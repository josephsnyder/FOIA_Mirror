Released GMRC*3*69 SEQ #58
Extracted from mail message
**KIDS**:GMRC*3.0*69^

**INSTALL NAME**
GMRC*3.0*69
"BLD",7245,0)
GMRC*3.0*69^CONSULT/REQUEST TRACKING^0^3090730^y
"BLD",7245,1,0)
^^22^22^3090126^
"BLD",7245,1,1,0)
CPRS internal ClearQuest ticket 17822. Remedy ticket 292869 
"BLD",7245,1,2,0)
and 293770. Added comments during Edit/Resubmit action in CPRS GUI are 
"BLD",7245,1,3,0)
not wrapping at 74 characters. As a result, comments are being stored on 
"BLD",7245,1,4,0)
a single node of the Request/Processing Activity multiple in file 123.
"BLD",7245,1,5,0)
 
"BLD",7245,1,6,0)
Long comments are hard to read in CPRS GUI due to the need to scroll to 
"BLD",7245,1,7,0)
the right to read the entire text.  Also for InterFacility Consults,
"BLD",7245,1,8,0)
comments of length greater than 255 characters will not transmit via HL7.
"BLD",7245,1,9,0)
 
"BLD",7245,1,10,0)
This routine will search through ^GMR(123 and reformat comments when the 
"BLD",7245,1,11,0)
following conditions are all true:
"BLD",7245,1,12,0)
Comment is a result of the Edit/Resubmit process, NOT just Add Comment.
"BLD",7245,1,13,0)
  Comment is longer than 80 characters AND stored on a single global node
"BLD",7245,1,14,0)
   OR
"BLD",7245,1,15,0)
  Comment maybe be stored on more than one global node (i.e. user entered 
"BLD",7245,1,16,0)
  carriage returns) but has lines of text exceeding 80 characters
"BLD",7245,1,17,0)
 
"BLD",7245,1,18,0)
Routine will create a backup of comments before reformatting in a 
"BLD",7245,1,19,0)
temporary array, ^XTMP("GMRC_PRE69",$J).  Temporary array is set to 
"BLD",7245,1,20,0)
expire 45 days from the date of execution.
"BLD",7245,1,21,0)
Routine will also send MailMan to installer containing the global 
"BLD",7245,1,22,0)
location and text of any comments found prior to being reformatted.
"BLD",7245,4,0)
^9.64PA^^
"BLD",7245,6.3)
13
"BLD",7245,"ABPKG")
n
"BLD",7245,"INI")
PRE^GMRCYP69
"BLD",7245,"INID")
^n^n
"BLD",7245,"INIT")
POST^GMRCYP69
"BLD",7245,"KRN",0)
^9.67PA^779.2^20
"BLD",7245,"KRN",.4,0)
.4
"BLD",7245,"KRN",.401,0)
.401
"BLD",7245,"KRN",.402,0)
.402
"BLD",7245,"KRN",.403,0)
.403
"BLD",7245,"KRN",.5,0)
.5
"BLD",7245,"KRN",.84,0)
.84
"BLD",7245,"KRN",3.6,0)
3.6
"BLD",7245,"KRN",3.8,0)
3.8
"BLD",7245,"KRN",9.2,0)
9.2
"BLD",7245,"KRN",9.8,0)
9.8
"BLD",7245,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",7245,"KRN",9.8,"NM",1,0)
GMRCYP69^^0^B30032201
"BLD",7245,"KRN",9.8,"NM","B","GMRCYP69",1)

"BLD",7245,"KRN",19,0)
19
"BLD",7245,"KRN",19,"NM",0)
^9.68A^^
"BLD",7245,"KRN",19.1,0)
19.1
"BLD",7245,"KRN",101,0)
101
"BLD",7245,"KRN",409.61,0)
409.61
"BLD",7245,"KRN",771,0)
771
"BLD",7245,"KRN",779.2,0)
779.2
"BLD",7245,"KRN",870,0)
870
"BLD",7245,"KRN",8989.51,0)
8989.51
"BLD",7245,"KRN",8989.52,0)
8989.52
"BLD",7245,"KRN",8994,0)
8994
"BLD",7245,"KRN","B",.4,.4)

"BLD",7245,"KRN","B",.401,.401)

"BLD",7245,"KRN","B",.402,.402)

"BLD",7245,"KRN","B",.403,.403)

"BLD",7245,"KRN","B",.5,.5)

"BLD",7245,"KRN","B",.84,.84)

"BLD",7245,"KRN","B",3.6,3.6)

"BLD",7245,"KRN","B",3.8,3.8)

"BLD",7245,"KRN","B",9.2,9.2)

"BLD",7245,"KRN","B",9.8,9.8)

"BLD",7245,"KRN","B",19,19)

"BLD",7245,"KRN","B",19.1,19.1)

"BLD",7245,"KRN","B",101,101)

"BLD",7245,"KRN","B",409.61,409.61)

"BLD",7245,"KRN","B",771,771)

"BLD",7245,"KRN","B",779.2,779.2)

"BLD",7245,"KRN","B",870,870)

"BLD",7245,"KRN","B",8989.51,8989.51)

"BLD",7245,"KRN","B",8989.52,8989.52)

"BLD",7245,"KRN","B",8994,8994)

"BLD",7245,"PRE")

"BLD",7245,"QUES",0)
^9.62^^
"BLD",7245,"REQB",0)
^9.611^1^1
"BLD",7245,"REQB",1,0)
OR*3.0*296^2
"BLD",7245,"REQB","B","OR*3.0*296",1)

"INI")
PRE^GMRCYP69
"INIT")
POST^GMRCYP69
"MBREQ")
0
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^13
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
69^3090730^123456789151
"PKG",128,22,1,"PAH",1,1,0)
^^22^22^3090730
"PKG",128,22,1,"PAH",1,1,1,0)
CPRS internal ClearQuest ticket 17822. Remedy ticket 292869 
"PKG",128,22,1,"PAH",1,1,2,0)
and 293770. Added comments during Edit/Resubmit action in CPRS GUI are 
"PKG",128,22,1,"PAH",1,1,3,0)
not wrapping at 74 characters. As a result, comments are being stored on 
"PKG",128,22,1,"PAH",1,1,4,0)
a single node of the Request/Processing Activity multiple in file 123.
"PKG",128,22,1,"PAH",1,1,5,0)
 
"PKG",128,22,1,"PAH",1,1,6,0)
Long comments are hard to read in CPRS GUI due to the need to scroll to 
"PKG",128,22,1,"PAH",1,1,7,0)
the right to read the entire text.  Also for InterFacility Consults,
"PKG",128,22,1,"PAH",1,1,8,0)
comments of length greater than 255 characters will not transmit via HL7.
"PKG",128,22,1,"PAH",1,1,9,0)
 
"PKG",128,22,1,"PAH",1,1,10,0)
This routine will search through ^GMR(123 and reformat comments when the 
"PKG",128,22,1,"PAH",1,1,11,0)
following conditions are all true:
"PKG",128,22,1,"PAH",1,1,12,0)
Comment is a result of the Edit/Resubmit process, NOT just Add Comment.
"PKG",128,22,1,"PAH",1,1,13,0)
  Comment is longer than 80 characters AND stored on a single global node
"PKG",128,22,1,"PAH",1,1,14,0)
   OR
"PKG",128,22,1,"PAH",1,1,15,0)
  Comment maybe be stored on more than one global node (i.e. user entered 
"PKG",128,22,1,"PAH",1,1,16,0)
  carriage returns) but has lines of text exceeding 80 characters
"PKG",128,22,1,"PAH",1,1,17,0)
 
"PKG",128,22,1,"PAH",1,1,18,0)
Routine will create a backup of comments before reformatting in a 
"PKG",128,22,1,"PAH",1,1,19,0)
temporary array, ^XTMP("GMRC_PRE69",$J).  Temporary array is set to 
"PKG",128,22,1,"PAH",1,1,20,0)
expire 45 days from the date of execution.
"PKG",128,22,1,"PAH",1,1,21,0)
Routine will also send MailMan to installer containing the global 
"PKG",128,22,1,"PAH",1,1,22,0)
location and text of any comments found prior to being reformatted.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","GMRCYP69")
0^1^B30032201^n/a
"RTN","GMRCYP69",1,0)
GMRCYP69 ;SLC/WAT - Reformat long comments from Edit/Resubmit ;1/21/09
"RTN","GMRCYP69",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**69**;DEC 27, 1997;Build 13
"RTN","GMRCYP69",3,0)
 ;;
"RTN","GMRCYP69",4,0)
 ;;ICR Invoked
"RTN","GMRCYP69",5,0)
 ;;10063, ^%ZTLOAD - $$S
"RTN","GMRCYP69",6,0)
 ;;10141, ^XPDUTL - BMES, PATCH
"RTN","GMRCYP69",7,0)
 ;;10103, ^XLFDT - $$FMADD, $$NOW, $$FMTH
"RTN","GMRCYP69",8,0)
 ;;10113, ^XMB(3.9
"RTN","GMRCYP69",9,0)
 ;;10066, XMZ^XMA2
"RTN","GMRCYP69",10,0)
 ;;10070, ^XMD - ENL,  ENT1
"RTN","GMRCYP69",11,0)
 ;;10011, ^DIWP, ^UTILITY($J
"RTN","GMRCYP69",12,0)
 ;;2053, WP^DIE
"RTN","GMRCYP69",13,0)
PRE ;sys check
"RTN","GMRCYP69",14,0)
 I $G(DUZ)="" D BMES^XPDUTL("Your DUZ is not defined. Install aborted. Transport global NOT deleted from system.") S XPDABORT=2 Q
"RTN","GMRCYP69",15,0)
 I '$$PATCH^XPDUTL("OR*3.0*296") S XPDABORT=2 D  Q 
"RTN","GMRCYP69",16,0)
 .D BMES^XPDUTL("*************")
"RTN","GMRCYP69",17,0)
 .D BMES^XPDUTL("OR*3.0*296 and the associated CPRS GUI exe must be installed first!")
"RTN","GMRCYP69",18,0)
 .D BMES^XPDUTL("Install aborted. Transport global NOT deleted from system.")
"RTN","GMRCYP69",19,0)
 Q
"RTN","GMRCYP69",20,0)
POST ;go
"RTN","GMRCYP69",21,0)
 D QUEUE
"RTN","GMRCYP69",22,0)
 Q
"RTN","GMRCYP69",23,0)
QUEUE ;task entry point
"RTN","GMRCYP69",24,0)
 N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSK
"RTN","GMRCYP69",25,0)
      S ZTRTN="EN^GMRCYP69",ZTDESC="GMRC Reformat Long Comments from Edit/Resubmit Action",ZTIO="",ZTDTH=$H
"RTN","GMRCYP69",26,0)
 D ^%ZTLOAD I '$G(ZTSK) D BMES^XPDUTL("POST INSTALL NOT QUEUED - RUN EN^GMRCYP69 AFTER INSTALL FINISHES") Q 
"RTN","GMRCYP69",27,0)
 D BMES^XPDUTL("Post-install queued as task #"_$G(ZTSK))
"RTN","GMRCYP69",28,0)
 D BMES^XPDUTL("If any records are locked, task will re-run 5 minutes after completion.")
"RTN","GMRCYP69",29,0)
 Q
"RTN","GMRCYP69",30,0)
EN ;main
"RTN","GMRCYP69",31,0)
 S $P(^XTMP("GMRC_PRE69",0),U)=$$FMADD^XLFDT(DT,45),$P(^XTMP("GMRC_PRE69",0),U,2)=DT
"RTN","GMRCYP69",32,0)
 S $P(^XTMP("GMRC_PRE69",0),U,3)=DUZ_" Patch installer's DUZ, global contains comment data before reformat in GMRC*3.0*69"
"RTN","GMRCYP69",33,0)
 S ^XTMP("GMRC_PRE69","DUZ")=DUZ ;get user's DUZ for mail mesage
"RTN","GMRCYP69",34,0)
 D SRCH
"RTN","GMRCYP69",35,0)
 I $D(^XTMP("GMRC_PRE69","RECHECK")) D RECHECK S ZTREQ="@" Q  ;some are locked, run recheck, clean task and quit
"RTN","GMRCYP69",36,0)
 I $D(^XTMP("GMRC_PRE69","RECHECK"))=0 D MSG S ZTREQ="@" Q  ;If all are checked, send msg, clean task, and quit
"RTN","GMRCYP69",37,0)
 Q
"RTN","GMRCYP69",38,0)
RECHECK ;if locked records requeue and re-run until all are checked
"RTN","GMRCYP69",39,0)
 Q:'$D(ZTQUEUED)&($D(^XTMP("GMRC_PRE69","RECHECK"))=0)  ;abort if outside taskman and all records already checked.
"RTN","GMRCYP69",40,0)
 N RECLOCK,IEN,A,B,TOTAL,IDX S (IEN,TOTAL)=0,IDX=""
"RTN","GMRCYP69",41,0)
 F  S IEN=$O(^XTMP("GMRC_PRE69","RECHECK",IEN)) Q:IEN=""  D
"RTN","GMRCYP69",42,0)
 .S RECLOCK=$$LOCKREC^GMRCUTL1(IEN)
"RTN","GMRCYP69",43,0)
 .Q:$G(RECLOCK)'=1  ;if still locked, do nothing
"RTN","GMRCYP69",44,0)
 .F  S IDX=$O(^XTMP("GMRC_PRE69","RECHECK",IEN,IDX)) Q:IDX=""  D
"RTN","GMRCYP69",45,0)
 ..S A=$P(^XTMP("GMRC_PRE69","RECHECK",IEN,IDX),",",4),B=1
"RTN","GMRCYP69",46,0)
 ..D REFORMAT D UNLKREC^GMRCUTL1(IEN) S ^XTMP("GMRC_PRE69","TOTAL")=$G(^XTMP("GMRC_PRE69","TOTAL"))+1
"RTN","GMRCYP69",47,0)
 ..K ^XTMP("GMRC_PRE69","RECHECK",IEN,IDX)
"RTN","GMRCYP69",48,0)
 I $D(^XTMP("GMRC_PRE69","RECHECK"))=0 D MSG S:($D(ZTQUEUED)) ZTREQ="@" Q
"RTN","GMRCYP69",49,0)
 E  D
"RTN","GMRCYP69",50,0)
 .N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSK,ZTSAVE
"RTN","GMRCYP69",51,0)
      .S ZTRTN="RECHECK^GMRCYP69",ZTDESC="GMRC Reformat Long Comments from Edit/Resubmit Action - RECHECK",ZTIO=""
"RTN","GMRCYP69",52,0)
      .S ZTDTH=$$FMTH^XLFDT($$FMADD^XLFDT($$NOW^XLFDT,,,5)) ;set to re-run in 5 minutes
"RTN","GMRCYP69",53,0)
      .D ^%ZTLOAD
"RTN","GMRCYP69",54,0)
      S ZTREQ="@"
"RTN","GMRCYP69",55,0)
 Q
"RTN","GMRCYP69",56,0)
SRCH ;search for long comments
"RTN","GMRCYP69",57,0)
 N IEN,A,B,C,TOTAL,FLG,LNCNT,RECLOCK,STPCHK,IDX S (IEN,TOTAL,RECLOCK,STPCHK,IDX)=0,LNCNT=1
"RTN","GMRCYP69",58,0)
 F  S IEN=$O(^GMR(123,IEN)) Q:+IEN=0!($G(ZTSTOP))  D
"RTN","GMRCYP69",59,0)
 .S A=0,STPCHK=STPCHK+1
"RTN","GMRCYP69",60,0)
 .I STPCHK>1000,$D(ZTQUEUED) S:$$S^%ZTLOAD ZTSTOP=1 Q:$G(ZTSTOP)  S STPCHK=0
"RTN","GMRCYP69",61,0)
 .F  S A=$O(^GMR(123,IEN,40,A)) Q:+A=0  D
"RTN","GMRCYP69",62,0)
 ..Q:$D(^GMR(123,IEN,40,A,0))<1
"RTN","GMRCYP69",63,0)
 ..Q:$P(^GMR(123,IEN,40,A,0),U,2)'=20  ;quit if action is not Add Comment
"RTN","GMRCYP69",64,0)
 ..;quit if next action not Edit/Resubmit, only get comments from Edit/Resubmit
"RTN","GMRCYP69",65,0)
 ..Q:$D(^GMR(123,IEN,40,A+1,0))<10&($P($G(^GMR(123,IEN,40,A+1,0)),U,2)'=11)
"RTN","GMRCYP69",66,0)
 ..S B=0
"RTN","GMRCYP69",67,0)
 ..F  S B=$O(^GMR(123,IEN,40,A,B)) Q:+B=0  D
"RTN","GMRCYP69",68,0)
 ...S C=0,FLG=0
"RTN","GMRCYP69",69,0)
 ...F  S C=$O(^GMR(123,IEN,40,A,B,C)) Q:+C=0  D  Q:FLG=1!($G(RECLOCK)=1)
"RTN","GMRCYP69",70,0)
 ....S FLG=0,RECLOCK=0 S:($L(^GMR(123,IEN,40,A,B,C,0))>80) FLG=1 Q:FLG'=1
"RTN","GMRCYP69",71,0)
 ....S RECLOCK=$$LOCKREC^GMRCUTL1(IEN)
"RTN","GMRCYP69",72,0)
 ....I $G(RECLOCK)'=1 S ^XTMP("GMRC_PRE69","RECHECK",IEN,IDX)=$NA(^GMR(123,IEN,40,A,B,C,0)),IDX=IDX+1
"RTN","GMRCYP69",73,0)
 ....S:$G(RECLOCK)=1 TOTAL=TOTAL+1,^XTMP("GMRC_PRE69","TOTAL")=$G(^XTMP("GMRC_PRE69","TOTAL"))+1
"RTN","GMRCYP69",74,0)
 ....D REFORMAT D:$G(RECLOCK)=1 UNLKREC^GMRCUTL1(IEN)
"RTN","GMRCYP69",75,0)
 Q
"RTN","GMRCYP69",76,0)
REFORMAT ;reformat data to 74 characters
"RTN","GMRCYP69",77,0)
 K ^UTILITY($J,"W")
"RTN","GMRCYP69",78,0)
 N INT,GMRC69,GMRCTMP,REF S INT=0,REF=A
"RTN","GMRCYP69",79,0)
 N X,DIWL,DIWR,DIWF
"RTN","GMRCYP69",80,0)
 S DIWL=1,DIWR=74,DIWF=""
"RTN","GMRCYP69",81,0)
 Q:$G(RECLOCK)'=1
"RTN","GMRCYP69",82,0)
 F  S INT=$O(^GMR(123,IEN,40,A,B,INT)) Q:+INT=0  D
"RTN","GMRCYP69",83,0)
 .S ^XTMP("GMRC_PRE69",IEN,40,A,B,INT,0)=^GMR(123,IEN,40,A,B,INT,0)
"RTN","GMRCYP69",84,0)
 .S X=^GMR(123,IEN,40,A,B,INT,0)
"RTN","GMRCYP69",85,0)
 .D ^DIWP
"RTN","GMRCYP69",86,0)
 .S:$G(RECLOCK)'=1 INT="A"
"RTN","GMRCYP69",87,0)
 D WP^DIE(123.02,REF_","_IEN_",","5","","^UTILITY($J,""W"",1)","^TMP($J,""ERR"")")
"RTN","GMRCYP69",88,0)
 Q
"RTN","GMRCYP69",89,0)
MSG ;create and send message
"RTN","GMRCYP69",90,0)
 N XMDUZ,XMSUB,XMZ,XMTEXT,XMY ;i/o args for XMZ^XMA2.
"RTN","GMRCYP69",91,0)
 N IEN,A,B,C,LNCNT S (IEN,A,B,C)=0,LNCNT=1
"RTN","GMRCYP69",92,0)
 S XMY(^XTMP("GMRC_PRE69","DUZ"))=""
"RTN","GMRCYP69",93,0)
 S XMDUZ="GMRC PACKAGE"
"RTN","GMRCYP69",94,0)
 S XMSUB="GMRC*3.0*69 COMMENTS BEFORE REFORMAT"
"RTN","GMRCYP69",95,0)
 D XMZ^XMA2 ; call Create Message Module
"RTN","GMRCYP69",96,0)
 I $G(^XTMP("GMRC_PRE69","TOTAL"))>0 F  S IEN=$O(^XTMP("GMRC_PRE69",IEN)) Q:+IEN=0  D
"RTN","GMRCYP69",97,0)
 .F  S A=$O(^XTMP("GMRC_PRE69",IEN,40,A)) Q:+A=0  D
"RTN","GMRCYP69",98,0)
 ..F  S B=$O(^XTMP("GMRC_PRE69",IEN,40,A,B)) Q:+B=0  D
"RTN","GMRCYP69",99,0)
 ...F  S C=$O(^XTMP("GMRC_PRE69",IEN,40,A,B,C)) Q:+C=0  D
"RTN","GMRCYP69",100,0)
 ....S ^XMB(3.9,XMZ,2,LNCNT,0)=$NA(^GMR(123,IEN,40,A,B,C,0))_U_^XTMP("GMRC_PRE69",IEN,40,A,B,C,0)
"RTN","GMRCYP69",101,0)
 ....S ^XMB(3.9,XMZ,2,0)="^3.92^"_LNCNT_"^"_LNCNT_"^"_DT ;define zero node per API
"RTN","GMRCYP69",102,0)
 ....S LNCNT=LNCNT+1
"RTN","GMRCYP69",103,0)
 I $G(^XTMP("GMRC_PRE69","TOTAL"))=0!($D(^XTMP("GMRC_PRE69","TOTAL"))=0) D
"RTN","GMRCYP69",104,0)
 .S XMTEXT="XMTEXT"
"RTN","GMRCYP69",105,0)
 .S XMTEXT(1)="No long comments found.  No records were modified in ^GMR(123."
"RTN","GMRCYP69",106,0)
 .D ENL^XMD
"RTN","GMRCYP69",107,0)
 D ENT1^XMD
"RTN","GMRCYP69",108,0)
 Q
"VER")
8.0^22.0
"BLD",7245,6)
^58
**END**
**END**

EMERGENCY Released EAS*1*94 SEQ #75
Extracted from mail message
**KIDS**:EAS*1.0*94^

**INSTALL NAME**
EAS*1.0*94
"BLD",7180,0)
EAS*1.0*94^ENROLLMENT APPLICATION SYSTEM^0^3090330^y
"BLD",7180,4,0)
^9.64PA^^
"BLD",7180,6.3)
6
"BLD",7180,"KRN",0)
^9.67PA^8989.52^19
"BLD",7180,"KRN",.4,0)
.4
"BLD",7180,"KRN",.401,0)
.401
"BLD",7180,"KRN",.402,0)
.402
"BLD",7180,"KRN",.403,0)
.403
"BLD",7180,"KRN",.5,0)
.5
"BLD",7180,"KRN",.84,0)
.84
"BLD",7180,"KRN",3.6,0)
3.6
"BLD",7180,"KRN",3.8,0)
3.8
"BLD",7180,"KRN",9.2,0)
9.2
"BLD",7180,"KRN",9.8,0)
9.8
"BLD",7180,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",7180,"KRN",9.8,"NM",1,0)
EASPREC4^^0^B29684211
"BLD",7180,"KRN",9.8,"NM","B","EASPREC4",1)

"BLD",7180,"KRN",19,0)
19
"BLD",7180,"KRN",19.1,0)
19.1
"BLD",7180,"KRN",101,0)
101
"BLD",7180,"KRN",409.61,0)
409.61
"BLD",7180,"KRN",771,0)
771
"BLD",7180,"KRN",870,0)
870
"BLD",7180,"KRN",8989.51,0)
8989.51
"BLD",7180,"KRN",8989.52,0)
8989.52
"BLD",7180,"KRN",8994,0)
8994
"BLD",7180,"KRN","B",.4,.4)

"BLD",7180,"KRN","B",.401,.401)

"BLD",7180,"KRN","B",.402,.402)

"BLD",7180,"KRN","B",.403,.403)

"BLD",7180,"KRN","B",.5,.5)

"BLD",7180,"KRN","B",.84,.84)

"BLD",7180,"KRN","B",3.6,3.6)

"BLD",7180,"KRN","B",3.8,3.8)

"BLD",7180,"KRN","B",9.2,9.2)

"BLD",7180,"KRN","B",9.8,9.8)

"BLD",7180,"KRN","B",19,19)

"BLD",7180,"KRN","B",19.1,19.1)

"BLD",7180,"KRN","B",101,101)

"BLD",7180,"KRN","B",409.61,409.61)

"BLD",7180,"KRN","B",771,771)

"BLD",7180,"KRN","B",870,870)

"BLD",7180,"KRN","B",8989.51,8989.51)

"BLD",7180,"KRN","B",8989.52,8989.52)

"BLD",7180,"KRN","B",8994,8994)

"BLD",7180,"QUES",0)
^9.62^^
"BLD",7180,"REQB",0)
^9.611^1^1
"BLD",7180,"REQB",1,0)
EAS*1.0*71^2
"BLD",7180,"REQB","B","EAS*1.0*71",1)

"MBREQ")
0
"PKG",187,-1)
1^1
"PKG",187,0)
ENROLLMENT APPLICATION SYSTEM^EAS^ENROLLMENT
"PKG",187,20,0)
^9.402P^1^1
"PKG",187,20,1,0)
2^^EASXDR
"PKG",187,20,1,1)
 
"PKG",187,20,"B",2,1)

"PKG",187,22,0)
^9.49I^1^1
"PKG",187,22,1,0)
1.0^3010315^3010321^66481
"PKG",187,22,1,"PAH",1,0)
94^3090330
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","EASPREC4")
0^1^B29684211^B25401092
"RTN","EASPREC4",1,0)
EASPREC4 ;ALB/PJH,TDM - PROCESS INCOMING HL7 (QRY) MESSAGES ; 3/30/09 8:37pm
"RTN","EASPREC4",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**71,94**;15-MAR-01;Build 6
"RTN","EASPREC4",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","EASPREC4",4,0)
 ;
"RTN","EASPREC4",5,0)
 ; CLONED FROM IVMPREC (ESR EVENT DRIVER)
"RTN","EASPREC4",6,0)
 ;
"RTN","EASPREC4",7,0)
 ; This routine will process (QRY) HL7 messages received from HEC
"RTN","EASPREC4",8,0)
 ; At present, the (QRY) message queries for updated information
"RTN","EASPREC4",9,0)
 ; for a single patient.
"RTN","EASPREC4",10,0)
 ;
"RTN","EASPREC4",11,0)
 ;
"RTN","EASPREC4",12,0)
QRY ; - Receive Query Message requesting further information
"RTN","EASPREC4",13,0)
 ;
"RTN","EASPREC4",14,0)
 S (HLEVN,IVMCT,IVMERROR,IVMFLAG)=0
"RTN","EASPREC4",15,0)
 ;
"RTN","EASPREC4",16,0)
 K IVMQUERY("LTD"),IVMQUERY("OVIS") ;Variables needed to open/close last visit date and outpt visit QUERIES
"RTN","EASPREC4",17,0)
 S IVMRTN="IVMPREC"
"RTN","EASPREC4",18,0)
 K ^TMP($J,IVMRTN),^TMP("HLS",$J),^TMP("HLA",$J)
"RTN","EASPREC4",19,0)
 F SEGCNT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","EASPREC4",20,0)
 .S CNT=0
"RTN","EASPREC4",21,0)
 .S ^TMP($J,IVMRTN,SEGCNT,CNT)=HLNODE
"RTN","EASPREC4",22,0)
 .F  S CNT=$O(HLNODE(CNT)) Q:'CNT  D
"RTN","EASPREC4",23,0)
 ..S ^TMP($J,IVMRTN,SEGCNT,CNT)=HLNODE(CNT)
"RTN","EASPREC4",24,0)
 ;
"RTN","EASPREC4",25,0)
 ; INITIALIZE HL7 VARIABLES
"RTN","EASPREC4",26,0)
 S HLEID="VAMC "_$P($$SITE^VASITE,"^",3)_" ORF-Z07 SERVER"
"RTN","EASPREC4",27,0)
 S HLEID=$O(^ORD(101,"B",HLEID,0))
"RTN","EASPREC4",28,0)
 D INIT^HLFNC2(HLEID,.HL)
"RTN","EASPREC4",29,0)
 S HLEIDS="EAS ESR "_$P($$SITE^VASITE,"^",3)_" ORF-Z07 CLIENT"
"RTN","EASPREC4",30,0)
 S HLEIDS=$O(^ORD(101,"B",HLEIDS,0))
"RTN","EASPREC4",31,0)
 I '$D(^ORD(101,HLEID,775,"B",+HLEIDS)) S HLEIDS=""
"RTN","EASPREC4",32,0)
 ;
"RTN","EASPREC4",33,0)
 ; IVM*2.0*105 BAJ 11/02/2005 Temp global for Consistency Checks
"RTN","EASPREC4",34,0)
 K ^TMP($J,"CC")
"RTN","EASPREC4",35,0)
 ;
"RTN","EASPREC4",36,0)
 F IVMDA=0:0 S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)) Q:'IVMDA  S IVMSEG=$G(^(IVMDA,0)) I $E(IVMSEG,1,3)="QRD"!($E(IVMSEG,1,3)="MSH") D
"RTN","EASPREC4",37,0)
 .I $E(IVMSEG,1,3)="MSH" S IVMMSHID=$P(IVMSEG,HLFS,10),MSGID=$P(IVMSEG,HLFS,10),HLMID=MSGID Q
"RTN","EASPREC4",38,0)
 .K HLERR S IVMFLAG=1
"RTN","EASPREC4",39,0)
 .S IVMSEG=$P(IVMSEG,HLFS,2,999) ; strip off segment name
"RTN","EASPREC4",40,0)
 .S IVMQLR=$P(IVMSEG,HLFS,7),DFN=$P(IVMSEG,HLFS,8),IVMIY=$P(IVMSEG,HLFS,10)
"RTN","EASPREC4",41,0)
 .D ERRCK
"RTN","EASPREC4",42,0)
 .I $D(HLERR) D ACK
"RTN","EASPREC4",43,0)
 .I '$D(HLERR) D
"RTN","EASPREC4",44,0)
 ..N EVENTS
"RTN","EASPREC4",45,0)
 ..; - if master query - create entry in (#301.9) file
"RTN","EASPREC4",46,0)
 ..I IVMQLR>1,'DFN D  Q
"RTN","EASPREC4",47,0)
 ...S IVMSEG1="QRD"_HLFS_IVMSEG
"RTN","EASPREC4",48,0)
 ...S:'$D(^IVM(301.9,1,10,0)) ^(0)="^301.9001DA^"
"RTN","EASPREC4",49,0)
 ...S DA(1)=1,DIC="^IVM(301.9,1,10,",DIC(0)=""
"RTN","EASPREC4",50,0)
 ...S X=IVMIY
"RTN","EASPREC4",51,0)
 ...K DO,DD D FILE^DICN
"RTN","EASPREC4",52,0)
 ...S DA=+Y,DA(1)=1,DIE="^IVM(301.9,1,10,"
"RTN","EASPREC4",53,0)
 ...S DR=".02///NOW;.04////^S X=IVMMSHID;10////^S X=IVMSEG1" D ^DIE
"RTN","EASPREC4",54,0)
 ..;
"RTN","EASPREC4",55,0)
 ..; Send AE if veteran has a Pseudo SSN and eligibility is not verified
"RTN","EASPREC4",56,0)
 ..;Removed with IVM*2*105
"RTN","EASPREC4",57,0)
 ..; I '$$SNDPSSN^IVMPTRN7(DFN) S HLERR="Pseudo SSN must be verified" D ACK Q
"RTN","EASPREC4",58,0)
 ..;
"RTN","EASPREC4",59,0)
 ..; - if Primary Eligibility = Employee generate error & quit
"RTN","EASPREC4",60,0)
 ..N DGPRIM
"RTN","EASPREC4",61,0)
 ..S DGPRIM=$$GET1^DIQ(2,DFN_",",.361)
"RTN","EASPREC4",62,0)
 ..I $G(DGPRIM)]"" S DGPRIM=$O(^DIC(8,"B",DGPRIM,0))
"RTN","EASPREC4",63,0)
 ..I $G(DGPRIM)]"" S DGPRIM=$P($G(^DIC(8,DGPRIM,0)),U,9)
"RTN","EASPREC4",64,0)
 ..I $G(DGPRIM)=14 S HLERR="Message not sent.  Patient is an employee" D ACK Q
"RTN","EASPREC4",65,0)
 ..;
"RTN","EASPREC4",66,0)
 ..; Do Z07 Consistency checks and if fail generate error & quit
"RTN","EASPREC4",67,0)
 ..I '$$EN^IVMZ07C(DFN) S HLERR="Message not sent.  Inconsistencies in Record" D ACK K ^TMP($J,"CC") Q
"RTN","EASPREC4",68,0)
 ..;
"RTN","EASPREC4",69,0)
 ..; - prepare (ACK) message
"RTN","EASPREC4",70,0)
 ..D:'$D(HLERR) MSGHDR   ;header (MSH)
"RTN","EASPREC4",71,0)
 ..D ACK     ;message (MSA)
"RTN","EASPREC4",72,0)
 ..;
"RTN","EASPREC4",73,0)
 ..; - set up local HL7 event type code in MSH
"RTN","EASPREC4",74,0)
 ..S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)="QRD"_HLFS_IVMSEG ; copy of incoming QRD
"RTN","EASPREC4",75,0)
 ..;
"RTN","EASPREC4",76,0)
 ..; - build 'FULL' transmission (note: without MSH segment)
"RTN","EASPREC4",77,0)
 ..S IVMMTDT=$E(IVMIY,1,3)+1_"1231.9999"
"RTN","EASPREC4",78,0)
 ..D FULL^IVMPTRN7(DFN,IVMMTDT,.EVENTS,.IVMCT,.IVMGTOT,,1,,.IVMQUERY)
"RTN","EASPREC4",79,0)
 ;
"RTN","EASPREC4",80,0)
 F Z="LTD","OVIS" I $G(IVMQUERY(Z)) D CLOSE^SDQ(IVMQUERY(Z)) K IVMQUERY(Z)
"RTN","EASPREC4",81,0)
 I 'IVMFLAG S HLERR="Invalid Message Format" D ACK
"RTN","EASPREC4",82,0)
 S HLMTN="ORF"
"RTN","EASPREC4",83,0)
 S HLMTIENA=HLMTIEN
"RTN","EASPREC4",84,0)
 K ^TMP("HLA",$J) M ^TMP("HLA",$J)=^TMP("HLS",$J) K ^TMP("HLS",$J)
"RTN","EASPREC4",85,0)
 D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,"GB",1,.HLRESLTA,HLMTIENA,.HLP)
"RTN","EASPREC4",86,0)
 ;
"RTN","EASPREC4",87,0)
QRYQ K DFN,DR,HLEVN,IVMCT,IVMDA,IVMERROR,IVMFLAG,IVMIY,IVMMTDT,IVMSEG,IVMSEG1,IVMQLR,IVMMSHID,MSGID,MSHID
"RTN","EASPREC4",88,0)
 K ^TMP("HLA",$J),^TMP("HLS",$J),^TMP($J,IVMRTN)
"RTN","EASPREC4",89,0)
 Q
"RTN","EASPREC4",90,0)
 ;
"RTN","EASPREC4",91,0)
 ;
"RTN","EASPREC4",92,0)
ERRCK ; Perform error checks on HL7 (QRD) segment
"RTN","EASPREC4",93,0)
 I ('DFN!(DFN'=+DFN)) S:IVMQLR'>1 HLERR="Invalid DFN"
"RTN","EASPREC4",94,0)
 I '$D(HLERR) S IVMIY=$$FMDATE^HLFNC(IVMIY) I $E(IVMIY,4,7)'="0000"!($E(IVMIY,1,3)<292) S HLERR="Invalid Income Year"
"RTN","EASPREC4",95,0)
 I '$D(HLERR),$P(IVMSEG,HLFS,2)'="R" S HLERR="Invalid Query Format Code"
"RTN","EASPREC4",96,0)
 I '$D(HLERR),$P(IVMSEG,HLFS,3)'="I",($P(IVMSEG,HLFS,3)'="D") S HLERR="Invalid Query Priority"
"RTN","EASPREC4",97,0)
 I '$D(HLERR),$P(IVMSEG,HLFS,9)'="DEM" S HLERR="Invalid Query Subject Filter"
"RTN","EASPREC4",98,0)
 I '$D(HLERR),$P(IVMSEG,HLFS,12)'="T" S HLERR="Invalid Query Results Level"
"RTN","EASPREC4",99,0)
 ;
"RTN","EASPREC4",100,0)
 Q
"RTN","EASPREC4",101,0)
 ;
"RTN","EASPREC4",102,0)
MSGHDR ; prepare header MSH segment in batch of 100 message events
"RTN","EASPREC4",103,0)
 ; input variables:
"RTN","EASPREC4",104,0)
 ;          IVMCT record counter
"RTN","EASPREC4",105,0)
 ;          HLEVN event number
"RTN","EASPREC4",106,0)
 ;          MSHID outgoing message id
"RTN","EASPREC4",107,0)
 ;             HL array for protocol
"RTN","EASPREC4",108,0)
 ;                 
"RTN","EASPREC4",109,0)
 N MID,HLRES
"RTN","EASPREC4",110,0)
 S HLEVN=$G(HLEVN)+1
"RTN","EASPREC4",111,0)
 D:(HLEVN#100)=1
"RTN","EASPREC4",112,0)
 .K MSHID,HLDT,HLDT1,HLMTIEN
"RTN","EASPREC4",113,0)
 .D INIT^HLFNC2(HLEID,.HL)
"RTN","EASPREC4",114,0)
 .D CREATE^HLTF(.MSHID,.HLMTIEN,.HLDT,.HLDT1)
"RTN","EASPREC4",115,0)
 S MID=MSHID_"-"_HLEVN
"RTN","EASPREC4",116,0)
 D MSH^HLFNC2(.HL,MID,.HLRES)
"RTN","EASPREC4",117,0)
 S IVMCT=$G(IVMCT)+1
"RTN","EASPREC4",118,0)
 S ^TMP("HLS",$J,IVMCT)=HLRES
"RTN","EASPREC4",119,0)
 Q
"RTN","EASPREC4",120,0)
 ;
"RTN","EASPREC4",121,0)
ACK ; prepare positive and negative acknowledgement (ACK) message
"RTN","EASPREC4",122,0)
 ; (positive acknowledgement: MSA segment with no MSH segment)
"RTN","EASPREC4",123,0)
 ; (negative acknowledgement: MSA segment with MSH segment)
"RTN","EASPREC4",124,0)
 N MID,HLRES
"RTN","EASPREC4",125,0)
 S IVMCT=$G(IVMCT)+1
"RTN","EASPREC4",126,0)
 D:$D(HLERR)
"RTN","EASPREC4",127,0)
 .S IVMERROR=1
"RTN","EASPREC4",128,0)
 .S HLEVN=HLEVN+1
"RTN","EASPREC4",129,0)
 .D:(HLEVN#100)=1
"RTN","EASPREC4",130,0)
 ..K HLMID,HLMTIEN,HLDT,HLDT1 ; set up batch
"RTN","EASPREC4",131,0)
 ..D INIT^HLFNC2(HLEID,.HL)
"RTN","EASPREC4",132,0)
 ..D CREATE^HLTF(.HLMID,.HLMTIEN,.HLDT,.HLDT1)
"RTN","EASPREC4",133,0)
 .S MID=HLMID_"-"_HLEVN
"RTN","EASPREC4",134,0)
 .D MSH^HLFNC2(.HL,MID,.HLRES)
"RTN","EASPREC4",135,0)
 .S ^TMP("HLS",$J,IVMCT)=HLRES
"RTN","EASPREC4",136,0)
 .S IVMCT=IVMCT+1
"RTN","EASPREC4",137,0)
 .S ^TMP("HLS",$J,IVMCT)="MSA"_HLFS_"AE"_HLFS_MSGID_HLFS_HLERR_"- SSN "_$S($G(DFN):$P($$PT^IVMUFNC4(DFN),"^",2),1:"NOT FOUND")
"RTN","EASPREC4",138,0)
 I '$D(HLERR) S ^TMP("HLS",$J,IVMCT)="MSA"_HLFS_"AA"_HLFS_HLMID
"RTN","EASPREC4",139,0)
 ;
"RTN","EASPREC4",140,0)
 Q
"RTN","EASPREC4",141,0)
 ;
"VER")
8.0^22.0
"BLD",7180,6)
^75
**END**
**END**

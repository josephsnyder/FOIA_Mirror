Released DG*5.3*823 SEQ #733
Extracted from mail message
**KIDS**:DG*5.3*823^

**INSTALL NAME**
DG*5.3*823
"BLD",8260,0)
DG*5.3*823^REGISTRATION^0^3100401^y
"BLD",8260,1,0)
^^2^2^3100323^
"BLD",8260,1,1,0)
The patch is to fix an error with the IF statement logic in the Vista 
"BLD",8260,1,2,0)
PIMS VAFHAPV1 API.
"BLD",8260,4,0)
^9.64PA^^
"BLD",8260,6.3)
6
"BLD",8260,"ABPKG")
n
"BLD",8260,"KRN",0)
^9.67PA^779.2^20
"BLD",8260,"KRN",.4,0)
.4
"BLD",8260,"KRN",.401,0)
.401
"BLD",8260,"KRN",.402,0)
.402
"BLD",8260,"KRN",.403,0)
.403
"BLD",8260,"KRN",.5,0)
.5
"BLD",8260,"KRN",.84,0)
.84
"BLD",8260,"KRN",3.6,0)
3.6
"BLD",8260,"KRN",3.8,0)
3.8
"BLD",8260,"KRN",9.2,0)
9.2
"BLD",8260,"KRN",9.8,0)
9.8
"BLD",8260,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",8260,"KRN",9.8,"NM",1,0)
VAFHAPV1^^0^B86007604
"BLD",8260,"KRN",9.8,"NM","B","VAFHAPV1",1)

"BLD",8260,"KRN",19,0)
19
"BLD",8260,"KRN",19.1,0)
19.1
"BLD",8260,"KRN",101,0)
101
"BLD",8260,"KRN",409.61,0)
409.61
"BLD",8260,"KRN",771,0)
771
"BLD",8260,"KRN",779.2,0)
779.2
"BLD",8260,"KRN",870,0)
870
"BLD",8260,"KRN",8989.51,0)
8989.51
"BLD",8260,"KRN",8989.52,0)
8989.52
"BLD",8260,"KRN",8994,0)
8994
"BLD",8260,"KRN","B",.4,.4)

"BLD",8260,"KRN","B",.401,.401)

"BLD",8260,"KRN","B",.402,.402)

"BLD",8260,"KRN","B",.403,.403)

"BLD",8260,"KRN","B",.5,.5)

"BLD",8260,"KRN","B",.84,.84)

"BLD",8260,"KRN","B",3.6,3.6)

"BLD",8260,"KRN","B",3.8,3.8)

"BLD",8260,"KRN","B",9.2,9.2)

"BLD",8260,"KRN","B",9.8,9.8)

"BLD",8260,"KRN","B",19,19)

"BLD",8260,"KRN","B",19.1,19.1)

"BLD",8260,"KRN","B",101,101)

"BLD",8260,"KRN","B",409.61,409.61)

"BLD",8260,"KRN","B",771,771)

"BLD",8260,"KRN","B",779.2,779.2)

"BLD",8260,"KRN","B",870,870)

"BLD",8260,"KRN","B",8989.51,8989.51)

"BLD",8260,"KRN","B",8989.52,8989.52)

"BLD",8260,"KRN","B",8994,8994)

"BLD",8260,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8260,"QUES",0)
^9.62^^
"BLD",8260,"REQB",0)
^9.611^1^1
"BLD",8260,"REQB",1,0)
DG*5.3*621^1
"BLD",8260,"REQB","B","DG*5.3*621",1)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
823^3100401
"PKG",5,22,1,"PAH",1,1,0)
^^2^2^3100401
"PKG",5,22,1,"PAH",1,1,1,0)
The patch is to fix an error with the IF statement logic in the Vista 
"PKG",5,22,1,"PAH",1,1,2,0)
PIMS VAFHAPV1 API.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","VAFHAPV1")
0^1^B86007604^B80986421
"RTN","VAFHAPV1",1,0)
VAFHAPV1 ;ALB/RJS - INPATIENT PV1 SEGMENT ; 1/11/10 1:43pm
"RTN","VAFHAPV1",2,0)
 ;;5.3;Registration;**91,209,190,298,494,621,823**;Aug 13, 1993;Build 6
"RTN","VAFHAPV1",3,0)
 ;
"RTN","VAFHAPV1",4,0)
 ;The DGBUILD entry point is call used internally by MAS software
"RTN","VAFHAPV1",5,0)
 ;to build a PV1 Segment for deleted Admissions. The DGPMP
"RTN","VAFHAPV1",6,0)
 ;variable, available from the DGPM Event Driver at the time of
"RTN","VAFHAPV1",7,0)
 ;the deletion, makes it possible to construct a partial PV1 segment
"RTN","VAFHAPV1",8,0)
 ;for the deleted record.
"RTN","VAFHAPV1",9,0)
 ;
"RTN","VAFHAPV1",10,0)
 ;06/29/00 ACS - Added sequence 21 (physical treating specialty - ward
"RTN","VAFHAPV1",11,0)
 ;location) and sequence 39 (facility + suffix).
"RTN","VAFHAPV1",12,0)
 ;
"RTN","VAFHAPV1",13,0)
EN(DFN,VAFHDT,VAFSTR,IEN,ALTVISID,SETID,VAFDIAG) ;
"RTN","VAFHAPV1",14,0)
 ;
"RTN","VAFHAPV1",15,0)
 ;This Entry Point builds the HL7 PV1 segment for inpatients.
"RTN","VAFHAPV1",16,0)
 ;
"RTN","VAFHAPV1",17,0)
 ;DFN, VAFHDT, & VAFSTR are the required variables.
"RTN","VAFHAPV1",18,0)
 ;
"RTN","VAFHAPV1",19,0)
 ;            DFN = IEN of Patient File
"RTN","VAFHAPV1",20,0)
 ;         VAFHDT = Date/Time of Patient Movement
"RTN","VAFHAPV1",21,0)
 ;         VAFSTR = HL7 Fields Requested e.g. ",3,7,10"
"RTN","VAFHAPV1",22,0)
 ;
"RTN","VAFHAPV1",23,0)
 ;IEN, ALTVISID, SETID are the optional variables
"RTN","VAFHAPV1",24,0)
 ;
"RTN","VAFHAPV1",25,0)
 ;The optional variable IEN is used for Discharge movements
"RTN","VAFHAPV1",26,0)
 ;because if only Date/Time is passed for a Discharge movement
"RTN","VAFHAPV1",27,0)
 ;no useful information is returned by VADPT.
"RTN","VAFHAPV1",28,0)
 ;
"RTN","VAFHAPV1",29,0)
 ;The optional ALTVISID variable is used to pass in a "Alternate.
"RTN","VAFHAPV1",30,0)
 ;Visit ID" this is a unique number that 
"RTN","VAFHAPV1",31,0)
 ;identifies this Admission or episode of care
"RTN","VAFHAPV1",32,0)
 ;
"RTN","VAFHAPV1",33,0)
 ;The optional variable SETID can be used to differentiate 
"RTN","VAFHAPV1",34,0)
 ;different sets of data, in messages that may contain multiple
"RTN","VAFHAPV1",35,0)
 ;events or messages.
"RTN","VAFHAPV1",36,0)
 ;
"RTN","VAFHAPV1",37,0)
 ;VAFDIAG, is a passed as a dotted variable. The inpatient diagnosis
"RTN","VAFHAPV1",38,0)
 ;is then returned in this variable.
"RTN","VAFHAPV1",39,0)
 ;
"RTN","VAFHAPV1",40,0)
 N VAFCOMP,RESULT,VAROOT,VA200
"RTN","VAFHAPV1",41,0)
 N CURRENT
"RTN","VAFHAPV1",42,0)
 ;Make sure the VAFSTR string is correctly formatted (",#,#,...,#,") DG*823
"RTN","VAFHAPV1",43,0)
 I $E(VAFSTR,1)'="," S VAFSTR=","_VAFSTR
"RTN","VAFHAPV1",44,0)
 I $E(VAFSTR,$L(VAFSTR))'="," S VAFSTR=VAFSTR_","
"RTN","VAFHAPV1",45,0)
 ;
"RTN","VAFHAPV1",46,0)
 D KVAR^VADPT
"RTN","VAFHAPV1",47,0)
 S VAFCOMP=$E(HLECH,1)
"RTN","VAFHAPV1",48,0)
 S VAROOT="CURRENT",VAIP("D")=VAFHDT,VA200=1
"RTN","VAFHAPV1",49,0)
 I ($G(IEN)'="") S VAIP("E")=IEN
"RTN","VAFHAPV1",50,0)
 D IN5^VADPT
"RTN","VAFHAPV1",51,0)
 S RESULT=$$BUILD()
"RTN","VAFHAPV1",52,0)
 I $G(ALTVISID)'="" S $P(RESULT,HLFS,51)=ALTVISID
"RTN","VAFHAPV1",53,0)
 I $G(SETID)'="" S $P(RESULT,HLFS,2)=SETID
"RTN","VAFHAPV1",54,0)
 I $G(SETID)="" S $P(RESULT,HLFS,2)=1
"RTN","VAFHAPV1",55,0)
 ;
"RTN","VAFHAPV1",56,0)
EXIT ;
"RTN","VAFHAPV1",57,0)
 Q $G(RESULT)
"RTN","VAFHAPV1",58,0)
 ;
"RTN","VAFHAPV1",59,0)
BUILD() ;Build the PV1 Segment
"RTN","VAFHAPV1",60,0)
 ;
"RTN","VAFHAPV1",61,0)
 ;Required Variables: Array "CURRENT" containing the results
"RTN","VAFHAPV1",62,0)
 ;                    of a call to VADPT
"RTN","VAFHAPV1",63,0)
 ;
"RTN","VAFHAPV1",64,0)
 ;This entry point is called to build the HL7 PV1 segment from
"RTN","VAFHAPV1",65,0)
 ;data returned by VADPT
"RTN","VAFHAPV1",66,0)
 ;
"RTN","VAFHAPV1",67,0)
 ;It returns a fully encoded HL7 segment, or a partially encoded HL7 segment containing patient class only
"RTN","VAFHAPV1",68,0)
 ;
"RTN","VAFHAPV1",69,0)
 N RESULT,SUBS
"RTN","VAFHAPV1",70,0)
 S RESULT="PV1"_HLFS_HLFS_"I"
"RTN","VAFHAPV1",71,0)
 I $G(CURRENT(1))="" Q RESULT
"RTN","VAFHAPV1",72,0)
 I $G(CURRENT(1))'="" D
"RTN","VAFHAPV1",73,0)
 . S VAFDIAG=CURRENT(9)
"RTN","VAFHAPV1",74,0)
 . ;
"RTN","VAFHAPV1",75,0)
 . ;--Ward, Room, Bed
"RTN","VAFHAPV1",76,0)
 . ;
"RTN","VAFHAPV1",77,0)
 . ;Format all If statements to be the same (I VAFSTR[",#,") DG*823
"RTN","VAFHAPV1",78,0)
 . I VAFSTR[",3," D
"RTN","VAFHAPV1",79,0)
 . . N WARD,ROOM,BED
"RTN","VAFHAPV1",80,0)
 . . S WARD=$$HLQ^VAFHUTL($P(CURRENT(5),"^",2))
"RTN","VAFHAPV1",81,0)
 . . S ROOM=$$HLQ^VAFHUTL($P($P(CURRENT(6),"^",2),"-",1))
"RTN","VAFHAPV1",82,0)
 . . S BED=$$HLQ^VAFHUTL($P($P(CURRENT(6),"^",2),"-",2))
"RTN","VAFHAPV1",83,0)
 . . S $P(RESULT,HLFS,4)=$G(WARD)_VAFCOMP_$G(ROOM)_VAFCOMP_$G(BED)
"RTN","VAFHAPV1",84,0)
 . ;
"RTN","VAFHAPV1",85,0)
 . ;--Attending Physician
"RTN","VAFHAPV1",86,0)
 . ;
"RTN","VAFHAPV1",87,0)
 . I VAFSTR[",7," D
"RTN","VAFHAPV1",88,0)
 . . N ATTNDPTR,ATTNDING
"RTN","VAFHAPV1",89,0)
 . . S ATTNDPTR=$P(CURRENT(18),"^",1)
"RTN","VAFHAPV1",90,0)
 . . ;S:ATTNDPTR'="" ATTNDING=$$HLNAME^HLFNC($P(CURRENT(18),"^",2))
"RTN","VAFHAPV1",91,0)
 . . I $G(ATTNDPTR)'="" D
"RTN","VAFHAPV1",92,0)
 . . . N DGNAME S DGNAME("FILE")=200,DGNAME("IENS")=ATTNDPTR,DGNAME("FIELD")=.01
"RTN","VAFHAPV1",93,0)
 . . . S ATTNDING=$$HLNAME^XLFNAME(.DGNAME,"S",$E($G(HLECH)))
"RTN","VAFHAPV1",94,0)
 . . S $P(RESULT,HLFS,8)=$$HLQ^VAFHUTL($G(ATTNDPTR))_VAFCOMP_$$HLQ^VAFHUTL($G(ATTNDING))
"RTN","VAFHAPV1",95,0)
 . ;
"RTN","VAFHAPV1",96,0)
 . ;--Treating Specialty
"RTN","VAFHAPV1",97,0)
 . ;
"RTN","VAFHAPV1",98,0)
 . I VAFSTR[",10," D
"RTN","VAFHAPV1",99,0)
 . . N SPECPTR,SPECALTY
"RTN","VAFHAPV1",100,0)
 . . S SPECPTR=$P(CURRENT(8),"^",1)
"RTN","VAFHAPV1",101,0)
 . . S:$G(SPECPTR)'="" SPECALTY=$P($G(^DIC(45.7,SPECPTR,0)),"^",2)
"RTN","VAFHAPV1",102,0)
 . . S $P(RESULT,HLFS,11)=$$HLQ^VAFHUTL($G(SPECALTY))
"RTN","VAFHAPV1",103,0)
 . ;
"RTN","VAFHAPV1",104,0)
 . ;--Previous Patient Location
"RTN","VAFHAPV1",105,0)
 . I VAFSTR[",6," D
"RTN","VAFHAPV1",106,0)
 . . N WARD,ROOM,BED,ROOMPTR,ROOMBED,MOVEMENT
"RTN","VAFHAPV1",107,0)
 . . S WARD=$$HLQ^VAFHUTL($P(CURRENT(15,4),"^",2))
"RTN","VAFHAPV1",108,0)
 . . S MOVEMENT=$G(CURRENT(15))
"RTN","VAFHAPV1",109,0)
 . . I MOVEMENT D
"RTN","VAFHAPV1",110,0)
 . . . S ROOMPTR=$P(^DGPM(MOVEMENT,0),"^",7)
"RTN","VAFHAPV1",111,0)
 . . . I ROOMPTR D
"RTN","VAFHAPV1",112,0)
 . . . . S ROOMBED=$P(^DG(405.4,ROOMPTR,0),"^",1)
"RTN","VAFHAPV1",113,0)
 . . . . I (ROOMBED'="") D
"RTN","VAFHAPV1",114,0)
 . . . . . S ROOM=$P(ROOMBED,"-",1)
"RTN","VAFHAPV1",115,0)
 . . . . . S BED=$P(ROOMBED,"-",2)
"RTN","VAFHAPV1",116,0)
 . . S $P(RESULT,HLFS,7)=$$HLQ^VAFHUTL($G(WARD))_VAFCOMP_$$HLQ^VAFHUTL($G(ROOM))_VAFCOMP_$$HLQ^VAFHUTL($G(BED))
"RTN","VAFHAPV1",117,0)
 . ;
"RTN","VAFHAPV1",118,0)
 . ;-- Patient Type
"RTN","VAFHAPV1",119,0)
 . I VAFSTR[",18," D
"RTN","VAFHAPV1",120,0)
 . .I +$G(^DPT(DFN,"TYPE")) DO
"RTN","VAFHAPV1",121,0)
 . . .S $P(RESULT,HLFS,19)=$P($G(^DG(391,+^("TYPE"),0)),"^",1)
"RTN","VAFHAPV1",122,0)
 . .E  S $P(RESULT,HLFS,19)=HLQ
"RTN","VAFHAPV1",123,0)
 . ;
"RTN","VAFHAPV1",124,0)
 . ;--Physical Treating Specialty - Ward Location
"RTN","VAFHAPV1",125,0)
 . ;
"RTN","VAFHAPV1",126,0)
 . I VAFSTR[",21," D
"RTN","VAFHAPV1",127,0)
 . . N VAWARD,VAPHYTS
"RTN","VAFHAPV1",128,0)
 . . ; get ward location pointer
"RTN","VAFHAPV1",129,0)
 . . S VAWARD=$P($G(CURRENT(5)),"^",1) Q:VAWARD=""
"RTN","VAFHAPV1",130,0)
 . . ; get ward treating specialty pointer
"RTN","VAFHAPV1",131,0)
 . . S VAPHYTS=$P($G(^DIC(42,VAWARD,0)),"^",12)
"RTN","VAFHAPV1",132,0)
 . . S $P(RESULT,HLFS,22)=$S(VAPHYTS]"":VAPHYTS,1:HLQ)
"RTN","VAFHAPV1",133,0)
 . . Q
"RTN","VAFHAPV1",134,0)
 . ;
"RTN","VAFHAPV1",135,0)
 . ;--Facility and Suffix
"RTN","VAFHAPV1",136,0)
 . I VAFSTR[",39," D
"RTN","VAFHAPV1",137,0)
 . . N VAFIEN,VAWARD,VAMEDCTR,VAFACSUF
"RTN","VAFHAPV1",138,0)
 . . ; get patient movement IEN, ward loc ptr, med center div ptr
"RTN","VAFHAPV1",139,0)
 . . S VAFIEN=$G(CURRENT(1))
"RTN","VAFHAPV1",140,0)
 . . S VAWARD=$P($G(^DGPM(VAFIEN,0)),"^",6) Q:VAWARD=""
"RTN","VAFHAPV1",141,0)
 . . S VAMEDCTR=$P($G(^DIC(42,VAWARD,0)),"^",11) Q:VAMEDCTR=""
"RTN","VAFHAPV1",142,0)
 . . ; call below returns: inst pointer^inst name^station number w/suffix
"RTN","VAFHAPV1",143,0)
 . . S VAFACSUF=$$SITE^VASITE($G(CURRENT(3)),VAMEDCTR)
"RTN","VAFHAPV1",144,0)
 . . S VAFACSUF=$P(VAFACSUF,"^",3)
"RTN","VAFHAPV1",145,0)
 . . ; move data into the PV1 segment
"RTN","VAFHAPV1",146,0)
 . . S $P(RESULT,HLFS,40)=$S(VAFACSUF]"":VAFACSUF,1:HLQ)
"RTN","VAFHAPV1",147,0)
 . ;
"RTN","VAFHAPV1",148,0)
 . ;Discharge Disposition
"RTN","VAFHAPV1",149,0)
 . I VAFSTR[",36," D  ;If Discharge Disposition requested
"RTN","VAFHAPV1",150,0)
 . .N DGDTYP
"RTN","VAFHAPV1",151,0)
 . .S DGDTYP=$P(CURRENT(17,3),"^") S $P(RESULT,HLFS,37)=DGDTYP
"RTN","VAFHAPV1",152,0)
 . ;
"RTN","VAFHAPV1",153,0)
 . ;--Admission Date
"RTN","VAFHAPV1",154,0)
 . ;
"RTN","VAFHAPV1",155,0)
 . I (VAFSTR[",44,") D
"RTN","VAFHAPV1",156,0)
 . . I ($P(CURRENT(13,1),"^",1)'="") S $P(RESULT,HLFS,45)=$$HLDATE^HLFNC($P(CURRENT(13,1),"^",1),"TS")
"RTN","VAFHAPV1",157,0)
 . . E  S $P(RESULT,HLFS,45)=HLQ
"RTN","VAFHAPV1",158,0)
 . ;
"RTN","VAFHAPV1",159,0)
 . ;
"RTN","VAFHAPV1",160,0)
 . ;--Discharge Date
"RTN","VAFHAPV1",161,0)
 . ;
"RTN","VAFHAPV1",162,0)
 . I (VAFSTR[",45,") D
"RTN","VAFHAPV1",163,0)
 . . I ($P(CURRENT(17,1),"^",1)'="") S $P(RESULT,HLFS,46)=$$HLDATE^HLFNC($P(CURRENT(17,1),"^",1),"TS")
"RTN","VAFHAPV1",164,0)
 . . E  S $P(RESULT,HLFS,46)=HLQ
"RTN","VAFHAPV1",165,0)
 ;
"RTN","VAFHAPV1",166,0)
 Q:$$TEST(7,RESULT,HLFS,VAFCOMP) RESULT
"RTN","VAFHAPV1",167,0)
 Q RESULT
"RTN","VAFHAPV1",168,0)
DGBUILD(DGPMP,VAFSTR) ;
"RTN","VAFHAPV1",169,0)
 ;
"RTN","VAFHAPV1",170,0)
 ;Required Variables:    DGPMP = 0 node of patient movement
"RTN","VAFHAPV1",171,0)
 ;                      VAFSTR = HL7 fields requested e.g.
"RTN","VAFHAPV1",172,0)
 ;                               ",3,7,10"
"RTN","VAFHAPV1",173,0)
 ;
"RTN","VAFHAPV1",174,0)
 ;This entry point builds an HL7 segment from data supplied
"RTN","VAFHAPV1",175,0)
 ;from the 0 node of the Patient movement file in the required
"RTN","VAFHAPV1",176,0)
 ;variable DGPMP. It is an internal PIMS call used to build
"RTN","VAFHAPV1",177,0)
 ;a PV1 segment when the record has already been deleted.
"RTN","VAFHAPV1",178,0)
 ;
"RTN","VAFHAPV1",179,0)
 ;The call returns a fully encoded PV1 segment or a partially encoded
"RTN","VAFHAPV1",180,0)
 ;PV1 segment containing only set id and patient class
"RTN","VAFHAPV1",181,0)
 ;
"RTN","VAFHAPV1",182,0)
 N WARD,BED,ROOM,ATTNDPTR,ATTNDING,SPECPTR,SPECALTY,TRANSACT
"RTN","VAFHAPV1",183,0)
 N ADMPTR,ADMSSN,VAFCOMP,RESULT
"RTN","VAFHAPV1",184,0)
 ;Check to have string follow correct format (",#,#,...,#,") DG*823
"RTN","VAFHAPV1",185,0)
 I $E(VAFSTR,1)'="," S VAFSTR=","_VAFSTR
"RTN","VAFHAPV1",186,0)
 I $E(VAFSTR,$L(VAFSTR))'="," S VAFSTR=VAFSTR_","
"RTN","VAFHAPV1",187,0)
 S RESULT="PV1"_HLFS_1_HLFS_"I" ;Inpatient
"RTN","VAFHAPV1",188,0)
 I $G(DGPMP)="" Q RESULT
"RTN","VAFHAPV1",189,0)
 S TRANSACT=$P(DGPMP,"^",2),VAFCOMP=$E(HLECH,1)
"RTN","VAFHAPV1",190,0)
 I TRANSACT=1 S VAFDIAG=$P(DGPMP,"^",10)
"RTN","VAFHAPV1",191,0)
 E  S ADMPTR=$P(DGPMP,"^",14),ADMSSN=$G(^DGPM(ADMPTR,0)),VAFDIAG=$P(ADMSSN,"^",10)
"RTN","VAFHAPV1",192,0)
 ;
"RTN","VAFHAPV1",193,0)
 ;--Ward, Room, Bed
"RTN","VAFHAPV1",194,0)
 ;
"RTN","VAFHAPV1",195,0)
 ;Make sure all IF statements carry same logic (I VAFSTR[",#,") DG*823
"RTN","VAFHAPV1",196,0)
 I VAFSTR[",3," D
"RTN","VAFHAPV1",197,0)
 . N WARD,ROOM,BED
"RTN","VAFHAPV1",198,0)
 . ;
"RTN","VAFHAPV1",199,0)
 . ;--Check node 2 to see if it's a discharge movement
"RTN","VAFHAPV1",200,0)
 . ;
"RTN","VAFHAPV1",201,0)
 . ;
"RTN","VAFHAPV1",202,0)
 . I TRANSACT=3 D
"RTN","VAFHAPV1",203,0)
 . . S $P(RESULT,HLFS,4)=HLQ_VAFCOMP_HLQ_VAFCOMP_HLQ
"RTN","VAFHAPV1",204,0)
 . . ;
"RTN","VAFHAPV1",205,0)
 . . ;--All non discharge events are handled the same
"RTN","VAFHAPV1",206,0)
 . . ;
"RTN","VAFHAPV1",207,0)
 . I TRANSACT'=3 D
"RTN","VAFHAPV1",208,0)
 . . N WARDPTR,ROOMPTR,ROOM,WARD,BED
"RTN","VAFHAPV1",209,0)
 . . S WARDPTR=$P(DGPMP,"^",6)
"RTN","VAFHAPV1",210,0)
 . . S ROOMPTR=$P(DGPMP,"^",7)
"RTN","VAFHAPV1",211,0)
 . . I $G(WARDPTR)'="" S WARD=$P(^DIC(42,WARDPTR,0),"^",1)
"RTN","VAFHAPV1",212,0)
 . . I $G(ROOMPTR)'="" D
"RTN","VAFHAPV1",213,0)
 . . . S ROOM=$P(^DG(405.4,ROOMPTR,0),"^",1)
"RTN","VAFHAPV1",214,0)
 . . . S BED=$P(ROOM,"-",2)
"RTN","VAFHAPV1",215,0)
 . . . S ROOM=$P(ROOM,"-",1)
"RTN","VAFHAPV1",216,0)
 . . S $P(RESULT,HLFS,4)=$$HLQ^VAFHUTL($G(WARD))_VAFCOMP_$$HLQ^VAFHUTL($G(ROOM))_VAFCOMP_$$HLQ^VAFHUTL($G(BED))
"RTN","VAFHAPV1",217,0)
 . ;
"RTN","VAFHAPV1",218,0)
 . ;--Attending Physician
"RTN","VAFHAPV1",219,0)
 . ;
"RTN","VAFHAPV1",220,0)
 I VAFSTR[",7," D
"RTN","VAFHAPV1",221,0)
 . N ATTNDPTR,ATTNDING
"RTN","VAFHAPV1",222,0)
 . S ATTNDPTR=$P(DGPMP,"^",19)
"RTN","VAFHAPV1",223,0)
 . I $G(ATTNDPTR)'="" D
"RTN","VAFHAPV1",224,0)
 . . N DGNAME S DGNAME("FILE")=200,DGNAME("IENS")=ATTNDPTR,DGNAME("FIELD")=.01
"RTN","VAFHAPV1",225,0)
 . . S ATTNDING=$$HLNAME^XLFNAME(.DGNAME,"S",$E($G(HLECH)))
"RTN","VAFHAPV1",226,0)
 . S $P(RESULT,HLFS,8)=$$HLQ^VAFHUTL($G(ATTNDPTR))_VAFCOMP_$$HLQ^VAFHUTL($G(ATTNDING))
"RTN","VAFHAPV1",227,0)
 . ;
"RTN","VAFHAPV1",228,0)
 . ;--Treating Specialty
"RTN","VAFHAPV1",229,0)
 . ;
"RTN","VAFHAPV1",230,0)
 I VAFSTR[",10," D
"RTN","VAFHAPV1",231,0)
 . N SPECPTR,SPECALTY
"RTN","VAFHAPV1",232,0)
 . S SPECPTR=$P(DGPMP,"^",9)
"RTN","VAFHAPV1",233,0)
 . I $G(SPECPTR)'="" S SPECALTY=$P($G(^DIC(45.7,SPECPTR,0)),"^",2)
"RTN","VAFHAPV1",234,0)
 . S $P(RESULT,HLFS,11)=$$HLQ^VAFHUTL($G(SPECALTY))
"RTN","VAFHAPV1",235,0)
 ;
"RTN","VAFHAPV1",236,0)
 ;-- Patient Type
"RTN","VAFHAPV1",237,0)
 I VAFSTR[",18," D
"RTN","VAFHAPV1",238,0)
 . I +$G(^DPT(DFN,"TYPE")) DO
"RTN","VAFHAPV1",239,0)
 . .  S $P(RESULT,HLFS,19)=$P($G(^DG(391,+^("TYPE"),0)),"^",1)
"RTN","VAFHAPV1",240,0)
 . E  S $P(RESULT,HLFS,19)=HLQ
"RTN","VAFHAPV1",241,0)
 ;
"RTN","VAFHAPV1",242,0)
 ;--Physical Treating Specialty - Ward Location
"RTN","VAFHAPV1",243,0)
 ;
"RTN","VAFHAPV1",244,0)
 I VAFSTR[",21," D
"RTN","VAFHAPV1",245,0)
 . N VAWARD,VAPHYTS
"RTN","VAFHAPV1",246,0)
 . ; get ward location pointer
"RTN","VAFHAPV1",247,0)
 . S VAWARD=$P($G(DGPMP),"^",6) Q:VAWARD=""
"RTN","VAFHAPV1",248,0)
 . ; get ward treating specialty
"RTN","VAFHAPV1",249,0)
 . S VAPHYTS=$P($G(^DIC(42,VAWARD,0)),"^",12)
"RTN","VAFHAPV1",250,0)
 . S $P(RESULT,HLFS,22)=$S(VAPHYTS]"":VAPHYTS,1:HLQ)
"RTN","VAFHAPV1",251,0)
 . Q
"RTN","VAFHAPV1",252,0)
 ;
"RTN","VAFHAPV1",253,0)
 ;--Facility and Suffix
"RTN","VAFHAPV1",254,0)
 ;
"RTN","VAFHAPV1",255,0)
 N VAWARD,VAMEDCTR,VAFACSUF
"RTN","VAFHAPV1",256,0)
 I VAFSTR[",39," D
"RTN","VAFHAPV1",257,0)
 . ; get ward location pointer, med center div pointer
"RTN","VAFHAPV1",258,0)
 . S $P(RESULT,HLFS,40)=HLQ
"RTN","VAFHAPV1",259,0)
 . S VAWARD=$P($G(DGPMP),"^",6) Q:VAWARD=""
"RTN","VAFHAPV1",260,0)
 . S VAMEDCTR=$P($G(^DIC(42,VAWARD,0)),"^",11) Q:VAMEDCTR=""
"RTN","VAFHAPV1",261,0)
 . ; call below returns: inst pointer^inst name^station number w/suffix
"RTN","VAFHAPV1",262,0)
 . S VAFACSUF=$$SITE^VASITE($P(DGPMP,"^",1),VAMEDCTR)
"RTN","VAFHAPV1",263,0)
 . S VAFACSUF=$P(VAFACSUF,"^",3)
"RTN","VAFHAPV1",264,0)
 . ; move data into the PV1 segment
"RTN","VAFHAPV1",265,0)
 . S $P(RESULT,HLFS,40)=$S(VAFACSUF]"":VAFACSUF,1:HLQ)
"RTN","VAFHAPV1",266,0)
 ;
"RTN","VAFHAPV1",267,0)
 ;Discharge Disposition
"RTN","VAFHAPV1",268,0)
 ;
"RTN","VAFHAPV1",269,0)
 I VAFSTR[",36," D  ;If Discharge Disposition requested
"RTN","VAFHAPV1",270,0)
 . N DGDTYP
"RTN","VAFHAPV1",271,0)
 . S DGDTYP=$P($G(DGPMP),"^",18) ;Discharge type pointer in movement file
"RTN","VAFHAPV1",272,0)
 . S $P(RESULT,HLFS,37)=DGDTYP ;store in variable
"RTN","VAFHAPV1",273,0)
 ;
"RTN","VAFHAPV1",274,0)
 ;--Admission Date
"RTN","VAFHAPV1",275,0)
 ;
"RTN","VAFHAPV1",276,0)
 I (VAFSTR[",44,") D
"RTN","VAFHAPV1",277,0)
 . I $P(DGPMP,"^",1)="" S $P(RESULT,HLFS,45)=HLQ
"RTN","VAFHAPV1",278,0)
 . E  S $P(RESULT,HLFS,45)=$$HLDATE^HLFNC($P(DGPMP,"^",1),"TS")
"RTN","VAFHAPV1",279,0)
 ;
"RTN","VAFHAPV1",280,0)
 Q:$$TEST(8,RESULT,HLFS,VAFCOMP) RESULT
"RTN","VAFHAPV1",281,0)
 Q RESULT
"RTN","VAFHAPV1",282,0)
TEST(COUNTER,STRING,FIELDSEP,COMPNENT) ;
"RTN","VAFHAPV1",283,0)
 N CHAR,LENGTH
"RTN","VAFHAPV1",284,0)
 S LENGTH=$L(STRING)
"RTN","VAFHAPV1",285,0)
NEXT ;
"RTN","VAFHAPV1",286,0)
 I COUNTER>LENGTH Q 0
"RTN","VAFHAPV1",287,0)
 S CHAR=$E(STRING,COUNTER,COUNTER)
"RTN","VAFHAPV1",288,0)
 I $G(CHAR)=FIELDSEP!($G(CHAR)=COMPNENT) S COUNTER=COUNTER+1 G NEXT
"RTN","VAFHAPV1",289,0)
 Q 1
"VER")
8.0^22.0
"BLD",8260,6)
^733
**END**
**END**

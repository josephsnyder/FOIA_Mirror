EMERGENCY Released DG*5.3*807 SEQ #705
Extracted from mail message
**KIDS**:DG*5.3*807^

**INSTALL NAME**
DG*5.3*807
"BLD",7182,0)
DG*5.3*807^REGISTRATION^0^3090402^y
"BLD",7182,4,0)
^9.64PA^^
"BLD",7182,6.3)
2
"BLD",7182,"INID")
^n
"BLD",7182,"INIT")
EN^DG53807P
"BLD",7182,"KRN",0)
^9.67PA^8989.52^19
"BLD",7182,"KRN",.4,0)
.4
"BLD",7182,"KRN",.401,0)
.401
"BLD",7182,"KRN",.402,0)
.402
"BLD",7182,"KRN",.403,0)
.403
"BLD",7182,"KRN",.5,0)
.5
"BLD",7182,"KRN",.84,0)
.84
"BLD",7182,"KRN",3.6,0)
3.6
"BLD",7182,"KRN",3.8,0)
3.8
"BLD",7182,"KRN",9.2,0)
9.2
"BLD",7182,"KRN",9.8,0)
9.8
"BLD",7182,"KRN",9.8,"NM",0)
^9.68A^2^1
"BLD",7182,"KRN",9.8,"NM",2,0)
DG53807P^^0^B20053102
"BLD",7182,"KRN",9.8,"NM","B","DG53807P",2)

"BLD",7182,"KRN",19,0)
19
"BLD",7182,"KRN",19.1,0)
19.1
"BLD",7182,"KRN",101,0)
101
"BLD",7182,"KRN",409.61,0)
409.61
"BLD",7182,"KRN",771,0)
771
"BLD",7182,"KRN",870,0)
870
"BLD",7182,"KRN",8989.51,0)
8989.51
"BLD",7182,"KRN",8989.52,0)
8989.52
"BLD",7182,"KRN",8994,0)
8994
"BLD",7182,"KRN","B",.4,.4)

"BLD",7182,"KRN","B",.401,.401)

"BLD",7182,"KRN","B",.402,.402)

"BLD",7182,"KRN","B",.403,.403)

"BLD",7182,"KRN","B",.5,.5)

"BLD",7182,"KRN","B",.84,.84)

"BLD",7182,"KRN","B",3.6,3.6)

"BLD",7182,"KRN","B",3.8,3.8)

"BLD",7182,"KRN","B",9.2,9.2)

"BLD",7182,"KRN","B",9.8,9.8)

"BLD",7182,"KRN","B",19,19)

"BLD",7182,"KRN","B",19.1,19.1)

"BLD",7182,"KRN","B",101,101)

"BLD",7182,"KRN","B",409.61,409.61)

"BLD",7182,"KRN","B",771,771)

"BLD",7182,"KRN","B",870,870)

"BLD",7182,"KRN","B",8989.51,8989.51)

"BLD",7182,"KRN","B",8989.52,8989.52)

"BLD",7182,"KRN","B",8994,8994)

"BLD",7182,"QUES",0)
^9.62^^
"BLD",7182,"REQB",0)
^9.611^1^1
"BLD",7182,"REQB",1,0)
DG*5.3*688^2
"BLD",7182,"REQB","B","DG*5.3*688",1)

"INIT")
EN^DG53807P
"MBREQ")
0
"PKG",47,-1)
1^1
"PKG",47,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",47,20,0)
^9.402P^^
"PKG",47,22,0)
^9.49I^1^1
"PKG",47,22,1,0)
5.3^2930813^2960613
"PKG",47,22,1,"PAH",1,0)
807^3090402
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","DG53807P")
0^2^B20053102^n/a
"RTN","DG53807P",1,0)
DG53807P ;ALB/LBD - PATCH DG*5.3*807 POST-INSTALL ROUTINE ; 4/2/09 4:15pm
"RTN","DG53807P",2,0)
 ;;5.3;Registration;**807**;Aug 13, 1993;Build 2
"RTN","DG53807P",3,0)
 ;
"RTN","DG53807P",4,0)
 ; This routine will loop through the Patient file #2 and update
"RTN","DG53807P",5,0)
 ; the country field in all Permanent, Temporary and Confidential
"RTN","DG53807P",6,0)
 ; Addresses that have a valid US zip code with UNITED STATES.
"RTN","DG53807P",7,0)
 ;
"RTN","DG53807P",8,0)
 Q
"RTN","DG53807P",9,0)
EN ;Entry point for DG*5.3*807 post-install
"RTN","DG53807P",10,0)
 N ZTDTH,ZTIO,ZTDESC,ZTRTN,ZTSK
"RTN","DG53807P",11,0)
 S ZTDESC="Update Addresses with United States"
"RTN","DG53807P",12,0)
 S ZTRTN="ENQ^DG53807P",ZTDTH=$H,ZTIO=""
"RTN","DG53807P",13,0)
 D ^%ZTLOAD
"RTN","DG53807P",14,0)
 I $G(ZTSK) D  Q
"RTN","DG53807P",15,0)
 .D BMES^XPDUTL("POST-INSTALL PROCESS HAS BEEN QUEUED AS TASK #"_ZTSK)
"RTN","DG53807P",16,0)
 .D MES^XPDUTL("Old patient addresses will be updated with UNITED STATES")
"RTN","DG53807P",17,0)
 D BMES^XPDUTL("ERROR: POST-INSTALL PROCESS COULD NOT BE QUEUED")
"RTN","DG53807P",18,0)
 Q
"RTN","DG53807P",19,0)
 ;
"RTN","DG53807P",20,0)
ENQ ;Entry point for tasked job
"RTN","DG53807P",21,0)
 N ERROR,PROG
"RTN","DG53807P",22,0)
 S PROG="DG53807P"
"RTN","DG53807P",23,0)
 S:'$D(^XTMP(PROG,0)) ^XTMP(PROG,0)=$$FMADD^XLFDT($$DT^XLFDT,180)_"^"_$$DT^XLFDT()_"^UPDATE OLD PATIENT ADDRESSES WITH UNITED STATES"
"RTN","DG53807P",24,0)
 S ^XTMP(PROG,"TASK")=$G(ZTSK)
"RTN","DG53807P",25,0)
 S ^XTMP(PROG,"START")=$$FMTE^XLFDT($$NOW^XLFDT) K ^XTMP(PROG,"END")
"RTN","DG53807P",26,0)
 S ^XTMP(PROG,"TOTPAT")=0
"RTN","DG53807P",27,0)
 D LOOP
"RTN","DG53807P",28,0)
 S ^XTMP(PROG,"END")=$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","DG53807P",29,0)
 D SENDMSG
"RTN","DG53807P",30,0)
 Q
"RTN","DG53807P",31,0)
LOOP ; Loop through Patient file #2, starting with most recent DFNs.
"RTN","DG53807P",32,0)
 N DFN,PAT,UPD,USA
"RTN","DG53807P",33,0)
 S DFN="A"
"RTN","DG53807P",34,0)
 ;Get IEN for UNITED STATES from COUNTRY CODE file #779.004
"RTN","DG53807P",35,0)
 S USA=$O(^HL(779.004,"C","UNITED STATES",0))
"RTN","DG53807P",36,0)
 I 'USA S ERROR="UNITED STATES MISSING FROM COUNTRY CODE FILE" Q
"RTN","DG53807P",37,0)
 F  S DFN=$O(^DPT(DFN),-1) Q:DFN=""!($$TST)  I $D(^DPT(DFN,0)) D
"RTN","DG53807P",38,0)
 .S ^XTMP(PROG,"TOTPAT")=$G(^XTMP(PROG,"TOTPAT"))+1
"RTN","DG53807P",39,0)
 .S UPD=0
"RTN","DG53807P",40,0)
 .L +^DPT(DFN):3 E  D FAIL Q
"RTN","DG53807P",41,0)
 .S PAT(.11)=$G(^DPT(DFN,.11))    ;Permanent Address data
"RTN","DG53807P",42,0)
 .S PAT(.121)=$G(^DPT(DFN,.121))  ;Temporary Address data
"RTN","DG53807P",43,0)
 .S PAT(.122)=$G(^DPT(DFN,.122))  ;Temporary Address data
"RTN","DG53807P",44,0)
 .S PAT(.141)=$G(^DPT(DFN,.141))  ;Confidential Address data
"RTN","DG53807P",45,0)
 .;Check Permanent Address
"RTN","DG53807P",46,0)
 .I $P(PAT(.11),"^",10)="" D
"RTN","DG53807P",47,0)
 ..I $$USZIP($P(PAT(.11),"^",6)) S $P(^DPT(DFN,.11),"^",10)=USA,UPD=1
"RTN","DG53807P",48,0)
 .;Check Temporary Address
"RTN","DG53807P",49,0)
 .I $P(PAT(.122),"^",3)="" D
"RTN","DG53807P",50,0)
 ..I $$USZIP($P(PAT(.121),"^",6)) S $P(^DPT(DFN,.122),"^",3)=USA,UPD=1
"RTN","DG53807P",51,0)
 .;Check Confidential Address
"RTN","DG53807P",52,0)
 .I $P(PAT(.141),"^",16)="" D
"RTN","DG53807P",53,0)
 ..I $$USZIP($P(PAT(.141),"^",6)) S $P(^DPT(DFN,.141),"^",16)=USA,UPD=1
"RTN","DG53807P",54,0)
 .L -^DPT(DFN)
"RTN","DG53807P",55,0)
 .I UPD S ^XTMP(PROG,"TOTUPD")=$G(^XTMP(PROG,"TOTUPD"))+1
"RTN","DG53807P",56,0)
 Q
"RTN","DG53807P",57,0)
 ;
"RTN","DG53807P",58,0)
USZIP(ZIP) ;Check if valid US zip code
"RTN","DG53807P",59,0)
 ;Return 1=US zip code; 0=Not valid US zip code
"RTN","DG53807P",60,0)
 N ST,Z
"RTN","DG53807P",61,0)
 I $G(ZIP)="" Q 0
"RTN","DG53807P",62,0)
 ;Lookup in POSTAL CODE file #5.12
"RTN","DG53807P",63,0)
 S Z=$O(^XIP(5.12,"B",ZIP,0)) I 'Z Q 0
"RTN","DG53807P",64,0)
 ;Get State
"RTN","DG53807P",65,0)
 S ST=$P($G(^XIP(5.12,Z,0)),"^",4) I 'ST Q 0
"RTN","DG53807P",66,0)
 ;Valid US state or possession?
"RTN","DG53807P",67,0)
 I '$P($G(^DIC(5,ST,0)),"^",6) Q 0
"RTN","DG53807P",68,0)
 Q 1
"RTN","DG53807P",69,0)
 ;
"RTN","DG53807P",70,0)
SENDMSG ;Send MailMan message when process completes
"RTN","DG53807P",71,0)
 N XMSUB,XMDUZ,XMY,XMTEXT,MSG,LN
"RTN","DG53807P",72,0)
 S XMY(DUZ)="",XMTEXT="MSG("
"RTN","DG53807P",73,0)
 S XMDUZ=.5,XMSUB="DG*5.3*807 JOB TO UPDT OLD PAT ADDRS"
"RTN","DG53807P",74,0)
 S MSG($$LN)="The DG*5.3*807 post-install process has completed."
"RTN","DG53807P",75,0)
 S MSG($$LN)=""
"RTN","DG53807P",76,0)
 S MSG($$LN)="This process ran through the Patient file #2 and checked"
"RTN","DG53807P",77,0)
 S MSG($$LN)="the patient's Permanent, Temporary, and Confidential"
"RTN","DG53807P",78,0)
 S MSG($$LN)="addresses.  If the address was a valid US address, but"
"RTN","DG53807P",79,0)
 S MSG($$LN)="the Country field was blank, the Country was updated with"
"RTN","DG53807P",80,0)
 S MSG($$LN)="UNITED STATES."
"RTN","DG53807P",81,0)
 S MSG($$LN)=""
"RTN","DG53807P",82,0)
 S MSG($$LN)="The process statistics:"
"RTN","DG53807P",83,0)
 S MSG($$LN)=""
"RTN","DG53807P",84,0)
 I $D(ERROR) D
"RTN","DG53807P",85,0)
 .S MSG($$LN)="*** ERROR: THIS PROCESS COULD NOT BE RUN BECAUSE 'UNITED STATES'"
"RTN","DG53807P",86,0)
 .S MSG($$LN)="           IS MISSING FROM THE COUNTRY CODE FILE #779.004"
"RTN","DG53807P",87,0)
 .S MSG($$LN)=""
"RTN","DG53807P",88,0)
 S MSG($$LN)="Job Start Date/Time: "_$G(^XTMP(PROG,"START"))
"RTN","DG53807P",89,0)
 S MSG($$LN)="  Job End Date/Time: "_$G(^XTMP(PROG,"END"))
"RTN","DG53807P",90,0)
 S MSG($$LN)=""
"RTN","DG53807P",91,0)
 S MSG($$LN)="Total Patient Records Searched: "_+$G(^XTMP(PROG,"TOTPAT"))
"RTN","DG53807P",92,0)
 S MSG($$LN)=" Total Patient Records Updated: "_+$G(^XTMP(PROG,"TOTUPD"))
"RTN","DG53807P",93,0)
 I $G(^XTMP(PROG,"LOCKFAIL")) D
"RTN","DG53807P",94,0)
 .S MSG($$LN)="  Total Patient Records Failed: "_+$G(^XTMP(PROG,"LOCKFAIL"))
"RTN","DG53807P",95,0)
 D ^XMD
"RTN","DG53807P",96,0)
 Q
"RTN","DG53807P",97,0)
LN() ;Increment line counter
"RTN","DG53807P",98,0)
 S LN=$G(LN)+1
"RTN","DG53807P",99,0)
 Q LN
"RTN","DG53807P",100,0)
FAIL ;Update ^XTMP with records that could not be locked
"RTN","DG53807P",101,0)
 S ^XTMP(PROG,"LOCKFAIL")=$G(^XTMP(PROG,"LOCKFAIL"))+1
"RTN","DG53807P",102,0)
 S ^XTMP(PROG,"LOCKFAIL",DFN)=""
"RTN","DG53807P",103,0)
 Q
"RTN","DG53807P",104,0)
 ;
"RTN","DG53807P",105,0)
TEST ;Entry point for testing
"RTN","DG53807P",106,0)
 N DIR,X,Y,DIRUT,DIROUT,TST
"RTN","DG53807P",107,0)
 W !!,"ADDRESS UPDATE ROUTINE DG53807P"
"RTN","DG53807P",108,0)
 S DIR(0)="NOA",DIR("A")="Enter number of records for test run: "
"RTN","DG53807P",109,0)
 D ^DIR I 'Y Q
"RTN","DG53807P",110,0)
 S TST=+Y
"RTN","DG53807P",111,0)
 G ENQ
"RTN","DG53807P",112,0)
TST() ;If testing, quit if number of records = TST
"RTN","DG53807P",113,0)
 I '$D(TST) Q 0
"RTN","DG53807P",114,0)
 I ^XTMP(PROG,"TOTPAT")=TST Q 1
"RTN","DG53807P",115,0)
 Q 0
"VER")
8.0^22.0
"BLD",7182,6)
^705
**END**
**END**

Released YS*5.01*93 SEQ #78
Extracted from mail message
**KIDS**:YS*5.01*93^

**INSTALL NAME**
YS*5.01*93
"BLD",7357,0)
YS*5.01*93^MENTAL HEALTH^0^3080319^y
"BLD",7357,1,0)
^^4^4^3080318^
"BLD",7357,1,1,0)
This patch is intended to stop HL7 message generation.  With the release 
"BLD",7357,1,2,0)
of YS*5.01*85, HL7 errors are occurring because it was the intent of the 
"BLD",7357,1,3,0)
development team to release that patch with messaging turned off.  
"BLD",7357,1,4,0)
Unfortunately, this was not the case.
"BLD",7357,4,0)
^9.64PA^^
"BLD",7357,6.3)
1
"BLD",7357,"KRN",0)
^9.67PA^8989.52^19
"BLD",7357,"KRN",.4,0)
.4
"BLD",7357,"KRN",.401,0)
.401
"BLD",7357,"KRN",.402,0)
.402
"BLD",7357,"KRN",.403,0)
.403
"BLD",7357,"KRN",.5,0)
.5
"BLD",7357,"KRN",.84,0)
.84
"BLD",7357,"KRN",3.6,0)
3.6
"BLD",7357,"KRN",3.8,0)
3.8
"BLD",7357,"KRN",9.2,0)
9.2
"BLD",7357,"KRN",9.8,0)
9.8
"BLD",7357,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",7357,"KRN",9.8,"NM",1,0)
YTQHL7^^0^B30700006
"BLD",7357,"KRN",9.8,"NM","B","YTQHL7",1)

"BLD",7357,"KRN",19,0)
19
"BLD",7357,"KRN",19.1,0)
19.1
"BLD",7357,"KRN",101,0)
101
"BLD",7357,"KRN",409.61,0)
409.61
"BLD",7357,"KRN",771,0)
771
"BLD",7357,"KRN",870,0)
870
"BLD",7357,"KRN",8989.51,0)
8989.51
"BLD",7357,"KRN",8989.52,0)
8989.52
"BLD",7357,"KRN",8994,0)
8994
"BLD",7357,"KRN","B",.4,.4)

"BLD",7357,"KRN","B",.401,.401)

"BLD",7357,"KRN","B",.402,.402)

"BLD",7357,"KRN","B",.403,.403)

"BLD",7357,"KRN","B",.5,.5)

"BLD",7357,"KRN","B",.84,.84)

"BLD",7357,"KRN","B",3.6,3.6)

"BLD",7357,"KRN","B",3.8,3.8)

"BLD",7357,"KRN","B",9.2,9.2)

"BLD",7357,"KRN","B",9.8,9.8)

"BLD",7357,"KRN","B",19,19)

"BLD",7357,"KRN","B",19.1,19.1)

"BLD",7357,"KRN","B",101,101)

"BLD",7357,"KRN","B",409.61,409.61)

"BLD",7357,"KRN","B",771,771)

"BLD",7357,"KRN","B",870,870)

"BLD",7357,"KRN","B",8989.51,8989.51)

"BLD",7357,"KRN","B",8989.52,8989.52)

"BLD",7357,"KRN","B",8994,8994)

"BLD",7357,"QUES",0)
^9.62^^
"BLD",7357,"REQB",0)
^9.611^1^1
"BLD",7357,"REQB",1,0)
YS*5.01*85^1
"BLD",7357,"REQB","B","YS*5.01*85",1)

"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
MENTAL HEALTH^YS^Version 5.01 of Mental Health
"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
5.01^2941230^2950417
"PKG",200,22,1,"PAH",1,0)
93^3080319
"PKG",200,22,1,"PAH",1,1,0)
^^4^4^3080319
"PKG",200,22,1,"PAH",1,1,1,0)
This patch is intended to stop HL7 message generation.  With the release 
"PKG",200,22,1,"PAH",1,1,2,0)
of YS*5.01*85, HL7 errors are occurring because it was the intent of the 
"PKG",200,22,1,"PAH",1,1,3,0)
development team to release that patch with messaging turned off.  
"PKG",200,22,1,"PAH",1,1,4,0)
Unfortunately, this was not the case.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","YTQHL7")
0^1^B30700006^B31149138
"RTN","YTQHL7",1,0)
YTQHL7 ;ALB/ASF HL7 ; 10/31/07 2:39pm
"RTN","YTQHL7",2,0)
 ;;5.01;MENTAL HEALTH;**85,93**;Dec 30, 1994;Build 1
"RTN","YTQHL7",3,0)
 Q
"RTN","YTQHL7",4,0)
ACKMHA ;
"RTN","YTQHL7",5,0)
 N YSLOCAT,YSERT,YSDIV,YSACK,YSMID,YSFS,YSAD,YSMTXT,YSX,YS772,YSMSG
"RTN","YTQHL7",6,0)
 S YSACK="",YSFS=HL("FS")
"RTN","YTQHL7",7,0)
 ;get ack type
"RTN","YTQHL7",8,0)
 F  X HLNEXT Q:HLQUIT'>0  D
"RTN","YTQHL7",9,0)
 . I $P(HLNODE,YSFS)="MSA" S YSACK=$P(HLNODE,YSFS,2),YSMID=$P(HLNODE,YSFS,3),YSERT=$P(HLNODE,YSFS,1,4)
"RTN","YTQHL7",10,0)
 ;get ien of 601.84 from message
"RTN","YTQHL7",11,0)
 S DIC=773,DIC(0)="MZ",X=YSMID D ^DIC K DIC
"RTN","YTQHL7",12,0)
 I Y'>0 D ERRMAIL("BAD BAD") Q  ;-->out
"RTN","YTQHL7",13,0)
 S YS772=$P(Y,U,2) ;ien of message 772
"RTN","YTQHL7",14,0)
 S X=$$GET1^DIQ(772,YS772_",",200,,"YSMSG")
"RTN","YTQHL7",15,0)
 S N=0,YSAD=0 F  S N=$O(YSMSG(N)) Q:N'>0!(YSAD>0)  S YSOUT=YSMSG(N) S:$P(YSOUT,YSFS)="OBX" YSAD=+$P(YSOUT,YSFS,4)
"RTN","YTQHL7",16,0)
 I YSAD'>0 D ERRMAIL(YSMTXT_"  MH ADMINITRATION #601.84 ien is 0",YSAD) Q  ;--->out
"RTN","YTQHL7",17,0)
 ;set 601.84 fields
"RTN","YTQHL7",18,0)
 S YSX=$S(YSACK="AA":"S",YSACK="AE":"E",YSACK="AR":"E",1:"")
"RTN","YTQHL7",19,0)
 S DA=YSAD,DIE="^YTT(601.84,",DR="11///"_YSX_";12///NOW" D ^DIE
"RTN","YTQHL7",20,0)
 I YSX'="S" D ERRMAIL(YSERT,YSAD)
"RTN","YTQHL7",21,0)
 Q
"RTN","YTQHL7",22,0)
ERRMAIL(X,YSAD) ;mail error reports
"RTN","YTQHL7",23,0)
 N XMDUZ,XMSUB,XMTEXT,XMY,YSMAILG
"RTN","YTQHL7",24,0)
 S YSMAILG=$$GETAPP^HLCS2("YS MHA")
"RTN","YTQHL7",25,0)
 K ^TMP("YSMHAHL7",$J)
"RTN","YTQHL7",26,0)
 S ^TMP("YSMHAHL7",$J,1,0)="An attempt to send MHA3 Administration ien #"_YSAD
"RTN","YTQHL7",27,0)
 S ^TMP("YSMHAHL7",$J,2,0)="generated an error."
"RTN","YTQHL7",28,0)
 S ^TMP("YSMHAHL7",$J,3,0)="Error: "_X
"RTN","YTQHL7",29,0)
 S ^TMP("YSMHAHL7",$J,4,0)="Please report this error via official channels."
"RTN","YTQHL7",30,0)
 S XMSUB="Mental Health Assistant 3 HL7 Error"
"RTN","YTQHL7",31,0)
 S XMY("G."_$P(YSMAILG,U))=""
"RTN","YTQHL7",32,0)
 S XMTEXT="^TMP(""YSMHAHL7"",$J,"
"RTN","YTQHL7",33,0)
 S XMDUZ="AUTOMATED MESSAGE"
"RTN","YTQHL7",34,0)
 D ^XMD
"RTN","YTQHL7",35,0)
 K ^TMP("YSMHAHL7",$J)
"RTN","YTQHL7",36,0)
 Q
"RTN","YTQHL7",37,0)
HL7(YSDATA,YS) ;RPC entry
"RTN","YTQHL7",38,0)
 ;input:ADMIN = ADMINISTRATION #
"RTN","YTQHL7",39,0)
 ;output: [DATA]
"RTN","YTQHL7",40,0)
 N G,G1,N,YSAD,YSQ,CNT,MC,HLFS,HLCS,DA,DFN,DIE,DR,HLECH,HLNEXT,HLNODE,HLQUIT,MYOPTNS,MYRESULT
"RTN","YTQHL7",41,0)
 N VADMVT,VAINDT,X1,Y,YSANSID,YSAVED,YSCC,YSCONID,YSEQ,YSIN,YSIO,YSLINE,YSORBY,YSOUT,YSQN,YSTEST,YSTESTN,YSTS,YSTST
"RTN","YTQHL7",42,0)
 S YSAD=$G(YS("AD"))
"RTN","YTQHL7",43,0)
 I YSAD'?1N.N S YSDATA(1)="[ERROR]",YSDATA(2)="bad ad num" Q  ;-->out
"RTN","YTQHL7",44,0)
 I '$D(^YTT(601.84,YSAD)) S YSDATA(1)="[ERROR]",YSDATA(2)="no such reference" Q  ;-->out
"RTN","YTQHL7",45,0)
 ;No Dups
"RTN","YTQHL7",46,0)
 I $P($G(^YTT(601.84,YSAD,2)),U)="S" S YSDATA(1)="[ERROR]",YSDATA(2)=YSAD_" is dup" Q  ;-->out
"RTN","YTQHL7",47,0)
 S YSTST=$P(^YTT(601.84,YSAD,0),U,3) ;ins ien
"RTN","YTQHL7",48,0)
 I $P($G(^YTT(601.71,YSTST,8)),U,4)'="Y" S YSDATA="[DATA]",YSDATA(2)="ins not to be sent" Q  ;--> out
"RTN","YTQHL7",49,0)
 S YSDATA(1)="[ERROR]"
"RTN","YTQHL7",50,0)
 S DA=YSAD,DIE="^YTT(601.84,",DR="11///T;12///NOW" D ^DIE
"RTN","YTQHL7",51,0)
 D ADSEND
"RTN","YTQHL7",52,0)
 Q
"RTN","YTQHL7",53,0)
ADSEND ;send completed Admin to MHSHG
"RTN","YTQHL7",54,0)
 S DFN=$P(^YTT(601.84,YSAD,0),U,2)
"RTN","YTQHL7",55,0)
 S YSAVED=$P(^YTT(601.84,YSAD,0),U,4) ;changed to GIVEN 10/31/07
"RTN","YTQHL7",56,0)
 S YSTESTN=$P(^YTT(601.84,YSAD,0),U,3)
"RTN","YTQHL7",57,0)
 S YSTEST=$$GET1^DIQ(601.71,YSTESTN_",",.01)
"RTN","YTQHL7",58,0)
 S YSORBY=$P(^YTT(601.84,YSAD,0),U,6)
"RTN","YTQHL7",59,0)
 S YSLOCAT=$P(^YTT(601.84,YSAD,0),U,11)
"RTN","YTQHL7",60,0)
 S YSDIV="" S:YSLOCAT?1N.N YSDIV=$$GET1^DIQ(44,YSLOCAT_",",3.5)
"RTN","YTQHL7",61,0)
 I YSDIV=""&($D(DUZ(2))) S YSDIV=$$GET1^DIQ(4,DUZ(2)_",",.01)
"RTN","YTQHL7",62,0)
BLDM ;BUILD A SINGLE MESSAGE
"RTN","YTQHL7",63,0)
 ;MSH-EVN-PID-PV1-OBX
"RTN","YTQHL7",64,0)
 K HLA,HLEVN
"RTN","YTQHL7",65,0)
 N CNT,MC,HLFS,HLCS
"RTN","YTQHL7",66,0)
 S CNT=0
"RTN","YTQHL7",67,0)
1 ;set up environment for message
"RTN","YTQHL7",68,0)
 K HL D INIT^HLFNC2("YS MHA A08 EVENT",.HL)
"RTN","YTQHL7",69,0)
 I $G(HL) D  Q  ; error occurred -->out
"RTN","YTQHL7",70,0)
 . ; put error handler here for init failure
"RTN","YTQHL7",71,0)
 . S YSDATA(1)="[ERROR]",YSDATA(2)="init Error: "_$P(HL,2) W !,"XXX"
"RTN","YTQHL7",72,0)
 S HLFS=$G(HL("FS")) I HLFS="" S HLFS="^"
"RTN","YTQHL7",73,0)
 S HLCS=$E(HL("ECH"),1)
"RTN","YTQHL7",74,0)
2 ;Add message txt to HLA array
"RTN","YTQHL7",75,0)
 ;create ENV segment
"RTN","YTQHL7",76,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HLFS_"A08"_HLFS_$$HLDATE^HLFNC(YSAVED,"TS")_HLFS_$$HLDATE^HLFNC(YSAVED,"TS")_HLFS_"05"_HLFS_HLFS_$$HLDATE^HLFNC(YSAVED,"TS")
"RTN","YTQHL7",77,0)
 ; create PID segment for patient DFN -- call segment generator
"RTN","YTQHL7",78,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFHLPID(DFN,"1,2,4,6,7,8,10,11,12,13,16,17,19,22",1,1)
"RTN","YTQHL7",79,0)
 ;create PV1 segment
"RTN","YTQHL7",80,0)
 S VAINDT=YSAVED D ADM^VADPT2 S YSIO=$S(VADMVT>0:"I",1:"O")
"RTN","YTQHL7",81,0)
 S CNT=CNT+1,HLA("HLS",CNT)="PV1"_HLFS_"0001"_HLFS_YSIO_HLFS_"~~~~~~~~"_YSDIV
"RTN","YTQHL7",82,0)
 ;create OBX segments
"RTN","YTQHL7",83,0)
 D OBX(YSAD)
"RTN","YTQHL7",84,0)
 ;crete PR1 proccedure
"RTN","YTQHL7",85,0)
 S CNT=CNT+1
"RTN","YTQHL7",86,0)
 S HLA("HLS",CNT)="PR1"_HLFS_1_HLFS_HLFS_YSTESTN_$E($G(HLECH))_YSTEST_HLFS_HLFS_$$HLDATE^HLFNC(YSAVED,"TS")_HLFS_"D"
"RTN","YTQHL7",87,0)
 N DGNAME S DGNAME("FILE")=200,DGNAME("IENS")=YSORBY,DGNAME("FIELD")=.01
"RTN","YTQHL7",88,0)
 S X1=$$HLNAME^XLFNAME(.DGNAME,"S",$E($G(HLECH))),X1=YSORBY_$E(HLECH,1)_X1
"RTN","YTQHL7",89,0)
 S HLA("HLS",CNT)=HLA("HLS",CNT)_HLFS_HLFS_HLFS_HLFS_HLFS_HLFS_X1
"RTN","YTQHL7",90,0)
 ;
"RTN","YTQHL7",91,0)
 ;
"RTN","YTQHL7",92,0)
DIRECT ;CALL HL7 TO TRANSMIT MESSAGE
"RTN","YTQHL7",93,0)
 ; VM/RJT - YS*5.01*93 - Turn off message generation
"RTN","YTQHL7",94,0)
 ;D GENERATE^HLMA("YS MHA A08 EVENT","LM",1,.MYRESULT,"",.MYOPTNS)
"RTN","YTQHL7",95,0)
 S YSDATA(1)="[DATA]"
"RTN","YTQHL7",96,0)
 Q
"RTN","YTQHL7",97,0)
OBX(YSAD) ;enter multiple OBX seqments
"RTN","YTQHL7",98,0)
 S YSIN=$P(^YTT(601.84,YSAD,0),U,3)
"RTN","YTQHL7",99,0)
 S YSEQ=0 F  S YSEQ=$O(^YTT(601.76,"AD",YSIN,YSEQ)) Q:YSEQ'>0  S YSCONID=$O(^YTT(601.76,"AD",YSIN,YSEQ,0)) D
"RTN","YTQHL7",100,0)
 . S YSQN=$P(^YTT(601.76,YSCONID,0),U,4)
"RTN","YTQHL7",101,0)
 . S YSANSID=$O(^YTT(601.85,"AC",YSAD,YSQN,0))
"RTN","YTQHL7",102,0)
 . Q:YSANSID'?1N.N
"RTN","YTQHL7",103,0)
 . S G=$G(^YTT(601.85,YSANSID,0)),YSCC=$P(G,U,4)
"RTN","YTQHL7",104,0)
 . S CNT=CNT+1
"RTN","YTQHL7",105,0)
 . I +YSCC S CNT=CNT+1,HLA("HLS",CNT)="OBX"_HLFS_YSEQ_HLFS_"CE"_HLFS_YSAD_"~~~"_YSQN_HLFS_1_HLFS_YSCC_"~"_$G(^YTT(601.75,$P(G,U,4),1))_"||||||"_"R|||"_$$HLDATE^HLFNC(YSAVED,"TS") Q
"RTN","YTQHL7",106,0)
 . E  S YSLINE=0 F  S YSLINE=$O(^YTT(601.85,YSANSID,1,YSLINE)) Q:YSLINE'>0  D
"RTN","YTQHL7",107,0)
 .. S CNT=CNT+1,HLA("HLS",CNT)="OBX"_HLFS_YSEQ_HLFS_"CE"_HLFS_YSAD_"~~~"_YSQN_HLFS_YSLINE_HLFS_0_"~"_$G(^YTT(601.85,YSANSID,1,YSLINE,0))_"||||||"_"R|||"_$$HLDATE^HLFNC(YSAVED,"TS") Q
"RTN","YTQHL7",108,0)
 Q
"RTN","YTQHL7",109,0)
REDO ;resend all no transmits and errors
"RTN","YTQHL7",110,0)
 S YSAD=0 F  S YSAD=$O(^YTT(601.84,YSAD)) Q:YSAD'>0  D
"RTN","YTQHL7",111,0)
 . S YSTS=$P($G(^YTT(601.84,YSAD,2)),U)
"RTN","YTQHL7",112,0)
 . I (YSTS="T")!(YSTS="E") K YS,YSDATA S YS("AD")=YSAD D HL7(.YSDATA,.YS)
"RTN","YTQHL7",113,0)
 Q
"RTN","YTQHL7",114,0)
REDO1 ;resend single admin
"RTN","YTQHL7",115,0)
 K DIC,DIR S DIC(0)="AEQM",DIC="^YTT(601.84," D ^DIC Q:Y'>0  ;-->out
"RTN","YTQHL7",116,0)
 W !
"RTN","YTQHL7",117,0)
 S (YSAD,DA)=+Y D EN^DIQ
"RTN","YTQHL7",118,0)
 S DIR(0)="Y",DIR("A")="Send HL7",DIR("B")="No" D ^DIR
"RTN","YTQHL7",119,0)
 I Y K YS,YSDATA S YS("AD")=YSAD D HL7(.YSDATA,.YS)
"RTN","YTQHL7",120,0)
 G REDO1
"VER")
8.0^22.0
"BLD",7357,6)
^78
**END**
**END**

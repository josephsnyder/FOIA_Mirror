Released TIU*1*271 SEQ #255
Extracted from mail message
**KIDS**:TIU*1.0*271^

**INSTALL NAME**
TIU*1.0*271
"BLD",9206,0)
TIU*1.0*271^TEXT INTEGRATION UTILITIES^0^3130523^y
"BLD",9206,1,0)
^^7^7^3120829^
"BLD",9206,1,1,0)
This patch will correct the following issues:
"BLD",9206,1,2,0)
 
"BLD",9206,1,3,0)
 Users unable to find any results when searching for addenda using the 
"BLD",9206,1,4,0)
 Text Integration Utilities (MRT) [TIU MAIN MENU MRT] option
"BLD",9206,1,5,0)
 
"BLD",9206,1,6,0)
 String dates are being stored in the REFERENCE DATE field (#1301) of 
"BLD",9206,1,7,0)
 the TIU DOCUMENT file (#8925).
"BLD",9206,4,0)
^9.64PA^^
"BLD",9206,6)
1^
"BLD",9206,6.3)
12
"BLD",9206,"INID")
^n
"BLD",9206,"INIT")
QUE^TIUP271
"BLD",9206,"KRN",0)
^9.67PA^779.2^20
"BLD",9206,"KRN",.4,0)
.4
"BLD",9206,"KRN",.401,0)
.401
"BLD",9206,"KRN",.402,0)
.402
"BLD",9206,"KRN",.403,0)
.403
"BLD",9206,"KRN",.5,0)
.5
"BLD",9206,"KRN",.84,0)
.84
"BLD",9206,"KRN",3.6,0)
3.6
"BLD",9206,"KRN",3.8,0)
3.8
"BLD",9206,"KRN",9.2,0)
9.2
"BLD",9206,"KRN",9.8,0)
9.8
"BLD",9206,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9206,"KRN",9.8,"NM",1,0)
TIURM1^^0^B40265162
"BLD",9206,"KRN",9.8,"NM",2,0)
TIUSRVP^^0^B50136233
"BLD",9206,"KRN",9.8,"NM","B","TIURM1",1)

"BLD",9206,"KRN",9.8,"NM","B","TIUSRVP",2)

"BLD",9206,"KRN",19,0)
19
"BLD",9206,"KRN",19.1,0)
19.1
"BLD",9206,"KRN",101,0)
101
"BLD",9206,"KRN",409.61,0)
409.61
"BLD",9206,"KRN",771,0)
771
"BLD",9206,"KRN",779.2,0)
779.2
"BLD",9206,"KRN",870,0)
870
"BLD",9206,"KRN",8989.51,0)
8989.51
"BLD",9206,"KRN",8989.52,0)
8989.52
"BLD",9206,"KRN",8994,0)
8994
"BLD",9206,"KRN","B",.4,.4)

"BLD",9206,"KRN","B",.401,.401)

"BLD",9206,"KRN","B",.402,.402)

"BLD",9206,"KRN","B",.403,.403)

"BLD",9206,"KRN","B",.5,.5)

"BLD",9206,"KRN","B",.84,.84)

"BLD",9206,"KRN","B",3.6,3.6)

"BLD",9206,"KRN","B",3.8,3.8)

"BLD",9206,"KRN","B",9.2,9.2)

"BLD",9206,"KRN","B",9.8,9.8)

"BLD",9206,"KRN","B",19,19)

"BLD",9206,"KRN","B",19.1,19.1)

"BLD",9206,"KRN","B",101,101)

"BLD",9206,"KRN","B",409.61,409.61)

"BLD",9206,"KRN","B",771,771)

"BLD",9206,"KRN","B",779.2,779.2)

"BLD",9206,"KRN","B",870,870)

"BLD",9206,"KRN","B",8989.51,8989.51)

"BLD",9206,"KRN","B",8989.52,8989.52)

"BLD",9206,"KRN","B",8994,8994)

"BLD",9206,"QUES",0)
^9.62^^
"BLD",9206,"REQB",0)
^9.611^1^1
"BLD",9206,"REQB",1,0)
TIU*1.0*239^2
"BLD",9206,"REQB","B","TIU*1.0*239",1)

"INIT")
QUE^TIUP271
"MBREQ")
0
"PKG",470,-1)
1^1
"PKG",470,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",470,20,0)
^9.402P^^
"PKG",470,22,0)
^9.49I^1^1
"PKG",470,22,1,0)
1.0^3010801^3010806^66481
"PKG",470,22,1,"PAH",1,0)
271^3130523^1155
"PKG",470,22,1,"PAH",1,1,0)
^^7^7^3130523
"PKG",470,22,1,"PAH",1,1,1,0)
This patch will correct the following issues:
"PKG",470,22,1,"PAH",1,1,2,0)
 
"PKG",470,22,1,"PAH",1,1,3,0)
 Users unable to find any results when searching for addenda using the 
"PKG",470,22,1,"PAH",1,1,4,0)
 Text Integration Utilities (MRT) [TIU MAIN MENU MRT] option
"PKG",470,22,1,"PAH",1,1,5,0)
 
"PKG",470,22,1,"PAH",1,1,6,0)
 String dates are being stored in the REFERENCE DATE field (#1301) of 
"PKG",470,22,1,"PAH",1,1,7,0)
 the TIU DOCUMENT file (#8925).
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","TIUP271")
0^^B27522434^n/a
"RTN","TIUP271",1,0)
TIUP271 ;SMT - Clean up utility for TIU*271 ; 4/12/13 10:57am
"RTN","TIUP271",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**271**;Aug 23, 2012;Build 12
"RTN","TIUP271",3,0)
 Q
"RTN","TIUP271",4,0)
 ; Utility By Seth Thompson - updated by Daniel Huffman
"RTN","TIUP271",5,0)
 ; Clean up String Dates in Field 1301 of file 8925
"RTN","TIUP271",6,0)
 ;
"RTN","TIUP271",7,0)
EN ;
"RTN","TIUP271",8,0)
 N DIE,DA,DR,TIUDT,TIUDA,CNT,RECS,ERR
"RTN","TIUP271",9,0)
 ;
"RTN","TIUP271",10,0)
 I $D(^TMP("TIU271")) W !,"Already Running! Only one instance allowed" Q
"RTN","TIUP271",11,0)
 S ^TMP("TIU271",0)="TIU*1*271 CLEANUP RUNNING"
"RTN","TIUP271",12,0)
 ;
"RTN","TIUP271",13,0)
 S TIUDT=9999999,ERR=0,CNT=1,RECS=0
"RTN","TIUP271",14,0)
 F  S TIUDT=$O(^TIU(8925,"D",TIUDT)) Q:'TIUDT  D
"RTN","TIUP271",15,0)
 . S DA=0 F  S DA=$O(^TIU(8925,"D",TIUDT,DA)) Q:'DA  D
"RTN","TIUP271",16,0)
 . . S RECS=RECS+1 D LOCK^TIUSRVP(.ERR,DA)
"RTN","TIUP271",17,0)
 . . I 'ERR D  Q
"RTN","TIUP271",18,0)
 . . . S DIE="^TIU(8925,",DR="1301///"_+TIUDT
"RTN","TIUP271",19,0)
 . . . D ^DIE
"RTN","TIUP271",20,0)
 . . . D UNLOCK^TIUSRVP(.ERR,DA)
"RTN","TIUP271",21,0)
 . . I $D(^TIU(8925,"D",TIUDT,DA)) D  ;If the node still exists...
"RTN","TIUP271",22,0)
 . . . S ^TMP("TIU271",CNT)="TIU Document:"_DA_" Reference Date:"_$$GET1^DIQ(8925,DA,1301,"I"),CNT=CNT+1
"RTN","TIUP271",23,0)
 . . . S ^TMP("TIU271",CNT)=" Reason: "_$S(ERR:$P(ERR,"^",2),1:"UNKNOWN"),CNT=CNT+1
"RTN","TIUP271",24,0)
 D MAIL
"RTN","TIUP271",25,0)
 K ^TMP("TIU271")
"RTN","TIUP271",26,0)
 S $P(^XTMP("TIUP271",0,"LAST"),U)="COMPLETED"  ;  djh update Set Completed status
"RTN","TIUP271",27,0)
 S $P(^XTMP("TIUP271",0,"LAST"),U,3)=$$NOW^XLFDT  ;  djh update Set completed date/time
"RTN","TIUP271",28,0)
 Q
"RTN","TIUP271",29,0)
 ;
"RTN","TIUP271",30,0)
MAIL ;
"RTN","TIUP271",31,0)
 ; djh update - Change XMD to XMY in newed list
"RTN","TIUP271",32,0)
 N CNT,MSG,XMY,XMDUZ,DIFROM,XMSUB,XMTEXT,I,NMSP,VAR
"RTN","TIUP271",33,0)
 ;
"RTN","TIUP271",34,0)
 S CNT=1
"RTN","TIUP271",35,0)
 S XMY(DUZ)="",XMY("G.TIU CACS")=""
"RTN","TIUP271",36,0)
 ; djh update add 'Patch ' to from text (XMDUZ) - fixes problem with mailman msg not being sent if any user name starts with TIU
"RTN","TIUP271",37,0)
 S XMSUB="REFERENCE DATES CORRECTED",XMTEXT="MSG(",XMDUZ="Patch TIU*1.0*271"
"RTN","TIUP271",38,0)
 S MSG(CNT)="This is a list of TIU Documents that had erroneous dates in the REFERENCE DATE ",CNT=CNT+1
"RTN","TIUP271",39,0)
 S MSG(CNT)="field and could not be cleaned up.",CNT=CNT+1
"RTN","TIUP271",40,0)
 S MSG(CNT)="For more information about the related issue, please see patch TIU*1*271",CNT=CNT+1
"RTN","TIUP271",41,0)
 S MSG(CNT)="",CNT=CNT+1
"RTN","TIUP271",42,0)
 ;
"RTN","TIUP271",43,0)
 S I=0 F  S I=$O(^TMP("TIU271",I)) Q:'I  S MSG(CNT)=^TMP("TIU271",I),CNT=CNT+1
"RTN","TIUP271",44,0)
 S:$O(^TMP("TIU271",0))="" MSG(CNT)="No Problems in REFERENCE DATE correction."
"RTN","TIUP271",45,0)
 D ^XMD
"RTN","TIUP271",46,0)
 Q
"RTN","TIUP271",47,0)
 ;
"RTN","TIUP271",48,0)
QUE ;  Entry point from kids Install
"RTN","TIUP271",49,0)
 N NAMSP,PATCH,JOBN,DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,QUIT,Y,ZTQUEUED,ZTREQ,ZTSAVE
"RTN","TIUP271",50,0)
 S NAMSP=$$NAMSP
"RTN","TIUP271",51,0)
 S JOBN="REFERENCE DATE UPDATE"
"RTN","TIUP271",52,0)
 S PATCH="TIU*1.0*271"
"RTN","TIUP271",53,0)
 ;
"RTN","TIUP271",54,0)
 L +^XTMP(NAMSP):$G(DILOCKTM,3) I '$T D  Q
"RTN","TIUP271",55,0)
 . D BMES^XPDUTL(JOBN_" job is already running.  Halting...")
"RTN","TIUP271",56,0)
 . D MES^XPDUTL("")
"RTN","TIUP271",57,0)
 . D QUIT
"RTN","TIUP271",58,0)
 ;
"RTN","TIUP271",59,0)
 I '$D(^XTMP(NAMSP)) D INITXTMP(NAMSP,JOBN_", "_PATCH,90)        ;90 day life
"RTN","TIUP271",60,0)
 S QUIT=0
"RTN","TIUP271",61,0)
 ;
"RTN","TIUP271",62,0)
 I $G(^XTMP(NAMSP,0,"LAST"))["COMPLETED" D  Q
"RTN","TIUP271",63,0)
 . W !!,*7,"This job has been run before to completion on "
"RTN","TIUP271",64,0)
 . ; djh update - use completed date from piece 3
"RTN","TIUP271",65,0)
 . W $$FMTE^XLFDT($P($G(^XTMP(NAMSP,0,"LAST")),"^",3)),!!
"RTN","TIUP271",66,0)
 . W "If you want to run it again, the global subscript ^XTMP('"_NAMSP_"') must be",!
"RTN","TIUP271",67,0)
 . W "deleted prior to doing so.",!!
"RTN","TIUP271",68,0)
 . D QUIT
"RTN","TIUP271",69,0)
 ;
"RTN","TIUP271",70,0)
 ;ques 2, if running from mumps prompt
"RTN","TIUP271",71,0)
 I '$D(XPDQUES("POS2")) D  I 'ZTDTH D QUIT Q
"RTN","TIUP271",72,0)
 . K DIR
"RTN","TIUP271",73,0)
 . S DIR("A",1)=" Enter when to Queue the "_JOBN_" job to run"
"RTN","TIUP271",74,0)
 . S DIR("A")=" in date@time format"
"RTN","TIUP271",75,0)
 . S DIR("B")="NOW"
"RTN","TIUP271",76,0)
 . S DIR(0)="D^::%DT"
"RTN","TIUP271",77,0)
 . S DIR("?")=" Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 021506@3:30p"
"RTN","TIUP271",78,0)
 . D ^DIR I $D(DUOUT) W !,"Halting..." S ZTDTH="" Q
"RTN","TIUP271",79,0)
 . S:$D(DTOUT) Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","TIUP271",80,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="RUN^"_$$NOW^XLFDT
"RTN","TIUP271",81,0)
 ;
"RTN","TIUP271",82,0)
 ;ques 2, if running from kids install
"RTN","TIUP271",83,0)
 I $D(XPDQUES("POS2")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS2"))
"RTN","TIUP271",84,0)
 ;
"RTN","TIUP271",85,0)
 D BMES^XPDUTL("=============================================================")
"RTN","TIUP271",86,0)
 D MES^XPDUTL("Queuing background job for "_JOBN_"...")
"RTN","TIUP271",87,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","TIUP271",88,0)
 D MES^XPDUTL("==============================================================")
"RTN","TIUP271",89,0)
 I ZTDTH="" D BMES^XPDUTL(JOBN_" NOT QUEUED") D QUIT Q
"RTN","TIUP271",90,0)
 ;
"RTN","TIUP271",91,0)
 S:$D(^XTMP(NAMSP,0,"LAST")) ^XTMP(NAMSP,0,"ZAUDIT",$H)="RE-STARTED ON"_"^"_$$NOW^XLFDT_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","TIUP271",92,0)
 ;
"RTN","TIUP271",93,0)
 I $P($G(^XTMP(NAMSP,0,"LAST")),"^")="STOP" D
"RTN","TIUP271",94,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="RUN^"_$$NOW^XLFDT
"RTN","TIUP271",95,0)
 E  D
"RTN","TIUP271",96,0)
 . S ^XTMP(NAMSP,0,"LAST")="RUN^"_$$NOW^XLFDT_"^^^"
"RTN","TIUP271",97,0)
 ;
"RTN","TIUP271",98,0)
 S ZTRTN="EN^"_NAMSP,ZTIO=""
"RTN","TIUP271",99,0)
 S ZTDESC="Background job "_JOBN_" updated via "_PATCH
"RTN","TIUP271",100,0)
 S ZTSAVE("JOBN")=""
"RTN","TIUP271",101,0)
 L -^XTMP(NAMSP)
"RTN","TIUP271",102,0)
 D ^%ZTLOAD
"RTN","TIUP271",103,0)
 D:$D(ZTSK)
"RTN","TIUP271",104,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","TIUP271",105,0)
 . D BMES^XPDUTL("")
"RTN","TIUP271",106,0)
 D BMES^XPDUTL("")
"RTN","TIUP271",107,0)
 K XPDQUES
"RTN","TIUP271",108,0)
 Q
"RTN","TIUP271",109,0)
 ;
"RTN","TIUP271",110,0)
NAMSP() ;
"RTN","TIUP271",111,0)
 Q $T(+0)
"RTN","TIUP271",112,0)
 ;
"RTN","TIUP271",113,0)
STOP ;stop job command
"RTN","TIUP271",114,0)
 I $$ST S ^XTMP($$NAMSP,0,"STOP")="" D
"RTN","TIUP271",115,0)
 . W !,"TALLY MISSING EXPIRATION DATES Job - set to STOP Soon"
"RTN","TIUP271",116,0)
 . W !!,"Check Status to be sure it has stopped and is not running..."
"RTN","TIUP271",117,0)
 . W !,"     (D STATUS^PSOTEXP1)"
"RTN","TIUP271",118,0)
 Q
"RTN","TIUP271",119,0)
 ;
"RTN","TIUP271",120,0)
ST() ;status
"RTN","TIUP271",121,0)
 L +^XTMP($$NAMSP):$G(DILOCKTM,3) I $T D  Q 0
"RTN","TIUP271",122,0)
 . L -^XTMP($$NAMSP)
"RTN","TIUP271",123,0)
 . W !,"*** NOT CURRENTLY RUNNING! ***",!
"RTN","TIUP271",124,0)
 Q 1
"RTN","TIUP271",125,0)
 ;
"RTN","TIUP271",126,0)
INITXTMP(NAMSP,TITLE,LIFE) ;create ^Xtmp according to SAC std
"RTN","TIUP271",127,0)
 N BEGDT,PURGDT
"RTN","TIUP271",128,0)
 S BEGDT=$$NOW^XLFDT()
"RTN","TIUP271",129,0)
 S PURGDT=$$FMADD^XLFDT(BEGDT,LIFE)
"RTN","TIUP271",130,0)
 I $G(^XTMP(NAMSP,0))']"" S ^XTMP(NAMSP,0)=PURGDT_"^"_BEGDT_"^"_TITLE
"RTN","TIUP271",131,0)
 Q
"RTN","TIUP271",132,0)
 ;
"RTN","TIUP271",133,0)
QUIT ;
"RTN","TIUP271",134,0)
 L -^XTMP(NAMSP)
"RTN","TIUP271",135,0)
 Q
"RTN","TIUP271",136,0)
 ;
"RTN","TIURM1")
0^1^B40265162^B39918877
"RTN","TIURM1",1,0)
TIURM1 ; SLC/JER - MIS Document Review ; 8/23/12 1:27pm
"RTN","TIURM1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**100,113,271**;Jun 20, 1997;Build 12
"RTN","TIURM1",3,0)
GATHER(TIUPREF,CLASS,STATIFNS,EARLY,LATE,DIVIFNS) ; Find/sort
"RTN","TIURM1",4,0)
 ;records for the list
"RTN","TIURM1",5,0)
 N TIUDA,TIUSFLD,TIUI,TIUQ
"RTN","TIURM1",6,0)
 S TIUSFLD=$P(TIUPREF,U,3)
"RTN","TIURM1",7,0)
 S TIUSFLD=$S(TIUSFLD="P":".02",TIUSFLD="D":".01",TIUSFLD="S":".05",TIUSFLD="C":"1507",TIUSFLD="A":"1202",TIUSFLD="E":"1208",1:"1301")
"RTN","TIURM1",8,0)
 S TIUI=EARLY F  S TIUI=$O(^TIU(8925,"F",TIUI)) Q:+TIUI'>0!(+TIUI>LATE)  D
"RTN","TIURM1",9,0)
 . S TIUDA=0
"RTN","TIURM1",10,0)
 . F  S TIUDA=$O(^TIU(8925,"F",TIUI,TIUDA)) Q:+TIUDA'>0  D
"RTN","TIURM1",11,0)
 . . ; Consider adding view check here
"RTN","TIURM1",12,0)
 . . I '$$INTYPES(TIUDA) Q
"RTN","TIURM1",13,0)
 . . I '$$INSTATUS(TIUDA,STATIFNS) Q
"RTN","TIURM1",14,0)
 . . I +$G(DIVIFNS("ENTRIES")),'$$ININST(TIUDA,.DIVIFNS) Q
"RTN","TIURM1",15,0)
 . . S TIUQ=$$RESOLVE^TIUR1(TIUDA,TIUSFLD)
"RTN","TIURM1",16,0)
 . . S ^TMP("TIUI",$J,TIUQ,(9999999-TIUI),TIUDA)=""
"RTN","TIURM1",17,0)
 Q
"RTN","TIURM1",18,0)
 ;
"RTN","TIURM1",19,0)
INTYPES(TIUDA) ; Evaluates whether a record is among the selected types
"RTN","TIURM1",20,0)
 N TIUI,TIUTYP,TIUY S (TIUI,TIUY)=0
"RTN","TIURM1",21,0)
 S TIUTYP=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIURM1",22,0)
 ;*271 Quit for addenda only if we found a parent.
"RTN","TIURM1",23,0)
 I TIUTYP=81 S TIUY=+$$DADINTYP(TIUDA) G:TIUY INTYPX
"RTN","TIURM1",24,0)
 F  S TIUI=$O(^TMP("TIUTYP",$J,TIUI)) Q:+TIUI'>0!+TIUY  D
"RTN","TIURM1",25,0)
 . I +$P(^TMP("TIUTYP",$J,TIUI),U,2)=TIUTYP S TIUY=1
"RTN","TIURM1",26,0)
INTYPX Q TIUY
"RTN","TIURM1",27,0)
 ;
"RTN","TIURM1",28,0)
INSTATUS(TIUDA,STATIFNS) ; Evaluates whether a record
"RTN","TIURM1",29,0)
 ;is among the selected statuses
"RTN","TIURM1",30,0)
 N TIUS,TIUSTAT,TIUSTATE,TIUY S TIUY=0
"RTN","TIURM1",31,0)
 S TIUSTATE=+$P($G(^TIU(8925,+TIUDA,0)),U,5)
"RTN","TIURM1",32,0)
 S TIUS=1 F  S TIUSTAT=$P(STATIFNS,";",TIUS) Q:'TIUSTAT!TIUY  D
"RTN","TIURM1",33,0)
 . S TIUS=TIUS+1
"RTN","TIURM1",34,0)
 . I TIUSTAT=TIUSTATE S TIUY=1
"RTN","TIURM1",35,0)
 Q TIUY
"RTN","TIURM1",36,0)
ININST(TIUDA,TIUDI) ; Evaluates whether a TIU DOCUMENT record
"RTN","TIURM1",37,0)
 ; is among the selected divisions
"RTN","TIURM1",38,0)
 ; Input -- TIUDA    TIU DOCUMENT file (#8925) IEN
"RTN","TIURM1",39,0)
 ;       -- TIUDI(   i.e. TIUDI(file #40.8 IEN)=Institution file
"RTN","TIURM1",40,0)
 ;                                           pointer for file #40.8 entry
"RTN","TIURM1",41,0)
 ; Output - TIUY     0= record not in selected division
"RTN","TIURM1",42,0)
 ;                   1= record in selected division
"RTN","TIURM1",43,0)
 N TIUIFP,TIUI,TIUINST,TIUY S TIUY=0
"RTN","TIURM1",44,0)
 S TIUINST=+$P($G(^TIU(8925,+TIUDA,12)),U,12)
"RTN","TIURM1",45,0)
 S TIUI=0 F  S TIUI=$O(TIUDI(TIUI)) Q:'TIUI!TIUY  D
"RTN","TIURM1",46,0)
 . S TIUIFP=$G(TIUDI(TIUI))
"RTN","TIURM1",47,0)
 . I TIUIFP=TIUINST S TIUY=1
"RTN","TIURM1",48,0)
 Q TIUY
"RTN","TIURM1",49,0)
DADINTYP(TIUDA) ; Evaluates whether addendum's parent is among
"RTN","TIURM1",50,0)
 ;                 the selected types
"RTN","TIURM1",51,0)
 N TIUI,TIUDTYP,TIUY S (TIUI,TIUY)=0
"RTN","TIURM1",52,0)
 S TIUDTYP=+$G(^TIU(8925,+$P($G(^TIU(8925,+TIUDA,0)),U,6),0))
"RTN","TIURM1",53,0)
 F  S TIUI=$O(^TMP("TIUTYP",$J,TIUI)) Q:+TIUI'>0!+TIUY  D
"RTN","TIURM1",54,0)
 . I +$P(^TMP("TIUTYP",$J,TIUI),U,2)=TIUDTYP S TIUY=1
"RTN","TIURM1",55,0)
 Q TIUY
"RTN","TIURM1",56,0)
 ;
"RTN","TIURM1",57,0)
PUTLIST(TIUPREF,TIUCLASS,STATUS,DIVIFNS) ; Expands list elements for LM Template
"RTN","TIURM1",58,0)
 N TIUJ,TIUQ,TIUDA,TIUPICK,TIUORDER,TIUEXPKD,TIUSFLD
"RTN","TIURM1",59,0)
 S VALMCNT=0
"RTN","TIURM1",60,0)
 S TIUSFLD=$P(TIUPREF,U,3)
"RTN","TIURM1",61,0)
 S TIUSFLD=$S(TIUSFLD="P":".02",TIUSFLD="D":".01",TIUSFLD="S":".05",TIUSFLD="C":"1507",TIUSFLD="A":"1202",TIUSFLD="E":"1208",1:"1301")
"RTN","TIURM1",62,0)
 S TIUORDER=$S($P(TIUPREF,U,4)="A":1,1:-1)
"RTN","TIURM1",63,0)
 S TIUPICK=+$O(^ORD(101,"B","TIU ACTION SELECT LIST ELEMENT",0))
"RTN","TIURM1",64,0)
 S TIUQ="" F  S TIUQ=$O(^TMP("TIUI",$J,TIUQ)) Q:TIUQ']""  D
"RTN","TIURM1",65,0)
 . S TIUJ=0 F  S TIUJ=$O(^TMP("TIUI",$J,TIUQ,TIUJ)) Q:+TIUJ'>0  D
"RTN","TIURM1",66,0)
 . . S TIUDA=0
"RTN","TIURM1",67,0)
 . . F  S TIUDA=$O(^TMP("TIUI",$J,TIUQ,TIUJ,TIUDA)) Q:'TIUDA  D
"RTN","TIURM1",68,0)
 . . . D REPLACE^TIUR2(TIUDA,TIUQ,TIUSFLD,TIUJ,.TIUEXPKD)
"RTN","TIURM1",69,0)
 D SETLIST(TIUORDER,.VALMCNT)
"RTN","TIURM1",70,0)
 S ^TMP("TIUR",$J,0)=+$G(VALMCNT)_U_STATUS("WORDS")
"RTN","TIURM1",71,0)
 S ^TMP("TIUR",$J,"CLASS")=TIUCLASS
"RTN","TIURM1",72,0)
 S ^TMP("TIUR",$J,"#")=TIUPICK_"^1:"_+$G(VALMCNT)
"RTN","TIURM1",73,0)
 M ^TMP("TIUR",$J,"DIV")=DIVIFNS
"RTN","TIURM1",74,0)
 I $D(VALMHDR)>9 D HDR^TIURMH
"RTN","TIURM1",75,0)
 I +$G(VALMCNT)'>0 D
"RTN","TIURM1",76,0)
 . S ^TMP("TIUR",$J,1,0)="",VALMCNT=2
"RTN","TIURM1",77,0)
 . S ^TMP("TIUR",$J,2,0)="     No records found to satisfy search criteria."
"RTN","TIURM1",78,0)
 . S ^TMP("TIUR",$J,"IDX",1,0)="" ; User can't select lines 1 or 2
"RTN","TIURM1",79,0)
 . S ^TMP("TIUR",$J,"IDX",2,0)=""
"RTN","TIURM1",80,0)
 ; -- Expand to show kids that fit:
"RTN","TIURM1",81,0)
 I '$G(TIURBLD),$D(TIUEXPKD) D EXPANDKD^TIUR2(.STATUS,.TIUEXPKD)
"RTN","TIURM1",82,0)
 Q
"RTN","TIURM1",83,0)
SETLIST(TIUORDER,VALMCNT) ; Set items from ^TMP("TIUI",$J) into
"RTN","TIURM1",84,0)
 ;List Template list
"RTN","TIURM1",85,0)
 N SORTVAL,TIUDTM,TIUDA
"RTN","TIURM1",86,0)
 S SORTVAL=""
"RTN","TIURM1",87,0)
 F  S SORTVAL=$O(^TMP("TIUI",$J,SORTVAL),TIUORDER) Q:SORTVAL=""  D
"RTN","TIURM1",88,0)
 . S TIUDTM=0
"RTN","TIURM1",89,0)
 . F  S TIUDTM=$O(^TMP("TIUI",$J,SORTVAL,TIUDTM)) Q:'TIUDTM  D
"RTN","TIURM1",90,0)
 . . S TIUDA=0
"RTN","TIURM1",91,0)
 . . F  S TIUDA=$O(^TMP("TIUI",$J,SORTVAL,TIUDTM,TIUDA)) Q:'TIUDA  D
"RTN","TIURM1",92,0)
 . . . D ADDELMNT(TIUDA,.VALMCNT)
"RTN","TIURM1",93,0)
 Q
"RTN","TIURM1",94,0)
 ;
"RTN","TIURM1",95,0)
ADDELMNT(DA,TIUCNT,APPEND) ; Add each element to the list
"RTN","TIURM1",96,0)
 N PT,ADT,DDT,AUT,AMD,EDT,LCT,SDT,TIULST4,INSTA,TIUSTN
"RTN","TIURM1",97,0)
 N TIUREC,TIUD0,TIUD12,TIUD13,TIUD15,STATX,TIULI,DOC ;P74 newed DOC
"RTN","TIURM1",98,0)
 N PREFIX,TIUGDATA
"RTN","TIURM1",99,0)
 I '$D(^TIU(8925,TIUDA,0)) Q
"RTN","TIURM1",100,0)
 I $G(^TMP("TIUR",$J,2,0))="     No records found to satisfy search criteria." D
"RTN","TIURM1",101,0)
 . K ^TMP("TIUR",$J,2),^TMP("TIUR",$J,"IDX",2),^TMP("TIUR",$J,"IDX",1)
"RTN","TIURM1",102,0)
 . S TIUCNT=0
"RTN","TIURM1",103,0)
 S TIUD0=$G(^TIU(8925,+DA,0)),TIUD12=$G(^TIU(8925,+DA,12))
"RTN","TIURM1",104,0)
 S TIUD13=$G(^TIU(8925,+DA,13)),TIUD15=$G(^TIU(8925,+DA,15))
"RTN","TIURM1",105,0)
 S DOC=$$PNAME^TIULC1(+TIUD0)
"RTN","TIURM1",106,0)
 I DOC="Addendum" S DOC=DOC_" to "_$$PNAME^TIULC1(+$G(^TIU(8925,+$P(TIUD0,U,6),0)))
"RTN","TIURM1",107,0)
 S PREFIX=$$PREFIX^TIULA2(TIUDA,0)
"RTN","TIURM1",108,0)
 S PT=$$NAME^TIULS($$PTNAME^TIULC1($P(TIUD0,U,2)),"LAST,FI MI")
"RTN","TIURM1",109,0)
 S TIULI=$E(PT)
"RTN","TIURM1",110,0)
 S PT=PREFIX_PT
"RTN","TIURM1",111,0)
 S TIULST4=$E($P($G(^DPT(+$P(TIUD0,U,2),0)),U,9),6,9)
"RTN","TIURM1",112,0)
 S TIULST4="("_TIULI_TIULST4_")"
"RTN","TIURM1",113,0)
 S ADT=$$DATE^TIULS($P(TIUD0,U,7),"MM/DD/YY")
"RTN","TIURM1",114,0)
 S DDT=$$DATE^TIULS($P(TIUD0,U,8),"MM/DD/YY")
"RTN","TIURM1",115,0)
 S AMD=$$PERSNAME^TIULC1($P(TIUD12,U,8)) S:AMD="UNKNOWN" AMD=""
"RTN","TIURM1",116,0)
 S AUT=$$PERSNAME^TIULC1($P(TIUD12,U,2)) S:AUT="UNKNOWN" AUT=""
"RTN","TIURM1",117,0)
 S AMD=$$NAME^TIULS(AMD,"LAST, FI MI")
"RTN","TIURM1",118,0)
 S AUT=$$NAME^TIULS(AUT,"LAST, FI MI")
"RTN","TIURM1",119,0)
 S EDT=$$DATE^TIULS($P(TIUD13,U,7),"MM/DD/YY")
"RTN","TIURM1",120,0)
 S SDT=$S(+$P(TIUD15,U,7):+$P(TIUD15,U,7),+$P(TIUD0,U,5)'<7:+$P(TIUD15,U),1:"")
"RTN","TIURM1",121,0)
 S SDT=$$DATE^TIULS(SDT,"MM/DD/YY")
"RTN","TIURM1",122,0)
 S STATX=$P($G(^TIU(8925.6,+$P(TIUD0,U,5),0)),U)
"RTN","TIURM1",123,0)
 S LCT=$P(TIUD0,U,10)
"RTN","TIURM1",124,0)
 S INSTA=""
"RTN","TIURM1",125,0)
 I +$P(TIUD12,U,12)>0 D
"RTN","TIURM1",126,0)
 . S TIUSTN=$$NS^XUAF4($P(TIUD12,U,12))
"RTN","TIURM1",127,0)
 . I $P(TIUSTN,U,2)]"" S INSTA=$P(TIUSTN,U,2)
"RTN","TIURM1",128,0)
 S INSTA=$E(INSTA,1,8)
"RTN","TIURM1",129,0)
 S TIUCNT=+$G(TIUCNT)+1
"RTN","TIURM1",130,0)
 S TIUREC=$$SETFLD^VALM1(TIUCNT,"","NUMBER")
"RTN","TIURM1",131,0)
 S TIUREC=$$SETFLD^VALM1(PT,TIUREC,"PATIENT NAME")
"RTN","TIURM1",132,0)
 S TIUREC=$$SETFLD^VALM1(TIULST4,TIUREC,"LAST I/LAST 4")
"RTN","TIURM1",133,0)
 S TIUREC=$$SETFLD^VALM1(DOC,TIUREC,"DOCUMENT TYPE")
"RTN","TIURM1",134,0)
 S TIUREC=$$SETFLD^VALM1(ADT,TIUREC,"ADMISSION DATE")
"RTN","TIURM1",135,0)
 S TIUREC=$$SETFLD^VALM1(DDT,TIUREC,"DISCH DATE")
"RTN","TIURM1",136,0)
 S TIUREC=$$SETFLD^VALM1(EDT,TIUREC,"DICT DATE")
"RTN","TIURM1",137,0)
 S TIUREC=$$SETFLD^VALM1(LCT,TIUREC,"LINE COUNT")
"RTN","TIURM1",138,0)
 S TIUREC=$$SETFLD^VALM1($$LOWER^TIULS(STATX),TIUREC,"STATUS")
"RTN","TIURM1",139,0)
 S TIUREC=$$SETFLD^VALM1(AUT,TIUREC,"AUTHOR")
"RTN","TIURM1",140,0)
 S TIUREC=$$SETFLD^VALM1(AMD,TIUREC,"ATTENDING")
"RTN","TIURM1",141,0)
 S TIUREC=$$SETFLD^VALM1(INSTA,TIUREC,"DIVISION")
"RTN","TIURM1",142,0)
 S ^TMP("TIUR",$J,TIUCNT,0)=TIUREC
"RTN","TIURM1",143,0)
 S ^TMP("TIUR",$J,"IDX",TIUCNT,TIUCNT)="" W "."
"RTN","TIURM1",144,0)
 S ^TMP("TIURIDX",$J,TIUCNT)=TIUCNT_U_DA_U_PREFIX
"RTN","TIURM1",145,0)
 S ^TMP("TIUR",$J,"IEN",DA,TIUCNT)=""
"RTN","TIURM1",146,0)
 S TIUGDATA=$$IDDATA^TIURECL1(DA,TIUD0)
"RTN","TIURM1",147,0)
 I TIUGDATA S ^TMP("TIUR",$J,"IDDATA",DA)=TIUGDATA
"RTN","TIURM1",148,0)
 I +$G(APPEND) D
"RTN","TIURM1",149,0)
 . D RESTORE^VALM10(TIUCNT)
"RTN","TIURM1",150,0)
 . D CNTRL^VALM10(TIUCNT,1,$G(VALM("RM")),IOINHI,IOINORM),HDR^TIURMH
"RTN","TIURM1",151,0)
 . S VALMSG="** Item #"_TIUCNT_" Added **"
"RTN","TIURM1",152,0)
 . S $P(^TMP("TIUR",$J,0),U)=TIUCNT
"RTN","TIURM1",153,0)
 . S $P(^TMP("TIUR",$J,"#"),":",2)=TIUCNT
"RTN","TIURM1",154,0)
 . S VALMCNT=TIUCNT
"RTN","TIURM1",155,0)
 . I $D(VALMHDR)>9 D HDR^TIURMH
"RTN","TIURM1",156,0)
 Q
"RTN","TIUSRVP")
0^2^B50136233^B49614327
"RTN","TIUSRVP",1,0)
TIUSRVP ; SLC/JER - RPCs for CREATE & UPDATE ; 8/31/12 12:41pm
"RTN","TIUSRVP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,7,19,28,47,89,104,100,115,109,167,113,112,175,157,184,239,271**;Jun 20, 1997;Build 12
"RTN","TIUSRVP",3,0)
MAKE(SUCCESS,DFN,TITLE,VDT,VLOC,VSIT,TIUX,VSTR,SUPPRESS,NOASF) ; New Document
"RTN","TIUSRVP",4,0)
 ; SUCCESS = (by ref) TIU DOCUMENT # (PTR to 8925)
"RTN","TIUSRVP",5,0)
 ;         = 0^Explanatory message if no SUCCESS
"RTN","TIUSRVP",6,0)
 ; DFN     = Patient (#2)
"RTN","TIUSRVP",7,0)
 ; TITLE   = TIU Document Definition (#8925.1)
"RTN","TIUSRVP",8,0)
 ; [VDT]   = Date(/Time) of Visit
"RTN","TIUSRVP",9,0)
 ; [VLOC]  = Visit Location (HOSPITAL LOCATION)
"RTN","TIUSRVP",10,0)
 ; [VSIT]  = Visit file ien (#9000010)
"RTN","TIUSRVP",11,0)
 ; [VSTR]  = Visit string (i.e., VLOC;VDT;VTYPE)
"RTN","TIUSRVP",12,0)
 ; [NOASF] = if 1=Do Not Set ASAVE cross-reference
"RTN","TIUSRVP",13,0)
 ; TIUX    = (by ref) array containing field data and document body
"RTN","TIUSRVP",14,0)
 ;
"RTN","TIUSRVP",15,0)
 N TIU,TIUDA,LDT,NEWREC
"RTN","TIUSRVP",16,0)
 S SUCCESS=0
"RTN","TIUSRVP",17,0)
 I +$G(VSIT) S VSTR=$$VSTRBLD(+VSIT)
"RTN","TIUSRVP",18,0)
 I $L($G(VSTR)) D
"RTN","TIUSRVP",19,0)
 . S VDT=$S(+$G(VDT):+$G(VDT),1:$P(VSTR,";",2))
"RTN","TIUSRVP",20,0)
 . S LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",21,0)
 . S VLOC=$S(+$G(VLOC):+$G(VLOC),1:$P(VSTR,";"))
"RTN","TIUSRVP",22,0)
 . ; If note is for Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",23,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",24,0)
 . ; Otherwise, call PATVADPT^TIULV
"RTN","TIUSRVP",25,0)
 . D PATVADPT^TIULV(.TIU,DFN,"",VSTR)
"RTN","TIUSRVP",26,0)
 I '+$G(VSIT),'$L($G(VSTR)),+$G(VDT),+$G(VLOC) D
"RTN","TIUSRVP",27,0)
 . S VDT=$G(VDT),LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",28,0)
 . ; If note is for Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",29,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",30,0)
 . ; Otherwise, call MAIN^TIUVSIT
"RTN","TIUSRVP",31,0)
 . D MAIN^TIUVSIT(.TIU,DFN,"",VDT,LDT,"LAST",0,VLOC)
"RTN","TIUSRVP",32,0)
 I '+$G(TIU("VSTR")) D
"RTN","TIUSRVP",33,0)
 . D EVENT^TIUSRVP1(.TIU,DFN)
"RTN","TIUSRVP",34,0)
 S TIU("INST")=$$DIVISION^TIULC1(+TIU("LOC"))
"RTN","TIUSRVP",35,0)
 I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,1:0) S SUCCESS="0^"_$$EZBLD^DIALOG(89250001) Q
"RTN","TIUSRVP",36,0)
 ;
"RTN","TIUSRVP",37,0)
 S TIUDA=$$GETREC(DFN,.TIU,TITLE,.NEWREC)
"RTN","TIUSRVP",38,0)
 I +TIUDA'>0 S SUCCESS="0^"_$$EZBLD^DIALOG(89250002) Q
"RTN","TIUSRVP",39,0)
 S SUCCESS=+TIUDA
"RTN","TIUSRVP",40,0)
 D STUFREC^TIUSRVP1(+TIUDA,.TIUX,DFN,,TITLE,.TIU)
"RTN","TIUSRVP",41,0)
 S:'+$G(NOASF) ^TIU(8925,"ASAVE",DUZ,TIUDA)=""
"RTN","TIUSRVP",42,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",43,0)
 M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUSRVP",44,0)
 D SETXT0(TIUDA)
"RTN","TIUSRVP",45,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",46,0)
 I +SUCCESS'>0 D DIK^TIURB2(TIUDA) Q
"RTN","TIUSRVP",47,0)
 I +$O(^TIU(8925,+TIUDA,"TEMP",0)) D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",48,0)
 I +$G(TIU("STOP")) D DEFER^TIUVSIT(TIUDA,TIU("STOP")) I 1
"RTN","TIUSRVP",49,0)
 E  D QUE^TIUPXAP1
"RTN","TIUSRVP",50,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",51,0)
 . D RELEASE^TIUT(TIUDA,1)
"RTN","TIUSRVP",52,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",53,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",54,0)
 Q
"RTN","TIUSRVP",55,0)
VSTRBLD(VSIT) ; Given Visit ien, build Visit-Descriptor String
"RTN","TIUSRVP",56,0)
 N TIUY,VSIT0,VLOC,VDT,VSVCAT
"RTN","TIUSRVP",57,0)
 S VSIT0=$G(^AUPNVSIT(+VSIT,0)),VDT=+$P(VSIT0,U),VLOC=+$P(VSIT0,U,22)
"RTN","TIUSRVP",58,0)
 S VSVCAT=$P(VSIT0,U,7)
"RTN","TIUSRVP",59,0)
 S TIUY=VLOC_";"_VDT_";"_VSVCAT
"RTN","TIUSRVP",60,0)
 Q TIUY
"RTN","TIUSRVP",61,0)
SETXT0(TIUDA) ; Set root node of "TEMP" WP-field
"RTN","TIUSRVP",62,0)
 N TIUC,TIUI S (TIUC,TIUI)=0
"RTN","TIUSRVP",63,0)
 F  S TIUI=$O(^TIU(8925,TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",64,0)
 . S:$D(^TIU(8925,TIUDA,"TEMP",TIUI,0)) TIUC=TIUC+1
"RTN","TIUSRVP",65,0)
 S ^TIU(8925,TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",66,0)
 Q
"RTN","TIUSRVP",67,0)
MAKEADD(TIUDADD,TIUDA,TIUX,SUPPRESS) ; Create addendum
"RTN","TIUSRVP",68,0)
 ; For backward compatibility
"RTN","TIUSRVP",69,0)
 ; Use MAKEADD^TIUSRVP2 now, please
"RTN","TIUSRVP",70,0)
 D MAKEADD^TIUSRVP2(.TIUDADD,TIUDA,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",71,0)
 Q
"RTN","TIUSRVP",72,0)
UPDATE(SUCCESS,TIUDA,TIUX,SUPPRESS) ; Update existing Document
"RTN","TIUSRVP",73,0)
 N TIU,TIUI,TIUC,TIUD0,TIUD12,TIUD14,TIUD15,TIUCPF,TITLE,PRFUNLNK,TIUY,TIUCC,TIUFLAG S TIUFLAG=0
"RTN","TIUSRVP",74,0)
 I $S(+$G(TIUDA)'>0:1,'$D(^TIU(8925,+TIUDA,0)):1,1:0) D  Q
"RTN","TIUSRVP",75,0)
 . S SUCCESS="0^ Cannot update a non-existent document..."
"RTN","TIUSRVP",76,0)
 I +$P($G(^TIU(8925,+TIUDA,0)),U,5)>6 D  Q
"RTN","TIUSRVP",77,0)
 . S SUCCESS="0^ TIU Document #"_TIUDA_" is already signed..."
"RTN","TIUSRVP",78,0)
 I $D(TIUX("TEXT")) D
"RTN","TIUSRVP",79,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",80,0)
 . M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT")
"RTN","TIUSRVP",81,0)
 . S (TIUC,TIUI)=0
"RTN","TIUSRVP",82,0)
 . F  S TIUI=$O(^TIU(8925,+TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",83,0)
 . . S TIUC=TIUC+1
"RTN","TIUSRVP",84,0)
 . I +TIUC>0 S ^TIU(8925,+TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",85,0)
 . K TIUX("TEXT")
"RTN","TIUSRVP",86,0)
 I +$O(TIUX(""))'>0 S:+$G(SUPPRESS) SUCCESS=+TIUDA Q
"RTN","TIUSRVP",87,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD12=$G(^(12)),TIUD14=$G(^(14)),TITLE=+TIUD0
"RTN","TIUSRVP",88,0)
 ;Set a flag to indicate whether or not a Title is a member of the
"RTN","TIUSRVP",89,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVP",90,0)
 S TIUCPF=+$$ISA^TIULX(TITLE,+$$CLASS^TIUCP)
"RTN","TIUSRVP",91,0)
 D SETCOS^TIUSRVP2(TIUDA,.TIUX,TIUD0,TIUD12)
"RTN","TIUSRVP",92,0)
 ; Consult association changed?  If so, rollback to Active status.    VM/RJT - *239
"RTN","TIUSRVP",93,0)
 S TIUCC=$P($G(TIUD14),"^",5)
"RTN","TIUSRVP",94,0)
 I +$G(TIUX("1405"))>0,+$G(TIUCC)>0,(+$G(TIUX("1405"))'=+TIUCC) D ROLLBACK^TIUCNSLT(TIUDA) S TIUFLAG=1
"RTN","TIUSRVP",95,0)
 ; Title changed? Refile DC
"RTN","TIUSRVP",96,0)
 I +$G(TIUX(.01))>0,(+$G(TIUX(.01))'=+TIUD0) D
"RTN","TIUSRVP",97,0)
 . S TIUX(.04)=$$DOCCLASS^TIULC1(+$G(TIUX(.01)))
"RTN","TIUSRVP",98,0)
 . S TIUY=0 D ISCNSLT^TIUCNSLT(.TIUY,TITLE)
"RTN","TIUSRVP",99,0)
 . I $G(TIUY),TIUFLAG=0 D ROLLBACK^TIUCNSLT(TIUDA) ;  if changed to Non-Consult title - VMP/RJT - *239
"RTN","TIUSRVP",100,0)
 . ; If change title from PRF to nonPRF, set flg to unlink note:
"RTN","TIUSRVP",101,0)
 . I $$ISPFTTL^TIUPRFL(TITLE),'$$ISPFTTL^TIUPRFL(+$G(TIUX(.01))) S PRFUNLNK=1
"RTN","TIUSRVP",102,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS),TIUCPF)
"RTN","TIUSRVP",103,0)
 I +SUCCESS'>0 K ^TIU(8925,+TIUDA,"TEMP") Q
"RTN","TIUSRVP",104,0)
 I $G(PRFUNLNK) D UNLINK^TIUPRF1(TIUDA)
"RTN","TIUSRVP",105,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVP",106,0)
 I $D(^TIU(8925,+TIUDA,"TEMP")) D
"RTN","TIUSRVP",107,0)
 . K ^TIU(8925,+TIUDA,"TEXT")
"RTN","TIUSRVP",108,0)
 . D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",109,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",110,0)
 . S:'+$G(SUCCESS) SUCCESS=+TIUDA
"RTN","TIUSRVP",111,0)
 ; If signed, re-file /ES/
"RTN","TIUSRVP",112,0)
 S TIUD15=$G(^TIU(8925,+TIUDA,15))
"RTN","TIUSRVP",113,0)
 I +TIUD15 D
"RTN","TIUSRVP",114,0)
 . N TIUBY,DR,DIE,DA,X,Y S TIUBY=$P(TIUD15,U,2) Q:+TIUBY'>0
"RTN","TIUSRVP",115,0)
 . S DR="1503///^S X=$$SIGNAME^TIULS("_TIUBY_");1504///^S X=$$SIGTITL^TIULS("_TIUBY_")"
"RTN","TIUSRVP",116,0)
 . S DA=TIUDA,DIE=8925 D ^DIE
"RTN","TIUSRVP",117,0)
 ; send alerts
"RTN","TIUSRVP",118,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",119,0)
 . I +$P(TIUD0,U,5)<5,'$D(TIUX(.05)) D UPDSTAT(TIUDA,+$G(TIUD0))
"RTN","TIUSRVP",120,0)
 . D SEND^TIUALRT(TIUDA),SENDID^TIUALRT1(TIUDA):+$G(^TIU(8925,+TIUDA,21))
"RTN","TIUSRVP",121,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",122,0)
 Q
"RTN","TIUSRVP",123,0)
SETCOS(TIUDA,TIUX,TIUD0,TIUD12) ; set cosig req
"RTN","TIUSRVP",124,0)
 ; For backward compatibility
"RTN","TIUSRVP",125,0)
 ; Use SETCOS^TIUSRVP2 now, please
"RTN","TIUSRVP",126,0)
 D SETCOS^TIUSRVP2(TIUDA,.TIUX,TIUD0,TIUD12)
"RTN","TIUSRVP",127,0)
 Q
"RTN","TIUSRVP",128,0)
UPDSTAT(DA,TITLE) ; Update status on commit
"RTN","TIUSRVP",129,0)
 N DR,DIE S DR=".05////"_$$STATUS^TIUSRVP1(DA,0,TITLE)
"RTN","TIUSRVP",130,0)
 I '+$P($G(^TIU(8925,DA,13)),U,4) S DR=DR_";1304////^S X=$$NOW^XLFDT"
"RTN","TIUSRVP",131,0)
 S DIE=8925
"RTN","TIUSRVP",132,0)
 D ^DIE
"RTN","TIUSRVP",133,0)
 Q
"RTN","TIUSRVP",134,0)
GETREC(DFN,TIU,TITLE,TIUNEW) ; Get/create document record
"RTN","TIUSRVP",135,0)
 N DA,DIC,DIE,DLAYGO,DR,X,Y,TIUDPRM,TIUFPRIV,TIUHIT,TIUSCAT
"RTN","TIUSRVP",136,0)
 S (TIUHIT,DA)=0,TIUFPRIV=1
"RTN","TIUSRVP",137,0)
 S (DIC,DLAYGO)=8925,DIC(0)="FL"
"RTN","TIUSRVP",138,0)
 S X=""""_"`"_+TITLE_"""" D ^DIC K DIC("S")
"RTN","TIUSRVP",139,0)
 I +Y'>0 Q Y_U_" Insufficient data to create a new record."
"RTN","TIUSRVP",140,0)
 S DA=+Y,TIUNEW=+$P(Y,U,3)
"RTN","TIUSRVP",141,0)
 N DIE,DR,TIUVISIT S DIE=8925
"RTN","TIUSRVP",142,0)
 S TIUVISIT=$S(+$G(TIU("VISIT")):+$G(TIU("VISIT")),1:"")
"RTN","TIUSRVP",143,0)
 S TIUSCAT=$S(+$L($P($G(TIU("CAT")),U)):$P($G(TIU("CAT")),U),+$L($P($G(TIU("VSTR")),";",3)):$P($G(TIU("VSTR")),";",3),1:"")
"RTN","TIUSRVP",144,0)
 S DR=".04////"_$$DOCCLASS^TIULC1(+$P(Y,U,2))_";.13////"_TIUSCAT_";1205////"_$P($G(TIU("LOC")),U)_";1211////"_$P($G(TIU("VLOC")),U)_";1212////"_$P($G(TIU("INST")),U)
"RTN","TIUSRVP",145,0)
 D ^DIE
"RTN","TIUSRVP",146,0)
 Q +$G(DA)
"RTN","TIUSRVP",147,0)
FILE(SUCCESS,TIUDA,TIUX,SUPPRESS,TIUCPF) ; Call FM Filer & commit
"RTN","TIUSRVP",148,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIUCMMTX
"RTN","TIUSRVP",149,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS=""
"RTN","TIUSRVP",150,0)
 I +$G(TIUX(1202)) S TIUX(1204)=+$G(TIUX(1202))
"RTN","TIUSRVP",151,0)
 I +$G(TIUX(1209)) S TIUX(1208)=+$G(TIUX(1209))
"RTN","TIUSRVP",152,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP",153,0)
 ;Entered By field to the Author/Dictator field
"RTN","TIUSRVP",154,0)
 I $G(TIUCPF),+$G(TIUX(1202)) S TIUX(1302)=+$G(TIUX(1202))
"RTN","TIUSRVP",155,0)
 ;*271 Prevent string date in 1301
"RTN","TIUSRVP",156,0)
 S:$G(TIUX(1301)) TIUX(1301)=+TIUX(1301)
"RTN","TIUSRVP",157,0)
 M @FDARR=TIUX
"RTN","TIUSRVP",158,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUSRVP",159,0)
 I $D(TIUMSG)>9 S SUCCESS=0_U_$G(TIUMSG("DIERR",1,"TEXT",1)) Q
"RTN","TIUSRVP",160,0)
 S SUCCESS=TIUDA
"RTN","TIUSRVP",161,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",162,0)
 . N DA
"RTN","TIUSRVP",163,0)
 . S DA=TIUDA
"RTN","TIUSRVP",164,0)
 . S TIUCMMTX=$$COMMIT^TIULC1(+$G(^TIU(8925,+TIUDA,0)))
"RTN","TIUSRVP",165,0)
 . I TIUCMMTX]"" X TIUCMMTX
"RTN","TIUSRVP",166,0)
 . K ^TIU(8925,"ASAVE",DUZ,TIUDA)
"RTN","TIUSRVP",167,0)
 Q
"RTN","TIUSRVP",168,0)
SIGN(ERR,TIUDA,TIUX) ; API for /es/
"RTN","TIUSRVP",169,0)
 ; For backward compatibility
"RTN","TIUSRVP",170,0)
 ; Use SIGN^TIUSRVP2 now, please
"RTN","TIUSRVP",171,0)
 D SIGN^TIUSRVP2(.ERR,TIUDA,.TIUX)
"RTN","TIUSRVP",172,0)
 Q
"RTN","TIUSRVP",173,0)
DELETE(ERR,TIUDA,TIURSN,OVRRIDE) ; delete document
"RTN","TIUSRVP",174,0)
 N TIUDEL,TIUD0 S ERR=0
"RTN","TIUSRVP",175,0)
 I '+$G(OVRRIDE) D  Q:+$G(TIUDEL)'>0
"RTN","TIUSRVP",176,0)
 . S TIUDEL=$$CANDO^TIULP(TIUDA,"DELETE RECORD")
"RTN","TIUSRVP",177,0)
 . I TIUDEL'>0 S ERR="89250003^"_$$EZBLD^DIALOG(89250003)
"RTN","TIUSRVP",178,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVP",179,0)
 I +$P(TIUD0,U,5)'<6 D  Q
"RTN","TIUSRVP",180,0)
 . S TIURSN=$G(TIURSN,"A")
"RTN","TIUSRVP",181,0)
 . D DELTEXT^TIURB2(TIUDA,TIURSN)
"RTN","TIUSRVP",182,0)
 D DIK^TIURB2(TIUDA)
"RTN","TIUSRVP",183,0)
 D DELAUDIT^TIUEDI1(TIUDA)
"RTN","TIUSRVP",184,0)
 Q
"RTN","TIUSRVP",185,0)
LOCK(ERR,TIUDA) ; Bid for lock on a TIU Document record
"RTN","TIUSRVP",186,0)
 L +^TIU(8925,+TIUDA):1 I  S ERR=0
"RTN","TIUSRVP",187,0)
 E  S ERR="1^ Another session has this record locked."
"RTN","TIUSRVP",188,0)
 Q
"RTN","TIUSRVP",189,0)
UNLOCK(ERR,TIUDA) ; Decrement Lock on a TIU Document record
"RTN","TIUSRVP",190,0)
 L -^TIU(8925,+TIUDA) S ERR=0
"RTN","TIUSRVP",191,0)
 Q
"VER")
8.0^22.0
"BLD",9206,6)
^255
**END**
**END**

Released MD*1*11 SEQ #13
Extracted from mail message
**KIDS**:MD*1.0*11^

**INSTALL NAME**
MD*1.0*11
"BLD",5713,0)
MD*1.0*11^CLINICAL PROCEDURES^0^3081104^y
"BLD",5713,1,0)
^^2^2^3081015^
"BLD",5713,1,1,0)
Please refer to the National Patch Module for the detail of this
"BLD",5713,1,2,0)
patch build.
"BLD",5713,4,0)
^9.64PA^702.01^1
"BLD",5713,4,702.01,0)
702.01
"BLD",5713,4,702.01,2,0)
^9.641^702.01^1
"BLD",5713,4,702.01,2,702.01,0)
CP DEFINITION  (File-top level)
"BLD",5713,4,702.01,2,702.01,1,0)
^9.6411^.12^1
"BLD",5713,4,702.01,2,702.01,1,.12,0)
PROCESSED RESULT
"BLD",5713,4,702.01,222)
y^y^p^^^^n^^n
"BLD",5713,4,702.01,224)

"BLD",5713,4,"APDD",702.01,702.01)

"BLD",5713,4,"APDD",702.01,702.01,.12)

"BLD",5713,4,"B",702.01,702.01)

"BLD",5713,6.3)
67
"BLD",5713,"ABPKG")
n
"BLD",5713,"KRN",0)
^9.67PA^8989.52^19
"BLD",5713,"KRN",.4,0)
.4
"BLD",5713,"KRN",.4,"NM",0)
^9.68A^^
"BLD",5713,"KRN",.401,0)
.401
"BLD",5713,"KRN",.402,0)
.402
"BLD",5713,"KRN",.403,0)
.403
"BLD",5713,"KRN",.5,0)
.5
"BLD",5713,"KRN",.84,0)
.84
"BLD",5713,"KRN",3.6,0)
3.6
"BLD",5713,"KRN",3.8,0)
3.8
"BLD",5713,"KRN",9.2,0)
9.2
"BLD",5713,"KRN",9.8,0)
9.8
"BLD",5713,"KRN",9.8,"NM",0)
^9.68A^15^12
"BLD",5713,"KRN",9.8,"NM",1,0)
MDHL7BH^^0^B17132013
"BLD",5713,"KRN",9.8,"NM",2,0)
MDHL7A^^0^B47975378
"BLD",5713,"KRN",9.8,"NM",3,0)
MDNCHK^^0^B2266513
"BLD",5713,"KRN",9.8,"NM",4,0)
MDHL7U1^^0^B15827833
"BLD",5713,"KRN",9.8,"NM",8,0)
MDWSETUP^^0^B65119245
"BLD",5713,"KRN",9.8,"NM",9,0)
MDRPCOT^^0^B79210353
"BLD",5713,"KRN",9.8,"NM",10,0)
MDRPCOT1^^0^B34134564
"BLD",5713,"KRN",9.8,"NM",11,0)
MDPURGE^^0^B4890082
"BLD",5713,"KRN",9.8,"NM",12,0)
MDWCAN^^0^B16228241
"BLD",5713,"KRN",9.8,"NM",13,0)
MDRPCOP^^0^B75016189
"BLD",5713,"KRN",9.8,"NM",14,0)
MDWOR^^0^B40687442
"BLD",5713,"KRN",9.8,"NM",15,0)
MDWORSR^^0^B57396407
"BLD",5713,"KRN",9.8,"NM","B","MDHL7A",2)

"BLD",5713,"KRN",9.8,"NM","B","MDHL7BH",1)

"BLD",5713,"KRN",9.8,"NM","B","MDHL7U1",4)

"BLD",5713,"KRN",9.8,"NM","B","MDNCHK",3)

"BLD",5713,"KRN",9.8,"NM","B","MDPURGE",11)

"BLD",5713,"KRN",9.8,"NM","B","MDRPCOP",13)

"BLD",5713,"KRN",9.8,"NM","B","MDRPCOT",9)

"BLD",5713,"KRN",9.8,"NM","B","MDRPCOT1",10)

"BLD",5713,"KRN",9.8,"NM","B","MDWCAN",12)

"BLD",5713,"KRN",9.8,"NM","B","MDWOR",14)

"BLD",5713,"KRN",9.8,"NM","B","MDWORSR",15)

"BLD",5713,"KRN",9.8,"NM","B","MDWSETUP",8)

"BLD",5713,"KRN",19,0)
19
"BLD",5713,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",5713,"KRN",19,"NM",1,0)
MD PROCESS NOSHOW/CANCEL^^0
"BLD",5713,"KRN",19,"NM","B","MD PROCESS NOSHOW/CANCEL",1)

"BLD",5713,"KRN",19.1,0)
19.1
"BLD",5713,"KRN",101,0)
101
"BLD",5713,"KRN",409.61,0)
409.61
"BLD",5713,"KRN",771,0)
771
"BLD",5713,"KRN",870,0)
870
"BLD",5713,"KRN",8989.51,0)
8989.51
"BLD",5713,"KRN",8989.51,"NM",0)
^9.68A^3^3
"BLD",5713,"KRN",8989.51,"NM",1,0)
MD USE APPOINTMENT^^0
"BLD",5713,"KRN",8989.51,"NM",2,0)
MD OLYMPUS 7^^0
"BLD",5713,"KRN",8989.51,"NM",3,0)
MD CLINIC ASSOCIATION^^0
"BLD",5713,"KRN",8989.51,"NM","B","MD CLINIC ASSOCIATION",3)

"BLD",5713,"KRN",8989.51,"NM","B","MD OLYMPUS 7",2)

"BLD",5713,"KRN",8989.51,"NM","B","MD USE APPOINTMENT",1)

"BLD",5713,"KRN",8989.52,0)
8989.52
"BLD",5713,"KRN",8994,0)
8994
"BLD",5713,"KRN","B",.4,.4)

"BLD",5713,"KRN","B",.401,.401)

"BLD",5713,"KRN","B",.402,.402)

"BLD",5713,"KRN","B",.403,.403)

"BLD",5713,"KRN","B",.5,.5)

"BLD",5713,"KRN","B",.84,.84)

"BLD",5713,"KRN","B",3.6,3.6)

"BLD",5713,"KRN","B",3.8,3.8)

"BLD",5713,"KRN","B",9.2,9.2)

"BLD",5713,"KRN","B",9.8,9.8)

"BLD",5713,"KRN","B",19,19)

"BLD",5713,"KRN","B",19.1,19.1)

"BLD",5713,"KRN","B",101,101)

"BLD",5713,"KRN","B",409.61,409.61)

"BLD",5713,"KRN","B",771,771)

"BLD",5713,"KRN","B",870,870)

"BLD",5713,"KRN","B",8989.51,8989.51)

"BLD",5713,"KRN","B",8989.52,8989.52)

"BLD",5713,"KRN","B",8994,8994)

"BLD",5713,"QUES",0)
^9.62^^
"BLD",5713,"REQB",0)
^9.611^2^2
"BLD",5713,"REQB",1,0)
MD*1.0*6^2
"BLD",5713,"REQB",2,0)
MD*1.0*14^2
"BLD",5713,"REQB","B","MD*1.0*14",2)

"BLD",5713,"REQB","B","MD*1.0*6",1)

"FIA",702.01)
CP DEFINITION
"FIA",702.01,0)
^MDS(702.01,
"FIA",702.01,0,0)
702.01I
"FIA",702.01,0,1)
y^y^p^^^^n^^n
"FIA",702.01,0,10)

"FIA",702.01,0,11)

"FIA",702.01,0,"RLRO")

"FIA",702.01,0,"VR")
1.0^MD
"FIA",702.01,702.01)
1
"FIA",702.01,702.01,.12)

"KRN",19,12868,-1)
0^1
"KRN",19,12868,0)
MD PROCESS NOSHOW/CANCEL^Process No Show/Cancel Studies^^R^^^^^^^^CLINICAL PROCEDURES
"KRN",19,12868,1,0)
^19.06^3^3^3080724^^^
"KRN",19,12868,1,1,0)
This option is tasked to run daily.  It will check for any appointment
"KRN",19,12868,1,2,0)
that is No Show or Cancelled for CP studies in the "Pending Instrument
"KRN",19,12868,1,3,0)
Data" status.
"KRN",19,12868,25)
EN1^MDWCAN
"KRN",19,12868,"U")
PROCESS NO SHOW/CANCEL STUDIES
"KRN",8989.51,456,-1)
0^1
"KRN",8989.51,456,0)
MD USE APPOINTMENT^Use Appointment Location^0^^Use Appointment location
"KRN",8989.51,456,1)
Y
"KRN",8989.51,456,20,0)
^8989.512^4^4^3070109^^^^
"KRN",8989.51,456,20,1,0)
Set this value to Yes to allow CPUser to use the location of the
"KRN",8989.51,456,20,2,0)
appointment selected during CP study check-in for the workload.
"KRN",8989.51,456,20,3,0)
Otherwise, the hospital location of the CP Definition will be used.
"KRN",8989.51,456,20,4,0)
If no value is entered, the default value is No.
"KRN",8989.51,456,30,0)
^8989.513I^1^1
"KRN",8989.51,456,30,1,0)
1^4.2
"KRN",8989.51,482,-1)
0^3
"KRN",8989.51,482,0)
MD CLINIC ASSOCIATION^MD Clinic Association^1^Sequence^Clinic;Procedure Association Value^0
"KRN",8989.51,482,1)
F
"KRN",8989.51,482,6)
N^1:9999^Enter the sequence to associate a clinic and procedure.
"KRN",8989.51,482,20,0)
^8989.512^4^4^3080318^^
"KRN",8989.51,482,20,1,0)
This parameter is used to identify the clinic and procedure
"KRN",8989.51,482,20,2,0)
association.  Each item should be entered with the following format
"KRN",8989.51,482,20,3,0)
 
"KRN",8989.51,482,20,4,0)
  Clinic internal entry number_";"_Procedure internal entry number
"KRN",8989.51,482,30,0)
^8989.513I^1^1
"KRN",8989.51,482,30,1,0)
1^4.2
"KRN",8989.51,483,-1)
0^2
"KRN",8989.51,483,0)
MD OLYMPUS 7^MD OLYMPUS 7^0^^Yes/No^0
"KRN",8989.51,483,1)
Y^^Enter Yes/No whether you have Olympus version 7.3.7.
"KRN",8989.51,483,20,0)
^8989.512^3^3^3080603^^
"KRN",8989.51,483,20,1,0)
This parameter definition indicates whether the Olympus device
"KRN",8989.51,483,20,2,0)
is version 7.3.7.  The value is Yes/No.  The default value
"KRN",8989.51,483,20,3,0)
is "No".
"KRN",8989.51,483,30,0)
^8989.513I^1^1
"KRN",8989.51,483,30,1,0)
1^4.2
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",365,-1)
1^1
"PKG",365,0)
CLINICAL PROCEDURES^MD^Clinical Procedures
"PKG",365,20,0)
^9.402P^^
"PKG",365,22,0)
^9.49I^1^1
"PKG",365,22,1,0)
1.0^3080917^2980529^363
"PKG",365,22,1,"PAH",1,0)
11^3081104^4558
"PKG",365,22,1,"PAH",1,1,0)
^^2^2^3081104
"PKG",365,22,1,"PAH",1,1,1,0)
Please refer to the National Patch Module for the detail of this
"PKG",365,22,1,"PAH",1,1,2,0)
patch build.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","MDHL7A")
0^2^B47975378^B47556007
"RTN","MDHL7A",1,0)
MDHL7A ; HOIFO/WAA - Routine to Decode HL7 for CP ;09/12/08  13:39
"RTN","MDHL7A",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,11**;Apr 01, 2004;Build 67
"RTN","MDHL7A",3,0)
 ; Reference DBIA #10035 [Supported] for DPT calls.
"RTN","MDHL7A",4,0)
 ; Reference DBIA #10106 [Supported] for HLFNC calls.
"RTN","MDHL7A",5,0)
 ; Reference DBIA #10062 [Supported] for VADPT6 calls.
"RTN","MDHL7A",6,0)
 ; Reference DBIA #2701 [Supported] for MPIF001 calls
"RTN","MDHL7A",7,0)
 ; Reference DBIA #10096 [Supported] for ^%ZOSF calls
"RTN","MDHL7A",8,0)
EN ; [Procedure] Entry Point for Message Array in MSG
"RTN","MDHL7A",9,0)
 N %,BID,CODE,CPT,DA,DATE,DFN,DIK,DLCO,DTO,DZ,ERRTX,EXAM,EXE,MDFLAG,FIL
"RTN","MDHL7A",10,0)
 N I,ICNT,ID,IMP,J,K,LBL,LINO,LINE,LN,MDAPP,MDRTN,MG,MSG,N,NAM,NEXT,NUM
"RTN","MDHL7A",11,0)
 N ORIFN,P,PID,PIEN,S,SEG,SET,SEP,MDSSN,STR,STYP,SUB,TCNT,TXT,UNIQ,SEC
"RTN","MDHL7A",12,0)
 N UNITS,VA,VAL,X,XMBODY,XMDUZ,XMSUBJ,XMTO,Z,ZZ,Z1,Z2,MDERROR
"RTN","MDHL7A",13,0)
 N ECODE,MDIEN,MDOBX,NUMZ,PNAM,ZCODE,MDDEV,MDD702,DEVNAME,DEVIEN,MDQFLG
"RTN","MDHL7A",14,0)
 N MDIORD
"RTN","MDHL7A",15,0)
 K ^TMP($J,"MDHL7A"),^TMP($J,"MDHL7"),^TMP($J,"MDHL7A1")
"RTN","MDHL7A",16,0)
 S MDFLAG=0,MDERROR=0,MDQFLG=0
"RTN","MDHL7A",17,0)
 Q:$G(HLMTIENS)=""
"RTN","MDHL7A",18,0)
 S ^TMP($J,"MDHL7A1")=""
"RTN","MDHL7A",19,0)
 S HLREST="^TMP($J,""MDHL7A1"")"
"RTN","MDHL7A",20,0)
 S X=$$MSGIEN^MDHL7U3(HLMTIENS,HLREST) ; This code is to convert the HL7 Message **6**
"RTN","MDHL7A",21,0)
 I $P(X,U)=0 D  Q
"RTN","MDHL7A",22,0)
 . S DEVIEN=0,ECODE=0
"RTN","MDHL7A",23,0)
 . S ERRTX=$P(X,U,2)
"RTN","MDHL7A",24,0)
 . D ^MDHL7X
"RTN","MDHL7A",25,0)
 . Q
"RTN","MDHL7A",26,0)
 I $P(X,U)=1 D XVERT^MDHL7U3("MDHL7A1","MDHL7A")
"RTN","MDHL7A",27,0)
 K HLNODE,^TMP($J,"MDHL7A1")
"RTN","MDHL7A",28,0)
 ;
"RTN","MDHL7A",29,0)
EN2 ; [Procedure] No Description
"RTN","MDHL7A",30,0)
 S (DEVIEN,DEVNAME)="",I=0
"RTN","MDHL7A",31,0)
 F I=1:1 S X=$G(^TMP($J,"MDHL7A",I)) Q:X=""  Q:$E(X,1,3)="OBX"  D
"RTN","MDHL7A",32,0)
 . S:$E(X,1,3)="MSH" DEVNAME=$P(X,"|",4)
"RTN","MDHL7A",33,0)
 . I DEVNAME="",HLREC("SFN")'="" S DEVNAME=HLREC("SFN")
"RTN","MDHL7A",34,0)
 . I $E(X,1,3)="MSH",DEVNAME'="Instrument Manager" S DEVIEN=$O(^MDS(702.09,"B",DEVNAME,0))
"RTN","MDHL7A",35,0)
 . I $E(X,1,3)="OBR" D
"RTN","MDHL7A",36,0)
 .. I DEVNAME="Instrument Manager" D
"RTN","MDHL7A",37,0)
 ... S DEVNAME=$P(X,"|",25)
"RTN","MDHL7A",38,0)
 ... Q
"RTN","MDHL7A",39,0)
 .. S MDIORD=$P(X,"|",4)
"RTN","MDHL7A",40,0)
 .. S MDD702=$S(+MDIORD<1:"",1:$$GETSTDY^MDRPCOT1(MDIORD))
"RTN","MDHL7A",41,0)
 .. I MDD702<1 S MDD702="" Q
"RTN","MDHL7A",42,0)
 .. I MDD702>0 D  ;Validate the entry from 702 is good.
"RTN","MDHL7A",43,0)
 ... I $G(^MDD(702,MDD702,0))="" S MDD702="" Q
"RTN","MDHL7A",44,0)
 ... S DEVIEN=$$GET1^DIQ(702,MDD702,.11,"I")
"RTN","MDHL7A",45,0)
 ... I DEVIEN<1 S DEVIEN="" ; No device defined
"RTN","MDHL7A",46,0)
 ... Q
"RTN","MDHL7A",47,0)
 .. Q
"RTN","MDHL7A",48,0)
 . Q
"RTN","MDHL7A",49,0)
 I DEVIEN="",DEVNAME'="" S DEVIEN=$O(^MDS(702.09,"B",DEVNAME,0))
"RTN","MDHL7A",50,0)
 I DEVNAME="" S ERRTX="Invalid device Code" D ^MDHL7X Q
"RTN","MDHL7A",51,0)
 I DEVIEN="" S ERRTX="Invalid device entry" D ^MDHL7X Q
"RTN","MDHL7A",52,0)
 S ZCODE=$P($G(^MDS(702.09,DEVIEN,.1)),"^",2)
"RTN","MDHL7A",53,0)
 S ECODE=0,INST=DEVIEN,MDAPP=DEVNAME
"RTN","MDHL7A",54,0)
 I 'INST S ERRTX="Invalid Application Code" D ^MDHL7X Q
"RTN","MDHL7A",55,0)
 D INST^MDHL7U2(DEVIEN,.ECODE) I 'ECODE D  Q
"RTN","MDHL7A",56,0)
 . S ERRTX="Device Error" D ^MDHL7X
"RTN","MDHL7A",57,0)
 . Q
"RTN","MDHL7A",58,0)
 I (ZCODE="M")!(ZCODE="B") D  Q:MDERROR  Q:ZCODE="M"  ;
"RTN","MDHL7A",59,0)
 . S MDFLAG=1,MDERROR=0 ; Tell Medicine that CP is talking to HL7
"RTN","MDHL7A",60,0)
 . D ^MDHL7MCA ; Run the Medicine routines
"RTN","MDHL7A",61,0)
 . Q:MDERROR  ; Medicine found an error and sent an error back
"RTN","MDHL7A",62,0)
 . Q
"RTN","MDHL7A",63,0)
 S NUMZ=$O(^TMP($J,"MDHL7A",""),-1)
"RTN","MDHL7A",64,0)
 S NUM=0,MDOBX=0
"RTN","MDHL7A",65,0)
 F NUM=1:1:NUMZ  D  Q:$G(ERRTX)'=""
"RTN","MDHL7A",66,0)
 . S LINO=^TMP($J,"MDHL7A",NUM)
"RTN","MDHL7A",67,0)
 . S SEC=$P(LINO,"|")
"RTN","MDHL7A",68,0)
 . I SEC="MSH" D MSH Q
"RTN","MDHL7A",69,0)
 . I SEC="PID" D PID Q
"RTN","MDHL7A",70,0)
 . I SEC="OBR" D OBR Q
"RTN","MDHL7A",71,0)
 . I SEC="PV1" Q
"RTN","MDHL7A",72,0)
 . I SEC="ORC" Q
"RTN","MDHL7A",73,0)
 . I SEC="OBX" S MDOBX=1 Q
"RTN","MDHL7A",74,0)
 . Q
"RTN","MDHL7A",75,0)
 Q:$G(ERRTX)'=""
"RTN","MDHL7A",76,0)
 I 'MDOBX S ERRTX="OBX not found when expected" D ^MDHL7X Q
"RTN","MDHL7A",77,0)
 D OBX
"RTN","MDHL7A",78,0)
 D STATUS(MDIEN,"P")
"RTN","MDHL7A",79,0)
 K ^TMP($J,"MDHL7A"),^TMP($J,"MDHL7")
"RTN","MDHL7A",80,0)
 Q
"RTN","MDHL7A",81,0)
STATUS(DA,STAT) ; Update the status of the report in 703.1
"RTN","MDHL7A",82,0)
 Q:$G(ERRTX)'=""
"RTN","MDHL7A",83,0)
 S $P(^MDD(703.1,DA,0),U,9)=STAT
"RTN","MDHL7A",84,0)
 S DIK="^MDD(703.1," D IX1^DIK
"RTN","MDHL7A",85,0)
 Q
"RTN","MDHL7A",86,0)
IM ;Instrument Manager Interface
"RTN","MDHL7A",87,0)
 Q:DEVNAME'="Instrument Manager"
"RTN","MDHL7A",88,0)
 I $E(X,1,3)'="OBR" Q
"RTN","MDHL7A",89,0)
 S DEVNAME=$P(X,"|",25)
"RTN","MDHL7A",90,0)
 S DEVIEN=$O(^MDS(702.09,"B",DEVNAME,0))
"RTN","MDHL7A",91,0)
 Q
"RTN","MDHL7A",92,0)
 ;
"RTN","MDHL7A",93,0)
MSH ; [Procedure] Decode MSH
"RTN","MDHL7A",94,0)
 N SEG
"RTN","MDHL7A",95,0)
 I '$D(^TMP($J,"MDHL7A",NUM)) Q
"RTN","MDHL7A",96,0)
 S X=$G(^TMP($J,"MDHL7A",NUM)),SEG("MSH")=X
"RTN","MDHL7A",97,0)
 I $E(X,1,3)'="MSH" S ERRTX="MSH not first record" D ^MDHL7X Q
"RTN","MDHL7A",98,0)
 Q
"RTN","MDHL7A",99,0)
 ;
"RTN","MDHL7A",100,0)
OBR ; [Procedure] Check OBR
"RTN","MDHL7A",101,0)
 N MDGMRC
"RTN","MDHL7A",102,0)
 S X=$G(^TMP($J,"MDHL7A",NUM)) I $E(X,1,3)'="OBR" S ERRTX="OBR not found when expected" D ^MDHL7X Q
"RTN","MDHL7A",103,0)
 S SEG("OBR")=X
"RTN","MDHL7A",104,0)
 S MDIORD=$P(X,"|",4)
"RTN","MDHL7A",105,0)
 S MDD702=$S(+MDIORD<1:"",1:$$GETSTDY^MDRPCOT1(MDIORD))
"RTN","MDHL7A",106,0)
 I MDD702'="" S MDD702=$$CHK^MDNCHK(MDD702) ; PATCH 11
"RTN","MDHL7A",107,0)
 S ORIFN=$P(X,"|",3),(EXAM,%)=$P(X,"|",5) I EXAM'="" S EXAM=$P(%,"^",2) I EXAM="" S EXAM=$P(%,"^",1)
"RTN","MDHL7A",108,0)
 S CPT=$P(X,"|",5) I $P(CPT,"^",3)["CPT" S CPT=$P(CPT,"^",1)
"RTN","MDHL7A",109,0)
 S DTO="",DATE=$P(X,"|",8) I DATE'="" S:$L(DATE)>14 DATE=$E(DATE,1,14) S DTO=$$FMDATE^HLFNC(DATE)
"RTN","MDHL7A",110,0)
 ;  vvv== Added to address the issues of mismatch
"RTN","MDHL7A",111,0)
 I $G(MDD702)>0 I DFN'=$$GET1^DIQ(702,MDD702,.01,"I") S ERRTX="Patient name Mismatch. Name in PID doesn't match the name in the CP Order #"_MDD702_"." D ^MDHL7X Q
"RTN","MDHL7A",112,0)
 I $G(MDD702)>0 I MDDOB'=$$GET1^DIQ(2,DFN,.03,"I") S ERRTX="Patient DOB Mismatch. DOB in PID doesn't match the DOB in the CP Order #"_MDD702_"." D ^MDHL7X Q
"RTN","MDHL7A",113,0)
 I DTO="" S ERRTX="Missing required Date/Time of Procedure in OBR" D ^MDHL7X Q
"RTN","MDHL7A",114,0)
 ;;S UNIQ=$TR($H,",","-")
"RTN","MDHL7A",115,0)
 S UNIQ=$$NEWID(DFN,DATE,INST,$G(MDD702),HLMTIEN)
"RTN","MDHL7A",116,0)
 I +UNIQ="-1" S ERRTX="Unable to Create or Lock 703.1" D ^MDHL7X Q
"RTN","MDHL7A",117,0)
 S MDIEN=$P(UNIQ,"^",1) ; Got the IEN for 703.1
"RTN","MDHL7A",118,0)
 N SET S SET=DTO_"^"_$P(UNIQ,U,2),ICNT=0 N IMP
"RTN","MDHL7A",119,0)
 S MDRTN=$P($G(^MDS(702.09,INST,.1)),"^",1) S:MDRTN'["^" MDRTN="^"_MDRTN
"RTN","MDHL7A",120,0)
 S X=MDRTN S:X["^" X=$P(X,"^",2) X ^%ZOSF("TEST") I '$T S ERRTX="Processing routine not found" D ^MDHL7X Q  ; IA %10096
"RTN","MDHL7A",121,0)
 D CPTICD^MDHL7U3(X,MDIEN) ; Update CPT and ICD9
"RTN","MDHL7A",122,0)
 D PHY^MDHL7U3(X,MDIEN) ; Get Doc who did the procedure.
"RTN","MDHL7A",123,0)
 Q
"RTN","MDHL7A",124,0)
 ;
"RTN","MDHL7A",125,0)
PID ; [Procedure] Check PID
"RTN","MDHL7A",126,0)
 S X=$G(^TMP($J,"MDHL7A",NUM)) I $E(X,1,3)'="PID" S ERRTX="PID not second record" D ^MDHL7X Q
"RTN","MDHL7A",127,0)
 S SEG("PID")=X
"RTN","MDHL7A",128,0)
 S MDDOB=$P(X,"|",8) I MDDOB'="" S MDDOB=($E(MDDOB,1,4)-1700)_$E(MDDOB,5,8)
"RTN","MDHL7A",129,0)
 I $L($P(X,"|",4))'<16 D  I +DFN=-1 Q
"RTN","MDHL7A",130,0)
 . N ICN
"RTN","MDHL7A",131,0)
 . S ICN=$P(X,"|",4)
"RTN","MDHL7A",132,0)
 . S DFN=$$GETDFN^MPIF001(ICN)
"RTN","MDHL7A",133,0)
 . I +DFN=-1 S ERRTX=$P(DFN,U,2)
"RTN","MDHL7A",134,0)
 . D MDSSN I DFN<1 S ERRTX="SSN not found" D ^MDHL7X Q
"RTN","MDHL7A",135,0)
 . I DFN>0 K ERRTX
"RTN","MDHL7A",136,0)
 . S MDSSN=$$GET1^DIQ(2,DFN,.09,"I") I MDSSN="" S MDSSN=" ",DFN=0
"RTN","MDHL7A",137,0)
 . Q
"RTN","MDHL7A",138,0)
 E  D MDSSN
"RTN","MDHL7A",139,0)
 I 'DFN S ERRTX="SSN not found" D ^MDHL7X Q
"RTN","MDHL7A",140,0)
 S Z1=$P($G(^DPT(DFN,0)),",",1),Z2=$P(NAM,"^",1)
"RTN","MDHL7A",141,0)
 S Z1=$TR(Z1,"abcdefghijklmnopqrstuvwxyz- '","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MDHL7A",142,0)
 S Z2=$TR(Z2,"abcdefghijklmnopqrstuvwxyz- '","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MDHL7A",143,0)
 I $E(Z1,1,3)'=$E(Z2,1,3) S ERRTX="Last Name MisMatch" D ^MDHL7X Q
"RTN","MDHL7A",144,0)
 S PNAM=$TR(NAM,"^",",")
"RTN","MDHL7A",145,0)
 D PID^VADPT6 S PID=$G(VA("PID")),BID=$G(VA("BID")) N VA
"RTN","MDHL7A",146,0)
 Q
"RTN","MDHL7A",147,0)
MDSSN ; This subroutine is to match up the SSN for a patient.
"RTN","MDHL7A",148,0)
 S NAM=$P(X,"|",6),MDSSN=$P(X,"|",20) I $L(MDSSN)<9 S MDSSN=$P(X,"|",4)
"RTN","MDHL7A",149,0)
 S MDSSN=$P(MDSSN,"^",1) I MDSSN'?9N S MDSSN=$TR(MDSSN,"- ","")
"RTN","MDHL7A",150,0)
 I $E(MDSSN,$L(MDSSN))="P" S MDSSN=$E(MDSSN,1,9)
"RTN","MDHL7A",151,0)
 S:MDSSN'?9N MDSSN=" " S DFN=$O(^DPT("SSN",MDSSN,0))
"RTN","MDHL7A",152,0)
 I 'DFN S DFN=$O(^DPT("SSN",MDSSN_"P",0))
"RTN","MDHL7A",153,0)
 Q
"RTN","MDHL7A",154,0)
 ;
"RTN","MDHL7A",155,0)
OBX ; [Observation]
"RTN","MDHL7A",156,0)
 D @MDRTN
"RTN","MDHL7A",157,0)
 Q
"RTN","MDHL7A",158,0)
NEWID(DFN,DATE,INST,MDD702,HLMTIEN) ; Generate a new entry and ID of 703.1
"RTN","MDHL7A",159,0)
 N NEWID,MDFDA,MDIEN,MDNO
"RTN","MDHL7A",160,0)
 S NEWID=$TR($H,",","-")  ; Create inital ID
"RTN","MDHL7A",161,0)
 L +(^MDD(703.1,"B")):60 E  Q "-1"
"RTN","MDHL7A",162,0)
 ;^^--- Unable to get a lock in the file
"RTN","MDHL7A",163,0)
 F  Q:'$D(^MDD(703.1,"B",NEWID))  H 1 S NEWID=$TR($H,",","-")
"RTN","MDHL7A",164,0)
 ;^^--- Search to create a new ID if current ID is in use
"RTN","MDHL7A",165,0)
 S MDFDA(703.1,"+1,",.01)=NEWID
"RTN","MDHL7A",166,0)
 S MDFDA(703.1,"+1,",.02)=DFN
"RTN","MDHL7A",167,0)
 S MDFDA(703.1,"+1,",.03)=$$HL7TFM^MDHL7U(DATE)
"RTN","MDHL7A",168,0)
 S MDFDA(703.1,"+1,",.04)=INST
"RTN","MDHL7A",169,0)
 S MDFDA(703.1,"+1,",.05)=MDD702
"RTN","MDHL7A",170,0)
 S MDFDA(703.1,"+1,",.06)=HLMTIEN
"RTN","MDHL7A",171,0)
 D UPDATE^DIE("","MDFDA","MDIEN")
"RTN","MDHL7A",172,0)
 L -(^MDD(703.1,"B"))
"RTN","MDHL7A",173,0)
 I $G(MDIEN(1))>0 D  Q MDIEN(1)_U_NEWID
"RTN","MDHL7A",174,0)
 . S ^MDD(703.1,MDIEN(1),.1,0)="^703.11S^0^0"
"RTN","MDHL7A",175,0)
 . S MDNO=$$NTIU^MDRPCW1(+MDD702)
"RTN","MDHL7A",176,0)
 . Q
"RTN","MDHL7A",177,0)
 ; ^^--- Create Subfile and quit
"RTN","MDHL7A",178,0)
 Q "-1"  ; Unable to create file
"RTN","MDHL7A",179,0)
 ;
"RTN","MDHL7A",180,0)
PROC ; [Procedure] Create report entry in file (703.1)
"RTN","MDHL7A",181,0)
 D PROC^MDHL7U
"RTN","MDHL7A",182,0)
 Q
"RTN","MDHL7BH")
0^1^B17132013^B11540394
"RTN","MDHL7BH",1,0)
MDHL7BH ; HOIFO/WAA -Bi-directional interface (HL7) routine ;7/23/01  11:41
"RTN","MDHL7BH",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11**;Apr 01, 2004;Build 67
"RTN","MDHL7BH",3,0)
 ;
"RTN","MDHL7BH",4,0)
 ; This routine will build the HL7 Message and store that message.
"RTN","MDHL7BH",5,0)
 ; After the message has been created then it will call the
"RTN","MDHL7BH",6,0)
 ; The actual HL7package to start the processing of the message
"RTN","MDHL7BH",7,0)
 ;
"RTN","MDHL7BH",8,0)
 ; Reference DBIA #2161 [Supported] for HL7 calls.
"RTN","MDHL7BH",9,0)
 ; Reference DBIA #2164 [Supported] for HL7 calls.
"RTN","MDHL7BH",10,0)
 ; Reference DBIA #2263 [Supported] call to XPAR
"RTN","MDHL7BH",11,0)
 ; Reference DBIA #3065 [Supported]  call to XLFNAME.
"RTN","MDHL7BH",12,0)
 ; Reference DBIA #3067 [Private] Read Consult Data with FM call.
"RTN","MDHL7BH",13,0)
 ; Reference DBIA #10035[Supported] Patient File Access
"RTN","MDHL7BH",14,0)
 ; Reference DBIA #10040[Supported] Access ^SC
"RTN","MDHL7BH",15,0)
 ; Reference DBIA #10061[Supported] call to VADPT
"RTN","MDHL7BH",16,0)
 Q
"RTN","MDHL7BH",17,0)
EN1 ;Main Entry point.
"RTN","MDHL7BH",18,0)
 N MDMSG,MD101,CNT,HLA,LINE,MDHL,DFN,MDLINK
"RTN","MDHL7BH",19,0)
 Q:RESULT<1  ; This tells the study is not a BDi
"RTN","MDHL7BH",20,0)
 S MDLINK=$$GET1^DIQ(702.09,DEVIEN,.18,"E")
"RTN","MDHL7BH",21,0)
 I MDLINK="" S RESULT=-1,MSG="No HL Logical Link has been defined." Q  ; No link has been defined 
"RTN","MDHL7BH",22,0)
 S MDERROR="0"
"RTN","MDHL7BH",23,0)
 D INIT^HLFNC2("MCAR ORM SERVER",.MDMSG)
"RTN","MDHL7BH",24,0)
 I +$G(MDMSG)>0 S RESULT=-1,MSG="Unable to produce a message." Q  ; something is wrong and no MSH was created
"RTN","MDHL7BH",25,0)
 S DFN=$$GET1^DIQ(702,MDD702,.01,"I")
"RTN","MDHL7BH",26,0)
 S DEVNAME=$$GET1^DIQ(702.09,DEVIEN,.16,"I")
"RTN","MDHL7BH",27,0)
 S CNT=0
"RTN","MDHL7BH",28,0)
 D PID S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",29,0)
 D PV1 S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",30,0)
 D ORC S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",31,0)
 D OBR I LINE'="" S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",32,0)
 S HLP("SUBSCRIBER")="^^VISTA^^"_DEVNAME_"^M"
"RTN","MDHL7BH",33,0)
 S HLL("LINKS",1)="MCAR ORM CLIENT"_"^"_MDLINK
"RTN","MDHL7BH",34,0)
 D GENERATE^HLMA("MCAR ORM SERVER","LM",1,.MDHL,,.HLP)
"RTN","MDHL7BH",35,0)
 I $P(MDHL,U,2) S MDERROR=MDHL
"RTN","MDHL7BH",36,0)
 Q
"RTN","MDHL7BH",37,0)
OBR ; Send the procedure to the correct device
"RTN","MDHL7BH",38,0)
 S LINE="OBR|"
"RTN","MDHL7BH",39,0)
 S DEVIEN=$$GET1^DIQ(702,MDD702,.11,"I")
"RTN","MDHL7BH",40,0)
 S USC=$$GET1^DIQ(702.09,DEVIEN,.17,"I")
"RTN","MDHL7BH",41,0)
 I USC="" S LINE="" Q
"RTN","MDHL7BH",42,0)
 E  S USC=$TR(USC,"=","^")
"RTN","MDHL7BH",43,0)
 S $P(LINE,"|",5)=USC_"|"
"RTN","MDHL7BH",44,0)
 Q
"RTN","MDHL7BH",45,0)
PID ;get the patient information and build the PID
"RTN","MDHL7BH",46,0)
 ;PID|||SSN||Last^First||DOB|SEX|||||||||||SSN
"RTN","MDHL7BH",47,0)
 N MDSSN,NAME,DOB,ADDR,TMP,MDADD,VAPA,VAERR,VAROOT
"RTN","MDHL7BH",48,0)
 S LINE="PID|",$P(LINE,"|",21)=""
"RTN","MDHL7BH",49,0)
 S MDSSN=$$GET1^DIQ(702,MDD702,.011) ; Get the ssn for the patient
"RTN","MDHL7BH",50,0)
 S NAME=$$GET1^DIQ(702,MDD702,.01,"E") ; get the patient name
"RTN","MDHL7BH",51,0)
 S NAME=$$HLNAME^XLFNAME($P(NAME,"^"),"",$E(HLECH,1))
"RTN","MDHL7BH",52,0)
 I $P(NAME,$E(HLECH,1),7)'="L" S $P(NAME,$E(HLECH,1),7)="L"
"RTN","MDHL7BH",53,0)
 S DOB=$$GET1^DIQ(2,DFN,.03,"I") S DOB=$$FTOHL7^MDHL7U2(DOB)
"RTN","MDHL7BH",54,0)
 S VAROOT="MDADD" D ADD^VADPT
"RTN","MDHL7BH",55,0)
 S ADDR=$G(MDADD(1))_"^" ; Address 1
"RTN","MDHL7BH",56,0)
 S TMP=$G(MDADD(2)) I TMP'="" S ADDR=ADDR_TMP ; Add 2
"RTN","MDHL7BH",57,0)
 S TMP=$G(MDADD(3)) I TMP'="" S ADDR=ADDR_" "_TMP ; Add 3
"RTN","MDHL7BH",58,0)
 S ADDR=ADDR_"^"_$G(MDADD(4)) ; City
"RTN","MDHL7BH",59,0)
 S ADDR=ADDR_"^"_$P($G(MDADD(5)),"^",2) ; State
"RTN","MDHL7BH",60,0)
 S ADDR=ADDR_"^"_$G(MDADD(6)) ; Zip
"RTN","MDHL7BH",61,0)
 K MDADD
"RTN","MDHL7BH",62,0)
 S $P(LINE,"|",2)="1"
"RTN","MDHL7BH",63,0)
 S $P(LINE,"|",4)=MDSSN
"RTN","MDHL7BH",64,0)
 S $P(LINE,"|",6)=NAME
"RTN","MDHL7BH",65,0)
 S $P(LINE,"|",8)=DOB
"RTN","MDHL7BH",66,0)
 S $P(LINE,"|",9)=$$GET1^DIQ(2,DFN,.02,"I")
"RTN","MDHL7BH",67,0)
 S $P(LINE,"|",12)=ADDR
"RTN","MDHL7BH",68,0)
 S $P(LINE,"|",20)=MDSSN
"RTN","MDHL7BH",69,0)
 Q
"RTN","MDHL7BH",70,0)
PV1 ;Get the ward location for PV1
"RTN","MDHL7BH",71,0)
 ;PV1||In or out|Ward location
"RTN","MDHL7BH",72,0)
 N CWARD,WARD,INOUT,CONSULT,REF,NREF,WARD1,WARD2,MDPR1,MDPNAM
"RTN","MDHL7BH",73,0)
 S WARD=$$GET1^DIQ(2,DFN,.1,"E"),(WARD1,WARD2)=""
"RTN","MDHL7BH",74,0)
 S INOUT=$S(WARD'="":"I",1:"O")
"RTN","MDHL7BH",75,0)
 S:WARD'="" WARD=WARD_U_WARD
"RTN","MDHL7BH",76,0)
 S CONSULT=$$GET123^MDHL7U2(MDD702)
"RTN","MDHL7BH",77,0)
 S CWARD=$P($G(^MDD(702,+MDD702,0)),U,7),CWARD=$P(CWARD,";",3)
"RTN","MDHL7BH",78,0)
 S:+CWARD WARD2=$$GET1^DIQ(44,+CWARD_",",.01,"E")
"RTN","MDHL7BH",79,0)
 S MDPR1=$$GET1^DIQ(702,+MDD702_",",.04,"I")
"RTN","MDHL7BH",80,0)
 S:+MDPR1 WARD1=$$GET1^DIQ(702.01,+MDPR1_",",.05,"E")
"RTN","MDHL7BH",81,0)
 S MDPNAM=$$GET1^DIQ(702.09,DEVIEN,.06,"I")
"RTN","MDHL7BH",82,0)
 I INOUT="O" D
"RTN","MDHL7BH",83,0)
 .;S WARD=WARD1 S:WARD="" WARD=WARD2
"RTN","MDHL7BH",84,0)
 .S WARD=WARD2 S:WARD="" WARD=WARD1
"RTN","MDHL7BH",85,0)
 .S:WARD="" WARD=$$GET1^DIQ(123,CONSULT_",",.04,"E")
"RTN","MDHL7BH",86,0)
 .I MDPNAM["Olympus" D
"RTN","MDHL7BH",87,0)
 ..S WARD1=$O(^SC("B",WARD,0)),CWARD=$P($G(^SC(+WARD1,0)),U,2)
"RTN","MDHL7BH",88,0)
 ..S WARD=$S(+$$GET^XPAR("SYS","MD OLYMPUS 7",1)>0:$E(WARD,1,7),1:$E(WARD,1,4))_"^"_CWARD
"RTN","MDHL7BH",89,0)
 I INOUT="I" S WARD=WARD_"^"_$S($G(^DPT(2,.101))'="":$G(^DPT(2,.101)),1:"")
"RTN","MDHL7BH",90,0)
 S LINE="PV1||"_INOUT_"|"_WARD
"RTN","MDHL7BH",91,0)
 Q:CONSULT<1
"RTN","MDHL7BH",92,0)
 S NREF=$$GETREF^MDHL7U2(CONSULT) Q:NREF="-1"
"RTN","MDHL7BH",93,0)
 S $P(LINE,"|",9)=NREF
"RTN","MDHL7BH",94,0)
 Q
"RTN","MDHL7BH",95,0)
ORC ;get ORC onformation
"RTN","MDHL7BH",96,0)
 ;ORC|NA|Order Number|||||||date/time ordered
"RTN","MDHL7BH",97,0)
 N DATE,SDATE
"RTN","MDHL7BH",98,0)
 S DATE=$$GET1^DIQ(702,MDD702,.02,"I")
"RTN","MDHL7BH",99,0)
 S DATE=$$FTOHL7^MDHL7U2(DATE)
"RTN","MDHL7BH",100,0)
 S SDATE=$$GET1^DIQ(702,MDD702,.07,"I")
"RTN","MDHL7BH",101,0)
 I SDATE[";" S SDATE=$P(SDATE,";",2)
"RTN","MDHL7BH",102,0)
 S SDATE=$$FTOHL7^MDHL7U2(SDATE)
"RTN","MDHL7BH",103,0)
 S LINE="ORC|"_$S(MDORFLG=1:"NW",MDORFLG=0:"CA",1:"")_"|"_MDIORD
"RTN","MDHL7BH",104,0)
 S $P(LINE,"|",6)=$S(MDORFLG=1:"NW",MDORFLG=0:"CA",1:"")
"RTN","MDHL7BH",105,0)
 S $P(LINE,"|",10)=DATE,$P(LINE,"|",16)=SDATE
"RTN","MDHL7BH",106,0)
 Q
"RTN","MDHL7U1")
0^4^B15827833^B15807235
"RTN","MDHL7U1",1,0)
MDHL7U1 ; HOIFO/WAA -Routine utilities for CP PROCESSING OBX ; 7/26/00
"RTN","MDHL7U1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11**;Apr 01, 2004;Build 67
"RTN","MDHL7U1",3,0)
 ;
"RTN","MDHL7U1",4,0)
PATHCHK(X,Y) ; Check the OBX to see if it is a path then set the path.
"RTN","MDHL7U1",5,0)
 ;
"RTN","MDHL7U1",6,0)
 S Y=0
"RTN","MDHL7U1",7,0)
 ; Add the OBX report type of RP Reference Pointer
"RTN","MDHL7U1",8,0)
 I $S($P(X,"|",3)="ST":0,$P(X,"|",3)="TX":0,$P(X,"|",3)="RP":0,1:1) Q
"RTN","MDHL7U1",9,0)
 I X["//" S X=$TR(X,"/","\")
"RTN","MDHL7U1",10,0)
 I X["\E\" D
"RTN","MDHL7U1",11,0)
 . N Y,Z
"RTN","MDHL7U1",12,0)
 . S Z=""
"RTN","MDHL7U1",13,0)
 . F I=1:1:$L(X) S Y=$E(X,I) D:Y="\"  S Z=Z_Y
"RTN","MDHL7U1",14,0)
 . . I $E(X,I+1)="E",$E(X,I+2)="\" S I=I+2
"RTN","MDHL7U1",15,0)
 . . Q
"RTN","MDHL7U1",16,0)
 . S X=Z
"RTN","MDHL7U1",17,0)
 . Q
"RTN","MDHL7U1",18,0)
 I X'["\\" Q
"RTN","MDHL7U1",19,0)
 S Y("FPATH")=$P(X,"|",6)
"RTN","MDHL7U1",20,0)
 I Y("FPATH")'["\\" S Y("FPATH")=$P(X,"|",4)
"RTN","MDHL7U1",21,0)
 S Y("FPATH")="\\"_$P(Y("FPATH"),"\\",2)
"RTN","MDHL7U1",22,0)
 S Y("FILE")=$P(Y("FPATH"),"\",($L(Y("FPATH"),"\")))
"RTN","MDHL7U1",23,0)
 I $P(Y("FILE"),".",2)="" Q
"RTN","MDHL7U1",24,0)
 S Y("PATH")=$P(Y("FPATH"),"\",1,($L(Y("FPATH"),"\")-1))
"RTN","MDHL7U1",25,0)
 S Y=1
"RTN","MDHL7U1",26,0)
 Q
"RTN","MDHL7U1",27,0)
REX(DA) ; Reindex the 703.1 entry
"RTN","MDHL7U1",28,0)
 Q:'$D(^MDD(703.1,DA,0))
"RTN","MDHL7U1",29,0)
 S DIK="^MDD(703.1," D IX1^DIK
"RTN","MDHL7U1",30,0)
 Q
"RTN","MDHL7U1",31,0)
UNC ;;PROCESS UNC;.301
"RTN","MDHL7U1",32,0)
 N CNT
"RTN","MDHL7U1",33,0)
 S CNT=0
"RTN","MDHL7U1",34,0)
 F  S CNT=$O(^TMP($J,"MDHL7A",CNT)) Q:CNT<1  D
"RTN","MDHL7U1",35,0)
 . N LINE,PATH,DA,DIK
"RTN","MDHL7U1",36,0)
 . S LINE=^TMP($J,"MDHL7A",CNT) Q:LINE=""
"RTN","MDHL7U1",37,0)
 . I $P(LINE,"|",1)'="OBX" Q
"RTN","MDHL7U1",38,0)
 . D PATHCHK(LINE,.PATH)
"RTN","MDHL7U1",39,0)
 . Q:'PATH
"RTN","MDHL7U1",40,0)
 . S MDDZ=$$UPDATE^MDHL7U(MDIEN) ; Create the entry in the multi.
"RTN","MDHL7U1",41,0)
 . Q:'MDDZ
"RTN","MDHL7U1",42,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,0)=$P(MDATT(PROC),";",6)
"RTN","MDHL7U1",43,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,.1)=PATH("FPATH")
"RTN","MDHL7U1",44,0)
 . Q
"RTN","MDHL7U1",45,0)
 Q
"RTN","MDHL7U1",46,0)
URL ;;PROCESS URL;.303
"RTN","MDHL7U1",47,0)
 N CNT
"RTN","MDHL7U1",48,0)
 S CNT=0
"RTN","MDHL7U1",49,0)
 F  S CNT=$O(^TMP($J,"MDHL7A",CNT)) Q:CNT<1  D
"RTN","MDHL7U1",50,0)
 . N LINE,PATH
"RTN","MDHL7U1",51,0)
 . S LINE=^TMP($J,"MDHL7A",CNT) Q:LINE=""
"RTN","MDHL7U1",52,0)
 . I $P(LINE,"|",1)'="OBX" Q
"RTN","MDHL7U1",53,0)
 . D PATHCHK(LINE,.PATH)
"RTN","MDHL7U1",54,0)
 . I PATH S MDDZ=$$UPDATE^MDHL7U(MDIEN) ; Create the entry in the multi.
"RTN","MDHL7U1",55,0)
 . Q:'MDDZ
"RTN","MDHL7U1",56,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,0)=$P(MDATT(PROC),";",6)
"RTN","MDHL7U1",57,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,.1)=PATH("FPATH")
"RTN","MDHL7U1",58,0)
 . Q
"RTN","MDHL7U1",59,0)
 Q
"RTN","MDHL7U1",60,0)
DDL ;;PROCESS DLL;.304
"RTN","MDHL7U1",61,0)
 N CNT
"RTN","MDHL7U1",62,0)
 S CNT=0
"RTN","MDHL7U1",63,0)
 F  S CNT=$O(^TMP($J,"MDHL7A",CNT)) Q:CNT<1  D
"RTN","MDHL7U1",64,0)
 . N LINE,PATH
"RTN","MDHL7U1",65,0)
 . S LINE=^TMP($J,"MDHL7A",CNT) Q:LINE=""
"RTN","MDHL7U1",66,0)
 . I $P(LINE,"|",1)'="OBX" Q
"RTN","MDHL7U1",67,0)
 . D PATHCHK(LINE,.PATH)
"RTN","MDHL7U1",68,0)
 . I PATH S MDDZ=$$UPDATE^MDHL7U(MDIEN) ; Create the entry in the multi.
"RTN","MDHL7U1",69,0)
 . Q:'MDDZ
"RTN","MDHL7U1",70,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,0)=$P(MDATT(PROC),";",6)
"RTN","MDHL7U1",71,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,.1)=PATH("FPATH")
"RTN","MDHL7U1",72,0)
 . Q
"RTN","MDHL7U1",73,0)
 Q
"RTN","MDHL7U1",74,0)
UUEN ;;PROCESS UUENCODE;.305
"RTN","MDHL7U1",75,0)
 N CNT,CNT2,MDDZ
"RTN","MDHL7U1",76,0)
 S (CNT,CNT2)=0
"RTN","MDHL7U1",77,0)
 S MDDZ=$$UPDATE^MDHL7U(MDIEN) ; Create the entry in the multi.
"RTN","MDHL7U1",78,0)
 Q:'MDDZ
"RTN","MDHL7U1",79,0)
 S ^MDD(703.1,MDIEN,.1,MDDZ,0)=$P(MDATT(PROC),";",6)
"RTN","MDHL7U1",80,0)
 S ^MDD(703.1,MDIEN,.1,MDDZ,.1)=$G(FTYPE,"")
"RTN","MDHL7U1",81,0)
 F  S CNT=$O(^TMP($J,"MDHL7","UUENCODE",CNT)) Q:CNT<1  D
"RTN","MDHL7U1",82,0)
 . N LINE
"RTN","MDHL7U1",83,0)
 . S LINE=^TMP($J,"MDHL7","UUENCODE",CNT)
"RTN","MDHL7U1",84,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,.2,CNT,0)=LINE
"RTN","MDHL7U1",85,0)
 . S CNT2=CNT
"RTN","MDHL7U1",86,0)
 . Q
"RTN","MDHL7U1",87,0)
 D NOW^%DTC
"RTN","MDHL7U1",88,0)
 S ^MDD(703.1,MDIEN,.1,MDDZ,.2,0)="^^"_CNT2_"^"_CNT2_"^"_$P(%,".")_"^"
"RTN","MDHL7U1",89,0)
 Q
"RTN","MDHL7U1",90,0)
XML ;;PROCESS XML;.306
"RTN","MDHL7U1",91,0)
 N CNT
"RTN","MDHL7U1",92,0)
 S CNT=0
"RTN","MDHL7U1",93,0)
 F  S CNT=$O(^TMP($J,"MDHL7A",CNT)) Q:CNT<1  D
"RTN","MDHL7U1",94,0)
 . N LINE,PATH
"RTN","MDHL7U1",95,0)
 . S LINE=^TMP($J,"MDHL7A",CNT) Q:LINE=""
"RTN","MDHL7U1",96,0)
 . I $P(LINE,"|",1)'="OBX" Q
"RTN","MDHL7U1",97,0)
 . D PATHCHK(LINE,.PATH)
"RTN","MDHL7U1",98,0)
 . I PATH S MDDZ=$$UPDATE^MDHL7U(MDIEN) ; Create the entry in the multi.
"RTN","MDHL7U1",99,0)
 . Q:'MDDZ
"RTN","MDHL7U1",100,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,0)=$P(MDATT(PROC),";",6)
"RTN","MDHL7U1",101,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,.1)=PATH("FPATH")
"RTN","MDHL7U1",102,0)
 . Q
"RTN","MDHL7U1",103,0)
 Q
"RTN","MDHL7U1",104,0)
XMS ;;PROCESS XMS;.307
"RTN","MDHL7U1",105,0)
 N CNT
"RTN","MDHL7U1",106,0)
 S CNT=0
"RTN","MDHL7U1",107,0)
 F  S CNT=$O(^TMP($J,"MDHL7A",CNT)) Q:CNT<1  D
"RTN","MDHL7U1",108,0)
 . N LINE,PATH
"RTN","MDHL7U1",109,0)
 . S LINE=^TMP($J,"MDHL7A",CNT) Q:LINE=""
"RTN","MDHL7U1",110,0)
 . I $P(LINE,"|",1)'="OBX" Q
"RTN","MDHL7U1",111,0)
 . D PATHCHK(LINE,.PATH)
"RTN","MDHL7U1",112,0)
 . I PATH S MDDZ=$$UPDATE^MDHL7U(MDIEN) ; Create the entry in the multi.
"RTN","MDHL7U1",113,0)
 . Q:'MDDZ
"RTN","MDHL7U1",114,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,0)=$P(MDATT(PROC),";",6)
"RTN","MDHL7U1",115,0)
 . S ^MDD(703.1,MDIEN,.1,MDDZ,.1)=PATH("FPATH")
"RTN","MDHL7U1",116,0)
 . Q
"RTN","MDHL7U1",117,0)
 Q
"RTN","MDNCHK")
0^3^B2266513^n/a
"RTN","MDNCHK",1,0)
MDNCHK ; HOIFO/NCA - CP Multiple Result Check ;4/26/05  15:17
"RTN","MDNCHK",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11**;Apr 01, 2004;Build 67
"RTN","MDNCHK",3,0)
 ; Reference
"RTN","MDNCHK",4,0)
 ; IA# 10103 [Supported] Call to XLFDT
"RTN","MDNCHK",5,0)
 ;
"RTN","MDNCHK",6,0)
CHK(MDIEN) ; RPC call to notify Consult of results
"RTN","MDNCHK",7,0)
 ; Input parameters
"RTN","MDNCHK",8,0)
 ;  1. MDIEN [Literal/Required] CP Study
"RTN","MDNCHK",9,0)
 ;
"RTN","MDNCHK",10,0)
 N MDDEF,MDERR,MDHLOC,MDIENS,MDION,MDFDA,MDSTAT,MDSTR,MDSUBL
"RTN","MDNCHK",11,0)
 I '$G(MDIEN) S MDIEN="" Q MDIEN
"RTN","MDNCHK",12,0)
 S MDDEF=+$$GET1^DIQ(702,MDIEN,.04,"I") I 'MDDEF Q MDIEN
"RTN","MDNCHK",13,0)
 S MDSTAT=+$$GET1^DIQ(702.01,MDDEF,.12,"I") I 'MDSTAT Q MDIEN
"RTN","MDNCHK",14,0)
 S MDION=+$$GET1^DIQ(702,MDIEN,.12,"I") I 'MDION Q MDIEN
"RTN","MDNCHK",15,0)
 I MDSTAT=2 Q MDIEN
"RTN","MDNCHK",16,0)
 S MDSTR=$G(^MDD(702,MDIEN,0)) I MDSTR="" Q MDIEN
"RTN","MDNCHK",17,0)
 I $P(MDSTR,"^",9)'=3 Q MDIEN
"RTN","MDNCHK",18,0)
 K ^MDD(702,"AION",+MDION,MDIEN)
"RTN","MDNCHK",19,0)
 S MDSUBL=$P(MDSTR,U,7)
"RTN","MDNCHK",20,0)
 S MDHLOC=+$$GET1^DIQ(702.01,MDDEF,.05,"I"),MDSUBL=$P(MDSUBL,";",1,2)_";"_MDHLOC
"RTN","MDNCHK",21,0)
 S MDFDA(702,"+1,",.01)=$P(MDSTR,U,1)
"RTN","MDNCHK",22,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDNCHK",23,0)
 S MDFDA(702,"+1,",.03)=$P(MDSTR,U,3)
"RTN","MDNCHK",24,0)
 S MDFDA(702,"+1,",.04)=$P(MDSTR,U,4)
"RTN","MDNCHK",25,0)
 S MDFDA(702,"+1,",.05)=$P(MDSTR,U,5)
"RTN","MDNCHK",26,0)
 S MDFDA(702,"+1,",.07)=$P(MDSTR,U,7)
"RTN","MDNCHK",27,0)
 S MDFDA(702,"+1,",.09)=5
"RTN","MDNCHK",28,0)
 S MDFDA(702,"+1,",.11)=$P(MDSTR,U,11)
"RTN","MDNCHK",29,0)
 S MDFDA(702,"+1,",.12)=$P(MDSTR,U,12)
"RTN","MDNCHK",30,0)
 D UPDATE^DIE("","MDFDA","MDIENS","MDERR")
"RTN","MDNCHK",31,0)
 S MDIEN=MDIENS(1)
"RTN","MDNCHK",32,0)
 Q MDIEN
"RTN","MDPURGE")
0^11^B4890082^n/a
"RTN","MDPURGE",1,0)
MDPURGE ;HOIFO/NCA - Study Clean-Up process ;6/18/08  10:15
"RTN","MDPURGE",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11**;Apr 01, 2004;Build 67
"RTN","MDPURGE",3,0)
 ; Reference IA #2263 [Supported] XPAR calls
"RTN","MDPURGE",4,0)
 ; Reference IA #3468 [Subscription] Call GMRCCP
"RTN","MDPURGE",5,0)
EN1 ; Clean up process entry point
"RTN","MDPURGE",6,0)
 N MDARRY,MDFN,MDK,MDLP,MDPRO,MDET,MDLST,MDX,MDY,X,Y,DTOUT,DUOUT
"RTN","MDPURGE",7,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDPURGE",8,0)
 F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDY=$P($G(MDLST(MDK)),"^",2) I +$P(MDY,";",2)>0 S MDPRO=+$P(MDY,";",2) D
"RTN","MDPURGE",9,0)
 .Q:+$$GET1^DIQ(702.01,+MDPRO_",",.06,"I")=2
"RTN","MDPURGE",10,0)
 .Q:+$$GET1^DIQ(702.01,+MDPRO_",",.12,"I")=1
"RTN","MDPURGE",11,0)
 .S MDARRY(+MDPRO)=+MDPRO
"RTN","MDPURGE",12,0)
 S MDLP=0 F  S MDLP=$O(^MDD(702,"AS",5,MDLP)) Q:MDLP<1  S MDX=$G(^MDD(702,MDLP,0)) D
"RTN","MDPURGE",13,0)
 .S MDET=$P(MDX,"^",4) Q:$G(MDARRY(MDET))=""
"RTN","MDPURGE",14,0)
 .S MDFN=+$P(MDX,"^")
"RTN","MDPURGE",15,0)
 .S MDCN=$P(MDX,"^",5) Q:'MDCN
"RTN","MDPURGE",16,0)
 .I +$$GETC(MDFN,MDET,+MDCN) D PURG(+MDLP)
"RTN","MDPURGE",17,0)
 .Q
"RTN","MDPURGE",18,0)
 S MDLP=0 F  S MDLP=$O(^MDD(702,"AS",0,MDLP)) Q:MDLP<1  S MDX=$G(^MDD(702,MDLP,0)) D
"RTN","MDPURGE",19,0)
 .S MDET=$P(MDX,"^",4) Q:$G(MDARRY(MDET))=""
"RTN","MDPURGE",20,0)
 .S MDFN=+$P(MDX,"^")
"RTN","MDPURGE",21,0)
 .S MDCN=$P(MDX,"^",5) Q:'MDCN
"RTN","MDPURGE",22,0)
 .I +$$GETC(MDFN,MDET,+MDCN) D PURG(+MDLP)
"RTN","MDPURGE",23,0)
 .Q
"RTN","MDPURGE",24,0)
 Q
"RTN","MDPURGE",25,0)
GETC(MDPAT,MDDA,MDCNS) ; Get consult date
"RTN","MDPURGE",26,0)
 N MDJ,MDCF S MDCF=0 K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,+MDDA,$NA(^TMP("MDTMP",$J)))
"RTN","MDPURGE",27,0)
 S MDJ=0 F  S MDJ=$O(^TMP("MDTMP",$J,MDJ)) Q:'MDJ!(+MDCF)  D
"RTN","MDPURGE",28,0)
 .I $P($G(^TMP("MDTMP",$J,MDJ)),U,4)="c"&(MDCNS=$P($G(^TMP("MDTMP",$J,MDJ)),U,5)) S MDCF=1 Q
"RTN","MDPURGE",29,0)
 K ^TMP("MDTMP",$J)
"RTN","MDPURGE",30,0)
 Q MDCF
"RTN","MDPURGE",31,0)
PURG(MDI) ; [Procedure] Delete Study
"RTN","MDPURGE",32,0)
 N MDAST,MDFDA,MDHOLD,MDNOTE,MDRES,MDSIEN,BODY,SUBJECT,DEVIEN
"RTN","MDPURGE",33,0)
 S (MDHOLD,MDSIEN)=+MDI,MDRES=0,MDNOTE=""
"RTN","MDPURGE",34,0)
 ;D ALERT^MDHL7U3(MDSIEN) ; Builds the body of the mail message
"RTN","MDPURGE",35,0)
 I $G(^MDD(702,+MDSIEN,0))="" Q
"RTN","MDPURGE",36,0)
 S:+$P(^MDD(702,MDSIEN,0),U,6) MDNOTE=$P(^MDD(702,MDSIEN,0),U,6)
"RTN","MDPURGE",37,0)
 S MDCANR=$$CANCEL^MDHL7B(MDHOLD) I +MDCANR<1 Q
"RTN","MDPURGE",38,0)
 Q:+MDNOTE
"RTN","MDPURGE",39,0)
 S MDAST=$$HL7CHK^MDHL7U3(+MDSIEN) I +MDAST<1 Q
"RTN","MDPURGE",40,0)
 ;D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) ; delete message
"RTN","MDPURGE",41,0)
 ;S MDFDA(702,DATA_",",.01)=""
"RTN","MDPURGE",42,0)
 ; Check for renal study to delete as well
"RTN","MDPURGE",43,0)
 S:$D(^MDK(704.202,+MDI)) MDFDA(704.202,+MDI_",",.01)=""
"RTN","MDPURGE",44,0)
 D FILE^DIE("","MDFDA")
"RTN","MDPURGE",45,0)
 N DA,DIK S DA=+MDSIEN,DIK="^MDD(702," D ^DIK
"RTN","MDPURGE",46,0)
 Q
"RTN","MDRPCOP")
0^13^B75016189^B73541480
"RTN","MDRPCOP",1,0)
MDRPCOP ; HOIFO/DP - Object RPCs (TMDPatient) ;3/12/08  09:16
"RTN","MDRPCOP",2,0)
 ;;1.0;CLINICAL PROCEDURES;**4,6,11**;Apr 01, 2004;Build 67
"RTN","MDRPCOP",3,0)
 ; Integration Agreements:
"RTN","MDRPCOP",4,0)
 ; IA# 2263 [Supported] XPAR calls
"RTN","MDRPCOP",5,0)
 ; IA# 3027 [Supported] Calls to DGSEC4
"RTN","MDRPCOP",6,0)
 ; IA# 2981 [Subscription] Calls to GUI~GMRCP5
"RTN","MDRPCOP",7,0)
 ; IA# 2548 [Supported] ACRP Interface Toolkit APIs.
"RTN","MDRPCOP",8,0)
 ; IA# 2552 [Supported] AIT API to provide outpatient encounter data.
"RTN","MDRPCOP",9,0)
 ; IA# 10061 [Supported] VADPT calls.
"RTN","MDRPCOP",10,0)
 ; IA# 3468 [Subscription] Use GMRCCP APIs.
"RTN","MDRPCOP",11,0)
 ; IA# 10103 [Supported] Call to XLFDT
"RTN","MDRPCOP",12,0)
 ; IA# 10039 [Supported] Ward Location File (#42) Access.
"RTN","MDRPCOP",13,0)
 ; IA# 10035 [Supported] DPT references
"RTN","MDRPCOP",14,0)
 ; IA# 3613 [Private] GETVST^MDRPCOP API call
"RTN","MDRPCOP",15,0)
 ; IA# 10099 [Supported] GMRADPT call
"RTN","MDRPCOP",16,0)
 ; IA# 1096 [Controlled Subscription] ^DGPM("ATID1" x-ref loop
"RTN","MDRPCOP",17,0)
 ; IA# 358 [Controlled Subscription] FILE 405 references
"RTN","MDRPCOP",18,0)
 ;
"RTN","MDRPCOP",19,0)
ADD(X) ; [Procedure] Add line to @RESULTS@(...
"RTN","MDRPCOP",20,0)
 S @RESULTS@(+$O(@RESULTS@(""),-1)+1)=X
"RTN","MDRPCOP",21,0)
 Q
"RTN","MDRPCOP",22,0)
 ;
"RTN","MDRPCOP",23,0)
ALLERGY ; [Procedure] Return Allergies
"RTN","MDRPCOP",24,0)
 D EN1^GMRADPT I '$O(GMRAL(0)) D  Q
"RTN","MDRPCOP",25,0)
 .I $G(GMRAL)="" S @RESULTS@(0)="No Allergy Assessment"
"RTN","MDRPCOP",26,0)
 .I $G(GMRAL)=0 S @RESULTS@(0)="No Known Allergies"
"RTN","MDRPCOP",27,0)
 S @RESULTS@(0)="This patient has the following allergy(ies): "
"RTN","MDRPCOP",28,0)
 F X=0:0 S X=$O(GMRAL(X)) Q:'X  D
"RTN","MDRPCOP",29,0)
 .S @RESULTS@(X)=$P($G(GMRAL(X)),U,2)
"RTN","MDRPCOP",30,0)
 Q
"RTN","MDRPCOP",31,0)
 ;
"RTN","MDRPCOP",32,0)
CHKIN ; [Procedure] Check In Study
"RTN","MDRPCOP",33,0)
 F X=2:1:5 D
"RTN","MDRPCOP",34,0)
 .I $P(DATA,U,X)]"" S MDFDA(702,$P(DATA,U,1),$P("^.04^.05^.11^.07",U,X))=$P(DATA,U,X)
"RTN","MDRPCOP",35,0)
 S MDFDA(702,$P(DATA,U,1),.09)=4  ; Status = Checked-In
"RTN","MDRPCOP",36,0)
 I $P(DATA,U,1)="+1," D
"RTN","MDRPCOP",37,0)
 .S MDFDA(702,"+1,",.01)=DFN
"RTN","MDRPCOP",38,0)
 .S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDRPCOP",39,0)
 .S MDFDA(702,"+1,",.03)=DUZ
"RTN","MDRPCOP",40,0)
 .S MDPC=$P(DATA,"^",5),MDPC=$S($L(MDPC,";")=1:MDPC,1:$P(MDPC,";",2))
"RTN","MDRPCOP",41,0)
 .S MDFDA(702,"+1,",.14)=MDPC
"RTN","MDRPCOP",42,0)
 .D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)
"RTN","MDRPCOP",43,0)
 .S MDIENS=MDIEN(1)_",",MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDRPCOP",44,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDRPCOP",45,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDRPCOP",46,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDRPCOP",47,0)
 I $P(DATA,U,1)'="+1," D
"RTN","MDRPCOP",48,0)
 .D FILE^DIE("","MDFDA","MDERR") Q:$D(MDERR)
"RTN","MDRPCOP",49,0)
 .S MDIENS=+DATA_","
"RTN","MDRPCOP",50,0)
 .S MDHL7=$$SUB^MDHL7B(+MDIENS)
"RTN","MDRPCOP",51,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDRPCOP",52,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDRPCOP",53,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDRPCOP",54,0)
 ; Patch 6 - Renal Check-In
"RTN","MDRPCOP",55,0)
 D:+$G(MDIENS)
"RTN","MDRPCOP",56,0)
 .S X=+$P(^MDD(702,+MDIENS,0),U,4) Q:'X
"RTN","MDRPCOP",57,0)
 .I $P(^MDS(702.01,X,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDRPCOP",58,0)
 ..D CP^MDKUTLR(+MDIENS)
"RTN","MDRPCOP",59,0)
 ..S MDFDA(702,+MDIENS_",",.09)=5
"RTN","MDRPCOP",60,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDRPCOP",61,0)
 ; Patch 6 - Renal Check-In
"RTN","MDRPCOP",62,0)
 I '$D(MDERR) S @RESULTS@(0)="1^OK" Q
"RTN","MDRPCOP",63,0)
 D ERROR^MDRPCU(RESULTS,.MDERR)
"RTN","MDRPCOP",64,0)
 Q
"RTN","MDRPCOP",65,0)
 ;
"RTN","MDRPCOP",66,0)
DISPCON ; [Procedure] Display a consult
"RTN","MDRPCOP",67,0)
 K ^TMP("GMRC",$J)
"RTN","MDRPCOP",68,0)
 D GUI^GMRCP5(.RESULTS,DATA)
"RTN","MDRPCOP",69,0)
 Q
"RTN","MDRPCOP",70,0)
 ;
"RTN","MDRPCOP",71,0)
GETCONS ; [Procedure] Get available consults for patient
"RTN","MDRPCOP",72,0)
 K ^TMP("MDTMP",$J) N MDCDT,MDDY,X1,X2,X
"RTN","MDRPCOP",73,0)
 S MDDY=$$GET^XPAR("SYS","MD COMPL PROC DISPLAY DAYS",1)
"RTN","MDRPCOP",74,0)
 S X1=DT,X2=-$S(MDDY>0:+MDDY,1:365) D C^%DTC S MDCDT=X
"RTN","MDRPCOP",75,0)
 D CPLIST^GMRCCP(DFN,,$NA(^TMP("MDTMP",$J)))
"RTN","MDRPCOP",76,0)
 S MDX=0
"RTN","MDRPCOP",77,0)
 F  S MDX=$O(^TMP("MDTMP",$J,MDX)) Q:'MDX  D:"saprc"[$P(^(MDX),U,4)
"RTN","MDRPCOP",78,0)
 .S Y="123;"_$P(^TMP("MDTMP",$J,MDX),U,5)
"RTN","MDRPCOP",79,0)
 .I $P($G(^TMP("MDTMP",$J,MDX)),U,4)="c" Q:$P($G(^TMP("MDTMP",$J,MDX)),U,1)<MDCDT
"RTN","MDRPCOP",80,0)
 .F X=2,3,4,1,6,5 S Y=Y_U_$P(^TMP("MDTMP",$J,MDX),U,X)
"RTN","MDRPCOP",81,0)
 .S Y=Y_U_+$O(^MDD(702,"ACON",+$P(^TMP("MDTMP",$J,MDX),U,5)))
"RTN","MDRPCOP",82,0)
 .;
"RTN","MDRPCOP",83,0)
 .; Patch MD*1.0*4 - Return number of times checked in at piece 9
"RTN","MDRPCOP",84,0)
 .;
"RTN","MDRPCOP",85,0)
 .S (X,Z)=0,MDY=+$P(^TMP("MDTMP",$J,MDX),U,5)
"RTN","MDRPCOP",86,0)
 .F  S X=$O(^MDD(702,"ACON",MDY,X)) Q:'X  S Z=Z+1
"RTN","MDRPCOP",87,0)
 .S $P(Y,U,9)=Z
"RTN","MDRPCOP",88,0)
 .;
"RTN","MDRPCOP",89,0)
 .; End Patch MD*1.0*4
"RTN","MDRPCOP",90,0)
 .;
"RTN","MDRPCOP",91,0)
 .D ADD(Y)
"RTN","MDRPCOP",92,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOP",93,0)
 K ^TMP("MDTMP",$J)
"RTN","MDRPCOP",94,0)
 Q
"RTN","MDRPCOP",95,0)
 ;
"RTN","MDRPCOP",96,0)
GETHDR ; [Procedure] Get Pt Header
"RTN","MDRPCOP",97,0)
 S DFNIENS=DFN_","
"RTN","MDRPCOP",98,0)
 S @RESULTS@(0)=$$GET1^DIQ(2,DFNIENS,.01)_"  "_$$GET1^DIQ(2,DFNIENS,.1)_" "_$$GET1^DIQ(2,DFNIENS,.101)
"RTN","MDRPCOP",99,0)
 S @RESULTS@(1)=$$GET1^DIQ(2,DFNIENS,.09)_"  "_$$GET1^DIQ(2,DFNIENS,.02)_"  "_$$GET1^DIQ(2,DFNIENS,.03)_" ("_$$GET1^DIQ(2,DFNIENS,.033)_")"
"RTN","MDRPCOP",100,0)
 Q
"RTN","MDRPCOP",101,0)
 ;
"RTN","MDRPCOP",102,0)
GETOBJ ; [Procedure] Get information for TMDPATIENT object
"RTN","MDRPCOP",103,0)
 D DEM^VADPT,INP^VADPT Q:'$D(VADM)
"RTN","MDRPCOP",104,0)
 S @RESULTS@(0)=DFN
"RTN","MDRPCOP",105,0)
 S @RESULTS@(1)=VADM(1)
"RTN","MDRPCOP",106,0)
 S @RESULTS@(2)=$P(VADM(2),U,2)
"RTN","MDRPCOP",107,0)
 S @RESULTS@(3)=$P(VADM(3),U,2)
"RTN","MDRPCOP",108,0)
 S @RESULTS@(4)=VADM(4)
"RTN","MDRPCOP",109,0)
 S @RESULTS@(5)=$P(VADM(5),U,2)
"RTN","MDRPCOP",110,0)
 I VAIN(4)]"" S @RESULTS@(6)="Ward: "_$P(VAIN(4),U,2)_" Rm: "_VAIN(5)
"RTN","MDRPCOP",111,0)
 E  S @RESULTS@(6)=""
"RTN","MDRPCOP",112,0)
 Q
"RTN","MDRPCOP",113,0)
 ;
"RTN","MDRPCOP",114,0)
GETRES ; [Procedure] Get results report
"RTN","MDRPCOP",115,0)
 F MDX=0:0 S MDX=$O(^MDD(703.1,"ADFN",DFN,MDX)) Q:'MDX  D
"RTN","MDRPCOP",116,0)
 .S MDINST=+$P($G(^MDD(703.1,MDX,0)),U,4)
"RTN","MDRPCOP",117,0)
 .I $G(DATA) Q:'$D(^MDS(702.01,DATA,.1,"B",MDINST))
"RTN","MDRPCOP",118,0)
 .S MDY=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOP",119,0)
 .S @RESULTS@(MDY)="703.1;"_MDX_U_^MDD(703.1,MDX,0)
"RTN","MDRPCOP",120,0)
 .S Y=$P(^MDD(703.1,MDX,0),U,3) D D^DIQ
"RTN","MDRPCOP",121,0)
 .S $P(@RESULTS@(MDY),U,11)=Y
"RTN","MDRPCOP",122,0)
 .S Y=$P($G(^MDS(702.09,+$P(^MDD(703.1,MDX,0),U,4),0)),U)
"RTN","MDRPCOP",123,0)
 .S $P(@RESULTS@(MDY),U,12)=Y
"RTN","MDRPCOP",124,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOP",125,0)
 Q
"RTN","MDRPCOP",126,0)
 ;
"RTN","MDRPCOP",127,0)
GETTRAN ; [Procedure] Get a patients transactions
"RTN","MDRPCOP",128,0)
 K ^TMP("MDTMP",$J),^TMP("MDCONL",$J) N MDCDT,MDCOM,MDMULT,MDNUM,MDREQ,MDREQDT,MDYR,X1,X2,X
"RTN","MDRPCOP",129,0)
 S MDNUM=$$GET^XPAR("SYS","MD DAYS TO RETAIN COM STUDY",1) S MDCOM=0
"RTN","MDRPCOP",130,0)
 I +MDNUM>0 S X1=DT,X2=-MDNUM D C^%DTC S MDCOM=X
"RTN","MDRPCOP",131,0)
 D CPLIST^GMRCCP(DFN,,$NA(^TMP("MDTMP",$J)))
"RTN","MDRPCOP",132,0)
 S X1=DT,X2=-365 D C^%DTC S MDCDT=X
"RTN","MDRPCOP",133,0)
 S MDX=0 F  S MDX=$O(^TMP("MDTMP",$J,MDX)) Q:'MDX  D:"saprc"[$P(^(MDX),U,4)
"RTN","MDRPCOP",134,0)
 .I $P($G(^TMP("MDTMP",$J,MDX)),U,4)="c" Q:$P($G(^TMP("MDTMP",$J,MDX)),U,1)<MDCDT
"RTN","MDRPCOP",135,0)
 .S ^TMP("MDCONL",$J,$P($G(^TMP("MDTMP",$J,MDX)),U,5))=$P($G(^TMP("MDTMP",$J,MDX)),U,1)
"RTN","MDRPCOP",136,0)
 K ^TMP("MDTMP",$J)
"RTN","MDRPCOP",137,0)
 F MDX=0:0 S MDX=$O(^MDD(702,"B",DFN,+MDX))_"," Q:'MDX  D
"RTN","MDRPCOP",138,0)
 .Q:'$$GET1^DIQ(702,MDX,.05,"I")
"RTN","MDRPCOP",139,0)
 .Q:$G(^TMP("MDCONL",$J,+$$GET1^DIQ(702,MDX,.05,"I")))=""
"RTN","MDRPCOP",140,0)
 .S MDMULT=+$$GET1^DIQ(702,MDX,".04:.12","I")
"RTN","MDRPCOP",141,0)
 .S MDYR=$S(MDMULT<1:MDCOM,1:MDCDT)
"RTN","MDRPCOP",142,0)
 .I MDNUM Q:$$GET1^DIQ(702,MDX,.09,"I")=3&($$GET1^DIQ(702,MDX,.02,"I")<MDYR)
"RTN","MDRPCOP",143,0)
 .S MDREQDT="" I +$$GET1^DIQ(702,MDX,.05,"I") S MDREQDT=$G(^TMP("MDCONL",$J,+$$GET1^DIQ(702,MDX,.05,"I")))
"RTN","MDRPCOP",144,0)
 .I MDREQDT'="" S MDREQDT=$$FMTE^XLFDT(MDREQDT,"1P")
"RTN","MDRPCOP",145,0)
 .S MDREQ=$$GET1^DIQ(702,MDX,.04)_"  "_+MDX_"  (Consult #:"_$$GET1^DIQ(702,MDX,.05,"I")_$S(MDREQDT'="":" Requested: "_MDREQDT,1:"")_")"
"RTN","MDRPCOP",146,0)
 .S Z=$$GET1^DIQ(702,MDX,".04:.02","I")_U_MDREQ_U_$$GET1^DIQ(702,MDX,.02,"I")_U_$$GET1^DIQ(702,MDX,.09)_U_$$GET1^DIQ(702,MDX,.11)_U_$$GET1^DIQ(702,MDX,.991)
"RTN","MDRPCOP",147,0)
 .S Y=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOP",148,0)
 .S @RESULTS@(Y)="702;"_+MDX_U_Z
"RTN","MDRPCOP",149,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOP",150,0)
 K ^TMP("MDCONL",$J)
"RTN","MDRPCOP",151,0)
 Q
"RTN","MDRPCOP",152,0)
 ;
"RTN","MDRPCOP",153,0)
GETVST ; [Procedure] Return list of visits
"RTN","MDRPCOP",154,0)
 N BEG,END,VAERR,VASD,BDT,DTM,EDT,LOC,NOW,MDQUERY,MDLST,MDTDF,STI,STS,TODAY,I,J,K,XI,XE,X
"RTN","MDRPCOP",155,0)
 S NOW=$$NOW^XLFDT(),TODAY=$P(NOW,".",1),MDTDF=DFN
"RTN","MDRPCOP",156,0)
 S BEG=$$X2FM($$GETBEG),END=$$X2FM($$GETEND)+0.2359
"RTN","MDRPCOP",157,0)
 S MDLST="",MDSTOP=""
"RTN","MDRPCOP",158,0)
 I END>NOW D   ; get future encounters, past cancels/no-shows from VADPT
"RTN","MDRPCOP",159,0)
 .S VASD("F")=BEG
"RTN","MDRPCOP",160,0)
 .S VASD("T")=END
"RTN","MDRPCOP",161,0)
 .S VASD("W")="123456789"
"RTN","MDRPCOP",162,0)
 .D SDA^VADPT
"RTN","MDRPCOP",163,0)
 .S I=0 F  S I=$O(^UTILITY("VASD",$J,I)) Q:'I  D
"RTN","MDRPCOP",164,0)
 ..S XI=^UTILITY("VASD",$J,I,"I"),XE=^("E")
"RTN","MDRPCOP",165,0)
 ..S DTM=$P(XI,U),IEN=$P(XI,U,2),STI=$P(XI,U,3)
"RTN","MDRPCOP",166,0)
 ..S LOC=$P(XE,U,2),STS=$P(XE,U,3)
"RTN","MDRPCOP",167,0)
 ..I DTM<TODAY,(STI=""!(STI["I")!(STI="NT")) Q  ; no prior kept appts
"RTN","MDRPCOP",168,0)
 ..S MDLST(DTM,"A",1)="A;"_DTM_";"_IEN_U_DTM_U_LOC_U_STS
"RTN","MDRPCOP",169,0)
 .K ^UTILITY("VASD",$J)
"RTN","MDRPCOP",170,0)
 I BEG'>NOW D  ;past encounters from ACRP Toolkit - set in CALLBACK
"RTN","MDRPCOP",171,0)
 .S BDT=BEG
"RTN","MDRPCOP",172,0)
 .S EDT=$S(END<NOW:END,1:NOW)
"RTN","MDRPCOP",173,0)
 .D OPEN^SDQ(.MDQUERY)
"RTN","MDRPCOP",174,0)
 .I '$$ERRCHK^SDQUT() D INDEX^SDQ(.MDQUERY,"PATIENT/DATE","SET")
"RTN","MDRPCOP",175,0)
 .I '$$ERRCHK^SDQUT() D PAT^SDQ(.MDQUERY,DFN,"SET")
"RTN","MDRPCOP",176,0)
 .I '$$ERRCHK^SDQUT() D DATE^SDQ(.MDQUERY,BDT,EDT,"SET")
"RTN","MDRPCOP",177,0)
 .I '$$ERRCHK^SDQUT() D
"RTN","MDRPCOP",178,0)
 ..D SCANCB^SDQ(.MDQUERY,"D CALLBACK^ORWCV(Y,Y0,$NA(MDLST),.MDSTOP)","SET")
"RTN","MDRPCOP",179,0)
 .I '$$ERRCHK^SDQUT() D ACTIVE^SDQ(.MDQUERY,"TRUE","SET")
"RTN","MDRPCOP",180,0)
 .I '$$ERRCHK^SDQUT() D SCAN^SDQ(.MDQUERY,"FORWARD")
"RTN","MDRPCOP",181,0)
 .D CLOSE^SDQ(.MDQUERY)
"RTN","MDRPCOP",182,0)
 N TIM,MOV,MDX0,Y,MTIM,XTYP,XLOC,XLOCI,HLOC,EARLY,DONE ; admits
"RTN","MDRPCOP",183,0)
 S EARLY=BEG,DONE=0 S:$G(DFN)="" DFN=MDTDF
"RTN","MDRPCOP",184,0)
 S TIM="" F  S TIM=$O(^DGPM("ATID1",DFN,TIM)) Q:TIM'>0  D  Q:DONE
"RTN","MDRPCOP",185,0)
 .S MOV=0  F  S MOV=$O(^DGPM("ATID1",DFN,TIM,MOV)) Q:MOV'>0  D  Q:DONE
"RTN","MDRPCOP",186,0)
 ..D GETS^DIQ(405,+MOV_",",".01;.04;.06","IE","MDX0") S MTIM=$G(MDX0(405,MOV_",",".01","I"))
"RTN","MDRPCOP",187,0)
 ..S XTYP=$G(MDX0(405,+MOV_",",".04","E"))
"RTN","MDRPCOP",188,0)
 ..S XLOC=$G(MDX0(405,+MOV_",",".06","E"))
"RTN","MDRPCOP",189,0)
 ..S XLOCI=+$G(MDX0(405,+MOV_",",".06","I")),HLOC=+$G(^DIC(42,+XLOCI,44))
"RTN","MDRPCOP",190,0)
 ..S MDLST(MTIM,"I",1)="I;"_MTIM_";"_HLOC_U_MTIM_U_"Inpatient Stay"_U_XLOC_U_XTYP
"RTN","MDRPCOP",191,0)
 ..S DONE=1  ; Not sure if I should include all stays <DRP@Hines>
"RTN","MDRPCOP",192,0)
 S I=0 F  S I=$O(MDLST(I)) Q:'I  D
"RTN","MDRPCOP",193,0)
 .S J="" F  S J=$O(MDLST(I,J)) Q:J=""  D
"RTN","MDRPCOP",194,0)
 ..S K=0 F  S K=$O(MDLST(I,J,K)) Q:'K  D
"RTN","MDRPCOP",195,0)
 ...S @RESULTS@($O(@RESULTS@(""),-1)+1)=MDLST(I,J,K)
"RTN","MDRPCOP",196,0)
 S:$G(DFN)="" DFN=MDTDF S @RESULTS@(0)=+$O(@RESULTS@(""),-1)_U_($$GET1^DIQ(2,DFN_",",.1)]"")
"RTN","MDRPCOP",197,0)
 Q
"RTN","MDRPCOP",198,0)
 ;
"RTN","MDRPCOP",199,0)
GETBEG() ; Get Beginning Date Range
"RTN","MDRPCOP",200,0)
 I $$GET^XPAR("SYS","MD APPOINT START DATE",1)>1 Q "T-"_$$GET^XPAR("SYS","MD APPOINT START DATE",1)
"RTN","MDRPCOP",201,0)
 Q "T-200"
"RTN","MDRPCOP",202,0)
GETEND() ; Get Ending Date Range
"RTN","MDRPCOP",203,0)
 I $$GET^XPAR("SYS","MD APPOINT END DATE",1)>1 Q "T+"_$$GET^XPAR("SYS","MD APPOINT END DATE",1)
"RTN","MDRPCOP",204,0)
 Q "T"
"RTN","MDRPCOP",205,0)
LOGSEC ; [Procedure] Log Security
"RTN","MDRPCOP",206,0)
 N RES
"RTN","MDRPCOP",207,0)
 D NOTICE^DGSEC4(.RES,DFN,DATA,1)
"RTN","MDRPCOP",208,0)
 S @RESULTS@(0)=$S(+RES:"1^Logged",1:"-1^Unable to log")
"RTN","MDRPCOP",209,0)
 Q
"RTN","MDRPCOP",210,0)
 ;
"RTN","MDRPCOP",211,0)
RPC(RESULTS,OPTION,DFN,DATA) ; [Procedure] Main RPC call tag
"RTN","MDRPCOP",212,0)
 NEW DFNIENS,GMRAL,GMVALG,GN,IENS,MDDFN,MDERR,MDFDA,MDFLD,MDHL7,MDID,MDIDS,MDIEN,MDIENS,MDRET,MDX,MDY,VA,VADM,VAERR,VAIN,Z
"RTN","MDRPCOP",213,0)
 S RESULTS=$NA(^TMP($J)) K @RESULTS
"RTN","MDRPCOP",214,0)
 D:$T(@OPTION)]"" @OPTION
"RTN","MDRPCOP",215,0)
 D:'$D(@RESULTS) BADRPC^MDRPCU("MD TMDPATIENT","MDRPCOP",OPTION)
"RTN","MDRPCOP",216,0)
 D CLEAN^DILF
"RTN","MDRPCOP",217,0)
 Q
"RTN","MDRPCOP",218,0)
 ;
"RTN","MDRPCOP",219,0)
SELECT ; [Procedure] Select patient
"RTN","MDRPCOP",220,0)
 ; Moved to continuation routine at MD*1.0*6 due to routine size
"RTN","MDRPCOP",221,0)
 D SELECT^MDRPCOP1
"RTN","MDRPCOP",222,0)
 Q
"RTN","MDRPCOP",223,0)
 ;
"RTN","MDRPCOP",224,0)
X2FM(X) ; [Function] return FM date given relative date
"RTN","MDRPCOP",225,0)
 N %DT S %DT="TS" D ^%DT
"RTN","MDRPCOP",226,0)
 Q Y
"RTN","MDRPCOP",227,0)
 ;
"RTN","MDRPCOT")
0^9^B79210353^B75811389
"RTN","MDRPCOT",1,0)
MDRPCOT ; HOIFO/DP/NCA - Object RPCs (TMDTransaction) ;3/12/08  09:18
"RTN","MDRPCOT",2,0)
 ;;1.0;CLINICAL PROCEDURES;**5,6,11**;Apr 01, 2004;Build 67
"RTN","MDRPCOT",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT",4,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDRPCOT",5,0)
 ; IA# 2944 [Subscription] Calls to TIUSRVR1.
"RTN","MDRPCOT",6,0)
 ; IA# 3535 [Subscription] Calls to TIUSRVP.
"RTN","MDRPCOT",7,0)
 ; IA# 10104 [Supported] Routine XLFSTR calls
"RTN","MDRPCOT",8,0)
ADDMSG ; [Procedure] Add message to transaction
"RTN","MDRPCOT",9,0)
 N MDIEN,MDIENS,MDRET
"RTN","MDRPCOT",10,0)
 Q:'$G(DATA("TRANSACTION"))
"RTN","MDRPCOT",11,0)
 Q:$G(DATA("MESSAGE"))=""
"RTN","MDRPCOT",12,0)
 S MDIEN=+DATA("TRANSACTION"),MDIENS="+1,"_MDIEN_","
"RTN","MDRPCOT",13,0)
 D NOW^%DTC S DATA("DATE")=% K %
"RTN","MDRPCOT",14,0)
 S MDFDA(702.091,MDIENS,.01)=+$O(^MDD(702,+MDIEN,.091,"A"),-1)+1
"RTN","MDRPCOT",15,0)
 S MDFDA(702.091,MDIENS,.02)=DATA("DATE")
"RTN","MDRPCOT",16,0)
 S MDFDA(702.091,MDIENS,.03)=$G(DATA("PKG"),"UNKNOWN")
"RTN","MDRPCOT",17,0)
 S MDFDA(702.091,MDIENS,.09)=DATA("MESSAGE")
"RTN","MDRPCOT",18,0)
 D UPDATE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOT",19,0)
 Q
"RTN","MDRPCOT",20,0)
 ;
"RTN","MDRPCOT",21,0)
DELETE ; [Procedure] Delete Study
"RTN","MDRPCOT",22,0)
 ; Sets @RESULTS@(0)="-1^Reason for not deleting" or "1^Study Deleted"
"RTN","MDRPCOT",23,0)
 ;
"RTN","MDRPCOT",24,0)
 N MDAST,MDHOLD,MDNOTE,MDRES,MDSIEN,BODY,SUBJECT,DEVIEN
"RTN","MDRPCOT",25,0)
 S (MDHOLD,MDSIEN)=+DATA,MDRES=0,MDNOTE=""
"RTN","MDRPCOT",26,0)
 D ALERT^MDHL7U3(MDSIEN) ; Builds the body of the mail message
"RTN","MDRPCOT",27,0)
 I $G(^MDD(702,+MDSIEN,0))="" S @RESULTS@(0)="1^Study Deleted." D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) Q  ;deleting message
"RTN","MDRPCOT",28,0)
 S:+$P(^MDD(702,MDSIEN,0),U,6) MDNOTE=$P(^MDD(702,MDSIEN,0),U,6)
"RTN","MDRPCOT",29,0)
 I "13"[$P(^MDD(702,MDSIEN,0),U,9) S @RESULTS@(0)="-1^Can't Delete TIU Note from a "_$$GET1^DIQ(702,MDSIEN,.09,"E")_" Study." Q
"RTN","MDRPCOT",30,0)
 I "5"[$P(^MDD(702,MDSIEN,0),U,9) S MDCANR=$$CANCEL^MDHL7B(MDHOLD) I +MDCANR<1 S @RESULTS@(0)="-1^"_$P(MDCANR,"^",2) Q
"RTN","MDRPCOT",31,0)
 I +MDNOTE S MDRES="" D DELETE^TIUSRVP(.MDRES,MDNOTE)
"RTN","MDRPCOT",32,0)
 I MDRES D  Q
"RTN","MDRPCOT",33,0)
 .D STATUS(MDSIEN_",",2,$P(MDRES,"^",2))
"RTN","MDRPCOT",34,0)
 .S DATA("TRANSACTION")=MDSIEN,DATA("PKG")="TIU"
"RTN","MDRPCOT",35,0)
 .S DATA("MESSAGE")=$P(MDRES,"^",2) D ADDMSG
"RTN","MDRPCOT",36,0)
 .S @RESULTS@(0)="-1^"_$P(MDRES,"^",2)
"RTN","MDRPCOT",37,0)
 .Q
"RTN","MDRPCOT",38,0)
 E  D
"RTN","MDRPCOT",39,0)
 .I $D(^MDD(702.001,"ASTUDY",MDSIEN)) S @RESULTS@(0)="-1^Note associated with study, can not delete." Q
"RTN","MDRPCOT",40,0)
 .S MDAST=$$HL7CHK^MDHL7U3(+MDSIEN) I +MDAST<1 S @RESULTS@(0)=MDAST Q
"RTN","MDRPCOT",41,0)
 .D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) ; delete message
"RTN","MDRPCOT",42,0)
 .S MDFDA(702,DATA_",",.01)=""
"RTN","MDRPCOT",43,0)
 .; Check for renal study to delete as well
"RTN","MDRPCOT",44,0)
 .S:$D(^MDK(704.202,DATA)) MDFDA(704.202,DATA_",",.01)=""
"RTN","MDRPCOT",45,0)
 .D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",46,0)
 .N DA,DIK S DA=+MDSIEN,DIK="^MDD(702," D ^DIK
"RTN","MDRPCOT",47,0)
 .S @RESULTS@(0)="1^Study Deleted."
"RTN","MDRPCOT",48,0)
 .Q
"RTN","MDRPCOT",49,0)
 Q
"RTN","MDRPCOT",50,0)
 ;
"RTN","MDRPCOT",51,0)
FILEMSG(STUDY,MDPKG,MDSTAT,MDMSG) ; [Procedure] File Study Status and Message.
"RTN","MDRPCOT",52,0)
 S DATA("TRANSACTION")=STUDY,DATA("PKG")=MDPKG
"RTN","MDRPCOT",53,0)
 S DATA("MESSAGE")=$P(MDMSG,"^",2)
"RTN","MDRPCOT",54,0)
 D STATUS(STUDY_",",MDSTAT,$P(MDMSG,"^",2)),ADDMSG
"RTN","MDRPCOT",55,0)
 Q
"RTN","MDRPCOT",56,0)
 ;
"RTN","MDRPCOT",57,0)
FILES ; [Procedure] Add/remove an attachment to this transaction
"RTN","MDRPCOT",58,0)
 NEW MDFDA,MDIEN,MDIENS,MDRET,MDT,MDT1,P1,P2,P3,P4
"RTN","MDRPCOT",59,0)
 S P1=$P(DATA,U,1),P2=$P(DATA,U,2),P3=$P(DATA,U,3),P4=$P(DATA,U,4)
"RTN","MDRPCOT",60,0)
 S MDIEN=0 I $G(^MDD(702,+P1,0))="" Q
"RTN","MDRPCOT",61,0)
 S MDT=+P1,MDT1=$$MULT^MDRPCOT1(MDT),MDT=$S('MDT1:1,MDT1=1:1,1:0)
"RTN","MDRPCOT",62,0)
 I +MDT,$P($G(^MDD(702,+P1,0)),"^",9)=3 S @RESULTS@(0)="1^Study is already complete" Q
"RTN","MDRPCOT",63,0)
 I $P($G(^MDD(702,+P1,0)),"^",9)=6 S @RESULTS@(0)="1^Study is already cancelled" Q
"RTN","MDRPCOT",64,0)
 ; Look for file (All comparisons done on lower case values)
"RTN","MDRPCOT",65,0)
 F  S MDIEN=$O(^MDD(702,P1,.1,MDIEN)) Q:'MDIEN  D  Q:X=P3
"RTN","MDRPCOT",66,0)
 .S X=$$LOW^XLFSTR($G(^MDD(702,P1,.1,MDIEN,.1)))
"RTN","MDRPCOT",67,0)
 I MDIEN&P4 S @RESULTS@(0)="1^File already assigned" Q
"RTN","MDRPCOT",68,0)
 I 'MDIEN&'P4 S @RESULTS@(0)="1^File not assigned" Q
"RTN","MDRPCOT",69,0)
 I P4 D  Q  ; Add a file
"RTN","MDRPCOT",70,0)
 .S MDIENS="+1,"_P1_","
"RTN","MDRPCOT",71,0)
 .S MDFDA(702.1,MDIENS,.01)=$O(^MDD(702,P1,.1,"B",""),-1)+1
"RTN","MDRPCOT",72,0)
 .S MDFDA(702.1,MDIENS,.02)=$S(P2:"I",1:"U")
"RTN","MDRPCOT",73,0)
 .I P2 S MDFDA(702.1,MDIENS,.03)=P2
"RTN","MDRPCOT",74,0)
 .S MDFDA(702.1,MDIENS,.1)=P3
"RTN","MDRPCOT",75,0)
 .D UPDATE^DIE("","MDFDA","MDIEN")
"RTN","MDRPCOT",76,0)
 .S @RESULTS@(0)=+$G(MDIEN(1),-1)
"RTN","MDRPCOT",77,0)
 I 'P4 D  Q  ; Remove the file
"RTN","MDRPCOT",78,0)
 .S MDFDA(702.1,MDIEN_","_P1_",",.01)="@"
"RTN","MDRPCOT",79,0)
 .D FILE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOT",80,0)
 .S @RESULTS@(0)=$S($D(MDRET):-1,1:1)
"RTN","MDRPCOT",81,0)
 Q
"RTN","MDRPCOT",82,0)
 ;
"RTN","MDRPCOT",83,0)
GETATT ; [Procedure] Get Attachments
"RTN","MDRPCOT",84,0)
 F X=0:0 S X=$O(^MDD(702,DATA,.1,X)) Q:'X  D
"RTN","MDRPCOT",85,0)
 .S Y=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOT",86,0)
 .S @RESULTS@(Y)=$P(^MDD(702,DATA,.1,X,0),U,1,3)
"RTN","MDRPCOT",87,0)
 .S $P(@RESULTS@(Y),U,4)=$G(^MDD(702,DATA,.1,X,.1))
"RTN","MDRPCOT",88,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOT",89,0)
 Q
"RTN","MDRPCOT",90,0)
 ;
"RTN","MDRPCOT",91,0)
GETERR ; [Procedure] Return list of Imaging Errors
"RTN","MDRPCOT",92,0)
 ; DATA = Transaction IEN
"RTN","MDRPCOT",93,0)
 F MDX=0:0 S MDX=$O(^MDD(702,DATA,.091,MDX)) Q:'MDX  D
"RTN","MDRPCOT",94,0)
 .S MDY=+^MDD(702,DATA,.091,MDX,0)_U,Y=$P(^(0),U,2)
"RTN","MDRPCOT",95,0)
 .D D^DIQ S MDY=MDY_Y_U
"RTN","MDRPCOT",96,0)
 .S MDY=MDY_$P(^MDD(702,DATA,.091,MDX,0),U,3)_U_$P(^(0),U,9)
"RTN","MDRPCOT",97,0)
 .S ^TMP($J,$O(^TMP($J,""),-1)+1)=MDY
"RTN","MDRPCOT",98,0)
 S ^TMP($J,0)=+$O(^TMP($J,""),-1)
"RTN","MDRPCOT",99,0)
 Q
"RTN","MDRPCOT",100,0)
 ;
"RTN","MDRPCOT",101,0)
NEWSTAT ; [Procedure] RPC Call to set status
"RTN","MDRPCOT",102,0)
 S MDFDA(702,DATA,.09)=TYPE
"RTN","MDRPCOT",103,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",104,0)
 I TYPE=3&($G(^MDK(704.202,+DATA,0))'="") K MDFDA S MDFDA(704.202,DATA,.09)=0 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDRPCOT",105,0)
 Q
"RTN","MDRPCOT",106,0)
 ;
"RTN","MDRPCOT",107,0)
RPC(RESULTS,OPTION,DATA,TYPE,FILE,RESREP) ; [Procedure] Main RPC call
"RTN","MDRPCOT",108,0)
 N MDCANR,MDCON,MDDOC,MDFDA,MDFN,MDGST,MDHOLD,MDIEN,MDIENS,MDL,MDLOC,MDMSG,MDNEWV,MDNOTE,MDNVST,MDPDT,MDPKG,MDPROC,MDRES,MDRESU,MDRESUL,MDRET,MDS,MDSIEN,MDSTAT,MDSTUDY,MDTITL,MDTIUER,MDTRAN,MDTST,MDTSTR,MDVST,MDVSTR,MDWP,MDX,MDY
"RTN","MDRPCOT",109,0)
 S RESULTS=$NA(^TMP($J)) K @RESULTS
"RTN","MDRPCOT",110,0)
 D:$T(@OPTION)]"" @OPTION
"RTN","MDRPCOT",111,0)
 D:'$D(@RESULTS) BADRPC^MDRPCU("MD TMDTRANSACTION","MDRPCOT",OPTION)
"RTN","MDRPCOT",112,0)
 D CLEAN^DILF
"RTN","MDRPCOT",113,0)
 Q
"RTN","MDRPCOT",114,0)
 ;
"RTN","MDRPCOT",115,0)
STATUS(MDIENS,MDSTAT,MDMSG) ; [Procedure] Update transaction status
"RTN","MDRPCOT",116,0)
 S MDFDA(702,MDIENS,.08)=$G(MDMSG)
"RTN","MDRPCOT",117,0)
 S MDFDA(702,MDIENS,.09)=MDSTAT
"RTN","MDRPCOT",118,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",119,0)
 Q
"RTN","MDRPCOT",120,0)
 ;
"RTN","MDRPCOT",121,0)
SUBMIT ; [Procedure] Process the Image(s) Submission.
"RTN","MDRPCOT",122,0)
 ; Output: -1^Error Message or
"RTN","MDRPCOT",123,0)
 ;          1^Successful Message
"RTN","MDRPCOT",124,0)
 N MDRESUL,MDSTUDY
"RTN","MDRPCOT",125,0)
 S MDSTUDY=+DATA,MDRESUL=""
"RTN","MDRPCOT",126,0)
 ; Create New TIU Document
"RTN","MDRPCOT",127,0)
 S MDRESUL=$$NEWTIUN(MDSTUDY)
"RTN","MDRPCOT",128,0)
 ; File TIU Error messages
"RTN","MDRPCOT",129,0)
 I +MDRESUL<0 D  Q
"RTN","MDRPCOT",130,0)
 .D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCOT",131,0)
 .S @RESULTS@(0)=MDRESUL
"RTN","MDRPCOT",132,0)
 ; Submit and export the images
"RTN","MDRPCOT",133,0)
 S MDRESUL=$$SUBMIT^MDRPCOT1(MDSTUDY)
"RTN","MDRPCOT",134,0)
 ; File message
"RTN","MDRPCOT",135,0)
 D FILEMSG(MDSTUDY,"IMAGING",$S(+MDRESUL>0:+MDRESUL,1:2),MDRESUL)
"RTN","MDRPCOT",136,0)
 S @RESULTS@(0)=MDRESUL
"RTN","MDRPCOT",137,0)
 Q
"RTN","MDRPCOT",138,0)
 ;
"RTN","MDRPCOT",139,0)
VIEWTIU ; [Procedure] VIew the associated tiu document
"RTN","MDRPCOT",140,0)
 I '$P(^MDD(702,+DATA,0),U,6) D  Q
"RTN","MDRPCOT",141,0)
 .S @RESULTS@(0)="NO TIU NOTE FOR THIS STUDY"
"RTN","MDRPCOT",142,0)
 D TGET^TIUSRVR1(.RESULTS,+$P(^MDD(702,+DATA,0),U,6))
"RTN","MDRPCOT",143,0)
 Q
"RTN","MDRPCOT",144,0)
 ;
"RTN","MDRPCOT",145,0)
GETDATA(STUDY) ; [Function] Return the Necessary data for creating a TIU note.
"RTN","MDRPCOT",146,0)
 ; Return: Patient DFN_"^"_TIU title_"^"_Hospital Location_"^"_TIU Note
"RTN","MDRPCOT",147,0)
 ;         IEN_"^"_Consult #_"^"_CP Definition IEN_"^"_Visit String_"^"
"RTN","MDRPCOT",148,0)
 ;         New Visit Flag
"RTN","MDRPCOT",149,0)
 ;         or
"RTN","MDRPCOT",150,0)
 ;         -1^Error Message
"RTN","MDRPCOT",151,0)
 N DFN,MDCON,MDFN,MDIEN,MDDPT,MDIENS,MDLOC,MDNEWV,MDNOTE,MDNVST,MDPROC,MDVSTR,MDTITL,MDX,MDTST
"RTN","MDRPCOT",152,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDNVST=0
"RTN","MDRPCOT",153,0)
 I $$GET1^DIQ(702,MDIENS,.01)="" Q "-1^No such study entry."
"RTN","MDRPCOT",154,0)
 ; Get DFN
"RTN","MDRPCOT",155,0)
 S DFN=$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT",156,0)
 I 'DFN Q "-1^No DFN."
"RTN","MDRPCOT",157,0)
 ; Get CP Def
"RTN","MDRPCOT",158,0)
 S MDPROC=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT",159,0)
 I 'MDPROC Q "-1^No CP Def."
"RTN","MDRPCOT",160,0)
 ; Get Consult
"RTN","MDRPCOT",161,0)
 S MDCON=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT",162,0)
 I 'MDCON Q "-1^No Consult #."
"RTN","MDRPCOT",163,0)
 ; Get TIU Note Title
"RTN","MDRPCOT",164,0)
 S MDTITL=$$GET1^DIQ(702.01,+MDPROC_",",.04,"I")
"RTN","MDRPCOT",165,0)
 I 'MDTITL Q "-1^No TIU Note Title."
"RTN","MDRPCOT",166,0)
 S MDVSTR=$$GET1^DIQ(702,MDIEN,.07)
"RTN","MDRPCOT",167,0)
 I MDVSTR=""  Q "-1^No Visit String."
"RTN","MDRPCOT",168,0)
 I $L(MDVSTR,";")=1 S MDNVST=1,MDDPT=$$PDT^MDRPCOT1(MDIEN),MDVSTR=";"_MDVSTR ; If new visit is selected
"RTN","MDRPCOT",169,0)
 ; MDLOC is Hospital Location
"RTN","MDRPCOT",170,0)
 I MDVSTR'="" D
"RTN","MDRPCOT",171,0)
 .S MDVSTR=$$GETVSTR^MDRPCOT1(DFN,MDVSTR,MDPROC,$$GET1^DIQ(702,MDIEN,.02,"I"))
"RTN","MDRPCOT",172,0)
 .S MDLOC=$P(MDVSTR,";",1)
"RTN","MDRPCOT",173,0)
 I $$GET1^DIQ(702.01,+MDPROC_",",.12,"I")=1 Q DFN_"^"_MDTITL_"^"_MDLOC_"^^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",174,0)
 ; Does TIU doc already exist?
"RTN","MDRPCOT",175,0)
 I $$GET1^DIQ(702,MDIEN,.06,"I") Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+$$GET1^DIQ(702,MDIEN,.06,"I")_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",176,0)
 ; Does TIU doc exist for previous transaction of this consult?
"RTN","MDRPCOT",177,0)
 I MDCON S MDNOTE=$$PREV(MDCON,MDIEN)
"RTN","MDRPCOT",178,0)
 Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+MDNOTE_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",179,0)
 ;
"RTN","MDRPCOT",180,0)
NEWTIUN(STUDY) ; [Function] Create a new TIU for transaction
"RTN","MDRPCOT",181,0)
 ; Input: STUDY - IENS of CP study entry
"RTN","MDRPCOT",182,0)
 ; Return: TIU Document IEN
"RTN","MDRPCOT",183,0)
 N CTR,DFN,MDCON,MDFDA,MDGST,MDL,MDLOC,MDNOTE,MDPDT,MDPROC,MDRESU,MDTITL,MDTSTR,MDVST,MDVSTR,MDWP,MDPT S CTR=0,MDGST=+STUDY,MDRESU=""
"RTN","MDRPCOT",184,0)
 ; Get data for TIU Note Creation
"RTN","MDRPCOT",185,0)
 S (MDTSTR,MDRESU)=$$GETDATA(MDGST)
"RTN","MDRPCOT",186,0)
 ; File Error message
"RTN","MDRPCOT",187,0)
 I +MDRESU<0 D FILEMSG(MDGST,"CP",2,MDRESU) Q MDRESU
"RTN","MDRPCOT",188,0)
 I $G(MDTSTR)="" Q "-1^No Data to Create TIU Document"
"RTN","MDRPCOT",189,0)
 F MDL="DFN","MDTITL","MDLOC","MDNOTE","MDCON","MDPROC","MDVSTR","MDNVST" D
"RTN","MDRPCOT",190,0)
 .S CTR=CTR+1,@MDL=$P(MDTSTR,"^",CTR)
"RTN","MDRPCOT",191,0)
 S MDVST=""
"RTN","MDRPCOT",192,0)
 ; If previous TIU document exists, quit
"RTN","MDRPCOT",193,0)
 I MDNOTE Q MDNOTE
"RTN","MDRPCOT",194,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT",195,0)
 ; Create new visit, if no vstring
"RTN","MDRPCOT",196,0)
 S MDPDT=$$PDT^MDRPCOT1(MDGST)
"RTN","MDRPCOT",197,0)
 I 'MDPDT S MDPT=$O(^MDD(703.1,"ASTUDYID",+MDGST,0)),MDPDT=$P($G(^MDD(703.1,+MDPT,0)),U,3)
"RTN","MDRPCOT",198,0)
 S:'MDPDT MDPDT=$P(MDVSTR,";",2) ; If No D/T Performed grab visit D/T
"RTN","MDRPCOT",199,0)
 I $P(MDVSTR,";",3)="V" S $P(MDVSTR,";",3)="A"
"RTN","MDRPCOT",200,0)
 ; Build variables for TIU Call
"RTN","MDRPCOT",201,0)
 S MDWP(.05)=1 ; Undicated Status
"RTN","MDRPCOT",202,0)
 S MDWP(1405)=+MDCON_";GMR(123," ; Package Reference
"RTN","MDRPCOT",203,0)
 S MDWP(70201)=5 ; Default Procedure Summary Code "Machine Resulted"
"RTN","MDRPCOT",204,0)
 I MDPDT S MDWP(70202)=MDPDT ; Date/Time Performed
"RTN","MDRPCOT",205,0)
 ; File PCE Error message
"RTN","MDRPCOT",206,0)
 I MDNVST S MDRESU=$$EN1^MDPCE(MDGST,$P(MDVSTR,";",2),MDPROC,$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU,MDVSTR=$P(MDRESU,"^",2)
"RTN","MDRPCOT",207,0)
 I MDNVST&(+MDRESU<0) D FILEMSG(MDGST,"PCE",2,$P(MDRESU,"^",2)) Q MDRESU
"RTN","MDRPCOT",208,0)
 ; Create the TIU note stub
"RTN","MDRPCOT",209,0)
 S MDNOTE="" D MAKE^TIUSRVP(.MDNOTE,DFN,MDTITL,$P(MDVSTR,";",2),MDLOC,$S(MDVST:MDVST,1:""),.MDWP,MDVSTR,1,1)
"RTN","MDRPCOT",210,0)
 I '(+MDNOTE) S $P(MDNOTE,"^")=-1 Q MDNOTE
"RTN","MDRPCOT",211,0)
 ; Finalize the transaction
"RTN","MDRPCOT",212,0)
 S MDFDA(702,STUDY_",",.06)=+MDNOTE
"RTN","MDRPCOT",213,0)
 S MDFDA(702,STUDY_",",.08)=""
"RTN","MDRPCOT",214,0)
 S:MDVST>0 MDFDA(702,STUDY_",",.13)=MDVST
"RTN","MDRPCOT",215,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",216,0)
 D UPD^MDKUTLR(STUDY,+MDNOTE)
"RTN","MDRPCOT",217,0)
 Q 1
"RTN","MDRPCOT",218,0)
 ;
"RTN","MDRPCOT",219,0)
PREV(MDC,MDS) ; [Function] Return the Previous TIU document.
"RTN","MDRPCOT",220,0)
 N MDNEWV,MDDOC,MDTRAN,MDTIUER,MDTST
"RTN","MDRPCOT",221,0)
 S (MDDOC,MDNEWV,MDTRAN,MDTIUER,MDTST)="" K ^TMP("MDTIUST",$J)
"RTN","MDRPCOT",222,0)
 F  S MDTRAN=$O(^MDD(702,"ACON",MDC,MDTRAN)) Q:'MDTRAN  D  Q:'MDTRAN
"RTN","MDRPCOT",223,0)
 .I $P(^MDD(702,MDTRAN,0),U,6) D
"RTN","MDRPCOT",224,0)
 ..D EXTRACT^TIULQ($P(^MDD(702,MDTRAN,0),U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;1406") Q:+MDTIUER
"RTN","MDRPCOT",225,0)
 ..S MDTST=$G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),.05,"E"))
"RTN","MDRPCOT",226,0)
 ..I MDTST'="UNDICTATED"&(MDTST'="UNSIGNED") K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT",227,0)
 ..I MDTST="UNSIGNED"&'($G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),1406,"I"))) K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT",228,0)
 ..S MDDOC=$P(^MDD(702,MDTRAN,0),U,6),MDNEWV=$P(^MDD(702,MDTRAN,0),U,7)
"RTN","MDRPCOT",229,0)
 ..Q:'MDS
"RTN","MDRPCOT",230,0)
 ..S MDFDA(702,MDS_",",.06)=MDDOC
"RTN","MDRPCOT",231,0)
 ..S MDFDA(702,MDS_",",.07)=MDNEWV
"RTN","MDRPCOT",232,0)
 ..D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",233,0)
 ..S MDTRAN=""
"RTN","MDRPCOT",234,0)
 Q MDDOC
"RTN","MDRPCOT",235,0)
 ;
"RTN","MDRPCOT1")
0^10^B34134564^B27880896
"RTN","MDRPCOT1",1,0)
MDRPCOT1 ; HOIFO/NCA/DP - Object RPCs (TMDTransaction) - Continued ; [08-02-2002 12:55]
"RTN","MDRPCOT1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**5,11**;Apr 01, 2004;Build 67
"RTN","MDRPCOT1",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT1",4,0)
 ; IA# 2263 [Supported] calls to XPAR
"RTN","MDRPCOT1",5,0)
 ; IA# 3468 [Subscription] GMRCCP API.
"RTN","MDRPCOT1",6,0)
 ; IA# 3567 [Subscription] MAGGSIUI API
"RTN","MDRPCOT1",7,0)
 ; IA# 10040 [Supported] Hospital Location File Access
"RTN","MDRPCOT1",8,0)
 ; IA# 10061 [Supported] Calls to VADPT
"RTN","MDRPCOT1",9,0)
 ; IA# 10103 [Supported] Calls to XLFDT.
"RTN","MDRPCOT1",10,0)
 ;
"RTN","MDRPCOT1",11,0)
DELERR(MDTIEN) ; [Procedure] Delete Imaging Error Messages
"RTN","MDRPCOT1",12,0)
 S MDLP=0 F  S MDLP=$O(^MDD(702,MDTIEN,.091,MDLP)) Q:'MDLP  D
"RTN","MDRPCOT1",13,0)
 .K DA,DIK
"RTN","MDRPCOT1",14,0)
 .S DA=+MDLP,DA(1)=+MDTIEN,DIK="^MDD(702,"_DA(1)_",.091," D ^DIK
"RTN","MDRPCOT1",15,0)
 .Q
"RTN","MDRPCOT1",16,0)
 Q
"RTN","MDRPCOT1",17,0)
 ;
"RTN","MDRPCOT1",18,0)
IMGSTAT(STUDY,MDSTAT) ; [Procedure] Update the Image Status.
"RTN","MDRPCOT1",19,0)
 N MDL
"RTN","MDRPCOT1",20,0)
 S MDL=0 F  S MDL=$O(^MDD(702,STUDY,.1,MDL)) Q:MDL<1  S $P(^(MDL,0),"^",9)=MDSTAT
"RTN","MDRPCOT1",21,0)
 Q
"RTN","MDRPCOT1",22,0)
 ;
"RTN","MDRPCOT1",23,0)
GETVSTR(DFN,MDSSTR,MDPR,MDTR) ; [Function] Check the Visit String
"RTN","MDRPCOT1",24,0)
 N MDCLOC,MDHOLD,MDLOC,MDINPT,VAIP
"RTN","MDRPCOT1",25,0)
 N MDPR12,MDAPP ; Patch 11
"RTN","MDRPCOT1",26,0)
 I '$G(MDTR) Q 0
"RTN","MDRPCOT1",27,0)
 I '$G(MDPR) Q 0
"RTN","MDRPCOT1",28,0)
 I $G(MDSSTR)="" Q 0
"RTN","MDRPCOT1",29,0)
 S VAIP("D")=MDTR ; DT of Transaction Created
"RTN","MDRPCOT1",30,0)
 D IN5^VADPT S MDINPT=$S(+VAIP(13):1,1:0)
"RTN","MDRPCOT1",31,0)
 S (MDCLOC,MDHOLD)=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDRPCOT1",32,0)
 ; Patch 11
"RTN","MDRPCOT1",33,0)
 S MDPR12=$$GET1^DIQ(702.01,+MDPR_",",.12,"I")
"RTN","MDRPCOT1",34,0)
 S:MDPR12=1 MDCLOC=""
"RTN","MDRPCOT1",35,0)
 S MDAPP=$$GET^XPAR("SYS","MD USE APPOINTMENT",1)
"RTN","MDRPCOT1",36,0)
 ; End Patch 11 code
"RTN","MDRPCOT1",37,0)
 I 'MDCLOC S MDCLOC=+$P(MDSSTR,";",3) I 'MDCLOC S MDCLOC=MDHOLD I 'MDCLOC Q 0
"RTN","MDRPCOT1",38,0)
 I +MDAPP S MDCLOC=$S(+$P(MDSSTR,";",3)>1:+$P(MDSSTR,";",3),1:MDCLOC) I 'MDCLOC Q 0
"RTN","MDRPCOT1",39,0)
 S Y=MDCLOC_";"_$P(MDSSTR,";",2)_";"_$P(MDSSTR,";")
"RTN","MDRPCOT1",40,0)
 I $P(Y,";",3)="A" Q Y
"RTN","MDRPCOT1",41,0)
 S:$P(Y,";",3)="" $P(Y,";",3)="A"
"RTN","MDRPCOT1",42,0)
 S:+MDINPT $P(Y,";",3)="A"
"RTN","MDRPCOT1",43,0)
 S:$P(Y,";",3)="V" $P(Y,";",3)="A"
"RTN","MDRPCOT1",44,0)
 Q Y
"RTN","MDRPCOT1",45,0)
 ;
"RTN","MDRPCOT1",46,0)
PDT(STUDIE) ; [Function] Loop through the attachments for Date/Time Performed.
"RTN","MDRPCOT1",47,0)
 N MDL,MDDT
"RTN","MDRPCOT1",48,0)
 S MDL=0,MDDT=""
"RTN","MDRPCOT1",49,0)
 F  S MDL=$O(^MDD(702,STUDIE,.1,MDL)) Q:'MDL  D  Q:MDDT
"RTN","MDRPCOT1",50,0)
 .S MDDT=$P($G(^MDD(702,STUDIE,.1,MDL,0)),"^",3)
"RTN","MDRPCOT1",51,0)
 I MDDT S MDDT=$P($G(^MDD(703.1,+MDDT,0)),"^",3) ; Get Date/Time Performed
"RTN","MDRPCOT1",52,0)
 S:'MDDT MDDT=$$NOW^XLFDT()
"RTN","MDRPCOT1",53,0)
 Q MDDT
"RTN","MDRPCOT1",54,0)
 ;
"RTN","MDRPCOT1",55,0)
SUBMIT(STUDY) ; [Function] Submit all non-pending/uncomplete images in transaction to Imaging
"RTN","MDRPCOT1",56,0)
 N DATA,MDACQ,MDC,MDCRES,MDCTR,MDLOC,MDAR,MDARR,MDDT,MDFDA,MDDEL,MDIEN,MDIENS,MDIMG,MDL,MDMAG,MDMULT,MDR,MDST,MDX,MDY,MDZ
"RTN","MDRPCOT1",57,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_","
"RTN","MDRPCOT1",58,0)
 S MDMULT=$$MULT(+MDIEN)
"RTN","MDRPCOT1",59,0)
 S MDST=$$GET1^DIQ(702,MDIEN,.09,"I") I 'MDMULT&("13"[MDST) Q "-1^Study not in proper status"
"RTN","MDRPCOT1",60,0)
 I MDMULT&(MDST=1) Q "-1^Study not in proper status"
"RTN","MDRPCOT1",61,0)
 I MDMULT&(MDST=3) D STATUS^MDRPCOT(MDIENS,5,"")
"RTN","MDRPCOT1",62,0)
 D DELERR(+MDIEN)
"RTN","MDRPCOT1",63,0)
 I $$GET1^DIQ(702,MDIEN,.01)="" Q "-1^No Entry in file (#702)."
"RTN","MDRPCOT1",64,0)
 D NOW^%DTC S MDDT=%
"RTN","MDRPCOT1",65,0)
 S MDMAG("IDFN")=+$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT1",66,0)
 I 'MDMAG("IDFN") Q "-1^No Patient DFN."
"RTN","MDRPCOT1",67,0)
 S MDMAG("PXPKG")=8925
"RTN","MDRPCOT1",68,0)
 S MDMAG("PXIEN")=+$$GET1^DIQ(702,MDIEN,.06,"I")
"RTN","MDRPCOT1",69,0)
 I 'MDMAG("PXIEN") Q "-1^No TIU IEN"
"RTN","MDRPCOT1",70,0)
 I '$O(^MDD(702,MDIEN,.1,0)) D  Q $S(+MDR<0:MDR,1:"3^Transaction Complete")
"RTN","MDRPCOT1",71,0)
 .S MDC=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT1",72,0)
 .S MDR=$$UPDCONS(MDC,MDMAG("PXIEN"))
"RTN","MDRPCOT1",73,0)
 S MDMAG("STSCB")="ISTAT^MDAPI"
"RTN","MDRPCOT1",74,0)
 S MDMAG("TRKID")="CP;"_MDIEN_"-"_MDDT
"RTN","MDRPCOT1",75,0)
 S MDLOC=$$GET1^DIQ(702,MDIEN,.07,"I"),MDLOC=$P(MDLOC,";",3)
"RTN","MDRPCOT1",76,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT1",77,0)
 S MDMAG("ACQS")=$S(+$$GET1^DIQ(44,MDLOC_",",3,"I"):+$$GET1^DIQ(44,MDLOC_",",3,"I"),1:+$G(DUZ(2)))
"RTN","MDRPCOT1",78,0)
 S MDMAG("ACQL")=MDLOC
"RTN","MDRPCOT1",79,0)
 S MDX=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT1",80,0)
 S MDZ=$P(^MDS(702.01,+MDX,0),"^",1)
"RTN","MDRPCOT1",81,0)
 S (MDACQ,MDX,MDDEL)="",MDCTR=0
"RTN","MDRPCOT1",82,0)
 N MDTOT S MDTOT=$$GET1^DIQ(702,MDIENS,.991)
"RTN","MDRPCOT1",83,0)
 S MDL=0 F  S MDL=$O(^MDD(702,MDIEN,.1,MDL)) Q:MDL<1  S MDX=$G(^(MDL,0)) D
"RTN","MDRPCOT1",84,0)
 .S:'MDDEL MDDEL=$P(MDX,"^",3)
"RTN","MDRPCOT1",85,0)
 .S MDY=$G(^MDD(702,MDIEN,.1,MDL,.1)) Q:MDY=""
"RTN","MDRPCOT1",86,0)
 .S:MDACQ="" MDACQ=$P($P(MDY,"\\",2),"\")
"RTN","MDRPCOT1",87,0)
 .S:"12"[$P(MDX,"^",9) $P(MDX,"^",9)=""
"RTN","MDRPCOT1",88,0)
 .I $P(MDX,"^",9)="" S MDCTR=MDCTR+1,MDARR(MDCTR)=MDY_"^"_MDZ_" image "_MDCTR_" out of "_MDTOT
"RTN","MDRPCOT1",89,0)
 .Q
"RTN","MDRPCOT1",90,0)
 I '$O(MDARR(0)) Q "-1^No UNC."
"RTN","MDRPCOT1",91,0)
 S MDMAG("GDESC")=MDZ_" Result"
"RTN","MDRPCOT1",92,0)
 I MDDEL S MDY=$P($G(^MDD(703.1,+MDDEL,0)),"^",3,4),MDMAG("PXDT")=$P(MDY,"^",1),MDY=+$P(MDY,"^",2),MDMAG("ACQD")=$P($G(^MDS(702.09,+MDY,0)),"^"),MDMAG("DFLG")=+$P($G(^MDS(702.09,+MDY,0)),"^",5)
"RTN","MDRPCOT1",93,0)
 S:$G(MDMAG("ACQD"))="" MDMAG("ACQD")=MDACQ
"RTN","MDRPCOT1",94,0)
 S:'$G(MDMAG("PXDT")) MDMAG("PXDT")=MDDT ; If no date, use NOW in MDDT
"RTN","MDRPCOT1",95,0)
 S MDMAG("TRTYPE")="NEW"
"RTN","MDRPCOT1",96,0)
 D IMPORT^MAGGSIUI(.MDIMG,.MDARR,.MDMAG)
"RTN","MDRPCOT1",97,0)
 I '(+$G(MDIMG(0))) D  Q "-1^"_$P(MDIMG(0),"^",2)
"RTN","MDRPCOT1",98,0)
 .D IMGSTAT(+MDIENS,1)
"RTN","MDRPCOT1",99,0)
 .F MDAR=0:0 S MDAR=$O(MDIMG(MDAR)) Q:'MDAR  I $G(MDIMG(MDAR))'="" D
"RTN","MDRPCOT1",100,0)
 ..S DATA("MESSAGE")=$$TRANS^MDAPI(MDIMG(MDAR)) D ADDMSG^MDRPCOT
"RTN","MDRPCOT1",101,0)
 D IMGSTAT(+MDIENS,0)
"RTN","MDRPCOT1",102,0)
 Q "1^Images Submitted"
"RTN","MDRPCOT1",103,0)
 ;
"RTN","MDRPCOT1",104,0)
UPDCONS(MDC,MDDOC) ; [Function] Update Consults Procedure Status
"RTN","MDRPCOT1",105,0)
 N MDCRES
"RTN","MDRPCOT1",106,0)
 S MDCRES=$$CPDOC^GMRCCP(MDC,MDDOC,2)
"RTN","MDRPCOT1",107,0)
 I '(+MDCRES) Q "-1^"_$P(MDCRES,"^",2)
"RTN","MDRPCOT1",108,0)
 Q 1
"RTN","MDRPCOT1",109,0)
 ;
"RTN","MDRPCOT1",110,0)
GETIORD(MDIEN) ; [Function] Return the Instrument order number for this study
"RTN","MDRPCOT1",111,0)
 ; Called from instrument interface routines
"RTN","MDRPCOT1",112,0)
 Q:'$D(^MDD(702,MDIEN,0))#2 -1  ; No such study
"RTN","MDRPCOT1",113,0)
 Q:'$P(^MDD(702,MDIEN,0),U,12) $$NEWIORD(MDIEN)  ; Create a new one
"RTN","MDRPCOT1",114,0)
 Q $P(^MDD(702,MDIEN,0),U,12)  ; Return the existing one
"RTN","MDRPCOT1",115,0)
 ;
"RTN","MDRPCOT1",116,0)
NEWIORD(MDIEN) ; [Function] Generate & return new unique instrument order number
"RTN","MDRPCOT1",117,0)
 ; Notice: will overwrite existing order number if it exists
"RTN","MDRPCOT1",118,0)
 N MDFDA
"RTN","MDRPCOT1",119,0)
 Q:'$D(^MDD(702,MDIEN,0))#2 -1  ; No such study
"RTN","MDRPCOT1",120,0)
 L +^MDD(702,"AION"):15 E  Q -1  ; Unable to lock and guarantee uniqueness
"RTN","MDRPCOT1",121,0)
 F  D  Q:'$D(^MDD(702,"AION",X))  H 1  ; Loop until unique
"RTN","MDRPCOT1",122,0)
 . S X=$$NOW^XLFDT() ; Current DateTime
"RTN","MDRPCOT1",123,0)
 . S X=$TR($J(X,14,6),".","") ; Pad with 0's and strip the decimal
"RTN","MDRPCOT1",124,0)
 . Q
"RTN","MDRPCOT1",125,0)
 I $E($G(^MDS(702.09,DEVIEN,0)),1,4)="Muse" D
"RTN","MDRPCOT1",126,0)
 . ; Due to current limitation to the Muse can only except 9
"RTN","MDRPCOT1",127,0)
 . S X=$E($TR($H,",",""),2,10) ; Using $E($H) only for the MUSE
"RTN","MDRPCOT1",128,0)
 . I '$D(^MDD(702,"AION",X)) Q  ; It is unique and quit
"RTN","MDRPCOT1",129,0)
 . N I,FLG ; Not unique
"RTN","MDRPCOT1",130,0)
 . S FLG=0
"RTN","MDRPCOT1",131,0)
 . F I=1:1 D  Q:FLG
"RTN","MDRPCOT1",132,0)
 . . S X=X+1
"RTN","MDRPCOT1",133,0)
 . . I '$D(^MDD(702,"AION",X)) S FLG=1
"RTN","MDRPCOT1",134,0)
 . . Q
"RTN","MDRPCOT1",135,0)
 . Q
"RTN","MDRPCOT1",136,0)
 S MDFDA(702,MDIEN_",",.12)=X  ; Build FDA
"RTN","MDRPCOT1",137,0)
 D FILE^DIE("","MDFDA")  ; File it
"RTN","MDRPCOT1",138,0)
 L -(^MDD(702,"AION"))  ; Unlock it
"RTN","MDRPCOT1",139,0)
 Q $P(^MDD(702,MDIEN,0),U,12)  ; Return it from the file
"RTN","MDRPCOT1",140,0)
GETSTDY(MDION) ; [Function] Return study from instrument order number
"RTN","MDRPCOT1",141,0)
 ; Called from instrument interface routines
"RTN","MDRPCOT1",142,0)
 Q:'$D(^MDD(702,"AION",MDION)) -1  ; No such order number
"RTN","MDRPCOT1",143,0)
 Q $O(^MDD(702,"AION",MDION,""))  ; Return the 702 ien
"RTN","MDRPCOT1",144,0)
 ;
"RTN","MDRPCOT1",145,0)
MULT(MDIN) ; [Function] Return whether result is mulitple or final
"RTN","MDRPCOT1",146,0)
 N MDDEF
"RTN","MDRPCOT1",147,0)
 S MDDEF=+$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT1",148,0)
 I 'MDDEF Q 0
"RTN","MDRPCOT1",149,0)
 Q +$$GET1^DIQ(702.01,MDDEF,.12,"I")
"RTN","MDWCAN")
0^12^B16228241^n/a
"RTN","MDWCAN",1,0)
MDWCAN ;HOIFO/NCA - Process No-Shows and Cancels ;7/29/08  09:50
"RTN","MDWCAN",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11**;Apr 01, 2004;Build 67
"RTN","MDWCAN",3,0)
 ; Reference IA #2263 [Supported] Call to ^XPAR
"RTN","MDWCAN",4,0)
 ;              #4433 [Supported] Call to SDAPI^SDAMA301
"RTN","MDWCAN",5,0)
 ;              #10103 [Supported] XLFDT call
"RTN","MDWCAN",6,0)
EN1 ; Check for No-Shows and Cancels
"RTN","MDWCAN",7,0)
 N MDARRAY,MDAPAT,MDAPPT,MDCHECK,MDALOC,MDCL,MDCOUNT,MDCLIEN,MDDFN,MDDATE,MDAPPT,MDK,MDLP1,MDLP2,MDLST,MDLIST,MDFIN,MDND,MDSTUDY,MDVST,MDXX,MDY,X1,X2
"RTN","MDWCAN",8,0)
 S X1=DT,X2=-1 D C^%DTC S MDDATE=X K ^TMP("MDAP",$J),^TMP("MDCAN",$J),^TMP("MDPLST",$J),MDALOC S MDFIN=DT+.24
"RTN","MDWCAN",9,0)
 D GETLST^XPAR(.MDLIST,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWCAN",10,0)
 F MDK=0:0 S MDK=$O(MDLIST(MDK)) Q:MDK<1  S MDND=$P($G(MDLIST(MDK)),"^",2) I +$P(MDND,";",2) S MDCL=+MDND D
"RTN","MDWCAN",11,0)
 .S:$G(MDALOC(+MDCL))="" MDALOC(+MDCL)=+MDCL
"RTN","MDWCAN",12,0)
 .S ^TMP("MDPLST",$J,+MDCL,+$P(MDND,";",2))=+$P(MDND,";",2)
"RTN","MDWCAN",13,0)
 .Q
"RTN","MDWCAN",14,0)
 S MDLP1=DT F  S MDLP1=$O(^MDD(702,"ASD",MDLP1)) Q:MDLP1<1!(MDLP1>MDFIN)  F MDLP2=0:0 S MDLP2=$O(^MDD(702,"ASD",MDLP1,MDLP2)) Q:MDLP2<1  D
"RTN","MDWCAN",15,0)
 .S MDXX=$G(^MDD(702,MDLP2,0))
"RTN","MDWCAN",16,0)
 .Q:$P(MDXX,"^",9)'=5
"RTN","MDWCAN",17,0)
 .Q:'+MDXX
"RTN","MDWCAN",18,0)
 .I $G(^TMP("MDAP",$J,+MDXX))="" S ^TMP("MDAP",$J,+MDXX)=+MDXX
"RTN","MDWCAN",19,0)
 .Q
"RTN","MDWCAN",20,0)
 F MDLP1=0:0 S MDLP1=$O(^MDD(702,"AS",0,MDLP1)) Q:MDLP1<1  D
"RTN","MDWCAN",21,0)
 .S MDXX=$G(^MDD(702,MDLP1,0))
"RTN","MDWCAN",22,0)
 .Q:$P(MDXX,"^",9)>0
"RTN","MDWCAN",23,0)
 .Q:'+$P(MDXX,"^",5)!($P(MDXX,"^",6)'="")
"RTN","MDWCAN",24,0)
 .Q:'+MDXX
"RTN","MDWCAN",25,0)
 .I $G(^TMP("MDAP",$J,+MDXX))="" S ^TMP("MDAP",$J,+MDXX)=+MDXX
"RTN","MDWCAN",26,0)
 .I '+$G(^TMP("MDCAN",$J,0,+MDXX,+$P(MDXX,"^",4))) S ^TMP("MDCAN",$J,0,+MDXX,+$P(MDXX,"^",4))=MDLP1
"RTN","MDWCAN",27,0)
 .Q
"RTN","MDWCAN",28,0)
 F MDK=0:0 S MDK=$O(^TMP("MDAP",$J,MDK)) Q:MDK<1  D
"RTN","MDWCAN",29,0)
 .K ^TMP($J,"SDAMA301") S MDXX=MDK,MDARRAY(1)=MDDATE_";"_DT
"RTN","MDWCAN",30,0)
 .S MDARRAY(2)="MDALOC("
"RTN","MDWCAN",31,0)
 .S MDARRAY(3)="NS;NSR;CP;CPR;CC;CCR",MDARRAY(4)=+MDXX,MDARRAY("FLDS")="1;3;4;25"
"RTN","MDWCAN",32,0)
 .S MDCOUNT=$$SDAPI^SDAMA301(.MDARRAY)
"RTN","MDWCAN",33,0)
 .I MDCOUNT>0 D
"RTN","MDWCAN",34,0)
 ..S MDCL=0 F  S MDCL=$O(^TMP($J,"SDAMA301",+MDXX,MDCL)) Q:MDCL<1  S MDCLIEN=0 F  S MDCLIEN=$O(^TMP($J,"SDAMA301",+MDXX,+MDCL,MDCLIEN)) Q:MDCLIEN<1  D
"RTN","MDWCAN",35,0)
 ...S MDAPPT=$G(^TMP($J,"SDAMA301",+MDXX,+MDCL,MDCLIEN))
"RTN","MDWCAN",36,0)
 ...Q:$P(MDAPPT,"^",3)=""
"RTN","MDWCAN",37,0)
 ...Q:+$P(MDAPPT,"^",4)'=+MDXX
"RTN","MDWCAN",38,0)
 ...Q:$P(MDAPPT,"^",1)=""
"RTN","MDWCAN",39,0)
 ...S MDSTUDY=$$GSTUDY(+MDXX,$P(MDAPPT,"^",1),+MDCL) Q:'MDSTUDY
"RTN","MDWCAN",40,0)
 ...I $G(^MDD(702,+MDSTUDY,3))="" K MDFDA S MDFDA(702,+MDSTUDY_",",.14)=$P(MDAPPT,"^",1) D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDWCAN",41,0)
 ...D PURG(+MDSTUDY) Q
"RTN","MDWCAN",42,0)
 ..Q
"RTN","MDWCAN",43,0)
 .Q
"RTN","MDWCAN",44,0)
 K ^TMP($J,"SDAMA301"),^TMP("MDAP",$J),^TMP("MDCAN",$J),^TMP("MDPLST",$J),MDAPAT,MDALOC
"RTN","MDWCAN",45,0)
 Q
"RTN","MDWCAN",46,0)
GSTUDY(MDPAT,MDDA,MDACL) ;Get study for scheduled date/time
"RTN","MDWCAN",47,0)
 N MDDONE,MDIN,MDN,MDV,Y1 S (MDDONE,Y1)=0
"RTN","MDWCAN",48,0)
 F MDIN=0:0 S MDIN=$O(^MDD(702,"ASD",MDDA,MDIN)) Q:MDIN<1!(Y1>0)!(MDDONE=1)  D
"RTN","MDWCAN",49,0)
 .I $P($G(^MDD(702,MDIN,0)),"^")=MDPAT D
"RTN","MDWCAN",50,0)
 ..S MDN=$G(^MDD(702,MDIN,0)),MDV=$P(MDN,"^",7)
"RTN","MDWCAN",51,0)
 ..I $P(MDV,";",3)'=""&($P(MDV,";",3)'=MDACL) Q
"RTN","MDWCAN",52,0)
 ..S:$P(MDN,"^",9)'=6 Y1=MDIN S:$P(MDN,"^",9)=6 MDDONE=1
"RTN","MDWCAN",53,0)
 ..Q
"RTN","MDWCAN",54,0)
 I +Y1>0 Q Y1
"RTN","MDWCAN",55,0)
 I +MDDONE>0 Q Y1
"RTN","MDWCAN",56,0)
 F MDIN=0:0 S MDIN=$O(^TMP("MDCAN",$J,0,MDPAT,MDIN)) Q:MDIN<1!(Y1>0)  D
"RTN","MDWCAN",57,0)
 .I +$G(^TMP("MDPLST",$J,MDACL,MDIN)) S Y1=+$G(^TMP("MDCAN",$J,0,MDPAT,MDIN))
"RTN","MDWCAN",58,0)
 Q Y1
"RTN","MDWCAN",59,0)
PURG(MDI) ; [Procedure] Delete Study
"RTN","MDWCAN",60,0)
 N MDAST,MDCANR,MDERR,MDFDA,MDHOLD,MDNOTE,MDRES,MDSIEN,BODY,SUBJECT,DEVIEN,MDORD
"RTN","MDWCAN",61,0)
 S (MDHOLD,MDSIEN)=+MDI,MDRES=0,MDNOTE=""
"RTN","MDWCAN",62,0)
 ;D ALERT^MDHL7U3(MDSIEN) ; Builds the body of the mail message
"RTN","MDWCAN",63,0)
 I $G(^MDD(702,+MDSIEN,0))="" Q
"RTN","MDWCAN",64,0)
 S:+$P(^MDD(702,+MDSIEN,0),U,6) MDNOTE=$P(^MDD(702,MDSIEN,0),U,6)
"RTN","MDWCAN",65,0)
 S MDCANR=$$CANCEL^MDHL7B(MDHOLD) I +MDCANR<1 Q
"RTN","MDWCAN",66,0)
 Q:+MDNOTE
"RTN","MDWCAN",67,0)
 S MDAST=$$HL7CHK^MDHL7U3(+MDSIEN) I +MDAST<1 Q
"RTN","MDWCAN",68,0)
 ;D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) ; delete message
"RTN","MDWCAN",69,0)
 ;S MDFDA(702,DATA_",",.01)=""
"RTN","MDWCAN",70,0)
 ; Check for renal study to cancel as well
"RTN","MDWCAN",71,0)
 I $D(^MDK(704.202,+MDI)) K MDFDA S MDFDA(704.202,+MDI_",",.09)=0 D FILE^DIE("","MDFDA")
"RTN","MDWCAN",72,0)
 K MDFDA
"RTN","MDWCAN",73,0)
 S MDFDA(702,+MDI_",",.07)=""
"RTN","MDWCAN",74,0)
 S MDFDA(702,+MDI_",",.09)=6
"RTN","MDWCAN",75,0)
 D FILE^DIE("","MDFDA")
"RTN","MDWCAN",76,0)
 S MDORD=+$P($G(^MDD(702,+MDI,0)),"^",12) I +MDORD K ^MDD(702,"AION",+MDORD,+MDI)
"RTN","MDWCAN",77,0)
 ;N DA,DIK S DA=+MDSIEN,DIK="^MDD(702," D ^DIK
"RTN","MDWCAN",78,0)
 K MDFDA
"RTN","MDWCAN",79,0)
 S MDFDA(702,"+1,",.01)=$P($G(^MDD(702,+MDI,0)),"^")
"RTN","MDWCAN",80,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWCAN",81,0)
 S MDFDA(702,"+1,",.03)=$P($G(^MDD(702,+MDI,0)),"^",3)
"RTN","MDWCAN",82,0)
 S MDFDA(702,"+1,",.04)=$P($G(^MDD(702,+MDI,0)),"^",4)
"RTN","MDWCAN",83,0)
 S MDFDA(702,"+1,",.05)=$P($G(^MDD(702,+MDI,0)),"^",5)
"RTN","MDWCAN",84,0)
 S MDFDA(702,"+1,",.09)=0
"RTN","MDWCAN",85,0)
 S MDFDA(702,"+1,",.11)=$P($G(^MDD(702,+MDI,0)),"^",11)
"RTN","MDWCAN",86,0)
 D UPDATE^DIE("","MDFDA","","MDERR") K MDFDA
"RTN","MDWCAN",87,0)
 Q
"RTN","MDWOR")
0^14^B40687442^B34141861
"RTN","MDWOR",1,0)
MDWOR ; HOIFO/NCA - Main Routine to Decode HL7 ;9/8/08  15:20
"RTN","MDWOR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11**;Apr 01,2004;Build 67
"RTN","MDWOR",3,0)
 ; Reference IA# 2263 [Supported] XPAR calls
"RTN","MDWOR",4,0)
 ;               3468 [Subscription] Call GMRCCP.
"RTN","MDWOR",5,0)
 ;               3071 [Subscription] Call $$PKGID^ORX8.
"RTN","MDWOR",6,0)
 ;              10035 [Supported] Access DPT("B"
"RTN","MDWOR",7,0)
 ;              10040 [Supported] Access SC(
"RTN","MDWOR",8,0)
 ;              10061 [Supported] VADPT call
"RTN","MDWOR",9,0)
 ;              10103 [Supported] XLFDT calls
"RTN","MDWOR",10,0)
EN(MDMSG) ; Entry Point for CPRS and pass MSG in MDMSG
"RTN","MDWOR",11,0)
 N DFN,MDCON,MDCPROC,MDCANC,MDCANR,MDFN,MDIFN,MDINST,MDINT,MDFLG,MDL,MDIN,MDINP,MDINST,MDLOC,MDNAM,MDOBC,MDOBX,MDOPRO,MDPROC,MDPAT
"RTN","MDWOR",12,0)
 N MDLL,MDK1,MDPROV,MDREQ,MDQTIM,MDROOT,MDRR,MDSINP,MDVSTD,MDX S MDVSTD=""
"RTN","MDWOR",13,0)
 S (MDINP,MDFLG,MDCANC,MDOBC)=0 F MDL=0:0 S MDL=$O(MDMSG(MDL)) Q:MDL<1!(MDFLG)  S MDX=$G(MDMSG(MDL)) D
"RTN","MDWOR",14,0)
 .I $E(MDX,1,3)="MSH" D MSH Q
"RTN","MDWOR",15,0)
 .I $E(MDX,1,3)="PID" D PID Q
"RTN","MDWOR",16,0)
 .I $E(MDX,1,3)="PV1" D PV1 Q
"RTN","MDWOR",17,0)
 .I $E(MDX,1,3)="ORC" D ORC Q
"RTN","MDWOR",18,0)
 .I $E(MDX,1,3)="OBR" D OBR Q
"RTN","MDWOR",19,0)
 .I $E(MDX,1,3)="OBX" D:MDOBC<1 OBX Q
"RTN","MDWOR",20,0)
 .Q
"RTN","MDWOR",21,0)
 D GETLST^XPAR(.MDLL,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWOR",22,0)
 I 'MDFLG,'MDCANC,MDVSTD="" F MDK1=0:0 S MDK1=$O(MDLL(MDK1)) Q:MDK1<1  S MDROOT=$G(MDLL(MDK1)) I +$P(MDROOT,";",2)=MDPROC D  Q:+MDRR
"RTN","MDWOR",23,0)
 .S MDRR=0,MDIFN=MDFN,MDRR=$$GETAPPT(MDIFN,+$P(MDROOT,"^",2))
"RTN","MDWOR",24,0)
 .S:+MDRR MDVSTD="A"_";"_$P(MDRR,"^",1)_";"_+$P(MDROOT,"^",2)
"RTN","MDWOR",25,0)
 I 'MDFLG,'MDCANC S MDATA="+1,^"_MDPROC_"^"_+MDCON_"^"_MDINST_"^"_MDVSTD D CHKIN(MDFN,MDREQ,MDPROV,MDATA,MDVSTD)
"RTN","MDWOR",26,0)
 Q
"RTN","MDWOR",27,0)
MSH ; Decode MSH
"RTN","MDWOR",28,0)
 I $P(MDX,"|",2)'="^~\&" S MDFLG=1 Q
"RTN","MDWOR",29,0)
 I $P(MDX,"|",3)'="ORDER ENTRY" S MDFLG=1 Q
"RTN","MDWOR",30,0)
 I $P(MDX,"|",9)'="ORM" S MDFLG=1 Q
"RTN","MDWOR",31,0)
 Q
"RTN","MDWOR",32,0)
PID ; Check PID
"RTN","MDWOR",33,0)
 S MDNAM=$P(MDX,"|",6),DFN=$P(MDX,"|",4)
"RTN","MDWOR",34,0)
 I '$D(^DPT("B",$E(MDNAM,1,30),DFN)) S MDFLG=1
"RTN","MDWOR",35,0)
 S MDFN=DFN
"RTN","MDWOR",36,0)
 Q
"RTN","MDWOR",37,0)
PV1 ; Check PV1
"RTN","MDWOR",38,0)
 S MDPAT=$P(MDX,"|",3) I MDPAT'?1U!("IO"'[MDPAT) S MDFLG=1 Q
"RTN","MDWOR",39,0)
 I MDPAT="I" S MDINP=1
"RTN","MDWOR",40,0)
 S MDLOC=+$P(MDX,"|",4) I $G(^SC(MDLOC,0))="" S MDFLG=1 Q
"RTN","MDWOR",41,0)
 S:MDINP>0 MDLOC=""
"RTN","MDWOR",42,0)
 Q
"RTN","MDWOR",43,0)
ORC ; Check ORC
"RTN","MDWOR",44,0)
 I $P(MDX,"|",2)="NW" D NEW Q
"RTN","MDWOR",45,0)
 I $P(MDX,"|",2)="DC" D CANCEL Q
"RTN","MDWOR",46,0)
 S MDFLG=1
"RTN","MDWOR",47,0)
 Q
"RTN","MDWOR",48,0)
OBX ; Check OBX
"RTN","MDWOR",49,0)
 N %,ANSWER,MDCV,MDOBX
"RTN","MDWOR",50,0)
 S MDOBX=$P(MDX,"|",6)
"RTN","MDWOR",51,0)
 I '+$$GET^XPAR("SYS","MD USE APPT WITH PROCEDURE",1) S MDOBC=MDOBC+1 Q
"RTN","MDWOR",52,0)
 S MDVSTD=$P(MDOBX,"Visit Date: ",2)
"RTN","MDWOR",53,0)
 S MDCV=$P(MDVSTD," ",1,2)
"RTN","MDWOR",54,0)
 I MDCV=""!(MDCV["UNKNOWN") S MDFLG=1 Q
"RTN","MDWOR",55,0)
 S MDVSTD=$P(MDCV," ")_"@"_$P(MDCV," ",2)
"RTN","MDWOR",56,0)
 D DT^DILF("T",MDVSTD,.ANSWER)
"RTN","MDWOR",57,0)
 S:ANSWER<0 ANSWER=""
"RTN","MDWOR",58,0)
 S MDVSTD=ANSWER I MDVSTD="" S MDFLG=1 Q
"RTN","MDWOR",59,0)
 I +MDLOC>0 S MDVSTD="A;"_MDVSTD_";"_MDLOC
"RTN","MDWOR",60,0)
 E  D NOW^%DTC S MDVSTD=%
"RTN","MDWOR",61,0)
 S MDOBC=MDOBC+1
"RTN","MDWOR",62,0)
 Q
"RTN","MDWOR",63,0)
NEW ; New Order Segment
"RTN","MDWOR",64,0)
 S MDIFN=+$P(MDX,"|",3) I 'MDIFN S MDFLG=1 Q
"RTN","MDWOR",65,0)
 S MDPROV=+$P(MDX,"|",11) I 'MDPROV S MDFLG=1 Q
"RTN","MDWOR",66,0)
 S MDQTIM=$P(MDX,"|",8),MDQTIM=$P(MDQTIM,"^",6)
"RTN","MDWOR",67,0)
 S MDREQ=$P(MDX,"|",16) S MDREQ=$$FMDTE(MDREQ) I 'MDREQ S MDFLG=1 Q
"RTN","MDWOR",68,0)
 S MDREQ=$S(MDQTIM="Z24":$$FMADD^XLFDT(MDREQ,0,24),MDQTIM="Z48":$$FMADD^XLFDT(MDREQ,0,48),MDQTIM="Z72":$$FMADD^XLFDT(MDREQ,0,72),MDQTIM="ZW":$$FMADD^XLFDT(MDREQ,7),MDQTIM="ZM":$$FMADD^XLFDT(MDREQ,30),1:MDREQ)
"RTN","MDWOR",69,0)
 ; Retrieve Consult Number
"RTN","MDWOR",70,0)
 N MDFDA
"RTN","MDWOR",71,0)
 S MDCON=$$PKGID^ORX8(MDIFN) I 'MDCON S MDFLG=1 Q
"RTN","MDWOR",72,0)
 Q
"RTN","MDWOR",73,0)
OBR ; Check OBR
"RTN","MDWOR",74,0)
 S MDPROC=$P(MDX,"|",5)
"RTN","MDWOR",75,0)
 I $E($P(MDPROC,"^",6),3,5)'["PRC" S MDFLG=1 Q
"RTN","MDWOR",76,0)
 S MDCPROC=$P(MDPROC,"^",4) I 'MDCPROC S MDFLG=1 Q
"RTN","MDWOR",77,0)
 ; Get Procedure for CP IEN
"RTN","MDWOR",78,0)
 S MDPROC=$$CPROC^GMRCCP(MDCPROC) I 'MDPROC S MDFLG=1 Q
"RTN","MDWOR",79,0)
 S MDSINP=$$HIGHV(MDPROC) I '+MDSINP S MDFLG=1 Q
"RTN","MDWOR",80,0)
 S (MDINST,MDINT)=0 F MDIN=0:0 S MDIN=$O(^MDS(702.01,MDPROC,.1,MDIN)) Q:MDIN<1!(+MDINST)  S MDINT=+$G(^(MDIN,0)) D
"RTN","MDWOR",81,0)
 .I +$$GET1^DIQ(702.09,+MDINT,".13","I") S MDINST=MDINT Q
"RTN","MDWOR",82,0)
 I +$P(MDSINP,"^",2)=2 D  Q
"RTN","MDWOR",83,0)
 .I +MDINP S MDVSTD="",MDOBC=MDOBC+1 Q
"RTN","MDWOR",84,0)
 .S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",85,0)
 I +$P(MDSINP,"^",2)=3 D  Q
"RTN","MDWOR",86,0)
 .I +MDINP S MDVSTD="",MDOBC=MDOBC+1 Q
"RTN","MDWOR",87,0)
 I +$P(MDSINP,"^",2)=1 D  Q
"RTN","MDWOR",88,0)
 .I '+MDINP S MDVSTD="" Q
"RTN","MDWOR",89,0)
 .S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",90,0)
 I +MDINP&('$P(^MDS(702.01,MDPROC,0),"^",5)) S MDFLG=1 Q
"RTN","MDWOR",91,0)
 I +MDINP S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",92,0)
 S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",93,0)
 Q
"RTN","MDWOR",94,0)
CANCEL ; Cancel/Discontinue
"RTN","MDWOR",95,0)
 K MDR S MDIFN=+$P(MDX,"|",3),MDCON=+$P(MDX,"|",4),MDCANC=1
"RTN","MDWOR",96,0)
 I 'MDIFN S MDFLG=1 Q
"RTN","MDWOR",97,0)
 I 'MDCON S MDFLG=1 Q
"RTN","MDWOR",98,0)
 S MDPROV=+$P(MDX,"|",13) I 'MDPROV S MDFLG=1 Q
"RTN","MDWOR",99,0)
 S MDREQ=$P(MDX,"|",16) I 'MDREQ S MDFLG=1 Q
"RTN","MDWOR",100,0)
 S MDINST=$O(^MDD(702,"ACON",MDCON,0)) Q:'MDINST
"RTN","MDWOR",101,0)
 Q:$G(^MDD(702,+MDINST,0))=""
"RTN","MDWOR",102,0)
 I "5"[$P(^MDD(702,+MDINST,0),U,9) S MDCANR=$$CANCEL^MDHL7B(+MDINST)
"RTN","MDWOR",103,0)
 N MDFDA S MDFDA(702,MDINST_",",.09)=6
"RTN","MDWOR",104,0)
 D FILE^DIE("K","MDFDA") K MDFDA
"RTN","MDWOR",105,0)
 N MDHEMO S MDHEMO=+$$GET1^DIQ(702,+MDINST,".04:.06","I")
"RTN","MDWOR",106,0)
 Q:MDHEMO<2
"RTN","MDWOR",107,0)
 Q:$G(^MDK(704.202,+MDINST,0))=""
"RTN","MDWOR",108,0)
 S MDFDA(704.202,+MDINST_",",.09)=0
"RTN","MDWOR",109,0)
 D FILE^DIE("","MDFDA")
"RTN","MDWOR",110,0)
 K ^MDK(704.202,"AS",1,+MDINST)
"RTN","MDWOR",111,0)
 S ^MDK(704.202,"AS",0,+MDINST)=""
"RTN","MDWOR",112,0)
 Q
"RTN","MDWOR",113,0)
CHKIN(MDFN,MDREQ,MDPROV,MDATA,MDVSTD) ; [Procedure] Check In Study
"RTN","MDWOR",114,0)
 N MDX1,MDFDA,MDIEN,MDIENS,MDERR,MDHL7,MDHOLD,MDSCHD,MDMAXD,MDXY,MDNOW
"RTN","MDWOR",115,0)
 F MDX1=2:1:5 D
"RTN","MDWOR",116,0)
 .I $P(MDATA,U,MDX1)]"" S MDFDA(702,$P(MDATA,U,1),$P("^.04^.05^.11^.07",U,MDX1))=$P(MDATA,U,MDX1)
"RTN","MDWOR",117,0)
 ; Remove code after instrument testing available
"RTN","MDWOR",118,0)
 ; End of code removal after instrument available for testin
"RTN","MDWOR",119,0)
 S MDSCHD=$S($L(MDVSTD,";")=1:MDVSTD,1:$P(MDVSTD,";",2)),MDMAXD=DT+.24
"RTN","MDWOR",120,0)
 S MDFDA(702,$P(MDATA,U,1),.09)=$S(MDSCHD="":0,MDSCHD>MDMAXD:0,1:5)  ; Status = Checked-In
"RTN","MDWOR",121,0)
 I $P(MDATA,U,1)="+1," D
"RTN","MDWOR",122,0)
 .S MDFDA(702,"+1,",.01)=MDFN
"RTN","MDWOR",123,0)
 .S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWOR",124,0)
 .S MDFDA(702,"+1,",.03)=MDPROV
"RTN","MDWOR",125,0)
 .S:+MDSCHD MDFDA(702,"+1,",.14)=MDSCHD
"RTN","MDWOR",126,0)
 .D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)
"RTN","MDWOR",127,0)
 .Q:MDSCHD>MDMAXD!(MDSCHD="")
"RTN","MDWOR",128,0)
 .S MDIENS=MDIEN(1)_",",MDXY=+$P(MDATA,U,2),MDHOLD="" I +MDXY D
"RTN","MDWOR",129,0)
 ..Q:$P(^MDS(702.01,MDXY,0),U,6)'=2
"RTN","MDWOR",130,0)
 ..S MDHOLD=$P($G(^MDD(702,MDIEN(1),0)),"^",7),MDNOW=$$NOW^XLFDT()
"RTN","MDWOR",131,0)
 ..S $P(^MDD(702,MDIEN(1),0),"^",7)=$S(MDNOW>MDSCHD:MDSCHD,1:MDNOW)
"RTN","MDWOR",132,0)
 .S MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDWOR",133,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWOR",134,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWOR",135,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWOR",136,0)
 Q:MDSCHD>MDMAXD!(MDSCHD="")
"RTN","MDWOR",137,0)
 D:+$G(MDIENS)
"RTN","MDWOR",138,0)
 .S MDXY=+$P(MDATA,U,2) Q:'MDXY
"RTN","MDWOR",139,0)
 .I $P(^MDS(702.01,MDXY,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDWOR",140,0)
 ..D CP^MDKUTL(+MDIENS)
"RTN","MDWOR",141,0)
 ..S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD
"RTN","MDWOR",142,0)
 ..S MDFDA(702,+MDIENS_",",.09)=5
"RTN","MDWOR",143,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWOR",144,0)
 Q
"RTN","MDWOR",145,0)
FMDTE(DATE) ; Convert HL-7 formatted date to a Fileman formatted date
"RTN","MDWOR",146,0)
 N X
"RTN","MDWOR",147,0)
 S X="" I DATE D
"RTN","MDWOR",148,0)
 .S X=$$HL7TFM^XLFDT(DATE,"L")
"RTN","MDWOR",149,0)
 Q X
"RTN","MDWOR",150,0)
HIGHV(MDHV) ; Return flag indicator whether procedure is use for auto check-in
"RTN","MDWOR",151,0)
 N MDANS,MDK,MDKY,MDLST S MDANS=0
"RTN","MDWOR",152,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CHECK-IN PROCEDURE LIST")
"RTN","MDWOR",153,0)
 F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDKY=$G(MDLST(MDK)) D
"RTN","MDWOR",154,0)
 .I MDHV=+$P(MDKY,"^") S MDANS=MDKY
"RTN","MDWOR",155,0)
 Q MDANS
"RTN","MDWOR",156,0)
GETAPPT(MDDPAT,MDDA) ; Get appointment
"RTN","MDWOR",157,0)
 N DFN,MDALP,MDARES K ^UTILITY("VASD",$J) S DFN=MDDPAT
"RTN","MDWOR",158,0)
 S X1=DT,X2=365 D C^%DTC S VASD("T")=X+.24,VASD("F")=DT,VASD("W")="129",VASD("C",+MDDA)=+MDDA D SDA^VADPT
"RTN","MDWOR",159,0)
 S MDARES=0 F MDALP=0:0 S MDALP=$O(^UTILITY("VASD",$J,MDALP)) Q:MDALP<1  S MDARES=$G(^(MDALP,"I")) Q
"RTN","MDWOR",160,0)
 K ^UTILITY("VASD",$J),VASD,X1,X2,X
"RTN","MDWOR",161,0)
 Q MDARES
"RTN","MDWORSR")
0^15^B57396407^B40172880
"RTN","MDWORSR",1,0)
MDWORSR ; HOIFO/NCA - Daily Schedule Studies;7/2/04  12:39 ;10/15/08  13:39
"RTN","MDWORSR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11**;Apr 01,2004;Build 67
"RTN","MDWORSR",3,0)
 ; Reference IA# 2263 [Supported] XPAR calls
"RTN","MDWORSR",4,0)
 ;               3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDWORSR",5,0)
 ;               3468 [Subscription] Call GMRCCP
"RTN","MDWORSR",6,0)
 ;               3869 [Subscription] SDAMA202 calls
"RTN","MDWORSR",7,0)
 ;               10035 [Supported] Patient File Access
"RTN","MDWORSR",8,0)
 ;               10103 [Supported] XLFDT calls
"RTN","MDWORSR",9,0)
 ;
"RTN","MDWORSR",10,0)
EN1 ; Entry Point to process scheduled studies
"RTN","MDWORSR",11,0)
 N MDCON,MDERR,MDFDA,MDHOLD,MDL,MDL1,MDMAXD,MDNOW,MDSTAT,MDX,MDXY
"RTN","MDWORSR",12,0)
 S MDMAXD=DT+.24
"RTN","MDWORSR",13,0)
 S MDL=DT F  S MDL=$O(^MDD(702,"ASD",MDL)) Q:MDL<1!(MDL>MDMAXD)  F MDL1=0:0 S MDL1=$O(^MDD(702,"ASD",MDL,MDL1)) Q:MDL1<1  S MDX=$G(^MDD(702,MDL1,0)) D
"RTN","MDWORSR",14,0)
 .K MDFDA
"RTN","MDWORSR",15,0)
 .S MDCON=+$P(MDX,"^",5) Q:'MDCON
"RTN","MDWORSR",16,0)
 .S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"E")
"RTN","MDWORSR",17,0)
 .Q:MDSTAT="DISCONTINUED"!(MDSTAT="CANCELLED")
"RTN","MDWORSR",18,0)
 .Q:+$P(MDX,"^",9)>0
"RTN","MDWORSR",19,0)
 .S MDIENS=MDL1_",",MDXY=+$P(MDX,"^",4),MDHOLD="" I MDXY D
"RTN","MDWORSR",20,0)
 ..Q:$P(^MDS(702.01,MDXY,0),U,6)'=2
"RTN","MDWORSR",21,0)
 ..S MDHOLD=$P($G(^MDD(702,+MDL1,0)),"^",7),MDNOW=$$NOW^XLFDT()
"RTN","MDWORSR",22,0)
 ..S $P(^MDD(702,+MDL1,0),"^",7)=$S(MDNOW>MDL:MDL,1:MDNOW)
"RTN","MDWORSR",23,0)
 .S MDHL7=$$SUB^MDHL7B(MDL1)
"RTN","MDWORSR",24,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",25,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.02)=$$NOW^XLFDT(),MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",26,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",27,0)
 .S MDXY=+$P(MDX,"^",4) Q:'MDXY
"RTN","MDWORSR",28,0)
 .I $P(^MDS(702.01,MDXY,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDWORSR",29,0)
 ..D CP^MDKUTL(+MDIENS)
"RTN","MDWORSR",30,0)
 ..S:$G(MDHOLD)'="" MDFDA(702,MDIENS,.07)=MDHOLD
"RTN","MDWORSR",31,0)
 ..S MDFDA(702,MDIENS,.09)=5
"RTN","MDWORSR",32,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",33,0)
 Q
"RTN","MDWORSR",34,0)
CLINICPT ; Check-in CP study with multiple results
"RTN","MDWORSR",35,0)
 N MD,MDCDT,MDCL,MDCOM,MDCON,MDDT,MDDX,MDEND,MDERR,MDFDA,MDHEMO,MDHL7,MDIEN,MDIENS,MDK,MDLP,MDLST,MDMULT,MDNODE,MDNUM,MDPT,MDRET,MDSCHD,MDVSTR,MDY,MDY1,MDYR,X,X1,X2
"RTN","MDWORSR",36,0)
 N MDATYP,MDHOLD,MDLST1,MDLST2,MDNEW,MDT,MDY3,MDY4 S MDDT=DT\1,MDEND=DT+.24 N MDINP K ^TMP($J,"SDAMA202","GETPLIST"),^TMP("MDSTATUS",$J) S MDCOM=0,MDHOLD=""
"RTN","MDWORSR",37,0)
 K ^TMP("MDMULT",$J),^TMP("MDCLINIC",$J),^TMP("MDLST",$J)
"RTN","MDWORSR",38,0)
 S MDNUM=$$GET^XPAR("SYS","MD COMPL PROC DISPLAY DAYS",1)
"RTN","MDWORSR",39,0)
 I +MDNUM>0 S X1=DT,X2=-MDNUM D C^%DTC S MDCOM=X
"RTN","MDWORSR",40,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWORSR",41,0)
 F MDLP=0:0 S MDLP=$O(^MDD(702,"AS",0,MDLP)) Q:MDLP<1  D
"RTN","MDWORSR",42,0)
 .S MDY=$G(^MDD(702,MDLP,0)) Q:+$P(MDY,"^",9)>0
"RTN","MDWORSR",43,0)
 .Q:$P(MDY,"^",7)'=""
"RTN","MDWORSR",44,0)
 .Q:'+$P(MDY,"^",5)!($P(MDY,"^",6)'="")
"RTN","MDWORSR",45,0)
 .Q:'+MDY
"RTN","MDWORSR",46,0)
 .I '+$G(^TMP("MDSTATUS",$J,+MDY,+$P(MDY,"^",4))) S ^TMP("MDSTATUS",$J,+MDY,+$P(MDY,"^",4))=+MDLP
"RTN","MDWORSR",47,0)
 .Q
"RTN","MDWORSR",48,0)
 ; Combine clinics with multiple procedures to regular clinics
"RTN","MDWORSR",49,0)
 S MDLST2=$S(+MDLST>0:MDLST,1:0)
"RTN","MDWORSR",50,0)
 ; Match new studies with 0 status to appointments
"RTN","MDWORSR",51,0)
 N MDXX K MDY F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDY=$P($G(MDLST(MDK)),"^",2) I +$P(MDY,";",2)>0 S MDCL=+MDY D
"RTN","MDWORSR",52,0)
 .S:$G(^TMP("MDCLINIC",$J,+MDCL))="" ^TMP("MDCLINIC",$J,+MDCL)=+MDCL
"RTN","MDWORSR",53,0)
 .S ^TMP("MDLST",$J,+MDCL,+$P(MDY,";",2))=+$P(MDY,";",2)
"RTN","MDWORSR",54,0)
 .S MDMULT=+$$GET1^DIQ(702.01,+$P(MDY,";",2)_",",.12,"I")
"RTN","MDWORSR",55,0)
 .S MDHEMO=+$$GET1^DIQ(702.01,+$P(MDY,";",2)_",",.06,"I")
"RTN","MDWORSR",56,0)
 .Q:MDMULT'=1&(MDHEMO<2)
"RTN","MDWORSR",57,0)
 .S ^TMP("MDMULT",$J,+MDK)=+MDCL_";"_+$P(MDY,";",2)
"RTN","MDWORSR",58,0)
 .Q
"RTN","MDWORSR",59,0)
 K MDLST,MDY F MDK=0:0 S MDK=$O(^TMP("MDCLINIC",$J,MDK)) Q:MDK<1  S MDY=MDK D
"RTN","MDWORSR",60,0)
 .K ^TMP($J,"SDAMA202","GETPLIST") S MDCL=+MDY
"RTN","MDWORSR",61,0)
 .D GETPLIST^SDAMA202(+MDY,"1;4;3","R",MDDT,MDEND,.MDRET,"")
"RTN","MDWORSR",62,0)
 .F MD=0:0 S MD=$O(^TMP($J,"SDAMA202","GETPLIST",MD)) Q:'MD  D
"RTN","MDWORSR",63,0)
 ..S MDY1=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,4)) Q:MDY1<1
"RTN","MDWORSR",64,0)
 ..S MDSCHD=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,1))
"RTN","MDWORSR",65,0)
 ..S MDATYP=$G(^TMP($J,"SDAMA202","GETPLIST",MD,3)) Q:MDATYP=""
"RTN","MDWORSR",66,0)
 ..Q:"RINT"'[MDATYP
"RTN","MDWORSR",67,0)
 ..S MDT=MDK,MDDX=+$$MATCH(+MDY1,MDT)
"RTN","MDWORSR",68,0)
 ..I 'MDDX S MDY4=$$GPRO(+MDY1,MDT),MDY3=$P(MDY4,"^",6),MDY4=$P(MDY4,"^",5) Q:'MDY4  S MDDX=+$$ADD(+MDY1,+MDY3,+MDY4,MDT) Q:'MDDX
"RTN","MDWORSR",69,0)
 ..S MDMULT=+$$GET1^DIQ(702,+MDDX,".04:.12","I")
"RTN","MDWORSR",70,0)
 ..S MDHEMO=+$$GET1^DIQ(702,+MDDX,".04:.06","I"),MDIENS=+MDDX_","
"RTN","MDWORSR",71,0)
 ..S MDFDA(702,MDIENS,.02)=$$NOW^XLFDT()
"RTN","MDWORSR",72,0)
 ..S MDFDA(702,MDIENS,.07)="A;"_MDSCHD_";"_MDCL
"RTN","MDWORSR",73,0)
 ..S MDFDA(702,MDIENS,.14)=MDSCHD
"RTN","MDWORSR",74,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR") K MDFDA
"RTN","MDWORSR",75,0)
 ..I MDHEMO=2 S MDHOLD=$P($G(^MDD(702,+MDIENS,0)),"^",7),MDNEW=$$NOW^XLFDT(),$P(^MDD(702,+MDIENS,0),"^",7)=$S(MDNEW>MDSCHD:MDSCHD,1:MDNEW)
"RTN","MDWORSR",76,0)
 ..S MDHL7=$$SUB^MDHL7B(+MDIENS)
"RTN","MDWORSR",77,0)
 ..I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",78,0)
 ..I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",79,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",80,0)
 ..Q:'+$G(MDIENS)
"RTN","MDWORSR",81,0)
 ..I MDHEMO=2 D CP^MDKUTL(+MDIENS) S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD S MDFDA(702,+MDIENS_",",.09)=5 D FILE^DIE("","MDFDA","MDERR") K MDFDA
"RTN","MDWORSR",82,0)
 ..Q
"RTN","MDWORSR",83,0)
 .Q
"RTN","MDWORSR",84,0)
 ; Match the rest of appointments with previous studies
"RTN","MDWORSR",85,0)
 N MDGET,MDINST S X1=DT,X2=-365 D C^%DTC S MDCDT=X
"RTN","MDWORSR",86,0)
 K MDY F MDK=0:0 S MDK=$O(^TMP("MDMULT",$J,MDK)) Q:MDK<1  S MDY=$G(^(MDK)) I +$P(MDY,";",2)>0 S MDCL=+MDY D
"RTN","MDWORSR",87,0)
 .K ^TMP($J,"SDAMA202","GETPLIST")
"RTN","MDWORSR",88,0)
 .D GETPLIST^SDAMA202(+MDY,"1;4;3","R",MDDT,MDEND,.MDRET,"")
"RTN","MDWORSR",89,0)
 .F MD=0:0 S MD=$O(^TMP($J,"SDAMA202","GETPLIST",MD)) Q:'MD  D
"RTN","MDWORSR",90,0)
 ..S MDINP=0
"RTN","MDWORSR",91,0)
 ..S MDY1=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,4)) Q:MDY1<1
"RTN","MDWORSR",92,0)
 ..S MDSCHD=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,1))
"RTN","MDWORSR",93,0)
 ..S MDATYP=$G(^TMP($J,"SDAMA202","GETPLIST",MD,3))
"RTN","MDWORSR",94,0)
 ..Q:"RINT"'[MDATYP
"RTN","MDWORSR",95,0)
 ..S MDPT=MDY1 Q:+$$GSTUDY(MDPT,MDSCHD)
"RTN","MDWORSR",96,0)
 ..S MDDX=$$GETC(MDPT,+$P(MDY,";",2)) Q:'+MDDX
"RTN","MDWORSR",97,0)
 ..S MDNODE=$G(^MDD(702,+MDDX,0))
"RTN","MDWORSR",98,0)
 ..S:$G(^DPT(MDY1,.105))'="" MDINP=1
"RTN","MDWORSR",99,0)
 ..S MDCON=$P(MDNODE,"^",5) Q:'MDCON
"RTN","MDWORSR",100,0)
 ..S MDVSTR=$P(MDNODE,"^",7) Q:MDVSTR=""
"RTN","MDWORSR",101,0)
 ..S MDMULT=+$$GET1^DIQ(702,+MDDX,".04:.12","I")
"RTN","MDWORSR",102,0)
 ..S MDHEMO=+$$GET1^DIQ(702,+MDDX,".04:.06","I")
"RTN","MDWORSR",103,0)
 ..S MDYR=$S(MDMULT<1:MDCOM,1:MDCDT)
"RTN","MDWORSR",104,0)
 ..Q:$P(MDNODE,"^",2)<MDYR
"RTN","MDWORSR",105,0)
 ..Q:'$P(MDNODE,"^",9)
"RTN","MDWORSR",106,0)
 ..Q:$P(MDNODE,"^",9)>3
"RTN","MDWORSR",107,0)
 ..Q:$P(MDVSTR,";",2)=MDSCHD
"RTN","MDWORSR",108,0)
 ..S MDINST=+$$GINST(+$P(MDNODE,"^",4)) Q:'MDINST
"RTN","MDWORSR",109,0)
 ..K MDFDA,MDERR,MDIEN
"RTN","MDWORSR",110,0)
 ..S MDFDA(702,"+1,",.01)=MDY1
"RTN","MDWORSR",111,0)
 ..S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWORSR",112,0)
 ..S MDFDA(702,"+1,",.03)=$P(MDNODE,"^",3)
"RTN","MDWORSR",113,0)
 ..S MDFDA(702,"+1,",.04)=$P(MDNODE,"^",4)
"RTN","MDWORSR",114,0)
 ..S MDFDA(702,"+1,",.05)=MDCON
"RTN","MDWORSR",115,0)
 ..S MDFDA(702,"+1,",.07)="A;"_MDSCHD_";"_MDCL
"RTN","MDWORSR",116,0)
 ..S MDFDA(702,"+1,",.11)=+MDINST
"RTN","MDWORSR",117,0)
 ..S MDFDA(702,"+1,",.14)=MDSCHD
"RTN","MDWORSR",118,0)
 ..D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)  K MDFDA
"RTN","MDWORSR",119,0)
 ..S MDIENS=MDIEN(1)_"," I MDHEMO=2 S MDHOLD=$P($G(^MDD(702,MDIEN(1),0)),"^",7),MDNOW=$$NOW^XLFDT(),$P(^MDD(702,MDIEN(1),0),"^",7)=$S(MDNOW>MDSCHD:MDSCHD,1:MDNOW)
"RTN","MDWORSR",120,0)
 ..S MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDWORSR",121,0)
 ..I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",122,0)
 ..I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",123,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",124,0)
 ..Q:'+$G(MDIENS)
"RTN","MDWORSR",125,0)
 ..I MDHEMO=2 D CP^MDKUTL(+MDIENS) K MDFDA S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD S MDFDA(702,+MDIENS_",",.09)=5 D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",126,0)
 K ^TMP($J,"SDAMA202","GETPLIST"),^TMP("MDSTATUS",$J),MDFDA
"RTN","MDWORSR",127,0)
 K ^TMP("MDCLINIC",$J),^TMP("MDMULT",$J),^TMP("MDLST",$J)
"RTN","MDWORSR",128,0)
 Q
"RTN","MDWORSR",129,0)
GETC(MDPAT,MDDA) ; Get consult date
"RTN","MDWORSR",130,0)
 N MDX,MDCF S MDCF=0 K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,+MDDA,$NA(^TMP("MDTMP",$J)))
"RTN","MDWORSR",131,0)
 S MDX=$O(^TMP("MDTMP",$J,""),-1) Q:'+MDX 0
"RTN","MDWORSR",132,0)
 I "saprc"'[$P($G(^TMP("MDTMP",$J,MDX)),U,4) S MDX=$O(^TMP("MDTMP",$J,MDX),-1) Q:'+MDX 0
"RTN","MDWORSR",133,0)
 I "saprc"[$P($G(^TMP("MDTMP",$J,MDX)),U,4) S MDCF=$P($G(^TMP("MDTMP",$J,MDX)),U,5)_"^"_$P($G(^TMP("MDTMP",$J,MDX)),U,1)
"RTN","MDWORSR",134,0)
 K ^TMP("MDTMP",$J)
"RTN","MDWORSR",135,0)
 Q $S(+MDCF:+$O(^MDD(702,"ACON",+MDCF,""),-1)_"^"_$P(MDCF,"^",2)_"^"_+MDCF_"^"_$P(MDCF,"^",6),1:0)
"RTN","MDWORSR",136,0)
GINST(MDDA) ; Get instrument from CP Definition
"RTN","MDWORSR",137,0)
 N MDIN,MDINT,Y1 S (MDINT,Y1)=0
"RTN","MDWORSR",138,0)
 F MDIN=0:0 S MDIN=$O(^MDS(702.01,+MDDA,.1,MDIN)) Q:MDIN<1!(+Y1)  S MDINT=+$G(^(MDIN,0)) I +$$GET1^DIQ(702.09,MDINT,".13","I") S Y1=MDINT
"RTN","MDWORSR",139,0)
 Q Y1
"RTN","MDWORSR",140,0)
GSTUDY(MDPAT,MDDA) ;Get study for scheduled date/time
"RTN","MDWORSR",141,0)
 N MDIN,Y1 S Y1=0
"RTN","MDWORSR",142,0)
 F MDIN=0:0 S MDIN=$O(^MDD(702,"ASD",MDDA,MDIN)) Q:MDIN<1!(Y1>0)  D
"RTN","MDWORSR",143,0)
 .S:$P($G(^MDD(702,MDIN,0)),"^")=MDPAT Y1=1
"RTN","MDWORSR",144,0)
 Q Y1
"RTN","MDWORSR",145,0)
GPRO(MDPAT,MDCLIN) ; Get procedure for study
"RTN","MDWORSR",146,0)
 N MDX,MDCF,MDCFX S MDCF="" K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,,$NA(^TMP("MDTMP",$J)))
"RTN","MDWORSR",147,0)
 S MDX=0 F  S MDX=$O(^TMP("MDTMP",$J,MDX)) Q:'MDX!(MDCF'="")  D:"sap"[$P(^(MDX),U,4)
"RTN","MDWORSR",148,0)
 .S MDCFX=$G(^TMP("MDTMP",$J,MDX)) Q:'+$G(^TMP("MDLST",$J,MDCLIN,+$P(MDCFX,"^",6)))
"RTN","MDWORSR",149,0)
 .Q:+$O(^MDD(702,"ACON",+$P(MDCFX,"^",5),0))  S MDCF=MDCFX Q
"RTN","MDWORSR",150,0)
 K ^TMP("MDTMP",$J)
"RTN","MDWORSR",151,0)
 Q $S(MDCF'="":MDCF,1:0)
"RTN","MDWORSR",152,0)
MATCH(MDPAT,MDCLIN) ; Match study to appointment
"RTN","MDWORSR",153,0)
 N MDI,MDY2 S MDY2=0
"RTN","MDWORSR",154,0)
 F MDI=0:0 S MDI=$O(^TMP("MDSTATUS",$J,MDPAT,MDI)) Q:MDI<1!(+MDY2)  D
"RTN","MDWORSR",155,0)
 .I +$G(^TMP("MDLST",$J,MDCLIN,MDI)) S MDY2=+$G(^TMP("MDSTATUS",$J,MDPAT,MDI))
"RTN","MDWORSR",156,0)
 Q MDY2
"RTN","MDWORSR",157,0)
ADD(MDPAT,MDY3,MDY4,MDCLIN) ; Add study, if none exist
"RTN","MDWORSR",158,0)
 N MDFDA,MDERR,MDIENS,MDP,MDPS
"RTN","MDWORSR",159,0)
 Q:'MDY3
"RTN","MDWORSR",160,0)
 K MDFDA,MDERR,MDIENN
"RTN","MDWORSR",161,0)
 S MDP=$O(^MDD(702,"B",MDPAT,0)),MDPS=$G(^MDD(702,+MDP,0))
"RTN","MDWORSR",162,0)
 S MDFDA(702,"+1,",.01)=MDPAT
"RTN","MDWORSR",163,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWORSR",164,0)
 S MDFDA(702,"+1,",.03)=$S(+$P(MDPS,"^",3):$P(MDPS,"^",3),1:DUZ)
"RTN","MDWORSR",165,0)
 S MDFDA(702,"+1,",.04)=+MDY3
"RTN","MDWORSR",166,0)
 S MDFDA(702,"+1,",.05)=+MDY4
"RTN","MDWORSR",167,0)
 S MDFDA(702,"+1,",.11)=+$$GINST(+MDY3)
"RTN","MDWORSR",168,0)
 D UPDATE^DIE("","MDFDA","MDIENN","MDERR") Q:$D(MDERR) 0
"RTN","MDWORSR",169,0)
 K MDFDA
"RTN","MDWORSR",170,0)
 Q MDIENN(1)
"RTN","MDWSETUP")
0^8^B65119245^B67128950
"RTN","MDWSETUP",1,0)
MDWSETUP ; HOIFO/NCA - Auto Study Check-In Setup ;3/18/08  14:14
"RTN","MDWSETUP",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11**;Apr 01, 2004;Build 67
"RTN","MDWSETUP",3,0)
EN1 ; [Procedure]
"RTN","MDWSETUP",4,0)
 ; This post conversion routine will place the Medicine Enter/Edit 
"RTN","MDWSETUP",5,0)
 ; options out of order
"RTN","MDWSETUP",6,0)
 ; Reference IA # 2263 [Supported] XPAR parameter calls
"RTN","MDWSETUP",7,0)
 ;               10040 [Supported] Accessing Hospital Location file (#44)
"RTN","MDWSETUP",8,0)
 ;               10103 [Supported] XLFDT call
"RTN","MDWSETUP",9,0)
 ;
"RTN","MDWSETUP",10,0)
 N MDANS,MDAPT,MDAR,MDCL,MDCNOD,MDCP,MDCT,MDCTR,MDDEF,MDDFLT,MDERR,MDFLAG,MDFRST,MDLP,MDLAST,MDLST,MDLST1,MDLST2,MDNODE,MDNXT
"RTN","MDWSETUP",11,0)
 N MDPREC,MDS,MDSAP,MDSED,MDSEL,MDX,MDX1,MDX2,MDX3,MDY,MDY1 K ^TMP("MDOLD",$J)
"RTN","MDWSETUP",12,0)
 D GETLST^XPAR(.MDLST1,"SYS","MD CLINIC ASSOCIATION") I '+$G(MDLST1) D GET
"RTN","MDWSETUP",13,0)
 S MDDEF=$$GET^XPAR("SYS","MD USE APPT WITH PROCEDURE",1),MDDEF=$S(+MDDEF:"YES",1:"NO")
"RTN","MDWSETUP",14,0)
 K DIR S DIR(0)="YA",DIR("A")="Use Appointment with procedure? ",DIR("B")=MDDEF,DIR("?")="Enter either 'Y' or 'N'."
"RTN","MDWSETUP",15,0)
 S DIR("?",1)="Default should be 'N' as most sites do not schedule procedures"
"RTN","MDWSETUP",16,0)
 S DIR("?",2)="before the order is entered.  Select 'Y' if the procedure appointment"
"RTN","MDWSETUP",17,0)
 S DIR("?",3)="is scheduled before the order is entered and the ordering provider"
"RTN","MDWSETUP",18,0)
 S DIR("?",4)="selects the appointment for the procedure."
"RTN","MDWSETUP",19,0)
 D ^DIR K DIR Q:$D(DIRUT)!$D(DIROUT)!(Y<0)
"RTN","MDWSETUP",20,0)
 ;D DEL^XPAR("SYS","MD USE APPT WITH PROCEDURE",1)
"RTN","MDWSETUP",21,0)
 D EN^XPAR("SYS","MD USE APPT WITH PROCEDURE",1,0)
"RTN","MDWSETUP",22,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CHECK-IN PROCEDURE LIST")
"RTN","MDWSETUP",23,0)
 D GETLST^XPAR(.MDLST1,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWSETUP",24,0)
 K ^TMP("MDPROC",$J),^TMP("MDPARAM",$J) S (MDCT,MDCTR,MDLAST)=0
"RTN","MDWSETUP",25,0)
 ; Get procedure parameter list
"RTN","MDWSETUP",26,0)
 F MDLP=0:0 S MDLP=$O(MDLST(MDLP)) Q:MDLP<1  I +$G(MDLST(MDLP)) S MDX=$P($G(^MDS(702.01,+$G(MDLST(MDLP)),0)),"^",1) D
"RTN","MDWSETUP",27,0)
 . Q:MDX=""  S MDY=+$P($G(MDLST(MDLP)),"^",2)
"RTN","MDWSETUP",28,0)
 . S ^TMP("MDPROC",$J,MDX,+$G(MDLST(MDLP)))=MDY_"^"_$S(MDY=1:"Outpatient",MDY=2:"Inpatient",MDY=3:"Both",1:"None")
"RTN","MDWSETUP",29,0)
 ; Get Clinic Quick List
"RTN","MDWSETUP",30,0)
 F MDLP=0:0 S MDLP=$O(MDLST1(MDLP)) Q:MDLP<1  S MDX3=+$G(MDLST1(MDLP)),MDX2=$P($G(MDLST1(MDLP)),"^",2),MDX1=+$P(MDX2,";",2) I +MDX1 D
"RTN","MDWSETUP",31,0)
 . S MDX=$P($G(^MDS(702.01,MDX1,0)),"^",1) Q:MDX=""
"RTN","MDWSETUP",32,0)
 . S MDY=+$P(MDX2,";",1) Q:'MDY
"RTN","MDWSETUP",33,0)
 . S MDCNOD=$G(^TMP("MDPROC",$J,MDX,MDX1)) Q:MDCNOD=""
"RTN","MDWSETUP",34,0)
 . S MDY1=$$GET1^DIQ(44,MDY_",",.01),MDCTR=MDCTR+1
"RTN","MDWSETUP",35,0)
 . S:$G(MDCTR(MDY))="" MDCTR(MDY)=0 S MDCTR(MDY)=MDCTR(MDY)+1
"RTN","MDWSETUP",36,0)
 . S ^TMP("MDPARAM",$J,MDX,MDY1)=MDX1_"^"_MDY_"^"_MDCNOD_"^"_MDX3,MDLAST=MDX3
"RTN","MDWSETUP",37,0)
 S MDPREC=$NA(^TMP("MDPROC",$J)) K MDLST,MDLST1
"RTN","MDWSETUP",38,0)
 F  S MDPREC=$Q(@MDPREC) Q:MDPREC=""  Q:$QS(MDPREC,1)'="MDPROC"  D
"RTN","MDWSETUP",39,0)
 . I '$D(^TMP("MDPARAM",$J,$QS(MDPREC,3))) S MDCTR=MDCTR+1,^TMP("MDPARAM",$J,$QS(MDPREC,3),"None")=$QS(MDPREC,4)_"^^"_@MDPREC
"RTN","MDWSETUP",40,0)
QURY ; Query the procedure parameter list
"RTN","MDWSETUP",41,0)
 I MDCTR<1 G A1
"RTN","MDWSETUP",42,0)
 N MDN S MDPREC=$NA(^TMP("MDPARAM",$J)),(MDANS,MDN)="" D HDR
"RTN","MDWSETUP",43,0)
 F  S MDPREC=$Q(@MDPREC) Q:MDPREC=""  Q:$QS(MDPREC,1)'="MDPARAM"  D
"RTN","MDWSETUP",44,0)
 . Q:MDANS="^"
"RTN","MDWSETUP",45,0)
 . S MDAPT=@MDPREC,MDAPT=$P(MDAPT,"^",4)
"RTN","MDWSETUP",46,0)
 . I $Y>(IOSL-2) K DIR S DIR(0)="E" D ^DIR K DIR D:Y HDR I $D(DIRUT)!$D(DIROUT)!(Y<0) S MDANS="^" Q
"RTN","MDWSETUP",47,0)
 . I MDN'=$QS(MDPREC,3) W !,$E($QS(MDPREC,3),1,25),?27,MDAPT,?55,$E($QS(MDPREC,4),1,25) S MDN=$QS(MDPREC,3) Q
"RTN","MDWSETUP",48,0)
 . W !?55,$E($QS(MDPREC,4),1,25)
"RTN","MDWSETUP",49,0)
A1 ; Ask for procedure parameter
"RTN","MDWSETUP",50,0)
 W !!,"Procedure: " R X:DTIME G:'$T!("^"[X) KIL
"RTN","MDWSETUP",51,0)
 I X["?" D PHELP^MDWCHK
"RTN","MDWSETUP",52,0)
 K DIC S DIC="^MDS(702.01,",DIC(0)="EQMZ",DIC("S")="I +$P(^(0),U,9)>0"
"RTN","MDWSETUP",53,0)
 D ^DIC K DIC G A1:"^"[X!$D(DTOUT),A1:Y<1
"RTN","MDWSETUP",54,0)
 S MDSEL=Y,MDCP=+MDSEL
"RTN","MDWSETUP",55,0)
 G:'$D(^TMP("MDPARAM",$J,Y(0,0))) A2
"RTN","MDWSETUP",56,0)
 S MDFRST=$O(^TMP("MDPARAM",$J,Y(0,0),"")) G:MDFRST="" A2
"RTN","MDWSETUP",57,0)
 S MDX1=$P($G(^TMP("MDPARAM",$J,Y(0,0),MDFRST)),"^",3)
"RTN","MDWSETUP",58,0)
 S MDNXT=$O(^TMP("MDPARAM",$J,Y(0,0),MDFRST)),MDDFLT="",MDFLAG=0
"RTN","MDWSETUP",59,0)
 I MDNXT="" S MDDFLT=$G(^TMP("MDPARAM",$J,Y(0,0),MDFRST)),MDNODE=MDFRST G E1
"RTN","MDWSETUP",60,0)
 I MDNXT'="" D  Q:+MDFLAG
"RTN","MDWSETUP",61,0)
 . W ! S MDLP="",MDCT=0 F  S MDLP=$O(^TMP("MDPARAM",$J,Y(0,0),MDLP)) Q:MDLP=""  D
"RTN","MDWSETUP",62,0)
 . . S MDCT=MDCT+1 W !,MDCT_") ",Y(0,0),"  ",MDLP S MDAR(MDCT)=MDLP
"RTN","MDWSETUP",63,0)
 . W ! K DIR S DIR(0)="NAO^1:"_MDCT,DIR("A")="Select 1-"_MDCT_": ",DIR("?")="Select from 1-"_MDCT D ^DIR
"RTN","MDWSETUP",64,0)
 . I X="" S MDSED=MDSEL,MDSAP=MDX1,MDFLAG=1 Q
"RTN","MDWSETUP",65,0)
 . K DIR G:$D(DIRUT)!$D(DIROUT)!(Y<1) KIL S MDS=Y
"RTN","MDWSETUP",66,0)
 . S MDNODE=$G(MDAR(MDS))
"RTN","MDWSETUP",67,0)
 . S MDDFLT=$G(^TMP("MDPARAM",$J,$P(MDSEL,"^",2),MDNODE))
"RTN","MDWSETUP",68,0)
E1 ; Edit the procedure
"RTN","MDWSETUP",69,0)
 W !!,"Procedure: ",$P(MDSEL,"^",2)_"// " R X:DTIME G:'$T!(X=U) KIL
"RTN","MDWSETUP",70,0)
 I X["?"!(X'="")&(X'="@") W !,"Hit Return to accept the procedure",!,"Enter ""@"" to delete the procedure.",!,"Enter a ""^"" will exit completely." G E1
"RTN","MDWSETUP",71,0)
 I X="@" D  G A1
"RTN","MDWSETUP",72,0)
 . I MDNXT="" D EN^XPAR("SYS","MD CHECK-IN PROCEDURE LIST",$P(MDSEL,"^",2),"@")
"RTN","MDWSETUP",73,0)
 . D EN^XPAR("SYS","MD CLINIC ASSOCIATION",+$P(MDDFLT,"^",5),"@")
"RTN","MDWSETUP",74,0)
 . K ^TMP("MDPARAM",$J,$P(MDSEL,"^",2),MDNODE)
"RTN","MDWSETUP",75,0)
 . S:+$P(MDDFLT,"^",2) MDCTR(+$P(MDDFLT,"^",2))=MDCTR(+$P(MDDFLT,"^",2))-1
"RTN","MDWSETUP",76,0)
 . W " ..Procedure deleted"
"RTN","MDWSETUP",77,0)
 S MDSED=MDSEL
"RTN","MDWSETUP",78,0)
E2 ; Ask whether appointment scheduled
"RTN","MDWSETUP",79,0)
 K DIR S DIR(0)="SA^0:None;1:Outpatient;2:Inpatient;3:Both",DIR("A")="Schedule Appointment?: ",DIR("B")=+$P(MDDFLT,"^",3)
"RTN","MDWSETUP",80,0)
 S DIR("?")="^D CHELP^MDWCHK"
"RTN","MDWSETUP",81,0)
 D ^DIR K DIR
"RTN","MDWSETUP",82,0)
 G:$D(DIRUT)!$D(DIROUT)!(Y<0) KIL S MDSAP=Y
"RTN","MDWSETUP",83,0)
 I $G(MDDFLT)'="" D EN^XPAR("SYS","MD CHECK-IN PROCEDURE LIST",$P(MDSEL,"^",2),"@")
"RTN","MDWSETUP",84,0)
 D EN^XPAR("SYS","MD CHECK-IN PROCEDURE LIST","`"_+MDSED,+MDSAP)
"RTN","MDWSETUP",85,0)
 I MDSAP'=+$P(MDDFLT,"^",3) S MDLP="" F  S MDLP=$O(^TMP("MDPARAM",$J,$P(MDSED,"^",2),MDLP)) Q:MDLP=""  S MDX=$G(^(MDLP)) I $P(MDX,"^",3)'=+MDSAP D
"RTN","MDWSETUP",86,0)
 . S $P(MDX,"^",3,4)=+MDSAP_"^"_$S(MDSAP=1:"Outpatient",MDSAP=2:"Inpatient",MDSAP=3:"Both",1:"None")
"RTN","MDWSETUP",87,0)
 . S ^TMP("MDPARAM",$J,$P(MDSED,"^",2),MDLP)=MDX
"RTN","MDWSETUP",88,0)
 I MDNODE["None" G A3
"RTN","MDWSETUP",89,0)
E3 ; Edit the location
"RTN","MDWSETUP",90,0)
 W !,"Clinic: ",MDNODE_"// " R X:DTIME G:'$T!(X=U) KIL
"RTN","MDWSETUP",91,0)
 I X["?"!(X'="")&(X'="@") W !,"Hit Return to accept the clinic",!,"Enter ""@"" to delete the clinic from the procedure.",!,"Enter a ""^"" will exit completely." G E3
"RTN","MDWSETUP",92,0)
 I X="" G A4
"RTN","MDWSETUP",93,0)
 I X="@" D  G A4
"RTN","MDWSETUP",94,0)
 . D:+$P(MDDFLT,"^",5) EN^XPAR("SYS","MD CLINIC ASSOCIATION",+$P(MDDFLT,"^",5),"@")
"RTN","MDWSETUP",95,0)
 . S:+$P(MDDFLT,"^",2) MDCTR(+$P(MDDFLT,"^",2))=MDCTR(+$P(MDDFLT,"^",2))-1
"RTN","MDWSETUP",96,0)
 . K ^TMP("MDPARAM",$J,$P(MDSEL,"^",2),MDNODE)
"RTN","MDWSETUP",97,0)
 . I $G(MDNXT)="" S $P(MDDFLT,"^",2)="",^TMP("MDPARAM",$J,$P(MDSEL,"^",2),"None")=MDDFLT
"RTN","MDWSETUP",98,0)
 . W " ..Value deleted"
"RTN","MDWSETUP",99,0)
 S MDCL=+$P(MDDFLT,"^",2)_"^"_MDNODE
"RTN","MDWSETUP",100,0)
 K MDCL,MDSEL
"RTN","MDWSETUP",101,0)
 G A4
"RTN","MDWSETUP",102,0)
A2 ; Ask if site schedule appointments
"RTN","MDWSETUP",103,0)
 K DIR S DIR(0)="SA^0:None;1:Outpatient;2:Inpatient;3:Both",DIR("A")="Schedule Appointment?: ",DIR("?")="^D CHELP^MDWCHK"
"RTN","MDWSETUP",104,0)
 D ^DIR K DIR
"RTN","MDWSETUP",105,0)
 I $D(DIRUT)!$D(DIROUT)!(Y<0) W "...Procedure removed" G KIL
"RTN","MDWSETUP",106,0)
 S MDSAP=Y
"RTN","MDWSETUP",107,0)
 D EN^XPAR("SYS","MD CHECK-IN PROCEDURE LIST","`"_+MDSEL,+MDSAP)
"RTN","MDWSETUP",108,0)
 S ^TMP("MDPARAM",$J,$P(MDSEL,"^",2),"None")=+MDSEL_"^^"_MDSAP_"^"_$S(MDSAP=1:"Outpatient",MDSAP=2:"Inpatient",MDSAP=3:"Both",1:"None")
"RTN","MDWSETUP",109,0)
 I 'MDSAP S MDCL="" D TASK G A1
"RTN","MDWSETUP",110,0)
A3 ; Ask for clinic value
"RTN","MDWSETUP",111,0)
 W !,"Clinic: " R X:DTIME G:'$T!(X=U) KIL
"RTN","MDWSETUP",112,0)
 I X["?" D CLHELP
"RTN","MDWSETUP",113,0)
 I X="" S MDCL="" D:'+MDSAP TASK G A1
"RTN","MDWSETUP",114,0)
 K DIC S DIC="^SC(",DIC(0)="EQMZ"
"RTN","MDWSETUP",115,0)
 D ^DIC K DIC G A3:"^"[X!$D(DTOUT),A3:Y<1
"RTN","MDWSETUP",116,0)
 S MDCL=Y D TASK
"RTN","MDWSETUP",117,0)
 K ^TMP("MDPARAM",$J,$P(MDSEL,"^",2),"None")
"RTN","MDWSETUP",118,0)
 S ^TMP("MDPARAM",$J,$P(MDSEL,"^",2),$P(MDCL,"^",2))=+MDSEL_"^"_+MDCL_"^"_MDSAP_"^"_$S(MDSAP=1:"Outpatient",MDSAP=2:"Inpatient",MDSAP=3:"Both",1:"None")
"RTN","MDWSETUP",119,0)
 S:$G(MDCTR(+MDCL))="" MDCTR(+MDCL)=0 S MDCTR(+MDCL)=MDCTR(+MDCL)+1,MDLAST=MDLAST+1
"RTN","MDWSETUP",120,0)
 D EN^XPAR("SYS","MD CLINIC ASSOCIATION",MDLAST,+MDCL_";"_+MDSEL)
"RTN","MDWSETUP",121,0)
A4 ; Ask for another Clinic
"RTN","MDWSETUP",122,0)
 K DIR W ! S DIR(0)="YA",DIR("A")="Enter another clinic for the same procedure? ",DIR("B")="NO",DIR("?")="Enter either 'Y' or 'N', if you want to assign more than one clinic."
"RTN","MDWSETUP",123,0)
 D ^DIR K DIR G:$D(DIRUT)!$D(DIROUT)!(Y<0) A4
"RTN","MDWSETUP",124,0)
 I +Y G A3
"RTN","MDWSETUP",125,0)
 G A1
"RTN","MDWSETUP",126,0)
KIL ; Clean Up TMP global arrays and exit
"RTN","MDWSETUP",127,0)
 K DIROUT,DIRUT,MDCL,MDSEL,X,Y
"RTN","MDWSETUP",128,0)
 K ^TMP("MDPROC",$J),^TMP("MDPARAM",$J)
"RTN","MDWSETUP",129,0)
 Q
"RTN","MDWSETUP",130,0)
TASK ; Queue a task to process previous requests
"RTN","MDWSETUP",131,0)
 K IO("Q"),ZTUCI,ZTDTH,ZTIO,ZTSAVE S ZTRTN="START^MDWCHK",ZTREQ="@",ZTSAVE("ZTREQ")="",ZTIO="",ZTDTH=$$NOW^XLFDT()
"RTN","MDWSETUP",132,0)
 S ZTDESC="Check-In Studies for "_$P($G(^MDS(702.01,+MDCP,0)),"^",1)
"RTN","MDWSETUP",133,0)
 S ZTSAVE("MDCP")="",ZTSAVE("MDCL")="",MDUSR=DUZ,ZTSAVE("MDUSR")="",ZTSAVE("MDSAP")=""
"RTN","MDWSETUP",134,0)
 D ^%ZTLOAD K ZTSK
"RTN","MDWSETUP",135,0)
 Q
"RTN","MDWSETUP",136,0)
GET ; Get existing parameter
"RTN","MDWSETUP",137,0)
 N MDPAR,MDVAL
"RTN","MDWSETUP",138,0)
 D GETLST^XPAR(.MDLST1,"SYS","MD CLINIC QUICK LIST")
"RTN","MDWSETUP",139,0)
 D GETLST^XPAR(.MDLST2,"SYS","MD CLINICS WITH MULT PROC")
"RTN","MDWSETUP",140,0)
 ; Get Clinic Quick List
"RTN","MDWSETUP",141,0)
 F MDLP=0:0 S MDLP=$O(MDLST1(MDLP)) Q:MDLP<1  S MDX1=+$P($G(MDLST1(MDLP)),"^",2) I +MDX1 D
"RTN","MDWSETUP",142,0)
 . S MDX=$P($G(^MDS(702.01,MDX1,0)),"^",1) Q:MDX=""
"RTN","MDWSETUP",143,0)
 . S MDY=+$G(MDLST1(MDLP)) Q:'MDY
"RTN","MDWSETUP",144,0)
 . S MDY1=$$GET1^DIQ(44,MDY_",",.01)
"RTN","MDWSETUP",145,0)
 . S ^TMP("MDOLD",$J,MDX,MDY1)=MDY_"^"_MDX1
"RTN","MDWSETUP",146,0)
 ; Get clinic with multiple procedures
"RTN","MDWSETUP",147,0)
 F MDLP=0:0 S MDLP=$O(MDLST2(MDLP)) Q:MDLP<1  I +$G(MDLST2(MDLP)) S MDX=$P($G(^MDS(702.01,+$G(MDLST2(MDLP)),0)),"^",1) D
"RTN","MDWSETUP",148,0)
 . S MDY=+$P($G(MDLST2(MDLP)),"^",2),MDY1=$$GET1^DIQ(44,MDY_",",.01)
"RTN","MDWSETUP",149,0)
 . Q:$G(^TMP("MDOLD",$J,MDX,MDY1))'=""
"RTN","MDWSETUP",150,0)
 . S ^TMP("MDOLD",$J,MDX,MDY1)=MDY_"^"_+$G(MDLST2(MDLP))
"RTN","MDWSETUP",151,0)
 S MDPAR=$NA(^TMP("MDOLD",$J)),MDCTR=0 F  S MDPAR=$Q(@MDPAR) Q:MDPAR=""  Q:$QS(MDPAR,1)'="MDOLD"  D
"RTN","MDWSETUP",152,0)
 . S MDCTR=MDCTR+1,MDVAL=@MDPAR,MDVAL=$TR(MDVAL,"^",";")
"RTN","MDWSETUP",153,0)
 . D EN^XPAR("SYS","MD CLINIC ASSOCIATION",MDCTR,MDVAL)
"RTN","MDWSETUP",154,0)
 K ^TMP("MDOLD",$J)
"RTN","MDWSETUP",155,0)
 Q
"RTN","MDWSETUP",156,0)
CLHELP ; Help Message for Clinic prompt
"RTN","MDWSETUP",157,0)
 W !,"Only required, if appointments are scheduled for the procedure."
"RTN","MDWSETUP",158,0)
 W !,"Enter the clinic used for scheduling the procedure."
"RTN","MDWSETUP",159,0)
 I +MDCP,$D(^TMP("MDPARAM",$J)) D
"RTN","MDWSETUP",160,0)
 .W ! S MDLP="" F  S MDLP=$O(^TMP("MDPARAM",$J,$P($G(^MDS(702.01,+MDCP,0)),"^",1),MDLP)) Q:MDLP=""  I MDLP'["None" W !,MDLP
"RTN","MDWSETUP",161,0)
 W !
"RTN","MDWSETUP",162,0)
 Q
"RTN","MDWSETUP",163,0)
HDR ; Parameter List Header
"RTN","MDWSETUP",164,0)
 W @IOF,!!,"Procedure",?27,"Schedule Appt.",?55,"Clinic"
"RTN","MDWSETUP",165,0)
 W !,"---------",?27,"--------------",?55,"------"
"RTN","MDWSETUP",166,0)
 Q
"VER")
8.0^22.0
"^DD",702.01,702.01,.12,0)
PROCESSED RESULT^S^0:Final Result;1:Multiple Results;2:Cumulative Result;^0;11^Q
"^DD",702.01,702.01,.12,.1)
Processed Result
"^DD",702.01,702.01,.12,3)
Enter the processed result.
"^DD",702.01,702.01,.12,21,0)
^^2^2^3050214^
"^DD",702.01,702.01,.12,21,1,0)
This field is a flag which indicates whether a final result,
"^DD",702.01,702.01,.12,21,2,0)
multiple results, or cumulative result is associated with this procedure.
"^DD",702.01,702.01,.12,"DT")
3050214
"BLD",5713,6)
^13
**END**
**END**

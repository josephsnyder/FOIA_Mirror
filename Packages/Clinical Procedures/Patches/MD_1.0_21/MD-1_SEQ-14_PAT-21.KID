Released MD*1*21 SEQ #14
Extracted from mail message
**KIDS**:MD*1.0*21^

**INSTALL NAME**
MD*1.0*21
"BLD",7271,0)
MD*1.0*21^CLINICAL PROCEDURES^0^3100430^y
"BLD",7271,1,0)
^^2^2^3090302^
"BLD",7271,1,1,0)
Please refer to the National Patch Module for the detail of this 
"BLD",7271,1,2,0)
patch build.
"BLD",7271,4,0)
^9.64PA^^0
"BLD",7271,6.3)
30
"BLD",7271,"ABPKG")
n
"BLD",7271,"INID")
^
"BLD",7271,"INIT")
MDPOST21
"BLD",7271,"KRN",0)
^9.67PA^779.2^20
"BLD",7271,"KRN",.4,0)
.4
"BLD",7271,"KRN",.401,0)
.401
"BLD",7271,"KRN",.402,0)
.402
"BLD",7271,"KRN",.403,0)
.403
"BLD",7271,"KRN",.5,0)
.5
"BLD",7271,"KRN",.84,0)
.84
"BLD",7271,"KRN",3.6,0)
3.6
"BLD",7271,"KRN",3.8,0)
3.8
"BLD",7271,"KRN",9.2,0)
9.2
"BLD",7271,"KRN",9.8,0)
9.8
"BLD",7271,"KRN",9.8,"NM",0)
^9.68A^32^26
"BLD",7271,"KRN",9.8,"NM",1,0)
MDHL7A^^0^B49521176
"BLD",7271,"KRN",9.8,"NM",2,0)
MDPCE^^0^B4196998
"BLD",7271,"KRN",9.8,"NM",3,0)
MDPCE2^^0^B24598640
"BLD",7271,"KRN",9.8,"NM",4,0)
MDRPCNT1^^0^B42671785
"BLD",7271,"KRN",9.8,"NM",7,0)
MDWCAN^^0^B19425889
"BLD",7271,"KRN",9.8,"NM",9,0)
MDAR7M^^0^B23544832
"BLD",7271,"KRN",9.8,"NM",10,0)
MDRPCW^^0^B69393853
"BLD",7271,"KRN",9.8,"NM",12,0)
MDRPCW1^^0^B57107439
"BLD",7271,"KRN",9.8,"NM",13,0)
MDHL7U3^^0^B65415989
"BLD",7271,"KRN",9.8,"NM",14,0)
MDSTUDW^^0^B21880299
"BLD",7271,"KRN",9.8,"NM",15,0)
MDCLN^^0^B494118
"BLD",7271,"KRN",9.8,"NM",16,0)
MDHL7XXX^^0^B26957233
"BLD",7271,"KRN",9.8,"NM",19,0)
MDARSET^^0^B19742072
"BLD",7271,"KRN",9.8,"NM",20,0)
MDPS1^^0^B81903471
"BLD",7271,"KRN",9.8,"NM",21,0)
MDRPCOT^^0^B85701277
"BLD",7271,"KRN",9.8,"NM",22,0)
MDRPCOT1^^0^B41706537
"BLD",7271,"KRN",9.8,"NM",23,0)
MDRPCOT2^^0^B44563560
"BLD",7271,"KRN",9.8,"NM",24,0)
MDRPCOTH^^0^B22669741
"BLD",7271,"KRN",9.8,"NM",25,0)
MDHL7K1^^0^B3829311
"BLD",7271,"KRN",9.8,"NM",26,0)
MDPSU^^0^B64018431
"BLD",7271,"KRN",9.8,"NM",27,0)
MDPSUL^^0^B4032954
"BLD",7271,"KRN",9.8,"NM",28,0)
MDHL7BH^^0^B22756208
"BLD",7271,"KRN",9.8,"NM",29,0)
MDWOR^^0^B40304234
"BLD",7271,"KRN",9.8,"NM",30,0)
MDWORSR^^0^B57541495
"BLD",7271,"KRN",9.8,"NM",31,0)
MDRPCWU^^0^B2706250
"BLD",7271,"KRN",9.8,"NM",32,0)
MDNCHK^^0^B2544252
"BLD",7271,"KRN",9.8,"NM","B","MDAR7M",9)

"BLD",7271,"KRN",9.8,"NM","B","MDARSET",19)

"BLD",7271,"KRN",9.8,"NM","B","MDCLN",15)

"BLD",7271,"KRN",9.8,"NM","B","MDHL7A",1)

"BLD",7271,"KRN",9.8,"NM","B","MDHL7BH",28)

"BLD",7271,"KRN",9.8,"NM","B","MDHL7K1",25)

"BLD",7271,"KRN",9.8,"NM","B","MDHL7U3",13)

"BLD",7271,"KRN",9.8,"NM","B","MDHL7XXX",16)

"BLD",7271,"KRN",9.8,"NM","B","MDNCHK",32)

"BLD",7271,"KRN",9.8,"NM","B","MDPCE",2)

"BLD",7271,"KRN",9.8,"NM","B","MDPCE2",3)

"BLD",7271,"KRN",9.8,"NM","B","MDPS1",20)

"BLD",7271,"KRN",9.8,"NM","B","MDPSU",26)

"BLD",7271,"KRN",9.8,"NM","B","MDPSUL",27)

"BLD",7271,"KRN",9.8,"NM","B","MDRPCNT1",4)

"BLD",7271,"KRN",9.8,"NM","B","MDRPCOT",21)

"BLD",7271,"KRN",9.8,"NM","B","MDRPCOT1",22)

"BLD",7271,"KRN",9.8,"NM","B","MDRPCOT2",23)

"BLD",7271,"KRN",9.8,"NM","B","MDRPCOTH",24)

"BLD",7271,"KRN",9.8,"NM","B","MDRPCW",10)

"BLD",7271,"KRN",9.8,"NM","B","MDRPCW1",12)

"BLD",7271,"KRN",9.8,"NM","B","MDRPCWU",31)

"BLD",7271,"KRN",9.8,"NM","B","MDSTUDW",14)

"BLD",7271,"KRN",9.8,"NM","B","MDWCAN",7)

"BLD",7271,"KRN",9.8,"NM","B","MDWOR",29)

"BLD",7271,"KRN",9.8,"NM","B","MDWORSR",30)

"BLD",7271,"KRN",19,0)
19
"BLD",7271,"KRN",19,"NM",0)
^9.68A^3^3
"BLD",7271,"KRN",19,"NM",1,0)
MD PROC W/INCOMPLETE WORKLOAD^^0
"BLD",7271,"KRN",19,"NM",2,0)
MD PROCESS RESULTS^^0
"BLD",7271,"KRN",19,"NM",3,0)
MD HIGH VOLUME PROCEDURE SETUP^^0
"BLD",7271,"KRN",19,"NM","B","MD HIGH VOLUME PROCEDURE SETUP",3)

"BLD",7271,"KRN",19,"NM","B","MD PROC W/INCOMPLETE WORKLOAD",1)

"BLD",7271,"KRN",19,"NM","B","MD PROCESS RESULTS",2)

"BLD",7271,"KRN",19.1,0)
19.1
"BLD",7271,"KRN",101,0)
101
"BLD",7271,"KRN",409.61,0)
409.61
"BLD",7271,"KRN",771,0)
771
"BLD",7271,"KRN",779.2,0)
779.2
"BLD",7271,"KRN",870,0)
870
"BLD",7271,"KRN",8989.51,0)
8989.51
"BLD",7271,"KRN",8989.51,"NM",0)
^9.68A^3^3
"BLD",7271,"KRN",8989.51,"NM",1,0)
MD GET HIGH VOLUME^^0
"BLD",7271,"KRN",8989.51,"NM",2,0)
MD NOT ADMN CLOSE MUSE NOTE^^0
"BLD",7271,"KRN",8989.51,"NM",3,0)
MD USE NOTE^^0
"BLD",7271,"KRN",8989.51,"NM","B","MD GET HIGH VOLUME",1)

"BLD",7271,"KRN",8989.51,"NM","B","MD NOT ADMN CLOSE MUSE NOTE",2)

"BLD",7271,"KRN",8989.51,"NM","B","MD USE NOTE",3)

"BLD",7271,"KRN",8989.52,0)
8989.52
"BLD",7271,"KRN",8994,0)
8994
"BLD",7271,"KRN","B",.4,.4)

"BLD",7271,"KRN","B",.401,.401)

"BLD",7271,"KRN","B",.402,.402)

"BLD",7271,"KRN","B",.403,.403)

"BLD",7271,"KRN","B",.5,.5)

"BLD",7271,"KRN","B",.84,.84)

"BLD",7271,"KRN","B",3.6,3.6)

"BLD",7271,"KRN","B",3.8,3.8)

"BLD",7271,"KRN","B",9.2,9.2)

"BLD",7271,"KRN","B",9.8,9.8)

"BLD",7271,"KRN","B",19,19)

"BLD",7271,"KRN","B",19.1,19.1)

"BLD",7271,"KRN","B",101,101)

"BLD",7271,"KRN","B",409.61,409.61)

"BLD",7271,"KRN","B",771,771)

"BLD",7271,"KRN","B",779.2,779.2)

"BLD",7271,"KRN","B",870,870)

"BLD",7271,"KRN","B",8989.51,8989.51)

"BLD",7271,"KRN","B",8989.52,8989.52)

"BLD",7271,"KRN","B",8994,8994)

"BLD",7271,"QUES",0)
^9.62^^
"BLD",7271,"REQB",0)
^9.611^2^2
"BLD",7271,"REQB",1,0)
MD*1.0*11^2
"BLD",7271,"REQB",2,0)
MD*1.0*13^2
"BLD",7271,"REQB","B","MD*1.0*11",1)

"BLD",7271,"REQB","B","MD*1.0*13",2)

"INIT")
MDPOST21
"KRN",19,12952,-1)
0^1
"KRN",19,12952,0)
MD PROC W/INCOMPLETE WORKLOAD^Print list of Procedure with incomplete workload^^R^^^^^^^^CLINICAL PROCEDURES
"KRN",19,12952,1,0)
^^2^2^3090302^
"KRN",19,12952,1,1,0)
This option prints a list of procedures that has incomplete workload
"KRN",19,12952,1,2,0)
for the visit.
"KRN",19,12952,25)
E1^MDSTUDW
"KRN",19,12952,"U")
PRINT LIST OF PROCEDURE WITH I
"KRN",19,12959,-1)
0^2
"KRN",19,12959,0)
MD PROCESS RESULTS^MD Process Results^^R^^^^^^^^CLINICAL PROCEDURES^^1
"KRN",19,12959,1,0)
^^2^2^3090519^
"KRN",19,12959,1,1,0)
This task is ran daily for every hour to process results and update
"KRN",19,12959,1,2,0)
Consults package.
"KRN",19,12959,20)
N ZTSAVE S ZTSAVE("DUZ")=DUZ,ZTSAVE("DUZ(")=""
"KRN",19,12959,25)
PROCESS^MDHL7XXX
"KRN",19,12959,"U")
MD PROCESS RESULTS
"KRN",19,13001,-1)
0^3
"KRN",19,13001,0)
MD HIGH VOLUME PROCEDURE SETUP^High Volume Procedure Setup^^R^^^^^^^^CLINICAL PROCEDURES
"KRN",19,13001,1,0)
^^4^4^3090629^
"KRN",19,13001,1,1,0)
This option will populate the XPAR Parameters MD GET HIGH VOLUME and
"KRN",19,13001,1,2,0)
MD NOT ADMN CLOSE MUSE NOTE.  It will let the user populate a list of
"KRN",19,13001,1,3,0)
Clinical Procedures procedures set it up for high volume procedure 
"KRN",19,13001,1,4,0)
process.
"KRN",19,13001,25)
EN1^MDARSET
"KRN",19,13001,"U")
HIGH VOLUME PROCEDURE SETUP
"KRN",8989.51,507,-1)
0^1
"KRN",8989.51,507,0)
MD GET HIGH VOLUME^Get High Volume^1^Procedure^Get String
"KRN",8989.51,507,1)
F^^
"KRN",8989.51,507,6)
P^702.01^Enter a high volume procedure.
"KRN",8989.51,507,8)
I +$P(^MDS(702.01,+Y,0),"^",6)'=2&(+$P(^MDS(702.01,+Y,0),"^",11)'=2)&($P(^MDS(702.01,+Y,0),"^",9)>0)
"KRN",8989.51,507,20,0)
^^7^7^3090701^
"KRN",8989.51,507,20,1,0)
This parameter will contain a free text string that contains two pieces
"KRN",8989.51,507,20,2,0)
of data delimited by a semicolon ';'.  The two pieces of data are: 1)
"KRN",8989.51,507,20,3,0)
1/0 (Yes/No) to indicate whether or not the text of the result should be
"KRN",8989.51,507,20,4,0)
added to the note, 2) 1/0 (Yes/No) to enter the text of the result as the
"KRN",8989.51,507,20,5,0)
significant finding of the Consult. (If you enter a 0, the note will be
"KRN",8989.51,507,20,6,0)
auto closed with the text inside.)
"KRN",8989.51,507,20,7,0)
Example string: 1;0
"KRN",8989.51,507,30,0)
^8989.513I^1^1
"KRN",8989.51,507,30,1,0)
1^4.2
"KRN",8989.51,521,-1)
0^2
"KRN",8989.51,521,0)
MD NOT ADMN CLOSE MUSE NOTE^NOT ADMN Close Muse Note^0^^Yes/No^0
"KRN",8989.51,521,1)
Y
"KRN",8989.51,521,20,0)
^^4^4^3090619^
"KRN",8989.51,521,20,1,0)
This parameter is used to indicate the note should not be 
"KRN",8989.51,521,20,2,0)
administratively closed with the proxy user CLINICAL, DEVICE PROXY 
"KRN",8989.51,521,20,3,0)
SERVICE but the interpreter of the procedure for the MUSE device.
"KRN",8989.51,521,20,4,0)
The default is "No".
"KRN",8989.51,521,30,0)
^8989.513I^1^1
"KRN",8989.51,521,30,1,0)
1^4.2
"KRN",8989.51,540,-1)
0^3
"KRN",8989.51,540,0)
MD USE NOTE^Use Note^^^Yes/No
"KRN",8989.51,540,1)
Y
"KRN",8989.51,540,20,0)
^^3^3^3090825^
"KRN",8989.51,540,20,1,0)
This parameter indicates that Clinical Procedures will use the note
"KRN",8989.51,540,20,2,0)
for the text of the result instead of the Significant Finding field in
"KRN",8989.51,540,20,3,0)
Consult.
"KRN",8989.51,540,30,0)
^8989.513I^1^1
"KRN",8989.51,540,30,1,0)
1^4.2
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",365,-1)
1^1
"PKG",365,0)
CLINICAL PROCEDURES^MD^Clinical Procedures
"PKG",365,20,0)
^9.402P^^
"PKG",365,22,0)
^9.49I^1^1
"PKG",365,22,1,0)
1.0^3090522^2980529^363
"PKG",365,22,1,"PAH",1,0)
21^3100430
"PKG",365,22,1,"PAH",1,1,0)
^^2^2^3100430
"PKG",365,22,1,"PAH",1,1,1,0)
Please refer to the National Patch Module for the detail of this 
"PKG",365,22,1,"PAH",1,1,2,0)
patch build.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
27
"RTN","MDAR7M")
0^9^B23544832^n/a
"RTN","MDAR7M",1,0)
MDAR7M ; HOIFO/NCA - Get Text Impression ;2/27/09  12:38
"RTN","MDAR7M",2,0)
 ;;1.0;Clinical Procedures;**21**;Apr 01, 2004;Build 30
"RTN","MDAR7M",3,0)
 ; Integration Agreement:
"RTN","MDAR7M",4,0)
 ;       IA #  2263 [Supported] XPAR Calls
"RTN","MDAR7M",5,0)
 ;            10103 [Supported] XLFDT Calls
"RTN","MDAR7M",6,0)
 ;            10104 [Supported] Calls to XLFSTR
"RTN","MDAR7M",7,0)
 ;
"RTN","MDAR7M",8,0)
GETTXT(MDTXR,RECID) ; Get text impression
"RTN","MDAR7M",9,0)
 N CCNT,CNT,CODE,ICNT,LAST,LL,LNE,MDAR,MDC,MDCH,MDFG,MDHLST,MDK,MDMUSE,MDNAD,MDOBR,MDPENT,MDPN,MDRESL,MDSY,MDX,SEG,TXT,UNITS,VAL,X,XN S (ICNT,MDFG,MDPENT)=0,(MDOBR,MDPN)=""
"RTN","MDAR7M",10,0)
 Q:'+$G(RECID)
"RTN","MDAR7M",11,0)
 S MDRESL=+$P($G(^MDD(703.1,+RECID,0)),"^",6)
"RTN","MDAR7M",12,0)
 S MDSY=+$P($G(^MDD(703.1,+RECID,0)),"^",5) Q:'MDSY
"RTN","MDAR7M",13,0)
 D GETLST^XPAR(.MDHLST,"SYS","MD GET HIGH VOLUME")
"RTN","MDAR7M",14,0)
 F MDK=0:0 S MDK=$O(MDHLST(MDK)) Q:MDK<1  I $P($G(MDHLST(MDK)),"^")=+$P(^MDD(702,+MDSY,0),U,4) S MDFG=$P($G(MDHLST(MDK)),"^",2) Q
"RTN","MDAR7M",15,0)
 S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="** DOCUMENT IN VISTA IMAGING **"
"RTN","MDAR7M",16,0)
 S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="SEE FULL REPORT IN VISTA IMAGING",ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)=""
"RTN","MDAR7M",17,0)
 I '$P(MDFG,";",2) S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="SIGNATURE NOT REQUIRED"
"RTN","MDAR7M",18,0)
 I '$P(MDFG,";",2) S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="SEE SIGNATURE IN VISTA IMAGING",ICNT=ICNT+1
"RTN","MDAR7M",19,0)
 S MDTXR("TEXT",ICNT,0)=""
"RTN","MDAR7M",20,0)
 Q:'+MDFG
"RTN","MDAR7M",21,0)
 Q:+$P($G(^MDS(702.01,+$P(^MDD(702,+MDSY,0),U,4),0)),"^",6)=2
"RTN","MDAR7M",22,0)
 Q:+$P($G(^MDS(702.01,+$P(^MDD(702,+MDSY,0),U,4),0)),"^",11)=2
"RTN","MDAR7M",23,0)
 S (MDNAD,MDMUSE,MDPENT)=0
"RTN","MDAR7M",24,0)
 I +$$GET^XPAR("SYS","MD NOT ADMN CLOSE MUSE NOTE",1) S MDNAD=1
"RTN","MDAR7M",25,0)
 S:$$UP^XLFSTR($$GET1^DIQ(702,+MDSY_",",".11","E"))["PENTAX" MDPENT=1
"RTN","MDAR7M",26,0)
 S:$$UP^XLFSTR($$GET1^DIQ(702,+MDSY_",",".11","E"))["MUSE" MDMUSE=1
"RTN","MDAR7M",27,0)
 Q:'MDRESL
"RTN","MDAR7M",28,0)
 Q:'$D(^TMP($J,"MDHL7A"))
"RTN","MDAR7M",29,0)
 S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="** ("_$$GET1^DIQ(702,+MDSY_",",".11","E")_")  AUTO-INSTRUMENT DIAGNOSIS **",ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)=""
"RTN","MDAR7M",30,0)
 S LAST=$O(^TMP($J,"MDHL7A",""),-1)
"RTN","MDAR7M",31,0)
 F MDK=1:1:LAST S XN=$G(^TMP($J,"MDHL7A",MDK)),TXT="" D
"RTN","MDAR7M",32,0)
 .I $P(XN,"|",1)="OBR" S SEG=XN S (MDOBR,TXT)=$$OBR(SEG) I TXT'="" D
"RTN","MDAR7M",33,0)
 ..S MDPN=$P(TXT,";",5) I MDPN["99999" S MDPN=$P(MDPN,"99999",2)
"RTN","MDAR7M",34,0)
 ..I MDPN'="" S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="Procedure: "_MDPN
"RTN","MDAR7M",35,0)
 ..S LNE=""
"RTN","MDAR7M",36,0)
 ..I $P(TXT,";",2)'="" S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="",ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="Release Status: "_$P(TXT,";",2)
"RTN","MDAR7M",37,0)
 ..I $P(TXT,";")'="" S LNE="Date Verified: "_$P(TXT,";"),ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)=LNE
"RTN","MDAR7M",38,0)
 ..I $P(TXT,";",3)'=""&(+MDMUSE) S LNE="Interpreter: "_$P(TXT,";",3),ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)=LNE
"RTN","MDAR7M",39,0)
 ..I $P(TXT,";",3)'=""&(+MDMUSE)&(+MDNAD) S MDTXR(1202)=$P(TXT,";",6),MDTXR(1204)=$P(TXT,";",6),MDTXR(1302)=$P(TXT,";",6)
"RTN","MDAR7M",40,0)
 ..S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="" Q
"RTN","MDAR7M",41,0)
 .I $P(XN,"|",1)="OBX" S SEG=XN Q:$P(SEG,"|",3)="ST"&($P(SEG,"|",6)["^")  Q:'MDPENT&($P(MDOBR,";")="")&($P(MDOBR,";",4)="")  S TXT=$$OBX(SEG) D
"RTN","MDAR7M",42,0)
 ..I $P(SEG,"|",3)'="ST" S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)=TXT Q
"RTN","MDAR7M",43,0)
 ..S CODE=$P(SEG,"|",4),VAL=$P(SEG,"|",6),UNITS=$P(SEG,"|",7),CCNT=$L(VAL),CNT=0
"RTN","MDAR7M",44,0)
 ..I CODE["^" S CODE=$S(+$P(CODE,"^",1):+$P(CODE,"^",1)_"  "_$P(CODE,"^",2),1:$P(CODE,"^",2))
"RTN","MDAR7M",45,0)
 ..Q:CODE=""!(VAL="")
"RTN","MDAR7M",46,0)
 ..Q:VAL["\\"
"RTN","MDAR7M",47,0)
 ..I $L(VAL)<50 S LNE=$E(CODE_":"_$J("",30),1,30)_VAL S:UNITS'="" LNE=$E(LNE_$J("",10),1,38)_UNITS S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)=LNE Q
"RTN","MDAR7M",48,0)
 ..E  K MDAR S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)=$E(CODE_":"_$J("",30),1,30) D WP(.MDAR,VAL,CNT) F MDC=0:0 S MDC=$O(MDAR(MDC)) Q:MDC<1  S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)=$G(MDAR(MDC))
"RTN","MDAR7M",49,0)
 ..S ICNT=ICNT+1,MDTXR("TEXT",ICNT,0)="" Q
"RTN","MDAR7M",50,0)
 .Q
"RTN","MDAR7M",51,0)
 Q
"RTN","MDAR7M",52,0)
OBR(SEGM) ; Get OBR
"RTN","MDAR7M",53,0)
 N EXAM,LINE,X,XNM
"RTN","MDAR7M",54,0)
 S EXAM=$P($P(SEGM,"|",5),"^",1) S:EXAM="" EXAM=99999
"RTN","MDAR7M",55,0)
 S EXAM=EXAM_"  "_$P($P(SEGM,"|",5),"^",2)
"RTN","MDAR7M",56,0)
 ; S SGET=Date verified;Release status;Interpreter;Result status;Interpreter ien
"RTN","MDAR7M",57,0)
 S X=$P(SEGM,"|",23) I X>0 S SGET=$$HL7TFM^XLFDT(X)_";"_"Released Off-Line Verified" ;
"RTN","MDAR7M",58,0)
 S X=$P($P(SEGM,"|",33),"^",1)
"RTN","MDAR7M",59,0)
 S XNM=$$GET1^DIQ(200,X,.01,"I")
"RTN","MDAR7M",60,0)
 I +X,XNM'="" S $P(SGET,";",3)=XNM,$P(SGET,";",6)=+X
"RTN","MDAR7M",61,0)
 S X=$P($G(SGET),";")
"RTN","MDAR7M",62,0)
 I X'="" S $P(SGET,";")=$$FMTE^XLFDT(X)
"RTN","MDAR7M",63,0)
 S:$P(SEGM,"|",26)="F" $P(SGET,";",4)="F"
"RTN","MDAR7M",64,0)
 S:$P(SEGM,"|",26)="C" $P(SGET,";",4)="C"
"RTN","MDAR7M",65,0)
 S $P(SGET,";",5)=EXAM
"RTN","MDAR7M",66,0)
 Q SGET
"RTN","MDAR7M",67,0)
OBX(SEGM) ; Process OBX
"RTN","MDAR7M",68,0)
 N CODE,LINE,STYP,VAL,X1
"RTN","MDAR7M",69,0)
 S X1=$G(SEGM)
"RTN","MDAR7M",70,0)
 S STYP=$P(X1,"|",3) Q:STYP="ST" ""
"RTN","MDAR7M",71,0)
 S CODE=$P(X1,"|",4),VAL=$P(X1,"|",6),UNITS=$P(X1,"|",7) I CODE["^" S CODE=$S(+$P(CODE,"^",1):+$P(CODE,"^",1)_"  "_$P(CODE,"^",2),1:$P(CODE,"^",2))
"RTN","MDAR7M",72,0)
 I CODE=""!(VAL="") Q ""
"RTN","MDAR7M",73,0)
 I STYP="CE" S VAL=$P(VAL,"^",2)
"RTN","MDAR7M",74,0)
 Q:VAL["\\" ""
"RTN","MDAR7M",75,0)
 I STYP="TX"!(STYP="FT") Q VAL
"RTN","MDAR7M",76,0)
 I STYP="CE" S LINE=$E(CODE_":"_$J("",30),1,30)_VAL Q LINE
"RTN","MDAR7M",77,0)
 I STYP="XCN" S VAL=$P(VAL,"^",3)_" "_$P(VAL,"^",4)_" "_$P(VAL,"^",2)_" "_$P(VAL,"^",7),LINE=$E(CODE_":"_$J("",30),1,30)_VAL Q LINE
"RTN","MDAR7M",78,0)
 I STYP="DT"!(STYP="TS") S VAL=$$HL7TFM^XLFDT(VAL),VAL=$$FMTE^XLFDT(VAL) S LINE=$E(CODE_":"_$J("",30),1,30)_VAL Q LINE
"RTN","MDAR7M",79,0)
 S LINE=$E(CODE_":"_$J("",30),1,30)_VAL
"RTN","MDAR7M",80,0)
 I UNITS'="" S LINE=$E(LINE_$J("",10),1,38)_UNITS
"RTN","MDAR7M",81,0)
 Q LINE
"RTN","MDAR7M",82,0)
WP(MDGAR,LTXT,MDJ) ; Process Word Process lines
"RTN","MDAR7M",83,0)
 N LOP
"RTN","MDAR7M",84,0)
LOOP I $L(LTXT)<70 S MDJ=MDJ+1,MDGAR(MDJ)=$J("",10)_LTXT Q
"RTN","MDAR7M",85,0)
 F LOP=70:-1:1 Q:$E(LTXT,LOP)?1P
"RTN","MDAR7M",86,0)
 S MDJ=MDJ+1,MDGAR(MDJ)=$J("",10)_$E(LTXT,1,LOP-1)
"RTN","MDAR7M",87,0)
 S LTXT=$E(LTXT,LOP+1,999) G LOOP
"RTN","MDARSET")
0^19^B19742072^n/a
"RTN","MDARSET",1,0)
MDARSET ; HOIFO/NCA - High Volume Check-In Setup ;6/30/09  10:00
"RTN","MDARSET",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDARSET",3,0)
 ; Reference IA # 2263 [Supported] XPAR parameter calls
"RTN","MDARSET",4,0)
 ;               10104 [Supported] XLFSTR call
"RTN","MDARSET",5,0)
 ;
"RTN","MDARSET",6,0)
EN1 ; Entry Point for the setup option
"RTN","MDARSET",7,0)
 N MDAPT,MDAR,MDCP,MDCP1,MDCT,MDDEF,MDERR,MDKK,MDLST,MDLST1,MDMF,MDNOD,MDVAL,MDX,MDX1,X,Y S (MDMF,MDCT)=0
"RTN","MDARSET",8,0)
 D GETLST^XPAR(.MDLST,"SYS","MD GET HIGH VOLUME")
"RTN","MDARSET",9,0)
 F MDKK=0:0 S MDKK=$O(MDLST(MDKK)) Q:MDKK<1  S MDX=$G(MDLST(MDKK)),MDLST1(+MDX)=MDKK_"^"_$P(MDX,"^",2),MDCT=MDCT+1
"RTN","MDARSET",10,0)
 S MDAR=$$GET^XPAR("SYS","MD NOT ADMN CLOSE MUSE NOTE",1)
"RTN","MDARSET",11,0)
A1 ; Ask for procedure parameter
"RTN","MDARSET",12,0)
 S (MDCP1,MDDEF)="",MDCP1="NO"
"RTN","MDARSET",13,0)
 W !!,"Procedure: " R X:DTIME G:'$T!("^"[X) KIL
"RTN","MDARSET",14,0)
 I X["?" D PHELP
"RTN","MDARSET",15,0)
 K DIC S DIC="^MDS(702.01,",DIC(0)="EQMZ",DIC("S")="I +$P(^(0),U,9)>0&(+$P(^(0),U,6)'=2)&(+$P(^(0),U,11)'=2)"
"RTN","MDARSET",16,0)
 D ^DIC K DIC G A1:"^"[X!$D(DTOUT),A1:Y<1
"RTN","MDARSET",17,0)
 S MDCP=+Y,MDNOD=""
"RTN","MDARSET",18,0)
 S MDMF=$$MUSE(MDCP)
"RTN","MDARSET",19,0)
 I $G(MDLST1(MDCP))'="" S MDDEF=+$P($G(MDLST1(MDCP)),"^",2),MDCP1=+$P($P($G(MDLST1(MDCP)),"^",2),";",2)
"RTN","MDARSET",20,0)
 I $G(MDLST1(MDCP))="" G A2
"RTN","MDARSET",21,0)
A11 ; Ask to delete an existing entry
"RTN","MDARSET",22,0)
 K DIR S DIR(0)="YA",DIR("A")="Delete current procedure setup? ",DIR("B")="NO",DIR("?")="Enter either 'Y' or 'N'."
"RTN","MDARSET",23,0)
 S DIR("?",1)="Enter Yes or No, if you want to delete the setup for the procedure."
"RTN","MDARSET",24,0)
 D ^DIR G:$D(DIRUT)!$D(DIROUT)!(Y<0) KIL K DIR
"RTN","MDARSET",25,0)
 I +Y D EN^XPAR("SYS","MD GET HIGH VOLUME",$P($G(^MDS(702.01,+MDCP,0)),"^",1),"@") D:+MDMF EN^XPAR("SYS","MD NOT ADMN CLOSE MUSE NOTE",1,0) W "...Procedure deleted" D  G A1
"RTN","MDARSET",26,0)
 .S MDNOD=+MDLST1(MDCP) K MDLST1(MDCP),MDLST(+MDNOD) Q
"RTN","MDARSET",27,0)
A2 ; Get Text
"RTN","MDARSET",28,0)
 K DIR S DIR(0)="YA",DIR("A")="Get Text? " S:MDDEF'="" DIR("B")=$S(+MDDEF:"Yes",1:"No") S DIR("?")="Enter either 'Y' or 'N'."
"RTN","MDARSET",29,0)
 S DIR("?",1)="Indicate whether the text from the result should or should not"
"RTN","MDARSET",30,0)
 S DIR("?",2)="be obtained."
"RTN","MDARSET",31,0)
 D ^DIR G:$D(DIRUT)!$D(DIROUT)!(Y<0) KIL K DIR
"RTN","MDARSET",32,0)
 S MDDEF=Y
"RTN","MDARSET",33,0)
 I '+MDDEF S MDVAL=MDDEF_";"_0 D:+MDMF EN^XPAR("SYS","MD NOT ADMN CLOSE MUSE NOTE",1,0) G SET
"RTN","MDARSET",34,0)
 I '+MDMF G A4
"RTN","MDARSET",35,0)
A3 ; Use Interpreter to close the note
"RTN","MDARSET",36,0)
 K DIR S DIR(0)="YA",DIR("A")="Use Interpreter to close note? " S:MDAR'="" DIR("B")=$S(+MDAR:"Yes",1:"No") S DIR("?")="Enter either 'Y' or 'N'."
"RTN","MDARSET",37,0)
 S DIR("?",1)="If 'YES', the interpreter of the result will be used to close"
"RTN","MDARSET",38,0)
 S DIR("?",2)="the note.  If 'NO', the Proxy service will be used."
"RTN","MDARSET",39,0)
 D ^DIR G:$D(DIRUT)!$D(DIROUT)!(Y<0) KIL K DIR
"RTN","MDARSET",40,0)
 D EN^XPAR("SYS","MD NOT ADMN CLOSE MUSE NOTE",1,Y)
"RTN","MDARSET",41,0)
 I +Y S MDVAL=MDDEF_";"_0 D EN^XPAR("SYS","MD GET HIGH VOLUME","`"_+MDCP,MDVAL) D  G A1
"RTN","MDARSET",42,0)
 .S MDNOD=$G(MDLST1(MDCP)) I MDNOD="" S MDCT=MDCT+1,MDLST1(MDCP)=MDCT_"^"_MDVAL,MDLST(MDCT)=MDCP_"^"_MDVAL Q
"RTN","MDARSET",43,0)
 .I MDNOD'="" S $P(MDNOD,"^",2)=MDVAL,MDLST1(MDCP)=MDNOD,$P(MDLST(+MDNOD),"^",2)=MDVAL Q
"RTN","MDARSET",44,0)
 .Q
"RTN","MDARSET",45,0)
A4 ; Use CP Method
"RTN","MDARSET",46,0)
 K DIR S DIR(0)="YA",DIR("A")="Do Not Auto Close Note? " S:MDCP1'="" DIR("B")=$S(+MDCP1:"Yes",1:"No") S DIR("?")="Enter either 'Y' or 'N'."
"RTN","MDARSET",47,0)
 S DIR("?",1)="If 'YES', the text of the result will be in the significant finding of the procedure."
"RTN","MDARSET",48,0)
 S DIR("?",2)="If 'NO', the default auto closure will be used."
"RTN","MDARSET",49,0)
 D ^DIR G:$D(DIRUT)!$D(DIROUT)!(Y<0) KIL K DIR
"RTN","MDARSET",50,0)
 S MDCP1=Y,MDVAL=MDDEF_";"_MDCP1
"RTN","MDARSET",51,0)
SET ; Set parameter
"RTN","MDARSET",52,0)
 D EN^XPAR("SYS","MD GET HIGH VOLUME","`"_+MDCP,MDVAL)
"RTN","MDARSET",53,0)
 S MDNOD=$G(MDLST1(MDCP)) I MDNOD="" S MDCT=MDCT+1,MDLST1(MDCP)=MDCT_"^"_MDVAL,MDLST(MDCT)=MDCP_"^"_MDVAL G A1
"RTN","MDARSET",54,0)
 I MDNOD'="" S $P(MDNOD,"^",2)=MDVAL,MDLST1(MDCP)=MDNOD,$P(MDLST(+MDNOD),"^",2)=MDVAL
"RTN","MDARSET",55,0)
 G A1
"RTN","MDARSET",56,0)
KIL ; kill DIR variables
"RTN","MDARSET",57,0)
 K DIC,DIR,DIROUT,DIRUT,DTOUT
"RTN","MDARSET",58,0)
 Q
"RTN","MDARSET",59,0)
MUSE(MDP) ; Check if procedure has Muse as a device
"RTN","MDARSET",60,0)
 N MDM,MDLL,MDINL S MDM=0
"RTN","MDARSET",61,0)
 Q:'$G(MDP)
"RTN","MDARSET",62,0)
 S MDLL=0 F  S MDLL=$O(^MDS(702.01,+MDP,.1,MDLL)) Q:MDLL<1  S MDINL=+$G(^(MDLL,0)) D  Q:+MDM
"RTN","MDARSET",63,0)
 .S:$$UP^XLFSTR($$GET1^DIQ(702.09,MDINL_",",".01","E"))["MUSE" MDM=1
"RTN","MDARSET",64,0)
 Q MDM
"RTN","MDARSET",65,0)
PHELP ; Procedure list
"RTN","MDARSET",66,0)
 N MDCH,MDACN,MDNAU
"RTN","MDARSET",67,0)
 S MDNAU=+$$GET^XPAR("SYS","MD USE NOTE",1)
"RTN","MDARSET",68,0)
 S MDACN=$$GET^XPAR("SYS","MD NOT ADMN CLOSE MUSE NOTE",1)
"RTN","MDARSET",69,0)
 W ! F MDKK=0:0 S MDKK=$O(MDLST(MDKK)) Q:MDKK<1  S MDX=$G(MDLST(MDKK)),MDX1=$P(MDX,"^",2) D
"RTN","MDARSET",70,0)
 .S MDCH=0 S:+$$MUSE(+MDX) MDCH=1
"RTN","MDARSET",71,0)
 .W !,$P($G(^MDS(702.01,+MDX,0)),"^"),?45,$S(+$P(MDX1,";"):"Text",1:"No Text")
"RTN","MDARSET",72,0)
 .W ?55,$S((+$P(MDX1,";",2)&'+MDNAU):"SF",(+MDCH&+MDACN):"Muse Interpreter",(+$P(MDX1,";",2)&+MDNAU):"Not Auto",1:"Auto")
"RTN","MDARSET",73,0)
 W !
"RTN","MDARSET",74,0)
 Q
"RTN","MDCLN")
0^15^B494118^n/a
"RTN","MDCLN",1,0)
MDCLN ;HIOFO/NCA - Cleanup Disabled Studies ;4/19/01  11:52
"RTN","MDCLN",2,0)
 ;;1.0;Clinical Procedures;**21**;Apr 01, 2004;Build 30
"RTN","MDCLN",3,0)
 N MDLP,MDFDA
"RTN","MDCLN",4,0)
 S MDLP=0 F  S MDLP=$O(^MDK(704.202,"AS",2,MDLP)) Q:MDLP<1  D
"RTN","MDCLN",5,0)
 .I $P($G(^MDD(702,MDLP,0)),"^",9)'=3!($P($G(^MDD(702,MDLP,0)),"^",9)=3) D
"RTN","MDCLN",6,0)
 ..S MDFDA(702,+MDLP_",",.09)=3
"RTN","MDCLN",7,0)
 ..D FILE^DIE("","MDFDA") W !,+MDLP
"RTN","MDCLN",8,0)
 ..K MDFDA S MDFDA(704.202,+MDLP_",",.09)=0
"RTN","MDCLN",9,0)
 ..D FILE^DIE("","MDFDA")
"RTN","MDCLN",10,0)
 Q
"RTN","MDHL7A")
0^1^B49521176^B47975378
"RTN","MDHL7A",1,0)
MDHL7A ; HOIFO/WAA - Routine to Decode HL7 for CP ;05/21/09  15:57
"RTN","MDHL7A",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,11,21**;Apr 01, 2004;Build 30
"RTN","MDHL7A",3,0)
 ; Reference DBIA #10035 [Supported] for DPT calls.
"RTN","MDHL7A",4,0)
 ; Reference DBIA #10106 [Supported] for HLFNC calls.
"RTN","MDHL7A",5,0)
 ; Reference DBIA #10062 [Supported] for VADPT6 calls.
"RTN","MDHL7A",6,0)
 ; Reference DBIA #2701 [Supported] for MPIF001 calls
"RTN","MDHL7A",7,0)
 ; Reference DBIA #10096 [Supported] for ^%ZOSF calls
"RTN","MDHL7A",8,0)
EN ; [Procedure] Entry Point for Message Array in MSG
"RTN","MDHL7A",9,0)
 N %,BID,CODE,CPT,DA,DATE,DFN,DIK,DLCO,DTO,DZ,ERRTX,EXAM,EXE,MDFLAG,FIL
"RTN","MDHL7A",10,0)
 N I,ICNT,ID,IMP,J,K,LBL,LINO,LINE,LN,MDAPP,MDRTN,MG,MSG,N,NAM,NEXT,NUM
"RTN","MDHL7A",11,0)
 N ORIFN,P,PID,PIEN,S,SEG,SET,SEP,MDSSN,STR,STYP,SUB,TCNT,TXT,UNIQ,SEC
"RTN","MDHL7A",12,0)
 N UNITS,VA,VAL,X,XMBODY,XMDUZ,XMSUBJ,XMTO,Z,ZZ,Z1,Z2,MDERROR
"RTN","MDHL7A",13,0)
 N ECODE,MDIEN,MDOBX,NUMZ,PNAM,ZCODE,MDDEV,MDD702,DEVNAME,DEVIEN,MDQFLG
"RTN","MDHL7A",14,0)
 N MDIORD,MDHORD
"RTN","MDHL7A",15,0)
 K ^TMP($J,"MDHL7A"),^TMP($J,"MDHL7"),^TMP($J,"MDHL7A1")
"RTN","MDHL7A",16,0)
 S MDFLAG=0,MDERROR=0,MDQFLG=0,MDHORD=""
"RTN","MDHL7A",17,0)
 Q:$G(HLMTIENS)=""
"RTN","MDHL7A",18,0)
 S ^TMP($J,"MDHL7A1")=""
"RTN","MDHL7A",19,0)
 S HLREST="^TMP($J,""MDHL7A1"")"
"RTN","MDHL7A",20,0)
 S X=$$MSGIEN^MDHL7U3(HLMTIENS,HLREST) ; This code is to convert the HL7 Message **6**
"RTN","MDHL7A",21,0)
 I $P(X,U)=0 D  Q
"RTN","MDHL7A",22,0)
 . S DEVIEN=0,ECODE=0
"RTN","MDHL7A",23,0)
 . S ERRTX=$P(X,U,2)
"RTN","MDHL7A",24,0)
 . D ^MDHL7X
"RTN","MDHL7A",25,0)
 . Q
"RTN","MDHL7A",26,0)
 I $P(X,U)=1 D XVERT^MDHL7U3("MDHL7A1","MDHL7A")
"RTN","MDHL7A",27,0)
 K HLNODE,^TMP($J,"MDHL7A1")
"RTN","MDHL7A",28,0)
 ;
"RTN","MDHL7A",29,0)
EN2 ; [Procedure] No Description
"RTN","MDHL7A",30,0)
 S (DEVIEN,DEVNAME)="",I=0
"RTN","MDHL7A",31,0)
 F I=1:1 S X=$G(^TMP($J,"MDHL7A",I)) Q:X=""  Q:$E(X,1,3)="OBX"  D
"RTN","MDHL7A",32,0)
 . S:$E(X,1,3)="MSH" DEVNAME=$P(X,"|",4)
"RTN","MDHL7A",33,0)
 . I DEVNAME="",HLREC("SFN")'="" S DEVNAME=HLREC("SFN")
"RTN","MDHL7A",34,0)
 . I $E(X,1,3)="MSH",DEVNAME'="Instrument Manager" S DEVIEN=$O(^MDS(702.09,"B",DEVNAME,0))
"RTN","MDHL7A",35,0)
 . I $E(X,1,3)="OBR" D
"RTN","MDHL7A",36,0)
 .. I DEVNAME="Instrument Manager" D
"RTN","MDHL7A",37,0)
 ... S DEVNAME=$P(X,"|",25)
"RTN","MDHL7A",38,0)
 ... Q
"RTN","MDHL7A",39,0)
 .. S MDIORD=$P(X,"|",4)
"RTN","MDHL7A",40,0)
 .. S MDD702=$S(+MDIORD<1:"",1:$$GETSTDY^MDRPCOT1(MDIORD))
"RTN","MDHL7A",41,0)
 .. I MDD702<1 S MDD702="" Q
"RTN","MDHL7A",42,0)
 .. I MDD702>0 D  ;Validate the entry from 702 is good.
"RTN","MDHL7A",43,0)
 ... I $G(^MDD(702,MDD702,0))="" S MDD702="" Q
"RTN","MDHL7A",44,0)
 ... S DEVIEN=$$GET1^DIQ(702,MDD702,.11,"I")
"RTN","MDHL7A",45,0)
 ... I DEVIEN<1 S DEVIEN="" ; No device defined
"RTN","MDHL7A",46,0)
 ... Q
"RTN","MDHL7A",47,0)
 .. Q
"RTN","MDHL7A",48,0)
 . Q
"RTN","MDHL7A",49,0)
 I DEVIEN="",DEVNAME'="" S DEVIEN=$O(^MDS(702.09,"B",DEVNAME,0))
"RTN","MDHL7A",50,0)
 I DEVNAME="" S ERRTX="Invalid device Code" D ^MDHL7X Q
"RTN","MDHL7A",51,0)
 I DEVIEN="" S ERRTX="Invalid device entry "_DEVNAME D ^MDHL7X Q
"RTN","MDHL7A",52,0)
 S ZCODE=$P($G(^MDS(702.09,DEVIEN,.1)),"^",2)
"RTN","MDHL7A",53,0)
 S ECODE=0,INST=DEVIEN,MDAPP=DEVNAME
"RTN","MDHL7A",54,0)
 I 'INST S ERRTX="Invalid Application Code" D ^MDHL7X Q
"RTN","MDHL7A",55,0)
 D INST^MDHL7U2(DEVIEN,.ECODE) I 'ECODE D  Q
"RTN","MDHL7A",56,0)
 . S ERRTX="Device Error" D ^MDHL7X
"RTN","MDHL7A",57,0)
 . Q
"RTN","MDHL7A",58,0)
 I (ZCODE="M")!(ZCODE="B") D  Q:MDERROR  Q:ZCODE="M"  ;
"RTN","MDHL7A",59,0)
 . S MDFLAG=1,MDERROR=0 ; Tell Medicine that CP is talking to HL7
"RTN","MDHL7A",60,0)
 . D ^MDHL7MCA ; Run the Medicine routines
"RTN","MDHL7A",61,0)
 . Q:MDERROR  ; Medicine found an error and sent an error back
"RTN","MDHL7A",62,0)
 . Q
"RTN","MDHL7A",63,0)
 S NUMZ=$O(^TMP($J,"MDHL7A",""),-1)
"RTN","MDHL7A",64,0)
 S NUM=0,MDOBX=0
"RTN","MDHL7A",65,0)
 F NUM=1:1:NUMZ  D  Q:$G(ERRTX)'=""
"RTN","MDHL7A",66,0)
 . S LINO=^TMP($J,"MDHL7A",NUM)
"RTN","MDHL7A",67,0)
 . S SEC=$P(LINO,"|")
"RTN","MDHL7A",68,0)
 . I SEC="MSH" D MSH Q
"RTN","MDHL7A",69,0)
 . I SEC="PID" D PID Q
"RTN","MDHL7A",70,0)
 . I SEC="OBR" D OBR Q
"RTN","MDHL7A",71,0)
 . I SEC="PV1" Q
"RTN","MDHL7A",72,0)
 . I SEC="ORC" Q
"RTN","MDHL7A",73,0)
 . I SEC="OBX" S MDOBX=1 Q
"RTN","MDHL7A",74,0)
 . Q
"RTN","MDHL7A",75,0)
 Q:$G(ERRTX)'=""
"RTN","MDHL7A",76,0)
 I 'MDOBX S ERRTX="OBX not found when expected" D ^MDHL7X Q
"RTN","MDHL7A",77,0)
 D OBX
"RTN","MDHL7A",78,0)
 D STATUS(MDIEN,"P")
"RTN","MDHL7A",79,0)
 K ^TMP($J,"MDHL7A"),^TMP($J,"MDHL7")
"RTN","MDHL7A",80,0)
 Q
"RTN","MDHL7A",81,0)
STATUS(DA,STAT) ; Update the status of the report in 703.1
"RTN","MDHL7A",82,0)
 Q:$G(ERRTX)'=""
"RTN","MDHL7A",83,0)
 S $P(^MDD(703.1,DA,0),U,9)=STAT
"RTN","MDHL7A",84,0)
 S DIK="^MDD(703.1," D IX1^DIK
"RTN","MDHL7A",85,0)
 Q
"RTN","MDHL7A",86,0)
IM ;Instrument Manager Interface
"RTN","MDHL7A",87,0)
 Q:DEVNAME'="Instrument Manager"
"RTN","MDHL7A",88,0)
 I $E(X,1,3)'="OBR" Q
"RTN","MDHL7A",89,0)
 S DEVNAME=$P(X,"|",25)
"RTN","MDHL7A",90,0)
 S DEVIEN=$O(^MDS(702.09,"B",DEVNAME,0))
"RTN","MDHL7A",91,0)
 Q
"RTN","MDHL7A",92,0)
 ;
"RTN","MDHL7A",93,0)
MSH ; [Procedure] Decode MSH
"RTN","MDHL7A",94,0)
 N SEG
"RTN","MDHL7A",95,0)
 I '$D(^TMP($J,"MDHL7A",NUM)) Q
"RTN","MDHL7A",96,0)
 S X=$G(^TMP($J,"MDHL7A",NUM)),SEG("MSH")=X
"RTN","MDHL7A",97,0)
 I $E(X,1,3)'="MSH" S ERRTX="MSH not first record" D ^MDHL7X Q
"RTN","MDHL7A",98,0)
 Q
"RTN","MDHL7A",99,0)
 ;
"RTN","MDHL7A",100,0)
OBR ; [Procedure] Check OBR
"RTN","MDHL7A",101,0)
 Q:$G(MDHORD)'=""
"RTN","MDHL7A",102,0)
 N MDGMRC
"RTN","MDHL7A",103,0)
 S X=$G(^TMP($J,"MDHL7A",NUM)) I $E(X,1,3)'="OBR" S ERRTX="OBR not found when expected" D ^MDHL7X Q
"RTN","MDHL7A",104,0)
 S SEG("OBR")=X
"RTN","MDHL7A",105,0)
 S MDIORD=$P(X,"|",4)
"RTN","MDHL7A",106,0)
 S MDD702=$S(+MDIORD<1:"",1:$$GETSTDY^MDRPCOT1(MDIORD)) S:MDHORD="" MDHORD=MDD702
"RTN","MDHL7A",107,0)
 S:MDD702="" MDD702=MDHORD
"RTN","MDHL7A",108,0)
 I MDD702'="" S MDD702=$$CHK^MDNCHK(MDD702) ; PATCH 11
"RTN","MDHL7A",109,0)
 S ORIFN=$P(X,"|",3),(EXAM,%)=$P(X,"|",5) I EXAM'="" S EXAM=$P(%,"^",2) I EXAM="" S EXAM=$P(%,"^",1)
"RTN","MDHL7A",110,0)
 S CPT=$P(X,"|",5) I $P(CPT,"^",3)["CPT" S CPT=$P(CPT,"^",1)
"RTN","MDHL7A",111,0)
 S DTO="",DATE=$P(X,"|",8) I DATE'="" S:$L(DATE)>14 DATE=$E(DATE,1,14) S DTO=$$FMDATE^HLFNC(DATE)
"RTN","MDHL7A",112,0)
 ;  vvv== Added to address the issues of mismatch
"RTN","MDHL7A",113,0)
 I $G(MDD702)>0 I DFN'=$$GET1^DIQ(702,MDD702,.01,"I") S ERRTX="Patient name Mismatch. Name in PID doesn't match the name in the CP Order #"_MDD702_"." D ^MDHL7X Q
"RTN","MDHL7A",114,0)
 I $G(MDD702)>0 I MDDOB'=$$GET1^DIQ(2,DFN,.03,"I") S ERRTX="Patient DOB Mismatch. DOB in PID doesn't match the DOB in the CP Order #"_MDD702_"." D ^MDHL7X Q
"RTN","MDHL7A",115,0)
 I DTO="" S ERRTX="Missing required Date/Time of Procedure in OBR" D ^MDHL7X Q
"RTN","MDHL7A",116,0)
 ;;S UNIQ=$TR($H,",","-")
"RTN","MDHL7A",117,0)
 S UNIQ=$$NEWID(DFN,DATE,INST,$G(MDD702),HLMTIEN)
"RTN","MDHL7A",118,0)
 I +UNIQ="-1" S ERRTX="Unable to Create or Lock 703.1" D ^MDHL7X Q
"RTN","MDHL7A",119,0)
 S MDIEN=$P(UNIQ,"^",1) ; Got the IEN for 703.1
"RTN","MDHL7A",120,0)
 N SET S SET=DTO_"^"_$P(UNIQ,U,2),ICNT=0 N IMP
"RTN","MDHL7A",121,0)
 S MDRTN=$P($G(^MDS(702.09,INST,.1)),"^",1) S:MDRTN'["^" MDRTN="^"_MDRTN
"RTN","MDHL7A",122,0)
 S X=MDRTN S:X["^" X=$P(X,"^",2) X ^%ZOSF("TEST") I '$T S ERRTX="Processing routine not found" D ^MDHL7X Q  ; IA %10096
"RTN","MDHL7A",123,0)
 D CPTICD^MDHL7U3(X,MDIEN) ; Update CPT and ICD9
"RTN","MDHL7A",124,0)
 D PHY^MDHL7U3(X,MDIEN) ; Get Doc who did the procedure.
"RTN","MDHL7A",125,0)
 Q
"RTN","MDHL7A",126,0)
 ;
"RTN","MDHL7A",127,0)
PID ; [Procedure] Check PID
"RTN","MDHL7A",128,0)
 S X=$G(^TMP($J,"MDHL7A",NUM)) I $E(X,1,3)'="PID" S ERRTX="PID not second record" D ^MDHL7X Q
"RTN","MDHL7A",129,0)
 S SEG("PID")=X
"RTN","MDHL7A",130,0)
 S MDDOB=$P(X,"|",8) I MDDOB'="" S MDDOB=($E(MDDOB,1,4)-1700)_$E(MDDOB,5,8)
"RTN","MDHL7A",131,0)
 I $L($P(X,"|",4))'<16 D  I +DFN=-1 Q
"RTN","MDHL7A",132,0)
 . N ICN
"RTN","MDHL7A",133,0)
 . S ICN=$P(X,"|",4)
"RTN","MDHL7A",134,0)
 . S DFN=$$GETDFN^MPIF001(ICN)
"RTN","MDHL7A",135,0)
 . I +DFN=-1 S ERRTX=$P(DFN,U,2)
"RTN","MDHL7A",136,0)
 . D MDSSN I DFN<1 S ERRTX="SSN not found" D ^MDHL7X Q
"RTN","MDHL7A",137,0)
 . I DFN>0 K ERRTX
"RTN","MDHL7A",138,0)
 . S MDSSN=$$GET1^DIQ(2,DFN,.09,"I") I MDSSN="" S MDSSN=" ",DFN=0
"RTN","MDHL7A",139,0)
 . Q
"RTN","MDHL7A",140,0)
 E  D MDSSN
"RTN","MDHL7A",141,0)
 I 'DFN S ERRTX="SSN not found" D ^MDHL7X Q
"RTN","MDHL7A",142,0)
 S Z1=$P($G(^DPT(DFN,0)),",",1),Z2=$P(NAM,"^",1)
"RTN","MDHL7A",143,0)
 S Z1=$TR(Z1,"abcdefghijklmnopqrstuvwxyz- '","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MDHL7A",144,0)
 S Z2=$TR(Z2,"abcdefghijklmnopqrstuvwxyz- '","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MDHL7A",145,0)
 I $E(Z1,1,3)'=$E(Z2,1,3) S ERRTX="Last Name MisMatch" D ^MDHL7X Q
"RTN","MDHL7A",146,0)
 S PNAM=$TR(NAM,"^",",")
"RTN","MDHL7A",147,0)
 D PID^VADPT6 S PID=$G(VA("PID")),BID=$G(VA("BID")) N VA
"RTN","MDHL7A",148,0)
 Q
"RTN","MDHL7A",149,0)
MDSSN ; This subroutine is to match up the SSN for a patient.
"RTN","MDHL7A",150,0)
 S NAM=$P(X,"|",6),MDSSN=$P(X,"|",20) I $L(MDSSN)<9 S MDSSN=$P(X,"|",4)
"RTN","MDHL7A",151,0)
 S MDSSN=$P(MDSSN,"^",1) I MDSSN'?9N S MDSSN=$TR(MDSSN,"- ","")
"RTN","MDHL7A",152,0)
 I $E(MDSSN,$L(MDSSN))="P" S MDSSN=$E(MDSSN,1,9)
"RTN","MDHL7A",153,0)
 S:MDSSN'?9N MDSSN=" " S DFN=$O(^DPT("SSN",MDSSN,0))
"RTN","MDHL7A",154,0)
 I 'DFN S DFN=$O(^DPT("SSN",MDSSN_"P",0))
"RTN","MDHL7A",155,0)
 Q
"RTN","MDHL7A",156,0)
 ;
"RTN","MDHL7A",157,0)
OBX ; [Observation]
"RTN","MDHL7A",158,0)
 D @MDRTN
"RTN","MDHL7A",159,0)
 Q
"RTN","MDHL7A",160,0)
NEWID(DFN,DATE,INST,MDD702,HLMTIEN) ; Generate a new entry and ID of 703.1
"RTN","MDHL7A",161,0)
 N NEWID,MDFDA,MDIEN,MDNO,MDRECI
"RTN","MDHL7A",162,0)
 S NEWID=$TR($H,",","-")  ; Create inital ID
"RTN","MDHL7A",163,0)
 L +(^MDD(703.1,"B")):60 E  Q "-1"
"RTN","MDHL7A",164,0)
 ;^^--- Unable to get a lock in the file
"RTN","MDHL7A",165,0)
 F  Q:'$D(^MDD(703.1,"B",NEWID))  H 1 S NEWID=$TR($H,",","-")
"RTN","MDHL7A",166,0)
 ;^^--- Search to create a new ID if current ID is in use
"RTN","MDHL7A",167,0)
 S MDFDA(703.1,"+1,",.01)=NEWID
"RTN","MDHL7A",168,0)
 S MDFDA(703.1,"+1,",.02)=DFN
"RTN","MDHL7A",169,0)
 S MDFDA(703.1,"+1,",.03)=$$HL7TFM^MDHL7U(DATE)
"RTN","MDHL7A",170,0)
 S MDFDA(703.1,"+1,",.04)=INST
"RTN","MDHL7A",171,0)
 S MDFDA(703.1,"+1,",.05)=MDD702
"RTN","MDHL7A",172,0)
 S MDFDA(703.1,"+1,",.06)=HLMTIEN
"RTN","MDHL7A",173,0)
 D UPDATE^DIE("","MDFDA","MDIEN")
"RTN","MDHL7A",174,0)
 L -(^MDD(703.1,"B"))
"RTN","MDHL7A",175,0)
 I $G(MDIEN(1))>0 D  Q MDIEN(1)_U_NEWID
"RTN","MDHL7A",176,0)
 . S ^MDD(703.1,MDIEN(1),.1,0)="^703.11S^0^0"
"RTN","MDHL7A",177,0)
 . S MDRECI=+MDIEN(1)
"RTN","MDHL7A",178,0)
 . S MDNO=$$NTIU^MDRPCW1(+MDD702,+MDRECI)
"RTN","MDHL7A",179,0)
 . Q
"RTN","MDHL7A",180,0)
 ; ^^--- Create Subfile and quit
"RTN","MDHL7A",181,0)
 Q "-1"  ; Unable to create file
"RTN","MDHL7A",182,0)
 ;
"RTN","MDHL7A",183,0)
PROC ; [Procedure] Create report entry in file (703.1)
"RTN","MDHL7A",184,0)
 D PROC^MDHL7U
"RTN","MDHL7A",185,0)
 Q
"RTN","MDHL7BH")
0^28^B22756208^B17132013
"RTN","MDHL7BH",1,0)
MDHL7BH ; HOIFO/WAA -Bi-directional interface (HL7) routine ;10/26/09  09:21
"RTN","MDHL7BH",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11,21**;Apr 01, 2004;Build 30
"RTN","MDHL7BH",3,0)
 ;
"RTN","MDHL7BH",4,0)
 ; This routine will build the HL7 Message and store that message.
"RTN","MDHL7BH",5,0)
 ; After the message has been created then it will call the
"RTN","MDHL7BH",6,0)
 ; The actual HL7package to start the processing of the message
"RTN","MDHL7BH",7,0)
 ;
"RTN","MDHL7BH",8,0)
 ; Reference DBIA #2161 [Supported] for HL7 calls.
"RTN","MDHL7BH",9,0)
 ; Reference DBIA #2164 [Supported] for HL7 calls.
"RTN","MDHL7BH",10,0)
 ; Reference DBIA #2263 [Supported] call to XPAR
"RTN","MDHL7BH",11,0)
 ; Reference DBIA #3065 [Supported]  call to XLFNAME.
"RTN","MDHL7BH",12,0)
 ; Reference DBIA #10103 [Supported] Call to XLFDT
"RTN","MDHL7BH",13,0)
 ; Reference DBIA #3067 [Private] Read Consult Data with FM call.
"RTN","MDHL7BH",14,0)
 ; Reference DBIA #10035[Supported] Patient File Access
"RTN","MDHL7BH",15,0)
 ; Reference DBIA #10040[Supported] Access ^SC
"RTN","MDHL7BH",16,0)
 ; Reference DBIA #10061[Supported] call to VADPT
"RTN","MDHL7BH",17,0)
 ; Reference DBIA #10056[Supported] Direct read STATE (5)
"RTN","MDHL7BH",18,0)
 Q
"RTN","MDHL7BH",19,0)
EN1 ;Main Entry point.
"RTN","MDHL7BH",20,0)
 N MDMSG,MD101,CNT,HLA,LINE,MDHL,DFN,MDLINK
"RTN","MDHL7BH",21,0)
 Q:RESULT<1  ; This tells the study is not a BDi
"RTN","MDHL7BH",22,0)
 S MDLINK=$$GET1^DIQ(702.09,DEVIEN,.18,"E")
"RTN","MDHL7BH",23,0)
 I MDLINK="" S RESULT=-1,MSG="No HL Logical Link has been defined." Q  ; No link has been defined
"RTN","MDHL7BH",24,0)
 S MDERROR="0"
"RTN","MDHL7BH",25,0)
 D INIT^HLFNC2("MCAR ORM SERVER",.MDMSG)
"RTN","MDHL7BH",26,0)
 I +$G(MDMSG)>0 S RESULT=-1,MSG="Unable to produce a message." Q  ; something is wrong and no MSH was created
"RTN","MDHL7BH",27,0)
 S DFN=$$GET1^DIQ(702,MDD702,.01,"I")
"RTN","MDHL7BH",28,0)
 S DEVNAME=$$GET1^DIQ(702.09,DEVIEN,.16,"I")
"RTN","MDHL7BH",29,0)
 S CNT=0
"RTN","MDHL7BH",30,0)
 D PID S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",31,0)
 D PV1 S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",32,0)
 D ORC S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",33,0)
 D OBR I LINE'="" S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",34,0)
 S HLP("SUBSCRIBER")="^^VISTA^^"_DEVNAME_"^M"
"RTN","MDHL7BH",35,0)
 S HLL("LINKS",1)="MCAR ORM CLIENT"_"^"_MDLINK
"RTN","MDHL7BH",36,0)
 D GENERATE^HLMA("MCAR ORM SERVER","LM",1,.MDHL,,.HLP)
"RTN","MDHL7BH",37,0)
 I $P(MDHL,U,2) S MDERROR=MDHL
"RTN","MDHL7BH",38,0)
 Q
"RTN","MDHL7BH",39,0)
OBR ; Send the procedure to the correct device
"RTN","MDHL7BH",40,0)
 S LINE="OBR|"
"RTN","MDHL7BH",41,0)
 S DEVIEN=$$GET1^DIQ(702,MDD702,.11,"I")
"RTN","MDHL7BH",42,0)
 S USC=$$GET1^DIQ(702.09,DEVIEN,.17,"I")
"RTN","MDHL7BH",43,0)
 I USC="" S LINE="" Q
"RTN","MDHL7BH",44,0)
 E  S USC=$TR(USC,"=","^")
"RTN","MDHL7BH",45,0)
 S $P(LINE,"|",5)=USC_"|"
"RTN","MDHL7BH",46,0)
 Q
"RTN","MDHL7BH",47,0)
PID ;get the patient information and build the PID
"RTN","MDHL7BH",48,0)
 ;PID|||SSN||Last^First||DOB|SEX|||||||||||SSN
"RTN","MDHL7BH",49,0)
 N MDSSN,NAME,DOB,ADDR,TMP,MDADD,VAPA,VAERR,VAROOT,MDPCOD
"RTN","MDHL7BH",50,0)
 S LINE="PID|",$P(LINE,"|",21)=""
"RTN","MDHL7BH",51,0)
 S MDSSN=$$GET1^DIQ(702,MDD702,.011) ; Get the ssn for the patient
"RTN","MDHL7BH",52,0)
 S NAME=$$GET1^DIQ(702,MDD702,.01,"E") ; get the patient name
"RTN","MDHL7BH",53,0)
 S NAME=$$HLNAME^XLFNAME($P(NAME,"^"),"",$E(HLECH,1))
"RTN","MDHL7BH",54,0)
 I $P(NAME,$E(HLECH,1),7)'="L" S $P(NAME,$E(HLECH,1),7)="L"
"RTN","MDHL7BH",55,0)
 S DOB=$$GET1^DIQ(2,DFN,.03,"I") S DOB=$$FTOHL7^MDHL7U2(DOB)
"RTN","MDHL7BH",56,0)
 S VAROOT="MDADD" D ADD^VADPT
"RTN","MDHL7BH",57,0)
 S ADDR=$G(MDADD(1))_"^" ; Address 1
"RTN","MDHL7BH",58,0)
 S TMP=$G(MDADD(2)) I TMP'="" S ADDR=ADDR_TMP ; Add 2
"RTN","MDHL7BH",59,0)
 S TMP=$G(MDADD(3)) I TMP'="" S ADDR=ADDR_" "_TMP ; Add 3
"RTN","MDHL7BH",60,0)
 S ADDR=ADDR_"^"_$G(MDADD(4)) ; City
"RTN","MDHL7BH",61,0)
 S MDPCOD=$P($G(MDADD(5)),"^",1) I MDPCOD'="" S MDPCOD=$P($G(^DIC(5,MDPCOD,0)),"^",2)
"RTN","MDHL7BH",62,0)
 ; ^^^^^^ Setting MDPCODE to Postal code Via direct supported lookup.
"RTN","MDHL7BH",63,0)
 S ADDR=ADDR_"^"_MDPCOD ; State Postal Code
"RTN","MDHL7BH",64,0)
 S ADDR=ADDR_"^"_$G(MDADD(6)) ; Zip
"RTN","MDHL7BH",65,0)
 K MDADD
"RTN","MDHL7BH",66,0)
 S $P(LINE,"|",2)="1"
"RTN","MDHL7BH",67,0)
 S $P(LINE,"|",4)=MDSSN
"RTN","MDHL7BH",68,0)
 S $P(LINE,"|",6)=NAME
"RTN","MDHL7BH",69,0)
 S $P(LINE,"|",8)=DOB
"RTN","MDHL7BH",70,0)
 S $P(LINE,"|",9)=$$GET1^DIQ(2,DFN,.02,"I")
"RTN","MDHL7BH",71,0)
 S $P(LINE,"|",12)=ADDR
"RTN","MDHL7BH",72,0)
 S $P(LINE,"|",20)=MDSSN
"RTN","MDHL7BH",73,0)
 Q
"RTN","MDHL7BH",74,0)
PV1 ;Get the ward location for PV1
"RTN","MDHL7BH",75,0)
 ;PV1||In or out|Ward location
"RTN","MDHL7BH",76,0)
 N CWARD,WARD,INOUT,CONSULT,REF,NREF,WARD1,WARD2,MDPR1,MDPNAM,MDSV
"RTN","MDHL7BH",77,0)
 S WARD=$$GET1^DIQ(2,DFN,.1,"E"),(WARD1,WARD2)=""
"RTN","MDHL7BH",78,0)
 S INOUT=$S(WARD'="":"I",1:"O")
"RTN","MDHL7BH",79,0)
 S:WARD'="" WARD=WARD_U_WARD
"RTN","MDHL7BH",80,0)
 S CONSULT=$$GET123^MDHL7U2(MDD702)
"RTN","MDHL7BH",81,0)
 S CWARD=$P($G(^MDD(702,+MDD702,0)),U,7),CWARD=$P(CWARD,";",3)
"RTN","MDHL7BH",82,0)
 S:+CWARD WARD2=$$GET1^DIQ(44,+CWARD_",",.01,"E")
"RTN","MDHL7BH",83,0)
 S MDPR1=$$GET1^DIQ(702,+MDD702_",",.04,"I")
"RTN","MDHL7BH",84,0)
 S:+MDPR1 WARD1=$$GET1^DIQ(702.01,+MDPR1_",",.05,"E")
"RTN","MDHL7BH",85,0)
 S MDPNAM=$$GET1^DIQ(702.09,DEVIEN,.06,"I")
"RTN","MDHL7BH",86,0)
 I INOUT="O" D
"RTN","MDHL7BH",87,0)
 .;S WARD=WARD1 S:WARD="" WARD=WARD2
"RTN","MDHL7BH",88,0)
 .S WARD=WARD2 S:WARD="" WARD=WARD1
"RTN","MDHL7BH",89,0)
 .I WARD="" S WARD=$$GET1^DIQ(123,CONSULT_",",.04,"E"),MDSV="A;"_$$NOW^XLFDT()_";"_$$GET1^DIQ(123,CONSULT_",",.04,"I"),$P(^MDD(702,+MDD702,0),U,7)=MDSV
"RTN","MDHL7BH",90,0)
 .I MDPNAM["Olympus" D
"RTN","MDHL7BH",91,0)
 ..S WARD1=$O(^SC("B",WARD,0)),CWARD=$P($G(^SC(+WARD1,0)),U,2)
"RTN","MDHL7BH",92,0)
 ..S WARD=$S(+$$GET^XPAR("SYS","MD OLYMPUS 7",1)>0:$E(WARD,1,7),1:$E(WARD,1,4))_"^"_CWARD
"RTN","MDHL7BH",93,0)
 I INOUT="I" S WARD=WARD_"^"_$S($G(^DPT(2,.101))'="":$G(^DPT(2,.101)),1:"")
"RTN","MDHL7BH",94,0)
 ;V--- NEW CODE THis code is
"RTN","MDHL7BH",95,0)
 I $P($P(^MDD(702,+MDD702,0),U,7),";",3)="" D
"RTN","MDHL7BH",96,0)
 . S:+MDPR1 WARD=$$GET1^DIQ(702.01,+MDPR1_",",.05,"I") Q:+WARD
"RTN","MDHL7BH",97,0)
 . S WARD=$$GET1^DIQ(123,CONSULT_",",.04,"E"),MDSV="A;"_$$NOW^XLFDT()_";"_$$GET1^DIQ(123,CONSULT_",",.04,"I"),$P(^MDD(702,+MDD702,0),U,7)=MDSV
"RTN","MDHL7BH",98,0)
 . Q
"RTN","MDHL7BH",99,0)
 ;^--- NEW CODE
"RTN","MDHL7BH",100,0)
 S LINE="PV1||"_INOUT_"|"_WARD
"RTN","MDHL7BH",101,0)
 Q:CONSULT<1
"RTN","MDHL7BH",102,0)
 S NREF=$$GETREF^MDHL7U2(CONSULT) Q:NREF="-1"
"RTN","MDHL7BH",103,0)
 S $P(LINE,"|",9)=NREF
"RTN","MDHL7BH",104,0)
 Q
"RTN","MDHL7BH",105,0)
ORC ;get ORC onformation
"RTN","MDHL7BH",106,0)
 ;ORC|NA|Order Number|||||||date/time ordered
"RTN","MDHL7BH",107,0)
 N DATE,SDATE
"RTN","MDHL7BH",108,0)
 S DATE=$$GET1^DIQ(702,MDD702,.02,"I")
"RTN","MDHL7BH",109,0)
 S DATE=$$FTOHL7^MDHL7U2(DATE)
"RTN","MDHL7BH",110,0)
 S SDATE=$$GET1^DIQ(702,MDD702,.07,"I")
"RTN","MDHL7BH",111,0)
 I SDATE[";" S SDATE=$P(SDATE,";",2)
"RTN","MDHL7BH",112,0)
 I SDATE="" D NOW^%DTC S SDATE=% S $P(^MDD(702,MDD702,0),"^",7)=SDATE
"RTN","MDHL7BH",113,0)
 I SDATE<DT D NOW^%DTC S SDATE=%
"RTN","MDHL7BH",114,0)
 S SDATE=$$FTOHL7^MDHL7U2(SDATE)
"RTN","MDHL7BH",115,0)
 S LINE="ORC|"_$S(MDORFLG=1:"NW",MDORFLG=0:"CA",1:"")_"|"_MDIORD
"RTN","MDHL7BH",116,0)
 S $P(LINE,"|",6)=$S(MDORFLG=1:"NW",MDORFLG=0:"CA",1:"")
"RTN","MDHL7BH",117,0)
 S $P(LINE,"|",10)=DATE,$P(LINE,"|",16)=SDATE
"RTN","MDHL7BH",118,0)
 Q
"RTN","MDHL7K1")
0^25^B3829311^n/a
"RTN","MDHL7K1",1,0)
MDHL7K1 ; HOIFO/WAA-KenitDx Interface ; 06/08/00
"RTN","MDHL7K1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDHL7K1",3,0)
 N TCNT,ICNT,LN
"RTN","MDHL7K1",4,0)
 S (TCNT,ICNT,LN)=0
"RTN","MDHL7K1",5,0)
OBX ; Process OBX
"RTN","MDHL7K1",6,0)
 N MDATT,PROC
"RTN","MDHL7K1",7,0)
 D ATT^MDHL7U(DEVIEN,.MDATT) Q:MDATT<1
"RTN","MDHL7K1",8,0)
 S PROC=0
"RTN","MDHL7K1",9,0)
 F  S PROC=$O(MDATT(PROC)) Q:PROC<1  D
"RTN","MDHL7K1",10,0)
 . N PROCESS
"RTN","MDHL7K1",11,0)
 . S PROCESS=$P(MDATT(PROC),";",5)
"RTN","MDHL7K1",12,0)
 . I PROCESS="TEXT^MDHL7U2" D TEXT
"RTN","MDHL7K1",13,0)
 . D @PROCESS
"RTN","MDHL7K1",14,0)
 . Q
"RTN","MDHL7K1",15,0)
 Q:'MDIEN
"RTN","MDHL7K1",16,0)
 D REX^MDHL7U1(MDIEN)
"RTN","MDHL7K1",17,0)
 D GENACK^MDHL7X
"RTN","MDHL7K1",18,0)
 Q
"RTN","MDHL7K1",19,0)
TEXT ;This subroutine is to parse out the text
"RTN","MDHL7K1",20,0)
 ;
"RTN","MDHL7K1",21,0)
 N CNT,P,LINE2,LINE,CNT2,CO,I,TEXT,DEL,TXT
"RTN","MDHL7K1",22,0)
 S P="|",CNT=0,LINE2="",CNT2=0,CNT3=0
"RTN","MDHL7K1",23,0)
 F  S CNT=$O(^TMP($J,"MDHL7A",CNT)) Q:CNT<1  D
"RTN","MDHL7K1",24,0)
 .S DEL="\.br\",LAST=""
"RTN","MDHL7K1",25,0)
 .S LINE=^TMP($J,"MDHL7A",CNT)
"RTN","MDHL7K1",26,0)
 .I $P(LINE,P,1)'="OBX" Q
"RTN","MDHL7K1",27,0)
 .I $P(LINE,P,3)'="FT" Q
"RTN","MDHL7K1",28,0)
 .S TEXT=$P(LINE,P,6)
"RTN","MDHL7K1",29,0)
 .D LINE(TEXT,DEL)
"RTN","MDHL7K1",30,0)
 .F  S CNT3=$O(^TMP($J,"MDHL7A",CNT,CNT3)) Q:CNT3<1  D
"RTN","MDHL7K1",31,0)
 .. S LINE=^TMP($J,"MDHL7A",CNT,CNT3)
"RTN","MDHL7K1",32,0)
 .. S TEXT=LAST_LINE
"RTN","MDHL7K1",33,0)
 .. D LINE(TEXT,DEL)
"RTN","MDHL7K1",34,0)
 .. Q
"RTN","MDHL7K1",35,0)
 .Q
"RTN","MDHL7K1",36,0)
 Q
"RTN","MDHL7K1",37,0)
LINE(TEXT,DEL) ;
"RTN","MDHL7K1",38,0)
 S CO=$L(TEXT,DEL)
"RTN","MDHL7K1",39,0)
 I CO F I=1:1:CO D  Q
"RTN","MDHL7K1",40,0)
 . S TXT=$P(TEXT,DEL,I)
"RTN","MDHL7K1",41,0)
 . D LG(TXT)
"RTN","MDHL7K1",42,0)
 . ;D BUILD(TXT)
"RTN","MDHL7K1",43,0)
 . Q
"RTN","MDHL7K1",44,0)
 E  D BUILD(TXT)
"RTN","MDHL7K1",45,0)
 I $O(^TMP($J,"MDHL7A",CNT,CNT3))="" ; S LAST=$P(TXT,DEL,CO)
"RTN","MDHL7K1",46,0)
 Q
"RTN","MDHL7K1",47,0)
 ;
"RTN","MDHL7K1",48,0)
 ;. S TXT=$P(TXT,DEL,CO)
"RTN","MDHL7K1",49,0)
 ;. I $L(TXT)>80 D LG(TXT) Q
"RTN","MDHL7K1",50,0)
 ;. Q
"RTN","MDHL7K1",51,0)
 Q
"RTN","MDHL7K1",52,0)
LG(TXT) ; LARGE LINES
"RTN","MDHL7K1",53,0)
 I $L(TXT)<80 D BUILD(TXT) Q
"RTN","MDHL7K1",54,0)
 N SP,TTEXT,LAST,FIRST,TTTEXT,X
"RTN","MDHL7K1",55,0)
 S TEXTTOT=TXT
"RTN","MDHL7K1",56,0)
 S TXT80=$E(TXT,1,80),SP=$L(TXT80," ")
"RTN","MDHL7K1",57,0)
 S TXT=$P(TXT80," ",1,$S(SP>1:SP-1,1:1))
"RTN","MDHL7K1",58,0)
 D BUILD(TXT) S TXT=$E(TEXTTOT,($L(TXT)+2),$L(TEXTTOT))
"RTN","MDHL7K1",59,0)
 I $L(TXT)>80 D LG(TXT)
"RTN","MDHL7K1",60,0)
 Q
"RTN","MDHL7K1",61,0)
BUILD(TXT) ;
"RTN","MDHL7K1",62,0)
 S LINE2="OBX||TX|||"
"RTN","MDHL7K1",63,0)
 S $P(LINE2,P,6)=TXT
"RTN","MDHL7K1",64,0)
 S CNT2=CNT2+1
"RTN","MDHL7K1",65,0)
 S ^TMP($J,"MDHL7","TEXT",CNT2)=LINE2
"RTN","MDHL7K1",66,0)
 Q
"RTN","MDHL7U3")
0^13^B65415989^B59275593
"RTN","MDHL7U3",1,0)
MDHL7U3 ; HOIFO/WAA -Utilities for CP to process HL7 messages  ;02/17/10  15:59
"RTN","MDHL7U3",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21**;Apr 01, 2004;Build 30
"RTN","MDHL7U3",3,0)
 ; Reference DBIA #2729 [Supported]  for XMXPAI
"RTN","MDHL7U3",4,0)
 ; Reference DBIA #4262 [Supported] for HLUOPT2 call.
"RTN","MDHL7U3",5,0)
 ; Reference DBIA #3244 [Subscription] for MSH node of HLMA file (#773).
"RTN","MDHL7U3",6,0)
 ; Reference DBIA #3273 [Subscription] for reference HLMA of file (#773).
"RTN","MDHL7U3",7,0)
 ; Reference DBIA #10138 [Supported] for reference of HL file (#772).
"RTN","MDHL7U3",8,0)
 ; Reference DBIA #3990 [Supported] for ICDCODE call
"RTN","MDHL7U3",9,0)
 ; Reference DBIA #1131 [Supported] for XMB("NETNAME") reference
"RTN","MDHL7U3",10,0)
 ; Reference DBIA #1995 [Supported] for ICPTCOD to handle CPT Codes call
"RTN","MDHL7U3",11,0)
 ; Reference DBIA #10060 [Supported] NEW PERSON FILE (#200) Lookup.
"RTN","MDHL7U3",12,0)
 ; Reference DBIA #10111 [Supported] for FILE 3.8 call
"RTN","MDHL7U3",13,0)
 ; Reference DBIA #10103 [Supported] for XLFDT call
"RTN","MDHL7U3",14,0)
 ;
"RTN","MDHL7U3",15,0)
HL7CHK(MDD702) ; Check to see of there is an entry in 703.1 for a patient.
"RTN","MDHL7U3",16,0)
 N X
"RTN","MDHL7U3",17,0)
 S X="1^"
"RTN","MDHL7U3",18,0)
 D
"RTN","MDHL7U3",19,0)
 . N Y
"RTN","MDHL7U3",20,0)
 . I $G(^MDD(702,MDD702,0))="" S X="-1^No Entry in 702." Q
"RTN","MDHL7U3",21,0)
 . I $D(^MDD(703.1,"ASTUDYID",MDD702))=0 Q
"RTN","MDHL7U3",22,0)
 . S Y=0
"RTN","MDHL7U3",23,0)
 . S Y=$O(^MDD(703.1,"ASTUDYID",MDD702,Y)) I Y>0 S X="-1^This Study has Data on file."
"RTN","MDHL7U3",24,0)
 . Q
"RTN","MDHL7U3",25,0)
 Q X
"RTN","MDHL7U3",26,0)
XVERT(MDA,MDB) ; Strip out blank Lines
"RTN","MDHL7U3",27,0)
 Q:MDA=""
"RTN","MDHL7U3",28,0)
 Q:MDB=""
"RTN","MDHL7U3",29,0)
 Q:$G(^TMP($J,MDA,1))
"RTN","MDHL7U3",30,0)
 N I,CNT,CNT2,NODE,FLG
"RTN","MDHL7U3",31,0)
 S (CNT,I,FLG)=0
"RTN","MDHL7U3",32,0)
 F  S I=$O(^TMP($J,MDA,I)) Q:I<1  D
"RTN","MDHL7U3",33,0)
 . S NODE=$TR(^TMP($J,MDA,I),$C(10),"")
"RTN","MDHL7U3",34,0)
 . I NODE=" " S NODE=""
"RTN","MDHL7U3",35,0)
 . I NODE="" S FLG=0 Q
"RTN","MDHL7U3",36,0)
 . I FLG  D  Q
"RTN","MDHL7U3",37,0)
 . . S CNT2=CNT2+1
"RTN","MDHL7U3",38,0)
 . . S ^TMP($J,MDB,CNT,CNT2)=NODE
"RTN","MDHL7U3",39,0)
 . . Q
"RTN","MDHL7U3",40,0)
 . I 'FLG D  Q
"RTN","MDHL7U3",41,0)
 . . S CNT=CNT+1
"RTN","MDHL7U3",42,0)
 . . S ^TMP($J,MDB,CNT)=NODE
"RTN","MDHL7U3",43,0)
 . . S FLG=1,CNT2=0
"RTN","MDHL7U3",44,0)
 . . Q
"RTN","MDHL7U3",45,0)
 . Q
"RTN","MDHL7U3",46,0)
 Q
"RTN","MDHL7U3",47,0)
 ;
"RTN","MDHL7U3",48,0)
PURGE(MDD7031) ;
"RTN","MDHL7U3",49,0)
 ; This sub-routine will delete HL7 772 Message text after a message
"RTN","MDHL7U3",50,0)
 ; been processed by Imaging.
"RTN","MDHL7U3",51,0)
 Q:'$D(^MDD(703.1,MDD7031,0))  ; No entry found
"RTN","MDHL7U3",52,0)
 S MDD772=$P(^MDD(703.1,MDD7031,0),U,6) Q:MDD772=""
"RTN","MDHL7U3",53,0)
 D DELBODY^HLUOPT2(MDD772,"CLINICAL PROCEDURES message purge","^TMP($J,""IN"")")
"RTN","MDHL7U3",54,0)
 S $P(^MDD(703.1,MDD7031,0),U,6)=""
"RTN","MDHL7U3",55,0)
 Q
"RTN","MDHL7U3",56,0)
 ;
"RTN","MDHL7U3",57,0)
PHY(X,MDIEN) ; Add the doc who did the exam to the report
"RTN","MDHL7U3",58,0)
 Q
"RTN","MDHL7U3",59,0)
 ; This will be implemented with the Doctor Lookup when it comes out.
"RTN","MDHL7U3",60,0)
 N LINE1,LINE
"RTN","MDHL7U3",61,0)
 S LINE1=$P(X,"|",17)
"RTN","MDHL7U3",62,0)
 S LINE=$P(LINE1,"^",2) ; Last
"RTN","MDHL7U3",63,0)
 S LINE=LINE_$S($P(LINE1,"^",3)'="":", "_$P(LINE1,"^",3),1:"") ; First
"RTN","MDHL7U3",64,0)
 S LINE=LINE_$S($P(LINE1,"^",4)'="":" "_$P(LINE1,"^",4),1:"") ; MI
"RTN","MDHL7U3",65,0)
 D ADD(MDIEN,"9",LINE)
"RTN","MDHL7U3",66,0)
 Q
"RTN","MDHL7U3",67,0)
 ;
"RTN","MDHL7U3",68,0)
CPTICD(X,MDIEN) ; Break out CPT and ICD9 codes
"RTN","MDHL7U3",69,0)
 N ICD,CPT
"RTN","MDHL7U3",70,0)
 Q:MDIEN<1
"RTN","MDHL7U3",71,0)
 S CPT=$P(X,"|",45) I CPT'="" D FILECD(MDIEN,CPT,"7")
"RTN","MDHL7U3",72,0)
 S ICD=$P(X,"|",14) I ICD'="" D FILECD(MDIEN,ICD,"8")
"RTN","MDHL7U3",73,0)
 Q
"RTN","MDHL7U3",74,0)
FILECD(MDIEN,CODE,TYPE) ; fILE THE DATA
"RTN","MDHL7U3",75,0)
 N LINE,Y,I,CNT,RESULT
"RTN","MDHL7U3",76,0)
 S CNT=$L(CODE,"~")
"RTN","MDHL7U3",77,0)
 S LINE=""
"RTN","MDHL7U3",78,0)
 F I=1:1:CNT S Y=$P(CODE,"~",I),RESULT=$P(Y,"^",1),LINE(.2,I,0)=RESULT
"RTN","MDHL7U3",79,0)
 S LINE(.2,0)="^^"_CNT_"^"_CNT_"^"_$P(%,".")
"RTN","MDHL7U3",80,0)
 Q:CNT<1  ; file the results if there is any
"RTN","MDHL7U3",81,0)
 D ADD(MDIEN,TYPE,.LINE,CNT)
"RTN","MDHL7U3",82,0)
 Q
"RTN","MDHL7U3",83,0)
 ;
"RTN","MDHL7U3",84,0)
ADD(MDIEN,TYPE,LINE,CNT) ;
"RTN","MDHL7U3",85,0)
 ; Create an entry in the .1 node
"RTN","MDHL7U3",86,0)
 N NODE,X
"RTN","MDHL7U3",87,0)
 S NODE=$G(^MDD(703.1,MDIEN,.1,0)) Q:NODE=""
"RTN","MDHL7U3",88,0)
 S NODE=$P(NODE,"^",3)
"RTN","MDHL7U3",89,0)
 S NODE=NODE+1
"RTN","MDHL7U3",90,0)
 S $P(^MDD(703.1,MDIEN,.1,0),"^",3,4)=NODE_"^"_NODE
"RTN","MDHL7U3",91,0)
 S $P(^MDD(703.1,MDIEN,.1,NODE,0),"^")=TYPE
"RTN","MDHL7U3",92,0)
 D NOW^%DTC
"RTN","MDHL7U3",93,0)
 M ^MDD(703.1,MDIEN,.1,NODE)=LINE
"RTN","MDHL7U3",94,0)
 Q
"RTN","MDHL7U3",95,0)
 ;
"RTN","MDHL7U3",96,0)
MSGIEN(MDHLIENS,MDHLREST) ; Return the message as definded in MDHLIENS  to the array in MDHLREST
"RTN","MDHL7U3",97,0)
 ; Only TCP type messages
"RTN","MDHL7U3",98,0)
 ; input: MDHLIENS= the intern entry number of the message in ^HLMA
"RTN","MDHL7U3",99,0)
 ; MDHLREST = the return array that will contain the whole HL7 message
"RTN","MDHL7U3",100,0)
 ; output: return "1^Message complete" if message was successful, "0^reason" if failed.
"RTN","MDHL7U3",101,0)
 ;
"RTN","MDHL7U3",102,0)
 N MDHLIEN,MDHLI,MDHLCNT,MDHLZ,RET
"RTN","MDHL7U3",103,0)
 S (MDHLCNT,MDHLI,RET)=0
"RTN","MDHL7U3",104,0)
 I $G(MDHLIENS)="" S RET=RET_"^No IEN defined" Q RET  ; Exit because no IEN for ^HLMA was provided
"RTN","MDHL7U3",105,0)
 I $G(MDHLREST)="" S RET=RET_"^No Return ARRAY provided" Q RET  ; Exit because no return array was provided
"RTN","MDHL7U3",106,0)
 I $G(^HLMA(MDHLIENS,0))="" S RET=RET_"^HLMA entry does not exist" Q RET  ; Exit because invalid OR non-EXISTING HLMA ENTRY
"RTN","MDHL7U3",107,0)
 S MDHLIEN=$P(^HLMA(MDHLIENS,0),U)
"RTN","MDHL7U3",108,0)
 I MDHLIEN="" S RET=RET_"^No pointer value to file 772" Q RET  ; No Pointer to 772
"RTN","MDHL7U3",109,0)
 I $G(^HL(772,MDHLIEN,0))="" S RET=RET_"^772 Entry does not exist" Q RET  ; No 772 entry exist
"RTN","MDHL7U3",110,0)
 ;get header
"RTN","MDHL7U3",111,0)
 S MDHLZ=$G(^HLMA(MDHLIENS,"MSH",1,0))
"RTN","MDHL7U3",112,0)
 I MDHLZ="" S RET=RET_"^No MSH segment found" Q RET  ; No MSH was found
"RTN","MDHL7U3",113,0)
 S MDHLCNT=MDHLCNT+1,@MDHLREST@(MDHLCNT)=MDHLZ
"RTN","MDHL7U3",114,0)
 S MDHLCNT=MDHLCNT+1,@MDHLREST@(MDHLCNT)=""
"RTN","MDHL7U3",115,0)
 ;get body
"RTN","MDHL7U3",116,0)
 S MDHLI=0
"RTN","MDHL7U3",117,0)
 F  S MDHLI=$O(^HL(772,MDHLIEN,"IN",MDHLI)) Q:'MDHLI  D
"RTN","MDHL7U3",118,0)
 . S MDHLCNT=MDHLCNT+1
"RTN","MDHL7U3",119,0)
 . S @MDHLREST@(MDHLCNT)=$G(^HL(772,MDHLIEN,"IN",MDHLI,0))
"RTN","MDHL7U3",120,0)
 . Q
"RTN","MDHL7U3",121,0)
 I MDHLCNT'>2 S RET=RET_"^No message body found" Q RET  ; There was no body
"RTN","MDHL7U3",122,0)
 S RET="1^Message complete"
"RTN","MDHL7U3",123,0)
 Q RET
"RTN","MDHL7U3",124,0)
 ;
"RTN","MDHL7U3",125,0)
CICNV(MDIEN,RETURN) ; This subroutine will read the data in 703.1 and return the results
"RTN","MDHL7U3",126,0)
 ;in the indicated global
"RTN","MDHL7U3",127,0)
 N NODE,FLG
"RTN","MDHL7U3",128,0)
 S FLG=1
"RTN","MDHL7U3",129,0)
 Q:MDIEN=""  ; The ien was null
"RTN","MDHL7U3",130,0)
 Q:RETURN=""  ; the array was null
"RTN","MDHL7U3",131,0)
 S ARRAY(0)="0^0"
"RTN","MDHL7U3",132,0)
 I $G(^MDD(703.1,MDIEN,.1,0))="" S FLG=0 Q  ; There is not data.
"RTN","MDHL7U3",133,0)
 ; Start the processing of ICD/POV codes Value is 8
"RTN","MDHL7U3",134,0)
 S NODE=0
"RTN","MDHL7U3",135,0)
 I FLG I $G(^MDD(703.1,MDIEN,.1,0))'="" D
"RTN","MDHL7U3",136,0)
 . F  S NODE=$O(^MDD(703.1,MDIEN,.1,NODE)) Q:NODE<1  D
"RTN","MDHL7U3",137,0)
 . . S TYPE=$P($G(^MDD(703.1,MDIEN,.1,NODE,0),0),"^",1)
"RTN","MDHL7U3",138,0)
 . . I TYPE=8 D PROCESS(MDIEN,NODE,TYPE,.ARRAY)
"RTN","MDHL7U3",139,0)
 . . I TYPE=7 D PROCESS(MDIEN,NODE,TYPE,.ARRAY)
"RTN","MDHL7U3",140,0)
 . . Q
"RTN","MDHL7U3",141,0)
 . Q
"RTN","MDHL7U3",142,0)
 M @RETURN=ARRAY
"RTN","MDHL7U3",143,0)
 Q
"RTN","MDHL7U3",144,0)
PROCESS(MDIEN,NODE,TYPE,ARRAY) ; This will process the data for each
"RTN","MDHL7U3",145,0)
 N CNT,X,CONT,CODE,AR,TP,LOC
"RTN","MDHL7U3",146,0)
 S CNT=0,CONT=0
"RTN","MDHL7U3",147,0)
 F  S CNT=$O(^MDD(703.1,MDIEN,.1,NODE,.2,CNT)) Q:CNT<1  D
"RTN","MDHL7U3",148,0)
 . S CODE=$G(^MDD(703.1,MDIEN,.1,NODE,.2,CNT,0),"") ; Grabbing the ICD9 AND CPT codes
"RTN","MDHL7U3",149,0)
 . I CODE="" Q
"RTN","MDHL7U3",150,0)
 . I TYPE=8 S AR=1,TP="POV",X=$$ICDDX^ICDCODE(CODE) Q:X=""  ; Reference DBIA #3990 [Supported] for ICDCODE call
"RTN","MDHL7U3",151,0)
 . I TYPE=7 S AR=2,TP="CPT",X=$$CPT^ICPTCOD(CODE) Q:X=""  ; Reference DBIA #1995 [Supported] for ICPTCOD to handle CPT Codes call
"RTN","MDHL7U3",152,0)
 . S CONT=CONT+1
"RTN","MDHL7U3",153,0)
 . S ARRAY(AR)=CONT_"^"_CONT
"RTN","MDHL7U3",154,0)
 . I AR=1 D
"RTN","MDHL7U3",155,0)
 . . N DESC,IN,LN
"RTN","MDHL7U3",156,0)
 . . S IN=$P(X,"^",1) Q:IN<1
"RTN","MDHL7U3",157,0)
 . . S DESC=$P(X,"^",4) Q:DESC=""
"RTN","MDHL7U3",158,0)
 . . S I=CONT
"RTN","MDHL7U3",159,0)
 . . S $P(ARRAY(AR,I),"^",1)=TP
"RTN","MDHL7U3",160,0)
 . . S $P(ARRAY(AR,I),"^",2)=$P(X,"^",1)
"RTN","MDHL7U3",161,0)
 . . S $P(ARRAY(AR,I),"^",3)=$P(X,"^",2)
"RTN","MDHL7U3",162,0)
 . . S $P(ARRAY(AR,I),"^",5)=DESC
"RTN","MDHL7U3",163,0)
 . . S $P(ARRAY(AR,I),"^",6)=$S(I=1:1,1:0)
"RTN","MDHL7U3",164,0)
 . . Q
"RTN","MDHL7U3",165,0)
 . I AR=2 D
"RTN","MDHL7U3",166,0)
 . . N DESC,IN,LN,LEX,CPTCNT
"RTN","MDHL7U3",167,0)
 . . S IN=$P(X,"^",1) Q:IN<1
"RTN","MDHL7U3",168,0)
 . . D CPTLEX^MDRPCWU(.LEX,CODE,"CPT")
"RTN","MDHL7U3",169,0)
 . . Q:$D(^TMP("MDLEX",$J))<1
"RTN","MDHL7U3",170,0)
 . . S DESC="",CPTCNT=""
"RTN","MDHL7U3",171,0)
 . . F  S CPTCNT=$O(^TMP("MDLEX",$J,CPTCNT)) Q:CPTCNT<1  D  Q:$L(DESC)>200
"RTN","MDHL7U3",172,0)
 . . . N LINE
"RTN","MDHL7U3",173,0)
 . . . S LINE=$P(^TMP("MDLEX",$J,CPTCNT),"^",3)
"RTN","MDHL7U3",174,0)
 . . . Q:LINE=""
"RTN","MDHL7U3",175,0)
 . . . S DESC=DESC_LINE_" "
"RTN","MDHL7U3",176,0)
 . . . Q
"RTN","MDHL7U3",177,0)
 . . I $L(DESC)>200 S DESC=$E(DESC,1,200)
"RTN","MDHL7U3",178,0)
 . . ; S LN=$G(^ICPT(IN,0),0) Q:LN=""
"RTN","MDHL7U3",179,0)
 . . ; S DESC=$P(X,"^",3) Q:DESC=""  ; DBIA1995 $$CPT^ICPTCOD(CODE) returns X and the second piece of X is the DESC
"RTN","MDHL7U3",180,0)
 . . S I=CNT
"RTN","MDHL7U3",181,0)
 . . S $P(ARRAY(AR,I),"^",1)=TP
"RTN","MDHL7U3",182,0)
 . . S $P(ARRAY(AR,I),"^",2)=$P(X,"^",1)
"RTN","MDHL7U3",183,0)
 . . S $P(ARRAY(AR,I),"^",3)=$P(X,"^",2)
"RTN","MDHL7U3",184,0)
 . . S $P(ARRAY(AR,I),"^",5)=DESC
"RTN","MDHL7U3",185,0)
 . . ; S $P(ARRAY(AR,I),"^",5)=LEX^MDRPCW1(RESULTS,CODE,"CPT") ; 02
"RTN","MDHL7U3",186,0)
 . . S $P(ARRAY(AR,I),"^",7)=$S(I=1:1,1:0)
"RTN","MDHL7U3",187,0)
 . . Q
"RTN","MDHL7U3",188,0)
 . Q
"RTN","MDHL7U3",189,0)
 I $D(ARRAY(1))!$D(ARRAY(2)) S ARRAY(0)="1^1"
"RTN","MDHL7U3",190,0)
 Q
"RTN","MDHL7U3",191,0)
 ;
"RTN","MDHL7U3",192,0)
NOTICE(SUBJECT,TXT,DEVIEN,DUZ) ; This will fire off a mail message to the Indicated mail group saying that a study was deleted
"RTN","MDHL7U3",193,0)
 ;
"RTN","MDHL7U3",194,0)
 N INST,MG,XMTO,XMDUZ,XMSUBJ,XMBODY,N,X
"RTN","MDHL7U3",195,0)
 S MG=0
"RTN","MDHL7U3",196,0)
 S INST=DEVIEN
"RTN","MDHL7U3",197,0)
 I INST>1 S MG=$P($G(^MDS(702.09,INST,0)),"^",2)
"RTN","MDHL7U3",198,0)
 I 'MG!('$$MG^MDHL7U2(MG)) S MG=$$FIND1^DIC(3.8,"","BX","MD DEVICE ERRORS") Q:'MG
"RTN","MDHL7U3",199,0)
 S MG=$$GET1^DIQ(3.8,+MG_",",.01)
"RTN","MDHL7U3",200,0)
 S XMTO="G."_MG_"@"_^XMB("NETNAME"),XMINSTR("FROM")=.5
"RTN","MDHL7U3",201,0)
 S XMBODY="TXT"
"RTN","MDHL7U3",202,0)
 S XMSUBJ=SUBJECT
"RTN","MDHL7U3",203,0)
 D SENDMSG^XMXAPI(DUZ,XMSUBJ,XMBODY,XMTO,.XMINSTR)
"RTN","MDHL7U3",204,0)
 Q
"RTN","MDHL7U3",205,0)
 ;
"RTN","MDHL7U3",206,0)
ALERT(MDSIEN) ; This is to send an e-mail to the main device mail group that a study has been deleted
"RTN","MDHL7U3",207,0)
 D NOW^%DTC
"RTN","MDHL7U3",208,0)
 S SUBJECT="Study "_MDSIEN_" for Patient "_$$GET1^DIQ(702,MDSIEN,.01,"E")_" has been DELETED!"
"RTN","MDHL7U3",209,0)
 S BODY(1)="The following study has been deleted."
"RTN","MDHL7U3",210,0)
 S BODY(2)="         By the USER:       "_$$GET1^DIQ(200,DUZ,.01,"E")
"RTN","MDHL7U3",211,0)
 S BODY(3)="             On Date:       "_$$FMTE^XLFDT(%,1)
"RTN","MDHL7U3",212,0)
 S BODY(4)="           "
"RTN","MDHL7U3",213,0)
 S BODY(5)="                   CP Study Information"
"RTN","MDHL7U3",214,0)
 S BODY(6)="------------------------------------------------------------------------------ "
"RTN","MDHL7U3",215,0)
 S BODY(7)="CP Study ID:       "_MDSIEN
"RTN","MDHL7U3",216,0)
 S BODY(8)="CP Study Def:      "_$$GET1^DIQ(702,MDSIEN,.04,"E")
"RTN","MDHL7U3",217,0)
 S BODY(9)="Created on:        "_$$FMTE^XLFDT($$GET1^DIQ(702,MDSIEN,.02,"I"),1)
"RTN","MDHL7U3",218,0)
 S BODY(10)="Created by:        "_$$GET1^DIQ(702,MDSIEN,.03,"E")
"RTN","MDHL7U3",219,0)
 S BODY(11)="On Instrument:     "_$$GET1^DIQ(702,MDSIEN,.11,"E")
"RTN","MDHL7U3",220,0)
 S BODY(12)="For Patient:       "_$$GET1^DIQ(702,MDSIEN,.01,"E")
"RTN","MDHL7U3",221,0)
 S BODY(13)="        SSN:       "_$E($$GET1^DIQ(702,MDSIEN,.011,"E"),6,9)
"RTN","MDHL7U3",222,0)
 S BODY(14)="        DOB:       "_$$FMTE^XLFDT($$GET1^DIQ(702,MDSIEN,.012,"I"),1)
"RTN","MDHL7U3",223,0)
 S DEVIEN=$$GET1^DIQ(702,MDSIEN,.11,"I")
"RTN","MDHL7U3",224,0)
 Q
"RTN","MDHL7XXX")
0^16^B26957233^B4422982
"RTN","MDHL7XXX",1,0)
MDHL7XXX ; HOIFO/DP - Loopback device for CP ;4/10/09  09:20
"RTN","MDHL7XXX",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDHL7XXX",3,0)
 ; IA#  2263 [Supported] XPAR Call
"RTN","MDHL7XXX",4,0)
 ;      2693 [Subscription] TIU Extractions.
"RTN","MDHL7XXX",5,0)
 ;      2980 [Subscription] Calls to GMRCGUIB.
"RTN","MDHL7XXX",6,0)
 ;      3160 [Subscription] GMRCMED Call
"RTN","MDHL7XXX",7,0)
 ;      3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDHL7XXX",8,0)
 ;      3468 [Subscription] GMRCCP API.
"RTN","MDHL7XXX",9,0)
 ;      3535 [Subscription] Calls to TIUSRVP.
"RTN","MDHL7XXX",10,0)
 ;      4508 [Subscription] Call to TIUSRVPT.
"RTN","MDHL7XXX",11,0)
 ;     10060 [Supported] New Person File (#200) Read w/FM.
"RTN","MDHL7XXX",12,0)
 ;     10103 [Supported] Calls to XLFDT
"RTN","MDHL7XXX",13,0)
 ;
"RTN","MDHL7XXX",14,0)
EN ; [Procedure] Main entry point
"RTN","MDHL7XXX",15,0)
 ; wait 10 seconds and then produce some results in the CP RESULTS file
"RTN","MDHL7XXX",16,0)
 ; Variables STUDY and INST passed in via taskman
"RTN","MDHL7XXX",17,0)
 H 10 ; Wait for the study to update
"RTN","MDHL7XXX",18,0)
 N MDFDA,MDIEN,MDERR K ^TMP($J)
"RTN","MDHL7XXX",19,0)
 L +(^MDD(703.1,"B")):15 E  Q
"RTN","MDHL7XXX",20,0)
 F  D  Q:'$D(^MDD(703.1,"B",X))
"RTN","MDHL7XXX",21,0)
 .S X="127001_"_(+$H)_$E($P($H,",",2)_"00000",1,5)
"RTN","MDHL7XXX",22,0)
 S MDFDA(703.1,"+1,",.01)=X
"RTN","MDHL7XXX",23,0)
 D UPDATE^DIE("","MDFDA","MDIEN","MDERR")
"RTN","MDHL7XXX",24,0)
 L -(^MDD(703.1,"B"))
"RTN","MDHL7XXX",25,0)
 S MDIEN=+$G(MDIEN(1),-1)_"," Q:+MDIEN<0
"RTN","MDHL7XXX",26,0)
 ; Proceed to build the report here using MDIEN in file 703.1
"RTN","MDHL7XXX",27,0)
 S MDFDA(703.1,MDIEN,.02)=$P(^MDD(702,STUDY,0),U,1)
"RTN","MDHL7XXX",28,0)
 S MDFDA(703.1,MDIEN,.03)=$$NOW^XLFDT()
"RTN","MDHL7XXX",29,0)
 S MDFDA(703.1,MDIEN,.04)=INST
"RTN","MDHL7XXX",30,0)
 D:+$$GET1^DIQ(702.09,INST_",",.13,"I")  ; Bi-Directional?
"RTN","MDHL7XXX",31,0)
 .S MDFDA(703.1,MDIEN,.05)=STUDY
"RTN","MDHL7XXX",32,0)
 ;
"RTN","MDHL7XXX",33,0)
 ;; New Loopback Method -- BEGIN
"RTN","MDHL7XXX",34,0)
 S MDFDA(703.1,MDIEN,.09)="P"
"RTN","MDHL7XXX",35,0)
 S MDFDA(703.11,"+2,"_MDIEN,.01)="3"
"RTN","MDHL7XXX",36,0)
 S MDFDA(703.11,"+2,"_MDIEN,.1)="\\vhaishmul14\uploads\body-box-study_19960228_000.pdf"
"RTN","MDHL7XXX",37,0)
 D UPDATE^DIE("","MDFDA","MDIEN","MDERR")
"RTN","MDHL7XXX",38,0)
 ;; New Loopback Method -- END
"RTN","MDHL7XXX",39,0)
 ;
"RTN","MDHL7XXX",40,0)
 ; New High Volume Procedure code begin
"RTN","MDHL7XXX",41,0)
 N MDSR S MDSR=$$NTIU^MDRPCW1(+STUDY,+MDIEN)
"RTN","MDHL7XXX",42,0)
 ; New High Volume Procedure end 
"RTN","MDHL7XXX",43,0)
 ;; Original Loopback Method -- BEGIN
"RTN","MDHL7XXX",44,0)
 ;S MDFDA(703.11,"+2,"_MDIEN,.01)="1"
"RTN","MDHL7XXX",45,0)
 ;D UPDATE^DIE("","MDFDA","MDIEN","MDERR")
"RTN","MDHL7XXX",46,0)
 ;S MDIEN=+MDIEN(2)_","_MDIEN
"RTN","MDHL7XXX",47,0)
 ;S MDFDA(703.11,MDIEN,.2)=$NA(MDFDA(703.11,MDIEN,.2))
"RTN","MDHL7XXX",48,0)
 ;D GETS^DIQ(702,STUDY_",",".01;.011;.02;.03;.04;.05;.06;.07;.08;.09;.091;.1;.11;.12;.991","ENR",$NA(^TMP($J)))
"RTN","MDHL7XXX",49,0)
 ;S X="" F  S X=$O(^TMP($J,702,STUDY_",",X)) Q:X=""  D
"RTN","MDHL7XXX",50,0)
 ;.S Y=$O(MDFDA(703.11,MDIEN,.2,""),-1)+1
"RTN","MDHL7XXX",51,0)
 ;.S MDFDA(703.11,MDIEN,.2,Y)=X_": "_$G(^TMP($J,702,STUDY_",",X,"E"))
"RTN","MDHL7XXX",52,0)
 ;S MDFDA(703.1,$P(MDIEN,",",2,3),.09)="P"
"RTN","MDHL7XXX",53,0)
 ;D UPDATE^DIE("","MDFDA","MDIEN","MDERR")
"RTN","MDHL7XXX",54,0)
 ;; Original Loopback Method -- END
"RTN","MDHL7XXX",55,0)
 ;
"RTN","MDHL7XXX",56,0)
 K ^TMP($J)
"RTN","MDHL7XXX",57,0)
 Q
"RTN","MDHL7XXX",58,0)
 ;
"RTN","MDHL7XXX",59,0)
TEST ; Queue up the study creator
"RTN","MDHL7XXX",60,0)
 N DIC
"RTN","MDHL7XXX",61,0)
 S DIC=702,DIC(0)="AEQM",DIC("A")="Select Study to create a report for: "
"RTN","MDHL7XXX",62,0)
 D ^DIC Q:+Y<1
"RTN","MDHL7XXX",63,0)
 S STUDY=+Y,INST=+$P(^MDD(702,+Y,0),U,11)
"RTN","MDHL7XXX",64,0)
 D LOOPBACK(STUDY,INST)
"RTN","MDHL7XXX",65,0)
 Q
"RTN","MDHL7XXX",66,0)
 ;
"RTN","MDHL7XXX",67,0)
LOOPBACK(STUDY,INST) ; Queue up the Loopback process
"RTN","MDHL7XXX",68,0)
 N ZTSAVE,ZTRTN,ZTIO,ZTDESC,ZTDTH,ZTSK
"RTN","MDHL7XXX",69,0)
 S ZTSAVE("STUDY")=STUDY,ZTSAVE("INST")=INST
"RTN","MDHL7XXX",70,0)
 S ZTRTN="EN^MDHL7XXX"
"RTN","MDHL7XXX",71,0)
 S ZTIO=""
"RTN","MDHL7XXX",72,0)
 S ZTDESC="CP Loopback test"
"RTN","MDHL7XXX",73,0)
 S ZTDTH=$$NOW^XLFDT()
"RTN","MDHL7XXX",74,0)
 D ^%ZTLOAD
"RTN","MDHL7XXX",75,0)
 Q
"RTN","MDHL7XXX",76,0)
PROCESS ; Process Device Results
"RTN","MDHL7XXX",77,0)
 N MDADD,MDADAR,MDARAD,MDWA,MDALRT,MDAPU,MDCONRS,MDCST,MDCX,MDFD,MDFDA,MDL,MDL1,MDHR,MDHVL,MDKK,MDMAXD,MDMG,MDRR,MDSTU,MDSTAT,MDTIUER,MDX,MDX4
"RTN","MDHL7XXX",78,0)
 S MDMAXD=DT+.24,(MDRR,MDARAD,MDTIUER)="" K ^TMP("MDTIUST",$J)
"RTN","MDHL7XXX",79,0)
 D GETLST^XPAR(.MDHVL,"SYS","MD GET HIGH VOLUME")
"RTN","MDHL7XXX",80,0)
 S MDAPU="CLINICAL,DEVICE PROXY SERVICE"
"RTN","MDHL7XXX",81,0)
 S MDFD=$$FIND1^DIC(200,,"X",MDAPU,"B")
"RTN","MDHL7XXX",82,0)
 F MDKK=0:0 S MDKK=$O(MDHVL(MDKK)) Q:MDKK<1  S:+$P($G(MDHVL(MDKK)),"^") MDHR(+$P($G(MDHVL(MDKK)),"^"))=$P($G(MDHVL(MDKK)),"^",2)
"RTN","MDHL7XXX",83,0)
 S MDL=$$FMADD^XLFDT(DT,-5,0,0)  F  S MDL=$O(^MDD(702,"ASD",MDL)) Q:MDL<1!(MDL>MDMAXD)  F MDL1=0:0 S MDL1=$O(^MDD(702,"ASD",MDL,MDL1)) Q:MDL1<1  S MDX=$G(^MDD(702,MDL1,0)) D
"RTN","MDHL7XXX",84,0)
 .Q:$G(MDHR(+$P(MDX,"^",4)))=""  S MDCX=$G(MDHR(+$P(MDX,"^",4)))
"RTN","MDHL7XXX",85,0)
 .Q:$P($G(^MDS(702.01,+$P(MDX,U,4),0)),U,6)=2
"RTN","MDHL7XXX",86,0)
 .S MDCST=$P(MDX,"^",5) Q:'+MDCST
"RTN","MDHL7XXX",87,0)
 .Q:'+$P(MDX,"^",6)
"RTN","MDHL7XXX",88,0)
 .K ^TMP("MDTIUST",$J),MDWA
"RTN","MDHL7XXX",89,0)
 .S MDWA(1202)=MDFD,MDWA(1204)=MDFD,MDWA(1302)=MDFD
"RTN","MDHL7XXX",90,0)
 .S MDWA("TEXT",1,0)="** DOCUMENT IN VISTA IMAGING **"
"RTN","MDHL7XXX",91,0)
 .S MDWA("TEXT",2,0)="SEE FULL REPORT IN VISTA IMAGING",MDWA("TEXT",3,0)=""
"RTN","MDHL7XXX",92,0)
 .D EXTRACT^TIULQ($P(MDX,U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05","E")
"RTN","MDHL7XXX",93,0)
 .I $G(^TMP("MDTIUST",$J,$P(MDX,U,6),.05,"E"))'="COMPLETED"&('+$P(MDCX,";",2)) D  Q
"RTN","MDHL7XXX",94,0)
 ..Q:$P(MDX,"^",9)'=3
"RTN","MDHL7XXX",95,0)
 ..I +$P(MDCX,";",1) S MDCONRS=$$CPDOC^GMRCCP(+MDCST,+$P(MDX,"^",6),2) Q
"RTN","MDHL7XXX",96,0)
 ..I '+$P(MDCX,";",1) D UPDATE^TIUSRVP(.MDRR,+$P(MDX,"^",6),.MDWA,1) D:+MDRR'<1 ADMNCLOS^TIUSRVPT(.MDARAD,+$P(MDX,"^",6),"M",MDFD) K MDWA D MEDCOMP^GMRCMED(+MDCST,$P(MDX,"^",6)_";TIU(8925,",DT,MDFD,$P(MDX,"^",3))
"RTN","MDHL7XXX",97,0)
 ..Q
"RTN","MDHL7XXX",98,0)
 .S MDSTU=MDL1 K MDWA
"RTN","MDHL7XXX",99,0)
 .S MDSTAT=$$GET1^DIQ(123,+MDCST_",",8,"E") I MDSTAT="COMPLETE" Q:$P(MDX,"^",9)=3  K MDFDA S MDFDA(702,MDSTU_",",.09)=3 D FILE^DIE("","MDFDA") K MDFDA Q
"RTN","MDHL7XXX",100,0)
 .I +$P(MDCX,";",2) D  Q
"RTN","MDHL7XXX",101,0)
 ..D GID(MDSTU,.MDADAR)
"RTN","MDHL7XXX",102,0)
 ..Q:$G(MDADAR(1))=""
"RTN","MDHL7XXX",103,0)
 ..S MDADD=$$SFILE^GMRCGUIB(+MDCST,4,"Y",MDFD,MDFD,.MDADAR,"N","",$G(^MDD(702,+MDSTU,3)))
"RTN","MDHL7XXX",104,0)
 ..S MDCONRS=$$CPDOC^GMRCCP(+MDCST,+$P(MDX,"^",6),2) Q
"RTN","MDHL7XXX",105,0)
 .S MDGET=$O(^MDD(703.1,"ASTUDYID",MDL1,""),-1) Q:'MDGET  S MDDAT=$P($G(^MDD(703.1,MDGET,0)),"^",3)
"RTN","MDHL7XXX",106,0)
 .D MEDCOMP^GMRCMED(+MDCST,$P(MDX,"^",6)_";TIU(8925,",MDDAT,MDFD,$P(MDX,"^",3))
"RTN","MDHL7XXX",107,0)
 .K ^TMP("MDTIUST",$J)
"RTN","MDHL7XXX",108,0)
 .I $P(MDX,"^",9)'=3 K MDFDA S MDFDA(702,MDSTU_",",.09)=3 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDHL7XXX",109,0)
 Q
"RTN","MDHL7XXX",110,0)
GID(STU,MDARY) ; Get the text array
"RTN","MDHL7XXX",111,0)
 N LOOP,MDRID,NODE S MDRID=0,LOOP=""
"RTN","MDHL7XXX",112,0)
 F  S LOOP=$O(^MDD(703.1,"ASTUDYID",STU,LOOP),-1) Q:LOOP<1!(+MDRID)  I +$P($G(^MDD(703.1,+LOOP,.4,0)),"^",3) S MDRID=+LOOP,NODE=$$GET1^DIQ(703.1,MDRID_",",.4,"","MDARY")
"RTN","MDHL7XXX",113,0)
 I +MDRID K MDFDA S MDFDA(703.1,MDRID_",",.4)="@" D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDHL7XXX",114,0)
 Q
"RTN","MDNCHK")
0^32^B2544252^B2266513
"RTN","MDNCHK",1,0)
MDNCHK ; HOIFO/NCA - CP Multiple Result Check ;4/26/05  15:17
"RTN","MDNCHK",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11,21**;Apr 01, 2004;Build 30
"RTN","MDNCHK",3,0)
 ; Reference
"RTN","MDNCHK",4,0)
 ; IA#  2263 [Supported] Calls to XPAR.
"RTN","MDNCHK",5,0)
 ; IA# 10103 [Supported] Call to XLFDT
"RTN","MDNCHK",6,0)
 ;
"RTN","MDNCHK",7,0)
CHK(MDIEN) ; RPC call to notify Consult of results
"RTN","MDNCHK",8,0)
 ; Input parameters
"RTN","MDNCHK",9,0)
 ;  1. MDIEN [Literal/Required] CP Study
"RTN","MDNCHK",10,0)
 ;
"RTN","MDNCHK",11,0)
 N MDDEF,MDERR,MDHLOC,MDIENS,MDION,MDFDA,MDSTAT,MDSTR,MDSUBL
"RTN","MDNCHK",12,0)
 I '$G(MDIEN) S MDIEN="" Q MDIEN
"RTN","MDNCHK",13,0)
 S MDDEF=+$$GET1^DIQ(702,MDIEN,.04,"I") I 'MDDEF Q MDIEN
"RTN","MDNCHK",14,0)
 S MDSTAT=+$$GET1^DIQ(702.01,MDDEF,.12,"I") I 'MDSTAT Q MDIEN
"RTN","MDNCHK",15,0)
 S MDION=+$$GET1^DIQ(702,MDIEN,.12,"I") I 'MDION Q MDIEN
"RTN","MDNCHK",16,0)
 I MDSTAT=2 Q MDIEN
"RTN","MDNCHK",17,0)
 S MDSTR=$G(^MDD(702,MDIEN,0)) I MDSTR="" Q MDIEN
"RTN","MDNCHK",18,0)
 I $P(MDSTR,"^",9)'=3 Q MDIEN
"RTN","MDNCHK",19,0)
 I $$GET^XPAR("SYS","MD GET HIGH VOLUME",MDDEF,"I")'="" Q MDIEN
"RTN","MDNCHK",20,0)
 K ^MDD(702,"AION",+MDION,MDIEN)
"RTN","MDNCHK",21,0)
 S MDSUBL=$P(MDSTR,U,7)
"RTN","MDNCHK",22,0)
 S MDHLOC=+$$GET1^DIQ(702.01,MDDEF,.05,"I"),MDSUBL=$P(MDSUBL,";",1,2)_";"_MDHLOC
"RTN","MDNCHK",23,0)
 S MDFDA(702,"+1,",.01)=$P(MDSTR,U,1)
"RTN","MDNCHK",24,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDNCHK",25,0)
 S MDFDA(702,"+1,",.03)=$P(MDSTR,U,3)
"RTN","MDNCHK",26,0)
 S MDFDA(702,"+1,",.04)=$P(MDSTR,U,4)
"RTN","MDNCHK",27,0)
 S MDFDA(702,"+1,",.05)=$P(MDSTR,U,5)
"RTN","MDNCHK",28,0)
 S MDFDA(702,"+1,",.07)=$P(MDSTR,U,7)
"RTN","MDNCHK",29,0)
 S MDFDA(702,"+1,",.09)=5
"RTN","MDNCHK",30,0)
 S MDFDA(702,"+1,",.11)=$P(MDSTR,U,11)
"RTN","MDNCHK",31,0)
 S MDFDA(702,"+1,",.12)=$P(MDSTR,U,12)
"RTN","MDNCHK",32,0)
 D UPDATE^DIE("","MDFDA","MDIENS","MDERR")
"RTN","MDNCHK",33,0)
 S MDIEN=MDIENS(1)
"RTN","MDNCHK",34,0)
 Q MDIEN
"RTN","MDPCE")
0^2^B4196998^B4577099
"RTN","MDPCE",1,0)
MDPCE ; HIRMFO/NCA - Routine For Data Extract ;6/9/08  13:29
"RTN","MDPCE",2,0)
 ;;1.0;CLINICAL PROCEDURES;**5,21**;Apr 01, 2004;Build 30
"RTN","MDPCE",3,0)
 ; Integration Agreements:
"RTN","MDPCE",4,0)
 ; IA# 1889 [Subscription] Create New Visit
"RTN","MDPCE",5,0)
 ;
"RTN","MDPCE",6,0)
EN1(MDINST,MDPDTE,MDPR,MDTYP,MDETYP) ; [Function] PCE Visit Creation
"RTN","MDPCE",7,0)
 ; Input parameters
"RTN","MDPCE",8,0)
 ;  1. MDINST [Literal/Required] Transaction IEN
"RTN","MDPCE",9,0)
 ;  2. MDPDT [Literal/Optional] Procedure Date/Time
"RTN","MDPCE",10,0)
 ;  3. MDPR [Literal/Required] CP Definition
"RTN","MDPCE",11,0)
 ;  4. MDTYP [Literal/Required] Type of Visit (Ambulatory or Hospitalization or Event (Historical))
"RTN","MDPCE",12,0)
 ;  5. MDETYP [Literal/Required] Encounter Type (Primary or Ancillary)
"RTN","MDPCE",13,0)
 ;
"RTN","MDPCE",14,0)
 N DATA,MDCLOC,MDPERR,MDJ,MDPKG,MDRES,MDSTR,MDVISIT,MDDRES K ^TMP("MDPXAPI",$J)
"RTN","MDPCE",15,0)
 S MDOUT=""
"RTN","MDPCE",16,0)
 S MDPKG=$$FIND1^DIC(9.4,"","MX","CLINICAL PROCEDURES")
"RTN","MDPCE",17,0)
 I 'MDPKG Q "-1^CLINICAL PROCEDURES does not exist in Package File."
"RTN","MDPCE",18,0)
 I '$D(^MDD(702,MDINST,0)) Q "-1^No Study Record."
"RTN","MDPCE",19,0)
 S MDSTR=$G(^MDD(702,MDINST,0))
"RTN","MDPCE",20,0)
 S MDJ=0,MDJ=MDJ+1
"RTN","MDPCE",21,0)
 S MDCLOC=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDPCE",22,0)
 I 'MDCLOC S:MDPR["^" MDCLOC=$P(MDPR,"^",2)
"RTN","MDPCE",23,0)
 I 'MDCLOC Q "-1^No Hospital Location for CP Definition."
"RTN","MDPCE",24,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"ENC D/T")=MDPDTE
"RTN","MDPCE",25,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"PATIENT")=$P(MDSTR,"^",1)
"RTN","MDPCE",26,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"HOS LOC")=MDCLOC
"RTN","MDPCE",27,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"SERVICE CATEGORY")=MDTYP
"RTN","MDPCE",28,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"ENCOUNTER TYPE")=MDETYP
"RTN","MDPCE",29,0)
 S MDRES=$$DATA2PCE^PXAPI("^TMP(""MDPXAPI"",$J)",MDPKG,"CLINICAL PROCEDURES",.MDVISIT,"","",1,"",.MDPERR)
"RTN","MDPCE",30,0)
 I MDRES D  Q MDOUT
"RTN","MDPCE",31,0)
 .S MDOUT=MDVISIT_"^"_MDCLOC_";"_MDPDTE_";"_MDTYP
"RTN","MDPCE",32,0)
 .S MDFDA(702,MDINST_",",.07)=MDTYP_";"_MDPDTE_";"_MDCLOC
"RTN","MDPCE",33,0)
 .S:MDVISIT>0 MDFDA(702,MDINST_",",.13)=MDVISIT
"RTN","MDPCE",34,0)
 .D FILE^DIE("K","MDFDA") K ^TMP("MDPXAPI",$J)
"RTN","MDPCE",35,0)
 K ^TMP("MDPXAPI",$J)
"RTN","MDPCE",36,0)
 S MDOUT="-1^PCE Visit Creation Error."
"RTN","MDPCE",37,0)
 Q MDOUT
"RTN","MDPCE2")
0^3^B24598640^B23364191
"RTN","MDPCE2",1,0)
MDPCE2 ; HOIFO/NCA - Routine For Data Extract For Hemo Dialysis;9/10/04  11:23 ;1/20/10  10:00
"RTN","MDPCE2",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21**;Apr 01, 2004;Build 30
"RTN","MDPCE2",3,0)
 ; Integration Agreements:
"RTN","MDPCE2",4,0)
 ; IA# 1889 [Subscription] Create New Visit - DATA2PCE^PXAPI call
"RTN","MDPCE2",5,0)
 ;     1890 [Subscription] Delete existing visit - DELVFILE^PXAPI call
"RTN","MDPCE2",6,0)
 ;     1995 [Supported] ICPTCOD API Call
"RTN","MDPCE2",7,0)
 ;     3990 [Supported] ICDCODE API Call
"RTN","MDPCE2",8,0)
 ;    10040 [Supported] Hospital Location File Access
"RTN","MDPCE2",9,0)
 ;    10048 [Supported] FILE 9.4 references
"RTN","MDPCE2",10,0)
 ;    10103 [Supported] XLFDT calls
"RTN","MDPCE2",11,0)
 ;
"RTN","MDPCE2",12,0)
EN1(MDENC,MDINST,MDPDTE,MDPR,MDTYP,MDETYP,MDCLOC) ; [Function] PCE Visit Creation
"RTN","MDPCE2",13,0)
 ; Input parameters
"RTN","MDPCE2",14,0)
 ;  1. MDENC [Literal/Required] Billing data array
"RTN","MDPCE2",15,0)
 ;  2. MDINST [Literal/Required] Transaction IEN
"RTN","MDPCE2",16,0)
 ;  3. MDPDTE [Literal/Optional] Procedure Date/Time
"RTN","MDPCE2",17,0)
 ;  4. MDPR [Literal/Required] CP Definition
"RTN","MDPCE2",18,0)
 ;  5. MDTYP [Literal/Required] Type of Visit (Ambulatory or Hospitalization)
"RTN","MDPCE2",19,0)
 ;  6. MDETYP [Literal/Required] Encounter Type (Primary or Ancillary)
"RTN","MDPCE2",20,0)
 ;  7. MDCLOC [Literal/Required] Workload Reporting hospital location
"RTN","MDPCE2",21,0)
 ;
"RTN","MDPCE2",22,0)
 N DATA,DIAG,MDCCOD,MDCLIN,MDCLL,MDDESC,MDPERR,MDJ,MDK,MDL,MDLST,MDM,MDNOD,MDOK,MDOK1,MDOK2,MDPKG,MDPROV,MDRES,MDSC,MDSTR,MDV1,MDVISIT,MDDRES K ^TMP("MDPXAPI",$J)
"RTN","MDPCE2",23,0)
 S MDOUT="",(MDOK,MDOK1,MDOK2,MDSC)=0
"RTN","MDPCE2",24,0)
 S MDPKG=$$FIND1^DIC(9.4,"","MX","CLINICAL PROCEDURES")
"RTN","MDPCE2",25,0)
 I 'MDPKG Q "-1^CLINICAL PROCEDURES does not exist in Package File."
"RTN","MDPCE2",26,0)
 I '$D(^MDD(702,MDINST,0)) Q "-1^No Study Record."
"RTN","MDPCE2",27,0)
 S MDSTR=$G(^MDD(702,MDINST,0))
"RTN","MDPCE2",28,0)
 S MDCLIN=$G(^MDD(702,MDINST,1))
"RTN","MDPCE2",29,0)
 S MDRES=""
"RTN","MDPCE2",30,0)
 I +$P(MDCLIN,U) S MDRES=$$DELVFILE^PXAPI("PRV^POV^CPT",+$P(MDCLIN,U),"","CLINICAL PROCEDURES") S MDVISIT=+MDCLIN
"RTN","MDPCE2",31,0)
 ;I +MDRES<0 Q $P(MDRES,"^")_"^Cannot purge existing visit during PCE data set."
"RTN","MDPCE2",32,0)
 S (MDJ,MDK,MDL,MDM)=0,MDJ=MDJ+1,MDPROV=""
"RTN","MDPCE2",33,0)
 I '$G(MDCLOC) S MDCLOC=$$GET1^DIQ(702.01,+MDPR_",",.05,"I") I 'MDCLOC Q "-1^No Hospital Location for CP Definition."
"RTN","MDPCE2",34,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"ENC D/T")=MDPDTE
"RTN","MDPCE2",35,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"PATIENT")=$P(MDSTR,"^",1)
"RTN","MDPCE2",36,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"HOS LOC")=MDCLOC
"RTN","MDPCE2",37,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"SERVICE CATEGORY")=$S(MDTYP="V":"A",1:MDTYP)
"RTN","MDPCE2",38,0)
 S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"ENCOUNTER TYPE")=MDETYP
"RTN","MDPCE2",39,0)
 I $$GET1^DIQ(44,MDCLOC_",",3,"I") S ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"INSTITUTION")=$$GET1^DIQ(44,MDCLOC_",",3,"I")
"RTN","MDPCE2",40,0)
 S MDLST="" F  S MDLST=$O(MDENC(MDLST)) Q:MDLST=""  S MDNOD=$G(MDENC(MDLST)) D
"RTN","MDPCE2",41,0)
 .I $P(MDNOD,"^")["SC" D  Q
"RTN","MDPCE2",42,0)
 ..S:+$P(MDNOD,";",2) ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"SC")=+$P($P(MDNOD,";",2),U,2) S:+$P($P(MDNOD,";",2),U,2)>0 MDSC=1
"RTN","MDPCE2",43,0)
 ..I $P(MDNOD,";",3)="AO" Q:+MDSC>0  S:+$P(MDNOD,";",4) ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"AO")=+$P($P(MDNOD,";",4),"^",2)
"RTN","MDPCE2",44,0)
 ..I $P(MDNOD,";",5)="IR" Q:+MDSC>0  S:+$P(MDNOD,";",6) ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"IR")=+$P($P(MDNOD,";",6),"^",2)
"RTN","MDPCE2",45,0)
 ..I $P(MDNOD,";",7)="EC" Q:+MDSC>0  S:+$P(MDNOD,";",8) ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"EC")=+$P($P(MDNOD,";",8),"^",2)
"RTN","MDPCE2",46,0)
 ..I $P(MDNOD,";",9)="MST" Q:+MDSC>0  S:+$P(MDNOD,";",10) ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"MST")=+$P($P(MDNOD,";",10),"^",2)
"RTN","MDPCE2",47,0)
 ..I $P(MDNOD,";",11)="HNC" Q:+MDSC>0  S:+$P(MDNOD,";",12) ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"HNC")=+$P($P(MDNOD,";",12),"^",2)
"RTN","MDPCE2",48,0)
 ..I $P(MDNOD,";",13)="CV" Q:+MDSC>0  S:+$P(MDNOD,";",14) ^TMP("MDPXAPI",$J,"ENCOUNTER",MDJ,"CV")=+$P($P(MDNOD,";",14),"^",2)
"RTN","MDPCE2",49,0)
 .I $P(MDNOD,"^")="PRV" I $P(MDNOD,"^",2)'="" D  Q
"RTN","MDPCE2",50,0)
 ..S MDK=MDK+1,^TMP("MDPXAPI",$J,"PROVIDER",MDK,"NAME")=$P(MDNOD,"^",2) S:'MDOK MDOK=1
"RTN","MDPCE2",51,0)
 ..S ^TMP("MDPXAPI",$J,"PROVIDER",MDK,"PRIMARY")=$P(MDNOD,"^",6)
"RTN","MDPCE2",52,0)
 ..S:MDPROV="" MDPROV=$P(MDNOD,"^",2)
"RTN","MDPCE2",53,0)
 ..Q
"RTN","MDPCE2",54,0)
 .I $P(MDNOD,"^")="POV" D  Q
"RTN","MDPCE2",55,0)
 ..Q:$P(MDNOD,"^",3)=""
"RTN","MDPCE2",56,0)
 ..S MDCCOD=$$CODEN^ICDCODE($P(MDNOD,"^",3),"") S MDCCOD=+$P(MDCCOD,"^") Q:+MDCCOD<1
"RTN","MDPCE2",57,0)
 ..S MDL=MDL+1,^TMP("MDPXAPI",$J,"DX/PL",MDL,"DIAGNOSIS")=MDCCOD
"RTN","MDPCE2",58,0)
 ..S ^TMP("MDPXAPI",$J,"DX/PL",MDL,"PRIMARY")=$P(MDNOD,"^",6)
"RTN","MDPCE2",59,0)
 ..S ^TMP("MDPXAPI",$J,"DX/PL",MDL,"ORD/RES")="R"
"RTN","MDPCE2",60,0)
 ..S ^TMP("MDPXAPI",$J,"DX/PL",MDL,"CATEGORY")=$P(MDNOD,"^",4)
"RTN","MDPCE2",61,0)
 ..S DIAG=$$ICDDX^ICDCODE($P(MDNOD,"^",3),"")
"RTN","MDPCE2",62,0)
 ..S ^TMP("MDPXAPI",$J,"DX/PL",MDL,"NARRATIVE")=$P(DIAG,"^",4)
"RTN","MDPCE2",63,0)
 ..S:MDPROV ^TMP("MDPXAPI",$J,"DX/PL",MDL,"ENC PROVIDER")=MDPROV
"RTN","MDPCE2",64,0)
 ..S:'MDOK1 MDOK1=1
"RTN","MDPCE2",65,0)
 .I $P(MDNOD,"^")="CPT" D  Q
"RTN","MDPCE2",66,0)
 ..Q:$P(MDNOD,U,3)=""
"RTN","MDPCE2",67,0)
 ..S MDCCOD=$$CPT^ICPTCOD($P(MDNOD,U,3)) Q:+MDCCOD<1
"RTN","MDPCE2",68,0)
 ..S MDM=MDM+1 S:'MDOK2 MDOK2=1
"RTN","MDPCE2",69,0)
 ..S MDDESC="",MDDESC=$P(MDNOD,"^",5)
"RTN","MDPCE2",70,0)
 ..S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230)
"RTN","MDPCE2",71,0)
 ..S:MDDESC="" MDDESC=$P(MDCCOD,"^",3)
"RTN","MDPCE2",72,0)
 ..S ^TMP("MDPXAPI",$J,"PROCEDURE",MDM,"PROCEDURE")=$P(MDCCOD,"^")
"RTN","MDPCE2",73,0)
 ..S ^TMP("MDPXAPI",$J,"PROCEDURE",MDM,"NARRATIVE")=MDDESC
"RTN","MDPCE2",74,0)
 ..S ^TMP("MDPXAPI",$J,"PROCEDURE",MDM,"CATEGORY")=$P(MDNOD,"^",4)
"RTN","MDPCE2",75,0)
 ..S ^TMP("MDPXAPI",$J,"PROCEDURE",MDM,"QTY")=$P(MDNOD,"^",7)
"RTN","MDPCE2",76,0)
 ..S:MDPROV ^TMP("MDPXAPI",$J,"PROCEDURE",MDM,"ENC PROVIDER")=MDPROV
"RTN","MDPCE2",77,0)
 I (MDOK+MDOK1+MDOK2)=3 S ^TMP("MDPXAPI",$J,"ENCOUNTER",1,"CHECKOUT D/T")=$$NOW^XLFDT
"RTN","MDPCE2",78,0)
 S MDRES=$$DATA2PCE^PXAPI("^TMP(""MDPXAPI"",$J)",MDPKG,"CLINICAL PROCEDURES",.MDVISIT,"","",1,"",.MDPERR)
"RTN","MDPCE2",79,0)
 I MDRES<1 D  Q MDOUT
"RTN","MDPCE2",80,0)
 .S MDOUT=1
"RTN","MDPCE2",81,0)
 .I MDVISIT>0 S MDFDA(702,MDINST_",",.13)=MDVISIT,MDOUT=MDVISIT_"^"_MDCLOC_";"_MDPDTE_";"_MDTYP,MDFDA(702,MDINST_",",.07)=MDTYP_";"_MDPDTE_";"_MDCLOC D FILE^DIE("K","MDFDA")
"RTN","MDPCE2",82,0)
 .K ^TMP("MDPXAPI",$J) Q
"RTN","MDPCE2",83,0)
 S:MDVISIT>0 MDFDA(702,MDINST_",",.13)=MDVISIT
"RTN","MDPCE2",84,0)
 S MDOUT=MDVISIT_"^"_MDCLOC_";"_MDPDTE_";"_MDTYP
"RTN","MDPCE2",85,0)
 S MDFDA(702,MDINST_",",.07)=MDTYP_";"_MDPDTE_";"_MDCLOC
"RTN","MDPCE2",86,0)
 D FILE^DIE("K","MDFDA") K ^TMP("MDPXAPI",$J)
"RTN","MDPCE2",87,0)
 Q MDOUT
"RTN","MDPOST21")
0^^B3149541^n/a
"RTN","MDPOST21",1,0)
MDPOST21 ; HOIFO/NCA - Post Init ;2/7/07  16:15
"RTN","MDPOST21",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDPOST21",3,0)
 ; Integration Agreements:
"RTN","MDPOST21",4,0)
 ; IA#  2263 [Supported] XPAR routine calls. 
"RTN","MDPOST21",5,0)
 ;      4677 [Subscription] XUSAP routine call
"RTN","MDPOST21",6,0)
 ;     10060 [Supported] New Person file #200 Read w/Fileman
"RTN","MDPOST21",7,0)
 ;     10141 [Supported] XPDUTL routine call
"RTN","MDPOST21",8,0)
 ;
"RTN","MDPOST21",9,0)
EN ; [Procedure] Setup Application PROXY 
"RTN","MDPOST21",10,0)
 ; This submodule is called during the KIDS installation
"RTN","MDPOST21",11,0)
 ; process.
"RTN","MDPOST21",12,0)
 ;
"RTN","MDPOST21",13,0)
 ; New private variables
"RTN","MDPOST21",14,0)
 N MDFD,MDFMC,MDHERR,MDHLST,MDK,MDL,MDOPT,MDAPU S MDAPU="CLINICAL,DEVICE PROXY SERVICE"
"RTN","MDPOST21",15,0)
 S MDOPT("MD GUI USER")=1,MDOPT("MD GUI MANAGER")=1,MDFMC=""
"RTN","MDPOST21",16,0)
 S MDFD=$$FIND1^DIC(200,,"X",MDAPU,"B") Q:+MDFD
"RTN","MDPOST21",17,0)
 S MDK=+$$CREATE^XUSAP(MDAPU,MDFMC,.MDOPT)
"RTN","MDPOST21",18,0)
 I MDK>0 S MDTXT(1)="'"_MDAPU_"' has been created as an Application Proxy User."
"RTN","MDPOST21",19,0)
 I MDK<0 S XPDABORT=1 D
"RTN","MDPOST21",20,0)
 .S MDTXT(1)="The post-init routine has stopped.  The Application Proxy User"
"RTN","MDPOST21",21,0)
 .S MDTXT(2)="was not created.  Make sure the name '"_MDAPU_"' is unique in"
"RTN","MDPOST21",22,0)
 .S MDTXT(3)="the NEW PERSON file (#200).  The patch can not continue until"
"RTN","MDPOST21",23,0)
 .S MDTXT(4)="the Application Proxy User can be created."
"RTN","MDPOST21",24,0)
 D:$O(MDTXT(0)) BMES^XPDUTL(.MDTXT)
"RTN","MDPOST21",25,0)
 Q:+$$PATCH^XPDUTL("MD*1.0*21")
"RTN","MDPOST21",26,0)
 D GETLST^XPAR(.MDHLST,"SYS","MD GET HIGH VOLUME")
"RTN","MDPOST21",27,0)
 I +$G(MDHLST) D NDEL^XPAR("SYS","MD GET HIGH VOLUME",.MDHERR)
"RTN","MDPOST21",28,0)
 Q
"RTN","MDPS1")
0^20^B81903471^B77051543
"RTN","MDPS1",1,0)
MDPS1 ; HOIFO/NCA - CP/Medicine Report Generator ;5/18/04  09:48
"RTN","MDPS1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**2,10,13,21**;Apr 01, 2004;Build 30
"RTN","MDPS1",3,0)
 ; Integration Agreements:
"RTN","MDPS1",4,0)
 ; IA# 2263 [Supported] XPAR calls.
"RTN","MDPS1",5,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDPS1",6,0)
 ; IA# 2925 [Subscription] Calls to GMRCSLM2.
"RTN","MDPS1",7,0)
 ; IA# 2926 [Subscription] Calls to GMRCGUIA.
"RTN","MDPS1",8,0)
 ; IA# 2944 [Subscription] Calls to TIUSRVR1.
"RTN","MDPS1",9,0)
 ; IA# 3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDPS1",10,0)
 ; IA# 4230 [Subscription] Document MDPS1 calls (CP Custodian).
"RTN","MDPS1",11,0)
 ; IA# 4231 [Subscription] Document CKP^GMTSUP usage.
"RTN","MDPS1",12,0)
 ; IA# 4792 [Private] CANDO^TIUSRVA call
"RTN","MDPS1",13,0)
 ; IA# 10017 [Supported] DD("DD")
"RTN","MDPS1",14,0)
 ; IA# 10103 [Supported] XLFDT Call
"RTN","MDPS1",15,0)
 ; IA# 10104 [Supported] Routine XLFSTR calls
"RTN","MDPS1",16,0)
 ;
"RTN","MDPS1",17,0)
 ; Pre-existing local variables
"RTN","MDPS1",18,0)
 ; DFN,GMTS1,GMTS2,GMTSNDM,GMTSNPG,GMTSQIT
"RTN","MDPS1",19,0)
 ;
"RTN","MDPS1",20,0)
EN1(MDGLO,MDDFN,MDSDT,MDEDT,MDMAX,MDPSC,MDALL) ; Return the List of Completed Studies
"RTN","MDPS1",21,0)
 ; Input: MDGLO - Return Global Array (Required)
"RTN","MDPS1",22,0)
 ;        MDDFN - Patient DFN         (Required)
"RTN","MDPS1",23,0)
 ;        MDSDT - Start Date in FM Internal Format (Optional)
"RTN","MDPS1",24,0)
 ;        MDEDT - End Date in FM Internal Format (Optional)
"RTN","MDPS1",25,0)
 ;        MDMAX - Number of studies to return    (Optional)
"RTN","MDPS1",26,0)
 ;        MDPSC - Procedure Summary Code         (Optional)
"RTN","MDPS1",27,0)
 ;        MDALL - Return the all text reports with
"RTN","MDPS1",28,0)
 ;                the procedures list            (Optional)
"RTN","MDPS1",29,0)
 ; (Returns all studies for Patient, if no MDSDT, MDEDT,and MDMAX.)
"RTN","MDPS1",30,0)
 ;
"RTN","MDPS1",31,0)
 I '$G(MDDFN)!('$D(MDGLO)) Q
"RTN","MDPS1",32,0)
 I $G(MDGLO)="" S MDGLO=$NA(^TMP("MDHSP",$J))
"RTN","MDPS1",33,0)
 N MDARR,MDCODE,MDCON,MDCTR,MDDTE,MDLP,MDLP1,MDPLST,MDPROC,MDSTAT,MDT,MDTIUER,MDX,Y
"RTN","MDPS1",34,0)
 S (MDIMG,MDCTR)=0,(MDCODE,MDDTE,MDTIUER)="",MDC=$G(MDPSC)
"RTN","MDPS1",35,0)
 K ^TMP("MDPLST",$J) S MDPLST=$NA(^TMP("MDPLST",$J))
"RTN","MDPS1",36,0)
 ;
"RTN","MDPS1",37,0)
 ; If not converted call old medicine gather routine
"RTN","MDPS1",38,0)
 D:$G(MDC)="" GP^MDPS4(MDDFN,MDSDT,MDEDT)
"RTN","MDPS1",39,0)
 I '$G(MDSDT),'$G(MDEDT) D EN^MDARP3(MDDFN,MDC)
"RTN","MDPS1",40,0)
 E  D EN^MCARPS3(MDDFN,MDC,MDSDT,MDEDT)
"RTN","MDPS1",41,0)
 ;
"RTN","MDPS1",42,0)
 ; Get CP procedures
"RTN","MDPS1",43,0)
 D GET702(.MDGLO,MDDFN,MDC,MDSDT,MDEDT,$S(+$G(MDMAX):MDMAX,1:999))
"RTN","MDPS1",44,0)
 K ^TMP("MDPLST",$J)
"RTN","MDPS1",45,0)
 Q
"RTN","MDPS1",46,0)
 ;
"RTN","MDPS1",47,0)
GET702(MDGLO,MDDFN,MDC,MDSDT,MDEDT,MDMAX) ; Gather the new 702 entries
"RTN","MDPS1",48,0)
 S MDLP="" F  S MDLP=$O(^MDD(702,"B",MDDFN,MDLP)) Q:MDLP<1  D
"RTN","MDPS1",49,0)
 .S MDX=$G(^MDD(702,MDLP,0)) Q:$P(MDX,"^",9)'=3
"RTN","MDPS1",50,0)
 .S MDPROC=$$GET1^DIQ(702,MDLP_",",.04,"E") Q:MDPROC=""
"RTN","MDPS1",51,0)
 .Q:'$P(MDX,U,6)
"RTN","MDPS1",52,0)
 .K ^TMP("MDTIUST",$J) S MDTIUER=""
"RTN","MDPS1",53,0)
 .D EXTRACT^TIULQ($P(MDX,U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;70201;70202") Q:+MDTIUER
"RTN","MDPS1",54,0)
 .S MDCODE=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),70201,"E"))
"RTN","MDPS1",55,0)
 .S:MDCODE'="" MDCODE=$$UP^XLFSTR(MDCODE)
"RTN","MDPS1",56,0)
 .I $G(MDC)'="" Q:MDCODE'=$G(MDC)
"RTN","MDPS1",57,0)
 .S MDDTE=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),70202,"I"))
"RTN","MDPS1",58,0)
 .S MDSTAT=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),.05,"E"))
"RTN","MDPS1",59,0)
 .S:'MDDTE MDDTE=$$GET1^DIQ(702,MDLP_",",.02,"I")
"RTN","MDPS1",60,0)
 .K ^TMP("MDTIUST",$J)
"RTN","MDPS1",61,0)
 .S MDCON=$P(MDX,U,5)
"RTN","MDPS1",62,0)
 .I +$G(MDSDT) Q:MDDTE<+$G(MDSDT)
"RTN","MDPS1",63,0)
 .I +$G(MDEDT) Q:MDDTE>+$G(MDEDT)
"RTN","MDPS1",64,0)
 .I MDCON D  Q:MDSTAT'="COMPLETE"&(MDSTAT'="PARTIAL RESULTS")
"RTN","MDPS1",65,0)
 ..S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"E")
"RTN","MDPS1",66,0)
 ..I MDSTAT="" S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"I") S:+MDSTAT MDSTAT=$$GET1^DIQ(100.01,MDSTAT_",",.01,"E")
"RTN","MDPS1",67,0)
 ..Q
"RTN","MDPS1",68,0)
 .S Y=MDDTE X ^DD("DD")
"RTN","MDPS1",69,0)
 .I MDCON Q:$G(MDARR(MDCON))'=""  S MDARR(MDCON)=MDCON
"RTN","MDPS1",70,0)
 .S:$G(^TMP("MDPLST",$J,(9999999.9999-MDDTE),MDPROC_"~"_MDLP))="" ^(MDPROC_"~"_MDLP)=MDPROC_"^"_MDLP_"^"_"PR702"_"^"_"MDPS1"_"^^"_Y_"^"_MDCODE_"^^^^"_MDPROC_"^^"_MDCON_"^"_+$P(MDX,U,6)
"RTN","MDPS1",71,0)
 .Q
"RTN","MDPS1",72,0)
 S MDCTR=0
"RTN","MDPS1",73,0)
 S MDLP="" F  S MDLP=$O(^TMP("MDPLST",$J,MDLP)) Q:MDLP=""  S MDLP1="" F  S MDLP1=$O(^TMP("MDPLST",$J,MDLP,MDLP1)) Q:MDLP1=""  S MDX=$G(^(MDLP1)) D
"RTN","MDPS1",74,0)
 .I +$G(MDMAX) Q:MDCTR=MDMAX
"RTN","MDPS1",75,0)
 .S MDCTR=MDCTR+1,@MDGLO@(MDCTR)=$G(MDX)
"RTN","MDPS1",76,0)
 K MDARR
"RTN","MDPS1",77,0)
 I +$G(MDALL) K ^TMP("MDPTXT",$J) S MDLP=0 F  S MDLP=$O(@MDGLO@(MDLP)) Q:MDLP<1  S MDX1=$G(@MDGLO@(MDLP)) D
"RTN","MDPS1",78,0)
 .S MCARGDA=+$P(MDX1,U,2),MCPRO=$P(MDX1,U,11),MCARPPS=$P(MDX1,U,3,4)
"RTN","MDPS1",79,0)
 .S MCARGRTN=$P(MDX1,U,5),MDT="RD"
"RTN","MDPS1",80,0)
 .D @MCARPPS
"RTN","MDPS1",81,0)
 K MCARGDA,MCARGRTN,MCPRO,MCARPPS
"RTN","MDPS1",82,0)
 Q
"RTN","MDPS1",83,0)
CPA ; Abnormal Report - Health Summary Component
"RTN","MDPS1",84,0)
 N MDHR,MDHSG,MDHDR,MDHFLG,MDLIM,MDTS1,MDTS2,MDX1
"RTN","MDPS1",85,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPS1",86,0)
 K ^TMP("MDHSP",$J) S MDHFLG=1
"RTN","MDPS1",87,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPS1",88,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM,"ABNORMAL")
"RTN","MDPS1",89,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPS1",90,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPS1",91,0)
 .D HSHDR^MDPS2
"RTN","MDPS1",92,0)
 .S MCARGDA=+$P(MDX1,U,2),MCARPPS=$P(MDX1,U,3,4),MCPRO=$P(MDX1,U,11)
"RTN","MDPS1",93,0)
 .S MCARGRTN=$P(MDX1,U,5),MDT="RD",MDHDR=1
"RTN","MDPS1",94,0)
 .D @MCARPPS Q
"RTN","MDPS1",95,0)
 K ^TMP("MDHSP",$J),MCARGRTN,MCPRO,MCARPPS
"RTN","MDPS1",96,0)
 Q
"RTN","MDPS1",97,0)
CPB ; Brief Report - Health Summary Component
"RTN","MDPS1",98,0)
 N MDHR,MDHSG,MDLIM,MDTS1,MDTS2,MDX1
"RTN","MDPS1",99,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPS1",100,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPS1",101,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPS1",102,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM)
"RTN","MDPS1",103,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPS1",104,0)
 D HDR^MDPS2
"RTN","MDPS1",105,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPS1",106,0)
 .D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",107,0)
 .W !,$S(+$P(MDX1,U,13):$J($P(MDX1,U,13),9),1:""),?12,$E($P(MDX1,U,1),1,30),?44,$P(MDX1,U,6),?67,$P(MDX1,U,7)
"RTN","MDPS1",108,0)
 .Q
"RTN","MDPS1",109,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPS1",110,0)
 Q
"RTN","MDPS1",111,0)
CPC ; Full Caption Report - Health Summary Component
"RTN","MDPS1",112,0)
 S MDT1="CD"
"RTN","MDPS1",113,0)
CPF ; Full Report - Health Summary Component
"RTN","MDPS1",114,0)
 N MDHR,MDHSG,MDHDR,MDHFLG,MDLIM,MDT,MDTS1,MDTS2,MDX1
"RTN","MDPS1",115,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPS1",116,0)
 K ^TMP("MDHSP",$J) S MDHFLG=1
"RTN","MDPS1",117,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPS1",118,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM)
"RTN","MDPS1",119,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPS1",120,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPS1",121,0)
 .D HSHDR^MDPS2
"RTN","MDPS1",122,0)
 .S MCARGDA=+$P(MDX1,U,2),MCPRO=$P(MDX1,U,11),MCARPPS=$P(MDX1,U,3,4)
"RTN","MDPS1",123,0)
 .S MCARGRTN=$P(MDX1,U,5),MDT=$S($G(MDT1)="":"RD",1:"CD"),MDHDR=1
"RTN","MDPS1",124,0)
 .D @MCARPPS Q
"RTN","MDPS1",125,0)
 K ^TMP("MDHSP",$J),MCARGDA,MCARGRTN,MCPRO,MCARPPS,MDT1
"RTN","MDPS1",126,0)
 Q
"RTN","MDPS1",127,0)
CPS ; One Line Summary Report
"RTN","MDPS1",128,0)
 N MDHR,MDHSG,MDLIM,MDTS1,MDTS2,MDX1
"RTN","MDPS1",129,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPS1",130,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPS1",131,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPS1",132,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM)
"RTN","MDPS1",133,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPS1",134,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPS1",135,0)
 .D HSHDR^MDPS2
"RTN","MDPS1",136,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPS1",137,0)
 Q
"RTN","MDPS1",138,0)
PR702 ; Return the Result Text for File 702 records
"RTN","MDPS1",139,0)
 Q:'$G(MCARGDA)
"RTN","MDPS1",140,0)
 N FFF,MDAK,MDAX,MDCLIN,MDCON,MDIMG,MDMCG,MDMED,MDREC,MDPRILV,MDPTR,MDSTUDY,MDTIU,MDX4,MDXY,PATID,MDRPG,RESULTS
"RTN","MDPS1",141,0)
 I '$G(MDALL) K ^TMP("MDPTXT",$J)
"RTN","MDPS1",142,0)
 S MDIMG=0,$P(FFF,"-",80)="",MDRPG=0
"RTN","MDPS1",143,0)
 S MDSTUDY=+$G(MCARGDA)
"RTN","MDPS1",144,0)
 S MDTIU=$$GET1^DIQ(702,MDSTUDY_",",.06,"I")
"RTN","MDPS1",145,0)
 S MDCON=$$GET1^DIQ(702,MDSTUDY_",",.05,"I")
"RTN","MDPS1",146,0)
 S MDAK=$$GET1^DIQ(702,MDSTUDY_",",.04,"E")
"RTN","MDPS1",147,0)
 Q:'MDTIU
"RTN","MDPS1",148,0)
 I +$P($G(^MDD(702,MDSTUDY,.1,0)),U,4)>0 S MDIMG=1
"RTN","MDPS1",149,0)
 S (MDPRILV,RESULTS)="",MDCLIN=0
"RTN","MDPS1",150,0)
 D CANDO^TIUSRVA(.MDPRILV,+MDTIU,"VIEW")
"RTN","MDPS1",151,0)
 I +MDPRILV<1 S ^TMP("MDPTXT",$J,MCARGDA,MCPRO,1)=$P(MDPRILV,U,2) D NXT Q
"RTN","MDPS1",152,0)
 I 'MDCON D TGET^TIUSRVR1(.RESULTS,+MDTIU) M ^TMP("MDPTXT",$J,MCARGDA,MCPRO)=@RESULTS K ^TMP("TIUVIEW",$J) Q:+$G(MDALL)  D NXT Q
"RTN","MDPS1",153,0)
 I MDCON D  Q:+$G(MDMED)
"RTN","MDPS1",154,0)
 .S MDG=$NA(^TMP("MDPTXT",$J,MCARGDA,MCPRO))
"RTN","MDPS1",155,0)
 .S MDMED=$$CHKMED^MDPS3(MDCON)
"RTN","MDPS1",156,0)
 .I MDMED D GETARY(.MDG,MDCON) Q:+$G(MDALL)  Q:+$G(MDRDV)  D NXT Q
"RTN","MDPS1",157,0)
 .S MDXY=$$GET^XPAR("SYS","MD GET HIGH VOLUME",MDAK,"E")
"RTN","MDPS1",158,0)
 .K ^TMP("MDGMRC",$J),^TMP("GMRCR",$J,"DT")
"RTN","MDPS1",159,0)
 .I '+$P(MDXY,";",2) S RESULTS=$NA(^TMP("MDGMRC",$J)) D RT^GMRCGUIA(MDCON,.RESULTS)
"RTN","MDPS1",160,0)
 .I +$P(MDXY,";",2) S RESULTS=$NA(^TMP("GMRCR",$J,"DT")) D DT^GMRCSLM2(MDCON)
"RTN","MDPS1",161,0)
 .D SETLINE(.MDG,.RESULTS) K ^TMP("MDGMRC",$J),^TMP("GMRCR",$J,"DT")
"RTN","MDPS1",162,0)
NXT Q:+$G(MDALL)  Q:+$G(MDRDV)
"RTN","MDPS1",163,0)
 I $D(ORHFS) U IO G PRINT
"RTN","MDPS1",164,0)
 G PRINT
"RTN","MDPS1",165,0)
PR690 ; Return the Result text for File 690 Medicine report record
"RTN","MDPS1",166,0)
 Q:'$G(MCARGDA)
"RTN","MDPS1",167,0)
 N MDSTUDY,RESULTS,MDTMP,PATID
"RTN","MDPS1",168,0)
 I '$G(MDALL) K ^TMP("MDPTXT",$J)
"RTN","MDPS1",169,0)
 S MDSTUDY=+$G(MCARGDA)
"RTN","MDPS1",170,0)
 S MDG=$NA(^TMP("MDPTXT",$J,MCARGDA,MCPRO))
"RTN","MDPS1",171,0)
 S MDTMP="",MDTMP=+$O(^MCAR(697.2,"B",MCPRO,MDTMP))
"RTN","MDPS1",172,0)
 S MDTMP=$G(^MCAR(697.2,+MDTMP,0)) Q:MDTMP=""
"RTN","MDPS1",173,0)
 S MDF=$P(MDTMP,U,2),MDF=$P(MDF,"(",2),MDR=+MCARGDA,MDPR=MCPRO,PATID=DFN S:$G(MDT)="" MDT="RD"
"RTN","MDPS1",174,0)
 D GETDATA^MDPS2(.MDG,DFN,MDPR,MDF,MDR,MDT,$S(+$G(MDHDR):MDHDR,1:0))
"RTN","MDPS1",175,0)
 Q:+$G(MDALL)  Q:+$G(MDRDV)
"RTN","MDPS1",176,0)
 I $D(ORHFS) U IO G PRINT
"RTN","MDPS1",177,0)
PRINT ; Print the text for Display
"RTN","MDPS1",178,0)
 N MDRE S MDREC=$NA(^TMP("MDPTXT",$J)),MDRPG=1,MDRE=+$P(MDREC,",",2)
"RTN","MDPS1",179,0)
 W:'$G(MDHFLG) @IOF,!!
"RTN","MDPS1",180,0)
 F  S MDREC=$Q(@MDREC) Q:MDREC=""  Q:$QS(MDREC,1)'="MDPTXT"  D
"RTN","MDPS1",181,0)
 .Q:$QS(MDREC,2)'=MDRE
"RTN","MDPS1",182,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",183,0)
 .I '$G(MDHFLG)&($Y>(IOSL-6)!($Y<1)) W @IOF D HDR^MDPS3
"RTN","MDPS1",184,0)
 .W !,$G(@MDREC)
"RTN","MDPS1",185,0)
 .Q
"RTN","MDPS1",186,0)
 I +$G(MDIMG) D
"RTN","MDPS1",187,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",188,0)
 .W ! I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",189,0)
 .W !,"NOTE: Images are associated with this procedure."
"RTN","MDPS1",190,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPS1",191,0)
 .W !,"      Please use Imaging Display to view the images."
"RTN","MDPS1",192,0)
 .Q
"RTN","MDPS1",193,0)
 K MCPRO,MCARPPS,MCARGRTN,^TMP("MDPTXT",$J)
"RTN","MDPS1",194,0)
 Q
"RTN","MDPS1",195,0)
GETARY(MDG,MDCON) ; Get the Medicine Result
"RTN","MDPS1",196,0)
 N MDCK,MDCX,MDX4,MDGL
"RTN","MDPS1",197,0)
 K ^TMP("MDREST",$J) S MDGL=$NA(^TMP("MDREST",$J))
"RTN","MDPS1",198,0)
 D GETS^DIQ(123,MDCON_",","50*","I","MDCX")
"RTN","MDPS1",199,0)
 S MDCK="" F  S MDCK=$O(MDCX(123.03,MDCK)) Q:MDCK<1  S MDX4=$G(MDCX(123.03,MDCK,.01,"I")) D
"RTN","MDPS1",200,0)
 .I MDX4["MCAR" D  Q
"RTN","MDPS1",201,0)
 ..S MDR=+MDX4,MDF=+$P(MDX4,"(",2),PATID=DFN S:$G(MDT)="" MDT="RD"
"RTN","MDPS1",202,0)
 ..Q:MDX4=""  S MCPRO=$$PRO^MDPS3(MDX4),MDPR=MCPRO
"RTN","MDPS1",203,0)
 ..D GETDATA^MDPS2(.MDGL,DFN,MDPR,MDF,MDR,MDT,$S(+$G(MDHDR):1,1:0))
"RTN","MDPS1",204,0)
 ..D SETLINE(.MDG,.MDGL) K ^TMP("MDREST",$J)
"RTN","MDPS1",205,0)
 ..Q
"RTN","MDPS1",206,0)
 .I MDX4["TIU" D  Q
"RTN","MDPS1",207,0)
 ..S RESULTS="" D TGET^TIUSRVR1(.RESULTS,+MDX4)
"RTN","MDPS1",208,0)
 ..D SETLINE(.MDG,.RESULTS) K ^TMP("TIUVIEW",$J)
"RTN","MDPS1",209,0)
 ..S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=FFF
"RTN","MDPS1",210,0)
 ..Q
"RTN","MDPS1",211,0)
 Q
"RTN","MDPS1",212,0)
SETLINE(MDG,MDGL) ; Set Global Lines
"RTN","MDPS1",213,0)
 N MDCK1,MDX3,MDSC,MDNAME,MDTITL,MDDTM
"RTN","MDPS1",214,0)
 D NOW^%DTC S X=% D DTIME^MCARP S MDDTM=$$FMTE^XLFDT(X,2) K %
"RTN","MDPS1",215,0)
 I $G(MCPRO)'="" S MDNAME=$O(^MCAR(697.2,"B",MCPRO,0)) D
"RTN","MDPS1",216,0)
 .I MDNAME S MDTITL=$P($G(^MCAR(697.2,+MDNAME,0)),"^",8)
"RTN","MDPS1",217,0)
 .I $G(MDTITL)="" S MDNAME=$O(^MDS(702.01,"B",MCPRO,0)) S:MDNAME MDTITL=$P($G(^MDS(702.01,+MDNAME,0)),U)
"RTN","MDPS1",218,0)
 S MDCK1=MDGL,MDSC=$QS(MDCK1,1),MDRPG=MDRPG+1
"RTN","MDPS1",219,0)
 I '$G(MDHDR) D
"RTN","MDPS1",220,0)
 .Q:MDSC="MDREST"
"RTN","MDPS1",221,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)="Pg. "_MDRPG_$J(" ",25)_$$HOSP^MDPS2(DFN)_$J(" ",25)_MDDTM
"RTN","MDPS1",222,0)
 .I $G(MDTITL)'="" S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$J(" ",25)_MDTITL
"RTN","MDPS1",223,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$$DEMO^MDPS2(DFN)
"RTN","MDPS1",224,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=FFF
"RTN","MDPS1",225,0)
 F  S MDCK1=$Q(@MDCK1) Q:MDCK1=""  Q:$QS(MDCK1,1)'=MDSC  Q:$QS(MDGL,2)'=$QS(MDCK1,2)  S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$G(@MDCK1)
"RTN","MDPS1",226,0)
 Q
"RTN","MDPSU")
0^26^B64018431^n/a
"RTN","MDPSU",1,0)
MDPSU ; HOIFO/NCA - CP/Medicine Report Generator Utility;5/18/04  09:48
"RTN","MDPSU",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDPSU",3,0)
 ; Integration Agreements:
"RTN","MDPSU",4,0)
 ; IA# 2263 [Supported] XPAR calls.
"RTN","MDPSU",5,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDPSU",6,0)
 ; IA# 2925 [Subscription] Calls to GMRCSLM2.
"RTN","MDPSU",7,0)
 ; IA# 2926 [Subscription] Calls to GMRCGUIA.
"RTN","MDPSU",8,0)
 ; IA# 2944 [Subscription] Calls to TIUSRVR1.
"RTN","MDPSU",9,0)
 ; IA# 3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDPSU",10,0)
 ; IA# 4231 [Subscription] Document CKP^GMTSUP usage.
"RTN","MDPSU",11,0)
 ; IA# 4792 [Private] CANDO^TIUSRVA call
"RTN","MDPSU",12,0)
 ; IA# 10017 [Supported] ^DD("DD")
"RTN","MDPSU",13,0)
 ; IA# 10103 [Supported] Routine XLFDT calls
"RTN","MDPSU",14,0)
 ;
"RTN","MDPSU",15,0)
 ; Pre-existing local variables
"RTN","MDPSU",16,0)
 ; DFN,GMTS1,GMTS2,GMTSNDM,GMTSNPG,GMTSQIT
"RTN","MDPSU",17,0)
 ;
"RTN","MDPSU",18,0)
EN1(MDGLO,MDDFN,MDSDT,MDEDT,MDMAX,MDPSC,MDALL) ; Return the List of Completed Studies
"RTN","MDPSU",19,0)
 ; Input: MDGLO - Return Global Array (Required)
"RTN","MDPSU",20,0)
 ;        MDDFN - Patient DFN         (Required)
"RTN","MDPSU",21,0)
 ;        MDSDT - Start Date in FM Internal Format (Optional)
"RTN","MDPSU",22,0)
 ;        MDEDT - End Date in FM Internal Format (Optional)
"RTN","MDPSU",23,0)
 ;        MDMAX - Number of studies to return    (Optional)
"RTN","MDPSU",24,0)
 ;        MDPSC - Procedure Summary Code         (Optional)
"RTN","MDPSU",25,0)
 ;        MDALL - Return the all text reports with
"RTN","MDPSU",26,0)
 ;                the procedures list            (Optional)
"RTN","MDPSU",27,0)
 ; (Returns all studies for Patient, if no MDSDT, MDEDT,and MDMAX.)
"RTN","MDPSU",28,0)
 ;
"RTN","MDPSU",29,0)
 I '$G(MDDFN)!('$D(MDGLO)) Q
"RTN","MDPSU",30,0)
 I $G(MDGLO)="" S MDGLO=$NA(^TMP("MDHSP",$J))
"RTN","MDPSU",31,0)
 N MDARR,MDCODE,MDCON,MDCTR,MDDTE,MDLP,MDLP1,MDPLST,MDPROC,MDSTAT,MDT,MDTIUER,MDX,Y
"RTN","MDPSU",32,0)
 S (MDIMG,MDCTR)=0,(MDCODE,MDDTE,MDTIUER)="",MDC=$G(MDPSC)
"RTN","MDPSU",33,0)
 K ^TMP("MDPLST",$J) S MDPLST=$NA(^TMP("MDPLST",$J))
"RTN","MDPSU",34,0)
 ;
"RTN","MDPSU",35,0)
 ; If not converted call old medicine gather routine
"RTN","MDPSU",36,0)
 ;D:$G(MDC)="" GP^MDPS4(MDDFN,MDSDT,MDEDT)
"RTN","MDPSU",37,0)
 ;I '$G(MDSDT),'$G(MDEDT) D EN^MDARP3(MDDFN,MDC)
"RTN","MDPSU",38,0)
 ;E  D EN^MCARPS3(MDDFN,MDC,MDSDT,MDEDT)
"RTN","MDPSU",39,0)
 ;
"RTN","MDPSU",40,0)
 ; Get CP procedures
"RTN","MDPSU",41,0)
 D GET702(.MDGLO,MDDFN,MDC,MDSDT,MDEDT,$S(+$G(MDMAX):MDMAX,1:999))
"RTN","MDPSU",42,0)
 K ^TMP("MDPLST",$J)
"RTN","MDPSU",43,0)
 Q
"RTN","MDPSU",44,0)
 ;
"RTN","MDPSU",45,0)
GET702(MDGLO,MDDFN,MDC,MDSDT,MDEDT,MDMAX) ; Gather the new 702 entries
"RTN","MDPSU",46,0)
 N MDIAR,MDIL Q:'$G(MDC)
"RTN","MDPSU",47,0)
 F MDIL=0:0 S MDIL=$O(^MDS(702.01,"AINST",+MDC,MDIL)) Q:MDIL<1  S MDIAR(MDIL)=MDC
"RTN","MDPSU",48,0)
 S MDLP="" F  S MDLP=$O(^MDD(702,"B",MDDFN,MDLP)) Q:MDLP<1  D
"RTN","MDPSU",49,0)
 .S MDX=$G(^MDD(702,MDLP,0)) Q:$P(MDX,"^",9)'=3
"RTN","MDPSU",50,0)
 .S MDPROC=$$GET1^DIQ(702,MDLP_",",.04,"E") Q:MDPROC=""
"RTN","MDPSU",51,0)
 .Q:'$P(MDX,U,6)
"RTN","MDPSU",52,0)
 .K ^TMP("MDTIUST",$J) S MDTIUER=""
"RTN","MDPSU",53,0)
 .D EXTRACT^TIULQ($P(MDX,U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;70201;70202") Q:+MDTIUER
"RTN","MDPSU",54,0)
 .I $G(MDC)'="" Q:$G(MDIAR($P(MDX,"^",4)))'=MDC
"RTN","MDPSU",55,0)
 .S MDDTE=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),70202,"I"))
"RTN","MDPSU",56,0)
 .S MDSTAT=$G(^TMP("MDTIUST",$J,$P(MDX,U,6),.05,"E"))
"RTN","MDPSU",57,0)
 .S MDDTE=$$GET1^DIQ(702,MDLP_",",.02,"I")
"RTN","MDPSU",58,0)
 .K ^TMP("MDTIUST",$J)
"RTN","MDPSU",59,0)
 .S MDCON=$P(MDX,U,5)
"RTN","MDPSU",60,0)
 .I +$G(MDSDT) Q:MDDTE<+$G(MDSDT)
"RTN","MDPSU",61,0)
 .I +$G(MDEDT) Q:MDDTE>+$G(MDEDT)
"RTN","MDPSU",62,0)
 .I MDCON D  Q:MDSTAT'="COMPLETE"&(MDSTAT'="PARTIAL RESULTS")
"RTN","MDPSU",63,0)
 ..S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"E")
"RTN","MDPSU",64,0)
 ..I MDSTAT="" S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"I") S:+MDSTAT MDSTAT=$$GET1^DIQ(100.01,MDSTAT_",",.01,"E")
"RTN","MDPSU",65,0)
 ..Q
"RTN","MDPSU",66,0)
 .S Y=MDDTE X ^DD("DD")
"RTN","MDPSU",67,0)
 .I MDCON Q:$G(MDARR(MDCON))'=""  S MDARR(MDCON)=MDCON
"RTN","MDPSU",68,0)
 .S:$G(^TMP("MDPLST",$J,(9999999.9999-MDDTE),MDPROC_"~"_MDLP))="" ^(MDPROC_"~"_MDLP)=MDPROC_"^"_MDLP_"^"_"PR702"_"^"_"MDPS1"_"^^"_Y_"^"_MDCODE_"^^^^"_MDPROC_"^^"_MDCON_"^"_+$P(MDX,U,6)
"RTN","MDPSU",69,0)
 .Q
"RTN","MDPSU",70,0)
 S MDCTR=0
"RTN","MDPSU",71,0)
 S MDLP="" F  S MDLP=$O(^TMP("MDPLST",$J,MDLP)) Q:MDLP=""  S MDLP1="" F  S MDLP1=$O(^TMP("MDPLST",$J,MDLP,MDLP1)) Q:MDLP1=""  S MDX=$G(^(MDLP1)) D
"RTN","MDPSU",72,0)
 .I +$G(MDMAX) Q:MDCTR=MDMAX
"RTN","MDPSU",73,0)
 .S MDCTR=MDCTR+1,@MDGLO@(MDCTR)=$G(MDX)
"RTN","MDPSU",74,0)
 K MDARR
"RTN","MDPSU",75,0)
 I +$G(MDALL) K ^TMP("MDPTXT",$J) S MDLP=0 F  S MDLP=$O(@MDGLO@(MDLP)) Q:MDLP<1  S MDX1=$G(@MDGLO@(MDLP)) D
"RTN","MDPSU",76,0)
 .S MCARGDA=+$P(MDX1,U,2),MCPRO=$P(MDX1,U,11),MCARPPS=$P(MDX1,U,3,4)
"RTN","MDPSU",77,0)
 .S MCARGRTN=$P(MDX1,U,5),MDT="RD"
"RTN","MDPSU",78,0)
 .D @MCARPPS
"RTN","MDPSU",79,0)
 K MCARGDA,MCARGRTN,MCPRO,MCARPPS,MDIAR
"RTN","MDPSU",80,0)
 Q
"RTN","MDPSU",81,0)
CPF ; Full Report - Health Summary Component
"RTN","MDPSU",82,0)
 N MDHR,MDHSG,MDHDR,MDHFLG,MDLIM,MDRTN,MDT,MDTS1,MDTS2,MDX1
"RTN","MDPSU",83,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPSU",84,0)
 Q:$G(GMTSEGH)=""  S MDRTN=$P(GMTSEGH," -") Q:MDRTN=""  S MDRTN=+$P(MDRTN,"M",2) Q:'MDRTN
"RTN","MDPSU",85,0)
 K ^TMP("MDHSP",$J) S MDHFLG=1
"RTN","MDPSU",86,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPSU",87,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM,MDRTN)
"RTN","MDPSU",88,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPSU",89,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPSU",90,0)
 .D HSHDR^MDPS2
"RTN","MDPSU",91,0)
 .S MCARGDA=+$P(MDX1,U,2),MCPRO=$P(MDX1,U,11),MCARPPS=$P(MDX1,U,3,4)
"RTN","MDPSU",92,0)
 .S MCARGRTN=$P(MDX1,U,5),MDT=$S($G(MDT1)="":"RD",1:"CD"),MDHDR=1
"RTN","MDPSU",93,0)
 .D @MCARPPS Q
"RTN","MDPSU",94,0)
 K ^TMP("MDHSP",$J),MCARGDA,MCARGRTN,MCPRO,MCARPPS,MDT1
"RTN","MDPSU",95,0)
 Q
"RTN","MDPSU",96,0)
CPS ; One Line Summary Report
"RTN","MDPSU",97,0)
 N MDHR,MDHSG,MDLIM,MDTS1,MDTS2,MDX1
"RTN","MDPSU",98,0)
 Q:'$G(DFN)  Q:'$G(GMTS1)  Q:'$G(GMTS2)
"RTN","MDPSU",99,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPSU",100,0)
 S MDHSG=$NA(^TMP("MDHSP",$J)) D SET^MDPS2
"RTN","MDPSU",101,0)
 D EN1(.MDHSG,DFN,MDTS1,MDTS2,MDLIM)
"RTN","MDPSU",102,0)
 I '$D(^TMP("MDHSP",$J)) D CKP^GMTSUP Q:$D(GMTSQIT)  W !,"No Procedure Data for the patient." Q
"RTN","MDPSU",103,0)
 S MDHR=0 F  S MDHR=$O(^TMP("MDHSP",$J,MDHR)) Q:MDHR<1  S MDX1=$G(^(MDHR)) D
"RTN","MDPSU",104,0)
 .D HSHDR^MDPS2
"RTN","MDPSU",105,0)
 K ^TMP("MDHSP",$J)
"RTN","MDPSU",106,0)
 Q
"RTN","MDPSU",107,0)
PR702 ; Return the Result Text for File 702 records
"RTN","MDPSU",108,0)
 Q:'$G(MCARGDA)
"RTN","MDPSU",109,0)
 N FFF,MDAK,MDAX,MDCLIN,MDCON,MDIMG,MDMCG,MDMED,MDREC,MDPRILV,MDPTR,MDSTUDY,MDTIU,MDX4,MDXY,PATID,MDRPG,RESULTS
"RTN","MDPSU",110,0)
 I '$G(MDALL) K ^TMP("MDPTXT",$J)
"RTN","MDPSU",111,0)
 S MDIMG=0,$P(FFF,"-",80)="",MDRPG=0
"RTN","MDPSU",112,0)
 S MDSTUDY=+$G(MCARGDA)
"RTN","MDPSU",113,0)
 S MDTIU=$$GET1^DIQ(702,MDSTUDY_",",.06,"I")
"RTN","MDPSU",114,0)
 S MDCON=$$GET1^DIQ(702,MDSTUDY_",",.05,"I")
"RTN","MDPSU",115,0)
 S MDAK=$$GET1^DIQ(702,MDSTUDY_",",.04,"E")
"RTN","MDPSU",116,0)
 Q:'MDTIU
"RTN","MDPSU",117,0)
 I +$P($G(^MDD(702,MDSTUDY,.1,0)),U,4)>0 S MDIMG=1
"RTN","MDPSU",118,0)
 S (MDPRILV,RESULTS)="",MDCLIN=0
"RTN","MDPSU",119,0)
 D CANDO^TIUSRVA(.MDPRILV,+MDTIU,"VIEW")
"RTN","MDPSU",120,0)
 I +MDPRILV<1 S ^TMP("MDPTXT",$J,MCARGDA,MCPRO,1)=$P(MDPRILV,U,2) D NXT Q
"RTN","MDPSU",121,0)
 I 'MDCON D TGET^TIUSRVR1(.RESULTS,+MDTIU) M ^TMP("MDPTXT",$J,MCARGDA,MCPRO)=@RESULTS K ^TMP("TIUVIEW",$J) Q:+$G(MDALL)  D NXT Q
"RTN","MDPSU",122,0)
 I MDCON D  Q:+$G(MDMED)
"RTN","MDPSU",123,0)
 .S MDG=$NA(^TMP("MDPTXT",$J,MCARGDA,MCPRO))
"RTN","MDPSU",124,0)
 .S MDMED=$$CHKMED^MDPS3(MDCON)
"RTN","MDPSU",125,0)
 .I MDMED D GETARY(.MDG,MDCON) Q:+$G(MDALL)  Q:+$G(MDRDV)  D NXT Q
"RTN","MDPSU",126,0)
 .S MDXY=$$GET^XPAR("SYS","MD GET HIGH VOLUME",MDAK,"E")
"RTN","MDPSU",127,0)
 .K ^TMP("MDGMRC",$J),^TMP("GMRCR",$J,"DT")
"RTN","MDPSU",128,0)
 .I '+$P(MDXY,";",2) S RESULTS=$NA(^TMP("MDGMRC",$J)) D RT^GMRCGUIA(MDCON,.RESULTS)
"RTN","MDPSU",129,0)
 .I +$P(MDXY,";",2) S RESULTS=$NA(^TMP("GMRCR",$J,"DT")) D DT^GMRCSLM2(MDCON)
"RTN","MDPSU",130,0)
 .D SETLINE(.MDG,.RESULTS) K ^TMP("MDGMRC",$J),^TMP("GMRCR",$J,"DT")
"RTN","MDPSU",131,0)
NXT Q:+$G(MDALL)  Q:+$G(MDRDV)
"RTN","MDPSU",132,0)
 I $D(ORHFS) U IO G PRINT
"RTN","MDPSU",133,0)
 G PRINT
"RTN","MDPSU",134,0)
PR690 ; Return the Result text for File 690 Medicine report record
"RTN","MDPSU",135,0)
 Q:'$G(MCARGDA)
"RTN","MDPSU",136,0)
 N MDSTUDY,RESULTS,MDTMP,PATID
"RTN","MDPSU",137,0)
 I '$G(MDALL) K ^TMP("MDPTXT",$J)
"RTN","MDPSU",138,0)
 S MDSTUDY=+$G(MCARGDA)
"RTN","MDPSU",139,0)
 S MDG=$NA(^TMP("MDPTXT",$J,MCARGDA,MCPRO))
"RTN","MDPSU",140,0)
 S MDTMP="",MDTMP=+$O(^MCAR(697.2,"B",MCPRO,MDTMP))
"RTN","MDPSU",141,0)
 S MDTMP=$G(^MCAR(697.2,+MDTMP,0)) Q:MDTMP=""
"RTN","MDPSU",142,0)
 S MDF=$P(MDTMP,U,2),MDF=$P(MDF,"(",2),MDR=+MCARGDA,MDPR=MCPRO,PATID=DFN S:$G(MDT)="" MDT="RD"
"RTN","MDPSU",143,0)
 D GETDATA^MDPS2(.MDG,DFN,MDPR,MDF,MDR,MDT,$S(+$G(MDHDR):MDHDR,1:0))
"RTN","MDPSU",144,0)
 Q:+$G(MDALL)  Q:+$G(MDRDV)
"RTN","MDPSU",145,0)
 I $D(ORHFS) U IO G PRINT
"RTN","MDPSU",146,0)
PRINT ; Print the text for Display
"RTN","MDPSU",147,0)
 N MDRE S MDREC=$NA(^TMP("MDPTXT",$J)),MDRPG=1,MDRE=+$P(MDREC,",",2)
"RTN","MDPSU",148,0)
 W:'$G(MDHFLG) @IOF,!!
"RTN","MDPSU",149,0)
 F  S MDREC=$Q(@MDREC) Q:MDREC=""  Q:$QS(MDREC,1)'="MDPTXT"  D
"RTN","MDPSU",150,0)
 .Q:$QS(MDREC,2)'=MDRE
"RTN","MDPSU",151,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPSU",152,0)
 .I '$G(MDHFLG)&($Y>(IOSL-6)!($Y<1)) W @IOF D HDR^MDPS3
"RTN","MDPSU",153,0)
 .W !,$G(@MDREC)
"RTN","MDPSU",154,0)
 .Q
"RTN","MDPSU",155,0)
 I +$G(MDIMG) D
"RTN","MDPSU",156,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPSU",157,0)
 .W ! I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPSU",158,0)
 .W !,"NOTE: Images are associated with this procedure."
"RTN","MDPSU",159,0)
 .I +$G(MDHFLG) D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","MDPSU",160,0)
 .W !,"      Please use Imaging Display to view the images."
"RTN","MDPSU",161,0)
 .Q
"RTN","MDPSU",162,0)
 K MCPRO,MCARPPS,MCARGRTN,^TMP("MDPTXT",$J)
"RTN","MDPSU",163,0)
 Q
"RTN","MDPSU",164,0)
GETARY(MDG,MDCON) ; Get the Medicine Result
"RTN","MDPSU",165,0)
 N MDCK,MDCX,MDX4,MDGL
"RTN","MDPSU",166,0)
 K ^TMP("MDREST",$J) S MDGL=$NA(^TMP("MDREST",$J))
"RTN","MDPSU",167,0)
 D GETS^DIQ(123,MDCON_",","50*","I","MDCX")
"RTN","MDPSU",168,0)
 S MDCK="" F  S MDCK=$O(MDCX(123.03,MDCK)) Q:MDCK<1  S MDX4=$G(MDCX(123.03,MDCK,.01,"I")) D
"RTN","MDPSU",169,0)
 .I MDX4["MCAR" D  Q
"RTN","MDPSU",170,0)
 ..S MDR=+MDX4,MDF=+$P(MDX4,"(",2),PATID=DFN S:$G(MDT)="" MDT="RD"
"RTN","MDPSU",171,0)
 ..Q:MDX4=""  S MCPRO=$$PRO^MDPS3(MDX4),MDPR=MCPRO
"RTN","MDPSU",172,0)
 ..D GETDATA^MDPS2(.MDGL,DFN,MDPR,MDF,MDR,MDT,$S(+$G(MDHDR):1,1:0))
"RTN","MDPSU",173,0)
 ..D SETLINE(.MDG,.MDGL) K ^TMP("MDREST",$J)
"RTN","MDPSU",174,0)
 ..Q
"RTN","MDPSU",175,0)
 .I MDX4["TIU" D  Q
"RTN","MDPSU",176,0)
 ..S RESULTS="" D TGET^TIUSRVR1(.RESULTS,+MDX4)
"RTN","MDPSU",177,0)
 ..D SETLINE(.MDG,.RESULTS) K ^TMP("TIUVIEW",$J)
"RTN","MDPSU",178,0)
 ..S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=FFF
"RTN","MDPSU",179,0)
 ..Q
"RTN","MDPSU",180,0)
 Q
"RTN","MDPSU",181,0)
SETLINE(MDG,MDGL) ; Set Global Lines
"RTN","MDPSU",182,0)
 N MDCK1,MDX3,MDSC,MDNAME,MDTITL,MDDTM
"RTN","MDPSU",183,0)
 D NOW^%DTC S X=% D DTIME^MCARP S MDDTM=$$FMTE^XLFDT(X,2) K %
"RTN","MDPSU",184,0)
 I $G(MCPRO)'="" S MDNAME=$O(^MCAR(697.2,"B",MCPRO,0)) D
"RTN","MDPSU",185,0)
 .I MDNAME S MDTITL=$P($G(^MCAR(697.2,+MDNAME,0)),"^",8)
"RTN","MDPSU",186,0)
 .I $G(MDTITL)="" S MDNAME=$O(^MDS(702.01,"B",MCPRO,0)) S:MDNAME MDTITL=$P($G(^MDS(702.01,+MDNAME,0)),U)
"RTN","MDPSU",187,0)
 S MDCK1=MDGL,MDSC=$QS(MDCK1,1),MDRPG=MDRPG+1
"RTN","MDPSU",188,0)
 I '$G(MDHDR) D
"RTN","MDPSU",189,0)
 .Q:MDSC="MDREST"
"RTN","MDPSU",190,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)="Pg. "_MDRPG_$J(" ",25)_$$HOSP^MDPS2(DFN)_$J(" ",25)_MDDTM
"RTN","MDPSU",191,0)
 .I $G(MDTITL)'="" S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$J(" ",25)_MDTITL
"RTN","MDPSU",192,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$$DEMO^MDPS2(DFN)
"RTN","MDPSU",193,0)
 .S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=FFF
"RTN","MDPSU",194,0)
 F  S MDCK1=$Q(@MDCK1) Q:MDCK1=""  Q:$QS(MDCK1,1)'=MDSC  Q:$QS(MDGL,2)'=$QS(MDCK1,2)  S MDCLIN=MDCLIN+1,@MDG@(MDCLIN,0)=$G(@MDCK1)
"RTN","MDPSU",195,0)
 Q
"RTN","MDPSUL")
0^27^B4032954^n/a
"RTN","MDPSUL",1,0)
MDPSUL ; HOIFO/NCA - HS Component Utility;5/18/04  09:48 ;10/5/09  09:33
"RTN","MDPSUL",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDPSUL",3,0)
 ; Integration Agreements:
"RTN","MDPSUL",4,0)
 ; IA# 10103 [Supported] XLFDT calls
"RTN","MDPSUL",5,0)
 ;
"RTN","MDPSUL",6,0)
EN2 ; Print the List of Components that should be created in HS
"RTN","MDPSUL",7,0)
 N DIC,MDSPEC,X,Y,DTOUT,DUOUT
"RTN","MDPSUL",8,0)
 K IOP S %ZIS="MQ",%ZIS("A")="Select LIST Printer: ",%ZIS("B")="HOME" W ! D ^%ZIS K %ZIS,IOP Q:POP
"RTN","MDPSUL",9,0)
 I $D(IO("Q")) D QUE Q
"RTN","MDPSUL",10,0)
 U IO D GETLIST D ^%ZISC K %ZIS,IOP Q
"RTN","MDPSUL",11,0)
QUE ; Queue List
"RTN","MDPSUL",12,0)
 K IO("Q"),ZTUCI,ZTDTH,ZTIO,ZTSAVE,ZTDESC,ZTSK S ZTRTN="GETLIST^MDPSUL",ZTREQ="@",ZTSAVE("ZTREQ")=""
"RTN","MDPSUL",13,0)
 S ZTDESC="Print the List of Components that should be created in HS."
"RTN","MDPSUL",14,0)
 D ^%ZTLOAD D ^%ZISC U IO W !,"Request Queued",! K ZTSK Q
"RTN","MDPSUL",15,0)
EX ; Exit
"RTN","MDPSUL",16,0)
 Q
"RTN","MDPSUL",17,0)
GETLIST ; [Procedure] Loop through Instruments and get active list
"RTN","MDPSUL",18,0)
 N ANS,DTP,LN,MDLL,MDX,PG,S1
"RTN","MDPSUL",19,0)
 S S1=$S(IOST?1"C".E:IOSL-8,1:IOSL-7)
"RTN","MDPSUL",20,0)
 S (ANS,LN)="",$P(LN,"-",57)=""
"RTN","MDPSUL",21,0)
 S PG=0 N % D NOW^%DTC S DTP=%,DTP=$$FMTE^XLFDT(DTP,"1P") D HDR
"RTN","MDPSUL",22,0)
 F MDLL=0:0 S MDLL=$O(^MDS(702.09,MDLL)) Q:MDLL<1!(ANS="^")  S MDX=$G(^(MDLL,0)) D
"RTN","MDPSUL",23,0)
 .Q:'$P(MDX,"^",9)
"RTN","MDPSUL",24,0)
 .Q:'$P($G(^MDS(702.09,MDLL,.1)),"^",3)
"RTN","MDPSUL",25,0)
 .D:$Y>(IOSL-8) HDR Q:ANS="^"
"RTN","MDPSUL",26,0)
 .W !,$E($P(MDX,"^"),1,25),?27,"CPF;MDPSU",?50,"M",MDLL
"RTN","MDPSUL",27,0)
 Q
"RTN","MDPSUL",28,0)
HDR ; List Header
"RTN","MDPSUL",29,0)
 Q:ANS="^"  D:$Y'<S1 PAUSE Q:ANS="^"
"RTN","MDPSUL",30,0)
 W:'($E(IOST,1,2)'="C-"&'PG) @IOF S PG=PG+1
"RTN","MDPSUL",31,0)
 W !,DTP,?52,"Page ",PG,!!?10,"LIST  OF  HS  COMPONENTS  NEEDED",!!
"RTN","MDPSUL",32,0)
 W !,"Name",?27,"Print Routine",?45,"Abbreviation",!,LN
"RTN","MDPSUL",33,0)
 Q
"RTN","MDPSUL",34,0)
PAUSE ; Pause For Scroll
"RTN","MDPSUL",35,0)
 I IOST?1"C".E K DIR S DIR(0)="E",DIR("A")="Enter RETURN to Continue or '^' to Quit Listing"  D ^DIR I 'Y S ANS="^"
"RTN","MDPSUL",36,0)
 Q
"RTN","MDRPCNT1")
0^4^B42671785^B40746099
"RTN","MDRPCNT1",1,0)
MDRPCNT1 ; HOIFO/NCA - Object RPCs (TMDNOTE) Continued 2;10/29/04  12:20 ;2/25/09  16:08
"RTN","MDRPCNT1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21**;Apr 01, 2004;Build 30
"RTN","MDRPCNT1",3,0)
 ; Integration Agreements:
"RTN","MDRPCNT1",4,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDRPCNT1",5,0)
 ; IA# 3535 [Subscription] Calls to TIUSRVP.
"RTN","MDRPCNT1",6,0)
 ; IA# 4795 [Subscription] Calls to TIUSRVP2.
"RTN","MDRPCNT1",7,0)
 ; IA# 5407 [Subscription] Call to GETDCOS^ORWTPN
"RTN","MDRPCNT1",8,0)
ADDMSG ; [Procedure] Add message to transaction
"RTN","MDRPCNT1",9,0)
 N MDIEN,MDIENS,MDRET
"RTN","MDRPCNT1",10,0)
 Q:'$G(DATA("TRANSACTION"))
"RTN","MDRPCNT1",11,0)
 Q:$G(DATA("MESSAGE"))=""
"RTN","MDRPCNT1",12,0)
 S MDIEN=+DATA("TRANSACTION"),MDIENS="+1,"_MDIEN_","
"RTN","MDRPCNT1",13,0)
 D NOW^%DTC S DATA("DATE")=%
"RTN","MDRPCNT1",14,0)
 S MDFDA(702.091,MDIENS,.01)=+$O(^MDD(702,+MDIEN,.091,"A"),-1)+1
"RTN","MDRPCNT1",15,0)
 S MDFDA(702.091,MDIENS,.02)=DATA("DATE")
"RTN","MDRPCNT1",16,0)
 S MDFDA(702.091,MDIENS,.03)=$G(DATA("PKG"),"UNKNOWN")
"RTN","MDRPCNT1",17,0)
 S MDFDA(702.091,MDIENS,.09)=DATA("MESSAGE")
"RTN","MDRPCNT1",18,0)
 D UPDATE^DIE("","MDFDA","MDRET")
"RTN","MDRPCNT1",19,0)
 Q
"RTN","MDRPCNT1",20,0)
 ;
"RTN","MDRPCNT1",21,0)
FILEMSG(STUDY,MDPKG,MDSTAT,MDMSG) ; [Procedure] File Study Status and Message.
"RTN","MDRPCNT1",22,0)
 S DATA("TRANSACTION")=STUDY,DATA("PKG")=MDPKG
"RTN","MDRPCNT1",23,0)
 S DATA("MESSAGE")=$P(MDMSG,"^",2)
"RTN","MDRPCNT1",24,0)
 D STATUS(STUDY_",",MDSTAT,$P(MDMSG,"^",2)),ADDMSG
"RTN","MDRPCNT1",25,0)
 Q
"RTN","MDRPCNT1",26,0)
 ;
"RTN","MDRPCNT1",27,0)
STATUS(MDIENS,MDSTAT,MDMSG) ; [Procedure] Update transaction status
"RTN","MDRPCNT1",28,0)
 S MDFDA(702,MDIENS,.08)=$G(MDMSG)
"RTN","MDRPCNT1",29,0)
 S MDFDA(702,MDIENS,.09)=MDSTAT
"RTN","MDRPCNT1",30,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCNT1",31,0)
 Q
"RTN","MDRPCNT1",32,0)
 ;
"RTN","MDRPCNT1",33,0)
SUBMIT(MDDATA,MDDT,MDAU,MDESIG,MDNTL,MDG1) ; [Procedure] Process the Image(s) Submission.
"RTN","MDRPCNT1",34,0)
 ; Input: MDDATA - Study ID
"RTN","MDRPCNT1",35,0)
 ;        MDDT-Date/Time of Document
"RTN","MDRPCNT1",36,0)
 ;        MDA - Author
"RTN","MDRPCNT1",37,0)
 ;        MDESIG - Electronic Signature
"RTN","MDRPCNT1",38,0)
 ;        MDNTL - Note title
"RTN","MDRPCNT1",39,0)
 ;        MDG1 - ^TMP global with the text of the report
"RTN","MDRPCNT1",40,0)
 ; Output: -1^Error Message or
"RTN","MDRPCNT1",41,0)
 ;          1^Successful Message
"RTN","MDRPCNT1",42,0)
 N MDANS,MDRESUL,MDSTUDY,MDG2,RES,MDN
"RTN","MDRPCNT1",43,0)
 S MDSTUDY=+MDDATA,(RES,MDRESUL)=""
"RTN","MDRPCNT1",44,0)
 ; Create New TIU Document
"RTN","MDRPCNT1",45,0)
 S (MDN,MDRESUL)=$$NEWTIUN(MDSTUDY,MDDT,MDAU,MDNTL)
"RTN","MDRPCNT1",46,0)
 ; File TIU Error messages
"RTN","MDRPCNT1",47,0)
 I +MDRESUL<0 D  Q RES
"RTN","MDRPCNT1",48,0)
 .D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCNT1",49,0)
 .S RES=MDRESUL
"RTN","MDRPCNT1",50,0)
 S MDANS=+MDRESUL
"RTN","MDRPCNT1",51,0)
 ; Update the text of the TIU document
"RTN","MDRPCNT1",52,0)
 S MDG2=@($NA(MDG1))
"RTN","MDRPCNT1",53,0)
 I +$O(@MDG2@(""),-1) D  Q:RES'="" RES
"RTN","MDRPCNT1",54,0)
 .S MDRESUL=$$UPDATE(MDSTUDY,MDANS,MDESIG,MDG2)
"RTN","MDRPCNT1",55,0)
 .I +MDRESUL<0 D  Q
"RTN","MDRPCNT1",56,0)
 ..D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCNT1",57,0)
 ..S RES=MDRESUL
"RTN","MDRPCNT1",58,0)
 S RES=MDANS
"RTN","MDRPCNT1",59,0)
 N XX S XX="",XX=$$UPDCONS^MDRPCOT1(+$P($G(^MDD(702,+MDSTUDY,0)),U,5),+MDN)
"RTN","MDRPCNT1",60,0)
 Q RES
"RTN","MDRPCNT1",61,0)
 ;
"RTN","MDRPCNT1",62,0)
GETDATA(STUDY) ; [Function] Return the Necessary data for creating a TIU note.
"RTN","MDRPCNT1",63,0)
 ; Return: Patient DFN_"^"_TIU title_"^"_Hospital Location_"^"_TIU Note
"RTN","MDRPCNT1",64,0)
 ;         IEN_"^"_Consult #_"^"_CP Definition IEN_"^"_Visit String_"^"
"RTN","MDRPCNT1",65,0)
 ;         New Visit Flag
"RTN","MDRPCNT1",66,0)
 ;         or
"RTN","MDRPCNT1",67,0)
 ;         -1^Error Message
"RTN","MDRPCNT1",68,0)
 N DFN,MDCON,MDFN,MDIEN,MDIENS,MDLOC,MDNEWV,MDNOTE,MDNVST,MDPROC,MDVSTR,MDTITL,MDX,MDTST
"RTN","MDRPCNT1",69,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDNVST=0
"RTN","MDRPCNT1",70,0)
 I $$GET1^DIQ(702,MDIENS,.01)="" Q "-1^No such study entry."
"RTN","MDRPCNT1",71,0)
 ; Get DFN
"RTN","MDRPCNT1",72,0)
 S DFN=$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCNT1",73,0)
 I 'DFN Q "-1^No DFN."
"RTN","MDRPCNT1",74,0)
 ; Get CP Def
"RTN","MDRPCNT1",75,0)
 S MDPROC=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCNT1",76,0)
 I 'MDPROC Q "-1^No CP Def."
"RTN","MDRPCNT1",77,0)
 ; Get Consult
"RTN","MDRPCNT1",78,0)
 S MDCON=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCNT1",79,0)
 I 'MDCON Q "-1^No Consult #."
"RTN","MDRPCNT1",80,0)
 ; Get TIU Note Title
"RTN","MDRPCNT1",81,0)
 S MDTITL=$$GET1^DIQ(702.01,+MDPROC_",",.04,"I")
"RTN","MDRPCNT1",82,0)
 I 'MDTITL Q "-1^No TIU Note Title."
"RTN","MDRPCNT1",83,0)
 S MDVSTR=$$GET1^DIQ(702,MDIEN,.07)
"RTN","MDRPCNT1",84,0)
 I MDVSTR=""  Q "-1^No Visit String."
"RTN","MDRPCNT1",85,0)
 I $L(MDVSTR,";")=1 S MDNVST=1,MDVSTR=";"_MDVSTR ; If new visit is selected
"RTN","MDRPCNT1",86,0)
 ; MDLOC is Hospital Location
"RTN","MDRPCNT1",87,0)
 I MDVSTR'="" D
"RTN","MDRPCNT1",88,0)
 .S MDVSTR=$$GETVSTR^MDRPCOT1(DFN,MDVSTR,MDPROC,$$GET1^DIQ(702,MDIEN,.02,"I"))
"RTN","MDRPCNT1",89,0)
 .S MDLOC=$P(MDVSTR,";",1)
"RTN","MDRPCNT1",90,0)
 ; Does TIU doc already exist?
"RTN","MDRPCNT1",91,0)
 ;I $$GET1^DIQ(702,MDIEN,.06,"I") Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+$$GET1^DIQ(702,MDIEN,.06,"I")_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCNT1",92,0)
 ; Does TIU doc exist for previous transaction of this consult?
"RTN","MDRPCNT1",93,0)
 ;I MDCON S MDNOTE=$$PREV(MDCON,MDIEN)
"RTN","MDRPCNT1",94,0)
 S MDNOTE=""
"RTN","MDRPCNT1",95,0)
 Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+MDNOTE_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCNT1",96,0)
 ;
"RTN","MDRPCNT1",97,0)
NEWTIUN(STUDY,MDDT,MDA,MDNT) ; [Function] Create a new TIU for transaction
"RTN","MDRPCNT1",98,0)
 ; Input: STUDY - IENS of CP study entry
"RTN","MDRPCNT1",99,0)
 ;        MDDT - Date of Note
"RTN","MDRPCNT1",100,0)
 ;        MDA - Author
"RTN","MDRPCNT1",101,0)
 ;        MDNT - Note Title
"RTN","MDRPCNT1",102,0)
 ; Return: TIU Document IEN
"RTN","MDRPCNT1",103,0)
 N CTR,DFN,MDCON,MDFDA,MDGST,MDL,MDLOC,MDNOTE,MDPDT,MDPROC,MDPT,MDRESU,MDDTTL,MDTITL,MDTSTR,MDVST,MDVSTR,MDWP S CTR=0,MDGST=+STUDY,MDRESU="" N MDFIL S MDFIL=8925.1
"RTN","MDRPCNT1",104,0)
 ; Get data for TIU Note Creation
"RTN","MDRPCNT1",105,0)
 S (MDTSTR,MDRESU)=$$GETDATA(MDGST),MDDTTL=0
"RTN","MDRPCNT1",106,0)
 ; File Error message
"RTN","MDRPCNT1",107,0)
 I +MDRESU<0 D FILEMSG(MDGST,"CP",2,MDRESU) Q MDRESU
"RTN","MDRPCNT1",108,0)
 I $G(MDTSTR)="" Q "-1^No Data to Create TIU Document"
"RTN","MDRPCNT1",109,0)
 F MDL="DFN","MDTITL","MDLOC","MDNOTE","MDCON","MDPROC","MDVSTR","MDNVST" D
"RTN","MDRPCNT1",110,0)
 .S CTR=CTR+1,@MDL=$P(MDTSTR,"^",CTR)
"RTN","MDRPCNT1",111,0)
 S (MDVST,MDRESU)=""
"RTN","MDRPCNT1",112,0)
 ; If previous TIU document exists, quit
"RTN","MDRPCNT1",113,0)
 ;I MDNOTE Q MDNOTE
"RTN","MDRPCNT1",114,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCNT1",115,0)
 ; Create new visit, if no vstring
"RTN","MDRPCNT1",116,0)
 S MDDTTL=+$$FIND1^DIC(MDFIL,"","BOX",MDNT,"B","","MDERR")
"RTN","MDRPCNT1",117,0)
 S MDTITL=$S(+MDDTTL>0:+MDDTTL,1:MDTITL)
"RTN","MDRPCNT1",118,0)
 S MDPDT=$$PDT^MDRPCOT1(MDGST)
"RTN","MDRPCNT1",119,0)
 I 'MDPDT S MDPT=$O(^MDD(703.1,"ASTUDYID",+MDGST,0)),MDPDT=$P($G(^MDD(703.1,+MDPT,0)),U,3)
"RTN","MDRPCNT1",120,0)
 S:'MDPDT MDPDT=$P(MDVSTR,";",2) ; If No D/T Performed grab visit D/T
"RTN","MDRPCNT1",121,0)
 ; Build variables for TIU Call
"RTN","MDRPCNT1",122,0)
 S MDWP(.05)=1 ; Undicated Status
"RTN","MDRPCNT1",123,0)
 S MDWP(1201)=MDDT ; Date/Time Note Created
"RTN","MDRPCNT1",124,0)
 S MDWP(1202)=MDA ; Author of Note
"RTN","MDRPCNT1",125,0)
 S MDWP(1302)=MDA ; Entered By
"RTN","MDRPCNT1",126,0)
 S MDWP(1405)=+MDCON_";GMR(123," ; Package Reference
"RTN","MDRPCNT1",127,0)
 S MDWP(70201)=5 ; Default Procedure Summary Code "Machine Resulted"
"RTN","MDRPCNT1",128,0)
 I MDPDT S MDWP(70202)=MDPDT ; Date/Time Performed
"RTN","MDRPCNT1",129,0)
 ; File PCE Error message
"RTN","MDRPCNT1",130,0)
 I MDNVST S MDRESU=$$EN1^MDPCE(MDGST,MDPDT,MDPROC,$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU,MDVSTR=$P(MDRESU,"^",2)
"RTN","MDRPCNT1",131,0)
 I +MDRESU<0 D FILEMSG(MDGST,"PCE",2,$P(MDRESU,"^",2)) Q MDRESU
"RTN","MDRPCNT1",132,0)
 ; Create the TIU note stub
"RTN","MDRPCNT1",133,0)
 I MDVST="" S MDVST=+$G(^MDD(702,MDGST,1))
"RTN","MDRPCNT1",134,0)
 S MDNOTE="" D MAKE^TIUSRVP(.MDNOTE,DFN,MDTITL,$P(MDVSTR,";",2),MDLOC,$S(MDVST:MDVST,1:""),.MDWP,MDVSTR,1,1)
"RTN","MDRPCNT1",135,0)
 I '(+MDNOTE) S $P(MDNOTE,"^")=-1 Q MDNOTE
"RTN","MDRPCNT1",136,0)
 ;S MDFDA(702,STUDY_",",.06)=+MDNOTE
"RTN","MDRPCNT1",137,0)
 S MDFDA(702,STUDY_",",.08)=""
"RTN","MDRPCNT1",138,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCNT1",139,0)
 D UPD^MDKUTLR(STUDY,+MDNOTE)
"RTN","MDRPCNT1",140,0)
 Q MDNOTE
"RTN","MDRPCNT1",141,0)
 ;
"RTN","MDRPCNT1",142,0)
UPDATE(STUDY,MDA,SIGN,MDGLB) ; Update the TIU document with the text
"RTN","MDRPCNT1",143,0)
 N MDK,MDNOTE,MDPPR,MDRESU,MDS,MDTI,MDTIUER,MDWP,MDV,MDV1,MDVAU S (MDNOTE,MDTIUER)="" K MDWP,^TMP("MDTIUST",$J)
"RTN","MDRPCNT1",144,0)
 F MDK=0:0 S MDK=$O(@MDGLB@(MDK)) Q:'MDK  S MDWP("TEXT",MDK,0)=$G(@MDGLB@(MDK))
"RTN","MDRPCNT1",145,0)
 S MDTI=MDA
"RTN","MDRPCNT1",146,0)
 S MDWP(.05)=5
"RTN","MDRPCNT1",147,0)
 D GETDCOS^ORWTPN(.MDVAU,DUZ)
"RTN","MDRPCNT1",148,0)
 I +MDVAU S MDWP(1506)=1,MDWP(1208)=+MDVAU
"RTN","MDRPCNT1",149,0)
 D UPDATE^TIUSRVP(.MDNOTE,+MDTI,.MDWP,1)
"RTN","MDRPCNT1",150,0)
 I '+MDNOTE S MDNOTE="-1^"_$P(MDNOTE,"^",2) Q MDNOTE
"RTN","MDRPCNT1",151,0)
 ; Sign TIU Document
"RTN","MDRPCNT1",152,0)
 S MDS=$$SIGN(MDTI,SIGN) I MDS<0 Q MDS
"RTN","MDRPCNT1",153,0)
 Q 1
"RTN","MDRPCNT1",154,0)
SIGN(MDTIUIN,MDSIGN) ; Sign the TIU Document
"RTN","MDRPCNT1",155,0)
 ; [Function] TIU SIGN RECORD
"RTN","MDRPCNT1",156,0)
 ;Input Parameters:
"RTN","MDRPCNT1",157,0)
 ;   1.  TIUIEN [Literal/Required] TIU internal Entry Number
"RTN","MDRPCNT1",158,0)
 ;   2.  MDSIGN [Literal/Required] User Signature
"RTN","MDRPCNT1",159,0)
 N MDSRES,X
"RTN","MDRPCNT1",160,0)
 S MDSRES=""
"RTN","MDRPCNT1",161,0)
 D SIGN^TIUSRVP2(.MDSRES,MDTIUIN,MDSIGN)
"RTN","MDRPCNT1",162,0)
 I +MDSRES>0 Q "-1^"_$P(MDSRES,"^",2)
"RTN","MDRPCNT1",163,0)
 Q 1
"RTN","MDRPCNT1",164,0)
 ;
"RTN","MDRPCNT1",165,0)
PREV(MDC,MDS) ; [Function] Return the Previous TIU document.
"RTN","MDRPCNT1",166,0)
 N MDNEWV,MDDOC,MDTRAN,MDTIUER,MDTST
"RTN","MDRPCNT1",167,0)
 S (MDDOC,MDNEWV,MDTRAN,MDTIUER,MDTST)="" K ^TMP("MDTIUST",$J)
"RTN","MDRPCNT1",168,0)
 F  S MDTRAN=$O(^MDD(702,"ACON",MDC,MDTRAN)) Q:'MDTRAN  D  Q:'MDTRAN
"RTN","MDRPCNT1",169,0)
 .I $P(^MDD(702,MDTRAN,0),U,6) D
"RTN","MDRPCNT1",170,0)
 ..D EXTRACT^TIULQ($P(^MDD(702,MDTRAN,0),U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;1406") Q:+MDTIUER
"RTN","MDRPCNT1",171,0)
 ..S MDTST=$G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),.05,"E"))
"RTN","MDRPCNT1",172,0)
 ..I MDTST'="UNDICTATED"&(MDTST'="UNSIGNED") K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCNT1",173,0)
 ..I MDTST="UNSIGNED"&'($G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),1406,"I"))) K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCNT1",174,0)
 ..S MDDOC=$P(^MDD(702,MDTRAN,0),U,6),MDNEWV=$P(^MDD(702,MDTRAN,0),U,7)
"RTN","MDRPCNT1",175,0)
 ..Q:'MDS
"RTN","MDRPCNT1",176,0)
 ..S MDFDA(702,MDS_",",.06)=MDDOC
"RTN","MDRPCNT1",177,0)
 ..S MDFDA(702,MDS_",",.07)=MDNEWV
"RTN","MDRPCNT1",178,0)
 ..D FILE^DIE("","MDFDA")
"RTN","MDRPCNT1",179,0)
 ..S MDTRAN=""
"RTN","MDRPCNT1",180,0)
 Q MDDOC
"RTN","MDRPCOT")
0^21^B85701277^B79210353
"RTN","MDRPCOT",1,0)
MDRPCOT ; HOIFO/DP/NCA - Object RPCs (TMDTransaction) ;10/26/09  10:23
"RTN","MDRPCOT",2,0)
 ;;1.0;CLINICAL PROCEDURES;**5,6,11,21**;Apr 01, 2004;Build 30
"RTN","MDRPCOT",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT",4,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDRPCOT",5,0)
 ; IA# 2944 [Subscription] Calls to TIUSRVR1.
"RTN","MDRPCOT",6,0)
 ; IA# 3535 [Subscription] Calls to TIUSRVP.
"RTN","MDRPCOT",7,0)
 ; IA# 10103 [Supported] Call to XLFDT
"RTN","MDRPCOT",8,0)
 ; IA# 10104 [Supported] Routine XLFSTR calls
"RTN","MDRPCOT",9,0)
ADDMSG ; [Procedure] Add message to transaction
"RTN","MDRPCOT",10,0)
 N MDIEN,MDIENS,MDRET
"RTN","MDRPCOT",11,0)
 Q:'$G(DATA("TRANSACTION"))
"RTN","MDRPCOT",12,0)
 Q:$G(DATA("MESSAGE"))=""
"RTN","MDRPCOT",13,0)
 S MDIEN=+DATA("TRANSACTION"),MDIENS="+1,"_MDIEN_","
"RTN","MDRPCOT",14,0)
 D NOW^%DTC S DATA("DATE")=% K %
"RTN","MDRPCOT",15,0)
 S MDFDA(702.091,MDIENS,.01)=+$O(^MDD(702,+MDIEN,.091,"A"),-1)+1
"RTN","MDRPCOT",16,0)
 S MDFDA(702.091,MDIENS,.02)=DATA("DATE")
"RTN","MDRPCOT",17,0)
 S MDFDA(702.091,MDIENS,.03)=$G(DATA("PKG"),"UNKNOWN")
"RTN","MDRPCOT",18,0)
 S MDFDA(702.091,MDIENS,.09)=DATA("MESSAGE")
"RTN","MDRPCOT",19,0)
 D UPDATE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOT",20,0)
 Q
"RTN","MDRPCOT",21,0)
 ;
"RTN","MDRPCOT",22,0)
DELETE ; [Procedure] Delete Study
"RTN","MDRPCOT",23,0)
 ; Sets @RESULTS@(0)="-1^Reason for not deleting" or "1^Study Deleted"
"RTN","MDRPCOT",24,0)
 ;
"RTN","MDRPCOT",25,0)
 N MDAST,MDHOLD,MDNOTE,MDRES,MDSIEN,BODY,SUBJECT,DEVIEN
"RTN","MDRPCOT",26,0)
 S (MDHOLD,MDSIEN)=+DATA,MDRES=0,MDNOTE=""
"RTN","MDRPCOT",27,0)
 D ALERT^MDHL7U3(MDSIEN) ; Builds the body of the mail message
"RTN","MDRPCOT",28,0)
 I $G(^MDD(702,+MDSIEN,0))="" S @RESULTS@(0)="1^Study Deleted." D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) Q  ;deleting message
"RTN","MDRPCOT",29,0)
 S:+$P(^MDD(702,MDSIEN,0),U,6) MDNOTE=$P(^MDD(702,MDSIEN,0),U,6)
"RTN","MDRPCOT",30,0)
 I "13"[$P(^MDD(702,MDSIEN,0),U,9) S @RESULTS@(0)="-1^Can't Delete TIU Note from a "_$$GET1^DIQ(702,MDSIEN,.09,"E")_" Study." Q
"RTN","MDRPCOT",31,0)
 I "5"[$P(^MDD(702,MDSIEN,0),U,9) S MDCANR=$$CANCEL^MDHL7B(MDHOLD) I +MDCANR<0 S @RESULTS@(0)="-1^"_$P(MDCANR,"^",2) Q
"RTN","MDRPCOT",32,0)
 I +MDNOTE S MDRES="" D DELETE^TIUSRVP(.MDRES,MDNOTE)
"RTN","MDRPCOT",33,0)
 I MDRES D  Q
"RTN","MDRPCOT",34,0)
 .D STATUS(MDSIEN_",",2,$P(MDRES,"^",2))
"RTN","MDRPCOT",35,0)
 .S DATA("TRANSACTION")=MDSIEN,DATA("PKG")="TIU"
"RTN","MDRPCOT",36,0)
 .S DATA("MESSAGE")=$P(MDRES,"^",2) D ADDMSG
"RTN","MDRPCOT",37,0)
 .S @RESULTS@(0)="-1^"_$P(MDRES,"^",2)
"RTN","MDRPCOT",38,0)
 .Q
"RTN","MDRPCOT",39,0)
 E  D
"RTN","MDRPCOT",40,0)
 .I $D(^MDD(702.001,"ASTUDY",MDSIEN)) S @RESULTS@(0)="-1^Note associated with study, can not delete." Q
"RTN","MDRPCOT",41,0)
 .S MDAST=$$HL7CHK^MDHL7U3(+MDSIEN) I +MDAST<1 S @RESULTS@(0)=MDAST Q
"RTN","MDRPCOT",42,0)
 .D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) ; delete message
"RTN","MDRPCOT",43,0)
 .S MDFDA(702,DATA_",",.01)=""
"RTN","MDRPCOT",44,0)
 .; Check for renal study to delete as well
"RTN","MDRPCOT",45,0)
 .S:$D(^MDK(704.202,DATA)) MDFDA(704.202,DATA_",",.01)=""
"RTN","MDRPCOT",46,0)
 .D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",47,0)
 .N DA,DIK S DA=+MDSIEN,DIK="^MDD(702," D ^DIK
"RTN","MDRPCOT",48,0)
 .S @RESULTS@(0)="1^Study Deleted."
"RTN","MDRPCOT",49,0)
 .Q
"RTN","MDRPCOT",50,0)
 Q
"RTN","MDRPCOT",51,0)
 ;
"RTN","MDRPCOT",52,0)
FILEMSG(STUDY,MDPKG,MDSTAT,MDMSG) ; [Procedure] File Study Status and Message.
"RTN","MDRPCOT",53,0)
 S DATA("TRANSACTION")=STUDY,DATA("PKG")=MDPKG
"RTN","MDRPCOT",54,0)
 S DATA("MESSAGE")=$P(MDMSG,"^",2)
"RTN","MDRPCOT",55,0)
 D STATUS(STUDY_",",MDSTAT,$P(MDMSG,"^",2)),ADDMSG
"RTN","MDRPCOT",56,0)
 Q
"RTN","MDRPCOT",57,0)
 ;
"RTN","MDRPCOT",58,0)
FILES ; [Procedure] Add/remove an attachment to this transaction
"RTN","MDRPCOT",59,0)
 NEW MDFDA,MDIEN,MDIENS,MDRET,MDT,MDT1,P1,P2,P3,P4
"RTN","MDRPCOT",60,0)
 S P1=$P(DATA,U,1),P2=$P(DATA,U,2),P3=$P(DATA,U,3),P4=$P(DATA,U,4)
"RTN","MDRPCOT",61,0)
 S MDIEN=0 I $G(^MDD(702,+P1,0))="" Q
"RTN","MDRPCOT",62,0)
 S MDT=+P1,MDT1=$$MULT^MDRPCOT1(MDT),MDT=$S('MDT1:1,MDT1=1:1,1:0)
"RTN","MDRPCOT",63,0)
 ;I +MDT,$P($G(^MDD(702,+P1,0)),"^",9)=3 S @RESULTS@(0)="1^Study is already complete" Q
"RTN","MDRPCOT",64,0)
 I $P($G(^MDD(702,+P1,0)),"^",9)=6 S @RESULTS@(0)="1^Study is already cancelled" Q
"RTN","MDRPCOT",65,0)
 ; Look for file (All comparisons done on lower case values)
"RTN","MDRPCOT",66,0)
 F  S MDIEN=$O(^MDD(702,P1,.1,MDIEN)) Q:'MDIEN  D  Q:X=P3
"RTN","MDRPCOT",67,0)
 .S X=$$LOW^XLFSTR($G(^MDD(702,P1,.1,MDIEN,.1)))
"RTN","MDRPCOT",68,0)
 I +MDT,MDIEN,P4 S @RESULTS@(0)="1^File already assigned" Q
"RTN","MDRPCOT",69,0)
 I 'MDIEN&'P4 S @RESULTS@(0)="1^File not assigned" Q
"RTN","MDRPCOT",70,0)
 I P4 D  Q  ; Add a file
"RTN","MDRPCOT",71,0)
 .S MDIENS="+1,"_P1_","
"RTN","MDRPCOT",72,0)
 .S MDFDA(702.1,MDIENS,.01)=$O(^MDD(702,P1,.1,"B",""),-1)+1
"RTN","MDRPCOT",73,0)
 .S MDFDA(702.1,MDIENS,.02)=$S(P2:"I",1:"U")
"RTN","MDRPCOT",74,0)
 .I P2 S MDFDA(702.1,MDIENS,.03)=P2
"RTN","MDRPCOT",75,0)
 .S MDFDA(702.1,MDIENS,.1)=P3
"RTN","MDRPCOT",76,0)
 .D UPDATE^DIE("","MDFDA","MDIEN")
"RTN","MDRPCOT",77,0)
 .S @RESULTS@(0)=+$G(MDIEN(1),-1)
"RTN","MDRPCOT",78,0)
 I 'P4 D  Q  ; Remove the file
"RTN","MDRPCOT",79,0)
 .S MDFDA(702.1,MDIEN_","_P1_",",.01)="@"
"RTN","MDRPCOT",80,0)
 .D FILE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOT",81,0)
 .S @RESULTS@(0)=$S($D(MDRET):-1,1:1)
"RTN","MDRPCOT",82,0)
 Q
"RTN","MDRPCOT",83,0)
 ;
"RTN","MDRPCOT",84,0)
GETATT ; [Procedure] Get Attachments
"RTN","MDRPCOT",85,0)
 F X=0:0 S X=$O(^MDD(702,DATA,.1,X)) Q:'X  D
"RTN","MDRPCOT",86,0)
 .S Y=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOT",87,0)
 .S @RESULTS@(Y)=$P(^MDD(702,DATA,.1,X,0),U,1,3)
"RTN","MDRPCOT",88,0)
 .S $P(@RESULTS@(Y),U,4)=$G(^MDD(702,DATA,.1,X,.1))
"RTN","MDRPCOT",89,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOT",90,0)
 Q
"RTN","MDRPCOT",91,0)
 ;
"RTN","MDRPCOT",92,0)
GETERR ; [Procedure] Return list of Imaging Errors
"RTN","MDRPCOT",93,0)
 ; DATA = Transaction IEN
"RTN","MDRPCOT",94,0)
 F MDX=0:0 S MDX=$O(^MDD(702,DATA,.091,MDX)) Q:'MDX  D
"RTN","MDRPCOT",95,0)
 .S MDY=+^MDD(702,DATA,.091,MDX,0)_U,Y=$P(^(0),U,2)
"RTN","MDRPCOT",96,0)
 .D D^DIQ S MDY=MDY_Y_U
"RTN","MDRPCOT",97,0)
 .S MDY=MDY_$P(^MDD(702,DATA,.091,MDX,0),U,3)_U_$P(^(0),U,9)
"RTN","MDRPCOT",98,0)
 .S ^TMP($J,$O(^TMP($J,""),-1)+1)=MDY
"RTN","MDRPCOT",99,0)
 S ^TMP($J,0)=+$O(^TMP($J,""),-1)
"RTN","MDRPCOT",100,0)
 Q
"RTN","MDRPCOT",101,0)
 ;
"RTN","MDRPCOT",102,0)
NEWSTAT ; [Procedure] RPC Call to set status
"RTN","MDRPCOT",103,0)
 S MDFDA(702,DATA,.09)=TYPE
"RTN","MDRPCOT",104,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",105,0)
 I TYPE=3&($G(^MDK(704.202,+DATA,0))'="") K MDFDA S MDFDA(704.202,DATA,.09)=0 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDRPCOT",106,0)
 I TYPE=5 D
"RTN","MDRPCOT",107,0)
 .N MDHL7,MDERR S MDHL7=$$SUB^MDHL7B(+DATA)
"RTN","MDRPCOT",108,0)
 .I +MDHL7=-1 S MDFDA(702,DATA,.09)=2,MDFDA(702,DATA,.08)=$P(MDHL7,U,2)
"RTN","MDRPCOT",109,0)
 .I +MDHL7=1 S MDFDA(702,DATA,.09)=5,MDFDA(702,DATA,.08)=""
"RTN","MDRPCOT",110,0)
 .I $L($P($G(^MDD(702,+DATA,0)),"^",7),";")=1 S MDFDA(702,DATA,.07)=$$NOW^XLFDT(),MDFDA(702,DATA,.14)=$$NOW^XLFDT()
"RTN","MDRPCOT",111,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDRPCOT",112,0)
 Q
"RTN","MDRPCOT",113,0)
 ;
"RTN","MDRPCOT",114,0)
RPC(RESULTS,OPTION,DATA,TYPE,FILE,RESREP) ; [Procedure] Main RPC call
"RTN","MDRPCOT",115,0)
 N MDCANR,MDCON,MDDOC,MDFDA,MDFN,MDGST,MDHOLD,MDIEN,MDIENS,MDL,MDLOC,MDMSG,MDNEWV,MDNOTE,MDNVST,MDPDT,MDPKG,MDPROC,MDRES,MDRESU,MDRESUL,MDRET,MDS,MDSIEN,MDSTAT,MDSTUDY,MDTITL,MDTIUER,MDTRAN,MDTST,MDTSTR,MDVST,MDVSTR,MDWP,MDX,MDY
"RTN","MDRPCOT",116,0)
 S RESULTS=$NA(^TMP($J)) K @RESULTS
"RTN","MDRPCOT",117,0)
 D:$T(@OPTION)]"" @OPTION
"RTN","MDRPCOT",118,0)
 D:'$D(@RESULTS) BADRPC^MDRPCU("MD TMDTRANSACTION","MDRPCOT",OPTION)
"RTN","MDRPCOT",119,0)
 D CLEAN^DILF
"RTN","MDRPCOT",120,0)
 Q
"RTN","MDRPCOT",121,0)
 ;
"RTN","MDRPCOT",122,0)
STATUS(MDIENS,MDSTAT,MDMSG) ; [Procedure] Update transaction status
"RTN","MDRPCOT",123,0)
 S MDFDA(702,MDIENS,.08)=$G(MDMSG)
"RTN","MDRPCOT",124,0)
 S MDFDA(702,MDIENS,.09)=MDSTAT
"RTN","MDRPCOT",125,0)
 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDRPCOT",126,0)
 Q
"RTN","MDRPCOT",127,0)
 ;
"RTN","MDRPCOT",128,0)
SUBMIT ; [Procedure] Process the Image(s) Submission.
"RTN","MDRPCOT",129,0)
 ; Output: -1^Error Message or
"RTN","MDRPCOT",130,0)
 ;          1^Successful Message
"RTN","MDRPCOT",131,0)
 N MDRESUL,MDSTUDY
"RTN","MDRPCOT",132,0)
 S MDSTUDY=+DATA,MDRESUL=""
"RTN","MDRPCOT",133,0)
 ; Create New TIU Document
"RTN","MDRPCOT",134,0)
 S MDRESUL=$$NEWTIUN(MDSTUDY)
"RTN","MDRPCOT",135,0)
 ; File TIU Error messages
"RTN","MDRPCOT",136,0)
 I +MDRESUL<0 D  Q
"RTN","MDRPCOT",137,0)
 .D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCOT",138,0)
 .S @RESULTS@(0)=MDRESUL
"RTN","MDRPCOT",139,0)
 ; Submit and export the images
"RTN","MDRPCOT",140,0)
 S MDRESUL=$$SUBMIT^MDRPCOT1(MDSTUDY)
"RTN","MDRPCOT",141,0)
 ; File message
"RTN","MDRPCOT",142,0)
 D FILEMSG(MDSTUDY,"IMAGING",$S(+MDRESUL>0:+MDRESUL,1:2),MDRESUL)
"RTN","MDRPCOT",143,0)
 S @RESULTS@(0)=MDRESUL
"RTN","MDRPCOT",144,0)
 Q
"RTN","MDRPCOT",145,0)
 ;
"RTN","MDRPCOT",146,0)
VIEWTIU ; [Procedure] VIew the associated tiu document
"RTN","MDRPCOT",147,0)
 I '$P(^MDD(702,+DATA,0),U,6) D  Q
"RTN","MDRPCOT",148,0)
 .S @RESULTS@(0)="NO TIU NOTE FOR THIS STUDY"
"RTN","MDRPCOT",149,0)
 D TGET^TIUSRVR1(.RESULTS,+$P(^MDD(702,+DATA,0),U,6))
"RTN","MDRPCOT",150,0)
 Q
"RTN","MDRPCOT",151,0)
 ;
"RTN","MDRPCOT",152,0)
GETDATA(STUDY) ; [Function] Return the Necessary data for creating a TIU note.
"RTN","MDRPCOT",153,0)
 ; Return: Patient DFN_"^"_TIU title_"^"_Hospital Location_"^"_TIU Note
"RTN","MDRPCOT",154,0)
 ;         IEN_"^"_Consult #_"^"_CP Definition IEN_"^"_Visit String_"^"
"RTN","MDRPCOT",155,0)
 ;         New Visit Flag
"RTN","MDRPCOT",156,0)
 ;         or
"RTN","MDRPCOT",157,0)
 ;         -1^Error Message
"RTN","MDRPCOT",158,0)
 N DFN,MDCON,MDFN,MDIEN,MDDPT,MDIENS,MDLOC,MDNEWV,MDNOTE,MDNVST,MDPROC,MDVSTR,MDTITL,MDX,MDTST
"RTN","MDRPCOT",159,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDNVST=0
"RTN","MDRPCOT",160,0)
 I $$GET1^DIQ(702,MDIENS,.01)="" Q "-1^No such study entry."
"RTN","MDRPCOT",161,0)
 ; Get DFN
"RTN","MDRPCOT",162,0)
 S DFN=$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT",163,0)
 I 'DFN Q "-1^No DFN."
"RTN","MDRPCOT",164,0)
 ; Get CP Def
"RTN","MDRPCOT",165,0)
 S MDPROC=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT",166,0)
 I 'MDPROC Q "-1^No CP Def."
"RTN","MDRPCOT",167,0)
 ; Get Consult
"RTN","MDRPCOT",168,0)
 S MDCON=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT",169,0)
 I 'MDCON Q "-1^No Consult #."
"RTN","MDRPCOT",170,0)
 ; Get TIU Note Title
"RTN","MDRPCOT",171,0)
 S MDTITL=$$GET1^DIQ(702.01,+MDPROC_",",.04,"I")
"RTN","MDRPCOT",172,0)
 I 'MDTITL Q "-1^No TIU Note Title."
"RTN","MDRPCOT",173,0)
 S MDVSTR=$$GET1^DIQ(702,MDIEN,.07)
"RTN","MDRPCOT",174,0)
 I MDVSTR=""  Q "-1^No Visit String."
"RTN","MDRPCOT",175,0)
 I $L(MDVSTR,";")=1 S MDNVST=1,MDDPT=$$PDT^MDRPCOT1(MDIEN),MDVSTR=";"_MDVSTR ; If new visit is selected
"RTN","MDRPCOT",176,0)
 ; MDLOC is Hospital Location
"RTN","MDRPCOT",177,0)
 I MDVSTR'="" D
"RTN","MDRPCOT",178,0)
 .S MDVSTR=$$GETVSTR^MDRPCOT1(DFN,MDVSTR,MDPROC,$$GET1^DIQ(702,MDIEN,.02,"I"))
"RTN","MDRPCOT",179,0)
 .S MDLOC=$P(MDVSTR,";",1)
"RTN","MDRPCOT",180,0)
 I $$GET1^DIQ(702.01,+MDPROC_",",.12,"I")=1 Q DFN_"^"_MDTITL_"^"_MDLOC_"^^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",181,0)
 ; Does TIU doc already exist?
"RTN","MDRPCOT",182,0)
 I $$GET1^DIQ(702,MDIEN,.06,"I") Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+$$GET1^DIQ(702,MDIEN,.06,"I")_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",183,0)
 ; Does TIU doc exist for previous transaction of this consult?
"RTN","MDRPCOT",184,0)
 I MDCON S MDNOTE=$$PREV(MDCON,MDIEN)
"RTN","MDRPCOT",185,0)
 Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+MDNOTE_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT",186,0)
 ;
"RTN","MDRPCOT",187,0)
NEWTIUN(STUDY) ; [Function] Create a new TIU for transaction
"RTN","MDRPCOT",188,0)
 ; Input: STUDY - IENS of CP study entry
"RTN","MDRPCOT",189,0)
 ; Return: TIU Document IEN
"RTN","MDRPCOT",190,0)
 N CTR,DFN,MDCON,MDFDA,MDGST,MDL,MDLOC,MDNOTE,MDPDT,MDPROC,MDRESU,MDTITL,MDTSTR,MDVST,MDVSTR,MDWP,MDPT S CTR=0,MDGST=+STUDY,MDRESU=""
"RTN","MDRPCOT",191,0)
 ; Get data for TIU Note Creation
"RTN","MDRPCOT",192,0)
 S (MDTSTR,MDRESU)=$$GETDATA(MDGST)
"RTN","MDRPCOT",193,0)
 ; File Error message
"RTN","MDRPCOT",194,0)
 I +MDRESU<0 D FILEMSG(MDGST,"CP",2,MDRESU) Q MDRESU
"RTN","MDRPCOT",195,0)
 I $G(MDTSTR)="" Q "-1^No Data to Create TIU Document"
"RTN","MDRPCOT",196,0)
 F MDL="DFN","MDTITL","MDLOC","MDNOTE","MDCON","MDPROC","MDVSTR","MDNVST" D
"RTN","MDRPCOT",197,0)
 .S CTR=CTR+1,@MDL=$P(MDTSTR,"^",CTR)
"RTN","MDRPCOT",198,0)
 S MDVST=""
"RTN","MDRPCOT",199,0)
 ; If previous TIU document exists, quit
"RTN","MDRPCOT",200,0)
 I MDNOTE Q MDNOTE
"RTN","MDRPCOT",201,0)
 I $$GET^XPAR("SYS","MD GET HIGH VOLUME",MDPROC,"I")'=""&(+$P(^MDD(702,+MDGST,0),"^",6)) Q $P(^MDD(702,+MDGST,0),"^",6)
"RTN","MDRPCOT",202,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT",203,0)
 ; Create new visit, if no vstring
"RTN","MDRPCOT",204,0)
 S MDPDT=$$PDT^MDRPCOT1(MDGST)
"RTN","MDRPCOT",205,0)
 I 'MDPDT S MDPT=$O(^MDD(703.1,"ASTUDYID",+MDGST,0)),MDPDT=$P($G(^MDD(703.1,+MDPT,0)),U,3)
"RTN","MDRPCOT",206,0)
 S:'MDPDT MDPDT=$P(MDVSTR,";",2) ; If No D/T Performed grab visit D/T
"RTN","MDRPCOT",207,0)
 I $P(MDVSTR,";",3)="V" S $P(MDVSTR,";",3)="A"
"RTN","MDRPCOT",208,0)
 ; Build variables for TIU Call
"RTN","MDRPCOT",209,0)
 S MDWP(.05)=1 ; Undicated Status
"RTN","MDRPCOT",210,0)
 S MDWP(1405)=+MDCON_";GMR(123," ; Package Reference
"RTN","MDRPCOT",211,0)
 S MDWP(70201)=5 ; Default Procedure Summary Code "Machine Resulted"
"RTN","MDRPCOT",212,0)
 I MDPDT S MDWP(70202)=MDPDT ; Date/Time Performed
"RTN","MDRPCOT",213,0)
 ; File PCE Error message
"RTN","MDRPCOT",214,0)
 I MDNVST S MDRESU=$$EN1^MDPCE(MDGST,$P(MDVSTR,";",2),MDPROC,$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU,MDVSTR=$P(MDRESU,"^",2)
"RTN","MDRPCOT",215,0)
 I MDNVST&(+MDRESU<0) D FILEMSG(MDGST,"PCE",2,$P(MDRESU,"^",2)) Q MDRESU
"RTN","MDRPCOT",216,0)
 ; Create the TIU note stub
"RTN","MDRPCOT",217,0)
 S MDNOTE="" D MAKE^TIUSRVP(.MDNOTE,DFN,MDTITL,$P(MDVSTR,";",2),MDLOC,$S(MDVST:MDVST,1:""),.MDWP,MDVSTR,1,1)
"RTN","MDRPCOT",218,0)
 I '(+MDNOTE) S $P(MDNOTE,"^")=-1 Q MDNOTE
"RTN","MDRPCOT",219,0)
 ; Finalize the transaction
"RTN","MDRPCOT",220,0)
 S MDFDA(702,STUDY_",",.06)=+MDNOTE
"RTN","MDRPCOT",221,0)
 S MDFDA(702,STUDY_",",.08)=""
"RTN","MDRPCOT",222,0)
 S:MDVST>0 MDFDA(702,STUDY_",",.13)=MDVST
"RTN","MDRPCOT",223,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",224,0)
 D UPD^MDKUTLR(STUDY,+MDNOTE)
"RTN","MDRPCOT",225,0)
 Q 1
"RTN","MDRPCOT",226,0)
 ;
"RTN","MDRPCOT",227,0)
PREV(MDC,MDS) ; [Function] Return the Previous TIU document.
"RTN","MDRPCOT",228,0)
 N MDNEWV,MDDOC,MDTRAN,MDTIUER,MDTST
"RTN","MDRPCOT",229,0)
 S (MDDOC,MDNEWV,MDTRAN,MDTIUER,MDTST)="" K ^TMP("MDTIUST",$J)
"RTN","MDRPCOT",230,0)
 F  S MDTRAN=$O(^MDD(702,"ACON",MDC,MDTRAN)) Q:'MDTRAN  D  Q:'MDTRAN
"RTN","MDRPCOT",231,0)
 .I $P(^MDD(702,MDTRAN,0),U,6) D
"RTN","MDRPCOT",232,0)
 ..D EXTRACT^TIULQ($P(^MDD(702,MDTRAN,0),U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;1406") Q:+MDTIUER
"RTN","MDRPCOT",233,0)
 ..S MDTST=$G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),.05,"E"))
"RTN","MDRPCOT",234,0)
 ..I MDTST'="UNDICTATED"&(MDTST'="UNSIGNED") K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT",235,0)
 ..I MDTST="UNSIGNED"&'($G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),1406,"I"))) K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT",236,0)
 ..S MDDOC=$P(^MDD(702,MDTRAN,0),U,6),MDNEWV=$P(^MDD(702,MDTRAN,0),U,7)
"RTN","MDRPCOT",237,0)
 ..Q:'MDS
"RTN","MDRPCOT",238,0)
 ..S MDFDA(702,MDS_",",.06)=MDDOC
"RTN","MDRPCOT",239,0)
 ..S MDFDA(702,MDS_",",.07)=MDNEWV
"RTN","MDRPCOT",240,0)
 ..D FILE^DIE("","MDFDA")
"RTN","MDRPCOT",241,0)
 ..S MDTRAN=""
"RTN","MDRPCOT",242,0)
 Q MDDOC
"RTN","MDRPCOT",243,0)
 ;
"RTN","MDRPCOT1")
0^22^B41706537^B34134564
"RTN","MDRPCOT1",1,0)
MDRPCOT1 ; HOIFO/NCA/DP - Object RPCs (TMDTransaction) - Continued ;3/13/09  11:18
"RTN","MDRPCOT1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**5,11,21**;Apr 01, 2004;Build 30
"RTN","MDRPCOT1",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT1",4,0)
 ; IA# 2263 [Supported] calls to XPAR
"RTN","MDRPCOT1",5,0)
 ; IA# 3067 [Private] Reads fields in Consults file (#123).
"RTN","MDRPCOT1",6,0)
 ; IA# 3468 [Subscription] GMRCCP API.
"RTN","MDRPCOT1",7,0)
 ; IA# 3567 [Subscription] MAGGSIUI API
"RTN","MDRPCOT1",8,0)
 ; IA# 10040 [Supported] Hospital Location File Access
"RTN","MDRPCOT1",9,0)
 ; IA# 10061 [Supported] Calls to VADPT
"RTN","MDRPCOT1",10,0)
 ; IA# 10103 [Supported] Calls to XLFDT.
"RTN","MDRPCOT1",11,0)
 ;
"RTN","MDRPCOT1",12,0)
DELERR(MDTIEN) ; [Procedure] Delete Imaging Error Messages
"RTN","MDRPCOT1",13,0)
 S MDLP=0 F  S MDLP=$O(^MDD(702,MDTIEN,.091,MDLP)) Q:'MDLP  D
"RTN","MDRPCOT1",14,0)
 .K DA,DIK
"RTN","MDRPCOT1",15,0)
 .S DA=+MDLP,DA(1)=+MDTIEN,DIK="^MDD(702,"_DA(1)_",.091," D ^DIK
"RTN","MDRPCOT1",16,0)
 .Q
"RTN","MDRPCOT1",17,0)
 Q
"RTN","MDRPCOT1",18,0)
 ;
"RTN","MDRPCOT1",19,0)
IMGSTAT(STUDY,MDSTAT) ; [Procedure] Update the Image Status.
"RTN","MDRPCOT1",20,0)
 N MDL
"RTN","MDRPCOT1",21,0)
 S MDL=0 F  S MDL=$O(^MDD(702,STUDY,.1,MDL)) Q:MDL<1  S $P(^(MDL,0),"^",9)=MDSTAT
"RTN","MDRPCOT1",22,0)
 Q
"RTN","MDRPCOT1",23,0)
 ;
"RTN","MDRPCOT1",24,0)
GETVSTR(DFN,MDSSTR,MDPR,MDTR) ; [Function] Check the Visit String
"RTN","MDRPCOT1",25,0)
 N MDCLOC,MDHOLD,MDLOC,MDINPT,VAIP
"RTN","MDRPCOT1",26,0)
 N MDPR12,MDAPP ; Patch 11
"RTN","MDRPCOT1",27,0)
 I '$G(MDTR) Q 0
"RTN","MDRPCOT1",28,0)
 I '$G(MDPR) Q 0
"RTN","MDRPCOT1",29,0)
 I $G(MDSSTR)="" Q 0
"RTN","MDRPCOT1",30,0)
 S VAIP("D")=MDTR ; DT of Transaction Created
"RTN","MDRPCOT1",31,0)
 D IN5^VADPT S MDINPT=$S(+VAIP(13):1,1:0)
"RTN","MDRPCOT1",32,0)
 S (MDCLOC,MDHOLD)=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDRPCOT1",33,0)
 ; Patch 11
"RTN","MDRPCOT1",34,0)
 S MDPR12=$$GET1^DIQ(702.01,+MDPR_",",.12,"I")
"RTN","MDRPCOT1",35,0)
 S:MDPR12=1 MDCLOC=""
"RTN","MDRPCOT1",36,0)
 S MDAPP=$$GET^XPAR("SYS","MD USE APPOINTMENT",1)
"RTN","MDRPCOT1",37,0)
 ; End Patch 11 code
"RTN","MDRPCOT1",38,0)
 I 'MDCLOC S MDCLOC=+$P(MDSSTR,";",3) I 'MDCLOC S MDCLOC=MDHOLD I 'MDCLOC Q 0
"RTN","MDRPCOT1",39,0)
 I +MDAPP S MDCLOC=$S(+$P(MDSSTR,";",3)>1:+$P(MDSSTR,";",3),1:MDCLOC) I 'MDCLOC Q 0
"RTN","MDRPCOT1",40,0)
 S Y=MDCLOC_";"_$P(MDSSTR,";",2)_";"_$P(MDSSTR,";")
"RTN","MDRPCOT1",41,0)
 I $P(Y,";",3)="A" Q Y
"RTN","MDRPCOT1",42,0)
 S:$P(Y,";",3)="" $P(Y,";",3)="A"
"RTN","MDRPCOT1",43,0)
 S:+MDINPT $P(Y,";",3)="A"
"RTN","MDRPCOT1",44,0)
 S:$P(Y,";",3)="V" $P(Y,";",3)="A"
"RTN","MDRPCOT1",45,0)
 Q Y
"RTN","MDRPCOT1",46,0)
 ;
"RTN","MDRPCOT1",47,0)
PDT(STUDIE) ; [Function] Loop through the attachments for Date/Time Performed.
"RTN","MDRPCOT1",48,0)
 N MDL,MDDT
"RTN","MDRPCOT1",49,0)
 S MDL=0,MDDT=""
"RTN","MDRPCOT1",50,0)
 F  S MDL=$O(^MDD(702,STUDIE,.1,MDL)) Q:'MDL  D  Q:MDDT
"RTN","MDRPCOT1",51,0)
 .S MDDT=$P($G(^MDD(702,STUDIE,.1,MDL,0)),"^",3)
"RTN","MDRPCOT1",52,0)
 I MDDT S MDDT=$P($G(^MDD(703.1,+MDDT,0)),"^",3) ; Get Date/Time Performed
"RTN","MDRPCOT1",53,0)
 ;S:'MDDT MDDT=$$NOW^XLFDT()
"RTN","MDRPCOT1",54,0)
 Q MDDT
"RTN","MDRPCOT1",55,0)
 ;
"RTN","MDRPCOT1",56,0)
SUBMIT(STUDY) ; [Function] Submit all non-pending/uncomplete images in transaction to Imaging
"RTN","MDRPCOT1",57,0)
 N DATA,DEVIEN,MDACQ,MDC,MDCRES,MDCTR,MDLOC,MDAR,MDARR,MDDT,MDFDA,MDDEL,MDIEN,MDIENS,MDIMG,MDL,MDLPB,MDMAG,MDMULT,MDR,MDST,MDX,MDY,MDZ
"RTN","MDRPCOT1",58,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDLPB=0
"RTN","MDRPCOT1",59,0)
 S DEVIEN=$P(^MDD(702,STUDY,0),U,11)
"RTN","MDRPCOT1",60,0)
 S:$$GET1^DIQ(702.09,DEVIEN_",",.14)="127.0.0.1" MDLPB=1
"RTN","MDRPCOT1",61,0)
 S MDMULT=$$MULT(+MDIEN)
"RTN","MDRPCOT1",62,0)
 S MDST=$$GET1^DIQ(702,MDIEN,.09,"I") ; I 'MDMULT&('MDLPB)&("13"[MDST) Q "-1^Study not in proper status"
"RTN","MDRPCOT1",63,0)
 I MDMULT&(MDST=1) Q "-1^Study not in proper status"
"RTN","MDRPCOT1",64,0)
 I MDMULT&(MDST=3) D STATUS^MDRPCOT(MDIENS,5,"")
"RTN","MDRPCOT1",65,0)
 D DELERR(+MDIEN)
"RTN","MDRPCOT1",66,0)
 I $$GET1^DIQ(702,MDIEN,.01)="" Q "-1^No Entry in file (#702)."
"RTN","MDRPCOT1",67,0)
 D NOW^%DTC S MDDT=%
"RTN","MDRPCOT1",68,0)
 S MDMAG("IDFN")=+$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT1",69,0)
 I 'MDMAG("IDFN") Q "-1^No Patient DFN."
"RTN","MDRPCOT1",70,0)
 S MDMAG("PXPKG")=8925
"RTN","MDRPCOT1",71,0)
 S MDMAG("PXIEN")=+$$GET1^DIQ(702,MDIEN,.06,"I")
"RTN","MDRPCOT1",72,0)
 I 'MDMAG("PXIEN") Q "-1^No TIU IEN"
"RTN","MDRPCOT1",73,0)
 I '$O(^MDD(702,MDIEN,.1,0)) D  Q $S(+MDR<0:MDR,1:"3^Transaction Complete")
"RTN","MDRPCOT1",74,0)
 .S MDC=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT1",75,0)
 .S MDR=$$UPDCONS(MDC,MDMAG("PXIEN"))
"RTN","MDRPCOT1",76,0)
 S MDMAG("STSCB")="ISTAT^MDAPI"
"RTN","MDRPCOT1",77,0)
 S MDMAG("TRKID")="CP;"_MDIEN_"-"_MDDT
"RTN","MDRPCOT1",78,0)
 S MDLOC=$$GET1^DIQ(702,MDIEN,.07,"I"),MDLOC=$P(MDLOC,";",3)
"RTN","MDRPCOT1",79,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT1",80,0)
 S MDMAG("ACQS")=$S(+$$GET1^DIQ(44,MDLOC_",",3,"I"):+$$GET1^DIQ(44,MDLOC_",",3,"I"),1:+$G(DUZ(2)))
"RTN","MDRPCOT1",81,0)
 S MDMAG("ACQL")=MDLOC
"RTN","MDRPCOT1",82,0)
 S MDX=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT1",83,0)
 S MDZ=$P(^MDS(702.01,+MDX,0),"^",1)
"RTN","MDRPCOT1",84,0)
 S (MDACQ,MDX,MDDEL)="",MDCTR=0
"RTN","MDRPCOT1",85,0)
 N MDTOT S MDTOT=$$GET1^DIQ(702,MDIENS,.991)
"RTN","MDRPCOT1",86,0)
 S MDL=0 F  S MDL=$O(^MDD(702,MDIEN,.1,MDL)) Q:MDL<1  S MDX=$G(^(MDL,0)) D
"RTN","MDRPCOT1",87,0)
 .S:'MDDEL MDDEL=$P(MDX,"^",3)
"RTN","MDRPCOT1",88,0)
 .S MDY=$G(^MDD(702,MDIEN,.1,MDL,.1)) Q:MDY=""
"RTN","MDRPCOT1",89,0)
 .S:MDACQ="" MDACQ=$P($P(MDY,"\\",2),"\")
"RTN","MDRPCOT1",90,0)
 .S:"12"[$P(MDX,"^",9) $P(MDX,"^",9)=""
"RTN","MDRPCOT1",91,0)
 .I $P(MDX,"^",9)="" S MDCTR=MDCTR+1,MDARR(MDCTR)=MDY_"^"_MDZ_" image "_MDCTR_" out of "_MDTOT
"RTN","MDRPCOT1",92,0)
 .Q
"RTN","MDRPCOT1",93,0)
 I '$O(MDARR(0)) Q "-1^No UNC."
"RTN","MDRPCOT1",94,0)
 S MDMAG("GDESC")=MDZ_" Result"
"RTN","MDRPCOT1",95,0)
 I MDDEL S MDY=$P($G(^MDD(703.1,+MDDEL,0)),"^",3,4),MDMAG("PXDT")=$P(MDY,"^",1),MDY=+$P(MDY,"^",2),MDMAG("ACQD")=$P($G(^MDS(702.09,+MDY,0)),"^"),MDMAG("DFLG")=+$P($G(^MDS(702.09,+MDY,0)),"^",5)
"RTN","MDRPCOT1",96,0)
 S:$G(MDMAG("ACQD"))="" MDMAG("ACQD")=MDACQ
"RTN","MDRPCOT1",97,0)
 S:'$G(MDMAG("PXDT")) MDMAG("PXDT")=MDDT ; If no date, use NOW in MDDT
"RTN","MDRPCOT1",98,0)
 S MDMAG("TRTYPE")="NEW"
"RTN","MDRPCOT1",99,0)
 D IMPORT^MAGGSIUI(.MDIMG,.MDARR,.MDMAG)
"RTN","MDRPCOT1",100,0)
 I '(+$G(MDIMG(0))) D  Q "-1^"_$P(MDIMG(0),"^",2)
"RTN","MDRPCOT1",101,0)
 .D IMGSTAT(+MDIENS,1)
"RTN","MDRPCOT1",102,0)
 .F MDAR=0:0 S MDAR=$O(MDIMG(MDAR)) Q:'MDAR  I $G(MDIMG(MDAR))'="" D
"RTN","MDRPCOT1",103,0)
 ..S DATA("MESSAGE")=$$TRANS^MDAPI(MDIMG(MDAR)) D ADDMSG^MDRPCOT
"RTN","MDRPCOT1",104,0)
 D IMGSTAT(+MDIENS,0)
"RTN","MDRPCOT1",105,0)
 Q "1^Images Submitted"
"RTN","MDRPCOT1",106,0)
 ;
"RTN","MDRPCOT1",107,0)
UPDCONS(MDC,MDDOC) ; [Function] Update Consults Procedure Status
"RTN","MDRPCOT1",108,0)
 N MDCRES,MDKK,MDSDY,MDPDEF,MDF,MDH,MDX3,MDX4,MDXC,MDXD S (MDF,MDXD)=0,MDX4=""
"RTN","MDRPCOT1",109,0)
 D GETLST^XPAR(.MDH,"SYS","MD GET HIGH VOLUME")
"RTN","MDRPCOT1",110,0)
 S MDSDY=$O(^MDD(702,"ACON",MDC,""),-1) Q:'+MDSDY 1
"RTN","MDRPCOT1",111,0)
 S MDPDEF=+$P($G(^MDD(702,+MDSDY,0)),"^",4) Q:'+MDPDEF 1
"RTN","MDRPCOT1",112,0)
 F MDKK=0:0 S MDKK=$O(MDH(MDKK)) Q:MDKK<1  I $P($G(MDH(MDKK)),"^")=+MDPDEF S MDF=1 Q
"RTN","MDRPCOT1",113,0)
 I $P($G(^MDS(702.01,+MDPDEF,0)),U,6)=2 Q 1
"RTN","MDRPCOT1",114,0)
 D GETS^DIQ(123,MDC_",","50*","I","MDXC")
"RTN","MDRPCOT1",115,0)
 S MDX3="" F  S MDX3=$O(MDXC(123.03,MDX3)) Q:MDX3<1  S MDX4=$G(MDXC(123.03,MDX3,.01,"I")) I MDX4["TIU" S:+MDX4=+$P($G(^MDD(702,+MDSDY,0)),"^",6) MDXD=1 Q
"RTN","MDRPCOT1",116,0)
 I +$P($G(^MDS(702.01,+MDPDEF,0)),U,10)!(+MDF) Q:+MDXD 1
"RTN","MDRPCOT1",117,0)
 S MDCRES=$$CPDOC^GMRCCP(MDC,MDDOC,2)
"RTN","MDRPCOT1",118,0)
 I '(+MDCRES) Q "-1^"_$P(MDCRES,"^",2)
"RTN","MDRPCOT1",119,0)
 Q 1
"RTN","MDRPCOT1",120,0)
 ;
"RTN","MDRPCOT1",121,0)
GETIORD(MDIEN) ; [Function] Return the Instrument order number for this study
"RTN","MDRPCOT1",122,0)
 ; Called from instrument interface routines
"RTN","MDRPCOT1",123,0)
 Q:'$D(^MDD(702,MDIEN,0))#2 -1  ; No such study
"RTN","MDRPCOT1",124,0)
 Q:'$P(^MDD(702,MDIEN,0),U,12) $$NEWIORD(MDIEN)  ; Create a new one
"RTN","MDRPCOT1",125,0)
 Q $P(^MDD(702,MDIEN,0),U,12)  ; Return the existing one
"RTN","MDRPCOT1",126,0)
 ;
"RTN","MDRPCOT1",127,0)
NEWIORD(MDIEN) ; [Function] Generate & return new unique instrument order number
"RTN","MDRPCOT1",128,0)
 ; Notice: will overwrite existing order number if it exists
"RTN","MDRPCOT1",129,0)
 N MDFDA
"RTN","MDRPCOT1",130,0)
 Q:'$D(^MDD(702,MDIEN,0))#2 -1  ; No such study
"RTN","MDRPCOT1",131,0)
 L +^MDD(702,"AION"):15 E  Q -1  ; Unable to lock and guarantee uniqueness
"RTN","MDRPCOT1",132,0)
 F  D  Q:'$D(^MDD(702,"AION",X))  H 1  ; Loop until unique
"RTN","MDRPCOT1",133,0)
 . S X=$$NOW^XLFDT() ; Current DateTime
"RTN","MDRPCOT1",134,0)
 . S X=$TR($J(X,14,6),".","") ; Pad with 0's and strip the decimal
"RTN","MDRPCOT1",135,0)
 . Q
"RTN","MDRPCOT1",136,0)
 I $E($G(^MDS(702.09,DEVIEN,0)),1,4)="Muse" D
"RTN","MDRPCOT1",137,0)
 . ; Due to current limitation to the Muse can only except 9
"RTN","MDRPCOT1",138,0)
 . S X=$E($TR($H,",",""),2,10) ; Using $E($H) only for the MUSE
"RTN","MDRPCOT1",139,0)
 . I '$D(^MDD(702,"AION",X)) Q  ; It is unique and quit
"RTN","MDRPCOT1",140,0)
 . N I,FLG ; Not unique
"RTN","MDRPCOT1",141,0)
 . S FLG=0
"RTN","MDRPCOT1",142,0)
 . F I=1:1 D  Q:FLG
"RTN","MDRPCOT1",143,0)
 . . S X=X+1
"RTN","MDRPCOT1",144,0)
 . . I '$D(^MDD(702,"AION",X)) S FLG=1
"RTN","MDRPCOT1",145,0)
 . . Q
"RTN","MDRPCOT1",146,0)
 . Q
"RTN","MDRPCOT1",147,0)
 S MDFDA(702,MDIEN_",",.12)=X  ; Build FDA
"RTN","MDRPCOT1",148,0)
 D FILE^DIE("","MDFDA")  ; File it
"RTN","MDRPCOT1",149,0)
 L -(^MDD(702,"AION"))  ; Unlock it
"RTN","MDRPCOT1",150,0)
 Q $P(^MDD(702,MDIEN,0),U,12)  ; Return it from the file
"RTN","MDRPCOT1",151,0)
GETSTDY(MDION) ; [Function] Return study from instrument order number
"RTN","MDRPCOT1",152,0)
 ; Called from instrument interface routines
"RTN","MDRPCOT1",153,0)
 Q:'$D(^MDD(702,"AION",MDION)) ""  ; No such order number
"RTN","MDRPCOT1",154,0)
 Q $O(^MDD(702,"AION",MDION,""),-1) ; Return the 702 ien
"RTN","MDRPCOT1",155,0)
 ;
"RTN","MDRPCOT1",156,0)
MULT(MDIN) ; [Function] Return whether result is mulitple or final
"RTN","MDRPCOT1",157,0)
 N MDDEF
"RTN","MDRPCOT1",158,0)
 S MDDEF=+$$GET1^DIQ(702,MDIN,.04,"I")
"RTN","MDRPCOT1",159,0)
 I 'MDDEF Q 0
"RTN","MDRPCOT1",160,0)
 Q +$$GET1^DIQ(702.01,MDDEF,.12,"I")
"RTN","MDRPCOT2")
0^23^B44563560^B41546824
"RTN","MDRPCOT2",1,0)
MDRPCOT2 ; HOIFO/NCA - Object RPCs (TMDTransaction) Continued 2;10/29/04  12:20 ;3/12/08  09:18
"RTN","MDRPCOT2",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21**;Apr 01, 2004;Build 30
"RTN","MDRPCOT2",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT2",4,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDRPCOT2",5,0)
 ; IA# 3468 [Subscription] GMRCCP API.
"RTN","MDRPCOT2",6,0)
 ; IA# 3535 [Subscription] Calls to TIUSRVP.
"RTN","MDRPCOT2",7,0)
 ; IA# 4795 [Subscription] Calls to TIUSRVP2.
"RTN","MDRPCOT2",8,0)
 ; IA# 5407 [Subscription] Call routine ORWTPN.
"RTN","MDRPCOT2",9,0)
ADDMSG ; [Procedure] Add message to transaction
"RTN","MDRPCOT2",10,0)
 N MDIEN,MDIENS,MDRET
"RTN","MDRPCOT2",11,0)
 Q:'$G(DATA("TRANSACTION"))
"RTN","MDRPCOT2",12,0)
 Q:$G(DATA("MESSAGE"))=""
"RTN","MDRPCOT2",13,0)
 S MDIEN=+DATA("TRANSACTION"),MDIENS="+1,"_MDIEN_","
"RTN","MDRPCOT2",14,0)
 D NOW^%DTC S DATA("DATE")=%
"RTN","MDRPCOT2",15,0)
 S MDFDA(702.091,MDIENS,.01)=+$O(^MDD(702,+MDIEN,.091,"A"),-1)+1
"RTN","MDRPCOT2",16,0)
 S MDFDA(702.091,MDIENS,.02)=DATA("DATE")
"RTN","MDRPCOT2",17,0)
 S MDFDA(702.091,MDIENS,.03)=$G(DATA("PKG"),"UNKNOWN")
"RTN","MDRPCOT2",18,0)
 S MDFDA(702.091,MDIENS,.09)=DATA("MESSAGE")
"RTN","MDRPCOT2",19,0)
 D UPDATE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOT2",20,0)
 Q
"RTN","MDRPCOT2",21,0)
 ;
"RTN","MDRPCOT2",22,0)
FILEMSG(STUDY,MDPKG,MDSTAT,MDMSG) ; [Procedure] File Study Status and Message.
"RTN","MDRPCOT2",23,0)
 S DATA("TRANSACTION")=STUDY,DATA("PKG")=MDPKG
"RTN","MDRPCOT2",24,0)
 S DATA("MESSAGE")=$P(MDMSG,"^",2)
"RTN","MDRPCOT2",25,0)
 D STATUS(STUDY_",",MDSTAT,$P(MDMSG,"^",2)),ADDMSG
"RTN","MDRPCOT2",26,0)
 Q
"RTN","MDRPCOT2",27,0)
 ;
"RTN","MDRPCOT2",28,0)
STATUS(MDIENS,MDSTAT,MDMSG) ; [Procedure] Update transaction status
"RTN","MDRPCOT2",29,0)
 S MDFDA(702,MDIENS,.08)=$G(MDMSG)
"RTN","MDRPCOT2",30,0)
 S MDFDA(702,MDIENS,.09)=MDSTAT
"RTN","MDRPCOT2",31,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT2",32,0)
 Q
"RTN","MDRPCOT2",33,0)
 ;
"RTN","MDRPCOT2",34,0)
SUBMIT(MDDATA,MDESIG,MDG1) ; [Procedure] Process the Image(s) Submission.
"RTN","MDRPCOT2",35,0)
 ; Input: MDDATA - Study ID
"RTN","MDRPCOT2",36,0)
 ;        MDESIG - Electronic Signature
"RTN","MDRPCOT2",37,0)
 ;        MDG1 - ^TMP global with the text of the report
"RTN","MDRPCOT2",38,0)
 ; Output: -1^Error Message or
"RTN","MDRPCOT2",39,0)
 ;          1^Successful Message
"RTN","MDRPCOT2",40,0)
 N MDRESUL,MDSTUDY,MDG2,RES
"RTN","MDRPCOT2",41,0)
 S MDSTUDY=+MDDATA,(RES,MDRESUL)=""
"RTN","MDRPCOT2",42,0)
 ; Create New TIU Document
"RTN","MDRPCOT2",43,0)
 S MDRESUL=$$NEWTIUN(MDSTUDY)
"RTN","MDRPCOT2",44,0)
 ;S MDRESUL=$$NEWTIUN(MDSTUDY)
"RTN","MDRPCOT2",45,0)
 ; File TIU Error messages
"RTN","MDRPCOT2",46,0)
 ;I +MDRESUL<0 D FILEMSG(MDSTUDY,"TIU",2,MDRESUL) Q MDRESUL
"RTN","MDRPCOT2",47,0)
 I +MDRESUL<0 D  Q RES
"RTN","MDRPCOT2",48,0)
 .D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCOT2",49,0)
 .S RES=MDRESUL
"RTN","MDRPCOT2",50,0)
 ; Update the text of the TIU document
"RTN","MDRPCOT2",51,0)
 S MDG2=@($NA(MDG1))
"RTN","MDRPCOT2",52,0)
 I +$O(@MDG2@(""),-1) D  Q:RES'="" RES
"RTN","MDRPCOT2",53,0)
 .S MDRESUL=$$UPDATE(MDSTUDY,MDESIG,MDG2)
"RTN","MDRPCOT2",54,0)
 .I +MDRESUL<0 D  Q
"RTN","MDRPCOT2",55,0)
 ..D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCOT2",56,0)
 ..S RES=MDRESUL
"RTN","MDRPCOT2",57,0)
 ; Submit and export the images
"RTN","MDRPCOT2",58,0)
 ;S MDRESUL=$$SUBMIT^MDRPCOT1(MDSTUDY)
"RTN","MDRPCOT2",59,0)
 ; File message
"RTN","MDRPCOT2",60,0)
 ;D FILEMSG(MDSTUDY,"IMAGING",$S(+MDRESUL>0:+MDRESUL,1:2),MDRESUL)
"RTN","MDRPCOT2",61,0)
 S RES=MDRESUL
"RTN","MDRPCOT2",62,0)
 Q RES
"RTN","MDRPCOT2",63,0)
 ;
"RTN","MDRPCOT2",64,0)
GETDATA(STUDY) ; [Function] Return the Necessary data for creating a TIU note.
"RTN","MDRPCOT2",65,0)
 ; Return: Patient DFN_"^"_TIU title_"^"_Hospital Location_"^"_TIU Note
"RTN","MDRPCOT2",66,0)
 ;         IEN_"^"_Consult #_"^"_CP Definition IEN_"^"_Visit String_"^"
"RTN","MDRPCOT2",67,0)
 ;         New Visit Flag
"RTN","MDRPCOT2",68,0)
 ;         or
"RTN","MDRPCOT2",69,0)
 ;         -1^Error Message
"RTN","MDRPCOT2",70,0)
 N DFN,MDCON,MDFN,MDIEN,MDIENS,MDLOC,MDNEWV,MDNOTE,MDNVST,MDPROC,MDVSTR,MDTITL,MDX,MDTST
"RTN","MDRPCOT2",71,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDNVST=0
"RTN","MDRPCOT2",72,0)
 I $$GET1^DIQ(702,MDIENS,.01)="" Q "-1^No such study entry."
"RTN","MDRPCOT2",73,0)
 ; Get DFN
"RTN","MDRPCOT2",74,0)
 S DFN=$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT2",75,0)
 I 'DFN Q "-1^No DFN."
"RTN","MDRPCOT2",76,0)
 ; Get CP Def
"RTN","MDRPCOT2",77,0)
 S MDPROC=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT2",78,0)
 I 'MDPROC Q "-1^No CP Def."
"RTN","MDRPCOT2",79,0)
 ; Get Consult
"RTN","MDRPCOT2",80,0)
 S MDCON=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT2",81,0)
 I 'MDCON Q "-1^No Consult #."
"RTN","MDRPCOT2",82,0)
 ; Get TIU Note Title
"RTN","MDRPCOT2",83,0)
 S MDTITL=$$GET1^DIQ(702.01,+MDPROC_",",.04,"I")
"RTN","MDRPCOT2",84,0)
 I 'MDTITL Q "-1^No TIU Note Title."
"RTN","MDRPCOT2",85,0)
 S MDVSTR=$$GET1^DIQ(702,MDIEN,.07)
"RTN","MDRPCOT2",86,0)
 I MDVSTR=""  Q "-1^No Visit String."
"RTN","MDRPCOT2",87,0)
 I $L(MDVSTR,";")=1 S MDNVST=1,MDVSTR=";"_MDVSTR ; If new visit is selected
"RTN","MDRPCOT2",88,0)
 ; MDLOC is Hospital Location
"RTN","MDRPCOT2",89,0)
 I MDVSTR'="" D
"RTN","MDRPCOT2",90,0)
 .S MDVSTR=$$GETVSTR^MDRPCOT1(DFN,MDVSTR,MDPROC,$$GET1^DIQ(702,MDIEN,.02,"I"))
"RTN","MDRPCOT2",91,0)
 .S MDLOC=$P(MDVSTR,";",1)
"RTN","MDRPCOT2",92,0)
 ; Does TIU doc already exist?
"RTN","MDRPCOT2",93,0)
 S MDNOTE=""
"RTN","MDRPCOT2",94,0)
 I $$GET1^DIQ(702,MDIEN,.06,"I") Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+$$GET1^DIQ(702,MDIEN,.06,"I")_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT2",95,0)
 ; Does TIU doc exist for previous transaction of this consult?
"RTN","MDRPCOT2",96,0)
 ;I MDCON S MDNOTE=$$PREV(MDCON,MDIEN)
"RTN","MDRPCOT2",97,0)
 Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+MDNOTE_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT2",98,0)
 ;
"RTN","MDRPCOT2",99,0)
NEWTIUN(STUDY) ; [Function] Create a new TIU for transaction
"RTN","MDRPCOT2",100,0)
 ; Input: STUDY - IENS of CP study entry
"RTN","MDRPCOT2",101,0)
 ; Return: TIU Document IEN
"RTN","MDRPCOT2",102,0)
 N CTR,DFN,MDCON,MDCONRS,MDFDA,MDGST,MDL,MDLOC,MDNOTE,MDPDT,MDPROC,MDPT,MDRESU,MDTITL,MDTSTR,MDVST,MDVSTR,MDWP S CTR=0,MDGST=+STUDY,MDRESU=""
"RTN","MDRPCOT2",103,0)
 ; Get data for TIU Note Creation
"RTN","MDRPCOT2",104,0)
 S (MDTSTR,MDRESU)=$$GETDATA(MDGST)
"RTN","MDRPCOT2",105,0)
 ; File Error message
"RTN","MDRPCOT2",106,0)
 I +MDRESU<0 D FILEMSG(MDGST,"CP",2,MDRESU) Q MDRESU
"RTN","MDRPCOT2",107,0)
 I $G(MDTSTR)="" Q "-1^No Data to Create TIU Document"
"RTN","MDRPCOT2",108,0)
 F MDL="DFN","MDTITL","MDLOC","MDNOTE","MDCON","MDPROC","MDVSTR","MDNVST" D
"RTN","MDRPCOT2",109,0)
 .S CTR=CTR+1,@MDL=$P(MDTSTR,"^",CTR)
"RTN","MDRPCOT2",110,0)
 S (MDVST,MDRESU)=""
"RTN","MDRPCOT2",111,0)
 ; If previous TIU document exists, quit
"RTN","MDRPCOT2",112,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT2",113,0)
 I MDNOTE Q MDNOTE
"RTN","MDRPCOT2",114,0)
 ; Create new visit, if no vstring
"RTN","MDRPCOT2",115,0)
 S MDPDT=$$PDT^MDRPCOT1(MDGST)
"RTN","MDRPCOT2",116,0)
 I 'MDPDT S MDPT=$O(^MDD(703.1,"ASTUDYID",+MDGST,""),-1),MDPDT=$P($G(^MDD(703.1,+MDPT,0)),U,3)
"RTN","MDRPCOT2",117,0)
 S:'MDPDT MDPDT=$P(MDVSTR,";",2) ; If No D/T Performed grab visit D/T
"RTN","MDRPCOT2",118,0)
 ; Build variables for TIU Call
"RTN","MDRPCOT2",119,0)
 S MDWP(.05)=1 ; Undictated Status
"RTN","MDRPCOT2",120,0)
 S MDWP(1405)=+MDCON_";GMR(123," ; Package Reference
"RTN","MDRPCOT2",121,0)
 S MDWP(70201)=5 ; Default Procedure Summary Code "Machine Resulted"
"RTN","MDRPCOT2",122,0)
 I MDPDT S MDWP(70202)=MDPDT ; Date/Time Performed
"RTN","MDRPCOT2",123,0)
 ; File PCE Error message
"RTN","MDRPCOT2",124,0)
 S MDRESU=$$EN1^MDPCE(MDGST,$P(MDVSTR,";",2),(MDPROC_"^"_MDLOC),$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU,MDVSTR=$P(MDRESU,"^",2)
"RTN","MDRPCOT2",125,0)
 ;I MDNVST S MDRESU=$$EN1^MDPCE1(MDGST,MDPDT,MDPROC,$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU,MDVSTR=$P(MDRESU,"^",2)
"RTN","MDRPCOT2",126,0)
 ;I 'MDNVST S MDVST=$P($G(^MDD(702,+MDGST,1)),U) I 'MDVST S MDRESU=$$EN1^MDPCE(MDGST,MDPDT,(MDPROC_"^"_MDLOC),$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU
"RTN","MDRPCOT2",127,0)
 ;I 'MDNVST&$$CHK^MDPCE1(MDGST) S MDRESU=$$EN1^MDPCE1(MDGST,MDPDT,MDPROC,$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU
"RTN","MDRPCOT2",128,0)
 I +MDRESU<0 D FILEMSG(MDGST,"PCE",2,$P(MDRESU,"^",2)) Q MDRESU
"RTN","MDRPCOT2",129,0)
 ; Create the TIU note stub
"RTN","MDRPCOT2",130,0)
 S MDVST="" S MDVST=+$G(^MDD(702,MDGST,1))
"RTN","MDRPCOT2",131,0)
 S MDNOTE="" D MAKE^TIUSRVP(.MDNOTE,DFN,MDTITL,$P(MDVSTR,";",2),MDLOC,$S(MDVST:MDVST,1:""),.MDWP,MDVSTR,1,1)
"RTN","MDRPCOT2",132,0)
 I '(+MDNOTE) S $P(MDNOTE,"^")=-1 Q MDNOTE
"RTN","MDRPCOT2",133,0)
 ; Finalize the transaction
"RTN","MDRPCOT2",134,0)
 S MDFDA(702,STUDY_",",.06)=+MDNOTE
"RTN","MDRPCOT2",135,0)
 S MDFDA(702,STUDY_",",.08)=""
"RTN","MDRPCOT2",136,0)
 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDRPCOT2",137,0)
 D UPD^MDKUTLR(STUDY,+MDNOTE)
"RTN","MDRPCOT2",138,0)
 S MDCONRS=$$CPDOC^GMRCCP(+MDCON,+MDNOTE,2)
"RTN","MDRPCOT2",139,0)
 Q 1
"RTN","MDRPCOT2",140,0)
 ;
"RTN","MDRPCOT2",141,0)
UPDATE(STUDY,SIGN,MDGLB) ; Update the TIU document with the text
"RTN","MDRPCOT2",142,0)
 N MDK,MDNOTE,MDPPR,MDRESU,MDS,MDTI,MDTIUER,MDWP,MDV,MDV1,MDVAU S (MDNOTE,MDTIUER)="" K MDWP,^TMP("MDTIUST",$J)
"RTN","MDRPCOT2",143,0)
 F MDK=0:0 S MDK=$O(@MDGLB@(MDK)) Q:'MDK  S MDWP("TEXT",MDK,0)=$G(@MDGLB@(MDK))
"RTN","MDRPCOT2",144,0)
 S MDTI=$$GET1^DIQ(702,STUDY_",",.06,"I") Q:'MDTI "-1^No Note."
"RTN","MDRPCOT2",145,0)
 S MDWP(.05)=5
"RTN","MDRPCOT2",146,0)
 S MDWP(1202)=DUZ
"RTN","MDRPCOT2",147,0)
 D GETDCOS^ORWTPN(.MDVAU,DUZ)
"RTN","MDRPCOT2",148,0)
 I +MDVAU S MDWP(1506)=1,MDWP(1208)=+MDVAU
"RTN","MDRPCOT2",149,0)
 D UPDATE^TIUSRVP(.MDNOTE,+MDTI,.MDWP,1)
"RTN","MDRPCOT2",150,0)
 I '+MDNOTE S MDNOTE="-1^"_$P(MDNOTE,"^",2) Q MDNOTE
"RTN","MDRPCOT2",151,0)
 ; Sign TIU Document
"RTN","MDRPCOT2",152,0)
 S MDS=$$SIGN(MDTI,SIGN) I MDS<0 Q MDS
"RTN","MDRPCOT2",153,0)
 ;N MDFDA S MDFDA(704.202,STUDY_",",.09)=0
"RTN","MDRPCOT2",154,0)
 S $P(^MDK(704.202,STUDY,0),"^",9)=0
"RTN","MDRPCOT2",155,0)
 ;D FILE^DIE("","MDFDA")
"RTN","MDRPCOT2",156,0)
 N MDFDA S MDFDA(702,STUDY_",",.09)=3
"RTN","MDRPCOT2",157,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT2",158,0)
 K ^MDK(704.202,"AS",1,STUDY)
"RTN","MDRPCOT2",159,0)
 S ^MDK(704.202,"AS",0,STUDY)=""
"RTN","MDRPCOT2",160,0)
 Q 1
"RTN","MDRPCOT2",161,0)
SIGN(MDTIUIN,MDSIGN) ; Sign the TIU Document
"RTN","MDRPCOT2",162,0)
 ; [Function] TIU SIGN RECORD
"RTN","MDRPCOT2",163,0)
 ;Input Parameters:
"RTN","MDRPCOT2",164,0)
 ;   1.  TIUIEN [Literal/Required] TIU internal Entry Number
"RTN","MDRPCOT2",165,0)
 ;   2.  MDSIGN [Literal/Required] User Signature
"RTN","MDRPCOT2",166,0)
 N MDSRES,X
"RTN","MDRPCOT2",167,0)
 S MDSRES=""
"RTN","MDRPCOT2",168,0)
 D SIGN^TIUSRVP2(.MDSRES,MDTIUIN,MDSIGN)
"RTN","MDRPCOT2",169,0)
 I +MDSRES>0 Q "-1^"_$P(MDSRES,"^",2)
"RTN","MDRPCOT2",170,0)
 Q 1
"RTN","MDRPCOT2",171,0)
 ;
"RTN","MDRPCOT2",172,0)
PREV(MDC,MDS) ; [Function] Return the Previous TIU document.
"RTN","MDRPCOT2",173,0)
 N MDNEWV,MDDOC,MDTRAN,MDTIUER,MDTST
"RTN","MDRPCOT2",174,0)
 S (MDDOC,MDNEWV,MDTRAN,MDTIUER,MDTST)="" K ^TMP("MDTIUST",$J)
"RTN","MDRPCOT2",175,0)
 F  S MDTRAN=$O(^MDD(702,"ACON",MDC,MDTRAN)) Q:'MDTRAN  D  Q:'MDTRAN
"RTN","MDRPCOT2",176,0)
 .I $P(^MDD(702,MDTRAN,0),U,6) D
"RTN","MDRPCOT2",177,0)
 ..D EXTRACT^TIULQ($P(^MDD(702,MDTRAN,0),U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;1406") Q:+MDTIUER
"RTN","MDRPCOT2",178,0)
 ..S MDTST=$G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),.05,"E"))
"RTN","MDRPCOT2",179,0)
 ..I MDTST'="UNDICTATED"&(MDTST'="UNSIGNED") K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT2",180,0)
 ..I MDTST="UNSIGNED"&'($G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),1406,"I"))) K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT2",181,0)
 ..S MDDOC=$P(^MDD(702,MDTRAN,0),U,6),MDNEWV=$P(^MDD(702,MDTRAN,0),U,7)
"RTN","MDRPCOT2",182,0)
 ..Q:'MDS
"RTN","MDRPCOT2",183,0)
 ..S MDFDA(702,MDS_",",.06)=MDDOC
"RTN","MDRPCOT2",184,0)
 ..S MDFDA(702,MDS_",",.07)=MDNEWV
"RTN","MDRPCOT2",185,0)
 ..D FILE^DIE("","MDFDA")
"RTN","MDRPCOT2",186,0)
 ..S MDTRAN=""
"RTN","MDRPCOT2",187,0)
 Q MDDOC
"RTN","MDRPCOTH")
0^24^B22669741^n/a
"RTN","MDRPCOTH",1,0)
MDRPCOTH ; HOIFO/NCA - Process High Volume Procedure Results ;2/27/09  10:08
"RTN","MDRPCOTH",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDRPCOTH",3,0)
 ; Integration Agreements:
"RTN","MDRPCOTH",4,0)
 ; IA# 2263 [Supported] Calls to XPAR.
"RTN","MDRPCOTH",5,0)
 ; IA# 3468 [Subscription] GMRCCP API.
"RTN","MDRPCOTH",6,0)
 ; IA# 3535 [Subscription] Calls to TIUSRVP.
"RTN","MDRPCOTH",7,0)
 ; IA# 4508 [Subscription] Call to TIUSRVPT.
"RTN","MDRPCOTH",8,0)
 ; IA# 10060 [Supported] Access to NEW PERSON file (#200).
"RTN","MDRPCOTH",9,0)
 ; IA# 10104 [Supported] Routine XLFSTR calls
"RTN","MDRPCOTH",10,0)
 ;
"RTN","MDRPCOTH",11,0)
ADDMSG ; [Procedure] Add message to transaction
"RTN","MDRPCOTH",12,0)
 N MDIEN,MDIENS,MDRET
"RTN","MDRPCOTH",13,0)
 Q:'$G(DATA("TRANSACTION"))
"RTN","MDRPCOTH",14,0)
 Q:$G(DATA("MESSAGE"))=""
"RTN","MDRPCOTH",15,0)
 S MDIEN=+DATA("TRANSACTION"),MDIENS="+1,"_MDIEN_","
"RTN","MDRPCOTH",16,0)
 D NOW^%DTC S DATA("DATE")=% K %
"RTN","MDRPCOTH",17,0)
 S MDFDA(702.091,MDIENS,.01)=+$O(^MDD(702,+MDIEN,.091,"A"),-1)+1
"RTN","MDRPCOTH",18,0)
 S MDFDA(702.091,MDIENS,.02)=DATA("DATE")
"RTN","MDRPCOTH",19,0)
 S MDFDA(702.091,MDIENS,.03)=$G(DATA("PKG"),"UNKNOWN")
"RTN","MDRPCOTH",20,0)
 S MDFDA(702.091,MDIENS,.09)=DATA("MESSAGE")
"RTN","MDRPCOTH",21,0)
 D UPDATE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOTH",22,0)
 Q
"RTN","MDRPCOTH",23,0)
FILEMSG(STUDY,MDPKG,MDSTAT,MDMSG) ; [Procedure] File Study Status and Message.
"RTN","MDRPCOTH",24,0)
 N DATA
"RTN","MDRPCOTH",25,0)
 S DATA("TRANSACTION")=STUDY,DATA("PKG")=MDPKG
"RTN","MDRPCOTH",26,0)
 S DATA("MESSAGE")=$P(MDMSG,"^",2)
"RTN","MDRPCOTH",27,0)
 D STATUS(STUDY_",",MDSTAT,$P(MDMSG,"^",2)),ADDMSG
"RTN","MDRPCOTH",28,0)
 Q
"RTN","MDRPCOTH",29,0)
 ;
"RTN","MDRPCOTH",30,0)
NEWSTAT ; [Procedure] RPC Call to set status
"RTN","MDRPCOTH",31,0)
 S MDFDA(702,DATA,.09)=TYPE
"RTN","MDRPCOTH",32,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOTH",33,0)
 I TYPE=3&($G(^MDK(704.202,+DATA,0))'="") K MDFDA S MDFDA(704.202,DATA,.09)=0 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDRPCOTH",34,0)
 Q
"RTN","MDRPCOTH",35,0)
 ;
"RTN","MDRPCOTH",36,0)
STATUS(MDIENS,MDSTAT,MDMSG) ; [Procedure] Update transaction status
"RTN","MDRPCOTH",37,0)
 S MDFDA(702,MDIENS,.08)=$G(MDMSG)
"RTN","MDRPCOTH",38,0)
 S MDFDA(702,MDIENS,.09)=MDSTAT
"RTN","MDRPCOTH",39,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOTH",40,0)
 Q
"RTN","MDRPCOTH",41,0)
 ;
"RTN","MDRPCOTH",42,0)
NEWTIUN(STUDY,RECID) ; [Function] Create a new TIU for transaction
"RTN","MDRPCOTH",43,0)
 ; Input: STUDY - IENS of CP study entry
"RTN","MDRPCOTH",44,0)
 ; Return: TIU Document IEN
"RTN","MDRPCOTH",45,0)
 N CTR,DFN,MDADD,MDCON,MDCONRS,MDCT,MDDAR,MDFDA,MDGST,MDL,MDLOC,MDNOTE,MDPDT,MDPROC,MDRESU,MDTI,MDTCHK,MDTITL,MDTRE,MDTSTR,MDNVST,MDVST,MDVSTR,MDWPA,MDPT,MDR,MDRP,MDRST,MDTX,MDUSR
"RTN","MDRPCOTH",46,0)
 N MDHLS,MDHLS1,MDKK,MDX0
"RTN","MDRPCOTH",47,0)
 S CTR=0,MDGST=+STUDY,MDRESU=""
"RTN","MDRPCOTH",48,0)
 K ^TMP("MDDAR",$J) N MDDAR2,GLOARR,MDMUS S MDMUS=0
"RTN","MDRPCOTH",49,0)
 ; Get data for TIU Note Creation
"RTN","MDRPCOTH",50,0)
 S (MDTSTR,MDRESU)=$$GETDATA^MDRPCOT(MDGST)
"RTN","MDRPCOTH",51,0)
 ; File Error message
"RTN","MDRPCOTH",52,0)
 I +MDRESU<0 D FILEMSG(MDGST,"CP",2,MDRESU) Q MDRESU
"RTN","MDRPCOTH",53,0)
 I $G(MDTSTR)="" Q "-1^No Data to Create TIU Document"
"RTN","MDRPCOTH",54,0)
 F MDL="DFN","MDTITL","MDLOC","MDNOTE","MDCON","MDPROC","MDVSTR","MDNVST" D
"RTN","MDRPCOTH",55,0)
 .S CTR=CTR+1,@MDL=$P(MDTSTR,"^",CTR)
"RTN","MDRPCOTH",56,0)
 S MDVST=""
"RTN","MDRPCOTH",57,0)
 ; If previous TIU document exists, quit
"RTN","MDRPCOTH",58,0)
 I MDNOTE Q MDNOTE
"RTN","MDRPCOTH",59,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOTH",60,0)
 S MDUSR=$$FIND1^DIC(200,,"X","CLINICAL,DEVICE PROXY SERVICE","B")
"RTN","MDRPCOTH",61,0)
 ; Create new visit, if no vstring
"RTN","MDRPCOTH",62,0)
 S MDPDT=$$PDT^MDRPCOT1(MDGST)
"RTN","MDRPCOTH",63,0)
 I 'MDPDT S MDPT=$O(^MDD(703.1,"ASTUDYID",+MDGST,""),-1),MDPDT=$P($G(^MDD(703.1,+MDPT,0)),U,3)
"RTN","MDRPCOTH",64,0)
 S:'MDPDT MDPDT=$P(MDVSTR,";",2) ; If No D/T Performed grab visit D/T
"RTN","MDRPCOTH",65,0)
 I $P(MDVSTR,";",3)="V" S $P(MDVSTR,";",3)="A"
"RTN","MDRPCOTH",66,0)
 ; Build variables for TIU Call
"RTN","MDRPCOTH",67,0)
 S MDWPA(.05)=1 ; Undicated Status
"RTN","MDRPCOTH",68,0)
 S MDWPA(1405)=+MDCON_";GMR(123," ; Package Reference
"RTN","MDRPCOTH",69,0)
 S MDWPA(70201)=5 ; Default Procedure Summary Code "Machine Resulted"
"RTN","MDRPCOTH",70,0)
 I MDPDT S MDWPA(70202)=MDPDT ; Date/Time Performed
"RTN","MDRPCOTH",71,0)
 ; File PCE Error message
"RTN","MDRPCOTH",72,0)
 S MDDAR=$NA(^TMP("MDDAR",$J)),MDDAR2=$NA(GLOARR)
"RTN","MDRPCOTH",73,0)
 S MDRP=0 F  S MDRP=$O(^MDD(702,+MDGST,.1,MDRP)) Q:'MDRP  D
"RTN","MDRPCOTH",74,0)
 .S MDRST=$P($G(^MDD(702,MDGST,.1,0)),"^",3)
"RTN","MDRPCOTH",75,0)
 .I MDRST D CICNV^MDHL7U3(+MDRST,.MDDAR) D SETGLO^MDRPCW1(.MDDAR,.MDDAR2)
"RTN","MDRPCOTH",76,0)
 .K ^TMP("MDDAR",$J) Q
"RTN","MDRPCOTH",77,0)
 S MDRESU=$$EN1^MDPCE2(.MDDAR2,MDGST,$P(MDVSTR,";",2),MDPROC,$P(MDVSTR,";",3),"P",MDLOC) I +MDRESU S MDVST=+MDRESU
"RTN","MDRPCOTH",78,0)
 I MDNVST&(+MDRESU<0) D FILEMSG(MDGST,"PCE",2,$P(MDRESU,"^",2)) Q MDRESU
"RTN","MDRPCOTH",79,0)
 ; Create the TIU note stub
"RTN","MDRPCOTH",80,0)
 S MDNOTE="" D MAKE^TIUSRVP(.MDNOTE,DFN,MDTITL,$P(MDVSTR,";",2),MDLOC,$S(MDVST:MDVST,1:""),.MDWPA,MDVSTR,1,1)
"RTN","MDRPCOTH",81,0)
 I '(+MDNOTE) S $P(MDNOTE,"^")=-1 Q MDNOTE
"RTN","MDRPCOTH",82,0)
 ; Finalize the transaction
"RTN","MDRPCOTH",83,0)
 S MDFDA(702,STUDY_",",.06)=+MDNOTE
"RTN","MDRPCOTH",84,0)
 S MDFDA(702,STUDY_",",.08)=""
"RTN","MDRPCOTH",85,0)
 S:MDVST>0 MDFDA(702,STUDY_",",.13)=MDVST
"RTN","MDRPCOTH",86,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOTH",87,0)
 D UPD^MDKUTLR(STUDY,+MDNOTE)
"RTN","MDRPCOTH",88,0)
 S:$$UP^XLFSTR($$GET1^DIQ(702,+STUDY_",",".11","E"))["MUSE" MDMUS=1
"RTN","MDRPCOTH",89,0)
 S MDHLS=$P(^MDS(702.01,+$P(^MDD(702,+STUDY,0),"^",4),0),"^")
"RTN","MDRPCOTH",90,0)
 S MDHLS1=$$GET^XPAR("SYS","MD GET HIGH VOLUME",MDHLS,"E")
"RTN","MDRPCOTH",91,0)
 K MDHLS,MDWPA D GETTXT^MDAR7M(.MDWPA,RECID)
"RTN","MDRPCOTH",92,0)
 I $G(MDWPA("TEXT",1,0))="" Q 1
"RTN","MDRPCOTH",93,0)
 I $G(MDWPA(1202))=""&('+$P(MDHLS1,";",2)) S MDWPA(1202)=MDUSR,MDWPA(1204)=MDUSR,MDWPA(1302)=MDUSR
"RTN","MDRPCOTH",94,0)
 S MDWPA(.05)=5,MDTI=""
"RTN","MDRPCOTH",95,0)
 I +$P(MDHLS1,";",2)&('+$$GET^XPAR("SYS","MD USE NOTE",1)) N MDADAR,MDCCN S MDCCN=0 D  Q 1
"RTN","MDRPCOTH",96,0)
 .S MDCT=0 F  S MDCT=$O(MDWPA("TEXT",MDCT)) Q:MDCT<1  S MDADAR=$G(MDWPA("TEXT",MDCT,0)) D
"RTN","MDRPCOTH",97,0)
 ..Q:'$G(RECID)
"RTN","MDRPCOTH",98,0)
 ..S ^MDD(703.1,+RECID,.4,MDCT,0)=MDADAR,MDCCN=MDCCN+1
"RTN","MDRPCOTH",99,0)
 ..Q
"RTN","MDRPCOTH",100,0)
 .S ^MDD(703.1,+RECID,.4,0)="^^"_MDCCN_"^"_MDCCN_"^"_DT_"^"
"RTN","MDRPCOTH",101,0)
 .K MDWPA Q
"RTN","MDRPCOTH",102,0)
 D UPDATE^TIUSRVP(.MDTI,+MDNOTE,.MDWPA,1)
"RTN","MDRPCOTH",103,0)
 ;I +$$GET^XPAR("SYS","MD NOT ADMN CLOSE MUSE NOTE",1) S MDCONRS=$$CPDOC^GMRCCP(+MDCON,+MDNOTE,2) Q 1
"RTN","MDRPCOTH",104,0)
 I +$P(MDHLS1,";",2)&(+$$GET^XPAR("SYS","MD USE NOTE",1)) S MDCONRS=$$CPDOC^GMRCCP(+MDCON,+MDNOTE,2) Q 1
"RTN","MDRPCOTH",105,0)
 I +MDNOTE&MDTI'<1 D ADMNCLOS^TIUSRVPT(.MDR,+MDNOTE,"M",MDWPA(1202))
"RTN","MDRPCOTH",106,0)
 Q 1
"RTN","MDRPCW")
0^10^B69393853^B62805042
"RTN","MDRPCW",1,0)
MDRPCW ; HOIFO/NCA - Calls to AICS;04/01/2003 ;01/21/10  11:51
"RTN","MDRPCW",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21**;Apr 01, 2004;Build 30
"RTN","MDRPCW",3,0)
 ; Reference Integration Agreement:
"RTN","MDRPCW",4,0)
 ; IA #142 [Subscription] Access ^DIC(31 NAME field (#.01) with FM
"RTN","MDRPCW",5,0)
 ; IA #174 [Subscription] Access DPT(DFN,.372) node.
"RTN","MDRPCW",6,0)
 ; IA #649 [Subscription] Access DG(391 with FM for
"RTN","MDRPCW",7,0)
 ;                        IGNORE VETERAN CHECK field (#.02).
"RTN","MDRPCW",8,0)
 ; IA #1296 [Subscription] IBDF18A call
"RTN","MDRPCW",9,0)
 ; IA #1593 [Subscription] Access to Provider Narrative file
"RTN","MDRPCW",10,0)
 ;                         (#9999999.27)
"RTN","MDRPCW",11,0)
 ; IA #1894 [Subscription] PXAPI call
"RTN","MDRPCW",12,0)
 ; IA #1995 [Supported] ICPTCOD calls
"RTN","MDRPCW",13,0)
 ; IA #3990 [Supported] ICDCODE calls
"RTN","MDRPCW",14,0)
 ; IA #10060 [Supported] Access File 200
"RTN","MDRPCW",15,0)
 ; IA #10061 [Supported] VADPT calls
"RTN","MDRPCW",16,0)
 ;
"RTN","MDRPCW",17,0)
 Q
"RTN","MDRPCW",18,0)
RPC(RESULTS,OPTION,DFN,MDSTUD) ; [Procedure] Main RPC call
"RTN","MDRPCW",19,0)
 ; RPC: [MD TMDCIDC]
"RTN","MDRPCW",20,0)
 ;
"RTN","MDRPCW",21,0)
 ; DFN=Patient internal entry number in Patient file (#2)
"RTN","MDRPCW",22,0)
 ; MDSTUD=CP study internal entry number
"RTN","MDRPCW",23,0)
 ;
"RTN","MDRPCW",24,0)
 D CLEAN^DILF
"RTN","MDRPCW",25,0)
 S RESULTS=$NA(^TMP("MDRPCW",$J)) K @RESULTS
"RTN","MDRPCW",26,0)
 I $G(MDSTUD)="" S @RESULTS@(0)="-1^No Study." Q
"RTN","MDRPCW",27,0)
 I $T(@OPTION)="" D  Q
"RTN","MDRPCW",28,0)
 .S @RESULTS@(0)="-1^Error in RPC: MD TMDCIDC at "_OPTION_U_$T(+0)
"RTN","MDRPCW",29,0)
 D @OPTION S:'$D(@RESULTS) @RESULTS@(0)="-1^No return"
"RTN","MDRPCW",30,0)
 D CLEAN^DILF
"RTN","MDRPCW",31,0)
 Q
"RTN","MDRPCW",32,0)
PROC ; get list of procedures for clinic
"RTN","MDRPCW",33,0)
 N CLIN,MDARR,MDPR,MDV
"RTN","MDRPCW",34,0)
 S MDV=$$GET1^DIQ(702,+MDSTUD_",",.07,"I")
"RTN","MDRPCW",35,0)
 I $G(MDV)="" S @RESULTS@(0)="-1^No Visit." Q
"RTN","MDRPCW",36,0)
 S MDPR=$$GET1^DIQ(702,+MDSTUD_",",.04,"I")
"RTN","MDRPCW",37,0)
 I '$G(MDPR) S @RESULTS@(0)="-1^No CP Definition." Q
"RTN","MDRPCW",38,0)
 S CLIN=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDRPCW",39,0)
 I 'CLIN S CLIN=+$P(MDV,";",3) I 'CLIN S @RESULTS@(0)="-1^No Hospital Location." Q
"RTN","MDRPCW",40,0)
 D GETLST^IBDF18A(CLIN,"DG SELECT CPT PROCEDURE CODES","MDARR",,,1,DT)
"RTN","MDRPCW",41,0)
 N MDIDX,MDMOD,CODES,MDFST S MDIDX=0 M @RESULTS=MDARR
"RTN","MDRPCW",42,0)
 F  S MDIDX=$O(@RESULTS@(MDIDX)) Q:'+MDIDX  D
"RTN","MDRPCW",43,0)
 . I @RESULTS@(MDIDX)="" K @RESULTS@(MDIDX) Q
"RTN","MDRPCW",44,0)
 . S MDMOD=0,CODES="",MDFST=1
"RTN","MDRPCW",45,0)
 . F  S MDMOD=$O(@RESULTS@(MDIDX,"MODIFIER",MDMOD)) Q:(MDMOD="")  D
"RTN","MDRPCW",46,0)
 . . I MDFST S MDFST=0
"RTN","MDRPCW",47,0)
 . . E  S CODES=CODES_";"
"RTN","MDRPCW",48,0)
 . . S CODES=CODES_@RESULTS@(MDIDX,"MODIFIER",MDMOD)
"RTN","MDRPCW",49,0)
 . K @RESULTS@(MDIDX,"MODIFIER")
"RTN","MDRPCW",50,0)
 . I 'MDFST S $P(@RESULTS@(MDIDX),U,12)=CODES
"RTN","MDRPCW",51,0)
 Q
"RTN","MDRPCW",52,0)
DIAG ; get list of diagnoses for clinic
"RTN","MDRPCW",53,0)
 N CLIN,MDARR,MDPR,MDV
"RTN","MDRPCW",54,0)
 S MDV=$$GET1^DIQ(702,+MDSTUD_",",.07,"I")
"RTN","MDRPCW",55,0)
 I $G(MDV)="" S @RESULTS@(0)="-1^No Visit." Q
"RTN","MDRPCW",56,0)
 S MDPR=$$GET1^DIQ(702,+MDSTUD_",",.04,"I")
"RTN","MDRPCW",57,0)
 I '$G(MDPR) S @RESULTS@(0)="-1^No CP Definition." Q
"RTN","MDRPCW",58,0)
 S CLIN=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDRPCW",59,0)
 I 'CLIN S CLIN=+$P(MDV,";",3) I 'CLIN S @RESULTS@(0)="-1^No Hospital Location." Q
"RTN","MDRPCW",60,0)
 D GETLST^IBDF18A(CLIN,"DG SELECT ICD-9 DIAGNOSIS CODES","MDARR",,,,DT)
"RTN","MDRPCW",61,0)
 M @RESULTS=MDARR
"RTN","MDRPCW",62,0)
 Q
"RTN","MDRPCW",63,0)
SCDISP ; Return Service Connected % and Rated Disabilities
"RTN","MDRPCW",64,0)
 N VAEL,VAERR,I,MDLST,DIS,MDSC,X2
"RTN","MDRPCW",65,0)
 D ELIG^VADPT
"RTN","MDRPCW",66,0)
 S:'+VAEL(3) @RESULTS@(1)="Service Connected: NO"
"RTN","MDRPCW",67,0)
 S:+VAEL(3) @RESULTS@(1)="SC Percent: "_$P(VAEL(3),U,2)_"%"
"RTN","MDRPCW",68,0)
 I 'VAEL(4),'$$GET1^DIQ(391,+VAEL(6)_",",.02,"I") S @RESULTS@(2)="Rated Disabilities: NOT A VETERAN." D KVAR^VADPT Q
"RTN","MDRPCW",69,0)
 S @RESULTS@(2)="Rated Disabilities: "
"RTN","MDRPCW",70,0)
 S I=0,MDLST=0 F  S I=$O(^DPT(DFN,.372,I)) Q:'I  S X2=^(I,0) D
"RTN","MDRPCW",71,0)
 . S DIS=$$GET1^DIQ(31,+X2_",",.01,"E") Q:DIS=""
"RTN","MDRPCW",72,0)
 . S MDSC=$S($P(X2,U,3):"SC",$P(X2,U,3)']"":"not specified",1:"NSC")
"RTN","MDRPCW",73,0)
 . S MDLST=MDLST+1,@RESULTS@(MDLST+2)="                    "_DIS_" ("_$P(X2,U,2)_"%-"_MDSC_")"
"RTN","MDRPCW",74,0)
 I 'MDLST S @RESULTS@(2)=@RESULTS@(2)_"NONE STATED"
"RTN","MDRPCW",75,0)
 D KVAR^VADPT
"RTN","MDRPCW",76,0)
 Q
"RTN","MDRPCW",77,0)
PCEDISP ; Return print text to display PCE data
"RTN","MDRPCW",78,0)
 ;S RESULTS=$NA(^TMP("MDENC",$J)) K @RESULTS
"RTN","MDRPCW",79,0)
 S STUDY=+MDSTUD
"RTN","MDRPCW",80,0)
 N MDDAR,MDDAR2,CAT,CODE,DIAG,GLOARR,MDCCON,MDX802,MDARR,MDCPT,MDCTR,MDDFN,MDENCDT,MDFLST,MDICD,MDLC,MDLL,MDLOCN,MDPROV,MDRP,MDRST,MDVST,MDVSTR,QTY,MDX,MDX0,MDX1,S S S=";"
"RTN","MDRPCW",81,0)
 N DESC,GDIAG,LLB,MDDDN,MDDDV,MDCK,MDNCTR,MDPFLG,MDCLL,MDDESC S (MDCK,MDPFLG)=0
"RTN","MDRPCW",82,0)
 Q:'$G(STUDY)
"RTN","MDRPCW",83,0)
 Q:'$G(^MDD(702,+STUDY,0))
"RTN","MDRPCW",84,0)
 D NOW^%DTC S MDDEF=% K % S MDCTR=0
"RTN","MDRPCW",85,0)
 K ^TMP("MDDAR",$J),^TMP("MDLEX",$J),GLOARR,MDFLST
"RTN","MDRPCW",86,0)
 S MDX=$G(^MDD(702,+STUDY,0)),MDX1=$G(^(1)),MDCCON=$P(MDX,U,5)
"RTN","MDRPCW",87,0)
 S MDVST=$P(MDX1,U),MDDFN=$P(MDX,U) Q:'MDDFN
"RTN","MDRPCW",88,0)
 S:+MDVST MDPFLG=1
"RTN","MDRPCW",89,0)
 S MDVSTR=$P(MDX,U,7),MDDAR=$NA(^TMP("MDDAR",$J)),MDDAR2=$NA(GLOARR),@MDDAR2@("POV",0)=0,@MDDAR2@("CPT",0)=0,MDLC=0
"RTN","MDRPCW",90,0)
 I 'MDVST S MDRP=0 F  S MDRP=$O(^MDD(702,STUDY,.1,MDRP)) Q:'MDRP  D
"RTN","MDRPCW",91,0)
 .S MDRST=$P($G(^MDD(702,STUDY,.1,+MDRP,0)),"^",3)
"RTN","MDRPCW",92,0)
 .I +MDRST D CICNV^MDHL7U3(+MDRST,.MDDAR) D SETGLO^MDRPCW1(.MDDAR,.MDDAR2)
"RTN","MDRPCW",93,0)
 .K ^TMP("MDDAR",$J) Q
"RTN","MDRPCW",94,0)
 I 'MDVST&(+$G(@MDDAR2@("POV",0))>0) F MDLL=1:1:+$G(@MDDAR2@("POV",0)) S MDLC=MDLC+1,MDFLST(MDLC)=$G(@MDDAR2@("POV",MDLL))
"RTN","MDRPCW",95,0)
 I 'MDVST&(+$G(@MDDAR2@("CPT",0))>0) F MDLL=1:1:+$G(@MDDAR2@("CPT",0)) S MDLC=MDLC+1,MDFLST(MDLC)=$G(@MDDAR2@("CPT",MDLL))
"RTN","MDRPCW",96,0)
 I MDVST>0 S MDENCDT=$P(MDVSTR,";",2),MDLOCN=$P(MDVSTR,";",3)
"RTN","MDRPCW",97,0)
 ;E  S MDENCDT=$$PDT^MDRPCOT1(STUDY)
"RTN","MDRPCW",98,0)
 E  S MDENCDT=$P(MDVSTR,";",2)
"RTN","MDRPCW",99,0)
 S:$L(MDVSTR,";")=1 MDVSTR=";"_MDVSTR
"RTN","MDRPCW",100,0)
 S MDVSTR=$$GETVSTR^MDRPCOT1(MDDFN,MDVSTR,+$P(MDX,U,4),$P(MDX,U,2)),MDLOCN=$P(MDVSTR,";",1)
"RTN","MDRPCW",101,0)
 S:'MDENCDT MDENCDT=$P(MDVSTR,";",2)
"RTN","MDRPCW",102,0)
 S:'MDENCDT MDENCDT=MDDEF
"RTN","MDRPCW",103,0)
 S:'MDLOCN MDLOCN=$P(MDVSTR,";")
"RTN","MDRPCW",104,0)
 S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Visit #: "_$S(MDVST>0:MDVST,1:"")
"RTN","MDRPCW",105,0)
 I '+MDVST S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Encounter Date/Time: "_$E(MDENCDT,4,5)_"/"_$E(MDENCDT,6,7)_"/"_$E(MDENCDT,2,3)
"RTN","MDRPCW",106,0)
 I '+MDVST S MDVST=$$GETENC^PXAPI(MDDFN,MDENCDT,MDLOCN),MDVST=$S(+MDVST<1:0,1:+MDVST),MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Visit # For Encounter Date: "_$S(MDVST>0:MDVST,1:"")
"RTN","MDRPCW",107,0)
 I +MDVST>0 D ENCEVENT^PXAPI(MDVST)
"RTN","MDRPCW",108,0)
 I +MDVST>0 S MDPROV=0 F  S MDPROV=$O(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV)) Q:'MDPROV  D
"RTN","MDRPCW",109,0)
 .Q:'MDPFLG
"RTN","MDRPCW",110,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV,0))
"RTN","MDRPCW",111,0)
 .S CODE=+$P(MDX0,U)
"RTN","MDRPCW",112,0)
 .I +CODE S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Provider: "_$$GET1^DIQ(200,+CODE_",",.01,"E")_" "_$S($P(MDX0,U,4)="P":"Primary",1:"")
"RTN","MDRPCW",113,0)
 I +MDVST>0 S MDICD=0 F  S MDICD=$O(^TMP("PXKENC",$J,MDVST,"POV",MDICD)) Q:'MDICD  D
"RTN","MDRPCW",114,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"POV",MDICD,0)),MDX802=$G(^(802))
"RTN","MDRPCW",115,0)
 .S CODE=+$G(MDX0,U),GDIAG=$$ICDDX^ICDCODE(CODE,"")
"RTN","MDRPCW",116,0)
 .S:CODE DIAG=$P(GDIAG,U,2)_U_$P(GDIAG,U,4)
"RTN","MDRPCW",117,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW",118,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW",119,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Diagnosis: "_$P(DIAG,U,2)_" "_$S($P(MDX0,U,12)="P":"Primary",1:""),MDCK=MDCK+1
"RTN","MDRPCW",120,0)
 I +MDVST>0 S MDCPT=0 F  S MDCPT=$O(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT)) Q:'MDCPT  D
"RTN","MDRPCW",121,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT,0)),MDX802=$G(^(802))
"RTN","MDRPCW",122,0)
 .S CODE=+$G(MDX0,U)
"RTN","MDRPCW",123,0)
 .S:CODE CODE=$$CPT^ICPTCOD(CODE,MDVST)
"RTN","MDRPCW",124,0)
 .S:CODE DIAG=$P(CODE,U,2,3)
"RTN","MDRPCW",125,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW",126,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW",127,0)
 .S QTY=$P(MDX0,U,16)
"RTN","MDRPCW",128,0)
 .S MDDESC="" D CPTLEX^MDRPCWU(.RESLT,+$G(MDX0,U),"CPT")
"RTN","MDRPCW",129,0)
 .S MDCLL="" F  S MDCLL=$O(^TMP("MDLEX",$J,MDCLL)) Q:MDCLL<1  S MDDESC=$P(^(MDCLL),"^",3)
"RTN","MDRPCW",130,0)
 .S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230) K ^TMP("MDLEX",$J),RESLT
"RTN","MDRPCW",131,0)
 .S:MDDESC="" MDDESC=$P(DIAG,U,2)
"RTN","MDRPCW",132,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="CPT: "_MDDESC_"-"_QTY,MDCK=MDCK+1
"RTN","MDRPCW",133,0)
 K ^TMP("PXKENC",$J)
"RTN","MDRPCW",134,0)
 I 'MDVST!(+MDCK<1) D
"RTN","MDRPCW",135,0)
 .S MDDDN=$O(^MDD(702,"ACON",MDCCON,+STUDY),-1),MDVST=0
"RTN","MDRPCW",136,0)
 .I MDDDN D
"RTN","MDRPCW",137,0)
 ..S MDDDV=$P($G(^MDD(702,+MDDDN,0)),U,7)
"RTN","MDRPCW",138,0)
 ..S:$L(MDDDV,";")>1 MDENCDT=$P(MDDDV,";",2),MDVST=+$G(^MDD(702,+MDDDN,1)),MDVST=$S(+MDVST<1:0,1:+MDVST)
"RTN","MDRPCW",139,0)
 ..I +MDVST>0 S MDNCTR=0
"RTN","MDRPCW",140,0)
 ..S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Previous Study # Used: "_+MDDDN
"RTN","MDRPCW",141,0)
 ..S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Previous Visit #: "_MDVST_" "_$E(MDENCDT,4,5)_"/"_$E(MDENCDT,6,7)_"/"_$E(MDENCDT,2,3)
"RTN","MDRPCW",142,0)
 I $G(MDFLST(1))'="" S MDLL=0 F  S MDLL=$O(MDFLST(MDLL)) Q:MDLL<1  S:$G(MDFLST(MDLL))'="" MDCTR=MDCTR+1,@RESULTS@(MDCTR)=$G(MDFLST(MDLL))
"RTN","MDRPCW",143,0)
 Q:MDCK>0
"RTN","MDRPCW",144,0)
 Q:'MDVST
"RTN","MDRPCW",145,0)
 D ENCEVENT^PXAPI(MDVST) S:$G(MDNCTR)>0 MDCTR=MDNCTR
"RTN","MDRPCW",146,0)
 S MDPROV=0 F  S MDPROV=$O(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV)) Q:'MDPROV  D
"RTN","MDRPCW",147,0)
 .Q
"RTN","MDRPCW",148,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV,0))
"RTN","MDRPCW",149,0)
 .S CODE=+$P(MDX0,U)
"RTN","MDRPCW",150,0)
 .I +CODE S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="PRV"_U_CODE_U_U_$$GET1^DIQ(200,+CODE_",",.01,"E")_U_U_($P(MDX0,U,4)="P")
"RTN","MDRPCW",151,0)
 ;^TMP("MDENC",$J,n)="POV"^ICD9 IEN^ICD9 CODE^provider narrative category^provider narrative (Short Description)^Primary (1=Yes,0=No)
"RTN","MDRPCW",152,0)
 S MDICD=0 F  S MDICD=$O(^TMP("PXKENC",$J,MDVST,"POV",MDICD)) Q:'MDICD  D
"RTN","MDRPCW",153,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"POV",MDICD,0)),MDX802=$G(^(802))
"RTN","MDRPCW",154,0)
 .S CODE=+$G(MDX0,U),GDIAG=$$ICDDX^ICDCODE(CODE,"")
"RTN","MDRPCW",155,0)
 .S:CODE DIAG=$P(GDIAG,U,2)_U_$P(GDIAG,U,4)
"RTN","MDRPCW",156,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW",157,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW",158,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Diagnosis: "_$P(DIAG,U,2)_" "_$S($P(MDX0,U,12)="P":"Primary",1:"")
"RTN","MDRPCW",159,0)
 S MDCPT=0 F  S MDCPT=$O(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT)) Q:'MDCPT  D
"RTN","MDRPCW",160,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT,0)),MDX802=$G(^(802))
"RTN","MDRPCW",161,0)
 .S CODE=+$G(MDX0,U)
"RTN","MDRPCW",162,0)
 .S:CODE CODE=$$CPT^ICPTCOD(CODE,MDVST)
"RTN","MDRPCW",163,0)
 .S:CODE DIAG=$P(CODE,U,2,3)
"RTN","MDRPCW",164,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW",165,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW",166,0)
 .S QTY=$P(MDX0,U,16)
"RTN","MDRPCW",167,0)
 .S MDDESC="" D CPTLEX^MDRPCWU(.RESLT,+$G(MDX0,U),"CPT")
"RTN","MDRPCW",168,0)
 .S MDCLL="" F  S MDCLL=$O(^TMP("MDLEX",$J,MDCLL)) Q:MDCLL<1  S MDDESC=$P(^(MDCLL),"^",3)
"RTN","MDRPCW",169,0)
 .S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230) K ^TMP("MDLEX",$J),RESLT
"RTN","MDRPCW",170,0)
 .S:MDDESC="" MDDESC=$P(DIAG,U,2)
"RTN","MDRPCW",171,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="CPT: "_MDDESC_"-"_QTY
"RTN","MDRPCW",172,0)
 K ^TMP("PXKENC",$J)
"RTN","MDRPCW",173,0)
 Q
"RTN","MDRPCW",174,0)
TIMEMET ; Check if appointment time is met
"RTN","MDRPCW",175,0)
 N MDNOW,MDTIM,MDV
"RTN","MDRPCW",176,0)
 S MDV=$$GET1^DIQ(702,+MDSTUD_",",.07,"I")
"RTN","MDRPCW",177,0)
 I $G(MDV)="" S @RESULTS@(0)="-1^No Visit." Q
"RTN","MDRPCW",178,0)
 I $L(MDV,";")=1 S MDTIM=MDV
"RTN","MDRPCW",179,0)
 E  S MDTIM=$P(MDV,";",2)
"RTN","MDRPCW",180,0)
 I 'MDTIM S @RESULTS@(0)="-1^No Visit Date/Time." Q
"RTN","MDRPCW",181,0)
 D NOW^%DTC S MDNOW=% K %
"RTN","MDRPCW",182,0)
 I MDNOW<MDTIM S @RESULTS@(0)="0^Appointment/Visit Date/Time not met." Q
"RTN","MDRPCW",183,0)
 S @RESULTS@(0)="1^Appointment/Visit Date/Time have met."
"RTN","MDRPCW",184,0)
 Q
"RTN","MDRPCW1")
0^12^B57107439^B47358389
"RTN","MDRPCW1",1,0)
MDRPCW1 ; HOIFO/NCA - MD TMDENCOUNTER Object; [05-28-2002 12:55] ;2/16/10  16:17
"RTN","MDRPCW1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21**;Apr 01, 2004;Build 30
"RTN","MDRPCW1",3,0)
 ; Reference Integration Agreement:
"RTN","MDRPCW1",4,0)
 ; IA #1573 [Supported] ICDONE^LEXU call
"RTN","MDRPCW1",5,0)
 ; IA #1593 [Subscription] Access to Provider Narrative file
"RTN","MDRPCW1",6,0)
 ;                         (#9999999.27)
"RTN","MDRPCW1",7,0)
 ; IA #1609 [Supported] CONFIG^LEXSET call
"RTN","MDRPCW1",8,0)
 ; IA #1894 [Subscription] PXAPI calls
"RTN","MDRPCW1",9,0)
 ; IA #1995 [Supported] ICPTCOD calls
"RTN","MDRPCW1",10,0)
 ; IA #1573 [Supported] LEXU call
"RTN","MDRPCW1",11,0)
 ; IA #2263 [Supported] XPAR calls
"RTN","MDRPCW1",12,0)
 ; IA #2348 [Subscription] SCCOND^PXUTLSCC call
"RTN","MDRPCW1",13,0)
 ; IA #2950 [Supported] LOOK^LEXA call
"RTN","MDRPCW1",14,0)
 ; IA #3990 [Supported] ICDCODE calls.
"RTN","MDRPCW1",15,0)
 ; IA #10060 [Supported] FILE 200 references
"RTN","MDRPCW1",16,0)
 ;
"RTN","MDRPCW1",17,0)
CPTMODS(RESULTS,MDCPT) ;Return CPT Modifiers for a CPT Code
"RTN","MDRPCW1",18,0)
 N MDARR,MDIDX,MDI,MDNAME
"RTN","MDRPCW1",19,0)
 S RESULTS=$NA(^TMP("MDMODS",$J)) K @RESULTS
"RTN","MDRPCW1",20,0)
 S MDDATE=DT
"RTN","MDRPCW1",21,0)
 I +($$CODM^ICPTCOD(MDCPT,$NA(MDARR),0,MDDATE)),+$D(MDARR) D
"RTN","MDRPCW1",22,0)
 . S MDIDX="",MDI=0
"RTN","MDRPCW1",23,0)
 . F  S MDIDX=$O(MDARR(MDIDX)) Q:(MDIDX="")  D
"RTN","MDRPCW1",24,0)
 . . S MDI=MDI+1,MDNAME=$P(MDARR(MDIDX),U,1)
"RTN","MDRPCW1",25,0)
 . . S @RESULTS@(MDNAME_MDI)=$P(MDARR(MDIDX),U,2)_U_MDNAME_U_MDIDX
"RTN","MDRPCW1",26,0)
 Q
"RTN","MDRPCW1",27,0)
LEX(RESULTS,MDSRCH,MDAPP)   ; return list after lexicon lookup
"RTN","MDRPCW1",28,0)
 N CODE,LEX,MDLST,MDI,LEXIEN,MDVAL
"RTN","MDRPCW1",29,0)
 S RESULTS=$NA(^TMP("MDLEX",$J)) K @RESULTS
"RTN","MDRPCW1",30,0)
 S MDDATE=DT
"RTN","MDRPCW1",31,0)
 S:MDAPP="CPT" MDAPP="CHP" ; LEX PATCH 10
"RTN","MDRPCW1",32,0)
 D CONFIG^LEXSET(MDAPP,MDAPP,MDDATE)
"RTN","MDRPCW1",33,0)
 D LOOK^LEXA(MDSRCH,MDAPP,1,"",MDDATE)
"RTN","MDRPCW1",34,0)
 I '$D(LEX("LIST",1)) S @RESULTS@(1)="-1^No matches found." Q
"RTN","MDRPCW1",35,0)
 S @RESULTS@(1)=LEX("LIST",1),MDLST=1
"RTN","MDRPCW1",36,0)
 S MDI="" F  S MDI=$O(^TMP("LEXFND",$J,MDI)) Q:MDI'<0  D
"RTN","MDRPCW1",37,0)
 . S LEXIEN=$O(^TMP("LEXFND",$J,MDI,0))
"RTN","MDRPCW1",38,0)
 . S MDLST=MDLST+1,@RESULTS@(MDLST)=LEXIEN_U_^TMP("LEXFND",$J,MDI,LEXIEN)
"RTN","MDRPCW1",39,0)
 K ^TMP("LEXFND",$J),^TMP("LEXHIT",$J)
"RTN","MDRPCW1",40,0)
 S MDI="" F  S MDI=$O(@RESULTS@(MDI)) Q:'MDI  S MDVAL=$G(@RESULTS@(MDI)) D
"RTN","MDRPCW1",41,0)
 . I MDAPP="ICD" S CODE=$$ICDONE^LEXU(+MDVAL,MDDATE),@RESULTS@(MDI)=CODE_U_MDVAL
"RTN","MDRPCW1",42,0)
 . I MDAPP="CPT"!(MDAPP="CHP") S CODE=$$CPTONE^LEXU(+MDVAL,MDDATE),@RESULTS@(MDI)=CODE_U_MDVAL
"RTN","MDRPCW1",43,0)
 . I CODE="",(MDAPP="CHP") S CODE=$$CPCONE^LEXU(+MDVAL,MDDATE),@RESULTS@(MDI)=CODE_U_MDVAL
"RTN","MDRPCW1",44,0)
 Q
"RTN","MDRPCW1",45,0)
GETENC(RESULTS,STUDY) ; Return the current encounter data entered
"RTN","MDRPCW1",46,0)
 S RESULTS=$NA(^TMP("MDENC",$J)) K @RESULTS
"RTN","MDRPCW1",47,0)
 N MDDAR,MDDAR2,CAT,CODE,DIAG,GLOARR,MDCCON,MDX802,MDARR,MDCPT,MDCTR,MDDFN,MDENCDT,MDFLST,MDICD,MDLC,MDLL,MDLOCN,MDPROV,MDRP,MDRST,MDVST,MDVSTR,QTY,MDX,MDX0,MDX1,S S S=";"
"RTN","MDRPCW1",48,0)
 N GDIAG,LLB,MDDDN,MDDDV,MDCK,RESLT,MDNCTR,MDPFLG,MDCLL,MDDESC S (MDCK,MDPFLG)=0
"RTN","MDRPCW1",49,0)
 Q:'$G(STUDY)
"RTN","MDRPCW1",50,0)
 Q:'$G(^MDD(702,+STUDY,0))
"RTN","MDRPCW1",51,0)
 D NOW^%DTC S MDDEF=% K % S MDCTR=0
"RTN","MDRPCW1",52,0)
 K ^TMP("MDDAR",$J),^TMP("MDLEX",$J),GLOARR,MDFLST
"RTN","MDRPCW1",53,0)
 S MDX=$G(^MDD(702,+STUDY,0)),MDX1=$G(^(1)),MDCCON=$P(MDX,U,5)
"RTN","MDRPCW1",54,0)
 S MDVST=$P(MDX1,U),MDDFN=$P(MDX,U) Q:'MDDFN
"RTN","MDRPCW1",55,0)
 S:+MDVST MDPFLG=1
"RTN","MDRPCW1",56,0)
 S MDVSTR=$P(MDX,U,7),MDDAR=$NA(^TMP("MDDAR",$J)),MDDAR2=$NA(GLOARR),@MDDAR2@("POV",0)=0,@MDDAR2@("CPT",0)=0,MDLC=0
"RTN","MDRPCW1",57,0)
 I 'MDVST S MDRP=0 F  S MDRP=$O(^MDD(702,STUDY,.1,MDRP)) Q:'MDRP  D
"RTN","MDRPCW1",58,0)
 .S MDRST=$P($G(^MDD(702,STUDY,.1,+MDRP,0)),"^",3)
"RTN","MDRPCW1",59,0)
 .I +MDRST D CICNV^MDHL7U3(+MDRST,.MDDAR) D SETGLO(.MDDAR,.MDDAR2)
"RTN","MDRPCW1",60,0)
 .K ^TMP("MDDAR",$J) Q
"RTN","MDRPCW1",61,0)
 I 'MDVST&(+$G(@MDDAR2@("POV",0))>0) F MDLL=1:1:+$G(@MDDAR2@("POV",0)) S MDLC=MDLC+1,MDFLST(MDLC)=$G(@MDDAR2@("POV",MDLL))
"RTN","MDRPCW1",62,0)
 I 'MDVST&(+$G(@MDDAR2@("CPT",0))>0) F MDLL=1:1:+$G(@MDDAR2@("CPT",0)) S MDLC=MDLC+1,MDFLST(MDLC)=$G(@MDDAR2@("CPT",MDLL))
"RTN","MDRPCW1",63,0)
 I MDVST>0 S MDENCDT=$P(MDVSTR,";",2),MDLOCN=$P(MDVSTR,";",3)
"RTN","MDRPCW1",64,0)
 ;E  S MDENCDT=$$PDT^MDRPCOT1(STUDY)
"RTN","MDRPCW1",65,0)
 E  S MDENCDT=$P(MDVSTR,";",2)
"RTN","MDRPCW1",66,0)
 S:$L(MDVSTR,";")=1 MDVSTR=";"_MDVSTR
"RTN","MDRPCW1",67,0)
 S MDVSTR=$$GETVSTR^MDRPCOT1(MDDFN,MDVSTR,+$P(MDX,U,4),$P(MDX,U,2)),MDLOCN=$P(MDVSTR,";",1)
"RTN","MDRPCW1",68,0)
 S:'MDENCDT MDENCDT=$P(MDVSTR,";",2)
"RTN","MDRPCW1",69,0)
 S:'MDENCDT MDENCDT=MDDEF
"RTN","MDRPCW1",70,0)
 S:'MDLOCN MDLOCN=$P(MDVSTR,";")
"RTN","MDRPCW1",71,0)
 D SCCOND^PXUTLSCC(MDDFN,MDENCDT,MDLOCN,MDVST,.MDARR)
"RTN","MDRPCW1",72,0)
 S MDCTR=MDCTR+1
"RTN","MDRPCW1",73,0)
 ; ^TMP("MDENC",$J,n)="SC";0/1^0/1;"AO";0/1^0/1;"IR";0/1^0/1;"EC";0/1^0/1;"MST";0/1^0/1;"HNC";0/1^0/1;"CV";0/1^0/1
"RTN","MDRPCW1",74,0)
 ;first piece 1 if the condition can be answered
"RTN","MDRPCW1",75,0)
 ;            0 if the condition should be null not asked
"RTN","MDRPCW1",76,0)
 ;second piece - If Scheduling has the answer, 1 = yes 0 = no
"RTN","MDRPCW1",77,0)
 S @RESULTS@(MDCTR)="SC"_S_$G(MDARR("SC"))_S_"AO"_S_$G(MDARR("AO"))_S_"IR"_S_$G(MDARR("IR"))_S_"EC"_S_$G(MDARR("EC"))_S_"MST"_S_$G(MDARR("MST"))_S_"HNC"_S_$G(MDARR("HNC"))_S_"CV"_S_$G(MDARR("CV"))
"RTN","MDRPCW1",78,0)
 I 'MDVST S MDVST=$$GETENC^PXAPI(MDDFN,MDENCDT,MDLOCN),MDVST=$S(+MDVST<1:0,1:+MDVST)
"RTN","MDRPCW1",79,0)
 I +MDVST>0 D ENCEVENT^PXAPI(MDVST)
"RTN","MDRPCW1",80,0)
 ;^TMP("MDENC",$J,n)="PRV"^CODE^^NARR^^Primary (1=Yes,0=No)
"RTN","MDRPCW1",81,0)
 I +MDVST>0 S MDPROV=0 F  S MDPROV=$O(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV)) Q:'MDPROV  D
"RTN","MDRPCW1",82,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV,0))
"RTN","MDRPCW1",83,0)
 .S CODE=+$P(MDX0,U)
"RTN","MDRPCW1",84,0)
 .I +CODE S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="PRV"_U_CODE_U_U_$$GET1^DIQ(200,+CODE_",",.01,"E")_U_U_($P(MDX0,U,4)="P")
"RTN","MDRPCW1",85,0)
 ;^TMP("MDENC",$J,n)="POV"^ICD9 IEN^ICD9 CODE^provider narrative category^provider narrative (Short Description)^Primary (1=Yes,0=No)
"RTN","MDRPCW1",86,0)
 I +MDVST>0 S MDICD=0 F  S MDICD=$O(^TMP("PXKENC",$J,MDVST,"POV",MDICD)) Q:'MDICD  D
"RTN","MDRPCW1",87,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"POV",MDICD,0)),MDX802=$G(^(802))
"RTN","MDRPCW1",88,0)
 .S CODE=+$G(MDX0,U),GDIAG=$$ICDDX^ICDCODE(CODE,"")
"RTN","MDRPCW1",89,0)
 .S:CODE DIAG=$P(GDIAG,U,2)_U_$P(GDIAG,U,4)
"RTN","MDRPCW1",90,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW1",91,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW1",92,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="POV"_U_+$G(MDX0,U)_U_$P(DIAG,U)_U_CAT_U_$P(DIAG,U,2)_U_($P(MDX0,U,12)="P"),MDCK=MDCK+1
"RTN","MDRPCW1",93,0)
 ;^TMP("MDENC",$J,n)="CPT"^CPT IEN^CPT CODE^provider narrative category^provider narrative (Description)^^Quantity
"RTN","MDRPCW1",94,0)
 I +MDVST>0 S MDCPT=0 F  S MDCPT=$O(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT)) Q:'MDCPT  D
"RTN","MDRPCW1",95,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT,0)),MDX802=$G(^(802))
"RTN","MDRPCW1",96,0)
 .S CODE=+$G(MDX0,U)
"RTN","MDRPCW1",97,0)
 .S:CODE CODE=$$CPT^ICPTCOD(CODE,MDVST)
"RTN","MDRPCW1",98,0)
 .S:CODE DIAG=$P(CODE,U,2,3)
"RTN","MDRPCW1",99,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW1",100,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW1",101,0)
 .S QTY=$P(MDX0,U,16)
"RTN","MDRPCW1",102,0)
 .S MDDESC="" D CPTLEX^MDRPCWU(.RESLT,+$G(MDX0,U),"CPT")
"RTN","MDRPCW1",103,0)
 .S MDCLL="" F  S MDCLL=$O(^TMP("MDLEX",$J,MDCLL)) Q:MDCLL<1  S MDDESC=$P(^(MDCLL),"^",3)
"RTN","MDRPCW1",104,0)
 .S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230) K ^TMP("MDLEX",$J),RESLT
"RTN","MDRPCW1",105,0)
 .S:MDDESC="" MDDESC=$P(DIAG,U,2)
"RTN","MDRPCW1",106,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="CPT"_U_+$G(MDX0,U)_U_$P(DIAG,U)_U_CAT_U_MDDESC_U_U_QTY,MDCK=MDCK+1
"RTN","MDRPCW1",107,0)
 K ^TMP("PXKENC",$J)
"RTN","MDRPCW1",108,0)
 I 'MDVST!(+MDCK<1) D
"RTN","MDRPCW1",109,0)
 .S MDDDN=$O(^MDD(702,"ACON",MDCCON,+STUDY),-1),MDVST=0
"RTN","MDRPCW1",110,0)
 .I MDDDN D
"RTN","MDRPCW1",111,0)
 ..S MDDDV=$P($G(^MDD(702,+MDDDN,0)),U,7)
"RTN","MDRPCW1",112,0)
 ..S:$L(MDDDV,";")>1 MDENCDT=$P(MDDDV,";",2),MDVST=+$G(^MDD(702,+MDDDN,1)),MDVST=$S(+MDVST<1:0,1:+MDVST)
"RTN","MDRPCW1",113,0)
 ..I +MDVST>0 S MDNCTR=MDCTR F LLB=2:1:MDCTR K @RESULTS@(MDCTR) S MDNCTR=MDNCTR-1
"RTN","MDRPCW1",114,0)
 I $G(MDFLST(1))'="" S MDLL=0 F  S MDLL=$O(MDFLST(MDLL)) Q:MDLL<1  S:$G(MDFLST(MDLL))'="" MDCTR=MDCTR+1,@RESULTS@(MDCTR)=$G(MDFLST(MDLL))
"RTN","MDRPCW1",115,0)
 Q:MDCK>0
"RTN","MDRPCW1",116,0)
 Q:'MDVST
"RTN","MDRPCW1",117,0)
 D ENCEVENT^PXAPI(MDVST) S:$G(MDNCTR)>0 MDCTR=MDNCTR
"RTN","MDRPCW1",118,0)
 ;^TMP("MDENC",$J,n)="PRV"^CODE^^NARR^^Primary (1=Yes,0=No)
"RTN","MDRPCW1",119,0)
 S MDPROV=0 F  S MDPROV=$O(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV)) Q:'MDPROV  D
"RTN","MDRPCW1",120,0)
 .Q
"RTN","MDRPCW1",121,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV,0))
"RTN","MDRPCW1",122,0)
 .S CODE=+$P(MDX0,U)
"RTN","MDRPCW1",123,0)
 .I +CODE S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="PRV"_U_CODE_U_U_$$GET1^DIQ(200,+CODE_",",.01,"E")_U_U_($P(MDX0,U,4)="P")
"RTN","MDRPCW1",124,0)
 ;^TMP("MDENC",$J,n)="POV"^ICD9 IEN^ICD9 CODE^provider narrative category^provider narrative (Short Description)^Primary (1=Yes,0=No)
"RTN","MDRPCW1",125,0)
 S MDICD=0 F  S MDICD=$O(^TMP("PXKENC",$J,MDVST,"POV",MDICD)) Q:'MDICD  D
"RTN","MDRPCW1",126,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"POV",MDICD,0)),MDX802=$G(^(802))
"RTN","MDRPCW1",127,0)
 .S CODE=+$G(MDX0,U),GDIAG=$$ICDDX^ICDCODE(CODE,"")
"RTN","MDRPCW1",128,0)
 .S:CODE DIAG=$P(GDIAG,U,2)_U_$P(GDIAG,U,4)
"RTN","MDRPCW1",129,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW1",130,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW1",131,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="POV"_U_+$G(MDX0,U)_U_$P(DIAG,U)_U_CAT_U_$P(DIAG,U,2)_U_($P(MDX0,U,12)="P")
"RTN","MDRPCW1",132,0)
 ;^TMP("MDENC",$J,n)="CPT"^CPT IEN^CPT CODE^provider narrative category^provider narrative (Short Description)^^Quantity
"RTN","MDRPCW1",133,0)
 S MDCPT=0 F  S MDCPT=$O(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT)) Q:'MDCPT  D
"RTN","MDRPCW1",134,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT,0)),MDX802=$G(^(802))
"RTN","MDRPCW1",135,0)
 .S CODE=+$G(MDX0,U)
"RTN","MDRPCW1",136,0)
 .S:CODE CODE=$$CPT^ICPTCOD(CODE,MDVST)
"RTN","MDRPCW1",137,0)
 .S:CODE DIAG=$P(CODE,U,2,3)
"RTN","MDRPCW1",138,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW1",139,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW1",140,0)
 .S QTY=$P(MDX0,U,16)
"RTN","MDRPCW1",141,0)
 .S MDDESC="" D CPTLEX^MDRPCWU(.RESLT,+$G(MDX0,U),"CPT")
"RTN","MDRPCW1",142,0)
 .S MDCLL="" F  S MDCLL=$O(^TMP("MDLEX",$J,MDCLL)) Q:MDCLL<1  S MDDESC=$P(^(MDCLL),"^",3)
"RTN","MDRPCW1",143,0)
 .S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230) K ^TMP("MDLEX",$J),RESLT
"RTN","MDRPCW1",144,0)
 .S:MDDESC="" MDDESC=$P(DIAG,U,2)
"RTN","MDRPCW1",145,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="CPT"_U_+$G(MDX0,U)_U_$P(DIAG,U)_U_CAT_U_MDDESC_U_U_QTY
"RTN","MDRPCW1",146,0)
 K ^TMP("PXKENC",$J)
"RTN","MDRPCW1",147,0)
 Q
"RTN","MDRPCW1",148,0)
SETGLO(MDGLO1,MDGLO2) ; Set the ICD and CPT from device into a global array
"RTN","MDRPCW1",149,0)
 N MDA,MDB,MDC
"RTN","MDRPCW1",150,0)
 I +$G(@MDGLO1@(1))<1&(+$G(@MDGLO1@(2))<1) Q
"RTN","MDRPCW1",151,0)
 S MDA=$O(@MDGLO2@("POV",""),-1)
"RTN","MDRPCW1",152,0)
 S MDB=$O(@MDGLO2@("CPT",""),-1)
"RTN","MDRPCW1",153,0)
 F MDC=1:1:+$G(@MDGLO1@(1)) S MDA=MDA+1,@MDGLO2@("POV",MDA)=$G(@MDGLO1@(1,MDC))
"RTN","MDRPCW1",154,0)
 F MDC=1:1:+$G(@MDGLO1@(2)) S MDB=MDB+1,@MDGLO2@("CPT",MDB)=$G(@MDGLO1@(2,MDC))
"RTN","MDRPCW1",155,0)
 S @MDGLO2@("POV",0)=MDA,@MDGLO2@("CPT",0)=MDB
"RTN","MDRPCW1",156,0)
 Q
"RTN","MDRPCW1",157,0)
NTIU(P1,RECID) ; Create New TIU note for Result
"RTN","MDRPCW1",158,0)
 I $G(^MDD(702,+P1,0))="" Q 0
"RTN","MDRPCW1",159,0)
 N MDNEWN,MDFG,MDHVL,MDKK S MDFG=0
"RTN","MDRPCW1",160,0)
 D GETLST^XPAR(.MDHVL,"SYS","MD GET HIGH VOLUME")
"RTN","MDRPCW1",161,0)
 F MDKK=0:0 S MDKK=$O(MDHVL(MDKK)) Q:MDKK<1  I $P($G(MDHVL(MDKK)),"^")=+$P(^MDD(702,+P1,0),U,4) S MDFG=1 Q
"RTN","MDRPCW1",162,0)
 I $P($G(^MDS(702.01,+$P(^MDD(702,+P1,0),U,4),0)),U,6)=2 S MDNEWN=$$NEWTIUN^MDRPCOT2(+P1)
"RTN","MDRPCW1",163,0)
 I +$P($G(^MDS(702.01,+$P(^MDD(702,+P1,0),U,4),0)),U,10)!(+MDFG) S MDNEWN=$$NEWTIUN^MDRPCOTH(+P1,RECID)
"RTN","MDRPCW1",164,0)
 Q 1
"RTN","MDRPCWU")
0^31^B2706250^n/a
"RTN","MDRPCWU",1,0)
MDRPCWU ; HOIFO/NCA - CPT Code Query; [05-28-2002 12:55] ;2/16/10  16:17
"RTN","MDRPCWU",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDRPCWU",3,0)
 ; Reference Integration Agreement:
"RTN","MDRPCWU",4,0)
 ; IA #1573 [Supported] LEXU calls
"RTN","MDRPCWU",5,0)
 ; IA #1609 [Supported] CONFIG^LEXSET call
"RTN","MDRPCWU",6,0)
 ; IA #2950 [Supported] LOOK^LEXA call
"RTN","MDRPCWU",7,0)
 ;
"RTN","MDRPCWU",8,0)
CPTLEX(RESLT,MDSRCH,MDAPP) ; CPT Code Query
"RTN","MDRPCWU",9,0)
 N CODE,LEX,MDLST,MDI,LEXIEN,MDVAL
"RTN","MDRPCWU",10,0)
 S RESLT=$NA(^TMP("MDLEX",$J)) K @RESLT
"RTN","MDRPCWU",11,0)
 S MDDATE=DT
"RTN","MDRPCWU",12,0)
 S:MDAPP="CPT" MDAPP="CHP" ; LEX PATCH 10
"RTN","MDRPCWU",13,0)
 D CONFIG^LEXSET(MDAPP,MDAPP,MDDATE)
"RTN","MDRPCWU",14,0)
 D LOOK^LEXA(MDSRCH,MDAPP,1,"",MDDATE)
"RTN","MDRPCWU",15,0)
 I '$D(LEX("LIST",1)) S @RESLT@(1)="-1^No matches found." Q
"RTN","MDRPCWU",16,0)
 S @RESLT@(1)=LEX("LIST",1),MDLST=1
"RTN","MDRPCWU",17,0)
 S MDI="" F  S MDI=$O(^TMP("LEXFND",$J,MDI)) Q:MDI'<0  D
"RTN","MDRPCWU",18,0)
 . S LEXIEN=$O(^TMP("LEXFND",$J,MDI,0))
"RTN","MDRPCWU",19,0)
 . S MDLST=MDLST+1,@RESLT@(MDLST)=LEXIEN_U_^TMP("LEXFND",$J,MDI,LEXIEN)
"RTN","MDRPCWU",20,0)
 K ^TMP("LEXFND",$J),^TMP("LEXHIT",$J)
"RTN","MDRPCWU",21,0)
 S MDI="" F  S MDI=$O(@RESLT@(MDI)) Q:'MDI  S MDVAL=$G(@RESLT@(MDI)) D
"RTN","MDRPCWU",22,0)
 . I MDAPP="ICD" S CODE=$$ICDONE^LEXU(+MDVAL,MDDATE),@RESLT@(MDI)=CODE_U_MDVAL
"RTN","MDRPCWU",23,0)
 . I MDAPP="CPT"!(MDAPP="CHP") S CODE=$$CPTONE^LEXU(+MDVAL,MDDATE),@RESLT@(MDI)=CODE_U_MDVAL
"RTN","MDRPCWU",24,0)
 . I CODE="",(MDAPP="CHP") S CODE=$$CPCONE^LEXU(+MDVAL,MDDATE),@RESLT@(MDI)=CODE_U_MDVAL
"RTN","MDRPCWU",25,0)
 Q
"RTN","MDSTUDW")
0^14^B21880299^n/a
"RTN","MDSTUDW",1,0)
MDSTUDW ; HOIFO/NCA - Print a List of Procedures With Incomplete Workload ;3/2/09  10:00
"RTN","MDSTUDW",2,0)
 ;;1.0;CLINICAL PROCEDURES;**21**;Apr 01, 2004;Build 30
"RTN","MDSTUDW",3,0)
 ; Integration Agreements:
"RTN","MDSTUDW",4,0)
 ; IA #1894 [Subscription] PXAPI call
"RTN","MDSTUDW",5,0)
 ; IA# 10103 [Supported] XLFDT calls
"RTN","MDSTUDW",6,0)
 ; IA# 10061 [Supported] VADPT calls
"RTN","MDSTUDW",7,0)
 ; IA# 10062 [Supported] VADPT6 calls
"RTN","MDSTUDW",8,0)
 ; IA# 4869 [Private] ^DIC(45.7,
"RTN","MDSTUDW",9,0)
 ;
"RTN","MDSTUDW",10,0)
E1 ; Get Start Date
"RTN","MDSTUDW",11,0)
 N MDSDT,MDEDT
"RTN","MDSTUDW",12,0)
 S %DT("A")="Select Start Date: ",%DT="AEX" W ! D ^%DT G EX:"^"[X!$D(DTOUT),E1:Y<1 S MDSDT=+Y
"RTN","MDSTUDW",13,0)
E2 S %DT("A")="Select End Date: ",%DT="AEX" W ! D ^%DT G EX:"^"[X!$D(DTOUT),E2:Y<1
"RTN","MDSTUDW",14,0)
 I +Y<MDSDT W !!,"***End Date must be on or after Start Date!!!" G E2
"RTN","MDSTUDW",15,0)
 S MDEDT=+Y+.24
"RTN","MDSTUDW",16,0)
EN2 ; Print a list of Procedures with incomplete Workload
"RTN","MDSTUDW",17,0)
 N DIC,MDSPEC,X,Y,DTOUT,DUOUT
"RTN","MDSTUDW",18,0)
S1 R !!,"Select Facility Treating Specialty (or ALL): ",X:DTIME Q:'$T!("^"[X)  S:X="all" X=$TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ") I X="ALL" S MDSPEC=0
"RTN","MDSTUDW",19,0)
 E  K DIC S DIC="^DIC(45.7,",DIC(0)="EMQ" D ^DIC G:Y<1!($D(DTOUT))!($D(DUOUT)) S1 S MDSPEC=+Y K DIC W !
"RTN","MDSTUDW",20,0)
 K IOP S %ZIS="MQ",%ZIS("A")="Select LIST Printer: ",%ZIS("B")="HOME" W ! D ^%ZIS K %ZIS,IOP Q:POP
"RTN","MDSTUDW",21,0)
 I $D(IO("Q")) D QUE Q
"RTN","MDSTUDW",22,0)
 U IO D GETTRAN D ^%ZISC K %ZIS,IOP Q
"RTN","MDSTUDW",23,0)
QUE ; Queue List
"RTN","MDSTUDW",24,0)
 K IO("Q"),ZTUCI,ZTDTH,ZTIO,ZTSAVE,ZTDESC,ZTSK S ZTRTN="GETTRAN^MDSTUDW",ZTREQ="@",ZTSAVE("ZTREQ")="",ZTSAVE("MDSPEC")="",ZTSAVE("MDSDT")="",ZTSAVE("MDEDT")=""
"RTN","MDSTUDW",25,0)
 S:$D(XQY0) ZTDESC=$P(XQY0,"^",1)
"RTN","MDSTUDW",26,0)
 D ^%ZTLOAD D ^%ZISC U IO W !,"Request Queued",! K ZTSK Q
"RTN","MDSTUDW",27,0)
EX ; Exit
"RTN","MDSTUDW",28,0)
 Q
"RTN","MDSTUDW",29,0)
GETTRAN ; [Procedure] Loop through Results by Date/Time Performed
"RTN","MDSTUDW",30,0)
 K ^TMP("MDSTUDW",$J)
"RTN","MDSTUDW",31,0)
 N ANS,BID,DFN,DTP,LN,MDL,MDL1,MDCHKD,MDCHKDT,MDCOM,MDCNST,MDCOMP,MDDEFN,MDNUM,MDPNAM,MDREQ,MDANOD,MDBNOD,MDCNOD,MDSP,MDTXT,MDVS,MDVST,MDX,PG,S1,X1,X2,X,Y0,Z
"RTN","MDSTUDW",32,0)
 N MDCT,MDLOP,MDOK,MDOK1,MDOK2,MDVDT S S1=$S(IOST?1"C".E:IOSL-8,1:IOSL-7)
"RTN","MDSTUDW",33,0)
 S LN="",$P(LN,"-",79)="",MDCOM=0
"RTN","MDSTUDW",34,0)
 S PG=0 N % D NOW^%DTC S DTP=%,DTP=$$FMTE^XLFDT(DTP,"1P")
"RTN","MDSTUDW",35,0)
 S MDL=MDSDT F  S MDL=$O(^MDD(703.1,"ADTP",MDL)) Q:'MDL!(MDL>MDEDT)  F MDL1=0:0 S MDL1=$O(^MDD(703.1,"ADTP",MDL,MDL1)) Q:MDL1<1  D
"RTN","MDSTUDW",36,0)
 .S (MDANOD,MDBNOD,MDCNOD)=""
"RTN","MDSTUDW",37,0)
 .S MDCOM=$P($G(^MDD(703.1,+MDL1,0)),"^",5)
"RTN","MDSTUDW",38,0)
 .S MDVST=+$G(^MDD(702,+MDCOM,1)) Q:'MDVST
"RTN","MDSTUDW",39,0)
 .D ENCEVENT^PXAPI(MDVST) S (MDOK,MDOK1,MDOK2)=0
"RTN","MDSTUDW",40,0)
 .I $D(^TMP("PXKENC",$J,MDVST,"POV")) S MDOK=1
"RTN","MDSTUDW",41,0)
 .I $D(^TMP("PXKENC",$J,MDVST,"CPT")) S MDOK1=1
"RTN","MDSTUDW",42,0)
 .I $D(^TMP("PXKENC",$J,MDVST,"PRV")) S MDOK2=1
"RTN","MDSTUDW",43,0)
 .S MDVS=$O(^TMP("PXKENC",$J,MDVST,"VST",0))
"RTN","MDSTUDW",44,0)
 .S MDVDT=$P($G(^TMP("PXKENC",$J,MDVST,"VST",+MDVS,0)),"^",1)
"RTN","MDSTUDW",45,0)
 .K ^TMP("PXKENC",$J)
"RTN","MDSTUDW",46,0)
 .Q:(MDOK+MDOK1+MDOK2)=3
"RTN","MDSTUDW",47,0)
 .S DFN=+$P($G(^MDD(702,+MDCOM,0)),"^") D DEM^VADPT S MDPNAM=$G(VADM(1)) K VADM D PID^VADPT6 S BID=$G(VA("BID")) K VA
"RTN","MDSTUDW",48,0)
 .S MDBNOD=$S($L(MDPNAM)>24:$E(MDPNAM,1,24),1:MDPNAM)_" ("_BID_")",MDCNST=$P($G(^MDD(702,+MDCOM,0)),"^",5)
"RTN","MDSTUDW",49,0)
 .S MDANOD="UNASSIGNED",MDSP=+$$GET1^DIQ(702,+MDCOM,".04:.02","I")
"RTN","MDSTUDW",50,0)
 .I +MDSP Q:+MDSPEC>0&(+MDSPEC'=+MDSP)  S MDANOD=$$GET1^DIQ(702,+MDCOM,".04:.02")
"RTN","MDSTUDW",51,0)
 .I +$$GET1^DIQ(702,+MDCOM,.04,"I") S MDDEFN=$$GET1^DIQ(702,+MDCOM,.04),MDCNOD=MDVDT_"~"_MDBNOD
"RTN","MDSTUDW",52,0)
 .S MDANOD=MDANOD_"~"_MDDEFN
"RTN","MDSTUDW",53,0)
 .S Z=$$FMTE^XLFDT(MDVDT,"2MZ")_"^"_MDCNST_"^"_+$P($G(^MDD(702,+MDCOM,0)),"^",6)_"^"_MDVST_"^"_$S('MDOK:"Diagnosis",1:"")_"^"_$S('MDOK1:"CPT",1:"")_"^"_$S('MDOK2:"Provider",1:"")
"RTN","MDSTUDW",54,0)
 .I '$D(^TMP("MDSTUDW",$J,MDANOD,MDCNOD)) S ^TMP("MDSTUDW",$J,MDANOD,MDCNOD)=Z
"RTN","MDSTUDW",55,0)
 .Q
"RTN","MDSTUDW",56,0)
 I '$D(^TMP("MDSTUDW",$J)) S (ANS,MDANOD,MDLOP)="" D HDR W !!,"No procedures with incomplete workload found."
"RTN","MDSTUDW",57,0)
 N MDCT S MDCT=0,(ANS,MDCHKD)=""
"RTN","MDSTUDW",58,0)
 N MDLOP S MDLOP="" F  S MDLOP=$O(^TMP("MDSTUDW",$J,MDLOP)) Q:MDLOP=""!(ANS="^")  D
"RTN","MDSTUDW",59,0)
 .D HDR
"RTN","MDSTUDW",60,0)
 .S MDANOD="" F  S MDANOD=$O(^TMP("MDSTUDW",$J,MDLOP,MDANOD)) Q:MDANOD=""!(ANS="^")  D
"RTN","MDSTUDW",61,0)
 ..S Y0=$G(^TMP("MDSTUDW",$J,MDLOP,MDANOD))
"RTN","MDSTUDW",62,0)
 ..D:$Y>(IOSL-8) HDR Q:ANS="^"
"RTN","MDSTUDW",63,0)
 ..I MDCHKD'=$P(MDLOP,"~",2) W !,"PROCEDURE: ",$P(MDLOP,"~",2),! S MDCHKD=$P(MDLOP,"~",2)
"RTN","MDSTUDW",64,0)
 ..D:$Y'<S1 PAUSE Q:ANS="^"
"RTN","MDSTUDW",65,0)
 ..W !,$P(Y0,U),?18,$P(MDANOD,"~",2),?52,$P(Y0,U,2),?62,$P(Y0,U,3)
"RTN","MDSTUDW",66,0)
 ..I $P(Y0,U,5)'="" W ?69,$P(Y0,U,5)
"RTN","MDSTUDW",67,0)
 ..I $P(Y0,U,6)'="" W !?69,$P(Y0,U,6)
"RTN","MDSTUDW",68,0)
 ..I $P(Y0,U,7)'="" W !?69,$P(Y0,U,7)
"RTN","MDSTUDW",69,0)
 ..W ! Q
"RTN","MDSTUDW",70,0)
 .Q
"RTN","MDSTUDW",71,0)
 K ^TMP("MDSTUDL",$J)
"RTN","MDSTUDW",72,0)
 Q
"RTN","MDSTUDW",73,0)
HDR ; List Header
"RTN","MDSTUDW",74,0)
 Q:ANS="^"  D:$Y'<S1 PAUSE Q:ANS="^"
"RTN","MDSTUDW",75,0)
 W:'($E(IOST,1,2)'="C-"&'PG) @IOF S PG=PG+1
"RTN","MDSTUDW",76,0)
 W !,DTP,?73,"Page ",PG,!!?5,"P R O C E D U R E S   W I T H   I N C O M P L E T E   W O R K L O A D",!!
"RTN","MDSTUDW",77,0)
 S Y=$S($P(MDLOP,"~")="UNASSIGNED":"",1:$P(MDLOP,"~")) W:Y'="" !?(78-$L(Y)\2),Y,!
"RTN","MDSTUDW",78,0)
 W !,"Visit D/T",?18,"Patient",?50,"Consult #",?62,"TIU #",?69,"MISSING",!,LN
"RTN","MDSTUDW",79,0)
 Q
"RTN","MDSTUDW",80,0)
PAUSE ; Pause For Scroll
"RTN","MDSTUDW",81,0)
 I IOST?1"C".E K DIR S DIR(0)="E",DIR("A")="Enter RETURN to Continue or '^' to Quit Listing"  D ^DIR I 'Y S ANS="^"
"RTN","MDSTUDW",82,0)
 Q
"RTN","MDWCAN")
0^7^B19425889^B16228241
"RTN","MDWCAN",1,0)
MDWCAN ;HOIFO/NCA - Process No-Shows and Cancels ;7/29/08  09:50
"RTN","MDWCAN",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11,21**;Apr 01, 2004;Build 30
"RTN","MDWCAN",3,0)
 ; Reference IA #2263 [Supported] Call to ^XPAR
"RTN","MDWCAN",4,0)
 ;              #4433 [Supported] Call to SDAPI^SDAMA301
"RTN","MDWCAN",5,0)
 ;              #10103 [Supported] XLFDT call
"RTN","MDWCAN",6,0)
EN1 ; Check for No-Shows and Cancels
"RTN","MDWCAN",7,0)
 N MDARRAY,MDAPAT,MDAPPT,MDCHECK,MDALOC,MDCL,MDCOUNT,MDCLIEN,MDDFN,MDDATE,MDAPPT,MDK,MDLP1,MDLP2,MDLST,MDLIST,MDFIN,MDND,MDSTUDY,MDVST,MDXX,MDY,X1,X2
"RTN","MDWCAN",8,0)
 S X1=DT,X2=-1 D C^%DTC S MDDATE=X K ^TMP("MDAP",$J),^TMP("MDCAN",$J),^TMP("MDPLST",$J),MDALOC S MDFIN=DT+.24
"RTN","MDWCAN",9,0)
 D GETLST^XPAR(.MDLIST,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWCAN",10,0)
 F MDK=0:0 S MDK=$O(MDLIST(MDK)) Q:MDK<1  S MDND=$P($G(MDLIST(MDK)),"^",2) I +$P(MDND,";",2) S MDCL=+MDND D
"RTN","MDWCAN",11,0)
 .S:$G(MDALOC(+MDCL))="" MDALOC(+MDCL)=+MDCL
"RTN","MDWCAN",12,0)
 .S ^TMP("MDPLST",$J,+MDCL,+$P(MDND,";",2))=+$P(MDND,";",2)
"RTN","MDWCAN",13,0)
 .Q
"RTN","MDWCAN",14,0)
 S MDLP1=DT F  S MDLP1=$O(^MDD(702,"ASD",MDLP1)) Q:MDLP1<1!(MDLP1>MDFIN)  F MDLP2=0:0 S MDLP2=$O(^MDD(702,"ASD",MDLP1,MDLP2)) Q:MDLP2<1  D
"RTN","MDWCAN",15,0)
 .S MDXX=$G(^MDD(702,MDLP2,0))
"RTN","MDWCAN",16,0)
 .Q:$P(MDXX,"^",9)'=5
"RTN","MDWCAN",17,0)
 .Q:'+MDXX
"RTN","MDWCAN",18,0)
 .I $G(^TMP("MDAP",$J,+MDXX))="" S ^TMP("MDAP",$J,+MDXX)=+MDXX
"RTN","MDWCAN",19,0)
 .Q
"RTN","MDWCAN",20,0)
 F MDLP1=0:0 S MDLP1=$O(^MDD(702,"AS",0,MDLP1)) Q:MDLP1<1  D
"RTN","MDWCAN",21,0)
 .S MDXX=$G(^MDD(702,MDLP1,0))
"RTN","MDWCAN",22,0)
 .Q:$P(MDXX,"^",9)>0
"RTN","MDWCAN",23,0)
 .Q:'+$P(MDXX,"^",5)!($P(MDXX,"^",6)'="")
"RTN","MDWCAN",24,0)
 .Q:'+MDXX
"RTN","MDWCAN",25,0)
 .I $G(^TMP("MDAP",$J,+MDXX))="" S ^TMP("MDAP",$J,+MDXX)=+MDXX
"RTN","MDWCAN",26,0)
 .I '+$G(^TMP("MDCAN",$J,0,+MDXX,+$P(MDXX,"^",4))) S ^TMP("MDCAN",$J,0,+MDXX,+$P(MDXX,"^",4))=MDLP1
"RTN","MDWCAN",27,0)
 .Q
"RTN","MDWCAN",28,0)
 F MDK=0:0 S MDK=$O(^TMP("MDAP",$J,MDK)) Q:MDK<1  D
"RTN","MDWCAN",29,0)
 .K ^TMP($J,"SDAMA301") S MDXX=MDK,MDARRAY(1)=MDDATE_";"_DT
"RTN","MDWCAN",30,0)
 .S MDARRAY(2)="MDALOC("
"RTN","MDWCAN",31,0)
 .S MDARRAY(3)="NS;NSR;CP;CPR;CC;CCR",MDARRAY(4)=+MDXX,MDARRAY("FLDS")="1;3;4;25"
"RTN","MDWCAN",32,0)
 .S MDCOUNT=$$SDAPI^SDAMA301(.MDARRAY)
"RTN","MDWCAN",33,0)
 .I MDCOUNT>0 D
"RTN","MDWCAN",34,0)
 ..S MDCL=0 F  S MDCL=$O(^TMP($J,"SDAMA301",+MDXX,MDCL)) Q:MDCL<1  S MDCLIEN=0 F  S MDCLIEN=$O(^TMP($J,"SDAMA301",+MDXX,+MDCL,MDCLIEN)) Q:MDCLIEN<1  D
"RTN","MDWCAN",35,0)
 ...S MDAPPT=$G(^TMP($J,"SDAMA301",+MDXX,+MDCL,MDCLIEN))
"RTN","MDWCAN",36,0)
 ...Q:$P(MDAPPT,"^",3)=""
"RTN","MDWCAN",37,0)
 ...Q:+$P(MDAPPT,"^",4)'=+MDXX
"RTN","MDWCAN",38,0)
 ...Q:$P(MDAPPT,"^",1)=""
"RTN","MDWCAN",39,0)
 ...S MDSTUDY=$$GSTUDY(+MDXX,$P(MDAPPT,"^",1),+MDCL) Q:'MDSTUDY
"RTN","MDWCAN",40,0)
 ...I $G(^MDD(702,+MDSTUDY,3))="" K MDFDA S MDFDA(702,+MDSTUDY_",",.14)=$P(MDAPPT,"^",1) D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDWCAN",41,0)
 ...D PURG(+MDSTUDY) Q
"RTN","MDWCAN",42,0)
 ..Q
"RTN","MDWCAN",43,0)
 .Q
"RTN","MDWCAN",44,0)
 K ^TMP($J,"SDAMA301"),^TMP("MDAP",$J),^TMP("MDCAN",$J),^TMP("MDPLST",$J),MDAPAT,MDALOC
"RTN","MDWCAN",45,0)
 Q
"RTN","MDWCAN",46,0)
GSTUDY(MDPAT,MDDA,MDACL) ;Get study for scheduled date/time
"RTN","MDWCAN",47,0)
 N MDDONE,MDIN,MDN,MDV,Y1 S (MDDONE,Y1)=0
"RTN","MDWCAN",48,0)
 F MDIN=0:0 S MDIN=$O(^MDD(702,"ASD",MDDA,MDIN)) Q:MDIN<1!(Y1>0)!(MDDONE=1)  D
"RTN","MDWCAN",49,0)
 .I $P($G(^MDD(702,MDIN,0)),"^")=MDPAT D
"RTN","MDWCAN",50,0)
 ..S MDN=$G(^MDD(702,MDIN,0)),MDV=$P(MDN,"^",7)
"RTN","MDWCAN",51,0)
 ..I $P(MDV,";",3)'=""&($P(MDV,";",3)'=MDACL) Q
"RTN","MDWCAN",52,0)
 ..S:$P(MDN,"^",9)'=6 Y1=MDIN S:$P(MDN,"^",9)=6 MDDONE=1
"RTN","MDWCAN",53,0)
 ..Q
"RTN","MDWCAN",54,0)
 I +Y1>0 Q Y1
"RTN","MDWCAN",55,0)
 I +MDDONE>0 Q Y1
"RTN","MDWCAN",56,0)
 F MDIN=0:0 S MDIN=$O(^TMP("MDCAN",$J,0,MDPAT,MDIN)) Q:MDIN<1!(Y1>0)  D
"RTN","MDWCAN",57,0)
 .I +$G(^TMP("MDPLST",$J,MDACL,MDIN)) S Y1=+$G(^TMP("MDCAN",$J,0,MDPAT,MDIN))
"RTN","MDWCAN",58,0)
 Q Y1
"RTN","MDWCAN",59,0)
PURG(MDI) ; [Procedure] Delete Study
"RTN","MDWCAN",60,0)
 N MDAST,MDCANR,MDERR,MDFDA,MDJ,MDHOLD,MDNK,MDNOTE,MDR,MDRES,MDSIEN,BODY,SUBJECT,DEVIEN,MDORD,MDTEMP,REBOOK
"RTN","MDWCAN",61,0)
 S (MDHOLD,MDSIEN)=+MDI,(MDRES,REBOOK)=0,MDNOTE=""
"RTN","MDWCAN",62,0)
 ;D ALERT^MDHL7U3(MDSIEN) ; Builds the body of the mail message
"RTN","MDWCAN",63,0)
 I $G(^MDD(702,+MDSIEN,0))="" Q
"RTN","MDWCAN",64,0)
 S:+$P(^MDD(702,+MDSIEN,0),U,6) MDNOTE=$P(^MDD(702,MDSIEN,0),U,6)
"RTN","MDWCAN",65,0)
 S MDCANR=$$CANCEL^MDHL7B(MDHOLD) I +MDCANR<1 Q
"RTN","MDWCAN",66,0)
 Q:+MDNOTE
"RTN","MDWCAN",67,0)
 S MDAST=$$HL7CHK^MDHL7U3(+MDSIEN) I +MDAST<1 Q
"RTN","MDWCAN",68,0)
 ;D NOTICE^MDHL7U3(SUBJECT,.BODY,DEVIEN,DUZ) ; delete message
"RTN","MDWCAN",69,0)
 ;S MDFDA(702,DATA_",",.01)=""
"RTN","MDWCAN",70,0)
 ; Check for renal study to cancel as well
"RTN","MDWCAN",71,0)
 I $D(^MDK(704.202,+MDI)) K MDFDA S MDFDA(704.202,+MDI_",",.09)=0 D FILE^DIE("","MDFDA")
"RTN","MDWCAN",72,0)
 K MDFDA
"RTN","MDWCAN",73,0)
 S MDFDA(702,+MDI_",",.07)=""
"RTN","MDWCAN",74,0)
 S MDFDA(702,+MDI_",",.09)=6
"RTN","MDWCAN",75,0)
 D FILE^DIE("","MDFDA")
"RTN","MDWCAN",76,0)
 S MDORD=+$P($G(^MDD(702,+MDI,0)),"^",12) I +MDORD K ^MDD(702,"AION",+MDORD,+MDI)
"RTN","MDWCAN",77,0)
 ;N DA,DIK S DA=+MDSIEN,DIK="^MDD(702," D ^DIK
"RTN","MDWCAN",78,0)
 D GETLST^XPAR(.MDTEMP,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWCAN",79,0)
 F MDJ=0:0 S MDJ=$O(MDTEMP(MDJ)) Q:MDJ<1  S MDNK=$P($G(MDTEMP(MDJ)),"^",2) D
"RTN","MDWCAN",80,0)
 .I $P(MDNK,";",2)'=$P(^MDD(702,+MDI,0),"^",4) K MDTEMP(MDJ)
"RTN","MDWCAN",81,0)
 F MDJ=0:0 S MDJ=$O(MDTEMP(MDJ)) Q:MDJ<1!(REBOOK>0)  S MDR=$$GETAPPT^MDWOR($P($G(^MDD(702,+MDI,0)),"^"),+$P($G(MDTEMP(MDJ)),"^",2)) D
"RTN","MDWCAN",82,0)
 .I +MDR&($P(MDR,"^",1)>DT) S REBOOK=1
"RTN","MDWCAN",83,0)
 Q:'REBOOK
"RTN","MDWCAN",84,0)
 K MDFDA
"RTN","MDWCAN",85,0)
 S MDFDA(702,"+1,",.01)=$P($G(^MDD(702,+MDI,0)),"^")
"RTN","MDWCAN",86,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWCAN",87,0)
 S MDFDA(702,"+1,",.03)=$P($G(^MDD(702,+MDI,0)),"^",3)
"RTN","MDWCAN",88,0)
 S MDFDA(702,"+1,",.04)=$P($G(^MDD(702,+MDI,0)),"^",4)
"RTN","MDWCAN",89,0)
 S MDFDA(702,"+1,",.05)=$P($G(^MDD(702,+MDI,0)),"^",5)
"RTN","MDWCAN",90,0)
 S MDFDA(702,"+1,",.09)=0
"RTN","MDWCAN",91,0)
 S MDFDA(702,"+1,",.11)=$P($G(^MDD(702,+MDI,0)),"^",11)
"RTN","MDWCAN",92,0)
 D UPDATE^DIE("","MDFDA","","MDERR") K MDFDA
"RTN","MDWCAN",93,0)
 Q
"RTN","MDWOR")
0^29^B40304234^B40687442
"RTN","MDWOR",1,0)
MDWOR ; HOIFO/NCA - Main Routine to Decode HL7 ;9/8/08  15:20
"RTN","MDWOR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11,21**;Apr 01,2004;Build 30
"RTN","MDWOR",3,0)
 ; Reference IA# 2263 [Supported] XPAR calls
"RTN","MDWOR",4,0)
 ;               3468 [Subscription] Call GMRCCP.
"RTN","MDWOR",5,0)
 ;               3071 [Subscription] Call $$PKGID^ORX8.
"RTN","MDWOR",6,0)
 ;              10035 [Supported] Access DPT("B"
"RTN","MDWOR",7,0)
 ;              10040 [Supported] Access SC(
"RTN","MDWOR",8,0)
 ;              10061 [Supported] VADPT call
"RTN","MDWOR",9,0)
 ;              10103 [Supported] XLFDT calls
"RTN","MDWOR",10,0)
EN(MDMSG) ; Entry Point for CPRS and pass MSG in MDMSG
"RTN","MDWOR",11,0)
 N DFN,MDCON,MDCPROC,MDCANC,MDCANR,MDFN,MDIFN,MDINST,MDINT,MDFLG,MDL,MDIN,MDINP,MDINST,MDLOC,MDNAM,MDOBC,MDOBX,MDOPRO,MDPROC,MDPAT
"RTN","MDWOR",12,0)
 N MDLL,MDK1,MDPROV,MDREQ,MDQTIM,MDROOT,MDRR,MDSINP,MDVSTD,MDX S MDVSTD=""
"RTN","MDWOR",13,0)
 S (MDINP,MDFLG,MDCANC,MDOBC)=0 F MDL=0:0 S MDL=$O(MDMSG(MDL)) Q:MDL<1!(MDFLG)  S MDX=$G(MDMSG(MDL)) D
"RTN","MDWOR",14,0)
 .I $E(MDX,1,3)="MSH" D MSH Q
"RTN","MDWOR",15,0)
 .I $E(MDX,1,3)="PID" D PID Q
"RTN","MDWOR",16,0)
 .I $E(MDX,1,3)="PV1" D PV1 Q
"RTN","MDWOR",17,0)
 .I $E(MDX,1,3)="ORC" D ORC Q
"RTN","MDWOR",18,0)
 .I $E(MDX,1,3)="OBR" D OBR Q
"RTN","MDWOR",19,0)
 .I $E(MDX,1,3)="OBX" D:MDOBC<1 OBX Q
"RTN","MDWOR",20,0)
 .Q
"RTN","MDWOR",21,0)
 D GETLST^XPAR(.MDLL,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWOR",22,0)
 I 'MDFLG,'MDCANC,MDVSTD="" F MDK1=0:0 S MDK1=$O(MDLL(MDK1)) Q:MDK1<1  S MDROOT=$G(MDLL(MDK1)) I +$P(MDROOT,";",2)=MDPROC D  Q:+MDRR
"RTN","MDWOR",23,0)
 .S MDRR=0,MDIFN=MDFN,MDRR=$$GETAPPT(MDIFN,+$P(MDROOT,"^",2))
"RTN","MDWOR",24,0)
 .S:+MDRR MDVSTD="A"_";"_$P(MDRR,"^",1)_";"_+$P(MDROOT,"^",2)
"RTN","MDWOR",25,0)
 I 'MDFLG,'MDCANC S MDATA="+1,^"_MDPROC_"^"_+MDCON_"^"_MDINST_"^"_MDVSTD D CHKIN(MDFN,MDREQ,MDPROV,MDATA,MDVSTD)
"RTN","MDWOR",26,0)
 Q
"RTN","MDWOR",27,0)
MSH ; Decode MSH
"RTN","MDWOR",28,0)
 I $P(MDX,"|",2)'="^~\&" S MDFLG=1 Q
"RTN","MDWOR",29,0)
 I $P(MDX,"|",3)'="ORDER ENTRY" S MDFLG=1 Q
"RTN","MDWOR",30,0)
 I $P(MDX,"|",9)'="ORM" S MDFLG=1 Q
"RTN","MDWOR",31,0)
 Q
"RTN","MDWOR",32,0)
PID ; Check PID
"RTN","MDWOR",33,0)
 S MDNAM=$P(MDX,"|",6),DFN=$P(MDX,"|",4)
"RTN","MDWOR",34,0)
 I '$D(^DPT("B",$E(MDNAM,1,30),DFN)) S MDFLG=1
"RTN","MDWOR",35,0)
 S MDFN=DFN
"RTN","MDWOR",36,0)
 Q
"RTN","MDWOR",37,0)
PV1 ; Check PV1
"RTN","MDWOR",38,0)
 S MDPAT=$P(MDX,"|",3) I MDPAT'?1U!("IO"'[MDPAT) S MDFLG=1 Q
"RTN","MDWOR",39,0)
 I MDPAT="I" S MDINP=1
"RTN","MDWOR",40,0)
 S MDLOC=+$P(MDX,"|",4) I $G(^SC(MDLOC,0))="" S MDFLG=1 Q
"RTN","MDWOR",41,0)
 S:MDINP>0 MDLOC=""
"RTN","MDWOR",42,0)
 Q
"RTN","MDWOR",43,0)
ORC ; Check ORC
"RTN","MDWOR",44,0)
 I $P(MDX,"|",2)="NW" D NEW Q
"RTN","MDWOR",45,0)
 I $P(MDX,"|",2)="DC" D CANCEL Q
"RTN","MDWOR",46,0)
 S MDFLG=1
"RTN","MDWOR",47,0)
 Q
"RTN","MDWOR",48,0)
OBX ; Check OBX
"RTN","MDWOR",49,0)
 N %,ANSWER,MDCV,MDOBX
"RTN","MDWOR",50,0)
 S MDOBX=$P(MDX,"|",6)
"RTN","MDWOR",51,0)
 I '+$$GET^XPAR("SYS","MD USE APPT WITH PROCEDURE",1) S MDOBC=MDOBC+1 Q
"RTN","MDWOR",52,0)
 S MDVSTD=$P(MDOBX,"Visit Date: ",2)
"RTN","MDWOR",53,0)
 S MDCV=$P(MDVSTD," ",1,2)
"RTN","MDWOR",54,0)
 I MDCV=""!(MDCV["UNKNOWN") S MDFLG=1 Q
"RTN","MDWOR",55,0)
 S MDVSTD=$P(MDCV," ")_"@"_$P(MDCV," ",2)
"RTN","MDWOR",56,0)
 D DT^DILF("T",MDVSTD,.ANSWER)
"RTN","MDWOR",57,0)
 S:ANSWER<0 ANSWER=""
"RTN","MDWOR",58,0)
 S MDVSTD=ANSWER I MDVSTD="" S MDFLG=1 Q
"RTN","MDWOR",59,0)
 I +MDLOC>0 S MDVSTD="A;"_MDVSTD_";"_MDLOC
"RTN","MDWOR",60,0)
 E  D NOW^%DTC S MDVSTD=%
"RTN","MDWOR",61,0)
 S MDOBC=MDOBC+1
"RTN","MDWOR",62,0)
 Q
"RTN","MDWOR",63,0)
NEW ; New Order Segment
"RTN","MDWOR",64,0)
 S MDIFN=+$P(MDX,"|",3) I 'MDIFN S MDFLG=1 Q
"RTN","MDWOR",65,0)
 S MDPROV=+$P(MDX,"|",11) I 'MDPROV S MDFLG=1 Q
"RTN","MDWOR",66,0)
 S MDQTIM=$P(MDX,"|",8),MDQTIM=$P(MDQTIM,"^",6)
"RTN","MDWOR",67,0)
 S MDREQ=$P(MDX,"|",16) S MDREQ=$$FMDTE(MDREQ) I 'MDREQ S MDFLG=1 Q
"RTN","MDWOR",68,0)
 S MDREQ=$S(MDQTIM="Z24":$$FMADD^XLFDT(MDREQ,0,24),MDQTIM="Z48":$$FMADD^XLFDT(MDREQ,0,48),MDQTIM="Z72":$$FMADD^XLFDT(MDREQ,0,72),MDQTIM="ZW":$$FMADD^XLFDT(MDREQ,7),MDQTIM="ZM":$$FMADD^XLFDT(MDREQ,30),1:MDREQ)
"RTN","MDWOR",69,0)
 ; Retrieve Consult Number
"RTN","MDWOR",70,0)
 N MDFDA
"RTN","MDWOR",71,0)
 S MDCON=$$PKGID^ORX8(MDIFN) I 'MDCON S MDFLG=1 Q
"RTN","MDWOR",72,0)
 Q
"RTN","MDWOR",73,0)
OBR ; Check OBR
"RTN","MDWOR",74,0)
 S MDPROC=$P(MDX,"|",5)
"RTN","MDWOR",75,0)
 I $E($P(MDPROC,"^",6),3,5)'["PRC" S MDFLG=1 Q
"RTN","MDWOR",76,0)
 S MDCPROC=$P(MDPROC,"^",4) I 'MDCPROC S MDFLG=1 Q
"RTN","MDWOR",77,0)
 ; Get Procedure for CP IEN
"RTN","MDWOR",78,0)
 S MDPROC=$$CPROC^GMRCCP(MDCPROC) I 'MDPROC S MDFLG=1 Q
"RTN","MDWOR",79,0)
 S MDSINP=$$HIGHV(MDPROC) I '+MDSINP S MDFLG=1 Q
"RTN","MDWOR",80,0)
 S (MDINST,MDINT)=0 F MDIN=0:0 S MDIN=$O(^MDS(702.01,MDPROC,.1,MDIN)) Q:MDIN<1!(+MDINST)  S MDINT=+$G(^(MDIN,0)) D
"RTN","MDWOR",81,0)
 .I +$$GET1^DIQ(702.09,+MDINT,".13","I") S MDINST=MDINT Q
"RTN","MDWOR",82,0)
 I +$P(MDSINP,"^",2)=2 D  Q
"RTN","MDWOR",83,0)
 .I +MDINP S MDVSTD="",MDOBC=MDOBC+1 Q
"RTN","MDWOR",84,0)
 .S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",85,0)
 I +$P(MDSINP,"^",2)=3 D  Q
"RTN","MDWOR",86,0)
 .I +MDINP S MDVSTD="",MDOBC=MDOBC+1 Q
"RTN","MDWOR",87,0)
 I +$P(MDSINP,"^",2)=1 D  Q
"RTN","MDWOR",88,0)
 .I '+MDINP S MDVSTD="" Q
"RTN","MDWOR",89,0)
 .S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",90,0)
 ;I +MDINP&('$P(^MDS(702.01,MDPROC,0),"^",5)) S MDFLG=1 Q
"RTN","MDWOR",91,0)
 I +MDINP S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",92,0)
 S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",93,0)
 Q
"RTN","MDWOR",94,0)
CANCEL ; Cancel/Discontinue
"RTN","MDWOR",95,0)
 K MDR S MDIFN=+$P(MDX,"|",3),MDCON=+$P(MDX,"|",4),MDCANC=1
"RTN","MDWOR",96,0)
 I 'MDIFN S MDFLG=1 Q
"RTN","MDWOR",97,0)
 I 'MDCON S MDFLG=1 Q
"RTN","MDWOR",98,0)
 S MDPROV=+$P(MDX,"|",13) I 'MDPROV S MDFLG=1 Q
"RTN","MDWOR",99,0)
 S MDREQ=$P(MDX,"|",16) I 'MDREQ S MDFLG=1 Q
"RTN","MDWOR",100,0)
 S MDINST=$O(^MDD(702,"ACON",MDCON,0)) Q:'MDINST
"RTN","MDWOR",101,0)
 Q:$G(^MDD(702,+MDINST,0))=""
"RTN","MDWOR",102,0)
 I "5"[$P(^MDD(702,+MDINST,0),U,9) S MDCANR=$$CANCEL^MDHL7B(+MDINST)
"RTN","MDWOR",103,0)
 N MDFDA S MDFDA(702,MDINST_",",.09)=6
"RTN","MDWOR",104,0)
 D FILE^DIE("K","MDFDA") K MDFDA
"RTN","MDWOR",105,0)
 N MDHEMO S MDHEMO=+$$GET1^DIQ(702,+MDINST,".04:.06","I")
"RTN","MDWOR",106,0)
 Q:MDHEMO<2
"RTN","MDWOR",107,0)
 Q:$G(^MDK(704.202,+MDINST,0))=""
"RTN","MDWOR",108,0)
 S MDFDA(704.202,+MDINST_",",.09)=0
"RTN","MDWOR",109,0)
 D FILE^DIE("","MDFDA")
"RTN","MDWOR",110,0)
 K ^MDK(704.202,"AS",1,+MDINST)
"RTN","MDWOR",111,0)
 S ^MDK(704.202,"AS",0,+MDINST)=""
"RTN","MDWOR",112,0)
 Q
"RTN","MDWOR",113,0)
CHKIN(MDFN,MDREQ,MDPROV,MDATA,MDVSTD) ; [Procedure] Check In Study
"RTN","MDWOR",114,0)
 N MDX1,MDFDA,MDIEN,MDIENS,MDERR,MDHL7,MDHOLD,MDSCHD,MDMAXD,MDXY,MDNOW
"RTN","MDWOR",115,0)
 F MDX1=2:1:5 D
"RTN","MDWOR",116,0)
 .I $P(MDATA,U,MDX1)]"" S MDFDA(702,$P(MDATA,U,1),$P("^.04^.05^.11^.07",U,MDX1))=$P(MDATA,U,MDX1)
"RTN","MDWOR",117,0)
 ; Remove code after instrument testing available
"RTN","MDWOR",118,0)
 ; End of code removal after instrument available for testin
"RTN","MDWOR",119,0)
 S MDSCHD=$S($L(MDVSTD,";")=1:MDVSTD,1:$P(MDVSTD,";",2)),MDMAXD=DT+.24
"RTN","MDWOR",120,0)
 S MDFDA(702,$P(MDATA,U,1),.09)=$S(MDSCHD="":0,MDSCHD>MDMAXD:0,1:5)  ; Status = Checked-In
"RTN","MDWOR",121,0)
 I $P(MDATA,U,1)="+1," D
"RTN","MDWOR",122,0)
 .S MDFDA(702,"+1,",.01)=MDFN
"RTN","MDWOR",123,0)
 .S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWOR",124,0)
 .S MDFDA(702,"+1,",.03)=MDPROV
"RTN","MDWOR",125,0)
 .S:+MDSCHD MDFDA(702,"+1,",.14)=MDSCHD
"RTN","MDWOR",126,0)
 .D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)
"RTN","MDWOR",127,0)
 .Q:MDSCHD>MDMAXD!(MDSCHD="")
"RTN","MDWOR",128,0)
 .S MDIENS=MDIEN(1)_",",MDXY=+$P(MDATA,U,2),MDHOLD="" I +MDXY D
"RTN","MDWOR",129,0)
 ..Q:$P(^MDS(702.01,MDXY,0),U,6)'=2
"RTN","MDWOR",130,0)
 ..S MDHOLD=$P($G(^MDD(702,MDIEN(1),0)),"^",7),MDNOW=$$NOW^XLFDT()
"RTN","MDWOR",131,0)
 ..S $P(^MDD(702,MDIEN(1),0),"^",7)=$S(MDNOW>MDSCHD:MDSCHD,1:MDNOW)
"RTN","MDWOR",132,0)
 .S MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDWOR",133,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWOR",134,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWOR",135,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWOR",136,0)
 Q:MDSCHD>MDMAXD!(MDSCHD="")
"RTN","MDWOR",137,0)
 D:+$G(MDIENS)
"RTN","MDWOR",138,0)
 .S MDXY=+$P(MDATA,U,2) Q:'MDXY
"RTN","MDWOR",139,0)
 .I $P(^MDS(702.01,MDXY,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDWOR",140,0)
 ..D CP^MDKUTL(+MDIENS)
"RTN","MDWOR",141,0)
 ..S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD
"RTN","MDWOR",142,0)
 ..S MDFDA(702,+MDIENS_",",.09)=5
"RTN","MDWOR",143,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWOR",144,0)
 Q
"RTN","MDWOR",145,0)
FMDTE(DATE) ; Convert HL-7 formatted date to a Fileman formatted date
"RTN","MDWOR",146,0)
 N X
"RTN","MDWOR",147,0)
 S X="" I DATE D
"RTN","MDWOR",148,0)
 .S X=$$HL7TFM^XLFDT(DATE,"L")
"RTN","MDWOR",149,0)
 Q X
"RTN","MDWOR",150,0)
HIGHV(MDHV) ; Return flag indicator whether procedure is use for auto check-in
"RTN","MDWOR",151,0)
 N MDANS,MDK,MDKY,MDLST S MDANS=0
"RTN","MDWOR",152,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CHECK-IN PROCEDURE LIST")
"RTN","MDWOR",153,0)
 F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDKY=$G(MDLST(MDK)) D
"RTN","MDWOR",154,0)
 .I MDHV=+$P(MDKY,"^") S MDANS=MDKY
"RTN","MDWOR",155,0)
 Q MDANS
"RTN","MDWOR",156,0)
GETAPPT(MDDPAT,MDDA) ; Get appointment
"RTN","MDWOR",157,0)
 N DFN,MDALP,MDARES K ^UTILITY("VASD",$J) S DFN=MDDPAT
"RTN","MDWOR",158,0)
 S X1=DT,X2=365 D C^%DTC S VASD("T")=X+.24,VASD("F")=DT,VASD("W")="129",VASD("C",+MDDA)=+MDDA D SDA^VADPT
"RTN","MDWOR",159,0)
 S MDARES=0 F MDALP=0:0 S MDALP=$O(^UTILITY("VASD",$J,MDALP)) Q:MDALP<1  S MDARES=$G(^(MDALP,"I")) Q
"RTN","MDWOR",160,0)
 K ^UTILITY("VASD",$J),VASD,X1,X2,X
"RTN","MDWOR",161,0)
 Q MDARES
"RTN","MDWORSR")
0^30^B57541495^B57396407
"RTN","MDWORSR",1,0)
MDWORSR ; HOIFO/NCA - Daily Schedule Studies;7/2/04  12:39 ;10/15/08  13:39
"RTN","MDWORSR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11,21**;Apr 01,2004;Build 30
"RTN","MDWORSR",3,0)
 ; Reference IA# 2263 [Supported] XPAR calls
"RTN","MDWORSR",4,0)
 ;               3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDWORSR",5,0)
 ;               3468 [Subscription] Call GMRCCP
"RTN","MDWORSR",6,0)
 ;               3869 [Subscription] SDAMA202 calls
"RTN","MDWORSR",7,0)
 ;               10035 [Supported] Patient File Access
"RTN","MDWORSR",8,0)
 ;               10103 [Supported] XLFDT calls
"RTN","MDWORSR",9,0)
 ;
"RTN","MDWORSR",10,0)
EN1 ; Entry Point to process scheduled studies
"RTN","MDWORSR",11,0)
 N MDCON,MDERR,MDFDA,MDHOLD,MDL,MDL1,MDMAXD,MDNOW,MDSTAT,MDX,MDXY
"RTN","MDWORSR",12,0)
 S MDMAXD=DT+.24
"RTN","MDWORSR",13,0)
 S MDL=DT F  S MDL=$O(^MDD(702,"ASD",MDL)) Q:MDL<1!(MDL>MDMAXD)  F MDL1=0:0 S MDL1=$O(^MDD(702,"ASD",MDL,MDL1)) Q:MDL1<1  S MDX=$G(^MDD(702,MDL1,0)) D
"RTN","MDWORSR",14,0)
 .K MDFDA
"RTN","MDWORSR",15,0)
 .S MDCON=+$P(MDX,"^",5) Q:'MDCON
"RTN","MDWORSR",16,0)
 .S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"E")
"RTN","MDWORSR",17,0)
 .Q:MDSTAT="DISCONTINUED"!(MDSTAT="CANCELLED")
"RTN","MDWORSR",18,0)
 .Q:+$P(MDX,"^",9)>0
"RTN","MDWORSR",19,0)
 .S MDIENS=MDL1_",",MDXY=+$P(MDX,"^",4),MDHOLD="" I MDXY D
"RTN","MDWORSR",20,0)
 ..S MDHOLD=$P($G(^MDD(702,+MDL1,0)),"^",7),MDNOW=$$NOW^XLFDT()
"RTN","MDWORSR",21,0)
 ..S $P(^MDD(702,+MDL1,0),"^",7)=$S(MDNOW>MDL:MDL,1:MDNOW)
"RTN","MDWORSR",22,0)
 .S MDHL7=$$SUB^MDHL7B(MDL1)
"RTN","MDWORSR",23,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",24,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.02)=$$NOW^XLFDT(),MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",25,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",26,0)
 .S MDXY=+$P(MDX,"^",4) Q:'MDXY
"RTN","MDWORSR",27,0)
 .I $P(^MDS(702.01,MDXY,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDWORSR",28,0)
 ..D CP^MDKUTL(+MDIENS)
"RTN","MDWORSR",29,0)
 ..S:$G(MDHOLD)'="" MDFDA(702,MDIENS,.07)=MDHOLD
"RTN","MDWORSR",30,0)
 ..S MDFDA(702,MDIENS,.09)=5
"RTN","MDWORSR",31,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",32,0)
 Q
"RTN","MDWORSR",33,0)
CLINICPT ; Check-in CP study with multiple results
"RTN","MDWORSR",34,0)
 N MD,MDCDT,MDCL,MDCOM,MDCON,MDDT,MDDX,MDEND,MDERR,MDFDA,MDHEMO,MDHL7,MDIEN,MDIENS,MDK,MDLP,MDLST,MDMULT,MDNODE,MDNUM,MDPT,MDRET,MDSCHD,MDVSTR,MDY,MDY1,MDYR,X,X1,X2
"RTN","MDWORSR",35,0)
 N MDATYP,MDHOLD,MDLST1,MDLST2,MDNEW,MDT,MDY3,MDY4 S MDDT=DT\1,MDEND=DT+.24 N MDINP K ^TMP($J,"SDAMA202","GETPLIST"),^TMP("MDSTATUS",$J) S MDCOM=0,MDHOLD=""
"RTN","MDWORSR",36,0)
 K ^TMP("MDMULT",$J),^TMP("MDCLINIC",$J),^TMP("MDLST",$J)
"RTN","MDWORSR",37,0)
 S MDNUM=$$GET^XPAR("SYS","MD COMPL PROC DISPLAY DAYS",1)
"RTN","MDWORSR",38,0)
 I +MDNUM>0 S X1=DT,X2=-MDNUM D C^%DTC S MDCOM=X
"RTN","MDWORSR",39,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWORSR",40,0)
 F MDLP=0:0 S MDLP=$O(^MDD(702,"AS",0,MDLP)) Q:MDLP<1  D
"RTN","MDWORSR",41,0)
 .S MDY=$G(^MDD(702,MDLP,0)) Q:+$P(MDY,"^",9)>0
"RTN","MDWORSR",42,0)
 .Q:$P(MDY,"^",7)'=""
"RTN","MDWORSR",43,0)
 .Q:'+$P(MDY,"^",5)!($P(MDY,"^",6)'="")
"RTN","MDWORSR",44,0)
 .Q:'+MDY
"RTN","MDWORSR",45,0)
 .I '+$G(^TMP("MDSTATUS",$J,+MDY,+$P(MDY,"^",4))) S ^TMP("MDSTATUS",$J,+MDY,+$P(MDY,"^",4))=+MDLP
"RTN","MDWORSR",46,0)
 .Q
"RTN","MDWORSR",47,0)
 ; Combine clinics with multiple procedures to regular clinics
"RTN","MDWORSR",48,0)
 S MDLST2=$S(+MDLST>0:MDLST,1:0)
"RTN","MDWORSR",49,0)
 ; Match new studies with 0 status to appointments
"RTN","MDWORSR",50,0)
 N MDXX K MDY F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDY=$P($G(MDLST(MDK)),"^",2) I +$P(MDY,";",2)>0 S MDCL=+MDY D
"RTN","MDWORSR",51,0)
 .S:$G(^TMP("MDCLINIC",$J,+MDCL))="" ^TMP("MDCLINIC",$J,+MDCL)=+MDCL
"RTN","MDWORSR",52,0)
 .S ^TMP("MDLST",$J,+MDCL,+$P(MDY,";",2))=+$P(MDY,";",2)
"RTN","MDWORSR",53,0)
 .S MDMULT=+$$GET1^DIQ(702.01,+$P(MDY,";",2)_",",.12,"I")
"RTN","MDWORSR",54,0)
 .S MDHEMO=+$$GET1^DIQ(702.01,+$P(MDY,";",2)_",",.06,"I")
"RTN","MDWORSR",55,0)
 .Q:MDMULT'=1&(MDHEMO<2)
"RTN","MDWORSR",56,0)
 .S ^TMP("MDMULT",$J,+MDK)=+MDCL_";"_+$P(MDY,";",2)
"RTN","MDWORSR",57,0)
 .Q
"RTN","MDWORSR",58,0)
 K MDLST,MDY F MDK=0:0 S MDK=$O(^TMP("MDCLINIC",$J,MDK)) Q:MDK<1  S MDY=MDK D
"RTN","MDWORSR",59,0)
 .K ^TMP($J,"SDAMA202","GETPLIST") S MDCL=+MDY
"RTN","MDWORSR",60,0)
 .D GETPLIST^SDAMA202(+MDY,"1;4;3","R",MDDT,MDEND,.MDRET,"")
"RTN","MDWORSR",61,0)
 .F MD=0:0 S MD=$O(^TMP($J,"SDAMA202","GETPLIST",MD)) Q:'MD  D
"RTN","MDWORSR",62,0)
 ..S MDY1=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,4)) Q:MDY1<1
"RTN","MDWORSR",63,0)
 ..S MDSCHD=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,1))
"RTN","MDWORSR",64,0)
 ..S MDATYP=$G(^TMP($J,"SDAMA202","GETPLIST",MD,3)) Q:MDATYP=""
"RTN","MDWORSR",65,0)
 ..Q:"RINT"'[MDATYP
"RTN","MDWORSR",66,0)
 ..S MDT=MDK,MDDX=+$$MATCH(+MDY1,MDT)
"RTN","MDWORSR",67,0)
 ..I 'MDDX S MDY4=$$GPRO(+MDY1,MDT),MDY3=$P(MDY4,"^",6),MDY4=$P(MDY4,"^",5) Q:'MDY4  S MDDX=+$$ADD(+MDY1,+MDY3,+MDY4,MDT,MDSCHD) Q:'MDDX
"RTN","MDWORSR",68,0)
 ..S MDMULT=+$$GET1^DIQ(702,+MDDX,".04:.12","I")
"RTN","MDWORSR",69,0)
 ..S MDHEMO=+$$GET1^DIQ(702,+MDDX,".04:.06","I"),MDIENS=+MDDX_","
"RTN","MDWORSR",70,0)
 ..S MDFDA(702,MDIENS,.02)=$$NOW^XLFDT()
"RTN","MDWORSR",71,0)
 ..S MDFDA(702,MDIENS,.07)="A;"_MDSCHD_";"_MDCL
"RTN","MDWORSR",72,0)
 ..S MDFDA(702,MDIENS,.14)=MDSCHD
"RTN","MDWORSR",73,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR") K MDFDA
"RTN","MDWORSR",74,0)
 ..I MDHEMO=2 S MDHOLD=$P($G(^MDD(702,+MDIENS,0)),"^",7),MDNEW=$$NOW^XLFDT(),$P(^MDD(702,+MDIENS,0),"^",7)=$S(MDNEW>MDSCHD:MDSCHD,1:MDNEW)
"RTN","MDWORSR",75,0)
 ..S MDHL7=$$SUB^MDHL7B(+MDIENS)
"RTN","MDWORSR",76,0)
 ..I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",77,0)
 ..I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",78,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",79,0)
 ..Q:'+$G(MDIENS)
"RTN","MDWORSR",80,0)
 ..I MDHEMO=2 D CP^MDKUTL(+MDIENS) S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD S MDFDA(702,+MDIENS_",",.09)=5 D FILE^DIE("","MDFDA","MDERR") K MDFDA
"RTN","MDWORSR",81,0)
 ..Q
"RTN","MDWORSR",82,0)
 .Q
"RTN","MDWORSR",83,0)
 ; Match the rest of appointments with previous studies
"RTN","MDWORSR",84,0)
 N MDGET,MDINST S X1=DT,X2=-365 D C^%DTC S MDCDT=X
"RTN","MDWORSR",85,0)
 K MDY F MDK=0:0 S MDK=$O(^TMP("MDMULT",$J,MDK)) Q:MDK<1  S MDY=$G(^(MDK)) I +$P(MDY,";",2)>0 S MDCL=+MDY D
"RTN","MDWORSR",86,0)
 .K ^TMP($J,"SDAMA202","GETPLIST")
"RTN","MDWORSR",87,0)
 .D GETPLIST^SDAMA202(+MDY,"1;4;3","R",MDDT,MDEND,.MDRET,"")
"RTN","MDWORSR",88,0)
 .F MD=0:0 S MD=$O(^TMP($J,"SDAMA202","GETPLIST",MD)) Q:'MD  D
"RTN","MDWORSR",89,0)
 ..S MDINP=0
"RTN","MDWORSR",90,0)
 ..S MDY1=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,4)) Q:MDY1<1
"RTN","MDWORSR",91,0)
 ..S MDSCHD=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,1))
"RTN","MDWORSR",92,0)
 ..S MDATYP=$G(^TMP($J,"SDAMA202","GETPLIST",MD,3))
"RTN","MDWORSR",93,0)
 ..Q:"RINT"'[MDATYP
"RTN","MDWORSR",94,0)
 ..S MDPT=MDY1 Q:+$$GSTUDY(MDPT,MDSCHD)
"RTN","MDWORSR",95,0)
 ..S MDDX=$$GETC(MDPT,+$P(MDY,";",2)) Q:'+MDDX
"RTN","MDWORSR",96,0)
 ..S MDNODE=$G(^MDD(702,+MDDX,0))
"RTN","MDWORSR",97,0)
 ..S:$G(^DPT(MDY1,.105))'="" MDINP=1
"RTN","MDWORSR",98,0)
 ..S MDCON=$P(MDNODE,"^",5) Q:'MDCON
"RTN","MDWORSR",99,0)
 ..S MDVSTR=$P(MDNODE,"^",7) Q:MDVSTR=""
"RTN","MDWORSR",100,0)
 ..S MDMULT=+$$GET1^DIQ(702,+MDDX,".04:.12","I")
"RTN","MDWORSR",101,0)
 ..S MDHEMO=+$$GET1^DIQ(702,+MDDX,".04:.06","I")
"RTN","MDWORSR",102,0)
 ..S MDYR=$S(MDMULT<1:MDCOM,1:MDCDT)
"RTN","MDWORSR",103,0)
 ..Q:$P(MDNODE,"^",2)<MDYR
"RTN","MDWORSR",104,0)
 ..Q:'$P(MDNODE,"^",9)
"RTN","MDWORSR",105,0)
 ..Q:$P(MDNODE,"^",9)>3
"RTN","MDWORSR",106,0)
 ..Q:$P(MDVSTR,";",2)=MDSCHD
"RTN","MDWORSR",107,0)
 ..S MDINST=+$$GINST(+$P(MDNODE,"^",4)) Q:'MDINST
"RTN","MDWORSR",108,0)
 ..K MDFDA,MDERR,MDIEN
"RTN","MDWORSR",109,0)
 ..S MDFDA(702,"+1,",.01)=MDY1
"RTN","MDWORSR",110,0)
 ..S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWORSR",111,0)
 ..S MDFDA(702,"+1,",.03)=$P(MDNODE,"^",3)
"RTN","MDWORSR",112,0)
 ..S MDFDA(702,"+1,",.04)=$P(MDNODE,"^",4)
"RTN","MDWORSR",113,0)
 ..S MDFDA(702,"+1,",.05)=MDCON
"RTN","MDWORSR",114,0)
 ..S MDFDA(702,"+1,",.07)="A;"_MDSCHD_";"_MDCL
"RTN","MDWORSR",115,0)
 ..S MDFDA(702,"+1,",.11)=+MDINST
"RTN","MDWORSR",116,0)
 ..S MDFDA(702,"+1,",.14)=MDSCHD
"RTN","MDWORSR",117,0)
 ..D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)  K MDFDA
"RTN","MDWORSR",118,0)
 ..S MDIENS=MDIEN(1)_"," I MDHEMO=2 S MDHOLD=$P($G(^MDD(702,MDIEN(1),0)),"^",7),MDNOW=$$NOW^XLFDT(),$P(^MDD(702,MDIEN(1),0),"^",7)=$S(MDNOW>MDSCHD:MDSCHD,1:MDNOW)
"RTN","MDWORSR",119,0)
 ..S MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDWORSR",120,0)
 ..I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",121,0)
 ..I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",122,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",123,0)
 ..Q:'+$G(MDIENS)
"RTN","MDWORSR",124,0)
 ..I MDHEMO=2 D CP^MDKUTL(+MDIENS) K MDFDA S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD S MDFDA(702,+MDIENS_",",.09)=5 D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",125,0)
 K ^TMP($J,"SDAMA202","GETPLIST"),^TMP("MDSTATUS",$J),MDFDA
"RTN","MDWORSR",126,0)
 K ^TMP("MDCLINIC",$J),^TMP("MDMULT",$J),^TMP("MDLST",$J)
"RTN","MDWORSR",127,0)
 Q
"RTN","MDWORSR",128,0)
GETC(MDPAT,MDDA) ; Get consult date
"RTN","MDWORSR",129,0)
 N MDX,MDCF S MDCF=0 K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,+MDDA,$NA(^TMP("MDTMP",$J)))
"RTN","MDWORSR",130,0)
 S MDX=$O(^TMP("MDTMP",$J,""),-1) Q:'+MDX 0
"RTN","MDWORSR",131,0)
 I "saprc"'[$P($G(^TMP("MDTMP",$J,MDX)),U,4) S MDX=$O(^TMP("MDTMP",$J,MDX),-1) Q:'+MDX 0
"RTN","MDWORSR",132,0)
 I "saprc"[$P($G(^TMP("MDTMP",$J,MDX)),U,4) S MDCF=$P($G(^TMP("MDTMP",$J,MDX)),U,5)_"^"_$P($G(^TMP("MDTMP",$J,MDX)),U,1)
"RTN","MDWORSR",133,0)
 K ^TMP("MDTMP",$J)
"RTN","MDWORSR",134,0)
 Q $S(+MDCF:+$O(^MDD(702,"ACON",+MDCF,""),-1)_"^"_$P(MDCF,"^",2)_"^"_+MDCF_"^"_$P(MDCF,"^",6),1:0)
"RTN","MDWORSR",135,0)
GINST(MDDA) ; Get instrument from CP Definition
"RTN","MDWORSR",136,0)
 N MDIN,MDINT,Y1 S (MDINT,Y1)=0
"RTN","MDWORSR",137,0)
 F MDIN=0:0 S MDIN=$O(^MDS(702.01,+MDDA,.1,MDIN)) Q:MDIN<1!(+Y1)  S MDINT=+$G(^(MDIN,0)) I +$$GET1^DIQ(702.09,MDINT,".13","I") S Y1=MDINT
"RTN","MDWORSR",138,0)
 Q Y1
"RTN","MDWORSR",139,0)
GSTUDY(MDPAT,MDDA) ;Get study for scheduled date/time
"RTN","MDWORSR",140,0)
 N MDIN,Y1 S Y1=0
"RTN","MDWORSR",141,0)
 F MDIN=0:0 S MDIN=$O(^MDD(702,"ASD",MDDA,MDIN)) Q:MDIN<1!(Y1>0)  D
"RTN","MDWORSR",142,0)
 .S:$P($G(^MDD(702,MDIN,0)),"^")=MDPAT Y1=1
"RTN","MDWORSR",143,0)
 Q Y1
"RTN","MDWORSR",144,0)
GPRO(MDPAT,MDCLIN) ; Get procedure for study
"RTN","MDWORSR",145,0)
 N MDX,MDCF,MDCFX S MDCF="" K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,,$NA(^TMP("MDTMP",$J)))
"RTN","MDWORSR",146,0)
 S MDX=0 F  S MDX=$O(^TMP("MDTMP",$J,MDX)) Q:'MDX!(MDCF'="")  D:"sap"[$P(^(MDX),U,4)
"RTN","MDWORSR",147,0)
 .S MDCFX=$G(^TMP("MDTMP",$J,MDX)) Q:'+$G(^TMP("MDLST",$J,MDCLIN,+$P(MDCFX,"^",6)))
"RTN","MDWORSR",148,0)
 .Q:+$O(^MDD(702,"ACON",+$P(MDCFX,"^",5),0))  S MDCF=MDCFX Q
"RTN","MDWORSR",149,0)
 K ^TMP("MDTMP",$J)
"RTN","MDWORSR",150,0)
 Q $S(MDCF'="":MDCF,1:0)
"RTN","MDWORSR",151,0)
MATCH(MDPAT,MDCLIN) ; Match study to appointment
"RTN","MDWORSR",152,0)
 N MDI,MDY2 S MDY2=0
"RTN","MDWORSR",153,0)
 F MDI=0:0 S MDI=$O(^TMP("MDSTATUS",$J,MDPAT,MDI)) Q:MDI<1!(+MDY2)  D
"RTN","MDWORSR",154,0)
 .I +$G(^TMP("MDLST",$J,MDCLIN,MDI)) S MDY2=+$G(^TMP("MDSTATUS",$J,MDPAT,MDI))
"RTN","MDWORSR",155,0)
 Q MDY2
"RTN","MDWORSR",156,0)
ADD(MDPAT,MDY3,MDY4,MDCLIN,MDSC) ; Add study, if none exist
"RTN","MDWORSR",157,0)
 N MDFDA,MDERR,MDIENS,MDP,MDPS
"RTN","MDWORSR",158,0)
 Q:'MDY3
"RTN","MDWORSR",159,0)
 K MDFDA,MDERR,MDIENN
"RTN","MDWORSR",160,0)
 S MDP=$O(^MDD(702,"B",MDPAT,0)),MDPS=$G(^MDD(702,+MDP,0))
"RTN","MDWORSR",161,0)
 S MDFDA(702,"+1,",.01)=MDPAT
"RTN","MDWORSR",162,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWORSR",163,0)
 S MDFDA(702,"+1,",.03)=$S(+$P(MDPS,"^",3):$P(MDPS,"^",3),1:DUZ)
"RTN","MDWORSR",164,0)
 S MDFDA(702,"+1,",.04)=+MDY3
"RTN","MDWORSR",165,0)
 S MDFDA(702,"+1,",.05)=+MDY4
"RTN","MDWORSR",166,0)
 S MDFDA(702,"+1,",.07)="A;"_MDSC_";"_MDCLIN
"RTN","MDWORSR",167,0)
 S MDFDA(702,"+1,",.11)=+$$GINST(+MDY3)
"RTN","MDWORSR",168,0)
 D UPDATE^DIE("","MDFDA","MDIENN","MDERR") Q:$D(MDERR) 0
"RTN","MDWORSR",169,0)
 K MDFDA
"RTN","MDWORSR",170,0)
 Q MDIENN(1)
"VER")
8.0^22.0
"BLD",7271,6)
^14
**END**
**END**

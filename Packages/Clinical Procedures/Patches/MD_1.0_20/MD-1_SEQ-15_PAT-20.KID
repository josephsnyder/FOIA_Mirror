Released MD*1*20 SEQ #15
Extracted from mail message
**KIDS**:MD*1.0*20^

**INSTALL NAME**
MD*1.0*20
"BLD",7229,0)
MD*1.0*20^CLINICAL PROCEDURES^0^3100907^y
"BLD",7229,1,0)
^^2^2^3100902^^^
"BLD",7229,1,1,0)
Please refer to the National Patch Module for the detail of this 
"BLD",7229,1,2,0)
patch build.
"BLD",7229,4,0)
^9.64PA^^
"BLD",7229,6.3)
9
"BLD",7229,"ABPKG")
n
"BLD",7229,"INID")
^y
"BLD",7229,"INIT")
MDPOST20
"BLD",7229,"KRN",0)
^9.67PA^779.2^20
"BLD",7229,"KRN",.4,0)
.4
"BLD",7229,"KRN",.401,0)
.401
"BLD",7229,"KRN",.402,0)
.402
"BLD",7229,"KRN",.403,0)
.403
"BLD",7229,"KRN",.5,0)
.5
"BLD",7229,"KRN",.84,0)
.84
"BLD",7229,"KRN",3.6,0)
3.6
"BLD",7229,"KRN",3.8,0)
3.8
"BLD",7229,"KRN",3.8,"NM",0)
^9.68A^^0
"BLD",7229,"KRN",9.2,0)
9.2
"BLD",7229,"KRN",9.8,0)
9.8
"BLD",7229,"KRN",9.8,"NM",0)
^9.68A^13^11
"BLD",7229,"KRN",9.8,"NM",1,0)
MDDEVCL^^0^B2354165
"BLD",7229,"KRN",9.8,"NM",2,0)
MDHL7BH^^0^B22948615
"BLD",7229,"KRN",9.8,"NM",4,0)
MDRPCOR^^0^B92120786
"BLD",7229,"KRN",9.8,"NM",6,0)
MDRPCOP^^0^B79065771
"BLD",7229,"KRN",9.8,"NM",7,0)
MDRPCOT2^^0^B44429829
"BLD",7229,"KRN",9.8,"NM",8,0)
MDNCHK^^0^B4073446
"BLD",7229,"KRN",9.8,"NM",9,0)
MDRPCOTA^^0^B925975
"BLD",7229,"KRN",9.8,"NM",10,0)
MDRPCW^^0^B70357475
"BLD",7229,"KRN",9.8,"NM",11,0)
MDRPCW1^^0^B57093327
"BLD",7229,"KRN",9.8,"NM",12,0)
MDWOR^^0^B42202068
"BLD",7229,"KRN",9.8,"NM",13,0)
MDWORSR^^0^B59105822
"BLD",7229,"KRN",9.8,"NM","B","MDDEVCL",1)

"BLD",7229,"KRN",9.8,"NM","B","MDHL7BH",2)

"BLD",7229,"KRN",9.8,"NM","B","MDNCHK",8)

"BLD",7229,"KRN",9.8,"NM","B","MDRPCOP",6)

"BLD",7229,"KRN",9.8,"NM","B","MDRPCOR",4)

"BLD",7229,"KRN",9.8,"NM","B","MDRPCOT2",7)

"BLD",7229,"KRN",9.8,"NM","B","MDRPCOTA",9)

"BLD",7229,"KRN",9.8,"NM","B","MDRPCW",10)

"BLD",7229,"KRN",9.8,"NM","B","MDRPCW1",11)

"BLD",7229,"KRN",9.8,"NM","B","MDWOR",12)

"BLD",7229,"KRN",9.8,"NM","B","MDWORSR",13)

"BLD",7229,"KRN",19,0)
19
"BLD",7229,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",7229,"KRN",19,"NM",1,0)
MD DEVICE SURVEY TRANSMISSION^^0
"BLD",7229,"KRN",19,"NM",2,0)
MD DEVICE SURVEY TANSMISSION^^1^
"BLD",7229,"KRN",19,"NM","B","MD DEVICE SURVEY TANSMISSION",2)

"BLD",7229,"KRN",19,"NM","B","MD DEVICE SURVEY TRANSMISSION",1)

"BLD",7229,"KRN",19.1,0)
19.1
"BLD",7229,"KRN",101,0)
101
"BLD",7229,"KRN",409.61,0)
409.61
"BLD",7229,"KRN",771,0)
771
"BLD",7229,"KRN",779.2,0)
779.2
"BLD",7229,"KRN",870,0)
870
"BLD",7229,"KRN",8989.51,0)
8989.51
"BLD",7229,"KRN",8989.51,"NM",0)
^9.68A^2^2
"BLD",7229,"KRN",8989.51,"NM",1,0)
MD DEVICE SURVEY TRANSMISSION^^0
"BLD",7229,"KRN",8989.51,"NM",2,0)
MD DAYS TO RET COM MULT^^0
"BLD",7229,"KRN",8989.51,"NM","B","MD DAYS TO RET COM MULT",2)

"BLD",7229,"KRN",8989.51,"NM","B","MD DEVICE SURVEY TRANSMISSION",1)

"BLD",7229,"KRN",8989.52,0)
8989.52
"BLD",7229,"KRN",8994,0)
8994
"BLD",7229,"KRN","B",.4,.4)

"BLD",7229,"KRN","B",.401,.401)

"BLD",7229,"KRN","B",.402,.402)

"BLD",7229,"KRN","B",.403,.403)

"BLD",7229,"KRN","B",.5,.5)

"BLD",7229,"KRN","B",.84,.84)

"BLD",7229,"KRN","B",3.6,3.6)

"BLD",7229,"KRN","B",3.8,3.8)

"BLD",7229,"KRN","B",9.2,9.2)

"BLD",7229,"KRN","B",9.8,9.8)

"BLD",7229,"KRN","B",19,19)

"BLD",7229,"KRN","B",19.1,19.1)

"BLD",7229,"KRN","B",101,101)

"BLD",7229,"KRN","B",409.61,409.61)

"BLD",7229,"KRN","B",771,771)

"BLD",7229,"KRN","B",779.2,779.2)

"BLD",7229,"KRN","B",870,870)

"BLD",7229,"KRN","B",8989.51,8989.51)

"BLD",7229,"KRN","B",8989.52,8989.52)

"BLD",7229,"KRN","B",8994,8994)

"BLD",7229,"QUES",0)
^9.62^1^1
"BLD",7229,"QUES",1,0)
POS1
"BLD",7229,"QUES",1,1)
YA^^
"BLD",7229,"QUES",1,"A")
Do you want to run the device survey transmission? 
"BLD",7229,"QUES",1,"B")
YES
"BLD",7229,"QUES",1,"Q")
Enter 'Y' or 'N'.
"BLD",7229,"QUES",1,"Q1",0)
^^2^2^3081124^
"BLD",7229,"QUES",1,"Q1",1,0)
Answer YES to run the device survey transmission,
"BLD",7229,"QUES",1,"Q1",2,0)
NO to suppress the device data collection and transmission.
"BLD",7229,"QUES","B","POS1",1)

"BLD",7229,"REQB",0)
^9.611^1^1
"BLD",7229,"REQB",1,0)
MD*1.0*21^2
"BLD",7229,"REQB","B","MD*1.0*21",1)

"INIT")
MDPOST20
"KRN",19,12924,-1)
0^1
"KRN",19,12924,0)
MD DEVICE SURVEY TRANSMISSION^MD Device Survey Transmission^^R^^^^^^^^CLINICAL PROCEDURES
"KRN",19,12924,1,0)
^19.06^2^2^3100907^^^
"KRN",19,12924,1,1,0)
This option will run the device survey collection routine and
"KRN",19,12924,1,2,0)
capture the data for transmission.
"KRN",19,12924,25)
COL^MDDEVCL
"KRN",19,12924,"U")
MD DEVICE SURVEY TRANSMISSION
"KRN",19,13162,-1)
1^2
"KRN",19,13162,0)
MD DEVICE SURVEY TANSMISSION
"KRN",8989.51,506,-1)
0^1
"KRN",8989.51,506,0)
MD DEVICE SURVEY TRANSMISSION^Device Survey Transmission^0^^Yes/No^0
"KRN",8989.51,506,1)
Y^^Enter 'Y' for 'YES' or 'N' for 'NO'.
"KRN",8989.51,506,20,0)
^8989.512^3^3^3081124^^^
"KRN",8989.51,506,20,1,0)
Used to determine if the site wants to transmit the device survey to
"KRN",8989.51,506,20,2,0)
Hines.  Enter 'Y' for 'YES' to send the survey or 'N' for 'NO' to 
"KRN",8989.51,506,20,3,0)
suppress the transmission.
"KRN",8989.51,506,30,0)
^8989.513I^1^1
"KRN",8989.51,506,30,1,0)
1^4.2
"KRN",8989.51,587,-1)
0^2
"KRN",8989.51,587,0)
MD DAYS TO RET COM MULT^Days to Retain Completed Multiple Study^0^^Days
"KRN",8989.51,587,1)
N^1:365^Enter the number of days from 1 to 365
"KRN",8989.51,587,20,0)
^^3^3^3100623^
"KRN",8989.51,587,20,1,0)
The number of days after check-in date/time to display the study
"KRN",8989.51,587,20,2,0)
that has been completed in the CPUser application.  This only
"KRN",8989.51,587,20,3,0)
pertains to studies that have procedures with multiple studies.
"KRN",8989.51,587,30,0)
^8989.513I^1^1
"KRN",8989.51,587,30,1,0)
1^4.2
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",365,-1)
1^1
"PKG",365,0)
CLINICAL PROCEDURES^MD^Clinical Procedures
"PKG",365,20,0)
^9.402P^^
"PKG",365,22,0)
^9.49I^1^1
"PKG",365,22,1,0)
1.0^3090522^2980529^363
"PKG",365,22,1,"PAH",1,0)
20^3100907
"PKG",365,22,1,"PAH",1,1,0)
^^2^2^3100907
"PKG",365,22,1,"PAH",1,1,1,0)
Please refer to the National Patch Module for the detail of this 
"PKG",365,22,1,"PAH",1,1,2,0)
patch build.
"QUES","POS1",0)
YA^^
"QUES","POS1","?")
Enter 'Y' or 'N'.
"QUES","POS1","?",1)
Answer YES to run the device survey transmission,
"QUES","POS1","?",2)
NO to suppress the device data collection and transmission.
"QUES","POS1","A")
Do you want to run the device survey transmission? 
"QUES","POS1","B")
YES
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","MDDEVCL")
0^1^B2354165^n/a
"RTN","MDDEVCL",1,0)
MDDEVCL ;HOIFO/NCA - Collect Device Data ;8:34 AM  9 Jun 2005
"RTN","MDDEVCL",2,0)
 ;;1.0;CLINICAL PROCEDURES;**20**;Apr 01, 2004;Build 9
"RTN","MDDEVCL",3,0)
 ; Reference IA # 2056 for DIQ
"RTN","MDDEVCL",4,0)
 ;                2263 FOR XPAR
"RTN","MDDEVCL",5,0)
 ;                2729 for XMXAPI calls.
"RTN","MDDEVCL",6,0)
 ;               10060 for NEW PERSON file (#200) access
"RTN","MDDEVCL",7,0)
COL ; Collect Device data for Transmission
"RTN","MDDEVCL",8,0)
 K ^TMP("MDMTXT",$J)
"RTN","MDDEVCL",9,0)
 N MDLP,MDTXT,MDTXT1,MDCT,MDSTAT,XMBODY,XMSUBJ,XMINSTR,XMTO S MDCT=0,MDSTAT=DUZ(2)
"RTN","MDDEVCL",10,0)
 Q:'+$$GET^XPAR("SYS","MD DEVICE SURVEY TRANSMISSION",1)
"RTN","MDDEVCL",11,0)
 S MDLP=0 F  S MDLP=$O(^MDS(702.09,MDLP)) Q:MDLP<1  S MDTXT=$G(^(MDLP,0)),MDTXT1=$G(^(.1)) D
"RTN","MDDEVCL",12,0)
 .S MDCT=MDCT+1
"RTN","MDDEVCL",13,0)
 .S ^TMP("MDMTXT",$J,MDCT)=MDSTAT_"^"_$P(MDTXT,"^",1)_"^"_$P(MDTXT1,"^",2)_"^"_$P(MDTXT,"^",9)_"^"_$$GET1^DIQ(200,DUZ_",",.01)
"RTN","MDDEVCL",14,0)
 Q:'MDCT
"RTN","MDDEVCL",15,0)
 S XMSUBJ="Medical Device Name Report"
"RTN","MDDEVCL",16,0)
 S XMINSTR("FROM")=.5,XMBODY="^TMP(""MDMTXT"",$J)"
"RTN","MDDEVCL",17,0)
 S XMTO="G.MDDEVICE@DEV.DEV.FO-HINES.MED.VA.GOV"
"RTN","MDDEVCL",18,0)
 D SENDMSG^XMXAPI(DUZ,XMSUBJ,XMBODY,XMTO,.XMINSTR) K ^TMP("MDMTXT",$J)
"RTN","MDDEVCL",19,0)
 I $G(XQY0)'=""&($P($G(XQY0),"^")["TRANSMISSION") W !!,"Message Transmitted."
"RTN","MDDEVCL",20,0)
 Q
"RTN","MDHL7BH")
0^2^B22948615^B22756208
"RTN","MDHL7BH",1,0)
MDHL7BH ; HOIFO/WAA -Bi-directional interface (HL7) routine ;10/26/09  09:21
"RTN","MDHL7BH",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11,21,20**;Apr 01, 2004;Build 9
"RTN","MDHL7BH",3,0)
 ;
"RTN","MDHL7BH",4,0)
 ; This routine will build the HL7 Message and store that message.
"RTN","MDHL7BH",5,0)
 ; After the message has been created then it will call the
"RTN","MDHL7BH",6,0)
 ; The actual HL7package to start the processing of the message
"RTN","MDHL7BH",7,0)
 ;
"RTN","MDHL7BH",8,0)
 ; Reference DBIA #2161 [Supported] for HL7 calls.
"RTN","MDHL7BH",9,0)
 ; Reference DBIA #2164 [Supported] for HL7 calls.
"RTN","MDHL7BH",10,0)
 ; Reference DBIA #2263 [Supported] call to XPAR
"RTN","MDHL7BH",11,0)
 ; Reference DBIA #3065 [Supported]  call to XLFNAME.
"RTN","MDHL7BH",12,0)
 ; Reference DBIA #10103 [Supported] Call to XLFDT
"RTN","MDHL7BH",13,0)
 ; Reference DBIA #3067 [Private] Read Consult Data with FM call.
"RTN","MDHL7BH",14,0)
 ; Reference DBIA #10035[Supported] Patient File Access
"RTN","MDHL7BH",15,0)
 ; Reference DBIA #10040[Supported] Access ^SC
"RTN","MDHL7BH",16,0)
 ; Reference DBIA #10061[Supported] call to VADPT
"RTN","MDHL7BH",17,0)
 ; Reference DBIA #10056[Supported] Direct read STATE (5)
"RTN","MDHL7BH",18,0)
 Q
"RTN","MDHL7BH",19,0)
EN1 ;Main Entry point.
"RTN","MDHL7BH",20,0)
 N MDMSG,MD101,CNT,HLA,LINE,MDHL,DFN,MDLINK
"RTN","MDHL7BH",21,0)
 Q:RESULT<1  ; This tells the study is not a BDi
"RTN","MDHL7BH",22,0)
 S MDLINK=$$GET1^DIQ(702.09,DEVIEN,.18,"E")
"RTN","MDHL7BH",23,0)
 I MDLINK="" S RESULT=-1,MSG="No HL Logical Link has been defined." Q  ; No link has been defined
"RTN","MDHL7BH",24,0)
 S MDERROR="0"
"RTN","MDHL7BH",25,0)
 D INIT^HLFNC2("MCAR ORM SERVER",.MDMSG)
"RTN","MDHL7BH",26,0)
 I +$G(MDMSG)>0 S RESULT=-1,MSG="Unable to produce a message." Q  ; something is wrong and no MSH was created
"RTN","MDHL7BH",27,0)
 S DFN=$$GET1^DIQ(702,MDD702,.01,"I")
"RTN","MDHL7BH",28,0)
 S DEVNAME=$$GET1^DIQ(702.09,DEVIEN,.16,"I")
"RTN","MDHL7BH",29,0)
 S CNT=0
"RTN","MDHL7BH",30,0)
 D PID S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",31,0)
 D PV1 S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",32,0)
 D ORC S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",33,0)
 D OBR I LINE'="" S CNT=CNT+1,HLA("HLS",CNT)=LINE
"RTN","MDHL7BH",34,0)
 S HLP("SUBSCRIBER")="^^VISTA^^"_DEVNAME_"^M"
"RTN","MDHL7BH",35,0)
 S HLL("LINKS",1)="MCAR ORM CLIENT"_"^"_MDLINK
"RTN","MDHL7BH",36,0)
 D GENERATE^HLMA("MCAR ORM SERVER","LM",1,.MDHL,,.HLP)
"RTN","MDHL7BH",37,0)
 I $P(MDHL,U,2) S MDERROR=MDHL
"RTN","MDHL7BH",38,0)
 Q
"RTN","MDHL7BH",39,0)
OBR ; Send the procedure to the correct device
"RTN","MDHL7BH",40,0)
 S LINE="OBR|"
"RTN","MDHL7BH",41,0)
 S DEVIEN=$$GET1^DIQ(702,MDD702,.11,"I")
"RTN","MDHL7BH",42,0)
 S USC=$$GET1^DIQ(702.09,DEVIEN,.17,"I")
"RTN","MDHL7BH",43,0)
 I USC="" S LINE="" Q
"RTN","MDHL7BH",44,0)
 E  S USC=$TR(USC,"=","^")
"RTN","MDHL7BH",45,0)
 S $P(LINE,"|",5)=USC_"|"
"RTN","MDHL7BH",46,0)
 Q
"RTN","MDHL7BH",47,0)
PID ;get the patient information and build the PID
"RTN","MDHL7BH",48,0)
 ;PID|||SSN||Last^First||DOB|SEX|||||||||||SSN
"RTN","MDHL7BH",49,0)
 N MDSSN,NAME,DOB,ADDR,TMP,MDADD,VAPA,VAERR,VAROOT,MDPCOD
"RTN","MDHL7BH",50,0)
 S LINE="PID|",$P(LINE,"|",21)=""
"RTN","MDHL7BH",51,0)
 S MDSSN=$$GET1^DIQ(702,MDD702,.011) ; Get the ssn for the patient
"RTN","MDHL7BH",52,0)
 S NAME=$$GET1^DIQ(702,MDD702,.01,"E") ; get the patient name
"RTN","MDHL7BH",53,0)
 S NAME=$$HLNAME^XLFNAME($P(NAME,"^"),"",$E(HLECH,1))
"RTN","MDHL7BH",54,0)
 I $P(NAME,$E(HLECH,1),7)'="L" S $P(NAME,$E(HLECH,1),7)="L"
"RTN","MDHL7BH",55,0)
 S DOB=$$GET1^DIQ(2,DFN,.03,"I") S DOB=$$FTOHL7^MDHL7U2(DOB)
"RTN","MDHL7BH",56,0)
 S VAROOT="MDADD" D ADD^VADPT
"RTN","MDHL7BH",57,0)
 S ADDR=$G(MDADD(1))_"^" ; Address 1
"RTN","MDHL7BH",58,0)
 S TMP=$G(MDADD(2)) I TMP'="" S ADDR=ADDR_TMP ; Add 2
"RTN","MDHL7BH",59,0)
 S TMP=$G(MDADD(3)) I TMP'="" S ADDR=ADDR_" "_TMP ; Add 3
"RTN","MDHL7BH",60,0)
 S ADDR=ADDR_"^"_$G(MDADD(4)) ; City
"RTN","MDHL7BH",61,0)
 S MDPCOD=$P($G(MDADD(5)),"^",1) I MDPCOD'="" S MDPCOD=$P($G(^DIC(5,MDPCOD,0)),"^",2)
"RTN","MDHL7BH",62,0)
 ; ^^^^^^ Setting MDPCODE to Postal code Via direct supported lookup.
"RTN","MDHL7BH",63,0)
 S ADDR=ADDR_"^"_MDPCOD ; State Postal Code
"RTN","MDHL7BH",64,0)
 S ADDR=ADDR_"^"_$G(MDADD(6)) ; Zip
"RTN","MDHL7BH",65,0)
 K MDADD
"RTN","MDHL7BH",66,0)
 S $P(LINE,"|",2)="1"
"RTN","MDHL7BH",67,0)
 S $P(LINE,"|",4)=MDSSN
"RTN","MDHL7BH",68,0)
 S $P(LINE,"|",6)=NAME
"RTN","MDHL7BH",69,0)
 S $P(LINE,"|",8)=DOB
"RTN","MDHL7BH",70,0)
 S $P(LINE,"|",9)=$$GET1^DIQ(2,DFN,.02,"I")
"RTN","MDHL7BH",71,0)
 S $P(LINE,"|",12)=ADDR
"RTN","MDHL7BH",72,0)
 S $P(LINE,"|",20)=MDSSN
"RTN","MDHL7BH",73,0)
 Q
"RTN","MDHL7BH",74,0)
PV1 ;Get the ward location for PV1
"RTN","MDHL7BH",75,0)
 ;PV1||In or out|Ward location
"RTN","MDHL7BH",76,0)
 N CWARD,WARD,INOUT,CONSULT,REF,NREF,WARD1,WARD2,MDPR1,MDPNAM,MDSV
"RTN","MDHL7BH",77,0)
 S WARD=$$GET1^DIQ(2,DFN,.1,"E"),(WARD1,WARD2)=""
"RTN","MDHL7BH",78,0)
 S INOUT=$S(WARD'="":"I",1:"O")
"RTN","MDHL7BH",79,0)
 S:WARD'="" WARD=WARD_U_WARD
"RTN","MDHL7BH",80,0)
 S CONSULT=$$GET123^MDHL7U2(MDD702)
"RTN","MDHL7BH",81,0)
 S CWARD=$P($G(^MDD(702,+MDD702,0)),U,7),CWARD=$P(CWARD,";",3)
"RTN","MDHL7BH",82,0)
 S:+CWARD WARD2=$$GET1^DIQ(44,+CWARD_",",.01,"E")
"RTN","MDHL7BH",83,0)
 S MDPR1=$$GET1^DIQ(702,+MDD702_",",.04,"I")
"RTN","MDHL7BH",84,0)
 S:+MDPR1 WARD1=$$GET1^DIQ(702.01,+MDPR1_",",.05,"E")
"RTN","MDHL7BH",85,0)
 S MDPNAM=$$GET1^DIQ(702.09,DEVIEN,.06,"I")
"RTN","MDHL7BH",86,0)
 I INOUT="O" D
"RTN","MDHL7BH",87,0)
 .;S WARD=WARD1 S:WARD="" WARD=WARD2
"RTN","MDHL7BH",88,0)
 .S WARD=WARD2 S:WARD="" WARD=WARD1
"RTN","MDHL7BH",89,0)
 .I WARD="" S WARD=$$GET1^DIQ(123,CONSULT_",",.04,"E"),MDSV="A;"_$$NOW^XLFDT()_";"_$$GET1^DIQ(123,CONSULT_",",.04,"I"),$P(^MDD(702,+MDD702,0),U,7)=MDSV
"RTN","MDHL7BH",90,0)
 .I MDPNAM["Olympus" D
"RTN","MDHL7BH",91,0)
 ..S WARD1=$O(^SC("B",WARD,0)),CWARD=$P($G(^SC(+WARD1,0)),U,2)
"RTN","MDHL7BH",92,0)
 ..S WARD=$S(+$$GET^XPAR("SYS","MD OLYMPUS 7",1)>0:$E(WARD,1,7),1:$E(WARD,1,4))_"^"_CWARD
"RTN","MDHL7BH",93,0)
 I INOUT="I" D
"RTN","MDHL7BH",94,0)
 .S:WARD="" WARD=WARD2 S:WARD="" WARD=WARD1
"RTN","MDHL7BH",95,0)
 .S:WARD="" WARD=$$GET1^DIQ(123,CONSULT_",",.04,"E")
"RTN","MDHL7BH",96,0)
 .S WARD=WARD_"^"_$S($G(^DPT(2,.101))'="":$G(^DPT(2,.101)),1:"") Q
"RTN","MDHL7BH",97,0)
 ;V--- NEW CODE THis code is
"RTN","MDHL7BH",98,0)
 I $P($P(^MDD(702,+MDD702,0),U,7),";",3)="" D
"RTN","MDHL7BH",99,0)
 . I +MDPR1 Q:+$$GET1^DIQ(702.01,+MDPR1_",",.05,"I")
"RTN","MDHL7BH",100,0)
 . S MDSV="A;"_$$NOW^XLFDT()_";"_$$GET1^DIQ(123,CONSULT_",",.04,"I"),$P(^MDD(702,+MDD702,0),U,7)=MDSV
"RTN","MDHL7BH",101,0)
 . Q
"RTN","MDHL7BH",102,0)
 ;^--- NEW CODE
"RTN","MDHL7BH",103,0)
 S LINE="PV1||"_INOUT_"|"_WARD
"RTN","MDHL7BH",104,0)
 Q:CONSULT<1
"RTN","MDHL7BH",105,0)
 S NREF=$$GETREF^MDHL7U2(CONSULT) Q:NREF="-1"
"RTN","MDHL7BH",106,0)
 S $P(LINE,"|",9)=NREF
"RTN","MDHL7BH",107,0)
 Q
"RTN","MDHL7BH",108,0)
ORC ;get ORC onformation
"RTN","MDHL7BH",109,0)
 ;ORC|NA|Order Number|||||||date/time ordered
"RTN","MDHL7BH",110,0)
 N DATE,SDATE
"RTN","MDHL7BH",111,0)
 S DATE=$$GET1^DIQ(702,MDD702,.02,"I")
"RTN","MDHL7BH",112,0)
 S DATE=$$FTOHL7^MDHL7U2(DATE)
"RTN","MDHL7BH",113,0)
 S SDATE=$$GET1^DIQ(702,MDD702,.07,"I")
"RTN","MDHL7BH",114,0)
 I SDATE[";" S SDATE=$P(SDATE,";",2)
"RTN","MDHL7BH",115,0)
 I SDATE="" D NOW^%DTC S SDATE=% S $P(^MDD(702,MDD702,0),"^",7)=SDATE
"RTN","MDHL7BH",116,0)
 I SDATE<DT D NOW^%DTC S SDATE=%
"RTN","MDHL7BH",117,0)
 S SDATE=$$FTOHL7^MDHL7U2(SDATE)
"RTN","MDHL7BH",118,0)
 S LINE="ORC|"_$S(MDORFLG=1:"NW",MDORFLG=0:"CA",1:"")_"|"_MDIORD
"RTN","MDHL7BH",119,0)
 S $P(LINE,"|",6)=$S(MDORFLG=1:"NW",MDORFLG=0:"CA",1:"")
"RTN","MDHL7BH",120,0)
 S $P(LINE,"|",10)=DATE,$P(LINE,"|",16)=SDATE
"RTN","MDHL7BH",121,0)
 Q
"RTN","MDNCHK")
0^8^B4073446^B2544252
"RTN","MDNCHK",1,0)
MDNCHK ; HOIFO/NCA - CP Multiple Result Check ;7/26/10  14:27
"RTN","MDNCHK",2,0)
 ;;1.0;CLINICAL PROCEDURES;**11,21,20**;Apr 01, 2004;Build 9
"RTN","MDNCHK",3,0)
 ; Reference
"RTN","MDNCHK",4,0)
 ; IA#  2056 [Supported] Call to DIQ.
"RTN","MDNCHK",5,0)
 ; IA# 10103 [Supported] Call to XLFDT
"RTN","MDNCHK",6,0)
 ;
"RTN","MDNCHK",7,0)
CHK(MDIEN) ; RPC call to notify Consult of results
"RTN","MDNCHK",8,0)
 ; Input parameters
"RTN","MDNCHK",9,0)
 ;  1. MDIEN [Literal/Required] CP Study
"RTN","MDNCHK",10,0)
 ;
"RTN","MDNCHK",11,0)
 N MDCLST,MDCLT,MDCX,MDDEF,MDERR,MDHLOC,MDIENS,MDION,MDFDA,MDSTAT,MDSTR,MDSUBL S MDCX=""
"RTN","MDNCHK",12,0)
 I '$G(MDIEN) S MDIEN="" Q MDIEN
"RTN","MDNCHK",13,0)
 S MDDEF=+$$GET1^DIQ(702,MDIEN,.04,"I") I 'MDDEF Q MDIEN
"RTN","MDNCHK",14,0)
 S MDSTR=$G(^MDD(702,MDIEN,0)) I MDSTR="" Q MDIEN
"RTN","MDNCHK",15,0)
 I $P(MDSTR,"^",9)=6 D  Q MDCX
"RTN","MDNCHK",16,0)
 .S MDCLST=$$GET1^DIQ(123,+$P(MDSTR,"^",5)_",",8,"E")
"RTN","MDNCHK",17,0)
 .I MDCLST="CANCELLED"!(MDCLST="DISCONTINUED") S MDCLT=$$GETCS^MDRPCOTA(+MDIEN) D
"RTN","MDNCHK",18,0)
 ..I +MDCLT S MDCX=$O(^MDD(702,"ACON",+MDCLT,""),-1) I 'MDCX K MDFDA S MDFDA(702,+MDIEN,.05)=MDCLT D FILE^DIE("","MDFDA") K MDFDA S MDCX=+MDIEN
"RTN","MDNCHK",19,0)
 ..S:'MDCX MDCX=+MDIEN
"RTN","MDNCHK",20,0)
 ..Q
"RTN","MDNCHK",21,0)
 .Q
"RTN","MDNCHK",22,0)
 S MDSTAT=+$$GET1^DIQ(702.01,MDDEF,.12,"I") I 'MDSTAT Q MDIEN
"RTN","MDNCHK",23,0)
 S MDION=+$$GET1^DIQ(702,MDIEN,.12,"I") I 'MDION Q MDIEN
"RTN","MDNCHK",24,0)
 I MDSTAT=2 Q MDIEN
"RTN","MDNCHK",25,0)
 I $P(MDSTR,"^",9)'=3 Q MDIEN
"RTN","MDNCHK",26,0)
 K ^MDD(702,"AION",+MDION,MDIEN)
"RTN","MDNCHK",27,0)
 S MDSUBL=$P(MDSTR,U,7)
"RTN","MDNCHK",28,0)
 S MDHLOC=+$$GET1^DIQ(702.01,MDDEF,.05,"I"),MDSUBL=$P(MDSUBL,";",1,2)_";"_MDHLOC
"RTN","MDNCHK",29,0)
 S MDFDA(702,"+1,",.01)=$P(MDSTR,U,1)
"RTN","MDNCHK",30,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDNCHK",31,0)
 S MDFDA(702,"+1,",.03)=$P(MDSTR,U,3)
"RTN","MDNCHK",32,0)
 S MDFDA(702,"+1,",.04)=$P(MDSTR,U,4)
"RTN","MDNCHK",33,0)
 S MDFDA(702,"+1,",.05)=$P(MDSTR,U,5)
"RTN","MDNCHK",34,0)
 S MDFDA(702,"+1,",.07)=$P(MDSTR,U,7)
"RTN","MDNCHK",35,0)
 S MDFDA(702,"+1,",.09)=5
"RTN","MDNCHK",36,0)
 S MDFDA(702,"+1,",.11)=$P(MDSTR,U,11)
"RTN","MDNCHK",37,0)
 S MDFDA(702,"+1,",.12)=$P(MDSTR,U,12)
"RTN","MDNCHK",38,0)
 D UPDATE^DIE("","MDFDA","MDIENS","MDERR")
"RTN","MDNCHK",39,0)
 S MDIEN=MDIENS(1)
"RTN","MDNCHK",40,0)
 Q MDIEN
"RTN","MDPOST20")
0^^B2097134^n/a
"RTN","MDPOST20",1,0)
MDPOST20 ; HOIFO/NCA - Post Init ;7/1/10  10:45
"RTN","MDPOST20",2,0)
 ;;1.0;CLINICAL PROCEDURES;**20**;Apr 01, 2004;Build 9
"RTN","MDPOST20",3,0)
 ; Integration Agreements:
"RTN","MDPOST20",4,0)
 ; IA# 2263 [Supported] XPAR parameter calls.
"RTN","MDPOST20",5,0)
 ; IA# 10141 [Supported] Calls to XPDUTL
"RTN","MDPOST20",6,0)
 ;
"RTN","MDPOST20",7,0)
EN ; [Procedure] Setup MD DEVICE SURVEY TRANSMISSION parameter
"RTN","MDPOST20",8,0)
 ; This submodule is called during the KIDS Post installation
"RTN","MDPOST20",9,0)
 ; process.
"RTN","MDPOST20",10,0)
 ;
"RTN","MDPOST20",11,0)
 ; New private variables
"RTN","MDPOST20",12,0)
 N MDOPT,MDAPU
"RTN","MDPOST20",13,0)
 S MDAPU=$G(XPDQUES("POS1"))
"RTN","MDPOST20",14,0)
 D EN^XPAR("SYS","MD DEVICE SURVEY TRANSMISSION",1,MDAPU)
"RTN","MDPOST20",15,0)
 I +MDAPU D COL^MDDEVCL D BMES^XPDUTL("Collecting device information for initial transmission...")
"RTN","MDPOST20",16,0)
 ;
"RTN","MDPOST20",17,0)
EN1 ; [Procedure] Setup preliminary parameters
"RTN","MDPOST20",18,0)
 ; This submodule is called during the KIDS installation
"RTN","MDPOST20",19,0)
 ; process.
"RTN","MDPOST20",20,0)
 ;
"RTN","MDPOST20",21,0)
 ; Variables:
"RTN","MDPOST20",22,0)
 ;  DIK: [Private] Fileman delete variable
"RTN","MDPOST20",23,0)
 ;  MDCLIENT: [Private] Current client version (#.#.#.#)
"RTN","MDPOST20",24,0)
 ;  MDFILE: [Private] Scratch
"RTN","MDPOST20",25,0)
 ;  MDRET: [Private] Scratch
"RTN","MDPOST20",26,0)
 ;  MDX: [Private] Scratch
"RTN","MDPOST20",27,0)
 ;
"RTN","MDPOST20",28,0)
 ; New private variables
"RTN","MDPOST20",29,0)
 N DIK,MDCLIENT,MDFILE,MDRET,MDX
"RTN","MDPOST20",30,0)
 W $$MSG("Setting compatible client versions")
"RTN","MDPOST20",31,0)
 S MDCLIENT="1.0.20.4" D
"RTN","MDPOST20",32,0)
 .D SETPAR("MD VERSION CHK","CPGATEWAY.EXE:"_MDCLIENT,1)
"RTN","MDPOST20",33,0)
 .D SETPAR("MD CRC VALUES","CPGATEWAY.EXE:"_MDCLIENT,"7C3BE136")
"RTN","MDPOST20",34,0)
 Q
"RTN","MDPOST20",35,0)
 ;
"RTN","MDPOST20",36,0)
MSG(TEXT) ; [Procedure] Display message to user
"RTN","MDPOST20",37,0)
 ; Input parameters
"RTN","MDPOST20",38,0)
 ;  1. TEXT [Literal/Required] Text to display to the user
"RTN","MDPOST20",39,0)
 ;
"RTN","MDPOST20",40,0)
 D MES^XPDUTL(" MDPOST-"_TEXT_"...")
"RTN","MDPOST20",41,0)
 D MES^XPDUTL("")
"RTN","MDPOST20",42,0)
 Q ""
"RTN","MDPOST20",43,0)
 ;
"RTN","MDPOST20",44,0)
SETPAR(PAR,INS,VAL) ; [Procedure] Set value into XPAR parameter
"RTN","MDPOST20",45,0)
 ; Input parameters
"RTN","MDPOST20",46,0)
 ;  1. PAR [Literal/Required] Parameter
"RTN","MDPOST20",47,0)
 ;  2. INS [Literal/Required] Instance
"RTN","MDPOST20",48,0)
 ;  3. VAL [Literal/Required] New value
"RTN","MDPOST20",49,0)
 ;
"RTN","MDPOST20",50,0)
 D EN^XPAR("SYS",PAR,INS,VAL)
"RTN","MDPOST20",51,0)
 Q
"RTN","MDRPCOP")
0^6^B79065771^B75016189
"RTN","MDRPCOP",1,0)
MDRPCOP ; HOIFO/DP - Object RPCs (TMDPatient) ;8/3/09  10:39
"RTN","MDRPCOP",2,0)
 ;;1.0;CLINICAL PROCEDURES;**4,6,11,20**;Apr 01, 2004;Build 9
"RTN","MDRPCOP",3,0)
 ; Integration Agreements:
"RTN","MDRPCOP",4,0)
 ; IA# 2054 [Supported] DILF call
"RTN","MDRPCOP",5,0)
 ; IA# 2056 [Supported] DIQ calls
"RTN","MDRPCOP",6,0)
 ; IA# 2263 [Supported] XPAR calls
"RTN","MDRPCOP",7,0)
 ; IA# 3027 [Supported] Calls to DGSEC4
"RTN","MDRPCOP",8,0)
 ; IA# 2981 [Subscription] Calls to GUI~GMRCP5
"RTN","MDRPCOP",9,0)
 ; IA# 2548 [Supported] ACRP Interface Toolkit APIs.
"RTN","MDRPCOP",10,0)
 ; IA# 2552 [Supported] AIT API to provide outpatient encounter data.
"RTN","MDRPCOP",11,0)
 ; IA# 10061 [Supported] VADPT calls.
"RTN","MDRPCOP",12,0)
 ; IA# 3468 [Subscription] Use GMRCCP APIs.
"RTN","MDRPCOP",13,0)
 ; IA# 10103 [Supported] Call to XLFDT
"RTN","MDRPCOP",14,0)
 ; IA# 10039 [Supported] Ward Location File (#42) Access.
"RTN","MDRPCOP",15,0)
 ; IA# 10035 [Supported] DPT references
"RTN","MDRPCOP",16,0)
 ; IA# 3613 [Private] GETVST^MDRPCOP API call
"RTN","MDRPCOP",17,0)
 ; IA# 10099 [Supported] GMRADPT call
"RTN","MDRPCOP",18,0)
 ; IA# 1096 [Controlled Subscription] ^DGPM("ATID1" x-ref loop
"RTN","MDRPCOP",19,0)
 ; IA# 358 [Controlled Subscription] FILE 405 references
"RTN","MDRPCOP",20,0)
 ;
"RTN","MDRPCOP",21,0)
ADD(X) ; [Procedure] Add line to @RESULTS@(...
"RTN","MDRPCOP",22,0)
 S @RESULTS@(+$O(@RESULTS@(""),-1)+1)=X
"RTN","MDRPCOP",23,0)
 Q
"RTN","MDRPCOP",24,0)
 ;
"RTN","MDRPCOP",25,0)
ALLERGY ; [Procedure] Return Allergies
"RTN","MDRPCOP",26,0)
 D EN1^GMRADPT I '$O(GMRAL(0)) D  Q
"RTN","MDRPCOP",27,0)
 .I $G(GMRAL)="" S @RESULTS@(0)="No Allergy Assessment"
"RTN","MDRPCOP",28,0)
 .I $G(GMRAL)=0 S @RESULTS@(0)="No Known Allergies"
"RTN","MDRPCOP",29,0)
 S @RESULTS@(0)="This patient has the following allergy(ies): "
"RTN","MDRPCOP",30,0)
 F X=0:0 S X=$O(GMRAL(X)) Q:'X  D
"RTN","MDRPCOP",31,0)
 .S @RESULTS@(X)=$P($G(GMRAL(X)),U,2)
"RTN","MDRPCOP",32,0)
 Q
"RTN","MDRPCOP",33,0)
 ;
"RTN","MDRPCOP",34,0)
CHKIN ; [Procedure] Check In Study
"RTN","MDRPCOP",35,0)
 F X=2:1:5 D
"RTN","MDRPCOP",36,0)
 .I $P(DATA,U,X)]"" S MDFDA(702,$P(DATA,U,1),$P("^.04^.05^.11^.07",U,X))=$P(DATA,U,X)
"RTN","MDRPCOP",37,0)
 S MDFDA(702,$P(DATA,U,1),.09)=4  ; Status = Checked-In
"RTN","MDRPCOP",38,0)
 I $P(DATA,U,1)="+1," D
"RTN","MDRPCOP",39,0)
 .S MDFDA(702,"+1,",.01)=DFN
"RTN","MDRPCOP",40,0)
 .S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDRPCOP",41,0)
 .S MDFDA(702,"+1,",.03)=DUZ
"RTN","MDRPCOP",42,0)
 .S MDPC=$P(DATA,"^",5),MDPC=$S($L(MDPC,";")=1:MDPC,1:$P(MDPC,";",2))
"RTN","MDRPCOP",43,0)
 .S MDFDA(702,"+1,",.14)=MDPC
"RTN","MDRPCOP",44,0)
 .D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)
"RTN","MDRPCOP",45,0)
 .S MDIENS=MDIEN(1)_",",MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDRPCOP",46,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDRPCOP",47,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDRPCOP",48,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDRPCOP",49,0)
 I $P(DATA,U,1)'="+1," D
"RTN","MDRPCOP",50,0)
 .D FILE^DIE("","MDFDA","MDERR") Q:$D(MDERR)
"RTN","MDRPCOP",51,0)
 .S MDIENS=+DATA_","
"RTN","MDRPCOP",52,0)
 .S MDHL7=$$SUB^MDHL7B(+MDIENS)
"RTN","MDRPCOP",53,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDRPCOP",54,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDRPCOP",55,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDRPCOP",56,0)
 ; Patch 6 - Renal Check-In
"RTN","MDRPCOP",57,0)
 D:+$G(MDIENS)
"RTN","MDRPCOP",58,0)
 .S X=+$P(^MDD(702,+MDIENS,0),U,4) Q:'X
"RTN","MDRPCOP",59,0)
 .I $P(^MDS(702.01,X,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDRPCOP",60,0)
 ..D CP^MDKUTLR(+MDIENS)
"RTN","MDRPCOP",61,0)
 ..S MDFDA(702,+MDIENS_",",.09)=5
"RTN","MDRPCOP",62,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDRPCOP",63,0)
 ; Patch 6 - Renal Check-In
"RTN","MDRPCOP",64,0)
 I '$D(MDERR) S @RESULTS@(0)="1^OK" Q
"RTN","MDRPCOP",65,0)
 D ERROR^MDRPCU(RESULTS,.MDERR)
"RTN","MDRPCOP",66,0)
 Q
"RTN","MDRPCOP",67,0)
 ;
"RTN","MDRPCOP",68,0)
DISPCON ; [Procedure] Display a consult
"RTN","MDRPCOP",69,0)
 K ^TMP("GMRC",$J)
"RTN","MDRPCOP",70,0)
 D GUI^GMRCP5(.RESULTS,DATA)
"RTN","MDRPCOP",71,0)
 Q
"RTN","MDRPCOP",72,0)
 ;
"RTN","MDRPCOP",73,0)
GETCONS ; [Procedure] Get available consults for patient
"RTN","MDRPCOP",74,0)
 K ^TMP("MDTMP",$J) N MDCDT,MDDY,X1,X2,X
"RTN","MDRPCOP",75,0)
 S MDDY=$$GET^XPAR("SYS","MD COMPL PROC DISPLAY DAYS",1)
"RTN","MDRPCOP",76,0)
 S X1=DT,X2=-$S(MDDY>0:+MDDY,1:365) D C^%DTC S MDCDT=X
"RTN","MDRPCOP",77,0)
 D CPLIST^GMRCCP(DFN,,$NA(^TMP("MDTMP",$J)))
"RTN","MDRPCOP",78,0)
 S MDX=0
"RTN","MDRPCOP",79,0)
 F  S MDX=$O(^TMP("MDTMP",$J,MDX)) Q:'MDX  D:"saprc"[$P(^(MDX),U,4)
"RTN","MDRPCOP",80,0)
 .S Y="123;"_$P(^TMP("MDTMP",$J,MDX),U,5)
"RTN","MDRPCOP",81,0)
 .I $P($G(^TMP("MDTMP",$J,MDX)),U,4)="c" Q:$P($G(^TMP("MDTMP",$J,MDX)),U,1)<MDCDT
"RTN","MDRPCOP",82,0)
 .F X=2,3,4,1,6,5 S Y=Y_U_$P(^TMP("MDTMP",$J,MDX),U,X)
"RTN","MDRPCOP",83,0)
 .S Y=Y_U_+$O(^MDD(702,"ACON",+$P(^TMP("MDTMP",$J,MDX),U,5)))
"RTN","MDRPCOP",84,0)
 .;
"RTN","MDRPCOP",85,0)
 .; Patch MD*1.0*4 - Return number of times checked in at piece 9
"RTN","MDRPCOP",86,0)
 .;
"RTN","MDRPCOP",87,0)
 .S (X,Z)=0,MDY=+$P(^TMP("MDTMP",$J,MDX),U,5)
"RTN","MDRPCOP",88,0)
 .F  S X=$O(^MDD(702,"ACON",MDY,X)) Q:'X  S Z=Z+1
"RTN","MDRPCOP",89,0)
 .S $P(Y,U,9)=Z
"RTN","MDRPCOP",90,0)
 .;
"RTN","MDRPCOP",91,0)
 .; End Patch MD*1.0*4
"RTN","MDRPCOP",92,0)
 .;
"RTN","MDRPCOP",93,0)
 .D ADD(Y)
"RTN","MDRPCOP",94,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOP",95,0)
 K ^TMP("MDTMP",$J)
"RTN","MDRPCOP",96,0)
 Q
"RTN","MDRPCOP",97,0)
 ;
"RTN","MDRPCOP",98,0)
GETHDR ; [Procedure] Get Pt Header
"RTN","MDRPCOP",99,0)
 S DFNIENS=DFN_","
"RTN","MDRPCOP",100,0)
 S @RESULTS@(0)=$$GET1^DIQ(2,DFNIENS,.01)_"  "_$$GET1^DIQ(2,DFNIENS,.1)_" "_$$GET1^DIQ(2,DFNIENS,.101)
"RTN","MDRPCOP",101,0)
 S @RESULTS@(1)=$$GET1^DIQ(2,DFNIENS,.09)_"  "_$$GET1^DIQ(2,DFNIENS,.02)_"  "_$$GET1^DIQ(2,DFNIENS,.03)_" ("_$$GET1^DIQ(2,DFNIENS,.033)_")"
"RTN","MDRPCOP",102,0)
 Q
"RTN","MDRPCOP",103,0)
 ;
"RTN","MDRPCOP",104,0)
GETOBJ ; [Procedure] Get information for TMDPATIENT object
"RTN","MDRPCOP",105,0)
 D DEM^VADPT,INP^VADPT Q:'$D(VADM)
"RTN","MDRPCOP",106,0)
 S @RESULTS@(0)=DFN
"RTN","MDRPCOP",107,0)
 S @RESULTS@(1)=VADM(1)
"RTN","MDRPCOP",108,0)
 S @RESULTS@(2)=$P(VADM(2),U,2)
"RTN","MDRPCOP",109,0)
 S @RESULTS@(3)=$P(VADM(3),U,2)
"RTN","MDRPCOP",110,0)
 S @RESULTS@(4)=VADM(4)
"RTN","MDRPCOP",111,0)
 S @RESULTS@(5)=$P(VADM(5),U,2)
"RTN","MDRPCOP",112,0)
 I VAIN(4)]"" S @RESULTS@(6)="Ward: "_$P(VAIN(4),U,2)_" Rm: "_VAIN(5)
"RTN","MDRPCOP",113,0)
 E  S @RESULTS@(6)=""
"RTN","MDRPCOP",114,0)
 Q
"RTN","MDRPCOP",115,0)
 ;
"RTN","MDRPCOP",116,0)
GETRES ; [Procedure] Get results report
"RTN","MDRPCOP",117,0)
 F MDX=0:0 S MDX=$O(^MDD(703.1,"ADFN",DFN,MDX)) Q:'MDX  D
"RTN","MDRPCOP",118,0)
 .S MDINST=+$P($G(^MDD(703.1,MDX,0)),U,4)
"RTN","MDRPCOP",119,0)
 .I $G(DATA) Q:'$D(^MDS(702.01,DATA,.1,"B",MDINST))
"RTN","MDRPCOP",120,0)
 .S MDY=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOP",121,0)
 .S @RESULTS@(MDY)="703.1;"_MDX_U_^MDD(703.1,MDX,0)
"RTN","MDRPCOP",122,0)
 .S Y=$P(^MDD(703.1,MDX,0),U,3) D D^DIQ
"RTN","MDRPCOP",123,0)
 .S $P(@RESULTS@(MDY),U,11)=Y
"RTN","MDRPCOP",124,0)
 .S Y=$P($G(^MDS(702.09,+$P(^MDD(703.1,MDX,0),U,4),0)),U)
"RTN","MDRPCOP",125,0)
 .S $P(@RESULTS@(MDY),U,12)=Y
"RTN","MDRPCOP",126,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOP",127,0)
 Q
"RTN","MDRPCOP",128,0)
 ;
"RTN","MDRPCOP",129,0)
GETTRAN ; [Procedure] Get a patients transactions
"RTN","MDRPCOP",130,0)
 K ^TMP("MDTMP",$J),^TMP("MDCONL",$J) N MDCDT,MDCDY,MDCOM,MDMULT,MDMULN,MDNUM,MDREQ,MDREQDT,MDYR,X1,X2,X
"RTN","MDRPCOP",131,0)
 S MDNUM=$$GET^XPAR("SYS","MD DAYS TO RETAIN COM STUDY",1) S (MDCDY,MDCOM)=0
"RTN","MDRPCOP",132,0)
 S MDMULN=$$GET^XPAR("SYS","MD DAYS TO RET COM MULT",1)
"RTN","MDRPCOP",133,0)
 I +MDNUM>0 S X1=DT,X2=-MDNUM D C^%DTC S MDCOM=X
"RTN","MDRPCOP",134,0)
 I +MDMULN>0 S X1=DT,X2=-MDMULN D C^%DTC S MDCDY=X
"RTN","MDRPCOP",135,0)
 D CPLIST^GMRCCP(DFN,,$NA(^TMP("MDTMP",$J)))
"RTN","MDRPCOP",136,0)
 S X1=DT,X2=-365 D C^%DTC S MDCDT=X
"RTN","MDRPCOP",137,0)
 S MDX=0 F  S MDX=$O(^TMP("MDTMP",$J,MDX)) Q:'MDX  D:"saprc"[$P(^(MDX),U,4)
"RTN","MDRPCOP",138,0)
 .I $P($G(^TMP("MDTMP",$J,MDX)),U,4)="c" Q:$P($G(^TMP("MDTMP",$J,MDX)),U,1)<MDCDT
"RTN","MDRPCOP",139,0)
 .S ^TMP("MDCONL",$J,$P($G(^TMP("MDTMP",$J,MDX)),U,5))=$P($G(^TMP("MDTMP",$J,MDX)),U,1)
"RTN","MDRPCOP",140,0)
 K ^TMP("MDTMP",$J)
"RTN","MDRPCOP",141,0)
 F MDX=0:0 S MDX=$O(^MDD(702,"B",DFN,+MDX))_"," Q:'MDX  D
"RTN","MDRPCOP",142,0)
 .Q:'$$GET1^DIQ(702,MDX,.05,"I")
"RTN","MDRPCOP",143,0)
 .Q:$G(^TMP("MDCONL",$J,+$$GET1^DIQ(702,MDX,.05,"I")))=""
"RTN","MDRPCOP",144,0)
 .S MDMULT=+$$GET1^DIQ(702,MDX,".04:.12","I")
"RTN","MDRPCOP",145,0)
 .S MDYR=$S(MDMULT<1:MDCOM,1:MDCDT)
"RTN","MDRPCOP",146,0)
 .I MDNUM Q:$$GET1^DIQ(702,MDX,.09,"I")=3&($$GET1^DIQ(702,MDX,.02,"I")<MDYR)
"RTN","MDRPCOP",147,0)
 .I MDMULT=1&(+MDMULN>0) Q:$$GET1^DIQ(702,MDX,.09,"I")=3&($$GET1^DIQ(702,MDX,.02,"I")<MDCDY)
"RTN","MDRPCOP",148,0)
 .S MDREQDT="" I +$$GET1^DIQ(702,MDX,.05,"I") S MDREQDT=$G(^TMP("MDCONL",$J,+$$GET1^DIQ(702,MDX,.05,"I")))
"RTN","MDRPCOP",149,0)
 .I MDREQDT'="" S MDREQDT=$$FMTE^XLFDT(MDREQDT,"1P")
"RTN","MDRPCOP",150,0)
 .S MDREQ=$$GET1^DIQ(702,MDX,.04)_"  "_+MDX_"  (Consult #:"_$$GET1^DIQ(702,MDX,.05,"I")_$S(MDREQDT'="":" Requested: "_MDREQDT,1:"")_")"
"RTN","MDRPCOP",151,0)
 .S Z=$$GET1^DIQ(702,MDX,".04:.02","I")_U_MDREQ_U_$$GET1^DIQ(702,MDX,.02,"I")_U_$$GET1^DIQ(702,MDX,.09)_U_$$GET1^DIQ(702,MDX,.11)_U_$$GET1^DIQ(702,MDX,.991)
"RTN","MDRPCOP",152,0)
 .S Y=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOP",153,0)
 .S @RESULTS@(Y)="702;"_+MDX_U_Z
"RTN","MDRPCOP",154,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOP",155,0)
 K ^TMP("MDCONL",$J)
"RTN","MDRPCOP",156,0)
 Q
"RTN","MDRPCOP",157,0)
 ;
"RTN","MDRPCOP",158,0)
GETVST ; [Procedure] Return list of visits
"RTN","MDRPCOP",159,0)
 N BEG,END,VAERR,VASD,BDT,DTM,EDT,LOC,NOW,MDQUERY,MDLST,MDTDF,STI,STS,TODAY,I,J,K,XI,XE,X
"RTN","MDRPCOP",160,0)
 S NOW=$$NOW^XLFDT(),TODAY=$P(NOW,".",1),MDTDF=DFN
"RTN","MDRPCOP",161,0)
 S BEG=$$X2FM($$GETBEG),END=$$X2FM($$GETEND)+0.2359
"RTN","MDRPCOP",162,0)
 S MDLST="",MDSTOP=""
"RTN","MDRPCOP",163,0)
 I END>NOW D   ; get future encounters, past cancels/no-shows from VADPT
"RTN","MDRPCOP",164,0)
 .S VASD("F")=BEG
"RTN","MDRPCOP",165,0)
 .S VASD("T")=END
"RTN","MDRPCOP",166,0)
 .S VASD("W")="129"
"RTN","MDRPCOP",167,0)
 .D SDA^VADPT
"RTN","MDRPCOP",168,0)
 .S I=0 F  S I=$O(^UTILITY("VASD",$J,I)) Q:'I  D
"RTN","MDRPCOP",169,0)
 ..S XI=^UTILITY("VASD",$J,I,"I"),XE=^("E")
"RTN","MDRPCOP",170,0)
 ..S DTM=$P(XI,U),IEN=$P(XI,U,2),STI=$P(XI,U,3)
"RTN","MDRPCOP",171,0)
 ..S LOC=$P(XE,U,2),STS=$P(XE,U,3)
"RTN","MDRPCOP",172,0)
 ..I DTM<TODAY,(STI=""!(STI["I")!(STI="NT")) Q  ; no prior kept appts
"RTN","MDRPCOP",173,0)
 ..S MDLST(DTM,"A",1)="A;"_DTM_";"_IEN_U_DTM_U_LOC_U_STS
"RTN","MDRPCOP",174,0)
 .K ^UTILITY("VASD",$J)
"RTN","MDRPCOP",175,0)
 I BEG'>NOW D  ;past encounters from ACRP Toolkit - set in CALLBACK
"RTN","MDRPCOP",176,0)
 .S BDT=BEG
"RTN","MDRPCOP",177,0)
 .S EDT=$S(END<NOW:END,1:NOW)
"RTN","MDRPCOP",178,0)
 .D OPEN^SDQ(.MDQUERY)
"RTN","MDRPCOP",179,0)
 .I '$$ERRCHK^SDQUT() D INDEX^SDQ(.MDQUERY,"PATIENT/DATE","SET")
"RTN","MDRPCOP",180,0)
 .I '$$ERRCHK^SDQUT() D PAT^SDQ(.MDQUERY,DFN,"SET")
"RTN","MDRPCOP",181,0)
 .I '$$ERRCHK^SDQUT() D DATE^SDQ(.MDQUERY,BDT,EDT,"SET")
"RTN","MDRPCOP",182,0)
 .I '$$ERRCHK^SDQUT() D
"RTN","MDRPCOP",183,0)
 ..D SCANCB^SDQ(.MDQUERY,"D CALLBACK^ORWCV(Y,Y0,$NA(MDLST),.MDSTOP)","SET")
"RTN","MDRPCOP",184,0)
 .I '$$ERRCHK^SDQUT() D ACTIVE^SDQ(.MDQUERY,"TRUE","SET")
"RTN","MDRPCOP",185,0)
 .I '$$ERRCHK^SDQUT() D SCAN^SDQ(.MDQUERY,"FORWARD")
"RTN","MDRPCOP",186,0)
 .D CLOSE^SDQ(.MDQUERY)
"RTN","MDRPCOP",187,0)
 N TIM,MOV,MDX0,Y,MTIM,XTYP,XLOC,XLOCI,HLOC,EARLY,DONE ; admits
"RTN","MDRPCOP",188,0)
 S EARLY=BEG,DONE=0 S:$G(DFN)="" DFN=MDTDF
"RTN","MDRPCOP",189,0)
 S TIM="" F  S TIM=$O(^DGPM("ATID1",DFN,TIM)) Q:TIM'>0  D  Q:DONE
"RTN","MDRPCOP",190,0)
 .S MOV=0  F  S MOV=$O(^DGPM("ATID1",DFN,TIM,MOV)) Q:MOV'>0  D  Q:DONE
"RTN","MDRPCOP",191,0)
 ..D GETS^DIQ(405,+MOV_",",".01;.04;.06","IE","MDX0") S MTIM=$G(MDX0(405,MOV_",",".01","I"))
"RTN","MDRPCOP",192,0)
 ..S XTYP=$G(MDX0(405,+MOV_",",".04","E"))
"RTN","MDRPCOP",193,0)
 ..S XLOC=$G(MDX0(405,+MOV_",",".06","E"))
"RTN","MDRPCOP",194,0)
 ..S XLOCI=+$G(MDX0(405,+MOV_",",".06","I")),HLOC=+$G(^DIC(42,+XLOCI,44))
"RTN","MDRPCOP",195,0)
 ..S MDLST(MTIM,"I",1)="I;"_MTIM_";"_HLOC_U_MTIM_U_"Inpatient Stay"_U_XLOC_U_XTYP
"RTN","MDRPCOP",196,0)
 ..S DONE=1  ; Not sure if I should include all stays <DRP@Hines>
"RTN","MDRPCOP",197,0)
 S I=0 F  S I=$O(MDLST(I)) Q:'I  D
"RTN","MDRPCOP",198,0)
 .S J="" F  S J=$O(MDLST(I,J)) Q:J=""  D
"RTN","MDRPCOP",199,0)
 ..S K=0 F  S K=$O(MDLST(I,J,K)) Q:'K  D
"RTN","MDRPCOP",200,0)
 ...S @RESULTS@($O(@RESULTS@(""),-1)+1)=MDLST(I,J,K)
"RTN","MDRPCOP",201,0)
 S:$G(DFN)="" DFN=MDTDF S @RESULTS@(0)=+$O(@RESULTS@(""),-1)_U_($$GET1^DIQ(2,DFN_",",.1)]"")
"RTN","MDRPCOP",202,0)
 Q
"RTN","MDRPCOP",203,0)
 ;
"RTN","MDRPCOP",204,0)
GETBEG() ; Get Beginning Date Range
"RTN","MDRPCOP",205,0)
 I $$GET^XPAR("SYS","MD APPOINT START DATE",1)>1 Q "T-"_$$GET^XPAR("SYS","MD APPOINT START DATE",1)
"RTN","MDRPCOP",206,0)
 Q "T-200"
"RTN","MDRPCOP",207,0)
GETEND() ; Get Ending Date Range
"RTN","MDRPCOP",208,0)
 I $$GET^XPAR("SYS","MD APPOINT END DATE",1)>1 Q "T+"_$$GET^XPAR("SYS","MD APPOINT END DATE",1)
"RTN","MDRPCOP",209,0)
 Q "T"
"RTN","MDRPCOP",210,0)
LOGSEC ; [Procedure] Log Security
"RTN","MDRPCOP",211,0)
 N RES
"RTN","MDRPCOP",212,0)
 D NOTICE^DGSEC4(.RES,DFN,DATA,1)
"RTN","MDRPCOP",213,0)
 S @RESULTS@(0)=$S(+RES:"1^Logged",1:"-1^Unable to log")
"RTN","MDRPCOP",214,0)
 Q
"RTN","MDRPCOP",215,0)
 ;
"RTN","MDRPCOP",216,0)
RPC(RESULTS,OPTION,DFN,DATA) ; [Procedure] Main RPC call tag
"RTN","MDRPCOP",217,0)
 NEW DFNIENS,GMRAL,GMVALG,GN,IENS,MDDFN,MDERR,MDFDA,MDFLD,MDHL7,MDID,MDIDS,MDIEN,MDIENS,MDRET,MDX,MDY,VA,VADM,VAERR,VAIN,Z
"RTN","MDRPCOP",218,0)
 S RESULTS=$NA(^TMP($J)) K @RESULTS
"RTN","MDRPCOP",219,0)
 D:$T(@OPTION)]"" @OPTION
"RTN","MDRPCOP",220,0)
 D:'$D(@RESULTS) BADRPC^MDRPCU("MD TMDPATIENT","MDRPCOP",OPTION)
"RTN","MDRPCOP",221,0)
 D CLEAN^DILF
"RTN","MDRPCOP",222,0)
 Q
"RTN","MDRPCOP",223,0)
 ;
"RTN","MDRPCOP",224,0)
SELECT ; [Procedure] Select patient
"RTN","MDRPCOP",225,0)
 ; Moved to continuation routine at MD*1.0*6 due to routine size
"RTN","MDRPCOP",226,0)
 D SELECT^MDRPCOP1
"RTN","MDRPCOP",227,0)
 Q
"RTN","MDRPCOP",228,0)
 ;
"RTN","MDRPCOP",229,0)
X2FM(X) ; [Function] return FM date given relative date
"RTN","MDRPCOP",230,0)
 N %DT S %DT="TS" D ^%DT
"RTN","MDRPCOP",231,0)
 Q Y
"RTN","MDRPCOP",232,0)
 ;
"RTN","MDRPCOR")
0^4^B92120786^B87786828
"RTN","MDRPCOR",1,0)
MDRPCOR ; HOIFO/DP - Object RPCs (TMDRecordId) ; [01-10-2003 09:14]
"RTN","MDRPCOR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**17,20**;Apr 01, 2004;Build 9
"RTN","MDRPCOR",3,0)
 ; Description:
"RTN","MDRPCOR",4,0)
 ; This routine manages both the MDVCL components and
"RTN","MDRPCOR",5,0)
 ; the TMDRecordID object
"RTN","MDRPCOR",6,0)
 ;
"RTN","MDRPCOR",7,0)
 ; Integration Agreements:
"RTN","MDRPCOR",8,0)
 ; IA# 2054 [Supported] Call to DILF
"RTN","MDRPCOR",9,0)
 ; IA# 2055 [Supported] Call to DILFD
"RTN","MDRPCOR",10,0)
 ; IA# 2056 [Supported] Call to DIQ
"RTN","MDRPCOR",11,0)
 ; IA# 2263 [Supported] Call to XPAR
"RTN","MDRPCOR",12,0)
 ; IA# 3568 [Subscription] TIUCP call
"RTN","MDRPCOR",13,0)
 ; IA# 3266 [Subscription] Calls to DPTLK1
"RTN","MDRPCOR",14,0)
 ; IA# 3267 [Subscription] Call to DPTLK1
"RTN","MDRPCOR",15,0)
 ; IA# 10003 [Supported] Call to %DT
"RTN","MDRPCOR",16,0)
 ; IA# 10104 [Public] Call to XLFSTR
"RTN","MDRPCOR",17,0)
 ;
"RTN","MDRPCOR",18,0)
CHANGES ; [Procedure] Returns number of changes to save
"RTN","MDRPCOR",19,0)
 S MDCHNG=0,(MDDD,MDIENS)=""
"RTN","MDRPCOR",20,0)
 F  S MDDD=$O(^TMP("MDFDA",$J,MDDD)) Q:MDDD=""  D
"RTN","MDRPCOR",21,0)
 .Q:$E(MDDD,1,$L(DD))'=DD  ; Not even the right DD
"RTN","MDRPCOR",22,0)
 .F  S MDIENS=$O(^TMP("MDFDA",$J,MDDD,MDIENS)) Q:MDIENS=""  D
"RTN","MDRPCOR",23,0)
 ..Q:$E(MDIENS,$L(MDIENS)-$L(IENS)+1,$L(MDIENS))'=IENS
"RTN","MDRPCOR",24,0)
 ..F FLD=0:0 S FLD=$O(^TMP("MDFDA",$J,MDDD,MDIENS,FLD)) Q:'FLD  D
"RTN","MDRPCOR",25,0)
 ...S MDCHNG=MDCHNG+1
"RTN","MDRPCOR",26,0)
 S @RESULTS@(0)=MDCHNG_"^Changes to Save"
"RTN","MDRPCOR",27,0)
 Q
"RTN","MDRPCOR",28,0)
 ;
"RTN","MDRPCOR",29,0)
CHKVER ; [Procedure] 
"RTN","MDRPCOR",30,0)
 S @RESULTS@(0)=+$G(DATA)'<1
"RTN","MDRPCOR",31,0)
 Q
"RTN","MDRPCOR",32,0)
 ;
"RTN","MDRPCOR",33,0)
CLEARFDA ; [Procedure] Discards changes in the FDA
"RTN","MDRPCOR",34,0)
 S MDFDA=$NA(^TMP("MDFDA",$J))
"RTN","MDRPCOR",35,0)
 F  S MDFDA=$Q(@MDFDA) Q:MDFDA=""  Q:$QS(MDFDA,2)'=$J  D
"RTN","MDRPCOR",36,0)
 .S MDDD=$QS(MDFDA,3),MDIENS=$QS(MDFDA,4)
"RTN","MDRPCOR",37,0)
 .I MDIENS'?@(".E1"""_IENS_"""") Q
"RTN","MDRPCOR",38,0)
 .I MDDD'?@("1"""_DD_""".E") Q
"RTN","MDRPCOR",39,0)
 .K ^TMP("MDFDA",$J,MDDD,MDIENS)
"RTN","MDRPCOR",40,0)
 S @RESULTS@(0)="1^FDA CLEARED"
"RTN","MDRPCOR",41,0)
 Q
"RTN","MDRPCOR",42,0)
 ;
"RTN","MDRPCOR",43,0)
DELREC ; [Procedure] Delete a fileman record
"RTN","MDRPCOR",44,0)
 D VAL^DIE(DD,IENS,.01,"FR","@",.MDRET,"MDDEL","MDERR")
"RTN","MDRPCOR",45,0)
 I MDRET="^" D ERROR^MDRPCU($NA(^TMP($J)),.MDERR) Q
"RTN","MDRPCOR",46,0)
 D FILE^DIE("","MDDEL","MDERR")
"RTN","MDRPCOR",47,0)
 I $D(MDERR) D ERROR^MDRPCU($NA(^TMP($J)),.MDERR) Q
"RTN","MDRPCOR",48,0)
 D RPC(.X,"CLEARFDA",DD,IENS)
"RTN","MDRPCOR",49,0)
 S @RESULTS@(0)="1^Record Deleted"
"RTN","MDRPCOR",50,0)
 Q
"RTN","MDRPCOR",51,0)
 ;
"RTN","MDRPCOR",52,0)
DT ; [Procedure] Convert date/time via %DT
"RTN","MDRPCOR",53,0)
 S DATA=$G(DATA,"NOW^TS")
"RTN","MDRPCOR",54,0)
 S X=$P(DATA,U,1),%DT=$P(DATA,U,2)
"RTN","MDRPCOR",55,0)
 D ^%DT
"RTN","MDRPCOR",56,0)
 I Y<1 S @RESULTS@(0)=Y_U_"Invalid date/time input '"_X_"'"
"RTN","MDRPCOR",57,0)
 E  S @RESULTS@(0)=1_U_Y D DD^%DT S $P(@RESULTS@(0),U,3)=Y
"RTN","MDRPCOR",58,0)
 Q
"RTN","MDRPCOR",59,0)
 ;
"RTN","MDRPCOR",60,0)
EXISTS ; [Procedure] Verify that a record exists
"RTN","MDRPCOR",61,0)
 S X=$$ROOT^DILFD(DD,IENS)
"RTN","MDRPCOR",62,0)
 S @RESULTS@(0)=$D(@(X_(+IENS)_",0)"))
"RTN","MDRPCOR",63,0)
 Q
"RTN","MDRPCOR",64,0)
 ;
"RTN","MDRPCOR",65,0)
FILENAME ; [Procedure] Return a filename
"RTN","MDRPCOR",66,0)
 I $$VFILE^DILFD(DD) S @RESULTS@(0)="1^"_$$GET1^DID(DD,"","","NAME")
"RTN","MDRPCOR",67,0)
 E  S @RESULTS@(0)="-1^Not a valid file #"
"RTN","MDRPCOR",68,0)
 Q
"RTN","MDRPCOR",69,0)
 ;
"RTN","MDRPCOR",70,0)
GETCODES ; [Procedure] Returns set of codes
"RTN","MDRPCOR",71,0)
 S MDTYPE=$$GET1^DID(DD,FLD,"","TYPE","","MDERR")
"RTN","MDRPCOR",72,0)
 I $D(MDERR) D ERROR^MDRPCU($NA(^TMP($J)),.MDERR) Q
"RTN","MDRPCOR",73,0)
 D:MDTYPE="SET"
"RTN","MDRPCOR",74,0)
 .S MDSET=$$GET1^DID(DD,FLD,"","POINTER")
"RTN","MDRPCOR",75,0)
 .F X=1:1:$L(MDSET,";")-1 D
"RTN","MDRPCOR",76,0)
 ..S @RESULTS@(X)=$P(MDSET,";",X)
"RTN","MDRPCOR",77,0)
 .S @RESULTS@(0)=+$O(@RESULTS@(""),-1)_"^Set of Codes"
"RTN","MDRPCOR",78,0)
 D:MDTYPE="POINTER"
"RTN","MDRPCOR",79,0)
 .S MDPTR=$$GET1^DID(DD,FLD,"","POINTER")
"RTN","MDRPCOR",80,0)
 .F X=0:0 S X=$O(@(U_MDPTR_"X)")) Q:'X  D
"RTN","MDRPCOR",81,0)
 ..S Y=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOR",82,0)
 ..S @RESULTS@(Y)="`"_X_":"_$P(@(U_MDPTR_"X,0)"),U,1)
"RTN","MDRPCOR",83,0)
 .S @RESULTS@(0)=+$O(@RESULTS@(""),-1)_"^Pointers as set of codes"
"RTN","MDRPCOR",84,0)
 Q
"RTN","MDRPCOR",85,0)
 ;
"RTN","MDRPCOR",86,0)
GETDATA ; [Procedure] Returns data for a field
"RTN","MDRPCOR",87,0)
 I $$GET1^DID(DD,FLD,"","TYPE")["WORD" D  Q
"RTN","MDRPCOR",88,0)
 .I $D(^TMP("MDFDA",$J,DD,IENS,FLD)) M ^TMP($J)=^TMP("MDFDA",$J,DD,IENS,FLD)
"RTN","MDRPCOR",89,0)
 .E  S X=$$GET1^DIQ(DD,IENS,FLD,"",$NA(^TMP($J)))
"RTN","MDRPCOR",90,0)
 .S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOR",91,0)
 I $$GET1^DID(DD,FLD,"","TYPE")["POINTER"&(DD=703.1)&(FLD=.05) D  Q
"RTN","MDRPCOR",92,0)
 .S @RESULTS@(0)=$$GET1^DIQ(DD,IENS,FLD,"I") Q
"RTN","MDRPCOR",93,0)
 I $D(^TMP("MDFDA",$J,DD,IENS,FLD)) S Y=^(FLD) D  Q
"RTN","MDRPCOR",94,0)
 .I $G(DATA) S @RESULTS@(0)=Y Q  ; Internal Format
"RTN","MDRPCOR",95,0)
 .S @RESULTS@(0)=$$EXTERNAL^DILFD(DD,FLD,"",Y)
"RTN","MDRPCOR",96,0)
 S @RESULTS@(0)=$$GET1^DIQ(DD,IENS,FLD,$S($G(DATA):"I",1:""))
"RTN","MDRPCOR",97,0)
 Q
"RTN","MDRPCOR",98,0)
 ;
"RTN","MDRPCOR",99,0)
GETHELP ; [Procedure] Returns fileman help
"RTN","MDRPCOR",100,0)
 D HELP^DIE(DD,IENS,FLD,"D")
"RTN","MDRPCOR",101,0)
 D:'$O(^TMP("DIHELP",$J,0)) HELP^DIE(DD,IENS,FLD,"A")
"RTN","MDRPCOR",102,0)
 I '$O(^TMP("DIHELP",$J,0)) D  Q
"RTN","MDRPCOR",103,0)
 .S @RESULTS@(0)=1
"RTN","MDRPCOR",104,0)
 .S @RESULTS@(1)="SORRY: No help available"
"RTN","MDRPCOR",105,0)
 M ^TMP($J)=^TMP("DIHELP",$J)
"RTN","MDRPCOR",106,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOR",107,0)
 Q
"RTN","MDRPCOR",108,0)
 ;
"RTN","MDRPCOR",109,0)
GETIDS ; [Procedure] Returns list of required ID's
"RTN","MDRPCOR",110,0)
 D FILE^DID(DD,"","REQUIRED IDENTIFIERS;NAME;ENTRIES","MDRET")
"RTN","MDRPCOR",111,0)
 S X=$NA(MDRET("REQUIRED IDENTIFIERS",0))
"RTN","MDRPCOR",112,0)
 F  S X=$Q(@X) Q:X=""  D
"RTN","MDRPCOR",113,0)
 .S Y=$O(@RESULTS@(""),-1)+1
"RTN","MDRPCOR",114,0)
 .S @RESULTS@(Y)=@X_U_$$GET1^DID(DD,@X,"","LABEL")_U_$$GET1^DID(DD,@X,"","TYPE")
"RTN","MDRPCOR",115,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)_U_MDRET("NAME")_U_MDRET("ENTRIES")
"RTN","MDRPCOR",116,0)
 Q
"RTN","MDRPCOR",117,0)
 ;
"RTN","MDRPCOR",118,0)
GETLABEL ; [Procedure] Get field label/title
"RTN","MDRPCOR",119,0)
 S MDLBL=$$GET1^DID(DD,FLD,"",$S($G(DATA):"TITLE",1:"LABEL"))
"RTN","MDRPCOR",120,0)
 S:$G(DATA)&(MDLBL="") MDLBL=$$GET1^DID(DD,FLD,"","LABEL")
"RTN","MDRPCOR",121,0)
 S @RESULTS@(0)=MDLBL_":"
"RTN","MDRPCOR",122,0)
 Q
"RTN","MDRPCOR",123,0)
 ;
"RTN","MDRPCOR",124,0)
GETLST ; [Procedure] Get list of records
"RTN","MDRPCOR",125,0)
 S IENS=$G(IENS),FLD=$G(FLD,"@;.01")
"RTN","MDRPCOR",126,0)
 S:$P(FLD,";",1)'="@" FLD="@;"_FLD
"RTN","MDRPCOR",127,0)
 D LIST^DIC(DD,IENS,FLD,"P",,,,,$G(DATA))
"RTN","MDRPCOR",128,0)
 F X=0:0 S X=$O(^TMP("DILIST",$J,X))  Q:'X  D
"RTN","MDRPCOR",129,0)
 .S @RESULTS@(X)=DD_";"_^TMP("DILIST",$J,X,0)
"RTN","MDRPCOR",130,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOR",131,0)
 F X=2:1 Q:$P(^TMP("DILIST",$J,0,"MAP"),U,X)=""  D
"RTN","MDRPCOR",132,0)
 .S @RESULTS@(0)=@RESULTS@(0)_U_$$GET1^DID(DD,$P(^TMP("DILIST",$J,0,"MAP"),U,X),"","LABEL")
"RTN","MDRPCOR",133,0)
 Q
"RTN","MDRPCOR",134,0)
 ;
"RTN","MDRPCOR",135,0)
LOCK ; [Procedure] Lock a record
"RTN","MDRPCOR",136,0)
 D LOCK^MDRPCU(.RESULTS,DD,IENS) Q
"RTN","MDRPCOR",137,0)
 ;
"RTN","MDRPCOR",138,0)
LOOKUP ; [Procedure] Lookup on a DD
"RTN","MDRPCOR",139,0)
 I DD=2 D RPC(.RESULTS,"PTLKUP",DD,,,DATA) Q
"RTN","MDRPCOR",140,0)
 D FIND^DIC(DD,IENS,.01,"P",DATA)
"RTN","MDRPCOR",141,0)
 F X=0:0 S X=$O(^TMP("DILIST",$J,X)) Q:'X  D
"RTN","MDRPCOR",142,0)
 .S @RESULTS@(X)=DD_";"_$P(^TMP("DILIST",$J,X,0),U,1,2)
"RTN","MDRPCOR",143,0)
 I '$D(^TMP($J)) S @RESULTS@(0)="-1^No entries found matching '"_DATA_"'"
"RTN","MDRPCOR",144,0)
 E  S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOR",145,0)
 Q
"RTN","MDRPCOR",146,0)
 ;
"RTN","MDRPCOR",147,0)
NEWIEN ; [Procedure] Return next available IEN
"RTN","MDRPCOR",148,0)
 S @RESULTS@(0)=$O(@($$ROOT^DILFD(DD,$G(IENS))_"""A"")"),-1)+1
"RTN","MDRPCOR",149,0)
 Q
"RTN","MDRPCOR",150,0)
 ;
"RTN","MDRPCOR",151,0)
NEWREC ; [Procedure] Create a new record
"RTN","MDRPCOR",152,0)
 I $G(DATA)]"" D  Q:MDRET="^"
"RTN","MDRPCOR",153,0)
 .D VAL^DIE(DD,"+1,"_IENS,$P(DATA,U,1),"F",$P(DATA,U,2,250),.MDRET,"MDNEW","MDERR")
"RTN","MDRPCOR",154,0)
 .I MDRET="^" D ERROR^MDRPCU($NA(^TMP($J)),.MDERR)
"RTN","MDRPCOR",155,0)
 S MDTMP="DATA"
"RTN","MDRPCOR",156,0)
 F  S MDTMP=$Q(@MDTMP) Q:MDTMP=""  D  Q:MDRET="^"
"RTN","MDRPCOR",157,0)
 .D VAL^DIE(DD,"+1,"_IENS,$P(@MDTMP,U,1),"F",$P(@MDTMP,U,2,250),.MDRET,"MDNEW","MDERR")
"RTN","MDRPCOR",158,0)
 .I MDRET="^" D ERROR^MDRPCU($NA(^TMP($J)),.MDERR)
"RTN","MDRPCOR",159,0)
 D:$D(MDNEW) UPDATE^DIE("","MDNEW","MDIEN")
"RTN","MDRPCOR",160,0)
 S @RESULTS@(0)=$G(MDIEN(1),"-1^Unable to create record")
"RTN","MDRPCOR",161,0)
 Q
"RTN","MDRPCOR",162,0)
 ;
"RTN","MDRPCOR",163,0)
PTLKUP ; [Procedure] Patient lookup handled separately for security
"RTN","MDRPCOR",164,0)
 D FIND^DIC(2,,"@;.01;.02;.03;.09","MP",DATA,45,"B^BS^BS5^SSN")
"RTN","MDRPCOR",165,0)
 I $P($G(^TMP("DILIST",$J,0)),U,3) D  Q
"RTN","MDRPCOR",166,0)
 .S @RESULTS@(0)="-1^Too many entries found matching '"_DATA_"', please be more specific."
"RTN","MDRPCOR",167,0)
 F MDX=0:0 S MDX=$O(^TMP("DILIST",$J,MDX)) Q:'MDX  D
"RTN","MDRPCOR",168,0)
 .S @RESULTS@(MDX)="2;"_$P(^TMP("DILIST",$J,MDX,0),U,1,5)
"RTN","MDRPCOR",169,0)
 .S MDIENS=+^TMP("DILIST",$J,MDX,0)_","
"RTN","MDRPCOR",170,0)
 .S $P(@RESULTS@(MDX),U,3)=$$GET1^DIQ(2,MDIENS,.02,"I")
"RTN","MDRPCOR",171,0)
 .S $P(@RESULTS@(MDX),U,4)=$$GET1^DIQ(2,MDIENS,.03,"I")
"RTN","MDRPCOR",172,0)
 .S $P(@RESULTS@(MDX),U,10)=$$DOB^DPTLK1(+MDIENS)
"RTN","MDRPCOR",173,0)
 .S $P(@RESULTS@(MDX),U,11)=$$SSN^DPTLK1(+MDIENS)
"RTN","MDRPCOR",174,0)
 I '$D(^TMP($J)) S @RESULTS@(0)="-1^No entries found matching '"_DATA_"'"
"RTN","MDRPCOR",175,0)
 E  S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOR",176,0)
 Q
"RTN","MDRPCOR",177,0)
 ;
"RTN","MDRPCOR",178,0)
PTRLKUP ; [Procedure] Lookup a pointer field
"RTN","MDRPCOR",179,0)
 S PTRDD=+$P($$GET1^DID(DD,FLD,"","SPECIFIER"),"P",2)
"RTN","MDRPCOR",180,0)
 I PTRDD=8925.1 D  Q  ; Handle TIU Note lookup with TIU API
"RTN","MDRPCOR",181,0)
 .S DATA=$$UP^XLFSTR(DATA)
"RTN","MDRPCOR",182,0)
 .D LNGCP^TIUCP(.MDRET,DATA)
"RTN","MDRPCOR",183,0)
 .I '$O(MDRET(0)) S @RESULTS@(0)=0 Q
"RTN","MDRPCOR",184,0)
 .I $D(MDRET(44)),$P($P(MDRET(44),U,2),DATA)="" S @RESULTS@(0)=0 Q
"RTN","MDRPCOR",185,0)
 .F X=0:0 S X=$O(MDRET(X)) Q:'X  D:$P($P(MDRET(X),U,2),DATA)=""
"RTN","MDRPCOR",186,0)
 ..S @RESULTS@(X)="8925.1;"_MDRET(X)
"RTN","MDRPCOR",187,0)
 .S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOR",188,0)
 D FIND^DIC(PTRDD,"","","PM",DATA,151,"",$G(PTRSCRN))
"RTN","MDRPCOR",189,0)
 F X=0:0 S X=$O(^TMP("DILIST",$J,X)) Q:'X  D
"RTN","MDRPCOR",190,0)
 .S @RESULTS@(X)=PTRDD_";"_^TMP("DILIST",$J,X,0)
"RTN","MDRPCOR",191,0)
 S @RESULTS@(0)=+$O(@RESULTS@(""),-1)
"RTN","MDRPCOR",192,0)
 Q
"RTN","MDRPCOR",193,0)
 ;
"RTN","MDRPCOR",194,0)
RENAME ; [Procedure] Rename a record
"RTN","MDRPCOR",195,0)
 I DATA=""!(DATA="@") S @RESULTS@(0)="-1^Deletion Not Supported" Q
"RTN","MDRPCOR",196,0)
 I $$DUPS^MDRPCU(DD,+IENS,DATA) D  Q
"RTN","MDRPCOR",197,0)
 .S @RESULTS@(0)="-1",@RESULTS@(1)="Duplicates not allowed"
"RTN","MDRPCOR",198,0)
 D VAL^DIE(DD,IENS,.01,"EFHR",DATA,.MDRET,"MDRENAME","MDERR")
"RTN","MDRPCOR",199,0)
 I MDRET="^" D ERROR^MDRPCU($NA(^TMP($J)),.MDERR) Q
"RTN","MDRPCOR",200,0)
 D FILE^DIE("","MDRENAME")
"RTN","MDRPCOR",201,0)
 S @RESULTS@(0)="1^"_MDRET(0)
"RTN","MDRPCOR",202,0)
 K ^TMP("MDFDA",$J,DD,IENS,.01) ; In case of editing
"RTN","MDRPCOR",203,0)
 Q
"RTN","MDRPCOR",204,0)
 ;
"RTN","MDRPCOR",205,0)
RPC(RESULTS,OPTION,DD,IENS,FLD,DATA) ; [Procedure] RPC call tag
"RTN","MDRPCOR",206,0)
 NEW MDCHNG,MDDD,MDDEL,MDERR,MDFDA,MDGBL,MDIENS,MDIEN,MDLBL,MDNEW,MDPTR,MDRENAME,MDRET,MDSET,MDTYPE,MDUTL,PTRDD,PTRSCRN
"RTN","MDRPCOR",207,0)
 S RESULTS=$NA(^TMP($J)) K @RESULTS
"RTN","MDRPCOR",208,0)
 D:$T(@OPTION)]"" @OPTION
"RTN","MDRPCOR",209,0)
 D:'$D(@RESULTS) BADRPC^MDRPCU("MD TMDRECORDID","MDRPCOR",OPTION)
"RTN","MDRPCOR",210,0)
 D CLEAN^DILF
"RTN","MDRPCOR",211,0)
 Q
"RTN","MDRPCOR",212,0)
 ;
"RTN","MDRPCOR",213,0)
SAVEFDA ; [Procedure] Save changes to the VistA database
"RTN","MDRPCOR",214,0)
 K ^TMP("MDSAVE",$J)
"RTN","MDRPCOR",215,0)
 S MDFDA=$NA(^TMP("MDFDA",$J))
"RTN","MDRPCOR",216,0)
 F  S MDFDA=$Q(@MDFDA) Q:MDFDA=""  Q:$QS(MDFDA,2)'=$J  D
"RTN","MDRPCOR",217,0)
 .S MDDD=$QS(MDFDA,3),MDIENS=$QS(MDFDA,4)
"RTN","MDRPCOR",218,0)
 .I MDIENS'?@(".E1"""_IENS_"""") Q
"RTN","MDRPCOR",219,0)
 .I MDDD'?@("1"""_DD_""".E") Q
"RTN","MDRPCOR",220,0)
 .M ^TMP("MDSAVE",$J,MDDD,MDIENS)=^TMP("MDFDA",$J,MDDD,MDIENS)
"RTN","MDRPCOR",221,0)
 .K ^TMP("MDFDA",$J,MDDD,MDIENS)
"RTN","MDRPCOR",222,0)
 I '$D(^TMP("MDSAVE",$J)) S @RESULTS@(0)="1^No changes to save" Q
"RTN","MDRPCOR",223,0)
 D:IENS?1"+1,".NP  ; New record
"RTN","MDRPCOR",224,0)
 .D UPDATE^DIE("",$NA(^TMP("MDSAVE",$J)),"MDIEN","MDERR")
"RTN","MDRPCOR",225,0)
 .I '$D(MDERR) S @RESULTS@(0)="1^New Record Created^"_MDIEN(1) Q
"RTN","MDRPCOR",226,0)
 .D ERROR^MDRPCU($NA(^TMP($J)),.MDERR)
"RTN","MDRPCOR",227,0)
 .M ^TMP("MDFDA",$J)=^TMP("MDSAVE",$J)
"RTN","MDRPCOR",228,0)
 D:IENS'?1"+1,".NP  ; Existing record
"RTN","MDRPCOR",229,0)
 .D FILE^DIE("",$NA(^TMP("MDSAVE",$J)),"MDERR")
"RTN","MDRPCOR",230,0)
 .I '$D(MDERR) S @RESULTS@(0)="1^FDA Saved" Q
"RTN","MDRPCOR",231,0)
 .D ERROR^MDRPCU($NA(^TMP($J)),.MDERR)
"RTN","MDRPCOR",232,0)
 .M ^TMP("MDFDA",$J)=^TMP("MDSAVE",$J)
"RTN","MDRPCOR",233,0)
 K ^TMP("MDSAVE",$J)
"RTN","MDRPCOR",234,0)
 I DD<702!(DD>703.1999) D  Q
"RTN","MDRPCOR",235,0)
 .S @RESULTS@(0)="-1^Non CLINICAL PROCEDURES DD number space"
"RTN","MDRPCOR",236,0)
 I DD=702.09&(+$$GET^XPAR("SYS","MD DEVICE SURVEY TRANSMISSION",1)) D COL^MDDEVCL
"RTN","MDRPCOR",237,0)
 Q
"RTN","MDRPCOR",238,0)
 ;
"RTN","MDRPCOR",239,0)
SETFDA ; [Procedure] Validate data and store in FDA
"RTN","MDRPCOR",240,0)
 D VAL^DIE(DD,IENS,FLD,"F",.DATA,.MDRET,$NA(^TMP("MDFDA",$J)),"MDERR")
"RTN","MDRPCOR",241,0)
 I MDRET="^" D ERROR^MDRPCU($NA(^TMP($J)),.MDERR) Q
"RTN","MDRPCOR",242,0)
 S @RESULTS@(0)="1^FDA Set"
"RTN","MDRPCOR",243,0)
 Q
"RTN","MDRPCOR",244,0)
 ;
"RTN","MDRPCOR",245,0)
UNLOCK ; [Procedure] Unlock a record
"RTN","MDRPCOR",246,0)
 D UNLOCK^MDRPCU(.RESULTS,DD,IENS) Q
"RTN","MDRPCOR",247,0)
 ;
"RTN","MDRPCOR",248,0)
VALIDATE ; [Procedure] Validate data for a field
"RTN","MDRPCOR",249,0)
 I ($G(DATA)="@"!($G(DATA)=""))&(FLD=.01) D  Q
"RTN","MDRPCOR",250,0)
 .S @RESULTS@(0)="-1^Record Deletion Not Allowed Here."
"RTN","MDRPCOR",251,0)
 I FLD=.01 I $$DUPS^MDRPCU(DD,+IENS,DATA) D  Q
"RTN","MDRPCOR",252,0)
 .S @RESULTS@(0)="-1",@RESULTS@(1)="Duplicates not allowed"
"RTN","MDRPCOR",253,0)
 S:$G(DATA)="@" DATA=""
"RTN","MDRPCOR",254,0)
 I $$GET1^DID(DD,FLD,"","TYPE")["WORD" D  Q
"RTN","MDRPCOR",255,0)
 .S MDGBL=$NA(^TMP("MDFDA",$J,DD,IENS,FLD))
"RTN","MDRPCOR",256,0)
 .K @MDGBL
"RTN","MDRPCOR",257,0)
 .I $O(DATA(""))="" S @MDGBL="@",@RESULTS@(0)="1^OK" Q
"RTN","MDRPCOR",258,0)
 .I $O(DATA(""),-1)=1&($G(DATA(1)))="" S @MDGBL="@",@RESULTS@(0)="1^OK" Q
"RTN","MDRPCOR",259,0)
 .S X=""  F  S X=$O(DATA(X)) Q:X=""  D
"RTN","MDRPCOR",260,0)
 ..S Y=$O(@MDGBL@(""""),-1)+1
"RTN","MDRPCOR",261,0)
 ..S @MDGBL@(Y)=DATA(X)
"RTN","MDRPCOR",262,0)
 .S @MDGBL=$NA(^TMP("MDSAVE",$J,DD,IENS,FLD))
"RTN","MDRPCOR",263,0)
 .S RESULTS(0)="1^WP"
"RTN","MDRPCOR",264,0)
 D VAL^DIE(DD,IENS,FLD,"EF",$G(DATA),.MDRET,$NA(^TMP("MDFDA",$J)),"MDERR")
"RTN","MDRPCOR",265,0)
 I MDRET="^" D ERROR^MDRPCU($NA(^TMP($J)),.MDERR) Q
"RTN","MDRPCOR",266,0)
 S @RESULTS@(0)="1^"_MDRET(0)
"RTN","MDRPCOR",267,0)
 Q
"RTN","MDRPCOR",268,0)
 ;
"RTN","MDRPCOT2")
0^7^B44429829^B44563560
"RTN","MDRPCOT2",1,0)
MDRPCOT2 ; HOIFO/NCA - Object RPCs (TMDTransaction) Continued 2;10/29/04  12:20 ;3/12/08  09:18
"RTN","MDRPCOT2",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21,20**;Apr 01, 2004;Build 9
"RTN","MDRPCOT2",3,0)
 ; Integration Agreements:
"RTN","MDRPCOT2",4,0)
 ; IA# 2056 [Supported] Call to DIQ.
"RTN","MDRPCOT2",5,0)
 ; IA# 2693 [Subscription] TIU Extractions.
"RTN","MDRPCOT2",6,0)
 ; IA# 3468 [Subscription] GMRCCP API.
"RTN","MDRPCOT2",7,0)
 ; IA# 3535 [Subscription] Calls to TIUSRVP.
"RTN","MDRPCOT2",8,0)
 ; IA# 4795 [Subscription] Calls to TIUSRVP2.
"RTN","MDRPCOT2",9,0)
 ; IA# 5407 [Subscription] Call routine ORWTPN.
"RTN","MDRPCOT2",10,0)
ADDMSG ; [Procedure] Add message to transaction
"RTN","MDRPCOT2",11,0)
 N MDIEN,MDIENS,MDRET
"RTN","MDRPCOT2",12,0)
 Q:'$G(DATA("TRANSACTION"))
"RTN","MDRPCOT2",13,0)
 Q:$G(DATA("MESSAGE"))=""
"RTN","MDRPCOT2",14,0)
 S MDIEN=+DATA("TRANSACTION"),MDIENS="+1,"_MDIEN_","
"RTN","MDRPCOT2",15,0)
 D NOW^%DTC S DATA("DATE")=%
"RTN","MDRPCOT2",16,0)
 S MDFDA(702.091,MDIENS,.01)=+$O(^MDD(702,+MDIEN,.091,"A"),-1)+1
"RTN","MDRPCOT2",17,0)
 S MDFDA(702.091,MDIENS,.02)=DATA("DATE")
"RTN","MDRPCOT2",18,0)
 S MDFDA(702.091,MDIENS,.03)=$G(DATA("PKG"),"UNKNOWN")
"RTN","MDRPCOT2",19,0)
 S MDFDA(702.091,MDIENS,.09)=DATA("MESSAGE")
"RTN","MDRPCOT2",20,0)
 D UPDATE^DIE("","MDFDA","MDRET")
"RTN","MDRPCOT2",21,0)
 Q
"RTN","MDRPCOT2",22,0)
 ;
"RTN","MDRPCOT2",23,0)
FILEMSG(STUDY,MDPKG,MDSTAT,MDMSG) ; [Procedure] File Study Status and Message.
"RTN","MDRPCOT2",24,0)
 S DATA("TRANSACTION")=STUDY,DATA("PKG")=MDPKG
"RTN","MDRPCOT2",25,0)
 S DATA("MESSAGE")=$P(MDMSG,"^",2)
"RTN","MDRPCOT2",26,0)
 D STATUS(STUDY_",",MDSTAT,$P(MDMSG,"^",2)),ADDMSG
"RTN","MDRPCOT2",27,0)
 Q
"RTN","MDRPCOT2",28,0)
 ;
"RTN","MDRPCOT2",29,0)
STATUS(MDIENS,MDSTAT,MDMSG) ; [Procedure] Update transaction status
"RTN","MDRPCOT2",30,0)
 S MDFDA(702,MDIENS,.08)=$G(MDMSG)
"RTN","MDRPCOT2",31,0)
 S MDFDA(702,MDIENS,.09)=MDSTAT
"RTN","MDRPCOT2",32,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT2",33,0)
 Q
"RTN","MDRPCOT2",34,0)
 ;
"RTN","MDRPCOT2",35,0)
SUBMIT(MDDATA,MDESIG,MDG1) ; [Procedure] Process the Image(s) Submission.
"RTN","MDRPCOT2",36,0)
 ; Input: MDDATA - Study ID
"RTN","MDRPCOT2",37,0)
 ;        MDESIG - Electronic Signature
"RTN","MDRPCOT2",38,0)
 ;        MDG1 - ^TMP global with the text of the report
"RTN","MDRPCOT2",39,0)
 ; Output: -1^Error Message or
"RTN","MDRPCOT2",40,0)
 ;          1^Successful Message
"RTN","MDRPCOT2",41,0)
 N MDRESUL,MDSTUDY,MDG2,RES
"RTN","MDRPCOT2",42,0)
 S MDSTUDY=+MDDATA,(RES,MDRESUL)=""
"RTN","MDRPCOT2",43,0)
 ; Create New TIU Document
"RTN","MDRPCOT2",44,0)
 S MDRESUL=$$NEWTIUN(MDSTUDY)
"RTN","MDRPCOT2",45,0)
 ;S MDRESUL=$$NEWTIUN(MDSTUDY)
"RTN","MDRPCOT2",46,0)
 ; File TIU Error messages
"RTN","MDRPCOT2",47,0)
 ;I +MDRESUL<0 D FILEMSG(MDSTUDY,"TIU",2,MDRESUL) Q MDRESUL
"RTN","MDRPCOT2",48,0)
 I +MDRESUL<0 D  Q RES
"RTN","MDRPCOT2",49,0)
 .D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCOT2",50,0)
 .S RES=MDRESUL
"RTN","MDRPCOT2",51,0)
 ; Update the text of the TIU document
"RTN","MDRPCOT2",52,0)
 S MDG2=@($NA(MDG1))
"RTN","MDRPCOT2",53,0)
 I +$O(@MDG2@(""),-1) D  Q:RES'="" RES
"RTN","MDRPCOT2",54,0)
 .S MDRESUL=$$UPDATE(MDSTUDY,MDESIG,MDG2)
"RTN","MDRPCOT2",55,0)
 .I +MDRESUL<0 D  Q
"RTN","MDRPCOT2",56,0)
 ..D FILEMSG(MDSTUDY,"TIU",2,MDRESUL)
"RTN","MDRPCOT2",57,0)
 ..S RES=MDRESUL
"RTN","MDRPCOT2",58,0)
 ; Submit and export the images
"RTN","MDRPCOT2",59,0)
 ;S MDRESUL=$$SUBMIT^MDRPCOT1(MDSTUDY)
"RTN","MDRPCOT2",60,0)
 ; File message
"RTN","MDRPCOT2",61,0)
 ;D FILEMSG(MDSTUDY,"IMAGING",$S(+MDRESUL>0:+MDRESUL,1:2),MDRESUL)
"RTN","MDRPCOT2",62,0)
 S RES=MDRESUL
"RTN","MDRPCOT2",63,0)
 Q RES
"RTN","MDRPCOT2",64,0)
 ;
"RTN","MDRPCOT2",65,0)
GETDATA(STUDY) ; [Function] Return the Necessary data for creating a TIU note.
"RTN","MDRPCOT2",66,0)
 ; Return: Patient DFN_"^"_TIU title_"^"_Hospital Location_"^"_TIU Note
"RTN","MDRPCOT2",67,0)
 ;         IEN_"^"_Consult #_"^"_CP Definition IEN_"^"_Visit String_"^"
"RTN","MDRPCOT2",68,0)
 ;         New Visit Flag
"RTN","MDRPCOT2",69,0)
 ;         or
"RTN","MDRPCOT2",70,0)
 ;         -1^Error Message
"RTN","MDRPCOT2",71,0)
 N DFN,MDCON,MDFN,MDIEN,MDIENS,MDLOC,MDNEWV,MDNOTE,MDNVST,MDPROC,MDVSTR,MDTITL,MDX,MDTST
"RTN","MDRPCOT2",72,0)
 S MDIEN=+STUDY,MDIENS=MDIEN_",",MDNVST=0
"RTN","MDRPCOT2",73,0)
 I $$GET1^DIQ(702,MDIENS,.01)="" Q "-1^No such study entry."
"RTN","MDRPCOT2",74,0)
 ; Get DFN
"RTN","MDRPCOT2",75,0)
 S DFN=$$GET1^DIQ(702,MDIEN,.01,"I")
"RTN","MDRPCOT2",76,0)
 I 'DFN Q "-1^No DFN."
"RTN","MDRPCOT2",77,0)
 ; Get CP Def
"RTN","MDRPCOT2",78,0)
 S MDPROC=$$GET1^DIQ(702,MDIEN,.04,"I")
"RTN","MDRPCOT2",79,0)
 I 'MDPROC Q "-1^No CP Def."
"RTN","MDRPCOT2",80,0)
 ; Get Consult
"RTN","MDRPCOT2",81,0)
 S MDCON=$$GET1^DIQ(702,MDIEN,.05,"I")
"RTN","MDRPCOT2",82,0)
 I 'MDCON Q "-1^No Consult #."
"RTN","MDRPCOT2",83,0)
 ; Get TIU Note Title
"RTN","MDRPCOT2",84,0)
 S MDTITL=$$GET1^DIQ(702.01,+MDPROC_",",.04,"I")
"RTN","MDRPCOT2",85,0)
 I 'MDTITL Q "-1^No TIU Note Title."
"RTN","MDRPCOT2",86,0)
 S MDVSTR=$$GET1^DIQ(702,MDIEN,.07)
"RTN","MDRPCOT2",87,0)
 I MDVSTR=""  Q "-1^No Visit String."
"RTN","MDRPCOT2",88,0)
 I $L(MDVSTR,";")=1 S MDNVST=1,MDVSTR=";"_MDVSTR ; If new visit is selected
"RTN","MDRPCOT2",89,0)
 ; MDLOC is Hospital Location
"RTN","MDRPCOT2",90,0)
 I MDVSTR'="" D
"RTN","MDRPCOT2",91,0)
 .S MDVSTR=$$GETVSTR^MDRPCOT1(DFN,MDVSTR,MDPROC,$$GET1^DIQ(702,MDIEN,.02,"I"))
"RTN","MDRPCOT2",92,0)
 .S MDLOC=$P(MDVSTR,";",1)
"RTN","MDRPCOT2",93,0)
 ; Does TIU doc already exist?
"RTN","MDRPCOT2",94,0)
 S MDNOTE=""
"RTN","MDRPCOT2",95,0)
 I $$GET1^DIQ(702,MDIEN,.06,"I") Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+$$GET1^DIQ(702,MDIEN,.06,"I")_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT2",96,0)
 ; Does TIU doc exist for previous transaction of this consult?
"RTN","MDRPCOT2",97,0)
 ;I MDCON S MDNOTE=$$PREV(MDCON,MDIEN)
"RTN","MDRPCOT2",98,0)
 Q DFN_"^"_MDTITL_"^"_MDLOC_"^"_+MDNOTE_"^"_MDCON_"^"_MDPROC_"^"_MDVSTR_"^"_MDNVST
"RTN","MDRPCOT2",99,0)
 ;
"RTN","MDRPCOT2",100,0)
NEWTIUN(STUDY) ; [Function] Create a new TIU for transaction
"RTN","MDRPCOT2",101,0)
 ; Input: STUDY - IENS of CP study entry
"RTN","MDRPCOT2",102,0)
 ; Return: TIU Document IEN
"RTN","MDRPCOT2",103,0)
 N CTR,DFN,MDCON,MDCONRS,MDFDA,MDGST,MDL,MDLOC,MDNOTE,MDPDT,MDPROC,MDPT,MDRESU,MDTITL,MDTSTR,MDVST,MDVSTR,MDWP S CTR=0,MDGST=+STUDY,MDRESU=""
"RTN","MDRPCOT2",104,0)
 ; Get data for TIU Note Creation
"RTN","MDRPCOT2",105,0)
 S (MDTSTR,MDRESU)=$$GETDATA(MDGST)
"RTN","MDRPCOT2",106,0)
 ; File Error message
"RTN","MDRPCOT2",107,0)
 I +MDRESU<0 D FILEMSG(MDGST,"CP",2,MDRESU) Q MDRESU
"RTN","MDRPCOT2",108,0)
 I $G(MDTSTR)="" Q "-1^No Data to Create TIU Document"
"RTN","MDRPCOT2",109,0)
 F MDL="DFN","MDTITL","MDLOC","MDNOTE","MDCON","MDPROC","MDVSTR","MDNVST" D
"RTN","MDRPCOT2",110,0)
 .S CTR=CTR+1,@MDL=$P(MDTSTR,"^",CTR)
"RTN","MDRPCOT2",111,0)
 S (MDVST,MDRESU)=""
"RTN","MDRPCOT2",112,0)
 ; If previous TIU document exists, quit
"RTN","MDRPCOT2",113,0)
 I 'MDLOC Q "-1^No Hospital Location."
"RTN","MDRPCOT2",114,0)
 I MDNOTE Q MDNOTE
"RTN","MDRPCOT2",115,0)
 ; Create new visit, if no vstring
"RTN","MDRPCOT2",116,0)
 S MDPDT=$$PDT^MDRPCOT1(MDGST)
"RTN","MDRPCOT2",117,0)
 I 'MDPDT S MDPT=$O(^MDD(703.1,"ASTUDYID",+MDGST,""),-1),MDPDT=$P($G(^MDD(703.1,+MDPT,0)),U,3)
"RTN","MDRPCOT2",118,0)
 S:'MDPDT MDPDT=$P(MDVSTR,";",2) ; If No D/T Performed grab visit D/T
"RTN","MDRPCOT2",119,0)
 ; Build variables for TIU Call
"RTN","MDRPCOT2",120,0)
 S MDWP(.05)=1 ; Undictated Status
"RTN","MDRPCOT2",121,0)
 S MDWP(1405)=+MDCON_";GMR(123," ; Package Reference
"RTN","MDRPCOT2",122,0)
 S MDWP(70201)=5 ; Default Procedure Summary Code "Machine Resulted"
"RTN","MDRPCOT2",123,0)
 I MDPDT S MDWP(70202)=MDPDT ; Date/Time Performed
"RTN","MDRPCOT2",124,0)
 ; File PCE Error message
"RTN","MDRPCOT2",125,0)
 S MDRESU=$$EN1^MDPCE(MDGST,$P(MDVSTR,";",2),(MDPROC_"^"_MDLOC),$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU,MDVSTR=$P(MDRESU,"^",2)
"RTN","MDRPCOT2",126,0)
 ;I MDNVST S MDRESU=$$EN1^MDPCE1(MDGST,MDPDT,MDPROC,$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU,MDVSTR=$P(MDRESU,"^",2)
"RTN","MDRPCOT2",127,0)
 ;I 'MDNVST S MDVST=$P($G(^MDD(702,+MDGST,1)),U) I 'MDVST S MDRESU=$$EN1^MDPCE(MDGST,MDPDT,(MDPROC_"^"_MDLOC),$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU
"RTN","MDRPCOT2",128,0)
 ;I 'MDNVST&$$CHK^MDPCE1(MDGST) S MDRESU=$$EN1^MDPCE1(MDGST,MDPDT,MDPROC,$P(MDVSTR,";",3),"P") I +MDRESU S MDVST=+MDRESU
"RTN","MDRPCOT2",129,0)
 I +MDRESU<0 D FILEMSG(MDGST,"PCE",2,$P(MDRESU,"^",2)) Q MDRESU
"RTN","MDRPCOT2",130,0)
 ; Create the TIU note stub
"RTN","MDRPCOT2",131,0)
 S MDVST="" S MDVST=+$G(^MDD(702,MDGST,1))
"RTN","MDRPCOT2",132,0)
 S MDNOTE="" D MAKE^TIUSRVP(.MDNOTE,DFN,MDTITL,$P(MDVSTR,";",2),MDLOC,$S(MDVST:MDVST,1:""),.MDWP,MDVSTR,1,1)
"RTN","MDRPCOT2",133,0)
 I '(+MDNOTE) S $P(MDNOTE,"^")=-1 Q MDNOTE
"RTN","MDRPCOT2",134,0)
 ; Finalize the transaction
"RTN","MDRPCOT2",135,0)
 S MDFDA(702,STUDY_",",.06)=+MDNOTE
"RTN","MDRPCOT2",136,0)
 S MDFDA(702,STUDY_",",.08)=""
"RTN","MDRPCOT2",137,0)
 D FILE^DIE("","MDFDA") K MDFDA
"RTN","MDRPCOT2",138,0)
 D UPD^MDKUTLR(STUDY,+MDNOTE)
"RTN","MDRPCOT2",139,0)
 ;S MDCONRS=$$CPDOC^GMRCCP(+MDCON,+MDNOTE,2)
"RTN","MDRPCOT2",140,0)
 Q 1
"RTN","MDRPCOT2",141,0)
 ;
"RTN","MDRPCOT2",142,0)
UPDATE(STUDY,SIGN,MDGLB) ; Update the TIU document with the text
"RTN","MDRPCOT2",143,0)
 N MDK,MDNOTE,MDPPR,MDRESU,MDS,MDTI,MDTIUER,MDWP,MDV,MDV1,MDVAU S (MDNOTE,MDTIUER)="" K MDWP,^TMP("MDTIUST",$J)
"RTN","MDRPCOT2",144,0)
 F MDK=0:0 S MDK=$O(@MDGLB@(MDK)) Q:'MDK  S MDWP("TEXT",MDK,0)=$G(@MDGLB@(MDK))
"RTN","MDRPCOT2",145,0)
 S MDTI=$$GET1^DIQ(702,STUDY_",",.06,"I") Q:'MDTI "-1^No Note."
"RTN","MDRPCOT2",146,0)
 S MDWP(.05)=5
"RTN","MDRPCOT2",147,0)
 S MDWP(1202)=DUZ
"RTN","MDRPCOT2",148,0)
 D GETDCOS^ORWTPN(.MDVAU,DUZ)
"RTN","MDRPCOT2",149,0)
 I +MDVAU S MDWP(1506)=1,MDWP(1208)=+MDVAU
"RTN","MDRPCOT2",150,0)
 D UPDATE^TIUSRVP(.MDNOTE,+MDTI,.MDWP,1)
"RTN","MDRPCOT2",151,0)
 I '+MDNOTE S MDNOTE="-1^"_$P(MDNOTE,"^",2) Q MDNOTE
"RTN","MDRPCOT2",152,0)
 ; Sign TIU Document
"RTN","MDRPCOT2",153,0)
 S MDS=$$SIGN(MDTI,SIGN) I MDS<0 Q MDS
"RTN","MDRPCOT2",154,0)
 ;N MDFDA S MDFDA(704.202,STUDY_",",.09)=0
"RTN","MDRPCOT2",155,0)
 S $P(^MDK(704.202,STUDY,0),"^",9)=0
"RTN","MDRPCOT2",156,0)
 ;D FILE^DIE("","MDFDA")
"RTN","MDRPCOT2",157,0)
 N MDFDA S MDFDA(702,STUDY_",",.09)=3
"RTN","MDRPCOT2",158,0)
 D FILE^DIE("","MDFDA")
"RTN","MDRPCOT2",159,0)
 K ^MDK(704.202,"AS",1,STUDY)
"RTN","MDRPCOT2",160,0)
 S ^MDK(704.202,"AS",0,STUDY)=""
"RTN","MDRPCOT2",161,0)
 Q 1
"RTN","MDRPCOT2",162,0)
SIGN(MDTIUIN,MDSIGN) ; Sign the TIU Document
"RTN","MDRPCOT2",163,0)
 ; [Function] TIU SIGN RECORD
"RTN","MDRPCOT2",164,0)
 ;Input Parameters:
"RTN","MDRPCOT2",165,0)
 ;   1.  TIUIEN [Literal/Required] TIU internal Entry Number
"RTN","MDRPCOT2",166,0)
 ;   2.  MDSIGN [Literal/Required] User Signature
"RTN","MDRPCOT2",167,0)
 N MDSRES,X
"RTN","MDRPCOT2",168,0)
 S MDSRES=""
"RTN","MDRPCOT2",169,0)
 D SIGN^TIUSRVP2(.MDSRES,MDTIUIN,MDSIGN)
"RTN","MDRPCOT2",170,0)
 I +MDSRES>0 Q "-1^"_$P(MDSRES,"^",2)
"RTN","MDRPCOT2",171,0)
 Q 1
"RTN","MDRPCOT2",172,0)
 ;
"RTN","MDRPCOT2",173,0)
PREV(MDC,MDS) ; [Function] Return the Previous TIU document.
"RTN","MDRPCOT2",174,0)
 N MDNEWV,MDDOC,MDTRAN,MDTIUER,MDTST
"RTN","MDRPCOT2",175,0)
 S (MDDOC,MDNEWV,MDTRAN,MDTIUER,MDTST)="" K ^TMP("MDTIUST",$J)
"RTN","MDRPCOT2",176,0)
 F  S MDTRAN=$O(^MDD(702,"ACON",MDC,MDTRAN)) Q:'MDTRAN  D  Q:'MDTRAN
"RTN","MDRPCOT2",177,0)
 .I $P(^MDD(702,MDTRAN,0),U,6) D
"RTN","MDRPCOT2",178,0)
 ..D EXTRACT^TIULQ($P(^MDD(702,MDTRAN,0),U,6),"^TMP(""MDTIUST"",$J)",MDTIUER,".01;.05;1406") Q:+MDTIUER
"RTN","MDRPCOT2",179,0)
 ..S MDTST=$G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),.05,"E"))
"RTN","MDRPCOT2",180,0)
 ..I MDTST'="UNDICTATED"&(MDTST'="UNSIGNED") K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT2",181,0)
 ..I MDTST="UNSIGNED"&'($G(^TMP("MDTIUST",$J,$P(^MDD(702,MDTRAN,0),U,6),1406,"I"))) K ^TMP("MDTIUST",$J) Q
"RTN","MDRPCOT2",182,0)
 ..S MDDOC=$P(^MDD(702,MDTRAN,0),U,6),MDNEWV=$P(^MDD(702,MDTRAN,0),U,7)
"RTN","MDRPCOT2",183,0)
 ..Q:'MDS
"RTN","MDRPCOT2",184,0)
 ..S MDFDA(702,MDS_",",.06)=MDDOC
"RTN","MDRPCOT2",185,0)
 ..S MDFDA(702,MDS_",",.07)=MDNEWV
"RTN","MDRPCOT2",186,0)
 ..D FILE^DIE("","MDFDA")
"RTN","MDRPCOT2",187,0)
 ..S MDTRAN=""
"RTN","MDRPCOT2",188,0)
 Q MDDOC
"RTN","MDRPCOTA")
0^9^B925975^n/a
"RTN","MDRPCOTA",1,0)
MDRPCOTA ; HOIFO/NCA - Object RPCs (TMDTransaction) Continued 2;10/29/04  12:20 ;3/12/08  09:18
"RTN","MDRPCOTA",2,0)
 ;;1.0;CLINICAL PROCEDURES;**20**;Apr 01, 2004;Build 9
"RTN","MDRPCOTA",3,0)
 ; Integration Agreements:
"RTN","MDRPCOTA",4,0)
 ; IA# 3468 [Subscription] GMRCCP API.
"RTN","MDRPCOTA",5,0)
 ;
"RTN","MDRPCOTA",6,0)
GETCS(MDNP1) ; [Function] Return the next procedure request.
"RTN","MDRPCOTA",7,0)
 N MDNLL,MDNFG,MDNNOD,MDNR,MDNX K ^TMP("MDNREQ",$J) S (MDNFG,MDNR)=0
"RTN","MDRPCOTA",8,0)
 S MDNNOD=$G(^MDD(702,+MDNP1,0)) Q:MDNNOD="" 0
"RTN","MDRPCOTA",9,0)
 D CPLIST^GMRCCP(+MDNNOD,+$P(MDNNOD,"^",4),$NA(^TMP("MDNREQ",$J)))
"RTN","MDRPCOTA",10,0)
 S MDNLL="" F  S MDNLL=$O(^TMP("MDNREQ",$J,MDNLL),-1) Q:MDNLL<1!(+MDNFG)  S MDNX=$G(^(MDNLL)) D
"RTN","MDRPCOTA",11,0)
 .I "saprc"[$P(MDNX,U,4) S MDNFG=1,MDNR=$P(MDNX,U,5) Q
"RTN","MDRPCOTA",12,0)
 .Q
"RTN","MDRPCOTA",13,0)
 Q MDNR
"RTN","MDRPCW")
0^10^B70357475^B69393853
"RTN","MDRPCW",1,0)
MDRPCW ; HOIFO/NCA - Calls to AICS;04/01/2003 ;01/21/10  11:51
"RTN","MDRPCW",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21,20**;Apr 01, 2004;Build 9
"RTN","MDRPCW",3,0)
 ; Reference Integration Agreement:
"RTN","MDRPCW",4,0)
 ; IA #142 [Subscription] Access ^DIC(31 NAME field (#.01) with FM
"RTN","MDRPCW",5,0)
 ; IA #174 [Subscription] Access DPT(DFN,.372) node.
"RTN","MDRPCW",6,0)
 ; IA #649 [Subscription] Access DG(391 with FM for
"RTN","MDRPCW",7,0)
 ;                        IGNORE VETERAN CHECK field (#.02).
"RTN","MDRPCW",8,0)
 ; IA #1296 [Subscription] IBDF18A call
"RTN","MDRPCW",9,0)
 ; IA #1593 [Subscription] Access to Provider Narrative file
"RTN","MDRPCW",10,0)
 ;                         (#9999999.27)
"RTN","MDRPCW",11,0)
 ; IA #1894 [Subscription] PXAPI call
"RTN","MDRPCW",12,0)
 ; IA #1995 [Supported] ICPTCOD calls
"RTN","MDRPCW",13,0)
 ; IA #2054 [Supported] Call to DILF
"RTN","MDRPCW",14,0)
 ; IA #2056 [Supported] Call to DIQ
"RTN","MDRPCW",15,0)
 ; IA #3990 [Supported] ICDCODE calls
"RTN","MDRPCW",16,0)
 ; IA #10060 [Supported] Access File 200
"RTN","MDRPCW",17,0)
 ; IA #10061 [Supported] VADPT calls
"RTN","MDRPCW",18,0)
 ;
"RTN","MDRPCW",19,0)
 Q
"RTN","MDRPCW",20,0)
RPC(RESULTS,OPTION,DFN,MDSTUD) ; [Procedure] Main RPC call
"RTN","MDRPCW",21,0)
 ; RPC: [MD TMDCIDC]
"RTN","MDRPCW",22,0)
 ;
"RTN","MDRPCW",23,0)
 ; DFN=Patient internal entry number in Patient file (#2)
"RTN","MDRPCW",24,0)
 ; MDSTUD=CP study internal entry number
"RTN","MDRPCW",25,0)
 ;
"RTN","MDRPCW",26,0)
 D CLEAN^DILF
"RTN","MDRPCW",27,0)
 S RESULTS=$NA(^TMP("MDRPCW",$J)) K @RESULTS
"RTN","MDRPCW",28,0)
 I $G(MDSTUD)="" S @RESULTS@(0)="-1^No Study." Q
"RTN","MDRPCW",29,0)
 I $T(@OPTION)="" D  Q
"RTN","MDRPCW",30,0)
 .S @RESULTS@(0)="-1^Error in RPC: MD TMDCIDC at "_OPTION_U_$T(+0)
"RTN","MDRPCW",31,0)
 D @OPTION S:'$D(@RESULTS) @RESULTS@(0)="-1^No return"
"RTN","MDRPCW",32,0)
 D CLEAN^DILF
"RTN","MDRPCW",33,0)
 Q
"RTN","MDRPCW",34,0)
PROC ; get list of procedures for clinic
"RTN","MDRPCW",35,0)
 N CLIN,MDARR,MDPR,MDV
"RTN","MDRPCW",36,0)
 S MDV=$$GET1^DIQ(702,+MDSTUD_",",.07,"I")
"RTN","MDRPCW",37,0)
 I $G(MDV)="" S @RESULTS@(0)="-1^No Visit." Q
"RTN","MDRPCW",38,0)
 S MDPR=$$GET1^DIQ(702,+MDSTUD_",",.04,"I")
"RTN","MDRPCW",39,0)
 I '$G(MDPR) S @RESULTS@(0)="-1^No CP Definition." Q
"RTN","MDRPCW",40,0)
 S CLIN=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDRPCW",41,0)
 I 'CLIN S CLIN=+$P(MDV,";",3) I 'CLIN S @RESULTS@(0)="-1^No Hospital Location." Q
"RTN","MDRPCW",42,0)
 D GETLST^IBDF18A(CLIN,"DG SELECT CPT PROCEDURE CODES","MDARR",,,1,DT)
"RTN","MDRPCW",43,0)
 N MDIDX,MDMOD,CODES,MDFST S MDIDX=0 M @RESULTS=MDARR
"RTN","MDRPCW",44,0)
 F  S MDIDX=$O(@RESULTS@(MDIDX)) Q:'+MDIDX  D
"RTN","MDRPCW",45,0)
 . I @RESULTS@(MDIDX)="" K @RESULTS@(MDIDX) Q
"RTN","MDRPCW",46,0)
 . S MDMOD=0,CODES="",MDFST=1
"RTN","MDRPCW",47,0)
 . F  S MDMOD=$O(@RESULTS@(MDIDX,"MODIFIER",MDMOD)) Q:(MDMOD="")  D
"RTN","MDRPCW",48,0)
 . . I MDFST S MDFST=0
"RTN","MDRPCW",49,0)
 . . E  S CODES=CODES_";"
"RTN","MDRPCW",50,0)
 . . S CODES=CODES_@RESULTS@(MDIDX,"MODIFIER",MDMOD)
"RTN","MDRPCW",51,0)
 . K @RESULTS@(MDIDX,"MODIFIER")
"RTN","MDRPCW",52,0)
 . I 'MDFST S $P(@RESULTS@(MDIDX),U,12)=CODES
"RTN","MDRPCW",53,0)
 Q
"RTN","MDRPCW",54,0)
DIAG ; get list of diagnoses for clinic
"RTN","MDRPCW",55,0)
 N CLIN,MDARR,MDPR,MDV
"RTN","MDRPCW",56,0)
 S MDV=$$GET1^DIQ(702,+MDSTUD_",",.07,"I")
"RTN","MDRPCW",57,0)
 I $G(MDV)="" S @RESULTS@(0)="-1^No Visit." Q
"RTN","MDRPCW",58,0)
 S MDPR=$$GET1^DIQ(702,+MDSTUD_",",.04,"I")
"RTN","MDRPCW",59,0)
 I '$G(MDPR) S @RESULTS@(0)="-1^No CP Definition." Q
"RTN","MDRPCW",60,0)
 S CLIN=$$GET1^DIQ(702.01,+MDPR_",",.05,"I")
"RTN","MDRPCW",61,0)
 I 'CLIN S CLIN=+$P(MDV,";",3) I 'CLIN S @RESULTS@(0)="-1^No Hospital Location." Q
"RTN","MDRPCW",62,0)
 D GETLST^IBDF18A(CLIN,"DG SELECT ICD-9 DIAGNOSIS CODES","MDARR",,,,DT)
"RTN","MDRPCW",63,0)
 M @RESULTS=MDARR
"RTN","MDRPCW",64,0)
 Q
"RTN","MDRPCW",65,0)
SCDISP ; Return Service Connected % and Rated Disabilities
"RTN","MDRPCW",66,0)
 N VAEL,VAERR,I,MDLST,DIS,MDSC,X2
"RTN","MDRPCW",67,0)
 D ELIG^VADPT
"RTN","MDRPCW",68,0)
 S:'+VAEL(3) @RESULTS@(1)="Service Connected: NO"
"RTN","MDRPCW",69,0)
 S:+VAEL(3) @RESULTS@(1)="SC Percent: "_$P(VAEL(3),U,2)_"%"
"RTN","MDRPCW",70,0)
 I 'VAEL(4),'$$GET1^DIQ(391,+VAEL(6)_",",.02,"I") S @RESULTS@(2)="Rated Disabilities: NOT A VETERAN." D KVAR^VADPT Q
"RTN","MDRPCW",71,0)
 S @RESULTS@(2)="Rated Disabilities: "
"RTN","MDRPCW",72,0)
 S I=0,MDLST=0 F  S I=$O(^DPT(DFN,.372,I)) Q:'I  S X2=^(I,0) D
"RTN","MDRPCW",73,0)
 . S DIS=$$GET1^DIQ(31,+X2_",",.01,"E") Q:DIS=""
"RTN","MDRPCW",74,0)
 . S MDSC=$S($P(X2,U,3):"SC",$P(X2,U,3)']"":"not specified",1:"NSC")
"RTN","MDRPCW",75,0)
 . S MDLST=MDLST+1,@RESULTS@(MDLST+2)="                    "_DIS_" ("_$P(X2,U,2)_"%-"_MDSC_")"
"RTN","MDRPCW",76,0)
 I 'MDLST S @RESULTS@(2)=@RESULTS@(2)_"NONE STATED"
"RTN","MDRPCW",77,0)
 D KVAR^VADPT
"RTN","MDRPCW",78,0)
 Q
"RTN","MDRPCW",79,0)
PCEDISP ; Return print text to display PCE data
"RTN","MDRPCW",80,0)
 ;S RESULTS=$NA(^TMP("MDENC",$J)) K @RESULTS
"RTN","MDRPCW",81,0)
 S STUDY=+MDSTUD
"RTN","MDRPCW",82,0)
 N MDDAR,MDDAR2,CAT,CODE,DIAG,GLOARR,MDCCON,MDX802,MDARR,MDCPT,MDCTR,MDDFN,MDENCDT,MDFLST,MDICD,MDLC,MDLL,MDLOCN,MDPROV,MDRP,MDRST,MDVST,MDVSTR,QTY,MDX,MDX0,MDX1,S S S=";"
"RTN","MDRPCW",83,0)
 N DESC,GDIAG,LLB,MDDDN,MDDDV,MDCK,MDNCTR,MDPFLG,MDCLL,MDDESC S (MDCK,MDPFLG)=0
"RTN","MDRPCW",84,0)
 Q:'$G(STUDY)
"RTN","MDRPCW",85,0)
 Q:'$G(^MDD(702,+STUDY,0))
"RTN","MDRPCW",86,0)
 D NOW^%DTC S MDDEF=% K % S MDCTR=0
"RTN","MDRPCW",87,0)
 K ^TMP("MDDAR",$J),^TMP("MDLEX",$J),GLOARR,MDFLST
"RTN","MDRPCW",88,0)
 S MDX=$G(^MDD(702,+STUDY,0)),MDX1=$G(^(1)),MDCCON=$P(MDX,U,5)
"RTN","MDRPCW",89,0)
 S MDVST=$P(MDX1,U),MDDFN=$P(MDX,U) Q:'MDDFN
"RTN","MDRPCW",90,0)
 S:+MDVST MDPFLG=1
"RTN","MDRPCW",91,0)
 S MDVSTR=$P(MDX,U,7),MDDAR=$NA(^TMP("MDDAR",$J)),MDDAR2=$NA(GLOARR),@MDDAR2@("POV",0)=0,@MDDAR2@("CPT",0)=0,MDLC=0
"RTN","MDRPCW",92,0)
 I 'MDVST S MDRP=0 F  S MDRP=$O(^MDD(702,STUDY,.1,MDRP)) Q:'MDRP  D
"RTN","MDRPCW",93,0)
 .S MDRST=$P($G(^MDD(702,STUDY,.1,+MDRP,0)),"^",3)
"RTN","MDRPCW",94,0)
 .I +MDRST D CICNV^MDHL7U3(+MDRST,.MDDAR) D SETGLO^MDRPCW1(.MDDAR,.MDDAR2)
"RTN","MDRPCW",95,0)
 .K ^TMP("MDDAR",$J) Q
"RTN","MDRPCW",96,0)
 I 'MDVST&(+$G(@MDDAR2@("POV",0))>0) F MDLL=1:1:+$G(@MDDAR2@("POV",0)) S MDLC=MDLC+1,MDFLST(MDLC)=$G(@MDDAR2@("POV",MDLL))
"RTN","MDRPCW",97,0)
 I 'MDVST&(+$G(@MDDAR2@("CPT",0))>0) F MDLL=1:1:+$G(@MDDAR2@("CPT",0)) S MDLC=MDLC+1,MDFLST(MDLC)=$G(@MDDAR2@("CPT",MDLL))
"RTN","MDRPCW",98,0)
 I MDVST>0 S MDENCDT=$P(MDVSTR,";",2),MDLOCN=$P(MDVSTR,";",3)
"RTN","MDRPCW",99,0)
 ;E  S MDENCDT=$$PDT^MDRPCOT1(STUDY)
"RTN","MDRPCW",100,0)
 E  S MDENCDT=$P(MDVSTR,";",2)
"RTN","MDRPCW",101,0)
 S:$L(MDVSTR,";")=1 MDVSTR=";"_MDVSTR
"RTN","MDRPCW",102,0)
 S MDVSTR=$$GETVSTR^MDRPCOT1(MDDFN,MDVSTR,+$P(MDX,U,4),$P(MDX,U,2)),MDLOCN=$P(MDVSTR,";",1)
"RTN","MDRPCW",103,0)
 S:'MDENCDT MDENCDT=$P(MDVSTR,";",2)
"RTN","MDRPCW",104,0)
 S:'MDENCDT MDENCDT=MDDEF
"RTN","MDRPCW",105,0)
 S:'MDLOCN MDLOCN=$P(MDVSTR,";")
"RTN","MDRPCW",106,0)
 S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Visit #: "_$S(MDVST>0:MDVST,1:"")
"RTN","MDRPCW",107,0)
 I '+MDVST S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Encounter Date/Time: "_$E(MDENCDT,4,5)_"/"_$E(MDENCDT,6,7)_"/"_$E(MDENCDT,2,3)
"RTN","MDRPCW",108,0)
 I '+MDVST S MDVST=$$GETENC^PXAPI(MDDFN,MDENCDT,MDLOCN),MDVST=$S(+MDVST<1:0,1:+MDVST),MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Visit # For Encounter Date: "_$S(MDVST>0:MDVST,1:"")
"RTN","MDRPCW",109,0)
 I +MDVST>0 D ENCEVENT^PXAPI(MDVST)
"RTN","MDRPCW",110,0)
 I +MDVST>0 S MDPROV=0 F  S MDPROV=$O(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV)) Q:'MDPROV  D
"RTN","MDRPCW",111,0)
 .Q:'MDPFLG
"RTN","MDRPCW",112,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV,0))
"RTN","MDRPCW",113,0)
 .S CODE=+$P(MDX0,U)
"RTN","MDRPCW",114,0)
 .I +CODE S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Provider: "_$$GET1^DIQ(200,+CODE_",",.01,"E")_" "_$S($P(MDX0,U,4)="P":"Primary",1:"")
"RTN","MDRPCW",115,0)
 I +MDVST>0 S MDICD=0 F  S MDICD=$O(^TMP("PXKENC",$J,MDVST,"POV",MDICD)) Q:'MDICD  D
"RTN","MDRPCW",116,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"POV",MDICD,0)),MDX802=$G(^(802))
"RTN","MDRPCW",117,0)
 .S CODE=+$G(MDX0,U),GDIAG=$$ICDDX^ICDCODE(CODE,"")
"RTN","MDRPCW",118,0)
 .S:CODE DIAG=$P(GDIAG,U,2)_U_$P(GDIAG,U,4)
"RTN","MDRPCW",119,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW",120,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW",121,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Diagnosis: "_$P(DIAG,U,2)_" "_$S($P(MDX0,U,12)="P":"Primary",1:""),MDCK=MDCK+1
"RTN","MDRPCW",122,0)
 I +MDVST>0 S MDCPT=0 F  S MDCPT=$O(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT)) Q:'MDCPT  D
"RTN","MDRPCW",123,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT,0)),MDX802=$G(^(802))
"RTN","MDRPCW",124,0)
 .S CODE=+$G(MDX0,U)
"RTN","MDRPCW",125,0)
 .S:CODE CODE=$$CPT^ICPTCOD(CODE,MDVST)
"RTN","MDRPCW",126,0)
 .S:CODE DIAG=$P(CODE,U,2,3)
"RTN","MDRPCW",127,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW",128,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW",129,0)
 .S QTY=$P(MDX0,U,16)
"RTN","MDRPCW",130,0)
 .S MDDESC="" D CPTLEX^MDRPCWU(.RESLT,$P(DIAG,U),"CPT")
"RTN","MDRPCW",131,0)
 .S MDCLL="" F  S MDCLL=$O(^TMP("MDLEX",$J,MDCLL)) Q:MDCLL<1  S MDDESC=$P(^(MDCLL),"^",3)
"RTN","MDRPCW",132,0)
 .S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230) K ^TMP("MDLEX",$J),RESLT
"RTN","MDRPCW",133,0)
 .S:MDDESC="" MDDESC=$P(DIAG,U,2)
"RTN","MDRPCW",134,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="CPT: "_MDDESC_"-"_QTY,MDCK=MDCK+1
"RTN","MDRPCW",135,0)
 K ^TMP("PXKENC",$J)
"RTN","MDRPCW",136,0)
 I 'MDVST!(+MDCK<1) D
"RTN","MDRPCW",137,0)
 .S MDDDN=$O(^MDD(702,"ACON",MDCCON,+STUDY),-1),MDVST=0
"RTN","MDRPCW",138,0)
 .I MDDDN D
"RTN","MDRPCW",139,0)
 ..S MDDDV=$P($G(^MDD(702,+MDDDN,0)),U,7)
"RTN","MDRPCW",140,0)
 ..S:$L(MDDDV,";")>1 MDENCDT=$P(MDDDV,";",2),MDVST=+$G(^MDD(702,+MDDDN,1)),MDVST=$S(+MDVST<1:0,1:+MDVST)
"RTN","MDRPCW",141,0)
 ..I +MDVST>0 S MDNCTR=0
"RTN","MDRPCW",142,0)
 ..S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Previous Study # Used: "_+MDDDN
"RTN","MDRPCW",143,0)
 ..S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Previous Visit #: "_MDVST_" "_$E(MDENCDT,4,5)_"/"_$E(MDENCDT,6,7)_"/"_$E(MDENCDT,2,3)
"RTN","MDRPCW",144,0)
 I $G(MDFLST(1))'="" S MDLL=0 F  S MDLL=$O(MDFLST(MDLL)) Q:MDLL<1  S:$G(MDFLST(MDLL))'="" MDCTR=MDCTR+1,@RESULTS@(MDCTR)=$G(MDFLST(MDLL))
"RTN","MDRPCW",145,0)
 Q:MDCK>0
"RTN","MDRPCW",146,0)
 Q:'MDVST
"RTN","MDRPCW",147,0)
 D ENCEVENT^PXAPI(MDVST) S:$G(MDNCTR)>0 MDCTR=MDNCTR
"RTN","MDRPCW",148,0)
 S MDPROV=0 F  S MDPROV=$O(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV)) Q:'MDPROV  D
"RTN","MDRPCW",149,0)
 .Q
"RTN","MDRPCW",150,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV,0))
"RTN","MDRPCW",151,0)
 .S CODE=+$P(MDX0,U)
"RTN","MDRPCW",152,0)
 .I +CODE S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="PRV"_U_CODE_U_U_$$GET1^DIQ(200,+CODE_",",.01,"E")_U_U_($P(MDX0,U,4)="P")
"RTN","MDRPCW",153,0)
 ;^TMP("MDENC",$J,n)="POV"^ICD9 IEN^ICD9 CODE^provider narrative category^provider narrative (Short Description)^Primary (1=Yes,0=No)
"RTN","MDRPCW",154,0)
 S MDICD=0 F  S MDICD=$O(^TMP("PXKENC",$J,MDVST,"POV",MDICD)) Q:'MDICD  D
"RTN","MDRPCW",155,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"POV",MDICD,0)),MDX802=$G(^(802))
"RTN","MDRPCW",156,0)
 .S CODE=+$G(MDX0,U),GDIAG=$$ICDDX^ICDCODE(CODE,"")
"RTN","MDRPCW",157,0)
 .S:CODE DIAG=$P(GDIAG,U,2)_U_$P(GDIAG,U,4)
"RTN","MDRPCW",158,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW",159,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW",160,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="Diagnosis: "_$P(DIAG,U,2)_" "_$S($P(MDX0,U,12)="P":"Primary",1:"")
"RTN","MDRPCW",161,0)
 S MDCPT=0 F  S MDCPT=$O(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT)) Q:'MDCPT  D
"RTN","MDRPCW",162,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT,0)),MDX802=$G(^(802))
"RTN","MDRPCW",163,0)
 .S CODE=+$G(MDX0,U)
"RTN","MDRPCW",164,0)
 .S:CODE CODE=$$CPT^ICPTCOD(CODE,MDVST)
"RTN","MDRPCW",165,0)
 .S:CODE DIAG=$P(CODE,U,2,3)
"RTN","MDRPCW",166,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW",167,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW",168,0)
 .S QTY=$P(MDX0,U,16)
"RTN","MDRPCW",169,0)
 .S MDDESC="" D CPTLEX^MDRPCWU(.RESLT,$P(DIAG,U),"CPT")
"RTN","MDRPCW",170,0)
 .S MDCLL="" F  S MDCLL=$O(^TMP("MDLEX",$J,MDCLL)) Q:MDCLL<1  S MDDESC=$P(^(MDCLL),"^",3)
"RTN","MDRPCW",171,0)
 .S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230) K ^TMP("MDLEX",$J),RESLT
"RTN","MDRPCW",172,0)
 .S:MDDESC="" MDDESC=$P(DIAG,U,2)
"RTN","MDRPCW",173,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="CPT: "_MDDESC_"-"_QTY
"RTN","MDRPCW",174,0)
 K ^TMP("PXKENC",$J)
"RTN","MDRPCW",175,0)
 Q
"RTN","MDRPCW",176,0)
TIMEMET ; Check if appointment time is met
"RTN","MDRPCW",177,0)
 N MDNOW,MDTIM,MDV
"RTN","MDRPCW",178,0)
 S MDV=$$GET1^DIQ(702,+MDSTUD_",",.07,"I")
"RTN","MDRPCW",179,0)
 I $G(MDV)="" S @RESULTS@(0)="-1^No Visit." Q
"RTN","MDRPCW",180,0)
 I $L(MDV,";")=1 S MDTIM=MDV
"RTN","MDRPCW",181,0)
 E  S MDTIM=$P(MDV,";",2)
"RTN","MDRPCW",182,0)
 I 'MDTIM S @RESULTS@(0)="-1^No Visit Date/Time." Q
"RTN","MDRPCW",183,0)
 D NOW^%DTC S MDNOW=% K %
"RTN","MDRPCW",184,0)
 I MDNOW<MDTIM S @RESULTS@(0)="0^Appointment/Visit Date/Time not met." Q
"RTN","MDRPCW",185,0)
 S @RESULTS@(0)="1^Appointment/Visit Date/Time have met."
"RTN","MDRPCW",186,0)
 Q
"RTN","MDRPCW1")
0^11^B57093327^B57107439
"RTN","MDRPCW1",1,0)
MDRPCW1 ; HOIFO/NCA - MD TMDENCOUNTER Object; [05-28-2002 12:55] ;2/16/10  16:17
"RTN","MDRPCW1",2,0)
 ;;1.0;CLINICAL PROCEDURES;**6,21,20**;Apr 01, 2004;Build 9
"RTN","MDRPCW1",3,0)
 ; Reference Integration Agreement:
"RTN","MDRPCW1",4,0)
 ; IA #1573 [Supported] ICDONE^LEXU call
"RTN","MDRPCW1",5,0)
 ; IA #1593 [Subscription] Access to Provider Narrative file
"RTN","MDRPCW1",6,0)
 ;                         (#9999999.27)
"RTN","MDRPCW1",7,0)
 ; IA #1609 [Supported] CONFIG^LEXSET call
"RTN","MDRPCW1",8,0)
 ; IA #1894 [Subscription] PXAPI calls
"RTN","MDRPCW1",9,0)
 ; IA #1995 [Supported] ICPTCOD calls
"RTN","MDRPCW1",10,0)
 ; IA #2056 [Supported] Call to DIQ
"RTN","MDRPCW1",11,0)
 ; IA #2263 [Supported] XPAR calls
"RTN","MDRPCW1",12,0)
 ; IA #2348 [Subscription] SCCOND^PXUTLSCC call
"RTN","MDRPCW1",13,0)
 ; IA #2950 [Supported] LOOK^LEXA call
"RTN","MDRPCW1",14,0)
 ; IA #3990 [Supported] ICDCODE calls.
"RTN","MDRPCW1",15,0)
 ; IA #10060 [Supported] FILE 200 references
"RTN","MDRPCW1",16,0)
 ;
"RTN","MDRPCW1",17,0)
CPTMODS(RESULTS,MDCPT) ;Return CPT Modifiers for a CPT Code
"RTN","MDRPCW1",18,0)
 N MDARR,MDIDX,MDI,MDNAME
"RTN","MDRPCW1",19,0)
 S RESULTS=$NA(^TMP("MDMODS",$J)) K @RESULTS
"RTN","MDRPCW1",20,0)
 S MDDATE=DT
"RTN","MDRPCW1",21,0)
 I +($$CODM^ICPTCOD(MDCPT,$NA(MDARR),0,MDDATE)),+$D(MDARR) D
"RTN","MDRPCW1",22,0)
 . S MDIDX="",MDI=0
"RTN","MDRPCW1",23,0)
 . F  S MDIDX=$O(MDARR(MDIDX)) Q:(MDIDX="")  D
"RTN","MDRPCW1",24,0)
 . . S MDI=MDI+1,MDNAME=$P(MDARR(MDIDX),U,1)
"RTN","MDRPCW1",25,0)
 . . S @RESULTS@(MDNAME_MDI)=$P(MDARR(MDIDX),U,2)_U_MDNAME_U_MDIDX
"RTN","MDRPCW1",26,0)
 Q
"RTN","MDRPCW1",27,0)
LEX(RESULTS,MDSRCH,MDAPP)   ; return list after lexicon lookup
"RTN","MDRPCW1",28,0)
 N CODE,LEX,MDLST,MDI,LEXIEN,MDVAL
"RTN","MDRPCW1",29,0)
 S RESULTS=$NA(^TMP("MDLEX",$J)) K @RESULTS
"RTN","MDRPCW1",30,0)
 S MDDATE=DT
"RTN","MDRPCW1",31,0)
 S:MDAPP="CPT" MDAPP="CHP" ; LEX PATCH 10
"RTN","MDRPCW1",32,0)
 D CONFIG^LEXSET(MDAPP,MDAPP,MDDATE)
"RTN","MDRPCW1",33,0)
 D LOOK^LEXA(MDSRCH,MDAPP,1,"",MDDATE)
"RTN","MDRPCW1",34,0)
 I '$D(LEX("LIST",1)) S @RESULTS@(1)="-1^No matches found." Q
"RTN","MDRPCW1",35,0)
 S @RESULTS@(1)=LEX("LIST",1),MDLST=1
"RTN","MDRPCW1",36,0)
 S MDI="" F  S MDI=$O(^TMP("LEXFND",$J,MDI)) Q:MDI'<0  D
"RTN","MDRPCW1",37,0)
 . S LEXIEN=$O(^TMP("LEXFND",$J,MDI,0))
"RTN","MDRPCW1",38,0)
 . S MDLST=MDLST+1,@RESULTS@(MDLST)=LEXIEN_U_^TMP("LEXFND",$J,MDI,LEXIEN)
"RTN","MDRPCW1",39,0)
 K ^TMP("LEXFND",$J),^TMP("LEXHIT",$J)
"RTN","MDRPCW1",40,0)
 S MDI="" F  S MDI=$O(@RESULTS@(MDI)) Q:'MDI  S MDVAL=$G(@RESULTS@(MDI)) D
"RTN","MDRPCW1",41,0)
 . I MDAPP="ICD" S CODE=$$ICDONE^LEXU(+MDVAL,MDDATE),@RESULTS@(MDI)=CODE_U_MDVAL
"RTN","MDRPCW1",42,0)
 . I MDAPP="CPT"!(MDAPP="CHP") S CODE=$$CPTONE^LEXU(+MDVAL,MDDATE),@RESULTS@(MDI)=CODE_U_MDVAL
"RTN","MDRPCW1",43,0)
 . I CODE="",(MDAPP="CHP") S CODE=$$CPCONE^LEXU(+MDVAL,MDDATE),@RESULTS@(MDI)=CODE_U_MDVAL
"RTN","MDRPCW1",44,0)
 Q
"RTN","MDRPCW1",45,0)
GETENC(RESULTS,STUDY) ; Return the current encounter data entered
"RTN","MDRPCW1",46,0)
 S RESULTS=$NA(^TMP("MDENC",$J)) K @RESULTS
"RTN","MDRPCW1",47,0)
 N MDDAR,MDDAR2,CAT,CODE,DIAG,GLOARR,MDCCON,MDX802,MDARR,MDCPT,MDCTR,MDDFN,MDENCDT,MDFLST,MDICD,MDLC,MDLL,MDLOCN,MDPROV,MDRP,MDRST,MDVST,MDVSTR,QTY,MDX,MDX0,MDX1,S S S=";"
"RTN","MDRPCW1",48,0)
 N GDIAG,LLB,MDDDN,MDDDV,MDCK,RESLT,MDNCTR,MDPFLG,MDCLL,MDDESC S (MDCK,MDPFLG)=0
"RTN","MDRPCW1",49,0)
 Q:'$G(STUDY)
"RTN","MDRPCW1",50,0)
 Q:'$G(^MDD(702,+STUDY,0))
"RTN","MDRPCW1",51,0)
 D NOW^%DTC S MDDEF=% K % S MDCTR=0
"RTN","MDRPCW1",52,0)
 K ^TMP("MDDAR",$J),^TMP("MDLEX",$J),GLOARR,MDFLST
"RTN","MDRPCW1",53,0)
 S MDX=$G(^MDD(702,+STUDY,0)),MDX1=$G(^(1)),MDCCON=$P(MDX,U,5)
"RTN","MDRPCW1",54,0)
 S MDVST=$P(MDX1,U),MDDFN=$P(MDX,U) Q:'MDDFN
"RTN","MDRPCW1",55,0)
 S:+MDVST MDPFLG=1
"RTN","MDRPCW1",56,0)
 S MDVSTR=$P(MDX,U,7),MDDAR=$NA(^TMP("MDDAR",$J)),MDDAR2=$NA(GLOARR),@MDDAR2@("POV",0)=0,@MDDAR2@("CPT",0)=0,MDLC=0
"RTN","MDRPCW1",57,0)
 I 'MDVST S MDRP=0 F  S MDRP=$O(^MDD(702,STUDY,.1,MDRP)) Q:'MDRP  D
"RTN","MDRPCW1",58,0)
 .S MDRST=$P($G(^MDD(702,STUDY,.1,+MDRP,0)),"^",3)
"RTN","MDRPCW1",59,0)
 .I +MDRST D CICNV^MDHL7U3(+MDRST,.MDDAR) D SETGLO(.MDDAR,.MDDAR2)
"RTN","MDRPCW1",60,0)
 .K ^TMP("MDDAR",$J) Q
"RTN","MDRPCW1",61,0)
 I 'MDVST&(+$G(@MDDAR2@("POV",0))>0) F MDLL=1:1:+$G(@MDDAR2@("POV",0)) S MDLC=MDLC+1,MDFLST(MDLC)=$G(@MDDAR2@("POV",MDLL))
"RTN","MDRPCW1",62,0)
 I 'MDVST&(+$G(@MDDAR2@("CPT",0))>0) F MDLL=1:1:+$G(@MDDAR2@("CPT",0)) S MDLC=MDLC+1,MDFLST(MDLC)=$G(@MDDAR2@("CPT",MDLL))
"RTN","MDRPCW1",63,0)
 I MDVST>0 S MDENCDT=$P(MDVSTR,";",2),MDLOCN=$P(MDVSTR,";",3)
"RTN","MDRPCW1",64,0)
 ;E  S MDENCDT=$$PDT^MDRPCOT1(STUDY)
"RTN","MDRPCW1",65,0)
 E  S MDENCDT=$P(MDVSTR,";",2)
"RTN","MDRPCW1",66,0)
 S:$L(MDVSTR,";")=1 MDVSTR=";"_MDVSTR
"RTN","MDRPCW1",67,0)
 S MDVSTR=$$GETVSTR^MDRPCOT1(MDDFN,MDVSTR,+$P(MDX,U,4),$P(MDX,U,2)),MDLOCN=$P(MDVSTR,";",1)
"RTN","MDRPCW1",68,0)
 S:'MDENCDT MDENCDT=$P(MDVSTR,";",2)
"RTN","MDRPCW1",69,0)
 S:'MDENCDT MDENCDT=MDDEF
"RTN","MDRPCW1",70,0)
 S:'MDLOCN MDLOCN=$P(MDVSTR,";")
"RTN","MDRPCW1",71,0)
 D SCCOND^PXUTLSCC(MDDFN,MDENCDT,MDLOCN,MDVST,.MDARR)
"RTN","MDRPCW1",72,0)
 S MDCTR=MDCTR+1
"RTN","MDRPCW1",73,0)
 ; ^TMP("MDENC",$J,n)="SC";0/1^0/1;"AO";0/1^0/1;"IR";0/1^0/1;"EC";0/1^0/1;"MST";0/1^0/1;"HNC";0/1^0/1;"CV";0/1^0/1
"RTN","MDRPCW1",74,0)
 ;first piece 1 if the condition can be answered
"RTN","MDRPCW1",75,0)
 ;            0 if the condition should be null not asked
"RTN","MDRPCW1",76,0)
 ;second piece - If Scheduling has the answer, 1 = yes 0 = no
"RTN","MDRPCW1",77,0)
 S @RESULTS@(MDCTR)="SC"_S_$G(MDARR("SC"))_S_"AO"_S_$G(MDARR("AO"))_S_"IR"_S_$G(MDARR("IR"))_S_"EC"_S_$G(MDARR("EC"))_S_"MST"_S_$G(MDARR("MST"))_S_"HNC"_S_$G(MDARR("HNC"))_S_"CV"_S_$G(MDARR("CV"))
"RTN","MDRPCW1",78,0)
 I 'MDVST S MDVST=$$GETENC^PXAPI(MDDFN,MDENCDT,MDLOCN),MDVST=$S(+MDVST<1:0,1:+MDVST)
"RTN","MDRPCW1",79,0)
 I +MDVST>0 D ENCEVENT^PXAPI(MDVST)
"RTN","MDRPCW1",80,0)
 ;^TMP("MDENC",$J,n)="PRV"^CODE^^NARR^^Primary (1=Yes,0=No)
"RTN","MDRPCW1",81,0)
 I +MDVST>0 S MDPROV=0 F  S MDPROV=$O(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV)) Q:'MDPROV  D
"RTN","MDRPCW1",82,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV,0))
"RTN","MDRPCW1",83,0)
 .S CODE=+$P(MDX0,U)
"RTN","MDRPCW1",84,0)
 .I +CODE S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="PRV"_U_CODE_U_U_$$GET1^DIQ(200,+CODE_",",.01,"E")_U_U_($P(MDX0,U,4)="P")
"RTN","MDRPCW1",85,0)
 ;^TMP("MDENC",$J,n)="POV"^ICD9 IEN^ICD9 CODE^provider narrative category^provider narrative (Short Description)^Primary (1=Yes,0=No)
"RTN","MDRPCW1",86,0)
 I +MDVST>0 S MDICD=0 F  S MDICD=$O(^TMP("PXKENC",$J,MDVST,"POV",MDICD)) Q:'MDICD  D
"RTN","MDRPCW1",87,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"POV",MDICD,0)),MDX802=$G(^(802))
"RTN","MDRPCW1",88,0)
 .S CODE=+$G(MDX0,U),GDIAG=$$ICDDX^ICDCODE(CODE,"")
"RTN","MDRPCW1",89,0)
 .S:CODE DIAG=$P(GDIAG,U,2)_U_$P(GDIAG,U,4)
"RTN","MDRPCW1",90,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW1",91,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW1",92,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="POV"_U_+$G(MDX0,U)_U_$P(DIAG,U)_U_CAT_U_$P(DIAG,U,2)_U_($P(MDX0,U,12)="P"),MDCK=MDCK+1
"RTN","MDRPCW1",93,0)
 ;^TMP("MDENC",$J,n)="CPT"^CPT IEN^CPT CODE^provider narrative category^provider narrative (Description)^^Quantity
"RTN","MDRPCW1",94,0)
 I +MDVST>0 S MDCPT=0 F  S MDCPT=$O(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT)) Q:'MDCPT  D
"RTN","MDRPCW1",95,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT,0)),MDX802=$G(^(802))
"RTN","MDRPCW1",96,0)
 .S CODE=+$G(MDX0,U)
"RTN","MDRPCW1",97,0)
 .S:CODE CODE=$$CPT^ICPTCOD(CODE,MDVST)
"RTN","MDRPCW1",98,0)
 .S:CODE DIAG=$P(CODE,U,2,3)
"RTN","MDRPCW1",99,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW1",100,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW1",101,0)
 .S QTY=$P(MDX0,U,16)
"RTN","MDRPCW1",102,0)
 .S MDDESC="" D CPTLEX^MDRPCWU(.RESLT,$P(DIAG,U),"CPT")
"RTN","MDRPCW1",103,0)
 .S MDCLL="" F  S MDCLL=$O(^TMP("MDLEX",$J,MDCLL)) Q:MDCLL<1  S MDDESC=$P(^(MDCLL),"^",3)
"RTN","MDRPCW1",104,0)
 .S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230) K ^TMP("MDLEX",$J),RESLT
"RTN","MDRPCW1",105,0)
 .S:MDDESC="" MDDESC=$P(DIAG,U,2)
"RTN","MDRPCW1",106,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="CPT"_U_+$G(MDX0,U)_U_$P(DIAG,U)_U_CAT_U_MDDESC_U_U_QTY,MDCK=MDCK+1
"RTN","MDRPCW1",107,0)
 K ^TMP("PXKENC",$J)
"RTN","MDRPCW1",108,0)
 I 'MDVST!(+MDCK<1) D
"RTN","MDRPCW1",109,0)
 .S MDDDN=$O(^MDD(702,"ACON",MDCCON,+STUDY),-1),MDVST=0
"RTN","MDRPCW1",110,0)
 .I MDDDN D
"RTN","MDRPCW1",111,0)
 ..S MDDDV=$P($G(^MDD(702,+MDDDN,0)),U,7)
"RTN","MDRPCW1",112,0)
 ..S:$L(MDDDV,";")>1 MDENCDT=$P(MDDDV,";",2),MDVST=+$G(^MDD(702,+MDDDN,1)),MDVST=$S(+MDVST<1:0,1:+MDVST)
"RTN","MDRPCW1",113,0)
 ..I +MDVST>0 S MDNCTR=MDCTR F LLB=2:1:MDCTR K @RESULTS@(MDCTR) S MDNCTR=MDNCTR-1
"RTN","MDRPCW1",114,0)
 I $G(MDFLST(1))'="" S MDLL=0 F  S MDLL=$O(MDFLST(MDLL)) Q:MDLL<1  S:$G(MDFLST(MDLL))'="" MDCTR=MDCTR+1,@RESULTS@(MDCTR)=$G(MDFLST(MDLL))
"RTN","MDRPCW1",115,0)
 Q:MDCK>0
"RTN","MDRPCW1",116,0)
 Q:'MDVST
"RTN","MDRPCW1",117,0)
 D ENCEVENT^PXAPI(MDVST) S:$G(MDNCTR)>0 MDCTR=MDNCTR
"RTN","MDRPCW1",118,0)
 ;^TMP("MDENC",$J,n)="PRV"^CODE^^NARR^^Primary (1=Yes,0=No)
"RTN","MDRPCW1",119,0)
 S MDPROV=0 F  S MDPROV=$O(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV)) Q:'MDPROV  D
"RTN","MDRPCW1",120,0)
 .Q
"RTN","MDRPCW1",121,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"PRV",MDPROV,0))
"RTN","MDRPCW1",122,0)
 .S CODE=+$P(MDX0,U)
"RTN","MDRPCW1",123,0)
 .I +CODE S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="PRV"_U_CODE_U_U_$$GET1^DIQ(200,+CODE_",",.01,"E")_U_U_($P(MDX0,U,4)="P")
"RTN","MDRPCW1",124,0)
 ;^TMP("MDENC",$J,n)="POV"^ICD9 IEN^ICD9 CODE^provider narrative category^provider narrative (Short Description)^Primary (1=Yes,0=No)
"RTN","MDRPCW1",125,0)
 S MDICD=0 F  S MDICD=$O(^TMP("PXKENC",$J,MDVST,"POV",MDICD)) Q:'MDICD  D
"RTN","MDRPCW1",126,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"POV",MDICD,0)),MDX802=$G(^(802))
"RTN","MDRPCW1",127,0)
 .S CODE=+$G(MDX0,U),GDIAG=$$ICDDX^ICDCODE(CODE,"")
"RTN","MDRPCW1",128,0)
 .S:CODE DIAG=$P(GDIAG,U,2)_U_$P(GDIAG,U,4)
"RTN","MDRPCW1",129,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW1",130,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW1",131,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="POV"_U_+$G(MDX0,U)_U_$P(DIAG,U)_U_CAT_U_$P(DIAG,U,2)_U_($P(MDX0,U,12)="P")
"RTN","MDRPCW1",132,0)
 ;^TMP("MDENC",$J,n)="CPT"^CPT IEN^CPT CODE^provider narrative category^provider narrative (Short Description)^^Quantity
"RTN","MDRPCW1",133,0)
 S MDCPT=0 F  S MDCPT=$O(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT)) Q:'MDCPT  D
"RTN","MDRPCW1",134,0)
 .S MDX0=$G(^TMP("PXKENC",$J,MDVST,"CPT",MDCPT,0)),MDX802=$G(^(802))
"RTN","MDRPCW1",135,0)
 .S CODE=+$G(MDX0,U)
"RTN","MDRPCW1",136,0)
 .S:CODE CODE=$$CPT^ICPTCOD(CODE,MDVST)
"RTN","MDRPCW1",137,0)
 .S:CODE DIAG=$P(CODE,U,2,3)
"RTN","MDRPCW1",138,0)
 .S CAT=$P(MDX802,U)
"RTN","MDRPCW1",139,0)
 .S:CAT CAT=$P($G(^AUTNPOV(CAT,0)),U)
"RTN","MDRPCW1",140,0)
 .S QTY=$P(MDX0,U,16)
"RTN","MDRPCW1",141,0)
 .S MDDESC="" D CPTLEX^MDRPCWU(.RESLT,$P(DIAG,U),"CPT")
"RTN","MDRPCW1",142,0)
 .S MDCLL="" F  S MDCLL=$O(^TMP("MDLEX",$J,MDCLL)) Q:MDCLL<1  S MDDESC=$P(^(MDCLL),"^",3)
"RTN","MDRPCW1",143,0)
 .S:$L(MDDESC)>230 MDDESC=$E(MDDESC,1,230) K ^TMP("MDLEX",$J),RESLT
"RTN","MDRPCW1",144,0)
 .S:MDDESC="" MDDESC=$P(DIAG,U,2)
"RTN","MDRPCW1",145,0)
 .S MDCTR=MDCTR+1,@RESULTS@(MDCTR)="CPT"_U_+$G(MDX0,U)_U_$P(DIAG,U)_U_CAT_U_MDDESC_U_U_QTY
"RTN","MDRPCW1",146,0)
 K ^TMP("PXKENC",$J)
"RTN","MDRPCW1",147,0)
 Q
"RTN","MDRPCW1",148,0)
SETGLO(MDGLO1,MDGLO2) ; Set the ICD and CPT from device into a global array
"RTN","MDRPCW1",149,0)
 N MDA,MDB,MDC
"RTN","MDRPCW1",150,0)
 I +$G(@MDGLO1@(1))<1&(+$G(@MDGLO1@(2))<1) Q
"RTN","MDRPCW1",151,0)
 S MDA=$O(@MDGLO2@("POV",""),-1)
"RTN","MDRPCW1",152,0)
 S MDB=$O(@MDGLO2@("CPT",""),-1)
"RTN","MDRPCW1",153,0)
 F MDC=1:1:+$G(@MDGLO1@(1)) S MDA=MDA+1,@MDGLO2@("POV",MDA)=$G(@MDGLO1@(1,MDC))
"RTN","MDRPCW1",154,0)
 F MDC=1:1:+$G(@MDGLO1@(2)) S MDB=MDB+1,@MDGLO2@("CPT",MDB)=$G(@MDGLO1@(2,MDC))
"RTN","MDRPCW1",155,0)
 S @MDGLO2@("POV",0)=MDA,@MDGLO2@("CPT",0)=MDB
"RTN","MDRPCW1",156,0)
 Q
"RTN","MDRPCW1",157,0)
NTIU(P1,RECID) ; Create New TIU note for Result
"RTN","MDRPCW1",158,0)
 I $G(^MDD(702,+P1,0))="" Q 0
"RTN","MDRPCW1",159,0)
 N MDNEWN,MDFG,MDHVL,MDKK S MDFG=0
"RTN","MDRPCW1",160,0)
 D GETLST^XPAR(.MDHVL,"SYS","MD GET HIGH VOLUME")
"RTN","MDRPCW1",161,0)
 F MDKK=0:0 S MDKK=$O(MDHVL(MDKK)) Q:MDKK<1  I $P($G(MDHVL(MDKK)),"^")=+$P(^MDD(702,+P1,0),U,4) S MDFG=1 Q
"RTN","MDRPCW1",162,0)
 I $P($G(^MDS(702.01,+$P(^MDD(702,+P1,0),U,4),0)),U,6)=2 S MDNEWN=$$NEWTIUN^MDRPCOT2(+P1)
"RTN","MDRPCW1",163,0)
 I +$P($G(^MDS(702.01,+$P(^MDD(702,+P1,0),U,4),0)),U,10)!(+MDFG) S MDNEWN=$$NEWTIUN^MDRPCOTH(+P1,RECID)
"RTN","MDRPCW1",164,0)
 Q 1
"RTN","MDWOR")
0^12^B42202068^B40304234
"RTN","MDWOR",1,0)
MDWOR ; HOIFO/NCA - Main Routine to Decode HL7 ;9/8/08  15:20
"RTN","MDWOR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11,21,20**;Apr 01,2004;Build 9
"RTN","MDWOR",3,0)
 ; Reference IA# 2263 [Supported] XPAR calls
"RTN","MDWOR",4,0)
 ;               3468 [Subscription] Call GMRCCP.
"RTN","MDWOR",5,0)
 ;               3071 [Subscription] Call $$PKGID^ORX8.
"RTN","MDWOR",6,0)
 ;              10035 [Supported] Access DPT("B"
"RTN","MDWOR",7,0)
 ;              10040 [Supported] Access SC(
"RTN","MDWOR",8,0)
 ;              10061 [Supported] VADPT call
"RTN","MDWOR",9,0)
 ;              10103 [Supported] XLFDT calls
"RTN","MDWOR",10,0)
EN(MDMSG) ; Entry Point for CPRS and pass MSG in MDMSG
"RTN","MDWOR",11,0)
 N DFN,MDCON,MDCPROC,MDCANC,MDCANR,MDFN,MDIFN,MDINST,MDFLG,MDINT,MDL,MDIN,MDINP,MDINST,MDLOC,MDNAM,MDOBC,MDOBX,MDOPRO,MDPROC,MDPAT
"RTN","MDWOR",12,0)
 N MDLL,MDK1,MDPROV,MDREQ,MDQTIM,MDROOT,MDRR,MDSINP,MDVSTD,MDX S MDVSTD=""
"RTN","MDWOR",13,0)
 S (MDFLG,MDINP,MDINST,MDCANC,MDOBC)=0 F MDL=0:0 S MDL=$O(MDMSG(MDL)) Q:MDL<1!(+MDFLG>0)  S MDX=$G(MDMSG(MDL)) D
"RTN","MDWOR",14,0)
 .I $E(MDX,1,3)="MSH" D MSH Q
"RTN","MDWOR",15,0)
 .I $E(MDX,1,3)="PID" D PID Q
"RTN","MDWOR",16,0)
 .I $E(MDX,1,3)="PV1" D PV1 Q
"RTN","MDWOR",17,0)
 .I $E(MDX,1,3)="ORC" D ORC Q
"RTN","MDWOR",18,0)
 .I $E(MDX,1,3)="OBR" D OBR Q
"RTN","MDWOR",19,0)
 .I $E(MDX,1,3)="OBX" D:MDOBC<1 OBX Q
"RTN","MDWOR",20,0)
 .Q
"RTN","MDWOR",21,0)
 D GETLST^XPAR(.MDLL,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWOR",22,0)
 I +MDFLG<1&(+MDCANC<1)&(MDVSTD="") F MDK1=0:0 S MDK1=$O(MDLL(MDK1)) Q:MDK1<1  S MDROOT=$G(MDLL(MDK1)) I +$P(MDROOT,";",2)=MDPROC D  Q:+MDRR
"RTN","MDWOR",23,0)
 .S MDRR=0,MDIFN=MDFN,MDRR=$$GETAPPT(MDIFN,+$P(MDROOT,"^",2))
"RTN","MDWOR",24,0)
 .S:+MDRR MDVSTD="A"_";"_$P(MDRR,"^",1)_";"_+$P(MDROOT,"^",2)
"RTN","MDWOR",25,0)
 I +MDFLG<1&(MDVSTD'="") F MDK1=0:0 S MDK1=$O(MDLL(MDK1)) Q:MDK1<1  S MDROOT=$P($G(MDLL(MDK1)),"^",2) I +$P(MDROOT,";",2)=MDPROC D
"RTN","MDWOR",26,0)
 .I +$P(MDVSTD,";",3)>0&(+MDROOT=$P(MDVSTD,";",3)) S MDFLG=0 Q
"RTN","MDWOR",27,0)
 .I +$P(MDVSTD,";",3)>0&(+MDROOT'=$P(MDVSTD,";",3)) S MDFLG=1 Q
"RTN","MDWOR",28,0)
 I +MDFLG<1&(+MDCANC<1) S MDATA="+1,^"_MDPROC_"^"_+MDCON_"^"_MDINST_"^"_MDVSTD D CHKIN(MDFN,MDREQ,MDPROV,MDATA,MDVSTD)
"RTN","MDWOR",29,0)
 Q
"RTN","MDWOR",30,0)
MSH ; Decode MSH
"RTN","MDWOR",31,0)
 I $P(MDX,"|",2)'="^~\&" S MDFLG=1 Q
"RTN","MDWOR",32,0)
 I $P(MDX,"|",3)'="ORDER ENTRY" S MDFLG=1 Q
"RTN","MDWOR",33,0)
 I $P(MDX,"|",9)'="ORM" S MDFLG=1 Q
"RTN","MDWOR",34,0)
 Q
"RTN","MDWOR",35,0)
PID ; Check PID
"RTN","MDWOR",36,0)
 S MDNAM=$P(MDX,"|",6),DFN=$P(MDX,"|",4)
"RTN","MDWOR",37,0)
 I '$D(^DPT("B",$E(MDNAM,1,30),DFN)) S MDFLG=1
"RTN","MDWOR",38,0)
 S MDFN=DFN
"RTN","MDWOR",39,0)
 Q
"RTN","MDWOR",40,0)
PV1 ; Check PV1
"RTN","MDWOR",41,0)
 S MDPAT=$P(MDX,"|",3) I MDPAT'?1U!("IO"'[MDPAT) S MDFLG=1 Q
"RTN","MDWOR",42,0)
 I MDPAT="I" S MDINP=1
"RTN","MDWOR",43,0)
 S MDLOC=+$P(MDX,"|",4) I $G(^SC(MDLOC,0))="" S MDFLG=1 Q
"RTN","MDWOR",44,0)
 S:MDINP>0 MDLOC=""
"RTN","MDWOR",45,0)
 Q
"RTN","MDWOR",46,0)
ORC ; Check ORC
"RTN","MDWOR",47,0)
 I $P(MDX,"|",2)="NW" D NEW Q
"RTN","MDWOR",48,0)
 I $P(MDX,"|",2)="DC" D CANCEL Q
"RTN","MDWOR",49,0)
 S MDFLG=1
"RTN","MDWOR",50,0)
 Q
"RTN","MDWOR",51,0)
OBX ; Check OBX
"RTN","MDWOR",52,0)
 N %,ANSWER,MDCV,MDOBX
"RTN","MDWOR",53,0)
 S MDOBX=$P(MDX,"|",6)
"RTN","MDWOR",54,0)
 I '+$$GET^XPAR("SYS","MD USE APPT WITH PROCEDURE",1) S MDOBC=MDOBC+1 Q
"RTN","MDWOR",55,0)
 S MDVSTD=$P(MDOBX,"Visit Date: ",2)
"RTN","MDWOR",56,0)
 S MDCV=$P(MDVSTD," ",1,2)
"RTN","MDWOR",57,0)
 I MDCV=""!(MDCV["UNKNOWN") S MDFLG=1 Q
"RTN","MDWOR",58,0)
 S MDVSTD=$P(MDCV," ")_"@"_$P(MDCV," ",2)
"RTN","MDWOR",59,0)
 D DT^DILF("T",MDVSTD,.ANSWER)
"RTN","MDWOR",60,0)
 S:ANSWER<0 ANSWER=""
"RTN","MDWOR",61,0)
 S MDVSTD=ANSWER I MDVSTD="" S MDFLG=1 Q
"RTN","MDWOR",62,0)
 I +MDLOC>0 S MDVSTD="A;"_MDVSTD_";"_MDLOC
"RTN","MDWOR",63,0)
 E  D NOW^%DTC S MDVSTD=%
"RTN","MDWOR",64,0)
 S MDOBC=MDOBC+1
"RTN","MDWOR",65,0)
 Q
"RTN","MDWOR",66,0)
NEW ; New Order Segment
"RTN","MDWOR",67,0)
 S MDIFN=+$P(MDX,"|",3) I 'MDIFN S MDFLG=1 Q
"RTN","MDWOR",68,0)
 S MDPROV=+$P(MDX,"|",11) I 'MDPROV S MDFLG=1 Q
"RTN","MDWOR",69,0)
 S MDQTIM=$P(MDX,"|",8),MDQTIM=$P(MDQTIM,"^",6)
"RTN","MDWOR",70,0)
 S MDREQ=$P(MDX,"|",16) S MDREQ=$$FMDTE(MDREQ) I 'MDREQ S MDFLG=1 Q
"RTN","MDWOR",71,0)
 S MDREQ=$S(MDQTIM="Z24":$$FMADD^XLFDT(MDREQ,0,24),MDQTIM="Z48":$$FMADD^XLFDT(MDREQ,0,48),MDQTIM="Z72":$$FMADD^XLFDT(MDREQ,0,72),MDQTIM="ZW":$$FMADD^XLFDT(MDREQ,7),MDQTIM="ZM":$$FMADD^XLFDT(MDREQ,30),1:MDREQ)
"RTN","MDWOR",72,0)
 ; Retrieve Consult Number
"RTN","MDWOR",73,0)
 N MDFDA
"RTN","MDWOR",74,0)
 S MDCON=$$PKGID^ORX8(MDIFN) I 'MDCON S MDFLG=1 Q
"RTN","MDWOR",75,0)
 Q
"RTN","MDWOR",76,0)
OBR ; Check OBR
"RTN","MDWOR",77,0)
 S MDPROC=$P(MDX,"|",5)
"RTN","MDWOR",78,0)
 I $E($P(MDPROC,"^",6),3,5)'["PRC" S MDFLG=1 Q
"RTN","MDWOR",79,0)
 S MDCPROC=$P(MDPROC,"^",4) I 'MDCPROC S MDFLG=1 Q
"RTN","MDWOR",80,0)
 ; Get Procedure for CP IEN
"RTN","MDWOR",81,0)
 S MDPROC=$$CPROC^GMRCCP(MDCPROC) I 'MDPROC S MDFLG=1 Q
"RTN","MDWOR",82,0)
 S MDSINP=$$HIGHV(MDPROC) I +MDSINP'>1 S MDFLG=1 Q
"RTN","MDWOR",83,0)
 S (MDINST,MDINT)=0 F MDIN=0:0 S MDIN=$O(^MDS(702.01,MDPROC,.1,MDIN)) Q:MDIN<1!(+MDINST)  S MDINT=+$G(^(MDIN,0)) D
"RTN","MDWOR",84,0)
 .I +$$GET1^DIQ(702.09,+MDINT,".13","I") S MDINST=MDINT Q
"RTN","MDWOR",85,0)
 I +$P(MDSINP,"^",2)=2 D  Q
"RTN","MDWOR",86,0)
 .I +MDINP S MDVSTD="",MDOBC=MDOBC+1 Q
"RTN","MDWOR",87,0)
 .S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",88,0)
 I +$P(MDSINP,"^",2)=3 D  Q
"RTN","MDWOR",89,0)
 .I +MDINP S MDVSTD="",MDOBC=MDOBC+1 Q
"RTN","MDWOR",90,0)
 I +$P(MDSINP,"^",2)=1 D  Q
"RTN","MDWOR",91,0)
 .I '+MDINP S MDVSTD="" Q
"RTN","MDWOR",92,0)
 .S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",93,0)
 ;I +MDINP&('$P(^MDS(702.01,MDPROC,0),"^",5)) S MDFLG=1 Q
"RTN","MDWOR",94,0)
 I +MDINP S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",95,0)
 S MDVSTD=MDREQ,MDOBC=MDOBC+1 Q
"RTN","MDWOR",96,0)
 Q
"RTN","MDWOR",97,0)
CANCEL ; Cancel/Discontinue
"RTN","MDWOR",98,0)
 K MDR S MDIFN=+$P(MDX,"|",3),MDCON=+$P(MDX,"|",4),MDCANC=1
"RTN","MDWOR",99,0)
 I 'MDIFN S MDFLG=1 Q
"RTN","MDWOR",100,0)
 I 'MDCON S MDFLG=1 Q
"RTN","MDWOR",101,0)
 S MDPROV=+$P(MDX,"|",13) I 'MDPROV S MDFLG=1 Q
"RTN","MDWOR",102,0)
 S MDREQ=$P(MDX,"|",16) I 'MDREQ S MDFLG=1 Q
"RTN","MDWOR",103,0)
 S MDINST=$O(^MDD(702,"ACON",MDCON,0)) Q:'MDINST
"RTN","MDWOR",104,0)
 Q:$G(^MDD(702,+MDINST,0))=""
"RTN","MDWOR",105,0)
 I "5"[$P(^MDD(702,+MDINST,0),U,9) S MDCANR=$$CANCEL^MDHL7B(+MDINST)
"RTN","MDWOR",106,0)
 N MDFDA S MDFDA(702,MDINST_",",.09)=6
"RTN","MDWOR",107,0)
 D FILE^DIE("K","MDFDA") K MDFDA
"RTN","MDWOR",108,0)
 N MDHEMO S MDHEMO=+$$GET1^DIQ(702,+MDINST,".04:.06","I")
"RTN","MDWOR",109,0)
 Q:MDHEMO<2
"RTN","MDWOR",110,0)
 Q:$G(^MDK(704.202,+MDINST,0))=""
"RTN","MDWOR",111,0)
 S MDFDA(704.202,+MDINST_",",.09)=0
"RTN","MDWOR",112,0)
 D FILE^DIE("","MDFDA")
"RTN","MDWOR",113,0)
 K ^MDK(704.202,"AS",1,+MDINST)
"RTN","MDWOR",114,0)
 S ^MDK(704.202,"AS",0,+MDINST)=""
"RTN","MDWOR",115,0)
 Q
"RTN","MDWOR",116,0)
CHKIN(MDFN,MDREQ,MDPROV,MDATA,MDVSTD) ; [Procedure] Check In Study
"RTN","MDWOR",117,0)
 N MDX1,MDFDA,MDIEN,MDIENS,MDERR,MDHL7,MDHOLD,MDSCHD,MDMAXD,MDXY,MDNOW
"RTN","MDWOR",118,0)
 F MDX1=2:1:5 D
"RTN","MDWOR",119,0)
 .I $P(MDATA,U,MDX1)]"" S MDFDA(702,$P(MDATA,U,1),$P("^.04^.05^.11^.07",U,MDX1))=$P(MDATA,U,MDX1)
"RTN","MDWOR",120,0)
 ; Remove code after instrument testing available
"RTN","MDWOR",121,0)
 ; End of code removal after instrument available for testin
"RTN","MDWOR",122,0)
 S MDSCHD=$S($L(MDVSTD,";")=1:MDVSTD,1:$P(MDVSTD,";",2)),MDMAXD=DT+.24
"RTN","MDWOR",123,0)
 S MDFDA(702,$P(MDATA,U,1),.09)=$S(MDSCHD="":0,MDSCHD>MDMAXD:0,1:5)  ; Status = Checked-In
"RTN","MDWOR",124,0)
 I $P(MDATA,U,1)="+1," D
"RTN","MDWOR",125,0)
 .S MDFDA(702,"+1,",.01)=MDFN
"RTN","MDWOR",126,0)
 .S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWOR",127,0)
 .S MDFDA(702,"+1,",.03)=MDPROV
"RTN","MDWOR",128,0)
 .S:+MDSCHD MDFDA(702,"+1,",.14)=MDSCHD
"RTN","MDWOR",129,0)
 .D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)
"RTN","MDWOR",130,0)
 .Q:MDSCHD>MDMAXD!(MDSCHD="")
"RTN","MDWOR",131,0)
 .S MDIENS=MDIEN(1)_",",MDXY=+$P(MDATA,U,2),MDHOLD="" I +MDXY D
"RTN","MDWOR",132,0)
 ..Q:$P(^MDS(702.01,MDXY,0),U,6)'=2
"RTN","MDWOR",133,0)
 ..S MDHOLD=$P($G(^MDD(702,MDIEN(1),0)),"^",7),MDNOW=$$NOW^XLFDT()
"RTN","MDWOR",134,0)
 ..S $P(^MDD(702,MDIEN(1),0),"^",7)=MDSCHD
"RTN","MDWOR",135,0)
 .S MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDWOR",136,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWOR",137,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWOR",138,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWOR",139,0)
 Q:MDSCHD>MDMAXD!(MDSCHD="")
"RTN","MDWOR",140,0)
 D:+$G(MDIENS)
"RTN","MDWOR",141,0)
 .S MDXY=+$P(MDATA,U,2) Q:'MDXY
"RTN","MDWOR",142,0)
 .I $P(^MDS(702.01,MDXY,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDWOR",143,0)
 ..D CP^MDKUTL(+MDIENS)
"RTN","MDWOR",144,0)
 ..S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD
"RTN","MDWOR",145,0)
 ..S MDFDA(702,+MDIENS_",",.09)=5
"RTN","MDWOR",146,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWOR",147,0)
 Q
"RTN","MDWOR",148,0)
FMDTE(DATE) ; Convert HL-7 formatted date to a Fileman formatted date
"RTN","MDWOR",149,0)
 N X
"RTN","MDWOR",150,0)
 S X="" I DATE D
"RTN","MDWOR",151,0)
 .S X=$$HL7TFM^XLFDT(DATE,"L")
"RTN","MDWOR",152,0)
 Q X
"RTN","MDWOR",153,0)
HIGHV(MDHV) ; Return flag indicator whether procedure is use for auto check-in
"RTN","MDWOR",154,0)
 N MDANS,MDK,MDKY,MDLST S MDANS=0
"RTN","MDWOR",155,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CHECK-IN PROCEDURE LIST")
"RTN","MDWOR",156,0)
 F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDKY=$G(MDLST(MDK)) D
"RTN","MDWOR",157,0)
 .I MDHV=+$P(MDKY,"^") S MDANS=MDKY
"RTN","MDWOR",158,0)
 Q MDANS
"RTN","MDWOR",159,0)
GETAPPT(MDDPAT,MDDA) ; Get appointment
"RTN","MDWOR",160,0)
 N DFN,MDALP,MDARES K ^UTILITY("VASD",$J) S DFN=MDDPAT
"RTN","MDWOR",161,0)
 S X1=DT,X2=365 D C^%DTC S VASD("T")=X+.24,VASD("F")=DT,VASD("W")="129",VASD("C",+MDDA)=+MDDA D SDA^VADPT
"RTN","MDWOR",162,0)
 S MDARES=0 F MDALP=0:0 S MDALP=$O(^UTILITY("VASD",$J,MDALP)) Q:MDALP<1  S MDARES=$G(^(MDALP,"I")) Q
"RTN","MDWOR",163,0)
 K ^UTILITY("VASD",$J),VASD,X1,X2,X
"RTN","MDWOR",164,0)
 Q MDARES
"RTN","MDWORSR")
0^13^B59105822^B57541495
"RTN","MDWORSR",1,0)
MDWORSR ; HOIFO/NCA - Daily Schedule Studies;7/2/04  12:39 ;10/15/08  13:39
"RTN","MDWORSR",2,0)
 ;;1.0;CLINICAL PROCEDURES;**14,11,21,20**;Apr 01,2004;Build 9
"RTN","MDWORSR",3,0)
 ; Reference IA# 2263 [Supported] XPAR calls
"RTN","MDWORSR",4,0)
 ;               3067 [Private] Read fields in Consult file (#123) w/FM
"RTN","MDWORSR",5,0)
 ;               3468 [Subscription] Call GMRCCP
"RTN","MDWORSR",6,0)
 ;               3869 [Subscription] SDAMA202 calls
"RTN","MDWORSR",7,0)
 ;               10035 [Supported] Patient File Access
"RTN","MDWORSR",8,0)
 ;               10103 [Supported] XLFDT calls
"RTN","MDWORSR",9,0)
 ;
"RTN","MDWORSR",10,0)
EN1 ; Entry Point to process scheduled studies
"RTN","MDWORSR",11,0)
 N MDACL,MDCON,MDCV,MDERR,MDFDA,MDHOLD,MDKK,MDL,MDL1,MDLSP,MDMAXD,MDNOW,MDSTAT,MDV,MDX,MDXY
"RTN","MDWORSR",12,0)
 S MDMAXD=DT+.24 K ^TMP("MDACLN",$J)
"RTN","MDWORSR",13,0)
 D GETLST^XPAR(.MDLSP,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWORSR",14,0)
 F MDKK=0:0 S MDKK=$O(MDLSP(MDKK)) Q:MDKK<1  S MDV=$P($G(MDLSP(MDKK)),"^",2) I +$P(MDV,";",2)>0 S MDACL=+MDV D
"RTN","MDWORSR",15,0)
 .S ^TMP("MDACLN",$J,+MDACL,+$P(MDV,";",2))=+$P(MDV,";",2)
"RTN","MDWORSR",16,0)
 S MDL=DT F  S MDL=$O(^MDD(702,"ASD",MDL)) Q:MDL<1!(MDL>MDMAXD)  F MDL1=0:0 S MDL1=$O(^MDD(702,"ASD",MDL,MDL1)) Q:MDL1<1  S MDX=$G(^MDD(702,MDL1,0)) D
"RTN","MDWORSR",17,0)
 .K MDFDA
"RTN","MDWORSR",18,0)
 .S MDCON=+$P(MDX,"^",5) Q:'MDCON
"RTN","MDWORSR",19,0)
 .S MDSTAT=$$GET1^DIQ(123,MDCON_",",8,"E")
"RTN","MDWORSR",20,0)
 .Q:MDSTAT="DISCONTINUED"!(MDSTAT="CANCELLED")
"RTN","MDWORSR",21,0)
 .Q:+$P(MDX,"^",9)>0
"RTN","MDWORSR",22,0)
 .S MDIENS=MDL1_",",MDXY=+$P(MDX,"^",4),MDHOLD="" I MDXY D
"RTN","MDWORSR",23,0)
 ..S MDHOLD=$P($G(^MDD(702,+MDL1,0)),"^",7),MDNOW=$$NOW^XLFDT()
"RTN","MDWORSR",24,0)
 ..S $P(^MDD(702,+MDL1,0),"^",7)=MDHOLD
"RTN","MDWORSR",25,0)
 .S MDCV=$P(MDHOLD,";",3)
"RTN","MDWORSR",26,0)
 .I +MDXY&(+MDCV) Q:$G(^TMP("MDACLN",$J,+MDCV,+MDXY))=""
"RTN","MDWORSR",27,0)
 .S MDHL7=$$SUB^MDHL7B(MDL1)
"RTN","MDWORSR",28,0)
 .I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",29,0)
 .I +MDHL7=1 S MDFDA(702,MDIENS,.02)=$$NOW^XLFDT(),MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",30,0)
 .D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",31,0)
 .S MDXY=+$P(MDX,"^",4) Q:'MDXY
"RTN","MDWORSR",32,0)
 .I $P(^MDS(702.01,MDXY,0),U,6)=2 D  Q  ; Renal Check-In
"RTN","MDWORSR",33,0)
 ..D CP^MDKUTL(+MDIENS)
"RTN","MDWORSR",34,0)
 ..S:$G(MDHOLD)'="" MDFDA(702,MDIENS,.07)=MDHOLD
"RTN","MDWORSR",35,0)
 ..S MDFDA(702,MDIENS,.09)=5
"RTN","MDWORSR",36,0)
 ..D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",37,0)
 K ^TMP("MDACLN",$J)
"RTN","MDWORSR",38,0)
 Q
"RTN","MDWORSR",39,0)
CLINICPT ; Check-in CP study with multiple results
"RTN","MDWORSR",40,0)
 N MD,MDCDT,MDCL,MDCOM,MDCON,MDDT,MDDX,MDEND,MDERR,MDFDA,MDHEMO,MDHL7,MDIEN,MDIENS,MDK,MDLP,MDLST,MDMULT,MDNODE,MDNUM,MDPT,MDRET,MDSCHD,MDVSTR,MDY,MDY1,MDYR,X,X1,X2
"RTN","MDWORSR",41,0)
 N MDATYP,MDHOLD,MDLST1,MDLST2,MDNEW,MDT,MDY3,MDY4 S MDDT=DT\1,MDEND=DT+.24 N MDINP K ^TMP($J,"SDAMA202","GETPLIST"),^TMP("MDSTATUS",$J) S MDCOM=0,MDHOLD=""
"RTN","MDWORSR",42,0)
 K ^TMP("MDMULT",$J),^TMP("MDCLINIC",$J),^TMP("MDLST",$J)
"RTN","MDWORSR",43,0)
 S MDNUM=$$GET^XPAR("SYS","MD COMPL PROC DISPLAY DAYS",1)
"RTN","MDWORSR",44,0)
 I +MDNUM>0 S X1=DT,X2=-MDNUM D C^%DTC S MDCOM=X
"RTN","MDWORSR",45,0)
 D GETLST^XPAR(.MDLST,"SYS","MD CLINIC ASSOCIATION")
"RTN","MDWORSR",46,0)
 F MDLP=0:0 S MDLP=$O(^MDD(702,"AS",0,MDLP)) Q:MDLP<1  D
"RTN","MDWORSR",47,0)
 .S MDY=$G(^MDD(702,MDLP,0)) Q:+$P(MDY,"^",9)>0
"RTN","MDWORSR",48,0)
 .Q:$P(MDY,"^",7)'=""
"RTN","MDWORSR",49,0)
 .Q:'+$P(MDY,"^",5)!($P(MDY,"^",6)'="")
"RTN","MDWORSR",50,0)
 .Q:'+MDY
"RTN","MDWORSR",51,0)
 .I '+$G(^TMP("MDSTATUS",$J,+MDY,+$P(MDY,"^",4))) S ^TMP("MDSTATUS",$J,+MDY,+$P(MDY,"^",4))=+MDLP
"RTN","MDWORSR",52,0)
 .Q
"RTN","MDWORSR",53,0)
 ; Combine clinics with multiple procedures to regular clinics
"RTN","MDWORSR",54,0)
 S MDLST2=$S(+MDLST>0:MDLST,1:0)
"RTN","MDWORSR",55,0)
 ; Match new studies with 0 status to appointments
"RTN","MDWORSR",56,0)
 N MDXX K MDY F MDK=0:0 S MDK=$O(MDLST(MDK)) Q:MDK<1  S MDY=$P($G(MDLST(MDK)),"^",2) I +$P(MDY,";",2)>0 S MDCL=+MDY D
"RTN","MDWORSR",57,0)
 .S:$G(^TMP("MDCLINIC",$J,+MDCL))="" ^TMP("MDCLINIC",$J,+MDCL)=+MDCL
"RTN","MDWORSR",58,0)
 .S ^TMP("MDLST",$J,+MDCL,+$P(MDY,";",2))=+$P(MDY,";",2)
"RTN","MDWORSR",59,0)
 .S MDMULT=+$$GET1^DIQ(702.01,+$P(MDY,";",2)_",",.12,"I")
"RTN","MDWORSR",60,0)
 .S MDHEMO=+$$GET1^DIQ(702.01,+$P(MDY,";",2)_",",.06,"I")
"RTN","MDWORSR",61,0)
 .Q:MDMULT'=1&(MDHEMO<2)
"RTN","MDWORSR",62,0)
 .S ^TMP("MDMULT",$J,+MDK)=+MDCL_";"_+$P(MDY,";",2)
"RTN","MDWORSR",63,0)
 .Q
"RTN","MDWORSR",64,0)
 K MDLST,MDY F MDK=0:0 S MDK=$O(^TMP("MDCLINIC",$J,MDK)) Q:MDK<1  S MDY=MDK D
"RTN","MDWORSR",65,0)
 .K ^TMP($J,"SDAMA202","GETPLIST") S MDCL=+MDY
"RTN","MDWORSR",66,0)
 .D GETPLIST^SDAMA202(+MDY,"1;4;3","R",MDDT,MDEND,.MDRET,"")
"RTN","MDWORSR",67,0)
 .F MD=0:0 S MD=$O(^TMP($J,"SDAMA202","GETPLIST",MD)) Q:'MD  D
"RTN","MDWORSR",68,0)
 ..S MDY1=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,4)) Q:MDY1<1
"RTN","MDWORSR",69,0)
 ..S MDSCHD=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,1))
"RTN","MDWORSR",70,0)
 ..S MDATYP=$G(^TMP($J,"SDAMA202","GETPLIST",MD,3)) Q:MDATYP=""
"RTN","MDWORSR",71,0)
 ..Q:"RINT"'[MDATYP
"RTN","MDWORSR",72,0)
 ..S MDT=MDK,MDDX=+$$MATCH(+MDY1,MDT) Q:'MDDX
"RTN","MDWORSR",73,0)
 ..S MDMULT=+$$GET1^DIQ(702,+MDDX,".04:.12","I")
"RTN","MDWORSR",74,0)
 ..S MDHEMO=+$$GET1^DIQ(702,+MDDX,".04:.06","I"),MDIENS=+MDDX_","
"RTN","MDWORSR",75,0)
 ..S MDFDA(702,MDIENS,.02)=$$NOW^XLFDT()
"RTN","MDWORSR",76,0)
 ..S MDFDA(702,MDIENS,.07)="A;"_MDSCHD_";"_MDCL
"RTN","MDWORSR",77,0)
 ..S MDFDA(702,MDIENS,.14)=MDSCHD
"RTN","MDWORSR",78,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR") K MDFDA
"RTN","MDWORSR",79,0)
 ..I MDHEMO=2 S MDHOLD=$P($G(^MDD(702,+MDIENS,0)),"^",7),MDNEW=$$NOW^XLFDT(),$P(^MDD(702,+MDIENS,0),"^",7)=MDSCHD
"RTN","MDWORSR",80,0)
 ..S MDHL7=$$SUB^MDHL7B(+MDIENS)
"RTN","MDWORSR",81,0)
 ..I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",82,0)
 ..I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",83,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",84,0)
 ..Q:'+$G(MDIENS)
"RTN","MDWORSR",85,0)
 ..I MDHEMO=2 D CP^MDKUTL(+MDIENS) S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD S MDFDA(702,+MDIENS_",",.09)=5 D FILE^DIE("","MDFDA","MDERR") K MDFDA
"RTN","MDWORSR",86,0)
 ..Q
"RTN","MDWORSR",87,0)
 .Q
"RTN","MDWORSR",88,0)
 ; Match the rest of appointments with previous studies
"RTN","MDWORSR",89,0)
 N MDGET,MDINST S X1=DT,X2=-365 D C^%DTC S MDCDT=X
"RTN","MDWORSR",90,0)
 K MDY F MDK=0:0 S MDK=$O(^TMP("MDMULT",$J,MDK)) Q:MDK<1  S MDY=$G(^(MDK)) I +$P(MDY,";",2)>0 S MDCL=+MDY D
"RTN","MDWORSR",91,0)
 .K ^TMP($J,"SDAMA202","GETPLIST")
"RTN","MDWORSR",92,0)
 .D GETPLIST^SDAMA202(+MDY,"1;4;3","R",MDDT,MDEND,.MDRET,"")
"RTN","MDWORSR",93,0)
 .F MD=0:0 S MD=$O(^TMP($J,"SDAMA202","GETPLIST",MD)) Q:'MD  D
"RTN","MDWORSR",94,0)
 ..S MDINP=0
"RTN","MDWORSR",95,0)
 ..S MDY1=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,4)) Q:MDY1<1
"RTN","MDWORSR",96,0)
 ..S MDSCHD=+$G(^TMP($J,"SDAMA202","GETPLIST",MD,1))
"RTN","MDWORSR",97,0)
 ..S MDATYP=$G(^TMP($J,"SDAMA202","GETPLIST",MD,3))
"RTN","MDWORSR",98,0)
 ..Q:"RINT"'[MDATYP
"RTN","MDWORSR",99,0)
 ..S MDPT=MDY1 Q:+$$GSTUDY(MDPT,MDSCHD)
"RTN","MDWORSR",100,0)
 ..S MDDX=$$GETC(MDPT,+$P(MDY,";",2)) Q:'+MDDX
"RTN","MDWORSR",101,0)
 ..S MDNODE=$G(^MDD(702,+MDDX,0))
"RTN","MDWORSR",102,0)
 ..S:$G(^DPT(MDY1,.105))'="" MDINP=1
"RTN","MDWORSR",103,0)
 ..S MDCON=$P(MDNODE,"^",5) Q:'MDCON
"RTN","MDWORSR",104,0)
 ..S MDVSTR=$P(MDNODE,"^",7) Q:MDVSTR=""
"RTN","MDWORSR",105,0)
 ..S MDMULT=+$$GET1^DIQ(702,+MDDX,".04:.12","I")
"RTN","MDWORSR",106,0)
 ..S MDHEMO=+$$GET1^DIQ(702,+MDDX,".04:.06","I")
"RTN","MDWORSR",107,0)
 ..S MDYR=$S(MDMULT<1:MDCOM,1:MDCDT)
"RTN","MDWORSR",108,0)
 ..Q:$P(MDNODE,"^",2)<MDYR
"RTN","MDWORSR",109,0)
 ..Q:'$P(MDNODE,"^",9)
"RTN","MDWORSR",110,0)
 ..Q:$P(MDNODE,"^",9)>3
"RTN","MDWORSR",111,0)
 ..Q:$P(MDVSTR,";",2)=MDSCHD
"RTN","MDWORSR",112,0)
 ..S MDINST=+$$GINST(+$P(MDNODE,"^",4)) Q:'MDINST
"RTN","MDWORSR",113,0)
 ..K MDFDA,MDERR,MDIEN
"RTN","MDWORSR",114,0)
 ..S MDFDA(702,"+1,",.01)=MDY1
"RTN","MDWORSR",115,0)
 ..S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWORSR",116,0)
 ..S MDFDA(702,"+1,",.03)=$P(MDNODE,"^",3)
"RTN","MDWORSR",117,0)
 ..S MDFDA(702,"+1,",.04)=$P(MDNODE,"^",4)
"RTN","MDWORSR",118,0)
 ..S MDFDA(702,"+1,",.05)=MDCON
"RTN","MDWORSR",119,0)
 ..S MDFDA(702,"+1,",.07)="A;"_MDSCHD_";"_MDCL
"RTN","MDWORSR",120,0)
 ..S MDFDA(702,"+1,",.11)=+MDINST
"RTN","MDWORSR",121,0)
 ..S MDFDA(702,"+1,",.14)=MDSCHD
"RTN","MDWORSR",122,0)
 ..D UPDATE^DIE("","MDFDA","MDIEN","MDERR") Q:$D(MDERR)  K MDFDA
"RTN","MDWORSR",123,0)
 ..S MDIENS=MDIEN(1)_"," I MDHEMO=2 S MDHOLD=$P($G(^MDD(702,MDIEN(1),0)),"^",7),MDNOW=$$NOW^XLFDT(),$P(^MDD(702,MDIEN(1),0),"^",7)=MDSCHD
"RTN","MDWORSR",124,0)
 ..S MDHL7=$$SUB^MDHL7B(MDIEN(1))
"RTN","MDWORSR",125,0)
 ..I +MDHL7=-1 S MDFDA(702,MDIENS,.09)=2,MDFDA(702,MDIENS,.08)=$P(MDHL7,U,2)
"RTN","MDWORSR",126,0)
 ..I +MDHL7=1 S MDFDA(702,MDIENS,.09)=5,MDFDA(702,MDIENS,.08)=""
"RTN","MDWORSR",127,0)
 ..D:$D(MDFDA) FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",128,0)
 ..Q:'+$G(MDIENS)
"RTN","MDWORSR",129,0)
 ..I MDHEMO=2 D CP^MDKUTL(+MDIENS) K MDFDA S:$G(MDHOLD)'="" MDFDA(702,+MDIENS_",",.07)=MDHOLD S MDFDA(702,+MDIENS_",",.09)=5 D FILE^DIE("","MDFDA","MDERR")
"RTN","MDWORSR",130,0)
 K ^TMP($J,"SDAMA202","GETPLIST"),^TMP("MDSTATUS",$J),MDFDA
"RTN","MDWORSR",131,0)
 K ^TMP("MDCLINIC",$J),^TMP("MDMULT",$J),^TMP("MDLST",$J)
"RTN","MDWORSR",132,0)
 Q
"RTN","MDWORSR",133,0)
GETC(MDPAT,MDDA) ; Get consult date
"RTN","MDWORSR",134,0)
 N MDX,MDCF S MDCF=0 K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,+MDDA,$NA(^TMP("MDTMP",$J)))
"RTN","MDWORSR",135,0)
 S MDX=$O(^TMP("MDTMP",$J,""),-1) Q:'+MDX 0
"RTN","MDWORSR",136,0)
 I "saprc"'[$P($G(^TMP("MDTMP",$J,MDX)),U,4) S MDX=$O(^TMP("MDTMP",$J,MDX),-1) Q:'+MDX 0
"RTN","MDWORSR",137,0)
 I "saprc"[$P($G(^TMP("MDTMP",$J,MDX)),U,4) S MDCF=$P($G(^TMP("MDTMP",$J,MDX)),U,5)_"^"_$P($G(^TMP("MDTMP",$J,MDX)),U,1)
"RTN","MDWORSR",138,0)
 K ^TMP("MDTMP",$J)
"RTN","MDWORSR",139,0)
 Q $S(+MDCF:+$O(^MDD(702,"ACON",+MDCF,""),-1)_"^"_$P(MDCF,"^",2)_"^"_+MDCF_"^"_$P(MDCF,"^",6),1:0)
"RTN","MDWORSR",140,0)
GINST(MDDA) ; Get instrument from CP Definition
"RTN","MDWORSR",141,0)
 N MDIN,MDINT,Y1 S (MDINT,Y1)=0
"RTN","MDWORSR",142,0)
 F MDIN=0:0 S MDIN=$O(^MDS(702.01,+MDDA,.1,MDIN)) Q:MDIN<1!(+Y1)  S MDINT=+$G(^(MDIN,0)) I +$$GET1^DIQ(702.09,MDINT,".13","I") S Y1=MDINT
"RTN","MDWORSR",143,0)
 Q Y1
"RTN","MDWORSR",144,0)
GSTUDY(MDPAT,MDDA) ;Get study for scheduled date/time
"RTN","MDWORSR",145,0)
 N MDIN,Y1 S Y1=0
"RTN","MDWORSR",146,0)
 F MDIN=0:0 S MDIN=$O(^MDD(702,"ASD",MDDA,MDIN)) Q:MDIN<1!(Y1>0)  D
"RTN","MDWORSR",147,0)
 .S:$P($G(^MDD(702,MDIN,0)),"^")=MDPAT Y1=1
"RTN","MDWORSR",148,0)
 Q Y1
"RTN","MDWORSR",149,0)
GPRO(MDPAT,MDCLIN) ; Get procedure for study
"RTN","MDWORSR",150,0)
 N MDX,MDCF,MDCFX S MDCF="" K ^TMP("MDTMP",$J) D CPLIST^GMRCCP(MDPAT,,$NA(^TMP("MDTMP",$J)))
"RTN","MDWORSR",151,0)
 S MDX=0 F  S MDX=$O(^TMP("MDTMP",$J,MDX)) Q:'MDX!(MDCF'="")  D:"sap"[$P(^(MDX),U,4)
"RTN","MDWORSR",152,0)
 .S MDCFX=$G(^TMP("MDTMP",$J,MDX)) Q:'+$G(^TMP("MDLST",$J,MDCLIN,+$P(MDCFX,"^",6)))
"RTN","MDWORSR",153,0)
 .Q:+$O(^MDD(702,"ACON",+$P(MDCFX,"^",5),0))  S MDCF=MDCFX Q
"RTN","MDWORSR",154,0)
 K ^TMP("MDTMP",$J)
"RTN","MDWORSR",155,0)
 Q $S(MDCF'="":MDCF,1:0)
"RTN","MDWORSR",156,0)
MATCH(MDPAT,MDCLIN) ; Match study to appointment
"RTN","MDWORSR",157,0)
 N MDI,MDY2 S MDY2=0
"RTN","MDWORSR",158,0)
 F MDI=0:0 S MDI=$O(^TMP("MDSTATUS",$J,MDPAT,MDI)) Q:MDI<1!(+MDY2)  D
"RTN","MDWORSR",159,0)
 .I +$G(^TMP("MDLST",$J,MDCLIN,MDI)) S MDY2=+$G(^TMP("MDSTATUS",$J,MDPAT,MDI))
"RTN","MDWORSR",160,0)
 Q MDY2
"RTN","MDWORSR",161,0)
ADD(MDPAT,MDY3,MDY4,MDCLIN,MDSC) ; Add study, if none exist
"RTN","MDWORSR",162,0)
 N MDFDA,MDERR,MDIENS,MDP,MDPS
"RTN","MDWORSR",163,0)
 Q:'MDY3
"RTN","MDWORSR",164,0)
 K MDFDA,MDERR,MDIENN
"RTN","MDWORSR",165,0)
 S MDP=$O(^MDD(702,"B",MDPAT,0)),MDPS=$G(^MDD(702,+MDP,0))
"RTN","MDWORSR",166,0)
 S MDFDA(702,"+1,",.01)=MDPAT
"RTN","MDWORSR",167,0)
 S MDFDA(702,"+1,",.02)=$$NOW^XLFDT()
"RTN","MDWORSR",168,0)
 S MDFDA(702,"+1,",.03)=$S(+$P(MDPS,"^",3):$P(MDPS,"^",3),1:DUZ)
"RTN","MDWORSR",169,0)
 S MDFDA(702,"+1,",.04)=+MDY3
"RTN","MDWORSR",170,0)
 S MDFDA(702,"+1,",.05)=+MDY4
"RTN","MDWORSR",171,0)
 S MDFDA(702,"+1,",.07)="A;"_MDSC_";"_MDCLIN
"RTN","MDWORSR",172,0)
 S MDFDA(702,"+1,",.11)=+$$GINST(+MDY3)
"RTN","MDWORSR",173,0)
 D UPDATE^DIE("","MDFDA","MDIENN","MDERR") Q:$D(MDERR) 0
"RTN","MDWORSR",174,0)
 K MDFDA
"RTN","MDWORSR",175,0)
 Q MDIENN(1)
"VER")
8.0^22.0
"BLD",7229,6)
^15
**END**
**END**

Released PSO*7*292 SEQ #249
Extracted from mail message
**KIDS**:PSO*7.0*292^

**INSTALL NAME**
PSO*7.0*292
"BLD",6606,0)
PSO*7.0*292^OUTPATIENT PHARMACY^0^3071106^y
"BLD",6606,1,0)
^^26^26^3071106^
"BLD",6606,1,1,0)
PROBLEM:
"BLD",6606,1,2,0)
--------
"BLD",6606,1,3,0)
HD214867 - Renewed orders remaining active
"BLD",6606,1,4,0)
 
"BLD",6606,1,5,0)
 
"BLD",6606,1,6,0)
PSI-06-177 - RENEWED ORDERS REMAINING ACTIVE
"BLD",6606,1,7,0)
(Note: Other scenarios related to renewed orders are being corrected in
"BLD",6606,1,8,0)
patch PSO*7*257).
"BLD",6606,1,9,0)
 
"BLD",6606,1,10,0)
1. If expiring or discontinuing a prescription that also has a pending
"BLD",6606,1,11,0)
renewal, the "renewed from" CPRS order's status is changed to expired or
"BLD",6606,1,12,0)
discontinued instead of staying as "renewed".
"BLD",6606,1,13,0)
 
"BLD",6606,1,14,0)
2. If cancel a pending renewal for a previously expired (or 
"BLD",6606,1,15,0)
discontinued) prescription that had been renewed after expired, the 
"BLD",6606,1,16,0)
"renewed from" CPRS order should go back to "expired" (or "discontinued")
"BLD",6606,1,17,0)
instead of remaining as "renewed".
"BLD",6606,1,18,0)
 
"BLD",6606,1,19,0)
RESOLUTION:
"BLD",6606,1,20,0)
-----------
"BLD",6606,1,21,0)
1. PSOHLSN1 - If  expiring or discontinuing a prescription that also has a
"BLD",6606,1,22,0)
pending renewal, keep the "renewed from" CPRS order's status as "renewed".
"BLD",6606,1,23,0)
 
"BLD",6606,1,24,0)
2. PSOHLSN: - If cancel a pending renewal for a previously expired (or 
"BLD",6606,1,25,0)
discontinued) prescription that had been renewed after expired (or 
"BLD",6606,1,26,0)
discontinued), set CPRS order's status back to expired (or discontinued).
"BLD",6606,4,0)
^9.64PA^^
"BLD",6606,6.3)
1
"BLD",6606,"ABPKG")
n
"BLD",6606,"KRN",0)
^9.67PA^8989.52^19
"BLD",6606,"KRN",.4,0)
.4
"BLD",6606,"KRN",.401,0)
.401
"BLD",6606,"KRN",.402,0)
.402
"BLD",6606,"KRN",.403,0)
.403
"BLD",6606,"KRN",.5,0)
.5
"BLD",6606,"KRN",.84,0)
.84
"BLD",6606,"KRN",3.6,0)
3.6
"BLD",6606,"KRN",3.8,0)
3.8
"BLD",6606,"KRN",9.2,0)
9.2
"BLD",6606,"KRN",9.8,0)
9.8
"BLD",6606,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",6606,"KRN",9.8,"NM",1,0)
PSOHLSN^^0^B60821675
"BLD",6606,"KRN",9.8,"NM",2,0)
PSOHLSN1^^0^B82545457
"BLD",6606,"KRN",9.8,"NM","B","PSOHLSN",1)

"BLD",6606,"KRN",9.8,"NM","B","PSOHLSN1",2)

"BLD",6606,"KRN",19,0)
19
"BLD",6606,"KRN",19.1,0)
19.1
"BLD",6606,"KRN",101,0)
101
"BLD",6606,"KRN",409.61,0)
409.61
"BLD",6606,"KRN",771,0)
771
"BLD",6606,"KRN",870,0)
870
"BLD",6606,"KRN",8989.51,0)
8989.51
"BLD",6606,"KRN",8989.52,0)
8989.52
"BLD",6606,"KRN",8994,0)
8994
"BLD",6606,"KRN","B",.4,.4)

"BLD",6606,"KRN","B",.401,.401)

"BLD",6606,"KRN","B",.402,.402)

"BLD",6606,"KRN","B",.403,.403)

"BLD",6606,"KRN","B",.5,.5)

"BLD",6606,"KRN","B",.84,.84)

"BLD",6606,"KRN","B",3.6,3.6)

"BLD",6606,"KRN","B",3.8,3.8)

"BLD",6606,"KRN","B",9.2,9.2)

"BLD",6606,"KRN","B",9.8,9.8)

"BLD",6606,"KRN","B",19,19)

"BLD",6606,"KRN","B",19.1,19.1)

"BLD",6606,"KRN","B",101,101)

"BLD",6606,"KRN","B",409.61,409.61)

"BLD",6606,"KRN","B",771,771)

"BLD",6606,"KRN","B",870,870)

"BLD",6606,"KRN","B",8989.51,8989.51)

"BLD",6606,"KRN","B",8989.52,8989.52)

"BLD",6606,"KRN","B",8994,8994)

"BLD",6606,"QUES",0)
^9.62^^
"BLD",6606,"REQB",0)
^9.611^1^1
"BLD",6606,"REQB",1,0)
PSO*7.0*239^2
"BLD",6606,"REQB","B","PSO*7.0*239",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
292^3071106
"PKG",141,22,1,"PAH",1,1,0)
^^26^26^3071106
"PKG",141,22,1,"PAH",1,1,1,0)
PROBLEM:
"PKG",141,22,1,"PAH",1,1,2,0)
--------
"PKG",141,22,1,"PAH",1,1,3,0)
HD214867 - Renewed orders remaining active
"PKG",141,22,1,"PAH",1,1,4,0)
 
"PKG",141,22,1,"PAH",1,1,5,0)
 
"PKG",141,22,1,"PAH",1,1,6,0)
PSI-06-177 - RENEWED ORDERS REMAINING ACTIVE
"PKG",141,22,1,"PAH",1,1,7,0)
(Note: Other scenarios related to renewed orders are being corrected in
"PKG",141,22,1,"PAH",1,1,8,0)
patch PSO*7*257).
"PKG",141,22,1,"PAH",1,1,9,0)
 
"PKG",141,22,1,"PAH",1,1,10,0)
1. If expiring or discontinuing a prescription that also has a pending
"PKG",141,22,1,"PAH",1,1,11,0)
renewal, the "renewed from" CPRS order's status is changed to expired or
"PKG",141,22,1,"PAH",1,1,12,0)
discontinued instead of staying as "renewed".
"PKG",141,22,1,"PAH",1,1,13,0)
 
"PKG",141,22,1,"PAH",1,1,14,0)
2. If cancel a pending renewal for a previously expired (or 
"PKG",141,22,1,"PAH",1,1,15,0)
discontinued) prescription that had been renewed after expired, the 
"PKG",141,22,1,"PAH",1,1,16,0)
"renewed from" CPRS order should go back to "expired" (or "discontinued")
"PKG",141,22,1,"PAH",1,1,17,0)
instead of remaining as "renewed".
"PKG",141,22,1,"PAH",1,1,18,0)
 
"PKG",141,22,1,"PAH",1,1,19,0)
RESOLUTION:
"PKG",141,22,1,"PAH",1,1,20,0)
-----------
"PKG",141,22,1,"PAH",1,1,21,0)
1. PSOHLSN1 - If  expiring or discontinuing a prescription that also has a
"PKG",141,22,1,"PAH",1,1,22,0)
pending renewal, keep the "renewed from" CPRS order's status as "renewed".
"PKG",141,22,1,"PAH",1,1,23,0)
 
"PKG",141,22,1,"PAH",1,1,24,0)
2. PSOHLSN: - If cancel a pending renewal for a previously expired (or 
"PKG",141,22,1,"PAH",1,1,25,0)
discontinued) prescription that had been renewed after expired (or 
"PKG",141,22,1,"PAH",1,1,26,0)
discontinued), set CPRS order's status back to expired (or discontinued).
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOHLSN")
0^1^B60821675^B58728067
"RTN","PSOHLSN",1,0)
PSOHLSN ;BIR/RTR-Send order information to OERR from file 52.41 ;10/10/94
"RTN","PSOHLSN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,7,15,24,27,30,55,46,98,88,121,292**;DEC 1997;Build 1
"RTN","PSOHLSN",3,0)
 ;Externel reference EN^ORERR supported by DBIA 2187
"RTN","PSOHLSN",4,0)
 ;
"RTN","PSOHLSN",5,0)
 ; PS EVSEND OR PROTOCOL MUST BE OUR DRIVER RTN, (52 OR 52.41 INDICATOR
"RTN","PSOHLSN",6,0)
 ; IS SENT THERE, THEN IT ROUTES, (NO NEED TO SEND FILE NUMBER HERE)
"RTN","PSOHLSN",7,0)
EN(PLACER,STAT,COMM,PSNOO) ;
"RTN","PSOHLSN",8,0)
 N DA,FIELD,J,JJ,MSG,LIMIT,NULLFLDS,PSIEN,PSOHINST,PSZERO,SEGMENT,NAME,DFN,COUNT,GG,CC,CT,MM,PVAR,PVAR1,PLIM,SEG1,SUBCOUNT,PSOPSTRT,PSOPSTOP,PSODFN,EDUZ,PSNOOTX,PSOHSTAT,PSOPSIEN
"RTN","PSOHLSN",9,0)
 S (PSIEN,PSOPSIEN)=$O(^PS(52.41,"B",PLACER,0))
"RTN","PSOHLSN",10,0)
 S COUNT=0
"RTN","PSOHLSN",11,0)
 ;I '$G(PSIEN) W !!,?5,"PROBLEM WITH ENTRY IN PENDING FILE!",! Q
"RTN","PSOHLSN",12,0)
 I '$G(PSIEN) Q
"RTN","PSOHLSN",13,0)
 I $G(STAT)="OC"!($G(STAT)="OD")!($G(STAT)="CR")!($G(STAT)="DR") D
"RTN","PSOHLSN",14,0)
 .D CHKOLDRX
"RTN","PSOHLSN",15,0)
 .I $D(^PS(52.41,PSIEN,0)) K ^PS(52.41,"AD",$P(^PS(52.41,PSIEN,0),"^",12),+$P($G(^("INI")),"^"),PSIEN),^PS(52.41,"ACL",+$P(^PS(52.41,PSIEN,0),"^",13),+$P(^(0),"^",12),PSIEN),^PS(52.41,"AQ",+$P($G(^PS(52.41,PSIEN,0)),"^",21),PSIEN)
"RTN","PSOHLSN",16,0)
 S PSZERO=$G(^PS(52.41,PSIEN,0)),PSOHSTAT=$G(STAT)
"RTN","PSOHLSN",17,0)
 S NULLFLDS="F JJ=0:1:LIMIT S FIELD(JJ)="""""
"RTN","PSOHLSN",18,0)
 D INIT
"RTN","PSOHLSN",19,0)
 I $G(STAT)="Z@" S COUNT=1 D PID,PV1,ORC,SEND Q
"RTN","PSOHLSN",20,0)
 S COUNT=1 D PID,PV1,ORC,RXE,ZRX,SEND,REN Q
"RTN","PSOHLSN",21,0)
INIT K ^UTILITY("DIQ1",$J),DIQ S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOHINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIQ,DIC
"RTN","PSOHLSN",22,0)
 S MSG(1)="MSH|^~\&|PHARMACY|"_$G(PSOHINST)_"|||||"_$S($G(PSOMSORR):"ORR",1:"ORM")
"RTN","PSOHLSN",23,0)
 Q
"RTN","PSOHLSN",24,0)
PID S LIMIT=5 X NULLFLDS
"RTN","PSOHLSN",25,0)
 S FIELD(0)="PID"
"RTN","PSOHLSN",26,0)
 S DFN=+$P(PSZERO,"^",2) D DEM^VADPT S NAME=$G(VADM(1)) K VADM
"RTN","PSOHLSN",27,0)
 S FIELD(3)=DFN
"RTN","PSOHLSN",28,0)
 S FIELD(5)=NAME
"RTN","PSOHLSN",29,0)
 D SEG Q
"RTN","PSOHLSN",30,0)
PV1 S LIMIT=19 X NULLFLDS
"RTN","PSOHLSN",31,0)
 S FIELD(0)="PV1"
"RTN","PSOHLSN",32,0)
 S FIELD(2)="O"
"RTN","PSOHLSN",33,0)
 S:$P($G(^PS(52.41,PSIEN,0)),"^",13) FIELD(3)=$P(^(0),"^",13)
"RTN","PSOHLSN",34,0)
 D SEG Q
"RTN","PSOHLSN",35,0)
ORC S LIMIT=15 X NULLFLDS
"RTN","PSOHLSN",36,0)
 S FIELD(0)="ORC"
"RTN","PSOHLSN",37,0)
 S FIELD(1)=STAT
"RTN","PSOHLSN",38,0)
 S FIELD(2)=PLACER_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"
"RTN","PSOHLSN",39,0)
 S FIELD(3)=PSIEN_"S"_"^PS"
"RTN","PSOHLSN",40,0)
 I $G(FIELD(5))="" I $G(STAT)="OR"!($G(STAT)="OE") S FIELD(5)="IP"
"RTN","PSOHLSN",41,0)
 S:$G(COMM)="IP" FIELD(5)="IP"
"RTN","PSOHLSN",42,0)
 I $G(STAT)="SC" S FIELD(5)=$S($G(COMM)="IP":"IP",$G(COMM)="HD":"HD",$G(COMM)="DC":"DC",1:"")
"RTN","PSOHLSN",43,0)
 I $G(PSORPV),$G(STAT)="OC" S FIELD(5)="RP"
"RTN","PSOHLSN",44,0)
 ;S (PSOPSTRT,PSOPSTOP)="" S X=$P($G(^PS(52.41,PSIEN,0)),"^",6) I X S PSOPSTRT=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN",45,0)
 ;I $G(STAT)="CR"!($G(STAT)="OC") D:'$G(DT)  S X=DT S PSOPSTOP=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN",46,0)
 ;.S DT=$$DT^XLFDT
"RTN","PSOHLSN",47,0)
 ;K X S FIELD(7)="^^^"_$G(PSOPSTRT)_"^"_$G(PSOPSTOP)
"RTN","PSOHLSN",48,0)
 S EDUZ=$P($G(^PS(52.41,PSIEN,0)),"^",4) I EDUZ D USER^PSOORFI2(EDUZ) S FIELD(10)=EDUZ_"^"_USER1 K USER1
"RTN","PSOHLSN",49,0)
 I $G(PSOCANRC),$G(PSOCANRN)'="" I $G(STAT)="OC"!($G(STAT)="OD") S FIELD(12)=$G(PSOCANRC)_"^"_$G(PSOCANRN)
"RTN","PSOHLSN",50,0)
 I '$G(FIELD(12)) D USER^PSOORFI2($P(^PS(52.41,PSIEN,0),"^",5))
"RTN","PSOHLSN",51,0)
 I '$G(FIELD(12)) S FIELD(12)=$P(^PS(52.41,PSIEN,0),"^",5)_"^"_USER1 K USER1
"RTN","PSOHLSN",52,0)
 S FIELD(15)=$G(PSOPSTRT)
"RTN","PSOHLSN",53,0)
 D SEG
"RTN","PSOHLSN",54,0)
 I $G(COMM)'=""!($G(PSNOO)'="") D
"RTN","PSOHLSN",55,0)
 .I $G(PSNOO)="" I $G(COMM)="IP"!($G(COMM)="HD")!($G(COMM)="DC") Q
"RTN","PSOHLSN",56,0)
 .I $G(PSNOO)'="" D NOO^PSOHLSN1
"RTN","PSOHLSN",57,0)
 .I '$D(COMM) S COMM=""
"RTN","PSOHLSN",58,0)
 .I $L($G(COMM))+($L(MSG(COUNT)))+($L($G(PSNOOTX)))+($S($G(PSNOO)'="":11,1:5))<245 S MSG(COUNT)=MSG(COUNT)_"|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$S(COMM="IP"!(COMM="DC")!(COMM="HD"):"",1:$G(COMM))_"^" Q
"RTN","PSOHLSN",59,0)
 .S MSG(COUNT,1)="|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$S(COMM="IP"!(COMM="DC")!(COMM="HD"):"",1:$G(COMM))_"^" Q
"RTN","PSOHLSN",60,0)
 Q
"RTN","PSOHLSN",61,0)
RXE S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN",62,0)
 S FIELD(0)="RXE"
"RTN","PSOHLSN",63,0)
 S (PSOPSTRT,PSOPSTOP)="" S X=$P($G(^PS(52.41,PSIEN,0)),"^",6) I X S PSOPSTRT=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN",64,0)
 I $G(STAT)="CR"!($G(STAT)="OC") D:'$G(DT)  S X=DT S PSOPSTOP=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN",65,0)
 .S DT=$$DT^XLFDT
"RTN","PSOHLSN",66,0)
 K X S FIELD(1)="^^^"_$G(PSOPSTRT)_"^"_$G(PSOPSTOP)
"RTN","PSOHLSN",67,0)
 D SEG Q
"RTN","PSOHLSN",68,0)
 ;
"RTN","PSOHLSN",69,0)
ZRX ;
"RTN","PSOHLSN",70,0)
 ;Only send if DC is from an external system
"RTN","PSOHLSN",71,0)
 I $G(STAT)'="OC",$G(STAT)'="OD" Q
"RTN","PSOHLSN",72,0)
 I '$G(PSOHUIOR)!('$G(PSOCANRC)) Q
"RTN","PSOHLSN",73,0)
 I $P($G(^PS(52.41,PSIEN,"EXT")),"^")="" Q
"RTN","PSOHLSN",74,0)
 S LIMIT=5 X NULLFLDS
"RTN","PSOHLSN",75,0)
 S FIELD(0)="ZRX"
"RTN","PSOHLSN",76,0)
 S FIELD(5)=PSOCANRC_"^"_$P($G(^VA(200,PSOCANRC,0)),"^")_"^"_"99NP"
"RTN","PSOHLSN",77,0)
 D SEG
"RTN","PSOHLSN",78,0)
 Q
"RTN","PSOHLSN",79,0)
 ;
"RTN","PSOHLSN",80,0)
SEG S SEGMENT="" F J=0:1:LIMIT S SEGMENT=$S(SEGMENT="":FIELD(J),1:SEGMENT_"|"_FIELD(J))
"RTN","PSOHLSN",81,0)
 S COUNT=COUNT+1,MSG(COUNT)=SEGMENT
"RTN","PSOHLSN",82,0)
 Q
"RTN","PSOHLSN",83,0)
SEND D MSG^XQOR("PS EVSEND OR",.MSG)
"RTN","PSOHLSN",84,0)
 Q
"RTN","PSOHLSN",85,0)
 ;
"RTN","PSOHLSN",86,0)
SEGPAR ;Parse out fields for sending segments to OERR that can be >245
"RTN","PSOHLSN",87,0)
 K PSOFIELD
"RTN","PSOHLSN",88,0)
 S COUNT=COUNT+1,CT=1,(PVAR,PVAR1)=""
"RTN","PSOHLSN",89,0)
 F MM=0:1:LIMIT S FIELD(MM)=$S(FIELD(MM)="":"|",1:FIELD(MM)_"|")
"RTN","PSOHLSN",90,0)
 I $L(FIELD(LIMIT))>1 S FIELD(LIMIT)=$E(FIELD(LIMIT),1,($L(FIELD(LIMIT))-1))
"RTN","PSOHLSN",91,0)
 F MM=0:1:LIMIT S SEG1=FIELD(MM) F CC=1:1:$L(SEG1) D  I $L(PVAR)=245 S PSOFIELD(CT)=PVAR,CT=CT+1,PVAR=""
"RTN","PSOHLSN",92,0)
 .S PVAR1=$E(SEG1,CC)
"RTN","PSOHLSN",93,0)
 .S PLIM=PVAR
"RTN","PSOHLSN",94,0)
 .S PVAR=$S(PVAR="":PVAR1,1:PVAR_PVAR1)
"RTN","PSOHLSN",95,0)
 I $G(PVAR)'="" S PSOFIELD(CT)=PVAR
"RTN","PSOHLSN",96,0)
 S MSG(COUNT)=PSOFIELD(1),SUBCOUNT=1 F GG=2:1 Q:'$D(PSOFIELD(GG))  S MSG(COUNT,SUBCOUNT)=PSOFIELD(GG),SUBCOUNT=SUBCOUNT+1
"RTN","PSOHLSN",97,0)
 K PSOFIELD
"RTN","PSOHLSN",98,0)
 Q
"RTN","PSOHLSN",99,0)
ERROR ;Builds error message from PSOHLNEW, usually means we can't find order
"RTN","PSOHLSN",100,0)
 D EN^ORERR(COMM,.MSG)
"RTN","PSOHLSN",101,0)
 N MSG,PSOHINST
"RTN","PSOHLSN",102,0)
 S PSOMSORR=1 D INIT
"RTN","PSOHLSN",103,0)
 S MSG(2)=$G(PSERRPID)
"RTN","PSOHLSN",104,0)
 S MSG(3)=$G(PSERRPV1)
"RTN","PSOHLSN",105,0)
 S MSG(4)="ORC|"_$S($G(STAT)'="":$G(STAT),1:"DE")_"|"_PLACER_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"_"|"_$S($P($G(PSERRORC),"|",4)'="":$P(PSERRORC,"|",4),1:"")
"RTN","PSOHLSN",106,0)
 F EER=11,13 I $P($G(PSERRORC),"|",EER)'="" S $P(MSG(4),"|",EER)=$P($G(PSERRORC),"|",EER)
"RTN","PSOHLSN",107,0)
 I $G(COMM)'="" S $P(MSG(4),"|",17)="^^^^"_$G(COMM)
"RTN","PSOHLSN",108,0)
 D SEND K PSOMSORR Q
"RTN","PSOHLSN",109,0)
 ;
"RTN","PSOHLSN",110,0)
RERROR ;
"RTN","PSOHLSN",111,0)
 F EER=0:0 S EER=$O(MSG(EER)) Q:'EER  S:$P(MSG(EER),"|")="PV1" PSERRPV1=MSG(EER) S:$P(MSG(EER),"|")="PID" PSERRPID=MSG(EER) S:$P(MSG(EER),"|")="ORC"&($G(PSERRORC)="") PSERRORC=MSG(EER)
"RTN","PSOHLSN",112,0)
 N MSG
"RTN","PSOHLSN",113,0)
 S PSOMSORR=1 D INIT
"RTN","PSOHLSN",114,0)
 S MSG(2)=$G(PSERRPID),MSG(3)=$G(PSERRPV1)
"RTN","PSOHLSN",115,0)
 S MSG(4)="ORC|"_$S($G(XOFLAGZ):"UX",1:"UA")_"|"_$G(PLACER)_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"_"|"_$S($P($G(PSERRORC),"|",4)'="":$P(PSERRORC,"|",4),1:"")
"RTN","PSOHLSN",116,0)
 F EER=11,13 I $P($G(PSERRORC),"|",EER)'="" S $P(MSG(4),"|",EER)=$P($G(PSERRORC),"|",EER)
"RTN","PSOHLSN",117,0)
 S $P(MSG(4),"|",17)="D^Duplicate^99ORN^^"_$S($G(XOFLAGZ):"Patient mismatch on previous order.",$G(NWFLAG):"Patient Mismatch on new CPRS order",$G(PSOXRP):"Patient mismatch on Renewal.",1:"Duplicate Renewal Request. Order rejected by Pharmacy.")
"RTN","PSOHLSN",118,0)
 I $G(PSOCVI) S $P(MSG(4),"|",17)="D^Duplicate^99ORN^^Order mismatch on Renewal."
"RTN","PSOHLSN",119,0)
 D SEND K PSOMSORR Q
"RTN","PSOHLSN",120,0)
 ;
"RTN","PSOHLSN",121,0)
DCP ;
"RTN","PSOHLSN",122,0)
 K ^PS(52.41,"AOR",+$G(DFN),+$P($G(^PS(52.41,+$G(PREV),"INI")),"^"),+$G(PREV)) S $P(^PS(52.41,+$G(PREV),0),"^",3)="DE"
"RTN","PSOHLSN",123,0)
 S PSORPV=1 N PSOMSORR
"RTN","PSOHLSN",124,0)
 D EN^PSOHLSN(+$P($G(^PS(52.41,+$G(PREV),0)),"^"),"OC","","A")
"RTN","PSOHLSN",125,0)
 K PSORPV
"RTN","PSOHLSN",126,0)
 Q
"RTN","PSOHLSN",127,0)
REN ;Update previous Rx on Cancel/Discontinue
"RTN","PSOHLSN",128,0)
 N RPREV,RENOC,RENOCP,RENSTA,PSOMSORR
"RTN","PSOHLSN",129,0)
 I $G(PSOHSTAT)'="OC",$G(PSOHSTAT)'="CR",$G(PSOHSTAT)'="DR",$G(PSOHSTAT)'="OD" Q
"RTN","PSOHLSN",130,0)
 Q:'$D(^PS(52.41,+$G(PSOPSIEN),0))
"RTN","PSOHLSN",131,0)
 S RPREV=$P($G(^PS(52.41,+$G(PSOPSIEN),0)),"^",21) Q:'$G(RPREV)!('$D(^PSRX(+$G(RPREV),0)))
"RTN","PSOHLSN",132,0)
 S RENSTA=$P($G(^PSRX(+$G(RPREV),"STA")),"^") Q:$G(RENSTA)=""
"RTN","PSOHLSN",133,0)
 S RENOC="SC",RENOCP=$S(RENSTA=0:"CM",(RENSTA=1!(RENSTA=4)):"IP",(RENSTA=3!(RENSTA=16)):"HD",RENSTA=5:"ZS",RENSTA=11:"ZE",RENSTA=15:"RP",1:"DC")
"RTN","PSOHLSN",134,0)
 D EN^PSOHLSN1(RPREV,RENOC,RENOCP,"","")
"RTN","PSOHLSN",135,0)
 Q
"RTN","PSOHLSN",136,0)
 ;
"RTN","PSOHLSN",137,0)
DELP ;Delete refill requests
"RTN","PSOHLSN",138,0)
 I $G(PSODEATH) Q
"RTN","PSOHLSN",139,0)
 N DA,PENDDA
"RTN","PSOHLSN",140,0)
 S PENDDA=$P($G(^PSRX(+$G(PSRXIEN),"OR1")),"^",2) I 'PENDDA Q
"RTN","PSOHLSN",141,0)
 S DA=$O(^PS(52.41,"B",PENDDA,0)) I '$G(DA) Q
"RTN","PSOHLSN",142,0)
 I $P($G(^PS(52.41,DA,0)),"^",3)="RF" S DIK="^PS(52.41," D ^DIK K DIK
"RTN","PSOHLSN",143,0)
 Q
"RTN","PSOHLSN",144,0)
SEGPARX ;
"RTN","PSOHLSN",145,0)
 N PSOFIELD
"RTN","PSOHLSN",146,0)
 S COUNT=COUNT+1,CT=1,(PVAR,PVAR1)=""
"RTN","PSOHLSN",147,0)
 F MM=0:1:LIMIT I MM'=1 S FIELD(MM)=$S(FIELD(MM)="":"|",1:FIELD(MM)_"|")
"RTN","PSOHLSN",148,0)
 F MM=0:0 S MM=$O(FIELD(1,MM)) I '$O(FIELD(1,MM)) S FIELD(1,MM)=$S(FIELD(1,MM)="":"|",1:FIELD(1,MM)_"|") Q
"RTN","PSOHLSN",149,0)
 I $L(FIELD(LIMIT))>1 S FIELD(LIMIT)=$E(FIELD(LIMIT),1,($L(FIELD(LIMIT))-1))
"RTN","PSOHLSN",150,0)
 F MM=0:1:LIMIT S SEG1=FIELD(MM) D:MM=1 SEGXX I MM'=1 F CC=1:1:$L(SEG1) D  I $L(PVAR)=245 S PSOFIELD(CT)=PVAR,CT=CT+1,PVAR=""
"RTN","PSOHLSN",151,0)
 .S PVAR1=$E(SEG1,CC)
"RTN","PSOHLSN",152,0)
 .S PLIM=PVAR
"RTN","PSOHLSN",153,0)
 .S PVAR=$S(PVAR="":PVAR1,1:PVAR_PVAR1)
"RTN","PSOHLSN",154,0)
 I $G(PVAR)'="" S PSOFIELD(CT)=PVAR
"RTN","PSOHLSN",155,0)
 S MSG(COUNT)=PSOFIELD(1),SUBCOUNT=1 F GG=2:1 Q:'$D(PSOFIELD(GG))  S MSG(COUNT,SUBCOUNT)=PSOFIELD(GG),SUBCOUNT=SUBCOUNT+1
"RTN","PSOHLSN",156,0)
 Q
"RTN","PSOHLSN",157,0)
SEGXX ;
"RTN","PSOHLSN",158,0)
 N MMZ F MMZ=0:0 S MMZ=$O(FIELD(MM,MMZ)) Q:'MMZ  S SEG1=FIELD(MM,MMZ) F CC=1:1:$L(SEG1) D  I $L(PVAR)=245 S PSOFIELD(CT)=PVAR,CT=CT+1,PVAR=""
"RTN","PSOHLSN",159,0)
 .S PVAR1=$E(SEG1,CC)
"RTN","PSOHLSN",160,0)
 .S PLIM=PVAR
"RTN","PSOHLSN",161,0)
 .S PVAR=$S(PVAR="":PVAR1,1:PVAR_PVAR1)
"RTN","PSOHLSN",162,0)
 Q
"RTN","PSOHLSN",163,0)
CHKOLDRX ; when dc a pending renewal - if prior Rx is expired, set piece 19 to 1 so will update CPRS from 'renewed' to 'expired' in PSOHLSN1
"RTN","PSOHLSN",164,0)
 N PSOOLD
"RTN","PSOHLSN",165,0)
 S PSOOLD=$P($G(^PS(52.41,PSIEN,0)),"^",21)
"RTN","PSOHLSN",166,0)
 I PSOOLD'="",$P($G(^PSRX(PSOOLD,"STA")),"^")=11 S $P(^PSRX(PSOOLD,0),"^",19)=1
"RTN","PSOHLSN",167,0)
 Q
"RTN","PSOHLSN1")
0^2^B82545457^B81359124
"RTN","PSOHLSN1",1,0)
PSOHLSN1 ;BIR/RTR - Send order info to OERR from file 52 ;10/10/94
"RTN","PSOHLSN1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,10,24,27,55,46,71,101,99,121,139,157,181,143,235,239,292**;DEC 1997;Build 1
"RTN","PSOHLSN1",3,0)
 ;Ref #50.606-DBIA 2174
"RTN","PSOHLSN1",4,0)
 ;#50.607-2221
"RTN","PSOHLSN1",5,0)
 ;#50.7-2223
"RTN","PSOHLSN1",6,0)
 ;#51.2-2226
"RTN","PSOHLSN1",7,0)
 ;#50-221
"RTN","PSOHLSN1",8,0)
 ;PSNDF-2195
"RTN","PSOHLSN1",9,0)
 ;EN^PSSUTIL1-3179
"RTN","PSOHLSN1",10,0)
 ;
"RTN","PSOHLSN1",11,0)
EN(PSRXIEN,STAT,PSSTAT,COMM,PSNOO) ;
"RTN","PSOHLSN1",12,0)
 N COUNT,DFN,J,LIMIT,NAME,NULLFLDS,PSDIEN,PSFLAG,PSND1,PSND2,PSND3,PRODUCT,UNIT,POIPTR,PSOHINST,PODOSE,PODOSENM,PSROUTE,RTNAME,SEGMENT,CCC,BBB,CSCOUNT,PPTR,MSG,PSOHSTRT,PSOHSTOP,PSOHISSD,PSORTLP,ZRXFLAG,RXE2FLAG,RXE2ONLY,PSODFN,EDUZ
"RTN","PSOHLSN1",13,0)
 N PSOCDDUZ,DA,FSIG,BSIG,PSHRX,PSHORX,PSNOOTX,ZPRE,PSOZSTAT,CCCX,PSOCPS,PSOICD
"RTN","PSOHLSN1",14,0)
 K FIELD
"RTN","PSOHLSN1",15,0)
 I $G(STAT)="" Q
"RTN","PSOHLSN1",16,0)
 I STAT="CR"!(STAT="DR")!(STAT="HR")!(STAT="OC")!(STAT="OD")!(STAT="OH")!(STAT="Z@")!(STAT="RP") S PSOZSTAT=STAT D DELP^PSOHLSN S STAT=PSOZSTAT G SKIP
"RTN","PSOHLSN1",17,0)
 I STAT="SC" I $G(PSSTAT)="ZE"!($G(PSSTAT)="HD")!($G(PSSTAT)="DC") S PSOZSTAT=STAT D DELP^PSOHLSN S STAT=PSOZSTAT
"RTN","PSOHLSN1",18,0)
SKIP ;
"RTN","PSOHLSN1",19,0)
 I $G(STAT)="SC",$G(PSSTAT)="ZE",$P($G(^PSRX(+$G(PSRXIEN),0)),"^",19)=2 Q
"RTN","PSOHLSN1",20,0)
 I $G(STAT)="RP" S STAT="OD",PSSTAT="RP"
"RTN","PSOHLSN1",21,0)
 S COUNT=0,NULLFLDS="F JJ=0:1:LIMIT S FIELD(JJ)="""""
"RTN","PSOHLSN1",22,0)
 I '$D(^PSRX(PSRXIEN,0)) Q
"RTN","PSOHLSN1",23,0)
 I ($G(STAT)="SC"&($G(PSSTAT)="ZE"))!($G(STAT)="OC")!($G(STAT)="OD") I $D(^PS(52.41,"AQ",PSRXIEN)) D EN^PSOHDR("PRES",PSRXIEN) Q
"RTN","PSOHLSN1",24,0)
 I STAT'="SN",STAT'="ZC",'$P($G(^PSRX(PSRXIEN,"OR1")),"^",2) Q
"RTN","PSOHLSN1",25,0)
 I $G(STAT)="SC",$G(PSSTAT)="ZE" S $P(^PSRX(PSRXIEN,0),"^",19)=2
"RTN","PSOHLSN1",26,0)
 D INIT
"RTN","PSOHLSN1",27,0)
 S COUNT=1,(ZRXFLAG,RXE2FLAG,RXE2ONLY)=0 D PID,PV1,ORC
"RTN","PSOHLSN1",28,0)
 I $G(STAT)="Z@" G NCM
"RTN","PSOHLSN1",29,0)
 I $G(STAT)="OK"!($G(STAT)="SN")!($G(STAT)="ZC")!($G(STAT)="XX")!($G(STAT)="SC")!($G(STAT)="RO") D RXO,RXE,RXR,ZRX,DG1,ZSC,ZCL G NCM
"RTN","PSOHLSN1",30,0)
 I $G(STAT)="SC",$G(PSSTAT)="CM" D RXO,RXE,RXR,ZRX,DG1,ZSC,ZCL
"RTN","PSOHLSN1",31,0)
 I '$G(RXE2FLAG) S RXE2ONLY=1 D RXE,SEGPARX^PSOHLSN
"RTN","PSOHLSN1",32,0)
 I '$G(ZRXFLAG) D ZRX
"RTN","PSOHLSN1",33,0)
NCM D SEND
"RTN","PSOHLSN1",34,0)
 K PSRXIEN Q
"RTN","PSOHLSN1",35,0)
INIT K ^UTILITY("DIQ1",$J),DIQ S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOHINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIQ,DIC
"RTN","PSOHLSN1",36,0)
 S MSG(1)="MSH|^~\&|PHARMACY|"_$G(PSOHINST)_"|||||"_$S($G(PSOMSORR):"ORR",1:"ORM")
"RTN","PSOHLSN1",37,0)
 Q
"RTN","PSOHLSN1",38,0)
PID S LIMIT=5 X NULLFLDS
"RTN","PSOHLSN1",39,0)
 S DFN=+$P(^PSRX(PSRXIEN,0),"^",2) D DEM^VADPT S NAME=$G(VADM(1)) K VADM
"RTN","PSOHLSN1",40,0)
 S FIELD(0)="PID"
"RTN","PSOHLSN1",41,0)
 S FIELD(3)=DFN
"RTN","PSOHLSN1",42,0)
 S FIELD(5)=NAME
"RTN","PSOHLSN1",43,0)
 D SEG Q
"RTN","PSOHLSN1",44,0)
DG1 D DG1^PSOHLSN2
"RTN","PSOHLSN1",45,0)
 Q
"RTN","PSOHLSN1",46,0)
PV1 ;
"RTN","PSOHLSN1",47,0)
 S LIMIT=19 X NULLFLDS
"RTN","PSOHLSN1",48,0)
 S FIELD(0)="PV1"
"RTN","PSOHLSN1",49,0)
 S FIELD(2)="O"
"RTN","PSOHLSN1",50,0)
 S:$P(^PSRX(PSRXIEN,0),"^",5) FIELD(3)=$P(^(0),"^",5)
"RTN","PSOHLSN1",51,0)
 D SEG Q
"RTN","PSOHLSN1",52,0)
ORC ;
"RTN","PSOHLSN1",53,0)
 S LIMIT=15 X NULLFLDS
"RTN","PSOHLSN1",54,0)
 S FIELD(0)="ORC"
"RTN","PSOHLSN1",55,0)
 S FIELD(1)=$G(STAT)
"RTN","PSOHLSN1",56,0)
 I $G(STAT)'="SN",$G(STAT)'="ZC" S FIELD(2)=$P($G(^PSRX(PSRXIEN,"OR1")),"^",2)
"RTN","PSOHLSN1",57,0)
 S:FIELD(2)'="" FIELD(2)=FIELD(2)_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"
"RTN","PSOHLSN1",58,0)
 S FIELD(3)=PSRXIEN_"^PS"
"RTN","PSOHLSN1",59,0)
 S FIELD(5)=$G(PSSTAT)
"RTN","PSOHLSN1",60,0)
 I $G(STAT)="RO",$G(PSOROPCH)'="PATCH" S FIELD(5)="CM"
"RTN","PSOHLSN1",61,0)
 I $G(FIELD(5))="" I $G(STAT)="OR"!($G(STAT)="OE") S FIELD(5)="CM"
"RTN","PSOHLSN1",62,0)
 S X=$P($G(^PSRX(PSRXIEN,2)),"^") I X S FIELD(9)=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",63,0)
 S EDUZ=$P($G(^PSRX(PSRXIEN,0)),"^",16) I EDUZ S FIELD(10)=EDUZ_"^"_$P($G(^VA(200,EDUZ,0)),"^")
"RTN","PSOHLSN1",64,0)
 I $G(PSOCANRC),$G(PSOCANRN)'="" I $G(STAT)="OD"!($G(STAT)="OC") S FIELD(12)=$G(PSOCANRC)_"^"_$G(PSOCANRN)
"RTN","PSOHLSN1",65,0)
 I '$G(FIELD(12)) S FIELD(12)=$P($G(^PSRX(PSRXIEN,0)),"^",4)_"^"_$P($G(^VA(200,+$P($G(^PSRX(PSRXIEN,0)),"^",4),0)),"^")
"RTN","PSOHLSN1",66,0)
 S PSOHISSD="",X=$P($G(^PSRX(PSRXIEN,0)),"^",13) I X S PSOHISSD=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",67,0)
 S FIELD(15)=$G(PSOHISSD) K X
"RTN","PSOHLSN1",68,0)
 D SEG
"RTN","PSOHLSN1",69,0)
 I $G(COMM)'=""!($G(PSNOO)'="") D
"RTN","PSOHLSN1",70,0)
 .I $G(PSNOO)'="" D NOO
"RTN","PSOHLSN1",71,0)
 .I $L($G(COMM))+($L(MSG(COUNT)))+($L($G(PSNOOTX)))+($S($G(PSNOO)'="":11,1:5))<245 S MSG(COUNT)=MSG(COUNT)_"|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$G(COMM)_"^" Q
"RTN","PSOHLSN1",72,0)
 .S MSG(COUNT,1)="|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$G(COMM)_"^"
"RTN","PSOHLSN1",73,0)
 Q
"RTN","PSOHLSN1",74,0)
 ;
"RTN","PSOHLSN1",75,0)
RXO ;
"RTN","PSOHLSN1",76,0)
 S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN1",77,0)
 S FIELD(0)="RXO"
"RTN","PSOHLSN1",78,0)
 S PPTR=+$P($G(^PSRX(PSRXIEN,"OR1")),"^")
"RTN","PSOHLSN1",79,0)
 S FIELD(1)=$S('PPTR:"^^^^^",1:"^^^"_PPTR_"^"_$P($G(^PS(50.7,PPTR,0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^")_"^99PSP")
"RTN","PSOHLSN1",80,0)
 D SEG Q
"RTN","PSOHLSN1",81,0)
 ;
"RTN","PSOHLSN1",82,0)
RXE ;
"RTN","PSOHLSN1",83,0)
 S RXE2FLAG=1
"RTN","PSOHLSN1",84,0)
 S LIMIT=$S('$G(RXE2ONLY):26,1:2) X NULLFLDS
"RTN","PSOHLSN1",85,0)
 S FIELD(0)="RXE"
"RTN","PSOHLSN1",86,0)
 S (PSOHSTRT,PSOHSTOP)="" S X=$P($G(^PSRX(PSRXIEN,2)),"^",2) I X S PSOHSTRT=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",87,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLSN1",88,0)
 S X=$S($P($G(^PSRX(PSRXIEN,3)),"^",5):$P($G(^(3)),"^",5),$G(STAT)="OD"!($G(STAT)="OC"):$G(DT),$P($G(^(2)),"^",6):$P($G(^(2)),"^",6),1:$G(DT)) I X S PSOHSTOP=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",89,0)
 K X N PSOMZT,MMZZ,MMZZT S MMZZT=1 F MMZZ=0:0 S MMZZ=$O(^PSRX(PSRXIEN,6,MMZZ)) Q:'MMZZ  D:$D(^(MMZZ,0))
"RTN","PSOHLSN1",90,0)
 .S FIELD(1,MMZZT)=$S($P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",2):$P($G(^(0)),"^")_"&"_$P($G(^PS(50.607,+$P($G(^(0)),"^",3),0)),"^")_"&"_$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",2)_"&"_$P($G(^(0)),"^",4),1:"")_"^"_$P($G(^(0)),"^",8)
"RTN","PSOHLSN1",91,0)
 .I $P($G(FIELD(1,MMZZT)),"^")'="" F PSOMZT=1,3 I $E($P(FIELD(1,MMZZT),"&",PSOMZT),1)="." S $P(FIELD(1,MMZZT),"&",PSOMZT)="0"_$P(FIELD(1,MMZZT),"&",PSOMZT)
"RTN","PSOHLSN1",92,0)
 .S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"^"_$$DUR(PSRXIEN,MMZZ)_"^^^^^"_$S($P($G(FIELD(1,MMZZT)),"^")'="":$P($G(FIELD(1,MMZZT)),"&")_$P($G(FIELD(1,MMZZT)),"&",2),1:$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^"))
"RTN","PSOHLSN1",93,0)
 .S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"^"_$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",6)
"RTN","PSOHLSN1",94,0)
 .I $O(^PSRX(PSRXIEN,6,MMZZ)) S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"~"
"RTN","PSOHLSN1",95,0)
 .S MMZZT=MMZZT+1
"RTN","PSOHLSN1",96,0)
 S $P(FIELD(1,1),"^",4)=$G(PSOHSTRT),$P(FIELD(1,1),"^",5)=$G(PSOHSTOP)
"RTN","PSOHLSN1",97,0)
 S PSFLAG=0,PSDIEN=+$P(^PSRX(PSRXIEN,0),"^",6),PSND1=$P($G(^PSDRUG(PSDIEN,"ND")),"^"),PSND2=$P($G(^("ND")),"^",2),PSND3=$P($G(^("ND")),"^",3) I PSND1,PSND3 S PSFLAG=1
"RTN","PSOHLSN1",98,0)
 S FIELD(2)=$S(PSFLAG:PSND1_"."_PSND3_"^"_PSND2_"^"_"99NDF",1:"^^")_"^"_PSDIEN_"^"_$P($G(^PSDRUG(PSDIEN,0)),"^")_"^"_"99PSD"
"RTN","PSOHLSN1",99,0)
 Q:$G(RXE2ONLY)
"RTN","PSOHLSN1",100,0)
 I PSFLAG D
"RTN","PSOHLSN1",101,0)
 .I $T(^PSNAPIS)]"" S PSOXN=$$DFSU^PSNAPIS(PSND1,PSND3) S FIELD(5)="^^^"_$P($G(PSOXN),"^",5)_"^"_$P($G(PSOXN),"^",6)_"^"_"99PSU" K PSOXN Q
"RTN","PSOHLSN1",102,0)
 .S PRODUCT=$G(^PSNDF(PSND1,5,PSND3,0)) S UNIT=$P($G(^PSNDF(PSND1,2,+$P(PRODUCT,"^",2),3,+$P(PRODUCT,"^",3),4,+$P(PRODUCT,"^",4),0)),"^")
"RTN","PSOHLSN1",103,0)
 .S FIELD(5)="^^^"_UNIT_"^"_$P($G(^PS(50.607,+UNIT,0)),"^")_"^"_"99PSU"
"RTN","PSOHLSN1",104,0)
 S POIPTR=$P($G(^PSRX(PSRXIEN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,+PODOSE,0)),"^")
"RTN","PSOHLSN1",105,0)
 I POIPTR S FIELD(6)="^^^"_$G(PODOSE)_"^"_$G(PODOSENM)_"^"_"99PSF"
"RTN","PSOHLSN1",106,0)
 S FIELD(10)=$P(^PSRX(PSRXIEN,0),"^",7)
"RTN","PSOHLSN1",107,0)
 S FIELD(12)=$P(^PSRX(PSRXIEN,0),"^",9)
"RTN","PSOHLSN1",108,0)
 S FIELD(14)=$P(^PSRX(PSRXIEN,0),"^",4)
"RTN","PSOHLSN1",109,0)
 S FIELD(15)=$P(^PSRX(PSRXIEN,0),"^")
"RTN","PSOHLSN1",110,0)
 S FIELD(22)=$P(^PSRX(PSRXIEN,0),"^",8)
"RTN","PSOHLSN1",111,0)
 K MMZZ S MMZZ=$$EN^PSSUTIL1(PSDIEN) S FIELD(25)=$S($E($P(MMZZ,"|"),1)=".":"0",1:"")_$P(MMZZ,"|"),FIELD(26)=$P(MMZZ,"|",2)
"RTN","PSOHLSN1",112,0)
 N PLIM,PVAR,PVAR1,SUBCOUNT D SEGPARX^PSOHLSN
"RTN","PSOHLSN1",113,0)
 ;
"RTN","PSOHLSN1",114,0)
 I $O(^PSRX(PSRXIEN,"PRC",0)) D
"RTN","PSOHLSN1",115,0)
 .S COUNT=COUNT+1,CCC=$O(^PSRX(PSRXIEN,"PRC",0))
"RTN","PSOHLSN1",116,0)
 .S MSG(COUNT)="NTE|6||"_$G(^PSRX(PSRXIEN,"PRC",CCC,0))
"RTN","PSOHLSN1",117,0)
 .S CSCOUNT=1 F CCC=CCC:0 S CCC=$O(^PSRX(PSRXIEN,"PRC",CCC)) Q:'CCC  S MSG(COUNT,CSCOUNT)=$G(^PSRX(PSRXIEN,"PRC",CCC,0)),CSCOUNT=CSCOUNT+1
"RTN","PSOHLSN1",118,0)
 I $O(^PSRX(PSRXIEN,"INS1",0)) D
"RTN","PSOHLSN1",119,0)
 .S COUNT=COUNT+1,CCC=$O(^PSRX(PSRXIEN,"INS1",0))
"RTN","PSOHLSN1",120,0)
 .S MSG(COUNT)="NTE|7|L|"_$G(^PSRX(PSRXIEN,"INS1",CCC,0))
"RTN","PSOHLSN1",121,0)
 .S CCCX=1 F CCC=CCC:0 S CCC=$O(^PSRX(PSRXIEN,"INS1",CCC,0)) Q:'CCC  I $D(^(0)) S MSG(COUNT,CCCX)=$G(^(0)) S CCCX=CCCX+1
"RTN","PSOHLSN1",122,0)
 S COUNT=COUNT+1
"RTN","PSOHLSN1",123,0)
 I $P($G(^PSRX(PSRXIEN,"SIG")),"^",2) D  Q
"RTN","PSOHLSN1",124,0)
 .D FSIG^PSOUTLA("R",PSRXIEN,238) S MSG(COUNT)="NTE|21||"_$S($G(FSIG(1))'="":$G(FSIG(1)),1:"No SIG available") I $O(FSIG(1)) F CCC=1:0 S CCC=$O(FSIG(CCC)) Q:'CCC  S MSG(COUNT,(CCC-1))=$G(FSIG(CCC))
"RTN","PSOHLSN1",125,0)
 I '$P($G(^PSRX(PSRXIEN,"SIG")),"^",2) D  Q
"RTN","PSOHLSN1",126,0)
 .D EN3^PSOUTLA1(PSRXIEN,238) S MSG(COUNT)="NTE|21||"_$S($G(BSIG(1))'="":$G(BSIG(1)),1:"No SIG available") I $O(BSIG(1)) F CCC=1:0 S CCC=$O(BSIG(CCC)) Q:'CCC  S MSG(COUNT,(CCC-1))=$G(BSIG(CCC))
"RTN","PSOHLSN1",127,0)
 Q
"RTN","PSOHLSN1",128,0)
 ;
"RTN","PSOHLSN1",129,0)
RXR ;
"RTN","PSOHLSN1",130,0)
 F PSORTLP=0:0 S PSORTLP=$O(^PSRX(PSRXIEN,6,PSORTLP)) Q:'PSORTLP  D
"RTN","PSOHLSN1",131,0)
 .S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN1",132,0)
 .S FIELD(0)="RXR"
"RTN","PSOHLSN1",133,0)
 .S PSROUTE=$P($G(^PSRX(PSRXIEN,6,PSORTLP,0)),"^",7) I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLSN1",134,0)
 .S FIELD(1)="^^^"_$G(PSROUTE)_"^"_$G(RTNAME)_"^"_"99PSR"
"RTN","PSOHLSN1",135,0)
 .D SEG
"RTN","PSOHLSN1",136,0)
 Q
"RTN","PSOHLSN1",137,0)
 ;
"RTN","PSOHLSN1",138,0)
ZCL D ZCL^PSOHLSN2
"RTN","PSOHLSN1",139,0)
 Q
"RTN","PSOHLSN1",140,0)
ZSC D ZSC^PSOHLSN2
"RTN","PSOHLSN1",141,0)
 Q
"RTN","PSOHLSN1",142,0)
 ;
"RTN","PSOHLSN1",143,0)
ZRX ;
"RTN","PSOHLSN1",144,0)
 S ZRXFLAG=1
"RTN","PSOHLSN1",145,0)
 S LIMIT=6 X NULLFLDS
"RTN","PSOHLSN1",146,0)
 S FIELD(0)="ZRX"
"RTN","PSOHLSN1",147,0)
 S ZPRE=$P($G(^PSRX(PSRXIEN,"OR1")),"^",3) I ZPRE S FIELD(1)=$P($G(^PSRX(ZPRE,"OR1")),"^",2)
"RTN","PSOHLSN1",148,0)
 I '$G(FIELD(1)),$G(PSORDEDT) S FIELD(1)=$P($G(^PS(52.41,$G(PSORDEDT),0)),"^")
"RTN","PSOHLSN1",149,0)
 S FIELD(2)=$G(PSNOO)
"RTN","PSOHLSN1",150,0)
 I $G(STAT)="SN"!($G(STAT)="RO") S FIELD(3)=$S($G(STAT)="RO"!($G(PSOEDIT)):"E",$G(PSOOPT)=3:"R",1:"N")
"RTN","PSOHLSN1",151,0)
 S FIELD(4)=$P(^PSRX(PSRXIEN,0),"^",11)
"RTN","PSOHLSN1",152,0)
 S PSOCDDUZ=$S($G(PSOROPCH)="PATCH":$P($G(^PSRX(PSRXIEN,"OR1")),"^",5),$G(PSOHUIOR)&($P($G(^PSRX(PSRXIEN,"EXT")),"^")'=""):+$G(PSOCANRC),1:$G(DUZ))
"RTN","PSOHLSN1",153,0)
 I $G(PSOCDDUZ) S FIELD(5)=PSOCDDUZ_"^"_$P($G(^VA(200,PSOCDDUZ,0)),"^")_"^"_"99NP"
"RTN","PSOHLSN1",154,0)
 I $G(STAT)="ZD",$G(PSODISPP) S FIELD(6)="P"
"RTN","PSOHLSN1",155,0)
 D SEG Q
"RTN","PSOHLSN1",156,0)
SEG S SEGMENT="" F J=0:1:LIMIT S SEGMENT=$S(SEGMENT="":FIELD(J),1:SEGMENT_"|"_FIELD(J))
"RTN","PSOHLSN1",157,0)
 S COUNT=COUNT+1,MSG(COUNT)=SEGMENT
"RTN","PSOHLSN1",158,0)
 Q
"RTN","PSOHLSN1",159,0)
SEND D:$G(PSRXIEN)&($T(EN^PSOHDR)]"")&($G(PSOSSMES)'="CPRSUP")  K FIELD D MSG^XQOR("PS EVSEND OR",.MSG) Q
"RTN","PSOHLSN1",160,0)
 .I $G(STAT)="ZC"!($G(STAT)="UC")!($G(STAT)="UD")!($G(STAT)="UH")!($G(STAT)="UR")!($G(STAT)="DE")!($G(STAT)="ZD")!($G(STAT)="SN")!($G(STAT)="Z@") Q
"RTN","PSOHLSN1",161,0)
 .I $G(STAT)="SC",$G(PSSTAT)="ZZ" Q
"RTN","PSOHLSN1",162,0)
 .D EN^PSOHDR("PRES",PSRXIEN)
"RTN","PSOHLSN1",163,0)
 ;
"RTN","PSOHLSN1",164,0)
NOO ;
"RTN","PSOHLSN1",165,0)
 I $G(PSNOO)="" S PSNOOTX="" Q
"RTN","PSOHLSN1",166,0)
 S PSNOOTX=$S(PSNOO="W":"Written",PSNOO="V":"Verbal",PSNOO="P":"Telephoned",PSNOO="S":"Service Correction",PSNOO="X":"Rejected",PSNOO="D":"Duplicate",PSNOO="I":"Policy",PSNOO="E":"Physician Entered",PSNOO="A":"Auto DC",1:"") Q
"RTN","PSOHLSN1",167,0)
 Q
"RTN","PSOHLSN1",168,0)
 ;
"RTN","PSOHLSN1",169,0)
DUR(PSODX1,PSODX2) ;
"RTN","PSOHLSN1",170,0)
 N PSODX,PSODX4,PSODX5,PSODX6,PSODX7 S PSODX=$P($G(^PSRX(PSODX1,6,PSODX2,0)),"^",5)
"RTN","PSOHLSN1",171,0)
 I 'PSODX Q PSODX
"RTN","PSOHLSN1",172,0)
 S PSODX4=$L(PSODX),PSODX5=$E(PSODX,PSODX4)
"RTN","PSOHLSN1",173,0)
 S PSODX=$S(PSODX5?1A:PSODX,1:PSODX_"D")
"RTN","PSOHLSN1",174,0)
 S PSODX6=$L(PSODX)
"RTN","PSOHLSN1",175,0)
 S PSODX7=$E(PSODX,PSODX6)_$E(PSODX,1,(PSODX6-1))
"RTN","PSOHLSN1",176,0)
 Q PSODX7
"RTN","PSOHLSN1",177,0)
 Q
"VER")
8.0^22.0
"BLD",6606,6)
^249
**END**
**END**

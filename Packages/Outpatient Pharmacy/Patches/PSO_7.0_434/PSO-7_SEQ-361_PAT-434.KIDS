Released PSO*7*434 SEQ #361
Extracted from mail message
**KIDS**:PSO*7.0*434^

**INSTALL NAME**
PSO*7.0*434
"BLD",9267,0)
PSO*7.0*434^OUTPATIENT PHARMACY^0^3131204^y
"BLD",9267,1,0)
^^3^3^3131021^
"BLD",9267,1,1,0)
VIC CARD ENHANCEMENT
"BLD",9267,1,2,0)
Refer to patch PSO*7*434 in the FORUM Patch Module for a complete
"BLD",9267,1,3,0)
description.
"BLD",9267,4,0)
^9.64PA^^
"BLD",9267,6.3)
2
"BLD",9267,"KRN",0)
^9.67PA^779.2^20
"BLD",9267,"KRN",.4,0)
.4
"BLD",9267,"KRN",.401,0)
.401
"BLD",9267,"KRN",.402,0)
.402
"BLD",9267,"KRN",.403,0)
.403
"BLD",9267,"KRN",.5,0)
.5
"BLD",9267,"KRN",.84,0)
.84
"BLD",9267,"KRN",3.6,0)
3.6
"BLD",9267,"KRN",3.8,0)
3.8
"BLD",9267,"KRN",9.2,0)
9.2
"BLD",9267,"KRN",9.8,0)
9.8
"BLD",9267,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9267,"KRN",9.8,"NM",1,0)
PSOHLDS1^^0^B48730314
"BLD",9267,"KRN",9.8,"NM",2,0)
PSOHLDS2^^0^B93310223
"BLD",9267,"KRN",9.8,"NM","B","PSOHLDS1",1)

"BLD",9267,"KRN",9.8,"NM","B","PSOHLDS2",2)

"BLD",9267,"KRN",19,0)
19
"BLD",9267,"KRN",19.1,0)
19.1
"BLD",9267,"KRN",101,0)
101
"BLD",9267,"KRN",409.61,0)
409.61
"BLD",9267,"KRN",771,0)
771
"BLD",9267,"KRN",779.2,0)
779.2
"BLD",9267,"KRN",870,0)
870
"BLD",9267,"KRN",8989.51,0)
8989.51
"BLD",9267,"KRN",8989.52,0)
8989.52
"BLD",9267,"KRN",8994,0)
8994
"BLD",9267,"KRN","B",.4,.4)

"BLD",9267,"KRN","B",.401,.401)

"BLD",9267,"KRN","B",.402,.402)

"BLD",9267,"KRN","B",.403,.403)

"BLD",9267,"KRN","B",.5,.5)

"BLD",9267,"KRN","B",.84,.84)

"BLD",9267,"KRN","B",3.6,3.6)

"BLD",9267,"KRN","B",3.8,3.8)

"BLD",9267,"KRN","B",9.2,9.2)

"BLD",9267,"KRN","B",9.8,9.8)

"BLD",9267,"KRN","B",19,19)

"BLD",9267,"KRN","B",19.1,19.1)

"BLD",9267,"KRN","B",101,101)

"BLD",9267,"KRN","B",409.61,409.61)

"BLD",9267,"KRN","B",771,771)

"BLD",9267,"KRN","B",779.2,779.2)

"BLD",9267,"KRN","B",870,870)

"BLD",9267,"KRN","B",8989.51,8989.51)

"BLD",9267,"KRN","B",8989.52,8989.52)

"BLD",9267,"KRN","B",8994,8994)

"BLD",9267,"QUES",0)
^9.62^^
"BLD",9267,"REQB",0)
^9.611^1^1
"BLD",9267,"REQB",1,0)
PSO*7.0*351^2
"BLD",9267,"REQB","B","PSO*7.0*351",1)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
434^3131204
"PKG",206,22,1,"PAH",1,1,0)
^^3^3^3131204
"PKG",206,22,1,"PAH",1,1,1,0)
VIC CARD ENHANCEMENT
"PKG",206,22,1,"PAH",1,1,2,0)
Refer to patch PSO*7*434 in the FORUM Patch Module for a complete
"PKG",206,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOHLDS1")
0^1^B48730314^B48714780
"RTN","PSOHLDS1",1,0)
PSOHLDS1 ;BIR/LC,PWC-Build HL7 Segments for Automated Interface ; 2/5/10 10:01am
"RTN","PSOHLDS1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,232,255,200,305,336,351,434**;DEC 1997;Build 2
"RTN","PSOHLDS1",3,0)
 ;HLFNC       supp. by DBIA 10106
"RTN","PSOHLDS1",4,0)
 ;PSNAPIS     supp. by DBIA 2531
"RTN","PSOHLDS1",5,0)
 ;VASITE      supp. by DBIA 10112
"RTN","PSOHLDS1",6,0)
 ;VADPT       supp. by DBIA 10061
"RTN","PSOHLDS1",7,0)
 ;EN^DIQ1     supp. by DBIA 100
"RTN","PSOHLDS1",8,0)
 ;EN^VAFHLZTA supp. by DBIA 758
"RTN","PSOHLDS1",9,0)
 ;PSDRUG      supp. by DBIA 221
"RTN","PSOHLDS1",10,0)
 ;PS(50.607   supp. by DBIA 2221
"RTN","PSOHLDS1",11,0)
 ;PS(55       supp. by DBIA 2228
"RTN","PSOHLDS1",12,0)
 ;DPT         supp. by DBIA 3097
"RTN","PSOHLDS1",13,0)
 ;SC          supp. by DBIA 10040
"RTN","PSOHLDS1",14,0)
 ;VA(200      supp. by DBIA 10060
"RTN","PSOHLDS1",15,0)
 ;SCMSVUT5    supp. by DBIA 4347
"RTN","PSOHLDS1",16,0)
 ;BLDPID^VAFCQRY supp. by DBIA 3630
"RTN","PSOHLDS1",17,0)
 ;MAKEIT^VAFHLU  supp. by DBIA 4346
"RTN","PSOHLDS1",18,0)
 ;
"RTN","PSOHLDS1",19,0)
 ;*232 allow for Do Not Mail
"RTN","PSOHLDS1",20,0)
 ;*255 move NTEPMI to PSOHLDS4.  fix "MP" node test to '=""
"RTN","PSOHLDS1",21,0)
 ;*305 send  Notice of Privacy Practices in NTE9 - Modified to NTE9 as NTE8 already exist
"RTN","PSOHLDS1",22,0)
 ;
"RTN","PSOHLDS1",23,0)
START ;
"RTN","PSOHLDS1",24,0)
 D GETDATA
"RTN","PSOHLDS1",25,0)
 D PID(.PSI),PV1(.PSI),PV2(.PSI),IAM^PSOHLDS4(.PSI),ORC^PSOHLDS4(.PSI)
"RTN","PSOHLDS1",26,0)
 D NTE^PSOHLDS2,RXE^PSOHLDS2(.PSI),RXD^PSOHLDS2(.PSI)
"RTN","PSOHLDS1",27,0)
 D NTEPMI^PSOHLDS4(.PSI),NTE9^PSOHLDS2(.PSI),RXR^PSOHLDS2(.PSI)                ;*255
"RTN","PSOHLDS1",28,0)
 ; clean up data set by GETDATA
"RTN","PSOHLDS1",29,0)
 K EBY,EBY1,EFDT,EXDT,FDT,PVDR,PVDR1,CSINER,CSINER1,SITE,SITADD,SITPHN
"RTN","PSOHLDS1",30,0)
 K VPHARMID,VPHARM,DEAID,MW,QTY,DASPLY,OLAN,OTHLAN,PRIORDT,RFRM,NFLD,WARN
"RTN","PSOHLDS1",31,0)
 K PSOXN,PSOXN2,PSND1,PSND2,PRODUCT,PSOPROD,UNIT,VANAME,DISPDT,PSONDC
"RTN","PSOHLDS1",32,0)
 K DRUG
"RTN","PSOHLDS1",33,0)
 Q
"RTN","PSOHLDS1",34,0)
GETDATA ; this is the place to set all data needed for several segments
"RTN","PSOHLDS1",35,0)
 I $G(FP)="F"&('$G(FPN)) D    ;original
"RTN","PSOHLDS1",36,0)
 . S FDT=$P(^PSRX(IRXN,2),"^",2),VPHARMID=$P(^(2),"^",10),DISPDT=$P(^(2),"^",5),EXDT=$P(^(2),"^",6),PSONDC=$P(^(2),"^",7)
"RTN","PSOHLDS1",37,0)
 . S PVDR=$P(^PSRX(IRXN,0),"^",4),QTY=$P(^(0),"^",7),DASPLY=$P(^(0),"^",8),MW=$P(^(0),"^",11),EBY=$P(^(0),"^",16)
"RTN","PSOHLDS1",38,0)
 I $G(FP)="F"&($G(FPN)) D    ;refill
"RTN","PSOHLDS1",39,0)
 . S FDT=$P(^PSRX(IRXN,1,FPN,0),"^"),MW=$P(^(0),"^",2),QTY=$P(^(0),"^",4),DASPLY=$P(^(0),"^",10),DISPDT=$P(^(0),"^",19),EXDT=$S($P(^(0),"^",15):$P(^(0),"^",15),1:$P(^PSRX(IRXN,2),"^",6))
"RTN","PSOHLDS1",40,0)
 . S VPHARMID=$S($P(^PSRX(IRXN,1,FPN,0),"^",5)'="":$P(^(0),"^",5),1:$P(^PSRX(IRXN,2),"^",10))
"RTN","PSOHLDS1",41,0)
 . S EBY=$S($P(^PSRX(IRXN,1,FPN,0),"^",5):$P(^(0),"^",5),1:$P(^(0),"^",7)),PVDR=$P(^(0),"^",17),PSONDC=$S($P($G(^PSRX(IRXN,1,FPN,1)),"^",3):$P(^(1),"^",3),1:$P(^PSRX(IRXN,2),"^",7))
"RTN","PSOHLDS1",42,0)
 I $G(FP)="P"&($G(FPN)) D  ;partial
"RTN","PSOHLDS1",43,0)
 . S FDT=$P(^PSRX(IRXN,"P",FPN,0),"^"),MW=$P(^(0),"^",2),QTY=$P(^(0),"^",4),DASPLY=$P(^(0),"^",10),DISPDT=FDT,PVDR=$P(^(0),"^",17),EXDT=$P(^PSRX(IRXN,2),"^",6)
"RTN","PSOHLDS1",44,0)
 . S EBY=$S($P(^PSRX(IRXN,"P",FPN,0),"^",5):$P(^(0),"^",5),1:$P(^(0),"^",7)),VPHARMID=$S($P(^(0),"^",5)'="":$P(^(0),"^",5),1:$P(^PSRX(IRXN,2),"^",10)),PVDR=$P(^PSRX(IRXN,"P",FPN,0),"^",17)
"RTN","PSOHLDS1",45,0)
 . S PSONDC=$S($P(^PSRX(IRXN,"P",FPN,0),"^",12):$P(^(0),"^",12),1:$P(^PSRX(IRXN,2),"^",7))
"RTN","PSOHLDS1",46,0)
 S EFDT=$P(^PSRX(IRXN,2),"^",2) S:$G(EFDT) EFDT=$$HLDATE^HLFNC(EFDT,"DT")
"RTN","PSOHLDS1",47,0)
 S ISDT=$P(^PSRX(IRXN,0),"^",13) S:$G(ISDT) ISDT=$$HLDATE^HLFNC(ISDT,"DT")
"RTN","PSOHLDS1",48,0)
 S DEAID=$$GET1^DIQ(200,PVDR_",",53.2)
"RTN","PSOHLDS1",49,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=VPHARMID D ^DIC
"RTN","PSOHLDS1",50,0)
 S VPHARM=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",51,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=EBY D ^DIC
"RTN","PSOHLDS1",52,0)
 S EBY1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",53,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=PVDR D ^DIC
"RTN","PSOHLDS1",54,0)
 S PVDR1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",55,0)
 S PRIORDT=$P(^PSRX(IRXN,3),"^",4),PRIORDT=$$HLDATE^HLFNC(PRIORDT,"DT")
"RTN","PSOHLDS1",56,0)
 S FDT=$$HLDATE^HLFNC(FDT,"DT")
"RTN","PSOHLDS1",57,0)
 S:$G(DISPDT) DISPDT=$$HLDATE^HLFNC(DISPDT,"DT")
"RTN","PSOHLDS1",58,0)
 S:$G(EXDT) EXDT=$$HLDATE^HLFNC(EXDT,"DT")
"RTN","PSOHLDS1",59,0)
 S FIN=$P(^PSRX(IRXN,"OR1"),"^",5)
"RTN","PSOHLDS1",60,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=FIN D ^DIC
"RTN","PSOHLDS1",61,0)
 S FIN1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",62,0)
 S SITE=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOHLDS1",63,0)
 S PSZIP=$P(SITE,"^",5) S PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOHLDS1",64,0)
 S CLN=+$P(^PSRX(IRXN,0),"^",5),CLN1=$S($D(^SC(CLN,0)):$P(^(0),"^",1),1:"UNKNOWN")
"RTN","PSOHLDS1",65,0)
 S CSINER=$P(^PSRX(IRXN,3),"^",3)
"RTN","PSOHLDS1",66,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=CSINER D ^DIC
"RTN","PSOHLDS1",67,0)
 S CSINER1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",68,0)
 D 6^VADPT
"RTN","PSOHLDS1",69,0)
 S X=$S($D(^PS(55,DFN,0)):^(0),1:""),CAP=$P(X,"^",2)
"RTN","PSOHLDS1",70,0)
 D MW(X,.MW,.MP)                                              ;PSO*232
"RTN","PSOHLDS1",71,0)
 I (($P(^PSRX(IRXN,"STA"),"^")>0)&($P(^("STA"),"^")'=2)&('$G(PSODBQ)))!'$G(^PSRX(IRXN,"IB")) S COPAY="NO COPAY"
"RTN","PSOHLDS1",72,0)
 E  S COPAY="COPAY"
"RTN","PSOHLDS1",73,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0)
"RTN","PSOHLDS1",74,0)
 S DATE=$$HLDATE^HLFNC(FDT) D NOW^%DTC S NOW=$$HLDATE^HLFNC(%,"TS")
"RTN","PSOHLDS1",75,0)
 S OLAN=$P($G(^PS(55,DFN,"LAN")),"^",2),OTLAN="N" I OLAN=2 S OTLAN="Y"
"RTN","PSOHLDS1",76,0)
 S CSUB1=$$GET1^DIQ(50,IDGN_",",3),CSUB="N" I $E(CSUB1,1)>1&($E(CSUB1,1)<6) S CSUB="Y"
"RTN","PSOHLDS1",77,0)
 S SCTALK=+$G(^PS(55,"ASTALK",$P(^PSRX(IRXN,0),"^",2)))
"RTN","PSOHLDS1",78,0)
 K DIC,DR,DIQ S DA=$P($$SITE^VASITE(),"^") I DA D
"RTN","PSOHLDS1",79,0)
 .K PSOINST S DIC=4,DIQ(0)="I",DR=99,DIQ="PSOINST" D EN^DIQ1
"RTN","PSOHLDS1",80,0)
 .S PSOINST=PSOINST(4,DA,99,"I") K DIC,DA,DR,DIQ,PSOINST(4)
"RTN","PSOHLDS1",81,0)
 S DRUG=$$ZZ^PSOSUTL(IRXN),DEA=$P(^PSDRUG(IDGN,0),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOHLDS1",82,0)
 S PSND1=$P($G(^PSDRUG(IDGN,"ND")),"^"),PSND2=$P($G(^("ND")),"^",2),PSND3=$P($G(^("ND")),"^",3)
"RTN","PSOHLDS1",83,0)
 K PSOXN,PSOXN2,PSOPROD
"RTN","PSOHLDS1",84,0)
 I PSND1,PSND3 D
"RTN","PSOHLDS1",85,0)
 .S PSOPROD=$$PROD2^PSNAPIS(PSND1,PSND3),VANAME=$P($G(PSOPROD),"^",1)
"RTN","PSOHLDS1",86,0)
 .I $T(^PSNAPIS)]"" S PSOXN=$$DFSU^PSNAPIS(PSND1,PSND3),UNIT=$P($G(PSOXN),"^",6) S PSOXN=$P($G(PSOXN),"^",5) S PSOXN2=$$PROD2^PSNAPIS(PSND1,PSND3) Q
"RTN","PSOHLDS1",87,0)
 .S PSOXN2=$G(^PSNDF(PSND1,5,PSND3,2))
"RTN","PSOHLDS1",88,0)
 .S PRODUCT=$G(^PSNDF(PSND1,5,PSND3,0))
"RTN","PSOHLDS1",89,0)
 .I $G(PRODUCT)'="" S PSOXN=+$P($G(^PSNDF(PSND1,2,+$P(PRODUCT,"^",2),3,+$P(PRODUCT,"^",3),4,+$P(PRODUCT,"^",4),0)),"^"),UNIT=$P($G(^PS(50.607,PSOXN,0)),"^")
"RTN","PSOHLDS1",90,0)
 S NFLD=0,UU="" F  S UU=$O(^PSRX(IRXN,1,UU)) Q:UU=""  S:$D(^PSRX(IRXN,1,UU,0)) NFLD=NFLD+1
"RTN","PSOHLDS1",91,0)
 S NRFL=$P(^PSRX(IRXN,0),"^",9),RFRM=(NRFL-NFLD)
"RTN","PSOHLDS1",92,0)
 Q
"RTN","PSOHLDS1",93,0)
PID(PSI) ;patient ID segment
"RTN","PSOHLDS1",94,0)
 Q:'$D(DFN)!$D(PAS)
"RTN","PSOHLDS1",95,0)
 S HLFS=HL1("FS"),HLECH=HL1("ECH"),HLQ=HL1("Q"),HLVER=HL1("VER")
"RTN","PSOHLDS1",96,0)
 K PSPID,PSPID1
"RTN","PSOHLDS1",97,0)
 D BLDPID^VAFCQRY(DFN,"","3,4,5,7,8,11,13",.PSPID,.HL1,.ERR)
"RTN","PSOHLDS1",98,0)
 ; put PID in format needed for segment parser
"RTN","PSOHLDS1",99,0)
 S PSPID=PSPID(1) K PSPID(1)
"RTN","PSOHLDS1",100,0)
 S (X,Y)=1 F  S X=+$O(PSPID(X)) Q:'X  S PSPID(Y)=PSPID(X),Y=Y+1 K PSPID(X)
"RTN","PSOHLDS1",101,0)
 ;parse PID into individual fields
"RTN","PSOHLDS1",102,0)
 K PRSEPID D SEGPRSE^SCMSVUT5("PSPID","PRSEPID",HL1("FS"))
"RTN","PSOHLDS1",103,0)
 ; parse address into individual components
"RTN","PSOHLDS1",104,0)
 K ADDSEQ D SEQPRSE^SCMSVUT5($NA(PRSEPID(11)),"ADDSEQ",HL1("ECH"))
"RTN","PSOHLDS1",105,0)
 ; build ZTA (Temporary Address)
"RTN","PSOHLDS1",106,0)
 K X2 S X2=$$EN^VAFHLZTA(DFN,"1,2,3,4,5,6,7,",1)
"RTN","PSOHLDS1",107,0)
 ; parse X2 (ZTA) into individual fields if temp add. exists
"RTN","PSOHLDS1",108,0)
 D:'$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOHLDS1",109,0)
 . N BADA S BADA=$$CHKRX^PSOBAI(IRXN)
"RTN","PSOHLDS1",110,0)
 . I $P(BADA,"^"),'$P(BADA,"^",2),ADDSEQ(1,7)'["VAB" S BADA=$$GET1^DIQ(2,DFN_",",.121,"I") S:BADA ADDSEQ(1,7)="VAB"_BADA
"RTN","PSOHLDS1",111,0)
 D:$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOHLDS1",112,0)
 . K PRSEZTA D SEGPRSE^SCMSVUT5("X2","PRSEZTA",HL1("FS"))
"RTN","PSOHLDS1",113,0)
 . ; parse temporary address into individual components
"RTN","PSOHLDS1",114,0)
 . K TMPADD D SEQPRSE^SCMSVUT5($NA(PRSEZTA(5)),"TMPADD",HL1("ECH"))
"RTN","PSOHLDS1",115,0)
 . ; add temporary address as next repitition in PID segment
"RTN","PSOHLDS1",116,0)
 . S SPOT=1+$O(ADDSEQ(""),-1)
"RTN","PSOHLDS1",117,0)
 . M ADDSEQ(SPOT)=TMPADD(1)
"RTN","PSOHLDS1",118,0)
 . S ADDSEQ(SPOT,7)="C"
"RTN","PSOHLDS1",119,0)
 . S ADDSEQ(SPOT,9)=PRSEZTA(6)
"RTN","PSOHLDS1",120,0)
 . S ADDSEQ(SPOT,12,1)=PRSEZTA(3)
"RTN","PSOHLDS1",121,0)
 . S ADDSEQ(SPOT,12,2)=PRSEZTA(4)
"RTN","PSOHLDS1",122,0)
 . ;move address sequence back into parse PID segment
"RTN","PSOHLDS1",123,0)
 ; rebuild PID segment
"RTN","PSOHLDS1",124,0)
 K PRSEPID(11) M PRSEPID(11)=ADDSEQ
"RTN","PSOHLDS1",125,0)
 K PSPID1 D MAKEIT^VAFHLU("PID",.PRSEPID,.PSPID1,.PSPID1)
"RTN","PSOHLDS1",126,0)
 ;put rebuilt PID into format used by $$EN^VAFCQRY
"RTN","PSOHLDS1",127,0)
 K PSPID S PSPID(1)=PSPID1
"RTN","PSOHLDS1",128,0)
 S X=0,Y=2 F  S X=+$O(PSPID1(X)) Q:'X  S PSPID(Y)=PSPID1(X) S Y=Y+1
"RTN","PSOHLDS1",129,0)
 S CNT=0 F I=1:1 Q:'$D(PSPID(I))  D
"RTN","PSOHLDS1",130,0)
 . I I=1 S ^TMP("PSO",$J,PSI)=PSPID(I) Q
"RTN","PSOHLDS1",131,0)
 . S CNT=CNT+1 S ^TMP("PSO",$J,PSI,CNT)=PSPID(I)
"RTN","PSOHLDS1",132,0)
 S PSI=PSI+1
"RTN","PSOHLDS1",133,0)
 S PAS=1
"RTN","PSOHLDS1",134,0)
 K PSPID,PSPID1,PRSEPID,PRSEZTA,SPOT,TMPADD,ADDSEQ
"RTN","PSOHLDS1",135,0)
 Q
"RTN","PSOHLDS1",136,0)
PV1(PSI) ;patient visit segment
"RTN","PSOHLDS1",137,0)
 Q:'$D(DFN)!$D(PAS1)
"RTN","PSOHLDS1",138,0)
 N PV1  ;hardcoded to letter O for Outpatient (Patient class)
"RTN","PSOHLDS1",139,0)
 S PV1="PV1"_FS_FS_"O"_FS
"RTN","PSOHLDS1",140,0)
 S ^TMP("PSO",$J,PSI)=PV1
"RTN","PSOHLDS1",141,0)
 S PSI=PSI+1,PAS1=1
"RTN","PSOHLDS1",142,0)
 Q
"RTN","PSOHLDS1",143,0)
PV2(PSI) ;patient visit segment (additional information)
"RTN","PSOHLDS1",144,0)
 ;PATIENT STATUS AND COPAY
"RTN","PSOHLDS1",145,0)
 Q:'$D(DFN)!$D(PAS2)
"RTN","PSOHLDS1",146,0)
 N PV2 S PV2=""
"RTN","PSOHLDS1",147,0)
 S $P(PV2,"|",24)=$P($G(^PS(53,+$P($G(^PSRX(IRXN,0)),"^",3),0)),"^",2)_"~"_COPAY_FS
"RTN","PSOHLDS1",148,0)
 S ^TMP("PSO",$J,PSI)="PV2|"_PV2
"RTN","PSOHLDS1",149,0)
 S PSI=PSI+1,PAS2=1
"RTN","PSOHLDS1",150,0)
 Q
"RTN","PSOHLDS1",151,0)
 ;
"RTN","PSOHLDS1",152,0)
MW(PS55,MW,MP) ;Return Mail/Window and MP expanded text               ;PSO*232
"RTN","PSOHLDS1",153,0)
 I MW="W"!(MW="") D                   ;*255
"RTN","PSOHLDS1",154,0)
 . S MP=$S($P($G(^PSRX(IRXN,"MP")),"^")'="":$P(^("MP"),"^"),1:"""""")
"RTN","PSOHLDS1",155,0)
 . S MW="WINDOW"
"RTN","PSOHLDS1",156,0)
 I MW="M" D
"RTN","PSOHLDS1",157,0)
 . S MP=""""""
"RTN","PSOHLDS1",158,0)
 . S PS55=$P(PS55,"^",3)
"RTN","PSOHLDS1",159,0)
 . S MW=$S(PS55=1:"CERTIFIED MAIL",PS55=2:"DO NOT MAIL",1:"REGULAR MAIL")
"RTN","PSOHLDS1",160,0)
 Q
"RTN","PSOHLDS2")
0^2^B93310223^B92367437
"RTN","PSOHLDS2",1,0)
PSOHLDS2 ;BHAM ISC/PWC,SAB-Build HL7 Segments for automated interface ;11/22/06 3:24pm
"RTN","PSOHLDS2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,198,255,200,268,305,336,434**;DEC 1997;Build 2
"RTN","PSOHLDS2",3,0)
 ;DIWP supported by DBIA 10011
"RTN","PSOHLDS2",4,0)
 ;^PS(50.606 supported by DBIA 2174
"RTN","PSOHLDS2",5,0)
 ;^PS(50.7 supported by DBIA #2223
"RTN","PSOHLDS2",6,0)
 ;^PS(51 supported by DBIA 2224
"RTN","PSOHLDS2",7,0)
 ;^PS(51.2 supported by DBIA 2226
"RTN","PSOHLDS2",8,0)
 ;^PS(55 supported by DBIA 2228
"RTN","PSOHLDS2",9,0)
 ;^PSDRUG supported by DBIA 221
"RTN","PSOHLDS2",10,0)
 ;^PS(54 supported by DBIA 2227
"RTN","PSOHLDS2",11,0)
 ;Cont'd build HL7 segments
"RTN","PSOHLDS2",12,0)
 ;
"RTN","PSOHLDS2",13,0)
 ;*198 add check to insert spaces into PMI segments
"RTN","PSOHLDS2",14,0)
 ;*255 add 2 new fields to RXE.21 (label name & VA PRINT NAME)
"RTN","PSOHLDS2",15,0)
 ;     and move NTEPMI tag to PSOHLDS4
"RTN","PSOHLDS2",16,0)
 ; *305 send  Notice of Privacy Practices in NTE9 - Modified to NTE9 as NTE8 already exist
"RTN","PSOHLDS2",17,0)
 ;
"RTN","PSOHLDS2",18,0)
RXE(PSI) ;pharmacy encoded order segment
"RTN","PSOHLDS2",19,0)
 Q:'$D(DFN)  N RXE S RXE="" S $P(RXE,"|",1)=""""""
"RTN","PSOHLDS2",20,0)
 S $P(RXE,"|",2)=$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_$G(PSND2)_CS_"99PSNDF"_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",21,0)
 S $P(RXE,"|",3)="" I $G(PSOXN)="" S PSOXN=""""""
"RTN","PSOHLDS2",22,0)
 S $P(RXE,"|",5)=PSOXN_CS_$S($G(UNIT)'="":$G(UNIT),1:"""""")_CS_"99PSU"
"RTN","PSOHLDS2",23,0)
 S POIPTR=$P($G(^PSRX(IRXN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",24,0)
 I '$G(POIPTR) S PODOSE=$P($G(^PS(50.7,$P($G(^PSDRUG(IDGN,2)),"^"),0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",25,0)
 S TRADENM=$G(^PSRX(IRXN,"TN")),$P(RXE,"|",6)=PODOSE_CS_PODOSENM_CS_"99PSF"
"RTN","PSOHLDS2",26,0)
 S $P(RXE,"|",8)=MP,$P(RXE,"|",9)=TRADENM,$P(RXE,"|",10)=QTY
"RTN","PSOHLDS2",27,0)
 S $P(RXE,"|",11)=CS_$P($G(^PSDRUG(IDGN,660)),"^",8),$P(RXE,"|",12)=NRFL
"RTN","PSOHLDS2",28,0)
 S $P(RXE,"|",13)=DEAID,$P(RXE,"|",14)=VPHARMID_CS_$P(VPHARM,",",1)_CS_$P(VPHARM,",",2)
"RTN","PSOHLDS2",29,0)
 S $P(RXE,"|",15)=$P(^PSRX(IRXN,0),"^"),$P(RXE,"|",16)=RFRM,$P(RXE,"|",17)=NFLD
"RTN","PSOHLDS2",30,0)
 S $P(RXE,"|",18)=PRIORDT,$P(RXE,"|",31)=CSUB_RS_SCTALK_RS_OTLAN
"RTN","PSOHLDS2",31,0)
 S $P(RXE,"|",21)=CS_DRUG_RS_CS_$G(VANAME)                       ;*255
"RTN","PSOHLDS2",32,0)
 S ^TMP("PSO",$J,PSI)="RXE|"_RXE,PSI=PSI+1
"RTN","PSOHLDS2",33,0)
 K PODOSE,PODOSENM,POIPTR,TRADENM,UU
"RTN","PSOHLDS2",34,0)
 Q
"RTN","PSOHLDS2",35,0)
RXD(PSI) ;pharmacy dispense segment
"RTN","PSOHLDS2",36,0)
 Q:'$D(DFN)  N RXD,I
"RTN","PSOHLDS2",37,0)
 S WNS="" I $G(WARN) F I=1:1 S WW=$P(WARN,",",I) Q:WW=""  S WNS=WNS_WW_CS_$S(WW'["N":^PS(54,WW,0),1:"")_RS
"RTN","PSOHLDS2",38,0)
 S RXD="RXD"_FS_$S($G(NFLD):NFLD,1:0)_FS_$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_PSND2_CS_"99PSNDF"
"RTN","PSOHLDS2",39,0)
 S RXD=RXD_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",40,0)
 S RXD=RXD_FS_DISPDT_FS_FS_FS_FS_$P(^PSRX(IRXN,0),"^")_FS_NRFL
"RTN","PSOHLDS2",41,0)
 S RXD=RXD_FS_DEA_RS_PSONDC_FS_$S(FIN'="":FIN_CS_FIN1,1:"")_FS
"RTN","PSOHLDS2",42,0)
 S RXD=RXD_FS_DASPLY_FS_MW_FS_FS_CS_$S($G(CAP):"NON-SAFETY",1:"SAFETY")
"RTN","PSOHLDS2",43,0)
 S RXD=RXD_FS_FS_FS_FS_EXDT_FS_FS_FS_FS_FS_FS_WNS_FS_FS
"RTN","PSOHLDS2",44,0)
 S ^TMP("PSO",$J,PSI)=RXD,PSI=PSI+1
"RTN","PSOHLDS2",45,0)
 Q
"RTN","PSOHLDS2",46,0)
RXR(PSI) ;pharmacy route segment
"RTN","PSOHLDS2",47,0)
 Q:'$D(DFN)  N RXR S (PSROUTE,RTNAME)=""""""
"RTN","PSOHLDS2",48,0)
 F PSRTLP=0:0 S PSRTLP=$O(^PSRX(IRXN,6,PSRTLP)) Q:'PSRTLP  D
"RTN","PSOHLDS2",49,0)
 .S PSROUTE=$P($G(^PSRX(IRXN,6,PSRTLP,0)),"^",7)
"RTN","PSOHLDS2",50,0)
 .I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLDS2",51,0)
 I RTNAME="" K PSROUTE,RTNAME,PSRTLP Q
"RTN","PSOHLDS2",52,0)
 S RXR="RXR"_FS_$G(PSROUTE)_CS_$G(RTNAME)_CS_"99PSR"_FS_FS_FS_FS
"RTN","PSOHLDS2",53,0)
 S ^TMP("PSO",$J,PSI)=RXR,PSI=PSI+1
"RTN","PSOHLDS2",54,0)
 K PSROUTE,RTNAME,PSRTLP
"RTN","PSOHLDS2",55,0)
 Q
"RTN","PSOHLDS2",56,0)
SIG K OT S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""
"RTN","PSOHLDS2",57,0)
 .I $D(^PS(51,"A",X)) D
"RTN","PSOHLDS2",58,0)
 ..I $P($G(^PS(55,DFN,"LAN")),"^") S OT=$O(^PS(51,"B",X,0)) I OT,$P($G(^PS(51,OT,4)),"^")]"" S X=$P(^PS(51,OT,4),"^") K OT Q
"RTN","PSOHLDS2",59,0)
 ..;S %=^PS(51,"A",X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG," ",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOHLDS2",60,0)
 .S SGY=SGY_X_" "
"RTN","PSOHLDS2",61,0)
 S X="",SGC=1 F J=1:1 S Z=$P(SGY," ",J) S:Z="" SGY(SGC)=X Q:Z=""  S:$L(X)+$L(Z)'<$S($P(PSOPAR,"^",28):46,1:34) SGY(SGC)=X,SGC=SGC+1,X="" S X=X_Z_" "
"RTN","PSOHLDS2",62,0)
SIGOLD I '$P(PSOPAR,"^",28) D  K NHC
"RTN","PSOHLDS2",63,0)
 .K DIC,DR,DIQ,NHC S DIC=2,DA=DFN,DR=148,DIQ="NHC",DIQ(0)="I"
"RTN","PSOHLDS2",64,0)
 .D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOHLDS2",65,0)
 .I NHC(2,DFN,148,"I")="Y"!($P($G(^PS(55,DFN,40)),"^")) S SGC=SGC+1,SGY(SGC)="Expiration:________ Mfg:_________"
"RTN","PSOHLDS2",66,0)
 Q
"RTN","PSOHLDS2",67,0)
 ;
"RTN","PSOHLDS2",68,0)
PSOLBL3 ;RX must be defined (Internal), Check already done for OERR SIG
"RTN","PSOHLDS2",69,0)
 ;Format OERR Sig for New and Old label stock
"RTN","PSOHLDS2",70,0)
 N CTCT,FFFF,LLIM,LLLL,LVAR,LVAR1,PPP,PPPP,SGCT,SIG9,ZZZZ,PSLONG,PPPP
"RTN","PSOHLDS2",71,0)
 S RX=IRXN
"RTN","PSOHLDS2",72,0)
 I $P($G(^PS(55,DFN,"LAN")),"^") N II D OTHL^PSOLBL3 G:$G(FND) FMSIG
"RTN","PSOHLDS2",73,0)
 S PSLONG=$S($P(PSOPAR,"^",28):46,1:34)
"RTN","PSOHLDS2",74,0)
 ; NEXT LINE IF SIG IS MOVED BACK TO MULTIPLE
"RTN","PSOHLDS2",75,0)
 S PPPP=1 F PPP=0:0 S PPP=$O(^PSRX(RX,"SIG1",PPP)) Q:'PPP  I $G(^PSRX(RX,"SIG1",PPP,0))'="" S SIG9(PPPP)=^(0) S PPPP=PPPP+1
"RTN","PSOHLDS2",76,0)
 ;NEXT LINE IF 1ST FRONT DOOR SIG LINE LIVES IN BACK DOOR SPOT
"RTN","PSOHLDS2",77,0)
FMSIG S (LVAR,LVAR1)="",LLLL=1
"RTN","PSOHLDS2",78,0)
 F FFFF=0:0 S FFFF=$O(SIG9(FFFF)) Q:'FFFF  S SGCT=0 F ZZZZ=1:1:$L(SIG9(FFFF)) I $E(SIG9(FFFF),ZZZZ)=" "!($L(SIG9(FFFF))=ZZZZ) S SGCT=SGCT+1 D  I $L(LVAR)>PSLONG S SGY(LLLL)=LLIM_" ",LLLL=LLLL+1,LVAR=LVAR1
"RTN","PSOHLDS2",79,0)
 .S LVAR1=$P(SIG9(FFFF)," ",(SGCT)),LLIM=LVAR,LVAR=$S(LVAR="":LVAR1,1:LVAR_" "_LVAR1)
"RTN","PSOHLDS2",80,0)
 I $G(LVAR)'="" S SGY(LLLL)=LVAR
"RTN","PSOHLDS2",81,0)
 I '$P(PSOPAR,"^",28) S SGC=0 F CTCT=0:0 S CTCT=$O(SGY(CTCT)) Q:'CTCT  S SGC=SGC+1
"RTN","PSOHLDS2",82,0)
 I $O(OSGY(0)) D
"RTN","PSOHLDS2",83,0)
 .F I=0:0 S I=$O(SGY(I)) Q:'I  I $G(OSGY(I))']"" S OSGY(I)=" "
"RTN","PSOHLDS2",84,0)
 .F I=0:0 S I=$O(OSGY(I)) Q:'I  I $G(SGY(I))']"" S SGY(I)=" "
"RTN","PSOHLDS2",85,0)
 Q
"RTN","PSOHLDS2",86,0)
NTE ;build NTE segment for SIG
"RTN","PSOHLDS2",87,0)
 ;
"RTN","PSOHLDS2",88,0)
 Q:'$D(DFN)
"RTN","PSOHLDS2",89,0)
 ; 1 = SIG
"RTN","PSOHLDS2",90,0)
 ; 2 = PI Narrative
"RTN","PSOHLDS2",91,0)
 ; 3 = Drug Warning
"RTN","PSOHLDS2",92,0)
 ; 4 = Profile
"RTN","PSOHLDS2",93,0)
 ; 5 = Drug Interaction
"RTN","PSOHLDS2",94,0)
 ; 6 = Drug Allergy
"RTN","PSOHLDS2",95,0)
 ; 7 = PMI Sheet (NTEPMI in PSOHLDS4)
"RTN","PSOHLDS2",96,0)
 ; 8 = Medication Instructions
"RTN","PSOHLDS2",97,0)
 ; 9 = Privacy Notification
"RTN","PSOHLDS2",98,0)
 ;
"RTN","PSOHLDS2",99,0)
 K FLDX
"RTN","PSOHLDS2",100,0)
 D NTE1(.PSI) K FLDX D NTE2(.PSI) K FLDX D NTE3(.PSI) K FLDX
"RTN","PSOHLDS2",101,0)
 D NTE4(.PSI) K FLDX D NTE5(.PSI) K FLDX D NTE6(.PSI) K FLDX
"RTN","PSOHLDS2",102,0)
 Q
"RTN","PSOHLDS2",103,0)
 ;
"RTN","PSOHLDS2",104,0)
NTE1(PSI) ;SIG
"RTN","PSOHLDS2",105,0)
 S SIG=$P($G(^PSRX(IRXN,"SIG")),"^")
"RTN","PSOHLDS2",106,0)
 I $P($G(^PSRX(IRXN,"SIG")),"^",2) D PSOLBL3,SIGOLD
"RTN","PSOHLDS2",107,0)
 I '$P($G(^PSRX(IRXN,"SIG")),"^",2) D SIG
"RTN","PSOHLDS2",108,0)
 I $O(OSGY(0)) D  G KNTE
"RTN","PSOHLDS2",109,0)
 .K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",110,0)
 .S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions (LANGUAGE PREFERENCE)"
"RTN","PSOHLDS2",111,0)
 .K DRR F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",112,0)
 .S DRR=DRR+1,OSGY(DRR)=FS_"Medication Instructions (ENGLISH)"
"RTN","PSOHLDS2",113,0)
 .K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",114,0)
 .S CLD=1 F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",115,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR)
"RTN","PSOHLDS2",116,0)
 .S PSI=PSI+1,^TMP("PSO",$J,PSI)="NTE"_FS_8_FS_FS
"RTN","PSOHLDS2",117,0)
 .S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",118,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",119,0)
 K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",120,0)
 S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions"
"RTN","PSOHLDS2",121,0)
 K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",122,0)
 S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",123,0)
 .S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",124,0)
KNTE S PSI=PSI+1 K DR,CLD,DRR,SIG,E,F,S,FLD1,X,Y,SGY,SGC,Z,DR,%,J,P,NT1,ST,EN,LTH
"RTN","PSOHLDS2",125,0)
 Q
"RTN","PSOHLDS2",126,0)
LENGTH(NT1) ; compensate for length > 245
"RTN","PSOHLDS2",127,0)
 I $L(NT1)>245 S LTH=$E($L(NT1)/245,1) S:$L(NT1)#245>0 LTH=LTH+1 F WW=1:1:LTH D
"RTN","PSOHLDS2",128,0)
 . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S NT11=$E(NT1,ST,EN)
"RTN","PSOHLDS2",129,0)
 . S:WW=1 ^TMP("PSO",$J,PSI)=NT11 S:WW>1 ^TMP("PSO",$J,PSI,WW-1)=NT11
"RTN","PSOHLDS2",130,0)
 S:'$D(LTH) ^TMP("PSO",$J,PSI)=NT1 S PSI=PSI+1
"RTN","PSOHLDS2",131,0)
 Q
"RTN","PSOHLDS2",132,0)
NTE2(PSI) ; Patient Narrative
"RTN","PSOHLDS2",133,0)
 K ^UTILITY($J,"W") S (DIWL,PSNACNT)=1,DIWR=45,DIWF="",(PSSIXFL,PSSEVFL)=0 F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,6,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",134,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSIXFL=1
"RTN","PSOHLDS2",135,0)
 I PSSIXFL S ^TMP("PSO",$J,PSI)="NTE"_FS_2_FS_FS,^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1,FLDX=1
"RTN","PSOHLDS2",136,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,7,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",137,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSEVFL=1
"RTN","PSOHLDS2",138,0)
 I PSSEVFL S ^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",139,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,4,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",140,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",141,0)
 S:$D(FLDX) ^TMP("PSO",$J,PSI,PSNACNT-1)=^TMP("PSO",$J,PSI,PSNACNT-1)_FS_"Patient Narrative",PSI=PSI+1
"RTN","PSOHLDS2",142,0)
 K DIWF,DIWL,DIWR,LLL,PSNACNT,PSSEVFL,PSSIXFL,ZZ
"RTN","PSOHLDS2",143,0)
 Q
"RTN","PSOHLDS2",144,0)
NTE3(PSI) ;Drug Warning Narrative
"RTN","PSOHLDS2",145,0)
 N NTE3,J,TEXT,W,CNT,PSSWSITE
"RTN","PSOHLDS2",146,0)
 S WARN=$P($G(^PSDRUG(IDGN,0)),"^",8)
"RTN","PSOHLDS2",147,0)
 S PSSWSITE=+$O(^PS(59.7,0))
"RTN","PSOHLDS2",148,0)
 I $P($G(^PS(59.7,PSSWSITE,10)),"^",11)="N" D
"RTN","PSOHLDS2",149,0)
 .S WARN=$$DRUG^PSSWRNA(IDGN,DFN)
"RTN","PSOHLDS2",150,0)
 I WARN="" Q
"RTN","PSOHLDS2",151,0)
 S NTE3="NTE"_FS_3_FS_FS,^TMP("PSO",$J,PSI)=NTE3,CNT=1
"RTN","PSOHLDS2",152,0)
 F J=1:1 S W=$P(WARN,",",J) Q:W=""  D
"RTN","PSOHLDS2",153,0)
 . S:CNT>1 ^TMP("PSO",$J,PSI,CNT-1)=^TMP("PSO",$J,PSI,CNT-1)_"\.sp\"
"RTN","PSOHLDS2",154,0)
 . S TEXT=$$WTEXT^PSSWRNA(W,$G(OLAN)) I TEXT'="" S FLDX=1 D
"RTN","PSOHLDS2",155,0)
 . . I $L(TEXT)<245 S ^TMP("PSO",$J,PSI,CNT)=TEXT,CNT=CNT+1 Q
"RTN","PSOHLDS2",156,0)
 . . N LTH,ST,EN,TXT,WW
"RTN","PSOHLDS2",157,0)
 . . S LTH=$E($L(TEXT)/245,1) S:$L(TEXT)#245>0 LTH=LTH+1
"RTN","PSOHLDS2",158,0)
 . . F WW=1:1:LTH D
"RTN","PSOHLDS2",159,0)
 . . . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S TXT=$E(TEXT,ST,EN)
"RTN","PSOHLDS2",160,0)
 . . . S ^TMP("PSO",$J,PSI,CNT)=TXT,CNT=CNT+1
"RTN","PSOHLDS2",161,0)
 I $G(FLDX) D  S PSI=PSI+1
"RTN","PSOHLDS2",162,0)
 . I $L(^TMP("PSO",$J,PSI,CNT-1)_FS_"Drug Warning Narrative")<245 S ^TMP("PSO",$J,PSI,CNT-1)=$G(^TMP("PSO",$J,PSI,CNT-1))_FS_"Drug Warning Narrative"
"RTN","PSOHLDS2",163,0)
 . E  S ^TMP("PSO",$J,PSI,CNT)=FS_"Drug Warning Narrative"
"RTN","PSOHLDS2",164,0)
 Q
"RTN","PSOHLDS2",165,0)
NTE4(PSI) ;Profile information
"RTN","PSOHLDS2",166,0)
 S PSODFN=DFN N NTE4
"RTN","PSOHLDS2",167,0)
 I $P(PSOPAR,"^",8) D START^PSOHLDS3
"RTN","PSOHLDS2",168,0)
 S:$D(NTE4) PSI=PSI+1
"RTN","PSOHLDS2",169,0)
 Q
"RTN","PSOHLDS2",170,0)
NTE5(PSI) ;Drug Interactions
"RTN","PSOHLDS2",171,0)
 N NTE5 D:$D(DRI) START2^PSOHLDS3
"RTN","PSOHLDS2",172,0)
 S:$D(NTE5) ^TMP("PSO",$J,PSI)=NTE5_FS_"Drug Interactions",PSI=PSI+1
"RTN","PSOHLDS2",173,0)
 Q
"RTN","PSOHLDS2",174,0)
NTE6(PSI) ;Drug Allergy Indications
"RTN","PSOHLDS2",175,0)
 N NTE6
"RTN","PSOHLDS2",176,0)
 Q:'$G(DAW)
"RTN","PSOHLDS2",177,0)
 D START3^PSOHLDS3
"RTN","PSOHLDS2",178,0)
 Q:NTE6=""
"RTN","PSOHLDS2",179,0)
 S ^TMP("PSO",$J,PSI)=NTE6_FS_"Drug Allergy Indications",PSI=PSI+1
"RTN","PSOHLDS2",180,0)
 Q
"RTN","PSOHLDS2",181,0)
NTE9(PSI) ;Privacy Notification
"RTN","PSOHLDS2",182,0)
 N NTE9,PSOLAN
"RTN","PSOHLDS2",183,0)
 S NTE9="NTE"_FS_9_FS_FS,^TMP("PSO",$J,PSI)=NTE9
"RTN","PSOHLDS2",184,0)
 S PSOLAN=$P($G(^PS(55,DFN,"LAN")),"^",2)
"RTN","PSOHLDS2",185,0)
 I PSOLAN'=2 D
"RTN","PSOHLDS2",186,0)
 . S ^TMP("PSO",$J,PSI,1)="The VA Notice of Privacy Practices, IB 10-163, which outlines your privacy rights, is available online at http://www1.domain.ext/Health/ or you may obtain a copy by writing the VHA Privacy Office (19F2),"
"RTN","PSOHLDS2",187,0)
 . S ^TMP("PSO",$J,PSI,2)="810 Vermont Avenue NW, Washington, DC 20420."_FS_"Privacy Notification"
"RTN","PSOHLDS2",188,0)
 I PSOLAN=2 D
"RTN","PSOHLDS2",189,0)
 . S ^TMP("PSO",$J,PSI,1)="La Notificacion relacionada con las Politicas de Privacidad del Departamento de Asuntos del Veterano, IB 10-163, contiene los detalles acerca de sus derechos de privacidad y esta disponsible electronicamente"
"RTN","PSOHLDS2",190,0)
 . S ^TMP("PSO",$J,PSI,2)=" en la siguiente direccion: http://www1.domain.ext/Health/.  Usted tambien puede conseguir una copia escribiendo a la Oficina de Privacidad del Departamento de Asuntos de Salud del Veterano, (19F2),"
"RTN","PSOHLDS2",191,0)
 . S ^TMP("PSO",$J,PSI,3)="810 Vermont Avenue NW, Washington, DC 20420."_FS_"Privacy Notification"
"RTN","PSOHLDS2",192,0)
 S PSI=PSI+1
"RTN","PSOHLDS2",193,0)
 Q
"VER")
8.0^22.0
"BLD",9267,6)
^361
**END**
**END**

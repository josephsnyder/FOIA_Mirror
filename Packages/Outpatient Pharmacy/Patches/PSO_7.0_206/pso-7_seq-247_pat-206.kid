Released PSO*7*206 SEQ #247
Extracted from mail message
**KIDS**:PSO*7.0*206^

**INSTALL NAME**
PSO*7.0*206
"BLD",6250,0)
PSO*7.0*206^OUTPATIENT PHARMACY^0^3071017^y
"BLD",6250,1,0)
^^8^8^3070725^
"BLD",6250,1,1,0)
PSO*7.0*206 
"BLD",6250,1,2,0)
HD68224  - DEA Code handling changes.
"BLD",6250,1,3,0)
  HD68648- dup HD68224
"BLD",6250,1,4,0)
  HD85385- dup HD68224
"BLD",6250,1,5,0)
  HD179790- dup HD68224
"BLD",6250,1,6,0)
HD186713 - Label shows Certified after mail status.
"BLD",6250,1,7,0)
HD156961 - Medication status of renewed for meds past stop date.
"BLD",6250,1,8,0)
HD161968 - Max refill issue for monthly clozapine patient
"BLD",6250,4,0)
^9.64PA^^
"BLD",6250,6)
8^
"BLD",6250,6.3)
39
"BLD",6250,"INID")
^y
"BLD",6250,"INIT")
EN^PSOP7206
"BLD",6250,"KRN",0)
^9.67PA^8989.52^19
"BLD",6250,"KRN",.4,0)
.4
"BLD",6250,"KRN",.401,0)
.401
"BLD",6250,"KRN",.402,0)
.402
"BLD",6250,"KRN",.403,0)
.403
"BLD",6250,"KRN",.5,0)
.5
"BLD",6250,"KRN",.84,0)
.84
"BLD",6250,"KRN",3.6,0)
3.6
"BLD",6250,"KRN",3.8,0)
3.8
"BLD",6250,"KRN",9.2,0)
9.2
"BLD",6250,"KRN",9.8,0)
9.8
"BLD",6250,"KRN",9.8,"NM",0)
^9.68A^25^19
"BLD",6250,"KRN",9.8,"NM",1,0)
PSOBUILD^^0^B39788051
"BLD",6250,"KRN",9.8,"NM",3,0)
PSODEA^^0^B2872733
"BLD",6250,"KRN",9.8,"NM",5,0)
PSORENW0^^0^B79577371
"BLD",6250,"KRN",9.8,"NM",6,0)
PSODIR3^^0^B27252502
"BLD",6250,"KRN",9.8,"NM",7,0)
PSOHELP^^0^B51838046
"BLD",6250,"KRN",9.8,"NM",8,0)
PSOLBL^^0^B70822934
"BLD",6250,"KRN",9.8,"NM",9,0)
PSOLLLI^^0^B65877294
"BLD",6250,"KRN",9.8,"NM",10,0)
PSOORED1^^0^B68466079
"BLD",6250,"KRN",9.8,"NM",12,0)
PSOORNE5^^0^B60770626
"BLD",6250,"KRN",9.8,"NM",13,0)
PSOORNEW^^0^B66909716
"BLD",6250,"KRN",9.8,"NM",14,0)
PSOORNW1^^0^B43500701
"BLD",6250,"KRN",9.8,"NM",15,0)
PSOORNW2^^0^B45461771
"BLD",6250,"KRN",9.8,"NM",16,0)
PSOORRNW^^0^B20892446
"BLD",6250,"KRN",9.8,"NM",19,0)
PSOREF^^0^B66253301
"BLD",6250,"KRN",9.8,"NM",20,0)
PSORENW^^0^B35245784
"BLD",6250,"KRN",9.8,"NM",22,0)
PSOSIGMX^^0^B14811697
"BLD",6250,"KRN",9.8,"NM",23,0)
PSOUTLA1^^0^B59314173
"BLD",6250,"KRN",9.8,"NM",24,0)
PSODIR1^^0^B73077319
"BLD",6250,"KRN",9.8,"NM",25,0)
PSOSD0^^0^B52648174
"BLD",6250,"KRN",9.8,"NM","B","PSOBUILD",1)

"BLD",6250,"KRN",9.8,"NM","B","PSODEA",3)

"BLD",6250,"KRN",9.8,"NM","B","PSODIR1",24)

"BLD",6250,"KRN",9.8,"NM","B","PSODIR3",6)

"BLD",6250,"KRN",9.8,"NM","B","PSOHELP",7)

"BLD",6250,"KRN",9.8,"NM","B","PSOLBL",8)

"BLD",6250,"KRN",9.8,"NM","B","PSOLLLI",9)

"BLD",6250,"KRN",9.8,"NM","B","PSOORED1",10)

"BLD",6250,"KRN",9.8,"NM","B","PSOORNE5",12)

"BLD",6250,"KRN",9.8,"NM","B","PSOORNEW",13)

"BLD",6250,"KRN",9.8,"NM","B","PSOORNW1",14)

"BLD",6250,"KRN",9.8,"NM","B","PSOORNW2",15)

"BLD",6250,"KRN",9.8,"NM","B","PSOORRNW",16)

"BLD",6250,"KRN",9.8,"NM","B","PSOREF",19)

"BLD",6250,"KRN",9.8,"NM","B","PSORENW",20)

"BLD",6250,"KRN",9.8,"NM","B","PSORENW0",5)

"BLD",6250,"KRN",9.8,"NM","B","PSOSD0",25)

"BLD",6250,"KRN",9.8,"NM","B","PSOSIGMX",22)

"BLD",6250,"KRN",9.8,"NM","B","PSOUTLA1",23)

"BLD",6250,"KRN",19,0)
19
"BLD",6250,"KRN",19.1,0)
19.1
"BLD",6250,"KRN",101,0)
101
"BLD",6250,"KRN",409.61,0)
409.61
"BLD",6250,"KRN",771,0)
771
"BLD",6250,"KRN",870,0)
870
"BLD",6250,"KRN",8989.51,0)
8989.51
"BLD",6250,"KRN",8989.52,0)
8989.52
"BLD",6250,"KRN",8994,0)
8994
"BLD",6250,"KRN","B",.4,.4)

"BLD",6250,"KRN","B",.401,.401)

"BLD",6250,"KRN","B",.402,.402)

"BLD",6250,"KRN","B",.403,.403)

"BLD",6250,"KRN","B",.5,.5)

"BLD",6250,"KRN","B",.84,.84)

"BLD",6250,"KRN","B",3.6,3.6)

"BLD",6250,"KRN","B",3.8,3.8)

"BLD",6250,"KRN","B",9.2,9.2)

"BLD",6250,"KRN","B",9.8,9.8)

"BLD",6250,"KRN","B",19,19)

"BLD",6250,"KRN","B",19.1,19.1)

"BLD",6250,"KRN","B",101,101)

"BLD",6250,"KRN","B",409.61,409.61)

"BLD",6250,"KRN","B",771,771)

"BLD",6250,"KRN","B",870,870)

"BLD",6250,"KRN","B",8989.51,8989.51)

"BLD",6250,"KRN","B",8989.52,8989.52)

"BLD",6250,"KRN","B",8994,8994)

"BLD",6250,"QUES",0)
^9.62^^
"BLD",6250,"REQB",0)
^9.611^15^6
"BLD",6250,"REQB",3,0)
PSO*7.0*200^2
"BLD",6250,"REQB",6,0)
PSO*7.0*235^2
"BLD",6250,"REQB",11,0)
PSO*7.0*258^2
"BLD",6250,"REQB",13,0)
PSO*7.0*268^2
"BLD",6250,"REQB",14,0)
PSO*7.0*259^2
"BLD",6250,"REQB",15,0)
PSO*7.0*269^2
"BLD",6250,"REQB","B","PSO*7.0*200",3)

"BLD",6250,"REQB","B","PSO*7.0*235",6)

"BLD",6250,"REQB","B","PSO*7.0*258",11)

"BLD",6250,"REQB","B","PSO*7.0*259",14)

"BLD",6250,"REQB","B","PSO*7.0*268",13)

"BLD",6250,"REQB","B","PSO*7.0*269",15)

"INIT")
EN^PSOP7206
"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
206^3071017^10000000070
"PKG",141,22,1,"PAH",1,1,0)
^^8^8^3071017
"PKG",141,22,1,"PAH",1,1,1,0)
PSO*7.0*206 
"PKG",141,22,1,"PAH",1,1,2,0)
HD68224  - DEA Code handling changes.
"PKG",141,22,1,"PAH",1,1,3,0)
  HD68648- dup HD68224
"PKG",141,22,1,"PAH",1,1,4,0)
  HD85385- dup HD68224
"PKG",141,22,1,"PAH",1,1,5,0)
  HD179790- dup HD68224
"PKG",141,22,1,"PAH",1,1,6,0)
HD186713 - Label shows Certified after mail status.
"PKG",141,22,1,"PAH",1,1,7,0)
HD156961 - Medication status of renewed for meds past stop date.
"PKG",141,22,1,"PAH",1,1,8,0)
HD161968 - Max refill issue for monthly clozapine patient
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
20
"RTN","PSOBUILD")
0^1^B39788051^B39272146
"RTN","PSOBUILD",1,0)
PSOBUILD ;IHS/DSD/JCM - BUILD ARRAY OF PATIENTS CURRENT MEDS  [ 07/15/96  5:25 PM ] ;6/21/07 8:20am
"RTN","PSOBUILD",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,82,119,132,235,206**;DEC 1997;Build 39
"RTN","PSOBUILD",3,0)
 ;External reference ^PS(50.606 supported by DBIA 2174
"RTN","PSOBUILD",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOBUILD",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOBUILD",6,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOBUILD",7,0)
 ; Input variables: PSODFN,DT,PSODTCUT
"RTN","PSOBUILD",8,0)
START N ORD K PSOSD I '$D(PSODFN)!('$D(DT)) G END
"RTN","PSOBUILD",9,0)
 D EOJ,INIT G:PSOQFLG END D BUILD
"RTN","PSOBUILD",10,0)
 S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSOBUILD",11,0)
 S DRG="" F I=0:0 S DRG=$O(PSOSD(DRG)) Q:DRG=""  I $G(PSOSD(DRG))]"" S PSOSD($P(STA,"^",$P(PSOSD(DRG),"^",2)+1),DRG)=PSOSD(DRG) D  K PSOSD(DRG)
"RTN","PSOBUILD",12,0)
 .S $P(PSOSD($P(STA,"^",$P(PSOSD(DRG),"^",2)+1),DRG),"^",9)=$G(^TMP("PS",$J,$P(STA,"^",$P(PSOSD(DRG),"^",2)+1),DRG))
"RTN","PSOBUILD",13,0)
 F PEN=0:0 S PEN=$O(^PS(52.41,"P",PSODFN,PEN)) Q:'PEN  S ORD=^PS(52.41,PEN,0),PSOOI=$P(ORD,"^",8),PSODD=+$P(ORD,"^",9) D:$P(ORD,"^",3)'="DC"&($P(ORD,"^",3)'="DE")&($P(ORD,"^",3)'="HD")
"RTN","PSOBUILD",14,0)
 .S DRG=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),+PSOOI&('PSODD):$P(^PS(50.7,+PSOOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,+PSOOI,0),"^",2),0),"^"),1:"") Q:DRG']""
"RTN","PSOBUILD",15,0)
 .I $D(PSOSD("PENDING",DRG)) S DRG=DRG_"^"_PEN
"RTN","PSOBUILD",16,0)
 .S PSOSD("PENDING",DRG)="*****^17^Z^Z^"_$S(PSODD:$P(^PSDRUG(PSODD,0),"^",2),1:"")_"^"_$P(^PS(52.41,PEN,0),"^",11)_"^"_$S($G(^PSDRUG(PSODD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:"")
"RTN","PSOBUILD",17,0)
 .S PSOSD("PENDING",DRG)=PSOSD("PENDING",DRG)_"^"_$P(ORD,"^",10)_"^"_$P(ORD,"^",6)_"^"_PEN_"^"_$S($G(PSODD):$G(PSODD),1:""),PSOSD=+$G(PSOSD)+1 K PSOOI,PSODD
"RTN","PSOBUILD",18,0)
 F NVA=0:0 S NVA=$O(^PS(55,PSODFN,"NVA",NVA)) Q:'NVA  S NON=^PS(55,PSODFN,"NVA",NVA,0) D:'$P(^PS(55,PSODFN,"NVA",NVA,0),"^",7)
"RTN","PSOBUILD",19,0)
 .S PSODD=$P(NON,"^",2),PSOOI=$P(NON,"^")
"RTN","PSOBUILD",20,0)
 .S DRG=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),+PSOOI&('PSODD):$P(^PS(50.7,+PSOOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,+PSOOI,0),"^",2),0),"^"),1:"")
"RTN","PSOBUILD",21,0)
 .I $D(PSOSD("ZNONVA",DRG)) S DRG=DRG_"^"_NVA
"RTN","PSOBUILD",22,0)
 .S PSOSD("ZNONVA",DRG)="****^9^Z^Z^"_$S($P(NON,"^",2):$P(^PSDRUG($P(NON,"^",2),0),"^",2),1:"")_"^"_$P(NON,"^",3)_"^^"_$P(NON,"^",5)_"^"_$P(NON,"^",10)_"^"_NVA_"^"_$P(NON,"^",2)
"RTN","PSOBUILD",23,0)
 .I $P(NON,"^",2) S $P(PSOSD("ZNONVA",DRG),"^",7)=$S($G(^PSDRUG(PSODD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:"")
"RTN","PSOBUILD",24,0)
 .S PSOSD=+$G(PSOSD)+1
"RTN","PSOBUILD",25,0)
END D EOJ
"RTN","PSOBUILD",26,0)
 Q
"RTN","PSOBUILD",27,0)
INIT ;
"RTN","PSOBUILD",28,0)
 K PSOSD,PSOMED S PSOQFLG=0,U="^",PSOBUILD("COUNT")=0 G:$D(PSODTCUT) INITX
"RTN","PSOBUILD",29,0)
 I '$D(^PS(53,"B","OUTPATIENT")) S PSOQFLG=1 G INITX
"RTN","PSOBUILD",30,0)
 S PSOX=$O(^PS(53,"B","OUTPATIENT","")) I 'PSOX S PSOQFLG=1 G INITX
"RTN","PSOBUILD",31,0)
 ;S DAYS=$S($D(DAYS360):360,1:45),X2=-$S($P($G(^PS(53,PSOX,0)),"^",3)+15>DAYS:$P($G(^(0)),"^",3)+15,1:DAYS),X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSOBUILD",32,0)
 S X2=-120,X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSOBUILD",33,0)
INITX K X,X1,X2,PSOX
"RTN","PSOBUILD",34,0)
 Q
"RTN","PSOBUILD",35,0)
 ;
"RTN","PSOBUILD",36,0)
BUILD ;build profiles
"RTN","PSOBUILD",37,0)
 F PSOEXPDT=(PSODTCUT-1):0 S PSOEXPDT=$O(^PS(55,PSODFN,"P","A",PSOEXPDT)) Q:'PSOEXPDT  F PSOBUILD("RX")=0:0 S PSOBUILD("RX")=$O(^PS(55,PSODFN,"P","A",PSOEXPDT,PSOBUILD("RX"))) Q:'PSOBUILD("RX")  I $D(^PSRX(PSOBUILD("RX"),0)) D GET
"RTN","PSOBUILD",38,0)
BUILDX I PSOBUILD("COUNT")>0 S PSOSD=PSOBUILD("COUNT")
"RTN","PSOBUILD",39,0)
 Q
"RTN","PSOBUILD",40,0)
GET ;data for profiles
"RTN","PSOBUILD",41,0)
 Q:'$P(^PSRX(PSOBUILD("RX"),0),"^",2)
"RTN","PSOBUILD",42,0)
 S (PSOSTF,PSOSTN)="",PSORX0=^PSRX(PSOBUILD("RX"),0),PSOST0=+^PSRX(PSOBUILD("RX"),"STA"),$P(PSORX0,"^",15)=PSOST0
"RTN","PSOBUILD",43,0)
 G:PSOST0=13 GETX S PSORX2=$G(^PSRX(PSOBUILD("RX"),2))
"RTN","PSOBUILD",44,0)
 S PSORX3=$G(^PSRX(PSOBUILD("RX"),3)) S:PSORX3="" PSORX3=$P(PSORX2,"^",2)
"RTN","PSOBUILD",45,0)
 S PSODRG=+$P(PSORX0,"^",6) G:'$D(^PSDRUG(PSODRG,0)) GETX S PSODRUG0=^PSDRUG(PSODRG,0),PSOVACL=$P(PSODRUG0,"^",2),PSODYS=$P(PSORX0,"^",8)
"RTN","PSOBUILD",46,0)
 ;
"RTN","PSOBUILD",47,0)
 I PSOST0<12!(PSOST0=16),PSOEXPDT<DT D:$P(PSORX0,"^",15)'=11
"RTN","PSOBUILD",48,0)
 .S PSOST0=11,$P(PSORX0,"^",15)=11 N DIE,DIC,DR,DA,PSOBEXDA S DIE=52,(DA,PSOBEXDA)=PSOBUILD("RX"),DR="100////11" D ^DIE K DIE,DIC,DR
"RTN","PSOBUILD",49,0)
 .D ECAN^PSOUTL(DA) K DA
"RTN","PSOBUILD",50,0)
 .S STAT="SC",PHARMST="ZE",COMM="Medication Expired on "_$E(PSOEXPDT,4,5)_"/"_$E(PSOEXPDT,6,7)_"/"_$E(PSOEXPDT,2,3) D EN^PSOHLSN1(PSOBEXDA,STAT,PHARMST,COMM) K COMM,STAT,PHARMST,PSOBEXDA
"RTN","PSOBUILD",51,0)
 I PSOST0=12,PSOEXPDT<DT S PSOST0=12
"RTN","PSOBUILD",52,0)
 I PSOST0=5 D  G GT1
"RTN","PSOBUILD",53,0)
 .I $O(^PS(52.5,"B",PSOBUILD("RX"),0)),'$D(^PS(52.5,+$O(^(0)),0)) D  Q
"RTN","PSOBUILD",54,0)
 ..S PSOST0=0 D FSTA
"RTN","PSOBUILD",55,0)
 ..K ^PS(52.5,"B",PSOBUILD("RX"),$O(^PS(52.5,"B",PSOBUILD("RX"),0)))
"RTN","PSOBUILD",56,0)
 .I '$O(^PS(52.5,"B",PSOBUILD("RX"),0)) S PSOST0=0 D FSTA
"RTN","PSOBUILD",57,0)
 I 'PSOST0 D STAT
"RTN","PSOBUILD",58,0)
GT1 G GETX:$D(NOEXP)&(PSOST0=11)
"RTN","PSOBUILD",59,0)
 I $D(^PSDRUG(PSODRG,"I")),^("I")]"",DT>^("I") S PSOSTN=PSOSTN_"A" I $P($G(PSOPAR),"^",11)']"" S PSOSTF=PSOSTF_"A"
"RTN","PSOBUILD",60,0)
 S PSONDF=$S($G(^PSDRUG(PSODRG,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOBUILD",61,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" S PSOSTN=PSOSTN_"M"
"RTN","PSOBUILD",62,0)
 S CLOZPT=$S($P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1":1,1:0)
"RTN","PSOBUILD",63,0)
 I 'CLOZPT,($P(PSODRUG0,"^",3)["A")&($P(PSODRUG0,"^",3)'["B") S PSOSTN=PSOSTN_"B",PSOSTF=PSOSTF_"B"
"RTN","PSOBUILD",64,0)
 K CLOZPT I ($P(PSODRUG0,"^",3)["W")!($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2) S PSOSTN=PSOSTN_"C"
"RTN","PSOBUILD",65,0)
 I $D(^PS(53,+$P(PSORX0,"^",3),0)),'$P(^(0),"^",5) S PSOSTN=PSOSTN_"D"
"RTN","PSOBUILD",66,0)
 I PSOST0=1 S PSOSTN=PSOSTN_"E"
"RTN","PSOBUILD",67,0)
 S PSOLC=$P(PSORX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)>90 S PSOSTN=PSOSTN_"F"
"RTN","PSOBUILD",68,0)
 I PSOST0,PSOST0'=2,PSOST0'=6 S PSOSTF=PSOSTF_"Z"
"RTN","PSOBUILD",69,0)
 I $G(PSORX("BAR CODE")),PSOST0,PSOST0'=2,PSOST0'=5,PSOST0'=6,PSOST0'=11,PSOST0'=12 S PSOSTN=PSOSTN_"Z" G BARC
"RTN","PSOBUILD",70,0)
 I PSOST0,PSOST0'=2,PSOST0'=5,PSOST0'=6,PSOST0'=11,PSOST0'=12,PSOST0'=14 S PSOSTN=PSOSTN_"Z"
"RTN","PSOBUILD",71,0)
BARC S PSORFRM=$P(PSORX0,"^",9) F PSOJ=0:0 S PSOJ=$O(^PSRX(PSOBUILD("RX"),1,PSOJ)) Q:'PSOJ  S PSORFRM=PSORFRM-1
"RTN","PSOBUILD",72,0)
 S:PSORFRM<0 PSORFRM=0 S:PSORFRM=0 PSOSTF=PSOSTF_"G"
"RTN","PSOBUILD",73,0)
 S PSODRUGN=$P(PSODRUG0,"^") I $D(PSOSD(PSODRUGN)),PSOST0>10 Q:$P(PSOSD(PSODRUGN),"^",2)<11  Q:$P(PSOSD(PSODRUGN),"^",2)>10&($P(PSORX0,"^",13)<$P(^PSRX(+$P(PSOSD(PSODRUGN),"^"),0),"^",13))
"RTN","PSOBUILD",74,0)
 S:'$D(PSOSD(PSODRUGN)) PSOBUILD("COUNT")=PSOBUILD("COUNT")+1
"RTN","PSOBUILD",75,0)
 I $D(PSOSD(PSODRUGN)),$P(PSOSD(PSODRUGN),"^",2)<10,PSOST0<10 S PSOSD(PSODRUGN_"^"_PSOBUILD("RX"))=PSOBUILD("RX")_"^"_PSOST0_"^"_PSOSTN_"^"_PSOSTF_"^"_PSOVACL_"^"_PSORFRM_"^"_PSONDF_"^"_PSODYS,PSOBUILD("COUNT")=PSOBUILD("COUNT")+1
"RTN","PSOBUILD",76,0)
 E  S PSOSD(PSODRUGN)=PSOBUILD("RX")_"^"_PSOST0_"^"_PSOSTN_"^"_PSOSTF_"^"_PSOVACL_"^"_PSORFRM_"^"_PSONDF_"^"_PSODYS
"RTN","PSOBUILD",77,0)
GETX Q
"RTN","PSOBUILD",78,0)
STAT N X S X=+$O(^PS(52.5,"B",PSOBUILD("RX"),0))
"RTN","PSOBUILD",79,0)
 I X,$D(^PS(52.5,X,0)),$P($G(^PS(52.5,X,0)),"^",7)'="X",'$G(^PS(52.5,X,"P")) S PSOST0=5
"RTN","PSOBUILD",80,0)
 I PSOST0 D FSTA
"RTN","PSOBUILD",81,0)
 Q
"RTN","PSOBUILD",82,0)
FSTA S $P(PSORX0,"^",15)=PSOST0
"RTN","PSOBUILD",83,0)
 N DIE,DR,DA S DIE=52,DA=PSOBUILD("RX"),DR="100////"_PSOST0 D ^DIE K DIE,DR,DA
"RTN","PSOBUILD",84,0)
 Q
"RTN","PSOBUILD",85,0)
 ;
"RTN","PSOBUILD",86,0)
EOJ K ORD,PSOX,PSOEXPDT,PSODRG,PSODRUG0,PSOLC,PSONDF,PSOQFLG,PSORFRM,PSORX0,PSORX2,PSORX3,PSOST0,PSOSTF,PSOSTN,PSOJ,PSODRUGN,PSOVACL,PSOBUILD,PSODYS,PEN,DRG,NON,NVA
"RTN","PSOBUILD",87,0)
 Q
"RTN","PSOBUILD",88,0)
INPAT(PSODFN) ;entry point for inpat meds to view patient's outpat. meds
"RTN","PSOBUILD",89,0)
 D FULL^VALM1
"RTN","PSOBUILD",90,0)
 S INPAT=1,X2=-120,X1=DT D C^%DTC S PSODTCUT=X D START,^PSODSPL
"RTN","PSOBUILD",91,0)
 K PSOSD,DDH,PSCNT,PSOCT,PSODD,PSOOI,PSOPAR,PSOSTA,STP,STR,PSODTCUT,PSODFN,INPAT,DRG
"RTN","PSOBUILD",92,0)
 Q
"RTN","PSODEA")
0^3^B2872733^B3118129
"RTN","PSODEA",1,0)
PSODEA ;BHAM ISC/  - HELP TEXT FOR DEA FIELD IN DRUG FILE ; 10/17/07 7:41am
"RTN","PSODEA",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**206**;DEC 1997;Build 39
"RTN","PSODEA",3,0)
 W !,"THE SPECIAL HANDLING CODE IS A 2 TO 6 POSTION FIELD.  IF APPLICABLE,",!,"A SCHEDULE CODE MUST APPEAR IN THE FIRST POSITION.  FOR EXAMPLE,"
"RTN","PSODEA",4,0)
 W !,"A SCHEDULE 3 NARCOTIC WILL BE CODED '3A' AND A SCHEDULE 2 DEPRESSANT",!,"WILL BE CODED '2L'.  THE CODES ARE:",!
"RTN","PSODEA",5,0)
 F I=1:1 S AA=$P($T(D+I),";",3,99) Q:AA=""  W !?10,AA
"RTN","PSODEA",6,0)
D K AA Q
"RTN","PSODEA",7,0)
 ;;0          MANUFACTURED IN PHARMACY
"RTN","PSODEA",8,0)
 ;;1          SCHEDULE 1 ITEM
"RTN","PSODEA",9,0)
 ;;2          SCHEDULE 2 ITEM
"RTN","PSODEA",10,0)
 ;;3          SCHEDULE 3 ITEM
"RTN","PSODEA",11,0)
 ;;4          SCHEDULE 4 ITEM
"RTN","PSODEA",12,0)
 ;;5          SCHEDULE 5 ITEM
"RTN","PSODEA",13,0)
 ;;6          LEGEND ITEM
"RTN","PSODEA",14,0)
 ;;9          OVER-THE-COUNTER
"RTN","PSODEA",15,0)
 ;;L          DEPRESSANTS AND STIMULANTS
"RTN","PSODEA",16,0)
 ;;A          NARCOTICS AND ALCOHOLICS
"RTN","PSODEA",17,0)
 ;;P          DATED DRUGS
"RTN","PSODEA",18,0)
 ;;I          INVESTIGATIONAL DRUGS
"RTN","PSODEA",19,0)
 ;;M          BULK COMPOUND ITEMS
"RTN","PSODEA",20,0)
 ;;C          CONTROLLED SUBSTANCES - NON NARCOTIC
"RTN","PSODEA",21,0)
 ;;R          RESTRICTED ITEMS
"RTN","PSODEA",22,0)
 ;;S          SUPPLY ITEMS
"RTN","PSODEA",23,0)
 ;;B          ALLOW REFILL (SCH. 3, 4, 5 ONLY)
"RTN","PSODEA",24,0)
 ;;W          NOT RENEWABLE
"RTN","PSODEA",25,0)
 ;;
"RTN","PSODEA",26,0)
EDIT ;INPUT XFORM FOR DEA FIELD IN DRUG FILE
"RTN","PSODEA",27,0)
 I X["B",(+X<3) W !,"The B designation is only valid for schedule 3, 4, 5 !",$C(7) K X Q
"RTN","PSODEA",28,0)
 Q
"RTN","PSODIR1")
0^24^B73077319^B72033927
"RTN","PSODIR1",1,0)
PSODIR1 ;IHS/DSD - ASKS DATA FOR RX ORDER ENTRY CONT. ;6/21/07 8:22am
"RTN","PSODIR1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,102,121,131,146,166,184,222,268,206**;DEC 1997;Build 39
"RTN","PSODIR1",3,0)
 ;Ext ref ^PS(55-DBIA 2228, ^PSDRUG(-DBIA 221
"RTN","PSODIR1",4,0)
PTSTAT(PSODIR) ;
"RTN","PSODIR1",5,0)
PTSTATEN K DIC,DR,DIE S PSODIR("FIELD")=0
"RTN","PSODIR1",6,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" K PSORX("PATIENT STATUS"),PSODIR("PATIENT STATUS") N PSOFNDRX,PSOFNDFL,PSOFNDPS D
"RTN","PSODIR1",7,0)
 .S PSOFNDFL=0 F PSOFNDPS=0:0 S PSOFNDPS=$O(^PS(53,PSOFNDPS)) Q:'PSOFNDPS!(PSOFNDFL)  D
"RTN","PSODIR1",8,0)
 ..S PSOFNDRX=$P($G(^PS(53,PSOFNDPS,0)),"^") S PSOFNDRX=$$UP^XLFSTR(PSOFNDRX) I PSOFNDRX="NON-VA" S PSOFNDFL=1 S (PSORX("PATIENT STATUS"),DIC("B"))=$P($G(^PS(53,PSOFNDPS,0)),"^")
"RTN","PSODIR1",9,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW",$G(PSORX("PATIENT STATUS"))="" W !,"Could not find a 'NON-VA' Patient Status in the RX PATIENT STATUS file (#53)!" D PSTPB D  S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",10,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODIR1",11,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBB
"RTN","PSODIR1",12,0)
 N PSOX
"RTN","PSODIR1",13,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^"),DIC("B")=PSORX("PATIENT STATUS")
"RTN","PSODIR1",14,0)
 S:$G(PSODIR("PATIENT STATUS"))]"" DIC("B")=PSODIR("PATIENT STATUS")
"RTN","PSODIR1",15,0)
TPBB ;
"RTN","PSODIR1",16,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"")
"RTN","PSODIR1",17,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSODIR1",18,0)
 S DIC("A")="RX PATIENT STATUS: "
"RTN","PSODIR1",19,0)
 S DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSODIR1",20,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" N PSOPSDIR,PSOFNDZZ,PSOPSUPA S (PSOPSDIR,PSOPSUPA)=0 D  I PSOPSDIR S:PSOPSUPA PSODIR("DFLG")=1 G:PSOPSUPA PTSTATX W ! D PSTPB G PTSTATEN
"RTN","PSODIR1",21,0)
 .I +Y'>0!($D(DTOUT))!($D(DUOUT)) S (PSOPSDIR,PSOPSUPA)=1 Q
"RTN","PSODIR1",22,0)
 .S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y,PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",23,0)
 .S PSOFNDZZ=$P($G(^PS(53,+Y,0)),"^") S PSOFNDZZ=$$UP^XLFSTR(PSOFNDZZ) I PSOFNDZZ'="NON-VA" S PSOPSDIR=1 K PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"),PSODIR("PTST NODE")
"RTN","PSODIR1",24,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBSC
"RTN","PSODIR1",25,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PTSTATX
"RTN","PSODIR1",26,0)
 I $D(DUOUT)!$D(DTOUT) S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",27,0)
 I Y=-1 W $C(7)," Required" G PTSTATEN
"RTN","PSODIR1",28,0)
 N PSOFNDX,PSOFNDXY,PSOFNDXX,PSOFNDYY
"RTN","PSODIR1",29,0)
 S PSOFNDXY=$G(Y),PSOFNDYY=$G(Y(0))
"RTN","PSODIR1",30,0)
 I '$G(PSOTPBFG),$G(PSOFROM)="NEW" S PSOFNDX=$P($G(^PS(53,+Y,0)),"^") S PSOFNDXX=$$UP^XLFSTR(PSOFNDX) I PSOFNDXX="NON-VA" K PSOFNDX,PSOFNDXY,PSOFNDYY,PSOFNDXX,Y W !!,"Cannot select 'NON-VA' Rx Patient Status!",! G PTSTATEN
"RTN","PSODIR1",31,0)
 S Y=$G(PSOFNDXY),Y(0)=$G(PSOFNDYY)
"RTN","PSODIR1",32,0)
 K PSOFNDXY,PSOFNDYY,PSOFNDX,PSOFNDXX
"RTN","PSODIR1",33,0)
 S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y
"RTN","PSODIR1",34,0)
 S PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",35,0)
TPBSC ;
"RTN","PSODIR1",36,0)
 I $G(PSOFDR),$P($G(OR0),"^",17)="C" G PTSTATX
"RTN","PSODIR1",37,0)
 L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T G PTSTATX
"RTN","PSODIR1",38,0)
 S DIE="55",DR="3////"_+Y,DA=PSODFN D ^DIE K DIE,DA,D0
"RTN","PSODIR1",39,0)
 L -^PS(55,PSODFN)
"RTN","PSODIR1",40,0)
PTSTATX K DTOUT,DUOUT,X,Y,DA
"RTN","PSODIR1",41,0)
 Q
"RTN","PSODIR1",42,0)
SIG(PSODIR) ;
"RTN","PSODIR1",43,0)
 I $G(PSOFDR),$G(PSODIR("SIG"))']"" D SIGOK G:$G(SIGOK)!($G(PSODIR("DFLG"))) SIGX
"RTN","PSODIR1",44,0)
 K DIR,DIC
"RTN","PSODIR1",45,0)
 S DIR(0)="52,10"
"RTN","PSODIR1",46,0)
 S:$G(PSODRUG("SIG"))]"" DIR("B")=PSODRUG("SIG")
"RTN","PSODIR1",47,0)
 S:$G(PSODIR("SIG"))]"" DIR("B")=PSODIR("SIG")
"RTN","PSODIR1",48,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") SIGX
"RTN","PSODIR1",49,0)
 S PSODIR("SIG")=Y,SIGOK=0 K SIG
"RTN","PSODIR1",50,0)
SIGX K X,Y
"RTN","PSODIR1",51,0)
 Q
"RTN","PSODIR1",52,0)
QTY(PSODIR) ;
"RTN","PSODIR1",53,0)
QTYA K DIR,DIC
"RTN","PSODIR1",54,0)
 I $G(CLOZPAT)=1 S DIR("A",1)="Patient Eligible for 14 day supply or 7 day supply with 1 refill"
"RTN","PSODIR1",55,0)
 I $G(CLOZPAT)=2 S DIR("A",1)="Patient Eligible 28 day supply or 14 day supply with 1 refill or 7 day supply with 3 refill"
"RTN","PSODIR1",56,0)
 S DIR(0)="52,7" S:$G(PSODRUG("IEN")) DIR("A")="QTY ( "_$G(PSODRUG("UNIT"))_" ) "_$S($P($G(^PSDRUG(+PSODRUG("IEN"),5)),"^")]"":$P(^PSDRUG(+PSODRUG("IEN"),5),"^"),1:"")
"RTN","PSODIR1",57,0)
 K QTYHLD I $G(PSODIR("QTY"))]"" S QTYHLD=PSODIR("QTY") K PSODIR("QTY")
"RTN","PSODIR1",58,0)
 D:'$G(PSOQTY) QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",59,0)
 I '$G(SPEED),$G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",60,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",61,0)
 I $G(SPEED),$G(PSODIR("QTY"))']"" S PSODIR("QTY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",7)
"RTN","PSODIR1",62,0)
 S:$G(PSODIR("QTY"))]"" DIR("B")=PSODIR("QTY")
"RTN","PSODIR1",63,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") QTYX
"RTN","PSODIR1",64,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("DAYS SUPPLY")),(Y/+PSODIR("DAYS SUPPLY")>PSODRUG("MAXDOSE")) D  G:$G(PSODIR("DFLG")) QTYX  G QTYA
"RTN","PSODIR1",65,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day" D DAYSEN
"RTN","PSODIR1",66,0)
 S PSODIR("QTY")=Y
"RTN","PSODIR1",67,0)
QTYX K X,Y
"RTN","PSODIR1",68,0)
 Q
"RTN","PSODIR1",69,0)
COPIES(PSODIR) ;
"RTN","PSODIR1",70,0)
 K DIR,DIC
"RTN","PSODIR1",71,0)
 S DIR(0)="52,10.6"
"RTN","PSODIR1",72,0)
 S DIR("B")=$S($G(PSODIR("COPIES"))]"":PSODIR("COPIES"),1:1)
"RTN","PSODIR1",73,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") COPIESX
"RTN","PSODIR1",74,0)
 S PSODIR("COPIES")=Y
"RTN","PSODIR1",75,0)
COPIESX K X,Y
"RTN","PSODIR1",76,0)
 Q
"RTN","PSODIR1",77,0)
DAYS(PSODIR) ;
"RTN","PSODIR1",78,0)
DAYSEN K DIR,DIC
"RTN","PSODIR1",79,0)
 S DIR(0)="N^1:"_$S($G(CLOZPAT)=2:28,$G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:90)
"RTN","PSODIR1",80,0)
 S DIR("B")=$S($D(CLOZPAT)&('$G(PSODIR("DAYS SUPPLY"))):7,$G(PSODIR("DAYS SUPPLY"))]"":PSODIR("DAYS SUPPLY"),$P($G(PSODIR("PTST NODE")),"^",3):$P(PSODIR("PTST NODE"),"^",3),1:30)
"RTN","PSODIR1",81,0)
 S DIR("A")="DAYS SUPPLY",DIR("?")="Enter a whole number between 1 and "_$S($G(CLOZPAT)=2:28,$G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:90)
"RTN","PSODIR1",82,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") DAYSX
"RTN","PSODIR1",83,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("QTY"))]"",(+PSODIR("QTY")/Y>PSODRUG("MAXDOSE")) W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day" G DAYSEN
"RTN","PSODIR1",84,0)
 S PSODIR("DAYS SUPPLY")=Y D:$G(PSOFROM)="NEW"
"RTN","PSODIR1",85,0)
 .K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",86,0)
 .I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",87,0)
 .K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",88,0)
 S:$G(CLOZPAT)=0 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",89,0)
 D:$G(CLOZPAT)=2
"RTN","PSODIR1",90,0)
 .S:PSODIR("DAYS SUPPLY")=28 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",91,0)
 .S:PSODIR("DAYS SUPPLY")=14 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=1
"RTN","PSODIR1",92,0)
 .S:PSODIR("DAYS SUPPLY")=7 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=3
"RTN","PSODIR1",93,0)
 D:$G(CLOZPAT)=1
"RTN","PSODIR1",94,0)
 .S:PSODIR("DAYS SUPPLY")=14 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",95,0)
 .S:PSODIR("DAYS SUPPLY")=7 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=1
"RTN","PSODIR1",96,0)
 K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",97,0)
 I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",98,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",99,0)
DAYSX K X,Y
"RTN","PSODIR1",100,0)
 Q
"RTN","PSODIR1",101,0)
REFILL(PSODIR) ;
"RTN","PSODIR1",102,0)
 I $G(OR0) G REFOR
"RTN","PSODIR1",103,0)
 S PSODIR("CS")=0 K DIR,DIC,PSOX
"RTN","PSODIR1",104,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSODIR("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSODIR("CS"),"^",2)=1
"RTN","PSODIR1",105,0)
 I PSODIR("CS") D
"RTN","PSODIR1",106,0)
 .S PSOX=5,PSOX1=$S($P($G(PSODIR("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSODIR("PTST NODE")),"^",4)),PSOX=$S(PSOX1=5:PSOX,1:PSOX1)
"RTN","PSODIR1",107,0)
 .S PSOX=$S('PSOX:0,PSODIR("DAYS SUPPLY")=90:1,1:PSOX),PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR1",108,0)
 E  D
"RTN","PSODIR1",109,0)
 .S PSOX=11,PSOX1=$S($P($G(PSODIR("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSODIR("PTST NODE")),"^",4)),PSOX=$S(PSOX1=11:PSOX,1:PSOX1)
"RTN","PSODIR1",110,0)
 .S PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR1",111,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) D  G REFILLX
"RTN","PSODIR1",112,0)
 .I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2)!'$O(^PSRX(+$G(PSODIR("IRXN")),1,0))!('$G(PSOLOKED)) D  Q
"RTN","PSODIR1",113,0)
 ..S VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["F":"this drug.",1:"Narcotics.") W !,VALMSG,!
"RTN","PSODIR1",114,0)
 ..S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR1",115,0)
 ..Q
"RTN","PSODIR1",116,0)
 .;reset refills to the # given
"RTN","PSODIR1",117,0)
 .D RFRSET^PSODIR2
"RTN","PSODIR1",118,0)
 .Q
"RTN","PSODIR1",119,0)
 I $P($G(PSODIR("CS")),"^",2)=1 W !,"No refills allowed on Schedule 2 drugs...",! S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0 G REFILLX
"RTN","PSODIR1",120,0)
 I $D(CLOZPAT) S PSOX=$S($G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,1:0)
"RTN","PSODIR1",121,0)
 S DIR(0)="N^"_$S($G(RFTT):RFTT,1:0)_":"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSODIR1",122,0)
 S DIR("B")=$S($G(COPY):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR1",123,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the DAYS SUPPLY field."
"RTN","PSODIR1",124,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") REFILLX
"RTN","PSODIR1",125,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR1",126,0)
REFILLX S:$G(PSODIR("# OF REFILLS"))']"" PSODIR("# OF REFILLS")=$S($G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSOX1)]""&($G(PSOX)>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR1",127,0)
 K X,Y,PSOX,PSOX1,PSDY,PSDY1,DEA,PSOCS
"RTN","PSODIR1",128,0)
 Q
"RTN","PSODIR1",129,0)
 ;OERR CALL
"RTN","PSODIR1",130,0)
REFOR ;
"RTN","PSODIR1",131,0)
 D REFOR^PSODIR3
"RTN","PSODIR1",132,0)
 G REFILLX
"RTN","PSODIR1",133,0)
 Q
"RTN","PSODIR1",134,0)
DIR ;
"RTN","PSODIR1",135,0)
 S (PSODIR("FIELD"),PSODIR("DFLG"))=0
"RTN","PSODIR1",136,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR1",137,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR1",138,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",139,0)
 I $D(DIRUT)!($D(DIROUT)),$G(SPEED) S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",140,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR1",141,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT
"RTN","PSODIR1",142,0)
 Q
"RTN","PSODIR1",143,0)
JUMP ;
"RTN","PSODIR1",144,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR1",145,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR1",146,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR1",147,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR1",148,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR1",149,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR1",150,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR1",151,0)
JUMPX S X="^"_X
"RTN","PSODIR1",152,0)
 Q
"RTN","PSODIR1",153,0)
SIGOK ;review and decide on oerr sig
"RTN","PSODIR1",154,0)
 I '$O(SIG(0)) S SIGOK=0 Q
"RTN","PSODIR1",155,0)
 K SIGOK W !,"SIG: "
"RTN","PSODIR1",156,0)
 F SIG=0:0 S SIG=$O(SIG(SIG)) W SIG(SIG)_" ",!?5 Q:'$O(SIG(SIG))
"RTN","PSODIR1",157,0)
 K DIR,DIRUT,DUOUT,DTOUT S DIR("B")="YES",DIR(0)="Y",DIR("A")="Is this SIG correct" D ^DIR K DIR I $D(DIRUT) S PSODIR("DFLG")=1 K DIRUT,DUOUT,DTOUT Q
"RTN","PSODIR1",158,0)
 S SIGOK=Y I Y K PSODIR("SIG")
"RTN","PSODIR1",159,0)
 Q
"RTN","PSODIR1",160,0)
PSTPB ;
"RTN","PSODIR1",161,0)
 W !,"New orders entered through this option must have a Patient Status of 'NON-VA'!",!
"RTN","PSODIR1",162,0)
 Q
"RTN","PSODIR3")
0^6^B27252502^B26563927
"RTN","PSODIR3",1,0)
PSODIR3 ;ISC-BIRM/SAB - rx order entry contd ;4/25/07 8:28am
"RTN","PSODIR3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,46,184,222,206**;DEC 1997;Build 39
"RTN","PSODIR3",3,0)
 ;
"RTN","PSODIR3",4,0)
EXP(PSODIR) ;
"RTN","PSODIR3",5,0)
 K DIC,DIR
"RTN","PSODIR3",6,0)
 I $G(PSODRUG("EXPIRATION DATE"))]"" S Y=PSODRUG("EXPIRATION DATE") X ^DD("DD") S PSORX("EXPIRATION DATE")=Y
"RTN","PSODIR3",7,0)
 S DIR("A")="EXPIRES",DIR("B")=$S($G(PSORX("EXPIRATION DATE"))]"":PSORX("EXPIRATION DATE"),1:"T+6M")
"RTN","PSODIR3",8,0)
 S DIR(0)="D^NOW::EX",DIR("?")="Both the month and date are required." D ^DIR
"RTN","PSODIR3",9,0)
 G:PSODIR("DFLG")!PSODIR("FIELD") EXPX
"RTN","PSODIR3",10,0)
 S PSODIR("EXPIRATION DATE")=Y
"RTN","PSODIR3",11,0)
EXPX K X,Y
"RTN","PSODIR3",12,0)
 Q
"RTN","PSODIR3",13,0)
 ;
"RTN","PSODIR3",14,0)
MW(PSODIR) ;
"RTN","PSODIR3",15,0)
 K DIR,DIC
"RTN","PSODIR3",16,0)
 S DIR(0)="52,11"
"RTN","PSODIR3",17,0)
 S DIR("B")=$S($G(PSORX("MAIL/WINDOW"))]"":PSORX("MAIL/WINDOW"),1:"WINDOW")
"RTN","PSODIR3",18,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") MWX
"RTN","PSODIR3",19,0)
 I $G(Y(0))']"" S PSODIR("DFLG")=1 G MWX
"RTN","PSODIR3",20,0)
 S PSODIR("MAIL/WINDOW")=Y,PSORX("MAIL/WINDOW")=Y(0)
"RTN","PSODIR3",21,0)
 I $G(PSORX("EDIT"))]"",PSODIR("MAIL/WINDOW")'="W" K PSODIR("METHOD OF PICK-UP")
"RTN","PSODIR3",22,0)
MW1 G:PSODIR("MAIL/WINDOW")'="W"!('$P($G(PSOPAR),"^",12)) MWX
"RTN","PSODIR3",23,0)
 S DIR(0)="52,35O"
"RTN","PSODIR3",24,0)
 S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP")
"RTN","PSODIR3",25,0)
 D DIR G:PSODIR("DFLG") MWX
"RTN","PSODIR3",26,0)
 I X[U W !,"Cannot jump to another field ..",! G MW1
"RTN","PSODIR3",27,0)
 S (PSODIR("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y
"RTN","PSODIR3",28,0)
MWX K X,Y
"RTN","PSODIR3",29,0)
 Q
"RTN","PSODIR3",30,0)
 ;
"RTN","PSODIR3",31,0)
FILLDT(PSODIR) ;
"RTN","PSODIR3",32,0)
 K DIR,DIC
"RTN","PSODIR3",33,0)
 S DIR("A")="FILL DATE",DIR("B")=$S($G(PSORX("FILL DATE"))]"":PSORX("FILL DATE"),1:"TODAY")
"RTN","PSODIR3",34,0)
 S DIR(0)="D^"_$S($G(PSODIR("ISSUE DATE"))]"":PSODIR("ISSUE DATE"),1:DT)_$S($G(DUZ("AG"))="I":":"_DT_":EX",1:"::EX")
"RTN","PSODIR3",35,0)
 S DIR("?",1)="The earliest fill date allowed is determined by the ISSUE DATE,"
"RTN","PSODIR3",36,0)
 S DIR("?",2)="the FILL DATE cannot be before the ISSUE DATE."
"RTN","PSODIR3",37,0)
 S DIR("?")="Both the month and date are required."
"RTN","PSODIR3",38,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") FILLDTX
"RTN","PSODIR3",39,0)
 S PSODIR("FILL DATE")=Y
"RTN","PSODIR3",40,0)
 X ^DD("DD") S PSORX("FILL DATE")=Y
"RTN","PSODIR3",41,0)
FILLDTX K X,Y
"RTN","PSODIR3",42,0)
 Q
"RTN","PSODIR3",43,0)
 ;
"RTN","PSODIR3",44,0)
CLERK(PSODIR) ;
"RTN","PSODIR3",45,0)
 I $G(DUZ("AG"))'="I",$G(DUZ) S PSODIR("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^") G CLERKX
"RTN","PSODIR3",46,0)
 K DIR,DIC
"RTN","PSODIR3",47,0)
 S DIR("A")="CLERK",DIR("B")=$S($G(PSORX("CLERK CODE"))]"":PSORX("CLERK CODE"),1:$P($G(^VA(200,DUZ,0)),"^",2)),DIR(0)="52,16"
"RTN","PSODIR3",48,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") CLERKX
"RTN","PSODIR3",49,0)
 S PSODIR("CLERK CODE")=+Y,PSORX("CLERK CODE")=$P(Y,"^")
"RTN","PSODIR3",50,0)
CLERKX Q
"RTN","PSODIR3",51,0)
 ;
"RTN","PSODIR3",52,0)
DIR ;
"RTN","PSODIR3",53,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR3",54,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR3",55,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR3",56,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR3",57,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR3",58,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR3",59,0)
 Q
"RTN","PSODIR3",60,0)
 ;
"RTN","PSODIR3",61,0)
JUMP ;
"RTN","PSODIR3",62,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR3",63,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR3",64,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR3",65,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR3",66,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR3",67,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR3",68,0)
JUMPX S X="^"_X
"RTN","PSODIR3",69,0)
 Q
"RTN","PSODIR3",70,0)
 ;Continued from PSODIR1, Tag REFOR, Added PSOCS set and changed G REFILLX references to a QUIT
"RTN","PSODIR3",71,0)
REFOR ;
"RTN","PSODIR3",72,0)
 F DEA=1:1 Q:$E($G(PSODRUG("DEA")),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOCS,"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOCS,"^",2)=1
"RTN","PSODIR3",73,0)
 I $G(PSOCS) D
"RTN","PSODIR3",74,0)
 .S (PSOX,PSOMAX)=$S($G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:5)
"RTN","PSODIR3",75,0)
 .S PSOX=$S('PSOX:0,PSODIR("DAYS SUPPLY")=90:1,1:PSOX),PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR3",76,0)
 E  D
"RTN","PSODIR3",77,0)
 .S (PSOX,PSOMAX)=$S($G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,$D(CLOZPAT):0,1:11)
"RTN","PSODIR3",78,0)
 .S PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR3",79,0)
 K PSOELSE I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D  Q
"RTN","PSODIR3",80,0)
 .S VALMSG="No refills allowed on "_$S($G(PSODRUG("DEA"))["A":"this narcotic drug.",1:"this drug.")
"RTN","PSODIR3",81,0)
 .W !,VALMSG,!
"RTN","PSODIR3",82,0)
 .S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR3",83,0)
 I $D(CLOZPAT) D
"RTN","PSODIR3",84,0)
 .S PSOX=$S($G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,1:0)
"RTN","PSODIR3",85,0)
 .S (PSODIR("# OF REFILLS"),PSODIR("N# REF"))=PSOX
"RTN","PSODIR3",86,0)
 S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSODIR3",87,0)
 S DIR("B")=$S($G(POERR)&($G(PSODIR("# OF REFILLS"))):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR3",88,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the DAYS SUPPLY field."
"RTN","PSODIR3",89,0)
 D DIR Q:PSODIR("DFLG")!PSODIR("FIELD")
"RTN","PSODIR3",90,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR3",91,0)
 Q
"RTN","PSOHELP")
0^7^B51838046^B51249011
"RTN","PSOHELP",1,0)
PSOHELP ;BHAM ISC/SAB-outpatient utility routine ; 10/17/07 7:41am
"RTN","PSOHELP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,23,29,48,46,117,131,222,268,206**;DEC 1997;Build 39
"RTN","PSOHELP",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOHELP",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOHELP",5,0)
 ;External reference ^PS(56 supported by DBIA 2229
"RTN","PSOHELP",6,0)
 ;External reference ^PSNPPIP supported by DBIA 2261
"RTN","PSOHELP",7,0)
 ;
"RTN","PSOHELP",8,0)
XREF D XREF^PSOHELP3
"RTN","PSOHELP",9,0)
 Q
"RTN","PSOHELP",10,0)
SIG ;checks PI for RXs
"RTN","PSOHELP",11,0)
 K VALMSG
"RTN","PSOHELP",12,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",13,0)
SIGONE K INS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EN S Z1=$P(X," ",Z0) D  G:'$D(X) EN
"RTN","PSOHELP",14,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",15,0)
 .D:$D(X)&($G(Z1)]"")  S INS1=$G(INS1)_" "_Z1
"RTN","PSOHELP",16,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",17,0)
 ..I $G(^PS(51,+Y,9))]"" S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",18,0)
EN K Z1,Z0
"RTN","PSOHELP",19,0)
 Q
"RTN","PSOHELP",20,0)
SSIG ;other lang. mods
"RTN","PSOHELP",21,0)
 K VALMSG
"RTN","PSOHELP",22,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",23,0)
 K SINS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EX S Z1=$P(X," ",Z0) D  G:'$D(X) EX
"RTN","PSOHELP",24,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",25,0)
 .D:$D(X)&($G(Z1)]"")  S SINS1=$G(SINS1)_" "_Z1
"RTN","PSOHELP",26,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",27,0)
 ..I $G(^PS(51,+Y,4))]"" S Z1=^PS(51,+Y,4) ;,Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",28,0)
EX K Z1,Z0
"RTN","PSOHELP",29,0)
 Q
"RTN","PSOHELP",30,0)
QTY ;Check quantity dispensed against inventory
"RTN","PSOHELP",31,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOHELP",32,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):+$P(^(0),"^",6),1:0)
"RTN","PSOHELP",33,0)
 I $D(^PSDRUG("AQ",Z0)),(+X'=X) K X,Z0 Q
"RTN","PSOHELP",34,0)
 S Z1=$S($D(^PSDRUG(Z0,660.1)):^(660.1),1:0)+(+X) D:X>Z1 EN^DDIOL("  Greater Than Current Inventory!","","$C(7)") K Z1
"RTN","PSOHELP",35,0)
 S ZX=X,ZZ0=$G(D0),D0=Z0
"RTN","PSOHELP",36,0)
 S Y(18,2)=$S($D(^PSDRUG(D0,660)):^(660),1:""),Y(18,1)=$S($D(^(660.1)):^(660.1),1:"")
"RTN","PSOHELP",37,0)
 S X=$P(Y(18,1),"^",1),X=$S($P(Y(18,2),"^",5):X/$P(Y(18,2),"^",5),1:"*******")
"RTN","PSOHELP",38,0)
 S X=$J(X,0,2)
"RTN","PSOHELP",39,0)
 D:X<$S($D(^PSDRUG(Z0,660)):+^(660),1:1) EN^DDIOL("  Below Reorder Level.","","$C(7)") S X=ZX,D0=$G(ZZ0) K ZZ0,Z0,ZX
"RTN","PSOHELP",40,0)
 Q
"RTN","PSOHELP",41,0)
HELP ;qty help
"RTN","PSOHELP",42,0)
 G:$G(PSOFDR) HLP
"RTN","PSOHELP",43,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):$P(^PSRX(DA,0),"^",6),1:0)
"RTN","PSOHELP",44,0)
HLP S Z0=+$G(PSODRUG("IEN"))  I $D(^PSDRUG("AQ",Z0)) D EN^DDIOL("This is a CMOP drug. The quantity may not contain alpha characters (i.e.; ML)","","!!") D EN^DDIOL("or more than two fractional decimal places (i.e.; .01).","","!") D  K Z0 Q
"RTN","PSOHELP",45,0)
 .D EN^DDIOL("Enter a number between 0 and 99999999 inclusive. The total entry cannot","","!") D EN^DDIOL("exceed 11 characters.","","!")
"RTN","PSOHELP",46,0)
 D EN^DDIOL("Enter a whole number between 0 and 99999999 inclusive.  Alpha characters are","","!!")
"RTN","PSOHELP",47,0)
 D EN^DDIOL("not allowed, and the entry cannot exceed 11 characters, or contain more than","","!") D EN^DDIOL("two fractional decimal places (i.e.; .01).","","!")
"RTN","PSOHELP",48,0)
 K Z0
"RTN","PSOHELP",49,0)
 Q
"RTN","PSOHELP",50,0)
ADD ;add/edited local drug/drug interactions
"RTN","PSOHELP",51,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEMQL",DLAYGO=56
"RTN","PSOHELP",52,0)
 S (DIC,DIE)="^PS(56,",DIC("S")="I '$P(^(0),""^"",5)" D ^DIC G:"^"[X QU G:Y<0 ADD S DA=+Y,DR="[PSO INTERACT]" L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G ADD
"RTN","PSOHELP",53,0)
 D ^DIE L:$G(DA) -^PS(56,DA) K DA G ADD
"RTN","PSOHELP",54,0)
QU L -^PS(56,DA) K X,DIC,DIE,DA
"RTN","PSOHELP",55,0)
 Q
"RTN","PSOHELP",56,0)
CRI ;change drug interaction severity to critical from significant
"RTN","PSOHELP",57,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEQM",(DIC,DIE)="^PS(56,",DIC("S")="I $P(^(0),""^"",4)=2" D ^DIC G:"^"[X QU G:Y<0 CRI S DA=+Y,DR=3
"RTN","PSOHELP",58,0)
 L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G CRI
"RTN","PSOHELP",59,0)
 D ^DIE L -^PS(56,DA) K DA G CRI
"RTN","PSOHELP",60,0)
 G QU
"RTN","PSOHELP",61,0)
 Q
"RTN","PSOHELP",62,0)
MAX S:$G(EXH) P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)),PTDY=$P($G(^(0)),"^",3),PTRF=$P($G(^(0)),"^",4)
"RTN","PSOHELP",63,0)
 S PSODEA=$P(^PSDRUG(P(5),0),"^",3),CS=0
"RTN","PSOHELP",64,0)
 I $D(CLOZPAT) S MAX=$S(CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=14):1,CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=7):3,CLOZPAT=1&($P(^PSRX(DA,0),"^",8)=7):1,1:0),MIN=0 Q
"RTN","PSOHELP",65,0)
 I PSODEA["A"&(PSODEA'["B")!(PSODEA["F")!(PSODEA[1)!(PSODEA[2) D EN^DDIOL("No refills allowed on "_$S(PSODEA["A":"this narcotic drug.",1:"this drug."),"","!") D EN^DDIOL(" ","","!") S $P(^PSRX(DA,0),"^",9)=0 K X,Y,PSODEA,CS,PTST Q
"RTN","PSOHELP",66,0)
 F DEA=1:1 Q:$E(PSODEA,DEA)=""  I $E(+PSODEA,DEA)>1,$E(+PSODEA,DEA)<6 S CS=1
"RTN","PSOHELP",67,0)
 S PSOELSE=CS I PSOELSE D
"RTN","PSOHELP",68,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOT=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOHELP",69,0)
 .S PSOT=$S('PSOT:0,P(7)=90:1,1:PSOT),PSDY1=$S(P(7)<60:5,P(7)'<60&(P(7)'>89):2,P(7)=90:1,1:0) S MAX=$S(PSOT'>PSDY1:PSOT,1:PSDY1)
"RTN","PSOHELP",70,0)
 I 'PSOELSE D
"RTN","PSOHELP",71,0)
 .S PSOX1=PTRF,PSOT=$S(PSOX1=11:11,1:PSOX1),PSOT=$S('PSOT:0,P(7)=90:3,1:PSOT)
"RTN","PSOHELP",72,0)
 .S PSDY1=$S(P(7)<60:11,P(7)'<60&(P(7)'>89):5,P(7)=90:3,1:0) S MAX=$S(PSOT'>PSDY1:PSOT,1:PSDY1)
"RTN","PSOHELP",73,0)
 K PSODEA,PSOELSE,PSOT,PSOX1,PSDY,PSDY1,DEA,CS
"RTN","PSOHELP",74,0)
 I $D(X) S MIN=0 I $D(DA) F REF=0:0 S REF=$O(^PSRX(DA,1,REF)) Q:'REF  I $D(^(REF,0)) S MIN=MIN+1
"RTN","PSOHELP",75,0)
 I $G(EXH) D EN^DDIOL("Enter a number Between "_MIN_" AND "_MAX_".","","!?10") K P(2),P(5),P(7),MAX,MAX1,MIN,REF
"RTN","PSOHELP",76,0)
 Q
"RTN","PSOHELP",77,0)
 ;
"RTN","PSOHELP",78,0)
REF S PSRF=X,P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)) S PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOHELP",79,0)
 D MAX Q:'$D(X)  I (+X'=X)!(X<0)!(X>MAX)!(X?.E1"."1N.N) D EN^DDIOL(" ** MAX REFILLS ALLOWED ARE "_MAX_" ** ","","$C(7)") K X
"RTN","PSOHELP",80,0)
 I $D(X),X<MIN D EN^DDIOL(" ** PATIENT HAS ALREADY RECEIVED "_MIN_" REFILLS ** ","","$C(7)") K X
"RTN","PSOHELP",81,0)
 D DAYS^PSOUTLA
"RTN","PSOHELP",82,0)
 K PTDY,PTRF,MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,MIN,REF,P(2),P(7),P(5),MAX1
"RTN","PSOHELP",83,0)
 Q
"RTN","PSOHELP",84,0)
PAT ;patient field screen in file 52
"RTN","PSOHELP",85,0)
 N DIC,DIE S DFN=X D INP^VADPT,DEM^VADPT
"RTN","PSOHELP",86,0)
 I $P(VADM(6),"^") D EN^DDIOL("PATIENT DIED "_$P(VADM(6),"^",2),"","$C(7),!?10") D EN^DDIOL(" ","","!") K X,DFN Q
"RTN","PSOHELP",87,0)
 I $P(VAIN(4),"^") D EN^DDIOL("PATIENT IS AN INPATIENT ON WARD "_$P(VAIN(4),"^",2)_" !!","","$C(7),!?10") K DIR D DIR K VA,VADN,VAIN Q
"RTN","PSOHELP",88,0)
 E  S X=DFN K DFN,DIRUT,DTOUT,DUOUT
"RTN","PSOHELP",89,0)
 Q
"RTN","PSOHELP",90,0)
DIR S DIR(0)="Y",DIR("B")="YES",DIR("A")="DO YOU WISH TO CONTINUE" D ^DIR K DIR
"RTN","PSOHELP",91,0)
 K:'Y X S:Y X=DFN K DFN,DIRUT,DTOUT,DUOUT,VA,VADM,VAIN
"RTN","PSOHELP",92,0)
 Q
"RTN","PSOHELP",93,0)
BG ;prevents editing of display groups with patients from name to ticket
"RTN","PSOHELP",94,0)
 S $P(^PS(59.3,DA,0),"^",2)=PDP W !,$C(7),"The display cannot be changed from NAME to TICKET when patients are",!,"already in the Display Group.  All patients must be purged and re-entered.",!,"Ticket numbers must be issued !!",! K Y,PDP
"RTN","PSOHELP",95,0)
 Q
"RTN","PSOHELP",96,0)
CLNAP ;quits action profile
"RTN","PSOHELP",97,0)
 Q
"RTN","PSOHELP",98,0)
PRMI ;prints medication instruction sheets.  select drug.
"RTN","PSOHELP",99,0)
 S X="PSNPPIP" X ^%ZOSF("TEST") I '$T S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",100,0)
 I $G(PSODFN) N PSNDFN S PSNDFN=PSODFN
"RTN","PSOHELP",101,0)
 W !! K PSNPPI("MESSAGE") D FULL^VALM1,^PSNPPIP S VALMBCK="R"
"RTN","PSOHELP",102,0)
 I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",103,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",104,0)
 Q
"RTN","PSOHELP",105,0)
PRMID ;prints medication instruction sheets.  pass in drug.
"RTN","PSOHELP",106,0)
 I $T(ENOP^PSNPPIP)']"" S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",107,0)
 K PSNPPI("MESSAGE") D FULL^VALM1
"RTN","PSOHELP",108,0)
 W !! D ENOP^PSNPPIP($P(RX0,"^",6),$G(^PSRX(RXN,"TN")),$P(RX0,"^"),PSODFN)
"RTN","PSOHELP",109,0)
 S VALMBCK="R" I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",110,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",111,0)
 Q
"RTN","PSOLBL")
0^8^B70822934^B70864785
"RTN","PSOLBL",1,0)
PSOLBL ;BIR/SAB/RTR-BOTTLE LABEL ;5/9/07 8:57am
"RTN","PSOLBL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,19,30,36,47,71,92,120,157,244,206**;DEC 1997;Build 39
"RTN","PSOLBL",3,0)
 ;DBIAs PSDRUG-221, PS(55-2228, IBARX-125, PSXSRP-2201, %ZIS-3435, DPT-3097
"RTN","PSOLBL",4,0)
 ;
"RTN","PSOLBL",5,0)
 ;*244 rem test for part fill when testing status > 11
"RTN","PSOLBL",6,0)
 ;
"RTN","PSOLBL",7,0)
DQ I $D(PSOIOS),PSOIOS]"" D DEVBAR^PSOBMST
"RTN","PSOLBL",8,0)
 I $G(PSOBAR0)]"",$G(PSOBAR1)]"",$D(^PS(59,PSOSITE,1)) S PSOBARS=1
"RTN","PSOLBL",9,0)
DQ1 D ^PSOLBL4
"RTN","PSOLBL",10,0)
 I $G(IOST(0)),$D(^%ZIS(2,IOST(0),55,"B","LL")) G ^PSOLLLI
"RTN","PSOLBL",11,0)
 G:'$D(PPL) HLEX G:($P($G(PSOPAR),"^",30)=2)&('$G(PSOEXREP)) HLEX K RXFLX S PSOCKHN=","_$G(PPL) S PSRESOLV=+PPL D CHECK F PI=1:1  D  S RX=$P(PPL,",",PI) D C Q:$G(PSOLAPPL)  D:$G(PSDFNFLG) TRAIL^PSOLBL2 K RXP,REPRINT
"RTN","PSOLBL",12,0)
 .S (PSDFNFLG,PSOLAPPL)=0 S NEXTRX=$P(PPL,",",(PI+1)) I NEXTRX=""!(NEXTRX=",") S PSOLAPPL=1 Q
"RTN","PSOLBL",13,0)
 .I PSOPDFN'=$P(^PSRX(NEXTRX,0),"^",2) S PSDFNFLG=1,PSOPDFN=$P(^PSRX(NEXTRX,0),"^",2) Q
"RTN","PSOLBL",14,0)
 I $P(^PS(59,PSOSITE,1),"^",28) D ^PSOLBLN2
"RTN","PSOLBL",15,0)
 D:'$P(^PS(59,PSOSITE,1),"^",28) ^PSOLBLS
"RTN","PSOLBL",16,0)
DQ5 I $D(^TMP($J,"PSOCP",DFN)),'$P(^PS(59,PSOSITE,1),"^",28) D INV^PSOCPE
"RTN","PSOLBL",17,0)
HLEX K RXPI,PSORX,RXP,PSOIOS,PSOLAPPL,XXX,COPAYVAR,TECH,PHYS,MFG,NURSE,STATE,SIDE,COPIES,EXDT,ISD,PSOINST,RXN,RXY,VADT,DEA,WARN,FDT,QTY,PATST,PDA,PS,PS1,PS2,PSL,PSNP,INRX,RR,XTYPE,SSNP,SSNPN,PNM,ADDR,PSODBQ,PSOLASTF,PSRESOLV,PSOEXREP,PSOSXQ
"RTN","PSOLBL",18,0)
 K ^TMP($J,"PSOCP",+$G(PSOCPN)),PSOCPN,PSOLBLDR,PSOLBLPS,PSOLBLCP,RXPR,RXRP,RXRS,PSOCKHN,RXFLX,PSOLAPPL,PSOPDFN,PSDFNFLG,PSOZERO,NEXTRX,PSOBLALL,STA S:'$G(PSOSUREP)&('$G(PSOSUSPR)) ZTREQ="@" Q
"RTN","PSOLBL",19,0)
C I $G(IOST(0)),$D(^%ZIS(2,IOST(0),55,"B","LL")) G C^PSOLLLI
"RTN","PSOLBL",20,0)
 U IO S X=$S('$P(^PS(59,PSOSITE,1),"^",28):132,1:158) X ^%ZOSF("RM") Q:'$D(^PSRX(RX,0))
"RTN","PSOLBL",21,0)
 S:$G(PSOBLALL) PSOBLRX=RX
"RTN","PSOLBL",22,0)
 S:$D(RXRP(RX)) REPRINT=1 S:$D(RXPR(RX)) RXP=RXPR(RX)
"RTN","PSOLBL",23,0)
 I $G(PSOSUREP)!($G(PSOEXREP)) S REPRINT=1 S:'$G(RXRP(RX)) RXRP(RX)=1
"RTN","PSOLBL",24,0)
 S RXY=^PSRX(RX,0),RXSTA=$P(^PSRX(RX,"STA"),"^") I RXSTA>11 D AL("QT") K RXY,RXP,REPRINT Q         ;*244
"RTN","PSOLBL",25,0)
 I RXSTA=3 D AL("QT") K RXY,RXP,REPRINT Q
"RTN","PSOLBL",26,0)
 I $G(RXPR(RX)),'$D(^PSRX(RX,"P",RXP,0)) K RXY,RXP,REPRINT Q
"RTN","PSOLBL",27,0)
 I $P($G(RXFL(RX)),"^"),'$D(^PSRX(RX,1,$P($G(RXFL(RX)),"^"),0)) K RXY,RXP,REPRINT Q
"RTN","PSOLBL",28,0)
 I $G(PSODBQ)!($G(RXRS(RX))) S RR=$O(^PS(52.5,"B",RX,0)) Q:'RR  I $G(^PS(52.5,RR,"P"))=1 K RXY,RXP,REPRINT Q
"RTN","PSOLBL",29,0)
 I $G(RXRS(RX))!($G(PSOPULL)) S PSOSXQ=0 N DR,DA,DIE D  I $G(PSOSXQ) K RXY,RXP,REPRINT Q
"RTN","PSOLBL",30,0)
 .S DA=$O(^PS(52.5,"B",RX,0)) Q:'DA  S A=$P($G(^PS(52.5,DA,0)),"^",7) Q:A=""
"RTN","PSOLBL",31,0)
 .I A="Q" S DIE="^PS(52.5,",DR="3////P" D ^DIE Q
"RTN","PSOLBL",32,0)
 .K RXRS(RX) S PSOSXQ=1
"RTN","PSOLBL",33,0)
 I $G(PSRESOLV)=RX D ENLBL^PSOBSET K PSRESOLV
"RTN","PSOLBL",34,0)
 I RXSTA'=4 D:$G(PSOSUSPR) AREC^PSOSUTL D:$G(PSOPULL)!($G(RXRS(RX))) AREC1^PSOSUTL D:$G(PSOSUREP) AREC^PSOSUSRP D:$G(PSXREP) AREC^PSXSRP
"RTN","PSOLBL",35,0)
 K ^UTILITY("DIQ1",$J) S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIC
"RTN","PSOLBL",36,0)
 S RXN=$P(RXY,"^"),ISD=$P(RXY,"^",13),RXF=0,DFN=+$P(RXY,"^",2),SIG=$P($G(^PSRX(RX,"SIG")),"^"),ISD=$E(ISD,4,5)_"/"_$E(ISD,6,7)_"/"_($E(ISD,1,3)+1700),ZY=0,$P(LINE,"_",28)="_"
"RTN","PSOLBL",37,0)
 S PSOLBLPS=+$P(RXY,"^",3),PSOLBLDR=+$P(RXY,"^",6)
"RTN","PSOLBL",38,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0) S FDT=$P(^PSRX(RX,2),"^",2),PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:""),PS1=$S($D(^(1)):^(1),1:""),PSOSITE7=$P(^("IB"),"^")
"RTN","PSOLBL",39,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLBL",40,0)
 S (EXPDT,EXDT)=$P(^PSRX(RX,2),"^",6),EXDT=$S('EXDT:"",1:$E(EXDT,4,5)_"/"_$E(EXDT,6,7)_"/"_($E(EXDT,1,3)+1700))
"RTN","PSOLBL",41,0)
 S COPIES=$S($P($G(RXRP(RX)),"^",2):$P($G(RXRP(RX)),"^",2),$P(RXY,"^",18)]"":$P(RXY,"^",18),1:1)
"RTN","PSOLBL",42,0)
 K PSOCKHNX S PSOCKHL=$L(RX),PSOCKHN=$E($G(PSOCKHN),(PSOCKHL+2),999) D  K PSOCKHNX,PSOCKHL,PSOCKHA
"RTN","PSOLBL",43,0)
 .S PSOCKHA=","_RX_","
"RTN","PSOLBL",44,0)
 .I PSOCKHN'[PSOCKHA Q
"RTN","PSOLBL",45,0)
 .S PSOCKHA=$E(PSOCKHA,1,($L(PSOCKHA)-1))
"RTN","PSOLBL",46,0)
 .S PSOCKHNX=$L(PSOCKHN,PSOCKHA)-1
"RTN","PSOLBL",47,0)
 .I +$G(PSOCKHNX)>0 D DOUB
"RTN","PSOLBL",48,0)
 I $O(^PSRX(RX,1,0)),$G(RXFL(RX))'=0 S $P(^PSRX(RX,3),"^",6)="" K ^PSRX(RX,"DAI"),^PSRX(RX,"DRI")
"RTN","PSOLBL",49,0)
 I '$G(RXP),'$O(^PSRX(RX,1,0)) S RXFL(RX)=0
"RTN","PSOLBL",50,0)
 I '$G(RXP) D OSET I '$O(^PSRX(RX,1,0))!($G(RXFL(RX))=0) G ORIG
"RTN","PSOLBL",51,0)
 I $O(^PSRX(RX,1,0)),'$G(RXP),'$G(RXFL(RX)) S XTYPE=1 D REF G STA
"RTN","PSOLBL",52,0)
 I $O(^PSRX(RX,1,0)),'$G(RXP),$G(RXFL(RX)) G STA
"RTN","PSOLBL",53,0)
 I $G(RXP) S XTYPE="P" D REF G STA
"RTN","PSOLBL",54,0)
ORIG S TECH=$P($G(^VA(200,+$P(^PSRX(RX,0),"^",16),0)),"^"),QTY=$P(^PSRX(RX,0),"^",7),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UKN") D 6^VADPT,PID^VADPT S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLBL",55,0)
 S DAYS=$P(^PSRX(RX,0),"^",8),MFG="________",LOT="________"
"RTN","PSOLBL",56,0)
STA S STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UKN")
"RTN","PSOLBL",57,0)
 S DRUG=$$ZZ^PSOSUTL(RX),DEA=$P($G(^PSDRUG(+$P(RXY,"^",6),0)),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOLBL",58,0)
 S SIDE=$S($P($G(RXRP(RX)),"^",3):1,1:0)
"RTN","PSOLBL",59,0)
 I $G(^PSRX(RX,"P",+$G(RXP),0))]"" S RXPI=RXP D
"RTN","PSOLBL",60,0)
 .S RXP=^PSRX(RX,"P",RXP,0)
"RTN","PSOLBL",61,0)
 .S RXY=$P(RXP,"^")_"^"_$P(RXY,"^",2,6)_"^"_$P(RXP,"^",4)_"^"_$P(RXP,"^",10)_"^"_$P(RXY,"^",9)_"^"_$P($G(^PSRX(RX,"SIG")),"^",2)_"^"_$P(RXP,"^",2)_"^"_$P(RXY,"^",12,14)_"^"_$P(^PSRX(RX,"STA"),"^")_"^"_$P(RXP,"^",7)_"^"_$P(RXY,"^",17,99)
"RTN","PSOLBL",62,0)
 .S FDT=$P(RXP,"^")
"RTN","PSOLBL",63,0)
 S MW=$P(RXY,"^",11) I $G(RXFL(RX))'=0 D:$G(RXFL(RX))  I '$G(RXFL(RX)) F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=RXF+1 S:'$G(RXP) MW=$P(^PSRX(RX,1,I,0),"^",2) I +^PSRX(RX,1,I,0)'<FDT S FDT=+^(0)
"RTN","PSOLBL",64,0)
 .I $G(RXFL(RX)),'$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLBL",65,0)
 .S RXF=RXFL(RX) S:'$G(RXP) MW=$P($G(^PSRX(RX,1,RXF,0)),"^",2) I +^PSRX(RX,1,RXF,0)'<FDT S FDT=+^(0)
"RTN","PSOLBL",66,0)
 I MW="W" S PSMP=$G(^PSRX(RX,"MP")) I PSMP]"" D
"RTN","PSOLBL",67,0)
 .S PSJ=0 F PSI=1:1:$L(PSMP) S PSMP(PSI)="",PSJ=PSJ+1 F PSJ=PSJ:1 S PSMP(PSI)=PSMP(PSI)_$P(PSMP," ",PSJ)_" " Q:($L(PSMP(PSI))+$L($P(PSMP," ",PSJ+1))>30)
"RTN","PSOLBL",68,0)
 .K PSMP(PSI)
"RTN","PSOLBL",69,0)
 S X=$S($D(^PS(55,DFN,0)):^(0),1:""),PSCAP=$P(X,"^",2),PS55=$P($G(X),"^",3),PS55X=$P($G(X),"^",5)
"RTN","PSOLBL",70,0)
 I (($G(PS55X)]"")&(PS55>1)&(PS55X<DT)) S PS55=0
"RTN","PSOLBL",71,0)
 S:MW="M" MW=$S((PS55=1!(PS55=4)):"R",1:MW)
"RTN","PSOLBL",72,0)
 S MW=$S(MW="M":"REGULAR",MW="R":"CERTIFIED",1:"WINDOW")
"RTN","PSOLBL",73,0)
 I ($G(PSMP(1))']""&($G(PS55)=2)) S PSMP(1)=$G(SSNPN)
"RTN","PSOLBL",74,0)
 ;S X=$S($D(^PS(55,DFN,0)):^(0),1:""),PSCAP=$P(X,"^",2) S:MW="M" MW=$S(+$P(X,"^",3):"R",1:MW) S MW=$S(MW="M":"REGULAR",MW="R":"CERTIFIED",1:"WINDOW")
"RTN","PSOLBL",75,0)
 S DATE=$E(FDT,1,7),REF=$P(RXY,"^",9)-RXF S:'$G(RXP) $P(^PSRX(RX,3),"^")=FDT S:REF<1 REF=0 D ^PSOLBL2 S II=RX D ^PSORFL,RFLDT^PSORFL
"RTN","PSOLBL",76,0)
 S PATST=$G(^PS(53,+$P(RXY,"^",3),0)) S PRTFL=1 I REF=0 S:('$P(PATST,"^",5))!(DEA["W")!(DEA[1)!(DEA[2) PRTFL=0
"RTN","PSOLBL",77,0)
 S VRPH=$P(^PSRX(RX,2),"^",10),PSCLN=+$P(RXY,"^",5),PSCLN=$S($D(^SC(PSCLN,0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLBL",78,0)
 S PATST=$P(PATST,"^",2),X1=DT,X2=$P(RXY,"^",8)-10 D C^%DTC:REF I $D(^PSRX(RX,2)),$P(^(2),"^",6),REF,X'<$P(^(2),"^",6) S REF=0,VRPH=$P(^(2),"^",10)
"RTN","PSOLBL",79,0)
 I $G(PSOCHAMP),$G(PSOTRAMT) S COPAYVAR="CHAMPUS" G LBL
"RTN","PSOLBL",80,0)
 I $G(RXP) S COPAYVAR="" G LBL
"RTN","PSOLBL",81,0)
 I $P($G(^PS(53,+$G(PSOLBLPS),0)),"^",7) D SNO G LBL
"RTN","PSOLBL",82,0)
 I $P($G(^PSDRUG(+$G(PSOLBLDR),0)),"^",3)["I"!($P($G(^(0)),"^",3)["S") D SNO G LBL
"RTN","PSOLBL",83,0)
 I $P(^PSRX(RX,"STA"),"^")>0,$P(^("STA"),"^")'=2,'$G(PSODBQ) D SNO G LBL
"RTN","PSOLBL",84,0)
 I $G(PSOLBLCP)="" D IBCP
"RTN","PSOLBL",85,0)
 N PSOQI S PSOQI=$G(^PSRX(RX,"IBQ")) I $G(PSOLBLCP)=0 D SNO G LBL
"RTN","PSOLBL",86,0)
 I $G(PSOLBLCP)=1 I $P(PSOQI,"^",2)!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLBL",87,0)
 I $G(PSOLBLCP)=2 I $P(PSOQI,"^")!($P(PSOQI,"^",2))!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLBL",88,0)
 I $G(PSOLBLCP)=2,'$P($G(^PSRX(RX,"IB")),"^") D SNO G LBL
"RTN","PSOLBL",89,0)
 S PSOCPN=$P(^PSRX(RX,0),"^",2),INRX=$P(^(0),"^") I $G(^TMP($J,"PSOCP",PSOCPN))="" S ^(PSOCPN)=PSOCPN
"RTN","PSOLBL",90,0)
 S ^TMP($J,"PSOCP",PSOCPN,INRX)=INRX_"^"_$$ZZ^PSOSUTL(RX)_"^"_+$G(DAYS) S COPAYVAR="COPAY" K ZDRUG
"RTN","PSOLBL",91,0)
LBL G ^PSOLBLD:$P(^PSRX(RX,"STA"),"^")=4 D ^PSOLBLD:$D(^PSRX(RX,"DRI"))&('$G(RXF))&('$G(RXP)) D:$P($G(^PSRX(RX,3)),"^",6)&('$G(RXF))&('$G(RXP)) ^PSOLBLD1 G ^PSOLBL1:'$P(^PS(59,PSOSITE,1),"^",28)
"RTN","PSOLBL",92,0)
 G ^PSOLBLN
"RTN","PSOLBL",93,0)
REF F XXX=0:0 S XXX=$O(^PSRX(RX,XTYPE,XXX)) Q:+XXX'>0  D
"RTN","PSOLBL",94,0)
 .S TECH=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLBL",95,0)
 .S QTY=$P(^PSRX(RX,XTYPE,XXX,0),"^",4),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLBL",96,0)
 .S DAYS=$P(^PSRX(RX,XTYPE,XXX,0),"^",10),LOT="________",MFG="________"
"RTN","PSOLBL",97,0)
 Q
"RTN","PSOLBL",98,0)
CHECK S PSDFNFLG=0,PSOZERO=$P(PPL,","),PSOPDFN=$P(^PSRX(PSOZERO,0),"^",2)
"RTN","PSOLBL",99,0)
 Q
"RTN","PSOLBL",100,0)
OSET I $G(RXFL(RX))']""!($G(RXFL(RX))=0) D  Q
"RTN","PSOLBL",101,0)
 .S TECH=$P($G(^VA(200,+$P(^PSRX(RX,0),"^",16),0)),"^"),QTY=$P(^PSRX(RX,0),"^",7),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UKN") D 6^VADPT,PID^VADPT S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLBL",102,0)
 .S DAYS=$P(^PSRX(RX,0),"^",8),MFG="________",LOT="________"
"RTN","PSOLBL",103,0)
 I '$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLBL",104,0)
 S TECH=$S($D(^VA(200,+$P(^PSRX(RX,1,RXFL(RX),0),"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLBL",105,0)
 S QTY=$P(^PSRX(RX,1,RXFL(RX),0),"^",4),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,1,RXFL(RX),0),"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLBL",106,0)
 S DAYS=$P(^PSRX(RX,1,RXFL(RX),0),"^",10),LOT="________",MFG="________"
"RTN","PSOLBL",107,0)
 Q
"RTN","PSOLBL",108,0)
DOUB Q:'$D(RXFL(RX))  I +$G(RXFL(RX))-PSOCKHNX<0 Q
"RTN","PSOLBL",109,0)
 S RXFLX(RX)=$G(RXFL(RX)),RXFL(RX)=$G(RXFL(RX))-PSOCKHNX
"RTN","PSOLBL",110,0)
 Q
"RTN","PSOLBL",111,0)
AL(T) N I,IR,RF,USR,TY,DES S USR=""
"RTN","PSOLBL",112,0)
 I T="UT" D
"RTN","PSOLBL",113,0)
 .N J,RX S USR=$G(DUZ),TY="B",DES="Label never queued to print by User"
"RTN","PSOLBL",114,0)
 .F J=1:1  S RX=+$P(PPL,",",J) Q:'RX  D AL1
"RTN","PSOLBL",115,0)
 I T="QT" D
"RTN","PSOLBL",116,0)
 .S I=+$P(^PSRX(RX,"STA"),"^"),TY=$S((I=3)!(I=16):"H",I=13:"D",1:"C")
"RTN","PSOLBL",117,0)
 .S DES=I_" "_$S((I=3)!(I=16):"HOLD"_$S(I=16:"(PROVIDER)",1:""),(I=12)!(I=14)!(I=15):"DISCONTINUED"_$S(I=14:"(PROVIDER)",I=15:"(EDIT)",1:""),I=13:"DELETED",1:"")
"RTN","PSOLBL",118,0)
 .S DES="Queued label terminated - "_DES D AL1
"RTN","PSOLBL",119,0)
 K %,%H,%I Q
"RTN","PSOLBL",120,0)
AL1 S (IR,I,RF)=0 F  S I=$O(^PSRX(RX,1,I)) Q:'I  S RF=I S:I>5 RF=I+1
"RTN","PSOLBL",121,0)
 S I=0 F  S I=$O(^PSRX(RX,"A",I)) Q:'I  S IR=I
"RTN","PSOLBL",122,0)
 S IR=IR+1,^PSRX(RX,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOLBL",123,0)
 D NOW^%DTC S ^PSRX(RX,"A",IR,0)=%_"^"_TY_"^"_USR_"^"_$S($G(RXPR(RX)):6,1:RF)_"^"_DES
"RTN","PSOLBL",124,0)
 Q
"RTN","PSOLBL",125,0)
IBCP N X,Y,PSOJJ,PSOLL
"RTN","PSOLBL",126,0)
 S PSOLBLCP="",X=$P($G(^PS(59,+$G(PSOSITE),"IB")),"^")_"^"_$G(DFN) D XTYPE^IBARX
"RTN","PSOLBL",127,0)
 S PSOJJ="" F  S PSOJJ=$O(Y(PSOJJ)) Q:'PSOJJ  S PSOLL="" F  S PSOLL=$O(Y(PSOJJ,PSOLL)) Q:PSOLL=""  S:PSOLL>0 PSOLBLCP=PSOLL
"RTN","PSOLBL",128,0)
 I '$G(PSOLBLCP) S PSOLBLCP=0
"RTN","PSOLBL",129,0)
 Q
"RTN","PSOLBL",130,0)
SNO S COPAYVAR="NO COPAY" Q
"RTN","PSOLLLI")
0^9^B65877294^B65923392
"RTN","PSOLLLI",1,0)
PSOLLLI ;BIR/JLC - LASER LABELS INITIALIZATION ;4/25/07 9:00am
"RTN","PSOLLLI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,157,189,161,244,200,206**;DEC 1997;Build 39
"RTN","PSOLLLI",3,0)
 ;
"RTN","PSOLLLI",4,0)
 ;DBIAs PSDRUG-221, PS(55-2228, SC-10040, IBARX-125, PSXSRP-2201, %ZIS-3435, DPT-3097, ^TMP($J,"PSNPPIO"-3794
"RTN","PSOLLLI",5,0)
 ;External reference to DRUG^PSSWRNA supported by DBIA 4449
"RTN","PSOLLLI",6,0)
 ;
"RTN","PSOLLLI",7,0)
 ;*244 remove test for partial fill when testing status > 11
"RTN","PSOLLLI",8,0)
 ;
"RTN","PSOLLLI",9,0)
DQ N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLLI",10,0)
DQ1 I '$D(PPL) G HLEX
"RTN","PSOLLLI",11,0)
 I $P($G(PSOPAR),"^",30)=2,'$G(PSOEXREP) G HLEX
"RTN","PSOLLLI",12,0)
 K RXFLX S PSOCKHN=","_$G(PPL),PSRESOLV=+PPL D CHECK
"RTN","PSOLLLI",13,0)
 S PSOINT=1 F PI=1:1 S RX=$P(PPL,",",PI) Q:RX=""  D
"RTN","PSOLLLI",14,0)
 . S RXY=$G(^PSRX(RX,0)) Q:RXY=""  I PSOPDFN'=$P(RXY,"^",2),'PSOINT D TRAIL^PSOLLL1 S PSOPDFN=$P(RXY,"^",2)
"RTN","PSOLLLI",15,0)
 . K RXP,REPRINT D C
"RTN","PSOLLLI",16,0)
 I 'PSOINT D TRAIL^PSOLLL1
"RTN","PSOLLLI",17,0)
HLEX K RXPI,PSORX,RXP,PSOIOS,PSOLAPPL,XXX,COPAYVAR,TECH,PHYS,MFG,NURSE,STATE,SIDE,COPIES,EXDT,ISD,PSOINST,RXN,RXY,VADT,DEA,WARN,FDT,QTY,PATST,PDA,PS,PS1,RXP,REPRINT
"RTN","PSOLLLI",18,0)
 K SGY,OSGY,PS2,PSL,PSNP,INRX,RR,XTYPE,SSNP,SSNPN,PNM,ADDR,PSODBQ,PSOLASTF,PSRESOLV,PSOEXREP,PSOSXQ
"RTN","PSOLLLI",19,0)
 K DATE,DR,DRUG,LINE,MW,PRTFL,VRPH,EXPDT,X2,DIFF,DAYS,PSZIP,PSOHZIP,PS55,PS55X
"RTN","PSOLLLI",20,0)
 K ^TMP($J,"PSNPMI"),^TMP($J,"PSOCP",+$G(PSOCPN)),PSOCPN,PSOLBLDR,PSOLBLPS,PSOLBLCP,RXPR,RXRP,RXRS,PSOCKHN,RXFLX,PSOLAPPL,PSOPDFN,PSDFNFLG,PSOZERO,NEXTRX,PSOBLALL,STA
"RTN","PSOLLLI",21,0)
 I '$G(PSOSUREP),'$G(PSOSUSPR) S ZTREQ="@"
"RTN","PSOLLLI",22,0)
 Q
"RTN","PSOLLLI",23,0)
C N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLLI",24,0)
 U IO Q:'$D(^PSRX(RX,0))  S RXY=^(0),RX2=^(2),RXSTA=^("STA") K SGY,OSGY
"RTN","PSOLLLI",25,0)
 S (SIGM,PFM,PMIM,L2,L3,L4,L5,FILLCONT,BOTTLBL)=0
"RTN","PSOLLLI",26,0)
 K SIGF,PFF,PMIF S (SIGF,PFF,PMIF)=0 F I="DR","T" S (SIGF(I),PFF(I))=1
"RTN","PSOLLLI",27,0)
 F I="A","B","I" S PMIF(I)=1
"RTN","PSOLLLI",28,0)
 D NOW^%DTC S Y=$P(%,"."),PSOFNOW=% X ^DD("DD") S PSONOW=Y,Y=PSOFNOW X ^DD("DD") S PSONOWT=Y
"RTN","PSOLLLI",29,0)
 S:$G(PSOBLALL) PSOBLRX=RX S:$D(RXRP(RX)) REPRINT=1 S:$D(RXPR(RX)) RXP=RXPR(RX)
"RTN","PSOLLLI",30,0)
 I $G(PSOSUREP)!($G(PSOEXREP)) S REPRINT=1 I '$G(RXRP(RX)) S RXRP(RX)=1
"RTN","PSOLLLI",31,0)
 S A=$P(RXSTA,"^") I A>11 D AL^PSOLBL("QT") K RXP,REPRINT Q      ;*244
"RTN","PSOLLLI",32,0)
 I A=3 D AL^PSOLBL("QT") K RXP,REPRINT Q
"RTN","PSOLLLI",33,0)
 I $G(RXPR(RX)),'$D(^PSRX(RX,"P",RXP,0)) K RXP,REPRINT Q
"RTN","PSOLLLI",34,0)
 I $P($G(RXFL(RX)),"^"),'$D(^PSRX(RX,1,$P($G(RXFL(RX)),"^"),0)) K RXP,REPRINT Q
"RTN","PSOLLLI",35,0)
 I $G(PSODBQ)!($G(RXRS(RX))) S RR=$O(^PS(52.5,"B",RX,0)) Q:'RR  I $G(^PS(52.5,RR,"P"))=1 K RXP,REPRINT Q
"RTN","PSOLLLI",36,0)
 I $G(RXRS(RX))!($G(PSOPULL)) S PSOSXQ=0 N DR,DA,DIE D  I $G(PSOSXQ) K RXP,REPRINT Q
"RTN","PSOLLLI",37,0)
 . S DA=$O(^PS(52.5,"B",RX,0)) Q:'DA
"RTN","PSOLLLI",38,0)
 . S A=$P($G(^PS(52.5,DA,0)),"^",7) I A="" Q
"RTN","PSOLLLI",39,0)
 . I A="Q" S DIE="^PS(52.5,",DR="3////P" D ^DIE Q
"RTN","PSOLLLI",40,0)
 . K RXRS(RX) S PSOSXQ=1
"RTN","PSOLLLI",41,0)
 I $G(PSRESOLV)=RX D ENLBL^PSOBSET K PSRESOLV
"RTN","PSOLLLI",42,0)
 I $P(RXSTA,"^")'=4 D
"RTN","PSOLLLI",43,0)
 . I $G(PSOSUSPR) D AREC^PSOSUTL
"RTN","PSOLLLI",44,0)
 . I $G(PSOPULL)!($G(RXRS(RX))) D AREC1^PSOSUTL
"RTN","PSOLLLI",45,0)
 . I $G(PSOSUREP) D AREC^PSOSUSRP
"RTN","PSOLLLI",46,0)
 . I $G(PSXREP) D AREC^PSXSRP
"RTN","PSOLLLI",47,0)
 S RXY=^PSRX(RX,0),RX2=^(2),RXSTA=^("STA")
"RTN","PSOLLLI",48,0)
 K ^UTILITY("DIQ1",$J) S DA=$P($$SITE^VASITE(),"^")
"RTN","PSOLLLI",49,0)
 I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIC
"RTN","PSOLLLI",50,0)
 S RXN=$P(RXY,"^"),DFN=+$P(RXY,"^",2),PSOLBLPS=+$P(RXY,"^",3),PSOLBLDR=+$P(RXY,"^",6)
"RTN","PSOLLLI",51,0)
 S ISD=$P(RXY,"^",13),RXF=0,SIG=$P($G(^PSRX(RX,"SIG")),"^"),ISD=$E(ISD,4,5)_"/"_$E(ISD,6,7)_"/"_($E(ISD,1,3)+1700),ZY=0,$P(LINE,"_",28)="_"
"RTN","PSOLLLI",52,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0)
"RTN","PSOLLLI",53,0)
 S FDT=$P(RX2,"^",2),PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:""),PS1=$S($D(^(1)):^(1),1:""),PSOSITE7=$P(^("IB"),"^")
"RTN","PSOLLLI",54,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLLLI",55,0)
 S EXPDT=$P(RX2,"^",6),EXDT=$S('EXPDT:"",1:$E(EXPDT,4,5)_"/"_$E(EXPDT,6,7)_"/"_($E(EXPDT,1,3)+1700))
"RTN","PSOLLLI",56,0)
 S COPIES=$S($P($G(RXRP(RX)),"^",2):$P($G(RXRP(RX)),"^",2),$P(RXY,"^",18)]"":$P(RXY,"^",18),1:1)
"RTN","PSOLLLI",57,0)
 K PSOCKHNX S PSOCKHL=$L(RX),PSOCKHN=$E($G(PSOCKHN),(PSOCKHL+2),999) D  K PSOCKHNX,PSOCKHL,PSOCKHA
"RTN","PSOLLLI",58,0)
 .S PSOCKHA=","_RX_","
"RTN","PSOLLLI",59,0)
 .I PSOCKHN'[PSOCKHA Q
"RTN","PSOLLLI",60,0)
 .S PSOCKHA=$E(PSOCKHA,1,($L(PSOCKHA)-1))
"RTN","PSOLLLI",61,0)
 .S PSOCKHNX=$L(PSOCKHN,PSOCKHA)-1
"RTN","PSOLLLI",62,0)
 .I +$G(PSOCKHNX)>0 D DOUB
"RTN","PSOLLLI",63,0)
 I $O(^PSRX(RX,1,0)),$G(RXFL(RX))'=0 S $P(^PSRX(RX,3),"^",6)="" K ^PSRX(RX,"DAI"),^PSRX(RX,"DRI")
"RTN","PSOLLLI",64,0)
 I '$G(RXP),'$O(^PSRX(RX,1,0)) S RXFL(RX)=0
"RTN","PSOLLLI",65,0)
 I '$G(RXP) D OSET I '$O(^PSRX(RX,1,0))!($G(RXFL(RX))=0) G ORIG
"RTN","PSOLLLI",66,0)
 I $O(^PSRX(RX,1,0)),'$G(RXP) D  G STA
"RTN","PSOLLLI",67,0)
 . I '$G(RXFL(RX)) S XTYPE=1 D REF
"RTN","PSOLLLI",68,0)
 I $G(RXP) S XTYPE="P" D REF G STA
"RTN","PSOLLLI",69,0)
ORIG S TECH=$P($G(^VA(200,+$P(RXY,"^",16),0)),"^"),PHYS=$S($D(^VA(200,+$P(RXY,"^",4),0)):$P(^(0),"^"),1:"UKN")
"RTN","PSOLLLI",70,0)
 S DAYS=$P(RXY,"^",8),QTY=$P(RXY,"^",7)
"RTN","PSOLLLI",71,0)
 D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLLI",72,0)
STA S STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UKN")
"RTN","PSOLLLI",73,0)
 S DRUG=$$ZZ^PSOSUTL(RX),DEA=$P($G(^PSDRUG(+$P(RXY,"^",6),0)),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOLLLI",74,0)
 S WARN=$$DRUG^PSSWRNA(+$P(RXY,"^",6),+$P(RXY,"^",2))
"RTN","PSOLLLI",75,0)
 S SIDE=$S($P($G(RXRP(RX)),"^",3):1,1:0)
"RTN","PSOLLLI",76,0)
 I $G(^PSRX(RX,"P",+$G(RXP),0))]"" S RXPI=RXP D
"RTN","PSOLLLI",77,0)
 .S RXP=^PSRX(RX,"P",RXP,0)
"RTN","PSOLLLI",78,0)
 .S RXY=$P(RXP,"^")_"^"_$P(RXY,"^",2,6)_"^"_$P(RXP,"^",4)_"^"_$P(RXP,"^",10)_"^"_$P(RXY,"^",9)_"^"_$P($G(^PSRX(RX,"SIG")),"^",2)_"^"_$P(RXP,"^",2)_"^"_$P(RXY,"^",12,14)_"^"_$P(^PSRX(RX,"STA"),"^")_"^"_$P(RXP,"^",7)_"^"_$P(RXY,"^",17,99)
"RTN","PSOLLLI",79,0)
 .S FDT=$P(RXP,"^")
"RTN","PSOLLLI",80,0)
 S MW=$P(RXY,"^",11) I $G(RXFL(RX))'=0 D:$G(RXFL(RX))  I '$G(RXFL(RX)) F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=RXF+1 S:'$G(RXP) MW=$P(^PSRX(RX,1,I,0),"^",2) I +^PSRX(RX,1,I,0)'<FDT S FDT=+^(0)
"RTN","PSOLLLI",81,0)
 .I $G(RXFL(RX)),'$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLLLI",82,0)
 .S RXF=RXFL(RX) S:'$G(RXP) MW=$P($G(^PSRX(RX,1,RXF,0)),"^",2) I +^PSRX(RX,1,RXF,0)'<FDT S FDT=+^(0)
"RTN","PSOLLLI",83,0)
 I MW="W",$G(^PSRX(RX,"MP"))]"" D
"RTN","PSOLLLI",84,0)
 .S PSMP=^PSRX(RX,"MP"),PSJ=0 F PSI=1:1:$L(PSMP) S PSMP(PSI)="",PSJ=PSJ+1 F PSJ=PSJ:1 S PSMP(PSI)=PSMP(PSI)_$P(PSMP," ",PSJ)_" " Q:($L(PSMP(PSI))+$L($P(PSMP," ",PSJ+1))>30)
"RTN","PSOLLLI",85,0)
 .K PSMP(PSI)
"RTN","PSOLLLI",86,0)
 ;New mail codes for CMOP
"RTN","PSOLLLI",87,0)
 S MAILCOM=""
"RTN","PSOLLLI",88,0)
 S X=$G(^PS(55,DFN,0)),PSCAP=$P(X,"^",2),PS55=$P(X,"^",3),PS55X=$P(X,"^",5)
"RTN","PSOLLLI",89,0)
 I PS55X]"",PS55>1,PS55X<DT S PS55=0
"RTN","PSOLLLI",90,0)
 S:MW="M" MW=$S((PS55=1!(PS55=4)):"R",1:MW)
"RTN","PSOLLLI",91,0)
 S MAILCOM=$P($G(^PS(59,PSOSITE,9)),"^")
"RTN","PSOLLLI",92,0)
 S MW=$S(MW="M":"REGULAR",MW="R":"CERTIFIED",1:"WINDOW")
"RTN","PSOLLLI",93,0)
 I $G(PSMP(1))="",$G(PS55)=2 S PSMP(1)=$G(SSNPN)
"RTN","PSOLLLI",94,0)
 S DATE=$E(FDT,1,7),REF=$P(RXY,"^",9)-RXF S:'$G(RXP) $P(^PSRX(RX,3),"^")=FDT S:REF<1 REF=0 D ^PSOLBL2 S II=RX D ^PSORFL,RFLDT^PSORFL
"RTN","PSOLLLI",95,0)
 S (X,PSOFLAST)=$G(PSOLASTF) I X?1N.E D ^%DT X ^DD("DD") S PSOFLAST=Y
"RTN","PSOLLLI",96,0)
 S PATST=$G(^PS(53,+$P(RXY,"^",3),0)) S PRTFL=1 I REF=0 S:('$P(PATST,"^",5))!(DEA["W")!(DEA[1)!(DEA[2) PRTFL=0
"RTN","PSOLLLI",97,0)
 S VRPH=$P(RX2,"^",10),PSCLN=+$P(RXY,"^",5),PSCLN=$G(^SC(PSCLN,0)),PSCLN=$S($P(PSCLN,"^",2)'="":$P(PSCLN,"^",2),1:$E($P(PSCLN,"^"),1,7)) I PSCLN="" S PSCLN="UNKNOWN"
"RTN","PSOLLLI",98,0)
 S PATST=$P(PATST,"^",2),X1=DT,X2=$P(RXY,"^",8)-10 D C^%DTC:REF I $D(^PSRX(RX,2)),$P(^(2),"^",6),REF,X'<$P(^(2),"^",6) S REF=0,VRPH=$P(^(2),"^",10)
"RTN","PSOLLLI",99,0)
 I $G(PSOCHAMP),$G(PSOTRAMT) S COPAYVAR="CHAMPUS" G LBL
"RTN","PSOLLLI",100,0)
 I $G(RXP) S COPAYVAR="" G LBL
"RTN","PSOLLLI",101,0)
 I $P($G(^PS(53,+$G(PSOLBLPS),0)),"^",7) D SNO G LBL
"RTN","PSOLLLI",102,0)
 I DEA["I"!(DEA["S") D SNO G LBL
"RTN","PSOLLLI",103,0)
 I $P(^PSRX(RX,"STA"),"^")>0,$P(^("STA"),"^")'=2,'$G(PSODBQ) D SNO G LBL
"RTN","PSOLLLI",104,0)
 I $G(PSOLBLCP)="" D IBCP
"RTN","PSOLLLI",105,0)
 N PSOQI S PSOQI=$G(^PSRX(RX,"IBQ"))
"RTN","PSOLLLI",106,0)
 I $G(PSOLBLCP)=0 D SNO G LBL
"RTN","PSOLLLI",107,0)
 I $G(PSOLBLCP)=1 I $P(PSOQI,"^",2)!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLLLI",108,0)
 I $G(PSOLBLCP)=2 I $P(PSOQI,"^")!($P(PSOQI,"^",2))!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLLLI",109,0)
 I $G(PSOLBLCP)=2,'$P($G(^PSRX(RX,"IB")),"^") D SNO G LBL
"RTN","PSOLLLI",110,0)
 S PSOCPN=$P(RXY,"^",2),INRX=$P(RXY,"^")
"RTN","PSOLLLI",111,0)
 I $G(^TMP($J,"PSOCP",PSOCPN))="" S ^(PSOCPN)=PSOCPN
"RTN","PSOLLLI",112,0)
 S ^TMP($J,"PSOCP",PSOCPN,INRX)=INRX_"^"_$$ZZ^PSOSUTL(RX)_"^"_+$G(DAYS),COPAYVAR="COPAY" K ZDRUG
"RTN","PSOLLLI",113,0)
LBL I $G(PSOIO("LLI"))]"" X PSOIO("LLI")
"RTN","PSOLLLI",114,0)
 I $P(RXSTA,"^")=4 D ^PSOLLL8 Q  ;for a critical interaction entered by a tech - don't allow a label to be printed
"RTN","PSOLLLI",115,0)
 I $D(^PSRX(RX,"DRI")),'$G(RXF),'$G(RXP) D ^PSOLLL8
"RTN","PSOLLLI",116,0)
 I $P($G(^PSRX(RX,3)),"^",6),'$G(RXF),'$G(RXP) D ^PSOLLL9
"RTN","PSOLLLI",117,0)
 S PSOINT=0 G ^PSOLLL1
"RTN","PSOLLLI",118,0)
REF F XXX=0:0 S XXX=$O(^PSRX(RX,XTYPE,XXX)) Q:+XXX'>0  D
"RTN","PSOLLLI",119,0)
 .S TECH=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLLLI",120,0)
 .S QTY=$P(^PSRX(RX,XTYPE,XXX,0),"^",4),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLLI",121,0)
 .S DAYS=$P(^PSRX(RX,XTYPE,XXX,0),"^",10)
"RTN","PSOLLLI",122,0)
 Q
"RTN","PSOLLLI",123,0)
CHECK S PSDFNFLG=0,PSOZERO=$P(PPL,","),PSOPDFN=$P(^PSRX(PSOZERO,0),"^",2)
"RTN","PSOLLLI",124,0)
 Q
"RTN","PSOLLLI",125,0)
OSET ;
"RTN","PSOLLLI",126,0)
 N A
"RTN","PSOLLLI",127,0)
 I $G(RXFL(RX))']""!($G(RXFL(RX))=0) D  Q
"RTN","PSOLLLI",128,0)
 .S A=^PSRX(RX,0)
"RTN","PSOLLLI",129,0)
 .S TECH=$P($G(^VA(200,+$P(A,"^",16),0)),"^"),QTY=$P(A,"^",7),PHYS=$S($D(^VA(200,+$P(A,"^",4),0)):$P(^(0),"^"),1:"UKN") D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLLI",130,0)
 .S DAYS=$P(A,"^",8)
"RTN","PSOLLLI",131,0)
 I '$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLLLI",132,0)
 S A=^PSRX(RX,1,RXFL(RX),0)
"RTN","PSOLLLI",133,0)
 S TECH=$S($D(^VA(200,+$P(A,"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLLLI",134,0)
 S QTY=$P(A,"^",4),PHYS=$S($D(^VA(200,+$P(A,"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT6 S SSNPN=$G(VA("BID"))
"RTN","PSOLLLI",135,0)
 S DAYS=$P(A,"^",10)
"RTN","PSOLLLI",136,0)
 Q
"RTN","PSOLLLI",137,0)
DOUB ;
"RTN","PSOLLLI",138,0)
 Q:'$D(RXFL(RX))
"RTN","PSOLLLI",139,0)
 I +$G(RXFL(RX))-PSOCKHNX<0 Q
"RTN","PSOLLLI",140,0)
 S RXFLX(RX)=$G(RXFL(RX))
"RTN","PSOLLLI",141,0)
 S RXFL(RX)=$G(RXFL(RX))-PSOCKHNX
"RTN","PSOLLLI",142,0)
 Q
"RTN","PSOLLLI",143,0)
IBCP ;
"RTN","PSOLLLI",144,0)
 N X,Y,PSOJJ,PSOLL
"RTN","PSOLLLI",145,0)
 S PSOLBLCP=""
"RTN","PSOLLLI",146,0)
 S X=$P($G(^PS(59,+$G(PSOSITE),"IB")),"^")_"^"_$G(DFN) D XTYPE^IBARX
"RTN","PSOLLLI",147,0)
 S PSOJJ="" F  S PSOJJ=$O(Y(PSOJJ)) Q:'PSOJJ  S PSOLL="" F  S PSOLL=$O(Y(PSOJJ,PSOLL)) Q:PSOLL=""  S:PSOLL>0 PSOLBLCP=PSOLL
"RTN","PSOLLLI",148,0)
 I '$G(PSOLBLCP) S PSOLBLCP=0
"RTN","PSOLLLI",149,0)
 Q
"RTN","PSOLLLI",150,0)
SNO ;
"RTN","PSOLLLI",151,0)
 S COPAYVAR="NO COPAY"
"RTN","PSOLLLI",152,0)
 Q
"RTN","PSOORED1")
0^10^B68466079^B67901232
"RTN","PSOORED1",1,0)
PSOORED1 ;ISC-BHAM/SAB - edit orders from backdoor ;5/10/07 8:25am
"RTN","PSOORED1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,23,46,78,114,117,131,146,223,148,244,249,268,206**;DEC 1997;Build 39
"RTN","PSOORED1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORED1",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED1",5,0)
 ;
"RTN","PSOORED1",6,0)
 ;*244 call to remove DC'd Rx's from Rx ien strings
"RTN","PSOORED1",7,0)
 ;
"RTN","PSOORED1",8,0)
EN(PSORENW) ;
"RTN","PSOORED1",9,0)
 N LST,ORD,ORN K VALMBCK,PSORX("FN") S PSOAC=1,(PSORX("QFLG"),PSORX("DFLG"))=0 ;D DREN^PSOORNW2,INIT
"RTN","PSOORED1",10,0)
 D INIT
"RTN","PSOORED1",11,0)
 D @$S($P(PSOPAR,"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN")
"RTN","PSOORED1",12,0)
 I '$D(PSONEW("RX #")),'$P(PSOPAR,"^",7) D PAUSE^VALM1 K VALMSG,PSONEW("QFLG") S VALMBCK="Q" Q
"RTN","PSOORED1",13,0)
 I '$D(PSONEW("RX #")) K VALMSG D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" Q
"RTN","PSOORED1",14,0)
 S PSORENW("RX #")=PSONEW("RX #") I '$P(PSOPAR,"^",7) D  Q:$G(PSONEW("DFLG"))!($G(PSONEW("QFLG")))
"RTN","PSOORED1",15,0)
 .S PSOX=PSORENW("RX #") D CHECK^PSONRXN
"RTN","PSOORED1",16,0)
 I $G(PSONEW("DFLG"))!$G(PSONEW("QFLG")) D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" K PSORENW Q
"RTN","PSOORED1",17,0)
 D EN^PSOORNE1(.PSORENW) I '$G(PSORX("FN")) D:$P($G(PSOPAR),"^",7)=1  S VALMBCK="Q" Q
"RTN","PSOORED1",18,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#","")),PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORED1",19,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORED1",20,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORED1",21,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORED1",22,0)
 .I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #"))
"RTN","PSOORED1",23,0)
 .K PSOX,PSOY Q
"RTN","PSOORED1",24,0)
 Q:$G(COPY)
"RTN","PSOORED1",25,0)
TRY S $P(^PSRX(PSORENW("OIRXN"),"STA"),"^")=15,DA=PSORENW("OIRXN")
"RTN","PSOORED1",26,0)
 S $P(^PSRX(DA,3),"^",5)=DT,$P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOORED1",27,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7),CAN^PSOTPCAN(DA)
"RTN","PSOORED1",28,0)
 D RMP^PSOCAN3                ;*244
"RTN","PSOORED1",29,0)
 ;cancel/discontinue action
"RTN","PSOORED1",30,0)
 S PHARM="",STAT="RP",COMM="Prescription discontinued due to editing." D EN^PSOHLSN1(DA,STAT,PHARM,COMM,PSONOOR) K STAT,PHARM,COMM
"RTN","PSOORED1",31,0)
 S ACOM="Discontinued due to editing. New Rx created "_$P(^PSRX(PSORENW("IRXN"),0),"^")_"."
"RTN","PSOORED1",32,0)
 I $G(^PSRX(DA,"H"))]"" D
"RTN","PSOORED1",33,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORED1",34,0)
 ..S DIE=52,DR="22///"_$P(^PSRX(DA,3),"^") D ^DIE S ACOM="Discontinued due to editing while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)
"RTN","PSOORED1",35,0)
 ..S ^PSRX(DA,"H")=""
"RTN","PSOORED1",36,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",RXDA,0)) D:DA
"RTN","PSOORED1",37,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORED1",38,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued due to editing while suspended."
"RTN","PSOORED1",39,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORED1",40,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORED1",41,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORED1",42,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORED1",43,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORED1",44,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_DUZ_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORED1",45,0)
 .I $G(PSOOIFLG),'$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item Edited."
"RTN","PSOORED1",46,0)
 .I '$G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Medication Route/Schedule Edited."
"RTN","PSOORED1",47,0)
 .I $G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item and Medication Route/Schedule Edited."
"RTN","PSOORED1",48,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORED1",49,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORED1",50,0)
 Q
"RTN","PSOORED1",51,0)
INS K X,QUIT,Y,DIR,DIRUT,DUOUT,DTOUT,DIC,INSDEL,UPMI,^TMP($J,"INS1")
"RTN","PSOORED1",52,0)
 I '$O(^PSRX(PSORXED("IRXN"),6,0)),'$O(PSORXED("DOSE",0)) D UPMI Q:$G(QUIT)  ;G INS1
"RTN","PSOORED1",53,0)
 I $G(^PSRX(PSORXED("IRXN"),"INS"))]"" S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS") K UPMI G INS1
"RTN","PSOORED1",54,0)
 K DD,GG F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S DD=$G(DD)+1
"RTN","PSOORED1",55,0)
 I $G(DD)=1 S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS1",$O(^PSRX(PSORXED("IRXN"),"INS1",0)),0) K UPMI,DD G INS1
"RTN","PSOORED1",56,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D  G INSX
"RTN","PSOORED1",57,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S ^TMP($J,"INS1",I,0)=^PSRX(PSORXED("IRXN"),"INS1",I,0)
"RTN","PSOORED1",58,0)
 .S ^TMP($J,"INS1",0)=^PSRX(PSORXED("IRXN"),"INS1",0)
"RTN","PSOORED1",59,0)
 .S DIC="^TMP($J,""INS1"",",DWPK=2,DWLW=80 D EN^DIWE I $G(X)="^" K ^TMP($J,"INS1") Q
"RTN","PSOORED1",60,0)
 .I '$O(^TMP($J,"INS1",0)) S INSDEL=1
"RTN","PSOORED1",61,0)
 .S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED1",62,0)
INS1 K Y,DIR,DIRUT,DUOUT,DTOUT,DIC,X
"RTN","PSOORED1",63,0)
 I $G(UPMI) K UPMI I $G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S PSORXED("FLD",114)=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSOORED1",64,0)
 S:$G(PSORXED("FLD",114))]"" DIR("B")=PSORXED("FLD",114)
"RTN","PSOORED1",65,0)
 S DIR("?")="Enter Quick codes or Free Text",DIR(0)="52,114" D ^DIR
"RTN","PSOORED1",66,0)
 I $D(DTOUT)!($D(DUOUT))!($G(PSORXED("FLD",114))=X) K PSORXED("FLD",114) G INSX
"RTN","PSOORED1",67,0)
 I X'="",X'="@" D SIG^PSOHELP G INS1:'$D(X)
"RTN","PSOORED1",68,0)
 S PSORXED("FLD",114)=X
"RTN","PSOORED1",69,0)
 I $G(INS1)]"" W " ("_$E(INS1,2,9999999)_")"
"RTN","PSOORED1",70,0)
 G:(X']""!(X="@")) INSX
"RTN","PSOORED1",71,0)
 S (PSORXED("INS"),PSORXED("SIG",1))=$E(INS1,2,9999999) D EN^PSOFSIG(.PSORXED)
"RTN","PSOORED1",72,0)
INSX I $P($G(^PS(55,PSODFN,"LAN")),"^") K DIR D
"RTN","PSOORED1",73,0)
 .I $G(^PSRX(PSORXED("IRXN"),"INSS"))]"" S PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORED1",74,0)
 .D SINS^PSODIR(.PSORXED) I $G(PSORXED("SINS"))']"" K ^PSRX(PSORXED("IRXN"),"INSS") Q
"RTN","PSOORED1",75,0)
 .S PSORXED("FLD",114.1)=PSORXED("SINS")
"RTN","PSOORED1",76,0)
 K DIRUT,DUOUT,DTOUT,DIR,X,Y,DIC,DWPK
"RTN","PSOORED1",77,0)
 Q
"RTN","PSOORED1",78,0)
INIT ;setup psorenw array
"RTN","PSOORED1",79,0)
 S PSORENW("RX0")=^PSRX(PSORENW("IRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSOORED1",80,0)
 I $G(PSOSIGFL),$G(PSORX("SIG"))]"" S PSORENW("SIG")=PSORX("SIG"),SIGOK=0
"RTN","PSOORED1",81,0)
 E  D
"RTN","PSOORED1",82,0)
 .I '$P($G(^PSRX(PSORENW("IRXN"),"SIG")),"^",2) S PSORENW("SIG")=$P($G(^("SIG")),"^")
"RTN","PSOORED1",83,0)
 .E  D
"RTN","PSOORED1",84,0)
 ..S SIGOK=1 Q:$O(SIG(0))
"RTN","PSOORED1",85,0)
 ..S D=0 F I=0:0 S D=D+1,I=$O(^PSRX(PSORENW("IRXN"),"SIG1",I)) Q:'I  S SIG(D)=^PSRX(PSORENW("IRXN"),"SIG1",I,0)
"RTN","PSOORED1",86,0)
 ..K PSOX1,D
"RTN","PSOORED1",87,0)
 S PSORENW("OIRXN")=PSORENW("IRXN")
"RTN","PSOORED1",88,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSOORED1",89,0)
 S (PSORENW("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSOORED1",90,0)
 I $P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSOORED1",91,0)
 S PSORENW("CLINIC")=$S($G(PSORENW("CLINIC")):PSORENW("CLINIC"),1:$P(PSORENW("RX0"),"^",5))
"RTN","PSOORED1",92,0)
 S PSORENW("REMARKS")="New Order Created by "_$S($G(COPY)&('$G(PSOEDIT)):"copying",1:"editing")_" Rx # "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",93,0)
 S PSORENW("COSIGNER")=$S($G(PSORENW("COSIGNER")):PSORENW("COSIGNER"),$P(PSORENW("RX3"),"^",3):$P(PSORENW("RX3"),"^",3),1:"")
"RTN","PSOORED1",94,0)
 K:PSORENW("COSIGNER")="" PSORENW("COSIGNER")
"RTN","PSOORED1",95,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSOORED1",96,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSOORED1",97,0)
 S:$G(PSODRUG("IEN")) PSORENW("DRUG IEN")=PSODRUG("IEN")
"RTN","PSOORED1",98,0)
 I $G(PSORENW("DAYS SUPPLY")) G QTY
"RTN","PSOORED1",99,0)
 S PSORENW("DAYS SUPPLY")=$S($D(CLOZPAT):7,1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",100,0)
QTY S PSORENW("QTY")=$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSOORED1",101,0)
RFN S PSORENW("# OF REFILLS")=$S($D(CLOZPAT):0,$G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSOORED1",102,0)
 S (PSOID,Y,PSORENW("FILL DATE"),PSORENW("ISSUE DATE"))=DT
"RTN","PSOORED1",103,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(+PSORENW("CLINIC"),0),"^")
"RTN","PSOORED1",104,0)
 S PSORENW("PATIENT STATUS")=$S($G(PSORENW("PATIENT STATUS")):PSORENW("PATIENT STATUS"),'$P(PSORENW("RX0"),"^",3):$G(^PS(55,PSORENW("PSODFN"),"PS")),1:$P(PSORENW("RX0"),"^",3))
"RTN","PSOORED1",105,0)
 S PSORENW("PTST NODE")=$G(^PS(53,PSORENW("PATIENT STATUS"),0))
"RTN","PSOORED1",106,0)
 S PSDAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),'$P(PSORENW("RX0"),"^",8):$P(PSORENW("PTST NODE"),"^",3),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",107,0)
 I $G(PSODRUG("IEN")) S DREN=PSODRUG("IEN"),POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORED1",108,0)
 D:$G(PSORENW("# OF REFILLS"))']"" RF
"RTN","PSOORED1",109,0)
 S PSORENW("MAIL/WINDOW")=$S($G(PSORENW("MAIL/WINDOW"))]"":PSORENW("MAIL/WINDOW"),1:$P(PSORENW("RX0"),"^",11))
"RTN","PSOORED1",110,0)
 S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="W":"WINDOW",1:"MAIL")
"RTN","PSOORED1",111,0)
 S PSORENW("COPIES")=$S($G(PSORENW("COPIES")):PSORENW("COPIES"),$P(PSORENW("RX0"),"^",18):$P(PSORENW("RX0"),"^",18),1:1)
"RTN","PSOORED1",112,0)
 S PSORENW("CLERK CODE")=DUZ
"RTN","PSOORED1",113,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSOORED1",114,0)
 Q:$D(COPY)  S PSORENW("ENT")=0 ;Q:$G(PSOSIGFL)!($D(COPY))
"RTN","PSOORED1",115,0)
 K PSORENW("ENT") F I=0:0 S I=$O(PSORENW("DOSE",I)) Q:'I  S PSORENW("ENT")=$G(PSORENW("ENT"))+1
"RTN","PSOORED1",116,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED1",117,0)
 .K PSORXED("SIG"),DD
"RTN","PSOORED1",118,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S PSORENW("SIG",I)=^TMP($J,"INS1",I,0)
"RTN","PSOORED1",119,0)
 .K ^TMP($J,"INS1")
"RTN","PSOORED1",120,0)
 I $G(^PSRX(PSORENW("IRXN"),"INS"))]"" S PSORENW("INS")=^PSRX(PSORENW("IRXN"),"INS")
"RTN","PSOORED1",121,0)
 I $G(^PSRX(PSORENW("IRXN"),"INSS"))]"" S PSORENW("SINS")=^PSRX(PSORENW("IRXN"),"INSS")
"RTN","PSOORED1",122,0)
 I '$G(PSORENW("ENT")),'$G(PSOSIGFL) D DOLST1^PSOORED3(.PSORENW) S PSORENW("ENT")=+$G(OLENT)
"RTN","PSOORED1",123,0)
 Q
"RTN","PSOORED1",124,0)
RF ;# of refills
"RTN","PSOORED1",125,0)
 S PTRF=$S($P(PSORENW("PTST NODE"),"^",4)]"":$P(PSORENW("PTST NODE"),"^",4),1:11)
"RTN","PSOORED1",126,0)
 S CS=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S CS=1
"RTN","PSOORED1",127,0)
 I CS D
"RTN","PSOORED1",128,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOORED1",129,0)
 .S PSOX=$S('PSOX:0,PSDAYS=90:1,1:PSOX),PSDY1=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",130,0)
 E  D
"RTN","PSOORED1",131,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,PSDAYS=90:3,1:PSOX)
"RTN","PSOORED1",132,0)
 .S PSDY1=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",133,0)
 I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) S PSORENW("# OF REFILLS")=0
"RTN","PSOORED1",134,0)
 K PSDY,PSDY1,PTRF,PSOX,PSOX1,PSDAYS,CS
"RTN","PSOORED1",135,0)
 Q
"RTN","PSOORED1",136,0)
UPMI ;add dosing data for pre-poe rxs
"RTN","PSOORED1",137,0)
 W !! K PSONEW("DFLG"),DIR,DIRUT,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Dosing Instructions Are Missing!! Do You Want to Add Them"
"RTN","PSOORED1",138,0)
 D ^DIR I 'Y!($D(DIRUT)) S QUIT=1 K DIR,DIRUT,DUOT,DUOUT Q
"RTN","PSOORED1",139,0)
 S UPMI=1,EDTHLD=$G(PSORX("EDIT")) K PSORX("EDIT")
"RTN","PSOORED1",140,0)
 D DOSE1^PSOORED5(.PSORXED) S (PSORXED,PSORX("EDIT"))=EDTHLD K EDTHLD I $G(PSONEW("DFLG")) S QUIT=1
"RTN","PSOORED1",141,0)
 Q
"RTN","PSOORNE5")
0^12^B60770626^B59982805
"RTN","PSOORNE5",1,0)
PSOORNE5 ;BIR/SAB - display orders from backdoor con't ;5/10/07 8:29am
"RTN","PSOORNE5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,46,78,99,117,131,146,171,180,210,222,268,206**;DEC 1997;Build 39
"RTN","PSOORNE5",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNE5",4,0)
 ;External references L and UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORNE5",5,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORNE5",6,0)
 ;External reference to ^PS(50.607 supported by DBIA 2221
"RTN","PSOORNE5",7,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNE5",8,0)
 ;called from PSOORNE2
"RTN","PSOORNE5",9,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE5",10,0)
 ;
"RTN","PSOORNE5",11,0)
PEN ;pending orders
"RTN","PSOORNE5",12,0)
 K ^TMP("PSOPO",$J),PSORX("ISSUE DATE"),PSORX("FILL DATE") S ORSV=ORD,ORD=$P(PSOLST(ORN),"^",2)
"RTN","PSOORNE5",13,0)
 I $P($G(^PS(52.41,ORD,0)),"^",3)="DC"!($P($G(^(0)),"^",3)="DE") S VALMBCK="R" Q
"RTN","PSOORNE5",14,0)
 I $G(PSODFN)'=$P($G(^PS(52.41,ORD,0)),"^",2) S VALMBCK="" Q
"RTN","PSOORNE5",15,0)
 I $G(PSOTPBFG) N PSOTPPEN,PSOTPPEX S PSOTPPEN=ORD,PSOTPPEX=0 D VOPNR^PSOTPCAN I PSOTPPEX K PSOTPPEX,PSOTPPEN S VALMBCK="R" Q
"RTN","PSOORNE5",16,0)
 K PSOTPPEX,PSOTPPEN
"RTN","PSOORNE5",17,0)
 ;I '$G(PSOTPBFG) D DSPL^PSOTPCAN(ORD)
"RTN","PSOORNE5",18,0)
 ;S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" Q
"RTN","PSOORNE5",19,0)
 I '$G(PSOFIN) S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient."),VALMBCK="" K PSOPLCK Q
"RTN","PSOORNE5",20,0)
 K PSOPLCK ; D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)_"S") I '$G(PSOMSG) S VAMLSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),PSOACT="" K PSOMSG G OK ;VALMBCK="" Q
"RTN","PSOORNE5",21,0)
 S PSODRG=+$P($G(^PS(52.41,ORD,0)),"^",9) I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S VALMSG="This Drug has been Inactivated."
"RTN","PSOORNE5",22,0)
 K PSOMSG S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEF",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORNE5",23,0)
OK S PAT=PSODFN,PSORNSV=ORN,PSORNLT=PSLST D ORD^PSOORFIN S PSLST=PSORNLT,ORD=ORSV,ORN=PSORNSV K ORSV,PSORNSV,PSORNLT,PSODRUG S VALMBCK="R"
"RTN","PSOORNE5",24,0)
 K ORCHK,ORDRG,PSOFDR,SIGOK,PSONEW,PSORX("ISSUE DATE"),PSORX("FILL DATE"),PSORX("FN")
"RTN","PSOORNE5",25,0)
 K:'$G(MEDP) PAT
"RTN","PSOORNE5",26,0)
 D CLEAN^PSOVER1 ;S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSOORNE5",27,0)
 I '$G(PSOFIN) D UL^PSSLOCK(PSODFN)
"RTN","PSOORNE5",28,0)
 Q
"RTN","PSOORNE5",29,0)
RXNCHK S PSOY=$O(PSONEW("OLD LAST RX#","")) I PSOY="" D AUTO^PSONRXN Q
"RTN","PSOORNE5",30,0)
 S PSONRXN("TYPE")=$S('+$G(^PS(59,+PSOSITE,2)):8,PSODRUG("DEA")["A"&(+$G(^PS(59,+PSOSITE,2))):3,1:8)
"RTN","PSOORNE5",31,0)
 S PSONEW("QFLG")=0 I PSOY'=PSONRXN("TYPE"),$P($G(PSOPAR),"^",7)=1 D
"RTN","PSOORNE5",32,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORNE5",33,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORNE5",34,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORNE5",35,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORNE5",36,0)
 .L +^PS(59,+PSOSITE,PSONRXN("TYPE")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORNE5",37,0)
 .S PSOX1=^PS(59,+PSOSITE,PSONRXN("TYPE")),PSONRXN("LO")=$P(PSOX1,"^")
"RTN","PSOORNE5",38,0)
 .S PSONRXN("HI")=$P(PSOX1,"^",2),PSOI=$P(PSOX1,"^",3),PSONEW("OLD LAST RX#",PSONRXN("TYPE"))=PSOI
"RTN","PSOORNE5",39,0)
 .S:PSOI<PSONRXN("LO") PSOI=PSONRXN("LO")
"RTN","PSOORNE5",40,0)
 .D LOOP2 I PSONEW("QFLG") L -^PS(59,+PSOSITE,PSONRXN("TYPE")),-^PSRX("B",PSOI) Q
"RTN","PSOORNE5",41,0)
 .K DIC,DIE,DA S DIE=59,DA=PSOSITE
"RTN","PSOORNE5",42,0)
 .S DR=$S(PSONRXN("TYPE")=8:"2003////"_PSOI,PSONRXN("TYPE")=3:"1002.1////"_PSOI,1:"2003////"_PSOI)
"RTN","PSOORNE5",43,0)
 .S PSONEW("RX #")=PSOI D ^DIE K DIE,DIC,DR,DA L -^PS(59,+PSOSITE,PSONRXN("TYPE"))
"RTN","PSOORNE5",44,0)
 .K PSOX1,PSONRXN,PSOI,X,Y
"RTN","PSOORNE5",45,0)
 Q
"RTN","PSOORNE5",46,0)
LOOP2 F  S PSOI=PSOI+1 D:PSOI>PSONRXN("HI") FATAL^PSONRXN Q:'$D(^PSRX("B",PSOI))!PSONEW("QFLG")
"RTN","PSOORNE5",47,0)
 L +^PSRX("B",PSOI):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I $D(^PSRX("B",PSOI))!'$T G LOOP2
"RTN","PSOORNE5",48,0)
 L -^PSRX("B",PSOI)
"RTN","PSOORNE5",49,0)
 Q
"RTN","PSOORNE5",50,0)
RDSPL S PSODIR("CS")=0
"RTN","PSOORNE5",51,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSODIR("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSODIR("CS"),"^",2)=1
"RTN","PSOORNE5",52,0)
 I $P($G(PSODIR("CS")),"^",2)=1 S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=0 Q
"RTN","PSOORNE5",53,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=0 Q
"RTN","PSOORNE5",54,0)
 I $D(CLOZPAT) S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=$S($G(CLOZPAT)=2&(PSONEW("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSONEW("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSONEW("DAYS SUPPLY")=7):1,1:0) Q
"RTN","PSOORNE5",55,0)
 I PSODIR("CS") D
"RTN","PSOORNE5",56,0)
 .S PSOX=5,PSOX1=$S($P($G(PSONEW("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSONEW("PTST NODE")),"^",4)),PSOX=$S(PSOX1=5:PSOX,1:PSOX1)
"RTN","PSOORNE5",57,0)
 .S PSOX=$S('PSOX:0,PSONEW("DAYS SUPPLY")=90:1,1:PSOX),PSDY=PSONEW("DAYS SUPPLY"),PSDY1=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNE5",58,0)
 .I PSONEW("# OF REFILLS")>PSOX S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=PSOX
"RTN","PSOORNE5",59,0)
 E  D
"RTN","PSOORNE5",60,0)
 .S PSOX=11,PSOX1=$S($P($G(PSONEW("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSONEW("PTST NODE")),"^",4)),PSOX=$S(PSOX1=11:PSOX,1:PSOX1)
"RTN","PSOORNE5",61,0)
 .S PSDY=PSONEW("DAYS SUPPLY"),PSDY1=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNE5",62,0)
 .I PSONEW("# OF REFILLS")>PSOX S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=PSOX
"RTN","PSOORNE5",63,0)
 Q
"RTN","PSOORNE5",64,0)
GET ;
"RTN","PSOORNE5",65,0)
 I $P(PSODRUG0,"^",3)["2" S (ACTREF,ACTREN)=0 Q
"RTN","PSOORNE5",66,0)
 S (ACTREF,ACTREN)=1
"RTN","PSOORNE5",67,0)
 ;refills
"RTN","PSOORNE5",68,0)
 I ST S ACTREF=0
"RTN","PSOORNE5",69,0)
 I '$P(PSOPAR,"^",11),$G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S ACTREF=0,VALMSG="Inactive Drug, Non Refillable!"
"RTN","PSOORNE5",70,0)
 ;I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" S ACTREF=0
"RTN","PSOORNE5",71,0)
 S PSORFRM=$P(RX0,"^",9) F PSOJ=0:0 S PSOJ=$O(^PSRX(RXN,1,PSOJ)) Q:'PSOJ  S PSORFRM=PSORFRM-1
"RTN","PSOORNE5",72,0)
 S:PSORFRM<0 PSORFRM=0 S:PSORFRM=0 ACTREF=0
"RTN","PSOORNE5",73,0)
 I $G(RXFL(RXN))]"",'$P(PSOPAR,"^",6) S ACTREF=0
"RTN","PSOORNE5",74,0)
 I $P(PSODRUG0,"^",3)["A"&($P(PSODRUG0,"^",3)'["B")!($P(PSODRUG0,"^",3)["F")!($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2) S ACTREF=0
"RTN","PSOORNE5",75,0)
 ;renews
"RTN","PSOORNE5",76,0)
 I $P(PSOPAR,"^",4)=0 S ACTREN=0 Q
"RTN","PSOORNE5",77,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" S ACTREN=0
"RTN","PSOORNE5",78,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S ACTREN=0,VALMSG="This Drug has been Inactivated."
"RTN","PSOORNE5",79,0)
 I '$P($G(^PSDRUG(PSODRG,2)),"^"),'$P($G(^PSRX(RXN,"OR1")),"^") S ACTREN=0,VALMSG="Drug must be Matched to an Orderable Item!"
"RTN","PSOORNE5",80,0)
 I ($P(PSODRUG0,"^",3)["W")!($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2) S ACTREN=0
"RTN","PSOORNE5",81,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) S ACTREN=0
"RTN","PSOORNE5",82,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 S ACTREN=0
"RTN","PSOORNE5",83,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12 S ACTREN=0
"RTN","PSOORNE5",84,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0
"RTN","PSOORNE5",85,0)
 Q
"RTN","PSOORNE5",86,0)
INST ;formats instruction from front door
"RTN","PSOORNE5",87,0)
 D INST^PSOORNE6 Q
"RTN","PSOORNE5",88,0)
PC ;displays provider comments
"RTN","PSOORNE5",89,0)
 D PC^PSOORNE6 Q
"RTN","PSOORNE5",90,0)
INST1 ;formats instruction from front door
"RTN","PSOORNE5",91,0)
 D INST1^PSOORNE6 Q
"RTN","PSOORNE5",92,0)
PC1 ;displays provider comments
"RTN","PSOORNE5",93,0)
 D PC1^PSOORNE6 Q
"RTN","PSOORNE5",94,0)
DOSE ;displays dosing instruction for both simple and complex backdoor Rxs.
"RTN","PSOORNE5",95,0)
 I '$O(^PSRX(RXN,6,0))  S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (3)          Dosage: " Q
"RTN","PSOORNE5",96,0)
 S DS=1 F I=0:0 S I=$O(^PSRX(RXN,6,I)) Q:'I  S DOSE=^PSRX(RXN,6,I,0) D
"RTN","PSOORNE5",97,0)
 .I '$P(DOSE,"^",2),$P(DOSE,"^",9)]"" S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Verb: "_$P(DOSE,"^",9)
"RTN","PSOORNE5",98,0)
 .I $G(DS)=1 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (3)"
"RTN","PSOORNE5",99,0)
 .D DOSE1 S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORNE5",100,0)
 K DOSE,I
"RTN","PSOORNE5",101,0)
 Q
"RTN","PSOORNE5",102,0)
DOSE1 ;
"RTN","PSOORNE5",103,0)
 I $G(DS)=1 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"         *Dosage: "_$S($E($P(DOSE,"^"),1)="."&($P(DOSE,"^",2)):"0",1:"")_$P(DOSE,"^")_$S($P(DOSE,"^",3)]"":" ("_$P(^PS(50.607,$P(DOSE,"^",3),0),"^")_")",1:"") K DS G DU
"RTN","PSOORNE5",104,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="             *Dosage: "_$S($E($P(DOSE,"^"),1)="."&($P(DOSE,"^",2)):"0",1:"")_$P(DOSE,"^")_$S($P(DOSE,"^",3)]"":" ("_$P(^PS(50.607,$P(DOSE,"^",3),0),"^")_")",1:"")
"RTN","PSOORNE5",105,0)
DU I '$P(DOSE,"^",2),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(^PSRX(RXN,6,I,1))
"RTN","PSOORNE5",106,0)
 I $P(DOSE,"^",2),$P(DOSE,"^",9)]"" D
"RTN","PSOORNE5",107,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Verb: "_$P(DOSE,"^",9)
"RTN","PSOORNE5",108,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="      Dispense Units: "_$S($E($P(DOSE,"^",2),1)=".":"0",1:"")_$P(DOSE,"^",2)
"RTN","PSOORNE5",109,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Noun: "_$P(DOSE,"^",4)
"RTN","PSOORNE5",110,0)
 I $P(DOSE,"^",7) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="              *Route: "_$P(^PS(51.2,$P(DOSE,"^",7),0),"^")
"RTN","PSOORNE5",111,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           *Schedule: "_$P(DOSE,"^",8)
"RTN","PSOORNE5",112,0)
 I $P(DOSE,"^",5)]"" D
"RTN","PSOORNE5",113,0)
 .S DUR=$S($E($P(DOSE,"^",5),1)'?.N:$E($P(DOSE,"^",5),2,99)_$E($P(DOSE,"^",5),1),1:$P(DOSE,"^",5))
"RTN","PSOORNE5",114,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           *Duration: "_DUR_" ("_$S($P(DOSE,"^",5)["M":"MINUTES",$P(DOSE,"^",5)["H":"HOURS",$P(DOSE,"^",5)["L":"MONTHS",$P(DOSE,"^",5)["W":"WEEKS",1:"DAYS")_")" K DUR
"RTN","PSOORNE5",115,0)
 I $P(DOSE,"^",6)]"" S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        *Conjunction: "_$S($P(DOSE,"^",6)="A":"AND",$P(DOSE,"^",6)="T":"THEN",$P(DOSE,"^",6)="X":"EXCEPT",1:"")
"RTN","PSOORNE5",116,0)
 Q
"RTN","PSOORNE5",117,0)
INS ;patient instructions                                        ;PSO*210
"RTN","PSOORNE5",118,0)
 I $G(^PSRX(RXN,"INS"))]"",'$O(^PSRX(RXN,"INS1",0)) D  K SG G SPINS
"RTN","PSOORNE5",119,0)
 .S PSORXED("SIG",1)=^PSRX(RXN,"INS")
"RTN","PSOORNE5",120,0)
 .D WORDWRAP^PSOUTLA2(^PSRX(RXN,"INS"),.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE5",121,0)
 ;
"RTN","PSOORNE5",122,0)
 I $O(^PSRX(RXN,"INS1",0)) D
"RTN","PSOORNE5",123,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"INS1",T)) Q:'T  D
"RTN","PSOORNE5",124,0)
 .. S (PSORXED("SIG",T),MIG)=^PSRX(RXN,"INS1",T,0)
"RTN","PSOORNE5",125,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE5",126,0)
SPINS K T,SG,MIG
"RTN","PSOORNE5",127,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="  Other Pat. Instruc: "_$S($G(^PSRX(RXN,"INSS"))]"":^PSRX(RXN,"INSS"),1:"")
"RTN","PSOORNE5",128,0)
 Q
"RTN","PSOORNE5",129,0)
SV S VALMSG="Pre-POE Rx. Please Compare Dosing Fields with SIG!"
"RTN","PSOORNE5",130,0)
 Q
"RTN","PSOORNEW")
0^13^B66909716^B66486192
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;4/25/07 8:50am
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206**;DEC 1997;Build 39
"RTN","PSOORNEW",3,0)
 ;^PS(50.7 -2223
"RTN","PSOORNEW",4,0)
 ;^PSDRUG -221
"RTN","PSOORNEW",5,0)
 ;^PS(50.606 -2174
"RTN","PSOORNEW",6,0)
 ;^PS(55 -2228
"RTN","PSOORNEW",7,0)
 ;
"RTN","PSOORNEW",8,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",9,0)
 ;
"RTN","PSOORNEW",10,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",11,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",12,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",13,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",14,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",15,0)
 .S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",16,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",17,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",18,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",19,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",20,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",21,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",22,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",23,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",24,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",25,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",26,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",27,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",29,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",31,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",32,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",33,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",34,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",35,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",36,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",38,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",39,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",40,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",41,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",42,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",43,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",44,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",45,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",46,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",47,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",48,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",49,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",50,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",51,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",52,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",53,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",54,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",55,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",57,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",58,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",59,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",60,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",61,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",62,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",63,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",64,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",65,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",66,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",67,0)
 Q
"RTN","PSOORNEW",68,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",69,0)
 Q
"RTN","PSOORNEW",70,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",71,0)
EDTSEL N LST,FLD,OUT D KV S OUT=0
"RTN","PSOORNEW",72,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",73,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",74,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",75,0)
 Q
"RTN","PSOORNEW",76,0)
ACP ;
"RTN","PSOORNEW",77,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",78,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",79,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",80,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",81,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",82,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",83,0)
 .D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",84,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",85,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",86,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",87,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",88,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",89,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",90,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",91,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",92,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",93,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",94,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",95,0)
 S PSONEW("POE")=1 D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2
"RTN","PSOORNEW",96,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",97,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",98,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",99,0)
 Q
"RTN","PSOORNEW",100,0)
KV K DIRUT,DUOUT,DTOUT,DIR
"RTN","PSOORNEW",101,0)
 Q
"RTN","PSOORNEW",102,0)
REF D REF^PSOORFI4
"RTN","PSOORNEW",103,0)
 Q
"RTN","PSOORNEW",104,0)
1 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",105,0)
 ;
"RTN","PSOORNEW",106,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",107,0)
 ;
"RTN","PSOORNEW",108,0)
3 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",109,0)
 ;
"RTN","PSOORNEW",110,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",111,0)
 ;
"RTN","PSOORNEW",112,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",113,0)
 ;
"RTN","PSOORNEW",114,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",115,0)
 ;
"RTN","PSOORNEW",116,0)
13 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",117,0)
 ;
"RTN","PSOORNEW",118,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",119,0)
 ;
"RTN","PSOORNEW",120,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1
"RTN","PSOORNEW",121,0)
 D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",122,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",123,0)
 Q
"RTN","PSOORNEW",124,0)
 ;
"RTN","PSOORNEW",125,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",126,0)
 ;
"RTN","PSOORNEW",127,0)
8 D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",128,0)
 ;
"RTN","PSOORNEW",129,0)
10 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",130,0)
 ;
"RTN","PSOORNEW",131,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",132,0)
 ;
"RTN","PSOORNEW",133,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",134,0)
 ;
"RTN","PSOORNEW",135,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",136,0)
 ;
"RTN","PSOORNEW",137,0)
DRGMSG ;
"RTN","PSOORNEW",138,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",139,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",140,0)
 K SG Q
"RTN","PSOORNW1")
0^14^B43500701^B42982549
"RTN","PSOORNW1",1,0)
PSOORNW1 ;ISC BHAM/SAB - continuation of finish of new order ;5/10/07 8:30am
"RTN","PSOORNW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,117,131,133,172,148,222,268,206**;DEC 1997;Build 39
"RTN","PSOORNW1",3,0)
 ;Reference ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOORNW1",4,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNW1",5,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSOORNW1",6,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by IA 4707
"RTN","PSOORNW1",7,0)
 ;
"RTN","PSOORNW1",8,0)
2 I $G(ORD) W !!,"Instructions: " D
"RTN","PSOORNW1",9,0)
 .S INST=0 F  S INST=$O(^PS(52.41,ORD,2,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,ORD,2,INST,0) D
"RTN","PSOORNW1",10,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORNW1",11,0)
 .S:'$D(PSODRUG("OI")) PSODRUG("OI")=$P(OR0,"^",8)
"RTN","PSOORNW1",12,0)
 .K INST,TY,MIG,SG
"RTN","PSOORNW1",13,0)
 S (PSDC,PSI)=0 W !!,"The following Drug(s) are available for selection:"
"RTN","PSOORNW1",14,0)
 F PSI=0:0 S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) D
"RTN","PSOORNW1",15,0)
 .S PSDC=PSDC+1 W !,PSDC_". "_$P(^PSDRUG(PSI,0),"^")_$S($P(^(0),"^",9):"     (N/F)",1:"")
"RTN","PSOORNW1",16,0)
 .S PSDC(PSDC)=PSI
"RTN","PSOORNW1",17,0)
 I PSDC=0 D
"RTN","PSOORNW1",18,0)
 . N X,DRG
"RTN","PSOORNW1",19,0)
 . S DRG=+$P($G(^PS(52.41,+$G(ORD),0)),"^",9)
"RTN","PSOORNW1",20,0)
 . S X=$$GET1^DIQ(50,DRG,100)
"RTN","PSOORNW1",21,0)
 . I X'="",(DT>X) D
"RTN","PSOORNW1",22,0)
 . . W !!,"   This Dispense Drug is now Inactive. You may select a"
"RTN","PSOORNW1",23,0)
 . . W !,"    new Orderable Item, or you can enter a new Order with"
"RTN","PSOORNW1",24,0)
 . . W !,"    an Active Drug.",!
"RTN","PSOORNW1",25,0)
 . E  W !!,"No drugs available!",!
"RTN","PSOORNW1",26,0)
 . K DIR S DIR(0)="E",DIR("A")="Press return to continue"
"RTN","PSOORNW1",27,0)
 . D ^DIR K DIR
"RTN","PSOORNW1",28,0)
 G:'PSDC ETX I $G(PSOBDRG),'$D(PSOBDR) M PSOBDR=PSODRUG
"RTN","PSOORNW1",29,0)
 I PSDC'=1 D
"RTN","PSOORNW1",30,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSOORNW1",31,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSOORNW1",32,0)
 W ! D KV S DIR(0)="N^1:"_PSDC,DIR("A")="Select Drug by number" D ^DIR
"RTN","PSOORNW1",33,0)
 I $D(DIRUT) S OUT=1 G EX
"RTN","PSOORNW1",34,0)
 D KV K PSOY S PSOY=PSDC(Y),PSOY(0)=^PSDRUG(PSOY,0),PSOCSIG=0
"RTN","PSOORNW1",35,0)
 I $G(PSOBDR("IEN")),PSOBDR("IEN")'=+PSOY D:$G(ORD)  G:$D(DIRUT) EX
"RTN","PSOORNW1",36,0)
 .D KV S DIR(0)="Y",DIR("B")="YES",DIR("A",1)="You have changed the dispense drug from",DIR("A",2)=PSOBDR("NAME")_" to "_$P(^PSDRUG(+PSOY,0),"^")_".",DIR("A")="Do You want to Edit the SIG"
"RTN","PSOORNW1",37,0)
 .D ^DIR I $D(DIRUT) S OUT=1 Q
"RTN","PSOORNW1",38,0)
 .S:Y PSOCSIG=1
"RTN","PSOORNW1",39,0)
 .I 'Y D URX I $D(DIRUT) S OUT=1 Q
"RTN","PSOORNW1",40,0)
 D KV
"RTN","PSOORNW1",41,0)
CT1 I $P($G(^PSDRUG(PSOY,"CLOZ1")),"^")="PSOCLO1",'$O(^YSCL(603.01,"C",PSODFN,0)) S VALMSG="Patient Not Registered in Clozapine Program",VALMBCK="Q" K PSOY,PSDC Q
"RTN","PSOORNW1",42,0)
 S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2),PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSOORNW1",43,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORNW1",44,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORNW1",45,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSOORNW1",46,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSOORNW1",47,0)
 I $G(^PSDRUG(+PSOY,660))']"" D:'$G(PSOFIN)&('$G(PSOCOPY)) POST^PSODRG G ETX
"RTN","PSOORNW1",48,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORNW1",49,0)
 D:'$G(PSOFIN)&('$G(PSOCOPY)) POST^PSODRG
"RTN","PSOORNW1",50,0)
 I $G(PSORX("DFLG")) K PSODRUG N LST Q:$G(PSOAC)!($G(NEWEDT))  D DSPL^PSOORFI1 S VALMBCK="Q" Q
"RTN","PSOORNW1",51,0)
ETX D REF S VALMBCK="R" I 'PSDC S VALMSG="NO dispense drugs tied to this orderable item!" S PSOQFLG=1
"RTN","PSOORNW1",52,0)
TX D KV K PSDC,PSI,X,Y,PSOX1,PSOY
"RTN","PSOORNW1",53,0)
 Q
"RTN","PSOORNW1",54,0)
EX M PSODRUG=PSOBDR K PSOBDR,PSOBDRG S PSOQFLG=1,VALMBCK="R" D MP1^PSOOREDX
"RTN","PSOORNW1",55,0)
 D TX Q
"RTN","PSOORNW1",56,0)
URX D KV S DIR(0)="Y",DIR("A")="Are You Sure You Want to Update Rx",DIR("B")="Yes"
"RTN","PSOORNW1",57,0)
 D ^DIR S:$D(DIRUT)!('Y) DIRUT=1
"RTN","PSOORNW1",58,0)
 Q
"RTN","PSOORNW1",59,0)
REF Q:'$D(PSODRUG("DEA"))!('$G(PSODRUG("IEN")))!('$G(^PS(55,PSODFN,"PS")))
"RTN","PSOORNW1",60,0)
 S PSONEW("CS")=0,PTRF=$S(+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",4)]""):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",4),1:5)
"RTN","PSOORNW1",61,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSONEW("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSONEW("CS"),"^",2)=1
"RTN","PSOORNW1",62,0)
 I $P($G(PSONEW("CS")),"^",2)=1 S PSONEW("# OF REFILLS")=0 Q
"RTN","PSOORNW1",63,0)
 I +PSONEW("CS") D
"RTN","PSOORNW1",64,0)
 .S PSOX=$S($P($G(OR0),"^",11)>5:5,1:+$P($G(OR0),"^",11))
"RTN","PSOORNW1",65,0)
 .S PSOX=$S(PSOX>PTRF:PTRF,1:PSOX)
"RTN","PSOORNW1",66,0)
 .S PSONEW("# OF REFILLS")=PSOX
"RTN","PSOORNW1",67,0)
 E  D
"RTN","PSOORNW1",68,0)
 .S PSOX=$S($P($G(OR0),"^",11)'>PTRF&($P($G(OR0),"^",11)'>11):11,1:PTRF)
"RTN","PSOORNW1",69,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) S PSOX=0,PSONEW("# OF REFILLS")=0 K PSDY,PSDY1,PTRF Q
"RTN","PSOORNW1",70,0)
 I $D(CLOZPAT) S (PSOX,PSONEW("N# REF"),PSONEW("# OF REFILLS"))=$S(CLOZPAT=2&($G(PSONEW("# OF REFILLS"))>2):3,CLOZPAT&($G(PSONEW("# OF REFILLS"))>1):1,1:0),PSONEW("DAYS SUPPLY")=7,ORCHK=1 K PSDY,PSDY1,PTRF Q
"RTN","PSOORNW1",71,0)
 S PSONEW("# OF REFILLS")=$S($G(PSONEW("# OF REFILLS"))'="":$G(PSONEW("# OF REFILLS")),1:PSOX) K PSDY,PSDY1,PTRF
"RTN","PSOORNW1",72,0)
 Q
"RTN","PSOORNW1",73,0)
EDNEW K PSMAX,PSFMAX F DEA=1:1 Q:$E(PSODEA,DEA)=""  I $E(+PSODEA,DEA)>1,$E(+PSODEA,DEA)<6 S CS=1
"RTN","PSOORNW1",74,0)
 I CS D
"RTN","PSOORNW1",75,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOORNW1",76,0)
 .S PSOX=$S('PSOX:0,PSDAYS=90:1,1:PSOX),PSDY1=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0) S MAX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNW1",77,0)
 E  D
"RTN","PSOORNW1",78,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,PSDAYS=90:3,1:PSOX)
"RTN","PSOORNW1",79,0)
 .S PSDY1=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0) S MAX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNW1",80,0)
 I PSRF>MAX D
"RTN","PSOORNW1",81,0)
 .W $C(7),!!,PSRF_" refills are not correct for a "_PSDAYS_" day supply.",!,"Please enter correct # of refills for a "_PSDAYS_" day supply. Max refills allowed is "_MAX_".",!
"RTN","PSOORNW1",82,0)
 .S (PSMAX("MAX"),PSFMAX("MAX"))=MAX,(PSMAX("RF"),PSFMAX("RF"))=PSRF,(PSMAX("DAYS"),PSFMAX("DAYS"))=PSDAYS,(PSMAX,PSFMAX)=1
"RTN","PSOORNW1",83,0)
 K PSTMAX D EDSTAT
"RTN","PSOORNW1",84,0)
 Q
"RTN","PSOORNW1",85,0)
STATDAY K PSMAX,PSRMAX,PSFMAX,PSTMAX S PSDAYS=$P(^PSRX(DA,0),"^",8),PSRF=$P(^PSRX(DA,0),"^",9),PTST=$P(^PS(53,X,0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOORNW1",86,0)
EDSTAT I PSRF>PTRF W !,$C(7),PSRF_" refills are greater than "_PTRF_" allowed for "_$P(PTST,"^")_" Rx Patient Status.",! S PSTMAX=1,PSTMAX("PTRF")=PTRF,PSTMAX("PSRF")=PSRF,PSTMAX("PT")=$P(PTST,"^")
"RTN","PSOORNW1",87,0)
 Q
"RTN","PSOORNW1",88,0)
OERF S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSOORNW1",89,0)
 S DIR("B")=$S($G(POERR):PSONEW("# OF REFILLS"),$G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",90,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the Rx Patient Status because there is no Dispense Drug."
"RTN","PSOORNW1",91,0)
 D ^DIR G:$D(DIRUT) REFX
"RTN","PSOORNW1",92,0)
 S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=Y
"RTN","PSOORNW1",93,0)
REFX S:'$D(PSONEW("# OF REFILLS")) PSONEW("# OF REFILLS")=$S($G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSOX1)]""&($G(PSOX)>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",94,0)
 K X,Y,PSOX,PSOX1,PSDY,PSDY1,DEA
"RTN","PSOORNW1",95,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORNW1",96,0)
 Q
"RTN","PSOORNW2")
0^15^B45461771^B43693860
"RTN","PSOORNW2",1,0)
PSOORNW2 ;ISC-BHAM/SAB - edit orders from oerr ; 6/28/07 11:36am
"RTN","PSOORNW2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,23,37,46,117,131,133,148,222,269,206**;DEC 1997;Build 39
"RTN","PSOORNW2",3,0)
 ;Reference to ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOORNW2",4,0)
 ;Reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORNW2",5,0)
 ;Reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOORNW2",6,0)
 ;Reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORNW2",7,0)
 ;Reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORNW2",8,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by IA 4707
"RTN","PSOORNW2",9,0)
 ;
"RTN","PSOORNW2",10,0)
1 I $G(PSODRUG("OI")) M:$G(PSOBDRG) PSOBDR=PSODRUG W !!,"Current Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSOORNW2",11,0)
 S DIC("B")=$S($G(PSODRUG("OIN"))]"":PSODRUG("OIN"),1:""),DIC="^PS(50.7,",DIC(0)="AEMQZ"
"RTN","PSOORNW2",12,0)
 S DIC("S")="I '$P(^PS(50.7,+Y,0),""^"",4)!($P(^(0),""^"",4)'<DT) N PSOF,PSOL S (PSOF,PSOL)=0 F  S PSOL=$O(^PSDRUG(""ASP"",+Y,PSOL)) Q:PSOF!'PSOL  "
"RTN","PSOORNW2",13,0)
 S DIC("S")=DIC("S")_"I $P($G(^PSDRUG(PSOL,2)),U,3)[""O"",'$G(^(""I""))!($G(^(""I""))'<DT) S PSOF=1"
"RTN","PSOORNW2",14,0)
 ;BHW;PSO*7*269;Modify ^DIC call to call MIX^DIC to use only the B and C Cross-References.
"RTN","PSOORNW2",15,0)
 S D="B^C" D MIX^DIC1 K DIC,D I X["^"!($D(DTOUT)) S OUT=1 Q
"RTN","PSOORNW2",16,0)
 S PSOY=Y
"RTN","PSOORNW2",17,0)
 I +Y'=OI D  I 'Y!($D(DIRUT)) D KV,MP1^PSOOREDX K DIC,Y,PSOY S OUT=1 Q
"RTN","PSOORNW2",18,0)
 .D KV S DIR(0)="Y",DIR("B")="NO",DIR("A",1)="",DIR("A")="This edit will create a new order.  Do you want to continue" D ^DIR
"RTN","PSOORNW2",19,0)
 G:Y<1 1 S PSODRUG("OI")=+PSOY,PSODRUG("OIN")=$P(PSOY,"^",2),PSONEW("CLERK CODE")=DUZ D KV K DIC,PSOY
"RTN","PSOORNW2",20,0)
 N PSOIC S PSOIC=1 D DREN
"RTN","PSOORNW2",21,0)
 D 2^PSOORNEW Q
"RTN","PSOORNW2",22,0)
4 S PSONEW("FLD")=1 D ISSDT^PSODIR2(.PSONEW) ; Issue Date
"RTN","PSOORNW2",23,0)
 I PSOID>PSONEW("FILL DATE") S PSONEW("FILL DATE")=PSOID,PSORX("FILL DATE")=PSORX("ISSUE DATE")
"RTN","PSOORNW2",24,0)
 Q
"RTN","PSOORNW2",25,0)
 ;
"RTN","PSOORNW2",26,0)
5 S PSONEW("FLD")=2 D FILLDT^PSODIR2(.PSONEW) ; Fill date
"RTN","PSOORNW2",27,0)
 Q
"RTN","PSOORNW2",28,0)
 ;
"RTN","PSOORNW2",29,0)
INS S PSONEW("FLD")=114 D INS^PSODIR(.PSONEW) ; Pat Inst
"RTN","PSOORNW2",30,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") D SINS^PSODIR(.PSONEW)
"RTN","PSOORNW2",31,0)
 Q
"RTN","PSOORNW2",32,0)
 ;
"RTN","PSOORNW2",33,0)
3 S PSONEW("FLD")=3 D PTSTAT^PSODIR1(.PSONEW) ; Get Patient Status
"RTN","PSOORNW2",34,0)
 I +$G(^PS(55,PSODFN,"PS")) S RXPT=+^("PS") I $G(^PS(53,RXPT,0))]"" D  Q
"RTN","PSOORNW2",35,0)
 .S PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>+$P(^PS(53,RXPT,0),"^",4):+$P(^PS(53,RXPT,0),"^",4),1:+$P(OR0,"^",11)),PSOMAX=+$P(^PS(53,RXPT,0),"^",4)
"RTN","PSOORNW2",36,0)
 .S PSOMAX=$S($G(PSOCS):5,1:11),PSOMAX=$S(PSOMAX>+$P(^PS(53,RXPT,0),"^",4):+$P(^PS(53,RXPT,0),"^",4),1:PSOMAX)
"RTN","PSOORNW2",37,0)
 .S PSONEW("# OF REFILLS")=$S(PSONEW("# OF REFILLS")>PSOMAX:PSOMAX,1:PSONEW("# OF REFILLS"))
"RTN","PSOORNW2",38,0)
 I $G(PSOMAX) S PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>PSOMAX:PSOMAX,1:+$P(OR0,"^",11))
"RTN","PSOORNW2",39,0)
 I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D
"RTN","PSOORNW2",40,0)
 .S PSONEW("# OF REFILLS")=0,VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["A":"this narcotic drug.",1:"this drug.")
"RTN","PSOORNW2",41,0)
 Q
"RTN","PSOORNW2",42,0)
 ;
"RTN","PSOORNW2",43,0)
12 S PSONEW("FLD")=4 D PROV^PSODIR(.PSONEW) ; Get Provider
"RTN","PSOORNW2",44,0)
 Q
"RTN","PSOORNW2",45,0)
 ;
"RTN","PSOORNW2",46,0)
11 S PSONEW("FLD")=5 D CLINIC^PSODIR2(.PSONEW) ; Get Clinic
"RTN","PSOORNW2",47,0)
 Q
"RTN","PSOORNW2",48,0)
 ;
"RTN","PSOORNW2",49,0)
8 S PSONEW("FLD")=7 D QTY^PSODIR1(.PSONEW) ; Get quantity
"RTN","PSOORNW2",50,0)
 Q
"RTN","PSOORNW2",51,0)
 ;
"RTN","PSOORNW2",52,0)
7 I '$G(PSODRUG("IEN")) W $C(7),!!,"No Dispense Drug!",! K DIR,DUOUT,DIRUT,DTOUT D 2^PSOORNW1
"RTN","PSOORNW2",53,0)
 I '$G(PSODRUG("IEN")) W !,$C(7),"No Dispense Drug Selected! A new Orderable Item may need to be selected.",! Q
"RTN","PSOORNW2",54,0)
 S PSONEW("FLD")=8 D DAYS^PSODIR1(.PSONEW) ; Get days supply
"RTN","PSOORNW2",55,0)
 Q:'$G(PSONEW("PATIENT STATUS"))
"RTN","PSOORNW2",56,0)
 K PSDY,PSDY1,PSMAX,PSTMAX S PSDAYS=PSONEW("DAYS SUPPLY"),PSRF=PSONEW("# OF REFILLS"),PTST=$P(^PS(53,PSONEW("PATIENT STATUS"),0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4),PSODEA=PSODRUG("DEA"),CS=0 ;D EDNEW^PSOORNW1
"RTN","PSOORNW2",57,0)
 Q
"RTN","PSOORNW2",58,0)
9 ;
"RTN","PSOORNW2",59,0)
 I '$G(PSONEW("PATIENT STATUS")) W !!,"Rx Patient Status required!",! D 3 I '$G(PSONEW("PATIENT STATUS")) S VALMSG="Rx Patient Status required!",VALMBCK="R" Q
"RTN","PSOORNW2",60,0)
 I +$G(^PS(55,PSODFN,"PS")) S RXPT=+^("PS") I $G(^PS(53,RXPT,0))]"" D  G ASK
"RTN","PSOORNW2",61,0)
 .S PSOMAX=$S($G(CLOZPAT)=2:3,$G(CLOZPAT)=1:1,$G(CLOZPAT)=0:0,1:+$P(^PS(53,RXPT,0),"^",4)) K RXPT
"RTN","PSOORNW2",62,0)
 .S:'$G(PSONEW("# OF REFILLS")) PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>PSOMAX:PSOMAX,1:+$P(OR0,"^",11))
"RTN","PSOORNW2",63,0)
 .S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=$S(PSONEW("# OF REFILLS")>PSOMAX:PSOMAX,1:PSONEW("# OF REFILLS"))
"RTN","PSOORNW2",64,0)
 .I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D  Q
"RTN","PSOORNW2",65,0)
 ..S (PSOMAX,PSONEW("N# REF"),PSONEW("# OF REFILLS"))=0,VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["A":"this narcotic drug.",1:"this drug.")
"RTN","PSOORNW2",66,0)
 .I $D(PSODRUG("DEA")) F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSOMAX=5
"RTN","PSOORNW2",67,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A"&($G(PSODRUG("DEA"))'["B")!($G(PSODRUG("DEA"))["F")!($G(PSODRUG("DEA"))[1)!($G(PSODRUG("DEA"))[2) D  Q
"RTN","PSOORNW2",68,0)
 .S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=0,VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["A":"this narcotic drug.",1:"this drug.")
"RTN","PSOORNW2",69,0)
 S (PSONEW("N# REF"),PSOMAX,PSONEW("# OF REFILLS"))=+$P(OR0,"^",11)
"RTN","PSOORNW2",70,0)
ASK S PSONEW("FLD")=9 D REFILL^PSODIR1(.PSONEW) ; Get # of refills
"RTN","PSOORNW2",71,0)
 K PSOMAX,PSMAX,PSTMAX S PSDAYS=PSONEW("DAYS SUPPLY"),PSRF=PSONEW("# OF REFILLS"),PTST=$P(^PS(53,PSONEW("PATIENT STATUS"),0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4),PSODEA=$G(PSODRUG("DEA")),CS=0 D EDNEW^PSOORNW1
"RTN","PSOORNW2",72,0)
 Q
"RTN","PSOORNW2",73,0)
 ;
"RTN","PSOORNW2",74,0)
6 Q  K DA S PSONEW("FLD")=10 D SIG^PSODIR1(.PSONEW) ; Get sig
"RTN","PSOORNW2",75,0)
 I $G(PSONEW("SIG"))]"" D EN^PSOSIGNO(ORD,PSONEW("SIG")) S SIG(1)=PSONEW("SIG")
"RTN","PSOORNW2",76,0)
 I $G(PSOSIGFL) D
"RTN","PSOORNW2",77,0)
 .K DIRUT,DUOUT,DTOUT,DIR S DIR(0)="Y",DIR("B")="NO",DIR("A",1)="",DIR("A")="This edit will create a new order.  Do you want to continue" D ^DIR
"RTN","PSOORNW2",78,0)
 .I 'Y!($D(DIRUT)) K DIR,DIRUT,DUOUT,DTOUT,DIC,Y,PSOSIGFL,PSONEW("SIG") S SIGOK=1
"RTN","PSOORNW2",79,0)
 S PSONEW("CLERK CODE")=DUZ K DIR,DIRUT,DUOUT,DTOUT,DIC,Y
"RTN","PSOORNW2",80,0)
 Q
"RTN","PSOORNW2",81,0)
 ;
"RTN","PSOORNW2",82,0)
13 S PSONEW("FLD")=11 D COPIES^PSODIR1(.PSONEW) ; Get # of copies
"RTN","PSOORNW2",83,0)
 Q
"RTN","PSOORNW2",84,0)
 ;
"RTN","PSOORNW2",85,0)
10 S PSONEW("FLD")=12 D MW^PSODIR2(.PSONEW) ; Get Mail/Window Info
"RTN","PSOORNW2",86,0)
 Q
"RTN","PSOORNW2",87,0)
 ;
"RTN","PSOORNW2",88,0)
14 S PSONEW("FLD")=13 D RMK^PSODIR2(.PSONEW) ; Get Remarks
"RTN","PSOORNW2",89,0)
 Q
"RTN","PSOORNW2",90,0)
DREN ;
"RTN","PSOORNW2",91,0)
 S (PSDC,PSI)=0
"RTN","PSOORNW2",92,0)
 F  S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) S PSDC=PSDC+1,PSDC(PSDC)=PSI
"RTN","PSOORNW2",93,0)
 I PSDC'=1 D  G DRENX
"RTN","PSOORNW2",94,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSOORNW2",95,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSOORNW2",96,0)
 K PSOY S PSI=PSDC(1),PSOY=^PSDRUG(PSI,0)
"RTN","PSOORNW2",97,0)
 I $P($G(^PSDRUG(PSI,"CLOZ1")),"^")="PSOCLO1",'$O(^YSCL(603.01,"C",PSODFN,0)) K PSOY,PSI Q
"RTN","PSOORNW2",98,0)
 S PSODRUG("IEN")=+PSI,PSODRUG("VA CLASS")=$P(PSOY,"^",2),PSODRUG("NAME")=$P(PSOY,"^")
"RTN","PSOORNW2",99,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSI,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORNW2",100,0)
 S PSODRUG("MAXDOSE")=$P(PSOY,"^",4),PSODRUG("DEA")=$P(PSOY,"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSI,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORNW2",101,0)
 S PSODRUG("SIG")=$P(PSOY,"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSI,$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(+PSI,660.1))
"RTN","PSOORNW2",102,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSI,81)
"RTN","PSOORNW2",103,0)
 G:$G(^PSDRUG(+PSI,660))']"" DRENX
"RTN","PSOORNW2",104,0)
 S PSOX1=$G(^PSDRUG(+PSI,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORNW2",105,0)
DRENX K PSDC,PSI,PSOY,Y,PSOXI,X Q
"RTN","PSOORNW2",106,0)
KV K DIR,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORRNW")
0^16^B20892446^B20397916
"RTN","PSOORRNW",1,0)
PSOORRNW ;BIR/SAB-finish OP renew orders from OE/RR ;4/25/07 8:46am
"RTN","PSOORRNW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,51,46,71,94,130,131,146,206**;DEC 1997;Build 39
"RTN","PSOORRNW",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORRNW",4,0)
 ;External reference to ^PS(50.607 supported by DBIA 2221
"RTN","PSOORRNW",5,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORRNW",6,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOORRNW",7,0)
 S PSORENXX=$P($G(OR0),"^",21),PSOFROM="NEW" K PRC,PHI
"RTN","PSOORRNW",8,0)
 I $G(PSORENXX) D PSOL^PSSLOCK(PSORENXX) I '$G(PSOMSG) D  K DIR,PSOMSG W ! S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR K DIR W ! Q
"RTN","PSOORRNW",9,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P(PSOMSG,"^",2) Q
"RTN","PSOORRNW",10,0)
 .W $C(7),!!,"Another person is editing Rx "_$P($G(^PSRX(PSORENXX,0)),"^")
"RTN","PSOORRNW",11,0)
 K PSOMSG N OI,VALMCNT K POERR("DFLG") D FULL^VALM1 S (PSORX("DFLG"),PSORENW("DFLG"))=0,(PSORNW("FILL DATE"),PSORENW("FILL DATE"))=DT
"RTN","PSOORRNW",12,0)
 S Y=DT X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSOORRNW",13,0)
 W !!,"Now Renewing Rx # "_$P(^PSRX($P(OR0,"^",21),0),"^")_"   Drug: "_$P($G(^PSDRUG($P(^PSRX($P(OR0,"^",21),0),"^",6),0)),"^"),! H 2
"RTN","PSOORRNW",14,0)
 I $P($G(^PSRX($P(OR0,"^",21),"OR1")),"^",4) D  D PROCESSX^PSORENW0 D UL Q
"RTN","PSOORRNW",15,0)
 .W !!,"Cannot Renew Rx # "_$P(^PSRX($P(OR0,"^",21),0),"^"),!," Drug: "_$P($G(^PSDRUG($P(^PSRX($P(OR0,"^",21),0),"^",6),0)),"^")_"."
"RTN","PSOORRNW",16,0)
 .W !,"This Rx has already been RENEWED ("_$P(^PSRX($P(^PSRX($P(OR0,"^",21),"OR1"),"^",4),0),"^")_").",!
"RTN","PSOORRNW",17,0)
 .S ACOM="Duplicate Renewal Request. Order rejected by Pharmacy.",PSONOOR="D" D DE^PSOORFI2 K ACOM,POERR("COMM"),POERR("PLACER"),POERR("STAT")
"RTN","PSOORRNW",18,0)
 I '$G(PSOTPBFG) D DSPL^PSOTPCAN(ORD)
"RTN","PSOORRNW",19,0)
 S (PSORX("PROVIDER NAME"),PSORENW("PROVIDER NAME"))=$P(^VA(200,$P(OR0,"^",5),0),"^"),PSORENW("NOO")=$P(OR0,"^",7)
"RTN","PSOORRNW",20,0)
 S PSORENW("PROVIDER")=$P(OR0,"^",5),PSORENW("MAIL/WINDOW")=$S($P(OR0,"^",17)="M":"M",1:"W")
"RTN","PSOORRNW",21,0)
 I $O(^PSRX($P(OR0,"^",21),"PRC",0)) F I=0:0 S I=$O(^PSRX($P(OR0,"^",21),"PRC",I)) Q:'I  S PRC(I)=^PSRX($P(OR0,"^",21),"PRC",I,0)
"RTN","PSOORRNW",22,0)
 K II F I=0:0 S I=$O(^PS(52.41,ORD,1,I)) Q:'I  S DOSE=$G(^PS(52.41,ORD,1,I,1)),DOSE1=$G(^(2)) D 
"RTN","PSOORRNW",23,0)
 .S II=$G(II)+1
"RTN","PSOORRNW",24,0)
 .S PSORENW("DOSE",II)=$P(DOSE1,"^"),PSORENW("DOSE ORDERED",II)=$P(DOSE1,"^",2),PSORENW("UNITS",II)=$P(DOSE,"^",9),PSORENW("NOUN",II)=$P(DOSE,"^",5)
"RTN","PSOORRNW",25,0)
 .S:$P(DOSE,"^",9) UNITS=$P(^PS(50.607,$P(DOSE,"^",9),0),"^")
"RTN","PSOORRNW",26,0)
 .S PSORENW("VERB",II)=$P(DOSE,"^",10),PSORENW("ROUTE",II)=$P(DOSE,"^",8)
"RTN","PSOORRNW",27,0)
 .S:$P(DOSE,"^",8) ROUTE=$P(^PS(51.2,$P(DOSE,"^",8),0),"^")
"RTN","PSOORRNW",28,0)
 .S PSORENW("SCHEDULE",II)=$P(DOSE,"^"),PSORENW("DURATION",II)=$P(DOSE,"^",2)
"RTN","PSOORRNW",29,0)
 .I $P(DOSE,"^",6)]"" S PSORENW("CONJUNCTION",II)=$S($P(DOSE,"^",6)="S":"T",$P(DOSE,"^",6)="X":"X",1:"A")
"RTN","PSOORRNW",30,0)
 S PSORENW("ENT")=+$G(II) K II,I
"RTN","PSOORRNW",31,0)
 F DR=1:1:PSORENW("ENT") I $G(PSORENW("DURATION",DR))]"" D
"RTN","PSOORRNW",32,0)
 .S DUR1=PSORENW("DURATION",DR)
"RTN","PSOORRNW",33,0)
 .S PSORENW("DURATION",DR)=$S($E(DUR1,1)'?.N:$E(DUR1,2,99)_$E(DUR1,1),1:DUR1)
"RTN","PSOORRNW",34,0)
 D ^PSORENW1,CHECK^PSORENW0 I PSORENW("DFLG") D KLIB^PSORENW1 D PROCESSX^PSORENW0 D UL Q
"RTN","PSOORRNW",35,0)
 D FILDATE^PSORENW0,DRUG^PSORENW0 I PSORENW("DFLG")!$G(PSORX("DFLG")) D KLIB^PSORENW1 D PROCESSX^PSORENW0 D UL Q
"RTN","PSOORRNW",36,0)
 D RXN^PSORENW0 I PSORENW("DFLG") D KLIB^PSORENW1 D PROCESSX^PSORENW0 D UL Q
"RTN","PSOORRNW",37,0)
 D STOP^PSORENW1,INIT^PSORENW3
"RTN","PSOORRNW",38,0)
 I $G(PSOORRNW) D
"RTN","PSOORRNW",39,0)
 .S PSORENW("ISSUE DATE")=$S(PSORENW("FILL DATE")>DT:DT,PSORENW("FILL DATE")<$E($P(OR0,"^",6),1,7):PSORENW("FILL DATE"),1:$E($P(OR0,"^",6),1,7))
"RTN","PSOORRNW",40,0)
 .S PSORENW("# OF REFILLS")=+$P(OR0,"^",11),PSOFDR=1
"RTN","PSOORRNW",41,0)
 .S PSORENW("CLERK CODE")=$P(OR0,"^",4),PSORX("CLERK CODE")=$P(^VA(200,$P(OR0,"^",4),0),"^")
"RTN","PSOORRNW",42,0)
 ;D CHK
"RTN","PSOORRNW",43,0)
 S PSOFXRN=0,PSOFXRNX=1
"RTN","PSOORRNW",44,0)
 S PSORENW("POE")=$S($G(^PS(52.41,ORD,"POE"))=1:1,'$O(^PSRX($P(OR0,"^",21),6,0)):1,1:"")
"RTN","PSOORRNW",45,0)
 D EN^PSOORNE4(.PSORENW) K PSORENW,PSORX("FILL DATE")
"RTN","PSOORRNW",46,0)
 I '$G(PSOFXRN) D UL
"RTN","PSOORRNW",47,0)
 D KLIB^PSORENW1
"RTN","PSOORRNW",48,0)
 K PSOFXRN,PSOFXRNX
"RTN","PSOORRNW",49,0)
 Q
"RTN","PSOORRNW",50,0)
CHK ;check for valid # of refills
"RTN","PSOORRNW",51,0)
 I $G(PSODRUG("DEA"))]"" D
"RTN","PSOORRNW",52,0)
 .S PSOCS=0 K DIR,DIC,PSOX
"RTN","PSOORRNW",53,0)
 .F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOCS,"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOCS,"^",2)=1
"RTN","PSOORRNW",54,0)
 .;PSO*7*206
"RTN","PSOORRNW",55,0)
 .S PSOMAX=$S(PSOCS:5,1:11) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F")!(PSODRUG("DEA")[1)!(PSODRUG("DEA")[2) S PSOMAX=0
"RTN","PSOORRNW",56,0)
 E  S PSOMAX=$P(OR0,"^",11)
"RTN","PSOORRNW",57,0)
 S RXPT=+$P(PSORENW("RX0"),"^",3) I $G(^PS(53,RXPT,0))]"" D
"RTN","PSOORRNW",58,0)
 .S PSORENW("# OF REFILLS")=$S(+$P(OR0,"^",11)>+$P(^PS(53,RXPT,0),"^",4):+$P(^PS(53,RXPT,0),"^",4),1:+$P(OR0,"^",11)),PSOX=+$P(^PS(53,RXPT,0),"^",4)
"RTN","PSOORRNW",59,0)
 .S PSORENW("# OF REFILLS")=$S(PSORENW("# OF REFILLS")>PSOMAX:PSOMAX,1:PSORENW("# OF REFILLS"))
"RTN","PSOORRNW",60,0)
 .S PSOMAX=$S(PSOMAX>+$P(^PS(53,RXPT,0),"^",4):+$P(^PS(53,RXPT,0),"^",4),1:PSOMAX) K RXPT
"RTN","PSOORRNW",61,0)
 E  D
"RTN","PSOORRNW",62,0)
 . I $G(PSOMAX) S PSORENW("# OF REFILLS")=$S(+$P(OR0,"^",11)>PSOMAX:PSOMAX,1:+$P(OR0,"^",11))
"RTN","PSOORRNW",63,0)
 Q
"RTN","PSOORRNW",64,0)
 ;
"RTN","PSOORRNW",65,0)
EDTPEN ;edit front door renews
"RTN","PSOORRNW",66,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D EDTSEL^PSOORNE4
"RTN","PSOORRNW",67,0)
 Q
"RTN","PSOORRNW",68,0)
UL I $G(PSORENXX) D PSOUL^PSSLOCK(PSORENXX)
"RTN","PSOORRNW",69,0)
 K PSORENXX
"RTN","PSOORRNW",70,0)
 Q
"RTN","PSOP7206")
0^^B1276310^n/a
"RTN","PSOP7206",1,0)
PSOP7206 ;SMT - PSO*7*206 Post Install ; 10/17/07 7:40am
"RTN","PSOP7206",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**206**;APR 2007;Build 39
"RTN","PSOP7206",3,0)
 ;
"RTN","PSOP7206",4,0)
 ;Enter at EN^PSOP7206 for POST INSTALL PSO*7*206
"RTN","PSOP7206",5,0)
 ;Cleanup routine, to fix erroneous listings of partials in the
"RTN","PSOP7206",6,0)
 ;activity log.
"RTN","PSOP7206",7,0)
 ;
"RTN","PSOP7206",8,0)
 ;
"RTN","PSOP7206",9,0)
EN ;
"RTN","PSOP7206",10,0)
 N XMMG,XMSTRIP,XMROU,XMYBLOB,XMZ,XMDUZ,XMSUB,XMTEXT,DIFROM,XMY,X,CNT,OP,VAR
"RTN","PSOP7206",11,0)
 S OP(1)="DRUG DEA CODES MAY HAVE CHANGED. PATCH PSO*7*206 HAS BEEN INSTALLED."
"RTN","PSOP7206",12,0)
 S OP(2)="SCHEDULING CHANGES HAVE BEEN MADE AND SHOULD HAVE BEEN VERIFIED."
"RTN","PSOP7206",13,0)
 S OP(3)="FOR MORE INFORMATION PLEASE SEE PATCH PSS*1*126."
"RTN","PSOP7206",14,0)
 S XMDUZ=.5,XMSUB="VERIFY DRUG SCHEDULING CHANGES",XMTEXT="OP("
"RTN","PSOP7206",15,0)
 S X="" F  S X=$O(^XUSEC("PSNMGR",X)) Q:'X  S XMY(X)=""
"RTN","PSOP7206",16,0)
 D ^XMD
"RTN","PSOP7206",17,0)
 Q
"RTN","PSOP7206",18,0)
 ; 
"RTN","PSOREF")
0^19^B66253301^B65936340
"RTN","PSOREF",1,0)
PSOREF ;BIR/SAB-refill data entry ;4/25/07 8:45am
"RTN","PSOREF",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,23,27,36,46,78,130,131,148,206**;DEC 1997;Build 39
"RTN","PSOREF",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOREF",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOREF",5,0)
 ;
"RTN","PSOREF",6,0)
EOJ ;
"RTN","PSOREF",7,0)
 K PSOMSG,PSOREF,PSORX("BAR CODE"),PSOLIST,LFD,MAX,MIN,NODE,PS,PSOERR,REF,RF,RXO,RXN,RXP,RXS,SD,VAERR,PSORX("FILL DATE")
"RTN","PSOREF",8,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOREF",9,0)
 Q
"RTN","PSOREF",10,0)
OERR ;single refil
"RTN","PSOREF",11,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSOREF",12,0)
 I $D(RXRP($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Reprint Label has been requested!" Q
"RTN","PSOREF",13,0)
 I $D(RXPR($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Partial has already been requested!" Q
"RTN","PSOREF",14,0)
 I $D(RXRS($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="Rx is being pulled from suspense!" Q
"RTN","PSOREF",15,0)
 I $D(RXFL($P(PSOLST(ORN),"^",2))) S PTRX=$P(PSOLST(ORN),"^",2) D ^PSOCMOPT I '$G(PSOXFLAG) K PSOXFLAG S VALMBCK="",VALMSG="Fill already requested for CMOP!" Q
"RTN","PSOREF",16,0)
 K PSOXFLAG
"RTN","PSOREF",17,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG Q
"RTN","PSOREF",18,0)
 N RXN K PSORX("FILL DATE") D FULL^VALM1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=$P(PSOLST(ORN),"^",2),PSOREF("QFLG")=0
"RTN","PSOREF",19,0)
 K PSOID D ^PSOREF1 I PSOREF("DFLG") D EOJ S VALMBCK="R" Q
"RTN","PSOREF",20,0)
 D ^PSOREF0
"RTN","PSOREF",21,0)
 W ! K DIR,DIRUT,DTOUT,DUOUT S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT,DUOUT S PSORXED=1 D ^PSOBUILD,ACT^PSOORNE2 K PSORXED S VALMBCK="Q" D EOJ
"RTN","PSOREF",22,0)
 Q
"RTN","PSOREF",23,0)
SPEED ;speed refill
"RTN","PSOREF",24,0)
 K LST,PSORX("FILL DATE") N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOREF",25,0)
 K DIR,DIRUT S DIR(0)="Y",DIR("B")="NO",DIR("A")="Barcode Refill",DIR("?")="If you want to use a barcode reader to process refills enter 'Y'."
"RTN","PSOREF",26,0)
 D ^DIR K DIR,DUOUT,DTOUT I $D(DIRUT) S VALMBCK="" Q
"RTN","PSOREF",27,0)
 G BCREF:Y
"RTN","PSOREF",28,0)
 K PSOREF,PSOFDR,DIR,DUOUT,DIRUT S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" Q
"RTN","PSOREF",29,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +Y S (ASK,SPEED,PSOOELSE)=1 D FULL^VALM1 S LST=Y D  G:$G(PSOREF("DFLG"))!($G(PSOREF("QFLG"))) SPEEDX
"RTN","PSOREF",30,0)
 .F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""!($G(PSOREF("QFLG")))  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52
"RTN","PSOREF",31,0)
 ..I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2)) W $C(7),!!,"Rx "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" has OPEN/UNRESOLVED 3rd Party Payer Reject!" K DIR D PAUSE^VALM1 Q
"RTN","PSOREF",32,0)
 ..D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")),! D PAUSE^VALM1 K PSOMSG Q
"RTN","PSOREF",33,0)
 ..K PSOMSG I $D(RXRP($P(PSOLST(ORN),"^",2))) W $C(7),!!,"A Reprint Label has been requested!" D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",34,0)
 ..I $D(RXPR($P(PSOLST(ORN),"^",2))) W $C(7),!!,"A Partial has already been requested!" D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",35,0)
 ..I $D(RXFL($P(PSOLST(ORN),"^",2))) S PTRX=$P(PSOLST(ORN),"^",2) D ^PSOCMOPT I '$G(PSOXFLAG) K PSOXFLAG W $C(7),!!,"A CMOP fill has already been requested for Rx "_$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^") D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",36,0)
 ..K PSOXFLAG I $D(RXRS($P(PSOLST(ORN),"^",2))) W $C(7),!!,"Rx is being pulled from suspense!" D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",37,0)
 ..I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=11 D  D ULK Q
"RTN","PSOREF",38,0)
 ...W $C(7),!!?5,"RX "_$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^")_" is in an EXPIRED status." W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSOREF",39,0)
 ..S PSOREF("IRXN")=$P(PSOLST(ORN),"^",2) I ASK D ^PSOREF1 S ASK=0 D:$G(PSOREF("QFLG")) ULK Q:$G(PSOREF("QFLG"))
"RTN","PSOREF",40,0)
 ..N RXN D FULL^VALM1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=$P(PSOLST(ORN),"^",2)
"RTN","PSOREF",41,0)
 ..I PSOREF("DFLG") D EOJ S VALMBCK="R" Q
"RTN","PSOREF",42,0)
 ..D ^PSOREF0 D ULK
"RTN","PSOREF",43,0)
 S:'$G(PSOOELSE) VALMBCK=""
"RTN","PSOREF",44,0)
 S PSORXED=1 D ^PSOBUILD,BLD^PSOORUT1
"RTN","PSOREF",45,0)
SPEEDX K PSOREF,PSORX("BAR CODE"),PSOLIST,LFD,MAX,MIN,NODE,PS,PSOERR,REF,RF,RXO,RXN,RXP,RXS,SD,VAERR,PSORX("FILL DATE")
"RTN","PSOREF",46,0)
 K LST,SPEED,PSORXED,PSOREF,PSOFDR,PSOOELSE,ASK S:'$D(VALMBCK) VALMBCK="R"
"RTN","PSOREF",47,0)
 K PSORX("FILL DATE"),PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOREF",48,0)
 Q
"RTN","PSOREF",49,0)
BCREF ;barcode refills
"RTN","PSOREF",50,0)
 K LST,DIR,DIRUT,DUOUT,DTOUT D FULL^VALM1
"RTN","PSOREF",51,0)
ASK S DIR(0)="FO^5:245^K:X'?3N1""-""1.N X",DIR("A")="WAND BARCODE"
"RTN","PSOREF",52,0)
 S DIR("?",1)="Wand the barcoded number of the prescription to be processed."
"RTN","PSOREF",53,0)
 S DIR("?",2)="The number should be of the form NNN-NNNNNN",DIR("?",3)="where the number before the dash is your station number."
"RTN","PSOREF",54,0)
 S DIR("?")="Enter ""^"", or a RETURN to quit."
"RTN","PSOREF",55,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) S VALMBCK="" G BCREFX
"RTN","PSOREF",56,0)
 I $G(X)']"",'$G(LST) S VALMBCK="" G BCREFX
"RTN","PSOREF",57,0)
 I $D(DIRUT),+$G(LST) D  S VALMBCK="R" G BCREFX
"RTN","PSOREF",58,0)
 .K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT
"RTN","PSOREF",59,0)
 .S (BCREF,ASK,SPEED,PSOOELSE)=1 D FULL^VALM1 D
"RTN","PSOREF",60,0)
 ..F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""!($G(PSOREF("QFLG")))  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52
"RTN","PSOREF",61,0)
 ...I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2)) W $C(7),!!,"Rx "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" has OPEN/UNRESOLVED 3rd Party Payer Reject!" K DIR D PAUSE^VALM1 Q
"RTN","PSOREF",62,0)
 ...D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")),! D PAUSE^VALM1 K PSOMSG Q
"RTN","PSOREF",63,0)
 ...K PSOMSG I $D(RXRP($P(PSOLST(ORN),"^",2))) W $C(7),!!,"A Reprint Label has been requested for Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),! D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",64,0)
 ...I $D(RXPR($P(PSOLST(ORN),"^",2))) W $C(7),!!,"A Partial has already been requested for Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),! D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",65,0)
 ...I $D(RXFL($P(PSOLST(ORN),"^",2))) S PTRX=$P(PSOLST(ORN),"^",2) D ^PSOCMOPT I '$G(PSOXFLAG) K PSOXFLAG W $C(7),!!,"A CMOP fill has already been requested for Rx "_$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^") D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",66,0)
 ...K PSOXFLAG I $D(RXRS($P(PSOLST(ORN),"^",2))) W $C(7),!!,"Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")_" is being pulled from suspense!" D ULK D PAUSE^VALM1 Q
"RTN","PSOREF",67,0)
 ...S PSOREF("IRXN")=$P(PSOLST(ORN),"^",2) I ASK D ^PSOREF1 S ASK=0 D:$G(PSOREF("DFLG")) ULK Q:$G(PSOREF("DFLG"))
"RTN","PSOREF",68,0)
 ...N RXN D FULL^VALM1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL" S PSOREF("DFLG")=0,PSOREF("IRXN")=$P(PSOLST(ORN),"^",2)
"RTN","PSOREF",69,0)
 ...I PSOREF("DFLG") D EOJ S VALMBCK="R" Q
"RTN","PSOREF",70,0)
 ...D ^PSOREF0 D ULK
"RTN","PSOREF",71,0)
 F RX=1:1:PSOCNT I $P(PSOLST(RX),"^",2)=$P(X,"-",2) D  Q
"RTN","PSOREF",72,0)
 .I $D(PSOBBC(RX)) Q
"RTN","PSOREF",73,0)
 .S LST=$G(LST)_RX_",",PSOBBC(RX)=1
"RTN","PSOREF",74,0)
 G ASK
"RTN","PSOREF",75,0)
BCREFX K BCREF,ASK,LST,SPEED,RX,PSOBBC,DIR,DIRUT,PSORXED,PSOREF,PSOFDR,PSOOELSE S PSORXED=1 D ^PSOBUILD,BLD^PSOORUT1
"RTN","PSOREF",76,0)
 S VALMBCK="R" Q
"RTN","PSOREF",77,0)
REFILL(PLACER) ;passes flag to CPRS for front door refill request
"RTN","PSOREF",78,0)
 ;PLACER=PHARMACY NUMBER
"RTN","PSOREF",79,0)
 N PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSODEA
"RTN","PSOREF",80,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSOREF",81,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSOREF",82,0)
 S RX0=^PSRX(RXN,0),PSODRG=$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0),PSODEA=$P($G(^(0)),"^",3),DIV=$P(^PSRX(RXN,2),"^",9),PSORFRM=$P(RX0,"^",9)
"RTN","PSOREF",83,0)
 I PSODEA["2" Q "0^Schedule 2 Drug. Order cannot be refilled."
"RTN","PSOREF",84,0)
 I '$P($G(^PSRX(RXN,"OR1")),"^"),'$P($G(^PSDRUG(PSODRG,2)),"^") Q "0^Cannot Refill. Drug not matched to a Pharmacy Orderable Item."
"RTN","PSOREF",85,0)
 I '$P($G(^PSRX(RXN,"OR1")),"^"),$P($G(^PSDRUG(PSODRG,2)),"^") S $P(^PSRX(RXN,"OR1"),"^")=$P(^PSDRUG(PSODRG,2),"^")
"RTN","PSOREF",86,0)
 S CLOZPAT=$S($P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1":1,1:0)
"RTN","PSOREF",87,0)
 I 'CLOZPAT I PSODEA["A"&(PSODEA'["B")!(PSODEA["F")!(PSODEA[1)!(PSODEA[2) Q "0^"_$S(PSODEA["A":"Narcotic Drug. ",1:"")_"Order Non-Refillable."
"RTN","PSOREF",88,0)
 K CLOZPAT I DT>$P($G(^PSRX(RXN,2)),"^",6) Q "0^Non-Refillable.  Prescription has Expired."
"RTN","PSOREF",89,0)
 I $P(^PSRX(RXN,3),"^",2)>$P(^PSRX(RXN,2),"^",6) Q "0^Next Refill Date Past Expiration Date.  New Order Required."
"RTN","PSOREF",90,0)
 I '$P($G(^PS(59,DIV,1)),"^",11),$G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^Inactive Drug, Non Refillable."
"RTN","PSOREF",91,0)
 I ST Q "0^Prescription is in a Non-Refillable Status."
"RTN","PSOREF",92,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Cannot Refill. Drug No Longer Used by Outpatient Pharmacy."
"RTN","PSOREF",93,0)
 S PSORFRM=$P(RX0,"^",9) F PSOJ=0:0 S PSOJ=$O(^PSRX(RXN,1,PSOJ)) Q:'PSOJ  S PSORFRM=PSORFRM-1
"RTN","PSOREF",94,0)
 I PSORFRM<1 Q "0^No Refills remaining. New Med order required."
"RTN","PSOREF",95,0)
 I $P(^PSRX(RXN,3),"^"),DT=$P(^PSRX(RXN,3),"^") Q "0^Can't Refill, Fill Date already exists for "_$E($P(^PSRX(RXN,3),"^"),4,5)_"/"_$E($P(^PSRX(RXN,3),"^"),6,7)_"/"_$E($P(^PSRX(RXN,3),"^"),2,3)_"."
"RTN","PSOREF",96,0)
 I $P(^PSRX(RXN,3),"^"),DT<$P(^PSRX(RXN,3),"^") Q "0^Can't Refill, later Refill Date already exists for "_$E($P(^PSRX(RXN,3),"^"),4,5)_"/"_$E($P(^PSRX(RXN,3),"^"),6,7)_"/"_$E($P(^PSRX(RXN,3),"^"),2,3)_"."
"RTN","PSOREF",97,0)
 I $O(^PS(52.41,"ARF",RXN,0)) Q "0^Pending Refill Request already exists."
"RTN","PSOREF",98,0)
 Q 1
"RTN","PSOREF",99,0)
 ;
"RTN","PSOREF",100,0)
ULK D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOREF",101,0)
 Q
"RTN","PSORENW")
0^20^B35245784^B34935503
"RTN","PSORENW",1,0)
PSORENW ;BIR/SAB-renew main driver ;4/25/07 8:42am
"RTN","PSORENW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,30,46,71,96,100,130,148,206**;DEC 1997;Build 39
"RTN","PSORENW",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW",4,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",5,0)
 ;External reference to LK^ORX2 and ULK^ORX2 supported by DBIA 867
"RTN","PSORENW",6,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW",7,0)
 ;External reference to MAIN^TIUEDIT supported by DBIA 2410
"RTN","PSORENW",8,0)
 ;
"RTN","PSORENW",9,0)
ASK ;
"RTN","PSORENW",10,0)
 K PSORENW("FILL DATE") D FILLDT^PSODIR2(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",11,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",12,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW",13,0)
 D MW^PSOCMOPA(.PSORENW)
"RTN","PSORENW",14,0)
 I PSORENW("DFLG") S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",15,0)
 S PSORNW("MAIL/WINDOW")=PSORENW("MAIL/WINDOW") S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="M":"MAIL",1:"WINDOW")
"RTN","PSORENW",16,0)
 D NOORE^PSONEW(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",17,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0
"RTN","PSORENW",18,0)
ASKX Q
"RTN","PSORENW",19,0)
 ;
"RTN","PSORENW",20,0)
EOJ ;
"RTN","PSORENW",21,0)
 K VERB,RTE,DRET,PSOMSG,PSORNW,PSOLIST,PSORENW,PSORX("BAR CODE"),PSORX("FILL DATE"),PSODIR,PSOID,PSONOOR,PSOCOU,PSOCOUU,PSOID,PSOFDMX,PSODRUG,COPY,PSOBCKDR
"RTN","PSORENW",22,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN D
"RTN","PSORENW",23,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW",24,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW",25,0)
 K RXN,RXN1,^TMP("PSORXN",$J)
"RTN","PSORENW",26,0)
 I $G(PSONOTE) D MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSORENW",27,0)
 K PSONOTE
"RTN","PSORENW",28,0)
 Q
"RTN","PSORENW",29,0)
OERR ;entry for renew backdoor
"RTN","PSORENW",30,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSORENW",31,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW",32,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW",33,0)
 K PSOID,PSOFDMX,PSORX("FILL DATE"),PSORENW("FILL DATE"),PSORX("QS"),PSORENW("QS"),PSOBARCD,COPY
"RTN","PSORENW",34,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULPAT Q
"RTN","PSORENW",35,0)
 S PSOBCKDR=1,PSOFROM="NEW",PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0
"RTN","PSORENW",36,0)
 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSORENW",37,0)
 D FULL^VALM1,ASK D:PSORENW("QFLG") KLIB^PSORENW1 D:PSORENW("QFLG") ULPAT D:PSORENW("QFLG") PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) G:PSORENW("QFLG") EOJ D ^PSORENW0
"RTN","PSORENW",38,0)
 D ULPAT,EOJ,KLIB^PSORENW1 K PSOOPT,PSONEW,PSORX("DFLG")
"RTN","PSORENW",39,0)
 Q
"RTN","PSORENW",40,0)
ULPAT K PSOMSG D UL^PSSLOCK(PSODFN) S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSORENW",41,0)
 Q
"RTN","PSORENW",42,0)
RENEW(PLACER,PSOCPDRG) ;passes flag to CPRS for front door renews
"RTN","PSORENW",43,0)
 ;-1=couldn't find order, 0=unable to renew, 1=renewable
"RTN","PSORENW",44,0)
 ;Placer=Pharmacy number
"RTN","PSORENW",45,0)
 N PSOSURX,PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSONEWOI,PSOOLDOI,PSOIFLAG,PSOINA
"RTN","PSORENW",46,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",47,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",48,0)
 S RX0=^PSRX(RXN,0),PSODRG=+$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0)
"RTN","PSORENW",49,0)
 S PSOIFLAG=0,PSOOLDOI=+$P($G(^PSRX(RXN,"OR1")),"^"),PSONEWOI=+$P($G(^PSDRUG(+$G(PSODRG),2)),"^") I PSONEWOI,PSONEWOI'=PSOOLDOI S PSOIFLAG=1
"RTN","PSORENW",50,0)
 S PSOINA=$P($G(^PS(50.7,PSONEWOI,0)),"^",4)
"RTN","PSORENW",51,0)
 I PSOINA,DT>PSOINA Q "0^This Orderable Item has been Inactivated."
"RTN","PSORENW",52,0)
 I ST=5 S PSOSURX=$O(^PS(52.5,"B",RXN,0)) I PSOSURX,$P($G(^PS(52.5,PSOSURX,0)),"^",7)="L" Q "0^Rx loading into a CMOP Transmission."
"RTN","PSORENW",53,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,2)),"^",6)<X Q "0^Prescription Expired more than 120 Days."
"RTN","PSORENW",54,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,3)),"^",5),$P($G(^(3)),"^",5)<X,$P(^("STA"),"^")=12 Q "0^Prescription Discontinued more than 120 Days."
"RTN","PSORENW",55,0)
 I $G(PSOCPDRG),$G(PSOCPDRG)'=$G(PSODRG) Q "0^Drug Mismatch, Non-Renewable."
"RTN","PSORENW",56,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=RXN D CDOSE^PSORENW0 I PSOOLPF Q "0^Non-Renewable, invalid Dosage of "_$G(PSOOLPD)
"RTN","PSORENW",57,0)
 I PSONOSIG Q "0^Non-Renewable, missing Sig."
"RTN","PSORENW",58,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Drug is No longer used by Outpatient Pharmacy."
"RTN","PSORENW",59,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^This Drug has been Inactivated."
"RTN","PSORENW",60,0)
 I ($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2)!($P(PSODRUG0,"^",3)["W") Q "0^Non-Renewable "_$S($P(PSODRUG0,"^",3)["A":"Drug Narcotic.",1:"Drug.")
"RTN","PSORENW",61,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) Q "0^Non-Renewable Prescription."
"RTN","PSORENW",62,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 Q "0^Max number of renewals (26) has been reached."
"RTN","PSORENW",63,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12,ST'=14 Q "0^Prescritpion is in a Non-Renewable Status."
"RTN","PSORENW",64,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",4) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",65,0)
 I $O(^PS(52.41,"AQ",RXN,0)) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",66,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST
"RTN","PSORENW",67,0)
 Q 1_$S($G(PSOIFLAG):"^"_$G(PSONEWOI),1:"")
"RTN","PSORENW",68,0)
 ;
"RTN","PSORENW",69,0)
INST1 ;Set Pharmacy Instructions array
"RTN","PSORENW",70,0)
 N PSOTZ
"RTN","PSORENW",71,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=$G(^PSRX(RXN,"PI",0)),PSOTZ=0 D
"RTN","PSORENW",72,0)
 .F  S PSOTZ=$O(^PSRX(RXN,"PI",PSOTZ)) Q:PSOTZ=""  S PHI(PSOTZ)=$G(^PSRX(RXN,"PI",PSOTZ,0))
"RTN","PSORENW",73,0)
 Q
"RTN","PSORENW",74,0)
INST2 ;Set Instructions and Comments
"RTN","PSORENW",75,0)
 I '$G(PSORENW("OIRXN")) Q
"RTN","PSORENW",76,0)
 I $G(PSOFDR) Q
"RTN","PSORENW",77,0)
 N PSOPHL,PSOPRL
"RTN","PSORENW",78,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) K PHI S PHI=$G(^PSRX(PSORENW("OIRXN"),"PI",0)),PSOPHL="" D
"RTN","PSORENW",79,0)
 .F  S PSOPHL=$O(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL)) Q:PSOPHL=""  S PHI(PSOPHL)=$G(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL,0))
"RTN","PSORENW",80,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) K PRC S PRC=$G(^PSRX(PSORENW("OIRXN"),"PRC",0)),PSOPRL="" D
"RTN","PSORENW",81,0)
 .F  S PSOPRL=$O(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL)) Q:PSOPRL=""  S PRC(PSOPRL)=$G(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL,0))
"RTN","PSORENW",82,0)
 Q
"RTN","PSORENW0")
0^5^B79577371^B79440242
"RTN","PSORENW0",1,0)
PSORENW0 ;IHS/DSD/JCM-renew main driver continuation ;4/24/07 9:05am
"RTN","PSORENW0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,59,64,46,71,96,100,130,237,206**;DEC 1997;Build 39
"RTN","PSORENW0",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW0",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW0",5,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW0",6,0)
 ;
"RTN","PSORENW0",7,0)
 ;PSO*237 was not adding to Clozapine Override file, fix
"RTN","PSORENW0",8,0)
PROCESS ;
"RTN","PSORENW0",9,0)
 D ^PSORENW1
"RTN","PSORENW0",10,0)
 D INST2^PSORENW
"RTN","PSORENW0",11,0)
 I $D(PSORX("BAR CODE")),PSODFN'=PSORENW("PSODFN") D NEWPT
"RTN","PSORENW0",12,0)
 S PSORENW("DFLG")=0,PSORENW("FILL DATE")=PSORNW("FILL DATE")
"RTN","PSORENW0",13,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW0",14,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW0",15,0)
 D CHECK G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",16,0)
 D FILDATE
"RTN","PSORENW0",17,0)
 D DRUG G:PSORENW("DFLG")!PSORX("DFLG") PROCESSX
"RTN","PSORENW0",18,0)
 D RXN G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",19,0)
 D STOP^PSORENW1,OERR^PSORENW1:$G(PSOFDR)
"RTN","PSORENW0",20,0)
DSPL K PSOEDT,PSOLM D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",21,0)
 S PSORENW("QFLG")=0 D:'$G(PSOFDR) EDIT
"RTN","PSORENW0",22,0)
 G:PSORENW("DFLG")!$G(PSORX("FN")) PROCESSX
"RTN","PSORENW0",23,0)
 G:'$G(PSORX("FN"))&('$G(PSORENW("QFLG"))) DSPL
"RTN","PSORENW0",24,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) I PSORENW("DFLG")=1 G PROCESSX
"RTN","PSORENW0",25,0)
 I $G(NEWDOSE),PSORENW("ENT")>0 K NEWDOSE G DSPL
"RTN","PSORENW0",26,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW0",27,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW0",28,0)
 D CAN,DCORD^PSONEW2
"RTN","PSORENW0",29,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W"
"RTN","PSORENW0",30,0)
 ;PSO*237 add to Clozapine Override file
"RTN","PSORENW0",31,0)
ANQ I $G(ANQDATA)]"" D NOW^%DTC G:$D(^PS(52.52,"B",%)) ANQ D
"RTN","PSORENW0",32,0)
 . K DD,DO S DIC="^PS(52.52,",DIC(0)="L",DLAYGO=52.52,X=%
"RTN","PSORENW0",33,0)
 . D FILE^DICN K DIC,DLAYGO,DD,DO,DA,DR
"RTN","PSORENW0",34,0)
 . N PS52 S (PS52,DA)=+Y,DIE="^PS(52.52,",DR="1////"_PSORENW("IRXN")
"RTN","PSORENW0",35,0)
 . D ^DIE K DIE,DA,DR
"RTN","PSORENW0",36,0)
 . S $P(^PS(52.52,PS52,0),"^",3,6)=ANQDATA
"RTN","PSORENW0",37,0)
 . K ANQDATA,X,Y,%,ANQREM
"RTN","PSORENW0",38,0)
 ;
"RTN","PSORENW0",39,0)
PROCESSX I PSORENW("DFLG")!$G(PSRX("DFLG")) S PSOBBCLK=1 W:'$G(POERR) !,$C(7),"RENEWED RX DELETED",! D:$P($G(PSOLST(+$G(ORN))),"^",2) PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) S POERR("DFLG")=1 D CLEAN^PSOVER1
"RTN","PSORENW0",40,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW0",41,0)
 K PRC,PHI,PSOQUIT,BBRN,BBRN1,PSORENW,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC"),PSORX("FN")
"RTN","PSORENW0",42,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW0",43,0)
 D CLEAN^PSOVER1
"RTN","PSORENW0",44,0)
 Q
"RTN","PSORENW0",45,0)
 ;
"RTN","PSORENW0",46,0)
CHECK ;
"RTN","PSORENW0",47,0)
 I '$D(PSORX("BAR CODE")),PSORENW("PSODFN")'=PSODFN D  G CHECKX
"RTN","PSORENW0",48,0)
 .W !!,?5,$C(7),"Can't renew Rx # "_$P(PSORENW("RX0"),"^")_", it is not for this patient." S PSORENW("DFLG")=1
"RTN","PSORENW0",49,0)
 .S:$G(POERR) VALMSG="Can't renew Rx # "_$P(PSORENW("RX0"),"^")_", not for this patient.",VALMBCK="R"
"RTN","PSORENW0",50,0)
 ;Invalid dosage check
"RTN","PSORENW0",51,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=PSORENW("OIRXN") D CDOSE
"RTN","PSORENW0",52,0)
 I PSOOLPF!(PSONOSIG) D  G CHECKX
"RTN","PSORENW0",53,0)
 .S PSORENW("DFLG")=1
"RTN","PSORENW0",54,0)
 .W !!,$C(7),"Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_$S(PSOOLPF:", invalid dosage of "_$G(PSOOLPD),1:", Missing Sig")
"RTN","PSORENW0",55,0)
 .S:$G(POERR) VALMSG="Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_$S(PSOOLPF:", invalid Dosage of "_$G(PSOOLPD),1:", Missing Sig") S VALMBCK="R"
"RTN","PSORENW0",56,0)
 .I '$G(PSORNSPD) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSORENW0",57,0)
 .I $G(PSORNSPD) W !
"RTN","PSORENW0",58,0)
 ;
"RTN","PSORENW0",59,0)
 S (PSOS,PSOX,PSOY)="" K ACOM,DIR,DIRUT,DIRUT,DUOUT
"RTN","PSORENW0",60,0)
 I $G(PSOSD) F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""!(PSORENW("DFLG"))  I PSORENW("OIRXN")=+PSOSD(PSOS,PSOX) S PSOY=PSOSD(PSOS,PSOX) I $TR($P(PSOY,"^",3),"B")]"" D  K ACOM,DIR,DIRUT,DIRUT,DUOUT
"RTN","PSORENW0",61,0)
 . S PSORENW("DFLG")=1
"RTN","PSORENW0",62,0)
 . W !,$C(7),"Cannot renew Rx # ",$P(PSORENW("RX0"),"^")
"RTN","PSORENW0",63,0)
 . S PSOREA=$P(PSOY,"^",3),PSOSTAT=+PSORENW("STA")
"RTN","PSORENW0",64,0)
 . D STATUS^PSOUTIL(PSOREA,PSOSTAT) K PSOREA,PSOSTAT
"RTN","PSORENW0",65,0)
 .I $G(ACOM)]"" D
"RTN","PSORENW0",66,0)
 ..S DRG=$P(^PSDRUG($P(^PSRX(PSORENW("OIRXN"),0),"^",6),0),"^")
"RTN","PSORENW0",67,0)
 ..W ! S DIR(0)="Y",DIR("A",1)="Do you want to Discontinue this Pending Order",DIR("A")="for "_DRG,DIR("B")="No"
"RTN","PSORENW0",68,0)
 ..D ^DIR I 'Y!($D(DIRUT)) Q
"RTN","PSORENW0",69,0)
 ..D NOOR^PSOCAN4 Q:$D(DIRUT)  D DE^PSOORFI2
"RTN","PSORENW0",70,0)
 .Q
"RTN","PSORENW0",71,0)
 I PSOY="",'$G(PSOORRNW) D
"RTN","PSORENW0",72,0)
 .W !,$C(7),"Cannot renew Rx # ",$P(PSORENW("RX0"),"^")," later Rx exists." S PSORENW("DFLG")=1
"RTN","PSORENW0",73,0)
 .S:$G(POERR) VALMSG="Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_" later Rx exists.",VALMBCK="R"
"RTN","PSORENW0",74,0)
 K PSOX,PSOY G:PSORENW("DFLG") CHECKX
"RTN","PSORENW0",75,0)
 ;
"RTN","PSORENW0",76,0)
 I $A($E(PSORENW("ORX #"),$L(PSORENW("ORX #"))))'<90 D  Q
"RTN","PSORENW0",77,0)
 . W !,$C(7),"Cannot renew Rx # "_PSORENW("ORX #")_", Max number of renewals reached."
"RTN","PSORENW0",78,0)
 .S:$G(POERR)!('$G(SPEED)) (ACOM,VALMSG)="Cannot renew Rx # "_PSORENW("ORX #")_", Max number reached.",VALMBCK="R"
"RTN","PSORENW0",79,0)
 . S PSORENW("DFLG")=1
"RTN","PSORENW0",80,0)
 .I $G(OR0)]"" D
"RTN","PSORENW0",81,0)
 ..S DRG=$P(^PSDRUG($P(^PSRX(PSORENW("OIRXN"),0),"^",6),0),"^")
"RTN","PSORENW0",82,0)
 ..W ! S DIR(0)="Y",DIR("A",1)="Do you want to Discontinue this Pending Order",DIR("A")="for "_DRG,DIR("B")="No"
"RTN","PSORENW0",83,0)
 ..D ^DIR I 'Y!($D(DIRUT)) Q
"RTN","PSORENW0",84,0)
 ..D NOOR^PSOCAN4 Q:$D(DIRUT)  D DE^PSOORFI2
"RTN","PSORENW0",85,0)
 .K ACOM Q
"RTN","PSORENW0",86,0)
 D CHKDIV G:PSORENW("DFLG") CHECKX
"RTN","PSORENW0",87,0)
 ;
"RTN","PSORENW0",88,0)
 D CHKPRV^PSOUTIL
"RTN","PSORENW0",89,0)
CHECKX Q
"RTN","PSORENW0",90,0)
 ;
"RTN","PSORENW0",91,0)
CHKDIV ;
"RTN","PSORENW0",92,0)
 G:$P(PSORENW("RX2"),"^",9)=+PSOSITE CHKDIVX
"RTN","PSORENW0",93,0)
 W !?5,$C(7),"RX # ",$P(PSORENW("RX0"),"^")," is for (",$P(^PS(59,$P(PSORENW("RX2"),"^",9),0),"^"),") division."
"RTN","PSORENW0",94,0)
 I '$P($G(PSOSYS),"^",2) S PSORENW("DFLG")=1 G CHKDIVX
"RTN","PSORENW0",95,0)
 D:$P($G(PSOSYS),"^",3) DIR
"RTN","PSORENW0",96,0)
CHKDIVX Q
"RTN","PSORENW0",97,0)
 ;
"RTN","PSORENW0",98,0)
DRUG ;
"RTN","PSORENW0",99,0)
 K PSOY
"RTN","PSORENW0",100,0)
 S PSOY=PSORENW("DRUG IEN"),PSOY(0)=^PSDRUG(PSOY,0)
"RTN","PSORENW0",101,0)
 I '$P($G(^PSDRUG(PSOY,2)),"^") D  Q:$G(PSORX("DFLG"))
"RTN","PSORENW0",102,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW0",103,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW0",104,0)
 D SET^PSODRG
"RTN","PSORENW0",105,0)
 D POST^PSODRG S:PSORX("DFLG") PSORENW("DFLG")=1 ;remove order checks for v7. do allergy checks only
"RTN","PSORENW0",106,0)
 ;D ^PSODRDUP Q:$G(PSORX("DFLG"))  ; Set PSORX("DFLG")=1 if process to stop
"RTN","PSORENW0",107,0)
 S PSONOOR=PSORENW("NOO")
"RTN","PSORENW0",108,0)
 ;I $G(PSODRUG("NDF")) S NDF=$P(PSODRUG("NDF"),"A"),VAP=$P(PSODRUG("NDF"),"A",2),PTR=NDF_"."_VAP D CHK^PSODGAL(PSODFN,"DR",PTR) K NDF,VAP,PTR
"RTN","PSORENW0",109,0)
 ;I '$G(PSODRUG("NDF")) D CHK1^PSODGAL(PSODFN)
"RTN","PSORENW0",110,0)
 K PSORX("INTERVENE")
"RTN","PSORENW0",111,0)
 S:$D(PSONEW("STATUS")) PSORENW("STATUS")=PSONEW("STATUS")
"RTN","PSORENW0",112,0)
 K PSOY,PSONEW("STATUS")
"RTN","PSORENW0",113,0)
 Q
"RTN","PSORENW0",114,0)
 ;
"RTN","PSORENW0",115,0)
RXN ;
"RTN","PSORENW0",116,0)
 K PSOX
"RTN","PSORENW0",117,0)
 S PSOX=$E(PSORENW("ORX #"),$L(PSORENW("ORX #")))
"RTN","PSORENW0",118,0)
 S PSORENW("NRX #")=$S(PSOX?1N:PSORENW("ORX #")_"A",1:$E(PSORENW("ORX #"),1,$L(PSORENW("ORX #"))-1)_$C($A(PSOX)+1))
"RTN","PSORENW0",119,0)
RETRY I $O(^PSRX("B",PSORENW("NRX #"),0)) D  G:'$G(PSORENW("DFLG")) RETRY
"RTN","PSORENW0",120,0)
 .W:$A($E(PSORENW("NRX #"),$L(PSORENW("ORX #"))))'=90 !,"Rx # "_PSORENW("NRX #")_" is already on file."
"RTN","PSORENW0",121,0)
 .S:$G(PSOFDR) VALMSG="Rx # "_PSORENW("NRX #")_" is already on file."
"RTN","PSORENW0",122,0)
 .I $A($E(PSORENW("NRX #"),$L(PSORENW("ORX #"))))=90 D
"RTN","PSORENW0",123,0)
 ..W !,"Rx # "_PSORENW("NRX #")_" is already on file. Cannot renew Rx #"_PSORENW("ORX #")_".",!,"A new Rx must be entered.",!
"RTN","PSORENW0",124,0)
 ..S:$G(PSOFDR) VALMSG="Rx # "_PSORENW("NRX #")_" is already on file. Cannot renew Rx #"_PSORENW("ORX #")_". A new Rx must be entered."
"RTN","PSORENW0",125,0)
 ..K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSORENW0",126,0)
 ..S:$G(POERR)!($G(PSOFDR)) VALMSG="Cannot renew Rx # "_PSORENW("ORX #")_", Max number reached.",VALMBCK="R" S PSORENW("DFLG")=1
"RTN","PSORENW0",127,0)
 .S PSOX=$E(PSORENW("NRX #"),$L(PSORENW("NRX #")))
"RTN","PSORENW0",128,0)
 .S PSORENW("NRX #")=$S(PSOX?1N:PSORENW("NRX #")_"A",1:$E(PSORENW("NRX #"),1,$L(PSORENW("NRX #"))-1)_$C($A(PSOX)+1))
"RTN","PSORENW0",129,0)
RXNX K PSOX
"RTN","PSORENW0",130,0)
 Q
"RTN","PSORENW0",131,0)
 ;
"RTN","PSORENW0",132,0)
FILDATE ;
"RTN","PSORENW0",133,0)
 S PSORENW("IRXN")=PSORENW("OIRXN")
"RTN","PSORENW0",134,0)
 D NEXT^PSOUTIL(.PSORENW)
"RTN","PSORENW0",135,0)
 I PSORENW("FILL DATE")<$P(PSORENW("RX3"),"^",2) D
"RTN","PSORENW0",136,0)
 .D RENFDT^PSOUTIL(.PSORENW)
"RTN","PSORENW0",137,0)
 .I PSORENW("FILL DATE")<DT,PSORENW("FILL DATE")<PSORNW("FILL DATE") S (Y,PSORENW("FILL DATE"))=DT X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSORENW0",138,0)
 K PSORENW("IRXN")
"RTN","PSORENW0",139,0)
 Q
"RTN","PSORENW0",140,0)
 ;
"RTN","PSORENW0",141,0)
EDIT ;
"RTN","PSORENW0",142,0)
 K DIR,X,Y
"RTN","PSORENW0",143,0)
 S DIR(0)="Y",DIR("B")=$S($G(DUZ("AG"))'="I":"Y",$G(PSEXDT):"Y",1:"N")
"RTN","PSORENW0",144,0)
 S DIR("A")="Edit renewed Rx ",DIR("?")="Answer YES to edit the renewed Rx, NO not to."
"RTN","PSORENW0",145,0)
 D ^DIR K DIR S:$D(DIRUT) PSORENW("DFLG")=1
"RTN","PSORENW0",146,0)
 G:PSORENW("DFLG") EDITX
"RTN","PSORENW0",147,0)
 K PSOQUIT,PSORX("FN") I Y D INIT^PSORENW3,EN^PSOORNE4(.PSORENW) S:$G(PSOQUIT) PSORENW("DFLG")=1 I '$G(PSORX("FN")) D FULL^VALM1 Q
"RTN","PSORENW0",148,0)
 Q:$G(PSORX("FN"))
"RTN","PSORENW0",149,0)
EDITX S PSOEDT=1,VALMBCK="Q" K X,Y,DIRUT,DTOUT,DUOUT S PSORENW("QFLG")=1
"RTN","PSORENW0",150,0)
 Q
"RTN","PSORENW0",151,0)
 ;
"RTN","PSORENW0",152,0)
DELETE ;
"RTN","PSORENW0",153,0)
 K DA,DIK
"RTN","PSORENW0",154,0)
 S DA=$O(^PS(52.5,"B",PSORENW("OIRXN"),0)),DIK="^PS(52.5,"
"RTN","PSORENW0",155,0)
 D ^DIK K DIK,DIC
"RTN","PSORENW0",156,0)
 Q
"RTN","PSORENW0",157,0)
 ;
"RTN","PSORENW0",158,0)
CAN ;
"RTN","PSORENW0",159,0)
 K REA,DA,MSG
"RTN","PSORENW0",160,0)
 S REA="C",DA=PSORENW("OIRXN")
"RTN","PSORENW0",161,0)
 S MSG="Renewed"_$S($G(PSOFDR):" from CPRS",1:"")
"RTN","PSORENW0",162,0)
 S PSCAN(PSORENW("ORX #"))=DA_"^C"
"RTN","PSORENW0",163,0)
 D CAN^PSOCAN
"RTN","PSORENW0",164,0)
 K REA,DA,MSG,PSCAN
"RTN","PSORENW0",165,0)
 Q
"RTN","PSORENW0",166,0)
 ;
"RTN","PSORENW0",167,0)
DIR ;
"RTN","PSORENW0",168,0)
 S DIR(0)="Y",DIR("A")="CONTINUE ",DIR("B")="N"
"RTN","PSORENW0",169,0)
 S DIR("?")="Answer YES to Continue, NO to bypass"
"RTN","PSORENW0",170,0)
 D ^DIR K DIR
"RTN","PSORENW0",171,0)
 S:$D(DIRUT)!('Y) PSORENW("DFLG")=1
"RTN","PSORENW0",172,0)
DIRX K DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSORENW0",173,0)
 Q
"RTN","PSORENW0",174,0)
NEWPT ;
"RTN","PSORENW0",175,0)
 S PSOQFLG=0
"RTN","PSORENW0",176,0)
 S PSODFN=PSORENW("PSODFN")
"RTN","PSORENW0",177,0)
 D ^PSOPTPST I PSOQFLG S PSORENW("DFLG")=1,PSOQFLG=0 G NEWPTX
"RTN","PSORENW0",178,0)
 D PROFILE^PSOREF1
"RTN","PSORENW0",179,0)
NEWPTX Q
"RTN","PSORENW0",180,0)
 ;
"RTN","PSORENW0",181,0)
EN(PSORENW)        ; Entry Point for Batch Barcode Option
"RTN","PSORENW0",182,0)
 S PSORENRX=$G(PSOBBC("OIRXN"))
"RTN","PSORENW0",183,0)
 I $G(PSORENRX) D PSOL^PSSLOCK(PSORENRX) I '$G(PSOMSG) D  K DIR,PSOMSG W ! S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR K DIR W ! Q
"RTN","PSORENW0",184,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P(PSOMSG,"^",2) Q
"RTN","PSORENW0",185,0)
 .W $C(7),!!,"Another person is editing Rx "_$P($G(^PSRX(PSORENRX,0)),"^")
"RTN","PSORENW0",186,0)
 K PSOMSG,PSOBBCLK S PSOBARCD=1 D PROCESS K PSOBARCD
"RTN","PSORENW0",187,0)
 D KLIB^PSORENW1
"RTN","PSORENW0",188,0)
 I $G(PSORENRX),$G(PSOBBCLK) D PSOUL^PSSLOCK(PSORENRX)
"RTN","PSORENW0",189,0)
 K PSORENRX,PSOBBCLK
"RTN","PSORENW0",190,0)
 Q
"RTN","PSORENW0",191,0)
CDOSE ;Validate Dosage field on Renewel, Copy, Edit
"RTN","PSORENW0",192,0)
 ;PSOOCPRX must be set to internal Rx number
"RTN","PSORENW0",193,0)
 Q:'$G(PSOOCPRX)
"RTN","PSORENW0",194,0)
 N PSOOLP,PSOOKZ
"RTN","PSORENW0",195,0)
 S PSOOLP="",(PSOOLPF,PSONOSIG)=0 F  S PSOOLP=$O(^PSRX(PSOOCPRX,6,PSOOLP)) Q:PSOOLP=""!(PSOOLPF)  I $P($G(^PSRX(PSOOCPRX,6,PSOOLP,0)),"^")["0.." S PSOOLPD=$P($G(^(0)),"^"),PSOOLPF=1
"RTN","PSORENW0",196,0)
 Q:PSOOLPF
"RTN","PSORENW0",197,0)
 S PSOOKZ=0
"RTN","PSORENW0",198,0)
 I $P($G(^PSRX(PSOOCPRX,"SIG")),"^",2) S PSOOLP="" F  S PSOOLP=$O(^PSRX(PSOOCPRX,"SIG1",PSOOLP)) Q:PSOOLP=""!(PSOOKZ)  I $G(^PSRX(PSOOCPRX,"SIG1",PSOOLP,0))'="" S PSOOKZ=1
"RTN","PSORENW0",199,0)
 I '$P($G(^PSRX(PSOOCPRX,"SIG")),"^",2),$P($G(^("SIG")),"^")'="" S PSOOKZ=1
"RTN","PSORENW0",200,0)
 I 'PSOOKZ S PSONOSIG=1
"RTN","PSORENW0",201,0)
 Q
"RTN","PSOSD0")
0^25^B52648174^B52329311
"RTN","PSOSD0",1,0)
PSOSD0 ;BHAM ISC/SAB - action or informational profile cont. ;6/21/07 8:20am
"RTN","PSOSD0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,19,40,66,107,110,258,206**;DEC 1997;Build 39
"RTN","PSOSD0",3,0)
 ;External reference to ^PS(50.605 supported by DBIA 696
"RTN","PSOSD0",4,0)
 ;External reference to ^SC supported by DBIA 10040
"RTN","PSOSD0",5,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOSD0",6,0)
CLASS S (ZCLASS,CLASS)="",RXCNT=0 F Z0=0:0 S CLASS=$O(^TMP($J,"PRF",CLASS)) Q:CLASS=""  S PCLASS=$S($D(^PS(50.605,+$O(^PS(50.605,"B",CLASS,0)),0)):CLASS_" - "_$P(^(0),"^",2),1:"UNCLASSIFIED") D DRUG Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOSD0",7,0)
 Q
"RTN","PSOSD0",8,0)
DRUG S DRUG="" F Z1=0:0 S DRUG=$O(^TMP($J,"PRF",CLASS,DRUG)) Q:DRUG=""  S FDT="" F Z3=0:0 S FDT=$O(^TMP($J,"PRF",CLASS,DRUG,FDT)) Q:'FDT  D RXN Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOSD0",9,0)
 Q
"RTN","PSOSD0",10,0)
RXN I PSORM D
"RTN","PSOSD0",11,0)
 .D:$S($P($G(PSOPAR),"^")&($G(PSTYPE))&('$D(DOD(DFN))):RXCNT=3,'$G(PSTYPE)!($D(DOD(DFN))):RXCNT=6,1:RXCNT=4) HD1^PSOSD2
"RTN","PSOSD0",12,0)
 I 'PSORM D
"RTN","PSOSD0",13,0)
 .D:$S($P($G(PSOPAR),"^")&($G(PSTYPE))&('$D(DOD(DFN))):RXCNT=2,1:RXCNT=5) HD1^PSOSD2
"RTN","PSOSD0",14,0)
 S RXN=0 F Z2=0:0 S RXN=$O(^TMP($J,"PRF",CLASS,DRUG,FDT,RXN)) Q:'RXN  D   Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOSD0",15,0)
 .S RX0=^TMP($J,"PRF",CLASS,DRUG,FDT,RXN),J=RXN,RX2=$S($D(^PSRX(J,2)):^(2),1:""),RX3=$G(^(3)),RXNO=RXN
"RTN","PSOSD0",16,0)
 .S RXNODE=^PSRX(RXN,0),$P(RXNODE,"^",15)=+$G(^("STA")) D ENSAVE^PSODACT,RXN1
"RTN","PSOSD0",17,0)
 Q
"RTN","PSOSD0",18,0)
RXN1 S RFL=1,FILL(9999999-$P(RX2,"^",2))=+$P(RX2,"^",2)_"^"_$S($P(RX2,"^",15):"(R)",1:""),FILLS=+$P(RX0,"^",9)
"RTN","PSOSD0",19,0)
 F II=0:0 S II=$O(^PSRX(J,1,II)) Q:'II  S FILL(9999999-^PSRX(J,1,II,0))=+^PSRX(J,1,II,0)_"^"_$S($P(^(0),"^",16):"(R)",1:"") S RFL=RFL+1
"RTN","PSOSD0",20,0)
 S PHYS=$S($D(^VA(200,+$P(RX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOSD0",21,0)
 I 'PSTYPE,ZCLASS=CLASS,$E(IOST)="C" K DIR S DIR(0)="E" D ^DIR Q:$D(DTOUT)!($D(DUOUT))  W !
"RTN","PSOSD0",22,0)
 I $S($G(PSTYPE):$Y>48,1:$Y>60)!(ZCLASS]""&(ZCLASS'=CLASS)&($S($G(PSTYPE):$Y+16>IOSL,1:$Y+8>IOSL))) D HD1^PSOSD2 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOSD0",23,0)
 I ZCLASS'=CLASS D:$S($G(PSTYPE):$Y>48,1:$Y>60) HD1^PSOSD2 W !,$S('PSORM:"Class: ",1:"Classification: ")_PCLASS,! S ZCLASS=CLASS
"RTN","PSOSD0",24,0)
 I 'PSORM D EIGHTY Q
"RTN","PSOSD0",25,0)
 W !,$S('$D(^PSDRUG(+$P(RX0,"^",6),0)):"",+$P(^PSDRUG(+$P(RX0,"^",6),0),"^",9):"N/F",1:"")," ",$S($D(^PSDRUG(+$P(RX0,"^",6),0)):$P(^(0),"^"),1:"NOT ON FILE")
"RTN","PSOSD0",26,0)
 N ACTS D ACTS
"RTN","PSOSD0",27,0)
 W ?45,"Qty: "_$P(RX0,"^",7)_" for "_$P(RX0,"^",8)_" Days ",?74,$P(RX0,"^"),?84," ",ACTS,?99,$E($P(RX2,"^",6),4,5)_"-"_$E($P(RX2,"^",6),6,7)_"-"_($E($P(RX2,"^",6),1,3)+1700)
"RTN","PSOSD0",28,0)
 W ?110,$E(PHYS,1,30) D COS^PSOSDP
"RTN","PSOSD0",29,0)
 I $G(^PSDRUG(+$P(RX0,"^",6),"PSO"))]"" W !," Message: "_$G(^PSDRUG(+$P(RX0,"^",6),"PSO"))
"RTN","PSOSD0",30,0)
 S RXCNT=RXCNT+1 D SIG W !?9,"Sig: ",$G(BSIG(1))
"RTN","PSOSD0",31,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?14,$G(BSIG(PSREV))
"RTN","PSOSD0",32,0)
 K BSIG,PSREV
"RTN","PSOSD0",33,0)
 S RFS=0 F RF=0:0 S RF=$O(^PSRX(RXN,1,RF)) Q:'RF  S RFS=RFS+1
"RTN","PSOSD0",34,0)
 W !?10,"Filled: " F PSIII=0:0 S PSIII=$O(FILL(PSIII)) Q:'PSIII  S Y=FILL(PSIII) W:Y " ",$E($P(Y,"^"),4,5),"-",$E($P(Y,"^"),6,7),"-",($E($P(Y,"^"),1,3)+1700)_$P(Y,"^",2)
"RTN","PSOSD0",35,0)
 S DUPD=$O(^TMP($J,"PRF",CLASS,DRUG,FDT)) I DUPD,RFL<6 D
"RTN","PSOSD0",36,0)
 .S OLDRX2=RX2,OLDJ=J,OLDFILL=FDT,OLDRX=RXN W "  Past Fills:" D DUP S FDT=OLDFILL,J=OLDJ,RX2=OLDRX2,RXN=OLDRX K OLDJ,OLDRX2,OLDFILL,OLDRX
"RTN","PSOSD0",37,0)
 W !?10,"Remaining Refills: "_($P(RX0,"^",9)-RFS),?45,"Clinic: ",$S($D(^SC(+$P(RX0,"^",5),0)):$E($P(^(0),"^"),1,30),1:"UNKNOWN")
"RTN","PSOSD0",38,0)
 W ?105,"Price: " S PRICE=$S($D(^PSDRUG($P(RX0,"^",6),660)):$P(^(660),"^",6),1:0),COST=$P(RX0,"^",7)*PRICE S:COST<1 COST="0"_COST W "$",$J(COST,3,2),! K COST
"RTN","PSOSD0",39,0)
 I 'PSTYPE D:$D(^PSDRUG(+$P(RX0,"^",6),"CLOZ"))&($P($G(^("CLOZ1")),"^")'="PSOCLO1") ^PSOLAB G RXN2
"RTN","PSOSD0",40,0)
 G:$G(DOD(DFN))]"" RXN2
"RTN","PSOSD0",41,0)
 D:+$G(PSOBAR4) BAR S PSRENW=0,PSODEA=$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^",3) I PSODEA'["1",PSODEA'["2",PSODEA'["W",$P($G(^PS(53,+$P(RX0,"^",3),0)),"^",5) S PSRENW=1
"RTN","PSOSD0",42,0)
 S PSOIFSUP=$S(PSODEA']"":0,PSODEA["S":1,1:0),RXX=$P(RX0,"^"),RXX(1)="",RXX=$O(^PSRX("B",RXX,RXX(1)))
"RTN","PSOSD0",43,0)
 W:$P($G(^PSRX(RXX,"IB")),"^") !?11,"****COPAY****" D PSRENW^PSOSD2
"RTN","PSOSD0",44,0)
 I PSRENW W !?1,$S(PSOIFSUP:"",'$D(PSOPRINT):"",PSOPRINT]"":PSOPRINT,1:""),?11,"RENEW/MD:" F T=1:1:30 W "_" I T=30 W "VA#:" F I=1:1:10 W "_" I I=10 D
"RTN","PSOSD0",45,0)
 .W "DATE__________ REFILL"
"RTN","PSOSD0",46,0)
 .W $S($P(RX0,"^",8)'<60&($P(RX0,"^",8)'>89):" 0 1 2"_$S('CS:" 3 4 5",1:""),$P(RX0,"^",8)<60:" 0 1 2 3 4 5"_$S('CS:" 6 7 8 9 10 11",1:""),1:" 0 1"_$S('CS:" 2 3",1:"")),!
"RTN","PSOSD0",47,0)
 I "ASH"[$E($P(RX0,"^",15)),PSTYPE D
"RTN","PSOSD0",48,0)
 .W !?21,"DISCONTINUE/MD:" F T=1:1:30 W "_" I T=30 W "VA#:" F I=1:1:10 W "_" I I=10 W "DATE__________",!
"RTN","PSOSD0",49,0)
 D:$D(^PSDRUG(+$P(RX0,"^",6),"CLOZ"))&($P($G(^("CLOZ1")),"^")'="PSOCLO1") PRINT^PSOLAB
"RTN","PSOSD0",50,0)
RXN2 W ! K RX0,RX3,RX2,PRDT,LABEL,PHYS,PSI,PSII,PSIII,II,Y,SIG,X,FILL,FILLS,PHYS,Z9,PRICE,I,T,RXX
"RTN","PSOSD0",51,0)
 Q
"RTN","PSOSD0",52,0)
SIG K FSIG,BSIG I $P($G(^PSRX(RXN,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXN,$S('PSORM:64,$E(IOST)="C":64,1:114)) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSOSD0",53,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXN,"SIG")),"^",2) D EN3^PSOUTLA1(RXN,$S('PSORM:64,$E(IOST)="C":64,1:114))
"RTN","PSOSD0",54,0)
 Q
"RTN","PSOSD0",55,0)
DUP ;DUP DRUG
"RTN","PSOSD0",56,0)
 F Z4=0:0 Q:RFL>9  S FDT=$O(^TMP($J,"PRF",CLASS,DRUG,FDT)) Q:'FDT  D
"RTN","PSOSD0",57,0)
 .F Z5=0:0 S Z5=$O(^TMP($J,"PRF",CLASS,DRUG,FDT,Z5)) Q:'Z5  S RX2=$S($D(^PSRX(Z5,2)):^(2),1:"") D:"DE"[$E($P(^TMP($J,"PRF",CLASS,DRUG,FDT,Z5),"^",15))
"RTN","PSOSD0",58,0)
 ..K FILL S FILL(9999999-$P(RX2,"^",2))=+$P(RX2,"^",2)_"^"_$S($P(RX2,"^",15):"(R)",1:"") F II=0:0 S II=$O(^PSRX(Z5,1,II)) Q:'II  S FILL(9999999-$P(^PSRX(Z5,1,II,0),"^"))=$P(^PSRX(Z5,1,II,0),"^")_"^"_$S($P(^(0),"^",16):"(R)",1:"")
"RTN","PSOSD0",59,0)
 ..F PSII=0:0 S PSII=$O(FILL(PSII)) Q:'PSII  W:($X+8)>$S('PSORM:80,1:IOM) !?9 S Y=FILL(PSII) W " ",$E($P(Y,"^"),4,5)_"-"_$E($P(Y,"^"),6,7)_"-"_($E($P(Y,"^"),1,3)+1700)_$P(Y,"^",2)
"RTN","PSOSD0",60,0)
 ..K ^TMP($J,"PRF",CLASS,DRUG,FDT,Z5)
"RTN","PSOSD0",61,0)
 Q
"RTN","PSOSD0",62,0)
BAR ;barcode
"RTN","PSOSD0",63,0)
 I PSOBAR4 S X="S",X2=PSOINST_"-"_RXN W !?15 S X1=$X W @PSOBAR3,X2,@PSOBAR2,$C(13) S $X=0
"RTN","PSOSD0",64,0)
 Q
"RTN","PSOSD0",65,0)
EIGHTY ;prints profile in 80 column format
"RTN","PSOSD0",66,0)
 W !,$S('$D(^PSDRUG(+$P(RX0,"^",6),0)):"",+$P(^PSDRUG(+$P(RX0,"^",6),0),"^",9):"N/F",1:"")," ",$S($D(^PSDRUG(+$P(RX0,"^",6),0)):$P(^(0),"^"),1:"NOT ON FILE"),?45,"Rx #: "_$P(RX0,"^")
"RTN","PSOSD0",67,0)
 I $G(^PSDRUG(+$P(RX0,"^",6),"PSO"))]"" W !," Message: "_$G(^PSDRUG(+$P(RX0,"^",6),"PSO"))
"RTN","PSOSD0",68,0)
 N ACTS D ACTS
"RTN","PSOSD0",69,0)
 W !?1,"Qty: "_$P(RX0,"^",7)_" for "_$P(RX0,"^",8)_" Days  "_ACTS,"  Exp: "_$E($P(RX2,"^",6),4,5)_"-"_$E($P(RX2,"^",6),6,7)_"-"_($E($P(RX2,"^",6),1,3)+1700)
"RTN","PSOSD0",70,0)
 W ?48," Prov: "_$E(PHYS,1,30) I $P($G(^PSRX(J,3)),"^",3),$D(^VA(200,+$P($G(^(3)),"^",3),0)) W !,?43,"COSIGNER: "_$P($G(^VA(200,+$P(^PSRX(J,3),"^",3),0)),"^")
"RTN","PSOSD0",71,0)
 S RXCNT=RXCNT+1 D SIG W !?9,"Sig: ",$G(BSIG(1))
"RTN","PSOSD0",72,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?14,$G(BSIG(PSREV))
"RTN","PSOSD0",73,0)
 K BSIG,PSREV
"RTN","PSOSD0",74,0)
 S RFS=0 F RF=0:0 S RF=$O(^PSRX(RXN,1,RF)) Q:'RF  S RFS=RFS+1
"RTN","PSOSD0",75,0)
 W !?10,"Filled: " F PSIII=0:0 S PSIII=$O(FILL(PSIII)) Q:'PSIII  S Y=FILL(PSIII) W:Y " ",$E($P(Y,"^"),4,5),"-",$E($P(Y,"^"),6,7),"-",($E($P(Y,"^"),1,3)+1700)_$P(Y,"^",2)
"RTN","PSOSD0",76,0)
 S DUPD=$O(^TMP($J,"PRF",CLASS,DRUG,FDT)) I DUPD,RFL<6 D
"RTN","PSOSD0",77,0)
 .S OLDRX2=RX2,OLDJ=J,OLDFILL=FDT,OLDRX=RXN W "  Past Fills:" D DUP S FDT=OLDFILL,J=OLDJ,RX2=OLDRX2,RXN=OLDRX K OLDJ,OLDRX2,OLDFILL,OLDRX
"RTN","PSOSD0",78,0)
 W !?10,"Remaining Refills: "_($P(RX0,"^",9)-RFS),?45,"Clinic: ",$S($D(^SC(+$P(RX0,"^",5),0)):$E($P(^(0),"^"),1,30),1:"UNKNOWN")
"RTN","PSOSD0",79,0)
 W !?10,"Price: " S PRICE=$S($D(^PSDRUG($P(RX0,"^",6),660)):$P(^(660),"^",6),1:0),COST=$P(RX0,"^",7)*PRICE S:COST<1 COST="0"_COST W "$",$J(COST,3,2),! K COST
"RTN","PSOSD0",80,0)
 I 'PSTYPE D:$D(^PSDRUG(+$P(RX0,"^",6),"CLOZ"))&($P($G(^("CLOZ1")),"^")'="PSOCLO1") ^PSOLAB G RXN2
"RTN","PSOSD0",81,0)
 G:$G(DOD(DFN))]"" RXN3
"RTN","PSOSD0",82,0)
 D:+$G(PSOBAR4) BAR S PSRENW=0,PSODEA=$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^",3) I PSODEA'["1",PSODEA'["2",PSODEA'["W",$P($G(^PS(53,+$P(RX0,"^",3),0)),"^",5) S PSRENW=1
"RTN","PSOSD0",83,0)
 S PSOIFSUP=$S(PSODEA']"":0,PSODEA["S":1,1:0),RXX=$P(RX0,"^"),RXX(1)="",RXX=$O(^PSRX("B",RXX,RXX(1)))
"RTN","PSOSD0",84,0)
 W:$P($G(^PSRX(RXX,"IB")),"^") !?11,"****COPAY****" D PSRENW^PSOSD2
"RTN","PSOSD0",85,0)
 I PSRENW W !?1,$S(PSOIFSUP:"",'$D(PSOPRINT):"",PSOPRINT]"":PSOPRINT,1:""),?6,"RENEW/MD:" F T=1:1:30 W "_" I T=30 W "VA#:" F I=1:1:10 W "_" I I=10 D
"RTN","PSOSD0",86,0)
 .W "DATE__________",!?6,"REFILLS"
"RTN","PSOSD0",87,0)
 .W $S($P(RX0,"^",8)'<60&($P(RX0,"^",8)'>89):" 0 1 2"_$S('CS:" 3 4 5",1:""),$P(RX0,"^",8)<60:" 0 1 2 3 4 5"_$S('CS:" 6 7 8 9 10 11",1:""),1:" 0 1"_$S('CS:" 2 3",1:"")),!
"RTN","PSOSD0",88,0)
 I "ASH"[$E($P(RX0,"^",15)),PSTYPE D
"RTN","PSOSD0",89,0)
 .W !?11,"DISCONTINUE/MD:" F T=1:1:26 W "_" I T=26 W "VA#:" F I=1:1:10 W "_" I I=10 W "DATE__________",!
"RTN","PSOSD0",90,0)
 D:$D(^PSDRUG(+$P(RX0,"^",6),"CLOZ"))&($P($G(^("CLOZ1")),"^")'="PSOCLO1") PRINT^PSOLAB
"RTN","PSOSD0",91,0)
RXN3 W ! K RX0,RX3,RX2,PRDT,LABEL,PHYS,PSI,PSII,PSIII,II,Y,SIG,X,FILL,FILLS,PHYS,Z9,PRICE,I,T,RXX
"RTN","PSOSD0",92,0)
 Q
"RTN","PSOSD0",93,0)
ACTS ;
"RTN","PSOSD0",94,0)
 S ACTS=$S($P(RX0,"^",15)["PENDING":"PENDING",$P(RX0,"^",15)["Suspended":"Active/Susp",1:$P(RX0,"^",15))
"RTN","PSOSD0",95,0)
 Q
"RTN","PSOSIGMX")
0^22^B14811697^B14444819
"RTN","PSOSIGMX",1,0)
PSOSIGMX ;BIR/RTR-Utility routine to calculate Max Refills for CPRS ; 7/25/07 11:17am
"RTN","PSOSIGMX",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,108,131,222,206**;DEC 1997;Build 39
"RTN","PSOSIGMX",3,0)
 ;External reference to PS(55 supported by DBIA 2228
"RTN","PSOSIGMX",4,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOSIGMX",5,0)
 ;External reference to YSCL(603.01 supported by DBIA 2697
"RTN","PSOSIGMX",6,0)
 ;External reference to PS(50.7 supported by DBIA 2223
"RTN","PSOSIGMX",7,0)
 ;
"RTN","PSOSIGMX",8,0)
 ;PSOQX("PATIENT")=patient DFN
"RTN","PSOSIGMX",9,0)
 ;PSOQX("DAYS SUPPLY")=Days Supply ->Optional ??
"RTN","PSOSIGMX",10,0)
 ;PSOQX("DRUG")=File 50 ien ->Optional
"RTN","PSOSIGMX",11,0)
 ;PSOQX("ITEM")=File 50.7 ien -> we may not use this
"RTN","PSOSIGMX",12,0)
 ;PSOQX("DISCHARGE")=1 if the order is for a Discharge
"RTN","PSOSIGMX",13,0)
 ;
"RTN","PSOSIGMX",14,0)
 ;PSOQX("MAX")=Returned max refills allowed
"RTN","PSOSIGMX",15,0)
 ;
"RTN","PSOSIGMX",16,0)
EN ;
"RTN","PSOSIGMX",17,0)
 S PSOQX("MAX")=11
"RTN","PSOSIGMX",18,0)
 N DFN,VAROOT,PSOWRF,PSOMXAUT,PSOMXAUX,PSOCDEA,PSOCSX,PSOMXRX,PSOMX1,PSODYX,PSODYX1,PSOMXPAT,PSOMXSTA
"RTN","PSOSIGMX",19,0)
 S PSOMXAUT=0
"RTN","PSOSIGMX",20,0)
 S PSOMXAUX=+$P($G(^PS(55,+$G(PSOQX("PATIENT")),"PS")),"^")
"RTN","PSOSIGMX",21,0)
 I PSOMXAUX,$P($G(^PS(53,+$G(PSOMXAUX),0)),"^")["AUTH ABS" S VAROOT="PSOWRF",DFN=$G(PSOQX("PATIENT")) D IN5^VADPT I '$G(PSOWRF(5)) S PSOMXAUT=1
"RTN","PSOSIGMX",22,0)
 S PSOMXSTA=$S($G(PSOQX("DISCHARGE")):0,$G(PSOMXAUT):0,1:+$P($G(^PS(55,+$G(PSOQX("PATIENT")),"PS")),"^")) I PSOMXSTA S PSOMXRX=$P($G(^PS(53,PSOMXSTA,0)),"^",4)
"RTN","PSOSIGMX",23,0)
 I 'PSOMXSTA S PSOMXRX=11
"RTN","PSOSIGMX",24,0)
 K PSOCDEA S PSOCSX=0
"RTN","PSOSIGMX",25,0)
 S PSONODD=0 I '$G(PSOQX("DRUG")),$G(PSOQX("ITEM")) D  S PSONODD=1
"RTN","PSOSIGMX",26,0)
 . N A,B,PSOCDEA,DEA,PSOAPP,PSOINA,%,%H,%I,X,PSOFIRST
"RTN","PSOSIGMX",27,0)
 . S DEA=99,(A,PSOFIRST)=""
"RTN","PSOSIGMX",28,0)
 . F  S A=$O(^PS(50.7,"A50",PSOQX("ITEM"),A)) Q:'A  D
"RTN","PSOSIGMX",29,0)
 .. S PSOCDEA=$P($G(^PSDRUG(A,0)),"^",3),PSOAPP=$P($G(^(2)),"^",3),PSOINA=$G(^("I"))
"RTN","PSOSIGMX",30,0)
 .. I PSOAPP'["O" Q
"RTN","PSOSIGMX",31,0)
 .. D NOW^%DTC I PSOINA]"",PSOINA'>% Q
"RTN","PSOSIGMX",32,0)
 .. I PSOFIRST="" S PSOFIRST=A
"RTN","PSOSIGMX",33,0)
 .. I PSOCDEA?1N.E,PSOCDEA<DEA S DEA=PSOCDEA,PSOQX("DRUG")=A
"RTN","PSOSIGMX",34,0)
 . I $G(PSOQX("DRUG"))="" S PSOQX("DRUG")=PSOFIRST
"RTN","PSOSIGMX",35,0)
 I $G(PSOQX("DRUG")) D
"RTN","PSOSIGMX",36,0)
 .S PSOCDEA=$P($G(^PSDRUG(PSOQX("DRUG"),0)),"^",3)
"RTN","PSOSIGMX",37,0)
 .I PSOCDEA["2"!(PSOCDEA["3")!(PSOCDEA["4")!(PSOCDEA["5") S PSOCSX=1
"RTN","PSOSIGMX",38,0)
 I PSOCSX D
"RTN","PSOSIGMX",39,0)
 .S PSOQX("MAX")=$S((PSOCDEA[1)!(PSOCDEA[2):0,1:5),PSOMX1=$S($G(PSOMXRX)>PSOQX("MAX"):PSOQX("MAX"),1:$G(PSOMXRX)),PSOQX("MAX")=$S(PSOMX1=5:PSOQX("MAX"),1:PSOMX1)
"RTN","PSOSIGMX",40,0)
 .S PSOQX("MAX")=$S('PSOQX("MAX"):0,$G(PSOQX("DAYS SUPPLY"))=90:1,1:PSOQX("MAX")),PSODYX=$G(PSOQX("DAYS SUPPLY")),PSODYX1=$S(PSODYX<60:5,PSODYX'<60&(PSODYX'>89):2,PSODYX=90:1,1:0) S PSOQX("MAX")=$S(PSOQX("MAX")'>PSODYX1:PSOQX("MAX"),1:PSODYX1)
"RTN","PSOSIGMX",41,0)
 I 'PSOCSX!('$G(PSOQX("DRUG"))) D
"RTN","PSOSIGMX",42,0)
 .S PSOQX("MAX")=11,PSOMX1=$S($G(PSOMXRX)>PSOQX("MAX"):PSOQX("MAX"),1:$G(PSOMXRX)),PSOQX("MAX")=$S(PSOMX1=11:PSOQX("MAX"),1:PSOMX1)
"RTN","PSOSIGMX",43,0)
 .S PSODYX=$G(PSOQX("DAYS SUPPLY")),PSODYX1=$S(PSODYX<60:11,PSODYX'<60&(PSODYX'>89):5,PSODYX=90:3,1:0) S PSOQX("MAX")=$S(PSOQX("MAX")'>PSODYX1:PSOQX("MAX"),1:PSODYX1)
"RTN","PSOSIGMX",44,0)
 I $P($G(^PSDRUG(+$G(PSOQX("DRUG")),"CLOZ1")),"^")="PSOCLO1" D  Q
"RTN","PSOSIGMX",45,0)
 .S PSOMXPAT=$O(^YSCL(603.01,"C",+$G(PSOQX("PATIENT")),0)) I 'PSOMXPAT S PSOQX("MAX")=0 Q
"RTN","PSOSIGMX",46,0)
 .S PSOMXPAT=$P($G(^YSCL(603.01,PSOMXPAT,0)),"^",3)
"RTN","PSOSIGMX",47,0)
 .I $D(PSOQX("DAYS SUPPLY")) S PSOQX("MAX")=$S(PSOMXPAT="M"&($G(PSOQX("DAYS SUPPLY"))<8):3,PSOMXPAT="M"&($G(PSOQX("DAYS SUPPLY"))<15):1,PSOMXPAT="B"&($G(PSOQX("DAYS SUPPLY"))<8):1,1:0) Q
"RTN","PSOSIGMX",48,0)
 .S PSOQX("MAX")=$S(PSOMXPAT="M":3,PSOMXPAT="B":1,1:0)
"RTN","PSOSIGMX",49,0)
 I $G(PSOQX("DRUG")) I PSOCDEA["A"&(PSOCDEA'["B")!(PSOCDEA["F")!(PSOCDEA[1)!(PSOCDEA[2) S PSOQX("MAX")=0
"RTN","PSOSIGMX",50,0)
 I PSONODD S PSOQX("DRUG")=0
"RTN","PSOSIGMX",51,0)
 Q
"RTN","PSOUTLA1")
0^23^B59314173^B59108648
"RTN","PSOUTLA1",1,0)
PSOUTLA1 ;BHAM ISC/RTR-Pharmacy utility program cont. ;5/22/07 10:01am
"RTN","PSOUTLA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**35,186,218,259,206**;DEC 1997;Build 39
"RTN","PSOUTLA1",3,0)
 ;External reference to File ^PS(55 supported by DBIA 2228
"RTN","PSOUTLA1",4,0)
 ;External reference to File ^PSDRUG supported by DBIA 221
"RTN","PSOUTLA1",5,0)
 ;External reference to File ^PS(59.7 supported by DBIA 694
"RTN","PSOUTLA1",6,0)
 ;External reference to File ^PS(51 supported by DBIA 2224
"RTN","PSOUTLA1",7,0)
 ;
"RTN","PSOUTLA1",8,0)
 ;*186 - add DEACHK function
"RTN","PSOUTLA1",9,0)
 ;*218 - add REFIP function
"RTN","PSOUTLA1",10,0)
 ;*259 - reverse *218 delete restriction only warn of deleting
"RTN","PSOUTLA1",11,0)
 ;       also add del of last refill only
"RTN","PSOUTLA1",12,0)
 ;
"RTN","PSOUTLA1",13,0)
EN1 ;Formats condensed, back door sig in BSIG array
"RTN","PSOUTLA1",14,0)
 ;pass in  1) Internal Rx from 52
"RTN","PSOUTLA1",15,0)
 ;         2) max length of BSIG array
"RTN","PSOUTLA1",16,0)
 ;Returned, still condensed, in BSIG array, when looping through, check for array=null, if so, juist don't print it
"RTN","PSOUTLA1",17,0)
EN2(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",18,0)
 K BSIG
"RTN","PSOUTLA1",19,0)
 N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM
"RTN","PSOUTLA1",20,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",21,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",22,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",23,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",24,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",25,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",26,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",27,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",28,0)
 Q
"RTN","PSOUTLA1",29,0)
 ;
"RTN","PSOUTLA1",30,0)
EN3(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",31,0)
 ;Pass in to EN3 the internal Rx number from 52, and the length of
"RTN","PSOUTLA1",32,0)
 ;the array you want. Returns expanded Sig, or warning from PSOHELP
"RTN","PSOUTLA1",33,0)
 ;concantenated with the condensed Sig in the BSIG array
"RTN","PSOUTLA1",34,0)
 ;BACK DOOR ONLY
"RTN","PSOUTLA1",35,0)
 K BSIG,X N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM,Y,SIG,Z0,Z1,BBWARN
"RTN","PSOUTLA1",36,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",37,0)
 S (SIG,X)=BBSIG
"RTN","PSOUTLA1",38,0)
 I $E(BBSIG)=" " S BBWARN="Leading spaces are not allowed in the SIG!" G START
"RTN","PSOUTLA1",39,0)
 S SIG="" Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" START S Z1=$P(X," ",Z0) D  G:'$D(X) START
"RTN","PSOUTLA1",40,0)
 .I $L(Z1)>32 S BBWARN="MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES!" K X Q
"RTN","PSOUTLA1",41,0)
 .D:$D(X)&($G(Z1)]"")  S SIG=SIG_" "_Z1
"RTN","PSOUTLA1",42,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2) Q:'$D(^(9))  S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOUTLA1",43,0)
START ;
"RTN","PSOUTLA1",44,0)
 S BBSIG=$S($G(BBWARN)="":SIG,1:BBWARN_"  "_BBSIG)
"RTN","PSOUTLA1",45,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",46,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",47,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",48,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",49,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",50,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",51,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",52,0)
 Q
"RTN","PSOUTLA1",53,0)
PATCH ;Allow sites to backfill more than what was done at install
"RTN","PSOUTLA1",54,0)
 N PSOBACKL,PSOBACKI,PSOBACKS,PSOBACKB,PSOBACKD,PSOBACKA
"RTN","PSOUTLA1",55,0)
 S PSOBACKL=$O(^PS(59.7,0)),PSOBACKI=$E($P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",7),1,7)
"RTN","PSOUTLA1",56,0)
 I '$G(PSOBACKI) S PSOBACKI=$P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",4)
"RTN","PSOUTLA1",57,0)
 I $G(PSOBACKI) S Y=PSOBACKI D DD^%DT S PSOBACKS=Y S X1=PSOBACKI,X2=-120 D C^%DTC S (Y,PSOBACKB)=X D DD^%DT S PSOBACKD=Y
"RTN","PSOUTLA1",58,0)
 I $G(PSOBACKD)'="" W !!,"Your CPRS/Outpatient installation date is "_$G(PSOBACKS)_","_" which",!,"means we have already backfilled all active prescriptions and all",!,"prescriptions canceled or expired after "_$G(PSOBACKD)_"."
"RTN","PSOUTLA1",59,0)
 I  W !!,"If you want to backfill orders that were canceled or expired prior to this",!,"date of "_$G(PSOBACKD)_", enter an earlier date and those orders",!,"will be backfilled to CPRS.",!
"RTN","PSOUTLA1",60,0)
 I $G(PSOBACKD)="" W !!,"We cannot determine the date of the CPRS/Outpatient installation.",!
"RTN","PSOUTLA1",61,0)
 W !,"If you choose to backfill more orders to CPRS by utilizing this option,",!,"we remind you that disk storage can be significantly affected, depending on",!,"how many orders are backfilled.",!
"RTN","PSOUTLA1",62,0)
 K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to backfill more prescriptions",DIR("?")="Enter Yes to backfill prescriptions canceled or expired before "_$G(PSOBACKD) D ^DIR K DIR I Y'=1 W ! G PATCHQ
"RTN","PSOUTLA1",63,0)
 W ! S %DT="AEPX",%DT("A")="Enter Date to begin backfill: " S:$G(PSOBACKB) %DT(0)=-PSOBACKB D ^%DT G:Y<0!($D(DTOUT)) PATCHQ S PSOBACKA=$E(Y,1,7)
"RTN","PSOUTLA1",64,0)
 W ! K ZTDTH S ZTSAVE("PSOBACKB")="",ZTSAVE("PSOBACKA")="",ZTRTN="PATCHR^PSOUTLA1",ZTDESC="BACKFILL PRSCRIPTIONS TO CPRS",ZTIO="" D ^%ZTLOAD W ! G PATCHQ
"RTN","PSOUTLA1",65,0)
PATCHR ;Begin task
"RTN","PSOUTLA1",66,0)
 N PSOPAL,PSOLPD,PSOLPRX
"RTN","PSOUTLA1",67,0)
 S PSOBACKA=PSOBACKA-.01
"RTN","PSOUTLA1",68,0)
 I '$G(PSOBACKB) S PSOBACKB=DT
"RTN","PSOUTLA1",69,0)
 F PSOPAL=0:0 S PSOPAL=$O(^PS(55,PSOPAL)) Q:'PSOPAL  F PSOLPD=PSOBACKA:0 S PSOLPD=$O(^PS(55,PSOPAL,"P","A",PSOLPD)) Q:'PSOLPD!(PSOLPD>PSOBACKB)  F PSOLPRX=0:0 S PSOLPRX=$O(^PS(55,PSOPAL,"P","A",PSOLPD,PSOLPRX)) Q:'PSOLPRX  D
"RTN","PSOUTLA1",70,0)
 .I $P($G(^PSRX(PSOLPRX,0)),"^")=""!('$P($G(^(0)),"^",2))!('$P($G(^(0)),"^",6)) Q
"RTN","PSOUTLA1",71,0)
 .I $P($G(^PSRX(PSOLPRX,"OR1")),"^",2) Q
"RTN","PSOUTLA1",72,0)
 .I '$P($G(^PSRX(PSOLPRX,0)),"^",19) D
"RTN","PSOUTLA1",73,0)
 ..I $P($G(^PSRX(PSOLPRX,"OR1")),"^")="",+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2)) S $P(^PSRX(PSOLPRX,"OR1"),"^")=+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2))
"RTN","PSOUTLA1",74,0)
 ..I $P($G(^PSRX(PSOLPRX,0)),"^",10)'="",$G(^PSRX(PSOLPRX,"SIG"))']"",'$O(^PSRX(PSOLPRX,"SIG1",0)) S ^PSRX(PSOLPRX,"SIG")=$P($G(^PSRX(PSOLPRX,0)),"^",10)_"^"_0 S $P(^PSRX(PSOLPRX,0),"^",10)=""
"RTN","PSOUTLA1",75,0)
 ..I $P($G(^PSRX(PSOLPRX,"STA")),"^")="",$P($G(^PSRX(PSOLPRX,0)),"^",15)'="" S $P(^PSRX(PSOLPRX,"STA"),"^")=$P($G(^PSRX(PSOLPRX,0)),"^",15) S $P(^PSRX(PSOLPRX,0),"^",15)=""
"RTN","PSOUTLA1",76,0)
 ..S $P(^PSRX(PSOLPRX,0),"^",19)=1
"RTN","PSOUTLA1",77,0)
 .S PSOLPSTA=$P($G(^PSRX(PSOLPRX,"STA")),"^") Q:PSOLPSTA=""!(PSOLPSTA=13)!(PSOLPSTA=10)
"RTN","PSOUTLA1",78,0)
 .D EN^PSOHLSN1(PSOLPRX,"ZC","")
"RTN","PSOUTLA1",79,0)
 .I PSOLPSTA'="",PSOLPSTA<10 D
"RTN","PSOUTLA1",80,0)
 ..I +$P($G(^PSRX(PSOLPRX,2)),"^",6),+$P($G(^(2)),"^",6)<DT S $P(^PSRX(PSOLPRX,"STA"),"^")=11,PSOLPSTA=11
"RTN","PSOUTLA1",81,0)
 .S PSOLPSTX=$S(PSOLPSTA=3:"OH",PSOLPSTA=16:"OH",PSOLPSTA=12:"OD",PSOLPSTA=15:"OD",PSOLPSTA=14:"OD",1:"SC"),PSOLPSTZ=$S(PSOLPSTA=0:"CM",PSOLPSTA=1:"IP",PSOLPSTA=4:"IP",PSOLPSTA=5:"ZS",PSOLPSTA=11:"ZE",1:"")
"RTN","PSOUTLA1",82,0)
 .D EN^PSOHLSN1(PSOLPRX,PSOLPSTX,PSOLPSTZ,"")
"RTN","PSOUTLA1",83,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOUTLA1",84,0)
PATCHQ Q
"RTN","PSOUTLA1",85,0)
 ;
"RTN","PSOUTLA1",86,0)
 ;PSO*186
"RTN","PSOUTLA1",87,0)
DEACHK(PSIRXN,PSDEA,PSDAYS,PCLOZ,PSOCS,PSMAXRF) ;Apply DEA restrictions
"RTN","PSOUTLA1",88,0)
 ;
"RTN","PSOUTLA1",89,0)
 ; If no refills allowed indicate that and set Max refills to number
"RTN","PSOUTLA1",90,0)
 ; of fills thus far, or if new order, then num of refills will not be
"RTN","PSOUTLA1",91,0)
 ; found and Max refills will be 0.
"RTN","PSOUTLA1",92,0)
 ;
"RTN","PSOUTLA1",93,0)
 ;  Function returns: 1 = no refills allowed
"RTN","PSOUTLA1",94,0)
 ;                    0 = ok to refill
"RTN","PSOUTLA1",95,0)
 ;  Input Variables: PSIRXN = internal RX number or "*"=(new order)
"RTN","PSOUTLA1",96,0)
 ;                   PSDEA  = DEA special handling for drug ordered
"RTN","PSOUTLA1",97,0)
 ;                   PSDAYS = Days supply ordered
"RTN","PSOUTLA1",98,0)
 ;                   PCLOZ  = Clozapine patient? (Optional)
"RTN","PSOUTLA1",99,0)
 ; Output Variables: PSOCS  = Controlled sub flag  (Optional)
"RTN","PSOUTLA1",100,0)
 ;                   PSMAXRF= Max Refill allowed by DEA restriction
"RTN","PSOUTLA1",101,0)
 ;                                                 (Optional)
"RTN","PSOUTLA1",102,0)
 ;
"RTN","PSOUTLA1",103,0)
 S PSIRXN=+$G(PSIRXN),PSDEA=$G(PSDEA),PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",104,0)
 S PSOCS=+$G(PSOCS),PSMAXRF=+$G(PSMAXRF),PCLOZ=$G(PCLOZ)
"RTN","PSOUTLA1",105,0)
 ;
"RTN","PSOUTLA1",106,0)
 ;if clozapine patient (passed in 0 or 1),  set max refills and quit
"RTN","PSOUTLA1",107,0)
 I PCLOZ=0 S PSMAXRF=0 Q 1
"RTN","PSOUTLA1",108,0)
 I PCLOZ=1 S PSMAXRF=1 Q 0
"RTN","PSOUTLA1",109,0)
 ;
"RTN","PSOUTLA1",110,0)
 ;no refills if PSDEA = 'A' & not 'B' or 'F',
"RTN","PSOUTLA1",111,0)
 I (PSDEA["A")&(PSDEA'["B")!(PSDEA["F")!(PSDEA[1)!(PSDEA[2) D  Q 1
"RTN","PSOUTLA1",112,0)
 . S PSMAXRF=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",113,0)
 ;
"RTN","PSOUTLA1",114,0)
 N QQ
"RTN","PSOUTLA1",115,0)
 F QQ=1:1 Q:$E(PSDEA,QQ)=""  I $E(+PSDEA,QQ)>1,$E(+PSDEA,QQ)<6 D
"RTN","PSOUTLA1",116,0)
 . S PSOCS=1
"RTN","PSOUTLA1",117,0)
 . S:$E(+PSDEA,QQ)=2 $P(PSOCS,"^",2)=1
"RTN","PSOUTLA1",118,0)
 ;
"RTN","PSOUTLA1",119,0)
 ;no refills allowed on sched 2
"RTN","PSOUTLA1",120,0)
 I $P(PSOCS,"^",2)=1 S PSMAXRF=$$NUMFILLS(PSIRXN) Q 1
"RTN","PSOUTLA1",121,0)
 ;
"RTN","PSOUTLA1",122,0)
 ;set max refill for controlled substance & other based on days supply
"RTN","PSOUTLA1",123,0)
 S PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",124,0)
 I PSOCS D
"RTN","PSOUTLA1",125,0)
 . S PSMAXRF=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0)
"RTN","PSOUTLA1",126,0)
 E  D
"RTN","PSOUTLA1",127,0)
 . S PSMAXRF=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0)
"RTN","PSOUTLA1",128,0)
 ;
"RTN","PSOUTLA1",129,0)
 ;get number of fills if applies & compare to Max refills
"RTN","PSOUTLA1",130,0)
 N PNFILLS S PNFILLS=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",131,0)
 I PNFILLS'<PSMAXRF S PSMAXRF=PNFILLS Q 1
"RTN","PSOUTLA1",132,0)
 ;
"RTN","PSOUTLA1",133,0)
 Q 0
"RTN","PSOUTLA1",134,0)
 ;
"RTN","PSOUTLA1",135,0)
NUMFILLS(PSIRXN) ;Return number of fills thus far, or 0 if doesn't apply
"RTN","PSOUTLA1",136,0)
 ; function returns: if   Active drug, then number of refills thus far
"RTN","PSOUTLA1",137,0)
 ;                   else return 0 for does not apply
"RTN","PSOUTLA1",138,0)
 ;  Input Variables: PSIRXN = internal RX number (Optional)
"RTN","PSOUTLA1",139,0)
 Q:'$G(PSIRXN) 0
"RTN","PSOUTLA1",140,0)
 N RFN,RFNC
"RTN","PSOUTLA1",141,0)
 S (RFN,RFNC)=0
"RTN","PSOUTLA1",142,0)
 F  S RFN=$O(^PSRX(PSIRXN,1,RFN)) Q:'RFN  S RFNC=RFNC+1
"RTN","PSOUTLA1",143,0)
 Q RFNC
"RTN","PSOUTLA1",144,0)
 ;
"RTN","PSOUTLA1",145,0)
REFIP(RXI,RFIL,TYP) ;Check if refill is Not Released and In Process and
"RTN","PSOUTLA1",146,0)
 ;           pending Auto Release by an external dispense machine.
"RTN","PSOUTLA1",147,0)
 ; Input: RXI = internal Prescription no.
"RTN","PSOUTLA1",148,0)
 ;        RFIL= refill number
"RTN","PSOUTLA1",149,0)
 ;        TYP ="R"-refill or "P"-partial
"RTN","PSOUTLA1",150,0)
 ; Returns 1 = In Process      (Not OK to delete)
"RTN","PSOUTLA1",151,0)
 ;         0 = Not In Process  (OK to delete)
"RTN","PSOUTLA1",152,0)
 ;
"RTN","PSOUTLA1",153,0)
 ;assumes a refill is Not In Process by the external dispense machine
"RTN","PSOUTLA1",154,0)
 ;unless it finds a record in this file and is marked to the contrary
"RTN","PSOUTLA1",155,0)
 ;
"RTN","PSOUTLA1",156,0)
 N PSIEN,IP,FOUND,EXDATA,EXDIV
"RTN","PSOUTLA1",157,0)
 S (IP,FOUND)=0,PSIEN=""
"RTN","PSOUTLA1",158,0)
 ;find first specified refill processing backwards, in case dupes
"RTN","PSOUTLA1",159,0)
 F  S PSIEN=$O(^PS(52.51,"B",RXI,PSIEN),-1) Q:PSIEN=""  D  Q:FOUND
"RTN","PSOUTLA1",160,0)
 . S EXDATA=^PS(52.51,PSIEN,0)
"RTN","PSOUTLA1",161,0)
 . I $P(EXDATA,"^",9)=RFIL D
"RTN","PSOUTLA1",162,0)
 . . S EXDIV=$P(EXDATA,"^",11)
"RTN","PSOUTLA1",163,0)
 . . Q:'$P($G(^PS(59,EXDIV,"DISP")),"^",2)     ;quit, not auto release
"RTN","PSOUTLA1",164,0)
 . . S FOUND=1
"RTN","PSOUTLA1",165,0)
 . I FOUND,$P(^PS(52.51,PSIEN,0),"^",10)'=2 S IP=1
"RTN","PSOUTLA1",166,0)
 Q IP
"RTN","PSOUTLA1",167,0)
 ;
"RTN","PSOUTLA1",168,0)
WARN1 ;partial del checks    *259
"RTN","PSOUTLA1",169,0)
 N PSR,PSOL
"RTN","PSOUTLA1",170,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),"P",PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTLA1",171,0)
 I DA=PSOL,$P(^PSRX(DA(1),"P",DA,0),"^",19) D  Q
"RTN","PSOUTLA1",172,0)
 .D EN^DDIOL("Partial Released! Use the 'Return to Stock' option!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTLA1",173,0)
 ;
"RTN","PSOUTLA1",174,0)
 ;Warn of In Process, Only delete if answered Yes         ;*259
"RTN","PSOUTLA1",175,0)
 I $$REFIP^PSOUTLA1(DA(1),DA,"P") D  I 'Y Q               ;reset $T
"RTN","PSOUTLA1",176,0)
 . D EN^DDIOL("** Partial refill has previously been sent to the External Dispense Machine","","!!,?2")
"RTN","PSOUTLA1",177,0)
 . D EN^DDIOL("** for filling and is still Pending Processing","","$C(7),!,?2")
"RTN","PSOUTLA1",178,0)
 . D EN^DDIOL("","","!")
"RTN","PSOUTLA1",179,0)
 . K DIR
"RTN","PSOUTLA1",180,0)
 . S DIR("A")="Do you want to continue? "
"RTN","PSOUTLA1",181,0)
 . S DIR("B")="Y"
"RTN","PSOUTLA1",182,0)
 . S DIR(0)="YA^^"
"RTN","PSOUTLA1",183,0)
 . S DIR("?")="Enter Y for Yes or N for No."
"RTN","PSOUTLA1",184,0)
 . D ^DIR
"RTN","PSOUTLA1",185,0)
 . K DIR
"RTN","PSOUTLA1",186,0)
 Q
"VER")
8.0^22.0
"BLD",6250,6)
^247
**END**
**END**

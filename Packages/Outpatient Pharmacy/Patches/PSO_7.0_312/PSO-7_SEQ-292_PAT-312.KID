Released PSO*7*312 SEQ #292
Extracted from mail message
**KIDS**:PSO*7.0*312^

**INSTALL NAME**
PSO*7.0*312
"BLD",7041,0)
PSO*7.0*312^OUTPATIENT PHARMACY^0^3090126^y
"BLD",7041,1,0)
^^4^4^3080917^
"BLD",7041,1,1,0)
This patch will modify the dispensing machine releasing so 
"BLD",7041,1,2,0)
the Message Server ID field (#10) of the Pharmacy External 
"BLD",7041,1,3,0)
Interface file (#52.51) does not get overwritten for previous 
"BLD",7041,1,4,0)
fills with the latest Message Server Id.
"BLD",7041,4,0)
^9.64PA^^
"BLD",7041,6.3)
5
"BLD",7041,"KRN",0)
^9.67PA^8989.52^19
"BLD",7041,"KRN",.4,0)
.4
"BLD",7041,"KRN",.401,0)
.401
"BLD",7041,"KRN",.402,0)
.402
"BLD",7041,"KRN",.403,0)
.403
"BLD",7041,"KRN",.5,0)
.5
"BLD",7041,"KRN",.84,0)
.84
"BLD",7041,"KRN",3.6,0)
3.6
"BLD",7041,"KRN",3.8,0)
3.8
"BLD",7041,"KRN",9.2,0)
9.2
"BLD",7041,"KRN",9.8,0)
9.8
"BLD",7041,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",7041,"KRN",9.8,"NM",1,0)
PSOHLDS^^0^B35608322
"BLD",7041,"KRN",9.8,"NM",2,0)
PSOHLSG^^0^B32839983
"BLD",7041,"KRN",9.8,"NM","B","PSOHLDS",1)

"BLD",7041,"KRN",9.8,"NM","B","PSOHLSG",2)

"BLD",7041,"KRN",19,0)
19
"BLD",7041,"KRN",19.1,0)
19.1
"BLD",7041,"KRN",101,0)
101
"BLD",7041,"KRN",409.61,0)
409.61
"BLD",7041,"KRN",771,0)
771
"BLD",7041,"KRN",870,0)
870
"BLD",7041,"KRN",8989.51,0)
8989.51
"BLD",7041,"KRN",8989.52,0)
8989.52
"BLD",7041,"KRN",8994,0)
8994
"BLD",7041,"KRN","B",.4,.4)

"BLD",7041,"KRN","B",.401,.401)

"BLD",7041,"KRN","B",.402,.402)

"BLD",7041,"KRN","B",.403,.403)

"BLD",7041,"KRN","B",.5,.5)

"BLD",7041,"KRN","B",.84,.84)

"BLD",7041,"KRN","B",3.6,3.6)

"BLD",7041,"KRN","B",3.8,3.8)

"BLD",7041,"KRN","B",9.2,9.2)

"BLD",7041,"KRN","B",9.8,9.8)

"BLD",7041,"KRN","B",19,19)

"BLD",7041,"KRN","B",19.1,19.1)

"BLD",7041,"KRN","B",101,101)

"BLD",7041,"KRN","B",409.61,409.61)

"BLD",7041,"KRN","B",771,771)

"BLD",7041,"KRN","B",870,870)

"BLD",7041,"KRN","B",8989.51,8989.51)

"BLD",7041,"KRN","B",8989.52,8989.52)

"BLD",7041,"KRN","B",8994,8994)

"BLD",7041,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7041,"QUES",0)
^9.62^^
"BLD",7041,"REQB",0)
^9.611^1^1
"BLD",7041,"REQB",1,0)
PSO*7.0*156^2
"BLD",7041,"REQB","B","PSO*7.0*156",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
312^3090126
"PKG",141,22,1,"PAH",1,1,0)
^^4^4^3090126
"PKG",141,22,1,"PAH",1,1,1,0)
This patch will modify the dispensing machine releasing so 
"PKG",141,22,1,"PAH",1,1,2,0)
the Message Server ID field (#10) of the Pharmacy External 
"PKG",141,22,1,"PAH",1,1,3,0)
Interface file (#52.51) does not get overwritten for previous 
"PKG",141,22,1,"PAH",1,1,4,0)
fills with the latest Message Server Id.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOHLDS")
0^1^B35608322^B35328782
"RTN","PSOHLDS",1,0)
PSOHLDS ;BIR/PWC-HL7 V.2.4 AUTOMATED DISPENSE INTERFACE ;03/01/96 09:45
"RTN","PSOHLDS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,312**;DEC 1997;Build 5
"RTN","PSOHLDS",3,0)
 ;External reference to GETAPP^HLCS2  supported by DBIA 2887
"RTN","PSOHLDS",4,0)
 ;External reference to INIT^HLFNC2   supported by DBIA 2161
"RTN","PSOHLDS",5,0)
 ;External reference to GENERATE^HLMA supported by DBIA 2164
"RTN","PSOHLDS",6,0)
 ;External reference to SETUP^XQALERT supported by DBIA 10081
"RTN","PSOHLDS",7,0)
 ;External reference to ^XUSEC("PSOINTERFACE" supported by DBIA 10076
"RTN","PSOHLDS",8,0)
 ;External reference to ^ORD(101 supported by DBIA 872
"RTN","PSOHLDS",9,0)
 ;
"RTN","PSOHLDS",10,0)
INIT ;initialize variables and build outgoing message
"RTN","PSOHLDS",11,0)
 N DFLAG,HLRESLT,HLP,PSLINK,PSOHLSER,PSOHLCL,PSOHLINX
"RTN","PSOHLDS",12,0)
 S PSOHLINX=$$GETAPP^HLCS2("PSO EXT SERVER") Q:$P($G(PSOHLINX),"^",2)="i"
"RTN","PSOHLDS",13,0)
 K ^TMP("PSO",$J)
"RTN","PSOHLDS",14,0)
 S PIEN=$O(^ORD(101,"B","PSO EXT SERVER",0)) G:'PIEN EXIT
"RTN","PSOHLDS",15,0)
 S PSI=1,HLPDT=DT D INIT^HLFNC2(PIEN,.HL1) I $G(HL1) G EXIT
"RTN","PSOHLDS",16,0)
 S FS=HL1("FS"),HL1("ECH")="~^\&",HLECH=HL1("ECH")
"RTN","PSOHLDS",17,0)
 S CS=$E(HL1("ECH")),RS=$E(HL1("ECH"),2),EC=$E(HL1("ECH"),3),SCS=$E(HL1("ECH"),4)
"RTN","PSOHLDS",18,0)
 I '$G(PSODTM) D NOW^%DTC S DTME=%
"RTN","PSOHLDS",19,0)
 I $G(PSODTM) S DTME=PSODTM
"RTN","PSOHLDS",20,0)
 F II=0:0 S II=$O(^UTILITY($J,"PSOHL",II)) Q:'II  S ODR=^UTILITY($J,"PSOHL",II) D
"RTN","PSOHLDS",21,0)
 .S IRXN=$P(ODR,"^"),IDGN=$P(ODR,"^",2),FP=$P(ODR,"^",3),FPN=$P(ODR,"^",4),DAW=$P(ODR,"^",5),DIN=$P(ODR,"^",6)
"RTN","PSOHLDS",22,0)
 .S ^TMP("PSOMID",$J,II)=IRXN_"^"_FP_"^"_FPN I DIN=1 D   ;;*312 - ADDED IRXN AS 4TH PIECE
"RTN","PSOHLDS",23,0)
 ..F JJ=0:0 S JJ=$O(^UTILITY($J,"PSOHL",II,JJ)) Q:'JJ  S ING(JJ)=^UTILITY($J,"PSOHL",II,JJ)
"RTN","PSOHLDS",24,0)
 .S SDI=$P(ODR,"^",7) I SDI=1 S DRI=^UTILITY($J,"PSOHL",II,"DRI")
"RTN","PSOHLDS",25,0)
 .S CPY=$P(ODR,"^",8),RPRT=$P(ODR,"^",9),PRSN=$P(ODR,"^",10),DIV=$G(PSOSITE),DFN=$P(^PSRX(IRXN,0),"^",2),STPMTR=$P($G(^PS(59,DIV,1)),"^",30)
"RTN","PSOHLDS",26,0)
 .I $G(STPMTR)>1&($P($G(^PSRX(IRXN,"STA")),"^")=5) D
"RTN","PSOHLDS",27,0)
 ..N PSOHLSPZ,PSOHLNDA S PSOHLSPZ=$O(^PS(52.5,"B",IRXN,0)),PSOHLNDA=""
"RTN","PSOHLDS",28,0)
 ..I PSOHLSPZ S PSOHLNDA=$G(^PS(52.5,PSOHLSPZ,0))
"RTN","PSOHLDS",29,0)
 ..I $G(RXPR(IRXN)),+$G(RXPR(IRXN))'=$P(PSOHLNDA,"^",5) Q
"RTN","PSOHLDS",30,0)
 ..I '$G(RXRP(IRXN)),'$G(RXPR(IRXN)),$D(RXFL(IRXN)),$P(PSOHLNDA,"^",13)'="",$P($G(RXFL(IRXN)),"^")'=$P(PSOHLNDA,"^",13) Q
"RTN","PSOHLDS",31,0)
 ..D SUS^PSOLBL4(IRXN,FP,FPN,RPRT)
"RTN","PSOHLDS",32,0)
 .K DIK,DIC,DA,DD,DO S DIC="^PS(52.51,",X=IRXN,DIC(0)=""
"RTN","PSOHLDS",33,0)
 .S DIC("DR")="2////"_DFN_";3////"_DTME_";4////"_PRSN_";5////"_RPRT_";6////"_STPMTR_";8////"_FP_";9////"_FPN_";15////"_DIV_";13////"_"BUILDING MESSAGE"_";14////1"
"RTN","PSOHLDS",34,0)
 .D FILE^DICN K DD,DO,DIC
"RTN","PSOHLDS",35,0)
 .S $P(^TMP("PSOMID",$J,II),"^",4)=$P(Y,"^") K Y
"RTN","PSOHLDS",36,0)
 .D START^PSOHLDS1
"RTN","PSOHLDS",37,0)
 K ^TMP("HLS",$J)
"RTN","PSOHLDS",38,0)
 M ^TMP("HLS",$J)=^TMP("PSO",$J) K ^TMP("PSO",$J)
"RTN","PSOHLDS",39,0)
 S PSLINK=$O(^UTILITY($J,"PSOHL",0))
"RTN","PSOHLDS",40,0)
 S DDNS=$$GET1^DIQ(59,PSOSITE_",",2006),DPORT=$$GET1^DIQ(59,PSOSITE_",",2007)
"RTN","PSOHLDS",41,0)
 S HLP("CONTPTR")="",HLP("SUBSCRIBER")="^^^^~"_DDNS_":"_DPORT_"~DNS"
"RTN","PSOHLDS",42,0)
 D GENERATE^HLMA(PIEN,"GM",1,.HLRESLT,"",.HLP)
"RTN","PSOHLDS",43,0)
 K HLL S HLMID=$P($G(HLRESLT),"^"),HLERR=$P($G(HLRESLT),"^",2)
"RTN","PSOHLDS",44,0)
 I '$G(HLMID) S XQAMSG="Error transmitting "_$P(^DPT(DFN,0),"^")_" order to external interface" D ALERT G EXIT
"RTN","PSOHLDS",45,0)
 I $G(HLMID),$P($G(HLERR),"^")'="" S XQAMSG="Error transmitting batch "_HLMID_" to the external interface",MESS="TRANSMISSION FAILED",STA=3 D UFILE,ALERT G EXIT
"RTN","PSOHLDS",46,0)
 I $G(HLMID),$P($G(HLERR),"^")="" S MESS="MESSAGE TRANSMITTED",STA=1 D UFILE G EXIT
"RTN","PSOHLDS",47,0)
UFILE F II=0:0 S II=$O(^TMP("PSOMID",$J,II)) Q:'II  S III=$G(^(II)) D
"RTN","PSOHLDS",48,0)
 .S PRX=$P(III,"^",4),PFP=$P(III,"^",2),PFPN=$P(III,"^",3)
"RTN","PSOHLDS",49,0)
 .Q:'$D(^PS(52.51,PRX))
"RTN","PSOHLDS",50,0)
 .I $P($G(^PS(52.51,PRX,0)),"^",8)=PFP,$P($G(^PS(52.51,PRX,0)),"^",9)=PFPN D
"RTN","PSOHLDS",51,0)
 ..S DA=PRX,DIE="^PS(52.51,",DR="10////"_HLMID_";13////"_MESS_";14////"_STA_"" D ^DIE
"RTN","PSOHLDS",52,0)
 Q
"RTN","PSOHLDS",53,0)
 ;
"RTN","PSOHLDS",54,0)
EXIT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOHLDS",55,0)
 K ^TMP("PSOMID",$J),MESS,PSODTM,STA,HLMID,PRX,PFP,PFPN,CS,CPY,DAW,DIN,DRI,EC,FP,FPN,FS,ING,IRXN,IDGN,II,JJ,ODR,PSI,RS,SCS,SDI,%
"RTN","PSOHLDS",56,0)
 K DA,DIE,DIV,DR,DTME,HL1,HLERR,HLPDT,XXX,DFN,PAS,STPMTR,X,III,PIEN,PRSN,RPRT,PAS1,PAS2,PAS3
"RTN","PSOHLDS",57,0)
 K ^TMP("HLS",$J),^TMP("PSO",$J)
"RTN","PSOHLDS",58,0)
 Q
"RTN","PSOHLDS",59,0)
 ;
"RTN","PSOHLDS",60,0)
ERRMSG S EMSG=""
"RTN","PSOHLDS",61,0)
 F AA=1:1 X HLNEXT Q:HLQUIT'>0  S EMSG=EMSG_"&&"_HLNODE
"RTN","PSOHLDS",62,0)
 S ^TMP("PSO2",$J)=EMSG
"RTN","PSOHLDS",63,0)
 Q
"RTN","PSOHLDS",64,0)
ACK ;process MSA received from the dispense machine (client)
"RTN","PSOHLDS",65,0)
 ;
"RTN","PSOHLDS",66,0)
 S:'$D(HL("APAT")) HL("APAT")="AL"
"RTN","PSOHLDS",67,0)
 S AACK=HL("APAT"),DTM=HL("DTM"),ETN=HL("ETN"),CMID=HL("MID")
"RTN","PSOHLDS",68,0)
 S MTN=HL("MTN"),RAN=HL("RAN"),SAN=HL("SAN"),VER=HL("VER")
"RTN","PSOHLDS",69,0)
 S EID=HL("EID"),EIDS=HL("EIDS"),FS=HL("FS")
"RTN","PSOHLDS",70,0)
 I $G(VER)'="2.4" G EXT
"RTN","PSOHLDS",71,0)
 N ORC K PSOMSG F I=1:1 X HLNEXT Q:HLQUIT'>0  S PSOMSG(I)=HLNODE,J=0 D
"RTN","PSOHLDS",72,0)
 .I $P(PSOMSG(I),"|")="MSA" S MSACDE=$P(PSOMSG(I),"|",2),SMID=$P(PSOMSG(I),"|",3) S:$P(PSOMSG(I),"|",4)]"" ERRMSG=$P(PSOMSG(I),"|",4)
"RTN","PSOHLDS",73,0)
 .I $P(PSOMSG(I),"|")="ORC" S ORC=1_"^"_+$P(PSOMSG(I),"|",3)
"RTN","PSOHLDS",74,0)
 .F  S J=$O(HLNODE(J)) Q:'J  S PSOMSG(I,J)=HLNODE(J)
"RTN","PSOHLDS",75,0)
 ;
"RTN","PSOHLDS",76,0)
 S ^TMP("PSO1",$J,CMID)=CMID_"^"_AACK_"^"_DTM_"^"_ETN_"^"_MTN_"^"_RAN_"^"_SAN_"^"_VER_"^"_EID_"^"_EIDS
"RTN","PSOHLDS",77,0)
 ;
"RTN","PSOHLDS",78,0)
 S (DIV1,SP1,SP2)="" F  S DIV1=$O(^PS(52.51,"AM",SMID,DIV1)) Q:'DIV1  F  S SP1=$O(^PS(52.51,"AM",SMID,DIV1,SP1)) Q:'SP1!(SP1=2)  S SP2=$P($G(^PS(52.51,SP1,0)),"^",6)
"RTN","PSOHLDS",79,0)
 I '$D(MSACDE) G EXT
"RTN","PSOHLDS",80,0)
 I $G(MSACDE)="AA" D ACK1
"RTN","PSOHLDS",81,0)
 I $G(MSACDE)="AE"!$G(MSACDE)="AR" D ACK2
"RTN","PSOHLDS",82,0)
 ;
"RTN","PSOHLDS",83,0)
EXT ;
"RTN","PSOHLDS",84,0)
 K ^TMP("PSO1",$J),AACK,DTM,ETN,CMID,MTN,RAN,SAN,VER,EID,EIDS,FS,MSA,AA,RPT
"RTN","PSOHLDS",85,0)
 K MSA1,MSACDE,SMID,ERRMSG,DIV1,SP1,SP2,HL,UID,FLL,FLLN,IRX,FLD12,FLD13
"RTN","PSOHLDS",86,0)
 K DIE,EMSG,HLQUIT,HLNEXT,HLNODE,PSOMSG,ORC,EIN
"RTN","PSOHLDS",87,0)
 Q
"RTN","PSOHLDS",88,0)
 ;
"RTN","PSOHLDS",89,0)
ACK1 ;
"RTN","PSOHLDS",90,0)
 S FLD13=$S($G(ORC):"MEDICATION DISPENSED",1:"TO BE PROCESSED") D FACK1
"RTN","PSOHLDS",91,0)
 Q
"RTN","PSOHLDS",92,0)
 ;
"RTN","PSOHLDS",93,0)
ACK2 S XQAMSG="Error processing batch "_SMID_". Interface will continue to transmit.",FLD13="PROCESS FAILED" S:$G(ERRMSG) FLD12=ERRMSG
"RTN","PSOHLDS",94,0)
 D FACK2,ALERT
"RTN","PSOHLDS",95,0)
 Q
"RTN","PSOHLDS",96,0)
 ;
"RTN","PSOHLDS",97,0)
ALERT ;send alert to key holders
"RTN","PSOHLDS",98,0)
 K XQA,XQAOPT,XQAROU,XQAID,XQADATA,XQAFLAG
"RTN","PSOHLDS",99,0)
 F UID=0:0 S UID=$O(^XUSEC("PSOINTERFACE",UID)) Q:'UID  S XQA(UID)=""
"RTN","PSOHLDS",100,0)
 D SETUP^XQALERT
"RTN","PSOHLDS",101,0)
 Q
"RTN","PSOHLDS",102,0)
UDFILE ;updates from vendor
"RTN","PSOHLDS",103,0)
 S (DIV1,SP1)="" F  S DIV1=$O(^PS(52.51,"AM",SMID,DIV1)) Q:'DIV1  F  S SP1=$O(^PS(52.51,"AM",SMID,DIV1,SP1)) Q:'SP1  S (EIN,DA)=SP1 D
"RTN","PSOHLDS",104,0)
 .S DIE="^PS(52.51,",DR="7////"_SAN_";11////"_CMID_";13////"_FLD13_";14////2" D ^DIE
"RTN","PSOHLDS",105,0)
 Q
"RTN","PSOHLDS",106,0)
FACK1 ;
"RTN","PSOHLDS",107,0)
 D:'$G(ORC) UDFILE
"RTN","PSOHLDS",108,0)
 I $G(ORC) D
"RTN","PSOHLDS",109,0)
 .S RXN=$P(ORC,"^",2),RX=0 F  S RX=$O(^PS(52.51,"B",RXN,RX)) Q:'RX  S (EIN,DA)=RX
"RTN","PSOHLDS",110,0)
 .I $G(DA) D
"RTN","PSOHLDS",111,0)
 ..S HLUSER=$P(^PS(52.51,DA,0),"^",4),HLRPT=$P(^(0),"^",5)
"RTN","PSOHLDS",112,0)
 ..S DIE="^PS(52.51,",DR="7////"_SAN_";11////"_CMID_";13////"_FLD13_";14////2" D ^DIE,^PSOHLDIS K EIN,HLUSER,HLRPT
"RTN","PSOHLDS",113,0)
 Q
"RTN","PSOHLDS",114,0)
 ;
"RTN","PSOHLDS",115,0)
FACK2 ;
"RTN","PSOHLDS",116,0)
 D UDFILE Q:'$G(^PSRX($P(^PS(52.51,EIN,0),"^"),0))
"RTN","PSOHLDS",117,0)
 S ACL=0,IRX=$P(^PS(52.51,EIN,0),"^"),FLL=$P(^(0),"^",8),FLLN=$P(^(0),"^",9),RXN=$P(^PSRX(IRX,0),"^")
"RTN","PSOHLDS",118,0)
 F I=0:0 S SUB=$O(^PSRX(IRX,"A",I)) Q:'I  S ACL=(ACL+1)
"RTN","PSOHLDS",119,0)
 D NOW^%DTC S ACL=ACL+1,^PSRX(IRX,"A",0)="^52.3DA^"_ACL_"^"_ACL
"RTN","PSOHLDS",120,0)
 S ^PSRX(IRX,"A",ACL,0)=%_"^N^^"_$S(FLL="F":FLLN,1:(99-FLLN))_"^External Interface Rx NOT Dispensed." K ACL,I,RXN
"RTN","PSOHLDS",121,0)
 Q
"RTN","PSOHLSG")
0^2^B32839983^B32605777
"RTN","PSOHLSG",1,0)
PSOHLSG ;BIR/LC,PWC-HL7 EXTERNAL INTERFACE ;03/01/96 09:45
"RTN","PSOHLSG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**26,70,139,156,312**;DEC 1997;Build 5
"RTN","PSOHLSG",3,0)
 ;External reference to GETAPP^HLCS2 supported by DBIA 2887
"RTN","PSOHLSG",4,0)
 ;External reference to INIT^HLFNC2 supported by DBIA 2161
"RTN","PSOHLSG",5,0)
 ;External reference to GENERATE^HLMA supported by DBIA 2164
"RTN","PSOHLSG",6,0)
 ;External reference to SETUP^XQALERT supported by DBIA 10081
"RTN","PSOHLSG",7,0)
 ;External reference to ^XUSEC("PSOINTERFACE" supported by DBIA 10076
"RTN","PSOHLSG",8,0)
 ;External reference to ^ORD(101 supported by DBIA 872
"RTN","PSOHLSG",9,0)
 ;
"RTN","PSOHLSG",10,0)
INIT ;initialize variables and build outgoing message
"RTN","PSOHLSG",11,0)
 Q:'$D(^UTILITY($J,"PSOHL"))
"RTN","PSOHLSG",12,0)
 S PSODISP=$$GET1^DIQ(59,PSOSITE_",",105,"I")  ;flag to determine if site is running HL7 V.2.4 dispensing systems
"RTN","PSOHLSG",13,0)
 I PSODISP="2.4" G ^PSOHLDS    ;branch off for V.2.4 dispensing machines
"RTN","PSOHLSG",14,0)
 N DFLAG,HLRESLT,HLP,PSLINK,PSOHLINX
"RTN","PSOHLSG",15,0)
 S PSOHLINX=$$GETAPP^HLCS2("PSO HLSERVER1") Q:$P($G(PSOHLINX),"^",2)="i"
"RTN","PSOHLSG",16,0)
 K ^TMP("PSO",$J)
"RTN","PSOHLSG",17,0)
 S PIEN=$O(^ORD(101,"B","PSO HLSERVER1",0)) G:'PIEN EXIT
"RTN","PSOHLSG",18,0)
 S PSI=1,HLPDT=DT D INIT^HLFNC2(PIEN,.HL1) I $G(HL1) G EXIT
"RTN","PSOHLSG",19,0)
 S FS=HL1("FS"),HL1("ECH")="^~\&",CS=$E(HL1("ECH")),RS=$E(HL1("ECH"),2),EC=$E(HL1("ECH"),3),SCS=$E(HL1("ECH"),4)
"RTN","PSOHLSG",20,0)
 I '$G(PSODTM) D NOW^%DTC S DTME=%
"RTN","PSOHLSG",21,0)
 I $G(PSODTM) S DTME=PSODTM
"RTN","PSOHLSG",22,0)
 F II=0:0 S II=$O(^UTILITY($J,"PSOHL",II)) Q:'II  S ODR=^UTILITY($J,"PSOHL",II) D
"RTN","PSOHLSG",23,0)
 .S IRXN=$P(ODR,"^"),IDGN=$P(ODR,"^",2),FP=$P(ODR,"^",3),FPN=$P(ODR,"^",4),DAW=$P(ODR,"^",5),DIN=$P(ODR,"^",6)
"RTN","PSOHLSG",24,0)
 .S ^TMP("PSOMID",$J,II)=IRXN_"^"_FP_"^"_FPN I DIN=1 D
"RTN","PSOHLSG",25,0)
 ..F JJ=0:0 S JJ=$O(^UTILITY($J,"PSOHL",II,JJ)) Q:'JJ  S ING(JJ)=^UTILITY($J,"PSOHL",II,JJ)
"RTN","PSOHLSG",26,0)
 .S SDI=$P(ODR,"^",7) I SDI=1 S DRI=^UTILITY($J,"PSOHL",II,"DRI")
"RTN","PSOHLSG",27,0)
 .S CPY=$P(ODR,"^",8),RPRT=$P(ODR,"^",9),PRSN=$P(ODR,"^",10),DIV=$G(PSOSITE),DFN=$P(^PSRX(IRXN,0),"^",2),STPMTR=$P($G(^PS(59,DIV,1)),"^",30)
"RTN","PSOHLSG",28,0)
 .I $G(STPMTR)>1&($P($G(^PSRX(IRXN,"STA")),"^")=5) D
"RTN","PSOHLSG",29,0)
 ..N PSOHLSPZ,PSOHLNDA S PSOHLSPZ=$O(^PS(52.5,"B",IRXN,0)),PSOHLNDA=""
"RTN","PSOHLSG",30,0)
 ..I PSOHLSPZ S PSOHLNDA=$G(^PS(52.5,PSOHLSPZ,0))
"RTN","PSOHLSG",31,0)
 ..I $G(RXPR(IRXN)),+$G(RXPR(IRXN))'=$P(PSOHLNDA,"^",5) Q
"RTN","PSOHLSG",32,0)
 ..I '$G(RXRP(IRXN)),'$G(RXPR(IRXN)),$D(RXFL(IRXN)),$P(PSOHLNDA,"^",13)'="",$P($G(RXFL(IRXN)),"^")'=$P(PSOHLNDA,"^",13) Q
"RTN","PSOHLSG",33,0)
 ..D SUS^PSOLBL4(IRXN,FP,FPN,RPRT)
"RTN","PSOHLSG",34,0)
 .K DIC,DA,DD,DO
"RTN","PSOHLSG",35,0)
 .S DIC="^PS(52.51,",X=IRXN,DIC(0)=""
"RTN","PSOHLSG",36,0)
 .S DIC("DR")="2////"_DFN_";3////"_DTME_";4////"_PRSN_";5////"_RPRT_";6////"_STPMTR_";8////"_FP_";9////"_FPN_";15////"_DIV_";13////"_"BUILDING MESSAGE"_";14////1"
"RTN","PSOHLSG",37,0)
 .D FILE^DICN K DD,DO,DIC
"RTN","PSOHLSG",38,0)
 .S $P(^TMP("PSOMID",$J,II),"^",4)=$P(Y,"^") K Y
"RTN","PSOHLSG",39,0)
 .D START^PSOHLSG1
"RTN","PSOHLSG",40,0)
 K ^TMP("HLS",$J)
"RTN","PSOHLSG",41,0)
 M ^TMP("HLS",$J)=^TMP("PSO",$J)
"RTN","PSOHLSG",42,0)
 S PSLINK=$O(^UTILITY($J,"PSOHL",0))
"RTN","PSOHLSG",43,0)
 S HLL("LINKS",1)="PSO HLCLIENT1^"_$P($G(^UTILITY($J,"PSOHL",PSLINK)),"^",12)
"RTN","PSOHLSG",44,0)
 S HLP("CONTPTR")="" D GENERATE^HLMA(PIEN,"GM",1,.HLRESLT,"",.HLP)
"RTN","PSOHLSG",45,0)
 K HLL S HLMID=$P($G(HLRESLT),"^"),HLERR=$P($G(HLRESLT),"^",2)
"RTN","PSOHLSG",46,0)
 I '$G(HLMID) S XQAMSG="Error transmitting "_$P(^DPT(DFN,0),"^")_" order to external interface" D ALERT G EXIT
"RTN","PSOHLSG",47,0)
 I $G(HLMID),$P($G(HLERR),"^")'="" S XQAMSG="Error transmitting batch "_HLMID_" to the external interface",MESS="TRANSMISSION FAILED",STA=3 D UFILE,ALERT G EXIT
"RTN","PSOHLSG",48,0)
 I $G(HLMID),$P($G(HLERR),"^")="" S MESS="MESSAGE TRANSMITTED",STA=1 D UFILE G EXIT
"RTN","PSOHLSG",49,0)
UFILE S II="" F  S II=$O(^TMP("PSOMID",$J,II)) Q:II=""  S III=$G(^(II)) D
"RTN","PSOHLSG",50,0)
 .S PRX=$P(III,"^",4),PFP=$P(III,"^",2),PFPN=$P(III,"^",3)
"RTN","PSOHLSG",51,0)
 .Q:'$D(^PS(52.51,PRX))
"RTN","PSOHLSG",52,0)
 .;S JJ="" F  S JJ=$O(^PS(52.51,"B",PRX,JJ)) Q:JJ=""  D
"RTN","PSOHLSG",53,0)
 .I $P($G(^PS(52.51,PRX,0)),"^",8)=PFP,$P($G(^PS(52.51,PRX,0)),"^",9)=PFPN D
"RTN","PSOHLSG",54,0)
 ..S DA=PRX,DIE="^PS(52.51,",DR="10////"_HLMID_";13////"_MESS_";14////"_STA_"" D ^DIE
"RTN","PSOHLSG",55,0)
 Q
"RTN","PSOHLSG",56,0)
 ;
"RTN","PSOHLSG",57,0)
EXIT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOHLSG",58,0)
 K ^TMP("PSOMID",$J),MESS,PSODTM,STA,HLMID,PRX,PFP,PFPN,CS,CPY,DAW,DIN,DRI,EC,FP,FPN,FS,ING,IRXN,IDGN,II,JJ,ODR,PSI,RS,SCS,SDI,%
"RTN","PSOHLSG",59,0)
 K DA,DIE,DIV,DR,DTME,HL1,HLERR,HLPDT,XXX,^TMP("PSO",$J),DFN,PAS,STPMTR,X,III,PIEN,PRSN,RPRT
"RTN","PSOHLSG",60,0)
 K ^TMP("HLS",$J)
"RTN","PSOHLSG",61,0)
 Q
"RTN","PSOHLSG",62,0)
 ;
"RTN","PSOHLSG",63,0)
ERRMSG S EMSG=""
"RTN","PSOHLSG",64,0)
 F AA=1:1 X HLNEXT Q:HLQUIT'>0  S EMSG=EMSG_"&&"_HLNODE
"RTN","PSOHLSG",65,0)
 S ^TMP("PSO2",$J)=EMSG
"RTN","PSOHLSG",66,0)
 Q
"RTN","PSOHLSG",67,0)
ACK ;process MSA received from the dispense machine (client)
"RTN","PSOHLSG",68,0)
 ;
"RTN","PSOHLSG",69,0)
 S:'$D(HL("APAT")) HL("APAT")="AL"
"RTN","PSOHLSG",70,0)
 S AACK=HL("APAT"),DTM=HL("DTM"),ETN=HL("ETN"),CMID=HL("MID")
"RTN","PSOHLSG",71,0)
 S MTN=HL("MTN"),RAN=HL("RAN"),SAN=HL("SAN"),VER=HL("VER")
"RTN","PSOHLSG",72,0)
 S EID=HL("EID"),EIDS=HL("EIDS"),FS=HL("FS")
"RTN","PSOHLSG",73,0)
 I $G(VER)'="2.2" G EXT
"RTN","PSOHLSG",74,0)
 S MSA=""
"RTN","PSOHLSG",75,0)
 F AA=1:1 X HLNEXT Q:HLQUIT'>0  S MSA=MSA_"&&"_HLNODE
"RTN","PSOHLSG",76,0)
 ;
"RTN","PSOHLSG",77,0)
 S ^TMP("PSO1",$J,CMID)=CMID_"^"_AACK_"^"_DTM_"^"_ETN_"^"_MTN_"^"_RAN_"^"_SAN_"^"_VER_"^"_EID_"^"_EIDS_"^"_MSA
"RTN","PSOHLSG",78,0)
 S MSA1=$P(^TMP("PSO1",$J,CMID),"&&",3),MSACDE=$P(MSA1,FS,2),SMID=$P(MSA1,FS,3) S:$P(MSA1,FS,4) ERRMSG=$P(MSA1,FS,4)
"RTN","PSOHLSG",79,0)
 ;
"RTN","PSOHLSG",80,0)
 S (DIV1,SP1,SP2)="" F  S DIV1=$O(^PS(52.51,"AM",SMID,DIV1)) Q:'DIV1  F  S SP1=$O(^PS(52.51,"AM",SMID,DIV1,SP1)) Q:'SP1!(SP1=2)  S SP2=$P($G(^PS(52.51,SP1,0)),"^",6)
"RTN","PSOHLSG",81,0)
 I '$D(MSACDE) G EXT
"RTN","PSOHLSG",82,0)
 I $G(MSACDE)="AA" D ACK1
"RTN","PSOHLSG",83,0)
 I $G(MSACDE)="AE"!$G(MSACDE)="AR" D ACK2
"RTN","PSOHLSG",84,0)
 ;the following can be used if site require ACKing the ACK
"RTN","PSOHLSG",85,0)
 ;S HLARYTYP="GM",HLFORMAT=1,HLMTIENS="",HLP("CONTPTR")=""
"RTN","PSOHLSG",86,0)
 ;S HLEID=EID,HLMTIENS="",HLEIDS=EIDS,HLARYTYP="GM",HLFORMAT=1,HLMTIENA=""
"RTN","PSOHLSG",87,0)
 ;D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,HLARYTYP,HLFORMAT,.HLRESLTA,HLMTIENA,.HLP)
"RTN","PSOHLSG",88,0)
 ;
"RTN","PSOHLSG",89,0)
EXT ;K ALL VARIABLES AND QUIT
"RTN","PSOHLSG",90,0)
 K ^TMP("PSO1",$J),AACK,DTM,ETN,CMID,MTN,RAN,SAN,VER,EID,EIDS,FS,MSA,AA,RPT
"RTN","PSOHLSG",91,0)
 K MSA1,MSACDE,SMID,ERRMSG,DIV1,SP1,SP2,HL,UID,FLL,FLLN,IRX,FLD12,FLD13
"RTN","PSOHLSG",92,0)
 K DIE,EMSG,HLQUIT,HLNEXT,HLNODE
"RTN","PSOHLSG",93,0)
 Q
"RTN","PSOHLSG",94,0)
 ;
"RTN","PSOHLSG",95,0)
ACK1 ;
"RTN","PSOHLSG",96,0)
 S FLD13="PROCESSED" D FACK1
"RTN","PSOHLSG",97,0)
 Q
"RTN","PSOHLSG",98,0)
 ;
"RTN","PSOHLSG",99,0)
ACK2 S XQAMSG="Error processing batch "_SMID_". Interface has been shutdown.",FLD13="PROCESS FAILED" S:$G(ERRMSG) FLD12=ERRMSG
"RTN","PSOHLSG",100,0)
 D FACK2,ALERT
"RTN","PSOHLSG",101,0)
 Q
"RTN","PSOHLSG",102,0)
 ;
"RTN","PSOHLSG",103,0)
ALERT ;turn off transmission and send alert to key holders
"RTN","PSOHLSG",104,0)
 S:$G(PSOSITE) $P(^PS(59,PSOSITE,0),"^",30)=0
"RTN","PSOHLSG",105,0)
 K XQA,XQAOPT,XQAROU,XQAID,XQADATA,XQAFLAG
"RTN","PSOHLSG",106,0)
 F UID=0:0 S UID=$O(^XUSEC("PSOINTERFACE",UID)) Q:'UID  S XQA(UID)=""
"RTN","PSOHLSG",107,0)
 D SETUP^XQALERT
"RTN","PSOHLSG",108,0)
 Q
"RTN","PSOHLSG",109,0)
FACK1 ;
"RTN","PSOHLSG",110,0)
 S (DIV1,SP1)="" F  S DIV1=$O(^PS(52.51,"AM",SMID,DIV1)) Q:'DIV1  F  S SP1=$O(^PS(52.51,"AM",SMID,DIV1,SP1)) Q:'SP1  S DA=SP1 D
"RTN","PSOHLSG",111,0)
 .S DIE="^PS(52.51,",DR="7////"_SAN_";11////"_CMID_";13////"_FLD13_";14////2" D ^DIE
"RTN","PSOHLSG",112,0)
 .I $G(SP2)>1 S IRX=$P(^PS(52.51,SP1,0),"^"),FLL=$P(^(0),"^",8),FLLN=$P(^(0),"^",9),RPT=$P(^(0),"^",5) D LAB^PSOLBL4(IRX,FLL,FLLN,RPT)
"RTN","PSOHLSG",113,0)
 Q
"RTN","PSOHLSG",114,0)
 ;
"RTN","PSOHLSG",115,0)
FACK2 ;
"RTN","PSOHLSG",116,0)
 S (DIV1,SP1)="" F  S DIV1=$O(^PS(52.51,"AM",SMID,DIV1)) Q:'DIV1  F  S SP1=$O(^PS(52.51,"AM",SMID,DIV1,SP1)) Q:'SP1  S DA=SP1 D
"RTN","PSOHLSG",117,0)
 .S DIE="^PS(52.51,",DR="7////"_SAN_";11////"_CMID_";12////"_FLD12_";13////"_FLD13_";14////3" D ^DIE
"RTN","PSOHLSG",118,0)
 Q
"VER")
8.0^22.0
"BLD",7041,6)
^292
**END**
**END**

Released PSO*7*246 SEQ #255
Extracted from mail message
**KIDS**:PSO*7.0*246^

**INSTALL NAME**
PSO*7.0*246
"BLD",6958,0)
PSO*7.0*246^OUTPATIENT PHARMACY^0^3070725^y
"BLD",6958,1,0)
^^8^8^3070725^
"BLD",6958,1,1,0)
MODIFY PSO COST TO IGNORE BAD XREFS IN FILE 52
"BLD",6958,1,2,0)
 
"BLD",6958,1,3,0)
An Undefined error occurs when editing a large number of prescriptions.
"BLD",6958,1,4,0)
 
"BLD",6958,1,5,0)
Correct OPAI option 4 in file #59 field #28 (send marked drugs and
"BLD",6958,1,6,0)
print labels)
"BLD",6958,1,7,0)
 
"BLD",6958,1,8,0)
Locking Issue
"BLD",6958,4,0)
^9.64PA^^
"BLD",6958,6)
8^
"BLD",6958,6.3)
12
"BLD",6958,"KRN",0)
^9.67PA^8989.52^19
"BLD",6958,"KRN",.4,0)
.4
"BLD",6958,"KRN",.401,0)
.401
"BLD",6958,"KRN",.402,0)
.402
"BLD",6958,"KRN",.403,0)
.403
"BLD",6958,"KRN",.5,0)
.5
"BLD",6958,"KRN",.84,0)
.84
"BLD",6958,"KRN",3.6,0)
3.6
"BLD",6958,"KRN",3.8,0)
3.8
"BLD",6958,"KRN",9.2,0)
9.2
"BLD",6958,"KRN",9.8,0)
9.8
"BLD",6958,"KRN",9.8,"NM",0)
^9.68A^8^3
"BLD",6958,"KRN",9.8,"NM",1,0)
PSOCSTM^^0^B46011931
"BLD",6958,"KRN",9.8,"NM",2,0)
PSORXED^^0^B53805571
"BLD",6958,"KRN",9.8,"NM",8,0)
PSOLBL4^^0^B49309535
"BLD",6958,"KRN",9.8,"NM","B","PSOCSTM",1)

"BLD",6958,"KRN",9.8,"NM","B","PSOLBL4",8)

"BLD",6958,"KRN",9.8,"NM","B","PSORXED",2)

"BLD",6958,"KRN",19,0)
19
"BLD",6958,"KRN",19.1,0)
19.1
"BLD",6958,"KRN",101,0)
101
"BLD",6958,"KRN",409.61,0)
409.61
"BLD",6958,"KRN",771,0)
771
"BLD",6958,"KRN",870,0)
870
"BLD",6958,"KRN",8989.51,0)
8989.51
"BLD",6958,"KRN",8989.52,0)
8989.52
"BLD",6958,"KRN",8994,0)
8994
"BLD",6958,"KRN","B",.4,.4)

"BLD",6958,"KRN","B",.401,.401)

"BLD",6958,"KRN","B",.402,.402)

"BLD",6958,"KRN","B",.403,.403)

"BLD",6958,"KRN","B",.5,.5)

"BLD",6958,"KRN","B",.84,.84)

"BLD",6958,"KRN","B",3.6,3.6)

"BLD",6958,"KRN","B",3.8,3.8)

"BLD",6958,"KRN","B",9.2,9.2)

"BLD",6958,"KRN","B",9.8,9.8)

"BLD",6958,"KRN","B",19,19)

"BLD",6958,"KRN","B",19.1,19.1)

"BLD",6958,"KRN","B",101,101)

"BLD",6958,"KRN","B",409.61,409.61)

"BLD",6958,"KRN","B",771,771)

"BLD",6958,"KRN","B",870,870)

"BLD",6958,"KRN","B",8989.51,8989.51)

"BLD",6958,"KRN","B",8989.52,8989.52)

"BLD",6958,"KRN","B",8994,8994)

"BLD",6958,"QUES",0)
^9.62^^
"BLD",6958,"REQB",0)
^9.611^5^3
"BLD",6958,"REQB",1,0)
PSO*7.0*201^2
"BLD",6958,"REQB",4,0)
PSO*7.0*212^2
"BLD",6958,"REQB",5,0)
PSO*7.0*233^2
"BLD",6958,"REQB","B","PSO*7.0*201",1)

"BLD",6958,"REQB","B","PSO*7.0*212",4)

"BLD",6958,"REQB","B","PSO*7.0*233",5)

"MBREQ")
0
"PKG",134,-1)
1^1
"PKG",134,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",134,20,0)
^9.402P^^
"PKG",134,22,0)
^9.49I^1^1
"PKG",134,22,1,0)
7.0^2971216^2980417^1271
"PKG",134,22,1,"PAH",1,0)
246^3070725^33243
"PKG",134,22,1,"PAH",1,1,0)
^^8^8^3070725
"PKG",134,22,1,"PAH",1,1,1,0)
MODIFY PSO COST TO IGNORE BAD XREFS IN FILE 52
"PKG",134,22,1,"PAH",1,1,2,0)
 
"PKG",134,22,1,"PAH",1,1,3,0)
An Undefined error occurs when editing a large number of prescriptions.
"PKG",134,22,1,"PAH",1,1,4,0)
 
"PKG",134,22,1,"PAH",1,1,5,0)
Correct OPAI option 4 in file #59 field #28 (send marked drugs and
"PKG",134,22,1,"PAH",1,1,6,0)
print labels)
"PKG",134,22,1,"PAH",1,1,7,0)
 
"PKG",134,22,1,"PAH",1,1,8,0)
Locking Issue
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSOCSTM")
0^1^B46011931^B44070535
"RTN","PSOCSTM",1,0)
PSOCSTM ;BHAM ISC/SAB - monthly rx cost compilation ;7/10/06 4:36pm
"RTN","PSOCSTM",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,17,19,28,89,212,246**;DEC 1997;Build 12
"RTN","PSOCSTM",3,0)
 ;External Ref. to ^PS(55 DBIA# 2228
"RTN","PSOCSTM",4,0)
 ;External Ref. to ^DPT DBIA# 10035
"RTN","PSOCSTM",5,0)
 ;External Ref. to ^PSDRUG DBIA# 221
"RTN","PSOCSTM",6,0)
 ;
"RTN","PSOCSTM",7,0)
 ;*212 don't allow this request, if monthly compile is running
"RTN","PSOCSTM",8,0)
 ;*246 alter SRCH1 For loop to not init to numeric values
"RTN","PSOCSTM",9,0)
 ;
"RTN","PSOCSTM",10,0)
 Q:$$MTHLCK(1)            ;get lock, quit if already locked    PSO*212
"RTN","PSOCSTM",11,0)
 K BDT,EDT W !!,"**** Date Range Selection ****" S LATE=$E(DT,1,5)_"00"
"RTN","PSOCSTM",12,0)
BEG W ! S %DT="APE",%DT("A")="   Beginning MONTH/YEAR : " D ^%DT G:Y<0 Q W:Y'<LATE !!,$C(7),"Run 'DAILY' compilation routine for selected month!",! G:Y'<LATE BEG I (+$E(Y,6,7)'=0)!(+$E(Y,4,5)=0) D QUES G BEG
"RTN","PSOCSTM",13,0)
 S BDT=Y
"RTN","PSOCSTM",14,0)
END S %DT(0)=BDT W ! S %DT="APE",%DT("A")="   Ending    MONTH/YEAR : " D ^%DT K %DT G:Y<0 Q W:Y'<LATE !!,$C(7),"Run 'DAILY' compilation routine for selected month!",! G:Y'<LATE END I (+$E(Y,6,7)'=0)!(+$E(Y,4,5)=0) D QUES G END
"RTN","PSOCSTM",15,0)
 W ! S EDT=Y
"RTN","PSOCSTM",16,0)
 S ZTIO="",ZTRTN="START^PSOCSTM",ZTDESC="Rx Monthly Cost Compile" F G="EDT","BDT" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOCSTM",17,0)
 D ^%ZTLOAD W:$D(ZTSK) !,"Task #"_ZTSK_" Queued!" K G,BDT,EDT,ZTSAVE,ZTIO,ZTRTN,ZTDESC Q
"RTN","PSOCSTM",18,0)
 L -^PSOCSTM                                    ;unlock month end flag
"RTN","PSOCSTM",19,0)
 ;
"RTN","PSOCSTM",20,0)
START Q:$$MTHLCK^PSOCSTM(1)      ;get lock, quit if already locked  PSO*212
"RTN","PSOCSTM",21,0)
 K ^TMP($J) S PSG=0 F I=1:1 S X=$T(G+I) Q:$P(X,";",3)=""  S A(I)=$P(X,";",3),B(I)=$P(X,";",4),PSG=PSG+1,A1(I)=$P(X,";",5),B1(I)=$P(X,";",6)
"RTN","PSOCSTM",22,0)
 S PSD=0 F I=1:1 S X=$T(D+I) Q:X=""  S C(I)=$P(X,";",3),D(I)=$P(X,";",4),PSD=PSD+1,C1(I)=$P(X,";",5),D1(I)=$P(X,";",6)
"RTN","PSOCSTM",23,0)
 F PSDT=BDT:100:EDT K ^PSCST(PSDT),^PSCST("B",PSDT)
"RTN","PSOCSTM",24,0)
 S STOP=$E(EDT,1,5)_"31.2359",PSDT=BDT F  S PSDT=$O(^PSCST(PSDT)) Q:'PSDT!(PSDT>STOP)  K ^PSCST(PSDT),^PSCST("B",PSDT)
"RTN","PSOCSTM",25,0)
 K STOP
"RTN","PSOCSTM",26,0)
 ;
"RTN","PSOCSTM",27,0)
SRCH F PSDT=BDT:100:EDT S PSDTX=PSDT+100 D:$E(PSDT,4,5)<13 SRCH1,SET1 S:$E(PSDT,4,5)>12 PSDT=$E(PSDT,1,2)_($E(PSDT,3)+1)_"0000"
"RTN","PSOCSTM",28,0)
 S PSOCNT=0 F PSDT=0:0 S PSDT=$O(^PSCST("B",PSDT)) Q:'PSDT  S PSD=PSDT,PSOCNT=PSOCNT+1
"RTN","PSOCSTM",29,0)
 S ^PSCST(0)="DRUG COST^50.9D^"_PSD_"^"_PSOCNT D ZNODE
"RTN","PSOCSTM",30,0)
Q K ^TMP($J),%DT,A,B,BDT,COST,DATA,DATA1,DATA2,DRG,DFN,EDT,I,II,LATE,ML,OR,PAST,PHYS,PSOCNT,PSD,PSDT,PSDT1,PSDTX,RXF,PSG,QTY,RF,RX0
"RTN","PSOCSTM",31,0)
 K RX2,DIV,D,C,CLINIC,A1,B1,C1,D1,RX1,RXN,VAL,VAR,PGM,VALUE,CDT,NDT,VISITS,DV,VIS,WD,X,X1,X2,Y S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCSTM",32,0)
 L -^PSOCSTM                                    ;unlock month end flag
"RTN","PSOCSTM",33,0)
 Q
"RTN","PSOCSTM",34,0)
 ;
"RTN","PSOCSTM",35,0)
SRCH1 D INI
"RTN","PSOCSTM",36,0)
 ;refill
"RTN","PSOCSTM",37,0)
 S PSDT1=PSDT                                ;*246
"RTN","PSOCSTM",38,0)
 F  S PSDT1=$O(^PSRX("AL",PSDT1)) Q:($E(PSDT1,1,7)<PSDT)!($E(PSDT1,1,7)>PSDTX)  D
"RTN","PSOCSTM",39,0)
 .S CDT=$P(PSDT1,".") F RXN=0:0 S RXN=$O(^PSRX("AL",PSDT1,RXN)) Q:'RXN  S RXF="" F  S RXF=$O(^PSRX("AL",PSDT1,RXN,RXF)) Q:RXF=""  D CHK
"RTN","PSOCSTM",40,0)
 .S NDT=$O(^PSRX("AL",PSDT1)) D:$P(NDT,".")'=CDT VST
"RTN","PSOCSTM",41,0)
 ;partial fill
"RTN","PSOCSTM",42,0)
 S PSDT1=PSDT                                ;*246
"RTN","PSOCSTM",43,0)
 F  S PSDT1=$O(^PSRX("AM",PSDT1)) Q:($E(PSDT1,1,7)<PSDT)!($E(PSDT1,1,7)>PSDTX)  D
"RTN","PSOCSTM",44,0)
 .S CDT=$P(PSDT1,"."),RXN=0 F  S RXN=$O(^PSRX("AM",PSDT1,RXN)) Q:'RXN  S RXF=0 F  S RXF=$O(^PSRX("AM",PSDT1,RXN,RXF)) Q:RXF=""  S PAR=1 D CHK
"RTN","PSOCSTM",45,0)
 .S NDT=$O(^PSRX("AM",PSDT1)) D:$P(NDT,".")'=CDT VST K PAR
"RTN","PSOCSTM",46,0)
 Q
"RTN","PSOCSTM",47,0)
INI K VIS S (VISITS,DV)=0 F  S DV=$O(^PS(59,DV)) Q:'+DV  S VIS(DV)=0
"RTN","PSOCSTM",48,0)
 Q
"RTN","PSOCSTM",49,0)
VST S DV=0 F  S DV=$O(^TMP($J,"PAT",DV)) Q:'DV  D
"RTN","PSOCSTM",50,0)
 .S DFN=0 F  S DFN=$O(^TMP($J,"PAT",DV,DFN)) Q:'DFN  S VIS(DV)=VIS(DV)+1,VISITS=VISITS+1
"RTN","PSOCSTM",51,0)
 K ^TMP($J,"PAT") Q
"RTN","PSOCSTM",52,0)
CHK I '$D(^PSRX(RXN,0)) K ^PSRX("AL",PSDT,RXN,RXF) Q
"RTN","PSOCSTM",53,0)
 Q:'$D(^PSRX(RXN,2))  S RX0=^PSRX(RXN,0),RX2=^PSRX(RXN,2)
"RTN","PSOCSTM",54,0)
 S DFN=+$P(RX0,"^",2) Q:'$D(^DPT(DFN,0))  D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOCSTM",55,0)
 S DRG=+$P(RX0,"^",6) Q:'$D(^PSDRUG(DRG,0))
"RTN","PSOCSTM",56,0)
 ;S CLASS=+$P(^(0),"^",2) Q:'$D(^PS(50.605,CLASS,0))
"RTN","PSOCSTM",57,0)
 S DIV=+$P(RX2,"^",9) Q:'$D(^PS(59,DIV,0))
"RTN","PSOCSTM",58,0)
 S PHYS=+$P(RX0,"^",4) Q:'$D(^VA(200,PHYS,0))
"RTN","PSOCSTM",59,0)
 S PAST=+$P(RX0,"^",3) Q:'$D(^PS(53,PAST,0))
"RTN","PSOCSTM",60,0)
 S CLINIC=+$P(RX0,"^",5) K:'$D(^SC(CLINIC,0)) CLINIC
"RTN","PSOCSTM",61,0)
 S COST=$S(+$P(RX0,"^",17):+$P(RX0,"^",17),$D(^PSDRUG(DRG,660)):+$P(^(660),"^",6),1:0)
"RTN","PSOCSTM",62,0)
 I $G(PAR) D  S PR=0 Q
"RTN","PSOCSTM",63,0)
 .I '$D(^PSRX(RXN,"P",RXF,0)) K ^PSRX("AM",PSDT,RXN,RXF) Q
"RTN","PSOCSTM",64,0)
 .I $P(^PSRX(RXN,"P",RXF,0),"^",19) D
"RTN","PSOCSTM",65,0)
 ..S RX1=^PSRX(RXN,"P",RXF,0),DIV=$S($P(RX1,"^",9):$P(RX1,"^",9),1:$P(RX2,"^",9))
"RTN","PSOCSTM",66,0)
 ..S PHYS=$S($P(RX1,"^",17):$P(RX1,"^",17),1:$P(RX0,"^",4))
"RTN","PSOCSTM",67,0)
 ..S OR=0,RF=1,QTY=+$P(RX1,"^",4),ML=$S($P(RX1,"^",2)="M":1,1:0),WD=$S($P(RX1,"^",2)="W":1,1:0) S COST=QTY*COST D SET,SF
"RTN","PSOCSTM",68,0)
 I $P(RX2,"^",13),'RXF D  Q
"RTN","PSOCSTM",69,0)
 .S OR=1,RF=0,QTY=+$P(RX0,"^",7),ML=$S($P(RX0,"^",11)="M":1,1:0),WD=$S($P(RX0,"^",11)="W":1,1:0),COST=QTY*COST D SET,SF
"RTN","PSOCSTM",70,0)
 D:RXF 
"RTN","PSOCSTM",71,0)
 .I '$D(^PSRX(RXN,1,RXF,0)) K ^PSRX("AL",PSDT,RXN,RXF) Q
"RTN","PSOCSTM",72,0)
 .Q:'$P(^PSRX(RXN,1,RXF,0),"^",18)  S RX1=^PSRX(RXN,1,RXF,0)
"RTN","PSOCSTM",73,0)
 .S OR=0,RF=1,QTY=+$P(RX1,"^",4),ML=$S($P(RX1,"^",2)="M":1,1:0),WD=$S($P(RX1,"^",2)="W":1,1:0) S COST=QTY*COST
"RTN","PSOCSTM",74,0)
 .S PHYS=$S($P(RX1,"^",17):$P(RX1,"^",17),1:$P(RX0,"^",4)),DIV=$S($P(RX1,"^",9):$P(RX1,"^",9),1:$P(RX2,"^",9))
"RTN","PSOCSTM",75,0)
 .D SET,SF
"RTN","PSOCSTM",76,0)
 Q
"RTN","PSOCSTM",77,0)
SF S DATA="^"_OR_"^"_RF_"^"_COST_"^"_QTY_"^"_ML_"^"_WD,^TMP($J,"PAT",DIV,DFN)=""
"RTN","PSOCSTM",78,0)
 F I=1:1:PSG Q:('$D(CLINIC))&(I=PSG)  S DATA1=$S($D(@A(I))#2:^(0),1:@(B(I))_"^0^0^0^0") S DATA2=+$P(DATA1,"^") D
"RTN","PSOCSTM",79,0)
 .F II=2:1:7 S VALUE=$P(DATA,"^",II)+$P(DATA1,"^",II),DATA2=DATA2_"^"_VALUE S:II=7 @A(I)=DATA2
"RTN","PSOCSTM",80,0)
 .S:'$D(@A1(I)) @A1(I)=B1(I) S $P(@A1(I),"^",4)=+$P(@A1(I),"^",4)+1,$P(@A1(I),"^",3)=@B(I)
"RTN","PSOCSTM",81,0)
 F I=1:1:PSD S DATA1=$S(($D(@(C(I)))#2):$G(^(0)),1:@(D(I))_"^0^0^0^0") S DATA2=+$P(DATA1,"^") D
"RTN","PSOCSTM",82,0)
 .F II=2:1:7 S VALUE=$P(DATA,"^",II)+$P(DATA1,"^",II),DATA2=DATA2_"^"_VALUE S:II=7 @C(I)=DATA2 D
"RTN","PSOCSTM",83,0)
 .S:'$D(@C1(I)) @C1(I)=D1(I) S $P(@C1(I),"^",4)=+$P(@C1(I),"^",4)+1,$P(@C1(I),"^",3)=@D(I)
"RTN","PSOCSTM",84,0)
 Q
"RTN","PSOCSTM",85,0)
 ;
"RTN","PSOCSTM",86,0)
SET S:'$D(^PSCST(PSDT,0)) ^PSCST(PSDT,0)=PSDT,^PSCST("B",PSDT,PSDT)="" Q
"RTN","PSOCSTM",87,0)
SET1 S ^PSCST(PSDT,1)=DT_"^"_VISITS
"RTN","PSOCSTM",88,0)
 S DV=0 F  S DV=$O(VIS(DV)) Q:'DV  S $P(^PSCST(PSDT,"V",DV,0),"^",8)=+VIS(DV)
"RTN","PSOCSTM",89,0)
 Q
"RTN","PSOCSTM",90,0)
QUES W !,$C(7),"??",!,"For example, September 1993 could be entered as 9/93 or SEP 93.",!,"For Year 2000 Compliance enter date as 9/2000 or SEP 2000." Q
"RTN","PSOCSTM",91,0)
ZNODE ;update zero nodes
"RTN","PSOCSTM",92,0)
 F PSDT=BDT:$S('$D(BEGDATE):100,1:1):EDT S NDZ=0 F ND="D","P","PS","S","V" S NODE(ND)=0 D:$O(^PSCST(PSDT,"D",0))
"RTN","PSOCSTM",93,0)
 .F  S NDZ=$O(^PSCST(PSDT,ND,NDZ)) Q:'NDZ  S NODE(ND)=NODE(ND)+1,NDZ2=NDZ D:ND="V"
"RTN","PSOCSTM",94,0)
 ..S NDZ1=0,NODE(ND,"P")=0 F  S NDZ1=$O(^PSCST(PSDT,ND,NDZ2,"P",NDZ1)) Q:'NDZ1  S NODE(ND,"P")=NODE(ND,"P")+1
"RTN","PSOCSTM",95,0)
 ..S $P(^PSCST(PSDT,ND,NDZ2,"P",0),"^",4)=NODE(ND,"P"),NDZ1=0
"RTN","PSOCSTM",96,0)
 .S:$G(^PSCST(PSDT,ND,0))]"" $P(^PSCST(PSDT,ND,0),"^",4)=NODE(ND),NDZ=0
"RTN","PSOCSTM",97,0)
 K NDZ,ND,NODE,NDZ2,NDZ1 Q
"RTN","PSOCSTM",98,0)
 ;
"RTN","PSOCSTM",99,0)
MTHLCK(GET) ;lock for month end run or query if month end is running
"RTN","PSOCSTM",100,0)
 ; INPUT:  GET = 1  try to get lock and keep locked
"RTN","PSOCSTM",101,0)
 ;               0  query if locked only, leave as unlocked
"RTN","PSOCSTM",102,0)
 ; RETURNS: 1 - already locked
"RTN","PSOCSTM",103,0)
 ;          0 - was not already locked
"RTN","PSOCSTM",104,0)
 ;
"RTN","PSOCSTM",105,0)
 I '$D(ZTQUEUED) W !,"checking for duplicate job..."
"RTN","PSOCSTM",106,0)
 N GOTLOCK
"RTN","PSOCSTM",107,0)
 L +^PSOCSTM:10 S GOTLOCK=$T   ;delay 10 secs to handle slower systems
"RTN","PSOCSTM",108,0)
 I GOTLOCK,'GET L -^PSOCSTM Q 0
"RTN","PSOCSTM",109,0)
 I GOTLOCK,GET Q 0
"RTN","PSOCSTM",110,0)
 N AST S AST="",$P(AST,"*",79)=""
"RTN","PSOCSTM",111,0)
 D:'($D(ZTQUEUED))
"RTN","PSOCSTM",112,0)
 .W !!,*7,AST,!
"RTN","PSOCSTM",113,0)
 .W "Monthly Rx Cost Compilation is currently running, "
"RTN","PSOCSTM",114,0)
 .W "Try your request later",!
"RTN","PSOCSTM",115,0)
 .W AST,!!
"RTN","PSOCSTM",116,0)
 Q 1
"RTN","PSOCSTM",117,0)
 ;
"RTN","PSOCSTM",118,0)
 ;
"RTN","PSOCSTM",119,0)
G ;;
"RTN","PSOCSTM",120,0)
 ;;^PSCST(PSDT,0);PSDT;^TMP($J,"A1");1
"RTN","PSOCSTM",121,0)
 ;;^PSCST(PSDT,"P",PHYS,0);PHYS;^PSCST(PSDT,"P",0);^50.9001PA^^
"RTN","PSOCSTM",122,0)
 ;;^PSCST(PSDT,"P",PHYS,"D",DRG,0);DRG;^PSCST(PSDT,"P",PHYS,"D",0);^50.9002PA^^
"RTN","PSOCSTM",123,0)
 ;;^PSCST(PSDT,"D",DRG,0);DRG;^PSCST(PSDT,"D",0);^50.9003PA^^
"RTN","PSOCSTM",124,0)
 ;;^PSCST(PSDT,"D",DRG,"P",PHYS,0);PHYS;^PSCST(PSDT,"D",DRG,"P",0);^50.9004PA^^
"RTN","PSOCSTM",125,0)
 ;;^PSCST(PSDT,"PS",PAST,0);PAST;^PSCST(PSDT,"PS",0);^50.9005PA^^
"RTN","PSOCSTM",126,0)
 ;;^PSCST(PSDT,"S",CLINIC,0);CLINIC;^PSCST(PSDT,"S",0);^50.9008PA^^
"RTN","PSOCSTM",127,0)
 ;;
"RTN","PSOCSTM",128,0)
D ;;
"RTN","PSOCSTM",129,0)
 ;;^PSCST(PSDT,"V",DIV,0);DIV;^PSCST(PSDT,"V",0);^50.9006PA^^
"RTN","PSOCSTM",130,0)
 ;;^PSCST(PSDT,"V",DIV,"D",DRG,0);DRG;^PSCST(PSDT,"V",DIV,"D",0);^50.9007PA^^
"RTN","PSOCSTM",131,0)
 ;;^PSCST(PSDT,"V",DIV,"P",PHYS,0);PHYS;^PSCST(PSDT,"V",DIV,"P",0);^50.901PA^^
"RTN","PSOLBL4")
0^8^B49309535^B55680785
"RTN","PSOLBL4",1,0)
PSOLBL4 ;BIR/RTR-Set up routine for HL7 interface ;12/19/06 10:45am
"RTN","PSOLBL4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**26,70,156,244,233,246**;DEC 1997;Build 12
"RTN","PSOLBL4",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOLBL4",4,0)
 ;
"RTN","PSOLBL4",5,0)
 ;*244 - ignore RX's with a status > 11
"RTN","PSOLBL4",6,0)
 ;*246 - send marked drugs & print label (option 4) now working
"RTN","PSOLBL4",7,0)
 ;
"RTN","PSOLBL4",8,0)
 N DIC,AP,X,Y,DPRT,QPRT
"RTN","PSOLBL4",9,0)
 I $G(ZTIO)]"" D
"RTN","PSOLBL4",10,0)
 .Q:'$O(^PS(59,PSOSITE,"P",0))
"RTN","PSOLBL4",11,0)
 .S DIC=3.5,DIC(0)="",X=ZTIO D ^DIC K DIC,X Q:Y=-1
"RTN","PSOLBL4",12,0)
 .S DPRT=+Y
"RTN","PSOLBL4",13,0)
 .F AP=0:0 S AP=$O(^PS(59,PSOSITE,"P",AP)) Q:'AP  I +$P(^PS(59,PSOSITE,"P",AP,0),"^")=DPRT S QPRT=1
"RTN","PSOLBL4",14,0)
 .I '$G(QPRT) S $P(PSOPAR,"^",30)=0
"RTN","PSOLBL4",15,0)
 Q:'$P($G(PSOPAR),"^",30)                ;HL7 interface turned off
"RTN","PSOLBL4",16,0)
 Q:$G(PSOEXREP)
"RTN","PSOLBL4",17,0)
HL N PSODTM,HHHH,PSOQUE,HLFLAG,HLFOUR,HLINGF,HLINRX,HLINRX0,II,HLNEXT,HLRR,HLRX,HLRXY,LL,PPLHL,PSHALP,HDFN,HLDFN,HNEWDFN,HLDAI,HLOSITE,HLJUST,HLRXYZ,PSOLLN,PSOLLL,PSFLG,HDFN1,NOTMD
"RTN","PSOLBL4",18,0)
 S HLOSITE=$P($G(PSOPAR),"^",30)
"RTN","PSOLBL4",19,0)
 K ^UTILITY($J,"PSOHL"),^UTILITY($J,"PSOHLL"),HLRXY
"RTN","PSOLBL4",20,0)
 S PPLHL=PPL
"RTN","PSOLBL4",21,0)
 S HLFLAG=0 F II=1:1 S HLRX=$P(PPLHL,",",II) D  Q:$G(HLFLAG)
"RTN","PSOLBL4",22,0)
 .S HLNEXT=$P(PPLHL,",",(II+1)) I HLNEXT=""!(HLNEXT=",") S HLFLAG=1
"RTN","PSOLBL4",23,0)
 .Q:'$G(HLRX)
"RTN","PSOLBL4",24,0)
 .Q:'$D(^PSRX(HLRX,0))
"RTN","PSOLBL4",25,0)
 .Q:$P($G(^PSRX(HLRX,"STA")),"^")=4
"RTN","PSOLBL4",26,0)
 .Q:$G(RXRP(HLRX,"RP"))
"RTN","PSOLBL4",27,0)
 .I $P($G(^PSRX(HLRX,"STA")),"^")>11!('$P(^PSRX(HLRX,0),"^",2)) Q
"RTN","PSOLBL4",28,0)
 .I $G(PSODBQ) S HLRR=$O(^PS(52.5,"B",HLRX,0)) Q:'HLRR  I $G(^PS(52.5,+HLRR,"P"))=1 Q
"RTN","PSOLBL4",29,0)
 .;   marked drug options 3 & 4
"RTN","PSOLBL4",30,0)
 .I (HLOSITE=3)!(HLOSITE=4) S NOTMD=0 D  Q:NOTMD     ;quit, not marked
"RTN","PSOLBL4",31,0)
 ..S HLJUST=+$P($G(^PSRX(HLRX,0)),"^",6)
"RTN","PSOLBL4",32,0)
 ..S:'$P($G(^PSDRUG(HLJUST,6)),"^") NOTMD=1
"RTN","PSOLBL4",33,0)
 .S HLRXY(II,HLRX)=""                                ;Valid Rx for HL7
"RTN","PSOLBL4",34,0)
 .S:HLOSITE=3 HLRXYZ(HLRX)=""
"RTN","PSOLBL4",35,0)
 ;
"RTN","PSOLBL4",36,0)
 I $G(HLOSITE)=3,$D(HLRXY) D                 ;rebuild PPL print string
"RTN","PSOLBL4",37,0)
 .K PPL F II=1:1 S HLRX=$P(PPLHL,",",II) Q:'HLRX  D
"RTN","PSOLBL4",38,0)
 ..Q:$D(HLRXYZ(HLRX))
"RTN","PSOLBL4",39,0)
 ..S PPL=$G(PPL)_HLRX_","
"RTN","PSOLBL4",40,0)
 ;
"RTN","PSOLBL4",41,0)
SOMDQ S (II,PSOQUE)=0 F  S II=$O(HLRXY(II)) Q:'II  S ^UTILITY($J,"PSOHLL",II)=$O(HLRXY(II,0)),PSOQUE=II
"RTN","PSOLBL4",42,0)
 I PSOQUE=0 G ENDHL                ;Nothing set, bypass Call to Queue
"RTN","PSOLBL4",43,0)
 F II=0:0 S II=$O(^UTILITY($J,"PSOHLL",II)) Q:'II  S HLINRX=^(II),HLINRX0=$G(^PSRX(HLINRX,0)) D
"RTN","PSOLBL4",44,0)
 .S ^UTILITY($J,"PSOHLL",II)=HLINRX_"^"_+$P(HLINRX0,"^",6)_"^"_$S($G(RXPR(HLINRX)):"P",1:"F")
"RTN","PSOLBL4",45,0)
 .I '$G(RXPR(HLINRX)) S HLFOUR=0 F HHHH=0:0 S HHHH=$O(^PSRX(HLINRX,1,HHHH)) Q:'HHHH  I +^(HHHH,0) S HLFOUR=HHHH
"RTN","PSOLBL4",46,0)
 .I '$G(RXPR(HLINRX)),$G(RXFL(HLINRX))'="" S HLFOUR=$S($G(RXFL(HLINRX))=0:0,$D(^PSRX(HLINRX,1,+$G(RXFL(HLINRX)),0)):+$G(RXFL(HLINRX)),1:$G(HLFOUR))
"RTN","PSOLBL4",47,0)
 .S ^UTILITY($J,"PSOHLL",II)=^UTILITY($J,"PSOHLL",II)_"^"_$S($G(RXPR(HLINRX)):RXPR(HLINRX),1:HLFOUR)_"^"_$S($P($G(^PSRX(HLINRX,3)),"^",6)&('$G(RXPR(HLINRX)))&('$G(RXFL(HLINRX))):1,1:0) D ACLOG
"RTN","PSOLBL4",48,0)
 .S HLINGF=0 I $P(^UTILITY($J,"PSOHLL",II),"^",5),$O(^PSRX(HLINRX,"DAI",0)) S HLINGF=1 D
"RTN","PSOLBL4",49,0)
 ..F LL=0:0 S LL=$O(^PSRX(HLINRX,"DAI",LL)) Q:'LL  S ^UTILITY($J,"PSOHLL",II,HLINGF)=$G(^PSRX(HLINRX,"DAI",LL,0)),HLINGF=HLINGF+1
"RTN","PSOLBL4",50,0)
 .S $P(^UTILITY($J,"PSOHLL",II),"^",6)=$S($G(HLINGF):1,1:0)
"RTN","PSOLBL4",51,0)
 .I $D(^PSRX(HLINRX,"DRI")),'$G(RXPR(HLINRX)),'$G(RXFL(HLINRX)) S ^UTILITY($J,"PSOHLL",II,"DRI")=^PSRX(HLINRX,"DRI"),$P(^UTILITY($J,"PSOHLL",II),"^",7)=1
"RTN","PSOLBL4",52,0)
 .E  S $P(^UTILITY($J,"PSOHLL",II),"^",7)=0
"RTN","PSOLBL4",53,0)
 .S $P(^UTILITY($J,"PSOHLL",II),"^",8)=0 D RPT Q:'$G(^PSRX(HLINRX,"IB"))
"RTN","PSOLBL4",54,0)
 .I $P(^PSRX(HLINRX,"STA"),"^")>0,$P(^("STA"),"^")'=2,'$G(PSODBQ) Q
"RTN","PSOLBL4",55,0)
 .S $P(^UTILITY($J,"PSOHLL",II),"^",8)=1
"RTN","PSOLBL4",56,0)
 ;
"RTN","PSOLBL4",57,0)
AAA D STRT^PSOHLSG5
"RTN","PSOLBL4",58,0)
 S (HDFN,HDFN1)=$O(^UTILITY($J,"PSOHLL",0)),HDFN=$P(^PSRX($P(^(HDFN),"^"),0),"^",2),PSOLLL=$P(^UTILITY($J,"PSOHLL",HDFN1),"^",12)
"RTN","PSOLBL4",59,0)
 F HLDFN=0:0 S HLDFN=$O(^UTILITY($J,"PSOHLL",HLDFN)) Q:'HLDFN  D  S ^UTILITY($J,"PSOHL",HLDFN)=^UTILITY($J,"PSOHLL",HLDFN) D OTHER
"RTN","PSOLBL4",60,0)
 .S PSFLG=0,PSOLLN=$P(^UTILITY($J,"PSOHLL",HLDFN),"^",12),HNEWDFN=$P(^PSRX($P(^UTILITY($J,"PSOHLL",HLDFN),"^"),0),"^",2) D
"RTN","PSOLBL4",61,0)
 ..I HDFN'=HNEWDFN S HDFN=HNEWDFN,PSFLG=1
"RTN","PSOLBL4",62,0)
 ..I PSOLLL'=PSOLLN S PSOLLL=PSOLLN,PSFLG=1
"RTN","PSOLBL4",63,0)
 ..I PSFLG=1 D SETZ
"RTN","PSOLBL4",64,0)
 I '$D(^UTILITY($J,"PSOHL")) G ENDHL
"RTN","PSOLBL4",65,0)
CALL D SETZ
"RTN","PSOLBL4",66,0)
ENDHL K ^UTILITY($J,"PSOHL"),^UTILITY($J,"PSOHLL"),HLRXY
"RTN","PSOLBL4",67,0)
 Q
"RTN","PSOLBL4",68,0)
OTHER I $G(^UTILITY($J,"PSOHLL",HLDFN,"DRI"))'="" S ^UTILITY($J,"PSOHL",HLDFN,"DRI")=^UTILITY($J,"PSOHLL",HLDFN,"DRI")
"RTN","PSOLBL4",69,0)
 F HLDAI=0:0 S HLDAI=$O(^UTILITY($J,"PSOHLL",HLDFN,HLDAI)) Q:'HLDAI  S ^UTILITY($J,"PSOHL",HLDFN,HLDAI)=^UTILITY($J,"PSOHLL",HLDFN,HLDAI)
"RTN","PSOLBL4",70,0)
 Q
"RTN","PSOLBL4",71,0)
ACLOG ;Activity log (sending to Hl7 interface)
"RTN","PSOLBL4",72,0)
 N DTTM,HCOM,HCNT,HJJ
"RTN","PSOLBL4",73,0)
 D NOW^%DTC S DTTM=%,HCOM="Prescription"_$S($G(RXPR(HLINRX)):" (Partial)",1:"")_$S($G(PSOSUREP)!($G(RXRP(HLINRX))):" (Reprint)",1:"")_" sent to external interface."
"RTN","PSOLBL4",74,0)
 S HCNT=0 F HJJ=0:0 S HJJ=$O(^PSRX(HLINRX,"A",HJJ)) Q:'HJJ  S HCNT=HJJ
"RTN","PSOLBL4",75,0)
 S HCNT=HCNT+1,^PSRX(HLINRX,"A",0)="^52.3DA^"_HCNT_"^"_HCNT S ^PSRX(HLINRX,"A",HCNT,0)=DTTM_"^X^"_$G(PDUZ)_"^"_$S($G(RXPR(HLINRX)):6,$G(HLFOUR)<6:$G(HLFOUR),1:(HLFOUR+1))_"^"_HCOM
"RTN","PSOLBL4",76,0)
 Q
"RTN","PSOLBL4",77,0)
SUS(HSREX,HSFL,HSFILL,HSRP) ;
"RTN","PSOLBL4",78,0)
 N DA,DIK,DTTM,HSCOM,HSCNT,HSJJ,HSLDUZ,PSHLCPRS
"RTN","PSOLBL4",79,0)
 I $P($G(^PSRX(HSREX,"STA")),"^")=5 S $P(^PSRX(HSREX,"STA"),"^")=0 S PSHLCPRS="Removed from Suspense, External Interface." D EN^PSOHLSN1(HSREX,"SC","ZU",PSHLCPRS)
"RTN","PSOLBL4",80,0)
 S DA=$O(^PS(52.5,"B",HSREX,0)) I DA K DIK S DIK="^PS(52.5," D ^DIK
"RTN","PSOLBL4",81,0)
 I $G(HSFL)="P" S HSLDUZ=+$P($G(^PSRX(HSREX,"P",HSFILL,0)),"^",7)
"RTN","PSOLBL4",82,0)
 E  S HSLDUZ=$S('HSFILL:+$P($G(^PSRX(HSREX,0)),"^",16),1:+$P($G(^PSRX(HSREX,1,HSFILL,0)),"^",7))
"RTN","PSOLBL4",83,0)
 D NOW^%DTC S DTTM=%,HSCOM="Removed from Suspense"_$S($G(HSFL)="P":" (Partial)",1:"")_$S($G(HSRP):" (Reprint)",1:"")_" (External Interface)"
"RTN","PSOLBL4",84,0)
 S HSCNT=0 F HSJJ=0:0 S HSJJ=$O(^PSRX(HSREX,"A",HSJJ)) Q:'HSJJ  S HSCNT=HSJJ
"RTN","PSOLBL4",85,0)
 S HSCNT=HSCNT+1,^PSRX(HSREX,"A",0)="^52.3DA^"_HSCNT_"^"_HSCNT S ^PSRX(HSREX,"A",HSCNT,0)=DTTM_"^X^"_$G(HSLDUZ)_"^"_$S($G(HSFL)="P":6,$G(HSFILL)<6:$G(HSFILL),1:(HSFILL+1))_"^"_$G(HSCOM)
"RTN","PSOLBL4",86,0)
 Q
"RTN","PSOLBL4",87,0)
LAB(HLREX,HLFL,HLFILL,HLREPT) ;
"RTN","PSOLBL4",88,0)
 N HLDUZ,NOW,DA,HCT,HFF
"RTN","PSOLBL4",89,0)
 D NOW^%DTC S NOW=% S HCT=0 F HFF=0:0 S HFF=$O(^PSRX(HLREX,"L",HFF)) Q:'HFF  S HCT=HFF
"RTN","PSOLBL4",90,0)
 I HLFL="F" S HLDUZ=$S('HLFILL:+$P($G(^PSRX(HLREX,0)),"^",16),1:+$P($G(^PSRX(HLREX,1,HLFILL,0)),"^",7))
"RTN","PSOLBL4",91,0)
 I HLFL="P" S HLDUZ=+$P($G(^PSRX(HLREX,"P",HLFILL,0)),"^",7)
"RTN","PSOLBL4",92,0)
 S HCT=HCT+1,^PSRX(HLREX,"L",0)="^52.032DA^"_HCT_"^"_HCT
"RTN","PSOLBL4",93,0)
 S ^PSRX(HLREX,"L",HCT,0)=NOW_"^"_$S($G(HLFL)="F":HLFILL,1:(99-HLFILL))_"^"_"From Rx number "_$P(^PSRX(HLREX,0),"^")_$S($G(HLFL)="P":" (Partial)",1:"")_$S($G(HLREPT):" (Reprint)",1:"")_" (External Interface)"_"^"_$G(HLDUZ)
"RTN","PSOLBL4",94,0)
 N PSOBADR,PSOTEMP
"RTN","PSOLBL4",95,0)
 S PSOBADR=$$CHKRX^PSOBAI(HLREX)
"RTN","PSOLBL4",96,0)
 I $G(PSOBADR) S PSOTEMP=$P(PSOBADR,"^",2),PSOBADR=$P(PSOBADR,"^")
"RTN","PSOLBL4",97,0)
 I $G(PSOBADR),'$G(PSOTEMP) D
"RTN","PSOLBL4",98,0)
 .S HCT=HCT+1,^PSRX(HLREX,"L",0)="^52.032DA^"_HCT_"^"_HCT
"RTN","PSOLBL4",99,0)
 .S ^PSRX(HLREX,"L",HCT,0)=NOW_"^"_$S($G(HLFL)="F":HLFILL,1:(99-HLFILL))_"^"_"ROUTING="_$G(MW)_" (BAD ADDRESS)"_"^"_$G(HLDUZ)
"RTN","PSOLBL4",100,0)
 Q
"RTN","PSOLBL4",101,0)
RPT ;
"RTN","PSOLBL4",102,0)
 S $P(^UTILITY($J,"PSOHLL",II),"^",9)=$S($G(PSOSUREP)!($G(RXRP(HLINRX))):1,1:0)
"RTN","PSOLBL4",103,0)
 S $P(^UTILITY($J,"PSOHLL",II),"^",10)=+$G(PDUZ)
"RTN","PSOLBL4",104,0)
 Q
"RTN","PSOLBL4",105,0)
SETZ ;
"RTN","PSOLBL4",106,0)
 D NOW^%DTC S PSODTM=%
"RTN","PSOLBL4",107,0)
 S ZTRTN=$S($$GET1^DIQ(59,PSOSITE_",",105,"I")=2.4:"INIT^PSOHLDS",1:"INIT^PSOHLSG")
"RTN","PSOLBL4",108,0)
 S ZTIO="",ZTDTH=$H,ZTSAVE("^UTILITY($J,""PSOHL"",")="",ZTSAVE("PSOPAR")="",ZTSAVE("PSOSITE")="",ZTSAVE("PSODTM")="",ZTSAVE("PSOLAP")=""
"RTN","PSOLBL4",109,0)
 S ZTSAVE("RXRP(")="",ZTSAVE("RXPR(")="",ZTSAVE("RXFL(")="",ZTSAVE("RXRS(")=""
"RTN","PSOLBL4",110,0)
 S ZTDESC=$S($$GET1^DIQ(59,PSOSITE_",",105,"I")=2.4:"Outpatient Automation External Interface",1:"GENERIC INTERFACE LABEL INFORMATION")
"RTN","PSOLBL4",111,0)
 D ^%ZTLOAD
"RTN","PSOLBL4",112,0)
 Q
"RTN","PSORXED")
0^2^B53805571^B53144628
"RTN","PSORXED",1,0)
PSORXED ;IHS/DSD/JCM-edit rx utility ; 5/18/07 2:53pm
"RTN","PSORXED",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,16,21,26,56,71,125,201,246**;DEC 1997;Build 12
"RTN","PSORXED",3,0)
 ;External reference to ^PSXEDIT supported by DBIA 2209
"RTN","PSORXED",4,0)
 ;External reference to ^DD(52 supported by DBIA 999
"RTN","PSORXED",5,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORXED",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSORXED",7,0)
START ;this entry point is no longer used.
"RTN","PSORXED",8,0)
 ;D INIT,LKUP G:PSORXED("QFLG") END D PARSE,EOJ G START
"RTN","PSORXED",9,0)
END D EOJ
"RTN","PSORXED",10,0)
 Q
"RTN","PSORXED",11,0)
INIT S PSORXED("QFLG")=0 Q
"RTN","PSORXED",12,0)
LKUP ; this line of code is no longer used S PSONUM="RX",PSONUM("A")="EDIT",PSOQFLG=0 D EN1^PSONUM I PSOQFLG!($Q(PSOLIST)']"") S PSORXED("QFLG")=1
"RTN","PSORXED",13,0)
 K PSOQFLG Q
"RTN","PSORXED",14,0)
 ;
"RTN","PSORXED",15,0)
PARSE F PSORXED("LIST")=1:1 Q:'$D(PSOLIST(PSORXED("LIST")))!PSORXED("QFLG")  F PSORXED("I")=1:1:$L(PSOLIST(PSORXED("LIST"))) S PSORXED("IRXN")=$P(PSOLIST(PSORXED("LIST")),",",PSORXED("I")) D:+PSORXED("IRXN") PROCESS
"RTN","PSORXED",16,0)
 Q
"RTN","PSORXED",17,0)
PROCESS S PSORXED("DFLG")=0 G:$G(^PSRX(PSORXED("IRXN"),0))']"" PROCESSX
"RTN","PSORXED",18,0)
 S PSORXED("RX0")=^PSRX(PSORXED("IRXN"),0),PSORXED("RX2")=^(2),PSORXED("RX3")=^(3),PSOSIG=$G(^PSRX(PSORXED("IRXN"),"SIG")),PSODAYS=$P(PSORXED("RX0"),"^",8)
"RTN","PSORXED",19,0)
 S (I,RFED,RFDT)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),1,I)) Q:'I  S RFED=I,PSORXED("RX1")=^PSRX(PSORXED("IRXN"),1,I,0),RFDT=$P(^(0),"^"),PSODAYS=$P(^(0),"^",10) S:$P(^(0),"^",17) PSONEW("PROVIDER NAME")=$P(^VA(200,$P(^(0),"^",17),0),"^")
"RTN","PSORXED",20,0)
 S PSORXST=+$P($G(^PS(53,+$P(PSORXED("RX0"),"^",3),0)),"^",7) N DA S DA=PSORXED("IRXN") D EN^PSORXPR
"RTN","PSORXED",21,0)
 D CHECK G:PSORXED("DFLG") PROCESSX
"RTN","PSORXED",22,0)
 N X S X="PSXEDIT" X ^%ZOSF("TEST") K X I $T D ^PSXEDIT I $G(PSXOUT) K PSXOUT G L1
"RTN","PSORXED",23,0)
 D DIE^PSORXED1
"RTN","PSORXED",24,0)
L1 D LOG,POST
"RTN","PSORXED",25,0)
PROCESSX Q
"RTN","PSORXED",26,0)
CHECK Q  L +^PSRX(PSORXED("IRXN")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W $C(7),!!,"Rx Number is Locked by Another User!",! S PSORXED("DFLG")=1 H 5 Q
"RTN","PSORXED",27,0)
 I $G(^PSDRUG($P(PSORXED("RX0"),"^",6),"I"))]"",^("I")<DT D  G CHECKX
"RTN","PSORXED",28,0)
 . W !,$C(7),"This drug has been inactivated. ",! S PSORXED("DFLG")=1 Q
"RTN","PSORXED",29,0)
 K PSPOP I $G(PSODIV),$P(PSORXED("RX2"),"^",9)'=PSOSITE S PSPRXN=PSORXED("IRXN") D CHK1^PSOUTLA I $G(PSPOP)=1 S PSORXED("DFLG")=1 G CHECKX
"RTN","PSORXED",30,0)
 ;
"RTN","PSORXED",31,0)
 I $P(^PSRX(PSORXED("IRXN"),"STA"),"^")=14!($P(^("STA"),"^")=15) S PSORXED("DFLG")=1 W !!,$C(7),"Discontinued prescriptions cannot be edited.",! G CHECKX
"RTN","PSORXED",32,0)
 I $D(^PS(52.4,"B",PSORXED("IRXN"))) S PSORXED("DFLG")=1 W !!,$C(7),"Non-verified prescriptions cannot be edited.",!
"RTN","PSORXED",33,0)
CHECKX K PSPOP,DIR,DTOUT,DUOUT,Y,X Q
"RTN","PSORXED",34,0)
LOG K PSFROM S DA=PSORXED("IRXN"),(PSRX0,RX0)=PSORXED("RX0"),QTY=$P(RX0,"^",7),QTY=QTY-$P(^PSRX(DA,0),"^",7) K ZD(DA) S:'$O(^PSRX(DA,1,0)) ZD(DA)=$P(^PSRX(DA,2),"^",2)
"RTN","PSORXED",35,0)
 S COM="" F I=3,4,5:1:13,17 I $P(PSRX0,"^",I)'=$P(^PSRX(DA,0),"^",I) S PSI=$S(I=13:1,1:I),COM=COM_$P(^DD(52,PSI,0),"^")_" ("_$P(PSRX0,"^",I)_"),"
"RTN","PSORXED",36,0)
 I $P(PSORXED("RX2"),"^",2)'=$P(^PSRX(DA,2),"^",2) S COM=COM_$P(^DD(52,22,0),"^")_" ("_$P(PSORXED("RX2"),"^",2)_"),"
"RTN","PSORXED",37,0)
 I $P(PSORXED("RX3"),"^",7)'=$P(^PSRX(DA,3),"^",7) S COM=COM_$P(^DD(52,12,0),"^")_" ("_$P(PSORXED("RX3"),"^",7)_"),"
"RTN","PSORXED",38,0)
 I PSOSIG'=$P($G(^PSRX(DA,"SIG")),"^") S COM=COM_$P(^DD(52,10,0),"^")_" ("_PSOSIG_"),"
"RTN","PSORXED",39,0)
 I PSOTRN'=$G(^PSRX(DA,"TN")) S COM=COM_$P(^DD(52,6.5,0),"^")_" ("_PSOTRN_"),"
"RTN","PSORXED",40,0)
 G:COM="" LOGX K PSRX0 S X=$S($D(PSOCLC):PSOCLC,1:DUZ)
"RTN","PSORXED",41,0)
 D FILL,LBL D:$G(PSOEDITL)=2&($P($G(^PSRX(DA,"STA")),"^")'=5)&('$G(RXRP(DA)))&('$G(PSOSIGFL)) ASKL
"RTN","PSORXED",42,0)
 S K=1,D1=0 F Z=0:0 S Z=$O(^PSRX(DA,"A",Z)) Q:'Z  S D1=Z,K=K+1
"RTN","PSORXED",43,0)
 S D1=D1+1 S:'($D(^PSRX(DA,"A",0))#2) ^(0)="^52.3DA^^^" S ^(0)=$P(^(0),"^",1,2)_"^"_D1_"^"_K
"RTN","PSORXED",44,0)
 S ^PSRX(DA,"A",D1,0)=DT_"^E^"_$G(DUZ)_"^0^"_COM
"RTN","PSORXED",45,0)
 I QTY,$P(^PSRX(DA,2),"^",13) S ^PSDRUG($P(^PSRX(DA,0),"^",6),660.1)=$S($D(^PSDRUG(+$P(^PSRX(DA,0),"^",6),660.1)):^(660.1)+QTY,1:QTY)
"RTN","PSORXED",46,0)
 S:$P(RX0,"^",6)'=$P(^PSRX(DA,0),"^",6) ^PSDRUG(+$P(^PSRX(DA,0),"^",6),660.1)=$S($D(^PSDRUG(+$P(RX0,"^",6),660.1)):^(660.1)+$P(RX0,"^",7),1:$P(RX0,"^",7))
"RTN","PSORXED",47,0)
 S RX0=^PSRX(DA,0),RX2=^(2),J=DA,OEXDT=+$P(RX2,"^",6) D ^PSOEXDT S NEXDT=+$P(RX2,"^",6) I OEXDT'=NEXDT D
"RTN","PSORXED",48,0)
 .K ^PSRX("AG",OEXDT,DA) S ^PSRX("AG",NEXDT,DA)=""
"RTN","PSORXED",49,0)
 .S D=+$P(RX0,"^",2) K ^PS(55,D,"P","A",OEXDT,DA) S ^PS(55,D,"P","A",NEXDT,DA)=""
"RTN","PSORXED",50,0)
 K D,OEXDT,NEXDT
"RTN","PSORXED",51,0)
 G:+$P(^PSRX(J,"STA"),"^")!($G(PSOEDITL)=1) LOGX S RXFL(PSORXED("IRXN"))=$S($G(PSOEDITF):$G(PSOEDITF),1:0) I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSORXED("IRXN")_"," D SETRP G LOGX
"RTN","PSORXED",52,0)
 G:$G(PSOEDITL)=1 LOGX
"RTN","PSORXED",53,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORXED",54,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSORXED("IRXN"))<220 D  G LOGX
"RTN","PSORXED",55,0)
 .I PSORX("PSOL",PSOX2)'[PSORXED("IRXN")_"," S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSORXED("IRXN")_"," D SETRP
"RTN","PSORXED",56,0)
 E  I $G(PSORX("PSOL",PSOX2+1))'[PSORXED("IRXN")_"," S PSORX("PSOL",PSOX2+1)=PSORXED("IRXN")_"," D SETRP   ;;PSO*7*246
"RTN","PSORXED",57,0)
LOGX K PSOEDITF,PSOEDITR,PSOEDITL D:$G(RFED) ^PSORXED1
"RTN","PSORXED",58,0)
 Q
"RTN","PSORXED",59,0)
POST ; D NEXT D:$G(^PSRX(PSORXED("IRXN"),"IB"))]"" COPAY K PSODAYS,PSORXST
"RTN","PSORXED",60,0)
 D NEXT D COPAY K PSODAYS,PSORXST
"RTN","PSORXED",61,0)
 Q
"RTN","PSORXED",62,0)
COPAY S DA=PSORXED("IRXN") I 'RFD,PSODAYS'=+$P(^PSRX(DA,0),"^",8) I +$G(^PSRX(DA,"IB"))!($P($G(^PSRX(DA,"PFS")),"^",2)) D CPCK G RXST
"RTN","PSORXED",63,0)
 I RFD,+$G(^PSRX(DA,1,RFD,0)),PSODAYS'=$P($G(^PSRX(DA,1,RFD,0)),"^",10) I +$G(^PSRX(DA,"IB"))!($P($G(^PSRX(DA,1,RFD,"PFS")),"^",2)) D CPCK
"RTN","PSORXED",64,0)
RXST G:PSORXST=+$P($G(^PS(53,+$P(^PSRX(DA,0),"^",3),0)),"^",7) COPAYX
"RTN","PSORXED",65,0)
 W !,$C(7),"Patient Status field for this Rx has been changed from a ",$S(PSORXST=0:"COPAYMENT ELIGIBLE",PSORXST=1:"COPAYMENT EXEMPT",1:"")
"RTN","PSORXED",66,0)
 W !,"patient status."
"RTN","PSORXED",67,0)
 W "  The copay status for this Rx will be automatically adjusted."
"RTN","PSORXED",68,0)
 W !,"If action needs to be taken to adjust charges you MUST use the"
"RTN","PSORXED",69,0)
 W !,"Reset Copay Status/Cancel Charges option."
"RTN","PSORXED",70,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSORXED",71,0)
 I +$P($G(^PS(53,+$P(^PSRX(DA,0),"^",3),0)),"^",7)=1 D  ; SET TO NO COPAY AND AUDIT CHANGE
"RTN","PSORXED",72,0)
 . I '$D(^PSRX(DA,"IB")) S ^PSRX(DA,"IB")=""
"RTN","PSORXED",73,0)
 . S $P(^PSRX(DA,"IB"),"^",1)=""
"RTN","PSORXED",74,0)
 . S PSODA=DA
"RTN","PSORXED",75,0)
 . S PSOREF=RFD
"RTN","PSORXED",76,0)
 . S PSOCOMM="Rx Patient Status Change"
"RTN","PSORXED",77,0)
 . S PSOOLD="Copay"
"RTN","PSORXED",78,0)
 . S PSONW="No Copay"
"RTN","PSORXED",79,0)
 . S PREA="R"
"RTN","PSORXED",80,0)
 . D ACTLOG^PSOCPA
"RTN","PSORXED",81,0)
COPAYX K DA,PSODAYS,PSO,PSODA,PSOFLAG,PSORXST,RFD,PSOREF,PSOCOMM,PSOOLD,PSONW
"RTN","PSORXED",82,0)
 Q
"RTN","PSORXED",83,0)
CPCK ;update COPAY
"RTN","PSORXED",84,0)
 I 'RFD,'$D(^PSRX(DA,"PFS")) G CPCK1
"RTN","PSORXED",85,0)
 I RFD,'$D(^PSRX(DA,1,RFD,"PFS")) G CPCK1
"RTN","PSORXED",86,0)
 N PSOPFS S PSOPFS=$P($S('RFD:^PSRX(DA,"PFS"),1:^PSRX(DA,1,RFD,"PFS")),"^",1,2)
"RTN","PSORXED",87,0)
 I +$G(PSOPFS)>0&('$P($G(PSOPFS),"^",2)) K PSOPFS Q
"RTN","PSORXED",88,0)
 I +$G(PSOPFS)<1 K PSOPFS
"RTN","PSORXED",89,0)
 E  S PSOPFS="1^"_PSOPFS
"RTN","PSORXED",90,0)
CPCK1 N TYPE S PSO=2,PSODA=DA,PSOFLAG=1,PSOPAR7=$G(^PS(59,PSOSITE,"IB")),TYPE=RFD D RXED^PSOCPA K TYPE
"RTN","PSORXED",91,0)
 Q
"RTN","PSORXED",92,0)
NEXT D NEXT^PSOUTIL(.PSORXED) K DIE,DR,DA S DIE="^PSRX(",DA=PSORXED("IRXN")
"RTN","PSORXED",93,0)
 S DR="101///"_$P(PSORXED("RX3"),"^")_";102///"_$P(PSORXED("RX3"),"^",2) D ^DIE K DIE,DR,DA,X,Y
"RTN","PSORXED",94,0)
 Q
"RTN","PSORXED",95,0)
EOJ K PSOSIG,PSORXED,PSOLIST,END,PSRX0
"RTN","PSORXED",96,0)
 D EX^PSORXED1
"RTN","PSORXED",97,0)
 Q
"RTN","PSORXED",98,0)
FILL ;
"RTN","PSORXED",99,0)
 K PSOEDITF,PSOEDITR,PSOERF
"RTN","PSORXED",100,0)
 F PSOEZ=0:0 S PSOEZ=$O(^PSRX(DA,1,PSOEZ)) Q:'PSOEZ  S:$D(^PSRX(DA,1,PSOEZ,0)) PSOERF=PSOEZ
"RTN","PSORXED",101,0)
 S PSOEDITF=$S($G(PSOERF):+$G(PSOERF),1:0)
"RTN","PSORXED",102,0)
 I PSOEDITF S PSOEDITR=$S($P($G(^PSRX(DA,1,PSOEDITF,0)),"^",18):1,1:0) G FILLX
"RTN","PSORXED",103,0)
 S PSOEDITR=$S($P($G(^PSRX(DA,2)),"^",13):1,1:0)
"RTN","PSORXED",104,0)
FILLX K PSOERF,PSOEZ
"RTN","PSORXED",105,0)
 Q
"RTN","PSORXED",106,0)
LBL ;
"RTN","PSORXED",107,0)
 S PSOEDITL=0
"RTN","PSORXED",108,0)
 I COM["PROV"!(COM["QTY")!(COM["DAYS")!(COM["MAIL")!(COM["UNIT")!(COM["FILL DATE")!(COM["REMARKS") I COM'["STATUS",COM'["CLINIC",COM'["DRUG",COM'["REFILLS",COM'["ISSUE",COM'["SIG",COM'["TRADE" D  Q
"RTN","PSORXED",109,0)
 .I $G(PSOEDITF) S PSOEDITL=1 Q
"RTN","PSORXED",110,0)
 .I '$G(PSOEDITF),$G(PSOEDITR) S PSOEDITL=2
"RTN","PSORXED",111,0)
 I '$G(PSOEDITF),$G(PSOEDITR) S PSOEDITL=2 Q
"RTN","PSORXED",112,0)
 I '$G(PSOEDITF),'$G(PSOEDITR) S PSOEDITL=0 Q
"RTN","PSORXED",113,0)
 I $G(RXRP(DA)) S PSOEDITL=1 Q
"RTN","PSORXED",114,0)
 I '$G(RXRP(DA)),$G(PSOEDITR) S PSOEDITL=2 Q
"RTN","PSORXED",115,0)
 S PSOEDITL=0
"RTN","PSORXED",116,0)
 Q
"RTN","PSORXED",117,0)
ASKL ;
"RTN","PSORXED",118,0)
 W ! K DIR S DIR("?",1)="You have edited a fill that has already been released. Do you want to",DIR("?",2)="include this prescription as one of the prescriptions to be acted upon",DIR("?",3)="at the label prompt."
"RTN","PSORXED",119,0)
 S DIR("?")="Enter 'Yes' to generate a reprint label request."
"RTN","PSORXED",120,0)
 S DIR(0)="Y",DIR("A")="The last fill has been released, do you want a reprint label",DIR("B")="Y" D ^DIR K DIR I Y=1 S PSOEDITL=0 Q
"RTN","PSORXED",121,0)
 S PSOEDITL=1
"RTN","PSORXED",122,0)
 Q
"RTN","PSORXED",123,0)
SETRP I $P($G(^PSRX(PSORXED("IRXN"),"STA")),"^")'=5,$G(PSOEDITL)=0 S RXRP(PSORXED("IRXN"))="1^^^1",VALMSG="Label will reprint due to Edit"
"RTN","PSORXED",124,0)
 Q
"VER")
8.0^22.0
"BLD",6958,6)
^255
**END**
**END**

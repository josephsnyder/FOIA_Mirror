Released PSO*7*305 SEQ #275
Extracted from mail message
**KIDS**:PSO*7.0*305^

**INSTALL NAME**
PSO*7.0*305
"BLD",6627,0)
PSO*7.0*305^OUTPATIENT PHARMACY^0^3090406^y
"BLD",6627,1,0)
^^81^81^3090114^
"BLD",6627,1,1,0)
The FY08 Q4 Enhancement Release includes the following enhancements.
"BLD",6627,1,2,0)
 
"BLD",6627,1,3,0)
1. Automate Computerized Patient Record System V. 1.0 (CPRS) Refill
"BLD",6627,1,4,0)
   Processing.
"BLD",6627,1,5,0)
2. Display of both the Fill Date and the Release Date.
"BLD",6627,1,6,0)
3. Duplicate Drugs Message Enhancements.
"BLD",6627,1,7,0)
4. Notice of Privacy Practice Reminder on Laser Labels.
"BLD",6627,1,8,0)
 
"BLD",6627,1,9,0)
***** NOTE TO SITES USING AUTOMATED FILLING EQUIPMENT *****
"BLD",6627,1,10,0)
This patch adds a new NTE8 segment that has the VA Notice of Privacy
"BLD",6627,1,11,0)
Practices, IB 10-163 narrative to the content of the laser labels print
"BLD",6627,1,12,0)
stream.  If you are using automated dispensing equipment that relies on
"BLD",6627,1,13,0)
the data stream sent to the laser labels port, you have to contact your
"BLD",6627,1,14,0)
vendor to make adjustments to the trailer page as defined in item #4
"BLD",6627,1,15,0)
below.
"BLD",6627,1,16,0)
 
"BLD",6627,1,17,0)
1. Automate CPRS Refill Processing
"BLD",6627,1,18,0)
==================================
"BLD",6627,1,19,0)
This patch provides functionality to automatically process refills placed
"BLD",6627,1,20,0)
by the provider via CPRS.  A new system parameter, AUTOMATE CPRS REFILLS
"BLD",6627,1,21,0)
field (#40.16), has been added to the PHARMACY SYSTEM file (#59.7) by the
"BLD",6627,1,22,0)
Pharmacy Data Management V. 1.0, patch PSS*1*137 to support this
"BLD",6627,1,23,0)
functionality.
"BLD",6627,1,24,0)
 
"BLD",6627,1,25,0)
Please refer to patch PSS*1*137 for more details.
"BLD",6627,1,26,0)
 
"BLD",6627,1,27,0)
The auto refill process will occur only if the new AUTOMATE CPRS REFILLS
"BLD",6627,1,28,0)
field (#40.16) of the PHARMACY SYSTEM file (#59.7) is set to YES and the
"BLD",6627,1,29,0)
security key, PSOAUTRF, has been assigned to at least one user; otherwise
"BLD",6627,1,30,0)
the current process will continue where the orders have to be finished
"BLD",6627,1,31,0)
manually. Orders processed automatically will have the refill date
"BLD",6627,1,32,0)
calculated by the refill process to the next possible fill date and the
"BLD",6627,1,33,0)
routing will be set to Mail.
"BLD",6627,1,34,0)
 
"BLD",6627,1,35,0)
During the auto refill process, if the criteria for refilling fails, then
"BLD",6627,1,36,0)
the order will not be processed but will be stored in the PENDING
"BLD",6627,1,37,0)
OUTPATIENT ORDERS file (#52.41) for manual processing. Also, a MailMan
"BLD",6627,1,38,0)
message, with the reason for not filling the auto refill, will be sent to
"BLD",6627,1,39,0)
holders of the PSOAUTRF security key. This should be very rare since CPRS
"BLD",6627,1,40,0)
will allow refills only if they are refillable.
"BLD",6627,1,41,0)
 
"BLD",6627,1,42,0)
2. Display of both the Fill Date and the Release Date
"BLD",6627,1,43,0)
=====================================================
"BLD",6627,1,44,0)
On the Patient Medication Profile screen, new functionality was
"BLD",6627,1,45,0)
implemented to allow users to have the option of viewing either the FILL
"BLD",6627,1,46,0)
DATE or the RELEASE DATE information. This is done by using a hidden
"BLD",6627,1,47,0)
ListMan action called RDD to invoke the RELEASE DATE display and will
"BLD",6627,1,48,0)
remain for that session. Using the RDD action again will display the FILL
"BLD",6627,1,49,0)
DATE.
"BLD",6627,1,50,0)
 
"BLD",6627,1,51,0)
3. Duplicate Drugs Message Enhancements
"BLD",6627,1,52,0)
=======================================
"BLD",6627,1,53,0)
This enhancement is related to patient safety issue PSI-07-236 and remedy
"BLD",6627,1,54,0)
ticket RT223633. When a duplicate drug message is displayed, the heading
"BLD",6627,1,55,0)
"CMOP Status" is currently shown for CMOP drugs only. This heading is
"BLD",6627,1,56,0)
being renamed to "Processing Status" and it will appear on every duplicate
"BLD",6627,1,57,0)
drug message along with the release status.
"BLD",6627,1,58,0)
 
"BLD",6627,1,59,0)
4. Notice of Privacy Practice Reminder on Laser Labels
"BLD",6627,1,60,0)
======================================================
"BLD",6627,1,61,0)
When the labels are printed for a patient's prescriptions, the
"BLD",6627,1,62,0)
following narrative will be printed on the trailer page in either English
"BLD",6627,1,63,0)
or Spanish, depending on the patient's language preference.
"BLD",6627,1,64,0)
 
"BLD",6627,1,65,0)
The English version reads as follows.
"BLD",6627,1,66,0)
 
"BLD",6627,1,67,0)
  The VA Notice of Privacy Practices, IB 10-163, which outlines your
"BLD",6627,1,68,0)
  privacy rights, is available online at http://www1.va.gov/Health/ or you
"BLD",6627,1,69,0)
  may obtain a copy by writing the VHA Privacy Office (19F2), 810 Vermont
"BLD",6627,1,70,0)
  Avenue NW, Washington DC 20420.
"BLD",6627,1,71,0)
 
"BLD",6627,1,72,0)
The Spanish language translation for the Privacy Notification reads as
"BLD",6627,1,73,0)
follows.
"BLD",6627,1,74,0)
 
"BLD",6627,1,75,0)
  La Notificacion relacionada con las Politicas de Privacidad del
"BLD",6627,1,76,0)
  Departamento de Asuntos del Veterano, IB-10-163, contiene los
"BLD",6627,1,77,0)
  detalles acerca de sus derechos de privacidad y esta disponible
"BLD",6627,1,78,0)
  electronicamente en la siguiente direccion:
"BLD",6627,1,79,0)
  http://www1.va.gov/Health/. Usted tambien puede conseguir una copia
"BLD",6627,1,80,0)
  escribiendo a la Oficina de Privacidad del Departamento de Asuntos de
"BLD",6627,1,81,0)
  Salud del Veterano, (19F2), 810 Vermont Avenue NW, Washington, DC 20420.
"BLD",6627,4,0)
^9.64PA^^
"BLD",6627,6)
^256
"BLD",6627,6.3)
8
"BLD",6627,"INID")
^
"BLD",6627,"INIT")

"BLD",6627,"KRN",0)
^9.67PA^8989.52^19
"BLD",6627,"KRN",.4,0)
.4
"BLD",6627,"KRN",.401,0)
.401
"BLD",6627,"KRN",.402,0)
.402
"BLD",6627,"KRN",.403,0)
.403
"BLD",6627,"KRN",.5,0)
.5
"BLD",6627,"KRN",.84,0)
.84
"BLD",6627,"KRN",3.6,0)
3.6
"BLD",6627,"KRN",3.8,0)
3.8
"BLD",6627,"KRN",9.2,0)
9.2
"BLD",6627,"KRN",9.8,0)
9.8
"BLD",6627,"KRN",9.8,"NM",0)
^9.68A^14^11
"BLD",6627,"KRN",9.8,"NM",1,0)
PSOLMUTL^^0^B11386551
"BLD",6627,"KRN",9.8,"NM",2,0)
PSOORUT1^^0^B71052534
"BLD",6627,"KRN",9.8,"NM",3,0)
PSOORUT2^^0^B65940792
"BLD",6627,"KRN",9.8,"NM",5,0)
PSODRDUP^^0^B46478362
"BLD",6627,"KRN",9.8,"NM",6,0)
PSOCPDUP^^0^B32857063
"BLD",6627,"KRN",9.8,"NM",7,0)
PSOHLNE2^^0^B64195087
"BLD",6627,"KRN",9.8,"NM",8,0)
PSOATRFC^^0^B44210974
"BLD",6627,"KRN",9.8,"NM",9,0)
PSOHLDS2^^0^B92029397
"BLD",6627,"KRN",9.8,"NM",12,0)
PSOLBLN2^^0^B37925640
"BLD",6627,"KRN",9.8,"NM",13,0)
PSOHLDS1^^0^B48838247
"BLD",6627,"KRN",9.8,"NM",14,0)
PSOLLL6^^0^B20102270
"BLD",6627,"KRN",9.8,"NM","B","PSOATRFC",8)

"BLD",6627,"KRN",9.8,"NM","B","PSOCPDUP",6)

"BLD",6627,"KRN",9.8,"NM","B","PSODRDUP",5)

"BLD",6627,"KRN",9.8,"NM","B","PSOHLDS1",13)

"BLD",6627,"KRN",9.8,"NM","B","PSOHLDS2",9)

"BLD",6627,"KRN",9.8,"NM","B","PSOHLNE2",7)

"BLD",6627,"KRN",9.8,"NM","B","PSOLBLN2",12)

"BLD",6627,"KRN",9.8,"NM","B","PSOLLL6",14)

"BLD",6627,"KRN",9.8,"NM","B","PSOLMUTL",1)

"BLD",6627,"KRN",9.8,"NM","B","PSOORUT1",2)

"BLD",6627,"KRN",9.8,"NM","B","PSOORUT2",3)

"BLD",6627,"KRN",19,0)
19
"BLD",6627,"KRN",19,"NM",0)
^9.68A^^
"BLD",6627,"KRN",19.1,0)
19.1
"BLD",6627,"KRN",101,0)
101
"BLD",6627,"KRN",101,"NM",0)
^9.68A^32^32
"BLD",6627,"KRN",101,"NM",1,0)
PSO FILL/RELEASE DATE DISPLAY^^0
"BLD",6627,"KRN",101,"NM",2,0)
PSO HIDDEN ACTIONS #2^^0
"BLD",6627,"KRN",101,"NM",3,0)
VALM NEXT SCREEN^^0
"BLD",6627,"KRN",101,"NM",4,0)
VALM PREVIOUS SCREEN^^0
"BLD",6627,"KRN",101,"NM",5,0)
VALM UP ONE LINE^^0
"BLD",6627,"KRN",101,"NM",6,0)
VALM DOWN A LINE^^0
"BLD",6627,"KRN",101,"NM",7,0)
VALM REFRESH^^0
"BLD",6627,"KRN",101,"NM",8,0)
VALM PRINT LIST^^0
"BLD",6627,"KRN",101,"NM",9,0)
VALM PRINT SCREEN^^0
"BLD",6627,"KRN",101,"NM",10,0)
VALM RIGHT^^0
"BLD",6627,"KRN",101,"NM",11,0)
VALM LEFT^^0
"BLD",6627,"KRN",101,"NM",12,0)
VALM SEARCH LIST^^0
"BLD",6627,"KRN",101,"NM",13,0)
VALM QUIT^^0
"BLD",6627,"KRN",101,"NM",14,0)
VALM LAST SCREEN^^0
"BLD",6627,"KRN",101,"NM",15,0)
VALM FIRST SCREEN^^0
"BLD",6627,"KRN",101,"NM",16,0)
VALM GOTO PAGE^^0
"BLD",6627,"KRN",101,"NM",17,0)
PSO SPEED RENEW^^0
"BLD",6627,"KRN",101,"NM",18,0)
PSO SPEED CANCEL^^0
"BLD",6627,"KRN",101,"NM",19,0)
PSO SPEED RELEASE^^0
"BLD",6627,"KRN",101,"NM",20,0)
PSO SPEED REPRINT^^0
"BLD",6627,"KRN",101,"NM",21,0)
PSO SPEED REFILL^^0
"BLD",6627,"KRN",101,"NM",22,0)
PSO SPEED PULL SUSPENSE^^0
"BLD",6627,"KRN",101,"NM",23,0)
PSO LM INPATIENT MEDICATION PROFILE^^0
"BLD",6627,"KRN",101,"NM",24,0)
VALM TURN ON/OFF MENUS^^0
"BLD",6627,"KRN",101,"NM",25,0)
PSO LM HIDDEN OTHER^^0
"BLD",6627,"KRN",101,"NM",26,0)
PSO SPEED SIG LOG REPRINT^^0
"BLD",6627,"KRN",101,"NM",27,0)
PSO LM QUEUE TO CMOP^^0
"BLD",6627,"KRN",101,"NM",28,0)
PSO LM PRINT MED INFO^^0
"BLD",6627,"KRN",101,"NM",29,0)
PSO LM DISPLAY ORDER STATUS^^0
"BLD",6627,"KRN",101,"NM",30,0)
PSO LM ACTION PROFILE^^0
"BLD",6627,"KRN",101,"NM",31,0)
PSO LM NON-VA MEDS RPT^^0
"BLD",6627,"KRN",101,"NM",32,0)
PSO LM MULTI-RX PRINT^^0
"BLD",6627,"KRN",101,"NM","B","PSO FILL/RELEASE DATE DISPLAY",1)

"BLD",6627,"KRN",101,"NM","B","PSO HIDDEN ACTIONS #2",2)

"BLD",6627,"KRN",101,"NM","B","PSO LM ACTION PROFILE",30)

"BLD",6627,"KRN",101,"NM","B","PSO LM DISPLAY ORDER STATUS",29)

"BLD",6627,"KRN",101,"NM","B","PSO LM HIDDEN OTHER",25)

"BLD",6627,"KRN",101,"NM","B","PSO LM INPATIENT MEDICATION PROFILE",23)

"BLD",6627,"KRN",101,"NM","B","PSO LM MULTI-RX PRINT",32)

"BLD",6627,"KRN",101,"NM","B","PSO LM NON-VA MEDS RPT",31)

"BLD",6627,"KRN",101,"NM","B","PSO LM PRINT MED INFO",28)

"BLD",6627,"KRN",101,"NM","B","PSO LM QUEUE TO CMOP",27)

"BLD",6627,"KRN",101,"NM","B","PSO SPEED CANCEL",18)

"BLD",6627,"KRN",101,"NM","B","PSO SPEED PULL SUSPENSE",22)

"BLD",6627,"KRN",101,"NM","B","PSO SPEED REFILL",21)

"BLD",6627,"KRN",101,"NM","B","PSO SPEED RELEASE",19)

"BLD",6627,"KRN",101,"NM","B","PSO SPEED RENEW",17)

"BLD",6627,"KRN",101,"NM","B","PSO SPEED REPRINT",20)

"BLD",6627,"KRN",101,"NM","B","PSO SPEED SIG LOG REPRINT",26)

"BLD",6627,"KRN",101,"NM","B","VALM DOWN A LINE",6)

"BLD",6627,"KRN",101,"NM","B","VALM FIRST SCREEN",15)

"BLD",6627,"KRN",101,"NM","B","VALM GOTO PAGE",16)

"BLD",6627,"KRN",101,"NM","B","VALM LAST SCREEN",14)

"BLD",6627,"KRN",101,"NM","B","VALM LEFT",11)

"BLD",6627,"KRN",101,"NM","B","VALM NEXT SCREEN",3)

"BLD",6627,"KRN",101,"NM","B","VALM PREVIOUS SCREEN",4)

"BLD",6627,"KRN",101,"NM","B","VALM PRINT LIST",8)

"BLD",6627,"KRN",101,"NM","B","VALM PRINT SCREEN",9)

"BLD",6627,"KRN",101,"NM","B","VALM QUIT",13)

"BLD",6627,"KRN",101,"NM","B","VALM REFRESH",7)

"BLD",6627,"KRN",101,"NM","B","VALM RIGHT",10)

"BLD",6627,"KRN",101,"NM","B","VALM SEARCH LIST",12)

"BLD",6627,"KRN",101,"NM","B","VALM TURN ON/OFF MENUS",24)

"BLD",6627,"KRN",101,"NM","B","VALM UP ONE LINE",5)

"BLD",6627,"KRN",409.61,0)
409.61
"BLD",6627,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",6627,"KRN",771,0)
771
"BLD",6627,"KRN",771,"NM",0)
^9.68A^^
"BLD",6627,"KRN",870,0)
870
"BLD",6627,"KRN",8989.51,0)
8989.51
"BLD",6627,"KRN",8989.52,0)
8989.52
"BLD",6627,"KRN",8994,0)
8994
"BLD",6627,"KRN","B",.4,.4)

"BLD",6627,"KRN","B",.401,.401)

"BLD",6627,"KRN","B",.402,.402)

"BLD",6627,"KRN","B",.403,.403)

"BLD",6627,"KRN","B",.5,.5)

"BLD",6627,"KRN","B",.84,.84)

"BLD",6627,"KRN","B",3.6,3.6)

"BLD",6627,"KRN","B",3.8,3.8)

"BLD",6627,"KRN","B",9.2,9.2)

"BLD",6627,"KRN","B",9.8,9.8)

"BLD",6627,"KRN","B",19,19)

"BLD",6627,"KRN","B",19.1,19.1)

"BLD",6627,"KRN","B",101,101)

"BLD",6627,"KRN","B",409.61,409.61)

"BLD",6627,"KRN","B",771,771)

"BLD",6627,"KRN","B",870,870)

"BLD",6627,"KRN","B",8989.51,8989.51)

"BLD",6627,"KRN","B",8989.52,8989.52)

"BLD",6627,"KRN","B",8994,8994)

"BLD",6627,"PRE")

"BLD",6627,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",6627,"QUES",0)
^9.62^^
"BLD",6627,"REQB",0)
^9.611^1^1
"BLD",6627,"REQB",1,0)
PSO*7.0*300^2
"BLD",6627,"REQB","B","PSO*7.0*300",1)

"KRN",101,1803,-1)
0^3
"KRN",101,1803,0)
VALM NEXT SCREEN^Next Screen^^A^^^^^^^^LIST MANAGER
"KRN",101,1803,1,0)
^^2^2^2920519^^^
"KRN",101,1803,1,1,0)
This action will allow the user to view the next screen
"KRN",101,1803,1,2,0)
of entries, if any exist.
"KRN",101,1803,2,0)
^101.02A^1^1
"KRN",101,1803,2,1,0)
NX
"KRN",101,1803,2,"B","NX",1)

"KRN",101,1803,15)

"KRN",101,1803,20)
D NEXT^VALM4
"KRN",101,1803,99)
61324,36642
"KRN",101,1804,-1)
0^4
"KRN",101,1804,0)
VALM PREVIOUS SCREEN^Previous Screen^^A^^^^^^^^LIST MANAGER
"KRN",101,1804,1,0)
^^2^2^2920113^^
"KRN",101,1804,1,1,0)
This action will allow the user to view the previous screen
"KRN",101,1804,1,2,0)
of entries, if any exist.
"KRN",101,1804,2,0)
^101.02A^3^2
"KRN",101,1804,2,1,0)
PR
"KRN",101,1804,2,2,0)
BK
"KRN",101,1804,2,3,0)
PR
"KRN",101,1804,2,"B","BK",2)

"KRN",101,1804,2,"B","PR",1)

"KRN",101,1804,2,"B","PR",3)

"KRN",101,1804,20)
D PREV^VALM4
"KRN",101,1804,99)
61324,36642
"KRN",101,1805,-1)
0^7
"KRN",101,1805,0)
VALM REFRESH^Re-Display Screen^^A^^^^^^^^LIST MANAGER
"KRN",101,1805,1,0)
^^1^1^2911024^
"KRN",101,1805,1,1,0)
This actions allows the user to re-display the current screen.
"KRN",101,1805,2,0)
^101.02A^1^1
"KRN",101,1805,2,1,0)
RE
"KRN",101,1805,2,"B","RE",1)

"KRN",101,1805,10,0)
^101.01PA^0^0
"KRN",101,1805,20)
D RE^VALM4
"KRN",101,1805,99)
61324,36642
"KRN",101,1806,-1)
0^14
"KRN",101,1806,0)
VALM LAST SCREEN^Last Screen^^A^^^^^^^^LIST MANAGER
"KRN",101,1806,1,0)
^^1^1^2911026^
"KRN",101,1806,1,1,0)
The action will display the last items.
"KRN",101,1806,20)
D LAST^VALM4
"KRN",101,1806,99)
61324,36642
"KRN",101,1807,-1)
0^15
"KRN",101,1807,0)
VALM FIRST SCREEN^First Screen^^A^^^^^^^^LIST MANAGER
"KRN",101,1807,1,0)
^^1^1^2960619^^
"KRN",101,1807,1,1,0)
This action will display the first screen.
"KRN",101,1807,15)

"KRN",101,1807,20)
D FIRST^VALM4
"KRN",101,1807,99)
61324,36643
"KRN",101,1808,-1)
0^5
"KRN",101,1808,0)
VALM UP ONE LINE^Up a Line^^A^^^^^^^^LIST MANAGER
"KRN",101,1808,1,0)
^^1^1^2911027^
"KRN",101,1808,1,1,0)
Move up a line
"KRN",101,1808,20)
D UP^VALM40
"KRN",101,1808,99)
61324,36643
"KRN",101,1809,-1)
0^6
"KRN",101,1809,0)
VALM DOWN A LINE^Down a Line^^A^^^^^^^^LIST MANAGER
"KRN",101,1809,1,0)
^^2^2^2950628^^
"KRN",101,1809,1,1,0)
Move down a line.
"KRN",101,1809,1,2,0)

"KRN",101,1809,3,0)
^101.03P^0^0
"KRN",101,1809,20)
D DOWN^VALM40
"KRN",101,1809,99)
61324,36643
"KRN",101,1811,-1)
0^13
"KRN",101,1811,0)
VALM QUIT^Quit^^A^^^^^^^^
"KRN",101,1811,.1)
 
"KRN",101,1811,1,0)
^^1^1^2911105^
"KRN",101,1811,1,1,0)
This protocol can be used as a generic 'quit' action.
"KRN",101,1811,2,0)
^101.02A^2^2
"KRN",101,1811,2,1,0)
EXIT
"KRN",101,1811,2,2,0)
QUIT
"KRN",101,1811,2,"B","EXIT",1)

"KRN",101,1811,2,"B","QUIT",2)

"KRN",101,1811,15)

"KRN",101,1811,20)
Q
"KRN",101,1811,99)
61324,36643
"KRN",101,1812,-1)
0^9
"KRN",101,1812,0)
VALM PRINT SCREEN^Print Screen^^A^^^^^^^^LIST MANAGER
"KRN",101,1812,1,0)
^^3^3^2920113^^
"KRN",101,1812,1,1,0)
This action allows the user to print the current List Manager
"KRN",101,1812,1,2,0)
display screen.  The header and the current portion of the
"KRN",101,1812,1,3,0)
list are printed.
"KRN",101,1812,20)
D PRT^VALM1
"KRN",101,1812,99)
61324,36643
"KRN",101,1813,-1)
0^8
"KRN",101,1813,0)
VALM PRINT LIST^Print List^^A^^^^^^^^LIST MANAGER
"KRN",101,1813,1,0)
^^2^2^2920113^
"KRN",101,1813,1,1,0)
This action allws the user to print the entire list of
"KRN",101,1813,1,2,0)
entries currently being displayed.
"KRN",101,1813,20)
D PRTL^VALM1
"KRN",101,1813,99)
61324,36643
"KRN",101,1815,-1)
0^24
"KRN",101,1815,0)
VALM TURN ON/OFF MENUS^Auto-Display(On/Off)^^A^^^^^^^^LIST MANAGER
"KRN",101,1815,20)
D MENU^VALM2
"KRN",101,1815,99)
61324,36643
"KRN",101,1817,-1)
0^12
"KRN",101,1817,0)
VALM SEARCH LIST^Search List^^A^^^^^^^^LIST MANAGER
"KRN",101,1817,1,0)
^^1^1^2920303^^
"KRN",101,1817,1,1,0)
Finds text in list of entries.
"KRN",101,1817,20)
D FIND^VALM40
"KRN",101,1817,99)
61324,36643
"KRN",101,1824,-1)
0^10
"KRN",101,1824,0)
VALM RIGHT^Shift View to Right^^A^^^^^^^^LIST MANAGER
"KRN",101,1824,20)
D RIGHT^VALM40(XQORNOD(0))
"KRN",101,1824,99)
61324,36643
"KRN",101,1825,-1)
0^11
"KRN",101,1825,0)
VALM LEFT^Shift View to Left^^A^^^^^^^^LIST MANAGER
"KRN",101,1825,20)
D LEFT^VALM40(XQORNOD(0))
"KRN",101,1825,99)
61324,36643
"KRN",101,1827,-1)
0^16
"KRN",101,1827,0)
VALM GOTO PAGE^Go to Page^^A^^^^^^^^LIST MANAGER
"KRN",101,1827,1,0)
^^1^1^2930113^
"KRN",101,1827,1,1,0)

"KRN",101,1827,20)
D GOTO^VALM40
"KRN",101,1827,99)
61324,36643
"KRN",101,3823,-1)
0^17
"KRN",101,3823,0)
PSO SPEED RENEW^Renew (OP)^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3823,20)
D ^PSORENW4
"KRN",101,3823,99)
61324,36643
"KRN",101,3824,-1)
0^2
"KRN",101,3824,0)
PSO HIDDEN ACTIONS #2^Outpatient Pharmacy Hidden Actions #2^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3824,1,0)
^101.06^1^1^3080520^^
"KRN",101,3824,1,1,0)
This hidden menu is attached to the OP medication profile.
"KRN",101,3824,4)
26^2
"KRN",101,3824,10,0)
^101.01PA^27^27
"KRN",101,3824,10,1,0)
1803^+^35^
"KRN",101,3824,10,1,"^")
VALM NEXT SCREEN
"KRN",101,3824,10,2,0)
1804^-^^
"KRN",101,3824,10,2,"^")
VALM PREVIOUS SCREEN
"KRN",101,3824,10,3,0)
1808^UP^^
"KRN",101,3824,10,3,"^")
VALM UP ONE LINE
"KRN",101,3824,10,4,0)
1809^DN^20^
"KRN",101,3824,10,4,"^")
VALM DOWN A LINE
"KRN",101,3824,10,5,0)
1805^RD^21^
"KRN",101,3824,10,5,"^")
VALM REFRESH
"KRN",101,3824,10,6,0)
1813^PT^22^
"KRN",101,3824,10,6,"^")
VALM PRINT LIST
"KRN",101,3824,10,7,0)
1812^PS^23^
"KRN",101,3824,10,7,"^")
VALM PRINT SCREEN
"KRN",101,3824,10,8,0)
1824^>^24^
"KRN",101,3824,10,8,"^")
VALM RIGHT
"KRN",101,3824,10,9,0)
1825^<^25^
"KRN",101,3824,10,9,"^")
VALM LEFT
"KRN",101,3824,10,10,0)
1817^SL^26^
"KRN",101,3824,10,10,"^")
VALM SEARCH LIST
"KRN",101,3824,10,11,0)
1811^QU^31^
"KRN",101,3824,10,11,"^")
VALM QUIT
"KRN",101,3824,10,12,0)
1806^LS^32^
"KRN",101,3824,10,12,"^")
VALM LAST SCREEN
"KRN",101,3824,10,13,0)
1807^FS^33^
"KRN",101,3824,10,13,"^")
VALM FIRST SCREEN
"KRN",101,3824,10,14,0)
1827^GO^34^
"KRN",101,3824,10,14,"^")
VALM GOTO PAGE
"KRN",101,3824,10,15,0)
3823^RN^11^
"KRN",101,3824,10,15,"^")
PSO SPEED RENEW
"KRN",101,3824,10,16,0)
3825^DC^12^
"KRN",101,3824,10,16,"^")
PSO SPEED CANCEL
"KRN",101,3824,10,17,0)
3826^RL^13^
"KRN",101,3824,10,17,"^")
PSO SPEED RELEASE
"KRN",101,3824,10,18,0)
3827^RP^10^
"KRN",101,3824,10,18,"^")
PSO SPEED REPRINT
"KRN",101,3824,10,19,0)
3830^RF^14^
"KRN",101,3824,10,19,"^")
PSO SPEED REFILL
"KRN",101,3824,10,20,0)
3833^PP^15^
"KRN",101,3824,10,20,"^")
PSO SPEED PULL SUSPENSE
"KRN",101,3824,10,21,0)
3838^IP^16^
"KRN",101,3824,10,21,"^")
PSO LM INPATIENT MEDICATION PROFILE
"KRN",101,3824,10,23,0)
1815^ADPL^^
"KRN",101,3824,10,23,"^")
VALM TURN ON/OFF MENUS
"KRN",101,3824,10,24,0)
3842^OTH^19^
"KRN",101,3824,10,24,"^")
PSO LM HIDDEN OTHER
"KRN",101,3824,10,25,0)
5614^RS^17^
"KRN",101,3824,10,25,"^")
PSO SPEED SIG LOG REPRINT
"KRN",101,3824,10,26,0)
5617^CM^18^
"KRN",101,3824,10,26,"^")
PSO LM QUEUE TO CMOP
"KRN",101,3824,10,27,0)
5663^RDD^27^
"KRN",101,3824,10,27,"^")
PSO FILL/RELEASE DATE DISPLAY
"KRN",101,3824,99)
61324,36643
"KRN",101,3825,-1)
0^18
"KRN",101,3825,0)
PSO SPEED CANCEL^Discontinue (OP)^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3825,20)
D ^PSOCAN4
"KRN",101,3825,99)
61324,36643
"KRN",101,3826,-1)
0^19
"KRN",101,3826,0)
PSO SPEED RELEASE^Release (OP)^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3826,20)
D ^PSODISP3
"KRN",101,3826,99)
61324,36643
"KRN",101,3827,-1)
0^20
"KRN",101,3827,0)
PSO SPEED REPRINT^Reprint (OP)^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3827,20)
D ^PSORXRP1
"KRN",101,3827,99)
61324,36643
"KRN",101,3830,-1)
0^21
"KRN",101,3830,0)
PSO SPEED REFILL^Refill (OP)^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3830,20)
D SPEED^PSOREF
"KRN",101,3830,99)
61324,36643
"KRN",101,3833,-1)
0^22
"KRN",101,3833,0)
PSO SPEED PULL SUSPENSE^Pull Rx (OP)^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3833,20)
D ^PSOSUPOE
"KRN",101,3833,99)
61324,36643
"KRN",101,3838,-1)
0^23
"KRN",101,3838,0)
PSO LM INPATIENT MEDICATION PROFILE^Inpat. Profile (OP)^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3838,10,0)
^101.01PA
"KRN",101,3838,15)
S VALMBCK="R"
"KRN",101,3838,20)
I $T(ENOR^PSJPR)]"" D FULL^VALM1,ENOR^PSJPR(PSODFN):'$G(PSOBEDT)
"KRN",101,3838,99)
61324,36643
"KRN",101,3841,-1)
0^28
"KRN",101,3841,0)
PSO LM PRINT MED INFO^Print Medication Instructions^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3841,15)
Q
"KRN",101,3841,20)
D PRMI^PSOHELP
"KRN",101,3841,99)
61049,30504
"KRN",101,3842,-1)
0^25
"KRN",101,3842,0)
PSO LM HIDDEN OTHER^Other OP Actions^^M^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3842,10,0)
^101.01PA^10^10
"KRN",101,3842,10,6,0)
3841^MI^10^
"KRN",101,3842,10,6,"^")
PSO LM PRINT MED INFO
"KRN",101,3842,10,7,0)
3845^DO^21^
"KRN",101,3842,10,7,"^")
PSO LM DISPLAY ORDER STATUS
"KRN",101,3842,10,8,0)
3846^AP^11^
"KRN",101,3842,10,8,"^")
PSO LM ACTION PROFILE
"KRN",101,3842,10,9,0)
5139^NV^^
"KRN",101,3842,10,9,"^")
PSO LM NON-VA MEDS RPT
"KRN",101,3842,10,10,0)
5326^MR^^
"KRN",101,3842,10,10,"^")
PSO LM MULTI-RX PRINT
"KRN",101,3842,15)
S VALMBCK="R"
"KRN",101,3842,99)
61457,35597
"KRN",101,3845,-1)
0^29
"KRN",101,3845,0)
PSO LM DISPLAY ORDER STATUS^Display Orders' Statuses^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3845,20)
D DPLYOR^PSOORUT3
"KRN",101,3845,99)
61049,30504
"KRN",101,3846,-1)
0^30
"KRN",101,3846,0)
PSO LM ACTION PROFILE^Action Profile (OP)^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,3846,15)
S VALMBCK="R"
"KRN",101,3846,20)
D FULL^VALM1 S DFN=PSODFN D LM^PSOSD1
"KRN",101,3846,99)
61049,30504
"KRN",101,5139,-1)
0^31
"KRN",101,5139,0)
PSO LM NON-VA MEDS RPT^Non-VA Meds Report^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,5139,15)
S VALMBCK="R"
"KRN",101,5139,20)
D FULL^VALM1 D HID^PSONVARP
"KRN",101,5139,99)
61049,30504
"KRN",101,5326,-1)
0^32
"KRN",101,5326,0)
PSO LM MULTI-RX PRINT^Multi-Rx Request Print^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,5326,15)
Q
"KRN",101,5326,20)
D QUEUE^PSOLLL7
"KRN",101,5326,99)
61049,30504
"KRN",101,5614,-1)
0^26
"KRN",101,5614,0)
PSO SPEED SIG LOG REPRINT^Reprint Sig Log^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,5614,2,0)
^101.02A^^0
"KRN",101,5614,20)
D ST^PSOLLLHN
"KRN",101,5614,99)
61324,36643
"KRN",101,5617,-1)
0^27
"KRN",101,5617,0)
PSO LM QUEUE TO CMOP^Manual Queue to CMOP^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,5617,20)
D CM^PSORESUS
"KRN",101,5617,99)
61324,36643
"KRN",101,5663,-1)
0^1
"KRN",101,5663,0)
PSO FILL/RELEASE DATE DISPLAY^Fill/Rel Date Disply^^A^^^^^^^^OUTPATIENT PHARMACY
"KRN",101,5663,2,0)
^101.02A^^0
"KRN",101,5663,10,0)
^101.01PA^^0
"KRN",101,5663,20)
D RFDSP^PSOLMUTL
"KRN",101,5663,99)
61324,36643
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
305^3090406^11863
"PKG",141,22,1,"PAH",1,1,0)
^^81^81^3090406
"PKG",141,22,1,"PAH",1,1,1,0)
The FY08 Q4 Enhancement Release includes the following enhancements.
"PKG",141,22,1,"PAH",1,1,2,0)
 
"PKG",141,22,1,"PAH",1,1,3,0)
1. Automate Computerized Patient Record System V. 1.0 (CPRS) Refill
"PKG",141,22,1,"PAH",1,1,4,0)
   Processing.
"PKG",141,22,1,"PAH",1,1,5,0)
2. Display of both the Fill Date and the Release Date.
"PKG",141,22,1,"PAH",1,1,6,0)
3. Duplicate Drugs Message Enhancements.
"PKG",141,22,1,"PAH",1,1,7,0)
4. Notice of Privacy Practice Reminder on Laser Labels.
"PKG",141,22,1,"PAH",1,1,8,0)
 
"PKG",141,22,1,"PAH",1,1,9,0)
***** NOTE TO SITES USING AUTOMATED FILLING EQUIPMENT *****
"PKG",141,22,1,"PAH",1,1,10,0)
This patch adds a new NTE8 segment that has the VA Notice of Privacy
"PKG",141,22,1,"PAH",1,1,11,0)
Practices, IB 10-163 narrative to the content of the laser labels print
"PKG",141,22,1,"PAH",1,1,12,0)
stream.  If you are using automated dispensing equipment that relies on
"PKG",141,22,1,"PAH",1,1,13,0)
the data stream sent to the laser labels port, you have to contact your
"PKG",141,22,1,"PAH",1,1,14,0)
vendor to make adjustments to the trailer page as defined in item #4
"PKG",141,22,1,"PAH",1,1,15,0)
below.
"PKG",141,22,1,"PAH",1,1,16,0)
 
"PKG",141,22,1,"PAH",1,1,17,0)
1. Automate CPRS Refill Processing
"PKG",141,22,1,"PAH",1,1,18,0)
==================================
"PKG",141,22,1,"PAH",1,1,19,0)
This patch provides functionality to automatically process refills placed
"PKG",141,22,1,"PAH",1,1,20,0)
by the provider via CPRS.  A new system parameter, AUTOMATE CPRS REFILLS
"PKG",141,22,1,"PAH",1,1,21,0)
field (#40.16), has been added to the PHARMACY SYSTEM file (#59.7) by the
"PKG",141,22,1,"PAH",1,1,22,0)
Pharmacy Data Management V. 1.0, patch PSS*1*137 to support this
"PKG",141,22,1,"PAH",1,1,23,0)
functionality.
"PKG",141,22,1,"PAH",1,1,24,0)
 
"PKG",141,22,1,"PAH",1,1,25,0)
Please refer to patch PSS*1*137 for more details.
"PKG",141,22,1,"PAH",1,1,26,0)
 
"PKG",141,22,1,"PAH",1,1,27,0)
The auto refill process will occur only if the new AUTOMATE CPRS REFILLS
"PKG",141,22,1,"PAH",1,1,28,0)
field (#40.16) of the PHARMACY SYSTEM file (#59.7) is set to YES and the
"PKG",141,22,1,"PAH",1,1,29,0)
security key, PSOAUTRF, has been assigned to at least one user; otherwise
"PKG",141,22,1,"PAH",1,1,30,0)
the current process will continue where the orders have to be finished
"PKG",141,22,1,"PAH",1,1,31,0)
manually. Orders processed automatically will have the refill date
"PKG",141,22,1,"PAH",1,1,32,0)
calculated by the refill process to the next possible fill date and the
"PKG",141,22,1,"PAH",1,1,33,0)
routing will be set to Mail.
"PKG",141,22,1,"PAH",1,1,34,0)
 
"PKG",141,22,1,"PAH",1,1,35,0)
During the auto refill process, if the criteria for refilling fails, then
"PKG",141,22,1,"PAH",1,1,36,0)
the order will not be processed but will be stored in the PENDING
"PKG",141,22,1,"PAH",1,1,37,0)
OUTPATIENT ORDERS file (#52.41) for manual processing. Also, a MailMan
"PKG",141,22,1,"PAH",1,1,38,0)
message, with the reason for not filling the auto refill, will be sent to
"PKG",141,22,1,"PAH",1,1,39,0)
holders of the PSOAUTRF security key. This should be very rare since CPRS
"PKG",141,22,1,"PAH",1,1,40,0)
will allow refills only if they are refillable.
"PKG",141,22,1,"PAH",1,1,41,0)
 
"PKG",141,22,1,"PAH",1,1,42,0)
2. Display of both the Fill Date and the Release Date
"PKG",141,22,1,"PAH",1,1,43,0)
=====================================================
"PKG",141,22,1,"PAH",1,1,44,0)
On the Patient Medication Profile screen, new functionality was
"PKG",141,22,1,"PAH",1,1,45,0)
implemented to allow users to have the option of viewing either the FILL
"PKG",141,22,1,"PAH",1,1,46,0)
DATE or the RELEASE DATE information. This is done by using a hidden
"PKG",141,22,1,"PAH",1,1,47,0)
ListMan action called RDD to invoke the RELEASE DATE display and will
"PKG",141,22,1,"PAH",1,1,48,0)
remain for that session. Using the RDD action again will display the FILL
"PKG",141,22,1,"PAH",1,1,49,0)
DATE.
"PKG",141,22,1,"PAH",1,1,50,0)
 
"PKG",141,22,1,"PAH",1,1,51,0)
3. Duplicate Drugs Message Enhancements
"PKG",141,22,1,"PAH",1,1,52,0)
=======================================
"PKG",141,22,1,"PAH",1,1,53,0)
This enhancement is related to patient safety issue PSI-07-236 and remedy
"PKG",141,22,1,"PAH",1,1,54,0)
ticket RT223633. When a duplicate drug message is displayed, the heading
"PKG",141,22,1,"PAH",1,1,55,0)
"CMOP Status" is currently shown for CMOP drugs only. This heading is
"PKG",141,22,1,"PAH",1,1,56,0)
being renamed to "Processing Status" and it will appear on every duplicate
"PKG",141,22,1,"PAH",1,1,57,0)
drug message along with the release status.
"PKG",141,22,1,"PAH",1,1,58,0)
 
"PKG",141,22,1,"PAH",1,1,59,0)
4. Notice of Privacy Practice Reminder on Laser Labels
"PKG",141,22,1,"PAH",1,1,60,0)
======================================================
"PKG",141,22,1,"PAH",1,1,61,0)
When the labels are printed for a patient's prescriptions, the
"PKG",141,22,1,"PAH",1,1,62,0)
following narrative will be printed on the trailer page in either English
"PKG",141,22,1,"PAH",1,1,63,0)
or Spanish, depending on the patient's language preference.
"PKG",141,22,1,"PAH",1,1,64,0)
 
"PKG",141,22,1,"PAH",1,1,65,0)
The English version reads as follows.
"PKG",141,22,1,"PAH",1,1,66,0)
 
"PKG",141,22,1,"PAH",1,1,67,0)
  The VA Notice of Privacy Practices, IB 10-163, which outlines your
"PKG",141,22,1,"PAH",1,1,68,0)
  privacy rights, is available online at http://www1.va.gov/Health/ or you
"PKG",141,22,1,"PAH",1,1,69,0)
  may obtain a copy by writing the VHA Privacy Office (19F2), 810 Vermont
"PKG",141,22,1,"PAH",1,1,70,0)
  Avenue NW, Washington DC 20420.
"PKG",141,22,1,"PAH",1,1,71,0)
 
"PKG",141,22,1,"PAH",1,1,72,0)
The Spanish language translation for the Privacy Notification reads as
"PKG",141,22,1,"PAH",1,1,73,0)
follows.
"PKG",141,22,1,"PAH",1,1,74,0)
 
"PKG",141,22,1,"PAH",1,1,75,0)
  La Notificacion relacionada con las Politicas de Privacidad del
"PKG",141,22,1,"PAH",1,1,76,0)
  Departamento de Asuntos del Veterano, IB-10-163, contiene los
"PKG",141,22,1,"PAH",1,1,77,0)
  detalles acerca de sus derechos de privacidad y esta disponible
"PKG",141,22,1,"PAH",1,1,78,0)
  electronicamente en la siguiente direccion:
"PKG",141,22,1,"PAH",1,1,79,0)
  http://www1.va.gov/Health/. Usted tambien puede conseguir una copia
"PKG",141,22,1,"PAH",1,1,80,0)
  escribiendo a la Oficina de Privacidad del Departamento de Asuntos de
"PKG",141,22,1,"PAH",1,1,81,0)
  Salud del Veterano, (19F2), 810 Vermont Avenue NW, Washington, DC 20420.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
11
"RTN","PSOATRFC")
0^8^B44210974^n/a
"RTN","PSOATRFC",1,0)
PSOATRFC ;BIR/MHA - Automate CPRS Refill request ;12/15/08 1:39pm
"RTN","PSOATRFC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**305**;DEC 1997;Build 8
"RTN","PSOATRFC",3,0)
 ;Reference to ^PSSLOCK supported by DBIA 2789
"RTN","PSOATRFC",4,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSOATRFC",5,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOATRFC",6,0)
 ;
"RTN","PSOATRFC",7,0)
REF(PSORXN,PSOITMG) ;process refill request
"RTN","PSOATRFC",8,0)
 N DFN,PSODFN,PSODTCUT,PSOITNS,PSOITDD,PSOITNF,PSOITF,DIV
"RTN","PSOATRFC",9,0)
 N PSOITP,PSOITR,PSOINST,PSOPAR,PSOPINST,PSOPRPAS,PSOPAR7,PSOPTPST
"RTN","PSOATRFC",10,0)
 N PSOSITE,PSOSNM,PSOSYS,PSORFN,PSOREA,PSOSTAT,PSOD,PSOS,DRG,DIVN
"RTN","PSOATRFC",11,0)
 N PSXSYS,RX,RX0,RXN,VA,ZZ,LC,XMY,PSORXN0,PSORXN2,PSORXN3,PSORXNS
"RTN","PSOATRFC",12,0)
 ;
"RTN","PSOATRFC",13,0)
 S (DIV,PSOSITE)=$P(^PSRX(PSORXN,2),"^",9)
"RTN","PSOATRFC",14,0)
 S (SITE,DA)=$P(^XMB(1,1,"XUS"),U,17),DIC="4",DIQ(0)="IE",DR=".01;99",DIQ="PSOUTIL" D EN^DIQ1
"RTN","PSOATRFC",15,0)
 S PSOINST=$G(PSOUTIL(4,SITE,99,"I"))
"RTN","PSOATRFC",16,0)
 S PSOPAR=$G(^PS(59,DIV,1)),PSORFN=$G(^PS(59,DIV,"RF")),PSOITNF=0
"RTN","PSOATRFC",17,0)
 S PSXSYS=+$O(^PSX(550,"C",""))_"^"_$G(PSOINST)_"^"_$G(PSOUTIL(4,SITE,.01,"E"))
"RTN","PSOATRFC",18,0)
 I $G(PSXSYS) D
"RTN","PSOATRFC",19,0)
 . K:($P($G(^PSX(550,+PSXSYS,0)),"^",2)'="A") PSXSYS
"RTN","PSOATRFC",20,0)
 . I $$VERSION^XPDUTL("PSO")<7.0 K PSXSYS
"RTN","PSOATRFC",21,0)
 S PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOATRFC",22,0)
 ;
"RTN","PSOATRFC",23,0)
 I '$D(^PSRX(PSORXN,0))!($P(^(0),U)="")!('$D(^(2)))!($P(^("STA"),U)=13) D  Q
"RTN","PSOATRFC",24,0)
 . D ERR("Rx IEN "_PSORXN_" not in file (#52)/Incomplete/Deleted")
"RTN","PSOATRFC",25,0)
 S PSORXN0=^PSRX(PSORXN,0),PSORXN2=^(2),PSORXN3=^(3),PSORXNS=^("STA")
"RTN","PSOATRFC",26,0)
 S (DFN,PSODFN)=$P(PSORXN0,U,2),RXN=$P(PSORXN0,U),DRG=$P(PSORXN0,U,6)
"RTN","PSOATRFC",27,0)
 D GET^PSOPTPST
"RTN","PSOATRFC",28,0)
 I $G(PSOPTPST(2,PSODFN,.351))]"" D  Q
"RTN","PSOATRFC",29,0)
 . D ERR("Patient Died on "_PSOPTPST(2,PSODFN,.351))
"RTN","PSOATRFC",30,0)
 D ICN^PSODPT(DFN)
"RTN","PSOATRFC",31,0)
 S PSOLOUD=1 D:$P($G(^PS(55,DFN,0)),U,6)'=2 EN^PSOHLUP(DFN) K PSOLOUD
"RTN","PSOATRFC",32,0)
 I '$P(PSOPAR,U,11),$G(^PSDRUG(DRG,"I"))]"",DT>$G(^("I")) D  Q
"RTN","PSOATRFC",33,0)
 . D ERR("Drug is inactive for Rx # "_RXN_" cannot be refilled")
"RTN","PSOATRFC",34,0)
 I $G(PSOPTPST(2,PSODFN,.1))]"",'PSORFN D  Q
"RTN","PSOATRFC",35,0)
 . D ERR("Patient is an Inpatient on Ward "_PSOPTPST(2,PSODFN,.1))
"RTN","PSOATRFC",36,0)
 I $G(PSOPTPST(2,PSODFN,148))="YES",'$P(PSORFN,U,2) D  Q
"RTN","PSOATRFC",37,0)
 . D ERR("Patient is in a Contract Nursing Home")
"RTN","PSOATRFC",38,0)
 D CHKRF Q:PSOITNF           ;Quit if RX not refillable
"RTN","PSOATRFC",39,0)
 ;
"RTN","PSOATRFC",40,0)
 ;more checks
"RTN","PSOATRFC",41,0)
 I $O(^PS(52.5,"B",PSORXN,0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSORXN,0)),"P")) D  Q
"RTN","PSOATRFC",42,0)
 . D ERR("Rx is in suspense and cannot be refilled")
"RTN","PSOATRFC",43,0)
 S PSOY=1+$$LSTRFL^PSOBPSU1(PSORXN)
"RTN","PSOATRFC",44,0)
 I PSOY>$P(PSORXN0,U,9) D  Q
"RTN","PSOATRFC",45,0)
 . D ERR("Can't refill, no refills remaining")
"RTN","PSOATRFC",46,0)
 S (PSOITF,PSOX("NUMBER"))=PSOY
"RTN","PSOATRFC",47,0)
 S PSOX("RX0")=PSORXN0,PSOX("RX2")=PSORXN2,PSOX("RX3")=PSORXN3,PSOX("STA")=PSORXNS
"RTN","PSOATRFC",48,0)
 S DRG=$P(PSORXN0,U,6)
"RTN","PSOATRFC",49,0)
 N PSODEA,PSODAY
"RTN","PSOATRFC",50,0)
 S PSODEA=$P($G(^PSDRUG(DRG,0)),U,3)
"RTN","PSOATRFC",51,0)
 S PSODAY=$P(PSORXN0,U,8)
"RTN","PSOATRFC",52,0)
 I $$DEACHK^PSOUTLA1(PSORXN,PSODEA,PSODAY) D  Q
"RTN","PSOATRFC",53,0)
 . D ERR("This drug has been changed, No refills allowed")
"RTN","PSOATRFC",54,0)
 D CHKDT Q:PSOITNF           ;Quit if not refillable
"RTN","PSOATRFC",55,0)
 ;
"RTN","PSOATRFC",56,0)
 ;ok to process refill
"RTN","PSOATRFC",57,0)
 D EN^PSOR52(.PSOX)
"RTN","PSOATRFC",58,0)
 ;add additional activity log comment to refill just added
"RTN","PSOATRFC",59,0)
 I PSOITF,$D(^PSRX(PSORXN,1,PSOITF,0)) D
"RTN","PSOATRFC",60,0)
 . N AL,DONE,PSOFDA
"RTN","PSOATRFC",61,0)
 . S AL="",DONE=0
"RTN","PSOATRFC",62,0)
 . F  S AL=$O(^PSRX(PSORXN,"A",AL),-1) Q:'AL  D  Q:DONE
"RTN","PSOATRFC",63,0)
 . . Q:$P(^PSRX(PSORXN,"A",AL,0),U,4)'=PSOITF
"RTN","PSOATRFC",64,0)
 . . S PSOFDA(52.34,"+3,"_AL_","_PSORXN_",",.01)="CPRS Auto Refill"
"RTN","PSOATRFC",65,0)
 . . D UPDATE^DIE("","PSOFDA")
"RTN","PSOATRFC",66,0)
 . . S DONE=1
"RTN","PSOATRFC",67,0)
 Q
"RTN","PSOATRFC",68,0)
 ;
"RTN","PSOATRFC",69,0)
CHKRF ;check precription if still refillable
"RTN","PSOATRFC",70,0)
 S X2=-120,X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSOATRFC",71,0)
 D ^PSOBUILD
"RTN","PSOATRFC",72,0)
 I '$G(PSOSD) D  Q
"RTN","PSOATRFC",73,0)
 .  D ERR("This patient has no prescriptions")
"RTN","PSOATRFC",74,0)
 S (PSOX,PSOY,PSOS)="",PSOX("STA")=PSORXNS
"RTN","PSOATRFC",75,0)
 F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""  D
"RTN","PSOATRFC",76,0)
 . I PSORXN=+PSOSD(PSOS,PSOX) S PSOY=PSOSD(PSOS,PSOX) I $P(PSOY,U,4)]"" D
"RTN","PSOATRFC",77,0)
 . . D ERR("Cannot refill Rx # "_RXN)
"RTN","PSOATRFC",78,0)
 . . S PSOREA=$P(PSOY,U,4),PSOSTAT=PSOX("STA")
"RTN","PSOATRFC",79,0)
 . . I PSOREA["Z" S:PSOSTAT=4 PSOSTAT=1 D  Q
"RTN","PSOATRFC",80,0)
 . . . S PSOA=";"_PSOSTAT,PSOB=$P(^DD(52,100,0),U,3)
"RTN","PSOATRFC",81,0)
 . . . S PSOA=$F(PSOB,PSOA),PSOA=$P($E(PSOB,PSOA,999),";",1)
"RTN","PSOATRFC",82,0)
 . . . D ERR(" Rx is in "_$P(PSOA,":",2)_" status")
"RTN","PSOATRFC",83,0)
 . . . K PSOA,PSOB
"RTN","PSOATRFC",84,0)
 . . I PSOREA["M" D ERR("Drug no longer used by Outpatient Pharmacy") Q
"RTN","PSOATRFC",85,0)
 . . I PSOREA["B" D ERR("Narcotic Drug") Q
"RTN","PSOATRFC",86,0)
 . . I PSOREA["C" D ERR("Non-Renewable Drug") Q
"RTN","PSOATRFC",87,0)
 . . I PSOREA["D" D ERR("Non-Renewable Patient Status") Q
"RTN","PSOATRFC",88,0)
 . . I PSOREA["E" D ERR("Non-Verified Rx") Q
"RTN","PSOATRFC",89,0)
 . . I PSOREA["G",PSOREA'["B" D ERR("No more refills left")
"RTN","PSOATRFC",90,0)
 I PSOY="" D ERR("Cannot refill, Rx is DC/Exp. Later Rx may exist") D
"RTN","PSOATRFC",91,0)
 . S (PSOS,PSOX)="",PSOD=$P(^PSDRUG($P(PSORXN0,U,6),0),U)
"RTN","PSOATRFC",92,0)
 . N ZRX S ZRX=""
"RTN","PSOATRFC",93,0)
 . F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  D
"RTN","PSOATRFC",94,0)
 . . F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX=""  D
"RTN","PSOATRFC",95,0)
 . . . I PSOD=PSOX,+PSOSD(PSOS,PSOX) S ZRX=$P($G(^PSRX(+PSOSD(PSOS,PSOX),0)),U)
"RTN","PSOATRFC",96,0)
 . D ERR(ZRX)
"RTN","PSOATRFC",97,0)
 Q
"RTN","PSOATRFC",98,0)
 ;
"RTN","PSOATRFC",99,0)
CHKDT ;check date on this refill request
"RTN","PSOATRFC",100,0)
 N X1,X2
"RTN","PSOATRFC",101,0)
 S PSOX("IRXN")=PSORXN
"RTN","PSOATRFC",102,0)
 S PSOX("MAIL/WINDOW")="M",PSOX("FLD")=2,PSOX("QS")="S"
"RTN","PSOATRFC",103,0)
 S PSOX("FIELD")=0,(PSORX("FILL DATE"),PSOX("FILL DATE"))=DT,PSOX("FLD")=1,X1=DT,X2=-180
"RTN","PSOATRFC",104,0)
 D C^%DTC S PSOX("ISSUE DATE")=X,PSOX("CLERK CODE")=DUZ
"RTN","PSOATRFC",105,0)
 S PSOX("STOP DATE")=$P(PSORXN2,U,6) D NEXT
"RTN","PSOATRFC",106,0)
 I PSOX("FILL DATE")<$P(PSORXN3,U,2) D SUSDATE^PSOUTIL(.PSOX)
"RTN","PSOATRFC",107,0)
 I PSOX("FILL DATE")>PSOX("STOP DATE") D  Q
"RTN","PSOATRFC",108,0)
 . D ERR("Can't refill, Refill Date "_$$DSP(PSOX("FILL DATE")))
"RTN","PSOATRFC",109,0)
 . D ERR("is past Expiration Date "_$$DSP(PSOX("STOP DATE")))
"RTN","PSOATRFC",110,0)
 S PSOX("LAST REFILL DATE")=$P(PSORXN3,U,1)
"RTN","PSOATRFC",111,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")=PSOX("LAST REFILL DATE") D  Q
"RTN","PSOATRFC",112,0)
 . D ERR("Can't refill, Fill Date already exists for "_$$DSP(PSOX("FILL DATE")))
"RTN","PSOATRFC",113,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")<PSOX("LAST REFILL DATE") D  Q
"RTN","PSOATRFC",114,0)
 . D ERR("Can't refill, later Refill Date already exists for "_$$DSP(PSOX("LAST REFILL DATE")))
"RTN","PSOATRFC",115,0)
 Q
"RTN","PSOATRFC",116,0)
 ;
"RTN","PSOATRFC",117,0)
NEXT ;
"RTN","PSOATRFC",118,0)
 S PSOX1=$P(PSORXN2,U,2)
"RTN","PSOATRFC",119,0)
 I '$O(^PSRX(PSORXN,1,0)) D  Q
"RTN","PSOATRFC",120,0)
 . S $P(PSORXN3,U)=PSOX1,X1=PSOX1
"RTN","PSOATRFC",121,0)
 . S X2=$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",122,0)
 . D C^%DTC
"RTN","PSOATRFC",123,0)
 . S:'$P(PSORXN3,U,8) $P(PSORXN3,U,2)=X K X
"RTN","PSOATRFC",124,0)
 S PSOY2=0
"RTN","PSOATRFC",125,0)
 F PSOY=0:0 S PSOY=$O(^PSRX(PSORXN,1,PSOY)) Q:'PSOY  S PSOY1=PSOY,PSOY2=PSOY2+1
"RTN","PSOATRFC",126,0)
 S PSOY=^PSRX(PSORXN,1,PSOY1,0)
"RTN","PSOATRFC",127,0)
 S PSOX2=$P(PSOY,U)
"RTN","PSOATRFC",128,0)
 S $P(PSORXN3,U)=PSOX2,X1=PSOX2
"RTN","PSOATRFC",129,0)
 S X2=$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",130,0)
 D C^%DTC S PSOY3=X
"RTN","PSOATRFC",131,0)
 S X1=PSOX1,X2=(PSOY2+1)*$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",132,0)
 D C^%DTC S PSOY4=X
"RTN","PSOATRFC",133,0)
 S $P(PSORXN3,U,2)=$S(PSOY3<PSOY4:PSOY4,1:PSOY3)
"RTN","PSOATRFC",134,0)
 K X,X1,X2,PSOX1,PSOX2,PSOY,PSOY1,PSOY2,PSOY3,PSOY4
"RTN","PSOATRFC",135,0)
 Q
"RTN","PSOATRFC",136,0)
 ;
"RTN","PSOATRFC",137,0)
DSP(X) ;
"RTN","PSOATRFC",138,0)
 Q:'X ""
"RTN","PSOATRFC",139,0)
 Q $E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3)
"RTN","PSOATRFC",140,0)
 ;
"RTN","PSOATRFC",141,0)
ERR(TXT) ;Build error text array
"RTN","PSOATRFC",142,0)
 ;  add TXT to end of last line in array, if will fit, else
"RTN","PSOATRFC",143,0)
 ;     add it as a new last line and indented 3.
"RTN","PSOATRFC",144,0)
 ;  and set error flag
"RTN","PSOATRFC",145,0)
 N II S II=$O(PSOITMG(""),-1) S:'II II=1
"RTN","PSOATRFC",146,0)
 S PSOITNF=1
"RTN","PSOATRFC",147,0)
 I $L($G(PSOITMG(II)))+$L(TXT)>79 D
"RTN","PSOATRFC",148,0)
 . S PSOITMG(II+1)="   "_TXT
"RTN","PSOATRFC",149,0)
 E  D
"RTN","PSOATRFC",150,0)
 . S PSOITMG(II)=$G(PSOITMG(II))_" "_TXT
"RTN","PSOATRFC",151,0)
 Q
"RTN","PSOATRFC",152,0)
 ;
"RTN","PSOATRFC",153,0)
MAILMSG(DFN,RXN,ERRTXT) ;send alert via mailman msg to PSOAUTRF key holders
"RTN","PSOATRFC",154,0)
 N MDUZ,XMDUZ,XMTEXT,XMSUB,PTNAME,PTSSN,DIV,DIVN
"RTN","PSOATRFC",155,0)
 D DEM^VADPT
"RTN","PSOATRFC",156,0)
 S PTNAME=$P(VADM(1),"^"),PTSSN=$P($P(VADM(2),"^",2),"-",3) K VADM
"RTN","PSOATRFC",157,0)
 S DIV=$$RXSITE^PSOBPSUT(RXN,0),DIVN=$P($G(^PS(59,DIV,0)),"^")
"RTN","PSOATRFC",158,0)
 S MDUZ=0
"RTN","PSOATRFC",159,0)
 F  S MDUZ=$O(^XUSEC("PSOAUTRF",MDUZ)) Q:MDUZ'>0  S XMY(MDUZ)=""
"RTN","PSOATRFC",160,0)
 S XMDUZ=.5,XMSUB=DIVN_" CPRS AUTO REFILL - Not Processed List"
"RTN","PSOATRFC",161,0)
 S ERRTXT(.1)="CPRS requested an Outpatient refill, but not allowed for the below reason:"
"RTN","PSOATRFC",162,0)
 S ERRTXT(.2)=""
"RTN","PSOATRFC",163,0)
 S ERRTXT(.3)="   Patient: "_PTNAME_" ("_PTSSN_")"
"RTN","PSOATRFC",164,0)
 S ERRTXT(.4)="      Rx #: "_$$GET1^DIQ(52,RXN,.01)
"RTN","PSOATRFC",165,0)
 S ERRTXT(.5)="      Drug: "_$$GET1^DIQ(52,RXN,6)
"RTN","PSOATRFC",166,0)
 S ERRTXT(.6)=""
"RTN","PSOATRFC",167,0)
 S XMTEXT="ERRTXT(" N DIFROM
"RTN","PSOATRFC",168,0)
 D ^XMD
"RTN","PSOATRFC",169,0)
 Q
"RTN","PSOCPDUP")
0^6^B32857063^B32544518
"RTN","PSOCPDUP",1,0)
PSOCPDUP ;BIR/SAB - Dup drug and class checker for copy orders ;1/3/05 11:34am
"RTN","PSOCPDUP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,130,132,192,207,222,243,305**;DEC 1997;Build 8
"RTN","PSOCPDUP",3,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCPDUP",4,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOCPDUP",5,0)
 ;External references to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOCPDUP",6,0)
 S $P(PSONULN,"-",79)="-",(STA,DNM)=""
"RTN","PSOCPDUP",7,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  D  Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",8,0)
 .I STA="PENDING" D ^PSODRDU1 Q
"RTN","PSOCPDUP",9,0)
 .I STA="ZNONVA" D NVA^PSODRDU1 Q
"RTN","PSOCPDUP",10,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",11,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",12,0)
 ..I $P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",13,0)
 ..I '$P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",14,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",15,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") S PSOCPCLS=1 D CLS K PSOCPCLS
"RTN","PSOCPDUP",16,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSOCPDUP",17,0)
 D REMOTE
"RTN","PSOCPDUP",18,0)
EXIT D ^PSOBUILD K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSOCPDUP",19,0)
 Q
"RTN","PSOCPDUP",20,0)
DUP S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"DUPLICATE DRUG "_$P(DNM,"^")_" in Prescription: ",$P(^PSRX(+PSOSD(STA,DNM),0),"^")
"RTN","PSOCPDUP",21,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During Prescription Entry COPY - Duplicate Drug"
"RTN","PSOCPDUP",22,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),SIG=$P($G(^PSRX(RXREC,"SIG")),"^"),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSOCPDUP",23,0)
 W !!,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2 W ?40,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSOCPDUP",24,0)
 D PRSTAT^PSODRDUP(RXREC)
"RTN","PSOCPDUP",25,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSOCPDUP",26,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSOCPDUP",27,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSOCPDUP",28,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSOCPDUP",29,0)
 K BSIG,PSREV
"RTN","PSOCPDUP",30,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?40,$J("# of refills: ",24)_RFLS S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOCPDUP",31,0)
 W !,$J("Provider: ",24)_PHYS,?40,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSOCPDUP",32,0)
 S LSTFL=+^PSRX(RXREC,3) W !?40,$J("Last filled on: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3),!?40,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSOCPDUP",33,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" Q
"RTN","PSOCPDUP",34,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 Q
"RTN","PSOCPDUP",35,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR Q
"RTN","PSOCPDUP",36,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR Q
"RTN","PSOCPDUP",37,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) W !!,"Prescription "_$S(+$G(PSOSD(STA,DNM)):$P($G(^PSRX(+$G(PSOSD(STA,DNM)),0)),"^")_" ",1:"")_"is on Provider Hold, it cannot be discontinued.",! D  Q
"RTN","PSOCPDUP",38,0)
 .S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DUP
"RTN","PSOCPDUP",39,0)
 I $G(PSOCPCLS),$G(RXRECCOP) D PSOL^PSSLOCK(RXRECCOP) I '$G(PSOMSG) D  K PSOMSG,DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSOCPDUP",40,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2) Q
"RTN","PSOCPDUP",41,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECCOP,0)),"^")
"RTN","PSOCPDUP",42,0)
 K PSOMSG S DIR("A")="Discontinue Rx # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^"),DIR(0)="Y",DIR("?")="Enter Y to discontinue this Rx."
"RTN","PSOCPDUP",43,0)
 D ^DIR K DIR S DA=RXREC S ACT="Discontinued while entering new Rx"
"RTN","PSOCPDUP",44,0)
 I 'Y W $C(7)," -Prescription was not discontinued..." S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA="C" S:$G(DUP) PSORX("DFLG")=1 K DUP,CLS D  Q
"RTN","PSOCPDUP",45,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSOCPDUP",46,0)
 .D:$G(PSOCPCLS) ULRX
"RTN","PSOCPDUP",47,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSOCPDUP",48,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New Rx Entry - DUPLICATE RX"),REA="C"
"RTN","PSOCPDUP",49,0)
 W !!,"Duplicate "_$S($G(CLS):"Class",1:"Drug")_" will be discontinued after the acceptance of the new order.",!
"RTN","PSOCPDUP",50,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D"
"RTN","PSOCPDUP",51,0)
 K CLS,DUP,PSOCPCLS Q
"RTN","PSOCPDUP",52,0)
CLS K DUP S CLS=1,MSG="Discontinued During New Prescription Entry - Duplicate Class" W !,PSONULN
"RTN","PSOCPDUP",53,0)
 W !?5,$C(7),"*** SAME CLASS *** OF DRUG IN RX #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" FOR "_$P(DNM,"^"),!,"CLASS: "_PSODRUG("VA CLASS")
"RTN","PSOCPDUP",54,0)
 S CAN=$P(PSOSD(STA,DNM),"^",2)'<11!($P(PSOSD(STA,DNM),"^",2)=1) S (RXREC,RXRECCOP)=+PSOSD(STA,DNM) S PSOELSE=$P(PSOPAR,"^",10) I PSOELSE D DATA
"RTN","PSOCPDUP",55,0)
 I 'PSOELSE S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT
"RTN","PSOCPDUP",56,0)
 K PSOELSE,RXRECCOP Q
"RTN","PSOCPDUP",57,0)
ULRX ;
"RTN","PSOCPDUP",58,0)
 I '$G(RXRECCOP) Q
"RTN","PSOCPDUP",59,0)
 D PSOUL^PSSLOCK(RXRECCOP)
"RTN","PSOCPDUP",60,0)
 Q
"RTN","PSOCPDUP",61,0)
 ;
"RTN","PSOCPDUP",62,0)
REMOTE ;
"RTN","PSOCPDUP",63,0)
 Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",64,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOCPDUP",65,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOCPDUP",66,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSOCPDUP",67,0)
 W:$D(IOF) @IOF W !,"Now doing remote order checks. Please wait..."
"RTN","PSOCPDUP",68,0)
 D REMOTE^PSOORRDI(PSODFN,PSODRUG("IEN"))
"RTN","PSOCPDUP",69,0)
 I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOCPDUP",70,0)
 I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOCPDUP",71,0)
REMOTE2 ;
"RTN","PSOCPDUP",72,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSOCPDUP",73,0)
 Q
"RTN","PSOCPDUP",74,0)
 ;
"RTN","PSODRDUP")
0^5^B46478362^B40100457
"RTN","PSODRDUP",1,0)
PSODRDUP ;BIR/SAB - Dup drug class checker ;11/1/04 3:38pm
"RTN","PSODRDUP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,39,56,130,132,192,207,222,243,305**;DEC 1997;Build 8
"RTN","PSODRDUP",3,0)
 ;
"RTN","PSODRDUP",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODRDUP",5,0)
 S $P(PSONULN,"-",79)="-",(STA,DNM)="" K CLS
"RTN","PSODRDUP",6,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""!$G(PSORX("DFLG"))  I $P(PSOSD(STA,DNM),"^")'=$G(PSORENW("OIRXN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",7,0)
 .I STA="PENDING" D ^PSODRDU1 Q
"RTN","PSODRDUP",8,0)
 .I STA="ZNONVA" D NVA^PSODRDU1 Q
"RTN","PSODRDUP",9,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",10,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",11,0)
 ..I $P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",12,0)
 ..I '$P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",13,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",14,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") D CLS
"RTN","PSODRDUP",15,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSODRDUP",16,0)
 D REMOTE^PSOCPDUP
"RTN","PSODRDUP",17,0)
EXIT D ^PSOBUILD K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSODRDUP",18,0)
 Q
"RTN","PSODRDUP",19,0)
DUP S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"Duplicate Drug "_$P(DNM,"^")_" in Prescription: ",$P(^PSRX(+PSOSD(STA,DNM),0),"^")
"RTN","PSODRDUP",20,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Drug"
"RTN","PSODRDUP",21,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODRDUP",22,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODRDUP",23,0)
 W !!,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2 W ?40,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSODRDUP",24,0)
 S DA=RXREC D PRSTAT(DA)
"RTN","PSODRDUP",25,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODRDUP",26,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSODRDUP",27,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSODRDUP",28,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSODRDUP",29,0)
 K BSIG,PSREV
"RTN","PSODRDUP",30,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?40,$J("# of refills: ",24)_RFLS S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSODRDUP",31,0)
 W !,$J("Provider: ",24)_PHYS,?40,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSODRDUP",32,0)
 S LSTFL=+^PSRX(RXREC,3) W !?40,$J("Last filled on: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3),!?40,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSODRDUP",33,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODRDUP",34,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC Q
"RTN","PSODRDUP",35,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODRDUP",36,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODRDUP",37,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! K DUP,RXRECLOC S PSORX("DFLG")=1 Q
"RTN","PSODRDUP",38,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODRDUP",39,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODRDUP",40,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECLOC,0)),"^"),!
"RTN","PSODRDUP",41,0)
 K PSOMSG S DIR("A")=$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^"),DIR(0)="Y",DIR("?")="Enter Y to "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODRDUP",42,0)
 D ^DIR K DIR S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODRDUP",43,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODRDUP",44,0)
 I 'Y W $C(7)," -Prescription was not "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODRDUP",45,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP D ULRX K RXRECLOC
"RTN","PSODRDUP",46,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODRDUP",47,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSODRDUP",48,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C")
"RTN","PSODRDUP",49,0)
 W !!,"Duplicate "_$S($G(CLS):"Class",1:"Drug")_" will be discontinued after the acceptance of the new order.",!
"RTN","PSODRDUP",50,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D"
"RTN","PSODRDUP",51,0)
 K RXRECLOC,DUP,CLS,PSONOOR Q
"RTN","PSODRDUP",52,0)
CLS K DUP
"RTN","PSODRDUP",53,0)
 I $E($G(PSODRUG("VA CLASS")),1,2)="HA",$E($P($G(PSOSD(STA,DNM)),"^",5),1,2)="HA" K PSOELSE Q
"RTN","PSODRDUP",54,0)
 S CLS=1,MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Class" W !,PSONULN
"RTN","PSODRDUP",55,0)
 W !?5,$C(7),"*** SAME CLASS *** OF DRUG IN RX #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" FOR "_$P(DNM,"^"),!,"CLASS: "_PSODRUG("VA CLASS")
"RTN","PSODRDUP",56,0)
 S CAN=$P(PSOSD(STA,DNM),"^",2)'<11!($P(PSOSD(STA,DNM),"^",2)=1) S RXREC=+PSOSD(STA,DNM) I $P($G(PSOPAR),"^",10) D DATA Q
"RTN","PSODRDUP",57,0)
 E  W !,PSONULN K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT
"RTN","PSODRDUP",58,0)
 K PSOELSE Q
"RTN","PSODRDUP",59,0)
ULRX ;
"RTN","PSODRDUP",60,0)
 I '$G(RXRECLOC) Q
"RTN","PSODRDUP",61,0)
 D PSOUL^PSSLOCK(RXRECLOC)
"RTN","PSODRDUP",62,0)
 Q
"RTN","PSODRDUP",63,0)
 ;
"RTN","PSODRDUP",64,0)
PRSTAT(DA) ;Displays the prescription's status
"RTN","PSODRDUP",65,0)
 N PSOTRANS,PSOREL,CMOP,RXPSTA,PSOX,RFLZRO,PSOLRD,PSORTS
"RTN","PSODRDUP",66,0)
 S RXPSTA="Processing Status: ",PSOLRD=$P($G(^PSRX(RXREC,2)),"^",13)
"RTN","PSODRDUP",67,0)
 D ^PSOCMOPA I $G(PSOCMOP)]"" D  K CMOP,PSOTRANS,PSOREL
"RTN","PSODRDUP",68,0)
 .S PSOTRANS=$E($P(PSOCMOP,"^",2),4,5)_"/"_$E($P(PSOCMOP,"^",2),6,7)_"/"_$E($P(PSOCMOP,"^",2),2,3)
"RTN","PSODRDUP",69,0)
 .S PSOREL=$S(CMOP("L")=0:$P($G(^PSRX(DA,2)),"^",13),1:$P(^PSRX(DA,1,CMOP("L"),0),"^",18))
"RTN","PSODRDUP",70,0)
 .S PSOREL=$E(PSOREL,4,5)_"/"_$E(PSOREL,6,7)_"/"_$E(PSOREL,2,3)_"@"_$E($P(PSOREL,".",2),1,4)
"RTN","PSODRDUP",71,0)
 .W !,$J(RXPSTA,24)_$S($P(PSOCMOP,"^")=0!($P(PSOCMOP,"^")=2):"Transmitted to CMOP on "_PSOTRANS,$P(PSOCMOP,"^")=1:"Released by CMOP on "_PSOREL,1:"Not Dispensed")
"RTN","PSODRDUP",72,0)
 I $G(PSOCMOP)']"" D
"RTN","PSODRDUP",73,0)
 .F PSOX=0:0 S PSOX=$O(^PSRX(RXREC,1,PSOX)) Q:'PSOX  D
"RTN","PSODRDUP",74,0)
 ..S RFLZRO=$G(^PSRX(RXREC,1,PSOX,0))
"RTN","PSODRDUP",75,0)
 ..S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R",PSORTS=$P(RFLZRO,"^",16)
"RTN","PSODRDUP",76,0)
 .I '$O(^PSRX(RXREC,1,0)),$P(^PSRX(RXREC,2),"^",15) S PSOLRD=PSOLRD_"^R",PSORTS=$P(^PSRX(RXREC,2),"^",15)
"RTN","PSODRDUP",77,0)
 .W !,$J(RXPSTA,24) I +$G(PSORTS) W "Returned to stock on "_$$FMTE^XLFDT(PSORTS,2) Q
"RTN","PSODRDUP",78,0)
 .W $S(PSOLRD="":"Not released locally",1:"Released locally on "_$$FMTE^XLFDT($P(PSOLRD,"^"),2)_" "_$P(PSOLRD,"^",2))_$S($P(^PSRX(RXREC,0),"^",11)="W":" (Window)",1:" (Mail)")
"RTN","PSODRDUP",79,0)
 Q
"RTN","PSOHLDS1")
0^13^B48838247^B48302679
"RTN","PSOHLDS1",1,0)
PSOHLDS1 ;BIR/LC,PWC-Build HL7 Segments for Automated Interface ; 7/25/08 1:28pm
"RTN","PSOHLDS1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,232,255,200,305**;DEC 1997;Build 8
"RTN","PSOHLDS1",3,0)
 ;HLFNC       supp. by DBIA 10106
"RTN","PSOHLDS1",4,0)
 ;PSNAPIS     supp. by DBIA 2531
"RTN","PSOHLDS1",5,0)
 ;VASITE      supp. by DBIA 10112
"RTN","PSOHLDS1",6,0)
 ;VADPT       supp. by DBIA 10061
"RTN","PSOHLDS1",7,0)
 ;EN^DIQ1     supp. by DBIA 100
"RTN","PSOHLDS1",8,0)
 ;EN^VAFHLZTA supp. by DBIA 758
"RTN","PSOHLDS1",9,0)
 ;PSDRUG      supp. by DBIA 221
"RTN","PSOHLDS1",10,0)
 ;PS(50.607   supp. by DBIA 2221
"RTN","PSOHLDS1",11,0)
 ;PS(55       supp. by DBIA 2228
"RTN","PSOHLDS1",12,0)
 ;DPT         supp. by DBIA 3097
"RTN","PSOHLDS1",13,0)
 ;SC          supp. by DBIA 10040
"RTN","PSOHLDS1",14,0)
 ;VA(200      supp. by DBIA 10060
"RTN","PSOHLDS1",15,0)
 ;SCMSVUT5    supp. by DBIA 4347
"RTN","PSOHLDS1",16,0)
 ;BLDPID^VAFCQRY supp. by DBIA 3630
"RTN","PSOHLDS1",17,0)
 ;MAKEIT^VAFHLU  supp. by DBIA 4346
"RTN","PSOHLDS1",18,0)
 ;
"RTN","PSOHLDS1",19,0)
 ;*232 allow for Do Not Mail
"RTN","PSOHLDS1",20,0)
 ;*255 move NTEPMI to PSOHLDS4.  fix "MP" node test to '=""
"RTN","PSOHLDS1",21,0)
 ;*305 send  Notice of Privacy Practices in NTE8
"RTN","PSOHLDS1",22,0)
 ;
"RTN","PSOHLDS1",23,0)
START ;
"RTN","PSOHLDS1",24,0)
 D GETDATA
"RTN","PSOHLDS1",25,0)
 D PID(.PSI),PV1(.PSI),PV2(.PSI),IAM^PSOHLDS4(.PSI),ORC^PSOHLDS4(.PSI)
"RTN","PSOHLDS1",26,0)
 D NTE^PSOHLDS2,RXE^PSOHLDS2(.PSI),RXD^PSOHLDS2(.PSI)
"RTN","PSOHLDS1",27,0)
 D NTEPMI^PSOHLDS4(.PSI),NTE8^PSOHLDS2(.PSI),RXR^PSOHLDS2(.PSI)                ;*255
"RTN","PSOHLDS1",28,0)
 ; clean up data set by GETDATA
"RTN","PSOHLDS1",29,0)
 K EBY,EBY1,EFDT,EXDT,FDT,PVDR,PVDR1,CSINER,CSINER1,SITE,SITADD,SITPHN
"RTN","PSOHLDS1",30,0)
 K VPHARMID,VPHARM,DEAID,MW,QTY,DASPLY,OLAN,OTHLAN,PRIORDT,RFRM,NFLD,WARN
"RTN","PSOHLDS1",31,0)
 K PSOXN,PSOXN2,PSND1,PSND2,PRODUCT,PSOPROD,UNIT,VANAME,DISPDT,PSONDC
"RTN","PSOHLDS1",32,0)
 K DRUG
"RTN","PSOHLDS1",33,0)
 Q
"RTN","PSOHLDS1",34,0)
GETDATA ; this is the place to set all data needed for several segments
"RTN","PSOHLDS1",35,0)
 I $G(FP)="F"&('$G(FPN)) D    ;original
"RTN","PSOHLDS1",36,0)
 . S FDT=$P(^PSRX(IRXN,2),"^",2),VPHARMID=$P(^(2),"^",10),DISPDT=$P(^(2),"^",5),EXDT=$P(^(2),"^",6),PSONDC=$P(^(2),"^",7)
"RTN","PSOHLDS1",37,0)
 . S PVDR=$P(^PSRX(IRXN,0),"^",4),QTY=$P(^(0),"^",7),DASPLY=$P(^(0),"^",8),MW=$P(^(0),"^",11),EBY=$P(^(0),"^",16)
"RTN","PSOHLDS1",38,0)
 I $G(FP)="F"&($G(FPN)) D    ;refill
"RTN","PSOHLDS1",39,0)
 . S FDT=$P(^PSRX(IRXN,1,FPN,0),"^"),MW=$P(^(0),"^",2),QTY=$P(^(0),"^",4),DASPLY=$P(^(0),"^",10),DISPDT=$P(^(0),"^",19),EXDT=$S($P(^(0),"^",15):$P(^(0),"^",15),1:$P(^PSRX(IRXN,2),"^",6))
"RTN","PSOHLDS1",40,0)
 . S VPHARMID=$S($P(^PSRX(IRXN,1,FPN,0),"^",5)'="":$P(^(0),"^",5),1:$P(^PSRX(IRXN,2),"^",10))
"RTN","PSOHLDS1",41,0)
 . S EBY=$S($P(^PSRX(IRXN,1,FPN,0),"^",5):$P(^(0),"^",5),1:$P(^(0),"^",7)),PVDR=$P(^(0),"^",17),PSONDC=$S($P($G(^PSRX(IRXN,1,FPN,1)),"^",3):$P(^(1),"^",3),1:$P(^PSRX(IRXN,2),"^",7))
"RTN","PSOHLDS1",42,0)
 I $G(FP)="P"&($G(FPN)) D  ;partial
"RTN","PSOHLDS1",43,0)
 . S FDT=$P(^PSRX(IRXN,"P",FPN,0),"^"),MW=$P(^(0),"^",2),QTY=$P(^(0),"^",4),DASPLY=$P(^(0),"^",10),DISPDT=$P(^(0),"^",13),PVDR=$P(^(0),"^",17),EXDT=$P(^PSRX(IRXN,2),"^",6)
"RTN","PSOHLDS1",44,0)
 . S EBY=$S($P(^PSRX(IRXN,"P",FPN,0),"^",5):$P(^(0),"^",5),1:$P(^(0),"^",7)),VPHARMID=$S($P(^(0),"^",5)'="":$P(^(0),"^",5),1:$P(^PSRX(IRXN,2),"^",10)),PVDR=$P(^PSRX(IRXN,"P",FPN,0),"^",17)
"RTN","PSOHLDS1",45,0)
 . S PSONDC=$S($P(^PSRX(IRXN,"P",FPN,0),"^",12):$P(^(0),"^",12),1:$P(^PSRX(IRXN,2),"^",7))
"RTN","PSOHLDS1",46,0)
 S EFDT=$P(^PSRX(IRXN,2),"^",2) S:$G(EFDT) EFDT=$$HLDATE^HLFNC(EFDT,"DT")
"RTN","PSOHLDS1",47,0)
 S ISDT=$P(^PSRX(IRXN,0),"^",13) S:$G(ISDT) ISDT=$$HLDATE^HLFNC(ISDT,"DT")
"RTN","PSOHLDS1",48,0)
 S DEAID=$$GET1^DIQ(200,PVDR_",",53.2)
"RTN","PSOHLDS1",49,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=VPHARMID D ^DIC
"RTN","PSOHLDS1",50,0)
 S VPHARM=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",51,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=EBY D ^DIC
"RTN","PSOHLDS1",52,0)
 S EBY1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",53,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=PVDR D ^DIC
"RTN","PSOHLDS1",54,0)
 S PVDR1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",55,0)
 S PRIORDT=$P(^PSRX(IRXN,3),"^",4),PRIORDT=$$HLDATE^HLFNC(PRIORDT,"DT")
"RTN","PSOHLDS1",56,0)
 S FDT=$$HLDATE^HLFNC(FDT,"DT")
"RTN","PSOHLDS1",57,0)
 S:$G(DISPDT) DISPDT=$$HLDATE^HLFNC(DISPDT,"DT")
"RTN","PSOHLDS1",58,0)
 S:$G(EXDT) EXDT=$$HLDATE^HLFNC(EXDT,"DT")
"RTN","PSOHLDS1",59,0)
 S FIN=$P(^PSRX(IRXN,"OR1"),"^",5)
"RTN","PSOHLDS1",60,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=FIN D ^DIC
"RTN","PSOHLDS1",61,0)
 S FIN1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",62,0)
 S SITE=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOHLDS1",63,0)
 S PSZIP=$P(SITE,"^",5) S PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOHLDS1",64,0)
 S CLN=+$P(^PSRX(IRXN,0),"^",5),CLN1=$S($D(^SC(CLN,0)):$P(^(0),"^",1),1:"UNKNOWN")
"RTN","PSOHLDS1",65,0)
 S CSINER=$P(^PSRX(IRXN,3),"^",3)
"RTN","PSOHLDS1",66,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=CSINER D ^DIC
"RTN","PSOHLDS1",67,0)
 S CSINER1=$S(+Y:$$HLNAME^HLFNC($P(Y,"^",2)),1:"""""") K DIC,X,Y
"RTN","PSOHLDS1",68,0)
 D 6^VADPT
"RTN","PSOHLDS1",69,0)
 S X=$S($D(^PS(55,DFN,0)):^(0),1:""),CAP=$P(X,"^",2)
"RTN","PSOHLDS1",70,0)
 D MW(X,.MW,.MP)                                              ;PSO*232
"RTN","PSOHLDS1",71,0)
 I (($P(^PSRX(IRXN,"STA"),"^")>0)&($P(^("STA"),"^")'=2)&('$G(PSODBQ)))!'$G(^PSRX(IRXN,"IB")) S COPAY="NO COPAY"
"RTN","PSOHLDS1",72,0)
 E  S COPAY="COPAY"
"RTN","PSOHLDS1",73,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0)
"RTN","PSOHLDS1",74,0)
 S DATE=$$HLDATE^HLFNC(FDT) D NOW^%DTC S NOW=$$HLDATE^HLFNC(%,"TS")
"RTN","PSOHLDS1",75,0)
 S OLAN=$P($G(^PS(55,DFN,"LAN")),"^",2),OTLAN="N" I OLAN=2 S OTLAN="Y"
"RTN","PSOHLDS1",76,0)
 S CSUB1=$$GET1^DIQ(50,IDGN_",",3),CSUB="N" I $E(CSUB1,1)>1&($E(CSUB1,1)<6) S CSUB="Y"
"RTN","PSOHLDS1",77,0)
 S SCTALK=+$G(^PS(55,"ASTALK",$P(^PSRX(IRXN,0),"^",2)))
"RTN","PSOHLDS1",78,0)
 K DIC,DR,DIQ S DA=$P($$SITE^VASITE(),"^") I DA D
"RTN","PSOHLDS1",79,0)
 .K PSOINST S DIC=4,DIQ(0)="I",DR=99,DIQ="PSOINST" D EN^DIQ1
"RTN","PSOHLDS1",80,0)
 .S PSOINST=PSOINST(4,DA,99,"I") K DIC,DA,DR,DIQ,PSOINST(4)
"RTN","PSOHLDS1",81,0)
 S DRUG=$$ZZ^PSOSUTL(IRXN),DEA=$P(^PSDRUG(IDGN,0),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOHLDS1",82,0)
 S PSND1=$P($G(^PSDRUG(IDGN,"ND")),"^"),PSND2=$P($G(^("ND")),"^",2),PSND3=$P($G(^("ND")),"^",3)
"RTN","PSOHLDS1",83,0)
 K PSOXN,PSOXN2,PSOPROD
"RTN","PSOHLDS1",84,0)
 I PSND1,PSND3 D
"RTN","PSOHLDS1",85,0)
 .S PSOPROD=$$PROD2^PSNAPIS(PSND1,PSND3),VANAME=$P($G(PSOPROD),"^",1)
"RTN","PSOHLDS1",86,0)
 .I $T(^PSNAPIS)]"" S PSOXN=$$DFSU^PSNAPIS(PSND1,PSND3),UNIT=$P($G(PSOXN),"^",6) S PSOXN=$P($G(PSOXN),"^",5) S PSOXN2=$$PROD2^PSNAPIS(PSND1,PSND3) Q
"RTN","PSOHLDS1",87,0)
 .S PSOXN2=$G(^PSNDF(PSND1,5,PSND3,2))
"RTN","PSOHLDS1",88,0)
 .S PRODUCT=$G(^PSNDF(PSND1,5,PSND3,0))
"RTN","PSOHLDS1",89,0)
 .I $G(PRODUCT)'="" S PSOXN=+$P($G(^PSNDF(PSND1,2,+$P(PRODUCT,"^",2),3,+$P(PRODUCT,"^",3),4,+$P(PRODUCT,"^",4),0)),"^"),UNIT=$P($G(^PS(50.607,PSOXN,0)),"^")
"RTN","PSOHLDS1",90,0)
 S NFLD=0,UU="" F  S UU=$O(^PSRX(IRXN,1,UU)) Q:UU=""  S:$D(^PSRX(IRXN,1,UU,0)) NFLD=NFLD+1
"RTN","PSOHLDS1",91,0)
 S NRFL=$P(^PSRX(IRXN,0),"^",9),RFRM=(NRFL-NFLD)
"RTN","PSOHLDS1",92,0)
 Q
"RTN","PSOHLDS1",93,0)
PID(PSI) ;patient ID segment
"RTN","PSOHLDS1",94,0)
 Q:'$D(DFN)!$D(PAS)
"RTN","PSOHLDS1",95,0)
 S HLFS=HL1("FS"),HLECH=HL1("ECH"),HLQ=HL1("Q"),HLVER=HL1("VER")
"RTN","PSOHLDS1",96,0)
 K PSPID,PSPID1
"RTN","PSOHLDS1",97,0)
 D BLDPID^VAFCQRY(DFN,"","3,5,7,8,11,13",.PSPID,.HL1,.ERR)
"RTN","PSOHLDS1",98,0)
 ; put PID in format needed for segment parser
"RTN","PSOHLDS1",99,0)
 S PSPID=PSPID(1) K PSPID(1)
"RTN","PSOHLDS1",100,0)
 S (X,Y)=1 F  S X=+$O(PSPID(X)) Q:'X  S PSPID(Y)=PSPID(X),Y=Y+1 K PSPID(X)
"RTN","PSOHLDS1",101,0)
 ;parse PID into individual fields
"RTN","PSOHLDS1",102,0)
 K PRSEPID D SEGPRSE^SCMSVUT5("PSPID","PRSEPID",HL1("FS"))
"RTN","PSOHLDS1",103,0)
 ; parse address into individual components
"RTN","PSOHLDS1",104,0)
 K ADDSEQ D SEQPRSE^SCMSVUT5($NA(PRSEPID(11)),"ADDSEQ",HL1("ECH"))
"RTN","PSOHLDS1",105,0)
 ; build ZTA (Temporary Address)
"RTN","PSOHLDS1",106,0)
 K X2 S X2=$$EN^VAFHLZTA(DFN,"1,2,3,4,5,6,7,",1)
"RTN","PSOHLDS1",107,0)
 ; parse X2 (ZTA) into individual fields if temp add. exists
"RTN","PSOHLDS1",108,0)
 D:'$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOHLDS1",109,0)
 . N BADA S BADA=$$CHKRX^PSOBAI(IRXN)
"RTN","PSOHLDS1",110,0)
 . I $P(BADA,"^"),'$P(BADA,"^",2),ADDSEQ(1,7)'["VAB" S BADA=$$GET1^DIQ(2,DFN_",",.121,"I") S:BADA ADDSEQ(1,7)="VAB"_BADA
"RTN","PSOHLDS1",111,0)
 D:$$CHKTEMP^PSOBAI(DFN)
"RTN","PSOHLDS1",112,0)
 . K PRSEZTA D SEGPRSE^SCMSVUT5("X2","PRSEZTA",HL1("FS"))
"RTN","PSOHLDS1",113,0)
 . ; parse temporary address into individual components
"RTN","PSOHLDS1",114,0)
 . K TMPADD D SEQPRSE^SCMSVUT5($NA(PRSEZTA(5)),"TMPADD",HL1("ECH"))
"RTN","PSOHLDS1",115,0)
 . ; add temporary address as next repitition in PID segment
"RTN","PSOHLDS1",116,0)
 . S SPOT=1+$O(ADDSEQ(""),-1)
"RTN","PSOHLDS1",117,0)
 . M ADDSEQ(SPOT)=TMPADD(1)
"RTN","PSOHLDS1",118,0)
 . S ADDSEQ(SPOT,7)="C"
"RTN","PSOHLDS1",119,0)
 . S ADDSEQ(SPOT,9)=PRSEZTA(6)
"RTN","PSOHLDS1",120,0)
 . S ADDSEQ(SPOT,12,1)=PRSEZTA(3)
"RTN","PSOHLDS1",121,0)
 . S ADDSEQ(SPOT,12,2)=PRSEZTA(4)
"RTN","PSOHLDS1",122,0)
 . ;move address sequence back into parse PID segment
"RTN","PSOHLDS1",123,0)
 ; rebuild PID segment
"RTN","PSOHLDS1",124,0)
 K PRSEPID(11) M PRSEPID(11)=ADDSEQ
"RTN","PSOHLDS1",125,0)
 K PSPID1 D MAKEIT^VAFHLU("PID",.PRSEPID,.PSPID1,.PSPID1)
"RTN","PSOHLDS1",126,0)
 ;put rebuilt PID into format used by $$EN^VAFCQRY
"RTN","PSOHLDS1",127,0)
 K PSPID S PSPID(1)=PSPID1
"RTN","PSOHLDS1",128,0)
 S X=0,Y=2 F  S X=+$O(PSPID1(X)) Q:'X  S PSPID(Y)=PSPID1(X) S Y=Y+1
"RTN","PSOHLDS1",129,0)
 S CNT=0 F I=1:1 Q:'$D(PSPID(I))  D
"RTN","PSOHLDS1",130,0)
 . I I=1 S ^TMP("PSO",$J,PSI)=PSPID(I) Q
"RTN","PSOHLDS1",131,0)
 . S CNT=CNT+1 S ^TMP("PSO",$J,PSI,CNT)=PSPID(I)
"RTN","PSOHLDS1",132,0)
 S PSI=PSI+1
"RTN","PSOHLDS1",133,0)
 S PAS=1
"RTN","PSOHLDS1",134,0)
 K PSPID,PSPID1,PRSEPID,PRSEZTA,SPOT,TMPADD,ADDSEQ
"RTN","PSOHLDS1",135,0)
 Q
"RTN","PSOHLDS1",136,0)
PV1(PSI) ;patient visit segment
"RTN","PSOHLDS1",137,0)
 Q:'$D(DFN)!$D(PAS1)
"RTN","PSOHLDS1",138,0)
 N PV1  ;hardcoded to letter O for Outpatient (Patient class)
"RTN","PSOHLDS1",139,0)
 S PV1="PV1"_FS_FS_"O"_FS
"RTN","PSOHLDS1",140,0)
 S ^TMP("PSO",$J,PSI)=PV1
"RTN","PSOHLDS1",141,0)
 S PSI=PSI+1,PAS1=1
"RTN","PSOHLDS1",142,0)
 Q
"RTN","PSOHLDS1",143,0)
PV2(PSI) ;patient visit segment (additional information)
"RTN","PSOHLDS1",144,0)
 ;PATIENT STATUS AND COPAY
"RTN","PSOHLDS1",145,0)
 Q:'$D(DFN)!$D(PAS2)
"RTN","PSOHLDS1",146,0)
 N PV2 S PV2=""
"RTN","PSOHLDS1",147,0)
 S $P(PV2,"|",24)=$P($G(^PS(53,+$P($G(^PSRX(IRXN,0)),"^",3),0)),"^",2)_"~"_COPAY_FS
"RTN","PSOHLDS1",148,0)
 S ^TMP("PSO",$J,PSI)="PV2|"_PV2
"RTN","PSOHLDS1",149,0)
 S PSI=PSI+1,PAS2=1
"RTN","PSOHLDS1",150,0)
 Q
"RTN","PSOHLDS1",151,0)
 ;
"RTN","PSOHLDS1",152,0)
MW(PS55,MW,MP) ;Return Mail/Window and MP expanded text               ;PSO*232
"RTN","PSOHLDS1",153,0)
 I MW="W"!(MW="") D                   ;*255
"RTN","PSOHLDS1",154,0)
 . S MP=$S($P($G(^PSRX(IRXN,"MP")),"^")'="":$P(^("MP"),"^"),1:"""""")
"RTN","PSOHLDS1",155,0)
 . S MW="WINDOW"
"RTN","PSOHLDS1",156,0)
 I MW="M" D
"RTN","PSOHLDS1",157,0)
 . S MP=""""""
"RTN","PSOHLDS1",158,0)
 . S PS55=$P(PS55,"^",3)
"RTN","PSOHLDS1",159,0)
 . S MW=$S(PS55=1:"CERTIFIED MAIL",PS55=2:"DO NOT MAIL",1:"REGULAR MAIL")
"RTN","PSOHLDS1",160,0)
 Q
"RTN","PSOHLDS2")
0^9^B92029397^B67611416
"RTN","PSOHLDS2",1,0)
PSOHLDS2 ;BHAM ISC/PWC,SAB-Build HL7 Segments for automated interface ;11/22/06 3:24pm
"RTN","PSOHLDS2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,198,255,200,268,305**;DEC 1997;Build 8
"RTN","PSOHLDS2",3,0)
 ;DIWP supported by DBIA 10011
"RTN","PSOHLDS2",4,0)
 ;^PS(50.606 supported by DBIA 2174
"RTN","PSOHLDS2",5,0)
 ;^PS(50.7 supported by DBIA #2223
"RTN","PSOHLDS2",6,0)
 ;^PS(51 supported by DBIA 2224
"RTN","PSOHLDS2",7,0)
 ;^PS(51.2 supported by DBIA 2226
"RTN","PSOHLDS2",8,0)
 ;^PS(55 supported by DBIA 2228
"RTN","PSOHLDS2",9,0)
 ;^PSDRUG supported by DBIA 221
"RTN","PSOHLDS2",10,0)
 ;^PS(54 supported by DBIA 2227
"RTN","PSOHLDS2",11,0)
 ;Cont'd build HL7 segments
"RTN","PSOHLDS2",12,0)
 ;
"RTN","PSOHLDS2",13,0)
 ;*198 add check to insert spaces into PMI segments
"RTN","PSOHLDS2",14,0)
 ;*255 add 2 new fields to RXE.21 (label name & VA PRINT NAME)
"RTN","PSOHLDS2",15,0)
 ;     and move NTEPMI tag to PSOHLDS4
"RTN","PSOHLDS2",16,0)
 ; *305 send  Notice of Privacy Practices in NTE8
"RTN","PSOHLDS2",17,0)
 ;
"RTN","PSOHLDS2",18,0)
RXE(PSI) ;pharmacy encoded order segment
"RTN","PSOHLDS2",19,0)
 Q:'$D(DFN)  N RXE S RXE="" S $P(RXE,"|",1)=""""""
"RTN","PSOHLDS2",20,0)
 S $P(RXE,"|",2)=$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_$G(PSND2)_CS_"99PSNDF"_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",21,0)
 S $P(RXE,"|",3)="" I $G(PSOXN)="" S PSOXN=""""""
"RTN","PSOHLDS2",22,0)
 S $P(RXE,"|",5)=PSOXN_CS_$S($G(UNIT)'="":$G(UNIT),1:"""""")_CS_"99PSU"
"RTN","PSOHLDS2",23,0)
 S POIPTR=$P($G(^PSRX(IRXN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",24,0)
 I '$G(POIPTR) S PODOSE=$P($G(^PS(50.7,$P($G(^PSDRUG(IDGN,2)),"^"),0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",25,0)
 S TRADENM=$G(^PSRX(IRXN,"TN")),$P(RXE,"|",6)=PODOSE_CS_PODOSENM_CS_"99PSF"
"RTN","PSOHLDS2",26,0)
 S $P(RXE,"|",8)=MP,$P(RXE,"|",9)=TRADENM,$P(RXE,"|",10)=QTY
"RTN","PSOHLDS2",27,0)
 S $P(RXE,"|",11)=CS_$P($G(^PSDRUG(IDGN,660)),"^",8),$P(RXE,"|",12)=NRFL
"RTN","PSOHLDS2",28,0)
 S $P(RXE,"|",13)=DEAID,$P(RXE,"|",14)=VPHARMID_CS_$P(VPHARM,",",1)_CS_$P(VPHARM,",",2)
"RTN","PSOHLDS2",29,0)
 S $P(RXE,"|",15)=$P(^PSRX(IRXN,0),"^"),$P(RXE,"|",16)=RFRM,$P(RXE,"|",17)=NFLD
"RTN","PSOHLDS2",30,0)
 S $P(RXE,"|",18)=PRIORDT,$P(RXE,"|",31)=CSUB_RS_SCTALK_RS_OTLAN
"RTN","PSOHLDS2",31,0)
 S $P(RXE,"|",21)=CS_DRUG_RS_CS_$G(VANAME)                       ;*255
"RTN","PSOHLDS2",32,0)
 S ^TMP("PSO",$J,PSI)="RXE|"_RXE,PSI=PSI+1
"RTN","PSOHLDS2",33,0)
 K PODOSE,PODOSENM,POIPTR,TRADENM,UU
"RTN","PSOHLDS2",34,0)
 Q
"RTN","PSOHLDS2",35,0)
RXD(PSI) ;pharmacy dispense segment
"RTN","PSOHLDS2",36,0)
 Q:'$D(DFN)  N RXD,I
"RTN","PSOHLDS2",37,0)
 S WNS="" I $G(WARN) F I=1:1 S WW=$P(WARN,",",I) Q:WW=""  S WNS=WNS_WW_CS_$S(WW'["N":^PS(54,WW,0),1:"")_RS
"RTN","PSOHLDS2",38,0)
 S RXD="RXD"_FS_$S($G(NFLD):NFLD,1:0)_FS_$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_PSND2_CS_"99PSNDF"
"RTN","PSOHLDS2",39,0)
 S RXD=RXD_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",40,0)
 S RXD=RXD_FS_DISPDT_FS_FS_FS_FS_$P(^PSRX(IRXN,0),"^")_FS_NRFL
"RTN","PSOHLDS2",41,0)
 S RXD=RXD_FS_DEA_RS_PSONDC_FS_$S(FIN'="":FIN_CS_FIN1,1:"")_FS
"RTN","PSOHLDS2",42,0)
 S RXD=RXD_FS_DASPLY_FS_MW_FS_FS_CS_$S($G(CAP):"NON-SAFETY",1:"SAFETY")
"RTN","PSOHLDS2",43,0)
 S RXD=RXD_FS_FS_FS_FS_EXDT_FS_FS_FS_FS_FS_FS_WNS_FS_FS
"RTN","PSOHLDS2",44,0)
 S ^TMP("PSO",$J,PSI)=RXD,PSI=PSI+1
"RTN","PSOHLDS2",45,0)
 Q
"RTN","PSOHLDS2",46,0)
RXR(PSI) ;pharmacy route segment
"RTN","PSOHLDS2",47,0)
 Q:'$D(DFN)  N RXR S (PSROUTE,RTNAME)=""""""
"RTN","PSOHLDS2",48,0)
 F PSRTLP=0:0 S PSRTLP=$O(^PSRX(IRXN,6,PSRTLP)) Q:'PSRTLP  D
"RTN","PSOHLDS2",49,0)
 .S PSROUTE=$P($G(^PSRX(IRXN,6,PSRTLP,0)),"^",7)
"RTN","PSOHLDS2",50,0)
 .I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLDS2",51,0)
 I RTNAME="" K PSROUTE,RTNAME,PSRTLP Q
"RTN","PSOHLDS2",52,0)
 S RXR="RXR"_FS_$G(PSROUTE)_CS_$G(RTNAME)_CS_"99PSR"_FS_FS_FS_FS
"RTN","PSOHLDS2",53,0)
 S ^TMP("PSO",$J,PSI)=RXR,PSI=PSI+1
"RTN","PSOHLDS2",54,0)
 K PSROUTE,RTNAME,PSRTLP
"RTN","PSOHLDS2",55,0)
 Q
"RTN","PSOHLDS2",56,0)
SIG K OT S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""
"RTN","PSOHLDS2",57,0)
 .I $D(^PS(51,"A",X)) D
"RTN","PSOHLDS2",58,0)
 ..I $P($G(^PS(55,DFN,"LAN")),"^") S OT=$O(^PS(51,"B",X,0)) I OT,$P($G(^PS(51,OT,4)),"^")]"" S X=$P(^PS(51,OT,4),"^") K OT Q
"RTN","PSOHLDS2",59,0)
 ..;S %=^PS(51,"A",X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG," ",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOHLDS2",60,0)
 .S SGY=SGY_X_" "
"RTN","PSOHLDS2",61,0)
 S X="",SGC=1 F J=1:1 S Z=$P(SGY," ",J) S:Z="" SGY(SGC)=X Q:Z=""  S:$L(X)+$L(Z)'<$S($P(PSOPAR,"^",28):46,1:34) SGY(SGC)=X,SGC=SGC+1,X="" S X=X_Z_" "
"RTN","PSOHLDS2",62,0)
SIGOLD I '$P(PSOPAR,"^",28) D  K NHC
"RTN","PSOHLDS2",63,0)
 .K DIC,DR,DIQ,NHC S DIC=2,DA=DFN,DR=148,DIQ="NHC",DIQ(0)="I"
"RTN","PSOHLDS2",64,0)
 .D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOHLDS2",65,0)
 .I NHC(2,DFN,148,"I")="Y"!($P($G(^PS(55,DFN,40)),"^")) S SGC=SGC+1,SGY(SGC)="Expiration:________ Mfg:_________"
"RTN","PSOHLDS2",66,0)
 Q
"RTN","PSOHLDS2",67,0)
 ;
"RTN","PSOHLDS2",68,0)
PSOLBL3 ;RX must be defined (Internal), Check already done for OERR SIG
"RTN","PSOHLDS2",69,0)
 ;Format OERR Sig for New and Old label stock
"RTN","PSOHLDS2",70,0)
 N CTCT,FFFF,LLIM,LLLL,LVAR,LVAR1,PPP,PPPP,SGCT,SIG9,ZZZZ,PSLONG,PPPP
"RTN","PSOHLDS2",71,0)
 S RX=IRXN
"RTN","PSOHLDS2",72,0)
 I $P($G(^PS(55,DFN,"LAN")),"^") N II D OTHL^PSOLBL3 G:$G(FND) FMSIG
"RTN","PSOHLDS2",73,0)
 S PSLONG=$S($P(PSOPAR,"^",28):46,1:34)
"RTN","PSOHLDS2",74,0)
 ; NEXT LINE IF SIG IS MOVED BACK TO MULTIPLE
"RTN","PSOHLDS2",75,0)
 S PPPP=1 F PPP=0:0 S PPP=$O(^PSRX(RX,"SIG1",PPP)) Q:'PPP  I $G(^PSRX(RX,"SIG1",PPP,0))'="" S SIG9(PPPP)=^(0) S PPPP=PPPP+1
"RTN","PSOHLDS2",76,0)
 ;NEXT LINE IF 1ST FRONT DOOR SIG LINE LIVES IN BACK DOOR SPOT
"RTN","PSOHLDS2",77,0)
FMSIG S (LVAR,LVAR1)="",LLLL=1
"RTN","PSOHLDS2",78,0)
 F FFFF=0:0 S FFFF=$O(SIG9(FFFF)) Q:'FFFF  S SGCT=0 F ZZZZ=1:1:$L(SIG9(FFFF)) I $E(SIG9(FFFF),ZZZZ)=" "!($L(SIG9(FFFF))=ZZZZ) S SGCT=SGCT+1 D  I $L(LVAR)>PSLONG S SGY(LLLL)=LLIM_" ",LLLL=LLLL+1,LVAR=LVAR1
"RTN","PSOHLDS2",79,0)
 .S LVAR1=$P(SIG9(FFFF)," ",(SGCT)),LLIM=LVAR,LVAR=$S(LVAR="":LVAR1,1:LVAR_" "_LVAR1)
"RTN","PSOHLDS2",80,0)
 I $G(LVAR)'="" S SGY(LLLL)=LVAR
"RTN","PSOHLDS2",81,0)
 I '$P(PSOPAR,"^",28) S SGC=0 F CTCT=0:0 S CTCT=$O(SGY(CTCT)) Q:'CTCT  S SGC=SGC+1
"RTN","PSOHLDS2",82,0)
 I $O(OSGY(0)) D
"RTN","PSOHLDS2",83,0)
 .F I=0:0 S I=$O(SGY(I)) Q:'I  I $G(OSGY(I))']"" S OSGY(I)=" "
"RTN","PSOHLDS2",84,0)
 .F I=0:0 S I=$O(OSGY(I)) Q:'I  I $G(SGY(I))']"" S SGY(I)=" "
"RTN","PSOHLDS2",85,0)
 Q
"RTN","PSOHLDS2",86,0)
NTE ;build NTE segment for SIG
"RTN","PSOHLDS2",87,0)
 ;
"RTN","PSOHLDS2",88,0)
 Q:'$D(DFN)
"RTN","PSOHLDS2",89,0)
 ; 1 = SIG
"RTN","PSOHLDS2",90,0)
 ; 2 = PI Narrative
"RTN","PSOHLDS2",91,0)
 ; 3 = Drug Warning
"RTN","PSOHLDS2",92,0)
 ; 4 = Profile
"RTN","PSOHLDS2",93,0)
 ; 5 = Drug Interaction
"RTN","PSOHLDS2",94,0)
 ; 6 = Drug Allergy
"RTN","PSOHLDS2",95,0)
 ; 7 = PMI Sheet (NTEPMI in PSOHLDS4)
"RTN","PSOHLDS2",96,0)
 ; 8 = Privacy Notification
"RTN","PSOHLDS2",97,0)
 ;
"RTN","PSOHLDS2",98,0)
 K FLDX
"RTN","PSOHLDS2",99,0)
 D NTE1(.PSI) K FLDX D NTE2(.PSI) K FLDX D NTE3(.PSI) K FLDX
"RTN","PSOHLDS2",100,0)
 D NTE4(.PSI) K FLDX D NTE5(.PSI) K FLDX D NTE6(.PSI) K FLDX
"RTN","PSOHLDS2",101,0)
 Q
"RTN","PSOHLDS2",102,0)
 ;
"RTN","PSOHLDS2",103,0)
NTE1(PSI) ;SIG
"RTN","PSOHLDS2",104,0)
 S SIG=$P($G(^PSRX(IRXN,"SIG")),"^")
"RTN","PSOHLDS2",105,0)
 I $P($G(^PSRX(IRXN,"SIG")),"^",2) D PSOLBL3,SIGOLD
"RTN","PSOHLDS2",106,0)
 I '$P($G(^PSRX(IRXN,"SIG")),"^",2) D SIG
"RTN","PSOHLDS2",107,0)
 I $O(OSGY(0)) D  G KNTE
"RTN","PSOHLDS2",108,0)
 .K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",109,0)
 .S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions (LANGUAGE PREFERENCE)"
"RTN","PSOHLDS2",110,0)
 .K DRR F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",111,0)
 .S DRR=DRR+1,OSGY(DRR)=FS_"Medication Instructions (ENGLISH)"
"RTN","PSOHLDS2",112,0)
 .K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",113,0)
 .S CLD=1 F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",114,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR)
"RTN","PSOHLDS2",115,0)
 .S PSI=PSI+1,^TMP("PSO",$J,PSI)="NTE"_FS_8_FS_FS
"RTN","PSOHLDS2",116,0)
 .S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",117,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",118,0)
 K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",119,0)
 S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions"
"RTN","PSOHLDS2",120,0)
 K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",121,0)
 S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",122,0)
 .S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",123,0)
KNTE S PSI=PSI+1 K DR,CLD,DRR,SIG,E,F,S,FLD1,X,Y,SGY,SGC,Z,DR,%,J,P,NT1,ST,EN,LTH
"RTN","PSOHLDS2",124,0)
 Q
"RTN","PSOHLDS2",125,0)
LENGTH(NT1) ; compensate for length > 245
"RTN","PSOHLDS2",126,0)
 I $L(NT1)>245 S LTH=$E($L(NT1)/245,1) S:$L(NT1)#245>0 LTH=LTH+1 F WW=1:1:LTH D
"RTN","PSOHLDS2",127,0)
 . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S NT11=$E(NT1,ST,EN)
"RTN","PSOHLDS2",128,0)
 . S:WW=1 ^TMP("PSO",$J,PSI)=NT11 S:WW>1 ^TMP("PSO",$J,PSI,WW-1)=NT11
"RTN","PSOHLDS2",129,0)
 S:'$D(LTH) ^TMP("PSO",$J,PSI)=NT1 S PSI=PSI+1
"RTN","PSOHLDS2",130,0)
 Q
"RTN","PSOHLDS2",131,0)
NTE2(PSI) ; Patient Narrative
"RTN","PSOHLDS2",132,0)
 K ^UTILITY($J,"W") S (DIWL,PSNACNT)=1,DIWR=45,DIWF="",(PSSIXFL,PSSEVFL)=0 F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,6,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",133,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSIXFL=1
"RTN","PSOHLDS2",134,0)
 I PSSIXFL S ^TMP("PSO",$J,PSI)="NTE"_FS_2_FS_FS,^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1,FLDX=1
"RTN","PSOHLDS2",135,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,7,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",136,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSEVFL=1
"RTN","PSOHLDS2",137,0)
 I PSSEVFL S ^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",138,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,4,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",139,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",140,0)
 S:$D(FLDX) ^TMP("PSO",$J,PSI,PSNACNT-1)=^TMP("PSO",$J,PSI,PSNACNT-1)_FS_"Patient Narrative",PSI=PSI+1
"RTN","PSOHLDS2",141,0)
 K DIWF,DIWL,DIWR,LLL,PSNACNT,PSSEVFL,PSSIXFL,ZZ
"RTN","PSOHLDS2",142,0)
 Q
"RTN","PSOHLDS2",143,0)
NTE3(PSI) ;Drug Warning Narrative
"RTN","PSOHLDS2",144,0)
 N NTE3,J,TEXT,W,CNT,PSSWSITE
"RTN","PSOHLDS2",145,0)
 S WARN=$P($G(^PSDRUG(IDGN,0)),"^",8)
"RTN","PSOHLDS2",146,0)
 S PSSWSITE=+$O(^PS(59.7,0))
"RTN","PSOHLDS2",147,0)
 I $P($G(^PS(59.7,PSSWSITE,10)),"^",11)="N" D
"RTN","PSOHLDS2",148,0)
 .S WARN=$$DRUG^PSSWRNA(IDGN,DFN)
"RTN","PSOHLDS2",149,0)
 I WARN="" Q
"RTN","PSOHLDS2",150,0)
 S NTE3="NTE"_FS_3_FS_FS,^TMP("PSO",$J,PSI)=NTE3,CNT=1
"RTN","PSOHLDS2",151,0)
 F J=1:1:5 S W=$P(WARN,",",J) Q:W=""  D
"RTN","PSOHLDS2",152,0)
 . S TEXT=$$WTEXT^PSSWRNA(W,$G(OLAN)) I TEXT'="" S FLDX=1 D
"RTN","PSOHLDS2",153,0)
 . . I $L(TEXT)<245 S ^TMP("PSO",$J,PSI,CNT)=TEXT,CNT=CNT+1 Q
"RTN","PSOHLDS2",154,0)
 . . N LTH,ST,EN,TXT,WW
"RTN","PSOHLDS2",155,0)
 . . S LTH=$E($L(TEXT)/245,1) S:$L(TEXT)#245>0 LTH=LTH+1
"RTN","PSOHLDS2",156,0)
 . . F WW=1:1:LTH D
"RTN","PSOHLDS2",157,0)
 . . . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S TXT=$E(TEXT,ST,EN)
"RTN","PSOHLDS2",158,0)
 . . . S ^TMP("PSO",$J,PSI,CNT)=TXT,CNT=CNT+1
"RTN","PSOHLDS2",159,0)
 I $G(FLDX) D  S PSI=PSI+1
"RTN","PSOHLDS2",160,0)
 . I $L(^TMP("PSO",$J,PSI,CNT-1)_FS_"Drug Warning Narrative")<245 S ^TMP("PSO",$J,PSI,CNT-1)=$G(^TMP("PSO",$J,PSI,CNT-1))_FS_"Drug Warning Narrative"
"RTN","PSOHLDS2",161,0)
 . E  S ^TMP("PSO",$J,PSI,CNT)=FS_"Drug Warning Narrative"
"RTN","PSOHLDS2",162,0)
 Q
"RTN","PSOHLDS2",163,0)
NTE4(PSI) ;Profile information
"RTN","PSOHLDS2",164,0)
 S PSODFN=DFN N NTE4
"RTN","PSOHLDS2",165,0)
 I $P(PSOPAR,"^",8) D START^PSOHLDS3
"RTN","PSOHLDS2",166,0)
 S:$D(NTE4) PSI=PSI+1
"RTN","PSOHLDS2",167,0)
 Q
"RTN","PSOHLDS2",168,0)
NTE5(PSI) ;Drug Interactions
"RTN","PSOHLDS2",169,0)
 N NTE5 D:$D(DRI) START2^PSOHLDS3
"RTN","PSOHLDS2",170,0)
 S:$D(NTE5) ^TMP("PSO",$J,PSI)=NTE5_FS_"Drug Interactions",PSI=PSI+1
"RTN","PSOHLDS2",171,0)
 Q
"RTN","PSOHLDS2",172,0)
NTE6(PSI) ;Drug Allergy Indications
"RTN","PSOHLDS2",173,0)
 N NTE6
"RTN","PSOHLDS2",174,0)
 Q:'$G(DAW)
"RTN","PSOHLDS2",175,0)
 D START3^PSOHLDS3
"RTN","PSOHLDS2",176,0)
 Q:NTE6=""
"RTN","PSOHLDS2",177,0)
 S ^TMP("PSO",$J,PSI)=NTE6_FS_"Drug Allergy Indications",PSI=PSI+1
"RTN","PSOHLDS2",178,0)
 Q
"RTN","PSOHLDS2",179,0)
NTE8(PSI) ;Privacy Notification
"RTN","PSOHLDS2",180,0)
 N NTE8,PSOLAN
"RTN","PSOHLDS2",181,0)
 S NTE8="NTE"_FS_8_FS_FS,^TMP("PSO",$J,PSI)=NTE8
"RTN","PSOHLDS2",182,0)
 S PSOLAN=$P($G(^PS(55,DFN,"LAN")),"^",2)
"RTN","PSOHLDS2",183,0)
 I PSOLAN'=2 D
"RTN","PSOHLDS2",184,0)
 . S ^TMP("PSO",$J,PSI,1)="The VA Notice of Privacy Practices, IB 10-163, which outlines your privacy rights, is available online at http://www1.va.gov/Health/ or you may obtain a copy by writing the VHA Privacy Office (19F2),"
"RTN","PSOHLDS2",185,0)
 . S ^TMP("PSO",$J,PSI,2)="810 Vermont Avenue NW, Washington, DC 20420."_FS_"Privacy Notification"
"RTN","PSOHLDS2",186,0)
 I PSOLAN=2 D
"RTN","PSOHLDS2",187,0)
 . S ^TMP("PSO",$J,PSI,1)="La Notificacion relacionada con las Politicas de Privacidad del Departamento de Asuntos del Veterano, IB 10-163, contiene los detalles acerca de sus derechos de privacidad y esta disponsible electronicamente"
"RTN","PSOHLDS2",188,0)
 . S ^TMP("PSO",$J,PSI,2)=" en la siguiente direccion: http://www1.va.gov/Health/.  Usted tambien puede conseguir una copia escribiendo a la Oficina de Privacidad del Departamento de Asuntos de Salud del Veterano, (19F2),"
"RTN","PSOHLDS2",189,0)
 . S ^TMP("PSO",$J,PSI,3)="810 Vermont Avenue NW, Washington, DC 20420."_FS_"Privacy Notification"
"RTN","PSOHLDS2",190,0)
 S PSI=PSI+1
"RTN","PSOHLDS2",191,0)
 Q
"RTN","PSOHLNE2")
0^7^B64195087^B60250922
"RTN","PSOHLNE2",1,0)
PSOHLNE2 ;BIR/RTR-Parsing out more OERR segments ;8/13/08 2:43pm
"RTN","PSOHLNE2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,7,59,46,225,305**;DEC 1997;Build 8
"RTN","PSOHLNE2",3,0)
 ;External reference to DG(40.8 supported by DBIA 728
"RTN","PSOHLNE2",4,0)
 ;External reference to PS(50.606 supported by DBIA 2174
"RTN","PSOHLNE2",5,0)
 ;External reference to PS(50.7 supported by DBIA 2223
"RTN","PSOHLNE2",6,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOHLNE2",7,0)
 ;External reference to PS(55 supported by DBIA 2228
"RTN","PSOHLNE2",8,0)
 ;External reference to SC( supported by DBIA 2675
"RTN","PSOHLNE2",9,0)
 ;External reference to EN^ORERR supported by DBIA 2187
"RTN","PSOHLNE2",10,0)
 ;
"RTN","PSOHLNE2",11,0)
EN ;RXO segment on new orders with multiple subscripts
"RTN","PSOHLNE2",12,0)
 S (POVAR,POVAR1)="",(NNN,NNNN)=0,PSOIII=1,MSG(ZZ,0)=$E(MSG(ZZ),5,$L(MSG(ZZ)))
"RTN","PSOHLNE2",13,0)
 S AAA="" F  S AAA=$O(MSG(ZZ,AAA)) Q:AAA=""  S NNN=0 F OOO=1:1:$L(MSG(ZZ,AAA)) S NNN=NNN+1 D  D:$G(POVAR1)="|" PARSE
"RTN","PSOHLNE2",14,0)
 .I $E(MSG(ZZ,AAA),OOO)="|" S NNNN=NNNN+1
"RTN","PSOHLNE2",15,0)
 .S POVAR1=$E(MSG(ZZ,AAA),OOO)
"RTN","PSOHLNE2",16,0)
 .S POLIM=POVAR
"RTN","PSOHLNE2",17,0)
 .S POVAR=$S(POVAR="":POVAR1,1:POVAR_POVAR1)
"RTN","PSOHLNE2",18,0)
 I $G(POVAR)'="" I NNNN=13!(NNNN=12) S PSOREFIL=POVAR
"RTN","PSOHLNE2",19,0)
 K MSG(ZZ,0)
"RTN","PSOHLNE2",20,0)
 Q
"RTN","PSOHLNE2",21,0)
PARSE ;
"RTN","PSOHLNE2",22,0)
 I NNNN=1 S PSORDITE=$P(POLIM,"^",4) G SET
"RTN","PSOHLNE2",23,0)
 I NNNN=10 S PSODDRUG=$P(POLIM,"^",4) I $G(PSODDRUG),('$D(^PSDRUG(PSODDRUG,0))) S PSODDRUG="" G SET
"RTN","PSOHLNE2",24,0)
 I NNNN=10 G SET
"RTN","PSOHLNE2",25,0)
 I NNNN=11 S PSOXQTY=POLIM G SET
"RTN","PSOHLNE2",26,0)
 I NNNN=13 S PSOREFIL=POLIM G SET
"RTN","PSOHLNE2",27,0)
 I NNNN=17 S PSODYSPL=POLIM
"RTN","PSOHLNE2",28,0)
SET S (POVAR,POLIM)="" Q
"RTN","PSOHLNE2",29,0)
 ;
"RTN","PSOHLNE2",30,0)
OBXX ;Parse out OBX segments
"RTN","PSOHLNE2",31,0)
 S OCOUNT=OCOUNT+1
"RTN","PSOHLNE2",32,0)
 S (POVAR,POVAR)="",(NNCK,NNN,NNNN)=0,PSOIII=1,MSG(ZZ,0)=$E(MSG(ZZ),5,$L(MSG(ZZ)))
"RTN","PSOHLNE2",33,0)
 S AAA="" F  S AAA=$O(MSG(ZZ,AAA)) Q:AAA=""  S NNN=0 F OOO=1:1:$L(MSG(ZZ,AAA)) S NNN=NNN+1 D  D:$G(POVAR1)="&"&(NNNN=4) OPARSE D:$G(POVAR1)="|" OPARSE
"RTN","PSOHLNE2",34,0)
 .I $E(MSG(ZZ,AAA),OOO)="|" S NNNN=NNNN+1
"RTN","PSOHLNE2",35,0)
 .S POVAR1=$E(MSG(ZZ,AAA),OOO)
"RTN","PSOHLNE2",36,0)
 .S POLIM=POVAR
"RTN","PSOHLNE2",37,0)
 .S POVAR=$S(POVAR="":POVAR1,1:POVAR_POVAR1)
"RTN","PSOHLNE2",38,0)
 I $G(POVAR)'="" I NNNN=4!(NNNN=5) S NNCK=NNCK+1 S OBXAR(OCOUNT,NNCK)=POVAR
"RTN","PSOHLNE2",39,0)
 K MSG(ZZ,0)
"RTN","PSOHLNE2",40,0)
 F OOO=2:1 Q:'$D(OBXAR(OCOUNT,OOO))  S OBXAR(OCOUNT,1)=OBXAR(OCOUNT,1)_"&"_OBXAR(OCOUNT,OOO) K OBXAR(OCOUNT,OOO)
"RTN","PSOHLNE2",41,0)
 Q
"RTN","PSOHLNE2",42,0)
OPARSE ;
"RTN","PSOHLNE2",43,0)
 I NNNN=4,$G(POVAR1)="&" S NNCK=NNCK+1,OBXAR(OCOUNT,NNCK)=$G(POLIM) G OSET
"RTN","PSOHLNE2",44,0)
 I NNNN=5 S NNCK=NNCK+1 S OBXAR(OCOUNT,NNCK)=$G(POLIM)
"RTN","PSOHLNE2",45,0)
OSET S (POVAR,POLIM)="" Q
"RTN","PSOHLNE2",46,0)
 ;
"RTN","PSOHLNE2",47,0)
PURGE ;Purge order initiated by CPRS
"RTN","PSOHLNE2",48,0)
 N DA,PREER,PRG,PPG,PND,PRGFLAG,PURGCOMM,PEER,PURGPV1,PURGPID,PURGORC,PURGRX,PURGPLC,PRGSTAT,PSCC,PSARC,PSCA,PSACOUNT,PURGEXRX,PLAST,PURGLTH,PURGNODE
"RTN","PSOHLNE2",49,0)
 S PSOMSORR=1
"RTN","PSOHLNE2",50,0)
 S PRGFLAG=0
"RTN","PSOHLNE2",51,0)
 I $G(PSOFILNM),$G(PSOFILNM)'["S" S PURGRX=PSOFILNM G PRX
"RTN","PSOHLNE2",52,0)
 S PND=+$G(PSOFILNM) I PND D  G PDNO
"RTN","PSOHLNE2",53,0)
 .I '$D(^PS(52.41,PND,0)) Q
"RTN","PSOHLNE2",54,0)
 .I $G(PDFN),$G(PDFN)'=$P($G(^PS(52.41,PND,0)),"^",2) S PURGCOMM="Patient does not match" D PDERR Q
"RTN","PSOHLNE2",55,0)
 .S PRGSTAT=$P($G(^PS(52.41,PND,0)),"^",3) I PRGSTAT="NW"!(PRGSTAT="RNW")!(PRGSTAT="HD") S PRGFLAG=1 Q
"RTN","PSOHLNE2",56,0)
 .K DIK S DA=PND,DIK="^PS(52.41," D ^DIK K DIK Q
"RTN","PSOHLNE2",57,0)
 S PURGCOMM="Order was not located by Pharmacy."
"RTN","PSOHLNE2",58,0)
 D PDERR G PDNO
"RTN","PSOHLNE2",59,0)
PDERR D EN^ORERR(PURGCOMM,.MSG)
"RTN","PSOHLNE2",60,0)
 Q
"RTN","PSOHLNE2",61,0)
PDNO F PEER=0:0 S PEER=$O(MSG(PEER)) Q:'PEER  S:$P(MSG(PEER),"|")="PV1" PURGPV1=MSG(PEER) S:$P(MSG(PEER),"|")="PID" PURGPID=MSG(PEER) S:$P(MSG(PEER),"|")="ORC"&($G(PURGORC)="") PURGORC=MSG(PEER)
"RTN","PSOHLNE2",62,0)
 N MSG,PSOHINST D INIT^PSOHLSN S MSG(2)=$G(PURGPID),MSG(3)=$G(PURGPV1),MSG(4)="ORC|"_$S($G(PRGFLAG):"ZU",1:"ZR")_"|"_$G(OR("PLACE"))_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"_"|"_$S($P($G(PURGORC),"|",4)'="":$P(PURGORC,"|",4),1:"")
"RTN","PSOHLNE2",63,0)
 F PREER=11,13 I $P($G(PURGORC),"|",PREER)'="" S $P(MSG(4),"|",PREER)=$P($G(PURGORC),"|",PREER)
"RTN","PSOHLNE2",64,0)
 S $P(MSG(4),"|",17)="^^^^"_$S($G(PRGFLAG):"Unable to Purge order.",1:"OK to Purge order.")_"^"
"RTN","PSOHLNE2",65,0)
 D SEND^PSOHLSN
"RTN","PSOHLNE2",66,0)
PURGEX K PSOMSORR Q
"RTN","PSOHLNE2",67,0)
PRX ;Purge from PSRX here
"RTN","PSOHLNE2",68,0)
 I '$D(^PSRX(PURGRX,0)) G PDNO
"RTN","PSOHLNE2",69,0)
 I $G(PDFN),$G(PDFN)'=$P($G(^PSRX(PURGRX,0)),"^",2) S PURGCOMM="Patient does not match" D PDERR G PDNO
"RTN","PSOHLNE2",70,0)
 I '$P($G(^PSRX(PURGRX,"ARC")),"^") S PRGFLAG=1 G PDNO
"RTN","PSOHLNE2",71,0)
 ;purge from PSRX
"RTN","PSOHLNE2",72,0)
 S PURGEXRX=$P(^PSRX(PURGRX,0),"^")
"RTN","PSOHLNE2",73,0)
 S PSOSUSPA=1 K DIK S DA=PURGRX,PSCC=$P($G(^PSRX(PURGRX,0)),"^",2),DIK="^PSRX(" D ^DIK K DIK,PSOSUSPA
"RTN","PSOHLNE2",74,0)
 I $D(^PS(55,+$G(PSCC),0)) S DA(1)=PSCC,DIK="^PS(55,"_DA(1)_",""P""," F PSCA=0:0 S PSCA=$O(^PS(55,+$G(PSCC),"P",PSCA)) Q:'PSCA  I ^PS(55,+$G(PSCC),"P",PSCA,0)=PURGRX S DA=PSCA D ^DIK K DA,DIK
"RTN","PSOHLNE2",75,0)
 I $D(^PS(52.4,PURGRX,0)) S DA=PURGRX,DIK="^PS(52.4," D ^DIK K DA,DIK
"RTN","PSOHLNE2",76,0)
 S DA=$O(^PS(52.5,"B",PURGRX,"")) I DA S DIK="^PS(52.5," D ^DIK K DIK,DA
"RTN","PSOHLNE2",77,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLNE2",78,0)
 I '$G(PSCC) G PUQUIT
"RTN","PSOHLNE2",79,0)
 I '$D(^PS(55,PSCC,"ARC",DT)) S DA=PSCC,DIE=55,DR="101///"_DT,DR(2,55.13)="1///"_$G(PURGEXRX) D ^DIE K DIE G PUQUIT
"RTN","PSOHLNE2",80,0)
 S PLAST=0 F PSARC=0:0 S PSARC=$O(^PS(55,PSCC,"ARC",DT,1,PSARC)) Q:'PSARC  S PLAST=PSARC
"RTN","PSOHLNE2",81,0)
 I $G(PLAST),$D(^PS(55,PSCC,"ARC",DT,1,PLAST,0)) S PURGNODE=^PS(55,PSCC,"ARC",DT,1,PLAST,0) S PURGLTH=$L(PURGNODE) I $G(PURGLTH),PURGLTH<220 S ^PS(55,PSCC,"ARC",DT,1,PLAST,0)=PURGNODE_$S($E(PURGNODE,PURGLTH)'="*":"*",1:"")_PURGEXRX G PUQUIT
"RTN","PSOHLNE2",82,0)
 S DA=PSCC,DIE=55,DR="101///"_DT,DR(2,55.13)="1///"_$G(PURGEXRX) D ^DIE K DIE
"RTN","PSOHLNE2",83,0)
PUQUIT G PDNO
"RTN","PSOHLNE2",84,0)
 ;
"RTN","PSOHLNE2",85,0)
REF ;  Refill request from CPRS
"RTN","PSOHLNE2",86,0)
 N PSORXFL,PSORFX,REFXXX,REFCOM,REFCOMXX,REFEER,REFPV1,REFPID,REFORC,RREER,RFLOOP,REFSEG,RFTYPE,REFILLER,REFVR,PSOERR,PSODUZ,PSOAUTOF
"RTN","PSOHLNE2",87,0)
 I $G(PSOFILNM),$G(PSOFILNM)'["S" S PSORXFL=PSOFILNM G REFRX
"RTN","PSOHLNE2",88,0)
 I $G(PSOFILNM) S PSORFX=+$G(PSOFILNM) D  S REFXXX=1 G REFSND
"RTN","PSOHLNE2",89,0)
 .I '$D(^PS(52.41,PSORFX,0)) S (REFCOMXX,REFCOM)="Order was not located by Pharmacy." D REFERR Q
"RTN","PSOHLNE2",90,0)
 .I $G(PDFN),$G(PDFN)'=$P($G(^PS(52.41,PSORFX,0)),"^",2) S (REFCOMXX,REFCOM)="Patient does not match." D REFERR Q
"RTN","PSOHLNE2",91,0)
 .I $P($G(^PS(52.41,PSORFX,0)),"^",3)="RF" S REFCOM="Refill has already been requested." Q
"RTN","PSOHLNE2",92,0)
 .S REFCOM="Refill request not allowed on Pending order."
"RTN","PSOHLNE2",93,0)
 S (REFCOMXX,REFCOM)="Order was not located by Pharmacy." D REFERR S REFXXX=1 G REFSND
"RTN","PSOHLNE2",94,0)
REFERR D EN^ORERR(REFCOMXX,.MSG)
"RTN","PSOHLNE2",95,0)
 Q
"RTN","PSOHLNE2",96,0)
REFSND ;  Add code here if response message is ever required
"RTN","PSOHLNE2",97,0)
 Q
"RTN","PSOHLNE2",98,0)
REFRX ;
"RTN","PSOHLNE2",99,0)
 I $O(^PS(52.41,"ARF",PSORXFL,0)) S REFXXX=1,REFCOM="Refill request already exists." G REFSND
"RTN","PSOHLNE2",100,0)
 I '$D(^PSRX(PSORXFL,0)) S (REFCOMXX,REFCOM)="Order was not located by Pharmacy." D REFERR S REFXXX=1 G REFSND
"RTN","PSOHLNE2",101,0)
 I $G(PDFN),$G(PDFN)'=$P($G(^PSRX(PSORXFL,0)),"^",2) S (REFCOMXX,REFCOM)="Patient does not match." D REFERR S REFXXX=1 G REFSND
"RTN","PSOHLNE2",102,0)
 F RFLOOP=0:0 S RFLOOP=$O(MSG(RFLOOP)) Q:'RFLOOP  S REFSEG=$G(MSG(RFLOOP)),RFTYPE=$P(REFSEG,"|")_"Z" S REFSEG=$E(REFSEG,5,$L(REFSEG)) I RFTYPE="PIDZ"!(RFTYPE="PV1Z")!(RFTYPE="ORCZ")!(RFTYPE="ZRXZ") D @RFTYPE
"RTN","PSOHLNE2",103,0)
 I '$G(PLACER) S REFXXX=1,REFCOM="Unable to process refill request." G REFSND
"RTN","PSOHLNE2",104,0)
 I $G(REFILLER),$G(REFILLER)'=$G(PSORXFL) S REFCOMXX="Filler number mismatch" D REFERR S REFXXX=1,REFCOM="Unable to process refill request." G REFSND
"RTN","PSOHLNE2",105,0)
 ;
"RTN","PSOHLNE2",106,0)
 ;  Auto Refill, file to Prescription file #52, if key exists and at
"RTN","PSOHLNE2",107,0)
 ;   least one key holder and if CPRS Automated refill flag is on.
"RTN","PSOHLNE2",108,0)
 S PSOAUTOF=0
"RTN","PSOHLNE2",109,0)
 I $D(^XUSEC("PSOAUTRF")),$O(^XUSEC("PSOAUTRF",0)),$$GET1^DIQ(59.7,1,40.16,"I") D
"RTN","PSOHLNE2",110,0)
 . S PSOERR=""
"RTN","PSOHLNE2",111,0)
 . D REF^PSOATRFC(PSOFILNM,.PSOERR)
"RTN","PSOHLNE2",112,0)
 . D:$D(PSOERR)>1 MAILMSG^PSOATRFC($G(PDFN),PSOFILNM,.PSOERR)
"RTN","PSOHLNE2",113,0)
 . ;  If no error msg array, then refill was filed in the Prescription
"RTN","PSOHLNE2",114,0)
 . ;   file #52 so quit, Else file refill to Pending file #52.41
"RTN","PSOHLNE2",115,0)
 . S:$D(PSOERR)<2 PSOAUTOF=1
"RTN","PSOHLNE2",116,0)
 Q:PSOAUTOF
"RTN","PSOHLNE2",117,0)
 ;
"RTN","PSOHLNE2",118,0)
 ;  Manual Refill, file to Pending Outpatient Orders file #52.41
"RTN","PSOHLNE2",119,0)
 K DD,DO S DIC="^PS(52.41,",DIC(0)="L",X=PLACER,DIC("DR")="1////"_$G(DFN)_";2////"_"RF"_";4////"_$G(ENTERED)_";5////"_$G(PROV) D FILE^DICN K DIC,DR I Y<0 S REFXXX=1,REFCOM="Unable to process refill request." G REFSND
"RTN","PSOHLNE2",120,0)
 S PENDING=+Y S $P(^PS(52.41,PENDING,0),"^",13)=$G(LOCATION),$P(^(0),"^",17)=$S($G(ROUTING)'="":$G(ROUTING),1:"W"),$P(^(0),"^",19)=$G(PSORXFL),$P(^(0),"^",20)="F",$P(^(0),"^",14)="R"
"RTN","PSOHLNE2",121,0)
 S $P(^PS(52.41,PENDING,0),"^",8)=$P($G(^PSRX(PSORXFL,"OR1")),"^"),$P(^PS(52.41,PENDING,0),"^",9)=$P($G(^PSRX(PSORXFL,0)),"^",6)
"RTN","PSOHLNE2",122,0)
 S $P(^PS(52.41,PENDING,"INI"),"^")=$G(PSINPTR) D NOW^%DTC S $P(^PS(52.41,PENDING,0),"^",12)=% K %
"RTN","PSOHLNE2",123,0)
 K DIK S DA=PENDING,DIK="^PS(52.41," D IX1^DIK K DIK
"RTN","PSOHLNE2",124,0)
 G REFSND
"RTN","PSOHLNE2",125,0)
PIDZ ;
"RTN","PSOHLNE2",126,0)
 S DFN=+$P(REFSEG,"|",3)
"RTN","PSOHLNE2",127,0)
 Q
"RTN","PSOHLNE2",128,0)
PV1Z ;
"RTN","PSOHLNE2",129,0)
 S LOCATION=+$P(+$P(REFSEG,"|",3),"^")
"RTN","PSOHLNE2",130,0)
 S:'$D(^SC(LOCATION,0)) LOCATION=""
"RTN","PSOHLNE2",131,0)
 S INPTRX=0 I $G(LOCATION) S PSINPTR=$P($G(^SC(LOCATION,0)),"^",4) I PSINPTR Q
"RTN","PSOHLNE2",132,0)
 I $G(LOCATION) S INPTRX=$P($G(^SC(LOCATION,0)),"^",15)
"RTN","PSOHLNE2",133,0)
 I '$G(INPTRX) S INPTRX=$O(^DG(40.8,0))
"RTN","PSOHLNE2",134,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLNE2",135,0)
 S PSINPTR=+$$SITE^VASITE(DT,INPTRX)
"RTN","PSOHLNE2",136,0)
 Q
"RTN","PSOHLNE2",137,0)
ORCZ ;
"RTN","PSOHLNE2",138,0)
 S PLACER=+$P(REFSEG,"|",2),REFILLER=+$P(REFSEG,"|",3),ENTERED=+$P(REFSEG,"|",10),PROV=+$P(REFSEG,"|",12)
"RTN","PSOHLNE2",139,0)
 Q
"RTN","PSOHLNE2",140,0)
ZRXZ ;
"RTN","PSOHLNE2",141,0)
 S ROUTING=$P(REFSEG,"|",4)
"RTN","PSOHLNE2",142,0)
 Q
"RTN","PSOHLNE2",143,0)
STUFF ;
"RTN","PSOHLNE2",144,0)
 S PSOVRBD=$P($G(^PS(50.7,+$G(PSORDITE),0)),"^",2)
"RTN","PSOHLNE2",145,0)
 I '$G(PSOVRBD) K PSOVRBD Q
"RTN","PSOHLNE2",146,0)
 S PSOVRB=$P($G(^PS(50.606,PSOVRBD,"MISC")),"^")
"RTN","PSOHLNE2",147,0)
 F EE=0:0 S EE=$O(^PS(52.41,PENDING,1,EE)) Q:'EE  S $P(^PS(52.41,PENDING,1,EE,1),"^",10)=$$UNESC^ORHLESC($G(PSOVRB))
"RTN","PSOHLNE2",148,0)
 K PSOVRBD,PSONUNN,PSONUN,PSOVRB
"RTN","PSOHLNE2",149,0)
 Q
"RTN","PSOLBLN2")
0^12^B37925640^B30135565
"RTN","PSOLBLN2",1,0)
PSOLBLN2 ;BHAM ISC/RTR - NEW LABEL TRAILER ;06/06/94
"RTN","PSOLBLN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**92,107,110,305**;DEC 1997;Build 8
"RTN","PSOLBLN2",3,0)
 Q:'+$G(RXN)!('$G(PSOTRAIL))!('+$G(DFN))
"RTN","PSOLBLN2",4,0)
 I $G(PSOBLALL),$P(PPL,",",PI+1)'="" Q
"RTN","PSOLBLN2",5,0)
 K ^TMP($J,"PSOMAIL"),^TMP($J,"PSONARR"),^TMP($J,"PSOSUSP") S PRCOPAY=$S('$D(PSOCPN):0,1:1)
"RTN","PSOLBLN2",6,0)
START ;RETURN MAIL
"RTN","PSOLBLN2",7,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"") I $P(PSOSYS,"^",4),$D(^PS(59,+$P($G(PSOSYS),"^",4),0)) S PS=^PS(59,$P($G(PSOSYS),"^",4),0)
"RTN","PSOLBLN2",8,0)
 S VAADDR1=$P(PS,"^"),VASTREET=$P(PS,"^",2),STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLBLN2",9,0)
 S PSZIP=$P(PS,"^",5) S PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLBLN2",10,0)
 S ^TMP($J,"PSOMAIL",$S(PRCOPAY:1,1:3))="Pharmacy Service (119)",^($S(PRCOPAY:2,1:4))=$G(VAADDR1),^($S(PRCOPAY:3,1:5))=$G(VASTREET),^($S(PRCOPAY:4,1:6))=$P(PS,"^",7)_", "_$G(STATE)_"  "_$G(PSOHZIP)
"RTN","PSOLBLN2",11,0)
 I PRCOPAY F ZZZ=5:1:15 S ^TMP($J,"PSOMAIL",ZZZ)=""
"RTN","PSOLBLN2",12,0)
 I 'PRCOPAY F ZZZ=7:1:17 S ^TMP($J,"PSOMAIL",ZZZ)=""
"RTN","PSOLBLN2",13,0)
 S ^TMP($J,"PSOMAIL",$S(PRCOPAY:16,1:18))="Use the label above to mail the computer",^($S(PRCOPAY:17,1:19))="copies back to us. Apply enough postage",^($S(PRCOPAY:18,1:20))="to your envelope to ensure delivery."
"RTN","PSOLBLN2",14,0)
NARR ;SET TMP GLOBAL FOR NARRATIVES
"RTN","PSOLBLN2",15,0)
 K ^UTILITY($J,"W") S (DIWL,PSNACNT)=1,DIWR=45,DIWF="",(PSSIXFL,PSSEVFL)=0 F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,6,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOLBLN2",16,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP($J,"PSONARR",PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSIXFL=1
"RTN","PSOLBLN2",17,0)
 I PSSIXFL S ^TMP($J,"PSONARR",PSNACNT)="" S PSNACNT=PSNACNT+1
"RTN","PSOLBLN2",18,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,7,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOLBLN2",19,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP($J,"PSONARR",PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSEVFL=1
"RTN","PSOLBLN2",20,0)
 I $G(PSOCHAMP),$G(PSOTRAMT) D:PSSEVFL  S ^TMP($J,"PSONARR",PSNACNT)="REMIT $"_PSOTRAMT_" TO AGENT CASHIER." G SUSP
"RTN","PSOLBLN2",21,0)
 .S ^TMP($J,"PSONARR",PSNACNT)="" S PSNACNT=PSNACNT+1
"RTN","PSOLBLN2",22,0)
 I 'PRCOPAY G SUSP
"RTN","PSOLBLN2",23,0)
 I PSSEVFL S ^TMP($J,"PSONARR",PSNACNT)="" S PSNACNT=PSNACNT+1
"RTN","PSOLBLN2",24,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,4,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOLBLN2",25,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP($J,"PSONARR",PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1
"RTN","PSOLBLN2",26,0)
SUSP ;SUSPENSE DOCUMENT
"RTN","PSOLBLN2",27,0)
 S (PSSUFLG,PSSPCNT)=0 S:'$D(DFN) DFN=+$P($G(^PSRX(RX,0)),"^",2) S PSODFN=DFN,(SPPL,RXX,STA)=""
"RTN","PSOLBLN2",28,0)
 I $G(PSODTCUT)']"" S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X
"RTN","PSOLBLN2",29,0)
 D ^PSOBUILD S (STA,RXX)="" F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S RXX=$O(PSOSD(STA,RXX)) Q:RXX=""  I $P(PSOSD(STA,RXX),"^",2)=5 S SPPL=$P(PSOSD(STA,RXX),"^")_","_SPPL
"RTN","PSOLBLN2",30,0)
 D 6^VADPT,PID^VADPT I SPPL="" S PSSUFLG=1 G PRINT
"RTN","PSOLBLN2",31,0)
 S ^TMP($J,"PSOSUSP",1)=$E($P(VADM(2),"^",2),5,12),^(2)=VADM(1),^(3)=$G(VAPA(1)),^(4)=$G(ADDR(2)) I $G(ADDR(3))="",$G(ADDR(4))="" S ^TMP($J,"PSOSUSP",5)="" G ADD
"RTN","PSOLBLN2",32,0)
 I $G(ADDR(3))'="",$G(ADDR(4))="" S ^TMP($J,"PSOSUSP",5)=$G(ADDR(3)) S ^TMP($J,"PSOSUSP",6)="" G ADD
"RTN","PSOLBLN2",33,0)
 S ^TMP($J,"PSOSUSP",5)=$G(ADDR(3)),^(6)=$G(ADDR(4)),^(7)=""
"RTN","PSOLBLN2",34,0)
ADD F ZZ=0:0 S ZZ=$O(^TMP($J,"PSOSUSP",ZZ)) Q:'ZZ  S PSSPCNT=ZZ
"RTN","PSOLBLN2",35,0)
 S PSSPCNT=PSSPCNT+1 S ^TMP($J,"PSOSUSP",PSSPCNT)="   The following prescriptions will be" S PSSPCNT=PSSPCNT+1 S ^TMP($J,"PSOSUSP",PSSPCNT)="mailed to you on or after the date indicated." S PSSPCNT=PSSPCNT+1
"RTN","PSOLBLN2",36,0)
 S ^TMP($J,"PSOSUSP",PSSPCNT)="",PSSPCNT=PSSPCNT+1,^(PSSPCNT)="Rx#                   Date",PSSPCNT=PSSPCNT+1,^(PSSPCNT)="============================================",PSSPCNT=PSSPCNT+1,^(PSSPCNT)="",PSSPCNT=PSSPCNT+1
"RTN","PSOLBLN2",37,0)
 F XX=1:1 Q:$P(SPPL,",",XX)=""  S PSSSRX=$P(SPPL,",",XX) D
"RTN","PSOLBLN2",38,0)
 .S SPNUM=$O(^PS(52.5,"B",PSSSRX,0)) I SPNUM S SPDATE=$P($G(^PS(52.5,SPNUM,0)),"^",2) S Y=SPDATE D DD^%DT S SPDATE=Y
"RTN","PSOLBLN2",39,0)
 .S $P(PSOLGTH," ",(20-($L($P(^PSRX(PSSSRX,0),"^")))))="" S ^TMP($J,"PSOSUSP",PSSPCNT)=$P(^PSRX(PSSSRX,0),"^")_PSOLGTH_$G(SPDATE) S PSSPCNT=PSSPCNT+1
"RTN","PSOLBLN2",40,0)
 .S ^TMP($J,"PSOSUSP",PSSPCNT)="  "_$$ZZ^PSOSUTL(PSSSRX) S PSSPCNT=PSSPCNT+1 K SPNUM,SPDATE,Y
"RTN","PSOLBLN2",41,0)
PRINT S PSOTRDFN=$P(VADM(2),"^"),PSOTRDFN=$S(PSOTRDFN]"":PSOTRDFN,1:"Unavailable") S Y=DT X ^DD("DD") S EDT=Y
"RTN","PSOLBLN2",42,0)
 W ?54,VADM(1)_" "_$E($P(VADM(2),"^",2),5,12)_" "_EDT
"RTN","PSOLBLN2",43,0)
 W ! I PRCOPAY,$G(PSOBARS) S X="S",X2=PSOTRDFN,X1=$X W ?54,@PSOBAR1,PSOTRDFN,@PSOBAR0,$C(13) S $X=0
"RTN","PSOLBLN2",44,0)
 I PRCOPAY,'$G(PSOBARS) W !!!
"RTN","PSOLBLN2",45,0)
 I 'PRCOPAY W !
"RTN","PSOLBLN2",46,0)
 I 'PSSUFLG D PRSUS,NPP1 G END
"RTN","PSOLBLN2",47,0)
 S (PSNONARR,PSNOADDR,PSNOBOTH)=0 F TTT=1:1 Q:$G(PSNOBOTH)  D
"RTN","PSOLBLN2",48,0)
 .W $G(^TMP($J,"PSOMAIL",TTT)) S:'$O(^(TTT)) PSNOADDR=1
"RTN","PSOLBLN2",49,0)
 .W ?54,$G(^TMP($J,"PSONARR",TTT)),! S:'$O(^(TTT)) PSNONARR=1
"RTN","PSOLBLN2",50,0)
 .I PSNOADDR,PSNONARR S PSNOBOTH=1
"RTN","PSOLBLN2",51,0)
 D NPP1
"RTN","PSOLBLN2",52,0)
END K ^TMP($J,"PSONARR"),^TMP($J,"PSOMAIL"),^TMP($J,"PSOSUSP"),^UTILITY($J,"W")
"RTN","PSOLBLN2",53,0)
 K DIWF,DIWL,DIWR,EDT,LLL,PRCOPAY,PS,PSNACNT,PSNOADDR,PSNOBOTH,PSNONARR,PSNOSUSP,PSNTHREE,PSOLGTH,PSOSD,PSOTRAIL,PSOTRDFN,PSSEVFL,PSSIXFL,PSSPCNT,PSSSRX,PSSUFLG,RXX,SPDATE,SPNUM,SPPL,STATE,TTT,VAADDR1,VADM,VAEL,VAPA,VASTREET,ZZ,ZZZ W @IOF
"RTN","PSOLBLN2",54,0)
 I $P(PSOPAR,"^",31) D BLANK^PSOLBLD W @IOF
"RTN","PSOLBLN2",55,0)
 Q
"RTN","PSOLBLN2",56,0)
NPP1 ;
"RTN","PSOLBLN2",57,0)
 N PSOLAN S PSOLAN=$P($G(^PS(55,DFN,"LAN")),"^",2) S:'PSOLAN PSOLAN=1
"RTN","PSOLBLN2",58,0)
 I $G(PSOLAN)=1 D
"RTN","PSOLBLN2",59,0)
 . W !,"The VA Notice of Privacy Practices, IB 10-163, which outlines your privacy",!
"RTN","PSOLBLN2",60,0)
 . W "rights, is available online at http://www1.va.gov/Health/ or you may obtain",!
"RTN","PSOLBLN2",61,0)
 . W "a copy by writing the VHA Privacy Office (19F2), 810 Vermont Avenue NW,",!
"RTN","PSOLBLN2",62,0)
 . W "Washington, DC 20420.",!
"RTN","PSOLBLN2",63,0)
 I $G(PSOLAN)=2 D
"RTN","PSOLBLN2",64,0)
 . W !,"La Notificacion relacionada con las Politicas de Privacidad del Departamento",!
"RTN","PSOLBLN2",65,0)
 . W "de Asuntos del Veterano, IB 10-163, contiene los detalles acerca de sus",!
"RTN","PSOLBLN2",66,0)
 . W "derechos de privacidad y esta disponible electronicamente en la siguiente",!
"RTN","PSOLBLN2",67,0)
 . W "direccion: http://www1.va.gov/Health/.  Usted tambien puede conseguir una",!
"RTN","PSOLBLN2",68,0)
 . W "copia escribiendo a la Oficina de Privacidad del Departamento de Asuntos de",!
"RTN","PSOLBLN2",69,0)
 . W "Salud del Veterano, (19F2), 810 Vermont Avenue NW, Washington, DC 20420.",!
"RTN","PSOLBLN2",70,0)
 Q
"RTN","PSOLBLN2",71,0)
 ;
"RTN","PSOLBLN2",72,0)
PRSUS S (PSNONARR,PSNOADDR,PSNOSUSP,PSNTHREE)=0 F TTT=1:1 Q:$G(PSNTHREE)  D
"RTN","PSOLBLN2",73,0)
 .W $G(^TMP($J,"PSOMAIL",TTT)) S:'$O(^(TTT)) PSNOADDR=1
"RTN","PSOLBLN2",74,0)
 .W ?54,$G(^TMP($J,"PSONARR",TTT)) S:'$O(^(TTT)) PSNONARR=1
"RTN","PSOLBLN2",75,0)
 .W ?102,$G(^TMP($J,"PSOSUSP",TTT)),! S:'$O(^(TTT)) PSNOSUSP=1
"RTN","PSOLBLN2",76,0)
 .I PSNOADDR,PSNONARR,PSNOSUSP S PSNTHREE=1
"RTN","PSOLBLN2",77,0)
 Q
"RTN","PSOLLL6")
0^14^B20102270^B9729924
"RTN","PSOLLL6",1,0)
PSOLLL6 ;BHAM/BHW - LABEL TRAILER ;12/02/2002
"RTN","PSOLLL6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,141,135,162,161,305**;DEC 1997;Build 8
"RTN","PSOLLL6",3,0)
 ;
"RTN","PSOLLL6",4,0)
 I $G(PSOBLALL),$P(PPL,",",PI+1)'="" Q
"RTN","PSOLLL6",5,0)
 S PRCOPAY=$S('$D(PSOCPN):0,1:1)
"RTN","PSOLLL6",6,0)
NARR ;NARRATIVES
"RTN","PSOLLL6",7,0)
 N LC S (PSSIXFL,PSSEVFL,LENGTH,OUT)=0,PTEXT="" F I=4,6,7 S LC(I)=0
"RTN","PSOLLL6",8,0)
 I $G(PSOIO("RNI"))]"" X PSOIO("RNI")
"RTN","PSOLLL6",9,0)
 S XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLL6",10,0)
 I $D(^PS(59,PSOSITE,6))!($D(^PS(59,PSOSITE,7))) S T=PNM_" "_SSNP_"  "_$G(PSONOW) D PRINT(T) S PSOY=PSOY+PSOYI
"RTN","PSOLLL6",11,0)
 F JJ=6,7 S TEXT="" D P(JJ)  S PSOY=PSOY+PSOYI Q:OUT
"RTN","PSOLLL6",12,0)
 I $G(PSOIO("CNI"))]"" X PSOIO("CNI")
"RTN","PSOLLL6",13,0)
 I $G(PSOCHAMP),$G(PSOTRAMT) S T="REMIT $"_PSOTRAMT_" TO AGENT CASHIER." D PRINT(T) G END
"RTN","PSOLLL6",14,0)
 I 'PRCOPAY G END
"RTN","PSOLLL6",15,0)
 S OUT=0,TEXT=""
"RTN","PSOLLL6",16,0)
 I $D(^PS(59,PSOSITE,4)) S T=PNM_" "_SSNP_"  "_$G(PSONOW) D PRINT(T) S PSOY=PSOY+PSOYI D P(4)
"RTN","PSOLLL6",17,0)
END ;
"RTN","PSOLLL6",18,0)
 D NPP
"RTN","PSOLLL6",19,0)
 K DIWF,DIWL,DIWR,EDT,LLL,PRCOPAY,PSNACNT,PSNOADDR,PSNOBOTH,PSNONARR,PSNOSUSP,PSNTHREE,PSOLGTH,PSOSD,PSOTRAIL,PSOTRDFN,PSSEVFL,PSSIXFL,PSSPCNT,PSSSRX,PSSUFLG,RXX,SPDATE,SPNUM,SPPL,TTT,VAADDR1,VADM,VAEL,VAPA,VASTREET,ZZ,ZZZ W @IOF
"RTN","PSOLLL6",20,0)
 Q
"RTN","PSOLLL6",21,0)
P(JJ) ;NARRATIVE PRINT CONTROL
"RTN","PSOLLL6",22,0)
 N TEXTLEN,PSOCNT
"RTN","PSOLLL6",23,0)
 S TEXTLEN=0,PSOCNT=0
"RTN","PSOLLL6",24,0)
 S ZZ=0 F  S ZZ=$O(^PS(59,PSOSITE,JJ,ZZ)) Q:'ZZ  S PSOCNT=PSOCNT+1 Q:PSOCNT>7  I $D(^(ZZ,0)) S TEXT=^(0),TEXTLEN=TEXTLEN+$L(TEXT) S:TEXTLEN>560 TEXTLEN=TEXTLEN-$L(TEXT),TEXT=$E(TEXT,1,560-TEXTLEN) Q:TEXT=""  D  Q:OUT
"RTN","PSOLLL6",25,0)
 . N IC
"RTN","PSOLLL6",26,0)
 . D STRT^PSOLLU1("SEC2",TEXT,.L)
"RTN","PSOLLL6",27,0)
 . I L(XFONT)>4.1 D  Q
"RTN","PSOLLL6",28,0)
 .. S IC=0 F J=1:1:$L(TEXT," ") D STRT^PSOLLU1("SEC2",$P(TEXT," ",J)_" ",.L) I L(XFONT)>4.1 S IC=1
"RTN","PSOLLL6",29,0)
 .. I IC D  Q:OUT
"RTN","PSOLLL6",30,0)
 ... F J=$L(TEXT):-1:1 S PTEXT=$E(TEXT,1,J) D STRT^PSOLLU1("SEC2",PTEXT,.L) D  Q:OUT
"RTN","PSOLLL6",31,0)
 .... I L(XFONT)<4.1 D PRINT(PTEXT) S LC(JJ)=LC(JJ)+1,TEXT=$E(TEXT,J+1,512),J=$L(TEXT)+1,PTEXT="" I PSOY>PSOYM S OUT=1
"RTN","PSOLLL6",32,0)
 .... Q
"RTN","PSOLLL6",33,0)
 ... Q
"RTN","PSOLLL6",34,0)
 .. I IC D:PTEXT]"" PRINT(PTEXT) S:PTEXT]"" LC(JJ)=LC(JJ)+1 S:PSOY>PSOYM OUT=1 Q
"RTN","PSOLLL6",35,0)
 .. F J=$L(TEXT," "):-1 S PTEXT=$P(TEXT," ",1,J) Q:OUT  Q:'$L(PTEXT)  D STRT^PSOLLU1("SEC2",PTEXT,.L) I L(XFONT)<4.1 D
"RTN","PSOLLL6",36,0)
 ... D PRINT(PTEXT) S LC(JJ)=LC(JJ)+1,TEXT=$P(TEXT," ",J+1,99) I PSOY>PSOYM S OUT=1
"RTN","PSOLLL6",37,0)
 ... ;Reset $L of TEXT +1 so J loop continues properly
"RTN","PSOLLL6",38,0)
 ... S J=$L(TEXT," ")+1
"RTN","PSOLLL6",39,0)
 ... Q
"RTN","PSOLLL6",40,0)
 .. Q
"RTN","PSOLLL6",41,0)
 . D PRINT(TEXT) S LC(JJ)=LC(JJ)+1,TEXT=""
"RTN","PSOLLL6",42,0)
 . I PSOY>PSOYM S OUT=1
"RTN","PSOLLL6",43,0)
 . Q
"RTN","PSOLLL6",44,0)
 I 'OUT I TEXT]"" D PRINT(TEXT) S LC(JJ)=LC(JJ)+1
"RTN","PSOLLL6",45,0)
 Q
"RTN","PSOLLL6",46,0)
PRINT(T) ;
"RTN","PSOLLL6",47,0)
 I $G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL6",48,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL6",49,0)
 W T,!
"RTN","PSOLLL6",50,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL6",51,0)
 Q
"RTN","PSOLLL6",52,0)
 ;
"RTN","PSOLLL6",53,0)
NPP ; Notice of Privacy Practices
"RTN","PSOLLL6",54,0)
 N SKP S SKP=LC(6)+LC(7)
"RTN","PSOLLL6",55,0)
 S PSOX=0 F I=SKP:-1:LC(4) D PRINT("")
"RTN","PSOLLL6",56,0)
 I SKP,'LC(4) D PRINT(""),PRINT("")
"RTN","PSOLLL6",57,0)
 D:SKP<16 PRINT("")
"RTN","PSOLLL6",58,0)
 S SKP=PSOYI*$S(PSOLAN=2:4,1:2)+PSOY I SKP>PSOYM Q
"RTN","PSOLLL6",59,0)
 I $G(PSOLAN)=2 D  Q
"RTN","PSOLLL6",60,0)
 . S T="La Notificacion relacionada con las Politicas de Privacidad del Departamento de Asuntos del Veterano, IB 10-163, contiene los" D PRINT(T)
"RTN","PSOLLL6",61,0)
 . S T="detalles acerca de sus derechos de privacidad y esta disponsible electronicamente en la siguiente direccion:" D PRINT(T)
"RTN","PSOLLL6",62,0)
 . S T="http://www1.va.gov/Health/.  Usted tambien puede conseguir una copia escribiendo a la Oficina de Privacidad del" D PRINT(T)
"RTN","PSOLLL6",63,0)
 . S T="Departamento de Asuntos de Salud del Veterano, (19F2), 810 Vermont Avenue NW, Washington, DC 20420." D PRINT(T)
"RTN","PSOLLL6",64,0)
 S T="The VA Notice of Privacy Practices, IB 10-163, which outlines your privacy rights, is available online at http://www1.va.gov/Health/" D PRINT(T)
"RTN","PSOLLL6",65,0)
 S T="or you may obtain a copy by writing the VHA Privacy Office (19F2), 810 Vermont Avenue NW, Washington, DC 20420." D PRINT(T)
"RTN","PSOLLL6",66,0)
 Q
"RTN","PSOLMUTL")
0^1^B11386551^B10572703
"RTN","PSOLMUTL",1,0)
PSOLMUTL ;BIR/SAB - listman utilities ;03/07/95
"RTN","PSOLMUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**19,46,84,99,131,132,148,268,225,305**;DEC 1997;Build 8
"RTN","PSOLMUTL",3,0)
 ;External reference FULL^VALM1 supported by dbia 10116
"RTN","PSOLMUTL",4,0)
 ;External reference $$SETSTR^VALM1 supported by dbia 10116
"RTN","PSOLMUTL",5,0)
 ;External reference EN2^GMRAPEMO supported by dbia 190
"RTN","PSOLMUTL",6,0)
 ;External reference to ^ORD(101 supported by DBIA 872
"RTN","PSOLMUTL",7,0)
 ;External reference to RE^VALM4 supported by dbia 10120
"RTN","PSOLMUTL",8,0)
 ;
"RTN","PSOLMUTL",9,0)
EN W @IOF S VALMCNT=0
"RTN","PSOLMUTL",10,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!?5,"Site parameter must be defined!",! G INITQ
"RTN","PSOLMUTL",11,0)
 D EN^PSOLMPI
"RTN","PSOLMUTL",12,0)
INITQ Q
"RTN","PSOLMUTL",13,0)
HDR ;patient med profile display
"RTN","PSOLMUTL",14,0)
 K VALMHDR S HDR=^TMP("PSOHDR",$J,1,0)
"RTN","PSOLMUTL",15,0)
 S:^TMP("PSOHDR",$J,8,0) X=IORVON_"<A>"_IORVOFF,HDR=$$SETSTR^VALM1(X,HDR,80-$L(X),80) S VALMHDR(1)=HDR
"RTN","PSOLMUTL",16,0)
 I '(^TMP("PSOHDR",$J,8,0)) S PSONOAL="" D ALLERGY^PSOORUT2 I PSONOAL'="" D  K PSONOAL
"RTN","PSOLMUTL",17,0)
 .S X=IORVON_"<NO ALLERGY ASSESSMENT>"_IORVOFF,HDR=$$SETSTR^VALM1(X,HDR,80-$L(X),80) S VALMHDR(1)=HDR
"RTN","PSOLMUTL",18,0)
 S HDR="  PID: "_^TMP("PSOHDR",$J,2,0)
"RTN","PSOLMUTL",19,0)
 S VALMHDR(2)=$$SETSTR^VALM1("Ht(cm): "_^TMP("PSOHDR",$J,7,0),HDR,52,27)
"RTN","PSOLMUTL",20,0)
 S HDR="  DOB: "_^TMP("PSOHDR",$J,3,0)_" ("_^TMP("PSOHDR",$J,4,0)_")"
"RTN","PSOLMUTL",21,0)
 S VALMHDR(3)=$$SETSTR^VALM1(" Wt(kg): "_^TMP("PSOHDR",$J,6,0),HDR,51,28)
"RTN","PSOLMUTL",22,0)
 S HDR="  SEX: "_$E(^TMP("PSOHDR",$J,5,0),1,44)
"RTN","PSOLMUTL",23,0)
 S VALMHDR(4)=HDR
"RTN","PSOLMUTL",24,0)
 S $P(VALMHDR(4)," ",30)="  "_$E(^TMP("PSOHDR",$J,5,0),48,80)
"RTN","PSOLMUTL",25,0)
 Q:$G(PS)="VIEW"!($G(PS)="DELETE")
"RTN","PSOLMUTL",26,0)
 S VALMHDR(5)=$G(^TMP("PSOHDR",$J,9,0))
"RTN","PSOLMUTL",27,0)
 S VALMHDR(6)=$G(^TMP("PSOHDR",$J,10,0))
"RTN","PSOLMUTL",28,0)
 Q
"RTN","PSOLMUTL",29,0)
 ;
"RTN","PSOLMUTL",30,0)
NEWALL(DFN) ; Enter Allergy info.
"RTN","PSOLMUTL",31,0)
 N PSOID D FULL^VALM1,EN2^GMRAPEM0,^PSOORUT2 S VALMBCK="R"
"RTN","PSOLMUTL",32,0)
 Q
"RTN","PSOLMUTL",33,0)
NEWSEL ;allows order selection by number instead of action
"RTN","PSOLMUTL",34,0)
 S Y=$P(XQORNOD(0),"=",2) N VALMCNT D NEWSEL^PSOORNE2
"RTN","PSOLMUTL",35,0)
 Q
"RTN","PSOLMUTL",36,0)
EDTSEL ;allows edit selection by number instead of action - active orders
"RTN","PSOLMUTL",37,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D EDTSEL^PSOOREDT
"RTN","PSOLMUTL",38,0)
 Q
"RTN","PSOLMUTL",39,0)
SELAL ;selection of allergy by number instead of action - select allergy
"RTN","PSOLMUTL",40,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D SELAL^PSOORDA
"RTN","PSOLMUTL",41,0)
 Q
"RTN","PSOLMUTL",42,0)
EDTNEW ;allows edit selection by number instead of action - new orders
"RTN","PSOLMUTL",43,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D EDTSEL^PSOORNE1
"RTN","PSOLMUTL",44,0)
 Q
"RTN","PSOLMUTL",45,0)
EDTRNEW ;allows edit selection by number instead of action - renew orders
"RTN","PSOLMUTL",46,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D EDTSEL^PSOORNE4
"RTN","PSOLMUTL",47,0)
 Q
"RTN","PSOLMUTL",48,0)
EDTPEN ;allows edit selection by number instead of action - pending orders
"RTN","PSOLMUTL",49,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2),SEDT=1 G EDTSEL^PSOORNEW
"RTN","PSOLMUTL",50,0)
 Q
"RTN","PSOLMUTL",51,0)
HLDHDR ;keeps patient's header info
"RTN","PSOLMUTL",52,0)
 S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSOLMUTL",53,0)
 Q
"RTN","PSOLMUTL",54,0)
 ;
"RTN","PSOLMUTL",55,0)
BYPASS S:$G(PSOFDR) SIGOK=1 S Y=-1,VALMBCK="Q"
"RTN","PSOLMUTL",56,0)
 Q
"RTN","PSOLMUTL",57,0)
ACTIONS() ;screen actions on active orders
"RTN","PSOLMUTL",58,0)
 Q:$G(PKI1)=2 0
"RTN","PSOLMUTL",59,0)
 N DIC,X,Y K DIC,Y S DIC="^ORD(101,"_DA(1)_",10,",X=DA,DIC(0)="ZN" D ^DIC Q:Y<0 0
"RTN","PSOLMUTL",60,0)
 S Y=Y(0,0)
"RTN","PSOLMUTL",61,0)
 I Y="PSO REFILL" Q $S(PSOACT["R":1,1:0)
"RTN","PSOLMUTL",62,0)
 I Y="PSO RENEW" Q $S(PSOACT["N":1,1:0)
"RTN","PSOLMUTL",63,0)
 I Y="PSO REPRINT" Q $S(PSOACT["P":1,1:0)
"RTN","PSOLMUTL",64,0)
 I Y="PSO EDIT ORDERS" Q $S(PSOACT["E":1,1:0)
"RTN","PSOLMUTL",65,0)
 I Y="PSO RELEASE" Q $S(PSOACT["L":1,1:0)
"RTN","PSOLMUTL",66,0)
 I Y="PSO PARTIAL" Q $S(PSOACT["T":1,1:0)
"RTN","PSOLMUTL",67,0)
 I Y="PSO CANCEL" Q $S(PSOACT["D":1,1:0)
"RTN","PSOLMUTL",68,0)
 I Y="PSO HOLD" Q $S(PSOACT["H":1,1:0)
"RTN","PSOLMUTL",69,0)
 I Y="PSO UNHOLD" Q $S(PSOACT["U":1,1:0)
"RTN","PSOLMUTL",70,0)
 I Y="PSO LM BACKDOOR COPY" Q $S(PSOACT["C":1,1:0)
"RTN","PSOLMUTL",71,0)
 I Y="PSO VERIFY" Q $S(PSOACT["V":1,1:0)
"RTN","PSOLMUTL",72,0)
 I Y="PSO ACTIVITY LOGS" Q 1
"RTN","PSOLMUTL",73,0)
 Q 1
"RTN","PSOLMUTL",74,0)
ACTIONS1() ;screen actions on pending orders
"RTN","PSOLMUTL",75,0)
 Q:$G(PKI1)=2 0
"RTN","PSOLMUTL",76,0)
 N DIC,X,Y K DIC,Y S DIC="^ORD(101,"_DA(1)_",10,",X=DA,DIC(0)="ZN" D ^DIC Q:Y<0 0
"RTN","PSOLMUTL",77,0)
 S Y=Y(0,0)
"RTN","PSOLMUTL",78,0)
 I Y="PSO LM DISCONTINUE" Q $S(PSOACT["D":1,1:0)
"RTN","PSOLMUTL",79,0)
 I Y="PSO LM EDIT" Q $S(PSOACT["E":1,1:0)
"RTN","PSOLMUTL",80,0)
 I Y="PSO LM FINISH" Q $S(PSOACT["F":1,1:0)
"RTN","PSOLMUTL",81,0)
 I Y="PSO LM FLAG" Q $S(PSOACT["X":1,1:0)
"RTN","PSOLMUTL",82,0)
 Q 1
"RTN","PSOLMUTL",83,0)
PKIACT() ;screen actions on pending orders DEA/PKI proj.
"RTN","PSOLMUTL",84,0)
 Q:$G(PKI1)=2 0
"RTN","PSOLMUTL",85,0)
 Q 1
"RTN","PSOLMUTL",86,0)
RFDSP ;screen action to toggle display of prescriptions between LAST FILL date and LAST RELEASE Date.
"RTN","PSOLMUTL",87,0)
 S PSORFG='$G(PSORFG)
"RTN","PSOLMUTL",88,0)
 I '$D(PSOSD) D ^PSOBUILD
"RTN","PSOLMUTL",89,0)
 D ^PSOORUT2,BLD^PSOORUT1
"RTN","PSOLMUTL",90,0)
 K VALMHDR
"RTN","PSOLMUTL",91,0)
 D RE^VALM4
"RTN","PSOLMUTL",92,0)
 Q
"RTN","PSOORUT1")
0^2^B71052534^B67437810
"RTN","PSOORUT1",1,0)
PSOORUT1 ;BIR/SAB - Utility routine for oerr interface ;6/28/07 7:36am
"RTN","PSOORUT1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,14,30,46,132,148,233,274,225,305**;DEC 1997;Build 8
"RTN","PSOORUT1",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORUT1",4,0)
 ;External reference to ^PSXOPUTL supported by DBIA 2203
"RTN","PSOORUT1",5,0)
 ;called from HD^PSOORUTL
"RTN","PSOORUT1",6,0)
REL ;removed order from hold
"RTN","PSOORUT1",7,0)
 S ACT=1,ORS=0
"RTN","PSOORUT1",8,0)
 I POERR("PSOFILNM")["S" S DA=+POERR("PSOFILNM") D  G EXIT^PSOORUTL
"RTN","PSOORUT1",9,0)
 .Q:'$D(^PS(52.41,DA,0))  Q:$P(^PS(52.41,DA,0),"^",3)="RF"
"RTN","PSOORUT1",10,0)
 .S $P(^PS(52.41,DA,0),"^",3)="NW",POERR("STAT")="OR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUT1",11,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order RELEASED from HOLD by OE/RR before finished." S $P(^PS(52.41,DA,4),"^")=POERR("COMM"),ORS=1
"RTN","PSOORUT1",12,0)
 S DA=POERR("PSOFILNM") I $D(^PSRX(DA,0)) S ORS=1,PSDA=DA D  G EXIT^PSOORUTL
"RTN","PSOORUT1",13,0)
 .S POERR("FILLER")=DA_"^R",POERR("STAT")="OR"
"RTN","PSOORUT1",14,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription Released from HOLD by OE/RR"
"RTN","PSOORUT1",15,0)
 .I DT>$P(^PSRX(DA,2),"^",6) D
"RTN","PSOORUT1",16,0)
 ..S EXP=$P(^PSRX(DA,2),"^",6) S:$P(^PSRX(DA,"STA"),"^")<12 $P(^PSRX(DA,"STA"),"^")=11,PSOEXFLG=1 S POERR("STAT")="UR",POERR("COMM")="Medication Expired on "_$E(EXP,4,5)_"/"_$E(EXP,6,7)_"/"_$E(EXP,2,3)_".",POERR("PHARMST")="" D ECAN^PSOUTL(DA) Q
"RTN","PSOORUT1",17,0)
 .I $P(^PSRX(DA,"STA"),"^")'=16 S POERR("STAT")="UR",POERR("COMM")="Unable to Release from Hold" Q
"RTN","PSOORUT1",18,0)
 .S RXFL(DA)=0,FDT=$P(^PSRX(DA,2),"^",2)
"RTN","PSOORUT1",19,0)
 .I $O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S FDT=$P(^PSRX(DA,1,I,0),"^"),RXFL(DA)=I
"RTN","PSOORUT1",20,0)
 .I FDT>DT N PSOSITEZ,ZPSOPAR6 S PSOSITEZ=$S($P($G(^PSRX(DA,2)),"^",9):$P(^(2),"^",9),1:$O(^PS(59,0))),ZPSOPAR6=$P($G(^PS(59,PSOSITEZ,1)),"^",6) I ZPSOPAR6 D  Q
"RTN","PSOORUT1",21,0)
 ..S RXXDA=DA,DA=$O(^PS(52.5,"B",RXXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORUT1",22,0)
 ..S DA=RXXDA
"RTN","PSOORUT1",23,0)
 ..S DIC="^PS(52.5,",DIC(0)="L",DLAYGO=52.5,X=RXXDA,DIC("DR")=".02///"_FDT_";.03////"_$P(^PSRX(DA,0),"^",2)_";.04///M;.05///0;.06////"_PSOSITEZ_";2///0;9///"_RXFL(DA) K DD,DO D FILE^DICN K RXFL,DD,DO
"RTN","PSOORUT1",24,0)
 ..S DA=RXXDA K RXXDA S $P(^PSRX(DA,"STA"),"^")=5,LFD=$E(FDT,4,5)_"-"_$E(FDT,6,7)_"-"_$E(FDT,2,3) D ACT1
"RTN","PSOORUT1",25,0)
 ..S PSOSUSZ=1
"RTN","PSOORUT1",26,0)
 .E  S $P(^PSRX(DA,"STA"),"^")=0
"RTN","PSOORUT1",27,0)
 .S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",28,0)
 .D ACT^PSOORUTL
"RTN","PSOORUT1",29,0)
 .I $$SUBMIT^PSOBPSUT(DA) D ECMESND^PSOBPSU1(DA,,$$RXFLDT^PSOBPSUT(DA),$S('$O(^PSRX(DA,1,0)):"OF",1:"RF"))
"RTN","PSOORUT1",30,0)
 G EXIT^PSOORUTL
"RTN","PSOORUT1",31,0)
ACT1 S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOORUT1",32,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOORUT1",33,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOORUT1",34,0)
 D NOW^%DTC S ^PSRX(DA,"A",IR,0)=%_"^S^"_POERR("USER")_"^"_RXF_"^"_"RX Placed on Suspense until "_LFD
"RTN","PSOORUT1",35,0)
 Q
"RTN","PSOORUT1",36,0)
SUS ;
"RTN","PSOORUT1",37,0)
 I $P($G(^PSRX(+$G(FILLER),"STA")),"^")=5 N PSOMSORR,PLACERXX D EN^PSOHLSN1(+$G(FILLER),"SC","ZS","")
"RTN","PSOORUT1",38,0)
 Q
"RTN","PSOORUT1",39,0)
BLD ;builds med profile for Listman
"RTN","PSOORUT1",40,0)
 K ^TMP("PSOPF",$J),PSOLST S:$G(PSOOPT)'=3 PSOOPT=0 I '$G(PSOSD) S ^TMP("PSOPF",$J,1,0)="This patient has no prescriptions" S PSOCNT=0,PSOPF=1 Q
"RTN","PSOORUT1",41,0)
 D EOJ,SHOW
"RTN","PSOORUT1",42,0)
EOJ ;
"RTN","PSOORUT1",43,0)
 K PSOQFLG,PSODRG,PSODATA,PSOLF
"RTN","PSOORUT1",44,0)
 Q
"RTN","PSOORUT1",45,0)
 ;-----------------------------------------------------------------
"RTN","PSOORUT1",46,0)
SHOW ;
"RTN","PSOORUT1",47,0)
 ; - ePharmacy modification to create a section for Rx with REJECTs
"RTN","PSOORUT1",48,0)
 N PSOTMP,PSOSTS,PSODRNM,I,PSORX
"RTN","PSOORUT1",49,0)
 S (PSOSTS,PSODRNM)=""
"RTN","PSOORUT1",50,0)
 F  S PSOSTS=$O(PSOSD(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",51,0)
 . F  S PSODRNM=$O(PSOSD(PSOSTS,PSODRNM)) Q:PSODRNM=""  D
"RTN","PSOORUT1",52,0)
 . . S PSORX=+$G(PSOSD(PSOSTS,PSODRNM))
"RTN","PSOORUT1",53,0)
 . . I PSOSTS="ACTIVE",$$FIND^PSOREJUT(PSORX) D  Q
"RTN","PSOORUT1",54,0)
 . . . S PSOTMP(" REJECT",PSODRNM)=PSOSTS
"RTN","PSOORUT1",55,0)
 . . S PSOTMP(PSOSTS,PSODRNM)=PSOSTS
"RTN","PSOORUT1",56,0)
 ;
"RTN","PSOORUT1",57,0)
 S (PSOSTS,PSODRG)="",(PSOCNT,PSOQFLG,IEN)=0
"RTN","PSOORUT1",58,0)
 K RN,DL S $P(RN," ",12)=" ",$P(DL," ",40)=" "
"RTN","PSOORUT1",59,0)
 F PSCNT=0:0 S PSOSTS=$O(PSOTMP(PSOSTS)) Q:PSOSTS=""  D
"RTN","PSOORUT1",60,0)
 . D STA
"RTN","PSOORUT1",61,0)
 . F PSOCT=0:0 S PSODRG=$O(PSOTMP(PSOSTS,PSODRG)) Q:PSODRG=""  Q:PSOCNT>1000!PSOQFLG  D
"RTN","PSOORUT1",62,0)
 . . S PSOSTA=PSOTMP(PSOSTS,PSODRG)
"RTN","PSOORUT1",63,0)
 . . S PSODATA=PSOSD(PSOSTA,PSODRG) I PSOSTA="ZNONVA" D NVA Q
"RTN","PSOORUT1",64,0)
 . . S PSOCNT=PSOCNT+1 I PSOSTA="PENDING" D PEN Q
"RTN","PSOORUT1",65,0)
 . . S:'$D(^PSRX(+PSODATA,0)) PSOCNT=PSOCNT-1 D:$D(^(0)) DISPL
"RTN","PSOORUT1",66,0)
 S (VALMCNT,PSOPF)=IEN
"RTN","PSOORUT1",67,0)
SHOWX K DIRUT,DTOUT,DUOUT,DIROUT,PSODRG
"RTN","PSOORUT1",68,0)
 Q
"RTN","PSOORUT1",69,0)
 ;
"RTN","PSOORUT1",70,0)
DISPL S IEN=IEN+1 N PSOID,PSOCMOP,STATLTH,ECME
"RTN","PSOORUT1",71,0)
 K PSOLNT,PSOQTL,PSOLSP S PSOLRX=$S($G(^PSRX(+PSODATA,"IB")):13,1:14)-$L($P(^PSRX(+PSODATA,0),"^")),$P(PSOLNT," ",PSOLRX)=" ",PSODQL=$L($P(PSODRG,"^"))+$L($P(^PSRX(+PSODATA,0),"^",7))
"RTN","PSOORUT1",72,0)
 I PSODQL<39 S $P(PSOQTL," ",(40-PSODQL))=" "
"RTN","PSOORUT1",73,0)
 E  S $P(PSOQTL," ",(52-$L($P(^PSRX(+PSODATA,0),"^",7))))=" ",$P(PSOLSP," ",(41-$L($P(PSODRG,"^"))))=" "
"RTN","PSOORUT1",74,0)
 S ECME=$$ECME^PSOBPSUT(+PSODATA) I ECME'="" S PSOLNT=$E(PSOLNT,1,$L(PSOLNT)-1)
"RTN","PSOORUT1",75,0)
 S ^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$P(^PSRX(+PSODATA,0),"^")_$S($G(^PSRX(+PSODATA,"IB")):"$",1:"")_ECME_PSOLNT_$P(PSODRG,"^")_$S(PSODQL<39:PSOQTL_$P(^PSRX(+PSODATA,0),"^",7)_" ",1:$G(PSOLSP))
"RTN","PSOORUT1",76,0)
 S STA="A^N^R^H^N^S^^^^^^E^DC^^DC^DE^H^P^"
"RTN","PSOORUT1",77,0)
 S PSOCMOP=""
"RTN","PSOORUT1",78,0)
 I $D(^PSDRUG("AQ",$P(^PSRX(+PSODATA,0),"^",6))) S PSOCMOP=">"
"RTN","PSOORUT1",79,0)
 N X S X="PSXOPUTL" X ^%ZOSF("TEST") K X I $T D
"RTN","PSOORUT1",80,0)
 .N DA S DA=+PSODATA D ^PSXOPUTL K DA
"RTN","PSOORUT1",81,0)
 .I $G(PSXZ(PSXZ("L")))=0!($G(PSXZ(PSXZ("L")))=2) S PSOCMOP="T"
"RTN","PSOORUT1",82,0)
 .K PSXZ
"RTN","PSOORUT1",83,0)
 N PSOBADR
"RTN","PSOORUT1",84,0)
 S PSOBADR=$O(^PSRX(+PSODATA,"L",9999),-1)
"RTN","PSOORUT1",85,0)
 I PSOBADR'="" S PSOBADR=$G(^PSRX(+PSODATA,"L",PSOBADR,0)) I PSOBADR["(BAD ADDRESS)" S PSOBADR="B"
"RTN","PSOORUT1",86,0)
 I PSOBADR'="B" S PSOBADR=""
"RTN","PSOORUT1",87,0)
 S STAPRT=$P(STA,"^",$P(PSODATA,"^",2)+1)_PSOCMOP_PSOBADR
"RTN","PSOORUT1",88,0)
 S STATLTH=$L(STAPRT)
"RTN","PSOORUT1",89,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_STAPRT_$S(STATLTH=0:"   ",STATLTH=1:"  ",STATLTH=2:" ",1:"")
"RTN","PSOORUT1",90,0)
 S PSOID=$P(^PSRX(+PSODATA,0),"^",13),PSOLF=+$G(^(3)),^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$E(PSOID,4,5)_"-"_$E(PSOID,6,7)_" "
"RTN","PSOORUT1",91,0)
 N RFLZRO,PSOLRD S PSOLRD=$P($G(^PSRX(+PSODATA,2)),"^",13)
"RTN","PSOORUT1",92,0)
 F PSOX=0:0 S PSOX=$O(^PSRX(+PSODATA,1,PSOX)) Q:'PSOX  D
"RTN","PSOORUT1",93,0)
 . S RFLZRO=$G(^PSRX(+PSODATA,1,PSOX,0))
"RTN","PSOORUT1",94,0)
 . I +RFLZRO=PSOLF,$P(RFLZRO,"^",16) S PSOLF=PSOLF_"^R"
"RTN","PSOORUT1",95,0)
 . S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",96,0)
 K PSOX
"RTN","PSOORUT1",97,0)
 I '$O(^PSRX(+PSODATA,1,0)),$P(^PSRX(+PSODATA,2),"^",15) S PSOLF=PSOLF_"^R",PSOLRD=PSOLRD_"^R"
"RTN","PSOORUT1",98,0)
 S PSOLF=$S($G(PSOLF):$E(PSOLF,4,5),1:"  ")_"-"_$S($G(PSOLF):$E(PSOLF,6,7),1:"  ")_$S($P(PSOLF,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",99,0)
 S PSOLRD=$S($G(PSOLRD):$E(PSOLRD,4,5),1:"  ")_"-"_$S($G(PSOLRD):$E(PSOLRD,6,7),1:"  ")_$S($P(PSOLRD,"^",2)="R":"R ",1:"  ")
"RTN","PSOORUT1",100,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$S($G(PSORFG):PSOLRD,1:PSOLF)
"RTN","PSOORUT1",101,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$J($P(PSODATA,"^",6),2)_" "_$J($P(PSODATA,"^",8),3)
"RTN","PSOORUT1",102,0)
 I PSODQL>38 S IEN=IEN+1 S ^TMP("PSOPF",$J,IEN,0)=PSOQTL_"Qty: "_$P(^PSRX(+PSODATA,0),"^",7)
"RTN","PSOORUT1",103,0)
 K PSOLNT,PSOQTL,PSOLSP,PSOLRX,PSODQL
"RTN","PSOORUT1",104,0)
 S PSOLST(PSOCNT)="52^"_+PSODATA_"^"_PSOSTA
"RTN","PSOORUT1",105,0)
 K PSODATA,PSOLF S PSOPF=IEN
"RTN","PSOORUT1",106,0)
 Q
"RTN","PSOORUT1",107,0)
 ;
"RTN","PSOORUT1",108,0)
STA N LABEL,LINE,POS
"RTN","PSOORUT1",109,0)
 S LABEL=PSOSTS,IEN=IEN+1
"RTN","PSOORUT1",110,0)
 I PSOSTS="ZNONVA" S LABEL="Non-VA MEDS (Not dispensed by VA)"
"RTN","PSOORUT1",111,0)
 I PSOSTS=" REJECT" S LABEL="REFILL TOO SOON/DUR REJECTS (Third Party)"
"RTN","PSOORUT1",112,0)
 S POS=80-$L(LABEL)/2,$P(LINE,"-",81)="",$E(LINE,POS+1,POS+$L(LABEL))=LABEL
"RTN","PSOORUT1",113,0)
 S ^TMP("PSOPF",$J,IEN,0)=LINE
"RTN","PSOORUT1",114,0)
 Q
"RTN","PSOORUT1",115,0)
PENX S PSOLST(PSOCNT)="52.41^"_$P(PSODATA,"^",10)_"^"_PSOSTA
"RTN","PSOORUT1",116,0)
 K PSODATA,PSOLF,RN,PSOLSP,PSOQTL,PSOLNT
"RTN","PSOORUT1",117,0)
 Q
"RTN","PSOORUT1",118,0)
PEN ;
"RTN","PSOORUT1",119,0)
 N PSOQTL,PSOLNT,PSOLNTZ,PSOQTLX,PSCMOPF,SPACEZ
"RTN","PSOORUT1",120,0)
 Q:'$D(^PS(52.41,$P(PSODATA,"^",10),0))
"RTN","PSOORUT1",121,0)
 S PSCMOPF=0 I $P($G(PSODATA),"^",11),$D(^PSDRUG("AQ",$P(PSODATA,"^",11))) S PSCMOPF=1
"RTN","PSOORUT1",122,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)=$J(PSOCNT,2)_$S($L(PSOCNT)<3:" ",1:"")_$P(PSODRG,"^")
"RTN","PSOORUT1",123,0)
 I $P($G(^PS(52.41,+$P(PSODATA,"^",10),0)),"^",23)=1 S ^TMP("PSOPF",$J,IEN,"RV")=""
"RTN","PSOORUT1",124,0)
 S PSOLNT=$L($P(PSODRG,"^")),PSOLNTZ=$L($P(PSODATA,"^",8))
"RTN","PSOORUT1",125,0)
 S $P(PSOQTLX," ",(11-PSOLNTZ))=" "
"RTN","PSOORUT1",126,0)
 S:PSOLNT<37 $P(PSOQTL," ",(37-PSOLNT))=" "
"RTN","PSOORUT1",127,0)
 I PSOLNT<38 D  G PENX
"RTN","PSOORUT1",128,0)
 .I PSOLNT=37 S PSOQTL=""
"RTN","PSOORUT1",129,0)
 .I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") Q
"RTN","PSOORUT1",130,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$G(PSOQTL)_"  "_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")
"RTN","PSOORUT1",131,0)
 .S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")_$P(PSODATA,"^",6)
"RTN","PSOORUT1",132,0)
 S IEN=IEN+1,$P(SPACEZ," ",42)=" "
"RTN","PSOORUT1",133,0)
 I $P(^PS(52.41,$P(PSODATA,"^",10),0),"^",3)="RF" S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"Refill Request   Rx #: "_$P(^PSRX($P(^PS(52.41,$P(PSODATA,"^",10),0),"^",19),0),"^") G PENX
"RTN","PSOORUT1",134,0)
 S ^TMP("PSOPF",$J,IEN,0)=SPACEZ_"QTY: "_$P(PSODATA,"^",8)_$G(PSOQTLX)_" ISDT: "_$S('$P(PSODATA,"^",9):"     ",1:$E($P(PSODATA,"^",9),4,5)_"-"_$E($P(PSODATA,"^",9),6,7))_$S($G(PSCMOPF):"> ",1:"  ")_"REF: "_$S($L($P(PSODATA,"^",6))>1:"",1:" ")
"RTN","PSOORUT1",135,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)
"RTN","PSOORUT1",136,0)
 G PENX
"RTN","PSOORUT1",137,0)
 ;
"RTN","PSOORUT1",138,0)
NVA ; Setting the Non-VA Meds on the Medication Profile Screen (ListMan)
"RTN","PSOORUT1",139,0)
 S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="  "_$P(PSODRG,"^")_" "
"RTN","PSOORUT1",140,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",6))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",141,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",6)_" "
"RTN","PSOORUT1",142,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+$L($P(PSODATA,"^",8))>70) S IEN=IEN+1,^TMP("PSOPF",$J,IEN,0)="    "
"RTN","PSOORUT1",143,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_$P(PSODATA,"^",8)
"RTN","PSOORUT1",144,0)
 I ($L(^TMP("PSOPF",$J,IEN,0))+20)>70 D  Q
"RTN","PSOORUT1",145,0)
 . S IEN=IEN+1,$P(^TMP("PSOPF",$J,IEN,0)," ",51)="Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",146,0)
 F I=0:0 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_" " Q:$L(^TMP("PSOPF",$J,IEN,0))>49
"RTN","PSOORUT1",147,0)
 S ^TMP("PSOPF",$J,IEN,0)=^TMP("PSOPF",$J,IEN,0)_"Date Documented: "_$E($P(PSODATA,"^",9),4,5)_"/"_$E($P(PSODATA,"^",9),6,7)_"/"_$E($P(PSODATA,"^",9),2,3)
"RTN","PSOORUT1",148,0)
 Q
"RTN","PSOORUT2")
0^3^B65940792^B65711274
"RTN","PSOORUT2",1,0)
PSOORUT2 ;ISC BHAM/SAB - build listman screen ; 3/20/07 9:47am
"RTN","PSOORUT2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,146,132,182,233,243,261,268,264,305**;DEC 1997;Build 8
"RTN","PSOORUT2",3,0)
 ;External reference to SDPHARM1 supported by DBIA 4196
"RTN","PSOORUT2",4,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORUT2",5,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSOORUT2",6,0)
 ;External reference ^DPT(D0,.372 supported by DBIA 1476
"RTN","PSOORUT2",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOORUT2",8,0)
 ;External references to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOORUT2",9,0)
 ;
"RTN","PSOORUT2",10,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) S DFN=PSODFN D ^VADPT,ADD^VADPT
"RTN","PSOORUT2",11,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSOORUT2",12,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2),^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSOORUT2",13,0)
 D NVA
"RTN","PSOORUT2",14,0)
 S POERR=1 D RE^PSODEM K POERR
"RTN","PSOORUT2",15,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSOORUT2",16,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSOORUT2",17,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSOORUT2",18,0)
 S $P(^TMP("PSOHDR",$J,9,0)," ",62)="ISSUE  LAST REF DAY"
"RTN","PSOORUT2",19,0)
 S ^TMP("PSOHDR",$J,10,0)=" #  RX #         DRUG                                 QTY ST  DATE  "_$S($G(PSORFG):"RELD",1:"FILL")_" REM SUP"
"RTN","PSOORUT2",20,0)
 D ELIG^VADPT S IEN=1,^TMP("PSOPI",$J,IEN,0)="Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:""),IEN=IEN+1
"RTN","PSOORUT2",21,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  S $P(^TMP("PSOPI",$J,IEN,0)," ",14)=$P(VAEL(1,N),"^",2),IEN=IEN+1
"RTN","PSOORUT2",22,0)
 S ^TMP("PSOPI",$J,IEN,0)="",^TMP("PSOPI",$J,IEN,0)="RX PATIENT STATUS: "_$$GET1^DIQ(55,PSODFN,3),IEN=IEN+1
"RTN","PSOORUT2",23,0)
 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Disabilities: "
"RTN","PSOORUT2",24,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOORUT2",25,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOORUT2",26,0)
 .S:$L(^TMP("PSOPI",$J,IEN,0)_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 IEN=IEN+1,$P(^TMP("PSOPI",$J,IEN,0)," ",14)=" "
"RTN","PSOORUT2",27,0)
 .S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOORUT2",28,0)
 S IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1
"RTN","PSOORUT2",29,0)
 I +VAPA(9) S ^TMP("PSOPI",$J,IEN,0)="      (Temp Address from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")",IEN=IEN+1
"RTN","PSOORUT2",30,0)
 S ^TMP("PSOPI",$J,IEN,0)=VAPA(1) S:VAPA(2)]"" IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(2) S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(3)
"RTN","PSOORUT2",31,0)
 S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(VAPA(3)))_"HOME PHONE: "_VAPA(8)
"RTN","PSOORUT2",32,0)
 S PSOTEL=$G(^DPT(DFN,.13))
"RTN","PSOORUT2",33,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(4),^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(VAPA(4)))_"CELL PHONE: "_$P(PSOTEL,"^",4)
"RTN","PSOORUT2",34,0)
 S PSOTMP=$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSOTMP
"RTN","PSOORUT2",35,0)
 S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(PSOTMP))_"WORK PHONE: "_$P(PSOTEL,"^",2)
"RTN","PSOORUT2",36,0)
 S MAILD=+$P($G(^PS(55,DFN,0)),"^",3) D  K MAILD
"RTN","PSOORUT2",37,0)
 .S PSOTMP="Prescription Mail Delivery: "_$S(MAILD=1:"Certified Mail",MAILD=2:"DO NOT MAIL",MAILD=3:"Local - Regular Mail",MAILD=4:"Local - Certified Mail",1:"Regular Mail") S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSOTMP
"RTN","PSOORUT2",38,0)
 .I MAILD<2!(MAILD>4) Q  ;ONLY FOR MAIL DELIVERIES 2,3,4
"RTN","PSOORUT2",39,0)
 .N PSOMDEXP,Y
"RTN","PSOORUT2",40,0)
 .S Y=$P($G(^PS(55,DFN,0)),"^",5)
"RTN","PSOORUT2",41,0)
 .I Y,Y'>DT D
"RTN","PSOORUT2",42,0)
 ..D DD^%DT S PSOMDEXP=Y
"RTN","PSOORUT2",43,0)
 ..S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_" Expire Date: "_PSOMDEXP
"RTN","PSOORUT2",44,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=$S($P($G(^PS(55,DFN,0)),"^",2):"Cannot use safety caps.",1:"") S $P(^TMP("PSOPI",$J,IEN,0)," ",40)=$S($P($G(^PS(55,DFN,0)),"^",4):"Dialysis Patient.",1:"")
"RTN","PSOORUT2",45,0)
 I $G(^PS(55,DFN,1))]"" S PSON=^(1),IEN=IEN+1 D
"RTN","PSOORUT2",46,0)
 .S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="     Outpatient Narrative: "
"RTN","PSOORUT2",47,0)
 .F I=1:1 Q:$P(PSON," ",I,99)=""  S:$L(^TMP("PSOPI",$J,IEN,0)_$P(PSON," ",I)_" ")>80 IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_$P(PSON," ",I)_" "
"RTN","PSOORUT2",48,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",49,0)
 I $D(^PS(52.91,DFN,0)) I '$P(^(0),"^",3)!($P(^(0),"^",3)>DT) D
"RTN","PSOORUT2",50,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Primary Care Appointment: "_$$PRIAPT^SDPHARM1(DFN)
"RTN","PSOORUT2",51,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",52,0)
 I 'GMRAL D
"RTN","PSOORUT2",53,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:"")
"RTN","PSOORUT2",54,0)
 .I GMRAL'=0 S PSONOAL="" D ALLERGY I PSONOAL'="" S ^TMP("PSOPI",$J,IEN,0)="Allergies: "_PSONOAL K PSONOAL
"RTN","PSOORUT2",55,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",56,0)
 .D REMOTE
"RTN","PSOORUT2",57,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOORUT2",58,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOORUT2",59,0)
 K ^UTILITY("VASD",$J),VASD S DFN=PSODFN,VASD("F")=DT,VASD("T")=9999999,VASD("W")="123456789" D SDA^VADPT K VASD I $D(^UTILITY("VASD",$J)) D
"RTN","PSOORUT2",60,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Pending Clinic Appointments:"
"RTN","PSOORUT2",61,0)
 .F PSOAPP=0:0 S PSOAPP=$O(^UTILITY("VASD",$J,PSOAPP)) Q:'PSOAPP  S PSOAPPE=$G(^UTILITY("VASD",$J,PSOAPP,"E")),PSOAPPI=$G(^("I")) D
"RTN","PSOORUT2",62,0)
 ..K X S X2=DT,X1=$P($P($G(PSOAPPI),"^"),".") I $G(X1) D ^%DTC
"RTN","PSOORUT2",63,0)
 ..S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="    "_$P(PSOAPPE,"^")_"  "_$P(PSOAPPE,"^",2)_$S($P(PSOAPPI,"^",3)["C":"   *** Canceled ***",1:" ("_$G(X)_" days)")
"RTN","PSOORUT2",64,0)
 K ^UTILITY("VASD",$J),X,PSOAPPI,PSOAPPE,PSOAPP,N
"RTN","PSOORUT2",65,0)
 S PSOPI=IEN K IEN
"RTN","PSOORUT2",66,0)
 Q
"RTN","PSOORUT2",67,0)
NVA ;
"RTN","PSOORUT2",68,0)
 Q:'$O(^PS(55,PSODFN,"NVA",0))
"RTN","PSOORUT2",69,0)
 K LSTDT F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",I)) Q:'I  D
"RTN","PSOORUT2",70,0)
 .Q:$P(^PS(55,PSODFN,"NVA",I,0),"^",7)  Q:'$P(^PS(55,PSODFN,"NVA",I,0),"^")
"RTN","PSOORUT2",71,0)
 .I $P(^PS(55,PSODFN,"NVA",I,0),"^",10)>+$G(LSTDT) S LSTDT=$P(^(0),"^",10)
"RTN","PSOORUT2",72,0)
 I $G(LSTDT)]"" D
"RTN","PSOORUT2",73,0)
 .S LSTDT="Non-VA Meds on File - Last entry on "_$E(LSTDT,4,5)_"/"_$E(LSTDT,6,7)_"/"_$E(LSTDT,2,3)
"RTN","PSOORUT2",74,0)
 .I $G(^TMP("PSOHDR",$J,5,0))="MALE" S $P(^TMP("PSOHDR",$J,5,0)," ",22)=LSTDT K LSTDT Q
"RTN","PSOORUT2",75,0)
 .S $P(^TMP("PSOHDR",$J,5,0)," ",20)=LSTDT K LSTDT
"RTN","PSOORUT2",76,0)
 K I
"RTN","PSOORUT2",77,0)
 Q
"RTN","PSOORUT2",78,0)
REMOTE ;
"RTN","PSOORUT2",79,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOORUT2",80,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOORUT2",81,0)
 N PSORALG,REAC,S1,A,FILE,LEN,I
"RTN","PSOORUT2",82,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",83,0)
 S PSORALG=1,PSORALG(1)="No remote data available"
"RTN","PSOORUT2",84,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSOORUT2",85,0)
 I $T(GET^ORRDI1)]"" S PSOSIEN=$G(IEN) D GET^ORRDI1(DFN,"ART") S IEN=PSOSIEN K PSOSIEN D
"RTN","PSOORUT2",86,0)
 .I $P($G(^XTMP("ORRDI","ART",DFN,0)),"^",3)=0 S PSORALG(1)="No remote allergies"
"RTN","PSOORUT2",87,0)
 .S S1=0,LEN=65,PSORALG=1,PSORALG(1)="" F  S S1=$O(^XTMP("ORRDI","ART",DFN,S1)) Q:'S1  D
"RTN","PSOORUT2",88,0)
 ..S A=$G(^XTMP("ORRDI","ART",DFN,S1,"REACTANT",0)),REAC=$P(A,"^",2),FILE=$P($P(A,"^",3),"99VA",2)
"RTN","PSOORUT2",89,0)
 ..I FILE'=50.6,FILE'=120.82,FILE'=50.605,FILE'=50.416 Q
"RTN","PSOORUT2",90,0)
 ..S ^TMP($J,"PSOART",REAC)=""
"RTN","PSOORUT2",91,0)
 .S REAC="" F  S REAC=$O(^TMP($J,"PSOART",REAC)) Q:REAC=""  D
"RTN","PSOORUT2",92,0)
 ..I $L(PSORALG(PSORALG))+$L(REAC)<LEN S PSORALG(PSORALG)=PSORALG(PSORALG)_REAC_", " Q
"RTN","PSOORUT2",93,0)
 ..S PSORALG=PSORALG+1,PSORALG(PSORALG)="              "_REAC_", ",LEN=76
"RTN","PSOORUT2",94,0)
 .I PSORALG(PSORALG)]"",$E(PSORALG(PSORALG),$L(PSORALG(PSORALG)))="," S PSORALG(PSORALG)=$E(PSORALG(PSORALG),1,$L(PSORALG(PSORALG))-1)
"RTN","PSOORUT2",95,0)
REMOTE2 ;
"RTN","PSOORUT2",96,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="      Remote: "_$G(PSORALG(1)) D
"RTN","PSOORUT2",97,0)
 .F I=2:1:PSORALG S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSORALG(I)
"RTN","PSOORUT2",98,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",99,0)
 Q
"RTN","PSOORUT2",100,0)
  ;
"RTN","PSOORUT2",101,0)
ALLERGY ;ALLERGIES & REACTIONS
"RTN","PSOORUT2",102,0)
 N GMRA,GMRAL,PSORY,ALCNT,EEE,PSOLG,PSOLGA,TEXT,CCC,CCC2
"RTN","PSOORUT2",103,0)
 K ^TMP($J,"PSOALWA")
"RTN","PSOORUT2",104,0)
 I '$D(DFN) S DFN=PSODFN
"RTN","PSOORUT2",105,0)
 S GMRA="0^0^111" D ^GMRADPT
"RTN","PSOORUT2",106,0)
 I $G(GMRAL) S PSORY=0 F  S PSORY=$O(GMRAL(PSORY)) Q:'PSORY  S ^TMP($J,"PSOALWA",$S($P(GMRAL(PSORY),"^",4):1,1:2),$S('$P(GMRAL(PSORY),"^",5):1,1:2),$P(GMRAL(PSORY),"^",7),$P(GMRAL(PSORY),"^",2))=""
"RTN","PSOORUT2",107,0)
 S ^TMP($J,"PSOAPT",1)=$G(PNM)_"  "_$G(SSNP),^(2)="Verified Allergies"
"RTN","PSOORUT2",108,0)
 S ALCNT=0,EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)=PSOLGA
"RTN","PSOORUT2",109,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)="NKA"
"RTN","PSOORUT2",110,0)
 S ALCNT=0,^TMP($J,"PSOAPT",3)="Non-Verified Allergies"
"RTN","PSOORUT2",111,0)
 S EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=EEE+1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)=PSOLGA
"RTN","PSOORUT2",112,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)="NKA"
"RTN","PSOORUT2",113,0)
 S ALCNT=0,^TMP($J,"PSOAPT",4)="Verified Adverse Reactions"
"RTN","PSOORUT2",114,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",4,ALCNT)=PSOLGA
"RTN","PSOORUT2",115,0)
 S ALCNT=0,^TMP($J,"PSOAPT",5)="Non-Verified Adverse Reactions"
"RTN","PSOORUT2",116,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",5,ALCNT)=PSOLGA
"RTN","PSOORUT2",117,0)
 S TEXT=^TMP($J,"PSOAPT",1) D CHKNO(TEXT)
"RTN","PSOORUT2",118,0)
 F CCC=3,4,5 I '$O(^TMP($J,"PSOAPT",CCC,0)) K ^TMP($J,"PSOAPT",CCC)
"RTN","PSOORUT2",119,0)
 D PSONOAL
"RTN","PSOORUT2",120,0)
 I CCC="NKA" S ^TMP($J,"PSOAPT",2,1)="No Known Allergies" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",121,0)
 S CCC=1,OUT=0
"RTN","PSOORUT2",122,0)
 F  S CCC=$O(^TMP($J,"PSOAPT",CCC)) Q:CCC=""  D  Q:OUT
"RTN","PSOORUT2",123,0)
 .S TEXT=$G(^TMP($J,"PSOAPT",CCC))
"RTN","PSOORUT2",124,0)
 .I TEXT="No Allergy Assessment" S PSONOAL=TEXT Q
"RTN","PSOORUT2",125,0)
 .S (TEXT,CCC2)="",LENGTH=0
"RTN","PSOORUT2",126,0)
 .F  S CCC2=$O(^TMP($J,"PSOAPT",CCC,CCC2)) Q:CCC2=""  S TEXT=^(CCC2) D CHKNO(TEXT)
"RTN","PSOORUT2",127,0)
 K ^TMP($J,"PSOALWA"),^TMP($J,"PSOAPT")
"RTN","PSOORUT2",128,0)
 Q
"RTN","PSOORUT2",129,0)
CHKNO(T) ;
"RTN","PSOORUT2",130,0)
 I T="No Allergy Assessment" S PSONOAL=T
"RTN","PSOORUT2",131,0)
 Q
"RTN","PSOORUT2",132,0)
PSONOAL ;
"RTN","PSOORUT2",133,0)
 N FLG3,FLG4,FLG5
"RTN","PSOORUT2",134,0)
 S CCC=$G(^TMP($J,"PSOAPT",2,1))
"RTN","PSOORUT2",135,0)
 S FLG3=$G(^TMP($J,"PSOAPT",3,1))
"RTN","PSOORUT2",136,0)
 S FLG4=$G(^TMP($J,"PSOAPT",4,1))
"RTN","PSOORUT2",137,0)
 S FLG5=$G(^TMP($J,"PSOAPT",5,1))
"RTN","PSOORUT2",138,0)
 I CCC="",FLG3="",FLG4="",FLG5="" S ^TMP($J,"PSOAPT",2,1)="No Allergy Assessment" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",139,0)
 Q
"VER")
8.0^22.0
"BLD",6627,6)
^275
**END**
**END**

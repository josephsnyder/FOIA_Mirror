Released PSO*7*324 SEQ #288
Extracted from mail message
**KIDS**:PSO*7.0*324^

**INSTALL NAME**
PSO*7.0*324
"BLD",6371,0)
PSO*7.0*324^OUTPATIENT PHARMACY^0^3090902^y
"BLD",6371,1,0)
^^83^83^3090518^
"BLD",6371,1,1,0)
The FY09 Q3 Enhancement Release includes the following.
"BLD",6371,1,2,0)
 
"BLD",6371,1,3,0)
1. PSI-07-134 (PSPO #771) - Remedy Ticket # HD200301/HD217962
"BLD",6371,1,4,0)
 
"BLD",6371,1,5,0)
In Outpatient Pharmacy during order entry when there is no allergy
"BLD",6371,1,6,0)
assessment on file for a patient, the user will be given the ability to
"BLD",6371,1,7,0)
duplicate the allergy intervention data filed for the last drug.
"BLD",6371,1,8,0)
In order to provide this functionality, during subsequent allergy
"BLD",6371,1,9,0)
intervention, this patch will now prompt
"BLD",6371,1,10,0)
"No Allergy Assessment - Do you want to duplicate Intervention? Yes//"
"BLD",6371,1,11,0)
 
"BLD",6371,1,12,0)
If the answer is "No," then it will prompt for a new intervention.
"BLD",6371,1,13,0)
 
"BLD",6371,1,14,0)
If the answer is "Yes," then it will display the last intervention
"BLD",6371,1,15,0)
entered. The following is an example.
"BLD",6371,1,16,0)
 
"BLD",6371,1,17,0)
INTERVENTION DATE: DEC 11, 2008       PATIENT: PSOPAT,NAME
"BLD",6371,1,18,0)
PROVIDER: PSOPROV, NAME               PHARMACIST: PSOPHARM, NAME
"BLD",6371,1,19,0)
DRUG: "current order drug name"       INSTITUTED BY: PHARMACY
"BLD",6371,1,20,0)
INTERVENTION: ALLERGY                 RECOMMENDATION: OTHER
"BLD",6371,1,21,0)
ORIGINATING PACKAGE: OUTPATIENT       DIVISION: OKLAHOMA CITY VAMC
"BLD",6371,1,22,0)
 
"BLD",6371,1,23,0)
Would you like to edit this Intervention? No//
"BLD",6371,1,24,0)
 
"BLD",6371,1,25,0)
If "No," then the system accepts the intervention and continues.
"BLD",6371,1,26,0)
If "Yes," then the system allows editing of the intervention.
"BLD",6371,1,27,0)
 
"BLD",6371,1,28,0)
 
"BLD",6371,1,29,0)
2. PSI-07-181 (PSPO# 865) - Remedy Ticket # HD208961
"BLD",6371,1,30,0)
 
"BLD",6371,1,31,0)
A prescription's strength was changed in Computerized Patient Record
"BLD",6371,1,32,0)
System V. 1.0 (CPRS) creating a new Rx. The original Rx had been
"BLD",6371,1,33,0)
transmitted to Consolidated Mail Outpatient Pharmacy (CMOP) on the
"BLD",6371,1,34,0)
previous day. When finishing, the pharmacist missed the previous day's
"BLD",6371,1,35,0)
transmission to CMOP of the original prescription. Both Rxs were mailed
"BLD",6371,1,36,0)
to the patient in the same package from the CMOP.
"BLD",6371,1,37,0)
 
"BLD",6371,1,38,0)
When a CMOP prescription with a status of Transmitted or Retransmitted is
"BLD",6371,1,39,0)
discontinued by a background process to the Outpatient Pharmacy options,
"BLD",6371,1,40,0)
e.g. CPRS or Registration V. 5.3 packages, then an email notifying that a
"BLD",6371,1,41,0)
prescription was just discontinued for that Rx will be sent to the new PSX
"BLD",6371,1,42,0)
EXTERNAL DISPENSE ALERTS mail group created by patch PSX*2*68 (see
"BLD",6371,1,43,0)
PSX*2*68 patch description for details). If no recipients are defined in
"BLD",6371,1,44,0)
the new mail group, then it will be sent to PSXCMOPMGR key holders. The
"BLD",6371,1,45,0)
email alert will inform the group that the CMOP status for the Rx just
"BLD",6371,1,46,0)
discontinued was either Transmitted or Retransmitted as seen in the
"BLD",6371,1,47,0)
example below.
"BLD",6371,1,48,0)
 
"BLD",6371,1,49,0)
  Subj: TROY - DC Alert on CMOP Rx 123456789 TRANSMITTED  [#90494]
"BLD",6371,1,50,0)
  03/03/09@17:37 8 lines
"BLD",6371,1,51,0)
  From: POSTMASTER  In 'IN' basket.   Page 1  *New*
"BLD",6371,1,52,0)
  ------------------------------------------------------------------------
"BLD",6371,1,53,0)
               Rx #: 123456789   Fill: 0
"BLD",6371,1,54,0)
            Patient: OUTPATIENT,DCONE (6660)
"BLD",6371,1,55,0)
               Drug: TAMOXIFEN CITRATE 10MG TABS
"BLD",6371,1,56,0)
          Rx Status: DISCONTINUED BY PROVIDER
"BLD",6371,1,57,0)
  Processing Status: TRANSMITTED to CMOP on 02/27/09
"BLD",6371,1,58,0)
           Provider: OPPROVIDER, PROV
"BLD",6371,1,59,0)
 
"BLD",6371,1,60,0)
  ********    Please contact CMOP or take appropriate action    ********
"BLD",6371,1,61,0)
 
"BLD",6371,1,62,0)
  Enter message action (in IN basket): Ignore//
"BLD",6371,1,63,0)
  ------------------------------------------------------------------------
"BLD",6371,1,64,0)
 
"BLD",6371,1,65,0)
When a CMOP prescription with a status of Transmitted or Retransmitted is
"BLD",6371,1,66,0)
discontinued by a foreground Pharmacy process due to a duplicate drug
"BLD",6371,1,67,0)
scenario that would trigger the duplicate to be discontinued, then the
"BLD",6371,1,68,0)
Processing Status field of the duplicate drug message is highlighted to
"BLD",6371,1,69,0)
alert the user. Below is an example.
"BLD",6371,1,70,0)
 
"BLD",6371,1,71,0)
  ------------------------------------------------------------------------
"BLD",6371,1,72,0)
  Duplicate Drug A AND Z OINTMENT in Prescription: 123456789
"BLD",6371,1,73,0)
 
"BLD",6371,1,74,0)
                    Status: Active                       Issued: 03/03/09
"BLD",6371,1,75,0)
<<BOLD>> Processing Status: Transmitted to CMOP on 03/04/09 <<BOLD>>
"BLD",6371,1,76,0)
                       SIG: APPLY 1 TUBE TO AFFECTED AREA TWICE A DAY
"BLD",6371,1,77,0)
                       QTY: 1                         # of refills: 5
"BLD",6371,1,78,0)
                  Provider: OPPROVIDER, PROV     Refills remaining: 5
"BLD",6371,1,79,0)
                                                Last filled on: 03/04/09
"BLD",6371,1,80,0)
                                                   Days Supply: 5
"BLD",6371,1,81,0)
  ------------------------------------------------------------------------
"BLD",6371,1,82,0)
 
"BLD",6371,1,83,0)
Discontinue RX # 123456789?
"BLD",6371,4,0)
^9.64PA^^
"BLD",6371,6.3)
6
"BLD",6371,"ABPKG")
n
"BLD",6371,"KRN",0)
^9.67PA^779.2^20
"BLD",6371,"KRN",.4,0)
.4
"BLD",6371,"KRN",.4,"NM",0)
^9.68A^^
"BLD",6371,"KRN",.401,0)
.401
"BLD",6371,"KRN",.402,0)
.402
"BLD",6371,"KRN",.403,0)
.403
"BLD",6371,"KRN",.5,0)
.5
"BLD",6371,"KRN",.84,0)
.84
"BLD",6371,"KRN",3.6,0)
3.6
"BLD",6371,"KRN",3.8,0)
3.8
"BLD",6371,"KRN",3.8,"NM",0)
^9.68A^^0
"BLD",6371,"KRN",9.2,0)
9.2
"BLD",6371,"KRN",9.8,0)
9.8
"BLD",6371,"KRN",9.8,"NM",0)
^9.68A^11^10
"BLD",6371,"KRN",9.8,"NM",1,0)
PSODRG^^0^B38932823
"BLD",6371,"KRN",9.8,"NM",2,0)
PSORX1^^0^B62615378
"BLD",6371,"KRN",9.8,"NM",3,0)
PSORXI^^0^B11542094
"BLD",6371,"KRN",9.8,"NM",4,0)
PSOAUTOC^^0^B66619284
"BLD",6371,"KRN",9.8,"NM",5,0)
PSOCAN3^^0^B70537692
"BLD",6371,"KRN",9.8,"NM",6,0)
PSODRDUP^^0^B48009751
"BLD",6371,"KRN",9.8,"NM",7,0)
PSOHLNEW^^0^B80638841
"BLD",6371,"KRN",9.8,"NM",9,0)
PSOUTL^^0^B96529999
"BLD",6371,"KRN",9.8,"NM",10,0)
PSOVER1^^0^B56428439
"BLD",6371,"KRN",9.8,"NM",11,0)
PSOORUTL^^0^B43174944
"BLD",6371,"KRN",9.8,"NM","B","PSOAUTOC",4)

"BLD",6371,"KRN",9.8,"NM","B","PSOCAN3",5)

"BLD",6371,"KRN",9.8,"NM","B","PSODRDUP",6)

"BLD",6371,"KRN",9.8,"NM","B","PSODRG",1)

"BLD",6371,"KRN",9.8,"NM","B","PSOHLNEW",7)

"BLD",6371,"KRN",9.8,"NM","B","PSOORUTL",11)

"BLD",6371,"KRN",9.8,"NM","B","PSORX1",2)

"BLD",6371,"KRN",9.8,"NM","B","PSORXI",3)

"BLD",6371,"KRN",9.8,"NM","B","PSOUTL",9)

"BLD",6371,"KRN",9.8,"NM","B","PSOVER1",10)

"BLD",6371,"KRN",19,0)
19
"BLD",6371,"KRN",19.1,0)
19.1
"BLD",6371,"KRN",101,0)
101
"BLD",6371,"KRN",409.61,0)
409.61
"BLD",6371,"KRN",771,0)
771
"BLD",6371,"KRN",779.2,0)
779.2
"BLD",6371,"KRN",870,0)
870
"BLD",6371,"KRN",8989.51,0)
8989.51
"BLD",6371,"KRN",8989.52,0)
8989.52
"BLD",6371,"KRN",8994,0)
8994
"BLD",6371,"KRN","B",.4,.4)

"BLD",6371,"KRN","B",.401,.401)

"BLD",6371,"KRN","B",.402,.402)

"BLD",6371,"KRN","B",.403,.403)

"BLD",6371,"KRN","B",.5,.5)

"BLD",6371,"KRN","B",.84,.84)

"BLD",6371,"KRN","B",3.6,3.6)

"BLD",6371,"KRN","B",3.8,3.8)

"BLD",6371,"KRN","B",9.2,9.2)

"BLD",6371,"KRN","B",9.8,9.8)

"BLD",6371,"KRN","B",19,19)

"BLD",6371,"KRN","B",19.1,19.1)

"BLD",6371,"KRN","B",101,101)

"BLD",6371,"KRN","B",409.61,409.61)

"BLD",6371,"KRN","B",771,771)

"BLD",6371,"KRN","B",779.2,779.2)

"BLD",6371,"KRN","B",870,870)

"BLD",6371,"KRN","B",8989.51,8989.51)

"BLD",6371,"KRN","B",8989.52,8989.52)

"BLD",6371,"KRN","B",8994,8994)

"BLD",6371,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",6371,"QUES",0)
^9.62^^
"BLD",6371,"REQB",0)
^9.611^5^3
"BLD",6371,"REQB",3,0)
PSO*7.0*281^2
"BLD",6371,"REQB",4,0)
PSO*7.0*326^2
"BLD",6371,"REQB",5,0)
PSX*2.0*68^2
"BLD",6371,"REQB","B","PSO*7.0*281",3)

"BLD",6371,"REQB","B","PSO*7.0*326",4)

"BLD",6371,"REQB","B","PSX*2.0*68",5)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
324^3090902
"PKG",141,22,1,"PAH",1,1,0)
^^83^83^3090902
"PKG",141,22,1,"PAH",1,1,1,0)
The FY09 Q3 Enhancement Release includes the following.
"PKG",141,22,1,"PAH",1,1,2,0)
 
"PKG",141,22,1,"PAH",1,1,3,0)
1. PSI-07-134 (PSPO #771) - Remedy Ticket # HD200301/HD217962
"PKG",141,22,1,"PAH",1,1,4,0)
 
"PKG",141,22,1,"PAH",1,1,5,0)
In Outpatient Pharmacy during order entry when there is no allergy
"PKG",141,22,1,"PAH",1,1,6,0)
assessment on file for a patient, the user will be given the ability to
"PKG",141,22,1,"PAH",1,1,7,0)
duplicate the allergy intervention data filed for the last drug.
"PKG",141,22,1,"PAH",1,1,8,0)
In order to provide this functionality, during subsequent allergy
"PKG",141,22,1,"PAH",1,1,9,0)
intervention, this patch will now prompt
"PKG",141,22,1,"PAH",1,1,10,0)
"No Allergy Assessment - Do you want to duplicate Intervention? Yes//"
"PKG",141,22,1,"PAH",1,1,11,0)
 
"PKG",141,22,1,"PAH",1,1,12,0)
If the answer is "No," then it will prompt for a new intervention.
"PKG",141,22,1,"PAH",1,1,13,0)
 
"PKG",141,22,1,"PAH",1,1,14,0)
If the answer is "Yes," then it will display the last intervention
"PKG",141,22,1,"PAH",1,1,15,0)
entered. The following is an example.
"PKG",141,22,1,"PAH",1,1,16,0)
 
"PKG",141,22,1,"PAH",1,1,17,0)
INTERVENTION DATE: DEC 11, 2008       PATIENT: PSOPAT,NAME
"PKG",141,22,1,"PAH",1,1,18,0)
PROVIDER: PSOPROV, NAME               PHARMACIST: PSOPHARM, NAME
"PKG",141,22,1,"PAH",1,1,19,0)
DRUG: "current order drug name"       INSTITUTED BY: PHARMACY
"PKG",141,22,1,"PAH",1,1,20,0)
INTERVENTION: ALLERGY                 RECOMMENDATION: OTHER
"PKG",141,22,1,"PAH",1,1,21,0)
ORIGINATING PACKAGE: OUTPATIENT       DIVISION: OKLAHOMA CITY VAMC
"PKG",141,22,1,"PAH",1,1,22,0)
 
"PKG",141,22,1,"PAH",1,1,23,0)
Would you like to edit this Intervention? No//
"PKG",141,22,1,"PAH",1,1,24,0)
 
"PKG",141,22,1,"PAH",1,1,25,0)
If "No," then the system accepts the intervention and continues.
"PKG",141,22,1,"PAH",1,1,26,0)
If "Yes," then the system allows editing of the intervention.
"PKG",141,22,1,"PAH",1,1,27,0)
 
"PKG",141,22,1,"PAH",1,1,28,0)
 
"PKG",141,22,1,"PAH",1,1,29,0)
2. PSI-07-181 (PSPO# 865) - Remedy Ticket # HD208961
"PKG",141,22,1,"PAH",1,1,30,0)
 
"PKG",141,22,1,"PAH",1,1,31,0)
A prescription's strength was changed in Computerized Patient Record
"PKG",141,22,1,"PAH",1,1,32,0)
System V. 1.0 (CPRS) creating a new Rx. The original Rx had been
"PKG",141,22,1,"PAH",1,1,33,0)
transmitted to Consolidated Mail Outpatient Pharmacy (CMOP) on the
"PKG",141,22,1,"PAH",1,1,34,0)
previous day. When finishing, the pharmacist missed the previous day's
"PKG",141,22,1,"PAH",1,1,35,0)
transmission to CMOP of the original prescription. Both Rxs were mailed
"PKG",141,22,1,"PAH",1,1,36,0)
to the patient in the same package from the CMOP.
"PKG",141,22,1,"PAH",1,1,37,0)
 
"PKG",141,22,1,"PAH",1,1,38,0)
When a CMOP prescription with a status of Transmitted or Retransmitted is
"PKG",141,22,1,"PAH",1,1,39,0)
discontinued by a background process to the Outpatient Pharmacy options,
"PKG",141,22,1,"PAH",1,1,40,0)
e.g. CPRS or Registration V. 5.3 packages, then an email notifying that a
"PKG",141,22,1,"PAH",1,1,41,0)
prescription was just discontinued for that Rx will be sent to the new PSX
"PKG",141,22,1,"PAH",1,1,42,0)
EXTERNAL DISPENSE ALERTS mail group created by patch PSX*2*68 (see
"PKG",141,22,1,"PAH",1,1,43,0)
PSX*2*68 patch description for details). If no recipients are defined in
"PKG",141,22,1,"PAH",1,1,44,0)
the new mail group, then it will be sent to PSXCMOPMGR key holders. The
"PKG",141,22,1,"PAH",1,1,45,0)
email alert will inform the group that the CMOP status for the Rx just
"PKG",141,22,1,"PAH",1,1,46,0)
discontinued was either Transmitted or Retransmitted as seen in the
"PKG",141,22,1,"PAH",1,1,47,0)
example below.
"PKG",141,22,1,"PAH",1,1,48,0)
 
"PKG",141,22,1,"PAH",1,1,49,0)
  Subj: TROY - DC Alert on CMOP Rx 123456789 TRANSMITTED  [#90494]
"PKG",141,22,1,"PAH",1,1,50,0)
  03/03/09@17:37 8 lines
"PKG",141,22,1,"PAH",1,1,51,0)
  From: POSTMASTER  In 'IN' basket.   Page 1  *New*
"PKG",141,22,1,"PAH",1,1,52,0)
  ------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,53,0)
               Rx #: 123456789   Fill: 0
"PKG",141,22,1,"PAH",1,1,54,0)
            Patient: OUTPATIENT,DCONE (6660)
"PKG",141,22,1,"PAH",1,1,55,0)
               Drug: TAMOXIFEN CITRATE 10MG TABS
"PKG",141,22,1,"PAH",1,1,56,0)
          Rx Status: DISCONTINUED BY PROVIDER
"PKG",141,22,1,"PAH",1,1,57,0)
  Processing Status: TRANSMITTED to CMOP on 02/27/09
"PKG",141,22,1,"PAH",1,1,58,0)
           Provider: OPPROVIDER, PROV
"PKG",141,22,1,"PAH",1,1,59,0)
 
"PKG",141,22,1,"PAH",1,1,60,0)
  ********    Please contact CMOP or take appropriate action    ********
"PKG",141,22,1,"PAH",1,1,61,0)
 
"PKG",141,22,1,"PAH",1,1,62,0)
  Enter message action (in IN basket): Ignore//
"PKG",141,22,1,"PAH",1,1,63,0)
  ------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,64,0)
 
"PKG",141,22,1,"PAH",1,1,65,0)
When a CMOP prescription with a status of Transmitted or Retransmitted is
"PKG",141,22,1,"PAH",1,1,66,0)
discontinued by a foreground Pharmacy process due to a duplicate drug
"PKG",141,22,1,"PAH",1,1,67,0)
scenario that would trigger the duplicate to be discontinued, then the
"PKG",141,22,1,"PAH",1,1,68,0)
Processing Status field of the duplicate drug message is highlighted to
"PKG",141,22,1,"PAH",1,1,69,0)
alert the user. Below is an example.
"PKG",141,22,1,"PAH",1,1,70,0)
 
"PKG",141,22,1,"PAH",1,1,71,0)
  ------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,72,0)
  Duplicate Drug A AND Z OINTMENT in Prescription: 123456789
"PKG",141,22,1,"PAH",1,1,73,0)
 
"PKG",141,22,1,"PAH",1,1,74,0)
                    Status: Active                       Issued: 03/03/09
"PKG",141,22,1,"PAH",1,1,75,0)
<<BOLD>> Processing Status: Transmitted to CMOP on 03/04/09 <<BOLD>>
"PKG",141,22,1,"PAH",1,1,76,0)
                       SIG: APPLY 1 TUBE TO AFFECTED AREA TWICE A DAY
"PKG",141,22,1,"PAH",1,1,77,0)
                       QTY: 1                         # of refills: 5
"PKG",141,22,1,"PAH",1,1,78,0)
                  Provider: OPPROVIDER, PROV     Refills remaining: 5
"PKG",141,22,1,"PAH",1,1,79,0)
                                                Last filled on: 03/04/09
"PKG",141,22,1,"PAH",1,1,80,0)
                                                   Days Supply: 5
"PKG",141,22,1,"PAH",1,1,81,0)
  ------------------------------------------------------------------------
"PKG",141,22,1,"PAH",1,1,82,0)
 
"PKG",141,22,1,"PAH",1,1,83,0)
Discontinue RX # 123456789?
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","PSOAUTOC")
0^4^B66619284^B66090393
"RTN","PSOAUTOC",1,0)
PSOAUTOC ;BIR/SAB - autocancel rxs on admission ;4/28/09 6:54am
"RTN","PSOAUTOC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,24,30,36,88,146,132,223,148,249,324**;DEC 1997;Build 6
"RTN","PSOAUTOC",3,0)
 ;External reference to File #59.7 supported by DBIA 694
"RTN","PSOAUTOC",4,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOAUTOC",5,0)
 ;External reference ^DPT(PSODFN,.1) supported by DBIA 10035
"RTN","PSOAUTOC",6,0)
 ;External reference ^DGPM("AMV1" supported by DBIA 2249
"RTN","PSOAUTOC",7,0)
 ;External reference ^DGPM("APTT1" supported by DBIA 2249
"RTN","PSOAUTOC",8,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOAUTOC",9,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOAUTOC",10,0)
AUTO I '$P(^PS(59.7,1,40.1),"^") W $C(7),!,"Autocancel System Parameter must be set to 'YES'",!,"before prescriptions are discontinued."
"RTN","PSOAUTOC",11,0)
 K %DT,DIC S DIC(0)="XZM",(DIE,DIC)="^DIC(19.2,",X="PSO AUTOCANCEL" D ^DIC
"RTN","PSOAUTOC",12,0)
 I +Y>0 D EDIT^XUTMOPT("PSO AUTOCANCEL") G EX
"RTN","PSOAUTOC",13,0)
 D RESCH^XUTMOPT("PSO AUTOCANCEL","","","24H","L"),EDIT^XUTMOPT("PSO AUTOCANCEL")
"RTN","PSOAUTOC",14,0)
EX K Y,C,D,D0,DI,DQ,DA,DIE,DR,DIC,X
"RTN","PSOAUTOC",15,0)
 Q
"RTN","PSOAUTOC",16,0)
TASK ;TaskMan entry point
"RTN","PSOAUTOC",17,0)
 G:'$P(^PS(59.7,1,40.1),"^") KILL S X="T-3" D ^%DT S PSOD2=Y,PSOD0=Y-.01,PSODL=Y+.3
"RTN","PSOAUTOC",18,0)
 S PSOD=PSOD0 F  S PSOD=$O(^DGPM("AMV1",PSOD)),PSODFN=0 Q:'PSOD!(PSOD>PSODL)  F PSODFN=0:0 S PSODFN=$O(^DGPM("AMV1",PSOD,PSODFN)) Q:'PSODFN  I $G(^DPT(PSODFN,.1))]"",$O(^PS(55,PSODFN,"P",0)),'$O(^DGPM("APTT1",PSODFN,PSOD)) D CAN
"RTN","PSOAUTOC",19,0)
 G KILL
"RTN","PSOAUTOC",20,0)
CAN ;discontinue Rxs
"RTN","PSOAUTOC",21,0)
 S DFN=PSODFN K VAIN D INP^VADPT I $P($G(VAIN(4)),"^"),$D(^PS(59.7,1,40.19,"B",$P($G(VAIN(4)),"^"))) Q
"RTN","PSOAUTOC",22,0)
 I $D(^PS(55,PSODFN,0)),$P($G(^PS(55,PSODFN,0)),U,6)'=2 D EN^PSOHLUP(PSODFN)
"RTN","PSOAUTOC",23,0)
 F PSORXJ=0:0 S PSORXJ=$O(^PS(55,PSODFN,"P",PSORXJ)) Q:'PSORXJ  I $D(^(PSORXJ,0)) S PSORX=^(0) D
"RTN","PSOAUTOC",24,0)
 .I $D(^PSRX(PSORX,0)) S PSO0=^(0),PSO2=$G(^(2)),STA=+^("STA") I STA<11,PSO2,$P(PSO2,"^",6)'<DT,$E(PSO2,1,7)'>PSOD2!(STA=16) D
"RTN","PSOAUTOC",25,0)
 ..S $P(^PSRX(PSORX,3),"^",5)=DT,$P(^("STA"),"^")=12
"RTN","PSOAUTOC",26,0)
 ..D CHKCMOP^PSOUTL(PSORX,"A")
"RTN","PSOAUTOC",27,0)
 ..D REVERSE^PSOBPSU1(PSORX,,"DC",7)
"RTN","PSOAUTOC",28,0)
 ..D CAN^PSOTPCAN(PSORX)
"RTN","PSOAUTOC",29,0)
 ..D FIL^PSOCAN3
"RTN","PSOAUTOC",30,0)
 ..;remove from hold
"RTN","PSOAUTOC",31,0)
 ..I $G(^PSRX(PSORX,"H"))]"" D
"RTN","PSOAUTOC",32,0)
 ...K:$P(^PSRX(PSORX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSORX,"H"),"^"),PSORX) S ^PSRX(PSORX,"H")=""
"RTN","PSOAUTOC",33,0)
 ...I '$P($G(^PSRX(PSORX,2)),"^",2),$P($G(^(3)),"^") S $P(^PSRX(PSORX,2),"^",2)=$P(^(3),"^")
"RTN","PSOAUTOC",34,0)
 ..;Add activity record
"RTN","PSOAUTOC",35,0)
 ..S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(PSORX,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOAUTOC",36,0)
 ..S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(PSORX,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOAUTOC",37,0)
 ..D NOW^%DTC S ACNT=ACNT+1,^PSRX(PSORX,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(PSORX,"A",ACNT,0)=%_"^"_"C"_"^^"_RFCNT_"^"_"Auto Discontinued on Admission"
"RTN","PSOAUTOC",38,0)
 ..;delete from suspense
"RTN","PSOAUTOC",39,0)
 ..D:$O(^PS(52.5,"B",PSORX,0))
"RTN","PSOAUTOC",40,0)
 ...I $O(^PSRX(PSORX,1,0)) S DA=PSORX,SUSD=$P($G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),0)),"^",2) D:'$G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),"P")) REF^PSOCAN2
"RTN","PSOAUTOC",41,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)),DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOAUTOC",42,0)
 ..;remove from non-verified file
"RTN","PSOAUTOC",43,0)
 ..I $G(^PS(52.4,PSORX,0))]"" S DIK="^PS(52.4,",DA=PSORX D ^DIK K DIK
"RTN","PSOAUTOC",44,0)
 ..S STAT="OD",PHARMST="",COM="Auto Discontinued on Admission" D EN^PSOHLSN1(PSORX,STAT,PHARMST,COM,"A")
"RTN","PSOAUTOC",45,0)
 ;auto-dc pending orders
"RTN","PSOAUTOC",46,0)
 ;F PSOIORD=0:0 S PSOIORD=$O(^PS(52.41,"AOR",PSODFN,PSOIORD)) Q:'PSOIORD  F PSORD=0:0 S PSORD=$O(^PS(52.41,"AOR",PSODFN,PSOIORD,PSORD)) Q:'PSORD  D
"RTN","PSOAUTOC",47,0)
 ;.I $P(^PS(52.41,PSORD,0),"^",3)="RF" S DA=PSORD,DIK="^PS(52.41," D ^DIK K DA,DIK Q
"RTN","PSOAUTOC",48,0)
 ;.K ^PS(52.41,"AOR",PSODFN,PSOIORD,PSORD) S $P(^PS(52.41,PSORD,0),"^",3)="DC"
"RTN","PSOAUTOC",49,0)
 ;.D EN^PSOHLSN(+^PS(52.41,PSORD,0),"OC","Auto Canceled on Admission","A")
"RTN","PSOAUTOC",50,0)
 K PSORD,PSOIORD
"RTN","PSOAUTOC",51,0)
 Q
"RTN","PSOAUTOC",52,0)
KILL K %,%H,%T,ACNT,DA,DFN,DIRUT,DTOUT,PSO,PSO0,PSO2,PSOD,PSOD0,PSOD2,PSODFN,PSODL,PSORX,PSORXJ,PSOSD,RF,RFCNT,SUB,TM,TSKDT,VAIN,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSOAUTOC",53,0)
 K ORD,PHARMST,STAT,COM S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOAUTOC",54,0)
 Q
"RTN","PSOAUTOC",55,0)
SETUP ;initialize nightly Rx cost compile job
"RTN","PSOAUTOC",56,0)
 K %DT,DIC,DTOUT S DIC(0)="XZM",DIC="^DIC(19.2,",X="PSO COSTDAY NIGHTJOB" D ^DIC
"RTN","PSOAUTOC",57,0)
 I +Y>0 D EDIT^XUTMOPT("PSO COSTDAY NIGHTJOB") G OUT
"RTN","PSOAUTOC",58,0)
 D RESCH^XUTMOPT("PSO COSTDAY NIGHTJOB","","","24H","L"),EDIT^XUTMOPT("PSO COSTDAY NIGHTJOB")
"RTN","PSOAUTOC",59,0)
OUT K Y,DIC,X,PSOTM,PSOOPTN,PSOPTN,%DT,DTOUT
"RTN","PSOAUTOC",60,0)
 Q
"RTN","PSOAUTOC",61,0)
 ;initialize management data compile job
"RTN","PSOAUTOC",62,0)
SETUP1 K %DT,DIC,DTOUT S DIC(0)="ZXM",DIC="^DIC(19.2,",X="PSO MGMT NIGHTLY COMPILE" D ^DIC
"RTN","PSOAUTOC",63,0)
 I +Y>0 D EDIT^XUTMOPT("PSO MGMT NIGHTLY COMPILE") G OUT
"RTN","PSOAUTOC",64,0)
 D RESCH^XUTMOPT("PSO MGMT NIGHTLY COMPILE","","","24H","L"),EDIT^XUTMOPT("PSO MGMT NIGHTLY COMPILE")
"RTN","PSOAUTOC",65,0)
 K Y,DIC,X,PSOTM,DIR,PSOOPTN,PSOPTN,%DT,DTOUT
"RTN","PSOAUTOC",66,0)
 Q
"RTN","PSOAUTOC",67,0)
APSOD(PSODFN) ;sends mail message that date of death has been deleted
"RTN","PSOAUTOC",68,0)
 I $G(PSODFN),$D(^PS(52.91,PSODFN,0)) D
"RTN","PSOAUTOC",69,0)
 .I $P(^PS(52.91,PSODFN,0),"^",3),$P(^(0),"^",4)=5 D
"RTN","PSOAUTOC",70,0)
 ..S $P(^PS(52.91,PSODFN,0),"^",3)="",$P(^PS(52.91,PSODFN,0),"^",4)=""
"RTN","PSOAUTOC",71,0)
 ..S ^PS(52.91,"AX",DT,PSODFN)=""
"RTN","PSOAUTOC",72,0)
 ..I $D(^PS(55,PSODFN,0)),$P($G(^PS(55,PSODFN,"PS")),"^")="" D
"RTN","PSOAUTOC",73,0)
 ...N PSORESPS,PSORESFG,PSORESF1 S PSORESFG=0 F PSORESPS=0:0 S PSORESPS=$O(^PS(53,PSORESPS)) Q:'PSORESPS!(PSORESFG)  D
"RTN","PSOAUTOC",74,0)
 ....S PSORESF1=$P($G(^PS(53,PSORESPS,0)),"^") S PSORESF1=$$UP^XLFSTR(PSORESF1) I PSORESF1="NON-VA" S $P(^PS(55,PSODFN,"PS"),"^")=PSORESPS,PSORESFG=1
"RTN","PSOAUTOC",75,0)
 N DI,DA,DR,DIE,DIC,X,Y
"RTN","PSOAUTOC",76,0)
 S ZTDTH=$H,ZTREQ="@",ZTSAVE("ZTREQ")="",ZTSAVE("PSODFN")="",ZTRTN="MAIL^PSOAUTOC",ZTDESC="Sends Mail Message that a Date of Death was Deleted",ZTIO="" D ^%ZTLOAD
"RTN","PSOAUTOC",77,0)
 Q
"RTN","PSOAUTOC",78,0)
MAIL ;builds mail message
"RTN","PSOAUTOC",79,0)
 S DIC=2,DA=PSODFN,DR=.351,DIQ="PTDOD" D EN^DIQ1 I PTDOD(2,DA,.351)]"" G EX1
"RTN","PSOAUTOC",80,0)
 K ^TMP("PSOHLD",$J),^TMP("PSOAD",$J),TOTRX,TOTPRX
"RTN","PSOAUTOC",81,0)
 F I=0:0 S I=$O(^PSRX("APSOD",PSODFN,I)) Q:'I  S TOTRX=$G(TOTRX)+1
"RTN","PSOAUTOC",82,0)
 F I=0:0 S I=$O(^PS(52.41,"APSOD",PSODFN,I)) Q:'I  S TOTPRX=$G(TOTPRX)+1
"RTN","PSOAUTOC",83,0)
 F I=0:0 S I=$O(^PS(55,PSODFN,"NVA","APSOD",I)) Q:'I  S TOTNVA=$G(TOTNVA)+1
"RTN","PSOAUTOC",84,0)
 K I Q:'$G(TOTRX)&('$G(TOTPRX))&('$G(TOTNVA))
"RTN","PSOAUTOC",85,0)
 S ENT=0,DFN=PSODFN D DEM^VADPT
"RTN","PSOAUTOC",86,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=$P(^DPT(PSODFN,0),"^")_" ID#: "_VA("PID")_" DOB: "_$P(VADM(3),"^",2)
"RTN","PSOAUTOC",87,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=" " S Y=DT D DD^%DT
"RTN","PSOAUTOC",88,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="This patient had a Date of Death deleted on "_Y_"."
"RTN","PSOAUTOC",89,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="When a Date of Death is entered ALL active prescriptions, pending orders, and",ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Non-VA Meds are discontinued automatically. The following Outpatient"
"RTN","PSOAUTOC",90,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Prescriptions and/or Pending Orders should be reviewed for this patient using",ENT=ENT+1,^TMP("PSOAD",$J,ENT)="the Patient Prescription Processing option."
"RTN","PSOAUTOC",91,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=" "
"RTN","PSOAUTOC",92,0)
 I $G(TOTRX) S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Total number of Prescriptions found for review is "_TOTRX D
"RTN","PSOAUTOC",93,0)
 .F I=0:0 S I=$O(^PSRX("APSOD",PSODFN,I)) Q:'I  S ^TMP("PSOHLD",$J,$P(^PSDRUG($P(^PSRX(I,0),"^",6),0),"^"),I)=I
"RTN","PSOAUTOC",94,0)
 .S DRG="" F  S DRG=$O(^TMP("PSOHLD",$J,DRG)) Q:DRG=""  F I=0:0 S I=$O(^TMP("PSOHLD",$J,DRG,I)) Q:'I  S RX=^TMP("PSOHLD",$J,DRG,I) D
"RTN","PSOAUTOC",95,0)
 ..S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Rx: "_$P(^PSRX(RX,0),"^")_"  Drug: "_DRG
"RTN","PSOAUTOC",96,0)
 N PSOLPI,PSOLPIX,PSOLPIST,PSOLPND
"RTN","PSOAUTOC",97,0)
 I $G(TOTPRX) S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=" " D
"RTN","PSOAUTOC",98,0)
 .S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Total number of Pending Orders found and reinstated is "_TOTPRX
"RTN","PSOAUTOC",99,0)
 .F PSOLPI=0:0 S PSOLPI=$O(^PS(52.41,"APSOD",PSODFN,PSOLPI)) Q:'PSOLPI  D
"RTN","PSOAUTOC",100,0)
 ..S $P(^PS(52.41,PSOLPI,0),"^",3)=$P(^PS(52.41,PSOLPI,"DDSTA"),";"),^PS(52.41,"AOR",PSODFN,$P(^PS(52.41,PSOLPI,"DDSTA"),";",2),PSOLPI)=""
"RTN","PSOAUTOC",101,0)
 ..S PSOLPIX=$P($G(^PS(52.41,PSOLPI,0)),"^"),PSOLPIST=$P($G(^(0)),"^",3)
"RTN","PSOAUTOC",102,0)
 ..I PSOLPIX D
"RTN","PSOAUTOC",103,0)
 ...I PSOLPIST'="NW",PSOLPIST'="RNW",PSOLPIST'="RF" Q
"RTN","PSOAUTOC",104,0)
 ...;Reset remaining cross references
"RTN","PSOAUTOC",105,0)
 ...S PSOLPND=$G(^PS(52.41,PSOLPI,0))
"RTN","PSOAUTOC",106,0)
 ...I $P(PSOLPND,"^",12),$P(PSOLPND,"^",13) S ^PS(52.41,"ACL",$P(PSOLPND,"^",13),$P(PSOLPND,"^",12),PSOLPI)=""
"RTN","PSOAUTOC",107,0)
 ...I $P(^PS(52.41,PSOLPI,"INI"),"^"),$P(PSOLPND,"^",12) S ^PS(52.41,"AD",$P(PSOLPND,"^",12),$P(^PS(52.41,PSOLPI,"INI"),"^"),PSOLPI)=""
"RTN","PSOAUTOC",108,0)
 ...I PSOLPIST="RNW",$P(PSOLPND,"^",21) S ^PS(52.41,"AQ",$P(PSOLPND,"^",21),PSOLPI)=""
"RTN","PSOAUTOC",109,0)
 ...I PSOLPIST="RF" Q
"RTN","PSOAUTOC",110,0)
 ...;Update CPRS with Pending order information on new and renewals
"RTN","PSOAUTOC",111,0)
 ...D EN^PSOHLSN(PSOLPIX,"SC","IP")
"RTN","PSOAUTOC",112,0)
 ..K ^PS(52.41,"APSOD",PSODFN,PSOLPI),ORTYP
"RTN","PSOAUTOC",113,0)
 ..S ENT=ENT+1,ORTYP=$P(^PS(52.41,PSOLPI,0),"^",3)
"RTN","PSOAUTOC",114,0)
 ..S MED=$S($P(^PS(52.41,PSOLPI,0),"^",9):$P(^PSDRUG($P(^PS(52.41,PSOLPI,0),"^",9),0),"^"),1:$P(^PS(50.7,$P(^PS(52.41,PSOLPI,0),"^",8),0),"^"))
"RTN","PSOAUTOC",115,0)
 ..I $G(MED)']"" S MED="NO DRUG OR ORDERABLE ITEM FOUND"
"RTN","PSOAUTOC",116,0)
 ..S ^TMP("PSOAD",$J,ENT)=$S(ORTYP="RF":"Refill",ORTYP="RNW":"Renew",ORTYP="HD":"On Hold",1:"New")_" Order Request  -  "
"RTN","PSOAUTOC",117,0)
 ..S ^TMP("PSOAD",$J,ENT)=^TMP("PSOAD",$J,ENT)_"Medication: "_MED
"RTN","PSOAUTOC",118,0)
 I $G(TOTNVA) S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=" " D
"RTN","PSOAUTOC",119,0)
 .N PSODD,MED,PSOOI,PSONVA,NVA S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Total number of Non-VA Med Orders found and reinstated is "_TOTNVA
"RTN","PSOAUTOC",120,0)
 .F NVA=0:0 S NVA=$O(^PS(55,PSODFN,"NVA","APSOD",NVA)) Q:'NVA  D
"RTN","PSOAUTOC",121,0)
 ..S PSOOI=$P(^PS(55,PSODFN,"NVA",NVA,0),"^"),PSODD=$P(^(0),"^",2),PLACER=$P(^(0),"^",8),LOCATION=$P(^(0),"^",12),DFN=PSODFN
"RTN","PSOAUTOC",122,0)
 ..S MED=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),1:$P(^PS(50.7,+PSOOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,+PSOOI,0),"^",2),0),"^"))
"RTN","PSOAUTOC",123,0)
 ..S $P(^PS(55,PSODFN,"NVA",NVA,0),"^",6)="",$P(^(0),"^",7)="" K ^PS(55,PSODFN,"NVA","APSOD",NVA)
"RTN","PSOAUTOC",124,0)
 ..S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Non-VA "_MED,REIN=1,PSONVA=NVA D REIN^PSONVNEW
"RTN","PSOAUTOC",125,0)
 ..K PSOOI,PSODD,PLACER,LOCATION,MED,REIN
"RTN","PSOAUTOC",126,0)
 S XMDUZ=.5,XMSUB="Date of Death Deleted for "_$P(^DPT(PSODFN,0),"^")_" ("_VA("BID")_")",XMTEXT="^TMP(""PSOAD"",$J," N DIFROM
"RTN","PSOAUTOC",127,0)
 F I=0:0 S I=$O(^XUSEC("PSORPH",I)) Q:'I  S XMY(I)=""
"RTN","PSOAUTOC",128,0)
 D ^XMD
"RTN","PSOAUTOC",129,0)
EX1 K ^TMP("PSOHLD",$J),XMSUB,XMTEXT,XMY,XMDUZ,^TMP("PSOAD",$J),I,TOTRX,TOTPRX,PSODFN,ENT,ORTYP,X,Y,MED,RX,PTDOD
"RTN","PSOAUTOC",130,0)
 Q
"RTN","PSOCAN3")
0^5^B70537692^B70221168
"RTN","PSOCAN3",1,0)
PSOCAN3 ;BIR/RTR/SAB - auto dc rxs due to death ; 4/30/09 11:47am
"RTN","PSOCAN3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,24,27,32,36,94,88,117,131,146,139,132,223,235,148,249,225,324**;DEC 1997;Build 6
"RTN","PSOCAN3",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN3",4,0)
 ;External references to L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN3",5,0)
 Q
"RTN","PSOCAN3",6,0)
APSOD(PSODFN) ;called from file #2 date of death xref 'APOSD'
"RTN","PSOCAN3",7,0)
 N D,DA,DB,DC,DE,DG,DH,DI,DIC,DIE,DIG,DIH,DIK,DIR,DIQ,DIU,DIV,DIW,DK,DL,DM,DP,DQ,DU,DV,DW,DR
"RTN","PSOCAN3",8,0)
 S PSODEATH=1 D CAN K PSODEATH
"RTN","PSOCAN3",9,0)
 Q
"RTN","PSOCAN3",10,0)
CAN ;discontinued rxs due to death
"RTN","PSOCAN3",11,0)
 I $G(PSODFN),$D(^PS(52.91,PSODFN,0)) D
"RTN","PSOCAN3",12,0)
 .I '$P($G(^PS(52.91,PSODFN,0)),"^",3)!($P($G(^(0)),"^",3)>DT) S $P(^PS(52.91,PSODFN,0),"^",3)=DT,$P(^PS(52.91,PSODFN,0),"^",4)=5,^PS(52.91,"AX",DT,PSODFN)="" D SET^PSOTPCAN(PSODFN)
"RTN","PSOCAN3",13,0)
 F PSORXJ=0:0 S PSORXJ=$O(^PS(55,PSODFN,"P",PSORXJ)) Q:'PSORXJ  I $D(^(PSORXJ,0)) S PSORX=^(0) S STA=$S($P($G(^PSRX(PSORX,"STA")),"^")<11:1,$P($G(^("STA")),"^")=16:1,1:0) D:STA
"RTN","PSOCAN3",14,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,"STA")),"^")="" D SETC
"RTN","PSOCAN3",15,0)
 .D REVERSE^PSOBPSU1(PSORX,,"DC",7)
"RTN","PSOCAN3",16,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,2)),"^",6)'<DT S PSO0=^(0),PSO2=$G(^(2)) D
"RTN","PSOCAN3",17,0)
 ..S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")
"RTN","PSOCAN3",18,0)
 ..;remove from hold
"RTN","PSOCAN3",19,0)
 ..I $G(^PSRX(PSORX,"H"))]"" D
"RTN","PSOCAN3",20,0)
 ...S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PSRX(PSORX,"H")
"RTN","PSOCAN3",21,0)
 ...K:$P(^PSRX(PSORX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSORX,"H"),"^"),PSORX) S ^PSRX(PSORX,"H")=""
"RTN","PSOCAN3",22,0)
 ...I '$P($G(^PSRX(PSORX,2)),"^",2),$P($G(^(3)),"^") S $P(^PSRX(PSORX,2),"^",2)=$P(^(3),"^")
"RTN","PSOCAN3",23,0)
 ...I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",24,0)
 ..;delete from non-verified file
"RTN","PSOCAN3",25,0)
 ..I $G(^PS(52.4,PSORX,0))]"" S ^PSRX(PSORX,"DDSTA")="52.4;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PS(52.4,PSORX,0),DIK="^PS(52.4,",DA=PSORX D ^DIK K DIK
"RTN","PSOCAN3",26,0)
 ..I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",27,0)
 ..;delete from suspense
"RTN","PSOCAN3",28,0)
 ..D:$O(^PS(52.5,"B",PSORX,0))
"RTN","PSOCAN3",29,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)) I '$G(^PS(52.5,DA,"P")),$G(PSODEATH) S ^PSRX(PSORX,"DDSTA")="52.5;5^"_^PS(52.5,DA,0),^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",30,0)
 ...I $O(^PSRX(PSORX,1,0)),'$G(PSODEATH) S DA=PSORX,SUSD=$P($G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),0)),"^",2) D:'$G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),"P")) REF^PSOCAN2
"RTN","PSOCAN3",31,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)),DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",32,0)
 ..D SETC
"RTN","PSOCAN3",33,0)
 ..;activity record
"RTN","PSOCAN3",34,0)
 ..S (COM,ACOM)=$S($G(PSODEATH):"Date of Death Entered by MAS",1:"Discontinued by Pharmacy")_"."
"RTN","PSOCAN3",35,0)
 ..S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(PSORX,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOCAN3",36,0)
 ..S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(PSORX,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN3",37,0)
 ..D NOW^%DTC S ACNT=ACNT+1,^PSRX(PSORX,"A",0)="^52.3DA^"_ACNT_"^"_ACNT
"RTN","PSOCAN3",38,0)
 ..S ^PSRX(PSORX,"A",ACNT,0)=%_"^"_"C"_"^^"_RFCNT_"^"_"Auto Discontinued Due to Death. "_ACOM
"RTN","PSOCAN3",39,0)
 ..;check for label/release/pending release
"RTN","PSOCAN3",40,0)
 ..D FIL
"RTN","PSOCAN3",41,0)
 ..S STAT="OD",PHARMST="" D EN^PSOHLSN1(PSORX,STAT,PHARMST,COM,"A") K COMM,PHARMST,STAT
"RTN","PSOCAN3",42,0)
 ;dc pending orders
"RTN","PSOCAN3",43,0)
 F PDA=0:0 S PDA=$O(^PS(52.41,"P",PSODFN,PDA)) Q:'PDA  I $P(^PS(52.41,PDA,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") D
"RTN","PSOCAN3",44,0)
 .I $G(PSODEATH) D
"RTN","PSOCAN3",45,0)
 ..S ^PS(52.41,PDA,"DDSTA")=$P(^PS(52.41,PDA,0),"^",3)_";"_+$P($G(^PS(52.41,PDA,"INI")),"^"),^PS(52.41,"APSOD",PSODFN,PDA)=""
"RTN","PSOCAN3",46,0)
 ..S $P(^PS(52.41,PDA,4),"^")="Date of Death Entered by MAS."
"RTN","PSOCAN3",47,0)
 .S $P(^PS(52.41,PDA,0),"^",3)="DC"
"RTN","PSOCAN3",48,0)
 .K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,PDA,"INI")),"^"),PDA)
"RTN","PSOCAN3",49,0)
 .S COM=$S($G(PSODEATH):"Date of Death Entered by MAS.",1:""),PL=$P(^PS(52.41,PDA,0),"^"),$P(^(0),"^",3)="DC"
"RTN","PSOCAN3",50,0)
 .D EN^PSOHLSN(PL,"OC",COM,"A") K COM,PL
"RTN","PSOCAN3",51,0)
 ;dc non-va meds
"RTN","PSOCAN3",52,0)
 D APSOD^PSONVNEW
"RTN","PSOCAN3",53,0)
KILL K %,%H,%T,ACNT,DA,PDA,DIRUT,DTOUT,PSO,PSO0,PSO2,PSOD,PSOD0,PSODFN,PSODL,PSORX,PSORXJ,PSOSD,RF,RFCNT,SUB,TM,TSKDT,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSOCAN3",54,0)
 D KVAR^VADPT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCAN3",55,0)
 Q
"RTN","PSOCAN3",56,0)
CAN1 Q:$G(DODR)
"RTN","PSOCAN3",57,0)
 S PSOMGDFN=$G(PSODFN) ; SAVE IN CASE CANCELING RX THAT WAS MERGED TO ANOTHER DFN
"RTN","PSOCAN3",58,0)
 I $G(^PSRX(DA,"H"))]"" D HLD^PSOCAN2
"RTN","PSOCAN3",59,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7)
"RTN","PSOCAN3",60,0)
 S PSCANVAR=0,RXDA=DA,DA=$O(^PS(52.5,"B",DA,0)) I DA,'$G(^PS(52.5,DA,"P")) S PSCANVAR=1 D
"RTN","PSOCAN3",61,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOCAN3",62,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while suspended. "_$G(COM)
"RTN","PSOCAN3",63,0)
 .S DIK="^PS(52.5," D ^DIK K DIK S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2)
"RTN","PSOCAN3",64,0)
 .D AREC^PSOCAN1 S DA=RXDA I $O(^PSRX(DA,1,0)) D REF^PSOCAN2
"RTN","PSOCAN3",65,0)
 I $G(REA)="C" S DA=$O(^PS(52.5,"B",RXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",66,0)
 I 'PSCANVAR S:$D(SPCANC) ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" during Rx cancel.  "
"RTN","PSOCAN3",67,0)
ADD S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) S:$G(PSOOPT)=3 REA="L"
"RTN","PSOCAN3",68,0)
 D:'$G(PSCANVAR) AREC^PSOCAN1 S:REA="L" REA="C" S:REA'="C" $P(^PSRX(DA,"STA"),"^")=0
"RTN","PSOCAN3",69,0)
 N PSOTPCNZ S PSOTPCNZ=0 I $P(^PSRX(DA,"STA"),"^")'=12 S PSOTPCNZ=1
"RTN","PSOCAN3",70,0)
 S:REA="C"&($P(^PSRX(DA,"STA"),"^")<12)!($P(^("STA"),"^")=16) $P(^PSRX(DA,"STA"),"^")=12 I $P($G(^PSRX(DA,"STA")),"^")=12,$G(PSOTPCNZ) D CAN^PSOTPCAN(DA)
"RTN","PSOCAN3",71,0)
 K PSOTPCNZ
"RTN","PSOCAN3",72,0)
 I REA="R" D
"RTN","PSOCAN3",73,0)
 .I $P(^PSRX(DA,3),"^",8) S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8),$P(^(3),"^",8)=""
"RTN","PSOCAN3",74,0)
 .S $P(^PSRX(DA,3),"^")=$S($P(^PSRX(DA,3),"^",10):$P(^(3),"^",10),$G(PSOCANHD):PSOCANHD,$P(^(3),"^",5):$P(^(3),"^",5),1:$P(^(3),"^")),$P(^(3),"^",5)="",$P(^(3),"^",10)=""
"RTN","PSOCAN3",75,0)
 I REA="C" D
"RTN","PSOCAN3",76,0)
 .S $P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOCAN3",77,0)
 .S:'$P(^PSRX(DA,3),"^",5) $P(^PSRX(DA,3),"^",5)=DT
"RTN","PSOCAN3",78,0)
 .I $O(^PS(52.41,"ARF",DA,0)),'$O(^PS(52.41,"APSOD",PSODFN,0)) S HLDDA=DA,DA=$O(^PS(52.41,"ARF",DA,0)),DIK="^PS(52.41," D ^DIK S DA=HLDDA K HLDDA
"RTN","PSOCAN3",79,0)
 .;check for label/release/pending release
"RTN","PSOCAN3",80,0)
 .I $G(PSOOPT)'=3 D FILX
"RTN","PSOCAN3",81,0)
 S PSONOOR=$S($D(PSONOOR):PSONOOR,1:"D"),STAT=$S(REA="C":"OD",1:"SC"),PHARMST=$S(REA="C":"",1:"CM")
"RTN","PSOCAN3",82,0)
 S COM=$S(REA="C":$S($G(PSOOPT)=3&('$G(DUP)):"Renewed",1:"Discontinued")_" by Pharmacy",1:"Reinstated by Pharmacy")
"RTN","PSOCAN3",83,0)
 D EN^PSOHLSN1(DA,STAT,PHARMST,$S(COM["Discontinued"&($D(INCOM)):INCOM,1:COM),$S($G(PSOOPT)=3&('$G(DUP)):"",1:PSONOOR)) K COM,STAT,PHARMST,PSCANVAR
"RTN","PSOCAN3",84,0)
 I REA="C" D
"RTN","PSOCAN3",85,0)
 .I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOCAN3",86,0)
 I $G(PSOMGDFN)'="" S PSODFN=PSOMGDFN K PSOMGDFN
"RTN","PSOCAN3",87,0)
 Q:(REA="C")!('$P($G(PSOPAR),"^",2))!($P(^PSRX(DA,2),"^",10)]"")
"RTN","PSOCAN3",88,0)
 Q:$D(^XUSEC("PSORPH",DUZ))  S PSVC=$P(^PSRX(DA,0),"^",16) F JJ=0:0 S JJ=$O(^PS(55,PSODFN,"P",JJ)) Q:'JJ  I $D(^(JJ,0)),+^(0)=DA Q
"RTN","PSOCAN3",89,0)
 Q:'JJ  S PSRXIN=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXIN,DIC(0)="ML"
"RTN","PSOCAN3",90,0)
 S DIC("DR")="1////"_$G(PSODFN)_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN3",91,0)
 K DD,DO D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM
"RTN","PSOCAN3",92,0)
 K DA,DIK S DA=PSRXIN K PSRXIN S $P(^PSRX(DA,"STA"),"^")=1 D NVER^PSOCAN2
"RTN","PSOCAN3",93,0)
 W !,"Rx # "_$P(^PSRX(DA,0),"^")_" is still non-verified!"
"RTN","PSOCAN3",94,0)
 Q
"RTN","PSOCAN3",95,0)
OERR I '$D(^XUSEC("PSORPH",DUZ)),'$P($G(PSOPAR),"^",2) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOCAN3",96,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOCAN3",97,0)
 K PSOPLCK S PSOCANRD=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",4),PSOCANRA=1
"RTN","PSOCAN3",98,0)
 I $P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^"),$P(^("STA"),"^")=1!($P(^("STA"),"^")=4) S:$G(SPEED) PSONOORS=$G(PSONOOR) D DEL^PSOCAN4 S:$G(PSONOORS)'="" PSONOOR=$G(PSONOORS) K PSONOORS D KCAN D ULP Q
"RTN","PSOCAN3",99,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D KCAN D ULP Q
"RTN","PSOCAN3",100,0)
 I '+^PSRX($P(PSOLST(ORN),"^",2),"OR1"),$P(^("STA"),"^")=12 S VALMSG="Rx Cannot be Reinstated.  No Orderable Item." D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",101,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12,$P($G(^("PKI")),"^") S VALMSG="Cannot be Reinstated - Digitally Signed" D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",102,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 S PSOCANRZ=1
"RTN","PSOCAN3",103,0)
 D HLDHDR^PSOLMUTL S X=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),PS=$S($P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^")=12:"Reinstate: ",1:"Discontinue: ")
"RTN","PSOCAN3",104,0)
 S POERR=1,DFNHLD=PSODFN,DA=$P(PSOLST(ORN),"^",2)
"RTN","PSOCAN3",105,0)
 I $P(^PSRX(DA,3),"^",5) S PSOCANHD=$P(^PSRX(DA,3),"^",5)
"RTN","PSOCAN3",106,0)
 D LMNO D:$P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 RMP
"RTN","PSOCAN3",107,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOCAN3",108,0)
 K POERR,PSCAN,PSI,PSL S PSODFN=DFNHLD K DFNHLD D ULP
"RTN","PSOCAN3",109,0)
 D KCAN
"RTN","PSOCAN3",110,0)
 Q
"RTN","PSOCAN3",111,0)
 Q
"RTN","PSOCAN3",112,0)
ULP D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOCAN3",113,0)
 Q
"RTN","PSOCAN3",114,0)
 ;
"RTN","PSOCAN3",115,0)
LMNO ; Calls LMNO^PSOCAN
"RTN","PSOCAN3",116,0)
 N PSODFN,PSORX,RXN,RX0
"RTN","PSOCAN3",117,0)
 S PSPOP=0,RXNUM=X S PSODFN=+$P(^PSRX(DA,0),"^",2) D LMNO^PSOCAN
"RTN","PSOCAN3",118,0)
 Q
"RTN","PSOCAN3",119,0)
 ;
"RTN","PSOCAN3",120,0)
KCAN ;
"RTN","PSOCAN3",121,0)
 K PSOCANRA,PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ,PSOMSG,PSOCANHD
"RTN","PSOCAN3",122,0)
 Q
"RTN","PSOCAN3",123,0)
 ;
"RTN","PSOCAN3",124,0)
KCAN1 ;
"RTN","PSOCAN3",125,0)
 K PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ
"RTN","PSOCAN3",126,0)
 Q
"RTN","PSOCAN3",127,0)
 ;
"RTN","PSOCAN3",128,0)
RMP D RMP^PSOCAN3N
"RTN","PSOCAN3",129,0)
 Q
"RTN","PSOCAN3",130,0)
 ;
"RTN","PSOCAN3",131,0)
FIL Q:'$G(PSORX)
"RTN","PSOCAN3",132,0)
 S PSOFC=PSORX G FILC
"RTN","PSOCAN3",133,0)
FILX Q:'$G(DA)
"RTN","PSOCAN3",134,0)
 S PSOFC=DA
"RTN","PSOCAN3",135,0)
FILC ;
"RTN","PSOCAN3",136,0)
 N PFC,PSOFFLAG
"RTN","PSOCAN3",137,0)
 I $P($G(^PSRX(PSOFC,2)),"^",13) G FILQ
"RTN","PSOCAN3",138,0)
 S PSOFFLAG=0 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,1,PFC)) Q:'PFC!(PSOFFLAG)  I $P($G(^PSRX(PSOFC,1,PFC,0)),"^",18) S PSOFFLAG=1
"RTN","PSOCAN3",139,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",140,0)
 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,"L",PFC)) Q:'PFC!(PSOFFLAG)  I $D(^PSRX(PSOFC,"L",PFC,0)),'$P($G(^(0)),"^",5) S PSOFFLAG=1
"RTN","PSOCAN3",141,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",142,0)
 S PSOFCSUS=$O(^PS(52.5,"B",PSOFC,0))
"RTN","PSOCAN3",143,0)
 I $G(PSOFCSUS),$P($G(^PS(52.5,PSOFCSUS,0)),"^",7)="L"!($P($G(^(0)),"^",7)="X") G FILQ
"RTN","PSOCAN3",144,0)
 S $P(^PSRX(PSOFC,3),"^",8)=$P($G(^PSRX(PSOFC,3)),"^",2)
"RTN","PSOCAN3",145,0)
 S $P(^PSRX(PSOFC,3),"^",2)=$P($G(^PSRX(PSOFC,2)),"^",2)
"RTN","PSOCAN3",146,0)
 I $P($G(^PSRX(PSOFC,"OR1")),"^",3) S $P(^PSRX(PSOFC,3),"^")=$P($G(^PSRX($P(^PSRX(PSOFC,"OR1"),"^",3),3)),"^")
"RTN","PSOCAN3",147,0)
FILQ K PSOFC,PSOFCSUS
"RTN","PSOCAN3",148,0)
 Q
"RTN","PSOCAN3",149,0)
 ;
"RTN","PSOCAN3",150,0)
SETC ;Called from Date of Death
"RTN","PSOCAN3",151,0)
 S $P(^PSRX(PSORX,"STA"),"^")=12,$P(^PSRX(PSORX,3),"^",5)=DT,$P(^PSRX(PSORX,3),"^",10)=$P(^PSRX(PSORX,3),"^") D CAN^PSOTPCAN(PSORX)
"RTN","PSOCAN3",152,0)
 D CHKCMOP^PSOUTL(PSORX,"D")
"RTN","PSOCAN3",153,0)
 Q
"RTN","PSODRDUP")
0^6^B48009751^B46478362
"RTN","PSODRDUP",1,0)
PSODRDUP ;BIR/SAB - Dup drug class checker ;4/30/09 12:32pm
"RTN","PSODRDUP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,39,56,130,132,192,207,222,243,305,324**;DEC 1997;Build 6
"RTN","PSODRDUP",3,0)
 ;
"RTN","PSODRDUP",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODRDUP",5,0)
 S $P(PSONULN,"-",79)="-",(STA,DNM)="" K CLS
"RTN","PSODRDUP",6,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""!$G(PSORX("DFLG"))  I $P(PSOSD(STA,DNM),"^")'=$G(PSORENW("OIRXN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",7,0)
 .I STA="PENDING" D ^PSODRDU1 Q
"RTN","PSODRDUP",8,0)
 .I STA="ZNONVA" D NVA^PSODRDU1 Q
"RTN","PSODRDUP",9,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",10,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",11,0)
 ..I $P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",12,0)
 ..I '$P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",13,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",14,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") D CLS
"RTN","PSODRDUP",15,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSODRDUP",16,0)
 D REMOTE^PSOCPDUP
"RTN","PSODRDUP",17,0)
EXIT D ^PSOBUILD K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSODRDUP",18,0)
 Q
"RTN","PSODRDUP",19,0)
DUP S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"Duplicate Drug "_$P(DNM,"^")_" in Prescription: ",$P(^PSRX(+PSOSD(STA,DNM),0),"^")
"RTN","PSODRDUP",20,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Drug"
"RTN","PSODRDUP",21,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODRDUP",22,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODRDUP",23,0)
 W !!,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2 W ?40,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSODRDUP",24,0)
 S DA=RXREC D PRSTAT(DA)
"RTN","PSODRDUP",25,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODRDUP",26,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSODRDUP",27,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSODRDUP",28,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSODRDUP",29,0)
 K BSIG,PSREV
"RTN","PSODRDUP",30,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?40,$J("# of refills: ",24)_RFLS S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSODRDUP",31,0)
 W !,$J("Provider: ",24)_PHYS,?40,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSODRDUP",32,0)
 S LSTFL=+^PSRX(RXREC,3) W !?40,$J("Last filled on: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3),!?40,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSODRDUP",33,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODRDUP",34,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC Q
"RTN","PSODRDUP",35,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODRDUP",36,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODRDUP",37,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! K DUP,RXRECLOC S PSORX("DFLG")=1 Q
"RTN","PSODRDUP",38,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODRDUP",39,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODRDUP",40,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECLOC,0)),"^"),!
"RTN","PSODRDUP",41,0)
 K PSOMSG S DIR("A")=$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^"),DIR(0)="Y",DIR("?")="Enter Y to "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODRDUP",42,0)
 D ^DIR K DIR S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODRDUP",43,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODRDUP",44,0)
 I 'Y W $C(7)," -Prescription was not "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODRDUP",45,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP D ULRX K RXRECLOC
"RTN","PSODRDUP",46,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODRDUP",47,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSODRDUP",48,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C")
"RTN","PSODRDUP",49,0)
 W !!,"Duplicate "_$S($G(CLS):"Class",1:"Drug")_" will be discontinued after the acceptance of the new order.",!
"RTN","PSODRDUP",50,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D"
"RTN","PSODRDUP",51,0)
 K RXRECLOC,DUP,CLS,PSONOOR Q
"RTN","PSODRDUP",52,0)
CLS K DUP
"RTN","PSODRDUP",53,0)
 I $E($G(PSODRUG("VA CLASS")),1,2)="HA",$E($P($G(PSOSD(STA,DNM)),"^",5),1,2)="HA" K PSOELSE Q
"RTN","PSODRDUP",54,0)
 S CLS=1,MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Class" W !,PSONULN
"RTN","PSODRDUP",55,0)
 W !?5,$C(7),"*** SAME CLASS *** OF DRUG IN RX #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" FOR "_$P(DNM,"^"),!,"CLASS: "_PSODRUG("VA CLASS")
"RTN","PSODRDUP",56,0)
 S CAN=$P(PSOSD(STA,DNM),"^",2)'<11!($P(PSOSD(STA,DNM),"^",2)=1) S RXREC=+PSOSD(STA,DNM) I $P($G(PSOPAR),"^",10) D DATA Q
"RTN","PSODRDUP",57,0)
 E  W !,PSONULN K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT
"RTN","PSODRDUP",58,0)
 K PSOELSE Q
"RTN","PSODRDUP",59,0)
ULRX ;
"RTN","PSODRDUP",60,0)
 I '$G(RXRECLOC) Q
"RTN","PSODRDUP",61,0)
 D PSOUL^PSSLOCK(RXRECLOC)
"RTN","PSODRDUP",62,0)
 Q
"RTN","PSODRDUP",63,0)
 ;
"RTN","PSODRDUP",64,0)
PRSTAT(DA) ;Displays the prescription's status
"RTN","PSODRDUP",65,0)
 N PSOTRANS,PSOREL,CMOP,RXPSTA,PSOX,RFLZRO,PSOLRD,PSORTS
"RTN","PSODRDUP",66,0)
 S RXPSTA="Processing Status: ",PSOLRD=$P($G(^PSRX(RXREC,2)),"^",13)
"RTN","PSODRDUP",67,0)
 D ^PSOCMOPA I $G(PSOCMOP)]"" D  K CMOP,PSOTRANS,PSOREL
"RTN","PSODRDUP",68,0)
 .S PSOTRANS=$E($P(PSOCMOP,"^",2),4,5)_"/"_$E($P(PSOCMOP,"^",2),6,7)_"/"_$E($P(PSOCMOP,"^",2),2,3)
"RTN","PSODRDUP",69,0)
 .S PSOREL=$S(CMOP("L")=0:$P($G(^PSRX(DA,2)),"^",13),1:$P(^PSRX(DA,1,CMOP("L"),0),"^",18))
"RTN","PSODRDUP",70,0)
 .S PSOREL=$E(PSOREL,4,5)_"/"_$E(PSOREL,6,7)_"/"_$E(PSOREL,2,3)_"@"_$E($P(PSOREL,".",2),1,4)
"RTN","PSODRDUP",71,0)
 .I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSODRDUP",72,0)
 .W !
"RTN","PSODRDUP",73,0)
 .I $P($G(^PSRX(RXREC,"STA")),"^")=0 D
"RTN","PSODRDUP",74,0)
 ..W:$$TRANCMOP^PSOUTL(RXREC) ?5,IORVON_IOINHI
"RTN","PSODRDUP",75,0)
 .W ?5,RXPSTA_$S($P(PSOCMOP,"^")=0!($P(PSOCMOP,"^")=2):"Transmitted to CMOP on "_PSOTRANS,$P(PSOCMOP,"^")=1:"Released by CMOP on "_PSOREL,1:"Not Dispensed"),IOINORM_IORVOFF
"RTN","PSODRDUP",76,0)
 I $G(PSOCMOP)']"" D
"RTN","PSODRDUP",77,0)
 .F PSOX=0:0 S PSOX=$O(^PSRX(RXREC,1,PSOX)) Q:'PSOX  D
"RTN","PSODRDUP",78,0)
 ..S RFLZRO=$G(^PSRX(RXREC,1,PSOX,0))
"RTN","PSODRDUP",79,0)
 ..S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R",PSORTS=$P(RFLZRO,"^",16)
"RTN","PSODRDUP",80,0)
 .I '$O(^PSRX(RXREC,1,0)),$P(^PSRX(RXREC,2),"^",15) S PSOLRD=PSOLRD_"^R",PSORTS=$P(^PSRX(RXREC,2),"^",15)
"RTN","PSODRDUP",81,0)
 .W !,$J(RXPSTA,24) I +$G(PSORTS) W "Returned to stock on "_$$FMTE^XLFDT(PSORTS,2) Q
"RTN","PSODRDUP",82,0)
 .W $S(PSOLRD="":"Not released locally",1:"Released locally on "_$$FMTE^XLFDT($P(PSOLRD,"^"),2)_" "_$P(PSOLRD,"^",2))_$S($P(^PSRX(RXREC,0),"^",11)="W":" (Window)",1:" (Mail)")
"RTN","PSODRDUP",83,0)
 Q
"RTN","PSODRG")
0^1^B38932823^B35387370
"RTN","PSODRG",1,0)
PSODRG ;IHS/DSD/JCM-ORDER ENTRY DRUG SELECTION ;03/30/93
"RTN","PSODRG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,23,36,53,54,46,112,139,207,148,243,268,324**;DEC 1997;Build 6
"RTN","PSODRG",3,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSODRG",4,0)
 ;Reference ^PS(50.7 supported by DBIA 2223
"RTN","PSODRG",5,0)
 ;Reference to PSSDIN supported by DBIA 3166
"RTN","PSODRG",6,0)
 ;Reference to $$NDCFMT^PSSNDCUT supported by IA 4707
"RTN","PSODRG",7,0)
 ;----------------------------------------------------------
"RTN","PSODRG",8,0)
START ;
"RTN","PSODRG",9,0)
 S (PSONEW("DFLG"),PSONEW("FIELD"),PSODRG("QFLG"))=0
"RTN","PSODRG",10,0)
 D @($S(+$G(PSOEDIT)=1&('$D(DA)):"SELECT^PSODRGN",1:"SELECT"))
"RTN","PSODRG",11,0)
 G:$G(PSORXED("DFLG")) END ; Select Drug
"RTN","PSODRG",12,0)
 I $G(PSORX("EDIT")),$G(PSOY),$G(PSODRUG("IEN"))=+PSOY D  G:$G(PSORXED("DFLG")) END
"RTN","PSODRG",13,0)
 . N NDC D NDC(+$G(PSORXED("IRXN")),0,+PSOY,.NDC) I $G(NDC)="^" S PSORXED("DFLG")=1 Q
"RTN","PSODRG",14,0)
 . I $G(NDC)'="" S (PSODRUG("NDC"),PSORXED("FLD",27))=NDC
"RTN","PSODRG",15,0)
 ;
"RTN","PSODRG",16,0)
 I $G(PSORX("EDIT"))]"",'PSONEW("FIELD") D TRADE
"RTN","PSODRG",17,0)
 G:PSONEW("DFLG")!(PSODRG("QFLG"))!($G(PSORXED("DFLG"))) END
"RTN","PSODRG",18,0)
 D SET ; Set various drug information
"RTN","PSODRG",19,0)
 D NFI ; Display dispense drug/orderable item text
"RTN","PSODRG",20,0)
 D:'$G(PSOEDIT) POST I $G(PSORX("DFLG")) S PSONEW("DFLG")=1 K:'$G(PSORX("EDIT")) PSORX("DFLG") ; Do any post selection action
"RTN","PSODRG",21,0)
END ;D EOJ
"RTN","PSODRG",22,0)
 Q
"RTN","PSODRG",23,0)
 ;------------------------------------------------------------
"RTN","PSODRG",24,0)
 ;
"RTN","PSODRG",25,0)
SELECT ;
"RTN","PSODRG",26,0)
 K:'$G(PSORXED) CLOZPAT
"RTN","PSODRG",27,0)
 K DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODRG",28,0)
 I $G(PSODRUG("IEN"))]"" S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODRG",29,0)
 W !,"DRUG: "_$S($G(Y)]"":Y_"// ",1:"") R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSODRG",30,0)
 I X="",$G(Y)]"" S:Y X=Y S:'X X=$G(PSODRUG("IEN")) S:X X="`"_X
"RTN","PSODRG",31,0)
 G:X="" SELECT
"RTN","PSODRG",32,0)
 I X?1."?" W !!,"Answer with DRUG NUMBER, or GENERIC NAME, or VA PRODUCT NAME, or",!,"NATIONAL DRUG CLASS, or SYNONYM" G SELECT
"RTN","PSODRG",33,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODRG",34,0)
 I X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",35,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODRG",36,0)
 S DIC=50,DIC(0)="EMQZVT",DIC("T")="",D="B^C^VAPN^VAC"
"RTN","PSODRG",37,0)
 S DIC("S")="I $S('$D(^PSDRUG(+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$S($P($G(^PSDRUG(+Y,2)),""^"",3)'[""O"":0,1:1),$D(^PSDRUG(""ASP"",+$G(^(2)),+Y))"
"RTN","PSODRG",38,0)
 D MIX^DIC1 K DIC,D
"RTN","PSODRG",39,0)
 I $D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",40,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODRG",41,0)
 I Y<0 G SELECT
"RTN","PSODRG",42,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODRG",43,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSODRG",44,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE
"RTN","PSODRG",45,0)
SELECTX K X,Y,DTOUT,DUOUT,PSONEW("OLD VAL")
"RTN","PSODRG",46,0)
 Q
"RTN","PSODRG",47,0)
 ;
"RTN","PSODRG",48,0)
NDC(RX,RFL,DRG,NDC) ; Editing NDC for ECME Released Rx's
"RTN","PSODRG",49,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",50,0)
 I $$STATUS^PSOBPSUT(RX,RFL)="" Q
"RTN","PSODRG",51,0)
 I '$$RXRLDT^PSOBPSUT(RX,RFL) Q
"RTN","PSODRG",52,0)
 ;
"RTN","PSODRG",53,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",54,0)
 D NDCEDT^PSONDCUT(RX,.RFL,$G(DRG),$G(PSOSITE),.NDC)
"RTN","PSODRG",55,0)
 Q
"RTN","PSODRG",56,0)
 ;
"RTN","PSODRG",57,0)
TRADE ;
"RTN","PSODRG",58,0)
 K DIR,DIC,DA,X,Y
"RTN","PSODRG",59,0)
 S DIR(0)="52,6.5" S:$G(PSOTRN)]"" DIR("B")=$G(PSOTRN) D ^DIR K DIR,DIC
"RTN","PSODRG",60,0)
 I X="@" S Y=X K DIRUT
"RTN","PSODRG",61,0)
 I $D(DIRUT) S:$D(DUOUT)!$D(DTOUT)&('$D(PSORX("EDIT"))) PSONEW("DFLG")=1 G TRADEX
"RTN","PSODRG",62,0)
 S PSODRUG("TRADE NAME")=Y
"RTN","PSODRG",63,0)
TRADEX I $G(PSORXED("DFLG")),$D(DIRUT) S PSORXED("DFLG")=1
"RTN","PSODRG",64,0)
 K DIRUT,DTOUT,DUOUT,X,Y,DA,DR,DIE
"RTN","PSODRG",65,0)
 Q
"RTN","PSODRG",66,0)
SET ;
"RTN","PSODRG",67,0)
 N STAT S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2)
"RTN","PSODRG",68,0)
 S PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSODRG",69,0)
 S:+$G(^PSDRUG(+PSOY,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSODRG",70,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODRG",71,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3)
"RTN","PSODRG",72,0)
 S PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSODRG",73,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5)
"RTN","PSODRG",74,0)
 I $G(PSODRUG("NDC"))="" S PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE))
"RTN","PSODRG",75,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSODRG",76,0)
 S PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSODRG",77,0)
 G:$G(^PSDRUG(+PSOY,660))']"" SETX
"RTN","PSODRG",78,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660))
"RTN","PSODRG",79,0)
 S PSODRUG("COST")=$P($G(PSOX1),"^",6)
"RTN","PSODRG",80,0)
 S PSODRUG("UNIT")=$P($G(PSOX1),"^",8)
"RTN","PSODRG",81,0)
 S PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSODRG",82,0)
SETX K PSOX1,PSOY
"RTN","PSODRG",83,0)
 Q
"RTN","PSODRG",84,0)
NFI ;display restriction/guidelines
"RTN","PSODRG",85,0)
 D EN^PSSDIN(PSODRUG("OI"),PSODRUG("IEN")) S NFI=$$PROMPT^PSSDIN
"RTN","PSODRG",86,0)
 I NFI]"","ODY"[NFI D TD^PSONFI
"RTN","PSODRG",87,0)
 K NFI Q
"RTN","PSODRG",88,0)
POST ;order checks
"RTN","PSODRG",89,0)
 K PSORX("INTERVENE") N STAT,SIG,PTR,NDF,VAP S PSORX("DFLG")=0
"RTN","PSODRG",90,0)
 D ^PSOBUILD
"RTN","PSODRG",91,0)
 D @$S($G(COPY):"^PSOCPDUP",1:"^PSODRDUP") ; Set PSORX("DFLG")=1 if process to stop
"RTN","PSODRG",92,0)
 Q:$G(PSORX("DFLG"))
"RTN","PSODRG",93,0)
 W:$G(PSOFIN)']"" !,"Now doing drug interaction and allergy checks.  Please wait...",!
"RTN","PSODRG",94,0)
 D ^PSODGDGI
"RTN","PSODRG",95,0)
 I $G(PSORX("INTERVENE"))]"" D FULL^VALM1,^PSORXI S VALMBCK="R"
"RTN","PSODRG",96,0)
 G:PSORX("DFLG") POSTX
"RTN","PSODRG",97,0)
 D:$P($G(^PSDRUG(PSODRUG("IEN"),"CLOZ1")),"^")]"" CLOZ G:PSORX("DFLG") POSTX
"RTN","PSODRG",98,0)
 K PSORX("INTERVENE")
"RTN","PSODRG",99,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D:PSONOAL'="" NOALRGY K PSONOAL
"RTN","PSODRG",100,0)
 G:PSORX("DFLG") POSTX
"RTN","PSODRG",101,0)
 I $D(PSODRUG("NDF")) S NDF=$P(PSODRUG("NDF"),"A"),VAP=$P(PSODRUG("NDF"),"A",2),PTR=NDF_"."_VAP
"RTN","PSODRG",102,0)
 I $G(NDF) D CHK^PSODGAL(PSODFN,"DR",PTR) K NDF,VAP,PTR
"RTN","PSODRG",103,0)
 I $P($G(PSODRUG("NDF")),"A")=0 D CHK1^PSODGAL(PSODFN)
"RTN","PSODRG",104,0)
 I $D(PSODRUG("VA CLASS")) D CLASS^PSODGAL(PSODFN)
"RTN","PSODRG",105,0)
POSTX ;
"RTN","PSODRG",106,0)
 K ^TMP($J,"DI"_PSODFN),^TMP($J,"DI")
"RTN","PSODRG",107,0)
 K PSORX("INTERVENE"),DA
"RTN","PSODRG",108,0)
 Q
"RTN","PSODRG",109,0)
 ;
"RTN","PSODRG",110,0)
EOJ ;
"RTN","PSODRG",111,0)
 K PSODRG
"RTN","PSODRG",112,0)
 Q
"RTN","PSODRG",113,0)
 ;
"RTN","PSODRG",114,0)
CLOZ ;
"RTN","PSODRG",115,0)
 S ANQRTN=$P(^PSDRUG(PSODRUG("IEN"),"CLOZ1"),"^"),ANQX=0
"RTN","PSODRG",116,0)
 S P(5)=PSODRUG("IEN"),DFN=PSODFN,X=ANQRTN
"RTN","PSODRG",117,0)
 X ^%ZOSF("TEST") I  D @("^"_ANQRTN) S:$G(ANQX) PSORX("DFLG")=1
"RTN","PSODRG",118,0)
 K P(5),ANQRTN,ANQX,X
"RTN","PSODRG",119,0)
 Q
"RTN","PSODRG",120,0)
 ;
"RTN","PSODRG",121,0)
EN(DRG) ;returns lab test identified for clozapine order checking
"RTN","PSODRG",122,0)
 K LAB I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")'="PSOCLO1" S LAB("NOT")=0 Q
"RTN","PSODRG",123,0)
 I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSODRG",124,0)
 .S (CNT,I)=0 F  S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  S CNT=$G(CNT)+1
"RTN","PSODRG",125,0)
 .I CNT'=2 S LAB("BAD TEST")=0 K CNT Q
"RTN","PSODRG",126,0)
 .K CNT F I=0:0 S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  D
"RTN","PSODRG",127,0)
 ..S LABT=$S($P(^PSDRUG(DRG,"CLOZ2",I,0),"^",4)=1:"WBC",1:"ANC"),LAB(LABT)=$P(^PSDRUG(DRG,"CLOZ2",I,0),"^")_"^"_$P(^(0),"^",3)_"^"_$P(^(0),"^",4)
"RTN","PSODRG",128,0)
 K LABT,I
"RTN","PSODRG",129,0)
 Q
"RTN","PSODRG",130,0)
NOALRGY ;
"RTN","PSODRG",131,0)
 N DIR
"RTN","PSODRG",132,0)
 S DIR(0)="SA^1:YES;0:NO"
"RTN","PSODRG",133,0)
 I $D(^TMP($J,"PSOINTERVENE",+PSODFN)) D  Q
"RTN","PSODRG",134,0)
 .S DIR("A")="No Allergy Assessment - Do you want to duplicate Intervention?: ",DIR("B")="Yes"
"RTN","PSODRG",135,0)
 .D ^DIR
"RTN","PSODRG",136,0)
 .I 'Y D  Q
"RTN","PSODRG",137,0)
 ..I Y=0 D ^PSORXI Q
"RTN","PSODRG",138,0)
 ..S PSORX("DFLG")=1
"RTN","PSODRG",139,0)
 .D DUPINV^PSORXI
"RTN","PSODRG",140,0)
 W $C(7),!,"There is no allergy assessment on file for this patient."
"RTN","PSODRG",141,0)
 W !,"You will be prompted to intervene if you continue with this prescription"
"RTN","PSODRG",142,0)
 S DIR("A")="Do you want to Continue?: ",DIR("B")="N" D ^DIR
"RTN","PSODRG",143,0)
 I 'Y D  Q
"RTN","PSODRG",144,0)
 .I $D(PSONV) S PSZZQUIT=1 Q
"RTN","PSODRG",145,0)
 .S PSORX("DFLG")=1
"RTN","PSODRG",146,0)
 I $D(PSONV) S PSORX("INTERVENE")=0 D EN1^PSORXI(PSONV) Q
"RTN","PSODRG",147,0)
 D ^PSORXI
"RTN","PSODRG",148,0)
 Q
"RTN","PSOHLNEW")
0^7^B80638841^B80329211
"RTN","PSOHLNEW",1,0)
PSOHLNEW ;BIR/RTR - CPRS orders ;2/25/09 11:01am
"RTN","PSOHLNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,7,15,46,71,98,111,124,117,131,146,132,143,223,235,148,239,249,225,324**;DEC 1997;Build 6
"RTN","PSOHLNEW",3,0)
 ;40.8-728,50-221,SC-2675,100-2219,50.7-2223,EN^ORERR-2187
"RTN","PSOHLNEW",4,0)
EN(MSG) ;
"RTN","PSOHLNEW",5,0)
 N PSODDRUG,ENTERED,LOCATION,PLACER,PSOOC,ROUTE,NATURE,PREV,ROUTING,OO,OR,STAT,ZZ,DFN,COMM,QCOUNT,OCOUNT,Q1I,QTARRAY,QTARRAY2,EE,PP,XOFLAG,PSODYSPL,PSOFILNM
"RTN","PSOHLNEW",6,0)
 N ONEFLAG,SERV,WPCT,EFFECT,PROV,PENDING,RRX,PSOLQ1I,PSOLQ1II,PSOQWX,PSOLQ1IX,PSONVA,PSOICD,PSOSCP,EEE
"RTN","PSOHLNEW",7,0)
 N OBXAR,AA,II,SIG1,FILLER,COMM,GG,FF,JJ,JJJ,CT,LIM,VAR,VAR1,QQQ,PSRNFLAG,PSRNQFLG,RCOMM,XOFLAGZ,NWFLAG,PFLAG,PSINPTR,INPTRX,PSOIBN,PSOIBY
"RTN","PSOHLNEW",8,0)
 N DSIG,PSOCHFFL,PSOCVI,PSOMO,PSOXRP,NN,LL,LLL,WPARRAY,QTVAR,POVAR,POVAR1,ORCSEG,NNN,OOO,AAA,NNNN,POLIM,NNCK,PRIOR,IPPLACER,PLACERXX,EER,PSERRPID,PSERRPV1,PSERRORC,PSOEXFLG,PSOMSORR,PDFN,VAL
"RTN","PSOHLNEW",9,0)
 S (SEND,PSOSND,OCOUNT)=0 K PSOPLC,PSOFFL,PSORSO,PSOSUSZ
"RTN","PSOHLNEW",10,0)
 F OO=0:0 S OO=$O(MSG(OO)) Q:'OO!(SEND)!(PSOSND)  D:$P(MSG(OO),"|")="PID" SPDFN I $P(MSG(OO),"|")="ORC",$P(MSG(OO),"|",2)'="NW",$P(MSG(OO),"|",2)'="XO" D
"RTN","PSOHLNEW",11,0)
 .S OR("STAT")=$P(MSG(OO),"|",2),OR("PLACE")=+$P(MSG(OO),"|",3),PLACERXX=+$P($P(MSG(OO),"|",3),";",2),OR("COMM")=$P(MSG(OO),"|",17),OR("USER")=$P(MSG(OO),"|",11) I $P(MSG(OO),"|",2)'="DE",$P(MSG(OO),"|",2)'="NA" S SEND=1 D FILL Q
"RTN","PSOHLNEW",12,0)
 .S PSOPLC=+$P(MSG(OO),"|",3),PSOFFL=+$P(MSG(OO),"|",4),PSOSND=1,PSOCHFFL=$P($P(MSG(OO),"|",4),"^")
"RTN","PSOHLNEW",13,0)
 I $G(OR("COMM"))["^" S OR("COMM")=$P(OR("COMM"),"^",5)
"RTN","PSOHLNEW",14,0)
 I PSOSND,$G(PSOCHFFL)["S",$G(OR("STAT"))="NA" D CHCS^PSOHLNE1 Q
"RTN","PSOHLNEW",15,0)
 I PSOSND,'$D(^PSRX(+$G(PSOFFL),0)) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) D KL Q
"RTN","PSOHLNEW",16,0)
 I PSOSND,$G(PDFN),PDFN'=+$P($G(^PSRX(+$G(PSOFFL),0)),"^",2) S COMM="Patient does not match" D EN^ORERR(COMM,.MSG) D KL Q
"RTN","PSOHLNEW",17,0)
 I PSOSND,$G(OR("STAT"))'="DE" N PSONAS S PSONAS=$S($P($G(^PSRX(PSOFFL,"OR1")),"^",2)="":1,1:0) S $P(^PSRX(PSOFFL,"OR1"),"^",2)=PSOPLC,^PSRX("APL",PSOPLC,PSOFFL)="" D:PSONAS EN^PSOHDR("PRES",PSOFFL) D KL Q
"RTN","PSOHLNEW",18,0)
 D KL
"RTN","PSOHLNEW",19,0)
 I SEND,$G(OR("STAT"))="Z@" G PURGE^PSOHLNE2
"RTN","PSOHLNEW",20,0)
 I SEND,$G(OR("STAT"))="ZF" G REF^PSOHLNE2
"RTN","PSOHLNEW",21,0)
 I SEND,$G(OR("STAT"))'="CA",$G(OR("STAT"))'="DC",$G(OR("STAT"))'="HD",$G(OR("STAT"))'="RL",$G(OR("STAT"))'="SS" S RCOMM="Invalid Order Control Code" D EN^ORERR(RCOMM,.MSG) Q
"RTN","PSOHLNEW",22,0)
 I SEND K SEND G:$G(OR("STAT"))="SS" ESTAT D EN^PSOORUTL(.OR) S PLACER=OR("PLACE"),STAT=OR("STAT"),COMM=OR("COMM") S PSOMSORR=1 D  K PSOMSORR Q
"RTN","PSOHLNEW",23,0)
 .I $G(OR("FILLER"))="" D  D ERROR^PSOHLSN Q
"RTN","PSOHLNEW",24,0)
 ..F EER=0:0 S EER=$O(MSG(EER)) Q:'EER  S:$P(MSG(EER),"|")="PV1" PSERRPV1=MSG(EER) S:$P(MSG(EER),"|")="PID" PSERRPID=MSG(EER) S:$P(MSG(EER),"|")="ORC"&($G(PSERRORC)="") PSERRORC=MSG(EER)
"RTN","PSOHLNEW",25,0)
 .I $P(OR("FILLER"),"^",2)="R" S FILLER=$P(OR("FILLER"),"^") D EN^PSOHLSN1(FILLER,STAT,$G(OR("PHARMST")),COMM) K:$G(PSOEXFLG) PSOMSORR,PLACERXX D:$G(PSOEXFLG) EN^PSOHLSN1(FILLER,"SC","ZE","") D:$G(PSOSUSZ) SUS^PSOORUT1 K PSOSUSZ Q
"RTN","PSOHLNEW",26,0)
 .D EN^PSOHLSN(PLACER,STAT,COMM) Q
"RTN","PSOHLNEW",27,0)
 D KL^PSOHLSIH S RRX=1 F ZZ=0:0 S ZZ=$O(MSG(ZZ)) Q:'ZZ  S PSOSEG=$G(MSG(ZZ)),PSOTYPE=$P(PSOSEG,"|") S PSOSEG=$E(PSOSEG,5,$L(PSOSEG)) I PSOTYPE'="NTE" D @PSOTYPE
"RTN","PSOHLNEW",28,0)
 I $G(PSRNFLAG) S PSOMO=0 D MISRN^PSOHLNE1 I $G(PSOMO) Q
"RTN","PSOHLNEW",29,0)
 S PSRNQFLG=0 I $G(PSRNFLAG),$G(PREV) D  I $G(PSRNQFLG) S RCOMM="Duplicate Renewal Request. Order rejected by Pharmacy." D EN^ORERR(RCOMM,.MSG) D RERROR^PSOHLSN D KL^PSOHLSIH Q
"RTN","PSOHLNEW",30,0)
 .I $P($G(^PSRX(PREV,"OR1")),"^",4) S PSRNQFLG=1 Q
"RTN","PSOHLNEW",31,0)
 .I $O(^PS(52.41,"AQ",PREV,0)) S PSRNQFLG=1
"RTN","PSOHLNEW",32,0)
 .I $G(XOFLAG),$G(DFN)'=$S($G(PFLAG):$P($G(^PS(52.41,+$G(PREV),0)),"^",2),1:$P($G(^PSRX(+$G(PREV),0)),"^",2)) S RCOMM="Patient mismatch on previous order." D EN^ORERR(RCOMM,.MSG) S XOFLAGZ=1 D RERROR^PSOHLSN D KL^PSOHLSIH Q
"RTN","PSOHLNEW",33,0)
 I $G(PLACER) I $G(DFN)'=+$P($G(^OR(100,+PLACER,0)),"^",2) G MISX^PSOHLNE1
"RTN","PSOHLNEW",34,0)
 I $G(PLACER) D NFILE
"RTN","PSOHLNEW",35,0)
 D KL^PSOHLSIH
"RTN","PSOHLNEW",36,0)
 Q
"RTN","PSOHLNEW",37,0)
ESTAT ;
"RTN","PSOHLNEW",38,0)
 D EXP^PSOHLNE1
"RTN","PSOHLNEW",39,0)
 Q
"RTN","PSOHLNEW",40,0)
MSH Q
"RTN","PSOHLNEW",41,0)
PID S DFN=+$P(PSOSEG,"|",3)
"RTN","PSOHLNEW",42,0)
 Q
"RTN","PSOHLNEW",43,0)
PV1 S LOCATION=+$P(+$P(PSOSEG,"|",3),"^")
"RTN","PSOHLNEW",44,0)
 S:'$D(^SC(LOCATION,0)) LOCATION=""
"RTN","PSOHLNEW",45,0)
 S INPTRX=0 I $G(LOCATION) S PSINPTR=$P($G(^SC(LOCATION,0)),"^",4) I PSINPTR Q
"RTN","PSOHLNEW",46,0)
 I $G(LOCATION) S INPTRX=$P($G(^SC(LOCATION,0)),"^",15)
"RTN","PSOHLNEW",47,0)
 I '$G(INPTRX) S INPTRX=$O(^DG(40.8,0))
"RTN","PSOHLNEW",48,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLNEW",49,0)
 S PSINPTR=+$$SITE^VASITE(DT,INPTRX)
"RTN","PSOHLNEW",50,0)
 Q
"RTN","PSOHLNEW",51,0)
OBR ;This segment is used to pass flagging information from CPRS.
"RTN","PSOHLNEW",52,0)
 D OBR^PSOHLNE4
"RTN","PSOHLNEW",53,0)
 Q
"RTN","PSOHLNEW",54,0)
DG1 S $P(PSOICD($P(PSOSEG,"|",1)),"^")=$P($P(PSOSEG,"|",3),"^")
"RTN","PSOHLNEW",55,0)
 Q
"RTN","PSOHLNEW",56,0)
ORC ;
"RTN","PSOHLNEW",57,0)
 Q:$P(PSOSEG,"|")="DE"
"RTN","PSOHLNEW",58,0)
 S:$P(PSOSEG,"|")="XO" XOFLAG=1 D ^PSOHLNE1 S:$G(PRIOR)="A" PRIOR="E" S:$G(PRIOR)="" PRIOR="R"
"RTN","PSOHLNEW",59,0)
 Q
"RTN","PSOHLNEW",60,0)
 ;
"RTN","PSOHLNEW",61,0)
RXO I $O(MSG(ZZ,0)) D ^PSOHLNE2 G RXOPS
"RTN","PSOHLNEW",62,0)
 S PSORDITE=$P($P(PSOSEG,"|"),"^",4)
"RTN","PSOHLNEW",63,0)
 S PSODDRUG=$P($P(PSOSEG,"|",10),"^",4) I $G(PSODDRUG) S:'$D(^PSDRUG(PSODDRUG,0)) PSODDRUG=""
"RTN","PSOHLNEW",64,0)
 S PSOXQTY=$P(PSOSEG,"|",11)
"RTN","PSOHLNEW",65,0)
 S PSOREFIL=$P(PSOSEG,"|",13)
"RTN","PSOHLNEW",66,0)
 S PSODYSPL=$P(PSOSEG,"|",17)
"RTN","PSOHLNEW",67,0)
RXOPS S ONEFLAG=0,WPCT=1,LL=ZZ+1
"RTN","PSOHLNEW",68,0)
 I $P($G(MSG(LL)),"|")="NTE" D
"RTN","PSOHLNEW",69,0)
 .S ONEFLAG=1,WORDP=$S($P(MSG(LL),"|",2):$P(MSG(LL),"|",2),1:$P(MSG(LL),"|",3)) S:$P(MSG(LL),"|",4)'="" WPARRAY(WORDP,WPCT)=$P(MSG(LL),"|",4) S:$P(MSG(LL),"|",4)'="" WPCT=WPCT+1 F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNEW",70,0)
 ..I $G(MSG(LL,LLL))'="" S WPARRAY(WORDP,WPCT)=$G(MSG(LL,LLL)),WPCT=WPCT+1
"RTN","PSOHLNEW",71,0)
 I ONEFLAG S LL=LL+1 I $P($G(MSG(LL)),"|")="NTE" D NTE^PSOHLNE1
"RTN","PSOHLNEW",72,0)
 K WORDP
"RTN","PSOHLNEW",73,0)
 Q
"RTN","PSOHLNEW",74,0)
RXR I $P($P(PSOSEG,"|"),"^",4) S ROUTE(RRX)=$P($P(PSOSEG,"|"),"^",4) S RRX=RRX+1
"RTN","PSOHLNEW",75,0)
 Q
"RTN","PSOHLNEW",76,0)
OBX I $O(MSG(ZZ,0)) D OBXX^PSOHLNE2 G OBXNTE
"RTN","PSOHLNEW",77,0)
 S OCOUNT=OCOUNT+1
"RTN","PSOHLNEW",78,0)
 S OBXAR(OCOUNT,1)=$P(PSOSEG,"|",5)
"RTN","PSOHLNEW",79,0)
OBXNTE ;
"RTN","PSOHLNEW",80,0)
 D OBXNTE^PSOHLNE3
"RTN","PSOHLNEW",81,0)
 Q
"RTN","PSOHLNEW",82,0)
ZRN S PSODSC=1_"^"_$P(PSOSEG,"|",2)
"RTN","PSOHLNEW",83,0)
 I $O(MSG(ZZ,0)) F T=0:0 S T=$O(MSG(ZZ,T)) Q:'T  S PSODSC(T)=MSG(ZZ,T)
"RTN","PSOHLNEW",84,0)
 K T
"RTN","PSOHLNEW",85,0)
 Q
"RTN","PSOHLNEW",86,0)
 ;
"RTN","PSOHLNEW",87,0)
ZRX D ZRX^PSOHLNE1
"RTN","PSOHLNEW",88,0)
 Q
"RTN","PSOHLNEW",89,0)
 ;
"RTN","PSOHLNEW",90,0)
ZCL D ZCL^PSOHLNE1
"RTN","PSOHLNEW",91,0)
 Q
"RTN","PSOHLNEW",92,0)
ZSC D CP^PSOHLNE1
"RTN","PSOHLNEW",93,0)
 Q
"RTN","PSOHLNEW",94,0)
NFILE ;
"RTN","PSOHLNEW",95,0)
 I $G(PSODSC) D ^PSONVNEW Q  ;adds non-va med to #55
"RTN","PSOHLNEW",96,0)
 ;
"RTN","PSOHLNEW",97,0)
 K DD,DO,DIC S DLAYGO="52.41",DIC="^PS(52.41,",DIC(0)="L",X=PLACER,DIC("DR")="1////"_DFN_";2////"_PSOOC_";6////"_$G(EFFECT)_";12////"_$G(PSOXQTY)_";25////"_$G(PRIOR)
"RTN","PSOHLNEW",98,0)
 S DIC("DR")=DIC("DR")_";22////"_$G(PSORSO)_";22.1////"_$G(PREV)_";19////"_$G(ROUTING)_";17////"_$$UNESC^ORHLESC($G(SERV))_";7////"_$G(NATURE)_";13////"_$G(PSOREFIL)_";1.1////"_$G(LOCATION)_";117////"_$G(DSIG)
"RTN","PSOHLNEW",99,0)
 D FILE^DICN K DIC,DR I Y<0 Q
"RTN","PSOHLNEW",100,0)
 S PENDING=+Y
"RTN","PSOHLNEW",101,0)
 S $P(^PS(52.41,PENDING,0),"^",4)=$S($G(ENTERED):+$G(ENTERED),1:""),$P(^(0),"^",5)=$S($G(PROV):+$G(PROV),1:""),$P(^(0),"^",8)=$S($G(PSORDITE):+$G(PSORDITE),1:""),$P(^(0),"^",9)=$S($G(PSODDRUG):+$G(PSODDRUG),1:""),$P(^(0),"^",15)=$G(ROUTE)
"RTN","PSOHLNEW",102,0)
 S ^PS(52.41,PENDING,"IBQ")=$G(PSOIBY)
"RTN","PSOHLNEW",103,0)
 I $G(PSODYSPL)'="",$E(PSODYSPL)?1A S PSODYSPL=$E(PSODYSPL,2,$L(PSODYSPL))
"RTN","PSOHLNEW",104,0)
 S $P(^PS(52.41,PENDING,"INI"),"^")=$G(PSINPTR),$P(^(0),"^",12)=$G(PSOLOG),$P(^(0),"^",22)=$G(PSODYSPL)
"RTN","PSOHLNEW",105,0)
 I $G(QCOUNT) S ^PS(52.41,PENDING,1,0)="^52.413^"_QCOUNT_"^"_QCOUNT
"RTN","PSOHLNEW",106,0)
 S PSOQWX=$G(PSODDRUG) D:'$G(PSOQWX) OID^PSOHLNE1
"RTN","PSOHLNEW",107,0)
 F PP=0:0 S PP=$O(Q1I(PP)) Q:'PP  S VAL=$S($G(PSOQWX)&($G(PSOLQ1II(PP))):Q1I(PP),$G(PSOQWX)&($G(PSOLQ1IX(PP))'="")&('$G(PSOLQ1II(PP))):PSOLQ1IX(PP),1:PSOLQ1I(PP)) S ^PS(52.41,PENDING,1,PP,0)=$$UNESC^ORHLESC(VAL)
"RTN","PSOHLNEW",108,0)
 F EE=0:0 S EE=$O(QTARRAY(EE)) Q:'EE  S ^PS(52.41,PENDING,1,EE,1)=$$UNESC^ORHLESC(QTARRAY(EE)) S VAL=$S($G(PSOQWX)&($G(PSOLQ1II(EE))):$G(QTARRAY2(EE)),$G(PSOQWX)&($G(PSOLQ1IX(EE))'="")&('$G(PSOLQ1II(EE))):PSOLQ1IX(EE),1:$G(PSOLQ1I(EE))) D
"RTN","PSOHLNEW",109,0)
 .S ^PS(52.41,PENDING,1,EE,2)=$$UNESC^ORHLESC(VAL) S $P(^PS(52.41,PENDING,1,EE,1),"^",8)=+$G(ROUTE(EE))
"RTN","PSOHLNEW",110,0)
 S:$P($G(^PS(52.41,PENDING,1,1,1)),"^",3) $P(^PS(52.41,PENDING,0),"^",18)=$E($P($G(^PS(52.41,PENDING,1,1,1)),"^",3),1,7)
"RTN","PSOHLNEW",111,0)
 D STUFF^PSOHLNE2
"RTN","PSOHLNEW",112,0)
 D ^PSOHLPII
"RTN","PSOHLNEW",113,0)
 S LL=0 I $O(WPARRAY(6,0)) F LLL=0:0 S LLL=$O(WPARRAY(6,LLL)) Q:'LLL  S LL=LL+1 S ^PS(52.41,PENDING,3,LL,0)=$$UNESC^ORHLESC($G(WPARRAY(6,LLL)))
"RTN","PSOHLNEW",114,0)
 I LL S ^PS(52.41,PENDING,3,0)="^52.42^"_LL_"^"_LL
"RTN","PSOHLNEW",115,0)
 S LL=0 I $O(WPARRAY(7,0)) F LLL=0:0 S LLL=$O(WPARRAY(7,LLL)) Q:'LLL  S LL=LL+1 S ^PS(52.41,PENDING,"INS1",LL,0)=$$UNESC^ORHLESC($G(WPARRAY(7,LLL)))
"RTN","PSOHLNEW",116,0)
 I LL S ^PS(52.41,PENDING,"INS1",0)="^^"_LL_"^"_LL_"^"_$G(DT)_"^"
"RTN","PSOHLNEW",117,0)
 I $P($G(^PS(50.7,+$G(PSORDITE),"INS")),"^")'="" S $P(^PS(52.41,PENDING,"INS"),"^",2)=$S($O(^PS(52.41,PENDING,"INS1",0)):1,1:0)
"RTN","PSOHLNEW",118,0)
 I $G(OCOUNT) S ^PS(52.41,PENDING,"OBX",0)="^52.4118A^"_OCOUNT_"^"_OCOUNT F OCOUNT=1:1:OCOUNT D
"RTN","PSOHLNEW",119,0)
 .S ^PS(52.41,PENDING,"OBX",OCOUNT,0)=$$UNESC^ORHLESC($G(OBXAR(OCOUNT,1)))
"RTN","PSOHLNEW",120,0)
 .D USER^PSOORFI2(+$G(PROV)) S ^PS(52.41,PENDING,"OBX",OCOUNT,1)=$$UNESC^ORHLESC(USER1) K USER1
"RTN","PSOHLNEW",121,0)
 .S PSOBCT=1 F LLL=2:1 Q:'$D(OBXAR(OCOUNT,LLL))  S ^PS(52.41,PENDING,"OBX",OCOUNT,2,PSOBCT,0)=$$UNESC^ORHLESC(OBXAR(OCOUNT,LLL)),^PS(52.41,PENDING,"OBX",OCOUNT,2,0)="^^"_PSOBCT_"^"_PSOBCT_"^"_$G(DT)_"^"
"RTN","PSOHLNEW",122,0)
 D ^PSOHLPIS
"RTN","PSOHLNEW",123,0)
 K DIK S DIK="^PS(52.41,",DA=PENDING D IX^DIK
"RTN","PSOHLNEW",124,0)
 I $G(PSOOC)="RNW",$G(PREV),$D(^PSRX(+$G(PREV),0)) D EN^PSOHLSN1(PREV,"SC","ZZ","")
"RTN","PSOHLNEW",125,0)
 S PSOMSORR=1,IPPLACER=$P($G(^PS(52.41,PENDING,0)),"^") I IPPLACER D
"RTN","PSOHLNEW",126,0)
 .I '$G(XOFLAG) D EN^PSOHLSN(IPPLACER,"OK","IP") Q
"RTN","PSOHLNEW",127,0)
 .D EN^PSOHLSN(IPPLACER,"XR","IP") I $G(PFLAG) D DCP^PSOHLSN Q
"RTN","PSOHLNEW",128,0)
 .K PSOMSORR I $D(^PSRX(+$G(PREV),0)) D  D EN^PSOHLSN1(PREV,"RP","","","A")
"RTN","PSOHLNEW",129,0)
 ..S $P(^PSRX(PREV,"STA"),"^")=15,$P(^PSRX(PREV,3),"^",5)=DT,$P(^PSRX(PREV,3),"^",10)=$P(^PSRX(PREV,3),"^")  ;;PSO*7*249
"RTN","PSOHLNEW",130,0)
 ..D CHKCMOP^PSOUTL(PREV)
"RTN","PSOHLNEW",131,0)
 ..D REVERSE^PSOBPSU1(PREV,,"DC",7),CAN^PSOTPCAN(PREV),CAN^PSOUTL(PREV)
"RTN","PSOHLNEW",132,0)
 ..D CNT^PSOHLNE1
"RTN","PSOHLNEW",133,0)
 ..D:$G(^PS(52.41,PENDING,1,1,0))=""&($P($G(^PS(52.41,PENDING,1,1,1)),"^")="")&($G(^PS(52.41,PENDING,"SIG",1,0))="")
"RTN","PSOHLNEW",134,0)
 ...N FSIG,BSIG
"RTN","PSOHLNEW",135,0)
 ...I '$P($G(^PSRX(PREV,"SIG")),"^",2),$P($G(^("SIG")),"^")'="" D
"RTN","PSOHLNEW",136,0)
 ....D EN3^PSOUTLA1(PREV,70)
"RTN","PSOHLNEW",137,0)
 ....I $G(BSIG(1))'="" S ^PS(52.41,PENDING,"SIG",1,0)=$$UNESC^ORHLESC($G(BSIG(1))) I $O(BSIG(1)) F EE=1:0 S EE=$O(BSIG(EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",EE,0)=$$UNESC^ORHLESC($G(BSIG(EE)))
"RTN","PSOHLNEW",138,0)
 ...I $P($G(^PSRX(PREV,"SIG")),"^",2),$G(^PSRX(PREV,"SIG1",1,0))'="" D
"RTN","PSOHLNEW",139,0)
 ....D FSIG^PSOUTLA("R",PREV,70)
"RTN","PSOHLNEW",140,0)
 ....I $G(FSIG(1))'="" S ^PS(52.41,PENDING,"SIG",1,0)=$$UNESC^ORHLESC($G(FSIG(1))) I $O(FSIG(1)) F EE=1:0 S EE=$O(FSIG(EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",EE,0)=$$UNESC^ORHLESC($G(FSIG(EE)))
"RTN","PSOHLNEW",141,0)
 ...F EE=0:0 S EE=$O(^PS(52.41,PENDING,"SIG",EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_EE_"^"_EE
"RTN","PSOHLNEW",142,0)
 D CSET^PSODIAG
"RTN","PSOHLNEW",143,0)
 Q
"RTN","PSOHLNEW",144,0)
SPDFN S PDFN=$P($G(MSG(OO)),"|",4) Q
"RTN","PSOHLNEW",145,0)
KL K PSOPLC,PSOFFL,PSOSND
"RTN","PSOHLNEW",146,0)
 Q
"RTN","PSOHLNEW",147,0)
FILL ;
"RTN","PSOHLNEW",148,0)
 S (PSOFILNM,OR("PSOFILNM"))=$P($P(MSG(OO),"|",4),"^")
"RTN","PSOHLNEW",149,0)
 Q
"RTN","PSOORUTL")
0^11^B43174944^B42932698
"RTN","PSOORUTL",1,0)
PSOORUTL ;ISC BHAM/SAB  - updates order status from oerr ;2/25/09 9:47am
"RTN","PSOORUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,46,146,132,118,199,223,148,249,274,225,324**;DEC 1997;Build 6
"RTN","PSOORUTL",3,0)
 ;External reference to EN^ORERR - 2187
"RTN","PSOORUTL",4,0)
 ;External reference to ^PS(55 - 2228
"RTN","PSOORUTL",5,0)
 ;Input variables, poerr("psofilnm")=pharmacy pointer # from OE/RR, poerr("stat")=Order Control status
"RTN","PSOORUTL",6,0)
 ;poerr("pharmst")=will contain 'ZE'if rx has expired, poerr("comm")=Comments, poerr("user")=Person placing request
"RTN","PSOORUTL",7,0)
EN(POERR) ;
"RTN","PSOORUTL",8,0)
 N PSZORS,III
"RTN","PSOORUTL",9,0)
 F OO=0:0 S OO=$O(MSG(OO)) Q:'OO  I $P(MSG(OO),"|")="ZRN" S NVA=1
"RTN","PSOORUTL",10,0)
 I $G(NVA) G NVA
"RTN","PSOORUTL",11,0)
 G:POERR("PSOFILNM")'["S" RXO S III=+POERR("PSOFILNM")
"RTN","PSOORUTL",12,0)
 S ORS=0 I $D(^PS(52.41,III,0)) D  G PEXIT
"RTN","PSOORUTL",13,0)
 .Q:$P($G(^PS(52.41,III,0)),"^",3)="RF"
"RTN","PSOORUTL",14,0)
 .I $G(PDFN),$P($G(^PS(52.41,III,0)),"^",2),PDFN'=$P(^PS(52.41,III,0),"^",2) S ORS=1
"RTN","PSOORUTL",15,0)
RXO S III=POERR("PSOFILNM") I $D(^PSRX(III,0)) D  G PEXIT
"RTN","PSOORUTL",16,0)
 .I $G(PDFN),$P($G(^PSRX(III,0)),"^",2),PDFN'=$P(^PSRX(III,0),"^",2) S ORS=1
"RTN","PSOORUTL",17,0)
 S (ORS,PSZORS)=1
"RTN","PSOORUTL",18,0)
PEXIT I $G(ORS) S POERR("STAT")=$S(POERR("STAT")="CA":"UC",POERR("STAT")="DC":"UD",POERR("STAT")="HD":"UH",1:"UR"),POERR("FILLER")="",POERR("COMM")=$S($G(PSZORS):"Invalid Pharmacy order number",1:"Patient does not match.") K ORS,PSZORS,III Q
"RTN","PSOORUTL",19,0)
 S POERR("PHARMST")="" G:POERR("STAT")="HD"!(POERR("STAT")="RL") HD
"RTN","PSOORUTL",20,0)
 S ORS=0 I POERR("PSOFILNM")["S" S DA=+POERR("PSOFILNM") I $D(^PS(52.41,DA,0)) D  G EXIT
"RTN","PSOORUTL",21,0)
 .Q:$P($G(^PS(52.41,DA,0)),"^",3)="RF"
"RTN","PSOORUTL",22,0)
 .S $P(^PS(52.41,DA,0),"^",3)="DC",POERR("PLACE")=$P(^(0),"^"),POERR("STAT")="CR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUTL",23,0)
 .K ^PS(52.41,"AOR",+$P($G(^PS(52.41,DA,0)),"^",2),+$P($G(^PS(52.41,DA,"INI")),"^"),DA)
"RTN","PSOORUTL",24,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order Canceled by OE/RR before finishing." S ORS=1,$P(^PS(52.41,DA,4),"^")=$G(POERR("COMM"))
"RTN","PSOORUTL",25,0)
 S DA=POERR("PSOFILNM") D:$D(^PSRX(DA,0)) REVERSE^PSOBPSU1(DA,,"DC",7)
"RTN","PSOORUTL",26,0)
 I $D(^PSRX(DA,0)) D  S $P(^PSRX(DA,"STA"),"^")=14,$P(^PSRX(DA,3),"^",5)=DT,$P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^") D CHKCMOP^PSOUTL(DA),CAN^PSOTPCAN(DA) G EXIT
"RTN","PSOORUTL",27,0)
 .;cancel/discontinue action
"RTN","PSOORUTL",28,0)
 .S POERR("PLACE")=+$P($G(^PSRX(DA,"OR1")),"^",2),POERR("STAT")=$S(POERR("STAT")="CA":"CR",1:"DR"),POERR("FILLER")=DA_"^R"
"RTN","PSOORUTL",29,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription DISCONTINUED by OERR"
"RTN","PSOORUTL",30,0)
 .S ORS=1 D CAN
"RTN","PSOORUTL",31,0)
EXIT I '$G(ORS) D
"RTN","PSOORUTL",32,0)
 .S POERR("STAT")=$S(POERR("STAT")="CA":"UC",POERR("STAT")="DC":"UD",POERR("STAT")="HD":"UH",1:"UR"),POERR("FILLER")="",POERR("COMM")="Order was not located by Pharmacy"
"RTN","PSOORUTL",33,0)
 K EXP,ORS,DA,ACOM,RXDA,SUSD,PSUS,RXF,I,FDA,DIC,DIE,DR,Y,X,%,%I,%H,RSDT,ACNT,ACT,DIK,FDT,IR,LFD,NOW,ORD,PSDA,PSCDA,PSODFN,PSUS,RF,RFCNT,RXN,RXP,RXREF,SD,SUB
"RTN","PSOORUTL",34,0)
 Q
"RTN","PSOORUTL",35,0)
CAN S ACOM="Discontinued by OE/RR." I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORUTL",36,0)
 .S ACOM="Discontinued by OE/RR while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")=""
"RTN","PSOORUTL",37,0)
 .I $P(^PSRX(DA,0),"^",13),'$O(^PSRX(DA,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(DA,0),"^",13),1,7) D ^DIE K DIE,DR Q
"RTN","PSOORUTL",38,0)
 .S (IFN,SUSD)=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S SUSD=IFN,RFDT=$P(^PSRX(DA,1,IFN,0),"^")
"RTN","PSOORUTL",39,0)
 .Q:'$G(SUSD)  I '$P(^PSRX(DA,1,SUSD,0),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(DA,1,SUSD),^PSRX("AD",RFDT,DA,SUSD),^PSRX(DA,1,"B",RFDT,SUSD),IFN,SUSD,RFDT
"RTN","PSOORUTL",40,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(DA,"L",PDA)) Q:'PDA  I $P($G(^PSRX(DA,"L",PDA,0)),"^",2)=SUSD S PSDTEST=1
"RTN","PSOORUTL",41,0)
 ..K CMOP D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOORUTL",42,0)
 ..S PSDTEST=1
"RTN","PSOORUTL",43,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",DA,0)) D:DA
"RTN","PSOORUTL",44,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORUTL",45,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued by OE/RR while suspended."
"RTN","PSOORUTL",46,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORUTL",47,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORUTL",48,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORUTL",49,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORUTL",50,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORUTL",51,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_POERR("USER")_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORUTL",52,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORUTL",53,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORUTL",54,0)
 Q
"RTN","PSOORUTL",55,0)
HD ;place order on hold
"RTN","PSOORUTL",56,0)
 G:POERR("STAT")="RL" REL^PSOORUT1 S (ACT,ORS)=0 I POERR("PSOFILNM")["S" D  G EXIT
"RTN","PSOORUTL",57,0)
 .S DA=+POERR("PSOFILNM")
"RTN","PSOORUTL",58,0)
 .Q:'$D(^PS(52.41,DA,0))  Q:$P(^PS(52.41,DA,0),"^",3)="RF"
"RTN","PSOORUTL",59,0)
 .S $P(^PS(52.41,DA,0),"^",3)="HD",POERR("STAT")="HR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUTL",60,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order PLACED on HOLD by OERR before finished." S $P(^PS(52.41,DA,4),"^")=POERR("COMM"),ORS=1
"RTN","PSOORUTL",61,0)
 S DA=POERR("PSOFILNM") I $D(^PSRX(DA,0)) S ORS=1,PSDA=DA D  G EXIT
"RTN","PSOORUTL",62,0)
 .S POERR("FILLER")=DA_"^R"
"RTN","PSOORUTL",63,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription Placed on HOLD by OERR"
"RTN","PSOORUTL",64,0)
 .I DT>$P(^PSRX(DA,2),"^",6) S EXP=$P(^(2),"^",6) S:$P(^PSRX(DA,"STA"),"^")<12 $P(^PSRX(DA,"STA"),"^")=11,PSOEXFLG=1 S POERR("STAT")="UH",POERR("COMM")="Prescription EXPIRED on "_$E(EXP,4,5)_"/"_$E(EXP,6,7)_"/"_$E(EXP,2,3)_"." D  Q
"RTN","PSOORUTL",65,0)
 ..D ECAN^PSOUTL(DA)
"RTN","PSOORUTL",66,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")>11) S POERR("STAT")="UH",POERR("COMM")="Unable to place on HOLD" Q
"RTN","PSOORUTL",67,0)
 .S $P(^PSRX(DA,"STA"),"^")=16,POERR("STAT")="HR",^PSRX(DA,"H")=99_"^"_POERR("COMM")_"^"_DT
"RTN","PSOORUTL",68,0)
 .S (PSUS,RXF)=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:RXF>1 RSDT=$P(^(RXF-1,0),"^")
"RTN","PSOORUTL",69,0)
 .S DA=PSDA D ACT D REVERSE^PSOBPSU1(DA,,"HLD",2)
"RTN","PSOORUTL",70,0)
 .S DA=$O(^PS(52.5,"B",PSDA,0)) I DA S DIK="^PS(52.5,",PSUS=1 D ^DIK K DA,DIK
"RTN","PSOORUTL",71,0)
 I 'ORS S POERR("COMM")="Unable to place order on HOLD" G EXIT
"RTN","PSOORUTL",72,0)
 Q
"RTN","PSOORUTL",73,0)
NVA ;non-va med action
"RTN","PSOORUTL",74,0)
 N DIE,DR,DA K NVA
"RTN","PSOORUTL",75,0)
 I POERR("PSOFILNM")'["N"!('$D(^PS(55,PDFN,"NVA",+POERR("PSOFILNM"),0))) D EN^ORERR("Order was not located by Pharmacy",.MSG) Q
"RTN","PSOORUTL",76,0)
 I $G(OR("STAT"))'="CA",$G(OR("STAT"))'="DC" D EN^ORERR("Invalid Order Control Code",.MSG) Q
"RTN","PSOORUTL",77,0)
XO S ORD=+POERR("PSOFILNM")
"RTN","PSOORUTL",78,0)
 N TMP
"RTN","PSOORUTL",79,0)
 D NOW^%DTC
"RTN","PSOORUTL",80,0)
 K TMP S TMP(55.05,ORD_","_PDFN_",",5)=$S($G(PSODEATH):2,1:1)
"RTN","PSOORUTL",81,0)
 S TMP(55.05,ORD_","_PDFN_",",6)=%
"RTN","PSOORUTL",82,0)
 D FILE^DIE("","TMP")
"RTN","PSOORUTL",83,0)
 S PLACER=$P(^PS(55,PDFN,"NVA",ORD,0),"^",8)
"RTN","PSOORUTL",84,0)
 K MSG S NULLFLDS="F JJ=0:1:LIMIT S FIELD(JJ)="""""
"RTN","PSOORUTL",85,0)
 K ^UTILITY("DIQ1",$J),DIQ S DA=$P($$SITE^VASITE(),"^")
"RTN","PSOORUTL",86,0)
 I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOHINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIQ,DIC
"RTN","PSOORUTL",87,0)
 S MSG(1)="MSH|^~\&|PHARMACY|"_$G(PSOHINST)_"|||||ORR"
"RTN","PSOORUTL",88,0)
 ;
"RTN","PSOORUTL",89,0)
 S DFN=PDFN,COUNT=1,LIMIT=5 X NULLFLDS D DEM^VADPT S NAME=$G(VADM(1)) K VADM
"RTN","PSOORUTL",90,0)
 S FIELD(0)="PID",FIELD(3)=DFN,FIELD(5)=NAME
"RTN","PSOORUTL",91,0)
 D SEG^PSOHLSN1
"RTN","PSOORUTL",92,0)
 ;
"RTN","PSOORUTL",93,0)
 S LIMIT=15 X NULLFLDS
"RTN","PSOORUTL",94,0)
 S FIELD(0)="ORC",FIELD(2)=PLACER_"^OR",FIELD(3)=+POERR("PSOFILNM")_"N^PS"
"RTN","PSOORUTL",95,0)
 S FIELD(1)="SC",FIELD(5)="DC"
"RTN","PSOORUTL",96,0)
 D SEG^PSOHLSN1
"RTN","PSOORUTL",97,0)
 I $G(PSODEATH) S MSG(COUNT)=MSG(COUNT)_"|^^^^DATE OF DEATH ENTERED BY MAS.^"
"RTN","PSOORUTL",98,0)
 ;
"RTN","PSOORUTL",99,0)
 D SEND^PSOHLSN1 K FIELDS,LIMIT,PSODSC,PSONVA,OI
"RTN","PSOORUTL",100,0)
 Q
"RTN","PSOORUTL",101,0)
 ;
"RTN","PSOORUTL",102,0)
ACT ;activity log
"RTN","PSOORUTL",103,0)
 D NOW^%DTC S NOW=%
"RTN","PSOORUTL",104,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOORUTL",105,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOORUTL",106,0)
 S RXF=$S(RXF>5:RXF+1,1:RXF)
"RTN","PSOORUTL",107,0)
 S ^PSRX(DA,"A",IR,0)=NOW_"^"_$S(ACT:"U",1:"H")_"^"_POERR("USER")_"^"_RXF_"^"_"RX "_$S('ACT:"placed in a",1:"removed from")_" HOLD status "_$S(+$G(PSUS):"and removed from SUSPENSE ",1:"")_"("_$E(DT,4,5)_"-"_$E(DT,6,7)_"-"_$E(DT,2,3)_") by OERR."
"RTN","PSOORUTL",108,0)
 Q
"RTN","PSORX1")
0^2^B62615378^B59378115
"RTN","PSORX1",1,0)
PSORX1 ;BIR/SAB-medication processing driver ;8/20/08 7:39am
"RTN","PSORX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,22,23,57,62,46,74,71,90,95,115,117,146,139,135,182,195,233,268,300,170,320,326,324**;DEC 1997;Build 6
"RTN","PSORX1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSORX1",4,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSORX1",5,0)
 ;External reference ^DPT(D0,.372 supported by DBIA 1476
"RTN","PSORX1",6,0)
 ;External reference DISPPRF^DGPFAPI supported by DBIA #4563
"RTN","PSORX1",7,0)
 ;External reference ^ORRDI1 is supported by DBIA 4659
"RTN","PSORX1",8,0)
 ;External reference ^XTMP("ORRDI" is supported by DBIA 4660
"RTN","PSORX1",9,0)
 ;External reference ^PSUHL supported by DBIA 4803
"RTN","PSORX1",10,0)
 ;
"RTN","PSORX1",11,0)
 ;PSO*195 add call to display Patient Record Flag (DISPPRF^DGPFAPI)
"RTN","PSORX1",12,0)
 ;
"RTN","PSORX1",13,0)
START K PSOQFLG,PSOID,PSOFIN,PSOQUIT,PSODRUG S (PSOBCK,PSOERR)=1 D INIT G:PSORX("QFLG") END
"RTN","PSORX1",14,0)
 D PT G:$G(PSORX("QFLG")) END D FULL^VALM1 I $G(NOPROC) K NOPROC G NX
"RTN","PSORX1",15,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORX1",16,0)
 F SLPPL=0:0 S SLPPL=$O(RXRS(SLPPL)) Q:'SLPPL  D
"RTN","PSORX1",17,0)
 .I $P($G(^PSRX(SLPPL,"STA")),"^")'=5 K RXRS(SLPPL) Q
"RTN","PSORX1",18,0)
 .S RXREC=SLPPL D WIND^PSOSUPOE I $G(PBINGRTE) D BBADD^PSOSUPOE S (BINGCRT,BINGRTE)=1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL"
"RTN","PSORX1",19,0)
 K TM,TM1 I $G(PSORX("PSOL",1))]""!($D(RXRS)) D ^PSORXL K PSORX
"RTN","PSORX1",20,0)
 G:$G(NOBG) NX
"RTN","PSORX1",21,0)
 S TM=$P(^TMP("PSOBB",$J),"^"),TM1=$P(^TMP("PSOBB",$J),"^",2) K ^TMP("PSOBB",$J)
"RTN","PSORX1",22,0)
 I $G(PSOFROM)="NEW"!($G(PSOFROM)="REFILL")!($G(PSOFROM)="PARTIAL") D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,BBRX,BBFLG
"RTN","PSORX1",23,0)
NX I $G(POERR("DEAD"))!$G(PSOQFLG) D EOJ G START
"RTN","PSORX1",24,0)
 D EOJ G START
"RTN","PSORX1",25,0)
END Q
"RTN","PSORX1",26,0)
 ;---------------------------------------------------------
"RTN","PSORX1",27,0)
INIT ;
"RTN","PSORX1",28,0)
 S PSORX("QFLG")=0
"RTN","PSORX1",29,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) S PSORX("QFLG")=1
"RTN","PSORX1",30,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSORX1",31,0)
INITX Q
"RTN","PSORX1",32,0)
 ;
"RTN","PSORX1",33,0)
PT ;
"RTN","PSORX1",34,0)
 K ^TMP("PSORXDC",$J),CLOZPAT,DIC,PSODFN,PSOPTLK S PSORX("QFLG")=0,DIC(0)="QEAM" D EN^PSOPATLK S Y=PSOPTLK
"RTN","PSORX1",35,0)
 I +Y'>0 S PSORX("QFLG")=1 G PTX
"RTN","PSORX1",36,0)
OERR N:$G(MEDP) PAT,POERR K PSOXFLG S (DFN,PSODFN)=+Y,PSORX("NAME")=$P(Y,"^",2)
"RTN","PSORX1",37,0)
 K NPPROC,PSOQFLG,DIC,DR,DIQ S DIC=2,DA=PSODFN,DR=.351,DIQ="PSOPTPST" D EN^DIQ1 K DIC,DA,DR,DIQ D DEAD^PSOPTPST I $G(PSOQFLG) S NOPROC=1 Q
"RTN","PSORX1",38,0)
 ;PSO*195 move SSN write to here and add DISPPRF call
"RTN","PSORX1",39,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")
"RTN","PSORX1",40,0)
 W " ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")" K SSN
"RTN","PSORX1",41,0)
 I $G(XQY0)["PSO LMOE FINISH",'$G(MEDP),$D(^TMP($J,"PSOFLPO",PSODFN)) D
"RTN","PSORX1",42,0)
 .I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSORX1",43,0)
 .W "  ",IORVON_IOINHI,"<This patient has flagged orders>",IOINORM_IORVOFF
"RTN","PSORX1",44,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D  I PSONOAL'="" D PAUSE
"RTN","PSORX1",45,0)
 .I PSONOAL'="" W !,$C(7),"     No Allergy Assessment!"
"RTN","PSORX1",46,0)
 D REMOTE
"RTN","PSORX1",47,0)
 N PSOUPDT
"RTN","PSORX1",48,0)
 S PSOUPDT=1
"RTN","PSORX1",49,0)
 I $G(XQY0)["PSO LMOE FINISH" S PSOUPDT=0
"RTN","PSORX1",50,0)
 D CHKADDR^PSOBAI(PSODFN,1,PSOUPDT)
"RTN","PSORX1",51,0)
 D:(XQY0["PSO LMOE FINISH")&('$G(SNGLPAT)) DISPPRF^DGPFAPI(PSODFN)
"RTN","PSORX1",52,0)
 ;
"RTN","PSORX1",53,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") W !?10,"Patient has another language preference!",! H 3
"RTN","PSORX1",54,0)
 I $G(^PS(55,"ASTALK",PSODFN)) W !,"Patient is enrolled to receive ScripTalk 'talking' prescription labels.",! H 2 D MAIL
"RTN","PSORX1",55,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORX1",56,0)
 ;Call to display remote/local prescriptions
"RTN","PSORX1",57,0)
 I '$G(PSOFIN) D RDICHK^PSORMRX(PSODFN)
"RTN","PSORX1",58,0)
 S PSOQFLG=0,DIC="^PS(55,",DLAYGO=55
"RTN","PSORX1",59,0)
 I '$D(^PS(55,PSODFN,0)) D
"RTN","PSORX1",60,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=PSODFN D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO
"RTN","PSORX1",61,0)
 ..S $P(^PS(55,PSODFN,0),"^")=PSODFN K DIK S DA=PSODFN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK
"RTN","PSORX1",62,0)
 D RXSTA
"RTN","PSORX1",63,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORX1",64,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSORX1",65,0)
 .L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1 Q
"RTN","PSORX1",66,0)
 .S PSOXFLG=1,SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")",! K SSN
"RTN","PSORX1",67,0)
 .S DIE=55,DR=".02;.03;.04;.05;1;D ELIG^PSORX1;3;50;106;106.1",DA=PSODFN W !!,?5,">>PHARMACY PATIENT DATA<<",! D ^DIE L -^PS(55,PSODFN)
"RTN","PSORX1",68,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORX1",69,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSORX1",70,0)
 .W !!,"Patient Status Required!!",! D ELIG
"RTN","PSORX1",71,0)
 .W ! K POERR("QFLG"),DIC,DR,DIE S DIC("A")="RX PATIENT STATUS: ",DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSORX1",72,0)
 .I $D(DIRUT)!(Y=-1) D  Q
"RTN","PSORX1",73,0)
 ..W $C(7),"Required Data!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1
"RTN","PSORX1",74,0)
 ..I $O(^PS(55,PSODFN,0))="" S DA=PSODFN,DIK="^PS(55," D ^DIK
"RTN","PSORX1",75,0)
 .S ^PS(55,PSODFN,"PS")=+Y,PSORX("PATIENT STATUS")=$P(^PS(53,+Y,0),"^")
"RTN","PSORX1",76,0)
 .K DIRUT,DTOUT,DUOUT,X,Y,DA
"RTN","PSORX1",77,0)
 Q:$G(PSOFIN)
"RTN","PSORX1",78,0)
 D ^PSOBUILD
"RTN","PSORX1",79,0)
 F PT="GET","DEAD","INP","CNH","TPB","ADDRESS","COPAY" S RTN=PT_"^PSOPTPST" D @RTN Q:$G(POERR("DEAD"))!($G(PSOQFLG))
"RTN","PSORX1",80,0)
 I $G(POERR("DEAD")) S POERR("QFLG")=1 F II=0:0 S II=$O(^PS(52.41,"P",PSODFN,II)) D:$P($G(^PS(52.41,II,0)),"^",3)'="DC"&($P($G(^(0)),"^",3)'="DE") DC^PSOORFI2
"RTN","PSORX1",81,0)
 K PSOERR("DEAD"),II I $G(PSOQFLG) S POERR("QFLG")=1 G EOJ Q
"RTN","PSORX1",82,0)
 S (PAT,PSOXXDFN)=PSODFN,POERR=1 D ^PSOORUT2,BLD^PSOORUT1,EN^PSOLMUTL
"RTN","PSORX1",83,0)
 D CLEAR^VALM1 G:$G(PSOQUIT) PTX D EN^PSOLMAO
"RTN","PSORX1",84,0)
 S (DFN,PSODFN)=PSOXXDFN K DIE,DIC,DLAYGO,DR,DA,PSOX,PSORXED
"RTN","PSORX1",85,0)
 I $O(RXFL("")),$P(^PS(55,PSODFN,0),"^",7)="" D
"RTN","PSORX1",86,0)
 . N %
"RTN","PSORX1",87,0)
 . D NOW^%DTC
"RTN","PSORX1",88,0)
 . S $P(^PS(55,PSODFN,0),"^",7)=$E(%,1,12),$P(^(0),"^",8)="A" D LOGDFN^PSUHL(PSODFN)
"RTN","PSORX1",89,0)
PTX ;
"RTN","PSORX1",90,0)
 K X,Y,^TMP("PS",$J),C,DEA,PRC,PSCNT,PSOACT,PSOCLC,PSOCS,PSOCT,PSOFINFL,PSOHD,PSOLST,PSOOPT,PSOPF,PSOX,PSOX1,PSOXXDFN,SIGOK,STP,STR,PSOPATLK
"RTN","PSORX1",91,0)
 Q
"RTN","PSORX1",92,0)
EOJ ;
"RTN","PSORX1",93,0)
 I $G(PSODFN) K ^TMP($J,"PSOINTERVENE",PSODFN)
"RTN","PSORX1",94,0)
 K PSOERR,PSOMED,PSORX,PSOSD,PSODRUG,PSODFN,PSOOPT,PSOBILL,PSOIBQS,PSOCPAY,PSOPF,PSOPI,COMM,DGI,DGS,PT,PTDY,PTRF,RN,RTN,SERS,ST0,STAT,DFN,STOP,SLPPL,RXREC
"RTN","PSORX1",95,0)
 K:'$G(MEDP) PSOQFLG
"RTN","PSORX1",96,0)
 D KVA^VADPT,FULL^VALM1 K PSOLST,PSOXFLG,PSCNT,PSDIS,PSOAL,P1,LOG,%,%DT,%I,D0,DAT,DFN,DRG,ORX,PSON,PSOPTPST,PSORX,PTST,PSOBCK,PSOID,PSOBXPUL
"RTN","PSORX1",97,0)
 K INCOM,SIG,SG,STP,RX0,RXN,RX2,RX3,RTS,C,DEAD,PS,PSOCLC,PSOCNT,PSOCT,PSODA,PSOFROM,PSOHD,R3,REA,RF,RFD,RFM,RLD,RXNUM,RXP,RXPR,RXRP,RXRS,STR,POERR,VALMSG
"RTN","PSORX1",98,0)
 K ^TMP("PSORXDC",$J),^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J) I '$G(MEDP),'$G(PSOQUIT) K PAT
"RTN","PSORX1",99,0)
 K PSORX,RFN,PSOXXDFN,VALM,VALMKEY,PSOBCK,SPOERR,PSOFLAG,VALMBCK,D,GMRA,GMRAL,GMRAREC,PSOSTA,PSODT,RXFL,NOBG,BBRX,BBFLG,^TMP($J,"PSOFLPO")
"RTN","PSORX1",100,0)
 Q
"RTN","PSORX1",101,0)
ELIG ; shows eligibility and disabilities
"RTN","PSORX1",102,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"") S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSORX1",103,0)
 W !,"Disabilities: " F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSORX1",104,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSORX1",105,0)
 .W:$L(PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 !,?15
"RTN","PSORX1",106,0)
 .W $S($G(PSDIS)]"":PSDIS_"-",1:"")_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSORX1",107,0)
 K N
"RTN","PSORX1",108,0)
 Q
"RTN","PSORX1",109,0)
PROFILE ;
"RTN","PSORX1",110,0)
 S (PSORX("REFILL"),PSORX("RENEW"))=0,PSOX="" D ^PSOBUILD
"RTN","PSORX1",111,0)
 I '$G(PSOSD) W !,"This patient has no prescriptions" S:'$D(DFN) DFN=PSODFN D GMRA^PSODEM G PROFILEX
"RTN","PSORX1",112,0)
 S (PSODRG,PSOX)="" F  S PSODRG=$O(PSOSD(PSODRG)) Q:PSODRG=""  F  S PSOX=$O(PSOSD(PSODRG,PSOX)) Q:PSOX=""  S:$P(PSOSD(PSODRG,PSOX),"^",3)="" PSORX("RENEW")=1 S:$P(PSOSD(PSODRG,PSOX),"^",4)="" PSORX("REFILL")=1
"RTN","PSORX1",113,0)
 K PSOX
"RTN","PSORX1",114,0)
PROFILEX Q
"RTN","PSORX1",115,0)
 ;
"RTN","PSORX1",116,0)
MAIL ; MAKE SURE MAIL STATUS IS COMPATIBLE WITH SCRIPTALK PATIENT
"RTN","PSORX1",117,0)
 I $P($G(^PS(59,PSOSITE,"STALK")),"^")="" Q  ; NO SCRIPTALK PRINTER SET UP FOR THIS DIVISION
"RTN","PSORX1",118,0)
 N MAIL
"RTN","PSORX1",119,0)
 S MAIL=$G(^PS(55,PSODFN,0)) I $P(MAIL,"^",3)>1 Q
"RTN","PSORX1",120,0)
MAILP W !!,"REMINDER: CMOP does not fill ScripTalk prescriptions. Please select mail."
"RTN","PSORX1",121,0)
 W !,"status:  2 (DO NOT MAIL), 3 (LOCAL REGULAR MAIL) or 4 (LOCAL CERTFIED MAIL)."
"RTN","PSORX1",122,0)
 R !,"MAIL: ",MAIL:120
"RTN","PSORX1",123,0)
 I MAIL?1"^".E Q
"RTN","PSORX1",124,0)
 I MAIL<2!(MAIL>4) W !,"INVALID MAIL SETTING - ENTER 2,3, OR 4" G MAILP
"RTN","PSORX1",125,0)
 W "  ",$S(MAIL=2:"DO NOT MAIL",MAIL=3:"LOCAL REGULAR MAIL",1:"LOCAL CERTIFIED MAIL")
"RTN","PSORX1",126,0)
 S $P(^PS(55,PSODFN,0),"^",3)=MAIL
"RTN","PSORX1",127,0)
 Q
"RTN","PSORX1",128,0)
REMOTE ; 
"RTN","PSORX1",129,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSORX1",130,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSORX1",131,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) W !,"Remote data not available - Only local order checks processed." D  Q
"RTN","PSORX1",132,0)
 .K DIR W ! S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR W ! K DIR
"RTN","PSORX1",133,0)
 Q
"RTN","PSORX1",134,0)
PAUSE ;
"RTN","PSORX1",135,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSORX1",136,0)
 Q
"RTN","PSORX1",137,0)
 ;
"RTN","PSORX1",138,0)
RXSTA ; DISPLAY ELIGIBILITY & PROMPT FOR RX PATIENT STATUS
"RTN","PSORX1",139,0)
 N DA,PSOSTA
"RTN","PSORX1",140,0)
 I '$G(PSODFN) Q
"RTN","PSORX1",141,0)
 S DA=PSODFN,PSOSTA=$G(^PS(55,PSODFN,"PS"))
"RTN","PSORX1",142,0)
 I XQY0["PSO LMOE FINISH"!(XQY0["PSO LM BACKDOOR ORDERS") I PSOSTA]"" D
"RTN","PSORX1",143,0)
 .D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"")
"RTN","PSORX1",144,0)
 .S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSORX1",145,0)
 .S DIC("A")="RX PATIENT STATUS: ",DIC("B")=PSOSTA,DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSORX1",146,0)
 .I +Y>0,+Y'=PSOSTA S DIE="^PS(55,",DR="3////"_+Y D ^DIE
"RTN","PSORX1",147,0)
 Q
"RTN","PSORXI")
0^3^B11542094^B6810533
"RTN","PSORXI",1,0)
PSORXI ;IHS/DSD/JCM - logs pharmacy interventions ;03/19/93 11:56
"RTN","PSORXI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**268,324**;DEC 1997;Build 6
"RTN","PSORXI",3,0)
 ; This routine is used to create entries in the APSP INTERVENTION file.
"RTN","PSORXI",4,0)
START ;   
"RTN","PSORXI",5,0)
 D INIT,DIC G:PSORXI("QFLG") END
"RTN","PSORXI",6,0)
 D EDIT
"RTN","PSORXI",7,0)
 S:'$D(PSONEW("PROVIDER")) PSONEW("PROVIDER")=$P(^APSPQA(32.4,PSORXI("DA"),0),"^",3)
"RTN","PSORXI",8,0)
END D EOJ
"RTN","PSORXI",9,0)
 Q
"RTN","PSORXI",10,0)
INIT ;
"RTN","PSORXI",11,0)
 W !!,"Now creating Pharmacy Intervention",!
"RTN","PSORXI",12,0)
 I $G(PSODRUG("IEN")) W "for  "_$P($G(^PSDRUG(PSODRUG("IEN"),0)),"^"),!
"RTN","PSORXI",13,0)
 K PSORXI S PSORXI("QFLG")=0
"RTN","PSORXI",14,0)
 Q
"RTN","PSORXI",15,0)
DIC ;
"RTN","PSORXI",16,0)
 K DIC,DR,DA,X,Y,DD,DO S DIC="^APSPQA(32.4,",DLAYGO=9009032.4,DIC(0)="L",X=DT
"RTN","PSORXI",17,0)
 S DIC("DR")=".02////"_+PSODFN_";.04////"_DUZ_";.05////"_PSODRUG("IEN")_";.06///PHARMACY"
"RTN","PSORXI",18,0)
 S DIC("DR")=DIC("DR")_";.07"_$S($G(PSORX("INTERVENE"))=1:"////18",$G(PSORX("INTERVENE"))=2:"////19",1:"////6")_";.14////0"_";.16////"_$S($G(PSOSITE)]"":PSOSITE,1:"")
"RTN","PSORXI",19,0)
 D FILE^DICN K DIC,DR,DA
"RTN","PSORXI",20,0)
 I Y>0 S PSORXI("DA")=+Y,^TMP($J,"PSOINTERVENE",PSODFN)=+Y
"RTN","PSORXI",21,0)
 E  S PSORXI("QFLG")=1 G DICX
"RTN","PSORXI",22,0)
 D DIE
"RTN","PSORXI",23,0)
DICX K X,Y
"RTN","PSORXI",24,0)
 Q
"RTN","PSORXI",25,0)
DIE ;
"RTN","PSORXI",26,0)
 K DIE,DIC,DR,DA
"RTN","PSORXI",27,0)
 S DIE="^APSPQA(32.4,",DA=PSORXI("DA"),DR=$S($G(PSORXI("EDIT"))]"":".03:1600",1:".03;.08")
"RTN","PSORXI",28,0)
 L +^APSPQA(32.4,PSORXI("DA")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) D ^DIE K DIE,DIC,DR,X,Y,DA L -^APSPQA(32.4,PSORXI("DA"))
"RTN","PSORXI",29,0)
 W $C(7),!!,"See 'Pharmacy Intervention Menu' if you want to delete this",!,"intervention or for more options.",!
"RTN","PSORXI",30,0)
 Q
"RTN","PSORXI",31,0)
EDIT ;
"RTN","PSORXI",32,0)
 K DIR W ! S DIR(0)="Y",DIR("A")="Would you like to edit this intervention ",DIR("B")="N" D ^DIR K DIR I $D(DIRUT)!'Y G EDITX
"RTN","PSORXI",33,0)
 S PSORXI("EDIT")=1 D DIE G EDIT
"RTN","PSORXI",34,0)
EDITX W ! K X,Y
"RTN","PSORXI",35,0)
 Q
"RTN","PSORXI",36,0)
DUPINV ;Duplicate and file intervention
"RTN","PSORXI",37,0)
 N PSOARY,PSOARYC,PSOMSG,PSODA,DUP,DIC,DA,DLAYGO,Y,X
"RTN","PSORXI",38,0)
 S DUP=^TMP($J,"PSOINTERVENE",+PSODFN),DIC="^APSPQA(32.4,",DIC(0)="AEQM"
"RTN","PSORXI",39,0)
 D GETS^DIQ(9009032.4,DUP,"**","I","PSOARY","PSOMSG")
"RTN","PSORXI",40,0)
 I $D(PSOMSG) W !,"Error Retrieving Last Duplicate..." G START
"RTN","PSORXI",41,0)
 L +^APSPQA(32.4):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSORXI",42,0)
 K DIC,DR,DA,X,Y,DD,DO
"RTN","PSORXI",43,0)
 S DIC="^APSPQA(32.4,",DLAYGO=9009032.4,DIC(0)="",X=DT
"RTN","PSORXI",44,0)
 D FILE^DICN
"RTN","PSORXI",45,0)
 L -^APSPQA(32.4)
"RTN","PSORXI",46,0)
 I Y<1 W !,"Error Encountered Filing Duplicate..." Q
"RTN","PSORXI",47,0)
 S DA=+Y,PSORXI("DA")=+Y,X=0,^TMP($J,"PSOINTERVENE",PSODFN)=+Y
"RTN","PSORXI",48,0)
 F  S X=$O(PSOARY(9009032.4,DUP_",",X)) Q:'X  D
"RTN","PSORXI",49,0)
 .S PSOARYC(9009032.4,DA_",",X)=PSOARY(9009032.4,DUP_",",X,"I")
"RTN","PSORXI",50,0)
 S PSOARYC(9009032.4,DA_",",.05)=PSODRUG("IEN")
"RTN","PSORXI",51,0)
 S PSOARYC(9009032.4,DA_",",.15)=""
"RTN","PSORXI",52,0)
 D FILE^DIE("K","PSOARYC","PSOMSG") I $D(PSOMSG) D  G START
"RTN","PSORXI",53,0)
 .W !,"Error Encountered Filing Duplicate..."
"RTN","PSORXI",54,0)
 .N DIK S DA=PSORXI("DA"),DIK="^APSPQA(32.4," D ^DIK
"RTN","PSORXI",55,0)
 W ! D EN^DIQ,EDIT
"RTN","PSORXI",56,0)
 Q
"RTN","PSORXI",57,0)
EOJ ;
"RTN","PSORXI",58,0)
 K PSORXI
"RTN","PSORXI",59,0)
 Q
"RTN","PSORXI",60,0)
EN1(PSOX) ; Entry Point if have internal rx #
"RTN","PSORXI",61,0)
 N PSODFN,PSONEW,PSODRUG,PSOY
"RTN","PSORXI",62,0)
 I $G(^PSRX(+$G(PSOX),0))']"" W !,$C(7),"No prescription data" G EN1X
"RTN","PSORXI",63,0)
 S PSORXI("IRXN")=PSOX K PSOY S PSOY=^PSRX(PSORXI("IRXN"),0)
"RTN","PSORXI",64,0)
 S PSODFN=$P(PSOY,"^",2),PSONEW("PROVIDER")=$P(PSOY,"^",4),PSODRUG("IEN")=$P(PSOY,"^",6)
"RTN","PSORXI",65,0)
 D START
"RTN","PSORXI",66,0)
EN1X Q
"RTN","PSOUTL")
0^9^B96529999^B70558171
"RTN","PSOUTL",1,0)
PSOUTL ;BHAM ISC/SAB - pso utility routine ;4/28/09 4:14pm
"RTN","PSOUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,21,126,174,218,259,324**;DEC 1997;Build 6
"RTN","PSOUTL",3,0)
 ;External reference SERV^IBARX1 supported by DBIA 2245
"RTN","PSOUTL",4,0)
 ;External reference ^PS(55,     supported by DBIA 2228
"RTN","PSOUTL",5,0)
 ;
"RTN","PSOUTL",6,0)
 ;*218 prevent refill from being deleted if pending processing via
"RTN","PSOUTL",7,0)
 ; external dispense machines
"RTN","PSOUTL",8,0)
 ;*259 reverse *218 restrictions & Add del only last refill logic.
"RTN","PSOUTL",9,0)
 ;
"RTN","PSOUTL",10,0)
SUSPCAN ;dcl rx from suspense used in new, renew AND verification of Rxs
"RTN","PSOUTL",11,0)
 S PSLAST=0 F PSI=0:0 S PSI=$O(^PSRX(PSRX,1,PSI)) Q:'PSI  S PSLAST=PSI
"RTN","PSOUTL",12,0)
 I PSLAST S PSI=^PSRX(PSRX,1,PSLAST,0) K ^PSRX(PSRX,1,PSLAST),^PSRX(PSRX,1,"B",+PSI,PSLAST) S ^(0)=$P(^PSRX(PSRX,1,0),"^",1,3)_"^"_($P(^(0),"^",4)-1) K PSLAST,PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",13,0)
 S $P(^PSRX(PSRX,3),"^",7)="DISCONTINUED FROM SUSPENSE BEFORE FILLING" K PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",14,0)
 ;
"RTN","PSOUTL",15,0)
ACTLOG ;
"RTN","PSOUTL",16,0)
 F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) I 'PSI!'$O(^(PSI)) S ^PSRX(PSRX,"A",+PSI+1,0)=DT_"^"_PSREA_"^"_PSOCLC_"^"_PSRXREF_"^"_PSMSG,^PSRX(PSRX,"A",0)="^52.3DA^"_(+PSI+1)_"^"_(+PSI+1) Q
"RTN","PSOUTL",17,0)
ACTOUT I PSREA="C" S PSI=$S($D(^PSRX(PSRX,2)):+$P(^(2),"^",6),1:0) K:$D(^PS(55,PSDFN,"P","A",PSI,PSRX)) ^(PSRX) S ^PS(55,PSDFN,"P","A",DT,PSRX)="" Q
"RTN","PSOUTL",18,0)
 I PSREA="R" F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) Q:'PSI  I $D(^(PSI,0)),$P(^(0),"^",2)="C" S PSS=+^(0)
"RTN","PSOUTL",19,0)
 I $D(PSS),PSS K:$D(^PS(55,PSDFN,"P","A",PSS,PSRX)) ^(PSRX)
"RTN","PSOUTL",20,0)
 I PSREA="R",$D(^PSRX(PSRX,2))#2 S ^PS(55,PSDFN,"P","A",+$P(^PSRX(PSRX,2),"^",6),PSRX)=""
"RTN","PSOUTL",21,0)
 Q
"RTN","PSOUTL",22,0)
 ;
"RTN","PSOUTL",23,0)
QUES ;INSTRUCTIONS FOR RENEW AND REFILL
"RTN","PSOUTL",24,0)
 W !?5,"Enter the item #(s) or RX #(s) you wish to ",$S(PSFROM="N":"renew ",PSFROM="R":"REFILL "),"separated by commas."
"RTN","PSOUTL",25,0)
 W !?5,"For example: 1,2,5 or 123456,33254A,232323B."
"RTN","PSOUTL",26,0)
 W !?5,"Do not enter the same number twice, duplicates are not allowed."
"RTN","PSOUTL",27,0)
 Q
"RTN","PSOUTL",28,0)
ENDVCHK S PSOPOP=0 Q:'PSODIV  Q:'$P(^PSRX(PSRX,2),"^",9)!($P(^(2),"^",9)=PSOSITE)
"RTN","PSOUTL",29,0)
CHK1 I '$P(PSOSYS,"^",2) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is not a valid choice. (Different Division)" S PSPOP=1 Q
"RTN","PSOUTL",30,0)
 I $P(PSOSYS,"^",3) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is from another division. Continue? (Y/N) " R ANS:DTIME I ANS="^"!(ANS="") S PSPOP=1 Q
"RTN","PSOUTL",31,0)
 I (ANS']"")!("YNyn"'[$E(ANS)) W !?10,$C(7),"Answer 'YES' or 'NO'." G CHK1
"RTN","PSOUTL",32,0)
 S:$E(ANS)["Nn" PSPOP=1 Q
"RTN","PSOUTL",33,0)
 ;PSO*7*259; SET VAR PSOSFN TO CHECK FOR SUSPENDED REFILL
"RTN","PSOUTL",34,0)
K52 K PSOSFN S SFN=+$O(^PS(52.5,"B",DA(1),0)),PSOSFN=SFN Q:SFN=0
"RTN","PSOUTL",35,0)
 I $P($G(^PS(52.5,SFN,0)),"^",5)=$P($G(^PSRX(+^PS(52.5,SFN,0),"P",0)),"^",3),$P($G(^PSRX($P(^PS(52.5,SFN,0),"^"),"P",0)),"^",4)=0 N PSOXX S PSOXX=1 G KILL
"RTN","PSOUTL",36,0)
 G:X'=""&($G(Y)=1) KILL I $G(Y)'=1,SFN I $D(^PS(52.5,SFN,0)),'$P(^(0),"^",5),'$P($G(^("P")),"^") D
"RTN","PSOUTL",37,0)
 .S SDT=+$P(^PS(52.5,SFN,0),"^",2) K ^PS(52.5,"C",SDT,SFN)
"RTN","PSOUTL",38,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" K ^PS(52.5,"AQ",SDT,+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",39,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" K ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),SDT,SFN)
"RTN","PSOUTL",40,0)
 .K SFN,SDT
"RTN","PSOUTL",41,0)
 Q
"RTN","PSOUTL",42,0)
S52 S (RIFN,PSOSX)=0 F  S RIFN=$O(^PSRX(DA(1),1,RIFN)) Q:'RIFN  S RFID=$P(^PSRX(DA(1),1,RIFN,0),"^"),PSOSX=PSOSX+1
"RTN","PSOUTL",43,0)
 S SFN=+$O(^PS(52.5,"B",DA(1),0)) I SFN,'$G(^PS(52.5,SFN,"P")),$P($G(^PSRX($P($G(^PS(52.5,SFN,0)),"^"),"STA")),"^")=5 D
"RTN","PSOUTL",44,0)
 .I '$D(^PS(52.5,SFN,0))!($P($G(^(0)),"^",5)) Q
"RTN","PSOUTL",45,0)
 .S $P(^PS(52.5,SFN,0),"^",2)=RFID,^PS(52.5,"C",RFID,SFN)=""
"RTN","PSOUTL",46,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" S ^PS(52.5,"AQ",RFID,+$P(^PS(52.5,SFN,0),"^",3),SFN)="" D SCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",47,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" S ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),RFID,SFN)=""
"RTN","PSOUTL",48,0)
 K SFN,RFIN,RFID,PSOSX,PSOSXDT Q
"RTN","PSOUTL",49,0)
KILL N DFN
"RTN","PSOUTL",50,0)
 I SFN D
"RTN","PSOUTL",51,0)
 .S $P(^PSRX(DA(1),"STA"),"^")=0 Q:'$D(^PS(52.5,SFN,0))  S DFN=+$P(^PS(52.5,SFN,0),"^",3),PAT=$P(^DPT(DFN,0),"^")
"RTN","PSOUTL",52,0)
 .;I $P(^PS(52.5,SFN,0),"^",5) Q
"RTN","PSOUTL",53,0)
 .K ^PS(52.5,"B",+$P(^PS(52.5,SFN,0),"^"),SFN),^PS(52.5,"C",+$P(^PS(52.5,SFN,0),"^",2),SFN),^PS(52.5,"D",PAT,SFN),^PS(52.5,"AF",DFN,SFN)
"RTN","PSOUTL",54,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" D
"RTN","PSOUTL",55,0)
 ..I $G(^PS(52.5,SFN,"P")) K ^PS(52.5,"AS",+$P(^(0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN) Q
"RTN","PSOUTL",56,0)
 ..K ^PS(52.5,"AC",DFN,+$P(^PS(52.5,SFN,0),"^",2),SFN)
"RTN","PSOUTL",57,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)'="" D
"RTN","PSOUTL",58,0)
 ..;Kill CMOP xrefs
"RTN","PSOUTL",59,0)
 ..N PSOC7 S PSOC7=$P($G(^PS(52.5,SFN,0)),"^",7)
"RTN","PSOUTL",60,0)
 ..I PSOC7="Q"!(PSOC7="P") K ^PS(52.5,"AG",+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",61,0)
 ..I PSOC7="X"!(PSOC7="P")!(PSOC7="L") K ^PS(52.5,$S(PSOC7="X":"AX",PSOC7="P":"AP",1:"AL"),$P(^PS(52.5,SFN,0),"^",2),$P(^(0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",62,0)
 ..K ^PS(52.5,"APR",+$P(^PS(52.5,SFN,0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN)
"RTN","PSOUTL",63,0)
 .K ^PS(52.5,SFN,0),^PS(52.5,SFN,"P"),DFN,SFN,PAT
"RTN","PSOUTL",64,0)
 S CNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA(1),"A",SUB)) Q:'SUB  S CNT=SUB
"RTN","PSOUTL",65,0)
 S:DA>5 DA=DA+1 D NOW^%DTC S CNT=CNT+1
"RTN","PSOUTL",66,0)
 S ^PSRX(DA(1),"A",0)="^52.3DA^"_CNT_"^"_CNT,^PSRX(DA(1),"A",CNT,0)=%_"^D^"_DUZ_"^"_DA_"^"
"RTN","PSOUTL",67,0)
 I '$D(PSOXX) S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_"Refill "
"RTN","PSOUTL",68,0)
 ;if PSOXX not exist, = refill. otherwise, it is a partial.
"RTN","PSOUTL",69,0)
 S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_$S($G(RESK):"returned to stock.",$G(PSOPSDAL):"deleted during Controlled Subs release.",$G(PSOXX)=1:"Partial deleted from suspense file.",1:"deleted during Rx edit.") K CNT,SUB
"RTN","PSOUTL",70,0)
 Q
"RTN","PSOUTL",71,0)
CID ;calculates six months limit on issue dates
"RTN","PSOUTL",72,0)
 S PSID=X,X="T-6M",%DT="X" D ^%DT S %DT(0)=Y,X=PSID,%DT="EX" D ^%DT K PSID
"RTN","PSOUTL",73,0)
 Q
"RTN","PSOUTL",74,0)
CIDH S X="T-6M",%DT="X" D ^%DT X ^DD("DD") D EN^DDIOL("Issue Date must be greater or equal to "_Y,"","!")
"RTN","PSOUTL",75,0)
 Q
"RTN","PSOUTL",76,0)
SPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",77,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",78,0)
SREF I $G(NODE) S NODE=NODE-1 G:'$D(^PSRX(DA(1),1,NODE,0)) SREF
"RTN","PSOUTL",79,0)
 I NODE=0 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",80,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) Q
"RTN","PSOUTL",81,0)
 K NODE,RF
"RTN","PSOUTL",82,0)
 Q
"RTN","PSOUTL",83,0)
KPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",84,0)
 I NODE=DA&(X'="") S NODE=NODE-1 S:NODE=1 NODE=0 G:'NODE ORIG G:NODE>1 KREF
"RTN","PSOUTL",85,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",86,0)
KREF S NODE=NODE-1 G:'NODE EX
"RTN","PSOUTL",87,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",88,0)
 G:NODE=DA&(X'="") KREF G:'$D(^PSRX(DA(1),1,NODE,0)) KREF
"RTN","PSOUTL",89,0)
ORIG I 'NODE S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",90,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) G EX
"RTN","PSOUTL",91,0)
EX K NODE,RF
"RTN","PSOUTL",92,0)
 Q
"RTN","PSOUTL",93,0)
IBSS N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOUTL",94,0)
 S PSOHLP(1)="Entry in this field must match the SERVICE field for pharmacy action"
"RTN","PSOUTL",95,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOUTL",96,0)
 S PSOHLP(2)="types in the IB ACTION TYPE file AND be a valid entry in your"
"RTN","PSOUTL",97,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOUTL",98,0)
 S PSOHLP(3)="SERVICE/SECTION file to generate copay charges!"
"RTN","PSOUTL",99,0)
 S PSOHLP(4,"F")="!!"
"RTN","PSOUTL",100,0)
 D EN^DDIOL(.PSOHLP) K PSOHLP
"RTN","PSOUTL",101,0)
 Q
"RTN","PSOUTL",102,0)
IBSSR S PSOIBFL=0 F PSOIBLP=0:0 S PSOIBLP=$O(^DIC(49,PSOIBLP)) Q:'PSOIBLP!(PSOIBFL)  S Y=PSOIBLP,PSOIBST=$$SERV^IBARX1(+Y) I $G(PSOIBST) S DIE="^PS(59,",DA=PSOSITE,DR="1003////"_PSOIBLP D ^DIE K DIE D  S PSOIBFL=1
"RTN","PSOUTL",103,0)
 .W $C(7),!!,"There was an invalid entry in your IB SERVICE/SECTION field in your Outpatient",!,"Site Parameter file, but we have fixed the problem for you, and you",!,"may continue!" Q
"RTN","PSOUTL",104,0)
 Q
"RTN","PSOUTL",105,0)
WARN ;
"RTN","PSOUTL",106,0)
 I $G(PSOUNHLD) D  Q
"RTN","PSOUTL",107,0)
 .D EN^DDIOL("You cannot delete a refill while removing from Hold! Use the Edit Action.","","$C(7),!!"),EN^DDIOL(" ","","!!")
"RTN","PSOUTL",108,0)
 I $G(CMOP(DA))]""&(+$G(CMOP(DA))<3) D  K CMOP Q
"RTN","PSOUTL",109,0)
 .D EN^DDIOL("You cannot delete a refill that"_$S(+$G(CMOP(DA))=1:" has been released by",1:" is being transmitted to")_" the CMOP","","!!")
"RTN","PSOUTL",110,0)
 .D EN^DDIOL(" ","","!!")
"RTN","PSOUTL",111,0)
 K CMOP
"RTN","PSOUTL",112,0)
 ;
"RTN","PSOUTL",113,0)
 N PSOL,PSR
"RTN","PSOUTL",114,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),1,PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTL",115,0)
 I DA=PSOL,$P(^PSRX(DA(1),1,DA,0),"^",18) D  Q
"RTN","PSOUTL",116,0)
 .D EN^DDIOL("Refill Released! Use the 'Return to Stock' option!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTL",117,0)
 ;
"RTN","PSOUTL",118,0)
 ;Only allow deletion if last refill      *259
"RTN","PSOUTL",119,0)
 I $O(^PSRX(DA(1),1,DA)) D  Q
"RTN","PSOUTL",120,0)
 .D EN^DDIOL("Only the last refill can be deleted.  Later refills must be deleted first.","","$C(7),!!")
"RTN","PSOUTL",121,0)
 .D EN^DDIOL("","","!!")
"RTN","PSOUTL",122,0)
 ;
"RTN","PSOUTL",123,0)
 ;Warn of In Process, Only delete if answered Yes         ;*259
"RTN","PSOUTL",124,0)
 I $$REFIP^PSOUTLA1(DA(1),DA,"R") D  I 'Y Q               ;reset $T
"RTN","PSOUTL",125,0)
 . D EN^DDIOL("** Refill has previously been sent to the External Dispense Machine","","!!,?2")
"RTN","PSOUTL",126,0)
 . D EN^DDIOL("** for filling and is still Pending Processing","","$C(7),!,?2")
"RTN","PSOUTL",127,0)
 . D EN^DDIOL("","","!")
"RTN","PSOUTL",128,0)
 . K DIR
"RTN","PSOUTL",129,0)
 . S DIR("A")="Do you want to continue? "
"RTN","PSOUTL",130,0)
 . S DIR("B")="Y"
"RTN","PSOUTL",131,0)
 . S DIR(0)="YA^^"
"RTN","PSOUTL",132,0)
 . S DIR("?")="Enter Y for Yes or N for No."
"RTN","PSOUTL",133,0)
 . D ^DIR
"RTN","PSOUTL",134,0)
 . K DIR
"RTN","PSOUTL",135,0)
 Q
"RTN","PSOUTL",136,0)
 ;
"RTN","PSOUTL",137,0)
WARN1 ;move to PSOUTLA1
"RTN","PSOUTL",138,0)
 D WARN1^PSOUTLA1
"RTN","PSOUTL",139,0)
 Q
"RTN","PSOUTL",140,0)
 ;
"RTN","PSOUTL",141,0)
CAN(PSOXRX) ;Clean up Rx when discontinued
"RTN","PSOUTL",142,0)
 N SUSD,IFN,RF,NODE,DA
"RTN","PSOUTL",143,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",144,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA S DIK="^PS(52.5,",SUSD=$P($G(^PS(52.5,DA,0)),"^",2) D ^DIK K DIK I $O(^PSRX(PSOXRX,1,0)) S DA=PSOXRX D REF^PSOCAN2
"RTN","PSOUTL",145,0)
 I $D(^PS(52.4,PSOXRX,0)) S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",146,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",147,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",148,0)
 Q
"RTN","PSOUTL",149,0)
ECAN(PSOXRX) ;Clean up Rx when expired
"RTN","PSOUTL",150,0)
 N DA
"RTN","PSOUTL",151,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",152,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA K DIK S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOUTL",153,0)
 I $D(^PS(52.4,PSOXRX,0)) K DIK S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",154,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",155,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",156,0)
 Q
"RTN","PSOUTL",157,0)
CMOP ;CMOP("L")=LAST FILL... if it is orig Rx =0
"RTN","PSOUTL",158,0)
 ;CMOP(FILL #)=CMOP status from 52[TRAN=0,DISP=1,RETRAN=2,NOT DISP=3
"RTN","PSOUTL",159,0)
 ;If suspended CMOP("S")=CMOP suspense status Q,L,X,P,R
"RTN","PSOUTL",160,0)
 ;All returned variables can be killed by K CMOP
"RTN","PSOUTL",161,0)
 ;
"RTN","PSOUTL",162,0)
 S CRX=DA
"RTN","PSOUTL",163,0)
CMOP1 N X
"RTN","PSOUTL",164,0)
 S (CMOP("L"),X)=0  F  S X=$O(^PSRX(CRX,1,X)) Q:'X  S CMOP("L")=X
"RTN","PSOUTL",165,0)
 I $O(^PSRX(CRX,4,0)) F X=0:0 S X=$O(^PSRX(CRX,4,X)) Q:'X  D
"RTN","PSOUTL",166,0)
 .S CMOP($P($G(^PSRX(CRX,4,X,0)),"^",3))=$P($G(^(0)),"^",4)
"RTN","PSOUTL",167,0)
 S X=$O(^PS(52.5,"B",CRX,0)) I X]"" S CMOP("S")=$P($G(^PS(52.5,X,0)),"^",7)
"RTN","PSOUTL",168,0)
 K CRX,X
"RTN","PSOUTL",169,0)
 Q
"RTN","PSOUTL",170,0)
 ;
"RTN","PSOUTL",171,0)
CHKCMOP(RX,REA) ;Check if an RX is Transmitted/Retransmitted to CMOP and send alert mail
"RTN","PSOUTL",172,0)
 ;
"RTN","PSOUTL",173,0)
 ; Input:  RX - ien to file #52
"RTN","PSOUTL",174,0)
 ;        REA - reason DC's "A" = admission, "D" = death
"RTN","PSOUTL",175,0)
 ; Output: none
"RTN","PSOUTL",176,0)
 ;
"RTN","PSOUTL",177,0)
 N CMOP,PSOCMOP
"RTN","PSOUTL",178,0)
 S REA=$G(REA)
"RTN","PSOUTL",179,0)
 I $$TRANCMOP(RX),$G(PSOCMOP)]"" D MAILCMOP(RX,PSOCMOP,REA)
"RTN","PSOUTL",180,0)
 Q
"RTN","PSOUTL",181,0)
 ;
"RTN","PSOUTL",182,0)
TRANCMOP(RX) ;check if a fill is Transmitted or Retransmitted
"RTN","PSOUTL",183,0)
 ;
"RTN","PSOUTL",184,0)
 ; Input:          = RX number
"RTN","PSOUTL",185,0)
 ; Function output:= RX number if CMOP status is Trans or Retrans
"RTN","PSOUTL",186,0)
 ;                 = 0 if neither
"RTN","PSOUTL",187,0)
 ; Global parm out:= PSOCMOP = string from call to ^PSOCMOPA
"RTN","PSOUTL",188,0)
 ;
"RTN","PSOUTL",189,0)
 N DA,PSOTRANS
"RTN","PSOUTL",190,0)
 S DA=RX D ^PSOCMOPA
"RTN","PSOUTL",191,0)
 S PSOTRANS=$P($G(PSOCMOP),"^")
"RTN","PSOUTL",192,0)
 Q:PSOTRANS=0!(PSOTRANS=2) RX
"RTN","PSOUTL",193,0)
 Q 0
"RTN","PSOUTL",194,0)
 ;
"RTN","PSOUTL",195,0)
MAILCMOP(RX,STR,REA) ;Send mail message to mail group PSX EXTERNAL DISPENSE ALERTS
"RTN","PSOUTL",196,0)
 ;
"RTN","PSOUTL",197,0)
 ; Input:  RX  = ien of PSRX
"RTN","PSOUTL",198,0)
 ;         STR = CMOP STATUS # ^ TRANSMIT DATE (FM) ^ LAST FILL #
"RTN","PSOUTL",199,0)
 ;         REA = reason DC'd  "A" = admission, "D" = death
"RTN","PSOUTL",200,0)
 ; Output: none
"RTN","PSOUTL",201,0)
 ;
"RTN","PSOUTL",202,0)
 N CMDT,CMST,DFN,VADM,PSOTEXT,PSOIEN,PSOKEYN,XMY,XMDUZ,XMSUB,XMTEXT
"RTN","PSOUTL",203,0)
 N DIV,SSN,RXO,FILL,DRUG,DIVN,MAILGRP,NAME,PRV,RXSTS
"RTN","PSOUTL",204,0)
 S RXO=$$GET1^DIQ(52,RX,.01)
"RTN","PSOUTL",205,0)
 S CMDT=$P(STR,U,2)
"RTN","PSOUTL",206,0)
 S CMDT=$E(CMDT,4,5)_"/"_$E(CMDT,6,7)_"/"_$E(CMDT,2,3)
"RTN","PSOUTL",207,0)
 S FILL=$P(STR,U,3)
"RTN","PSOUTL",208,0)
 S CMST=$P(STR,U),CMST=$S(CMST=2:"RETRANSMITTED",1:"TRANSMITTED")
"RTN","PSOUTL",209,0)
 S DIV=$P(^PSRX(RX,2),"^",9),DIVN=$P($G(^PS(59,DIV,0)),"^")
"RTN","PSOUTL",210,0)
 S MAILGRP="PSX EXTERNAL DISPENSE ALERTS"
"RTN","PSOUTL",211,0)
 S XMY("G."_MAILGRP)=""
"RTN","PSOUTL",212,0)
 ;if no members & no member groups & no remote members, then send to
"RTN","PSOUTL",213,0)
 ; the default: PSXCMOPMGR key holders
"RTN","PSOUTL",214,0)
 S PSOIEN=$O(^XMB(3.8,"B",MAILGRP,0))
"RTN","PSOUTL",215,0)
 I '$O(^XMB(3.8,PSOIEN,1,0))&'$O(^XMB(3.8,PSOIEN,5,0))&'$O(^XMB(3.8,PSOIEN,6,0)) D
"RTN","PSOUTL",216,0)
 . S PSOKEYN=0
"RTN","PSOUTL",217,0)
 . F  S PSOKEYN=$O(^XUSEC("PSXCMOPMGR",PSOKEYN)) Q:'PSOKEYN  D
"RTN","PSOUTL",218,0)
 . . S XMY(PSOKEYN)=""
"RTN","PSOUTL",219,0)
 S DFN=$$GET1^DIQ(52,RX,2,"I") D DEM^VADPT
"RTN","PSOUTL",220,0)
 S NAME=VADM(1)
"RTN","PSOUTL",221,0)
 S SSN=$P($P(VADM(2),"^",2),"-",3)
"RTN","PSOUTL",222,0)
 S RXSTS=$$GET1^DIQ(52,RX,100)
"RTN","PSOUTL",223,0)
 S DRUG=$$GET1^DIQ(52,RX,6)
"RTN","PSOUTL",224,0)
 S PRV=$$GET1^DIQ(52,RX,4)
"RTN","PSOUTL",225,0)
 S XMDUZ=.5
"RTN","PSOUTL",226,0)
 S XMSUB=DIVN_" - DC Alert on CMOP Rx "_RXO_" "_CMST
"RTN","PSOUTL",227,0)
 S PSOTEXT(1)="             Rx #: "_RXO_"   Fill: "_FILL
"RTN","PSOUTL",228,0)
 S PSOTEXT(2)="          Patient: "_NAME_" ("_SSN_")"
"RTN","PSOUTL",229,0)
 S PSOTEXT(3)="             Drug: "_DRUG
"RTN","PSOUTL",230,0)
 S PSOTEXT(4)="        Rx Status: "_RXSTS
"RTN","PSOUTL",231,0)
 S:REA="A" PSOTEXT(4)=PSOTEXT(4)_" (due to Admission)"
"RTN","PSOUTL",232,0)
 S:REA="D" PSOTEXT(4)=PSOTEXT(4)_" (due to Date of Death)"
"RTN","PSOUTL",233,0)
 S PSOTEXT(5)="Processing Status: "_CMST_" to CMOP on "_CMDT
"RTN","PSOUTL",234,0)
 S PSOTEXT(6)="         Provider: "_PRV
"RTN","PSOUTL",235,0)
 S PSOTEXT(7)=""
"RTN","PSOUTL",236,0)
 S PSOTEXT(8)="********    Please contact CMOP or take appropriate action    ********"
"RTN","PSOUTL",237,0)
 S XMTEXT="PSOTEXT(" D ^XMD
"RTN","PSOUTL",238,0)
 D KVA^VADPT
"RTN","PSOUTL",239,0)
 Q
"RTN","PSOVER1")
0^10^B56428439^B59048766
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207,148,243,268,281,324**;DEC 1997;Build 6
"RTN","PSOVER1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
REDO ;
"RTN","PSOVER1",10,0)
 S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",11,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",12,0)
 S (STA,DNM)="",PSDPSTOP=0,$P(PSONULN,"-",79)="-" F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  K PSZZZDUP I $P(PSOSD(STA,DNM),"^",2)<10 D
"RTN","PSOVER1",13,0)
 .I STA="ZNONVA" D NVA Q
"RTN","PSOVER1",14,0)
 .I PSODRUG("NAME")=$P(DNM,"^")&(PSONV'=$P(PSOSD(STA,DNM),"^")) S PSZZZDUP=1 K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" W ! D ^DIR K DIR S PSDTSTOP=1
"RTN","PSOVER1",15,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" W ! D ^DIR K DIR D CLS^PSODRDUP S PSDTSTOP=1
"RTN","PSOVER1",16,0)
 .I $G(PSZZZDUP),$G(PSVFLAG),$P($G(^PSRX($P(PSOSD(STA,DNM),"^"),"STA")),"^")=12,$D(^PS(52.4,$P(PSOSD(STA,DNM),"^"),0)) S DA=$P(PSOSD(STA,DNM),"^"),DIK="^PS(52.4," D ^DIK K DIK
"RTN","PSOVER1",17,0)
 .I $G(PSZZZDUP),$G(PSVFLAG),$P($G(^PSRX($P(PSOSD(STA,DNM),"^"),"STA")),"^")'=12 S PSZZQUIT=1
"RTN","PSOVER1",18,0)
 K MSG I $G(PSZZQUIT),$G(PSVFLAG) K PSZZQUIT,PSODRUG,PSODFN,PSZZZDUP,DNM,PSDTSTOP D CLEAN Q
"RTN","PSOVER1",19,0)
 D REMOTE
"RTN","PSOVER1",20,0)
 K PSODRUG,PSODFN,PSZZZDUP,DNM,PSZZQUIT
"RTN","PSOVER1",21,0)
ALLR ;Allergy check
"RTN","PSOVER1",22,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D:PSONOAL'="" NOALRGY K PSONOAL I $G(PSZZQUIT) K MSG,PSZZQUIT,PSODRUG,PSODFN,PSZZZDUP,DNM,PSDTSTOP D CLEAN Q
"RTN","PSOVER1",23,0)
 G:'$P($G(^PSRX(PSONV,3)),"^",6) EDIT
"RTN","PSOVER1",24,0)
 I '$G(PSDTSTOP) K DIR S DIR(0)="E" D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) K PSDTSTOP G OUT
"RTN","PSOVER1",25,0)
 W !!,"A Drug-Allergy Reaction exists for this medication!",!!,"***SIGNIFICANT*** Allergy Reaction"
"RTN","PSOVER1",26,0)
 W !,"Drug: ",$P($G(^PSDRUG(+$P($G(^PSRX(PSONV,0)),"^",6),0)),"^")
"RTN","PSOVER1",27,0)
 I $O(^PSRX(PSONV,"DAI",0)) W !?6,"Ingredients: " D
"RTN","PSOVER1",28,0)
 .F PSPPP=0:0 S PSPPP=$O(^PSRX(PSONV,"DAI",PSPPP)) Q:'PSPPP  I $G(^(PSPPP,0))'="" W:$X+$L($G(^PSRX(PSONV,"DAI",PSPPP,0)))+2>IOM !?19 W $G(^PSRX(PSONV,"DAI",PSPPP,0))_", "
"RTN","PSOVER1",29,0)
 W ! K DIR,PSPPP S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to intervene?" D ^DIR K DIR I X["^"!($D(DTOUT))!($D(DUOUT)) K PSDTSTOP G OUT
"RTN","PSOVER1",30,0)
 I Y S PSORX("INTERVENE")=0 D EN1^PSORXI(PSONV)
"RTN","PSOVER1",31,0)
EDIT I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",32,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to proceed with verification"
"RTN","PSOVER1",33,0)
 D ^DIR K DIR I Y="Y",$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",34,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",35,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",36,0)
 G VERIFY:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",37,0)
CHANGE S DA=PSONV,(PSRX1,PSRX2)=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",38,0)
 S DEA1=1,DEA2=0,PSDOLD=+DA,DIE="^PSRX(",DR="3;7;8;9;4;5;12;1;22;11;"_$S($P(PSOPAR,"^",12):"35;",1:"")_$S($P(PSOPAR,"^",15):"10.6",1:"")_";@2" D ^DIE
"RTN","PSOVER1",39,0)
 ;I PSRX1'=PSRX2,DEA1'=DEA2 S DR="6////"_PSRX1 D ^DIE
"RTN","PSOVER1",40,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",41,0)
 K PSD(PSDOLD) S PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",42,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",43,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",44,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",45,0)
 D ^PSODSPL G EDIT Q
"RTN","PSOVER1",46,0)
 ;
"RTN","PSOVER1",47,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",48,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(52.4,DA,0),"^",7)=X Q
"RTN","PSOVER1",49,0)
VERIFY G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",50,0)
 S DIR("A")="VERIFY FOR "_PSONAM_" ? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",51,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",52,0)
 D ^DIR K DIR G OUT:Y="N",QUIT:"Q^"[$E(Y),DELETE:Y="D"
"RTN","PSOVER1",53,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",54,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",55,0)
 K ^PSRX(PSONV,"DRI"),SPFL
"RTN","PSOVER1",56,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",57,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",58,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",59,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",60,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",61,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",62,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",63,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",64,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",65,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",66,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",67,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",68,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",69,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",70,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^(2),"^",2),RXF=0 D UPSUS S PSTRIVER=1 D SUS^PSORXL K PSORX("FILL DATE"),PSTRIVER G KILL
"RTN","PSOVER1",71,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,$P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",72,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",73,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",74,0)
 ;
"RTN","PSOVER1",75,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSOVER1",76,0)
 N ACTION
"RTN","PSOVER1",77,0)
 I $$SUBMIT^PSOBPSUT(PSONV) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSOVER1",78,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSONV,,,$S($O(^PSRX(PSONV,1,0)):"RF",1:"OF"))
"RTN","PSOVER1",79,0)
 . I $$FIND^PSOREJUT(PSONV) D
"RTN","PSOVER1",80,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSONV,0,"79,88","OF","IOQ","Q")
"RTN","PSOVER1",81,0)
 ;
"RTN","PSOVER1",82,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",83,0)
OUT K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN Q
"RTN","PSOVER1",84,0)
DELETE K UPFLAGX D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",85,0)
QUIT S PSOQUIT="" D CLEAN Q
"RTN","PSOVER1",86,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",87,0)
 Q
"RTN","PSOVER1",88,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",89,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",90,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",91,0)
 .W !,$S($P(^TMP("PSORXDC",$J,RORD,0),"^")=52:"Prescription",1:"Pending Order")_" #"_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")=52:$P(^PSRX(RORD,0),"^"),1:RORD)_" NOT Discontinued."
"RTN","PSOVER1",92,0)
 K ^TMP("PSORXDC",$J),RORD
"RTN","PSOVER1",93,0)
 Q
"RTN","PSOVER1",94,0)
KV1 ;
"RTN","PSOVER1",95,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",96,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",97,0)
 Q
"RTN","PSOVER1",98,0)
NVA ;
"RTN","PSOVER1",99,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",100,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",101,0)
 S (Y,FLG)=""
"RTN","PSOVER1",102,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",103,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",104,0)
 Q
"RTN","PSOVER1",105,0)
REMOTE ; 
"RTN","PSOVER1",106,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",107,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",108,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",109,0)
 .I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSOVER1",110,0)
 ..I $T(REMOTE^PSORX1)]"" Q
"RTN","PSOVER1",111,0)
 ..W !,"Remote data not available - Only local order checks processed." D PAUSE^PSOORRD2
"RTN","PSOVER1",112,0)
 .W !,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",113,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",114,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !,"Remote data not available - Only local order checks processed." D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",115,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",116,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",117,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",118,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",119,0)
 Q
"RTN","PSOVER1",120,0)
NOALRGY ;
"RTN","PSOVER1",121,0)
 N PSODFN,PSODRUG
"RTN","PSOVER1",122,0)
 S PSODFN=$P(^PSRX(PSONV,0),"^",2),PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",123,0)
 D NOALRGY^PSODRG
"RTN","PSOVER1",124,0)
 Q
"VER")
8.0^22.0
"BLD",6371,6)
^288
**END**
**END**

Released PRC*5.1*119 SEQ #101
Extracted from mail message
**KIDS**:PRC*5.1*119^

**INSTALL NAME**
PRC*5.1*119
"BLD",5782,0)
PRC*5.1*119^IFCAP^0^3080418^y
"BLD",5782,1,0)
^^9^9^3080417^^
"BLD",5782,1,1,0)
Description:
"BLD",5782,1,2,0)
===========
"BLD",5782,1,3,0)
 
"BLD",5782,1,4,0)
This patch is addressing the issue regarding an <UNDEFINED> error that
"BLD",5782,1,5,0)
occurred in the Bay Pines' DynaMed/IFCAP interface. Bay Pines is the only
"BLD",5782,1,6,0)
site that is running the DynaMed/IFCAP interface. With the help from the
"BLD",5782,1,7,0)
VistA Interface Engine (VIE) group and DynaMed, a test link between 
"BLD",5782,1,8,0)
DynaMed and IFCAP was created to complete the secondary review test in 
"BLD",5782,1,9,0)
the Bay Pines test environment.
"BLD",5782,4,0)
^9.64PA^^
"BLD",5782,6.3)
8
"BLD",5782,"ABPKG")
n
"BLD",5782,"KRN",0)
^9.67PA^8989.52^19
"BLD",5782,"KRN",.4,0)
.4
"BLD",5782,"KRN",.401,0)
.401
"BLD",5782,"KRN",.402,0)
.402
"BLD",5782,"KRN",.403,0)
.403
"BLD",5782,"KRN",.5,0)
.5
"BLD",5782,"KRN",.84,0)
.84
"BLD",5782,"KRN",3.6,0)
3.6
"BLD",5782,"KRN",3.8,0)
3.8
"BLD",5782,"KRN",9.2,0)
9.2
"BLD",5782,"KRN",9.8,0)
9.8
"BLD",5782,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",5782,"KRN",9.8,"NM",1,0)
PRCVRC2^^0^B37446189
"BLD",5782,"KRN",9.8,"NM",2,0)
PRCVREA^^0^B24623450
"BLD",5782,"KRN",9.8,"NM",3,0)
PRCVRE1^^0^B52916025
"BLD",5782,"KRN",9.8,"NM","B","PRCVRC2",1)

"BLD",5782,"KRN",9.8,"NM","B","PRCVRE1",3)

"BLD",5782,"KRN",9.8,"NM","B","PRCVREA",2)

"BLD",5782,"KRN",19,0)
19
"BLD",5782,"KRN",19.1,0)
19.1
"BLD",5782,"KRN",101,0)
101
"BLD",5782,"KRN",409.61,0)
409.61
"BLD",5782,"KRN",771,0)
771
"BLD",5782,"KRN",870,0)
870
"BLD",5782,"KRN",8989.51,0)
8989.51
"BLD",5782,"KRN",8989.52,0)
8989.52
"BLD",5782,"KRN",8994,0)
8994
"BLD",5782,"KRN","B",.4,.4)

"BLD",5782,"KRN","B",.401,.401)

"BLD",5782,"KRN","B",.402,.402)

"BLD",5782,"KRN","B",.403,.403)

"BLD",5782,"KRN","B",.5,.5)

"BLD",5782,"KRN","B",.84,.84)

"BLD",5782,"KRN","B",3.6,3.6)

"BLD",5782,"KRN","B",3.8,3.8)

"BLD",5782,"KRN","B",9.2,9.2)

"BLD",5782,"KRN","B",9.8,9.8)

"BLD",5782,"KRN","B",19,19)

"BLD",5782,"KRN","B",19.1,19.1)

"BLD",5782,"KRN","B",101,101)

"BLD",5782,"KRN","B",409.61,409.61)

"BLD",5782,"KRN","B",771,771)

"BLD",5782,"KRN","B",870,870)

"BLD",5782,"KRN","B",8989.51,8989.51)

"BLD",5782,"KRN","B",8989.52,8989.52)

"BLD",5782,"KRN","B",8994,8994)

"BLD",5782,"QUES",0)
^9.62^^
"BLD",5782,"REQB",0)
^9.611^1^1
"BLD",5782,"REQB",1,0)
PRC*5.1*81^2
"BLD",5782,"REQB","B","PRC*5.1*81",1)

"MBREQ")
0
"PKG",455,-1)
1^1
"PKG",455,0)
IFCAP^PRC^IFCAP System Files
"PKG",455,20,0)
^9.402P^^
"PKG",455,22,0)
^9.49I^1^1
"PKG",455,22,1,0)
5.1^3001012^3001019^68
"PKG",455,22,1,"PAH",1,0)
119^3080418
"PKG",455,22,1,"PAH",1,1,0)
^^9^9^3080418
"PKG",455,22,1,"PAH",1,1,1,0)
Description:
"PKG",455,22,1,"PAH",1,1,2,0)
===========
"PKG",455,22,1,"PAH",1,1,3,0)
 
"PKG",455,22,1,"PAH",1,1,4,0)
This patch is addressing the issue regarding an <UNDEFINED> error that
"PKG",455,22,1,"PAH",1,1,5,0)
occurred in the Bay Pines' DynaMed/IFCAP interface. Bay Pines is the only
"PKG",455,22,1,"PAH",1,1,6,0)
site that is running the DynaMed/IFCAP interface. With the help from the
"PKG",455,22,1,"PAH",1,1,7,0)
VistA Interface Engine (VIE) group and DynaMed, a test link between 
"PKG",455,22,1,"PAH",1,1,8,0)
DynaMed and IFCAP was created to complete the secondary review test in 
"PKG",455,22,1,"PAH",1,1,9,0)
the Bay Pines test environment.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PRCVRC2")
0^1^B37446189^B34815057
"RTN","PRCVRC2",1,0)
PRCVRC2 ;WOIFO/BMM/VAC - silently build RIL for DynaMed ; 12/3/07 10:32am
"RTN","PRCVRC2",2,0)
V ;;5.1;IFCAP;**81,119**;Oct 20, 2000;Build 8
"RTN","PRCVRC2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCVRC2",4,0)
 ;
"RTN","PRCVRC2",5,0)
 ;12/07 Code modified to fix error in GETTXN due to logic error.
"RTN","PRCVRC2",6,0)
 ;  Added KILL statements to eliminate finding random ^TMP global data
"RTN","PRCVRC2",7,0)
 ;  from other routines and to clean up ^DIC calls.
"RTN","PRCVRC2",8,0)
 ;
"RTN","PRCVRC2",9,0)
 ;validation, error code for PRCVRC1
"RTN","PRCVRC2",10,0)
 ;
"RTN","PRCVRC2",11,0)
 Q
"RTN","PRCVRC2",12,0)
 ;
"RTN","PRCVRC2",13,0)
GETFY(PRCVDT) ;return the fiscal year, PRCVDT is date/time the DM
"RTN","PRCVRC2",14,0)
 ;message was created (thus the date/time for RIL)
"RTN","PRCVRC2",15,0)
 ;
"RTN","PRCVRC2",16,0)
 Q $E(100+$E(PRCVDT,2,3)+$E(PRCVDT,4),2,3)
"RTN","PRCVRC2",17,0)
 ;
"RTN","PRCVRC2",18,0)
GETQTR(PRCVDT) ;return the fiscal quarter, PRCVDT is date/time the DM
"RTN","PRCVRC2",19,0)
 ;message was created (thus the date/time for RIL)
"RTN","PRCVRC2",20,0)
 ;
"RTN","PRCVRC2",21,0)
 N QTR S QTR=+$E(PRCVDT,4,5)
"RTN","PRCVRC2",22,0)
 Q $P("2^2^2^3^3^3^4^4^4^1^1^1","^",+QTR)
"RTN","PRCVRC2",23,0)
 ;
"RTN","PRCVRC2",24,0)
GETTXN(PRCVSTR) ;obtain current transaction number (if exists) from
"RTN","PRCVRC2",25,0)
 ;Transaction Number file (#410.1)
"RTN","PRCVRC2",26,0)
 ;increment transaction for current use, update 410.1 entry
"RTN","PRCVRC2",27,0)
 ;return new transaction number for this RIL
"RTN","PRCVRC2",28,0)
 ;PRCVSTR is Entry Number, comes in as "station-fy-qtr-fcp-cc"
"RTN","PRCVRC2",29,0)
 ;TXN is transaction #, PRCVRN is IEN for 410.1 entry
"RTN","PRCVRC2",30,0)
 ;NOTE: CHECK 410 too, look in EN1^PRCSUT3, lines 8-10 etc.
"RTN","PRCVRC2",31,0)
 ;
"RTN","PRCVRC2",32,0)
 Q:$G(PRCVSTR)="" 0
"RTN","PRCVRC2",33,0)
 N TXN,PRCVE,PRCVRN S TXN="",(PRCVRN,PRCVE)=0
"RTN","PRCVRC2",34,0)
 ;check if Entry Number def in 410.1
"RTN","PRCVRC2",35,0)
 K ATXN,^TMP("DIERR",$J),^TMP("DILIST",$J)
"RTN","PRCVRC2",36,0)
 D FIND^DIC(410.1,,"1","BX",PRCVSTR,,,,,"ATXN")
"RTN","PRCVRC2",37,0)
 ;
"RTN","PRCVRC2",38,0)
 S TXN=+$G(ATXN("DILIST","ID",1,1))
"RTN","PRCVRC2",39,0)
 S PRCVRN=$G(ATXN("DILIST",2,1))
"RTN","PRCVRC2",40,0)
 I TXN<1 D  Q:PRCVE=1 0
"RTN","PRCVRC2",41,0)
 . ;TXN=0 so Entry Number not def, create new
"RTN","PRCVRC2",42,0)
 . K PRCVAT S PRCVAT(410.1,"+1,",.01)=PRCVSTR
"RTN","PRCVRC2",43,0)
 . S PRCVAT(410.1,"+1,",2)=DT
"RTN","PRCVRC2",44,0)
 . S PRCVAT(410.1,"+1,",1)=1
"RTN","PRCVRC2",45,0)
 . K ^TMP("DIERR",$J),^TMP("DILIST",$J)
"RTN","PRCVRC2",46,0)
 . D UPDATE^DIE("","PRCVAT","PRCVRN")
"RTN","PRCVRC2",47,0)
 . ;don't send msg here
"RTN","PRCVRC2",48,0)
 . ;I $D(^TMP("DIERR",$J)) D SENDMSG(7,PRCVGL,0,1) S PRCVE=1 Q
"RTN","PRCVRC2",49,0)
 . I $D(^TMP("DIERR",$J))>0 K ^TMP("DIERR",$J),^TMP("DILIST",$J) S PRCVE=1 Q
"RTN","PRCVRC2",50,0)
 . S PRCVRN=PRCVRN(1)
"RTN","PRCVRC2",51,0)
 S TXN=TXN+1
"RTN","PRCVRC2",52,0)
 K PRCVSA S PRCVSA(410.1,PRCVRN_",",1)=TXN
"RTN","PRCVRC2",53,0)
 K ^TMP("DIERR",$J),^TMP("DILIST",$J)
"RTN","PRCVRC2",54,0)
 D FILE^DIE("","PRCVSA")
"RTN","PRCVRC2",55,0)
 ;don't send msg here
"RTN","PRCVRC2",56,0)
 ;I $D(^TMP("DILIST",$J)) D SENDMSG(7,PRCVGL,0,1) Q 0
"RTN","PRCVRC2",57,0)
 I $D(^TMP("DIERR",$J))>0 K ^TMP("DIERR",$J),^TMP("DILIST",$J) Q 0
"RTN","PRCVRC2",58,0)
 K ^TMP("DIERR",$J),^TMP("DILIST",$J)
"RTN","PRCVRC2",59,0)
 S TXN="000"_TXN,TXN=$E(TXN,$L(TXN)-3,$L(TXN))
"RTN","PRCVRC2",60,0)
 Q TXN
"RTN","PRCVRC2",61,0)
 ;
"RTN","PRCVRC2",62,0)
CHKDT(INDT) ;check the incoming date (date/time message created) against
"RTN","PRCVRC2",63,0)
 ;the present date.  date/time message created must be today or in
"RTN","PRCVRC2",64,0)
 ;the past.  if INDT is today or before today then return 1, else 
"RTN","PRCVRC2",65,0)
 ;return 0
"RTN","PRCVRC2",66,0)
 ;both dates are in Fileman format ex. 3050503.12446
"RTN","PRCVRC2",67,0)
 ;
"RTN","PRCVRC2",68,0)
 Q:$G(INDT)="" 0
"RTN","PRCVRC2",69,0)
 N %,PRESENT,PRCVDIFF
"RTN","PRCVRC2",70,0)
 D NOW^%DTC S PRESENT=%
"RTN","PRCVRC2",71,0)
 S PRCVDIFF=$$FMDIFF^XLFDT(PRESENT,INDT,1)
"RTN","PRCVRC2",72,0)
 I PRCVDIFF'<0 Q 1
"RTN","PRCVRC2",73,0)
 Q 0
"RTN","PRCVRC2",74,0)
 ;
"RTN","PRCVRC2",75,0)
CHKDTN(INDT) ;check the incoming date (Date Needed By from DynaMed)
"RTN","PRCVRC2",76,0)
 ;against the present date.  Date Needed By must be today or in the
"RTN","PRCVRC2",77,0)
 ;future.  if INDT is today or after today then return 1, else return 0
"RTN","PRCVRC2",78,0)
 ;both dates are in FileMan format ex. 3050503.12446
"RTN","PRCVRC2",79,0)
 ;
"RTN","PRCVRC2",80,0)
 Q:$G(INDT)="" 0
"RTN","PRCVRC2",81,0)
 N %,PRESENT,PRCVDIFF
"RTN","PRCVRC2",82,0)
 D NOW^%DTC S PRESENT=%
"RTN","PRCVRC2",83,0)
 S PRCVDIFF=$$FMDIFF^XLFDT(PRESENT,INDT,1)
"RTN","PRCVRC2",84,0)
 I PRCVDIFF'>0 Q 1
"RTN","PRCVRC2",85,0)
 Q 0
"RTN","PRCVRC2",86,0)
 ;
"RTN","PRCVRC2",87,0)
CHKBOC(ITEM,BOC) ;test BOC from passed-in detail record
"RTN","PRCVRC2",88,0)
 ;
"RTN","PRCVRC2",89,0)
 Q:$G(ITEM)="" 0
"RTN","PRCVRC2",90,0)
 N PRCVIBOC
"RTN","PRCVRC2",91,0)
 S PRCVIBOC=$$GET1^DIQ(441,ITEM_",",12,"I")
"RTN","PRCVRC2",92,0)
 I PRCVIBOC'=BOC Q 0
"RTN","PRCVRC2",93,0)
 Q 1
"RTN","PRCVRC2",94,0)
 ;
"RTN","PRCVRC2",95,0)
CHKFCP(PRCVFCP,PRCVST) ;validate that FCP is in 420
"RTN","PRCVRC2",96,0)
 ;
"RTN","PRCVRC2",97,0)
 Q:$G(PRCVFCP)=""!($G(PRCVST)="") 0
"RTN","PRCVRC2",98,0)
 N PRCVE,PRCVN,PRCVVAL
"RTN","PRCVRC2",99,0)
 S PRCVVAL=1,PRCVN=0
"RTN","PRCVRC2",100,0)
 S PRCVN=$$FIND1^DIC(420.01,","_PRCVST_",","",PRCVFCP_" ","B","","PRCVE")
"RTN","PRCVRC2",101,0)
 I +PRCVN'>0 S PRCVVAL=0
"RTN","PRCVRC2",102,0)
 Q PRCVVAL
"RTN","PRCVRC2",103,0)
 ;
"RTN","PRCVRC2",104,0)
CHKITM(PRCVITM) ;check extracted item number:
"RTN","PRCVRC2",105,0)
 ;1. must be greater than 100000
"RTN","PRCVRC2",106,0)
 ;2. must be defined in Item Master (#441) file
"RTN","PRCVRC2",107,0)
 ;3. must not be inactive (441 field 16 '=1)
"RTN","PRCVRC2",108,0)
 ;
"RTN","PRCVRC2",109,0)
 Q:$G(PRCVITM)="" 0
"RTN","PRCVRC2",110,0)
 N CITM S CITM=0
"RTN","PRCVRC2",111,0)
 ;N NITM
"RTN","PRCVRC2",112,0)
 ;S NITM=$$FIND1^DIC(441,"","X",PRCVITM,"","","ATXN")
"RTN","PRCVRC2",113,0)
 ;I '$D(ATXN) Q 1
"RTN","PRCVRC2",114,0)
 I PRCVITM'<100000,$D(^PRC(441,"B",PRCVITM)) D
"RTN","PRCVRC2",115,0)
 . I +$$GET1^DIQ(441,PRCVITM_",",16,"I")=0 S CITM=1
"RTN","PRCVRC2",116,0)
 Q CITM
"RTN","PRCVRC2",117,0)
 ;
"RTN","PRCVRC2",118,0)
CHKVEND(VENDN) ;check that vendor in Vendor file is active.
"RTN","PRCVRC2",119,0)
 ;VENDN is Vendor number
"RTN","PRCVRC2",120,0)
 ;
"RTN","PRCVRC2",121,0)
 Q:+VENDN=0 0
"RTN","PRCVRC2",122,0)
 N NVNDP,CHKFLG
"RTN","PRCVRC2",123,0)
 S CHKFLG=0
"RTN","PRCVRC2",124,0)
 I $D(^PRC(440,VENDN,0)),$$GET1^DIQ(440,VENDN_",",32,"I")="" S CHKFLG=1
"RTN","PRCVRC2",125,0)
 Q CHKFLG
"RTN","PRCVRC2",126,0)
 ;
"RTN","PRCVRC2",127,0)
CHKVI(VENDN,ITMN) ;check that vendor VENDN sells item ITMN
"RTN","PRCVRC2",128,0)
 ;can't use $$FIND1^DIC since could be >1 cross-ref and >1 node
"RTN","PRCVRC2",129,0)
 ;
"RTN","PRCVRC2",130,0)
 N ITMNN,VENDP,CHKFLG
"RTN","PRCVRC2",131,0)
 S (VENDP,ITMNN,CHKFLG)=0
"RTN","PRCVRC2",132,0)
 Q:+VENDN=0!(+ITMN=0) CHKFLG
"RTN","PRCVRC2",133,0)
 ;get item ien, quit if undef
"RTN","PRCVRC2",134,0)
 S ITMNN=$O(^PRC(441,"B",ITMN,0))
"RTN","PRCVRC2",135,0)
 Q:ITMNN="" CHKFLG
"RTN","PRCVRC2",136,0)
 ;get pointer to vendor ien
"RTN","PRCVRC2",137,0)
 S VENDP=$O(^PRC(441,ITMNN,2,"B",VENDN,0))
"RTN","PRCVRC2",138,0)
 ;check that vendor is defined
"RTN","PRCVRC2",139,0)
 I VENDP>0,$D(^PRC(440,VENDP,0)) S CHKFLG=1
"RTN","PRCVRC2",140,0)
 ;if item file defined and vendor for item defined, good
"RTN","PRCVRC2",141,0)
 Q CHKFLG
"RTN","PRCVRC2",142,0)
 ;
"RTN","PRCVRC2",143,0)
CHKDUZ(INDUZ) ;validate that DUZ against New Person (#200)
"RTN","PRCVRC2",144,0)
 ;
"RTN","PRCVRC2",145,0)
 N DUZFLG S DUZFLG=0
"RTN","PRCVRC2",146,0)
 Q:$G(INDUZ)="" DUZFLG
"RTN","PRCVRC2",147,0)
 I $D(^VA(200,INDUZ,0)) S DUZFLG=1
"RTN","PRCVRC2",148,0)
 Q DUZFLG
"RTN","PRCVRC2",149,0)
 ;
"RTN","PRCVRC2",150,0)
CHKNIF(ITEM,NIF) ;use the passed-in item to check that the passed-in
"RTN","PRCVRC2",151,0)
 ;NIF# is correct.  return 1 if valid, 0 if not valid
"RTN","PRCVRC2",152,0)
 ;
"RTN","PRCVRC2",153,0)
 N PRCVINIF
"RTN","PRCVRC2",154,0)
 S PRCVINIF=$$GET1^DIQ(441,ITEM_",",51)
"RTN","PRCVRC2",155,0)
 I PRCVINIF=NIF Q 1
"RTN","PRCVRC2",156,0)
 Q 0
"RTN","PRCVRC2",157,0)
 ;
"RTN","PRCVRC2",158,0)
MAKECAP(INSTR) ;take INSTR and return an all-caps version of it
"RTN","PRCVRC2",159,0)
 ;
"RTN","PRCVRC2",160,0)
 Q:$G(INSTR)="" ""
"RTN","PRCVRC2",161,0)
 N X,Y
"RTN","PRCVRC2",162,0)
 S X=INSTR X ^%ZOSF("UPPERCASE")
"RTN","PRCVRC2",163,0)
 Q Y
"RTN","PRCVRC2",164,0)
 ;
"RTN","PRCVRC2",165,0)
SENDMSG(EC,PRCVGL,CTR,ERPC) ;send an alert or error message back to
"RTN","PRCVRC2",166,0)
 ;DynaMed via VIE by posting "ERR" node to appropriate ^XTMP node
"RTN","PRCVRC2",167,0)
 ;
"RTN","PRCVRC2",168,0)
 ;the error text is currently stored in the routine PRCVRC3
"RTN","PRCVRC2",169,0)
 ;
"RTN","PRCVRC2",170,0)
 ;EC is the error code
"RTN","PRCVRC2",171,0)
 ;use EC to get the description and severity
"RTN","PRCVRC2",172,0)
 ;the message is built in ECSTR and the "ERR" node in ^XTMP is 
"RTN","PRCVRC2",173,0)
 ;  created using passed-in message id in MID.  the error message 
"RTN","PRCVRC2",174,0)
 ;  is appended to "ERR" and is separated by other error messages 
"RTN","PRCVRC2",175,0)
 ;  already there with a carat ("^")
"RTN","PRCVRC2",176,0)
 ;PRCVGL is the ^XTMP subscript and CTR is the detail counter #
"RTN","PRCVRC2",177,0)
 ;ERPC is the data piece in the line item node or header node to 
"RTN","PRCVRC2",178,0)
 ;  which the error pertains
"RTN","PRCVRC2",179,0)
 ;
"RTN","PRCVRC2",180,0)
 N X S X="PRCVRC3"
"RTN","PRCVRC2",181,0)
 X ^%ZOSF("TEST") I '$T Q
"RTN","PRCVRC2",182,0)
 N ECSTR,OVERSTR,ERRCTR
"RTN","PRCVRC2",183,0)
 S ERPC=$G(ERPC)
"RTN","PRCVRC2",184,0)
 S ECSTR=ERPC_"^"_$P($T(ET+EC^PRCVRC3),";;",2),CTR=+CTR
"RTN","PRCVRC2",185,0)
 I CTR'=0 D
"RTN","PRCVRC2",186,0)
 . S ERRCTR=+$O(^XTMP(PRCVGL,2,CTR,"ERR",""),-1)
"RTN","PRCVRC2",187,0)
 . S ERRCTR=ERRCTR+1,^XTMP(PRCVGL,2,CTR,"ERR",ERRCTR)=ECSTR
"RTN","PRCVRC2",188,0)
 I CTR=0 D
"RTN","PRCVRC2",189,0)
 . S ERRCTR=+$O(^XTMP(PRCVGL,1,"ERR",""),-1)
"RTN","PRCVRC2",190,0)
 . S ERRCTR=ERRCTR+1,^XTMP(PRCVGL,1,"ERR",ERRCTR)=ECSTR
"RTN","PRCVRC2",191,0)
 Q
"RTN","PRCVRC2",192,0)
 ;
"RTN","PRCVRC2",193,0)
ADDAUD(ADDSTR) ;add "^"-pieces from ADDSTR as fields to a new record in
"RTN","PRCVRC2",194,0)
 ;the Audit file #410.02
"RTN","PRCVRC2",195,0)
 ;
"RTN","PRCVRC2",196,0)
 ;ADDSTR pieces: DynaMed Doc ID ^ Item # ^ Vendor ^ User DUZ ^
"RTN","PRCVRC2",197,0)
 ;  Last name,First name ^ RIL# ^ date/time RIL created ^
"RTN","PRCVRC2",198,0)
 ;  date/time message created (DynaMed requisition) ^ date needed
"RTN","PRCVRC2",199,0)
 ;
"RTN","PRCVRC2",200,0)
 Q:$G(ADDSTR)=""
"RTN","PRCVRC2",201,0)
 ;
"RTN","PRCVRC2",202,0)
 ;set up entry
"RTN","PRCVRC2",203,0)
 N PRCVA,PRCVI,PRCVP,PRCVRIL,PRCVTMP S PRCVA="",PRCVP=0
"RTN","PRCVRC2",204,0)
 F PRCVI=.01,1,2,3,13,4,5,6,12 S PRCVP=PRCVP+1 D
"RTN","PRCVRC2",205,0)
 . S PRCVA(414.02,"+1,",PRCVI)=$P(ADDSTR,U,PRCVP)
"RTN","PRCVRC2",206,0)
 ;add record to Audit File
"RTN","PRCVRC2",207,0)
 D UPDATE^DIE("","PRCVA")
"RTN","PRCVRC2",208,0)
 ;if error, send bulletin
"RTN","PRCVRC2",209,0)
 I $D(^TMP("DIERR",$J)) D  Q
"RTN","PRCVRC2",210,0)
 . S PRCVTMP="PRCVRC2",PRCVRIL=$P(ADDSTR,U,5)
"RTN","PRCVRC2",211,0)
 . S XMB(1)="creating an entry in the DynaMed Audit File (#414.02)"
"RTN","PRCVRC2",212,0)
 . S XMB(2)=$P(ADDSTR,U)
"RTN","PRCVRC2",213,0)
 . S XMB(3)="unable to create Audit File entry"
"RTN","PRCVRC2",214,0)
 . S ^TMP($J,"PRCVRC2",1,0)="",PRCVP=1
"RTN","PRCVRC2",215,0)
 . S ^TMP($J,"PRCVRC2",2,0)="DynaMed Doc ID: "_$P(ADDSTR,U)
"RTN","PRCVRC2",216,0)
 . S ^TMP($J,"PRCVRC2",3,0)="Item #: "_$P(ADDSTR,U,2)
"RTN","PRCVRC2",217,0)
 . S ^TMP($J,"PRCVRC2",4,0)="Vendor #: "_$P(ADDSTR,U,3)
"RTN","PRCVRC2",218,0)
 . S ^TMP($J,"PRCVRC2",5,0)="User DUZ: "_$P(ADDSTR,U,4)
"RTN","PRCVRC2",219,0)
 . S ^TMP($J,"PRCVRC2",6,0)="RIL #: "_$P(ADDSTR,U,5)
"RTN","PRCVRC2",220,0)
 . S ^TMP($J,"PRCVRC2",7,0)="Message date/time: "_$P(ADDSTR,U,6)
"RTN","PRCVRC2",221,0)
 . S ^TMP($J,"PRCVRC2",8,0)="RIL create date: "_PRCVRIL
"RTN","PRCVRC2",222,0)
 . S ^TMP($J,"PRCVRC2",9,0)="Date Needed: "_$P(ADDSTR,U,8)
"RTN","PRCVRC2",223,0)
 . S ^TMP($J,"PRCVRC2",10,0)="Error: "_$G(^TMP("DIERR",$J,1,"TEXT",1))
"RTN","PRCVRC2",224,0)
 . S PRCVST=$P(PRCVRIL,"-"),PRCVFCP=$P(PRCVRIL,"-",4)
"RTN","PRCVRC2",225,0)
 . D DMERXMB^PRCVLIC(PRCVTMP,PRCVST,PRCVFCP)
"RTN","PRCVRC2",226,0)
 Q
"RTN","PRCVRC2",227,0)
 ;
"RTN","PRCVRE1")
0^3^B52916025^B52433723
"RTN","PRCVRE1",1,0)
PRCVRE1 ;WOIFO/VC-Transmit HL7 message to IFCAP for requisition received from DynaMed ; 11/3/04 3:13pm ; 5/6/05 3:43pm
"RTN","PRCVRE1",2,0)
 ;;5.1;IFCAP;**81,119**;Oct 20, 2000;Build 8
"RTN","PRCVRE1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","PRCVRE1",4,0)
 ;
"RTN","PRCVRE1",5,0)
 ;An exemption from the 245 character length standard for a variable
"RTN","PRCVRE1",6,0)
 ;   has been requested from the SACC for reading HL7 segments into
"RTN","PRCVRE1",7,0)
 ;   a single variable.  The limit is request to be 1K and if longer
"RTN","PRCVRE1",8,0)
 ;   than that the system will exit with an Application ACK reject.
"RTN","PRCVRE1",9,0)
 ;   Submitted 4/14/05.
"RTN","PRCVRE1",10,0)
 ;
"RTN","PRCVRE1",11,0)
 ;This routine processes messages from DynaMed to IFCAP to build a RIL
"RTN","PRCVRE1",12,0)
 ;
"RTN","PRCVRE1",13,0)
 ;HL("MID") - Message Control ID
"RTN","PRCVRE1",14,0)
 ;HL7DT - Today's date in HL7 format
"RTN","PRCVRE1",15,0)
 ;PRCDT - Date value
"RTN","PRCVRE1",16,0)
 ;ORC Segment will repeat for each item
"RTN","PRCVRE1",17,0)
 ;  PRCORD - Order control should be NW for new order - ORC-1
"RTN","PRCVRE1",18,0)
 ;  PRCFCP - Fund control Point - ORC-3
"RTN","PRCVRE1",19,0)
 ;  PRCDATE - Date and time item entered - ORC-9
"RTN","PRCVRE1",20,0)
 ;  PRCEMP - Enter by - ORC-10 DUZ^Lname^Fname^Approving Authority
"RTN","PRCVRE1",21,0)
 ;  PRCCC - Cost Center - ORC-17
"RTN","PRCVRE1",22,0)
 ;  PRCSITE - Site Code should be 516 - ORC-21
"RTN","PRCVRE1",23,0)
 ;RQD Segment will repeat for each item
"RTN","PRCVRE1",24,0)
 ;  PRCCTR - Item counter - RQD-1
"RTN","PRCVRE1",25,0)
 ;  PRCDOC - DynaMed Document number - unique per item - RQD-2
"RTN","PRCVRE1",26,0)
 ;  PRCITM - Item number $p1 of RQD-3
"RTN","PRCVRE1",27,0)
 ;  PRCQTY - Item quantity - RQD-5
"RTN","PRCVRE1",28,0)
 ;  PRCNEED - Date Needed - RQD-10
"RTN","PRCVRE1",29,0)
 ;RQ1 Segment one segment for each RQD segment
"RTN","PRCVRE1",30,0)
 ;  PRCCOST - Estimated Unit Cost - RQ1-1
"RTN","PRCVRE1",31,0)
 ;  PRCBOC -  BOC Number - RQ1-3
"RTN","PRCVRE1",32,0)
 ;  PRCVND - Vendor number - pointer to file 440 - RQ1-4
"RTN","PRCVRE1",33,0)
 ;  PRCNIF - National Item File number - RQ1-5
"RTN","PRCVRE1",34,0)
 ;PRCTYP - Repetitive Item List type - default to blank
"RTN","PRCVRE1",35,0)
 ;Message builds an ^XTMP to pass data to IFCAP RIL build routine.
"RTN","PRCVRE1",36,0)
 ; The first node is "PRCVRE*"+the Message Control ID. The next nodes
"RTN","PRCVRE1",37,0)
 ; are 0,1, and 2. The 0 node is the standard ^XTMP structure plus
"RTN","PRCVRE1",38,0)
 ; $H. The $H is used to measure transmission timing. The 1 node holds
"RTN","PRCVRE1",39,0)
 ; header data common to all detail items being transmitted. The 2
"RTN","PRCVRE1",40,0)
 ; node holds detail information about each item ordered in a counter
"RTN","PRCVRE1",41,0)
 ; sub-node.
"RTN","PRCVRE1",42,0)
 ; Under the 1 and 2 nodes are "ERR" subnodes that hold error 
"RTN","PRCVRE1",43,0)
 ; information about each item.  There can be multiple errors
"RTN","PRCVRE1",44,0)
 ; associated with each item, therefore there are multiple sub-nodes
"RTN","PRCVRE1",45,0)
 ; possible under each "ERR" node.
"RTN","PRCVRE1",46,0)
 ;Counters
"RTN","PRCVRE1",47,0)
 ;  PRCCNT, ACKCNT,PRCCC1,PRCFCP1,X,X1,X2,X8,X9,I,II,LL,ERRCNT
"RTN","PRCVRE1",48,0)
 ;ERRCOD - Error code from IFCAP
"RTN","PRCVRE1",49,0)
 ;ERRDAT - Error data from IFCAP
"RTN","PRCVRE1",50,0)
 ;ERRSTR - Error text from IFCAP
"RTN","PRCVRE1",51,0)
 ;ERRSUB - A substring of ERRSTR
"RTN","PRCVRE1",52,0)
 ;ERRS - Error substring from IFCAP
"RTN","PRCVRE1",53,0)
 ;SEVER - Error severity value - W or E
"RTN","PRCVRE1",54,0)
 ;TOT,TOTERR,TOTGOOD,TOTREC - Counters of errors returned to DM
"RTN","PRCVRE1",55,0)
 ;FLDNO - Field identified in an error message
"RTN","PRCVRE1",56,0)
 ;ERRVAL - ERROR FLAG
"RTN","PRCVRE1",57,0)
 ;ERRARY - Message Error array sent to Prosthetics
"RTN","PRCVRE1",58,0)
 ;ERRLOC - Location of error sent in ACK
"RTN","PRCVRE1",59,0)
 ;PRCCS, PRCFS, PRCRS - Field delimiters
"RTN","PRCVRE1",60,0)
 ;PRCNODE - Message segment identifier
"RTN","PRCVRE1",61,0)
 ;Temporary Globals
"RTN","PRCVRE1",62,0)
 ;  ^TMP("PRCVRIL",$J,"ACK") - Acknowledgement is ok
"RTN","PRCVRE1",63,0)
 ;  ^TMP("PRCVRIL",$J,"NAK") - Acknowledgement is not ok
"RTN","PRCVRE1",64,0)
 ;  ^TMP("HLA",$J) - Message array sent to DynaMed
"RTN","PRCVRE1",65,0)
 ;  ^XTMP("PRCVRE*"_Message Control ID,) - Data sent to IFCAP
"RTN","PRCVRE1",66,0)
 ;Temporary variables
"RTN","PRCVRE1",67,0)
 ;   TMP,MSGFLG,X, X1
"RTN","PRCVRE1",68,0)
 ;PRCHD - Array to hold map between HL7 and XTMP for Header info
"RTN","PRCVRE1",69,0)
 ;PRCDET - Array to hold map between HL7 and XTMP for Detail info
"RTN","PRCVRE1",70,0)
 ;PRCVERR - Array to hold error messages for MailMan
"RTN","PRCVRE1",71,0)
 ;PRCSUB - XTMP first node
"RTN","PRCVRE1",72,0)
 ;PRCSUB2 - Second $p of PRCSUB equal to Message Control ID
"RTN","PRCVRE1",73,0)
 ;PRCVRES - Return variable from GENACK - Note:this doesn't work.
"RTN","PRCVRE1",74,0)
 ;PRCVINDX - Index number into XTMP to keep track of number of items
"RTN","PRCVRE1",75,0)
 ;
"RTN","PRCVRE1",76,0)
 Q
"RTN","PRCVRE1",77,0)
 ;
"RTN","PRCVRE1",78,0)
BEGIN N PRCORD,DYNADATE,PRCDATE,PRCEMP,PRCSITE
"RTN","PRCVRE1",79,0)
 N PRCDOC,PRCITM,PRCQTY,PRCFCP,PRCCC
"RTN","PRCVRE1",80,0)
 N PRCCOST,PRCVND,PRCBOC,PRCNEED,PRCNIF
"RTN","PRCVRE1",81,0)
 N PRCSUB,PRCSUB2,PRCDT,PRCVINDX
"RTN","PRCVRE1",82,0)
 N ERRARY,PRCCS,PRCFS,PRCRS,PRCNODE,PRCNODE2
"RTN","PRCVRE1",83,0)
 N ACKCNT,NODE1,NODE2,PRCCTR,PRCCNT,PRCI,PRCJ,MID
"RTN","PRCVRE1",84,0)
 N X,X1,X2,X8,X9,XX,TMP,PRCCC1,PRCFCP1,LENVAL
"RTN","PRCVRE1",85,0)
 ; Fields used in PRCVREA are NEWed and KILLed here
"RTN","PRCVRE1",86,0)
 N MSG,MSGFLG,DOCID,ERRCNT,ERRCOD,ERRDAT,ERRS,ERRSTR,ERRSUB,FLDNO
"RTN","PRCVRE1",87,0)
 N I,IL,ERRTXT,I,II,III,J,SEVER,TOT,TOTERR,TOTGOOD,TOTREC
"RTN","PRCVRE1",88,0)
 N PRCDET,PRCHD,PRCVERR,MYRESULT,ERRLOC,PRCVRES
"RTN","PRCVRE1",89,0)
 D:'$D(U) DT^DICRW
"RTN","PRCVRE1",90,0)
 S PRCDT=$$NOW^XLFDT
"RTN","PRCVRE1",91,0)
 S HL7DT=$$FMTHL7^XLFDT(PRCDT),PRCDT=HL7DT
"RTN","PRCVRE1",92,0)
 S PRCSUB="PRCVRE*"_HL("MID") K ^XTMP(PRCSUB)
"RTN","PRCVRE1",93,0)
 D BUILD
"RTN","PRCVRE1",94,0)
 S PRCCNT=0
"RTN","PRCVRE1",95,0)
 S PRCFS=$G(HL("FS")),PRCCS=$E($G(HL("ECH"))),PRCRS=$E($G(HL("ECH")),2)
"RTN","PRCVRE1",96,0)
 D START
"RTN","PRCVRE1",97,0)
 D CLEANUP
"RTN","PRCVRE1",98,0)
 Q
"RTN","PRCVRE1",99,0)
 ;
"RTN","PRCVRE1",100,0)
START ;This will read the incoming message from DynaMed and build ^TMP
"RTN","PRCVRE1",101,0)
 ;
"RTN","PRCVRE1",102,0)
SETACK ; Set up information for the ACK or NAK
"RTN","PRCVRE1",103,0)
 ;
"RTN","PRCVRE1",104,0)
 K ^TMP("PRCVRIL",$J)
"RTN","PRCVRE1",105,0)
 S ^TMP("PRCVRIL",$J,"ACK",1)="MSA"_PRCFS_"AA"_PRCFS_HL("MID")
"RTN","PRCVRE1",106,0)
 S ^TMP("PRCVRIL",$J,"NAK",1)="MSA"_PRCFS_"AE"_PRCFS_HL("MID")
"RTN","PRCVRE1",107,0)
 S ^TMP("PRCVRIL",$J,"NAK",2)="ERR"_PRCFS
"RTN","PRCVRE1",108,0)
 S ACKCNT=2
"RTN","PRCVRE1",109,0)
 ;
"RTN","PRCVRE1",110,0)
 ;If this is not the right message quit
"RTN","PRCVRE1",111,0)
 ;
"RTN","PRCVRE1",112,0)
 I HL("MTN")'="OMN" D  Q
"RTN","PRCVRE1",113,0)
 .S $P(^TMP("PRCVRIL",$J,"NAK",ACKCNT),PRCFS,2)="Wrong Message Type: "_HL("MTN")
"RTN","PRCVRE1",114,0)
 .D NAKIT^PRCVREA
"RTN","PRCVRE1",115,0)
 I HL("ETN")'="O07" D  Q
"RTN","PRCVRE1",116,0)
 .S $P(^TMP("PRCVRIL",$J,"NAK",ACKCNT),PRCFS,2)="Wrong Event Type: "_HL("ETN")
"RTN","PRCVRE1",117,0)
 .D NAKIT^PRCVREA
"RTN","PRCVRE1",118,0)
 ;
"RTN","PRCVRE1",119,0)
 S ERRARY(1)="OK"
"RTN","PRCVRE1",120,0)
 ;
"RTN","PRCVRE1",121,0)
 ;Read the message and build the ^TMP global
"RTN","PRCVRE1",122,0)
 ;
"RTN","PRCVRE1",123,0)
 K ^TMP("PRCVRE",$J)
"RTN","PRCVRE1",124,0)
 S PRCI=""
"RTN","PRCVRE1",125,0)
 F PRCI=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","PRCVRE1",126,0)
 .S ^TMP("PRCVRE",$J,PRCSUB,PRCI)=HLNODE,PRCJ=0
"RTN","PRCVRE1",127,0)
 .F  S PRCJ=$O(HLNODE(PRCJ)) Q:'PRCJ  S ^TMP("PRCVRE",$J,PRCSUB,PRCI,PRCJ)=HLNODE(PRCJ)
"RTN","PRCVRE1",128,0)
 .I $E(HLNODE,1,3)="ORC" D
"RTN","PRCVRE1",129,0)
 ..S PRCFCP=$P(HLNODE,PRCFS,4),PRCCC=$P(HLNODE,PRCFS,18)
"RTN","PRCVRE1",130,0)
 ..S TMP($J,PRCFCP,PRCCC)=""
"RTN","PRCVRE1",131,0)
 ;
"RTN","PRCVRE1",132,0)
 ;Validate that there is only one FCP and CC
"RTN","PRCVRE1",133,0)
 S PRCFCP="",PRCFCP1=""
"RTN","PRCVRE1",134,0)
 ; Prevent PRCCC1 undefined   PRC*5.1*119
"RTN","PRCVRE1",135,0)
 S PRCCC1=""
"RTN","PRCVRE1",136,0)
 F X8=1:1 S PRCFCP=$O(TMP($J,PRCFCP)) Q:PRCFCP=""  D
"RTN","PRCVRE1",137,0)
 .S PRCFCP1=X8
"RTN","PRCVRE1",138,0)
 .S PRCCC=""
"RTN","PRCVRE1",139,0)
 .F X9=1:1 S PRCCC=$O(TMP($J,PRCFCP,PRCCC)) Q:PRCCC=""  D
"RTN","PRCVRE1",140,0)
 ..S PRCCC1=X9
"RTN","PRCVRE1",141,0)
 I (PRCFCP1>1)!(PRCCC1>1) D  Q
"RTN","PRCVRE1",142,0)
 .S $P(^TMP("PRCVRIL",$J,"NAK",2),PRCFS,2)="Message contains multiple FCP's or CC's: "_HL("ETN") D NAKIT^PRCVREA
"RTN","PRCVRE1",143,0)
 ;
"RTN","PRCVRE1",144,0)
PARSIT ;Read the ^TMP global and build the ^XTMP global to pass to IFCAP
"RTN","PRCVRE1",145,0)
 ;
"RTN","PRCVRE1",146,0)
 S PRCI=0,PRCJ=0,LENVAL="OK"
"RTN","PRCVRE1",147,0)
 F  S PRCI=$O(^TMP("PRCVRE",$J,PRCSUB,PRCI)) Q:PRCI=""  Q:LENVAL="NOTOK"  D
"RTN","PRCVRE1",148,0)
 .S NODE1=$G(^TMP("PRCVRE",$J,PRCSUB,PRCI)) Q:NODE1=""
"RTN","PRCVRE1",149,0)
 .F PRCJ=1:1 D  Q:$G(^TMP("PRCVRE",$J,PRCSUB,PRCI,PRCJ))=""
"RTN","PRCVRE1",150,0)
 ..S NODE2=$G(^TMP("PRCVRE",$J,PRCSUB,PRCI,PRCJ))
"RTN","PRCVRE1",151,0)
 ..I $L(NODE1)+$L(NODE2)>1024 S LENVAL="NOTOK" Q
"RTN","PRCVRE1",152,0)
 ..S NODE1=NODE1_NODE2
"RTN","PRCVRE1",153,0)
 .Q:LENVAL="NOTOK"
"RTN","PRCVRE1",154,0)
 .S PRCNODE=$E(NODE1,1,3)
"RTN","PRCVRE1",155,0)
 .;
"RTN","PRCVRE1",156,0)
 .; IF MSH segment ignore the record
"RTN","PRCVRE1",157,0)
 .;
"RTN","PRCVRE1",158,0)
 .I PRCNODE="MSH" Q
"RTN","PRCVRE1",159,0)
 .S PRCNODE2=$E(NODE1,5,$L(NODE1))
"RTN","PRCVRE1",160,0)
 .;
"RTN","PRCVRE1",161,0)
 .; If ORC segment process the record
"RTN","PRCVRE1",162,0)
 .;
"RTN","PRCVRE1",163,0)
 .I PRCNODE="ORC" D  Q
"RTN","PRCVRE1",164,0)
 ..I $D(^XTMP(PRCSUB,1))'=0 Q
"RTN","PRCVRE1",165,0)
 ..S PRCORD=$P(PRCNODE2,PRCFS,1),DYNADATE=$P(PRCNODE2,PRCFS,9),PRCEMP=$P($P(PRCNODE2,PRCFS,10),PRCCS,1,3),PRCSITE=$P(PRCNODE2,PRCFS,21)
"RTN","PRCVRE1",166,0)
 ..S PRCFCP=$P(PRCNODE2,PRCFS,3),PRCCC=$P(PRCNODE2,PRCFS,17)
"RTN","PRCVRE1",167,0)
 ..S PRCDATE=$$HL7TFM^XLFDT(DYNADATE)
"RTN","PRCVRE1",168,0)
 ..S $P(^XTMP(PRCSUB,1),U,1)=0
"RTN","PRCVRE1",169,0)
 ..S $P(^XTMP(PRCSUB,1),U,4)=PRCORD,$P(^XTMP(PRCSUB,1),U,5)=PRCSITE
"RTN","PRCVRE1",170,0)
 ..S $P(^XTMP(PRCSUB,1),U,6)=PRCDATE,$P(^XTMP(PRCSUB,1),U,7)=PRCEMP
"RTN","PRCVRE1",171,0)
 .;
"RTN","PRCVRE1",172,0)
 .; If RQD segment process the record
"RTN","PRCVRE1",173,0)
 .;
"RTN","PRCVRE1",174,0)
 .I PRCNODE="RQD" D  Q
"RTN","PRCVRE1",175,0)
 ..S PRCCTR=$P(PRCNODE2,PRCFS,1)
"RTN","PRCVRE1",176,0)
 ..S PRCDOC=$P(PRCNODE2,PRCFS,2),PRCITM=$P(PRCNODE2,PRCFS,3)
"RTN","PRCVRE1",177,0)
 ..S PRCQTY=$P(PRCNODE2,PRCFS,5),DYNADATE=$P(PRCNODE2,PRCFS,10)
"RTN","PRCVRE1",178,0)
 ..S PRCNEED=$$HL7TFM^XLFDT(DYNADATE)
"RTN","PRCVRE1",179,0)
 .;
"RTN","PRCVRE1",180,0)
 .;If RQ1 segment process the record and build the XTMP global record
"RTN","PRCVRE1",181,0)
 .;
"RTN","PRCVRE1",182,0)
 .I PRCNODE="RQ1" D  Q
"RTN","PRCVRE1",183,0)
 ..S PRCCOST=$P(PRCNODE2,PRCFS,1),PRCBOC=$P(PRCNODE2,PRCFS,3),PRCVND=$P(PRCNODE2,PRCFS,4),PRCNIF=$P(PRCNODE2,PRCFS,5)
"RTN","PRCVRE1",184,0)
 ..;
"RTN","PRCVRE1",185,0)
 ..; Now build the XTMP record
"RTN","PRCVRE1",186,0)
 ..;
"RTN","PRCVRE1",187,0)
 ..S PRCVINDX=$P($G(^XTMP(PRCSUB,1)),U,1)
"RTN","PRCVRE1",188,0)
 ..I PRCCTR>PRCVINDX S $P(^XTMP(PRCSUB,1),U,1)=PRCCTR
"RTN","PRCVRE1",189,0)
 ..S $P(^XTMP(PRCSUB,1),U,2)=PRCFCP
"RTN","PRCVRE1",190,0)
 ..S $P(^XTMP(PRCSUB,1),U,3)=PRCCC
"RTN","PRCVRE1",191,0)
 ..S ^XTMP(PRCSUB,2,PRCCTR)=PRCITM_U_PRCQTY_U_PRCVND_U_PRCCOST_U_PRCNEED_U_PRCDOC_U_PRCNIF_U_PRCBOC
"RTN","PRCVRE1",192,0)
 ;
"RTN","PRCVRE1",193,0)
 I LENVAL="NOTOK" D  Q
"RTN","PRCVRE1",194,0)
 .S $P(^TMP("PRCVRIL",$J,"NAK",2),PRCFS,2)="HL7 Segment length greater than 1K"
"RTN","PRCVRE1",195,0)
 .D NAKIT^PRCVREA
"RTN","PRCVRE1",196,0)
 .K ^XTMP(PRCSUB)
"RTN","PRCVRE1",197,0)
 D CALLIT^PRCVREA
"RTN","PRCVRE1",198,0)
 Q
"RTN","PRCVRE1",199,0)
 ;
"RTN","PRCVRE1",200,0)
BUILD ;Build the ^XTMP global zero node record.
"RTN","PRCVRE1",201,0)
 ;
"RTN","PRCVRE1",202,0)
 S XX=$$HTFM^XLFDT($H,1)
"RTN","PRCVRE1",203,0)
 S X1=$$FMADD^XLFDT(XX,5)
"RTN","PRCVRE1",204,0)
 S ^XTMP(PRCSUB,0)=X1_U_XX_"^Transmit message to IFCAP to build the RIL"_U_$H
"RTN","PRCVRE1",205,0)
 Q
"RTN","PRCVRE1",206,0)
 ;
"RTN","PRCVRE1",207,0)
CLEANUP ;This area will kill all temporary globals and variables
"RTN","PRCVRE1",208,0)
 ;
"RTN","PRCVRE1",209,0)
 K ^TMP("PRCVRE",$J),TMP($J)
"RTN","PRCVRE1",210,0)
 K ^TMP("HLA",$J)
"RTN","PRCVRE1",211,0)
 K ^TMP("PRCVRIL",$J)
"RTN","PRCVRE1",212,0)
 K PRCCTR,PRCCNT,PRCORD,DYNADATE,PRCDATE,PRCEMP,PRCSITE,PRCDOC
"RTN","PRCVRE1",213,0)
 K PRCITM,PRCQTY,PRCFCP,PRCCC,PRCNIF,PRCBOC
"RTN","PRCVRE1",214,0)
 K PRCCOST,PRCVND,PRCSUB,PRCSUB2,PRCDT,PRCNEED
"RTN","PRCVRE1",215,0)
 K PRCFS,PRCCS,PRCRS,PRCVINDX
"RTN","PRCVRE1",216,0)
 K ERRARY
"RTN","PRCVRE1",217,0)
 K PRCFS,PRCRS,PRCNODE,PRCNODE2,PRCI,PRCJ
"RTN","PRCVRE1",218,0)
 K ACKCNT,NODE1,NODE2,LENVAL
"RTN","PRCVRE1",219,0)
 K X,X1,X2,X8,X9,XX,TMP,PRCCC1,PRCFCP1
"RTN","PRCVRE1",220,0)
 ;Fields killed here are used in PRCVREA
"RTN","PRCVRE1",221,0)
 K MID,MSG,MSGFLG,MYRESULT,PRCDET,PRCHD,ERRLOC,ERRSUB
"RTN","PRCVRE1",222,0)
 K DOCID,ERRCNT,ERRCOD,ERRDAT,ERRS,ERRSTR,I,II,III,IL,J,ERRTXT,SEVER
"RTN","PRCVRE1",223,0)
 K TOT,TOTERR,TOTGOOD,TOTREC,FLDNO,PRCVERR,PRCVRES
"RTN","PRCVRE1",224,0)
 Q
"RTN","PRCVREA")
0^2^B24623450^B24071162
"RTN","PRCVREA",1,0)
PRCVREA ;WOIFO/VC-Transmit HL7 message to IFCAP for RIL(cont);11/24/03 ; 2/29/08 1:54pm
"RTN","PRCVREA",2,0)
 ;;5.1;IFCAP;**81,119**;Oct 20, 2000;Build 8
"RTN","PRCVREA",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","PRCVREA",4,0)
 ;
"RTN","PRCVREA",5,0)
CALLIT ;Call the IFCAP RIL build Routine
"RTN","PRCVREA",6,0)
 ;
"RTN","PRCVREA",7,0)
 D EN^PRCVRC1(PRCSUB)
"RTN","PRCVREA",8,0)
 ;
"RTN","PRCVREA",9,0)
SETUP S PRCHD(1)=""
"RTN","PRCVREA",10,0)
 ;Added 1,"T" node to stop crash
"RTN","PRCVREA",11,0)
 S PRCHD(1,"T")="ORDER HEADER INFO"
"RTN","PRCVREA",12,0)
 S PRCHD(2)="ORC"_PRCCS_PRCCS_3
"RTN","PRCVREA",13,0)
 S PRCHD(2,"T")="FUND CONTROL POINT"
"RTN","PRCVREA",14,0)
 S PRCHD(3)="ORC"_PRCCS_PRCCS_17
"RTN","PRCVREA",15,0)
 S PRCHD(3,"T")="COST CENTER"
"RTN","PRCVREA",16,0)
 S PRCHD(4)=""
"RTN","PRCVREA",17,0)
 S PRCHD(5)="ORC"_PRCCS_PRCCS_21
"RTN","PRCVREA",18,0)
 S PRCHD(5,"T")="SITE NUMBER"
"RTN","PRCVREA",19,0)
 S PRCHD(6)=""
"RTN","PRCVREA",20,0)
 S PRCHD(7)="ORC"_PRCCS_PRCCS_10
"RTN","PRCVREA",21,0)
 S PRCHD(7,"T")="DUZ"
"RTN","PRCVREA",22,0)
 S PRCHD(8)="ORC"_PRCCS_PRCCS_10
"RTN","PRCVREA",23,0)
 S PRCHD(8,"T")="LAST NAME"
"RTN","PRCVREA",24,0)
 S PRCHD(9)="ORC"_PRCCS_PRCCS_11
"RTN","PRCVREA",25,0)
 S PRCHD(9,"T")="FIRST NAME"
"RTN","PRCVREA",26,0)
 S PRCDET(1)="RQD"_PRCCS_PRCCS_3
"RTN","PRCVREA",27,0)
 S PRCDET(1,"T")="ITEM NUMBER"
"RTN","PRCVREA",28,0)
 S PRCDET(2)="RQD"_PRCCS_PRCCS_5
"RTN","PRCVREA",29,0)
 S PRCDET(2,"T")="QUANTITY"
"RTN","PRCVREA",30,0)
 S PRCDET(3)="RQ1"_PRCCS_PRCCS_4
"RTN","PRCVREA",31,0)
 S PRCDET(3,"T")="VENDOR ID"
"RTN","PRCVREA",32,0)
 S PRCDET(4)="RQ1"_PRCCS_PRCCS_1
"RTN","PRCVREA",33,0)
 S PRCDET(4,"T")="UNIT COST"
"RTN","PRCVREA",34,0)
 S PRCDET(5)="RQD"_PRCCS_PRCCS_10
"RTN","PRCVREA",35,0)
 S PRCDET(5,"T")="DATE NEEDED"
"RTN","PRCVREA",36,0)
 S PRCDET(6)="RQD"_PRCCS_PRCCS_2
"RTN","PRCVREA",37,0)
 S PRCDET(6,"T")="DYNAMED DOCUMENT ID"
"RTN","PRCVREA",38,0)
 S PRCDET(7)="RQ1"_PRCCS_PRCCS_5
"RTN","PRCVREA",39,0)
 S PRCDET(7,"T")="NIF NUMBER"
"RTN","PRCVREA",40,0)
 S PRCDET(8)="RQ1"_PRCCS_PRCCS_3
"RTN","PRCVREA",41,0)
 S PRCDET(8,"T")="BOC"
"RTN","PRCVREA",42,0)
 ;Check if IFCAP has returned any errors
"RTN","PRCVREA",43,0)
 ;
"RTN","PRCVREA",44,0)
 S ERRCNT=1
"RTN","PRCVREA",45,0)
 S PRCVERR(0)="0"
"RTN","PRCVREA",46,0)
HEAD ;If there are errors in the "1" sub-segment, add all errors to all
"RTN","PRCVREA",47,0)
 ;   line items
"RTN","PRCVREA",48,0)
 S ERRCNT=1,MSGFLG=0,PRCSUB2=$P(PRCSUB,"*",2)
"RTN","PRCVREA",49,0)
 I $D(^XTMP(PRCSUB,1,"ERR"))>0 D
"RTN","PRCVREA",50,0)
 .S II=0
"RTN","PRCVREA",51,0)
 .F I=1:1 S II=$O(^XTMP(PRCSUB,1,"ERR",II)) Q:II=""  D
"RTN","PRCVREA",52,0)
 ..S ERRDAT=$G(^XTMP(PRCSUB,1,"ERR",II))
"RTN","PRCVREA",53,0)
 ..Q:ERRDAT=""
"RTN","PRCVREA",54,0)
 ..S MSGFLG=1
"RTN","PRCVREA",55,0)
 ..S FLDNO=$P(ERRDAT,U,1),ERRCOD="PRCV"_$P(ERRDAT,U,2),ERRTXT=$P(ERRDAT,U,3)
"RTN","PRCVREA",56,0)
 ..S SEVER=$P(ERRDAT,U,4)
"RTN","PRCVREA",57,0)
 ..S ERRSTR="ERR"_PRCFS_PRCFS_PRCHD(FLDNO)_PRCFS_"207"_PRCCS_"Application internal error"_PRCCS_"HL70357"_PRCFS_SEVER_PRCFS_ERRCOD_PRCCS_ERRTXT_PRCFS
"RTN","PRCVREA",58,0)
 ..S PRCVERR(ERRCNT)="Error in Requisition Header for "_PRCHD(FLDNO,"T")_" from HL7 MESSAGE "_PRCSUB2_" "_ERRCOD_" "_ERRTXT,ERRCNT=ERRCNT+1
"RTN","PRCVREA",59,0)
 ..S J=0
"RTN","PRCVREA",60,0)
 ..F IL=1:1 S J=$O(^XTMP(PRCSUB,2,J)) Q:J=""  D
"RTN","PRCVREA",61,0)
 ...S ERRSUB=$P(ERRSTR,PRCFS,3)
"RTN","PRCVREA",62,0)
 ...S $P(ERRSUB,U,2)=J
"RTN","PRCVREA",63,0)
 ...S $P(ERRSTR,PRCFS,3)=ERRSUB
"RTN","PRCVREA",64,0)
 ...;S $P($P(ERRSTR,PRCFS,3),U,2)=J
"RTN","PRCVREA",65,0)
 ...S $P(ERRSTR,PRCFS,7)=$P($G(^XTMP(PRCSUB,2,J)),U,6)
"RTN","PRCVREA",66,0)
 ...S ^TMP("PRCVRIL",$J,"NAK",ACKCNT)=ERRSTR,ACKCNT=ACKCNT+1
"RTN","PRCVREA",67,0)
DETAIL ;If there are errors in the detail lines, add them
"RTN","PRCVREA",68,0)
 S II=0
"RTN","PRCVREA",69,0)
 F I=1:1 S II=$O(^XTMP(PRCSUB,2,II)) Q:II=""  D
"RTN","PRCVREA",70,0)
 .S DOCID=$P(^XTMP(PRCSUB,2,II),U,6)
"RTN","PRCVREA",71,0)
 .S III=0
"RTN","PRCVREA",72,0)
 .F J=1:1 S III=$O(^XTMP(PRCSUB,2,II,"ERR",III)) Q:III=""  D
"RTN","PRCVREA",73,0)
 ..S ERRDAT=$G(^XTMP(PRCSUB,2,II,"ERR",III))
"RTN","PRCVREA",74,0)
 ..Q:ERRDAT=""
"RTN","PRCVREA",75,0)
 ..S MSGFLG=1
"RTN","PRCVREA",76,0)
 ..S FLDNO=$P(ERRDAT,U,1),ERRCOD="PRCV"_$P(ERRDAT,U,2),ERRTXT=$P(ERRDAT,U,3)
"RTN","PRCVREA",77,0)
 ..S ERRLOC=PRCDET(FLDNO),$P(ERRLOC,U,2)=II
"RTN","PRCVREA",78,0)
 ..S SEVER=$P(ERRDAT,U,4)
"RTN","PRCVREA",79,0)
 ..S ERRSTR="ERR"_PRCFS_PRCFS_ERRLOC_PRCFS_"207"_PRCCS_"Application internal error"_PRCCS_"HL70357"_PRCFS_SEVER_PRCFS_ERRCOD_PRCCS_ERRTXT_PRCFS_DOCID
"RTN","PRCVREA",80,0)
 ..S ^TMP("PRCVRIL",$J,"NAK",ACKCNT)=ERRSTR,ACKCNT=ACKCNT+1
"RTN","PRCVREA",81,0)
 ..S PRCVERR(ERRCNT)="Error in detail for Message Control ID "_PRCSUB2_". Field in error - "_PRCDET(FLDNO,"T")_". "_ERRTXT_" DynaMed Doc ID "_DOCID
"RTN","PRCVREA",82,0)
 ..S ERRCNT=ERRCNT+1
"RTN","PRCVREA",83,0)
 ;
"RTN","PRCVREA",84,0)
 I MSGFLG=0 D ACKIT,CLEANUP^PRCVRE1 Q
"RTN","PRCVREA",85,0)
SETNTE ; If there are errors set an NTE segment
"RTN","PRCVREA",86,0)
 ;
"RTN","PRCVREA",87,0)
 S TOT=0,TOTREC=0,TOTERR=0
"RTN","PRCVREA",88,0)
 F I=1:1 S TOT=$O(^XTMP(PRCSUB,2,TOT)) Q:TOT=""  D
"RTN","PRCVREA",89,0)
 .S TOTREC=TOT
"RTN","PRCVREA",90,0)
 .I $D(^XTMP(PRCSUB,2,TOT,"ERR"))>0 D
"RTN","PRCVREA",91,0)
 ..S ERRS=0
"RTN","PRCVREA",92,0)
 ..F J=1:1 S ERRS=$O(^XTMP(PRCSUB,2,TOT,"ERR",ERRS)) Q:ERRS=""  D
"RTN","PRCVREA",93,0)
 ...S SEVER=$P($G(^XTMP(PRCSUB,2,TOT,"ERR",ERRS)),U,4)
"RTN","PRCVREA",94,0)
 ...I SEVER'="W" S TOTERR=TOTERR+1,ERRS=99
"RTN","PRCVREA",95,0)
 I $D(^XTMP(PRCSUB,2,"ERR",1))>1 S TOTERR=TOTREC
"RTN","PRCVREA",96,0)
 S TOTGOOD=TOTREC-TOTERR
"RTN","PRCVREA",97,0)
 S ^TMP("PRCVRIL",$J,"NAK",ACKCNT)="NTE"_PRCFS_PRCFS_PRCFS_TOTREC_"-"_TOTERR_"-"_TOTGOOD,ACKCNT=ACKCNT+1
"RTN","PRCVREA",98,0)
 D NAKIT,CLEANUP^PRCVRE1 Q
"RTN","PRCVREA",99,0)
 ;
"RTN","PRCVREA",100,0)
NAKIT ;Send an acknowledgement that the message is rejected
"RTN","PRCVREA",101,0)
 ;
"RTN","PRCVREA",102,0)
 I HL("APAT")'="AL" Q
"RTN","PRCVREA",103,0)
 S MSG=""
"RTN","PRCVREA",104,0)
 F I=1:1 S MSG=$O(^TMP("PRCVRIL",$J,"NAK",MSG)) Q:MSG=""  D
"RTN","PRCVREA",105,0)
 .S ^TMP("HLA",$J,I)=^TMP("PRCVRIL",$J,"NAK",MSG)
"RTN","PRCVREA",106,0)
 S PRCVRES=""
"RTN","PRCVREA",107,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"GM",1,.PRCVRES)
"RTN","PRCVREA",108,0)
 ;I +$P(PRCVRES,U,2) D
"RTN","PRCVREA",109,0)
 ;.S PRCVERR(ERRCNT)="Application ACK not processed. Contact EVS."
"RTN","PRCVREA",110,0)
MAIL ;Send MailMan message with error
"RTN","PRCVREA",111,0)
 Q:LENVAL="NOTOK"
"RTN","PRCVREA",112,0)
 N XMDUZ,XMMG,XMSUB,XMTEXT,XMY,XMZ
"RTN","PRCVREA",113,0)
 S XMSUB="RIL build errors in HL7 message "_HL("MID")_" "
"RTN","PRCVREA",114,0)
 S XMDUZ="IFCAP/DynaMed Interface"
"RTN","PRCVREA",115,0)
 S XMTEXT="PRCVERR("
"RTN","PRCVREA",116,0)
 D GETFCPU^PRCVLIC(.XMY,PRCSITE,PRCFCP)
"RTN","PRCVREA",117,0)
 D ^XMD
"RTN","PRCVREA",118,0)
 K XMDUZ,XMMG,XMSUB,XMTEXT,XMY,XMZ
"RTN","PRCVREA",119,0)
 Q
"RTN","PRCVREA",120,0)
 ;
"RTN","PRCVREA",121,0)
ACKIT ;Send an acknowledgement that everything went fine
"RTN","PRCVREA",122,0)
 ;
"RTN","PRCVREA",123,0)
 I HL("APAT")'="AL" Q
"RTN","PRCVREA",124,0)
 F I=1:1:1 S ^TMP("HLA",$J,I)=$G(^TMP("PRCVRIL",$J,"ACK",I))
"RTN","PRCVREA",125,0)
 ;
"RTN","PRCVREA",126,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"GM",1,.PRCVRES)
"RTN","PRCVREA",127,0)
 ;I +P(PRCVRES,U,2) D
"RTN","PRCVREA",128,0)
 ;.I $D(ERRCNT)=0 S ERRCNT=1
"RTN","PRCVREA",129,0)
 ;.S PRCVERR(ERRCNT)="Application ACK not processed. Contact EVS."
"RTN","PRCVREA",130,0)
 ;.D MAIL
"RTN","PRCVREA",131,0)
 Q
"VER")
8.0^22.0
"BLD",5782,6)
^101
**END**
**END**

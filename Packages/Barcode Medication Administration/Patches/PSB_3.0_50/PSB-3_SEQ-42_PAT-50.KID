Released PSB*3*50 SEQ #42
Extracted from mail message
**KIDS**:PSB*3.0*50^

**INSTALL NAME**
PSB*3.0*50
"BLD",8186,0)
PSB*3.0*50^BAR CODE MED ADMIN^0^3100907^y
"BLD",8186,1,0)
^^15^15^3100513^
"BLD",8186,1,1,0)
This patch addresses Patient Safety issue PSPO #1401 and three
"BLD",8186,1,2,0)
additional issues in Bar Code Medication Administration (BCMA):
"BLD",8186,1,3,0)
 
"BLD",8186,1,4,0)
 
"BLD",8186,1,5,0)
 
"BLD",8186,1,6,0)
1. PSPO #1401 - When a pain score is entered through BCMA and then marked 
"BLD",8186,1,7,0)
"entered in error" in Vitals, the errant pain score still shows on the 
"BLD",8186,1,8,0)
BCMA Coversheet and other reports.
"BLD",8186,1,9,0)
2. Receiving an error "Error - <UNDEFINED>SCANFAIL+9^PSBMLEN1" when 
"BLD",8186,1,10,0)
running the MANUAL MEDICATION ENTRY [PSB MED LOG NEW ENTRY] option.
"BLD",8186,1,11,0)
3. Receiving error "<SUBSCRIPT>EN+12^PSBOMH1" when running the Medication 
"BLD",8186,1,12,0)
Administration History (MAH) report when the nurse has given a medication 
"BLD",8186,1,13,0)
and does not have his/her initials in the NEW PERSON file (#200).
"BLD",8186,1,14,0)
4. The Medication Therapy report does not contain PRN Effectiveness 
"BLD",8186,1,15,0)
information.
"BLD",8186,4,0)
^9.64PA^^
"BLD",8186,6.3)
78
"BLD",8186,"KRN",0)
^9.67PA^779.2^20
"BLD",8186,"KRN",.4,0)
.4
"BLD",8186,"KRN",.401,0)
.401
"BLD",8186,"KRN",.402,0)
.402
"BLD",8186,"KRN",.403,0)
.403
"BLD",8186,"KRN",.5,0)
.5
"BLD",8186,"KRN",.84,0)
.84
"BLD",8186,"KRN",3.6,0)
3.6
"BLD",8186,"KRN",3.8,0)
3.8
"BLD",8186,"KRN",9.2,0)
9.2
"BLD",8186,"KRN",9.8,0)
9.8
"BLD",8186,"KRN",9.8,"NM",0)
^9.68A^14^12
"BLD",8186,"KRN",9.8,"NM",1,0)
PSBO^^0^B80519878
"BLD",8186,"KRN",9.8,"NM",2,0)
PSBCSUTL^^0^B132423549
"BLD",8186,"KRN",9.8,"NM",3,0)
PSBMLEN1^^0^B53149065
"BLD",8186,"KRN",9.8,"NM",4,0)
PSBOMH1^^0^B80229523
"BLD",8186,"KRN",9.8,"NM",5,0)
PSBVDLU3^^0^B91754867
"BLD",8186,"KRN",9.8,"NM",7,0)
PSBOCP^^0^B77940079
"BLD",8186,"KRN",9.8,"NM",9,0)
PSBOMT^^0^B88222978
"BLD",8186,"KRN",9.8,"NM",10,0)
PSBOML^^0^B33332484
"BLD",8186,"KRN",9.8,"NM",11,0)
PSBOCM^^0^B76599407
"BLD",8186,"KRN",9.8,"NM",12,0)
PSBOCM1^^0^B22801470
"BLD",8186,"KRN",9.8,"NM",13,0)
PSBOCE^^0^B78332113
"BLD",8186,"KRN",9.8,"NM",14,0)
PSBOCE1^^0^B14285420
"BLD",8186,"KRN",9.8,"NM","B","PSBCSUTL",2)

"BLD",8186,"KRN",9.8,"NM","B","PSBMLEN1",3)

"BLD",8186,"KRN",9.8,"NM","B","PSBO",1)

"BLD",8186,"KRN",9.8,"NM","B","PSBOCE",13)

"BLD",8186,"KRN",9.8,"NM","B","PSBOCE1",14)

"BLD",8186,"KRN",9.8,"NM","B","PSBOCM",11)

"BLD",8186,"KRN",9.8,"NM","B","PSBOCM1",12)

"BLD",8186,"KRN",9.8,"NM","B","PSBOCP",7)

"BLD",8186,"KRN",9.8,"NM","B","PSBOMH1",4)

"BLD",8186,"KRN",9.8,"NM","B","PSBOML",10)

"BLD",8186,"KRN",9.8,"NM","B","PSBOMT",9)

"BLD",8186,"KRN",9.8,"NM","B","PSBVDLU3",5)

"BLD",8186,"KRN",19,0)
19
"BLD",8186,"KRN",19.1,0)
19.1
"BLD",8186,"KRN",101,0)
101
"BLD",8186,"KRN",409.61,0)
409.61
"BLD",8186,"KRN",771,0)
771
"BLD",8186,"KRN",779.2,0)
779.2
"BLD",8186,"KRN",870,0)
870
"BLD",8186,"KRN",8989.51,0)
8989.51
"BLD",8186,"KRN",8989.52,0)
8989.52
"BLD",8186,"KRN",8994,0)
8994
"BLD",8186,"KRN","B",.4,.4)

"BLD",8186,"KRN","B",.401,.401)

"BLD",8186,"KRN","B",.402,.402)

"BLD",8186,"KRN","B",.403,.403)

"BLD",8186,"KRN","B",.5,.5)

"BLD",8186,"KRN","B",.84,.84)

"BLD",8186,"KRN","B",3.6,3.6)

"BLD",8186,"KRN","B",3.8,3.8)

"BLD",8186,"KRN","B",9.2,9.2)

"BLD",8186,"KRN","B",9.8,9.8)

"BLD",8186,"KRN","B",19,19)

"BLD",8186,"KRN","B",19.1,19.1)

"BLD",8186,"KRN","B",101,101)

"BLD",8186,"KRN","B",409.61,409.61)

"BLD",8186,"KRN","B",771,771)

"BLD",8186,"KRN","B",779.2,779.2)

"BLD",8186,"KRN","B",870,870)

"BLD",8186,"KRN","B",8989.51,8989.51)

"BLD",8186,"KRN","B",8989.52,8989.52)

"BLD",8186,"KRN","B",8994,8994)

"BLD",8186,"QDEF")
^^^^^^^^^^YES
"BLD",8186,"QUES",0)
^9.62^^
"BLD",8186,"REQB",0)
^9.611^1^1
"BLD",8186,"REQB",1,0)
PSB*3.0*51^2
"BLD",8186,"REQB","B","PSB*3.0*51",1)

"MBREQ")
0
"PKG",550,-1)
1^1
"PKG",550,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",550,20,0)
^9.402P^^
"PKG",550,22,0)
^9.49I^1^1
"PKG",550,22,1,0)
3.0^3040224^3040311^66481
"PKG",550,22,1,"PAH",1,0)
50^3100907
"PKG",550,22,1,"PAH",1,1,0)
^^15^15^3100907
"PKG",550,22,1,"PAH",1,1,1,0)
This patch addresses Patient Safety issue PSPO #1401 and three
"PKG",550,22,1,"PAH",1,1,2,0)
additional issues in Bar Code Medication Administration (BCMA):
"PKG",550,22,1,"PAH",1,1,3,0)
 
"PKG",550,22,1,"PAH",1,1,4,0)
 
"PKG",550,22,1,"PAH",1,1,5,0)
 
"PKG",550,22,1,"PAH",1,1,6,0)
1. PSPO #1401 - When a pain score is entered through BCMA and then marked 
"PKG",550,22,1,"PAH",1,1,7,0)
"entered in error" in Vitals, the errant pain score still shows on the 
"PKG",550,22,1,"PAH",1,1,8,0)
BCMA Coversheet and other reports.
"PKG",550,22,1,"PAH",1,1,9,0)
2. Receiving an error "Error - <UNDEFINED>SCANFAIL+9^PSBMLEN1" when 
"PKG",550,22,1,"PAH",1,1,10,0)
running the MANUAL MEDICATION ENTRY [PSB MED LOG NEW ENTRY] option.
"PKG",550,22,1,"PAH",1,1,11,0)
3. Receiving error "<SUBSCRIPT>EN+12^PSBOMH1" when running the Medication 
"PKG",550,22,1,"PAH",1,1,12,0)
Administration History (MAH) report when the nurse has given a medication 
"PKG",550,22,1,"PAH",1,1,13,0)
and does not have his/her initials in the NEW PERSON file (#200).
"PKG",550,22,1,"PAH",1,1,14,0)
4. The Medication Therapy report does not contain PRN Effectiveness 
"PKG",550,22,1,"PAH",1,1,15,0)
information.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","PSBCSUTL")
0^2^B132423549^B81338300
"RTN","PSBCSUTL",1,0)
PSBCSUTL ;BIRMINGHAM/TEJ- BCMA-HSC COVER SHEET UTILITIES ;Mar 2004
"RTN","PSBCSUTL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**16,13,38,32,50**;Mar 2004;Build 78
"RTN","PSBCSUTL",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBCSUTL",4,0)
 ;
"RTN","PSBCSUTL",5,0)
 ; Reference/IA
"RTN","PSBCSUTL",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBCSUTL",7,0)
 ; IN5^VADPT/10061
"RTN","PSBCSUTL",8,0)
 ; $$GET^XPAR/2263
"RTN","PSBCSUTL",9,0)
 ; ^%DTC/10000
"RTN","PSBCSUTL",10,0)
 ; $$FMADD^XLFDT/10103
"RTN","PSBCSUTL",11,0)
 ; $$GET1^DIQ/2056
"RTN","PSBCSUTL",12,0)
 ; EN1^GMVDCEXT/4251
"RTN","PSBCSUTL",13,0)
RPC(RESULTS,DFN,EXPWIN) ;
"RTN","PSBCSUTL",14,0)
 K RESULTS,^TMP("PSB",$J),^TMP("PSJ",$J)
"RTN","PSBCSUTL",15,0)
 S PSBXWIN=$G(EXPWIN,24)
"RTN","PSBCSUTL",16,0)
 S PSBTAB="CVRSHT"
"RTN","PSBCSUTL",17,0)
 N PSBCNT S PSBTRFL=0,PSBDFNX=DFN
"RTN","PSBCSUTL",18,0)
 D PAINCMT(DFN) ;;Correct Comment if Pain Score entered in BCMA was marked "Entered in Error" in Vitals. (PSB*3*50)
"RTN","PSBCSUTL",19,0)
 S RESULTS=$NAME(^TMP("PSB",$J,PSBTAB))
"RTN","PSBCSUTL",20,0)
 K ^TMP("PSB",$J,PSBTAB) S ^TMP("PSB",$J,PSBTAB,0)=1 D LIGHTS(PSBDFNX)
"RTN","PSBCSUTL",21,0)
 S ^TMP("PSB",$J,PSBTAB,0)=1,^TMP("PSB",$J,PSBTAB,1)=^TMP("PSB",$J,PSBTAB,1)
"RTN","PSBCSUTL",22,0)
 Q:$P(^TMP("PSB",$J,PSBTAB,1),U,4)=-1
"RTN","PSBCSUTL",23,0)
 D NOW^%DTC S PSBNOW=+$E(%,1,10),PSBDT=$P(%,".",1)
"RTN","PSBCSUTL",24,0)
 ;set range
"RTN","PSBCSUTL",25,0)
 S PSBWBEG=$$FMADD^XLFDT(PSBNOW,"",-PSBXWIN),PSBWEND=$$FMADD^XLFDT(PSBNOW,"",PSBXWIN)
"RTN","PSBCSUTL",26,0)
 S PSBTBEG=$$FMADD^XLFDT(PSBNOW,"",-12),PSBTEND=$$FMADD^XLFDT(PSBNOW,"",12)
"RTN","PSBCSUTL",27,0)
 S PSBWADM=$$GET^XPAR("DIV","PSB ADMIN BEFORE"),PSBMHBCK=$$GET^XPAR("ALL","PSB MED HIST DAYS BACK",,"B") I +PSBMHBCK=0 S PSBMHBCK=30
"RTN","PSBCSUTL",28,0)
 D NOW^%DTC S PSBWADM=$$FMADD^XLFDT(%,"","",+PSBWADM),PSBMHBCK=$$FMADD^XLFDT(%,-1*(PSBMHBCK))
"RTN","PSBCSUTL",29,0)
 ;use lst movemnt for API
"RTN","PSBCSUTL",30,0)
 S VAIP("D")="LAST" D IN5^VADPT S PSBTRDT=+VAIP(3),PSBTRTYP=$P(VAIP(2),U,2),PSBMVTYP=$P(VAIP(4),U,2) K VAIP
"RTN","PSBCSUTL",31,0)
 S PSBPTTR=$$GET^XPAR("DIV","PSB PATIENT TRANSFER") I PSBPTTR="" S PSBPTTR=72
"RTN","PSBCSUTL",32,0)
 D NOW^%DTC S PSBNTDT=$$FMADD^XLFDT(%,"",-PSBPTTR) I PSBNTDT'>PSBTRDT S PSBTRFL=1
"RTN","PSBCSUTL",33,0)
 S X1=$P(PSBNOW,"."),X2=-3 D C^%DTC
"RTN","PSBCSUTL",34,0)
 D EN^PSJBCMA(PSBDFNX,X,$S(PSBMHBCK<PSBWBEG:PSBMHBCK,PSBWBEG<PSBMHBCK:PSBWBEG,1:PSBMHBCK))
"RTN","PSBCSUTL",35,0)
 ;Devlop Outp
"RTN","PSBCSUTL",36,0)
 S PSBTBOUT=0
"RTN","PSBCSUTL",37,0)
 I ^TMP("PSJ",$J,1,0)>0 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBCSUTL",38,0)
 .S:(PSBTAB'="CVRSHT")&($G(^TMP("PSB",$J,"CVRSHT",2))>0) PSBTBOUT=1
"RTN","PSBCSUTL",39,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX),NOW^%DTC
"RTN","PSBCSUTL",40,0)
 .Q:PSBONX["P"  Q:(PSBOSP<PSBWBEG)&'(PSBONX["V")  ;in rnge?
"RTN","PSBCSUTL",41,0)
 .S (PSBREC,PSBONTAB)=""
"RTN","PSBCSUTL",42,0)
 .S $P(PSBREC,U,1)=PSBDFN ;Dfn
"RTN","PSBCSUTL",43,0)
 .S $P(PSBREC,U,2)=PSBONX ;OrdX 
"RTN","PSBCSUTL",44,0)
 .S $P(PSBREC,U,3)=PSBON ;Ord#
"RTN","PSBCSUTL",45,0)
 .S $P(PSBREC,U,4)=PSBOTYP ;v/u/p
"RTN","PSBCSUTL",46,0)
 .S $P(PSBREC,U,5)=PSBSCHT ;Schtyp
"RTN","PSBCSUTL",47,0)
 .S $P(PSBREC,U,6)=PSBSCH ;Sch
"RTN","PSBCSUTL",48,0)
 .S $P(PSBREC,U,7)=$S(PSBHSM:"HSM",PSBSM:"SM",1:"") ; slfmed
"RTN","PSBCSUTL",49,0)
 .S $P(PSBREC,U,8)=PSBOITX ;Drgnm
"RTN","PSBCSUTL",50,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ;Dose
"RTN","PSBCSUTL",51,0)
 .S $P(PSBREC,U,10)=PSBMR ;med route
"RTN","PSBCSUTL",52,0)
 .;Lst Gvn -AOIP xRef
"RTN","PSBCSUTL",53,0)
 .S (PSBCNT,PSBFLAG)=0,(Y,PSBSTUS)="" K PSBHSTA,PSBHSTAX
"RTN","PSBCSUTL",54,0)
 .F XZ=1:1:20 S Y=$O(^PSB(53.79,"AOIP",PSBDFN,PSBOIT,Y),-1),(PSBCNT,PSBFLAG)=0 Q:Y=""  D
"RTN","PSBCSUTL",55,0)
 ..S:Y>0 $P(PSBREC,U,11)=Y
"RTN","PSBCSUTL",56,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",PSBDFN,PSBOIT,Y,X),-1) Q:X=""  D
"RTN","PSBCSUTL",57,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9) S:$G(PSBSTUS)="" PSBSTUS="X" I (PSBSTUS'="N") S PSBFLAG=1,PSBHSTA(Y,$G(PSBSTUS))="ORIG"_U_X
"RTN","PSBCSUTL",58,0)
 ...D:PSBSTUS="N"
"RTN","PSBCSUTL",59,0)
 ....S ($P(PSBREC,U,11),Z)=""
"RTN","PSBCSUTL",60,0)
 ....F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBCSUTL",61,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",62,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",63,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R" D LAST^PSBVDLU1
"RTN","PSBCSUTL",64,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H" D LAST^PSBVDLU1
"RTN","PSBCSUTL",65,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M" D LAST^PSBVDLU1
"RTN","PSBCSUTL",66,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM" D LAST^PSBVDLU1
"RTN","PSBCSUTL",67,0)
 .....I PSBFLAG=1,'$D(PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))) S PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))=Z_U_X
"RTN","PSBCSUTL",68,0)
 .I $D(PSBHSTA) S $P(PSBREC,U,11)=$O(PSBHSTA(""),-1),PSBSTUS=$O(PSBHSTA($P(PSBREC,U,11),""),-1) M PSBHSTAX(PSBOIT)=PSBHSTA K PSBHSTA  ;last action date/time
"RTN","PSBCSUTL",69,0)
 .S $P(PSBREC,U,12)="" ;ien - below
"RTN","PSBCSUTL",70,0)
 .S $P(PSBREC,U,13)="" ;sttus - below
"RTN","PSBCSUTL",71,0)
 .S $P(PSBREC,U,14)="" ;admn dte - below
"RTN","PSBCSUTL",72,0)
 .S $P(PSBREC,U,15)=PSBOIT ;OI Pointer
"RTN","PSBCSUTL",73,0)
 .S $P(PSBREC,U,16)=PSBNJECT  ;njctble med route flag
"RTN","PSBCSUTL",74,0)
 .;Var dosg
"RTN","PSBCSUTL",75,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBCSUTL",76,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBCSUTL",77,0)
 .S:PSBDOSEF?1"CAP".E!(PSBDOSEF?1"TAB".E)!(PSBDOSEF="PATCH") $P(PSBREC,U,18)=PSBDOSEF ;DosgFrm
"RTN","PSBCSUTL",78,0)
 .D PSJ1^PSBVT(PSBDFN,PSBONX)
"RTN","PSBCSUTL",79,0)
 .S PSBPB=$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH)),PSBLVIV=0
"RTN","PSBCSUTL",80,0)
 .Q:PSBPB&(PSBOSP<PSBWBEG)
"RTN","PSBCSUTL",81,0)
 .S:(PSBONX["V"&'PSBPB) PSBLVIV=1
"RTN","PSBCSUTL",82,0)
 .S $P(PSBREC,U,19)=$S(PSBVNI]"":PSBVNI,PSBVNI']"":"***") ;VerfNrsInts
"RTN","PSBCSUTL",83,0)
 .S $P(PSBREC,U,20)=PSBSTUS S:$P(PSBREC,U,11)="" $P(PSBREC,U,20)=""  ;LstActn
"RTN","PSBCSUTL",84,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBCSUTL",85,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBCSUTL",86,0)
 .S $P(PSBREC,U,25)=0 I $G(PSBTRFL),$P(PSBREC,U,11)]"",$P(PSBREC,U,11)'<$G(PSBNTDT),$P(PSBREC,U,11)'>$G(PSBTRDT) S $P(PSBREC,U,25)=1
"RTN","PSBCSUTL",87,0)
 .S $P(PSBREC,U,26)=PSBOSP  ;OrdStpDt/Tm
"RTN","PSBCSUTL",88,0)
 .S $P(PSBREC,U,27)=$$LASTG($P(PSBREC,U,1),$P(PSBREC,U,15))
"RTN","PSBCSUTL",89,0)
 .S $P(PSBREC,U,28)=$S((PSBONX["U")&('PSBPB):1,PSBPB:2,(PSBONX["V")&'PSBPB:3,1:"")
"RTN","PSBCSUTL",90,0)
 .;get all Admn(s) - DD info.
"RTN","PSBCSUTL",91,0)
 .S (PSBDDS,PSBSOLS,PSBADDS,PSBFLAG)="0"
"RTN","PSBCSUTL",92,0)
 .I PSBLVIV D XFERBAGS^PSBCSUTY,LVIV^PSBCSUTY I $G(PSBEXPRD) S X1=$O(^TMP("PSB",$J,PSBTAB,""),-1) S:^TMP("PSB",$J,PSBTAB,X1)'="END" ^TMP("PSB",$J,PSBTAB,X1+1)="END" Q
"RTN","PSBCSUTL",93,0)
 .D GETADMX^PSBCSUTY
"RTN","PSBCSUTL",94,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBCSUTL",95,0)
 ..I $P(PSBDDA(Y),U,5)=$P(%,".") S PSBFLAG=1  ;drug nactvt
"RTN","PSBCSUTL",96,0)
 ..Q:$P(PSBDDA(Y),U,5)&($P(PSBDDA(Y),U,5)<%)  ;nactv
"RTN","PSBCSUTL",97,0)
 ..S:$P(PSBDDA(Y),U,4)="" $P(PSBDDA(Y),U,4)=1
"RTN","PSBCSUTL",98,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,4),$P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBCSUTL",99,0)
 .;OnCa O PRN
"RTN","PSBCSUTL",100,0)
 .I ("^O^OC^P^"[(U_PSBSCHT_U))!(PSBLVIV) D  S ($P(PSBREC,U,12),$P(PSBREC,U,14))=""  Q
"RTN","PSBCSUTL",101,0)
 ..S (PSBIENX,PSBGOT1)="",PSBADMTM="" F  S PSBADMTM=$O(^PSB(53.79,"AORDX",PSBDFNX,PSBONX,PSBADMTM)) Q:(PSBADMTM="")  D
"RTN","PSBCSUTL",102,0)
 ...Q:(PSBADMTM<PSBMHBCK)&'PSBLVIV
"RTN","PSBCSUTL",103,0)
 ...F  S PSBIENX=$O(^PSB(53.79,"AORDX",PSBDFNX,PSBONX,PSBADMTM,PSBIENX)) Q:PSBIENX=""  D
"RTN","PSBCSUTL",104,0)
 ....S $P(PSBREC,U,12)=PSBIENX,$P(PSBREC,U,14)=PSBADMTM,$P(PSBREC,U,23)=$$GET1^DIQ(53.79,PSBIENX_",","IV UNIQUE ID")
"RTN","PSBCSUTL",105,0)
 ....S PSBQRR=1 D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBADMTM,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",106,0)
 ..I ('+PSBGOT1)&(PSBOSP'<PSBWBEG) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",107,0)
 ..I ('+PSBGOT1)&($D(PSBADMX(PSBONX))) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT")
"RTN","PSBCSUTL",108,0)
 ..S PSBGLBX=$O(^TMP("PSB",$J,PSBTAB,""),-1) S:^TMP("PSB",$J,PSBTAB,PSBGLBX)'="END" ^TMP("PSB",$J,PSBTAB,PSBGLBX+1)="END"
"RTN","PSBCSUTL",109,0)
 .;cont - proces AdmnTm
"RTN","PSBCSUTL",110,0)
 .S (PSBYES,PSBODD,PSBYTF)=0 S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBCSUTL",111,0)
 .I PSBYES,PSBADST="" Q
"RTN","PSBCSUTL",112,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTF=1
"RTN","PSBCSUTL",113,0)
 .I PSBSCHT="C",PSBYTF="1",PSBADST="" Q
"RTN","PSBCSUTL",114,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBCSUTL",115,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBCSUTL",116,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBCSUTL",117,0)
 .S:PSBLVIV PSBYES=1
"RTN","PSBCSUTL",118,0)
 .I 'PSBYES,PSBFREQ<1 Q
"RTN","PSBCSUTL",119,0)
 .I (PSBADST="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1(PSBTAB) Q
"RTN","PSBCSUTL",120,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBCSUTL",121,0)
 .I PSBODD,PSBADST'="" Q
"RTN","PSBCSUTL",122,0)
 .S PSBDTX=PSBWBEG\1,PSBGOT1=0
"RTN","PSBCSUTL",123,0)
 .F PSBXX=1:1:2 D  S PSBDTX=$$FMADD^XLFDT(PSBDTX,"",24)  ;incrmnt 1 day!
"RTN","PSBCSUTL",124,0)
 ..F PSBY=1:1:$L(PSBADST,"-") Q:$P(PSBADST,"-",PSBY)=""  D
"RTN","PSBCSUTL",125,0)
 ...S PSB=+(PSBDTX_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBCSUTL",126,0)
 ...I (PSB'<PSBWBEG)&(PSB'>PSBWEND) D  ;wndow?
"RTN","PSBCSUTL",127,0)
 ....D:(PSB'<PSBOST)&(PSB<PSBOSP)    ;actv?
"RTN","PSBCSUTL",128,0)
 .....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ;dt?
"RTN","PSBCSUTL",129,0)
 ......D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",130,0)
 ...S PSB=+(PSBWEND\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBCSUTL",131,0)
 ...I (PSB'<PSBWBEG)&(PSB'>PSBWEND) D  ;wndow?
"RTN","PSBCSUTL",132,0)
 ....D:(PSB'<PSBOST)&(PSB<PSBOSP)    ;actv?
"RTN","PSBCSUTL",133,0)
 .....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ;dt?
"RTN","PSBCSUTL",134,0)
 ......D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",135,0)
 .I ('PSBGOT1)&(PSBOSP'<PSBWBEG) D ADD^PSBVDLU1(PSBREC,PSBOTXT,+(PSBWEND\1_"."_$P(PSBADST,"-")),PSBDDS,PSBSOLS,PSBADDS,"CVRSHT")
"RTN","PSBCSUTL",136,0)
 .K PSBSTUS
"RTN","PSBCSUTL",137,0)
 D EN^PSBVDLPA
"RTN","PSBCSUTL",138,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))]"" S PSBI1=$O(^TMP("PSB",$J,PSBTAB,""),-1) I ^TMP("PSB",$J,PSBTAB,PSBI1)'="END" S ^TMP("PSB",$J,PSBTAB,PSBI1+1)="END"
"RTN","PSBCSUTL",139,0)
 S ^TMP("PSB",$J,PSBTAB,0)=$O(^TMP("PSB",$J,PSBTAB,""),-1)
"RTN","PSBCSUTL",140,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))']"" S $P(^TMP("PSB",$J,PSBTAB,1),U,4)="-1^No orders To display on Coversheet"
"RTN","PSBCSUTL",141,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))]"" S $P(^TMP("PSB",$J,PSBTAB,1),U,4)="1^COVERSHEET DATA FOLLOWS" D ADD^PSBCSUTX
"RTN","PSBCSUTL",142,0)
 D CLEAN
"RTN","PSBCSUTL",143,0)
 Q
"RTN","PSBCSUTL",144,0)
LASTG(PSBPATPT,PSBOIPT) ;LstGvn-(inpt: DFN,OrItm IEN)
"RTN","PSBCSUTL",145,0)
 K PSBHSTG S Y="",LASTG="" F XZ=1:1:20 S Y=$O(^PSB(53.79,"AOIP",PSBPATPT,PSBOIPT,Y),-1),(PSBCNT,PSBFLAG)=0 Q:Y=""  D
"RTN","PSBCSUTL",146,0)
 .S:Y>0 LASTG="",X="" F  S X=$O(^PSB(53.79,"AOIP",PSBPATPT,PSBOIPT,Y,X),-1) Q:X=""  D
"RTN","PSBCSUTL",147,0)
 ..S PSBSTX=$P(^PSB(53.79,X,0),U,9) S:PSBSTX']"" PSBHSTG(Y)=-1 I PSBSTX="G"  S PSBHSTG(Y)="G"
"RTN","PSBCSUTL",148,0)
 ..Q:PSBSTX="N"
"RTN","PSBCSUTL",149,0)
 ..D:(PSBSTX'="G")
"RTN","PSBCSUTL",150,0)
 ...S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBCSUTL",151,0)
 ....I (PSBDATA["Set to 'GIVEN'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",152,0)
 ....I (PSBDATA["STATUS 'GIVEN'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",153,0)
 ....I PSBCNT#2=0,PSBDATA'["'GIVEN'" Q
"RTN","PSBCSUTL",154,0)
 ....I '$D(PSBHSTG($P(PSBDATA,U))) S PSBFLAG=1,PSBHSTG($P(PSBDATA,U))=""
"RTN","PSBCSUTL",155,0)
 I $D(PSBHSTG) S LASTG="" F  S LASTG=$O(PSBHSTG(LASTG),-1) Q:+LASTG=0  Q:PSBHSTG(LASTG)="G"  I PSBHSTG(LASTG)=-1 S LASTG="" Q
"RTN","PSBCSUTL",156,0)
 Q LASTG
"RTN","PSBCSUTL",157,0)
PAINCMT(DFN) ;;Add comment if Pain Score entered in BCMA was marked "Entered in Error" in Vitals.
"RTN","PSBCSUTL",158,0)
 ;;This will run through all the patients appointments, check their comments to see if they had a Pain Vital entered  through BCMA, and check if that Vital was marked "Entered in Error."
"RTN","PSBCSUTL",159,0)
 Q:'$D(^DPT(DFN,0))
"RTN","PSBCSUTL",160,0)
 N PSBCMT,PSBGMR,PSBCMTGLB,PSBIEN,PSBCMTM,PSBVITM,PSBTMDF,PSBBDT,PSBEDT,PSBEFTM,PSBCMFL,PSBEXTM,PSBERFL,PSBPNSC,PSBNOW,PSBDFN,PSBPRNDT,PSBSTRTDT,PSBMDHST,PSBEFFL,PSBCOMMENT,X,X1,X2
"RTN","PSBCSUTL",161,0)
 K ^TMP("PSBGMV",$J)
"RTN","PSBCSUTL",162,0)
 D NOW^%DTC S PSBEDT=%
"RTN","PSBCSUTL",163,0)
 S PSBMDHST=+($$GET^XPAR("ALL","PSB MED HIST DAYS BACK",,"B")) S:+$G(PSBMDHST)=0 PSBMDHST=30
"RTN","PSBCSUTL",164,0)
 S X1=$P(PSBEDT,"."),X2=-(PSBMDHST) D C^%DTC S PSBMDHST=X
"RTN","PSBCSUTL",165,0)
 S PSBSTRTDT=$S($G(PSBSTRT)]0:PSBSTRT,1:PSBMDHST)
"RTN","PSBCSUTL",166,0)
 S PSBPRNDT=PSBSTRTDT F  S PSBPRNDT=$O(^PSB(53.79,"APRN",DFN,PSBPRNDT)) Q:'PSBPRNDT  D
"RTN","PSBCSUTL",167,0)
 .S PSBIEN=0 F  S PSBIEN=$O(^PSB(53.79,"APRN",DFN,PSBPRNDT,PSBIEN)) Q:'PSBIEN  D
"RTN","PSBCSUTL",168,0)
 ..S PSBCMT=0 F  S PSBCMT=$O(^PSB(53.79,PSBIEN,.3,PSBCMT)) Q:'PSBCMT  S PSBCMTGLB=^PSB(53.79,PSBIEN,.3,PSBCMT,0) D
"RTN","PSBCSUTL",169,0)
 ...I $P($G(PSBCMTGLB),U)["Pain Score of" D
"RTN","PSBCSUTL",170,0)
 ....I $E($P($G(PSBCMTGLB),U),1,14)="*Pain Score of" S PSBCMFL=""
"RTN","PSBCSUTL",171,0)
 ....I $E($P($G(PSBCMTGLB),U),1,15)="**Pain Score of" S PSBEFFL=""
"RTN","PSBCSUTL",172,0)
 ....S PSBCMTM=$P($G(PSBCMTGLB),U,3)
"RTN","PSBCSUTL",173,0)
 ....S PSBBDT=$E(PSBCMTM,1,12)
"RTN","PSBCSUTL",174,0)
 ....S PSBEXTM=$$FMTE^XLFDT(PSBBDT,"5Z")
"RTN","PSBCSUTL",175,0)
 ....I '$D(^TMP("PSBGMV",$J)) D EN1^GMVDCEXT("^TMP(""PSBGMV"",$J)",DFN,2,,1,PSBSTRTDT,PSBEDT,,1)
"RTN","PSBCSUTL",176,0)
 ....S PSBGMR=0 F  S PSBGMR=$O(^TMP("PSBGMV",$J,PSBGMR)) Q:PSBGMR=""  I $P(^TMP("PSBGMV",$J,PSBGMR),U,4)="PN" D
"RTN","PSBCSUTL",177,0)
 .....S PSBVITM=$P(^TMP("PSBGMV",$J,PSBGMR),U,5)
"RTN","PSBCSUTL",178,0)
 .....S PSBTMDF=$$FMDIFF^XLFDT(PSBVITM,PSBCMTM,2)
"RTN","PSBCSUTL",179,0)
 .....I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3) D
"RTN","PSBCSUTL",180,0)
 ......I $P(^TMP("PSBGMV",$J,PSBGMR),U,9)=1 S PSBPNSC=$P(^TMP("PSBGMV",$J,PSBGMR),U,8),PSBERFL=""
"RTN","PSBCSUTL",181,0)
 ..I $D(PSBERFL),'$D(PSBCMFL) S PSBCOMMENT="*Pain Score of "_PSBPNSC_" entered in Vitals via BCMA at "_PSBEXTM_" may have been marked 'Entered in Error'. See Vitals Package for an updated Score." D COMMENT^PSBML(PSBIEN,PSBCOMMENT)
"RTN","PSBCSUTL",182,0)
 ..K PSBCMFL,PSBERFL
"RTN","PSBCSUTL",183,0)
 ..S PSBEFTM=$P($G(^PSB(53.79,PSBIEN,.2)),U,4) Q:PSBEFTM=""
"RTN","PSBCSUTL",184,0)
 ..S PSBBDT=$E(PSBEFTM,1,12)
"RTN","PSBCSUTL",185,0)
 ..S PSBEXTM=$$FMTE^XLFDT(PSBBDT,"5Z")
"RTN","PSBCSUTL",186,0)
 ..D:'$D(^TMP("PSBGMV",$J)) EN1^GMVDCEXT("^TMP(""PSBGMV"",$J)",DFN,2,,1,PSBSTRTDT,PSBEDT,,1)
"RTN","PSBCSUTL",187,0)
 ..S PSBGMR=0 F  S PSBGMR=$O(^TMP("PSBGMV",$J,PSBGMR)) Q:PSBGMR=""  I $P(^TMP("PSBGMV",$J,PSBGMR),U,4)="PN" D
"RTN","PSBCSUTL",188,0)
 ...S PSBVITM=$P(^TMP("PSBGMV",$J,PSBGMR),U,5)
"RTN","PSBCSUTL",189,0)
 ...S PSBTMDF=$$FMDIFF^XLFDT(PSBVITM,PSBEFTM,2)
"RTN","PSBCSUTL",190,0)
 ...I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3)  D
"RTN","PSBCSUTL",191,0)
 ....I $P(^TMP("PSBGMV",$J,PSBGMR),U,9)=1 S PSBPNSC=$P(^TMP("PSBGMV",$J,PSBGMR),U,8),PSBERFL=""
"RTN","PSBCSUTL",192,0)
 ..I $D(PSBERFL),'$D(PSBEFFL) S PSBCOMMENT="**Pain Score of "_PSBPNSC_" entered in Vitals via BCMA at "_PSBEXTM_" may have been marked 'Entered in Error'. See Vitals Package for an updated Score." D COMMENT^PSBML(PSBIEN,PSBCOMMENT)
"RTN","PSBCSUTL",193,0)
 ..K PSBERFL,PSBEFFL
"RTN","PSBCSUTL",194,0)
 K ^TMP("PSBGMV",$J)
"RTN","PSBCSUTL",195,0)
 Q
"RTN","PSBCSUTL",196,0)
LIGHTS(PSBDFN) ;
"RTN","PSBCSUTL",197,0)
 D RPC^PSBVDLTB(,PSBDFN,"NO TAB",) S PSBTAB="CVRSHT"
"RTN","PSBCSUTL",198,0)
 M ^TMP("PSB",$J,PSBTAB,1)=^TMP("PSB",$J,"NO TAB",1) K ^TMP("PSB",$J,"NO TAB")
"RTN","PSBCSUTL",199,0)
 Q
"RTN","PSBCSUTL",200,0)
CLEAN ;
"RTN","PSBCSUTL",201,0)
 D CLEAN^PSBVT
"RTN","PSBCSUTL",202,0)
 K PSBACT,PSBACTBY,PSBACTDT,PSBACTPT,PSBADDS,PSBBAGID,PSBCHDT,PSBCHKV,PSBCNT1,PSBCNT2,PSBDDS,PSBDFNX,PSBWEND
"RTN","PSBCSUTL",203,0)
 K PSBDT,PSBFLAG,PSBHSTAX,PSBI1,PSBIEN,PSBIENX,PSBLSTS,PSBMAUD,PSBMVTYP,PSBMWC,PSBNOW,PSBNTDT,PSBONMBR,PSBY,PSBXX
"RTN","PSBCSUTL",204,0)
 K PSBONXS,PSBORREC,PSBPDT,PSBPRNRE,PSBPTTR,PSBQR,PSBRDOW,PSBREC,PSBRECHD,PSBSCHBR,PSBSCHTM,PSBSOLS,PSBTAB,PSBADMTM,PSBDTX
"RTN","PSBCSUTL",205,0)
 K PSBTBOUT,PSBTRDT,PSBTRFL,PSBTRTYP,PSBUID,PSBUIDS,PSBX,PSBXIEN,PSBX2,PSBYEA,PSBYEA1,PSBYTF,PSBYES,VAIP,PSBWADM,PSBWBEG
"RTN","PSBCSUTL",206,0)
 K PSBXREC,PSBGOT1,PSBCDT,PSBQUIT,PSBUSED,PSBLST4X,PSBADMX,PSBI2,PSBXXX,PSBI,PSBPB,PSBSHWTB,PSBONTAB,PSBDONE,^TMP("PSJ",$J)
"RTN","PSBCSUTL",207,0)
 K PSBNXTDU,LASTG,LSTTIME,PSBMHBCK,PSBHSTG,PSBNXTDT,NEXTADM,PSBLVIV
"RTN","PSBCSUTL",208,0)
 Q
"RTN","PSBMLEN1")
0^3^B53149065^B51812368
"RTN","PSBMLEN1",1,0)
PSBMLEN1 ;BIRMINGHAM/EFC-BCMA MEDICATION LOG FUNCTIONS ;Mar 2004
"RTN","PSBMLEN1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,4,9,11,13,28,50**;Mar 2004;Build 78
"RTN","PSBMLEN1",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBMLEN1",4,0)
 ;
"RTN","PSBMLEN1",5,0)
 ; Reference/IA
"RTN","PSBMLEN1",6,0)
 ; ENE^PSJBCMA4/3416
"RTN","PSBMLEN1",7,0)
 ;
"RTN","PSBMLEN1",8,0)
NEW(Y) ; Create the new entry
"RTN","PSBMLEN1",9,0)
 N PSBREC,PSB,PSBADST,PSBFREQ
"RTN","PSBMLEN1",10,0)
 S PSBMMEN=1
"RTN","PSBMLEN1",11,0)
 W @IOF D CLEAN^PSBVT,PSJ1^PSBVT(DFN,Y)
"RTN","PSBMLEN1",12,0)
 D NOW^%DTC
"RTN","PSBMLEN1",13,0)
 I PSBOSP<% D  Q:%'=1
"RTN","PSBMLEN1",14,0)
 .W @IOF,$C(7)
"RTN","PSBMLEN1",15,0)
 .W !,"NOTICE: This order is NOT currently active."
"RTN","PSBMLEN1",16,0)
 .W !,"        Are You Sure You Want To Continue"
"RTN","PSBMLEN1",17,0)
 .S %=2 D YN^DICN
"RTN","PSBMLEN1",18,0)
 I PSBADST="" S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX),PSBADST=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBDT)
"RTN","PSBMLEN1",19,0)
 E  K ^TMP("PSB",$J,"GETADMIN") S ^TMP("PSB",$J,"GETADMIN",0)=PSBADST
"RTN","PSBMLEN1",20,0)
 S PSBODSCH=0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODSCH=1
"RTN","PSBMLEN1",21,0)
 W !,"Order:       ",PSBONX
"RTN","PSBMLEN1",22,0)
 W !,"Medication:  ",PSBOITX
"RTN","PSBMLEN1",23,0)
 W !,"Dosage:      ",PSBDOSE
"RTN","PSBMLEN1",24,0)
 W !,"Schedule:    ",PSBSCH
"RTN","PSBMLEN1",25,0)
 W !,"Admin Times: ",$S(PSBODSCH:"(Odd Sched.)",1:PSBADST)
"RTN","PSBMLEN1",26,0)
 I $D(^XUSEC("PSB READ ONLY",DUZ)) D  Q
"RTN","PSBMLEN1",27,0)
 .W !!,"Medications CANNOT be administered while in PSB READ ONLY mode.",!! R "Press ENTER KEY to continue. ",PSBCNTNU:5
"RTN","PSBMLEN1",28,0)
 W !!,"Is this the correct Order" S %=1 D YN^DICN Q:%'=1
"RTN","PSBMLEN1",29,0)
 ;
"RTN","PSBMLEN1",30,0)
 ; PRN, One-Time, On Call orders
"RTN","PSBMLEN1",31,0)
 ;
"RTN","PSBMLEN1",32,0)
 I PSBSCHT'="C" D
"RTN","PSBMLEN1",33,0)
 .D VAL^PSBMLVAL(.PSB,DFN,+PSBONX,$E(PSBONX,$L(PSBONX)))
"RTN","PSBMLEN1",34,0)
 .I PSBSCHT="P",($D(PSB(1))) W !!,"Brief Administration History:  ",! S X=$O(PSB(" "),-1),X=$S(X>4:4,1:X) F I=1:1:X W !,?5,PSB(I)
"RTN","PSBMLEN1",35,0)
 .I $D(^XUSEC("PSB READ ONLY",DUZ)) W !,"This operation is NOT AVAILABLE in PSB READ ONLY mode.",! Q
"RTN","PSBMLEN1",36,0)
 .I ($D(^XUSEC("PSB STUDENT",DUZ))),('$D(^XUSEC("PSB INSTRUCTOR"))) W !,"This operation is NOT AVAILABLE in PSB READ ONLY mode.",! Q
"RTN","PSBMLEN1",37,0)
 .W !!,"Create an administration for this order" S %=1 D YN^DICN Q:%'=1
"RTN","PSBMLEN1",38,0)
 .I PSBSCHT="P" D  Q:Y=""!(Y["^")
"RTN","PSBMLEN1",39,0)
 ..K DIR S DIR(0)="FB^1:30",DIR("A")="PRN Reason (1-30 characters)"
"RTN","PSBMLEN1",40,0)
 ..W !!,"NOTICE: PRN Reason is Required for ALL PRN Entries",!
"RTN","PSBMLEN1",41,0)
 ..D ^DIR
"RTN","PSBMLEN1",42,0)
 ..I Y=""!(Y["^") W !!,"Sorry, Reason is required, No Entry Made!" Q
"RTN","PSBMLEN1",43,0)
 ..S PSBREC(6)=$P(Y,"|")
"RTN","PSBMLEN1",44,0)
 .; Build the form of dosage to CAP or TAB or null
"RTN","PSBMLEN1",45,0)
 .S:(PSBDOSEF'?1"CAP".E)&(PSBDOSEF'?1"TAB".E)&(PSBDOSEF'?1"PATCH".E) PSBDOSEF=""
"RTN","PSBMLEN1",46,0)
 .; Build the variable dose check #####-#####MG
"RTN","PSBMLEN1",47,0)
 .S PSBVARD=$S(PSBDOSE?1.5N1"-"1.5N.E:1,1:0)
"RTN","PSBMLEN1",48,0)
 .S PSBREC(0)=DFN
"RTN","PSBMLEN1",49,0)
 .S PSBREC(1)=PSBONX
"RTN","PSBMLEN1",50,0)
 .S PSBREC(2)=PSBSCHT
"RTN","PSBMLEN1",51,0)
 .S PSBREC(3)="G"
"RTN","PSBMLEN1",52,0)
 .S PSBREC(4)=PSBOIT
"RTN","PSBMLEN1",53,0)
 .S PSBREC(5)=""
"RTN","PSBMLEN1",54,0)
 .S PSBREC(7)="Entry created with 'Manual Medication Entry' option."
"RTN","PSBMLEN1",55,0)
 .S PSBREC(8)=""
"RTN","PSBMLEN1",56,0)
 .S PSBREC(9)=$S(PSBONX["U":"UDTAB",1:"PBTAB")
"RTN","PSBMLEN1",57,0)
 .S PSBINDX=10
"RTN","PSBMLEN1",58,0)
 .S X="" F  S X=$O(PSBDDA(X)) Q:X=""  S PSBREC(PSBINDX)=$P(PSBDDA(X),U,1,2)_U_$P(PSBDDA(X),U,4)_U_$P(PSBDDA(X),U,4)_U_PSBDOSEF,PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",59,0)
 .S X="" F  S X=$O(PSBADA(X)) Q:X=""  S PSBREC(PSBINDX)=PSBADA(X),PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",60,0)
 .S X="" F  S X=$O(PSBSOLA(X)) Q:X=""  S PSBREC(PSBINDX)=PSBSOLA(X),PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",61,0)
 .D FILE
"RTN","PSBMLEN1",62,0)
 .I $G(DA),PSBREC(2)="O",$D(^PSB(53.79,DA)) I $P(^PSB(53.79,DA,0),U,9)="G" D ENE^PSJBCMA4(PSBREC(0),PSBREC(1))
"RTN","PSBMLEN1",63,0)
 ;
"RTN","PSBMLEN1",64,0)
 ; Continuous Meds
"RTN","PSBMLEN1",65,0)
 ;
"RTN","PSBMLEN1",66,0)
 I PSBSCHT="C" D
"RTN","PSBMLEN1",67,0)
 .W ! S %DT="AEQ",%DT("A")="Enter the DATE the medication was administered: "
"RTN","PSBMLEN1",68,0)
 .D NOW^%DTC S %DT(0)=(-1)*X,%DT("B")="" D ^%DT K %DT(0) Q:Y<1  S PSBDTX=Y D D^DIQ
"RTN","PSBMLEN1",69,0)
 .S:PSBODSCH PSBSCTMX=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBDTX)
"RTN","PSBMLEN1",70,0)
 .F PSBXX=0:1 Q:$G(^TMP("PSB",$J,"GETADMIN",PSBXX))=""  D
"RTN","PSBMLEN1",71,0)
 ..S X="",Y=$G(^TMP("PSB",$J,"GETADMIN",PSBXX))
"RTN","PSBMLEN1",72,0)
 ..F Z=1:1:$L(Y,"-") S X=X_$S(X]"":";",1:"")_Z_":"_$P(Y,"-",Z)
"RTN","PSBMLEN1",73,0)
 .I PSBODSCH,PSBSCTMX="" D  Q
"RTN","PSBMLEN1",74,0)
 ..W !!,"Order "_PSBONX_" is NOT SCHEDULED for administration on that entered date."
"RTN","PSBMLEN1",75,0)
 ..K DIR S DIR(0)="E^" D ^DIR
"RTN","PSBMLEN1",76,0)
 .K DIR S DIR(0)="S^"_X,DIR("A")="Select Administration Time"
"RTN","PSBMLEN1",77,0)
 .D ^DIR Q:Y<1
"RTN","PSBMLEN1",78,0)
 .S PSBDTX=+(PSBDTX_"."_Y(0))
"RTN","PSBMLEN1",79,0)
 .S Y=PSBDTX D D^DIQ
"RTN","PSBMLEN1",80,0)
 .W !!,"Create an administration for ",Y S %=1 D YN^DICN  Q:%'=1
"RTN","PSBMLEN1",81,0)
FORUM .; Build the form of dosage to CAP or TAB or null
"RTN","PSBMLEN1",82,0)
 .S PSBDOSEF=PSBDOSEF
"RTN","PSBMLEN1",83,0)
 .S:(PSBDOSEF'?1"CAP".E)&(PSBDOSEF'?1"TAB".E)&(PSBDOSEF'?1"PATCH".E) PSBDOSEF=""
"RTN","PSBMLEN1",84,0)
 .; Build the variable dose check #####-#####MG
"RTN","PSBMLEN1",85,0)
 .S PSBVARD=$S(PSBDOSE?1.5N1"-"1.5N.E:1,1:0)
"RTN","PSBMLEN1",86,0)
 .S PSBREC(0)=DFN
"RTN","PSBMLEN1",87,0)
 .S PSBREC(1)=PSBONX
"RTN","PSBMLEN1",88,0)
 .S PSBREC(2)=PSBSCHT
"RTN","PSBMLEN1",89,0)
 .S PSBREC(3)="G"
"RTN","PSBMLEN1",90,0)
 .S PSBREC(4)=PSBOIT
"RTN","PSBMLEN1",91,0)
 .S PSBREC(5)=PSBDTX
"RTN","PSBMLEN1",92,0)
 .S PSBREC(6)=""
"RTN","PSBMLEN1",93,0)
 .S PSBREC(7)="Entry created with 'Manual Medication Entry' option."
"RTN","PSBMLEN1",94,0)
 .S PSBREC(8)=""
"RTN","PSBMLEN1",95,0)
 .S PSBREC(9)=$S(PSBONX["U":"UDTAB",1:"PBTAB")
"RTN","PSBMLEN1",96,0)
 .S PSBINDX=10
"RTN","PSBMLEN1",97,0)
 .S X="" F  S X=$O(PSBDDA(X)) Q:X=""  S PSBREC(PSBINDX)=$P(PSBDDA(X),U,1,2)_U_$P(PSBDDA(X),U,4)_U_$P(PSBDDA(X),U,4)_U_PSBDOSEF,PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",98,0)
 .S X="" F  S X=$O(PSBADA(X)) Q:X=""  S PSBREC(PSBINDX)=PSBADA(X),PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",99,0)
 .S X="" F  S X=$O(PSBSOLA(X)) Q:X=""  S PSBREC(PSBINDX)=PSBSOLA(X),PSBINDX=PSBINDX+1
"RTN","PSBMLEN1",100,0)
 .D FILE
"RTN","PSBMLEN1",101,0)
 K ^TMP("PSB",$J)
"RTN","PSBMLEN1",102,0)
 Q
"RTN","PSBMLEN1",103,0)
 ;
"RTN","PSBMLEN1",104,0)
FILE ; Call the med log RPC to file it and DDS to edit it
"RTN","PSBMLEN1",105,0)
 N PSB,PSBSAVE,PSBAUDIT
"RTN","PSBMLEN1",106,0)
 D RPC^PSBML(.PSB,"+1^MEDPASS",.PSBREC)
"RTN","PSBMLEN1",107,0)
 I '$D(PSB) S PSB(0)=1,PSB(1)="-1^INCOMPLETE ENTRY^"_PSBINCX
"RTN","PSBMLEN1",108,0)
 I +PSB(1)<1 D  Q
"RTN","PSBMLEN1",109,0)
 .W @IOF,!,"Error(s) Creating Med Log Entry",!
"RTN","PSBMLEN1",110,0)
 .S X=$S(PSB(0)=1:0,1:1) F  S X=$O(PSB(X)) Q:X=""  W !,$J($S(X=1:X,1:X-1),2),". ",$S(X=1:$P(PSB(X),"^",2),1:PSB(X))
"RTN","PSBMLEN1",111,0)
 .W !!,"No Med Log Entry Created.",!!
"RTN","PSBMLEN1",112,0)
 .K DIR S DIR(0)="E" D ^DIR
"RTN","PSBMLEN1",113,0)
 S PSBSAVE=0 S:'$G(PSBMMEN) PSBAUDIT=1
"RTN","PSBMLEN1",114,0)
 S DA=$P(PSB(1),U,3),DDSFILE=53.79,DDSPARM="C"
"RTN","PSBMLEN1",115,0)
 I $P(^PSB(53.79,DA,.1),U,1)?.N1"U" S DR="[PSB NEW UD ENTRY]"
"RTN","PSBMLEN1",116,0)
 I $P(^PSB(53.79,DA,.1),U,1)?.N1"V" S DR="[PSB NEW IV ENTRY]"
"RTN","PSBMLEN1",117,0)
 D ^DDS
"RTN","PSBMLEN1",118,0)
 L +^PSB(53.79,DA):DILOCKTM I  L -^PSB(53.79,DA) I PSBSAVE'=1 D
"RTN","PSBMLEN1",119,0)
 .W !,"Incomplete Med Log Entry, Deleting...#",DA S A=^PSB(53.79,DA,0),DFN=$P(A,U,1),AADT=$P(A,U,6)
"RTN","PSBMLEN1",120,0)
 .K ^PSB(53.79,"AADT",DFN,AADT,DA) S DIK="^PSB(53.79," D ^DIK
"RTN","PSBMLEN1",121,0)
 I PSBSAVE=1 D
"RTN","PSBMLEN1",122,0)
 .I $D(DA) D:($P(^PSB(53.79,DA,0),U,9)="G")
"RTN","PSBMLEN1",123,0)
 ..I $D(^PSB(53.79,DA,.5)) S PSBY=0 F  S PSBY=$O(^PSB(53.79,DA,.5,PSBY)) Q:+PSBY<1  D
"RTN","PSBMLEN1",124,0)
 ...I $P(^PSB(53.79,DA,.5,PSBY,0),U,4)="PATCH" D
"RTN","PSBMLEN1",125,0)
 ....S (PSBYX,PSBXUIT)="" F  S PSBYX=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBYX),-1)   Q:PSBYX=""  D  Q:PSBXUIT
"RTN","PSBMLEN1",126,0)
 .....S PSBYZ="" S PSBYZ=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBYX,PSBYZ)) I (PSBYZ'=DA),$P(^PSB(53.79,PSBYZ,0),U,9)="G" D
"RTN","PSBMLEN1",127,0)
 ......W !!,"PATCH has been GIVEN before this admin completed; Deleting Med Log Entry...#",DA,!! S A=^PSB(53.79,DA,0),DFN=$P(A,U,1),AADT=$P(A,U,6)
"RTN","PSBMLEN1",128,0)
 ......K ^PSB(53.79,"AADT",DFN,AADT,DA) S DIK="^PSB(53.79," D ^DIK
"RTN","PSBMLEN1",129,0)
 ......S PSBXUIT=1
"RTN","PSBMLEN1",130,0)
 ....Q:PSBXUIT
"RTN","PSBMLEN1",131,0)
 ....S ^PSB(53.79,"APATCH",$P(^PSB(53.79,DA,0),U),$P(^PSB(53.79,DA,0),U,6),DA)=""
"RTN","PSBMLEN1",132,0)
 .Q:(PSBIEN="+1")&('$D(PSBIEN(1)))
"RTN","PSBMLEN1",133,0)
 .Q:$G(PSBXUIT)
"RTN","PSBMLEN1",134,0)
 .S X=$S($P(PSBIEN,",",2)]"":$P(PSBIEN,",",2),PSBIEN="+1":PSBIEN(1),1:"")
"RTN","PSBMLEN1",135,0)
 .I X]"" I ($F("HR",$P(^PSB(53.79,X,0),U,9))>1) F Y=.5,.6,.7 S Z=0 F  S Z=$O(^PSB(53.79,X,Y,Z)) Q:+Z=0  S $P(^PSB(53.79,X,Y,Z,0),U,3)=0
"RTN","PSBMLEN1",136,0)
 .I X]"",$G(PSBMMEN)=1 D SCANFAIL ;If Manual Med Entry was used, document "scanning failure"
"RTN","PSBMLEN1",137,0)
 Q
"RTN","PSBMLEN1",138,0)
 ;
"RTN","PSBMLEN1",139,0)
FDATE ;Check Admin Time for future date/time.
"RTN","PSBMLEN1",140,0)
 N PSBTIMX
"RTN","PSBMLEN1",141,0)
 S PSBTIMX=X D NOW^%DTC
"RTN","PSBMLEN1",142,0)
 I PSBTIMX>% W $C(7) S (DDSERROR,DDSBR)=1 D HLP^DDSUTL("Future date/time is not allowed")
"RTN","PSBMLEN1",143,0)
 Q
"RTN","PSBMLEN1",144,0)
 ;
"RTN","PSBMLEN1",145,0)
SCANFAIL ;File an MSF record
"RTN","PSBMLEN1",146,0)
 N PSBPRM,PSBRSLT,PSBX,PSBX1,PSBX2
"RTN","PSBMLEN1",147,0)
 S PSBX=^PSB(53.79,DA,0)
"RTN","PSBMLEN1",148,0)
 S PSBX1=^PSB(53.79,DA,.1)
"RTN","PSBMLEN1",149,0)
 S PSBPRM(0)=$P(PSBX,U,1)_U_$P(PSBX1,U,1)_U_"Manual Medication Entry"_U_""_U_"M"_U_1
"RTN","PSBMLEN1",150,0)
 I $P(PSBX1,U,1)["U",$P($G(^PSB(53.79,DA,.5,1,0)),U,1)]"" D
"RTN","PSBMLEN1",151,0)
 .S PSBX2="DD"_U_$P($G(^PSB(53.79,DA,.5,1,0)),U,1)
"RTN","PSBMLEN1",152,0)
 I $P(PSBX1,U,1)["V",$P($G(^PSB(53.79,DA,.6,1,0)),U,1)]"" D
"RTN","PSBMLEN1",153,0)
 .S PSBX2="ADD"_U_$P($G(^PSB(53.79,DA,.6,1,0)),U,1)
"RTN","PSBMLEN1",154,0)
 I $G(PSBX2)="",$P(PSBX1,U,1)["V",$P($G(^PSB(53.79,DA,.7,1,0)),U,1)]"" D
"RTN","PSBMLEN1",155,0)
 .S PSBX2="SOL"_U_$P($G(^PSB(53.79,DA,.7,1,0)),U,1)
"RTN","PSBMLEN1",156,0)
 I $G(PSBX2)]"" S PSBPRM(1)=PSBX2
"RTN","PSBMLEN1",157,0)
 D SCANFAIL^PSBVDLU3(.PSBRSLT,.PSBPRM)
"RTN","PSBMLEN1",158,0)
 Q
"RTN","PSBO")
0^1^B80519878^B72590688
"RTN","PSBO",1,0)
PSBO ;BIRMINGHAM/EFC-BCMA OUTPUTS ; 28 Jul 2008  6:58 AM
"RTN","PSBO",2,0)
 ;;3.0;BAR CODE MED ADMIN;**13,32,2,25,28,51,50**;Mar 2004;Build 78
"RTN","PSBO",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBO",4,0)
 ;
"RTN","PSBO",5,0)
 ; Reference/IA
"RTN","PSBO",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBO",7,0)
 ; ^ORD(101.24/3429
"RTN","PSBO",8,0)
 ; ^PSDRUG(/221
"RTN","PSBO",9,0)
 ;
"RTN","PSBO",10,0)
RPC(RESULTS,PSBTYPE,PSBDFN,PSBSTRT,PSBSTOP,PSBINCL,PSBDEV,PSBSORT,PSBOI,PSBWLOC,PSBWSORT,PSBFUTR,PSBORDNM,PSBRCRI,PSBLIST,PSBPST,PSBTR,PSBDIV) ;
"RTN","PSBO",11,0)
 ;
"RTN","PSBO",12,0)
 ; RPC: PSB REPORT
"RTN","PSBO",13,0)
 ;
"RTN","PSBO",14,0)
 ; Description:
"RTN","PSBO",15,0)
 ; Used by the client to create individual patient extracts of
"RTN","PSBO",16,0)
 ; CHUI report options to display on the client.
"RTN","PSBO",17,0)
 ;
"RTN","PSBO",18,0)
 S RESULTS=$NAME(^TMP("PSBO",$J))
"RTN","PSBO",19,0)
 N PSBIENS,PSBRPT,PSBFDA,DIC,PSBANS
"RTN","PSBO",20,0)
 K ^TMP("PSBO",$J) S ^TMP("PSBO",$J,1)="-1^"
"RTN","PSBO",21,0)
 S DFN=PSBDFN
"RTN","PSBO",22,0)
 D NEW^PSBO1(.PSBRPT,PSBTYPE)
"RTN","PSBO",23,0)
 I PSBDFN'="",PSBTYPE="MH"!(PSBTYPE="WA")!(PSBTYPE="ML")!(PSBTYPE="MT") D PAINCMT^PSBCSUTL(PSBDFN) ;;Add Comment if Pain Score entered in BCMA was marked "Entered in Error" in Vitals.
"RTN","PSBO",24,0)
 I +PSBRPT(0)<1 S ^TMP("PSBO",$J,1)="-1^Error: "_$P(PSBRPT(0),U,2) Q
"RTN","PSBO",25,0)
 S PSBIENS=+PSBRPT(0)_","
"RTN","PSBO",26,0)
 S PSBSTRT(0)=$E($P(PSBSTRT,".",2)_"0000",1,4),PSBSTRT=PSBSTRT\1
"RTN","PSBO",27,0)
 S PSBSTOP(0)=$E($P(PSBSTOP,".",2)_"0000",1,4),PSBSTOP=PSBSTOP\1
"RTN","PSBO",28,0)
 D:$G(PSBDEV)]""
"RTN","PSBO",29,0)
 .D NOW^%DTC
"RTN","PSBO",30,0)
 .I $P(PSBDEV,U,2)="" D VAL^DIE(53.69,PSBIENS,.06,"F",PSBDEV,"PSBRET","PSBFDA")
"RTN","PSBO",31,0)
 .I $P(PSBDEV,U,2)'="" D VAL^DIE(53.69,PSBIENS,.06,"F","`"_$P(PSBDEV,U,2),"PSBRET","PSBFDA")
"RTN","PSBO",32,0)
 .D VAL^DIE(53.69,PSBIENS,.07,"F",$S($P(PSBRCRI,U)="QD":$P(PSBRCRI,U,2),1:%),"PSBRET","PSBFDA")
"RTN","PSBO",33,0)
 D:$G(PSBOI)]"" VAL^DIE(53.69,PSBIENS,.09,"F",PSBOI,"PSBRET","PSBFDA")
"RTN","PSBO",34,0)
 S:($G(PSBSORT)']"")&(PSBTYPE'="XA") PSBSORT="P" D VAL^DIE(53.69,PSBIENS,.11,"F",PSBSORT,"PSBRET","PSBFDA")
"RTN","PSBO",35,0)
 I "^SF"[("^"_PSBTYPE) D VAL^DIE(53.69,PSBIENS,.51,"F",PSBSORT,"PSBRET","PSBFDA")
"RTN","PSBO",36,0)
 S PSBPST=$TR($G(PSBPST),"^",",")
"RTN","PSBO",37,0)
 D VAL^DIE(53.69,PSBIENS,.52,"F",PSBPST,"PSBRET","PSBFDA")
"RTN","PSBO",38,0)
 S PSBTR=$TR($G(PSBTR),"^",",")
"RTN","PSBO",39,0)
 I $G(PSBDIV)]"" D VAL^DIE(53.69,PSBIENS,.04,"F",$G(PSBDIV),"PSBRET","PSBFDA")
"RTN","PSBO",40,0)
 D VAL^DIE(53.69,PSBIENS,2,"F",PSBTR,"PSBRET","PSBFDA")
"RTN","PSBO",41,0)
 D VAL^DIE(53.69,PSBIENS,.12,"F","`"_PSBDFN,"PSBRET","PSBFDA")
"RTN","PSBO",42,0)
 I $G(PSBWLOC)]"" S PSBFDA(53.69,PSBIENS,.13)=PSBWLOC
"RTN","PSBO",43,0)
 D:$G(PSBWSORT)]"" VAL^DIE(53.69,PSBIENS,.15,"F",PSBWSORT,"PSBRET","PSBFDA")
"RTN","PSBO",44,0)
 D VAL^DIE(53.69,PSBIENS,.16,"F",PSBSTRT,"PSBRET","PSBFDA")
"RTN","PSBO",45,0)
 D VAL^DIE(53.69,PSBIENS,.17,"F",PSBSTRT(0),"PSBRET","PSBFDA")
"RTN","PSBO",46,0)
 D VAL^DIE(53.69,PSBIENS,.18,"F",PSBSTOP,"PSBRET","PSBFDA")
"RTN","PSBO",47,0)
 D VAL^DIE(53.69,PSBIENS,.19,"F",PSBSTOP(0),"PSBRET","PSBFDA")
"RTN","PSBO",48,0)
 D:$G(PSBINCL)]""
"RTN","PSBO",49,0)
 .D VAL^DIE(53.69,PSBIENS,.21,"F",+$P(PSBINCL,"^",1),"PSBRET","PSBFDA")
"RTN","PSBO",50,0)
 .D VAL^DIE(53.69,PSBIENS,.22,"F",+$P(PSBINCL,"^",2),"PSBRET","PSBFDA")
"RTN","PSBO",51,0)
 .D VAL^DIE(53.69,PSBIENS,.23,"F",+$P(PSBINCL,"^",3),"PSBRET","PSBFDA")
"RTN","PSBO",52,0)
 .D VAL^DIE(53.69,PSBIENS,.24,"F",+$P(PSBINCL,"^",4),"PSBRET","PSBFDA")
"RTN","PSBO",53,0)
 .D VAL^DIE(53.69,PSBIENS,.28,"F",+$P(PSBINCL,"^",5),"PSBRET","PSBFDA")
"RTN","PSBO",54,0)
 .D VAL^DIE(53.69,PSBIENS,.29,"F",+$P(PSBINCL,"^",6),"PSBRET","PSBFDA")
"RTN","PSBO",55,0)
 D:$G(PSBFUTR)]""
"RTN","PSBO",56,0)
 .D VAL^DIE(53.69,PSBIENS,.25,"F",+$P(PSBFUTR,"^",1),"PSBRET","PSBFDA")
"RTN","PSBO",57,0)
 .D VAL^DIE(53.69,PSBIENS,.26,"F",+$P(PSBFUTR,"^",2),"PSBRET","PSBFDA")
"RTN","PSBO",58,0)
 .D VAL^DIE(53.69,PSBIENS,.27,"F",+$P(PSBFUTR,"^",3),"PSBRET","PSBFDA")
"RTN","PSBO",59,0)
 .D VAL^DIE(53.69,PSBIENS,.41,"F",+$P(PSBFUTR,"^",4),"PSBRET","PSBFDA")
"RTN","PSBO",60,0)
 .D VAL^DIE(53.69,PSBIENS,.61,"F",$TR(PSBFUTR,"^ ","~"),"PSBRET","PSBFDA")
"RTN","PSBO",61,0)
 D FILE^DIE("","PSBFDA")
"RTN","PSBO",62,0)
 I "^SF"'[("^"_PSBTYPE) I $G(PSBLIST(0),"")]"" D LIST^PSBO1(.PSBLIST)
"RTN","PSBO",63,0)
 I $G(PSBDEV)]"" D PRINT^PSBO1 S RESULTS=$NAME(^TMP("PSBO",$J)) Q
"RTN","PSBO",64,0)
 D HFSOPEN^PSBUTL("RPC") I POP S ^TMP("PSBO",$J,1)="ERROR: UNABLE TO ACCESS HFS DIRECTORY "_$$GET^XPAR("DIV","PSB HFS SCRATCH"),^TMP("PSBO",$J,2)="PLEASE CHECK DIRECTORY WRITE PRIVILEDGES." Q
"RTN","PSBO",65,0)
 U IO D DQ(+PSBIENS)
"RTN","PSBO",66,0)
 D HFSCLOSE^PSBUTL("RPC")
"RTN","PSBO",67,0)
 S RESULTS=$NAME(^TMP("PSBO",$J))
"RTN","PSBO",68,0)
 D:$G(PSBDEV)]"" PRINT^PSBO1
"RTN","PSBO",69,0)
 Q
"RTN","PSBO",70,0)
 ;
"RTN","PSBO",71,0)
XQ(PSBTYPE) ; Called via Kernel Menus
"RTN","PSBO",72,0)
 N PSBANS,PSBANS1,PSBRPT,PSBSAVE,DA,DIK,DR,DDSFILE
"RTN","PSBO",73,0)
 D NEW^PSBO1(.PSBRPT,PSBTYPE)
"RTN","PSBO",74,0)
 I +PSBRPT(0)<1 W !,"Error: ",$P(PSBRPT(0),U,2) S DIR(0)="E" D ^DIR Q
"RTN","PSBO",75,0)
 S DA=+PSBRPT(0),DR="[PSBO "_PSBTYPE_"]",DDSFILE=53.69 D ^DDS
"RTN","PSBO",76,0)
 W @IOF
"RTN","PSBO",77,0)
 I 'PSBSAVE W !,"Cancelling Request..." S DIK="^PSB(53.69," D ^DIK W "Cancelled!"
"RTN","PSBO",78,0)
 D:PSBSAVE
"RTN","PSBO",79,0)
 .;Check Drug to Patient Relationship.
"RTN","PSBO",80,0)
 .I (PSBTYPE="BL")!(PSBTYPE="BZ") S PSBANS="" D CHECK  I PSBANS=0!($D(DIRUT)) W !,"Cancelling Request..." S DIK="^PSB(53.69," D ^DIK W "Cancelled!" Q
"RTN","PSBO",81,0)
 .;Allow "'BROWSER" Device
"RTN","PSBO",82,0)
 .S IOP=$$GET1^DIQ(53.69,DA_",",.06,"I"),PSBSIO=0 I IOP]"" D
"RTN","PSBO",83,0)
 ..S IOP="`"_IOP,%ZIS="N"
"RTN","PSBO",84,0)
 ..D ^%ZIS
"RTN","PSBO",85,0)
 ..I IO=IO(0) S PSBSIO=1
"RTN","PSBO",86,0)
 ..D HOME^%ZIS K IOP
"RTN","PSBO",87,0)
 .I $$GET1^DIQ(53.69,DA_",",.06)["BROWSER"!(PSBSIO=1) S IOP=$$GET1^DIQ(53.69,DA_",",.06)_";132" D ^%ZIS U IO D DQ(DA) D ^%ZISC K IOP Q
"RTN","PSBO",88,0)
 .W @IOF,"Submitting Your Report Request to TaskMan..."
"RTN","PSBO",89,0)
 .S ZTIO=$$GET1^DIQ(53.69,DA_",",.06)
"RTN","PSBO",90,0)
 .S ZTDTH=$P(^PSB(53.69,DA,0),U,7)
"RTN","PSBO",91,0)
 .S ZTDESC="BCMA - "_$$GET1^DIQ(53.69,DA_",",.05)
"RTN","PSBO",92,0)
 .S ZTRTN="DQ^PSBO("_DA_")"
"RTN","PSBO",93,0)
 .D ^%ZTLOAD
"RTN","PSBO",94,0)
 .W "Submitted!",!,"Your Task Number Is: ",$G(ZTSK),!
"RTN","PSBO",95,0)
 K ^TMP("PSBO",$J)
"RTN","PSBO",96,0)
 Q
"RTN","PSBO",97,0)
 ;
"RTN","PSBO",98,0)
DQ(PSBRPT) ; Dequeue report from Taskman
"RTN","PSBO",99,0)
 N PSBDFN
"RTN","PSBO",100,0)
 Q:'$D(^PSB(53.69,PSBRPT,0))  ; No Such Report
"RTN","PSBO",101,0)
 S $P(^PSB(53.69,PSBRPT,0),U,8)=$G(ZTSK,"RPC")
"RTN","PSBO",102,0)
 D:$$SETUP @("EN^PSBO"_$P(PSBRPT(0),U,5))
"RTN","PSBO",103,0)
 K ^TMP("PSBO",$J)
"RTN","PSBO",104,0)
 S ZTREQ="@"
"RTN","PSBO",105,0)
 Q
"RTN","PSBO",106,0)
 ;
"RTN","PSBO",107,0)
IOM() ; Returns good margin or not
"RTN","PSBO",108,0)
 Q:IOM'<132 1
"RTN","PSBO",109,0)
 W !,"**************************************************************"
"RTN","PSBO",110,0)
 W !,"* SORRY, Your selected DEVICE does not print 132 columns.    *"
"RTN","PSBO",111,0)
 W !,"**************************************************************"
"RTN","PSBO",112,0)
 W !
"RTN","PSBO",113,0)
 Q 0
"RTN","PSBO",114,0)
 ;
"RTN","PSBO",115,0)
VAL(PSBFLDS) ; Validate that fields in PSBFLDS are filled in
"RTN","PSBO",116,0)
 N PSB,PSBFLD,PSBMSG,PSBSTOP,PSBST,PSBDAYS S PSBSTRT=""
"RTN","PSBO",117,0)
 F PSB=1:1 Q:$P(PSBFLDS,";",PSB)=""  S PSBFLD=$P(PSBFLDS,";",PSB),PSBFLD(PSBFLD)=$$GET^DDSVAL(53.69,DA,PSBFLD)
"RTN","PSBO",118,0)
 I $D(PSBFLD(.11)) K:$E(PSBFLD(.11))="P" PSBFLD(.13),PSBFLD(.15) K:$E(PSBFLD(.11))="W" PSBFLD(.12)
"RTN","PSBO",119,0)
 S PSB=""  F  S PSB=$O(PSBFLD(PSB)) Q:PSB=""  D:PSBFLD(PSB)=""
"RTN","PSBO",120,0)
 .I '$D(PSBMSG) S PSBMSG(0)="UNABLE TO FILE REQUEST",PSBMSG(1)=" ",PSBMSG(2)="ERROR: MISSING DATA - ALL FIELDS ARE REQUIRED",PSBMSG(3)=" "
"RTN","PSBO",121,0)
 .D FIELD^DID(53.69,PSB,"","TITLE;LABEL","PSB")
"RTN","PSBO",122,0)
 .S Z="  Missing Field: "_$S(PSB("TITLE")]"":PSB("TITLE"),1:PSB("LABEL"))
"RTN","PSBO",123,0)
 .S PSBMSG($O(PSBMSG(""),-1)+1)=Z
"RTN","PSBO",124,0)
 ; Check Times
"RTN","PSBO",125,0)
 D:$G(PSBFLD(.16))
"RTN","PSBO",126,0)
 .S PSBSTRT=PSBFLD(.16)+$G(PSBFLD(.17))
"RTN","PSBO",127,0)
 .D:$P($$GET1^DIQ(53.69,DA_",",.01),U)["MH"
"RTN","PSBO",128,0)
 ..S PSBDAYS=$$GET1^DIQ(101.24,$$FIND1^DIC(101.24,"","X","ORRP BCMA MAH","B")_",",.42)  ;check maxdays
"RTN","PSBO",129,0)
 ..S:PSBDAYS="" PSBDAYS=7
"RTN","PSBO",130,0)
 ..S X=PSBSTRT\1 D H^%DTC S PSBST=%H+PSBDAYS    ;Determine stop date
"RTN","PSBO",131,0)
 .S PSBSTOP=$S($G(PSBFLD(.18)):PSBFLD(.18),1:PSBFLD(.16))+$G(PSBFLD(.19))
"RTN","PSBO",132,0)
 .I PSBSTOP<PSBSTRT S Y=$O(PSBMSG(""),-1)+1,PSBMSG(Y)="  Date: Stop Date/Time is before Start Date/Time"
"RTN","PSBO",133,0)
 .I $P($$GET1^DIQ(53.69,DA_",",.01),U)["MH" S X=PSBSTOP\1 D H^%DTC I %H>PSBST S Y=$O(PSBMSG(""),-1)+1,PSBMSG(Y)="  The date range cannot exceed "_PSBDAYS_" day(s) as defined in the CPRS 'MAXIMUM DAYS BACK' parameter"
"RTN","PSBO",134,0)
 Q:'$D(PSBMSG)  ; All is well
"RTN","PSBO",135,0)
 D MSG^DDSUTL(.PSBMSG)
"RTN","PSBO",136,0)
 S DDSERROR=1
"RTN","PSBO",137,0)
 Q
"RTN","PSBO",138,0)
 ;
"RTN","PSBO",139,0)
SETUP() ; Setup parameters for the report in PSBRPT
"RTN","PSBO",140,0)
 N PSBWRDL,PSBINDX,PSBWRDA
"RTN","PSBO",141,0)
 K ^TMP("PSBO",$J)
"RTN","PSBO",142,0)
 F X=0,.1,.2,.3,.4,.5,1 S PSBRPT(X)=$G(^PSB(53.69,PSBRPT,X))
"RTN","PSBO",143,0)
 I $D(^PSB(53.69,PSBRPT,2)) M PSBRPT(2)=^PSB(53.69,PSBRPT,2)
"RTN","PSBO",144,0)
 I $D(^PSB(53.69,PSBRPT,3)) M PSBRPT(3)=^PSB(53.69,PSBRPT,3)
"RTN","PSBO",145,0)
 S PSBRPT(.52)=$P($G(^PSB(53.69,PSBRPT,.5)),U,2)
"RTN","PSBO",146,0)
 I $P(PSBRPT(0),"-")="ST",PSBRPT(3)]"" Q 1  ;Running a MSF report PSB*3*28
"RTN","PSBO",147,0)
 I $P(PSBRPT(0),"-")="SF",PSBRPT(.52)]"" Q 1  ;Running a MSF report PSB*3*28
"RTN","PSBO",148,0)
 I $P(PSBRPT(.1),U,1)="P" D  I 'PSBDFN Q 0
"RTN","PSBO",149,0)
 .S PSBDFN=+$P(PSBRPT(.1),U,2) Q:'PSBDFN  S ^TMP("PSBO",$J,PSBDFN,0)=$P(^DPT(PSBDFN,0),U)_U_$P(^DPT(PSBDFN,0),U,9),^TMP("PSBO",$J,"B",$P(^DPT(PSBDFN,0),U),PSBDFN)=""
"RTN","PSBO",150,0)
 I $P(PSBRPT(.1),U,1)="W" D  I 'PSBWRD Q 0
"RTN","PSBO",151,0)
 .S PSBWRD=$P(PSBRPT(.1),U,3) Q:'PSBWRD  D WARD^NURSUT5("L^"_PSBWRD,.PSBWRDA)
"RTN","PSBO",152,0)
 .S X="" F  S X=$O(PSBWRDA(PSBWRD,2,X)) Q:X=""   S PSBWRDL=$P(PSBWRDA(PSBWRD,2,X,.01),U,2) D
"RTN","PSBO",153,0)
 ..F PSBDFN=0:0 S PSBDFN=$O(^DPT("CN",PSBWRDL,PSBDFN)) Q:PSBDFN=""  D
"RTN","PSBO",154,0)
 ...Q:$G(PSBDFN)=""
"RTN","PSBO",155,0)
 ...Q:$G(PSBDFN)'>0
"RTN","PSBO",156,0)
 ...S ^TMP("PSBO",$J,PSBDFN,0)=$P(^DPT(PSBDFN,0),U)_U_$P(^DPT(PSBDFN,0),U,9)
"RTN","PSBO",157,0)
 ...; Determine Sort or default to Pt Name...
"RTN","PSBO",158,0)
 ...S:$P(PSBRPT(.1),U,5)="P" PSBINDX=$P(^DPT(PSBDFN,0),U)
"RTN","PSBO",159,0)
 ...I $P(PSBRPT(.1),U,5)="B" S PSBINDX=$P($G(^DPT(PSBDFN,.101)),U) S:PSBINDX="" PSBINDX="** NO ROOM BED **"
"RTN","PSBO",160,0)
 ...S:$P(PSBRPT(.1),U,5)="" PSBINDX=$P(^DPT(PSBDFN,0),U)
"RTN","PSBO",161,0)
 ...S:$G(PSBINDX)="" PSBINDX=$P(^DPT(PSBDFN,0),U)
"RTN","PSBO",162,0)
 ...S ^TMP("PSBO",$J,"B",PSBINDX,PSBDFN)=""
"RTN","PSBO",163,0)
 Q 1
"RTN","PSBO",164,0)
 ;
"RTN","PSBO",165,0)
WRAP(X,Y,Z) ; Quick text wrap
"RTN","PSBO",166,0)
 ;
"RTN","PSBO",167,0)
 ; Input Parameters Description:
"RTN","PSBO",168,0)
 ;  X: Left Column of display [Optional]
"RTN","PSBO",169,0)
 ;  Y: Cols to wrap in [Optional]
"RTN","PSBO",170,0)
 ;  Z: Text to wrap [Optional]
"RTN","PSBO",171,0)
 ;
"RTN","PSBO",172,0)
 N PSB
"RTN","PSBO",173,0)
 F  Q:'$L(Z)  D
"RTN","PSBO",174,0)
 .W:$X>X !
"RTN","PSBO",175,0)
 .W:$X<X ?X
"RTN","PSBO",176,0)
 .I $L(Z)<Y W Z S Z="" Q
"RTN","PSBO",177,0)
 .F PSB=Y:-1:0 Q:$E(Z,PSB)=" "
"RTN","PSBO",178,0)
 .S:PSB<1 PSB=Y
"RTN","PSBO",179,0)
 .W $E(Z,1,PSB)
"RTN","PSBO",180,0)
 .S Z=$E(Z,PSB+1,250)
"RTN","PSBO",181,0)
 Q ""
"RTN","PSBO",182,0)
 ;
"RTN","PSBO",183,0)
CHECK ;Beginning of PSB*1*10
"RTN","PSBO",184,0)
 K ^TMP("PSJ",$J)
"RTN","PSBO",185,0)
 N PSBDFN,PSBBAR,PSBDRUG,PSBFLAG,PSBPNM,PSBNDX,PSBX
"RTN","PSBO",186,0)
 S PSBFLAG="",PSBBAR=$P($P($G(^PSB(53.69,DA,.3)),U,1),"~",2)
"RTN","PSBO",187,0)
 S PSBDRUG=$$GET1^DIQ(53.69,DA_",",.31)
"RTN","PSBO",188,0)
 S PSBDFN=$$GET1^DIQ(53.69,DA_",",.12,"I") S:$G(PSBDFN) PSBFLAG=1
"RTN","PSBO",189,0)
 D EN^PSJBCMA(PSBDFN)
"RTN","PSBO",190,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D
"RTN","PSBO",191,0)
 .K Y,PSBORD,PSBPNM,PSBNDX
"RTN","PSBO",192,0)
 .M PSBORD=^TMP("PSJ",$J,PSBX)
"RTN","PSBO",193,0)
 .F PSBNDX=700,850,950  D
"RTN","PSBO",194,0)
 ..F Y=0:0 S Y=$O(PSBORD(PSBNDX,Y)) Q:'Y  D
"RTN","PSBO",195,0)
 ...I $P($G(PSBORD(1)),U,7)'="A" Q
"RTN","PSBO",196,0)
 ...S PSBPNM=$P(PSBORD(PSBNDX,Y,0),U,1)
"RTN","PSBO",197,0)
 ...I PSBNDX=700,PSBPNM=PSBBAR S PSBFLAG=0 Q
"RTN","PSBO",198,0)
 ...I PSBNDX=850,$D(^PSDRUG("A526",PSBBAR,PSBPNM)) S PSBFLAG=0 Q
"RTN","PSBO",199,0)
 ...I PSBNDX=950,$D(^PSDRUG("A527",PSBBAR,PSBPNM)) S PSBFLAG=0
"RTN","PSBO",200,0)
 I PSBFLAG=1 D
"RTN","PSBO",201,0)
 .W !,"Patient is not currently on medication: ",PSBDRUG
"RTN","PSBO",202,0)
 .K DIRUT,DIR
"RTN","PSBO",203,0)
 .S DIR("A")="Do you want to continue"
"RTN","PSBO",204,0)
 .S DIR(0)="Y"
"RTN","PSBO",205,0)
 .D ^DIR
"RTN","PSBO",206,0)
 .S PSBANS=+Y W !
"RTN","PSBO",207,0)
 Q
"RTN","PSBO",208,0)
 ;
"RTN","PSBO",209,0)
PRNEFF(PSBEIECMT,PSBIEN) ;Check for PRN Error comment
"RTN","PSBO",210,0)
 N PSBCMTCH
"RTN","PSBO",211,0)
 I $P($G(PSBRPT(.2)),U,8)=0 S PSBCMTCH=0 F  S PSBCMTCH=$O(^PSB(53.79,PSBIEN,.3,PSBCMTCH)) Q:PSBCMTCH=""  D
"RTN","PSBO",212,0)
 .I $P($G(^PSB(53.79,PSBIEN,.3,PSBCMTCH,0)),U)["**Pain Score of" S PSBEIECMT=" **This Pain Score may have been Entered in Error. See Vitals Package.**"
"RTN","PSBO",213,0)
 Q PSBEIECMT
"RTN","PSBO",214,0)
 ;
"RTN","PSBOCE")
0^13^B78332113^B78251398
"RTN","PSBOCE",1,0)
PSBOCE ;BIRMINGHAM/TEJ-Expired/DC'd/EXPIRING ORDERS REPORT ;Mar 2004
"RTN","PSBOCE",2,0)
 ;;3.0;BAR CODE MED ADMIN;**32,50**;Mar 2004;Build 78
"RTN","PSBOCE",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOCE",4,0)
 ;
"RTN","PSBOCE",5,0)
EN ;
"RTN","PSBOCE",6,0)
 N PSBX1X,RESULTS,RESULT,PSBFUTR
"RTN","PSBOCE",7,0)
 S PSBFUTR=$TR(PSBRPT(1),"~",U)
"RTN","PSBOCE",8,0)
 S (PSBOCRIT,PSBXFLG,PSBCFLG)=""   ; Ord Status srch crit - "A"ctve, "D"C ed, "E"xpred"
"RTN","PSBOCE",9,0)
 S:$P(PSBFUTR,U,7) PSBOCRIT=PSBOCRIT_"Expired/DC'd" S:$P(PSBFUTR,U,8) PSBOCRIT=PSBOCRIT_"Expired/DC'd" S:$P(PSBFUTR,U,9) PSBOCRIT=PSBOCRIT_"Expiring Today"
"RTN","PSBOCE",10,0)
 S:$P(PSBFUTR,U,10) PSBOCRIT=PSBOCRIT_"Expiring Tomorrow"
"RTN","PSBOCE",11,0)
 S:$P(PSBFUTR,U,11) PSBXFLG=1
"RTN","PSBOCE",12,0)
 I $D(PSBRPT(.2)) I $P(PSBRPT(.2),U,8) S PSBCFLG=1
"RTN","PSBOCE",13,0)
 K PSBSRTBY,PSBCMT,PSBADM,PSBDATA,PSBOUTP,PSBLGD
"RTN","PSBOCE",14,0)
 S PSBSORT=1
"RTN","PSBOCE",15,0)
 D NOW^%DTC S (Y,PSBNOWX)=% D DD^%DT S PSBDTTM=Y
"RTN","PSBOCE",16,0)
 D GETPAR^PSBPAR("ALL","PSB ADMIN BEFORE")
"RTN","PSBOCE",17,0)
 S PSBB4=0 S:RESULTS(0)>0 PSBB4=+RESULTS(0)
"RTN","PSBOCE",18,0)
 D GETPAR^PSBPAR("ALL","PSB ADMIN AFTER")
"RTN","PSBOCE",19,0)
 S PSBAFT=0 S:RESULTS(0)>0 PSBAFT=+RESULTS(0)
"RTN","PSBOCE",20,0)
 K ^XTMP("PSBO",$J,"PSBLIST")
"RTN","PSBOCE",21,0)
 S (PSBPGNUM,PSBLNTOT,PSBTOT,PSBX1X)=""
"RTN","PSBOCE",22,0)
 K PSBLIST,PSBLIST2
"RTN","PSBOCE",23,0)
 S PSBXDFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOCE",24,0)
 S PSBLIST(PSBXDFN)=""
"RTN","PSBOCE",25,0)
 S (PSBX1X,PSBTOT)=0
"RTN","PSBOCE",26,0)
 F  S PSBX1X=$O(PSBLIST(PSBX1X)) Q:+PSBX1X=0  D
"RTN","PSBOCE",27,0)
 .D RPC^PSBCSUTL(.PSBAREA,PSBX1X)
"RTN","PSBOCE",28,0)
 .M PSBDATA=@PSBAREA
"RTN","PSBOCE",29,0)
 .S PSBX2X=1
"RTN","PSBOCE",30,0)
 .S (PSBLIST2("Expiring Tomorrow"),PSBLIST2("Expiring Today"),PSBLIST2("Expired/DC'd"),PSBLIST2(" * NO * "))=0
"RTN","PSBOCE",31,0)
 .F  S PSBX2X=$O(PSBDATA(PSBX2X)) Q:+PSBX2X=0  D
"RTN","PSBOCE",32,0)
 ..S PSBDATA=PSBDATA(PSBX2X)
"RTN","PSBOCE",33,0)
 ..I $P(PSBDATA,U)="ORD" D  Q
"RTN","PSBOCE",34,0)
 ...K PSBDRUGN
"RTN","PSBOCE",35,0)
 ...S PSBORDN=$P(PSBDATA,U,3)
"RTN","PSBOCE",36,0)
 ...S PSBTB=$P(PSBDATA,U,29) S PSBTB=$S(PSBTB=1:"UD",PSBTB=2:"IVPB",PSBTB=3:"IV",1:" * ERROR * ")
"RTN","PSBOCE",37,0)
 ...S PSBTB(PSBORDN,PSBTB)=""
"RTN","PSBOCE",38,0)
 ...S PSBSTS=$P(PSBDATA,U,23) S PSBSTS=$S((PSBSTS="A")&(($P(PSBDATA,U,27)>PSBNOWX)):"Active",PSBSTS="H":"On Hold",PSBSTS="D":"Discontinued",PSBSTS="DE":"Discontinued (Edit)",(PSBSTS="E")!($P(PSBDATA,U,27)'>PSBNOWX):"Expired",1:" * ERROR * ")
"RTN","PSBOCE",39,0)
 ...S PSBSTS(PSBORDN,PSBSTS)=""
"RTN","PSBOCE",40,0)
 ...S X2=$P(PSBDATA,U,27),X3=$P(PSBNOWX,".")
"RTN","PSBOCE",41,0)
 ...S PSBSTSX=$S((X2<PSBNOWX):"Expired/DC'd",(X3'>X2)&($$FMADD^XLFDT(X3,1)>X2):"Expiring Today",($$FMADD^XLFDT(X3,1)'>X2)&(X2'>$$FMADD^XLFDT(X3,2)):"Expiring Tomorrow",1:" * NO * ")
"RTN","PSBOCE",42,0)
 ...I PSBSTS["Discontinued" S PSBSTSX="Expired/DC'd"
"RTN","PSBOCE",43,0)
 ...S PSBLIST2(PSBSTSX,$P(PSBDATA,U,9),PSBORDN)="" S PSBLIST2(PSBSTSX)=PSBLIST2(PSBSTSX)+1
"RTN","PSBOCE",44,0)
 ...S:PSBOCRIT[PSBSTSX PSBTOT=PSBTOT+1
"RTN","PSBOCE",45,0)
 ...S PSBSCHTY=$P(PSBDATA,U,6)
"RTN","PSBOCE",46,0)
 ...S PSBSCHTY(PSBORDN,PSBSCHTY)=""
"RTN","PSBOCE",47,0)
 ...S PSBSCHD=$P(PSBDATA,U,7) I PSBSCHD="" S PSBSCHD=" "
"RTN","PSBOCE",48,0)
 ...S PSBSCHD(PSBORDN,PSBSCHD)=""
"RTN","PSBOCE",49,0)
 ...S PSBDOSR=$P(PSBDATA,U,10)_", "_$P(PSBDATA,U,11)
"RTN","PSBOCE",50,0)
 ...S PSBDOSR=$TR($E(PSBDOSR,1)," ")_$E(PSBDOSR,2,999)
"RTN","PSBOCE",51,0)
 ...S PSBDOSR(PSBORDN,PSBDOSR)="" K PSBOMDR(PSBORDN)
"RTN","PSBOCE",52,0)
 ...S PSBNXTX1=$$NEXTADM^PSBCSUTX(PSBX1X,PSBORDN)
"RTN","PSBOCE",53,0)
 ...I PSBSTS["Hold" S PSBNXTX2="Provider Hold"
"RTN","PSBOCE",54,0)
 ...I PSBSTS'["Hold" D 
"RTN","PSBOCE",55,0)
 ....I PSBNOWX>$$FMADD^XLFDT(PSBNXTX1,,,PSBAFT) S PSBNXTX2="MISSED "_PSBNXTX1
"RTN","PSBOCE",56,0)
 ....E  S PSBNXTX2="DUE "_PSBNXTX1
"RTN","PSBOCE",57,0)
 ...S PSBNXTX1=$$FMTDT^PSBOCE1(PSBNXTX1)
"RTN","PSBOCE",58,0)
 ...I ("^P^OC^O"[(U_PSBSCHTY))!(PSBTB="IV")!(PSBSTS["Discontinued")!(PSBSTS["Expired") S:PSBSTS'["Hold" PSBNXTX2=" "
"RTN","PSBOCE",59,0)
 ...S PSBNXTX(PSBORDN,PSBNXTX2)=""
"RTN","PSBOCE",60,0)
 ...; ** SPC INSTR  **
"RTN","PSBOCE",61,0)
 ...S PSBX2X=PSBX2X+1
"RTN","PSBOCE",62,0)
 ...S PSBSI=$P(PSBDATA(PSBX2X),U,2)
"RTN","PSBOCE",63,0)
 ...I PSBSI]" " S PSBSI(PSBORDN,PSBSI)=""
"RTN","PSBOCE",64,0)
 ...S PSBOSTDT=$P(PSBDATA,U,22)
"RTN","PSBOCE",65,0)
 ...S PSBOSTDT(PSBORDN,PSBOSTDT)=""
"RTN","PSBOCE",66,0)
 ...S PSBOSPDT=$P(PSBDATA,U,27)
"RTN","PSBOCE",67,0)
 ...S PSBOSPDT(PSBORDN,PSBOSPDT)=""
"RTN","PSBOCE",68,0)
 ..I "^DD^ADD^SOL"[(U_$P(PSBDATA,U)) D  Q
"RTN","PSBOCE",69,0)
 ...F I=PSBX2X:1 S PSBDATA1=PSBDATA(I) D  Q:$D(PSBOMDR(PSBORDN))
"RTN","PSBOCE",70,0)
 ....I "^DD^ADD^SOL"[(U_$P(PSBDATA1,U)) S PSBX2X=I S PSBDRUGN=$G(PSBDRUGN,"")_$P(PSBDATA1,U,3)_", " Q
"RTN","PSBOCE",71,0)
 ....S $E(PSBDRUGN,$L(PSBDRUGN)-1)="" S PSBDRUGN(PSBORDN,$E(PSBDRUGN,1,250))=PSBDRUGN
"RTN","PSBOCE",72,0)
 ....S PSBOMDR(PSBORDN,$E((PSBDRUGN_"; "_PSBDOSR),1,250))=PSBDRUGN_"; "_PSBDOSR
"RTN","PSBOCE",73,0)
 ..I $P(PSBDATA,U)="END" Q
"RTN","PSBOCE",74,0)
 ..I $P(PSBDATA(PSBX2X+1),U)="ORF" D  Q
"RTN","PSBOCE",75,0)
 ...S PSBX2X=PSBX2X+1 S PSBDATA=PSBDATA(PSBX2X)
"RTN","PSBOCE",76,0)
 ...S:$P(PSBDATA,U,2)]"" PSBFLGD(PSBORDN,$P(PSBDATA,U,3)_" - "_$P(PSBDATA,U,4))=""
"RTN","PSBOCE",77,0)
 ..I ($P(PSBDATA,U)="ADM")&($P(PSBDATA,U,4)]"") D
"RTN","PSBOCE",78,0)
 ...S PSBXID=$P(PSBDATA,U,6)_U_$P(PSBDATA,U,4),PSBADM(PSBORDN,(-1*($P(PSBDATA,U,6))),PSBXID)=PSBDATA
"RTN","PSBOCE",79,0)
 ...I $O(PSBSCHTY(PSBORDN,""))="P" S PSBPRNR(PSBORDN,$P(PSBDATA,U,4))=$P(PSBDATA,U,9)
"RTN","PSBOCE",80,0)
 ...I $P(PSBDATA,U,3)]"" S PSBBID(PSBORDN,$P(PSBDATA,U,4))=$P(PSBDATA,U,3)
"RTN","PSBOCE",81,0)
 ...S:PSBXFLG PSBLGD(PSBORDN,"X","INITIALS",$P(PSBDATA,U,8))=""
"RTN","PSBOCE",82,0)
 ...K PSBDATA(PSBX2X)
"RTN","PSBOCE",83,0)
 ...I ($P(PSBDATA(PSBX2X+1),U)="CMT")  F  S PSBDATA=PSBDATA(PSBX2X+1) Q:($P(PSBDATA,U)'="CMT")  D
"RTN","PSBOCE",84,0)
 ....S PSBX2X=PSBX2X+1
"RTN","PSBOCE",85,0)
 ....S PSBDATA=PSBDATA(PSBX2X)
"RTN","PSBOCE",86,0)
 ....K PSBDATA(PSBX2X)
"RTN","PSBOCE",87,0)
 ....S:$P(PSBDATA,U,3)]"" PSBPRNEF(PSBORDN,$P(PSBXID,U,2))=$P(PSBDATA,U,3)
"RTN","PSBOCE",88,0)
 ....I 'PSBCFLG S PSBDATA=PSBDATA(PSBX2X+1) Q
"RTN","PSBOCE",89,0)
 ....I $P(PSBDATA,U,2)'="" D
"RTN","PSBOCE",90,0)
 .....S PSBLGD(PSBORDN,"C","INITIALS",$P(PSBDATA,U,4))=""
"RTN","PSBOCE",91,0)
 .....S PSBCMT(PSBORDN,$P(PSBXID,U,2),(-1*$P(PSBDATA,U,6)),PSBX2X)=PSBDATA
"RTN","PSBOCE",92,0)
 I '$D(PSBLIST2) K PSBLIST,^XTMP("PSBO",$J,"PSBLIST")
"RTN","PSBOCE",93,0)
 D CREATHDR
"RTN","PSBOCE",94,0)
 D SUBHDR
"RTN","PSBOCE",95,0)
 D BLDRPT
"RTN","PSBOCE",96,0)
 D WRTRPT
"RTN","PSBOCE",97,0)
 Q
"RTN","PSBOCE",98,0)
BLDRPT ; Buld RPT DATA
"RTN","PSBOCE",99,0)
 S X0="" K PSBLIST2(" * NO * "),PSBL2ULN
"RTN","PSBOCE",100,0)
 S PSBTOPHD=PSBLNTOT-2
"RTN","PSBOCE",101,0)
 I '$D(PSBLIST2) D  Q
"RTN","PSBOCE",102,0)
 .S PSBOUTP(0,PSBLNTOT)="W !!,""<<<< NO ORDERS TO DISPLAY >>>>"",!!"
"RTN","PSBOCE",103,0)
 S PSBMORE=5 F PSBX1X="Expired/DC'd","Expiring Today","Expiring Tomorrow" D
"RTN","PSBOCE",104,0)
 .I PSBX1X'=" * ERROR * " S PSBSUM=PSBX1X_" ["_PSBLIST2(PSBX1X)_$S(PSBLIST2(PSBX1X)=1:" Order",1:" Orders")_"]" S PSBOUTP($$PGTOT,PSBLNTOT)="W !!,"""_PSBSUM_""""
"RTN","PSBOCE",105,0)
 .Q:PSBLIST2(PSBX1X)=0
"RTN","PSBOCE",106,0)
 .Q:PSBOCRIT'[PSBX1X
"RTN","PSBOCE",107,0)
 .S:$L(PSBSUM)>$G(PSBL2ULN,0) PSBL2ULN=$L(PSBSUM)
"RTN","PSBOCE",108,0)
 .S PSBOUTP($$PGTOT(2),PSBLNTOT)="W !,$TR($J("""",PSBL2ULN),"" "",""=""),!"
"RTN","PSBOCE",109,0)
 .S PSBOUTP($$PGTOT,PSBLNTOT)="W !"
"RTN","PSBOCE",110,0)
 .K PSBDATA
"RTN","PSBOCE",111,0)
 .S X0="",PSBTOT1=0
"RTN","PSBOCE",112,0)
 .F  S X0=$O(PSBLIST2(PSBX1X,X0))  Q:X0=""  F  S PSBX2X=$O(PSBLIST2(PSBX1X,X0,PSBX2X)) Q:PSBX2X=""  D
"RTN","PSBOCE",113,0)
 ..M PSBLGD("INITIALS")=PSBLGD(PSBX2X,"X","INITIALS") M PSBLGD("INITIALS")=PSBLGD(PSBX2X,"C","INITIALS")
"RTN","PSBOCE",114,0)
 ..S PSBDATA(1,1)=$O(PSBTB(PSBX2X,""))
"RTN","PSBOCE",115,0)
 ..S PSBDATA(1,2)=$O(PSBSTS(PSBX2X,""))
"RTN","PSBOCE",116,0)
 ..S PSBDATA(1,3)=$O(PSBSCHTY(PSBX2X,""))
"RTN","PSBOCE",117,0)
 ..S Y0=$O(PSBOMDR(PSBX2X,"")) I Y0]"" S PSBDATA(1,4)="("_X0_")",PSBDATA(1,4,0)=PSBOMDR(PSBX2X,Y0)
"RTN","PSBOCE",118,0)
 ..S PSBDATA(1,5)=$O(PSBSCHD(PSBX2X,""))
"RTN","PSBOCE",119,0)
 ..S PSBDATA(1,6)=$O(PSBNXTX(PSBX2X,""))
"RTN","PSBOCE",120,0)
 ..S:PSBDATA(1,6)'["Hold" $P(PSBDATA(1,6)," ",2)=$$FMTDT^PSBOCE1($P(PSBDATA(1,6)," ",2))
"RTN","PSBOCE",121,0)
 ..S PSBDATA(1,7)=$$FMTDT^PSBOCE1($O(PSBOSTDT(PSBX2X,"")))
"RTN","PSBOCE",122,0)
 ..S PSBDATA(1,8)=$$FMTDT^PSBOCE1($E($O(PSBOSPDT(PSBX2X,"")),1,12))
"RTN","PSBOCE",123,0)
 ..S PSBSIDAT(1)=$O(PSBSI(PSBX2X,""))
"RTN","PSBOCE",124,0)
 ..S PSBTOT1=PSBTOT1+1
"RTN","PSBOCE",125,0)
 ..K PSBDATA(2),PSBDATA(3),PSBSILN
"RTN","PSBOCE",126,0)
 ..D BUILDLN^PSBOCE1,SIOPI^PSBOCM(.PSBSIDAT,PSBTAB8,$S(PSBX2X["V":"Other Print Info:",1:""))
"RTN","PSBOCE",127,0)
 ..I $D(PSBRPLN) S PSBMORE=$O(PSBRPLN(""),-1)+6 I $D(PSBSILN) S PSBMORE=PSBMORE+$O(PSBSILN(""),-1)
"RTN","PSBOCE",128,0)
 ..K PSB1 I $D(PSBFLGD(PSBX2X)) S PSB="" F  S PSB=$O(PSBFLGD(PSBX2X,PSB)) Q:PSB=""  I ($P(PSB,":")'="NOX")&($P(PSB,":")'="STAT") S PSB1=$G(PSB1,"")_PSB
"RTN","PSBOCE",129,0)
 ..S PSBCNT=PSBTOT1_"   "_$G(PSB1,"")
"RTN","PSBOCE",130,0)
 ..S PSBOUTP($$PGTOT,PSBLNTOT)="W """_PSBCNT_""""
"RTN","PSBOCE",131,0)
 ..S I="" F  S I=$O(PSBRPLN(I)) Q:+I=0  D
"RTN","PSBOCE",132,0)
 ...S PSBOUTP($$PGTOT,PSBLNTOT)="W !,"""_PSBRPLN(I)_""""
"RTN","PSBOCE",133,0)
 ..S I="" F  S I=$O(PSBSILN(I)) Q:+I=0  D
"RTN","PSBOCE",134,0)
 ...S PSBOUTP($$PGTOT,PSBLNTOT)="W !,"""_PSBSILN(I)_""""
"RTN","PSBOCE",135,0)
 ..S PSBOUTP($$PGTOT(2),PSBLNTOT)="W !,$TR($J("""",PSBTAB8),"" "",""-""),!"
"RTN","PSBOCE",136,0)
 ..K PSBRPLN,PSBDATA,PSBSILN
"RTN","PSBOCE",137,0)
 D:+PSBTOT>0 LGD^PSBOCM
"RTN","PSBOCE",138,0)
 Q
"RTN","PSBOCE",139,0)
WRTRPT ;  writ
"RTN","PSBOCE",140,0)
 I $O(PSBOUTP(""),-1)<1 D  Q
"RTN","PSBOCE",141,0)
 .X PSBOUTP($O(PSBOUTP(""),-1),21)
"RTN","PSBOCE",142,0)
 .D FTR
"RTN","PSBOCE",143,0)
 S PSBPGNUM=1
"RTN","PSBOCE",144,0)
 S PSBZ="" F  S PSBZ=$O(PSBOUTP(PSBZ)) Q:PSBZ=""  D
"RTN","PSBOCE",145,0)
 .I PSBPGNUM'=PSBZ D FTR S PSBPGNUM=PSBZ D HDR,SUBHDR
"RTN","PSBOCE",146,0)
 .S PSBX2X="" F  S PSBX2X=$O(PSBOUTP(PSBZ,PSBX2X)) Q:PSBX2X=""  D
"RTN","PSBOCE",147,0)
 ..X PSBOUTP(PSBZ,PSBX2X)
"RTN","PSBOCE",148,0)
 D FTR
"RTN","PSBOCE",149,0)
 K ^XTMP("PSBO",$J,"PSBLIST"),PSBOUTP
"RTN","PSBOCE",150,0)
 Q
"RTN","PSBOCE",151,0)
HDR ;  Hder
"RTN","PSBOCE",152,0)
 W:$Y>1 @IOF
"RTN","PSBOCE",153,0)
 W:$X>1 !
"RTN","PSBOCE",154,0)
 S PSBRPNM="BCMA COVERSHEET EXPIRED/DC'd/EXPIRING ORDERS REPORT"
"RTN","PSBOCE",155,0)
 D:$P(PSBRPT(.1),U,1)="P"
"RTN","PSBOCE",156,0)
 .S PSBHDR(0)=PSBRPNM
"RTN","PSBOCE",157,0)
 .S PSBHDR(1)="Order Status(es): --"
"RTN","PSBOCE",158,0)
 .F Y=7,8,9,10 I $P(PSBFUTR,U,Y) S $P(PSBHDR(1),": ",2)=$P(PSBHDR(1),": ",2)_$S(PSBHDR(1)["--":"",1:"/ ")_$P("^^^^^^Expired^DC'd^Expiring Today^Expiring Tomorrow^^^^^^^^",U,Y)_" " S PSBHDR(1)=$TR(PSBHDR(1),"-","")
"RTN","PSBOCE",159,0)
 .I $P(PSBFUTR,U,11) S PSBHDR(2)="Include Action(s)"_$S(PSBCFLG:" & Comments/Reasons",1:"")
"RTN","PSBOCE",160,0)
 .D PT^PSBOHDR(PSBXDFN,.PSBHDR)
"RTN","PSBOCE",161,0)
 Q
"RTN","PSBOCE",162,0)
SUBHDR ;
"RTN","PSBOCE",163,0)
 N PSBAL S PSBAL=$O(PSBHDR("ALERGY",""),-1) S PSBAL=$S((PSBAL/12)>(PSBAL\12):(PSBAL\12)+1,1:(PSBAL\12))
"RTN","PSBOCE",164,0)
 N PSBRE S PSBRE=$O(PSBHDR("REAC",""),-1) S PSBRE=$S((PSBRE/12)>(PSBRE\12):(PSBRE\12)+1,1:(PSBRE\12))
"RTN","PSBOCE",165,0)
 S PSBLNTOT=$O(PSBHDR(""),-1)+9+PSBAL+PSBRE+1
"RTN","PSBOCE",166,0)
 I $G(PSBPGNUM,0)=1 W !,?(PSBTAB8-($L("Total Orders reported: "_+PSBTOT))),"Total Orders reported: "_+PSBTOT,! S PSBLNTOT=PSBLNTOT+2
"RTN","PSBOCE",167,0)
 W !,$TR($J("",PSBTAB8)," ","_") S PSBLNTOT=PSBLNTOT+1
"RTN","PSBOCE",168,0)
 W !,$G(PSBHD1,"") S PSBLNTOT=PSBLNTOT+1
"RTN","PSBOCE",169,0)
 W !,$G(PSBHD2,"") S PSBLNTOT=PSBLNTOT+1
"RTN","PSBOCE",170,0)
 W !,$TR($J("",PSBTAB8)," ","="),! S PSBLNTOT=PSBLNTOT+2
"RTN","PSBOCE",171,0)
 I $D(NOTE(PSBPGNUM)) W NOTE(PSBPGNUM),!! S PSBLNTOT=PSBLNTOT+2
"RTN","PSBOCE",172,0)
 Q
"RTN","PSBOCE",173,0)
FTR ;  Footr
"RTN","PSBOCE",174,0)
 D PTFTR^PSBOHDR()
"RTN","PSBOCE",175,0)
 S PSBPG="Page: "_PSBPGNUM_" of "_$S($O(PSBOUTP(""),-1)=0:1,1:$O(PSBOUTP(""),-1))
"RTN","PSBOCE",176,0)
 S PSBPGRM=PSBTAB8-($L(PSBPG))
"RTN","PSBOCE",177,0)
 W !,PSBRPNM,"     ",?(PSBPGRM-($L(PSBDTTM)+3)),PSBDTTM_"  "_PSBPG
"RTN","PSBOCE",178,0)
 Q
"RTN","PSBOCE",179,0)
PGTOT(X) ;mnt PAGE Number
"RTN","PSBOCE",180,0)
 I (PSBLNTOT+PSBMORE)>(IOSL) D PGC^PSBOCE1
"RTN","PSBOCE",181,0)
 I $G(X,1) S PSBLNTOT=PSBLNTOT+$G(X,1),PSBMORE=PSBMORE-$G(X,1)
"RTN","PSBOCE",182,0)
 Q PSBPGNUM
"RTN","PSBOCE",183,0)
CREATHDR ;
"RTN","PSBOCE",184,0)
 K PSBHD1,PSBHD2
"RTN","PSBOCE",185,0)
 I IOM'<132 S PSBMORE=4,PSBHD1=$P($T(HD132A),"~",2),PSBHD2=$P($T(HD132B),";",2),PSBBLANK=$P($T(H132BLK),";",2)
"RTN","PSBOCE",186,0)
 E  S PSBHD1="THIS REPORT SUPPORTS >131 CHAR./LINE PRINT FORMATS ONLY" K PSBLIST2 Q
"RTN","PSBOCE",187,0)
 ; tabs
"RTN","PSBOCE",188,0)
 S PSBTAB0=1 F PSBI=0:1:($L(PSBHD1,"|")-1) S:PSBI>0 @("PSBTAB"_PSBI)=($F(PSBHD1,"|",@("PSBTAB"_(PSBI-1))+1))-1
"RTN","PSBOCE",189,0)
 S PSBPGNUM=1
"RTN","PSBOCE",190,0)
 D HDR
"RTN","PSBOCE",191,0)
 Q
"RTN","PSBOCE",192,0)
HD132A ;~ VDL |    Status     |Type|       Medication; Dosage, Route      |    Schedule    |     Next      |   Order Start  |   Order Stop  |
"RTN","PSBOCE",193,0)
 Q
"RTN","PSBOCE",194,0)
HD132B ; Tab |               |    |                                      |                |   Action      |     Date       |    Date       |
"RTN","PSBOCE",195,0)
 Q
"RTN","PSBOCE",196,0)
H132BLK ;;     |               |    |                                      |                |                |               |               |
"RTN","PSBOCE",197,0)
 Q
"RTN","PSBOCE1")
0^14^B14285420^B12338914
"RTN","PSBOCE1",1,0)
PSBOCE1 ;BIRMINGHAM/TEJ-Expired/DC'd/EXPIRING ORDERS REPORT (1) ;Mar 2004
"RTN","PSBOCE1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**32,50**;Mar 2004;Build 78
"RTN","PSBOCE1",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOCE1",4,0)
 ;
"RTN","PSBOCE1",5,0)
FMTDT(Y) ;
"RTN","PSBOCE1",6,0)
 ; Format date/time as displayed by GUI  ie. 02/25/2005@2323
"RTN","PSBOCE1",7,0)
 N X S X=$E(Y,4,5) X ^DD("DD") S Y=$TR(Y," ,:","//") S $P(Y,"/")=X
"RTN","PSBOCE1",8,0)
 Q Y
"RTN","PSBOCE1",9,0)
BUILDLN ; Constr recs
"RTN","PSBOCE1",10,0)
 K J S J(0)="" F PSBFLD=1:1:8 S J=1 D FORMDAT(PSBFLD) S J($O(PSBRPLN(""),-1))=""
"RTN","PSBOCE1",11,0)
 ; Write administration info...
"RTN","PSBOCE1",12,0)
 Q:'PSBXFLG
"RTN","PSBOCE1",13,0)
 S J=($O(J(""),-1)+1),PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1
"RTN","PSBOCE1",14,0)
 S (N,Y)=""
"RTN","PSBOCE1",15,0)
 M PSBLGD("INITIALS")=PSBLGD(PSBX2X,"X","INITIALS")
"RTN","PSBOCE1",16,0)
 F  S Y=$O(PSBADM(PSBX2X,Y)) Q:Y']""  D
"RTN","PSBOCE1",17,0)
 .F  S N=$O(PSBADM(PSBX2X,Y,N)) Q:N']""  D
"RTN","PSBOCE1",18,0)
 ..I $D(PSBBID(PSBX2X,$P(N,U,2))) S PSBDATA(2,0)="BAG ID: "_PSBBID(PSBX2X,$P(N,U,2))
"RTN","PSBOCE1",19,0)
 ..S $E(PSBDATA(2,0),25)="ACTION BY: "_$P(PSBADM(PSBX2X,Y,N),U,7)_" "_$$FMTDT^PSBOCE1($E($P(PSBADM(PSBX2X,Y,N),U,6),1,12))
"RTN","PSBOCE1",20,0)
 ..S X=$P(PSBADM(PSBX2X,Y,N),U,5) S $E(PSBDATA(2,0),56)="ACTION: "_$S(X="G":"GIVEN",X="R":"REFUSED",X="RM":"REMOVED",X="H":"HELD",X="S":"STOPPED",X="I":"INFUSING",X="C":"COMPLETED",X="M":"MISSING DOSE",X=" ":"*UNKNOWN*",1:" ")
"RTN","PSBOCE1",21,0)
 ..I $D(PSBPRNR(PSBX2X)) S $E(PSBDATA(2,0),72)="PRN REASON: "_PSBPRNR(PSBX2X,$P(N,U,2))
"RTN","PSBOCE1",22,0)
 ..I $G(PSBDATA(2,0))]" " D WRAPPER(1,132-1,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCE1",23,0)
 ..N PSBEIECMT S PSBEIECMT="" I $D(PSBPRNEF(PSBX2X,$P(N,U,2))),$P($G(PSBRPT(.2)),U,8)=0 S PSBEIECMT=$$PRNEFF^PSBO(PSBEIECMT,$P(N,U,2))
"RTN","PSBOCE1",24,0)
 ..I $D(PSBPRNEF(PSBX2X,$P(N,U,2))) S PSBDATA(2,0)="PRN EFFECTIVENESS: "_PSBPRNEF(PSBX2X,$P(N,U,2))_PSBEIECMT
"RTN","PSBOCE1",25,0)
 ..I $G(PSBDATA(2,0))]" " D WRAPPER(30,132-30,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCE1",26,0)
 ..I ('PSBCFLG)!('$D(PSBCMT(PSBX2X,$P(N,U,2)))) S PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1 Q
"RTN","PSBOCE1",27,0)
 ..M PSBLGD("INITIALS")=PSBLGD(PSBX2X,"C","INITIALS")
"RTN","PSBOCE1",28,0)
 ..S X="" F   S X=$O(PSBCMT(PSBX2X,$P(N,U,2),X)) Q:X']""  D
"RTN","PSBOCE1",29,0)
 ...N PSBDAT S PSBDAT="" F  S PSBDAT=$O(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT)) Q:PSBDAT']""  D
"RTN","PSBOCE1",30,0)
 ....S PSBDATA(2,0)="COMMENT BY: "_$S($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,5)]"":$P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,5)_" "_$$FMTDT^PSBOCE1($E($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,6),1,12)),1:" n/a ")
"RTN","PSBOCE1",31,0)
 ....S PSBDATA(2,0)=PSBDATA(2,0)_"  COMMENT: "_$S($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,2)]"":$P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,2),1:" ")
"RTN","PSBOCE1",32,0)
 ....I $G(PSBDATA(2,0))]" " D WRAPPER(30,132-30,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCE1",33,0)
 ..S PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1
"RTN","PSBOCE1",34,0)
 Q
"RTN","PSBOCE1",35,0)
FORMDAT(FLD) ;
"RTN","PSBOCE1",36,0)
 K PSBVAL
"RTN","PSBOCE1",37,0)
 Q:'$D(PSBDATA(1,FLD))
"RTN","PSBOCE1",38,0)
 S PSBVAL=PSBDATA(1,FLD)
"RTN","PSBOCE1",39,0)
 D WRAPPER(@("PSBTAB"_(FLD-1))+1,((@("PSBTAB"_(FLD))-(@("PSBTAB"_(FLD-1))+1))),PSBVAL)
"RTN","PSBOCE1",40,0)
 I FLD=4 S J=$O(J(""),-1)+1,PSBVAL=PSBDATA(1,4,0) D WRAPPER(@("PSBTAB"_(FLD-1))+1,((@("PSBTAB"_(FLD))-(@("PSBTAB"_(FLD-1))+1))),PSBVAL)
"RTN","PSBOCE1",41,0)
 Q
"RTN","PSBOCE1",42,0)
WRAPPER(X,Y,Z) ;  Text WRAP
"RTN","PSBOCE1",43,0)
 N PSB
"RTN","PSBOCE1",44,0)
 I ($L(Z)>0),$F(Z,"""")>1 F  Q:$F(Z,"""")'>1  S Z=$TR(Z,"""","^")
"RTN","PSBOCE1",45,0)
 F  Q:'$L(Z)  D
"RTN","PSBOCE1",46,0)
 .I $L(Z)<Y S $E(PSBRPLN(J),X)=Z S Z="" Q
"RTN","PSBOCE1",47,0)
 .F PSB=Y:-1:0 Q:$E(Z,PSB)=" "
"RTN","PSBOCE1",48,0)
 .S:PSB<1 PSB=Y
"RTN","PSBOCE1",49,0)
 .S $E(PSBRPLN(J),X)=$E(Z,1,PSB)
"RTN","PSBOCE1",50,0)
 .I $L(PSBRPLN(J),"^")>1 F X=1:1:$L(PSBRPLN(J),"^")-1 S $P(PSBRPLN(J),"^",X)=$P(PSBRPLN(J),"^",X)_""""
"RTN","PSBOCE1",51,0)
 .S PSBRPLN(J)=$TR(PSBRPLN(J),"^","""")
"RTN","PSBOCE1",52,0)
 .S Z=$E(Z,PSB+1,250),J=J+1,J(J)=""
"RTN","PSBOCE1",53,0)
 Q ""
"RTN","PSBOCE1",54,0)
PGC ;
"RTN","PSBOCE1",55,0)
 S PSBPGNUM=PSBPGNUM+1,PSBLNTOT=PSBTOPHD S PSBMORE=$S(PSBMORE>(IOSL-(PSBTOPHD)):(IOSL-(PSBTOPHD)),1:PSBMORE)
"RTN","PSBOCE1",56,0)
 S NOTE(PSBPGNUM)="( "_PSBX1X_" - Continued )"
"RTN","PSBOCE1",57,0)
 Q
"RTN","PSBOCM")
0^11^B76599407^B76517195
"RTN","PSBOCM",1,0)
PSBOCM ;BIRMINGHAM/TEJ-COVERSHEET MEDICATION OVERVIEW REPORT ;Mar 2004
"RTN","PSBOCM",2,0)
 ;;3.0;BAR CODE MED ADMIN;**32,50**;Mar 2004;Build 78
"RTN","PSBOCM",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOCM",4,0)
 ;
"RTN","PSBOCM",5,0)
 ; Reference/IA
"RTN","PSBOCM",6,0)
 ; File 4/10090
"RTN","PSBOCM",7,0)
 ; File 200/10060
"RTN","PSBOCM",8,0)
EN ;
"RTN","PSBOCM",9,0)
 N PSBX1X,RESULTS,RESULT,PSBFUTR
"RTN","PSBOCM",10,0)
 S PSBFUTR=$TR(PSBRPT(1),"~","^")
"RTN","PSBOCM",11,0)
 S (PSBOCRIT,PSBXFLG,PSBCFLG)=""        ;  Order Status search criteria - "A"ctive, "D"C ed, "E"xpired"
"RTN","PSBOCM",12,0)
 S:$P(PSBFUTR,U,7) PSBOCRIT=PSBOCRIT_"D" S:$P(PSBFUTR,U,8) PSBOCRIT=PSBOCRIT_"E" S:$P(PSBFUTR,U,5) PSBOCRIT=PSBOCRIT_"A"
"RTN","PSBOCM",13,0)
 S:$P(PSBFUTR,U,4) PSBOCRIT=PSBOCRIT_"F"
"RTN","PSBOCM",14,0)
 S:$P(PSBFUTR,U,11) PSBXFLG=1
"RTN","PSBOCM",15,0)
 I $D(PSBRPT(.2)) I $P(PSBRPT(.2),U,8) S PSBCFLG=1
"RTN","PSBOCM",16,0)
 K PSBSRTBY,PSBCMT,PSBADM,PSBDATA,PSBOUTP,PSBLGD,PSBHDR,PSBSTS
"RTN","PSBOCM",17,0)
 S PSBSORT=1
"RTN","PSBOCM",18,0)
 D NOW^%DTC S (Y,PSBNOWX)=% D DD^%DT S PSBDTTM=$E(Y,1,18)
"RTN","PSBOCM",19,0)
 D GETPAR^PSBPAR("ALL","PSB ADMIN BEFORE")
"RTN","PSBOCM",20,0)
 S PSBB4=0 S:RESULTS(0)>0 PSBB4=+RESULTS(0)
"RTN","PSBOCM",21,0)
 D GETPAR^PSBPAR("ALL","PSB ADMIN AFTER")
"RTN","PSBOCM",22,0)
 S PSBAFT=0 S:RESULTS(0)>0 PSBAFT=+RESULTS(0)
"RTN","PSBOCM",23,0)
 K ^XTMP("PSBO",$J,"PSBLIST")
"RTN","PSBOCM",24,0)
 S (PSBPGNUM,PSBLNTOT,PSBTOT,PSBX1X)=""
"RTN","PSBOCM",25,0)
 K PSBLIST,PSBLIST2
"RTN","PSBOCM",26,0)
 S PSBXDFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOCM",27,0)
 S PSBLIST(PSBXDFN)=""
"RTN","PSBOCM",28,0)
 S (PSBX1X,PSBTOT)=0
"RTN","PSBOCM",29,0)
 F  S PSBX1X=$O(PSBLIST(PSBX1X)) Q:+PSBX1X=0  D
"RTN","PSBOCM",30,0)
 .D RPC^PSBCSUTL(.PSBAREA,PSBX1X)
"RTN","PSBOCM",31,0)
 .M PSBDATA=@PSBAREA
"RTN","PSBOCM",32,0)
 .S PSBX2X=1
"RTN","PSBOCM",33,0)
 .S PSBLIST2("ACTIVE")=0,PSBLIST2("FUTURE")=0,PSBLIST2("EXPIRED/DC'd")=0,PSBLIST2(" * ERROR * ")=0
"RTN","PSBOCM",34,0)
 .F  S PSBX2X=$O(PSBDATA(PSBX2X)) Q:+PSBX2X=0  D
"RTN","PSBOCM",35,0)
 ..S PSBDATA=PSBDATA(PSBX2X)
"RTN","PSBOCM",36,0)
 ..I $P(PSBDATA,U)="ORD" D  Q
"RTN","PSBOCM",37,0)
 ...K PSBDRUGN
"RTN","PSBOCM",38,0)
 ...S PSBORDN=$P(PSBDATA,U,3)
"RTN","PSBOCM",39,0)
 ...S PSBTB=$P(PSBDATA,U,29) S PSBTB=$S(PSBTB=1:"UD",PSBTB=2:"IVPB",PSBTB=3:"IV",1:" * ERROR * ")
"RTN","PSBOCM",40,0)
 ...S PSBTB(PSBORDN,PSBTB)=""
"RTN","PSBOCM",41,0)
 ...S PSBSTS=$P(PSBDATA,U,23) S PSBSTS=$S((PSBSTS="A")&(($P(PSBDATA,U,27)>PSBNOWX)):"Active",PSBSTS="H":"On Hold",PSBSTS="D":"Discontinued",PSBSTS="DE":"Discontinued (Edit)",(PSBSTS="E")!($P(PSBDATA,U,27)'>PSBNOWX):"Expired",1:" * ERROR * ")
"RTN","PSBOCM",42,0)
 ...S PSBSTS(PSBORDN,PSBSTS)=""
"RTN","PSBOCM",43,0)
 ...S PSBSTSX=$S($P(PSBDATA,U,27)'>PSBNOWX:"EXPIRED/DC'd",$$FMADD^XLFDT($P(PSBDATA,U,22),,,-PSBB4)'>PSBNOWX:"ACTIVE",$P(PSBDATA,U,22)>$$FMADD^XLFDT(PSBNOWX,,,PSBB4):"FUTURE",1:" * ERROR * ")
"RTN","PSBOCM",44,0)
 ...S PSBLIST2(PSBSTSX,$P(PSBDATA,U,9),PSBORDN)="" S PSBLIST2(PSBSTSX)=PSBLIST2(PSBSTSX)+1
"RTN","PSBOCM",45,0)
 ...S:PSBOCRIT[$E(PSBSTSX,1) PSBTOT=PSBTOT+1
"RTN","PSBOCM",46,0)
 ...S PSBSCHTY=$P(PSBDATA,U,6)
"RTN","PSBOCM",47,0)
 ...I PSBTB="IV" S PSBSCHTY=" "
"RTN","PSBOCM",48,0)
 ...S PSBSCHTY(PSBORDN,PSBSCHTY)=""
"RTN","PSBOCM",49,0)
 ...S PSBDOSR=$P(PSBDATA,U,10)_", "_$P(PSBDATA,U,11)
"RTN","PSBOCM",50,0)
 ...S PSBDOSR=$TR($E(PSBDOSR,1)," ")_$E(PSBDOSR,2,999)
"RTN","PSBOCM",51,0)
 ...S PSBDOSR(PSBORDN,PSBDOSR)="" K PSBOMDR(PSBORDN)
"RTN","PSBOCM",52,0)
 ...S PSBSCHD=$P(PSBDATA,U,7) I PSBSCHD="" S PSBSCHD=" "
"RTN","PSBOCM",53,0)
 ...S PSBSCHD(PSBORDN,PSBSCHD)=""
"RTN","PSBOCM",54,0)
 ...S PSBNXTX1=$$NEXTADM^PSBCSUTX(PSBX1X,PSBORDN)
"RTN","PSBOCM",55,0)
 ...I PSBSTS["Hold" S PSBNXTX2="Provider Hold"
"RTN","PSBOCM",56,0)
 ...I PSBSTS'["Hold",(PSBNXTX1]"") D
"RTN","PSBOCM",57,0)
 ....I PSBNOWX>$$FMADD^XLFDT(PSBNXTX1,,,PSBAFT) S PSBNXTX2="MISSED "_PSBNXTX1
"RTN","PSBOCM",58,0)
 ....E  S:+PSBNXTX1>0 PSBNXTX2="DUE "_PSBNXTX1
"RTN","PSBOCM",59,0)
 ...S PSBNXTX1=$$FMTDT^PSBOCE1(PSBNXTX1)
"RTN","PSBOCM",60,0)
 ...I ("^P^OC^O"[("^"_PSBSCHTY))!(PSBTB="IV")!(PSBSTS["Discontinued")!(PSBSTS["Expired") S:PSBSTS'["Hold" PSBNXTX2=" "
"RTN","PSBOCM",61,0)
 ...S PSBNXTX(PSBORDN,$G(PSBNXTX2," "))=""
"RTN","PSBOCM",62,0)
 ...; ** SPECIAL INSTRUCTIONS  **
"RTN","PSBOCM",63,0)
 ...S PSBX2X=PSBX2X+1
"RTN","PSBOCM",64,0)
 ...S PSBSI=$P(PSBDATA(PSBX2X),U,2)
"RTN","PSBOCM",65,0)
 ...I PSBSI]" " S PSBSI(PSBORDN,PSBSI)=""
"RTN","PSBOCM",66,0)
 ...S PSBOSTDT=$P(PSBDATA,U,22)
"RTN","PSBOCM",67,0)
 ...S PSBOSTDT(PSBORDN,PSBOSTDT)=""
"RTN","PSBOCM",68,0)
 ...S PSBOSPDT=$P(PSBDATA,U,27)
"RTN","PSBOCM",69,0)
 ...S PSBOSPDT(PSBORDN,PSBOSPDT)=""
"RTN","PSBOCM",70,0)
 ..I "^DD^ADD^SOL"[(U_$P(PSBDATA(PSBX2X),U)) D  Q
"RTN","PSBOCM",71,0)
 ...F I=PSBX2X:1 S PSBDATA1=PSBDATA(I) D  Q:$D(PSBOMDR(PSBORDN))
"RTN","PSBOCM",72,0)
 ....I "^DD^ADD^SOL"[(U_$P(PSBDATA1,U)) S PSBX2X=I S PSBDRUGN=$G(PSBDRUGN,"")_$P(PSBDATA1,U,3)_", " Q
"RTN","PSBOCM",73,0)
 ....S $E(PSBDRUGN,$L(PSBDRUGN)-1)="" S PSBDRUGN(PSBORDN,$E(PSBDRUGN,1,250))=PSBDRUGN
"RTN","PSBOCM",74,0)
 ....S PSBOMDR(PSBORDN,$E((PSBDRUGN_"; "_PSBDOSR),1,250))=PSBDRUGN_"; "_PSBDOSR
"RTN","PSBOCM",75,0)
 ..I $P(PSBDATA,U)="END" Q
"RTN","PSBOCM",76,0)
 ..I $P(PSBDATA(PSBX2X),U)="ORF" D  Q
"RTN","PSBOCM",77,0)
 ...S PSBDATA=PSBDATA(PSBX2X)
"RTN","PSBOCM",78,0)
 ...S:$P(PSBDATA,U,2)]"" PSBFLGD(PSBORDN,$P(PSBDATA,U,3)_" - "_$P(PSBDATA,U,4))=""
"RTN","PSBOCM",79,0)
 ..I ($P(PSBDATA,U)="ADM")&($P(PSBDATA,U,4)]"") D
"RTN","PSBOCM",80,0)
 ...S PSBXID=$P(PSBDATA,U,6)_U_$P(PSBDATA,U,4),PSBADM(PSBORDN,(-1*($P(PSBDATA,U,6))),PSBXID)=PSBDATA
"RTN","PSBOCM",81,0)
 ...S PSBTEST="" F  S PSBTEST=$O(PSBFLGD(PSBORDN,PSBTEST)) Q:PSBTEST=""  I $P(PSBTEST,":")="NOX" K PSBFLGD(PSBORDN,PSBTEST) Q
"RTN","PSBOCM",82,0)
 ...I $O(PSBSCHTY(PSBORDN,""))="P" S PSBPRNR(PSBORDN,$P(PSBDATA,U,4))=$P(PSBDATA,U,9)
"RTN","PSBOCM",83,0)
 ...I $P(PSBDATA,U,3)]"" S PSBBID(PSBORDN,$P(PSBDATA,U,4))=$P(PSBDATA,U,3)
"RTN","PSBOCM",84,0)
 ...S:PSBXFLG PSBLGD(PSBORDN,"X","INITIALS",$P(PSBDATA,U,8))=""
"RTN","PSBOCM",85,0)
 ...K PSBDATA(PSBX2X)
"RTN","PSBOCM",86,0)
 ...I ($P(PSBDATA(PSBX2X+1),U)="CMT")  F  S PSBDATA=PSBDATA(PSBX2X+1) Q:($P(PSBDATA,U)'="CMT")  D
"RTN","PSBOCM",87,0)
 ....S PSBX2X=PSBX2X+1
"RTN","PSBOCM",88,0)
 ....S PSBDATA=PSBDATA(PSBX2X)
"RTN","PSBOCM",89,0)
 ....K PSBDATA(PSBX2X)
"RTN","PSBOCM",90,0)
 ....S:$P(PSBDATA,U,3)]"" PSBPRNEF(PSBORDN,$P(PSBXID,U,2))=$P(PSBDATA,U,3)
"RTN","PSBOCM",91,0)
 ....I 'PSBCFLG S PSBDATA=PSBDATA(PSBX2X+1) Q
"RTN","PSBOCM",92,0)
 ....I $P(PSBDATA,U,2)'="" D
"RTN","PSBOCM",93,0)
 .....S PSBLGD(PSBORDN,"C","INITIALS",$P(PSBDATA,U,4))=""
"RTN","PSBOCM",94,0)
 .....S PSBCMT(PSBORDN,$P(PSBXID,U,2),(-1*$P(PSBDATA,U,6)),PSBX2X)=PSBDATA
"RTN","PSBOCM",95,0)
 I +PSBTOT=0 K PSBLIST,^XTMP("PSBO",$J,"PSBLIST")
"RTN","PSBOCM",96,0)
 D CREATHDR^PSBOCM1
"RTN","PSBOCM",97,0)
 D SUBHDR^PSBOCE
"RTN","PSBOCM",98,0)
 D BLDRPT
"RTN","PSBOCM",99,0)
 D WRTRPT^PSBOCM1
"RTN","PSBOCM",100,0)
 Q
"RTN","PSBOCM",101,0)
BLDRPT ; Buld REPORT DATA
"RTN","PSBOCM",102,0)
 S PSBTOPHD=PSBLNTOT-2
"RTN","PSBOCM",103,0)
 K PSBL2ULN
"RTN","PSBOCM",104,0)
 I '$D(PSBLIST2) D  Q
"RTN","PSBOCM",105,0)
 .S PSBOUTP(0,PSBLNTOT)="W !!,""<<<< NO ORDERS TO DISPLAY >>>>"",!!"
"RTN","PSBOCM",106,0)
 S PSBMORE=5 F PSBX1X="ACTIVE","FUTURE","EXPIRED/DC'd"," * ERROR * " D
"RTN","PSBOCM",107,0)
 .I PSBX1X'=" * ERROR * " S PSBSUM=PSBX1X_" ["_PSBLIST2(PSBX1X)_$S(PSBLIST2(PSBX1X)=1:" Order",1:" Orders")_"]" S PSBOUTP($$PGTOT,PSBLNTOT)="W !!,"""_PSBSUM_""""
"RTN","PSBOCM",108,0)
 .Q:PSBLIST2(PSBX1X)=0
"RTN","PSBOCM",109,0)
 .Q:PSBOCRIT'[$E(PSBX1X,1)
"RTN","PSBOCM",110,0)
 .S:$L(PSBSUM)>$G(PSBL2ULN,0) PSBL2ULN=$L(PSBSUM)
"RTN","PSBOCM",111,0)
 .S PSBOUTP($$PGTOT(2),PSBLNTOT)="W !,$TR($J("""",PSBL2ULN),"" "",""=""),!"
"RTN","PSBOCM",112,0)
 .S PSBOUTP($$PGTOT,PSBLNTOT)="W !"
"RTN","PSBOCM",113,0)
 .K PSBDATA
"RTN","PSBOCM",114,0)
 .S X0="",PSBTOT1=0
"RTN","PSBOCM",115,0)
 .F  S X0=$O(PSBLIST2(PSBX1X,X0))  Q:X0=""  S PSBX2X="" F  S PSBX2X=$O(PSBLIST2(PSBX1X,X0,PSBX2X)) Q:PSBX2X=""  D
"RTN","PSBOCM",116,0)
 ..M PSBLGD("INITIALS")=PSBLGD(PSBX2X,"X","INITIALS") M PSBLGD("INITIALS")=PSBLGD(PSBX2X,"C","INITIALS")
"RTN","PSBOCM",117,0)
 ..S PSBDATA(1,1)=$O(PSBTB(PSBX2X,""))
"RTN","PSBOCM",118,0)
 ..S PSBDATA(1,2)=$O(PSBSTS(PSBX2X,""))
"RTN","PSBOCM",119,0)
 ..S PSBDATA(1,3)=$O(PSBSCHTY(PSBX2X,""))
"RTN","PSBOCM",120,0)
 ..S Y0=$O(PSBOMDR(PSBX2X,"")) I Y0]"" S PSBDATA(1,4)="("_X0_")",PSBDATA(1,4,0)=PSBOMDR(PSBX2X,Y0)
"RTN","PSBOCM",121,0)
 ..S PSBDATA(1,5)=$O(PSBSCHD(PSBX2X,""))
"RTN","PSBOCM",122,0)
 ..S PSBDATA(1,6)=$O(PSBNXTX(PSBX2X,""))
"RTN","PSBOCM",123,0)
 ..S:PSBDATA(1,6)'["Hold" $P(PSBDATA(1,6)," ",2)=$$FMTDT^PSBOCE1($P(PSBDATA(1,6)," ",2))
"RTN","PSBOCM",124,0)
 ..S PSBDATA(1,7)=$$FMTDT^PSBOCE1($O(PSBOSTDT(PSBX2X,"")))
"RTN","PSBOCM",125,0)
 ..S PSBDATA(1,8)=$$FMTDT^PSBOCE1($E($O(PSBOSPDT(PSBX2X,"")),1,12))
"RTN","PSBOCM",126,0)
 ..S PSBSIDAT(1)=$O(PSBSI(PSBX2X,""))
"RTN","PSBOCM",127,0)
 ..S PSBTOT1=PSBTOT1+1
"RTN","PSBOCM",128,0)
 ..K PSBDATA(2),PSBDATA(3),PSBSILN
"RTN","PSBOCM",129,0)
 ..D BUILDLN^PSBOCM1,SIOPI(.PSBSIDAT,PSBTAB8,$S(PSBX2X["V":"Other Print Info:",1:""))
"RTN","PSBOCM",130,0)
 ..I $D(PSBRPLN) S PSBMORE=$O(PSBRPLN(""),-1)+6 I $D(PSBSILN) S PSBMORE=PSBMORE+$O(PSBSILN(""),-1)
"RTN","PSBOCM",131,0)
 ..K PSB1,X I $D(PSBFLGD(PSBX2X)) S PSB="" F  S PSB=$O(PSBFLGD(PSBX2X,PSB)) Q:PSB=""  I ($P(PSB,":")'="NOX")&($P(PSB,":")'="STAT") S PSB1=$G(PSB1,"")_PSB
"RTN","PSBOCM",132,0)
 ..S PSBCNT=PSBTOT1_"   "_$G(PSB1,"")
"RTN","PSBOCM",133,0)
 ..S PSBOUTP($$PGTOT,PSBLNTOT)="W """_PSBCNT_""""
"RTN","PSBOCM",134,0)
 ..S I="" F  S I=$O(PSBRPLN(I)) Q:+I=0  D
"RTN","PSBOCM",135,0)
 ...S PSBOUTP($$PGTOT,PSBLNTOT)="W !,"""_PSBRPLN(I)_""""
"RTN","PSBOCM",136,0)
 ..S I="" F  S I=$O(PSBSILN(I)) Q:+I=0  D
"RTN","PSBOCM",137,0)
 ...S PSBOUTP($$PGTOT,PSBLNTOT)="W !,"""_PSBSILN(I)_""""
"RTN","PSBOCM",138,0)
 ..S PSBOUTP($$PGTOT(2),PSBLNTOT)="W !,$TR($J("""",PSBTAB8),"" "",""-""),!"
"RTN","PSBOCM",139,0)
 ..K PSBRPLN,PSBDATA,PSBSILN
"RTN","PSBOCM",140,0)
 D:+PSBTOT>0 LGD
"RTN","PSBOCM",141,0)
 Q
"RTN","PSBOCM",142,0)
PGTOT(X) ;mnt PAGE Number
"RTN","PSBOCM",143,0)
 I (PSBLNTOT+PSBMORE)>(IOSL) D PGC^PSBOCE1
"RTN","PSBOCM",144,0)
 I $G(X,1) S PSBLNTOT=PSBLNTOT+$G(X,1),PSBMORE=PSBMORE-$G(X,1)
"RTN","PSBOCM",145,0)
 Q PSBPGNUM
"RTN","PSBOCM",146,0)
SIOPI(PSBXSI,TAB,Y) ;
"RTN","PSBOCM",147,0)
 Q:$G(PSBXSI(1))']""
"RTN","PSBOCM",148,0)
 I $G(Y,"")']"" S Y="Special Instructions: "
"RTN","PSBOCM",149,0)
 S PSBXSI(1)="  "_Y_PSBXSI(1)
"RTN","PSBOCM",150,0)
 N X
"RTN","PSBOCM",151,0)
 K J,TXT1,TXT2 S J(0)=""
"RTN","PSBOCM",152,0)
 S J=($O(J(""),-1)+1) S PSBSILN(J)="",J(J)="" S J=($O(J(""),-1)+1)
"RTN","PSBOCM",153,0)
 F X=1:1 Q:'$D(PSBXSI(X))  D
"RTN","PSBOCM",154,0)
 .S TXT1=PSBXSI(X)
"RTN","PSBOCM",155,0)
 .I ($L(TXT1)>0),$F(TXT1,"""")>1 D
"RTN","PSBOCM",156,0)
 ..S TXT1=$TR(TXT1,"""","^")
"RTN","PSBOCM",157,0)
 ..I $L(TXT1)+5'<TAB S TXT2=$E(TXT1,TAB-9,999),TXT1=$E(TXT1,1,TAB-10)
"RTN","PSBOCM",158,0)
 ..I $L(TXT1,"^")>1 F Y=1:1:$L(TXT1,"^")-1 S $P(TXT1,"^",Y)=$P(TXT1,"^",Y)_""""
"RTN","PSBOCM",159,0)
 ..I $D(TXT2) I $L(TXT2,"^")>1 F X=1:1:$L(TXT2,"^")-1 S $P(TXT2,"^",X)=$P(TXT2,"^",X)_""""
"RTN","PSBOCM",160,0)
 ..S TXT1=$TR(TXT1,"^","""") I $D(TXT2) S TXT2=$TR(TXT2,"^","""")
"RTN","PSBOCM",161,0)
 .S $E(PSBSILN(J),5,999)=TXT1,J(J)="",J=J+1
"RTN","PSBOCM",162,0)
 .I $D(TXT2) S $E(PSBSILN(J),5,999)=TXT2,J(J)="",J=J+1
"RTN","PSBOCM",163,0)
 S $E(PSBSILN(J),3,999)=" ",J(J)="",J=J+1
"RTN","PSBOCM",164,0)
 Q
"RTN","PSBOCM",165,0)
LGD ; Create Report's Legend
"RTN","PSBOCM",166,0)
 K PSBLGDO
"RTN","PSBOCM",167,0)
 S PSBLGD("ORDER TYPES","C")="Continuous"
"RTN","PSBOCM",168,0)
 S PSBLGD("ORDER TYPES","O")="One Time"
"RTN","PSBOCM",169,0)
 S PSBLGD("ORDER TYPES","OC")="On Call"
"RTN","PSBOCM",170,0)
 S PSBLGD("ORDER TYPES","P")="PRN"
"RTN","PSBOCM",171,0)
 S PSB=0 F  S PSB=$O(PSBLGD("INITIALS",PSB)) Q:+PSB=0  D
"RTN","PSBOCM",172,0)
 .S PSBINIT=$$GET1^DIQ(200,PSB_",","INITIAL"),PSBLGD("INITIALS",$S(PSBINIT']" ":"*n/a*",1:PSBINIT))=$$GET1^DIQ(200,PSB_",","NAME")
"RTN","PSBOCM",173,0)
 .K PSBLGD("INITIALS",PSB)
"RTN","PSBOCM",174,0)
 S PSBPGNUM=$O(PSBOUTP(""),-1),PSBLGDO(0)="REPORT LEGEND"
"RTN","PSBOCM",175,0)
 S PSBLGDO(1)=""
"RTN","PSBOCM",176,0)
 S PSBLGDO(2)=$S($G(PSBNO,0):"",1:"SCHEDULE TYPES")
"RTN","PSBOCM",177,0)
 S PSBLGDO(3)=""
"RTN","PSBOCM",178,0)
 I '$G(PSBNO,0) S X1="",X2=3 F  S X1=$O(PSBLGD("ORDER TYPES",X1)) Q:X1=""  S X2=X2+1,PSBLGDO(X2)=X1,$E(PSBLGDO(X2),5)="- "_PSBLGD("ORDER TYPES",X1)
"RTN","PSBOCM",179,0)
 I $D(PSBLGD("INITIALS")) S $E(PSBLGDO(2),35)="INITIALS" S X1="",X2=3 F  S X1=$O(PSBLGD("INITIALS",X1)) Q:X1=""  S X2=X2+1,$E(PSBLGDO(X2),35)=X1,$E(PSBLGDO(X2),40)="- "_PSBLGD("INITIALS",X1)
"RTN","PSBOCM",180,0)
 S (PSBMORE,X0)=10+($O(PSBLGDO(""),-1))
"RTN","PSBOCM",181,0)
 I (PSBLNTOT+PSBMORE)'<IOSL S PSBLNTOT=PSBTOPHD-2,PSBPGNUM=PSBPGNUM+1
"RTN","PSBOCM",182,0)
 I IOSL<1000 S X2=PSBLNTOT F  Q:X2'<(IOSL-(X0+3))  S PSBOUTP($$PGTOT,PSBLNTOT)="W !",X2=X2+1
"RTN","PSBOCM",183,0)
 S PSBMORE=X0
"RTN","PSBOCM",184,0)
 S PSBOUTP($$PGTOT(2),PSBLNTOT)="W !,"""_$TR($J("",IOM)," ","=")_""",!"
"RTN","PSBOCM",185,0)
 F X1=0:1 Q:'$D(PSBLGDO(X1))  S PSBOUTP($$PGTOT,PSBLNTOT)="W !,"""_$G(PSBLGDO(X1)," ")_""""
"RTN","PSBOCM",186,0)
 S PSBOUTP($$PGTOT(2),PSBLNTOT)="W !,"""_$TR($J("",IOM)," ","=")_""",!"
"RTN","PSBOCM",187,0)
 Q
"RTN","PSBOCM1")
0^12^B22801470^B20780748
"RTN","PSBOCM1",1,0)
PSBOCM1 ;BIRMINGHAM/TEJ-COVERSHEET MEDICATION OVERVIEW REPORT ;Mar 2004
"RTN","PSBOCM1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**32,50**;Mar 2004;Build 78
"RTN","PSBOCM1",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOCM1",4,0)
 ;
"RTN","PSBOCM1",5,0)
BUILDLN ; Constr recs
"RTN","PSBOCM1",6,0)
 K J S J(0)="" F PSBFLD=1:1:8 S J=1 D FORMDAT(PSBFLD) S J($O(PSBRPLN(""),-1))=""
"RTN","PSBOCM1",7,0)
 ; Write administration info...
"RTN","PSBOCM1",8,0)
 Q:'PSBXFLG
"RTN","PSBOCM1",9,0)
 S J=($O(J(""),-1)+1),PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1
"RTN","PSBOCM1",10,0)
 S (N,Y)="",J=($O(J(""),-1)+1)
"RTN","PSBOCM1",11,0)
 F  S Y=$O(PSBADM(PSBX2X,Y)) Q:Y']""  D
"RTN","PSBOCM1",12,0)
 .F  S N=$O(PSBADM(PSBX2X,Y,N)) Q:N']""  D
"RTN","PSBOCM1",13,0)
 ..I $D(PSBBID(PSBX2X,$P(N,U,2))) S PSBDATA(2,0)="BAG ID: "_PSBBID(PSBX2X,$P(N,U,2))
"RTN","PSBOCM1",14,0)
 ..S $E(PSBDATA(2,0),25)="ACTION BY: "_$P(PSBADM(PSBX2X,Y,N),U,7)_" "_$$FMTDT^PSBOCE1($E($P(PSBADM(PSBX2X,Y,N),U,6),1,12))
"RTN","PSBOCM1",15,0)
 ..S X=$P(PSBADM(PSBX2X,Y,N),U,5) S $E(PSBDATA(2,0),56)="ACTION: "_$S(X="G":"GIVEN",X="R":"REFUSED",X="RM":"REMOVED",X="H":"HELD",X="S":"STOPPED",X="I":"INFUSING",X="C":"COMPLETED",X="M":"MISSING DOSE",X=" ":"*UNKNOWN*",1:" ")
"RTN","PSBOCM1",16,0)
 ..I $D(PSBPRNR(PSBX2X)) S $E(PSBDATA(2,0),72)="PRN REASON: "_PSBPRNR(PSBX2X,$P(N,U,2))
"RTN","PSBOCM1",17,0)
 ..I $G(PSBDATA(2,0))]" " D WRAPPER(1,132-1,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCM1",18,0)
 ..N PSBEIECMT S PSBEIECMT="" I $D(PSBPRNEF(PSBX2X,$P(N,U,2))),$P($G(PSBRPT(.2)),U,8)=0 S PSBEIECMT=$$PRNEFF^PSBO(PSBEIECMT,$P(N,U,2))
"RTN","PSBOCM1",19,0)
 ..I $D(PSBPRNEF(PSBX2X,$P(N,U,2))) S PSBDATA(2,0)="PRN EFFECTIVENESS: "_PSBPRNEF(PSBX2X,$P(N,U,2))_PSBEIECMT
"RTN","PSBOCM1",20,0)
 ..I $G(PSBDATA(2,0))]" " D WRAPPER(30,132-30,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCM1",21,0)
 ..I ('PSBCFLG)!('$D(PSBCMT(PSBX2X,$P(N,U,2)))) S PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1 Q
"RTN","PSBOCM1",22,0)
 ..S X="" F   S X=$O(PSBCMT(PSBX2X,$P(N,U,2),X)) Q:X']""  D
"RTN","PSBOCM1",23,0)
 ...N PSBDAT S PSBDAT="" F  S PSBDAT=$O(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT)) Q:PSBDAT']""  D
"RTN","PSBOCM1",24,0)
 ....S PSBDATA(2,0)="COMMENT BY: "_$S($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,5)]"":$P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,5)_" "_$$FMTDT^PSBOCE1($E($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,6),1,12)),1:" n/a ")
"RTN","PSBOCM1",25,0)
 ....S PSBDATA(2,0)=PSBDATA(2,0)_"  COMMENT: "_$S($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,2)]"":$P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,2),1:" ")
"RTN","PSBOCM1",26,0)
 ....I $G(PSBDATA(2,0))]" " D WRAPPER(30,132-30,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCM1",27,0)
 ..S PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1
"RTN","PSBOCM1",28,0)
 Q
"RTN","PSBOCM1",29,0)
FORMDAT(FLD) ;
"RTN","PSBOCM1",30,0)
 K PSBVAL
"RTN","PSBOCM1",31,0)
 Q:'$D(PSBDATA(1,FLD))
"RTN","PSBOCM1",32,0)
 S PSBVAL=PSBDATA(1,FLD)
"RTN","PSBOCM1",33,0)
 D WRAPPER(@("PSBTAB"_(FLD-1))+1,((@("PSBTAB"_(FLD))-(@("PSBTAB"_(FLD-1))+1))),PSBVAL)
"RTN","PSBOCM1",34,0)
 I FLD=4 S J=$O(J(""),-1)+1,PSBVAL=PSBDATA(1,4,0) D WRAPPER(@("PSBTAB"_(FLD-1))+1,((@("PSBTAB"_(FLD))-(@("PSBTAB"_(FLD-1))+1))),PSBVAL)
"RTN","PSBOCM1",35,0)
 Q
"RTN","PSBOCM1",36,0)
WRAPPER(X,Y,Z) ;  Text WRAP
"RTN","PSBOCM1",37,0)
 N PSB
"RTN","PSBOCM1",38,0)
 I ($L(Z)>0),$F(Z,"""")>1 F  Q:$F(Z,"""")'>1  S Z=$TR(Z,"""","^")
"RTN","PSBOCM1",39,0)
 F  Q:'$L(Z)  D
"RTN","PSBOCM1",40,0)
 .I $L(Z)<Y S $E(PSBRPLN(J),X)=Z S Z="" D  Q
"RTN","PSBOCM1",41,0)
 ..I $L(PSBRPLN(J),"^")>1 F X=1:1:$L(PSBRPLN(J),"^")-1 S $P(PSBRPLN(J),"^",X)=$P(PSBRPLN(J),"^",X)_""""
"RTN","PSBOCM1",42,0)
 ..S PSBRPLN(J)=$TR(PSBRPLN(J),"^","""")
"RTN","PSBOCM1",43,0)
 .F PSB=Y:-1:0 Q:($E(Z,PSB)=" ")  Q:($E(Z,PSB)="-")
"RTN","PSBOCM1",44,0)
 .S:PSB<1 PSB=Y
"RTN","PSBOCM1",45,0)
 .S $E(PSBRPLN(J),X)=$E(Z,1,PSB)
"RTN","PSBOCM1",46,0)
 .S Z=$E(Z,PSB+1,250)
"RTN","PSBOCM1",47,0)
 .I $L(PSBRPLN(J),"^")>1 F X=1:1:$L(PSBRPLN(J),"^")-1 S $P(PSBRPLN(J),"^",X)=$P(PSBRPLN(J),"^",X)_""""
"RTN","PSBOCM1",48,0)
 .S PSBRPLN(J)=$TR(PSBRPLN(J),"^","""")
"RTN","PSBOCM1",49,0)
 .S J=J+1,J(J)=""
"RTN","PSBOCM1",50,0)
 Q ""
"RTN","PSBOCM1",51,0)
CREATHDR ;
"RTN","PSBOCM1",52,0)
 K PSBHD1,PSBHD2
"RTN","PSBOCM1",53,0)
 I IOM'<132 S PSBHD1=$P($T(HD132A),"~",2),PSBHD2=$P($T(HD132B),";",2),PSBBLANK=$P($T(C132BLK),";",2)
"RTN","PSBOCM1",54,0)
 E  S PSBHD1="THIS REPORT SUPPORTS >131 CHAR./LINE PRINT FORMATS ONLY" Q
"RTN","PSBOCM1",55,0)
 ; reset tabs
"RTN","PSBOCM1",56,0)
 S PSBTAB0=1 F PSBI=0:1:($L(PSBHD1,"|")-1) S:PSBI>0 @("PSBTAB"_PSBI)=($F(PSBHD1,"|",@("PSBTAB"_(PSBI-1))+1))-1
"RTN","PSBOCM1",57,0)
 S PSBPGNUM=1
"RTN","PSBOCM1",58,0)
 D HDR
"RTN","PSBOCM1",59,0)
 Q
"RTN","PSBOCM1",60,0)
HD132A ;~VDL  |   Order    |Type|       Medication; Dosage, Route      |  Schedule   |      Next Action      |  Order Start  |   Order Stop  |
"RTN","PSBOCM1",61,0)
 Q
"RTN","PSBOCM1",62,0)
HD132B ;Tab  |   Status   |    |                                      |             |                       |   Date        |    Date       |
"RTN","PSBOCM1",63,0)
 Q
"RTN","PSBOCM1",64,0)
C132BLK ;;
"RTN","PSBOCM1",65,0)
 Q
"RTN","PSBOCM1",66,0)
WRTRPT ;  writ
"RTN","PSBOCM1",67,0)
 I $O(PSBOUTP(""),-1)<1 D  Q
"RTN","PSBOCM1",68,0)
 .X PSBOUTP($O(PSBOUTP(""),-1),14)
"RTN","PSBOCM1",69,0)
 .D FTR
"RTN","PSBOCM1",70,0)
 S PSBPGNUM=1
"RTN","PSBOCM1",71,0)
 S PSBZ="" F  S PSBZ=$O(PSBOUTP(PSBZ)) Q:PSBZ=""  D
"RTN","PSBOCM1",72,0)
 .I PSBPGNUM'=PSBZ D FTR S PSBPGNUM=PSBZ D HDR,SUBHDR^PSBOCE
"RTN","PSBOCM1",73,0)
 .S PSBX2X="" F  S PSBX2X=$O(PSBOUTP(PSBZ,PSBX2X)) Q:PSBX2X=""  D
"RTN","PSBOCM1",74,0)
 ..X PSBOUTP(PSBZ,PSBX2X)
"RTN","PSBOCM1",75,0)
 D FTR
"RTN","PSBOCM1",76,0)
 K ^XTMP("PSBO",$J,"PSBLIST"),PSBOUTP
"RTN","PSBOCM1",77,0)
 Q
"RTN","PSBOCM1",78,0)
HDR ;  Header
"RTN","PSBOCM1",79,0)
 W:$Y>1 @IOF
"RTN","PSBOCM1",80,0)
 W:$X>1 !
"RTN","PSBOCM1",81,0)
 S PSBRPNM="BCMA COVERSHEET MEDICATION OVERVIEW REPORT"
"RTN","PSBOCM1",82,0)
 D:$P(PSBRPT(.1),U,1)="P"
"RTN","PSBOCM1",83,0)
 .S PSBHDR(0)=PSBRPNM
"RTN","PSBOCM1",84,0)
 .S PSBHDR(1)="Order Status(es): --"
"RTN","PSBOCM1",85,0)
 .F Y=4,5,7,8 I $P(PSBFUTR,U,Y) S $P(PSBHDR(1),": ",2)=$P(PSBHDR(1),": ",2)_$S(PSBHDR(1)["--":"",1:"/ ")_$P("^^^Future^Active^^Expired^DC'd^^^^^^^^^^",U,Y)_" " S PSBHDR(1)=$TR(PSBHDR(1),"-","")
"RTN","PSBOCM1",86,0)
 .I $P(PSBFUTR,U,11) S PSBHDR(2)="Include Action(s)"_$S(PSBCFLG:" & Comments/Reasons",1:"")
"RTN","PSBOCM1",87,0)
 .D PT^PSBOHDR(PSBXDFN,.PSBHDR)
"RTN","PSBOCM1",88,0)
 Q
"RTN","PSBOCM1",89,0)
FTR ;  Fter
"RTN","PSBOCM1",90,0)
 D PTFTR^PSBOHDR()
"RTN","PSBOCM1",91,0)
 S PSBPG="Page: "_PSBPGNUM_" of "_$S($O(PSBOUTP(""),-1)=0:1,1:$O(PSBOUTP(""),-1))
"RTN","PSBOCM1",92,0)
 S PSBPGRM=PSBTAB8-($L(PSBPG))
"RTN","PSBOCM1",93,0)
 W !,PSBRPNM,"     ",?(PSBPGRM-($L(PSBDTTM)+3)),PSBDTTM_"  "_PSBPG
"RTN","PSBOCM1",94,0)
 Q
"RTN","PSBOCP")
0^7^B77940079^B73770736
"RTN","PSBOCP",1,0)
PSBOCP ;BIRMINGHAM/TEJ-COVERSHEET PRN OVERVIEW REPORT ;Mar 2004
"RTN","PSBOCP",2,0)
 ;;3.0;BAR CODE MED ADMIN;**32,50**;Mar 2004;Build 78
"RTN","PSBOCP",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOCP",4,0)
 ;
"RTN","PSBOCP",5,0)
 ; Reference/IA
"RTN","PSBOCP",6,0)
 ; File 4/10090
"RTN","PSBOCP",7,0)
EN ; Entry Point
"RTN","PSBOCP",8,0)
 N PSBX1X,RESULTS,RESULT,PSBFUTR
"RTN","PSBOCP",9,0)
 S PSBFUTR=$TR(PSBRPT(1),"~","^")
"RTN","PSBOCP",10,0)
 S (PSBOCRIT,PSBXFLG,PSBCFLG)=""        ;  Order Status search criteria - "A"ctive, "D"C ed, "E"xpired"
"RTN","PSBOCP",11,0)
 S:$P(PSBFUTR,U,7) PSBOCRIT=PSBOCRIT_"D" S:$P(PSBFUTR,U,8) PSBOCRIT=PSBOCRIT_"E" S:$P(PSBFUTR,U,5) PSBOCRIT=PSBOCRIT_"A"
"RTN","PSBOCP",12,0)
 S:$P(PSBFUTR,U,4) PSBOCRIT=PSBOCRIT_"F"
"RTN","PSBOCP",13,0)
 S:$P(PSBFUTR,U,11) PSBXFLG=1
"RTN","PSBOCP",14,0)
 I $D(PSBRPT(.2)) I $P(PSBRPT(.2),U,8) S PSBCFLG=1
"RTN","PSBOCP",15,0)
 K PSBSRTBY,PSBCMT,PSBADM,PSBDATA,PSBOUTP,PSBLGD
"RTN","PSBOCP",16,0)
 S PSBSORT=1
"RTN","PSBOCP",17,0)
 D NOW^%DTC S (Y,PSBNOWX)=% D DD^%DT S PSBDTTM=Y
"RTN","PSBOCP",18,0)
 D GETPAR^PSBPAR("ALL","PSB ADMIN BEFORE")
"RTN","PSBOCP",19,0)
 S PSBB4=0 S:RESULTS(0)>0 PSBB4=+RESULTS(0)
"RTN","PSBOCP",20,0)
 D GETPAR^PSBPAR("ALL","PSB ADMIN AFTER")
"RTN","PSBOCP",21,0)
 S PSBAFT=0 S:RESULTS(0)>0 PSBAFT=+RESULTS(0)
"RTN","PSBOCP",22,0)
 K ^XTMP("PSBO",$J,"PSBLIST")
"RTN","PSBOCP",23,0)
 S (PSBPGNUM,PSBLNTOT,PSBTOT,PSBX1X)=""
"RTN","PSBOCP",24,0)
 K PSBLIST,PSBLIST2
"RTN","PSBOCP",25,0)
 S PSBXDFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOCP",26,0)
 S PSBLIST(PSBXDFN)=""
"RTN","PSBOCP",27,0)
 S (PSBX1X,PSBTOT)=0
"RTN","PSBOCP",28,0)
 F  S PSBX1X=$O(PSBLIST(PSBX1X)) Q:+PSBX1X=0  D
"RTN","PSBOCP",29,0)
 .D RPC^PSBCSUTL(.PSBAREA,PSBX1X)
"RTN","PSBOCP",30,0)
 .M PSBDATA=@PSBAREA
"RTN","PSBOCP",31,0)
 .S PSBX2X=1
"RTN","PSBOCP",32,0)
 .S (PSBLIST2("ACTIVE"),PSBLIST2("FUTURE"),PSBLIST2("EXPIRED/DC'd"),PSBLIST2(" * ERROR * "))=0
"RTN","PSBOCP",33,0)
 .F  S PSBX2X=$O(PSBDATA(PSBX2X)) Q:+PSBX2X=0  D
"RTN","PSBOCP",34,0)
 ..S PSBDATA=PSBDATA(PSBX2X)
"RTN","PSBOCP",35,0)
 ..I ($P(PSBDATA,U)="ORD") I $P(PSBDATA,U,6)'="P" F  S PSBX2X=$O(PSBDATA(PSBX2X)) S PSBDATA=PSBDATA(PSBX2X) Q:$P(PSBDATA,U)="END"
"RTN","PSBOCP",36,0)
 ..I ($P(PSBDATA,U)="ORD") K PSBORDN  D  Q
"RTN","PSBOCP",37,0)
 ...K PSBDRUGN
"RTN","PSBOCP",38,0)
 ...S PSBSCHTY="P"
"RTN","PSBOCP",39,0)
 ...S PSBORDN=$P(PSBDATA,U,3)
"RTN","PSBOCP",40,0)
 ...S PSBTB=$P(PSBDATA,U,29) S PSBTB=$S(PSBTB=1:"UD",PSBTB=2:"IVPB",PSBTB=3:"IV",1:" * ERROR * ")
"RTN","PSBOCP",41,0)
 ...S PSBTB(PSBORDN,PSBTB)=""
"RTN","PSBOCP",42,0)
 ...S PSBSTS1=$P(PSBDATA,U,23)
"RTN","PSBOCP",43,0)
 ...S PSBSTS=$S((PSBSTS1="A")&(($P(PSBDATA,U,27)>PSBNOWX)):"Active",PSBSTS1="H":"Hold",PSBSTS1="D":"Discontinued",PSBSTS1="DE":"Discontinued (Edit)",(PSBSTS1="E")!($P(PSBDATA,U,27)'>PSBNOWX):"Expired",1:" * ERROR * ")
"RTN","PSBOCP",44,0)
 ...S PSBSTS(PSBORDN,PSBSTS)=""
"RTN","PSBOCP",45,0)
 ...S V=$$FMADD^XLFDT(PSBNOWX,,,PSBB4)
"RTN","PSBOCP",46,0)
 ...S PSBSTSX=$S($P(PSBDATA,U,27)'>PSBNOWX:"EXPIRED/DC'd",$P(PSBDATA,U,22)'>V:"ACTIVE",V:"FUTURE",1:" * ERROR * ")
"RTN","PSBOCP",47,0)
 ...S PSBLIST2(PSBSTSX,$P(PSBDATA,U,9),PSBORDN)="" S PSBLIST2(PSBSTSX)=PSBLIST2(PSBSTSX)+1
"RTN","PSBOCP",48,0)
 ...S:PSBOCRIT[$E(PSBSTSX,1) PSBTOT=PSBTOT+1
"RTN","PSBOCP",49,0)
 ...S PSBSCHTY(PSBORDN,PSBSCHTY)=""
"RTN","PSBOCP",50,0)
 ...S PSBDOSR=$P(PSBDATA,U,10)_", "_$P(PSBDATA,U,11)
"RTN","PSBOCP",51,0)
 ...S PSBDOSR=$TR($E(PSBDOSR,1)," ")_$E(PSBDOSR,2,999)
"RTN","PSBOCP",52,0)
 ...S PSBDOSR(PSBORDN,PSBDOSR)=""
"RTN","PSBOCP",53,0)
 ...S PSBLSTG=$P(PSBDATA,U,28)
"RTN","PSBOCP",54,0)
 ...I PSBLSTG]"" S PSBLSTG(PSBORDN,$$FMTDT^PSBOCE1($E(PSBLSTG,1,12)))=""
"RTN","PSBOCP",55,0)
 ...S PSBLSTX=$S(PSBLSTG]"":$$LSTX(PSBLSTG,PSBNOWX),1:" ")
"RTN","PSBOCP",56,0)
 ...S PSBLSTX(PSBORDN,PSBLSTX)=""
"RTN","PSBOCP",57,0)
 ...; ** SPECIAL INSTRUCTIONS  **
"RTN","PSBOCP",58,0)
 ...S PSBX2X=PSBX2X+1
"RTN","PSBOCP",59,0)
 ...S PSBSI=$P(PSBDATA(PSBX2X),U,2)
"RTN","PSBOCP",60,0)
 ...I PSBSI]" " S PSBSI(PSBORDN,PSBSI)=""
"RTN","PSBOCP",61,0)
 ...S PSBOSTDT=$P(PSBDATA,U,22)
"RTN","PSBOCP",62,0)
 ...S PSBOSTDT(PSBORDN,PSBOSTDT)=""
"RTN","PSBOCP",63,0)
 ...S PSBOSPDT=$P(PSBDATA,U,27)
"RTN","PSBOCP",64,0)
 ...S PSBOSPDT(PSBORDN,PSBOSPDT)=""
"RTN","PSBOCP",65,0)
 ..Q:'$D(PSBORDN)
"RTN","PSBOCP",66,0)
 ..I "^DD^ADD^SOL"[(U_$P(PSBDATA(PSBX2X),U)) D  Q
"RTN","PSBOCP",67,0)
 ...F I=PSBX2X:1 S PSBDATA1=PSBDATA(I) D  Q:$D(PSBOMDR(PSBORDN))
"RTN","PSBOCP",68,0)
 ....I "^DD^ADD^SOL"[(U_$P(PSBDATA1,U)) S PSBX2X=I S PSBDRUGN=$G(PSBDRUGN,"")_$P(PSBDATA1,U,3)_", " Q
"RTN","PSBOCP",69,0)
 ....S $E(PSBDRUGN,$L(PSBDRUGN)-1)="" S PSBDRUGN(PSBORDN,$E(PSBDRUGN,1,250))=PSBDRUGN
"RTN","PSBOCP",70,0)
 ....S PSBOMDR(PSBORDN,$E((PSBDRUGN_"; "_PSBDOSR),1,250))=PSBDRUGN_"; "_PSBDOSR
"RTN","PSBOCP",71,0)
 ..I $P(PSBDATA,U)="END" Q
"RTN","PSBOCP",72,0)
 ..Q:'$D(PSBORDN)
"RTN","PSBOCP",73,0)
 ..I $P(PSBDATA(PSBX2X),U)="ORF" D  Q
"RTN","PSBOCP",74,0)
 ...S PSBDATA=PSBDATA(PSBX2X)
"RTN","PSBOCP",75,0)
 ...S:$P(PSBDATA,U,2)]"" PSBFLGD(PSBORDN,$P(PSBDATA,U,3)_" - "_$P(PSBDATA,U,4))=""
"RTN","PSBOCP",76,0)
 ..Q:'$D(PSBORDN)
"RTN","PSBOCP",77,0)
 ..I ($P(PSBDATA,U)="ADM")&($P(PSBDATA,U,4)]"") D  Q
"RTN","PSBOCP",78,0)
 ...S PSBXID=$P(PSBDATA,U,6)_U_$P(PSBDATA,U,4),PSBADM(PSBORDN,(-1*($P(PSBDATA,U,6))),PSBXID)=PSBDATA
"RTN","PSBOCP",79,0)
 ...I $O(PSBSCHTY(PSBORDN,""))="P" S PSBPRNR(PSBORDN,$P(PSBDATA,U,4))=$P(PSBDATA,U,9)
"RTN","PSBOCP",80,0)
 ...I $P(PSBDATA,U,3)]"" S PSBBID(PSBORDN,$P(PSBDATA,U,4))=$P(PSBDATA,U,3)
"RTN","PSBOCP",81,0)
 ...S:PSBXFLG PSBLGD(PSBORDN,"X","INITIALS",$P(PSBDATA,U,8))=""
"RTN","PSBOCP",82,0)
 ...I $P(PSBDATA(PSBX2X+1),U)="CMT"  S PSBX2X=PSBX2X+1 F PSBX3X=PSBX2X:1 S PSBDATA=PSBDATA(PSBX3X) Q:($P(PSBDATA,U)'="CMT")  D
"RTN","PSBOCP",83,0)
 ....S PSBX2X=PSBX3X
"RTN","PSBOCP",84,0)
 ....I $P(PSBDATA,U,3)]"" S PSBPRNEF(PSBORDN,$P(PSBXID,U,2))=$P(PSBDATA,U,3)
"RTN","PSBOCP",85,0)
 ....I PSBCFLG I $P(PSBDATA,U,2)'="" S PSBLGD(PSBORDN,"C","INITIALS",$P(PSBDATA,U,4))="",PSBCMT(PSBORDN,$P(PSBXID,U,2),(-1*$P(PSBDATA,U,6)),PSBX2X)=PSBDATA
"RTN","PSBOCP",86,0)
 I +PSBTOT=0 K PSBLIST,^XTMP("PSBO",$J,"PSBLIST")
"RTN","PSBOCP",87,0)
 D CREATHDR^PSBOCP1
"RTN","PSBOCP",88,0)
 D SUBHDR^PSBOCE
"RTN","PSBOCP",89,0)
 D BLDRPT
"RTN","PSBOCP",90,0)
 D WRTRPT^PSBOCP1
"RTN","PSBOCP",91,0)
 Q
"RTN","PSBOCP",92,0)
BLDRPT ; Buld REPORT DATA
"RTN","PSBOCP",93,0)
 K PSBL2ULN
"RTN","PSBOCP",94,0)
 S PSBTOPHD=PSBLNTOT-2
"RTN","PSBOCP",95,0)
 I '$D(PSBLIST2) D  Q
"RTN","PSBOCP",96,0)
 .S PSBOUTP(0,PSBLNTOT)="W !!,""<<<< NO ORDERS TO DISPLAY >>>>"",!!"
"RTN","PSBOCP",97,0)
 S PSBMORE=5 F PSBX1X="ACTIVE","FUTURE","EXPIRED/DC'd"," * ERROR * " D
"RTN","PSBOCP",98,0)
 .I PSBX1X'=" * ERROR * " S PSBSUM=PSBX1X_" ["_PSBLIST2(PSBX1X)_$S(PSBLIST2(PSBX1X)=1:" Order",1:" Orders")_"]" S PSBOUTP($$PGTOT,PSBLNTOT)="W !!,"""_PSBSUM_""""
"RTN","PSBOCP",99,0)
 .Q:PSBLIST2(PSBX1X)=0
"RTN","PSBOCP",100,0)
 .Q:PSBOCRIT'[$E(PSBX1X,1)
"RTN","PSBOCP",101,0)
 .S:$L(PSBSUM)>$G(PSBL2ULN,0) PSBL2ULN=$L(PSBSUM)
"RTN","PSBOCP",102,0)
 .S PSBOUTP($$PGTOT(2),PSBLNTOT)="W !,$TR($J("""",PSBL2ULN),"" "",""=""),!"
"RTN","PSBOCP",103,0)
 .S PSBOUTP($$PGTOT,PSBLNTOT)="W !"
"RTN","PSBOCP",104,0)
 .K PSBDATA
"RTN","PSBOCP",105,0)
 .S X0="",PSBTOT1=0
"RTN","PSBOCP",106,0)
 .F  S X0=$O(PSBLIST2(PSBX1X,X0))  Q:X0=""  S PSBX2X="" F  S PSBX2X=$O(PSBLIST2(PSBX1X,X0,PSBX2X)) Q:PSBX2X=""  D
"RTN","PSBOCP",107,0)
 ..M PSBLGD("INITIALS")=PSBLGD(PSBX2X,"X","INITIALS") M PSBLGD("INITIALS")=PSBLGD(PSBX2X,"C","INITIALS")
"RTN","PSBOCP",108,0)
 ..S PSBDATA(1,1)=$O(PSBTB(PSBX2X,""))
"RTN","PSBOCP",109,0)
 ..S PSBDATA(1,2)=$O(PSBSTS(PSBX2X,""))
"RTN","PSBOCP",110,0)
 ..S PSBDATA(1,3)=$O(PSBSCHTY(PSBX2X,""))
"RTN","PSBOCP",111,0)
 ..S Y0=$O(PSBOMDR(PSBX2X,"")) I Y0]"" S PSBDATA(1,4)="("_X0_")",PSBDATA(1,4,0)=PSBOMDR(PSBX2X,Y0)
"RTN","PSBOCP",112,0)
 ..S PSBDATA(1,5)=$O(PSBLSTG(PSBX2X,""))
"RTN","PSBOCP",113,0)
 ..S PSBDATA(1,6)=$O(PSBLSTX(PSBX2X,""))
"RTN","PSBOCP",114,0)
 ..S PSBDATA(1,7)=$$FMTDT^PSBOCE1($O(PSBOSTDT(PSBX2X,"")))
"RTN","PSBOCP",115,0)
 ..S PSBDATA(1,8)=$$FMTDT^PSBOCE1($E($O(PSBOSPDT(PSBX2X,"")),1,12))
"RTN","PSBOCP",116,0)
 ..S PSBSIDAT(1)=$O(PSBSI(PSBX2X,""))
"RTN","PSBOCP",117,0)
 ..S PSBTOT1=PSBTOT1+1
"RTN","PSBOCP",118,0)
 ..K PSBDATA(2),PSBDATA(3),PSBSILN
"RTN","PSBOCP",119,0)
 ..D BUILDLN,SIOPI^PSBOCM(.PSBSIDAT,PSBTAB8,$S(PSBX2X["V":"Other Print Info:",1:""))
"RTN","PSBOCP",120,0)
 ..I $D(PSBRPLN) S PSBMORE=$O(PSBRPLN(""),-1)+6 I $D(PSBSILN) S PSBMORE=PSBMORE+$O(PSBSILN(""),-1)
"RTN","PSBOCP",121,0)
 ..K PSB1 I $D(PSBFLGD(PSBX2X)) S PSB="" F  S PSB=$O(PSBFLGD(PSBX2X,PSB)) Q:PSB=""  I ($P(PSB,":")'="NOX")&($P(PSB,":")'="STAT") S PSB1=$G(PSB1,"")_PSB
"RTN","PSBOCP",122,0)
 ..S PSBCNT=PSBTOT1_"   "_$G(PSB1,"")
"RTN","PSBOCP",123,0)
 ..S PSBOUTP($$PGTOT,PSBLNTOT)="W """_PSBCNT_""""
"RTN","PSBOCP",124,0)
 ..S I="" F  S I=$O(PSBRPLN(I)) Q:+I=0  D
"RTN","PSBOCP",125,0)
 ...S PSBOUTP($$PGTOT,PSBLNTOT)="W !,"""_PSBRPLN(I)_""""
"RTN","PSBOCP",126,0)
 ..S I="" F  S I=$O(PSBSILN(I)) Q:+I=0  D
"RTN","PSBOCP",127,0)
 ...S PSBOUTP($$PGTOT,PSBLNTOT)="W !,"""_PSBSILN(I)_""""
"RTN","PSBOCP",128,0)
 ..S PSBOUTP($$PGTOT(2),PSBLNTOT)="W !,$TR($J("""",PSBTAB8),"" "",""-""),!"
"RTN","PSBOCP",129,0)
 ..K PSBRPLN,PSBDATA
"RTN","PSBOCP",130,0)
 D:+PSBTOT>0 LGD^PSBOCM
"RTN","PSBOCP",131,0)
 Q
"RTN","PSBOCP",132,0)
BUILDLN ; Constr recs
"RTN","PSBOCP",133,0)
 K J S J(0)="" F PSBFLD=1:1:8 S J=1 D FORMDAT(PSBFLD) S J($O(PSBRPLN(""),-1))=""
"RTN","PSBOCP",134,0)
 ; Write administration info...
"RTN","PSBOCP",135,0)
 Q:'PSBXFLG
"RTN","PSBOCP",136,0)
 S J=($O(J(""),-1)+1),PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1
"RTN","PSBOCP",137,0)
 S (N,Y)=""
"RTN","PSBOCP",138,0)
 F  S Y=$O(PSBADM(PSBX2X,Y)) Q:Y']""  D
"RTN","PSBOCP",139,0)
 .F  S N=$O(PSBADM(PSBX2X,Y,N)) Q:N']""  D
"RTN","PSBOCP",140,0)
 ..N PSBEIECMT S PSBEIECMT="" I $D(PSBPRNEF(PSBX2X,$P(N,U,2))),$P($G(PSBRPT(.2)),U,8)=0 S PSBEIECMT=$$PRNEFF^PSBO(PSBEIECMT,$P(N,U,2))
"RTN","PSBOCP",141,0)
 ..I $D(PSBBID(PSBX2X,$P(N,U,2))) S PSBDATA(2,0)="BAG ID: "_PSBBID(PSBX2X,$P(N,U,2))
"RTN","PSBOCP",142,0)
 ..S $E(PSBDATA(2,0),25)="ACTION BY: "_$P(PSBADM(PSBX2X,Y,N),U,7)_" "_$$FMTDT^PSBOCE1($E($P(PSBADM(PSBX2X,Y,N),U,6),1,12))
"RTN","PSBOCP",143,0)
 ..S X=$P(PSBADM(PSBX2X,Y,N),U,5) S $E(PSBDATA(2,0),56)="ACTION: "_$S(X="G":"GIVEN",X="R":"REFUSED",X="RM":"REMOVED",X="H":"HELD",X="S":"STOPPED",X="I":"INFUSING",X="C":"COMPLETED",X="M":"MISSING DOSE",X=" ":"*UNKNOWN*",1:" ")
"RTN","PSBOCP",144,0)
 ..I $D(PSBPRNR(PSBX2X)) S $E(PSBDATA(2,0),72)="PRN REASON: "_PSBPRNR(PSBX2X,$P(N,U,2))
"RTN","PSBOCP",145,0)
 ..I $G(PSBDATA(2,0))]" " D WRAPPER(1,132-1,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCP",146,0)
 ..I $D(PSBPRNEF(PSBX2X,$P(N,U,2))) S PSBDATA(2,0)="PRN EFFECTIVENESS: "_PSBPRNEF(PSBX2X,$P(N,U,2))_PSBEIECMT
"RTN","PSBOCP",147,0)
 ..I $G(PSBDATA(2,0))]" " D WRAPPER(30,132-30,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCP",148,0)
 ..I ('PSBCFLG)!('$D(PSBCMT(PSBX2X,$P(N,U,2)))) S PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1 Q
"RTN","PSBOCP",149,0)
 ..S X="" F   S X=$O(PSBCMT(PSBX2X,$P(N,U,2),X)) Q:X']""  D
"RTN","PSBOCP",150,0)
 ...N PSBDAT S PSBDAT="" F  S PSBDAT=$O(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT)) Q:PSBDAT']""  D
"RTN","PSBOCP",151,0)
 ....S PSBDATA(2,0)="COMMENT BY: "_$S($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,5)]"":$P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,5)_" "_$$FMTDT^PSBOCE1($E($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,6),1,12)),1:" n/a ")
"RTN","PSBOCP",152,0)
 ....S PSBDATA(2,0)=PSBDATA(2,0)_"  COMMENT: "_$S($P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,2)]"":$P(PSBCMT(PSBX2X,$P(N,U,2),X,PSBDAT),U,2),1:" ")
"RTN","PSBOCP",153,0)
 ....I $G(PSBDATA(2,0))]" " D WRAPPER(30,132-30,PSBDATA(2,0)) K PSBDATA(2) S J=J+1
"RTN","PSBOCP",154,0)
 ..S PSBRPLN(J)=PSBBLANK,J(J)="",J=J+1
"RTN","PSBOCP",155,0)
 Q
"RTN","PSBOCP",156,0)
FORMDAT(FLD) ;
"RTN","PSBOCP",157,0)
 K PSBVAL
"RTN","PSBOCP",158,0)
 Q:'$D(PSBDATA(1,FLD))
"RTN","PSBOCP",159,0)
 S PSBVAL=PSBDATA(1,FLD)
"RTN","PSBOCP",160,0)
 D WRAPPER(@("PSBTAB"_(FLD-1))+1,((@("PSBTAB"_(FLD))-(@("PSBTAB"_(FLD-1))+1))),PSBVAL)
"RTN","PSBOCP",161,0)
 I FLD=4 S J=$O(J(""),-1)+1,PSBVAL=PSBDATA(1,4,0) D WRAPPER(@("PSBTAB"_(FLD-1))+1,((@("PSBTAB"_(FLD))-(@("PSBTAB"_(FLD-1))+1))),PSBVAL)
"RTN","PSBOCP",162,0)
 Q
"RTN","PSBOCP",163,0)
PGTOT(X) ;mnt PAGE Number
"RTN","PSBOCP",164,0)
 I (PSBLNTOT+PSBMORE)>(IOSL) D PGC^PSBOCE1
"RTN","PSBOCP",165,0)
 I $G(X,1) S PSBLNTOT=PSBLNTOT+$G(X,1),PSBMORE=PSBMORE-$G(X,1)
"RTN","PSBOCP",166,0)
 Q PSBPGNUM
"RTN","PSBOCP",167,0)
WRAPPER(X,Y,Z) ;  Text WRAP
"RTN","PSBOCP",168,0)
 N PSB
"RTN","PSBOCP",169,0)
 I ($L(Z)>0),$F(Z,"""")>1 F  Q:$F(Z,"""")'>1  S Z=$TR(Z,"""","^")
"RTN","PSBOCP",170,0)
 F  Q:'$L(Z)  D
"RTN","PSBOCP",171,0)
 .I $L(Z)<Y S $E(PSBRPLN(J),X)=Z S Z="" Q
"RTN","PSBOCP",172,0)
 .F PSB=Y:-1:0 Q:$E(Z,PSB)=" "
"RTN","PSBOCP",173,0)
 .S:PSB<1 PSB=Y
"RTN","PSBOCP",174,0)
 .S $E(PSBRPLN(J),X)=$E(Z,1,PSB)
"RTN","PSBOCP",175,0)
 .I $L(PSBRPLN(J),"^")>1 F X=1:1:$L(PSBRPLN(J),"^")-1 S $P(PSBRPLN(J),"^",X)=$P(PSBRPLN(J),"^",X)_""""
"RTN","PSBOCP",176,0)
 .S PSBRPLN(J)=$TR(PSBRPLN(J),"^","""")
"RTN","PSBOCP",177,0)
 .S Z=$E(Z,PSB+1,250),J=J+1,J(J)=""
"RTN","PSBOCP",178,0)
 Q ""
"RTN","PSBOCP",179,0)
LSTX(P,O) ;
"RTN","PSBOCP",180,0)
 S DT=$$FMDIFF^XLFDT(O,P,2)
"RTN","PSBOCP",181,0)
 I ((DT\60)<1) Q "0d 0h 1m"
"RTN","PSBOCP",182,0)
 S D=(DT\(60*60*24)) S DT=DT-(D*(60*60*24))
"RTN","PSBOCP",183,0)
 S H=(DT\(60*60)) S DT=DT-(H*(60*60))
"RTN","PSBOCP",184,0)
 S M=((DT+30)\(60)) S DT=DT-(M*(60))
"RTN","PSBOCP",185,0)
 Q D_"d "_H_"h "_M_"m"
"RTN","PSBOMH1")
0^4^B80229523^B75301577
"RTN","PSBOMH1",1,0)
PSBOMH1 ;BIRMINGHAM/EFC-MAH ; 1/7/09 9:27am
"RTN","PSBOMH1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,9,11,26,38,45,51,50**;Mar 2004;Build 78
"RTN","PSBOMH1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBOMH1",4,0)
 ;
"RTN","PSBOMH1",5,0)
 ; Reference/IA
"RTN","PSBOMH1",6,0)
 ; ^DILF/2054
"RTN","PSBOMH1",7,0)
 ; File 200/10060
"RTN","PSBOMH1",8,0)
 ;
"RTN","PSBOMH1",9,0)
EN ;
"RTN","PSBOMH1",10,0)
 ; Load administrations
"RTN","PSBOMH1",11,0)
 S (PSBORD,PSBIEN,PSBR1,PSBADIEN,PSBABR)="",PSBDT=PSBSTRT
"RTN","PSBOMH1",12,0)
 K PSBTSA
"RTN","PSBOMH1",13,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOMH1",14,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  Q:'$D(^PSB(53.79,PSBIEN))  L +^PSB(53.79,PSBIEN):3 I $P(^PSB(53.79,PSBIEN,0),U,9)]"" D  L -^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",15,0)
 ..Q:'$P($G(^PSB(53.79,PSBIEN,0)),U,6)  ; Bad IEN -no evnt dt
"RTN","PSBOMH1",16,0)
 ..Q:$P(^PSB(53.79,PSBIEN,0),U,9)="N"  ;NGiven
"RTN","PSBOMH1",17,0)
 ..S PSBORD=$P($G(^PSB(53.79,PSBIEN,.1)),U,1)
"RTN","PSBOMH1",18,0)
 ..;PSB*3*45 Anyone on the audit log should be in the legend
"RTN","PSBOMH1",19,0)
 ..N TMPCT S TMPCT=0 F  S TMPCT=$O(^PSB(53.79,PSBIEN,.9,TMPCT)) Q:'TMPCT  D
"RTN","PSBOMH1",20,0)
 ...S PSBINIT=$$GET1^DIQ(53.799,TMPCT_","_PSBIEN,"USER:INITIAL"),PSBNAME=$$GET1^DIQ(53.799,TMPCT_","_PSBIEN_",","USER")
"RTN","PSBOMH1",21,0)
 ...S:PSBINIT="" PSBINIT=99
"RTN","PSBOMH1",22,0)
 ...S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",23,0)
 ..; Continuous
"RTN","PSBOMH1",24,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="C"
"RTN","PSBOMH1",25,0)
 ...S X=PSBDT D H^%DTC S PSBWEEK=PSBAR(%H) D CLEAN^PSBVT,PSJ1^PSBVT($P(^PSB(53.79,PSBIEN,0),U,1),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",26,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,6)'=PSBDT,'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH) D  D CLEAN^PSBVT Q  ;chck IV audit
"RTN","PSBOMH1",27,0)
 ....S PSBSIEN=PSBIEN
"RTN","PSBOMH1",28,0)
 ....I $P(^PSB(53.79,PSBIEN,0),"^",10)]"" D BAGDTL^PSBRPC2(.PSBAUD,$P(^PSB(53.79,PSBIEN,0),U,10),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",29,0)
 ....S PSBIEN=PSBSIEN K PSBSIEN
"RTN","PSBOMH1",30,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  I $P(PSBAUD(X),U,3)="" K PSBAUD(X)
"RTN","PSBOMH1",31,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  Q:$P(PSBAUD(X),U,1)=PSBDT
"RTN","PSBOMH1",32,0)
 ....I X="" K PSBAUD Q
"RTN","PSBOMH1",33,0)
 ....I '$D(PSBAUD(X)) K PSBAUD Q
"RTN","PSBOMH1",34,0)
 ....S PSBS=$P(PSBAUD(X),U,3)
"RTN","PSBOMH1",35,0)
 ....I PSBS="GIVEN",$P($G(PSBAUD(X-1)),U,3)="NOT GIVEN" Q
"RTN","PSBOMH1",36,0)
 ....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",37,0)
 ....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NOACTION")
"RTN","PSBOMH1",38,0)
 ....D PSBSTIV^PSBOMH2
"RTN","PSBOMH1",39,0)
 ....S X=PSBDT_U_$P(PSBAUD(X),U,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",40,0)
 ....S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",41,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X
"RTN","PSBOMH1",42,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",43,0)
 ....D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",44,0)
 ....K PSBAUD
"RTN","PSBOMH1",45,0)
 ...S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOMH1",46,0)
 ...S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:NAME")
"RTN","PSBOMH1",47,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",48,0)
 ...;get instrc info - audt log
"RTN","PSBOMH1",49,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",50,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",51,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",52,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",53,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("A")
"RTN","PSBOMH1",54,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)'="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("B")
"RTN","PSBOMH1",55,0)
 ...I PSBDT'=$P(^PSB(53.79,PSBIEN,0),U,6),$P(^PSB(53.79,PSBIEN,0),U,9)="RM" D
"RTN","PSBOMH1",56,0)
 ....D DDAUD
"RTN","PSBOMH1",57,0)
 ....S I="" F  S I=$O(PSBTAR(I),-1) Q:I=""  I $P(PSBTAR(I),U,1)=PSBDT D
"RTN","PSBOMH1",58,0)
 .....S PSBS=$P(PSBTAR(I),U,3)
"RTN","PSBOMH1",59,0)
 .....I PSBS="GIVEN",$P($G(PSBTAR(I-1)),U,3)="NOT GIVEN" Q  ; canceled - not given
"RTN","PSBOMH1",60,0)
 .....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",61,0)
 .....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NO ACTION")
"RTN","PSBOMH1",62,0)
 .....D PSBCTAR^PSBOMH2
"RTN","PSBOMH1",63,0)
 .....S X=$P(PSBTAR(I),U,1,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",64,0)
 ...S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",65,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X
"RTN","PSBOMH1",66,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",67,0)
 ...D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",68,0)
 ...Q
"RTN","PSBOMH1",69,0)
 ..; 1-Time On Call or PRN
"RTN","PSBOMH1",70,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="C"
"RTN","PSBOMH1",71,0)
 ...I PSBDT'=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I") Q
"RTN","PSBOMH1",72,0)
 ...S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOMH1",73,0)
 ...S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:NAME")
"RTN","PSBOMH1",74,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",75,0)
 ...S (PSBXA,PSBM)=1,(PSBZ,PSBT,PSBFLG)=""
"RTN","PSBOMH1",76,0)
 ...I $$GET1^DIQ(53.79,PSBIEN_",",.09)="REMOVED"  D
"RTN","PSBOMH1",77,0)
 ....F I=1:1 S PSBXA=$O(^PSB(53.79,PSBIEN,.9,PSBXA)) Q:PSBXA=""  I PSBXA?1.3N  S PSBZ=PSBZ+1,PSBT(PSBZ)=^PSB(53.79,PSBIEN,.9,PSBXA,0)
"RTN","PSBOMH1",78,0)
 ....F S=1:1 Q:PSBM<1  S PSBM=PSBZ-S  I (PSBM>0) I (PSBT(PSBM)["GIVEN")  S PSBFLG="1" S PRELINE1=$P(PSBT(PSBM),"'",2)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.04)_" "_$E($P(PSBT(PSBM),"'",4),1,3) Q
"RTN","PSBOMH1",79,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",80,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",81,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",82,0)
 ...I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D PSBOUT(PSBDT,PSBINIT)
"RTN","PSBOMH1",83,0)
 ...S PSBLINE1=$$GET1^DIQ(53.79,PSBIEN_",",.09)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.06)_" "_PSBINIT_"            "_$$GET1^DIQ(53.79,PSBIEN_",",.21),PSBLINE2=""
"RTN","PSBOMH1",84,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",85,0)
 ...D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOMH1",86,0)
 ....I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" S PSBLINE2="  Results: <No PRN Results On File>"
"RTN","PSBOMH1",87,0)
 ....E  D
"RTN","PSBOMH1",88,0)
 .....S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:INITIAL")
"RTN","PSBOMH1",89,0)
 .....S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:NAME")
"RTN","PSBOMH1",90,0)
 .....I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",91,0)
 .....I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",92,0)
 ......S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."),0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",93,0)
 ......S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",94,0)
 .....I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D
"RTN","PSBOMH1",95,0)
 ......D:$D(^PSB(53.79,PSBIEN,.9,0))
"RTN","PSBOMH1",96,0)
 .......S (PSBXA2,PSBFG)=0,PSBEFFDT=$P(^PSB(53.79,PSBIEN,.2),U,4) F  S PSBXA2=$O(^PSB(53.79,PSBIEN,.9,PSBXA2)) Q:+PSBXA2'>0  D  Q:PSBFG=1
"RTN","PSBOMH1",97,0)
 ........D:($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U)=PSBEFFDT)&($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)["Instruct")&($P(^PSB(53.79,PSBIEN,.2),U,3)=$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,2))
"RTN","PSBOMH1",98,0)
 .........S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",99,0)
 .........S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)="",PSBFG=1
"RTN","PSBOMH1",100,0)
 .....S PSBLINE2="  Results: "_$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBOMH1",101,0)
 .....S PSBRTXTW="     Entered By "_PSBINIT_" on "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",102,0)
 .....N PSBEIECMT,PSBCMTCH S PSBEIECMT="",PSBCMTCH=0 F  S PSBCMTCH=$O(^PSB(53.79,PSBIEN,.3,PSBCMTCH)) Q:'PSBCMTCH  D
"RTN","PSBOMH1",103,0)
 ......I $P($G(^PSB(53.79,PSBIEN,.3,PSBCMTCH,0)),U)["**Pain Score of" S PSBEIECMT=" **This Pain Score may have been Entered in Error. See Vitals Package.**"
"RTN","PSBOMH1",104,0)
 .....S PSBLINE2=PSBLINE2_PSBEIECMT
"RTN","PSBOMH1",105,0)
 .....I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",106,0)
 ...S X=PSBDT D H^%DTC F PSBWEEK=PSBAR(%H):-7 Q:$D(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",0))!('$D(PSBAR(PSBWEEK)))
"RTN","PSBOMH1",107,0)
 ...S X=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",""),-1)+1
"RTN","PSBOMH1",108,0)
 ...I PSBFLG="1" S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X)=PRELINE1
"RTN","PSBOMH1",109,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+1)=PSBLINE1
"RTN","PSBOMH1",110,0)
 ...I $G(PSBLINE2)]"" D
"RTN","PSBOMH1",111,0)
 ....I $L(PSBLINE2)<=90 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=PSBLINE2 S:$$GET1^DIQ(53.79,PSBIEN_",",.24)'="" ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="      "_PSBRTXTW
"RTN","PSBOMH1",112,0)
 ....I $L(PSBLINE2)>90 D
"RTN","PSBOMH1",113,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=$E(PSBLINE2,1,90)
"RTN","PSBOMH1",114,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="           "_$E(PSBLINE2,91,169)
"RTN","PSBOMH1",115,0)
 .....I $L(PSBLINE2)'>169 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="     "_PSBRTXTW
"RTN","PSBOMH1",116,0)
 .....I $L(PSBLINE2)>169 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="           "_$E(PSBLINE2,170,245),^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+5)="     "_PSBRTXTW
"RTN","PSBOMH1",117,0)
 Q
"RTN","PSBOMH1",118,0)
 ;
"RTN","PSBOMH1",119,0)
DDAUD ;  audits for dispen drugs
"RTN","PSBOMH1",120,0)
 ;
"RTN","PSBOMH1",121,0)
 M PSBMLA=^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",122,0)
 S PSBGA="" I $D(PSBMLA(.9,0)) D
"RTN","PSBOMH1",123,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D  Q
"RTN","PSBOMH1",124,0)
 ..I $D(PSBMLA(.9,PSBX-2,0)) D DT^DILF("ENPST",$P(PSBMLA(.9,PSBX-2,0),"'",2),.PSBDATE)
"RTN","PSBOMH1",125,0)
 ..I '$D(PSBMLA(.9,PSBX-2,0)) S PSBDATE=$P(^PSB(53.79,PSBIEN,0),U,6)
"RTN","PSBOMH1",126,0)
 ..S PSBTMP(10000000-PSBDATE,"B")=PSBDATE_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,5))_U_$P(PSBMLA(.9,PSBX,0),"'",2)
"RTN","PSBOMH1",127,0)
 ..S PSBGA=1
"RTN","PSBOMH1",128,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D
"RTN","PSBOMH1",129,0)
 ..S PSBTMP(10000000-$P(PSBMLA(.9,PSBX,0),U,1),"B")=$P(PSBMLA(.9,PSBX,0),U,1)_U_$$INITIAL^PSBRPC2($P(PSBMLA(.9,PSBX,0),U,2))_U_$P($P(PSBMLA(.9,PSBX,0),U,3),"'",2)
"RTN","PSBOMH1",130,0)
 ..S PSBGA=1
"RTN","PSBOMH1",131,0)
 ;PSB*3*45 Remove Use of $Q(<>,-1)
"RTN","PSBOMH1",132,0)
 N PSBTMQ
"RTN","PSBOMH1",133,0)
 I PSBGA'=1 S PSBTMP(10000000-$P(PSBMLA(0),U,6),"A")=$P(PSBMLA(0),U,6)_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,7))
"RTN","PSBOMH1",134,0)
 S PSBQRY="PSBTMP",PSBCNT=1 F  S PSBTMQ=PSBQRY,PSBQRY=$Q(@PSBQRY) Q:PSBQRY=""  D  ; does comment go with action
"RTN","PSBOMH1",135,0)
 .S PSBPQRY=$G(PSBTMQ)
"RTN","PSBOMH1",136,0)
 .I PSBPQRY="" S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; no prev action
"RTN","PSBOMH1",137,0)
 .I $QS(PSBPQRY,2)="C"  S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; prev line = comment
"RTN","PSBOMH1",138,0)
 .I $QS(PSBQRY,2)="C",$E($P(@PSBTMQ,U,1),1,12)=$E($P(@PSBQRY,U,1),1,12),$P(@PSBTMQ,U,2)=$P(@PSBQRY,U,2) D  Q
"RTN","PSBOMH1",139,0)
 ..S X=$P(@PSBQRY,U,4) S:X[":" X=$P(X,":",2) S $P(PSBTAR(PSBCNT-1),U,4)=X Q
"RTN","PSBOMH1",140,0)
 .S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1
"RTN","PSBOMH1",141,0)
 Q
"RTN","PSBOMH1",142,0)
 ;
"RTN","PSBOMH1",143,0)
PSBOUT(PSBTET,PSBOT1) ;
"RTN","PSBOMH1",144,0)
 I '$D(^PSB(53.79,PSBIEN,.9,0))  D PSBENT^PSBOMH2(PSBOT1)
"RTN","PSBOMH1",145,0)
 S PSBIDA="" I $P(^PSB(53.79,PSBIEN,0),U,6)=PSBTET S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,7),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",146,0)
 S PSBXA1=0
"RTN","PSBOMH1",147,0)
 F  S PSBXA1=$O(^PSB(53.79,PSBIEN,.9,PSBXA1)) Q:+PSBXA1'>0  I PSBXA1'=0  D  Q:$G(PSBOT1)["*"
"RTN","PSBOMH1",148,0)
 .I $L(PSBXA1)<4  D
"RTN","PSBOMH1",149,0)
 ..I $P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1)=PSBTET  D
"RTN","PSBOMH1",150,0)
 ...S:$G(PSBIDA)="" PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",151,0)
 ...I (PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2)),$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",3)["Instruct"  D
"RTN","PSBOMH1",152,0)
 ....S INSDD=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1),Y=INSDD D DD^%DT S INSDD=Y
"RTN","PSBOMH1",153,0)
 ....S PSBOT1=PSBOT1_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),U,3)_" "_INSDD
"RTN","PSBOMH1",154,0)
 I $G(PSBIDA)="",$P(^PSB(53.79,PSBIEN,0),U,4)=PSBTET D
"RTN","PSBOMH1",155,0)
 .S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",156,0)
 I $G(PSBNAME)="" D
"RTN","PSBOMH1",157,0)
 . S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",158,0)
 S ^TMP("PSB",$J,"LEGEND",$S($G(PSBOT1)="":99,1:PSBOT1),PSBNAME)=""
"RTN","PSBOMH1",159,0)
 Q
"RTN","PSBOMH1",160,0)
 ;
"RTN","PSBOML")
0^10^B33332484^B31797933
"RTN","PSBOML",1,0)
PSBOML ;BIRMINGHAM/EFC-MEDICATION LOG ;Mar 2004
"RTN","PSBOML",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,11,50**;Mar 2004;Build 78
"RTN","PSBOML",3,0)
 ;
"RTN","PSBOML",4,0)
 ; Reference/IA
"RTN","PSBOML",5,0)
 ; ^DPT/10035
"RTN","PSBOML",6,0)
 ;
"RTN","PSBOML",7,0)
 ;
"RTN","PSBOML",8,0)
EN ; Begin printing
"RTN","PSBOML",9,0)
 N PSBSTRT,PSBSTOP,PSBHDR,DFN
"RTN","PSBOML",10,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOML",11,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOML",12,0)
 S PSBAUDF=$P(PSBRPT(.2),U,9)
"RTN","PSBOML",13,0)
 S PSBHDR(0)="Medication Log Report"
"RTN","PSBOML",14,0)
 S PSBHDR(1)="Continuing/PRN/Stat/One Time Medication/Treatment Record (Detailed Log) (VAF 10-2970 B, C, D)"
"RTN","PSBOML",15,0)
 ;
"RTN","PSBOML",16,0)
 ; Patient Report
"RTN","PSBOML",17,0)
 ;
"RTN","PSBOML",18,0)
 D:$P(PSBRPT(.1),U,1)="P"
"RTN","PSBOML",19,0)
 .S PSBHDR(2)="Log Type: INDIVIDUAL PATIENT"
"RTN","PSBOML",20,0)
 .S DFN=+$P(PSBRPT(.1),U,2)
"RTN","PSBOML",21,0)
 .W $$PTHDR()
"RTN","PSBOML",22,0)
 .S X=$O(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",23,0)
 .I X>PSBSTOP!(X="") W !!?10,"<<<< NO MEDICATIONS FOUND FOR THIS TIME FRAME >>>>",!! Q
"RTN","PSBOML",24,0)
 .S PSBGBL=$NAME(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",25,0)
 .F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'="AADT"!($QS(PSBGBL,3)'=DFN)!($QS(PSBGBL,4)>PSBSTOP)  D
"RTN","PSBOML",26,0)
 ..S PSBIEN=$QS(PSBGBL,5) Q:'$D(^PSB(53.79,PSBIEN))
"RTN","PSBOML",27,0)
 ..I $P(^PSB(53.79,PSBIEN,0),U,6)'=$QS(PSBGBL,4) Q
"RTN","PSBOML",28,0)
 ..I $Y>(IOSL-10) W $$PTFTR^PSBOHDR(),$$PTHDR()
"RTN","PSBOML",29,0)
 ..W $$LINE(PSBIEN)
"RTN","PSBOML",30,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOML",31,0)
 ;
"RTN","PSBOML",32,0)
 ; Ward Output
"RTN","PSBOML",33,0)
 ;
"RTN","PSBOML",34,0)
 D:$P(PSBRPT(.1),U,1)="W"
"RTN","PSBOML",35,0)
 .S PSBHDR(2)="LOG TYPE: WARD"
"RTN","PSBOML",36,0)
 .W $$WDHDR(PSBWRD)
"RTN","PSBOML",37,0)
 .S PSBTMPG=$NAME(^TMP("PSBO",$J,"B"))
"RTN","PSBOML",38,0)
 .F  S PSBTMPG=$Q(@PSBTMPG) Q:PSBTMPG=""  Q:$QS(PSBTMPG,1)'="PSBO"!($QS(PSBTMPG,2)'=$J)  D
"RTN","PSBOML",39,0)
 ..S DFN=$QS(PSBTMPG,5)
"RTN","PSBOML",40,0)
 ..I $Y>(IOSL-14) W $$WDHDR(PSBWRD)
"RTN","PSBOML",41,0)
 ..W !,$P(^DPT(DFN,0),U),"  (",$P(^(0),U,9),")"
"RTN","PSBOML",42,0)
 ..W !,"Ward: ",$G(^DPT(DFN,.1),"***"),"  Rm-Bed: ",$G(^DPT(DFN,.101),"***"),!
"RTN","PSBOML",43,0)
 ..S X=$O(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",44,0)
 ..I X>PSBSTOP!(X="") W !!?10,"<<<< NO MEDICATIONS FOUND FOR THIS TIME FRAME >>>>",!! Q
"RTN","PSBOML",45,0)
 ..S PSBGBL=$NAME(^PSB(53.79,"AADT",DFN,PSBSTRT-.0000001))
"RTN","PSBOML",46,0)
 ..F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,2)'="AADT"!($QS(PSBGBL,3)'=DFN)!($QS(PSBGBL,4)>PSBSTOP)  D
"RTN","PSBOML",47,0)
 ...S PSBIEN=$QS(PSBGBL,5) I $P(^PSB(53.79,PSBIEN,0),U,6)'=$QS(PSBGBL,4) Q
"RTN","PSBOML",48,0)
 ...W:$Y>(IOSL-10) $$WDHDR(PSBWRD)
"RTN","PSBOML",49,0)
 ...W $$LINE(PSBIEN)
"RTN","PSBOML",50,0)
 Q
"RTN","PSBOML",51,0)
 ;
"RTN","PSBOML",52,0)
LINE(PSBIEN) ; Displays the med log entry in PSBIEN
"RTN","PSBOML",53,0)
 N PSBX,PSBASTUS
"RTN","PSBOML",54,0)
 S X=$P($G(^PSB(53.79,PSBIEN,.1)),U)
"RTN","PSBOML",55,0)
 I X="" W !,"Error: Med Log Entry ",PSBIEN," has no order reference number!" Q ""
"RTN","PSBOML",56,0)
 I 'PSBAUDF,$P(^PSB(53.79,PSBIEN,0),U,9)="N" Q ""
"RTN","PSBOML",57,0)
 D CLEAN^PSBVT
"RTN","PSBOML",58,0)
 D PSJ1^PSBVT(DFN,X)
"RTN","PSBOML",59,0)
 I PSBDFN="-1" W !,"Error: Inpatient Meds API Failure!" Q ""
"RTN","PSBOML",60,0)
 M PSBX=^PSB(53.79,PSBIEN)
"RTN","PSBOML",61,0)
 S Y=$P(PSBX(0),U,4)+.0000001
"RTN","PSBOML",62,0)
 W !,$E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",63,0)
 W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",64,0)
 S Y=$$GET1^DIQ(53.79,PSBIEN_",",.08)
"RTN","PSBOML",65,0)
 S Y=Y_" ["_PSBDOSE_PSBIFR_" "_PSBSCH
"RTN","PSBOML",66,0)
 S Y=Y_" "_PSBMRAB
"RTN","PSBOML",67,0)
 S:$P($G(^PSB(53.79,PSBIEN,.1)),U,6)]"" Y=Y_" Inj Site: "_$P(^(.1),U,6)
"RTN","PSBOML",68,0)
 S Y=Y_"]"
"RTN","PSBOML",69,0)
 W $$WRAP^PSBO(16,32,Y)
"RTN","PSBOML",70,0)
 W ?50,$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOML",71,0)
 S X=$P(PSBX(0),U,9)
"RTN","PSBOML",72,0)
 S PSBASTUS=$S(X="G":"Given",X="H":"Held",X="R":"Refused",X="I":"Infusing",X="C":"Completed",X="S":"Stopped",X="N":"Not Given",X="RM":"Removed",X="M":"Missing dose",1:"Status Unknown")
"RTN","PSBOML",73,0)
 S Y=$P(PSBX(0),U,6)+.0000001
"RTN","PSBOML",74,0)
 S Y=$E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)_" "_$E(Y,9,10)_":"_$E(Y,11,12)
"RTN","PSBOML",75,0)
 S Y=Y_" "_PSBASTUS
"RTN","PSBOML",76,0)
 W $$WRAP^PSBO(57,15,Y)
"RTN","PSBOML",77,0)
 W:$P(PSBX(.1),U)["V" ?75,"Bag ID #",$$GET1^DIQ(53.79,PSBIEN,"IV UNIQUE ID")
"RTN","PSBOML",78,0)
 W:$P(PSBX(.1),U)["V" ?107,"NA",?115,"NA",?120,"NA"
"RTN","PSBOML",79,0)
 W !,$TR($$FMTE^XLFDT(PSBOST,2),"@"," ")_">"
"RTN","PSBOML",80,0)
 F PSBZ=.5,.6,.7 S PSBDHIT=0 F PSBY=0:0 S PSBY=$O(PSBX(PSBZ,PSBY)) Q:'PSBY  D
"RTN","PSBOML",81,0)
 .W:$X>75 !
"RTN","PSBOML",82,0)
 .S PSBDD=$S(PSBZ=.5:53.795,PSBZ=.6:53.796,1:53.797)
"RTN","PSBOML",83,0)
 .S Y=$$EXTERNAL^DILFD(PSBDD,.01,"",$P(PSBX(PSBZ,PSBY,0),U,1))
"RTN","PSBOML",84,0)
 .W $$WRAP^PSBO(75,28,Y)
"RTN","PSBOML",85,0)
 .I $P(PSBX(.1),U)["U" W ?105,$J($P(PSBX(PSBZ,PSBY,0),U,2),6,2),?113,$J($P(PSBX(PSBZ,PSBY,0),U,3),6,2) W $$WRAP^PSBO(120,12,$P(PSBX(PSBZ,PSBY,0),U,4)) S PSBDHIT=1
"RTN","PSBOML",86,0)
 .W:$P(PSBX(.1),U)["V"&($X+3+$L($P(PSBX(PSBZ,PSBY,0),U,3))>105) !?75
"RTN","PSBOML",87,0)
 .W:$P(PSBX(.1),U)["V" " - ",$P(PSBX(PSBZ,PSBY,0),U,3)
"RTN","PSBOML",88,0)
 D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOML",89,0)
 .W !?16,"PRN Reason: ",?30,$$GET1^DIQ(53.79,PSBIEN_",",.21)
"RTN","PSBOML",90,0)
 .W !?16,"PRN Effectiveness: "
"RTN","PSBOML",91,0)
 .I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" W "<No PRN Effectiveness Entered>" Q
"RTN","PSBOML",92,0)
 .N PSBEIECMT S PSBEIECMT="" I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)'="",$P(PSBRPT(.2),U,8)=0 S PSBEIECMT=$$PRNEFF^PSBO(PSBEIECMT,PSBIEN)
"RTN","PSBOML",93,0)
 .W $$WRAP^PSBO(20,100,$$GET1^DIQ(53.79,PSBIEN_",",.22)_PSBEIECMT)
"RTN","PSBOML",94,0)
 .W !?20,"Entered By: ",$$GET1^DIQ(53.79,PSBIEN_",",.23)
"RTN","PSBOML",95,0)
 .W " Date/Time: ",$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOML",96,0)
 .W " Minutes: ",$$GET1^DIQ(53.79,PSBIEN_",",.25)
"RTN","PSBOML",97,0)
 D:$P(PSBRPT(.2),U,8)
"RTN","PSBOML",98,0)
 .W !?16,"Comments: ",?30 I '$O(PSBX(.3,0)) W "<No Comments>"
"RTN","PSBOML",99,0)
 .F PSBY=0:0 S PSBY=$O(PSBX(.3,PSBY)) Q:'PSBY  D
"RTN","PSBOML",100,0)
 ..W:$X>30 !?30
"RTN","PSBOML",101,0)
 ..S Y=$P(PSBX(.3,PSBY,0),U,3)+.0000001
"RTN","PSBOML",102,0)
 ..W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",103,0)
 ..W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",104,0)
 ..W ?46,$$GET1^DIQ(53.793,PSBY_","_PSBIEN_",","ENTERED BY:INITIAL")
"RTN","PSBOML",105,0)
 ..W $$WRAP^PSBO(52,70,$P(PSBX(.3,PSBY,0),U,1))
"RTN","PSBOML",106,0)
 W !,$TR($$FMTE^XLFDT(PSBOSP,2),"@"," ")_"<"
"RTN","PSBOML",107,0)
 D:PSBAUDF
"RTN","PSBOML",108,0)
 .W !?16,"Audits: ",?30 I '$O(PSBX(.9,0)) W "<No Audits>" Q
"RTN","PSBOML",109,0)
 .F PSBY=0:0 S PSBY=$O(PSBX(.9,PSBY)) Q:'PSBY  D
"RTN","PSBOML",110,0)
 ..W:$X>30 !?30
"RTN","PSBOML",111,0)
 ..S Y=$P(PSBX(.9,PSBY,0),U,1)+.0000001
"RTN","PSBOML",112,0)
 ..W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)
"RTN","PSBOML",113,0)
 ..W " ",$E(Y,9,10),":",$E(Y,11,12)
"RTN","PSBOML",114,0)
 ..W ?46,$$GET1^DIQ(53.799,PSBY_","_PSBIEN_",","USER:INITIAL")
"RTN","PSBOML",115,0)
 ..W $$WRAP^PSBO(52,70,$P(PSBX(.9,PSBY,0),U,3))
"RTN","PSBOML",116,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOML",117,0)
 Q ""
"RTN","PSBOML",118,0)
 ;
"RTN","PSBOML",119,0)
WDHDR(PSBWARD) ;
"RTN","PSBOML",120,0)
 D WARD^PSBOHDR(PSBWARD,.PSBHDR)
"RTN","PSBOML",121,0)
 W $$SUB()
"RTN","PSBOML",122,0)
 Q ""
"RTN","PSBOML",123,0)
 ;
"RTN","PSBOML",124,0)
PTHDR() ;
"RTN","PSBOML",125,0)
 D PT^PSBOHDR(DFN,.PSBHDR)
"RTN","PSBOML",126,0)
 W $$SUB()
"RTN","PSBOML",127,0)
 Q ""
"RTN","PSBOML",128,0)
 ;
"RTN","PSBOML",129,0)
SUB() ; Med Log Sub Header
"RTN","PSBOML",130,0)
 W:$X>1 !
"RTN","PSBOML",131,0)
 W "Activity Date",?16,"Orderable Item",?50,"Action",?57,"Action"
"RTN","PSBOML",132,0)
 W !,"Start Date>",?16,"[Dose/Sched/Route/Inj Site]",?50,"By"
"RTN","PSBOML",133,0)
 W ?57,"Date/Time",?75,"Drug/Additive/Solution",?105," U/Ord"
"RTN","PSBOML",134,0)
 W ?113," U/Gvn",?120,"Unit",!,"Stop Date<"
"RTN","PSBOML",135,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOML",136,0)
 Q ""
"RTN","PSBOML",137,0)
 ;
"RTN","PSBOMT")
0^9^B88222978^B79357659
"RTN","PSBOMT",1,0)
PSBOMT ;BIRMINGHAM/TEJ-BCMA MEDICATION THERAPY REPORT ;Mar 2004
"RTN","PSBOMT",2,0)
 ;;3.0;BAR CODE MED ADMIN;**32,50**;Mar 2004;Build 78
"RTN","PSBOMT",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOMT",4,0)
 ;
"RTN","PSBOMT",5,0)
 ; Reference/IA
"RTN","PSBOMT",6,0)
 ; File 50.7/2880
"RTN","PSBOMT",7,0)
 ; File 52.6/436
"RTN","PSBOMT",8,0)
 ; File 52.7/437
"RTN","PSBOMT",9,0)
 ; File 200/10060
"RTN","PSBOMT",10,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBOMT",11,0)
 ; IEN^PSN50P65/4543
"RTN","PSBOMT",12,0)
 ; DRGIEN^PSS50P7/4662
"RTN","PSBOMT",13,0)
 ; VAC^PSS50/4533
"RTN","PSBOMT",14,0)
 ; ^PSDRUG(/221 
"RTN","PSBOMT",15,0)
EN ;
"RTN","PSBOMT",16,0)
 N PSBHDR,PSBORDS,PSBORD,PSBOIP
"RTN","PSBOMT",17,0)
 N TMP
"RTN","PSBOMT",18,0)
 K TMP("PSBOIS",$J),TMP("VA CLASS",$J),TMP("PSBADDS",$J),TMP("PSBSOLS",$J),PSBLGD,PSBOIL,PSBDDL,PSBSOLL,PSBADDL
"RTN","PSBOMT",19,0)
 S PSBCLSS=0,PSBCFLG=0
"RTN","PSBOMT",20,0)
 S PSBXDFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOMT",21,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7),PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOMT",22,0)
 K PSBOCRIT F Y=1:1:4 I $P(PSBRPT(.2),U,Y) S PSBOCRIT=$G(PSBOCRIT,"")_$P("C^P^OC^O",U,Y)_"^"
"RTN","PSBOMT",23,0)
 D NOW^%DTC S (Y,PSBNOWX)=% D DD^%DT S PSBDTTM=$E(Y,1,18)
"RTN","PSBOMT",24,0)
 S:+PSBSTRT'>0 PSBSTRT=$$FMADD^XLFDT(X,-1)
"RTN","PSBOMT",25,0)
 S:+PSBSTOP'>0 PSBSTOP=$P(%,".")
"RTN","PSBOMT",26,0)
 I $D(PSBRPT(.2)) I $P(PSBRPT(.2),U,8) S PSBCFLG=1
"RTN","PSBOMT",27,0)
 I $D(PSBRPT(2)) F XD=$O(PSBRPT(2,0)):1:$O(PSBRPT(2,"B"),-1) S PSBRPT(2,XD,0)=$TR(PSBRPT(2,XD,0),"~",U) D:$P(PSBRPT(2,XD,0),U)="MT"
"RTN","PSBOMT",28,0)
 .I $P(PSBRPT(2,XD,0),U,2)="OIT" D  Q
"RTN","PSBOMT",29,0)
 ..S PSBSRCHL="ORDERABLE ITEM SEARCH LIST:",PSBOIL(+$P(PSBRPT(2,XD,0),U,3))=""
"RTN","PSBOMT",30,0)
 ..S PSB=$P(PSBRPT(2,XD,0),U,3) F X=1:1:$L(PSB,",") Q:$P(PSB,",",X)=""  S (TMP("PSBOIS",$J,$P(PSB,",",X)),PSBOIP("OIP",$P(PSB,",",X)))=""
"RTN","PSBOMT",31,0)
 .I $P(PSBRPT(2,XD,0),U,2)="ADD" D  Q
"RTN","PSBOMT",32,0)
 ..S PSBSRCHL="IV MEDICATION SEARCH LIST:"
"RTN","PSBOMT",33,0)
 ..I $D(^PSDRUG("A526",$P(PSBRPT(2,XD,0),U,3))) S X2=$O(^PSDRUG("A526",$P(PSBRPT(2,XD,0),U,3),"")) S PSBADDL(X2)="",TMP("PSBOIS",$J,$$OFROMA(X2))=""
"RTN","PSBOMT",34,0)
 .I $P(PSBRPT(2,XD,0),U,2)="SOL" D  Q
"RTN","PSBOMT",35,0)
 ..S PSBSRCHL="IV MEDICATION SEARCH LIST:"
"RTN","PSBOMT",36,0)
 ..I $D(^PSDRUG("A527",$P(PSBRPT(2,XD,0),U,3))) S X2=$O(^PSDRUG("A527",$P(PSBRPT(2,XD,0),U,3),"")) S PSBSOLL(X2)="",TMP("PSBOIS",$J,$$OFROMS(X2))=""
"RTN","PSBOMT",37,0)
 .I $P(PSBRPT(2,XD,0),U,2)="DD" D  K PSBDRGS Q
"RTN","PSBOMT",38,0)
 ..S PSBSRCHL="DISPENSED DRUG SEARCH LIST:",PSBDDL($P(PSBRPT(2,XD,0),U,3))=""
"RTN","PSBOMT",39,0)
 ..K PSBDRGS S PSBDRGS="" D OILST^PSBRPCMO(.PSBDRGS,$P(PSBRPT(2,XD,0),U,3),"UD")
"RTN","PSBOMT",40,0)
 ..F X2=PSBDRGS(0):1:$O(PSBDRGS(""),-1) I +PSBDRGS(1)'<0 S TMP("PSBOIS",$J,$P(PSBDRGS(X2),U,4))=""
"RTN","PSBOMT",41,0)
 .I $P(PSBRPT(2,XD,0),U,2)="VAC" D
"RTN","PSBOMT",42,0)
 ..S PSBSRCHL="VA DRUG CLASS SEARCH LIST:"
"RTN","PSBOMT",43,0)
 ..S PSBCLS=$P(PSBRPT(2,XD,0),U,3) D GETCLSS(PSBCLS) K PSBDDRG("VAC") M TMP("VA CLASS",$J,PSBCLS,"DDRG")=PSBDDRG K PSBDDRG
"RTN","PSBOMT",44,0)
 ..S PSBCLSS=1
"RTN","PSBOMT",45,0)
 M PSBOIP("OIP")=TMP("PSBOIS",$J)
"RTN","PSBOMT",46,0)
 D OUT(PSBXDFN,PSBSTRT,PSBSTOP)
"RTN","PSBOMT",47,0)
 Q
"RTN","PSBOMT",48,0)
OUT(PSBXDFN,PSBSTRT,PSBSTOP) ;
"RTN","PSBOMT",49,0)
 D:PSBCLSS GETOIS  ; POSSBLE CLASS ITEMS VIA AVAIL ORDERS
"RTN","PSBOMT",50,0)
 D GETADSO^PSBOMT1 ; ALL ADDS AND SOLS
"RTN","PSBOMT",51,0)
 D FINDIENS^PSBOMT1 ; FIND ALL MED LOG ENTRS
"RTN","PSBOMT",52,0)
 D PREOUT ;   WRIT TO GLOBL
"RTN","PSBOMT",53,0)
 D WRITEOT
"RTN","PSBOMT",54,0)
 D CLEANSUM^PSBOMT1
"RTN","PSBOMT",55,0)
 D CLEANALL^PSBOMT1
"RTN","PSBOMT",56,0)
 Q
"RTN","PSBOMT",57,0)
GETOIS ;
"RTN","PSBOMT",58,0)
 K ^TMP("PSJ",$J),PSBTMP
"RTN","PSBOMT",59,0)
 D EN^PSJBCMA(PSBXDFN,PSBSTRT)
"RTN","PSBOMT",60,0)
 Q:^TMP("PSJ",$J,1,0)<0
"RTN","PSBOMT",61,0)
 M PSBTMP=^TMP("PSJ",$J) K ^TMP("PSJ",$J)
"RTN","PSBOMT",62,0)
 S X=0 F  S X=$O(PSBTMP(X)) Q:+X=0  D
"RTN","PSBOMT",63,0)
 .Q:$G(PSBOCRIT,"")'[$P(PSBTMP(X,1),U,2)_"^"
"RTN","PSBOMT",64,0)
 .S PSBORDN=$P(PSBTMP(X,0),U,3) S PSBORDS(PSBORDN)=""
"RTN","PSBOMT",65,0)
 .I $D(PSBTMP(X,700)) D  Q
"RTN","PSBOMT",66,0)
 ..F XX=1:1:PSBTMP(X,700,0) D
"RTN","PSBOMT",67,0)
 ...S PSBCLS="" F  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",68,0)
 ....I '$D(TMP("VA CLASS",$J,PSBCLS,"DDRG",$P(PSBTMP(X,700,XX,0),U))) Q
"RTN","PSBOMT",69,0)
 ....S PSBORDS(PSBORDN,"DD",$P(PSBTMP(X,700,XX,0),U))=""
"RTN","PSBOMT",70,0)
 ....S PSBORDS(PSBORDN,"OIP",$P(PSBTMP(X,3),U))=""
"RTN","PSBOMT",71,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",72,0)
 .I $D(PSBTMP(X,850)) M PSBORDS(PSBORDN,"ADD")=PSBTMP(X,850) D
"RTN","PSBOMT",73,0)
 ..F XX=1:1:PSBORDS(PSBORDN,"ADD",0) S PSBORDS(PSBORDN,"OIP",$$OFROMA($P(PSBORDS(PSBORDN,"ADD",XX,0),U)))=""
"RTN","PSBOMT",74,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",75,0)
 .I $D(PSBTMP(X,950)) M PSBORDS(PSBORDN,"SOL")=PSBTMP(X,950) D
"RTN","PSBOMT",76,0)
 ..F XX=1:1:PSBORDS(PSBORDN,"SOL",0) S PSBORDS(PSBORDN,"OIP",$$OFROMS($P(PSBORDS(PSBORDN,"SOL",XX,0),U)))=""
"RTN","PSBOMT",77,0)
 ..M PSBOIP("OIP")=PSBORDS(PSBORDN,"OIP")
"RTN","PSBOMT",78,0)
 K PSBTMP
"RTN","PSBOMT",79,0)
 M TMP("PSBOIS",$J)=PSBOIP("OIP")
"RTN","PSBOMT",80,0)
 Q
"RTN","PSBOMT",81,0)
OFROMA(PSBADD) ;OITEM FROM AN ADDITIVE
"RTN","PSBOMT",82,0)
 S X1=$$GET1^DIQ(52.6,PSBADD_",",15,"I")
"RTN","PSBOMT",83,0)
 I PSBCLSS D
"RTN","PSBOMT",84,0)
 .S X2=$$GETDRN(X1)
"RTN","PSBOMT",85,0)
 .S PSBCLS="" K X3 F  Q:$D(X3)  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",86,0)
 ..I $D(TMP("VA CLASS",$J,PSBCLS,"DDRG",X2)) S X3=X1
"RTN","PSBOMT",87,0)
 .I '$D(X3) S X3=0
"RTN","PSBOMT",88,0)
 Q $G(X3,X1)
"RTN","PSBOMT",89,0)
OFROMS(PSBSOL) ;OITEM FROM A SOLUTION
"RTN","PSBOMT",90,0)
 S X1=$$GET1^DIQ(52.7,PSBSOL_",",9,"I")
"RTN","PSBOMT",91,0)
 I PSBCLSS D
"RTN","PSBOMT",92,0)
 .S X2=$$GETDRN(X1)
"RTN","PSBOMT",93,0)
 .S PSBCLS="" K X3 F  Q:$D(X3)  S PSBCLS=$O(TMP("VA CLASS",$J,PSBCLS)) Q:+PSBCLS=0  D
"RTN","PSBOMT",94,0)
 ..I $D(TMP("VA CLASS",$J,PSBCLS,"DDRG",X2)) S X3=X1
"RTN","PSBOMT",95,0)
 .I '$D(X3) S X3=0
"RTN","PSBOMT",96,0)
 Q $G(X3,X1)
"RTN","PSBOMT",97,0)
PREOUT ;
"RTN","PSBOMT",98,0)
 K PSBUNK S XDT="" F  S XDT=$O(TMP("PSBIENS",$J,XDT),-1) Q:XDT=""  S XIEN="",XIEN=$O(TMP("PSBIENS",$J,XDT,XIEN)) D
"RTN","PSBOMT",99,0)
 .Q:$$NONSTS(PSBXDFN,XIEN)
"RTN","PSBOMT",100,0)
 .S PSBIEN=XIEN
"RTN","PSBOMT",101,0)
 .S PSBIENS=PSBIEN_","
"RTN","PSBOMT",102,0)
 .D OUTPUT
"RTN","PSBOMT",103,0)
 Q
"RTN","PSBOMT",104,0)
OUTPUT ;
"RTN","PSBOMT",105,0)
 S PSBSPC=$J("",80)
"RTN","PSBOMT",106,0)
 S W=$E($$GET1^DIQ(53.79,PSBIENS,.02)_PSBSPC,1,20)_" "
"RTN","PSBOMT",107,0)
 S W=W_$S($P(^PSB(53.79,PSBIEN,0),U,9)="":"?? ",1:$E($P(^PSB(53.79,PSBIEN,0),U,9)_"  ",1,2)_" ")
"RTN","PSBOMT",108,0)
 S:$P(^PSB(53.79,PSBIEN,0),U,9)="" PSBUNK=1
"RTN","PSBOMT",109,0)
 S W=W_$E($P($G(^PSB(53.79,PSBIEN,.1)),U,2)_PSBSPC,1,2)_"  "
"RTN","PSBOMT",110,0)
 S W=W_$E($E($$GET1^DIQ(53.79,PSBIENS,.06),1,18)_PSBSPC,1,21)_" "
"RTN","PSBOMT",111,0)
 S W=W_$E($$GET1^DIQ(53.79,PSBIENS,"ACTION BY:INITIAL")_PSBSPC,1,10)_" ",PSBLGD("INITIALS",$$GET1^DIQ(53.79,PSBIENS,"ACTION BY","I"))=""
"RTN","PSBOMT",112,0)
 S W=W_$$GET1^DIQ(53.79,PSBIENS,.16)
"RTN","PSBOMT",113,0)
 D ADD(W)
"RTN","PSBOMT",114,0)
 K PSBV
"RTN","PSBOMT",115,0)
 F PSBNODE=.5,.6,.7 D
"RTN","PSBOMT",116,0)
 .S PSBDD=$S(PSBNODE=.5:53.795,PSBNODE=.6:53.796,1:53.797)
"RTN","PSBOMT",117,0)
 .F PSBY=0:0 S PSBY=$O(^PSB(53.79,PSBIEN,PSBNODE,PSBY)) Q:'PSBY  D
"RTN","PSBOMT",118,0)
 ..I $$GET1^DIQ(53.79,PSBIENS,.11)["V" S PSBV=1
"RTN","PSBOMT",119,0)
 ..D WRAPMEDS($$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.01),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.03),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.02),$$GET1^DIQ(PSBDD,PSBY_","_PSBIENS,.04))
"RTN","PSBOMT",120,0)
 D PRNEFF
"RTN","PSBOMT",121,0)
 I PSBCFLG=1 D COMNTS
"RTN","PSBOMT",122,0)
 D ADD("")
"RTN","PSBOMT",123,0)
 Q
"RTN","PSBOMT",124,0)
PRNEFF ;Add PRN Effectiveness to Medication theropy Report  - PSB*3*50
"RTN","PSBOMT",125,0)
 N PSBPRN,PSBEIECMT,PSBLINE1,PSBLINE2
"RTN","PSBOMT",126,0)
 S PSBEIECMT=""
"RTN","PSBOMT",127,0)
 I $P($G(PSBRPT(.2)),U,8)=0,$D(^PSB(53.79,PSBIEN,.2)) S PSBEIECMT=$$PRNEFF^PSBO(PSBEIECMT,PSBIEN)
"RTN","PSBOMT",128,0)
 I $D(^PSB(53.79,PSBIEN,.2)) D
"RTN","PSBOMT",129,0)
 .D ADD("")
"RTN","PSBOMT",130,0)
 .D ADD($J("",35)_"PRN Effectiveness: "_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",131,0)
 .I $P(^PSB(53.79,PSBIEN,.2),U,2)'="" D
"RTN","PSBOMT",132,0)
 ..S PSBPRN=$P(^PSB(53.79,PSBIEN,.2),U,2)
"RTN","PSBOMT",133,0)
 .I $P(^PSB(53.79,PSBIEN,.2),U,2)="" S PSBPRN="<No PRN Effectiveness Entered>"
"RTN","PSBOMT",134,0)
 .S PSBLINE1=$E(PSBPRN_PSBEIECMT,1,75),PSBLINE2=$E(PSBPRN_PSBEIECMT,76,245) D WRAP(PSBLINE2,PSBLINE1,PSBIEN)
"RTN","PSBOMT",135,0)
 Q 
"RTN","PSBOMT",136,0)
COMNTS ;
"RTN","PSBOMT",137,0)
 N Z,CNT
"RTN","PSBOMT",138,0)
 S Z="",CNT=0
"RTN","PSBOMT",139,0)
 I $D(^PSB(53.79,PSBIEN,.3,0)) D
"RTN","PSBOMT",140,0)
 .D ADD("")
"RTN","PSBOMT",141,0)
 .D ADD($J("",44)_"Comments: "_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",142,0)
 .S XT="" F  S XT=$O(^PSB(53.79,PSBIEN,.3,XT)) Q:XT=""  I XT'=0  D
"RTN","PSBOMT",143,0)
 ..D:CNT=1 ADD("")
"RTN","PSBOMT",144,0)
 ..S Y=$P(^PSB(53.79,PSBIEN,.3,XT,0),"^",3) D DD^%DT S XBR=Y
"RTN","PSBOMT",145,0)
 ..S Z=XBR_"   "_$P(^VA(200,$P(^PSB(53.79,PSBIEN,.3,XT,0),"^",2),0),"^",2)
"RTN","PSBOMT",146,0)
 ..D WRAP($P(^PSB(53.79,PSBIEN,.3,XT,0),"^",1),Z,PSBIEN)
"RTN","PSBOMT",147,0)
 ..S CNT=1
"RTN","PSBOMT",148,0)
 .D ADD($J("",54)_$$MAKELINE^PSBOMT1("-",78))
"RTN","PSBOMT",149,0)
 Q
"RTN","PSBOMT",150,0)
WRAPMEDS(MED,UG,UO,UOA) ;
"RTN","PSBOMT",151,0)
 ;THIS WILL CREATE UPTO 3 LINES
"RTN","PSBOMT",152,0)
 S MED=$E(MED_$J("",40),1,40)
"RTN","PSBOMT",153,0)
 N UGWRAP,ORWRAP
"RTN","PSBOMT",154,0)
 S (CNTX,UOA1,UOA16,UOA31)=""
"RTN","PSBOMT",155,0)
 I +$G(UG)?1"."1.N S UG=0_+UG
"RTN","PSBOMT",156,0)
 I +$G(UO)?1"."1.N S UO=0_+UO
"RTN","PSBOMT",157,0)
 I $G(PSBV,0) S UO="NA"
"RTN","PSBOMT",158,0)
 F CNT=1:15:45  D
"RTN","PSBOMT",159,0)
 .D PARSE^PSBOMT1(UOA,CNT)
"RTN","PSBOMT",160,0)
 .S UGWRAP=$E(UG,CNT,(CNT+7)),UOWRAP=$E(UO,CNT,(CNT+7))
"RTN","PSBOMT",161,0)
 .I CNT=1 D ADD($J("",55)_MED_" "_$$PAD^PSBOMT1(UOWRAP,8)_" "_$$PAD^PSBOMT1(UGWRAP,8)_"  "_$$PAD^PSBOMT1(UOA1,15))
"RTN","PSBOMT",162,0)
 .I (CNT>1),($L(UGWRAP)>0!$L(@("UOA"_CNT))>0) D ADD($J("",94)_$$PAD^PSBOMT1(UOWRAP,8)_" "_$$PAD^PSBOMT1(UGWRAP,8)_"  "_$$PAD^PSBOMT1(@("UOA"_CNT),15))
"RTN","PSBOMT",163,0)
 Q
"RTN","PSBOMT",164,0)
HEADA ;
"RTN","PSBOMT",165,0)
 W !
"RTN","PSBOMT",166,0)
 W "Location",?21,"St Sch Administration Date",?50,"By",?61,"Injection Site",?96,"Units",?104,"Units",?113,"Units of"
"RTN","PSBOMT",167,0)
 W !,?55,"Medication & Dosage",?96,"Ordered",?104,"Given",?113,"Administration"
"RTN","PSBOMT",168,0)
 W !
"RTN","PSBOMT",169,0)
 W $$MAKELINE^PSBOMT1("-",132)
"RTN","PSBOMT",170,0)
 Q
"RTN","PSBOMT",171,0)
NONSTS(PSBX,PSBY) ;
"RTN","PSBOMT",172,0)
 D CLEAN^PSBVT,PSJ1^PSBVT(PSBX,$$GET1^DIQ(53.79,PSBY_",","ORDER REFERENCE NUMBER","I"))
"RTN","PSBOMT",173,0)
 Q PSBOCRIT'[PSBSCHT_"^"
"RTN","PSBOMT",174,0)
WRITEOT ;
"RTN","PSBOMT",175,0)
 D HDR^PSBOMT1
"RTN","PSBOMT",176,0)
 D MEDS
"RTN","PSBOMT",177,0)
 D PT^PSBOHDR(PSBXDFN,.PSBHDR),HEADA
"RTN","PSBOMT",178,0)
 I '$D(TMP("PSBIENS",$J)) D ADD("<<<< NO HISTORY FOUND FOR THIS TIME FRAME >>>>")
"RTN","PSBOMT",179,0)
 S EX="" F  S EX=$O(^TMP("PSB",$J,EX)) Q:EX=""  D
"RTN","PSBOMT",180,0)
 .I $Y>(IOSL-5) D
"RTN","PSBOMT",181,0)
 ..W $$PTFTR^PSBOHDR()
"RTN","PSBOMT",182,0)
 ..D PT^PSBOHDR(PSBXDFN,.PSBHDR),HEADA
"RTN","PSBOMT",183,0)
 .W !,$G(^TMP("PSB",$J,EX))
"RTN","PSBOMT",184,0)
 D:$D(TMP("PSBIENS",$J)) LEGEND^PSBOMT1
"RTN","PSBOMT",185,0)
 D FTR^PSBOMT1
"RTN","PSBOMT",186,0)
 Q
"RTN","PSBOMT",187,0)
MEDS ;
"RTN","PSBOMT",188,0)
 N MED,XA,XB
"RTN","PSBOMT",189,0)
 S MED="",XB=$O(PSBHDR(""),-1)+1
"RTN","PSBOMT",190,0)
 S PSBHDR(XB)=PSBSRCHL
"RTN","PSBOMT",191,0)
 I PSBCLSS S XA=0 K PSBGOT F  S XA=$O(TMP("VA CLASS",$J,XA)) Q:+XA=0  D
"RTN","PSBOMT",192,0)
 .K ^TMP($J,"PSBLIST") D IEN^PSN50P65(XA,"??","PSBLIST")
"RTN","PSBOMT",193,0)
 .I ^TMP($J,"PSBLIST",0)>0 S MED=^TMP($J,"PSBLIST",XA,1) Q:$D(PSBGOT(MED))  K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",194,0)
 .I $L(PSBHDR(XB)_" "_$G(MED," * NO DATA FOUND * "))+3>IOM D  Q
"RTN","PSBOMT",195,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED S PSBGOT(MED)=""
"RTN","PSBOMT",196,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED,PSBGOT(MED)=""
"RTN","PSBOMT",197,0)
 I $D(PSBOIL) S XA="" K PSBGOT F  S XA=$O(PSBOIL(XA)) Q:XA=""  D
"RTN","PSBOMT",198,0)
 .S MED=$$GET1^DIQ(50.7,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",199,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",200,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",201,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",202,0)
 I $D(PSBADDL) S XA="" K PSBGOT F  S XA=$O(PSBADDL(XA)) Q:XA=""  D
"RTN","PSBOMT",203,0)
 .S MED=$$GET1^DIQ(52.6,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",204,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",205,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",206,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",207,0)
 I $D(PSBSOLL) S XA="" K PSBGOT F  S XA=$O(PSBSOLL(XA)) Q:XA=""  D
"RTN","PSBOMT",208,0)
 .S MED=$$GET1^DIQ(52.7,XA,.01) Q:$D(PSBGOT(MED))  S PSBGOT(MED)=""
"RTN","PSBOMT",209,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",210,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",211,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",212,0)
 I $D(PSBDDL) S XA="" F  S XA=$O(PSBDDL(XA)) Q:XA=""  D
"RTN","PSBOMT",213,0)
 .S MED=$$GET1^DIQ(50,XA,.01)
"RTN","PSBOMT",214,0)
 .I $L(PSBHDR(XB)_" / "_MED)+3>IOM D  Q
"RTN","PSBOMT",215,0)
 ..S XB=XB+1,PSBHDR(XB)="                         / "_MED
"RTN","PSBOMT",216,0)
 .S PSBHDR(XB)=PSBHDR(XB)_$S(($L(PSBHDR(XB),":")=2)&($P(PSBHDR(XB),":",2)=""):" ",1:" / ")_MED
"RTN","PSBOMT",217,0)
 Q
"RTN","PSBOMT",218,0)
WRAP(SIZE,ZP,BRIEN) ;
"RTN","PSBOMT",219,0)
 D ADD($J("",55)_ZP)
"RTN","PSBOMT",220,0)
 D ADD($J("",55)_$E(SIZE,1,75))
"RTN","PSBOMT",221,0)
 I $L(SIZE)>75 D ADD($J("",55)_$E(SIZE,76,150))
"RTN","PSBOMT",222,0)
 Q
"RTN","PSBOMT",223,0)
ADD(XE) ;
"RTN","PSBOMT",224,0)
 S ^TMP("PSB",$J,$O(^TMP("PSB",$J,""),-1)+1)=XE
"RTN","PSBOMT",225,0)
 Q
"RTN","PSBOMT",226,0)
GETDRN(IEN1) ;
"RTN","PSBOMT",227,0)
 ; Get the Drug IEN (p50) via OI IEN (p50.7)
"RTN","PSBOMT",228,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",229,0)
 D DRGIEN^PSS50P7(IEN1,,"PSBLIST")
"RTN","PSBOMT",230,0)
 S DN=$O(^TMP($J,"PSBLIST",0))
"RTN","PSBOMT",231,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",232,0)
 Q DN
"RTN","PSBOMT",233,0)
GETCLSS(IEN1) ;
"RTN","PSBOMT",234,0)
 ; Get the Items w/i VA Class
"RTN","PSBOMT",235,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",236,0)
 D VAC^PSS50(IEN1,,,"PSBLIST")
"RTN","PSBOMT",237,0)
 M PSBDDRG=^TMP($J,"PSBLIST")
"RTN","PSBOMT",238,0)
 K ^TMP($J,"PSBLIST")
"RTN","PSBOMT",239,0)
 Q
"RTN","PSBVDLU3")
0^5^B91754867^B91584919
"RTN","PSBVDLU3",1,0)
PSBVDLU3 ;BIRMINGHAM/TEJ-BCMA VDL UTILITIES 3 ; 27 Aug 2008  9:06 PM
"RTN","PSBVDLU3",2,0)
 ;;3.0;BAR CODE MED ADMIN;**13,38,28,50**;Mar 2004;Build 78
"RTN","PSBVDLU3",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBVDLU3",4,0)
 ;
"RTN","PSBVDLU3",5,0)
 ;This routine file has been created to serve as a container
"RTN","PSBVDLU3",6,0)
 ;for Extrinsic Variables/Functions
"RTN","PSBVDLU3",7,0)
 ;
"RTN","PSBVDLU3",8,0)
 ; Reference/IA
"RTN","PSBVDLU3",9,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLU3",10,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBVDLU3",11,0)
 ; File 50/221
"RTN","PSBVDLU3",12,0)
 ; File 52.6/436
"RTN","PSBVDLU3",13,0)
 ; File 52.7/437
"RTN","PSBVDLU3",14,0)
 ;
"RTN","PSBVDLU3",15,0)
IVPTAB(PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBPUSH)  ;
"RTN","PSBVDLU3",16,0)
 ;
"RTN","PSBVDLU3",17,0)
 ; This function will return
"RTN","PSBVDLU3",18,0)
 ; the value 1 (one) if the
"RTN","PSBVDLU3",19,0)
 ; specified order input will cause
"RTN","PSBVDLU3",20,0)
 ; the order to display on the "IVP/IVPB"
"RTN","PSBVDLU3",21,0)
 ; tab of the VDL BCMA Virtual Due List (VDL)
"RTN","PSBVDLU3",22,0)
 ; else return the value 0 (zero).
"RTN","PSBVDLU3",23,0)
 ;
"RTN","PSBVDLU3",24,0)
 ; Input Parameters:
"RTN","PSBVDLU3",25,0)
 ;
"RTN","PSBVDLU3",26,0)
 ;     PSBORTYP - Order type (e.g. "U","V")
"RTN","PSBVDLU3",27,0)
 ;     PSBIVTYP - IV Type (e.g. "P","S","C")
"RTN","PSBVDLU3",28,0)
 ;     PSBINTSY - Intermittent Syringe value
"RTN","PSBVDLU3",29,0)
 ;     PSBCHMTY - Chemo type (e.g. "P","S")
"RTN","PSBVDLU3",30,0)
 ;     PSBPUSH - IV PUSH Flag (e.g. 0 or 1, 1=IV PUSH)
"RTN","PSBVDLU3",31,0)
 ;
"RTN","PSBVDLU3",32,0)
 ; Output:
"RTN","PSBVDLU3",33,0)
 ;     1 - order will display on the "IVP/IVPB" Tab of BCMA VDL
"RTN","PSBVDLU3",34,0)
 ;     0 - order will NOT display on the "IVP/IVPB" Tab of BCMA VDL
"RTN","PSBVDLU3",35,0)
 ;    -1 - error processed
"RTN","PSBVDLU3",36,0)
 ;
"RTN","PSBVDLU3",37,0)
 Q:'$D(PSBORTYP) "-1^Missing Parameter"
"RTN","PSBVDLU3",38,0)
 I PSBORTYP="U"&(PSBPUSH) Q 1
"RTN","PSBVDLU3",39,0)
 I '(PSBORTYP="V") Q 0
"RTN","PSBVDLU3",40,0)
 I $G(PSBIVTYP)="P" Q 1
"RTN","PSBVDLU3",41,0)
 I $G(PSBIVTYP)="S",$G(PSBINTSY)=1 Q 1
"RTN","PSBVDLU3",42,0)
 I $G(PSBIVTYP)="C",$G(PSBCHMTY)="P" Q 1
"RTN","PSBVDLU3",43,0)
 I $G(PSBIVTYP)="C",$G(PSBCHMTY)="S",$G(PSBINTSY)=1 Q 1
"RTN","PSBVDLU3",44,0)
 Q 0
"RTN","PSBVDLU3",45,0)
 ;
"RTN","PSBVDLU3",46,0)
SHOVDL(DFN,BDATE,OTDATE,PSBTAB) ;
"RTN","PSBVDLU3",47,0)
 ;
"RTN","PSBVDLU3",48,0)
 ; This function will find orders such as discontinued or expired infusing IV bags 
"RTN","PSBVDLU3",49,0)
 ; or discontinued or expired "given" patches.  Recognizing these types of orders
"RTN","PSBVDLU3",50,0)
 ; will allow these orders to be displayed on the VDL and permits the user to take 
"RTN","PSBVDLU3",51,0)
 ; action on them.  This routine determines if such orders exist for patient,
"RTN","PSBVDLU3",52,0)
 ; time, and "BCMA VDL tab."  This routine is an "extention" to the API EN^PSJBCMA.
"RTN","PSBVDLU3",53,0)
 ;
"RTN","PSBVDLU3",54,0)
 ; INPUT Parameters:
"RTN","PSBVDLU3",55,0)
 ;    DFN           (req)   Patient Internal File Number.
"RTN","PSBVDLU3",56,0)
 ;    BDATE         (opt)   Start searching for "order stop" after this date. 
"RTN","PSBVDLU3",57,0)
 ;    OTDATE        (opt)   Include One-Time orders from this date.
"RTN","PSBVDLU3",58,0)
 ;    PSBTAB        (opt)   "UDTAB" or "IVTAB" - expedites process if specific tab
"RTN","PSBVDLU3",59,0)
 ;                            is given.
"RTN","PSBVDLU3",60,0)
 ;
"RTN","PSBVDLU3",61,0)
 ; OUTPUT Values
"RTN","PSBVDLU3",62,0)
 ;    0               absolutely no orders to display on VDL
"RTN","PSBVDLU3",63,0)
 ;    1               displayable orders have been located.
"RTN","PSBVDLU3",64,0)
 ;
"RTN","PSBVDLU3",65,0)
 ;
"RTN","PSBVDLU3",66,0)
 D EN^PSJBCMA(DFN,$G(BDATE),$G(OTDATE))
"RTN","PSBVDLU3",67,0)
 ; any active Patch orders to show on VDL?
"RTN","PSBVDLU3",68,0)
 S PSBFLG=0
"RTN","PSBVDLU3",69,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 D
"RTN","PSBVDLU3",70,0)
 .;  
"RTN","PSBVDLU3",71,0)
 .; Check the indexice for given patches or infusing IVs
"RTN","PSBVDLU3",72,0)
 .;
"RTN","PSBVDLU3",73,0)
 .; Check APATCH
"RTN","PSBVDLU3",74,0)
 .D:($G(PSBTAB)="UDTAB")!($G(PSBTAB)="")  Q:PSBFLG
"RTN","PSBVDLU3",75,0)
 ..S PSBGNODE="^PSB(53.79,"_"""APATCH"""_","_DFN_")" Q:'$D(PSBGNODE)
"RTN","PSBVDLU3",76,0)
 ..F  S PSBGNODE=$Q(@PSBGNODE) Q:PSBGNODE=""  Q:$QS(PSBGNODE,3)'=DFN  Q:PSBFLG  S PSBIEN=$QS(PSBGNODE,5),PSBFLG=$S($P(^PSB(53.79,PSBIEN,0),U,9)="G":1,1:0)
"RTN","PSBVDLU3",77,0)
 .;
"RTN","PSBVDLU3",78,0)
 .; Check AUID
"RTN","PSBVDLU3",79,0)
 .;
"RTN","PSBVDLU3",80,0)
 .D:(($G(PSBTAB)="IVTAB")!($G(PSBTAB)=""))&('PSBFLG)  Q:PSBFLG
"RTN","PSBVDLU3",81,0)
 ..S PSBGNODE="^PSB(53.79,"_"""AUID"""_","_DFN_")" Q:'$D(PSBGNODE)
"RTN","PSBVDLU3",82,0)
 ..F  S PSBGNODE=$Q(@PSBGNODE) Q:PSBGNODE=""  Q:$QS(PSBGNODE,3)'=DFN  Q:PSBFLG  S PSBIEN=$QS(PSBGNODE,6),PSBFLG=$S($P(^PSB(53.79,PSBIEN,0),U,9)="I":1,1:0)
"RTN","PSBVDLU3",83,0)
 .;
"RTN","PSBVDLU3",84,0)
 .;  NOTE: Infusing bags will not display if DCed more than 3 days ago!
"RTN","PSBVDLU3",85,0)
 .;
"RTN","PSBVDLU3",86,0)
 S:$G(^TMP("PSJ",$J,1,0))'=-1 PSBFLG=1
"RTN","PSBVDLU3",87,0)
 ;
"RTN","PSBVDLU3",88,0)
 Q PSBFLG
"RTN","PSBVDLU3",89,0)
 ;
"RTN","PSBVDLU3",90,0)
FNDACTV(RESULTS,PARAMS) ;   Utility to check and order for the latest " ? (parameter #3) " order activities per patient (parameter #1)
"RTN","PSBVDLU3",91,0)
 ; #parameter= # "^"piece
"RTN","PSBVDLU3",92,0)
 ;       #1 DFN - Patient's IEN          e.g. 1234      (required)
"RTN","PSBVDLU3",93,0)
 ;       #2 Order Number_Order Type      e.g. "1V"     "" = all orders
"RTN","PSBVDLU3",94,0)
 ;       #3 Search for Activity          e.g           "" = *unknown* activity
"RTN","PSBVDLU3",95,0)
 ;       #4 Search "back"time(hours)     e.g. 12       "" = search back 3 admins
"RTN","PSBVDLU3",96,0)
 ;          NOTE:  ="FREQ"  This Function will use order's frequency.
"RTN","PSBVDLU3",97,0)
 ;          1. If the order is a PRN, On Call or One-Time
"RTN","PSBVDLU3",98,0)
 ;           the look back a default of 72 hours.
"RTN","PSBVDLU3",99,0)
 ;          2. if the order is a Continuous order key off
"RTN","PSBVDLU3",100,0)
 ;             of the frequency as follows.
"RTN","PSBVDLU3",101,0)
 ;           a.) if the frequency is <24 hours use the
"RTN","PSBVDLU3",102,0)
 ;               default of 72 hours.
"RTN","PSBVDLU3",103,0)
 ;           b.) if the frequency is >= 24 hour, look back
"RTN","PSBVDLU3",104,0)
 ;               3.5 times the frequency
"RTN","PSBVDLU3",105,0)
 ;    NOTE:  ["X#"    This Function will search back # of admins.
"RTN","PSBVDLU3",106,0)
 ;
"RTN","PSBVDLU3",107,0)
 ;  Example call: D FNDACTV^PSBVDLU3(.TEJ,"1234^1U^H^12")
"RTN","PSBVDLU3",108,0)
 ;
"RTN","PSBVDLU3",109,0)
 N PSBNOW,PSBDFN,PSBON,PSBCNT,PSBACT,PSBTMFRM,PSBX,PSBSET,PSBFRQ
"RTN","PSBVDLU3",110,0)
 K RESULTS
"RTN","PSBVDLU3",111,0)
 S PSBDFN=$P(PARAMS,U),PSBON=$P(PARAMS,U,2),PSBACT=$P(PARAMS,U,3),PSBTMFRM=$P(PARAMS,U,4)
"RTN","PSBVDLU3",112,0)
 S RESULTS(0)=1
"RTN","PSBVDLU3",113,0)
 I $G(PSBDFN)']"" S RESULTS(0)=1,RESULTS(1)="-1^ERROR - MISSING PARAMETER (DFN REQ.)" Q
"RTN","PSBVDLU3",114,0)
 I $G(PSBTMFRM)="" S PSBX=3
"RTN","PSBVDLU3",115,0)
 I $G(PSBTMFRM)["X" S PSBX=+($P(PSBTMFRM,"X",2)),PSBTMFRM=""
"RTN","PSBVDLU3",116,0)
 I $G(PSBTMFRM)]"",$G(PSBTMFRM)'["FREQ" D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM),PSBSET=1 S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",117,0)
 I $G(PSBX)="" S PSBX=9999999
"RTN","PSBVDLU3",118,0)
 D:$G(PSBON)'=""
"RTN","PSBVDLU3",119,0)
 .K ^TMP("PSJ",$J) D EN^PSJBCMA1(PSBDFN,PSBON)
"RTN","PSBVDLU3",120,0)
 .;Maintain Time Frame and other order information
"RTN","PSBVDLU3",121,0)
 .I $G(PSBTMFRM)["FREQ" D
"RTN","PSBVDLU3",122,0)
 ..S PSBFRQ=+$P(^TMP("PSJ",$J,4),"^",11) I PSBFRQ=0 S PSBFRQ=1440
"RTN","PSBVDLU3",123,0)
 ..I "P^OC^O^"[($P(^TMP("PSJ",$J,4),"^")_"^") S PSBTMFRM=72 Q
"RTN","PSBVDLU3",124,0)
 ..I (PSBFRQ/60)<24 S PSBTMFRM=72 Q
"RTN","PSBVDLU3",125,0)
 ..I (PSBFRQ/60)'<24 S PSBTMFRM=(PSBFRQ/60)*3.5
"RTN","PSBVDLU3",126,0)
 .I '$G(PSBSET) D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM) S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",127,0)
 .S I="",X=0 F  S I=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I),-1)  Q:(I="")!(I<$S(PSBTMFRM]"":PSBTMFRM,1:-1))  D  Q:X
"RTN","PSBVDLU3",128,0)
 ..S Z=0,J="",PSBCNT=0 F  S J=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I,J),-1)  Q:(J="")  S Z=Z+1 Q:Z>PSBX  D  Q:X
"RTN","PSBVDLU3",129,0)
 ...L +^PSB(53.79,J):DILOCKTM
"RTN","PSBVDLU3",130,0)
 ...I  L -^PSB(53.79,J)
"RTN","PSBVDLU3",131,0)
 ...E  Q
"RTN","PSBVDLU3",132,0)
 ...I ($P(^PSB(53.79,J,0),U,9)=PSBACT) S X=1 D
"RTN","PSBVDLU3",133,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.02)
"RTN","PSBVDLU3",134,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$P(^TMP("PSJ",$J,2),U,2)_"^"_($$GET1^DIQ(53.79,J_",",.11))
"RTN","PSBVDLU3",135,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.06,"I")
"RTN","PSBVDLU3",136,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.13,"I")
"RTN","PSBVDLU3",137,0)
 D:$G(PSBON)=""
"RTN","PSBVDLU3",138,0)
 .S Z="",X=0 F  S Z=$O(^PSB(53.79,"AORDX",PSBDFN,Z),-1)  Q:(Z="")  S PSBON=Z D  Q:X
"RTN","PSBVDLU3",139,0)
 ..;Maintain Time Frame and other order information
"RTN","PSBVDLU3",140,0)
 ..K ^TMP("PSJ",$J) D EN^PSJBCMA1(PSBDFN,PSBON)
"RTN","PSBVDLU3",141,0)
 ..I $G(PSBTMFRM)["FREQ" D
"RTN","PSBVDLU3",142,0)
 ...S PSBFRQ=+$P(^TMP("PSJ",$J,4),"^",11) I PSBFRQ=0 S PSBFRQ=1440
"RTN","PSBVDLU3",143,0)
 ...I "P^OC^O^"[($P(^TMP("PSJ",$J,4),"^")_"^") S PSBTMFRM=72 Q
"RTN","PSBVDLU3",144,0)
 ...I (PSBFRQ/60)<24 S PSBTMFRM=72 Q
"RTN","PSBVDLU3",145,0)
 ...I (PSBFRQ/60)'<24 S PSBTMFRM=(PSBFRQ/60)*3.5
"RTN","PSBVDLU3",146,0)
 ..I '$G(PSBSET) D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM) S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",147,0)
 ..S I="" F  S I=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I),-1)  Q:(I="")!(I<$S(PSBTMFRM]"":PSBTMFRM,1:-1))  D  Q:X
"RTN","PSBVDLU3",148,0)
 ...S ZZ=0,J="",PSBCNT=0 F  S J=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I,J),-1)  Q:(J="")  S ZZ=ZZ+1 Q:ZZ>PSBX  D  Q:X
"RTN","PSBVDLU3",149,0)
 ....L +^PSB(53.79,J):DILOCKTM
"RTN","PSBVDLU3",150,0)
 ....I  L -^PSB(53.79,J)
"RTN","PSBVDLU3",151,0)
 ....E  Q
"RTN","PSBVDLU3",152,0)
 ....I ($P(^PSB(53.79,J,0),U,9)=PSBACT) S X=1 D
"RTN","PSBVDLU3",153,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.02)
"RTN","PSBVDLU3",154,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$P(^TMP("PSJ",$J,2),U,2)_"^"_($$GET1^DIQ(53.79,J_",",.11))
"RTN","PSBVDLU3",155,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.06,"I")
"RTN","PSBVDLU3",156,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.13,"I")
"RTN","PSBVDLU3",157,0)
 I $G(PSBCNT)>0 S RESULTS(0)=PSBCNT
"RTN","PSBVDLU3",158,0)
 K ^TMP("PSJ",$J)
"RTN","PSBVDLU3",159,0)
 Q
"RTN","PSBVDLU3",160,0)
 ;
"RTN","PSBVDLU3",161,0)
SCANFAIL(RESULTS,PSBPARAM) ;  TEJ 05/12/2006  BCMA-Managing Scanning Failures (MSF)
"RTN","PSBVDLU3",162,0)
 ;       Document Unable to Scan Event
"RTN","PSBVDLU3",163,0)
 ;               Parameters:
"RTN","PSBVDLU3",164,0)
 ;               Input (via GUI):
"RTN","PSBVDLU3",165,0)
 ;
"RTN","PSBVDLU3",166,0)
 ;        Per Wristband  (0)      -       Pat IEN ^ ^ Reason Unable to Scan ^ User's Comment ^ "W" ^ 1 (keyed entry) or 2 (scanner)
"RTN","PSBVDLU3",167,0)
 ;        Per Medication (0)      -       Pat IEN ^ Order Number ^ Reason Unable to Scan ^ User's Comment ^ "M" ^ 1 (keyed entry) or 2 (scanner)
"RTN","PSBVDLU3",168,0)
 ;                       (1)      -       tag^ unique identifier
"RTN","PSBVDLU3",169,0)
 ;               Output:
"RTN","PSBVDLU3",170,0)
 ;                 Entry into database ^PSB(53.77)
"RTN","PSBVDLU3",171,0)
 ;                 Electronic Mail - Message Data per Unable to Scan Event
"RTN","PSBVDLU3",172,0)
 ;  PSB1 - Patient IEN
"RTN","PSBVDLU3",173,0)
 ;  PSB2 - Ward Location/Room
"RTN","PSBVDLU3",174,0)
 ;  PSB3 - Reason
"RTN","PSBVDLU3",175,0)
 ;  PSB4 - Type of Scan Issue
"RTN","PSBVDLU3",176,0)
 ;  PSB5 - Event date/item
"RTN","PSBVDLU3",177,0)
 ;  PSB6 - User's Comment
"RTN","PSBVDLU3",178,0)
 ;  PSB7 - User identification
"RTN","PSBVDLU3",179,0)
 ;  PSB8 - Order Number
"RTN","PSBVDLU3",180,0)
 ;                 RESULTS(0)=1
"RTN","PSBVDLU3",181,0)
 ;                 RESULTS(1)= 1 (Success) or -1 (Nonsuccess)
"RTN","PSBVDLU3",182,0)
 ;
"RTN","PSBVDLU3",183,0)
 K RESULTS,PSBSFUID,PSBMEDOI,PSBMEDNM
"RTN","PSBVDLU3",184,0)
 S RESULTS(0)=1,RESULTS(1)="-1^Unable to Scan documentation NOT successful!"
"RTN","PSBVDLU3",185,0)
 N PSBDAT,PSBDAT1,PSBXON,PSBSCHAD
"RTN","PSBVDLU3",186,0)
 S PSBDAT=PSBPARAM(0) I $D(PSBPARAM(1)) S PSBDAT1=PSBPARAM(1)
"RTN","PSBVDLU3",187,0)
 S PSBXON=$P(PSBDAT,"^",2)
"RTN","PSBVDLU3",188,0)
 S PSB8=$G(PSBXON)
"RTN","PSBVDLU3",189,0)
 S (PSB1,PSBDFN)=$P(PSBDAT,"^")
"RTN","PSBVDLU3",190,0)
 ;
"RTN","PSBVDLU3",191,0)
 ; Changed the ward+room delimiter from / to $.
"RTN","PSBVDLU3",192,0)
 S PSB2=" *UNIDENTIFIABLE PATIENT* " I +$G(PSB1)>0 S PSB2=$$GET1^DIQ(2,PSB1_",",.1)_"$"_$$GET1^DIQ(2,PSB1_",",.101)
"RTN","PSBVDLU3",193,0)
 S PSB3=$P(PSBDAT,"^",3) I PSB3="Manual Medication Entry" S PSBMMEN=1
"RTN","PSBVDLU3",194,0)
 S PSB4=$S($P(PSBDAT,"^",5)="W":"Wristband",$P(PSBDAT,"^",5)="M":"Medication",1:" *UNDEFINED* ")
"RTN","PSBVDLU3",195,0)
 I PSB4="Medication"&($D(PSBDAT1)) D
"RTN","PSBVDLU3",196,0)
 .; Determine DD/ADD/SOL
"RTN","PSBVDLU3",197,0)
 .S PSBMEDOI=$P(PSBDAT1,"^",2)
"RTN","PSBVDLU3",198,0)
 .S PSBFILE=$P(PSBDAT1,"^"),PSBFILE=$S(PSBFILE="DD":50,PSBFILE="ADD":52.6,PSBFILE="SOL":52.7,1:PSBFILE)
"RTN","PSBVDLU3",199,0)
 .I PSBFILE'="ID" S PSBMEDNM=$$GET1^DIQ(PSBFILE,PSBMEDOI_",",.01)
"RTN","PSBVDLU3",200,0)
 .K PSBSFUID I PSBFILE="ID",(PSBMEDOI]"") S PSBSFUID=PSBMEDOI
"RTN","PSBVDLU3",201,0)
 D NOW^%DTC S (Y,PSB5A)=% D DD^%DT S PSB5=Y
"RTN","PSBVDLU3",202,0)
 S PSB6=$P(PSBDAT,"^",4)
"RTN","PSBVDLU3",203,0)
 S PSB7=". *UNDEFINED* " I $G(DUZ)>0 S PSB7=$$GET1^DIQ(200,DUZ_",",.01),PSB7A="`"_DUZ
"RTN","PSBVDLU3",204,0)
 ; Send message.
"RTN","PSBVDLU3",205,0)
 I $G(PSBMMEN)'=1,$P(PSBDAT,U,6)'=1,$P(PSBDAT,U,6)'=2 D MSFMSG^PSBMLU(PSB1,PSB2,PSB3,PSB4,PSB5,PSB6,PSB7,PSB8,.RESULTS)
"RTN","PSBVDLU3",206,0)
 I RESULTS(0)=-1 S RESULTS(0)=1,RESULTS(1)="-1^Unable to Scan MAILGROUP NOT SETUP!" Q
"RTN","PSBVDLU3",207,0)
 ;File data
"RTN","PSBVDLU3",208,0)
 D CLEAN^DILF
"RTN","PSBVDLU3",209,0)
 N PSBNEW1
"RTN","PSBVDLU3",210,0)
 S PSBNEW1="+1"
"RTN","PSBVDLU3",211,0)
 D
"RTN","PSBVDLU3",212,0)
 .I $G(PSBMMEN)=1 S PSBSCTYP="MMME" Q
"RTN","PSBVDLU3",213,0)
 .I $P(PSBDAT,U,6)=2 S PSBSCTYP=$S($P(PSBPARAM(0),"^",5)="W":"WSCN",$P(PSBPARAM(0),"^",5)="M":"MSCN") Q
"RTN","PSBVDLU3",214,0)
 .I $P(PSBDAT,U,6)=1 S PSBSCTYP=$S($P(PSBPARAM(0),"^",5)="W":"WKEY",$P(PSBPARAM(0),"^",5)="M":"MKEY") Q
"RTN","PSBVDLU3",215,0)
 .I $P(PSBDAT,U,6)=0 S PSBSCTYP=$S($P(PSBPARAM(0),"^",5)="W":"WUAS",$P(PSBPARAM(0),"^",5)="M":"MUAS")
"RTN","PSBVDLU3",216,0)
 ;
"RTN","PSBVDLU3",217,0)
FILESF ; File event.
"RTN","PSBVDLU3",218,0)
 D VAL^PSBML(53.77,"+1,",.01,PSB7A)
"RTN","PSBVDLU3",219,0)
 D VAL^PSBML(53.77,"+1,",.02,"`"_PSBDFN)
"RTN","PSBVDLU3",220,0)
 D VAL^PSBML(53.77,"+1,",.03,PSB2)
"RTN","PSBVDLU3",221,0)
 D VAL^PSBML(53.77,"+1,",.04,PSB5A)
"RTN","PSBVDLU3",222,0)
 D VAL^PSBML(53.77,"+1,",.05,PSBSCTYP)
"RTN","PSBVDLU3",223,0)
 D VAL^PSBML(53.77,"+1,",.06,PSB3)
"RTN","PSBVDLU3",224,0)
 D VAL^PSBML(53.77,"+1,",.07,$S($G(XMZ)]"":"`"_XMZ,1:""))
"RTN","PSBVDLU3",225,0)
 D VAL^PSBML(53.77,"+1,",.08,PSBXON)
"RTN","PSBVDLU3",226,0)
 D VAL^PSBML(53.77,"+1,",.09,PSB6)
"RTN","PSBVDLU3",227,0)
 D:$G(PSBFILE)=50
"RTN","PSBVDLU3",228,0)
 .D VAL^PSBML(53.771,"+2,+1,",.01,"`"_PSBMEDOI)
"RTN","PSBVDLU3",229,0)
 .D VAL^PSBML(53.771,"+2,+1,",1,PSBMEDNM)
"RTN","PSBVDLU3",230,0)
 D:$G(PSBFILE)=52.6
"RTN","PSBVDLU3",231,0)
 .D VAL^PSBML(53.7711,"+2,+1,",.01,"`"_PSBMEDOI)
"RTN","PSBVDLU3",232,0)
 .D VAL^PSBML(53.7711,"+2,+1,",1,PSBMEDNM)
"RTN","PSBVDLU3",233,0)
 D:$G(PSBFILE)=52.7
"RTN","PSBVDLU3",234,0)
 .D VAL^PSBML(53.7712,"+2,+1,",.01,"`"_PSBMEDOI)
"RTN","PSBVDLU3",235,0)
 .D VAL^PSBML(53.7712,"+2,+1,",1,PSBMEDNM)
"RTN","PSBVDLU3",236,0)
 I $G(PSBFILE)="ID" D VAL^PSBML(53.77,"+1,",14,PSBOIT),VAL^PSBML(53.77,"+1,",15,PSBOITX)
"RTN","PSBVDLU3",237,0)
 I $D(PSBSFUID) D VAL^PSBML(53.77,"+1,",13,PSBSFUID)
"RTN","PSBVDLU3",238,0)
 I $G(PSBFILE)="ID" D VAL^PSBML(53.77,"+1,",13,$S(PSBMEDOI']"":"WS",1:PSBMEDOI))
"RTN","PSBVDLU3",239,0)
 D UPDATE^DIE("","PSBFDA","PSBNEW1","PSBMSG")
"RTN","PSBVDLU3",240,0)
 I $D(PSBMSG("DIERR")) S RESULTS(0)=2,RESULTS(1)="-1^MSF Filing ERROR! "_PSBMSG("DIERR","1","TEXT",1) Q
"RTN","PSBVDLU3",241,0)
 S RESULTS(0)=1,RESULTS(1)="1^Unable to Scan documentation successful!"
"RTN","PSBVDLU3",242,0)
 Q
"RTN","PSBVDLU3",243,0)
 ;
"RTN","PSBVDLU3",244,0)
CLEANMSF ;
"RTN","PSBVDLU3",245,0)
 ;  Clean-up
"RTN","PSBVDLU3",246,0)
 K PSBNEW1,PSB1,PSB2,PSB3,PSB4,PSB5,PSB6,PSB7,PSB8,XMZ
"RTN","PSBVDLU3",247,0)
 Q
"RTN","PSBVDLU3",248,0)
 ;
"RTN","PSBVDLU3",249,0)
SCANCNT(PSBTYP) ;
"RTN","PSBVDLU3",250,0)
 ;  Routine to count total scans (NO MAIL)
"RTN","PSBVDLU3",251,0)
 ;  Input: PSBTYP - "WSCN"/"MSCN"/"MMME"/"MKEY"/"WKEY"  
"RTN","PSBVDLU3",252,0)
 D CLEAN^DILF
"RTN","PSBVDLU3",253,0)
 N PSBNEW1
"RTN","PSBVDLU3",254,0)
 S PSBNEW1="+1"
"RTN","PSBVDLU3",255,0)
 D VAL^PSBML(53.77,"+1,",.01,"`"_".5")
"RTN","PSBVDLU3",256,0)
 D VAL^PSBML(53.77,"+1,",.05,PSBTYP)
"RTN","PSBVDLU3",257,0)
 D UPDATE^DIE("","PSBFDA","PSBNEW1","PSBMSG")
"RTN","PSBVDLU3",258,0)
 I $D(PSBNEW1(1)) S DIK="^PSB(53.77,",DA=PSBNEW1(1) D ^DIK
"RTN","PSBVDLU3",259,0)
 I $D(PSBMSG("DIERR")) S RESULTS(0)=2,RESULTS(1)="-1^MSF Filing ERROR! "_PSBMSG("DIERR","1","TEXT",1) Q
"RTN","PSBVDLU3",260,0)
 S RESULTS(0)=1,RESULTS(1)="1^Unable to Scan documentation successful!"
"RTN","PSBVDLU3",261,0)
 Q
"RTN","PSBVDLU3",262,0)
 ;
"VER")
8.0^22.0
"BLD",8186,6)
^42
**END**
**END**

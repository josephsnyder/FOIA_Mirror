Released PSB*3*25 SEQ #33
Extracted from mail message
**KIDS**:PSB*3.0*25^

**INSTALL NAME**
PSB*3.0*25
"BLD",6469,0)
PSB*3.0*25^BAR CODE MED ADMIN^0^3080918^y
"BLD",6469,1,0)
^^1^1^3070829^^
"BLD",6469,1,1,0)
DUE LIST DISPLAYED MED NOT DUE
"BLD",6469,4,0)
^9.64PA^^
"BLD",6469,6)
3^
"BLD",6469,6.3)
6
"BLD",6469,"KRN",0)
^9.67PA^8989.52^19
"BLD",6469,"KRN",.4,0)
.4
"BLD",6469,"KRN",.4,"NM",0)
^9.68A^^
"BLD",6469,"KRN",.401,0)
.401
"BLD",6469,"KRN",.402,0)
.402
"BLD",6469,"KRN",.403,0)
.403
"BLD",6469,"KRN",.5,0)
.5
"BLD",6469,"KRN",.84,0)
.84
"BLD",6469,"KRN",3.6,0)
3.6
"BLD",6469,"KRN",3.8,0)
3.8
"BLD",6469,"KRN",9.2,0)
9.2
"BLD",6469,"KRN",9.8,0)
9.8
"BLD",6469,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",6469,"KRN",9.8,"NM",1,0)
PSBML^^0^B78540880
"BLD",6469,"KRN",9.8,"NM",2,0)
PSBO^^0^B64731627
"BLD",6469,"KRN",9.8,"NM",3,0)
PSBODL^^0^B74741447
"BLD",6469,"KRN",9.8,"NM",4,0)
PSBVDLVL^^0^B63495779
"BLD",6469,"KRN",9.8,"NM","B","PSBML",1)

"BLD",6469,"KRN",9.8,"NM","B","PSBO",2)

"BLD",6469,"KRN",9.8,"NM","B","PSBODL",3)

"BLD",6469,"KRN",9.8,"NM","B","PSBVDLVL",4)

"BLD",6469,"KRN",19,0)
19
"BLD",6469,"KRN",19.1,0)
19.1
"BLD",6469,"KRN",101,0)
101
"BLD",6469,"KRN",409.61,0)
409.61
"BLD",6469,"KRN",771,0)
771
"BLD",6469,"KRN",870,0)
870
"BLD",6469,"KRN",8989.51,0)
8989.51
"BLD",6469,"KRN",8989.52,0)
8989.52
"BLD",6469,"KRN",8994,0)
8994
"BLD",6469,"KRN","B",.4,.4)

"BLD",6469,"KRN","B",.401,.401)

"BLD",6469,"KRN","B",.402,.402)

"BLD",6469,"KRN","B",.403,.403)

"BLD",6469,"KRN","B",.5,.5)

"BLD",6469,"KRN","B",.84,.84)

"BLD",6469,"KRN","B",3.6,3.6)

"BLD",6469,"KRN","B",3.8,3.8)

"BLD",6469,"KRN","B",9.2,9.2)

"BLD",6469,"KRN","B",9.8,9.8)

"BLD",6469,"KRN","B",19,19)

"BLD",6469,"KRN","B",19.1,19.1)

"BLD",6469,"KRN","B",101,101)

"BLD",6469,"KRN","B",409.61,409.61)

"BLD",6469,"KRN","B",771,771)

"BLD",6469,"KRN","B",870,870)

"BLD",6469,"KRN","B",8989.51,8989.51)

"BLD",6469,"KRN","B",8989.52,8989.52)

"BLD",6469,"KRN","B",8994,8994)

"BLD",6469,"QUES",0)
^9.62^^
"BLD",6469,"REQB",0)
^9.611^5^3
"BLD",6469,"REQB",2,0)
PSB*3.0*32^2
"BLD",6469,"REQB",4,0)
PSB*3.0*2^2
"BLD",6469,"REQB",5,0)
PSB*3.0*13^2
"BLD",6469,"REQB","B","PSB*3.0*13",5)

"BLD",6469,"REQB","B","PSB*3.0*2",4)

"BLD",6469,"REQB","B","PSB*3.0*32",2)

"MBREQ")
0
"PKG",536,-1)
1^1
"PKG",536,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",536,20,0)
^9.402P^^
"PKG",536,22,0)
^9.49I^1^1
"PKG",536,22,1,0)
3.0^3040224^3040819^11874
"PKG",536,22,1,"PAH",1,0)
25^3080918^10000000075
"PKG",536,22,1,"PAH",1,1,0)
^^1^1^3080918
"PKG",536,22,1,"PAH",1,1,1,0)
DUE LIST DISPLAYED MED NOT DUE
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSBML")
0^1^B78540880^B78116244
"RTN","PSBML",1,0)
PSBML ;BIRMINGHAM/EFC-BCMA MED LOG FUNCTIONS ; 2/5/08 8:49am
"RTN","PSBML",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,4,9,11,13,25**;Mar 2004;Build 6
"RTN","PSBML",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBML",4,0)
 ; Reference/IA
"RTN","PSBML",5,0)
 ; ^DPT/10035
"RTN","PSBML",6,0)
 ; DIC(42/10039
"RTN","PSBML",7,0)
 ; DIC(42/2440
"RTN","PSBML",8,0)
 ; File 200/10060
"RTN","PSBML",9,0)
 ; EN^PSJBCMA3/3320
"RTN","PSBML",10,0)
 ; $$SITE^VASITE/10112
"RTN","PSBML",11,0)
 ; ^XUSEC(/10076
"RTN","PSBML",12,0)
 ;
"RTN","PSBML",13,0)
RPC(RESULTS,PSBHDR,PSBREC) ;BCMA MedLog Filing
"RTN","PSBML",14,0)
 S PSBEDTFL=0
"RTN","PSBML",15,0)
 N PSBORD,PSBTRAN,PSBFDA
"RTN","PSBML",16,0)
 K PSBIEN,PSBHL7
"RTN","PSBML",17,0)
 S PSBIEN=$P(PSBHDR,U,1)
"RTN","PSBML",18,0)
 S PSBTRAN=$P(PSBHDR,U,2),PSBHL7=PSBTRAN
"RTN","PSBML",19,0)
 S PSBINST=$P($G(PSBHDR),U,3)
"RTN","PSBML",20,0)
 S PSBAUDIT=$S(PSBIEN="+1":0,1:1)
"RTN","PSBML",21,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBML",22,0)
 I $D(^XUSEC("PSB STUDENT",DUZ)),PSBINST="" S RESULTS(0)=1,RESULTS(1)="-1^Instructor not present" Q
"RTN","PSBML",23,0)
 I $D(^XUSEC("PSB STUDENT",DUZ)),'$D(^XUSEC("PSB INSTRUCTOR",PSBINST)) S RESULTS(0)=1,RESULTS(1)="-1^Instructor doesn't have authority" Q
"RTN","PSBML",24,0)
 S PSBINST(0)=$$GET1^DIQ(200,PSBINST_",",.01)
"RTN","PSBML",25,0)
 I PSBTRAN="ADD COMMENT" D COMMENT^PSBML1 Q
"RTN","PSBML",26,0)
 I PSBTRAN="PRN EFFECTIVENESS" D PRN^PSBML1 Q
"RTN","PSBML",27,0)
 I PSBTRAN="UPDATE STATUS" D  Q
"RTN","PSBML",28,0)
 .I '$D(^PSB(53.79,PSBIEN)) S RESULTS(0)=1,RESULTS(1)="-1^Administration is at an UNKNOWN STATUS" Q
"RTN","PSBML",29,0)
 .D UPDATED^PSBML2
"RTN","PSBML",30,0)
 I PSBTRAN="EDIT" D EDIT^PSBML2 Q
"RTN","PSBML",31,0)
 ;SAGG
"RTN","PSBML",32,0)
 N PSBWARD S PSBWARD=$G(^DPT(+$G(PSBREC(0)),.1),"UNKNOWN"),^PSB("SAGG",PSBWARD,DT)=$G(^PSB("SAGG",PSBWARD,DT))+1
"RTN","PSBML",33,0)
 I PSBREC(1)?1U1";"1.6N S PSBREC(1)=$P(PSBREC(1),";",1)_$E(PSBREC(1))
"RTN","PSBML",34,0)
 D PSJ1^PSBVT(PSBREC(0),$P(PSBREC(1),";",2)_$P(PSBREC(1),";",1))
"RTN","PSBML",35,0)
 S PSBTAB=$P(PSBREC(9),U,1),PSBUID=$P(PSBREC(9),U,2)
"RTN","PSBML",36,0)
 D:PSBTRAN="MEDPASS"
"RTN","PSBML",37,0)
 .I (PSBDOSEF["PATCH"),(PSBREC(3)="G") D  Q:+$G(RESULTS(1))<0
"RTN","PSBML",38,0)
 ..S PSBXDT="" F  S PSBXDT=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXDT)) Q:PSBXDT=""  D  Q:+$G(RESULTS(1))<0
"RTN","PSBML",39,0)
 ...S PSBYZ="" F  S PSBYZ=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXDT,PSBYZ)) Q:'PSBYZ  I ("G"[$$GET1^DIQ(53.79,PSBYZ,.09,"I")) D  Q
"RTN","PSBML",40,0)
 ....S:($$GET1^DIQ(53.79,PSBYZ,.09,"I")="G") RESULTS(0)=1,RESULTS(1)="-1^Previous Patch has not been removed. Administration canceled."
"RTN","PSBML",41,0)
 ....S:($$GET1^DIQ(53.79,PSBYZ,.09,"I")="")&(($$GET1^DIQ(53.79,PSBYZ,.07,"I")'=DUZ)&('$D(^XUSEC("PSB MANAGER",DUZ)))) RESULTS(0)=1,RESULTS(1)="-1^Patch status ""*UNKNOWN*"". Administration canceled."
"RTN","PSBML",42,0)
 .I PSBREC(7)="BCMA/CPRS Interface Entry." S PSBNOW=PSBREC(5)  ;MOB
"RTN","PSBML",43,0)
 .F X=0:1:9 S PSBREC(X)=$G(PSBREC(X))
"RTN","PSBML",44,0)
 .I PSBREC(1)?1U1";".N S PSBREC(1)=$P(PSBREC(1),";",2)_$P(PSBREC(1),";",1)
"RTN","PSBML",45,0)
 .I PSBREC(1)["V",+PSBREC(5)>0,+$P(PSBREC(5),".",2)=0,PSBIVT'["P" D NOW^%DTC S PSBREC(5)=$P(PSBREC(5),".",1)_"."_$P(%,".",2)
"RTN","PSBML",46,0)
 .I $P(PSBREC(9),U,1)="IVTAB",$P(PSBREC(9),U,2)="" S PSBUID=$$GETWSID^PSBVDLU2(PSBREC(0),PSBREC(1))
"RTN","PSBML",47,0)
 .I $P(PSBREC(9),U,1)="PBTAB",$P(PSBREC(9),U,2)="",PSBREC(1)'["U",PSBREC(3)'="M",PSBREC(3)'="R",PSBREC(3)'="H" S PSBUID=$$GETWSID^PSBVDLU2(PSBREC(0),PSBREC(1))
"RTN","PSBML",48,0)
 .;OnCal
"RTN","PSBML",49,0)
 .D:PSBREC(2)="OC"
"RTN","PSBML",50,0)
 ..S X=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),"")) Q:X=""
"RTN","PSBML",51,0)
 ..S Y=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),X,0))
"RTN","PSBML",52,0)
 ..I $P(^PSB(53.79,Y,0),U,9)="G"&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL")) D ERR(1,"On-Call already given")
"RTN","PSBML",53,0)
 .;1x
"RTN","PSBML",54,0)
 .D:PSBREC(2)="O"
"RTN","PSBML",55,0)
 ..S X=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),"")) Q:X=""
"RTN","PSBML",56,0)
 ..S Y=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),X,0))
"RTN","PSBML",57,0)
 ..I $P(^PSB(53.79,Y,0),U,9)="G" D ERR(1,"One Time already Given")
"RTN","PSBML",58,0)
 .;PRN
"RTN","PSBML",59,0)
 .I PSBREC(2)="P",PSBREC(3)'="M",$P(PSBREC(9),U,1)'="IVTAB" D
"RTN","PSBML",60,0)
 ..I PSBREC(6)="" D ERR(1,"PRN Medications MUST Have a PRN Reason")
"RTN","PSBML",61,0)
 ..I PSBREC(5)]"" D ERR(1,"PRN Orders don't have scheduled times")
"RTN","PSBML",62,0)
 ..I PSBREC(3)'="G" D ERR(1,"PRN Orders cannot be marked NOT Given")
"RTN","PSBML",63,0)
 .;Cnt
"RTN","PSBML",64,0)
 .I PSBREC(2)="C",PSBTAB'="IVTAB" D
"RTN","PSBML",65,0)
 ..D:PSBREC(5)="" ERR(1,"Continuous Order needs admin time")
"RTN","PSBML",66,0)
 ..D:PSBREC(6)]"" ERR(1,"No PRN Reason allowed on Continuous Orders")
"RTN","PSBML",67,0)
 .I PSBREC(2)="C",$D(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),+PSBREC(5))),PSBIEN="+1" D  K PSBADMBY,PSBADMAT Q:PSBSIEN=""  Q:$P(^PSB(53.79,PSBSIEN,0),U,9)'="N"
"RTN","PSBML",68,0)
 ..S PSBSIEN=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),PSBREC(5),""))
"RTN","PSBML",69,0)
 ..I PSBSIEN]"" I '(($P(^PSB(53.79,PSBSIEN,0),U,7)=DUZ)!($D(^XUSEC("PSB MANAGER",DUZ)))) S PSBSIEN=""
"RTN","PSBML",70,0)
 ..I PSBSIEN']"" S RESULTS(0)=2,RESULTS(1)="-2^Error Filing Transaction MEDPASS",RESULTS(2)="The PSB MANAGER key is required to modify this scheduled admin" Q
"RTN","PSBML",71,0)
 ..D:$P(^PSB(53.79,PSBSIEN,0),U,9)'="N"
"RTN","PSBML",72,0)
 ...K PSBINCX I $P(^PSB(53.79,PSBSIEN,0),U,9)="" S PSBINCX=PSBSIEN L +^PSB(53.79,PSBINCX):1 Q:'$T  L -^PSB(53.79,PSBINCX)
"RTN","PSBML",73,0)
 ...S Y=$P(^PSB(53.79,PSBSIEN,0),U,6) D DD^%DT S PSBADMAT=Y
"RTN","PSBML",74,0)
 ...S PSBADMBY=$$GET1^DIQ(200,$P(^PSB(53.79,PSBSIEN,0),U,7),.01,)
"RTN","PSBML",75,0)
 ...S RESULTS(0)=3,RESULTS(1)="-2^Error Filing Transaction MEDPASS"
"RTN","PSBML",76,0)
 ...S RESULTS(2)="Continuous Administration Date/Time already on file."
"RTN","PSBML",77,0)
 ...S RESULTS(3)="Administered by "_PSBADMBY_" at "_PSBADMAT_"."
"RTN","PSBML",78,0)
 ...I $D(XWB) S RESULTS(0)=RESULTS(0)+2,RESULTS(4)="                                         ",RESULTS(5)="            VDL will now be updated."
"RTN","PSBML",79,0)
 .;NonGvn
"RTN","PSBML",80,0)
 .I PSBREC(3)'="G",PSBREC(3)'="M",PSBUID'["V",PSBUID'["W" D
"RTN","PSBML",81,0)
 ..I PSBREC(7)="",PSBTAB'="IVTAB" D ERR(1,"Comment needed if Not Marked Given")
"RTN","PSBML",82,0)
 ..I PSBREC(7)="",PSBTAB="IVTAB" D ERR(1,"Comment needed if Not Marked Completed")
"RTN","PSBML",83,0)
 .S:PSBREC(3)="H" PSBREC(7)="Held: "_PSBREC(7)    ;.3
"RTN","PSBML",84,0)
 .S:PSBREC(3)="R" PSBREC(7)="Refused: "_PSBREC(7) ;.3
"RTN","PSBML",85,0)
 .S:PSBREC(3)="S" PSBREC(7)="Stopped: "_PSBREC(7) ;.3
"RTN","PSBML",86,0)
 .;Vald?
"RTN","PSBML",87,0)
 .I $G(PSBSIEN)'="" I $D(^PSB(53.79,PSBSIEN,0)) I $P(^PSB(53.79,PSBSIEN,0),U,9)="N" S PSBIEN=+PSBSIEN_",",$P(PSBHDR,U)=PSBIEN,PSBTRAN="UPDATE STATUS",PSBAUDIT=1   ;do UPDATE
"RTN","PSBML",88,0)
 .D:PSBIEN="+1"  ;New?
"RTN","PSBML",89,0)
 ..D VAL(53.79,PSBIEN,.01,"`"_PSBREC(0)) ;Pt
"RTN","PSBML",90,0)
 ..S X=$G(^DPT(PSBREC(0),.1))_" "_$G(^(.101)) ;WrdRmBd
"RTN","PSBML",91,0)
 ..D VAL(53.79,PSBIEN,.02,X) ;PtLoc
"RTN","PSBML",92,0)
 ..D:$G(^DPT(PSBREC(0),.1))'=""
"RTN","PSBML",93,0)
 ...S Y=$O(^DIC(42,"B",$G(^DPT(PSBREC(0),.1)),"")),Y=$$GET1^DIQ(42,Y,.015,"I"),PSBDIV=$$SITE^VASITE(DT,Y)
"RTN","PSBML",94,0)
 ...D VAL(53.79,PSBIEN,.03,"`"_$P(PSBDIV,U,1)) ;Div
"RTN","PSBML",95,0)
 ..D VAL(53.79,PSBIEN,.04,PSBNOW)  ;EntDT
"RTN","PSBML",96,0)
 ..D VAL(53.79,PSBIEN,.05,"`"_DUZ) ;Who
"RTN","PSBML",97,0)
 ..D VAL(53.79,PSBIEN,.06,PSBNOW)  ;AdmDT
"RTN","PSBML",98,0)
 ..D VAL(53.79,PSBIEN,.07,"`"_DUZ) ;AdmBy
"RTN","PSBML",99,0)
 ..D VAL(53.79,PSBIEN,.08,"`"_PSBREC(4)) ;OrdblItm
"RTN","PSBML",100,0)
 ..D VAL(53.79,PSBIEN,.11,PSBREC(1)) ;OrdTpeIEN
"RTN","PSBML",101,0)
 ..D VAL(53.79,PSBIEN,.12,PSBREC(2)) ;OrdSchdTpe
"RTN","PSBML",102,0)
 ..D VAL(53.79,PSBIEN,.13,PSBREC(5)) ;SchdAdmDT
"RTN","PSBML",103,0)
 ..D:PSBTAB'="UDTAB" VAL(53.79,PSBIEN,.26,PSBUID) ;Bag
"RTN","PSBML",104,0)
 ..D:PSBTAB="IVTAB" VAL(53.79,PSBIEN,.13,"") ;no SchdAdm - lvIV
"RTN","PSBML",105,0)
 ..D:PSBREC(1)?.N1"U" VAL(53.79,PSBIEN,.15,PSBDOSE) ;UDDsage
"RTN","PSBML",106,0)
 ..D:PSBREC(1)?.N1"V" VAL(53.79,PSBIEN,.35,PSBIFR)  ;IVInfRt
"RTN","PSBML",107,0)
 .;Ovrwrt if exsts
"RTN","PSBML",108,0)
 .I PSBREC(3)="G"!(PSBREC(3))="C" D  ;Gvn/Cmpltd?
"RTN","PSBML",109,0)
 ..D VAL(53.79,PSBIEN,.06,PSBNOW)   ;AdmDT
"RTN","PSBML",110,0)
 ..D VAL(53.79,PSBIEN,.07,"`"_DUZ)  ;AdmBy
"RTN","PSBML",111,0)
 .D:PSBREC(8)]"" VAL(53.79,PSBIEN,.16,PSBREC(8)) ;InjctSte
"RTN","PSBML",112,0)
 .D:'$G(PSBMMEN) VAL(53.79,PSBIEN,.09,PSBREC(3)) ;AStats
"RTN","PSBML",113,0)
 .D:PSBREC(6)]"" VAL(53.79,PSBIEN,.21,$P(PSBREC(6),U)),VAL(53.79,PSBIEN,.27,$P(PSBREC(6),U,2)) ;PRNRsn
"RTN","PSBML",114,0)
 .D:PSBREC(7)]""
"RTN","PSBML",115,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.01,PSBREC(7)) ;Cmnt
"RTN","PSBML",116,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.02,"`"_DUZ)   ;Who
"RTN","PSBML",117,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.03,PSBNOW)
"RTN","PSBML",118,0)
 .;DD/SOL/ADD
"RTN","PSBML",119,0)
 .I PSBREC(3)="G"!(PSBREC(3)="I")!(PSBREC(3)="H")!(PSBREC(3)="R")!(PSBREC(3)="M") D  ;gvn/infs?
"RTN","PSBML",120,0)
 ..I PSBTRAN="UPDATE STATUS" K ^PSB(53.79,+PSBIEN,.5),^PSB(53.79,+PSBIEN,.6),^PSB(53.79,+PSBIEN,.7)
"RTN","PSBML",121,0)
 ..F PSBCNT=10:1 Q:'$D(PSBREC(PSBCNT))  D
"RTN","PSBML",122,0)
 ...S Y=$P(PSBREC(PSBCNT),U)
"RTN","PSBML",123,0)
 ...S PSBDD=$S(Y="DD":53.795,Y="ADD":53.796,Y="SOL":53.797,1:0)
"RTN","PSBML",124,0)
 ...Q:'PSBDD
"RTN","PSBML",125,0)
 ...S PSBIENS="+"_PSBCNT_","_PSBIEN
"RTN","PSBML",126,0)
 ...D VAL(PSBDD,PSBIENS,.01,"`"_$P(PSBREC(PSBCNT),U,2))
"RTN","PSBML",127,0)
 ...D VAL(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML",128,0)
 ...D VAL(PSBDD,PSBIENS,.03,$P(PSBREC(PSBCNT),U,4))
"RTN","PSBML",129,0)
 ...D:(PSBTAB="UDTAB")!(PSBTAB="PBTAB") VAL(PSBDD,PSBIENS,.04,$E($P(PSBREC(PSBCNT),U,5),1,40))
"RTN","PSBML",130,0)
 .I $O(RESULTS("")) S RESULTS(0)=1,RESULTS(1)="-1^Error(s) Filing Transaction MEDPASS"  Q
"RTN","PSBML",131,0)
 .D FILEIT
"RTN","PSBML",132,0)
 .D:(PSBREC(2)="O")&(PSBREC(3)="G") EXPIRE^PSBML1  ;1x exp?
"RTN","PSBML",133,0)
 .I $P(RESULTS(0),U,1)=1,PSBTAB'="UDTAB",PSBUID]"",PSBUID'["WS" S PSBON=+PSBREC(1) D EN^PSJBCMA3(PSBREC(0),PSBON,PSBUID,PSBREC(3),PSBNOW)
"RTN","PSBML",134,0)
 Q
"RTN","PSBML",135,0)
BCBU ;HL7,NatContng
"RTN","PSBML",136,0)
 Q:+$G(RESULTS(0))'>0
"RTN","PSBML",137,0)
 N PSBIEN1 S PSBIEN1=$S($P(PSBIEN,",",2)'="":+$P(PSBIEN,",",2),$G(PSBIEN)="+1":PSBIEN(1),1:+$G(PSBIEN))
"RTN","PSBML",138,0)
 I $G(PSBIEN1)="" S RESULTS(0)=1,RESULTS(1)="-1^Contingency NOT processed" Q
"RTN","PSBML",139,0)
 I $G(PSBIEN)="+1" S PSBHL7="MEDPASS"
"RTN","PSBML",140,0)
 E  S:$G(PSBHL7)="" PSBHL7="UPDATE STATUS"
"RTN","PSBML",141,0)
 D:('$D(Y(0))!($G(Y(0))="SAVE")!($G(Y(0))="YES")) EN^PSBSVHL7(+PSBIEN1,PSBHL7),MEDL^ALPBCBU(+PSBIEN1) K PSBHL7
"RTN","PSBML",142,0)
 ;<<HDR-VDEF(frm *3)
"RTN","PSBML",143,0)
 Q
"RTN","PSBML",144,0)
VAL(PSBDD,PSBIEN,PSBFLD,PSBVAL) ;
"RTN","PSBML",145,0)
 K ^TMP("DIERR",$J),PSBRET
"RTN","PSBML",146,0)
 D VAL^DIE(PSBDD,PSBIEN,PSBFLD,"F",PSBVAL,.PSBRET,"PSBFDA")
"RTN","PSBML",147,0)
 I PSBRET="^" F X=0:0 S X=$O(^TMP("DIERR",$J,X)) Q:'X  D ERR(2,^TMP("DIERR",$J,X)_": "_$G(^(X,"TEXT",1),"**"))
"RTN","PSBML",148,0)
 K ^TMP("DIERR",$J),PSBRET
"RTN","PSBML",149,0)
 Q
"RTN","PSBML",150,0)
FILEIT ;Updt
"RTN","PSBML",151,0)
 N PSBMSG,PSBAUD
"RTN","PSBML",152,0)
 S (PSB1,PSB2)=""
"RTN","PSBML",153,0)
 D APATCH^PSBML3
"RTN","PSBML",154,0)
 D CLEAN^DILF
"RTN","PSBML",155,0)
 D RESETADM^PSBUTL
"RTN","PSBML",156,0)
 D UPDATE^DIE("","PSBFDA","PSBIEN","PSBMSG")
"RTN","PSBML",157,0)
 I '$G(PSBMMEN) S X=+PSBIEN I $F("HR",$P(^PSB(53.79,X,0),U,9))>1 F Y=.5,.6,.7 S Z=0 F  S Z=$O(^PSB(53.79,+X,Y,Z)) Q:+Z=0  S $P(^PSB(53.79,+X,Y,Z,0),U,3)=0
"RTN","PSBML",158,0)
 I $D(PSBMSG("DIERR")) S RESULTS(0)=1,RESULTS(1)="-1^"_PSBMSG("DIERR",1)_": "_PSBMSG("DIERR",1,"TEXT",1)  Q
"RTN","PSBML",159,0)
 I $G(PSB1)]"" X PSB1 I $G(PSB2)]"" X PSB2
"RTN","PSBML",160,0)
 I $D(PSBHDR) D:"NHMR"[$P(^PSB(53.79,$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:+PSBIEN),0),U,9)
"RTN","PSBML",161,0)
 .N PSBINDX S PSBINDX=$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:+PSBIEN)
"RTN","PSBML",162,0)
 .K ^PSB(53.79,"APATCH",$P(^PSB(53.79,PSBINDX,0),U),$P(^PSB(53.79,PSBINDX,0),U,6),PSBINDX)
"RTN","PSBML",163,0)
 S RESULTS(0)=1,RESULTS(1)="1^Data Successfully Filed^"_$S($G(PSBIEN(1))'="":$G(PSBIEN(1)),1:+$G(PSBIEN))
"RTN","PSBML",164,0)
 D BCBU  ;NatContng
"RTN","PSBML",165,0)
 I $G(PSBINST,0) S PSBAUD=$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:$P(PSBHDR,"^",1)) D AUDIT^PSBMLU(PSBAUD,"Instructor "_PSBINST(0)_" present.",PSBTRAN)
"RTN","PSBML",166,0)
 Q
"RTN","PSBML",167,0)
ERR(X,Y) ;
"RTN","PSBML",168,0)
 S X=$P("Business Logic Error^Data Validation Error",U,X)
"RTN","PSBML",169,0)
 S RESULTS($O(RESULTS(""),-1)+1)=X_": "_Y
"RTN","PSBML",170,0)
 Q
"RTN","PSBML",171,0)
COMMENT(DA,PSBCMT) ;
"RTN","PSBML",172,0)
 N PSBFDA,PSBIEN,PSBNOW
"RTN","PSBML",173,0)
 S PSBIEN="+1,"_DA_","
"RTN","PSBML",174,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBML",175,0)
 D VAL(53.793,PSBIEN,.01,PSBCMT)
"RTN","PSBML",176,0)
 S PSBFDA(53.793,PSBIEN,.02)=DUZ
"RTN","PSBML",177,0)
 S PSBFDA(53.793,PSBIEN,.03)=PSBNOW
"RTN","PSBML",178,0)
 D FILEIT
"RTN","PSBML",179,0)
 Q
"RTN","PSBO")
0^2^B64731627^B64714477
"RTN","PSBO",1,0)
PSBO ;BIRMINGHAM/EFC-BCMA OUTPUTS ;Mar 2004
"RTN","PSBO",2,0)
 ;;3.0;BAR CODE MED ADMIN;**13,32,2,25**;Mar 2004;Build 6
"RTN","PSBO",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBO",4,0)
 ; Reference/IA
"RTN","PSBO",5,0)
 ; ^DPT(/10035
"RTN","PSBO",6,0)
 ; WARD^NURSUT5/3052
"RTN","PSBO",7,0)
 ; EN^PSJBCMA/2828
"RTN","PSBO",8,0)
 ; ^ORD(101.24/3429
"RTN","PSBO",9,0)
 ; ^PSDRUG(/221
"RTN","PSBO",10,0)
RPC(RESULTS,PSBTYPE,PSBDFN,PSBSTRT,PSBSTOP,PSBINCL,PSBDEV,PSBSORT,PSBOI,PSBWLOC,PSBWSORT,PSBFUTR,PSBORDNM,PSBRCRI,PSBLIST) ;
"RTN","PSBO",11,0)
 ;
"RTN","PSBO",12,0)
 ; RPC: PSB REPORT
"RTN","PSBO",13,0)
 ;
"RTN","PSBO",14,0)
 ; Description:
"RTN","PSBO",15,0)
 ; Used by the client to create individual patient extracts of
"RTN","PSBO",16,0)
 ; CHUI report options to display on the client.
"RTN","PSBO",17,0)
 ;
"RTN","PSBO",18,0)
 S RESULTS=$NAME(^TMP("PSBO",$J))
"RTN","PSBO",19,0)
 N PSBIENS,PSBRPT,PSBFDA,DIC,PSBANS
"RTN","PSBO",20,0)
 K ^TMP("PSBO",$J) S ^TMP("PSBO",$J,1)="-1^"
"RTN","PSBO",21,0)
 S DFN=PSBDFN
"RTN","PSBO",22,0)
 D NEW^PSBO1(.PSBRPT,PSBTYPE)
"RTN","PSBO",23,0)
 I +PSBRPT(0)<1 S ^TMP("PSBO",$J,1)="-1^Error: "_$P(PSBRPT(0),U,2) Q
"RTN","PSBO",24,0)
 S PSBIENS=+PSBRPT(0)_","
"RTN","PSBO",25,0)
 S PSBSTRT(0)=$E($P(PSBSTRT,".",2)_"0000",1,4),PSBSTRT=PSBSTRT\1
"RTN","PSBO",26,0)
 S PSBSTOP(0)=$E($P(PSBSTOP,".",2)_"0000",1,4),PSBSTOP=PSBSTOP\1
"RTN","PSBO",27,0)
 D:$G(PSBDEV)]""
"RTN","PSBO",28,0)
 .D NOW^%DTC
"RTN","PSBO",29,0)
 .I $P(PSBDEV,U,2)="" D VAL^DIE(53.69,PSBIENS,.06,"F",PSBDEV,"PSBRET","PSBFDA")
"RTN","PSBO",30,0)
 .I $P(PSBDEV,U,2)'="" D VAL^DIE(53.69,PSBIENS,.06,"F","`"_$P(PSBDEV,U,2),"PSBRET","PSBFDA")
"RTN","PSBO",31,0)
 .D VAL^DIE(53.69,PSBIENS,.07,"F",$S($P(PSBRCRI,U)="QD":$P(PSBRCRI,U,2),1:%),"PSBRET","PSBFDA")
"RTN","PSBO",32,0)
 D:$G(PSBOI)]"" VAL^DIE(53.69,PSBIENS,.09,"F",PSBOI,"PSBRET","PSBFDA")
"RTN","PSBO",33,0)
 S:($G(PSBSORT)']"")&(PSBTYPE'="XA") PSBSORT="P" D VAL^DIE(53.69,PSBIENS,.11,"F",PSBSORT,"PSBRET","PSBFDA")
"RTN","PSBO",34,0)
 D VAL^DIE(53.69,PSBIENS,.12,"F","`"_PSBDFN,"PSBRET","PSBFDA")
"RTN","PSBO",35,0)
 I $G(PSBWLOC)]"" S PSBFDA(53.69,PSBIENS,.13)=PSBWLOC
"RTN","PSBO",36,0)
 D:$G(PSBWSORT)]"" VAL^DIE(53.69,PSBIENS,.15,"F",PSBWSORT,"PSBRET","PSBFDA")
"RTN","PSBO",37,0)
 D VAL^DIE(53.69,PSBIENS,.16,"F",PSBSTRT,"PSBRET","PSBFDA")
"RTN","PSBO",38,0)
 D VAL^DIE(53.69,PSBIENS,.17,"F",PSBSTRT(0),"PSBRET","PSBFDA")
"RTN","PSBO",39,0)
 D VAL^DIE(53.69,PSBIENS,.18,"F",PSBSTOP,"PSBRET","PSBFDA")
"RTN","PSBO",40,0)
 D VAL^DIE(53.69,PSBIENS,.19,"F",PSBSTOP(0),"PSBRET","PSBFDA")
"RTN","PSBO",41,0)
 D:$G(PSBINCL)]""
"RTN","PSBO",42,0)
 .D VAL^DIE(53.69,PSBIENS,.21,"F",+$P(PSBINCL,"^",1),"PSBRET","PSBFDA")
"RTN","PSBO",43,0)
 .D VAL^DIE(53.69,PSBIENS,.22,"F",+$P(PSBINCL,"^",2),"PSBRET","PSBFDA")
"RTN","PSBO",44,0)
 .D VAL^DIE(53.69,PSBIENS,.23,"F",+$P(PSBINCL,"^",3),"PSBRET","PSBFDA")
"RTN","PSBO",45,0)
 .D VAL^DIE(53.69,PSBIENS,.24,"F",+$P(PSBINCL,"^",4),"PSBRET","PSBFDA")
"RTN","PSBO",46,0)
 .D VAL^DIE(53.69,PSBIENS,.28,"F",+$P(PSBINCL,"^",5),"PSBRET","PSBFDA")
"RTN","PSBO",47,0)
 .D VAL^DIE(53.69,PSBIENS,.29,"F",+$P(PSBINCL,"^",6),"PSBRET","PSBFDA")
"RTN","PSBO",48,0)
 D:$G(PSBFUTR)]""
"RTN","PSBO",49,0)
 .D VAL^DIE(53.69,PSBIENS,.25,"F",+$P(PSBFUTR,"^",1),"PSBRET","PSBFDA")
"RTN","PSBO",50,0)
 .D VAL^DIE(53.69,PSBIENS,.26,"F",+$P(PSBFUTR,"^",2),"PSBRET","PSBFDA")
"RTN","PSBO",51,0)
 .D VAL^DIE(53.69,PSBIENS,.27,"F",+$P(PSBFUTR,"^",3),"PSBRET","PSBFDA")
"RTN","PSBO",52,0)
 .D VAL^DIE(53.69,PSBIENS,.41,"F",+$P(PSBFUTR,"^",4),"PSBRET","PSBFDA")
"RTN","PSBO",53,0)
 .D VAL^DIE(53.69,PSBIENS,.61,"F",$TR(PSBFUTR,"^ ","~"),"PSBRET","PSBFDA")
"RTN","PSBO",54,0)
 D FILE^DIE("","PSBFDA")
"RTN","PSBO",55,0)
 I $G(PSBLIST(0),"")]"" D LIST^PSBO1(.PSBLIST)
"RTN","PSBO",56,0)
 I $G(PSBDEV)]"" D PRINT^PSBO1 S RESULTS=$NAME(^TMP("PSBO",$J)) Q
"RTN","PSBO",57,0)
 D HFSOPEN^PSBUTL("RPC") I POP S ^TMP("PSBO",$J,1)="ERROR: UNABLE TO ACCESS HFS DIRECTORY "_$$GET^XPAR("DIV","PSB HFS SCRATCH"),^TMP("PSBO",$J,2)="PLEASE CHECK DIRECTORY WRITE PRIVILEDGES." Q
"RTN","PSBO",58,0)
 U IO D DQ(+PSBIENS)
"RTN","PSBO",59,0)
 D HFSCLOSE^PSBUTL("RPC")
"RTN","PSBO",60,0)
 S RESULTS=$NAME(^TMP("PSBO",$J))
"RTN","PSBO",61,0)
 D:$G(PSBDEV)]"" PRINT^PSBO1
"RTN","PSBO",62,0)
 Q
"RTN","PSBO",63,0)
 ;
"RTN","PSBO",64,0)
XQ(PSBTYPE) ; Called via Kernel Menus
"RTN","PSBO",65,0)
 N PSBANS,PSBANS1,PSBRPT,PSBSAVE,DA,DIK,DR,DDSFILE
"RTN","PSBO",66,0)
 D NEW^PSBO1(.PSBRPT,PSBTYPE)
"RTN","PSBO",67,0)
 I +PSBRPT(0)<1 W !,"Error: ",$P(PSBRPT(0),U,2) S DIR(0)="E" D ^DIR Q
"RTN","PSBO",68,0)
 S DA=+PSBRPT(0),DR="[PSBO "_PSBTYPE_"]",DDSFILE=53.69 D ^DDS
"RTN","PSBO",69,0)
 W @IOF
"RTN","PSBO",70,0)
 I 'PSBSAVE W !,"Cancelling Request..." S DIK="^PSB(53.69," D ^DIK W "Cancelled!"
"RTN","PSBO",71,0)
 D:PSBSAVE
"RTN","PSBO",72,0)
 .;Check Drug to Patient Relationship.
"RTN","PSBO",73,0)
 .I (PSBTYPE="BL")!(PSBTYPE="BZ") S PSBANS="" D CHECK  I PSBANS=0!($D(DIRUT)) W !,"Cancelling Request..." S DIK="^PSB(53.69," D ^DIK W "Cancelled!" Q
"RTN","PSBO",74,0)
 .;
"RTN","PSBO",75,0)
 .;Allow "'BROWSER" Device
"RTN","PSBO",76,0)
 .S IOP=$$GET1^DIQ(53.69,DA_",",.06,"I"),PSBSIO=0 I IOP]"" D
"RTN","PSBO",77,0)
 ..S IOP="`"_IOP,%ZIS="N"
"RTN","PSBO",78,0)
 ..D ^%ZIS
"RTN","PSBO",79,0)
 ..I IO=IO(0) S PSBSIO=1
"RTN","PSBO",80,0)
 ..D HOME^%ZIS K IOP
"RTN","PSBO",81,0)
 .I $$GET1^DIQ(53.69,DA_",",.06)["BROWSER"!(PSBSIO=1) S IOP=$$GET1^DIQ(53.69,DA_",",.06)_";132" D ^%ZIS U IO D DQ(DA) D ^%ZISC K IOP Q
"RTN","PSBO",82,0)
 .W @IOF,"Submitting Your Report Request to Taskman..."
"RTN","PSBO",83,0)
 .S ZTIO=$$GET1^DIQ(53.69,DA_",",.06)
"RTN","PSBO",84,0)
 .S ZTDTH=$P(^PSB(53.69,DA,0),U,7)
"RTN","PSBO",85,0)
 .S ZTDESC="BCMA - "_$$GET1^DIQ(53.69,DA_",",.05)
"RTN","PSBO",86,0)
 .S ZTRTN="DQ^PSBO("_DA_")"
"RTN","PSBO",87,0)
 .D ^%ZTLOAD
"RTN","PSBO",88,0)
 .W "Submitted!",!,"Your Task Number Is: ",$G(ZTSK),!
"RTN","PSBO",89,0)
 K ^TMP("PSBO",$J)
"RTN","PSBO",90,0)
 Q
"RTN","PSBO",91,0)
 ;
"RTN","PSBO",92,0)
DQ(PSBRPT) ; Dequeue report from Taskman
"RTN","PSBO",93,0)
 N PSBWRD,PSBDFN
"RTN","PSBO",94,0)
 Q:'$D(^PSB(53.69,PSBRPT,0))  ; No Such Report
"RTN","PSBO",95,0)
 S $P(^PSB(53.69,PSBRPT,0),U,8)=$G(ZTSK,"RPC")
"RTN","PSBO",96,0)
 D:$$SETUP @("EN^PSBO"_$P(PSBRPT(0),U,5))
"RTN","PSBO",97,0)
 K ^TMP("PSBO",$J)
"RTN","PSBO",98,0)
 S ZTREQ="@"
"RTN","PSBO",99,0)
 Q
"RTN","PSBO",100,0)
 ;
"RTN","PSBO",101,0)
IOM() ; Returns good margin or not
"RTN","PSBO",102,0)
 Q:IOM'<132 1
"RTN","PSBO",103,0)
 W !,"**************************************************************"
"RTN","PSBO",104,0)
 W !,"* SORRY, Your selected DEVICE does not print 132 columns.    *"
"RTN","PSBO",105,0)
 W !,"**************************************************************"
"RTN","PSBO",106,0)
 W !
"RTN","PSBO",107,0)
 Q 0
"RTN","PSBO",108,0)
 ;
"RTN","PSBO",109,0)
VAL(PSBFLDS) ; Validate that fields in PSBFLDS are filled in
"RTN","PSBO",110,0)
 N PSB,PSBFLD,PSBMSG,PSBSTOP,PSBST,PSBDAYS S PSBSTRT=""
"RTN","PSBO",111,0)
 F PSB=1:1 Q:$P(PSBFLDS,";",PSB)=""  S PSBFLD=$P(PSBFLDS,";",PSB),PSBFLD(PSBFLD)=$$GET^DDSVAL(53.69,DA,PSBFLD)
"RTN","PSBO",112,0)
 I $D(PSBFLD(.11)) K:$E(PSBFLD(.11))="P" PSBFLD(.13),PSBFLD(.15) K:$E(PSBFLD(.11))="W" PSBFLD(.12)
"RTN","PSBO",113,0)
 S PSB=""  F  S PSB=$O(PSBFLD(PSB)) Q:PSB=""  D:PSBFLD(PSB)=""
"RTN","PSBO",114,0)
 .I '$D(PSBMSG) S PSBMSG(0)="UNABLE TO FILE REQUEST",PSBMSG(1)=" ",PSBMSG(2)="ERROR: MISSING DATA - ALL FIELDS ARE REQUIRED",PSBMSG(3)=" "
"RTN","PSBO",115,0)
 .D FIELD^DID(53.69,PSB,"","TITLE;LABEL","PSB")
"RTN","PSBO",116,0)
 .S Z="  Missing Field: "_$S(PSB("TITLE")]"":PSB("TITLE"),1:PSB("LABEL"))
"RTN","PSBO",117,0)
 .S PSBMSG($O(PSBMSG(""),-1)+1)=Z
"RTN","PSBO",118,0)
 ; Check Times
"RTN","PSBO",119,0)
 D:$G(PSBFLD(.16))
"RTN","PSBO",120,0)
 .S PSBSTRT=PSBFLD(.16)+$G(PSBFLD(.17))
"RTN","PSBO",121,0)
 .D:$P($$GET1^DIQ(53.69,DA_",",.01),U)["MH"
"RTN","PSBO",122,0)
 ..S PSBDAYS=$$GET1^DIQ(101.24,$$FIND1^DIC(101.24,"","X","ORRP BCMA MAH","B")_",",.42)  ;check maxdays
"RTN","PSBO",123,0)
 ..S:PSBDAYS="" PSBDAYS=7
"RTN","PSBO",124,0)
 ..S X=PSBSTRT\1 D H^%DTC S PSBST=%H+PSBDAYS    ;Determine stop date
"RTN","PSBO",125,0)
 .S PSBSTOP=$S($G(PSBFLD(.18)):PSBFLD(.18),1:PSBFLD(.16))+$G(PSBFLD(.19))
"RTN","PSBO",126,0)
 .I PSBSTOP<PSBSTRT S Y=$O(PSBMSG(""),-1)+1,PSBMSG(Y)="  Date: Stop Date/Time is before Start Date/Time"
"RTN","PSBO",127,0)
 .I $P($$GET1^DIQ(53.69,DA_",",.01),U)["MH" S X=PSBSTOP\1 D H^%DTC I %H>PSBST S Y=$O(PSBMSG(""),-1)+1,PSBMSG(Y)="  The date range cannot exceed "_PSBDAYS_" day(s) as defined in the CPRS 'MAXIMUM DAYS BACK' parameter"
"RTN","PSBO",128,0)
 Q:'$D(PSBMSG)  ; All is well
"RTN","PSBO",129,0)
 D MSG^DDSUTL(.PSBMSG)
"RTN","PSBO",130,0)
 S DDSERROR=1
"RTN","PSBO",131,0)
 Q
"RTN","PSBO",132,0)
 ;
"RTN","PSBO",133,0)
SETUP() ; Setup parameters for the report in PSBRPT
"RTN","PSBO",134,0)
 N PSBWRDL,PSBINDX,PSBWRDA
"RTN","PSBO",135,0)
 K ^TMP("PSBO",$J)
"RTN","PSBO",136,0)
 F X=0,.1,.2,.3,.4,1 S PSBRPT(X)=$G(^PSB(53.69,PSBRPT,X))
"RTN","PSBO",137,0)
 I $D(^PSB(53.69,PSBRPT,2)) M PSBRPT(2)=^PSB(53.69,PSBRPT,2)
"RTN","PSBO",138,0)
 I $P(PSBRPT(.1),U,1)="P" D  I 'PSBDFN Q 0
"RTN","PSBO",139,0)
 .S PSBDFN=+$P(PSBRPT(.1),U,2) Q:'PSBDFN
"RTN","PSBO",140,0)
 .S ^TMP("PSBO",$J,PSBDFN,0)=$P(^DPT(PSBDFN,0),U)_U_$P(^DPT(PSBDFN,0),U,9),^TMP("PSBO",$J,"B",$P(^DPT(PSBDFN,0),U),PSBDFN)=""
"RTN","PSBO",141,0)
 I $P(PSBRPT(.1),U,1)="W" D  I 'PSBWRD Q 0
"RTN","PSBO",142,0)
 .S PSBWRD=$P(PSBRPT(.1),U,3) Q:'PSBWRD  D WARD^NURSUT5("L^"_PSBWRD,.PSBWRDA)
"RTN","PSBO",143,0)
 .S X="" F  S X=$O(PSBWRDA(PSBWRD,2,X)) Q:X=""   S PSBWRDL=$P(PSBWRDA(PSBWRD,2,X,.01),U,2) D
"RTN","PSBO",144,0)
 ..F PSBDFN=0:0 S PSBDFN=$O(^DPT("CN",PSBWRDL,PSBDFN)) Q:'PSBDFN  D
"RTN","PSBO",145,0)
 ...S ^TMP("PSBO",$J,PSBDFN,0)=$P(^DPT(PSBDFN,0),U)_U_$P(^DPT(PSBDFN,0),U,9)
"RTN","PSBO",146,0)
 ...; Determine Sort or default to Pt Name...
"RTN","PSBO",147,0)
 ...S:$P(PSBRPT(.1),U,5)="P" PSBINDX=$P(^DPT(PSBDFN,0),U)
"RTN","PSBO",148,0)
 ...I $P(PSBRPT(.1),U,5)="B" S PSBINDX=$P($G(^DPT(PSBDFN,.101)),U) S:PSBINDX="" PSBINDX="** NO ROOM BED **"
"RTN","PSBO",149,0)
 ...S:$P(PSBRPT(.1),U,5)="" PSBINDX=$P(^DPT(PSBDFN,0),U)
"RTN","PSBO",150,0)
 ...S:$G(PSBINDX)="" PSBINDX=$P(^DPT(PSBDFN,0),U)
"RTN","PSBO",151,0)
 ...S ^TMP("PSBO",$J,"B",PSBINDX,PSBDFN)=""
"RTN","PSBO",152,0)
 Q 1
"RTN","PSBO",153,0)
 ;
"RTN","PSBO",154,0)
WRAP(X,Y,Z)    ; Quick text wrap
"RTN","PSBO",155,0)
 ;
"RTN","PSBO",156,0)
 ; Input Parameters Description:
"RTN","PSBO",157,0)
 ;  X: Left Column of display [Optional]
"RTN","PSBO",158,0)
 ;  Y: Cols to wrap in [Optional]
"RTN","PSBO",159,0)
 ;  Z: Text to wrap [Optional]
"RTN","PSBO",160,0)
 ;
"RTN","PSBO",161,0)
 N PSB
"RTN","PSBO",162,0)
 F  Q:'$L(Z)  D
"RTN","PSBO",163,0)
 .W:$X>X !
"RTN","PSBO",164,0)
 .W:$X<X ?X
"RTN","PSBO",165,0)
 .I $L(Z)<Y W Z S Z="" Q
"RTN","PSBO",166,0)
 .F PSB=Y:-1:0 Q:$E(Z,PSB)=" "
"RTN","PSBO",167,0)
 .S:PSB<1 PSB=Y
"RTN","PSBO",168,0)
 .W $E(Z,1,PSB)
"RTN","PSBO",169,0)
 .S Z=$E(Z,PSB+1,250)
"RTN","PSBO",170,0)
 Q ""
"RTN","PSBO",171,0)
 ;
"RTN","PSBO",172,0)
CHECK ;Beginning of PSB*1*10
"RTN","PSBO",173,0)
 K ^TMP("PSJ",$J)
"RTN","PSBO",174,0)
 N PSBDFN,PSBBAR,PSBDRUG,PSBFLAG,PSBPNM,PSBNDX,PSBX
"RTN","PSBO",175,0)
 S PSBFLAG="",PSBBAR=$P($P($G(^PSB(53.69,DA,.3)),U,1),"~",2)
"RTN","PSBO",176,0)
 S PSBDRUG=$$GET1^DIQ(53.69,DA_",",.31)
"RTN","PSBO",177,0)
 S PSBDFN=$$GET1^DIQ(53.69,DA_",",.12,"I") S:$G(PSBDFN) PSBFLAG=1
"RTN","PSBO",178,0)
 D EN^PSJBCMA(PSBDFN)
"RTN","PSBO",179,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D
"RTN","PSBO",180,0)
 .K Y,PSBORD,PSBPNM,PSBNDX
"RTN","PSBO",181,0)
 .M PSBORD=^TMP("PSJ",$J,PSBX)
"RTN","PSBO",182,0)
 .F PSBNDX=700,850,950  D
"RTN","PSBO",183,0)
 ..F Y=0:0 S Y=$O(PSBORD(PSBNDX,Y)) Q:'Y  D
"RTN","PSBO",184,0)
 ...I $P($G(PSBORD(1)),U,7)'="A" Q
"RTN","PSBO",185,0)
 ...S PSBPNM=$P(PSBORD(PSBNDX,Y,0),U,1)
"RTN","PSBO",186,0)
 ...I PSBNDX=700,PSBPNM=PSBBAR S PSBFLAG=0 Q
"RTN","PSBO",187,0)
 ...I PSBNDX=850,$D(^PSDRUG("A526",PSBBAR,PSBPNM)) S PSBFLAG=0 Q
"RTN","PSBO",188,0)
 ...I PSBNDX=950,$D(^PSDRUG("A527",PSBBAR,PSBPNM)) S PSBFLAG=0
"RTN","PSBO",189,0)
 I PSBFLAG=1 D
"RTN","PSBO",190,0)
 .W !,"Patient is not currently on medication: ",PSBDRUG
"RTN","PSBO",191,0)
 .K DIRUT,DIR
"RTN","PSBO",192,0)
 .S DIR("A")="Do you want to continue"
"RTN","PSBO",193,0)
 .S DIR(0)="Y"
"RTN","PSBO",194,0)
 .D ^DIR
"RTN","PSBO",195,0)
 .S PSBANS=+Y W !
"RTN","PSBO",196,0)
 ; 
"RTN","PSBODL")
0^3^B74741447^B72460144
"RTN","PSBODL",1,0)
PSBODL ;BIRMINGHAM/EFC-DUE LIST ;Mar 2004
"RTN","PSBODL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,9,38,32,25**;Mar 2004;Build 6
"RTN","PSBODL",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified. 
"RTN","PSBODL",4,0)
 ;
"RTN","PSBODL",5,0)
 ; Reference/IA
"RTN","PSBODL",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBODL",7,0)
 ; $$GET^XPAR/2263
"RTN","PSBODL",8,0)
 ; ^XLFDT/10103
"RTN","PSBODL",9,0)
 ;
"RTN","PSBODL",10,0)
EN ; Prt DL
"RTN","PSBODL",11,0)
 N PSBGBL,PSBHDR,IOINHI,IOINORM,PSBGIVEN,PSBIEN,PSBLGDT,PSBEVDT,DFN,PSBFLAG
"RTN","PSBODL",12,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS S X=""
"RTN","PSBODL",13,0)
 I '$D(^TMP("PSBO",$J,"B")) S ^TMP("PSBO",$J,"B","EMPTY")=""
"RTN","PSBODL",14,0)
 S PSBGBL="^TMP(""PSBO"",$J,""B"")"
"RTN","PSBODL",15,0)
 I $G(PSBRPT(.4)) S $P(PSBRPT(.2),U,8)=1
"RTN","PSBODL",16,0)
 F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:$QS(PSBGBL,1)'="PSBO"!($QS(PSBGBL,2)'=$J)  D
"RTN","PSBODL",17,0)
 .S DFN=$QS(PSBGBL,5)
"RTN","PSBODL",18,0)
 .K PSBHDR
"RTN","PSBODL",19,0)
 .S PSBHDR(1)="MEDICATION DUE LIST for "
"RTN","PSBODL",20,0)
 .S (Y,PSBEVDT)=$P(PSBRPT(.1),U,6) D D^DIQ S Z=Y,PSBHDR(1)=PSBHDR(1)_Y_"@" S Y=$P(PSBRPT(.1),U,7) S PSBHDR(1)=PSBHDR(1)_$E(Y_"0000",2,5)
"RTN","PSBODL",21,0)
 .S PSBEVDT2=$P(PSBRPT(.1),U,6) S Y=$P(PSBRPT(.1),U,9) S:Y]"" PSBHDR(1)=PSBHDR(1)_" to "_Z_"@"_$E(Y_"0000",2,5)
"RTN","PSBODL",22,0)
 .S PSBHDR(2)="Schedule Type(s): --"
"RTN","PSBODL",23,0)
 .F Y=1:1:4 I $P(PSBRPT(.2),U,Y) S $P(PSBHDR(2),": ",2)=$P(PSBHDR(2),": ",2)_$S(PSBHDR(2)["--":"",1:"/ ")_$P("Continuous^PRN^On-Call^One-Time",U,Y)_" " S PSBHDR(2)=$TR(PSBHDR(2),"-","")
"RTN","PSBODL",24,0)
 .S PSBHDR(3)="Order Type(s): --"
"RTN","PSBODL",25,0)
 .F Y=6,7,8 I $P(PSBRPT(.2),U,Y) S $P(PSBHDR(3),": ",2)=$P(PSBHDR(3),": ",2)_$S(PSBHDR(3)["--":"",1:"/ ")_$P("^^^^^IV^Unit Dose^Future Orders",U,Y)_" " S PSBHDR(3)=$TR(PSBHDR(3),"-","")
"RTN","PSBODL",26,0)
 .I $QS(PSBGBL,4)="EMPTY" D  Q
"RTN","PSBODL",27,0)
 ..S X="" F  S X=$O(PSBHDR(X)) Q:X=""  D  W !!?10,"** NO DATA FOR ENTIRE NURSE/WARD LOCATION **",! Q
"RTN","PSBODL",28,0)
 ...W !,PSBHDR(X)
"RTN","PSBODL",29,0)
 .D PRINT(DFN)
"RTN","PSBODL",30,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J),^TMP("PSBO",$J)
"RTN","PSBODL",31,0)
 Q
"RTN","PSBODL",32,0)
PRINT(DFN) ;^TMP($J.
"RTN","PSBODL",33,0)
 N PSBGBL,PSBOSTRT,PSBOSTOP,PSBINDX,PSBTYPE,PSBSCH,PSBSCHT
"RTN","PSBODL",34,0)
 N PSBMED,PSBORD,PSB,PSBX,PSBY,PSBZ,PSBSTOP,PSBSTRT,PSBSM,PSBNUM,PSBAT
"RTN","PSBODL",35,0)
 N PSBADMIN,PSBADM,PSBSTAT,PSBWFLAG
"RTN","PSBODL",36,0)
 W $$HDR()
"RTN","PSBODL",37,0)
 S PSBOSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBODL",38,0)
 S PSBOSTOP=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,9)
"RTN","PSBODL",39,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J)
"RTN","PSBODL",40,0)
 D EN^PSJBCMA(DFN,PSBOSTRT,"")
"RTN","PSBODL",41,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 W !!?10,"** NO SPECIFIED MEDICATIONS TO PRINT **",!,$$BLANKS(),$$FTR^PSBODL1() Q
"RTN","PSBODL",42,0)
 S PSBI1=0 F  S PSBODATE=$$FMADD^XLFDT(PSBEVDT,PSBI1) Q:PSBODATE>PSBEVDT2  D
"RTN","PSBODL",43,0)
 .S PSBI1=1
"RTN","PSBODL",44,0)
 .S Y=PSBODATE D D^DIQ
"RTN","PSBODL",45,0)
 .W !!,"Administration Date: "_Y,!
"RTN","PSBODL",46,0)
 .S PSBINDX=0
"RTN","PSBODL",47,0)
 .F  S PSBINDX=$O(^TMP("PSJ",$J,PSBINDX)) Q:'PSBINDX  D
"RTN","PSBODL",48,0)
 ..S PSBTYPE=$P(^TMP("PSJ",$J,PSBINDX,0),U,3),PSBTYPE=$E(PSBTYPE,$L(PSBTYPE))
"RTN","PSBODL",49,0)
 ..Q:PSBTYPE=""!(PSBTYPE="P")  ; No Pend this ver
"RTN","PSBODL",50,0)
 ..S PSBSTAT=^TMP("PSJ",$J,PSBINDX,1)
"RTN","PSBODL",51,0)
 ..I $P(PSBSTAT,U,7)["D"!($P(PSBSTAT,U,7)="E")!($P(PSBSTAT,U,8)) Q
"RTN","PSBODL",52,0)
 ..Q:PSBTYPE="U"&('$P(PSBRPT(.2),U,7))
"RTN","PSBODL",53,0)
 ..Q:PSBTYPE="V"&('$P(PSBRPT(.2),U,6))
"RTN","PSBODL",54,0)
 ..S PSBTYPE=$S(PSBTYPE="U":"UD-",PSBTYPE="V":"IV-",1:"**")
"RTN","PSBODL",55,0)
 ..S Y=$P(PSBSTAT,U,2)
"RTN","PSBODL",56,0)
 ..Q:Y="C"&('$P(PSBRPT(.2),U,1))
"RTN","PSBODL",57,0)
 ..Q:Y="P"&('$P(PSBRPT(.2),U,2))
"RTN","PSBODL",58,0)
 ..Q:Y="OC"&('$P(PSBRPT(.2),U,3))
"RTN","PSBODL",59,0)
 ..Q:Y="O"&('$P(PSBRPT(.2),U,4))
"RTN","PSBODL",60,0)
 ..S PSBSCHT=Y
"RTN","PSBODL",61,0)
 ..S:PSBSCHT="" PSBSCHT="*"
"RTN","PSBODL",62,0)
 ..S PSBMED=$P(^TMP("PSJ",$J,PSBINDX,3),U,2)
"RTN","PSBODL",63,0)
 ..S PSBORD=$P(^TMP("PSJ",$J,PSBINDX,0),U,3)
"RTN","PSBODL",64,0)
 ..S ^TMP("PSB",$J,"B",PSBTYPE,PSBSCHT,PSBMED,PSBORD)=""
"RTN","PSBODL",65,0)
 .I '$D(^TMP("PSB",$J,"B")) W !!?10,"** NO SPECIFIED MEDICATIONS TO PRINT **",!,$$BLANKS(),$$FTR^PSBODL1() Q
"RTN","PSBODL",66,0)
 .S PSBGBL=$NAME(^TMP("PSB",$J,"B")),PSBWFLAG=0
"RTN","PSBODL",67,0)
 .F  S PSBGBL=$Q(@PSBGBL) Q:PSBGBL=""  Q:($QS(PSBGBL,1)'="PSB")!($QS(PSBGBL,2)'=$J)!($QS(PSBGBL,3)'="B")  D
"RTN","PSBODL",68,0)
 ..K PSBORD,PSBFUTRO
"RTN","PSBODL",69,0)
 ..S PSBTYPE=$QS(PSBGBL,4)
"RTN","PSBODL",70,0)
 ..S PSBSCHT=$QS(PSBGBL,5)
"RTN","PSBODL",71,0)
 ..S PSBMED=$QS(PSBGBL,6)
"RTN","PSBODL",72,0)
 ..S PSBORD=$QS(PSBGBL,7)
"RTN","PSBODL",73,0)
 ..D CLEAN^PSBVT
"RTN","PSBODL",74,0)
 ..D PSJ1^PSBVT(DFN,PSBORD)
"RTN","PSBODL",75,0)
 ..D NOW^%DTC S PSBNOW=%
"RTN","PSBODL",76,0)
 ..Q:PSBOSP<PSBOSTRT
"RTN","PSBODL",77,0)
 ..Q:(PSBOSP<PSBOSTRT)&(PSBSCHT'="O")
"RTN","PSBODL",78,0)
 ..Q:(PSBOSP'>PSBNOW)
"RTN","PSBODL",79,0)
 ..S (PSBYES,PSBODD,PSBDAYB,PSBSCBR)=0
"RTN","PSBODL",80,0)
 ..S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1,PSBDAYB=1
"RTN","PSBODL",81,0)
 ..F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBSCBR=1
"RTN","PSBODL",82,0)
 ..I PSBYES,PSBADST="",PSBSCHT'="O",PSBSCHT'="OC",PSBSCHT'="P" D  Q
"RTN","PSBODL",83,0)
 ...D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH)
"RTN","PSBODL",84,0)
 ..I PSBSCHT="OC" S PSBYES=1
"RTN","PSBODL",85,0)
 ..I PSBSCHT="P" S PSBYES=1
"RTN","PSBODL",86,0)
 ..I "PCS"'[PSBIVT S PSBYES=1
"RTN","PSBODL",87,0)
 ..I PSBIVT["S",PSBISYR'=1 S PSBYES=1
"RTN","PSBODL",88,0)
 ..I PSBIVT["C",PSBCHEMT'="P",PSBISYR'=1 S PSBYES=1
"RTN","PSBODL",89,0)
 ..I PSBIVT["C",PSBCHEMT="A" S PSBYES=1
"RTN","PSBODL",90,0)
 ..I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBODL",91,0)
 ..I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBODL",92,0)
 ..I PSBSCHT="P" S PSBFREQ=1440
"RTN","PSBODL",93,0)
 ..I PSBSCHT="O" S PSBFREQ=1440
"RTN","PSBODL",94,0)
 ..I 'PSBYES,PSBFREQ<1 D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH) Q
"RTN","PSBODL",95,0)
 ..S PSBVALB=$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH)
"RTN","PSBODL",96,0)
 ..I 'PSBDAYB,'PSBSCBR,PSBSCHT="C",PSBVALB="1",PSBADST'="",PSBFREQ<1 D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH) Q
"RTN","PSBODL",97,0)
 ..I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBODL",98,0)
 ..I PSBODD,PSBADST'="" D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH) Q
"RTN","PSBODL",99,0)
 ..I PSBADST'="" D
"RTN","PSBODL",100,0)
 ...F PSBY=1:1:$L(PSBADST,"-")  D
"RTN","PSBODL",101,0)
 ....D:($P(PSBADST,"-",PSBY)'?2N)&($P(PSBADST,"-",PSBY)'?4N)
"RTN","PSBODL",102,0)
 .....D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBODL",103,0)
 ..I PSBSCHT="C",PSBOTYP="U" Q:'$$OKAY^PSBVDLU1(PSBOST,PSBODATE,PSBSCH,PSBONX,PSBOITX,PSBFREQ,)
"RTN","PSBODL",104,0)
 ..I PSBSCHT="C",$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH),'$$OKAY^PSBVDLU1(PSBOST,PSBODATE,PSBSCH,PSBONX,PSBOITX,PSBFREQ) Q
"RTN","PSBODL",105,0)
 ..I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBODL",106,0)
 ...S (PSBGVN,X,Y)=""
"RTN","PSBODL",107,0)
 ...F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBODL",108,0)
 ....F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBODL",109,0)
 .....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBODL",110,0)
 ..S PSBRMN=1
"RTN","PSBODL",111,0)
 ..I PSBSCHT="O" D
"RTN","PSBODL",112,0)
 ...Q:(PSBOST'=PSBOSP)
"RTN","PSBODL",113,0)
 ...Q:(PSBOSP<PSBOSTRT)
"RTN","PSBODL",114,0)
 ...Q:((%'>PSBOST)!(%'=PSBOST))
"RTN","PSBODL",115,0)
 ...S PSBRMN=0
"RTN","PSBODL",116,0)
 ..Q:'PSBRMN
"RTN","PSBODL",117,0)
 ..I PSBOST>$$FMADD^XLFDT(PSBNOW,"","",+($$GET^XPAR("DIV","PSB ADMIN BEFORE"))) S ^TMP("PSBO",$J,DFN,PSBORD,PSBTYPE)="" Q
"RTN","PSBODL",118,0)
 ..I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBODL",119,0)
 ...S (PSBGVN,X,Y)=""
"RTN","PSBODL",120,0)
 ...F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBODL",121,0)
 ....F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBODL",122,0)
 .....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBODL",123,0)
 ..S PSBLGDT="",X=""
"RTN","PSBODL",124,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,X),-1) Q:'X  D  Q:PSBLGDT
"RTN","PSBODL",125,0)
 ...S PSBIEN=""
"RTN","PSBODL",126,0)
 ...F  S PSBIEN=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,X,PSBIEN),-1) Q:PSBIEN=""  D  Q:PSBLGDT
"RTN","PSBODL",127,0)
 ....S:$P($G(^PSB(53.79,PSBIEN,0)),U,9)="G" PSBLGDT=X
"RTN","PSBODL",128,0)
 ..S PSBADMIN="" K ^TMP("PSB",$J,"GETADMIN")
"RTN","PSBODL",129,0)
 ..I PSBSCHT="C" D  Q:PSBADMIN=""
"RTN","PSBODL",130,0)
 ...S PSBX=PSBADST,PSBFLAG=1
"RTN","PSBODL",131,0)
 ...D:PSBX=""
"RTN","PSBODL",132,0)
 ....I PSBIVT="C",PSBCHEMT="A" S PSBX="0000",PSBFLAG=0
"RTN","PSBODL",133,0)
 ....I PSBIVT="C",PSBISYR=0 S PSBX="0000",PSBFLAG=0
"RTN","PSBODL",134,0)
 ....I PSBIVT="S",PSBISYR'=1 S PSBX="0000",PSBFLAG=0
"RTN","PSBODL",135,0)
 ....I "HA"[PSBIVT S:PSBIVT]"" PSBX="0000",PSBFLAG=0
"RTN","PSBODL",136,0)
 ...I ((PSBIVT="S")!(PSBIVT="C")),(PSBISYR=1) S:+($G(PSBX))=0 PSBX=""
"RTN","PSBODL",137,0)
 ...I (PSBIVT="C"),(PSBCHEMT="P") S:+($G(PSBX))=0 PSBX=""
"RTN","PSBODL",138,0)
 ...I PSBOTYP="U",PSBX="0000" S PSBX=""
"RTN","PSBODL",139,0)
 ...I PSBIVT="P" S:+($G(PSBX))=0 PSBX=""
"RTN","PSBODL",140,0)
 ...I PSBX="" S:($G(PSBFREQ)>29)!(PSBFREQ="D") PSBX=$$GETADMIN^PSBVDLU1(DFN,PSBONX,PSBOST,PSBFREQ,PSBODATE)
"RTN","PSBODL",141,0)
 ...E  S ^TMP("PSB",$J,"GETADMIN",0)=PSBX
"RTN","PSBODL",142,0)
 ...D:PSBX'=""
"RTN","PSBODL",143,0)
 ....F PSBXX=0:1 Q:'$D(^TMP("PSB",$J,"GETADMIN",PSBXX))  S PSBX=$G(^TMP("PSB",$J,"GETADMIN",PSBXX)) D
"RTN","PSBODL",144,0)
 .....F PSBY=1:1:$L(PSBX,"-")  D
"RTN","PSBODL",145,0)
 ......S PSBAT=+(PSBODATE_"."_$P(PSBX,"-",PSBY))
"RTN","PSBODL",146,0)
 ......I PSBFLAG Q:PSBAT<PSBOSTRT!(PSBAT>PSBOSTOP)
"RTN","PSBODL",147,0)
 ......D VAL^PSBMLVAL(.PSBZ,DFN,PSBON,PSBOTYP,PSBAT)
"RTN","PSBODL",148,0)
 ......I (PSBZ(0)<0)&(PSBCNT=1) S ^TMP("PSBO",$J,DFN,PSBORD,PSBTYPE,PSBAT)="" Q
"RTN","PSBODL",149,0)
 ......I (PSBAT'["."),($G(PSBORD)["V") I (PSBOST<PSBOSTOP),(PSBOST'<PSBOSTRT) S ^TMP("PSBO",$J,DFN,PSBORD,PSBTYPE,PSBAT)="" Q
"RTN","PSBODL",150,0)
 ......Q:+PSBZ(0)<0
"RTN","PSBODL",151,0)
 ......I $G(PSBOST)'>$G(PSBAT) D
"RTN","PSBODL",152,0)
 .......Q:($G(PSBOSP)'>$G(PSBAT))
"RTN","PSBODL",153,0)
 .......S PSBADMIN=PSBADMIN_$S(PSBADMIN]"":"-",1:"")_$P(PSBX,"-",PSBY)
"RTN","PSBODL",154,0)
 ......E  I ($P($G(PSBOST),".")'>$P($G(PSBAT),"."))&($P($G(PSBAT),".",2)="") S PSBADMIN=PSBADMIN_$S(PSBADMIN]"":"-",1:"")_$P(PSBX,"-",PSBY)
"RTN","PSBODL",155,0)
 ...I +$G(PSBFREQ)>0,$G(PSBFREQ)<30,PSBADMIN'="0000" S PSBADMIN="Due every "_$G(PSBFREQ)_" minutes."
"RTN","PSBODL",156,0)
 ..I $Y>(IOSL-(12+($L(PSBADMIN)/27))) W !?(IOM-36\2),"(Medications Continued on Next Page)",$$FTR^PSBODL1(),$$HDR()
"RTN","PSBODL",157,0)
 ..I PSBSM S PSBSM=$S(PSBSMX:"H",1:"")_"SM"
"RTN","PSBODL",158,0)
 ..E  S PSBSM=""
"RTN","PSBODL",159,0)
 ..W !,$J(PSBSM,3),?6,PSBTYPE,$E(PSBSCHT,1,4),?12 S PSBWFLAG=1
"RTN","PSBODL",160,0)
 ..S X="",Y=0
"RTN","PSBODL",161,0)
 ..D WRAPPUP^PSBODL1
"RTN","PSBODL",162,0)
 .I '$G(PSBWFLAG) W !!,?10,"** NO SPECIFIED MEDICATIONS TO PRINT **"
"RTN","PSBODL",163,0)
 .W $$BLANKS(),$$FTR^PSBODL1()
"RTN","PSBODL",164,0)
 .S PSBORD=$O(^TMP("PSBO",$J,DFN,""),-1)
"RTN","PSBODL",165,0)
 .I +$G(PSBORD)>0,$P(PSBRPT(.4),U,1),$D(^TMP("PSBO",$J,DFN,PSBORD)) D EN^PSBODL1
"RTN","PSBODL",166,0)
 Q
"RTN","PSBODL",167,0)
HDR() ;
"RTN","PSBODL",168,0)
 D PT^PSBOHDR(DFN,.PSBHDR)
"RTN","PSBODL",169,0)
 W !,"Self",?85,"Last",?100,"Start",?110,"Stop",?120,"Verifying"
"RTN","PSBODL",170,0)
 W !,"Med",?6,"Sched",?14,"Medication",?50,"Dose",?78,"Route",?85,"Given",?100,"Date",?110,"Date",?120,"Rph/Rn"
"RTN","PSBODL",171,0)
 W !,?100,"@Time",?110,"@Time"
"RTN","PSBODL",172,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBODL",173,0)
 Q ""
"RTN","PSBODL",174,0)
BLANKS() ;
"RTN","PSBODL",175,0)
 Q:'$P(PSBRPT(.2),U,5) ""
"RTN","PSBODL",176,0)
 W !
"RTN","PSBODL",177,0)
 D:$Y>(IOSL-26)
"RTN","PSBODL",178,0)
 .W ?(IOM-42\2),"(Changes/Addendums to Orders on Next Page)"
"RTN","PSBODL",179,0)
 .W $$FTR^PSBODL1(),$$HDR() ; New page - no room for blanks
"RTN","PSBODL",180,0)
 I IOSL<100 F  Q:$Y>(IOSL-26)  W !
"RTN","PSBODL",181,0)
 W ?(IOM-28\2),"Changes/Addendums to orders"
"RTN","PSBODL",182,0)
 F X=1:1:4 D
"RTN","PSBODL",183,0)
 .W !,$TR($J("",IOM)," ","-")
"RTN","PSBODL",184,0)
 .W !!?3,"CON ___ PRN ___"
"RTN","PSBODL",185,0)
 .W ?20,"Drug: ",$TR($J("",22)," ","_")
"RTN","PSBODL",186,0)
 .W ?50,"Give: ",$TR($J("",42)," ","_")
"RTN","PSBODL",187,0)
 .W ?100,"Start: _________ Stop: _________"
"RTN","PSBODL",188,0)
 .W !?20,"Spec"
"RTN","PSBODL",189,0)
 .W !?3,"OT  ___ OC  ___"
"RTN","PSBODL",190,0)
 .W ?20,"Inst: ",$TR($J("",72)," ","_")
"RTN","PSBODL",191,0)
 .W ?100,"Initials: ______ Date: _________"
"RTN","PSBODL",192,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBODL",193,0)
 Q ""
"RTN","PSBVDLVL")
0^4^B63495779^B63610275
"RTN","PSBVDLVL",1,0)
PSBVDLVL ;BIRMINGHAM/EFC-BCMA VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBVDLVL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,12,11,13,32,25**;Mar 2004;Build 6
"RTN","PSBVDLVL",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBVDLVL",4,0)
 ;
"RTN","PSBVDLVL",5,0)
 ;
"RTN","PSBVDLVL",6,0)
 ; Reference/IA
"RTN","PSBVDLVL",7,0)
 ; $$GET^XPAR/2263
"RTN","PSBVDLVL",8,0)
 ; 
"RTN","PSBVDLVL",9,0)
EN(RESULTS,DFN,PSBXOR,PSBTYPE,PSBADMIN,PSBTAB,PSBUID,PSBASTS,PSBORSTS,PSBRMV) ;
"RTN","PSBVDLVL",10,0)
 ;
"RTN","PSBVDLVL",11,0)
 ; RPC: PSB VALIDATE ORDER
"RTN","PSBVDLVL",12,0)
 ;
"RTN","PSBVDLVL",13,0)
 ; Description: Final check of order against an actual administration
"RTN","PSBVDLVL",14,0)
 ;              date/time used immediately after scanned med has been
"RTN","PSBVDLVL",15,0)
 ;              validated to be a good un-administered order.
"RTN","PSBVDLVL",16,0)
 ;
"RTN","PSBVDLVL",17,0)
 K PSBTST
"RTN","PSBVDLVL",18,0)
 N PSBFLAG
"RTN","PSBVDLVL",19,0)
 I PSBRMV="I" D GETOHIST^PSBRPC2(.PSBTST,DFN,PSBXOR_PSBTYPE) S I=0 F  S I=$O(PSBTST(I)) Q:I=""  I $P(PSBTST(I),U,5)="I" S RESULTS(0)=1,RESULTS(1)="-2^" K PSBTST Q
"RTN","PSBVDLVL",20,0)
 K PSBOKAY D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBXOR_PSBTYPE) S PSB=0
"RTN","PSBVDLVL",21,0)
 S RESULTS(0)=1,RESULTS(1)="-1^***Unable to determine administration" ; Default Flag will be overwritten by anything
"RTN","PSBVDLVL",22,0)
 D NOW^%DTC
"RTN","PSBVDLVL",23,0)
 I ((PSBOSTS="A")!(PSBOSTS="R"))&(PSBOSP<%) S PSBOSTS="E"
"RTN","PSBVDLVL",24,0)
 I PSBORSTS'=PSBOSTS,((PSBSCHT'="O")&(PSBOSTS'="E")) S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="-2^ORDER STATUS MISMATCH" Q
"RTN","PSBVDLVL",25,0)
 I ((PSBTAB="UDTAB")!(PSBTAB="PBTAB")),((PSBRMV="RM")!(PSBRMV="N")) D  Q
"RTN","PSBVDLVL",26,0)
 .S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="0^OKAY TO REMOVE"  ; patch removal does not follow rest of validte rules
"RTN","PSBVDLVL",27,0)
 .I PSBASTS="" Q  ;status is not given - don't check for missmatch
"RTN","PSBVDLVL",28,0)
 .I $D(^PSB(53.79,"AORD",DFN,PSBXOR_PSBTYPE,+PSBADMIN)) S X=$O(^PSB(53.79,"AORD",DFN,PSBXOR_PSBTYPE,+PSBADMIN,"")) I $P($G(^PSB(53.79,+X,0)),U,9)'=PSBASTS  S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="-2^Admin status mismatch"
"RTN","PSBVDLVL",29,0)
 I PSBTYPE="V",PSBSCHT'="P",((PSBUID="")!(PSBUID["WS")) S RESULTS(0)=1,RESULTS(1)="0^Okay to administer" Q:PSBTAB="IVTAB"
"RTN","PSBVDLVL",30,0)
 I PSBTYPE="V",PSBUID'="" D  Q:PSBTAB="IVTAB"  ; validate IV bags Piggybacks have additional tests
"RTN","PSBVDLVL",31,0)
 .S PSB=0,PSBSUID=PSBUID D EN^PSBPOIV(DFN,PSBXOR_PSBTYPE)
"RTN","PSBVDLVL",32,0)
 .S X="" F  S X=$O(^TMP("PSBAR",$J,X)) Q:X=""  D
"RTN","PSBVDLVL",33,0)
 ..I PSBSUID'=X Q
"RTN","PSBVDLVL",34,0)
 ..S PSBUIDS=^TMP("PSBAR",$J,X)
"RTN","PSBVDLVL",35,0)
 ..I $P(PSBUIDS,U,2)="I"!($P(PSBUIDS,U,2)="S") S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="0^Okay to administer" Q  ; is infusing or stopped
"RTN","PSBVDLVL",36,0)
 ..I $P(PSBUIDS,U,1)="I" S Y=$P(^TMP("PSBAR",$J,"I"),U,2) D DD^%DT S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)=$P(^TMP("PSBAR",$J,"I"),U,3,99)_"  "_Y Q
"RTN","PSBVDLVL",37,0)
 ..I $P(PSBUIDS,U,1)["W" S PSBWS=$P(PSBUIDS,U,1) F PSBWM=2:1 Q:$P(PSBWS,";",PSBWM)=""  D
"RTN","PSBVDLVL",38,0)
 ...S Y=$P(^TMP("PSBAR",$J,"W",$P(PSBWS,";",PSBWM)),U,2) D DD^%DT S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)=$P(^TMP("PSBAR",$J,"W",$P(PSBWS,";",PSBWM)),U,3,99)_" "_Y
"RTN","PSBVDLVL",39,0)
 ..S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="0^Okay to administer"
"RTN","PSBVDLVL",40,0)
 .K ^TMP("PSBAR",$J)
"RTN","PSBVDLVL",41,0)
 ;
"RTN","PSBVDLVL",42,0)
 ; no IV orders
"RTN","PSBVDLVL",43,0)
 ;
"RTN","PSBVDLVL",44,0)
 D NOW^%DTC
"RTN","PSBVDLVL",45,0)
 I PSBOSTS="H" S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="0^Order is on Provider Hold" Q
"RTN","PSBVDLVL",46,0)
 I PSBSCHT'="O"&(%<($$FMADD^XLFDT(PSBOST,"","",$$GET^XPAR("ALL","PSB ADMIN BEFORE")*-1))) S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="-1^Order Not Active" Q
"RTN","PSBVDLVL",47,0)
 I (%>PSBOSP) S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)="-1^Order Not Active" Q
"RTN","PSBVDLVL",48,0)
 I (PSBSCHT="C")!((PSBSCHT="P")&(PSBDOSEF="PATCH")) D
"RTN","PSBVDLVL",49,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",50,0)
 .I PSBASTS["*UNKNOWN*" S PSBOKAY="-1^This administration has *UNKNOWN* status" Q
"RTN","PSBVDLVL",51,0)
 .I PSBOSTS'="A",PSBOSTS'="R",PSBOSTS'="O" S PSBOKAY="-1^Order Not Active" Q
"RTN","PSBVDLVL",52,0)
 .I PSBNGF S PSBOKAY="-1^marked DO NOT GIVE" Q
"RTN","PSBVDLVL",53,0)
 .S PSBFLAG=0 I PSBRMV="M"!(PSBRMV="H")!(PSBRMV="R") S PSBFLAG=1
"RTN","PSBVDLVL",54,0)
 .I $D(^PSB(53.79,"AORDX",DFN,PSBXOR_PSBTYPE)) D  Q:X
"RTN","PSBVDLVL",55,0)
 ..S X=0,PSBLADT=$O(^PSB(53.79,"AORDX",DFN,PSBXOR_PSBTYPE,""),-1),PSBLAIEN=$O(^PSB(53.79,"AORDX",DFN,PSBXOR_PSBTYPE,PSBLADT,""),-1)
"RTN","PSBVDLVL",56,0)
 ..I $P($G(^PSB(53.79,PSBLAIEN,0)),U,9)="G",$P($G(^PSB(53.79,PSBLAIEN,.5,1,0)),U,4)="PATCH",PSBFLAG=0 S X=1,PSBOKAY="-1^Previous patch has not been removed" Q
"RTN","PSBVDLVL",57,0)
 .I $D(^PSB(53.79,"AORD",DFN,PSBXOR_PSBTYPE,+PSBADMIN)) D  Q:+PSBOKAY<0
"RTN","PSBVDLVL",58,0)
 ..S X=$O(^PSB(53.79,"AORD",DFN,PSBXOR_PSBTYPE,+PSBADMIN,""))
"RTN","PSBVDLVL",59,0)
 ..L +^PSB(53.79,+X):1
"RTN","PSBVDLVL",60,0)
 ..I  L -^PSB(53.79,+X)
"RTN","PSBVDLVL",61,0)
 ..E  S PSBOKAY="-1^The "_$$GET1^DIQ(53.79,+X_",",.13)_" administration is being edited by another" Q
"RTN","PSBVDLVL",62,0)
 ..I $G(PSBASTS)]"" D  Q:+PSBOKAY<0
"RTN","PSBVDLVL",63,0)
 ...I $P($G(^PSB(53.79,+X,0)),U,9)="" Q
"RTN","PSBVDLVL",64,0)
 ...I $P($G(^PSB(53.79,+X,0)),U,9)'=PSBASTS S PSBOKAY="-2^Admin status mismatch" Q
"RTN","PSBVDLVL",65,0)
 .; Minutes before
"RTN","PSBVDLVL",66,0)
 .S PSBWIN1=$$GET^XPAR("DIV","PSB ADMIN BEFORE")*-1
"RTN","PSBVDLVL",67,0)
 .; Minutes After
"RTN","PSBVDLVL",68,0)
 .S PSBWIN2=$$GET^XPAR("DIV","PSB ADMIN AFTER")
"RTN","PSBVDLVL",69,0)
 .D NOW^%DTC S PSBMIN=$$DIFF^PSBUTL(PSBADMIN,%)
"RTN","PSBVDLVL",70,0)
 .; PENDING A PC SOLUTION!
"RTN","PSBVDLVL",71,0)
 .I PSBMIN<PSBWIN1 S PSBOKAY="1^Admin is "_(PSBMIN*-1)_" minutes before the scheduled administration time" Q
"RTN","PSBVDLVL",72,0)
 .I PSBMIN>PSBWIN2 S PSBOKAY="1^Admin is "_(PSBMIN)_" minutes after the scheduled administration time" Q
"RTN","PSBVDLVL",73,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",74,0)
 ; Validate a PRN Order
"RTN","PSBVDLVL",75,0)
 D:(PSBSCHT="P")
"RTN","PSBVDLVL",76,0)
 .I PSBOSTS'="A",PSBOSTS'="R",PSBOSTS'="O" S PSBOKAY="-1^Order Not Active" Q
"RTN","PSBVDLVL",77,0)
 .I PSBNGF S PSBOKAY="-1^marked DO NOT GIVE" Q
"RTN","PSBVDLVL",78,0)
 .I (+($G(PSBOKAY))<0)&(PSBDOSEF="PATCH") Q  ;A Patch may have to be removed.
"RTN","PSBVDLVL",79,0)
 .S PSBOKAY="1^"
"RTN","PSBVDLVL",80,0)
 .; Get Last Four Givens
"RTN","PSBVDLVL",81,0)
 .S PSBDT=""
"RTN","PSBVDLVL",82,0)
 .F  S PSBDT=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,PSBDT),-1) Q:PSBDT=""  D
"RTN","PSBVDLVL",83,0)
 ..S PSBDA=""
"RTN","PSBVDLVL",84,0)
 ..F  S PSBDA=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,PSBDT,PSBDA),-1) Q:'PSBDA  D
"RTN","PSBVDLVL",85,0)
 ...S (PSBCNT1,PSBCNT2,PSBCNT3)=0
"RTN","PSBVDLVL",86,0)
 ...S PSBLADT=$$GET1^DIQ(53.79,PSBDA_",",.06,"I")
"RTN","PSBVDLVL",87,0)
 ...S PSBSTUS=$$GET1^DIQ(53.79,PSBDA_",",.09)
"RTN","PSBVDLVL",88,0)
 ...S:PSBSTUS="" PSBSTUS="U"
"RTN","PSBVDLVL",89,0)
 ...S PSBSCH=$$GET1^DIQ(53.79,PSBDA_",",.12)
"RTN","PSBVDLVL",90,0)
 ...S PSBRSN=$$GET1^DIQ(53.79,PSBDA_",",.21)
"RTN","PSBVDLVL",91,0)
 ...S PSBINJ=$$GET1^DIQ(53.79,PSBDA_",",.16)
"RTN","PSBVDLVL",92,0)
 ...Q:$P(^PSB(53.79,PSBDA,0),U,9)="N"
"RTN","PSBVDLVL",93,0)
 ...F PSBZ=.5,.6,.7 F PSBY=0:0 S PSBY=$O(^PSB(53.79,PSBDA,PSBZ,PSBY)) Q:'PSBY  D
"RTN","PSBVDLVL",94,0)
 ....Q:'$D(^PSB(53.79,PSBDA,PSBZ,PSBY))
"RTN","PSBVDLVL",95,0)
 ....S PSBDD=$S(PSBZ=.5:53.795,PSBZ=.6:53.796,1:53.797)
"RTN","PSBVDLVL",96,0)
 ....S PSBUNIT=$$GET1^DIQ(PSBDD,PSBY_","_PSBDA_",",.03)
"RTN","PSBVDLVL",97,0)
 ....S PSBUNFR=$$GET1^DIQ(PSBDD,PSBY_","_PSBDA_",",.04)
"RTN","PSBVDLVL",98,0)
 ....I PSBZ=.5 S PSBCNT1=PSBCNT1+1
"RTN","PSBVDLVL",99,0)
 ....I PSBZ=.6 S PSBCNT2=PSBCNT2+1
"RTN","PSBVDLVL",100,0)
 ....I PSBZ=.7 S PSBCNT3=PSBCNT3+1
"RTN","PSBVDLVL",101,0)
 ...;Units given or free text not to display for multiple dispense drugs or additives and solution
"RTN","PSBVDLVL",102,0)
 ...I (PSBCNT1>1)!(PSBCNT2>0)!(PSBCNT3>0) S (PSBUNIT,PSBUNFR)=""
"RTN","PSBVDLVL",103,0)
 ...S X=PSBLADT_U
"RTN","PSBVDLVL",104,0)
 ...S X=X_PSBSTUS_U_PSBSCH_U_$G(PSBRSN)_U_$G(PSBINJ)_U_$G(PSBUNIT)_U_$G(PSBUNFR)
"RTN","PSBVDLVL",105,0)
 ...S PSBOKAY($O(PSBOKAY(""),-1)+1)=3_U_X
"RTN","PSBVDLVL",106,0)
 ...S:$D(PSBOKAY(4)) PSBDT=0
"RTN","PSBVDLVL",107,0)
 .S X1=$$LASTG^PSBCSUTL(DFN,+PSBOIT) I X1>0 S PSBOKAY($O(PSBOKAY(""),-1)+1)=4_U_X1
"RTN","PSBVDLVL",108,0)
 ; Validate a One-Time Order
"RTN","PSBVDLVL",109,0)
 D:PSBSCHT="O"
"RTN","PSBVDLVL",110,0)
 .S (PSBGVN,X,Y)=""
"RTN","PSBVDLVL",111,0)
 .F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1)  Q:'X  F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  I $P(^PSB(53.79,Y,.1),U)=PSBONX,"G"[$P(^PSB(53.79,Y,0),U,9) S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLVL",112,0)
 .I PSBGVN S PSBOKAY="-1^Dose Already on medication Log" Q
"RTN","PSBVDLVL",113,0)
 .; One Time are automatically expired so we don't check STATUS here
"RTN","PSBVDLVL",114,0)
 .I PSBNGF S PSBOKAY="-1^marked DO NOT GIVE" Q
"RTN","PSBVDLVL",115,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",116,0)
 ; Validate an On Call Order
"RTN","PSBVDLVL",117,0)
 D:PSBSCHT="OC"
"RTN","PSBVDLVL",118,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",119,0)
 .S (PSBGVN,X,Y)=""
"RTN","PSBVDLVL",120,0)
 .F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1)  Q:'X  F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  I $P(^PSB(53.79,Y,.1),U)=PSBONX,"G"[$P(^PSB(53.79,Y,0),U,9) S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLVL",121,0)
 .I PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL")) S PSBOKAY="-1^Dose Already on medication Log" Q
"RTN","PSBVDLVL",122,0)
 .I PSBOSTS'="A",PSBOSTS'="R",PSBOSTS'="O" S PSBOKAY="-1^Order Not Active" Q
"RTN","PSBVDLVL",123,0)
 .I PSBNGF S PSBOKAY="-1^marked DO NOT GIVE" Q
"RTN","PSBVDLVL",124,0)
 .I PSBGVN&($$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))&(PSBDOSEF="PATCH") S PSBOKAY="-1^Previous patch has not been removed" Q
"RTN","PSBVDLVL",125,0)
 .S PSBOKAY="0^Okay to administer"
"RTN","PSBVDLVL",126,0)
 ;
"RTN","PSBVDLVL",127,0)
 D:+PSBOKAY'<0
"RTN","PSBVDLVL",128,0)
 .N PSBDIFF,Y
"RTN","PSBVDLVL",129,0)
 .D:(PSBSCHT="C")!(PSBSCHT="OC"&('$G(PSBGVN)))
"RTN","PSBVDLVL",130,0)
 ..; On-call or cont and not on the log.
"RTN","PSBVDLVL",131,0)
 ..S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,""),-1)
"RTN","PSBVDLVL",132,0)
 ..;Check for the status of the medication and insert status in the text
"RTN","PSBVDLVL",133,0)
 ..I Y]"" S X=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,Y,""),-1),PSBSTUS=$P(^PSB(53.79,X,0),U,9)
"RTN","PSBVDLVL",134,0)
 ..S:Y']"" PSBSTUS=""
"RTN","PSBVDLVL",135,0)
 ..I PSBSTUS="N" D  Q:$G(PSBQUIT)
"RTN","PSBVDLVL",136,0)
 ...S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y,X),-1)
"RTN","PSBVDLVL",137,0)
 ...D:X']""
"RTN","PSBVDLVL",138,0)
 ....S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y),-1) I Y']"" S PSBQUIT=1 Q
"RTN","PSBVDLVL",139,0)
 ....S X=$O(^PSB(53.79,"AOIP",DFN,+PSBOIT,Y,""),-1),PSBSTUS=$P(^PSB(53.79,X,0),U,9)
"RTN","PSBVDLVL",140,0)
 ..S PSBDIFF=$$FMDIFF^XLFDT($$NOW^XLFDT(),Y,2)
"RTN","PSBVDLVL",141,0)
 ..Q:PSBDIFF>7200  ; Greater than 2 hours
"RTN","PSBVDLVL",142,0)
 ..I (PSBSTUS="G")!(PSBSTUS="H")!(PSBSTUS="R")!(PSBSTUS="RM") D
"RTN","PSBVDLVL",143,0)
 ...S PSBSTUS=$$GET1^DIQ(53.79,X_",",.09)
"RTN","PSBVDLVL",144,0)
 ...I PSBSTUS'="" D
"RTN","PSBVDLVL",145,0)
 ....S Y="1^*** NOTICE, "_PSBOITX_" was "_PSBSTUS_" "_(PSBDIFF\60)_" minutes ago."
"RTN","PSBVDLVL",146,0)
 ....I +PSBOKAY=1 S PSBOKAY(1)=Y
"RTN","PSBVDLVL",147,0)
 ....E  S PSBOKAY=Y
"RTN","PSBVDLVL",148,0)
 ;
"RTN","PSBVDLVL",149,0)
 S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)=PSBOKAY
"RTN","PSBVDLVL",150,0)
 F X=1:1 Q:'$D(PSBOKAY(X))  S PSB=PSB+1,RESULTS(0)=PSB,RESULTS(PSB)=PSBOKAY(X)
"RTN","PSBVDLVL",151,0)
 Q
"RTN","PSBVDLVL",152,0)
 ;
"VER")
8.0^22.0
"BLD",6469,6)
^33
**END**
**END**

EMERGENCY Released PSB*3*78 SEQ #65
Extracted from mail message
**KIDS**:PSB*3.0*78^

**INSTALL NAME**
PSB*3.0*78
"BLD",9617,0)
PSB*3.0*78^BAR CODE MED ADMIN^0^3140130^y
"BLD",9617,1,0)
^^10^10^3140129^
"BLD",9617,1,1,0)
This Patch Addresses 2 issues:
"BLD",9617,1,2,0)
 
"BLD",9617,1,3,0)
1. An order will not display on the Bar Code Medication
"BLD",9617,1,4,0)
Administration (BCMA) Virtual Due List (VDL) properly 
"BLD",9617,1,5,0)
if the order has its first administration time not on the
"BLD",9617,1,6,0)
hour and the start date and time are not exactly on the hour.
"BLD",9617,1,7,0)
 
"BLD",9617,1,8,0)
2. The BCMA PRN Effectiveness Report and Medication
"BLD",9617,1,9,0)
Variance Report do not display the ward name when
"BLD",9617,1,10,0)
printed by ward.
"BLD",9617,4,0)
^9.64PA^^
"BLD",9617,6.3)
8
"BLD",9617,"KRN",0)
^9.67PA^779.2^20
"BLD",9617,"KRN",.4,0)
.4
"BLD",9617,"KRN",.401,0)
.401
"BLD",9617,"KRN",.402,0)
.402
"BLD",9617,"KRN",.403,0)
.403
"BLD",9617,"KRN",.5,0)
.5
"BLD",9617,"KRN",.84,0)
.84
"BLD",9617,"KRN",3.6,0)
3.6
"BLD",9617,"KRN",3.8,0)
3.8
"BLD",9617,"KRN",9.2,0)
9.2
"BLD",9617,"KRN",9.8,0)
9.8
"BLD",9617,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",9617,"KRN",9.8,"NM",1,0)
PSBVDLTB^^0^B34445687
"BLD",9617,"KRN",9.8,"NM",2,0)
PSBOMV^^0^B51967870
"BLD",9617,"KRN",9.8,"NM",3,0)
PSBOPE^^0^B22369471
"BLD",9617,"KRN",9.8,"NM","B","PSBOMV",2)

"BLD",9617,"KRN",9.8,"NM","B","PSBOPE",3)

"BLD",9617,"KRN",9.8,"NM","B","PSBVDLTB",1)

"BLD",9617,"KRN",19,0)
19
"BLD",9617,"KRN",19.1,0)
19.1
"BLD",9617,"KRN",101,0)
101
"BLD",9617,"KRN",409.61,0)
409.61
"BLD",9617,"KRN",771,0)
771
"BLD",9617,"KRN",779.2,0)
779.2
"BLD",9617,"KRN",870,0)
870
"BLD",9617,"KRN",8989.51,0)
8989.51
"BLD",9617,"KRN",8989.52,0)
8989.52
"BLD",9617,"KRN",8994,0)
8994
"BLD",9617,"KRN","B",.4,.4)

"BLD",9617,"KRN","B",.401,.401)

"BLD",9617,"KRN","B",.402,.402)

"BLD",9617,"KRN","B",.403,.403)

"BLD",9617,"KRN","B",.5,.5)

"BLD",9617,"KRN","B",.84,.84)

"BLD",9617,"KRN","B",3.6,3.6)

"BLD",9617,"KRN","B",3.8,3.8)

"BLD",9617,"KRN","B",9.2,9.2)

"BLD",9617,"KRN","B",9.8,9.8)

"BLD",9617,"KRN","B",19,19)

"BLD",9617,"KRN","B",19.1,19.1)

"BLD",9617,"KRN","B",101,101)

"BLD",9617,"KRN","B",409.61,409.61)

"BLD",9617,"KRN","B",771,771)

"BLD",9617,"KRN","B",779.2,779.2)

"BLD",9617,"KRN","B",870,870)

"BLD",9617,"KRN","B",8989.51,8989.51)

"BLD",9617,"KRN","B",8989.52,8989.52)

"BLD",9617,"KRN","B",8994,8994)

"BLD",9617,"QUES",0)
^9.62^^
"BLD",9617,"REQB",0)
^9.611^2^2
"BLD",9617,"REQB",1,0)
PSB*3.0*70^2
"BLD",9617,"REQB",2,0)
PSB*3.0*60^2
"BLD",9617,"REQB","B","PSB*3.0*60",2)

"BLD",9617,"REQB","B","PSB*3.0*70",1)

"MBREQ")
0
"PKG",550,-1)
1^1
"PKG",550,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",550,20,0)
^9.402P^^
"PKG",550,22,0)
^9.49I^1^1
"PKG",550,22,1,0)
3.0^3040224^3040311^66481
"PKG",550,22,1,"PAH",1,0)
78^3140130
"PKG",550,22,1,"PAH",1,1,0)
^^10^10^3140130
"PKG",550,22,1,"PAH",1,1,1,0)
This Patch Addresses 2 issues:
"PKG",550,22,1,"PAH",1,1,2,0)
 
"PKG",550,22,1,"PAH",1,1,3,0)
1. An order will not display on the Bar Code Medication
"PKG",550,22,1,"PAH",1,1,4,0)
Administration (BCMA) Virtual Due List (VDL) properly 
"PKG",550,22,1,"PAH",1,1,5,0)
if the order has its first administration time not on the
"PKG",550,22,1,"PAH",1,1,6,0)
hour and the start date and time are not exactly on the hour.
"PKG",550,22,1,"PAH",1,1,7,0)
 
"PKG",550,22,1,"PAH",1,1,8,0)
2. The BCMA PRN Effectiveness Report and Medication
"PKG",550,22,1,"PAH",1,1,9,0)
Variance Report do not display the ward name when
"PKG",550,22,1,"PAH",1,1,10,0)
printed by ward.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSBOMV")
0^2^B51967870^B49401054
"RTN","PSBOMV",1,0)
PSBOMV ;BIRMINGHAM/EFC-BCMA UNIT DOSE VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBOMV",2,0)
 ;;3.0;BAR CODE MED ADMIN;**60,78**;Mar 2004;Build 8
"RTN","PSBOMV",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOMV",4,0)
 ;
"RTN","PSBOMV",5,0)
 ; Reference/IA
"RTN","PSBOMV",6,0)
 ; ^DPT/10035
"RTN","PSBOMV",7,0)
 ; ^NURSF(211.4/1409
"RTN","PSBOMV",8,0)
 ;
"RTN","PSBOMV",9,0)
EN ;
"RTN","PSBOMV",10,0)
 N CNT,PSBHDR,PSBPT,PSBINDX,DFN,PSBY,PSBSORT,PSBPRINT,PSBDT,PSBEV,PSBLOG,PSBPRCX,PSBRB,PSBSTOP,PSBSTRT,PSBTIME,PSBWLF,PSBWRD,PSBWRDA,PSBX,PSBY,PSBXX
"RTN","PSBOMV",11,0)
 ;
"RTN","PSBOMV",12,0)
 K ^TMP("PSBO",$J)
"RTN","PSBOMV",13,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOMV",14,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOMV",15,0)
 S CNT=0,PSBPRINT=$P($G(PSBRPT(.1)),U)
"RTN","PSBOMV",16,0)
 I PSBPRINT="P" S PSBPT=$P(PSBRPT(.1),U,2)
"RTN","PSBOMV",17,0)
 I PSBPRINT="W" S PSBSORT=$P($G(PSBRPT(.1)),U,5),PSBWRD=$P(PSBRPT(.1),U,3) Q:'PSBWRD  D WARD^NURSUT5("L^"_PSBWRD,.PSBWRDA)
"RTN","PSBOMV",18,0)
 ;
"RTN","PSBOMV",19,0)
RANGE ;Locate data between date range.
"RTN","PSBOMV",20,0)
 N PSBTMDF
"RTN","PSBOMV",21,0)
 S PSBX=PSBSTRT F  S PSBX=$O(^PSB(53.78,"ADT",PSBX)) Q:'PSBX!(PSBX>PSBSTOP)  D
"RTN","PSBOMV",22,0)
 .F PSBY=0:0 S PSBY=$O(^PSB(53.78,"ADT",PSBX,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",23,0)
 ..S DFN=+^PSB(53.78,PSBY,0),PSBWLF=$P($G(^(0)),U,9),PSBTIME=$P($G(^(0)),U,4),PSBLOG=$P($G(^(0)),U,8)
"RTN","PSBOMV",24,0)
CHECK ..;Ward IEN must exist in Ward Field # 9.
"RTN","PSBOMV",25,0)
 ..Q:'$G(PSBWLF)
"RTN","PSBOMV",26,0)
 ..Q:'$G(PSBLOG)
"RTN","PSBOMV",27,0)
 ..;PSB*3*60 adds code to allow a variance equal to system variable DILOCKTM when checking for removal of a patch
"RTN","PSBOMV",28,0)
 ..S PSBTMDF=$$FMDIFF^XLFDT($P($G(^PSB(53.79,PSBLOG,0)),U,6),$G(PSBTIME),2) ;PSB*3*60
"RTN","PSBOMV",29,0)
 ..I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3),$P($G(^PSB(53.79,PSBLOG,0)),U,9)="RM" Q  ;PSB*3*60
"RTN","PSBOMV",30,0)
 ..;Quit if Ward IEN is not in Nurse Location file.
"RTN","PSBOMV",31,0)
 ..I PSBPRINT="W",'$O(^NURSF(211.4,"C",PSBWLF,PSBWRD,0)) Q
"RTN","PSBOMV",32,0)
 ..;Compare date/time and Quit if order status set to Remove.
"RTN","PSBOMV",33,0)
 ..;
"RTN","PSBOMV",34,0)
BUILD ..I $G(PSBSORT)'="B" S ^TMP("PSBO",$J,DFN,PSBX,PSBY)=""
"RTN","PSBOMV",35,0)
 ..I PSBPRINT="P",DFN=PSBPT S ^TMP("PSBO",$J,"B",$P(^DPT(DFN,0),U),DFN)="" Q
"RTN","PSBOMV",36,0)
 ..S ^TMP("PSBO",$J,DFN,0)=^DPT(DFN,0)
"RTN","PSBOMV",37,0)
 ..I PSBPRINT="W" D SORTING
"RTN","PSBOMV",38,0)
 ;
"RTN","PSBOMV",39,0)
BYWDPT ;Print by Ward and Sort by Patient.
"RTN","PSBOMV",40,0)
 I $G(PSBPRINT)="W",$G(PSBSORT)'="B" D
"RTN","PSBOMV",41,0)
 .;Print report by the selected ward name.
"RTN","PSBOMV",42,0)
 .W $$WRDHDR()
"RTN","PSBOMV",43,0)
 .S PSBINDX=""
"RTN","PSBOMV",44,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",45,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",46,0)
 ...W:$Y>(IOSL-10) $$WRDHDR()
"RTN","PSBOMV",47,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",48,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",49,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",50,0)
 .....S PSBRB=$$GET1^DIQ(53.78,PSBY_",",.02)
"RTN","PSBOMV",51,0)
 .....W !,PSBRB
"RTN","PSBOMV",52,0)
 .....W ?20,$P(^TMP("PSBO",$J,DFN,0),U,1)
"RTN","PSBOMV",53,0)
 .....W ?48,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",54,0)
 .....W ?75,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",55,0)
 .....W ?95,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",56,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",57,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",58,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",59,0)
 .....W !?52
"RTN","PSBOMV",60,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",61,0)
 ;
"RTN","PSBOMV",62,0)
BYWDRB ;Print by Ward and Sort by Room and Bed.
"RTN","PSBOMV",63,0)
 I $G(PSBPRINT)="W",$G(PSBSORT)="B" D
"RTN","PSBOMV",64,0)
 .;Print report by the selected ward name.
"RTN","PSBOMV",65,0)
 .W $$WRDHDR()
"RTN","PSBOMV",66,0)
 .S PSBINDX=""
"RTN","PSBOMV",67,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",68,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",69,0)
 ...W:$Y>(IOSL-10) $$WRDHDR()
"RTN","PSBOMV",70,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",71,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",72,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",73,0)
 .....S PSBRB=$$GET1^DIQ(53.78,PSBY_",",.02)
"RTN","PSBOMV",74,0)
 .....W !,PSBRB
"RTN","PSBOMV",75,0)
 .....W ?20,$P(^TMP("PSBO",$J,DFN,0),U,1)
"RTN","PSBOMV",76,0)
 .....W ?48,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",77,0)
 .....W ?75,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",78,0)
 .....W ?95,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",79,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",80,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",81,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",82,0)
 .....W !?52
"RTN","PSBOMV",83,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",84,0)
 ;
"RTN","PSBOMV",85,0)
BYDFN ;Print by Patient.
"RTN","PSBOMV",86,0)
 D:$G(PSBPRINT)="P"
"RTN","PSBOMV",87,0)
 .W $$PTHDR()
"RTN","PSBOMV",88,0)
 .S PSBINDX=""
"RTN","PSBOMV",89,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",90,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",91,0)
 ...W:$Y>(IOSL-10) $$PTHDR()
"RTN","PSBOMV",92,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",93,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",94,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",95,0)
 .....W !,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",96,0)
 .....W ?23,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",97,0)
 .....W ?43,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",98,0)
 .....W ?50,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",99,0)
 .....W ?50,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",100,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",101,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",102,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOMV",103,0)
 Q
"RTN","PSBOMV",104,0)
 ;
"RTN","PSBOMV",105,0)
WRDHDR() ;
"RTN","PSBOMV",106,0)
 N PSBSRCHL ;Add PSBSRCHL variable and additional PSBHDR array spacers for PSBOHDR call, PSB*3*78
"RTN","PSBOMV",107,0)
 S PSBHDR(1)="MEDICATION VARIANCE LOG"
"RTN","PSBOMV",108,0)
 S PSBSRCHL=$$SRCHLIST^PSBOHDR()
"RTN","PSBOMV",109,0)
 S PSBHDR(2)="",PSBHDR(3)="",PSBHDR(4)="Ward Location: "
"RTN","PSBOMV",110,0)
 D WARD^PSBOHDR(PSBWRD,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOMV",111,0)
 W !,"Rm-Bed",?20,"Patient Name",?48,"Event Date/Time",?75,"Event",?95,"Var",?102,"Medication",!,$TR($J("",IOM)," ","-")
"RTN","PSBOMV",112,0)
 Q ""
"RTN","PSBOMV",113,0)
 ;
"RTN","PSBOMV",114,0)
PTHDR() ;
"RTN","PSBOMV",115,0)
 S PSBHDR(1)="MEDICATION VARIANCE LOG"
"RTN","PSBOMV",116,0)
 D PT^PSBOHDR(PSBDFN,.PSBHDR)
"RTN","PSBOMV",117,0)
 W !,"Event Date/Time",?23,"Event",?43,"Var",?50,"Medication",!,$TR($J("",IOM)," ","-")
"RTN","PSBOMV",118,0)
 Q ""
"RTN","PSBOMV",119,0)
 ;
"RTN","PSBOMV",120,0)
VCOM ;Print Ward and Comments from Med Log on Variance Report.
"RTN","PSBOMV",121,0)
 N PSBCOM,PSBML,Y
"RTN","PSBOMV",122,0)
 Q:'$P($G(^PSB(53.78,PSBY,0)),"^",8)  S PSBML=$P(^(0),"^",8)
"RTN","PSBOMV",123,0)
 I $P(PSBRPT(.1),U)="P" W !,?23,"Ward:      ",?34 D
"RTN","PSBOMV",124,0)
 .I $P($G(^PSB(53.79,PSBML,0)),U,2)=""  W "<No Ward>" Q
"RTN","PSBOMV",125,0)
 .W $P($G(^PSB(53.79,PSBML,0)),U,2)
"RTN","PSBOMV",126,0)
 W !,?23,"Comments:  ",?34 I '$O(^PSB(53.79,PSBML,.3,0))  W "<No Comments>" I $Y>(IOSL-10) D  Q  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",127,0)
 .I $G(PSBPRINT)="P" W $$PTFTR^PSBOHDR(),!,$$PTHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",128,0)
 .I $G(PSBPRINT)="W" W !,$$WRDHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",129,0)
 F PSBCOM=0:0 S PSBCOM=$O(^PSB(53.79,PSBML,.3,PSBCOM)) Q:'PSBCOM  D
"RTN","PSBOMV",130,0)
 .W:$X>34 !?34
"RTN","PSBOMV",131,0)
 .S Y=$P(^PSB(53.79,PSBML,.3,PSBCOM,0),U,3)+.0000001
"RTN","PSBOMV",132,0)
 .W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)," ",$E(Y,9,10),":",$E(Y,11,12),?50,"By: ",$$GET1^DIQ(53.793,PSBCOM_","_PSBML_",","ENTERED BY:INITIAL"),$$WRAP^PSBO(60,75,$P(^PSB(53.79,PSBML,.3,PSBCOM,0),U,1))
"RTN","PSBOMV",133,0)
 .I $Y>(IOSL-10) D  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",134,0)
 ..I $G(PSBPRINT)="P" W $$PTFTR^PSBOHDR(),!,$$PTHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",135,0)
 ..I $G(PSBPRINT)="W" W !,$$WRDHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",136,0)
 Q
"RTN","PSBOMV",137,0)
 ;
"RTN","PSBOMV",138,0)
EVENTS ;Record total number of events.
"RTN","PSBOMV",139,0)
 S PSBEV=$P($G(^PSB(53.78,PSBY,0)),U,5) Q:'$G(PSBEV)
"RTN","PSBOMV",140,0)
 S ^TMP("PSBO",$J,"EVENTS",PSBEV,0)=$P($G(^TMP("PSBO",$J,"EVENTS",PSBEV,0)),U)+1
"RTN","PSBOMV",141,0)
 S CNT=CNT+1,^TMP("PSBO",$J,"EVENTSTOT",0)=CNT
"RTN","PSBOMV",142,0)
 Q
"RTN","PSBOMV",143,0)
EVEPRNT ;Display Total and Percentage of Events.
"RTN","PSBOMV",144,0)
 ;
"RTN","PSBOMV",145,0)
 Q:'$D(^TMP("PSBO",$J,"EVENTSTOT"))  ;Quit if there are no events
"RTN","PSBOMV",146,0)
 W !,"Total Number of Events for the reporting period is: "_$P(^TMP("PSBO",$J,"EVENTSTOT",0),U)_".",!
"RTN","PSBOMV",147,0)
 F PSBXX=0:0 S PSBXX=$O(^TMP("PSBO",$J,"EVENTS",PSBXX)) Q:'PSBXX  D
"RTN","PSBOMV",148,0)
 .W !,"Total number of "_$$EXTERNAL^DILFD(53.78,.05,"",PSBXX)_" events is "_$P($G(^TMP("PSBO",$J,"EVENTS",PSBXX,0)),U)_"."
"RTN","PSBOMV",149,0)
 .S PSBPRCX=$E($FN($P(^TMP("PSBO",$J,"EVENTS",PSBXX,0),U)/$P(^TMP("PSBO",$J,"EVENTSTOT",0),U),"",2),3,4)
"RTN","PSBOMV",150,0)
 .W !,"Percentage of Total Events: "_$S(PSBPRCX="00":"100",1:PSBPRCX)_"%",!
"RTN","PSBOMV",151,0)
 Q
"RTN","PSBOMV",152,0)
 ;
"RTN","PSBOMV",153,0)
SORTING ;Sort by Patient or Room and Bed Information
"RTN","PSBOMV",154,0)
 ;
"RTN","PSBOMV",155,0)
 I $G(PSBSORT)="P"!($G(PSBSORT)="") S PSBINDX=$P(^DPT(DFN,0),U),^TMP("PSBO",$J,"B",PSBINDX,DFN)="" Q
"RTN","PSBOMV",156,0)
 I $G(PSBSORT)="B" S PSBINDX=$P($G(^PSB(53.78,+PSBY,0)),U,2) S:PSBINDX="" PSBINDX="** NO ROOM/BED **" S ^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBX,PSBY)=""
"RTN","PSBOMV",157,0)
 Q 
"RTN","PSBOPE")
0^3^B22369471^B20462828
"RTN","PSBOPE",1,0)
PSBOPE ;BIRMINGHAM/EFC-PRN EFFECTIVENESS WORKSHEET ;8/12/12 10:57pm
"RTN","PSBOPE",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,23,32*,70,78*;Mar 2004;Build 8
"RTN","PSBOPE",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOPE",4,0)
 ;
"RTN","PSBOPE",5,0)
 ; Reference/IA
"RTN","PSBOPE",6,0)
 ; ^DPT/10035
"RTN","PSBOPE",7,0)
 ; EN^PSJBCMA/2828
"RTN","PSBOPE",8,0)
 ;
"RTN","PSBOPE",9,0)
 ;*70 - reset PSBCLINORD = 2 to signify combined orders report
"RTN","PSBOPE",10,0)
 ;
"RTN","PSBOPE",11,0)
EN ; Called from DQ^PSBO
"RTN","PSBOPE",12,0)
 N PSBSTRT,PSBSTOP,DFN
"RTN","PSBOPE",13,0)
 K ^TMP("PSB",$J)
"RTN","PSBOPE",14,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOPE",15,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOPE",16,0)
 F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,DFN)) Q:'DFN  D EN1
"RTN","PSBOPE",17,0)
 D PRINT
"RTN","PSBOPE",18,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J)
"RTN","PSBOPE",19,0)
 Q
"RTN","PSBOPE",20,0)
 ;
"RTN","PSBOPE",21,0)
EN1 ; Expects DFN,PSBSTRT,PSBSTOP from EN
"RTN","PSBOPE",22,0)
 N PSBGBL,PSBHDR,PSBX,PSBADMIN,PSBDFN,PSBDT,PSBMED,PSBORD,PSBOSTRT,PSBSCHED
"RTN","PSBOPE",23,0)
 K ^TMP("PSJ",$J)
"RTN","PSBOPE",24,0)
 S PSBDT=PSBSTRT-.0000001
"RTN","PSBOPE",25,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOPE",26,0)
 .S PSBIEN=0
"RTN","PSBOPE",27,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  D
"RTN","PSBOPE",28,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="P"  ; Not a PRN Administration
"RTN","PSBOPE",29,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,.2)),U,2)]""  ; Effectiveness entered
"RTN","PSBOPE",30,0)
 ..Q:($P($G(^PSB(53.79,PSBIEN,0)),U,9)'="G")&($P($G(^PSB(53.79,PSBIEN,0)),U,9)'="RM")  ;Allow only entries with at status of "GIVEN" and "REMOVED"
"RTN","PSBOPE",31,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,0)),U,6)<PSBDT
"RTN","PSBOPE",32,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,0)),U,6)>PSBSTOP
"RTN","PSBOPE",33,0)
 ..S ^TMP("PSB",$J,DFN,PSBIEN)=""
"RTN","PSBOPE",34,0)
 Q
"RTN","PSBOPE",35,0)
PRINT ; Print meds stored in ^TMP("PSB",$J,DFN,....
"RTN","PSBOPE",36,0)
 N PSBHDR,PSBDT,PSBMED,DFN
"RTN","PSBOPE",37,0)
 ;
"RTN","PSBOPE",38,0)
 ; Print by Patient
"RTN","PSBOPE",39,0)
 ;
"RTN","PSBOPE",40,0)
 D:$P(PSBRPT(.1),U,1)="P"
"RTN","PSBOPE",41,0)
 .S PSBHDR(1)="PRN EFFECTIVENESS LIST for "_$$FMTE^XLFDT(PSBSTRT)_" to "_$$FMTE^XLFDT(PSBSTOP)
"RTN","PSBOPE",42,0)
 .S DFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOPE",43,0)
 .W $$PTHDR()
"RTN","PSBOPE",44,0)
 .I '$O(^TMP("PSB",$J,DFN,0)) W !,"No PRN Medications Found",$$PTFTR^PSBOHDR() Q
"RTN","PSBOPE",45,0)
 .W !  ; Line Break Between Admin Times
"RTN","PSBOPE",46,0)
 .S PSBIEN=""
"RTN","PSBOPE",47,0)
 .F  S PSBIEN=$O(^TMP("PSB",$J,DFN,PSBIEN)) Q:PSBIEN=""  D
"RTN","PSBOPE",48,0)
 ..S PSBIENS=PSBIEN_","
"RTN","PSBOPE",49,0)
 ..I $Y>(IOSL-5) W $$PTFTR^PSBOHDR(),$$PTHDR()
"RTN","PSBOPE",50,0)
 ..W !,$$GET1^DIQ(53.79,PSBIENS,.06),?30,$$GET1^DIQ(53.79,PSBIENS,.08),?64,$$GET1^DIQ(53.79,PSBIENS,"ACTION BY")                      ;*70
"RTN","PSBOPE",51,0)
 ..W ?102,$$GET1^DIQ(53.79,PSBIENS,"PATIENT LOCATION")           ;*70
"RTN","PSBOPE",52,0)
 ..W !,?5,"PRN Reason: ",$$GET1^DIQ(53.79,PSBIENS,.21)
"RTN","PSBOPE",53,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOPE",54,0)
 .Q
"RTN","PSBOPE",55,0)
 ;
"RTN","PSBOPE",56,0)
 ; Print by Ward
"RTN","PSBOPE",57,0)
 ;
"RTN","PSBOPE",58,0)
 D:$P(PSBRPT(.1),U,1)="W"
"RTN","PSBOPE",59,0)
 .S PSBHDR(1)="PRN EFFECTIVENESS LIST  from "_$$FMTE^XLFDT(PSBSTRT)_" thru "_$$FMTE^XLFDT(PSBSTOP)
"RTN","PSBOPE",60,0)
 .S PSBWARD=$P(PSBRPT(.1),U,3)
"RTN","PSBOPE",61,0)
 .W $$WRDHDR()
"RTN","PSBOPE",62,0)
 .I '$O(^TMP("PSB",$J,0)) W !,"No PRN Medications Found" Q
"RTN","PSBOPE",63,0)
 .S PSBSORT=$P(PSBRPT(.1),U,5)
"RTN","PSBOPE",64,0)
 .F DFN=0:0 S DFN=$O(^TMP("PSB",$J,DFN)) Q:'DFN  D
"RTN","PSBOPE",65,0)
 ..S PSBINDX=$S(PSBSORT="P":$P(^DPT(DFN,0),U),1:$G(^DPT(DFN,.1))_" "_$G(^DPT(DFN,.101)))  ;PSB*3*23
"RTN","PSBOPE",66,0)
 ..S:PSBINDX="" PSBINDX=$P(^DPT(DFN,0),U)
"RTN","PSBOPE",67,0)
 ..S ^TMP("PSB",$J,"B",PSBINDX,DFN)=""
"RTN","PSBOPE",68,0)
 .S PSBINDX=""
"RTN","PSBOPE",69,0)
 .F  S PSBINDX=$O(^TMP("PSB",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOPE",70,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSB",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOPE",71,0)
 ...W ! ; Line Break Between Pt's
"RTN","PSBOPE",72,0)
 ...W:$P(PSBRPT(.1),U,5)="P" !,$$GET1^DIQ(2,DFN_",",.01),?32,$$GET1^DIQ(2,DFN_",",.1),"  ",$$GET1^DIQ(2,DFN_",",.101)
"RTN","PSBOPE",73,0)
 ...W:$P(PSBRPT(.1),U,5)="B" !,$$GET1^DIQ(2,DFN_",",.1),"  ",$$GET1^DIQ(2,DFN_",",.101),?20,$$GET1^DIQ(2,DFN_",",.01)
"RTN","PSBOPE",74,0)
 ...W !  ; Line Break Between Admin Times
"RTN","PSBOPE",75,0)
 ...S PSBIEN=""
"RTN","PSBOPE",76,0)
 ...F  S PSBIEN=$O(^TMP("PSB",$J,DFN,PSBIEN)) Q:PSBIEN=""  D
"RTN","PSBOPE",77,0)
 ....I $Y>(IOSL-5) W $$WRDHDR()
"RTN","PSBOPE",78,0)
 ....W !?5,$$GET1^DIQ(53.79,PSBIEN_",",.06),?35,$$GET1^DIQ(53.79,PSBIEN_",",.08),?68,$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY")      ;*70
"RTN","PSBOPE",79,0)
 ....W ?102,$$GET1^DIQ(53.79,PSBIEN_",","PATIENT LOCATION")   ;*70
"RTN","PSBOPE",80,0)
 ....W !?10,"PRN Reason: ",$$GET1^DIQ(53.79,PSBIEN_",",.21)
"RTN","PSBOPE",81,0)
 Q
"RTN","PSBOPE",82,0)
 ;
"RTN","PSBOPE",83,0)
WRDHDR() ; Ward Header
"RTN","PSBOPE",84,0)
 N PSBSRCHL ;Add PSBSRCHL variable and additional PSBHDR array spacers for PSBOHDR call, PSB*3*78
"RTN","PSBOPE",85,0)
  S PSBSRCHL=$$SRCHLIST^PSBOHDR()
"RTN","PSBOPE",86,0)
 S PSBHDR(2)="",PSBHDR(3)="",PSBHDR(4)="Ward Location: "
"RTN","PSBOPE",87,0)
 N PSBCLINORD S PSBCLINORD=2               ;2 = both order types   *70
"RTN","PSBOPE",88,0)
 D WARD^PSBOHDR(PSBWRD,.PSBHDR,,,PSBSRCHL)
"RTN","PSBOPE",89,0)
 W:$P(PSBRPT(.1),U,5)="B" !,"Ward Rm-Bed",?20,"Patient"
"RTN","PSBOPE",90,0)
 W:$P(PSBRPT(.1),U,5)="P" !,"Patient",?32,"Ward Rm-Bed"
"RTN","PSBOPE",91,0)
 ;adjust name of headings and colums to make room for Location    ;*70
"RTN","PSBOPE",92,0)
 W !?5,"Admin Date/Time",?35,"Medication",?68,"Administered By"   ;*70
"RTN","PSBOPE",93,0)
 W ?102,"Location"                                                ;*70
"RTN","PSBOPE",94,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOPE",95,0)
 Q ""
"RTN","PSBOPE",96,0)
 ;
"RTN","PSBOPE",97,0)
PTHDR() ; Patient Header
"RTN","PSBOPE",98,0)
 N PSBCLINORD S PSBCLINORD=2               ;2 = both order types   *70
"RTN","PSBOPE",99,0)
 D PT^PSBOHDR(DFN,.PSBHDR)
"RTN","PSBOPE",100,0)
 W !,"Admin Date/Time",?30,"Medication",?64,"Administered By"
"RTN","PSBOPE",101,0)
 W ?102,"Location"
"RTN","PSBOPE",102,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOPE",103,0)
 Q ""
"RTN","PSBOPE",104,0)
 ;
"RTN","PSBVDLTB")
0^1^B34445687^B33639693
"RTN","PSBVDLTB",1,0)
PSBVDLTB ;BIRMINGHAM/EFC-BCMA VIRTUAL DUE LIST FUNCTIONS (CONT) ;3/19/13 19:13pm
"RTN","PSBVDLTB",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,4,16,68,70,78**;Mar 2004;Build 8
"RTN","PSBVDLTB",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBVDLTB",4,0)
 ;
"RTN","PSBVDLTB",5,0)
 ; Reference/IA
"RTN","PSBVDLTB",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLTB",7,0)
 ; IN5^VADPT/10061
"RTN","PSBVDLTB",8,0)
 ; DEM^VADPT/10061
"RTN","PSBVDLTB",9,0)
 ; INP^VADPT/10061
"RTN","PSBVDLTB",10,0)
 ; $$FMADD^XLFDT/10103
"RTN","PSBVDLTB",11,0)
 ; $$GET^XPAR/2263
"RTN","PSBVDLTB",12,0)
 ; 
"RTN","PSBVDLTB",13,0)
 ;*68 - add new parameter to use new SI/OPI word processing fields
"RTN","PSBVDLTB",14,0)
 ;*70 - add Clinic order request IN param flag (true/false 0/1).
"RTN","PSBVDLTB",15,0)
 ;      also add to return array(1) 6th, 7th piece = IM & CO ord count
"RTN","PSBVDLTB",16,0)
 ;      also add to return array order line 32 piece, Clinic name for 
"RTN","PSBVDLTB",17,0)
 ;      CO orders.
"RTN","PSBVDLTB",18,0)
 ;
"RTN","PSBVDLTB",19,0)
 ; ** Warning: PSBSIOPI & PSBCLINORD will be used as global variables
"RTN","PSBVDLTB",20,0)
 ;             for all down stream calls from this RPC tag.
"RTN","PSBVDLTB",21,0)
 ;
"RTN","PSBVDLTB",22,0)
RPC(RESULTS,DFN,PSBTAB,PSBDT,PSBSIOPI,PSBCLINORD,PSBSRCHDIR) ;
"RTN","PSBVDLTB",23,0)
 N PSBCNT,PSBORDCNT,PSBPATCH,PSBINFUS,PSBIVSTP,PSBA               ;*70
"RTN","PSBVDLTB",24,0)
 K RESULTS,^TMP("PSB",$J),^TMP("PSJ",$J)
"RTN","PSBVDLTB",25,0)
 S PSBSIOPI=+$G(PSBSIOPI)   ;*68 init to 0 if not present or 1 if sent
"RTN","PSBVDLTB",26,0)
 S PSBCLINORD=+$G(PSBCLINORD)                   ;*70 set to 0 if NULL
"RTN","PSBVDLTB",27,0)
 S PSBSRCHDIR=$$UP^XLFSTR($G(PSBSRCHDIR))       ;*70 set to NULL/upper
"RTN","PSBVDLTB",28,0)
 S PSBTRFL=0
"RTN","PSBVDLTB",29,0)
 S RESULTS=$NAME(^TMP("PSB",$J,PSBTAB))
"RTN","PSBVDLTB",30,0)
 ;
"RTN","PSBVDLTB",31,0)
 Q:$$DECEASED(DFN)
"RTN","PSBVDLTB",32,0)
 ;
"RTN","PSBVDLTB",33,0)
 ;Set date & time window varaibles
"RTN","PSBVDLTB",34,0)
 ;
"RTN","PSBVDLTB",35,0)
 S PSBNOW=+$G(PSBDT)
"RTN","PSBVDLTB",36,0)
 I 'PSBNOW D NOW^%DTC S PSBNOW=+$E(%,1,10)
"RTN","PSBVDLTB",37,0)
 S PSBDT=$P(PSBNOW,".",1)
"RTN","PSBVDLTB",38,0)
 ;
"RTN","PSBVDLTB",39,0)
 ;check if fast search requested and valid direction passed, then
"RTN","PSBVDLTB",40,0)
 ; get the next date tha order data exists and Not Given
"RTN","PSBVDLTB",41,0)
 I PSBCLINORD,(PSBSRCHDIR="B")!(PSBSRCHDIR="F") D
"RTN","PSBVDLTB",42,0)
 . N PSBSRCHDT,SRCHDIR
"RTN","PSBVDLTB",43,0)
 . S SRCHDIR=$S(PSBSRCHDIR="B":-1,1:1)
"RTN","PSBVDLTB",44,0)
 . S PSBSRCHDT=$$FINDORD^PSBVDLU1(SRCHDIR,DFN,PSBDT,PSBTAB)
"RTN","PSBVDLTB",45,0)
 . S:PSBSRCHDT'=-1 (PSBNOW,PSBDT)=PSBSRCHDT
"RTN","PSBVDLTB",46,0)
 ;
"RTN","PSBVDLTB",47,0)
 ;*70 - if CO, set window of time to the entire day
"RTN","PSBVDLTB",48,0)
 I PSBCLINORD D
"RTN","PSBVDLTB",49,0)
 .S PSBWBEG=$P(PSBDT,".")_".0000"
"RTN","PSBVDLTB",50,0)
 .S PSBWEND=$P(PSBDT,".")_".2400"
"RTN","PSBVDLTB",51,0)
 E  D
"RTN","PSBVDLTB",52,0)
 .S PSBWBEG=$$FMADD^XLFDT(PSBNOW,"",-12)
"RTN","PSBVDLTB",53,0)
 .S PSBWEND=$$FMADD^XLFDT(PSBNOW,"",12)
"RTN","PSBVDLTB",54,0)
 ;
"RTN","PSBVDLTB",55,0)
 ;Create variable for valid order start date/time against admin window
"RTN","PSBVDLTB",56,0)
 S PSBWADM=$$GET^XPAR("DIV","PSB ADMIN BEFORE")
"RTN","PSBVDLTB",57,0)
 S:PSBCLINORD PSBWADM=99999
"RTN","PSBVDLTB",58,0)
 D NOW^%DTC S PSBWADM=$$FMADD^XLFDT(%,"","",+PSBWADM) ; correction for start date issue, PSB*3*78
"RTN","PSBVDLTB",59,0)
 ;
"RTN","PSBVDLTB",60,0)
 ;Use last movement for API
"RTN","PSBVDLTB",61,0)
 S VAIP("D")="LAST" D IN5^VADPT S PSBTRDT=+VAIP(3),PSBTRTYP=$P(VAIP(2),U,2),PSBMVTYP=$P(VAIP(4),U,2) K VAIP
"RTN","PSBVDLTB",62,0)
 ;
"RTN","PSBVDLTB",63,0)
 ;Get patient transfer notification timeframe to determine pop-up box
"RTN","PSBVDLTB",64,0)
 S PSBPTTR=$$GET^XPAR("DIV","PSB PATIENT TRANSFER") I PSBPTTR="" S PSBPTTR=72
"RTN","PSBVDLTB",65,0)
 D NOW^%DTC S PSBNTDT=$$FMADD^XLFDT(%,"",-PSBPTTR) I PSBNTDT'>PSBTRDT S PSBTRFL=1
"RTN","PSBVDLTB",66,0)
 ;
"RTN","PSBVDLTB",67,0)
 ;Passing PSBDT as 3rd parameter turns off the V.1.0 One-Time lookback
"RTN","PSBVDLTB",68,0)
 ;*70 check if IM or CO orders exists for mode lights
"RTN","PSBVDLTB",69,0)
 S PSBORDCNT=$$MODELITE^PSBVDLU1                ;mode lights
"RTN","PSBVDLTB",70,0)
 S PSBPATCH=$$PATCHON^PSBVDLU1(DFN,.PSBA)       ;patch on light
"RTN","PSBVDLTB",71,0)
 S:PSBA("I") $P(PSBORDCNT,U)=1 S:PSBA("C") $P(PSBORDCNT,U,2)=1
"RTN","PSBVDLTB",72,0)
 S PSBIVSTP=$$STOPPED^PSBVDLU1(DFN,.PSBA)       ;IV stopped light
"RTN","PSBVDLTB",73,0)
 S:PSBA("I") $P(PSBORDCNT,U)=1 S:PSBA("C") $P(PSBORDCNT,U,2)=1
"RTN","PSBVDLTB",74,0)
 S PSBINFUS=$$INFUSING^PSBVDLU1(DFN,.PSBA)      ;IV infusing light
"RTN","PSBVDLTB",75,0)
 S:PSBA("I") $P(PSBORDCNT,U)=1 S:PSBA("C") $P(PSBORDCNT,U,2)=1
"RTN","PSBVDLTB",76,0)
 ;
"RTN","PSBVDLTB",77,0)
 ; Setup the ^TMP("PSJ",$J global for use below 
"RTN","PSBVDLTB",78,0)
 K ^TMP("PSJ",$J)
"RTN","PSBVDLTB",79,0)
 D EN^PSJBCMA(DFN,PSBNOW,PSBDT)
"RTN","PSBVDLTB",80,0)
 D:PSBCLINORD INCLUDCO^PSBVDLU1
"RTN","PSBVDLTB",81,0)
 D:'PSBCLINORD REMOVECO^PSBVDLU1
"RTN","PSBVDLTB",82,0)
 ;
"RTN","PSBVDLTB",83,0)
 ;initialize tabs
"RTN","PSBVDLTB",84,0)
 D TABINIT
"RTN","PSBVDLTB",85,0)
 ;
"RTN","PSBVDLTB",86,0)
 ;The following calls must be made in the order below since the ^TMP global is reused
"RTN","PSBVDLTB",87,0)
 D EN^PSBVDLUD(DFN,PSBDT)
"RTN","PSBVDLTB",88,0)
 D EN^PSBVDLPB(DFN,PSBDT)
"RTN","PSBVDLTB",89,0)
 D EN^PSBVDLIV(DFN,PSBDT)
"RTN","PSBVDLTB",90,0)
 ; adding a special check for lighting the Unit Dose Tab light.
"RTN","PSBVDLTB",91,0)
 ; Patches sent to GUI via this API will send both IM and CO patches
"RTN","PSBVDLTB",92,0)
 ; that are expired/dc'd and are still on the patient. So there is a
"RTN","PSBVDLTB",93,0)
 ; a scenario when a unit dose patch can be on TMP global and it is
"RTN","PSBVDLTB",94,0)
 ; the only order in TMP but was for a different mode than currently
"RTN","PSBVDLTB",95,0)
 ; viewing.  In this case CNT will = 0 and use it to turn on the light
"RTN","PSBVDLTB",96,0)
 N CNT,QQ,NODE S CNT=0
"RTN","PSBVDLTB",97,0)
 I $D(^TMP("PSB",$J,"UDTAB",2))>0 D           ;unit dose tab check *70
"RTN","PSBVDLTB",98,0)
 . F QQ=2:1  Q:'$D(^TMP("PSB",$J,"UDTAB",QQ))  D  Q:CNT
"RTN","PSBVDLTB",99,0)
 .. S NODE=^TMP("PSB",$J,"UDTAB",QQ)
"RTN","PSBVDLTB",100,0)
 .. I $L(NODE,U)>27,$P(NODE,U,2)?.N1A D
"RTN","PSBVDLTB",101,0)
 ... ;  first order found Activ per correct mode, then quit with cnt=1
"RTN","PSBVDLTB",102,0)
 ... I PSBCLINORD,$P(NODE,U,33),$P(NODE,U,22)="A" S CNT=1 Q
"RTN","PSBVDLTB",103,0)
 ... I 'PSBCLINORD,'$P(NODE,U,33),$P(NODE,U,22)="A" S CNT=1 Q
"RTN","PSBVDLTB",104,0)
 ... Q:'$P(NODE,U,28)  ;not a given patch
"RTN","PSBVDLTB",105,0)
 ... I PSBCLINORD,$P($P(NODE,U,26),".")'>DT,'$P(NODE,U,33) Q
"RTN","PSBVDLTB",106,0)
 ... I 'PSBCLINORD,$P($P(NODE,U,26),".")'>DT,$P(NODE,U,33) Q
"RTN","PSBVDLTB",107,0)
 ... S CNT=1
"RTN","PSBVDLTB",108,0)
 S $P(PSBATAB,U,1)=$S(CNT:1,1:0)            ;*70 use CNT for UD light
"RTN","PSBVDLTB",109,0)
 S $P(PSBATAB,U,2)=$S($D(^TMP("PSB",$J,"PBTAB",2))>0:1,1:0)
"RTN","PSBVDLTB",110,0)
 S $P(PSBATAB,U,3)=$S($D(^TMP("PSB",$J,"IVTAB",2))>0:1,1:0)
"RTN","PSBVDLTB",111,0)
 S:PSBTAB="UDTAB" PSBCNT=$O(^TMP("PSB",$J,"UDTAB",""),-1)
"RTN","PSBVDLTB",112,0)
 S:PSBTAB="IVTAB" PSBCNT=$O(^TMP("PSB",$J,"IVTAB",""),-1)
"RTN","PSBVDLTB",113,0)
 S:PSBTAB="PBTAB" PSBCNT=$O(^TMP("PSB",$J,"PBTAB",""),-1)
"RTN","PSBVDLTB",114,0)
 ;
"RTN","PSBVDLTB",115,0)
 I PSBTAB="NO TAB" D
"RTN","PSBVDLTB",116,0)
 .S ^TMP("PSB",$J,PSBTAB,0)=1
"RTN","PSBVDLTB",117,0)
 .S ^TMP("PSB",$J,PSBTAB,1)=PSBATAB
"RTN","PSBVDLTB",118,0)
 .S $P(^TMP("PSB",$J,PSBTAB,1),U,5,6)=PSBORDCNT  ;*70 Cvsht offset cnt
"RTN","PSBVDLTB",119,0)
 .S $P(^TMP("PSB",$J,PSBTAB,1),U,7)=PSBINFUS     ;*70 IV infuse light
"RTN","PSBVDLTB",120,0)
 .S $P(^TMP("PSB",$J,PSBTAB,1),U,8)=PSBIVSTP     ;*70 IV stop light
"RTN","PSBVDLTB",121,0)
 .S $P(^TMP("PSB",$J,PSBTAB,1),U,9)=PSBPATCH     ;*70 patch light
"RTN","PSBVDLTB",122,0)
 E  D
"RTN","PSBVDLTB",123,0)
 .I $G(PSBCNT)>0 S ^TMP("PSB",$J,PSBTAB,0)=PSBCNT
"RTN","PSBVDLTB",124,0)
 .I $G(PSBCNT)>1 S ^TMP("PSB",$J,PSBTAB,1)=PSBATAB_U_$S(PSBTRFL:PSBTRTYP_U_PSBMVTYP,1:"")
"RTN","PSBVDLTB",125,0)
 .I $G(PSBCNT)'>1 S ^TMP("PSB",$J,PSBTAB,1)=PSBATAB
"RTN","PSBVDLTB",126,0)
 .S $P(^TMP("PSB",$J,PSBTAB,1),U,6,7)=PSBORDCNT   ;*70 Tabs Ord cnt
"RTN","PSBVDLTB",127,0)
 .S $P(^TMP("PSB",$J,PSBTAB,1),U,8)=PSBINFUS      ;*70 IV infuse light
"RTN","PSBVDLTB",128,0)
 .S $P(^TMP("PSB",$J,PSBTAB,1),U,9)=PSBIVSTP      ;*70 IV stop light
"RTN","PSBVDLTB",129,0)
 .S $P(^TMP("PSB",$J,PSBTAB,1),U,10)=PSBPATCH     ;*70 patch light
"RTN","PSBVDLTB",130,0)
 ;
"RTN","PSBVDLTB",131,0)
 F X="UDTAB","PBTAB","IVTAB" I X'=PSBTAB K ^TMP("PSB",$J,X)
"RTN","PSBVDLTB",132,0)
 D CLEAN^PSBVT K ^TMP("PSJ",$J),PSBATAB,PSBWADM,PSBWBEG,PSBWEND,PSBNOW,PSBTRDT,PSBPTTR,PSBTRFL,PSBNTDT,PSBTRTYP,PSBMVTYP
"RTN","PSBVDLTB",133,0)
 Q
"RTN","PSBVDLTB",134,0)
 ;
"RTN","PSBVDLTB",135,0)
TABINIT ;
"RTN","PSBVDLTB",136,0)
 F PSBX="UDTAB","PBTAB","IVTAB" D
"RTN","PSBVDLTB",137,0)
 .K ^TMP("PSB",$J,PSBX)
"RTN","PSBVDLTB",138,0)
 .S ^TMP("PSB",$J,PSBX,0)=1
"RTN","PSBVDLTB",139,0)
 .S ^TMP("PSB",$J,PSBX,1)="-1^No Administration(s) due at this time." Q
"RTN","PSBVDLTB",140,0)
 ;
"RTN","PSBVDLTB",141,0)
DECEASED(DFN) ; Patient Deceased?
"RTN","PSBVDLTB",142,0)
 ;
"RTN","PSBVDLTB",143,0)
 S DECEASED=0
"RTN","PSBVDLTB",144,0)
 D DEM^VADPT I VADM(6)]"" S DECEASED=1 K VADM D  Q DECEASED
"RTN","PSBVDLTB",145,0)
 .F PSBX="UDTAB","PBTAB","IVTAB","NO TAB" D
"RTN","PSBVDLTB",146,0)
 ..K ^TMP("PSB",$J,PSBX)
"RTN","PSBVDLTB",147,0)
 ..S ^TMP("PSB",$J,PSBX,0)=1,^TMP("PSB",$J,PSBX,1)="0^0^0^-1^A ""DATE OF DEATH"" has been logged for this patient."
"RTN","PSBVDLTB",148,0)
 Q DECEASED
"VER")
8.0^22.0
**END**
**END**


Released PRS*4*116 SEQ #104
Extracted from mail message
**KIDS**:PRS*4.0*116^

**INSTALL NAME**
PRS*4.0*116
"BLD",7484,0)
PRS*4.0*116^PAID^0^3080411^y
"BLD",7484,4,0)
^9.64PA^^
"BLD",7484,6)
7^
"BLD",7484,6.3)
23
"BLD",7484,"ABPKG")
n
"BLD",7484,"KRN",0)
^9.67PA^8989.52^19
"BLD",7484,"KRN",.4,0)
.4
"BLD",7484,"KRN",.401,0)
.401
"BLD",7484,"KRN",.402,0)
.402
"BLD",7484,"KRN",.403,0)
.403
"BLD",7484,"KRN",.5,0)
.5
"BLD",7484,"KRN",.84,0)
.84
"BLD",7484,"KRN",3.6,0)
3.6
"BLD",7484,"KRN",3.8,0)
3.8
"BLD",7484,"KRN",9.2,0)
9.2
"BLD",7484,"KRN",9.8,0)
9.8
"BLD",7484,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",7484,"KRN",9.8,"NM",1,0)
PRSATPE^^0^B68842972
"BLD",7484,"KRN",9.8,"NM",2,0)
PRSAPPH^^0^B20434653
"BLD",7484,"KRN",9.8,"NM",3,0)
PRSDSERV^^0^B45205157
"BLD",7484,"KRN",9.8,"NM",4,0)
PRSASR1^^0^B49700773
"BLD",7484,"KRN",9.8,"NM",5,0)
PRSAUDP^^0^B9116588
"BLD",7484,"KRN",9.8,"NM",6,0)
PRSARC07^^0^B48614564
"BLD",7484,"KRN",9.8,"NM",7,0)
PRSA8BNH^^0^B56986678
"BLD",7484,"KRN",9.8,"NM",8,0)
PRS8MT^^0^B44975495
"BLD",7484,"KRN",9.8,"NM",9,0)
PRS8SU^^0^B22986620
"BLD",7484,"KRN",9.8,"NM",10,0)
PRSA8BNI^^0^B27323554
"BLD",7484,"KRN",9.8,"NM","B","PRS8MT",8)

"BLD",7484,"KRN",9.8,"NM","B","PRS8SU",9)

"BLD",7484,"KRN",9.8,"NM","B","PRSA8BNH",7)

"BLD",7484,"KRN",9.8,"NM","B","PRSA8BNI",10)

"BLD",7484,"KRN",9.8,"NM","B","PRSAPPH",2)

"BLD",7484,"KRN",9.8,"NM","B","PRSARC07",6)

"BLD",7484,"KRN",9.8,"NM","B","PRSASR1",4)

"BLD",7484,"KRN",9.8,"NM","B","PRSATPE",1)

"BLD",7484,"KRN",9.8,"NM","B","PRSAUDP",5)

"BLD",7484,"KRN",9.8,"NM","B","PRSDSERV",3)

"BLD",7484,"KRN",19,0)
19
"BLD",7484,"KRN",19,"NM",0)
^9.68A^6^6
"BLD",7484,"KRN",19,"NM",1,0)
PRSRSU-PAID SYSTEM REPORTS^^2
"BLD",7484,"KRN",19,"NM",2,0)
PRSRFI-PAID SYSTEM REPORTS^^2
"BLD",7484,"KRN",19,"NM",3,0)
PRSA FIND 8B-TOUR MISMATCH-FIS^^0
"BLD",7484,"KRN",19,"NM",4,0)
PRSA FIND 8B-TOUR MISMATCH-SUP^^0
"BLD",7484,"KRN",19,"NM",5,0)
PRSA FIND 8B-TOUR MISMATCH-TK^^0
"BLD",7484,"KRN",19,"NM",6,0)
PRSA TK MEN-EMP^^2
"BLD",7484,"KRN",19,"NM","B","PRSA FIND 8B-TOUR MISMATCH-FIS",3)

"BLD",7484,"KRN",19,"NM","B","PRSA FIND 8B-TOUR MISMATCH-SUP",4)

"BLD",7484,"KRN",19,"NM","B","PRSA FIND 8B-TOUR MISMATCH-TK",5)

"BLD",7484,"KRN",19,"NM","B","PRSA TK MEN-EMP",6)

"BLD",7484,"KRN",19,"NM","B","PRSRFI-PAID SYSTEM REPORTS",2)

"BLD",7484,"KRN",19,"NM","B","PRSRSU-PAID SYSTEM REPORTS",1)

"BLD",7484,"KRN",19.1,0)
19.1
"BLD",7484,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",7484,"KRN",101,0)
101
"BLD",7484,"KRN",409.61,0)
409.61
"BLD",7484,"KRN",771,0)
771
"BLD",7484,"KRN",870,0)
870
"BLD",7484,"KRN",8989.51,0)
8989.51
"BLD",7484,"KRN",8989.52,0)
8989.52
"BLD",7484,"KRN",8994,0)
8994
"BLD",7484,"KRN","B",.4,.4)

"BLD",7484,"KRN","B",.401,.401)

"BLD",7484,"KRN","B",.402,.402)

"BLD",7484,"KRN","B",.403,.403)

"BLD",7484,"KRN","B",.5,.5)

"BLD",7484,"KRN","B",.84,.84)

"BLD",7484,"KRN","B",3.6,3.6)

"BLD",7484,"KRN","B",3.8,3.8)

"BLD",7484,"KRN","B",9.2,9.2)

"BLD",7484,"KRN","B",9.8,9.8)

"BLD",7484,"KRN","B",19,19)

"BLD",7484,"KRN","B",19.1,19.1)

"BLD",7484,"KRN","B",101,101)

"BLD",7484,"KRN","B",409.61,409.61)

"BLD",7484,"KRN","B",771,771)

"BLD",7484,"KRN","B",870,870)

"BLD",7484,"KRN","B",8989.51,8989.51)

"BLD",7484,"KRN","B",8989.52,8989.52)

"BLD",7484,"KRN","B",8994,8994)

"BLD",7484,"QUES",0)
^9.62^^
"BLD",7484,"REQB",0)
^9.611^2^2
"BLD",7484,"REQB",1,0)
PRS*4.0*93^2
"BLD",7484,"REQB",2,0)
PRS*4.0*112^2
"BLD",7484,"REQB","B","PRS*4.0*112",2)

"BLD",7484,"REQB","B","PRS*4.0*93",1)

"KRN",19,5908,-1)
2^6
"KRN",19,5908,0)
PRSA TK MEN-EMP^Employee Data^^M^100831^^^^^^^
"KRN",19,5908,10,0)
^19.01IP^14^14
"KRN",19,5908,10,14,0)
13153^9
"KRN",19,5908,10,14,"^")
PRSA FIND 8B-TOUR MISMATCH-TK
"KRN",19,5908,"U")
EMPLOYEE DATA
"KRN",19,5990,-1)
2^1
"KRN",19,5990,0)
PRSRSU-PAID SYSTEM REPORTS^Employee Reports^^M^100831^^^^^^^408
"KRN",19,5990,10,0)
^19.01IP^7^7
"KRN",19,5990,10,7,0)
13123^7
"KRN",19,5990,10,7,"^")
PRSA FIND 8B-TOUR MISMATCH-SUP
"KRN",19,5990,"U")
EMPLOYEE REPORTS
"KRN",19,6004,-1)
2^2
"KRN",19,6004,0)
PRSRFI-PAID SYSTEM REPORTS^Employee Reports^^M^100831^^^^^^^408
"KRN",19,6004,10,0)
^19.01IP^7^7
"KRN",19,6004,10,7,0)
13130^7
"KRN",19,6004,10,7,"^")
PRSA FIND 8B-TOUR MISMATCH-FIS
"KRN",19,6004,"U")
EMPLOYEE REPORTS
"KRN",19,13123,-1)
0^4
"KRN",19,13123,0)
PRSA FIND 8B-TOUR MISMATCH-SUP^Find Mismatched Normal and Tour Hours^^R^^^^^^^y^
"KRN",19,13123,1,0)
^19.06^12^12^3080312^^^
"KRN",19,13123,1,1,0)
This option searches a pay period for employees with scheduled tour hours
"KRN",19,13123,1,2,0)
that don't match the employee's 8B Normal Hours.  In some cases hours that
"KRN",19,13123,1,3,0)
carry over from a two day tour on the last Saturday of the pay period 
"KRN",19,13123,1,4,0)
prior to the one being searched can be the source of the mismatch.  
"KRN",19,13123,1,5,0)
Timecards for employees on this report cannot be certified until all
"KRN",19,13123,1,6,0)
scheduled hours from midnight Saturday through midnight Saturday match the
"KRN",19,13123,1,7,0)
8B Normal Hours.  Either the tour or 8B Normal Hours should be updated
"KRN",19,13123,1,8,0)
through established processes for any employee appearing on this report 
"KRN",19,13123,1,9,0)
for an uncertified pay period.  Optionally, Tours of Duty and Tour Hours 
"KRN",19,13123,1,10,0)
can be displayed.  The Tour Hours column contains a total of any tour 
"KRN",19,13123,1,11,0)
hours that fall on that day.  So, two day tours will contribute hours to 
"KRN",19,13123,1,12,0)
both days on which they fall.
"KRN",19,13123,10.1)
Find Norm/Tour Mismatch
"KRN",19,13123,25)
SUPERV^PRSA8BNH
"KRN",19,13123,"U")
FIND MISMATCHED NORMAL AND TOU
"KRN",19,13130,-1)
0^3
"KRN",19,13130,0)
PRSA FIND 8B-TOUR MISMATCH-FIS^Find Mismatched Normal and Tour Hours^^R^^^^^^^^
"KRN",19,13130,1,0)
^^12^12^3080305^
"KRN",19,13130,1,1,0)
This option searches a pay period for employees with scheduled tour hours
"KRN",19,13130,1,2,0)
that don't match the employee's 8B Normal Hours.  In some cases hours that
"KRN",19,13130,1,3,0)
carry over from a two day tour on the last Saturday of the pay period 
"KRN",19,13130,1,4,0)
prior to the one being searched can be the source of the mismatch.  
"KRN",19,13130,1,5,0)
Timecards for employees on this report cannot be certified until all
"KRN",19,13130,1,6,0)
scheduled hours from midnight Saturday through midnight Saturday match the
"KRN",19,13130,1,7,0)
8B Normal Hours.  Either the tour or 8B Normal Hours should be updated
"KRN",19,13130,1,8,0)
through established processes for any employee appearing on this report 
"KRN",19,13130,1,9,0)
for an uncertified pay period.  Optionally, Tours of Duty and Tour Hours
"KRN",19,13130,1,10,0)
can be displayed.  The Tour Hours column contains a total of any tour 
"KRN",19,13130,1,11,0)
hours that fall on that day.  So, two day tours will contribute hours to 
"KRN",19,13130,1,12,0)
both days on which they fall.
"KRN",19,13130,25)
PAYROLL^PRSA8BNH
"KRN",19,13130,"U")
FIND MISMATCHED NORMAL AND TOU
"KRN",19,13153,-1)
0^5
"KRN",19,13153,0)
PRSA FIND 8B-TOUR MISMATCH-TK^Find Mismatched Normal and Tour Hours^^R^^^^^^^^
"KRN",19,13153,1,0)
^^12^12^3080312^
"KRN",19,13153,1,1,0)
This option searches a pay period for employees with scheduled tour hours
"KRN",19,13153,1,2,0)
that don't match the employee's 8B Normal Hours.  In some cases hours that
"KRN",19,13153,1,3,0)
carry over from a two day tour on the last Saturday of the pay period 
"KRN",19,13153,1,4,0)
prior to the one being searched can be the source of the mismatch.  
"KRN",19,13153,1,5,0)
Timecards for employees on this report cannot be certified until all
"KRN",19,13153,1,6,0)
scheduled hours from midnight Saturday through midnight Saturday match the
"KRN",19,13153,1,7,0)
8B Normal Hours.  Either the tour or 8B Normal Hours should be updated
"KRN",19,13153,1,8,0)
through established processes for any employee appearing on this report 
"KRN",19,13153,1,9,0)
for an uncertified pay period.  Optionally, Tours of Duty and Tour Hours 
"KRN",19,13153,1,10,0)
can be displayed.  The Tour Hours column contains a total of any tour 
"KRN",19,13153,1,11,0)
hours that fall on that day.  So, two day tours will contribute hours to 
"KRN",19,13153,1,12,0)
both days on which they fall.
"KRN",19,13153,10.1)
Find Norm/Tour Mismatch
"KRN",19,13153,25)
TIMEKEEP^PRSA8BNH
"KRN",19,13153,"U")
FIND MISMATCHED NORMAL AND TOU
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",408,-1)
1^1
"PKG",408,0)
PAID^PRS^PAID
"PKG",408,20,0)
^9.402P^^
"PKG",408,22,0)
^9.49I^1^1
"PKG",408,22,1,0)
4.0^2950912^2960130
"PKG",408,22,1,"PAH",1,0)
116^3080411^13198
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","PRS8MT")
0^8^B44975495^B45103174
"RTN","PRS8MT",1,0)
PRS8MT ;HISC/MRL-DECOMPOSITION, MEALTIME ;02/21/08
"RTN","PRS8MT",2,0)
 ;;4.0;PAID;**2,40,69,102,109,112,116**;Sep 21, 1995;Build 23
"RTN","PRS8MT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRS8MT",4,0)
 ;
"RTN","PRS8MT",5,0)
 ;This routine is used to determine placement of mealtime where
"RTN","PRS8MT",6,0)
 ;necessary.
"RTN","PRS8MT",7,0)
 ;
"RTN","PRS8MT",8,0)
 ;Called by Routines:  PRS8ST
"RTN","PRS8MT",9,0)
 ;
"RTN","PRS8MT",10,0)
MULT ; --- checking 1 node
"RTN","PRS8MT",11,0)
 I $$HOLIDAY^PRS8UT(PY,DFN,MDY),$G(^PRST(458,PY,"E",DFN,"D",MDY,2))["MID^MID^ON" Q  ;don't add meal if mid-mid on-call on a holiday, quit routine
"RTN","PRS8MT",12,0)
 S TWO=DAY(MDY,"TWO")
"RTN","PRS8MT",13,0)
 S S=1 D SET D:'Q  I TWO S S=2 D SET D:'Q
"RTN","PRS8MT",14,0)
 .S D1="",$P(D1,"0",193)="",V(1)=97,V(2)=0
"RTN","PRS8MT",15,0)
 .F I=1:3:28 S V=$P(N,"^",I,I+2) Q:$P(V,"^",1)=""  D
"RTN","PRS8MT",16,0)
 ..S X=$P(V,"^",3) I "^^6^7^3^8^"'[("^"_X_"^") Q  ;quit if not NH
"RTN","PRS8MT",17,0)
 ..F M=$P(V,"^"):1:$P(V,"^",2) D  ; build up tour
"RTN","PRS8MT",18,0)
 ...S D1=$E(D1,1,M-1)_$S(X=""!(X=3):1,X=6:2,1:3)_$E(D1,M+1,192)
"RTN","PRS8MT",19,0)
 ...I V(1)>M S V(1)=M
"RTN","PRS8MT",20,0)
 ...I V(2)<M S V(2)=M
"RTN","PRS8MT",21,0)
 ..Q
"RTN","PRS8MT",22,0)
 .D:V(2) GETY
"RTN","PRS8MT",23,0)
 .F I="N","W" F J=MDY,MDY+1 S X=$G(DAY(J,I)) D
"RTN","PRS8MT",24,0)
 ..I X'="" S ^TMP($J,"PRS8",J,I)=X
"RTN","PRS8MT",25,0)
 ..Q
"RTN","PRS8MT",26,0)
 .Q
"RTN","PRS8MT",27,0)
 ;
"RTN","PRS8MT",28,0)
END ; --- all done here
"RTN","PRS8MT",29,0)
 K A,B,C,D,DIF,DIF1,J,L,M,M1,MID,MT,N,PM,T,SPL,SPLX,USE,V(1),V(2),VT,X,X1,X2,Y
"RTN","PRS8MT",30,0)
 Q
"RTN","PRS8MT",31,0)
 ;
"RTN","PRS8MT",32,0)
GETY ; --- this is where Y (placement of mealtime) is defined
"RTN","PRS8MT",33,0)
 S X=$E(D,V(1),V(2)),D1=$E(D1,V(1),V(2))
"RTN","PRS8MT",34,0)
 N ORIGX,RECESS
"RTN","PRS8MT",35,0)
 S ORIGX=X ; Original copy of codes in X and
"RTN","PRS8MT",36,0)
 S RECESS=DAY(MDY,"r")_$G(DAY(MDY,"rN"))
"RTN","PRS8MT",37,0)
 S RECESS=$E(RECESS,V(1),V(2)) ; load any Recess
"RTN","PRS8MT",38,0)
 I X["5" D
"RTN","PRS8MT",39,0)
 . N DAYP
"RTN","PRS8MT",40,0)
 . ; loop thru string X and replace 5s by a leave code if one exists
"RTN","PRS8MT",41,0)
 . S DAYP=$E(DAY(MDY,"P"),V(1),V(2)) ; leave may be hidden here
"RTN","PRS8MT",42,0)
 . F M=1:1:$L(X) D
"RTN","PRS8MT",43,0)
 . . I $E(X,M)=5,$E(DAYP,M)'=0 S $E(X,M)=$E(DAYP,M)
"RTN","PRS8MT",44,0)
 S MID=V(2)-V(1)+1-MT\2,MID=MID+V(1) ;middle of tour
"RTN","PRS8MT",45,0)
 S PM=+$P($G(^PRST(457.1,+$P(DAY(MDY,0),"^",$S(S=1:2,1:13)),0)),"^",7) ;0=non=prem meal/1=prem. meal
"RTN","PRS8MT",46,0)
 S X1=$E(X),Q=1
"RTN","PRS8MT",47,0)
 F M=1:1:$L(X) D  Q:'Q
"RTN","PRS8MT",48,0)
 .S Y=$E(X,M)
"RTN","PRS8MT",49,0)
 .I "1235C"[Y,"1235C"[X1 Q  ; scheduled work time
"RTN","PRS8MT",50,0)
 .I "4OC"[Y,$E(RECESS,M)="r" S Q=0 Q  ; Work performed while on Recess (9mo AWS)
"RTN","PRS8MT",51,0)
 .I Y'="O",Y'=X1 S Q=0 Q  ; not same type of time, and non-OT
"RTN","PRS8MT",52,0)
 .I Y="O",($E(DAY($S(V(1)+M-1<97:MDY,1:MDY+1),"HOL"),$S(V(1)+M-1<97:V(1)+M-1,1:V(1)+M-1-96))'=2) S Q=0 Q  ; OT indicating non-holiday worked gets no meal
"RTN","PRS8MT",53,0)
 .I Y="O",($E(DAY($S(V(1)+M-1<97:MDY,1:MDY+1),"HOL"),$S(V(1)+M-1<97:V(1)+M-1,1:V(1)+M-1-96))=2),"123C"[X1 S Q=0 Q  ; OT indicating holiday worked and Excused.
"RTN","PRS8MT",54,0)
 .Q
"RTN","PRS8MT",55,0)
 I X["0" D
"RTN","PRS8MT",56,0)
 .I RECESS'["r" S SPL=$TR(X,"1235"),SPLX=$TR(X,SPL,$TR($J("",$L(SPL))," "))
"RTN","PRS8MT",57,0)
 .I RECESS["r" S SPL=$TR(X,"01235"),SPLX=$TR(X,SPL,$TR($J("",$L(SPL))," "))
"RTN","PRS8MT",58,0)
 .I SPLX="" S Q=1
"RTN","PRS8MT",59,0)
 ;
"RTN","PRS8MT",60,0)
 K M
"RTN","PRS8MT",61,0)
 ;--- one activity for entire tour
"RTN","PRS8MT",62,0)
 I Q S Q=0 D  F M=1:1:MT S M(M)=Y+M-1
"RTN","PRS8MT",63,0)
 .I V(1)>24,V(2)<73 S Y=MID Q  ;no premium time involved/ meal in middle
"RTN","PRS8MT",64,0)
 .S Q=0 D  ;check for all premium
"RTN","PRS8MT",65,0)
 ..I V(1)<25,V(2)<25 S Q=1 Q  ;all hours before 6am
"RTN","PRS8MT",66,0)
 ..I V(1)>72,V(2)>72,V(2)'>120 S Q=1 Q  ;all hours after 6pm
"RTN","PRS8MT",67,0)
 .I Q S Y=MID Q  ; all time premium time/ meal in middle
"RTN","PRS8MT",68,0)
 .I PM S Y=0 D
"RTN","PRS8MT",69,0)
 ..I V(2)>72 S Y=73-$S(V(2)-73>MT&(V(1)'>73):0,V(1)<25!(V(2)'<121):73,1:MT-(V(2)-73))
"RTN","PRS8MT",70,0)
 ..I 'Y,V(1)<25 S Y=$S(25-V(1)>MT:25-MT,1:V(1))
"RTN","PRS8MT",71,0)
 ..I 'Y S Y=$S(121-V(1)>MT:121-MT,1:V(1))
"RTN","PRS8MT",72,0)
 .E  S Y=0 D
"RTN","PRS8MT",73,0)
 ..I V(2)>72 S Y=$S(73-MT>V(1):73-MT,V(1)<25!(V(2)'<121):0,1:V(1))
"RTN","PRS8MT",74,0)
 ..I 'Y,V(1)<25 S Y=$S(V(2)-MT>24:25,1:V(2)-MT+1)
"RTN","PRS8MT",75,0)
 ..I 'Y S Y=$S(V(2)-MT>120:121,1:V(2)-MT+1)
"RTN","PRS8MT",76,0)
 .I 'Y S Y=MID
"RTN","PRS8MT",77,0)
 .Q
"RTN","PRS8MT",78,0)
 ; --- multiple activities per tour
"RTN","PRS8MT",79,0)
 E  D
"RTN","PRS8MT",80,0)
 .S Z=$TR(X,"1235"),X=$TR(X,Z,$TR($J("",$L(Z))," ","0"))
"RTN","PRS8MT",81,0)
 .;
"RTN","PRS8MT",82,0)
 .; if leave posted > or = to tour length + mt (ie didn't post around 
"RTN","PRS8MT",83,0)
 .; lunch) it was resulting in OT (ZRIK strips HOL, OC, & no tour time)
"RTN","PRS8MT",84,0)
 .;
"RTN","PRS8MT",85,0)
 .S ZRIK=$TR(Z,"HC0")
"RTN","PRS8MT",86,0)
 .I MT>0,$L(ZRIK)'<(($P(DAY(DAY,0),"^",8)*4)+MT) S X="",$P(X,"1",$L(ZRIK)+1)=""
"RTN","PRS8MT",87,0)
 .Q:X?1"0"."0"&(RECESS'["r")
"RTN","PRS8MT",88,0)
 .S M=0 F A=1,2 Q:M=MT  F B=MID,MID+1,MID-1:-1:V(1),MID+2:1:V(2) D  Q:M=MT
"RTN","PRS8MT",89,0)
 ..Q:'$E(X,B-V(1)+1)
"RTN","PRS8MT",90,0)
 ..I A=1,PM,B<25!(B>72&(B<121)) S M=M+1,M(M)=B
"RTN","PRS8MT",91,0)
 ..I A=1,'PM,B>24&(B<73)!(B>120) S M=M+1,M(M)=B
"RTN","PRS8MT",92,0)
 ..I A=2 S M=M+1,M(M)=B
"RTN","PRS8MT",93,0)
 ..Q
"RTN","PRS8MT",94,0)
 .Q
"RTN","PRS8MT",95,0)
 Q:'$O(M(0))
"RTN","PRS8MT",96,0)
Y ; --- this is where meals get placed in string
"RTN","PRS8MT",97,0)
 F Y=0:0 S Y=$O(M(Y)) Q:Y'>0  D
"RTN","PRS8MT",98,0)
 . N ORIGAC ; original activity code
"RTN","PRS8MT",99,0)
 . S M=M(Y),(X,ORIGAC)=$E(D,M),X=$S(X="J":"A",X=5:$E(DAY(MDY,"P"),M),1:X)
"RTN","PRS8MT",100,0)
 . ; If a 9mo AWS works during Recess don't place meal over that type of time
"RTN","PRS8MT",101,0)
 . I +NAWS=9 D  ; 9mo AWS nurses
"RTN","PRS8MT",102,0)
 . . ; If extra work (UN,OT,CT) was posted over the entire tour including the meal time
"RTN","PRS8MT",103,0)
 . . ; don't include meal time in the W node or you will reduce the extra work count.
"RTN","PRS8MT",104,0)
 . . ; Set X=0 to reduce the Recess count below.
"RTN","PRS8MT",105,0)
 . . I "4OEC"[ORIGAC&($L(ORIGX)=$L($TR(ORIGX,"1235"))) S X=0 Q
"RTN","PRS8MT",106,0)
 . . ;
"RTN","PRS8MT",107,0)
 . . ; If extra work posted over tour time that wasn't covered by Recess it will
"RTN","PRS8MT",108,0)
 . . ; be stored in the r node.  If this time exists, add that time back into the 
"RTN","PRS8MT",109,0)
 . . ; W node instead of the meal time.
"RTN","PRS8MT",110,0)
 . . I "1235"[ORIGAC,"4OEC"[$E(RECESS,M-V(1)+1) D  Q
"RTN","PRS8MT",111,0)
 . . . S D=$E(D,0,M-1)_$E(RECESS,M-V(1)+1)_$E(D,M+1,999)
"RTN","PRS8MT",112,0)
 . . . S ORIGX=$E(ORIGX,1,M-V(1)-1)_$E(RECESS,M-V(1)+1)_$E(ORIGX,M-V(1)+2,999)
"RTN","PRS8MT",113,0)
 . . ;
"RTN","PRS8MT",114,0)
 . . ; For everything else, update D and ORIGX
"RTN","PRS8MT",115,0)
 . . S D=$E(D,0,M-1)_"m"_$E(D,M+1,999)
"RTN","PRS8MT",116,0)
 . . S ORIGX=$E(ORIGX,M-V(1)-1)_"m"_$E(ORIGX,M-V(1)+2,999)
"RTN","PRS8MT",117,0)
 . ;
"RTN","PRS8MT",118,0)
 . ; All employees other than 9mo AWS
"RTN","PRS8MT",119,0)
 . I +NAWS'=9 S D=$E(D,0,M-1)_"m"_$E(D,M+1,999)
"RTN","PRS8MT",120,0)
 . ;
"RTN","PRS8MT",121,0)
 . ; The following line has been updated to include a check for Recess as the 48th piece.
"RTN","PRS8MT",122,0)
 . ; Recess will be designated as a zero (0). 
"RTN","PRS8MT",123,0)
 . S X=$S(X'="M":$F("LSWnAR*U************************V********YXFGD*0",X)-1,1:5)
"RTN","PRS8MT",124,0)
 . ;
"RTN","PRS8MT",125,0)
 . ; Firefighter checks
"RTN","PRS8MT",126,0)
 . I "Ff"[TYP,NH'=480!(NH(1)'=NH(2)) S X=32
"RTN","PRS8MT",127,0)
 . ;I X'=4,CYA2806>0 S CYA2806=CYA2806-1 ; << ADDED-> DROP LUNCH FROM CY ALSO>>
"RTN","PRS8MT",128,0)
 . Q:X'>0
"RTN","PRS8MT",129,0)
 . Q:MDY=0&(M(Y)<96)!(MDY=14&(M(Y)>97))
"RTN","PRS8MT",130,0)
 . S W=$S(MDY<8:1,1:2) I MDY=7&(M(Y)>96) S W=2
"RTN","PRS8MT",131,0)
 . I $P(WK(W),"^",+X)>0 S $P(WK(W),"^",+X)=$P(WK(W),"^",+X)-1 ;subtract
"RTN","PRS8MT",132,0)
 . ;
"RTN","PRS8MT",133,0)
 . ; If Military Leave subtract the mealtime out of the WK(3) array.
"RTN","PRS8MT",134,0)
 . I ORIGAC="M",$P(WK(3),U,11)>0 S $P(WK(3),U,11)=$P(WK(3),U,11)-1
"RTN","PRS8MT",135,0)
 . ;I WPCYA>0 S WPCYA=WPCYA-1 ;lunch from total << AND FROM CA TOTAL >>
"RTN","PRS8MT",136,0)
 . ; PRS*4*40 added 8 (U), 44 (F), 45 (G), 46 (D) to following line
"RTN","PRS8MT",137,0)
 . ; because PRS8AC also increments LU for those types of time
"RTN","PRS8MT",138,0)
 . I +X,"^1^2^6^8^44^45^46^"[("^"_+X_"^") S LU=LU-1 ;reduce leave used
"RTN","PRS8MT",139,0)
 . I +X,"^3^"[("^"_+X_"^"),"P"[TYP S TH=TH+1,TH(W)=TH(W)+1
"RTN","PRS8MT",140,0)
 . Q
"RTN","PRS8MT",141,0)
 S DAY(MDY,"W")=$E(D,1,96)
"RTN","PRS8MT",142,0)
 S X=$E(D,97,999) I $L(X) D
"RTN","PRS8MT",143,0)
 .I $D(DAY(MDY+1,"W")) S DAY(MDY+1,"W")=X_$E(DAY(MDY+1,"W"),$L(X)+1,999)
"RTN","PRS8MT",144,0)
 .S DAY(MDY,"N")=X
"RTN","PRS8MT",145,0)
 Q
"RTN","PRS8MT",146,0)
 ;
"RTN","PRS8MT",147,0)
SET ; --- set up for processing
"RTN","PRS8MT",148,0)
 K A,B S (A,B,Q,Y)=0
"RTN","PRS8MT",149,0)
 S MT=$G(DAY(MDY,"MT"_S)) I MT'>0 S Q=1 Q  ; mealtime for tour?
"RTN","PRS8MT",150,0)
 S D=DAY(MDY,"W")_$G(DAY(MDY,"N")) ; get daily activity
"RTN","PRS8MT",151,0)
 S N=DAY(MDY,S*S) ; get tour
"RTN","PRS8MT",152,0)
 Q
"RTN","PRS8SU")
0^9^B22986620^B23008538
"RTN","PRS8SU",1,0)
PRS8SU ;HISC/MRL-DECOMPOSITION, SET-UP ;02/20/08
"RTN","PRS8SU",2,0)
 ;;4.0;PAID;**112,116**;Sep 21, 1995;Build 23
"RTN","PRS8SU",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRS8SU",4,0)
 ;
"RTN","PRS8SU",5,0)
 ;This routine sets up various data elements required to process
"RTN","PRS8SU",6,0)
 ;a decomp.  The ^TMP array is built for each day of the
"RTN","PRS8SU",7,0)
 ;pay period (1-14) and includes tour information, exceptions,
"RTN","PRS8SU",8,0)
 ;holiday information, etc.  All times are converted to 15-minute
"RTN","PRS8SU",9,0)
 ;increments in this routine (the number of 15-minute increments
"RTN","PRS8SU",10,0)
 ;into the day).  Additionally, the credit tour for WG
"RTN","PRS8SU",11,0)
 ;employees is determined in this routine.
"RTN","PRS8SU",12,0)
 ;
"RTN","PRS8SU",13,0)
 ;Called by Routines:  PRS8DR
"RTN","PRS8SU",14,0)
 ;
"RTN","PRS8SU",15,0)
 K ^TMP($J,"PRS8")
"RTN","PRS8SU",16,0)
 K D,DAY F DAY=0:1:15 D
"RTN","PRS8SU",17,0)
 .I 'CYA,DAY>1,DAY<15,$E($P(PPD,"^",DAY),4,7)="0101" S CYA=DAY
"RTN","PRS8SU",18,0)
 .S P=0 I 'DAY S P=+PPD(0),D=14 ;last day of previous pp
"RTN","PRS8SU",19,0)
 .I DAY=15 S P=+PPD(15),D=1 ;first day of next pp
"RTN","PRS8SU",20,0)
 .I P S ZZ=$S(D=14:0,1:15)
"RTN","PRS8SU",21,0)
 .I 'P S P=+PY,(ZZ,D)=+DAY
"RTN","PRS8SU",22,0)
 .S W=$S(D<8:1,1:2) K DADRFM S DADRFM=1
"RTN","PRS8SU",23,0)
 .S TWO=0 F N=0,1,4,2,10 S Z=$G(^PRST(458,+P,"E",+DFN,"D",+D,N)) D
"RTN","PRS8SU",24,0)
 ..S (N14,NDAY,LAST,QT)=0,D(N)=Z,N1=$S(N=2:4,1:3)
"RTN","PRS8SU",25,0)
 ..I N=0,$S(ZZ<15:1,1:0) F J=2,13 I +$P(D(0),"^",J) D
"RTN","PRS8SU",26,0)
 ...S X=+$P(D(0),"^",$S(J=2:8,1:14)) Q:'X  ;normal hours
"RTN","PRS8SU",27,0)
 ...I DAY'=0 S X=X\.25 S NH(W)=NH(W)+X ;increment NH
"RTN","PRS8SU",28,0)
 ...S Z1=Z,Z=X,D1=D,X="DH"_$S(J=2:1,1:2) D SET S Z=Z1 ;save NH
"RTN","PRS8SU",29,0)
 ...S X=+$P(D(0),"^",J)
"RTN","PRS8SU",30,0)
 ...S X=+$P($G(^PRST(457.1,+X,0)),"^",3) Q:'X  ;mltime
"RTN","PRS8SU",31,0)
 ...S X=X\15,MT($S(J=2:1,1:2))=X ;save mltime
"RTN","PRS8SU",32,0)
 ...I X S X1=Z,Z=X,D1=D,X="MT"_$S(J=2:1,1:2) D SET S Z=X1
"RTN","PRS8SU",33,0)
 ..I "^1^2^4^"[("^"_N_"^") F K=1:N1 S V=$P(Z,"^",K,K+1) Q:QT  D
"RTN","PRS8SU",34,0)
 ...S X=$P(Z,U,K,999) S:X?1"^"."^"!(X="")!(N14=1) QT=1 I QT!($P(Z,U,K)="") Q
"RTN","PRS8SU",35,0)
 ...S:K=1 (NDAY,LAST)=0 F K1=1,2 S X=$P(V,"^",K1),(Y,Y1)=K1-1 I X'="" D
"RTN","PRS8SU",36,0)
 ....S FLAG=1 I N=2&(K1=1)&("^HW^"[("^"_$P(Z,"^",K+2)_"^")) S FLAG=$S(NDAY=1!(LAST>96)&("^HW^"[("^"_$P(Z,"^",K+2)_"^"))&((X["A")!(X["MID")):0,1:1),NDAY=0
"RTN","PRS8SU",37,0)
 ....S:$P(D(0),"^",14)'=""&(X="MID")&(LAST=96)&(N=2)&(K1=1) FLAG=0 S:N=2&(K1=1)&(FLAG=1) (NDAY,LAST)=0 S Y=K1-1 D 15
"RTN","PRS8SU",38,0)
 ....I N=2,"^RG^OT^CT^ON^SB^"'[("^"_$P(Z,"^",K+2)_"^") D
"RTN","PRS8SU",39,0)
 .....S Y=+$O(DADRFM("S",(-X-.01))),Y1=+$O(DADRFM("F",(X-.01)))
"RTN","PRS8SU",40,0)
 .....I $G(DADRFM("S",Y))'=$G(DADRFM("F",Y1)) S X=X+96
"RTN","PRS8SU",41,0)
 .....Q
"RTN","PRS8SU",42,0)
 ....S $P(Z,"^",K+(K1-1))=X ;15-minute conversion
"RTN","PRS8SU",43,0)
 ....I K1=1,N=1!(N=4) S DADRFM("S",-X)=DADRFM
"RTN","PRS8SU",44,0)
 ....I K1=2,N=1!(N=4) S DADRFM("F",X)=DADRFM,DADRFM=DADRFM+1
"RTN","PRS8SU",45,0)
 ....I K1=2,X>96,N'=2 S Y=$P(Z,"^",(K+K1)) I Y=""!("12345"'[Y) S X=X-96 D
"RTN","PRS8SU",46,0)
 .....I "^0^7^14^"'[("^"_+ZZ_"^") Q
"RTN","PRS8SU",47,0)
 .....I $G(^TMP($J,"PRS8",DAY,"MT1"))>1 S X=X-$G(^TMP($J,"PRS8",DAY,"MT1"))
"RTN","PRS8SU",48,0)
 .....I ZZ=0!(ZZ=7) S NH($S('ZZ:1,1:2))=NH($S('ZZ:1,1:2))+X
"RTN","PRS8SU",49,0)
 .....Q:'ZZ  ;already moved previous time to this pp
"RTN","PRS8SU",50,0)
 .....S NH($S(D=7:1,1:2))=NH($S(D=7:1,1:2))-X
"RTN","PRS8SU",51,0)
 .....Q
"RTN","PRS8SU",52,0)
 ....Q
"RTN","PRS8SU",53,0)
 ...I N=4,Z?1AN.E!(Z?1"^".AN) D  ;2-tour day
"RTN","PRS8SU",54,0)
 ....I +D(1)'>+Z S TWO=1_"^"_+Z ;early tour first
"RTN","PRS8SU",55,0)
 ....E  S TWO=2_"^"_+D(1) ;late tour first
"RTN","PRS8SU",56,0)
 ....Q:+TWO=1  ;we're gonna switch 1&4 nodes if necessary now
"RTN","PRS8SU",57,0)
 ....S X1=^TMP($J,"PRS8",DAY,1),D1=D,X=1,D(1)=Z D SET ;move 4 node to 1
"RTN","PRS8SU",58,0)
 ....S Z=X1,N14=1 K X,X1 ;this will move 1 node to 4
"RTN","PRS8SU",59,0)
 ..S D(N)=Z,D1=D,X=N D SET
"RTN","PRS8SU",60,0)
 .K DADRFM,MT1,MT2
"RTN","PRS8SU",61,0)
 .S Z=TWO,D1=D,X="TWO" D SET
"RTN","PRS8SU",62,0)
 .S Z="",$P(Z,"0",97)="",D1=D,X="W" D SET ;activity string
"RTN","PRS8SU",63,0)
 .S X="HOL" D SET ;save holiday string
"RTN","PRS8SU",64,0)
 .S X="P" D SET ;premium node
"RTN","PRS8SU",65,0)
 .S X="r" D SET ;Recess node
"RTN","PRS8SU",66,0)
 .S X=D(0),OFF=0 I $P(X,"^",2)=1 S OFF=1 ;day off
"RTN","PRS8SU",67,0)
 .S Z=OFF,X="OFF" D SET
"RTN","PRS8SU",68,0)
 .I +TWO=2 S MT2=$G(^TMP($J,"PRS8",D1,"MT2")),MT1=$G(^TMP($J,"PRS8",D1,"MT1")),^TMP($J,"PRS8",D1,"MT2")=MT1,^TMP($J,"PRS8",D1,"MT1")=MT2
"RTN","PRS8SU",69,0)
 .I TYP["W" D  ; -- compute credit tour for WG
"RTN","PRS8SU",70,0)
 ..S X=D(0) I DAY=0 S (L,T)=0
"RTN","PRS8SU",71,0)
 ..I $P(X,"^",3) S X=$G(^PRST(457.1,+$P(X,"^",4),1)) ;temp tour
"RTN","PRS8SU",72,0)
 ..E  S X=D(1) ;not temporary
"RTN","PRS8SU",73,0)
 ..S S=0 F J=1,4 Q:D(J)=""  F I=3:3:28 Q:S!($P(D(J),"^",(I-2))="")  D
"RTN","PRS8SU",74,0)
 ...I "^6^7^"[("^"_+$P(D(J),"^",I)_"^") S S=+$P(D(J),"^",I)-4
"RTN","PRS8SU",75,0)
 ..I 'OFF S:'S S=1 S:(DAY>0)&(DAY<15) L=S ;credit tour
"RTN","PRS8SU",76,0)
 ..I DAY>0,DAY<15 D
"RTN","PRS8SU",77,0)
 ...I 'T S T=+S
"RTN","PRS8SU",78,0)
 ...I S S T=S ;T=credit tour on days off
"RTN","PRS8SU",79,0)
 ..S Z=S S:TYP'["W"&(Z>1) Z=1 S D1=DAY,X="TOUR" D SET
"RTN","PRS8SU",80,0)
 ..I DAY=7!(DAY=14) S TOUR((DAY\7))=$S(T:T,1:1),T=0 ;save tour
"RTN","PRS8SU",81,0)
 I TYP["B" S NH=320,(NH(1),NH(2))=160,TH=192,(TH(1),TH(2))=96 ; Baylor NH=40 hrs to mimic full time, TH = 24 hrs for reality
"RTN","PRS8SU",82,0)
 E  S TH=NH,TH(1)=NH(1),TH(2)=NH(2) ;total hrs for pp
"RTN","PRS8SU",83,0)
 ; 
"RTN","PRS8SU",84,0)
 ; Update NH for the nurses on the 36/40 AWS
"RTN","PRS8SU",85,0)
 I "KM"[$E(AC,1),$E(AC,2)=1,NH=288 S NH=320,(NH(1),NH(2))=160,TH=320,(TH(1),TH(2))=160
"RTN","PRS8SU",86,0)
 ;
"RTN","PRS8SU",87,0)
 I TYP["W",L>1 S $P(WK(3),"^",3)=L ;last tour (IN) in misc for WG
"RTN","PRS8SU",88,0)
 S VALOLD=$G(^PRST(458,+PY,"E",+DFN,5)) ;existing decomp
"RTN","PRS8SU",89,0)
 K D,D1,DAY,NDAY,FLAG,J,K,K1,L,LAST,MT,N,N1,N14,P,QT,T,V,W,X,Y,Y1,Z
"RTN","PRS8SU",90,0)
 G ^PRS8ST ;start decomp
"RTN","PRS8SU",91,0)
 ;
"RTN","PRS8SU",92,0)
15 ; --- convert time to 15-minute increments
"RTN","PRS8SU",93,0)
 ;
"RTN","PRS8SU",94,0)
 ; Need to conditionally set Y $S(Y=0 mid=00:00, y=1: mid=24:00)
"RTN","PRS8SU",95,0)
 ; based on whether exception is within or outside the tour.
"RTN","PRS8SU",96,0)
 D MIL^PRSATIM ;convert to military (24hr) time
"RTN","PRS8SU",97,0)
 I +Y<1000 S Y=$E("0000",0,4-$L(Y))_Y
"RTN","PRS8SU",98,0)
 S X=(+$E(Y,1,2)*4)+($E(Y,3,4)\15)
"RTN","PRS8SU",99,0)
 I 'Y1 S X=X+1 ; Add 15 minutes to start time
"RTN","PRS8SU",100,0)
 I X<LAST S X=X+96,NDAY=1 ;new day
"RTN","PRS8SU",101,0)
 S LAST=X Q
"RTN","PRS8SU",102,0)
 ;
"RTN","PRS8SU",103,0)
SET ; --- save value (Z) in ^TMP($J,"PRS8",DAY,X)
"RTN","PRS8SU",104,0)
 ;
"RTN","PRS8SU",105,0)
 S D1=+ZZ
"RTN","PRS8SU",106,0)
 S ^TMP($J,"PRS8",D1,X)=Z Q
"RTN","PRS8SU",107,0)
 ;
"RTN","PRS8SU",108,0)
TAL ; --- T&L Unit (whole zeroth node)
"RTN","PRS8SU",109,0)
 ;
"RTN","PRS8SU",110,0)
 S X=$O(^PRST(455.5,"B",X,0))
"RTN","PRS8SU",111,0)
 S X=$G(^PRST(455.5,+X,0)) I $E(X)="" S X=""
"RTN","PRSA8BNH")
0^7^B56986678^n/a
"RTN","PRSA8BNH",1,0)
PRSA8BNH ;WOIFO/JAH - Tour Hours vs 8B Norm Hrs Report ;12/28/07
"RTN","PRSA8BNH",2,0)
 ;;4.0;PAID;**116**;Sep 21, 1995;Build 23
"RTN","PRSA8BNH",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRSA8BNH",4,0)
 Q
"RTN","PRSA8BNH",5,0)
 ; Search for 8b normal hours that don't match tours
"RTN","PRSA8BNH",6,0)
 ; look in timecard 8B node for normal hours otherwise use 450
"RTN","PRSA8BNH",7,0)
 ;
"RTN","PRSA8BNH",8,0)
PAYROLL ;prompt for T&L's--set's up payroll all T&L's
"RTN","PRSA8BNH",9,0)
 N PRSTLV,FORWHO
"RTN","PRSA8BNH",10,0)
 S PRSTLV=7
"RTN","PRSA8BNH",11,0)
 S FORWHO="for Payroll"
"RTN","PRSA8BNH",12,0)
 ;
"RTN","PRSA8BNH",13,0)
TIMEKEEP ; entry point sets up timekeeper T&L variable for PRSAUTL call
"RTN","PRSA8BNH",14,0)
 I $G(PRSTLV)'>0 N PRSTLV,FORWHO S PRSTLV=2,FORWHO="for Timekeeper"
"RTN","PRSA8BNH",15,0)
 ;
"RTN","PRSA8BNH",16,0)
SUPERV ; sets up supervisor for T&L lookup
"RTN","PRSA8BNH",17,0)
 I $G(PRSTLV)'>0 N PRSTLV,FORWHO S PRSTLV=3,FORWHO="for T&A Supervisor"
"RTN","PRSA8BNH",18,0)
 ;
"RTN","PRSA8BNH",19,0)
 N DIR,DIRUT,TLS,Y,PPI,PPE,NOTOUR,NOTCARD,PPRANGE,DAILYHRS,EP,SP,SDT,EDT
"RTN","PRSA8BNH",20,0)
 S TLS=1
"RTN","PRSA8BNH",21,0)
 S DIR(0)="Y"
"RTN","PRSA8BNH",22,0)
 S DIR("B")="Y"
"RTN","PRSA8BNH",23,0)
 S DIR("A")="All T&L's"
"RTN","PRSA8BNH",24,0)
 D ^DIR
"RTN","PRSA8BNH",25,0)
 Q:$D(DIRUT)
"RTN","PRSA8BNH",26,0)
 I +Y=1 S TLS="ALL"
"RTN","PRSA8BNH",27,0)
 I TLS=1 D
"RTN","PRSA8BNH",28,0)
 .  D ^PRSAUTL
"RTN","PRSA8BNH",29,0)
 Q:TLS=1&($G(TLI)="")
"RTN","PRSA8BNH",30,0)
 ;
"RTN","PRSA8BNH",31,0)
 S PPI=$$GETPP^PRSA8BNI()
"RTN","PRSA8BNH",32,0)
 Q:PPI'>0
"RTN","PRSA8BNH",33,0)
 S PPE=$P($G(^PRST(458,PPI,0)),U)
"RTN","PRSA8BNH",34,0)
 S SDT=$P($G(^PRST(458,PPI,2)),U)
"RTN","PRSA8BNH",35,0)
 S EDT=$P($G(^PRST(458,PPI,2)),U,14)
"RTN","PRSA8BNH",36,0)
 S SP=$L(SDT," ")
"RTN","PRSA8BNH",37,0)
 S EP=$L(EDT," ")
"RTN","PRSA8BNH",38,0)
 S PPRANGE=$P(SDT," ",SP)_" thru "_$P(EDT," ",EP)
"RTN","PRSA8BNH",39,0)
 ;
"RTN","PRSA8BNH",40,0)
 ; ask user to include employees with no timecard at all.
"RTN","PRSA8BNH",41,0)
 S NOTCARD=$$NOTCARD^PRSA8BNI()
"RTN","PRSA8BNH",42,0)
 Q:NOTCARD<0
"RTN","PRSA8BNH",43,0)
 ;
"RTN","PRSA8BNH",44,0)
 ; ask user to include employees with no tour of duty entered
"RTN","PRSA8BNH",45,0)
 S NOTOUR=$$NOTOURS^PRSA8BNI()
"RTN","PRSA8BNH",46,0)
 Q:NOTOUR<0
"RTN","PRSA8BNH",47,0)
 ;
"RTN","PRSA8BNH",48,0)
 ; ask user to include employees daily tour hours
"RTN","PRSA8BNH",49,0)
 S DAILYHRS=$$DAILYHRS^PRSA8BNI()
"RTN","PRSA8BNH",50,0)
 Q:DAILYHRS<0
"RTN","PRSA8BNH",51,0)
 ;
"RTN","PRSA8BNH",52,0)
 ;
"RTN","PRSA8BNH",53,0)
 N %ZIS,POP,IOP
"RTN","PRSA8BNH",54,0)
 S %ZIS="MQ"
"RTN","PRSA8BNH",55,0)
 D ^%ZIS
"RTN","PRSA8BNH",56,0)
 Q:POP
"RTN","PRSA8BNH",57,0)
 I $D(IO("Q")) D
"RTN","PRSA8BNH",58,0)
 .  K IO("Q")
"RTN","PRSA8BNH",59,0)
 .  N ZTDESC,ZTRTN,ZTSAVE
"RTN","PRSA8BNH",60,0)
 .  S ZTDESC="PAID REPORT: TOUR HOURS DON'T MATCH 8B NORMAL"
"RTN","PRSA8BNH",61,0)
 .  S ZTRTN="TOUR8B^PRSA8BNH"
"RTN","PRSA8BNH",62,0)
 .  S ZTSAVE("PRSTLV")=""
"RTN","PRSA8BNH",63,0)
 .  S ZTSAVE("TLE")=""
"RTN","PRSA8BNH",64,0)
 .  S ZTSAVE("PPI")=""
"RTN","PRSA8BNH",65,0)
 .  S ZTSAVE("PPE")=""
"RTN","PRSA8BNH",66,0)
 .  S ZTSAVE("TLS")=""
"RTN","PRSA8BNH",67,0)
 .  S ZTSAVE("NOTOUR")=""
"RTN","PRSA8BNH",68,0)
 .  S ZTSAVE("NOTCARD")=""
"RTN","PRSA8BNH",69,0)
 .  S ZTSAVE("DAILYHRS")=""
"RTN","PRSA8BNH",70,0)
 .  S ZTSAVE("PPRANGE")=""
"RTN","PRSA8BNH",71,0)
 .  S ZTSAVE("FORWHO")=""
"RTN","PRSA8BNH",72,0)
 .  D ^%ZTLOAD
"RTN","PRSA8BNH",73,0)
 .  I $D(ZTSK) S ZTREQ="@"
"RTN","PRSA8BNH",74,0)
 E  D
"RTN","PRSA8BNH",75,0)
 .  D TOUR8B
"RTN","PRSA8BNH",76,0)
 K PRSTLV
"RTN","PRSA8BNH",77,0)
 D ^%ZISC K %ZIS,IOP
"RTN","PRSA8BNH",78,0)
 Q
"RTN","PRSA8BNH",79,0)
 ;
"RTN","PRSA8BNH",80,0)
TOUR8B ;
"RTN","PRSA8BNH",81,0)
 U IO
"RTN","PRSA8BNH",82,0)
 N OUT,TLECNT,TSTAMP,Y,%,%I,GRANDTOT,PG,ATL
"RTN","PRSA8BNH",83,0)
 D NOW^%DTC S Y=% D DD^%DT S TSTAMP=$P(Y,":",1,2)
"RTN","PRSA8BNH",84,0)
 S (TLECNT,OUT,GRANDTOT,PG)=0
"RTN","PRSA8BNH",85,0)
 I TLS="ALL" D
"RTN","PRSA8BNH",86,0)
 .  N TLI,TLE
"RTN","PRSA8BNH",87,0)
 .  S ATL="ATL"
"RTN","PRSA8BNH",88,0)
 .  F  S ATL=$O(^PRSPC(ATL)) Q:ATL>"ATLVCS"!OUT  D
"RTN","PRSA8BNH",89,0)
 ..    S TLE=$E(ATL,4,6)
"RTN","PRSA8BNH",90,0)
 ..    Q:TLE=""
"RTN","PRSA8BNH",91,0)
 ..    S TLI=$O(^PRST(455.5,"B",TLE,0))
"RTN","PRSA8BNH",92,0)
 ..    Q:TLI'>0
"RTN","PRSA8BNH",93,0)
 ..; skip T&L's supervisors and timekeepers don't have access too
"RTN","PRSA8BNH",94,0)
 ..    Q:(PRSTLV=2)&('$D(^PRST(455.5,"AT",DUZ,TLI)))
"RTN","PRSA8BNH",95,0)
 ..    Q:(PRSTLV=3)&('$D(^PRST(455.5,"AS",DUZ,TLI)))
"RTN","PRSA8BNH",96,0)
 ..     I TLECNT=0 D HDR^PRSA8BNI(.PG,TSTAMP,0,FORWHO,PPE,PPRANGE)
"RTN","PRSA8BNH",97,0)
 ..     D LOOPTL(.OUT,.GRANDTOT,TLE,PPI,TSTAMP)
"RTN","PRSA8BNH",98,0)
 ..     S TLECNT=TLECNT+1
"RTN","PRSA8BNH",99,0)
 E  D
"RTN","PRSA8BNH",100,0)
 .   D HDR^PRSA8BNI(.PG,TSTAMP,0,FORWHO,PPE,PPRANGE)
"RTN","PRSA8BNH",101,0)
 .   D LOOPTL(.OUT,.GRANDTOT,TLE,PPI,TSTAMP)
"RTN","PRSA8BNH",102,0)
 .   S TLECNT=TLECNT+1
"RTN","PRSA8BNH",103,0)
 D REPDONE^PRSA8BNI(OUT,TLECNT,TSTAMP,DAILYHRS,GRANDTOT)
"RTN","PRSA8BNH",104,0)
 Q
"RTN","PRSA8BNH",105,0)
 ;
"RTN","PRSA8BNH",106,0)
LOOPTL(OUT,TOT,TLE,PPI,TSTAMP) ; LOOP THROUGH T&L
"RTN","PRSA8BNH",107,0)
 N COUNT,NN,PRSIEN,EMPNODE,PRSENAME,HRS,EMPND1,SEPIND,WEEKHRS,PRSD,PRSSN
"RTN","PRSA8BNH",108,0)
 K ERRORS
"RTN","PRSA8BNH",109,0)
 S (COUNT,OUT)=0
"RTN","PRSA8BNH",110,0)
 S NN=""
"RTN","PRSA8BNH",111,0)
 F  S NN=$O(^PRSPC("ATL"_TLE,NN)) Q:NN=""  D
"RTN","PRSA8BNH",112,0)
 .  F PRSIEN=0:0 S PRSIEN=$O(^PRSPC("ATL"_TLE,NN,PRSIEN)) Q:PRSIEN<1!(OUT)  D
"RTN","PRSA8BNH",113,0)
 ..;  skip Extended LWOP or anyone without a timecard
"RTN","PRSA8BNH",114,0)
 ..    Q:'NOTCARD&($G(^PRST(458,PPI,"E",PRSIEN,0))="")
"RTN","PRSA8BNH",115,0)
 ..    Q:'NOTOUR&($P($G(^PRST(458,PPI,"E",PRSIEN,"D",1,0)),U,2)="")
"RTN","PRSA8BNH",116,0)
 ..    S EMPNODE=$G(^PRSPC(PRSIEN,0))
"RTN","PRSA8BNH",117,0)
 ..    S EMPND1=$G(^PRSPC(PRSIEN,1))
"RTN","PRSA8BNH",118,0)
 ..    S SEPIND=$P(EMPND1,U,33)
"RTN","PRSA8BNH",119,0)
 ..    Q:EMPNODE=""!(SEPIND="Y")
"RTN","PRSA8BNH",120,0)
 ..    I '$$HRSMATCH^PRSATPE(PPI,PRSIEN) D
"RTN","PRSA8BNH",121,0)
 ...     S COUNT=COUNT+1
"RTN","PRSA8BNH",122,0)
 ...     S GRANDTOT=GRANDTOT+1
"RTN","PRSA8BNH",123,0)
 ...     S ERRORS(PRSIEN)=""
"RTN","PRSA8BNH",124,0)
 I COUNT>0 D
"RTN","PRSA8BNH",125,0)
 .  I DAILYHRS,$Y>(IOSL-12) S OUT=$$RET^PRSA8BNI(TSTAMP) Q:OUT
"RTN","PRSA8BNH",126,0)
 .  I 'DAILYHRS,$Y>(IOSL-7) S OUT=$$RET^PRSA8BNI(TSTAMP) Q:OUT
"RTN","PRSA8BNH",127,0)
 .  W !!,?12,"T & L UNIT: "_TLE,"   ",COUNT," mismatches found."
"RTN","PRSA8BNH",128,0)
 .  S PRSIEN=""
"RTN","PRSA8BNH",129,0)
 .  F  S PRSIEN=$O(ERRORS(PRSIEN)) Q:PRSIEN'>0!OUT  D
"RTN","PRSA8BNH",130,0)
 ..   S WEEKHRS=$$GETHOURS^PRSA8BNI(PPI,PRSIEN)
"RTN","PRSA8BNH",131,0)
 ..   S PRSENAME=$P($G(^PRSPC(PRSIEN,0)),U)
"RTN","PRSA8BNH",132,0)
 ..   S PRSSN=$P($G(^PRSPC(PRSIEN,0)),U,9)
"RTN","PRSA8BNH",133,0)
 ..   S PRSSN=$S(PRSTLV=7:$E(PRSSN,1,3)_"-"_$E(PRSSN,4,5),PRSTLV'<2:$E(PRSSN,1)_"XX-XX",1:"XXX-XX")_"-"_$E(PRSSN,6,9)
"RTN","PRSA8BNH",134,0)
 ..   I DAILYHRS,$Y>(IOSL-10) S OUT=$$RET^PRSA8BNI(TSTAMP) Q:OUT
"RTN","PRSA8BNH",135,0)
 ..   I 'DAILYHRS,$Y>(IOSL-5) S OUT=$$RET^PRSA8BNI(TSTAMP) Q:OUT
"RTN","PRSA8BNH",136,0)
 ..   D EMPINFO^PRSA8BNI(PRSENAME,PRSSN,WEEKHRS)
"RTN","PRSA8BNH",137,0)
 ..;  show the actual tour hours for each day
"RTN","PRSA8BNH",138,0)
 ..   I DAILYHRS D
"RTN","PRSA8BNH",139,0)
 ...    N HRS,I
"RTN","PRSA8BNH",140,0)
 ...    D TOURHRS^PRSARC07(.HRS,PPI,PRSIEN)
"RTN","PRSA8BNH",141,0)
 ...    I $Y>(IOSL-8) S OUT=$$RET^PRSA8BNI(TSTAMP) Q:OUT  D EMPINFO^PRSA8BNI(PRSENAME,PRSSN,WEEKHRS)
"RTN","PRSA8BNH",142,0)
 ...    D TRHDR^PRSA8BNI
"RTN","PRSA8BNH",143,0)
 ...    F PRSD=1:1:7 D  Q:OUT
"RTN","PRSA8BNH",144,0)
 ....     I $Y>(IOSL-4) S OUT=$$RET^PRSA8BNI(TSTAMP) Q:OUT  D EMPINFO^PRSA8BNI(PRSENAME,PRSSN,WEEKHRS),TRHDR^PRSA8BNI
"RTN","PRSA8BNH",145,0)
 ....     Q:OUT
"RTN","PRSA8BNH",146,0)
 ....     D TOURDISP(PPI,PRSIEN,PRSD,.HRS)
"RTN","PRSA8BNH",147,0)
 ..   Q:OUT
"RTN","PRSA8BNH",148,0)
 ..   I $Y>(IOSL-5) S OUT=$$RET^PRSA8BNI(TSTAMP) Q:OUT
"RTN","PRSA8BNH",149,0)
 Q
"RTN","PRSA8BNH",150,0)
TOURDISP(PPI,PRSIEN,PRSD,HRS) ;
"RTN","PRSA8BNH",151,0)
 N Y1,Y2,Y4,Y5,DTE,TD1C1,TD1C2,L2,L3,TD2C1,TD2C2
"RTN","PRSA8BNH",152,0)
 S TD1C1=$P($G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,0)),"^",2),Y1=$G(^(1)),Y4=$G(^(4))
"RTN","PRSA8BNH",153,0)
 S TD2C1=$P($G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,0)),"^",13)
"RTN","PRSA8BNH",154,0)
 I Y1="" S Y1=$S(TD1C1=1:"Day Off",TD1C1=2:"Day Tour",TD1C1=3!(TD1C1=4):"Intermittent",1:"")
"RTN","PRSA8BNH",155,0)
 S TD1C2=$P($G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD+7,0)),"^",2),Y2=$G(^(1)),Y5=$G(^(4))
"RTN","PRSA8BNH",156,0)
 S TD2C2=$P($G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD+7,0)),"^",13)
"RTN","PRSA8BNH",157,0)
 I Y2="" S Y2=$S(TD1C2=1:"Day Off",TD1C2=2:"Day Tour",TD1C2=3!(TD1C2=4):"Intermittent",1:"")
"RTN","PRSA8BNH",158,0)
 S DTE=$P("Sun Mon Tue Wed Thu Fri Sat"," ",PRSD)
"RTN","PRSA8BNH",159,0)
 W !?7,DTE S (L2,L3)=0
"RTN","PRSA8BNH",160,0)
 I Y1="",Y2="" Q
"RTN","PRSA8BNH",161,0)
 ;
"RTN","PRSA8BNH",162,0)
S0 ; Set Schedule Array
"RTN","PRSA8BNH",163,0)
 N A1,L1,B
"RTN","PRSA8BNH",164,0)
 F L1=1:3:19 D
"RTN","PRSA8BNH",165,0)
 .  S A1=$P(Y1,"^",L1) Q:A1=""
"RTN","PRSA8BNH",166,0)
 .  S L2=L2+1,Y1(L2)=A1
"RTN","PRSA8BNH",167,0)
 .  S:$P(Y1,"^",L1+1)'="" Y1(L2)=Y1(L2)_"-"_$P(Y1,"^",L1+1)
"RTN","PRSA8BNH",168,0)
 .  I L1=1 D
"RTN","PRSA8BNH",169,0)
 ..   N DAYHRS S DAYHRS=$J($P(HRS(PRSD),U,2),5,2)
"RTN","PRSA8BNH",170,0)
 ..   S B=$E("               ",1,20-$L(DAYHRS)-$L(Y1(L2)))
"RTN","PRSA8BNH",171,0)
 ..   S Y1(L2)=$J(TD1C1,5,0)_"  "_Y1(L2)_B_DAYHRS
"RTN","PRSA8BNH",172,0)
 .  E  D
"RTN","PRSA8BNH",173,0)
 ..   S Y1(L2)="       "_Y1(L2)
"RTN","PRSA8BNH",174,0)
 .  I $P(Y1,"^",L1+2)'="" D
"RTN","PRSA8BNH",175,0)
 ..   S L2=L2+1
"RTN","PRSA8BNH",176,0)
 ..   S Y1(L2)="        "_$P($G(^PRST(457.2,+$P(Y1,"^",L1+2),0)),"^",1)
"RTN","PRSA8BNH",177,0)
 G:Y4="" S1
"RTN","PRSA8BNH",178,0)
 F L1=1:3:19 D
"RTN","PRSA8BNH",179,0)
 .  S A1=$P(Y4,"^",L1) Q:A1=""
"RTN","PRSA8BNH",180,0)
 .  S L2=L2+1
"RTN","PRSA8BNH",181,0)
 .  S Y1(L2)=A1
"RTN","PRSA8BNH",182,0)
 .  S:$P(Y4,"^",L1+1)'="" Y1(L2)=Y1(L2)_"-"_$P(Y4,"^",L1+1)
"RTN","PRSA8BNH",183,0)
 .  I L1=1 D
"RTN","PRSA8BNH",184,0)
 ..   S Y1(L2)=$J(TD2C1,5,0)_"  "_Y1(L2)
"RTN","PRSA8BNH",185,0)
 .  E  D
"RTN","PRSA8BNH",186,0)
 ..   S Y1(L2)="       "_Y1(L2)
"RTN","PRSA8BNH",187,0)
 .  I $P(Y4,"^",L1+2)'="" D
"RTN","PRSA8BNH",188,0)
 ..   S L2=L2+1
"RTN","PRSA8BNH",189,0)
 ..   S Y1(L2)="        "_$P($G(^PRST(457.2,+$P(Y4,"^",L1+2),0)),"^",1)
"RTN","PRSA8BNH",190,0)
 ;
"RTN","PRSA8BNH",191,0)
S1 ; Set Schedule Array
"RTN","PRSA8BNH",192,0)
 F L1=1:3:19 D
"RTN","PRSA8BNH",193,0)
 .  S A1=$P(Y2,"^",L1) Q:A1=""
"RTN","PRSA8BNH",194,0)
 .  S L3=L3+1
"RTN","PRSA8BNH",195,0)
 .  S Y2(L3)=A1
"RTN","PRSA8BNH",196,0)
 .  S:$P(Y2,"^",L1+1)'="" Y2(L3)=Y2(L3)_"-"_$P(Y2,"^",L1+1)
"RTN","PRSA8BNH",197,0)
 .  I L1=1 D
"RTN","PRSA8BNH",198,0)
 ..   N DAYHRS S DAYHRS=$J($P(HRS(PRSD+7),U,2),5,2)
"RTN","PRSA8BNH",199,0)
 ..   S B=$E("               ",1,20-$L(DAYHRS)-$L(Y2(L3)))
"RTN","PRSA8BNH",200,0)
 ..   S Y2(L3)=$J(TD1C2,5,0)_"  "_Y2(L3)_B_DAYHRS
"RTN","PRSA8BNH",201,0)
 .  E  D
"RTN","PRSA8BNH",202,0)
 ..   S Y2(L3)="       "_Y2(L3)
"RTN","PRSA8BNH",203,0)
 .   I $P(Y2,"^",L1+2)'="" D
"RTN","PRSA8BNH",204,0)
 ..    S L3=L3+1
"RTN","PRSA8BNH",205,0)
 ..    S Y2(L3)="        "_$P($G(^PRST(457.2,+$P(Y2,"^",L1+2),0)),"^",1)
"RTN","PRSA8BNH",206,0)
 ;
"RTN","PRSA8BNH",207,0)
 G:Y5="" S2
"RTN","PRSA8BNH",208,0)
 ;
"RTN","PRSA8BNH",209,0)
 F L1=1:3:19 D
"RTN","PRSA8BNH",210,0)
 .  S A1=$P(Y5,"^",L1) Q:A1=""
"RTN","PRSA8BNH",211,0)
 .  S L3=L3+1,Y2(L3)=A1
"RTN","PRSA8BNH",212,0)
 .  S:$P(Y5,"^",L1+1)'="" Y2(L3)=Y2(L3)_"-"_$P(Y5,"^",L1+1)
"RTN","PRSA8BNH",213,0)
 .  I L1=1 D
"RTN","PRSA8BNH",214,0)
 ..   S Y2(L3)=$J(TD2C2,5,0)_"  "_Y2(L3)
"RTN","PRSA8BNH",215,0)
 .  E  D
"RTN","PRSA8BNH",216,0)
 ..   S Y2(L3)="       "_Y2(L3)
"RTN","PRSA8BNH",217,0)
 .  I $P(Y5,"^",L1+2)'="" D
"RTN","PRSA8BNH",218,0)
 ..   S L3=L3+1
"RTN","PRSA8BNH",219,0)
 ..   S Y2(L3)="        "_$P($G(^PRST(457.2,+$P(Y5,"^",L1+2),0)),"^",1)
"RTN","PRSA8BNH",220,0)
 ;
"RTN","PRSA8BNH",221,0)
S2 ;
"RTN","PRSA8BNH",222,0)
 N K
"RTN","PRSA8BNH",223,0)
 F K=1:1 Q:'$D(Y1(K))&'$D(Y2(K))  D
"RTN","PRSA8BNH",224,0)
 .  W:K>1 ! W:$D(Y1(K)) ?12,Y1(K) W:$D(Y2(K)) ?47,Y2(K)
"RTN","PRSA8BNH",225,0)
 Q
"RTN","PRSA8BNI")
0^10^B27323554^n/a
"RTN","PRSA8BNI",1,0)
PRSA8BNI ;WOIFO/JAH - Tour Hours vs 8B Norm Hrs Report ;3/5/08
"RTN","PRSA8BNI",2,0)
 ;;4.0;PAID;**116**;Sep 21, 1995;Build 23
"RTN","PRSA8BNI",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRSA8BNI",4,0)
 Q
"RTN","PRSA8BNI",5,0)
 ;
"RTN","PRSA8BNI",6,0)
GETPP() ;prompt for pay period
"RTN","PRSA8BNI",7,0)
 N DIC,X,Y,PPI,DTOUT
"RTN","PRSA8BNI",8,0)
 S DIC="^PRST(458,",DIC(0)="AEQM",DIC("A")="Select PAY PERIOD: "
"RTN","PRSA8BNI",9,0)
 W !
"RTN","PRSA8BNI",10,0)
 D ^DIC
"RTN","PRSA8BNI",11,0)
 S PPI=+Y
"RTN","PRSA8BNI",12,0)
 I $D(DTOUT)!(+Y'>0) S PPI=0
"RTN","PRSA8BNI",13,0)
 Q PPI
"RTN","PRSA8BNI",14,0)
NOTOURS() ;return true if user wants to see data from employees with
"RTN","PRSA8BNI",15,0)
 ;        no tour of duty set up yet
"RTN","PRSA8BNI",16,0)
 ;        otherwise return 0 or -1 for abort
"RTN","PRSA8BNI",17,0)
 ;
"RTN","PRSA8BNI",18,0)
 N DIR,DIRUT,Y
"RTN","PRSA8BNI",19,0)
 S DIR(0)="Y"
"RTN","PRSA8BNI",20,0)
 S DIR("B")="N"
"RTN","PRSA8BNI",21,0)
 S DIR("A")="Include employees with no tour of duty entered"
"RTN","PRSA8BNI",22,0)
 D ^DIR
"RTN","PRSA8BNI",23,0)
 Q:$D(DIRUT) -1
"RTN","PRSA8BNI",24,0)
 Q +Y
"RTN","PRSA8BNI",25,0)
 ;
"RTN","PRSA8BNI",26,0)
NOTCARD() ;return true if user wants to see data from employees with
"RTN","PRSA8BNI",27,0)
 ;  no timecard on file, ie no entry for pp in 458
"RTN","PRSA8BNI",28,0)
 ;  otherwise return 0 or -1 for abort
"RTN","PRSA8BNI",29,0)
 ;
"RTN","PRSA8BNI",30,0)
 N DIR,DIRUT,Y
"RTN","PRSA8BNI",31,0)
 S DIR(0)="Y"
"RTN","PRSA8BNI",32,0)
 S DIR("B")="N"
"RTN","PRSA8BNI",33,0)
 S DIR("A")="Include employees with no timecard on file"
"RTN","PRSA8BNI",34,0)
 D ^DIR
"RTN","PRSA8BNI",35,0)
 Q:$D(DIRUT) -1
"RTN","PRSA8BNI",36,0)
 Q +Y
"RTN","PRSA8BNI",37,0)
DAILYHRS() ;return true if user wants to see tour hours for each day
"RTN","PRSA8BNI",38,0)
 ;  otherwise return 0 or -1 for abort
"RTN","PRSA8BNI",39,0)
 ;
"RTN","PRSA8BNI",40,0)
 N DIR,DIRUT,Y
"RTN","PRSA8BNI",41,0)
 S DIR(0)="Y"
"RTN","PRSA8BNI",42,0)
 S DIR("B")="N"
"RTN","PRSA8BNI",43,0)
 S DIR("A")="Include employees daily tour hours"
"RTN","PRSA8BNI",44,0)
 D ^DIR
"RTN","PRSA8BNI",45,0)
 Q:$D(DIRUT) -1
"RTN","PRSA8BNI",46,0)
 Q +Y
"RTN","PRSA8BNI",47,0)
 ;
"RTN","PRSA8BNI",48,0)
TRHDR ;
"RTN","PRSA8BNI",49,0)
 W !!,?7,"Day",?12,"ToD #*",?19,"Tour Week 1",?34,"Hours*",?47,"ToD #*",?54,"Tour Week 2",?69,"Hours*"
"RTN","PRSA8BNI",50,0)
 W !,?7,"---",?12,"-----",?19,"-----------",?34,"-----",?47,"-----",?54,"-----------",?69,"-----"
"RTN","PRSA8BNI",51,0)
 Q
"RTN","PRSA8BNI",52,0)
EMPINFO(PRSENAME,PRSSN,HRS) ;
"RTN","PRSA8BNI",53,0)
 W !!?2,PRSENAME,?26,PRSSN,?44,$P(HRS,U),?55,$P(HRS,U,2)
"RTN","PRSA8BNI",54,0)
 I $G(DUZ(0))="@" W ?63,PRSIEN
"RTN","PRSA8BNI",55,0)
 Q
"RTN","PRSA8BNI",56,0)
HDR(PG,TSTAMP,END,FORWHO,PPE,PPRANGE) ;
"RTN","PRSA8BNI",57,0)
 S PG=PG+1
"RTN","PRSA8BNI",58,0)
 W @IOF
"RTN","PRSA8BNI",59,0)
 N H1,H2,B
"RTN","PRSA8BNI",60,0)
 S H1="VA TIME & ATTENDANCE REPORT "_FORWHO_"--"_TSTAMP
"RTN","PRSA8BNI",61,0)
 S B=$E("               ",1,(IOM-$L(H1))\2-3-$L(PG))
"RTN","PRSA8BNI",62,0)
 S H2="Tour Hrs Don't Match 8B Normal Hrs:  PP "_PPE_" ("_PPRANGE_")"
"RTN","PRSA8BNI",63,0)
 W !,?(IOM-$L(H1)\2),H1,B,"p",PG,!,?(IOM-$L(H2)\2),H2
"RTN","PRSA8BNI",64,0)
 Q:END
"RTN","PRSA8BNI",65,0)
 W !!,?2,"EMPLOYEE NAME",?26,"    SSN",?40,"8B NRM HRS   ToD HRS*"
"RTN","PRSA8BNI",66,0)
 I $G(DUZ(0))="@" W ?63,"IEN 450"
"RTN","PRSA8BNI",67,0)
 W !?2,"======================",?26,"===========",?40,"==========   ======="
"RTN","PRSA8BNI",68,0)
 I $G(DUZ(0))="@" W "   ======="
"RTN","PRSA8BNI",69,0)
 Q
"RTN","PRSA8BNI",70,0)
 ;
"RTN","PRSA8BNI",71,0)
RET(TSTAMP) ;
"RTN","PRSA8BNI",72,0)
 I ($E(IOST,1,2)'="C-")!($D(ZTQUEUED)) D HDR(.PG,TSTAMP,0,FORWHO,PPE,PPRANGE) Q 0
"RTN","PRSA8BNI",73,0)
 ;
"RTN","PRSA8BNI",74,0)
 N OUT
"RTN","PRSA8BNI",75,0)
 S OUT=$$ASK^PRSLIB00(1)
"RTN","PRSA8BNI",76,0)
 I 'OUT D HDR(.PG,TSTAMP,0,FORWHO,PPE,PPRANGE)
"RTN","PRSA8BNI",77,0)
 Q OUT
"RTN","PRSA8BNI",78,0)
GETHOURS(PPI,PRSIEN) ; Return TOUR HOURS AND NORMAL HOURS
"RTN","PRSA8BNI",79,0)
 N MATCH,HRS,NH,ENT,ENTPTR,DFN,TH
"RTN","PRSA8BNI",80,0)
 I $G(PPI)'>0!($G(PRSIEN)'>0) Q 1
"RTN","PRSA8BNI",81,0)
 S MATCH=1
"RTN","PRSA8BNI",82,0)
 S NH=-1
"RTN","PRSA8BNI",83,0)
 S ENTPTR=$P($G(^PRST(458,PPI,"E",PRSIEN,0)),U,5)
"RTN","PRSA8BNI",84,0)
 I ENTPTR'="" D
"RTN","PRSA8BNI",85,0)
 .  S ENT=$P($G(^PRST(457.5,ENTPTR,1)),U)
"RTN","PRSA8BNI",86,0)
 .  S NH=$E($G(^PRST(458,PPI,"E",PRSIEN,5)),26,27)
"RTN","PRSA8BNI",87,0)
 .  Q:NH="00"
"RTN","PRSA8BNI",88,0)
 .  I +NH'>0 S NH=$P($G(^PRSPC(PRSIEN,0)),U,50)
"RTN","PRSA8BNI",89,0)
 I $G(ENT)="" S DFN=PRSIEN D ^PRSAENT
"RTN","PRSA8BNI",90,0)
 I $G(ENT)'="",$E(ENT)'="D",($E(ENT,1,2)'="0D") D
"RTN","PRSA8BNI",91,0)
 .  D TOURHRS^PRSARC07(.HRS,PPI,PRSIEN)
"RTN","PRSA8BNI",92,0)
 .  S TH=($G(HRS("W1"))+$G(HRS("W2")))
"RTN","PRSA8BNI",93,0)
 Q NH_U_TH
"RTN","PRSA8BNI",94,0)
 ;
"RTN","PRSA8BNI",95,0)
REPDONE(OUT,TLECNT,TSTAMP,DAILYHRS,GRANDTOT) ; report done display page
"RTN","PRSA8BNI",96,0)
 ;
"RTN","PRSA8BNI",97,0)
 I TLECNT=0 D HDR(.PG,TSTAMP,1,FORWHO,PPE,PPRANGE) W !,"NO T&L UNITS WERE FOUND ASSIGNED TO YOU THAT COULD BE CHECKED." Q
"RTN","PRSA8BNI",98,0)
 I 'OUT,$Y>(IOSL-24) S OUT=$$ASK^PRSLIB00(1) D HDR(.PG,TSTAMP,1,FORWHO,PPE,PPRANGE)
"RTN","PRSA8BNI",99,0)
 I OUT W !!,"********REPORT ABORTED*********"
"RTN","PRSA8BNI",100,0)
 E  W !!,"REPORT COMPLETED.  TOTAL MISMATCHES FOUND:  ",GRANDTOT
"RTN","PRSA8BNI",101,0)
 W !,"================================================================="
"RTN","PRSA8BNI",102,0)
 N TXT,I
"RTN","PRSA8BNI",103,0)
 W !
"RTN","PRSA8BNI",104,0)
 F I=1:1 S TXT=$P($T(ALLFT+I),";",3) Q:TXT=""  W !,TXT
"RTN","PRSA8BNI",105,0)
 I DAILYHRS D
"RTN","PRSA8BNI",106,0)
 .  F I=1:1 S TXT=$P($T(DAILYFT+I),";",3) Q:TXT=""  W !,TXT
"RTN","PRSA8BNI",107,0)
 S OUT=$$ASK^PRSLIB00(1)
"RTN","PRSA8BNI",108,0)
 Q
"RTN","PRSA8BNI",109,0)
ALLFT ;;
"RTN","PRSA8BNI",110,0)
 ;;                   FOOTNOTES TO REPORT HEADINGS
"RTN","PRSA8BNI",111,0)
 ;;                   ============================
"RTN","PRSA8BNI",112,0)
 ;;*ToD HRS (Tour of Duty Hours) The total Tour of Duty hours that fall within the
"RTN","PRSA8BNI",113,0)
 ;;--------  two week pay period, beginning midnight Saturday.  Hours that cross 
"RTN","PRSA8BNI",114,0)
 ;;          midnight from a tour that starts on the last day of a pay period will
"RTN","PRSA8BNI",115,0)
 ;;          appear on the following pay period.
"RTN","PRSA8BNI",116,0)
 ;;.....................................................................
"RTN","PRSA8BNI",117,0)
DAILYFT ;;
"RTN","PRSA8BNI",118,0)
 ;;*Hours   (DAILY TOUR HOURS) This column contains actual tour hours that fall
"RTN","PRSA8BNI",119,0)
 ;;------    on that day from the 24 hour period beginning at midnight.  A two day
"RTN","PRSA8BNI",120,0)
 ;;          tour will contribute hours to each day the tour falls on.  Hours 
"RTN","PRSA8BNI",121,0)
 ;;          that cross midnight from a tour that starts on the last day of a pay
"RTN","PRSA8BNI",122,0)
 ;;          period will appear on the following pay period.
"RTN","PRSA8BNI",123,0)
 ;;.....................................................................
"RTN","PRSA8BNI",124,0)
 ;;*ToD #   (Tour of Duty Number)
"RTN","PRSA8BNI",125,0)
 ;;------
"RTN","PRSA8BNI",126,0)
 ;;.....................................................................
"RTN","PRSAPPH")
0^2^B20434653^B20434653
"RTN","PRSAPPH",1,0)
PRSAPPH ; WOIFO/JAH - Holiday Utilities ;12/07/07
"RTN","PRSAPPH",2,0)
 ;;4.0;PAID;**33,66,113,112,116**;Sep 21, 1995;Build 23
"RTN","PRSAPPH",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRSAPPH",4,0)
 K HOL S PDT=$G(^PRST(458,PPI,1)) Q:PDT=""  S X1=$P(PDT,"^",1),X2=-6 D C^%DTC
"RTN","PRSAPPH",5,0)
 S PRS8D=X D EN^PRS8HD
"RTN","PRSAPPH",6,0)
 S PDH=PRS8D F DAY=1:1:25 S X1=PRS8D,X2=DAY D C^%DTC S PDH=PDH_"^"_X
"RTN","PRSAPPH",7,0)
 F DAY=1:1:26 S Z=$P(PDH,"^",DAY) I $D(HD(Z)) S HOL(Z)=$S(DAY<7:-DAY,1:DAY-6)
"RTN","PRSAPPH",8,0)
 K HO,HD,PRS8D,PDH Q
"RTN","PRSAPPH",9,0)
E ; Set Holidays for Employees
"RTN","PRSAPPH",10,0)
 S FLX=$P($G(^PRST(458,PPI,"E",DFN,0)),"^",6),DB=$P($G(^PRSPC(DFN,0)),"^",10)
"RTN","PRSAPPH",11,0)
 S NH=$P($G(^PRSPC(DFN,0)),"^",16) Q:NH>80
"RTN","PRSAPPH",12,0)
 F LLL=0:0 S LLL=$O(HOL(LLL)) Q:LLL<1  S DAY=HOL(LLL) D E0
"RTN","PRSAPPH",13,0)
 Q
"RTN","PRSAPPH",14,0)
E0 ; Find Benefit Day
"RTN","PRSAPPH",15,0)
 Q:DAY=15  I DAY>0,DAY<15 G P0
"RTN","PRSAPPH",16,0)
 Q:DB'=1  Q:NH=48!(NH=72)  G P1:DAY<0,P3:DAY>14
"RTN","PRSAPPH",17,0)
P0 S TC=$P($G(^PRST(458,PPI,"E",DFN,"D",DAY,0)),"^",2) Q:'TC
"RTN","PRSAPPH",18,0)
 I (TC=3)!(TC=4) G U1
"RTN","PRSAPPH",19,0)
 I DB=1,NH=48 G U1
"RTN","PRSAPPH",20,0)
 S C=0
"RTN","PRSAPPH",21,0)
 I TC=2!$P($G(^PRST(458,PPI,"E",DFN,"D",DAY,0)),"^",8)!$P($G(^(0)),"^",14),'$P($G(^(0)),"^",12) G S0
"RTN","PRSAPPH",22,0)
 Q:$P($G(^(0)),"^",12)=LLL&(TT="HX") 
"RTN","PRSAPPH",23,0)
 G U1:DB=2!(NH=72) I FLX'="C" G EF:(DAY#7=1),EB:(DAY#7=0)
"RTN","PRSAPPH",24,0)
 S C=0 F X1=$S(DAY<8:1,1:8):1:DAY I '$P($G(^PRST(458,PPI,"E",DFN,"D",X1,0)),"^",8),'$P($G(^(0)),"^",14) S C=C+1
"RTN","PRSAPPH",25,0)
 I FLX'="C" G EF:C<2,EB
"RTN","PRSAPPH",26,0)
 I C'=2 G EF:C<3,EB
"RTN","PRSAPPH",27,0)
 I DAY#7 F X1=DAY+1:1:$S(DAY<8:7,1:14) I '$P($G(^PRST(458,PPI,"E",DFN,"D",X1,0)),"^",8),'$P($G(^(0)),"^",14) S C=C+1
"RTN","PRSAPPH",28,0)
 G EB:C=2,EF
"RTN","PRSAPPH",29,0)
 ;
"RTN","PRSAPPH",30,0)
 ;if looking forward, don't set off for another holiday
"RTN","PRSAPPH",31,0)
 ;
"RTN","PRSAPPH",32,0)
EF F DAY=DAY+1:1:14 S TC=$P($G(^PRST(458,PPI,"E",DFN,"D",DAY,0)),"^",2) Q:TC=""  I TC=2!$P($G(^(0)),"^",8)!$P($G(^(0)),"^",14),'$$FUTRHOL(),$$PREVSET() G S0
"RTN","PRSAPPH",33,0)
 Q
"RTN","PRSAPPH",34,0)
 ;
"RTN","PRSAPPH",35,0)
FUTRHOL() ;Check to see if day is another future holiday.
"RTN","PRSAPPH",36,0)
 Q $G(HOL($P($G(^PRST(458,PPI,1)),"^",DAY)))>0
"RTN","PRSAPPH",37,0)
PREVSET() ; Day NOT Already Set as holiday
"RTN","PRSAPPH",38,0)
 Q ('($P($G(^PRST(458,PPI,"E",DFN,"D",DAY,0)),"^",12)>0)!($P($G(^(0)),"^",12)=LLL))
"RTN","PRSAPPH",39,0)
 ;
"RTN","PRSAPPH",40,0)
 ;back up to find an available day to set the Holiday.
"RTN","PRSAPPH",41,0)
EB F DAY=DAY-1:-1:1 S TC=$P($G(^PRST(458,PPI,"E",DFN,"D",DAY,0)),"^",2) Q:TC=""  I $$PREVSET(),TC=2!$P($G(^(0)),"^",8)!$P($G(^(0)),"^",14) G S0
"RTN","PRSAPPH",42,0)
 Q
"RTN","PRSAPPH",43,0)
 ;
"RTN","PRSAPPH",44,0)
P1 I FLX'="C" Q:DAY'=-5  S C=13 D PF Q:'Z  S DAY=0 G EF
"RTN","PRSAPPH",45,0)
 S C=8-DAY D PF Q:'Z
"RTN","PRSAPPH",46,0)
 S DAY=8-DAY,C=0 F X1=8:1:DAY I '$P($G(^PRST(458,PPI-1,"E",DFN,"D",X1,0)),"^",8),'$P($G(^(0)),"^",14) S C=C+1
"RTN","PRSAPPH",47,0)
 Q:C>2  I C<2 S DAY=0 G EF
"RTN","PRSAPPH",48,0)
 I DAY<14 F X1=DAY+1:1:14 I '$P($G(^PRST(458,PPI-1,"E",DFN,"D",X1,0)),"^",8),'$P($G(^(0)),"^",14) S C=C+1
"RTN","PRSAPPH",49,0)
 Q:C=2  S DAY=0 G EF
"RTN","PRSAPPH",50,0)
P3 I FLX'="C" Q:DAY'=16  S C=2 D PN Q:'Z  S DAY=15 G EB
"RTN","PRSAPPH",51,0)
 Q:DAY=15  S C=DAY-14 D PN Q:'Z  I DAY>16 S DAY=15 G EB
"RTN","PRSAPPH",52,0)
 S C=2 F L1=3:1:7 D
"RTN","PRSAPPH",53,0)
 .S X1=$G(^PRST(458,PPI+1,"E",DFN,"D",L1,0)) I X1'="" S:$P(X1,"^",8)+$P(X1,"^",14)=0 C=C+1 Q
"RTN","PRSAPPH",54,0)
 .S X1=$P($G(^PRST(458,PPI,"E",DFN,"D",L1,0)),"^",2,4) I $P(X1,"^",3),$P(X1,"^",4) S X1=$P(X1,"^",4)
"RTN","PRSAPPH",55,0)
 .S:'$P($G(^PRST(457.1,+X1,0)),"^",6) C=C+1 Q
"RTN","PRSAPPH",56,0)
 Q:C>2  S DAY=15 G EB
"RTN","PRSAPPH",57,0)
PN ; Determine TC for next Pay Period; if Z=1 then all TC=1 for days 1 to C
"RTN","PRSAPPH",58,0)
 S Z=1 F C=C:-1:1 D  Q:'Z
"RTN","PRSAPPH",59,0)
 .S X1=$P($G(^PRST(458,PPI+1,"E",DFN,"D",C,0)),"^",2) I X1=2 S Z=0 Q
"RTN","PRSAPPH",60,0)
 .I X1'="" S X1=$P($G(^PRST(458,PPI+1,"E",DFN,"D",C,0)),"^",8)+$P($G(^(0)),"^",14) S:X1 Z=0 Q
"RTN","PRSAPPH",61,0)
 .S X1=$P($G(^PRST(458,PPI,"E",DFN,"D",C,0)),"^",2,4) I $P(X1,"^",2),$P(X1,"^",3) S X1=$P(X1,"^",3)
"RTN","PRSAPPH",62,0)
 .S X1=+X1 I X1=0!(X1=2) S Z=0 Q
"RTN","PRSAPPH",63,0)
 .S:$P($G(^PRST(457.1,X1,0)),"^",6) Z=0 Q
"RTN","PRSAPPH",64,0)
 Q
"RTN","PRSAPPH",65,0)
PF ; Determine TC for prior PP
"RTN","PRSAPPH",66,0)
 S Z=1 F C=C:1:14 D  Q:'Z
"RTN","PRSAPPH",67,0)
 .S X1=$P($G(^PRST(458,PPI-1,"E",DFN,"D",C,0)),"^",2) I X1=""!(X1=2) S Z=0 Q
"RTN","PRSAPPH",68,0)
 .S X1=$P($G(^PRST(458,PPI-1,"E",DFN,"D",C,0)),"^",8)+$P($G(^(0)),"^",14) S:X1 Z=0 Q
"RTN","PRSAPPH",69,0)
 Q
"RTN","PRSAPPH",70,0)
S0 ; Set Holiday (Excused or Worked)
"RTN","PRSAPPH",71,0)
 I TT="HX",$P($G(^PRST(458,PPI,"E",DFN,"D",DAY,0)),"^",12)=LLL Q
"RTN","PRSAPPH",72,0)
 S Z=$G(^PRST(458,PPI,"E",DFN,"D",DAY,1)) I Z="" S $P(^(2),"^",3)=TT Q:TT="HW"  G UPD
"RTN","PRSAPPH",73,0)
 S ZS=$G(^PRST(458,PPI,"E",DFN,"D",DAY,4)) I ZS'="" D FND
"RTN","PRSAPPH",74,0)
 S ZS="",L1=1 F K=1:3:19 Q:$P(Z,"^",K)=""  D
"RTN","PRSAPPH",75,0)
 .I $P(Z,"^",K+2),"RG"'[$P($G(^PRST(457.2,+$P(Z,"^",K+2),0)),"^",2) Q
"RTN","PRSAPPH",76,0)
 .S $P(ZS,"^",L1)=$P(Z,"^",K),$P(ZS,"^",L1+1)=$P(Z,"^",K+1)
"RTN","PRSAPPH",77,0)
 .S $P(ZS,"^",L1+2)=TT S L1=L1+4 Q
"RTN","PRSAPPH",78,0)
 S:ZS'="" ^PRST(458,PPI,"E",DFN,"D",DAY,2)=ZS Q:TT="HW"  G:'DUP UPD
"RTN","PRSAPPH",79,0)
 ; Remove holiday on another day
"RTN","PRSAPPH",80,0)
 S K=PPI F L1=$S(DAY-8>0:DAY-8,1:1):1:$S(DAY+8<15:DAY+8,1:14) I $P($G(^PRST(458,K,"E",DFN,"D",L1,0)),"^",12)=LLL D REM
"RTN","PRSAPPH",81,0)
 I DAY<9 S K=PPI-1 F L1=(DAY+6):1:14 I $P($G(^PRST(458,K,"E",DFN,"D",L1,0)),"^",12)=LLL D REM
"RTN","PRSAPPH",82,0)
 I DAY>6 S K=PPI+1 F L1=1:1:(DAY-6) I $P($G(^PRST(458,K,"E",DFN,"D",L1,0)),"^",12)=LLL D REM
"RTN","PRSAPPH",83,0)
UPD ; Update status
"RTN","PRSAPPH",84,0)
 S $P(^PRST(458,PPI,"E",DFN,"D",DAY,10),"^",1,4)="T^"_DUZ_"^"_NOW_"^2"
"RTN","PRSAPPH",85,0)
U1 ; Mark as Holiday
"RTN","PRSAPPH",86,0)
 S $P(^PRST(458,PPI,"E",DFN,"D",DAY,0),"^",12)=LLL Q
"RTN","PRSAPPH",87,0)
REM ; Remove posting for moved holiday
"RTN","PRSAPPH",88,0)
 I $P($G(^PRST(458,K,"E",DFN,0)),"^",2)'="T" Q
"RTN","PRSAPPH",89,0)
 S $P(^PRST(458,K,"E",DFN,"D",L1,0),"^",12)=""
"RTN","PRSAPPH",90,0)
 S ZS=$G(^PRST(458,K,"E",DFN,"D",L1,2)) Q:ZS=""
"RTN","PRSAPPH",91,0)
 I ZS["HX"!(ZS["HW") K ^PRST(458,K,"E",DFN,"D",L1,2),^(3),^(10)
"RTN","PRSAPPH",92,0)
 Q
"RTN","PRSAPPH",93,0)
FND ; Determine which tour is first
"RTN","PRSAPPH",94,0)
 N X,Y S X=$P(Z,"^",1),Y=0 D MIL^PRSATIM S K=Y
"RTN","PRSAPPH",95,0)
 S X=$P(ZS,"^",1),Y=0 D MIL^PRSATIM S:Y<K Z=ZS Q
"RTN","PRSAPPH",96,0)
 Q
"RTN","PRSARC07")
0^6^B48614564^B43840543
"RTN","PRSARC07",1,0)
PRSARC07 ;WOIFO/JAH - Tour Hours Procedure ;01/07/08
"RTN","PRSARC07",2,0)
 ;;4.0;PAID;**112,116**;Sep 21, 1995;Build 23
"RTN","PRSARC07",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRSARC07",4,0)
 Q
"RTN","PRSARC07",5,0)
 ;
"RTN","PRSARC07",6,0)
TOURHRS(THRARY,PPI,PRSIEN,TOURSTR) ; Return data for TOUR OF DUTY
"RTN","PRSARC07",7,0)
 ;Input:
"RTN","PRSARC07",8,0)
 ;  PPI (optional) IEN of #458 otherwise curr PPI assumed.
"RTN","PRSARC07",9,0)
 ;    *If PPI and TOURSTR (or only PPI) defined then last pay period
"RTN","PRSARC07",10,0)
 ;     spill over from 2nd sat. is added to day 1.
"RTN","PRSARC07",11,0)
 ;    *If TOURSTR is defined but not PPI then tour hours
"RTN","PRSARC07",12,0)
 ;     from 2nd saturday of tour in TOURSTR are placed on 1st Sunday.
"RTN","PRSARC07",13,0)
 ;
"RTN","PRSARC07",14,0)
 ;  PRSIEN (required) IEN-File (#450). 
"RTN","PRSARC07",15,0)
 ;  TOURSTR (optional) if defined should contain 14 piece string
"RTN","PRSARC07",16,0)
 ;          delimited by "^" pieces 1-14 contain pointers
"RTN","PRSARC07",17,0)
 ;          to ToD file. Will be used instead of pp to determine
"RTN","PRSARC07",18,0)
 ;          tour hrs.
"RTN","PRSARC07",19,0)
 ; Output
"RTN","PRSARC07",20,0)
 ;  THRARY (TOUR HRS ARRAY)-2 piece array subsc by day #.
"RTN","PRSARC07",21,0)
 ;     W1 & W2 node w/ wkly tour hrs.
"RTN","PRSARC07",22,0)
 ;    Piece one = Shift code:
"RTN","PRSARC07",23,0)
 ;      -Null when no tour hrs fall on that day.
"RTN","PRSARC07",24,0)
 ;      -Always 0 for Wage Grades
"RTN","PRSARC07",25,0)
 ;      -1, 2, or 3 corresponds to earliest shift on day being reported.
"RTN","PRSARC07",26,0)
 ;    Piece two = total hrs for tours that fall on each day.
"RTN","PRSARC07",27,0)
 ;       Tours crossing midnight--hrs placed in node on day the occur
"RTN","PRSARC07",28,0)
 ;    SPECIAL CASE: COMPRESSED TOURS: "CT" node is defined
"RTN","PRSARC07",29,0)
 ;      Piece one set to shift (earliest for pp or 0 for wage)
"RTN","PRSARC07",30,0)
 ;      Piece 2 = total pp hrs 
"RTN","PRSARC07",31,0)
 ;
"RTN","PRSARC07",32,0)
 ;    Error Codes = ARRAY VARIABLE contains a 1 for success or 0 for
"RTN","PRSARC07",33,0)
 ;       failure.  If failed then error codes returned in Array 0 node
"RTN","PRSARC07",34,0)
 ;         1 = pp undef
"RTN","PRSARC07",35,0)
 ;         2 = emp undef
"RTN","PRSARC07",36,0)
 ;         3 = no timecard for emp in pp
"RTN","PRSARC07",37,0)
 ; Example
"RTN","PRSARC07",38,0)
 ; >D TOURHRS^PRSARC04(.THRS,257,12711)
"RTN","PRSARC07",39,0)
 ; >ZW THRS
"RTN","PRSARC07",40,0)
 ; THRS=1
"RTN","PRSARC07",41,0)
 ; THRS(1)=^0
"RTN","PRSARC07",42,0)
 ; THRS(2)=1^3
"RTN","PRSARC07",43,0)
 ; THRS(3)=1^6
"RTN","PRSARC07",44,0)
 ; ...
"RTN","PRSARC07",45,0)
 ; THRS(14)=^0
"RTN","PRSARC07",46,0)
 N SHIFTCD,ISWAGE,ZNODE,PRSD,SAT,LASTPPI
"RTN","PRSARC07",47,0)
 K THRARY
"RTN","PRSARC07",48,0)
 I '$D(^PRSPC(+$G(PRSIEN),0)) S THRARY=0,THRARY(0)="2^undefined employee"
"RTN","PRSARC07",49,0)
 I $G(TOURSTR)="" D
"RTN","PRSARC07",50,0)
 .  I $G(PPI)'>0 S PPI=$P(^PRST(458,0),"^",3)
"RTN","PRSARC07",51,0)
 .  I '$D(^PRST(458,+$G(PPI),0)) S THRARY=0,THRARY(0)="1^undefined pay period"
"RTN","PRSARC07",52,0)
 .  S LASTPPI=PPI-1
"RTN","PRSARC07",53,0)
 .  S ISWAGE=$$ISWAGE^PRSARC08(PRSIEN)
"RTN","PRSARC07",54,0)
 . ;
"RTN","PRSARC07",55,0)
 . ; Get ToD and Second ToD from last saturday of 
"RTN","PRSARC07",56,0)
 . ; prior PP to check for spill over hrs onto day 1 of this PP.
"RTN","PRSARC07",57,0)
 . S SAT=$G(^PRST(458,LASTPPI,"E",PRSIEN,"D",14,0))
"RTN","PRSARC07",58,0)
 . S PRSD=0,T1=$P(SAT,U,2),T2=$P(SAT,U,13)
"RTN","PRSARC07",59,0)
 . D PLACEHRS(.THRARY,PRSIEN,PRSD,T1,T2,LASTPPI)
"RTN","PRSARC07",60,0)
 . F PRSD=1:1:14 D
"RTN","PRSARC07",61,0)
 ..   S ZNODE=$G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,0))
"RTN","PRSARC07",62,0)
 ..   S T1=$P(ZNODE,U,2),T2=$P(ZNODE,U,13)
"RTN","PRSARC07",63,0)
 ..   D PLACEHRS(.THRARY,PRSIEN,PRSD,T1,T2,PPI)
"RTN","PRSARC07",64,0)
 ..   D PLACESHF(.THRARY,PRSD,T1,T2,ISWAGE)
"RTN","PRSARC07",65,0)
 .;
"RTN","PRSARC07",66,0)
 .; add compressed tour node if necessary
"RTN","PRSARC07",67,0)
 .I $$ISCMPTR^PRSARC08(PPI,PRSIEN) S THRARY("CT")=$$EARLYSH^PRSARC08(.THRARY,ISWAGE)_"^"_$$TOTAL^PRSARC08(.THRARY)
"RTN","PRSARC07",68,0)
 E  D
"RTN","PRSARC07",69,0)
 .; use tourstring for tours
"RTN","PRSARC07",70,0)
 .; add prior tour spillover from 2nd Sat to first Sun
"RTN","PRSARC07",71,0)
 . I $G(PPI)>0 D
"RTN","PRSARC07",72,0)
 ..   S SAT=$G(^PRST(458,PPI-1,"E",PRSIEN,"D",14,0))
"RTN","PRSARC07",73,0)
 ..   S PRSD=0,T1=$P(SAT,U,2),T2=$P(SAT,U,13)
"RTN","PRSARC07",74,0)
 ..   D PLACEHRS(.THRARY,PRSIEN,PRSD,T1,T2,PPI)
"RTN","PRSARC07",75,0)
 . F PRSD=1:1:14 D
"RTN","PRSARC07",76,0)
 ..   S T1=$P(TOURSTR,U,PRSD),T2=""
"RTN","PRSARC07",77,0)
 ..   D PLACEHRS(.THRARY,PRSIEN,PRSD,T1,T2,PPI)
"RTN","PRSARC07",78,0)
 . ; wrap second saturday to first sunday (IF PPI NOT PASSED)
"RTN","PRSARC07",79,0)
 . I $G(PPI)="" S $P(THRARY(1),U,2)=$P(THRARY(1),U,2)+$P($G(THRARY(15)),U,2)
"RTN","PRSARC07",80,0)
 ; Prior Sat THRARY(0) only needed temp to get any part of a two day 
"RTN","PRSARC07",81,0)
 ; tour that spilled onto THRARY(1)-1st Sun. Next Sun THRARY(15) is 
"RTN","PRSARC07",82,0)
 ; only an artifact.
"RTN","PRSARC07",83,0)
 S THRARY("W1")=$$TOTAL^PRSARC08(.THRARY,1)
"RTN","PRSARC07",84,0)
 S THRARY("W2")=$$TOTAL^PRSARC08(.THRARY,2)
"RTN","PRSARC07",85,0)
 K THRARY(0),THRARY(15)
"RTN","PRSARC07",86,0)
 Q
"RTN","PRSARC07",87,0)
 ;
"RTN","PRSARC07",88,0)
PLACEHRS(PRSTH,PRSIEN,PRSD,T1,T2,PPI) ; procedure puts hrs from tours on current 
"RTN","PRSARC07",89,0)
 ; day and next.  called once for each day so a call for curr day 
"RTN","PRSARC07",90,0)
 ; may have hrs from prior two day tour
"RTN","PRSARC07",91,0)
 ;
"RTN","PRSARC07",92,0)
 N CURHRS,CURSHFT,TODAYND,TOMORND,TODHRS,TOMHRS,TOURHRS
"RTN","PRSARC07",93,0)
 S TODAYND=$G(PRSTH(PRSD))
"RTN","PRSARC07",94,0)
 S TOMORND=$G(PRSTH(PRSD+1))
"RTN","PRSARC07",95,0)
 S TODHRS=$P(TODAYND,U,2)
"RTN","PRSARC07",96,0)
 S TOMHRS=$P(TOMORND,U,2)
"RTN","PRSARC07",97,0)
 ;
"RTN","PRSARC07",98,0)
 ; get tour 1 hrs-add to today, tomorrow
"RTN","PRSARC07",99,0)
 I T1>0 D
"RTN","PRSARC07",100,0)
 .  S TOURHRS=$$TRHRS(1,PRSD,PRSIEN,T1,PPI)
"RTN","PRSARC07",101,0)
 .  S TODHRS=TODHRS+$P(TOURHRS,U)
"RTN","PRSARC07",102,0)
 .  S TOMHRS=TOMHRS+$P(TOURHRS,U,2)
"RTN","PRSARC07",103,0)
 ;
"RTN","PRSARC07",104,0)
 ; get tour 2 hrs-add to today, tomorrow
"RTN","PRSARC07",105,0)
 I T2>0 D
"RTN","PRSARC07",106,0)
 .  S TOURHRS=$$TRHRS(2,PRSD,PRSIEN,T2,PPI)
"RTN","PRSARC07",107,0)
 .  S TODHRS=TODHRS+$P(TOURHRS,U)
"RTN","PRSARC07",108,0)
 .  S TOMHRS=TOMHRS+$P(TOURHRS,U,2)
"RTN","PRSARC07",109,0)
 ;
"RTN","PRSARC07",110,0)
 ; add tour hrs to array
"RTN","PRSARC07",111,0)
 S $P(PRSTH(PRSD),U,2)=TODHRS
"RTN","PRSARC07",112,0)
 ;
"RTN","PRSARC07",113,0)
 ; add hrs to day node of array 
"RTN","PRSARC07",114,0)
 ;   (2 day tour hrs past midnight on last Sat. go in node 15)
"RTN","PRSARC07",115,0)
 ;
"RTN","PRSARC07",116,0)
 S $P(PRSTH(PRSD+1),U,2)=TOMHRS
"RTN","PRSARC07",117,0)
 Q
"RTN","PRSARC07",118,0)
TRHRS(TNUM,PRSD,PRSIEN,TOURIEN,PPI) ; return string w/ todays hrs p1 ^ tomorrows hrs p2
"RTN","PRSARC07",119,0)
 ;
"RTN","PRSARC07",120,0)
 N TODHR,TOMHR,TOUR,TSEGS,TWODAYTR,REGHRS,DONE,CROSS,BEG,END,MEALTIME
"RTN","PRSARC07",121,0)
 N BEG24,END24,SEGTIME,SEGTOD,SEGTOM,I,SPECIND
"RTN","PRSARC07",122,0)
 ;
"RTN","PRSARC07",123,0)
 S TODHR=0,TOMHR=0
"RTN","PRSARC07",124,0)
 I $G(TOURIEN)'>0 Q TODHR_"^"_TOMHR
"RTN","PRSARC07",125,0)
 S TOUR=$G(^PRST(457.1,TOURIEN,0))
"RTN","PRSARC07",126,0)
 I TNUM=1 S TSEGS=$G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,1))
"RTN","PRSARC07",127,0)
 I TNUM=2 S TSEGS=$G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,4))
"RTN","PRSARC07",128,0)
 I TSEGS="" S TSEGS=$G(^PRST(457.1,TOURIEN,1))
"RTN","PRSARC07",129,0)
 S TWODAYTR=$P(TOUR,U,5)="Y"
"RTN","PRSARC07",130,0)
 S MEALTIME=$P(TOUR,U,3)
"RTN","PRSARC07",131,0)
 I TNUM=1 S REGHRS=$P($G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,0)),U,8)
"RTN","PRSARC07",132,0)
 I TNUM=2 S REGHRS=$P($G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,0)),U,14)
"RTN","PRSARC07",133,0)
 I REGHRS'>0 S REGHRS=$P(TOUR,U,6)
"RTN","PRSARC07",134,0)
 I TWODAYTR D
"RTN","PRSARC07",135,0)
 .  S (DONE,CROSS)=0
"RTN","PRSARC07",136,0)
 .  F I=1:3:19 D  Q:DONE
"RTN","PRSARC07",137,0)
 ..    S BEG=$P(TSEGS,U,I)
"RTN","PRSARC07",138,0)
 ..    I BEG="" S DONE=1 Q
"RTN","PRSARC07",139,0)
 ..    S END=$P(TSEGS,U,I+1)
"RTN","PRSARC07",140,0)
 ..    S SPECIND=$P(TSEGS,U,I+2)
"RTN","PRSARC07",141,0)
 ..;   only count regular hours
"RTN","PRSARC07",142,0)
 ..    I SPECIND,"RG"'[$P($G(^PRST(457.2,+SPECIND,0)),"^",2) Q
"RTN","PRSARC07",143,0)
 ..;  convert beg & end to 24 hr to check if one < other (Xes midnight)
"RTN","PRSARC07",144,0)
 ..;  also crossed midnight if not first seg starts at midnight.
"RTN","PRSARC07",145,0)
 ..;  CROSS is true so remaining segments recorded to tomorrow.
"RTN","PRSARC07",146,0)
 ..    S BEG24=$$TWENTY4^PRSPESR2(BEG)
"RTN","PRSARC07",147,0)
 ..    S END24=$$TWENTY4^PRSPESR2(END)
"RTN","PRSARC07",148,0)
 ..    I 'CROSS&(((BEG24'<END24)&(BEG24'=2400))!((I>1)&(BEG24=2400))) D
"RTN","PRSARC07",149,0)
 ...     S CROSS=1
"RTN","PRSARC07",150,0)
 ...     S SEGTOD=$S(BEG24=2400:0,1:$$AMT^PRSPSAPU(BEG,"MID",0))
"RTN","PRSARC07",151,0)
 ...     S SEGTOM=$$AMT^PRSPSAPU("MID",END,0)
"RTN","PRSARC07",152,0)
 ...     S TODHR=TODHR+SEGTOD
"RTN","PRSARC07",153,0)
 ...     S TOMHR=TOMHR+SEGTOM
"RTN","PRSARC07",154,0)
 ..    E  D
"RTN","PRSARC07",155,0)
 ...     S SEGTIME=$$AMT^PRSPSAPU(BEG,END,0)
"RTN","PRSARC07",156,0)
 ...     I CROSS D
"RTN","PRSARC07",157,0)
 ....      S TOMHR=TOMHR+SEGTIME
"RTN","PRSARC07",158,0)
 ...     E  D
"RTN","PRSARC07",159,0)
 ....      S TODHR=TODHR+SEGTIME
"RTN","PRSARC07",160,0)
 . ;Pull meal off hrs for today, tomorrow or both.
"RTN","PRSARC07",161,0)
 . N HOURS S HOURS=$$PLACEML^PRSARC08(TODHR,TOMHR,MEALTIME)
"RTN","PRSARC07",162,0)
 . S TODHR=$P(HOURS,U)
"RTN","PRSARC07",163,0)
 . S TOMHR=$P(HOURS,U,2)
"RTN","PRSARC07",164,0)
 E  D
"RTN","PRSARC07",165,0)
 .  S TODHR=REGHRS
"RTN","PRSARC07",166,0)
 Q TODHR_"^"_TOMHR
"RTN","PRSARC07",167,0)
 ;
"RTN","PRSARC07",168,0)
PLACESHF(PRSTH,PRSD,T1,T2,WAGER) ;Place earliest shift from
"RTN","PRSARC07",169,0)
 ; tour 1 and tour 2 in SDA Tour array (PRSTH)
"RTN","PRSARC07",170,0)
 ;INPUT:
"RTN","PRSARC07",171,0)
 ;  PRSTH - array to store SDA tour info p1=shift, p2=tour hrs.
"RTN","PRSARC07",172,0)
 ;  PRSD - day number in pp 1-14
"RTN","PRSARC07",173,0)
 ;  T1, T2 - tour 1 and 2 (ien in ToD file)
"RTN","PRSARC07",174,0)
 ;  WAGER - 0 or 1 for whether this is a wage grade employee.
"RTN","PRSARC07",175,0)
 ;OUTPUT:
"RTN","PRSARC07",176,0)
 ;  PRSTH by reference.  Update "^" piece 1 with shift indicator
"RTN","PRSARC07",177,0)
 ;
"RTN","PRSARC07",178,0)
 N SHIFT,T1SHFTS,T2SHFTS,SHIFTINI,EARLIEST,SHIFT2
"RTN","PRSARC07",179,0)
 ;
"RTN","PRSARC07",180,0)
 ; Wage grade always have a 0 for shift
"RTN","PRSARC07",181,0)
 I WAGER D
"RTN","PRSARC07",182,0)
 .  S $P(PRSTH(PRSD),U)=0
"RTN","PRSARC07",183,0)
 E  D 
"RTN","PRSARC07",184,0)
 .  S T1SHFTS=$$TRSHFTS^PRSARC08(T1) ; get tour 1 shift for today and tomorrow
"RTN","PRSARC07",185,0)
 .  S T2SHFTS=$$TRSHFTS^PRSARC08(T2) ; and tour 2
"RTN","PRSARC07",186,0)
 .;  Get any shift placed by a two day tour from yesterday.
"RTN","PRSARC07",187,0)
 .;  Then find earliest shift from t1, t2 and two day carryover
"RTN","PRSARC07",188,0)
 .  S SHIFTINI=$P($G(PRSTH(PRSD)),U) I SHIFTINI="" S SHIFTINI=4
"RTN","PRSARC07",189,0)
 .  S SHIFT=$P(T1SHFTS,U) I SHIFT="" S SHIFT=4
"RTN","PRSARC07",190,0)
 .  S SHIFT2=$P(T2SHFTS,U) I SHIFT2="" S SHIFT2=4
"RTN","PRSARC07",191,0)
 .  S EARLIEST=SHIFTINI
"RTN","PRSARC07",192,0)
 .  I SHIFT<SHIFTINI S EARLIEST=SHIFT
"RTN","PRSARC07",193,0)
 .  I SHIFT2<EARLIEST S EARLIEST=SHIFT2
"RTN","PRSARC07",194,0)
 .  I EARLIEST=4 S EARLIEST=""
"RTN","PRSARC07",195,0)
 .  S $P(PRSTH(PRSD),U)=EARLIEST
"RTN","PRSARC07",196,0)
 . ;
"RTN","PRSARC07",197,0)
 . ; Now do anything for tomorrow
"RTN","PRSARC07",198,0)
 .  S SHIFTINI=$P($G(PRSTH(PRSD+1)),U,1) I SHIFTINI="" S SHIFTINI=4
"RTN","PRSARC07",199,0)
 .  S SHIFT=$P(T1SHFTS,U,2) I SHIFT="" S SHIFT=4
"RTN","PRSARC07",200,0)
 .  S SHIFT2=$P(T2SHFTS,U,2) I SHIFT2="" S SHIFT2=4
"RTN","PRSARC07",201,0)
 .  S EARLIEST=SHIFTINI
"RTN","PRSARC07",202,0)
 .  I SHIFT<SHIFTINI S EARLIEST=SHIFT
"RTN","PRSARC07",203,0)
 .  I SHIFT2<EARLIEST S EARLIEST=SHIFT2
"RTN","PRSARC07",204,0)
 .  I EARLIEST=4 S EARLIEST=""
"RTN","PRSARC07",205,0)
 .  S $P(PRSTH(PRSD+1),U)=EARLIEST
"RTN","PRSARC07",206,0)
 Q
"RTN","PRSARC07",207,0)
 ;
"RTN","PRSASR1")
0^4^B49700773^B49767232
"RTN","PRSASR1",1,0)
PRSASR1 ;WCIOFO/JAH - Display VCS, Fee, ED ;02/20/08
"RTN","PRSASR1",2,0)
 ;;4.0;PAID;**6,21,82,93,116**;Sep 21, 1995;Build 23
"RTN","PRSASR1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRSASR1",4,0)
VCS ; Display VCS Sales/Fee Basis
"RTN","PRSASR1",5,0)
 ;
"RTN","PRSASR1",6,0)
 N OLDPP
"RTN","PRSASR1",7,0)
 S PAYP=$P($G(^PRSPC(DFN,0)),"^",21)
"RTN","PRSASR1",8,0)
 ; Check the pay plan for the pay period we are dealing with
"RTN","PRSASR1",9,0)
 ; in case it's a previous pay period where an employee
"RTN","PRSASR1",10,0)
 ; had a different pay plan.
"RTN","PRSASR1",11,0)
 ;  1st put pay period in YY-PP format 4 call 2 lookup old pay plan.
"RTN","PRSASR1",12,0)
 ;Only check if called from option Display employee pay period PPERIOD
"RTN","PRSASR1",13,0)
 ;will be defined.
"RTN","PRSASR1",14,0)
 I $G(PPERIOD) D
"RTN","PRSASR1",15,0)
 .;S PPERIOD=$S(Y["-":$P(Y,"^",2),1:$P(^PRST(458,$P(Y,"^"),0),"^"))
"RTN","PRSASR1",16,0)
 .S OLDPP=$$OLDPP^PRS8UT(PPERIOD,DFN)
"RTN","PRSASR1",17,0)
 .I OLDPP'=0,(OLDPP'=PAYP) D
"RTN","PRSASR1",18,0)
 .. S PAYP=OLDPP
"RTN","PRSASR1",19,0)
 .. W !,"Employee is NOT currently under this pay plan."
"RTN","PRSASR1",20,0)
 ;
"RTN","PRSASR1",21,0)
 W !!?30,$S(PAYP="F":"Fee Basis Appointee",1:"VCS Commission Sales")
"RTN","PRSASR1",22,0)
 W !!?13,"Sun       Mon       Tue       Wed       Thu       Fri       Sat",!
"RTN","PRSASR1",23,0)
 W !,"Week 1" S L1=1 F K=1:1:7 S L1=L1+10,Z1=$P(Z,"^",K) I Z1'="" W ?L1,$J(Z1,7,2)
"RTN","PRSASR1",24,0)
 W !,"Week 2" S L1=1 F K=8:1:14 S L1=L1+10,Z1=$P(Z,"^",K) I Z1'="" W ?L1,$J(Z1,7,2)
"RTN","PRSASR1",25,0)
 I PAYP="F" W !! F K=19:1:21 S Z1=$P(Z,"^",K) W "Total ",$P("Hours Days Procedures"," ",K-18),": ",Z1,"    "
"RTN","PRSASR1",26,0)
 Q
"RTN","PRSASR1",27,0)
ED ; Display Envir. Diff.
"RTN","PRSASR1",28,0)
 W !!?26,"Environmental Differentials",!
"RTN","PRSASR1",29,0)
 S Y="" F K=1:2:5 S Z1=$P(Z,"^",K) Q:'Z1  S:Y'="" Y=Y_"; " S Y=Y_$P($G(^PRST(457.6,+Z1,0)),"^",1)_" "_$P(Z,"^",K+1)_" Hrs."
"RTN","PRSASR1",30,0)
 I Y'="" W !,"Week 1: ",Y
"RTN","PRSASR1",31,0)
 S Y="" F K=7:2:11 S Z1=$P(Z,"^",K) Q:'Z1  S:Y'="" Y=Y_"; " S Y=Y_$P($G(^PRST(457.6,+Z1,0)),"^",1)_" "_$P(Z,"^",K+1)_" Hrs."
"RTN","PRSASR1",32,0)
 I Y'="" W !,"Week 2: ",Y
"RTN","PRSASR1",33,0)
 Q
"RTN","PRSASR1",34,0)
 ;
"RTN","PRSASR1",35,0)
LD ; Display changes to the Labor Distribution Codes within the Pay
"RTN","PRSASR1",36,0)
 ; Period.
"RTN","PRSASR1",37,0)
 ;
"RTN","PRSASR1",38,0)
 N DASH,DESC,IENS,LDCC,LDCCB,LDCCEX,LDCODE,LDCNT,LDDOA,LDFCP
"RTN","PRSASR1",39,0)
 N LDHOLD,LDPCT,LDTOI,PRSLD,Y
"RTN","PRSASR1",40,0)
 S $P(DASH,"-",80)=""
"RTN","PRSASR1",41,0)
 W !
"RTN","PRSASR1",42,0)
 D LDHOLD
"RTN","PRSASR1",43,0)
 W !,"Current Labor Distribution Values:"
"RTN","PRSASR1",44,0)
 S LDDOA=$$GET1^DIQ(450,DFN,756,"E")
"RTN","PRSASR1",45,0)
 S LDCCB=$$GET1^DIQ(450,DFN,755,"E")
"RTN","PRSASR1",46,0)
 S LDTOI=$$GET1^DIQ(450,DFN,755.1,"E")
"RTN","PRSASR1",47,0)
 W !,LDDOA,?24,LDCCB,?61,LDTOI
"RTN","PRSASR1",48,0)
 F PRSLD=1:1:4 D
"RTN","PRSASR1",49,0)
 . S LDCODE=$$GET1^DIQ(450.0757,PRSLD_","_DFN,1)
"RTN","PRSASR1",50,0)
 . S LDPCT=$$GET1^DIQ(450.0757,PRSLD_","_DFN,2)
"RTN","PRSASR1",51,0)
 . S LDCC=$$GET1^DIQ(450.0757,PRSLD_","_DFN,3)
"RTN","PRSASR1",52,0)
 . S Y=LDCC,SUB454="CC"
"RTN","PRSASR1",53,0)
 . D OT^PRSDUTIL K SUB454
"RTN","PRSASR1",54,0)
 . S LDCCEX=$E(Y,1,30)
"RTN","PRSASR1",55,0)
 . S LDFCP=$$GET1^DIQ(450.0757,PRSLD_","_DFN,4)
"RTN","PRSASR1",56,0)
 . W !,"Code",PRSLD,": ",LDCODE,?12,LDPCT,?24,LDCC," - ",LDCCEX,?70,LDFCP
"RTN","PRSASR1",57,0)
 ;
"RTN","PRSASR1",58,0)
 W !!,"The previous Labor Distribution Values:"
"RTN","PRSASR1",59,0)
 S LDCNT="A"
"RTN","PRSASR1",60,0)
 S LDCNT=$O(^PRST(458,PPI,"E",DFN,"LDAUD",LDCNT),-1)
"RTN","PRSASR1",61,0)
 Q:'LDCNT
"RTN","PRSASR1",62,0)
 S IENS=LDCNT_","_DFN_","_PPI_","
"RTN","PRSASR1",63,0)
 S LDDOA=$$GET1^DIQ(458.1105,IENS,1,"E")
"RTN","PRSASR1",64,0)
 S LDCCB=$$GET1^DIQ(458.1105,IENS,2,"E")
"RTN","PRSASR1",65,0)
 S LDTOI=$$GET1^DIQ(458.1105,IENS,3,"E")
"RTN","PRSASR1",66,0)
 W !,LDDOA,?24,LDCCB,?61,LDTOI
"RTN","PRSASR1",67,0)
 F PRSLD=1:1:4 D
"RTN","PRSASR1",68,0)
 . S IENS=PRSLD_","_LDCNT_","_DFN_","_PPI_","
"RTN","PRSASR1",69,0)
 . S LDCODE=$$GET1^DIQ(458.11054,IENS,1)
"RTN","PRSASR1",70,0)
 . S LDPCT=$$GET1^DIQ(458.11054,IENS,2)
"RTN","PRSASR1",71,0)
 . S LDCC=$$GET1^DIQ(458.11054,IENS,3)
"RTN","PRSASR1",72,0)
 . S Y=LDCC,SUB454="CC"
"RTN","PRSASR1",73,0)
 . D OT^PRSDUTIL K SUB454
"RTN","PRSASR1",74,0)
 . S LDCCEX=$E(Y,1,30)
"RTN","PRSASR1",75,0)
 . S LDFCP=$$GET1^DIQ(458.11054,IENS,4)
"RTN","PRSASR1",76,0)
 . W !,"Code",PRSLD,": ",LDCODE,?12,LDPCT,?24,LDCC," - ",LDCCEX,?70,LDFCP
"RTN","PRSASR1",77,0)
 Q
"RTN","PRSASR1",78,0)
 ;
"RTN","PRSASR1",79,0)
LDHDR ; Labor Distribution Header information
"RTN","PRSASR1",80,0)
 ;
"RTN","PRSASR1",81,0)
 W !?15,"Labor Distribution Changes within the Pay Period:"
"RTN","PRSASR1",82,0)
 W !,"Date/Time",?24,"Changed by",?61,"Type of Interface"
"RTN","PRSASR1",83,0)
 W !,"Code",?12,"Percent",?24,"Cost Center - Description"
"RTN","PRSASR1",84,0)
 W ?65,"Fund Ctrl Pt"
"RTN","PRSASR1",85,0)
 W !,DASH
"RTN","PRSASR1",86,0)
 Q
"RTN","PRSASR1",87,0)
 ;
"RTN","PRSASR1",88,0)
LDHOLD ; Pause of more LD changes that will fit on 1 screen.
"RTN","PRSASR1",89,0)
 ;
"RTN","PRSASR1",90,0)
 N X
"RTN","PRSASR1",91,0)
 S LDHOLD=$$ASK^PRSLIB00(1)
"RTN","PRSASR1",92,0)
 S X=$G(^PRSPC(DFN,0))
"RTN","PRSASR1",93,0)
 W !,@IOF,?3,$P(X,"^",1)
"RTN","PRSASR1",94,0)
 S X=$P(X,"^",9)
"RTN","PRSASR1",95,0)
 I X W ?68,$E(X),"XX-XX-",$E(X,6,9)
"RTN","PRSASR1",96,0)
 W !,DASH
"RTN","PRSASR1",97,0)
 D LDHDR
"RTN","PRSASR1",98,0)
 Q
"RTN","PRSASR1",99,0)
 ;
"RTN","PRSASR1",100,0)
PTP(PRSIEN,PPI) ; Updates hours credited for PT Phys w/ Memorandums
"RTN","PRSASR1",101,0)
 ; This API can be used for initial and subsequent calculation
"RTN","PRSASR1",102,0)
 ; of the PTP's ESR.
"RTN","PRSASR1",103,0)
 ;    algorithm for this API follows:
"RTN","PRSASR1",104,0)
 ; 1. Grab copy of currently stored pay period hours
"RTN","PRSASR1",105,0)
 ; 2. Look at ESR/timecard data to recalculate pay period hours
"RTN","PRSASR1",106,0)
 ; 3. Calculate net difference between 1 and 2
"RTN","PRSASR1",107,0)
 ; 4. update current pay period with new pp totals from (2) above
"RTN","PRSASR1",108,0)
 ; 5. add net diff (3) to memo totals
"RTN","PRSASR1",109,0)
 ;
"RTN","PRSASR1",110,0)
 N AHRS,AHTCM,AMT,COHRS,DIFFNP,DIFFRG,DIFFWP,INPH,ITHP,ITHW,IWPH
"RTN","PRSASR1",111,0)
 N MDAT,MDATA,MEAL,MIEN,MPPIEN,POHC,POT,PPC,PPE
"RTN","PRSASR1",112,0)
 N PPHRS,PPNP,PPWP,PRSX,START,STOP,THP,TOT,TOTAL,TOTNP,TOTWP
"RTN","PRSASR1",113,0)
 S MDAT=$P($G(^PRST(458,PPI,1)),U,1)
"RTN","PRSASR1",114,0)
 S MIEN=+$$MIEN^PRSPUT1(PRSIEN,MDAT)
"RTN","PRSASR1",115,0)
 Q:'MIEN  ; Not a PTP w/ memo
"RTN","PRSASR1",116,0)
 S PPE=$P($G(^PRST(458,PPI,0)),U,1)
"RTN","PRSASR1",117,0)
 ;
"RTN","PRSASR1",118,0)
 ; Locate this PP in the PTP's memorandum
"RTN","PRSASR1",119,0)
 S MPPIEN=$O(^PRST(458.7,MIEN,9,"B",PPE,0))
"RTN","PRSASR1",120,0)
 Q:'MPPIEN  ; PP not found within memo (###exception message)
"RTN","PRSASR1",121,0)
 ;
"RTN","PRSASR1",122,0)
 ;get the current values for this pay period under the memo.
"RTN","PRSASR1",123,0)
 S PRSX=$G(^PRST(458.7,MIEN,9,MPPIEN,0))
"RTN","PRSASR1",124,0)
 S PPHRS=+$P(PRSX,U,2) ; Actual hours of work credited
"RTN","PRSASR1",125,0)
 S PPNP=+$P(PRSX,U,3)  ; Actual hours of Non Pay
"RTN","PRSASR1",126,0)
 S PPWP=+$P(PRSX,U,4)  ; Actual hours of LWOP
"RTN","PRSASR1",127,0)
 K PRSX
"RTN","PRSASR1",128,0)
 ;
"RTN","PRSASR1",129,0)
 ; Load the memo totals
"RTN","PRSASR1",130,0)
 S MDATA=$G(^PRST(458.7,MIEN,0))
"RTN","PRSASR1",131,0)
 S AHRS=+$P(MDATA,U,4)  ; Agreed Hours
"RTN","PRSASR1",132,0)
 S COHRS=+$P(MDATA,U,9) ; Carryover Hours
"RTN","PRSASR1",133,0)
 S ITHW=+$P(MDATA,U,10) ; Initial Total Hours Worked
"RTN","PRSASR1",134,0)
 S ITHP=+$P(MDATA,U,11) ; Initial Total Hours Paid
"RTN","PRSASR1",135,0)
 S INPH=+$P(MDATA,U,12) ; Initial Non-Pay Hours
"RTN","PRSASR1",136,0)
 S IWPH=+$P(MDATA,U,13) ; Initial Without Pay Hours
"RTN","PRSASR1",137,0)
 S (AHTCM,DIFFRG,DIFFNP,DIFFWP)=0
"RTN","PRSASR1",138,0)
 ;
"RTN","PRSASR1",139,0)
 ; Get Non pay and Leave without pay times from 8b string or recalc.
"RTN","PRSASR1",140,0)
 N TAMTS
"RTN","PRSASR1",141,0)
 S TAMTS("WP","Leave Without Pay")=""
"RTN","PRSASR1",142,0)
 S TAMTS("NP","Non-Pay Time")=""
"RTN","PRSASR1",143,0)
 D PP8BAMT^PRSPUT3(.TAMTS,PPI,PRSIEN)
"RTN","PRSASR1",144,0)
 S TOTAL("WP")=$G(TAMTS("WP","Leave Without Pay"))
"RTN","PRSASR1",145,0)
 S TOTAL("NP")=$G(TAMTS("NP","Non-Pay Time"))
"RTN","PRSASR1",146,0)
 S DIFFNP=TOTAL("NP")-PPNP
"RTN","PRSASR1",147,0)
 S DIFFWP=TOTAL("WP")-PPWP
"RTN","PRSASR1",148,0)
 ;
"RTN","PRSASR1",149,0)
 ; Loop thru day and ESR segments looking for leave and RG time
"RTN","PRSASR1",150,0)
 N DAY,ESR,RGCODES,SEG,TOT
"RTN","PRSASR1",151,0)
 S RGCODES="AA,AD,AL,CB,CP,DL,HX,ML,RG,RL,SL,TR,TV"
"RTN","PRSASR1",152,0)
 S TOTAL("RG")=0
"RTN","PRSASR1",153,0)
 F DAY=1:1:14 D
"RTN","PRSASR1",154,0)
 . ; only add totals for supervisor approved days
"RTN","PRSASR1",155,0)
 . Q:$$GETSTAT^PRSPESR1(PRSIEN,PPI,DAY)'=5
"RTN","PRSASR1",156,0)
 . S ESR=$G(^PRST(458,PPI,"E",PRSIEN,"D",DAY,5))
"RTN","PRSASR1",157,0)
 . Q:ESR=""
"RTN","PRSASR1",158,0)
 . F SEG=0:1:6 Q:$P(ESR,U,(5*SEG)+3)=""  D
"RTN","PRSASR1",159,0)
 . . S TOT=$P(ESR,U,(5*SEG)+3)
"RTN","PRSASR1",160,0)
 . . ; Types Of Time that might have been worked in week 1
"RTN","PRSASR1",161,0)
 . . I RGCODES[TOT D  Q
"RTN","PRSASR1",162,0)
 . . . S TOTAL("RG")=TOTAL("RG")+$$AMT(ESR)
"RTN","PRSASR1",163,0)
 ;
"RTN","PRSASR1",164,0)
 ; Checks for Regular Time
"RTN","PRSASR1",165,0)
 S DIFFRG=TOTAL("RG")-PPHRS
"RTN","PRSASR1",166,0)
 ; determine number of memo pay periods that have been certified
"RTN","PRSASR1",167,0)
 S PRSX=$$MEMCPP^PRSPUT3(MIEN)
"RTN","PRSASR1",168,0)
 S PPC=$P(PRSX,U,2)+$S(PPE]$P(PRSX,U):1,1:0)
"RTN","PRSASR1",169,0)
 ;
"RTN","PRSASR1",170,0)
 ; Update pp totals with current calculated values
"RTN","PRSASR1",171,0)
 K IEN4587,PRSFDA
"RTN","PRSASR1",172,0)
 S IEN4587=MIEN_","
"RTN","PRSASR1",173,0)
 S PRSFDA(458.701,MPPIEN_","_IEN4587,1)=TOTAL("RG")  ; PP new REG hrs
"RTN","PRSASR1",174,0)
 S PRSFDA(458.701,MPPIEN_","_IEN4587,2)=TOTAL("NP")  ; PP new NP hrs
"RTN","PRSASR1",175,0)
 S PRSFDA(458.701,MPPIEN_","_IEN4587,3)=TOTAL("WP")  ; PP new WP hrs
"RTN","PRSASR1",176,0)
 ;
"RTN","PRSASR1",177,0)
 ; update memo grand totals with differences found 
"RTN","PRSASR1",178,0)
 S TOTNP=INPH+DIFFNP
"RTN","PRSASR1",179,0)
 S TOTWP=IWPH+DIFFWP
"RTN","PRSASR1",180,0)
 S PRSFDA(458.7,IEN4587,11)=TOTNP ; NP hrs
"RTN","PRSASR1",181,0)
 S PRSFDA(458.7,IEN4587,12)=TOTWP ; WP hrs
"RTN","PRSASR1",182,0)
 S PRSFDA(458.7,IEN4587,9)=ITHW+DIFFRG ; tot hrs worked (all creditable)
"RTN","PRSASR1",183,0)
 ;
"RTN","PRSASR1",184,0)
 ; If this is the first time the PP has been processed PPHRS will be null
"RTN","PRSASR1",185,0)
 ; so add the average hrs/pp, otherwise this count has already been added
"RTN","PRSASR1",186,0)
 S THP=ITHP+$S(PPHRS="":AHRS/26,1:0)
"RTN","PRSASR1",187,0)
 S PRSFDA(458.7,IEN4587,10)=$FN(THP-DIFFNP-DIFFWP,"",2) ; tot hrs paid
"RTN","PRSASR1",188,0)
 S PRSFDA(458.7,IEN4587,13)=$FN(PPC/26,"",2) ; % of memo completed
"RTN","PRSASR1",189,0)
 ; % OF HOURS COMPLETED
"RTN","PRSASR1",190,0)
 S POHC=$FN((ITHW+COHRS+DIFFRG)/(AHRS-TOTNP-TOTWP),"",2)
"RTN","PRSASR1",191,0)
 S PRSFDA(458.7,IEN4587,14)=POHC
"RTN","PRSASR1",192,0)
 ;
"RTN","PRSASR1",193,0)
 ; ave hrs/pp to complete mem (if certifying last pay period then then
"RTN","PRSASR1",194,0)
 ; you're out of pay periods so use 0.00 to report how many more hours)
"RTN","PRSASR1",195,0)
 S AHTCM=$S(PPC>25:"0.00",1:$FN((AHRS-(ITHW+COHRS+DIFFRG)/(26-PPC)),"",2))
"RTN","PRSASR1",196,0)
 S PRSFDA(458.7,IEN4587,15)=AHTCM
"RTN","PRSASR1",197,0)
 ; % off target
"RTN","PRSASR1",198,0)
 S POT=((AHRS/26)*PPC)-TOTNP-TOTWP
"RTN","PRSASR1",199,0)
 S POT=(ITHW+COHRS+DIFFRG)-POT/POT,POT=POT*100,POT=$FN(POT,"",2)
"RTN","PRSASR1",200,0)
 S PRSFDA(458.7,IEN4587,16)=POT
"RTN","PRSASR1",201,0)
 D FILE^DIE("","PRSFDA")
"RTN","PRSASR1",202,0)
 Q
"RTN","PRSASR1",203,0)
 ;
"RTN","PRSASR1",204,0)
AMT(ESR) ; Return hours elapsed for time segment in decimal format
"RTN","PRSASR1",205,0)
 ;          deduct meal
"RTN","PRSASR1",206,0)
 ;            e.g. AMT=2.5 (2 hours 30 min)
"RTN","PRSASR1",207,0)
 N START,STOP,MEAL,AMT,X
"RTN","PRSASR1",208,0)
 S START=$P(ESR,U,(5*SEG)+1),STOP=$P(ESR,U,(5*SEG)+2)
"RTN","PRSASR1",209,0)
 S MEAL=$P(ESR,U,(5*SEG)+5)
"RTN","PRSASR1",210,0)
 S AMT=$$ELAPSE^PRSPESR2(MEAL,START,STOP)
"RTN","PRSASR1",211,0)
 S X=$P(AMT,":",2) S X=$S(X=30:5,X=15:25,X=45:75,1:0)
"RTN","PRSASR1",212,0)
 S AMT=+$P(AMT,":",1)_"."_X
"RTN","PRSASR1",213,0)
 Q AMT
"RTN","PRSATPE")
0^1^B68842972^B59425461
"RTN","PRSATPE",1,0)
PRSATPE ;WOIFO/PLT - Find Exceptions ;12/3/07
"RTN","PRSATPE",2,0)
 ;;4.0;PAID;**26,34,69,102,112,116**;Sep 21, 1995;Build 23
"RTN","PRSATPE",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRSATPE",4,0)
 K ER S (ECNT,FATAL)=0,X0=$G(^PRST(458,PPI,"E",DFN,"D",DAY,0)),STAT=$P($G(^(10)),"^",1)
"RTN","PRSATPE",5,0)
 N MLTIME S MLTIME=0
"RTN","PRSATPE",6,0)
 S TC=$P(X0,"^",2) I 'TC S ER(1)=$P($T(ERTX+1),";;",2),FATAL=1 G EX
"RTN","PRSATPE",7,0)
 ;
"RTN","PRSATPE",8,0)
 ;ensure Normal Hrs = tour hrs for hourly employees
"RTN","PRSATPE",9,0)
 I DAY=14 I '$$HRSMATCH(PPI,DFN) S FATAL=1,ERR=21 D ERR3640 G EX
"RTN","PRSATPE",10,0)
 ;
"RTN","PRSATPE",11,0)
 I "1 3 4"'[TC,STAT="" S ER(1)=$P($T(ERTX+2),";;",2),FATAL=1 G EX
"RTN","PRSATPE",12,0)
 ;
"RTN","PRSATPE",13,0)
 ;  Validate NAWS 36/40 nurse tours--can't certify if errors
"RTN","PRSATPE",14,0)
 N NAWSERR S NAWSERR=0
"RTN","PRSATPE",15,0)
 I DAY=7!(DAY=14),$$NAWS3640(DFN,PPI) D
"RTN","PRSATPE",16,0)
 .  I $$SAT2DAY(DAY/7,DFN,PPI) D
"RTN","PRSATPE",17,0)
 ..    S FATAL=1 S ERR=16 D ERR3640 S ERR=17 D ERR3640
"RTN","PRSATPE",18,0)
 ..    S NAWSERR=1
"RTN","PRSATPE",19,0)
 .  I $$THREE12(DAY/7,DFN,PPI) D
"RTN","PRSATPE",20,0)
 ..    S FATAL=1 I 'NAWSERR S ERR=16 D ERR3640
"RTN","PRSATPE",21,0)
 ..    S ERR=$S(DAY=7:19,1:20) D ERR3640
"RTN","PRSATPE",22,0)
 I DAY=1,$$NAWS3640(DFN,PPI),$$CARRYOVR(DFN,PPI) D
"RTN","PRSATPE",23,0)
 .    S FATAL=1 S ERR=16 D ERR3640 S ERR=18 D ERR3640
"RTN","PRSATPE",24,0)
 ;
"RTN","PRSATPE",25,0)
 S X2=$G(^PRST(458,PPI,"E",DFN,"D",DAY,2)) G:X2="" EX S X1=$G(^(1)),X4=$G(^(4)),K=$P($G(^(10)),U,4)
"RTN","PRSATPE",26,0)
 ;check recess entire day having un-unavailable posted for all scheduled on-on call
"RTN","PRSATPE",27,0)
 I $E($G(PRSENT),5),K=2,X2["^RS" D
"RTN","PRSATPE",28,0)
 . F K=1:3 QUIT:$P(X1,U,K,999)=""  S Z=$P(X1,U,K+2) I Z,$P($G(^PRST(457.2,Z,0)),"^",2)="ON",X2'[($P(X1,U,K,K+1)_"^UN") S PRSWOC=$G(PRSWOC)_DAY_"," QUIT
"RTN","PRSATPE",29,0)
 . I $G(PRSWOC)'[(DAY_",") F K=1:3 QUIT:$P(X4,U,K,999)=""  S Z=$P(X4,U,K+2) I Z,$P($G(^PRST(457.2,Z,0)),"^",2)="ON",X2'[($P(X4,U,K,K+1)_"^UN") S PRSWOC=$G(PRSWOC)_DAY_"," QUIT
"RTN","PRSATPE",30,0)
 . QUIT
"RTN","PRSATPE",31,0)
 ;
"RTN","PRSATPE",32,0)
 K TM I X2["OT"!(X2["CT") D TM
"RTN","PRSATPE",33,0)
 K T,TRS F K=1:3 Q:$P(X1,"^",K)=""  S Z=$P(X1,"^",K+2) I $S('Z:1,1:$P($G(^PRST(457.2,Z,0)),"^",2)="RG") D
"RTN","PRSATPE",34,0)
 .S X=$P(X1,"^",K,K+1) D CNV^PRSATIM S Z1=$P(Y,"^",1),Z2=$P(Y,"^",2) D V0
"RTN","PRSATPE",35,0)
 .I Z1'="",$G(T(Z1))="*" K T(Z1) S T(Z2)="*" Q
"RTN","PRSATPE",36,0)
 .S T(Z1)="",T(Z2)="*" Q
"RTN","PRSATPE",37,0)
 I X4'="" F K=1:3 Q:$P(X4,"^",K)=""  S Z=$P(X4,"^",K+2) I $S('Z:1,1:$P($G(^PRST(457.2,Z,0)),"^",2)="RG") D
"RTN","PRSATPE",38,0)
 .S X=$P(X4,"^",K,K+1) D CNV^PRSATIM S Z1=$P(Y,"^",1),Z2=$P(Y,"^",2) D V0
"RTN","PRSATPE",39,0)
 .I Z1'="",$G(T(Z1))="*" K T(Z1) S T(Z2)="*" Q
"RTN","PRSATPE",40,0)
 .S T(Z1)="",T(Z2)="*" Q
"RTN","PRSATPE",41,0)
 ;
"RTN","PRSATPE",42,0)
 ;find rs-type of time segments of trs array in x2 posted string
"RTN","PRSATPE",43,0)
 I X2["^RS" F K=1:4:25 QUIT:$P(X2,U,K,999)=""  S X=$P(X2,"^",K,K+1) I "^"'[X,$P(X2,"^",K+2)="RS" D
"RTN","PRSATPE",44,0)
 . S TT=$P(X2,"^",K+2) D CNV^PRSATIM S Z1=$P(Y,"^",1),Z2=$P(Y,"^",2) D V1
"RTN","PRSATPE",45,0)
 . I Z1'="",$G(TRS(Z1))="*" K TRS(Z1) S TRS(Z2)="*" QUIT
"RTN","PRSATPE",46,0)
 . S TRS(Z1)="",TRS(Z2)="*"
"RTN","PRSATPE",47,0)
 . QUIT
"RTN","PRSATPE",48,0)
 ; Checks for Daily employees
"RTN","PRSATPE",49,0)
 I "^"[$P(X2,"^",1,2) S TT=$P(X2,"^",3),K=1,DN=0,Y0="" G L0
"RTN","PRSATPE",50,0)
 F K=1:4:25 S X=$P(X2,"^",K,K+1) I "^"'[X D
"RTN","PRSATPE",51,0)
 . N Z3,Z4
"RTN","PRSATPE",52,0)
 . S TT=$P(X2,"^",K+2)
"RTN","PRSATPE",53,0)
 . D CNV^PRSATIM S Y0=Y,Z1=$P(Y,"^",1),Z2=$P(Y,"^",2) D V1 S TIM=Z2-Z1/60
"RTN","PRSATPE",54,0)
 . S Z3=Z1,Z4=Z2
"RTN","PRSATPE",55,0)
 . I TT="ML" S MLTIME=MLTIME+TIM
"RTN","PRSATPE",56,0)
 . S Z1=$O(T(Z1)) S:Z1'="" Z1=T(Z1)
"RTN","PRSATPE",57,0)
 . S Z2=$O(T(Z2-1)) S:Z2'="" Z2=T(Z2)
"RTN","PRSATPE",58,0)
 . ;trs=1 if absolute outside rs, 2 if absolute inside rs, 3 if overlap (in/outside) rs and inside tour of duty
"RTN","PRSATPE",59,0)
 . ;if exception segment start/ending time outside tour of duty, reset z3 and z4
"RTN","PRSATPE",60,0)
 . I Z1]""!(Z2]""),X2["^RS" S:Z1=""&(Z2="*") Z3=$O(T(Z3)) S:Z1="*"&(Z2="") Z4=$O(T(Z3)) S Z3=$O(TRS(Z3)) S:Z3]"" Z3=TRS(Z3) S Z4=$O(TRS(Z4-1)) S:Z4]"" Z4=TRS(Z4) S TRS=$S(Z3=""&(Z4=""):1,Z3="*"&(Z4="*"):2,1:3)
"RTN","PRSATPE",61,0)
 . I TT="UN" D UN^PRSATPH QUIT
"RTN","PRSATPE",62,0)
 . I "CT OT ON SB RG"[TT D OT QUIT
"RTN","PRSATPE",63,0)
 . D LV QUIT
"RTN","PRSATPE",64,0)
 ;
"RTN","PRSATPE",65,0)
 ; Check for a minimum of 1 hour ML
"RTN","PRSATPE",66,0)
 ;
"RTN","PRSATPE",67,0)
 I TT="ML",MLTIME<1 S ER(1)=$P($T(ERTX+14),";;",2),FATAL=1 G EX
"RTN","PRSATPE",68,0)
 ;
"RTN","PRSATPE",69,0)
EX Q
"RTN","PRSATPE",70,0)
V0 I Z2>Z1 S:$O(T(""))'<Z2 Z1=Z1+1440,Z2=Z2+1440 Q
"RTN","PRSATPE",71,0)
 S Z2=Z2+1440 Q
"RTN","PRSATPE",72,0)
V1 S DN=0 I Z2>Z1 Q:"CT OT ON SB UN RG"[TT  S:$O(T(""))'<Z2 Z1=Z1+1440,Z2=Z2+1440,DN=2 Q
"RTN","PRSATPE",73,0)
 S Z2=Z2+1440,DN=1 Q
"RTN","PRSATPE",74,0)
OT ; Check OT/CT Request
"RTN","PRSATPE",75,0)
 I Z1'=""!(Z2'="") D O2 I $G(ERR)=6 S FATAL=1 D ERR
"RTN","PRSATPE",76,0)
 I DN=1,$O(T(1440))="" D NX^PRSATPH
"RTN","PRSATPE",77,0)
 I 'DN,$O(T(""))=""!($P(Y0,"^",1)'>$O(T(""))) D PR^PRSATPH
"RTN","PRSATPE",78,0)
 I "ON SB RG"[TT Q
"RTN","PRSATPE",79,0)
 ; check status of request(s)
"RTN","PRSATPE",80,0)
 S DTI=$P($G(^PRST(458,PPI,1)),U,DAY) Q:'DTI
"RTN","PRSATPE",81,0)
 S STAT="" ; init highest status var
"RTN","PRSATPE",82,0)
 S DA=0 F  S DA=$O(^PRST(458.2,"AD",DFN,DTI,DA)) Q:'DA  D  Q:STAT="A"
"RTN","PRSATPE",83,0)
 . S Z=$G(^PRST(458.2,DA,0))
"RTN","PRSATPE",84,0)
 . Q:$P(Z,"^",5)'=TT  ; ignore different type
"RTN","PRSATPE",85,0)
 . I $F("RSA",$P(Z,U,8))>$F("RSA",STAT) S STAT=$P(Z,U,8) ; higher status
"RTN","PRSATPE",86,0)
 I STAT="" S ERR=3 D ERR Q  ; none with requested or higher status
"RTN","PRSATPE",87,0)
 I STAT'="A" D  Q  ; none approved
"RTN","PRSATPE",88,0)
 . S ERR=$S(STAT="R":8,1:9) D ERR
"RTN","PRSATPE",89,0)
 . ; check posted hours vs requested since no approved request
"RTN","PRSATPE",90,0)
 . S TM(TT,"R")=$G(TM(TT,"R"))-TIM I TM(TT,"R")<0 S ERR=7 D ERR
"RTN","PRSATPE",91,0)
 ; check posted hours vs approved since we have an approved request
"RTN","PRSATPE",92,0)
 S TM(TT,"A")=$G(TM(TT,"A"))-TIM I TM(TT,"A")<0 S ERR=13 D ERR
"RTN","PRSATPE",93,0)
 Q
"RTN","PRSATPE",94,0)
O2 ; Check for valid with-in tour or cross-tour situations
"RTN","PRSATPE",95,0)
 I TT="ON"&(X2["HX") Q
"RTN","PRSATPE",96,0)
 ;I "OT CT"[TT,TIM'>1 Q
"RTN","PRSATPE",97,0)
 ;none-leave hours are inside tour hours, but quit if inside rs hours
"RTN","PRSATPE",98,0)
 QUIT:$G(TRS)=2!(TT="HW"&(X2["^RS"))  S ERR=6 QUIT
"RTN","PRSATPE",99,0)
TM ; Get OT,CT request,approve times
"RTN","PRSATPE",100,0)
 S DTI=$P($G(^PRST(458,PPI,1)),"^",DAY),DA=0 Q:'DTI
"RTN","PRSATPE",101,0)
T1 S DA=$O(^PRST(458.2,"AD",DFN,DTI,DA)) I 'DA Q
"RTN","PRSATPE",102,0)
 S Z=$G(^PRST(458.2,DA,0)),STAT=$P(Z,"^",8) I STAT'="","XD"[STAT G T1
"RTN","PRSATPE",103,0)
 S TT=$P(Z,"^",5) I TT'="OT",TT'="CT" G T1
"RTN","PRSATPE",104,0)
 S TM(TT,"R")=$G(TM(TT,"R"))+$P(Z,"^",6) ; requested sum
"RTN","PRSATPE",105,0)
 I STAT="A" S TM(TT,"A")=$G(TM(TT,"A"))+$P(Z,"^",6) ; approved sum
"RTN","PRSATPE",106,0)
 G T1
"RTN","PRSATPE",107,0)
LV ; Check Leave Request
"RTN","PRSATPE",108,0)
 I TC=3!(TC=4) Q
"RTN","PRSATPE",109,0)
 I TC=1,TT="HW" Q
"RTN","PRSATPE",110,0)
 ;leave hours are (overlap) outside tour hours or (overlap) inside recess hours
"RTN","PRSATPE",111,0)
 I ($G(TRS)'=1&(TT="HW")&$G(TRS)) QUIT
"RTN","PRSATPE",112,0)
 I Z1'="*"!(Z2'="*")!($G(TRS)'=1&(TT'="RS")&$G(TRS)) S ERR=5,FATAL=1 D ERR
"RTN","PRSATPE",113,0)
 ;
"RTN","PRSATPE",114,0)
L0 N REMARK S REMARK=$P(X2,"^",K+3)
"RTN","PRSATPE",115,0)
 Q:REMARK&(REMARK'=15&(REMARK'=16))
"RTN","PRSATPE",116,0)
 I "HX"[TT D HENCAP
"RTN","PRSATPE",117,0)
 ;no leave request for non-leave hour and rs types
"RTN","PRSATPE",118,0)
 QUIT:"RG CP NP HX HW TR TV RS"[TT
"RTN","PRSATPE",119,0)
 S DTI=$P($G(^PRST(458,PPI,1)),"^",DAY) Q:'DTI  S (DT1,DT2)=DTI
"RTN","PRSATPE",120,0)
 I DN D D2 S:DN=2 DT1=DT2
"RTN","PRSATPE",121,0)
 S DTIN=9999999-DT2,DA=0
"RTN","PRSATPE",122,0)
 F KK=0:0 S KK=$O(^PRST(458.1,"AD",DFN,KK)) G:KK=""!(KK>DTIN) L3 F DA=0:0 S DA=$O(^PRST(458.1,"AD",DFN,KK,DA)) Q:DA=""  I ^(DA)'>DT1 D L1 G:LF L4
"RTN","PRSATPE",123,0)
 Q
"RTN","PRSATPE",124,0)
L1 S Z=$G(^PRST(458.1,DA,0)),LF=0 Q:$P(Z,"^",7)'=TT  S STAT=$P(Z,"^",9) I "XD"[STAT Q
"RTN","PRSATPE",125,0)
 G:Y0="" L2 S Z1=$P(Y0,"^",1),Z2=$P(Y0,"^",2)
"RTN","PRSATPE",126,0)
 S X=$P(Z,"^",4)_"^"_$P(Z,"^",6) D CNV^PRSATIM
"RTN","PRSATPE",127,0)
 I $P(Z,"^",3)=DT1,$P(Y,"^",1)>Z1 Q
"RTN","PRSATPE",128,0)
 I $P(Z,"^",5)=DT2,$P(Y,"^",2)<Z2 Q
"RTN","PRSATPE",129,0)
L2 I STAT'="A" S ERR=4 D ERR
"RTN","PRSATPE",130,0)
 S LF=1 Q
"RTN","PRSATPE",131,0)
L3 S ERR=3 D ERR Q
"RTN","PRSATPE",132,0)
L4 Q
"RTN","PRSATPE",133,0)
D2 I DAY<14 S DT2=$P($G(^PRST(458,PPI,1)),"^",DAY+1) Q
"RTN","PRSATPE",134,0)
 N X1,X2 S X1=DT1,X2=1 D C^%DTC S DT2=X Q
"RTN","PRSATPE",135,0)
 ;
"RTN","PRSATPE",136,0)
HENCAP ; Check for Holiday encapsulated by non-pay
"RTN","PRSATPE",137,0)
 N DAH,DBH,HOL,QUIT
"RTN","PRSATPE",138,0)
 S (DAH,DBH,HOL,QUIT)=""
"RTN","PRSATPE",139,0)
 D HENCAP^PRSATP4(PPI,DFN,DAY,.DBH,.HOL,.DAH,.QUIT)
"RTN","PRSATPE",140,0)
 Q:QUIT
"RTN","PRSATPE",141,0)
 Q:HOL=""
"RTN","PRSATPE",142,0)
 S ERR=15 D ERR Q  ; Holiday in current PP
"RTN","PRSATPE",143,0)
 Q
"RTN","PRSATPE",144,0)
NAWS3640(PRSEMP,PPI) ; return true if NAWS 36/40 Nurse for this PPI
"RTN","PRSATPE",145,0)
 N EMPNODE,PAYPLAN,DTYBASIS,NORMHRS,S8
"RTN","PRSATPE",146,0)
 S S8=$G(^PRST(458,PPI,"E",PRSEMP,5))
"RTN","PRSATPE",147,0)
 I S8'="",($E(S8,26,27)'=72!("KM"'[$E(S8,28))!($E(S8,29)'=1)) Q 0
"RTN","PRSATPE",148,0)
 S EMPNODE=$G(^PRSPC(PRSEMP,0))
"RTN","PRSATPE",149,0)
 S PAYPLAN=$P(EMPNODE,U,21)
"RTN","PRSATPE",150,0)
 S DTYBASIS=$P(EMPNODE,U,10)
"RTN","PRSATPE",151,0)
 S NORMHRS=$P(EMPNODE,U,16)
"RTN","PRSATPE",152,0)
 Q "KM"[PAYPLAN&(DTYBASIS=1)&(NORMHRS=72)
"RTN","PRSATPE",153,0)
SAT2DAY(WK,PRSIEN,PPI) ;
"RTN","PRSATPE",154,0)
 N HRS,SUNTRHRS,SAT2DAY,PRSD
"RTN","PRSATPE",155,0)
 S SAT2DAY=0
"RTN","PRSATPE",156,0)
 S PRSD=$S(WK=1:7,1:14)
"RTN","PRSATPE",157,0)
 S SAT2DAY=$P($G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,0)),"^",2)
"RTN","PRSATPE",158,0)
 I SAT2DAY>0 S SAT2DAY=$P($G(^PRST(457.1,SAT2DAY,0)),U,5)="Y"
"RTN","PRSATPE",159,0)
 Q SAT2DAY
"RTN","PRSATPE",160,0)
CARRYOVR(PRSIEN,PPI) ; true if hours are coming in from last pp
"RTN","PRSATPE",161,0)
 N PRIORSAT,SAT2DAY
"RTN","PRSATPE",162,0)
 S SAT2DAY=0
"RTN","PRSATPE",163,0)
 S PRIORSAT=$P($G(^PRST(458,PPI-1,"E",PRSIEN,"D",14,0)),U,2)
"RTN","PRSATPE",164,0)
 I PRIORSAT>0 S SAT2DAY=$P($G(^PRST(457.1,PRIORSAT,0)),U,5)="Y"
"RTN","PRSATPE",165,0)
 Q SAT2DAY
"RTN","PRSATPE",166,0)
THREE12(WK,PRSIEN,PPI) ;
"RTN","PRSATPE",167,0)
 N PRSD,TOURDTY,COUNT,ST,EN
"RTN","PRSATPE",168,0)
 S COUNT=0
"RTN","PRSATPE",169,0)
 S ST=$S(WK=1:1,1:8),EN=$S(WK=1:7,1:14)
"RTN","PRSATPE",170,0)
 F PRSD=ST:1:EN D
"RTN","PRSATPE",171,0)
 . S TOURDTY=$P($G(^PRST(458,PPI,"E",PRSIEN,"D",PRSD,0)),"^",2)
"RTN","PRSATPE",172,0)
 . I $P($G(^PRST(457.1,TOURDTY,0)),U,6)=12 S COUNT=COUNT+1
"RTN","PRSATPE",173,0)
 I COUNT'=3 Q 1
"RTN","PRSATPE",174,0)
 N HRS
"RTN","PRSATPE",175,0)
 D TOURHRS^PRSARC07(.HRS,PPI,PRSIEN)
"RTN","PRSATPE",176,0)
 Q:(HRS($S(WK=1:"W1",1:"W2"))'=36) 1
"RTN","PRSATPE",177,0)
 Q 0
"RTN","PRSATPE",178,0)
HRSMATCH(PPI,DFN) ; Return true if hourly employee tour hrs '= 8B normal hrs
"RTN","PRSATPE",179,0)
 N MATCH,HRS,NH,ENT,ENTPTR
"RTN","PRSATPE",180,0)
 I $G(PPI)'>0!($G(DFN)'>0) Q 1
"RTN","PRSATPE",181,0)
 S MATCH=1
"RTN","PRSATPE",182,0)
 S NH=-1
"RTN","PRSATPE",183,0)
 S ENTPTR=$P($G(^PRST(458,PPI,"E",DFN,0)),U,5)
"RTN","PRSATPE",184,0)
 I ENTPTR'="" D
"RTN","PRSATPE",185,0)
 .  S ENT=$P($G(^PRST(457.5,ENTPTR,1)),U)
"RTN","PRSATPE",186,0)
 .  S NH=$E($G(^PRST(458,PPI,"E",DFN,5)),26,27)
"RTN","PRSATPE",187,0)
 .  Q:NH="00"
"RTN","PRSATPE",188,0)
 .  I +NH'>0 S NH=$P($G(^PRSPC(DFN,0)),U,50)
"RTN","PRSATPE",189,0)
 I $G(ENT)="" D ^PRSAENT
"RTN","PRSATPE",190,0)
 I $G(ENT)'="",$E(ENT)'="D",($E(ENT,1,2)'="0D"),$G(NH)'=112 D
"RTN","PRSATPE",191,0)
 .  D TOURHRS^PRSARC07(.HRS,PPI,DFN)
"RTN","PRSATPE",192,0)
 .  I ($G(HRS("W1"))+$G(HRS("W2")))'=+$G(NH) S MATCH=0
"RTN","PRSATPE",193,0)
 Q MATCH
"RTN","PRSATPE",194,0)
 ;
"RTN","PRSATPE",195,0)
ERR ; Set Error
"RTN","PRSATPE",196,0)
 S ECNT=ECNT+1,ER(ECNT)=TT_$P($T(ERTX+ERR),";;",2)_"^"_$P(X2,"^",K) Q
"RTN","PRSATPE",197,0)
ERR3640 ; Set NAWS (36/40) Errors and errors not related to a single segment
"RTN","PRSATPE",198,0)
 S ECNT=ECNT+1,ER(ECNT)=$P($T(ERTX+ERR),";;",2) Q
"RTN","PRSATPE",199,0)
ERTX ;;
"RTN","PRSATPE",200,0)
1 ;;No Tour Entered^
"RTN","PRSATPE",201,0)
2 ;;No Time Posted^
"RTN","PRSATPE",202,0)
3 ;; not Requested
"RTN","PRSATPE",203,0)
4 ;; Requested but not Approved
"RTN","PRSATPE",204,0)
5 ;; Posted outside of Tour Hours or within Recess Hours
"RTN","PRSATPE",205,0)
6 ;; Posted within Tour Hours or outside of Recess Hours
"RTN","PRSATPE",206,0)
7 ;; Posted exceeds Requested Hours
"RTN","PRSATPE",207,0)
8 ;; Requested but pending Supervisor Approval
"RTN","PRSATPE",208,0)
9 ;; Supervisor Approved but pending Director Approval
"RTN","PRSATPE",209,0)
10 ;; Overlaps with the start of the next day's Tour
"RTN","PRSATPE",210,0)
11 ;; Overlaps with the prior day's Tour
"RTN","PRSATPE",211,0)
12 ;; can only be posted against OT, CT, ON, & SB in Tour
"RTN","PRSATPE",212,0)
13 ;; Posted exceeds Approved Hours
"RTN","PRSATPE",213,0)
14 ;; The minimum charge for Military Leave is one hour
"RTN","PRSATPE",214,0)
15 ;; was encapsulated by non-pay
"RTN","PRSATPE",215,0)
16 ;;36/40 AWS tours require
"RTN","PRSATPE",216,0)
17 ;; -no 2 day tours on Sat
"RTN","PRSATPE",217,0)
18 ;; -no prior pp carryover
"RTN","PRSATPE",218,0)
19 ;; -3 12 hr tours/wk 1
"RTN","PRSATPE",219,0)
20 ;; -3 12 hr tours/wk 2
"RTN","PRSATPE",220,0)
21 ;;Normal/Tour hrs unequal
"RTN","PRSAUDP")
0^5^B9116588^B8456640
"RTN","PRSAUDP",1,0)
PRSAUDP ; WOIFO/DWA - Display Employee Pay Period Audit Data ;12/3/07
"RTN","PRSAUDP",2,0)
 ;;4.0;PAID;**116**;Sep 21, 1995;Build 23
"RTN","PRSAUDP",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRSAUDP",4,0)
 ;called by PRSADP2
"RTN","PRSAUDP",5,0)
 D RET Q:QT
"RTN","PRSAUDP",6,0)
 S STATYPE=$P(^DD(458.1101,4,0),"^",3)
"RTN","PRSAUDP",7,0)
 S PG=PG+1,X=$G(^PRSPC(DFN,0)) W @IOF,!,?3,$P(X,U,1) S X=$P(X,U,9)
"RTN","PRSAUDP",8,0)
 I '$G(PRSTLV)!($G(PRSTLV)=1) W ?68,"XXX-XX-",$E(X,6,9)
"RTN","PRSAUDP",9,0)
 I $G(PRSTLV)=2!($G(PRSTLV)=3) W ?68,$E(X),"XX-XX-",$E(X,6,9)
"RTN","PRSAUDP",10,0)
 I $G(PRSTLV)=7 W ?68,$E(X,1,3),"-",$E(X,4,5),"-",$E(X,6,9)
"RTN","PRSAUDP",11,0)
 W !,?26,"Corrected  T&A  History",!!
"RTN","PRSAUDP",12,0)
AUN S AUN=0 F  S AUN=$O(^PRST(458,PPI,"E",DFN,"X",AUN)) Q:AUN=""!(QT=1)  D B
"RTN","PRSAUDP",13,0)
 W @IOF
"RTN","PRSAUDP",14,0)
EX K AUN,AX0,B,CA,CB,CC,CD,DAY,DB,DISP,DTE,IFN,J,TYP,X,STATYPE,STATUS,LNE,DFN,AUR
"RTN","PRSAUDP",15,0)
 Q
"RTN","PRSAUDP",16,0)
B S B=-1 S B=$O(^PRST(458,PPI,"E",DFN,"X",AUN,B)) Q:B=""!(QT=1)  S AX0=$G(^(B))
"RTN","PRSAUDP",17,0)
 F CA=1:1:11 S AX0(CA)=$P(AX0,U,CA)
"RTN","PRSAUDP",18,0)
 S STDT="" F CB=2,11,9,7 S Y=AX0(CB) D DTP S AX0(CB)=Y S:Y'="" STDT=Y K Y ;date/time(s)
"RTN","PRSAUDP",19,0)
 F CC=3,6,8,10 I AX0(CC)]"" I $D(^VA(200,AX0(CC),0)) S AX0(CC)=$P(^VA(200,AX0(CC),0),U,1) ;names
"RTN","PRSAUDP",20,0)
 S TYP=AX0(4),LNE="" S $P(LNE,"-",80)="" S STATUS=$P($P(STATYPE,AX0(5)_":",2),";",1)
"RTN","PRSAUDP",21,0)
 Q:TYP'?1U  Q:"TVH"'[TYP  D @TYP
"RTN","PRSAUDP",22,0)
 I $D(^PRST(458,PPI,"E",DFN,"X",AUN,7)) W !!,"Change Remarks: ",^(7)
"RTN","PRSAUDP",23,0)
 D RET Q
"RTN","PRSAUDP",24,0)
RET I $E(IOST,1,2)="C-" R !!,"Press RETURN to Continue.",X:DTIME S:'$T!(X[U) QT=1 W @IOF
"RTN","PRSAUDP",25,0)
 Q
"RTN","PRSAUDP",26,0)
T ;Time/Tour Change
"RTN","PRSAUDP",27,0)
 W !,"Status: ",STATUS,?29,"* * * Prior Data * * *",?58,STDT S IFN=AUN S DAY=$P($G(^PRST(458,PPI,"E",DFN,"X",IFN,1)),"^",1),DTE=$P($G(^PRST(458,PPI,2)),"^",+DAY) D GET^PRSAPPP,DIS^PRSAPPQ
"RTN","PRSAUDP",28,0)
 W !!?27,"* * * Corrected Data * * *" S IFN=AUN+1 D GET^PRSAPPP,DIS^PRSAPPQ W !,LNE,!
"RTN","PRSAUDP",29,0)
 Q
"RTN","PRSAUDP",30,0)
V ;VCS Sales Change
"RTN","PRSAUDP",31,0)
 W !,"Status: ",STATUS,?29,"* * * Prior Data * * *",?58,STDT S IFN=AUN D GET^PRSAPPP S Z=AUR(1) D VCS^PRSAPPQ
"RTN","PRSAUDP",32,0)
 W !!?27,"* * * Corrected Data * * *" S IFN=AUN+1 D GET^PRSAPPP S Z=AUR(1) D VCS^PRSAPPQ W !,LNE,!
"RTN","PRSAUDP",33,0)
 Q
"RTN","PRSAUDP",34,0)
H ;Hazard Change
"RTN","PRSAUDP",35,0)
 W !,"Status: ",STATUS,?29,"* * * Prior Data * * *",?58,STDT S IFN=AUN D GET^PRSAPPP S Z=AUR(1) D ED^PRSAPPQ
"RTN","PRSAUDP",36,0)
 W !!?27,"* * * Corrected Data * * *" S IFN=AUN+1 D GET^PRSAPPP S Z=AUR(1) D ED^PRSAPPQ W !,LNE,!
"RTN","PRSAUDP",37,0)
 Q
"RTN","PRSAUDP",38,0)
DTP ; Printable Date/Time
"RTN","PRSAUDP",39,0)
 Q:'Y  S %=Y,Y=$J(+$E(Y,6,7),2)_"-"_$P("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"," ",+$E(Y,4,5))_"-"_$E(Y,2,3)
"RTN","PRSAUDP",40,0)
 S:%#1 %=+$E(%_"0",9,10)_"^"_$E(%_"000",11,12),Y=Y_$J($S(%>12:%-12,1:+%),3)_":"_$P(%,"^",2)_$S(%<12:"am",%<24:"pm",1:"m") K % Q
"RTN","PRSDSERV")
0^3^B45205157^B43800529
"RTN","PRSDSERV",1,0)
PRSDSERV ;WOIFO/MGD,PLT - PAID DOWNLOAD MESSAGE SERVER ;12/3/07
"RTN","PRSDSERV",2,0)
 ;;4.0;PAID;**6,78,82,116**;Sep 21, 1995;Build 23
"RTN","PRSDSERV",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRSDSERV",4,0)
 D NOW^%DTC S TIME=% S XMPOS=1 D REC^XMS3 G:XMER'=0 EXIT
"RTN","PRSDSERV",5,0)
 S LPE=$E(XMRG,1,7) I LPE'?1"**"2N1"PDH",LPE'="****PDH" G EXIT
"RTN","PRSDSERV",6,0)
 ; EMPCNT = # emp in this mail message
"RTN","PRSDSERV",7,0)
 ; SEQNUM = Mail message sequence number if more than one message
"RTN","PRSDSERV",8,0)
 S EMPCNT=+$E(XMRG,9,12),SEQNUM=$E(XMRG,13,16),TYPE=$E(XMRG,23)
"RTN","PRSDSERV",9,0)
 S DATE=$E(XMRG,24,31),STA="",SUB="TMP"
"RTN","PRSDSERV",10,0)
 I "IEPTD"'[TYPE G EXIT
"RTN","PRSDSERV",11,0)
 ; Check to see if the message was previously loaded
"RTN","PRSDSERV",12,0)
 I $D(^PRSD(450.12,"B",XMZ)) G EXIT
"RTN","PRSDSERV",13,0)
 S MTYPE=$S(TYPE="I":"Initial",TYPE="E":"Edit & Update",TYPE="P":"Payrun",TYPE="T":"Transfer",1:"")
"RTN","PRSDSERV",14,0)
 ; Set Lines Per Employee (LPE) for the correct interface
"RTN","PRSDSERV",15,0)
 S LPE=$E(LPE,3,4),LPE=$S(LPE?2N:+LPE,TYPE="I":20,(TYPE="E")!(TYPE="T"):15,TYPE="P":9,1:0)
"RTN","PRSDSERV",16,0)
 D REC^XMS3 G:XMER'=0 EXIT S STA=$E(XMRG,1,3) I STA'?3N G EXIT
"RTN","PRSDSERV",17,0)
 I TYPE="D" D ^PRSDDL G EXIT  ; Process Separation download
"RTN","PRSDSERV",18,0)
 ; Mark message as received.  This info is for the reports sent to the
"RTN","PRSDSERV",19,0)
 ; PAD mail group.
"RTN","PRSDSERV",20,0)
 I $D(^XTMP("PRS","MNR",TYPE,DATE,STA,SEQNUM)) D  G EXIT
"RTN","PRSDSERV",21,0)
 .S ^TMP($J,"PRSD",999)=MTYPE_" message "_SEQNUM_" received."
"RTN","PRSDSERV",22,0)
 .D SETPRS S MNR="" D PROC^PRSDPROC
"RTN","PRSDSERV",23,0)
 I $D(^PRSD(450.12,"C",TYPE_"-"_DATE_"-"_STA_"-"_SEQNUM)) G EXIT
"RTN","PRSDSERV",24,0)
 K DD,DO S DIC="^PRSD(450.12,",DIC(0)="L",X=XMZ D FILE^DICN
"RTN","PRSDSERV",25,0)
 S PRSDIEN=+Y,$P(^PRSD(450.12,+Y,0),U,2)=TYPE_"-"_DATE_"-"_STA_"-"_SEQNUM
"RTN","PRSDSERV",26,0)
 S $P(^PRSD(450.12,+Y,0),U,3)="R",$P(^PRSD(450.12,+Y,0),U,4)=TIME
"RTN","PRSDSERV",27,0)
 S ^PRSD(450.12,"C",TYPE_"-"_DATE_"-"_STA_"-"_SEQNUM,+Y)=""
"RTN","PRSDSERV",28,0)
SETPRS ;start employee record
"RTN","PRSDSERV",29,0)
 S XMPOS=2 F A=1:1:EMPCNT D SSNLOOP Q:SSN=999999999
"RTN","PRSDSERV",30,0)
 I $D(^XTMP("PRS","MNR",TYPE,DATE,STA,SEQNUM)) K ^XTMP("PRS","MNR",TYPE,DATE,STA,SEQNUM) Q
"RTN","PRSDSERV",31,0)
 S:SSN'=999999999 $P(^PRSD(450.12,PRSDIEN,0),U,3)="S"
"RTN","PRSDSERV",32,0)
EXIT K %,%H,%I,A,AA,AAA,ADDFLG,B,BB,CC,DA,DATA,DATE,DBNAME,DIC,DIK,DINUM
"RTN","PRSDSERV",33,0)
 K DLAYGO,DLID,E1,E2,EE,ECNT,ECOUNT,EMPCNT,ERRCNT,ERRFLG,ERRID,ERRIEN,SUB
"RTN","PRSDSERV",34,0)
 K ERRMSG,FLD,FLDNUM,GNUM,GRP,GRPVAL,IEN,II,LPE,LTH,MO,MFLD,MTYPE,MULT
"RTN","PRSDSERV",35,0)
 K NAME,NODE,NODE459,PIC,PIECE,PIECE459,PP,PP455,PPIEN,PRSD,PRSDIEN,RCD
"RTN","PRSDSERV",36,0)
 K RTN,RTNNUM,RTYPE,SEQNUM,SSN,SSNLINE,STA,STA450,SUM,TMPIEN,TMPLINE
"RTN","PRSDSERV",37,0)
 K TIME,TYPE,X,XCNP,XMDUZ,XMSUB,XMTEXT,XMY,Y,YR,XMPOS,XMRG,XMER,XMLOC
"RTN","PRSDSERV",38,0)
 K XMMG,MNR,PDATE,CDATE,X1,X2
"RTN","PRSDSERV",39,0)
REMSB I $D(XMZ) S XMSER="S.PRSD" D REMSBMSG^XMA1C K XMSER
"RTN","PRSDSERV",40,0)
 Q
"RTN","PRSDSERV",41,0)
SSNLOOP D REC^XMS3
"RTN","PRSDSERV",42,0)
 S SSN=$S(TYPE="I":$P(XMRG,":",2),1:$E(XMRG,4,12))
"RTN","PRSDSERV",43,0)
 S SSN=$E("000000000",$L(SSN)+1,9)_SSN
"RTN","PRSDSERV",44,0)
 ; The last employee in the last MailMan message has a SSN=999999999
"RTN","PRSDSERV",45,0)
 ; This triggers the software to begin processing the download.
"RTN","PRSDSERV",46,0)
 I SSN=999999999 D  Q
"RTN","PRSDSERV",47,0)
 .I TYPE="I" K ^XTMP("PRS","ERR")
"RTN","PRSDSERV",48,0)
 .S ^XTMP("PRS","LSN",TYPE,DATE,STA)=SEQNUM
"RTN","PRSDSERV",49,0)
 .S:$D(PRSDIEN) $P(^PRSD(450.12,PRSDIEN,0),U,3)="S" H 600
"RTN","PRSDSERV",50,0)
 .D REMSB S ECNT=0 D START,START,^PRSDERR,^PRSDSTAT S SSN=999999999
"RTN","PRSDSERV",51,0)
 S (PDATE,CDATE)=$P(TIME,".",1),X1=PDATE,X2=90 D C^%DTC S PDATE=X
"RTN","PRSDSERV",52,0)
 S ^XTMP("PRS",0)=PDATE_"^"_CDATE
"RTN","PRSDSERV",53,0)
 K KFLG S XMPOS=XMPOS-1
"RTN","PRSDSERV",54,0)
 F B=1:1:LPE D REC^XMS3 I (($L(XMRG,":")-1)'=$L(XMRG))!(TYPE="I") S TMPLINE=$E("000",$L(XMPOS)+1,3)_XMPOS,^XTMP("PRS",SUB,DATE,TYPE,STA,SSN,XMZ_"-"_TMPLINE_"-"_B)=XMRG I TYPE="T",B=6 D TRANSCK^PRSDERR
"RTN","PRSDSERV",55,0)
 I $D(KFLG) K ^XTMP("PRS",SUB,DATE,TYPE,STA,SSN),KFLG
"RTN","PRSDSERV",56,0)
 Q
"RTN","PRSDSERV",57,0)
START ; Process download
"RTN","PRSDSERV",58,0)
 ; RTYPE is used to determine which series of routines to call to
"RTN","PRSDSERV",59,0)
 ; process the download
"RTN","PRSDSERV",60,0)
 S SSN="",RTYPE=$S(TYPE="I":"LD",(TYPE="E")!(TYPE="T"):"EU",TYPE="P":"PR",1:"")
"RTN","PRSDSERV",61,0)
 F  S SSN=$O(^XTMP("PRS",SUB,DATE,TYPE,STA,SSN)) Q:SSN=""  D
"RTN","PRSDSERV",62,0)
 . L +^XTMP("PRS",SUB,DATE,TYPE,STA,SSN):0
"RTN","PRSDSERV",63,0)
 . I $T D
"RTN","PRSDSERV",64,0)
 . . S TMPIEN=$O(^XTMP("PRS",SUB,DATE,TYPE,STA,SSN,""))
"RTN","PRSDSERV",65,0)
 . . I TMPIEN'="" D
"RTN","PRSDSERV",66,0)
 . . . S RCD=^(TMPIEN),ERRFLG=""
"RTN","PRSDSERV",67,0)
 . . . D SSN
"RTN","PRSDSERV",68,0)
 . . . D:ERRFLG'="Y" LDINIT,PROC,PROC2,LDFNL,LDCMP
"RTN","PRSDSERV",69,0)
 . . . D:ERRFLG="Y" TMPERR D UNL
"RTN","PRSDSERV",70,0)
 Q
"RTN","PRSDSERV",71,0)
 ; Piece together the routine name and call the routine
"RTN","PRSDSERV",72,0)
PROC S TMPIEN="" F  S TMPIEN=$O(^XTMP("PRS",SUB,DATE,TYPE,STA,SSN,TMPIEN)) Q:TMPIEN=""  S RCD=^XTMP("PRS",SUB,DATE,TYPE,STA,SSN,TMPIEN),RTNNUM=$P(TMPIEN,"-",3) S:$L(RTNNUM)=1 RTNNUM=0_RTNNUM S RTN="^PRSD"_RTYPE_RTNNUM D:$T(@RTN)]"" @RTN
"RTN","PRSDSERV",73,0)
 Q
"RTN","PRSDSERV",74,0)
PROC2 I TYPE="P",PP'="" D ^PRSDCOMP  ;Compute calculated fields
"RTN","PRSDSERV",75,0)
 S NODE=0 F EE=1:1 S NODE=$O(^PRSPC(IEN,NODE)) Q:NODE=""  I $D(^PRSPC(IEN,NODE))#2 S DATA=^PRSPC(IEN,NODE) I $L(DATA,U)-1=$L(DATA) K ^PRSPC(IEN,NODE)
"RTN","PRSDSERV",76,0)
 K ^XTMP("PRS",SUB,DATE,TYPE,STA,SSN) Q
"RTN","PRSDSERV",77,0)
TMPERR I TYPE="P",PP="" G TMPERR1
"RTN","PRSDSERV",78,0)
 S TMPIEN="" F  S TMPIEN=$O(^XTMP("PRS",SUB,DATE,TYPE,STA,SSN,TMPIEN)) Q:TMPIEN=""  S RCD=^XTMP("PRS",SUB,DATE,TYPE,STA,SSN,TMPIEN),^XTMP("PRS","ERR",DATE,TYPE,STA,SSN,TMPIEN)=RCD
"RTN","PRSDSERV",79,0)
TMPERR1 K ^XTMP("PRS",SUB,DATE,TYPE,STA,SSN) Q
"RTN","PRSDSERV",80,0)
UNL L -^XTMP("PRS",SUB,DATE,TYPE,STA,SSN) Q
"RTN","PRSDSERV",81,0)
SSN I TYPE="P",'$D(^PRSPC("SSN",SSN)) S ERRMSG="SSN "_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_" not found" D ERR Q
"RTN","PRSDSERV",82,0)
 I TYPE="I" S NAME=$P(RCD,":",4)
"RTN","PRSDSERV",83,0)
 I (TYPE="E")!(TYPE="T") S NAME=$P(RCD,":",2),DATA=$E(NAME,1,27) I DATA'="" D RTS^PRSDUTIL S NAME=DATA S:TYPE="T" ^TMP($J,"PRS",NAME,SSN)=""
"RTN","PRSDSERV",84,0)
 I '$D(^PRSPC("SSN",SSN)) D ^PRSDADD K DA,DIE,DR,OLDSSN,VAIEN,VANAME Q:ERRFLG="Y"  G SSNOUT
"RTN","PRSDSERV",85,0)
 S IEN=0,IEN=$O(^PRSPC("SSN",SSN,IEN))
"RTN","PRSDSERV",86,0)
SSNOUT I TYPE="P" D ^PRSDPTYP I PP="" S ERRFLG="Y" Q
"RTN","PRSDSERV",87,0)
 S ECNT=ECNT+1
"RTN","PRSDSERV",88,0)
 Q
"RTN","PRSDSERV",89,0)
ERR K DD,DO S DIC="^PRSD(450.11,",DIC(0)="L",X=TYPE_"-"_DATE_"-"_STA D FILE^DICN I Y>0 S $P(^PRSD(450.11,+Y,0),U,3)=ERRMSG
"RTN","PRSDSERV",90,0)
 S ERRFLG="Y"
"RTN","PRSDSERV",91,0)
 Q
"RTN","PRSDSERV",92,0)
LDINIT ; Load Initial Labor Distribution Values
"RTN","PRSDSERV",93,0)
 S LDINIT=$$LDLOAD()
"RTN","PRSDSERV",94,0)
 Q
"RTN","PRSDSERV",95,0)
LDFNL ; Load Final Labor Distribution Values
"RTN","PRSDSERV",96,0)
 S LDFNL=$$LDLOAD()
"RTN","PRSDSERV",97,0)
 Q
"RTN","PRSDSERV",98,0)
LDLOAD() ; Retrieve current Labor Distribution Values from #450
"RTN","PRSDSERV",99,0)
 ;
"RTN","PRSDSERV",100,0)
 N LD,LDCC,LDCODE,LDFCP,LDPCT,PRSLD
"RTN","PRSDSERV",101,0)
 S LD=""
"RTN","PRSDSERV",102,0)
 F PRSLD=1:1:4 D
"RTN","PRSDSERV",103,0)
 . S LDCODE=$$GET1^DIQ(450.0757,PRSLD_","_IEN,1)
"RTN","PRSDSERV",104,0)
 . S LDPCT=$$GET1^DIQ(450.0757,PRSLD_","_IEN,2)
"RTN","PRSDSERV",105,0)
 . S LDCC=$$GET1^DIQ(450.0757,PRSLD_","_IEN,3)
"RTN","PRSDSERV",106,0)
 . S LDFCP=$$GET1^DIQ(450.0757,PRSLD_","_IEN,4)
"RTN","PRSDSERV",107,0)
 . S LD=LD_LDCODE_U_LDPCT_U_LDCC_U_LDFCP_U
"RTN","PRSDSERV",108,0)
 Q LD
"RTN","PRSDSERV",109,0)
 ;
"RTN","PRSDSERV",110,0)
LDCMP ; Compare Initial and Final Labor Distribution for changes
"RTN","PRSDSERV",111,0)
 ; and update audit trail in #458 if necessary.
"RTN","PRSDSERV",112,0)
 Q:LDINIT=LDFNL
"RTN","PRSDSERV",113,0)
 N PPA,I,IENS,IENS1,INDX,J,LDA,PRSFDA,TLDPER
"RTN","PRSDSERV",114,0)
 ; Get IEN for current Pay Period
"RTN","PRSDSERV",115,0)
 S PPA=$P($G(^PRST(458,"AD",$P(TIME,".",1))),U,1)
"RTN","PRSDSERV",116,0)
 Q:PPA=""
"RTN","PRSDSERV",117,0)
 ;
"RTN","PRSDSERV",118,0)
 ; Get next multiple number
"RTN","PRSDSERV",119,0)
 S LDA="A",LDA=$O(^PRST(458,PPA,"E",IEN,"LDAUD",LDA),-1)
"RTN","PRSDSERV",120,0)
 S LDA=$S(LDA>0:LDA+1,1:1)
"RTN","PRSDSERV",121,0)
 ;
"RTN","PRSDSERV",122,0)
 ; Set Audit information into #450
"RTN","PRSDSERV",123,0)
 S DA=IEN,DIE="^PRSPC("
"RTN","PRSDSERV",124,0)
 S DR="755///^S X=$O(^VA(200,""B"",""CENTRAL,PAID"",0))"
"RTN","PRSDSERV",125,0)
 D ^DIE
"RTN","PRSDSERV",126,0)
 S DR="755.1///^S X=TYPE"
"RTN","PRSDSERV",127,0)
 D ^DIE
"RTN","PRSDSERV",128,0)
 S DR="756///^S X=TIME"
"RTN","PRSDSERV",129,0)
 D ^DIE
"RTN","PRSDSERV",130,0)
 ;
"RTN","PRSDSERV",131,0)
 ; If there is no entry for this employee in the Pay Period, create
"RTN","PRSDSERV",132,0)
 ; a record for them
"RTN","PRSDSERV",133,0)
 I '$D(^PRSPC(458,PPA,"E",IEN)) D
"RTN","PRSDSERV",134,0)
 . S IENS=","_PPA_","
"RTN","PRSDSERV",135,0)
 . S PRSFDA(458.01,"?+1"_IENS,.01)=IEN
"RTN","PRSDSERV",136,0)
 . D UPDATE^DIE("","PRSFDA")
"RTN","PRSDSERV",137,0)
 ;
"RTN","PRSDSERV",138,0)
 ; Set LD AUDIT record into #458.1105
"RTN","PRSDSERV",139,0)
 S IENS=","_IEN_IENS
"RTN","PRSDSERV",140,0)
 K PRSFDA
"RTN","PRSDSERV",141,0)
 S PRSFDA(458.1105,"?+1"_IENS,.01)=LDA
"RTN","PRSDSERV",142,0)
 S PRSFDA(458.1105,"?+1"_IENS,1)=TIME
"RTN","PRSDSERV",143,0)
 S PRSFDA(458.1105,"?+1"_IENS,2)=$O(^VA(200,"B","CENTRAL PAID",0))
"RTN","PRSDSERV",144,0)
 S PRSFDA(458.1105,"?+1"_IENS,3)=TYPE
"RTN","PRSDSERV",145,0)
 D UPDATE^DIE("","PRSFDA")
"RTN","PRSDSERV",146,0)
 ;
"RTN","PRSDSERV",147,0)
 ; Central PAID only sends LD fields that have changed.  Run check on 
"RTN","PRSDSERV",148,0)
 ; percentages and delete all LD fields in #450 after 99% has been reached
"RTN","PRSDSERV",149,0)
 S TLDPER=0
"RTN","PRSDSERV",150,0)
 F I=0:1:3 S TLDPER=TLDPER+$P(LDFNL,U,I*4+2) Q:TLDPER'<.99
"RTN","PRSDSERV",151,0)
 S J=(I+1)*4+1 ; Set counter for LDINIT
"RTN","PRSDSERV",152,0)
 F J=J:1:16 S $P(LDINIT,U,J)=""
"RTN","PRSDSERV",153,0)
 S I=I+2 ; Adjust counter for deletion of multiples
"RTN","PRSDSERV",154,0)
 K PRSFDA
"RTN","PRSDSERV",155,0)
 S DA(1)=IEN
"RTN","PRSDSERV",156,0)
 F I=I:1:4 D
"RTN","PRSDSERV",157,0)
 . S DA=I,DIK="^PRSPC("_DA(1)_",""LD"","
"RTN","PRSDSERV",158,0)
 . D ^DIK
"RTN","PRSDSERV",159,0)
 ;
"RTN","PRSDSERV",160,0)
 ; Set LABOR DISTRIBUTION (Multiple-458.11054)
"RTN","PRSDSERV",161,0)
 S LD=$O(^PRST(458,PPA,"E",IEN,"LDAUD",0))
"RTN","PRSDSERV",162,0)
 F PRSLD=0:1:3 D
"RTN","PRSDSERV",163,0)
 . S J=PRSLD+1
"RTN","PRSDSERV",164,0)
 . S IENS1="+"_J_","_LD_IENS
"RTN","PRSDSERV",165,0)
 . ; Don't record empty multiples
"RTN","PRSDSERV",166,0)
 . Q:$P(LDINIT,U,PRSLD*4+2)=""  ; PERCENT
"RTN","PRSDSERV",167,0)
 . K PRSFDA
"RTN","PRSDSERV",168,0)
 . S PRSFDA(458.11054,IENS1,.01)=PRSLD+1
"RTN","PRSDSERV",169,0)
 . S PRSFDA(458.11054,IENS1,1)=$P(LDINIT,U,PRSLD*4+1) ; CODE
"RTN","PRSDSERV",170,0)
 . S PRSFDA(458.11054,IENS1,2)=$P(LDINIT,U,PRSLD*4+2) ; PERCENT
"RTN","PRSDSERV",171,0)
 . S PRSFDA(458.11054,IENS1,3)=$P(LDINIT,U,PRSLD*4+3) ; COST CENTER
"RTN","PRSDSERV",172,0)
 . S PRSFDA(458.11054,IENS1,4)=$P(LDINIT,U,PRSLD*4+4) ; FUND CTRL PT
"RTN","PRSDSERV",173,0)
 . D UPDATE^DIE("","PRSFDA")
"RTN","PRSDSERV",174,0)
 K LDINIT,LDFNL
"RTN","PRSDSERV",175,0)
 Q
"VER")
8.0^22.0
"BLD",7484,6)
^104
**END**
**END**

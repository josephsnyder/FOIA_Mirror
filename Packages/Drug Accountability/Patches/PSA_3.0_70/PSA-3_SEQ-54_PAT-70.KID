Released PSA*3*70 SEQ #54
Extracted from mail message
**KIDS**:PSA*3.0*70^

**INSTALL NAME**
PSA*3.0*70
"BLD",7061,0)
PSA*3.0*70^DRUG ACCOUNTABILITY^0^3090217^y
"BLD",7061,1,0)
^^25^25^3081021^
"BLD",7061,1,1,0)
This patch addresses the following problems:
"BLD",7061,1,2,0)
 
"BLD",7061,1,3,0)
1.  HD257764 - UNDEF ERROR
"BLD",7061,1,4,0)
When editing the ORDER UNIT for a Supply Item of a verified order, the
"BLD",7061,1,5,0)
application errors with an undefined error.
"BLD",7061,1,6,0)
 
"BLD",7061,1,7,0)
2.  HD255967 - UNDEF ERROR <UNDEFINED>EDIT1+36^PSAUTL1
"BLD",7061,1,8,0)
During Order Processing if 2 users select same orders to process and 1
"BLD",7061,1,9,0)
user is editing an order, the application will error.
"BLD",7061,1,10,0)
 
"BLD",7061,1,11,0)
3. HD266899 - Error when running PSA IV ALL LOCATIONS
"BLD",7061,1,12,0)
When running the "Outdated Medications" report and it quits unexpectedly,
"BLD",7061,1,13,0)
the ^TMP("PSA",$J global is left behind causing the "PSA IV ALL LOCATIONS"
"BLD",7061,1,14,0)
option to error.
"BLD",7061,1,15,0)
 
"BLD",7061,1,16,0)
4. HD265183 - Blank Order Unit on zero qty received causes supplies
"BLD",7061,1,17,0)
              to appear on error report
"BLD",7061,1,18,0)
When an invoice contains a blank Order Unit and a zero quantity, all 
"BLD",7061,1,19,0)
supply items that follow, are included in the error report.
"BLD",7061,1,20,0)
 
"BLD",7061,1,21,0)
5. HD273421 - Cost Calculated Incorrectly on Outdated Meds
"BLD",7061,1,22,0)
The cost on the Items To Be Returned report should be calculating based
"BLD",7061,1,23,0)
on number of Dispense Units returned multiplied by Price Per Dispense
"BLD",7061,1,24,0)
Unit from file 50. Instead, it is multiplying the number of containers
"BLD",7061,1,25,0)
by the Price Per Dispense Unit:
"BLD",7061,4,0)
^9.64PA^^
"BLD",7061,6.3)
12
"BLD",7061,"ABPKG")
n
"BLD",7061,"KRN",0)
^9.67PA^8989.52^19
"BLD",7061,"KRN",.4,0)
.4
"BLD",7061,"KRN",.401,0)
.401
"BLD",7061,"KRN",.402,0)
.402
"BLD",7061,"KRN",.403,0)
.403
"BLD",7061,"KRN",.5,0)
.5
"BLD",7061,"KRN",.84,0)
.84
"BLD",7061,"KRN",3.6,0)
3.6
"BLD",7061,"KRN",3.8,0)
3.8
"BLD",7061,"KRN",9.2,0)
9.2
"BLD",7061,"KRN",9.8,0)
9.8
"BLD",7061,"KRN",9.8,"NM",0)
^9.68A^13^10
"BLD",7061,"KRN",9.8,"NM",4,0)
PSAOP3^^0^B2325842
"BLD",7061,"KRN",9.8,"NM",5,0)
PSAOUT^^0^B73425251
"BLD",7061,"KRN",9.8,"NM",6,0)
PSAVER3^^0^B72006337
"BLD",7061,"KRN",9.8,"NM",7,0)
PSAVERA^^0^B44615569
"BLD",7061,"KRN",9.8,"NM",8,0)
PSAVERA1^^0^B60705765
"BLD",7061,"KRN",9.8,"NM",9,0)
PSAVERA3^^0^B13969445
"BLD",7061,"KRN",9.8,"NM",10,0)
PSAPROC^^0^B77154032
"BLD",7061,"KRN",9.8,"NM",11,0)
PSAPROC1^^0^B41172320
"BLD",7061,"KRN",9.8,"NM",12,0)
PSAPROC2^^0^B71381092
"BLD",7061,"KRN",9.8,"NM",13,0)
PSAPROC8^^0^B67886786
"BLD",7061,"KRN",9.8,"NM","B","PSAOP3",4)

"BLD",7061,"KRN",9.8,"NM","B","PSAOUT",5)

"BLD",7061,"KRN",9.8,"NM","B","PSAPROC",10)

"BLD",7061,"KRN",9.8,"NM","B","PSAPROC1",11)

"BLD",7061,"KRN",9.8,"NM","B","PSAPROC2",12)

"BLD",7061,"KRN",9.8,"NM","B","PSAPROC8",13)

"BLD",7061,"KRN",9.8,"NM","B","PSAVER3",6)

"BLD",7061,"KRN",9.8,"NM","B","PSAVERA",7)

"BLD",7061,"KRN",9.8,"NM","B","PSAVERA1",8)

"BLD",7061,"KRN",9.8,"NM","B","PSAVERA3",9)

"BLD",7061,"KRN",19,0)
19
"BLD",7061,"KRN",19,"NM",0)
^9.68A^^
"BLD",7061,"KRN",19.1,0)
19.1
"BLD",7061,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",7061,"KRN",101,0)
101
"BLD",7061,"KRN",409.61,0)
409.61
"BLD",7061,"KRN",771,0)
771
"BLD",7061,"KRN",870,0)
870
"BLD",7061,"KRN",8989.51,0)
8989.51
"BLD",7061,"KRN",8989.52,0)
8989.52
"BLD",7061,"KRN",8994,0)
8994
"BLD",7061,"KRN","B",.4,.4)

"BLD",7061,"KRN","B",.401,.401)

"BLD",7061,"KRN","B",.402,.402)

"BLD",7061,"KRN","B",.403,.403)

"BLD",7061,"KRN","B",.5,.5)

"BLD",7061,"KRN","B",.84,.84)

"BLD",7061,"KRN","B",3.6,3.6)

"BLD",7061,"KRN","B",3.8,3.8)

"BLD",7061,"KRN","B",9.2,9.2)

"BLD",7061,"KRN","B",9.8,9.8)

"BLD",7061,"KRN","B",19,19)

"BLD",7061,"KRN","B",19.1,19.1)

"BLD",7061,"KRN","B",101,101)

"BLD",7061,"KRN","B",409.61,409.61)

"BLD",7061,"KRN","B",771,771)

"BLD",7061,"KRN","B",870,870)

"BLD",7061,"KRN","B",8989.51,8989.51)

"BLD",7061,"KRN","B",8989.52,8989.52)

"BLD",7061,"KRN","B",8994,8994)

"BLD",7061,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7061,"QUES",0)
^9.62^^
"BLD",7061,"REQB",0)
^9.611^8^5
"BLD",7061,"REQB",2,0)
PSA*3.0*42^1
"BLD",7061,"REQB",4,0)
PSA*3.0*60^1
"BLD",7061,"REQB",5,0)
PSA*3.0*63^1
"BLD",7061,"REQB",7,0)
PSA*3.0*68^1
"BLD",7061,"REQB",8,0)
PSA*3.0*64^1
"BLD",7061,"REQB","B","PSA*3.0*42",2)

"BLD",7061,"REQB","B","PSA*3.0*60",4)

"BLD",7061,"REQB","B","PSA*3.0*63",5)

"BLD",7061,"REQB","B","PSA*3.0*64",8)

"BLD",7061,"REQB","B","PSA*3.0*68",7)

"MBREQ")
0
"PKG",287,-1)
1^1
"PKG",287,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",287,20,0)
^9.402P^^
"PKG",287,22,0)
^9.49I^1^1
"PKG",287,22,1,0)
3.0^2971024^2971030^11595
"PKG",287,22,1,"PAH",1,0)
70^3090217^1611
"PKG",287,22,1,"PAH",1,1,0)
^^25^25^3090217
"PKG",287,22,1,"PAH",1,1,1,0)
This patch addresses the following problems:
"PKG",287,22,1,"PAH",1,1,2,0)
 
"PKG",287,22,1,"PAH",1,1,3,0)
1.  HD257764 - UNDEF ERROR
"PKG",287,22,1,"PAH",1,1,4,0)
When editing the ORDER UNIT for a Supply Item of a verified order, the
"PKG",287,22,1,"PAH",1,1,5,0)
application errors with an undefined error.
"PKG",287,22,1,"PAH",1,1,6,0)
 
"PKG",287,22,1,"PAH",1,1,7,0)
2.  HD255967 - UNDEF ERROR <UNDEFINED>EDIT1+36^PSAUTL1
"PKG",287,22,1,"PAH",1,1,8,0)
During Order Processing if 2 users select same orders to process and 1
"PKG",287,22,1,"PAH",1,1,9,0)
user is editing an order, the application will error.
"PKG",287,22,1,"PAH",1,1,10,0)
 
"PKG",287,22,1,"PAH",1,1,11,0)
3. HD266899 - Error when running PSA IV ALL LOCATIONS
"PKG",287,22,1,"PAH",1,1,12,0)
When running the "Outdated Medications" report and it quits unexpectedly,
"PKG",287,22,1,"PAH",1,1,13,0)
the ^TMP("PSA",$J global is left behind causing the "PSA IV ALL LOCATIONS"
"PKG",287,22,1,"PAH",1,1,14,0)
option to error.
"PKG",287,22,1,"PAH",1,1,15,0)
 
"PKG",287,22,1,"PAH",1,1,16,0)
4. HD265183 - Blank Order Unit on zero qty received causes supplies
"PKG",287,22,1,"PAH",1,1,17,0)
              to appear on error report
"PKG",287,22,1,"PAH",1,1,18,0)
When an invoice contains a blank Order Unit and a zero quantity, all 
"PKG",287,22,1,"PAH",1,1,19,0)
supply items that follow, are included in the error report.
"PKG",287,22,1,"PAH",1,1,20,0)
 
"PKG",287,22,1,"PAH",1,1,21,0)
5. HD273421 - Cost Calculated Incorrectly on Outdated Meds
"PKG",287,22,1,"PAH",1,1,22,0)
The cost on the Items To Be Returned report should be calculating based
"PKG",287,22,1,"PAH",1,1,23,0)
on number of Dispense Units returned multiplied by Price Per Dispense
"PKG",287,22,1,"PAH",1,1,24,0)
Unit from file 50. Instead, it is multiplying the number of containers
"PKG",287,22,1,"PAH",1,1,25,0)
by the Price Per Dispense Unit:
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","PSAOP3")
0^4^B2325842^B2157207
"RTN","PSAOP3",1,0)
PSAOP3 ;BIR/LTL,JMB-Nightly Background Job ;7/23/97
"RTN","PSAOP3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,70**; 10/24/97;Build 12
"RTN","PSAOP3",3,0)
 ;This is the entry point to gather outpatient pharmacy dispensing data
"RTN","PSAOP3",4,0)
 ;for all drugs in all pharmacy locations. When the drug is released in
"RTN","PSAOP3",5,0)
 ;outpatient, an ^XTMP("PSA") global is set to contain the dispensing
"RTN","PSAOP3",6,0)
 ;data. It is called by PSAPSI3.
"RTN","PSAOP3",7,0)
 ;^XTMP("PSA",59.7 OP Site#,50 Drug#,Date dispensed)=Total Qty Dispensed
"RTN","PSAOP3",8,0)
 ;
"RTN","PSAOP3",9,0)
 N PSA,PSADRUG,PSALOC ;PSA=OP SITE, PSA(1)=DRUG(IEN), PSA(2)=DT
"RTN","PSAOP3",10,0)
LUP S PSA=0 F  S PSA=$O(^XTMP("PSA",PSA)) Q:'PSA  D
"RTN","PSAOP3",11,0)
 .S PSA(1)=0 F  S PSA(1)=$O(^XTMP("PSA",PSA,PSA(1))) Q:'PSA(1)  D
"RTN","PSAOP3",12,0)
 ..S PSA(2)=0 F  S PSA(2)=$O(^XTMP("PSA",PSA,PSA(1),PSA(2))) Q:'PSA(2)  D
"RTN","PSAOP3",13,0)
 ...S PSALOC=$O(^PSD(58.8,"AOP",PSA,0)),PSADRUG=PSA(1)
"RTN","PSAOP3",14,0)
 ...Q:'$G(PSALOC)  ;; Added check to PSALOC PSA*3*70
"RTN","PSAOP3",15,0)
 ...;PSA*3*21 (due to multiple OP locations, check for Inactive - Dave B)
"RTN","PSAOP3",16,0)
 ...I $P($G(^PSD(58.8,PSALOC,7,PSA,0)),"^",2)'="" Q
"RTN","PSAOP3",17,0)
 ...S PSA(3)=$G(^XTMP("PSA",PSA,PSA(1),PSA(2)))
"RTN","PSAOP3",18,0)
 ...D:$D(^PSD(58.8,+PSALOC,1,PSADRUG))&($P($G(^PSD(58.8,+PSALOC,0)),U,2)="P") ^PSAOP1
"RTN","PSAOP3",19,0)
 ...K ^XTMP("PSA",PSA,PSA(1),PSA(2))
"RTN","PSAOP3",20,0)
 S X1=DT,X2=7 D C^%DTC S ^XTMP("PSA",0)=X_"^"_DT_"^Drug Accountability Dispensing Data"
"RTN","PSAOP3",21,0)
QUIT Q
"RTN","PSAOUT")
0^5^B73425251^B72887272
"RTN","PSAOUT",1,0)
PSAOUT ;BHM/DB/PWC - Return Drugs to Manufacturer ;23 FEB 04
"RTN","PSAOUT",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**51,64,68,70**; 10/24/97;Build 12
"RTN","PSAOUT",3,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAOUT",4,0)
 ;References to ^DIC(51.5 are covered by DBIA # 1931
"RTN","PSAOUT",5,0)
 ;References to ^PSRX( are covered by DBIA # 254
"RTN","PSAOUT",6,0)
 ;References to ^PSD(58.86 are covered by DBIA # 4472
"RTN","PSAOUT",7,0)
 S PSACNT=0
"RTN","PSAOUT",8,0)
 D Q
"RTN","PSAOUT",9,0)
 K DIR S DIR(0)="S^1:Print Report;2:Enter drugs Return to Manufacturer" D ^DIR K DIR G Q:$D(DIRUT) I +Y=1 G RPT
"RTN","PSAOUT",10,0)
 D ORDER^PSALOC   ; PSA*3*68 will now ask the Dispense Location
"RTN","PSAOUT",11,0)
1 ;Select Drug
"RTN","PSAOUT",12,0)
 K PSAINDX,PSADRG
"RTN","PSAOUT",13,0)
 R !!,"Scan Drug barcode or enter a drug name : ",AN:DTIME S PSACNT=$G(PSACNT)+1 G DONE:AN["^" G DONE:AN="" I AN=" " W "??" G 1
"RTN","PSAOUT",14,0)
 I $D(^PSDRUG("NDC",AN)) S PSANDC=AN D NDC G:$G(DUOUT) DONE G:$G(PSADRG) FOUND
"RTN","PSAOUT",15,0)
 I $D(^PSDRUG("C",AN)),$G(PSAINDX)'="NDC" D INDEX G:$G(DUOUT) DONE G:$G(PSADRG) FOUND
"RTN","PSAOUT",16,0)
 I AN["-",$P(AN,"-",3)'="",$G(PSAINDX)'="NDC" D NDC G:$G(DUOUT) DONE G:$G(PSADRG) FOUND
"RTN","PSAOUT",17,0)
 I AN["-",$P(AN,"-",2)'="",$P(AN,"-",3)="" S PSARX=$P(AN,"-",2),PSADRG=$P($G(^PSRX(PSARX,0)),"^",6) I $G(PSADRG)>0 G FOUND
"RTN","PSAOUT",18,0)
 I AN?.AN,$D(^PSDRUG(AN,0)) S PSADRG=AN G FOUND
"RTN","PSAOUT",19,0)
 I $G(PSAINDX)'["C" D  G:$G(DUOUT) DONE G:$G(PSADRG) FOUND
"RTN","PSAOUT",20,0)
 .S X=AN,DIC(0)="EQMZ",DIC("A")="Select Drug : ",DIC("S")="I $S('$D(^(""I"")):1,+^(""I"")>DT:1,1:0),$P($G(^(2)),""^"",3)'[""N""",DIC="^PSDRUG(" D ^DIC S:+Y>0 PSADRG=+Y K DIC
"RTN","PSAOUT",21,0)
 W !!,"Sorry, I could not find a match. Please enter the drug name.",!! G 1
"RTN","PSAOUT",22,0)
FOUND ;Might have match
"RTN","PSAOUT",23,0)
 S PSADRUGN=$P($G(^PSDRUG(PSADRG,0)),"^") W " ",$G(PSADRUGN) S DIC("B")=PSADRUGN
"RTN","PSAOUT",24,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" W !!,"Sorry, Controlled Substances cannot be selected through this option." K PSADRG,PSADRUGN,X,AN G 1
"RTN","PSAOUT",25,0)
OK K DIR S DIR("A")="Is this correct",DIR(0)="Y",DIR("B")="YES" D ^DIR G DONE:$D(DIRUT)
"RTN","PSAOUT",26,0)
 I +Y>0 G PROCEED
"RTN","PSAOUT",27,0)
 G 1
"RTN","PSAOUT",28,0)
 Q
"RTN","PSAOUT",29,0)
PROCEED ;On to the next series of questions
"RTN","PSAOUT",30,0)
CON K DIR S DIR(0)="N",DIR("A")="Number of containers " D ^DIR K DIR S PSACON=+Y I $D(DIRUT) G DONE
"RTN","PSAOUT",31,0)
 K PSAOU
"RTN","PSAOUT",32,0)
 S PSAOU=$P($G(^PSDRUG(PSADRG,"660")),"^",2) I $G(PSAOU)>0 S PSAOU(1)=$P(^DIC(51.5,PSAOU,0),"^")
"RTN","PSAOUT",33,0)
 S PSAPDUOU=$P($G(^PSDRUG(PSADRG,660)),"^",6)
"RTN","PSAOUT",34,0)
QTY K DIR S DIR(0)="N",DIR("A")="Number of Dispense units being returned: " D ^DIR G DONE:$D(DIRUT)>0 S PSAQTY=Y
"RTN","PSAOUT",35,0)
OU K DIC,Y,X S DIC(0)="QAEMZ",DIC="^DIC(51.5,",DIC("A")="Package type: ",DR=.01 S:$G(PSAOU(1))'="" DIC("B")=PSAOU(1) D ^DIC K DIC I +Y<0 G DONE
"RTN","PSAOUT",36,0)
 S PSAOU(1)=Y(0)
"RTN","PSAOUT",37,0)
 K DIR S DIR("A")="Is it ok to file the data entered",DIR(0)="Y",DIR("B")="YES" D ^DIR K DIR G Q:$D(DIRUT) I Y'>0 W !,"ok, try again,",! G CON
"RTN","PSAOUT",38,0)
 W !,"Updating Destruction holding file."
"RTN","PSAOUT",39,0)
 F  L +^PSD(58.86,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAOUT",40,0)
FIND S PSAHLD=$P(^PSD(58.86,0),"^",3)+1 I $D(^PSD(58.86,PSAHLD)) S $P(^PSD(58.86,0),"^",3)=PSAHLD G FIND
"RTN","PSAOUT",41,0)
 D NOW^%DTC S PSADT=%
"RTN","PSAOUT",42,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.86,DIC(0)="L",(X,DINUM)=PSAHLD D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSAOUT",43,0)
 L -^PSD(58.86,0)
"RTN","PSAOUT",44,0)
 W !,"Updating Drug Accountability Transaction file."
"RTN","PSAOUT",45,0)
PSTRAN S PSAIEN=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAIEN)) S $P(^PSD(58.81,0),"^",3)=PSAIEN G PSTRAN
"RTN","PSAOUT",46,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYG0=58.81,(DINUM,X)=PSAIEN D ^DIC K DIC,DLAYGO
"RTN","PSAOUT",47,0)
 S DIE="^PSD(58.81,",DA=PSAIEN,DR="1////^S X=10;3////^S X=PSADT;4////^S X=PSADRG;6////^S X=DUZ;47////^S X=PSAHLD" D ^DIE
"RTN","PSAOUT",48,0)
UPDT K DA,DIE,DR S DIE=58.86,DA=PSAHLD,DR="1////"_+PSADRG_";2////"_PSAQTY_";11////"_PSACON_";12////"_$P(PSAOU(1),U,1)_";9////^S X=DUZ;10////^S X=PSADT;6////^S X=PSALOC;19////^S X=$G(PSAPDUOU)"
"RTN","PSAOUT",49,0)
 I +PSADRG=99999999 S ^PSD(58.86,DA,1)=PSADRUGN
"RTN","PSAOUT",50,0)
 D ^DIE K DIE,DA,DR S ^PSD(58.86,PSAHLD,2)="Returned to Manufacturer"
"RTN","PSAOUT",51,0)
 S ^XTMP("PSAOUT",$J,PSACNT)=PSADRG_"^"_PSAQTY_"^"_PSAOU_"^"_PSACON
"RTN","PSAOUT",52,0)
 W !!!!!!! K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y G DONE
"RTN","PSAOUT",53,0)
 G 1
"RTN","PSAOUT",54,0)
 Q
"RTN","PSAOUT",55,0)
NDC ;DRUG LOOKUP USING THE NDC INDEX
"RTN","PSAOUT",56,0)
 N PSAOUT,TMP1,Y,DIR
"RTN","PSAOUT",57,0)
 S PSAINDX="NDC"
"RTN","PSAOUT",58,0)
 I '$G(PSANDC),AN["-" S PSANDC=$P(AN,"-")_$P(AN,"-",2)_$P(AN,"-",3)
"RTN","PSAOUT",59,0)
 Q:'$O(^PSDRUG("NDC",PSANDC,0))
"RTN","PSAOUT",60,0)
 D FIND^DIC(50,"","","",PSANDC,"","NDC","","","PSAOUT")
"RTN","PSAOUT",61,0)
 I $P(PSAOUT("DILIST","0"),"^")=1 S PSADRG=$G(PSAOUT("DILIST","2",1))
"RTN","PSAOUT",62,0)
 I $P(PSAOUT("DILIST","0"),"^")>1 D
"RTN","PSAOUT",63,0)
 .S TMP1=0
"RTN","PSAOUT",64,0)
 .F  S TMP1=$O(PSAOUT("DILIST",1,TMP1)) Q:TMP1=""  D
"RTN","PSAOUT",65,0)
 ..W !,?5,TMP1,?9,AN,"  ",$G(PSAOUT("DILIST",1,TMP1)),"            ",$G(PSAOUT("DILIST","ID",TMP1,25))
"RTN","PSAOUT",66,0)
 .S DIR(0)="NO^1:"_$P(PSAOUT("DILIST","0"),"^") D ^DIR
"RTN","PSAOUT",67,0)
 .I '$G(DUOUT),$G(Y)>0 S PSADRG=$P(PSAOUT("DILIST",2,+Y),"^")
"RTN","PSAOUT",68,0)
 Q
"RTN","PSAOUT",69,0)
INDEX ;DRUG FILE LOOKUP USING "C" INDEX
"RTN","PSAOUT",70,0)
 N PSAOUT,TMP1,Y,DIR
"RTN","PSAOUT",71,0)
 S PSAINDX="C"
"RTN","PSAOUT",72,0)
 D FIND^DIC(50,"","","",AN,"","C","","","PSAOUT")
"RTN","PSAOUT",73,0)
 I $P(PSAOUT("DILIST","0"),"^")=1 S PSADRG=$G(PSAOUT("DILIST","2",1))
"RTN","PSAOUT",74,0)
 I $P(PSAOUT("DILIST","0"),"^")>1 D
"RTN","PSAOUT",75,0)
 .S TMP1=0
"RTN","PSAOUT",76,0)
 .F  S TMP1=$O(PSAOUT("DILIST",1,TMP1)) Q:TMP1=""  D
"RTN","PSAOUT",77,0)
 ..W !,?5,TMP1,?9,AN,"  ",$G(PSAOUT("DILIST",1,TMP1)),"            ",$G(PSAOUT("DILIST","ID",TMP1,25))
"RTN","PSAOUT",78,0)
 .S DIR(0)="NO^1:"_$P(PSAOUT("DILIST","0"),"^") D ^DIR
"RTN","PSAOUT",79,0)
 .I '$G(DUOUT),$G(Y)>0 S PSADRG=$P(PSAOUT("DILIST",2,+Y),"^")
"RTN","PSAOUT",80,0)
 I $G(Y)'>0 S X=AN,DIC(0)="EQMZ",DIC("A")="Select Drug : ",DIC("S")="I $S('$D(^(""I"")):1,+^(""I"")>DT:1,1:0),$P($G(^(2)),""^"",3)'[""N""",DIC="^PSDRUG(" D ^DIC Q:+Y'>0  S PSADRG=+Y K DIC
"RTN","PSAOUT",81,0)
 Q
"RTN","PSAOUT",82,0)
DONE I $G(PSACNT)'>0 G Q
"RTN","PSAOUT",83,0)
 K DIR S DIR("A")="Would you like to print the returns report ",DIR(0)="Y",DIR("B")="YES" D ^DIR G Q:$D(DIRUT)>0 I Y'>0 G Q
"RTN","PSAOUT",84,0)
RPT ;print report
"RTN","PSAOUT",85,0)
 W !,"If you are returning the items to the manufacturer at this time, the program",!,"will add today's date to the item to show when it was actually returned.",!
"RTN","PSAOUT",86,0)
 K DIR S DIR("A")="Are you returning items to the manufacturer at this time",DIR(0)="Y",DIR("B")="YES" D ^DIR G Q:$D(DIRUT)>0 I Y>0 S PSARET=1
"RTN","PSAOUT",87,0)
 D NOW^%DTC S X1=X,X2=-90 D C^%DTC S Y=X D DD^%DT S %DT("B")=Y
"RTN","PSAOUT",88,0)
BGNDT S %DT="AEP",%DT("A")="Beginning Date: " D ^%DT I +Y<1!($D(DTOUT))!(X["^")!(X']"") G Q
"RTN","PSAOUT",89,0)
 S PSABEG=+Y
"RTN","PSAOUT",90,0)
ENDDT D NOW^%DTC S Y=+% D DD^%DT S %DT("B")=$P(Y,"@"),%DT="AE",%DT("A")="Ending Date   : " D ^%DT I +Y<1!($D(DTOUT))!(X["^")!(X']"") S PSAOUT=1 G Q
"RTN","PSAOUT",91,0)
 I Y<PSABEG W !!,"Ending Date cannot be before the Start Date." G ENDDT
"RTN","PSAOUT",92,0)
 S PSAEND=+Y
"RTN","PSAOUT",93,0)
 K IO("Q") S %ZIS="Q" W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED.",! G Q
"RTN","PSAOUT",94,0)
 I $D(IO("Q")) K ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAOUT",ZTDTH=$H,ZTDESC="PSA OUTDATED REPORT" F X="PSARET","PSABEG","PSAEND" S ZTSAVE(X)=""
"RTN","PSAOUT",95,0)
 I  D ^%ZTLOAD,HOME^%ZIS G Q
"RTN","PSAOUT",96,0)
 U IO
"RTN","PSAOUT",97,0)
START ;
"RTN","PSAOUT",98,0)
 K ^XTMP("PSAOUT",$J) S PG=0
"RTN","PSAOUT",99,0)
 S Y=PSABEG,PSADT=PSABEG-.1 D DD^%DT S PSABEG(1)=Y
"RTN","PSAOUT",100,0)
 S Y=PSAEND D DD^%DT S PSAEND(1)=Y,PSAEND=PSAEND+.999999
"RTN","PSAOUT",101,0)
 D NOW^%DTC S PSARETD=$P(%,"."),^XTMP("PSAOUT",$J,0)=PSARETD_"^"_PSARETD,Y=PSARETD
"RTN","PSAOUT",102,0)
 D DD^%DT S PSARETD=Y K Y
"RTN","PSAOUT",103,0)
LOOP ;Loop through "AC" xref
"RTN","PSAOUT",104,0)
 ;^PSD(58.86,"AC",DATE/TIME DESTROYED,DISPENSING SITE,DRUG,DA)=""
"RTN","PSAOUT",105,0)
 S PSADT=$O(^PSD(58.86,"AC",PSADT)) G BEGIN:PSADT'>0 G BEGIN:PSADT>PSAEND
"RTN","PSAOUT",106,0)
 S PSALOC1=0
"RTN","PSAOUT",107,0)
LOC S PSALOC1=$O(^PSD(58.86,"AC",PSADT,PSALOC1)) G LOOP:PSALOC1'>0 G LOOP:PSALOC1'>0 S PSADRG=0
"RTN","PSAOUT",108,0)
DRG S PSADRG=$O(^PSD(58.86,"AC",PSADT,PSALOC1,PSADRG)) G LOC:PSADRG'>0 S PSAIEN=0
"RTN","PSAOUT",109,0)
IEN S PSAIEN=$O(^PSD(58.86,"AC",PSADT,PSALOC1,PSADRG,PSAIEN)) G DRG:PSAIEN'>0
"RTN","PSAOUT",110,0)
 S PSADATA=$G(^PSD(58.86,PSAIEN,0)),PSADATA2=$G(^PSD(58.86,PSAIEN,2))
"RTN","PSAOUT",111,0)
 I $E(PSADATA2,1,3)'="Ret" G IEN
"RTN","PSAOUT",112,0)
 F X=1:1:14 S PSA(X)=$P(PSADATA,"^",X)
"RTN","PSAOUT",113,0)
 I $G(PSA(2))=99999999 S PSA(2)=$G(^PSD(58.86,PSAIEN,1))
"RTN","PSAOUT",114,0)
 S ^XTMP("PSAOUT",$J,PSA(7),PSA(1))=PSA(8)_"^"_PSA(2)_"^"_PSA(3)_"^"_PSA(10)_"^"_PSA(9)_"^"_PSADT_"^"_$G(^PSD(58.86,PSAIEN,2))_"^"_PSA(12)_"^"_PSA(14)
"RTN","PSAOUT",115,0)
 I $G(PSARET)=1,$G(^PSD(58.86,PSAIEN,2))'["on" S ^PSD(58.86,PSAIEN,2)=^PSD(58.86,PSAIEN,2)_" on "_PSARETD
"RTN","PSAOUT",116,0)
 G IEN
"RTN","PSAOUT",117,0)
PRINT ;Print data
"RTN","PSAOUT",118,0)
 S PG=$G(PG)+1 W @IOF,!!!,?25,"Items to be Returned Report",?70,"Page : ",$G(PG)
"RTN","PSAOUT",119,0)
 W !,?24,PSABEG(1)," thru ",PSAEND(1)
"RTN","PSAOUT",120,0)
 I $G(PSALOC) S PSALL1=$P(^PSD(58.8,PSALOC,0),"^",3),PSALOCM=$P(^PSD(58.8,PSALOC,0),"^",1)_" - "_$S(PSALL1'="":$P(^PS(59.4,PSALL1,0),"^"),1:"") W !,?40-($L(PSALOCM)/2),PSALOCM
"RTN","PSAOUT",121,0)
 W !,"Printed on: ",PSADT(1),?50,"Printed by: ",$P($G(^VA(200,DUZ,0)),"^"),!
"RTN","PSAOUT",122,0)
 F X=1:1:((IOM/2)-2) W "- "
"RTN","PSAOUT",123,0)
 W !,?50,"Total Dispense"
"RTN","PSAOUT",124,0)
 W !,"Drug Name",?30,"Containers",?50,"Units / Cost",?66,"Entered by",! F X=1:1:(IOM-1) W "-"
"RTN","PSAOUT",125,0)
 Q
"RTN","PSAOUT",126,0)
BEGIN D NOW^%DTC S Y=+% D DD^%DT S PSADT(1)=Y
"RTN","PSAOUT",127,0)
 ; added to print by location and then date PSA*3*68
"RTN","PSAOUT",128,0)
 ; Changed ^XTMP("PSA" to ^XTMP("PSAOUT"  PSA*3*70
"RTN","PSAOUT",129,0)
 S PSALOC=0 F X=1:1 S PSALOC=$O(^XTMP("PSAOUT",$J,PSALOC)) Q:PSALOC'>0  G EORPT:$G(PSAOUT)=1  D
"RTN","PSAOUT",130,0)
 . S PSAIEN=0,PG=0 D PRINT
"RTN","PSAOUT",131,0)
 . F XX=1:1 S PSAIEN=$O(^XTMP("PSAOUT",$J,PSALOC,PSAIEN)) Q:PSAIEN'>0  D
"RTN","PSAOUT",132,0)
 .. S PSADATA=^XTMP("PSAOUT",$J,PSALOC,PSAIEN),PSADRUGN=$P(PSADATA,"^",2)
"RTN","PSAOUT",133,0)
 .. W !,$S('$D(^PSDRUG(PSADRUGN,0)):PSADRUGN,1:$P(^PSDRUG(PSADRUGN,0),"^"))
"RTN","PSAOUT",134,0)
 .. I $L(PSADRUGN)>37 W !
"RTN","PSAOUT",135,0)
 .. W ?38,$J($P(PSADATA,"^",1),2)," (",$P(PSADATA,"^",8),")",?50,$J($P(PSADATA,"^",3),3)
"RTN","PSAOUT",136,0)
 .. I $P(PSADATA,"^",9)]"",$P(PSADATA,"^",1)]"" W ?55,$J(($P(PSADATA,"^",3)*$P(PSADATA,"^",9)),5,2)
"RTN","PSAOUT",137,0)
 .. S PSANAME=$S($P(PSADATA,"^",4)']"":"",1:$P($G(^VA(200,$P(PSADATA,"^",4),0)),"^"))
"RTN","PSAOUT",138,0)
 .. I PSANAME'="" S PSANM1=$P(PSANAME,",",1),PSANM2=$P(PSANAME,",",2),PSANAME=$E(PSANM2,1)_$E(PSANM1,1)
"RTN","PSAOUT",139,0)
 .. W ?64,PSANAME S DATA=$P(PSADATA,"^",6),X2=$E(DATA,1,3)+1700
"RTN","PSAOUT",140,0)
 .. W " (",$E(DATA,4,5),"/",$E(DATA,6,7),"/",$E(X2,3,4),")"
"RTN","PSAOUT",141,0)
 .. I $Y>(IOSL-5) D HDR
"RTN","PSAOUT",142,0)
 . I $O(^XTMP("PSAOUT",$J,PSALOC)),($E(IOST,1,2)="C-") W ! K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSAOUT",143,0)
EORPT W !!,"End of report" D ^%ZISC
"RTN","PSAOUT",144,0)
Q K AN,DA,DATA,DIC,DIR,DIE,DIRUT,DLAYG0,DR,DTOUT,DUOUT,PG,PSA,PSABEG,PSACHK,PSACNT,PSACOMB,PSACON,PSADATA,PSADATA2,PSADRG
"RTN","PSAOUT",145,0)
 K PSADRUGN,PSADT,PSAEND,PSAHLD,PSAIEN,PSAINDX,PSAISITN,PSAITY,PSALOC,PSALOCA,PSALOC1,PSALOCN,PSAMNU,PSANAME,PSANDC,PSANM1,PSANM2
"RTN","PSAOUT",146,0)
 K PSANUM,PSAONE,PSAOU,PSALOCM,PSAPDUOU,PSAOUT,PSAQTY,PSARET,PSARETD,PSARX,PSAOSITN,PSALOCM,PSALL1,X,XX,X1,X2,Y,^XTMP("PSAOUT",$J) Q
"RTN","PSAOUT",147,0)
NONDRUG W !,"The item could not be found in the drug file.",!
"RTN","PSAOUT",148,0)
 K DIR S DIR("A")="Is this a non-va drug",DIR(0)="Y",DIR("B")="NO" D ^DIR K DIR G Q:$D(DIRUT)=1
"RTN","PSAOUT",149,0)
 I +Y'>0 G 1
"RTN","PSAOUT",150,0)
 S PSADRG=99999999,PSADRUGN=AN
"RTN","PSAOUT",151,0)
ASKD W !,PSADRUGN," //" R AN:DTIME I AN="" G CON
"RTN","PSAOUT",152,0)
 G Q:AN["^" S PSADRUGN=AN W " ok, press ENTER to confirm.",! G ASKD
"RTN","PSAOUT",153,0)
HDR I $E(IOST,1,2)="C-",PG W ! K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAOUT",154,0)
 D PRINT Q
"RTN","PSAPROC")
0^10^B77154032^B76150646
"RTN","PSAPROC",1,0)
PSAPROC ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data ;10/9/97
"RTN","PSAPROC",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,21,70**; 10/24/97;Build 12
"RTN","PSAPROC",3,0)
 ;This routine assigns a pharmacy location or master vault to all invoices.
"RTN","PSAPROC",4,0)
 ;
"RTN","PSAPROC",5,0)
 N PSALCK S (PSALCK,PSAOUT)=1 D EXIT K PSAOUT,PSALCK ;Kill all option variables
"RTN","PSAPROC",6,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSAPROC",7,0)
ESIG D SIG^XUSESIG I X1="" S PSAOUT=1 G EXIT
"RTN","PSAPROC",8,0)
 S PSASLN="",$P(PSASLN,"-",80)="",PSADLN="",$P(PSADLN,"=",80)="",(PSACNT,PSACTRL,PSAOUT)=0
"RTN","PSAPROC",9,0)
 ;DAVE B (PSA*3*12) 12MAY99 Multi-divisional select
"RTN","PSAPROC",10,0)
 D DAVE
"RTN","PSAPROC",11,0)
 ;
"RTN","PSAPROC",12,0)
CNT ;Count invoices that need a pharm location or master vault assigned.
"RTN","PSAPROC",13,0)
 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC",14,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",15,0)
 .I $G(PSASORT)'=0,$G(PSASORT)'="",$D(^XTMP("PSAPV",PSACTRL,"ST")),$P(^XTMP("PSAPV",PSACTRL,"ST"),"^",1)'=PSASORT Q
"RTN","PSAPROC",16,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC",17,0)
 .;DAVE B (PSA*3*21)
"RTN","PSAPROC",18,0)
 .K PSAINVDL D ^PSAPTCH Q:$D(PSAINVDL)
"RTN","PSAPROC",19,0)
 .I $P(PSAIN,"^",10)="ALL CS",$P(PSAIN,"^",12)="" S PSACNT=PSACNT+1,PSACS(PSACTRL)="" Q
"RTN","PSAPROC",20,0)
 .I $P(PSAIN,"^",10)'="ALL CS" D
"RTN","PSAPROC",21,0)
 ..I $P(PSAIN,"^",9)="CS" S:$P(PSAIN,"^",7)="" PSANCS(PSACTRL)="" S:$P(PSAIN,"^",12)="" PSACS(PSACTRL)="" S:$P(PSAIN,"^",7)=""!($P(PSAIN,"^",12)="") PSACNT=PSACNT+1 Q
"RTN","PSAPROC",22,0)
 ..I $P(PSAIN,"^",9)="",$P(PSAIN,"^",7)="" S PSACNT=PSACNT+1,PSANCS(PSACTRL)=""
"RTN","PSAPROC",23,0)
 I 'PSACNT D ^PSAPROC1 G EXIT
"RTN","PSAPROC",24,0)
 ;
"RTN","PSAPROC",25,0)
LOC ;Gets pharmacy locations
"RTN","PSAPROC",26,0)
 S (PSALOC,PSANUM)=0 F  S PSALOC=+$O(^PSD(58.8,"ADISP","P",PSALOC)) Q:'PSALOC  D
"RTN","PSAPROC",27,0)
 .Q:'$D(^PSD(58.8,PSALOC,0))!($P($G(^PSD(58.8,PSALOC,0)),"^")="")
"RTN","PSAPROC",28,0)
 .I +$G(^PSD(58.8,PSALOC,"I")),+^PSD(58.8,PSALOC,"I")'>DT Q
"RTN","PSAPROC",29,0)
 .S PSANUM=PSANUM+1,PSAONE=PSALOC,PSAISIT=+$P(^PSD(58.8,PSALOC,0),"^",3),PSAOSIT=+$P(^(0),"^",10)
"RTN","PSAPROC",30,0)
 .D SITES^PSAUTL1 S PSACOMB=$S('$D(PSACOMB):"NO COMBINED IP/OP",1:PSACOMB),PSALOCA($P(^PSD(58.8,PSALOC,0),"^")_PSACOMB,PSALOC)=PSAISIT_"^"_PSAOSIT
"RTN","PSAPROC",31,0)
 ;
"RTN","PSAPROC",32,0)
 ;Gets master vaults
"RTN","PSAPROC",33,0)
 S (PSAMVN,PSAMV)=0 F  S PSAMV=+$O(^PSD(58.8,"ADISP","M",PSAMV)) Q:'PSAMV  D
"RTN","PSAPROC",34,0)
 .Q:'$D(^PSD(58.8,PSAMV,0))!($P($G(^PSD(58.8,PSAMV,0)),"^")="")
"RTN","PSAPROC",35,0)
 .I +$G(^PSD(58.8,PSAMV,"I")),+^PSD(58.8,PSAMV,"I")'>DT Q
"RTN","PSAPROC",36,0)
 .S PSAMVN=PSAMVN+1,PSAONEMV=PSAMV,PSAMV($P(^PSD(58.8,PSAMV,0),"^"),PSAMV)=""
"RTN","PSAPROC",37,0)
 ;PSA*3*22 (Set PSDOUT on next line to avoid automatic stuffing
"RTN","PSAPROC",38,0)
 I 'PSANUM D NONE S PSAOUT=1 G EXIT
"RTN","PSAPROC",39,0)
 I PSANUM=1 D ONE Q:PSAOUT
"RTN","PSAPROC",40,0)
 I PSANUM>1 D MANY Q:PSAOUT
"RTN","PSAPROC",41,0)
 D ^PSAPROC1 G EXIT
"RTN","PSAPROC",42,0)
 ;
"RTN","PSAPROC",43,0)
NONE ;No DA pharmacy locations
"RTN","PSAPROC",44,0)
 W !!,"There are no Drug Accountability pharmacy locations.",!!,"Use the Set Up/Edit a Pharmacy Location option on Pharmacy Location Maintenance"
"RTN","PSAPROC",45,0)
 W !,"Menu to setup one or more pharmacy locations. Then select the Process Uploaded",!,"Prime Vendor Invoice Data option to process the invoices."
"RTN","PSAPROC",46,0)
 D END S PSA=$O(PSACS("")) D:PSA'="" MASTER,END
"RTN","PSAPROC",47,0)
 Q
"RTN","PSAPROC",48,0)
 ;
"RTN","PSAPROC",49,0)
ONE ;Only one location
"RTN","PSAPROC",50,0)
 S PSACNT=0,PSALOC=PSAONE,PSALOCN=$O(PSALOCA(""))
"RTN","PSAPROC",51,0)
 W !!,"The invoices are being assigned to the pharmacy location. Please wait."
"RTN","PSAPROC",52,0)
 S PSACTRL="" F  S PSACTRL=$O(PSANCS(PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC",53,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",54,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)=PSALOC,PSACNT=1 W "."
"RTN","PSAPROC",55,0)
 H 1 S PSA=$O(PSACS("")) D:PSA'="" MASTER
"RTN","PSAPROC",56,0)
 Q
"RTN","PSAPROC",57,0)
 ;
"RTN","PSAPROC",58,0)
MANY ;If more than one pharmacy location, display invoices.
"RTN","PSAPROC",59,0)
 S PSACTRL="" F  S PSACTRL=$O(PSANCS(PSACTRL)) Q:PSACTRL=""  D  Q:PSAOUT
"RTN","PSAPROC",60,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",61,0)
 .S PSAIN=$G(^XTMP("PSAPV",PSACTRL,"IN")),PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2)
"RTN","PSAPROC",62,0)
 .D DISPLOC
"RTN","PSAPROC",63,0)
 .W !,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN)
"RTN","PSAPROC",64,0)
 .W:$D(PSACS(PSACTRL)) !,"Some controlled substances" D SELECT
"RTN","PSAPROC",65,0)
 S PSA=$O(PSACS("")) D:PSA'="" MASTER,END K PSAMENU,PSALOCA
"RTN","PSAPROC",66,0)
 Q
"RTN","PSAPROC",67,0)
 ;
"RTN","PSAPROC",68,0)
DISPLOC ;Displays the active pharmacy locations.
"RTN","PSAPROC",69,0)
 W @IOF,!?19,"<<< ASSIGN A PHARMACY LOCATION SCREEN >>>",!,PSASLN
"RTN","PSAPROC",70,0)
 S (PSACNT,PSASTOP)=0,PSALOCN=""
"RTN","PSAPROC",71,0)
 F  S PSALOCN=$O(PSALOCA(PSALOCN)) Q:PSALOCN=""!(PSASTOP)  D
"RTN","PSAPROC",72,0)
 .S PSALOC=0 F  S PSALOC=$O(PSALOCA(PSALOCN,PSALOC)) Q:'PSALOC!(PSASTOP)  D
"RTN","PSAPROC",73,0)
 ..S PSACNT=PSACNT+1,PSAMENU(PSACNT,PSALOCN,PSALOC)=PSALOC
"RTN","PSAPROC",74,0)
 ..I $Y+3>IOSL D HDR I PSAOUT S PSAOUT=0,PSASTOP=1 Q
"RTN","PSAPROC",75,0)
 ..W !,$J(PSACNT,2)_"." W:$L(PSALOCN)>72 ?4,$P(PSALOCN,"(IP)",1)_"(IP)",!?21,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<73 ?4,PSALOCN
"RTN","PSAPROC",76,0)
 W ! K PSASTOP
"RTN","PSAPROC",77,0)
 Q
"RTN","PSAPROC",78,0)
 ;
"RTN","PSAPROC",79,0)
HDR D END
"RTN","PSAPROC",80,0)
 W @IOF,!?19,"<<< ASSIGN A PHARMACY LOCATION SCREEN >>>",!,PSASLN
"RTN","PSAPROC",81,0)
 Q
"RTN","PSAPROC",82,0)
 ;
"RTN","PSAPROC",83,0)
SELECT ;Select the Pharmacy Location to be assigned to the order.
"RTN","PSAPROC",84,0)
 W ! K DIR S DIR(0)="NO^1:"_PSACNT,DIR("A")="Pharmacy Location",DIR("?")="Select the pharmacy location that received the invoice's drugs"
"RTN","PSAPROC",85,0)
 ;
"RTN","PSAPROC",86,0)
 ;DAVE B (PSA*3*12) 2/16/99 Force entering a pharacy location
"RTN","PSAPROC",87,0)
 S DIR("??")="^D PHARM^PSAPROC" D ^DIR K DIR Q:Y=""  ;I Y="" W !!?5,"Enter an Up-arrow '^' to abort the process.",! G SELECT
"RTN","PSAPROC",88,0)
 I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC",89,0)
 S PSASEL=Y,PSALOCN=""
"RTN","PSAPROC",90,0)
 F  S PSALOCN=$O(PSAMENU(PSASEL,PSALOCN)) Q:PSALOCN=""  D
"RTN","PSAPROC",91,0)
 .S PSALOC=0 F  S PSALOC=+$O(PSAMENU(PSASEL,PSALOCN,PSALOC)) Q:'PSALOC  D
"RTN","PSAPROC",92,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)=PSALOC
"RTN","PSAPROC",93,0)
 Q
"RTN","PSAPROC",94,0)
 ;
"RTN","PSAPROC",95,0)
MASTER ;Assigns invoice to Master Vault
"RTN","PSAPROC",96,0)
 I 'PSAMVN W !!,"No master vaults are set up. You must set up a master vault then",!,"select the Process Uploaded Prime Vendor Invoices Data option." S PSAOUT=1 Q
"RTN","PSAPROC",97,0)
 ;
"RTN","PSAPROC",98,0)
 I PSAMVN=1 D  H 1 Q
"RTN","PSAPROC",99,0)
 .S PSACTRL=$O(PSACS(""))
"RTN","PSAPROC",100,0)
 .W !!,"The invoices are being assigned to the master vault. Please wait."
"RTN","PSAPROC",101,0)
 .S PSACTRL="" F  S PSACTRL=$O(PSACS(PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC",102,0)
 ..Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",103,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)=PSAONEMV W "."
"RTN","PSAPROC",104,0)
 ;
"RTN","PSAPROC",105,0)
 I PSAMVN>1 D
"RTN","PSAPROC",106,0)
 .S PSACTRL="" F  S PSACTRL=$O(PSACS(PSACTRL)) Q:PSACTRL=""  D  Q:PSAOUT
"RTN","PSAPROC",107,0)
 ..Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC",108,0)
 ..S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2)
"RTN","PSAPROC",109,0)
 ..D DISPMV W !,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN)
"RTN","PSAPROC",110,0)
 ..W:$P(PSAIN,"^",10)="ALL CS" !,"** All controlled substances"
"RTN","PSAPROC",111,0)
 ..W:$P(PSAIN,"^",10)'="ALL CS" !,"** Some controlled substances"
"RTN","PSAPROC",112,0)
 ..D SELMV
"RTN","PSAPROC",113,0)
 Q
"RTN","PSAPROC",114,0)
 ;
"RTN","PSAPROC",115,0)
DISPMV ;Displays active master vaults
"RTN","PSAPROC",116,0)
 W @IOF,!?22,"<<< ASSIGN A MASTER VAULT SCREEN >>>",!,PSASLN
"RTN","PSAPROC",117,0)
 S PSA=0,PSAMVA="" F  S PSAMVA=$O(PSAMV(PSAMVA)) Q:PSAMVA=""  D
"RTN","PSAPROC",118,0)
 .S PSAMVIEN=0 F  S PSAMVIEN=$O(PSAMV(PSAMVA,PSAMVIEN)) Q:'PSAMVIEN  D
"RTN","PSAPROC",119,0)
 ..S PSA=PSA+1,PSAVAULT(PSA,PSAMVA,PSAMVIEN)=""
"RTN","PSAPROC",120,0)
 ..W !,$J(PSA,2)_".",?4,PSAMVA
"RTN","PSAPROC",121,0)
 W !
"RTN","PSAPROC",122,0)
 Q
"RTN","PSAPROC",123,0)
 ;
"RTN","PSAPROC",124,0)
SELMV ;Select displayed master vaults
"RTN","PSAPROC",125,0)
 W ! S DIR(0)="NO^1:"_PSA,DIR("A")="Select Master Vault",DIR("?")="Select the Master Vault that received the invoice's drugs"
"RTN","PSAPROC",126,0)
 ;
"RTN","PSAPROC",127,0)
 ;DAVE B (PSA*3*12) 2/16/99 Force entry of MV
"RTN","PSAPROC",128,0)
 S DIR("??")="^D MV^PSAPROC" D ^DIR K DIR Q:Y=""  ;I Y="" W !!?5,"A Master Vault must be selected. Otherwise enter an up-arrow '^' to abort.",! G SELMV
"RTN","PSAPROC",129,0)
 I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC",130,0)
 ;
"RTN","PSAPROC",131,0)
 ;
"RTN","PSAPROC",132,0)
 S PSASEL=Y
"RTN","PSAPROC",133,0)
 S PSAMVA=$O(PSAVAULT(PSASEL,"")) Q:PSAMVA=""  S PSAMVIEN=+$O(PSAVAULT(PSASEL,PSAMVA,0)) Q:'PSAMVIEN  S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)=PSAMVIEN
"RTN","PSAPROC",134,0)
 Q
"RTN","PSAPROC",135,0)
 ;
"RTN","PSAPROC",136,0)
END ;Holds screen
"RTN","PSAPROC",137,0)
 S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSAPROC",138,0)
 S DIR(0)="E" D ^DIR K DIR S:$G(DIRUT) PSAOUT=1 W @IOF
"RTN","PSAPROC",139,0)
 Q
"RTN","PSAPROC",140,0)
 ;
"RTN","PSAPROC",141,0)
EXIT ;Kills processing variables
"RTN","PSAPROC",142,0)
 I $G(PSAENTRY) D PRINT2^PSAUP
"RTN","PSAPROC",143,0)
 D:($G(PSALCK)!($G(PSAOUT))) PSAUNLCK^PSAPROC8  ;; < PSA*3*70 RJS
"RTN","PSAPROC",144,0)
 ;
"RTN","PSAPROC",145,0)
 ;DAVE B (PSA*3*12) replaced '$D with '$G on next line
"RTN","PSAPROC",146,0)
 K DA,DIC,DIE,DIK,DIR,DIRUT,DR,DTOUT,DUOUT,PSA,PSABEFOR,PSACHG,PSACHO,PSACNT,PSACNT1,PSACNTER,PSACNTOK,PSACOMB,PSACONT,PSACS,PSACTRL,PSAREA,PSAFLD
"RTN","PSAPROC",147,0)
 K PSADRG1,PSASORT
"RTN","PSAPROC",148,0)
 K PSAD0,PSAD1,PSAD2,PSAD3,PSAD4,PSAD5,PSAD6,PSADATA,PSADIFF,PSADISP,PSADJQTY,PSADLN,PSADONE,PSADU,PSAENTRY,PSAERR,PSAFLDS,PSAFND,PSAFPR,PSAGET,PSAHDR
"RTN","PSAPROC",149,0)
 K PSAIEN,PSAIEN3,PSAIEN50,PSAIN,PSAINV,PSAIPR,PSAISIT,PSAISITN,PSAJUST,PSAKK,PSALINE,PSALINES,PSALLSUP,PSALN,PSALNCNT,PSALNSU,PSALOC,PSALOCA,PSALOCN,PSALOCN
"RTN","PSAPROC",150,0)
 K PSAMENU,PSAMV,PSAMVA,PSAMVIEN,PSAMVN,PSANCS,PSANDC,PSANEXT,PSANODE,PSANUM,PSAOK,PSAONE,PSAONEMV,PSAORD,PSAOSIT,PSAOSITN,PSAOUT,PSAPASS,PSAPC,PSAPCF,PSAPCL,PSAPHARM,PSAPICK,PSAPRICE,PSAPTR
"RTN","PSAPROC",151,0)
 K PSARECD,PSAREORD,PSASAME,PSASEL,PSASEL1,PSASKIP,PSASLN,PSASNODE,PSASS,PSASSUB,PSASTOCK,PSASUB,PSASUP,PSASUPP,PSASYN,PSAVAPN,PSAVAULT,PSAVSN,X1,Y,ZTDTH,ZTIO
"RTN","PSAPROC",152,0)
 Q
"RTN","PSAPROC",153,0)
 ;
"RTN","PSAPROC",154,0)
MV ;Extended help for the select "Master Vault" prompt
"RTN","PSAPROC",155,0)
 W !?5,"Enter the number of the master vault for which you want to assign",!?5,"the order. The invoiced drugs in the assigned master vault will be"
"RTN","PSAPROC",156,0)
 W !?5,"incremented with the quantity received after the order is verified."
"RTN","PSAPROC",157,0)
 Q
"RTN","PSAPROC",158,0)
PHARM ;Extended help for the select "Pharmacy Location" prompt
"RTN","PSAPROC",159,0)
 W !?5,"Enter the number of the pharmacy location for which you want to assign",!?5,"the order. The invoiced drugs in the assigned pharmacy location will be"
"RTN","PSAPROC",160,0)
 W !?5,"incremented with the quantity received after the order is verified."
"RTN","PSAPROC",161,0)
 Q
"RTN","PSAPROC",162,0)
DAVE ;Select division
"RTN","PSAPROC",163,0)
 S (CNT,CNTR,DIV,PSASORT)=0
"RTN","PSAPROC",164,0)
 S X=0 F  S X=$O(^XTMP("PSAPV",X)) Q:X=""  I $D(^XTMP("PSAPV",X,"ST")) S DATA=^XTMP("PSAPV",X,"ST"),DIV($P(DATA,"^"))=""
"RTN","PSAPROC",165,0)
 Q:$O(DIV(0))=""  S (CNT,CNTR)=0,DIR(0)="S^" F  S CNT=$G(CNT)+1,CNTR=$O(DIV(CNTR)) Q:CNTR=""  S DIR(0)=DIR(0)_CNT_":"_CNTR_";"
"RTN","PSAPROC",166,0)
 Q:$L(DIR(0))'>2  S XX=$L(DIR(0)),XX=XX-1,XXX=$E(DIR(0),1,XX),DIR(0)=XXX
"RTN","PSAPROC",167,0)
 K X,XX,XXX,CNT,CNTR,DIV
"RTN","PSAPROC",168,0)
 W !!,"You have invoices on your system for more than one division.",!,"Please select the location for which you want to process invoices.",!,"or Press the up-arrow to process all invoices."
"RTN","PSAPROC",169,0)
 D ^DIR S:+Y>0 PSASORT=Y(0)
"RTN","PSAPROC",170,0)
 Q
"RTN","PSAPROC1")
0^11^B41172320^B40487833
"RTN","PSAPROC1",1,0)
PSAPROC1 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**12,21,50,60,70**; 10/24/97;Build 12
"RTN","PSAPROC1",3,0)
 ;
"RTN","PSAPROC1",4,0)
 ;This routine processes uploaded invoices.
"RTN","PSAPROC1",5,0)
 ;
"RTN","PSAPROC1",6,0)
 ;;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPROC1",7,0)
 ;
"RTN","PSAPROC1",8,0)
CHK ;Check for invoices with a status of "OK" (uploaded & error free)
"RTN","PSAPROC1",9,0)
 ;& status of "" (uploaded & errors). 
"RTN","PSAPROC1",10,0)
 K PSA,PSAOK S (PSACNTOK,PSACNTER,PSACTRL)=0
"RTN","PSAPROC1",11,0)
 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC1",12,0)
 .;DAVE B (PSA*3*12 13MAY99) Restrict to appropriate division
"RTN","PSAPROC1",13,0)
 .I $G(PSASORT)'=0,$G(PSASORT)'="",$D(^XTMP("PSAPV",PSACTRL,"ST")),$P(^XTMP("PSAPV",PSACTRL,"ST"),"^",1)'=PSASORT Q
"RTN","PSAPROC1",14,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))  S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSAPROC1",15,0)
 .I $P(PSAIN,"^",8)="OK"!($P(PSAIN,"^",13)="SUP") D  Q
"RTN","PSAPROC1",16,0)
 ..I $P(PSAIN,"^",10)="ALL CS",$P(PSAIN,"^",12)'="" D OK Q
"RTN","PSAPROC1",17,0)
 ..I $P(PSAIN,"^",10)'="ALL CS",$P(PSAIN,"^",9)="CS",$P(PSAIN,"^",12)'="",$P(PSAIN,"^",7)'="" D OK Q
"RTN","PSAPROC1",18,0)
 ..I $P(PSAIN,"^",10)'="ALL CS",$P(PSAIN,"^",9)'="CS",$P(PSAIN,"^",7)'="" D OK Q
"RTN","PSAPROC1",19,0)
 ..S PSACNTER=PSACNTER+1,PSAERR(PSACNTER)=$P(PSAIN,"^",4)_"^"_$P(PSAIN,"^",2)_"^"_PSACTRL_"^"_$P(PSAIN,"^",7)
"RTN","PSAPROC1",20,0)
 .I $P(PSAIN,"^",8)="" S PSACNTER=PSACNTER+1,PSAERR(PSACNTER)=$P(PSAIN,"^",4)_"^"_$P(PSAIN,"^",2)_"^"_PSACTRL_"^"_$P(PSAIN,"^",7)
"RTN","PSAPROC1",21,0)
 S PSA=+$O(PSAOK(0))
"RTN","PSAPROC1",22,0)
 G:'PSA ^PSAPROC2
"RTN","PSAPROC1",23,0)
 ;
"RTN","PSAPROC1",24,0)
NOERROR ;Display list of invoices that can be processed by selecting
"RTN","PSAPROC1",25,0)
 ;invoice number.
"RTN","PSAPROC1",26,0)
 W @IOF,!?21,"<<< PROCESS ENTIRE INVOICE SCREEN >>>"
"RTN","PSAPROC1",27,0)
 W !!?2,"No errors have been detected on the following invoices. If there are no",!?2,"corrections, you can change the invoices' status to ""Processed"" by"
"RTN","PSAPROC1",28,0)
 W !?2,"selecting them from the list. If you do have corrections, press the return",!?2,"key then a second list will be displayed. You will be able to choose the",!?2,"invoices from that list and enter corrections."
"RTN","PSAPROC1",29,0)
 W !!?2,"Choose the invoices from the list you want to process.",!,PSADLN
"RTN","PSAPROC1",30,0)
 S (PSACNT,PSASTOP)=0,PSAMENU=""
"RTN","PSAPROC1",31,0)
 F  S PSAMENU=$O(PSAOK(PSAMENU)) Q:PSAMENU=""!(PSAOUT)  D  Q:PSASTOP
"RTN","PSAPROC1",32,0)
 .I $Y+4>IOSL D HEADER Q:PSASTOP
"RTN","PSAPROC1",33,0)
 .S PSAORD=$P(PSAOK(PSAMENU),"^"),PSAINV=$P(PSAOK(PSAMENU),"^",2),PSACTRL=$P(PSAOK(PSAMENU),"^",3),PSACNT=PSACNT+1
"RTN","PSAPROC1",34,0)
 .W !?2,PSAMENU_". ",?4,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC1",35,0)
 K PSASTOP W !,PSADLN
"RTN","PSAPROC1",36,0)
 S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select invoices to process",DIR("?",1)="Enter the number to the left of the invoice",DIR("?")="data to be processed or a range of numbers." W !
"RTN","PSAPROC1",37,0)
 S DIR("??")="^D SEL^PSAPROC1" D ^DIR K DIR G:Y="" EDIT I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC1",38,0)
 S PSASEL=Y
"RTN","PSAPROC1",39,0)
 D PLOCK^PSAPROC8(1)  ;; < PSA*3*70 RJS
"RTN","PSAPROC1",40,0)
 I '$G(PSASEL) G EXIT^PSAPROC
"RTN","PSAPROC1",41,0)
INVSEL F PSAPC=1:1 S PSA=+$P(PSASEL,",",PSAPC) Q:'PSA  D  Q:PSAOUT
"RTN","PSAPROC1",42,0)
 .I '$D(PSAOK(PSA)) Q  ;*50
"RTN","PSAPROC1",43,0)
 .S PSACTRL=$P(PSAOK(PSA),"^",3) Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC1",44,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSARECD=+$P(PSAIN,"^",6),PSALINES=0
"RTN","PSAPROC1",45,0)
 .D PROCESS
"RTN","PSAPROC1",46,0)
 Q:PSAOUT  G:'+$O(PSAOK(0)) PROC2
"RTN","PSAPROC1",47,0)
EDIT ;Edit error free invoices
"RTN","PSAPROC1",48,0)
 S PSA=0 F  S PSA=$O(PSAOK(PSA)) Q:'PSA  D
"RTN","PSAPROC1",49,0)
 .I $P($G(^XTMP("PSAPV",$P(PSAOK(PSA),"^",3),"IN")),"^",8)="OK"!($P($G(^("IN")),"^",13)="SUP") D
"RTN","PSAPROC1",50,0)
 ..S PSACNTER=PSACNTER+1,PSAERR(PSACNTER)=$P(^XTMP("PSAPV",$P(PSAOK(PSA),"^",3),"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_$P(PSAOK(PSA),"^",3)_"^"_$P(^("IN"),"^",7)
"RTN","PSAPROC1",51,0)
 ;
"RTN","PSAPROC1",52,0)
PROC2 I +$O(PSAERR(0)) D ^PSAPROC2
"RTN","PSAPROC1",53,0)
 Q
"RTN","PSAPROC1",54,0)
 ;
"RTN","PSAPROC1",55,0)
HEADER S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSAPROC1",56,0)
 S DIR(0)="E" D ^DIR K DIR I $G(DIRUT) S PSASTOP=1 Q
"RTN","PSAPROC1",57,0)
 W @IOF,!?21,"<<< PROCESS ENTIRE INVOICE SCREEN >>>",!!,PSADLN
"RTN","PSAPROC1",58,0)
 Q
"RTN","PSAPROC1",59,0)
 ;
"RTN","PSAPROC1",60,0)
PROCESS ;Get date recd & line item data
"RTN","PSAPROC1",61,0)
 I $P(PSAIN,"^",13)="SUP" D HDR,SUPPLY^PSAPROC6 Q
"RTN","PSAPROC1",62,0)
 D HDR,RECD^PSAPROC3 Q:PSAOUT  S (PSACS,PSALNCNT)=0,PSALINE=""
"RTN","PSAPROC1",63,0)
 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""  D  Q:PSAOUT
"RTN","PSAPROC1",64,0)
 .K PSAPHARM,PSAMV
"RTN","PSAPROC1",65,0)
 .S PSALNCNT=PSALNCNT+1,(PSADISP,PSADU,PSAHDR)=0
"RTN","PSAPROC1",66,0)
 .S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE),PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),+$P(PSADATA,"^",6):+$P(PSADATA,"^",6),1:0),PSASUB=+$P(PSADATA,"^",7)
"RTN","PSAPROC1",67,0)
 .S:$P(PSADATA,"^",19)="CS" PSAMV=+$P(PSAIN,"^",12) S:$P(PSADATA,"^",19)'="CS" PSAPHARM=+$P(PSAIN,"^",7)
"RTN","PSAPROC1",68,0)
 .S PSALOC=+$S($P(PSADATA,"^",19)="CS":PSAMV,1:PSAPHARM)
"RTN","PSAPROC1",69,0)
 .I $P($G(^PSDRUG(PSAIEN,660)),"^",8)="" D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D DU^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC1",70,0)
 .I '+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",7),$P($G(^PSDRUG(PSAIEN,660)),"^",8)'="" D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D:PSASUB DUOU^PSAPROC8 D:'PSASUB DUOU^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC1",71,0)
 .I +$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6)'=+$P(PSADATA,"^",3) D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D PRICE^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC1",72,0)
 .I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D  Q:PSAOUT
"RTN","PSAPROC1",73,0)
 ..I '+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",3),'+$P(PSADATA,"^",27) D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D STOCK^PSAPROC8 Q:PSAOUT
"RTN","PSAPROC1",74,0)
 ..I '+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",5),'+$P(PSADATA,"^",21) D:'PSAHDR HDR D:'PSADISP DISPLAY^PSAUTL1 D REORDER^PSAPROC8
"RTN","PSAPROC1",75,0)
 .D SETLINE^PSAPROC3 S:$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS" PSACS=PSACS+1
"RTN","PSAPROC1",76,0)
 S PSAOK=0
"RTN","PSAPROC1",77,0)
CS I PSACS D  Q:PSAOUT
"RTN","PSAPROC1",78,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="CS"
"RTN","PSAPROC1",79,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)="" S PSACS(PSACTRL)="" D MASTER^PSAPROC9 Q:PSAOUT  S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)'="" PSAOK=1 ;PSA*60
"RTN","PSAPROC1",80,0)
 .I PSACS=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)="ALL CS" Q
"RTN","PSAPROC1",81,0)
 .I PSACS'=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)=""
"RTN","PSAPROC1",82,0)
NCS I 'PSACS S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="",$P(^("IN"),"^",10)="",$P(^("IN"),"^",12)="" D:$P(^("IN"),"^",7)="" GETLOC^PSAPROC9 Q:PSAOUT  S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)'="" PSAOK=1
"RTN","PSAPROC1",83,0)
 ;
"RTN","PSAPROC1",84,0)
 I PSALNCNT=PSALINES S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="P" K PSAOK(PSA) W !!,"The invoice status has been changed to Processed!" D ^PSAPROC7 I 1 ;PSA*3*21 (1/3/01- file immediately);*50 
"RTN","PSAPROC1",85,0)
 E  W !!,"** The invoice has not been placed in a Processed status!"
"RTN","PSAPROC1",86,0)
 D END^PSAPROC
"RTN","PSAPROC1",87,0)
 Q
"RTN","PSAPROC1",88,0)
 ;
"RTN","PSAPROC1",89,0)
HDR ;Header for editing line items with missing data
"RTN","PSAPROC1",90,0)
 S PSAHDR=1
"RTN","PSAPROC1",91,0)
 W @IOF,!?21,"<<< PROCESS ENTIRE INVOICE SCREEN >>>",!,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSADLN
"RTN","PSAPROC1",92,0)
 Q
"RTN","PSAPROC1",93,0)
OK ;Sets okay array
"RTN","PSAPROC1",94,0)
 S PSACNTOK=PSACNTOK+1,PSAOK(PSACNTOK)=$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_PSACTRL_"^"_$P(^("IN"),"^",7)
"RTN","PSAPROC1",95,0)
 Q
"RTN","PSAPROC1",96,0)
 ;
"RTN","PSAPROC1",97,0)
SEL ;Extended help to 'Select invoices'
"RTN","PSAPROC1",98,0)
 W !?5,"Enter the number to the left of the invoice data that you want to process."
"RTN","PSAPROC1",99,0)
 Q
"RTN","PSAPROC2")
0^12^B71381092^B70245487
"RTN","PSAPROC2",1,0)
PSAPROC2 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**34,50,70**; 10/24/97;Build 12
"RTN","PSAPROC2",3,0)
 ;This routine allows the user to edit invoices with errors or missing
"RTN","PSAPROC2",4,0)
 ;data.
"RTN","PSAPROC2",5,0)
 ;
"RTN","PSAPROC2",6,0)
CHK S PSA=+$O(PSAERR(0))
"RTN","PSAPROC2",7,0)
 I 'PSA W @IOF,!!,"There are no invoices that need to be processed." D END^PSAPROC Q
"RTN","PSAPROC2",8,0)
 ;
"RTN","PSAPROC2",9,0)
INV D HDR W !,"  More data is needed on the following invoices. Choose the invoices from",!,"  the list you want to edit.",!,PSASLN
"RTN","PSAPROC2",10,0)
 S (PSACNT,PSAMENU,PSASTOP)=0
"RTN","PSAPROC2",11,0)
 F  S PSAMENU=+$O(PSAERR(PSAMENU)) Q:'PSAMENU!(PSAOUT)  D  Q:PSASTOP
"RTN","PSAPROC2",12,0)
 .I $Y+4>IOSL D HEADER Q:PSASTOP
"RTN","PSAPROC2",13,0)
 .S PSAORD=$P(PSAERR(PSAMENU),"^"),PSAINV=$P(PSAERR(PSAMENU),"^",2),PSACTRL=$P(PSAERR(PSAMENU),"^",3),PSACNT=PSACNT+1
"RTN","PSAPROC2",14,0)
 .W !?2,PSAMENU_". ",?6,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC2",15,0)
 W !,PSASLN K DIR,PSASTOP
"RTN","PSAPROC2",16,0)
 S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select invoices to edit",DIR("?",1)="Enter the number to the left of the invoice",DIR("?")="data to be processed or a range of numbers." W !
"RTN","PSAPROC2",17,0)
 S DIR("??")="^D SELHELP^PSAPROC2" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC2",18,0)
 S PSASEL=Y
"RTN","PSAPROC2",19,0)
 D PLOCK^PSAPROC8(2)  ;; < PSA*3*70 RJS
"RTN","PSAPROC2",20,0)
 I '$G(PSASEL) G EXIT^PSAPROC
"RTN","PSAPROC2",21,0)
 ;
"RTN","PSAPROC2",22,0)
PROC W ! S DIR("A",1)="Do you want to select the line items to be edited (S) or",DIR("A")="have them automatically (A) displayed for you?",DIR("B")="A",DIR(0)="SB^S:Select;A:Automatically displayed"
"RTN","PSAPROC2",23,0)
 S DIR("?",1)="Enter ""S"" to allow you to select the line items to be edited.",DIR("?",2)="Enter ""A"" to automatically receive prompts for the line items",DIR("?")="that need editing."
"RTN","PSAPROC2",24,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC2",25,0)
 G:Y="S" SEL^PSAPROC6
"RTN","PSAPROC2",26,0)
 ;
"RTN","PSAPROC2",27,0)
AUTO ;Process line items
"RTN","PSAPROC2",28,0)
 F PSAPC=1:1 S PSAMENU=$P(PSASEL,",",PSAPC) Q:'PSAMENU!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAPROC2",29,0)
 .Q:'$D(PSAERR(PSAMENU))
"RTN","PSAPROC2",30,0)
 .S PSACTRL=$P(PSAERR(PSAMENU),"^",3),(PSALNCNT,PSALINES,PSACS,PSALLSUP)=0
"RTN","PSAPROC2",31,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))!('$D(^XTMP("PSAPV",PSACTRL,"IT")))
"RTN","PSAPROC2",32,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSALOC=+$P(PSAIN,"^",7),PSAMV=+$P(PSAIN,"^",12)
"RTN","PSAPROC2",33,0)
 .D HDR W !,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSASLN
"RTN","PSAPROC2",34,0)
 .W:$P(PSAIN,"^",9)="CS" !!,"MASTER VAULT: "_$S(PSAMV:$P($G(^PSD(58.8,PSAMV,0)),"^"),1:"Blank")
"RTN","PSAPROC2",35,0)
 .I $P(PSAIN,"^",10)="" D
"RTN","PSAPROC2",36,0)
 ..D SITES^PSAUTL1 S PSALOCN=$S($D(^PSD(58.8,PSALOC,0)):$P($G(^PSD(58.8,PSALOC,0)),"^"),1:"UNKNOWN")_PSACOMB
"RTN","PSAPROC2",37,0)
 ..W !!,"PHARMACY LOCATION: " I 'PSALOC W "Blank" Q
"RTN","PSAPROC2",38,0)
 ..W:$L(PSALOCN)>76 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<77 !,PSALOCN
"RTN","PSAPROC2",39,0)
 .W ! S PSARECD=$S(+$P(PSAIN,"^",11):+$P(PSAIN,"^",11),+$P(PSAIN,"^",6):+$P(PSAIN,"^",6),1:"") D RECD^PSAPROC3 Q:PSAOUT
"RTN","PSAPROC2",40,0)
 .;
"RTN","PSAPROC2",41,0)
 .;Gets & processes the line items
"RTN","PSAPROC2",42,0)
 .S PSALINE="" F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAPROC2",43,0)
 ..S PSALNCNT=PSALNCNT+1,(PSAPASS,PSASUPP)=0,PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC2",44,0)
 ..I $P(PSADATA,"^",18)="OK"!($P(PSADATA,"^",18)="P") S:$P(PSADATA,"^",18)="OK" $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P" S PSALINES=PSALINES+1 S:$P(PSADATA,"^",19)="CS" PSACS=PSACS+1 Q
"RTN","PSAPROC2",45,0)
 ..S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC2",46,0)
 ..S PSAIEN=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),1:+$P(PSADATA,"^",6)),PSASUB=+$P(PSADATA,"^",7),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~")
"RTN","PSAPROC2",47,0)
 ..D EDITDISP^PSAUTL1 D ^PSAPROC9
"RTN","PSAPROC2",48,0)
 .D:'PSAOUT SETINV
"RTN","PSAPROC2",49,0)
 Q:PSAOUT
"RTN","PSAPROC2",50,0)
 I '$O(PSAERR(0)) Q  ;*50 rid select (1-0)
"RTN","PSAPROC2",51,0)
 W @IOF,!,"If you are changing the status of an invoice to Processed, this is the",!,"last time you will be allowed to edit it before it goes to the verifier."
"RTN","PSAPROC2",52,0)
 W !,"If you are not changing the status of an invoice to Processed, you can",!,"edit it now.",!!,"You can edit the invoice's delivery date, pharmacy location, master vault,"
"RTN","PSAPROC2",53,0)
 W !,"and the line item's drug, quantity received, order unit, and dispense units",!,"per order unit. The reorder level can be edited if the pharmacy location or"
"RTN","PSAPROC2",54,0)
 W !,"master vault is set up to track the reorder levels.",!
"RTN","PSAPROC2",55,0)
 S DIR(0)="Y",DIR("A")="Edit invoices",DIR("B")="N",DIR("?",1)="Enter Yes to edit the invoices you just processed.",DIR("?",1)="Enter No to accept the invoices as they are now."
"RTN","PSAPROC2",56,0)
 S DIR("??")="^D EDIT^PSAPROC2" D ^DIR K DIR I $G(DIRUT)!('Y) S PSAOUT=1 Q
"RTN","PSAPROC2",57,0)
 ;
"RTN","PSAPROC2",58,0)
EDITINV ;Edits the invoice before placing in Processed status.
"RTN","PSAPROC2",59,0)
 K PSAERR S (PSACTRL,PSAERR,PSAOUT)=0
"RTN","PSAPROC2",60,0)
 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSAPROC2",61,0)
 .S:$D(^XTMP("PSAPV",PSACTRL,"IN")) PSAERR=PSAERR+1,PSAERR(PSAERR)=$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_PSACTRL_"^"_$P(^("IN"),"^",7)_"^"_$P(^("IN"),"^",12)
"RTN","PSAPROC2",62,0)
 ;
"RTN","PSAPROC2",63,0)
 W @IOF,!?26,"<<< EDIT INVOICE SCREEN >>>"
"RTN","PSAPROC2",64,0)
 W !!,"Choose the invoices to be edited. You can edit the invoice's date received and",!,"the line item's drug, quantity received, and order unit. The reorder and"
"RTN","PSAPROC2",65,0)
 W !,"stock levels can be edited if the pharmacy location or master vault is set",!,"up to maintain the reorder levels.",!,PSASLN,!
"RTN","PSAPROC2",66,0)
 S (PSACNT,PSAMENU,PSASTOP)=0
"RTN","PSAPROC2",67,0)
 F  S PSAMENU=+$O(PSAERR(PSAMENU)) Q:'PSAMENU!(PSAOUT)  D  Q:PSASTOP
"RTN","PSAPROC2",68,0)
 .I $Y+4>IOSL D HDR1 Q:PSASTOP
"RTN","PSAPROC2",69,0)
 .S PSAORD=$P(PSAERR(PSAMENU),"^"),PSAINV=$P(PSAERR(PSAMENU),"^",2),PSACTRL=$P(PSAERR(PSAMENU),"^",3),PSACNT=PSACNT+1
"RTN","PSAPROC2",70,0)
 .W !?1,PSACNT_".",?4,"Order#: "_PSAORD_"  Invoice#: "_PSAINV_"  Invoice Date: "_$$FMTE^XLFDT(+^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSAPROC2",71,0)
 K PSASTOP
"RTN","PSAPROC2",72,0)
 S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select invoices",DIR("?",1)="Enter the number to the left of the invoice",DIR("?")="data to be edited or a range of numbers." W !
"RTN","PSAPROC2",73,0)
 S DIR("??")="^D SEL^PSAPROC2" D ^DIR K DIR S:Y="" DUOUT=1 I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q  ;*50
"RTN","PSAPROC2",74,0)
 S PSASEL=Y D ^PSAPROC6
"RTN","PSAPROC2",75,0)
 Q
"RTN","PSAPROC2",76,0)
HDR ;Screen header
"RTN","PSAPROC2",77,0)
 W @IOF,!?19,"<<< EDIT INVOICES TO BE PROCESSED SCREEN >>>",!
"RTN","PSAPROC2",78,0)
 Q
"RTN","PSAPROC2",79,0)
 ;
"RTN","PSAPROC2",80,0)
HDR1 ;Screen header with hold
"RTN","PSAPROC2",81,0)
 S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSAPROC2",82,0)
 S DIR(0)="E" D ^DIR K DIR I $G(DIRUT) S PSASTOP=1 Q
"RTN","PSAPROC2",83,0)
 W @IOF,!?26,"<<< EDIT INVOICE SCREEN >>>",!!,PSASLN
"RTN","PSAPROC2",84,0)
 Q
"RTN","PSAPROC2",85,0)
 ;
"RTN","PSAPROC2",86,0)
HEADER ;Screen hold with header
"RTN","PSAPROC2",87,0)
 S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSAPROC2",88,0)
 S DIR(0)="E" D ^DIR K DIR I $G(DIRUT) S PSASTOP=1 Q
"RTN","PSAPROC2",89,0)
 W @IOF,!?19,"<<< EDIT INVOICES TO BE PROCESSED SCREEN >>>",!!,PSASLN
"RTN","PSAPROC2",90,0)
 Q
"RTN","PSAPROC2",91,0)
 ;
"RTN","PSAPROC2",92,0)
SETINV ;Sets invoice to processed if okay.
"RTN","PSAPROC2",93,0)
 S PSAOK=1
"RTN","PSAPROC2",94,0)
 I PSALLSUP=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)="",$P(^("IN"),"^",9)="",$P(^("IN"),"^",10)="",$P(^("IN"),"^",12)="",$P(^("IN"),"^",13)="SUP",PSAOK=1 G STATUS
"RTN","PSAPROC2",95,0)
 E  S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)=""
"RTN","PSAPROC2",96,0)
 I PSACS D  Q:PSAOUT
"RTN","PSAPROC2",97,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="CS"
"RTN","PSAPROC2",98,0)
 .I $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)="" S PSACS(PSACTRL)="" D MASTER^PSAPROC9 Q:PSAOUT  S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)="" PSAOK=0
"RTN","PSAPROC2",99,0)
 .I PSACS=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)="ALL CS" Q
"RTN","PSAPROC2",100,0)
 .I PSACS'=PSALNCNT S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)=""
"RTN","PSAPROC2",101,0)
 I 'PSACS S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="",$P(^("IN"),"^",10)="",$P(^("IN"),"^",12)="" D:$P(^("IN"),"^",7)="" GETLOC^PSAPROC9 Q:PSAOUT  S:$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)="" PSAOK=0
"RTN","PSAPROC2",102,0)
 ;
"RTN","PSAPROC2",103,0)
STATUS I PSALNCNT=PSALINES!(PSALNCNT=PSALLSUP),PSAOK D CHG^PSAPROC6,END^PSAPROC Q
"RTN","PSAPROC2",104,0)
 E  W !!,"** The invoice has not been placed in a Processed status!"
"RTN","PSAPROC2",105,0)
 D END^PSAPROC
"RTN","PSAPROC2",106,0)
 Q
"RTN","PSAPROC2",107,0)
EDIT ;Extended help for 'edit any invoices'
"RTN","PSAPROC2",108,0)
 W !?5,"If you answer Yes, a list of the invoices you were able to process will",!?5,"be displayed. You will be able to select the invoices to be edited then"
"RTN","PSAPROC2",109,0)
 W !?5,"the line item numbers. You will be able to edit the date the invoice was",!?5,"received, drug, quantity, order unit, and dispense units per order unit."
"RTN","PSAPROC2",110,0)
 W !?5,"If the drugs are assigned to a pharmacy location or master vault that",!?5,"maintains reorder levels, you will also be able to edit the reorder and",!?5,"stock levels.",!!?5,"Enter No if the invoice are correct."
"RTN","PSAPROC2",111,0)
 Q
"RTN","PSAPROC2",112,0)
SEL ;Extended help to 'Select invoices to process'
"RTN","PSAPROC2",113,0)
 W !?5,"Enter the number to the left of the invoice data that you want to process."
"RTN","PSAPROC2",114,0)
 Q
"RTN","PSAPROC2",115,0)
SELHELP ;Extended help to 'Select invoices to edit'
"RTN","PSAPROC2",116,0)
 W !?5,"Enter the number to the left of the invoice data that you want to",!?5,"edit. The line items will be displayed for you to select the ones"
"RTN","PSAPROC2",117,0)
 W !?5,"you want to edit. You are given this opportunity to edit the invoice",!?5,"because the automatic display may not catch all the needed corrections."
"RTN","PSAPROC2",118,0)
 W !!?5,"For example, the quantity on the invoice may be 6, but one bottle may",!?5,"be broken. Six is a valid quantity that the automatic display will not"
"RTN","PSAPROC2",119,0)
 W !?5,"realize as being incorrect. By answering Yes, you will be allowed to change",!?5,"the quantity to 5."
"RTN","PSAPROC2",120,0)
 Q
"RTN","PSAPROC8")
0^13^B67886786^B42624373
"RTN","PSAPROC8",1,0)
PSAPROC8 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC8",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,64,70**; 10/24/97;Build 12
"RTN","PSAPROC8",3,0)
 ;This routine processes uploaded invoices.
"RTN","PSAPROC8",4,0)
 ;
"RTN","PSAPROC8",5,0)
DU ;Prompts Dispense Unit if blank
"RTN","PSAPROC8",6,0)
 F  L +^PSDRUG(PSAIEN,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC8",7,0)
 S DIE="^PSDRUG(",DA=PSAIEN,DR=14.5 D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",8,0)
 I +$P($G(^PSDRUG(PSAIEN,660)),"^",8) D  G DU
"RTN","PSAPROC8",9,0)
 .F  L +^PSDRUG(PSAIEN,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC8",10,0)
 .S DIE="^PSDRUG(",DA=PSAIEN,DR="14.5///@" D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",11,0)
 I $P($G(^PSDRUG(PSAIEN,660)),"^",8)'="" S PSADU=1 Q
"RTN","PSAPROC8",12,0)
 ;
"RTN","PSAPROC8",13,0)
 W !,"The dispense units must be entered to change",!,"the status of the invoice to Processed."
"RTN","PSAPROC8",14,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to enter the dispense units now",DIR("?",1)="Enter Yes to return to the DISPENSE UNIT prompt.",DIR("?")="Enter No to bypass entering the dispense units now."
"RTN","PSAPROC8",15,0)
 S DIR("??")="^D DISPYN^PSAPROC8" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC8",16,0)
 G:+Y DU
"RTN","PSAPROC8",17,0)
 Q
"RTN","PSAPROC8",18,0)
 ;
"RTN","PSAPROC8",19,0)
DUOU ;Gets Dispense Units per Order Unit
"RTN","PSAPROC8",20,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)
"RTN","PSAPROC8",21,0)
 S PSADU=1
"RTN","PSAPROC8",22,0)
 F  L +^PSDRUG(PSAIEN,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC8",23,0)
 S DIE="^PSDRUG("_PSAIEN_",1,",DA(1)=PSAIEN,DA=+PSASUB,DR=403 D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",24,0)
 I $D(Y)!($G(DTOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",25,0)
 Q:+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",7)
"RTN","PSAPROC8",26,0)
 ;
"RTN","PSAPROC8",27,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A",1)="The dispense units per order unit must be entered to change the ",DIR("A")="status of the invoice to Processed. Do you want to enter the data now"
"RTN","PSAPROC8",28,0)
 S DIR("?",1)="Enter Yes to return to the "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)_"s per "_$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",2),0)),"^",2)_" prompt."
"RTN","PSAPROC8",29,0)
 S DIR("?")="Enter No to bypass entering the dispense units now.",DIR("??")="^D DUOUYN^PSAPROC8"
"RTN","PSAPROC8",30,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",31,0)
 G:+Y DUOU
"RTN","PSAPROC8",32,0)
 Q
"RTN","PSAPROC8",33,0)
OK ;
"RTN","PSAPROC8",34,0)
 S PSACNTOK=PSACNTOK+1,PSAOK(PSACNTOK)=$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_PSACTRL_"^"_$P(^("IN"),"^",7)
"RTN","PSAPROC8",35,0)
 Q
"RTN","PSAPROC8",36,0)
PRICE ;Price per Order Unit changed
"RTN","PSAPROC8",37,0)
 S PSAIPR=$L($FN($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3),",",2)),PSAFPR=$L($FN($P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),",",2))
"RTN","PSAPROC8",38,0)
 S PSAJUST=$S(PSAIPR>PSAFPR:PSAIPR,1:PSAFPR)
"RTN","PSAPROC8",39,0)
 W !!,"Price per Order Unit -- Invoice's: $"_$J($FN($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3),",",2),PSAJUST,2),!?24,"File's   : $"_$J($FN($P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),",",2),PSAJUST,2),!
"RTN","PSAPROC8",40,0)
 S DIR(0)="Y",DIR("A")="Is the invoice's price per order unit correct",DIR("B")="Y",DIR("?",1)="Enter Yes if "_$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3)_" is correct."
"RTN","PSAPROC8",41,0)
 S DIR("?")="Enter No to keep the file's price per order unit.",DIR("??")="^D PRICEOU^PSAPROC1" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC8",42,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",22)=+Y
"RTN","PSAPROC8",43,0)
 I '+Y S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",23)=+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",24)=DUZ,$P(^(PSALINE),"^",25)=DT
"RTN","PSAPROC8",44,0)
 Q
"RTN","PSAPROC8",45,0)
 ;
"RTN","PSAPROC8",46,0)
REORDER ;Enter reorder level for drug if the field is blank.
"RTN","PSAPROC8",47,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(+PSAIEN,660)),"^",8)
"RTN","PSAPROC8",48,0)
 S PSADU=1,DIR(0)="NO^0:99999",DIR("A")="REORDER LEVEL IN "_$P($G(^PSD(58.8,PSALOC,0)),"^")
"RTN","PSAPROC8",49,0)
 S DIR("?")="Enter the minimum number of dispense units to keep in the "_$S($P(PSADATA,"^",19)="CS":"master vault.",1:"pharmacy location."),DIR("??")="^D REORD^PSAPROC8"
"RTN","PSAPROC8",50,0)
 S DIR("B")=$S(+$P(PSADATA,"^",21):+$P(PSADATA,"^",21),+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",5):$P(^PSD(58.8,PSALOC,1,PSAIEN,0),"^",5),1:"")
"RTN","PSAPROC8",51,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",52,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",21)=+Y
"RTN","PSAPROC8",53,0)
 Q
"RTN","PSAPROC8",54,0)
 ;
"RTN","PSAPROC8",55,0)
STOCK ;Enter stock level for drug if the field is blank.
"RTN","PSAPROC8",56,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(+PSAIEN,660)),"^",8)
"RTN","PSAPROC8",57,0)
 S PSADU=1,DIR(0)="NO^0:99999",DIR("A")="STOCK LEVEL IN "_$P($G(^PSD(58.8,+PSALOC,0)),"^")
"RTN","PSAPROC8",58,0)
 S DIR("?")="Enter the minimum number of dispense units to keep on the shelf",DIR("??")="^D STKLEVEL^PSAPROC8"
"RTN","PSAPROC8",59,0)
 S DIR("B")=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",3):$P(^PSD(58.8,PSALOC,1,PSAIEN,0),"^",3),1:"")
"RTN","PSAPROC8",60,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",61,0)
 Q:$G(DIRUT)
"RTN","PSAPROC8",62,0)
 S:+Y $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",27)=+Y
"RTN","PSAPROC8",63,0)
 Q
"RTN","PSAPROC8",64,0)
 ;
"RTN","PSAPROC8",65,0)
DISPYN ;Extended help to enter dispense units
"RTN","PSAPROC8",66,0)
 W !?5,"Enter Yes if you want to enter the dispense units now.",!!?5,"Enter No to bypass entering the dispense units. The invoice will not",!?5,"be placed in a Processed status if the dispense units are not entered."
"RTN","PSAPROC8",67,0)
 Q
"RTN","PSAPROC8",68,0)
DUOUYN ;Extended help to enter dispense units per order units
"RTN","PSAPROC8",69,0)
 W !?5,"Enter Yes if you want to enter the dispense units per order unit now.",!!?5,"Enter No to bypass entering the dispense units per order unit. The"
"RTN","PSAPROC8",70,0)
 W !?5,"invoice will not be placed in a "_$S($D(PSABEFOR):"Verified",1:"Processed")_" status if the dispense units",!?5,"are not entered."
"RTN","PSAPROC8",71,0)
 Q
"RTN","PSAPROC8",72,0)
PRICEOU ;Extended help to 'Is invoice's price per order unit correct'
"RTN","PSAPROC8",73,0)
 W !?5,"Enter Yes if the invoice's price per order unit is correct. The",!?5,"invoice's price per order unit will be entered into the DRUG file."
"RTN","PSAPROC8",74,0)
 W !!?5,"Enter No if the invoice's price per order unit is not correct.",!?5,"The DRUG file's price per order unit will remain the same."
"RTN","PSAPROC8",75,0)
 Q
"RTN","PSAPROC8",76,0)
REORD ;Extended help for 'Reorder level'
"RTN","PSAPROC8",77,0)
 W !?5,"Enter the lowest amount of "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)_"s to keep in the "_$S($P(PSADATA,"^",19)="CS":"master vault",1:"pharmacy location")_"."
"RTN","PSAPROC8",78,0)
 W !!?5,"When the amount on hand is lower than the reorder level, a mail",!?5,"message will be sent showing the drug name, reorder level, and",!?5,"quantity on hand."
"RTN","PSAPROC8",79,0)
 Q
"RTN","PSAPROC8",80,0)
STKLEVEL ;Extended help for 'Stock level'
"RTN","PSAPROC8",81,0)
 W !?5,"Enter the ideal number of dispense units to keep on the shelf. When the",!?5,"number of dispense units is equal to or less than the reorder level, the"
"RTN","PSAPROC8",82,0)
 W !?5,"amount to order is determined by subtracting the current number of dispense",!?5,"units from the stock level."
"RTN","PSAPROC8",83,0)
 Q
"RTN","PSAPROC8",84,0)
PLOCK(PSATYP) ;SET ^XTMP("PSAPV",PSACRTL WITH A LOCK INDENTIFER  <- PSA*3*70 RJS
"RTN","PSAPROC8",85,0)
 N PSAPC,PSAORD,PSATMP,PSAMENU,PSADUZ S PSATMP=""
"RTN","PSAPROC8",86,0)
 F  L +^XTMP("PSAPVL"):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC8",87,0)
 I PSATYP=2 D
"RTN","PSAPROC8",88,0)
 .F PSAPC=1:1 S PSAMENU=$P(PSASEL,",",PSAPC) Q:'PSAMENU!(PSAOUT)  D
"RTN","PSAPROC8",89,0)
 ..Q:'$D(PSAERR(PSAMENU))
"RTN","PSAPROC8",90,0)
 ..S PSACTRL=$P(PSAERR(PSAMENU),"^",3),PSAORD=$P(PSAERR(PSAMENU),"^",1),PSADUZ=$G(^XTMP("PSAPVL",PSACTRL))
"RTN","PSAPROC8",91,0)
 ..I $P(PSADUZ,"^",3)<+$H K ^XTMP("PSAPVL",PSACTRL)
"RTN","PSAPROC8",92,0)
 ..I $D(^XTMP("PSAPVL",PSACTRL)),+PSADUZ=DUZ,$P(PSADUZ,"^",2)'=$J W !!,?5,"YOU ARE CURRENTLY PROCESSING ORDER# ",PSAORD," IN ANOTHER SESSION" Q
"RTN","PSAPROC8",93,0)
 ..I $D(^XTMP("PSAPVL",PSACTRL)),+PSADUZ'=DUZ W !!,?5,"ORDER# ",PSAORD," IS CURRENTLY BEING PROCESSED BY ",$P($P(^VA(200,+PSADUZ,0),"^",1),",",2)," ",$P($P(^VA(200,+PSADUZ,0),"^",1),",",1) Q
"RTN","PSAPROC8",94,0)
 ..I '$D(^XTMP("PSAPV",PSACTRL,"IN"))&($D(^PSD(58.811,"B",PSAORD))) W !!,?5,"ORDER# ",PSAORD," HAS ALREAY BEEN PROCESSED BY ANOTHER USER" Q
"RTN","PSAPROC8",95,0)
 ..S ^XTMP("PSAPVL",PSACTRL)=DUZ_"^"_$J_"^"_+$H
"RTN","PSAPROC8",96,0)
 ..S PSATMP=PSATMP_PSAMENU_",",PSALCK=1
"RTN","PSAPROC8",97,0)
 I PSATYP=1 D
"RTN","PSAPROC8",98,0)
 .F PSAPC=1:1 S PSA=+$P(PSASEL,",",PSAPC) Q:'PSA  D
"RTN","PSAPROC8",99,0)
 ..Q:'$D(PSAOK(PSA))
"RTN","PSAPROC8",100,0)
 ..S PSACTRL=$P(PSAOK(PSA),"^",3),PSAORD=$P(PSAOK(PSA),"^",1),PSADUZ=$G(^XTMP("PSAPVL",PSACTRL))
"RTN","PSAPROC8",101,0)
 ..I $P(PSADUZ,"^",3)<+$H K ^XTMP("PSAPVL",PSACTRL)
"RTN","PSAPROC8",102,0)
 ..I $D(^XTMP("PSAPVL",PSACTRL)),+PSADUZ=DUZ,$P(PSADUZ,"^",2)'=$J W !!,?5,"YOU ARE CURRENTLY PROCESSING ORDER# ",PSAORD," IN ANOTHER SESSION" Q
"RTN","PSAPROC8",103,0)
 ..I $D(^XTMP("PSAPVL",PSACTRL)),+PSADUZ'=DUZ W !!,?5,"ORDER# ",PSAORD," IS CURRENTLY BEING PROCESSED BY ",$P($P(^VA(200,+PSADUZ,0),"^",1),",",2)," ",$P($P(^VA(200,+PSADUZ,0),"^",1),",",1) Q
"RTN","PSAPROC8",104,0)
 ..I '$D(^XTMP("PSAPV",PSACTRL,"IN"))&($D(^PSD(58.811,"B",PSAORD))) W !!,?5,"ORDER# ",PSAORD," HAS ALREAY BEEN PROCESSED BY ANOTHER USER" Q
"RTN","PSAPROC8",105,0)
 ..S ^XTMP("PSAPVL",PSACTRL)=DUZ_"^"_$J_"^"_+$H
"RTN","PSAPROC8",106,0)
 ..S PSATMP=PSATMP_PSACTRL_",",PSALCK=1
"RTN","PSAPROC8",107,0)
 S PSASEL=PSATMP K PSATYP
"RTN","PSAPROC8",108,0)
 L -^XTMP("PSAPVL")
"RTN","PSAPROC8",109,0)
 Q
"RTN","PSAPROC8",110,0)
PSAUNLCK ;CLEANUP LOCK INDICATOR  <- PSA*3*70 RJS
"RTN","PSAPROC8",111,0)
 N PSACTRL,PSADUZ
"RTN","PSAPROC8",112,0)
 S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPVL",PSACTRL)) Q:'PSACTRL  D
"RTN","PSAPROC8",113,0)
 .S PSADUZ=$G(^XTMP("PSAPVL",PSACTRL))
"RTN","PSAPROC8",114,0)
 .I $P(PSADUZ,"^",3)<+$H K ^XTMP("PSAPVL",PSACTRL) Q
"RTN","PSAPROC8",115,0)
 .I $G(^XTMP("PSAPVL",PSACTRL)),'$G(^XTMP("PSAPV",PSACTRL,"IN")) K ^XTMP("PSAPVL",PSACTRL)  Q
"RTN","PSAPROC8",116,0)
 .I +$G(^XTMP("PSAPVL",PSACTRL))=DUZ,$G(^XTMP("PSAPV",PSACTRL,"IN")) D  Q
"RTN","PSAPROC8",117,0)
 ..K:$P(^XTMP("PSAPVL",PSACTRL),"^",2)=$J ^XTMP("PSAPVL",PSACTRL) Q
"RTN","PSAPROC8",118,0)
 ..W !!,"YOU ARE CURRENTLY PROCESSING ORDER# ",$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)," IN ANOTHER SESSION"
"RTN","PSAPROC8",119,0)
 .I +$G(^XTMP("PSAPVL",PSACTRL))'=DUZ,$G(^XTMP("PSAPV",PSACTRL,"IN")) D  Q
"RTN","PSAPROC8",120,0)
 ..W !!,$P($P(^VA(200,+PSADUZ,0),"^",1),",",2)," ",$P($P(^VA(200,+PSADUZ,0),"^",1),",",1)," IS CURRENTLY PROCESSING ORDER# ",$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)," IN ANOTHER SESSION"
"RTN","PSAPROC8",121,0)
 K PSALCK
"RTN","PSAPROC8",122,0)
 Q
"RTN","PSAVER3")
0^6^B72006337^B71438317
"RTN","PSAVER3",1,0)
PSAVER3 ;BIR/JMB-Verify Invoices - CONT'D ;9/5/97
"RTN","PSAVER3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,19,21,64,70**; 10/24/97;Build 12
"RTN","PSAVER3",3,0)
 ;This routine checks for verification errors, prints an error report,
"RTN","PSAVER3",4,0)
 ;& changes data in DA ORDERS to verification if there are no errors.
"RTN","PSAVER3",5,0)
 ;
"RTN","PSAVER3",6,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVER3",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER3",8,0)
 ;
"RTN","PSAVER3",9,0)
SETLINE ;Set line as verified if all data is present.
"RTN","PSAVER3",10,0)
 K PSADRG,PSAOU,PSAQTY S (PSADJN,PSADJ)=0
"RTN","PSAVER3",11,0)
 S PSADATA=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER3",12,0)
 I $O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) D
"RTN","PSAVER3",13,0)
 .S PSAA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) Q:PSAA=2
"RTN","PSAVER3",14,0)
 .S PSADJ=0 F  S PSADJ=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ)) Q:'PSADJ  D
"RTN","PSAVER3",15,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER3",16,0)
 ..S PSADJN=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)
"RTN","PSAVER3",17,0)
 ..I $P(PSADJN,"^")="D" D
"RTN","PSAVER3",18,0)
 ...I (+$P(PSADJN,"^",9)&($P(PSADJN,"^",6)'?.N))!('+$P(PSADJN,"^",9)&(+$P(PSADJN,"^",5))&($P(PSADJN,"^",2)'?.N)) S PSASUP=PSASUP+1,PSALNSU=1,PSADRG=0 Q
"RTN","PSAVER3",19,0)
 ...S PSADRG=$S($P(PSADJN,"^",6)'="":$P(PSADJN,"^",6),$P(PSADJN,"^",2)'="":$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",20,0)
 ..I $P(PSADJN,"^")="O" S PSAOU=$S(+$P(PSADJN,"^",6):+$P(PSADJN,"^",6),+$P(PSADJN,"^",2):+$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",21,0)
 ..I $P(PSADJN,"^")="Q" S PSAQTY=$S($P(PSADJN,"^",6)'="":+$P(PSADJN,"^",6),$P(PSADJN,"^",2)'="":+$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",22,0)
 S:'$G(PSADRG) PSADRG=+$P(PSADATA,"^",2) S:'$D(PSAQTY) PSAQTY=+$P(PSADATA,"^",3)
"RTN","PSAVER3",23,0)
 ;DAVE B (13SEP99) PSA*3*19 If item is supply, skip this area
"RTN","PSAVER3",24,0)
 I $G(PSALNSU)=1,$G(PSADRG)=0,$G(PSASUP)>0 G SUPPLY
"RTN","PSAVER3",25,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),PSANDC=$P(PSADATA,"^",11)
"RTN","PSAVER3",26,0)
 ;DAVE B (PSA*3*19) Check for exisitence of NDC
"RTN","PSAVER3",27,0)
 S PSASUB=$S(+$P(PSATEMP,"^",3):+$P(PSATEMP,"^",3),1:0) ;NDC may be zero
"RTN","PSAVER3",28,0)
 I $G(PSANDC)'="",$G(PSANDC)'=0,$G(PSADRG)'="",$G(PSADRG)'=0,$D(^PSDRUG("C",PSANDC,PSADRG)) S PSASUB=$S($G(PSASUB):$G(PSASUB),+$O(^PSDRUG("C",PSANDC,PSADRG,0)):+$O(^PSDRUG("C",PSANDC,PSADRG,0)),1:0)
"RTN","PSAVER3",29,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER3",30,0)
 I '$D(PSAOU) D
"RTN","PSAVER3",31,0)
 .I +$P(PSADATA,"^",4),$P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'="" S PSAOU=+$P(PSADATA,"^",4) Q
"RTN","PSAVER3",32,0)
 .I PSADRG,PSASUB,$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",5) S PSAOU=$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",5) Q
"RTN","PSAVER3",33,0)
 .I $P(PSATEMP,"^",5)'="",+$P($P(PSATEMP,"^",5),"~",2) S PSAOU=+$P($P(PSATEMP,"^",5),"~",2)
"RTN","PSAVER3",34,0)
 I PSASUB D
"RTN","PSAVER3",35,0)
 .;Next line added 8APR98 (Dave B)
"RTN","PSAVER3",36,0)
 .S PSALOC=$S($G(PSALOC)'="":PSALOC,1:$S($P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",12):$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",12),$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",5):$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",5),1:0))
"RTN","PSAVER3",37,0)
 .S:'PSADUOU PSADUOU=$S(PSADRG&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:1)
"RTN","PSAVER3",38,0)
 .S:'PSASTOCK PSASTOCK=$S(PSADRG:+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER3",39,0)
 .S:'PSAREORD PSAREORD=$S(PSADRG:+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER3",40,0)
 ;
"RTN","PSAVER3",41,0)
SUPPLY ;If it is a supply, automatically verify it.
"RTN","PSAVER3",42,0)
 I '+$G(PSAERR),PSALNSU,'$G(PSAPRINT) D VERIFY,VERIFY1 Q
"RTN","PSAVER3",43,0)
 Q:$G(PSASUP)&(+$G(PSAERR))  ;; <PSA*3*70 RJS
"RTN","PSAVER3",44,0)
 ;
"RTN","PSAVER3",45,0)
NEWDRUG ;Store in array if drug is new to location/vault
"RTN","PSAVER3",46,0)
 I +PSADRG D
"RTN","PSAVER3",47,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N",+$P(PSAIN,"^",12),'$D(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)) D
"RTN","PSAVER3",48,0)
 ..S PSAHOLD(+$P(PSAIN,"^",12),PSAIEN,PSAIEN1,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"UNKNOWN"))=PSADRG,$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=1
"RTN","PSAVER3",49,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)'["N",+$P(PSAIN,"^",5),'$D(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)) D
"RTN","PSAVER3",50,0)
 ..S PSAHOLD(+$P(PSAIN,"^",5),PSAIEN,PSAIEN1,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"UNKNOWN"))=PSADRG,$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=0
"RTN","PSAVER3",51,0)
 ;
"RTN","PSAVER3",52,0)
NOTSUP ;If it is not a supply, look for drug, qty, dispense units, dispense
"RTN","PSAVER3",53,0)
 ;units/order unit, order unit, location/master vault, & reorder level
"RTN","PSAVER3",54,0)
 I '+$P(PSADATA,"^",2)&('$G(PSADRG)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"D"
"RTN","PSAVER3",55,0)
 I $P(PSADATA,"^",3)=""&($G(PSAQTY)="") S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"Q"
"RTN","PSAVER3",56,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",8)="" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_8
"RTN","PSAVER3",57,0)
 I '+$P($G(^PSDRUG(PSADRG,1,+PSASUB,0)),"^",7)&('+$G(PSADUOU)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"U"
"RTN","PSAVER3",58,0)
 I '+$P(PSADATA,"^",4)&('$G(PSAOU)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"O"
"RTN","PSAVER3",59,0)
 ;
"RTN","PSAVER3",60,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)'["N" D
"RTN","PSAVER3",61,0)
 .I '+$P(PSAIN,"^",5) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"P" D CS^PSAVER5
"RTN","PSAVER3",62,0)
 .S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=0,PSADATA=^(0)
"RTN","PSAVER3",63,0)
 I $P(PSAIN,"^",8)="N"!($P(PSAIN,"^",8)="S"),'+$P(PSAIN,"^",5),$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))'["P" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"P"
"RTN","PSAVER3",64,0)
 ;
"RTN","PSAVER3",65,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" D
"RTN","PSAVER3",66,0)
 .I '+$P(PSAIN,"^",12) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"M" D CS^PSAVER5
"RTN","PSAVER3",67,0)
 .S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=1,PSADATA=^(0)
"RTN","PSAVER3",68,0)
 I $P(PSAIN,"^",8)="A"!($P(PSAIN,"^",8)="S"),'+$P(PSAIN,"^",12),$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))'["M" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"M"
"RTN","PSAVER3",69,0)
 ;
"RTN","PSAVER3",70,0)
 S:$D(PSANOVER(PSAIEN,PSAIEN1,PSALINE)) PSAERR=PSAERR+1,PSALNERR=1
"RTN","PSAVER3",71,0)
 I 'PSAERR D GOOD Q
"RTN","PSAVER3",72,0)
 Q
"RTN","PSAVER3",73,0)
 ;
"RTN","PSAVER3",74,0)
GOOD ;If no errors found, verify invoice.
"RTN","PSAVER3",75,0)
 D VERIFY,VERIFY1
"RTN","PSAVER3",76,0)
 S PSAL=0 F  S PSAL=+$O(PSAHOLD(PSAL)) Q:'PSAL  D
"RTN","PSAVER3",77,0)
 .S PSANAME="" F  S PSANAME=$O(PSAHOLD(PSAL,PSAIEN,PSAIEN1,PSANAME)) Q:PSANAME=""  D
"RTN","PSAVER3",78,0)
 ..S PSANEWD(PSAL,PSANAME)=PSAHOLD(PSAL,PSAIEN,PSAIEN1,PSANAME)
"RTN","PSAVER3",79,0)
 K PSAHOLD
"RTN","PSAVER3",80,0)
 Q
"RTN","PSAVER3",81,0)
 ;
"RTN","PSAVER3",82,0)
PRINT ;Prints verification error list
"RTN","PSAVER3",83,0)
 S DIR(0)="Y",DIR("A")="Do you want to print the verification error report",DIR("B")="N"
"RTN","PSAVER3",84,0)
 S DIR("?",1)="Enter YES if you want to print the report just displayed.",DIR("?")="Enter NO if you do not want to print the report.",DIR("??")="^D PRINTYN^PSAVER3"
"RTN","PSAVER3",85,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER3",86,0)
 Q:Y=""!('+Y)
"RTN","PSAVER3",87,0)
 W ! S %ZIS="Q" D ^%ZIS Q:POP
"RTN","PSAVER3",88,0)
 I $D(IO("Q")) D  Q
"RTN","PSAVER3",89,0)
 .S ZTDESC="Drug Acct. - Print Prime Vendor Invoices",ZTRTN="PRN^PSAVER3"
"RTN","PSAVER3",90,0)
 .I $O(PSANOVER(0))'="" S ZTSAVE("PSANOVER(")=""
"RTN","PSAVER3",91,0)
 .F PSASAVE="PSAIN","PSASLN" S:$D(@PSASAVE) ZTSAVE(PSASAVE)=""
"RTN","PSAVER3",92,0)
 .D ^%ZTLOAD
"RTN","PSAVER3",93,0)
PRN ;Entry point to print verification errors
"RTN","PSAVER3",94,0)
 S (PSAERR,PSALINE,PSAOUT,PSAPG)=0,PSAPRINT=1
"RTN","PSAVER3",95,0)
 S PSAIEN=0 F  S PSAIEN=$O(PSANOVER(PSAIEN)) Q:'PSAIEN!(PSAOUT)  D
"RTN","PSAVER3",96,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))  S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^")
"RTN","PSAVER3",97,0)
 .S PSAIEN1=0 F  S PSAIEN1=$O(PSANOVER(PSAIEN,PSAIEN1)) Q:'PSAIEN1!(PSAOUT)  D
"RTN","PSAVER3",98,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))  S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0),PSAINV=$P(PSAIN,"^")
"RTN","PSAVER3",99,0)
 ..S PSALINE=0 F  S PSALINE=$O(PSANOVER(PSAIEN,PSAIEN1,PSALINE)) Q:'PSALINE!(PSAOUT)  D
"RTN","PSAVER3",100,0)
 ...D NOVER
"RTN","PSAVER3",101,0)
 .K PSANOVER(PSAIEN)
"RTN","PSAVER3",102,0)
 W !!,"** The invoice has not been placed in a Verified status!",!
"RTN","PSAVER3",103,0)
 D:$E(IOST,1,2)="C-" END^PSAPROC W:$E(IOST)'="C" @IOF
"RTN","PSAVER3",104,0)
 D ^%ZISC
"RTN","PSAVER3",105,0)
 Q
"RTN","PSAVER3",106,0)
 ;
"RTN","PSAVER3",107,0)
NOVER ;Prints errors
"RTN","PSAVER3",108,0)
 S PSANO=PSANOVER(PSAIEN,PSAIEN1,PSALINE),PSALEN=$L(PSANO)
"RTN","PSAVER3",109,0)
 S PSALINEN=$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)),"^"),PSATAB=$L(PSALINEN)+8
"RTN","PSAVER3",110,0)
 I $E(IOST,1,2)="C-" D:'PSAPG HDR I $Y+(4+PSALEN)>IOSL D END^PSAPROC Q:PSAOUT  D HDR
"RTN","PSAVER3",111,0)
 I $E(IOST)'="C",$Y+(4+PSALEN)>IOSL!('PSAPG) D HDR
"RTN","PSAVER3",112,0)
 W "Line# "_PSALINEN_": "
"RTN","PSAVER3",113,0)
 W:PSANO[8 ?PSATAB,"Dispense unit",!
"RTN","PSAVER3",114,0)
 W:PSANO["U" ?PSATAB,"Dispense unit per order unit",!
"RTN","PSAVER3",115,0)
 W:PSANO["D" ?PSATAB,"Drug",!
"RTN","PSAVER3",116,0)
 I PSANO["M" W ?PSATAB,"Master Vault",!
"RTN","PSAVER3",117,0)
 W:PSANO["O" ?PSATAB,"Order unit",!
"RTN","PSAVER3",118,0)
 I PSANO["P" W ?PSATAB,"Pharmacy location",!
"RTN","PSAVER3",119,0)
 W:PSANO["Q" ?PSATAB,"Quantity",!
"RTN","PSAVER3",120,0)
 W !
"RTN","PSAVER3",121,0)
 Q
"RTN","PSAVER3",122,0)
 ;
"RTN","PSAVER3",123,0)
HDR ;Prints header
"RTN","PSAVER3",124,0)
 I $E(IOST,1,2)="C-" W @IOF,!?23,"<<< VERIFICATION ERROR REPORT >>>"
"RTN","PSAVER3",125,0)
 I $E(IOST)'="C" W:PSAPG'=1 @IOF W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",!?27,"VERIFICATION ERROR REPORT",?72,"Page "_PSAPG,!
"RTN","PSAVER3",126,0)
 S PSAPG=PSAPG+1
"RTN","PSAVER3",127,0)
 W !,"Order#: "_PSAORD_"  Invoice#: "_$P(PSAIN,"^")_"  Invoice Date: "_$$FMTE^XLFDT(+$P(PSAIN,"^",2)) W:'$G(PSAERR) !,PSASLN,!
"RTN","PSAVER3",128,0)
 I $G(PSAERR) W !!,"The following line numbers' status cannot be changed to Verified.",!,"The fields that contain an error or need data are listed with the line item.",!,PSASLN,!
"RTN","PSAVER3",129,0)
 Q
"RTN","PSAVER3",130,0)
 ;
"RTN","PSAVER3",131,0)
STATUS ;Sets invoice's status to Verified
"RTN","PSAVER3",132,0)
 ;
"RTN","PSAVER3",133,0)
 ;PSA*3*3 (DAVE B)
"RTN","PSAVER3",134,0)
 S DA=PSAIEN1,DA(1)=PSAIEN,DIE="^PSD(58.811,"_DA(1)_",1,",DR="2///V;12////^S X="_DUZ
"RTN","PSAVER3",135,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER3",136,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER3",137,0)
 K DIE
"RTN","PSAVER3",138,0)
 Q
"RTN","PSAVER3",139,0)
 ;
"RTN","PSAVER3",140,0)
VERIFY ;Set line item to verified
"RTN","PSAVER3",141,0)
 I PSADRG,$P($G(^PSDRUG(PSADRG,2)),"^",3)["N" S PSACSLN=1
"RTN","PSAVER3",142,0)
 E  S PSACSLN=0
"RTN","PSAVER3",143,0)
 K DA S DA=PSALINE,DA(1)=PSAIEN1,DA(2)=PSAIEN,DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DR="7///^S X="_DT_";8////^S X="_DUZ_";12///^S X=PSACSLN"
"RTN","PSAVER3",144,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER3",145,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER3",146,0)
 K DIE
"RTN","PSAVER3",147,0)
 Q
"RTN","PSAVER3",148,0)
 ;
"RTN","PSAVER3",149,0)
VERIFY1 ;Set adjs if entire invioce was verified
"RTN","PSAVER3",150,0)
 S DA=0 F  S DA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA)) Q:'DA  D
"RTN","PSAVER3",151,0)
 .Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0))
"RTN","PSAVER3",152,0)
 .Q:$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0),"^",9)=DUZ
"RTN","PSAVER3",153,0)
 .S PSAREA="",PSADJ=$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0),"^",2) D ADJ^PSAVER2
"RTN","PSAVER3",154,0)
 Q
"RTN","PSAVER3",155,0)
 ;
"RTN","PSAVER3",156,0)
DDQOR ;Extended help for 'Edit field'
"RTN","PSAVER3",157,0)
 W !?5,"Enter the number or range of numbers of the field you want to edit.",!?5,"For example, 1-3 or 1,3"
"RTN","PSAVER3",158,0)
 Q
"RTN","PSAVER3",159,0)
LNHELP ;Extended help for 'Line Number"
"RTN","PSAVER3",160,0)
 W !?5,"Enter the number of the item on the invoice you want to edit.",!?5,"You may enter several line item numbers separated by comas.",!!?5,"Do NOT enter a range of numbers separated by a dash."
"RTN","PSAVER3",161,0)
 Q
"RTN","PSAVER3",162,0)
PRINTYN ;Extended help for 'Print verification report'
"RTN","PSAVER3",163,0)
 W !?5,"Enter YES to print the Verification Error Report on a printer.",!?5,"Enter NO if you do not want to print the report."
"RTN","PSAVER3",164,0)
 Q
"RTN","PSAVERA")
0^7^B44615569^B44372640
"RTN","PSAVERA",1,0)
PSAVERA ;BHM/DBM - Change verified invoice data;16AUG05
"RTN","PSAVERA",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,36,40,53,63,70**; 10/24/97;Build 12
"RTN","PSAVERA",3,0)
 ;
"RTN","PSAVERA",4,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVERA",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVERA",6,0)
 D Q
"RTN","PSAVERA",7,0)
 D HOME^%ZIS S XX="VERIFIED INVOICE ALTERATION SCREEN" W @IOF,!!,?((IOM/2)-($L(XX)/2)),XX,!!
"RTN","PSAVERA",8,0)
ORDR ;Get Order Number
"RTN","PSAVERA",9,0)
 S DIC(0)="AEQMZ",DIC("A")="Select Order Number: ",DIC="^PSD(58.811," D ^DIC K DIC G Q:+Y'>0 S PSAIEN=+Y,PSAORD=$P(Y,U,2)
"RTN","PSAVERA",10,0)
 ;
"RTN","PSAVERA",11,0)
INV ;Get Invoice Number
"RTN","PSAVERA",12,0)
 S DIC(0)="AEQMZ",DIC("A")="Select Invoice Number: ",DIC="^PSD(58.811,"_PSAIEN_",1,",D="ASTAT" D ^DIC K DIC G Q:+Y'>0 S PSAIEN1=+Y,PSAINV=$P(Y,U,2)
"RTN","PSAVERA",13,0)
 S DATA=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVERA",14,0)
 S PSALOC=$S($P(DATA,"^",12)'="":$P(DATA,"^",12),1:$P(DATA,"^",5)) I $G(PSALOC)="" S PSALOC="No Location identified"
"RTN","PSAVERA",15,0)
 D ^PSAVERA1
"RTN","PSAVERA",16,0)
 K DATA,PSAITM,LINENUM,X,X1,X2,X3,DIC,DA,DR D HDR
"RTN","PSAVERA",17,0)
DISP S PSAITM=$S('$D(PSAITM):$O(INVARRAY(PSAORD,PSAINV,0)),1:$O(INVARRAY(PSAORD,PSAINV,PSAITM))) G LINEASK:PSAITM'>0 S LINENUM=$G(LINENUM)+1
"RTN","PSAVERA",18,0)
 S DATA=$G(INVARRAY(PSAORD,PSAINV,PSAITM)),PSAOU=$P(DATA,"^",4) I $G(PSAOU) S PSAOU(1)=$P($G(^DIC(51.5,$P(DATA,"^",4),0)),"^") ;Current Order Unit  ;; <*63 RJS
"RTN","PSAVERA",19,0)
 W !,PSAITM,?6,$S($P($P(DATA,"^",1),"~",1)'>0:$P($P(DATA,"^",1),"~",1),1:$P($P(DATA,"^",1),"~",2)),?45,$S($G(PSAOU)="":"none",$G(PSAOU(1))'="":$G(PSAOU(1)),1:$G(PSAAOU)),?55,$J($P($G(DATA),"^",2),4),?61,$P(DATA,"^",5)  ;;<PSA*3*70 RJS
"RTN","PSAVERA",20,0)
 I IOST["C-",$Y>(IOSL-5) S DIR(0)="E" D ^DIR G Q:$G(DUOUT)=1 D HDR
"RTN","PSAVERA",21,0)
 G DISP
"RTN","PSAVERA",22,0)
LINEASK ;ask for line number
"RTN","PSAVERA",23,0)
 W !,"Enter the corresponding item number to edit: " R AN:DTIME I AN["^"!(AN="") G Q
"RTN","PSAVERA",24,0)
 I AN<1!(AN>LINENUM) W !,"Enter a number between 1 & ",LINENUM,! G LINEASK
"RTN","PSAVERA",25,0)
 I "?"[AN W !,"Select the number that corresponds to the line item that needs editing",! K AN G LINEASK
"RTN","PSAVERA",26,0)
 S DATA=$G(INVARRAY(PSAORD,PSAINV,AN))
"RTN","PSAVERA",27,0)
 S PSALINE=AN,PSAIN="NADA" I '$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)) W !,"Invalid line selection." G LINEASK
"RTN","PSAVERA",28,0)
 S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),PSASUP=0
"RTN","PSAVERA",29,0)
 S PSACS=0 S:+$P(PSADATA,"^",10) PSACS=$G(PSACS)+1
"RTN","PSAVERA",30,0)
 S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAVERA",31,0)
 S PSALINEN="" D VERDISP^PSAUTL4 W !,PSASLN,!
"RTN","PSAVERA",32,0)
 S PSAVEND=$P(^PSD(58.811,PSAIEN,0),"^",2)
"RTN","PSAVERA",33,0)
 S PSAODUOU=PSADUOU
"RTN","PSAVERA",34,0)
 ;; *63
"RTN","PSAVERA",35,0)
 S PSA581="" F  S PSA581=$O(^PSD(58.81,"PV",PSAINV,PSA581)) Q:'PSA581  I $P(^PSD(58.81,PSA581,0),U,5)=PSADRG S PSABFR(581)=$G(^PSD(58.81,PSA581,0))
"RTN","PSAVERA",36,0)
 S:$G(PSABFR(581)) PSDTRN=$P(PSABFR(581),U,1),PSABFR("Q")=$S($G(^PSD(58.81,PSDTRN,4)):$P(^PSD(58.81,PSDTRN,4),"^",3),1:$P(^PSD(58.81,PSDTRN,0),"^",6)) ; <*63 RJS >
"RTN","PSAVERA",37,0)
DRG W !,"Select (D)rug or (O)rder Unit " R AN:DTIME G Q:AN["^"!(AN="") W $S("Dd"[AN:"rug","oO"[AN:"rder Unit",1:"??") I "DdOo"'[AN W !,"Enter a 'D' to edit the Drug, or 'O' to edit the order unit",! K AN G DRG
"RTN","PSAVERA",38,0)
 I "Dd"'[AN D ^PSAVERA3 G Q  ;;*63
"RTN","PSAVERA",39,0)
 ;Get either new name of drug or supply item description
"RTN","PSAVERA",40,0)
 S PSABFR=$P(DATA,"~",1),PSABFR(1)=$S(PSABFR'?.N:PSABFR,1:$P($P(DATA,"^"),"~",2)),PSABFR("NDC")=$P(PSADATA,"^",11)  ;;*63
"RTN","PSAVERA",41,0)
DRGAGN D
"RTN","PSAVERA",42,0)
 .S X1=0 F  S X1=$O(^PSDRUG(PSABFR,1,X1)) Q:X1'>0  S DATA=$G(^PSDRUG(PSABFR,1,X1,0)) I $P(DATA,"^",2)=PSABFR("NDC") S PSABFR("SYNNODE")=X1  ;;*63
"RTN","PSAVERA",43,0)
 D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVERA",44,0)
 I $G(PSABFR("SYNNODE"))="",$E(PSABFR("NDC"))'="S" S PSABFR("NDC")="S"_PSABFR("NDC") G DRGAGN ;may be supply, try again
"RTN","PSAVERA",45,0)
 I $G(PSABFR("SYNNODE"))'="" S PSASUB=PSABFR("SYNNODE") D
"RTN","PSAVERA",46,0)
 .S DATA=$G(^PSDRUG(PSABFR,1,PSASUB,0)),PSAOU=$P(DATA,"^",5),PSAPOU=$P(DATA,"^",6),PSADUOU=$P(DATA,"^",7),PSAPDUOU=$P(DATA,"^",8)
"RTN","PSAVERA",47,0)
 .S PSADU=$P($G(^PSDRUG(PSABFR,660)),"^",8)
"RTN","PSAVERA",48,0)
 I ($G(PSAOU)=""!$G(PSAPOU)=""!$G(PSADUOU)=""!$G(PSAPDUOU)="") W !!,"Sorry, I could not find the necessary information to change the drug selection.",! G Q
"RTN","PSAVERA",49,0)
 W !,"Current Drug : ",PSABFR(1)
"RTN","PSAVERA",50,0)
DRG1 S PSAGAIN=0,DIC("A")="Select name of Correct Drug: ",PSABFR=PSADRG,DIC(0)="AEQMZ",DIC="^PSDRUG(" D ^DIC K DIC G Q:PSAOUT
"RTN","PSAVERA",51,0)
 I $G(DTOUT)!($G(DUOT))!(Y<0) S PSAOUT=1 Q
"RTN","PSAVERA",52,0)
 S (PSADJ,PSADRG)=+Y
"RTN","PSAVERA",53,0)
 W !!,"Comparing drug file data..."
"RTN","PSAVERA",54,0)
 S PSAODU=$P($G(^PSDRUG(PSADRG,660)),"^",8),PSAXDUOU=$P($G(^PSDRUG(PSADRG,660)),"^",5)
"RTN","PSAVERA",55,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",2)'=$G(PSAOU) W !,"The Order Units are different between these two drugs."
"RTN","PSAVERA",56,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",8)'=$G(PSADU) W !,"Please Enter an appropriate Dispense Unit" S DIE="^PSDRUG(",DA=PSADRG,DR="14.5" D ^DIE S PSADU=$P(^PSDRUG(PSADRG,660),"^",8)
"RTN","PSAVERA",57,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",5)'=$G(PSADUOU) W !,"Please enter the appropriate Dispense Units per order unit" S DIE="^PSDRUG(",DA=PSADRG,DR="15" D ^DIE S PSADUOU=$P(^PSDRUG(PSADRG,660),"^",5)
"RTN","PSAVERA",58,0)
 K DIE,DA,DR
"RTN","PSAVERA",59,0)
ASK R !!,"Are you sure about this ?  NO// ",AN:DTIME G NOCHNG:AN["^"!(AN="")
"RTN","PSAVERA",60,0)
 S AN=$E(AN) I "yYnN"'[AN W !,"Answer yes, and the data on file for the current drug will be transferred",!,"to the new drug selection.",!,"That includes Order Unit, Dispense Unit, Dispense Units per Order Unit, etc.",!! G ASK
"RTN","PSAVERA",61,0)
 I "Nn"[AN G NOCHNG ;*53
"RTN","PSAVERA",62,0)
 S PSAAFTER=PSADRG,PSADRG=PSABFR
"RTN","PSAVERA",63,0)
 I $D(^PSDRUG(PSADRG))&$G(PSABFR(581)) D
"RTN","PSAVERA",64,0)
 .W !,"Removing "_PSABFR("Q")_" from "_PSABFR(1)
"RTN","PSAVERA",65,0)
 .S FMDATA=$P($G(^PSDRUG(PSADRG,660.1)),"^")-PSABFR("Q"),DIE="^PSDRUG(",DA=PSADRG,DR="50////^S X="_FMDATA
"RTN","PSAVERA",66,0)
 .F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVERA",67,0)
 .D ^DIE L -^PSDRUG(DA,0) K FMDATA
"RTN","PSAVERA",68,0)
 S PSADRG=PSAAFTER
"RTN","PSAVERA",69,0)
 I $G(PSAPOU)="",$G(PSAPRICE)'="" S PSAPOU=PSAPRICE
"RTN","PSAVERA",70,0)
 W !,"Adding "_($G(PSAQTY)*$G(PSADUOU))_" to "_$P($G(^PSDRUG(PSADRG,0)),"^")
"RTN","PSAVERA",71,0)
 W !,"Entering new drug selection as an adjustment."
"RTN","PSAVERA",72,0)
 S PSAREA="",PSADJFLD="D",PSADJ=PSADRG D RECORD^PSAVER2,50^PSAVER7
"RTN","PSAVERA",73,0)
FILE ;File dispense units per order units into 58.811
"RTN","PSAVERA",74,0)
 S DIE="^PSD(58.811,"_PSAIEN_",1,"_PSAIEN1_",1,",DA=PSALINE,DA(1)=PSAIEN1,DA(2)=PSAIEN,DR="10///"_PSADUOU D ^DIE
"RTN","PSAVERA",75,0)
 G:$D(^PSD(58.811,"ASTAT","P",PSAIEN,PSAIEN1)) Q  ;; *63 RJS
"RTN","PSAVERA",76,0)
 D UPDATE^PSAVERA1 G Q
"RTN","PSAVERA",77,0)
 ;
"RTN","PSAVERA",78,0)
HDR W @IOF,!?25,"EDIT VERIFIED INVOICED ITEM SCREEN",!,PSASLN,!
"RTN","PSAVERA",79,0)
 W !,?44,"Order",!,"#",?6,"Drug/Item Name",?45,"Unit",?56,"Qnty.",?67,"NDC",!,PSASLN,! Q  ;; <- PSA*3*70 RJS
"RTN","PSAVERA",80,0)
Q K AN,D,DA,DATA,DIC,DIR,INVARRAY,LINENUM,POP,PSA50IEN,PSA581,PSAABAL,PSAAFTER,PSAAQTY,PSABAL,PSABFR,PSACS,PSADASH,PSADATA,PSADJ,PSADJD,PSADJFLD,PSADJO,PSADJP,PSADJQ,PSADRG,PSADRUGN,PSADT
"RTN","PSAVERA",81,0)
 K PSADU,PSADUOU,PSADUREC,PSAEDTT,PSAGAIN,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSAITM,PSALINE,PSALINEN,PSALOC,PSANDC,PSANDUOU,PSANEW,PSANODE,PSANPDU,PSANQTY,PSAODASH,PSAODU,PSAODUOU,PSAONDC,PSAORD
"RTN","PSAVERA",82,0)
 K PSAOU,PSAOUT,PSAPOU,PSAPRICE,PSAQTY,PSAREA,PSAREORD,PSASET,PSASLN,PSASTOCK,PSASUB,PSASUP,PSASUPP,PSAT,PSATEMP,PSAUPC,PSAVDUZ,PSAVEND,PSAVER,PSAVSN,PSAXDUOU,PSDTRN,X,X1,X2,X3,XX,XXX,Y
"RTN","PSAVERA",83,0)
 Q
"RTN","PSAVERA",84,0)
NOCHNG ;*53 said no to changes, backout the edits on the new drug choice.
"RTN","PSAVERA",85,0)
 K DIE,DR,DA
"RTN","PSAVERA",86,0)
 S DIE="^PSDRUG(",DA=PSADRG,DR="14.5////^S X=PSAODU;15////^S X=PSAXDUOU" D ^DIE
"RTN","PSAVERA",87,0)
 W !,"NO CHANGE",! G Q
"RTN","PSAVERA1")
0^8^B60705765^B59601347
"RTN","PSAVERA1",1,0)
PSAVERA1 ;BHM/DB - Edit previously verified invoices;16NOV99
"RTN","PSAVERA1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,61,63,70**; 10/24/97;Build 12
"RTN","PSAVERA1",3,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVERA1",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVERA1",5,0)
 ;
"RTN","PSAVERA1",6,0)
 S $P(PSASLN,"=",79)="" K PSALINE
"RTN","PSAVERA1",7,0)
DISPLN S PSALINE=$S('$D(PSALINE):$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,0)),1:$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE))) G Q:PSALINE'>0 S CNT=$G(CNT)+1
"RTN","PSAVERA1",8,0)
 S PSADATA=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVERA1",9,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVERA1",10,0)
 S PSAVSN=$P(PSADATA,"^",12),PSAOUT=0,PSADRUGN=""
"RTN","PSAVERA1",11,0)
DRUG S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAVERA1",12,0)
 I $G(PSADJ) D
"RTN","PSAVERA1",13,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVERA1",14,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVERA1",15,0)
 .S PSASUP=$S(PSADJD'?1.N:1,1:0)
"RTN","PSAVERA1",16,0)
 .S PSADRG=$S(PSADJ&('PSASUP):$G(PSADJD),PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAVERA1",17,0)
 .I $G(PSADJD),$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S (PSADRG,PSA50IEN)=+PSADJD Q
"RTN","PSAVERA1",18,0)
 .I $G(PSADJD),$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAVERA1",19,0)
 .S PSADJSUP=1,(PSADRG,PSA50IEN)=PSADJD
"RTN","PSAVERA1",20,0)
 I '$G(PSADJ) D
"RTN","PSAVERA1",21,0)
 .S (PSA50IEN,PSADRG)=$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):+$P(PSADATA,"^",2),1:0)
"RTN","PSAVERA1",22,0)
 I $G(PSASUP) S PSADRUGN=PSADRG_" - SUP/ITM"  ;;<- PSA*3*70 RJS
"RTN","PSAVERA1",23,0)
 S:'$G(PSADRUGN) PSADRUGN=$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"Unknown Drug Name/Supply Item")
"RTN","PSAVERA1",24,0)
QTY ;Quantity
"RTN","PSAVERA1",25,0)
 ;No Adj. Qty
"RTN","PSAVERA1",26,0)
 S PSADJQ="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAVERA1",27,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVERA1",28,0)
 ;Adj. Qty
"RTN","PSAVERA1",29,0)
 I $G(PSADJQ) S PSAQTY=PSADJQ
"RTN","PSAVERA1",30,0)
 I '$G(PSADJQ) S PSAQTY=$P(PSADATA,"^",3)
"RTN","PSAVERA1",31,0)
UPC S:$P(PSADATA,"^",13) PSAUPC=$P(PSADATA,"^",13)
"RTN","PSAVERA1",32,0)
OU ;W !,"Order Unit  : "
"RTN","PSAVERA1",33,0)
 S PSAOU=$S(+$P(PSADATA,"^",4)&($P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'=""):+$P(PSADATA,"^",4),1:"")
"RTN","PSAVERA1",34,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVERA1",35,0)
 I +$P(PSATEMP,"^",3),PSADRG,+$P($G(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0)),"^",5) S PSAOU=+$P(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0),"^",5)
"RTN","PSAVERA1",36,0)
 S PSADJO="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAVERA1",37,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVERA1",38,0)
 ;Adj. Order Unit
"RTN","PSAVERA1",39,0)
 I PSADJO'="" S PSAOU=+PSADJO
"RTN","PSAVERA1",40,0)
 I PSADJO="" ;W $S(+PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"Blank")
"RTN","PSAVERA1",41,0)
 ;
"RTN","PSAVERA1",42,0)
NDC S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAVERA1",43,0)
 ;I $E(PSANDC)'="S" W ?38,"NDC: "_$S(PSANDC'="":$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12),1:"Blank")
"RTN","PSAVERA1",44,0)
 ;
"RTN","PSAVERA1",45,0)
PRICE ;W !,"Unit Price  : $"
"RTN","PSAVERA1",46,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAVERA1",47,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAVERA1",48,0)
 ;Adj. Unit Price
"RTN","PSAVERA1",49,0)
 I $G(PSADJP) D
"RTN","PSAVERA1",50,0)
 .I $L($P(PSADJP,".",2))<2 S PSADJP=$P(PSADJP,".")_"."_$P(PSADJP,".",2)_$E("00",1,(2-$L($P(PSADJP,".",2))))
"RTN","PSAVERA1",51,0)
 .;W $FN(PSADJP,",")_" ($"_$S(+$P(PSADATA,"^",5):$FN($P(PSADATA,"^",5),","),$P(PSADATA,"^",5)=0:"0.00",1:"")_")"
"RTN","PSAVERA1",52,0)
 .S PSAPRICE=PSADJP
"RTN","PSAVERA1",53,0)
 I '$G(PSADJP) D
"RTN","PSAVERA1",54,0)
 .S PSAPRICE=+$P(PSADATA,"^",5)
"RTN","PSAVERA1",55,0)
 .;I $G(PSAPRICE)!(PSAPRICE=0) W $S($G(PSAPRICE):PSAPRICE,1:"0.00") Q
"RTN","PSAVERA1",56,0)
 .;W "Blank"
"RTN","PSAVERA1",57,0)
 ;
"RTN","PSAVERA1",58,0)
VSN ;W ?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAVERA1",59,0)
VDU S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVERA1",60,0)
 S INVARRAY(PSAORD,PSAINV,PSALINE)=$G(PSADRG)_"~"_$G(PSADRUGN)_"^"_$G(PSAQTY)_"^"_$G(PSALOC)_"^"_$G(PSAOU)_"^"_$G(PSANDC)_"^"_$G(PSAPRICE)_"^"_$G(PSAVSN)_"^"_$G(PSAUPC),PSASUP=0
"RTN","PSAVERA1",61,0)
 ;
"RTN","PSAVERA1",62,0)
 I '+$P($G(^PSD(58.8,+PSALOC,0)),"^",14) G DISPLN
"RTN","PSAVERA1",63,0)
 ;
"RTN","PSAVERA1",64,0)
STOCK S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3),1:"Blank")
"RTN","PSAVERA1",65,0)
REORDER S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5),1:"Blank")
"RTN","PSAVERA1",66,0)
 S INVARRAY(PSAORD,PSAINV,PSALINE)=$G(INVARRAY(PSAORD,PSAINV,PSALINE))_"^"_$G(PSASTOCK)_"^"_$G(PSAREORD)
"RTN","PSAVERA1",67,0)
 G DISPLN
"RTN","PSAVERA1",68,0)
ASK R !!,"Enter an '^' to abort, <RET> to continue, or a corresponding line item number: ",AN:DTIME I AN="" G DISPLN
"RTN","PSAVERA1",69,0)
 I AN["^" G Q
"RTN","PSAVERA1",70,0)
 I AN<0!(AN>CNT) W !,"Enter a number between 1 and ",CNT G ASK
"RTN","PSAVERA1",71,0)
 S (PSALINE,PSALINEN)=AN
"RTN","PSAVERA1",72,0)
PROCSS I '$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)) W !,"Invalid line number." G ASK
"RTN","PSAVERA1",73,0)
 S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),PSASUP=0
"RTN","PSAVERA1",74,0)
 S PSANDC=$P(PSADATA,"^",11),PSAVSN=$P(PSADATA,"^",12),PSALOC=$S($P(PSADATA,"^",10):+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAVERA1",75,0)
VIEW S PSALINEN=" " D VERDISP^PSAUTL4 W !,PSASLN,!
"RTN","PSAVERA1",76,0)
 W "1. Drug",!,"2. Order Unit",! S PSACHO=2
"RTN","PSAVERA1",77,0)
 S DIR(0)="LO^1:"_PSACHO,DIR("A")="Edit fields",DIR("?")="Enter the number(s) of the data to be edited" S DIR("??")="^D DDQOR^PSAVER3"
"RTN","PSAVERA1",78,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVERA1",79,0)
 Q:Y=""  S PSAFLDS=Y,PSASET=0 ;D VERDISP^PSAUTL4 W PSASLN
"RTN","PSAVERA1",80,0)
FIELDS F PSAPCF=1:1 S PSAFLD=$P(PSAFLDS,",",PSAPCF) Q:'PSAFLD!(PSAOUT)  D
"RTN","PSAVERA1",81,0)
 .I PSAFLD=1 D ASKDRUG^PSAVERA2 Q
"RTN","PSAVERA1",82,0)
 .I PSAFLD=2 D OU^PSAVER2 Q
"RTN","PSAVERA1",83,0)
Q Q
"RTN","PSAVERA1",84,0)
 ;
"RTN","PSAVERA1",85,0)
UPDATE ; *63 RJS CODE REMOVED FROM PSAVERA AND CALLED BY PSAVERA
"RTN","PSAVERA1",86,0)
 ;File data in 58.8
"RTN","PSAVERA1",87,0)
 ;PSALOC= Either PSALOC or PSALOCB
"RTN","PSAVERA1",88,0)
 S PSADRG=PSABFR
"RTN","PSAVERA1",89,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVERA1",90,0)
 S PSADUREC=PSAQTY*$G(PSAODUOU),PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4),$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSABAL-$G(PSABFR("Q"))
"RTN","PSAVERA1",91,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVERA1",92,0)
 S PSADRG=PSAAFTER,PSAABAL=PSABAL,PSADUREC=PSAQTY*$G(PSADUOU)
"RTN","PSAVERA1",93,0)
 D NOW^%DTC S PSADT=+$E(%,1,14)
"RTN","PSAVERA1",94,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAVERA1",95,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAVERA1",96,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,DINUM,X)=PSADRG,DIC(0)="L",DLAYGO=58.8 ;*53
"RTN","PSAVERA1",97,0)
 .F  L +^PSD(58.8,PSALOC,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVERA1",98,0)
 .D FILE^DICN L -^PSD(58.8,PSALOC,0) K DIC,DA,DLAYGO
"RTN","PSAVERA1",99,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVERA1",100,0)
 S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVERA1",101,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",1)'=PSADRG S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",1)=PSADRG
"RTN","PSAVERA1",102,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSADUREC+PSABAL
"RTN","PSAVERA1",103,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSAVERA1",104,0)
 .I PSASTOCK'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)=PSASTOCK
"RTN","PSAVERA1",105,0)
 .I PSAREORD'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5)=PSAREORD
"RTN","PSAVERA1",106,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAVERA1",107,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAVERA1",108,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSABAL)",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC
"RTN","PSAVERA1",109,0)
 .S X="T-1M" D ^%DT S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSAVERA1",110,0)
 .S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAVERA1",111,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DA=$E(DT,1,5)*100,DR="5////^S X="_($P($G(^(0)),"^",3)+PSADUREC) D ^DIE K DIE
"RTN","PSAVERA1",112,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVERA1",113,0)
 W !,"updating pharmacy location file."
"RTN","PSAVERA1",114,0)
FILE581 ;Update transaction file ;;*63
"RTN","PSAVERA1",115,0)
 S PSAVDUZ=DUZ,PSAREA="EDIT VERIFIED INVOICE"
"RTN","PSAVERA1",116,0)
 I '$G(PSABFR(581)) D NEW581 Q
"RTN","PSAVERA1",117,0)
 I PSADRG'=PSABFR S PSANQTY=0,PSAAQTY=$G(PSABFR("Q"))*-1
"RTN","PSAVERA1",118,0)
 I PSADRG=PSABFR S PSANQTY=PSADUREC D
"RTN","PSAVERA1",119,0)
 .S PSAAQTY=PSADUREC-$G(PSABFR("Q"))
"RTN","PSAVERA1",120,0)
FIND S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAVERA1",121,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSAVERA1",122,0)
 S DIE="^PSD(58.81,",DA=PSAT
"RTN","PSAVERA1",123,0)
 I PSAAFTER'=PSABFR S PSADRG=PSABFR
"RTN","PSAVERA1",124,0)
 S DR="1////14;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;48////^S X=PSADT;49////^S X=PSAVDUZ;50////^S X=PSANQTY;51////^S X=PSAAQTY;53////^S X=PSAREA;54////^S X=PSAABAL;71////^S X=PSAINV;106////^S X=PSAORD"
"RTN","PSAVERA1",125,0)
 F  L +^PSD(58.81,DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVERA1",126,0)
 D ^DIE L -^PSD(58.81,DA,0) K DIE
"RTN","PSAVERA1",127,0)
 I PSAAFTER'=PSABFR S PSADRG=PSAAFTER D NEW581
"RTN","PSAVERA1",128,0)
 Q
"RTN","PSAVERA1",129,0)
 ;
"RTN","PSAVERA1",130,0)
NEW581 S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G NEW581
"RTN","PSAVERA1",131,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSAVERA1",132,0)
 S PSADUREC=PSAQTY*$G(PSADUOU)
"RTN","PSAVERA1",133,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////1;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;5////^S X=PSADUREC;6////^S X=PSAVDUZ;9////^S X=PSABAL;71////^S X=PSAINV;106////^S X=PSAORD"
"RTN","PSAVERA1",134,0)
 I $G(PSACS)>0 S DR=DR_";100////^S X=PSACS"
"RTN","PSAVERA1",135,0)
 F  L +^PSD(58.81,DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVERA1",136,0)
 D ^DIE L -^PSD(58.81,DA,0) K DIE W !,"updating transaction file." Q
"RTN","PSAVERA1",137,0)
 Q
"RTN","PSAVERA3")
0^9^B13969445^B8881546
"RTN","PSAVERA3",1,0)
PSAVERA3 ;BHM/DB - RECORD TRANSACTION & UPDATE DRUG FILE;31JAN00
"RTN","PSAVERA3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,42,70**; 10/24/97;Build 12
"RTN","PSAVERA3",3,0)
 ;
"RTN","PSAVERA3",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVERA3",5,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVERA3",6,0)
 ;
"RTN","PSAVERA3",7,0)
OU S DIC(0)="QAEMZ",DIC="^DIC(51.5,",DIC("A")="Select New Order Unit: "
"RTN","PSAVERA3",8,0)
 D ^DIC G Q:+Y'>0 S PSAOU=+Y
"RTN","PSAVERA3",9,0)
 I $G(PSAOU)=$G(PSAAOU) W !,"No change." G Q
"RTN","PSAVERA3",10,0)
 ;;< PSA*3*70
"RTN","PSAVERA3",11,0)
 N PSATMPPR
"RTN","PSAVERA3",12,0)
 I $G(PSASUP) S (PSATMPPR,DIR("B"))=$S($P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",1)'="":$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",1),1:"Blank")
"RTN","PSAVERA3",13,0)
 I '$G(PSASUP) S (PSATMPPR,DIR("B"))=$S($P($G(^PSDRUG(PSADRG,660)),"^",5)'="":$P($G(^PSDRUG(PSADRG,660)),"^",5),1:"Blank")
"RTN","PSAVERA3",14,0)
 ;; PSA*3*70 <
"RTN","PSAVERA3",15,0)
 S DIR(0)="NO^::2",DIR("A")="DISPENSE UNITS PER ORDER UNIT"
"RTN","PSAVERA3",16,0)
 S DIR("?")="Enter the number of dispense units contained in one order unit",DIR("??")="^D DUOUHELP^PSAPROC3"
"RTN","PSAVERA3",17,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 G Q
"RTN","PSAVERA3",18,0)
 S PSANDUOU=+Y
"RTN","PSAVERA3",19,0)
 ;
"RTN","PSAVERA3",20,0)
DRG K PSASUB S X1=0 F  S X1=$O(^PSDRUG(PSADRG,1,X1)) Q:X1'>0  S DATA=$G(^PSDRUG(PSADRG,1,X1,0)) I $P(DATA,"^",1)=PSANDC S PSASUB=X1
"RTN","PSAVERA3",21,0)
 ;; < PSA*3*70 RJS
"RTN","PSAVERA3",22,0)
 W !,"Old Dispense Units Per Order Unit: "
"RTN","PSAVERA3",23,0)
 I '$G(PSASUP) W PSATMPPR,?45,"Price Per Disp. Unit: "_$J($P($G(^PSDRUG(PSADRG,660)),"^",6),8,2)
"RTN","PSAVERA3",24,0)
 I $G(PSASUP) W PSATMPPR,?45,"Price Per Disp. Unit: " D
"RTN","PSAVERA3",25,0)
 .I $G(PSANDUOU),$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^") W ($J($P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",5)/$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^"),8,2))
"RTN","PSAVERA3",26,0)
 W !,"New Dispense Units Per Order Unit: "_PSANDUOU
"RTN","PSAVERA3",27,0)
 I '$G(PSASUP),PSANDUOU=$P($G(^PSDRUG(PSADRG,660)),"^",5) W ?45," unchanged " G UPDATE
"RTN","PSAVERA3",28,0)
 I $G(PSASUP),PSANDUOU=$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^") W ?45," unchanged " G UPDATE
"RTN","PSAVERA3",29,0)
 I $G(PSAPRICE),$G(PSANDUOU) W ?64,$J((PSAPRICE/PSANDUOU),8,2)
"RTN","PSAVERA3",30,0)
 ;; PSA*3*70 RJS<
"RTN","PSAVERA3",31,0)
UPDATE ;update file
"RTN","PSAVERA3",32,0)
 S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^")=+PSANDUOU S:+PSANDUOU PSASET=1  ;;<PSA*3*70 RJS
"RTN","PSAVERA3",33,0)
 I $G(PSANDC)'="",$L(PSANDC)'=11 D
"RTN","PSAVERA3",34,0)
 .I $G(PSANDC)'="" S X=11,X1=$L(PSANDC) F X=1:1:(11-X1) S PSANDC="0"_PSANDC ;*42 11 digit NDC
"RTN","PSAVERA3",35,0)
 .S NDC0=1 F X=1:1:$L(PSANDC) I $E(PSANDC,X)'=0&($E(PSANDC,X)'="-") K NDC0
"RTN","PSAVERA3",36,0)
 .I $G(NDC0)=1 S PSANDC=""
"RTN","PSAVERA3",37,0)
 D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVERA3",38,0)
 ;;<PSA*3*70 RJS
"RTN","PSAVERA3",39,0)
 I '$G(PSASUP),$P($G(^PSDRUG(PSADRG,2)),"^",4)'=$G(PSADASH) S DIE="^PSDRUG(",DA=PSADRG,DR="31////^S X=PSADASH" D ^DIE
"RTN","PSAVERA3",40,0)
 S PSANPDU=0
"RTN","PSAVERA3",41,0)
 I $G(PSAPRICE),$G(PSANDUOU) S PSANPDU=PSAPRICE/PSANDUOU
"RTN","PSAVERA3",42,0)
 I $G(PSASUP) G SUPITM
"RTN","PSAVERA3",43,0)
 ;;>PSA*3*70 RJS
"RTN","PSAVERA3",44,0)
 W !,"Updating Drug File's Synonym data"
"RTN","PSAVERA3",45,0)
 I $G(PSASUB)=""!('$D(^PSDRUG(PSADRG,1))) S DA(1)=PSADRG,DIC="^PSDRUG("_DA(1)_",1,",DIC(0)="L",X=PSANDC,DLAYGO=50 D ^DIC S PSASUB=+Y
"RTN","PSAVERA3",46,0)
 S DA(1)=PSADRG,DIE="^PSDRUG("_DA(1)_",1,",DA=PSASUB,DR="401////^S X=PSAOU;403////^S X=PSANDUOU;404////^S X=PSANPDU" D ^DIE
"RTN","PSAVERA3",47,0)
 W !,"Updating Drug File's Dispense Units Per Order Unit & Price Per Dispense Unit"
"RTN","PSAVERA3",48,0)
 K DR,DIE
"RTN","PSAVERA3",49,0)
 S DA=DA(1),DIE="^PSDRUG(",DR="12///^S X=PSAOU;13////^S X=PSAPRICE;15////^S X=PSANDUOU" D ^DIE
"RTN","PSAVERA3",50,0)
SUPITM S PSADJFLD="O",PSADJ=PSAOU,PSAREA="" D RECORD^PSAVER2
"RTN","PSAVERA3",51,0)
 W !,"making adjustment in DRUG ACCOUNTABILITY ORDER file"
"RTN","PSAVERA3",52,0)
 W !,"TAKING A BREAK !?"
"RTN","PSAVERA3",53,0)
 Q
"RTN","PSAVERA3",54,0)
Q Q
"VER")
8.0^22.0
"BLD",7061,6)
^54
**END**
**END**

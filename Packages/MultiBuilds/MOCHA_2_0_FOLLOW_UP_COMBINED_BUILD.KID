KIDS Distribution saved on Jul 03, 2013@16:49:15
MOCHA 2.0 FOLLOW UP Combined Build
**KIDS**:MOCHA 2.0 FOLLOW UP Combined Build 1.0^PSJ*5.0*257^PSO*7.0*416^GMRA*4.0*47^OR*3.0*311^

**INSTALL NAME**
MOCHA 2.0 FOLLOW UP Combined Build 1.0
"BLD",8451,0)
MOCHA 2.0 FOLLOW UP Combined Build 1.0^^1^3130703^y
"BLD",8451,6.3)
18
"BLD",8451,10,0)
^9.63^4^4
"BLD",8451,10,1,0)
PSJ*5.0*257^1
"BLD",8451,10,2,0)
PSO*7.0*416^1
"BLD",8451,10,3,0)
GMRA*4.0*47^1
"BLD",8451,10,4,0)
OR*3.0*311^1
"BLD",8451,10,"B","GMRA*4.0*47",3)

"BLD",8451,10,"B","OR*3.0*311",4)

"BLD",8451,10,"B","PSJ*5.0*257",1)

"BLD",8451,10,"B","PSO*7.0*416",2)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"VER")
8.0^22.0
**INSTALL NAME**
PSJ*5.0*257
"BLD",8409,0)
PSJ*5.0*257^INPATIENT MEDICATIONS^0^3130703^y
"BLD",8409,1,0)
^^2^2^3121212^
"BLD",8409,1,1,0)
This patch is the follow up build for MEDICATION ORDER CHECK HEALTHCARE
"BLD",8409,1,2,0)
APPLICATION (MOCHA) 2.0.
"BLD",8409,4,0)
^9.64PA^53.1^3
"BLD",8409,4,53.1,0)
53.1
"BLD",8409,4,53.1,2,0)
^9.641^53.1^1
"BLD",8409,4,53.1,2,53.1,0)
NON-VERIFIED ORDERS  (File-top level)
"BLD",8409,4,53.1,2,53.1,1,0)
^9.6411^.01^3
"BLD",8409,4,53.1,2,53.1,1,.01,0)
ORDER NUMBER
"BLD",8409,4,53.1,2,53.1,1,.5,0)
PATIENT NAME
"BLD",8409,4,53.1,2,53.1,1,113,0)
CLINIC
"BLD",8409,4,53.1,222)
y^y^p^^^^n^^n
"BLD",8409,4,53.1,224)

"BLD",8409,4,53.46,0)
53.46
"BLD",8409,4,53.46,2,0)
^9.641^53.46^1
"BLD",8409,4,53.46,2,53.46,0)
CLINIC DEFINITION  (File-top level)
"BLD",8409,4,53.46,2,53.46,1,0)
^9.6411^6^1
"BLD",8409,4,53.46,2,53.46,1,6,0)
IMO DC/EXPIRED DAY LIMIT
"BLD",8409,4,53.46,222)
y^n^p^^^^n^^n
"BLD",8409,4,53.46,224)

"BLD",8409,4,55,0)
55
"BLD",8409,4,55,2,0)
^9.641^55.06^3
"BLD",8409,4,55,2,55,0)
PHARMACY PATIENT  (File-top level)
"BLD",8409,4,55,2,55,1,0)
^9.6411^.01^1
"BLD",8409,4,55,2,55,1,.01,0)
NAME
"BLD",8409,4,55,2,55.01,0)
IV  (sub-file)
"BLD",8409,4,55,2,55.01,1,0)
^9.6411^.03^1
"BLD",8409,4,55,2,55.01,1,.01,0)
ORDER NUMBER
"BLD",8409,4,55,2,55.01,1,.03,0)
STOP DATE/TIME
"BLD",8409,4,55,2,55.01,1,136,0)
CLINIC
"BLD",8409,4,55,2,55.06,0)
UNIT DOSE  (sub-file)
"BLD",8409,4,55,2,55.06,1,0)
^9.6411^34^1
"BLD",8409,4,55,2,55.06,1,.01,0)
ORDER NUMBER
"BLD",8409,4,55,2,55.06,1,.5,0)
PATIENT NAME
"BLD",8409,4,55,2,55.06,1,34,0)
STOP DATE/TIME
"BLD",8409,4,55,2,55.06,1,130,0)
CLINIC
"BLD",8409,4,55,222)
y^y^p^^^^n^^n
"BLD",8409,4,55,224)

"BLD",8409,4,"APDD",53.1,53.1)

"BLD",8409,4,"APDD",53.1,53.1,.01)

"BLD",8409,4,"APDD",53.1,53.1,.5)

"BLD",8409,4,"APDD",53.1,53.1,113)

"BLD",8409,4,"APDD",53.46,53.46)

"BLD",8409,4,"APDD",53.46,53.46,6)

"BLD",8409,4,"APDD",55,55)

"BLD",8409,4,"APDD",55,55,.01)

"BLD",8409,4,"APDD",55,55.01)

"BLD",8409,4,"APDD",55,55.01,.01)

"BLD",8409,4,"APDD",55,55.01,.03)

"BLD",8409,4,"APDD",55,55.01,136)

"BLD",8409,4,"APDD",55,55.06)

"BLD",8409,4,"APDD",55,55.06,.01)

"BLD",8409,4,"APDD",55,55.06,.5)

"BLD",8409,4,"APDD",55,55.06,34)

"BLD",8409,4,"APDD",55,55.06,130)

"BLD",8409,4,"B",53.1,53.1)

"BLD",8409,4,"B",53.46,53.46)

"BLD",8409,4,"B",55,55)

"BLD",8409,6)
35^
"BLD",8409,6.3)
105
"BLD",8409,"ABPKG")
n
"BLD",8409,"INID")
^n
"BLD",8409,"INIT")
PSJ257PO
"BLD",8409,"KRN",0)
^9.67PA^779.2^20
"BLD",8409,"KRN",.4,0)
.4
"BLD",8409,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8409,"KRN",.401,0)
.401
"BLD",8409,"KRN",.402,0)
.402
"BLD",8409,"KRN",.403,0)
.403
"BLD",8409,"KRN",.5,0)
.5
"BLD",8409,"KRN",.84,0)
.84
"BLD",8409,"KRN",3.6,0)
3.6
"BLD",8409,"KRN",3.8,0)
3.8
"BLD",8409,"KRN",9.2,0)
9.2
"BLD",8409,"KRN",9.8,0)
9.8
"BLD",8409,"KRN",9.8,"NM",0)
^9.68A^49^20
"BLD",8409,"KRN",9.8,"NM",27,0)
PSIVOCDS^^0^B131643526
"BLD",8409,"KRN",9.8,"NM",28,0)
PSJOC^^0^B32808738
"BLD",8409,"KRN",9.8,"NM",29,0)
PSJOCDS^^0^B73617469
"BLD",8409,"KRN",9.8,"NM",30,0)
PSJBLDOC^^0^B52892828
"BLD",8409,"KRN",9.8,"NM",31,0)
PSJGMRA^^0^B26285552
"BLD",8409,"KRN",9.8,"NM",32,0)
PSJOCDI^^0^B93276069
"BLD",8409,"KRN",9.8,"NM",35,0)
PSJOCDT^^0^B55618824
"BLD",8409,"KRN",9.8,"NM",36,0)
PSGFILED^^0^B25006038
"BLD",8409,"KRN",9.8,"NM",37,0)
PSJCLNOC^^0^B84441536
"BLD",8409,"KRN",9.8,"NM",38,0)
PSJHLV^^0^B21975577
"BLD",8409,"KRN",9.8,"NM",39,0)
PSJHL10^^0^B75460781
"BLD",8409,"KRN",9.8,"NM",40,0)
PSGOT^^0^B23046911
"BLD",8409,"KRN",9.8,"NM",41,0)
PSGOTR^^0^B19636030
"BLD",8409,"KRN",9.8,"NM",42,0)
PSIVORFB^^0^B83657459
"BLD",8409,"KRN",9.8,"NM",43,0)
PSJIMO1^^0^B32765352
"BLD",8409,"KRN",9.8,"NM",44,0)
PSGOEC^^0^B75500256
"BLD",8409,"KRN",9.8,"NM",46,0)
PSJOEA2^^0^B30358376
"BLD",8409,"KRN",9.8,"NM",47,0)
PSIVORC2^^0^B59663678
"BLD",8409,"KRN",9.8,"NM",48,0)
PSJCOMV^^0^B40386923
"BLD",8409,"KRN",9.8,"NM",49,0)
PSJLIACT^^0^B50131468
"BLD",8409,"KRN",9.8,"NM","B","PSGFILED",36)

"BLD",8409,"KRN",9.8,"NM","B","PSGOEC",44)

"BLD",8409,"KRN",9.8,"NM","B","PSGOT",40)

"BLD",8409,"KRN",9.8,"NM","B","PSGOTR",41)

"BLD",8409,"KRN",9.8,"NM","B","PSIVOCDS",27)

"BLD",8409,"KRN",9.8,"NM","B","PSIVORC2",47)

"BLD",8409,"KRN",9.8,"NM","B","PSIVORFB",42)

"BLD",8409,"KRN",9.8,"NM","B","PSJBLDOC",30)

"BLD",8409,"KRN",9.8,"NM","B","PSJCLNOC",37)

"BLD",8409,"KRN",9.8,"NM","B","PSJCOMV",48)

"BLD",8409,"KRN",9.8,"NM","B","PSJGMRA",31)

"BLD",8409,"KRN",9.8,"NM","B","PSJHL10",39)

"BLD",8409,"KRN",9.8,"NM","B","PSJHLV",38)

"BLD",8409,"KRN",9.8,"NM","B","PSJIMO1",43)

"BLD",8409,"KRN",9.8,"NM","B","PSJLIACT",49)

"BLD",8409,"KRN",9.8,"NM","B","PSJOC",28)

"BLD",8409,"KRN",9.8,"NM","B","PSJOCDI",32)

"BLD",8409,"KRN",9.8,"NM","B","PSJOCDS",29)

"BLD",8409,"KRN",9.8,"NM","B","PSJOCDT",35)

"BLD",8409,"KRN",9.8,"NM","B","PSJOEA2",46)

"BLD",8409,"KRN",19,0)
19
"BLD",8409,"KRN",19,"NM",0)
^9.68A^^
"BLD",8409,"KRN",19.1,0)
19.1
"BLD",8409,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",8409,"KRN",101,0)
101
"BLD",8409,"KRN",409.61,0)
409.61
"BLD",8409,"KRN",771,0)
771
"BLD",8409,"KRN",779.2,0)
779.2
"BLD",8409,"KRN",870,0)
870
"BLD",8409,"KRN",8989.51,0)
8989.51
"BLD",8409,"KRN",8989.52,0)
8989.52
"BLD",8409,"KRN",8994,0)
8994
"BLD",8409,"KRN","B",.4,.4)

"BLD",8409,"KRN","B",.401,.401)

"BLD",8409,"KRN","B",.402,.402)

"BLD",8409,"KRN","B",.403,.403)

"BLD",8409,"KRN","B",.5,.5)

"BLD",8409,"KRN","B",.84,.84)

"BLD",8409,"KRN","B",3.6,3.6)

"BLD",8409,"KRN","B",3.8,3.8)

"BLD",8409,"KRN","B",9.2,9.2)

"BLD",8409,"KRN","B",9.8,9.8)

"BLD",8409,"KRN","B",19,19)

"BLD",8409,"KRN","B",19.1,19.1)

"BLD",8409,"KRN","B",101,101)

"BLD",8409,"KRN","B",409.61,409.61)

"BLD",8409,"KRN","B",771,771)

"BLD",8409,"KRN","B",779.2,779.2)

"BLD",8409,"KRN","B",870,870)

"BLD",8409,"KRN","B",8989.51,8989.51)

"BLD",8409,"KRN","B",8989.52,8989.52)

"BLD",8409,"KRN","B",8994,8994)

"BLD",8409,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8409,"QUES",0)
^9.62^^
"BLD",8409,"REQB",0)
^9.611^8^7
"BLD",8409,"REQB",1,0)
PSJ*5.0*252^2
"BLD",8409,"REQB",2,0)
PSJ*5.0*288^2
"BLD",8409,"REQB",3,0)
PSJ*5.0*295^2
"BLD",8409,"REQB",5,0)
PSJ*5.0*195^2
"BLD",8409,"REQB",6,0)
PSJ*5.0*267^2
"BLD",8409,"REQB",7,0)
PSJ*5.0*268^2
"BLD",8409,"REQB",8,0)
PSJ*5.0*275^2
"BLD",8409,"REQB","B","PSJ*5.0*195",5)

"BLD",8409,"REQB","B","PSJ*5.0*252",1)

"BLD",8409,"REQB","B","PSJ*5.0*267",6)

"BLD",8409,"REQB","B","PSJ*5.0*268",7)

"BLD",8409,"REQB","B","PSJ*5.0*275",8)

"BLD",8409,"REQB","B","PSJ*5.0*288",2)

"BLD",8409,"REQB","B","PSJ*5.0*295",3)

"FIA",53.1)
NON-VERIFIED ORDERS
"FIA",53.1,0)
^PS(53.1,
"FIA",53.1,0,0)
53.1I
"FIA",53.1,0,1)
y^y^p^^^^n^^n
"FIA",53.1,0,10)

"FIA",53.1,0,11)

"FIA",53.1,0,"RLRO")

"FIA",53.1,0,"VR")
5.0^PSJ
"FIA",53.1,53.1)
1
"FIA",53.1,53.1,.01)

"FIA",53.1,53.1,.5)

"FIA",53.1,53.1,113)

"FIA",53.46)
CLINIC DEFINITION
"FIA",53.46,0)
^PS(53.46,
"FIA",53.46,0,0)
53.46P
"FIA",53.46,0,1)
y^n^p^^^^n^^n
"FIA",53.46,0,10)

"FIA",53.46,0,11)

"FIA",53.46,0,"RLRO")

"FIA",53.46,0,"VR")
5.0^PSJ
"FIA",53.46,53.46)
1
"FIA",53.46,53.46,6)

"FIA",55)
PHARMACY PATIENT
"FIA",55,0)
^PS(55,
"FIA",55,0,0)
55P
"FIA",55,0,1)
y^y^p^^^^n^^n
"FIA",55,0,10)

"FIA",55,0,11)

"FIA",55,0,"RLRO")

"FIA",55,0,"VR")
5.0^PSJ
"FIA",55,55)
1
"FIA",55,55,.01)

"FIA",55,55,62)

"FIA",55,55,100)

"FIA",55,55.01)
1
"FIA",55,55.01,.01)

"FIA",55,55.01,.03)

"FIA",55,55.01,136)

"FIA",55,55.06)
1
"FIA",55,55.06,.01)

"FIA",55,55.06,.5)

"FIA",55,55.06,34)

"FIA",55,55.06,130)

"INIT")
PSJ257PO
"IX",53.1,53.1,"AD",0)
53.1^AD^List of patients by clinic.^R^^R^IR^I^53.1^^^^^S
"IX",53.1,53.1,"AD",1)
S ^PS(53.1,"AD",$E(X(1),1,20),$E(X(2),1,20),DA)=""
"IX",53.1,53.1,"AD",2)
K ^PS(53.1,"AD",$E(X(1),1,20),$E(X(2),1,20),DA)
"IX",53.1,53.1,"AD",2.5)
K ^PS(53.1,"AD")
"IX",53.1,53.1,"AD",11.1,0)
^.114IA^2^2
"IX",53.1,53.1,"AD",11.1,1,0)
1^F^53.1^113^20^1^F
"IX",53.1,53.1,"AD",11.1,2,0)
2^F^53.1^.5^20^2^F
"IX",53.1,53.1,"CIMO",0)
53.1^CIMO^CIMO - PS(53.1,"CIMO",PATIENT,CLINIC,ORDER)^R^^R^IR^I^53.1^^^^^LS
"IX",53.1,53.1,"CIMO",.1,0)
^^11^11^3130626^
"IX",53.1,53.1,"CIMO",.1,1,0)
This cross reference is used during enhanced order checks for quick 
"IX",53.1,53.1,"CIMO",.1,2,0)
access to clinic order information for Unit Dose and IV orders by PATIENT,
"IX",53.1,53.1,"CIMO",.1,3,0)
CLINIC and ORDER NUMBER.
"IX",53.1,53.1,"CIMO",.1,4,0)
 
"IX",53.1,53.1,"CIMO",.1,5,0)
The set condition checks to see if the clinic is defined with YES answered
"IX",53.1,53.1,"CIMO",.1,6,0)
for the ADMINISTER INPATIENT MEDS parameter under the SET UP A CLINIC
"IX",53.1,53.1,"CIMO",.1,7,0)
[SDBUILD] option and if the order has an appointment date/time defined.  
"IX",53.1,53.1,"CIMO",.1,8,0)
If both are true, the cross reference is defined.
"IX",53.1,53.1,"CIMO",.1,9,0)
 
"IX",53.1,53.1,"CIMO",.1,10,0)
Using the same criteria, this cross reference will be defined if a clinic
"IX",53.1,53.1,"CIMO",.1,11,0)
is added or edited using the CLINIC DEFINITION [PSJ CD] option.
"IX",53.1,53.1,"CIMO",1)
S ^PS(53.1,"CIMO",X(1),X(2),DA)=""
"IX",53.1,53.1,"CIMO",1.4)
S X=$$CHECK3^PSJIMO1() I X
"IX",53.1,53.1,"CIMO",2)
K ^PS(53.1,"CIMO",X(1),X(2),DA)
"IX",53.1,53.1,"CIMO",2.5)
K ^PS(53.1,"CIMO")
"IX",53.1,53.1,"CIMO",11.1,0)
^.114IA^2^2
"IX",53.1,53.1,"CIMO",11.1,1,0)
1^F^53.1^.5^^1^F
"IX",53.1,53.1,"CIMO",11.1,2,0)
2^F^53.1^113^^2^F
"IX",55,55,"ACRIV",0)
55^ACRIV^Clinical Reminders index.^MU^^R^IR^W^55.01^^^^^A
"IX",55,55,"ACRIV",.1,0)
^^8^8^3041215
"IX",55,55,"ACRIV",.1,1,0)
This cross-reference builds two indexes, one for finding
"IX",55,55,"ACRIV",.1,2,0)
all patients with a particular drug and one for
"IX",55,55,"ACRIV",.1,3,0)
finding all the drugs a patient has. The indexes are
"IX",55,55,"ACRIV",.1,4,0)
stored in the Clinical Reminders index global as:
"IX",55,55,"ACRIV",.1,5,0)
 ^PXRMINDX(55,"IP",DRUG,DFN,START,STOP,DAS)
"IX",55,55,"ACRIV",.1,6,0)
 ^PXRMINDX(55,"PI",DFN,DRUG,START,STOP,DAS)
"IX",55,55,"ACRIV",.1,7,0)
respectively. START is the start date and STOP is the stop date.
"IX",55,55,"ACRIV",.1,8,0)
For all the details, see the Clinical Reminders Index Technical Guide/Programmer's Manual.
"IX",55,55,"ACRIV",1)
D SPSPA^PSJXRFS(.X,.DA,"IV")
"IX",55,55,"ACRIV",1.4)
S X=$$PATCH^XPDUTL("PXRM*1.5*12")
"IX",55,55,"ACRIV",2)
D KPSPA^PSJXRFK(.X,.DA,"IV")
"IX",55,55,"ACRIV",2.4)
S X=$$PATCH^XPDUTL("PXRM*1.5*12")
"IX",55,55,"ACRIV",2.5)
K ^PXRMINDX(55)
"IX",55,55,"ACRIV",11.1,0)
^.114IA^2^2
"IX",55,55,"ACRIV",11.1,1,0)
1^F^55.01^.02^^1^F
"IX",55,55,"ACRIV",11.1,2,0)
2^F^55.01^.03^^2^F
"IX",55,55,"ACRUD",0)
55^ACRUD^Clinical Reminders index.^MU^^R^IR^W^55.06^^^^^A
"IX",55,55,"ACRUD",.1,0)
^^8^8^3041215
"IX",55,55,"ACRUD",.1,1,0)
This cross-reference builds two indexes, one for finding
"IX",55,55,"ACRUD",.1,2,0)
all patients with a particular drug and one for
"IX",55,55,"ACRUD",.1,3,0)
finding all the drugs a patient has. The indexes are
"IX",55,55,"ACRUD",.1,4,0)
stored in the Clinical Reminders index global as:
"IX",55,55,"ACRUD",.1,5,0)
 ^PXRMINDX(55,"IP",DRUG,DFN,START,STOP,DAS)
"IX",55,55,"ACRUD",.1,6,0)
 ^PXRMINDX(55,"PI",DFN,DRUG,START,STOP,DAS)
"IX",55,55,"ACRUD",.1,7,0)
respectively. START is the start date and STOP is the stop date.
"IX",55,55,"ACRUD",.1,8,0)
For all the details, see the Clinical Reminders Index Technical Guide/Programmer's Manual.
"IX",55,55,"ACRUD",1)
D SPSPA^PSJXRFS(.X,.DA,"UD")
"IX",55,55,"ACRUD",1.4)
S X=$$PATCH^XPDUTL("PXRM*1.5*12")
"IX",55,55,"ACRUD",2)
D KPSPA^PSJXRFK(.X,.DA,"UD")
"IX",55,55,"ACRUD",2.4)
S X=$$PATCH^XPDUTL("PXRM*1.5*12")
"IX",55,55,"ACRUD",2.5)
K ^PXRMINDX(55)
"IX",55,55,"ACRUD",11.1,0)
^.114IA^2^2
"IX",55,55,"ACRUD",11.1,1,0)
1^F^55.06^10^^1^F
"IX",55,55,"ACRUD",11.1,2,0)
2^F^55.06^34^^2^F
"IX",55,55,"AIVC",0)
55^AIVC^List of patients with orders associated with clinic appointments.^R^^R^IR^W^55.01^^^^^S
"IX",55,55,"AIVC",1)
S ^PS(55,"AIVC",$E(X(1),1,20),$E(X(2),1,20),DA(1),DA)=""
"IX",55,55,"AIVC",2)
K ^PS(55,"AIVC",$E(X(1),1,20),$E(X(2),1,20),DA(1),DA)
"IX",55,55,"AIVC",2.5)
K ^PS(55,"AIVC")
"IX",55,55,"AIVC",11.1,0)
^.114IA^3^2
"IX",55,55,"AIVC",11.1,2,0)
1^F^55.01^.03^20^1^F
"IX",55,55,"AIVC",11.1,3,0)
2^F^55.01^136^20^2^F
"IX",55,55,"AUDC",0)
55^AUDC^List of patients with orders associated with clinic appointments.^R^^R^IR^W^55.06^^^^^S
"IX",55,55,"AUDC",1)
S ^PS(55,"AUDC",$E(X(1),1,20),$E(X(2),1,20),DA(1),DA)=""
"IX",55,55,"AUDC",2)
K ^PS(55,"AUDC",$E(X(1),1,20),$E(X(2),1,20),DA(1),DA)
"IX",55,55,"AUDC",2.5)
K ^PS(55,"AUDC")
"IX",55,55,"AUDC",11.1,0)
^.114IA^3^2
"IX",55,55,"AUDC",11.1,2,0)
1^F^55.06^34^20^1^F
"IX",55,55,"AUDC",11.1,3,0)
2^F^55.06^130^20^2^F
"IX",55,55,"CIMOCLI",0)
55^CIMOCLI^CIMOCLI - PS(55,CLINIC,PATIENT) ^R^^F^IR^W^55.01^^^^^LS
"IX",55,55,"CIMOCLI",.1,0)
^^15^15^3130626^
"IX",55,55,"CIMOCLI",.1,1,0)
This cross reference will be defined during order entry if the clinic is
"IX",55,55,"CIMOCLI",.1,2,0)
defined with YES answered for the ADMINISTER INPATIENT MEDS parameter
"IX",55,55,"CIMOCLI",.1,3,0)
under the SET UP A CLINIC [SDBUILD] option.  These parameters identify the
"IX",55,55,"CIMOCLI",.1,4,0)
clinic as an IMO clinic. If at the time of order entry the clinic was not
"IX",55,55,"CIMOCLI",.1,5,0)
defined as an IMO clinic, it is not stored in the either the CIMOI or 
"IX",55,55,"CIMOCLI",.1,6,0)
CIMOCLI cross reference.
"IX",55,55,"CIMOCLI",.1,7,0)
 
"IX",55,55,"CIMOCLI",.1,8,0)
When a new IMO clinic is added or an existing clinic is edited using the
"IX",55,55,"CIMOCLI",.1,9,0)
CLINIC DEFINTION [PSJ CD] option and it is marked as an IMO clinic, the
"IX",55,55,"CIMOCLI",.1,10,0)
IMO^PSJIMO1(.CLINICS) API will be called passing by references the array
"IX",55,55,"CIMOCLI",.1,11,0)
of clinics added/edited. This API will add/update the CIMOI and CIMOCLI
"IX",55,55,"CIMOCLI",.1,12,0)
cross references with any newly added IMO clinic(s). 
"IX",55,55,"CIMOCLI",.1,13,0)
 
"IX",55,55,"CIMOCLI",.1,14,0)
Additionally, CIMOCLI will be used during order entry to verify whether
"IX",55,55,"CIMOCLI",.1,15,0)
the clinic is an IMO clinic. 
"IX",55,55,"CIMOCLI",1)
S ^PS(55,"CIMOCLI",X,DA(1),DA)=""
"IX",55,55,"CIMOCLI",1.4)
S X=$$CHECK2^PSJIMO1() I X
"IX",55,55,"CIMOCLI",2)
K ^PS(55,"CIMOCLI",X,DA(1),DA)
"IX",55,55,"CIMOCLI",2.5)
K ^PS(55,"CIMOCLI")
"IX",55,55,"CIMOCLI",11.1,0)
^.114IA^1^1
"IX",55,55,"CIMOCLI",11.1,1,0)
1^F^55.01^136^^1^F
"IX",55,55,"CIMOCLU",0)
55^CIMOCLU^CIMOCLU - PS(55,CLINIC,PATIENT)^R^^F^IR^W^55.06^^^^^LS
"IX",55,55,"CIMOCLU",.1,0)
^^15^15^3130626^
"IX",55,55,"CIMOCLU",.1,1,0)
This cross reference will be defined during order entry if the clinic is
"IX",55,55,"CIMOCLU",.1,2,0)
defined with YES answered for the ADMINISTER INPATIENT MEDS parameter
"IX",55,55,"CIMOCLU",.1,3,0)
under the SET UP A CLINIC [SDBUILD] option.  These parameters identify 
"IX",55,55,"CIMOCLU",.1,4,0)
the clinic as an IMO clinic. If at the time of order entry the clinic was
"IX",55,55,"CIMOCLU",.1,5,0)
not defined as an IMO clinic, it is not stored in the either the CIMOU or 
"IX",55,55,"CIMOCLU",.1,6,0)
CIMOCLU cross reference.
"IX",55,55,"CIMOCLU",.1,7,0)
 
"IX",55,55,"CIMOCLU",.1,8,0)
When a new IMO clinic is added or an existing clinic is edited using the
"IX",55,55,"CIMOCLU",.1,9,0)
CLINIC DEFINTION [PSJ CD] option and it is marked as an IMO clinic, the
"IX",55,55,"CIMOCLU",.1,10,0)
IMO^PSJIMO1(.CLINICS) API will be called passing by references the 
"IX",55,55,"CIMOCLU",.1,11,0)
array of clinics added/edited. This API will add/update the CIMOU
"IX",55,55,"CIMOCLU",.1,12,0)
and CIMOCLU cross references with the newly added IMO clinic(s).
"IX",55,55,"CIMOCLU",.1,13,0)
 
"IX",55,55,"CIMOCLU",.1,14,0)
Additionally, CIMOCLU will be used during order entry to verify whether 
"IX",55,55,"CIMOCLU",.1,15,0)
the clinic is an IMO clinic.
"IX",55,55,"CIMOCLU",1)
S ^PS(55,"CIMOCLU",X,DA(1),DA)=""
"IX",55,55,"CIMOCLU",1.4)
S X=$$GET1^DIQ(44,X2(1),2802,"I") I X
"IX",55,55,"CIMOCLU",2)
K ^PS(55,"CIMOCLU",X,DA(1),DA)
"IX",55,55,"CIMOCLU",2.5)
K ^PS(55,"CIMOCLU")
"IX",55,55,"CIMOCLU",11.1,0)
^.114IA^1^1
"IX",55,55,"CIMOCLU",11.1,1,0)
1^F^55.06^130^^1^F
"IX",55,55,"CIMOU",0)
55^CIMOU^CIMOU - PS(55,"CIMOU",PATIENT,CLINIC,STOP DATE/TIME,PATIENT,ORDER)^R^^R^IR^W^55.06^^^^^LS
"IX",55,55,"CIMOU",.1,0)
^^11^11^3130626^
"IX",55,55,"CIMOU",.1,1,0)
This cross reference is used during enhanced order checks for quick 
"IX",55,55,"CIMOU",.1,2,0)
access to clinic order information for unit dose orders by PATIENT, 
"IX",55,55,"CIMOU",.1,3,0)
CLINIC, STOP DATE/TIME and ORDER NUMBER.
"IX",55,55,"CIMOU",.1,4,0)
 
"IX",55,55,"CIMOU",.1,5,0)
The set condition checks to see if the clinic is defined with YES answered
"IX",55,55,"CIMOU",.1,6,0)
for the ADMINISTER INPATIENT MEDS parameter under the SET UP A CLINIC
"IX",55,55,"CIMOU",.1,7,0)
[SDBUILD] option and if the order has an appointment date/time defined.  
"IX",55,55,"CIMOU",.1,8,0)
If both are true, the cross reference is defined.
"IX",55,55,"CIMOU",.1,9,0)
 
"IX",55,55,"CIMOU",.1,10,0)
Using the same criteria, this cross reference will be defined if a clinic
"IX",55,55,"CIMOU",.1,11,0)
is added or edited using the CLINIC DEFINITION [PSJ CD] option.
"IX",55,55,"CIMOU",1)
S ^PS(55,"CIMOU",X(1),X(2),X(3),DA(1),DA)=""
"IX",55,55,"CIMOU",1.4)
S X=$$CHECK^PSJIMO1() I X
"IX",55,55,"CIMOU",2)
K ^PS(55,"CIMOU",X(1),X(2),X(3),DA(1),DA)
"IX",55,55,"CIMOU",2.5)
K ^PS(55,"CIMOU")
"IX",55,55,"CIMOU",11.1,0)
^.114IA^3^3
"IX",55,55,"CIMOU",11.1,1,0)
1^F^55.06^.5^^1^F
"IX",55,55,"CIMOU",11.1,2,0)
2^F^55.06^130^^2^F
"IX",55,55,"CIMOU",11.1,3,0)
3^F^55.06^34^^3^F
"IX",55,55.01,"AIN",0)
55.01^AIN^Clinic cross-reference.^R^^R^IR^I^55.01^^^^^S
"IX",55,55.01,"AIN",.1,0)
^^2^2^3040729^
"IX",55,55.01,"AIN",.1,1,0)
This cross-reference is used to easily determine if a specific patient 
"IX",55,55.01,"AIN",.1,2,0)
has clinic orders.
"IX",55,55.01,"AIN",1)
S ^PS(55,DA(1),"IV","AIN",X(1),X(2),DA)=""
"IX",55,55.01,"AIN",2)
K ^PS(55,DA(1),"IV","AIN",X(1),X(2),DA)
"IX",55,55.01,"AIN",2.5)
K ^PS(55,DA(1),"IV","AIN")
"IX",55,55.01,"AIN",11.1,0)
^.114IA^2^2
"IX",55,55.01,"AIN",11.1,1,0)
1^F^55.01^.03^^1^F
"IX",55,55.01,"AIN",11.1,1,3)

"IX",55,55.01,"AIN",11.1,2,0)
2^F^55.01^136^^2^F
"IX",55,55.01,"AIN",11.1,2,3)

"IX",55,55.01,"CIMOI",0)
55.01^CIMOI^CIMOI - PS(55,PATIENT,"IV","CIMOI",CLINIC,STOP DATE/TIME,ORDER)^R^^R^IR^I^55.01^^^^^LS
"IX",55,55.01,"CIMOI",.1,0)
^^10^10^3130626^
"IX",55,55.01,"CIMOI",.1,1,0)
This cross reference is used during enhanced order checks for quick 
"IX",55,55.01,"CIMOI",.1,2,0)
access to clinic order information for IV orders.  IV sub-file cross 
"IX",55,55.01,"CIMOI",.1,3,0)
referenced by CLINIC, STOP DATE/TIME and ORDER NUMBER.
"IX",55,55.01,"CIMOI",.1,4,0)
 
"IX",55,55.01,"CIMOI",.1,5,0)
As orders are placed, this cross reference will be defined when YES is
"IX",55,55.01,"CIMOI",.1,6,0)
answered for the ADMINISTER INPATIENT MEDS parameter under the SET UP A
"IX",55,55.01,"CIMOI",.1,7,0)
CLINIC [SDBUILD] option and appointment date/time is defined.
"IX",55,55.01,"CIMOI",.1,8,0)
 
"IX",55,55.01,"CIMOI",.1,9,0)
Using the same criteria, this cross reference will be defined if a clinic
"IX",55,55.01,"CIMOI",.1,10,0)
is added or edited using the CLINIC DEFINITION [PSJ CD] option.
"IX",55,55.01,"CIMOI",1)
S ^PS(55,DA(1),"IV","CIMOI",X(1),X(2),DA)=""
"IX",55,55.01,"CIMOI",1.4)
S X=$$CHECK2^PSJIMO1() I X
"IX",55,55.01,"CIMOI",2)
K ^PS(55,DA(1),"IV","CIMOI",X(1),X(2),DA)
"IX",55,55.01,"CIMOI",2.5)
K ^PS(55,DA(1),"IV","CIMOI")
"IX",55,55.01,"CIMOI",11.1,0)
^.114IA^2^2
"IX",55,55.01,"CIMOI",11.1,1,0)
1^F^55.01^136^^1^F
"IX",55,55.01,"CIMOI",11.1,2,0)
2^F^55.01^.03^^2^F
"IX",55,55.06,"AUN",0)
55.06^AUN^Clinic cross-reference.^R^^R^IR^I^55.06^^^^^S
"IX",55,55.06,"AUN",.1,0)
^^2^2^3040729^
"IX",55,55.06,"AUN",.1,1,0)
This cross-reference is used to easily determine if a specific patient 
"IX",55,55.06,"AUN",.1,2,0)
has clinic orders.
"IX",55,55.06,"AUN",1)
S ^PS(55,DA(1),5,"AUN",X(1),X(2),DA)=""
"IX",55,55.06,"AUN",2)
K ^PS(55,DA(1),5,"AUN",X(1),X(2),DA)
"IX",55,55.06,"AUN",2.5)
K ^PS(55,DA(1),5,"AUN")
"IX",55,55.06,"AUN",11.1,0)
^.114IA^2^2
"IX",55,55.06,"AUN",11.1,1,0)
1^F^55.06^34^^1^F
"IX",55,55.06,"AUN",11.1,1,3)

"IX",55,55.06,"AUN",11.1,2,0)
2^F^55.06^130^^2^F
"IX",55,55.06,"AUN",11.1,2,3)

"MBREQ")
1
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
257^3130703^10000000068
"PKG",197,22,1,"PAH",1,1,0)
^^2^2^3130703
"PKG",197,22,1,"PAH",1,1,1,0)
This patch is the follow up build for MEDICATION ORDER CHECK HEALTHCARE
"PKG",197,22,1,"PAH",1,1,2,0)
APPLICATION (MOCHA) 2.0.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
21
"RTN","PSGFILED")
0^36^B25006038
"RTN","PSGFILED",1,0)
PSGFILED ;BIR/CML3-VARIOUS FILES' UPKEEP ;16 Mar 99 / 10:22 AM
"RTN","PSGFILED",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**20,50,63,119,110,111,112,154,184,181,257**;16 DEC 97;Build 105
"RTN","PSGFILED",3,0)
 ;
"RTN","PSGFILED",4,0)
 ; Reference to ^PS(50.606 supported by DBIA# 2174.
"RTN","PSGFILED",5,0)
 ; Reference to ^PSDRUG supported by DBIA# 2192.
"RTN","PSGFILED",6,0)
 ; Reference to ^PS(59.7 is supported by DBIA# 2181.
"RTN","PSGFILED",7,0)
 ; Reference to ^PS(51 is supported by DBIA# 2176.
"RTN","PSGFILED",8,0)
 ; Reference to ^PS(51.2 is supported by DBIA# 2178.
"RTN","PSGFILED",9,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSGFILED",10,0)
 ;
"RTN","PSGFILED",11,0)
DONE D ENKV^PSGSETU K D0,D1,D2,PSGRBS Q
"RTN","PSGFILED",12,0)
 ;
"RTN","PSGFILED",13,0)
GED ; generic edit
"RTN","PSGFILED",14,0)
 S DA=+Y,DR=".01;1" W ! D ^DIE Q
"RTN","PSGFILED",15,0)
 ;
"RTN","PSGFILED",16,0)
ENAT ; team file
"RTN","PSGFILED",17,0)
 F  S DIC="^PS(57.7,",DIC(0)="QEAMIL",DLAYGO=57.7,DIC("A")="Select WARD: " W ! D ^DIC K DIC,DLAYGO Q:Y'>0  S DA=+Y,DIE="^PS(57.7,",DR="[PSJUMATE]" D ^DIE
"RTN","PSGFILED",18,0)
 G DONE
"RTN","PSGFILED",19,0)
 ;
"RTN","PSGFILED",20,0)
ENAS ; schedules file - no longer used
"RTN","PSGFILED",21,0)
 ;
"RTN","PSGFILED",22,0)
ENMR ; med route file
"RTN","PSGFILED",23,0)
 NEW MRNO,MR K DIE,DIC,DR,Y
"RTN","PSGFILED",24,0)
 F  S DIC="^PS(51.2,",DIC(0)="QEAMIL",DLAYGO=51.2 W ! D ^DIC K DIC,DLAYGO Q:+Y'>0  S MRNO=+Y,MR=$P(Y,U,2),DA=+Y,DIE="^PS(51.2,",DR=".01;1;3;4" D ^DIE D DF
"RTN","PSGFILED",25,0)
 G DONE
"RTN","PSGFILED",26,0)
 ;
"RTN","PSGFILED",27,0)
ENWG ; ward group file
"RTN","PSGFILED",28,0)
 F  S DIC="^PS(57.5,",DIC(0)="QEAMIL",DLAYGO=57.5 W ! D ^DIC K DA,DIC,DR Q:+Y'>0  S DA=+Y,DIE="^PS(57.5,",DR="[PSJU WG]" D ^DIE
"RTN","PSGFILED",29,0)
 G DONE
"RTN","PSGFILED",30,0)
 ;
"RTN","PSGFILED",31,0)
ENMI ; medication instruction file
"RTN","PSGFILED",32,0)
 F  S DIC="^PS(51,",DIC(0)="QEAMIL",DLAYGO=51 W ! D ^DIC K DIC Q:+Y'>0  S DIE="^PS(51,",DA=+Y,DR=".01;1;30" D ^DIE
"RTN","PSGFILED",33,0)
 G DONE
"RTN","PSGFILED",34,0)
 ;
"RTN","PSGFILED",35,0)
ENDRG ; standard drug fields
"RTN","PSGFILED",36,0)
 D NOW^%DTC S PSGDT=% F  S DIC="^PSDRUG(",DIC(0)="AEIMOQ",DIC("A")="Select DISPENSE DRUG: " W ! D ^DIC K DIC Q:+Y'>0  D DE
"RTN","PSGFILED",37,0)
 K PSIUA,PSIUDA,PSIUX G DONE
"RTN","PSGFILED",38,0)
 ;
"RTN","PSGFILED",39,0)
DE ;
"RTN","PSGFILED",40,0)
 I $D(^PSDRUG(+Y,"I")),^("I"),^("I")<PSGDT W $C(7),$C(7),!!?3,"*** WARNING, THIS DRUG IS INACTIVE. ***",!
"RTN","PSGFILED",41,0)
 W ! S DIE="^PSDRUG(",(DA,PSIUDA)=+Y,DR="[PSJ FILED]"
"RTN","PSGFILED",42,0)
 S PSIUX="U^UNIT DOSE PHARMACY^1" D ^PSGIU,^DIE:PSIUA'["^" K DA,DIE,DR Q
"RTN","PSGFILED",43,0)
 ;
"RTN","PSGFILED",44,0)
ENOSE ; order set enter/edit
"RTN","PSGFILED",45,0)
 K DIC F  S DLAYGO=53.2,DIC="^PS(53.2,",DIC(0)="QEAML",DIC("A")="Select ORDER SET: " W ! D ^DIC K DIC Q:Y'>0  S DA=+Y S DIE="^PS(53.2,",DR="[PSJUOSE]" D ^DIE K D0,D1,DA,DIE,DR,PSGNEDFD,PSGS0XT,PSGS0Y
"RTN","PSGFILED",46,0)
 G DONE
"RTN","PSGFILED",47,0)
 ;
"RTN","PSGFILED",48,0)
RBCHK ; used to validate room-bed
"RTN","PSGFILED",49,0)
 ;No longer used.
"RTN","PSGFILED",50,0)
 ;F Z0=0:0 S Z0=$O(^PS(57.7,DA(2),1,Z0)) Q:'Z0  I Z0'=DA(1),$D(^(Z0,1,"B",X)) W !?19,X," is already under ",$S('$D(^PS(57.7,DA(2),1,Z0,0)):"another team ("_Z0_")!",$P(^(0),"^")]"":$P(^(0),"^")_"!",1:"another team ("_Z0_")!") Q
"RTN","PSGFILED",51,0)
 ;I 'Z0,$D(^DIC(42,DA(2),2,+$O(^DIC(42,DA(2),2,"B",$P(X,"-"),0)),1,"B",$P(X,"-",2))) K Z0 Q
"RTN","PSGFILED",52,0)
 ;K X,Z0 Q
"RTN","PSGFILED",53,0)
 ;
"RTN","PSGFILED",54,0)
RBQ ; show room-beds for a ward
"RTN","PSGFILED",55,0)
 ;No longer used.
"RTN","PSGFILED",56,0)
 Q
"RTN","PSGFILED",57,0)
 ;
"RTN","PSGFILED",58,0)
RBNP W """^"" TO STOP: " R Z3:DTIME W:'$T $C(7) S:'$T Z3="^" W $C(13),"            ",$C(13) Q
"RTN","PSGFILED",59,0)
 ;
"RTN","PSGFILED",60,0)
ENPPD ; edit pharmacy patient data
"RTN","PSGFILED",61,0)
 ; W !!?3,"...This option is still under development...",! Q
"RTN","PSGFILED",62,0)
 ;
"RTN","PSGFILED",63,0)
ENCPDD ; edit patient's default stop date (wall)
"RTN","PSGFILED",64,0)
 D ENCV^PSGSETU I $D(XQUIT) Q
"RTN","PSGFILED",65,0)
 F  D ENAO^PSGGAO Q:PSGP'>0  D
"RTN","PSGFILED",66,0)
 .S WDN=$P($G(^DPT(PSGP,.1)),"^") W:WDN="" !!?2,"The patient is not currently on a ward."
"RTN","PSGFILED",67,0)
 .I WDN]"" S WD=$O(^DIC(42,"B",WDN,0)),WD=$O(^PS(59.6,"B",+WD,0)) I $S('WD:1,1:'$P($G(^PS(59.6,WD,0)),"^",4)) S X="PLEASE NOTE: The 'SAME STOP DATE' parameter for the ward ("_WDN_") is not turned on.  Any date entered here will be ignored "
"RTN","PSGFILED",68,0)
 .I  S X=X_"until the parameter is turned on for this ward." W $C(7),!!?2 F Y=1:1:$L(X," ") S X(1)=$P(X," ",Y) W:$L(X(1))+$X>78 ! W X(1)," "
"RTN","PSGFILED",69,0)
 .S DA=PSGP,DR="62.01T",DIE="^PS(55," W !! D ^DIE
"RTN","PSGFILED",70,0)
 K WD,WDN G DONE
"RTN","PSGFILED",71,0)
 ;
"RTN","PSGFILED",72,0)
ENSYS ; edit system file
"RTN","PSGFILED",73,0)
 ;/S DIE="^PS(59.7,",DA=1,DR="21;26;26.3;26.4;26.2;20.412ALLOW THE CHANGE OF ORDER TYPES ON ORDERS FROM OERR;32"
"RTN","PSGFILED",74,0)
 S DIE="^PS(59.7,",DA=1,DR="21;26;26.3;26.4;26.2;26.5;26.6;26.7;26.8;34;27;27.1"
"RTN","PSGFILED",75,0)
 W ! D ^DIE K DIE,DA,DR Q
"RTN","PSGFILED",76,0)
 ;
"RTN","PSGFILED",77,0)
ENPLSP ; edit pick list site parameters
"RTN","PSGFILED",78,0)
 ;
"RTN","PSGFILED",79,0)
ENCS ; change current site & parameters
"RTN","PSGFILED",80,0)
 I $D(PSJSYSW0)#2 W !!,"Current site: ",$P(PSJSYSW0,"^")
"RTN","PSGFILED",81,0)
 S PSGCSF=1 D ^PSGSET,ENKV^PSGSETU W:$D(XQUIT) !!?5,"(The Inpatient site you are currently working under has not changed.)" K PSGCSF,PSGORSET,XQUIT Q
"RTN","PSGFILED",82,0)
 ;
"RTN","PSGFILED",83,0)
DF ; Add/edit Med route, instruction... to the Dosage form file.
"RTN","PSGFILED",84,0)
 S DIR("A")="Would you like to update the Dosage Form file"
"RTN","PSGFILED",85,0)
 S DIR("?")="If your answer is Yes, you will be able to Add/edit the Med routes, Instructions, Verb, Noun and Preposition that associate with this Dosage form."
"RTN","PSGFILED",86,0)
 S DIR(0)="Y",DIR("B")="Y" D ^DIR Q:Y'=1
"RTN","PSGFILED",87,0)
 NEW Y,DFNO K DIE,DIC,DA,DR
"RTN","PSGFILED",88,0)
 F  S DIC="^PS(50.606,",DIC(0)="QEAMI" D ^DIC Q:+Y'>0  S DFNO=+Y D
"RTN","PSGFILED",89,0)
 . I $G(MR)]"",'$D(^PS(50.606,DFNO,"MR","B",MRNO)) S DIE="^PS(50.606,",DR="1///"_MR,DA=DFNO D ^DIE
"RTN","PSGFILED",90,0)
 . K DIE,DIC,DR,MR S DIE="^PS(50.606,",DR="1;3;4;5",DA=DFNO D ^DIE
"RTN","PSGFILED",91,0)
 ;. K DIE,DIC,DR,MR S DIE="^PS(50.606,",DR="1;2;3;4;5",DA=DFNO D ^DIE
"RTN","PSGFILED",92,0)
 Q
"RTN","PSGFILED",93,0)
ENCD ;edit Clinic Definitions file
"RTN","PSGFILED",94,0)
 N CLINICS,CLINFLG S CLINICS=""
"RTN","PSGFILED",95,0)
 F  K DIC S DIC="^PS(53.46,",DIC(0)="AELMQ",DIC("A")="Select CLINIC: ",DLAYGO=53.46 D ^DIC K DIC Q:Y<0  D
"RTN","PSGFILED",96,0)
 . S DIE="^PS(53.46,",DA=+Y,CLINICS(DA)="",DR="1;2;3;6" D ^DIE K DIE,DA,DR
"RTN","PSGFILED",97,0)
 D IMO^PSJIMO1(.CLINICS)
"RTN","PSGFILED",98,0)
 Q
"RTN","PSGFILED",99,0)
 ;
"RTN","PSGFILED",100,0)
ENCG ; ward group file0
"RTN","PSGFILED",101,0)
 F  S DIC="^PS(57.8,",DIC(0)="QEAMIL",DLAYGO=57.8 W ! D ^DIC K DA,DIC,DR Q:+Y'>0  S DA=+Y,DIE="^PS(57.8,",DR=".01;1" D ^DIE
"RTN","PSGFILED",102,0)
 G DONE
"RTN","PSGFILED",103,0)
 ;
"RTN","PSGOEC")
0^44^B75500256
"RTN","PSGOEC",1,0)
PSGOEC ;BIR/CML3-CANCEL ORDERS ;02 Mar 99 / 9:29 AM
"RTN","PSGOEC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**23,58,110,175,201,134,181,260,288,257**;16 DEC 97;Build 105
"RTN","PSGOEC",3,0)
 ;
"RTN","PSGOEC",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSGOEC",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789.
"RTN","PSGOEC",6,0)
 ; 
"RTN","PSGOEC",7,0)
ENA ; all orders
"RTN","PSGOEC",8,0)
 D ENCV^PSGSETU Q:$D(XQUIT)  S CF=$P(PSJSYSP0,U,5) N ND,ND1 S ND="$D(^PS(55,PSGP,5,PSGDA,4)),$P(^(4),U,12),$P(^(4),U,13)",ND1="$D(^PS(53.1,PSGDA,4)),$P(^(4),U,12),$P(^(4),U,13)"
"RTN","PSGOEC",9,0)
 F  W !!,"Do you want to ",$S(CF:"discontinue",1:"mark for discontinuation")," all of this patient's orders" S %=1 D YN^DICN Q:%  D ENCAM^PSGOEM
"RTN","PSGOEC",10,0)
 S PSGCF=0 Q:%<0  S PSGCF=1,T=$E("T",'PSJSYSU) G:%=1 ENCA F T=0:0 S T=$O(^PS(55,PSGP,5,"AUS",T)) Q:'T  F PSGDA=0:0 S PSGDA=$O(^PS(55,PSGP,5,"AUS",T,PSGDA)) Q:'PSGDA  I @ND Q
"RTN","PSGOEC",11,0)
 E  F PSGDA=0:0 S PSGDA=$O(^PS(53.1,"AC",PSGP,PSGDA)) Q:'PSGDA  I @ND1 Q
"RTN","PSGOEC",12,0)
 E  G DONE
"RTN","PSGOEC",13,0)
 W !!,"SOME OR ALL OF THESE ORDERS HAVE" D ENUMK^PSGOEM Q:%'=1
"RTN","PSGOEC",14,0)
 W !!,"...a few moments, please..." S PSGAL("C")=PSJSYSU*10+21400
"RTN","PSGOEC",15,0)
 F T=PSGDT:0 S T=$O(^PS(55,PSGP,5,"AUS",T)) Q:'T  F PSGDA=0:0 S PSGDA=$O(^PS(55,PSGP,5,"AUS",T,PSGDA)) Q:'PSGDA  I @ND W "." D RS,^PSGAL5
"RTN","PSGOEC",16,0)
 F PSGDA=0:0 S PSGDA=$O(^PS(53.1,"AC",PSGP,PSGDA)) Q:'PSGDA  I @ND1 W "." D RS
"RTN","PSGOEC",17,0)
 W " . . . DONE!" G DONE
"RTN","PSGOEC",18,0)
ENCA ;
"RTN","PSGOEC",19,0)
 D NOW^%DTC S (Q1,PSGDT)=+$E(%,1,12) F  S Q1=$O(^PS(55,PSGP,5,"AUS",Q1)) Q:'Q1  F Q2=0:0 S Q2=$O(^PS(55,PSGP,5,"AUS",Q1,Q2)) Q:'Q2  I $P($G(^PS(55,PSGP,5,Q2,0)),"^",21) Q
"RTN","PSGOEC",20,0)
 E  F Q2=0:0 S Q2=$O(^PS(53.1,"AC",PSGP,Q2)) Q:'Q2  I $P($G(^PS(53.1,Q2,0)),U,21) Q
"RTN","PSGOEC",21,0)
 I  S PSJNOO=$$ENNOO^PSJUTL5("D") I PSJNOO<0!('$$REQPROV) D  G DONE
"RTN","PSGOEC",22,0)
 .W !!,$C(7),"No changes made to this order." D PAUSE^VALM1
"RTN","PSGOEC",23,0)
 S PSGALR=$S('$D(PSGALO):20,PSGALO?4N&($E(PSGALO)=1):10,1:20) I $P(PSJSYSP0,U,5) D ENHE^PSJADT0 S PSGOP=PSGP D ASET
"RTN","PSGOEC",24,0)
 F SD=PSGDT:0 S SD=$O(^PS(55,PSGP,5,"AUS",SD)) Q:'SD  F PSGORD=0:0 S PSGORD=$O(^PS(55,PSGP,5,"AUS",SD,PSGORD)) Q:'PSGORD  S PSGORD=+PSGORD_"A" D AC
"RTN","PSGOEC",25,0)
 D NSET S CF=$P(PSJSYSP0,U,5) F PSGORD=0:0 S PSGORD=$O(^PS(53.1,"AC",PSGP,PSGORD)) Q:'PSGORD  S PSGORD=+PSGORD_"N" D NC
"RTN","PSGOEC",26,0)
 W " . . . DONE!" K PSGORD G DONE
"RTN","PSGOEC",27,0)
ENO(PSGP,PSGORD) ; single order
"RTN","PSGOEC",28,0)
 I PSGSTAT="D" W !,"This order has already been DISCONTINUED." D PAUSE^VALM1 Q
"RTN","PSGOEC",29,0)
 S CF=$S($P(PSJSYSP0,U,5):1,PSGORD["U":0,1:($P($G(^PS(53.1,+PSGORD,0)),U,25)=""&($P($G(^(4)),U,7)=DUZ)))
"RTN","PSGOEC",30,0)
 S PSJCOM=+$S(PSGORD["U":$P($G(^PS(55,PSGP,5,+PSGORD,.2)),"^",8),1:$P($G(^PS(53.1,+PSGORD,.2)),"^",8))
"RTN","PSGOEC",31,0)
 I 'CF,PSJCOM W !!,"This order is part of a complex order and CANNOT be marked for discontinuation." Q
"RTN","PSGOEC",32,0)
 I $$PNDRNOK(PSGORD) N PSJDCTYP S PSJDCTYP=$$PNDRNA(PSGORD) D:(PSJDCTYP=1!(PSJDCTYP=2)) PNDRN($G(PSJDCTYP),PSGORD) G DONE
"RTN","PSGOEC",33,0)
 ;I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSGORD)
"RTN","PSGOEC",34,0)
 ;F  W !!,"Do you want to ",$S(PSJCOM:"discontinue this series of complex orders",CF:"discontinue this order",1:"mark this order for discontinuation") S %=$S($G(PSJOCFLG):2,1:1) D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSGOEC",35,0)
 ;I %<0 S VALMBCK="" Q
"RTN","PSGOEC",36,0)
 I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSGORD)
"RTN","PSGOEC",37,0)
 I PSJCOM F  W !!,"Do you want to discontinue this series of complex orders" S %=$S($G(PSJOCFLG):2,1:1) D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSGOEC",38,0)
 I 'PSJCOM,CF,'$D(PSJDCDTF) F  W !!,"Do you want to discontinue this order" S %=$S($G(PSJOCFLG):2,1:1) D YN^DICN Q:%  D ENCOM^PSGOEM I %<0 S VALMBCK="" Q
"RTN","PSGOEC",39,0)
 I 'PSJCOM,CF,$D(PSJDCDTF) F  W !!,"Enter DC to discontinue the above order or press <RETURN> to continue:" S %=$S($G(PSJOCFLG):2,1:1) D TST4DC W:%=2 !,"No action taken!" Q:%  D ENDC^PSGOEM I %<0 S VALMBCK="" Q
"RTN","PSGOEC",40,0)
 I 'PSJCOM,'CF,'$D(PSJDCDTF) F  W !!,"Do you want mark this order for discontinuation" S %=$S($G(PSJOCFLG):2,1:1) D YN^DICN Q:%  D ENCOM^PSGOEM I %<0 S VALMBCK="" Q
"RTN","PSGOEC",41,0)
 G:%=1 SOC I $S(PSGORD["U":$D(^PS(55,PSGP,5,+PSGORD,4)),1:$D(^PS(53.1,+PSGORD,4))),$P(^(4),U,12) W !!,"THIS ORDER HAS"
"RTN","PSGOEC",42,0)
 I  D ENUMK^PSGOEM I %=1 W "..." K DA S:PSGORD["A" PSGAL("C")=PSJSYSU*10+21400,DA=+PSGORD,DA(1)=PSGP D RS,^PSGAL5:PSGORD["A" W " . . . DONE!"
"RTN","PSGOEC",43,0)
 G DONE
"RTN","PSGOEC",44,0)
SOC ;
"RTN","PSGOEC",45,0)
 I 'CF,'$P($S(PSGORD["U":$G(^PS(55,PSGP,5,+PSGORD,0)),1:$G(^PS(53.1,+PSGORD,0))),U,21) W !!,"...one moment, please..."
"RTN","PSGOEC",46,0)
 E  I CF,'($G(PSJDCTYP)=2) S PSJNOO=$$ENNOO^PSJUTL5("D") I PSJNOO<0 D ABORT^PSGOEE G DONE
"RTN","PSGOEC",47,0)
 ; prompt for requesting provider
"RTN","PSGOEC",48,0)
 I '($G(PSJDCTYP)=2) I CF,'$$REQPROV D ABORT^PSGOEE G DONE
"RTN","PSGOEC",49,0)
 K DA D NOW^%DTC S PSGDT=%,T=$E("T",'PSJSYSU),PSGALR=20,DA=+PSGORD,DA(1)=PSGP
"RTN","PSGOEC",50,0)
 I 'PSJCOM D
"RTN","PSGOEC",51,0)
 .I PSGORD["U" D ASET:CF,AC
"RTN","PSGOEC",52,0)
 .I PSGORD'["U" D NSET:CF,NC
"RTN","PSGOEC",53,0)
 I PSJCOM N COMFLG S COMFLG=0 D
"RTN","PSGOEC",54,0)
 . I PSGORD["P" Q:('$$LOCK^PSJOEA(PSGP,PSJCOM))  D 
"RTN","PSGOEC",55,0)
 .. N O S O="" F  S O=$O(^PS(53.1,"ACX",PSJCOM,O)) Q:O=""  S (PSGORD,PSJORD)=O_"P" D NSET,NC
"RTN","PSGOEC",56,0)
 .I PSGORD["U" N O,OO S O=0,OO="" F  S O=$O(^PS(55,"ACX",PSJCOM,O)) Q:'O  F  S OO=$O(^PS(55,"ACX",PSJCOM,O,OO)) Q:OO=""  Q:COMFLG  D
"RTN","PSGOEC",57,0)
 .. Q:OO=PSGORD  I '$$LS^PSSLOCK(DFN,OO) S COMFLG=1 Q
"RTN","PSGOEC",58,0)
 I PSJCOM Q:COMFLG  N O,OO S O=0,OO="" F  S O=$O(^PS(55,"ACX",PSJCOM,O)) Q:'O  F  S OO=$O(^PS(55,"ACX",PSJCOM,O,OO)) Q:OO=""  D
"RTN","PSGOEC",59,0)
 . I OO["V" S ON55=OO D D1^PSIVOPT2 S PSIVALT=1,PSIVALCK="STOP",PSIVREA="D",ON=ON55,P(3)=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3) D
"RTN","PSGOEC",60,0)
 .. D LOG^PSIVORAL N PSJORD S PSJORD=ON55,P(3)=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3),P("NAT")=PSJNOO D HL^PSIVORA
"RTN","PSGOEC",61,0)
 . I OO["U" N PSGORD,PSJORD S (PSGORD,PSJORD)=OO D ASET^PSGOEC,AC^PSGOEC
"RTN","PSGOEC",62,0)
 Q
"RTN","PSGOEC",63,0)
D1 N %,DA,DIE,DIU,STP,NSTOP
"RTN","PSGOEC",64,0)
 D NOW^%DTC S NSTOP=+$E(%,1,12),STP=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3),NSTOP=+$S(STP>NSTOP:NSTOP,1:STP),P(17)="D"
"RTN","PSGOEC",65,0)
 S DA(1)=DFN,DA=+ON55,DIE="^PS(55,"_DFN_",""IV"",",DR="109////"_NSTOP_$S('$P($G(^PS(55,DFN,"IV",+ON55,2)),U,7):";116////"_STP,1:"")_";100///D;.03////"_NSTOP,PSIVACT=1 D ^DIE
"RTN","PSGOEC",66,0)
 I $S($G(PSIVAC)="OD":0,$G(PSIVAC)'="AD":1,$G(PSGALO)<1060:0,1:$P($G(PSJSYSW0),U,15)) S X=$S($G(PSIVAC)="AD":1,1:2) D ENLBL^PSIVOPT(X,$S(X=1:+$G(PSGUOW),1:DUZ),DFN,3,+ON55,$E("AD",1,3-X))
"RTN","PSGOEC",67,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN Q:'PSJIVORF  ;* S ORIFN=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,21) Q:'ORIFN
"RTN","PSGOEC",68,0)
 Q
"RTN","PSGOEC",69,0)
OUT ;
"RTN","PSGOEC",70,0)
 W $S(PSJCOM:"...ORDER ",1:"...ORDERS "),$S(CF:"DISCONTINUED!",1:"MARKED!") S PSGCANFL=1
"RTN","PSGOEC",71,0)
DONE ;
"RTN","PSGOEC",72,0)
 K CF,DA,DIE,DP,DR,ORIFN,ORETURN,PSGAL,PSGALR,PSGDA,SD,ST,T,UCF,Y,PSJDCTYP Q
"RTN","PSGOEC",73,0)
ASET ;
"RTN","PSGOEC",74,0)
 S DIE="^PS(55,"_PSGP_",5,",DR="136////@;28////"_$S($P($G(^PS(55,PSGP,5,+$G(PSJORD),0)),U,27)="E":"DE",$D(PSGEDIT):"DE",1:"D")_";Q;34////"_PSGDT_$S(T]"":";49////1",1:"")
"RTN","PSGOEC",75,0)
 Q
"RTN","PSGOEC",76,0)
NSET ;
"RTN","PSGOEC",77,0)
 S DIE="^PS(53.1,",DR="28////"_$S($P($G(^PS(53.1,+$G(PSJORD),0)),U,27)="E":"DE",$D(PSGEDIT):"DE",1:"D")_$S(T]"":";42////1",1:"")_";25////"_PSGDT Q
"RTN","PSGOEC",78,0)
AC ;
"RTN","PSGOEC",79,0)
 I 'CF K DA S $P(^PS(55,PSGP,5,+PSGORD,4),U,11,14)="^1^"_DUZ_U_PSGDT,PSGAL("C")=13040,DA=+PSGORD,DA(1)=PSGP D ^PSGAL5
"RTN","PSGOEC",80,0)
 I 'CF,$D(PSJSYSO) S PSGORD=+PSGORD_"A",PSGPOSA="C",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOEC",81,0)
 Q:'CF  K DA,ORIFN S PSGAL("C")=PSJSYSU*10+4000,DA=+PSGORD,DA(1)=PSGP D ^PSGAL5 S $P(^(2),U,3)=$P(^PS(55,PSGP,5,+PSGORD,2),U,4) D ^DIE S ^PS(55,"AUE",PSGP,+PSGORD)=""
"RTN","PSGOEC",82,0)
 I '$D(PSJSYSL) S PSJSYSL=""
"RTN","PSGOEC",83,0)
 I PSJSYSL K DA S $P(^PS(55,PSGP,5,+PSGORD,7),U,1,2)=PSGDT_U_$S($D(PSGEDIT):"DE",1:"D"),PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD,DA(1)=PSGP D ENL^PSGVDS
"RTN","PSGOEC",84,0)
 S ORIFN=$P($G(^PS(55,PSGP,5,+PSGORD,0)),U,21) D:ORIFN DCOR^PSGOECS
"RTN","PSGOEC",85,0)
 Q
"RTN","PSGOEC",86,0)
NC ;
"RTN","PSGOEC",87,0)
 D KILL531^PSJIMO1(PSGP,"",+PSGORD)
"RTN","PSGOEC",88,0)
 I 'CF S $P(^PS(53.1,+PSGORD,4),"^",11,14)="^1^"_DUZ_U_PSGDT
"RTN","PSGOEC",89,0)
 I 'CF,$D(PSJSYSO) S PSGORD=+PSGORD_"N",PSGPOSA="C",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOEC",90,0)
 Q:'CF  S PSGSTAT=$P($G(^PS(53.1,+PSGORD,0)),U,9),PSGORIFN=$P($G(^(0)),U,21)
"RTN","PSGOEC",91,0)
 I PSGSTAT'="U" K DA,ORIFN S DA=+PSGORD D ^DIE I PSJSYSL,PSJSYSL<3,(PSGSTAT'="P") S $P(^PS(53.1,+PSGORD,7),U,1,2)=PSGDT_U_$S($D(PSGEDIT):"DE",1:"D"),PSGTOO=2,PSGUOW=DUZ,PSGTOL=2 D ENL^PSGVDS
"RTN","PSGOEC",92,0)
 I PSGSTAT="U" K DA S DA=+PSGORD,DIK="^PS(53.1," D ^DIK
"RTN","PSGOEC",93,0)
 I PSGORIFN S ORIFN=PSGORIFN D DCOR^PSGOECS
"RTN","PSGOEC",94,0)
 Q
"RTN","PSGOEC",95,0)
T ;
"RTN","PSGOEC",96,0)
 F  W !!,"Is this due to the patient being transferred" S %=2 D YN^DICN Q:%  D ENCTM^PSGOEM1
"RTN","PSGOEC",97,0)
 S T=$S(%<0:"^",1:$E("T",%=1)) Q
"RTN","PSGOEC",98,0)
RS ;
"RTN","PSGOEC",99,0)
 ; naked ref below is from variable ND1, ^PS(53.1,PSGDA,4)
"RTN","PSGOEC",100,0)
 S $P(^(4),U,11,14)="^^^" Q
"RTN","PSGOEC",101,0)
 ;
"RTN","PSGOEC",102,0)
REQPROV()          ;
"RTN","PSGOEC",103,0)
 I $G(PSJDCTYP)=2 Q 1
"RTN","PSGOEC",104,0)
 K PSJDCPRV,DIC,DUOUT,DTOUT,Y
"RTN","PSGOEC",105,0)
 N PROVIDER,PROVNAME,RESULT,RSB S RESULT=0
"RTN","PSGOEC",106,0)
 S PROVIDER=+$P($G(^PS(55,DFN,5.1)),"^",2),PROVNAME=""
"RTN","PSGOEC",107,0)
 I PROVIDER>0 D
"RTN","PSGOEC",108,0)
 .S DIC=200,DR="53.1;53.4",DIQ="RSB",DIQ(0)="I",DA=PROVIDER D EN^DIQ1
"RTN","PSGOEC",109,0)
 .K DIC,DR,DA,DIQ
"RTN","PSGOEC",110,0)
 .I $G(RSB(200,PROVIDER,53.1,"I"))="1"&(($G(RSB(200,PROVIDER,53.4,"I"))="")!($G(RSB(200,PROVIDER,53.4,"I"))>DT)) D
"RTN","PSGOEC",111,0)
 ..S DIC=200,DA=PROVIDER,DR=".01",DIQ="RSB",DIQ(0)="E" D EN^DIQ1
"RTN","PSGOEC",112,0)
 ..S PROVNAME=$G(RSB(200,PROVIDER,.01,"E")) K DA,DIQ,DR
"RTN","PSGOEC",113,0)
 K DIC S DIC=200,DIC(0)="AEMQZ"
"RTN","PSGOEC",114,0)
 S:PROVNAME]"" DIC("B")=PROVNAME
"RTN","PSGOEC",115,0)
 S DIC("A")="Requesting PROVIDER: "
"RTN","PSGOEC",116,0)
 S DIC("S")="I $D(^(""PS"")),^(""PS""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)>DT)" D ^DIC K DIC
"RTN","PSGOEC",117,0)
 I +Y>0,'$D(DUOUT),'$D(DTOUT) S RESULT=1,PSJDCPRV=+Y
"RTN","PSGOEC",118,0)
 Q RESULT
"RTN","PSGOEC",119,0)
 ;
"RTN","PSGOEC",120,0)
PNDRNA(ORDER) ; Ask Discontinue Pending Renewal only, or both Pending Renew and Renewed Order
"RTN","PSGOEC",121,0)
 ; Perform this action only for pending renewals
"RTN","PSGOEC",122,0)
 I '$G(ORDER)!'($G(ORDER)["P") Q 3
"RTN","PSGOEC",123,0)
 ; Quit if original order is no longer active
"RTN","PSGOEC",124,0)
 N ORIGORD,ORIGSTOP S ORIGORD=$P($G(^PS(53.1,+ORDER,0)),"^",25) Q:'ORIGORD  D  I ORIGSTOP<$G(PSGDT) Q 1
"RTN","PSGOEC",125,0)
 .S ORIGSTOP=$S(ORIGORD["U":$P($G(^PS(55,PSGP,5,+ORIGORD,2)),"^",4),ORIGORD["V":$P($G(^PS(55,PSGP,"IV",+ORIGORD,0)),"^",3),1:"")
"RTN","PSGOEC",126,0)
 N NDP2
"RTN","PSGOEC",127,0)
 S NDP2=^PS(53.1,+ORDER,.2) S DRG=NDP2,DO=$P(DRG,"^",2) S DRG=$$ENPDN^PSGMI($P(DRG,"^"))
"RTN","PSGOEC",128,0)
 S ND2=^PS(53.1,+ORDER,2) S SCH=$P(ND2,"^"),START=$P(ND2,"^",2),START=$$FMTE^XLFDT(START,2)
"RTN","PSGOEC",129,0)
 W !!?5,DRG_" "_DO
"RTN","PSGOEC",130,0)
 W !?5,"This order has a pending status. If this pending order"
"RTN","PSGOEC",131,0)
 W !?5,"is discontinued, the original order may still be active."
"RTN","PSGOEC",132,0)
 S DIR("A")="Select order(s) to discontinue"
"RTN","PSGOEC",133,0)
 S DIR(0)="S^1:DC BOTH Orders;2:DC Pending Order;3:Cancel - No Action Taken"
"RTN","PSGOEC",134,0)
 S DIR("L",1)="1 - DC BOTH Orders"
"RTN","PSGOEC",135,0)
 S DIR("L",2)="2 - DC Pending Order"
"RTN","PSGOEC",136,0)
 S DIR("L",3)="3 - Cancel - No Action Taken" D ^DIR
"RTN","PSGOEC",137,0)
 ; Reverse order - Y=1 - Pending only  Y=2:BOTH
"RTN","PSGOEC",138,0)
 S Y=$S(Y=1:2,Y=2:1,1:3)
"RTN","PSGOEC",139,0)
 Q Y
"RTN","PSGOEC",140,0)
 ;
"RTN","PSGOEC",141,0)
PNDRN(PSJDCTYP,ORDER) ; Perform Discontinue action for Pending order only or both Pending and Renewed
"RTN","PSGOEC",142,0)
 ; Perform this action only for pending renewals
"RTN","PSGOEC",143,0)
 N PSGORD S PSGORD=ORDER
"RTN","PSGOEC",144,0)
 Q:'$G(PSGORD)!'($G(PSGORD)["P")
"RTN","PSGOEC",145,0)
 I PSJDCTYP=1 G SOC
"RTN","PSGOEC",146,0)
 I PSJDCTYP=2 S PSJDCTYP=1 D SOC Q:'$G(PSJDCTYP)  D
"RTN","PSGOEC",147,0)
 .I ($G(PSJNOO)<0) Q
"RTN","PSGOEC",148,0)
 .N ND5310 S ND5310=$G(^PS(53.1,+PSGORD,0))
"RTN","PSGOEC",149,0)
 .N PSGORD S PSGORD=$P(ND5310,"^",25) I PSGORD S PSJDCTYP=2 D SOC K PSJDCTYP
"RTN","PSGOEC",150,0)
 Q
"RTN","PSGOEC",151,0)
 ;
"RTN","PSGOEC",152,0)
PNDRNOK(ORDER) ; Execute DC Pending Renew enhancement only if 
"RTN","PSGOEC",153,0)
 ;                  1) Renewal order is pending/non-verified, and 
"RTN","PSGOEC",154,0)
 ;                  2) Original order is not DC'd or Expired
"RTN","PSGOEC",155,0)
 Q:'$G(PSGORD)!'($G(PSGORD)["P") 0
"RTN","PSGOEC",156,0)
 N ORIGORD,ORIGSTOP S ORIGORD=$P($G(^PS(53.1,+ORDER,0)),"^",25) Q:'ORIGORD 0  D  I ORIGSTOP<$G(PSGDT) Q 0
"RTN","PSGOEC",157,0)
 .S ORIGSTOP=$S(ORIGORD["U":$P($G(^PS(55,PSGP,5,+ORIGORD,2)),"^",4),ORIGORD["V":$P($G(^PS(55,PSGP,"IV",+ORIGORD,0)),"^",3),1:"")
"RTN","PSGOEC",158,0)
 Q:'($P($G(^PS(53.1,+PSGORD,0)),U,24)="R") 0
"RTN","PSGOEC",159,0)
 Q 1
"RTN","PSGOEC",160,0)
 ;
"RTN","PSGOEC",161,0)
TST4DC ; Test for DC at prompt
"RTN","PSGOEC",162,0)
 R X:$S($D(DTIME):DTIME,1:300) I '$T S %=2 Q
"RTN","PSGOEC",163,0)
 S %=$S(X="DC":1,X="Dc":1,X="dc":1,X="dC":1,X="D":1,X="d":1,X="":2,X="^":2,X]"":"",1:2)
"RTN","PSGOEC",164,0)
 Q
"RTN","PSGOT")
0^40^B23046911
"RTN","PSGOT",1,0)
PSGOT ;BIR/CML3-TRANSFERS DATA FROM 53.1 TO 55 ;24 SEP 97 / 7:54 AM
"RTN","PSGOT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**13,68,90,110,173,134,161,254,267,257**;16 DEC 97;Build 105
"RTN","PSGOT",3,0)
 ;
"RTN","PSGOT",4,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOT",5,0)
 ; Reference to ^PSUHL supported by DBIA 4803.
"RTN","PSGOT",6,0)
 ;
"RTN","PSGOT",7,0)
START ; get internal record number, lock record, and write
"RTN","PSGOT",8,0)
 S ODA=+PSGORD S:$D(^PS(55,PSGP,0))[0 ^(0)=PSGP,^PS(55,"B",PSGP,PSGP)="",$P(^PS(55,0),U,3,4)=PSGP_U_($P($G(^PS(55,0)),U,4)+1) F  L +^PS(55,PSGP,5,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSGOT",9,0)
 S ZND=$G(^PS(55,PSGP,5,0)) S:ZND="" ZND="^55.06IA" F DA=$P(ZND,"^",3)+1:1 I '$D(^PS(55,PSGP,5,DA)),'$D(^("B",DA)) L +^PS(55,PSGP,5,DA):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  S $P(ZND,"^",3)=DA,$P(ZND,"^",4)=$P(ZND,"^",4)+1,^PS(55,PSGP,5,0)=ZND Q
"RTN","PSGOT",10,0)
 L -^PS(55,PSGP,5,0) S ND0=^PS(53.1,ODA,0),$P(ND0,"^",23)=PSJPWD,^PS(55,PSGP,5,DA,0)=ND0
"RTN","PSGOT",11,0)
 S (ND1,^PS(55,PSGP,5,DA,.2))=$G(^PS(53.1,ODA,.2)),^PS(55,PSGP,5,DA,.3)=$G(^PS(53.1,ODA,.3)),(ND2,^PS(55,PSGP,5,DA,2))=^PS(53.1,ODA,2),^PS(55,PSGP,5,DA,4)=$G(^PS(53.1,ODA,4)),^PS(55,"AUD",+$P(ND2,"^",4),PSGP,DA)=""
"RTN","PSGOT",12,0)
 S X=^PS(55,PSGP,0) I $P(X,"^",7)="" S $P(X,"^",7)=$P($P(ND0,"^",16),"."),$P(X,"^",8)="A",^(0)=X D LOGDFN^PSUHL(PSGP)
"RTN","PSGOT",13,0)
 I $P($G(^PS(55,PSGP,5,DA,2)),"^",6)="" S $P(^PS(55,PSGP,5,DA,2),"^",6)=$S($G(PSGS0XT)'="":PSGS0XT,$P($G(ZZND),"^",3)'="":$P(ZZND,"^",3),1:""),$P(^PS(53.1,ODA,2),"^",6)=$P(^PS(55,PSGP,5,DA,2),"^",6)
"RTN","PSGOT",14,0)
 F X=6,7,13 I $D(^PS(53.1,ODA,X)) S ^PS(55,PSGP,5,DA,X)=^(X)
"RTN","PSGOT",15,0)
 I $D(^PS(53.1,ODA,"DSS")) S ^PS(55,PSGP,5,DA,8)=^("DSS") D CIMOU^PSJIMO1(PSGP,DA,"",ODA)
"RTN","PSGOT",16,0)
 I $O(^PS(53.1,ODA,1,0)) S (C,X)=0 F  S X=$O(^PS(53.1,ODA,1,X)) Q:'X  S:$D(^(X,0)) C=C+1,^PS(55,PSGP,5,DA,1,C,0)=^(0),^PS(55,PSGP,5,DA,1,"B",+$P($G(^(0)),U),C)=""
"RTN","PSGOT",17,0)
 I $O(^PS(53.1,ODA,1,0)) S ^PS(55,PSGP,5,DA,1,0)="^55.07P^"_C_"^"_C
"RTN","PSGOT",18,0)
 F X=3,12 D  S ^PS(55,PSGP,5,DA,X,0)="^55.0"_$S(X=3:8,1:612)_U_CNT_U_CNT
"RTN","PSGOT",19,0)
 .S CNT=0 F C=0:0 S C=$O(^PS(53.1,ODA,X,C)) Q:'C  I $D(^(C,0)) S ^PS(55,PSGP,5,DA,X,C,0)=^(0),CNT=CNT+1
"RTN","PSGOT",20,0)
 S $P(^PS(53.1,ODA,0),"^",19)=DA
"RTN","PSGOT",21,0)
 D SETUDINT^PSGSICH1(ODA_"P",DA_"U")
"RTN","PSGOT",22,0)
CR ; set x-refs
"RTN","PSGOT",23,0)
 N A
"RTN","PSGOT",24,0)
 I $D(^PS(55,PSGP,5.1)),$P(^(5.1),"^",6) S X=$P(^(5.1),"^",6) I $P(ND2,"^",3),$P(ND2,"^",6)'>X S $P(^(5.1),"^",6)=$P(ND2,"^",3)
"RTN","PSGOT",25,0)
 S ^PS(55,PSGP,5,"B",+ODA,DA)="",^PS(55,PSGP,5,"AU",$P(ND0,"^",7),+$P(ND2,"^",4),DA)=""
"RTN","PSGOT",26,0)
 S ^PS(55,PSGP,5,"AUS",+$P(ND2,"^",4),DA)=""
"RTN","PSGOT",27,0)
 S ^PS(55,PSGP,5,"C",+ND1,DA)="",^PS(55,"AUE",PSGP,DA)=""
"RTN","PSGOT",28,0)
 S ^PS(55,"AUDS",+$P(ND2,"^",2),PSGP,DA)=""
"RTN","PSGOT",29,0)
 I $D(^PS(55,PSGP,5,DA,8)) S A=^(8),^PS(55,"AUDC",+$P(ND2,"^",4),+A,PSGP,DA)=""
"RTN","PSGOT",30,0)
 I $$PATCH^XPDUTL("PXRM*1.5*12") S X(1)=+$P(ND2,"^",2),X(2)=+$P(ND2,"^",4),DA(1)=PSGP D SPSPA^PSJXRFS(.X,.DA,"UD")
"RTN","PSGOT",31,0)
 K DIK S DA(1)=PSGP S DIK="^PS(55,"_DA(1)_",5,",DIK(1)=125 D EN1^DIK K DIK
"RTN","PSGOT",32,0)
 S PSGTOL=2,PSGTOO=1 F PSGUOW=0:0 S PSGUOW=$O(^PS(53.41,2,1,PSGUOW)) Q:'PSGUOW  I $D(^(PSGUOW,1,PSGP,1,2,1,+ODA)) K ^(+ODA) D ENL^PSGVDS
"RTN","PSGOT",33,0)
DONE I $D(PSGOE2),PSGOE2]"",$D(^TMP("PSJON",$J,PSGOE2)) S ^(PSGOE2)=DA_"U"
"RTN","PSGOT",34,0)
 N PSJTMPTX,PSJOVRMX,PSJTMPLIN
"RTN","PSGOT",35,0)
 S PSGODA=ODA,PSGORD=DA_"U"
"RTN","PSGOT",36,0)
 S PSGNODE=$G(^PS(55,PSGP,5,DA,0)),PSG25=$P(PSGNODE,"^",25),PSG26=$P(PSGNODE,"^",26)
"RTN","PSGOT",37,0)
 I PSG25 S X=$S(PSG25["V":"^PS(55,"_PSGP_",""IV"",",PSG25["U"!(PSG25["A"):"^PS(55,"_PSGP_",5,",1:"^PS(53.1,")_+PSG25_","_$E("02",PSG25["V"+1)_")" I $D(@X) S $P(@X,"^",$S(PSG25["V":6,1:26))=DA_"U"
"RTN","PSGOT",38,0)
 I $P(PSGNODE,"^",26),$P(PSGNODE,"^",26)'["V",$D(^PS(55,PSGP,5,+$P(PSGNODE,"^",26),0)) S $P(^(0),"^",25)=DA_"U"
"RTN","PSGOT",39,0)
 F Q=0:0 S Q=$O(^PS(53.44,Q)) Q:'Q  I $D(^(Q,1,PSGP,+ODA,0)) S $P(^(0),"^",2)=DA
"RTN","PSGOT",40,0)
 I $D(^PS(53.1,+ODA,15,0)) S ^PS(55,PSGP,5,DA,15,0)="^55.6135^"_$P($G(^PS(53.1,+ODA,15,0)),"^",3)_"^"_$P($G(^PS(53.1,+ODA,15,0)),"^",4) D
"RTN","PSGOT",41,0)
 .N LN,LNCNT,SIMSG S SIMSG="Instructions too long. See Order View or BCMA for full text."
"RTN","PSGOT",42,0)
 .S LNCNT=0,LN=9999 F  S LN=$O(^PS(53.1,+ODA,15,LN),-1) Q:'LN  D
"RTN","PSGOT",43,0)
 ..I 'LNCNT,($G(^PS(53.1,+ODA,15,LN,0))="") Q
"RTN","PSGOT",44,0)
 ..S ^PS(55,PSGP,5,DA,15,LN,0)=^PS(53.1,+ODA,15,LN,0) S LNCNT=LNCNT+1
"RTN","PSGOT",45,0)
 .I LNCNT S $P(^PS(55,PSGP,5,DA,15,0),"^",3,4)=LNCNT_"^"_LNCNT
"RTN","PSGOT",46,0)
 .S PSJTMPTX="",PSJOVRMX=0 S TMPLIN=0 F  S TMPLIN=$O(^PS(55,+DFN,5,DA,15,TMPLIN)) Q:'TMPLIN!(PSJOVRMX)  D
"RTN","PSGOT",47,0)
 ..S:($L(PSJTMPTX)+$L($G(^PS(55,+DFN,5,DA,15,TMPLIN,0))))>180 PSJOVRMX=1 Q:$G(PSJOVRMX)  S PSJTMPTX=$G(PSJTMPTX)_$S($G(PSJTMPTX)]"":" ",1:"")_$G(^PS(55,+DFN,5,DA,15,TMPLIN,0))
"RTN","PSGOT",48,0)
 .S TXT=$S(PSJOVRMX:SIMSG,1:PSJTMPTX)
"RTN","PSGOT",49,0)
 .S:($TR(TXT,"^ ")="")!'($D(^PS(55,PSGP,5,DA,15,1))) TXT="" S ^PS(55,PSGP,5,DA,6)=TXT S $P(^PS(55,PSGP,5,DA,6),"^",2)=$P(^PS(53.1,+ODA,6),"^",2)
"RTN","PSGOT",50,0)
 .N LSTLNUM,LSTLNTXT S LSTLNUM=$O(^PS(55,+PSGP,5,+DA,15,""),-1) I LSTLNUM>1 S LSTLNTXT=$G(^PS(55,+PSGP,5,+DA,15,LSTLNUM,0)) I $TR(LSTLNTXT," ")="" D
"RTN","PSGOT",51,0)
 ..K ^PS(55,+PSGP,5,+DA,15,LSTLNUM,0)
"RTN","PSGOT",52,0)
 L -^PS(53.1,+ODA) L -^PS(55,PSGP,5,+DA) K CNT,ND,ODA,XX,ZND
"RTN","PSGOT",53,0)
 Q
"RTN","PSGOT",54,0)
 ;
"RTN","PSGOTR")
0^41^B19636030
"RTN","PSGOTR",1,0)
PSGOTR ;BIR/CML3-TRANSFERS RENEW DATA FROM 53.1 TO 55 ;23 SEP 03 / 7:54 AM
"RTN","PSGOTR",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**110,127,133,129,267,257**;16 DEC 97;Build 105
"RTN","PSGOTR",3,0)
 ;
"RTN","PSGOTR",4,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOTR",5,0)
 ;
"RTN","PSGOTR",6,0)
START(ODA,DA) ; lock record, and write
"RTN","PSGOTR",7,0)
 N OFD,PVND4 S OFD=""
"RTN","PSGOTR",8,0)
 S OFD=$P($G(^PS(55,PSGP,5,DA,2)),"^",4) K:OFD ^PS(55,"AUD",+OFD,PSGP,+DA)
"RTN","PSGOTR",9,0)
 S ND2=^PS(53.1,+ODA,2) S ^PS(55,"AUD",+$P(ND2,"^",4),PSGP,DA)=""
"RTN","PSGOTR",10,0)
 F X=6,7 I $D(^PS(53.1,+ODA,X)) S ^PS(55,PSGP,5,DA,X)=^(X)
"RTN","PSGOTR",11,0)
 I $O(^PS(53.1,+ODA,1,0)) D
"RTN","PSGOTR",12,0)
 .K ^PS(55,PSGP,5,DA,1)
"RTN","PSGOTR",13,0)
 .S (C,X)=0 F  S X=$O(^PS(53.1,+ODA,1,X)) Q:'X  S:$D(^(X,0)) C=C+1,^PS(55,PSGP,5,DA,1,C,0)=^(0),^PS(55,PSGP,5,DA,1,"B",+$P($G(^(0)),U),C)=""
"RTN","PSGOTR",14,0)
 .S ^PS(55,PSGP,5,DA,1,0)="^55.07P^"_C_"^"_C
"RTN","PSGOTR",15,0)
 F X=3,12 D  S ^PS(55,PSGP,5,DA,X,0)="^55.0"_$S(X=3:8,1:612)_U_CNT_U_CNT
"RTN","PSGOTR",16,0)
 .S CNT=0 F C=0:0 S C=$O(^PS(53.1,+ODA,X,C)) Q:'C  I $D(^(C,0)) S ^PS(55,PSGP,5,DA,X,C,0)=^(0),CNT=CNT+1
"RTN","PSGOTR",17,0)
 S $P(^PS(53.1,+ODA,0),"^",19)=DA
"RTN","PSGOTR",18,0)
 S $P(^PS(55,PSGP,5,DA,0),"^",7)=$P(^PS(53.1,+ODA,0),"^",7)
"RTN","PSGOTR",19,0)
 N PSGPND0,PSGPND2,RDUZ,OND14 S PSGPND0=^PS(53.1,+ODA,0),PSGPND2=^(2) S RNWDT=$P(PSGPND0,"^",16),PSGOEPR=$P(PSGPND0,"^",2)
"RTN","PSGOTR",20,0)
 S PSGFD=$P(PSGPND2,"^",4),PSJNOO=$P(^PS(53.1,+ODA,.2),"^",3) S OND14=$$LASTREN^PSJLMPRI(PSGP,+ODA_"P") S RDUZ=$P(OND14,"^",2) S:$P(OND14,"^",3) PSGOEPR=$P(OND14,"^",3)
"RTN","PSGOTR",21,0)
 I '$G(DUOUT) D
"RTN","PSGOTR",22,0)
 .I $G(PSJORD)["P" N PSGFDO S PSGFDO=$$LASTREN^PSJLMPRI(PSGP,PSJORD),PSGFDO=$P(PSGFDO,"^",4)
"RTN","PSGOTR",23,0)
 .D UPDREN^PSGOER(DA_"U",RNWDT,PSGOEPR,$S($G(PSGFDO):PSGFDO,1:PSGFD),PSJNOO,RDUZ)
"RTN","PSGOTR",24,0)
 S PVND4=$G(^PS(53.1,+ODA,4)) I $P(PVND4,"^"),$P(PVND4,"^",2) D
"RTN","PSGOTR",25,0)
 .N RNDT S RNDT=$$LASTREN^PSJLMPRI(DFN,+ODA_"P") Q:RNDT>$P(PVND4,"^",2)
"RTN","PSGOTR",26,0)
 .S $P(^PS(55,DFN,5,DA,4),"^")=$P(PVND4,"^"),$P(^PS(55,DFN,5,DA,4),"^",2)=$P(PVND4,"^",2)
"RTN","PSGOTR",27,0)
CR ; set x-refs
"RTN","PSGOTR",28,0)
 I $D(^PS(55,PSGP,5.1)),$P(^(5.1),"^",6) S X=$P(^(5.1),"^",6) I $P(ND2,"^",3),$P(ND2,"^",6)'>X S $P(^(5.1),"^",6)=$P(ND2,"^",3)
"RTN","PSGOTR",29,0)
 S ^PS(55,PSGP,5,"B",+ODA,DA)="",^PS(55,"AUE",PSGP,DA)=""
"RTN","PSGOTR",30,0)
 F S="C","O","P","R","OC" K ^PS(55,PSGP,5,"AU",S,+$P(PSGPND2,"^",4),DA)
"RTN","PSGOTR",31,0)
 S ^PS(55,PSGP,5,"AU",$P(PSGPND0,"^",7),+$P(PSGPND2,"^",4),DA)=""
"RTN","PSGOTR",32,0)
 S ^PS(55,PSGP,5,"AUS",+$P(ND2,"^",4),DA)="" I OFD,OFD'=$P(ND2,"^",4) K ^PS(55,PSGP,5,"AUS",+OFD,DA)
"RTN","PSGOTR",33,0)
 D CIMOU^PSJIMO1(PSGP,DA,"",ODA)
"RTN","PSGOTR",34,0)
 I $$PATCH^XPDUTL("PXRM*1.5*12") S X(1)=+$P(ND2,"^",2),X(2)=+$P(ND2,"^",4),DA(1)=PSGP D SPSPA^PSJXRFS(.X,.DA,"UD")
"RTN","PSGOTR",35,0)
 K DIK S DA(1)=PSGP S DIK="^PS(55,"_DA(1)_",5,",DIK(1)=125 D EN1^DIK K DIK
"RTN","PSGOTR",36,0)
 S PSGTOL=2,PSGTOO=1 F PSGUOW=0:0 S PSGUOW=$O(^PS(53.41,2,1,PSGUOW)) Q:'PSGUOW  I $D(^(PSGUOW,1,PSGP,1,2,1,+ODA)) K ^(+ODA) D ENL^PSGVDS
"RTN","PSGOTR",37,0)
DONE I $D(PSGOE2),PSGOE2]"",$D(^TMP("PSJON",$J,PSGOE2)) S ^(PSGOE2)=DA_"U"
"RTN","PSGOTR",38,0)
 S PSGODA=ODA,PSGORD=DA_"U"
"RTN","PSGOTR",39,0)
 F Q=0:0 S Q=$O(^PS(53.44,Q)) Q:'Q  I $D(^(Q,1,PSGP,+ODA,0)) S $P(^(0),"^",2)=DA
"RTN","PSGOTR",40,0)
 I $D(^PS(53.1,+ODA,15,0)) N SIARRAY D
"RTN","PSGOTR",41,0)
 .M SIARRAY=^PS(55,PSGP,5,+DA,15) I $$DIFFSI^PSJBCMA5(PSGP,+DA_"U") D NEWUDAL^PSGAL5(PSGP,+DA_"U",6000,"SPECIAL INSTRUCTIONS",,.SIARRAY)
"RTN","PSGOTR",42,0)
 .K ^PS(55,PSGP,5,DA,15) S ^PS(55,PSGP,5,DA,6)=$G(^PS(53.1,+ODA,6)) S ^PS(55,PSGP,5,DA,15,0)="^55.6135^"_$P($G(^PS(53.1,+ODA,15,0)),"^",3)_"^"_$P($G(^PS(53.1,+ODA,15,0)),"^",4)
"RTN","PSGOTR",43,0)
 .N LN,LNCNT S LNCNT=0,LN=9999 F  S LN=$O(^PS(53.1,+ODA,15,LN),-1) Q:'LN  D
"RTN","PSGOTR",44,0)
 ..I 'LNCNT,($G(^PS(53.1,+ODA,15,LN,0))="") Q
"RTN","PSGOTR",45,0)
 ..S ^PS(55,PSGP,5,DA,15,LN,0)=^PS(53.1,+ODA,15,LN,0) S LNCNT=LNCNT+1
"RTN","PSGOTR",46,0)
 .I LNCNT S $P(^PS(55,PSGP,5,DA,15,0),"^",3,4)=LNCNT_"^"_LNCNT
"RTN","PSGOTR",47,0)
 .N TXT,LNCNT,SIMSG S LNCNT=$O(^PS(53.1,+ODA,15,""),-1) S SIMSG="Instructions too long. See Order View or BCMA for full text."
"RTN","PSGOTR",48,0)
 .S PSJTMPTX="",PSJOVRMX=0 S TMPLIN=0 F  S TMPLIN=$O(^PS(55,+DFN,5,DA,15,TMPLIN)) Q:'TMPLIN!(PSJOVRMX)  D
"RTN","PSGOTR",49,0)
 ..S:($L(PSJTMPTX)+$L($G(^PS(55,+DFN,5,DA,15,TMPLIN,0))))>180 PSJOVRMX=1 Q:$G(PSJOVRMX)  S PSJTMPTX=$G(PSJTMPTX)_$S($G(PSJTMPTX)]"":" ",1:"")_$G(^PS(55,+DFN,5,DA,15,TMPLIN,0))
"RTN","PSGOTR",50,0)
 .S TXT=$S(PSJOVRMX:SIMSG,1:PSJTMPTX)
"RTN","PSGOTR",51,0)
 .S:($TR(TXT,"^ ")="")!'($D(^PS(55,PSGP,5,DA,15,1))) TXT="" S ^PS(55,PSGP,5,DA,6)=TXT S $P(^PS(55,PSGP,5,DA,6),"^",2)=$P(^PS(53.1,+ODA,6),"^",2)
"RTN","PSGOTR",52,0)
 .N LSTLNUM,LSTLNTXT S LSTLNUM=$O(^PS(55,+PSGP,5,+DA,15,""),-1) I LSTLNUM>1 S LSTLNTXT=$G(^PS(55,+PSGP,5,+DA,15,LSTLNUM,0)) I $TR(LSTLNTXT," ")="" D
"RTN","PSGOTR",53,0)
 ..K ^PS(55,+PSGP,5,+DA,15,LSTLNUM,0)
"RTN","PSGOTR",54,0)
 L -^PS(53.1,+ODA) L -^PS(55,PSGP,5,+DA) K CNT,ND,ODA,XX,ZND Q
"RTN","PSIVOCDS")
0^27^B131643526
"RTN","PSIVOCDS",1,0)
PSIVOCDS ;BIR/MV - PROCESS DOSING ORDER CHECKS FOR IV ;6 Jun 07 / 3:37 PM
"RTN","PSIVOCDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252,257**;16 DEC 97;Build 105
"RTN","PSIVOCDS",3,0)
 ;
"RTN","PSIVOCDS",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIVOCDS",5,0)
 ; Reference to ^PSDRUG is supported by DBIA #2192.
"RTN","PSIVOCDS",6,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425.
"RTN","PSIVOCDS",7,0)
 ; Reference to ^PSSFDBRT is supported by DBIA #5496.
"RTN","PSIVOCDS",8,0)
 ; Reference to $$CONV^PSSDSAPK is supported by DBIA #5497.
"RTN","PSIVOCDS",9,0)
 ;
"RTN","PSIVOCDS",10,0)
IN(PSJBASE) ;
"RTN","PSIVOCDS",11,0)
 ;PSJBASE - Base(Literal value for TMP global)- Required
"RTN","PSIVOCDS",12,0)
 ;PSIVDDSV(AD/SOL,CNT)=P1..P9
"RTN","PSIVOCDS",13,0)
 ; P1=Drug IEN; P2=Dspl name(add/sol or CPRS OI; P3=Numeric dose & unit; P4=Bottle #
"RTN","PSIVOCDS",14,0)
 ; P5=""; P6=""; P7=""; P8=Strength/Vol; P9=Unit
"RTN","PSIVOCDS",15,0)
 ;
"RTN","PSIVOCDS",16,0)
 ;These two flags below are set when stuff freq, duration to 1 & Duration rate = dose rate
"RTN","PSIVOCDS",17,0)
 ;They are used by the output routine to generate the appropriate output messages.
"RTN","PSIVOCDS",18,0)
 ;PSJFDB(PSJCNT,"INF_ERROR")="" & PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",19,0)
 ;
"RTN","PSIVOCDS",20,0)
 NEW ON,PSJCNT,PSJCNTX,PSJONEFG,PSJRT,PSIVAS,PSIVAS0,PSIVDDSV,PSPDRG,PSJALLGY,X,PSJP8,PSJP8NUM,PSJP8UNT,PSJP8TME,PSJOIX
"RTN","PSIVOCDS",21,0)
 K PSJOCDS,PSJFDB,PSIVDDSV,PSPDRG,PSJALLGY
"RTN","PSIVOCDS",22,0)
 S PSJCNT=0
"RTN","PSIVOCDS",23,0)
 ;PSJRT - FDB Route
"RTN","PSIVOCDS",24,0)
 S PSJRT=$P($$MRT^PSSDSAPI(+P("MR")),U,2)
"RTN","PSIVOCDS",25,0)
 ;Set Flag to indicate CPRS OI had no active AD/SOL.
"RTN","PSIVOCDS",26,0)
 S PSJOIX="" F  S PSJOIX=$O(PSJIV("OI_ERROR",PSJOIX)) Q:PSJOIX=""  D
"RTN","PSIVOCDS",27,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSIVOCDS",28,0)
 . S PSJFDB(PSJCNT,"RX_NUM")="I;;PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",29,0)
 . S PSJFDB(PSJCNT,"DRUG_NM")=PSJOIX
"RTN","PSIVOCDS",30,0)
 . S PSJFDB(PSJCNT,"OI")=$P(PSJIV("OI_ERROR",PSJOIX),U,2)
"RTN","PSIVOCDS",31,0)
 . S PSJFDB(PSJCNT,"OI_ERROR",PSJOIX)=$P(PSJIV("OI_ERROR",PSJOIX),U)_U_"I;;PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",32,0)
 D SETDD^PSIVOC(1)
"RTN","PSIVOCDS",33,0)
 I ($G(PSIVDDSV("TOT_VOL"))=""),($G(PSJIV("TOT_VOL"))]"") S PSIVDDSV("TOT_VOL")=PSJIV("TOT_VOL")
"RTN","PSIVOCDS",34,0)
 F PSIVAS="AD","SOL" F PSJCNTX=0:0 S PSJCNTX=$O(PSIVDDSV(PSIVAS,PSJCNTX)) Q:'PSJCNTX  D
"RTN","PSIVOCDS",35,0)
 . S PSIVAS0=$G(PSIVDDSV(PSIVAS,PSJCNTX))
"RTN","PSIVOCDS",36,0)
 .;PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" now FDB handles both units for this drug.
"RTN","PSIVOCDS",37,0)
 .;I PSIVAS="SOL" S X=$$LITER($P(PSIVAS0,U,8)) I X]"" D
"RTN","PSIVOCDS",38,0)
 .;. S $P(PSIVAS0,U,8)=$P(X,U)
"RTN","PSIVOCDS",39,0)
 .;. S $P(PSIVAS0,U,9)=$P(X,U,2)
"RTN","PSIVOCDS",40,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSIVOCDS",41,0)
 . D COMMON
"RTN","PSIVOCDS",42,0)
 . I P("DTYP")=1 D IVPB
"RTN","PSIVOCDS",43,0)
 . I P("DTYP")>1 D IV
"RTN","PSIVOCDS",44,0)
 Q
"RTN","PSIVOCDS",45,0)
IV ;Setup input data for Continuous IV (admixture, hyperal)
"RTN","PSIVOCDS",46,0)
 NEW PSJXRT,PSJP8ERR
"RTN","PSIVOCDS",47,0)
 S PSJP8=$$P8^PSJMISC2(P(8))
"RTN","PSIVOCDS",48,0)
 D BASIC
"RTN","PSIVOCDS",49,0)
 S PSJP8NUM=+$P(PSJP8,U)
"RTN","PSIVOCDS",50,0)
 S PSJP8UNT=$P(PSJP8,U,2)
"RTN","PSIVOCDS",51,0)
 S PSJP8TME=$P(PSJP8,U,3)
"RTN","PSIVOCDS",52,0)
 ;All premix are using the "Continuous Infusion" Route logic. This is so Potassium gets both single
"RTN","PSIVOCDS",53,0)
 ;and max dosing checks.  Cisplatin premix won't work since FDB can't process as "Continuous Infusion"
"RTN","PSIVOCDS",54,0)
 I PSIVAS="SOL" D PREMIX Q
"RTN","PSIVOCDS",55,0)
 S PSJXRT=$$RTESCRN($P($$MRT^PSSDSAPI(+P("MR")),U,1))
"RTN","PSIVOCDS",56,0)
 I $$ISONEAD(),$$ISALLBAG(),('$$CLASS(PSJFDB(PSJCNT,"DRUG_IEN"))),(PSJXRT'=0),$$FDBRT(PSJFDB(PSJCNT,"DRUG_IEN"),PSJXRT) D ONEAD(PSJXRT) Q
"RTN","PSIVOCDS",57,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",58,0)
 D CONTIV
"RTN","PSIVOCDS",59,0)
 Q
"RTN","PSIVOCDS",60,0)
IVPB ;Setup input data for Schedule IV
"RTN","PSIVOCDS",61,0)
 NEW X,PSJP9,PSJP15
"RTN","PSIVOCDS",62,0)
 S PSJOCDS(PSJCNT,"DRUG_AMT")=$P(PSIVAS0,U,8)
"RTN","PSIVOCDS",63,0)
 S PSJOCDS(PSJCNT,"DRUG_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",64,0)
 I '+$G(PSJIV("DUR")) D
"RTN","PSIVOCDS",65,0)
 . S X=$$DURATION()
"RTN","PSIVOCDS",66,0)
 . S PSJOCDS(PSJCNT,"DRATE")=$S(+X:X_"M",1:"")
"RTN","PSIVOCDS",67,0)
 I +$G(PSJIV("DUR"))<1440,(+$G(PSJIV("DUR"))>0) S PSJOCDS(PSJCNT,"DRATE")=PSJIV("DUR")
"RTN","PSIVOCDS",68,0)
 S PSJOCDS(PSJCNT,"MR_IEN")=+P("MR")
"RTN","PSIVOCDS",69,0)
 S PSJOCDS(PSJCNT,"DO")=""
"RTN","PSIVOCDS",70,0)
 S PSJOCDS(PSJCNT,"SCHEDULE")=P(9)
"RTN","PSIVOCDS",71,0)
 ;
"RTN","PSIVOCDS",72,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=$S('+$P(PSIVAS0,U,8):"",1:$P(PSIVAS0,U,8))
"RTN","PSIVOCDS",73,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",74,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",75,0)
 ;
"RTN","PSIVOCDS",76,0)
 S PSJONEFG=0
"RTN","PSIVOCDS",77,0)
 I $$ONE^PSJORPOE(P(9))!$$ONCALL^PSJMISC(P(9)) S PSJONEFG=1 D SINGLE Q
"RTN","PSIVOCDS",78,0)
 I +$G(PSJIV("DOSE_CNT")) S PSJFDB(PSJCNT,"FREQ")=$G(PSJIV("DOSE_CNT")) Q
"RTN","PSIVOCDS",79,0)
 I +$G(PSJOCDS(PSJCNT,"DRATE")) D UND24HRS^PSJOCDS(+PSJOCDS(PSJCNT,"DRATE"),$G(P(11)),$G(P(15)),$G(P(2)),$G(P(3)),$G(P(9))) Q
"RTN","PSIVOCDS",80,0)
 I 'PSJONEFG D
"RTN","PSIVOCDS",81,0)
 . S X="",PSJP9=P(9)
"RTN","PSIVOCDS",82,0)
 . S PSJP15=P(15)
"RTN","PSIVOCDS",83,0)
 . I (P(9)["PRN"),'$O(^PS(51.1,"AC","PSJ",P(9),0)) S PSJP15=""
"RTN","PSIVOCDS",84,0)
 . I P(15)="D",(P(11)]"") S $P(PSJP9,"@",2)=P(11)
"RTN","PSIVOCDS",85,0)
 . I P(9)]"" S X=$P($$FRQ^PSSDSAPI(PSJP9,PSJP15,"I"),U)
"RTN","PSIVOCDS",86,0)
 . I X="" S X=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",87,0)
 . S PSJFDB(PSJCNT,"FREQ")=X
"RTN","PSIVOCDS",88,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",89,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",90,0)
 Q
"RTN","PSIVOCDS",91,0)
SINGLE ;Set fields needed for Single Dose type
"RTN","PSIVOCDS",92,0)
 ; Can't get FDB to return correct data for Continuous Infusion /w Single dose so all Continuous will be sent in as Maintenance.
"RTN","PSIVOCDS",93,0)
 I PSJFDB(PSJCNT,"ROUTE")=("CONTINUOUS INFUSION") Q
"RTN","PSIVOCDS",94,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="SINGLE DOSE"
"RTN","PSIVOCDS",95,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",96,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",97,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DOSE_RATE")
"RTN","PSIVOCDS",98,0)
 Q
"RTN","PSIVOCDS",99,0)
COMMON ;Set common data for all IV types
"RTN","PSIVOCDS",100,0)
 S PSJFDB(PSJCNT,"RX_NUM")="I;"_$G(PSJPON)_";PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",101,0)
 S PSJFDB(PSJCNT,"DRUG_IEN")=$P(PSIVAS0,U)
"RTN","PSIVOCDS",102,0)
 S PSJFDB(PSJCNT,"DRUG_NM")=$P(PSIVAS0,U,2)_" "_$P(PSIVAS0,U,3)
"RTN","PSIVOCDS",103,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",104,0)
 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",105,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="MAINTENANCE"
"RTN","PSIVOCDS",106,0)
 S PSJFDB(PSJCNT,"SPECIFIC")=1
"RTN","PSIVOCDS",107,0)
 ;This is set when CPRS sends Duration without entering a solution.
"RTN","PSIVOCDS",108,0)
 I $D(PSJIV("FRQ_ERROR")) S PSJFDB(PSJCNT,"FRQ_ERROR")="",PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",109,0)
 Q
"RTN","PSIVOCDS",110,0)
BASIC ;Set basic data for non schedule IVs
"RTN","PSIVOCDS",111,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",112,0)
 S PSJFDB(PSJCNT,"FREQ")=""
"RTN","PSIVOCDS",113,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",114,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",115,0)
 ; SDA is set to the additive strength or volume of the solution.
"RTN","PSIVOCDS",116,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=$P(PSIVAS0,U,8)
"RTN","PSIVOCDS",117,0)
 Q
"RTN","PSIVOCDS",118,0)
FREEDOSE ;Set data for free text dose
"RTN","PSIVOCDS",119,0)
 ;"GENERAL" info only needed to pass in Dose Route and Dose Type.
"RTN","PSIVOCDS",120,0)
 ;"Exception" node sets here to get the specified error back for free text dosing.
"RTN","PSIVOCDS",121,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",122,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",123,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DOSE_RATE")
"RTN","PSIVOCDS",124,0)
 S PSJFDB(PSJCNT,"INF_ERROR")=""
"RTN","PSIVOCDS",125,0)
 I $G(PSJP8ERR)=2!($G(PSJP8ERR)=4) S PSJFDB(PSJCNT,"WT_ERROR")=""
"RTN","PSIVOCDS",126,0)
 I $G(PSJP8ERR)=3!($G(PSJP8ERR)=4) S PSJFDB(PSJCNT,"HT_ERROR")=""
"RTN","PSIVOCDS",127,0)
 Q
"RTN","PSIVOCDS",128,0)
ONEAD(PSJRT) ;Setup data for 'Continuous Infusion' IV type
"RTN","PSIVOCDS",129,0)
 NEW PSJCLASS,PSJX
"RTN","PSIVOCDS",130,0)
 I $G(PSJRT)=0!($G(PSJRT)="") Q
"RTN","PSIVOCDS",131,0)
 ;Check to make sure the infusion rate is in form of "ml/hr" before applying the calculation
"RTN","PSIVOCDS",132,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",133,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",134,0)
 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",135,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",136,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",137,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",138,0)
 I PSJP8UNT="MILLILITERS",(PSJP8TME="HOUR") D
"RTN","PSIVOCDS",139,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=$$SDACI()
"RTN","PSIVOCDS",140,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",141,0)
 I PSJP8UNT'="MILLILITERS" D
"RTN","PSIVOCDS",142,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",143,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=PSJP8NUM
"RTN","PSIVOCDS",144,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=PSJP8UNT
"RTN","PSIVOCDS",145,0)
 . S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",146,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",147,0)
 Q
"RTN","PSIVOCDS",148,0)
CONTIV ;Set data needed for continuous IV with multiple drugs
"RTN","PSIVOCDS",149,0)
 NEW PSJFREQ,PSJDIFF
"RTN","PSIVOCDS",150,0)
 S PSJDIFF=+$$DURATION()
"RTN","PSIVOCDS",151,0)
 ; Order has duration <24 hrs
"RTN","PSIVOCDS",152,0)
 I PSJDIFF D UND24HRS
"RTN","PSIVOCDS",153,0)
 ; Order has duration >= 24 hrs
"RTN","PSIVOCDS",154,0)
 I 'PSJDIFF S PSJFDB(PSJCNT,"FREQ")=$$IVFREQ
"RTN","PSIVOCDS",155,0)
 ;
"RTN","PSIVOCDS",156,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",157,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",158,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",159,0)
 Q
"RTN","PSIVOCDS",160,0)
ISONEAD() ;Return 1 if there's only one additive
"RTN","PSIVOCDS",161,0)
 NEW X,PSJX
"RTN","PSIVOCDS",162,0)
 I $D(PSIVDDSV("AD")),$D(PSIVDDSV("SOL")) Q 0
"RTN","PSIVOCDS",163,0)
 I $O(PSIVDDSV("SOL",0)) Q 0
"RTN","PSIVOCDS",164,0)
 S PSJX=0
"RTN","PSIVOCDS",165,0)
 F X=0:0 S X=$O(PSIVDDSV("AD",X)) Q:'X  S PSJX=PSJX+1 Q:PSJX>1
"RTN","PSIVOCDS",166,0)
 I PSJX>1 Q 0
"RTN","PSIVOCDS",167,0)
 Q 1
"RTN","PSIVOCDS",168,0)
ISALLBAG() ;Return 1 if not additive not in all bags
"RTN","PSIVOCDS",169,0)
 ;***this call assuming only 1 additive entered in the order
"RTN","PSIVOCDS",170,0)
 NEW X,PSIVAS0
"RTN","PSIVOCDS",171,0)
 S X=$O(PSIVDDSV("AD",0))
"RTN","PSIVOCDS",172,0)
 S PSIVAS0=$G(PSIVDDSV("AD",X))
"RTN","PSIVOCDS",173,0)
 I $P(PSIVAS0,U,4)]"" Q 0
"RTN","PSIVOCDS",174,0)
 Q 1
"RTN","PSIVOCDS",175,0)
ISNOADD() ;Return 1 if there's no additives
"RTN","PSIVOCDS",176,0)
 NEW X,PSJX
"RTN","PSIVOCDS",177,0)
 I $O(PSIVDDSV("AD",0)) Q 0
"RTN","PSIVOCDS",178,0)
 I $D(PSIVDDSV("SOL")) Q 1
"RTN","PSIVOCDS",179,0)
 Q 0
"RTN","PSIVOCDS",180,0)
PREMIX ;The route is always set to "Continuous Infusion" & the FREQUENCY must set to 1
"RTN","PSIVOCDS",181,0)
 NEW X
"RTN","PSIVOCDS",182,0)
 S PSJFDB(PSJCNT,"ROUTE")=$$RTESCRN(PSJRT)
"RTN","PSIVOCDS",183,0)
 I PSJFDB(PSJCNT,"ROUTE")=0 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",184,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",185,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",186,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=PSJP8NUM
"RTN","PSIVOCDS",187,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=PSJP8UNT
"RTN","PSIVOCDS",188,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",189,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",190,0)
 ;PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" now FDB handles both units for this drug.
"RTN","PSIVOCDS",191,0)
 ;S PSJFDB(PSJCNT,"ROUTE")="CONTINUOUS INFUSION"
"RTN","PSIVOCDS",192,0)
 ;I PSJP8UNT="MILLILITERS" S X=$$LITER(PSJP8NUM) I X]"" D
"RTN","PSIVOCDS",193,0)
 ;. S PSJFDB(PSJCNT,"DOSE_AMT")=$P(X,U)
"RTN","PSIVOCDS",194,0)
 ;. S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(X,U,2)
"RTN","PSIVOCDS",195,0)
 Q
"RTN","PSIVOCDS",196,0)
SDACI() ;Return Single Dose Amount for ad for 'CONTINUOUS INFUSION' FDB Route (Not classed at "VT" or "TN")
"RTN","PSIVOCDS",197,0)
 ;Single Dose Amount(PSJSDA):
"RTN","PSIVOCDS",198,0)
 ; For Additive - PSJSDA=(Strength/Tot vol)*Infusion Rate
"RTN","PSIVOCDS",199,0)
 ; If can't calculate then return null
"RTN","PSIVOCDS",200,0)
 NEW PSJSDA,X
"RTN","PSIVOCDS",201,0)
 S PSJSDA=""
"RTN","PSIVOCDS",202,0)
 I $D(PSIVDDSV("AD")) D
"RTN","PSIVOCDS",203,0)
 . S X=+$G(PSIVDDSV("TOT_VOL")) Q:'X
"RTN","PSIVOCDS",204,0)
 . S PSJSDA=($P(PSIVAS0,U,8)/X)*PSJP8NUM
"RTN","PSIVOCDS",205,0)
 I '+PSJSDA S PSJSDA=$P(PSIVAS0,U,8),PSJFDB(PSJCNT,"INF_ERROR")=""
"RTN","PSIVOCDS",206,0)
 Q PSJSDA
"RTN","PSIVOCDS",207,0)
CLASS(PSJDD) ;Check if the Drug contains "VT" & "TN" classes
"RTN","PSIVOCDS",208,0)
 ;Return 1 if "VT" or "TN"
"RTN","PSIVOCDS",209,0)
 ;Return 0 if not
"RTN","PSIVOCDS",210,0)
 Q:'+$G(PSJDD) 0
"RTN","PSIVOCDS",211,0)
 NEW PSJCLASS
"RTN","PSIVOCDS",212,0)
 S PSJCLASS=$P($G(^PSDRUG(+PSJDD,0)),U,2)
"RTN","PSIVOCDS",213,0)
 ;I (PSJCLASS["TN")!(PSJCLASS["VT") Q 1
"RTN","PSIVOCDS",214,0)
 I PSJCLASS["VT" Q 1
"RTN","PSIVOCDS",215,0)
 Q 0
"RTN","PSIVOCDS",216,0)
IVFREQ() ;Return the frequency for an continuous IV
"RTN","PSIVOCDS",217,0)
 ; Hours needed to run a bag is defined as: Total Volume / Infusion rate
"RTN","PSIVOCDS",218,0)
 ; # of bags needed for a day is defined as: 24 / Hours need to run a bag
"RTN","PSIVOCDS",219,0)
 ; PSJFREQ is either in Q#H or N for # of admin per day
"RTN","PSIVOCDS",220,0)
 NEW PSJFREQ,PSJBOT,PSJX,X,PSJTOTBG,PSJTOTBT,PSJTOTV,PSJBAGX
"RTN","PSIVOCDS",221,0)
 S (PSJFREQ,PSJTOTBG,PSJTOTBT)=0
"RTN","PSIVOCDS",222,0)
 S PSJTOTV=+$G(PSIVDDSV("TOT_VOL"))
"RTN","PSIVOCDS",223,0)
 ;CONV^PSSDSAPK converts # of hours to run a bag to either Q#H or n for number of admin per day
"RTN","PSIVOCDS",224,0)
 I +PSJTOTV,PSJP8NUM D
"RTN","PSIVOCDS",225,0)
 . I +PSJTOTV#PSJP8NUM D
"RTN","PSIVOCDS",226,0)
 .. S PSJFDB(PSJCNT,"DOSE_AMT")=$$ADJSDA(+PSJTOTV,PSJP8NUM,+PSJFDB(PSJCNT,"DOSE_AMT"),1)
"RTN","PSIVOCDS",227,0)
 . S PSJBAGX=PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",228,0)
 . I PSJBAGX<1 S PSJFREQ="Q1H"
"RTN","PSIVOCDS",229,0)
 . S:PSJBAGX'<1 PSJFREQ=$$CONV^PSSDSAPK(PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",230,0)
 . S PSJTOTBG=24/(+PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",231,0)
 I PSIVAS="AD" D BOTTLE(PSJTOTBG,$P(PSIVAS0,U,4)) D
"RTN","PSIVOCDS",232,0)
 . I PSJTOTBG<1,'(+PSJTOTV#PSJP8NUM) S PSJFDB(PSJCNT,"DOSE_AMT")=$$ADJSDA(+PSJTOTV,PSJP8NUM,+PSJFDB(PSJCNT,"DOSE_AMT"),0)
"RTN","PSIVOCDS",233,0)
 I PSJFREQ=""!(PSJFREQ=0) S PSJFREQ=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",234,0)
 Q PSJFREQ
"RTN","PSIVOCDS",235,0)
ADJSDA(PSJTOTV,PSJINFRT,PSJSDA,PSJNOTE) ;Adjust SDA
"RTN","PSIVOCDS",236,0)
 NEW PSJBAGX,X,PSJNOTEV
"RTN","PSIVOCDS",237,0)
 I '+$G(PSJTOTV) Q ""
"RTN","PSIVOCDS",238,0)
 I '+$G(PSJINFRT) Q ""
"RTN","PSIVOCDS",239,0)
 I '+$G(PSJSDA) Q ""
"RTN","PSIVOCDS",240,0)
 S (PSJBAGX,X)=+PSJTOTV/PSJINFRT
"RTN","PSIVOCDS",241,0)
 ;**  Removed for MOCHA 2.0 When it takes < 1 hour to run a bag. May need to bring back for MOCHA 2.1 (Daily dose check).
"RTN","PSIVOCDS",242,0)
 ;I PSJBAGX<1 S PSJSDA=PSJSDA/PSJBAGX
"RTN","PSIVOCDS",243,0)
 I PSJBAGX<1 D
"RTN","PSIVOCDS",244,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",245,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",246,0)
 . S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",247,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",248,0)
 I PSJBAGX'<1 D
"RTN","PSIVOCDS",249,0)
 . S X=$J(PSJBAGX,"",0)
"RTN","PSIVOCDS",250,0)
 . S PSJSDA=PSJSDA/(+PSJTOTV)*PSJINFRT*($S(X<24:X,1:24))
"RTN","PSIVOCDS",251,0)
 . S PSJNOTEV=($S(X<24:X,1:24)*PSJINFRT)_" ML over "_$S(X<24:X,1:24)_" hours)."
"RTN","PSIVOCDS",252,0)
 . I $G(PSJNOTE) D
"RTN","PSIVOCDS",253,0)
 .. S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE: The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the nearest whole number of hours ("_PSJNOTEV
"RTN","PSIVOCDS",254,0)
 . I '$G(PSJNOTE) D
"RTN","PSIVOCDS",255,0)
 .. S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE:  The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the duration of the order or 24 hours; whichever is less ("_PSJNOTEV
"RTN","PSIVOCDS",256,0)
 Q PSJSDA
"RTN","PSIVOCDS",257,0)
UND24HRS ;Calculate freq for order <24 hrs
"RTN","PSIVOCDS",258,0)
 NEW PSJTOTV,PSJBAG,PSJMNBAG,PSJTOTBG,PSJFREQ,PSJHRS,X
"RTN","PSIVOCDS",259,0)
 S (PSJFREQ,PSJBAG,PSJMNBAG)=0
"RTN","PSIVOCDS",260,0)
 S PSJTOTV=+$G(PSIVDDSV("TOT_VOL"))
"RTN","PSIVOCDS",261,0)
 I +PSJTOTV,PSJP8NUM D
"RTN","PSIVOCDS",262,0)
 . S PSJHRS=PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",263,0)
 . S PSJMNBAG=PSJHRS*60
"RTN","PSIVOCDS",264,0)
 . S PSJTOTBG=24/PSJHRS
"RTN","PSIVOCDS",265,0)
 I '+PSJMNBAG D  Q
"RTN","PSIVOCDS",266,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",267,0)
 . S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",268,0)
 S:+PSJMNBAG PSJBAG=PSJDIFF/PSJMNBAG
"RTN","PSIVOCDS",269,0)
 ; If the order is for < 24 hrs & Freq < 1 then adjust the SDA & Freq set to 1
"RTN","PSIVOCDS",270,0)
 I PSJBAG<1 D  Q
"RTN","PSIVOCDS",271,0)
 . S X=$J((PSJDIFF/60),"",0)
"RTN","PSIVOCDS",272,0)
 . S PSJNOTEV=($S(X<24:X,1:24)*PSJP8NUM)_" ML over "_$S(X<24:X,1:24)_" hours)."
"RTN","PSIVOCDS",273,0)
 . S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE:  The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the duration of the order or 24 hours; whichever is less ("_PSJNOTEV
"RTN","PSIVOCDS",274,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",275,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=PSJBAG*(PSJFDB(PSJCNT,"DOSE_AMT"))
"RTN","PSIVOCDS",276,0)
 ;
"RTN","PSIVOCDS",277,0)
 S PSJFREQ=$J(PSJBAG,"",0)
"RTN","PSIVOCDS",278,0)
 I PSIVAS="AD" D BOTTLE(PSJFREQ,$P(PSIVAS0,U,4))
"RTN","PSIVOCDS",279,0)
 S PSJFDB(PSJCNT,"FREQ")=PSJFREQ
"RTN","PSIVOCDS",280,0)
 Q
"RTN","PSIVOCDS",281,0)
 ;
"RTN","PSIVOCDS",282,0)
BOTTLE(PSJTOTBG,PSJBOT) ;Set freq to either specified bottle or # needed for the duration/24hrs of the order
"RTN","PSIVOCDS",283,0)
 NEW PSJTOTBT,X,PSJX
"RTN","PSIVOCDS",284,0)
 Q:'+$G(PSJTOTBG)
"RTN","PSIVOCDS",285,0)
 ;
"RTN","PSIVOCDS",286,0)
 ;PSJ*5*252 - ADJSDA already adjusted the SDA so recal SDA is not needed
"RTN","PSIVOCDS",287,0)
 I PSJTOTBG<1 S PSJFREQ=1 Q
"RTN","PSIVOCDS",288,0)
 Q:$G(PSJBOT)=""
"RTN","PSIVOCDS",289,0)
 S PSJTOTBT=0
"RTN","PSIVOCDS",290,0)
 F X=1:1:$L(PSJBOT,",") S PSJX=$P(PSJBOT,",",X) S:+PSJX PSJTOTBT=PSJTOTBT+1
"RTN","PSIVOCDS",291,0)
 S PSJFREQ=$S(PSJTOTBT>PSJTOTBG:PSJTOTBG,1:PSJTOTBT)
"RTN","PSIVOCDS",292,0)
 I PSJTOTV#PSJP8NUM,(PSJTOTBT>PSJTOTBG) D
"RTN","PSIVOCDS",293,0)
 . S PSJFREQ=$$CONV^PSSDSAPK(PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",294,0)
 I PSJFREQ=0 S PSJFREQ=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",295,0)
 Q
"RTN","PSIVOCDS",296,0)
DURATION() ;
"RTN","PSIVOCDS",297,0)
 ;If PSJIV("DUR") is passed in from CPRS then return the minutes if <1440 otherwise return ""
"RTN","PSIVOCDS",298,0)
 ;If not call from CPRS then calculate from start, stop date
"RTN","PSIVOCDS",299,0)
 NEW PSJX,X,PSJP8X
"RTN","PSIVOCDS",300,0)
 S PSJX=""
"RTN","PSIVOCDS",301,0)
 I +$G(PSJIV("DUR")) D  Q X
"RTN","PSIVOCDS",302,0)
 .S PSJX=+$G(PSJIV("DUR"))
"RTN","PSIVOCDS",303,0)
 .S X=$S(PSJX<1440:PSJX,1:"")
"RTN","PSIVOCDS",304,0)
 I +$G(PSJIV("TOT_VOL")) D  Q X
"RTN","PSIVOCDS",305,0)
 . S PSJP8X=$S(+$G(PSJP8NUM):PSJP8NUM,+P(8):+P(8),1:0)
"RTN","PSIVOCDS",306,0)
 . S:PSJP8X PSJX=(+PSJIV("TOT_VOL")/PSJP8X)*60
"RTN","PSIVOCDS",307,0)
 . S X=$S(PSJX<1440:PSJX,1:"")
"RTN","PSIVOCDS",308,0)
 S X=$$DURATION^PSJOCDS($G(P(2)),$G(P(3)))
"RTN","PSIVOCDS",309,0)
 Q X
"RTN","PSIVOCDS",310,0)
FDBRT(PSJDD,PSJRT) ;Check if the ordered route can be admin by FDB for this drug
"RTN","PSIVOCDS",311,0)
 ;PSJDD = Drug IEN
"RTN","PSIVOCDS",312,0)
 ;PSJRT = FDB continuous dose route (ordered MR -> Standard RT ->FDB cont. Rt)
"RTN","PSIVOCDS",313,0)
 ;Return 1 if the route can admin by FDB; 0 if this route is not specify for this drug
"RTN","PSIVOCDS",314,0)
 NEW PSJFDBRT
"RTN","PSIVOCDS",315,0)
 I '+$G(PSJDD)!$G(PSJRT)="" Q 0
"RTN","PSIVOCDS",316,0)
 D GROUTE^PSSFDBRT(PSJDD,.PSJFDBRT)
"RTN","PSIVOCDS",317,0)
 I +$G(PSJFDBRT(0))=-1 Q 1
"RTN","PSIVOCDS",318,0)
 I $D(PSJFDBRT(PSJRT)) Q 1
"RTN","PSIVOCDS",319,0)
 Q 0
"RTN","PSIVOCDS",320,0)
RTESCRN(PSJRT) ; Screen routes for none "VT or "TN"
"RTN","PSIVOCDS",321,0)
 ;Return 0 or FDB continuous dose route if the standard route(mapped to the ordered MR) is one of the six below.
"RTN","PSIVOCDS",322,0)
 ;PSJRT - standard route
"RTN","PSIVOCDS",323,0)
 I $G(PSJRT)="" Q 0
"RTN","PSIVOCDS",324,0)
 I PSJRT="EPIDURAL" Q "CONTINUOUS EPIDURAL"
"RTN","PSIVOCDS",325,0)
 I PSJRT="INTRA-ARTERIAL" Q "CONT INTRAARTER INF"
"RTN","PSIVOCDS",326,0)
 I PSJRT="INFILTRATION" Q "CONTINUOUS INFILTRAT"
"RTN","PSIVOCDS",327,0)
 I PSJRT="INTRACAUDAL" Q "CONT CAUDAL INFUSION"
"RTN","PSIVOCDS",328,0)
 I PSJRT="INTRAOSSEOUS" Q "CONT INTRAOSSEOUS"
"RTN","PSIVOCDS",329,0)
 I PSJRT="INTRATHECAL" Q "CONT INTRATHECAL INF"
"RTN","PSIVOCDS",330,0)
 I PSJRT="INTRAVENOUS" Q "CONTINUOUS INFUSION"
"RTN","PSIVOCDS",331,0)
 I PSJRT="NEBULIZATION" Q "CONT NEBULIZATION"
"RTN","PSIVOCDS",332,0)
 I PSJRT="SUBCUTANEOUS" Q "CONT SUBCUTAN INFUSI"
"RTN","PSIVOCDS",333,0)
 Q 0
"RTN","PSIVOCDS",334,0)
LITER(PSJVOLP8) ; Convert the unit from ML to L for premix contains potassium
"RTN","PSIVOCDS",335,0)
 ; PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" for this drug now that FDB handles both units.
"RTN","PSIVOCDS",336,0)
 ; FDB only accept Liter for this type for drug
"RTN","PSIVOCDS",337,0)
 ; PSJVOLP8 - Either = volume or the infusion rate
"RTN","PSIVOCDS",338,0)
 NEW PSJVAGEN,PSJSDA,PSJUNIT
"RTN","PSIVOCDS",339,0)
 Q:$G(PSJVOLP8)=""
"RTN","PSIVOCDS",340,0)
 S PSJVAGEN=$$VAGEN^PSJMISC($P(PSIVAS0,U))
"RTN","PSIVOCDS",341,0)
 I PSJVAGEN["POTASSIUM" D
"RTN","PSIVOCDS",342,0)
 . S PSJSDA=+(PSJVOLP8/1000)
"RTN","PSIVOCDS",343,0)
 . S PSJUNIT="L"
"RTN","PSIVOCDS",344,0)
 I '+$G(PSJSDA)!($G(PSJUNIT)="") Q ""
"RTN","PSIVOCDS",345,0)
 Q PSJSDA_U_PSJUNIT
"RTN","PSIVORC2")
0^47^B59663678
"RTN","PSIVORC2",1,0)
PSIVORC2 ;BIR/MLM-PROCESS INCOMPLETE IV ORDER - CONT ;22 OCT 97 / 3:16 PM
"RTN","PSIVORC2",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**29,49,50,65,58,85,101,110,127,151,181,267,275,257**;16 DEC 97;Build 105
"RTN","PSIVORC2",3,0)
 ;
"RTN","PSIVORC2",4,0)
 ; Reference to ^ORD(101 is supported by DBIA #872
"RTN","PSIVORC2",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178
"RTN","PSIVORC2",6,0)
 ; Reference to ^PS(55 is supported by DBIA #2191
"RTN","PSIVORC2",7,0)
 ; Reference to ^PS(52.6 is supported by DBIA #1231.
"RTN","PSIVORC2",8,0)
 ; Reference to ^PS(52.7 is supported by DBIA #2173.
"RTN","PSIVORC2",9,0)
 ; Reference to EN1^ORCFLAG is supported by DBIA #3620.
"RTN","PSIVORC2",10,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVORC2",11,0)
 ;
"RTN","PSIVORC2",12,0)
EDCHK ;Update or create new order in 55.
"RTN","PSIVORC2",13,0)
 D CKORD D:'$G(PSJIVORF) ORPARM^PSIVOREN I 'PSJIVORF W !,"Either the Inpatient Medications or the IV Medications package is not on, please check the Order Parameters file" Q
"RTN","PSIVORC2",14,0)
 I PSIVCHG,PSJIVORF D NATURE^PSIVOREN I '$D(P("NAT")) W $C(7),"Order unchanged" Q
"RTN","PSIVORC2",15,0)
 S:PSIVCHG P("21FLG")=""
"RTN","PSIVORC2",16,0)
 I $G(PSJCOM) D IV^PSJCOMV Q
"RTN","PSIVORC2",17,0)
 Q:$$NONVF()
"RTN","PSIVORC2",18,0)
ACTIVE ;
"RTN","PSIVORC2",19,0)
 S PSJCOM=P("PRNTON")
"RTN","PSIVORC2",20,0)
 I PSJCOM D VFYIV^PSJCOMV Q
"RTN","PSIVORC2",21,0)
 S P("RES")=$P($G(^PS(53.1,+ON,0)),U,24)
"RTN","PSIVORC2",22,0)
 I P("RES")="R" S P("NEWON")=P("OLDON") S PSJOSTOP="" D
"RTN","PSIVORC2",23,0)
 .N PSJTROPI,PSJNVO S PSJNVO=$G(P("NEWON")) I (PSJNVO["P") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO) Q
"RTN","PSIVORC2",24,0)
 .I ($G(P("PON"))["P"),($G(ON55)=P("PON")) S PSJNVO=P("PON") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO)
"RTN","PSIVORC2",25,0)
 .I $G(P("NEWON")) D FILEOPI^PSJBCMA5(DFN,P("NEWON")) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,P("NEWON"))
"RTN","PSIVORC2",26,0)
 .D RUPDATE^PSIVOREN(DFN,ON,P(2)) I $P($G(^PS(53.45,+$G(PSJSYSP),6,0)),"^",3)
"RTN","PSIVORC2",27,0)
 I P("RES")'="R" S PSJORD=ON,P(17)="A",ORSTS=6,PSJORNP=P(6) D SETNEW^PSIVORFB S P("NEWON")=ON55 D @$S(PSIVCHG:"NEWORD",1:"OLDORD")
"RTN","PSIVORC2",28,0)
 I $G(PSJIOPIV) D MVOPI^PSJBCMA5($G(DFN),$G(PSJORD),$G(ON55)),MVOPIAL^PSJBCMA5($G(DFN),$G(PSJORD),$G(ON55))
"RTN","PSIVORC2",29,0)
 S (ON55,ON)=P("NEWON"),OD=P(2) D EN^PSIVORE
"RTN","PSIVORC2",30,0)
 D CIMOI^PSJIMO1(DFN,ON55,"",$G(PSJORD))
"RTN","PSIVORC2",31,0)
 D VF1^PSJLIACT("F","ORDER VERIFIED BY ",1)
"RTN","PSIVORC2",32,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"N")
"RTN","PSIVORC2",33,0)
 I $G(^PS(55,DFN,"IV",+ON55,4)) D EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSIVORC2",34,0)
 L -^PS(53.1,+$G(PSJORD)) L -^PS(55,DFN,"IV",+ON55)
"RTN","PSIVORC2",35,0)
 Q
"RTN","PSIVORC2",36,0)
 ;
"RTN","PSIVORC2",37,0)
CKORD ;Check if new order is to be created.
"RTN","PSIVORC2",38,0)
 I $G(PSIVCOPY) S PSIVCHG=0 Q
"RTN","PSIVORC2",39,0)
 N ND,PSJCHG S PSIVCHG=0,ND(0)=$G(^PS(53.1,+ON,0)),ND("PD")=$G(^PS(53.1,+ON,.2))_U_$P(ND(0),U,3)
"RTN","PSIVORC2",40,0)
 N X S X=$P($G(^PS(53.1,+ON,8)),U,5),X=$S(P(8)["@":$P(X,"@"),1:X)
"RTN","PSIVORC2",41,0)
 S ND=$S($E(P("OT"))="I":P(8)_U_$P(ND(0),U,3)_U_+$P(ND("PD"),U),1:X_U_+P("MR")_U_+P("PD"))
"RTN","PSIVORC2",42,0)
 S ND=ND_U_$S($P(ND(0),U,2)=+P("CLRK"):+$P(ND(0),U,2),1:+P(6))
"RTN","PSIVORC2",43,0)
 I ND'=($S($E(P("OT"))="I":P(8),P(8)["@":$P(P(8),"@"),1:P(8))_U_+P("MR")_U_+P("PD")_U_+P(6)) S PSIVCHG=1
"RTN","PSIVORC2",44,0)
 I 'PSIVCHG I $P($G(^PS(53.1,+ON,2)),U)'=P(9) S:($G(P("DTYP"))'=1) PSIVDSFG=1 S PSIVCHG=1
"RTN","PSIVORC2",45,0)
 N ND,TDRG,TMPDRG
"RTN","PSIVORC2",46,0)
 Q:PSIVCHG
"RTN","PSIVORC2",47,0)
 D TMPDRG1^PSJMISC(DFN,$G(ON),.TMPDRG)
"RTN","PSIVORC2",48,0)
 I $$COMPARE^PSJMISC(.DRG,.TMPDRG,$S(P("DTYP")=1:0,1:1)) S PSIVCHG=1
"RTN","PSIVORC2",49,0)
 K TMPDRG
"RTN","PSIVORC2",50,0)
 Q:PSIVCHG
"RTN","PSIVORC2",51,0)
 Q
"RTN","PSIVORC2",52,0)
CKPC ;
"RTN","PSIVORC2",53,0)
 ;PSJ*5*181 Note - No longer use by *181
"RTN","PSIVORC2",54,0)
 ;
"RTN","PSIVORC2",55,0)
 Q:PSIVCHG  I $E(P("OT"))'="I" D
"RTN","PSIVORC2",56,0)
 .;
"RTN","PSIVORC2",57,0)
 .; Check IV drugs for changes.
"RTN","PSIVORC2",58,0)
 .S DNE=0 F DRGT="AD","SOL" I $D(DRG(DRGT)) S FIL="52."_$S(DRGT="AD":6,1:7) D
"RTN","PSIVORC2",59,0)
 ..N ND,TDRG F DRGI=0:0 S DRGI=$O(DRG(DRGT,DRGI)) Q:'DRGI!DNE  S TDRG(+$P(DRG(DRGT,DRGI),U),DRGI)=DRGI,TDRG("CNT")=+$G(TDRG("CNT"))+1
"RTN","PSIVORC2",60,0)
 ..F ON1=0:0 S ON1=$O(^PS(53.1,+ON,DRGT,ON1)) Q:'+ON1!DNE  S ND=$G(^PS(53.1,+ON,DRGT,ON1,0)),ND("CNT")=$G(ND("CNT"))+1 D
"RTN","PSIVORC2",61,0)
 ...S DRG=+$P(ND,U) S:'$D(TDRG(+DRG)) (DNE,PSIVCHG)=1 F DRGI=0:0 S DRGI=$O(TDRG(+DRG,DRGI)) Q:'DRGI!DNE  I $P($G(DRG(DRGT,DRGI)),U)_U_$P($G(DRG(DRGT,DRGI)),U,3)'=$P(ND,U,1,2) S (DNE,PSIVCHG)=1
"RTN","PSIVORC2",62,0)
 ..S:$G(ND("CNT"))'=$G(TDRG("CNT")) (DNE,PSIVCHG)=1 K ND,TDRG
"RTN","PSIVORC2",63,0)
 Q
"RTN","PSIVORC2",64,0)
 ;
"RTN","PSIVORC2",65,0)
OLDORD ; Update old order, update order links.
"RTN","PSIVORC2",66,0)
 Q:P("RES")="R"
"RTN","PSIVORC2",67,0)
 S P("OLDON")=$P($G(^PS(53.1,+ON,0)),U,25) I P("OLDON")'=ON55 S $P(^PS(55,DFN,"IV",+ON55,2),U,8)=P("RES"),$P(^(2),U,5)=P("OLDON") I P("OLDON") D
"RTN","PSIVORC2",68,0)
 .I P("OLDON")["V",$D(^PS(55,DFN,"IV",+P("OLDON"),0)) S $P(^(2),U,6)=ON55,$P(^(2),U,9)=P("RES")
"RTN","PSIVORC2",69,0)
 .I P("OLDON")["A",$D(^PS(55,DFN,5,+P("OLDON"),0)) S $P(^(0),U,26,27)=ON55_U_P("RES")
"RTN","PSIVORC2",70,0)
 .I $S(P("OLDON")["P":1,P("OLDON")["N":1,1:0),$D(^PS(53.1,+P("OLDON"),0)) S $P(^(0),U,26,27)=ON55_U_P("RES")
"RTN","PSIVORC2",71,0)
 D PUT531^PSIVORFA S $P(^PS(53.1,+ON,0),U,25,26)="^",ON=ON55 D UPD100^PSIVORFA
"RTN","PSIVORC2",72,0)
 Q
"RTN","PSIVORC2",73,0)
 ;
"RTN","PSIVORC2",74,0)
NEWORD ; Create new order, update order links.
"RTN","PSIVORC2",75,0)
 Q:P("RES")="R"
"RTN","PSIVORC2",76,0)
 S $P(^PS(53.1,+ON,0),U,26,27)=P("NEWON")_U_"E",PSIVAC="CE",PSJORNAT=P("NAT") D DC^PSIVORA
"RTN","PSIVORC2",77,0)
 S P("NEWON")=$P($G(^PS(53.1,+PSJORD,0)),U,26),$P(^PS(55,DFN,"IV",+P("NEWON"),2),U,5)=PSJORD,$P(^(2),U,8)="E",ON=ON55
"RTN","PSIVORC2",78,0)
 I PSJIVORF D EN1^PSJHL2(DFN,"SN",+ON55_"V","NEW ORDER CREATED")
"RTN","PSIVORC2",79,0)
 Q
"RTN","PSIVORC2",80,0)
 ;
"RTN","PSIVORC2",81,0)
GTIVDRG ; Try to find an IV drug from the Orderable Item.
"RTN","PSIVORC2",82,0)
 ; If there is only 1 match to OI then stuff in DRG otherwise prompt user to select which
"RTN","PSIVORC2",83,0)
 ; ad/sol matched to OI
"RTN","PSIVORC2",84,0)
 K PSIVOI NEW FIL,ND,SCR,PSJNOW
"RTN","PSIVORC2",85,0)
 D NOW^%DTC S PSJNOW=%
"RTN","PSIVORC2",86,0)
 S SCR("S")="S ND=$P($G(^(""I"")),U) I ND=""""!(ND>PSJNOW)"
"RTN","PSIVORC2",87,0)
 F FIL=52.6,52.7 D FIND^DIC(FIL,,"@;.01;2","QXP",+P("PD"),,"AOI",SCR("S"),,"PSIVOI") I +PSIVOI("DILIST",0)>0 D  Q
"RTN","PSIVORC2",88,0)
 . S DRGT=$S(FIL=52.6:"AD",1:"SOL"),PSIVOI=DRGT
"RTN","PSIVORC2",89,0)
 . I PSIVOI="AD" D
"RTN","PSIVORC2",90,0)
 .. N XX,XXX,QC S XX=0 F  S XX=$O(PSIVOI("DILIST",XX)) Q:XX=""  S XXX=+PSIVOI("DILIST",XX,0) D LIST^DIC(52.61,","_XXX_",","@;.01","PQ",,,,,,,"PSIVQC") D
"RTN","PSIVORC2",91,0)
 ... I +$G(PSIVQC("DILIST",0))>0 S QC=0 F  S QC=$O(PSIVQC("DILIST",QC)) Q:QC=""  S PSIVOI("DILIST",XX,QC,0)=PSIVQC("DILIST",QC,0)
"RTN","PSIVORC2",92,0)
 ... K PSIVQC("DILIST",0),PSIVQC("DILIST",0,"MAP")
"RTN","PSIVORC2",93,0)
 .. D RESET
"RTN","PSIVORC2",94,0)
 . I +PSIVOI("DILIST",0)=1 D
"RTN","PSIVORC2",95,0)
 .. S DRG=+PSIVOI("DILIST",1,0)
"RTN","PSIVORC2",96,0)
 .. S DNE=1,DRG(DRGT,0)=1,ND=$G(^PS(FIL,+DRG,0)),DRG(DRGT,1)=+DRG_U_$P(ND,U)_U_$S(FIL=52.7:$P(ND,U,3),1:"")_U_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSIVORC2",97,0)
 K:+PSIVOI("DILIST",0)<2 PSIVOI
"RTN","PSIVORC2",98,0)
 Q
"RTN","PSIVORC2",99,0)
 ;
"RTN","PSIVORC2",100,0)
EDIT ; Edit incomplete order
"RTN","PSIVORC2",101,0)
 K PSIVENO
"RTN","PSIVORC2",102,0)
 S PSIVAC="CE"
"RTN","PSIVORC2",103,0)
 I $E(P("OT"))="I",'$D(DRG("AD")),('$D(DRG("SOL"))) D GTIVDRG
"RTN","PSIVORC2",104,0)
 I P(4)="" D 53^PSIVORC1 Q:P(4)=""  D ^PSIVORV2
"RTN","PSIVORC2",105,0)
 D GSTRING^PSIVORE1,GTFLDS^PSIVORFE ;S (PSIVOK,EDIT)="57^58^59^3"_$S(P("DTYP")=1:"^26^39",1:"")_"^63^64^"_$S($E(P("OT"))="I":"101^109^",1:"")_"10^25"_$S(+P(6)'=+P("CLRK"):"^1",1:"") D GTFLDS^PSIVORFE
"RTN","PSIVORC2",106,0)
 Q:$G(DONE)
"RTN","PSIVORC2",107,0)
 I '$G(PSIVENO) S PSIVENO=1 D EN^VALM("PSJ LM IV AC/EDIT") S VALMBCK="Q"
"RTN","PSIVORC2",108,0)
 Q
"RTN","PSIVORC2",109,0)
 ;
"RTN","PSIVORC2",110,0)
FINISH ; Ask only for missing data in incomplete IV order.
"RTN","PSIVORC2",111,0)
 S P("OPI")=$$ENPC^PSJUTL("V",+PSIVUP,60,P("OPI")) I $E(P("OT"))="I",'$D(DRG("AD")),('$D(DRG("SOL"))) S DNE=0 D GTIVDRG
"RTN","PSIVORC2",112,0)
 D:P(4)="" 53^PSIVORC1 Q:P(4)=""  S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSIVORC2",113,0)
 I 'P(2) D ENT^PSIVCAL K %DT S X=P(2),%DT="RTX" D ^%DT S P(2)=+Y
"RTN","PSIVORC2",114,0)
 I 'P(3) D ENSTOP^PSIVCAL K %DT S X=P(3),%DT="RTX" D ^%DT S P(3)=+Y
"RTN","PSIVORC2",115,0)
 I 'P("MR") S P("MR")=$O(^PS(51.2,"B","INTRAVENOUS",0))_"^IV"
"RTN","PSIVORC2",116,0)
 S PSIVOK="1^3^10^25^26^39^57^58^59^63^64" D CKFLDS^PSIVORC1 D:EDIT]"" EDIT^PSIVEDT G COMPLTE^PSIVORC1
"RTN","PSIVORC2",117,0)
 Q
"RTN","PSIVORC2",118,0)
NONVF() ; Updated 53.1 status to non-verified after finish.
"RTN","PSIVORC2",119,0)
 NEW PSGOEAV S PSGOEAV=+$P(PSJSYSP0,U,9)
"RTN","PSIVORC2",120,0)
 I +PSJSYSU=3,PSGOEAV Q 0
"RTN","PSIVORC2",121,0)
 I +PSJSYSU=1,PSGOEAV Q 0
"RTN","PSIVORC2",122,0)
 I PSIVCHG D NWNONVF Q 1
"RTN","PSIVORC2",123,0)
 S P(17)="N",P("REN")=0
"RTN","PSIVORC2",124,0)
 D GTPD^PSIVORE2
"RTN","PSIVORC2",125,0)
 W !,"...transcribing this non-verified order...."
"RTN","PSIVORC2",126,0)
 S $P(^PS(53.1,+ON,.2),U)=""
"RTN","PSIVORC2",127,0)
 D PUT531^PSIVORFA
"RTN","PSIVORC2",128,0)
 D NEWNVAL^PSGAL5(ON,$S(+PSJSYSU=1:22000,+PSJSYSU=3:22005,1:22006),"","")
"RTN","PSIVORC2",129,0)
 I ($G(PSJINFIN)=2) D NEWNVAL^PSGAL5(ON,6000,"OTHER PRINT INFO")
"RTN","PSIVORC2",130,0)
 NEW PSIVORFA S PSIVORFA=1 D:ON["V" DEL55^PSIVORE2
"RTN","PSIVORC2",131,0)
 D EN1^PSJHL2(DFN,"XX",ON,"UPDATED ORDER")
"RTN","PSIVORC2",132,0)
 D VF
"RTN","PSIVORC2",133,0)
 Q 1
"RTN","PSIVORC2",134,0)
NWNONVF ;Create non-verified due to edit
"RTN","PSIVORC2",135,0)
 K DA D ENGNN^PSGOETO S P("NEWON")=DA_"P",P(17)="N",P("REN")=0
"RTN","PSIVORC2",136,0)
 I $D(^PS(53.45,PSJSYSP,6,1)) D FILEOPI^PSJBCMA5(DFN,P("NEWON"))
"RTN","PSIVORC2",137,0)
 S PSJORD=ON,$P(^PS(53.1,+ON,0),U,26,27)=P("NEWON")_U_"E",PSIVAC="CE",PSJORNAT=P("NAT") D DC^PSIVORA
"RTN","PSIVORC2",138,0)
 S P("OLDON")=ON,ON=P("NEWON")
"RTN","PSIVORC2",139,0)
 I $D(^PS(53.1,+P("OLDON"),12)) M ^PS(53.1,+P("NEWON"),12)=^PS(53.1,+P("OLDON"),12)
"RTN","PSIVORC2",140,0)
 S P("RES")="E"
"RTN","PSIVORC2",141,0)
 S P("DO")="" D GTPD^PSIVORE2 ;Get dosage order if not defined for IPM IV
"RTN","PSIVORC2",142,0)
 D PUT531^PSIVORFA
"RTN","PSIVORC2",143,0)
 S $P(^PS(53.1,+ON,0),U,25,26)=P("OLDON")_U_""
"RTN","PSIVORC2",144,0)
 D NEWNVAL^PSGAL5(ON,$S(+PSJSYSU=1:22000,+PSJSYSU=3:22005,1:22006),"","")
"RTN","PSIVORC2",145,0)
 D EN1^PSJHL2(DFN,"SN",ON,"SEND ORDER NUMBER")
"RTN","PSIVORC2",146,0)
 S:$D(PSGP)#10 PSJNOL=$$LS^PSSLOCK(PSGP,ON)
"RTN","PSIVORC2",147,0)
 D VF
"RTN","PSIVORC2",148,0)
 Q
"RTN","PSIVORC2",149,0)
VF ; Display Verify screen
"RTN","PSIVORC2",150,0)
 Q:ON'["P"
"RTN","PSIVORC2",151,0)
 K PSJIVBD
"RTN","PSIVORC2",152,0)
 D GT531^PSIVORFA(DFN,ON)
"RTN","PSIVORC2",153,0)
 S PSGACT="EL"
"RTN","PSIVORC2",154,0)
 I P(17)="N",(P("OLDON")=""),(+P("CLRK")=DUZ) S PSGACT="ELD"
"RTN","PSIVORC2",155,0)
 I +PSJSYSU=3!(+PSJSYSU=1) S PSGACT="DELV"
"RTN","PSIVORC2",156,0)
 I +PSJSYSU=3,$L($T(EN1^ORCFLAG)) S PSGACT=PSGACT_"G"
"RTN","PSIVORC2",157,0)
 I P("OT")="I" S PSJSTAR="(1)^(5)^(7)^(9)^(10)"
"RTN","PSIVORC2",158,0)
 I P("OT")'="I" S PSJSTAR="(1)^(2)^(3)^(5)^(7)^(9)"
"RTN","PSIVORC2",159,0)
 D EN^VALM("PSJ LM IV INPT ACTIVE")
"RTN","PSIVORC2",160,0)
 Q
"RTN","PSIVORC2",161,0)
 ;
"RTN","PSIVORC2",162,0)
RESET ;Reset PSIVOI("DILIST") for additives with quick codes
"RTN","PSIVORC2",163,0)
 N XX,XXX,CNT S CNT=0
"RTN","PSIVORC2",164,0)
 S XX=0 F  S XX=$O(PSIVOI("DILIST",XX)) Q:XX=""  S CNT=CNT+1,LYN(CNT)=PSIVOI("DILIST",XX,0) D
"RTN","PSIVORC2",165,0)
 . S XXX=0 F  S XXX=$O(PSIVOI("DILIST",XX,XXX)) Q:XXX=""  S CNT=CNT+1,LYN(CNT)=$P(PSIVOI("DILIST",XX,0),"^")_"^"_$P(PSIVOI("DILIST",XX,XXX,0),"^",2)_"^"_$P(PSIVOI("DILIST",XX,XXX,0),"^")_"^"_"QC"
"RTN","PSIVORC2",166,0)
 K PSIVOI("DILIST")
"RTN","PSIVORC2",167,0)
 S PSIVOI("DILIST",0)=CNT_"^*^0^"
"RTN","PSIVORC2",168,0)
 S XX=0 F  S XX=$O(LYN(XX)) Q:'XX  S PSIVOI("DILIST",XX,0)=LYN(XX)
"RTN","PSIVORC2",169,0)
 K LYN
"RTN","PSIVORC2",170,0)
 Q
"RTN","PSIVORFB")
0^42^B83657459
"RTN","PSIVORFB",1,0)
PSIVORFB ;BIR/MLM-FILE/RETRIEVE ORDERS IN ^PS(55 ;25 Sep 98 / 2:24 PM
"RTN","PSIVORFB",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**3,18,28,68,58,85,110,111,120,134,213,161,181,273,267,257**;16 DEC 97;Build 105
"RTN","PSIVORFB",3,0)
 ;
"RTN","PSIVORFB",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSIVORFB",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178.
"RTN","PSIVORFB",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA #1231.
"RTN","PSIVORFB",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA #2173.
"RTN","PSIVORFB",8,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSIVORFB",9,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177.
"RTN","PSIVORFB",10,0)
 ; Reference to ^PSUHL is supported by DBIA #4803.
"RTN","PSIVORFB",11,0)
 ; 
"RTN","PSIVORFB",12,0)
NEW55 ; Get new order number in 55.
"RTN","PSIVORFB",13,0)
 N DA,DD,DO,DIC,DLAYGO,X,Y,PSIVLIM,MINS,PSJDSTP1,PSJDSTP2,A,PSJCLIN,PSJDNM,PSJPROV,PSJWARD,PSJPAO,PSJALRT
"RTN","PSIVORFB",14,0)
 I ($G(PSIVAC)="PN"),$G(PSJSYSP) D KILL^PSJBCMA5(+$G(PSJSYSP))
"RTN","PSIVORFB",15,0)
 I $D(^PS(55,+DFN)),'$D(^PS(55,+DFN,0)) D ENSET0^PSGNE3(+DFN)
"RTN","PSIVORFB",16,0)
 ;*273 - Set PSIVSITE if not set.
"RTN","PSIVORFB",17,0)
 I $G(PSJORD)["V"!($G(PSJORD)["P"),$G(P(2))]"" D
"RTN","PSIVORFB",18,0)
 . I '$G(PSIVSITE) S PSIVSN=$P(P("IVRM"),"^") D ENCHK^PSIVSET
"RTN","PSIVORFB",19,0)
 . D LIMSTOP(.PSJDSTP1,.PSJDSTP2)
"RTN","PSIVORFB",20,0)
 I ($G(PSJORD)["P"!($G(PSJORD)["V"))&$G(PSIVLIM) I $$CMPLIM(PSJORD,PSJDSTP1,PSJDSTP2) D
"RTN","PSIVORFB",21,0)
 . D
"RTN","PSIVORFB",22,0)
 .. S PSJPROV=DUZ I PSJORD["P" S PSJPROV=$P($G(^PS(53.1,+PSJORD,0)),"^",2)
"RTN","PSIVORFB",23,0)
 .. I PSJORD["V" S PSJPROV=$P($G(^PS(55,DFN,"IV",+PSJORD,0)),"^",6)
"RTN","PSIVORFB",24,0)
 .. D NOW^%DTC S XQA(PSJPROV)="",XQAID="PSJ,"_DFN_";"_PSJPROV_";"_%,XQADATA=""
"RTN","PSIVORFB",25,0)
 .. D
"RTN","PSIVORFB",26,0)
 ... I PSJORD["P" S A=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSIVORFB",27,0)
 ... I PSJORD["V" S A=$G(^PS(55,PSGP,"IV",+PSJORD,"DSS"))
"RTN","PSIVORFB",28,0)
 ... S PSJCLIN=$P(A,"^") I PSJCLIN]"" S PSJCLIN=$P(^SC(PSJCLIN,0),"^")
"RTN","PSIVORFB",29,0)
 .. S A=$G(^DPT(DFN,0)),PSJWARD=$G(^(.1))
"RTN","PSIVORFB",30,0)
 .. S XQAMSG=$P(A,"^")_" ("_$E($P(A,"^"))_$E($P(A,"^",9),6,9)_"): ["_$S(PSJWARD]"":$E(PSJWARD,1,10),$G(PSJCLIN)]"":$E(PSJCLIN,1,10),1:"UNKNOWN")_"] "
"RTN","PSIVORFB",31,0)
 .. S A=$O(DRG("AD",0)) I A]"" S A=DRG("AD",A)
"RTN","PSIVORFB",32,0)
 .. I A="" S A=$O(DRG("SOL",0)) I A]"" S A=DRG("SOL",A)
"RTN","PSIVORFB",33,0)
 .. S PSJDNM=$P(^PS(50.7,+$P(A,"^",6),0),"^")
"RTN","PSIVORFB",34,0)
 .. S XQAMSG=XQAMSG_PSJDNM_" your DURATION not used for stop date/time"
"RTN","PSIVORFB",35,0)
 .. D SETUP^XQALERT
"RTN","PSIVORFB",36,0)
 .. S PSJALRT=$$FMTDUR^PSJLIVMD($S(PSJORD["P":$P($G(^PS(53.1,+PSJORD,2.5)),"^",4),PSJORD["IV":$P($G(^PS(55,DFN,"IV",+PSJORD,2.5)),"^",4),1:"UNK"))
"RTN","PSIVORFB",37,0)
 S DIC="^PS(55,",DIC(0)="LN",DLAYGO=55,(DINUM,X)=+DFN D ^DIC Q:Y<0
"RTN","PSIVORFB",38,0)
LOCK0 F  L +^PS(55,DFN,"IV",0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSIVORFB",39,0)
 S ND=$S($D(^PS(55,DFN,"IV",0)):^(0),1:"^55.01") F DA=$P(ND,"^",3)+1:1 W "." I '$D(^PS(55,DFN,"IV",DA)) S $P(ND,"^",3)=DA,$P(ND,"^",4)=$P(ND,"^",4)+1,^PS(55,DFN,"IV",0)=ND Q
"RTN","PSIVORFB",40,0)
 L +^PS(55,DFN,"IV",+DA):$S($G(DILOCKTM)>0:DILOCKTM,1:3) E  G LOCK0
"RTN","PSIVORFB",41,0)
 S ^PS(55,DFN,"IV",+DA,0)=+DA,^PS(55,DFN,"IV","B",+DA,+DA)=""
"RTN","PSIVORFB",42,0)
 L -^PS(55,DFN,"IV",0) S ON55=+DA_"V"
"RTN","PSIVORFB",43,0)
 I $G(PSJALRT)]"" S PSIVAL="IV LIMIT OVERRIDDEN ("_$G(PSJALRT)_"): ALERT SENT",PSIVALT="",PSIVREA="E" D
"RTN","PSIVORFB",44,0)
 .D LOG^PSIVORAL S P("LIMIT")="",P("OVRIDE")=1 K IVLIM,IVLIMIT
"RTN","PSIVORFB",45,0)
 .S $P(^PS(55,DFN,"IV",+ON55,2.5),"^",4)="" S:$G(PSJORD)["P" $P(^PS(53.1,+PSJORD,2.5),"^",4)=""
"RTN","PSIVORFB",46,0)
 .K PSIVAL,PSIVREA,PSIVALT
"RTN","PSIVORFB",47,0)
 I $G(PSIVCOPY)=1,$G(OLDON) I (OLDON["V")&(OLDON'=(+DA_"V")) D GETOPI^PSJBCMA5(DFN,OLDON)
"RTN","PSIVORFB",48,0)
 I $P($G(^PS(53.45,+$G(DUZ),6,0)),"^",3) D
"RTN","PSIVORFB",49,0)
 .N PSJTROPI,PSJNVO S PSJNVO=$G(P("NEWON")) I (PSJNVO["P") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO) Q
"RTN","PSIVORFB",50,0)
 .I ($G(P("PON"))["P"),($G(ON55)["V") S PSJNVO=P("PON") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO) Q
"RTN","PSIVORFB",51,0)
 .D FILEOPI^PSJBCMA5(DFN,ON55) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,ON55)
"RTN","PSIVORFB",52,0)
 Q
"RTN","PSIVORFB",53,0)
SET55 ; Move data from local variables to 55.
"RTN","PSIVORFB",54,0)
 I '$D(ON55) W !,"*** Can't create this order at this time ***" Q
"RTN","PSIVORFB",55,0)
 N DA,DIK,ND,PSIVACT,PSIVDUR,PSJTROPI,PSJTROPL
"RTN","PSIVORFB",56,0)
 S:'$D(P(21)) (P(21),P("21FLG"))="" S ND(0)=+ON55,P(22)=$S(VAIN(4):+VAIN(4),1:.5) F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSIVORFB",57,0)
 S ND(.3)=$G(P("INS")),ND(2.5)="" N X S X=$S($G(PSGORD):PSGORD,1:$G(ON)) I X D
"RTN","PSIVORFB",58,0)
 .N PKG S PKG=$E(X,$L(X)) S PKG=$S(PKG="V":"""IV""",PKG="U":5,PKG="P":"P",1:"") Q:PKG=""
"RTN","PSIVORFB",59,0)
 .S PSIVDUR=$$GETDUR^PSJLIVMD(DFN,+X,$E(X,$L(X)),1) Q:PSIVDUR=""
"RTN","PSIVORFB",60,0)
 .I $G(IVLIMIT) S ND(2.5)="^^^"_PSIVDUR K IVLIMIT Q
"RTN","PSIVORFB",61,0)
 S $P(ND(0),U,17)="A",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(P("NAT"))_U_U_U_$G(P("PRNTON"))
"RTN","PSIVORFB",62,0)
 F X=0,1,2.5,3,.2,.3 S ^PS(55,DFN,"IV",+ON55,X)=ND(X)
"RTN","PSIVORFB",63,0)
 ; PSJ*5*213 - if Piggyback, intermittent syringe, or
"RTN","PSIVORFB",64,0)
 ; intermittent chemotherapy, and frequency is null, attempt to
"RTN","PSIVORFB",65,0)
 ; set frequency again based on P(15),PSGS0XT, and piece 3 of ZZND if they exist.
"RTN","PSIVORFB",66,0)
 ; If this still is null, attempt to re-set based upon the schedule name.
"RTN","PSIVORFB",67,0)
 I $G(P("IVCAT"))="I"!($P($G(ND(0)),U,4)?1(1"P",1"S",1"C"))&($P($G(ND(0)),U,15)="") D
"RTN","PSIVORFB",68,0)
 . I $P($G(ND(0)),U,4)="S",$P($G(ND(0)),U,5)'=1 Q  ;Not intermittent syringe
"RTN","PSIVORFB",69,0)
 . I $P($G(ND(0)),U,4)="C",$P($G(ND(0)),U,23)?1(1"A",1"H") Q  ;Not chemo piggyback or syringe
"RTN","PSIVORFB",70,0)
 . I $P($G(ND(0)),U,4)="C",$P($G(ND(0)),U,23)="S",$P($G(ND(0)),U,5)'=1 Q  ;Not intermitent chemo syringe
"RTN","PSIVORFB",71,0)
 . S $P(^PS(55,DFN,"IV",+ON55,0),U,15)=$S($G(P(15))'="":P(15),$G(PSGS0XT)'="":PSGS0XT,$P($G(ZZND),"^",3)'="":$P(ZZND,"^",3),1:$$GETFRQ($P($G(ND(0)),U,9))) K PSJFRQ,PSJSKED
"RTN","PSIVORFB",72,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,1,4)=P("LOG")_U_+P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSIVORFB",73,0)
 S X=^PS(55,DFN,0) I $P(X,"^",7)="" S $P(X,"^",7)=$P($P(P("LOG"),"^"),"."),$P(X,"^",8)="A",^(0)=X D LOGDFN^PSUHL(DFN)
"RTN","PSIVORFB",74,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,11)=+P("CLRK")
"RTN","PSIVORFB",75,0)
 I +$G(P("CLIN")) S $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=P("CLIN") D:$P(P("CLIN"),"^")'="" CIMOI^PSJIMO1(DFN,+ON55,P("CLIN"))
"RTN","PSIVORFB",76,0)
 S:+$G(P("APPT")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^",2)=P("APPT")
"RTN","PSIVORFB",77,0)
 S:+$G(P("NINIT")) ^PS(55,DFN,"IV",+ON55,4)=P("NINIT")_U_P("NINITDT")
"RTN","PSIVORFB",78,0)
 I '$D(^PS(53.45,PSJSYSP,6)),($G(P("NEWON"))["P") S PSJTROPI=P("NEWON") S PSJTROPL=$$GETOPI^PSJBCMA5(DFN,PSJTROPI)
"RTN","PSIVORFB",79,0)
 I $G(^PS(53.45,PSJSYSP,6))!$P($G(^PS(53.45,PSJSYSP,6,0)),"^",3) D
"RTN","PSIVORFB",80,0)
 . I $G(PSJCOM),$G(PSJCOMSI),$G(PSJORD)["V" M ^TMP("PSJOPI",$J,6)=^PS(53.45,PSJSYSP,6)
"RTN","PSIVORFB",81,0)
 . D FILEOPI^PSJBCMA5(DFN,ON55) K ^TMP("PSJOPI",$J,6)
"RTN","PSIVORFB",82,0)
 I '$G(PSIVCHG)!($G(PSJREN)&($G(PSIVCHG)=2)) I $G(P("PON")),P("PON")'=ON55 D
"RTN","PSIVORFB",83,0)
 . N X S X=$S(P("PON")["P":"^PS(53.1,+P(""PON""),12,0)",P("PON")["V"&$G(PSJREN):"^PS(55,DFN,""IV"",+P(""PON""),5,0)",1:"") Q:X=""
"RTN","PSIVORFB",84,0)
 . I $O(@X) S %X=X,%Y="^PS(55,"_DFN_",""IV"","_+ON55_",5," D %XY^%RCR
"RTN","PSIVORFB",85,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSIVORFB",86,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK
"RTN","PSIVORFB",87,0)
 I $G(PSJCOM),$G(PSJCOMSI),$G(PSJORD)["V" K PSJCOMSI N PSJCHILD,PSJOEORD S PSJOEORD=0 F  S PSJOEORD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD)) Q:'PSJOEORD  D
"RTN","PSIVORFB",88,0)
 . N PSJCHILD S PSJCHILD=0 F  S PSJCHILD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD,PSJCHILD)) Q:'PSJCHILD  S PSJCHILD(+PSJCHILD)=PSJCOM
"RTN","PSIVORFB",89,0)
 . S PSJCHILD=0 F  S PSJCHILD=$O(PSJCHILD(PSJCHILD)) Q:'PSJCHILD  D
"RTN","PSIVORFB",90,0)
 .. Q:PSJCHILD=PSJORD  K DR,DA,DIE,ORD S DR="31////"_$P($G(P("OPI")),"^",1,2),DA(1)=DFN
"RTN","PSIVORFB",91,0)
 .. N ON,ON55 S (ON,ON55)=+PSJCHILD_"V" S:+$G(PSJPINIT)'>0 PSJPINIT=DUZ S PSIVALT=1,PSIVAL="COMPLEX ORDER" D ENTACT^PSIVAL D
"RTN","PSIVORFB",92,0)
 ... I $P($G(^PS(55,DFN,"IV",+ON55,3)),"^")'=$P(P("OPI"),"^") S P("FC")="OTHER PRINT INFO^"_$P($G(^(3)),"^")_U_$P(P("OPI"),"^") D GTFC^PSIVORAL
"RTN","PSIVORFB",93,0)
 ... I $D(^PS(55,DFN,"IV",+ON55,0)) S ^PS(55,DFN,"IV",+ON55,3)=P("OPI") D EN1^PSJHL2(DFN,"XX",ON55)
"RTN","PSIVORFB",94,0)
 ... M ^PS(55,DFN,"IV",+ON55,10)=^TMP("PSJOPI",$J,6)
"RTN","PSIVORFB",95,0)
 K ^TMP("PSJOPI",$J)
"RTN","PSIVORFB",96,0)
 Q
"RTN","PSIVORFB",97,0)
 ;
"RTN","PSIVORFB",98,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSIVORFB",99,0)
 K ^PS(55,DFN,"IV",+ON55,DRGT) S ^PS(55,DFN,"IV",+ON55,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSIVORFB",100,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSIVORFB",101,0)
 .S Y=^PS(55,DFN,"IV",+ON55,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSIVORFB",102,0)
 .S ^PS(55,DFN,"IV",+ON55,DRGT,0)=Y,Y=$P(DRG(DRGT,X),U)_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^PS(55,DFN,"IV",+ON55,DRGT,+DRG,0)=Y
"RTN","PSIVORFB",103,0)
 Q
"RTN","PSIVORFB",104,0)
GT55 ; Retrieve data from 55 into local array
"RTN","PSIVORFB",105,0)
 K DRG,DRGN,P S:'$D(ON55) ON55=ON S P("REN")="",Y=$G(^PS(55,DFN,"IV",+ON55,0)) F X=1:1:25 S P(X)=$P(Y,U,X)
"RTN","PSIVORFB",106,0)
 S P("21FLG")=P(21)
"RTN","PSIVORFB",107,0)
 S P("PON")=ON55,PSJORIFN=P(21),P(6)=P(6)_U_$P($G(^VA(200,+P(6),0)),U),(DRG,DRGN)="",P("REM")=$G(^PS(55,DFN,"IV",+ON55,1))
"RTN","PSIVORFB",108,0)
 S Y=$G(^PS(55,DFN,"IV",+ON55,2)),P("LOG")=$P(Y,U),P("IVRM")=$P(Y,U,2)_U_$P($G(^PS(59.5,+$P(Y,U,2),0)),U)
"RTN","PSIVORFB",109,0)
 S P("CLRK")=$P(Y,U,11)_U_$P($G(^VA(200,+$P(Y,U,11),0)),U),P("RES")=$P(Y,U,8),P("FRES")=$P(Y,U,9),P("SYRS")=$P(Y,U,4),P("OPI")=$G(^PS(55,DFN,"IV",+ON55,3))
"RTN","PSIVORFB",110,0)
 S P("INS")=$G(^PS(55,DFN,"IV",+ON55,.3))
"RTN","PSIVORFB",111,0)
 S P("CLIN")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^"),P("APPT")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^",2)
"RTN","PSIVORFB",112,0)
 S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSIVORFB",113,0)
 D:'$D(PSJLABEL) GTPC(ON55) S ND=$G(^PS(55,DFN,"IV",+ON55,.2)),P("PD")=$S($P(ND,U):$P(ND,U)_U_$$OIDF^PSJLMUT1(+ND)_U_$P($G(^PS(50.7,+ND,0)),U),1:""),P("DO")=$P(ND,U,2),P("PRY")=$P(ND,U,4),P("NAT")=$P(ND,U,5),(PSJCOM,P("PRNTON"))=$P(ND,U,8)
"RTN","PSIVORFB",114,0)
 I P("PRY")="D",'+P("IVRM") S P("IVRM")=+$G(PSIVSN)_U_$P($G(^PS(59.5,+$G(PSIVSN),0)),U)
"RTN","PSIVORFB",115,0)
 S P("MR")=$P(ND,U,3),ND=$G(^PS(51.2,+P("MR"),0)),P("MR")=P("MR")_U_$S($P(ND,U,3)]"":$P(ND,U,3),1:$P(ND,U)) D GTCUM
"RTN","PSIVORFB",116,0)
 D GTDRG,GTOT^PSIVUTL(P(4))
"RTN","PSIVORFB",117,0)
 N ND2P5 S ND2P5=$G(^PS(55,DFN,"IV",+ON55,2.5)) D
"RTN","PSIVORFB",118,0)
 .S P("DUR")=$P(ND2P5,"^",2)
"RTN","PSIVORFB",119,0)
 .S P("LIMIT")=$P(ND2P5,"^",4)
"RTN","PSIVORFB",120,0)
 .S P("IVCAT")=$P(ND2P5,"^",5)
"RTN","PSIVORFB",121,0)
K ; Kill and exit.
"RTN","PSIVORFB",122,0)
 K FIL,ND
"RTN","PSIVORFB",123,0)
 Q
"RTN","PSIVORFB",124,0)
GTDRG ; Get drug info and place in DRG(.
"RTN","PSIVORFB",125,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F Y=0:0 S Y=$O(^PS(55,DFN,"IV",+ON55,DRGT,Y)) Q:'Y  D
"RTN","PSIVORFB",126,0)
 .; naked ref below refers to line above
"RTN","PSIVORFB",127,0)
 .S DRG=$G(^(Y,0)),ND=$G(^PS(FIL,+DRG,0)),(DRGI,DRG(DRGT,0))=$G(DRG(DRGT,0))+1
"RTN","PSIVORFB",128,0)
 .S DRG(DRGT,+DRGI)=+DRG_U_$P(ND,U)_U_$P(DRG,U,2)_U_$P(DRG,U,3)_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSIVORFB",129,0)
 Q
"RTN","PSIVORFB",130,0)
 ;
"RTN","PSIVORFB",131,0)
GTCUM ; Retrieve dispensing info.
"RTN","PSIVORFB",132,0)
 S ND=$G(^PS(55,DFN,"IV",+ON55,9)),P("LF")=$P(ND,U),P("LFA")=$P(ND,U,2),P("CUM")=$P(ND,U,3)
"RTN","PSIVORFB",133,0)
 Q
"RTN","PSIVORFB",134,0)
 ;
"RTN","PSIVORFB",135,0)
GTPC(ON) ; Retrieve Provider Comments and create "scratch" fields to edit
"RTN","PSIVORFB",136,0)
 Q
"RTN","PSIVORFB",137,0)
 ;
"RTN","PSIVORFB",138,0)
SETNEW ; Create new order and set
"RTN","PSIVORFB",139,0)
 D NEW55,SET55
"RTN","PSIVORFB",140,0)
 Q
"RTN","PSIVORFB",141,0)
 ;
"RTN","PSIVORFB",142,0)
CMPLIM(PSJORD,PSJDSTP1,PSJDSTP2) ; Compare stop date of order against IV Limit
"RTN","PSIVORFB",143,0)
 I $P($G(^PS(53.1,+PSJORD,0)),"^",25)]"" D CHKD Q:PSJPAO 0
"RTN","PSIVORFB",144,0)
 I $G(PSJDSTP1),$E(+PSJDSTP1,1,11)'=$E(+P(3),1,11),+PSJDSTP2'=+P(3) Q 1
"RTN","PSIVORFB",145,0)
 Q 0
"RTN","PSIVORFB",146,0)
 ;
"RTN","PSIVORFB",147,0)
LIMSTOP(PSJDSTP1,PSJDSTP2) ; Calculate default stop date using IV Limit
"RTN","PSIVORFB",148,0)
 ;      Output: PSJDSTP1 - Default stop using duration only
"RTN","PSIVORFB",149,0)
 ;              PSJDSTP2 - Default stop using duration and IV parameters for time
"RTN","PSIVORFB",150,0)
 S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",151,0)
 I 'PSIVLIM,PSIVLIM]"" S PSIVLIM=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD)
"RTN","PSIVORFB",152,0)
 I PSIVLIM]"" D
"RTN","PSIVORFB",153,0)
 . S MINS=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD),PSJDSTP1=$$FMADD^XLFDT(P(2),,,MINS)
"RTN","PSIVORFB",154,0)
 . S X=$P(PSJDSTP1,"."),PSJDSTP2=X_$S($P($G(PSIVSITE),"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14))
"RTN","PSIVORFB",155,0)
 Q
"RTN","PSIVORFB",156,0)
 ;
"RTN","PSIVORFB",157,0)
GETFRQ(PSJSKED) ;Get frequency using name of schedule
"RTN","PSIVORFB",158,0)
 I PSJSKED="" K PSJSKED Q ""
"RTN","PSIVORFB",159,0)
 S (PSJCNTX,PSJFRQ)=""
"RTN","PSIVORFB",160,0)
 I $D(^PS(51.1,"APPSJ",PSJSKED)) F  S PSJCNTX=$O(^PS(51.1,"APPSJ",PSJSKED,PSJCNTX)) Q:PSJCNTX=""  D  Q:$G(PSJFRQ)'=""
"RTN","PSIVORFB",161,0)
 . I $P($G(^PS(51.1,PSJCNTX,0)),U,3)'="" S PSJFRQ=$P(^PS(51.1,PSJCNTX,0),U,3)
"RTN","PSIVORFB",162,0)
 K PSJCNTX
"RTN","PSIVORFB",163,0)
 Q PSJFRQ
"RTN","PSIVORFB",164,0)
 ;
"RTN","PSIVORFB",165,0)
CHKD ;Check for a previous active order and compare the duration
"RTN","PSIVORFB",166,0)
 N PSJPO,A,PSJDUR
"RTN","PSIVORFB",167,0)
 S PSJDUR=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",168,0)
 S PSJPAO=0,PSJPO=PSJORD
"RTN","PSIVORFB",169,0)
CHKDR S PSJPO=$P($G(^PS(53.1,+PSJPO,0)),"^",25) Q:PSJPO=""
"RTN","PSIVORFB",170,0)
 I PSJPO["P" G CHKDR
"RTN","PSIVORFB",171,0)
 I PSJPO["V" S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJPO) I PSJDUR'=PSIVLIM S PSJPAO=1 Q
"RTN","PSIVORFB",172,0)
 G CHKDR
"RTN","PSIVORFB",173,0)
 ;
"RTN","PSIVORFB",174,0)
LOGOPI(DFN,ON55) ; Log OPI activity into activity log
"RTN","PSIVORFB",175,0)
 N PSJPICHK
"RTN","PSIVORFB",176,0)
 I ON55["V" D
"RTN","PSIVORFB",177,0)
 .I ($G(P("PON"))["V"),($G(ON55)["V"),(ON55'=P("PON")) D
"RTN","PSIVORFB",178,0)
 ..K PSJARRY1,PSJARRY2 M PSJARRY1=^PS(53.45,+$G(PSJSYSP),6),PSJARRY2=^PS(55,DFN,"IV",+P("PON"),10) S PSJPICHK='$$DIFFAR^PSJBCMA5(.PSJARRY1,.PSJARRY2)
"RTN","PSIVORFB",179,0)
 .Q:$G(PSJPICHK)
"RTN","PSIVORFB",180,0)
 .N PSIVALCK,PSIVRA,PSIVLN,PSIVLSTA S PSIVLN=$O(^PS(55,DFN,"IV",+ON55,"A",""),-1)+1
"RTN","PSIVORFB",181,0)
 .K PSJARRY1,PSJARRY2 S PSJARRY1="",PSJARRY2="" M PSJARRY1=^PS(53.45,+$G(PSJSYSP),6),PSJARRY2=^PS(55,DFN,"IV",+ON55,10) Q:'$$DIFFAR^PSJBCMA5(.PSJARRY1,.PSJARRY2)
"RTN","PSIVORFB",182,0)
 .S P("FC")="OTHER PRINT INFO^"_$P($G(^PS(55,DFN,"IV",+ON55,3)),"^")_U_$P($G(P("OPI")),"^"),PSIVALCK="OPI",PSIVREA="E" D LOG^PSIVORAL
"RTN","PSIVORFB",183,0)
 K PSJARRY1,PSJARRY2
"RTN","PSIVORFB",184,0)
 Q
"RTN","PSJ257PO")
0^^B8181415
"RTN","PSJ257PO",1,0)
PSJ257PO ;BIR/LE-Post Install routine for patch PSJ*5*257 ;05/1/13
"RTN","PSJ257PO",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**257**;9/30/97;Build 105
"RTN","PSJ257PO",3,0)
 ;
"RTN","PSJ257PO",4,0)
QUE ;
"RTN","PSJ257PO",5,0)
 N NAMSP,PATCH,JOBN,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,Y,ZTQUEUED,ZTREQ,ZTSAVE,CNT,SBJM
"RTN","PSJ257PO",6,0)
 S NAMSP="PSJ257PO"
"RTN","PSJ257PO",7,0)
 S JOBN="PSJ*5*297 Post Install"
"RTN","PSJ257PO",8,0)
 S PATCH="PSJ*5*297"
"RTN","PSJ257PO",9,0)
 S Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSJ257PO",10,0)
 ;
"RTN","PSJ257PO",11,0)
 D BMES^XPDUTL("=============================================================")
"RTN","PSJ257PO",12,0)
 D MES^XPDUTL("Queuing background job for "_JOBN_"...")
"RTN","PSJ257PO",13,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSJ257PO",14,0)
 D MES^XPDUTL("A MailMan message will be sent to the installer upon Post")
"RTN","PSJ257PO",15,0)
 D MES^XPDUTL("Install Completion.  This may take 2-3 hours.")
"RTN","PSJ257PO",16,0)
 D MES^XPDUTL("==============================================================")
"RTN","PSJ257PO",17,0)
 ;
"RTN","PSJ257PO",18,0)
 S ZTRTN="EN^"_NAMSP,ZTIO=""
"RTN","PSJ257PO",19,0)
 S (SBJM,ZTDESC)="Background job for "_JOBN
"RTN","PSJ257PO",20,0)
 S ZTSAVE("JOBN")="",ZTSAVE("ZTDTH")="",ZTSAVE("DUZ")="",ZTSAVE("SBJM")=""
"RTN","PSJ257PO",21,0)
 D ^%ZTLOAD
"RTN","PSJ257PO",22,0)
 D:$D(ZTSK)
"RTN","PSJ257PO",23,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","PSJ257PO",24,0)
 . D BMES^XPDUTL("")
"RTN","PSJ257PO",25,0)
 . S ZTSAVE("ZTSK")=""
"RTN","PSJ257PO",26,0)
 D BMES^XPDUTL("")
"RTN","PSJ257PO",27,0)
 K XPDQUES
"RTN","PSJ257PO",28,0)
 Q
"RTN","PSJ257PO",29,0)
 ;
"RTN","PSJ257PO",30,0)
EN ;Do Mail Message
"RTN","PSJ257PO",31,0)
 N DFN,DA,STARTH,STOPH,SUBJ
"RTN","PSJ257PO",32,0)
 S STARTH=$$HTE^XLFDT(ZTDTH)
"RTN","PSJ257PO",33,0)
 K DIK S DIK="^PS(53.1,",DIK(1)="113^CIMO" D ENALL^DIK
"RTN","PSJ257PO",34,0)
 K DIK S DFN=0 F  S DFN=$O(^PS(55,DFN)) Q:'DFN  S DA(1)=DFN D
"RTN","PSJ257PO",35,0)
 .S DIK="^PS(55,"_DA(1)_",5,",DIK(1)="130^CIMOU" D ENALL^DIK
"RTN","PSJ257PO",36,0)
 .S DIK="^PS(55,"_DA(1)_",5,",DIK(1)="130^CIMOCLU" D ENALL^DIK
"RTN","PSJ257PO",37,0)
 .S DIK="^PS(55,"_DA(1)_","_"""IV"""_",",DIK(1)="136^CIMOI" D ENALL^DIK
"RTN","PSJ257PO",38,0)
 .S DIK="^PS(55,"_DA(1)_","_"""IV"""_",",DIK(1)="136^CIMOCLI" D ENALL^DIK
"RTN","PSJ257PO",39,0)
 K DIK
"RTN","PSJ257PO",40,0)
 ;
"RTN","PSJ257PO",41,0)
 ;Send message
"RTN","PSJ257PO",42,0)
 S CNT=1
"RTN","PSJ257PO",43,0)
 S Y=$$NOW^XLFDT S STOPH=$$FMTH^XLFDT(Y),STOPH=$$HTE^XLFDT(STOPH)
"RTN","PSJ257PO",44,0)
 S SUBJ="PSJ*5*257 POST INSTALL Complete"
"RTN","PSJ257PO",45,0)
 S MSG(CNT)="The new cross references for clinic orders have been created:",CNT=CNT+1
"RTN","PSJ257PO",46,0)
 S MSG(CNT)="     File 53.1 - CIMO",CNT=CNT+1
"RTN","PSJ257PO",47,0)
 S MSG(CNT)="      File 55  - CIMOU and CIMOCLU for Unit Dose Sub-file.",CNT=CNT+1
"RTN","PSJ257PO",48,0)
 S MSG(CNT)="      File 55  - CIMOI AND CIMOCLI for IV Sub-file.",CNT=CNT+1
"RTN","PSJ257PO",49,0)
 S MSG(CNT)=" ",CNT=CNT+1
"RTN","PSJ257PO",50,0)
 S MSG(CNT)="The background job "_ZTSK_" began "_STARTH_" and ",CNT=CNT+1
"RTN","PSJ257PO",51,0)
 S MSG(CNT)="ended "_STOPH_".",CNT=CNT+1
"RTN","PSJ257PO",52,0)
 D MAIL(.MSG,SUBJ)
"RTN","PSJ257PO",53,0)
 Q
"RTN","PSJ257PO",54,0)
 ;
"RTN","PSJ257PO",55,0)
MAIL(MSG,SBJ) ; Send out some mail!
"RTN","PSJ257PO",56,0)
 N DIFROM,XMDUZ,XMSUB,XMTEXT,XMY,I
"RTN","PSJ257PO",57,0)
 S XMDUZ="INPT PHARMACY",XMSUB=SBJM,XMTEXT="MSG("
"RTN","PSJ257PO",58,0)
 S XMY(DUZ)=""
"RTN","PSJ257PO",59,0)
 D ^XMD
"RTN","PSJ257PO",60,0)
 Q ""
"RTN","PSJ257PO",61,0)
 ;
"RTN","PSJBLDOC")
0^30^B52892828
"RTN","PSJBLDOC",1,0)
PSJBLDOC ;BIR/MV - API to build ^TMP for prospective and PSJ profile drugs ;03 Aug 98 / 8:42 AM
"RTN","PSJBLDOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,263,260,295,252,257**;16 DEC 97;Build 105
"RTN","PSJBLDOC",3,0)
 ;
"RTN","PSJBLDOC",4,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJBLDOC",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJBLDOC",6,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBLDOC",7,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJBLDOC",8,0)
 ; Reference to ^PSSDSAPM is supported by DBIA# 5570.
"RTN","PSJBLDOC",9,0)
 ;
"RTN","PSJBLDOC",10,0)
IN(DFN,LIST,PDRG,PTYP) ;
"RTN","PSJBLDOC",11,0)
 ;Build the IPM profiles and the prospective drugs list for both PSO & PSJ if PDRG is passed in.
"RTN","PSJBLDOC",12,0)
 ;DFN - PATIENT DFN
"RTN","PSJBLDOC",13,0)
 ;LIST - BASE
"RTN","PSJBLDOC",14,0)
 ;PDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSJBLDOC",15,0)
 ;       Where n is a sequential number.  Drug name can be OI, Generic name from #50 or Additive/sol name
"RTN","PSJBLDOC",16,0)
 ;PTYP - P1;P2 where P1="I" for Inpatient & "O" for Outpatient, P2= PSJ order#
"RTN","PSJBLDOC",17,0)
 NEW PSJONCNT,PSJDCNT,PSJDRGND,PSJWON
"RTN","PSJBLDOC",18,0)
 S PSJONCNT=0
"RTN","PSJBLDOC",19,0)
 S PSJWON=$P($G(PTYP),";",2)
"RTN","PSJBLDOC",20,0)
 D PROFILE(DFN,PSJWON,PTYP)
"RTN","PSJBLDOC",21,0)
 K ^TMP($J,"PSJPRE","CLINIC")
"RTN","PSJBLDOC",22,0)
 Q
"RTN","PSJBLDOC",23,0)
PROFILE(DFN,PSJWON,PTYP)     ;Setup ^TMP for the active meds to be on the OC profile list.
"RTN","PSJBLDOC",24,0)
 ;DFN:    Patient internal entry number
"RTN","PSJBLDOC",25,0)
 ;PSJWON: The current order number being working on.  It can be null.
"RTN","PSJBLDOC",26,0)
 ;        It is the order being work on (RN, FN..) and should be on the prospective list.
"RTN","PSJBLDOC",27,0)
 ;Output: ^TMP($J,"ORDERS",PSJINX)=DRUG CLASS^NATIONAL DRUG FILE ENTRY
"RTN","PSJBLDOC",28,0)
 ;        _"A"_PSNDFA PRODUCT NAME ENTRY_DISPENSE DRUG NAME^OE/RR #
"RTN","PSJBLDOC",29,0)
 ;        _ORDER NUMBER(P/I/V)_";I"
"RTN","PSJBLDOC",30,0)
 ;
"RTN","PSJBLDOC",31,0)
 NEW BDT,COD,DDRUG,DDRUGND,EDT,F,ON,ON1,PST,WBDT,X,PSJORIEN,%,PSJCLCOD,PSJCLINF,PSJCLIND,PSJTYPCL,PSJCLNPR
"RTN","PSJBLDOC",32,0)
 S PSJWON=$G(PSJWON),PSJCLCOD=""
"RTN","PSJBLDOC",33,0)
 ;
"RTN","PSJBLDOC",34,0)
 ;Must display any DC/Expired clinic orders within largest number of days defined for whichever clinic has the oldest date defined for ORDER CHECK DC/EXPIRED DAYS field
"RTN","PSJBLDOC",35,0)
 ;under the CLINIC DEFINITION file (#53.46)
"RTN","PSJBLDOC",36,0)
 ;Active, non-verified, pending, hold clinic orders must be displayed in the clinic display format.
"RTN","PSJBLDOC",37,0)
 D CLINICS^PSJCLNOC(DFN)  ;get clinic orders for this patient and set ^TMP($J,"PSJPRE","CLINIC",IEN,FILE_TYPE)=""
"RTN","PSJBLDOC",38,0)
 I $D(^TMP($J,"PSJPRE","CLINIC")) S PSJCLNPR=1 D
"RTN","PSJBLDOC",39,0)
 .S (PSJTYPCL,ON)="" F  S ON=$O(^TMP($J,"PSJPRE","CLINIC",ON)) Q:ON=""  F  S PSJTYPCL=$O(^TMP($J,"PSJPRE","CLINIC",ON,PSJTYPCL)) Q:PSJTYPCL=""  D
"RTN","PSJBLDOC",40,0)
 ..S F="^PS(55,DFN,5,"
"RTN","PSJBLDOC",41,0)
 ..I PSJTYPCL["55U" S COD=ON_"U",PSJCLCOD=2 D:COD'=PSJWON UD Q
"RTN","PSJBLDOC",42,0)
 ..I PSJTYPCL["55I" S COD=ON_"V" S PSJCLCOD=1 D:COD'=PSJWON IV Q
"RTN","PSJBLDOC",43,0)
 ..S F="^PS(53.1,"
"RTN","PSJBLDOC",44,0)
 ..S COD=ON_"P" Q:COD=PSJWON!($D(PSJVFF)&(COD=$G(PSJORD)))
"RTN","PSJBLDOC",45,0)
 ..I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",46,0)
 ..I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) S PSJCLCOD=3 D PIV Q
"RTN","PSJBLDOC",47,0)
 ..I $$GET1^DIQ(53.1,+ON,4,"I")="I" S PSJCLCOD=5
"RTN","PSJBLDOC",48,0)
 ..S PSJCLCOD=4 D UD
"RTN","PSJBLDOC",49,0)
 S PSJCLNPR=1
"RTN","PSJBLDOC",50,0)
 ;
"RTN","PSJBLDOC",51,0)
 D NOW^%DTC S (BDT,WBDT)=%,EDT=9999999  ; WBDT SET THIS WAY BEFORE CLINIC OC DISPLAY ADDED
"RTN","PSJBLDOC",52,0)
 S F="^PS(55,DFN,5," F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  S COD=ON_"U",PSJCLCOD=2 D:COD'=PSJWON UD
"RTN","PSJBLDOC",53,0)
 S WBDT=BDT,F="^PS(53.1,",PSJCLCOD="" F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  D
"RTN","PSJBLDOC",54,0)
 . S COD=ON_"P" Q:COD=PSJWON!($D(PSJVFF)&(COD=$G(PSJORD)))
"RTN","PSJBLDOC",55,0)
 . I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",56,0)
 . I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) S PSJCLCOD=3 D PIV Q
"RTN","PSJBLDOC",57,0)
 . S PSJCLCOD=4
"RTN","PSJBLDOC",58,0)
 . I $$GET1^DIQ(53.1,+ON,4,"I")="I" S PSJCLCOD=5
"RTN","PSJBLDOC",59,0)
 . D UD
"RTN","PSJBLDOC",60,0)
 S WBDT=BDT F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  S COD=ON_"V" S PSJCLCOD=1 D:COD'=PSJWON IV
"RTN","PSJBLDOC",61,0)
 K PSJWON
"RTN","PSJBLDOC",62,0)
 Q
"RTN","PSJBLDOC",63,0)
UD ;Get the dispense drugs for the Unit Dose orders.
"RTN","PSJBLDOC",64,0)
 NEW X,PSJQUIT,PSJCNT,DDRUG,DDRUGN,PSJX,PSJOI,PSJEXPDD,PSJUTMP,PSJEDOVR,PSJCLNX,PSJCLDAT,PSJCLDAY,PSJSTOP
"RTN","PSJBLDOC",65,0)
 S X=@(F_ON_",0)")
"RTN","PSJBLDOC",66,0)
 Q:$P(X,U,9)="R"
"RTN","PSJBLDOC",67,0)
 S (PSJEDOVR,PSJCLINF,PSJCLNX,PSJCLDAY,PSJSTOP)=0,PSJCLDAT="",PSJCLNX=$P(X,U,9)
"RTN","PSJBLDOC",68,0)
 I $D(^TMP($J,"PSJPRE","CLINIC",+ON,$S(PSJCLCOD=5:"531I",PSJCLCOD=2:"55U",1:"531U"))) S PSJCLINF=1
"RTN","PSJBLDOC",69,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",70,0)
 Q:$P(X,U,9)["D"&('PSJCLINF)
"RTN","PSJBLDOC",71,0)
 Q:$P(X,U,9)="E"&('PSJCLINF)
"RTN","PSJBLDOC",72,0)
 S PSJORIEN=$P(X,U,21),DDRUG=0
"RTN","PSJBLDOC",73,0)
 ;
"RTN","PSJBLDOC",74,0)
 ;Use the first active DD within the order. If >1 DD, use OI_Dosage form for display name
"RTN","PSJBLDOC",75,0)
 S ON1=0,PSJCNT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'ON1  S PSJCNT=PSJCNT+1
"RTN","PSJBLDOC",76,0)
 S PSJOI=+$G(@(F_ON_",.2)"))
"RTN","PSJBLDOC",77,0)
 S ON1=0,PSJQUIT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'+ON1!PSJQUIT  S DDRUG=@(F_ON_",1,"_ON1_",0)") D
"RTN","PSJBLDOC",78,0)
 . Q:'+DDRUG
"RTN","PSJBLDOC",79,0)
 . S PSJX=$P(DDRUG,U,3)
"RTN","PSJBLDOC",80,0)
 . I 'PSJCLINF,PSJX]"",(PSJX'>BDT) Q
"RTN","PSJBLDOC",81,0)
 . D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) S PSJQUIT=1
"RTN","PSJBLDOC",82,0)
 ;Quit when an active DD within the order if found
"RTN","PSJBLDOC",83,0)
 Q:+$G(PSJQUIT)
"RTN","PSJBLDOC",84,0)
 ;
"RTN","PSJBLDOC",85,0)
 ;No DD found from the order. Get one from the OI
"RTN","PSJBLDOC",86,0)
 I '+PSJOI D SETIN("PROFILE","NOT FOUND: "_COD,"",COD,1,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",87,0)
 S DDRUG=$P($$DRG^PSSDSAPM(+PSJOI,"I"),U)
"RTN","PSJBLDOC",88,0)
 I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",89,0)
 ;
"RTN","PSJBLDOC",90,0)
 ;Get the first DD from OI (CCR5665 - set exception if pending order has no DD assigned and none is active. PSJ*5*252 t9)
"RTN","PSJBLDOC",91,0)
 I ($G(COD)'["P"),('+DDRUG) S DDRUG=$O(^PSDRUG("ASP",PSJOI,0)) I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",92,0)
 ;
"RTN","PSJBLDOC",93,0)
 ;Set exception when no DD found
"RTN","PSJBLDOC",94,0)
 I '+DDRUG D SETIN("PROFILE",$$OIDF^PSJLMUT1(+$G(PSJOI)),"",COD,1,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",95,0)
 Q
"RTN","PSJBLDOC",96,0)
PIV ;Get the dispense drugs for the Pending IV orders.
"RTN","PSJBLDOC",97,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM,PSJCLNTY
"RTN","PSJBLDOC",98,0)
 S PSJX=^PS(53.1,+ON,0),PSJORIEN=$P(PSJX,U,21) Q:$P(PSJX,U,27)="R"
"RTN","PSJBLDOC",99,0)
 S (PSJEDOVR,PSJCLINF,PSJCLNTY)=0,PSJCLNTY=$$GET1^DIQ(53.1,+ON,4,"I")
"RTN","PSJBLDOC",100,0)
 S:$D(^TMP($J,"PSJPRE","CLINIC",+ON,531_PSJCLNTY)) PSJCLINF=1
"RTN","PSJBLDOC",101,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",102,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",103,0)
 . S PSJX=^PS(53.1,+ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",104,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",105,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",106,0)
 . D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",107,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",108,0)
 . S PSJX=^PS(53.1,+ON,"SOL",ON1,0) D
"RTN","PSJBLDOC",109,0)
 . I $$PREMIX^PSJMISC(+PSJX) D
"RTN","PSJBLDOC",110,0)
 .. S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",111,0)
 .. S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",112,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",113,0)
 .. D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",114,0)
 Q
"RTN","PSJBLDOC",115,0)
IV ;Get the dispense drugs for the IV orders.
"RTN","PSJBLDOC",116,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM,PSJCLNX,PSJSTOP
"RTN","PSJBLDOC",117,0)
 S PSJX=^PS(55,DFN,"IV",ON,0),PSJORIEN=$P(PSJX,U,21),(PSJCLINF,PSJCLNX)=0,PSJCLNX=$P(PSJX,U,17)
"RTN","PSJBLDOC",118,0)
 Q:$P(PSJX,U,17)="R"
"RTN","PSJBLDOC",119,0)
 I $D(^TMP($J,"PSJPRE","CLINIC",+ON,"55I")) S PSJCLINF=1
"RTN","PSJBLDOC",120,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",121,0)
 Q:$P(PSJX,U,17)["D"&('PSJCLINF)
"RTN","PSJBLDOC",122,0)
 Q:$P(PSJX,U,17)="E"&('PSJCLINF)
"RTN","PSJBLDOC",123,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",124,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",125,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",126,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",127,0)
 . D SETIN("PROFILE",PSJNM,DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",128,0)
 ; Only include Pre-mix in the OC.
"RTN","PSJBLDOC",129,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",130,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"SOL",ON1,0)
"RTN","PSJBLDOC",131,0)
 . I $$PREMIX^PSJMISC(+PSJX) D
"RTN","PSJBLDOC",132,0)
 .. S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",133,0)
 .. S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",134,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",135,0)
 .. D SETIN("PROFILE",PSJNM,DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",136,0)
 Q
"RTN","PSJBLDOC",137,0)
SETIN(PSJFLG,PSJNM,DDRUG,ON,PSJCODE,PSJCLCOD,PSJCLINF) ;Set ^TMP($J,"PSJPRE,"IN" arrays.
"RTN","PSJBLDOC",138,0)
 ;ON = ON with "U/V/P"
"RTN","PSJBLDOC",139,0)
 ;PSJFLG = "PROSPECTIVE" or "PROFILE"
"RTN","PSJBLDOC",140,0)
 ;PSJNM = This should be the AD/SOL print name or IV order.  Use Dispense drug name if U/D order
"RTN","PSJBLDOC",141,0)
 ;PSJPON = 4 piece pharmacy order #
"RTN","PSJBLDOC",142,0)
 NEW PSJPON
"RTN","PSJBLDOC",143,0)
 Q:$G(PSJFLG)=""
"RTN","PSJBLDOC",144,0)
 S PSJONCNT=$G(PSJONCNT)+1
"RTN","PSJBLDOC",145,0)
 S PSJPON=$S(PSJCLINF:"C"_PSJCLCOD_";",1:"I;")_ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",146,0)
 I $P(PSJCODE,";")="O" S PSJPON="C"_PSJCLCOD_";"_+ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",147,0)
 I '+$G(DDRUG) D  Q
"RTN","PSJBLDOC",148,0)
 . I +$G(PSJCODE) D NODD($G(PSJCODE),PSJNM,PSJPON,LIST)
"RTN","PSJBLDOC",149,0)
 Q:$$SUP^PSSDSAPI(+DDRUG)
"RTN","PSJBLDOC",150,0)
 I $G(PSJNM)="" S PSJNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",151,0)
 S PSJFLG=$S($G(PSJDGCK):"PROSPECTIVE",1:"PROFILE") ;when using DX hidden action
"RTN","PSJBLDOC",152,0)
 S ^TMP($J,LIST,"IN",PSJFLG,PSJPON)=+$$GCN^PSJMISC(+DDRUG)_U_$$GTVUID^PSJMISC(+DDRUG)_U_+DDRUG_U_PSJNM_U_$G(PSJORIEN)_U_"I"_U_PSJCLCOD_";"_PSJCLINF
"RTN","PSJBLDOC",153,0)
 Q
"RTN","PSJBLDOC",154,0)
IV0(PSJAD,PSIVIEN) ;Return ad/sol zero node
"RTN","PSJBLDOC",155,0)
 ;PSJAD = "AD" is passed in if it additive, otherwise it's null
"RTN","PSJBLDOC",156,0)
 I PSJAD="AD" Q $G(^PS(52.6,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",157,0)
 I $G(PSJAD)="" Q $G(^PS(52.7,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",158,0)
 Q ""
"RTN","PSJBLDOC",159,0)
NODD(PSJCODE,PSJOIDF,PSJPON,PSJBASE) ;Set ^TMP for OI without a dispense drug
"RTN","PSJBLDOC",160,0)
 ;PSJCODE - A numeric code to trigger the appropriate exception message 
"RTN","PSJBLDOC",161,0)
 ;PSJOIDF - Orderable Item name_Dose form (can be CPRS OI)
"RTN","PSJBLDOC",162,0)
 ;PSJPON - Pharmacy order #
"RTN","PSJBLDOC",163,0)
 ;PSJBASE - Base subscript
"RTN","PSJBLDOC",164,0)
 Q:$G(PSJOIDF)=""
"RTN","PSJBLDOC",165,0)
 Q:$G(PSJBASE)=""
"RTN","PSJBLDOC",166,0)
 Q:'+$G(PSJCODE)
"RTN","PSJBLDOC",167,0)
 ;S PSJIV("OI_ERROR",PSJOIDF)=$G(PSJCODE)_U_$G(PSJPON)
"RTN","PSJBLDOC",168,0)
 S ^TMP($J,PSJBASE,"IN","EXCEPTIONS","OI",PSJOIDF)=PSJCODE_U_$G(PSJPON)
"RTN","PSJBLDOC",169,0)
 Q
"RTN","PSJCLNOC")
0^37^B84441536
"RTN","PSJCLNOC",1,0)
PSJCLNOC ;BIR/LE - Clinic Order Check Utilities ;26 FEB 12 / 12:42 PM
"RTN","PSJCLNOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**260,257**;16 DEC 97;Build 105
"RTN","PSJCLNOC",3,0)
 ;Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSJCLNOC",4,0)
 ;
"RTN","PSJCLNOC",5,0)
CLINICS(PSJDFN) ;
"RTN","PSJCLNOC",6,0)
 ;Only clinics with yes to ADMINISTER INPATIENT MEDS in SET UP A CLINIC option and Rx's where a clinic and appt date/time are defined for the Rx are stored in 
"RTN","PSJCLNOC",7,0)
 ;the CIMO, CIMOU and CIMOI cross references. 
"RTN","PSJCLNOC",8,0)
 N X,X1,X2,PSJSTDT,PSJCLIN,PSJCLINF,ORDID,PSJSTA,PSJUTMP,PSJTYP,PSJCANEX,PSJCLCOD,PST,PSJSTPDT,PSJTODAY,PSJCLIN,PSJXREF,PSJAPTDT,CLNDAYS,CLNDAY,OLDEST,PSJSTOP,CLFILIEN,PSJTYPE
"RTN","PSJCLNOC",9,0)
 D NOW^%DTC S PSJTODAY=%
"RTN","PSJCLNOC",10,0)
 K ^TMP($J,"PSJPRE","CLINIC")
"RTN","PSJCLNOC",11,0)
 S (PSJSTDT,PSJCLIN,PSJCLINF,ORDID,PSJCLIN,CLFILIEN,CLNDAYS,CLNDAY,OLDEST)=""
"RTN","PSJCLNOC",12,0)
 S X1=PSJTODAY,X2=-120 D C^%DTC S (CLNDAY,PSJSTDT)=X
"RTN","PSJCLNOC",13,0)
 S PSJXREF="CIMOU"
"RTN","PSJCLNOC",14,0)
 F  S PSJCLIN=$O(^PS(55,PSJXREF,PSJDFN,PSJCLIN)) Q:PSJCLIN=""  D GETCLINF D
"RTN","PSJCLNOC",15,0)
 .F  S PSJSTDT=$O(^PS(55,PSJXREF,PSJDFN,PSJCLIN,PSJSTDT)) Q:PSJSTDT=""  F  S ORDID=$O(^PS(55,PSJXREF,PSJDFN,PSJCLIN,PSJSTDT,PSJDFN,ORDID)) Q:ORDID=""  D
"RTN","PSJCLNOC",16,0)
 ..D SETTMP
"RTN","PSJCLNOC",17,0)
 S PSJXREF="CIMOI",(PSJCLIN,ORDID)="",PSJSTDT=CLNDAY
"RTN","PSJCLNOC",18,0)
 F  S PSJCLIN=$O(^PS(55,PSJDFN,"IV",PSJXREF,PSJCLIN)) Q:PSJCLIN=""  D GETCLINF D
"RTN","PSJCLNOC",19,0)
 .F  S PSJSTDT=$O(^PS(55,PSJDFN,"IV",PSJXREF,PSJCLIN,PSJSTDT)) Q:PSJSTDT=""  F  S ORDID=$O(^PS(55,PSJDFN,"IV",PSJXREF,PSJCLIN,PSJSTDT,ORDID)) Q:ORDID=""  D
"RTN","PSJCLNOC",20,0)
 ..D SETTMP
"RTN","PSJCLNOC",21,0)
 ;
"RTN","PSJCLNOC",22,0)
D531 ;
"RTN","PSJCLNOC",23,0)
 S X1=PSJTODAY,X2=-120 D C^%DTC S (CLNDAY,PSJSTDT)=X
"RTN","PSJCLNOC",24,0)
 S (PSJSTDT,PSJCLIN,PSJCLINF,ORDID,PSJCLIN,CLFILIEN,CLNDAYS,CLNDAY,PSJTYPE)="",X1=PSJTODAY,X2=-120 D C^%DTC S PSJSTDT=X
"RTN","PSJCLNOC",25,0)
 F  S PSJCLIN=$O(^PS(53.1,"CIMO",PSJDFN,PSJCLIN)) Q:PSJCLIN=""  F  S ORDID=$O(^PS(53.1,"CIMO",PSJDFN,PSJCLIN,ORDID)) Q:ORDID=""  D
"RTN","PSJCLNOC",26,0)
 .S CLFILIEN="",CLFILIEN=$O(^PS(53.46,"B",PSJCLIN,CLFILIEN)),(CLNDAYS,CLNDAY,OLDEST)=""
"RTN","PSJCLNOC",27,0)
 .S CLNDAYS=$$GET1^DIQ(53.46,CLFILIEN,6)
"RTN","PSJCLNOC",28,0)
 .S PSJTYPE=$$GET1^DIQ(53.1,ORDID,4,"I")
"RTN","PSJCLNOC",29,0)
 .I CLNDAYS="" S CLNDAYS=30
"RTN","PSJCLNOC",30,0)
 .S X1=PSJTODAY,X2=-CLNDAYS D C^%DTC S (PSJSTDT,CLNDAY)=X
"RTN","PSJCLNOC",31,0)
 .S ^TMP($J,"PSJPRE","CLINIC",ORDID,531_PSJTYPE)=CLNDAYS_"^"_PSJSTDT_"^"_PSJCLIN
"RTN","PSJCLNOC",32,0)
 Q
"RTN","PSJCLNOC",33,0)
 ;
"RTN","PSJCLNOC",34,0)
SETTMP ;
"RTN","PSJCLNOC",35,0)
 S ^TMP($J,"PSJPRE","CLINIC",ORDID,$S(PSJXREF="CIMOU":"55U",1:"55I"))=CLNDAYS_"^"_PSJSTDT_"^"_PSJCLIN
"RTN","PSJCLNOC",36,0)
 Q
"RTN","PSJCLNOC",37,0)
 ;
"RTN","PSJCLNOC",38,0)
GETCLINF ;
"RTN","PSJCLNOC",39,0)
 S CLFILIEN="",CLFILIEN=$O(^PS(53.46,"B",PSJCLIN,CLFILIEN)),(CLNDAYS,CLNDAY,OLDEST)=""
"RTN","PSJCLNOC",40,0)
 S CLNDAYS=$$GET1^DIQ(53.46,CLFILIEN,6)
"RTN","PSJCLNOC",41,0)
 I CLNDAYS="" S CLNDAYS=30
"RTN","PSJCLNOC",42,0)
 S X1=PSJTODAY,X2=-CLNDAYS D C^%DTC S (PSJSTDT,CLNDAY)=X
"RTN","PSJCLNOC",43,0)
 ;S OLDEST="",OLDEST=$G(^TMP($J,"PSJPRE","CLINIC","OLDEST")) I CLNDAYS>OLDEST S ^TMP($J,"PSJPRE","CLINIC","OLDEST")=CLNDAYS
"RTN","PSJCLNOC",44,0)
 Q
"RTN","PSJCLNOC",45,0)
 ;----------------------------------
"RTN","PSJCLNOC",46,0)
CANEXP(DFN,ON,PSJCLCOD) ;
"RTN","PSJCLNOC",47,0)
 N FILE,ORTYPE,PIECE,FLDS,FLD1,FLD2,FLD3
"RTN","PSJCLNOC",48,0)
 S ORTYPE=$P(PSJCLCOD,";")
"RTN","PSJCLNOC",49,0)
 I ORTYPE=1 S FILE=55.06,FLDS=".03;100;109",FLD1=.03,FLD2=109,FLD3=100
"RTN","PSJCLNOC",50,0)
 I ORTYPE=2 S FILE=55.06,FLDS="28;34;48",FLD1=34,FLD2=48,FLD3=28
"RTN","PSJCLNOC",51,0)
 I ORTYPE=3!(ORTYPE=4) S FILE=53.1,FLDS="25;28;38",FLD1=25,FLD2=38,FLD3=28
"RTN","PSJCLNOC",52,0)
 ;
"RTN","PSJCLNOC",53,0)
CE ;check to see if Rx is outside the stop date + 90 days time frame
"RTN","PSJCLNOC",54,0)
 N CANEXPDT,PSJUTMP,PSJDCEXD,X1,X2,X,PSJCLNX
"RTN","PSJCLNOC",55,0)
 S (PSJCLNX,PSJDCEXD,CANEXPDT,X,X1,X2)=""
"RTN","PSJCLNOC",56,0)
 D GETS^DIQ(FILE,ON_","_DFN,FLDS,"I","PSJUTMP")
"RTN","PSJCLNOC",57,0)
 S:$D(PSJUTMP(FILE,ON_","_DFN_",",FLD3,"I")) PSJCLNX=PSJUTMP(FILE,ON_","_DFN_",",FLD3,"I")
"RTN","PSJCLNOC",58,0)
 S:'$D(PSJCLNX) PSJCLNX="" Q:PSJCLNX=""!('$D(PSJCLNX)) 0
"RTN","PSJCLNOC",59,0)
 I PSJCLNX="D" S:$D(PSJUTMP(FILE,ON_","_DFN_",",FLD1,"I")) CANEXPDT=PSJUTMP(FILE,ON_","_DFN_",",FLD1,"I")
"RTN","PSJCLNOC",60,0)
 I PSJCLNX="E"!(CANEXPDT="") S:$D(PSJUTMP(FILE,ON_","_DFN_",",FLD2,"I")) CANEXPDT=PSJUTMP(FILE,ON_","_DFN_",",FLD2,"I")
"RTN","PSJCLNOC",61,0)
 I CANEXPDT="" Q 0
"RTN","PSJCLNOC",62,0)
 S X1=CANEXPDT,X2=90 D C^%DTC S PSJDCEXD=X
"RTN","PSJCLNOC",63,0)
 I BDT>PSJDCEXD Q 0
"RTN","PSJCLNOC",64,0)
 Q 1
"RTN","PSJCLNOC",65,0)
 ;---------------------------------
"RTN","PSJCLNOC",66,0)
SETIN(PSJFLG,PSJPON,PSJNM,PSJCLCOD) ;
"RTN","PSJCLNOC",67,0)
 N TMP,STATUS,STARTDT,STOPDT,SCHEDULE,DOSAGE,ORDID,PSJCDFN,TYPE,FLG,INFUSE
"RTN","PSJCLNOC",68,0)
 S ORDID=$P(PSJCLCOD,";",1),PSJCDFN=$P(PSJCLCOD,";",3)
"RTN","PSJCLNOC",69,0)
 S TYPE="IN"
"RTN","PSJCLNOC",70,0)
 S ^TMP($J,LIST,"CLINIC",PSJPON)=ORDID_"^"_PSJCDFN_"^"_PSJNM_"^"_$P(PSJCLCOD,";",2)
"RTN","PSJCLNOC",71,0)
 Q
"RTN","PSJCLNOC",72,0)
 ;
"RTN","PSJCLNOC",73,0)
GET(PSJCON,PSJCDFN,ORDID,PSJCCODE,PSJNM,PSJCGET)  ;
"RTN","PSJCLNOC",74,0)
 N TYPE,LIST
"RTN","PSJCLNOC",75,0)
 S TYPE="IN",LIST="PSJPRE",(DOSAGE,STATUS,STARTDT,STOPDT,SCHEDULE,INFUSE,STARTDTF,STOPDTF)=""
"RTN","PSJCLNOC",76,0)
 I PSJCCODE=1 S FLG=0 D GETF55
"RTN","PSJCLNOC",77,0)
 I PSJCCODE=2 S FLG=1 D GETF55
"RTN","PSJCLNOC",78,0)
 I PSJCCODE=3 D GETF531
"RTN","PSJCLNOC",79,0)
 I PSJCCODE=4!(PSJCCODE=5) D GETF531
"RTN","PSJCLNOC",80,0)
 Q
"RTN","PSJCLNOC",81,0)
 ;
"RTN","PSJCLNOC",82,0)
GETF55 ;get file 55 clinic info
"RTN","PSJCLNOC",83,0)
 D GETS^DIQ($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN,$S(FLG:"10;26;28;34;59;109",1:".02;.03;.08;.09;100;131"),,"TMP")
"RTN","PSJCLNOC",84,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:28,1:100))) STATUS=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:28,1:100))
"RTN","PSJCLNOC",85,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:10,1:.02))) STARTDT=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:10,1:.02))
"RTN","PSJCLNOC",86,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:34,1:.03))) STOPDT=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:34,1:.03))
"RTN","PSJCLNOC",87,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:26,1:.09))) SCHEDULE=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:26,1:.09))
"RTN","PSJCLNOC",88,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:109,1:131))) DOSAGE=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:109,1:131))
"RTN","PSJCLNOC",89,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:59,1:.08))) INFUSE=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:59,1:.08))
"RTN","PSJCLNOC",90,0)
 S PSJCGET(ORDID)=STATUS_"^"_STARTDT_"^"_STOPDT_"^"_SCHEDULE_"^"_DOSAGE_"^"_INFUSE_"^"_PSJNM
"RTN","PSJCLNOC",91,0)
 Q:PSJCCODE=2!(PSJCCODE=4)
"RTN","PSJCLNOC",92,0)
 ;IV additives and solutions
"RTN","PSJCLNOC",93,0)
 N ON1,PSJX,DDRUG,PSJ0,PSJDNAM
"RTN","PSJCLNOC",94,0)
 S ON1=0 F  S ON1=$O(^PS(55,PSJCDFN,"IV",ORDID,"AD",ON1)) Q:'ON1!(ON1'?1N.N)   D
"RTN","PSJCLNOC",95,0)
 . S PSJX=^PS(55,PSJCDFN,"IV",ORDID,"AD",ON1,0),PSJ0=$$IV0^PSJBLDOC("AD",+PSJX)
"RTN","PSJCLNOC",96,0)
 . S DDRUG=$P(PSJ0,U,2),PSJDNAM=$P(PSJ0,U)_" "_$P(PSJX,U,2)
"RTN","PSJCLNOC",97,0)
 . S PSJCGET(ORDID,"ADDITIVE",ON1)=PSJDNAM_"^"_DDRUG_"^"_ORDID_"^"_$P(PSJX,"^",3)
"RTN","PSJCLNOC",98,0)
 ; Pre-mix in the OC.
"RTN","PSJCLNOC",99,0)
 S ON1=0 F  S ON1=$O(^PS(55,PSJCDFN,"IV",ORDID,"SOL",ON1)) Q:'ON1!(ON1'?1N.N)   D
"RTN","PSJCLNOC",100,0)
 . S PSJX=^PS(55,PSJCDFN,"IV",ORDID,"SOL",ON1,0)
"RTN","PSJCLNOC",101,0)
 . S PSJ0=$$IV0^PSJBLDOC("",+PSJX),DDRUG=$P(PSJ0,U,2)
"RTN","PSJCLNOC",102,0)
 . S PSJDNAM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJCLNOC",103,0)
 . S PSJCGET(ORDID,"SOLUTION",ON1)=PSJDNAM_"^"_DDRUG_"^"_INFUSE
"RTN","PSJCLNOC",104,0)
 Q
"RTN","PSJCLNOC",105,0)
 ;
"RTN","PSJCLNOC",106,0)
GETF531 ;get file 53.1 clinic info
"RTN","PSJCLNOC",107,0)
 D GETS^DIQ(53.1,ORDID_","_PSJCDFN,"28;10;25;26;27;109;115;116;117",,"TMP")
"RTN","PSJCLNOC",108,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",28)) STATUS=TMP(53.1,ORDID_","_PSJCDFN_",",28)
"RTN","PSJCLNOC",109,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",10)) STARTDT=TMP(53.1,ORDID_","_PSJCDFN_",",10)
"RTN","PSJCLNOC",110,0)
 I STARTDT="" S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",115)) STARTDT=TMP(53.1,ORDID_","_PSJCDFN_",",115) S:STARTDT'="" STARTDTF=1
"RTN","PSJCLNOC",111,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",116)) DURATION=TMP(53.1,ORDID_","_PSJCDFN_",",116)
"RTN","PSJCLNOC",112,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",25)) STOPDT=TMP(53.1,ORDID_","_PSJCDFN_",",25)
"RTN","PSJCLNOC",113,0)
 I STOPDT="" S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",117)) STOPDT=TMP(53.1,ORDID_","_PSJCDFN_",",117) S:STOPDT'="" STOPDTF=1
"RTN","PSJCLNOC",114,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",27)) ORDDATE=TMP(53.1,ORDID_","_PSJCDFN_",",27)
"RTN","PSJCLNOC",115,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",26)) SCHEDULE=TMP(53.1,ORDID_","_PSJCDFN_",",26)
"RTN","PSJCLNOC",116,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",109)) DOSAGE=TMP(53.1,ORDID_","_PSJCDFN_",",109)
"RTN","PSJCLNOC",117,0)
 S PSJCGET(ORDID)=STATUS_"^"_STARTDT_"^"_STOPDT_"^"_SCHEDULE_"^"_DOSAGE_"^"_INFUSE_"^"_PSJNM_"^"_STARTDTF_"^"_STOPDTF_"^"_ORDDATE
"RTN","PSJCLNOC",118,0)
  ;IV additives and solutions
"RTN","PSJCLNOC",119,0)
 N ON1,PSJX,DDRUG,ADDITIVE,SOLUTION,PSJ0,PSJDNAM
"RTN","PSJCLNOC",120,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,ORDID,"AD",ON1)) Q:'ON1!(ON1'?1N.N)  D
"RTN","PSJCLNOC",121,0)
 . S PSJX=^PS(53.1,ORDID,"AD",ON1,0),PSJ0=$$IV0^PSJBLDOC("AD",+PSJX)
"RTN","PSJCLNOC",122,0)
 . S DDRUG=$P(PSJ0,U,2),PSJDNAM=$P(PSJ0,U)_" "_$P(PSJX,U,2)
"RTN","PSJCLNOC",123,0)
 . S PSJCGET(ORDID,"ADDITIVE",ON1)=PSJDNAM_"^"_DDRUG_"^"_ORDID_"^"_$P(PSJX,"^",3)
"RTN","PSJCLNOC",124,0)
 ; Pre-mix in the OC.
"RTN","PSJCLNOC",125,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,ORDID,"SOL",ON1)) Q:'ON1!(ON1'?1N.N)   D
"RTN","PSJCLNOC",126,0)
 . S PSJX=^PS(53.1,ORDID,"SOL",ON1,0)
"RTN","PSJCLNOC",127,0)
 . S PSJ0=$$IV0^PSJBLDOC("",+PSJX)
"RTN","PSJCLNOC",128,0)
 . S DDRUG=$P(PSJ0,U,2)
"RTN","PSJCLNOC",129,0)
 . S PSJDNAM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJCLNOC",130,0)
 . S PSJCGET(ORDID,"SOLUTION",ON1)=PSJDNAM_"^"_DDRUG_"^"_INFUSE
"RTN","PSJCLNOC",131,0)
 Q
"RTN","PSJCLNOC",132,0)
 ;
"RTN","PSJCLNOC",133,0)
DISPCLN(PSJP,PSJCLINF) ;
"RTN","PSJCLNOC",134,0)
 N DRGNAME,STATUS,STARTDT,STOPDT,SCHEDULE,ORDID,DOSAGE,DATA,PSJDSPON,PSJCON,PSJCDFN,PSJCGET,INFUSE,PSJCCODE,DURATION,STARTDTF,STOPDTF,ORDDATE
"RTN","PSJCLNOC",135,0)
 I $G(PSJSORT)>10 S PSJDSPON($P(PSJP(4),";",2))=""
"RTN","PSJCLNOC",136,0)
DISP2 ;
"RTN","PSJCLNOC",137,0)
 S PSJCON=PSJP(4),PSJCGET=""
"RTN","PSJCLNOC",138,0)
 S PSJCDFN=DFN
"RTN","PSJCLNOC",139,0)
 S ORDID=$P(PSJCON,";",2),ORDID=+ORDID
"RTN","PSJCLNOC",140,0)
 S PSJCCODE=$P(PSJCLINF,";",1)
"RTN","PSJCLNOC",141,0)
 S (DRGNAME,PSJNM)=PSJP(2)
"RTN","PSJCLNOC",142,0)
 D GET(PSJCON,PSJCDFN,ORDID,PSJCCODE,PSJNM,.PSJCGET)
"RTN","PSJCLNOC",143,0)
 S DATA="",DATA=PSJCGET(ORDID)
"RTN","PSJCLNOC",144,0)
 Q:DATA=""
"RTN","PSJCLNOC",145,0)
 S (STATUS,STARTDT,STOPDT,SCHEDULE,DOSAGE)=""
"RTN","PSJCLNOC",146,0)
 S STATUS=$P(DATA,"^",1),STARTDT=$P(DATA,"^",2),STOPDT=$P(DATA,"^",3),SCHEDULE=$P(DATA,"^",4),DOSAGE=$P(DATA,"^",5)
"RTN","PSJCLNOC",147,0)
 S STARTDTF=$P(DATA,"^",8),STOPDTF=$P(DATA,"^",9),ORDDATE=$P(DATA,"^",10)
"RTN","PSJCLNOC",148,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJCLNOC",149,0)
 W !,$J("Clinic Order: ",23)_DRGNAME_" ("_STATUS_")"
"RTN","PSJCLNOC",150,0)
 I $D(PSJCGET(ORDID,"ADDITIVE"))!($D(PSJCGET(ORDID,"SOLUTION"))) D IVDISP G EXIT
"RTN","PSJCLNOC",151,0)
 W !,$J("Schedule: ",23),SCHEDULE
"RTN","PSJCLNOC",152,0)
 W !,$J("Dosage: ",23),DOSAGE
"RTN","PSJCLNOC",153,0)
 I STARTDT=""&(ORDDATE'="") W !,$J("Order Date: ",23),ORDDATE
"RTN","PSJCLNOC",154,0)
 I STARTDT'="" W !,$J($S($G(STARTDTF):"Requested Start Date: ",1:"Start Date: "),23),STARTDT
"RTN","PSJCLNOC",155,0)
 E  W !,$J("Start Date: ",23),"********"
"RTN","PSJCLNOC",156,0)
 I STOPDT'="" W !,$J($S($G(STOPDTF):"Requested Stop Date: ",1:"Stop Date: "),23),STOPDT
"RTN","PSJCLNOC",157,0)
 E  W !,$J("Stop Date: ",23),"********"
"RTN","PSJCLNOC",158,0)
 W !
"RTN","PSJCLNOC",159,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJCLNOC",160,0)
EXIT ;
"RTN","PSJCLNOC",161,0)
 K PSJCGET
"RTN","PSJCLNOC",162,0)
 Q 
"RTN","PSJCLNOC",163,0)
 ;
"RTN","PSJCLNOC",164,0)
CLNDISP(PSJCLINF) ;
"RTN","PSJCLNOC",165,0)
 N DRGNAME,STATUS,STARTDT,STOPDT,SCHEDULE,ORDID,DOSAGE,DATA,PSJDSPON,PSJCON,PSJCDFN,PSJCGET,INFUSE,PSJCCODE,PSJP,STARTDTF,STOPDTF,ORDDATE
"RTN","PSJCLNOC",166,0)
 S PSJP(2)=PSJCLINF(3)
"RTN","PSJCLNOC",167,0)
 S PSJP(4)=PSJCLINF(2)
"RTN","PSJCLNOC",168,0)
 D DISP2
"RTN","PSJCLNOC",169,0)
 Q
"RTN","PSJCLNOC",170,0)
 ;
"RTN","PSJCLNOC",171,0)
IVDISP ;
"RTN","PSJCLNOC",172,0)
 N SEQ,ADATA,SDATA,DNAM,BOTTLE,AFLG,SFLG,SSEQ,SNAM,ADDS
"RTN","PSJCLNOC",173,0)
 S ADDS="",SEQ=0 F  S SEQ=$O(PSJCGET(ORDID,"ADDITIVE",SEQ)) Q:SEQ=""  D
"RTN","PSJCLNOC",174,0)
 .S ADATA=PSJCGET(ORDID,"ADDITIVE",SEQ)
"RTN","PSJCLNOC",175,0)
 .S DNAM=$P(ADATA,"^")
"RTN","PSJCLNOC",176,0)
 .Q:DNAM=DRGNAME
"RTN","PSJCLNOC",177,0)
 .S BOTTLE=$P(ADATA,"^",4)
"RTN","PSJCLNOC",178,0)
 .I '$G(AFLG) S ADDS=DNAM S:BOTTLE'="" ADDS=ADDS_" ("_BOTTLE_")"
"RTN","PSJCLNOC",179,0)
 .I $G(AFLG) S ADDS=ADDS_", "_DNAM S:BOTTLE'="" ADDS=ADDS_" ("_BOTTLE_")"
"RTN","PSJCLNOC",180,0)
 .W:'$G(AFLG) !,$J("Other Additive(s): ",23)
"RTN","PSJCLNOC",181,0)
 .S:'$G(AFLG) AFLG=1
"RTN","PSJCLNOC",182,0)
 I $G(AFLG) D MYWRITE^PSJMISC(ADDS,23,78)
"RTN","PSJCLNOC",183,0)
 S (SDATA,SNAM,INFUSE,SFLG)="",SSEQ=0
"RTN","PSJCLNOC",184,0)
 S SSEQ=0 F  S SSEQ=$O(PSJCGET(ORDID,"SOLUTION",SSEQ)) Q:SSEQ=""  D
"RTN","PSJCLNOC",185,0)
 .S SDATA=PSJCGET(ORDID,"SOLUTION",SSEQ)
"RTN","PSJCLNOC",186,0)
 .S SNAM=$P(SDATA,"^",1),INFUSE=$P(SDATA,"^",3)
"RTN","PSJCLNOC",187,0)
 .W:'$G(SFLG) !,$J("Solution(s): ",23)_SNAM_" "_INFUSE
"RTN","PSJCLNOC",188,0)
 .I $G(SFLG) W !?23,SNAM_" "_INFUSE
"RTN","PSJCLNOC",189,0)
 .S SFLG=1
"RTN","PSJCLNOC",190,0)
 W:SCHEDULE'="" !,$J("Schedule: ",23),SCHEDULE
"RTN","PSJCLNOC",191,0)
 I STARTDT=""&(ORDDATE'="") W !,$J("Order Date: ",23),ORDDATE
"RTN","PSJCLNOC",192,0)
 I STARTDT'="" W !,$J($S($G(STARTDTF):"Requested Start Date: ",1:"Start Date: "),23),STARTDT
"RTN","PSJCLNOC",193,0)
 E  W !,$J("Start Date: ",23),"********"
"RTN","PSJCLNOC",194,0)
 I STOPDT'="" W !,$J($S($G(STOPDTF):"Requested Stop Date: ",1:"Stop Date: "),23),STOPDT
"RTN","PSJCLNOC",195,0)
 E  W !,$J("Stop Date: ",23),"********"
"RTN","PSJCLNOC",196,0)
 W !
"RTN","PSJCLNOC",197,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJCLNOC",198,0)
 Q
"RTN","PSJCOMV")
0^48^B40386923
"RTN","PSJCOMV",1,0)
PSJCOMV ;BIR/CML3-FINISH COMPLEX IV ORDERS ENTERED THROUGH OE/RR ;02 Feb 2001  12:20 PM
"RTN","PSJCOMV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**110,127,267,257**;16 DEC 97;Build 105
"RTN","PSJCOMV",3,0)
 ;
"RTN","PSJCOMV",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJCOMV",5,0)
 ; Reference to ^%DTC is supported by DBIA 10000..
"RTN","PSJCOMV",6,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSJCOMV",7,0)
 ;
"RTN","PSJCOMV",8,0)
 ;
"RTN","PSJCOMV",9,0)
IV ; Move IV data in local variables to ^TMP
"RTN","PSJCOMV",10,0)
 Q:'PSJCOM  Q:ON'["P"
"RTN","PSJCOMV",11,0)
 M ^TMP("PSJCOM",$J,+ON)=^PS(53.1,+ON)
"RTN","PSJCOMV",12,0)
 S P(17)="N"
"RTN","PSJCOMV",13,0)
 K ND S ND(0)=+ON_U_+P(6)_U_$S(+P("MR"):+P("MR"),1:"")_U_$P(P("OT"),U)_U_U_U_"C",$P(ND(0),U,9)=P(17),$P(ND(0),U,21)=$G(P(21))
"RTN","PSJCOMV",14,0)
 S $P(ND(0),U,14,16)=P("LOG")_U_DFN_U_P("LOG"),$P(ND(0),U,24,26)=$G(P("RES"))_U_$G(P("OLDON"))_U_$G(P("NEWON")) S ND(2)=P(9)_U_P(2)_U_U_P(3)_U_P(11)_U_P(15),$P(ND(4),U,7,9)=+P("CLRK")_U_U_P("REN")
"RTN","PSJCOMV",15,0)
 S ND(8)=P(4)_U_P(23)_U_P("SYRS")_U_P(5)_U_P(8)_"^^"_P(7),ND(9)=$S($L(P("REM")_P("OPI")):P("REM")_U_P("OPI"),1:"")
"RTN","PSJCOMV",16,0)
 S:+$G(P("CLIN")) ^TMP("PSJCOM",$J,+ON,"DSS")=P("CLIN")
"RTN","PSJCOMV",17,0)
 F X=0,2,4,8,9 S ^TMP("PSJCOM",$J,+ON,X)=ND(X)
"RTN","PSJCOMV",18,0)
 S:'+$G(^TMP("PSJCOM",$J,+ON,.2)) $P(^(.2),U,1,3)=+P("PD")_U_P("DO")_U_$G(P("NAT"))
"RTN","PSJCOMV",19,0)
 F DRGT="AD","SOL" D:$D(DRG(DRGT)) PTD531
"RTN","PSJCOMV",20,0)
 I '+$P(PSJSYSP0,"^",9) D NEWNVAL^PSJCOM(ON,$S(+PSJSYSU=3:22005,1:22000))
"RTN","PSJCOMV",21,0)
 I +PSJSYSU=3,+$P(PSJSYSP0,U,9) D VFYIV Q
"RTN","PSJCOMV",22,0)
 I +PSJSYSU=1,+$P(PSJSYSP0,U,9),$G(PSJIRNF) D VFYIV
"RTN","PSJCOMV",23,0)
 I $G(PSIVENO),($P(^PS(53.1,+PSJORD,0),U,9)="N") D EN^VALM("PSJ LM IV INPT ACTIVE")
"RTN","PSJCOMV",24,0)
 Q
"RTN","PSJCOMV",25,0)
 ;
"RTN","PSJCOMV",26,0)
VFYIV ;
"RTN","PSJCOMV",27,0)
 Q:'PSJCOM
"RTN","PSJCOMV",28,0)
 D KILL531^PSJIMO1(DFN,"",+ON)
"RTN","PSJCOMV",29,0)
 I '$D(^TMP("PSJCOM",$J,+ON)) M ^TMP("PSJCOM",$J,+ON)=^PS(53.1,+ON) D
"RTN","PSJCOMV",30,0)
 . N CHILD,ORDER S ORDER=0 F  S ORDER=$O(^PS(53.1,"ACX",PSJCOM,ORDER)) Q:'ORDER  D
"RTN","PSJCOMV",31,0)
 .. I '$D(^TMP("PSJCOM",$J,+ORDER)) M ^TMP("PSJCOM",$J,+ORDER)=^PS(53.1,+ORDER)
"RTN","PSJCOMV",32,0)
 I ON["P" D
"RTN","PSJCOMV",33,0)
 . S P(17)="A"
"RTN","PSJCOMV",34,0)
 . S PSGORDP=ON ;Used in ACTLOG to update activity log in ^TMP
"RTN","PSJCOMV",35,0)
 . NEW PSGX S PSGX=$S($D(^TMP("PSJCOM2",$J,+ON,2.5)):$G(^TMP("PSJCOM2",$J,+ON,2.5)),1:$G(^TMP("PSJCOM2",$J,+ON,2.5))),PSGRSD=$P(PSGX,U),PSGRFD=$P(PSGX,U,3)
"RTN","PSJCOMV",36,0)
 . S:$D(^TMP("PSJCOM2",$J,+ON,0)) $P(^TMP("PSJCOM2",$J,+ON,0),"^",9)=P(17) S:'$D(^TMP("PSJCOM2",$J,+ON,0)) $P(^TMP("PSJCOM",$J,+ON,0),"^",9)=P(17) W "." ;D ^PSGOT
"RTN","PSJCOMV",37,0)
 D NEWNVAL^PSJCOM(ON,(PSJSYSU*10+22000)) W "."
"RTN","PSJCOMV",38,0)
 S VND4=$S('$D(^TMP("PSJCOM2",$J,+ON)):$G(^TMP("PSJCOM",$J,+ON,4)),1:$G(^TMP("PSJCOM2",$J,+ON,4)))
"RTN","PSJCOMV",39,0)
 S VND2P5=$$GETDUR^PSJLIVMD(DFN,ON,$E(ON,$L(ON)),1) I VND2P5]"" D
"RTN","PSJCOMV",40,0)
 . S:'$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM",$J,+ON,2.5)="^"_VND2P5 Q
"RTN","PSJCOMV",41,0)
 . S:$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM2",$J,+ON,2.5)="^"_VND2P5
"RTN","PSJCOMV",42,0)
 I $G(PSGRSD) D
"RTN","PSJCOMV",43,0)
 . S PSGRSD=$$ENDTC^PSGMI(PSGRSD) D NEWNVAL^PSJCOM(ON,6090,"Requested Start Date",PSGRSD)
"RTN","PSJCOMV",44,0)
 . S PSGRFD=$$ENDTC^PSGMI(PSGRFD) D NEWNVAL^PSJCOM(ON,6090,"Requested Stop Date",PSGRFD)
"RTN","PSJCOMV",45,0)
 K PSGRSD,PSGRFD,PSGALFN
"RTN","PSJCOMV",46,0)
 NEW X S X=0 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S X=1
"RTN","PSJCOMV",47,0)
 I +PSJSYSU=3,ON'["O",$S(X:0,'$P(VND4,"^",16):1,1:$P(VND4,"^",15)) ; D EN^PSGPEN(+ON)
"RTN","PSJCOMV",48,0)
 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9)
"RTN","PSJCOMV",49,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT,^TMP("PSJCOM",$J,+ON,4)=VND4
"RTN","PSJCOMV",50,0)
 S:'$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM",$J,+ON,4)=VND4 S:$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM2",$J,+ON,4)=VND4
"RTN","PSJCOMV",51,0)
 W:'$D(PSJSPEED) ! W !,"ORDER VERIFIED.",!
"RTN","PSJCOMV",52,0)
 I '$D(PSJSPEED) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSJCOMV",53,0)
 S VALMBCK="Q"
"RTN","PSJCOMV",54,0)
 S ^TMP("PSJCOM",$J)="A" S:$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM2",$J)="A" Q
"RTN","PSJCOMV",55,0)
 ;
"RTN","PSJCOMV",56,0)
PTD531 ; Move drug data from local array into ^TMP
"RTN","PSJCOMV",57,0)
 K ^TMP("PSJCOM",$J,DRGT) S ^TMP("PSJCOM",$J,+ON,DRGT,0)=$S(DRGT="AD":"^53.157^0^0",1:"^53.158^0^0")
"RTN","PSJCOMV",58,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSJCOMV",59,0)
 .S X1=$P(DRG(DRGT,X),U),Y=^TMP("PSJCOM",$J,+ON,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJCOMV",60,0)
 .S ^TMP("PSJCOM",$J,+ON,DRGT,0)=Y,Y=+X1_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^TMP("PSJCOM",$J,+ON,DRGT,+DRG,0)=Y
"RTN","PSJCOMV",61,0)
 Q
"RTN","PSJCOMV",62,0)
 ;
"RTN","PSJCOMV",63,0)
NEWIV ;Create new IV order in appropriate file format
"RTN","PSJCOMV",64,0)
 M ^TMP("PSJCOM2",$J,+ON)=^PS(53.1,+ON)
"RTN","PSJCOMV",65,0)
 S $P(^TMP("PSJCOM",$J,+ON,0),"^",9)="DE",P("OLDON")=+ON_"P",P("RES")="E"
"RTN","PSJCOMV",66,0)
 I +$P(PSJSYSP0,U,9) D NEWAIV Q
"RTN","PSJCOMV",67,0)
 S ND(0)=+ON_U_+P(6)_U_$S(+P("MR"):+P("MR"),1:"")_U_$P(P("OT"),U)_U_U_U_"C",$P(ND(0),U,9)=P(17),$P(ND(0),U,21)=$G(P(21))
"RTN","PSJCOMV",68,0)
 S $P(ND(0),U,14,16)=P("LOG")_U_DFN_U_P("LOG"),$P(ND(0),U,24,26)=$G(P("RES"))_U_$G(P("OLDON"))_U_$G(P("NEWON")) S ND(2)=P(9)_U_P(2)_U_U_P(3)_U_P(11)_U_P(15),$P(ND(4),U,7,9)=+P("CLRK")_U_U_P("REN")
"RTN","PSJCOMV",69,0)
 S ND(8)=P(4)_U_P(23)_U_P("SYRS")_U_P(5)_U_P(8)_"^^"_P(7),ND(9)=$S($L(P("REM")_P("OPI")):P("REM")_U_P("OPI"),1:"")
"RTN","PSJCOMV",70,0)
 S:+$G(P("CLIN")) ^TMP("PSJCOM2",$J,+ON,"DSS")=P("CLIN")
"RTN","PSJCOMV",71,0)
 F X=0,2,4,8,9 S ^TMP("PSJCOM2",$J,+ON,X)=ND(X)
"RTN","PSJCOMV",72,0)
 S:'+$G(^TMP("PSJCOM2",$J,+ON,.2)) $P(^(.2),U,1,3)=+P("PD")_U_P("DO")_U_$G(P("NAT"))
"RTN","PSJCOMV",73,0)
 I $G(P("PRNTON"))]"" S $P(^TMP("PSJCOM2",$J,+ON,.2),"^",8)=$G(P("PRNTON"))
"RTN","PSJCOMV",74,0)
 F DRGT="AD","SOL" D:$D(DRG(DRGT)) PTD5312
"RTN","PSJCOMV",75,0)
 D EN^VALM("PSJ LM IV INPT ACTIVE")
"RTN","PSJCOMV",76,0)
 Q
"RTN","PSJCOMV",77,0)
 ;
"RTN","PSJCOMV",78,0)
PTD5312 ; Move drug data from local array into ^TMP
"RTN","PSJCOMV",79,0)
 K ^TMP("PSJCOM2",$J,DRGT) S ^TMP("PSJCOM2",$J,+ON,DRGT,0)=$S(DRGT="AD":"^53.157^0^0",1:"^53.158^0^0")
"RTN","PSJCOMV",80,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSJCOMV",81,0)
 .S X1=$P(DRG(DRGT,X),U),Y=^TMP("PSJCOM2",$J,+ON,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJCOMV",82,0)
 .S ^TMP("PSJCOM2",$J,+ON,DRGT,0)=Y,Y=+X1_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^TMP("PSJCOM2",$J,+ON,DRGT,+DRG,0)=Y
"RTN","PSJCOMV",83,0)
 Q
"RTN","PSJCOMV",84,0)
 ;
"RTN","PSJCOMV",85,0)
NEWAIV ;Creates new IV order in the file 55 format
"RTN","PSJCOMV",86,0)
 N DA,DIK,ND,PSIVACT
"RTN","PSJCOMV",87,0)
 I '$D(PSGDT) D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJCOMV",88,0)
 S:'$D(P(21)) (P(21),P("21FLG"))="" S ND(0)=+ON,P(22)=$S(VAIN(4):+VAIN(4),1:.5) F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSJCOMV",89,0)
 S ND(.3)=$G(P("INS"))
"RTN","PSJCOMV",90,0)
 S $P(ND(0),U,17)="A",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(P("NAT"))_U_U_U_$G(P("PRNTON"))
"RTN","PSJCOMV",91,0)
 F X=0,1,3,.2,.3 S ^TMP("PSJCOM2",$J,+ON,X)=ND(X)
"RTN","PSJCOMV",92,0)
 S $P(^TMP("PSJCOM2",$J,+ON,2),U,1,4)=P("LOG")_U_+P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSJCOMV",93,0)
 S $P(^TMP("PSJCOM2",$J,+ON,2),U,11)=+P("CLRK")
"RTN","PSJCOMV",94,0)
 S:+$G(P("CLIN")) ^TMP("PSJCOM2",$J,+ON,"DSS")=P("CLIN")
"RTN","PSJCOMV",95,0)
 S:+$G(P("NINIT")) ^TMP("PSJCOM2",$J,+ON,4)=P("NINIT")_U_P("NINITDT")
"RTN","PSJCOMV",96,0)
 I +PSJSYSU=3 S $P(^TMP("PSJCOM2",$J,+ON,4),"^",4)=DUZ,$P(^TMP("PSJCOM2",$J,+ON,4),"^",5)=PSGDT,$P(^TMP("PSJCOM2",$J,+ON,4),"^",9)=1
"RTN","PSJCOMV",97,0)
 I +PSJSYSU=1 S $P(^TMP("PSJCOM2",$J,+ON,4),"^",10)=1
"RTN","PSJCOMV",98,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSJCOMV",99,0)
 Q
"RTN","PSJCOMV",100,0)
 ;
"RTN","PSJCOMV",101,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSJCOMV",102,0)
 K ^TMP("PSJCOM2",$J,+ON,DRGT) S ^TMP("PSJCOM2",$J,+ON,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSJCOMV",103,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSJCOMV",104,0)
 .S Y=^TMP("PSJCOM2",$J,+ON,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJCOMV",105,0)
 .S ^TMP("PSJCOM2",$J,+ON,DRGT,0)=Y,Y=$P(DRG(DRGT,X),U)_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^TMP("PSJCOM2",$J,+ON,DRGT,+DRG,0)=Y
"RTN","PSJCOMV",106,0)
 Q
"RTN","PSJGMRA")
0^31^B26285552
"RTN","PSJGMRA",1,0)
PSJGMRA ;BIR/MV - Retrieve and display Allergy data ;6 Jun 07 / 3:37 PM
"RTN","PSJGMRA",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,270,260,252,257**;16 DEC 97;Build 105
"RTN","PSJGMRA",3,0)
 ;
"RTN","PSJGMRA",4,0)
 ; Reference to ^PS(50.605 is supported by DBIA 696.
"RTN","PSJGMRA",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSJGMRA",6,0)
 ; Reference to ^TMP("GMRAOC" supported by DBIA 4848.
"RTN","PSJGMRA",7,0)
 ; Reference to GETDATA^GMRAOR supported by DBIA 4847.
"RTN","PSJGMRA",8,0)
 ; Reference to PSODGAL1 supported by DBIA 5764.
"RTN","PSJGMRA",9,0)
 ; Reference to ^PS(50.7 supported by DBIA 2180.
"RTN","PSJGMRA",10,0)
 ;
"RTN","PSJGMRA",11,0)
EN(DFN,PSJDD) ;
"RTN","PSJGMRA",12,0)
 ;DFN - Patient IEN
"RTN","PSJGMRA",13,0)
 ;PSJDD - ^PSDRUG IEN
"RTN","PSJGMRA",14,0)
 Q:'+$G(DFN)
"RTN","PSJGMRA",15,0)
 Q:'+$G(PSJDD)
"RTN","PSJGMRA",16,0)
 N PTR,GMRAING,PSJACK,PSJCLCNT,PSJFLG,PSJVACL,DIW,DIWF,DIWI,DIWL,DIWR,DIWT,DIWTC,DIWX,PSJNEW,X,Y,PSODRUG,PSODFN,PSJAOC
"RTN","PSJGMRA",17,0)
 K ^TMP("GMRAOC",$J),^TMP($J,"PSJCLS"),PSJVACL,^TMP("PSJDAI",$J),^TMP("PSJDAOC",$J)
"RTN","PSJGMRA",18,0)
 S DIC=50,DIC(0)="MQZV",X=PSJDD D ^DIC K DIC Q:Y=-1
"RTN","PSJGMRA",19,0)
 S PSODRUG("IEN")=PSJDD,PSODRUG("VA CLASS")=$P(Y(0),"^",2),PSODRUG("NAME")=$P(Y(0),"^")
"RTN","PSJGMRA",20,0)
 S:+$G(^PSDRUG(+Y,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSJGMRA",21,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSJDD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSJGMRA",22,0)
 ;changed in psj*5*260
"RTN","PSJGMRA",23,0)
 S PSODFN=DFN G ^PSODGAL1
"RTN","PSJGMRA",24,0)
 ;
"RTN","PSJGMRA",25,0)
 S PSJACK=0
"RTN","PSJGMRA",26,0)
 S PTR=$P($G(^PSDRUG(PSJDD,"ND")),U)_"."_$P($G(^PSDRUG(PSJDD,"ND")),U,3)
"RTN","PSJGMRA",27,0)
 I +PTR S PSJACK=$$NDF()
"RTN","PSJGMRA",28,0)
 S PSJCLCNT=$$CLASS()
"RTN","PSJGMRA",29,0)
 D DISP
"RTN","PSJGMRA",30,0)
 K ^TMP("GMRAOC",$J),^TMP($J,"PSJCLS")
"RTN","PSJGMRA",31,0)
 Q
"RTN","PSJGMRA",32,0)
NDF() ;Process NDF drug
"RTN","PSJGMRA",33,0)
 NEW PSJLP
"RTN","PSJGMRA",34,0)
 S PSJACK=0
"RTN","PSJGMRA",35,0)
 K ^TMP("GMRAOC",$J)
"RTN","PSJGMRA",36,0)
 S PSJACK=$$ORCHK^GMRAOR(DFN,"DR",PTR)
"RTN","PSJGMRA",37,0)
 Q PSJACK
"RTN","PSJGMRA",38,0)
CLASS() ;
"RTN","PSJGMRA",39,0)
 NEW PSJLEN,PSJLOC,PSJCLCHK,PSJCLNM,PSJDDCL,INVCL,INVCNT
"RTN","PSJGMRA",40,0)
 S PSJDDCL=$P($G(^PSDRUG(+PSJDD,0)),U,2)
"RTN","PSJGMRA",41,0)
 S PSJLEN=4,PSJCLCNT=0
"RTN","PSJGMRA",42,0)
 I $E(PSJDDCL,1,4)="CN10" S PSJLEN=5 ;look at 5 chars if ANALGESICS
"RTN","PSJGMRA",43,0)
 ;
"RTN","PSJGMRA",44,0)
 K GMRADRCL,^TMP("GMRAOC",$J,"APC"),^TMP($J,"PSJCLS")
"RTN","PSJGMRA",45,0)
 D GETDATA^GMRAOR(DFN)
"RTN","PSJGMRA",46,0)
 I '$D(^TMP("GMRAOC",$J,"APC")) Q 0
"RTN","PSJGMRA",47,0)
 ;
"RTN","PSJGMRA",48,0)
 S PSJVACL="" F  S PSJVACL=$O(^TMP("GMRAOC",$J,"APC",PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",49,0)
 .;*PSJ*5*270 - Check for invalid drug class, print warning message
"RTN","PSJGMRA",50,0)
 . S PSJLOC=^TMP("GMRAOC",$J,"APC",PSJVACL),PSJCLNM=$P($G(^PS(50.605,+$O(^PS(50.605,"B",PSJVACL,0)),0)),U,2)
"RTN","PSJGMRA",51,0)
 . I $G(PSJCLNM)="" S INVCL(PSJVACL)="" Q
"RTN","PSJGMRA",52,0)
 . S PSJVACL(PSJVACL)=PSJVACL_U_PSJCLNM_" ("_PSJLOC_")"
"RTN","PSJGMRA",53,0)
 . S PSJCLCNT=PSJCLCNT+1
"RTN","PSJGMRA",54,0)
 I $D(INVCL) D
"RTN","PSJGMRA",55,0)
 . W $C(7),!!,"WARNING: The following drug class does not exist in the VA DRUG CLASS file",!
"RTN","PSJGMRA",56,0)
 . W "         (#50.605).  Please do a manual Drug-Allergy order check and notify",!
"RTN","PSJGMRA",57,0)
 . W "         the pharmacy ADPAC for follow up.",!
"RTN","PSJGMRA",58,0)
 . S INVCNT="" F  S INVCNT=$O(INVCL(INVCNT)) Q:INVCNT=""  W !,"VA Drug Class: ",INVCNT
"RTN","PSJGMRA",59,0)
 . W ! S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR W !
"RTN","PSJGMRA",60,0)
 ;
"RTN","PSJGMRA",61,0)
 S PSJCLCHK=0,PSJVACL="" F  S PSJVACL=$O(PSJVACL(PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",62,0)
 .I $E(PSJDDCL,1,PSJLEN)=$E(PSJVACL,1,PSJLEN) D
"RTN","PSJGMRA",63,0)
 .. S PSJCLCHK=PSJCLCHK+1
"RTN","PSJGMRA",64,0)
 .. S ^TMP($J,"PSJCLS",PSJCLCHK)=PSJVACL_" "_$P(PSJVACL(PSJVACL),"^",2)
"RTN","PSJGMRA",65,0)
 K ^TMP("GMRAOC",$J)
"RTN","PSJGMRA",66,0)
 Q PSJCLCHK
"RTN","PSJGMRA",67,0)
DISP ;
"RTN","PSJGMRA",68,0)
 NEW PSJLOC,PSJNIEN,PSJNM,PSJVACL,X,PSJX
"RTN","PSJGMRA",69,0)
 S PSJFLG=0
"RTN","PSJGMRA",70,0)
 S PSJX=$O(^TMP("GMRAOC",$J,"APC",""))
"RTN","PSJGMRA",71,0)
 I '$G(PSJACK)&'$G(PSJCLCNT) Q
"RTN","PSJGMRA",72,0)
 S PSJFLG=1
"RTN","PSJGMRA",73,0)
 W $C(7),!!,"A Drug-Allergy Reaction exists for this medication and/or class!"
"RTN","PSJGMRA",74,0)
 W !!,?3,"Drug: "_$P($G(^PSDRUG(PSJDD,0)),"^")
"RTN","PSJGMRA",75,0)
 I PSJACK D
"RTN","PSJGMRA",76,0)
 . S PSJX=""
"RTN","PSJGMRA",77,0)
 . F X=0:0 S X=$O(GMRAING(X)) Q:'X  D
"RTN","PSJGMRA",78,0)
 .. S PSJX=PSJX_$S(PSJX="":"",1:", ")_GMRAING(X)
"RTN","PSJGMRA",79,0)
 . I PSJX]"" W !?6,"Ingredients: " D MYWRITE^PSJMISC(PSJX,19,75)
"RTN","PSJGMRA",80,0)
 D:PSJCLCNT DISPCL
"RTN","PSJGMRA",81,0)
 D:(PSJFLG&'$D(PSJDGCK)) INTERV("ALLERGY")
"RTN","PSJGMRA",82,0)
 Q
"RTN","PSJGMRA",83,0)
DISPCL ;Display class(es)
"RTN","PSJGMRA",84,0)
 NEW PSJX,X
"RTN","PSJGMRA",85,0)
 Q:'$D(^TMP($J,"PSJCLS"))
"RTN","PSJGMRA",86,0)
 S PSJX=""
"RTN","PSJGMRA",87,0)
 S PSJVACL="" F  S PSJVACL=$O(^TMP($J,"PSJCLS",PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",88,0)
 . S PSJX=PSJX_$S(PSJX="":"",1:", ")_^TMP($J,"PSJCLS",PSJVACL)
"RTN","PSJGMRA",89,0)
 . S PSJFLG=1
"RTN","PSJGMRA",90,0)
 I PSJX]"" D
"RTN","PSJGMRA",91,0)
 . W !,?6,"Drug Class: "
"RTN","PSJGMRA",92,0)
 . D MYWRITE^PSJMISC(PSJX,19,75)
"RTN","PSJGMRA",93,0)
 Q
"RTN","PSJGMRA",94,0)
 ;
"RTN","PSJGMRA",95,0)
INTERV(PSJRXREQ,PSJDD1) ;Prompt if user to log an intervention for significant interaction
"RTN","PSJGMRA",96,0)
 ;PSPRXREQ - intervention type
"RTN","PSJGMRA",97,0)
 ;PSJDD1 - Prospective drug name
"RTN","PSJGMRA",98,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJGMRA",99,0)
 I $G(PSGORQF)=1 Q
"RTN","PSJGMRA",100,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")=$S($G(PSJRXREQ)="ALLERGY":"YES",1:"NO")
"RTN","PSJGMRA",101,0)
 I $G(PSJDD1)]"" S DIR("A")="Do you want to Intervene with "_PSJDD1_"? "
"RTN","PSJGMRA",102,0)
 W ! D ^DIR
"RTN","PSJGMRA",103,0)
 S DIR("?",1)="Answer 'YES' if you DO want to enter an intervention for this medication,"
"RTN","PSJGMRA",104,0)
 S DIR("?")="       'NO' if you DON'T want to enter an intervention for this medication,"
"RTN","PSJGMRA",105,0)
 I Y S PSGP=DFN D ^PSJRXI W !
"RTN","PSJGMRA",106,0)
 Q 
"RTN","PSJGMRA",107,0)
RINTERV(PSJRXREQ,PSJDD1) ;Prompt user to log an intervention for critical interaction
"RTN","PSJGMRA",108,0)
 ;PSPRXREQ - intervention type
"RTN","PSJGMRA",109,0)
 ;PSJDD1 - Prospective drug name
"RTN","PSJGMRA",110,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJGMRA",111,0)
 K PSGORQF
"RTN","PSJGMRA",112,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="NO"
"RTN","PSJGMRA",113,0)
 I $G(PSJDD1)]"" S DIR("A")="Do you want to Continue with "_PSJDD1_"? "
"RTN","PSJGMRA",114,0)
 S DIR("?",1)="Enter 'NO' if you wish to exit without continuing with the order,",DIR("?")="or 'YES' to continue with the order entry process."
"RTN","PSJGMRA",115,0)
 D ^DIR
"RTN","PSJGMRA",116,0)
 I 'Y S PSGORQF=1 S VALMBCK="R" Q
"RTN","PSJGMRA",117,0)
 I Y S PSGP=DFN D ^PSJRXI W !
"RTN","PSJGMRA",118,0)
 Q
"RTN","PSJHL10")
0^39^B75460781
"RTN","PSJHL10",1,0)
PSJHL10  ;BIR/LDT,BSJ-VALIDATE INCOMING HL7 DATA/CREATE NEW ORDER ;30 MAY 07
"RTN","PSJHL10",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**58,78,91,109,110,195,257**;16 DEC 97;Build 105
"RTN","PSJHL10",3,0)
 ;
"RTN","PSJHL10",4,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJHL10",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA# 2178.
"RTN","PSJHL10",6,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL10",7,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJHL10",8,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJHL10",9,0)
 ; Reference to ^PSBAPIPM is supported by DBIA# 3564.
"RTN","PSJHL10",10,0)
 ; Reference to ^ORERR is supported by DBIA# 2187.
"RTN","PSJHL10",11,0)
 ;
"RTN","PSJHL10",12,0)
VALID ;
"RTN","PSJHL10",13,0)
 ;Call BCMA for rest of data
"RTN","PSJHL10",14,0)
 D MOB^PSBAPIPM(PSJHLDFN,+PSJORDER)
"RTN","PSJHL10",15,0)
 N DATA0,CHK S DATA0=$G(^TMP("PSB",$J,0)) I DATA0=-1 S PSREASON="""YOUR ORDER WAS NOT SAVED. EXIT BCMA, SIGN BACK IN, THEN TRY AGAIN.""" D ERROR Q
"RTN","PSJHL10",16,0)
 I $P(DATA0,"^")'=PSJHLDFN S PSREASON="Patient does not match" D ERROR Q
"RTN","PSJHL10",17,0)
 I $P(DATA0,"^",2)'=+PSJORDER S PSREASON="Order number does not match" D ERROR Q
"RTN","PSJHL10",18,0)
 N VAIP S DFN=PSJHLDFN,VAIP("D")=$G(LOGIN) D IN5^VADPT
"RTN","PSJHL10",19,0)
 ;If UD do UD set/validate.
"RTN","PSJHL10",20,0)
 I $P(DATA0,"^",3)="" D UDSET
"RTN","PSJHL10",21,0)
 ;If IV do IV set/validate.
"RTN","PSJHL10",22,0)
 I $P(DATA0,"^",3)]"" D IVSET
"RTN","PSJHL10",23,0)
 D:'CHK EN1^PSJHL2(PSJHLDFN,"OK",PSGORD),EN1^PSJHL2(PSJHLDFN,"SC",PSGORD),EN1^PSJHL2(PSJHLDFN,"ZV",PSGORD),MOBR^PSBAPIPM(PSJHLDFN,+PSJORDER,PSGORD)
"RTN","PSJHL10",24,0)
 Q
"RTN","PSJHL10",25,0)
 ;
"RTN","PSJHL10",26,0)
ERROR ;Sends error msg to CPRS, logs error in OE/RR Errors file
"RTN","PSJHL10",27,0)
 S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(PSREASON,.PSJMSG),MOBR^PSBAPIPM(PSJHLDFN,+PSJORDER)
"RTN","PSJHL10",28,0)
 D EN1^PSJHLERR(PSJHLDFN,"OC",PSJORDER,PSREASON) S QFLG=1 K ^TMP("PSJNVO",$J),^TMP("PSB",$J)
"RTN","PSJHL10",29,0)
 Q
"RTN","PSJHL10",30,0)
 ;
"RTN","PSJHL10",31,0)
UDSET ;Set up UD variables
"RTN","PSJHL10",32,0)
 N PSGPR,PSGMR,PSGSM,PSGHSM,PSGST,PSGP,PSGSCH,PSGPDRG,PSGDO,PSGNESD,PSGNEFD,PSGOEAV,PSJSYSU,PSGS0XT,PSGS0Y
"RTN","PSJHL10",33,0)
 S PSGPR=PROVIDER,PSGMR=ROUTE,PSGSM=0,PSGHSM="",PSGST="O",PSGP=PSJHLDFN,PSGSCH=SCHEDULE,PSGPDRG=PSITEM
"RTN","PSJHL10",34,0)
 S (PSGNESD,PSGNEFD)=+$P(DATA0,"^",5),PSGOEAV=1,PSJSYSU=1,PSGS0XT="O",PSGS0Y=""
"RTN","PSJHL10",35,0)
 I $G(DOSE)]"",$G(UNIT)]"" S PSGDO=DOSE_UNIT
"RTN","PSJHL10",36,0)
 I $G(PSGDO)']"",$G(INSTR)]"" S PSGDO=$$TRIM^XLFSTR(INSTR,"R"," ")
"RTN","PSJHL10",37,0)
 S CHK=""
"RTN","PSJHL10",38,0)
 S ND=U_PSGPR_U_PSGMR_"^U^"_PSGSM_U_PSGHSM_U_PSGST_"^^"_"E"_"^^^^^"_LOGIN_U_PSGP_U_LOGIN
"RTN","PSJHL10",39,0)
 D CHK("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSJHL10",40,0)
 I CHK D ERROR Q
"RTN","PSJHL10",41,0)
 I PSGSCH'="STAT",PSGSCH'="NOW" S PSREASON="Invalid Schedule" S CHK=1 D ERROR Q
"RTN","PSJHL10",42,0)
 I ORDCON'="V",ORDCON'="P" S PSREASON="Invalid Nature of Order" S CHK=1 D ERROR Q
"RTN","PSJHL10",43,0)
 D:'$D(^PS(55,PSGP,0)) ENSET0^PSGNE3(PSGP) S $P(^PS(55,PSGP,5.1),U,2)=PSGPR,PSGOEPR=PSGPR
"RTN","PSJHL10",44,0)
 S ND0=ND D ENGNA^PSGOETO
"RTN","PSJHL10",45,0)
 I $D(^PS(51.2,+PSGMR,0)),$P(^(0),U,3)]"" S PSGMRN=$P(^(0),U,3)
"RTN","PSJHL10",46,0)
 S ND0=DA_ND0
"RTN","PSJHL10",47,0)
 S $P(ND0,"^",21)=PSJORDER
"RTN","PSJHL10",48,0)
 S ND2=PSGSCH_U_PSGNESD_"^^"_PSGNEFD_U_PSGS0Y_U_PSGS0XT_"^^^^"_+VAIP(5)
"RTN","PSJHL10",49,0)
 S $P(ND4,U,7)=DUZ I PSGOEAV,PSJSYSU D
"RTN","PSJHL10",50,0)
 .S $P(ND4,U,PSJSYSU,PSJSYSU+1)=DUZ_U_+$P(DATA0,"^",5),$P(ND4,U,+PSJSYSU=1+9)=1,$P(ND4,U,+PSJSYSU=3+9)=0
"RTN","PSJHL10",51,0)
 .S $P(ND4,U,9,10)=+$P(ND4,U,9)_U_+$P(ND4,U,10)
"RTN","PSJHL10",52,0)
 .I '$P(ND4,U,9) S ^PS(55,"APV",PSGP,DA)=""
"RTN","PSJHL10",53,0)
 .I '$P(ND4,U,10) S ^PS(55,"NPV",PSGP,DA)=""
"RTN","PSJHL10",54,0)
 .I $P(ND4,U,9) K ^PS(55,"APV",PSGP,DA)
"RTN","PSJHL10",55,0)
 .I $P(ND4,U,10) K ^PS(55,"NPV",PSGP,DA)
"RTN","PSJHL10",56,0)
 S F="^PS(55,"_PSGP_",5,"_DA_",",@(F_"0)")=ND0
"RTN","PSJHL10",57,0)
 ;naked reference on the four (4) lines below refer to the full ref to ^PS(55,PSGP,5,DA created by indirection using variable F
"RTN","PSJHL10",58,0)
 I $G(INSTR)]"" S @(F_".3)")=INSTR
"RTN","PSJHL10",59,0)
 S @(F_".2)")=PSGPDRG_U_PSGDO S $P(^(.2),U,3,6)=$G(ORDCON)_"^"_$E(PRIORITY,2)_"^"_$G(DOSE)_"^"_$G(UNIT)
"RTN","PSJHL10",60,0)
 S @(F_"2)")=ND2,^(4)=ND4
"RTN","PSJHL10",61,0)
 S (C,X)=0 F  S X=$O(^TMP("PSB",$J,700,X)) Q:'X  S D=$G(^(X,0)) I D S C=C+1,@(F_"1,"_C_",0)")=$P(D,U,1,2),@(F_"1,""B"","_+D_","_C_")")=""
"RTN","PSJHL10",62,0)
 S:C @(F_"1,0)")=U_"55.07P^"_C_U_C
"RTN","PSJHL10",63,0)
 I $D(PROCOM) D
"RTN","PSJHL10",64,0)
 .;naked refs on the three lines below refer to the full ref to ^PS(55,PSGP,5,DA created by indrection using variable F
"RTN","PSJHL10",65,0)
 .I '$D(@(F_"12,0)")) S ^(0)=U_55.0612_U_0_U_0
"RTN","PSJHL10",66,0)
 .S JJ=0 F  S JJ=$O(PROCOM(JJ)) Q:'JJ  S $P(@(F_"12,0)"),"^",3,4)=JJ_"^"_JJ,@(F_"12,"_JJ_",0)")=PROCOM(JJ)
"RTN","PSJHL10",67,0)
 S @(F_"6)")=$$ENPC^PSJHL11("U",180)
"RTN","PSJHL10",68,0)
 D CIMOU^PSJIMO1(PSGP,DA)
"RTN","PSJHL10",69,0)
 D CRA^PSGOETO
"RTN","PSJHL10",70,0)
 L -^PS(55,DFN,5,DA)
"RTN","PSJHL10",71,0)
 S PSGORD=DA_"U"
"RTN","PSJHL10",72,0)
OUT ;
"RTN","PSJHL10",73,0)
 Q
"RTN","PSJHL10",74,0)
 ;
"RTN","PSJHL10",75,0)
CHK(X,Y,Z)      ;Check for required fields
"RTN","PSJHL10",76,0)
 ; Input: X="^^"_MED ROUTE_"^^^^"_SCH TYPE
"RTN","PSJHL10",77,0)
 ;        Y=ORDERABLE ITEM_"^"_DOSAGE ORDERED
"RTN","PSJHL10",78,0)
 ;        Z=SCHEDULE_"^"_START DATE/TIME_"^^"_STOP DATE/TIME
"RTN","PSJHL10",79,0)
 D CHK^PSJHL7(X,Y,Z)
"RTN","PSJHL10",80,0)
 Q
"RTN","PSJHL10",81,0)
 ;
"RTN","PSJHL10",82,0)
DDOK(PSJF,OI) ;Check to be sure all dispense drugs that are active in the
"RTN","PSJHL10",83,0)
 ;order are valid.
"RTN","PSJHL10",84,0)
 ; Input: PSJF - File root of the order including all but the IEN of 
"RTN","PSJHL10",85,0)
 ;               the drug. (EX "^PS(53.45,X,2,")
"RTN","PSJHL10",86,0)
 ;        OI   - IEN of the order's orderable item
"RTN","PSJHL10",87,0)
 ; Output: 1 - all active DD's in the order are valid
"RTN","PSJHL10",88,0)
 ;         0 - no DD's active DD's or at least one active is invalid
"RTN","PSJHL10",89,0)
 N DDCNT,ND,PSJ,PSJ1 S (PSJ1,DDCNT)=0
"RTN","PSJHL10",90,0)
 I '$D(PSGDT) D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJHL10",91,0)
 I '$O(@(PSJF_"0)")) Q 1
"RTN","PSJHL10",92,0)
 ; Naked reference below refers to ^PS(53.45, created using indirection in variable PSJF
"RTN","PSJHL10",93,0)
 F PSJ=0:0 S PSJ=$O(@(PSJF_PSJ_")")) Q:'PSJ  S ND=$G(@(PSJF_PSJ_",0)"))  D
"RTN","PSJHL10",94,0)
 .S DDCNT=DDCNT+1
"RTN","PSJHL10",95,0)
 .S PSJ1=$S('$D(^PSDRUG(+ND,0)):1,$P($G(^(2)),U,3)'["U":1,+$G(^(2))'=+OI:1,$G(^("I"))="":0,1:^("I")'>PSGDT)
"RTN","PSJHL10",96,0)
 Q $S('DDCNT:0,PSJ1=1:0,1:1)
"RTN","PSJHL10",97,0)
 ;
"RTN","PSJHL10",98,0)
IVSET ;
"RTN","PSJHL10",99,0)
 N P,DFN S DFN=PSJHLDFN,CHK=""
"RTN","PSJHL10",100,0)
 F X=1:1:23 S P(X)=""
"RTN","PSJHL10",101,0)
 S (P(2),P(3),P("NINITDT"))=+$P(DATA0,"^",5),P("LOG")=LOGIN,P(4)=$P(DATA0,"^",3),P(5)=$S(P(4)="S":$P(DATA0,"^",4),1:""),P(6)=PROVIDER,P(8)=$G(INFRT),P(9)=$G(SCHEDULE),P(17)="E",P(21)=PSJORDER,P(22)=LOC
"RTN","PSJHL10",102,0)
 S:P(4)="P" P(9)=$P(DATA0,"^",6)
"RTN","PSJHL10",103,0)
 I P(4)="S",P(5)=1 S P(9)=$P(DATA0,"^",6)
"RTN","PSJHL10",104,0)
 S P("MR")=$S(P(4)="P":$O(^PS(51.2,"B","IV PIGGYBACK",0)),1:$O(^PS(51.2,"B","INTRAVENOUS",0)))
"RTN","PSJHL10",105,0)
 S (P("CLRK"),P("NINIT"))=CLERK,P("PD")=PSITEM,(P("IVRM"),P("SYRS"),P("CLIN"),P("FRES"),P("OPI"))="",P("RES")=ROC,P("PRY")=$E(PRIORITY,2),P("REM")=""
"RTN","PSJHL10",106,0)
 I $$SCHREQ^PSJLIVFD(.P),P(15)'>0 N P15 S P15=$$INTERVAL^PSIVUTL(.P)
"RTN","PSJHL10",107,0)
 D CHKIV I CHK D ERROR Q
"RTN","PSJHL10",108,0)
 D SETN
"RTN","PSJHL10",109,0)
 D NEW55^PSIVORFB
"RTN","PSJHL10",110,0)
 N DA,DIK,ND,PSIVACT
"RTN","PSJHL10",111,0)
 S ND(0)=+ON55 F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSJHL10",112,0)
 S ND(.3)=$G(P("INS"))
"RTN","PSJHL10",113,0)
 S $P(ND(0),U,17)="E",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(ORDCON) F X=0,1,3,.2,.3 S ^PS(55,DFN,"IV",+ON55,X)=ND(X)
"RTN","PSJHL10",114,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,1,4)=P("LOG")_U_P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSJHL10",115,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,11)=+P("CLRK")
"RTN","PSJHL10",116,0)
 I +$G(P("CLIN")) S $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=P("CLIN") D:$P(P("CLIN"),"^")'="" CIMOI^PSJIMO1(DFN,ON55)
"RTN","PSJHL10",117,0)
 S:+$G(P("NINIT")) ^PS(55,DFN,"IV",+ON55,4)=P("NINIT")_U_P("NINITDT")_"^^^^^^^^"_"1"
"RTN","PSJHL10",118,0)
 S ^PS(55,"APIV",DFN,+ON55)=""
"RTN","PSJHL10",119,0)
 I $D(PROCOM) D
"RTN","PSJHL10",120,0)
 .I '$D(^PS(55,DFN,"IV",+ON55,5,0)) S ^(0)=U_55.1115_U_0_U_0
"RTN","PSJHL10",121,0)
 .S JJ=0 F  S JJ=$O(PROCOM(JJ)) Q:'JJ  S $P(^PS(55,DFN,"IV",+ON55,5,0),"^",3,4)=JJ_"^"_JJ,^PS(55,DFN,"IV",+ON55,5,JJ,0)=PROCOM(JJ)
"RTN","PSJHL10",122,0)
 S ^PS(55,DFN,"IV",+ON55,3)=$$ENPC^PSJHL11("V",60)
"RTN","PSJHL10",123,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSJHL10",124,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK
"RTN","PSJHL10",125,0)
 L -^PS(55,DFN,"IV",DA)
"RTN","PSJHL10",126,0)
 S PSGORD=ON55
"RTN","PSJHL10",127,0)
 Q
"RTN","PSJHL10",128,0)
 ;
"RTN","PSJHL10",129,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSJHL10",130,0)
 K ^PS(55,DFN,"IV",+ON55,DRGT) S ^PS(55,DFN,"IV",+ON55,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSJHL10",131,0)
 F X=0:0 S X=$O(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),X)) Q:'X  D
"RTN","PSJHL10",132,0)
 .S Y=^PS(55,DFN,"IV",+ON55,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJHL10",133,0)
 .S ^PS(55,DFN,"IV",+ON55,DRGT,0)=Y,^PS(55,DFN,"IV",+ON55,DRGT,+DRG,0)=$P(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),X,0),"^")_"^"_$P(^TMP("PSJNVO",$J,DRGT,+DRG,0),"^",2)
"RTN","PSJHL10",134,0)
 Q
"RTN","PSJHL10",135,0)
 ;
"RTN","PSJHL10",136,0)
SETN ;Set up patient 0 node if needed.
"RTN","PSJHL10",137,0)
 I '$D(^PS(55,DFN,0)) K DO,DA,DD,DIC,PSIVFN S:$D(^(5.1)) PSIVFN=^(5.1) K:$D(PSIVFN) ^(5.1) S (DINUM,X)=DFN,DIC(0)="L",DIC="^PS(55," D FILE^DICN S:$D(PSIVFN) ^PS(55,DFN,5.1)=PSIVFN D  K DIC,PSIVFN,DO,DA,DD
"RTN","PSJHL10",138,0)
 .; Mark PSJ and PSO as converted
"RTN","PSJHL10",139,0)
 .S $P(^PS(55,DFN,5.1),"^",11)=2
"RTN","PSJHL10",140,0)
 Q
"RTN","PSJHL10",141,0)
 ;
"RTN","PSJHL10",142,0)
CHKIV ;Validate IV data
"RTN","PSJHL10",143,0)
 N OK S OK=0
"RTN","PSJHL10",144,0)
 I "APS"'[P(4) S CHK=1,PSREASON="Invalid IV Type" Q
"RTN","PSJHL10",145,0)
 I P(9)="",P(4)="P" S CHK=1,PSREASON="Piggyback IV Type requires a schedule" Q
"RTN","PSJHL10",146,0)
 I P(4)="S",P(5)=1,P(9)="" S CHK=1,PSREASON="Intermittent Syringe IV Type requires a schedule" Q
"RTN","PSJHL10",147,0)
 I P(9)'="STAT",(P(9)'="NOW"),P(9)'="" S CHK=1,PSREASON="Invalid Schedule" Q
"RTN","PSJHL10",148,0)
 I ORDCON'="V",ORDCON'="P" S CHK=1,PSREASON="Invalid Nature of Order" Q
"RTN","PSJHL10",149,0)
 I +$G(^TMP("PSB",$J,800,0))=0,+$G(^TMP("PSB",$J,900,0))=0 S CHK=1,PSREASON="IV orders must have at least one additive or solution" Q
"RTN","PSJHL10",150,0)
 I +$G(^TMP("PSB",$J,900,0))=0,P(4)'="P" S CHK=1,PSREASON="You must have at least one solution for this order." Q
"RTN","PSJHL10",151,0)
 I +$G(^TMP("PSB",$J,800,0))'=+$G(^TMP("PSJNVO",$J,"AD",0)) S CHK=1,PSREASON="Number of additives in BCMA & CPRS do not match." Q
"RTN","PSJHL10",152,0)
 I +$G(^TMP("PSB",$J,900,0))'=+$G(^TMP("PSJNVO",$J,"SOL",0)) S CHK=1,PSREASON="Number of solutions in BCMA & CPRS do not match." Q
"RTN","PSJHL10",153,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F DRGI=0:0 S DRGI=$O(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),DRGI)) Q:'DRGI  S DRG=$G(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),DRGI,0)) D DRG,@DRGT Q:CHK=1
"RTN","PSJHL10",154,0)
 I 'OK,'CHK S CHK=1,PSREASON="The Orderable Item does not match any of the additives or solutions in this order" Q
"RTN","PSJHL10",155,0)
 Q
"RTN","PSJHL10",156,0)
 ;
"RTN","PSJHL10",157,0)
AD ;Check additives
"RTN","PSJHL10",158,0)
 I '$D(^PS(FIL,+DRG,0)) S CHK=1,PSREASON="Additive "_+DRG_" does not exist in the additive file" Q
"RTN","PSJHL10",159,0)
 ;Naked reference below refers to ^PS(52.6,+DRG,0)
"RTN","PSJHL10",160,0)
 I $P(^(0),"^",11)=PSITEM S OK=1
"RTN","PSJHL10",161,0)
 I $$ENU^PSIVUTL(+DRG)'=$P($P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)," ",2,99)!(+$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)'>0) S CHK=1,PSREASON="Invalid strength entered for additive "_+DRG Q
"RTN","PSJHL10",162,0)
 Q
"RTN","PSJHL10",163,0)
SOL ;Check solutions
"RTN","PSJHL10",164,0)
 I '$D(^PS(FIL,+DRG,0)) S CHK=1,PSREASON="Solution "_+DRG_" does not exist in the solution file" Q
"RTN","PSJHL10",165,0)
 ;Naked reference below refers to ^PS(52.7,+DRG,0)
"RTN","PSJHL10",166,0)
 I $P(^(0),"^",11)=PSITEM S OK=1
"RTN","PSJHL10",167,0)
 I +$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)>9999!(+$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)'>0) S CHK=1,PSREASON="Volume on "_+DRG_" is an invalid strength" Q
"RTN","PSJHL10",168,0)
 Q
"RTN","PSJHL10",169,0)
DRG ;Check to be sure additive/solutions are active
"RTN","PSJHL10",170,0)
 I $S('$G(^PS(FIL,+DRG,"I")):0,^("I")>DT:0,1:1) S CHK=1,PSREASON="An additive or solution is inactive" Q
"RTN","PSJHL10",171,0)
 Q
"RTN","PSJHLV")
0^38^B21975577
"RTN","PSJHLV",1,0)
PSJHLV ;BIR/CML3-VERIFY (MAKE ACTIVE) ORDERS ;4/8/99  08:16
"RTN","PSJHLV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**39,42,78,92,127,133,268,257**;16 DEC 97;Build 105
"RTN","PSJHLV",3,0)
 ;
"RTN","PSJHLV",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180.
"RTN","PSJHLV",5,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHLV",6,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJHLV",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA# 2789.
"RTN","PSJHLV",8,0)
 ;
"RTN","PSJHLV",9,0)
EN(PSJHLDFN,PSGORD) ;
"RTN","PSJHLV",10,0)
VFY ; change status, move to 55, and change label record
"RTN","PSJHLV",11,0)
 N PSJPWD,VAIP,DFN,PSGP,PSGORDP S (DFN,PSGP)=PSJHLDFN D IN5^VADPT S:VAIP(5)]"" PSJPWD=+VAIP(5) G:VAIP(5)']"" DONE
"RTN","PSJHLV",12,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,4)'="U" D IV Q
"RTN","PSJHLV",13,0)
 N PSJSYSP S PSJSYSP=+NURSEACK
"RTN","PSJHLV",14,0)
 N PSGDT D NOW^%DTC S PSGDT=%
"RTN","PSJHLV",15,0)
 S CHK=0 D DDCHK G:CHK DONE
"RTN","PSJHLV",16,0)
 D CHK($G(^PS(53.1,+PSGORD,0)),$G(^(.2)),$G(^(2)))
"RTN","PSJHLV",17,0)
 G:CHK DONE
"RTN","PSJHLV",18,0)
 S PSGORDP=PSGORD
"RTN","PSJHLV",19,0)
 ;
"RTN","PSJHLV",20,0)
 N PSJRPND0 S PSJRPND0=^PS(53.1,+PSGORD,0) I $P(PSJRPND0,U,24)="R" D
"RTN","PSJHLV",21,0)
 .N PSGORDR,PSJPRIO,PSJSCHED,FILE55N0
"RTN","PSJHLV",22,0)
 .S PSGORDR=$P(PSJRPND0,U,25)
"RTN","PSJHLV",23,0)
 .Q:'$$LS^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJHLV",24,0)
 .N OEORD,OOEORD,FILE55,FILE55N0,FILE55N2 S FILE55="^PS(55,"_PSJHLDFN_$S($P(PSJRPND0,U,4)="U":",5,",1:",""IV"","),FILE55N0=FILE55_+PSGORDR_",0)",FILE55N2=FILE55_+PSGORDR_",2)"
"RTN","PSJHLV",25,0)
 .S OEORD=$P(PSJRPND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD N PSGSD S PSGSD=$P(@FILE55N2,"^",2) D
"RTN","PSJHLV",26,0)
 ..D EXPOE^PSGOER(PSJHLDFN,PSGORD,+$$LASTREN^PSJLMPRI(PSJHLDFN,PSGORD))
"RTN","PSJHLV",27,0)
 .K DA,DR,DIE S PSGORDP=PSGORD,DIE="^PS(53.1,",DA=+PSGORD,DR="28////A;104////@" W "." D ^DIE
"RTN","PSJHLV",28,0)
 .D START^PSGOTR(PSGORD,+PSGORDR) I OEORD D
"RTN","PSJHLV",29,0)
 ..K DA,DR,DIE S DA(1)=PSJHLDFN,DA=+PSGORDR,DIE=FILE55,DR=$S(DIE["IV":110,1:66)_"////"_+OEORD D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSJHLV",30,0)
 ..D EN1^PSJHL2(PSJHLDFN,"SC",PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJHLV",31,0)
 ..S PSGORD=PSGORDR
"RTN","PSJHLV",32,0)
 ;
"RTN","PSJHLV",33,0)
 S DIE="^PS(53.1,",DA=+PSGORD,DR="28////A" D ^DIE I $P(PSJRPND0,U,24)'="R" D ^PSGOT
"RTN","PSJHLV",34,0)
 D CIMOU^PSJIMO1(PSJHLDFN,+PSGORD,"",PSGORDP)
"RTN","PSJHLV",35,0)
 S DA=+PSGORD,DA(1)=PSJHLDFN,PSGAL("C")=22010
"RTN","PSJHLV",36,0)
 D ^PSGAL5 S VND4=$G(^PS(55,PSJHLDFN,5,DA,4)) I $P(PSJRPND0,U,24)="R",$P(VND4,U,4) D
"RTN","PSJHLV",37,0)
 .K DA,DIE,DR I $P(VND4,U,4)<$$LASTREN^PSJLMPRI(PSJHLDFN,PSGORDP) S DIE="^PS(55,"_PSJHLDFN_",5,",DA(1)=PSJHLDFN,DA=+PSGORD,DR="18////@;19////@" D ^DIE
"RTN","PSJHLV",38,0)
 .S $P(VND4,U,3,4)=""
"RTN","PSJHLV",39,0)
 S $P(VND4,"^",10)=1
"RTN","PSJHLV",40,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",1,2)=+NURSEACK_"^"_PSGDT,^PS(55,PSJHLDFN,5,+PSGORD,4)=VND4
"RTN","PSJHLV",41,0)
 I '$P(VND4,U,9) S ^PS(55,"APV",PSJHLDFN,+PSGORD)=""
"RTN","PSJHLV",42,0)
 I '$P(VND4,U,10) S ^PS(55,"ANV",PSJHLDFN,+PSGORD)=""
"RTN","PSJHLV",43,0)
 I $P(VND4,U,10) K ^PS(55,"ANV",PSJHLDFN,+PSGORD)
"RTN","PSJHLV",44,0)
 D:$D(PSGORDP) ACTLOG^PSGOEV(PSGORDP,PSJHLDFN,PSGORD)
"RTN","PSJHLV",45,0)
 D EN1^PSJHL2(PSJHLDFN,"SC",+PSGORD_"U")
"RTN","PSJHLV",46,0)
 ; ** This is where the Automated Dispensing Machine hook is called. Do NOT DELETE or change this location **
"RTN","PSJHLV",47,0)
 D NEWJ^PSJADM
"RTN","PSJHLV",48,0)
 ; ** END of Inferface Hook **
"RTN","PSJHLV",49,0)
 Q
"RTN","PSJHLV",50,0)
 ;
"RTN","PSJHLV",51,0)
IV ;
"RTN","PSJHLV",52,0)
 NEW DRG,DRGI,DRGN,DRGT,FIL,ON,ON55,P,PSJORD,VADM,VAIN
"RTN","PSJHLV",53,0)
 S ON=PSGORD,PSIVCHG=0,PSJSYSU=1
"RTN","PSJHLV",54,0)
 D INP^VADPT
"RTN","PSJHLV",55,0)
 D GT531^PSIVORFA(PSJHLDFN,PSGORD),ACTIVE^PSIVORC2
"RTN","PSJHLV",56,0)
 K PSIVCHG,PSJIVORF,PSJORF,PSJORIFN,PSJORL,PSJORNP,PSJPINIT,PSJSYSL,PSJSYSU,PSJSYSW,PSJSYSW0
"RTN","PSJHLV",57,0)
 Q
"RTN","PSJHLV",58,0)
DONE ;
"RTN","PSJHLV",59,0)
 K CHK,DA,DIE,DRGF,DP,DR,ND,PSGAL,PSGODA,PSGPD,VND4 Q
"RTN","PSJHLV",60,0)
 ;
"RTN","PSJHLV",61,0)
CHK(ND,DRG,ND2) ; checks for data in required fields
"RTN","PSJHLV",62,0)
 ; Input: ND  - ^(PS(53.1,PSGORD,0)
"RTN","PSJHLV",63,0)
 ;        DRG - ^(.2)
"RTN","PSJHLV",64,0)
 ;        ND2 - ^(2)
"RTN","PSJHLV",65,0)
 S CHK="" I DRG,$D(^PS(50.7,+DRG,0))
"RTN","PSJHLV",66,0)
 E  S CHK=1
"RTN","PSJHLV",67,0)
 I ND="" S CHK=CHK_23
"RTN","PSJHLV",68,0)
 E  S CHK=CHK_$S($P(ND,"^",3):"",1:2)_$S($P(ND,"^",7)]"":"",1:3)
"RTN","PSJHLV",69,0)
 ;The naked reference on the line below refers to the variable ND
"RTN","PSJHLV",70,0)
 ;which is ^PS(53.1,PSGORD,0).
"RTN","PSJHLV",71,0)
 I ND2="" S CHK=CHK_$S('$D(^(0)):4,$P(^(0),"^",7)="OC":"",1:4)_56
"RTN","PSJHLV",72,0)
 E  S CHK=CHK_$S($P(ND2,"^")]"":"",ND="":4,$P(ND,"^",7)="OC":"",1:4)_$S($P(ND2,"^",2):"",1:5)_$S($P(ND2,"^",4):"",1:6)
"RTN","PSJHLV",73,0)
 I $$CHECK^PSGOE8(PSJSYSP),$P(DRG,U,2)="" S CHK=CHK_8
"RTN","PSJHLV",74,0)
 K PSGDFLG,PSGPFLG S PSGDI=0
"RTN","PSJHLV",75,0)
 S:'$$OIOK^PSGOE2(+DRG) PSGPFLG=1
"RTN","PSJHLV",76,0)
 Q
"RTN","PSJHLV",77,0)
 ;
"RTN","PSJHLV",78,0)
DDCHK ; dispense drug check
"RTN","PSJHLV",79,0)
 S DRGF="^PS("_$S(PSGORD["P":"53.1,"_+PSGORD,1:"55,"_PSJHLDFN_",5,"_+PSGORD)_",",CHK=$S('$O(@(DRGF_"1,0)")):7,1:0)
"RTN","PSJHLV",80,0)
 S PSGPD=$G(@(DRGF_".2)"))
"RTN","PSJHLV",81,0)
 S CHK=$S('$$DDOK(DRGF_"1,",PSGPD):7,1:0)
"RTN","PSJHLV",82,0)
 Q
"RTN","PSJHLV",83,0)
 ;
"RTN","PSJHLV",84,0)
DDOK(PSJF,OI) ;Check to be sure all dispense drugs that are active in the
"RTN","PSJHLV",85,0)
  ;order are valid.
"RTN","PSJHLV",86,0)
  ; Input: PSJF - File root of the order including all but the IEN of 
"RTN","PSJHLV",87,0)
  ;               the drug. (EX "^PS(53.1,X,1,")
"RTN","PSJHLV",88,0)
  ;        OI   - IEN of the order's orderable item
"RTN","PSJHLV",89,0)
  ; Output: 1 - all active DD's in the order are valid
"RTN","PSJHLV",90,0)
  ;         0 - no DD's active DD's or at least one active is invalid
"RTN","PSJHLV",91,0)
  N DDCNT,ND,PSJ,X S (X,DDCNT)=0
"RTN","PSJHLV",92,0)
  I '$O(@(PSJF_"0)")) Q 1
"RTN","PSJHLV",93,0)
  F PSJ=0:0 S PSJ=$O(@(PSJF_PSJ_")")) Q:'PSJ!X  S ND=$G(@(PSJF_PSJ_",0)"))  D
"RTN","PSJHLV",94,0)
  .I $P(ND,U,3),($P(ND,U,3)'>PSGDT) Q
"RTN","PSJHLV",95,0)
  .S DDCNT=DDCNT+1
"RTN","PSJHLV",96,0)
  .S X=$S('$D(^PSDRUG(+ND,0)):1,$P($G(^(2)),U,3)'["U":1,+$G(^(2))'=+OI:1,$G(^("I"))="":0,1:^("I")'>PSGDT)
"RTN","PSJHLV",97,0)
  Q $S('DDCNT:0,X=1:0,1:1)
"RTN","PSJHLV",98,0)
  ;
"RTN","PSJIMO1")
0^43^B32765352
"RTN","PSJIMO1",1,0)
PSJIMO1 ;BIR/LE-IMO UTILITIES AND XREFS ;16 Mar 99 / 10:22 AM
"RTN","PSJIMO1",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**257**;16 DEC 97;Build 105
"RTN","PSJIMO1",3,0)
 ;
"RTN","PSJIMO1",4,0)
IMO(CLINICS) ;called from ENCD^PSGFILED
"RTN","PSJIMO1",5,0)
 W !!,"Verifying IMO clinic cross references...",!
"RTN","PSJIMO1",6,0)
 N CLINFLG,IMOCLIEN,PSJIMOCL,PSJCLIN,FLAG S FLAG=""
"RTN","PSJIMO1",7,0)
 S (CLINFLG,CLINIC,PSJIMOCL,IMOCLIEN)=""
"RTN","PSJIMO1",8,0)
 F  S IMOCLIEN=$O(CLINICS(IMOCLIEN)) Q:IMOCLIEN=""  S PSJIMOCL=$$GET1^DIQ(53.46,IMOCLIEN,.01,"I"),CLINFLG=$$GET1^DIQ(44,PSJIMOCL,2802,"I") D
"RTN","PSJIMO1",9,0)
 .I 'CLINFLG D IMOKILL(PSJIMOCL) Q
"RTN","PSJIMO1",10,0)
 .I CLINFLG D IMOSET(PSJIMOCL)
"RTN","PSJIMO1",11,0)
 I FLAG W !,"IMO cross references have been updated.",!
"RTN","PSJIMO1",12,0)
 Q
"RTN","PSJIMO1",13,0)
 ;
"RTN","PSJIMO1",14,0)
IMOSET(PSJCLIN) ;
"RTN","PSJIMO1",15,0)
 ;Clinic order means Yes is answered to ADMINISTER INPATIENT MEDS field in file 44, a clinic and appointment date/time is defined.
"RTN","PSJIMO1",16,0)
 ;Q:$D(^PS("CIMOCLU",CLINIC))!($D(^PS("CIMOCLI",CLINIC)))
"RTN","PSJIMO1",17,0)
 N CLNDAYS,PSJAPTDT,PSJTODAY,X1,X2,PATIENT,PSJSTDT,PS55IEN,PS531IEN,PSJXREF,PSJTYPE,APPTDT,PSJUTMP,PSJSTART
"RTN","PSJIMO1",18,0)
 S CLNDAYS=$$GET1^DIQ(53.46,CLINIC,6)
"RTN","PSJIMO1",19,0)
 S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",20,0)
 D NOW^%DTC S (X1,PSJTODAY)=%,X2=-CLNDAYS D C^%DTC S PSJSTART=X
"RTN","PSJIMO1",21,0)
 ;FILE 55
"RTN","PSJIMO1",22,0)
 F PSJXREF="AUDC","AIVC" S PSJSTDT=PSJSTART F  S PSJSTDT=$O(^PS(55,PSJXREF,PSJSTDT)) Q:PSJSTDT=""  D
"RTN","PSJIMO1",23,0)
 .S PATIENT="" F  S PATIENT=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT)) Q:PATIENT=""  S PS55IEN="" F  S PS55IEN=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT,PS55IEN)) Q:PS55IEN=""  D
"RTN","PSJIMO1",24,0)
 ..I PSJXREF="AUDC" S PSJAPTDT=$$GET1^DIQ(55.06,PS55IEN_","_PATIENT_",",131)
"RTN","PSJIMO1",25,0)
 ..I PSJXREF="AIVC" S PSJAPTDT=$$GET1^DIQ(55.01,PS55IEN_","_PATIENT_",",139)
"RTN","PSJIMO1",26,0)
 ..Q:PSJAPTDT=""
"RTN","PSJIMO1",27,0)
 ..S:PSJXREF="AUDC" ^PS(55,"CIMOU",PATIENT,PSJCLIN,PSJSTDT,PATIENT,PS55IEN)=""
"RTN","PSJIMO1",28,0)
 ..S:PSJXREF="AIVC" ^PS(55,PATIENT,"IV","CIMOI",PSJCLIN,PSJSTDT,PS55IEN)=""
"RTN","PSJIMO1",29,0)
 ..S ^PS(55,$S(PSJXREF="AUDC":"CIMOCLU",1:"CIMOCLI"),PSJCLIN,PATIENT,PS55IEN)=""
"RTN","PSJIMO1",30,0)
 ..S FLAG=1
"RTN","PSJIMO1",31,0)
 ;
"RTN","PSJIMO1",32,0)
 ;FILE 53.1
"RTN","PSJIMO1",33,0)
 S (PATIENT,PS531IEN)=""
"RTN","PSJIMO1",34,0)
 F  S PATIENT=$O(^PS(53.1,"AD",PSJCLIN,PATIENT)) Q:PATIENT=""  F  S PS531IEN=$O(^PS(53.1,"AD",PSJCLIN,PATIENT,PS531IEN)) Q:PS531IEN=""  D
"RTN","PSJIMO1",35,0)
 .K PSJUTMP D GETS^DIQ(53.1,PS531IEN,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",36,0)
 .S (APPTDT,PSJTYPE)=""
"RTN","PSJIMO1",37,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",126,"I")) APPTDT=PSJUTMP(53.1,PS531IEN_",",126,"I")
"RTN","PSJIMO1",38,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",28,"I")) PSJTYPE=PSJUTMP(53.1,PS531IEN_",",28,"I")
"RTN","PSJIMO1",39,0)
 .Q:PSJTYPE'="P"&(PSJTYPE'="N")
"RTN","PSJIMO1",40,0)
 .Q:APPTDT=""!'CLINFLG
"RTN","PSJIMO1",41,0)
 .S ^PS(53.1,"CIMO",PATIENT,PSJCLIN,PS531IEN)="",FLAG=1
"RTN","PSJIMO1",42,0)
 Q
"RTN","PSJIMO1",43,0)
 ;
"RTN","PSJIMO1",44,0)
IMOKILL(CLINIC) ;
"RTN","PSJIMO1",45,0)
 I $D(^PS(55,"CIMOCLU",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",46,0)
 .K ^PS(55,"CIMOU",PATIENT,CLINIC)
"RTN","PSJIMO1",47,0)
 I $D(^PS(55,"CIMOCLI",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",48,0)
 .K ^PS(55,PATIENT,"IV","CIMOI",CLINIC)
"RTN","PSJIMO1",49,0)
 K ^PS(55,"CIMOCLU",CLINIC),^PS(55,"CIMOCLI",CLINIC)
"RTN","PSJIMO1",50,0)
 Q
"RTN","PSJIMO1",51,0)
 ;
"RTN","PSJIMO1",52,0)
CIMOU(PSGP,PSJDA55,PSCLINIC,PSODA531) ;IMO UNIT DOSE FILE 55 CROSS REFERENCE
"RTN","PSJIMO1",53,0)
 N PSJCLINI,CLINFLG
"RTN","PSJIMO1",54,0)
 I '$G(PSCLINIC) S PSCLINIC="",PSCLINIC=$$GET1^DIQ(55.06,+PSJDA55_","_PSGP_",",130,"I")
"RTN","PSJIMO1",55,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",56,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",57,0)
 Q:'CLINFLG
"RTN","PSJIMO1",58,0)
 D GETS^DIQ(55.06,+PSJDA55_","_PSGP_",","34;131","I","PSJCLINI")
"RTN","PSJIMO1",59,0)
 I CLINFLG&($G(PSJCLINI(55.06,+PSJDA55_","_PSGP_",","131","I"))) D
"RTN","PSJIMO1",60,0)
 .S ^PS(55,"CIMOU",PSGP,PSCLINIC,PSJCLINI(55.06,+PSJDA55_","_PSGP_",","34","I"),PSGP,+PSJDA55)=""
"RTN","PSJIMO1",61,0)
 .S ^PS(55,"CIMOCLU",PSCLINIC,PSGP,+PSJDA55)=""
"RTN","PSJIMO1",62,0)
 I $G(PSODA531) D KILL531(PSGP,PSCLINIC,PSODA531)
"RTN","PSJIMO1",63,0)
 Q
"RTN","PSJIMO1",64,0)
 ;
"RTN","PSJIMO1",65,0)
CIMOI(DFN,PSJDA55,PSCLINIC,PSODA531) ;IMO IV FILE 55 CROSS REFERENCE
"RTN","PSJIMO1",66,0)
 N PSJCLINI,CLINFLG
"RTN","PSJIMO1",67,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(55.01,+PSJDA55_","_DFN_",",136,"I")
"RTN","PSJIMO1",68,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",69,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",70,0)
 Q:'CLINFLG
"RTN","PSJIMO1",71,0)
 D GETS^DIQ(55.01,+PSJDA55_","_DFN_",",".03","I","PSJCLINI")
"RTN","PSJIMO1",72,0)
 I $D(PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I")) D
"RTN","PSJIMO1",73,0)
 .S ^PS(55,DFN,"IV","CIMOI",PSCLINIC,PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I"),+PSJDA55)=""
"RTN","PSJIMO1",74,0)
 .S ^PS(55,"CIMOCLI",PSCLINIC,DFN,+PSJDA55)=""
"RTN","PSJIMO1",75,0)
 I $G(PSODA531) D KILL531(DFN,PSCLINIC,+PSODA531)
"RTN","PSJIMO1",76,0)
 Q
"RTN","PSJIMO1",77,0)
 ;
"RTN","PSJIMO1",78,0)
KILL531(PSJCLPAT,PSCLINIC,PSODA531) ;
"RTN","PSJIMO1",79,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(53.1,+PSODA531_","_PSJCLPAT_",",113,"I")
"RTN","PSJIMO1",80,0)
 Q:PSCLINIC=""!(PSODA531="")
"RTN","PSJIMO1",81,0)
 I $D(^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSODA531)) K ^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSODA531)
"RTN","PSJIMO1",82,0)
 Q
"RTN","PSJIMO1",83,0)
 ;
"RTN","PSJIMO1",84,0)
GETCLN(PSGP,ORDER) ; Return Clinic IEN for a given patient/order combination
"RTN","PSJIMO1",85,0)
 I '$G(ORDER) Q ""
"RTN","PSJIMO1",86,0)
 N CLN S CLN=$S(ORDER["P":$G(^PS(53.1,+ORDER,"DSS")),ORDER["V":$G(^PS(55,PSGP,"IV",+ORDER,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+ORDER,8)),1:"")
"RTN","PSJIMO1",87,0)
 I 'CLN,(ORDER=+ORDER) D
"RTN","PSJIMO1",88,0)
 .I $D(^PS(53.1,"ACX",+ORDER)) N PSJORD S PSJORD=0 F  S PSJORD=$O(^PS(53.1,"ACX",+ORDER,PSJORD)) Q:'PSJORD!$G(CLN)  S CLN=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSJIMO1",89,0)
 .I $D(^PS(55,"ACX",+ORDER)) N ACX2,PSJORD S ACX2="" F  S ACX2=$O(^PS(55,"ACX",+ORDER,ACX2)) Q:'ACX2!$G(CLN)  S PSJORD=0 F  S PSJORD=$O(^PS(55,"ACX",+ORDER,ACX2,PSJORD)) Q:'PSJORD!$G(CLN)  D
"RTN","PSJIMO1",90,0)
 ..S CLN=$S(PSJORD["P":$G(^PS(53.1,+PSJORD,"DSS")),PSJORD["V":$G(^PS(55,PSGP,"IV",+PSJORD,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+PSJORD,8)),1:"")
"RTN","PSJIMO1",91,0)
 Q +CLN
"RTN","PSJIMO1",92,0)
 ;
"RTN","PSJIMO1",93,0)
CHECK() ;
"RTN","PSJIMO1",94,0)
 N PSJCFLAG,PSJAPPTD,X
"RTN","PSJIMO1",95,0)
 S X=0
"RTN","PSJIMO1",96,0)
 S PSJCFLAG=$$GET1^DIQ(44,X2(2),2802,"I")
"RTN","PSJIMO1",97,0)
 S PSJAPPTD=$$GET1^DIQ(55.06,DA_","_X2(1)_",",131,"I")
"RTN","PSJIMO1",98,0)
 S:PSJCFLAG&(PSJAPPTD'="") X=1
"RTN","PSJIMO1",99,0)
 Q X
"RTN","PSJIMO1",100,0)
 ;
"RTN","PSJIMO1",101,0)
CHECK2() ;
"RTN","PSJIMO1",102,0)
 N PSJCFLAG,X,PSJAPPTD
"RTN","PSJIMO1",103,0)
 S X=0
"RTN","PSJIMO1",104,0)
 S PSJCFLAG=$$GET1^DIQ(44,X2(1),2802,"I")
"RTN","PSJIMO1",105,0)
 S PSJAPPTD=$$GET1^DIQ(55.01,DA_","_DA(1)_",",139,"I")
"RTN","PSJIMO1",106,0)
 S:PSJCFLAG&(PSJAPPTD'="") X=1
"RTN","PSJIMO1",107,0)
 Q X
"RTN","PSJIMO1",108,0)
 ;
"RTN","PSJIMO1",109,0)
CHECK3() ;
"RTN","PSJIMO1",110,0)
 N PSJCFLAG,PSJAPPTD,X
"RTN","PSJIMO1",111,0)
 S X=0
"RTN","PSJIMO1",112,0)
 S PSJCFLAG=$$GET1^DIQ(44,X2(2),2802,"I")
"RTN","PSJIMO1",113,0)
 S PSJAPPTD=$$GET1^DIQ(53.1,DA_","_X2(1)_",",126,"I")
"RTN","PSJIMO1",114,0)
 S:PSJCFLAG&(PSJAPPTD'="") X=1
"RTN","PSJIMO1",115,0)
 Q X
"RTN","PSJIMO1",116,0)
 ;
"RTN","PSJIMO1",117,0)
TEST ;
"RTN","PSJIMO1",118,0)
 N PSJTESCL,PSJTESPA
"RTN","PSJIMO1",119,0)
TEST2 ;
"RTN","PSJIMO1",120,0)
 S (PSJTESCL,PSJTESPA)=""
"RTN","PSJIMO1",121,0)
 R !,"CLINIC: ",PSJTESCL:60 Q:'$T  Q:PSJTESCL="^"!(PSJTESCL="")
"RTN","PSJIMO1",122,0)
 R !,"PATIENT: ",PSJTESPA:60 Q:'$T  G TEST2:PSJTESPA=""!(PSJTESPA="^")
"RTN","PSJIMO1",123,0)
 ;
"RTN","PSJIMO1",124,0)
 K ^PS(55,394,"IV","CIMOI",PSJTESCL)
"RTN","PSJIMO1",125,0)
 K ^PS(55,"CIMOCLI",PSJTESCL)
"RTN","PSJIMO1",126,0)
 K ^PS(55,"CIMOU",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",127,0)
 K ^PS(55,"CIMOCLU",PSJTESCL)
"RTN","PSJIMO1",128,0)
 K ^PS(53.1,"CIMO",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",129,0)
 W !,"DELETED",!
"RTN","PSJIMO1",130,0)
 Q
"RTN","PSJLIACT")
0^49^B50131468
"RTN","PSJLIACT",1,0)
PSJLIACT ;BIR/MV-IV ACTION ;28 Jul 98 / 8:50 AM
"RTN","PSJLIACT",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**15,47,62,58,82,97,80,110,111,134,181,247,260,275,257**;16 DEC 97;Build 105
"RTN","PSJLIACT",3,0)
 ;
"RTN","PSJLIACT",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJLIACT",5,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA 2410.
"RTN","PSJLIACT",6,0)
 ;
"RTN","PSJLIACT",7,0)
DC ; Discontinue order
"RTN","PSJLIACT",8,0)
 K PSGORQF
"RTN","PSJLIACT",9,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",10,0)
 S PSJCOM=+$S(PSJORD["V":$P($G(^PS(55,DFN,"IV",+PSJORD,.2)),"^",8),1:$P($G(^PS(53.1,+PSJORD,.2)),"^",8))
"RTN","PSJLIACT",11,0)
 I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSJORD)
"RTN","PSJLIACT",12,0)
 I PSJCOM F  W !!,"Do you want to discontinue this order" S %=1 D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSJLIACT",13,0)
 I PSJCOM,%'=1 S VALMBK="" Q
"RTN","PSJLIACT",14,0)
 I $G(ON55)["P",$G(PSIVOORD) S PSJORD=ON55 ;*247 - Correct DCing newly copied orders
"RTN","PSJLIACT",15,0)
 I PSJORD["V" D DC^PSIVORA D:'$G(PSJOCFLG) EN^PSJLIORD(DFN,ON) Q
"RTN","PSJLIACT",16,0)
 I PSJORD["P" N ON S ON=PSJORD D DISCONT^PSIVORC
"RTN","PSJLIACT",17,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",18,0)
 Q
"RTN","PSJLIACT",19,0)
ACEDIT ; Display LM screen and AC and EDit actions
"RTN","PSJLIACT",20,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",21,0)
 S VALMBCK=$S($G(PSIVACEP):"Q",1:"R")
"RTN","PSJLIACT",22,0)
 Q
"RTN","PSJLIACT",23,0)
AEEXIT ; Call for EXIT CODE in PSJ LM IV AC/EDIT
"RTN","PSJLIACT",24,0)
 K PSGORQF
"RTN","PSJLIACT",25,0)
 D:ON["V" GT55^PSIVORFB
"RTN","PSJLIACT",26,0)
 I ON["P" D GT531^PSIVORFA(DFN,ON) D:P("OT")'="I" GTDATA^PSJLIFN
"RTN","PSJLIACT",27,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",28,0)
 K PSIVENO
"RTN","PSJLIACT",29,0)
 Q
"RTN","PSJLIACT",30,0)
EDIT ; Edit order
"RTN","PSJLIACT",31,0)
 K PSIVFN1 NEW PSIVNBD
"RTN","PSJLIACT",32,0)
 I $D(PSGACT),PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJLIACT",33,0)
 D EDIT1
"RTN","PSJLIACT",34,0)
 Q:$D(PSIVNBD)!($G(PSIVCOPY)&'$G(PSIVENO))
"RTN","PSJLIACT",35,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",36,0)
 S VALMBCK=$S($G(PSIVFN1):"Q",1:"R")
"RTN","PSJLIACT",37,0)
 Q
"RTN","PSJLIACT",38,0)
EDIT1 ;
"RTN","PSJLIACT",39,0)
 K PSGORQF
"RTN","PSJLIACT",40,0)
 ;Ensure P() is defined
"RTN","PSJLIACT",41,0)
 I $D(P)<10 S XQORQUIT=1,P("PON")="",PSIVNBD=1 D  Q
"RTN","PSJLIACT",42,0)
 .W !,"WARNING: An error has occurred. Changes will not be saved"
"RTN","PSJLIACT",43,0)
 .D PAUSE^VALM1
"RTN","PSJLIACT",44,0)
 .S VALMBCK="Q"
"RTN","PSJLIACT",45,0)
 I "ANP"'[P(17) W !,"You cannot edit an inactive order" D PAUSE^VALM1 Q
"RTN","PSJLIACT",46,0)
 S:$G(ON55)="" ON55=$G(PSJORD)
"RTN","PSJLIACT",47,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",48,0)
 ;* Edit a new back door order
"RTN","PSJLIACT",49,0)
 I ($G(ON55)["V"&($G(P("21FLG"))="")) D  Q
"RTN","PSJLIACT",50,0)
 . D GSTRING^PSIVORE1,GTFLDS^PSIVORFE
"RTN","PSJLIACT",51,0)
 . I $G(ON55)["V",'$G(DONE) D OK^PSIVORE
"RTN","PSJLIACT",52,0)
 . S VALMBCK="Q",PSIVNBD=1
"RTN","PSJLIACT",53,0)
 ;* Edit an active order
"RTN","PSJLIACT",54,0)
 I $G(ON55)["V" NEW PSJEDIT1 D E^PSIVOPT1 D  Q
"RTN","PSJLIACT",55,0)
 . I $G(PSJIVBD) K PSJIVBD D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",56,0)
 I $G(ON55)["P" D EDIT^PSIVORC ;Edit incomplete order.
"RTN","PSJLIACT",57,0)
 K P("OVRIDE")
"RTN","PSJLIACT",58,0)
 Q
"RTN","PSJLIACT",59,0)
ACCEPT ; Accept order
"RTN","PSJLIACT",60,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",61,0)
 ;Accept IV from back door.
"RTN","PSJLIACT",62,0)
 I $G(PSJIVBD) K PSJIVBD D OK^PSIVORE S VALMBCK="Q" Q
"RTN","PSJLIACT",63,0)
 ;D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","") Q:$G(PSGORQF)
"RTN","PSJLIACT",64,0)
 I ON["V" D ACCEPT^PSIVOPT1 Q
"RTN","PSJLIACT",65,0)
 S PSIVFN1=1
"RTN","PSJLIACT",66,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIACT",67,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",68,0)
 Q
"RTN","PSJLIACT",69,0)
R ; Renewal
"RTN","PSJLIACT",70,0)
 K PSGORQF
"RTN","PSJLIACT",71,0)
 S PSJREN=1
"RTN","PSJLIACT",72,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",73,0)
 NEW PSIVAC S PSIVAC="PR" K PSGFDX
"RTN","PSJLIACT",74,0)
 D R^PSIVOPT
"RTN","PSJLIACT",75,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",76,0)
 K PSJREN
"RTN","PSJLIACT",77,0)
 Q
"RTN","PSJLIACT",78,0)
H ; Hold
"RTN","PSJLIACT",79,0)
 K PSGORQF
"RTN","PSJLIACT",80,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",81,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",82,0)
 D H^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",83,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",84,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",85,0)
 Q
"RTN","PSJLIACT",86,0)
L ; Activity Log
"RTN","PSJLIACT",87,0)
 NEW PSIVLAB,PSIVLOG,PSJHIS S (PSIVLAB,PSIVLOG)=1
"RTN","PSJLIACT",88,0)
 D EN^PSIVVW1
"RTN","PSJLIACT",89,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",90,0)
 S VALMBCK="R"
"RTN","PSJLIACT",91,0)
 Q
"RTN","PSJLIACT",92,0)
O ; On Call
"RTN","PSJLIACT",93,0)
 K PSGORQF
"RTN","PSJLIACT",94,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",95,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",96,0)
 D O^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",97,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",98,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",99,0)
 Q
"RTN","PSJLIACT",100,0)
VF ; Make the order active **ENHANCEMENTS MADE IN PSJ*5.0*260
"RTN","PSJLIACT",101,0)
 NEW PSIVCHG,PSGORQF,PSJVFF S PSIVCHG=0
"RTN","PSJLIACT",102,0)
 IF VALM("TITLE")="ACTIVE IV " W !!,">>>  Verify may not be selected at this point." D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJLIACT",103,0)
 ELSE  IF $G(PSGSTAT)="NON-VERIFIED",$G(PSJNEWOE)=0 S PSJVFF=1 D EN^PSJGMRA($G(DFN),$G(PSGPD)),OC^PSIVOC D:'$G(PSGORQF) IN^PSJOCDS($G(PSGORD),"IV","") K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",104,0)
 ELSE  IF '$G(PSGORQF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",105,0)
 ELSE  IF $G(PSIVFN1),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",106,0)
 ELSE  IF $G(PSGDEF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",107,0)
 ELSE  IF $G(PSIVCOPY),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",108,0)
 D ACTIVE^PSIVORC2
"RTN","PSJLIACT",109,0)
 Q
"RTN","PSJLIACT",110,0)
VF1(PSIVREA,PSIVAL,PSIVLOG) ;
"RTN","PSJLIACT",111,0)
 ;Update 4 node and set activity log.
"RTN","PSJLIACT",112,0)
 ;PSIVREA: the reason use by LOG^PSIVORAL
"RTN","PSJLIACT",113,0)
 ;PSIVAL : the description reason
"RTN","PSJLIACT",114,0)
 ;PSIVLOG: Log an activity if = 1
"RTN","PSJLIACT",115,0)
 K PSGORQF
"RTN","PSJLIACT",116,0)
 I '+$G(OD)!($L($G(OD))>16) K OD
"RTN","PSJLIACT",117,0)
 D:+PSJSYSU=3 ^PSIVORE1
"RTN","PSJLIACT",118,0)
 NEW DIE,DA,DR,PSJX,XX,PSIVACT,PSJRQND
"RTN","PSJLIACT",119,0)
 S PSIVACT=1
"RTN","PSJLIACT",120,0)
 S PSJX=$G(^PS(55,DFN,"IV",+ON55,4)),XX=""
"RTN","PSJLIACT",121,0)
 I $P(PSJX,U)="" S XX=";143////0"
"RTN","PSJLIACT",122,0)
 I $P(PSJX,U,4)="" S XX=XX_U_";142////0"
"RTN","PSJLIACT",123,0)
 D NOW^%DTC
"RTN","PSJLIACT",124,0)
 S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",125,0)
 I +PSJSYSU=3 S DR="140////"_DUZ_";141////"_$E(%,1,12)_";142////1"_$P(XX,U)
"RTN","PSJLIACT",126,0)
 I +PSJSYSU=1 S DR="16////"_DUZ_";17////"_$E(%,1,12)_";143////1"_$P(XX,U,2)
"RTN","PSJLIACT",127,0)
 I $G(P("PRY"))="D" S DR=DR_";.22////"_+P("IVRM")
"RTN","PSJLIACT",128,0)
 D ^DIE
"RTN","PSJLIACT",129,0)
 D CIMOI^PSJIMO1(DFN,ON55,"",$G(PSJORD))
"RTN","PSJLIACT",130,0)
 ; If pending IV renew is edited during finish, go back and DE the original active order left in RENEWED status
"RTN","PSJLIACT",131,0)
 S PREREN=$S(ON55["V":$G(@(DIE_"+ON55,2)")),1:""),PREREN=$P(PREREN,"^",5) I PREREN D  K PREREN
"RTN","PSJLIACT",132,0)
 . I PREREN["P" S PREREN=$G(@("^PS(53.1,+PREREN,0)")),PREREN=$P(PREREN,"^",25)
"RTN","PSJLIACT",133,0)
 . I PREREN["V" N PRERENOD S PRERENOD=$G(@("^PS(55,DFN,""IV"",+PREREN,0)")) I $P(PRERENOD,"^",17)="R",($G(P("RES"))="E") D
"RTN","PSJLIACT",134,0)
 ..  S DIE="^PS(55,"_DFN_",""IV"",",DA=+PREREN,DA(1)=DFN
"RTN","PSJLIACT",135,0)
 ..  S DR="100////D;.03////"_PSGDT S ORIGSTOP=$P($G(@("^PS(55,DFN,""IV"",+PREREN,2)")),"^",3) I ORIGSTOP S DR=DR_";116////"_ORIGSTOP
"RTN","PSJLIACT",136,0)
 ..  D ^DIE D EN1^PSJHL2(DFN,"SC",PREREN)
"RTN","PSJLIACT",137,0)
 K DR,DIE,DA
"RTN","PSJLIACT",138,0)
 I (+PSJSYSU=3)&($G(P("PRY"))="D") D
"RTN","PSJLIACT",139,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSJLIACT",140,0)
 .Q:Y="N"
"RTN","PSJLIACT",141,0)
 .D MAIN^TIUEDIT(3,.TIUDA,DFN,"","","","",1)
"RTN","PSJLIACT",142,0)
 Q:'$G(PSIVLOG)
"RTN","PSJLIACT",143,0)
 I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D
"RTN","PSJLIACT",144,0)
 . NEW DIC,DA,X,Y,XX,DO D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJLIACT",145,0)
 . S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJLIACT",146,0)
 . S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJLIACT",147,0)
 . S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJLIACT",148,0)
 . D FILE^DICN
"RTN","PSJLIACT",149,0)
 NEW PSIVALCK
"RTN","PSJLIACT",150,0)
 S PSIVREA="V",PSIVALT=""
"RTN","PSJLIACT",151,0)
 S PSIVAL=PSIVAL_$S(+PSJSYSU=3:"PHARMACIST",1:"NURSE")
"RTN","PSJLIACT",152,0)
 D LOG^PSIVORAL K PSIVAL,PSIVREA,PSIVLN
"RTN","PSJLIACT",153,0)
 I $G(PSJORD)["P" S PSIVREA="V",PSIVALT="",PSGRDTX=$G(^PS(53.1,+PSJORD,2.5)) D
"RTN","PSJLIACT",154,0)
 . I $G(PSGRDTX) S PSIVAL="Requested Start Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U))) D LOG^PSIVORAL
"RTN","PSJLIACT",155,0)
 . I $P(PSGRDTX,U,3) S PSIVREA="V",PSIVALT="" S PSIVAL="Requested Stop Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U,3))) D LOG^PSIVORAL
"RTN","PSJLIACT",156,0)
 N DUR I $G(PSJORD) S DUR=$$GETDUR^PSJLIVMD(DFN,+PSJORD,$S(PSJORD["P":"P",1:"IV"),1) I DUR]""  D
"RTN","PSJLIACT",157,0)
 . K DR S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",158,0)
 . S DR=$S($G(IVLIMIT):"152////"_DUR,1:"151////"_DUR) K IVLIMIT
"RTN","PSJLIACT",159,0)
 . D ^DIE
"RTN","PSJLIACT",160,0)
 D EN1^PSJHL2(DFN,"SC",ON55)
"RTN","PSJLIACT",161,0)
 D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSJLIACT",162,0)
 D GT55^PSIVORFB S OLDON=$P($G(^PS(55,DFN,"IV",+ON55,2)),"^",5),P("OLDON")=OLDON
"RTN","PSJLIACT",163,0)
 N PSJPRIO,PSJSCH,NODE0,NODEP2 S NODE0=$G(^PS(55,DFN,"IV",+ON55,0)),NODEP2=$G(^PS(55,DFN,"IV",+ON55,.2))
"RTN","PSJLIACT",164,0)
 S PSJPRIO=$P(NODEP2,"^",4),PSJSCH=$P(NODE0,"^",9)
"RTN","PSJLIACT",165,0)
 I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCH)="NOW")!($G(PSJSCH)["STAT") D NOTIFY^PSJHL4(ON55,DFN,$G(PSJPRIO),$G(PSJSCH))
"RTN","PSJLIACT",166,0)
 Q
"RTN","PSJOC")
0^28^B32808738
"RTN","PSJOC",1,0)
PSJOC ;BIR/MV - NEW ORDER CHECKS DRIVER ;6 Jun 07 / 3:37 PM
"RTN","PSJOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,260,252,257**;16 DEC 97;Build 105
"RTN","PSJOC",3,0)
 ;
"RTN","PSJOC",4,0)
 ; Reference to ^PSODDPR4 is supported by DBIA# 5366.
"RTN","PSJOC",5,0)
 ; Reference to ^PSSHRQ2 is supported by DBIA# 5369.
"RTN","PSJOC",6,0)
 ;
"RTN","PSJOC",7,0)
OC(PSPDRG,PSJPTYP) ;
"RTN","PSJOC",8,0)
 ;PSPDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug Name
"RTN","PSJOC",9,0)
 ;Where n is a sequential number.  The Drug Name can be OI, Generic name from #50, or Add/Sol name
"RTN","PSJOC",10,0)
 ;PSJPTYP - P1 ; P2
"RTN","PSJOC",11,0)
 ; Where P1 is "I" for Inpatient, "O" for Outpatient
"RTN","PSJOC",12,0)
 ;       P2 is the Inpatient Order Number (for PSJ use only)
"RTN","PSJOC",13,0)
 ;PSJOCERR(DRUG NAME)="Reason text". Where Drug Name can be either OI name or AD/SOL name.
"RTN","PSJOC",14,0)
 NEW PSJOCERR
"RTN","PSJOC",15,0)
 ;Quit OC if FDB link is down.  PSGORQF is defined if user wish to stop the order process
"RTN","PSJOC",16,0)
 I $$SYS^PSJOCERR() Q
"RTN","PSJOC",17,0)
 ;
"RTN","PSJOC",18,0)
 I $D(PSJDGCK) W !!,"Building MEDS profile please wait...",!
"RTN","PSJOC",19,0)
 D BLD^PSODDPR4(DFN,"PSJPRE",.PSPDRG,PSJPTYP)
"RTN","PSJOC",20,0)
 D DISPLAY
"RTN","PSJOC",21,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSJOC",22,0)
 Q
"RTN","PSJOC",23,0)
DISPLAY ;
"RTN","PSJOC",24,0)
 NEW PSJPAUSE,PSJOLDSV,PSJDNM,PSJMON,PSJOC,PSJOCDT,PSJOCDTL,PSJOCLST,PSJP,PSJS,PSJPON,PSJDN,PSJSEV,PSJECNT
"RTN","PSJOC",25,0)
 D GMRAOC
"RTN","PSJOC",26,0)
 Q:'$$DSPSERR()
"RTN","PSJOC",27,0)
 D FULL^VALM1
"RTN","PSJOC",28,0)
 W @IOF,"Now Processing Enhanced Order Checks!  Please wait...",!
"RTN","PSJOC",29,0)
 ; If there are no OC or errors to display, this var will trigger a pause before continue /w the order
"RTN","PSJOC",30,0)
 S PSJPAUSE=1
"RTN","PSJOC",31,0)
 D DRUGERR
"RTN","PSJOC",32,0)
 I $D(PSJDGCK) W:'$D(^TMP($J,"PSJPRE","OUT","DRUGDRUG"))&'$D(^TMP($J,"PSJPRE","OUT","THERAPY",1)) !,"No Order Check Warnings Found",!
"RTN","PSJOC",33,0)
 ;Process drug interaction & drug interception
"RTN","PSJOC",34,0)
 D DI^PSJOCDI
"RTN","PSJOC",35,0)
 Q:$G(PSGORQF)
"RTN","PSJOC",36,0)
 D DSPERR^PSJOCERR("DRUGDRUG")
"RTN","PSJOC",37,0)
 ;Process duplicate therapy order checks
"RTN","PSJOC",38,0)
 D:'$D(PSJDGCK) DT^PSJOCDT
"RTN","PSJOC",39,0)
 I $D(PSJDGCK) D:$D(^TMP($J,"PSJPRE","OUT","THERAPY")) DTDGCK^PSJOCDT
"RTN","PSJOC",40,0)
 D:'$G(PSGORQF) DSPERR^PSJOCERR("THERAPY")
"RTN","PSJOC",41,0)
 I $D(PSJDGCK),'$D(^TMP($J,"PSJPRE","OUT","THERAPY")) D PAUSE^PSJLMUT1 Q  ;DX action
"RTN","PSJOC",42,0)
 Q:$G(PSGORQF)
"RTN","PSJOC",43,0)
 D:$G(PSJPAUSE) PAUSE^PSJLMUT1
"RTN","PSJOC",44,0)
 Q
"RTN","PSJOC",45,0)
 ;
"RTN","PSJOC",46,0)
GMRAOC ;Display allergy & CPRS OC regardless if FDB is connected
"RTN","PSJOC",47,0)
 D ALLERGY
"RTN","PSJOC",48,0)
 D CPRS^PSJOCOR(.PSPDRG)
"RTN","PSJOC",49,0)
 Q
"RTN","PSJOC",50,0)
ALLERGY ;Do allergy order check
"RTN","PSJOC",51,0)
 ;The allergy check will be processed for each of the dispense drug stores in the PSJALLGY array
"RTN","PSJOC",52,0)
 ;PSJALLGY(X)="" Where X is the disp drug IEN.  PSJALLGY array store all dispense drugs use in an order
"RTN","PSJOC",53,0)
 ;
"RTN","PSJOC",54,0)
 I '$D(PSJDGCK) D
"RTN","PSJOC",55,0)
 .NEW PSJDD
"RTN","PSJOC",56,0)
 .F PSJDD=0:0 S PSJDD=$O(PSJALLGY(PSJDD)) Q:'PSJDD  D EN^PSJGMRA(DFN,PSJDD)
"RTN","PSJOC",57,0)
 I $D(PSJDGCK) D
"RTN","PSJOC",58,0)
 .S PSJXX="" S PSJYY=1
"RTN","PSJOC",59,0)
 .F  S PSJXX=$O(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJXX)) Q:PSJXX=""  D
"RTN","PSJOC",60,0)
 ..S PSJALLGY(PSJYY,$P(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJXX),U,3))=""
"RTN","PSJOC",61,0)
 ..S PSJYY=PSJYY+1
"RTN","PSJOC",62,0)
 .F PSJDD=0:0 S PSJDD=$O(PSJALLGY(PSJDD)) Q:'PSJDD  F PSJCC=0:0 S PSJCC=$O(PSJALLGY(PSJDD,PSJCC)) Q:'PSJCC  D EN^PSJGMRA(DFN,PSJCC)
"RTN","PSJOC",63,0)
 K PSJXX,PSJYY,PSJDD,PSJCC,PSJALLGY
"RTN","PSJOC",64,0)
 Q
"RTN","PSJOC",65,0)
DSPORD(ON,PSJNLST,PSJCLINF) ;Display the order data
"RTN","PSJOC",66,0)
 ;ON - ON_U/V/P ex: 21V
"RTN","PSJOC",67,0)
 ;PSJNLST - It's number list and also use to trigger pg break, line break
"RTN","PSJOC",68,0)
 NEW PSJCOL,PSJX,PSJOC,PSJLINE,X
"RTN","PSJOC",69,0)
 Q:ON=""
"RTN","PSJOC",70,0)
 S:'$D(PSJCLINF) PSJCLINF=";0"
"RTN","PSJOC",71,0)
 S PSJLINE=1,PSJCOL=1
"RTN","PSJOC",72,0)
 I $P(PSJCLINF,";",2) D CLNDISP^PSJCLNOC(.PSJCLINF) D  Q
"RTN","PSJOC",73,0)
 .I $G(PSJNLST)="",(($Y+6)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",74,0)
 I ON'["V" D DSPLORDU^PSJLMUT1(DFN,ON)
"RTN","PSJOC",75,0)
 I ON["V" D DSPLORDV^PSJLMUT1(DFN,ON)
"RTN","PSJOC",76,0)
 F PSJX=0:0 S PSJX=$O(PSJOC(ON,PSJX)) Q:'PSJX  D
"RTN","PSJOC",77,0)
 . I $G(PSJNLST)="",(($Y+6)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",78,0)
 . W !
"RTN","PSJOC",79,0)
 . I $G(PSJNLST) W:(PSJX=1) PSJNLST W:(PSJX>1) ?$L(PSJNLST)
"RTN","PSJOC",80,0)
 . S X=PSJOC(ON,PSJX)
"RTN","PSJOC",81,0)
 . W $E(X,9,$L(X))
"RTN","PSJOC",82,0)
 W !
"RTN","PSJOC",83,0)
 Q
"RTN","PSJOC",84,0)
 ;
"RTN","PSJOC",85,0)
DRUGERR ;Display drug level errors
"RTN","PSJOC",86,0)
 NEW PSJPON,PSJN,PSJNV,PSJDSPFG,PSJPERR,PSJX
"RTN","PSJOC",87,0)
 ;Only display the exceptions once per patient. Use the exception from prospective drug if exception(s) existed for the 
"RTN","PSJOC",88,0)
 ; same drug on the profile.
"RTN","PSJOC",89,0)
 ;PSJEXCPT(PSJDNM_REASON) - Array for invalid drugs that already display to once within a pt selection
"RTN","PSJOC",90,0)
 S PSJDSPFG=0
"RTN","PSJOC",91,0)
 S PSJPERR=$$PROSPERR()
"RTN","PSJOC",92,0)
 I PSJPERR D  Q
"RTN","PSJOC",93,0)
 . I PSJDSPFG D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",94,0)
 I $D(PSJEXCPT("PROFILE")) Q
"RTN","PSJOC",95,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",96,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOC",97,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOC",98,0)
 .. I $P(PSJPON,";",3)'="PROFILE" Q
"RTN","PSJOC",99,0)
 .. ;I '$$ERRCHK("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOC",100,0)
 .. I '$$ERRCHK("PROFILE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOC",101,0)
 .. D DSPDRGER()
"RTN","PSJOC",102,0)
 I PSJDSPFG D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",103,0)
 Q
"RTN","PSJOC",104,0)
DSPDRGER(PSJDSFLG) ;
"RTN","PSJOC",105,0)
 NEW PSJTXT
"RTN","PSJOC",106,0)
 S PSJTXT=$P(PSJNV,U,7)
"RTN","PSJOC",107,0)
 S X="Enhanced Order Checks cannot "
"RTN","PSJOC",108,0)
 I $G(PSJDSFLG),(PSJTXT[X) S PSJTXT="Dosing Checks could not "_$P(PSJTXT,X,2)
"RTN","PSJOC",109,0)
 S PSJDSPFG=1
"RTN","PSJOC",110,0)
 K PSJPAUSE
"RTN","PSJOC",111,0)
 I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",112,0)
 W !
"RTN","PSJOC",113,0)
 D WRITE^PSJMISC(PSJTXT,,79)
"RTN","PSJOC",114,0)
 D:$P(PSJNV,U,10)]"" WRITE^PSJMISC("Reason(s): "_$P(PSJNV,U,10),3,79)
"RTN","PSJOC",115,0)
 W !
"RTN","PSJOC",116,0)
 Q
"RTN","PSJOC",117,0)
ERRCHK(PSJTYPE,PSJX) ;
"RTN","PSJOC",118,0)
 ;PSJTYPE - Either "PROFILE" or "PROSPECTIVE"
"RTN","PSJOC",119,0)
 ;PSJX - Drug name_Error reason
"RTN","PSJOC",120,0)
 ;Return 1 if this error drug has not displayed to the user.
"RTN","PSJOC",121,0)
 I $G(PSJX)="" Q 0
"RTN","PSJOC",122,0)
 I $G(PSJTYPE)="" Q 0
"RTN","PSJOC",123,0)
 ;I PSJTYPE="PROFILE",'$D(PSJEXCPT(PSJTYPE,PSJX)) S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",124,0)
 I PSJTYPE="PROFILE" S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",125,0)
 I PSJTYPE="PROSPECTIVE",'$D(PSJEXCPT(PSJTYPE,PSJX)) S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",126,0)
 Q 0
"RTN","PSJOC",127,0)
PING(PSJMSG) ;Check if FDB is down.  Return 0 if it is
"RTN","PSJOC",128,0)
 ;pass in a message to customize the display
"RTN","PSJOC",129,0)
 S ^TMP($J,"PSJPRE","IN","PING")=""
"RTN","PSJOC",130,0)
 D IN^PSSHRQ2("PSJPRE")
"RTN","PSJOC",131,0)
 Q $$DSPSERR($G(PSJMSG))
"RTN","PSJOC",132,0)
DSPSERR(PSJMSG) ;Display system errors
"RTN","PSJOC",133,0)
 NEW X
"RTN","PSJOC",134,0)
 S X=$G(^TMP($J,"PSJPRE","OUT",0))
"RTN","PSJOC",135,0)
 I $P(X,U)=-1 D NOFDB($P(X,U,2),$G(PSJMSG))
"RTN","PSJOC",136,0)
 Q $S($P(X,U)=-1:0,1:1)
"RTN","PSJOC",137,0)
NOFDB(PSJX,PSJMSG) ;Display connection down message
"RTN","PSJOC",138,0)
 NEW X
"RTN","PSJOC",139,0)
 Q:$G(PSJX)=""
"RTN","PSJOC",140,0)
 I $G(PSJMSG)]"" W !!,"Maximum Single Dose Check could not be performed"
"RTN","PSJOC",141,0)
 I $G(PSJMSG)="" W !!,"No Enhanced Order Checks can be performed."
"RTN","PSJOC",142,0)
 W !,"   Reason(s): ",PSJX,!!
"RTN","PSJOC",143,0)
 K PSJX
"RTN","PSJOC",144,0)
 D:$G(PSJMSG)["Maximum Single" PAUSE^PSJLMUT1
"RTN","PSJOC",145,0)
 Q
"RTN","PSJOC",146,0)
PROSPERR() ;Display exceptions for prospective drug
"RTN","PSJOC",147,0)
 NEW PSJPON,PSJN,PSJNV,PSJPERR
"RTN","PSJOC",148,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",149,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOC",150,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOC",151,0)
 .. I $P(PSJPON,";",3)="PROFILE" Q 
"RTN","PSJOC",152,0)
 .. I ($P(PSJPON,";",3)="PROSPECTIVE") S PSJX='$$ERRCHK("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10))
"RTN","PSJOC",153,0)
 .. D DSPDRGER()
"RTN","PSJOC",154,0)
 ;If the prospective drug(s) is caught in the exception, the exception for profile drug(s) is not display.
"RTN","PSJOC",155,0)
 ;  The exception for the prospective is the only one need to display.
"RTN","PSJOC",156,0)
 S PSJPERR=1
"RTN","PSJOC",157,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJPON)) Q:PSJPON=""  Q:'PSJPERR  D
"RTN","PSJOC",158,0)
 . I $D(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q
"RTN","PSJOC",159,0)
 . S PSJPERR=0
"RTN","PSJOC",160,0)
 Q PSJPERR
"RTN","PSJOCDI")
0^32^B93276069
"RTN","PSJOCDI",1,0)
PSJOCDI ;BIR/MV - DISPLAY DRUG INTERACTION ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCDI",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,260,252,257**;16 DEC 97;Build 105
"RTN","PSJOCDI",3,0)
 ; Reference to ^PSODRDU2 is supported by DBIA #2189.
"RTN","PSJOCDI",4,0)
 ;
"RTN","PSJOCDI",5,0)
DI ;
"RTN","PSJOCDI",6,0)
 NEW PSJDN,PSJDNM,PSJMON,PSJOCLST,PSJPON,PSJSEV,PSJHDR,PSJRDI,PSJ2,PSJONFLG,PSJCRTCL,PSJSORT,PSJGROUP,PSJCLINF,PSJDXOPT
"RTN","PSJOCDI",7,0)
 ;If interception occurred, display message to user
"RTN","PSJOCDI",8,0)
 ;
"RTN","PSJOCDI",9,0)
 ;Store VUID from Remote data in PSJRDI(PSJON)=VUID.
"RTN","PSJOCDI",10,0)
 D RDIVUID
"RTN","PSJOCDI",11,0)
 S PSJ2=0
"RTN","PSJOCDI",12,0)
 ;Loop through drug drug order checks output
"RTN","PSJOCDI",13,0)
 S PSJSEV="" F  S PSJSEV=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV)) Q:PSJSEV=""!($G(PSGORQF))  D
"RTN","PSJOCDI",14,0)
 . S PSJDNM="" F  S PSJDNM=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM)) Q:PSJDNM=""!($G(PSGORQF))  D
"RTN","PSJOCDI",15,0)
 .. S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON)) Q:PSJPON=""!($G(PSGORQF))  D
"RTN","PSJOCDI",16,0)
 ... S PSJCLINF="",PSJDXOPT=$S($G(PSJDGCK):"PROSPECTIVE",1:"PROFILE")
"RTN","PSJOCDI",17,0)
 ... S PSJCLINF="",PSJCLINF=$P($G(^TMP($J,"PSJPRE","IN",PSJDXOPT,PSJPON)),"^",7)
"RTN","PSJOCDI",18,0)
 ... F PSJDN=0:0 S PSJDN=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN)) Q:'PSJDN!($G(PSGORQF))  D SORTORD
"RTN","PSJOCDI",19,0)
 I $O(PSJOCLST(""))="" Q
"RTN","PSJOCDI",20,0)
 D CRITICAL
"RTN","PSJOCDI",21,0)
 D DSPLOC
"RTN","PSJOCDI",22,0)
 I $D(^TMP($J,"PSJPRE","OUT","DRUGDRUG","S")) D
"RTN","PSJOCDI",23,0)
 . W !,"*** REFER TO MONOGRAPH FOR SIGNIFICANT INTERACTION CLINICAL EFFECTS",!
"RTN","PSJOCDI",24,0)
 D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",25,0)
 W !
"RTN","PSJOCDI",26,0)
 D MON^PSJMON(.PSJMON)
"RTN","PSJOCDI",27,0)
 D:$G(PSJONFLG)&('$D(PSJDGCK)) INTERV
"RTN","PSJOCDI",28,0)
 Q
"RTN","PSJOCDI",29,0)
DSPLOC ;Display drug drug interaction - sorted by severity, prospective drug (50,.01), profile drug (VAgen name), package, seq#
"RTN","PSJOCDI",30,0)
 NEW PSJDN,PSJDNV,PSJPON,PSJP,PSJX,X,PSJXSEV,PSJXNM,PSJXNM1,PSJXSORT,PSJXDN,PSJSORT,PSJPSPEC,PSJPROFL,PSJ2,PSJSEV,PSJHDRS,PSJDSPON,PSJCLINF
"RTN","PSJOCDI",31,0)
 ;
"RTN","PSJOCDI",32,0)
 K PSJPAUSE
"RTN","PSJOCDI",33,0)
 ;Get the last drug in the sort list so a '=' line is printed instead of '.'
"RTN","PSJOCDI",34,0)
 S PSJLINE=".",PSJHDRS=""
"RTN","PSJOCDI",35,0)
 S PSJXSEV=$O(PSJOCLST(""),-1)
"RTN","PSJOCDI",36,0)
 S PSJXNM=$O(PSJOCLST(PSJXSEV,""),-1)
"RTN","PSJOCDI",37,0)
 S PSJXNM1=$O(PSJOCLST(PSJXSEV,PSJXNM,""),-1)
"RTN","PSJOCDI",38,0)
 S PSJXSORT=$O(PSJOCLST(PSJXSEV,PSJXNM,PSJXNM1,""),-1)
"RTN","PSJOCDI",39,0)
 S PSJXDN=$O(PSJOCLST(PSJXSEV,PSJXNM,PSJXNM1,PSJXSORT,""),-1)
"RTN","PSJOCDI",40,0)
 ;
"RTN","PSJOCDI",41,0)
 ;S PSJSEV="" F  S PSJSEV=$O(PSJOCLST(PSJSEV)) Q:PSJSEV=""  D
"RTN","PSJOCDI",42,0)
 ;Displaying Critical orders
"RTN","PSJOCDI",43,0)
 S PSJSEV="C"
"RTN","PSJOCDI",44,0)
 I $D(PSJCRTCL) D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",45,0)
 F PSJSORT=0:0 S PSJSORT=$O(PSJCRTCL(PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",46,0)
 . F PSJGROUP=0:0 S PSJGROUP=$O(PSJCRTCL(PSJSORT,PSJGROUP)) Q:'PSJGROUP  D
"RTN","PSJOCDI",47,0)
 .. S X=$G(PSJCRTCL(PSJSORT,PSJGROUP))
"RTN","PSJOCDI",48,0)
 .. D DSPCRTCL($P(X,U),$P(X,U,2))
"RTN","PSJOCDI",49,0)
 ;Displaying Significant orders
"RTN","PSJOCDI",50,0)
 K PSJDSPON
"RTN","PSJOCDI",51,0)
 S PSJSEV="S"
"RTN","PSJOCDI",52,0)
 S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",53,0)
 . D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",54,0)
 . F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",55,0)
 .. F PSJ2=0:0 S PSJ2=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",56,0)
 ... S PSJDNV=PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT,PSJ2)
"RTN","PSJOCDI",57,0)
 ... D DISPON
"RTN","PSJOCDI",58,0)
 . W !
"RTN","PSJOCDI",59,0)
 Q
"RTN","PSJOCDI",60,0)
DSPCRTCL(PSJPSPEC,PSJPROFL) ;Display Critical orders
"RTN","PSJOCDI",61,0)
 NEW PSJSORT,PSJ2
"RTN","PSJOCDI",62,0)
 Q:$G(PSJPSPEC)=""
"RTN","PSJOCDI",63,0)
 Q:$G(PSJPROFL)=""
"RTN","PSJOCDI",64,0)
 F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",65,0)
 . F PSJ2=0:0 S PSJ2=$O(PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",66,0)
 .. S PSJDNV=PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)
"RTN","PSJOCDI",67,0)
 .. D DISPON
"RTN","PSJOCDI",68,0)
 Q
"RTN","PSJOCDI",69,0)
DISPON ; Display orders & clin effects if applied.
"RTN","PSJOCDI",70,0)
 F X=1:1:11 S PSJP(X)=$P(PSJDNV,U,X)
"RTN","PSJOCDI",71,0)
 S PSJCLINF=$P(PSJDNV,U,12)
"RTN","PSJOCDI",72,0)
 I ($G(PSJHDR)'=$P(PSJDNV,U,3))!(PSJHDRS'=PSJSEV) S PSJHDR=$P(PSJDNV,U,3),PSJHDRS=PSJSEV K PSJDSPON D HDR(PSJHDR)
"RTN","PSJOCDI",73,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",74,0)
 I PSJSORT=10 D
"RTN","PSJOCDI",75,0)
 . S PSJONFLG=1
"RTN","PSJOCDI",76,0)
 . I $P(PSJCLINF,";",2) D DISPCLN^PSJCLNOC(.PSJP,PSJCLINF) Q
"RTN","PSJOCDI",77,0)
 . D DSPDRG(PSJP(4),$P(PSJDNV,U,2),PSJCLINF)
"RTN","PSJOCDI",78,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",79,0)
 I PSJSORT>10 S PSJONFLG=1 D
"RTN","PSJOCDI",80,0)
 . I $D(PSJDSPON($P(PSJP(4),";",2))) Q
"RTN","PSJOCDI",81,0)
 . S PSJDSPON($P(PSJP(4),";",2))=""
"RTN","PSJOCDI",82,0)
 . I $P($P(PSJDNV,U,12),";",2) D DISPCLN^PSJCLNOC(.PSJP,PSJCLINF) Q
"RTN","PSJOCDI",83,0)
 . D EN^PSODRDU2(DFN,PSJP(4),"PSJPRE")
"RTN","PSJOCDI",84,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",85,0)
DISPON2 ;
"RTN","PSJOCDI",86,0)
 I PSJSEV=PSJXSEV,(PSJPSPEC=PSJXNM),(PSJSORT=PSJXSORT),(PSJ2=PSJXDN) S PSJLINE="="
"RTN","PSJOCDI",87,0)
 I PSJSEV="C",$$DSPLCLIN(PSJ2) D CLIN(PSJP(5),PSJP(2),PSJP(4),PSJP(1),PSJLINE)
"RTN","PSJOCDI",88,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC() W @IOF
"RTN","PSJOCDI",89,0)
 Q
"RTN","PSJOCDI",90,0)
SORTORD ;Sort drug drug output to display in order of: Inpatient, Active Rx, Remote Rx, Pending Rx, Non_VA
"RTN","PSJOCDI",91,0)
 NEW PDJDNV,PSJX
"RTN","PSJOCDI",92,0)
 S PSJDNV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN))
"RTN","PSJOCDI",93,0)
 I $E(PSJPON,1,1)'="I" D
"RTN","PSJOCDI",94,0)
 . S PSJX=$E($P(PSJPON,";"),1,1)
"RTN","PSJOCDI",95,0)
 . D OCLST($S(PSJX["C":10,PSJX="O":20,PSJX="R":30,PSJX="P":40,PSJX="N":50,1:""),PSJCLINF)
"RTN","PSJOCDI",96,0)
 I $E(PSJPON,1,1)="I" D OCLST(10,PSJCLINF)
"RTN","PSJOCDI",97,0)
 Q
"RTN","PSJOCDI",98,0)
OCLST(PSJ1,PSJCLINF) ;Sort orders into array to display later
"RTN","PSJOCDI",99,0)
 ;PSJOCLST(PSJSEV("C",PSJPSPEC,PSJPROFL,PSJ1-package,PSJ2)=P1...P6 (P1=SEQ NO, P2=Drug Name(Profile), P3=Drug Name(Prospective)
"RTN","PSJOCDI",100,0)
 ;  (P4=Pharm order# ,P5=Severity, P6=P3 IEN)
"RTN","PSJOCDI",101,0)
 ;PSJOCLST(PSJSEV("S",PSJPSPEC,PSJ1-package,PSJ2)=P1...P12 (P1=SEQ NO, P2=Drug Name(Profile), P3=Drug Name(Prospective), P12=PSJCLINF
"RTN","PSJOCDI",102,0)
 ;  (P4=Pharm order# ,P5=Severity, P6=P3 IEN)
"RTN","PSJOCDI",103,0)
 ;PSJSEV: Sort first by severity
"RTN","PSJOCDI",104,0)
 ;PSJ1: 10=PSJ Order
"RTN","PSJOCDI",105,0)
 ;      20=PSO Active Rx
"RTN","PSJOCDI",106,0)
 ;      30=Remote Rx
"RTN","PSJOCDI",107,0)
 ;      40=PSO pending
"RTN","PSJOCDI",108,0)
 ;      50=Non-VA
"RTN","PSJOCDI",109,0)
 ;PSJ2: A counter
"RTN","PSJOCDI",110,0)
 NEW PSJDNV,PSJMONTI,PSJMONV,PSJVAGEN,PSJON1,PSJON2,PSJONFG,PSJPSPEC,PSJPROFL
"RTN","PSJOCDI",111,0)
 Q:'$G(PSJ1)
"RTN","PSJOCDI",112,0)
 S PSJ2=$G(PSJ2)+1
"RTN","PSJOCDI",113,0)
 S PSJDNV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN))
"RTN","PSJOCDI",114,0)
 S PSJPSPEC=$P(PSJDNV,U,4) S:PSJPSPEC="" PSJPSPEC="UNKNOWN DRUG NAME"
"RTN","PSJOCDI",115,0)
 ; Criticals are grouped by profile VAGEN name and then package type
"RTN","PSJOCDI",116,0)
 I PSJSEV="C" D
"RTN","PSJOCDI",117,0)
 . S PSJVAGEN=$$VAGEN^PSJMISC(+$P(PSJDNV,U,3)) I PSJVAGEN="" S PSJVAGEN=PSJDNM
"RTN","PSJOCDI",118,0)
 . S PSJOCLST(PSJSEV,PSJPSPEC,PSJVAGEN,PSJ1,PSJ2)=PSJDN_U_$G(PSJDNM)_U_$P(PSJDNV,U,4)_U_PSJPON_U_PSJSEV_U_$P(PSJDNV,U,2)_"^^^^^^"_PSJCLINF
"RTN","PSJOCDI",119,0)
 ; Significants are grouped by package type so Inpatient orders display first
"RTN","PSJOCDI",120,0)
 I PSJSEV="S" D 
"RTN","PSJOCDI",121,0)
 . S PSJOCLST(PSJSEV,PSJPSPEC,PSJ1,PSJ2)=PSJDN_U_$G(PSJDNM)_U_$P(PSJDNV,U,4)_U_PSJPON_U_PSJSEV_U_$P(PSJDNV,U,2)_"^^^^^^"_PSJCLINF
"RTN","PSJOCDI",122,0)
 S PSJMONTI=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN,"PMON",3,0))
"RTN","PSJOCDI",123,0)
 S PSJMONTI=$P(PSJMONTI,"MONOGRAPH TITLE:  ",2) Q:PSJMONTI=""
"RTN","PSJOCDI",124,0)
 S PSJVAGEN=$$VAGEN^PSJMISC(+$P(PSJDNV,U,3))
"RTN","PSJOCDI",125,0)
 I PSJVAGEN="",'+$P(PSJDNV,U,3) S PSJVAGEN=$$GENVUID^PSJMISC($G(PSJRDI(PSJPON)))
"RTN","PSJOCDI",126,0)
 Q:PSJVAGEN=""
"RTN","PSJOCDI",127,0)
 S PSJVAGEN=PSJVAGEN_"+"_$P(PSJDNV,U,4)
"RTN","PSJOCDI",128,0)
 S PSJMONV=$G(PSJMON(PSJVAGEN,PSJMONTI))
"RTN","PSJOCDI",129,0)
 I PSJMONTI]"" D
"RTN","PSJOCDI",130,0)
 . S $P(PSJMON(PSJVAGEN,PSJMONTI),U,1,7)=PSJDN_U_$G(PSJDNM)_U_+$P(PSJDNV,U,3)_U_$P(PSJDNV,U,4)_U_+$P(PSJDNV,U,2)_U_PSJPON_U_PSJSEV
"RTN","PSJOCDI",131,0)
 . S $P(PSJMON(PSJVAGEN,PSJMONTI),U,11)=PSJVAGEN
"RTN","PSJOCDI",132,0)
 I PSJMONV]"" D
"RTN","PSJOCDI",133,0)
 . I $P(PSJMONV,U,7)'=PSJSEV S $P(PSJMON(PSJVAGEN,PSJMONTI),U,9)=1
"RTN","PSJOCDI",134,0)
 . S PSJONFG=0
"RTN","PSJOCDI",135,0)
 . S PSJON1=$P($P(PSJMONV,U,6),";")
"RTN","PSJOCDI",136,0)
 . S PSJON2=$P(PSJPON,";")
"RTN","PSJOCDI",137,0)
 . I PSJON1="I",PSJON2'="I" S PSJONFG=1
"RTN","PSJOCDI",138,0)
 . I PSJON1'="I",PSJON2="I" S PSJONFG=1
"RTN","PSJOCDI",139,0)
 . I PSJONFG S $P(PSJMON(PSJVAGEN,PSJMONTI),U,10)=1
"RTN","PSJOCDI",140,0)
 K PSJON1,PSJON2,PSJONFG
"RTN","PSJOCDI",141,0)
 Q
"RTN","PSJOCDI",142,0)
CLIN(PSJSEV,PSJDNM,PSJPON,PSJDN,PSJLINE) ;
"RTN","PSJOCDI",143,0)
 ;No longer need to display the clinical effect for Significant
"RTN","PSJOCDI",144,0)
 Q:PSJSEV="S"
"RTN","PSJOCDI",145,0)
 NEW PSJCLINV,PSJNDX,PSJX
"RTN","PSJOCDI",146,0)
 I $G(PSJLINE)="" S PSJLINE="."
"RTN","PSJOCDI",147,0)
 F PSJDNX=0:0 S PSJDNX=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDNX)) Q:'PSJDNX  D
"RTN","PSJOCDI",148,0)
 . S PSJCLINV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDNX,"CLIN"))
"RTN","PSJOCDI",149,0)
 . W !
"RTN","PSJOCDI",150,0)
 . S PSJX=$P(PSJCLINV,"CLINICAL EFFECTS:  ",2) I ($Y+($L(PSJX)\65)+4)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",151,0)
 . D WRITE^PSJMISC(PSJX)
"RTN","PSJOCDI",152,0)
 W !
"RTN","PSJOCDI",153,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(0,0) W @IOF
"RTN","PSJOCDI",154,0)
 Q
"RTN","PSJOCDI",155,0)
INTERV ;Log intervention.  Required for Critical.
"RTN","PSJOCDI",156,0)
 ;Critical interaction MUST log an intervention before continue with the order
"RTN","PSJOCDI",157,0)
 ;Only log one intervention for a prospective drug & log it for the higher severity
"RTN","PSJOCDI",158,0)
 NEW PSJSEV,PSJDD,PSJDN,PSJNDV,PSJTYPE,PSJINTVD,PSJPROFL
"RTN","PSJOCDI",159,0)
 K PSJDDSV,PSJINTVD
"RTN","PSJOCDI",160,0)
 ;Required intervention for each of the prospective drug with critical interactions
"RTN","PSJOCDI",161,0)
 F PSJSEV="C" Q:$G(PSGORQF)  S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",162,0)
 . S PSJPROFL="" F  S PSJPROFL=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL)) Q:PSJPROFL=""  D
"RTN","PSJOCDI",163,0)
 .. F PSJTYPE=0:0 S PSJTYPE=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE)) Q:'PSJTYPE  D
"RTN","PSJOCDI",164,0)
 ... F PSJDN=0:0 S PSJDN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE,PSJDN)) Q:'PSJDN  Q:$G(PSGORQF)  D
"RTN","PSJOCDI",165,0)
 .... S PSJNDV=$G(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE,PSJDN)),PSJDD=$P(PSJNDV,U,6)
"RTN","PSJOCDI",166,0)
 .... ;I ($P($P(PSJNDV,U,4),";",1)="I"),('$D(PSJINTVD($P(PSJNDV,U,3)))) D
"RTN","PSJOCDI",167,0)
 .... I '$D(PSJINTVD($P(PSJNDV,U,3))) D
"RTN","PSJOCDI",168,0)
 ..... S (PSJINTVD($P(PSJNDV,U,3)))=""
"RTN","PSJOCDI",169,0)
 ..... D:'$D(PSJDGCK) RINTERV^PSJGMRA("CRITICAL DRUG INTERACTION",$P(PSJNDV,U,3))
"RTN","PSJOCDI",170,0)
 ;
"RTN","PSJOCDI",171,0)
 ; Optional intervention for each of the prospective drug(not the same as critical) with significant interactions
"RTN","PSJOCDI",172,0)
 F PSJSEV="S" Q:$G(PSGORQF)  S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",173,0)
 . F PSJTYPE=0:0 S PSJTYPE=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE)) Q:'PSJTYPE  D
"RTN","PSJOCDI",174,0)
 .. F PSJDN=0:0 S PSJDN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE,PSJDN)) Q:'PSJDN  Q:$G(PSGORQF)  D
"RTN","PSJOCDI",175,0)
 ... S PSJNDV=$G(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE,PSJDN)),PSJDD=$P(PSJNDV,U,6)
"RTN","PSJOCDI",176,0)
 ... I '$D(PSJINTVD($P(PSJNDV,U,3))) D
"RTN","PSJOCDI",177,0)
 .... S (PSJINTVD($P(PSJNDV,U,3)))=""
"RTN","PSJOCDI",178,0)
 .... D:'$D(PSJDGCK) INTERV^PSJGMRA("SIGNIFICANT DRUG INTERACTION",$P(PSJNDV,U,3))
"RTN","PSJOCDI",179,0)
 Q
"RTN","PSJOCDI",180,0)
HDR(PSJDNM) ;Display the intro text on drug interaction
"RTN","PSJOCDI",181,0)
 W !,"This patient is receiving the following order(s) that have a "
"RTN","PSJOCDI",182,0)
 W $S($G(PSJSEV)="C":"CRITICAL",$G(PSJSEV)="S":"SIGNIFICANT",1:"")_" Drug"
"RTN","PSJOCDI",183,0)
 W !,"Interaction with "_$G(PSJDNM)_":",!
"RTN","PSJOCDI",184,0)
 Q
"RTN","PSJOCDI",185,0)
DSPDRG(PSJPON,PSJDNM,PSJCLINF) ;Display order info or drug name from prospective.
"RTN","PSJOCDI",186,0)
 Q:$G(PSJPON)=""
"RTN","PSJOCDI",187,0)
 I $P(PSJPON,";",3)="PROSPECTIVE" W !?8,$G(PSJDNM),! Q
"RTN","PSJOCDI",188,0)
 I $D(PSJDSPON($P(PSJPON,";",2))) Q
"RTN","PSJOCDI",189,0)
 S PSJDSPON($P(PSJPON,";",2))=""
"RTN","PSJOCDI",190,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",191,0)
 D DSPORD^PSJOC($P(PSJPON,";",2),"",PSJCLINF)
"RTN","PSJOCDI",192,0)
 Q
"RTN","PSJOCDI",193,0)
RDIVUID ;Loop thru the "IN" global to store the VUID for remote Rx
"RTN","PSJOCDI",194,0)
 NEW PSJPON,PSJVUID
"RTN","PSJOCDI",195,0)
 K PSJRDI
"RTN","PSJOCDI",196,0)
 S PSJPON=""
"RTN","PSJOCDI",197,0)
 F  S PSJPON=$O(^TMP($J,"PSJPRE","IN","PROFILE",PSJPON)) Q:PSJPON=""  I $E(PSJPON,1,1)="R" D
"RTN","PSJOCDI",198,0)
 . S PSJVUID=$P($G(^TMP($J,"PSJPRE","IN","PROFILE",PSJPON)),U,2)
"RTN","PSJOCDI",199,0)
 . S:+PSJVUID PSJRDI(PSJPON)=PSJVUID
"RTN","PSJOCDI",200,0)
 Q
"RTN","PSJOCDI",201,0)
DSPLCLIN(PSJ2) ;If the next drug on the list is diff the flag to display the clin effects.
"RTN","PSJOCDI",202,0)
 NEW PSJCLINC,PSJCLINN,PSJDNVC,PSJDNVN,PSJPC,PSJPN,PSJ2N,PSJSORTN
"RTN","PSJOCDI",203,0)
 I $G(PSJ2)="" Q 0
"RTN","PSJOCDI",204,0)
 S PSJDNVC=PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)
"RTN","PSJOCDI",205,0)
 F X=1:1:10 S PSJPC(X)=$P(PSJDNVC,U,X)
"RTN","PSJOCDI",206,0)
 S PSJ2N=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2))
"RTN","PSJOCDI",207,0)
 I 'PSJ2N S PSJSORTN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORTN 1
"RTN","PSJOCDI",208,0)
 S PSJ2N=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,0)) Q:'PSJ2N 1
"RTN","PSJOCDI",209,0)
 S PSJDNVN=PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2N)
"RTN","PSJOCDI",210,0)
 F X=1:1:10 S PSJPN(X)=$P(PSJDNVN,U,X)
"RTN","PSJOCDI",211,0)
 I $S(PSJPC(5)="":1,PSJPC(2)="":1,PSJPC(4)="":1,'+PSJPC(1):1,PSJPN(5)="":1,PSJPN(2)="":1,PSJPN(4)="":1,'+PSJPN(1):1,1:0) Q 0
"RTN","PSJOCDI",212,0)
 S PSJCLINC=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJPC(5),PSJPC(2),PSJPC(4),PSJPC(1),"CLIN"))
"RTN","PSJOCDI",213,0)
 S PSJCLINN=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJPN(5),PSJPN(2),PSJPN(4),PSJPN(1),"CLIN"))
"RTN","PSJOCDI",214,0)
 I (PSJCLINC'=PSJCLINN) Q 1
"RTN","PSJOCDI",215,0)
 Q 0
"RTN","PSJOCDI",216,0)
CRITICAL ;
"RTN","PSJOCDI",217,0)
 NEW PSJGROUP,PSJNEXT
"RTN","PSJOCDI",218,0)
 S PSJGROUP=0,PSJNEXT=0
"RTN","PSJOCDI",219,0)
 S PSJSEV="C"
"RTN","PSJOCDI",220,0)
 S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",221,0)
 . S PSJPROFL="" F  S PSJPROFL=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL)) Q:PSJPROFL=""  D
"RTN","PSJOCDI",222,0)
 .. S PSJNEXT=0
"RTN","PSJOCDI",223,0)
 .. S PSJGROUP=PSJGROUP+1
"RTN","PSJOCDI",224,0)
 .. F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",225,0)
 ... Q:PSJNEXT
"RTN","PSJOCDI",226,0)
 ... F PSJ2=0:0 S PSJ2=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",227,0)
 .... Q:PSJNEXT
"RTN","PSJOCDI",228,0)
 .... S PSJCRTCL(PSJSORT,PSJGROUP)=PSJPSPEC_U_PSJPROFL_U_$P(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2),"^",12)
"RTN","PSJOCDI",229,0)
 .... S PSJNEXT=1
"RTN","PSJOCDI",230,0)
 Q
"RTN","PSJOCDS")
0^29^B73617469
"RTN","PSJOCDS",1,0)
PSJOCDS ;BIR/MV - SET INPUT DATA FOR DOSING ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252,257**;16 DEC 97;Build 105
"RTN","PSJOCDS",3,0)
 ;
"RTN","PSJOCDS",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOCDS",5,0)
 ; Reference to ^PSSORPH is supported by DBIA #3234.
"RTN","PSJOCDS",6,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425.
"RTN","PSJOCDS",7,0)
 ; Reference to ^PSSDSAPD is supported by DBIA #5426.
"RTN","PSJOCDS",8,0)
 ; Reference to FULL^VALM1 and PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOCDS",9,0)
 ;
"RTN","PSJOCDS",10,0)
 ;The Dose API will be processed separately than the DD & DT order checks
"RTN","PSJOCDS",11,0)
 ;
"RTN","PSJOCDS",12,0)
IN(PSJPON,PSJTYPE,PSJDD) ;
"RTN","PSJOCDS",13,0)
 ;PSJPON - Order number
"RTN","PSJOCDS",14,0)
 ;PSJPTYPE - UD/IV
"RTN","PSJOCDS",15,0)
 ;PSJDD - Dispense drug IEN (for UD order only)
"RTN","PSJOCDS",16,0)
 ;
"RTN","PSJOCDS",17,0)
 ;PSJOVR array is defined when OVERLAP^PSGOEF2 is called.
"RTN","PSJOCDS",18,0)
 ;
"RTN","PSJOCDS",19,0)
 NEW PSJDSOFF,PSJCNT
"RTN","PSJOCDS",20,0)
 D FULL^VALM1
"RTN","PSJOCDS",21,0)
 S PSJDSOFF=$$DS^PSSDSAPI()
"RTN","PSJOCDS",22,0)
 I '+PSJDSOFF D DOSEOFF^PSJOCDSD($P(PSJDSOFF,U,2)) Q
"RTN","PSJOCDS",23,0)
 NEW PSJOCDS,PSJFDB,PSJBASE,PSJOVR,PSJOVRLP,PSJX
"RTN","PSJOCDS",24,0)
 K PSJOCDS,PSJFDB
"RTN","PSJOCDS",25,0)
 I '$$PING^PSJOC("Maximum Single Dose Check could not be performed") Q
"RTN","PSJOCDS",26,0)
 K ^TMP($J,"PSJPRE"),^TMP($J,"PSJPRE1")
"RTN","PSJOCDS",27,0)
 S PSJBASE(1)="PSJPRE",PSJBASE(3)="PSJPRE1"
"RTN","PSJOCDS",28,0)
 ;
"RTN","PSJOCDS",29,0)
 ;;**** Commented out complex dosing
"RTN","PSJOCDS",30,0)
 ;;PSJOCDSC("CX","PSJCOM") is to flag if dosing checks needs to handle complex orders.
"RTN","PSJOCDS",31,0)
 ;;*I '$D(PSJOCDSC("CX","PSJCOM")) D
"RTN","PSJOCDS",32,0)
 ;;*. I $G(PSJCOM),$$CONJ^PSJOCDSC() S PSJOCDSC("CX","PSJCOM")=1
"RTN","PSJOCDS",33,0)
 ;;*I $G(PSJOCDSC("CX","PSJCOM")),'$D(PSJOCDSC("CX","ACX")) D SETLST^PSJOCDSC(PSJPON)
"RTN","PSJOCDS",34,0)
 ;;*I PSJTYPE="UD" D UD I $G(PSJOCDSC("CX","PSJCOM")) D COMPLEX^PSJOCDSC Q
"RTN","PSJOCDS",35,0)
 ;;*I PSJTYPE="IV" D IN^PSIVOCDS("PSJPRE") D:$G(PSJOCDSC("CX","PSJCOM")) IV^PSJOCDSC(PSJPON),UPDLST^PSJOCDSC(PSJPON,2)
"RTN","PSJOCDS",36,0)
 ;;**** End Complex dosing
"RTN","PSJOCDS",37,0)
 ;
"RTN","PSJOCDS",38,0)
 ;;****To be removed when complex dosing is ready
"RTN","PSJOCDS",39,0)
 I PSJTYPE="UD" D UD
"RTN","PSJOCDS",40,0)
 I PSJTYPE="IV" D IN^PSIVOCDS("PSJPRE")
"RTN","PSJOCDS",41,0)
 ;;****END
"RTN","PSJOCDS",42,0)
 ;
"RTN","PSJOCDS",43,0)
 I '$D(PSJFDB) Q
"RTN","PSJOCDS",44,0)
 ;;*If complex order then set conjunction to "Then" so low dose warning is screened out.
"RTN","PSJOCDS",45,0)
 ;;*I $G(PSJCOM),$$ALLTHEN^PSJOCDSC() D
"RTN","PSJOCDS",46,0)
 ;;*. F PSJX=0:0 S PSJX=$O(PSJOCDS(PSJX)) Q:'PSJX  S PSJOCDS(PSJX,"CONJ")="T"
"RTN","PSJOCDS",47,0)
 D DOSE^PSSDSAPD(.PSJBASE,DFN,.PSJOCDS,.PSJFDB)
"RTN","PSJOCDS",48,0)
 D DISPLAY^PSJOCDSD
"RTN","PSJOCDS",49,0)
 ;I '$G(PSGORQF),(PSJTYPE="IV"),$G(PSJOCDSC("CX","PSJCOM")) D NODAILY^PSJOCDSP(PSJPON)
"RTN","PSJOCDS",50,0)
 K ^TMP($J,"PSJPRE"),^TMP($J,"PSJPRE1")
"RTN","PSJOCDS",51,0)
 Q
"RTN","PSJOCDS",52,0)
UD ;Process data from a UD order
"RTN","PSJOCDS",53,0)
 NEW PSJDS,PSJFREQ,X
"RTN","PSJOCDS",54,0)
 ;At this state a dispense drug should be selected already.  But just incase...
"RTN","PSJOCDS",55,0)
 Q:'+PSJDD
"RTN","PSJOCDS",56,0)
 K PSJOCDS,PSJFDB
"RTN","PSJOCDS",57,0)
 ;If the drug is to be exempted then exclude it from the dose check
"RTN","PSJOCDS",58,0)
 Q:$$EXMT^PSSDSAPI(PSJDD)
"RTN","PSJOCDS",59,0)
 S PSJCNT=1
"RTN","PSJOCDS",60,0)
 S PSJDS=""
"RTN","PSJOCDS",61,0)
 ;
"RTN","PSJOCDS",62,0)
 S X=$$DOSE()
"RTN","PSJOCDS",63,0)
 S PSJOCDS(PSJCNT,"DRG_AMT")=$P(X,U)
"RTN","PSJOCDS",64,0)
 S PSJOCDS(PSJCNT,"DRG_UNIT")=$P(X,U,2)
"RTN","PSJOCDS",65,0)
 S PSJOCDS(PSJCNT,"DO")=$P(X,U,3)
"RTN","PSJOCDS",66,0)
 ;
"RTN","PSJOCDS",67,0)
 S X=$$DATES(PSJPON)
"RTN","PSJOCDS",68,0)
 S X=$$DURATION($P(X,U),$P(X,U,2))
"RTN","PSJOCDS",69,0)
 ;S X=$$DURATION($G(PSGSD),$G(PSGFD))
"RTN","PSJOCDS",70,0)
 S PSJOCDS(PSJCNT,"DRATE")=$S(+X:X_"M",1:"")
"RTN","PSJOCDS",71,0)
 ;S PSJOCDS(PSJCNT,"DUR")=X
"RTN","PSJOCDS",72,0)
 ;S PSJOCDS(PSJCNT,"DUR_RT")=$S(+X:"MINUTE",1:"")
"RTN","PSJOCDS",73,0)
 S PSJOCDS(PSJCNT,"MR_IEN")=$G(PSGMR)
"RTN","PSJOCDS",74,0)
 S PSJOCDS(PSJCNT,"SCHEDULE")=$G(PSGSCH)
"RTN","PSJOCDS",75,0)
 D FDBDATA
"RTN","PSJOCDS",76,0)
 ;D LITER
"RTN","PSJOCDS",77,0)
 Q
"RTN","PSJOCDS",78,0)
FDBDATA ;Set data needed by FDB's Dose API
"RTN","PSJOCDS",79,0)
 ;Use the OI + Dosage form when display drug name.  If OI IEN doesn't exist, use DD name
"RTN","PSJOCDS",80,0)
 NEW PSJOINM,PSJXSCH,X
"RTN","PSJOCDS",81,0)
 S PSJFDB(PSJCNT,"RX_NUM")="I;"_PSJPON_";PROSPECTIVE;"_PSJCNT
"RTN","PSJOCDS",82,0)
 S PSJFDB(PSJCNT,"DRUG_IEN")=PSJDD
"RTN","PSJOCDS",83,0)
 S PSJOINM=$$DRGNM^PSGSICHK()
"RTN","PSJOCDS",84,0)
 S PSJFDB(PSJCNT,"DRUG_NM")=$S(PSJOINM]"":PSJOINM,1:$$DN^PSJMISC(+PSJDD))
"RTN","PSJOCDS",85,0)
 I PSJOCDS(PSJCNT,"DO")=(PSJOCDS(PSJCNT,"DRG_AMT")_PSJOCDS(PSJCNT,"DRG_UNIT")) D
"RTN","PSJOCDS",86,0)
 . Q:PSJOCDS(PSJCNT,"DO")=""
"RTN","PSJOCDS",87,0)
 .;Strip off leading zero otherwise FDB triggers an "Invalid or Undefined Dose"
"RTN","PSJOCDS",88,0)
 . S X=PSJOCDS(PSJCNT,"DRG_AMT")
"RTN","PSJOCDS",89,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=$S(+X=0:X,1:+X)
"RTN","PSJOCDS",90,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=$$UNIT^PSSDSAPI(PSJOCDS(PSJCNT,"DRG_UNIT"))
"RTN","PSJOCDS",91,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSJOCDS",92,0)
 ;
"RTN","PSJOCDS",93,0)
 S X="",PSJXSCH=PSGSCH
"RTN","PSJOCDS",94,0)
 I $G(PSGS0XT)="" S PSGS0XT=$$DOW^PSJAPIDS(PSGSCH)
"RTN","PSJOCDS",95,0)
 I $G(PSGS0XT)="D",$G(PSGS0Y)]"" S $P(PSJXSCH,"@",2)=$G(PSGS0Y)
"RTN","PSJOCDS",96,0)
 I $G(PSGSCH)]"" S X=$P($$FRQ^PSSDSAPI(PSJXSCH,$G(PSGS0XT),"I"),U)
"RTN","PSJOCDS",97,0)
 I X="" S X=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSJOCDS",98,0)
 S PSJFDB(PSJCNT,"FREQ")=X
"RTN","PSJOCDS",99,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSJOCDS",100,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSJOCDS",101,0)
 S PSJFDB(PSJCNT,"ROUTE")=$P($$MRT^PSSDSAPI($G(PSGMR)),U,2)
"RTN","PSJOCDS",102,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="MAINTENANCE"
"RTN","PSJOCDS",103,0)
 S PSJFDB(PSJCNT,"SPECIFIC")=1
"RTN","PSJOCDS",104,0)
 ;Set data for onetime or <24 hours order
"RTN","PSJOCDS",105,0)
 S X=$$ONE^PSJORPOE($G(PSGSCH))
"RTN","PSJOCDS",106,0)
 I +X!($G(PSGST)="O")!+$$ONCALL^PSJMISC($G(PSGSCH),$G(PSGST)) D  Q
"RTN","PSJOCDS",107,0)
 . K PSJFDB(PSJCNT,"FRQ_ERROR")
"RTN","PSJOCDS",108,0)
 . S PSJFDB(PSJCNT,"DOSE_TYPE")="SINGLE DOSE"
"RTN","PSJOCDS",109,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSJOCDS",110,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DURATION_RT")
"RTN","PSJOCDS",111,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSJOCDS",112,0)
 I +PSJOCDS(PSJCNT,"DRATE") D UND24HRS(+PSJOCDS(PSJCNT,"DRATE"),$G(PSGAT),$G(PSGS0XT),PSGSD,PSGFD,PSGSCH)
"RTN","PSJOCDS",113,0)
 Q
"RTN","PSJOCDS",114,0)
LITER ;FDB requires "L" instead of ML for the particular conditions below
"RTN","PSJOCDS",115,0)
 ;PSJ*5*252 (6/29/11)- This module is longer called since FDB handles either "ML" or "L" now.
"RTN","PSJOCDS",116,0)
 NEW PSJXDO
"RTN","PSJOCDS",117,0)
 Q:'$G(PSJDD)
"RTN","PSJOCDS",118,0)
 Q:$G(PSJFDB(1,"ROUTE"))'="INTRAVENOUS"
"RTN","PSJOCDS",119,0)
 Q:$G(PSGST)'="R"
"RTN","PSJOCDS",120,0)
 Q:$$VAGEN^PSJMISC(PSJDD)'["POTASSIUM"
"RTN","PSJOCDS",121,0)
 Q:$$CLASS^PSJMISC(PSJDD)'="TN102"
"RTN","PSJOCDS",122,0)
 S PSJXDO=PSJOCDS(PSJCNT,"DO")
"RTN","PSJOCDS",123,0)
 I PSJXDO["ML" D
"RTN","PSJOCDS",124,0)
 . Q:'+PSJXDO
"RTN","PSJOCDS",125,0)
 . S (PSJOCDS(PSJCNT,"DRG_AMT"),PSJFDB(PSJCNT,"DOSE_AMT"))=+(+PSJXDO/1000)
"RTN","PSJOCDS",126,0)
 . S (PSJOCDS(1,"DRG_UNIT"),PSJFDB(PSJCNT,"DOSE_UNIT"))="L"
"RTN","PSJOCDS",127,0)
 Q
"RTN","PSJOCDS",128,0)
UND24HRS(PSJDUR,PSGAT,PSGS0XT,PSGSD,PSGFD,PSGSCH) ;
"RTN","PSJOCDS",129,0)
 ;*** This line tag is called by ^PSIVOCDS also ***
"RTN","PSJOCDS",130,0)
 ;PSJDUR - order duration in minutes
"RTN","PSJOCDS",131,0)
 ;PSGAT - admin times
"RTN","PSJOCDS",132,0)
 ;PSGS0XT - Order Frequency
"RTN","PSJOCDS",133,0)
 NEW PSJNDOSE,PSJFRQ1,PSJFRQ2,PSJFRQX,PSJX
"RTN","PSJOCDS",134,0)
 Q:'+$G(PSJDUR)
"RTN","PSJOCDS",135,0)
 ; Set frequency to # of amdin times
"RTN","PSJOCDS",136,0)
 I ($G(PSGAT)]"") D  Q
"RTN","PSJOCDS",137,0)
 . S PSJX=$$DATES(PSJPON)
"RTN","PSJOCDS",138,0)
 . S PSJNDOSE=$$CNTDOSE($P(PSJX,U),$P(PSJX,U,2))
"RTN","PSJOCDS",139,0)
 . I PSJNDOSE S PSJFDB(PSJCNT,"FREQ")=PSJNDOSE Q
"RTN","PSJOCDS",140,0)
 ; Set frequency based on frequency(51.1)
"RTN","PSJOCDS",141,0)
 S PSJFRQ2=+$P($$FRQ^PSSDSAPI($G(PSGSCH),$G(PSGS0XT),"I"),U)
"RTN","PSJOCDS",142,0)
 ; If frequency is there then set freq = duration in min / freq in min
"RTN","PSJOCDS",143,0)
 I +$G(PSGS0XT) S PSJFRQ1=(+PSJDUR)/PSGS0XT
"RTN","PSJOCDS",144,0)
 ; Calculate freq from number of dose admin per day
"RTN","PSJOCDS",145,0)
 I '+$G(PSGS0XT),PSJFRQ2 S PSJFRQ1=(PSJFRQ2/24)*(+PSJDUR/60)
"RTN","PSJOCDS",146,0)
 S PSJFDB(PSJCNT,"FREQ")=$J($G(PSJFRQ1),"",0)
"RTN","PSJOCDS",147,0)
 I PSJFDB(PSJCNT,"FREQ")'=0 Q
"RTN","PSJOCDS",148,0)
 ; If no admin times or frequency(51.1) set error
"RTN","PSJOCDS",149,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSJOCDS",150,0)
 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSJOCDS",151,0)
 Q
"RTN","PSJOCDS",152,0)
CNTDOSE(PSGSD,PSGFD) ;Count # of admins to set the Freq to
"RTN","PSJOCDS",153,0)
 ;only do this if the start & stop dates are within 24 hours.
"RTN","PSJOCDS",154,0)
 NEW PSJX,PSJADMIN,PSJCNT,PSJSTRTM,PSJSTPTM,PSJDTFLG
"RTN","PSJOCDS",155,0)
 I $G(PSGAT)="" Q 0
"RTN","PSJOCDS",156,0)
 I $G(PSGSD)="" Q 0
"RTN","PSJOCDS",157,0)
 I $G(PSGFD)="" Q 0
"RTN","PSJOCDS",158,0)
 I ($$FMDIFF^XLFDT(PSGFD,PSGSD,2)/60)>1440 Q 0
"RTN","PSJOCDS",159,0)
 S PSJCNT=0
"RTN","PSJOCDS",160,0)
 S PSJSTRTM=$E($P(PSGSD,".",2)_"0000",1,4)
"RTN","PSJOCDS",161,0)
 S PSJSTPTM=$E($P(PSGFD,".",2)_"0000",1,4)
"RTN","PSJOCDS",162,0)
 S PSJDTFLG=0
"RTN","PSJOCDS",163,0)
 I $P(PSGSD,".")=$P(PSGFD,".") S PSJDTFLG=1
"RTN","PSJOCDS",164,0)
 F PSJX=1:1 S PSJADMIN=$P(PSGAT,"-",PSJX) Q:PSJADMIN=""  D
"RTN","PSJOCDS",165,0)
 . S PSJADMIN=$E($P(PSGAT,"-",PSJX)_"0000",1,4)
"RTN","PSJOCDS",166,0)
 . I PSJDTFLG D  Q
"RTN","PSJOCDS",167,0)
 .. I (PSJSTRTM'>PSJADMIN),(PSJADMIN<PSJSTPTM) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",168,0)
 . I (PSJSTRTM'>PSJADMIN) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",169,0)
 . I (PSJSTPTM>PSJADMIN) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",170,0)
 Q PSJCNT
"RTN","PSJOCDS",171,0)
DURATION(PSGSD,PSGFD) ;Figure out the duration from the start, stop dates
"RTN","PSJOCDS",172,0)
 ;Return the diff between Stop - Start date in minutes.  If > 1 day then return null
"RTN","PSJOCDS",173,0)
 NEW PSJDIFF
"RTN","PSJOCDS",174,0)
 I '$D(PSGFD)!'$D(PSGSD) Q ""
"RTN","PSJOCDS",175,0)
 S PSJDIFF=$$FMDIFF^XLFDT(PSGFD,PSGSD,2)/60
"RTN","PSJOCDS",176,0)
 I (PSJDIFF<1440) Q PSJDIFF
"RTN","PSJOCDS",177,0)
 Q ""
"RTN","PSJOCDS",178,0)
DOSE() ;Figure out the dose, unit, & dosage Ordered
"RTN","PSJOCDS",179,0)
 ;Return 3 pieces: Numeric Dose ^ Unit ^ Dosage Ordered
"RTN","PSJOCDS",180,0)
 NEW PSJDS,PSJND0,PSJND2,X,PSJX,PSJXDOX,PSJNDS,PSJALLGY
"RTN","PSJOCDS",181,0)
 S PSJDS=""
"RTN","PSJOCDS",182,0)
 ;Subsequence orders in the Complex order has the PSGDO from the first order. Get new PSGDO
"RTN","PSJOCDS",183,0)
 I $G(PSJPON)["U",$S($G(PSJCOM):1,$G(PSGRENEW):1,1:0) S PSGDO=$P($G(^PS(55,DFN,5,+PSJPON,.2)),U,2)
"RTN","PSJOCDS",184,0)
 ;If the dose & unit exist use them
"RTN","PSJOCDS",185,0)
 I +$G(PSJDOSE("DO"))_$P($G(PSJDOSE("DO")),U,2)=$G(PSGDO) Q PSJDOSE("DO")_U_$G(PSGDO)
"RTN","PSJOCDS",186,0)
 ;Get dd, dose, unit from the order
"RTN","PSJOCDS",187,0)
 I $G(PSGORD)]"",'+$G(PSJDD) D
"RTN","PSJOCDS",188,0)
 . I PSGORD["P" S PSJND2=$G(^PS(53.1,+PSGORD,.2)),PSJDD=$O(^PS(53.1,+PSGORD,1,"B",0))
"RTN","PSJOCDS",189,0)
 . I PSGORD["U" S PSJND2=$G(^PS(55,DFN,5,+PSGORD,.2)),PSJDD=$O(^PS(53.1,+DFN,5,+PSGORD,1,"B",0))
"RTN","PSJOCDS",190,0)
 ;If no numeric dose and there is a dosage ordered then get dose & unit from the order
"RTN","PSJOCDS",191,0)
 I $D(PSGORD),$G(PSGDO)]"" D
"RTN","PSJOCDS",192,0)
 . S PSJDS=$P($G(PSJND2),U,5,6)
"RTN","PSJOCDS",193,0)
 Q:+PSJDS PSJDS_U_$G(PSGDO)
"RTN","PSJOCDS",194,0)
 ;Get dispense unit per dose and figure out numeric and unit
"RTN","PSJOCDS",195,0)
 I +$G(PSJDD),($G(PSGDO)]"") D
"RTN","PSJOCDS",196,0)
 . S PSJDS=$$DOSE1()
"RTN","PSJOCDS",197,0)
 . I $P($G(PSJXDOX(1)),U,11)=$$UP^XLFSTR(PSGDO) Q:+PSJDS
"RTN","PSJOCDS",198,0)
 . S PSJDS=""
"RTN","PSJOCDS",199,0)
 . S PSJX=$G(PSJXDOX(1))
"RTN","PSJOCDS",200,0)
 . I +PSJX S X=+PSGDO/+PSJX S PSJDS=$$DOSE1(X)
"RTN","PSJOCDS",201,0)
 . I $P($G(PSJXDOX(1)),U,11)=$$UP^XLFSTR(PSGDO) Q:+PSJDS
"RTN","PSJOCDS",202,0)
 . S PSJDS=""
"RTN","PSJOCDS",203,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",204,0)
 I +$G(PSJDD),($G(PSGDO)=""),($G(PSGORD)="") D
"RTN","PSJOCDS",205,0)
 . S PSJDS=$$DOSE1($S(+$G(PSGUD):PSGUD,1:1))
"RTN","PSJOCDS",206,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",207,0)
 ;Figure out dose & unit from the dispense drug.  Dosage Ordered is required for multiple dispense drugs
"RTN","PSJOCDS",208,0)
 I $G(PSGDO)="" D
"RTN","PSJOCDS",209,0)
 . S PSJND0=$$DD53P45^PSJMISC()
"RTN","PSJOCDS",210,0)
 . I PSJND0="" S PSJND0=$G(PSGDRG)
"RTN","PSJOCDS",211,0)
 . S X=+$P(PSJND0,U,2) S PSJDS=$$DOSE1($S(X:X,1:1))
"RTN","PSJOCDS",212,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",213,0)
 Q "^^"_$G(PSGDO)
"RTN","PSJOCDS",214,0)
DOSE1(PSJDUP) ;
"RTN","PSJOCDS",215,0)
 ;PSJDUP - Dispense unit per dose
"RTN","PSJOCDS",216,0)
 NEW PSJDS
"RTN","PSJOCDS",217,0)
 Q:'+$G(PSJDD)
"RTN","PSJOCDS",218,0)
 K PSJXDOX
"RTN","PSJOCDS",219,0)
 S PSJDS=""
"RTN","PSJOCDS",220,0)
 D DOSE^PSSORPH(.PSJXDOX,+PSJDD,"U",,$G(PSJDUP))
"RTN","PSJOCDS",221,0)
 S:$G(PSJXDOX(1)) PSJDS=$P(PSJXDOX(1),U,1,2)_U_$P(PSJXDOX(1),U)_$P(PSJXDOX(1),U,2)
"RTN","PSJOCDS",222,0)
 Q PSJDS
"RTN","PSJOCDS",223,0)
DATES(PSJPON) ;Check the correct Start, Stop dates to use
"RTN","PSJOCDS",224,0)
 ;PSJOCDSC("CX",PSGsd/PSGfd,on)=default PSGsd/PSGfd date _^_ PSGsd/PSGfd _^_PSJFLG
"RTN","PSJOCDS",225,0)
 ;PSJP1 = Start date; PSJP2 = Stop date; PSJFLG = 1 if start or stop date has changed.
"RTN","PSJOCDS",226,0)
 ;For some reasons, PSGSD redefined to cal start date for Complex order (one with duration),
"RTN","PSJOCDS",227,0)
 ; PSGFD redefined to cal stop date.  These 2 fields reflect the default start, stop dates if they
"RTN","PSJOCDS",228,0)
 ; were edited.
"RTN","PSJOCDS",229,0)
 ;
"RTN","PSJOCDS",230,0)
 NEW PSJXSD,PSJXFD,PSJP1,PSJP2,PSJFLG,X
"RTN","PSJOCDS",231,0)
 I '+$G(PSJPON) Q $G(PSGSD)_U_$G(PSGFD)_U_0
"RTN","PSJOCDS",232,0)
 S PSJFLG=0
"RTN","PSJOCDS",233,0)
 S PSJP1=$G(PSGSD),PSJP2=$G(PSGFD)
"RTN","PSJOCDS",234,0)
 I $D(PSJOCDSC("CX","PSGSD")) D
"RTN","PSJOCDS",235,0)
 . S PSJXSD=$G(PSJOCDSC("CX","PSGSD",+PSJPON))
"RTN","PSJOCDS",236,0)
 . S PSJXFD=$G(PSJOCDSC("CX","PSGFD",+PSJPON))
"RTN","PSJOCDS",237,0)
 . I PSGSD=$P(PSJXSD,U,2) S PSJP1=$P(PSJXSD,U)
"RTN","PSJOCDS",238,0)
 .;
"RTN","PSJOCDS",239,0)
 . I $P(PSJXFD,U,2)]"",(PSGFD=$P(PSJXFD,U,2)) S PSJP2=$P(PSJXFD,U)
"RTN","PSJOCDS",240,0)
 . I $P(PSJXFD,U,2)="" S $P(PSJXFD,U,2)=PSGFD,PSJP2=PSGFD
"RTN","PSJOCDS",241,0)
 .;
"RTN","PSJOCDS",242,0)
 .; I $P(PSJXFD,U,2)="" S $P(PSJXFD,U,2)=PSGFD
"RTN","PSJOCDS",243,0)
 .; I PSGFD=$P(PSJXFD,U,2) S PSJP2=$P(PSJXFD,U)
"RTN","PSJOCDS",244,0)
 . I (PSJXSD]"")!(PSJXFD]"") D
"RTN","PSJOCDS",245,0)
 .. I $S($G(PSGSD)'=$P(PSJXSD,U,2):1,$G(PSGFD)'=$P(PSJXFD,U,2):1,1:0) S PSJFLG=1
"RTN","PSJOCDS",246,0)
 . S X=$G(^PS(53.1,+PSJPON,2.5))
"RTN","PSJOCDS",247,0)
 . ;Reset PSJP1 & PSJP2 from the order is needed when complex order defaulted to IV but FN as UD,
"RTN","PSJOCDS",248,0)
 . ; the calc Start/stop dates were used therefore the duration was not considered.
"RTN","PSJOCDS",249,0)
 . I (PSJPON["P"),(PSJFLG=0),($P(X,U,2)]"") S PSJP1=$P(X,U,1),PSJP2=$P(X,U,3)
"RTN","PSJOCDS",250,0)
 Q PSJP1_U_PSJP2_U_PSJFLG
"RTN","PSJOCDT")
0^35^B55618824
"RTN","PSJOCDT",1,0)
PSJOCDT ;BIR/MV - PROCESS DUPLICATE THERAPY ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCDT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,260,288,257**;16 DEC 97;Build 105
"RTN","PSJOCDT",3,0)
 ;
"RTN","PSJOCDT",4,0)
 ; Reference to EN^PSODRDU2 is supported by DBIA# 2189.
"RTN","PSJOCDT",5,0)
 ;
"RTN","PSJOCDT",6,0)
DT ;
"RTN","PSJOCDT",7,0)
 NEW PSJN1,PSJCLASS,PSJDNCNT,PSJNDV,PSJPROSP,PSJOCDT
"RTN","PSJOCDT",8,0)
 S PSJCLASS=""
"RTN","PSJOCDT",9,0)
 F PSJN1=0:0 S PSJN1=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1)) Q:'PSJN1  D
"RTN","PSJOCDT",10,0)
 . D SETCLASS
"RTN","PSJOCDT",11,0)
 . F PSJDNCNT=0:0 S PSJDNCNT=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",PSJDNCNT)) Q:'PSJDNCNT  D
"RTN","PSJOCDT",12,0)
 .. S PSJNDV=$G(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",PSJDNCNT))
"RTN","PSJOCDT",13,0)
 .. D SETOC
"RTN","PSJOCDT",14,0)
 I '$D(PSJPROSP) Q
"RTN","PSJOCDT",15,0)
 D DSPOC
"RTN","PSJOCDT",16,0)
 Q
"RTN","PSJOCDT",17,0)
DTDGCK ;This version of DT is only executed when the user selects hidden action CK (Drug Check)
"RTN","PSJOCDT",18,0)
 NEW PSJN1,PSJCLASS,PSJDNCNT,PSJNDV,PSJPROSP,PSJOCDT,PSJXX
"RTN","PSJOCDT",19,0)
 S PSJCLASS=""
"RTN","PSJOCDT",20,0)
 F PSJXX=1:1:2 D
"RTN","PSJOCDT",21,0)
 .F PSJN1=0:0 S PSJN1=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1)) Q:'PSJN1  D
"RTN","PSJOCDT",22,0)
 ..I PSJXX=1 I $P(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",1),";",3)'="PROSPECTIVE" Q
"RTN","PSJOCDT",23,0)
 ..I PSJXX=2 I $P(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",1),";",3)'="PROFILE" Q
"RTN","PSJOCDT",24,0)
 ..D SETCLASS
"RTN","PSJOCDT",25,0)
 ..F PSJDNCNT=0:0 S PSJDNCNT=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",PSJDNCNT)) Q:'PSJDNCNT  D
"RTN","PSJOCDT",26,0)
 ...S PSJNDV=$G(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",PSJDNCNT))
"RTN","PSJOCDT",27,0)
 ...D SETOC
"RTN","PSJOCDT",28,0)
 ..D DSPOC K PSJOCDT,PSJPROSP S PSJCLASS=""
"RTN","PSJOCDT",29,0)
 Q
"RTN","PSJOCDT",30,0)
DSPOC ;
"RTN","PSJOCDT",31,0)
 ;PSJDSPON(ON) - Is set after the order is displayed so the same order is not displayed again
"RTN","PSJOCDT",32,0)
 NEW PSJTYPE,PSJDNM,PSPON,PSJPONX,PSJX,PSJDSPON,PSJCLINF
"RTN","PSJOCDT",33,0)
 D HDR
"RTN","PSJOCDT",34,0)
 F PSJTYPE=0:0 S PSJTYPE=$O(PSJOCDT(PSJTYPE)) Q:'PSJTYPE  D
"RTN","PSJOCDT",35,0)
 . S PSJDNM="" F  S PSJDNM=$O(PSJOCDT(PSJTYPE,PSJDNM)) Q:PSJDNM=""  D
"RTN","PSJOCDT",36,0)
 .. S PSJPON="" F  S PSJPON=$O(PSJOCDT(PSJTYPE,PSJDNM,PSJPON)) Q:PSJPON=""  D
"RTN","PSJOCDT",37,0)
 ... K PSJCLINF S PSJCLINF="" I $P(PSJPON,";",2)'="",PSJOCDT(PSJTYPE,PSJDNM,PSJPON)'=""  S PSJCLINF=PSJOCDT(PSJTYPE,PSJDNM,PSJPON),PSJCLINF(2)=PSJPON,PSJCLINF(3)=PSJDNM
"RTN","PSJOCDT",38,0)
 ... I ($Y+6)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",39,0)
 ... S PSJPONX=$P(PSJPON,";",2)
"RTN","PSJOCDT",40,0)
 ... I PSJTYPE=10,+PSJPONX D
"RTN","PSJOCDT",41,0)
 .... I '$D(PSJDSPON(PSJPONX)) D DSPORD^PSJOC(PSJPONX,,.PSJCLINF)
"RTN","PSJOCDT",42,0)
 .... S PSJDSPON(PSJPONX)=""
"RTN","PSJOCDT",43,0)
 ... I ($Y+8)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",44,0)
 ... I PSJTYPE>10 D
"RTN","PSJOCDT",45,0)
 .... I PSJCLINF D CLNDISP^PSJCLNOC(.PSJCLINF) Q
"RTN","PSJOCDT",46,0)
 .... D EN^PSODRDU2(DFN,PSJPON,"PSJPRE")
"RTN","PSJOCDT",47,0)
 ;Break the display text this way so the info on classes are indented correctly
"RTN","PSJOCDT",48,0)
 S PSJCLASS=" Involved in Therapeutic Duplication(s): "_PSJCLASS
"RTN","PSJOCDT",49,0)
 S PSJX=$L(PSJCLASS)\65 I ($Y+PSJX+4)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",50,0)
 W !,"Class(es)"
"RTN","PSJOCDT",51,0)
 D MYWRITE^PSJMISC(PSJCLASS,3,67)
"RTN","PSJOCDT",52,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",53,0)
 W !
"RTN","PSJOCDT",54,0)
 ;D LINE^PSJMISC($S($G(PSJOLDN):PSJLINE,1:"="),81)
"RTN","PSJOCDT",55,0)
 D LINE^PSJMISC("=",81)
"RTN","PSJOCDT",56,0)
 I '$D(PSJOCDT(10)),$D(PSJOCDT) K PSJPAUSE D PAUSE^PSJLMUT1 W @IOF Q
"RTN","PSJOCDT",57,0)
 ;I ($Y+8)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",58,0)
 I $D(PSJDGCK) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR Q
"RTN","PSJOCDT",59,0)
 I $D(PSJDGCK) Q
"RTN","PSJOCDT",60,0)
 D CONT
"RTN","PSJOCDT",61,0)
 Q:$G(PSGORQF)
"RTN","PSJOCDT",62,0)
 S PSJY=$$SORTLST()
"RTN","PSJOCDT",63,0)
 K PSJPAUSE
"RTN","PSJOCDT",64,0)
 I PSJY=1 D  Q
"RTN","PSJOCDT",65,0)
 . W !!
"RTN","PSJOCDT",66,0)
 . D:'$D(PSJDGCK) PROCLST(PSJY)
"RTN","PSJOCDT",67,0)
 I (PSJY>1),+$$DCPROMPT() D
"RTN","PSJOCDT",68,0)
 . W !
"RTN","PSJOCDT",69,0)
 . S PSJY=$$LST() W !
"RTN","PSJOCDT",70,0)
 . D:'$D(PSJDGCK) PROCLST(PSJY)
"RTN","PSJOCDT",71,0)
 Q
"RTN","PSJOCDT",72,0)
HDR ;
"RTN","PSJOCDT",73,0)
 NEW PSJHDR,PSJDNM
"RTN","PSJOCDT",74,0)
 I $D(^TMP($J,"PSJPRE","OUT","DRUGDRUG")) W @IOF
"RTN","PSJOCDT",75,0)
 D LINE^PSJMISC("=",81)
"RTN","PSJOCDT",76,0)
 S PSJHDR="This patient is already receiving the following INPATIENT and/or OUTPATIENT order(s) for a drug in the same therapeutic class(es)"
"RTN","PSJOCDT",77,0)
 S:$D(PSJDGCK) PSJHDR="This patient is already receiving the following INPATIENT and/or OUTPATIENT order(s) for drugs in the same therapeutic class(es)"
"RTN","PSJOCDT",78,0)
 S PSJDNM=$O(PSJPROSP("UD",""))
"RTN","PSJOCDT",79,0)
 I PSJDNM]"" S PSJHDR=PSJHDR_" as "_PSJDNM_":" D WRITE^PSJMISC(PSJHDR,1,77) Q
"RTN","PSJOCDT",80,0)
 D WRITE^PSJMISC(PSJHDR_":",1,77)
"RTN","PSJOCDT",81,0)
HDR2 ;
"RTN","PSJOCDT",82,0)
 W !,"Drug(s) Ordered:"
"RTN","PSJOCDT",83,0)
 S PSJDNM="" F  S PSJDNM=$O(PSJPROSP("IV",PSJDNM)) Q:PSJDNM=""  D
"RTN","PSJOCDT",84,0)
 . W !,?3,PSJDNM
"RTN","PSJOCDT",85,0)
 . I ($Y+8)>IOSL D PAUSE^PSJMISC() W @IOF
"RTN","PSJOCDT",86,0)
 W !
"RTN","PSJOCDT",87,0)
 Q
"RTN","PSJOCDT",88,0)
SETCLASS ;Store all classes to display at the end.
"RTN","PSJOCDT",89,0)
 NEW PSJN2,PSJCLS
"RTN","PSJOCDT",90,0)
 F PSJN2=0:0 S PSJN2=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,PSJN2)) Q:'PSJN2  D
"RTN","PSJOCDT",91,0)
 . S PSJCLS=$G(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,PSJN2,"CLASS"))
"RTN","PSJOCDT",92,0)
 . S PSJCLASS=PSJCLASS_$S(PSJCLASS="":"",1:", ")_PSJCLS
"RTN","PSJOCDT",93,0)
 Q
"RTN","PSJOCDT",94,0)
SETOC ;Set PSJOCDT array to sort by Package(Inpt, Outpt: Active, Remote, Pending, Non-VA
"RTN","PSJOCDT",95,0)
 ;PSJPROSP(UD/IV,drugname)="" - This is used to display the header
"RTN","PSJOCDT",96,0)
 ;PSJOCDT(package,drugname,Pharm ord#)=""
"RTN","PSJOCDT",97,0)
 NEW PSJPON,PSJPKG,PSJTYPE,PSJDNM,PSJPONX,PSJCLINF,PSJDXOPT
"RTN","PSJOCDT",98,0)
 S PSJPON=$P(PSJNDV,U) Q:PSJPON=""
"RTN","PSJOCDT",99,0)
 S PSJCLINF="",PSJDXOPT=$S($G(PSJDGCK):"PROSPECTIVE",1:"PROFILE")
"RTN","PSJOCDT",100,0)
 I $P(PSJPON,";",3)'="PROSPECTIVE" S PSJCLINF=$P(^TMP($J,"PSJPRE","IN",PSJDXOPT,PSJPON),"^",7)
"RTN","PSJOCDT",101,0)
 S PSJPONX=$P(PSJPON,";",2)
"RTN","PSJOCDT",102,0)
 S PSJTYPE=$P(PSJPON,";") Q:PSJTYPE=""
"RTN","PSJOCDT",103,0)
 S PSJDNM=$P(PSJNDV,U,3) Q:PSJDNM=""
"RTN","PSJOCDT",104,0)
 S PSJPKG=$S(PSJTYPE["C":10,PSJTYPE="I":10,PSJTYPE="O":20,PSJTYPE="R":30,PSJTYPE="P":40,PSJTYPE="N":50,1:"")
"RTN","PSJOCDT",105,0)
 ; Set prospective drug name array to display in the header.
"RTN","PSJOCDT",106,0)
 I PSJPKG=10,($P(PSJPON,";",3)="PROSPECTIVE") D  Q
"RTN","PSJOCDT",107,0)
 . I PSJPONX["V" S PSJPROSP("IV",PSJDNM)="" Q
"RTN","PSJOCDT",108,0)
 . I PSJPONX["P",+$G(PSJLIFNI) S PSJPROSP("IV",PSJDNM)="" Q
"RTN","PSJOCDT",109,0)
 . I PSJPONX["P",($P($G(^PS(53.1,+PSJPONX,8)),U)]"") S PSJPROSP("IV",PSJDNM)="" Q
"RTN","PSJOCDT",110,0)
 . S PSJPROSP("UD",PSJDNM)=""
"RTN","PSJOCDT",111,0)
 S PSJOCDT(PSJPKG,PSJDNM,PSJPON)=PSJCLINF
"RTN","PSJOCDT",112,0)
 Q
"RTN","PSJOCDT",113,0)
CONT ;Display the continue prompt.
"RTN","PSJOCDT",114,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJOCDT",115,0)
 W !
"RTN","PSJOCDT",116,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")=$S($D(PSJDGCK):"Do you wish to continue",1:"Do you wish to continue with the current order")
"RTN","PSJOCDT",117,0)
 S DIR("?",1)="Enter 'NO' if you wish to not continue with the order,",DIR("?")="or 'YES' to continue with the current order."
"RTN","PSJOCDT",118,0)
 D ^DIR
"RTN","PSJOCDT",119,0)
 I 'Y!($G(PSJDGCK)) S PSGORQF=1 S VALMBCK="R"
"RTN","PSJOCDT",120,0)
 Q
"RTN","PSJOCDT",121,0)
DCPROMPT() ;Prompt if user wants to DC order(s)
"RTN","PSJOCDT",122,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJOCDT",123,0)
 W !
"RTN","PSJOCDT",124,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Do you wish to DISCONTINUE any of the listed INPATIENT orders"
"RTN","PSJOCDT",125,0)
 S DIR("?",1)="Enter 'NO' if you don't wish to discontinue any of the order(s),",DIR("?")="or 'YES' to discontinue selected order(s)."
"RTN","PSJOCDT",126,0)
 D ^DIR
"RTN","PSJOCDT",127,0)
 Q Y
"RTN","PSJOCDT",128,0)
SORTLST() ;Sort orders into a numeric list
"RTN","PSJOCDT",129,0)
 NEW DIR,DIRUT,DTOUT,DUOUT,PSJN,PSJPON1,PSJMONV,PSJS,PSJSEV1,PSJX,X,Y,PSJDNM,PSJPONX,PSJDSPON,PSOCLINF
"RTN","PSJOCDT",130,0)
 ;Sort orders into a numeric list
"RTN","PSJOCDT",131,0)
 Q:'$D(PSJOCDT(10)) 0
"RTN","PSJOCDT",132,0)
 S PSJN=0,PSJDNM=""
"RTN","PSJOCDT",133,0)
 F  S PSJDNM=$O(PSJOCDT(10,PSJDNM)) Q:PSJDNM=""  S PSJS="" F  S PSJS=$O(PSJOCDT(10,PSJDNM,PSJS)) Q:PSJS=""  D
"RTN","PSJOCDT",134,0)
 . S PSJPONX=$P(PSJS,";",2)
"RTN","PSJOCDT",135,0)
 . S PSJCLINF="",PSJCLINF=PSJOCDT(10,PSJDNM,PSJS)
"RTN","PSJOCDT",136,0)
 . ;Business Rule(s): don't show orders that have a status of DISCONTINUED in list
"RTN","PSJOCDT",137,0)
 . Q:$D(PSJDSPON(PSJPONX))
"RTN","PSJOCDT",138,0)
 . S PSJDSPON(PSJPONX)=""
"RTN","PSJOCDT",139,0)
 . S:'$$CKDC^PSJOCDT PSJN=PSJN+1,PSJOCDTL(PSJN)=PSJPONX
"RTN","PSJOCDT",140,0)
 Q PSJN
"RTN","PSJOCDT",141,0)
LST() ;
"RTN","PSJOCDT",142,0)
 ;Only present the list if there are more than 1 orders the list
"RTN","PSJOCDT",143,0)
 F PSJX=0:0 S PSJX=$O(PSJOCDTL(PSJX)) Q:'PSJX  D
"RTN","PSJOCDT",144,0)
 . I ($Y+6)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",145,0)
 . D DSPORD^PSJOC(PSJOCDTL(PSJX),PSJX_".  ")
"RTN","PSJOCDT",146,0)
 W !
"RTN","PSJOCDT",147,0)
 K DIR S DIR(0)="LO^1:"_$O(PSJOCDTL(""),-1),DIR("A")="Enter a list or range of numbers to discontinue" D ^DIR K DIR
"RTN","PSJOCDT",148,0)
 Q Y
"RTN","PSJOCDT",149,0)
PROCLST(PSJY) ;DC the orders selected by user
"RTN","PSJOCDT",150,0)
 NEW PSJX,PSJX1,PSJON,PSJCLINF
"RTN","PSJOCDT",151,0)
 F PSJX1=1:1:$L(PSJY) S PSJX=$P(PSJY,",",PSJX1) Q:PSJX=""  D
"RTN","PSJOCDT",152,0)
 . I ($Y+8)>IOSL D PAUSE^PSJMISC() W @IOF
"RTN","PSJOCDT",153,0)
 . I '$D(PSJOCDTL(PSJX)) Q
"RTN","PSJOCDT",154,0)
 . S PSJON=PSJOCDTL(PSJX),PSJCLINF=0
"RTN","PSJOCDT",155,0)
 . I $D(PSJOCDTL(PSJX,"CLN")) S PSJCLINF=$P(PSJOCDTL(PSJX,"CLN"),"^"),PSJCLINF(2)=$P(PSJOCDTL(PSJX,"CLN"),"^",2),PSJCLINF(3)=$P(PSJOCDTL(PSJX,"CLN"),"^",3)
"RTN","PSJOCDT",156,0)
 . D DC^PSJOCDC(PSGP,PSJON,.PSJCLINF)
"RTN","PSJOCDT",157,0)
 . W !
"RTN","PSJOCDT",158,0)
 Q
"RTN","PSJOCDT",159,0)
CKDC() ; rule: don't show orders that have a status of DISCONTINUED in list
"RTN","PSJOCDT",160,0)
 N PSJCKPON,PSJCKFLD
"RTN","PSJOCDT",161,0)
 S (PSJCKFLD,PSJCKPON)="",PSJCKPON=$S(PSJPONX["U":55.06,PSJPONX["I"!(PSJPONX["V"):55.01,1:53.1)
"RTN","PSJOCDT",162,0)
 S PSJCKFLD=$S(PSJPONX["V"!(PSJPONX="I"):"100",1:"28")  ;Unit dose and pending/non-verified file statuses are in field 28 in each file
"RTN","PSJOCDT",163,0)
 D GETS^DIQ(PSJCKPON,+PSJPONX_","_DFN,PSJCKFLD,"I","DCTMP")
"RTN","PSJOCDT",164,0)
 I '$D(DCTMP(PSJCKPON,+PSJPONX_","_DFN_",",PSJCKFLD,"I")) K DCTMP Q 0
"RTN","PSJOCDT",165,0)
 I DCTMP(PSJCKPON,+PSJPONX_","_DFN_",",PSJCKFLD,"I")="D" K DCTMP Q 1
"RTN","PSJOCDT",166,0)
 K DCTMP Q 0
"RTN","PSJOEA2")
0^46^B30358376
"RTN","PSJOEA2",1,0)
PSJOEA2 ;BIR/MLM-INPATIENT ORDER ENTRY ; 5/11/09 7:50am
"RTN","PSJOEA2",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**127,133,200,267,268,257**;16 DEC 97;Build 105
"RTN","PSJOEA2",3,0)
 ;
"RTN","PSJOEA2",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOEA2",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789.
"RTN","PSJOEA2",6,0)
 ;
"RTN","PSJOEA2",7,0)
CHK ;Check to be sure all the orders in the complex order series are completed, continued.
"RTN","PSJOEA2",8,0)
 I 'PSJCOMV,'$G(COMQUIT) N PSJO S PSJO=0 F  S PSJO=$O(^TMP("PSJCOM",$J,PSJO)) Q:'PSJO  S PSGORD=+PSJO_"P",PSGND=$G(^PS(53.1,+PSJO,0)) D
"RTN","PSJOEA2",9,0)
 .S PSGP=$P(PSGND,"^",15)
"RTN","PSJOEA2",10,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="A",($P(PSGND,U,24)'="R") D ^PSGOT D  Q
"RTN","PSJOEA2",11,0)
 ..M ^PS(55,PSGP,5,+PSGORD,4)=^PS(53.1,PSJO,4)
"RTN","PSJOEA2",12,0)
 ..N PSGND2P5 S PSGND2P5=$G(^PS(53.1,+PSJO,2.5)),DUR=$P(PSGND2P5,"^",2) I $G(DUR)]"" N DA,DR,DIE S DIE="^PS(55,"_PSGP_",5,",DA(1)=PSGP,DA=+PSGORD,DR="126////"_$G(DUR) D ^DIE
"RTN","PSJOEA2",13,0)
 ..D KILL531^PSJIMO1(PSGP,"",+PSJO)
"RTN","PSJOEA2",14,0)
 ..D ACTLOG^PSJOEA(PSJO,PSGP,PSGORD)
"RTN","PSJOEA2",15,0)
 ..S VND4=$G(^PS(55,PSGP,5,+PSGORD,4))
"RTN","PSJOEA2",16,0)
 ..I PSJSYSL>1 S $P(^PS(55,PSGP,5,+PSGORD,7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"_$S($P(^PS(55,PSGP,5,+PSGORD,0),"^",24)="E":"E",1:"") S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSJOEA2",17,0)
 ..S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT
"RTN","PSJOEA2",18,0)
 ..; Set PV and NV flag according to PSJSYSU  (PSJ*5*200)
"RTN","PSJOEA2",19,0)
 ..S $P(VND4,"^",+PSJSYSU=1+9)=1 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9) S ^PS(55,PSGP,5,+PSGORD,4)=VND4
"RTN","PSJOEA2",20,0)
 ..I '$P(VND4,U,10) S ^PS(55,"ANV",PSGP,+PSGORD)=""
"RTN","PSJOEA2",21,0)
 ..I $P(VND4,U,9) K ^PS(55,"APV",PSGP,+PSGORD)
"RTN","PSJOEA2",22,0)
 ..I $P(VND4,U,10) K ^PS(55,"ANV",PSGP,+PSGORD)
"RTN","PSJOEA2",23,0)
 ..S:+PSJSYSU=3 ^PS(55,"AUE",PSGP,+PSGORD)=""
"RTN","PSJOEA2",24,0)
 ..S PSJCOM=$P($G(^PS(55,PSGP,5,+PSGORD,.2)),"^",8) I PSJCOM]"" K ^PS(53.1,"ACX",PSJCOM,PSJO) ;S $P(^PS(55,PSGP,5,+PSGORD,4),"^",9)=1
"RTN","PSJOEA2",25,0)
 ..D EN1^PSJHL2(PSGP,$S(+PSJSYSU=3:"SC",+PSJSYSU=1:"SC",1:"XX"),+PSGORD_"U")     ; allow status change to be sent for pharmacists & nurses
"RTN","PSJOEA2",26,0)
 ..D:+PSJSYSU=1 EN1^PSJHL2(PSGP,"ZV",+PSGORD_"U") L -^PS(55,PSGP,5,+PSGORD)
"RTN","PSJOEA2",27,0)
 ..; ** This is where the Automated Dispensing hook is called. Do NOT DELETE or change location **
"RTN","PSJOEA2",28,0)
 ..D NEWJ^PSJADM
"RTN","PSJOEA2",29,0)
 ..; ** END to Interface Hook **
"RTN","PSJOEA2",30,0)
 ..S PSJPREX=1 D CMPLX2^PSJCOM1(PSGP,PSJORD,PSGORD) K PSJPREX
"RTN","PSJOEA2",31,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="A" D GT531^PSIVORFA(PSGP,PSJO_"P") D  Q
"RTN","PSJOEA2",32,0)
 ..S ON55="" I $P(PSGND,"^",24)="R" S ON55=$P(PSGND,"^",25) D
"RTN","PSJOEA2",33,0)
 ...N PND0,PSGORDR S PND0=^PS(53.1,+PSJO,0),PSGORDR=$P(PND0,U,25)
"RTN","PSJOEA2",34,0)
 ...Q:'$$LS^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJOEA2",35,0)
 ...D KILL531^PSJIMO1(PSGP,"",+PSJO)
"RTN","PSJOEA2",36,0)
 ...N OEORD,OOEORD,FILE55,FILE55N0,PNDP2 S PNDP2=^PS(53.1,+PSJO,.2),FILE55="^PS(55,"_DFN_",""IV"",",FILE55N0=FILE55_+PSGORDR_",0)"
"RTN","PSJOEA2",37,0)
 ...S OEORD=$P(PND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD D EXPOE^PSGOER(DFN,+PSJO_"P",+$$LASTREN^PSJLMPRI(DFN,+PSJO_"P"))
"RTN","PSJOEA2",38,0)
 ...S PSGORDP=PSJO,DIE="^PS(53.1,",DA=+PSJO,DR="28////A;104////@" W "." D ^DIE
"RTN","PSJOEA2",39,0)
 ...Q:'$G(OEORD)  K DA,DR,DIE S DA(1)=DFN,DA=+PSGORDR,DIE=FILE55,DR=110_"////"_+OEORD
"RTN","PSJOEA2",40,0)
 ...S:$P(PNDP2,U,8) DR=DR_";150////"_$P(PNDP2,U,8) D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSJOEA2",41,0)
 ...D EN1^PSJHL2(DFN,"SC",PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJOEA2",42,0)
 ..I 'ON55 D SETNEW^PSIVORFB
"RTN","PSJOEA2",43,0)
 ..S (P("NEWON"),ON)=ON55,PSGP=$P(PSGND,U,15)
"RTN","PSJOEA2",44,0)
 ..S VND4=$G(^TMP("PSJCOM",$J,+PSJO,4)) D
"RTN","PSJOEA2",45,0)
 ...N PSJRN,PSJRNDT,PSJRPH,PSJRPHD,PSJPVFL,PSJNVFL,DR,DIE,DA
"RTN","PSJOEA2",46,0)
 ...S (PSJPVFL,PSJNVFL)=""
"RTN","PSJOEA2",47,0)
 ...S PSJRN=$P(VND4,U,1),PSJRNDT=$P(VND4,U,2),PSJRPH=$P(VND4,U,3),PSJRPHD=$P(VND4,U,4),PSJPVFL=$P(VND4,U,16) S:PSJRN]"" PSJNVFL=1
"RTN","PSJOEA2",48,0)
 ...S DR="16////"_PSJRN_";17////"_PSJRNDT_";140////"_PSJRPH_";141////"_PSJRPHD_";142////"_PSJPVFL_";143////"_PSJNVFL
"RTN","PSJOEA2",49,0)
 ...S DA(1)=PSGP,DA=+ON55,DIE="^PS(55,"_PSGP_",""IV""," D ^DIE
"RTN","PSJOEA2",50,0)
 ..D:P("RES")="R" RUPDATE^PSIVOREN(PSGP,ON,P(2))
"RTN","PSJOEA2",51,0)
 ..I +PSJSYSU=3 K OD D ^PSIVORE1 ;LABEL STUFF
"RTN","PSJOEA2",52,0)
 ..I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D  Q
"RTN","PSJOEA2",53,0)
 ...NEW DIC,DA,X,Y,XX D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJOEA2",54,0)
 ...S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJOEA2",55,0)
 ...S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJOEA2",56,0)
 ...S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJOEA2",57,0)
 ...K DO D FILE^DICN K DO
"RTN","PSJOEA2",58,0)
 ...N DIK,DA,PSIVACT S DIK="^PS(55,"_DFN_",""IV"",",DA=+ON,PSIVACT="" S:$G(DFN) DA(1)=DFN D IX^DIK K DIK,DA
"RTN","PSJOEA2",59,0)
 ...S PSJCOM=$P($G(^PS(55,DFN,"IV",+ON,.2)),"^",8) I PSJCOM]"" K ^PS(53.1,"ACX",PSJCOM,PSJO)
"RTN","PSJOEA2",60,0)
 ...D EN1^PSJHL2(DFN,"SC",ON)
"RTN","PSJOEA2",61,0)
 ...D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON) L -^PS(55,DFN,"IV",+ON) I $G(ON55) L -^PS(55,DFN,"IV",+ON55)
"RTN","PSJOEA2",62,0)
 ..L -^PS(55,DFN,"IV",+ON) I $G(ON55) L -^PS(55,DFN,"IV",+ON55)
"RTN","PSJOEA2",63,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",9)="A",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)="U" S PSGP=$P(PSGND,U,15) D UD^PSJOEA
"RTN","PSJOEA2",64,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",9)="A",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)="U" S PSGP=$P(PSGND,U,15) D UD^PSJOEA
"RTN","PSJOEA2",65,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)'="U",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",17)="A" S DFN=$S($G(PSGP)]"":PSGP,1:$P(PSGND,U,15)) D IV^PSJOEA
"RTN","PSJOEA2",66,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)'="U",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",17)="A" S DFN=$S($G(PSGP)]"":PSGP,1:$P(PSGND,U,15)) D IV^PSJOEA
"RTN","PSJOEA2",67,0)
 K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),PSJOWALL
"RTN","PSJOEA2",68,0)
 Q
"UP",55,55.01,-1)
55^IV
"UP",55,55.01,0)
55.01
"UP",55,55.06,-1)
55^5
"UP",55,55.06,0)
55.06
"VER")
8.0^22.0
"^DD",53.1,53.1,.01,0)
ORDER NUMBER^RNJ10,0^^0;1^K:+X'=X!(X>1000000000)!(X<1)!(X?.E1"."1N.N) X
"^DD",53.1,53.1,.01,1,0)
^.1^^-1
"^DD",53.1,53.1,.01,1,1,0)
53.1^B
"^DD",53.1,53.1,.01,1,1,1)
S ^PS(53.1,"B",$E(X,1,30),DA)=""
"^DD",53.1,53.1,.01,1,1,2)
K ^PS(53.1,"B",$E(X,1,30),DA)
"^DD",53.1,53.1,.01,3)
Type a whole number between 1 and 1000000000.
"^DD",53.1,53.1,.01,20,0)
^.3LA^1^1
"^DD",53.1,53.1,.01,20,1,0)
PSJU
"^DD",53.1,53.1,.01,21,0)
^^1^1^2910305^^^^
"^DD",53.1,53.1,.01,21,1,0)
  This is a reference number for this order.
"^DD",53.1,53.1,.01,"DT")
3130625
"^DD",53.1,53.1,.5,0)
PATIENT NAME^RP2'^DPT(^0;15^Q
"^DD",53.1,53.1,.5,1,0)
^.1
"^DD",53.1,53.1,.5,1,1,0)
53.1^AP^MUMPS
"^DD",53.1,53.1,.5,1,1,1)
S XX=X,X="PSGAXR" X ^%ZOSF("TEST") I  S X=XX D ENNPS^PSGAXR
"^DD",53.1,53.1,.5,1,1,2)
S XX=X,X="PSGAXR" X ^%ZOSF("TEST") I  S X=XX D ENNPK^PSGAXR
"^DD",53.1,53.1,.5,1,1,3)
Used by Inpatient Meds to set several cross-references.
"^DD",53.1,53.1,.5,1,1,"%D",0)
^.101^11^11^3041101^^^
"^DD",53.1,53.1,.5,1,1,"%D",1,0)
  This is used to set and kill the following cross-references:
"^DD",53.1,53.1,.5,1,1,"%D",2,0)
 ^PS(53.1,"AC",patient,DA)=""
"^DD",53.1,53.1,.5,1,1,"%D",3,0)
 ^PS(53.1,"AOD",patient,primary drug,DA)=""
"^DD",53.1,53.1,.5,1,1,"%D",4,0)
 ^PS(53.1,"AS",status,patient,DA)=""
"^DD",53.1,53.1,.5,1,1,"%D",5,0)
 ^PS(53.1,"AV",patient,DA)=""
"^DD",53.1,53.1,.5,1,1,"%D",6,0)
 ^PS(53.1,"C",patient,DA)=""
"^DD",53.1,53.1,.5,1,1,"%D",7,0)
 
"^DD",53.1,53.1,.5,1,1,"%D",8,0)
  The AC and AOD x-refs are only set if the order has not been verified or
"^DD",53.1,53.1,.5,1,1,"%D",9,0)
discontinued.
"^DD",53.1,53.1,.5,1,1,"%D",10,0)
  The AV x-ref is only set if the order has a pending status and was 
"^DD",53.1,53.1,.5,1,1,"%D",11,0)
acknowledged by a nurse.
"^DD",53.1,53.1,.5,3)

"^DD",53.1,53.1,.5,20,0)
^.3LA^1^1
"^DD",53.1,53.1,.5,20,1,0)
PSJU
"^DD",53.1,53.1,.5,21,0)
^^1^1^2910305^^
"^DD",53.1,53.1,.5,21,1,0)
  This is the patient for which the medication has been ordered.
"^DD",53.1,53.1,.5,"DT")
3130625
"^DD",53.1,53.1,113,0)
CLINIC^P44'^SC(^DSS;1^Q
"^DD",53.1,53.1,113,3)
Enter the name of the clinic where the patient was seen.
"^DD",53.1,53.1,113,21,0)
^^1^1^2980923^^^
"^DD",53.1,53.1,113,21,1,0)
Entry must be a clinic.  Depending on the condition, INACTIVATE and REACTIVATE dates may exist.
"^DD",53.1,53.1,113,"DT")
3130625
"^DD",53.46,53.46,6,0)
IMO DC/EXPIRED DAY LIMIT^NJ3,0^^0;7^K:+X'=X!(X>120)!(X<1)!(X?.E1"."1N.N) X
"^DD",53.46,53.46,6,3)
Enter the number of days (1 to 120) to include DC/EXPIRED IMO orders in Order Checks.
"^DD",53.46,53.46,6,21,0)
^.001^4^4^3130510^^
"^DD",53.46,53.46,6,21,1,0)
This field contains the number of days that DC/Expired orders 
"^DD",53.46,53.46,6,21,2,0)
will be included in the enhanced order checks for drug interactions
"^DD",53.46,53.46,6,21,3,0)
and therapeutic duplications for clinic orders. If this field is
"^DD",53.46,53.46,6,21,4,0)
left blank, a default value of 30 days will be used.
"^DD",53.46,53.46,6,23,0)
^^3^3^3130510^
"^DD",53.46,53.46,6,23,1,0)
Enhanced order checks for clinics that have the "ADMINISTER INPATIENT
"^DD",53.46,53.46,6,23,2,0)
MEDS?" field defined as "YES" under the SETUP A CLINIC [SDBUILD]
"^DD",53.46,53.46,6,23,3,0)
option in the Scheduling package are affected by this parameter.
"^DD",53.46,53.46,6,"DT")
3130510
"^DD",55,55,.01,0)
NAME^RP2'X^DPT(^0;1^S DINUM=X
"^DD",55,55,.01,1,0)
^.1^^-1
"^DD",55,55,.01,1,1,0)
55^B
"^DD",55,55,.01,1,1,1)
S ^PS(55,"B",$E(X,1,30),DA)=""
"^DD",55,55,.01,1,1,2)
K ^PS(55,"B",$E(X,1,30),DA)
"^DD",55,55,.01,1,2,0)
55^ALCNVRT^MUMPS
"^DD",55,55,.01,1,2,1)
I '$D(PSGINITF) S ^PS(55,"ALCNVRT")=$S($D(^PS(59.7,1,20)):$P(^(20),"^"),1:"")
"^DD",55,55,.01,1,2,2)
Q
"^DD",55,55,.01,1,2,"%D",0)
^.101^3^3^3130613^^^^
"^DD",55,55,.01,1,2,"%D",1,0)
Used by the Inpatient post-inits to determine if a conversion needs to be
"^DD",55,55,.01,1,2,"%D",2,0)
run on this file.
"^DD",55,55,.01,1,2,"%D",3,0)
In the form of: ^PS(55,"ALCNVRT")
"^DD",55,55,.01,1,3,0)
55^AUDDD^MUMPS
"^DD",55,55,.01,1,3,1)
I '$D(PSGINITF) S ^PS(55,"AUDDD")=$S($D(^PS(59.7,1,20)):$P(^(20),"^"),1:"")
"^DD",55,55,.01,1,3,2)
Q
"^DD",55,55,.01,1,3,"%D",0)
^.101^3^3^3130613^^^^
"^DD",55,55,.01,1,3,"%D",1,0)
Used by the Inpatient post-inits to determine if a conversion needs to be
"^DD",55,55,.01,1,3,"%D",2,0)
run on this file.
"^DD",55,55,.01,1,3,"%D",3,0)
In the form of: ^PS(55,"AUDDD")
"^DD",55,55,.01,1,4,0)
55^AUDAPM^MUMPS
"^DD",55,55,.01,1,4,1)
I '$D(PSGINITF) S ^PS(55,"AUDAPM")=$S($D(^PS(59.7,1,20)):$P(^(20),"^"),1:"")
"^DD",55,55,.01,1,4,2)
Q
"^DD",55,55,.01,1,4,"%D",0)
^.101^3^3^3130613^^^
"^DD",55,55,.01,1,4,"%D",1,0)
Used by the Inpatient post-inits to determine if a conversion needs to be
"^DD",55,55,.01,1,4,"%D",2,0)
run on this file.
"^DD",55,55,.01,1,4,"%D",3,0)
In the form of: ^PS(55,"AUDAPM")
"^DD",55,55,.01,3)

"^DD",55,55,.01,20,0)
^.3LA^1^1
"^DD",55,55,.01,20,1,0)
PS
"^DD",55,55,.01,21,0)
^^1^1^2940803^^^^
"^DD",55,55,.01,21,1,0)
  This is the name of a patient that has some type of pharmacy order.
"^DD",55,55,.01,"DT")
2890308
"^DD",55,55,62,0)
UNIT DOSE^55.06IA^^5;0
"^DD",55,55,62,11,0)
^.2LAP
"^DD",55,55,62,20,0)
^.3LA^1^1
"^DD",55,55,62,20,1,0)
PSJU
"^DD",55,55,62,21,0)
^.001^4^4^3111016^^^^
"^DD",55,55,62,21,1,0)
  This represents the 'top' of the UNIT DOSE SUB-FILE, where all of
"^DD",55,55,62,21,2,0)
a patient's active (and expired & dc'd) UNIT DOSE orders are kept.
"^DD",55,55,62,21,3,0)
Although orders are initially entered into ^PS(53.1), the order is
"^DD",55,55,62,21,4,0)
transferred into this sub-file (^PSGOT) upon verification.
"^DD",55,55,62,"DT")
2960726
"^DD",55,55,100,0)
IV^55.01^^IV;0
"^DD",55,55,100,20,0)
^.3LA^1^1
"^DD",55,55,100,20,1,0)
PSJI
"^DD",55,55,100,21,0)
^.001^4^4^3110411^^^^
"^DD",55,55,100,21,1,0)
This subfile contains IV order information for any given patient.
"^DD",55,55,100,21,2,0)
A separate IV order file does not exist. This isn't the same design as 
"^DD",55,55,100,21,3,0)
outpatient pharmacy -- which does contain a separate file for
"^DD",55,55,100,21,4,0)
prescriptions.
"^DD",55,55,100,"DT")
2930623
"^DD",55,55.01,0)
IV SUB-FIELD^NL^154^75
"^DD",55,55.01,0,"NM","IV")

"^DD",55,55.01,.01,0)
ORDER NUMBER^MRNJ7,0X^^0;1^K:+X'=X!(X>9999999)!(X<1)!(X?.E1"."1N.N) X S:$D(X) DINUM=X
"^DD",55,55.01,.01,1,0)
^.1
"^DD",55,55.01,.01,1,1,0)
55.01^B
"^DD",55,55.01,.01,1,1,1)
S ^PS(55,DA(1),"IV","B",$E(X,1,30),DA)=""
"^DD",55,55.01,.01,1,1,2)
K ^PS(55,DA(1),"IV","B",$E(X,1,30),DA)
"^DD",55,55.01,.01,3)
Type a whole number between 1 and 9999999.
"^DD",55,55.01,.01,20,0)
^.3LA^1^1
"^DD",55,55.01,.01,20,1,0)
PSJI
"^DD",55,55.01,.01,21,0)
^^1^1^2910306^^^
"^DD",55,55.01,.01,21,1,0)
Order Number for IV drugs administered to this patient.
"^DD",55,55.01,.01,"DT")
3130625
"^DD",55,55.01,.03,0)
STOP DATE/TIME^RDX^^0;3^S %DT="ETX" D:X'=+X ^%DT D:X=+X ENDL^PSSDDUT3 S X=Y K:Y<1!(Y'[".") X
"^DD",55,55.01,.03,1,0)
^.1
"^DD",55,55.01,.03,1,1,0)
55^AIV
"^DD",55,55.01,.03,1,1,1)
S ^PS(55,"AIV",+$E(X,1,30),DA(1),DA)=""
"^DD",55,55.01,.03,1,1,2)
K ^PS(55,"AIV",+$E(X,1,30),DA(1),DA)
"^DD",55,55.01,.03,1,1,"%D",0)
^^1^1^2931031^
"^DD",55,55.01,.03,1,1,"%D",1,0)
Identifies IV orders by the order's stop date/time.
"^DD",55,55.01,.03,1,2,0)
55.01^AF^MUMPS
"^DD",55,55.01,.03,1,2,1)
Q:$D(PSIVACT)  I '$D(DIU(0)) S PSIVF1=55.01,PSIVF2=.03 D ENTO^PSIVAL
"^DD",55,55.01,.03,1,2,2)
Q:$D(PSIVACT)  I '$D(DIU(0)) S PSIVF1=55.01,PSIVF2=.03 D ENFR^PSIVAL
"^DD",55,55.01,.03,1,2,"%D",0)
^^1^2920831^
"^DD",55,55.01,.03,1,2,"%D",1,0)
Used by IV Package.
"^DD",55,55.01,.03,1,3,0)
55.01^AIS
"^DD",55,55.01,.03,1,3,1)
S ^PS(55,DA(1),"IV","AIS",$E(X,1,30),DA)=""
"^DD",55,55.01,.03,1,3,2)
K ^PS(55,DA(1),"IV","AIS",$E(X,1,30),DA)
"^DD",55,55.01,.03,1,4,0)
55^AIT^MUMPS
"^DD",55,55.01,.03,1,4,1)
I $P($G(^PS(55,DA(1),"IV",DA,0)),U,4)]"" S ^PS(55,DA(1),"IV","AIT",$P(^(0),U,4),+X,DA)=""
"^DD",55,55.01,.03,1,4,2)
I $P($G(^PS(55,DA(1),"IV",DA,0)),U,4)]"" K ^PS(55,DA(1),"IV","AIT",$P(^(0),U,4),+X,DA)
"^DD",55,55.01,.03,1,4,"%D",0)
4^^4^4^2930611^
"^DD",55,55.01,.03,1,4,"%D",1,0)
  Used by IV to gather orders.  X-refs are in the form of:  
"^DD",55,55.01,.03,1,4,"%D",2,0)
  ^PS(55,DA(1),"IV","AIT",type,stop date/time,DA)  
"^DD",55,55.01,.03,1,4,"%D",3,0)
 
"^DD",55,55.01,.03,1,4,"%D",4,0)
  These are used primarily by the Med Due Worksheet and MAR.
"^DD",55,55.01,.03,1,4,"DT")
2930610
"^DD",55,55.01,.03,3)

"^DD",55,55.01,.03,20,0)
^.3LA^1^1
"^DD",55,55.01,.03,20,1,0)
PSJI
"^DD",55,55.01,.03,21,0)
^^1^1^2920512^^^^
"^DD",55,55.01,.03,21,1,0)
  This is the date and time the order is to end.
"^DD",55,55.01,.03,"DT")
3130625
"^DD",55,55.01,136,0)
CLINIC^*P44'^SC(^DSS;1^S DIC("S")="D PSS13^PSSDDUT" D ^DIC K DIC S DIC=$G(DIE),X=+Y K:Y<0 X
"^DD",55,55.01,136,12)
Entry must be a clinic.  Depending on the condition, INACTIVATE and REACTIVATE dates may exist.
"^DD",55,55.01,136,12.1)
S DIC("S")="D PSS13^PSSDDUT"
"^DD",55,55.01,136,"DT")
3130627
"^DD",55,55.06,0)
UNIT DOSE SUB-FIELD^NL^135^98
"^DD",55,55.06,0,"NM","UNIT DOSE")

"^DD",55,55.06,.01,0)
ORDER NUMBER^RNJ10,0O^^0;1^K:+X'=X!(X>1000000000)!(X<1)!(X?.E1"."1N.N) X
"^DD",55,55.06,.01,1,0)
^.1^^-1
"^DD",55,55.06,.01,1,1,0)
55.06^AL1^MUMPS
"^DD",55,55.06,.01,1,1,1)
I '$D(DIU(0)) D:$D(PSGAL(1))#2 KILL^PSGAL5:PSGAL(1)=X K PSGAL
"^DD",55,55.06,.01,1,1,2)
I '$D(DIU(0)),'$D(PSGPO) S PSGAL(1)=X,PSGAL("C")=6000,PSGALFF=.01 D ^PSGAL5
"^DD",55,55.06,.01,1,1,3)
UNIT DOSE ACTIVITY LOG
"^DD",55,55.06,.01,1,1,"%D",0)
^^1^1^2920725^^
"^DD",55,55.06,.01,1,1,"%D",1,0)
Used by Unit Dose to log any changes to this field.
"^DD",55,55.06,.01,1,2,0)
55.06^B
"^DD",55,55.06,.01,1,2,1)
S ^PS(55,DA(1),5,"B",$E(X,1,30),DA)=""
"^DD",55,55.06,.01,1,2,2)
K ^PS(55,DA(1),5,"B",$E(X,1,30),DA)
"^DD",55,55.06,.01,1,3,0)
55^AUE^MUMPS
"^DD",55,55.06,.01,1,3,1)
I '$D(DIU(0)) S ^PS(55,"AUE",DA(1),DA)=""
"^DD",55,55.06,.01,1,3,2)
I '$D(DIU(0)) K ^PS(55,"AUE",DA(1),DA)
"^DD",55,55.06,.01,1,3,3)
This x-ref is a flag and will NOT always exist.
"^DD",55,55.06,.01,1,3,"%D",0)
^^3^3^2920729^^
"^DD",55,55.06,.01,1,3,"%D",1,0)
Set when certain actions (edit, etc.) are taken on the order.
"^DD",55,55.06,.01,1,3,"%D",2,0)
Allows other package functionality, such as the pick list update,
"^DD",55,55.06,.01,1,3,"%D",3,0)
to know that the order needs to be "revisited".
"^DD",55,55.06,.01,1,5,0)
55^APV2^MUMPS
"^DD",55,55.06,.01,1,5,1)
Q
"^DD",55,55.06,.01,1,5,2)
K ^PS(55,"APV",DA(1),DA)
"^DD",55,55.06,.01,1,5,3)
This is used to delete the APV xref when the order is deleted.
"^DD",55,55.06,.01,1,5,"%D",0)
^^3^3^2960925^^
"^DD",55,55.06,.01,1,5,"%D",1,0)
This is used to delete the APV xref when the order is deleted. The APV xref 
"^DD",55,55.06,.01,1,5,"%D",2,0)
is used by the Unit Dose package to identify orders that have been verified 
"^DD",55,55.06,.01,1,5,"%D",3,0)
by a nurse but not a pharmacist.
"^DD",55,55.06,.01,1,5,"DT")
2960917
"^DD",55,55.06,.01,1,7,0)
55^ANV2^MUMPS
"^DD",55,55.06,.01,1,7,1)
Q
"^DD",55,55.06,.01,1,7,2)
K ^PS(55,"ANV",DA(1),DA)
"^DD",55,55.06,.01,1,7,3)
This is used to delete the ANV xref when the order is deleted.
"^DD",55,55.06,.01,1,7,"%D",0)
^^3^3^2960925^^^
"^DD",55,55.06,.01,1,7,"%D",1,0)
This is used to delete the ANV xref when the order is deleted. The ANV xref
"^DD",55,55.06,.01,1,7,"%D",2,0)
is used by the Unit Dose package to identify orders that have been verified
"^DD",55,55.06,.01,1,7,"%D",3,0)
by a pharacist but not a nurse.
"^DD",55,55.06,.01,1,7,"DT")
2960918
"^DD",55,55.06,.01,3)
Type a whole number between 1 and 1000000000.
"^DD",55,55.06,.01,4)

"^DD",55,55.06,.01,20,0)
^.3LA^1^1
"^DD",55,55.06,.01,20,1,0)
PSJU
"^DD",55,55.06,.01,21,0)
^^1^1^2970624^^^
"^DD",55,55.06,.01,21,1,0)
  This is the record number of the order.
"^DD",55,55.06,.01,"DEL",1,0)
I '$D(PSGPO) S PSGAL("C")=20180 D ^PSGAL5 K PSGAL D EN^DDIOL("YOU CANNOT DELETE A UNIT DOSE ORDER!","","$C(7),!")
"^DD",55,55.06,.01,"DT")
3130625
"^DD",55,55.06,.5,0)
PATIENT NAME^P2'^DPT(^0;15^Q
"^DD",55,55.06,.5,1,0)
^.1
"^DD",55,55.06,.5,1,1,0)
55.06^AL2^MUMPS
"^DD",55,55.06,.5,1,1,1)
I '$D(DIU(0)) D:$D(PSGAL(2))#2 KILL^PSGAL5:PSGAL(2)=X K PSGAL
"^DD",55,55.06,.5,1,1,2)
I '$D(DIU(0)),'$D(PSGPO) S PSGAL(2)=X,PSGAL("C")=6000,PSGALFF=.5 D ^PSGAL5
"^DD",55,55.06,.5,1,1,3)
UNIT DOSE ACTIVITY LOG
"^DD",55,55.06,.5,1,1,"%D",0)
^^1^1^2920725^
"^DD",55,55.06,.5,1,1,"%D",1,0)
Used by Unit Dose to log any changes made to this field.
"^DD",55,55.06,.5,20,0)
^.3LA^1^1
"^DD",55,55.06,.5,20,1,0)
PSJU
"^DD",55,55.06,.5,21,0)
^^1^1^2910306^^
"^DD",55,55.06,.5,21,1,0)
  This is the patient for which the medication has been ordered.
"^DD",55,55.06,.5,"DT")
3130625
"^DD",55,55.06,34,0)
STOP DATE/TIME^RDX^^2;4^X:X=+X&X&$D(^PS(55,DA(1),5,DA,2)) "S PSGDL=X D EN2^PSSDDUT3" S %DT="ERTX" D ^%DT S X=+Y K:Y'>0 X
"^DD",55,55.06,34,1,0)
^.1
"^DD",55,55.06,34,1,1,0)
55.06^ASD^MUMPS
"^DD",55,55.06,34,1,1,1)
S ^PS(55,DA(1),5,"AUS",+X,DA)="" I $P($G(^PS(55,DA(1),5,DA,0)),"^",7)]"" S ^PS(55,DA(1),5,"AU",$P(^(0),"^",7),+X,DA)=""
"^DD",55,55.06,34,1,1,2)
K ^PS(55,DA(1),5,"AUS",+X,DA) I $P($G(^PS(55,DA(1),5,DA,0)),"^",7)]"" K ^PS(55,DA(1),5,"AU",$P(^(0),"^",7),+X,DA)
"^DD",55,55.06,34,1,1,3)
NEEDED BY UNIT DOSE
"^DD",55,55.06,34,1,1,"%D",0)
^^5^5^2920729^^^
"^DD",55,55.06,34,1,1,"%D",1,0)
Used by Unit Dose to gather orders.  X-refs are in the form of:
"^DD",55,55.06,34,1,1,"%D",2,0)
^PS(55,DA(1),"AU",status,stop date/time,DA)
"^DD",55,55.06,34,1,1,"%D",3,0)
^PS(55,DA(1),"AUS",stop date/time,DA)
"^DD",55,55.06,34,1,1,"%D",4,0)
 
"^DD",55,55.06,34,1,1,"%D",5,0)
These are used primarily by the profiles.
"^DD",55,55.06,34,1,1,"DT")
2920729
"^DD",55,55.06,34,1,2,0)
55.06^AL53^MUMPS
"^DD",55,55.06,34,1,2,1)
I '$D(DIU(0)) D:$D(PSGAL(53))#2 KILL^PSGAL5:PSGAL(53)=X K PSGAL
"^DD",55,55.06,34,1,2,2)
I '$D(DIU(0)),'$D(PSGPO) S PSGAL(53)=X,PSGAL("C")=6000,PSGALFF=34 D ^PSGAL5
"^DD",55,55.06,34,1,2,3)
UNIT DOSE ACTIVITY LOG
"^DD",55,55.06,34,1,2,"%D",0)
^^1^1^2920729^
"^DD",55,55.06,34,1,2,"%D",1,0)
Used by Unit Dose to log any changes made to this field.
"^DD",55,55.06,34,1,3,0)
55^AUD
"^DD",55,55.06,34,1,3,1)
S ^PS(55,"AUD",$E(X,1,30),DA(1),DA)=""
"^DD",55,55.06,34,1,3,2)
K ^PS(55,"AUD",$E(X,1,30),DA(1),DA)
"^DD",55,55.06,34,1,3,"%D",0)
^^1^1^2931031^
"^DD",55,55.06,34,1,3,"%D",1,0)
Identifies verified Unit Dose orders by the order's stop date/time.
"^DD",55,55.06,34,1,3,"DT")
2931031
"^DD",55,55.06,34,3)
Enter the date and time that the last dose is to be given (and the order will expire).
"^DD",55,55.06,34,4)
D EN^DDIOL(" TIME IS REQUIRED.","","?0")
"^DD",55,55.06,34,20,0)
^.3LA^1^1
"^DD",55,55.06,34,20,1,0)
PSJU
"^DD",55,55.06,34,21,0)
^^3^3^2970624^^^^
"^DD",55,55.06,34,21,1,0)
  This is the date and time the order will automatically expire.  This
"^DD",55,55.06,34,21,2,0)
package initially calculates a default stop date, depending on the SITE
"^DD",55,55.06,34,21,3,0)
PARAMETERS.
"^DD",55,55.06,34,"DT")
3130625
"^DD",55,55.06,130,0)
CLINIC^*P44'^SC(^8;1^S DIC("S")="D PSS13^PSSDDUT" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X D ^DIC K DIC S DIC=$G(DIE),X=+Y K:Y<0 X
"^DD",55,55.06,130,3)
Entry must be a clinic location and should be a clinic that allows administration of Inpatient Meds.
"^DD",55,55.06,130,12)
Must be a clinic location. For Unit Dose, should allow IPM.
"^DD",55,55.06,130,12.1)
S DIC("S")="D PSS13^PSSDDUT"
"^DD",55,55.06,130,21,0)
^^1^1^3030516^
"^DD",55,55.06,130,21,1,0)
This is the clinic location if this order is for an Outpatient.
"^DD",55,55.06,130,"DT")
3130626
**INSTALL NAME**
PSO*7.0*416
"BLD",8449,0)
PSO*7.0*416^OUTPATIENT PHARMACY^0^3130703^y
"BLD",8449,4,0)
^9.64PA^^
"BLD",8449,6)
1^
"BLD",8449,6.3)
32
"BLD",8449,"ABPKG")
n
"BLD",8449,"KRN",0)
^9.67PA^779.2^20
"BLD",8449,"KRN",.4,0)
.4
"BLD",8449,"KRN",.401,0)
.401
"BLD",8449,"KRN",.402,0)
.402
"BLD",8449,"KRN",.403,0)
.403
"BLD",8449,"KRN",.5,0)
.5
"BLD",8449,"KRN",.84,0)
.84
"BLD",8449,"KRN",3.6,0)
3.6
"BLD",8449,"KRN",3.8,0)
3.8
"BLD",8449,"KRN",9.2,0)
9.2
"BLD",8449,"KRN",9.8,0)
9.8
"BLD",8449,"KRN",9.8,"NM",0)
^9.68A^22^21
"BLD",8449,"KRN",9.8,"NM",1,0)
PSOORFI5^^0^B47164460
"BLD",8449,"KRN",9.8,"NM",2,0)
PSODIR^^0^B34430452
"BLD",8449,"KRN",9.8,"NM",3,0)
PSODGDGP^^0^B67660976
"BLD",8449,"KRN",9.8,"NM",4,0)
PSOORED4^^0^B54845404
"BLD",8449,"KRN",9.8,"NM",5,0)
PSOORFIN^^0^B63913344
"BLD",8449,"KRN",9.8,"NM",6,0)
PSOORNEW^^0^B92394411
"BLD",8449,"KRN",9.8,"NM",7,0)
PSOVER^^0^B87892032
"BLD",8449,"KRN",9.8,"NM",8,0)
PSOCAN^^0^B53171969
"BLD",8449,"KRN",9.8,"NM",9,0)
PSOCAN2^^0^B85372649
"BLD",8449,"KRN",9.8,"NM",10,0)
PSODDPR2^^0^B107649994
"BLD",8449,"KRN",9.8,"NM",11,0)
PSODDPR4^^0^B126073847
"BLD",8449,"KRN",9.8,"NM",12,0)
PSODDPR5^^0^B160645085
"BLD",8449,"KRN",9.8,"NM",13,0)
PSODDPR8^^0^B57269094
"BLD",8449,"KRN",9.8,"NM",14,0)
PSODDPRE^^0^B133385173
"BLD",8449,"KRN",9.8,"NM",15,0)
PSORXEDT^^0^B45078409
"BLD",8449,"KRN",9.8,"NM",16,0)
PSOVER1^^0^B126246906
"BLD",8449,"KRN",9.8,"NM",17,0)
PSODOSUT^^0^B130658909
"BLD",8449,"KRN",9.8,"NM",18,0)
PSOORED3^^0^B61293813
"BLD",8449,"KRN",9.8,"NM",19,0)
PSOORED5^^0^B58804005
"BLD",8449,"KRN",9.8,"NM",21,0)
PSODOSUN^^0^B84411682
"BLD",8449,"KRN",9.8,"NM",22,0)
PSOBKDED^^0^B81693378
"BLD",8449,"KRN",9.8,"NM","B","PSOBKDED",22)

"BLD",8449,"KRN",9.8,"NM","B","PSOCAN",8)

"BLD",8449,"KRN",9.8,"NM","B","PSOCAN2",9)

"BLD",8449,"KRN",9.8,"NM","B","PSODDPR2",10)

"BLD",8449,"KRN",9.8,"NM","B","PSODDPR4",11)

"BLD",8449,"KRN",9.8,"NM","B","PSODDPR5",12)

"BLD",8449,"KRN",9.8,"NM","B","PSODDPR8",13)

"BLD",8449,"KRN",9.8,"NM","B","PSODDPRE",14)

"BLD",8449,"KRN",9.8,"NM","B","PSODGDGP",3)

"BLD",8449,"KRN",9.8,"NM","B","PSODIR",2)

"BLD",8449,"KRN",9.8,"NM","B","PSODOSUN",21)

"BLD",8449,"KRN",9.8,"NM","B","PSODOSUT",17)

"BLD",8449,"KRN",9.8,"NM","B","PSOORED3",18)

"BLD",8449,"KRN",9.8,"NM","B","PSOORED4",4)

"BLD",8449,"KRN",9.8,"NM","B","PSOORED5",19)

"BLD",8449,"KRN",9.8,"NM","B","PSOORFI5",1)

"BLD",8449,"KRN",9.8,"NM","B","PSOORFIN",5)

"BLD",8449,"KRN",9.8,"NM","B","PSOORNEW",6)

"BLD",8449,"KRN",9.8,"NM","B","PSORXEDT",15)

"BLD",8449,"KRN",9.8,"NM","B","PSOVER",7)

"BLD",8449,"KRN",9.8,"NM","B","PSOVER1",16)

"BLD",8449,"KRN",19,0)
19
"BLD",8449,"KRN",19.1,0)
19.1
"BLD",8449,"KRN",101,0)
101
"BLD",8449,"KRN",409.61,0)
409.61
"BLD",8449,"KRN",771,0)
771
"BLD",8449,"KRN",779.2,0)
779.2
"BLD",8449,"KRN",870,0)
870
"BLD",8449,"KRN",8989.51,0)
8989.51
"BLD",8449,"KRN",8989.52,0)
8989.52
"BLD",8449,"KRN",8994,0)
8994
"BLD",8449,"KRN","B",.4,.4)

"BLD",8449,"KRN","B",.401,.401)

"BLD",8449,"KRN","B",.402,.402)

"BLD",8449,"KRN","B",.403,.403)

"BLD",8449,"KRN","B",.5,.5)

"BLD",8449,"KRN","B",.84,.84)

"BLD",8449,"KRN","B",3.6,3.6)

"BLD",8449,"KRN","B",3.8,3.8)

"BLD",8449,"KRN","B",9.2,9.2)

"BLD",8449,"KRN","B",9.8,9.8)

"BLD",8449,"KRN","B",19,19)

"BLD",8449,"KRN","B",19.1,19.1)

"BLD",8449,"KRN","B",101,101)

"BLD",8449,"KRN","B",409.61,409.61)

"BLD",8449,"KRN","B",771,771)

"BLD",8449,"KRN","B",779.2,779.2)

"BLD",8449,"KRN","B",870,870)

"BLD",8449,"KRN","B",8989.51,8989.51)

"BLD",8449,"KRN","B",8989.52,8989.52)

"BLD",8449,"KRN","B",8994,8994)

"BLD",8449,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8449,"QUES",0)
^9.62^^
"BLD",8449,"REQB",0)
^9.611^6^6
"BLD",8449,"REQB",1,0)
PSO*7.0*372^2
"BLD",8449,"REQB",2,0)
PSS*1.0*160^2
"BLD",8449,"REQB",3,0)
PSO*7.0*390^2
"BLD",8449,"REQB",4,0)
PSO*7.0*413^2
"BLD",8449,"REQB",5,0)
PSO*7.0*391^2
"BLD",8449,"REQB",6,0)
PSO*7.0*378^2
"BLD",8449,"REQB","B","PSO*7.0*372",1)

"BLD",8449,"REQB","B","PSO*7.0*378",6)

"BLD",8449,"REQB","B","PSO*7.0*390",3)

"BLD",8449,"REQB","B","PSO*7.0*391",5)

"BLD",8449,"REQB","B","PSO*7.0*413",4)

"BLD",8449,"REQB","B","PSS*1.0*160",2)

"MBREQ")
1
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
416^3130703^10000000068
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
21
"RTN","PSOBKDED")
0^22^B81693378
"RTN","PSOBKDED",1,0)
PSOBKDED ;BIR/SAB - Edit backdoor Rx Order entry ;04/17/95
"RTN","PSOBKDED",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,46,91,78,99,117,133,143,268,378,416**;DEC 1997;Build 32
"RTN","PSOBKDED",3,0)
 ;Ref PS(50.607 IA 2221
"RTN","PSOBKDED",4,0)
 ;Ref PS(50.7 IA 2223
"RTN","PSOBKDED",5,0)
 ;Ref PS(51.2 IA 2226
"RTN","PSOBKDED",6,0)
 ;Ref PSDRUG( IA 221
"RTN","PSOBKDED",7,0)
 ;Ref DOSE^PSSORPH IA 3234
"RTN","PSOBKDED",8,0)
 ;Ref PS(55 IA 2228
"RTN","PSOBKDED",9,0)
1 S %DT="AEX",%DT(0)=-PSONEW("FILL DATE"),Y=PSONEW("ISSUE DATE") X ^DD("DD") S %DT("A")="ISSUE DATE: ",%DT("B")=Y D ^%DT
"RTN","PSOBKDED",10,0)
 I "^"[$E(X) D KX K %DT Q
"RTN","PSOBKDED",11,0)
 G:Y=-1 1 S (PSOID,PSONEW("ISSUE DATE"))=Y D KX K %DT
"RTN","PSOBKDED",12,0)
 Q
"RTN","PSOBKDED",13,0)
2 S PSONEW("FLD")=2 D FILLDT^PSODIR2(.PSONEW) ;Fdt
"RTN","PSOBKDED",14,0)
 Q
"RTN","PSOBKDED",15,0)
3 S:$G(POERR) PSONEW("ISSUE DATE")=PSOID
"RTN","PSOBKDED",16,0)
 S PSONEW("FLD")=3 D PTSTAT^PSODIR1(.PSONEW) ;Sta
"RTN","PSOBKDED",17,0)
 Q
"RTN","PSOBKDED",18,0)
4 S PSONEW("FLD")=4 D PROV^PSODIR(.PSONEW) ;Pro
"RTN","PSOBKDED",19,0)
 Q
"RTN","PSOBKDED",20,0)
5 S PSONEW("FLD")=5 D CLINIC^PSODIR2(.PSONEW) ;Cli
"RTN","PSOBKDED",21,0)
 Q
"RTN","PSOBKDED",22,0)
6 S PSONEW("FLD")=6 D ^PSODRG,EN^PSODIAG ;Drg/ICD
"RTN","PSOBKDED",23,0)
 D 6^PSODRGN
"RTN","PSOBKDED",24,0)
 Q
"RTN","PSOBKDED",25,0)
7 S PSONEW("FLD")=7 D QTY^PSODIR1(.PSONEW) ;Qty
"RTN","PSOBKDED",26,0)
 Q
"RTN","PSOBKDED",27,0)
8 S PSONEW("FLD")=8 D DAYS^PSODIR1(.PSONEW) ;Day
"RTN","PSOBKDED",28,0)
 K PSMAX,PSTMAX D REF^PSOORNEW S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOBKDED",29,0)
 Q
"RTN","PSOBKDED",30,0)
9 S PSONEW("FLD")=9 D REFILL^PSODIR1(.PSONEW) ;Ref
"RTN","PSOBKDED",31,0)
 K PSMAX,PSTMAX
"RTN","PSOBKDED",32,0)
 Q
"RTN","PSOBKDED",33,0)
10 S PSONEW("FLD")="3A" N PSOEDDOS S PSOEDDOS=1 D DOSE^PSODIR(.PSONEW) ;Dose
"RTN","PSOBKDED",34,0)
 Q
"RTN","PSOBKDED",35,0)
 ;
"RTN","PSOBKDED",36,0)
 Q  I $G(COPY),$G(SIGOK) S PSOFDR=1 K PSONEW("SIG")
"RTN","PSOBKDED",37,0)
 S PSONEW("FLD")=10 D SIG^PSODIR1(.PSONEW) ;Sig
"RTN","PSOBKDED",38,0)
 I $G(COPY) K PSOFDR
"RTN","PSOBKDED",39,0)
 S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR D KV
"RTN","PSOBKDED",40,0)
 Q
"RTN","PSOBKDED",41,0)
INS S PSONEW("FLD")="3B" D INS^PSODIR(.PSONEW) ;Ins
"RTN","PSOBKDED",42,0)
 Q
"RTN","PSOBKDED",43,0)
11 S PSONEW("FLD")=11 D COPIES^PSODIR1(.PSONEW) ;Cop
"RTN","PSOBKDED",44,0)
 Q
"RTN","PSOBKDED",45,0)
12 S PSONEW("FLD")=12 D MW^PSODIR2(.PSONEW) ;M/W
"RTN","PSOBKDED",46,0)
 Q
"RTN","PSOBKDED",47,0)
13 S PSONEW("FLD")=13 D RMK^PSODIR2(.PSONEW) ;Rem
"RTN","PSOBKDED",48,0)
 Q
"RTN","PSOBKDED",49,0)
DOSE ;backdoor
"RTN","PSOBKDED",50,0)
 I '$G(PSONEW("ENT")) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5) Dosage Ordered: " G INS1
"RTN","PSOBKDED",51,0)
 S SD=1 F I=1:1:PSONEW("ENT") D 
"RTN","PSOBKDED",52,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOBKDED",53,0)
 .S:$G(SD)=1 IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5)",DS=1 K SD
"RTN","PSOBKDED",54,0)
 .D DOSE1
"RTN","PSOBKDED",55,0)
INS1 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)Pat Instruction:"
"RTN","PSOBKDED",56,0)
INS2 I $O(PSONEW("SIG",0)) F D=0:0 S D=$O(PSONEW("SIG",D)) Q:'D  D
"RTN","PSOBKDED",57,0)
 .F SG=1:1:$L(PSONEW("SIG",D)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("SIG",D)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " D
"RTN","PSOBKDED",58,0)
 ..S:$P(PSONEW("SIG",D)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("SIG",D)," ",SG)
"RTN","PSOBKDED",59,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") D  Q
"RTN","PSOBKDED",60,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" Other Patient Inst.: "
"RTN","PSOBKDED",61,0)
 .I $G(^PSRX(+$G(PSONEW("OIRXN")),"INSS"))]"" S PSONEW("SINS")=^PSRX(PSONEW("OIRXN"),"INSS")
"RTN","PSOBKDED",62,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_$G(PSONEW("SINS"))
"RTN","PSOBKDED",63,0)
 Q
"RTN","PSOBKDED",64,0)
 ;
"RTN","PSOBKDED",65,0)
DOSE1 I $G(DS)=1 D  K DS G DU
"RTN","PSOBKDED",66,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_" Dosage Ordered: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)_$S($G(PSONEW("UNITS",I))'="":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOBKDED",67,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dosage Ordered: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)_$S($G(PSONEW("UNITS",I))'="":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOBKDED",68,0)
DU I '$G(PSONEW("DOSE ORDERED",I)),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOBKDED",69,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOBKDED",70,0)
 S:$G(PSONEW("DOSE ORDERED",I)) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dispense Units: "_$S($E($G(PSONEW("DOSE ORDERED",I)),1)=".":"0",1:"")_$G(PSONEW("DOSE ORDERED",I))
"RTN","PSOBKDED",71,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("NOUN",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Noun: "_PSONEW("NOUN",I)
"RTN","PSOBKDED",72,0)
 I $G(PSONEW("ROUTE",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Route: "_$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOBKDED",73,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOBKDED",74,0)
 I $G(PSONEW("DURATION",I))]"" D
"RTN","PSOBKDED",75,0)
 .S IEN=IEN+1
"RTN","PSOBKDED",76,0)
 .S ^TMP("PSOPO",$J,IEN,0)="           *Duration: "_PSONEW("DURATION",I)_" ("_$S(PSONEW("DURATION",I)["M":"MINUTES",PSONEW("DURATION",I)["W":"WEEKS",PSONEW("DURATION",I)["L":"MONTHS",PSONEW("DURATION",I)["H":"HOURS",1:"DAYS")_")"
"RTN","PSOBKDED",77,0)
 I $G(PSONEW("CONJUNCTION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="         Conjunction: "_$S($G(PSONEW("CONJUNCTION",I))="A":"AND",$G(PSONEW("CONJUNCTION",I))="T":"THEN",$G(PSONEW("CONJUNCTION",I))="X":"EXCEPT",1:"")
"RTN","PSOBKDED",78,0)
 Q
"RTN","PSOBKDED",79,0)
RTE I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOBKDED",80,0)
 I $G(RTE) K RTE
"RTN","PSOBKDED",81,0)
 K DIR,DIRUT S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOBKDED",82,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",83,0)
 ;I '$G(PSORXED("ROUTE",ENT)),$G(PSOREEDT) K DIR("B")
"RTN","PSOBKDED",84,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOBKDED",85,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOBKDED",86,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" Q
"RTN","PSOBKDED",87,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) Q
"RTN","PSOBKDED",88,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOBKDED",89,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOBKDED",90,0)
 Q
"RTN","PSOBKDED",91,0)
ASK K JUMP,UNITN,DOSE D KV D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN)
"RTN","PSOBKDED",92,0)
 I $D(DOSE("DD")) I $G(PSOFROM)="PENDING"!($G(PSOREEDQ)) D LST2^PSOBKDE1 G ASK1
"RTN","PSOBKDED",93,0)
 D:$G(PSOFROM)="NEW"&($G(PSORX("EDIT"))']"")!($G(PSOFROM1))!($G(COPY)) LST^PSOBKDE1:$O(DOSE(0))
"RTN","PSOBKDED",94,0)
ASK1 S STRE=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",5),UNITN=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",6),DOSE("LD")=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",11)
"RTN","PSOBKDED",95,0)
 W ! S DIR(0)="F^1:60",DIR("A",1)="Select from list of Available Dosages, Enter Free Text Dose",DIR("?")="^D LST1^PSOBKDE1",DIR("A")="or Enter a Question Mark (?) to view list"
"RTN","PSOBKDED",96,0)
 I $G(PSORXED("DOSE",ENT))]"" S DIR("B")=PSORXED("DOSE",ENT) D
"RTN","PSOBKDED",97,0)
 .I $G(PSORXED("UNITS",ENT))]"",DIR("B")'[($P($G(^PS(50.607,PSORXED("UNITS",ENT),0)),"^")) S DIR("B")=DIR("B")_$P($G(^PS(50.607,PSORXED("UNITS",ENT),0)),"^")
"RTN","PSOBKDED",98,0)
 K:$G(PSOREEDQ)!($G(PSOBDRG)) DIR("B")
"RTN","PSOBKDED",99,0)
 D ^DIR
"RTN","PSOBKDED",100,0)
 I X[U,$L(X)>1 S FIELD="ASK",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOBKDED",101,0)
 I $D(DIRUT) S:$G(ORD) PSODSPL=1 Q
"RTN","PSOBKDED",102,0)
 I X=$G(PSORXED("DOSE",ENT)),$D(DOSE(Y)) G GD1
"RTN","PSOBKDED",103,0)
 I X=$G(PSORXED("DOSE",ENT)) D  G DOS
"RTN","PSOBKDED",104,0)
 .S DOSE=X,UNITS=$G(PSORXED("UNITS",ENT))
"RTN","PSOBKDED",105,0)
 .I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("DOSE ORDERED",ENT),DUPD,PSORXED("NOUN",ENT)
"RTN","PSOBKDED",106,0)
GD1 N PSORXTE
"RTN","PSOBKDED",107,0)
 I $D(DOSE(Y)) D  G DOS ;from list
"RTN","PSOBKDED",108,0)
 .S DOSE=$S($P(DOSE(Y),"^"):$P(DOSE(Y),"^"),$P(DOSE(Y),"^",3)]"":$P(DOSE(Y),"^",3),1:1),DOLST=Y
"RTN","PSOBKDED",109,0)
 .I $P(DOSE(Y),"^") S UNITS=$P(DOSE(Y),"^",2),DUPD=$P(DOSE(Y),"^",3),UNITN=$P(DOSE("DD",PSODRUG("IEN")),"^",6),PSORXTE("DOSE ORDERED",ENT)=DUPD
"RTN","PSOBKDED",110,0)
 .S PSORXTE("NOUN",ENT)=$P(DOSE(Y),"^",6),PSORXTE("VERB",ENT)=$P(DOSE(Y),"^",8)
"RTN","PSOBKDED",111,0)
 .I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") D  Q
"RTN","PSOBKDED",112,0)
 ..S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("DOSE ORDERED",ENT),DUPD,PSORXED("NOUN",ENT)
"RTN","PSOBKDED",113,0)
 ..I $P($G(^PS(55,PSODFN,"LAN")),"^"),$G(PSOFROM)="PENDING" D LAN^PSOORED5 Q
"RTN","PSOBKDED",114,0)
 ..I $P($G(^PS(55,PSODFN,"LAN")),"^"),$G(PSOFROM)="NEW" D LAN^PSOORED5
"RTN","PSOBKDED",115,0)
 .S PSORXTE("UNITS",ENT)=$G(UNITS)
"RTN","PSOBKDED",116,0)
 S DOSE=Y,DOLST=0 ;non-numeric and numeric not in list
"RTN","PSOBKDED",117,0)
 I DOSE("LD") D
"RTN","PSOBKDED",118,0)
 .F I=1:1:$L(DOSE)  I $E(DOSE,I)'?.N&($E(DOSE,I)'?1" ")&($E(DOSE,I)'?1".") S DCHK=$G(DCHK)_$E(DOSE,I)
"RTN","PSOBKDED",119,0)
 .I $G(DCHK)]"" D
"RTN","PSOBKDED",120,0)
 ..S DCHK=$TR(DCHK,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOBKDED",121,0)
 ..I DCHK=UNITN S DOSE=+DOSE
"RTN","PSOBKDED",122,0)
 K I,DCHK
"RTN","PSOBKDED",123,0)
 S PSOINDT=$$GET1^DIQ(50,PSODRUG("IEN"),100,"I") I PSOINDT,DT>PSOINDT G DOS
"RTN","PSOBKDED",124,0)
 S PSORXTE("NOUN",ENT)=$P(DOSE("DD",PSODRUG("IEN")),"^",9),PSORXTE("VERB",ENT)=$P(DOSE("DD",PSODRUG("IEN")),"^",10)
"RTN","PSOBKDED",125,0)
 I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("NOUN",ENT),PSORXED("ODOSE",ENT) G DOS
"RTN","PSOBKDED",126,0)
 S:$P(DOSE("DD",PSODRUG("IEN")),"^",6)]"" (PSORXTE("UNITS",ENT),UNITS)=$O(^PS(50.607,"B",$P(DOSE("DD",PSODRUG("IEN")),"^",6),0)),UNITN=$P(DOSE("DD",PSODRUG("IEN")),"^",6)
"RTN","PSOBKDED",127,0)
 S:$P(DOSE("DD",PSODRUG("IEN")),"^",5) DUPD=DOSE/$P(DOSE("DD",PSODRUG("IEN")),"^",5),PSORXTE("DOSE ORDERED",ENT)=DUPD
"RTN","PSOBKDED",128,0)
DOS W " "_$S($E(DOSE,1)="."&($G(UNITN)'=""):"0",1:"")_DOSE W:$G(UNITN)'="" UNITN
"RTN","PSOBKDED",129,0)
 W ! K DIR,DIRUT S DIR(0)="Y",DIR("A")="You entered "_$S($E(DOSE,1)="."&($G(UNITN)'=""):"0",1:"")_DOSE_$S($G(UNITN)'="":UNITN,1:"")_" is this correct",DIR("B")="Yes"
"RTN","PSOBKDED",130,0)
 D ^DIR I 'Y D KX K DOSE,UNITS,PSORXTE,PSOINDT G ASK
"RTN","PSOBKDED",131,0)
 S PSORXED("DOSE",ENT)=DOSE
"RTN","PSOBKDED",132,0)
 S:$G(PSORXTE("DOSE ORDERED",ENT))]"" PSORXED("DOSE ORDERED",ENT)=PSORXTE("DOSE ORDERED",ENT)
"RTN","PSOBKDED",133,0)
 S:$G(PSORXTE("NOUN",ENT))]"" PSORXED("NOUN",ENT)=PSORXTE("NOUN",ENT)
"RTN","PSOBKDED",134,0)
 S:$G(PSORXTE("VERB",ENT))]"" PSORXED("VERB",ENT)=PSORXTE("VERB",ENT)
"RTN","PSOBKDED",135,0)
 S:$G(PSORXTE("UNITS",ENT))]"" PSORXED("UNITS",ENT)=PSORXTE("UNITS",ENT)
"RTN","PSOBKDED",136,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD"),$P($G(^PS(55,PSODFN,"LAN")),"^") D
"RTN","PSOBKDED",137,0)
 .K OTHDOS(ENT) D KX S DIR(0)="52.0113,9"
"RTN","PSOBKDED",138,0)
 .I '$G(OTHDOS(ENT)),$G(PSORXED("ODOSE",ENT))']"" D LAN^PSOORED5
"RTN","PSOBKDED",139,0)
 .I $G(PSORXED("ODOSE",ENT))]"" S DIR("B")=PSORXED("ODOSE",ENT) K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",140,0)
 .K DTOUT,DUOUT,DIRUT,Y,X D ^DIR K DIR K:$G(X)="@"!($G(X)="") DIRUT I $D(DIRUT) Q
"RTN","PSOBKDED",141,0)
 .I X="@" S OTHDOS(ENT)=1 D KX K PSORXED("ODOSE",ENT) Q
"RTN","PSOBKDED",142,0)
 .S:X'="" PSORXED("ODOSE",ENT)=X
"RTN","PSOBKDED",143,0)
 Q
"RTN","PSOBKDED",144,0)
 ;
"RTN","PSOBKDED",145,0)
SCH D KX
"RTN","PSOBKDED",146,0)
 S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>3)!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOBKDED",147,0)
 I '$D(PSOSCH),'$D(PSORXED("SCHEDULE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",8)]"" S PSOSCH=$P(^PS(50.7,PSODRUG("OI"),0),"^",8)
"RTN","PSOBKDED",148,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",149,0)
 I $G(PSORXED("SCHEDULE",ENT))']"",$G(PSOREEDT) K DIR("B")
"RTN","PSOBKDED",150,0)
 D ^DIR
"RTN","PSOBKDED",151,0)
 Q
"RTN","PSOBKDED",152,0)
KX K X,Y
"RTN","PSOBKDED",153,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOBKDED",154,0)
 Q
"RTN","PSOCAN")
0^8^B53171969
"RTN","PSOCAN",1,0)
PSOCAN ;BIR/JMB - Rx discontinue and reinstate ;8/3/06 12:38pm
"RTN","PSOCAN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,24,27,32,37,88,117,131,185,253,251,375,379,390,413,372,416**;DEC 1997;Build 32
"RTN","PSOCAN",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN",4,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN",5,0)
START N PSOODOSP,PSOREINF,PSOONOFC S WARN=0,(DAYS360,SPCANC)=1 D KCAN1^PSOCAN3 W !! S DIR("A")="Discontinue/Reinstate by Rx# or patient name",DIR(0)="SBO^R:RX NUMBER;P:PATIENT NAME"
"RTN","PSOCAN",6,0)
 S DIR("?")="Enter 'R' to discontinue/reinstate by Rx#.  Enter 'P' to discontinue/reinstate by patient name." D ^DIR K DIR
"RTN","PSOCAN",7,0)
 G:$G(DIRUT) KILL^PSOCAN1 K RP S RP=Y G:RP="P" PAT^PSOCAN1
"RTN","PSOCAN",8,0)
NUM D DCORD^PSONEW2
"RTN","PSOCAN",9,0)
 K PSOTECCK,RXSP,PSINV,PSOWUN,PSOULRX D KCAN1^PSOCAN3 S:'$D(PSOCLC) PSOCLC=DUZ S PS="Discontinue" W ! S DIR("A")="Discontinue/Reinstate Prescription(s)#"
"RTN","PSOCAN",10,0)
 S DIR(0)="FO^1:245",DIR("?")="Wand/enter barcode or enter Rx number(s) to discontinued/reinstated. If more than one, separate with commas. Do not exceed 245 characters including commas"
"RTN","PSOCAN",11,0)
 D ^DIR K DIR G:$G(DIRUT) START S OUT=0 I Y["-" D PSOINST^PSOSUPAT G:OUT NUM S (IN,X)=$P(^PSRX($P(Y,"-",2),0),"^") G NO
"RTN","PSOCAN",12,0)
 S IN=Y G RX:Y[","
"RTN","PSOCAN",13,0)
NO I '$O(^PSRX("B",Y,0)) W " Rx Not Found!",! G NUM
"RTN","PSOCAN",14,0)
 S PSPOP=0,DIC=52,DIC(0)="QEMZ" D ^DIC K DIC Q:$G(POERR)&(Y<0)
"RTN","PSOCAN",15,0)
 G:Y<0 NUM S (DA,IFN,PSOULRX)=+Y,RXNUM=Y(0,0),PSODFN=+$P(^PSRX(DA,0),"^",2) I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF"),PSOREINF S PSOODOSP=PSODFN
"RTN","PSOCAN",16,0)
 S PSOWUN=1 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G NUM
"RTN","PSOCAN",17,0)
 K PSOPLCK D PSOL^PSSLOCK(IFN) I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.") K PSOMSG D ULP G NUM
"RTN","PSOCAN",18,0)
 I $P($G(^PSRX(+$G(IFN),"STA")),"^")=12,$P($G(^("PKI")),"^") W !!,"Cannot be Reinstated - Digitally Signed" D ULP G NUM
"RTN","PSOCAN",19,0)
 I $P($G(^PSRX(+$G(IFN),"STA")),"^")=12 S PSOCANRZ=1
"RTN","PSOCAN",20,0)
 E  S PSOCANRD=+$P($G(^PSRX(+$G(IFN),0)),"^",4)
"RTN","PSOCAN",21,0)
 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN)
"RTN","PSOCAN",22,0)
LMNO D CHK S:'$G(DA)&($G(IFN)) DA=IFN
"RTN","PSOCAN",23,0)
 I DEAD S PSINV($P(^PSRX(DA,0),"^"))="" D:$G(PSOWUN) ULP,ULRX G EP1
"RTN","PSOCAN",24,0)
 I $P(^PSRX(DA,"STA"),"^")'<13,$P(^("STA"),"^")'=16 S PSINV($P(^PSRX(DA,0),"^"))="" D:$G(PSOWUN) ULP,ULRX G EP1
"RTN","PSOCAN",25,0)
 I $G(PSODIV),$P($G(^PSRX(DA,2)),"^",9),$P(^(2),"^",9)'=$G(PSOSITE) S RXREC=DA D DIV D:$G(POERR)&(PSPOP) ULP,ULRX Q:$G(POERR)&(PSPOP)  D:$G(PSOWUN)&($G(PSPOP)) ULP,ULRX G:PSPOP NUM
"RTN","PSOCAN",26,0)
 D ICN^PSODPT(PSODFN)
"RTN","PSOCAN",27,0)
 N PSTS S PSTS=$S($P(^PSRX(DA,"STA"),"^")=12:1,$P(^PSRX(DA,"STA"),"^")=14:1,$P(^PSRX(DA,"STA"),"^")=15:1,1:0)
"RTN","PSOCAN",28,0)
 S PS=$S($G(PSTS):"Reinstate",1:"Discontinue")
"RTN","PSOCAN",29,0)
 ;S PS=$S($P(^PSRX(DA,"STA"),"^")=12:"Reinstate",1:"Discontinue")
"RTN","PSOCAN",30,0)
 I '$G(POERR) N PKIR D
"RTN","PSOCAN",31,0)
 .I $P(^PSRX(DA,"STA"),"^")=1,$P($G(^("PKI")),"^") S PKIR=""
"RTN","PSOCAN",32,0)
 .D ^PSORXPR
"RTN","PSOCAN",33,0)
 D YN S:PS="Reinstate" PS="Discontinue" Q:$G(POERR)&('%)
"RTN","PSOCAN",34,0)
 I '% D ULP,ULRX G NUM
"RTN","PSOCAN",35,0)
 D REA D:'$D(REA)&($G(PSOWUN)) ULP,ULRX Q:'$D(REA)
"RTN","PSOCAN",36,0)
 D COM^PSOCAN1 Q:$G(POERR)&('$D(INCOM))!($D(DIRUT))  I '$D(INCOM)!($D(DIRUT)) D ULP,ULRX G NUM
"RTN","PSOCAN",37,0)
 S RX=$P(^PSRX(DA,0),"^"),PSCAN(RX)=DA_"^"_REA
"RTN","PSOCAN",38,0)
 D:REA="R" REINS^PSOCAN2 Q:$G(PSOQUIT)&($G(PSOREINS))
"RTN","PSOCAN",39,0)
 I REA="R",'$G(PSORX("DFLG")) D DCORD^PSONEW2
"RTN","PSOCAN",40,0)
 K PSOTECCK
"RTN","PSOCAN",41,0)
 D:$G(PSORX("DFLG")) ULP,ULRX
"RTN","PSOCAN",42,0)
 Q:$G(POERR)&($G(PSORX("DFLG")))
"RTN","PSOCAN",43,0)
 G NUM:$G(PSORX("DFLG"))
"RTN","PSOCAN",44,0)
 D:REA="C" CAN
"RTN","PSOCAN",45,0)
 Q:$G(POERR)
"RTN","PSOCAN",46,0)
 D ULP,ULRX G NUM
"RTN","PSOCAN",47,0)
YN D EN^PSOCMOPA I $G(XFLAG)]"" S %=0 K XFLAG Q
"RTN","PSOCAN",48,0)
 W ! S DIR("A")="Are you sure you want to "_PS,DIR(0)="Y",DIR("B")="NO" D ^DIR S %=Y K DIR,DUOUT,DTOUT I 'Y!$D(DIRUT) S VALMBCK="R"
"RTN","PSOCAN",49,0)
 K DIRUT Q
"RTN","PSOCAN",50,0)
REA S REA=+$P(^PSRX(DA,"STA"),"^") I REA=12 S REA="R" Q
"RTN","PSOCAN",51,0)
 I REA,REA'=11 W !?5,$C(7) D
"RTN","PSOCAN",52,0)
 .W "Rx# "_RXNUM_" was"_$S(REA=1:" Non-Verified",REA=13:" Deleted",REA=11:" Expired",REA=5:" Suspended",REA=4:" Pending Due to Drug Interactions",REA=3:" On Hold",REA=14!(REA=15):" Discontinued",REA=16:" Provider Held",1:" In Fill Status")_"."
"RTN","PSOCAN",53,0)
 I REA,REA'=1,REA'=3,REA'=5,REA'=11,REA'<13,REA'=16 D  Q
"RTN","PSOCAN",54,0)
 .K REA W !?10,"Rx Cannot Be Discontinued/Reinstated!" H 2
"RTN","PSOCAN",55,0)
 .S VALMSG="Rx# "_RXNUM_" Cannot Be "_$S($G(PSTS):"Reinstated",1:"Discontinued")_"."
"RTN","PSOCAN",56,0)
 S REA="C" Q
"RTN","PSOCAN",57,0)
CAN N PSODRUG D CAN1^PSOCAN3 Q
"RTN","PSOCAN",58,0)
DIV I '$P($G(PSOSYS),"^",2) W !?10,$C(7),"RX# ",$P(^PSRX(DA,0),"^")," is not a valid choice.  (Different Division)" S PSPOP=1 Q
"RTN","PSOCAN",59,0)
 I $P($G(PSOSYS),"^",3) W !?10,$C(7) S DIR("A")="RX# "_$P(^PSRX(DA,0),"^")_" is from another division.  Continue",DIR(0)="Y",DIR("B")="Y" D ^DIR K DIR S:$G(DIRUT)!('Y) PSPOP=1
"RTN","PSOCAN",60,0)
 Q
"RTN","PSOCAN",61,0)
CHK K VADM,DEAD S DFN=PSODFN D DEM^VADPT I $G(VADM(6))="" S DEAD=0 Q
"RTN","PSOCAN",62,0)
 S (PSODEATH,DEAD)=1 W !!,?10,VADM(1)_" DIED "_$P($G(VADM(6)),"^",2) D CAN^PSOCAN3 K PSODEATH
"RTN","PSOCAN",63,0)
 Q
"RTN","PSOCAN",64,0)
RX N PKI S RXCNT=0,RXSP=1 D TESTRP D COM^PSOCAN1 G:'$D(INCOM)!($D(DIRUT)) NUM K PSINV,PSCAN F II=1:1 S (EN,X)=$P(IN,",",II) Q:$P(IN,",",II)']""  S DIC=52,DIC(0)="QMZ" D ^DIC K DIC S:Y'>0 PSINV(X)="" D:Y>0
"RTN","PSOCAN",65,0)
 .S YY=Y,YY(0,0)=Y(0,0),(PSODFN,DFN)=$P(Y(0),"^",2) D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN)
"RTN","PSOCAN",66,0)
 .D:$G(DFN)>0 CHK I DEAD!($P(^PSRX(+YY,"STA"),"^")=13)!($P(^("STA"),"^")=14) S PSINV(EN)="" Q
"RTN","PSOCAN",67,0)
 .I $P(^PSRX(+YY,"STA"),"^")=12,$P($G(^("PKI")),"^") S PKI=1,PSINV(EN)="" Q
"RTN","PSOCAN",68,0)
 .S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP
"RTN","PSOCAN",69,0)
 .S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN",70,0)
 .;S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP Q
"RTN","PSOCAN",71,0)
 .;E  S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN",72,0)
 K YY G:'$D(PSCAN) INVALD^PSOCAN1 S RX="",RXCNT=0 F  S RX=$O(PSCAN(RX)) Q:RX=""  S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),RXCNT=RXCNT+1  D SHOW^PSOCAN1
"RTN","PSOCAN",73,0)
ASK Q:'$D(PSCAN)  W ! S DIR("A")="OK to "_$S($G(RXCNT)>1:"Change Status",REA="C":"Discontinued",1:"Reinstate"),DIR(0)="Y",DIR("B")="N"
"RTN","PSOCAN",74,0)
 N PSOCNRXV S PSOCNRXV=0
"RTN","PSOCAN",75,0)
 D ^DIR K DIR Q:$G(DIRUT)  I 'Y K PSCAN D INVALD^PSOCAN1 G NUM
"RTN","PSOCAN",76,0)
 K PSOPLCKZ S RX="" F  S RX=$O(PSCAN(RX)) Q:'RX  D
"RTN","PSOCAN",77,0)
 .S PSODFN=+$P($G(^PSRX(+PSCAN(RX),0)),"^",2)
"RTN","PSOCAN",78,0)
 .S PSOPLCK=$$L^PSSLOCK(+$G(PSODFN),0) D:'$G(PSOPLCK)&('$D(PSOPLCKZ(PSODFN))) LOCK^PSOORCPY I '$G(PSOPLCK) S PSOPLCKZ(PSODFN)=PSODFN Q
"RTN","PSOCAN",79,0)
 .D PSOL^PSSLOCK(+PSCAN(RX)) I '$G(PSOMSG) D  D UL^PSSLOCK(PSODFN) Q
"RTN","PSOCAN",80,0)
 ..I $P($G(PSOMSG),"^",2)'="" W !,$P($G(PSOMSG),"^",2),!,"Order "_$P($G(^PSRX(+PSCAN(RX),0)),"^")_"." Q
"RTN","PSOCAN",81,0)
 ..W !,"Another person is editing order "_$P($G(^PSRX(+PSCAN(RX),0)),"^")_"."
"RTN","PSOCAN",82,0)
 .D ACT D PSOUL^PSSLOCK(+PSCAN(RX)),UL^PSSLOCK(PSODFN)
"RTN","PSOCAN",83,0)
 .S PSOCNRXV=1
"RTN","PSOCAN",84,0)
 K PSOPLCKZ W:$G(PSOCNRXV) !,$S($G(RXCNT)>1:"Statuses Changed",REA="C":"Prescription Discontinued",1:"Prescription Reinstated") D INVALD^PSOCAN1 G NUM
"RTN","PSOCAN",85,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 Q
"RTN","PSOCAN",86,0)
 D CAN Q
"RTN","PSOCAN",87,0)
EXP ;S PSINV($P(^PSRX(DA,0),"^"))="" 
"RTN","PSOCAN",88,0)
 Q:$P(^PSRX(DA,"STA"),"^")=12
"RTN","PSOCAN",89,0)
 S $P(^PSRX(DA,"STA"),"^")=11 D ECAN^PSOUTL(DA)
"RTN","PSOCAN",90,0)
 S STAT="SC",PHARMST="ZE",COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3) D EN^PSOHLSN1(DA,STAT,PHARMST,COMM) K COMM,STAT,PHARMST
"RTN","PSOCAN",91,0)
EP1 I '$G(RXSP) D INVALD^PSOCAN1 Q:$G(POERR)  G NUM
"RTN","PSOCAN",92,0)
 Q
"RTN","PSOCAN",93,0)
PSD ;Called from Controlled Subs, PSDRX is internal Rx number
"RTN","PSOCAN",94,0)
 S PSDRFDEL=0
"RTN","PSOCAN",95,0)
 I '$G(PSDRX)!('$D(^PSRX(+$G(PSDRX),0))) Q
"RTN","PSOCAN",96,0)
 I $P($G(^PSRX(PSDRX,"STA")),"^")<12 Q
"RTN","PSOCAN",97,0)
 N DA,NODE,RF,PSOPSDAL,PSODRX,PSODTE,PSODL,SFN,RIFN,PSOSXP,PSOFILDL
"RTN","PSOCAN",98,0)
 S PSODRX=0 F PSODLP=0:0 S PSODLP=$O(^PSRX(PSDRX,1,PSODLP)) Q:'PSODLP  S:$D(^PSRX(PSDRX,1,PSODLP,0)) PSODRX=PSODLP
"RTN","PSOCAN",99,0)
 I 'PSODRX Q
"RTN","PSOCAN",100,0)
 I $P($G(^PSRX(PSDRX,1,PSODRX,0)),"^",18) Q
"RTN","PSOCAN",101,0)
 D PSDREF I $G(PSOFILDL) K PSOFILDL Q
"RTN","PSOCAN",102,0)
 K PSOFILDL,DIE S NODE=0,PSOPSDAL=1,DA(1)=PSDRX,DA=PSODRX,DIE="^PSRX("_DA(1)_",1,",DR=".01///@" D ^DIE K DIE
"RTN","PSOCAN",103,0)
 S PSDRFDEL=1
"RTN","PSOCAN",104,0)
 Q
"RTN","PSOCAN",105,0)
PSDREF ;
"RTN","PSOCAN",106,0)
 N PRDL,PSOCNODE
"RTN","PSOCAN",107,0)
 S PSOFILDL=0
"RTN","PSOCAN",108,0)
 F PRDL=0:0 S PRDL=$O(^PSRX(PSDRX,4,PRDL)) Q:'PRDL  I $G(PSODRX)=$P($G(^PSRX(PSDRX,4,PRDL,0)),"^",3) S PSOCNODE=$G(^(0))
"RTN","PSOCAN",109,0)
 I $G(PSOCNODE)="" Q
"RTN","PSOCAN",110,0)
 I +$P(PSOCNODE,"^",4)<3 S PSOFILDL=1
"RTN","PSOCAN",111,0)
 Q
"RTN","PSOCAN",112,0)
TESTRP ;
"RTN","PSOCAN",113,0)
 N PIIN,PIINFLAG S PIINFLAG=0 F PIIN=1:1 S X=$P(IN,",",PIIN) Q:$P(IN,",",PIIN)']""  K DIC S DIC=52,DIC(0)="QMZ" D ^DIC K DIC I +$G(Y) D
"RTN","PSOCAN",114,0)
 .I $P($G(^PSRX(+Y,"STA")),"^")'=12,'$G(PIINFLAG) S PSOCANRD=+$P($G(^PSRX(+Y,0)),"^",4) S PIINFLAG=1
"RTN","PSOCAN",115,0)
 I '$G(PIINFLAG) S PSOCANRZ=1
"RTN","PSOCAN",116,0)
 Q
"RTN","PSOCAN",117,0)
ULP ;
"RTN","PSOCAN",118,0)
 D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOCAN",119,0)
 Q
"RTN","PSOCAN",120,0)
ULRX ;
"RTN","PSOCAN",121,0)
 I $G(PSOULRX) D PSOUL^PSSLOCK(PSOULRX)
"RTN","PSOCAN",122,0)
 Q
"RTN","PSOCAN2")
0^9^B85372649
"RTN","PSOCAN2",1,0)
PSOCAN2 ;BHAM ISC/JMB - rx cancel with speed ability drug check ; 2/16/12 3:40pm
"RTN","PSOCAN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,18,62,46,88,164,235,148,259,281,287,251,375,379,396,390,372,416**;DEC 1997;Build 32
"RTN","PSOCAN2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCAN2",4,0)
REINS N DODR,ORN
"RTN","PSOCAN2",5,0)
 I $G(PSODFN)'=$G(PSOODOSP) K PSORX("DOSING OFF"),PSOREINF S PSOODOSP=PSODFN
"RTN","PSOCAN2",6,0)
 I $P(^PSRX(DA,2),"^",6)<DT D  Q
"RTN","PSOCAN2",7,0)
 .S Y=$P(^PSRX(DA,2),"^",6) X ^DD("DD")
"RTN","PSOCAN2",8,0)
 .W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" Drug: "_$S($D(^PSDRUG($P(^PSRX(DA,0),"^",6),0)):$P(^(0),"^"),1:""),!,"Expired "_Y_" and cannot be Reinstated!",!
"RTN","PSOCAN2",9,0)
 .D PAUSE^VALM1
"RTN","PSOCAN2",10,0)
 I $D(^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA)) S PSCAN($P(^PSRX(DA,0),"^"))=DA_"^R",DODR=1 D AUTOD G ACT
"RTN","PSOCAN2",11,0)
 I $P(PSOPAR,"^",2),'$D(^XUSEC("PSORPH",DUZ)) N PSOVODA S PSOVODA=DA D DRGDRG Q:$G(PSOQUIT)&($G(PSOREINS))  S DA=PSOVODA Q:PSORX("DFLG")  D VERIFY D  D AREC^PSOCAN1 Q
"RTN","PSOCAN2",12,0)
 .S RX1=$P(^PSRX(DA,0),"^") S:'$D(PSCAN(RX1)) PSCAN(RX1)=DA_"^R" K RX1
"RTN","PSOCAN2",13,0)
ACT W ! F I=1:1:80 W "="
"RTN","PSOCAN2",14,0)
 D ^PSOBUILD S DRG=+$P(^PSRX(DA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:""),HOLDRX=RX
"RTN","PSOCAN2",15,0)
 W !!,RX_"  "_DRG I $G(POERR) S HPOERR=POERR
"RTN","PSOCAN2",16,0)
 D DRGDRG Q:$G(PSOQUIT)&($G(PSOREINS))
"RTN","PSOCAN2",17,0)
 S:$G(HPOERR) POERR=HPOERR S:$G(PSORX("DFLG"))'=1 PSORX("DFLG")=0
"RTN","PSOCAN2",18,0)
 S RX=HOLDRX K HOLDRX,HPOERR Q:$P(^PSRX(+PSCAN(RX),"STA"),"^")'=12!($G(PSORX("DFLG")))
"RTN","PSOCAN2",19,0)
 S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2) D CAN^PSOCAN W !
"RTN","PSOCAN2",20,0)
 N RXIEN S RXIEN=DA
"RTN","PSOCAN2",21,0)
 ;Takes action on reinstated Rx's
"RTN","PSOCAN2",22,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN2",23,0)
 S (LPRT,LREF,XRELDT,XFDT)="" F LL=0:0 S LL=$O(^PSRX(DA,"L",LL)) Q:'LL  S LPRT=$P($G(^PSRX(DA,"L",LL,0)),"."),LREF=$P($G(^(0)),"^",2)
"RTN","PSOCAN2",24,0)
 I 'RFCNT S FDT=$S($P($G(^PSRX(DA,2)),"^",2)'="":$P($G(^PSRX(DA,2)),"^",2),1:$P($G(^PSRX(DA,2)),"^")) S RELDT=$P(^(2),"^",13),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",25,0)
 I RFCNT S FDT=$P($G(^PSRX(DA,1,RFCNT,0)),"^"),RELDT=$P(^(0),"^",18),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",26,0)
 S Y=FDT D DD^%DT S XFDT=Y I RELDT'="" S Y=RELDT D DD^%DT S XRELDT=Y
"RTN","PSOCAN2",27,0)
 I LPRT'="" S Y=LPRT D DD^%DT S XLPDT=Y
"RTN","PSOCAN2",28,0)
 ;If Rx was released, do nothing
"RTN","PSOCAN2",29,0)
 I RELDT'="" W !,RX_" Reinstated -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:""),?56,"Released: "_$G(XRELDT) H 3 Q
"RTN","PSOCAN2",30,0)
 ;If Rx not released, check fill/refill date for action
"RTN","PSOCAN2",31,0)
 I $G(PSXSYS) D REINS^PSOCMOPA I $G(XFLAG) K XFLAG Q
"RTN","PSOCAN2",32,0)
 W !,"Prescription #"_RX_" REINSTATED!"
"RTN","PSOCAN2",33,0)
 ;
"RTN","PSOCAN2",34,0)
 N PSOTRIC S PSOTRIC="",PSOTRIC=$$TRIC^PSOREJP1(RXIEN,RFCNT,PSOTRIC)
"RTN","PSOCAN2",35,0)
 D SUBMIT^PSOREJU3(RXIEN,RFCNT,PSOTRIC)
"RTN","PSOCAN2",36,0)
 ;
"RTN","PSOCAN2",37,0)
 W !?3,"Prescription #",RX_": "
"RTN","PSOCAN2",38,0)
 W !?6,$S('RFCNT:"  Filled",1:"  Refilled # "_LREF)_": "_XFDT,"  Printed: "_$S(LREF=RFCNT:XLPDT,1:""),"  Released: "_$G(XRELDT),!
"RTN","PSOCAN2",39,0)
 I FDT<DT D
"RTN","PSOCAN2",40,0)
 .Q:$$FIND^PSOREJUT(RXIEN)  ;No label for Rx's with unresolved claims rejects
"RTN","PSOCAN2",41,0)
 .Q:PSOTRIC&($$STATUS^PSOBPSUT(RXIEN,RFCNT)["IN PROGRESS")  ;No labels for TRICARE/CHAMPVA in progress Rx *396
"RTN","PSOCAN2",42,0)
 .I PSOTRIC,$P($G(^PSRX(RXIEN,"STA")),"^")=12 Q  ;No label for TRICARE/CHAMPVA if discontinued via Reject Notification screen *396
"RTN","PSOCAN2",43,0)
 .S DIR("A")="     ** Do you want to print the label now",DIR("B")="N",DIR(0)="Y",DIR("?")="Enter 'Y' to print the label now.  If 'N' is entered, the label may be reprinted through reprint at a later date."
"RTN","PSOCAN2",44,0)
 .D ^DIR K DIR Q:$G(DIRUT)!('Y)  S PPL=RXIEN D Q^PSORXL Q
"RTN","PSOCAN2",45,0)
 I FDT=DT D
"RTN","PSOCAN2",46,0)
 . Q:$$FIND^PSOREJUT(RXIEN)  ;No label for Rx's with unresolved claims rejects
"RTN","PSOCAN2",47,0)
 . Q:PSOTRIC&($$STATUS^PSOBPSUT(RXIEN,RFCNT)["IN PROGRESS")  ;No labels for TRICARE/CHAMPVA in progress Rx *396
"RTN","PSOCAN2",48,0)
 . I PSOTRIC,$P($G(^PSRX(RXIEN,"STA")),"^")=12 Q  ;No label for TRICARE/CHAMPVA if discontinued via Reject Notification screen *396
"RTN","PSOCAN2",49,0)
 . W !?5,"Either print the label using the reprint option "
"RTN","PSOCAN2",50,0)
 . W !?7,"or check later to see if the label has been printed." D WAIT^PSODRG Q
"RTN","PSOCAN2",51,0)
 I FDT>DT&('$G(DODR)) W !?5,"Placing Rx on suspense.  Please wait..." D SUS
"RTN","PSOCAN2",52,0)
 K DODR
"RTN","PSOCAN2",53,0)
 Q
"RTN","PSOCAN2",54,0)
SUS ;Adds rec to suspense
"RTN","PSOCAN2",55,0)
 S ACT=1,RXN=DA,RX0=^PSRX(DA,0),RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK S DA=RXN
"RTN","PSOCAN2",56,0)
 S RXP=$S($D(RXP):RXP,1:0),DIC="^PS(52.5,",DIC(0)="L",X=RXN,DIC("DR")=".02///"_FDT_";.03///"_$P(RX0,"^",2)_";.04///M;.05///"_RXP_";.06////"_$G(PSOSITE)_";2///0" K DD,DO D FILE^DICN
"RTN","PSOCAN2",57,0)
 I +$G(Y),$G(RFCNT)'="" S $P(^PS(52.5,+Y,0),"^",13)=$G(RFCNT)
"RTN","PSOCAN2",58,0)
 S DA=RXN,$P(^PSRX(DA,"STA"),"^")=5,LFD=$E($P(^PSRX(DA,3),"^"),4,5)_"-"_$E($P(^(3),"^"),6,7)_"-"_$E($P(^(3),"^"),2,3)
"RTN","PSOCAN2",59,0)
 S ACOM="RX Placed on Suspense until "_LFD D AREC^PSOCAN1 S ST="SC",PHST="ZS" D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST
"RTN","PSOCAN2",60,0)
 Q
"RTN","PSOCAN2",61,0)
DRGDRG ;Checks for drug/drug interaction, duplicate drug and class
"RTN","PSOCAN2",62,0)
 Q:$P(^PSRX(DA,2),"^",6)<DT
"RTN","PSOCAN2",63,0)
 S (PSORX("DFLG"),PSORXED("DFLG"))=0
"RTN","PSOCAN2",64,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSOCAN2",65,0)
 S STAT=$P(STA,"^",$P(^PSRX(DA,"STA"),"^")+1)
"RTN","PSOCAN2",66,0)
 S X=$P(^PSRX(DA,0),"^",6),DIC="^PSDRUG(",DIC(0)="MZO" D ^DIC K DIC Q:$D(DTOUT)!(Y<0)
"RTN","PSOCAN2",67,0)
 K HOLD S NAME=$P(Y(0),"^") I +$G(PSOSD(STAT,NAME))=+PSCAN(RX) S HOLD(STAT,NAME)=$G(PSOSD(STAT,NAME)) K PSOSD(STAT,NAME)
"RTN","PSOCAN2",68,0)
 S:$G(PSONEW("OLD VAL"))=+Y PSODRG("QFLG")=1
"RTN","PSOCAN2",69,0)
 K PSOY,PSOTECCK S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSOCAN2",70,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S PSOTECCK=1 N ZRXN
"RTN","PSOCAN2",71,0)
 S (ZRXN,PSORENW("OIRXN"))=DA D SET^PSODRG,POST^PSODRG Q:$G(PSOREINS)&$G(PSOQUIT)
"RTN","PSOCAN2",72,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("C")
"RTN","PSOCAN2",73,0)
 S REA=$P(PSCAN($P(^PSRX(PSORENW("OIRXN"),0),"^")),"^",2)
"RTN","PSOCAN2",74,0)
 W ! S:$G(HOLD(STAT,NAME))]"" PSOSD(STAT,NAME)=$G(HOLD(STAT,NAME)) K HOLD,STA,STAT,PSORENW("OIRXN")
"RTN","PSOCAN2",75,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOCAN2",76,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOCAN2",77,0)
 .N RXN,PSODAOC S RXN=ZRXN,PSODAOC="Rx Reinstate Order Acceptance_OP"
"RTN","PSOCAN2",78,0)
 .D DAOC^PSONEW
"RTN","PSOCAN2",79,0)
 .K ^TMP("PSODAOC",$J),RET
"RTN","PSOCAN2",80,0)
 Q
"RTN","PSOCAN2",81,0)
VERIFY ;Put in non-verify file
"RTN","PSOCAN2",82,0)
 S PSRXDA=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXDA,DIC(0)="ML",DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN2",83,0)
 K DD,DO D FILE^DICN K DIC,DLAYGO,DINUM
"RTN","PSOCAN2",84,0)
 S DA=PSRXDA S $P(^PSRX(DA,"STA"),"^")=1
"RTN","PSOCAN2",85,0)
 S ST="SC",PHST="IP",VCOM="Put in non-verified status" D EN^PSOHLSN1(DA,ST,PHST,VCOM) K ST,PHST,VCOM
"RTN","PSOCAN2",86,0)
 Q
"RTN","PSOCAN2",87,0)
HLD N PSDTEST,PDA,CMOP,SUSD I $P(^PSRX(DA,"STA"),"^")=3 D
"RTN","PSOCAN2",88,0)
 .S ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while on hold during Rx cancel. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")=""
"RTN","PSOCAN2",89,0)
 .I $P(^PSRX(DA,0),"^",13),'$O(^PSRX(DA,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(DA,0),"^",13),1,7) D ^DIE K DIE,DR Q
"RTN","PSOCAN2",90,0)
 .S (IFN,SUSD)=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S SUSD=IFN,RFDT=$P(^PSRX(DA,1,IFN,0),"^")
"RTN","PSOCAN2",91,0)
 .Q:'$G(SUSD)  I '$P(^PSRX(DA,1,SUSD,0),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(DA,1,SUSD),^PSRX("AD",RFDT,DA,SUSD),^PSRX(DA,1,"B",RFDT,SUSD),IFN,SUSD,RFDT
"RTN","PSOCAN2",92,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(DA,"L",PDA)) Q:'PDA  I $P($G(^PSRX(DA,"L",PDA,0)),"^",2)=SUSD S PSDTEST=1
"RTN","PSOCAN2",93,0)
 ..K CMOP D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOCAN2",94,0)
 ..S PSDTEST=1
"RTN","PSOCAN2",95,0)
 Q
"RTN","PSOCAN2",96,0)
REF S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I $P($G(^PSRX(DA,1,IFN,0)),"^")=SUSD,'$P(^(0),"^",18) D
"RTN","PSOCAN2",97,0)
 .D DELREF I $G(PSORFDEL) K PSORFDEL Q
"RTN","PSOCAN2",98,0)
 .;PSO*7*259;CHECK IF REFILL RELEASED OR LABEL PRINTED
"RTN","PSOCAN2",99,0)
 .I $P($G(^PSRX(DA,1,IFN,0)),"^",18)]"" Q  ;REFILL RELEASED
"RTN","PSOCAN2",100,0)
 .N PSONODEL,PSOLBL S PSONODEL=0
"RTN","PSOCAN2",101,0)
 .I $P(^PSRX(DA,"STA"),"^")=5 D REF^PSOCAN4 Q:PSONODEL
"RTN","PSOCAN2",102,0)
 .S PSOLBL="" F  S PSOLBL=$O(^PSRX(DA,"L",PSOLBL),-1) Q:'PSOLBL  Q:PSONODEL  Q:$P(^PSRX(DA,"L",PSOLBL,0),"^",2)<IFN  I $P(^PSRX(DA,"L",PSOLBL,0),"^",2)=IFN S PSONODEL=1
"RTN","PSOCAN2",103,0)
 .Q:PSONODEL
"RTN","PSOCAN2",104,0)
 .K PSORFDEL K ^PSRX(DA,1,IFN),^PSRX("AD",SUSD,DA,IFN),^PSRX(DA,1,"B",SUSD,IFN)
"RTN","PSOCAN2",105,0)
 .S $P(^PSRX(DA,1,0),"^",4)=$P(^PSRX(DA,1,0),"^",4)-1,DA(1)=DA
"RTN","PSOCAN2",106,0)
 .S NODE=0 D SPR^PSOUTL K DA(1),RF,NODE
"RTN","PSOCAN2",107,0)
 S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I '$O(^PSRX(DA,1,IFN)) S $P(^PSRX(DA,3),"^")=+$P(^PSRX(DA,1,IFN,0),"^"),$P(^(3),"^",2)=SUSD
"RTN","PSOCAN2",108,0)
 I '$O(^PSRX(DA,1,0)) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,2),"^",2),$P(^PSRX(DA,3),"^",2)=SUSD
"RTN","PSOCAN2",109,0)
 K IFN,SUSD
"RTN","PSOCAN2",110,0)
 Q
"RTN","PSOCAN2",111,0)
KILL K %,ACNT,ACOM,ACT,ALL,BCNUM,CMOP,CNT,DA,DAYS360,DEAD,DRG,DIRUT,DR,DRUG,DTOUT,DUOUT,FDT,HOLD,I,II,IN,IT,JJ,LC,LFD,LINE,LL,LPRT,LREF,LSI,NAME,NDF,NOEXP,NSF,OUT,RXSP,EN,WARN K:'$G(POERR) INCOM
"RTN","PSOCAN2",112,0)
 K PSODRUG,PCNT,POP,PPL,PS,PSFROM,PSINV,PLINE,PSI,PSINV,PSOCAN,PSOCMOP,PSODFN,PSODRG,PSOOPT,PSOSD,PSPOP,PSRXDA,PSS,PSVC,PSONOOR
"RTN","PSOCAN2",113,0)
 K REA,RELDT,RF,RFDATE,RFCNT,RFL,RFL1,RFLL,RP,RX,RX0,RXCNT,RXDA,RXN,RXNUM,RXP,RXREC,RXREF,RXS,SDATE,SPCANC,SS,STAT,SUB,X,XFDT,XLPDT,XRELDT,Y D KVA^VADPT Q
"RTN","PSOCAN2",114,0)
DELREF ;
"RTN","PSOCAN2",115,0)
 N RDL,PSCNODE
"RTN","PSOCAN2",116,0)
 S PSORFDEL=0
"RTN","PSOCAN2",117,0)
 F RDL=0:0 S RDL=$O(^PSRX(DA,4,RDL)) Q:'RDL  I $G(IFN)=$P($G(^PSRX(DA,4,RDL,0)),"^",3) S PSCNODE=$G(^(0))
"RTN","PSOCAN2",118,0)
 I $G(PSCNODE)="" Q
"RTN","PSOCAN2",119,0)
 I +$P(PSCNODE,"^",4)<3 S PSORFDEL=1
"RTN","PSOCAN2",120,0)
 Q
"RTN","PSOCAN2",121,0)
AUTOD ;reinstates Rxs dc'd by date of death
"RTN","PSOCAN2",122,0)
 I $G(^PSRX(DA,"DDSTA"))']"" K ^PSRX("APSOD",+$P(^PSRX(DA,0),"^",2),DA),DODR Q
"RTN","PSOCAN2",123,0)
 S DODS=$P(^PSRX(DA,"DDSTA"),"^"),DODD=$P(^("DDSTA"),"^",2,245)
"RTN","PSOCAN2",124,0)
 S FILE=$P(DODS,";"),STA=$P(DODS,";",2)
"RTN","PSOCAN2",125,0)
 I FILE=52.4 D  Q
"RTN","PSOCAN2",126,0)
 .S RXN=DA,^PS(52.4,DA,0)=DODD,DIK="^PS(52.4," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",127,0)
 .S ST="SC",PHST="IP",ACOM="Date of Death Deleted. Returned to Non-Verified status."
"RTN","PSOCAN2",128,0)
 .K ^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",129,0)
 .S DA=RXN D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,RXN
"RTN","PSOCAN2",130,0)
 I FILE=52.5 D  Q
"RTN","PSOCAN2",131,0)
 .;Adds rec to suspense
"RTN","PSOCAN2",132,0)
 .S RXN=DA,RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK
"RTN","PSOCAN2",133,0)
 .S DIC="^PS(52.5,",DIC(0)="L",X=RXN K DD,DO D FILE^DICN S DA=+Y
"RTN","PSOCAN2",134,0)
 .S ^PS(52.5,DA,0)=DODD,^PS(52.5,DA,"P")=0,LFD=$E($P(^PS(52.5,DA,0),"^",2),4,5)_"-"_$E($P(^(0),"^",2),6,7)_"-"_$E($P(^(0),"^",2),2,3)
"RTN","PSOCAN2",135,0)
 .S DIK="^PS(52.5," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",136,0)
 .S ACOM="Date of Death Deleted. RX Placed on Suspense until "_LFD
"RTN","PSOCAN2",137,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",138,0)
 .I STA=5 S ST="SC",PHST="ZS" D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,LFD
"RTN","PSOCAN2",139,0)
 I FILE=52 S ^PSRX(DA,"STA")=STA I STA=3!(STA=16) D  Q
"RTN","PSOCAN2",140,0)
 .S ^PSRX(DA,"H")=DODD,^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)=""
"RTN","PSOCAN2",141,0)
 .S ACOM="Date of Death Deleted. Medication Returned to"_$S(STA=16:" Provider",1:"")_" Hold Status "_$E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3)_"."
"RTN","PSOCAN2",142,0)
 .D LOG,EN^PSOHLSN1(DA,"OH","",ACOM) K ACOM
"RTN","PSOCAN2",143,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",144,0)
 S ACOM="Date of Death Deleted. Prescription Reinstated." D EN^PSOHLSN1(DA,"SC","CM",ACOM),LOG K ACOM
"RTN","PSOCAN2",145,0)
 K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",146,0)
 Q
"RTN","PSOCAN2",147,0)
LOG K ACNT F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",148,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=$G(RFCNT)+1 S:RF>5 RFCNT=$G(RFCNT)+1
"RTN","PSOCAN2",149,0)
 S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",150,0)
 D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(DA,"A",ACNT,0)=%_"^R^"_DUZ_"^"_RFCNT_"^"_ACOM
"RTN","PSOCAN2",151,0)
 K ^PSRX("APSOD",PSODFN,DA),ACNT,RFCNT,RF,%
"RTN","PSOCAN2",152,0)
 I $P(^PSRX(DA,3),"^",10) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,3),"^",10) ;*396
"RTN","PSOCAN2",153,0)
 S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8)
"RTN","PSOCAN2",154,0)
 S $P(^PSRX(DA,3),"^",5)="",$P(^(3),"^",8)=""
"RTN","PSOCAN2",155,0)
 Q
"RTN","PSOCAN2",156,0)
NVER ;Called from PSOCAN3, needs DA defined
"RTN","PSOCAN2",157,0)
 N PSONVC,PSONVCP,PSONVCC
"RTN","PSOCAN2",158,0)
 S PSONVC="SC",PSONVCP="IP",PSONVCC="Put in non-verified status" D EN^PSOHLSN1(DA,PSONVC,PSONVCP,PSONVCC)
"RTN","PSOCAN2",159,0)
 Q
"RTN","PSOCAN2",160,0)
RMB(IDX) ;remove Rx if found in array BBRX() (Bingo Board)
"RTN","PSOCAN2",161,0)
 N ST4,ST5,ST6,K
"RTN","PSOCAN2",162,0)
 S ST4=BBRX(IDX) Q:ST4'[(DA_",")
"RTN","PSOCAN2",163,0)
 S ST6=""
"RTN","PSOCAN2",164,0)
 F K=1:1 S ST5=$P(ST4,",",K) Q:'ST5  D
"RTN","PSOCAN2",165,0)
 . S:ST5'=DA ST6=ST6_$S('ST6:"",1:",")_ST5
"RTN","PSOCAN2",166,0)
 . S:ST6]"" BBRX(IDX)=ST6_"," K:ST6="" BBRX(IDX)
"RTN","PSOCAN2",167,0)
 I '$D(BBRX) K BINGCRT
"RTN","PSOCAN2",168,0)
 Q
"RTN","PSOCAN2",169,0)
 ;
"RTN","PSODDPR2")
0^10^B107649994
"RTN","PSODDPR2",1,0)
PSODDPR2 ;BIR/SAB - display enhanced order checks ;11 May 2010  9:06 AM
"RTN","PSODDPR2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,390,372,416**;DEC 1997;Build 32
"RTN","PSODDPR2",3,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR2",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR2",5,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR2",6,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR2",7,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789 
"RTN","PSODDPR2",8,0)
 K ^UTILITY($J),PSODRUG("BAD"),THER,THERO,^TMP($J,"PSODCOR"),PSOINTV,PSOVAG,PSODD,PSI,PSORDIT,DRGNM,PDODCNT
"RTN","PSODDPR2",9,0)
 I $O(^TMP($J,LIST,"OUT","EXCEPTIONS",""))]"" D EXC^PSODDPR5 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",10,0)
 N COUNT,DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV,PSOLINES,OLDDRG,PSOOLDD,PSOTSUB,PSODSEQ,ZST,ZHDR,ZSUB,ZZDGDGC,PSOCLNS
"RTN","PSODDPR2",11,0)
 S (ON,DRG,SV,LSI,DGI,SER,SERS,PSOOLDD)="",(ZZDGDGC,CT,COUNT)=0,$P(PSONULN,"-",79)="-",$P(PSONULN1,"=",79)="=",ZHDR=1
"RTN","PSODDPR2",12,0)
 D NSRT^PSODDPR5 K ^TMP("PSODGI",$J),^TMP("PSOSER",$J),^TMP("PSOSERS",$J),^TMP("PSODGS",$J),^TMP("PSOTDD",$J,1)
"RTN","PSODDPR2",13,0)
 S (ON,DRG,SV,DGI,SER,SERS,ZVA)="",(ZST,ZORS,CT,COUNT)=0
"RTN","PSODDPR2",14,0)
 F  S SV=$O(ZZDGDG(SV)) Q:SV=""!$G(PSODLQT)  F  S ZST=$O(ZZDGDG(SV,ZST)) Q:'ZST!$G(PSODLQT)  F  S ZORS=$O(ZZDGDG(SV,ZST,ZORS)) Q:'ZORS!$G(PSODLQT)  D
"RTN","PSODDPR2",15,0)
 .F  S ZVA=$O(ZZDGDG(SV,ZST,ZORS,ZVA)) Q:ZVA=""!$G(PSODLQT)  F  S DRG=$O(ZZDGDG(SV,ZST,ZORS,ZVA,DRG)) Q:DRG=""!$G(PSODLQT)  S COUNT=COUNT+1 D DUP^PSODDPR8,BLD2^PSODGDGP
"RTN","PSODDPR2",16,0)
 K HZVA,ZVA,ZORS,ZZDGDG,PSOCLNS,COUNT,ON,DRG,SV,DGI,PSORX("INTERVENE"),DIR D HD() G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",17,0)
 Q:$D(PSSDIUTL)
"RTN","PSODDPR2",18,0)
 I +$G(PSOINTV) D INT G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",19,0)
 I $G(PSORX("DFLG")) W:$G(COPY) !,$C(7),"RX DELETED",! S PSORX("DFLG")=1,POERR("DFLG")=1,VALMBCK="R" G EXIT  Q
"RTN","PSODDPR2",20,0)
 I '$D(^XUSEC("PSORPH",DUZ)) K PSORX("INTERVENE")
"RTN","PSODDPR2",21,0)
 I $G(PSORX("INTERVENE"))]"" D FULL^VALM1,^PSORXI S:'$G(POERR) VALMBCK="R" W !
"RTN","PSODDPR2",22,0)
 I $G(PSORX("DFLG")) G EXIT
"RTN","PSODDPR2",23,0)
 I $O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",""))]"" D  G EXIT:PSODLQT  I ($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",24,0)
 .S NODDERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",25,0)
 .I ($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q
"RTN","PSODDPR2",26,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Interaction Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",27,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON)) Q:ON=""  F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT)) Q:'CT  D
"RTN","PSODDPR2",28,0)
 ..Q:$G(NODDERR)&($P(ON,";")'="Z")
"RTN","PSODDPR2",29,0)
 ..W ?5,$S($P(ON,";")="N":"",$P(ON,";")="R":"Remote Rx for ",$P(ON,";")="O":"Local Rx for ",1:"Prospective Rx for ")
"RTN","PSODDPR2",30,0)
 ..W " "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",31,0)
 ..D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",32,0)
 ;therapy
"RTN","PSODDPR2",33,0)
 ;D HD() G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",34,0)
THER I '$O(^TMP($J,LIST,"OUT","THERAPY",0)) G EXIT
"RTN","PSODDPR2",35,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$P(PSOPAR,"^",2),$G(PSOTECCK) G EXIT
"RTN","PSODDPR2",36,0)
 D NSRT1^PSODDPR5
"RTN","PSODDPR2",37,0)
 N ON,DDTH,CLASS,QTHER,ZDRG,ZTHER K DUPT,THER,THERO,SUB,ZOT I '$P(PSOPAR,"^",10) D NOCAN^PSODDPR5 G ERR
"RTN","PSODDPR2",38,0)
 W @IOF,PSONULN1,! S (SUB,CT,LST,PSOZZ)=0 S THER=1,THERO=0,QTHER=1 K RXDT
"RTN","PSODDPR2",39,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT!$G(PSODLQT)  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB!$G(PSODLQT)  S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^") D
"RTN","PSODDPR2",40,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR2",41,0)
 .S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",42,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR2",43,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR2",44,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR2",45,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",46,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",47,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR2",48,0)
 .S ZOT=$S($P(ON,";")["C":1,$P(ON,";")="O":2,$P(ON,";")="R":3,$P(ON,";")="P":4,1:5)
"RTN","PSODDPR2",49,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR2",50,0)
 ..I '$P(^PS(52.41,$P(ON,";",2),0),"^",9) S ZDRG=$P(^PS(50.7,$P(^PS(52.41,$P(ON,";",2),0),"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^") Q
"RTN","PSODDPR2",51,0)
 ..S ZDRG=$P(^PSDRUG($P(^PS(52.41,$P(ON,";",2),0),"^",9),0),"^")
"RTN","PSODDPR2",52,0)
 .I $P(ON,";")="O" S ZDRG=$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR2",53,0)
 .I $P(ON,";")="N" D
"RTN","PSODDPR2",54,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0)
"RTN","PSODDPR2",55,0)
 ..I '$P(DUPRX0,"^",2) S ZDRG=$P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^") Q
"RTN","PSODDPR2",56,0)
 ..S ZDRG=$P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR2",57,0)
 .I $P(ON,";")="R" D
"RTN","PSODDPR2",58,0)
 ..Q:'$D(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)))
"RTN","PSODDPR2",59,0)
 ..S RXREC=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)),ZDRG=$P(RXREC,"^",3)
"RTN","PSODDPR2",60,0)
 .I $E($P(ON,";"))="C" S RXREC=^TMP($J,LIST,"IN","PROFILE",ON),ZDRG=$P(RXREC,U,4) Q:$D(ZTHER(ZOT_"^"_ZDRG_"^"_ON))  ; clinic order
"RTN","PSODDPR2",61,0)
 .S ZTHER(ZOT_"^"_ZDRG_"^"_ON,SUB)=ON K ZDRG
"RTN","PSODDPR2",62,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",63,0)
 I $O(ZTHER(""))]"" D
"RTN","PSODDPR2",64,0)
 .S (PSODUPF,PSODUPC,PSODUPC1,PSOTSUB)="" F  S PSODUPF=$O(ZTHER(PSODUPF)) Q:PSODUPF=""  F  S PSOTSUB=$O(ZTHER(PSODUPF,PSOTSUB)) Q:PSOTSUB=""  S PSODUPC1=PSODUPC1+1
"RTN","PSODDPR2",65,0)
 .;get line counts for each duplicate therapy by setting PSODUPF=1 and calling DUPCL to execute therapy code without actually displaying info. ; no breaks in the middle of displaying individual dup therapies.
"RTN","PSODDPR2",66,0)
 .S PSODUPF=1,PSODUPC=0,PSODUPC("CLASS")="" D DUPCL S PSODUPF=0
"RTN","PSODDPR2",67,0)
 .;set PSODUPF=0 then call DUPCL to actually print the duplicate therapies.
"RTN","PSODDPR2",68,0)
 .D DUPCL K DDTH,PSODUPC,PSODUPF,PSODUPC1,PSODUPC2
"RTN","PSODDPR2",69,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",70,0)
 K PSODCTH,RXDT,PSOZZ
"RTN","PSODDPR2",71,0)
 I $P(PSOPAR,"^",10),$O(^TMP($J,"PSODCOR",0)),'$G(PSODGCK) D DCOR^PSODDPR3 K ^TMP($J,"PSODCOR") D HD() G EXIT:$G(PSODLQT) W !,PSONULN1,!
"RTN","PSODDPR2",72,0)
 E  I $D(^XUSEC("PSORPH",DUZ)) S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",73,0)
ERR I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" D  S NODTERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",74,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Therapy Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",75,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON)) Q:ON=""!$G(PSODLQT)  F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT)) Q:'CT!$G(PSODLQT)  D
"RTN","PSODDPR2",76,0)
 ..Q:$G(NODTERR)&($P(ON,";")'="Z")!$G(PSODLQT)
"RTN","PSODDPR2",77,0)
 ..D HD() Q:$G(PSODLQT)  W ?5,$S($P(ON,";")="P":"Pending Order: ",$P(ON,";")="N":"Non-VA Med Order: ",$P(ON,";")="R":"Remote Rx: ",$P(ON,";")="O":"Rx: ",1:"Prospective Rx: ")
"RTN","PSODDPR2",78,0)
 ..D HD() Q:$G(PSODLQT)  W " "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",79,0)
 I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q:$G(PSODLQT)
"RTN","PSODDPR2",80,0)
 D HD()
"RTN","PSODDPR2",81,0)
EXIT ;
"RTN","PSODDPR2",82,0)
 D ^PSOBUILD
"RTN","PSODDPR2",83,0)
 K DSPL,CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG,ZCT
"RTN","PSODDPR2",84,0)
 K IT,LST,THER,THERO,^UTILITY($J),DGI,SER,SEV,SERS,BSIG,I,NODDERR,NODTERR,PDRG,DRGI,STATUS,^UTILITY($J,"W"),X,ZX,DIWL,DIWR,DIWF,THER,THERO,PSOINTV,ZTHER,PSOVORD,PSODCTH,ZZDGDG,ZZDGDG2
"RTN","PSODDPR2",85,0)
 Q
"RTN","PSODDPR2",86,0)
 ;
"RTN","PSODDPR2",87,0)
RX D HD() Q:$G(PSODLQT)  W ! S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",88,0)
 S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),STATUS=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPR2",89,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODDPR2",90,0)
 S J=RXREC D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",91,0)
 I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODDPR2",92,0)
 I STATUS>10,STATUS'=16 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR W @IOF S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC Q
"RTN","PSODDPR2",93,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",94,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",95,0)
 I STATUS=16 W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! K DUP,RXRECLOC S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",96,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",97,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODDPR2",98,0)
 .W !!,"Another person is editing Rx #"_$P($G(^PSRX(RXREC,0)),"^"),!
"RTN","PSODDPR2",99,0)
 K PSOMSG S DIR("A")=$S(STATUS=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(RXREC,0),"^"),DIR(0)="Y",DIR("?")="Enter Y to "_$S(STATUS=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODDPR2",100,0)
 D ^DIR K DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR2",101,0)
 S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S(STATUS=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODDPR2",102,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODDPR2",103,0)
 I 'Y W $C(7)," -Prescription was not "_$S(STATUS=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODDPR2",104,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S(STATUS=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP
"RTN","PSODDPR2",105,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODDPR2",106,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S(STATUS=12:"R",1:"C")
"RTN","PSODDPR2",107,0)
 W !!,"THERAPEUTIC DUPLICATIONS will be discontinued after the acceptance of the new order.",!!
"RTN","PSODDPR2",108,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_ST_"^"_DRG,PSONOOR="D"
"RTN","PSODDPR2",109,0)
 K RXRECLOC,DUP,CLS,PSONOOR,STATUS,ACT,PSONV,REA,SPCANC
"RTN","PSODDPR2",110,0)
 Q
"RTN","PSODDPR2",111,0)
 ;
"RTN","PSODDPR2",112,0)
DUPCL ;
"RTN","PSODDPR2",113,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR2",114,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 W:'$G(PSODUPF) @IOF,PSONULN1,!
"RTN","PSODDPR2",115,0)
 I '$G(PSODUPF) W "*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with"
"RTN","PSODDPR2",116,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 N PSODUPCT,PSODUPC2,PSODUPCL
"RTN","PSODDPR2",117,0)
 S (PSODUPC2,PSODUPCT)=0 S:'$G(PSODUPF) PSODUPCT=2
"RTN","PSODDPR2",118,0)
 ;displays order and therapy
"RTN","PSODDPR2",119,0)
 K DDTH S (PSODUPCL,ZSUB,ZCT,PSODSEQ,PSODSEQ)=""
"RTN","PSODDPR2",120,0)
 F  S ZCT=$O(ZTHER(ZCT)) Q:ZCT=""!($G(PSODLQT))  F  S PSODSEQ=$O(ZTHER(ZCT,PSODSEQ)) Q:PSODSEQ=""!($G(PSODLQT))  S ON=ZTHER(ZCT,PSODSEQ) D
"RTN","PSODDPR2",121,0)
 .S PDODCNT=0,PSODUPC2=PSODUPC2+1 I $G(PSODUPF) S PSODUPC(ZCT)=0
"RTN","PSODDPR2",122,0)
 .I PSODUPC2=PSODUPC2+1
"RTN","PSODDPR2",123,0)
 .I '$G(PSODUPF) D
"RTN","PSODDPR2",124,0)
 ..I PSODUPC2=PSODUPC1,(PSODUPCT+PSODUPC(ZCT)+PSODUPC("CLASS"))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",125,0)
 ..I (PSODUPCT+PSODUPC(ZCT))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",126,0)
 ..S PSODUPCT=PSODUPCT+PSODUPC(ZCT)
"RTN","PSODDPR2",127,0)
 .I $P(ON,";")="O" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D DDRX^PSODDPR8 D
"RTN","PSODDPR2",128,0)
 ..Q:STATUS>5&(STATUS'=16)
"RTN","PSODDPR2",129,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""
"RTN","PSODDPR2",130,0)
 ..Q:$G(RXDT("O",RXREC))
"RTN","PSODDPR2",131,0)
 ..S RX0=^PSRX(RXREC,0),J=RXREC,RX2=^PSRX(RXREC,2) D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",132,0)
 ..S PSOZZ=PSOZZ+1,^TMP($J,"PSODCOR",PSOZZ)="52"_"^"_RXREC_"^"_ST_"^"_DRGNM,RXDT("O",RXREC)=1
"RTN","PSODDPR2",133,0)
 .I $P(ON,";")="N" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D ^PSODDPR3
"RTN","PSODDPR2",134,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR2",135,0)
 ..D HD(8) Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! S RXREC=$P(ON,";",2) D PEND^PSODDPR8
"RTN","PSODDPR2",136,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""
"RTN","PSODDPR2",137,0)
 ..Q:$G(RXDT("P",RXREC))
"RTN","PSODDPR2",138,0)
 ..S PSOZZ=PSOZZ+1,DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR2",139,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)="P"_"^"_RXREC_"^^"_$S($P(DUPRX0,"^",9):$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"),1:$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"))
"RTN","PSODDPR2",140,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)=^TMP($J,"PSODCOR",PSOZZ)_"^"_$S('$P(DUPRX0,"^",9):$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"))
"RTN","PSODDPR2",141,0)
 ..S RXDT("P",RXREC)=1
"RTN","PSODDPR2",142,0)
 .I $P(ON,";")="R" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D RDI^PSODDPR3 D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",143,0)
 .I $E($P(ON,";"))="C" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D DUP^PSODDPR7  ; clinic order
"RTN","PSODDPR2",144,0)
 .I $O(ZTHER(ZCT,PSODSEQ))'="" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,PSONULN
"RTN","PSODDPR2",145,0)
 D CLASSES^PSODDPR3
"RTN","PSODDPR2",146,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR2",147,0)
 I '$G(PSODUPF)&'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODDPR2",148,0)
 .S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF
"RTN","PSODDPR2",149,0)
 .I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",150,0)
 .I '$G(PSODUPF),($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",151,0)
 Q
"RTN","PSODDPR2",152,0)
INT ;
"RTN","PSODDPR2",153,0)
 Q:$D(PSSDIUTL)
"RTN","PSODDPR2",154,0)
 D INT^PSODDPR5
"RTN","PSODDPR2",155,0)
 Q
"RTN","PSODDPR2",156,0)
HD(PSOLINES,OVRRID) ;
"RTN","PSODDPR2",157,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODDPR2",158,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)'>IOSL) Q
"RTN","PSODDPR2",159,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODDPR2",160,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSODDPR2",161,0)
 K PSOLINES,OVRRID
"RTN","PSODDPR2",162,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",163,0)
 W:'$G(PSODUPF) @IOF
"RTN","PSODDPR2",164,0)
 Q
"RTN","PSODDPR4")
0^11^B126073847
"RTN","PSODDPR4",1,0)
PSODDPR4 ;BHAM - ISC/EJW,SAB - build local OP  & RDI profiles ;07/19/07
"RTN","PSODDPR4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,387,379,390,372,416**;DEC 1997;Build 32
"RTN","PSODDPR4",3,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODDPR4",4,0)
 ;External references to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSODDPR4",5,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR4",6,0)
 ;External reference to IN^PSJBLDOC supported by DBIA 5306
"RTN","PSODDPR4",7,0)
 ;External references to ^PSSDSAPM supported by DBIA 5570
"RTN","PSODDPR4",8,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR4",9,0)
 ;External reference to ENCHK^PSJORUT2 supported by DBIA 2376
"RTN","PSODDPR4",10,0)
 ;External reference to IN^PSSHRQ2 supported by DBIA 5369
"RTN","PSODDPR4",11,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR4",12,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR4",13,0)
 ;
"RTN","PSODDPR4",14,0)
BLD(PSODFN,LIST,PDRG,PTY) ;
"RTN","PSODDPR4",15,0)
 ;build OP, RDI, INP MEDS profiles
"RTN","PSODDPR4",16,0)
 ;PTY - P1;P2 where P1="I" for IP & "O" for OP (required), P2=Pharm order# (optional)
"RTN","PSODDPR4",17,0)
 I '$D(PSODFN) W !,"Patient UNDEFINED!",! Q
"RTN","PSODDPR4",18,0)
 I '$D(LIST) W !,"Input Base UNDEFINED!",! Q
"RTN","PSODDPR4",19,0)
 K ^TMP($J,LIST)
"RTN","PSODDPR4",20,0)
ORD N PSODTCUT,X1,X2,ODRG,ORTYP,ORN,DO,IEN,NAME,PROF,PSOON,PSODPSPR S (PROF,CNT)=0
"RTN","PSODDPR4",21,0)
 F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  S IEN=$P(PDRG(ZI),"^"),NAME=$P(PDRG(ZI),"^",2) D DRG
"RTN","PSODDPR4",22,0)
 I $D(PSJDGCK),'$D(PSGDGCKF) Q:$O(^TMP($J,LIST,"IN","PROSPECTIVE",""))=""   ;no prospective drugs to pass in
"RTN","PSODDPR4",23,0)
 I '$D(PSJDGCK),$O(^TMP($J,LIST,"IN","PROSPECTIVE",""))="" D:$O(PSODUPSP(0)) DRGSUP Q  ;no prospective drugs to pass in and drug is supply, create supply nodes
"RTN","PSODDPR4",24,0)
 S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X D ^PSOBUILD,PROFILE
"RTN","PSODDPR4",25,0)
 K PSOSD D REMOTE D:$P($G(PTY),";")="I" IN^PSJBLDOC(PSODFN,LIST,.PDRG,$G(PTY))
"RTN","PSODDPR4",26,0)
 S ^TMP($J,LIST,"IN","IEN")=PSODFN,^TMP($J,LIST,"IN","DRUGDRUG")="",^TMP($J,LIST,"IN","THERAPY")=""
"RTN","PSODDPR4",27,0)
 S ^TMP($J,LIST,"IN","SOURCE")=$P($G(PTY),";")
"RTN","PSODDPR4",28,0)
 I $P($G(PTY),";")="O" D IMO^PSODDPR7(PSODFN)
"RTN","PSODDPR4",29,0)
 N PSOICT,PSODRUG,PSOY,CNT,ZI
"RTN","PSODDPR4",30,0)
 D IN^PSSHRQ2(LIST) D:$O(PSODUPSP(0)) DRGSUP
"RTN","PSODDPR4",31,0)
 Q
"RTN","PSODDPR4",32,0)
PROFILE ;build profile drug input
"RTN","PSODDPR4",33,0)
 N ID,ORTYP,DD,PSOI,ORN,RECTYP S (STA,DNM)="",DO=0
"RTN","PSODDPR4",34,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  D
"RTN","PSODDPR4",35,0)
 .I STA="PENDING" D  Q
"RTN","PSODDPR4",36,0)
 ..Q:$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",3)="RF"
"RTN","PSODDPR4",37,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ORN=$P(^PS(52.41,RXREC,0),"^"),ODRG=$P(^(0),"^",9),ORTYP="P"
"RTN","PSODDPR4",38,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPR4",39,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",40,0)
 ...S DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",41,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(52.41,RXREC,0),"^",8) D
"RTN","PSODDPR4",42,0)
 ...S DRNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR4",43,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"O") I '$P(DDRG,";") D OIX Q
"RTN","PSODDPR4",44,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",45,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPR4",46,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",47,0)
 ...D ID1
"RTN","PSODDPR4",48,0)
 .I STA="ZNONVA" D  Q
"RTN","PSODDPR4",49,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ODRG=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^",2),ORN=$P($G(^(0)),"^",8),ORTYP="N"
"RTN","PSODDPR4",50,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPR4",51,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",52,0)
 ...S DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",53,0)
  ..E  N PSOI,DDRG,ODRG,SEQN,DDRG,DRNM S PSOI=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^") D
"RTN","PSODDPR4",54,0)
 ...S DRNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR4",55,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"X") I '$P(DDRG,";") D:'$$NVATST^PSODDPRE(PSOI) OIX Q
"RTN","PSODDPR4",56,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",57,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3),DO=DO+1 K PSOI
"RTN","PSODDPR4",58,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",59,0)
 ...D ID1
"RTN","PSODDPR4",60,0)
 .S RXREC=+PSOSD(STA,DNM)
"RTN","PSODDPR4",61,0)
 .I $P($G(PTY),";")="O",$P($G(PTY),";",2)=RXREC Q
"RTN","PSODDPR4",62,0)
 .I $P($G(^PSRX(RXREC,0)),"^",6) S ODRG=$P(^PSRX(RXREC,0),"^",6) D
"RTN","PSODDPR4",63,0)
 ..I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",64,0)
 ..I STA="DISCONTINUED" Q:$$DUPTHER^PSODDPRE(RXREC)  ;screen out duplicate therapy for local orders
"RTN","PSODDPR4",65,0)
 ..S ORN=$P($G(^PSRX(RXREC,"OR1")),"^",2),ORTYP="O",DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",66,0)
 K RXREC,ID,STA,DNM,SEQN,PSOI,PSODD,P1,P3,OR1,P2,PSODRUG,DD,DRNM,DDRG
"RTN","PSODDPR4",67,0)
 Q
"RTN","PSODDPR4",68,0)
ID N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",69,0)
 S P1=$P($G(^PSDRUG(ODRG,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=+$P(X,"^",7)
"RTN","PSODDPR4",70,0)
ID1 I '$D(PSJDGCK) S ^TMP($J,LIST,"IN","PROFILE",ORTYP_";"_RXREC_";PROFILE;"_DO)=SEQN_"^"_ID_"^"_ODRG_"^"_DRNM_"^"_ORN_"^O" K ID
"RTN","PSODDPR4",71,0)
 I $D(PSJDGCK) S ^TMP($J,LIST,"IN","PROSPECTIVE",ORTYP_";"_RXREC_";PROSPECTIVE;"_DO)=SEQN_"^"_ID_"^"_ODRG_"^"_DRNM_"^"_ORN_"^O" K ID
"RTN","PSODDPR4",72,0)
 Q
"RTN","PSODDPR4",73,0)
OIX S ^TMP($J,LIST,"IN","EXCEPTIONS","OI",DRNM)=1_"^"_ORTYP_";"_RXREC_";PROFILE;"_DO
"RTN","PSODDPR4",74,0)
 K TU
"RTN","PSODDPR4",75,0)
 Q
"RTN","PSODDPR4",76,0)
REMOTE ;
"RTN","PSODDPR4",77,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODDPR4",78,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODDPR4",79,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSODDPR4",80,0)
 .I $T(REMOTE^PSORX1)]"" Q
"RTN","PSODDPR4",81,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODDPR4",82,0)
 .W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODDPR4",83,0)
 I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed." D HD^PSODDPR2():(($Y+5)'>IOSL) Q
"RTN","PSODDPR4",84,0)
 N PSORDI,RDIINST,RDIVUID,RDIRX,RDIDNAM,RDISTA,RDISIG,RDIDAYS,RDIQTY,RDIFILL,RDIEXP,RDIISS,RDIFILL,ZI
"RTN","PSODDPR4",85,0)
 N RDIREF,RDIPHYS,PSOPROD,PSOCLASS,DRNM,RDITMP,PSODC,IT,PSOICT,NDF,RDIDI,PSOPRODA,PSOFILE,PSOSIG,PSOSEQN,X
"RTN","PSODDPR4",86,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSODDPR4",87,0)
 S PSORDI=0
"RTN","PSODDPR4",88,0)
 I $T(GET^ORRDI1)]"" S PSORDI=$$GET^ORRDI1(PSODFN,"PSOO")
"RTN","PSODDPR4",89,0)
 I PSORDI<1 Q
"RTN","PSODDPR4",90,0)
 I '$D(^XTMP("ORRDI","PSOO",PSODFN)) Q
"RTN","PSODDPR4",91,0)
 K ^TMP($J,LIST,"OUT","REMOTE")
"RTN","PSODDPR4",92,0)
 D PARSE,FILTER
"RTN","PSODDPR4",93,0)
 I '$D(^TMP($J,LIST,"OUT","REMOTE")) Q
"RTN","PSODDPR4",94,0)
 N DIC D REMO
"RTN","PSODDPR4",95,0)
 Q
"RTN","PSODDPR4",96,0)
REMO ;
"RTN","PSODDPR4",97,0)
  S (PSOON,PSORDI)=0 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI  S RDITMP=^(PSORDI) D  K PSOSEQN
"RTN","PSODDPR4",98,0)
 .Q:$P(RDITMP,"^",2)=""
"RTN","PSODDPR4",99,0)
 .;screen out dc'd remotes
"RTN","PSODDPR4",100,0)
 .I $P($G(^TMP($J,LIST,"OUT","REMOTE",PSORDI)),"^",4)["DISC" D  I $G(PSOON) K PSOON Q
"RTN","PSODDPR4",101,0)
 ..K X,Y,X1,X2
"RTN","PSODDPR4",102,0)
 ..S X=$P(^TMP($J,LIST,"OUT","REMOTE",PSORDI),"^",6) D ^%DT S X1=Y,X2=(+$P(^TMP($J,LIST,"OUT","REMOTE",PSORDI),"^",7)+7)
"RTN","PSODDPR4",103,0)
 ..D C^%DTC I X<DT S PSOON=1 K X,Y,X1,X2
"RTN","PSODDPR4",104,0)
 .;
"RTN","PSODDPR4",105,0)
 .S RDIVUID=$P(RDITMP,"^",2),RDIDNAM=$P(RDITMP,"^",3)
"RTN","PSODDPR4",106,0)
 .I $O(PDRG(0)) F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  I $P(^PSDRUG($P(PDRG(ZI),"^"),0),"^")=RDIDNAM S INDD=+$G(INDD)+1,^TMP($J,"DD",INDD,0)=$P(PDRG(ZI),"^")_"^"_RDIDNAM_"^^"_PSORDI_"Z;O"
"RTN","PSODDPR4",107,0)
 .S DO=$G(DO)+1 D GETIREF^XTID(50.68,.01,RDIVUID,"PSOSEQN",1) I 'PSOSEQN S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=0_"^"_RDIVUID_"^0^"_RDIDNAM_"^^" Q
"RTN","PSODDPR4",108,0)
 .S SEQN="" S SEQN=$O(PSOSEQN(50.68,.01,SEQN)) Q:SEQN=""
"RTN","PSODDPR4",109,0)
 .S P3=+SEQN,SEQN=$P($$PROD0^PSNAPIS(,P3),"^",7)
"RTN","PSODDPR4",110,0)
 .S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=SEQN_"^"_RDIVUID_"^0^"_RDIDNAM_"^^"
"RTN","PSODDPR4",111,0)
 Q
"RTN","PSODDPR4",112,0)
 ;
"RTN","PSODDPR4",113,0)
PARSE ; PULL INFORMATION FROM ^XTMP
"RTN","PSODDPR4",114,0)
 N PSORDI,LOCAL,NEWISS,BADEXP,PSOPRE,PSO30,NEWDC,NEWEXP
"RTN","PSODDPR4",115,0)
 S PSORDI=0 F  S PSORDI=$O(^XTMP("ORRDI","PSOO",PSODFN,PSORDI)) Q:'PSORDI  D
"RTN","PSODDPR4",116,0)
 .S RDISTA=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,5,0))
"RTN","PSODDPR4",117,0)
 .I RDISTA="DELETED" Q
"RTN","PSODDPR4",118,0)
 .S RDIINST=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,1,0))
"RTN","PSODDPR4",119,0)
 .S RDIDNAM=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,2,0))
"RTN","PSODDPR4",120,0)
 .S RDIVUID=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,3,0))
"RTN","PSODDPR4",121,0)
 .I RDIVUID="" Q
"RTN","PSODDPR4",122,0)
 .D GETPROD^PSOORRDI
"RTN","PSODDPR4",123,0)
 .Q:$E($G(PSOCLASS),1,2)="XA"
"RTN","PSODDPR4",124,0)
 .S RDIRX=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,4,0))
"RTN","PSODDPR4",125,0)
 .S RDIQTY=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,6,0))
"RTN","PSODDPR4",126,0)
 .S RDIDAYS=$P(RDIQTY,";",2),RDIQTY=$P(RDIQTY,";")
"RTN","PSODDPR4",127,0)
 .I $E(RDIDAYS)="D" S RDIDAYS=$P(RDIDAYS,"D",2)
"RTN","PSODDPR4",128,0)
 .S RDIEXP=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,7,0))
"RTN","PSODDPR4",129,0)
 .S RDIISS=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,8,0))
"RTN","PSODDPR4",130,0)
 .I RDIEXP?."/" S BADEXP=1 D  I BADEXP Q
"RTN","PSODDPR4",131,0)
 ..I RDIISS?."/" Q
"RTN","PSODDPR4",132,0)
 ..S PSOPRE=$E(DT) I $P(RDIISS,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",133,0)
 ..S NEWISS=PSOPRE_$P(RDIISS,"/",3)_$P(RDIISS,"/")_$P(RDIISS,"/",2) I NEWISS>(DT-10000) S RDIEXP=RDIISS,BADEXP=0
"RTN","PSODDPR4",134,0)
 .I RDISTA["EXPIRE" S PSO30=0 D  I PSO30 Q
"RTN","PSODDPR4",135,0)
 ..S PSOPRE=$E(DT) I $P(RDIEXP,"/",3)>($E(DT,2,3)+1) S PSO30=1 Q
"RTN","PSODDPR4",136,0)
 ..S NEWEXP=PSOPRE_$P(RDIEXP,"/",3)_$P(RDIEXP,"/")_$P(RDIEXP,"/",2)
"RTN","PSODDPR4",137,0)
 ..S X1=NEWEXP,X2=30 D C^%DTC I X<DT S PSO30=1
"RTN","PSODDPR4",138,0)
 .I RDIRX'="" S LOCAL=0 D CHKLOCAL I LOCAL Q
"RTN","PSODDPR4",139,0)
 .S RDIFILL=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,9,0))
"RTN","PSODDPR4",140,0)
 .I RDISTA["DISCONT" S PSO30=0 D  I PSO30 Q
"RTN","PSODDPR4",141,0)
 ..S PSOPRE=$E(DT) I $P(RDIFILL,"/",3)>($E(DT,2,3)+1) S PSO30=1 Q
"RTN","PSODDPR4",142,0)
 ..S NEWDC=PSOPRE_$P(RDIFILL,"/",3)_$P(RDIFILL,"/")_$P(RDIFILL,"/",2)
"RTN","PSODDPR4",143,0)
 ..S X1=NEWDC,X2=30+RDIDAYS D C^%DTC I X<DT S PSO30=1
"RTN","PSODDPR4",144,0)
 .I RDISTA["DRUG INTERACTION" S RDISTA="NON-VERIFIED"
"RTN","PSODDPR4",145,0)
 .S RDIREF=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,10,0))
"RTN","PSODDPR4",146,0)
 .S RDIPHYS=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,11,0))
"RTN","PSODDPR4",147,0)
 .S PSOSIG="" F  S PSOSIG=$O(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,14,PSOSIG)) Q:PSOSIG=""  S PSOSIG(PSOSIG)=^(PSOSIG)
"RTN","PSODDPR4",148,0)
 .S ^TMP($J,LIST,"OUT","REMOTE",PSORDI)=RDIINST_"^"_RDIVUID_"^"_RDIDNAM_"^"_RDISTA_"^"_RDIRX_"^"_RDIFILL_"^"_RDIDAYS_"^"_RDIQTY_"^"_RDIREF_"^"_RDIEXP_"^"_RDIPHYS_"^"_RDIISS
"RTN","PSODDPR4",149,0)
 .S PSOSIG="" F  S PSOSIG=$O(PSOSIG(PSOSIG)) Q:PSOSIG=""  S ^TMP($J,LIST,"OUT","REMOTE",PSORDI,"SIG",PSOSIG)=PSOSIG(PSOSIG)
"RTN","PSODDPR4",150,0)
 Q
"RTN","PSODDPR4",151,0)
 ;
"RTN","PSODDPR4",152,0)
CHKLOCAL ; IF SAME RX NUMBER AND ISSUE DATE - LOCAL RX
"RTN","PSODDPR4",153,0)
 N PSOISS
"RTN","PSODDPR4",154,0)
 I $D(^PSRX("B",RDIRX)) D
"RTN","PSODDPR4",155,0)
 .N PSORX
"RTN","PSODDPR4",156,0)
 .S PSORX=$O(^PSRX("B",RDIRX,"")) I 'PSORX Q
"RTN","PSODDPR4",157,0)
 .S PSOISS=$P($G(^PSRX(PSORX,0)),"^",13)
"RTN","PSODDPR4",158,0)
 .S PSOISS=$E(PSOISS,4,5)_"/"_$E(PSOISS,6,7)_"/"_$E(PSOISS,2,3)
"RTN","PSODDPR4",159,0)
 .I PSOISS=RDIISS S LOCAL=1 Q
"RTN","PSODDPR4",160,0)
 Q
"RTN","PSODDPR4",161,0)
 ;
"RTN","PSODDPR4",162,0)
FILTER ; FOR SAME DRUG VUID FOR SAME SITE, KEEP 1 ENTRY - CHECK BY ACTIVE STATUS FIRST THEN BY GREATEST EXPIRATION DATE
"RTN","PSODDPR4",163,0)
 N XX,RDI,OLDEXP,RDIEXP,RDIEXP2,OLDEXP2,PSORDI,RDISTA,OLDSTA,OLDRDI,ZZ
"RTN","PSODDPR4",164,0)
 S PSORDI=0
"RTN","PSODDPR4",165,0)
 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI  D
"RTN","PSODDPR4",166,0)
 .S XX=$G(^TMP($J,LIST,"OUT","REMOTE",PSORDI)),RDIINST=$P(XX,"^"),RDIVUID=$P(XX,"^",2),RDISTA=$P(XX,"^",4),RDIEXP=$P(XX,"^",10) Q:RDIINST=""  Q:RDIVUID=""  I RDIEXP="" Q
"RTN","PSODDPR4",167,0)
 .I $D(RDI(RDIINST,RDIVUID)) S ZZ=RDI(RDIINST,RDIVUID) D  Q
"RTN","PSODDPR4",168,0)
 ..I RDISTA="ACTIVE"!(RDISTA["SUSPEN") D  Q
"RTN","PSODDPR4",169,0)
 ...S OLDSTA=$P(ZZ,"^",2) I OLDSTA["ACTIVE"!(OLDSTA["SUSPEN") D CHKEXP Q
"RTN","PSODDPR4",170,0)
 ...S OLDRDI=$P(ZZ,"^") K ^TMP($J,LIST,"OUT","REMOTE",OLDRDI) D SETRDI
"RTN","PSODDPR4",171,0)
 ..S OLDSTA=$P(ZZ,"^",2) I OLDSTA["ACTIVE"!(OLDSTA["SUSPEN") K ^TMP($J,LIST,"OUT","REMOTE",PSORDI) Q
"RTN","PSODDPR4",172,0)
 ..D CHKEXP ; ALL OTHER STATUSES - KEEP BY GREATER EXPIRATION DATE
"RTN","PSODDPR4",173,0)
 .D SETRDI
"RTN","PSODDPR4",174,0)
 Q
"RTN","PSODDPR4",175,0)
 ;
"RTN","PSODDPR4",176,0)
CHKEXP ; 
"RTN","PSODDPR4",177,0)
 N PSOPRE
"RTN","PSODDPR4",178,0)
 S OLDEXP=$P(ZZ,"^",3) D  I OLDEXP2>RDIEXP2 K ^TMP($J,"OUT","REMOTE",PSORDI) Q
"RTN","PSODDPR4",179,0)
 .S PSOPRE=$E(DT) I $P(RDIEXP,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",180,0)
 .S RDIEXP2=PSOPRE_$P(RDIEXP,"/",3)_$P(RDIEXP,"/")_$P(RDIEXP,"/",2)
"RTN","PSODDPR4",181,0)
 .S PSOPRE=$E(DT) I $P(OLDEXP,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",182,0)
 .S OLDEXP2=PSOPRE_$P(OLDEXP,"/",3)_$P(OLDEXP,"/")_$P(OLDEXP,"/",2)
"RTN","PSODDPR4",183,0)
 S OLDRDI=$P(ZZ,"^") K ^TMP($J,LIST,"OUT","REMOTE",OLDRDI) D SETRDI
"RTN","PSODDPR4",184,0)
 Q
"RTN","PSODDPR4",185,0)
 ;
"RTN","PSODDPR4",186,0)
SETRDI ;
"RTN","PSODDPR4",187,0)
 S RDI(RDIINST,RDIVUID)=PSORDI_"^"_RDISTA_"^"_RDIEXP
"RTN","PSODDPR4",188,0)
 Q
"RTN","PSODDPR4",189,0)
CPRS(PSODFN,LIST,PDRG,PTY) ;
"RTN","PSODDPR4",190,0)
 ;PDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSODDPR4",191,0)
 ;PTY - P1;P2 where P1="I" for IP & "O" for OP (required), P2=Pharm order# (optional)
"RTN","PSODDPR4",192,0)
 I '$G(PSODFN) W !,"Patient UNDEFINED!",! Q
"RTN","PSODDPR4",193,0)
 I '$O(PDRG(0)) W !,"Dispense Drug(s) UNDEFINED!",! Q
"RTN","PSODDPR4",194,0)
 I '$D(LIST) W !,"Input Base UNDEFINED!",! Q
"RTN","PSODDPR4",195,0)
 S ^TMP($J,LIST,"IN","PING")="" D IN^PSSHRQ2(LIST) I $P(^TMP($J,LIST,"OUT",0),"^")=-1 Q
"RTN","PSODDPR4",196,0)
 K ^TMP($J,"ORDERS"),^TMP($J,"DD"),^TMP($J,LIST) N ZII,INDX,INDD,PSODUPSP,PSODUPSY,PSODUPLS S (INDX,INDD)=0,PSODUPSY=$G(PTY),PSODUPLS=LIST
"RTN","PSODDPR4",197,0)
 ;build patient's drug profile outpat/inpat/non-va
"RTN","PSODDPR4",198,0)
 D BLD^PSOORDRG,ENCHK^PSJORUT2(PSODFN,.INDX),NVA^PSOORDRG
"RTN","PSODDPR4",199,0)
 ;dup drug check CPRS ONLY
"RTN","PSODDPR4",200,0)
 S PSOICT="",CNT=0 F ZII=0:0 S ZII=$O(PDRG(ZII)) Q:'ZII  D
"RTN","PSODDPR4",201,0)
 .S PSOY=$P(PDRG(ZII),"^")_"^"_$P($G(^PSDRUG($P(PDRG(ZII),"^"),0)),"^"),PSOY(0)=$G(^PSDRUG(PDRG(ZII),0))
"RTN","PSODDPR4",202,0)
 .S IEN=+PSOY,NAME=$P(PSOY,"^",2),DNM=0 K PSOX1,PSOY
"RTN","PSODDPR4",203,0)
 .F  S DNM=$O(^TMP($J,"ORDERS",DNM)) Q:'DNM  I NAME=$P(^TMP($J,"ORDERS",DNM),"^",3) D
"RTN","PSODDPR4",204,0)
 ..S INDD=$G(INDD)+1,^TMP($J,"DD",INDD,0)=IEN_"^"_NAME_"^"_$P(^TMP($J,"ORDERS",DNM),"^",4)_"^"_$P(^(DNM),"^",5),PSODUPSP(IEN)=PSODUPSY,PSODUPSP(IEN,"NAME")=NAME
"RTN","PSODDPR4",205,0)
 K ^TMP($J,"ORDERS")
"RTN","PSODDPR4",206,0)
 D ORD
"RTN","PSODDPR4",207,0)
 Q
"RTN","PSODDPR4",208,0)
DRG ;
"RTN","PSODDPR4",209,0)
 I $P($G(^PSDRUG(IEN,0)),"^",3)["S"!($E($P($G(^PSDRUG(IEN,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",210,0)
 N ID,SEQN S PSODRUG("NDF")=$S($G(^PSDRUG(IEN,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODDPR4",211,0)
 S ID=$$GETVUID^XTID(50.68,,+$P($G(PSODRUG("NDF")),"A",2)_",")
"RTN","PSODDPR4",212,0)
 S P1=$P($G(^PSDRUG(IEN,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=$P(X,"^",7)
"RTN","PSODDPR4",213,0)
 I '$D(PSJDGCK) S CNT=$G(CNT)+1,^TMP($J,LIST,"IN","PROSPECTIVE",$P(PTY,";")_";"_$P(PTY,";",2)_";PROSPECTIVE;"_CNT)=SEQN_"^"_+ID_"^"_IEN_"^"_NAME,PSODPSPR(IEN)=""
"RTN","PSODDPR4",214,0)
 I $D(PSJDGCK),'$D(PSGDGCKF) S CNT=$G(CNT)+1,^TMP($J,LIST,"IN","PROSPECTIVE",$P(PTY,";")_";"_$P(PTY,";",2)_";PROSPECTIVE;"_CNT)=SEQN_"^"_+ID_"^"_IEN_"^"_NAME,PSODPSPR(IEN)=""
"RTN","PSODDPR4",215,0)
 K ID,SEQN,P1,P2,X,DNM
"RTN","PSODDPR4",216,0)
 Q
"RTN","PSODDPR4",217,0)
 ;
"RTN","PSODDPR4",218,0)
DRGSUP ;Create "prospective" nodes for duplicate supply entries 
"RTN","PSODDPR4",219,0)
 N PSODPSID,PSODPSQN,PSODPSP1,PSODPSP2,PSODPSP3,PSODPSXX,PSODPSLP,PSODPSNF,PSODPSCT,PSODPSC1,PSODPSNM
"RTN","PSODDPR4",220,0)
 S PSODPSCT=0
"RTN","PSODDPR4",221,0)
 S PSODPSC1="" F  S PSODPSC1=$O(^TMP($J,PSODUPLS,"IN","PROSPECTIVE",PSODPSC1)) Q:PSODPSC1=""  S PSODPSP3=$P(PSODPSC1,";",4) I PSODPSP3>PSODPSCT S PSODPSCT=PSODPSP3
"RTN","PSODDPR4",222,0)
 S PSODPSLP="" F  S PSODPSLP=$O(PSODUPSP(PSODPSLP)) Q:PSODPSLP=""  D:'$D(PSODPSPR(PSODPSLP))
"RTN","PSODDPR4",223,0)
 .S PSODPSNM=$G(PSODUPSP(PSODPSLP,"NAME"))
"RTN","PSODDPR4",224,0)
 .S PSODPSNF=$S($G(^PSDRUG(PSODPSLP,"ND"))]"":+^PSDRUG(PSODPSLP,"ND")_"A"_$P(^PSDRUG(PSODPSLP,"ND"),"^",3),1:0)
"RTN","PSODDPR4",225,0)
 .S PSODPSID=$$GETVUID^XTID(50.68,,+$P($G(PSODPSNF),"A",2)_",")
"RTN","PSODDPR4",226,0)
 .S PSODPSP1=$P($G(^PSDRUG(PSODPSLP,"ND")),"^"),PSODPSP2=$P($G(^PSDRUG(PSODPSLP,"ND")),"^",3),PSODPSXX=$$PROD0^PSNAPIS(PSODPSP1,PSODPSP2),PSODPSQN=$P(PSODPSXX,"^",7)
"RTN","PSODDPR4",227,0)
 .S PSODPSCT=$G(PSODPSCT)+1,^TMP($J,PSODUPLS,"IN","PROSPECTIVE",$P(PSODUPSY,";")_";"_$P(PSODUPSY,";",2)_";PROSPECTIVE;"_PSODPSCT)=PSODPSQN_"^"_+PSODPSID_"^"_PSODPSLP_"^"_$G(PSODPSNM)
"RTN","PSODDPR4",228,0)
 Q
"RTN","PSODDPR5")
0^12^B160645085
"RTN","PSODDPR5",1,0)
PSODDPR5 ;BIR/SAB - displays OP/rdi/pending/nva orders ;09/320/06 11:33am
"RTN","PSODDPR5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,390,372,416**;DEC 1997;Build 32
"RTN","PSODDPR5",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR5",4,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR5",5,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR5",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228 
"RTN","PSODDPR5",7,0)
 ;
"RTN","PSODDPR5",8,0)
EXC ;displays order check exceptions
"RTN","PSODDPR5",9,0)
 N Q,CT,ONT,OT,ON,TD,ERRTY,OP,OPP,ZEXC,ZREA,X,DIWL,DIWR,DIWF,PSOWROTE
"RTN","PSODDPR5",10,0)
 I ($Y+5)'>IOSL D HD^PSODDPR2() Q:$G(PSODLQT)  ;W @IOF
"RTN","PSODDPR5",11,0)
 S (CT,Q)=0,ONT=""
"RTN","PSODDPR5",12,0)
 F  S ONT=$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT)) Q:ONT=""  F  S CT=$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT)) Q:'CT  D
"RTN","PSODDPR5",13,0)
 .S ZEXC=^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),ZREA=$P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",10)
"RTN","PSODDPR5",14,0)
 .S OT=$P(ONT,";"),ON=$P(ONT,";",2),OP=$P(ONT,";",3),OPP=OT_";"_ON_";"_OP
"RTN","PSODDPR5",15,0)
 .I '$D(PSODGCK),'$D(PSSDGCK),OT="Z",ZREA="Drug not matched to NDF"!($P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",7)["manual check") S PSODRUG("BAD",PSODRUG("IEN"))=1
"RTN","PSODDPR5",16,0)
 .Q:$G(^TMP($J,"PSEXC","OUT",OPP))
"RTN","PSODDPR5",17,0)
 .S Q=Q+1,ERRTY=$S(OT="R":"RDI",OT="N":"Non-VA",OT="P":"Pending",OT="O":"Rx",1:"")
"RTN","PSODDPR5",18,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPR5",19,0)
 .W ! S X=$P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",7) D ^DIWP
"RTN","PSODDPR5",20,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0) S PSOWROTE=1
"RTN","PSODDPR5",21,0)
 .I $D(PSODGCK)!$D(PSSDGCK) K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." W ! D ^DIR K DIR W @IOF
"RTN","PSODDPR5",22,0)
 .S:OT'="Z" ^TMP($J,"PSEXC","OUT",OPP)=1,PSOWROTE=1
"RTN","PSODDPR5",23,0)
 .Q:ZREA=""
"RTN","PSODDPR5",24,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPR5",25,0)
 .S X="   Reason(s): "_ZREA D ^DIWP
"RTN","PSODDPR5",26,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0) S PSOWROTE=1
"RTN","PSODDPR5",27,0)
 .K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF
"RTN","PSODDPR5",28,0)
 .D:$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT)) HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR5",29,0)
 W !! I $G(PSOWROTE) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 W ! K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSODDPR5",30,0)
 Q
"RTN","PSODDPR5",31,0)
NOCAN ;shows duplicate therapeutic when cancel duplicate class parameter is et to 'no'
"RTN","PSODDPR5",32,0)
 K ^UTILITY($J,"W"),DDTH,DOCPL S DIWL=1,DIWR=78,DIWF="",(CT,SUB)=0 K TCT,TCTP,TCTL,TCTI,ZZQ,ZHDR
"RTN","PSODDPR5",33,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D
"RTN","PSODDPR5",34,0)
 .S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^"),PDRG=$P(^(SUB),"^",3),RXREC=$P(ON,";",2)
"RTN","PSODDPR5",35,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR5",36,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR5",37,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR5",38,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR5",39,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",40,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",41,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR5",42,0)
 .I '$G(ZHDR) D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  W !,PSONULN,!,"*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with",! S ZHDR=1
"RTN","PSODDPR5",43,0)
 Q:'$G(ZHDR)  Q:$G(PSODLQT)
"RTN","PSODDPR5",44,0)
 N ST,STA,STAT,ORT K DOCPL
"RTN","PSODDPR5",45,0)
 S (SUB,CT)=0 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D DUPCL K DDTH
"RTN","PSODDPR5",46,0)
 D DUPCP
"RTN","PSODDPR5",47,0)
 Q
"RTN","PSODDPR5",48,0)
DUPCL ;
"RTN","PSODDPR5",49,0)
 S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^"),PDRG=$P(^(SUB),"^",3),RXREC=$P(ON,";",2)
"RTN","PSODDPR5",50,0)
 I $P(ON,";")="Z" Q
"RTN","PSODDPR5",51,0)
 I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR5",52,0)
 I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR5",53,0)
 I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",54,0)
 I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",55,0)
 I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR5",56,0)
 S ORT=$S($P(ON,";")="N":4,$P(ON,";")="P":3,$P(ON,";")="R":2,1:1)
"RTN","PSODDPR5",57,0)
 S DOCPL(ORT,ON)=""
"RTN","PSODDPR5",58,0)
 Q
"RTN","PSODDPR5",59,0)
DUPCP D HD^PSODDPR2():(($Y+5)'>IOSL) S ORT=0,ON=""  F  S ORT=$O(DOCPL(ORT)) Q:'ORT!$G(PSODLQT)  F  S ON=$O(DOCPL(ORT,ON)) Q:ON=""!$G(PSODLQT)  D
"RTN","PSODDPR5",60,0)
 .I $P(ON,";")="O" D
"RTN","PSODDPR5",61,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  S ST=$P(^PSRX($P(ON,";",2),"STA"),"^")+1
"RTN","PSODDPR5",62,0)
 ..S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED BY PROVIDER^DISCONTINUE EDIT^PROVIDER HOLD"
"RTN","PSODDPR5",63,0)
 ..S STAT=$P(STA,"^",ST) W !?2,"Local Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" ("_STAT_") for "_$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR5",64,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR5",65,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",66,0)
 ..S RXREC=$P(ON,";",2),DNM=$P(^PS(52.41,RXREC,0),"^",9)
"RTN","PSODDPR5",67,0)
 ..S DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR5",68,0)
 ..W !?2,"Pending Order for "
"RTN","PSODDPR5",69,0)
 ..I '$P(DUPRX0,"^",9) W $P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR5",70,0)
 ..E  W $P(^PSDRUG($P(DUPRX0,"^",9),0),"^")
"RTN","PSODDPR5",71,0)
 .I $P(ON,";")="R" N RXDAT D
"RTN","PSODDPR5",72,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",73,0)
 ..S RXDAT=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2))
"RTN","PSODDPR5",74,0)
 ..S RDIRX=$P(RXDAT,"^",5) D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  W !?2,"Remote Rx #"_RDIRX_" ("_$P(RXDAT,"^",4)_") for "_$P(RXDAT,"^",3)
"RTN","PSODDPR5",75,0)
 .I $P(ON,";")="N" D
"RTN","PSODDPR5",76,0)
 ..Q:'$D(^PS(55,PSODFN,"NVA",$P(ON,";",2),0))
"RTN","PSODDPR5",77,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0) N NVAQ
"RTN","PSODDPR5",78,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",79,0)
 ..W !?2,"Non-VA Med for "
"RTN","PSODDPR5",80,0)
 ..I '$P(DUPRX0,"^",2) W $P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR5",81,0)
 ..E  W $P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR5",82,0)
 .S DDTH(ON)=1
"RTN","PSODDPR5",83,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",84,0)
 D CLASSES^PSODDPR3
"RTN","PSODDPR5",85,0)
 D HD^PSODDPR2(0,1) Q:$G(PSODLQT)
"RTN","PSODDPR5",86,0)
 Q
"RTN","PSODDPR5",87,0)
REMOTE ;backdoor RDI
"RTN","PSODDPR5",88,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR5",89,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI!$G(PSODLQT)  S RDITMP=^(PSORDI) D  K PSOSEQN
"RTN","PSODDPR5",90,0)
 .I $P(RDITMP,"^",2)="" Q
"RTN","PSODDPR5",91,0)
 .S RDIVUID=$P(RDITMP,"^",2),RDIDNAM=$P(RDITMP,"^",3)
"RTN","PSODDPR5",92,0)
 .I $O(PDRG(0)) F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  I $P(^PSDRUG($P(PDRG(ZI),"^"),0),"^")=RDIDNAM S INDD=+$G(INDD)+1,^TMP($J,"DD",INDD,0)=$P(PDRG(ZI),"^")_"^"_RDIDNAM_"^^"_PSORDI_"Z;O"
"RTN","PSODDPR5",93,0)
 .S DO=$G(DO)+1 D GETIREF^XTID(50.68,.01,RDIVUID,"PSOSEQN",1) I 'PSOSEQN S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=0_"^"_RDIVUID_"^0^"_RDIDNAM_"^^" Q
"RTN","PSODDPR5",94,0)
 .S SEQN="" S SEQN=$O(PSOSEQN(50.68,.01,SEQN)) Q:SEQN=""
"RTN","PSODDPR5",95,0)
 .S P3=+SEQN,SEQN=$P($$PROD0^PSNAPIS(,P3),"^",7)
"RTN","PSODDPR5",96,0)
 .S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=SEQN_"^"_RDIVUID_"^0^"_RDIDNAM_"^^"
"RTN","PSODDPR5",97,0)
 Q
"RTN","PSODDPR5",98,0)
NSRT ;sort of drug interactions ; called by psoddpr2
"RTN","PSODDPR5",99,0)
 ;Q:$G(PSODLQT)
"RTN","PSODDPR5",100,0)
 N SV,SEV,STOP,TYP,CNT,CHK,DRG,ON,CT,ZOT,PSOVAG,PSODD,COUNT,NSRT,NSRT2 S COUNT=0,(SV,DRG,ON,CT,PSOVAG)=""
"RTN","PSODDPR5",101,0)
 F  S SV=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV)) Q:SV=""!$G(PSODLQT)  D  Q:$G(PSORX("DFLG"))
"RTN","PSODDPR5",102,0)
 .F  S DRG=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG)) Q:DRG=""!$G(PSODLQT)  F  S ON=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON)) Q:ON=""!$G(PSODLQT)  F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT)) Q:'CT!$G(PSODLQT)  D
"RTN","PSODDPR5",103,0)
 ..I $P(ON,";")'="Z",$P(ON,";")="O",$P(^PSRX($P(ON,";",2),"STA"),"^")>5,$P(^PSRX($P(ON,";",2),"STA"),"^")'=16 Q
"RTN","PSODDPR5",104,0)
 ..I $P(ON,";")'="Z",$P(ON,";")="R" D RVAGEN Q
"RTN","PSODDPR5",105,0)
 ..I $P(ON,";")'="Z",$P(ON,";")="P",'$P($G(^PS(52.41,$P(ON,";",2),0)),"^",9) S PSORDIT=$P($G(^PS(52.41,$P(ON,";",2),0)),"^",8) D:$G(PSORDIT) DVAGEN Q
"RTN","PSODDPR5",106,0)
 ..I $P(ON,";")'="Z",$P(ON,";")="N",'$P($G(^PS(55,PSODFN,"NVA",$P(ON,";",2),0)),"^",2) S PSORDIT=$P($G(^PS(55,PSODFN,"NVA",$P(ON,";",2),0)),"^") D:$G(PSORDIT) DVAGEN Q
"RTN","PSODDPR5",107,0)
 ..S PSODD=$O(^PSDRUG("B",DRG,0)) D:PSODD'="" VAGEN^PSODDPR3(PSODD)
"RTN","PSODDPR5",108,0)
 ..S:PSOVAG="" PSOVAG=DRG
"RTN","PSODDPR5",109,0)
 ..S ZOT=$S($P(ON,";")["C":1,$P(ON,";")="O":2,$P(ON,";")="R":3,$P(ON,";")="P":4,1:5)
"RTN","PSODDPR5",110,0)
 ..S ZDGDG(SV,ZOT,PSOVAG,DRG)=ON_"^"_CT
"RTN","PSODDPR5",111,0)
 ..I ZOT=1 S PSOCLNS(SV,PSOVAG,DRG,ON)=CT
"RTN","PSODDPR5",112,0)
 ..I '$D(NSRT(SV,PSOVAG)) S NSRT(SV,PSOVAG)=ZOT
"RTN","PSODDPR5",113,0)
 ..E  S $P(NSRT(SV,PSOVAG),"^",1)=$P(NSRT(SV,PSOVAG),"^",1)_","_ZOT
"RTN","PSODDPR5",114,0)
 ;resort of zdgdg
"RTN","PSODDPR5",115,0)
 K ZZDGDG S (SEV,STOP,PSOVAG,TYP,ON)="",CNT=0
"RTN","PSODDPR5",116,0)
 F J=1:1:5 F  S SEV=$O(NSRT(SEV)) Q:SEV=""  F I=1:1:5 F  S PSOVAG=$O(NSRT(SEV,PSOVAG)) Q:PSOVAG=""  D
"RTN","PSODDPR5",117,0)
 .S TYP="",TYP=","_$P(NSRT(SEV,PSOVAG),"^",1)_","
"RTN","PSODDPR5",118,0)
 .Q:TYP'[(","_J_",")
"RTN","PSODDPR5",119,0)
 .S STOP=0 F CHK=1:1:5 I TYP[(","_CHK_",")&(CHK<J) S STOP=1
"RTN","PSODDPR5",120,0)
 .Q:STOP
"RTN","PSODDPR5",121,0)
 .S CNT=CNT+1 F I=J:1:5 S TYP=I I $D(ZDGDG(SEV,TYP)) D S2(SEV,TYP,PSOVAG,CNT)
"RTN","PSODDPR5",122,0)
 K NSRT,J,F,ZDGDG,COUNT,CNT
"RTN","PSODDPR5",123,0)
 Q
"RTN","PSODDPR5",124,0)
 ;print order sort
"RTN","PSODDPR5",125,0)
S2(SEV,TYP,PSOVAG,CNT) ;
"RTN","PSODDPR5",126,0)
 N PSONAM,COUNT2 S (PSONAM)="",COUNT2=0
"RTN","PSODDPR5",127,0)
 F  S PSONAM=$O(ZDGDG(SEV,TYP,PSOVAG,PSONAM)) Q:PSONAM=""  S COUNT2=COUNT2+1 D
"RTN","PSODDPR5",128,0)
 .S:$G(ZZDGDG2(SEV,PSOVAG)) ZZDGDG2(SEV,PSOVAG)=ZZDGDG2(SEV,PSOVAG)+1 S:'$G(ZZDGDG2(SEV,PSOVAG)) ZZDGDG2(SEV,PSOVAG)=1
"RTN","PSODDPR5",129,0)
 .S ZZDGDG(SEV,CNT,TYP,PSOVAG,PSONAM)=ZDGDG(SEV,TYP,PSOVAG,PSONAM)
"RTN","PSODDPR5",130,0)
 .S ZZDGCK(SEV,CNT,TYP,PSOVAG,PSONAM)=ZDGDG(SEV,TYP,PSOVAG,PSONAM)
"RTN","PSODDPR5",131,0)
 Q
"RTN","PSODDPR5",132,0)
 ;
"RTN","PSODDPR5",133,0)
NSRT1 ;sort out dc'd drug therapies local and remote rxs
"RTN","PSODDPR5",134,0)
 S (SUB,CT)=0 K PSODCTH N RXN
"RTN","PSODDPR5",135,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D
"RTN","PSODDPR5",136,0)
 .S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^")
"RTN","PSODDPR5",137,0)
 .I $P(ON,";")="O",$P($G(^PSRX($P(ON,";",2),3)),"^",5) D  Q
"RTN","PSODDPR5",138,0)
 ..S RXN=$P(ON,";",2),X1=$P($G(^PSRX($P(ON,";",2),3)),"^",5),X2=(+$P(^PSRX($P(ON,";",2),0),"^",8)+7)
"RTN","PSODDPR5",139,0)
 ..D C^%DTC I X<DT S PSODCTH(ON)=1 K X,Y,X1,X2
"RTN","PSODDPR5",140,0)
 .I $P(ON,";")="R",$P($G(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2))),"^",4)["DISC" D
"RTN","PSODDPR5",141,0)
 ..S RXN=$P(ON,";",2) K X,Y,X1,X2
"RTN","PSODDPR5",142,0)
 ..S X=$P(^TMP($J,LIST,"OUT","REMOTE",RXN),"^",6) D ^%DT S X1=Y,X2=(+$P(^TMP($J,LIST,"OUT","REMOTE",RXN),"^",7)+7)
"RTN","PSODDPR5",143,0)
 ..D C^%DTC I X<DT S PSODCTH(ON)=1 K X,Y,X1,X2
"RTN","PSODDPR5",144,0)
 Q
"RTN","PSODDPR5",145,0)
 ;
"RTN","PSODDPR5",146,0)
RVAGEN ;va generic for remote drugs
"RTN","PSODDPR5",147,0)
 N PSOVIUD,PSONDF,PSOVAG,DIC
"RTN","PSODDPR5",148,0)
 S PSOVUID=$P(^TMP($J,"PSOPEPS","OUT","REMOTE",$P(ON,";",2)),"^",2) Q:'$G(PSOVUID)
"RTN","PSODDPR5",149,0)
 K PSORDIID S PSOVAGEN="" D GETIREF^XTID("50.68",".01",PSOVUID,"PSORDIID")
"RTN","PSODDPR5",150,0)
 S PSONDF=$O(PSORDIID(50.68,.01,"")) K PSORDIID
"RTN","PSODDPR5",151,0)
 I +PSONDF D DATA^PSN50P68(+PSONDF,,"PSONDF") S PSOVAG=$P($G(^TMP($J,"PSONDF",+PSONDF,.05)),U,2),ZDGDG(SV,2,PSOVAG,DRG)=ON_"^"_CT
"RTN","PSODDPR5",152,0)
 K ^TMP($J,"PSONDF")
"RTN","PSODDPR5",153,0)
 Q
"RTN","PSODDPR5",154,0)
 ;
"RTN","PSODDPR5",155,0)
DVAGEN ;va generic for non-va/pending meds
"RTN","PSODDPR5",156,0)
 S PSI=0 N PSID,PSODD,PSOVAG
"RTN","PSODDPR5",157,0)
 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["X":0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",158,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",159,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["U":0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",160,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["I":0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",161,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S('$L($P($G(^PSDRUG(PSI,2)),"^",3)):0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",162,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($L($P($G(^PSDRUG(PSI,2)),"^",3)):0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",163,0)
 Q:$G(PSID)']""
"RTN","PSODDPR5",164,0)
 S PSODD=$O(^PSDRUG("B",PSID,0)) D VAGEN^PSODDPR3(PSODD)
"RTN","PSODDPR5",165,0)
 Q:$G(PSOVAG)']""
"RTN","PSODDPR5",166,0)
 S ZOT=$S($P(ON,";")="O":1,$P(ON,";")="R":2,$P(ON,";")="P":3,1:4),ZDGDG(SV,ZOT,PSOVAG,DRG)=ON_"^"_CT,COUNT=COUNT+1
"RTN","PSODDPR5",167,0)
 K PSI,PSID,PSORDIT,PSODD,PSOVAG
"RTN","PSODDPR5",168,0)
 Q
"RTN","PSODDPR5",169,0)
 ;
"RTN","PSODDPR5",170,0)
INT ;
"RTN","PSODDPR5",171,0)
 I $G(PSOVORD),$P(PSOINTV,"^")=1 D  Q
"RTN","PSODDPR5",172,0)
 .K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODDPR5",173,0)
 .W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="Y" D ^DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR5",174,0)
 .K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODDPR5",175,0)
 .I 'Y S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR5",176,0)
 .S DA=PSONV,RXREC=DA,RX=$G(^PSRX(RXREC,0)),PSORX("INTERVENE")=1
"RTN","PSODDPR5",177,0)
 .D:'$D(PSODGCK) CRI^PSODGDG1
"RTN","PSODDPR5",178,0)
 .I $G(OLDDA) S DA=OLDDA K OLDDA
"RTN","PSODDPR5",179,0)
 Q:$G(PSODLQT)!($G(PSORX("DFLG")))
"RTN","PSODDPR5",180,0)
 I '$D(PSODGCK),$P(PSOINTV,"^") S IT=$P(PSOINTV,"^"),ON=$P(PSOINTV,"^",2) D ^PSODGDGP K DIR S IT=$P(PSOINTV,"^")
"RTN","PSODDPR5",181,0)
 Q
"RTN","PSODDPR5",182,0)
 ;
"RTN","PSODDPR5",183,0)
DGCK ;CK - Drug check option at patient profile
"RTN","PSODDPR5",184,0)
 I '$D(PSOSD) D FULL^VALM1 W !!,"Not enough drugs found in profile!",! K DIR S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR G DGCKQ
"RTN","PSODDPR5",185,0)
 S PSODGCK=1
"RTN","PSODDPR5",186,0)
 D FULL^VALM1
"RTN","PSODDPR5",187,0)
 D PSOCK^PSOUTL
"RTN","PSODDPR5",188,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." W ! D ^DIR K DIR W @IOF,!
"RTN","PSODDPR5",189,0)
 D SELECT
"RTN","PSODDPR5",190,0)
 I $G(PSONEW("DFLG"))=1!'$D(PSOSD) W ! G DGCKQ
"RTN","PSODDPR5",191,0)
 D SET^PSODRG
"RTN","PSODDPR5",192,0)
DGCKNP D POST^PSODRG
"RTN","PSODDPR5",193,0)
DGCKQ S VALMBCK="R"
"RTN","PSODDPR5",194,0)
 K PSODGCK,PSODGCKX,MON,PSONEW("DFLG"),PSORX("DFLG"),PSOIENID,PSOGCNPT,PSOGCNID,PSONDFID,DGCKDUPF
"RTN","PSODDPR5",195,0)
 Q
"RTN","PSODDPR5",196,0)
 ;
"RTN","PSODDPR5",197,0)
GCN(PSOIENID) ;Return 0 for not matched, 1 for matched with no GCNSEQNO, 1^1 for matched with a GCNSEQNO
"RTN","PSODDPR5",198,0)
 N PSONDFID,PSOGCNPT,PSOGCNID
"RTN","PSODDPR5",199,0)
 S PSONDFID=$P($G(^PSDRUG(PSOIENID,"ND")),"^"),PSOGCNPT=$P($G(^PSDRUG(PSOIENID,"ND")),"^",3)
"RTN","PSODDPR5",200,0)
 I 'PSONDFID!('PSOGCNPT) Q 0
"RTN","PSODDPR5",201,0)
 S PSOGCNID=$$PROD0^PSNAPIS(PSONDFID,PSOGCNPT)
"RTN","PSODDPR5",202,0)
 I $P(PSOGCNID,"^",7) Q PSOIENID_";"_PSONDFID_";"_$P(PSOGCNID,"^",7)
"RTN","PSODDPR5",203,0)
 Q PSOIENID_";"_PSONDFID
"RTN","PSODDPR5",204,0)
 ;
"RTN","PSODDPR5",205,0)
PKGFLG(PKF1) ;Return 0 for not in range of acceptable package flags, 1 for within range
"RTN","PSODDPR5",206,0)
 I $S(PKF1["O":1,1:0) Q 1
"RTN","PSODDPR5",207,0)
 I $S(PKF1["X":1,1:0) Q 1
"RTN","PSODDPR5",208,0)
 Q 0
"RTN","PSODDPR5",209,0)
 ;
"RTN","PSODDPR5",210,0)
SELECT ;
"RTN","PSODDPR5",211,0)
 N PSODGCKD S PSODGCKD=0 K:'$G(PSORXED) CLOZPAT
"RTN","PSODDPR5",212,0)
 K IT,DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW"),PSODRUG("BAD") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODDPR5",213,0)
 I $G(PSODRUG("IEN"))]"",'$D(PSODGCK) S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODDPR5",214,0)
 W !,"DRUG: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSODDPR5",215,0)
 I PSODGCK,X="",PSOSD<2 W !!,"Not enough drugs found in profile!",! K DIR S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODDPR5",216,0)
 S:X="" PSODGCKX=1
"RTN","PSODDPR5",217,0)
 I X="",$G(Y)]"" S:Y X=Y S:'X X=$G(PSODRUG("IEN")) S:X X="`"_X
"RTN","PSODDPR5",218,0)
 I X="",$D(PSOSD) S X=$O(PSOSD($O(PSOSD("")),"")),PSODGCKD=1
"RTN","PSODDPR5",219,0)
 I X="",'$D(PSOSD) D  Q
"RTN","PSODDPR5",220,0)
 .W !!,"Now Processing Enhanced Order Checks!  Please wait..." H 1
"RTN","PSODDPR5",221,0)
 .W !!,"No Order Check Warnings Found",! K DIR S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR
"RTN","PSODDPR5",222,0)
 I X?1."?" W !!,"Answer with DRUG NUMBER, or GENERIC NAME, or VA PRODUCT NAME, or",!,"NATIONAL DRUG CLASS, or SYNONYM" G SELECT
"RTN","PSODDPR5",223,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODDPR5",224,0)
 I X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODDPR5",225,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODDPR5",226,0)
 S DIC=50,DIC(0)="MZV",D="B^C^VAPN^VAC"
"RTN","PSODDPR5",227,0)
 I 'PSODGCKD S DIC=50,DIC(0)="EMQZVT",DIC("T")="",D="B^C^VAPN^VAC"
"RTN","PSODDPR5",228,0)
 S DIC("S")="I $S('$D(^PSDRUG(+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$$GCN^PSODDPR5(+Y),$$PKGFLG^PSODDPR5($P($G(^PSDRUG(+Y,2)),""^"",3)),$D(^PSDRUG(""ASP"",+$G(^(2)),+Y))"
"RTN","PSODDPR5",229,0)
 D MIX^DIC1 K DIC,PKF1,D
"RTN","PSODDPR5",230,0)
 I $$PSOSUPCK^PSOUTL(+Y) G SELECT
"RTN","PSODDPR5",231,0)
 S (DGCKSTA,DGCKDNM)=""
"RTN","PSODDPR5",232,0)
 I '$D(PSODGCKX),$D(PSOSD) F  S DGCKSTA=$O(PSOSD(DGCKSTA)) Q:DGCKSTA=""!$G(DGCKDUPF)  F  S DGCKDNM=$O(PSOSD(DGCKSTA,DGCKDNM)) Q:DGCKDNM=""!$G(DGCKDUPF)  D
"RTN","PSODDPR5",233,0)
 .I DGCKDNM=$G(Y(0,0)) D
"RTN","PSODDPR5",234,0)
 ..S DGCKDUPF=1 W !!,"Duplicate Drug in Patient profile, please select a different drug:",!
"RTN","PSODDPR5",235,0)
 ..K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSODDPR5",236,0)
 I $D(DGCKDUPF) K DGCKDUPF,PSODGCKX G SELECT
"RTN","PSODDPR5",237,0)
 I '$D(PSOSD) D  Q
"RTN","PSODDPR5",238,0)
 .W !!,"Now Processing Enhanced Order Checks!  Please wait..." H 1
"RTN","PSODDPR5",239,0)
 .W !!,"No Order Check Warnings Found",! K DIR S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR
"RTN","PSODDPR5",240,0)
 I $D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODDPR5",241,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODDPR5",242,0)
 I Y<0 G SELECT
"RTN","PSODDPR5",243,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODDPR5",244,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSODDPR5",245,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE^PSODRG
"RTN","PSODDPR5",246,0)
SELECTX K X,Y,DTOUT,DUOUT,PSONEW("OLD VAL"),PSODGCKD,DGCKDNM,DGCKSTA
"RTN","PSODDPR5",247,0)
 Q
"RTN","PSODDPR5",248,0)
 ;
"RTN","PSODDPR8")
0^13^B57269094
"RTN","PSODDPR8",1,0)
PSODDPR8 ;BIR/SAB - display enhanced order checks ;11 May 2010  9:06 AM
"RTN","PSODDPR8",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**390,372,416**;DEC 1997;Build 32
"RTN","PSODDPR8",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR8",4,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR8",5,0)
 ;External reference to ^PS(52.41 supported by DBIA 2844
"RTN","PSODDPR8",6,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR8",7,0)
 ;External reference to ENCHK^PSJORUT2 supported by DBIA 2376
"RTN","PSODDPR8",8,0)
 ;
"RTN","PSODDPR8",9,0)
DUP ;display drug interaction, clinical effects, and call to display monograph
"RTN","PSODDPR8",10,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR8",11,0)
 S ZZDGDGC=ZZDGDGC+1,ON=$P(ZZDGDG(SV,ZST,ZORS,ZVA,DRG),"^"),CT=$P(ZZDGDG(SV,ZST,ZORS,ZVA,DRG),"^",2),SEV=$G(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"SEV")) K ISTX
"RTN","PSODDPR8",12,0)
 S IT=$S(SEV="Critical":1,SEV="Significant":2,1:0),PDRG=$P(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT),"^",4),DRGI=$P(^(CT),"^",2)
"RTN","PSODDPR8",13,0)
 D HD() Q:$G(PSODLQT)
"RTN","PSODDPR8",14,0)
 I $G(ZHDR) W @IOF,PSONULN,!,"***"_SEV_"*** Drug Interaction with Prospective Drug:",!?20,PDRG_" and",! S ZHDR=0
"RTN","PSODDPR8",15,0)
 E  W !
"RTN","PSODDPR8",16,0)
 I $P(ON,";")["C" D ^PSODDPR7
"RTN","PSODDPR8",17,0)
 I $P(ON,";")="N" D ^PSODDPR3 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",18,0)
 I $P(ON,";")="P" D PEND D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",19,0)
 I $P(ON,";")="O" D DDRX D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",20,0)
 I $P(ON,";")="Z" D DDRX1 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",21,0)
 I $P(ON,";")="R" D RDI^PSODDPR3 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",22,0)
 I '+$G(PSOINTV),IT=2 S PSOINTV=2_"^"_ON
"RTN","PSODDPR8",23,0)
 I IT=1 S PSOINTV=1_"^"_ON
"RTN","PSODDPR8",24,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  I COUNT=ZZDGDG2(SV,ZVA) S COUNT=0 W ! D CL D HD():(($Y+5)'>IOSL)
"RTN","PSODDPR8",25,0)
 Q
"RTN","PSODDPR8",26,0)
 ;
"RTN","PSODDPR8",27,0)
PEND N DUPRX0,RFLS,ISSD,DNM,RXREC,Y
"RTN","PSODDPR8",28,0)
 D HD() Q:$G(PSODLQT)  S RXREC=$P(ON,";",2),DNM=$P(^PS(52.41,RXREC,0),"^",9)
"RTN","PSODDPR8",29,0)
 S DUPRX0=^PS(52.41,RXREC,0),RFLS=$P(DUPRX0,"^",11),ISSD=$P(DUPRX0,"^",6)
"RTN","PSODDPR8",30,0)
 I '$P(DUPRX0,"^",9) D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Pending Order: ",20)_$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR8",31,0)
 E  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Pending Drug: ",20)_$S($P(DUPRX0,"^",9):$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"),1:"No Dispense Drug Selected")
"RTN","PSODDPR8",32,0)
 D FSIG^PSOUTLA("P",RXREC,50)
"RTN","PSODDPR8",33,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("SIG: ",20) F I=0:0 S I=$O(FSIG(I)) Q:'I  W:'$G(PSODUPF) FSIG(I) I $O(FSIG(I)) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("      ",20)
"RTN","PSODDPR8",34,0)
 Q
"RTN","PSODDPR8",35,0)
 ;
"RTN","PSODDPR8",36,0)
DDRX ;
"RTN","PSODDPR8",37,0)
 S RXREC=$P(ON,";",2),DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),($P(RX0,"^",15),STATUS)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPR8",38,0)
 S J=RXREC D STAT^PSOFUNC K RX0,RX2,LSTFD S RXRECLOC=$G(RXREC),DRGNM=$P(^PSDRUG($P(DUPRX0,"^",6),0),"^")
"RTN","PSODDPR8",39,0)
 D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Local RX#: ",20)_$P(DUPRX0,"^"),!,$J("Drug: ",20)_DRGNM_" ("_ST_")"
"RTN","PSODDPR8",40,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,50) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODDPR8",41,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,50)
"RTN","PSODDPR8",42,0)
 D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("SIG: ",20),$G(BSIG(1))
"RTN","PSODDPR8",43,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("     ",20)_$G(BSIG(PSREV)) D HD()
"RTN","PSODDPR8",44,0)
 K BSIG,PSREV
"RTN","PSODDPR8",45,0)
 I $G(QTHER) D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("QTY: ",20)_$P(DUPRX0,"^",7),?44,$J("Days Supply: ",20)_$P(DUPRX0,"^",8)
"RTN","PSODDPR8",46,0)
 D PRSTAT^PSODDPRE(RXREC) S LSTFD=+^PSRX(RXREC,3) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Last Filled On: ",20)_$E(LSTFD,4,5)_"/"_$E(LSTFD,6,7)_"/"_$E(LSTFD,2,3)
"RTN","PSODDPR8",47,0)
 Q
"RTN","PSODDPR8",48,0)
 ;
"RTN","PSODDPR8",49,0)
DDRX1 ;
"RTN","PSODDPR8",50,0)
 W:SV="C" !,$J("Drug: ",21)_$S($D(PSSDIUTL):PDRG,1:DRG)
"RTN","PSODDPR8",51,0)
 W:SV="S" !,$J("Drug: ",24)_$S($D(PSSDIUTL):PDRG,1:DRG)
"RTN","PSODDPR8",52,0)
 Q
"RTN","PSODDPR8",53,0)
 ;
"RTN","PSODDPR8",54,0)
CL Q:$G(PSODLQT)  N CLI,LT,STX,I,BSIG S ZHDR=1 N CLECNT
"RTN","PSODDPR8",55,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",56,0)
 I IT=2 W !?2,"*** Refer to MONOGRAPH for SIGNIFICANT INTERACTION CLINICAL EFFECTS",!
"RTN","PSODDPR8",57,0)
 I IT=1 W ! D
"RTN","PSODDPR8",58,0)
 .S CLECNT=0 F  S CLECNT=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT)) Q:CLECNT=""  I $D(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT,"CLIN")) D
"RTN","PSODDPR8",59,0)
 ..S CLI="",CLI=$P($G(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT,"CLIN")),"CLINICAL EFFECTS: ",2)
"RTN","PSODDPR8",60,0)
 ..S LT=75,STX=CLI D FT Q:$G(PSODLQT)  F I=0:0 S I=$O(BSIG(I)) Q:'I  W ?2,BSIG(I),! D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",61,0)
 ..W !
"RTN","PSODDPR8",62,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  I $O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",0)) D MON^PSODDPR3 K X,Y
"RTN","PSODDPR8",63,0)
 D HD():(($Y+5)>IOSL)
"RTN","PSODDPR8",64,0)
 Q
"RTN","PSODDPR8",65,0)
 ;
"RTN","PSODDPR8",66,0)
FT ;format text
"RTN","PSODDPR8",67,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  K BSIG N BBSIG,BVAR,BVAR1,III,ZNT,NNN,BLIM S BBSIG=STX S (BVAR,BVAR1)="",III=1
"RTN","PSODDPR8",68,0)
 S ZNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S ZNT=ZNT+1 D  I $L(BVAR)>LT S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSODDPR8",69,0)
 .S BVAR1=$P(BBSIG," ",(ZNT)),BLIM=BVAR,BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1) D HD(6):(($Y+6)>IOSL)
"RTN","PSODDPR8",70,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSODDPR8",71,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSODDPR8",72,0)
 K LT D HD():(($Y+5)>IOSL)
"RTN","PSODDPR8",73,0)
 Q
"RTN","PSODDPR8",74,0)
 ;
"RTN","PSODDPR8",75,0)
HD(PSOLINES,OVRRID) ;
"RTN","PSODDPR8",76,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODDPR8",77,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)'>IOSL) Q
"RTN","PSODDPR8",78,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODDPR8",79,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSODDPR8",80,0)
 K PSOLINES,OVRRID
"RTN","PSODDPR8",81,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR8",82,0)
 W:'$G(PSODUPF) @IOF
"RTN","PSODDPR8",83,0)
 Q
"RTN","PSODDPR8",84,0)
 ;
"RTN","PSODDPR8",85,0)
 ;
"RTN","PSODDPR8",86,0)
CPRS(PSODFN,PSODSULS,PSODSUOI,PSODSUTY,PSODSUAG) ;
"RTN","PSODDPR8",87,0)
 ;Duplicate supply check for CPRS
"RTN","PSODDPR8",88,0)
 ;PSODFN - Patient
"RTN","PSODDPR8",89,0)
 ;PSODSULS - Literal
"RTN","PSODDPR8",90,0)
 ;PSODSUOI - Orderable Item array in format of PSODSUOI(n)=IEN (#50.7) ^ Orderable Name name
"RTN","PSODDPR8",91,0)
 ;PSODSUTY - P1;P2 where P1 is dialogue ("I" for IV, U for Unit Dose, "O" for Outpatient, "N" for Non-VA Meds (required)), P2=Pharm order# (optional)
"RTN","PSODDPR8",92,0)
 ;PSODSUAG - If 1, indicates TMP global from CPRS^PSODDPR4 call still exists, and add to it
"RTN","PSODDPR8",93,0)
 I '$G(PSODFN) Q
"RTN","PSODDPR8",94,0)
 I '$O(PSODSUOI(0)) Q
"RTN","PSODDPR8",95,0)
 I '$D(PSODSULS) Q
"RTN","PSODDPR8",96,0)
 N INDX,PSODSUDL,PSODSUPK,PSODSURG,PSODSUA1,PSODSUA2,PSODSUNM,PSODSUAP,PSODSUIN,PSODSUII,PSODSUNN,PSODSUDM,PSODSUDC,PSODSUST,PSODSUCC,PSODSULP,PSODSUBB,PSODSUB4
"RTN","PSODDPR8",97,0)
 S PSODSUDL=$P($G(PSODSUTY),";") I PSODSUDL'="I",PSODSUDL'="U",PSODSUDL'="O",PSODSUDL'="N" Q
"RTN","PSODDPR8",98,0)
 S PSODSUPK=$S(PSODSUDL="I":1,PSODSUDL="U":1,1:0),PSODSUCC=0
"RTN","PSODDPR8",99,0)
 S PSODSUA1="" F  S PSODSUA1=$O(PSODSUOI(PSODSUA1)) Q:PSODSUA1=""  D
"RTN","PSODDPR8",100,0)
 .S PSODSUA2="" F  S PSODSUA2=$O(^PSDRUG("ASP",PSODSUA1,PSODSUA2)) Q:PSODSUA2=""  D
"RTN","PSODDPR8",101,0)
 ..S PSODSUNM=$P($G(^PSDRUG(PSODSUA2,0)),"^") Q:PSODSUNM=""
"RTN","PSODDPR8",102,0)
 ..S PSODSUAP=$P($G(^PSDRUG(PSODSUA2,2)),"^",3)
"RTN","PSODDPR8",103,0)
 ..I PSODSUPK,PSODSUAP'["I",PSODSUAP'["U" Q
"RTN","PSODDPR8",104,0)
 ..I PSODSUDL="O",PSODSUAP'["O" Q
"RTN","PSODDPR8",105,0)
 ..I PSODSUDL="N",PSODSUAP'["X" Q
"RTN","PSODDPR8",106,0)
 ..I '$$SUP^PSSDSAPI(PSODSUA2) Q
"RTN","PSODDPR8",107,0)
 ..S PSODSUIN=$P($G(^PSDRUG(PSODSUA2,"I")),"^")
"RTN","PSODDPR8",108,0)
 ..I PSODSUIN,PSODSUIN<DT Q
"RTN","PSODDPR8",109,0)
 ..S PSODSURG(PSODSUA2)=PSODSUNM
"RTN","PSODDPR8",110,0)
 I $O(PSODSURG(""))="" Q
"RTN","PSODDPR8",111,0)
 S INDX=0 K ^TMP($J,"ORDERS") I '$G(PSODSUAG) K ^TMP($J,"DD"),^TMP($J,PSODSULS)
"RTN","PSODDPR8",112,0)
 D BLD^PSOORDRG,ENCHK^PSJORUT2(PSODFN,.INDX),NVA^PSOORDRG I '$D(^TMP($J,"ORDERS")) Q
"RTN","PSODDPR8",113,0)
 S PSODSUDC=0,PSODSUII=""
"RTN","PSODDPR8",114,0)
 I $G(PSODSUAG) D 
"RTN","PSODDPR8",115,0)
 .S PSODSULP="" F  S PSODSULP=$O(^TMP($J,"DD",PSODSULP)) Q:PSODSULP=""  S PSODSUDC=PSODSULP
"RTN","PSODDPR8",116,0)
 .S PSODSUBB="" F  S PSODSUBB=$O(^TMP($J,PSODSULS,"IN","PROSPECTIVE",PSODSUBB)) Q:PSODSUBB=""  I $G(PSODSUTY)=$P(PSODSUBB,";",1,2) S PSODSUB4=$P(PSODSUBB,";",4) I PSODSUB4>PSODSUCC S PSODSUCC=PSODSUB4
"RTN","PSODDPR8",117,0)
 F  S PSODSUII=$O(PSODSURG(PSODSUII)) Q:PSODSUII=""  D
"RTN","PSODDPR8",118,0)
 .S PSODSUNN=PSODSURG(PSODSUII),PSODSUDM=""
"RTN","PSODDPR8",119,0)
 .F  S PSODSUDM=$O(^TMP($J,"ORDERS",PSODSUDM)) Q:PSODSUDM=""  I PSODSUNN=$P(^TMP($J,"ORDERS",PSODSUDM),"^",3) D
"RTN","PSODDPR8",120,0)
 ..S PSODSUDC=PSODSUDC+1,^TMP($J,"DD",PSODSUDC,0)=PSODSUII_"^"_PSODSUNN_"^"_$P(^TMP($J,"ORDERS",PSODSUDM),"^",4)_"^"_$P(^TMP($J,"ORDERS",PSODSUDM),"^",5) D:'$D(PSODSUST(PSODSUII)) PNODE
"RTN","PSODDPR8",121,0)
 K ^TMP($J,"ORDERS")
"RTN","PSODDPR8",122,0)
 Q
"RTN","PSODDPR8",123,0)
 ;
"RTN","PSODDPR8",124,0)
PNODE ;Set prospective node for duplicate supply check for CPRS
"RTN","PSODDPR8",125,0)
 N PSOSPRID,PSOSPRQN,PSOSPRNF,PSOSPRN1,PSOSPRN2,PSOSPRXX
"RTN","PSODDPR8",126,0)
 S PSOSPRNF=$S($G(^PSDRUG(PSODSUII,"ND"))]"":+^PSDRUG(PSODSUII,"ND")_"A"_$P(^PSDRUG(PSODSUII,"ND"),"^",3),1:0)
"RTN","PSODDPR8",127,0)
 S PSOSPRID=$$GETVUID^XTID(50.68,,+$P($G(PSOSPRNF),"A",2)_",")
"RTN","PSODDPR8",128,0)
 S PSOSPRN1=$P($G(^PSDRUG(PSODSUII,"ND")),"^"),PSOSPRN2=$P($G(^PSDRUG(PSODSUII,"ND")),"^",3),PSOSPRXX=$$PROD0^PSNAPIS(PSOSPRN1,PSOSPRN2),PSOSPRQN=$P(PSOSPRXX,"^",7)
"RTN","PSODDPR8",129,0)
 S PSODSUCC=$G(PSODSUCC)+1,^TMP($J,PSODSULS,"IN","PROSPECTIVE",$P(PSODSUTY,";")_";"_$P(PSODSUTY,";",2)_";PROSPECTIVE;"_PSODSUCC)=PSOSPRQN_"^"_+PSOSPRID_"^"_PSODSUII_"^"_$G(PSODSUNN)
"RTN","PSODDPR8",130,0)
 S PSODSUST(PSODSUII)=""
"RTN","PSODDPR8",131,0)
 Q
"RTN","PSODDPRE")
0^14^B133385173
"RTN","PSODDPRE",1,0)
PSODDPRE ;BIR/SAB - Enhanced OP order checks ;09/20/06 3:38pm
"RTN","PSODDPRE",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,387,379,390,372,416**;DEC 1997;Build 32
"RTN","PSODDPRE",3,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODDPRE",4,0)
 ;External references to ^PSSDSAPM supported by DBIA 5570
"RTN","PSODDPRE",5,0)
 ;External references to ^PSSHRQ2 supported by DBIA 5369
"RTN","PSODDPRE",6,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPRE",7,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPRE",8,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSODDPRE",9,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPRE",10,0)
 ;External reference to $$SUP^PSSDSAPI supported by DBIA 5425
"RTN","PSODDPRE",11,0)
 ;
"RTN","PSODDPRE",12,0)
 W @IOF
"RTN","PSODDPRE",13,0)
 K IT,^TMP("PSORXDC",$J),^TMP("PSORXDD",$J),CLS,^TMP($J,"PSONVADD"),^TMP($J,"PSONRVADD"),^TMP($J,"PSORDI"),^TMP($J,"PSORMDD")
"RTN","PSODDPRE",14,0)
 N PSONULN,PSODLQT,ZZPSODRG S LIST="PSOPEPS",$P(PSONULN,"-",79)="-",(STA,DNM)=""
"RTN","PSODDPRE",15,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",16,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""!$G(PSORX("DFLG"))  I $P(PSOSD(STA,DNM),"^")'=$G(PSORENW("OIRXN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",17,0)
 .I STA="PENDING" D ^PSODDPR1 Q
"RTN","PSODDPRE",18,0)
 .I STA="ZNONVA" D NVA^PSODDPR1 Q
"RTN","PSODDPRE",19,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",20,0)
 ..I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16) D DUP I $G(PSOTECCK) S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",21,0)
 ..I '$P(PSOPAR,"^",2),$P(PSOPAR,"^",16),$G(PSOTECCK) D DUP Q
"RTN","PSODDPRE",22,0)
 ..I $P(PSOPAR,"^",2),$G(PSOTECCK) D  Q
"RTN","PSODDPRE",23,0)
 ...S DA=+PSOSD(STA,DNM),PSOCLC=DUZ
"RTN","PSODDPRE",24,0)
 ...S MSG="Discontinued During Reinstating Prescription Entry",ACT="Discontinued during Rx Reinstate."
"RTN","PSODDPRE",25,0)
 ...S ^TMP("PSORXDC",$J,DA,0)="52^"_DA_"^"_MSG_"^C^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D",^TMP("PSORXDD",$J)=DNM
"RTN","PSODDPRE",26,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q
"RTN","PSODDPRE",27,0)
 ..I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16) D DUP S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",28,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP
"RTN","PSODDPRE",29,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"PSODRDI")
"RTN","PSODDPRE",30,0)
 Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",31,0)
 M ZZPSODRG=PSODRUG
"RTN","PSODDPRE",32,0)
 S LIST="PSOPEPS" D REMOTE^PSOCPPRE
"RTN","PSODDPRE",33,0)
 M PSODRUG=ZZPSODRG
"RTN","PSODDPRE",34,0)
 Q
"RTN","PSODDPRE",35,0)
OBX  ;process enhanced order checks
"RTN","PSODDPRE",36,0)
 K ZDGDG,ZTHER,IT
"RTN","PSODDPRE",37,0)
 S LIST="PSOPEPS" K PSODLQT,DTOUT,DUOUT,DIRUT,PSODOSD
"RTN","PSODDPRE",38,0)
 I $P(^TMP($J,LIST,"OUT",0),"^")=-1 G EXIT
"RTN","PSODDPRE",39,0)
 W !,"Now Processing Enhanced Order Checks!  Please wait...",! H 1
"RTN","PSODDPRE",40,0)
 D FDB S PDRG=PSODRUG("IEN"),DO=0 D IN^PSSHRQ2(LIST)    ;call 2 fdb
"RTN","PSODDPRE",41,0)
 ;
"RTN","PSODDPRE",42,0)
 K DIR
"RTN","PSODDPRE",43,0)
 I $P(^TMP($J,LIST,"OUT",0),"^")=-1 D DATACK G EXIT
"RTN","PSODDPRE",44,0)
 I '$D(PSODGCK) D ^PSODDPR2 ;if order checks returned
"RTN","PSODDPRE",45,0)
 I $D(PSODGCK) D PROC^PSSDIUTL Q  ;if running DX option
"RTN","PSODDPRE",46,0)
 I '$G(PSOCOPY)&('$G(PSORENW)),$G(PSOQUIT) D
"RTN","PSODDPRE",47,0)
 .I $G(PSOREINS) Q:$G(PSODLQT)  S PSORX("DFLG")=1
"RTN","PSODDPRE",48,0)
 ;
"RTN","PSODDPRE",49,0)
EXIT ;
"RTN","PSODDPRE",50,0)
 D ^PSOBUILD
"RTN","PSODDPRE",51,0)
 K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSODDPRE",52,0)
 K DO,PDRG,IT,PSODLQT
"RTN","PSODDPRE",53,0)
 K ^TMP($J,LIST,"IN","PING"),^TMP($J,LIST,"OUT","EXCEPTIONS"),^TMP($J,"PSOPEPS"),^TMP($J,"PSORDI")
"RTN","PSODDPRE",54,0)
 Q
"RTN","PSODDPRE",55,0)
DUP S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"Duplicate Drug in Local Rx:",!
"RTN","PSODDPRE",56,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Drug"
"RTN","PSODDPRE",57,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPRE",58,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODDPRE",59,0)
 S DA=RXREC
"RTN","PSODDPRE",60,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",61,0)
 W !,$J("Rx: ",24)_$P(^PSRX(+PSOSD(STA,DNM),0),"^")
"RTN","PSODDPRE",62,0)
 W !,$J("Drug: ",24)_$P(DNM,"^")
"RTN","PSODDPRE",63,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODDPRE",64,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSODDPRE",65,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSODDPRE",66,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSODDPRE",67,0)
 K BSIG,PSREV
"RTN","PSODDPRE",68,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",69,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?42,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSODDPRE",70,0)
 S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSODDPRE",71,0)
 W !,$J("Provider: ",24)_PHYS,?42,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSODDPRE",72,0)
 W !,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2
"RTN","PSODDPRE",73,0)
 S LSTFL=+^PSRX(RXREC,3) W ?42,$J("Last filled: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3)
"RTN","PSODDPRE",74,0)
 D PRSTAT(RXREC)
"RTN","PSODDPRE",75,0)
 W !?42,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSODDPRE",76,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODDPRE",77,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 D  Q
"RTN","PSODDPRE",78,0)
 .K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC W @IOF
"RTN","PSODDPRE",79,0)
 .S ^TMP("PSORXDD",$J,RXREC,0)=1
"RTN","PSODDPRE",80,0)
 I '$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) D  Q
"RTN","PSODDPRE",81,0)
 .S PSORX("DFLG")=1 K RXRECLOC,DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue"
"RTN","PSODDPRE",82,0)
 .D ^DIR K DIR
"RTN","PSODDPRE",83,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) D  Q
"RTN","PSODDPRE",84,0)
 .W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",!
"RTN","PSODDPRE",85,0)
 .K DUP,DIR,RXRECLOC S PSORX("DFLG")=1 S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODDPRE",86,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",87,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODDPRE",88,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECLOC,0)),"^"),!
"RTN","PSODDPRE",89,0)
 I $D(PSODGCK) K RXRECLOC,DUP,CLS,PSONOOR Q
"RTN","PSODDPRE",90,0)
 K PSOMSG S DIR("A")=$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" "_$P(DNM,"^")_" Y/N",DIR(0)="Y"
"RTN","PSODDPRE",91,0)
 S DIR("?")="Enter Y to "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODDPRE",92,0)
 D ^DIR K DIR S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODDPRE",93,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODDPRE",94,0)
 I 'Y W !,$C(7)," -Prescription was not "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODDPRE",95,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP D ULRX K RXRECLOC
"RTN","PSODDPRE",96,0)
 .K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODDPRE",97,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSODDPRE",98,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C")
"RTN","PSODDPRE",99,0)
 W !! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPRE",100,0)
 S X="Rx #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" "_DNM_" will be discontinued after"_$S('$G(PSOTECCK):" the acceptance of the new order.",1:" reinstating the order.") D ^DIWP
"RTN","PSODDPRE",101,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSODDPRE",102,0)
 K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF W !
"RTN","PSODDPRE",103,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D",^TMP("PSORXDD",$J)=DNM H 2
"RTN","PSODDPRE",104,0)
 K RXRECLOC,DUP,CLS,PSONOOR
"RTN","PSODDPRE",105,0)
 Q
"RTN","PSODDPRE",106,0)
FDB ;build drug check input
"RTN","PSODDPRE",107,0)
 N ID,ORTYP,PSOI,ORN S DFN=PSODFN,CT=0
"RTN","PSODDPRE",108,0)
 S ID=+$$GETVUID^XTID(50.68,,+$P(PSODRUG("NDF"),"A",2)_",")
"RTN","PSODDPRE",109,0)
 S P1=$P(PSODRUG("NDF"),"A"),P2=$P(PSODRUG("NDF"),"A",2),X=$$PROD0^PSNAPIS(P1,P2),SEQN=+$P(X,"^",7)
"RTN","PSODDPRE",110,0)
 I 'SEQN K ^TMP($J,LIST,"OUT","EXCEPTIONS"),^TMP($J,LIST,"IN")
"RTN","PSODDPRE",111,0)
 S ^TMP($J,LIST,"IN","PROSPECTIVE","Z;1;PROSPECTIVE;1")=SEQN_"^"_ID_"^"_PSODRUG("IEN")_"^"_$P(^PSDRUG(PSODRUG("IEN"),0),"^")
"RTN","PSODDPRE",112,0)
 K:$D(PSODGCK)&$D(PSODGCKX) ^TMP($J,LIST,"IN","PROSPECTIVE","Z;1;PROSPECTIVE;1"),PSODGCKX
"RTN","PSODDPRE",113,0)
 S ^TMP($J,LIST,"IN","IEN")=PSODFN,^TMP($J,LIST,"IN","DRUGDRUG")="",^TMP($J,LIST,"IN","THERAPY")=""
"RTN","PSODDPRE",114,0)
 K ID,P1,P2 N ODRG,TU S (STA,DNM)="" I '$G(PSOCOPY),'$G(SEQN) K SEQN Q
"RTN","PSODDPRE",115,0)
 ;build profile drug order checks
"RTN","PSODDPRE",116,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""   D  ;I $P(PSOSD(STA,DNM),"^")'=$G(PSORENW("OIRXN")) S CT=CT+1 D
"RTN","PSODDPRE",117,0)
 .Q:$P(PSOSD(STA,DNM),"^")=$G(PSORENW("OIRXN"))&('$G(PSOCOPY))
"RTN","PSODDPRE",118,0)
 .S CT=CT+1
"RTN","PSODDPRE",119,0)
 .I STA="PENDING" N DDRG D
"RTN","PSODDPRE",120,0)
 ..Q:$G(^TMP("PSORXDC",$J,$P(PSOSD(STA,DNM),"^",10),0))]""
"RTN","PSODDPRE",121,0)
 ..Q:$G(PSODRUG("IEN"))=$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",9)
"RTN","PSODDPRE",122,0)
 ..Q:$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",3)="RF"
"RTN","PSODDPRE",123,0)
 ..Q:$G(^TMP("PSORXPO",$J,$P(PSOSD(STA,DNM),"^",10),0))
"RTN","PSODDPRE",124,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ORN=$P(^PS(52.41,RXREC,0),"^"),ODRG=$P(^(0),"^",9),ORTYP="P"
"RTN","PSODDPRE",125,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPRE",126,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q 
"RTN","PSODDPRE",127,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") D ID
"RTN","PSODDPRE",128,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(52.41,RXREC,0),"^",8) D
"RTN","PSODDPRE",129,0)
 ...S PDNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPRE",130,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"O") I '$P(DDRG,";") D OIX Q
"RTN","PSODDPRE",131,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",132,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPRE",133,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",134,0)
 ...D ID1
"RTN","PSODDPRE",135,0)
 .I STA="ZNONVA" D  Q
"RTN","PSODDPRE",136,0)
 ..Q:$G(^TMP($J,"PSONVADD",$P(PSOSD(STA,DNM),"^",10),0))]""
"RTN","PSODDPRE",137,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ODRG=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^",2),ORN=$P(^(0),"^",8),ORTYP="N"
"RTN","PSODDPRE",138,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPRE",139,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",140,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") D ID
"RTN","PSODDPRE",141,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^") D
"RTN","PSODDPRE",142,0)
 ...S PDNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPRE",143,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"X") I '$P(DDRG,";") D:'$$NVATST(PSOI) OIX Q
"RTN","PSODDPRE",144,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",145,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPRE",146,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",147,0)
 ...D ID1
"RTN","PSODDPRE",148,0)
 .I $P($G(^PSRX(+PSOSD(STA,DNM),0)),"^",6) D
"RTN","PSODDPRE",149,0)
 ..Q:$G(^TMP("PSORXDC",$J,$P(PSOSD(STA,DNM),"^"),0))]""
"RTN","PSODDPRE",150,0)
 ..Q:$G(^TMP("PSORXBO",$J,$P(PSOSD(STA,DNM),"^"),0))
"RTN","PSODDPRE",151,0)
 ..Q:$G(^TMP("PSORXDD",$J,$P(PSOSD(STA,DNM),"^"),0))
"RTN","PSODDPRE",152,0)
 ..;I $P(PSOSD(STA,DNM),"^",2)>5,$P(PSOSD(STA,DNM),"^",2)'=16 Q
"RTN","PSODDPRE",153,0)
 ..S RXREC=+PSOSD(STA,DNM),ODRG=$P(^PSRX(RXREC,0),"^",6),ORN=$P($G(^("OR1")),"^",2),ORTYP="O"
"RTN","PSODDPRE",154,0)
 ..I ODRG D
"RTN","PSODDPRE",155,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",156,0)
 ...I STA="DISCONTINUED" Q:$$DUPTHER(RXREC)
"RTN","PSODDPRE",157,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") D ID
"RTN","PSODDPRE",158,0)
 D IMO^PSODDPR7(PSODFN)
"RTN","PSODDPRE",159,0)
 K RXREC,ID,STA,DNM,PSOI,ORN,ODRG,ORTYP,CT,PDNM,TU,DDRG
"RTN","PSODDPRE",160,0)
 Q
"RTN","PSODDPRE",161,0)
 ;
"RTN","PSODDPRE",162,0)
ID N ID,P1,P2,PSODGCKP S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",163,0)
 S P1=$P($G(^PSDRUG(ODRG,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=$P(X,"^",7)
"RTN","PSODDPRE",164,0)
ID1 S PSODGCKP=$S($G(PSODGCK):"PROSPECTIVE",1:"PROFILE")
"RTN","PSODDPRE",165,0)
 S ^TMP($J,LIST,"IN",PSODGCKP,$S($D(PSODGCK):"Z",1:ORTYP)_";"_RXREC_";"_PSODGCKP_";"_CT)=SEQN_"^"_ID_"^"_ODRG_"^"_PDNM_"^"_ORN_"^O" K ID
"RTN","PSODDPRE",166,0)
 Q
"RTN","PSODDPRE",167,0)
DUPTHER(RXREC) ;screen out discontinued/duplicate therapy Rx's greater than business rule calculation (cancel date + days supply +7 days)
"RTN","PSODDPRE",168,0)
 ;Note: If the dup allowance is 1 you have to have at least 3 eligible drug orders (or 2 matches) to produce the dupl. therapy warning
"RTN","PSODDPRE",169,0)
 ;Business rule for expired orders is (expiration date+120 days) which is the length of time expired order currently stay on med profile.  No changes for this.
"RTN","PSODDPRE",170,0)
 N X,Y,X1,X2 S X1=$P($G(^PSRX(RXREC,3)),"^",5),X2=(+$P(^PSRX(RXREC,0),"^",8)+7) D C^%DTC I DT>X Q 1
"RTN","PSODDPRE",171,0)
 Q 0
"RTN","PSODDPRE",172,0)
OIX S ^TMP($J,LIST,"IN","EXCEPTIONS","OI",PDNM)=1_"^"_ORTYP_";"_RXREC_";PROFILE;"_CT
"RTN","PSODDPRE",173,0)
 Q
"RTN","PSODDPRE",174,0)
ULRX ;
"RTN","PSODDPRE",175,0)
 I '$G(RXRECLOC) Q
"RTN","PSODDPRE",176,0)
 D PSOUL^PSSLOCK(RXRECLOC)
"RTN","PSODDPRE",177,0)
 Q
"RTN","PSODDPRE",178,0)
 ;
"RTN","PSODDPRE",179,0)
PRSTAT(DA) ;Displays the prescription's status
"RTN","PSODDPRE",180,0)
 N PSOTRANS,PSOREL,PSOCMOP,RXPSTA,PSOX,RFLZRO,PSOLRD,PSORTS,CMOP
"RTN","PSODDPRE",181,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)  S RXPSTA="Processing Status: ",PSOLRD=$P($G(^PSRX(RXREC,2)),"^",13)
"RTN","PSODDPRE",182,0)
 D ^PSOCMOPA I $G(PSOCMOP)]"" D  K CMOP,PSOTRANS,PSOREL
"RTN","PSODDPRE",183,0)
 .S PSOTRANS=$E($P(PSOCMOP,"^",2),4,5)_"/"_$E($P(PSOCMOP,"^",2),6,7)_"/"_$E($P(PSOCMOP,"^",2),2,3)
"RTN","PSODDPRE",184,0)
 .S PSOREL=$S(CMOP("L")=0:$P($G(^PSRX(DA,2)),"^",13),1:$P(^PSRX(DA,1,CMOP("L"),0),"^",18))
"RTN","PSODDPRE",185,0)
 .S PSOREL=$E(PSOREL,4,5)_"/"_$E(PSOREL,6,7)_"/"_$E(PSOREL,2,3)_"@"_$E($P(PSOREL,".",2),1,4)
"RTN","PSODDPRE",186,0)
 .I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSODDPRE",187,0)
 .I $P($G(^PSRX(RXREC,"STA")),"^")=0 W:$$TRANCMOP^PSOUTL(RXREC) ?5,IORVON_IOINHI
"RTN","PSODDPRE",188,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J(RXPSTA,24)_$S($P(PSOCMOP,"^")=0!($P(PSOCMOP,"^")=2):"Transmitted to CMOP on "_PSOTRANS,$P(PSOCMOP,"^")=1:"Released by CMOP on "_PSOREL,1:"Not Dispensed"),IOINORM_IORVOFF
"RTN","PSODDPRE",189,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",190,0)
 I $G(PSOCMOP)']"" D
"RTN","PSODDPRE",191,0)
 .F PSOX=0:0 S PSOX=$O(^PSRX(RXREC,1,PSOX)) Q:'PSOX  D
"RTN","PSODDPRE",192,0)
 ..S RFLZRO=$G(^PSRX(RXREC,1,PSOX,0))
"RTN","PSODDPRE",193,0)
 ..S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R",PSORTS=$P(RFLZRO,"^",16)
"RTN","PSODDPRE",194,0)
 .I '$O(^PSRX(RXREC,1,0)),$P(^PSRX(RXREC,2),"^",15) S PSOLRD=PSOLRD_"^R",PSORTS=$P(^PSRX(RXREC,2),"^",15)
"RTN","PSODDPRE",195,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J(RXPSTA,24)
"RTN","PSODDPRE",196,0)
 .I +$G(PSORTS) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) "Returned to stock on "_$$FMTE^XLFDT(PSORTS,2) Q
"RTN","PSODDPRE",197,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) $S(PSOLRD="":"Not released locally",1:"Released locally on "_$$FMTE^XLFDT($P(PSOLRD,"^"),2)_" "_$P(PSOLRD,"^",2))_$S($P(^PSRX(RXREC,0),"^",11)="W":" (Window)",1:" (Mail)")
"RTN","PSODDPRE",198,0)
 Q
"RTN","PSODDPRE",199,0)
 ;
"RTN","PSODDPRE",200,0)
DATACK ;check FDB returned data to determine whether to continue processing.
"RTN","PSODDPRE",201,0)
 S DIR(0)="E",DIR("A",1)="No Enhanced Order Checks can be performed."
"RTN","PSODDPRE",202,0)
 S DIR("A",2)="   Reason(s): "_$P($G(^TMP($J,LIST,"OUT",0)),"^",2)
"RTN","PSODDPRE",203,0)
 S DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue"
"RTN","PSODDPRE",204,0)
 W ! D ^DIR K DIRUT,DUOUT,DIR,X,Y  W @IOF ;I $P(^TMP($J,LIST,"OUT",0),"^")=1
"RTN","PSODDPRE",205,0)
 Q
"RTN","PSODDPRE",206,0)
 ;
"RTN","PSODDPRE",207,0)
NVATST(PSONVTOI) ; Look for any active Non-VA Dispense Drugs not marked as a supply item
"RTN","PSODDPRE",208,0)
 N PSONVT1,PSONVTFL,PSONVTIN
"RTN","PSODDPRE",209,0)
 S PSONVTFL=1
"RTN","PSODDPRE",210,0)
 F PSONVT1=0:0 S PSONVT1=$O(^PSDRUG("ASP",PSONVTOI,PSONVT1)) Q:'PSONVT1!('PSONVTFL)  D
"RTN","PSODDPRE",211,0)
 .I $P($G(^PSDRUG(PSONVT1,2)),"^",3)'["X" Q
"RTN","PSODDPRE",212,0)
 .S PSONVTIN=$P($G(^PSDRUG(PSONVT1,"I")),"^") I PSONVTIN,PSONVTIN<DT Q
"RTN","PSODDPRE",213,0)
 .S PSONVTFL=$$SUP^PSSDSAPI(PSONVT1)
"RTN","PSODDPRE",214,0)
 Q PSONVTFL
"RTN","PSODGDGP")
0^3^B67660976
"RTN","PSODGDGP",1,0)
PSODGDGP ;BIR/SAB - drug drug interaction checker ;4/14/93
"RTN","PSODGDGP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,387,379,391,372,416**;DEC 1997;Build 32
"RTN","PSODGDGP",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODGDGP",4,0)
 ;External references PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODGDGP",5,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODGDGP",6,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSODGDGP",7,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSODGDGP",8,0)
 N DRG,PSOREMOT S (CRIT,DRG,LSI,DGI,DGS,SER,SERS,STA,PSOICT)="",PSOREMOT=0
"RTN","PSODGDGP",9,0)
 D BLD Q:+$G(PSORX("DFLG"))!($G(PSODLQT))
"RTN","PSODGDGP",10,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(DGI)]"" S:$G(CRIT) PSONEW("STATUS")=4 W $C(7),!,"DRUG INTERACTON WITH RX #s: "_LSI,!
"RTN","PSODGDGP",11,0)
 I '$D(^XUSEC("PSORPH",DUZ)),(","_$G(^TMP("PSOSER",$J,0))_",")[(",1,") S:$D(^TMP("PSODGI",$J,0)) PSONEW("STATUS")=4
"RTN","PSODGDGP",12,0)
 K DRG,NDF,PSOICT,IT,LSI
"RTN","PSODGDGP",13,0)
 I +$G(PSORX("DFLG")) Q
"RTN","PSODGDGP",14,0)
 I +$G(PSODRUG("NDF"))'=0 D
"RTN","PSODGDGP",15,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODGDGP",16,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODGDGP",17,0)
 .;D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSODGDGP",18,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",!! S PSOREMOT=1 D HD^PSODDPR2():(($Y+5)>IOSL) Q
"RTN","PSODGDGP",19,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSODGDGP",20,0)
 .K ^TMP($J,"DI"_PSODFN),^TMP($J,"DI")
"RTN","PSODGDGP",21,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSOREMOT)!($G(DGI)]"") K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue..." D ^DIR K DIR,DUOUT,DTOUT
"RTN","PSODGDGP",22,0)
 Q
"RTN","PSODGDGP",23,0)
TECH ;add tech entry to RX VERIFY file (#52.4); called from new order/copy/renew
"RTN","PSODGDGP",24,0)
 I $$DS^PSSDSAPI,+$G(^TMP("PSODOSF",$J,0)) S ^PS(52.4,PSOXIRXN,1)=^TMP("PSODOSF",$J,0)
"RTN","PSODGDGP",25,0)
 Q:'$D(^TMP("PSODGI",$J,0))
"RTN","PSODGDGP",26,0)
 S $P(^PSRX(PSOXIRXN,"DRI"),"^")=^TMP("PSOSER",$J,0)_"^"_^TMP("PSODGI",$J,0)
"RTN","PSODGDGP",27,0)
 S $P(^PS(52.4,PSOXIRXN,0),"^",8)=1,$P(^PS(52.4,PSOXIRXN,0),"^",9)=^TMP("PSOSER",$J,0),$P(^PS(52.4,PSOXIRXN,0),"^",10)=^TMP("PSODGI",$J,0)
"RTN","PSODGDGP",28,0)
 Q
"RTN","PSODGDGP",29,0)
TECH2(PSOXIRXN,PSODFN,DUZ,PSOX) ;
"RTN","PSODGDGP",30,0)
 I $D(PSOX("NOPSDRPH")) G T3
"RTN","PSODGDGP",31,0)
 Q:$D(^XUSEC("PSORPH",DUZ))
"RTN","PSODGDGP",32,0)
T3 ;
"RTN","PSODGDGP",33,0)
 ; The only time PSOX("NOPSDRPH) key is defined equal to 1 is for controlled substances and the user doesn't hold
"RTN","PSODGDGP",34,0)
 ; the PSDRPH key.
"RTN","PSODGDGP",35,0)
 N PSODWARN,PSOSIGNIF,PSOINTSV,PSOTLBL S (PSODWARN,PSOSIGNIF,PSOTLBL,PSOINTSV)=0
"RTN","PSODGDGP",36,0)
 S:$$DS^PSSDSAPI&(+$G(^TMP("PSODOSF",$J,0))) PSODWARN=1 ;dosing drug warning
"RTN","PSODGDGP",37,0)
 I $D(^TMP("PSOSER",$J,0)) S PSOINTSV=$G(^TMP("PSOSER",$J,0)) S:PSOINTSV[1 PSODWARN=1 S:PSOINTSV[2 PSOSIGNIF=1 ;critical and significant drug interaction drug warnings
"RTN","PSODGDGP",38,0)
 ;
"RTN","PSODGDGP",39,0)
 ; When verification is OFF and there's a significant drug interaction or the user doesn't hold the PSDRPH key,
"RTN","PSODGDGP",40,0)
 ; set file 52 "DRI" node for the significant drug interactions but don't quit.  When the verification switch is off, the bottle label and the tech warning 
"RTN","PSODGDGP",41,0)
 ; a tech warning label and the bottle label must print when significant interactions are present.  However if the
"RTN","PSODGDGP",42,0)
 ; the PSOX("NOPSDRPH") variable is defined, no labels are allowed to print and processing should continue on.
"RTN","PSODGDGP",43,0)
 ;
"RTN","PSODGDGP",44,0)
 I '$G(PSORX("VERIFY")),'PSODWARN&($G(PSOSIGNIF)) D  Q:'$D(PSOX("NOPSDRPH")) PSOTLBL  ;don't set 52.4 when verification is off and only significiant interaction
"RTN","PSODGDGP",45,0)
 .S $P(^PSRX(PSOXIRXN,"DRI"),"^")=^TMP("PSOSER",$J,0)
"RTN","PSODGDGP",46,0)
 .S $P(^PSRX(PSOXIRXN,"DRI"),"^",2)=^TMP("PSODGI",$J,0)
"RTN","PSODGDGP",47,0)
 .I '$P(PSOPAR,"^",2) S PSOTLBL=1
"RTN","PSODGDGP",48,0)
 ;
"RTN","PSODGDGP",49,0)
 ; If verification is ON, set file 52.4.  If there are critical drug interactions or dose warnings, the fields to 
"RTN","PSODGDGP",50,0)
 ; indicate these must be set and a tech warning label should print.  If the PSOX("NOPSDRPH") variable is present,
"RTN","PSODGDGP",51,0)
 ; file 52.4 should be set (along with any drug interaction and dose warning data) and the technician warning label
"RTN","PSODGDGP",52,0)
 ; should print (PSOTLBL=2)
"RTN","PSODGDGP",53,0)
 ;
"RTN","PSODGDGP",54,0)
 I ($D(PSOX("NOPSDRPH")))!($G(PSODWARN))!($G(PSORX("VERIFY"))) D
"RTN","PSODGDGP",55,0)
 .K DIC,DLAYGO,DINUM,DIADD,X,DD,DO S DIC="^PS(52.4,",DLAYGO=52.4,DINUM=PSOXIRXN,DIC(0)="ML",X=PSOXIRXN
"RTN","PSODGDGP",56,0)
 .D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM S ^PS(52.4,PSOXIRXN,0)=PSOXIRXN_"^"_PSODFN_"^"_DUZ_"^"_"^"_$E(PSOX("LOGIN DATE"),1,7)_"^"_PSOXIRXN_"^"_PSOX("STOP DATE")
"RTN","PSODGDGP",57,0)
 .I '$D(PSOX("NOPSDRPH")) Q:PSOINTSV'[1&('PSODWARN)
"RTN","PSODGDGP",58,0)
 .D TECH
"RTN","PSODGDGP",59,0)
 ;
"RTN","PSODGDGP",60,0)
 I $D(^PS(52.4,PSOXIRXN)) K DIK,DA S DIK="^PS(52.4,",DA=PSOX("IRXN") D IX^DIK K DIK,DA
"RTN","PSODGDGP",61,0)
 I '$G(PSORX("VERIFY")) S:(PSOX("STATUS")=4!$G(PSODWARN)) PSOTLBL=1 ;verification off, dose warn or drug interaction, print technician warning label
"RTN","PSODGDGP",62,0)
 I $G(PSORX("VERIFY")) S PSOTLBL=$S('$G(PSODWARN)&('$G(PSOSIGNIF)):2,'$G(PSODWARN)&($G(PSOSIGNIF)):2,$G(PSODWARN):1,1:0)
"RTN","PSODGDGP",63,0)
 ;
"RTN","PSODGDGP",64,0)
 ; If the PSOX("NOPSDRPH") variable is present and regardless of the verification switch, labels cannot be 
"RTN","PSODGDGP",65,0)
 ; printed (i.e. PSOTLBL=2).  A technician warning label will be printed if drug interactions or dose warnings are 
"RTN","PSODGDGP",66,0)
 ; present.
"RTN","PSODGDGP",67,0)
 I $D(PSOX("NOPSDRPH")) S PSOTLBL=2
"RTN","PSODGDGP",68,0)
 Q PSOTLBL
"RTN","PSODGDGP",69,0)
 ;
"RTN","PSODGDGP",70,0)
BLD I $D(^XUSEC("PSORPH",DUZ)) S PSORX("PHARM")=DUZ D PHARM Q
"RTN","PSODGDGP",71,0)
BLD2 ;
"RTN","PSODGDGP",72,0)
 Q:$P(ON,";")'="O"
"RTN","PSODGDGP",73,0)
 S LSI=$P(^PSRX($P(ON,";",2),0),"^")_"/"_$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")_","_LSI
"RTN","PSODGDGP",74,0)
 I '$D(^TMP("PSODGI",$J,0)) D
"RTN","PSODGDGP",75,0)
 . S ^TMP("PSODGI",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGI",$J,0)),^TMP("PSOSER",$J,0)=IT_","_$G(^TMP("PSOSER",$J,0))
"RTN","PSODGDGP",76,0)
 I ^TMP("PSODGI",$J,0)'[$P(ON,";",2) D
"RTN","PSODGDGP",77,0)
 .S ^TMP("PSODGI",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGI",$J,0))
"RTN","PSODGDGP",78,0)
 .S ^TMP("PSOSER",$J,0)=IT_","_$G(^TMP("PSOSER",$J,0))
"RTN","PSODGDGP",79,0)
 I IT=2 S ^TMP("PSOSERS",$J,0)=IT_","_$G(^TMP("PSOSERS",$J,0)),^TMP("PSODGS",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGS",$J,0))
"RTN","PSODGDGP",80,0)
 S:IT=1 ^TMP("PSOTDD",$J,1)=1
"RTN","PSODGDGP",81,0)
 Q
"RTN","PSODGDGP",82,0)
PHARM ;pharmacist verification of drug interaction
"RTN","PSODGDGP",83,0)
 S PSODGRLX=$P(ON,";",2)
"RTN","PSODGDGP",84,0)
 S DIR("?",1)="Answer 'YES' if you DO want to "_$S(IT=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGP",85,0)
 S DIR("?")="       'NO' if you DON'T want to "_$S(IT=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGP",86,0)
 W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to "_$S(IT=1:"Continue? ",1:"Intervene? "),DIR("B")="Y" D ^DIR
"RTN","PSODGDGP",87,0)
 I 'Y,IT=1 S PSODLQT=1,DGI="" S:'$G(PSORXED)&('$G(PSOREINS)) PSORX("DFLG")=1 S:$G(PSORXED)!($G(PSOREINS)) PSOQUIT=1 K DIR,DTOUT,DIRUT,DIROUT,DUOUT Q
"RTN","PSODGDGP",88,0)
 I Y,IT=1 S PSORX("INTERVENE")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT G CRI Q
"RTN","PSODGDGP",89,0)
 I 'Y,IT=2 S:$G(DIRUT) (PSODLQT,PSOQUIT)=1 K DIR,DTOUT,DIRUT,DIROUT,DUOUT D ULRX Q
"RTN","PSODGDGP",90,0)
 I Y,IT=2 S PSORX("INTERVENE")=2,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGP",91,0)
 D ULRX
"RTN","PSODGDGP",92,0)
 Q
"RTN","PSODGDGP",93,0)
CRI ;process new drug interactions entered by pharmacist
"RTN","PSODGDGP",94,0)
 K DIR ;G:$P(PSOSD(STA,DRG),"^",9) CRITN 
"RTN","PSODGDGP",95,0)
 S DIR("A",1)="",DIR("A",2)="Do you want to Process medication",DIR("A")=PSODRUG("NAME")_": ",DIR(0)="SA^1:PROCESS;0:ABORT ORDER ENTRY",DIR("B")="P"
"RTN","PSODGDGP",96,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'A' to Abort Order Entry process" D ^DIR K X1,DIR I 'Y S PSORX("DFLG")=1,DGI="" K DTOUT,DIRUT,DIROUT,DUOUT,PSORX("INTERVENE") D ULRX Q
"RTN","PSODGDGP",97,0)
 I IT=1 D
"RTN","PSODGDGP",98,0)
 .S PSORX("INTERVENE")=IT
"RTN","PSODGDGP",99,0)
 .D SIG^XUSESIG I X1="" K PSORX("INTERVENE") S PSORX("DFLG")=1 Q
"RTN","PSODGDGP",100,0)
 K DUOUT,DTOUT,DIRUT,DIROUT D ULRX Q
"RTN","PSODGDGP",101,0)
CRITN ;process multiple new drug interactions
"RTN","PSODGDGP",102,0)
 K X1,DIR S DIR("A",1)="",DIR("A",2)="Do you want to: ",DIR("A",3)=" 1.  Delete NEW medication "_PSODRUG("NAME"),DIR("A",4)=" 2.  Cancel ACTIVE New Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" DRUG: "_DRG
"RTN","PSODGDGP",103,0)
 S DIR("A",5)=" 3.  Delete 1 and Cancel 2",DIR("A")=" 4.  Continue ?: ",DIR(0)="SA^1:NEW MEDICATION;2:ACTIVE New Rx "_DRG_";3:BOTH;4:CONTINUE"
"RTN","PSODGDGP",104,0)
 S DIR("?",1)="Enter '1' or 'N' to Delete New Medication and Dispense Rx #"_$P(^PSRX($P(ON,";",2),0),"^")
"RTN","PSODGDGP",105,0)
 S DIR("?",2)="      '2' or 'A' to Cancel Active Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" and Dispense New Rx"
"RTN","PSODGDGP",106,0)
 S DIR("?",3)="      '3' or 'B' to Delete 1 and Cancel 2",DIR("?")="      '4' or 'C' to do nothing to either Rx" D ^DIR K DIR
"RTN","PSODGDGP",107,0)
 I Y=1 S PSORX("DFLG")=1,DGI="",PSHLDDRG=PSODRUG("IEN") D  D ULRX Q
"RTN","PSODGDGP",108,0)
 .I $G(PSORXED) D  Q
"RTN","PSODGDGP",109,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) W $C(7)," ACTION NOT TAKEN!",! S PSORX("DFLG")=1 K PSORX("INTERVENE") Q
"RTN","PSODGDGP",110,0)
 ..S DA=$P(ON,";",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGP",111,0)
 ..K PSOSD($P(PSOLST($P(ON,";",2)),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGP",112,0)
 .S PSODRUG("IEN")=$P(^PSRX($P(ON,";",2),0),"^",6) D FULL^VALM1,^PSORXI
"RTN","PSODGDGP",113,0)
 .S PSODRUG("IEN")=PSHLDDRG,VALMBCK="R"
"RTN","PSODGDGP",114,0)
 .K DTOUT,DIRUT,DIROUT,DUOUT,PSHLDDRG
"RTN","PSODGDGP",115,0)
 .I $G(OR0) D
"RTN","PSODGDGP",116,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",117,0)
 ...W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",118,0)
 ..D DC^PSOORFI2
"RTN","PSODGDGP",119,0)
 I Y=2 S (DA,PSOHOLDA)=$P(ON,";",2) D  D ULRX Q
"RTN","PSODGDGP",120,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",121,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",122,0)
 .D MESS,ENQ^PSORXDL
"RTN","PSODGDGP",123,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL
"RTN","PSODGDGP",124,0)
 .K DTOUT,DIROUT,DIRUT,DUOUT,PSOHOLDA
"RTN","PSODGDGP",125,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S VALMBCK="R"
"RTN","PSODGDGP",126,0)
 I Y=3 S (DA,PSOHOLDA)=$P(ON,";",2) D  S VALMBCK="R"
"RTN","PSODGDGP",127,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",128,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",129,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S PSORX("DFLG")=1 D MESS,ENQ^PSORXDL
"RTN","PSODGDGP",130,0)
 .I $G(OR0) D DC^PSOORFI2
"RTN","PSODGDGP",131,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL K PSOHOLDA
"RTN","PSODGDGP",132,0)
 .I $G(PSORXED) D
"RTN","PSODGDGP",133,0)
 ..S DA=$P(ON,";",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGP",134,0)
 ..K DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGP",135,0)
 K DTOUT,DIROUT,DIRUT,DUOUT
"RTN","PSODGDGP",136,0)
 D ULRX
"RTN","PSODGDGP",137,0)
 Q
"RTN","PSODGDGP",138,0)
MESS W !!,"Canceling Rx: "_$P($G(^PSRX(DA,0)),"^")_"   "_"Drug: "_$P($G(^PSDRUG($P(^PSRX(DA,0),"^",6),0)),"^"),! Q
"RTN","PSODGDGP",139,0)
PPL F PSOSL=0:0 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  S PSOX2=PSOSL
"RTN","PSODGDGP",140,0)
 I $G(PSOX2) D
"RTN","PSODGDGP",141,0)
 .F PSOSL=0:1:PSOX2 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  F ENT=1:1:$L(PSORX("PSOL",PSOSL),",") I $P(PSORX("PSOL",PSOSL),",",ENT)=$P(ON,";",2) S PSOL(PSOSL,ENT)=""
"RTN","PSODGDGP",142,0)
 .F PSOL=0:0 S PSOL=$O(PSOL(PSOL)) Q:'PSOL  F ENT=0:0 S ENT=$O(PSOL(PSOL,ENT)) Q:'ENT  D
"RTN","PSODGDGP",143,0)
 ..I ENT=1,'$P(PSORX("PSOL",PSOL),",",2) K PSORX("PSOL",PSOL) Q
"RTN","PSODGDGP",144,0)
 ..I ENT=1,$P(PSORX("PSOL",PSOL),",",2) S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",2,99) Q
"RTN","PSODGDGP",145,0)
 ..S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",1,ENT-1)_","_$P(PSORX("PSOL",PSOL),",",ENT+1,99)
"RTN","PSODGDGP",146,0)
 K PSOX2,PSOSL,PSOL,ENT Q
"RTN","PSODGDGP",147,0)
ULRX ;
"RTN","PSODGDGP",148,0)
 I '$G(PSODGRLX) Q
"RTN","PSODGDGP",149,0)
 D PSOUL^PSSLOCK(PSODGRLX) K PSODGRLX
"RTN","PSODGDGP",150,0)
 Q
"RTN","PSODIR")
0^2^B34430452
"RTN","PSODIR",1,0)
PSODIR ;BHAM ISC/SAB - asks data for rx order entry ; 9/17/07 5:03pm
"RTN","PSODIR",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**37,46,111,117,146,164,211,264,275,391,372,416**;DEC 1997;Build 32
"RTN","PSODIR",3,0)
 ;External reference PSDRUG( supported by DBIA 221
"RTN","PSODIR",4,0)
 ;External reference PS(50.7 supported by DBIA 2223
"RTN","PSODIR",5,0)
 ;External reference to VA(200 is supported by DBIA 10060
"RTN","PSODIR",6,0)
 ;----------------------------------------------------------------
"RTN","PSODIR",7,0)
 ;
"RTN","PSODIR",8,0)
PROV(PSODIR) ;
"RTN","PSODIR",9,0)
PROVEN ; Entry point for failed lookup
"RTN","PSODIR",10,0)
 K DIC,X,Y S:$G(PSOFDR)&($G(OR0)) DIC("B")=$P(^VA(200,$P($G(OR0),"^",5),0),"^")
"RTN","PSODIR",11,0)
 I '$D(PSODIR("CS")),$D(PSODRUG("DEA")) D
"RTN","PSODIR",12,0)
 .N DEA S PSODIR("CS")=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSODIR",13,0)
 I $G(PSODIR("PROVIDER"))]"" S PSODIR("OLD VAL")=PSODIR("PROVIDER")
"RTN","PSODIR",14,0)
 S DIC="^VA(200,",DIC(0)="QEAM",PSODIR("FIELD")=0
"RTN","PSODIR",15,0)
 S DIC("W")="W ""     "",$P(^(""PS""),""^"",9)"
"RTN","PSODIR",16,0)
 S DIC("A")="PROVIDER: ",DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSODIR",17,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" S DIC("S")=DIC("S")_",$P($G(^(""TPB"")),""^""),$P($G(^(""TPB"")),""^"",5)=0"
"RTN","PSODIR",18,0)
 S:$G(PSORX("PROVIDER NAME"))]"" DIC("B")=PSORX("PROVIDER NAME")
"RTN","PSODIR",19,0)
 D ^DIC K DIC
"RTN","PSODIR",20,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PROVX
"RTN","PSODIR",21,0)
 I $D(DTOUT)!$D(DUOUT) S PSODIR("DFLG")=1 G PROVX
"RTN","PSODIR",22,0)
 I '$G(SPEED),Y=-1 G PROVEN
"RTN","PSODIR",23,0)
 Q:$G(SPEED)&(Y=-1)
"RTN","PSODIR",24,0)
 ;PSO*7*211; ADD CHECK FOR DEA# AND VA#
"RTN","PSODIR",25,0)
 I $P($G(PSODIR("CS")),"^",1)!($D(CLOZPAT)) N NDEA,SDEA S SDEA=$$DRGSCH() S NDEA=$$SDEA^XUSER(0,+Y,SDEA) I $L($P(NDEA,"^"))<3 D  G PROVEN
"RTN","PSODIR",26,0)
 .I NDEA=2 W $C(7),!!,"Provider not authorized to write Federal Schedule "_SDEA_" prescriptions.",! Q
"RTN","PSODIR",27,0)
 .W $C(7),!!,"Provider must have a DEA# or VA# to write prescriptions for this drug.",!
"RTN","PSODIR",28,0)
 ;PSO*7.0*391; Added check for DETOX#
"RTN","PSODIR",29,0)
 I $$DETOX^PSSOPKI($G(PSODRUG("IEN"))),$$DETOX^XUSER(+Y)="" W $C(7),!!,"Provider must have a DETOX# to order this drug.",! G PROVEN
"RTN","PSODIR",30,0)
 I $D(CLOZPAT),'$D(^XUSEC("YSCL AUTHORIZED",+Y)) D  G PROVEN
"RTN","PSODIR",31,0)
 .W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSODIR",32,0)
 I '$G(PSODRUG("IEN")),'$G(PSORENW("DRUG IEN")) G NODRUG
"RTN","PSODIR",33,0)
NODRUG S PSODIR("PROVIDER")=+Y
"RTN","PSODIR",34,0)
 S (PSODIR("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P(Y,"^",2)
"RTN","PSODIR",35,0)
 I $G(PSODIR("OLD VAL"))'=+Y K PSODIR("GENERIC PROVIDER"),PSODIR("COSIGNING PROVIDER")
"RTN","PSODIR",36,0)
 I $G(PSODIR("OLD VAL"))'=$G(PSODIR("PROVIDER")),$P(Y,"^",2)="PROVIDER,OTHER"!($P(Y,"^",2)="PROVIDER,OUTSIDE") D GENERIC
"RTN","PSODIR",37,0)
 I $P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",7),$P(^("PS"),"^",8) D COSIGN
"RTN","PSODIR",38,0)
 I $G(PSODIR("COSIGNING PROVIDER")),'$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",7) K PSODIR("COSIGNING PROVIDER")
"RTN","PSODIR",39,0)
PROVX K X,Y
"RTN","PSODIR",40,0)
 Q
"RTN","PSODIR",41,0)
 ;
"RTN","PSODIR",42,0)
DRGSCH() ; determine the drug schedule
"RTN","PSODIR",43,0)
 N ND3,SCH
"RTN","PSODIR",44,0)
 S SCH="",ND3=$P($G(^PSDRUG(PSODRUG("IEN"),"ND")),"^",3) S:+ND3 SCH=$$GET1^DIQ(50.68,ND3,19,"I")
"RTN","PSODIR",45,0)
 I +SCH>0!($G(PSODRUG("DEA"))="") Q SCH
"RTN","PSODIR",46,0)
 I "^4^5^"[+PSODRUG("DEA") Q +PSODRUG("DEA")
"RTN","PSODIR",47,0)
 Q $S($G(PSODRUG("DEA"))["A":+PSODRUG("DEA"),1:+PSODRUG("DEA")_"n")
"RTN","PSODIR",48,0)
 ;
"RTN","PSODIR",49,0)
GENERIC ;
"RTN","PSODIR",50,0)
 K DIR,DIC,PSODIR("GENERIC PROVIDER")
"RTN","PSODIR",51,0)
 S DIR(0)="52,30"
"RTN","PSODIR",52,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") GENERICX
"RTN","PSODIR",53,0)
 S PSODIR("GENERIC PROVIDER")=Y
"RTN","PSODIR",54,0)
GENERICX K X,Y
"RTN","PSODIR",55,0)
 Q
"RTN","PSODIR",56,0)
 ;
"RTN","PSODIR",57,0)
COSIGN ;
"RTN","PSODIR",58,0)
 K DIC
"RTN","PSODIR",59,0)
 I '$G(PSODIR("COSIGNING PROVIDER")),$P($G(RX3),"^",3) S PSODIR("COSIGNING PROVIDER")=$P(RX3,"^",3) G COSIGN1
"RTN","PSODIR",60,0)
 I $P($G(RX3),"^",3),$P($G(RX3),"^",3)'=$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8) D
"RTN","PSODIR",61,0)
 .W !!,"Previous Co-Signing Provider: "_$P(^VA(200,$P(RX3,"^",3),0),"^")
"RTN","PSODIR",62,0)
 .S PSODIR("COSIGNING PROVIDER")=$S($P(RX3,"^",3)'=PSODIR("COSIGNING PROVIDER"):PSODIR("COSIGNING PROVIDER"),1:$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8))
"RTN","PSODIR",63,0)
COSIGN1 S DIC(0)="QEAM",DIC="^VA(200,",DIC("B")=$S($G(PSODIR("COSIGNING PROVIDER")):$P(^VA(200,PSODIR("COSIGNING PROVIDER"),0),"^"),1:$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8))
"RTN","PSODIR",64,0)
 S DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSODIR",65,0)
 S DIC("W")="W ""     "",$P(^(""PS""),""^"",9)",DIC("S")=DIC("S")_",'$P(^(""PS""),""^"",7)"
"RTN","PSODIR",66,0)
 S DIC("A")="COSIGNING PROVIDER: " D ^DIC K DIC
"RTN","PSODIR",67,0)
 I $D(DTOUT)!$D(DUOUT) S PSODIR("DFLG")=1 G COSIGNX
"RTN","PSODIR",68,0)
 S:+Y>0 PSODIR("COSIGNING PROVIDER")=+Y G:Y<0 COSIGN
"RTN","PSODIR",69,0)
COSIGNX K X,Y
"RTN","PSODIR",70,0)
 Q
"RTN","PSODIR",71,0)
DOSE(PSODIR) ;add dosing info
"RTN","PSODIR",72,0)
 N PSODOSNW S PSODOSNW=1
"RTN","PSODIR",73,0)
 D DOSE1^PSOORED5(.PSODIR)
"RTN","PSODIR",74,0)
EX K PSODOSE,PSOSCH,DOSE,DOOR,SCH,VERB,NOUN,DOSEOR,ENT,PSORTE,DRUA,DIR,X,Y,DIRUT,RTE,ERTE,DD,INS1,SINS1
"RTN","PSODIR",75,0)
 Q
"RTN","PSODIR",76,0)
INS(PSODIR) ;patient instructions
"RTN","PSODIR",77,0)
 N DA K INS1,DD,DIR,DIRUT S D=0 F  S D=$O(PSODIR("SIG",D)) Q:'D  S DD=$G(DD)+1
"RTN","PSODIR",78,0)
 I $G(DD)=1 S PSODIR("INS")=$G(PSODIR("SIG",1)) G INSD
"RTN","PSODIR",79,0)
 ;PSO*7*275 remove check for PSOINSFL just check for multi line sig
"RTN","PSODIR",80,0)
 I $G(DD)>1 D  G EX
"RTN","PSODIR",81,0)
 .K ^TMP($J) S D=0 F  S D=$O(PSODIR("SIG",D)) Q:'D  S ^TMP($J,"SIG",D,0)=PSODIR("SIG",D)
"RTN","PSODIR",82,0)
 .S DWPK=2,DWLW=80,DIC="^TMP($J,""SIG""," D EN^DIWE K PSODIR("SIG")
"RTN","PSODIR",83,0)
 .S D=0 F  S D=$O(^TMP($J,"SIG",D)) Q:'D  S PSODIR("SIG",D)=^TMP($J,"SIG",D,0)
"RTN","PSODIR",84,0)
 .D EN^PSOFSIG(.PSODIR,1) K DWLW,D,DWPK,^TMP($J)
"RTN","PSODIR",85,0)
 I $G(PSOINSFL)=0 G INSD
"RTN","PSODIR",86,0)
 I $G(PSOFDR),$G(ORD),$P($G(^PS(52.41,+$G(ORD),"EXT")),"^")'="" G INSD
"RTN","PSODIR",87,0)
 I $G(PSODIR("INS"))']"",$G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S DIR("B")=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSODIR",88,0)
INSD S DIR(0)="52,114" S:$G(PSODIR("INS"))]"" DIR("B")=PSODIR("INS")
"RTN","PSODIR",89,0)
 D DIR G:$G(PSODIR("DFLG"))!(PSODIR("FIELD")) EX
"RTN","PSODIR",90,0)
 I X'="",X'="@" S PSODIR("INS")=Y D SIG^PSOHELP G INSD:'$D(X)
"RTN","PSODIR",91,0)
 I $G(INS1)]"" D EN^DDIOL($E(INS1,2,9999999)) S (PSODIR("SIG",1),PSODIR("SIG"))=$E(INS1,2,9999999)
"RTN","PSODIR",92,0)
 I X="@" K PSODIR("INS"),PSODIR("SIG")
"RTN","PSODIR",93,0)
 D EN^PSOFSIG(.PSODIR,1) I $O(SIG(0)) S SIGOK=1
"RTN","PSODIR",94,0)
 G EX
"RTN","PSODIR",95,0)
 Q
"RTN","PSODIR",96,0)
SINS(PSODIR) ;other lang. patient instructions
"RTN","PSODIR",97,0)
 K SINS1,DIR
"RTN","PSODIR",98,0)
 S DIR(0)="52,114.1" S:$G(PSODIR("SINS"))]"" DIR("B")=PSODIR("SINS")
"RTN","PSODIR",99,0)
 I $G(PSODIR("SINS"))']"",$G(^PS(50.7,PSODRUG("OI"),"INS1"))]"" S DIR("B")=^PS(50.7,PSODRUG("OI"),"INS1")
"RTN","PSODIR",100,0)
 D DIR G:$G(PSODIR("DFLG")) EX
"RTN","PSODIR",101,0)
 I X'="",X'="@" S PSODIR("SINS")=Y D SSIG^PSOHELP
"RTN","PSODIR",102,0)
 I $G(SINS1)]"" D EN^DDIOL($E(SINS1,2,9999999)) S PSODIR("SINS")=$E(SINS1,2,9999999)
"RTN","PSODIR",103,0)
 I X="@" K PSODIR("SINS")
"RTN","PSODIR",104,0)
 G EX
"RTN","PSODIR",105,0)
 Q
"RTN","PSODIR",106,0)
 ;
"RTN","PSODIR",107,0)
DIR ;
"RTN","PSODIR",108,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR",109,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR",110,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR",111,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1 S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR",112,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP
"RTN","PSODIR",113,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR",114,0)
 Q
"RTN","PSODIR",115,0)
 ;
"RTN","PSODIR",116,0)
JUMP ;
"RTN","PSODIR",117,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR",118,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR",119,0)
 I Y=-1 S PSODIR("FIELD")=$G(PSODIR("FLD")) G JUMPX
"RTN","PSODIR",120,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR",121,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR",122,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR",123,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR",124,0)
JUMPX S X="^"_X
"RTN","PSODIR",125,0)
 Q
"RTN","PSODOSUN")
0^21^B84411682
"RTN","PSODOSUN",1,0)
PSODOSUN ;BIR/RTR - Dose Check Utility routine ;11/18/08
"RTN","PSODOSUN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,379,372,416**;DEC 1997;Build 32
"RTN","PSODOSUN",3,0)
 ;
"RTN","PSODOSUN",4,0)
DOSE() ;Write Dose output for renew, finish, copy, etc.
"RTN","PSODOSUN",5,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,PSODLFLG,PSODLALZ,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1,PSODLOFF
"RTN","PSODOSUN",6,0)
 N PSODLNN1,PSODLERR,PSODLERX,PSODLQT,PSOCPXG,PSOCPXRR,PSODLEXR,PSODELNX,PSODLECT,PSOCPXF,PSODTYPE,PSOCPXC,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",7,0)
 S (PSODLERF,PSODLERZ,PSODLALZ,PSODLINS,PSODLINR,PSODLERR,PSODLQT,PSOCPXG,PSOCPXF,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODLOFF)=0,PSODTYPE="N",PSOCPXC=1
"RTN","PSODOSUN",8,0)
 I $G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",9,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",10,0)
 W:$G(PSOEDIT)!$G(PSOCOPY)!($G(PSOFOERR)) @IOF I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G END
"RTN","PSODOSUN",11,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",12,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",13,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",14,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",15,0)
 ;PSOCPXB = Number of Dosing Seq
"RTN","PSODOSUN",16,0)
 S PSODLQT=0 K PSOCPXRR
"RTN","PSODOSUN",17,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",18,0)
END ;
"RTN","PSODOSUN",19,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",20,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",21,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",22,0)
 K PSODAILY,DIR,Y,PSODOSEX
"RTN","PSODOSUN",23,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",24,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",25,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",26,0)
 .S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",27,0)
 I '$G(PSODLINS)&'$G(PSODLINR) Q 0
"RTN","PSODOSUN",28,0)
 I '$D(^XUSEC("PSORPH",DUZ)) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",29,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",30,0)
 S DIR("A")=$$GETGN^PSODOSUN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",31,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",32,0)
 D ^DIR K DIR
"RTN","PSODOSUN",33,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",34,0)
 I Y=0 Q 3_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")  ;need to know if user cancelled or not
"RTN","PSODOSUN",35,0)
 K PSODOSEX
"RTN","PSODOSUN",36,0)
 D SIG^XUSESIG I $G(X1)="" Q 1
"RTN","PSODOSUN",37,0)
END2 ;
"RTN","PSODOSUN",38,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",39,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",40,0)
 ;
"RTN","PSODOSUN",41,0)
EVAL(PSODLINS,PSODLINR) ;
"RTN","PSODOSUN",42,0)
 Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",43,0)
 ;
"RTN","PSODOSUN",44,0)
DOSEX(PSODLXNT) ;Write Dose exceptions for order entry/edit
"RTN","PSODOSUN",45,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",46,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODELNX,PSODTYPE,PSODCONT,PSODSEQ,PSODOSX,PSODLOFF
"RTN","PSODOSUN",47,0)
 W @IOF S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSODLQT,PSODCONT,PSODLOFF)=0,PSODTYPE="E"
"RTN","PSODOSUN",48,0)
 I $G(PSOEDDOS) Q:$G(PSORXED("CONJUNCTION",1))="" 0  ;don't show messages when simple order before accept of order during edits
"RTN","PSODOSUN",49,0)
 I PSOCPXB>3,$G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",50,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G ENDX
"RTN","PSODOSUN",51,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",52,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",53,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",54,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",55,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",56,0)
ENDX ;
"RTN","PSODOSUN",57,0)
 S PSODOSX=1
"RTN","PSODOSUN",58,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",59,0)
 K PSOCPXRR
"RTN","PSODOSUN",60,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",61,0)
 ;
"RTN","PSODOSUN",62,0)
 ;This "return to continue" occurs after the last dosing sequence for a complex order with 4 or more dosing sequences during an edit when finishing, placing a new order, copy or edit
"RTN","PSODOSUN",63,0)
 ;
"RTN","PSODOSUN",64,0)
 I '$G(PSOCKCON)&($G(PSOFOERR)) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",65,0)
 .Q:($G(PSODLFLG))&$D(^XUSEC("PSORPH",DUZ))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",66,0)
 .D RETURN
"RTN","PSODOSUN",67,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",68,0)
 ;
"RTN","PSODOSUN",69,0)
 I '$G(PSOFOERR) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",70,0)
 .Q:$G(PSODLFLG)&$D(^XUSEC("PSORPH",DUZ))
"RTN","PSODOSUN",71,0)
 .I '$G(PSOEDIT) Q:$G(PSODOSNW)&'$G(PSOCPXD)&'$G(PSOCOPY)
"RTN","PSODOSUN",72,0)
 .Q:($G(PSOCOPY)!$G(PSOEDIT))&'$G(PSOCPXV)
"RTN","PSODOSUN",73,0)
 .Q:PSOCPXB>3&$G(PSOCPXV)
"RTN","PSODOSUN",74,0)
 .D RETURN
"RTN","PSODOSUN",75,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",76,0)
 ;
"RTN","PSODOSUN",77,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",78,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR)),$G(PSODLFLG) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",79,0)
 I 'PSODCONT Q:$G(PSOCPXV) 0
"RTN","PSODOSUN",80,0)
 I $G(PSODLBD4)&'$G(PSODLINS)&'$G(PSODLINR)&('$G(PSODLALZ)) S Y=1 G ENDX2
"RTN","PSODOSUN",81,0)
 K DIR,Y I $D(^XUSEC("PSORPH",DUZ)) S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",82,0)
ENDX2 ;
"RTN","PSODOSUN",83,0)
 K PSODOSEX
"RTN","PSODOSUN",84,0)
 W !
"RTN","PSODOSUN",85,0)
 Q 0
"RTN","PSODOSUN",86,0)
DOSEZ() ;Write Dose output summary for complex orders
"RTN","PSODOSUN",87,0)
 I $G(PSOEDDOS) Q:$G(PSORXED("CONJUNCTION",1))="" 0  ;don't show messages when simple order before accept of order during edits
"RTN","PSODOSUN",88,0)
 N PSOCPXF,PSOCPXC,PSOCPXRR,PSOCPXG,PSODLESM,PSODELNX,PSOCPXH,PSODTYPE,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",89,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",90,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODLEXR,PSODLECT,PSODLOFF
"RTN","PSODOSUN",91,0)
 I '$G(PSOTOF) W @IOF
"RTN","PSODOSUN",92,0)
 S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSOCPXF,PSODLQT,PSOCPXH,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODLOFF)=0,PSODTYPE="C",PSOCPXC=1
"RTN","PSODOSUN",93,0)
 I $G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) S PSOEDOUT=1
"RTN","PSODOSUN",94,0)
 I PSOCPXB>3,$G(PSOEDOUT) S PSOCPXC=0
"RTN","PSODOSUN",95,0)
 ;I PSOCPXB>3,$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",96,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",97,0)
 Q:$G(PSOCPXB)<4&'$G(PSOFOERR)&('$G(PSODLFLG)) 0
"RTN","PSODOSUN",98,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 S PSODLQT=1 D  S PSODLFLG=0,PSODLOFF=1 G ENDZ
"RTN","PSODOSUN",99,0)
 .D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) !! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",100,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",101,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT)&(PSOCPXC) ! D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",102,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",103,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",104,0)
ENDZ ;
"RTN","PSODOSUN",105,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",106,0)
 K PSODAILY
"RTN","PSODOSUN",107,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",108,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 0
"RTN","PSODOSUN",109,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",110,0)
 I '$G(PSOCPXF)&(PSOLASTS'=PSOCPXB),PSOEDOUT Q 0
"RTN","PSODOSUN",111,0)
 K PSODOSEX
"RTN","PSODOSUN",112,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",113,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",114,0)
ENDZC ;
"RTN","PSODOSUN",115,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",116,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR))  Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",117,0)
 G ENDZ2:$G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4))
"RTN","PSODOSUN",118,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",119,0)
 S DIR("A")=$$GETGN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",120,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",121,0)
 D ^DIR K DIR,PSODOSEX
"RTN","PSODOSUN",122,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",123,0)
 D SIG^XUSESIG I $G(X1)="" Q 1
"RTN","PSODOSUN",124,0)
ENDZ2 ;
"RTN","PSODOSUN",125,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",126,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",127,0)
HD ;
"RTN","PSODOSUN",128,0)
 I PSODLQT!(($Y+5)'>IOSL) Q
"RTN","PSODOSUN",129,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUN",130,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1,PSORX("DFLG")=1 Q 1
"RTN","PSODOSUN",131,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",132,0)
 W @IOF W !
"RTN","PSODOSUN",133,0)
 Q
"RTN","PSODOSUN",134,0)
MESG ;Write out System error heading
"RTN","PSODOSUN",135,0)
 I 'PSODLQT D HD W !,"Maximum Single Dose Check could not be performed:",!
"RTN","PSODOSUN",136,0)
 Q
"RTN","PSODOSUN",137,0)
GETGN(PSODRIEN) ;get generic name
"RTN","PSODOSUN",138,0)
 K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",139,0)
 D DATA^PSS50(PSODRIEN,,,,,"PSODOSUN GN")
"RTN","PSODOSUN",140,0)
 Q $S($D(^TMP($J,"PSODOSUN GN",PSODRIEN,.01)):^TMP($J,"PSODOSUN GN",PSODRIEN,.01),1:"")
"RTN","PSODOSUN",141,0)
 ;
"RTN","PSODOSUN",142,0)
PROMPT ;
"RTN","PSODOSUN",143,0)
 ;assumes that a previous check was made to verify that errors, exceptions or messages are present
"RTN","PSODOSUN",144,0)
 ;if only warnings (exceptions/errors) then display "Press return to continue"; otherwise display "Do you want to continue" prompt.
"RTN","PSODOSUN",145,0)
 ;FINISH and BACKDOOR are separated below in order keep to a mininum the vast number of scenarios to be tested
"RTN","PSODOSUN",146,0)
 I $G(PSODLOFF)&(($Y+5)>IOSL) D RETURN Q
"RTN","PSODOSUN",147,0)
 I $G(PSOFOERR) D  ;FINISH
"RTN","PSODOSUN",148,0)
 .Q:$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))
"RTN","PSODOSUN",149,0)
 .I '$G(PSODLFLG) D
"RTN","PSODOSUN",150,0)
 ..Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",151,0)
 ..I '$G(PSORENWD) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",152,0)
 ..D RETURN
"RTN","PSODOSUN",153,0)
 ;
"RTN","PSODOSUN",154,0)
 I '$G(PSOFOERR)&'$G(PSODLFLG) D  ;BACKDOOR
"RTN","PSODOSUN",155,0)
 .Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",156,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",157,0)
 .D RETURN
"RTN","PSODOSUN",158,0)
 ;
"RTN","PSODOSUN",159,0)
 I $G(PSODLFLG)&'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODOSUN",160,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",161,0)
 .D RETURN
"RTN","PSODOSUN",162,0)
 Q
"RTN","PSODOSUN",163,0)
 ;
"RTN","PSODOSUN",164,0)
RETURN ;
"RTN","PSODOSUN",165,0)
 ;I $G(PSORENWD) Q:($Y+15)<IOSL
"RTN","PSODOSUN",166,0)
 Q:'$D(^XUSEC("PSORPH",DUZ))&($Y<10)
"RTN","PSODOSUN",167,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR  S:'Y PSODLQT=1,PSOQTOUT=1,PSORX("DFLG")=1 W @IOF
"RTN","PSODOSUN",168,0)
 Q
"RTN","PSODOSUN",169,0)
 ;
"RTN","PSODOSUN",170,0)
HD3(PSOLINES,OVRRID) ;
"RTN","PSODOSUN",171,0)
 N X,Y,DTOUT,DUOUT,DIR
"RTN","PSODOSUN",172,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODOSUN",173,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)<IOSL) Q
"RTN","PSODOSUN",174,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR,PSOLINES,OVRRID
"RTN","PSODOSUN",175,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUN",176,0)
 W @IOF
"RTN","PSODOSUN",177,0)
 Q
"RTN","PSODOSUT")
0^17^B130658909
"RTN","PSODOSUT",1,0)
PSODOSUT ;BIR/RTR - PRE Dose Check Utility routine ;11/18/08
"RTN","PSODOSUT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,372,416**;DEC 1997;Build 32
"RTN","PSODOSUT",3,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSODOSUT",4,0)
 ;
"RTN","PSODOSUT",5,0)
 ;DOSE expect PSODLQT to be defined prior to calling it.
"RTN","PSODOSUT",6,0)
 ; PSODLQT=1 means no data will be written to the screen, but a value will be returned.
"RTN","PSODOSUT",7,0)
 ; PSODLQT=0 means data will be written to the screen and a value is returned 
"RTN","PSODOSUT",8,0)
 ;
"RTN","PSODOSUT",9,0)
 ;EVAL(PSODLINS,PSODLINR) ;
"RTN","PSODOSUT",10,0)
 ;Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUT",11,0)
 ;
"RTN","PSODOSUT",12,0)
SUMM ;
"RTN","PSODOSUT",13,0)
 I 'PSODLQT W !,"   DOSING CHECK SUMMARY:",!!
"RTN","PSODOSUT",14,0)
 S PSOCPXF=1
"RTN","PSODOSUT",15,0)
 Q
"RTN","PSODOSUT",16,0)
 ;
"RTN","PSODOSUT",17,0)
SUB ;Write sub header; called from PSODOSUN
"RTN","PSODOSUT",18,0)
 D HD^PSODOSU2 I 'PSODLQT,'$G(PSODLEXR) W ! S PSODLEXR=0
"RTN","PSODOSUT",19,0)
 D HD^PSODOSU2
"RTN","PSODOSUT",20,0)
 I 'PSODLQT W "   DOSE SEQ "_PSOCPXG_":"
"RTN","PSODOSUT",21,0)
 S PSOCPXRR(PSOCPXG)=1
"RTN","PSODOSUT",22,0)
 Q
"RTN","PSODOSUT",23,0)
 ;
"RTN","PSODOSUT",24,0)
DAILY ;
"RTN","PSODOSUT",25,0)
 I 'PSODLQT W:'$G(PSORENW)!($G(PSOCOPY))!($G(PSORXED)) ! W "   DAILY DOSE RANGE WARNING:"
"RTN","PSODOSUT",26,0)
 S PSODAILY=1
"RTN","PSODOSUT",27,0)
 Q
"RTN","PSODOSUT",28,0)
 ;
"RTN","PSODOSUT",29,0)
COMPLEX ;called from DOSEZ^PSODOSUN
"RTN","PSODOSUT",30,0)
 I 'PSOCPXF&(PSOCPXC) S PSOCPXG=$P(PSODLNN1,";",4) D SUMM K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSUT",31,0)
 I PSOCPXC S PSOCPXG=$P(PSODLNN1,";",4) D HD D
"RTN","PSODOSUT",32,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSUT",33,0)
 .I '$G(PSOCPXRR(PSOCPXG))&('$G(PSOCPXH)) D SUB I $G(PSOCOPY)!($G(PSORENW)) S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSUT",34,0)
 .I PSODLPL="2_RANGE"&PSODLINR&'$G(PSODAILY) D DAILY
"RTN","PSODOSUT",35,0)
 .D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUT",36,0)
 .N PSODELXF,PSODELXR S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUT",37,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUT",38,0)
 .D HD I 'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W !
"RTN","PSODOSUT",39,0)
 Q
"RTN","PSODOSUT",40,0)
 ;
"RTN","PSODOSUT",41,0)
HD ;
"RTN","PSODOSUT",42,0)
 I $G(PSODLQT)!(($Y+5)<IOSL)!($G(PSORX("DFLG"))) Q
"RTN","PSODOSUT",43,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUT",44,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR I 'Y!($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSODLQT=1,PSONEW("DFLG")=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUT",45,0)
 W @IOF
"RTN","PSODOSUT",46,0)
 Q
"RTN","PSODOSUT",47,0)
 ;
"RTN","PSODOSUT",48,0)
SFD ;
"RTN","PSODOSUT",49,0)
 S PSODELXF=1 S:PSODLERX="TEXT" PSODLERZ=1
"RTN","PSODOSUT",50,0)
 Q
"RTN","PSODOSUT",51,0)
 ;
"RTN","PSODOSUT",52,0)
SBAD ;Set Bad Drug flag just in case not set in enhanced check, possibly because Dosage edits are done first
"RTN","PSODOSUT",53,0)
 N PSODLBD1,PSODLBD3
"RTN","PSODOSUT",54,0)
 I PSODLERB["GCNSEQNO"!(PSODLERB["Drug not matched to NDF") D
"RTN","PSODOSUT",55,0)
 .S PSODLBD1=$O(^TMP($J,"PSOPDOSA","OUT","EXCEPTIONS","DOSE",PSODSEQ,PSODLNN1,"")) I PSODLBD1 D
"RTN","PSODOSUT",56,0)
 ..S PSODLBD3=$P($G(^TMP($J,"PSOPDOSA","OUT","EXCEPTIONS","DOSE",PSODSEQ,PSODLNN1,PSODLBD1)),"^",3) I PSODLBD3 S PSODRUG("BAD",PSODLBD3)=1
"RTN","PSODOSUT",57,0)
 Q
"RTN","PSODOSUT",58,0)
 ;
"RTN","PSODOSUT",59,0)
EXCEPT ;don't show "not matched to NDF" or "no GCNSEQNO" errors for dosing - when dosage is edited enhanced order checks are performed again so we don't want to display these type messages for dosing.
"RTN","PSODOSUT",60,0)
 N PSODLER1,PSODLER2
"RTN","PSODOSUT",61,0)
 F PSODLER1=0:0 S PSODLER1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1)) Q:'PSODLER1  D
"RTN","PSODOSUT",62,0)
 .S PSODLER2=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1))
"RTN","PSODOSUT",63,0)
 .I PSODLER2["Drug not matched to NDF"!(PSODLER2["GCNSEQNO") D
"RTN","PSODOSUT",64,0)
 .. S PSODLER3="" F PSODLER3=PSODLER1-1:1:PSODLER1 K ^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER3)
"RTN","PSODOSUT",65,0)
 Q
"RTN","PSODOSUT",66,0)
 ;
"RTN","PSODOSUT",67,0)
FEED() ; Write Line feed after Exceptions if no message globals follow, and next order has no errors or exceptions, only a message
"RTN","PSODOSUT",68,0)
 I PSODLQT Q 0
"RTN","PSODOSUT",69,0)
 N PSODLNN2
"RTN","PSODOSUT",70,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE")) Q 0
"RTN","PSODOSUT",71,0)
 S PSODLNN2=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1))
"RTN","PSODOSUT",72,0)
 I PSODLNN2="" Q 0
"RTN","PSODOSUT",73,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN2,"ERROR")) Q 0
"RTN","PSODOSUT",74,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN2,"EXCEPTIONS")) Q 0
"RTN","PSODOSUT",75,0)
 Q 1
"RTN","PSODOSUT",76,0)
 ;
"RTN","PSODOSUT",77,0)
DCHKN ;Called from PSOORNEW, PSOORNE1 & PSOORNEW; Dose Check for Copying an Order
"RTN","PSODOSUT",78,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSONEW("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",79,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSONEW,.PSODRUG)
"RTN","PSODOSUT",80,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA")
"RTN","PSODOSUT",81,0)
 I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",82,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",83,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1 Q
"RTN","PSODOSUT",84,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",85,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",86,0)
 ;I +PSODLNVL=3 D CANCEL(PSONEW("OIRXN")) Q  ;CR2724
"RTN","PSODOSUT",87,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",88,0)
 Q
"RTN","PSODOSUT",89,0)
 ;
"RTN","PSODOSUT",90,0)
DCHKR ;Renewal Dose Check; Called from PSORENW0
"RTN","PSODOSUT",91,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSORENW("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",92,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORENW,.PSODRUG)
"RTN","PSODOSUT",93,0)
 S PSODLNVL=$$DOSE^PSODOSUN
"RTN","PSODOSUT",94,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1
"RTN","PSODOSUT",95,0)
 K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA") I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",96,0)
 D DOSIV
"RTN","PSODOSUT",97,0)
 Q
"RTN","PSODOSUT",98,0)
 ;
"RTN","PSODOSUT",99,0)
DCHKC ;Dose Check on reinstate; Called from PSOCAN2
"RTN","PSODOSUT",100,0)
 N PSODCAN
"RTN","PSODOSUT",101,0)
 I '$D(PSODRUG("IEN")) S:$D(PSORENW("OIRXN")) PSODRUG("IEN")=$$GET1^DIQ(52,PSORENW("OIRXN"),6,"I")
"RTN","PSODOSUT",102,0)
 S PSOCPXB=0 F PSOCPXA=0:0 S PSOCPXA=$O(^PSRX(PSORENW("OIRXN"),6,PSOCPXA)) Q:'PSOCPXA  I $P($G(^PSRX(PSORENW("OIRXN"),6,PSOCPXA,0)),"^")'="" S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",103,0)
 D RX^PSODOSCL(.PSODLBS1,PSORENW("OIRXN"))
"RTN","PSODOSUT",104,0)
 S PSODLNNN=PSORENW("OIRXN"),PSODCAN=1
"RTN","PSODOSUT",105,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN"),^TMP($J,"PSOPDOSA")
"RTN","PSODOSUT",106,0)
 I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",107,0)
 D DOSIV
"RTN","PSODOSUT",108,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1
"RTN","PSODOSUT",109,0)
 Q
"RTN","PSODOSUT",110,0)
 ;
"RTN","PSODOSUT",111,0)
DCHK() ;Dose check after entering Null at the conjunction prompt
"RTN","PSODOSUT",112,0)
 ;For complex Dosing, they will eventually enter null too, so change to call if it was not a complex order, and null was entered
"RTN","PSODOSUT",113,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF 0
"RTN","PSODOSUT",114,0)
 Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",115,0)
 ;D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",116,0)
 N PSODLNNN,PSODLENT,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSODLENT,PSOCPXA,PSOCPXV,PSOTOF,PSOCPXB
"RTN","PSODOSUT",117,0)
 ;Need to make sure Drug Name is what you set in the API
"RTN","PSODOSUT",118,0)
 ;Either pass in name here, or set in PSODOSCL to array name that PSSDSAPD uses, which is still the .01 of File 50
"RTN","PSODOSUT",119,0)
 I $$EXMT^PSSDSAPI(PSODRUG("IEN")) Q 0
"RTN","PSODOSUT",120,0)
 I $G(PSODRUG("BAD",PSODRUG("IEN"))) Q 0
"RTN","PSODOSUT",121,0)
 ;Currently only one prospective drug at a time for Outpatient Dose Check
"RTN","PSODOSUT",122,0)
 ;S PSODLNNN="O;1;PROSPECTIVE;1"
"RTN","PSODOSUT",123,0)
 K ^TMP("PSODOSF",$J)
"RTN","PSODOSUT",124,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",125,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORXED,.PSODRUG)
"RTN","PSODOSUT",126,0)
 S PSODLENT=ENT,PSOCPXV=1,PSOCPXB=0
"RTN","PSODOSUT",127,0)
 S PSOCPXB=0 F PSOCPXA=0:0 S PSOCPXA=$O(PSORXED("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",128,0)
 S PSODLNVL=$$DOSEX^PSODOSUN(PSODLENT) S PSOTOF=1 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1
"RTN","PSODOSUT",129,0)
 I $G(PSOEDDOS) D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",130,0)
 I $P($G(PSODLNVL),"^")=1 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") Q 1
"RTN","PSODOSUT",131,0)
DCHK2 ;Finishing of a complex order
"RTN","PSODOSUT",132,0)
 N PSOCPXC,PSOCPXD
"RTN","PSODOSUT",133,0)
 K PSODLNVL
"RTN","PSODOSUT",134,0)
 S PSOCPXD=1 ;flag for MOCHA 2.0, used to not display enter to continue prompt after errors/exceptions list which displays just after last dose sequence.  MOCHA 2.0 does not display errors or exceptions.
"RTN","PSODOSUT",135,0)
 ;S (PSOCPXB)=0 ;setting PSOCPXB=0 makes dosing summery not display when cycling through individual doses of a complex order.  Dose summary should only show after accept of order.
"RTN","PSODOSUT",136,0)
 S PSODLNVL=$$DOSEZ^PSODOSUN K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN")
"RTN","PSODOSUT",137,0)
 I $G(PSOEDDOS) D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",138,0)
 I $P($G(PSODLNVL),"^")=1 Q 1
"RTN","PSODOSUT",139,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) W ! Q 0
"RTN","PSODOSUT",140,0)
 I '$G(PSODLNVL) Q 0
"RTN","PSODOSUT",141,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",142,0)
 I $D(PSORX("EDIT"))!($G(PSORXED)&$G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) Q 0
"RTN","PSODOSUT",143,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",144,0)
 W !
"RTN","PSODOSUT",145,0)
 Q 0
"RTN","PSODOSUT",146,0)
 ;
"RTN","PSODOSUT",147,0)
DCHK1 ;Dose check after entering a value at the Conjunction prompt
"RTN","PSODOSUT",148,0)
 Q:$G(PSORX("DFLG"))!($G(PSODLQT))
"RTN","PSODOSUT",149,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF
"RTN","PSODOSUT",150,0)
 ;D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG"))
"RTN","PSODOSUT",151,0)
 N PSODLNNN,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSODLENT,PSOCPXB
"RTN","PSODOSUT",152,0)
 ;Need to make sure Drug Name is what you set in the API
"RTN","PSODOSUT",153,0)
 ;Either pass in name here, or set in PSODOSCL to array name that PSSDSAPD uses, which is still the .01 of File 50
"RTN","PSODOSUT",154,0)
 I $$EXMT^PSSDSAPI(PSODRUG("IEN")) Q
"RTN","PSODOSUT",155,0)
 I $G(PSODRUG("BAD",PSODRUG("IEN"))) Q
"RTN","PSODOSUT",156,0)
 ;Currently only one prospective drug at a time for Outpatient Dose Check
"RTN","PSODOSUT",157,0)
 ;S PSODLNNN="O;1;PROSPECTIVE;1"
"RTN","PSODOSUT",158,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",159,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORXED,.PSODRUG)
"RTN","PSODOSUT",160,0)
 S PSODLENT=ENT,PSOCPXB=0
"RTN","PSODOSUT",161,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSORXED("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",162,0)
 S PSODLNVL=$$DOSEX^PSODOSUN(PSODLENT)
"RTN","PSODOSUT",163,0)
 D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG"))
"RTN","PSODOSUT",164,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") I $P($G(PSODLNVL),"^")=1 S PSORXED("DFLG")=1 Q
"RTN","PSODOSUT",165,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",166,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) W ! Q
"RTN","PSODOSUT",167,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",168,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",169,0)
 W !
"RTN","PSODOSUT",170,0)
 Q
"RTN","PSODOSUT",171,0)
 ;
"RTN","PSODOSUT",172,0)
CONVMSG(MESS) ;Convert DOSE CHECK message to numeric value for field 8 of ^PS(52.4
"RTN","PSODOSUT",173,0)
 ;For MOCHA 2.0, only returning "DOSAGE EXCEEDS MAX SINGLE DOSE" when a dosing error is present.
"RTN","PSODOSUT",174,0)
 N PSODOSF
"RTN","PSODOSUT",175,0)
 S MESS="DOSAGE EXCEEDS MAX SINGLE DOSE"
"RTN","PSODOSUT",176,0)
 S PSODOSF=$S(MESS="DOSAGE EXCEEDS MAX SINGLE DOSE":4,MESS="MAX SINGLE DOSE & DAILY DOSE RANGE":3,MESS="MAX SINGLE DOSE":2,MESS="DAILY DOSE RANGE":1,1:"")
"RTN","PSODOSUT",177,0)
 Q PSODOSF
"RTN","PSODOSUT",178,0)
 ;
"RTN","PSODOSUT",179,0)
DCHKV ;Dose check when verifying an order
"RTN","PSODOSUT",180,0)
 N PSODOSF,PSOLINE,PSOVERFL,PSOVCAN
"RTN","PSODOSUT",181,0)
 S PSOVERFL=1
"RTN","PSODOSUT",182,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(^PSRX(PSONV,6,PSOCPXA)) Q:'PSOCPXA  I $P($G(^PSRX(PSONV,6,PSOCPXA,0)),"^")'="" S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",183,0)
 D RX^PSODOSCL(.PSODLBS1,PSONV)
"RTN","PSODOSUT",184,0)
 S $P(PSOLINE,"-",79)="-"
"RTN","PSODOSUT",185,0)
 S PSODLNNN=PSONV
"RTN","PSODOSUT",186,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA") I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",187,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2))
"RTN","PSODOSUT",188,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",189,0)
 I +PSODLNVL=3 D  Q:PSOVCAN
"RTN","PSODOSUT",190,0)
 . D SIG^XUSESIG I X1="" S (PSORX("DFLG"),PSVERFLG)=1 Q
"RTN","PSODOSUT",191,0)
 . D NOOR^PSOCAN4
"RTN","PSODOSUT",192,0)
 . I $G(DIRUT) D UPOUT^PSODGDG1,KILL^PSODGDG1 K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODOSUT",193,0)
 . S PSOVCAN=1
"RTN","PSODOSUT",194,0)
 . S DA=PSONV D RXV^PSODGDG1 S DA=PSONV D INV^PSODGDG1 S DA=PSONV D PSDEL^PSODGDG1,DEL^PSODGDG1
"RTN","PSODOSUT",195,0)
 . K DIK,LST,PSONOOR S PSVERFLG=1
"RTN","PSODOSUT",196,0)
 S PSODLNVT=$P(PSODLNVL,"^",2),PSODOSF=1
"RTN","PSODOSUT",197,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",198,0)
 S DA=PSONV,RX=$G(^PSRX(PSONV,0)) D DOSIV  ;CRI^PSODGDG1
"RTN","PSODOSUT",199,0)
 Q
"RTN","PSODOSUT",200,0)
 ;
"RTN","PSODOSUT",201,0)
DOSIV ;DOSE INTERVENTION
"RTN","PSODOSUT",202,0)
 I PSOFROM="C",'$D(^XUSEC("PSORPH",DUZ)) Q
"RTN","PSODOSUT",203,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) Q
"RTN","PSODOSUT",204,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",205,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",206,0)
DOSIV1 ;
"RTN","PSODOSUT",207,0)
 I $$EN3^PSORXI(PSODLNVT) D
"RTN","PSODOSUT",208,0)
 . W !!,"Unable to log intervention, cannot find intervention type.",!
"RTN","PSODOSUT",209,0)
 . K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",210,0)
 Q
"RTN","PSODOSUT",211,0)
 ;
"RTN","PSODOSUT",212,0)
CANCEL(PSONV) ;CR2724 -  where PSONV = RXIEN 
"RTN","PSODOSUT",213,0)
 D SIG^XUSESIG I X1="" S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",214,0)
 D NOOR^PSOCAN4
"RTN","PSODOSUT",215,0)
 I $G(DIRUT) D UPOUT^PSODGDG1,KILL^PSODGDG1 K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODOSUT",216,0)
 S DA=PSONV D INV^PSODGDG1 S DA=PSONV D PSDEL^PSODGDG1,DEL^PSODGDG1
"RTN","PSODOSUT",217,0)
 K DIK,LST,PSONOOR
"RTN","PSODOSUT",218,0)
 Q
"RTN","PSODOSUT",219,0)
 ;
"RTN","PSODOSUT",220,0)
DOSCK(PSOFROM,MSG) ;
"RTN","PSODOSUT",221,0)
 ;D HD
"RTN","PSODOSUT",222,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF
"RTN","PSODOSUT",223,0)
 I $G(PSORX("DFLG"))!($G(PSODOSD)) S PSORX("DFLG")=1 K PSODOSD Q
"RTN","PSODOSUT",224,0)
 N PSODLNNN,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSOCPXA,PSOCPXB,PSOCPXC
"RTN","PSODOSUT",225,0)
 Q:$$EXMT^PSSDSAPI(PSODRUG("IEN"))
"RTN","PSODOSUT",226,0)
 Q:$G(PSODRUG("BAD",PSODRUG("IEN")))
"RTN","PSODOSUT",227,0)
 K ^TMP($J,"PSOPDOSN"),^TMP($J,"PSOPDOSA"),^TMP("PSODOSF",$J) S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",228,0)
 I ($D(DTOUT))!($D(DUOUT))!($G(DIRUT))!($G(PSODLQT)) K PSODLQT,DTOUT,DUOUT,DIRUT,PSORX("DFLG") Q
"RTN","PSODOSUT",229,0)
 ;D CLEAR^VALM1
"RTN","PSODOSUT",230,0)
 S PSOCPXB=0
"RTN","PSODOSUT",231,0)
 I PSOFROM="V" D DCHKV Q  ;PSOVER1 - verification 
"RTN","PSODOSUT",232,0)
 I PSOFROM="N" D DCHKN Q  ;PSOORNE1 & PSOORNEW - new & copy
"RTN","PSODOSUT",233,0)
 I PSOFROM="R" D DCHKR Q  ;PSORENW0 - renewal
"RTN","PSODOSUT",234,0)
 I PSOFROM="C" D DCHKC Q  ;PSOCAN2 - cancel
"RTN","PSODOSUT",235,0)
 Q
"RTN","PSODOSUT",236,0)
 ;
"RTN","PSODOSUT",237,0)
RCONVMS(MESS) ;Convert DOSE CHECK from numeric to alpha
"RTN","PSODOSUT",238,0)
 N PSODOSF
"RTN","PSODOSUT",239,0)
 S MESS=4  ;For MOCHA 2.0, only returning "DOSAGE EXCEEDS MAX SINGLE DOSE" when a dosing error is present.
"RTN","PSODOSUT",240,0)
 S PSODOSF=$S(MESS=4:"DOSAGE EXCEEDS MAX SINGLE DOSE",MESS=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",MESS=2:"MAX SINGLE DOSE",MESS=1:"DAILY DOSE RANGE",1:"")
"RTN","PSODOSUT",241,0)
 Q PSODOSF
"RTN","PSODOSUT",242,0)
 ;
"RTN","PSODOSUT",243,0)
DOSEOFF ;
"RTN","PSODOSUT",244,0)
 S PSODONOF=$$DS^PSSDSAPI
"RTN","PSODOSUT",245,0)
DOSEOFF2 ;
"RTN","PSODOSUT",246,0)
 I $G(PSORX("DOSING OFF")),+PSODONOF K PSORX("DOSING OFF"),PSOREINF,PSOONOFC Q
"RTN","PSODOSUT",247,0)
 Q:+PSODONOF
"RTN","PSODOSUT",248,0)
 I ($G(PSOONOFC)!$G(PSOREINF)),'+PSODONOF S PSORX("DOSING OFF")=1  ;Reinstate news PSORX array so have to work around it
"RTN","PSODOSUT",249,0)
 Q:$G(PSORX("DOSING OFF"))  ;only display 'dosing off' message once per patient 
"RTN","PSODOSUT",250,0)
 N PSODOFFC
"RTN","PSODOSUT",251,0)
 I '+PSODONOF&($P(PSODONOF,"^",2)'="") D
"RTN","PSODOSUT",252,0)
 .S X=$P(PSODONOF,"^",2),DIWL=1,DIWR=73 K ^UTILITY($J,"W") D ^DIWP W !
"RTN","PSODOSUT",253,0)
 .S PSODOFFC=0 F PSODOFFC=0:0 S PSODOFFC=$O(^UTILITY($J,"W",DIWL,PSODOFFC)) Q:'PSODOFFC  W !?5,$G(^UTILITY($J,"W",DIWL,PSODOFFC,0))
"RTN","PSODOSUT",254,0)
 .N DIR,DIRUT,DUOUT,X,Y S DIR(0)="E"
"RTN","PSODOSUT",255,0)
 .S DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue"
"RTN","PSODOSUT",256,0)
 .W ! D ^DIR K DIRUT,DUOUT,DIR,X,Y W !
"RTN","PSODOSUT",257,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUT",258,0)
 .S PSORX("DOSING OFF")=1 S:$G(PSOREINS) (PSOREINF,PSOONOFC)=1  ;set this flag to only display 'dosing off' message once per session. 
"RTN","PSODOSUT",259,0)
 Q
"RTN","PSOORED3")
0^18^B61293813
"RTN","PSOORED3",1,0)
PSOORED3 ;BIR/SAB-edit finished orders through backdoor ;10/20/06 11:09am
"RTN","PSOORED3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,99,117,133,148,249,251,379,378,372,416**;DEC 1997;Build 32
"RTN","PSOORED3",3,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED3",4,0)
 ;called from psoored2
"RTN","PSOORED3",5,0)
 D DOLST
"RTN","PSOORED3",6,0)
 ;
"RTN","PSOORED3",7,0)
DOSE ;adds dosing info
"RTN","PSOORED3",8,0)
 I '$G(PSORXED("ENT")) F  S I=$O(PSORXED("DOSE",I)) Q:'I  S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORED3",9,0)
 K ROU,UNITN,STRE,PSODOSE,RTE,NOUN,VERB M PSODOSE=PSORXED
"RTN","PSOORED3",10,0)
 D KV K FIELD,DOSEOR,DOOR,X,Y,UNITS S ENT=1
"RTN","PSOORED3",11,0)
ASK S ROU="PSOORED3" D ASK^PSOBKDED K ROU I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",12,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED3",13,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED3",14,0)
 ;
"RTN","PSOORED3",15,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED3",16,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED3",17,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",18,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED3",19,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED3",20,0)
DUPD ;
"RTN","PSOORED3",21,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED3",22,0)
 D DUPD^PSOOREDX
"RTN","PSOORED3",23,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED3",24,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED3",25,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",26,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED3",27,0)
 D STR^PSOOREDX
"RTN","PSOORED3",28,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED3",29,0)
 D CNON
"RTN","PSOORED3",30,0)
 N PSONDEF
"RTN","PSOORED3",31,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED3",32,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED3",33,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",34,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED3",35,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED3",36,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED3",37,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED3",38,0)
RTE S:$G(PSORXED("ROUTE",ENT))']"" DRET=1
"RTN","PSOORED3",39,0)
 K JUMP S ROU="PSOORED3" D RTE^PSOBKDED K ROU
"RTN","PSOORED3",40,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",41,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",42,0)
 I $G(QUIT) K QUIT,ROU Q
"RTN","PSOORED3",43,0)
 ;
"RTN","PSOORED3",44,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED3",45,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",46,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED3",47,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED3",48,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED3",49,0)
 ;
"RTN","PSOORED3",50,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN MONTHS, WEEKS, DAYS, HOURS OR MINUTES)"
"RTN","PSOORED3",51,0)
 S DIR("B")=$S($G(DUR)]"":DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED3",52,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED3",53,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",54,0)
 D DUR1^PSOOREDX
"RTN","PSOORED3",55,0)
 ;
"RTN","PSOORED3",56,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED3",57,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",58,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED3",59,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED3",60,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED3",61,0)
 ;
"RTN","PSOORED3",62,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED3",63,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EXQ S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED3",64,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSOQUIT=1 G EXQ
"RTN","PSOORED3",65,0)
 I PSOSAVX="",$G(PSORXED)!$D(PSOEDDOS) K PSOCKCON
"RTN","PSOORED3",66,0)
 K PSOSAVX
"RTN","PSOORED3",67,0)
 ;
"RTN","PSOORED3",68,0)
 S DENT=$O(PSORXED("DOSE",ENT)) I DENT,(ENT+1)'=DENT D
"RTN","PSOORED3",69,0)
 .K PSORXED("DOSE",DENT),PSORXED("NOUN",DENT),PSORXED("VERB",DENT),PSORXED("DOSE ORDERED",DENT),PSORXED("ROUTE",DENT),PSORXED("ODOSE",DENT)
"RTN","PSOORED3",70,0)
 .K PSORXED("SCHEDULE",DENT),PSORXED("DURATION",DENT),PSORXED("CONJUNCTION",DENT),DENT
"RTN","PSOORED3",71,0)
 I $G(FIELD)]"" K FIELD S QUIT=1
"RTN","PSOORED3",72,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D
"RTN","PSOORED3",73,0)
 .F D=0:0 S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED3",74,0)
 D EN^PSOFSIG(.PSORXED) D VER^PSOORED7:'$G(PSOVER) I $G(CKX),'$G(PSOSIGFL) D M1 K CKX
"RTN","PSOORED3",75,0)
 ;I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",76,0)
 S:'$D(PSORXED("DAYS SUPPLY")) PSORXED("DAYS SUPPLY")=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORED3",77,0)
 ;Needed to calculate QTY
"RTN","PSOORED3",78,0)
 ;K QTY,QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",79,0)
 K QTY,QTYHLD S QTYHLD=$P(PSORXED("RX0"),"^",7) D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",80,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED3",81,0)
 I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",82,0)
 K QTYHLD Q:$G(PSOVER)!($G(PSOREEDQ))
"RTN","PSOORED3",83,0)
UDSIG I $O(SIG(0)) D
"RTN","PSOORED3",84,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED3",85,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED3",86,0)
 .D NOW^%DTC I $G(QTY) S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^Quantity Updated "_"("_$P(^PSRX(PSORXED("IRXN"),0),"^",7)_")",$P(^PSRX(PSORXED("IRXN"),0),"^",7)=$G(PSORXED("QTY")) K QTY
"RTN","PSOORED3",87,0)
 .S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED3",88,0)
 ..I '$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^") Q
"RTN","PSOORED3",89,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED3",90,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",91,0)
 .K SIG,A,I
"RTN","PSOORED3",92,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED3",93,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED3",94,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED3",95,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,1)=$G(PSORXED("ODOSE",I))
"RTN","PSOORED3",96,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1
"RTN","PSOORED3",97,0)
 G EX
"RTN","PSOORED3",98,0)
 Q
"RTN","PSOORED3",99,0)
EX ;
"RTN","PSOORED3",100,0)
 K PSORXED("DOSE"),DOSE,DUPD,SCH,PSORXED("NOUN"),PSORXED("VERB"),VERB,NOUN,PSORXED("DOSE ORDERED"),DOSEOR,PSORXED("ROUTE"),ENT,PSORTE,SIG,PSODOSE
"RTN","PSOORED3",101,0)
 K PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),DURA,X,Y,PSORXED("ODOSE")
"RTN","PSOORED3",102,0)
EX1 K STRE,UNITN,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ERTE,ROU
"RTN","PSOORED3",103,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORED3",104,0)
 Q
"RTN","PSOORED3",105,0)
EXQ K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) S PSORXED("DFLG")=1 D M1 G EX
"RTN","PSOORED3",106,0)
 Q
"RTN","PSOORED3",107,0)
M1 D M1^PSOOREDX
"RTN","PSOORED3",108,0)
 Q
"RTN","PSOORED3",109,0)
DOLST1(PSORXED) ;
"RTN","PSOORED3",110,0)
 ;
"RTN","PSOORED3",111,0)
DOLST F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),6,I)) Q:'I  S INST=^(I,0) D
"RTN","PSOORED3",112,0)
 .S PSORXED("DOSE",I)=$P(INST,"^"),PSORXED("DOSE ORDERED",I)=$P(INST,"^",2),PSORXED("UNITS",I)=$P(INST,"^",3),PSORXED("NOUN",I)=$P(INST,"^",4)
"RTN","PSOORED3",113,0)
 .I $P(INST,"^",5)]"" D
"RTN","PSOORED3",114,0)
 ..S PSORXED("DURATION",I)=$S($E($P(INST,"^",5),1)'?.N:$E($P(INST,"^",5),2,99)_$E($P(INST,"^",5),1),1:$P(INST,"^",5))
"RTN","PSOORED3",115,0)
 .S PSORXED("ROUTE",I)=$P(INST,"^",7),PSORXED("SCHEDULE",I)=$P(INST,"^",8)
"RTN","PSOORED3",116,0)
 .S PSORXED("CONJUNCTION",I)=$P(INST,"^",6),PSORXED("VERB",I)=$P(INST,"^",9),OLENT=I
"RTN","PSOORED3",117,0)
 .S PSORXED("ODOSE",I)=$G(^PSRX(PSORXED("IRXN"),6,I,1))
"RTN","PSOORED3",118,0)
 K:'$O(PSORXED("DOSE",0)) PSORXED("ENT"),OLENT
"RTN","PSOORED3",119,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORED3",120,0)
 Q
"RTN","PSOORED3",121,0)
UPDSIG ;updates sig
"RTN","PSOORED3",122,0)
 K ^PSRX(PSORXED("IRXN"),"SIG1") S ^PSRX(PSORXED("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSOORED3",123,0)
 S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1
"RTN","PSOORED3",124,0)
 S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",125,0)
 Q
"RTN","PSOORED3",126,0)
JUMP ;jump to fields
"RTN","PSOORED3",127,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED3",128,0)
 D FNM^PSOOREDX
"RTN","PSOORED3",129,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED3",130,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED3",131,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED3",132,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED3",133,0)
 G EX
"RTN","PSOORED3",134,0)
 Q
"RTN","PSOORED3",135,0)
 ;
"RTN","PSOORED3",136,0)
CNON ;
"RTN","PSOORED3",137,0)
 I $G(NOUN)'="" Q
"RTN","PSOORED3",138,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOORED3",139,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOORED3",140,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOORED3",141,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOORED3",142,0)
 I PSONLG'>3 Q
"RTN","PSOORED3",143,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOORED3",144,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOORED3",145,0)
 ;test noun of (S)
"RTN","PSOORED3",146,0)
 K NOUN ; NOT SURE ABOUT THIS???
"RTN","PSOORED3",147,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOORED3",148,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOORED3",149,0)
 Q
"RTN","PSOORED4")
0^4^B54845404
"RTN","PSOORED4",1,0)
PSOORED4 ;BIR/SAB - Edit front door dosing ;07/13/00
"RTN","PSOORED4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,91,78,99,111,117,133,159,148,251,391,372,416**;DEC 1997;Build 32
"RTN","PSOORED4",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOORED4",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED4",5,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED4",6,0)
 ;called from psoornew
"RTN","PSOORED4",7,0)
 ;
"RTN","PSOORED4",8,0)
DOSE(PSORXED) ;
"RTN","PSOORED4",9,0)
 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORED4",10,0)
 K ROU,STRE,UNITN,PSODOSE M PSODOSE=PSORXED
"RTN","PSOORED4",11,0)
 D KV K FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=PSORXED("ENT")
"RTN","PSOORED4",12,0)
ASK I $G(ORD) W !!,"Possible SIG: " D
"RTN","PSOORED4",13,0)
 .;Coded only for outside orders with no Patient Instructions
"RTN","PSOORED4",14,0)
 .I $O(SIG(""))="",$G(ORD),$P($G(^PS(52.41,ORD,"EXT")),"^")'="" D SIGS^PSOHCPRS
"RTN","PSOORED4",15,0)
 .S INST=0 F  S INST=$O(SIG(INST)) Q:'INST  S MIG=SIG(INST) D
"RTN","PSOORED4",16,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORED4",17,0)
 K SG,INST,MIG
"RTN","PSOORED4",18,0)
 S ROU="PSOORED4",II=ENT D ASK^PSOBKDED K ROU,II I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",19,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED4",20,0)
 ;
"RTN","PSOORED4",21,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED4",22,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED4",23,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",24,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED4",25,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED4",26,0)
DUPD ;
"RTN","PSOORED4",27,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED4",28,0)
 D DUPD^PSOOREDX
"RTN","PSOORED4",29,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED4",30,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED4",31,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",32,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED4",33,0)
 D STR^PSOOREDX
"RTN","PSOORED4",34,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED4",35,0)
 D CNON^PSOORED3
"RTN","PSOORED4",36,0)
 N PSONDEF
"RTN","PSOORED4",37,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED4",38,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED4",39,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",40,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED4",41,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED4",42,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED4",43,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED4",44,0)
 ;
"RTN","PSOORED4",45,0)
RTE K JUMP S ROU="PSOORED4" D RTE^PSOBKDED K ROU
"RTN","PSOORED4",46,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",47,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",48,0)
 ;
"RTN","PSOORED4",49,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED4",50,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",51,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED4",52,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED4",53,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED4",54,0)
 ;
"RTN","PSOORED4",55,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED4",56,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",57,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED4",58,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",59,0)
 D DUR1^PSOOREDX
"RTN","PSOORED4",60,0)
 ;
"RTN","PSOORED4",61,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED4",62,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",63,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED4",64,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED4",65,0)
 I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED4",66,0)
 ;
"RTN","PSOORED4",67,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED4",68,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED4",69,0)
 E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence.
"RTN","PSOORED4",70,0)
 I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOORED4",71,0)
 K PSOSAVX
"RTN","PSOORED4",72,0)
 ;
"RTN","PSOORED4",73,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED4",74,0)
 D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOORED4",75,0)
 I $G(PSOSIGFL)=1 D  I '$G(PSOSIGFL) Q
"RTN","PSOORED4",76,0)
 .I $D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOORED4",77,0)
 ..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",78,0)
 .S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOORED4",79,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED4",80,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED4",81,0)
 K QTYHLD
"RTN","PSOORED4",82,0)
 I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOORED4",83,0)
EX ;
"RTN","PSOORED4",84,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU
"RTN","PSOORED4",85,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOORED4",86,0)
 Q
"RTN","PSOORED4",87,0)
EXQ ;
"RTN","PSOORED4",88,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOORED4",89,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",90,0)
 G EX Q
"RTN","PSOORED4",91,0)
MP1 D MP1^PSOOREDX
"RTN","PSOORED4",92,0)
 Q
"RTN","PSOORED4",93,0)
VERI ;checks for changes to dosing instructions
"RTN","PSOORED4",94,0)
 S ENTS=0
"RTN","PSOORED4",95,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S ENTS=$G(ENTS)+1
"RTN","PSOORED4",96,0)
 I ENTS<OLENT!(ENTS>OLENT) S PSOSIGFL=1 Q
"RTN","PSOORED4",97,0)
 F I=1:1:OLENT D
"RTN","PSOORED4",98,0)
 .I +PSODOSE("DOSE",I)'=$G(PSORXED("DOSE",I)) S PSOSIGFL=1
"RTN","PSOORED4",99,0)
 .I $G(PSODOSE("DURATION",I))]"" D
"RTN","PSOORED4",100,0)
 ..S DURATION=$S($E(PSODOSE("DURATION",I),1)'?.N:$E(PSODOSE("DURATION",I),2,99)_$E(PSODOSE("DURATION",I),1),1:PSODOSE("DURATION",I))
"RTN","PSOORED4",101,0)
 ..I +DURATION'=+$G(PSORXED("DURATION",I)) S PSOSIGFL=1
"RTN","PSOORED4",102,0)
 .I $G(PSODOSE("CONJUNCTION",I))'=$G(PSORXED("CONJUNCTION",I)) S PSOSIGFL=1
"RTN","PSOORED4",103,0)
 .I PSODOSE("ROUTE",I)'=$G(PSORXED("ROUTE",I)) S PSOSIGFL=1
"RTN","PSOORED4",104,0)
 .I PSODOSE("SCHEDULE",I)'=$G(PSORXED("SCHEDULE",I)) S PSOSIGFL=1
"RTN","PSOORED4",105,0)
 K DURATION Q
"RTN","PSOORED4",106,0)
JUMP ;jump to fields
"RTN","PSOORED4",107,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED4",108,0)
 D FNM^PSOOREDX
"RTN","PSOORED4",109,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED4",110,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED4",111,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED4",112,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED4",113,0)
 G EX
"RTN","PSOORED4",114,0)
 Q
"RTN","PSOORED4",115,0)
HLP ;help text for med route
"RTN","PSOORED4",116,0)
 D FULL^VALM1 W !,"Please enter how patient will use the medication!"
"RTN","PSOORED4",117,0)
 S DIC=51.2,X="??",DIC(0)="M",DIC("S")="I $P(^PS(51.2,+Y,0),""^"",4)" D ^DIC K DIC,X,Y
"RTN","PSOORED4",118,0)
 Q
"RTN","PSOORED4",119,0)
SCHLP ;
"RTN","PSOORED4",120,0)
 D FULL^VALM1 W !,"You can choose an entry from the Administration Schedule File (#51.1),",!,"Medication Instruction File (#51) or enter free text."
"RTN","PSOORED4",121,0)
 W !,"The free text entry cannot contain more than 2 spaces or be greater than 20",!,"characters in length."
"RTN","PSOORED4",122,0)
 W ! S DIR(0)="S^A:Administration Schedule File;M:Medication Instruction File;B:Both;F:Free Text",DIR("B")="Both"
"RTN","PSOORED4",123,0)
 S DIR("A")="Do you want to list from" D ^DIR I Y="F"!($G(DIRUT)) K X,Y G X
"RTN","PSOORED4",124,0)
 S LBL=Y G @LBL
"RTN","PSOORED4",125,0)
A ;display 51.1 entries only
"RTN","PSOORED4",126,0)
B K X,Y,DIC S X="??",DIC="^PS(51.1,",DIC(0)="QES",DIC("W")="D DICW^PSOORED4",D="APPSJ" W ! D IX^DIC
"RTN","PSOORED4",127,0)
 K DIC,X I LBL="A"!($G(DTOUT)) K LBL G X
"RTN","PSOORED4",128,0)
 I Y=-1!($G(DUOUT)) K DIR,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to continue with the Medication Instruction File"
"RTN","PSOORED4",129,0)
 D ^DIR I 'Y!($G(DTOUT)) K DIR,X,Y G X
"RTN","PSOORED4",130,0)
M K X,Y,DIC S DIC=51,X="??",DIC(0)="M" D ^DIC K DIC,X,Y,DTOUT,DUOUT,LBL
"RTN","PSOORED4",131,0)
X S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>3)!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOORED4",132,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",133,0)
 Q
"RTN","PSOORED4",134,0)
DICW ;
"RTN","PSOORED4",135,0)
 S Z=$P(^PS(51.1,+Y,0),"^",5),Z=$S(Z="O":-1,Z="S":1,Z="R":-2,1:0) W:Z "  ",$S(Z>0:"SHIFT",Z=-2:"RANGE",1:"ONE-TIME")
"RTN","PSOORED4",136,0)
 I Z'<0,$D(PSJW),$D(^(PSJPP'="PSJ"+1,PSJW,0)),$P(^(0),"^",Z+2)]"" W "  ",$P(^(0),"^",Z+2)
"RTN","PSOORED4",137,0)
 ;Naked reference on DICW+2 is from DICW+1, ^PS(51.1,+Y,0)
"RTN","PSOORED4",138,0)
 Q
"RTN","PSOORED5")
0^19^B58804005
"RTN","PSOORED5",1,0)
PSOORED5 ;BIR/SAB-Rxs without dosing info ;07/20/00
"RTN","PSOORED5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,75,78,100,99,117,133,251,378,372,416**;DEC 1997;Build 32
"RTN","PSOORED5",3,0)
 ;^PS(51.2 - DBIA 2226
"RTN","PSOORED5",4,0)
 ;^PS(50.7 - DBIA 2223
"RTN","PSOORED5",5,0)
 ;^PSDRUG - DBIA 221
"RTN","PSOORED5",6,0)
 ;^PS(55 - DBIA 2228
"RTN","PSOORED5",7,0)
 ;called by psoored2 and psodir
"RTN","PSOORED5",8,0)
 ;pre-poe rxs and new backdoor rxs
"RTN","PSOORED5",9,0)
DOSE1(PSORXED) ;for new rxs
"RTN","PSOORED5",10,0)
DOSE ;pre-poe rx
"RTN","PSOORED5",11,0)
 D KV K ROU,STRE,FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=ENT
"RTN","PSOORED5",12,0)
ASK S ROU="PSOORED5" D ASK^PSOBKDED K ROU G:$D(DIRUT) EX
"RTN","PSOORED5",13,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED5",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED5",15,0)
 ;
"RTN","PSOORED5",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED5",17,0)
 I $G(PSORX("EDIT"))']"" W:$G(PSORXED("VERB",ENT))]"" !,"VERB: "_PSORXED("VERB",ENT) G DUPD
"RTN","PSOORED5",18,0)
VER D VER^PSOOREDX
"RTN","PSOORED5",19,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED5",20,0)
 G:$D(DTOUT)!($D(DUOUT)) EX I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED5",21,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED5",22,0)
DUPD ;
"RTN","PSOORED5",23,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED5",24,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOORED5",25,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOORED5",26,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),$G(DUPD)]"":DUPD,1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED5",27,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED5",28,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",29,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED5",30,0)
 D STR^PSOOREDX
"RTN","PSOORED5",31,0)
 ;
"RTN","PSOORED5",32,0)
NOU1 G:'$D(DUPD) RTE D CNON^PSOORED3 N PSONDEF
"RTN","PSOORED5",33,0)
 I $G(NOUN)]"",$G(PSORX("EDIT"))']"" S PSORXED("NOUN",ENT)=NOUN W !,"NOUN: "_$G(NOUN) G RTE
"RTN","PSOORED5",34,0)
 I $G(PSORX("EDIT"))']"",$G(PSORXED("NOUN",ENT))]"" W !,"NOUN: "_PSORXED("NOUN",ENT) G RTE
"RTN","PSOORED5",35,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED5",36,0)
 G:$D(DTOUT)!($D(DUOUT)) EX I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED5",37,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED5",38,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED5",39,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED5",40,0)
 ;
"RTN","PSOORED5",41,0)
RTE I $G(ENT)>1,$G(PSORX("EDIT"))']"",$G(PSORXED("ROUTE",ENT-1)),$G(PSORXED("ROUTE",ENT))']"" S PSORXED("ROUTE",ENT)=PSORXED("ROUTE",ENT-1) G SCH
"RTN","PSOORED5",42,0)
 I '$G(DRET),'$G(PSORXED("ROUTE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",6) S PSORXED("ROUTE",ENT)=$P(^PS(50.7,PSODRUG("OI"),0),"^",6)
"RTN","PSOORED5",43,0)
 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOORED5",44,0)
 I $G(RTE) K RTE
"RTN","PSOORED5",45,0)
 D KV S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOORED5",46,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",47,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE" G JUMP
"RTN","PSOORED5",48,0)
 I $D(DTOUT)!($D(DUOUT)) S PSODIR("DFLG")=1 Q
"RTN","PSOORED5",49,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" G SCH
"RTN","PSOORED5",50,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),ERTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^",2) W X_" "_$G(ERTE) G SCH
"RTN","PSOORED5",51,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOORED5",52,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOORED5",53,0)
 ;
"RTN","PSOORED5",54,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED5",55,0)
 G:$D(DTOUT)!($D(DUOUT)) EX S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED5",56,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED5",57,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED5",58,0)
 ;
"RTN","PSOORED5",59,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED5",60,0)
 S DIR("B")=$S($D(DUR):DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",61,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED5",62,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",63,0)
 D DUR1^PSOOREDX
"RTN","PSOORED5",64,0)
 ;
"RTN","PSOORED5",65,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED5",66,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",67,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED5",68,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED5",69,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EX G:'Y CON S:'$G(COPY) PSOSIGFL=1 D UPD^PSOOREDX G CON
"RTN","PSOORED5",70,0)
 ;
"RTN","PSOORED5",71,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED5",72,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED5",73,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSORXED("DFLG")=1,PSORX("DFLG")=1 G EX
"RTN","PSOORED5",74,0)
 I PSOSAVX="",$G(PSORXED)!($D(PSOEDDOS)) K PSOCKCON
"RTN","PSOORED5",75,0)
 K PSOSAVX
"RTN","PSOORED5",76,0)
 ;
"RTN","PSOORED5",77,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED5",78,0)
 D EN^PSOFSIG(.PSORXED) I $O(SIG(0)) S PSORXED("ENT")=ENT,SIGOK=1
"RTN","PSOORED5",79,0)
 Q:$G(PSOREEDT)!($G(PSOORRNW))
"RTN","PSOORED5",80,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED5",81,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED5",82,0)
 K QTYHLD Q:$G(PSOFROM)="NEW"!($G(COPY))!($G(PSOFROM))!($G(PSOREEDT))
"RTN","PSOORED5",83,0)
 Q:$G(PSOSIGFL)  D
"RTN","PSOORED5",84,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED5",85,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED5",86,0)
 .S:'$D(^PSRX(PSORXED("IRXN"),"A",0)) ^PSRX(PSORXED("IRXN"),"A",0)="^52.3DA^"
"RTN","PSOORED5",87,0)
 .S $P(^PSRX(PSORXED("IRXN"),"A",0),"^",3)=$P($G(^PSRX(PSORXED("IRXN"),"A",0)),"^",3)+1,$P(^(0),"^",4)=$P($G(^(0)),"^",4)+1
"RTN","PSOORED5",88,0)
 .D NOW^%DTC S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED5",89,0)
 ..I '$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^") Q
"RTN","PSOORED5",90,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED5",91,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1" K SIG,A,I
"RTN","PSOORED5",92,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED5",93,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED5",94,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED5",95,0)
 .I $G(PSORXED("DOSE",I))]"" S ^PSRX(PSORXED("IRXN"),6,I,1)=PSORXED("DOSE",I)
"RTN","PSOORED5",96,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1 G EX
"RTN","PSOORED5",97,0)
 Q
"RTN","PSOORED5",98,0)
EX I $D(DUOUT)!($D(DTOUT)) S PSONEW("DFLG")=1
"RTN","PSOORED5",99,0)
 ;I $D(DUOUT)!($D(DTOUT)) S:'$G(PSORX("EDIT")) PSONEW("DFLG")=1
"RTN","PSOORED5",100,0)
 G:$G(PSOSIGFL)!($G(PSORX("EDIT")))!($G(PSORXED))!($G(PSOREEDT)) EX1
"RTN","PSOORED5",101,0)
 K PSORXED("DOSE"),PSORXED("NOUN"),PSORXED("VERB"),PSORXED("DOSE ORDERED"),PSORXED("ROUTE"),SIG,PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),PSORXED("ODOSE")
"RTN","PSOORED5",102,0)
EX1 K UNITN,STRE,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ENT,PSORTE,DURA,ERTE,ROU
"RTN","PSOORED5",103,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED5",104,0)
 Q
"RTN","PSOORED5",105,0)
UPD ;updates dosing array
"RTN","PSOORED5",106,0)
 D UPD^PSOORED6
"RTN","PSOORED5",107,0)
 Q
"RTN","PSOORED5",108,0)
JUMP ;
"RTN","PSOORED5",109,0)
 I $G(PSORXED("SCHEDULE",1))']"" W $C(7),!!,"All Dosing Instructions must be entered before Jumping to other Fields!",!! G @FIELD
"RTN","PSOORED5",110,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED5",111,0)
 D FNM^PSOOREDX
"RTN","PSOORED5",112,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED5",113,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED5",114,0)
 D KV
"RTN","PSOORED5",115,0)
 I $G(PSOFROM)'="NEW",'$G(COPY) S DIR("A",1)="* Indicates which fields will create a New Order"
"RTN","PSOORED5",116,0)
 S DIR("A")="Select Field by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED5",117,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED5",118,0)
 G EX
"RTN","PSOORED5",119,0)
 Q
"RTN","PSOORED5",120,0)
LAN ;
"RTN","PSOORED5",121,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOORED5",122,0)
 I $G(OR0),'$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D  K QI,QII Q
"RTN","PSOORED5",123,0)
 .Q:$G(OTHDOS(II))
"RTN","PSOORED5",124,0)
 .F QI=0:0 S QI=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",QI)) Q:'QI  D  Q:$G(QII)
"RTN","PSOORED5",125,0)
 ..Q:$G(PSONEW("DOSE",II))']""
"RTN","PSOORED5",126,0)
 ..I PSONEW("DOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^") S PSONEW("ODOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^",4),QII=1
"RTN","PSOORED5",127,0)
 I $G(Y),$P($G(DOSE(Y)),"^",13)]"" S PSORXED("ODOSE",ENT)=$P(DOSE(Y),"^",13) Q
"RTN","PSOORED5",128,0)
 K QII F I=0:0 S I=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",I)) Q:'I  I DOSE=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^") D  Q:$G(QII)
"RTN","PSOORED5",129,0)
 .S PSORXED("ODOSE",ENT)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^",4),QII=1
"RTN","PSOORED5",130,0)
 K QII,I
"RTN","PSOORED5",131,0)
 Q
"RTN","PSOORED5",132,0)
 ;
"RTN","PSOORFI5")
0^1^B47164460
"RTN","PSOORFI5",1,0)
PSOORFI5 ;BIR/SJA-finish cprs orders ; 8/27/08 4:47pm
"RTN","PSOORFI5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,315,266,391,372,416**;DEC 1997;Build 32
"RTN","PSOORFI5",3,0)
 ;External references UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORFI5",4,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOORFI5",5,0)
 ;
"RTN","PSOORFI5",6,0)
FLG W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="FLAGGED^FLAGGED"
"RTN","PSOORFI5",7,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",8,0)
 .Q:'$D(^PS(52.41,PSOD,0))!('$P($G(^PS(52.41,PSOD,0)),"^",23))
"RTN","PSOORFI5",9,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",10,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",11,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",12,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",13,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",14,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",15,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",16,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",17,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",18,0)
 ..I $P($G(^PS(52.41,ORD,0)),"^",23) D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",19,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",20,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",21,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",22,0)
 G EX
"RTN","PSOORFI5",23,0)
 ;
"RTN","PSOORFI5",24,0)
PRI ; Called from PSOORFIN due to it's routine size.
"RTN","PSOORFI5",25,0)
 K DIR S PSOSORT="PRIORITY"
"RTN","PSOORFI5",26,0)
 S DIR("A")="Select Priority",DIR(0)="SBM^S:STAT;E:EMERGENCY;R:ROUTINE",DIR("B")="ROUTINE"
"RTN","PSOORFI5",27,0)
 D ^DIR G:$D(DIRUT) EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFI5",28,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",29,0)
 .Q:$P($G(^PS(52.41,PSOD,0)),"^",23)
"RTN","PSOORFI5",30,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",31,0)
 .;PSO*7*266
"RTN","PSOORFI5",32,0)
 .I PAT'=PATA K PSORX("DOSING OFF") D LBL^PSOORFIN
"RTN","PSOORFI5",33,0)
 .I '$O(^PS(52.41,"AP",PAT,PSRT,0)) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",34,0)
 .D PRI^PSOORFI2 I $G(PSZFIN) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",35,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",36,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP Q
"RTN","PSOORFI5",37,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",38,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",39,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",40,0)
 .D PP S ORD=0 D @PSRT S PAT(PAT)=PAT
"RTN","PSOORFI5",41,0)
 .S X=PAT D ULP
"RTN","PSOORFI5",42,0)
 ;PSO*7*266
"RTN","PSOORFI5",43,0)
 D LBL^PSOORFIN
"RTN","PSOORFI5",44,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",45,0)
EX D EX^PSOORFI1
"RTN","PSOORFI5",46,0)
 Q
"RTN","PSOORFI5",47,0)
LK D LOCK^PSOORFI1
"RTN","PSOORFI5",48,0)
 Q
"RTN","PSOORFI5",49,0)
LK1 D LOCK1^PSOORFI1 Q
"RTN","PSOORFI5",50,0)
QU I $G(PSOQUIT) S POERR("QFLG")=1 K PSOQUIT
"RTN","PSOORFI5",51,0)
 S:$G(PSOQFLG) PAT(PAT)=PAT
"RTN","PSOORFI5",52,0)
 Q
"RTN","PSOORFI5",53,0)
ULP K PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOORFI5",54,0)
 D CLEAN^PSOVER1
"RTN","PSOORFI5",55,0)
 I '$G(X) Q
"RTN","PSOORFI5",56,0)
 D UL^PSSLOCK(X) Q
"RTN","PSOORFI5",57,0)
KLL K PSOPTLOK
"RTN","PSOORFI5",58,0)
 Q
"RTN","PSOORFI5",59,0)
KLLP K PSONOLCK
"RTN","PSOORFI5",60,0)
 Q
"RTN","PSOORFI5",61,0)
SPL D SPL^PSOORFI4
"RTN","PSOORFI5",62,0)
 Q
"RTN","PSOORFI5",63,0)
SDFN S PSODFN=+$G(PSODFN)
"RTN","PSOORFI5",64,0)
 Q
"RTN","PSOORFI5",65,0)
PP D PP^PSOORFI4
"RTN","PSOORFI5",66,0)
 Q
"RTN","PSOORFI5",67,0)
KQ K PSOQUIT,POERR("QFLG")
"RTN","PSOORFI5",68,0)
 Q
"RTN","PSOORFI5",69,0)
S D S^PSOORFI2 ; Process STAT priority
"RTN","PSOORFI5",70,0)
 Q
"RTN","PSOORFI5",71,0)
 ;
"RTN","PSOORFI5",72,0)
E D E^PSOORFI2 ; Process EMERGENCY priority
"RTN","PSOORFI5",73,0)
 Q
"RTN","PSOORFI5",74,0)
 ;
"RTN","PSOORFI5",75,0)
R D R^PSOORFI2 ; Process ROUTINE priority
"RTN","PSOORFI5",76,0)
 Q
"RTN","PSOORFI5",77,0)
 ;
"RTN","PSOORFI5",78,0)
LMDISP(ORD) ; Backdoor ListManager Display of Flag/Unflag Information
"RTN","PSOORFI5",79,0)
 N FLAG
"RTN","PSOORFI5",80,0)
 K FLAGLINE S ORD=+$G(ORD) I 'ORD Q
"RTN","PSOORFI5",81,0)
 ;
"RTN","PSOORFI5",82,0)
 I '$G(^PS(52.41,ORD,"FLG")) Q
"RTN","PSOORFI5",83,0)
 ; S X=IORVON_"Flagged"_IORVOFF
"RTN","PSOORFI5",84,0)
 D GETS^DIQ(52.41,ORD,"33;34;35;36;37;38","IE","FLAG")
"RTN","PSOORFI5",85,0)
 S L1="Flagged by "_$E(FLAG(52.41,ORD_",",34,"E"),1,30)_" on "_$$FMTE^XLFDT(FLAG(52.41,ORD_",",33,"I"),2)_": "
"RTN","PSOORFI5",86,0)
 S LEN=80-$L(L1),L1=L1_$E(FLAG(52.41,ORD_",",35,"E"),1,LEN),L2=$E(FLAG(52.41,ORD_",",35,"E"),LEN+1,999)
"RTN","PSOORFI5",87,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L1,FLAGLINE(IEN)=7
"RTN","PSOORFI5",88,0)
 I L2'="" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L2
"RTN","PSOORFI5",89,0)
 I FLAG(52.41,ORD_",",36,"I")'="" D
"RTN","PSOORFI5",90,0)
 . S L1="Unflagged by "_$E(FLAG(52.41,ORD_",",37,"E"),1,30)_" on "_$$FMTE^XLFDT(FLAG(52.41,ORD_",",36,"I"),2)_": "
"RTN","PSOORFI5",91,0)
 . S LEN=80-$L(L1),L1=L1_$E(FLAG(52.41,ORD_",",38,"E"),1,LEN),L2=$E(FLAG(52.41,ORD_",",38,"E"),LEN+1,999)
"RTN","PSOORFI5",92,0)
 . S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L1,FLAGLINE(IEN)=9
"RTN","PSOORFI5",93,0)
 . I L2'="" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L2
"RTN","PSOORFI5",94,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" "
"RTN","PSOORFI5",95,0)
 Q
"RTN","PSOORFI5",96,0)
 ;
"RTN","PSOORFI5",97,0)
CS ; Digitally Signed CS - PSO*7*391
"RTN","PSOORFI5",98,0)
 K DIR N PSOCSRT S DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;B:BOTH;E:EXIT",DIR("B")="BOTH" D ^DIR
"RTN","PSOORFI5",99,0)
 Q:$D(DIRUT)!(Y="E")
"RTN","PSOORFI5",100,0)
 S PSOCSRT=$S(Y="B":1,1:Y)
"RTN","PSOORFI5",101,0)
 W !!,"Select a schedule(s)"
"RTN","PSOORFI5",102,0)
 K DIR S PSOSORT="DIGITALLY SIGNED"
"RTN","PSOORFI5",103,0)
 S DIR("A")="Select Schedule(s)",DIR(0)="S^1:SCHEDULE II;2:SCHEDULES III - V;3:SCHEDULES II - V;E:EXIT",DIR("B")=3
"RTN","PSOORFI5",104,0)
 D ^DIR G:$D(DIRUT)!(Y="E") EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFI5",105,0)
 N PDEA,OR0 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",106,0)
 .Q:'$D(^PS(52.41,PSOD,0))
"RTN","PSOORFI5",107,0)
 .S OR0=^PS(52.41,PSOD,0)
"RTN","PSOORFI5",108,0)
 .Q:$P(OR0,"^",23)!('$P(OR0,"^",24))
"RTN","PSOORFI5",109,0)
 .S PDEA=0 D PDEA Q:'PDEA!(PDEA'=PSRT)
"RTN","PSOORFI5",110,0)
 .I 'PSOCSRT,PSOCSRT'=$P(OR0,"^",17) Q
"RTN","PSOORFI5",111,0)
 .Q:$G(PAT($P(OR0,"^",2)))=$P(OR0,"^",2)  S PAT=$P(OR0,"^",2)
"RTN","PSOORFI5",112,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",113,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",114,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",115,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",116,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",117,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",118,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",119,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",120,0)
 ..Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFI5",121,0)
 ..S OR0=^PS(52.41,ORD,0)
"RTN","PSOORFI5",122,0)
 ..Q:$P(OR0,"^",23)!('$P(OR0,"^",24))
"RTN","PSOORFI5",123,0)
 ..I 'PSOCSRT,PSOCSRT'=$P(OR0,"^",17) Q
"RTN","PSOORFI5",124,0)
 ..Q:$P(OR0,"^",3)="DC"!($P(OR0,"^",3)="DE")
"RTN","PSOORFI5",125,0)
 ..S PDEA=0 D PDEA Q:'PDEA!(PDEA'=PSRT)
"RTN","PSOORFI5",126,0)
 ..D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",127,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",128,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",129,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",130,0)
 G EX
"RTN","PSOORFI5",131,0)
 ;
"RTN","PSOORFI5",132,0)
PDEA ;
"RTN","PSOORFI5",133,0)
 I +$P(OR0,"^",9) S PDEA=$P($G(^PSDRUG($P(OR0,"^",9),0)),"^",3),PDEA=$S(PDEA[2:1,PDEA[3!(PDEA[4)!(PDEA[5):2,1:0)
"RTN","PSOORFI5",134,0)
 E  S PDEA=$$OIDEA^PSSUTLA1($P(OR0,"^",8),"O")
"RTN","PSOORFI5",135,0)
 I PDEA,PSRT=3 S PDEA=3
"RTN","PSOORFI5",136,0)
 Q
"RTN","PSOORFI5",137,0)
 ;
"RTN","PSOORFI5",138,0)
PRV(PROV,DRG,ORN) ;
"RTN","PSOORFI5",139,0)
 N DETN,DEA,I,LBL,VADD,SPC
"RTN","PSOORFI5",140,0)
 I PROV="" Q
"RTN","PSOORFI5",141,0)
 S DEA=$$DEA^XUSER(0,PROV)
"RTN","PSOORFI5",142,0)
 S LBL=$S(DEA["-":" VA#: ",1:"DEA#: ") I $G(ADDS) S LBL=" "_LBL
"RTN","PSOORFI5",143,0)
 I DRG,$$DETOX^PSSOPKI(DRG) S DETN=$$DETOX^XUSER(PROV)
"RTN","PSOORFI5",144,0)
 S $P(SPC," ",($S($G(ADDS):30,1:33)-$L(DEA)))=" "
"RTN","PSOORFI5",145,0)
 I (DEA'="")!($G(DETN)'="") S IEN=IEN+1,$E(^TMP("PSOPO",$J,IEN,0),16)=LBL_DEA_$S($G(DETN)]"":SPC_"DETOX#: "_$G(DETN),1:"")
"RTN","PSOORFI5",146,0)
 I $G(ORN) D PRVAD^PSOPKIV2 I $G(VADD(1))]"" D
"RTN","PSOORFI5",147,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"       Site Address: "_VADD(1)
"RTN","PSOORFI5",148,0)
 .S:VADD(2)'="" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"                     "_VADD(2) S:VADD(3)'="" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"                     "_VADD(3)
"RTN","PSOORFI5",149,0)
 Q
"RTN","PSOORFI5",150,0)
 ;
"RTN","PSOORFIN")
0^5^B63913344
"RTN","PSOORFIN",1,0)
PSOORFIN ;BIR/SAB-finish cprs orders ; 8/27/08 4:57pm
"RTN","PSOORFIN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,15,27,32,44,46,84,106,111,117,131,146,139,195,225,315,266,338,391,372,416**;DEC 1997;Build 32
"RTN","PSOORFIN",3,0)
 ;PSSLOCK-2789,PSDRUG-221,50.7-2223,55-2228,50.606-2174
"RTN","PSOORFIN",4,0)
 ;PSO*7*266 Change order of calling ^PSOBING1 and ^PSORXL
"RTN","PSOORFIN",5,0)
 ;
"RTN","PSOORFIN",6,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) D MSG^PSODPT G EX
"RTN","PSOORFIN",7,0)
 D INST^PSOORFI2 I $G(PSOIQUIT) K PSOIQUIT G EX
"RTN","PSOORFIN",8,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSOORFIN",9,0)
 S (PSOFIN,POERR)=1
"RTN","PSOORFIN",10,0)
 K PSOBCK,MEDA,MEDP,SRT,DIR D KQ
"RTN","PSOORFIN",11,0)
 S DIR("?")="^D ST^PSOORFI1",DIR("A")="Select By",DIR("B")="PATIENT"
"RTN","PSOORFIN",12,0)
 S DIR(0)="SMB^PA:PATIENT;RT:ROUTE;PR:PRIORITY;CL:CLINIC;FL:FLAGGED;CS:CONTROLLED SUBSTANCES;E:EXIT"
"RTN","PSOORFIN",13,0)
 D ^DIR I $D(DIRUT)!(Y="E") G EX
"RTN","PSOORFIN",14,0)
 K:Y="FL" ^TMP($J,"PSOFLPO") ;file not needed when selection="FL"
"RTN","PSOORFIN",15,0)
 G:Y="PA" PAT G:Y="PR" PRI^PSOORFI5 G:Y="CL" ^PSOORFI3 G:Y="FL" FLG^PSOORFI5 G:Y="CS" CS^PSOORFI5
"RTN","PSOORFIN",16,0)
 K DIR S PSOSORT="ROUTE"
"RTN","PSOORFIN",17,0)
 S DIR("?")="^D RT^PSOORFI1",DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;C:CLINIC;E:EXIT",DIR("B")="WINDOW"
"RTN","PSOORFIN",18,0)
 D ^DIR G:$D(DIRUT)!(Y="E") EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFIN",19,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFIN",20,0)
 .Q:$P($G(^PS(52.41,PSOD,0)),"^",23)
"RTN","PSOORFIN",21,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFIN",22,0)
 .;PSO*7*266
"RTN","PSOORFIN",23,0)
 .I PAT'=PATA D LBL
"RTN","PSOORFIN",24,0)
 .I '$O(^PS(52.41,"AC",PAT,PSRT,0)) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",25,0)
 .D RTE^PSOORFI2 I $G(PSZFIN) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",26,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",27,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP Q
"RTN","PSOORFIN",28,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFIN",29,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFIN",30,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFIN",31,0)
 .D PP S ORD=0 D @PSRT S PAT(PAT)=PAT
"RTN","PSOORFIN",32,0)
 .S X=PAT D ULP
"RTN","PSOORFIN",33,0)
 ;PSO*7*266
"RTN","PSOORFIN",34,0)
 K POERR("QFLG"),PSOQFLG,PSOPTPST,MAIL,WIN,CLI D LBL
"RTN","PSOORFIN",35,0)
 I $G(PSOQUIT) K PSOQUIT D EX G PSOORFIN
"RTN","PSOORFIN",36,0)
EX D EX^PSOORFI1
"RTN","PSOORFIN",37,0)
 Q
"RTN","PSOORFIN",38,0)
W D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S MAIL=1
"RTN","PSOORFIN",39,0)
 Q:$G(POERR("QFLG"))  I $G(MAIL) S ORD=0 D
"RTN","PSOORFIN",40,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",41,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",42,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",43,0)
 Q
"RTN","PSOORFIN",44,0)
M D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S WIN=1
"RTN","PSOORFIN",45,0)
 Q:$G(POERR("QFLG"))  I $G(WIN) S ORD=0 D
"RTN","PSOORFIN",46,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD
"RTN","PSOORFIN",47,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",48,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",49,0)
 Q
"RTN","PSOORFIN",50,0)
C D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S CLI=1
"RTN","PSOORFIN",51,0)
 Q:$G(POERR("QFLG"))  I $G(CLI) S ORD=0 D
"RTN","PSOORFIN",52,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD
"RTN","PSOORFIN",53,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",54,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",55,0)
 Q
"RTN","PSOORFIN",56,0)
PAT W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="PATIENT"
"RTN","PSOORFIN",57,0)
 S DIR("?")="^D PT^PSOORFI1",DIR("A")="All Patients or Single Patient",DIR(0)="SBM^A:ALL;S:SINGLE;E:EXIT",DIR("B")="SINGLE"
"RTN","PSOORFIN",58,0)
 D ^DIR K DIR G:$D(DIRUT)!(Y="E") EX I Y="S" S PSOSORT=PSOSORT_"^"_"SINGLE" G SPAT
"RTN","PSOORFIN",59,0)
 S PSOSORT=PSOSORT_"^ALL"
"RTN","PSOORFIN",60,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFIN",61,0)
 .Q:'$D(^PS(52.41,PSOD,0))!($P($G(^PS(52.41,PSOD,0)),"^",23))
"RTN","PSOORFIN",62,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFIN",63,0)
 .;PSO*7*266
"RTN","PSOORFIN",64,0)
 .I PAT'=PATA D LBL
"RTN","PSOORFIN",65,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",66,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFIN",67,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFIN",68,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFIN",69,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFIN",70,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFIN",71,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFIN",72,0)
 ..I '$P($G(^PS(52.41,ORD,0)),"^",23) D PP,LK1,ORD
"RTN","PSOORFIN",73,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFIN",74,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL
"RTN","PSOORFIN",75,0)
 I $G(PSOQUIT) K PSOQUIT D EX G PSOORFIN
"RTN","PSOORFIN",76,0)
 G EX
"RTN","PSOORFIN",77,0)
 ;PSO*7*266 kill BINGCRT,BINGRTE when selecting pat.
"RTN","PSOORFIN",78,0)
SPAT K MEDA,MEDP,PSOQFLG,PSORX("FN"),BINGCRT,BINGRTE D KQ,KV^PSOVER1
"RTN","PSOORFIN",79,0)
 S DIR(0)="FO^2:30",DIR("A")="Select Patient",DIR("?")="^D HELP^PSOORFI2" D ^DIR I $E(X)="?" G SPAT
"RTN","PSOORFIN",80,0)
 G:$D(DIRUT) EX D KV^PSOVER1
"RTN","PSOORFIN",81,0)
 S DIC(0)="EQM",DIC=2,DIC("S")="I $D(^PS(52.41,""AOR"",+Y,PSOPINST))"
"RTN","PSOORFIN",82,0)
 D ^DIC K DIC G:"^"[X EX G:Y=-1 SPAT S (PSODFN,PAT)=+Y,PSOFINY=Y
"RTN","PSOORFIN",83,0)
 D LK I $G(POERR("QFLG")) G SPAT
"RTN","PSOORFIN",84,0)
 N SNGLPAT S SNGLPAT=1
"RTN","PSOORFIN",85,0)
 ;PSO*7*266
"RTN","PSOORFIN",86,0)
 D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSOFINY I $G(MEDP) D SPL D OERR^PSORX1 D LBL S PSOFIN=1,X=PSOPTLOK D KLLP,ULP,KLL G SPAT
"RTN","PSOORFIN",87,0)
 D PP,SDFN,POST^PSOORFI1 D:$G(PSOQFLG)  G:$G(PSOQFLG) EX I $G(PSOQUIT) S:$G(PSOQUIT) POERR("QFLG")=1 S X=PAT D ULP G SPAT
"RTN","PSOORFIN",88,0)
 .S X=PAT D ULP
"RTN","PSOORFIN",89,0)
 S ORD=0 F  S ORD=$O(^PS(52.41,"P",PAT,ORD)) Q:'ORD!($G(POERR("QFLG")))  D:'$P($G(^PS(52.41,ORD,0)),"^",23)
"RTN","PSOORFIN",90,0)
 .D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE")&($P(^(0),"^",3)'="HD") LK1,ORD
"RTN","PSOORFIN",91,0)
 ;PSO*7*266
"RTN","PSOORFIN",92,0)
 D LBL
"RTN","PSOORFIN",93,0)
 S PSOFIN=1,X=PAT D ULP G SPAT
"RTN","PSOORFIN",94,0)
ORD I $G(PSOBCK) N LST,ORN
"RTN","PSOORFIN",95,0)
 E  S PSOLOUD=1 D:$P($G(^PS(55,PAT,0)),"^",6)'=2 EN^PSOHLUP(PAT) K PSOLOUD
"RTN","PSOORFIN",96,0)
 K DRET,SIG,^TMP("PSORXDC",$J) Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFIN",97,0)
 I $G(PSOFIN),$P($G(^PS(52.41,ORD,"INI")),"^")'=$G(PSOPINST) Q
"RTN","PSOORFIN",98,0)
 D L1^PSOORFI3 I '$G(PSOMSG) K PSOMSG Q
"RTN","PSOORFIN",99,0)
 I '$D(^PS(52.41,ORD,0)) K PSOMSG Q
"RTN","PSOORFIN",100,0)
 K DRET,SIG,PSOPRC,PHI,PRC,PSOSIGFL,OBX,PSOMSG,PSOFOERR S OR0=^PS(52.41,ORD,0)
"RTN","PSOORFIN",101,0)
 I $P(OR0,"^",24),($P(OR0,"^",3)="RNW"!($P(OR0,"^",3)="NW")) N PKI,PKI1,PKIR,PKIE,PKID S PKI=0 D CER^PSOPKIV1 I PKI<1 D UL1^PSOORFI3 K OR0 Q
"RTN","PSOORFIN",102,0)
 S (PSOFOERR,PSOFDR)=1,OI=$P(OR0,"^",8),PSORX("SC")=$P(OR0,"^",16)
"RTN","PSOORFIN",103,0)
 I $O(^PS(52.41,ORD,2,0)) S PHI=^PS(52.41,ORD,2,0),T=0 F  S T=$O(^PS(52.41,ORD,2,T)) Q:'T  S PHI(T)=^PS(52.41,ORD,2,T,0)
"RTN","PSOORFIN",104,0)
 I $P($G(^PS(52.41,ORD,"EXT")),"^")'="" K PHI I $O(^PS(52.41,ORD,"SIG",0)) S PHI=$G(^PS(52.41,ORD,"SIG",0)),T=0 F  S T=$O(^PS(52.41,ORD,"SIG",T)) Q:'T  S PHI(T)=$G(^PS(52.41,ORD,"SIG",T,0))
"RTN","PSOORFIN",105,0)
 I $O(^PS(52.41,ORD,3,0)) S PRC=^PS(52.41,ORD,3,0),T=0 F  S T=$O(^PS(52.41,ORD,3,T)) Q:'T  S PRC(T)=^PS(52.41,ORD,3,T,0)
"RTN","PSOORFIN",106,0)
 I $P(OR0,"^",3)="RNW",$D(^PSRX(+$P(OR0,"^",21),0)) D  G SUCC ;process renews
"RTN","PSOORFIN",107,0)
 .K PSOREEDT S (PSOORRNW,PSOFDR)=1,PSORENW("OIRXN")=$P(OR0,"^",21),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"))=0 D ^PSOORRNW,SQR
"RTN","PSOORFIN",108,0)
 I $P(OR0,"^",3)="RF",$D(^PSRX(+$P(OR0,"^",19),0)) D RF^PSOORFI2 G SUCC
"RTN","PSOORFIN",109,0)
 N PSODRUG,PSONEW S PSOFROM="PENDING" D:'$G(PSOTPBFG) DSPL^PSOTPCAN(ORD) D DSPL^PSOORFI1,SQN^PSOORFI3
"RTN","PSOORFIN",110,0)
SUCC ;
"RTN","PSOORFIN",111,0)
 D UL1^PSOORFI3,FULL^VALM1
"RTN","PSOORFIN",112,0)
 D:$P($G(^PS(52.41,+$G(ORD),0)),"^",3)'="NW"&($P($G(^(0)),"^",3)'="RNW")&($P($G(^(0)),"^",3)'="HD")&($P($G(^(0)),"^",3)'="RF")
"RTN","PSOORFIN",113,0)
 .K PSOSD("PENDING",$S('$G(OID):$P(^PS(50.7,$P(OR0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(OR0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(OR0,"^",9),0),"^")))
"RTN","PSOORFIN",114,0)
 S:$G(POERR("DFLG")) POERR("QFLG")=1 K POERR("DFLG"),PSONEW,ACP,OR0,DRET,SIG,OID,OI,PSORX("SC"),PSORX("CLINIC"),PSODRUG,PSOFOERR
"RTN","PSOORFIN",115,0)
 Q
"RTN","PSOORFIN",116,0)
 ;PSO*7*266 change order of bingo checks.
"RTN","PSOORFIN",117,0)
LBL I $O(PSORX("PSOL",0))!($D(RXRS)) S PSOFROM="NEW" D ^PSORXL K PSORX("PSOL"),PPL,RXRS
"RTN","PSOORFIN",118,0)
 D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,PSONEW,BBFLG,BBRX,PSORX("DOSING OFF"),PSOONOFC
"RTN","PSOORFIN",119,0)
 Q
"RTN","PSOORFIN",120,0)
CHK ;
"RTN","PSOORFIN",121,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W !,$C(7),"Outpatient Division MUST be selected!",! G EX
"RTN","PSOORFIN",122,0)
 D INST1^PSOORFI2
"RTN","PSOORFIN",123,0)
 S PSZCNT=0 F PSZZI=0:0 S PSZZI=$O(^PS(59,PSZZI)) Q:'PSZZI  S PSZCNT=PSZCNT+1
"RTN","PSOORFIN",124,0)
 S TC=0 F TO=0:0 S TO=$O(^PS(52.41,"AOR",TO)) Q:'TO  F TZ=0:0 S TZ=$O(^PS(52.41,"AOR",TO,TZ)) Q:'TZ  F PSTZ=0:0 S PSTZ=$O(^PS(52.41,"AOR",TO,TZ,PSTZ)) Q:'PSTZ  S TC=TC+1
"RTN","PSOORFIN",125,0)
 W !!?10,$C(7),"Orders to be completed"_$S(PSZCNT=1:": ",1:" for all divisions: ")_TC,! Q:'TC
"RTN","PSOORFIN",126,0)
 D SUMM^PSOORNE1 K PSZZI,PSZCNT,PSTZ
"RTN","PSOORFIN",127,0)
 Q
"RTN","PSOORFIN",128,0)
 ;
"RTN","PSOORFIN",129,0)
LK D LOCK^PSOORFI1
"RTN","PSOORFIN",130,0)
 Q
"RTN","PSOORFIN",131,0)
LK1 D LOCK1^PSOORFI1 Q
"RTN","PSOORFIN",132,0)
QU I $G(PSOQUIT) S POERR("QFLG")=1 K PSOQUIT
"RTN","PSOORFIN",133,0)
 S:$G(PSOQFLG) PAT(PAT)=PAT
"RTN","PSOORFIN",134,0)
 Q
"RTN","PSOORFIN",135,0)
ULP K PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOORFIN",136,0)
 D CLEAN^PSOVER1
"RTN","PSOORFIN",137,0)
 I '$G(X) Q
"RTN","PSOORFIN",138,0)
 D UL^PSSLOCK(X) Q
"RTN","PSOORFIN",139,0)
KLL K PSOPTLOK Q
"RTN","PSOORFIN",140,0)
KLLP K PSONOLCK Q
"RTN","PSOORFIN",141,0)
SPL D SPL^PSOORFI4 Q
"RTN","PSOORFIN",142,0)
SDFN S PSODFN=+$G(PSODFN) Q
"RTN","PSOORFIN",143,0)
PP D PP^PSOORFI4 Q
"RTN","PSOORFIN",144,0)
KQ K PSOQUIT,POERR("QFLG") Q
"RTN","PSOORFIN",145,0)
SQR ;
"RTN","PSOORFIN",146,0)
 K PSOORRNW,PSOOPT,PSOREEDT,PSOQUIT,VALMSG S POERR("DFLG")=0
"RTN","PSOORFIN",147,0)
 Q
"RTN","PSOORNEW")
0^6^B92394411
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,390,391,372,416**;DEC 1997;Build 32
"RTN","PSOORNEW",3,0)
 ;^PS(50.7 -2223
"RTN","PSOORNEW",4,0)
 ;^PSDRUG -221
"RTN","PSOORNEW",5,0)
 ;^PS(50.606 -2174
"RTN","PSOORNEW",6,0)
 ;^PS(55 -2228
"RTN","PSOORNEW",7,0)
 ;EN1^ORCFLAG -3620
"RTN","PSOORNEW",8,0)
 ;
"RTN","PSOORNEW",9,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",10,0)
 ;
"RTN","PSOORNEW",11,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",12,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",13,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",14,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",15,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",16,0)
 .S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",17,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",18,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",19,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",20,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",21,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",23,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",24,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",25,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",26,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",27,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",29,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",34,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",35,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",36,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",38,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",39,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",40,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",41,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",42,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",43,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",45,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",47,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",48,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",49,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",50,0)
 S IEN=IEN+1
"RTN","PSOORNEW",51,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_+$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",52,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",53,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",57,0)
 D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",58,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",59,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",60,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",62,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",63,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",64,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",65,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",66,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",67,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",68,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",69,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",70,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",71,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",72,0)
 Q
"RTN","PSOORNEW",73,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",74,0)
 Q
"RTN","PSOORNEW",75,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",76,0)
EDTSEL N LST,FLD,OUT D KV S OUT=0
"RTN","PSOORNEW",77,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",78,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",79,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",80,0)
 Q
"RTN","PSOORNEW",81,0)
ACP ;
"RTN","PSOORNEW",82,0)
 N DIR,Y S Y=0
"RTN","PSOORNEW",83,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",84,0)
 . D FULL^VALM1
"RTN","PSOORNEW",85,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",86,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",87,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",88,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",89,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",90,0)
 . D KV
"RTN","PSOORNEW",91,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",92,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",93,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",94,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",95,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",96,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",97,0)
 ;
"RTN","PSOORNEW",98,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",99,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",100,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",101,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",102,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",103,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",104,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",105,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",106,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",107,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",108,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",109,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",110,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",111,0)
 ;
"RTN","PSOORNEW",112,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",113,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",114,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",115,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",116,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",117,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",118,0)
 S PSONEW("POE")=1 D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNEW",119,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNEW",120,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOORNEW",121,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNEW",122,0)
 .S RXN=PSONEW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"Order Acceptance_OP"
"RTN","PSOORNEW",123,0)
 .D DAOC^PSONEW
"RTN","PSOORNEW",124,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",125,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",126,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",127,0)
 Q
"RTN","PSOORNEW",128,0)
KV K DIRUT,DUOUT,DTOUT,DIR,PSOEDDOS
"RTN","PSOORNEW",129,0)
 Q
"RTN","PSOORNEW",130,0)
REF D REF^PSOORFI4
"RTN","PSOORNEW",131,0)
 Q
"RTN","PSOORNEW",132,0)
1 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",133,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",134,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",135,0)
 ;
"RTN","PSOORNEW",136,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",137,0)
 ;
"RTN","PSOORNEW",138,0)
3 I $G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",139,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",140,0)
 N PSOEDDOS S PSOEDDOS=1 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",141,0)
 ;
"RTN","PSOORNEW",142,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",143,0)
 ;
"RTN","PSOORNEW",144,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",145,0)
 ;
"RTN","PSOORNEW",146,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",147,0)
 ;
"RTN","PSOORNEW",148,0)
13 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",149,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",150,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",151,0)
 ;
"RTN","PSOORNEW",152,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",153,0)
 ;
"RTN","PSOORNEW",154,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",155,0)
 N CPRN S CPRN=+$P($G(OR0),"^",24) D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",156,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",157,0)
 Q
"RTN","PSOORNEW",158,0)
 ;
"RTN","PSOORNEW",159,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",160,0)
 ;
"RTN","PSOORNEW",161,0)
8 N CPRN S CPRN=+$P($G(OR0),"^",24) D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",162,0)
 ;
"RTN","PSOORNEW",163,0)
10 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",164,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",165,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",166,0)
 ;
"RTN","PSOORNEW",167,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",168,0)
 ;
"RTN","PSOORNEW",169,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",170,0)
 ;
"RTN","PSOORNEW",171,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",172,0)
 ;
"RTN","PSOORNEW",173,0)
DRGMSG ;
"RTN","PSOORNEW",174,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",175,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",176,0)
 K SG
"RTN","PSOORNEW",177,0)
 Q
"RTN","PSOORNEW",178,0)
 ;
"RTN","PSOORNEW",179,0)
PZ ;
"RTN","PSOORNEW",180,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",181,0)
 Q
"RTN","PSORXEDT")
0^15^B45078409
"RTN","PSORXEDT",1,0)
PSORXEDT ;BIR/SAB-edit rx routine ;10/21/98
"RTN","PSORXEDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**21,23,44,71,146,185,148,253,390,372,416**;DEC 1997;Build 32
"RTN","PSORXEDT",3,0)
 ;Ref. ^PS(55 supp. IA 2228
"RTN","PSORXEDT",4,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSORXEDT",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) G EOJ Q
"RTN","PSORXEDT",6,0)
 K PSODRUG,PSOLIST,DIR,DIRUT,DUOUT,X,Y,PSOFROM,^TMP("PSOBEDT",$J),NOPP,CLOZPST
"RTN","PSORXEDT",7,0)
 N PSOODOSP
"RTN","PSORXEDT",8,0)
 W !! S DIR(0)="FAO^1:245",DIR("A")="Edit Rx(s) => ",DIR("?",1)="Enter Rx Number or A List of numbers Separated",DIR("?")="by Commas, e.g. 1234A,345,937002Q."
"RTN","PSORXEDT",9,0)
 D ^DIR K DIR G:$D(DIRUT) EOJ
"RTN","PSORXEDT",10,0)
 S END=$L(X,","),BAD=0
"RTN","PSORXEDT",11,0)
 F I=1:1:END S RXM=$P(X,",",I) I +RXM F J=I+1:1:END S DUP=$P(X,",",J) I DUP=RXM S $P(X,",",J)="" W !?5,$C(7),"Duplicate Rx # "_RXM_"  was found in your list, ignoring it!",! S BAD=1
"RTN","PSORXEDT",12,0)
 S PSORLST=$P(X,",") F I=2:1:END S RXM=$P(X,",",I) S:RXM'?1.N.A BAD=1 I RXM?1.N.A S PSORLST=PSORLST_","_RXM
"RTN","PSORXEDT",13,0)
 F I=1:1:$L(PSORLST) S RXM=$P(PSORLST,",",I) I +RXM F J=I+1:1:END S DUP=$P(PSORLST,",",J) I DUP=RXM S $P(PSORLST,",",J)=""
"RTN","PSORXEDT",14,0)
BAD I PSORLST D  I 'Y K Y G PSORXEDT
"RTN","PSORXEDT",15,0)
 .W !?15,"=> "_PSORLST
"RTN","PSORXEDT",16,0)
 .K DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OKAY ",DIR("B")="Yes"
"RTN","PSORXEDT",17,0)
 .D ^DIR K DIR
"RTN","PSORXEDT",18,0)
 .I 'Y!$D(DIRUT) K X,PSORLST,BAD
"RTN","PSORXEDT",19,0)
 K BAD I 'PSORLST K PSORLST G PSORXEDT
"RTN","PSORXEDT",20,0)
 F I=1:1:$L(PSORLST,",") S RXM=$P(PSORLST,",",I) S GOOD=$D(^PSRX("B",RXM)) D
"RTN","PSORXEDT",21,0)
 .I 'GOOD W !!?5,"Couldn't Find RX # "_RXM H 3 Q
"RTN","PSORXEDT",22,0)
 .S RXN=$O(^PSRX("B",RXM,0)) D  I $P(^PSRX(RXN,"STA"),"^")=13 W !!?5,"Rx # "_RXM_" is marked for Deletion." H 3 Q
"RTN","PSORXEDT",23,0)
 ..I $G(RXN),$P($G(^PS(55,+$P($G(^PSRX(RXN,0)),"^",2),0)),"^",6)'=2 S PSOLOUD=1 D EN^PSOHLUP(+$P($G(^PSRX(RXN,0)),"^",2)) K PSOLOUD
"RTN","PSORXEDT",24,0)
 .D LIST K GOOD
"RTN","PSORXEDT",25,0)
 K GOOD,END
"RTN","PSORXEDT",26,0)
EPH ; - Entry for Epharmacy Rx Edit (PSOREJP1)
"RTN","PSORXEDT",27,0)
 F PSOT1=1:1 Q:'$D(PSOLIST(PSOT1))  F PSOLST2=1:1:$L(PSOLIST(PSOT1),",") S ORN=$P(PSOLIST(PSOT1),",",PSOLST2) D:+ORN PT
"RTN","PSORXEDT",28,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORXEDT",29,0)
 K POP,PSOLIST,TM,TM1 G:'$O(PSORX("PSOL",0)) NX
"RTN","PSORXEDT",30,0)
 D:$G(PSORX("PSOL",1))]"" ^PSORXL K PSORX G:$G(NOBG) NX
"RTN","PSORXEDT",31,0)
PRF G:'$P(PSOPAR,"^",8)!($G(NOPP)="H")!($G(NOPP)="S")!('$D(^TMP("PSOBEDT",$J))) BBG
"RTN","PSORXEDT",32,0)
 I $O(^TMP("PSOBEDT",$J,0)),$P(PSOPAR,"^",8) S PSOFROM="NEW",PSOION=ION K RXRS
"RTN","PSORXEDT",33,0)
 G:$D(PSOPROP)&($G(PSOPROP)'=ION) QUP
"RTN","PSORXEDT",34,0)
 I '$D(PSOPROP)!($G(PSOPROP)=ION) D  G:$G(POP)!($E(IOST)["C")!(PSOION=ION) BBG
"RTN","PSORXEDT",35,0)
 .S PSOION=ION W !,"Profiles must be sent to Printer !!",! K IOP,%ZIS,IO("Q"),POP
"RTN","PSORXEDT",36,0)
 .S %ZIS="MNQ",%ZIS("A")="Select Profile Device: " D ^%ZIS K %ZIS("A")
"RTN","PSORXEDT",37,0)
 .Q:$G(POP)!($E(IOST)["C")!(PSOION=ION)  S PSOPROP=ION
"RTN","PSORXEDT",38,0)
QUP S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X,HOLDRPAS=$G(PSOPRPAS),PSOPRPAS=$P(PSOPAR,"^",13)
"RTN","PSORXEDT",39,0)
 F DFN=0:0 S DFN=$O(^TMP("PSOBEDT",$J,DFN)) Q:'DFN  S PPL=^TMP("PSOBEDT",$J,DFN,0) D
"RTN","PSORXEDT",40,0)
 .S ZTRTN="DQ^PSOPRF",ZTIO=PSOPROP,ZTDESC="Outpatient Pharmacy Patient Profiles",ZTDTH=$H
"RTN","PSORXEDT",41,0)
 .F G="PSOPAR","PSODTCUT","PSOPRPAS","DFN","PSOSITE","NEW1","NEW11","PSOBMST","PFIO","PPL" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXEDT",42,0)
 .D ^%ZTLOAD
"RTN","PSORXEDT",43,0)
 W:$D(ZTSK) !,"PROFILE(S) QUEUED to PRINT",!! K G,ZTSK D ^%ZISC
"RTN","PSORXEDT",44,0)
 S PSOPRPAS=$G(HOLDRPAS) K:PSOPRPAS']"" PSOPRPAS K HOLDRPAS
"RTN","PSORXEDT",45,0)
BBG K DFN F PSODFN=0:0 S PSODFN=$O(^TMP("PSOBEDT",$J,PSODFN)) Q:'PSODFN  I $G(^TMP("PSOBEDT",$J,PSODFN,1)),$D(DISGROUP) S TM=$P($G(^TMP("PSOBB",$J)),"^"),TM1=$P($G(^($J)),"^",2),PPL=^TMP("PSOBEDT",$J,PSODFN,0) D ^PSOBING1
"RTN","PSORXEDT",46,0)
NX ;
"RTN","PSORXEDT",47,0)
 K %X,%Y,ACTREF,ACTREN,D,D0,DAT,DFN,DIC,DIQ,DQ,DRG,END,FDR,PSOBEDT,TM,TM1,PSOT1,PSOLST2,NOBG,BBFLG,BINGCRT,BINGRTE,C,CC,CMOP,COM,CT,D1,DI,DREN,BBRX,PSOFROM,POP,PSORX("QFLG"),IT,PSOERR,PSOBCK,PSOBM,PPL
"RTN","PSORXEDT",48,0)
 K ^TMP("PSOBEDT",$J),^TMP("PSOBB",$J),ZTSK,NOPP,VALMSG,VALMBCK D EOJ
"RTN","PSORXEDT",49,0)
END Q
"RTN","PSORXEDT",50,0)
 ;---------------------------------------------------------
"RTN","PSORXEDT",51,0)
PT ;
"RTN","PSORXEDT",52,0)
 N PSOTXEDT,PSOTPEXT S PSOTXEDT=$P($G(^PSRX(ORN,0)),"^",2) I PSOTXEDT I $D(^PS(52.91,PSOTXEDT,0)) I '$P(^PS(52.91,PSOTXEDT,0),"^",3)!($P(^(0),"^",3)>DT) D PDIR^PSOTPCAN(PSOTXEDT) I $G(PSOTPEXT) K PSOTPEXT,PSOTXEDT D EOJ Q
"RTN","PSORXEDT",53,0)
 K PSOTXEDT,PSOTPEXT
"RTN","PSORXEDT",54,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",55,0)
 S $P(PSOLST(ORN),"^",2)=ORN,(PSOBEDT)=1
"RTN","PSORXEDT",56,0)
 S (DFN,PSODFN)=+$P(^PSRX(ORN,0),"^",2),PSORX("NAME")=$P(^DPT(DFN,0),"^") I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF") S PSOODOSP=PSODFN
"RTN","PSORXEDT",57,0)
 D ICN^PSODPT(DFN)
"RTN","PSORXEDT",58,0)
 S RX0=^PSRX(ORN,0),RX2=$G(^(2)),RX3=$G(^(3))
"RTN","PSORXEDT",59,0)
 D:$G(DUZ("AG"))="V" COPAY^PSOPTPST ; Deals with copay
"RTN","PSORXEDT",60,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) D ^VADPT,ADD^VADPT
"RTN","PSORXEDT",61,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSORXEDT",62,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2)
"RTN","PSORXEDT",63,0)
 S ^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSORXEDT",64,0)
 S POERR=1 D RE^PSODEM K POERR,VALMBCK
"RTN","PSORXEDT",65,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSORXEDT",66,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSORXEDT",67,0)
 S ^TMP("PSOHDR",$J,9,0)="",^TMP("PSOHDR",$J,10,0)=""
"RTN","PSORXEDT",68,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSORXEDT",69,0)
 S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2)) S ^TMP("PSOHDR",$J,12,0)=PSOBSA
"RTN","PSORXEDT",70,0)
 S RSLT=$$CRCL^PSOORUT2(DFN)
"RTN","PSORXEDT",71,0)
 I $P(RSLT,"^",2)["Not Found" S ZDSPL=" CrCL: "_$P(RSLT,"^",2)
"RTN","PSORXEDT",72,0)
 E  S ZDSPL=" CrCL: "_$P($G(RSLT),"^",2)_"(est.) "_"(CREAT:"_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSORXEDT",73,0)
 S ^TMP("PSOHDR",$J,13,0)=ZDSPL
"RTN","PSORXEDT",74,0)
 K PSOBSA,RSLT,ZDSPL
"RTN","PSORXEDT",75,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",76,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORXEDT",77,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORXEDT",78,0)
 D CLEAR^VALM1
"RTN","PSORXEDT",79,0)
 S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSORXEDT",80,0)
 S $P(PSOLST(ORN),"^",3)=$P(STA,"^",$P(^PSRX(ORN,"STA"),"^")+1),PSLST=ORN,ORD=1
"RTN","PSORXEDT",81,0)
 D ACT^PSOORNE2
"RTN","PSORXEDT",82,0)
EOJ ;
"RTN","PSORXEDT",83,0)
 K INS1,HDR,IK,INDT,LOG,NODE,ORN,P1,PSI,PSL,PSOLION,PSNP,PSOACT,PSOBM,PSOCLC,PSOCNT,PSODD,PSODFN,PSOHD,PSOJ,PSOLST,PSOOI,PSOPF,PSLST
"RTN","PSORXEDT",84,0)
 K PSOIBQS,PSORLST,PSOSD,PSOSIG,PSPRXN,PSORX0,PSORX1,PTST,REFL,RF,RFD,RIFN,RLD,RPH,RTS,RX0,RX1,RX2,RX3,RXM,RXOR,SIG,SIGOK
"RTN","PSORXEDT",85,0)
 D KVA^VADPT K SLPPL,ST,STA,^TMP("PS",$J),PSOQFLG,PSORXED,PSOEDIT,DIR,DIRUT,DUOUT,DTOUT,PSOLOUD,GMRAL,GG,FEV,ACNT
"RTN","PSORXEDT",86,0)
 D FULL^VALM1 K ^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J),PAT
"RTN","PSORXEDT",87,0)
 K JJ,K,MM,PSDAYS,PSOAC,PSOAL,PSOCOU,PSOCOUU,PSONEW,PSODRUG,PSONOOR,PSRX0,QTY,REA,RFCNT,RFDT,RXDA,RXFL,RXREF,SUB,X,Z,ZII
"RTN","PSORXEDT",88,0)
 K ACOM,CRIT,DA,DDH,DGI,DGS,PSONEW3,SER,SERS,ZONE,RN,RXN,PSOX,PSOERR,ORD,PSOBCK,PSOBILL,SURX,PSORX("QFLG"),PSORX("FN"),CLOZPAT
"RTN","PSORXEDT",89,0)
 Q
"RTN","PSORXEDT",90,0)
LIST ;
"RTN","PSORXEDT",91,0)
 I $G(^PSRX(RXN,0))']"" W !,$C(7),"Rx data is not on file !",! G LISTX
"RTN","PSORXEDT",92,0)
 I $P(^PSRX(RXN,0),"^",15)=13 S PSVD=1 W !,$C(7),"Rx # "_RXM_" has been deleted."
"RTN","PSORXEDT",93,0)
 S RXN1=RXN,RXM1=RXM D:'$G(PSVD) LST1 W "." S RXN=RXN1,RXM=RXM1 K RXN1,RXM1
"RTN","PSORXEDT",94,0)
 F  S RXN=$O(^PSRX("B",RXM,RXN)) Q:'RXN  D
"RTN","PSORXEDT",95,0)
 .I $G(^PSRX(RXN,0))']"" Q
"RTN","PSORXEDT",96,0)
 .I $P(^PSRX(RXN,0),"^",15)=13 Q
"RTN","PSORXEDT",97,0)
 .D LST1
"RTN","PSORXEDT",98,0)
 K RXN1 G LISTX
"RTN","PSORXEDT",99,0)
 Q
"RTN","PSORXEDT",100,0)
LST1 I $G(PSOLIST(1))']"" S PSOLIST(1)=RXN_"," G LISTX
"RTN","PSORXEDT",101,0)
 F PSOX1=0:0 S PSOX1=$O(PSOLIST(PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORXEDT",102,0)
 I $L(PSOLIST(PSOX2))+$L(RXN)<220 S:RXN_","'[PSOLIST(PSOX2) PSOLIST(PSOX2)=PSOLIST(PSOX2)_RXN_","
"RTN","PSORXEDT",103,0)
 E  S:RXN_","'[PSOLIST(PSOX2+1) PSOLIST(PSOX2+1)=RXN_","
"RTN","PSORXEDT",104,0)
LISTX K PSOX1,PSOX2,RXN,PSVD
"RTN","PSORXEDT",105,0)
 Q
"RTN","PSOVER")
0^7^B87892032
"RTN","PSOVER",1,0)
PSOVER ;BIR/SAB - verify rx's by clerk ;07/03/95
"RTN","PSOVER",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**16,21,27,117,131,146,251,375,387,379,391,372,416**;DEC 1997;Build 32
"RTN","PSOVER",3,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER",4,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOVER",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! Q
"RTN","PSOVER",6,0)
 Q:'$D(^XUSEC("PSORPH",DUZ))  S PSOZVER=1
"RTN","PSOVER",7,0)
PAT K PSOTT,PSOACT,PSOVER,PSOQUIT,PSORX("DFLG"),DTOUT,DIRUT,PSOVQUIT W !! S DIC("A")="Enter PATIENT NAME (or ^C to verify for a clerk): ",DIC="^DPT(",DIC("S")="I $D(^PS(52.4,""C"",+Y))",DIC(0)="QEAMZ" D ^DIC K DIC G CLERK:$E(X,1,2)="^C",END:Y'>0
"RTN","PSOVER",8,0)
 S PSONV=0,(DFN,PSDFN,PSODFN)=+Y,PPL="",PSONAM=$P(^DPT(PSDFN,0),"^") D ^PSOBUILD
"RTN","PSOVER",9,0)
L1 D PID^VADPT S PSONV=$O(^PS(52.4,"C",PSDFN,PSONV)) I 'PSONV D:$$GET1^DIQ(52,PSONV,100,"I")'=13 PACK G PAT
"RTN","PSOVER",10,0)
 F DGDG=0:0 S DGDG=$O(^PS(52.4,"C",PSDFN,DGDG)) S PSONV=DGDG K PSOSIG,PSOTHER Q:'DGDG!($G(PSOQUIT))  D  Q:$G(DIRUT)
"RTN","PSOVER",11,0)
 .I $D(^PS(52.4,"ADI",DGDG,1)) S PSONV=DGDG D DGDGI Q
"RTN","PSOVER",12,0)
 .I $D(^PSRX(PSONV,"DRI")) S PSOSIG=1 D DGDGI Q
"RTN","PSOVER",13,0)
 .D:'$D(^PS(52.4,"ADI",PSONV,1))&('$D(^PSRX(PSONV,"DRI"))) DSPL Q
"RTN","PSOVER",14,0)
 G QUIT:$D(PSOSD)
"RTN","PSOVER",15,0)
 ;
"RTN","PSOVER",16,0)
SHOW I '$D(PSOSD) W !,$C(7),"This patient has no prescriptions on file",!! Q
"RTN","PSOVER",17,0)
 I ($Y+5)>IOSL D HD^PSODDPR2(5) Q:$G(PSODLQT)
"RTN","PSOVER",18,0)
 W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"")
"RTN","PSOVER",19,0)
 D ^PSODSPL
"RTN","PSOVER",20,0)
SHOW2 ;
"RTN","PSOVER",21,0)
 I ($Y+5)>IOSL D HD^PSODDPR2() Q
"RTN","PSOVER",22,0)
 Q:$Y<5
"RTN","PSOVER",23,0)
 N DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","PSOVER",24,0)
 K DIR W ! S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOVER",25,0)
 W @IOF
"RTN","PSOVER",26,0)
 Q
"RTN","PSOVER",27,0)
 ;
"RTN","PSOVER",28,0)
CLERK D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! G END
"RTN","PSOVER",29,0)
 K PSOVERPL,PSOVERPX,PSOVERPH,PSOVERLX,PSOVERQ,PSORX("DFLG"),DIRUT,DTOUT,PSOVQUIT
"RTN","PSOVER",30,0)
 K PSOQUIT,PSOCQ,PSOVORD,PSOINTV S PSOCLK=1 W ! S DIC="^VA(200,",DIC(0)="AEQM",DIC("S")="I $D(^PS(52.4,""D"",+Y))",DIC("A")="Enter Clerk Name: "
"RTN","PSOVER",31,0)
 D ^DIC K DIC K:Y'>0!($D(DTOUT)) PSORX G END:Y'>0!($D(DTOUT))
"RTN","PSOVER",32,0)
 N PSOODOSP S PSOTT=+Y,(PSONV,PSDFN0)=0,PPL="" K PSOVER,PSONAM
"RTN","PSOVER",33,0)
CL1 F DGDG=0:0 S DGDG=$O(^PS(52.4,"D",PSOTT,DGDG)) Q:'DGDG!($G(PSOQUIT))!($G(PSOCQ))  D  Q:$D(DIRUT)
"RTN","PSOVER",34,0)
 .S PSOVQUIT=0,(DFN,PSOVERPX,PSDFN,PSODFN)=$P(^PS(52.4,DGDG,0),"^",2),PSONV=DGDG D  D PATCHK K PSOSIG,PSOTHER
"RTN","PSOVER",35,0)
 ..I $G(PSOODOSP)'=DFN S PSOODOSP=DFN K PSORX("DOSING OFF")
"RTN","PSOVER",36,0)
 .S CLFLAG=1 D STAT^PSODGDG2 K CLFLAG D:'$G(FLAGST)  Q:$D(DIRUT)
"RTN","PSOVER",37,0)
 ..S PSONVXX=PSONV I $G(PSOVERPH)=$G(PSOVERPX),$G(PSOVERLX) Q
"RTN","PSOVER",38,0)
 ..I $G(PSOVERPH)'=$G(PSOVERPX) K PSOVERLX D:$G(PSOVERPH)&('$G(PSOVERPL)) ULP S PSOVERPH=PSOVERPX D LPAT I $G(PSOVERPL) Q
"RTN","PSOVER",39,0)
 ..S PSDFN0=PSDFN D LRX I '$G(PSOMSG) Q
"RTN","PSOVER",40,0)
 ..K PSOMSG I $D(^PS(52.4,"ADI",DGDG,1)) S PSONV=DGDG D DSPL D PSOUL^PSSLOCK(PSONVXX) Q
"RTN","PSOVER",41,0)
 ..I $D(^PSRX(PSONV,"DRI")) S PSOSIG=1 D DSPL D PSOUL^PSSLOCK(PSONVXX) Q
"RTN","PSOVER",42,0)
 ..D:'$D(^PS(52.4,"ADI",PSONV,1))&('$D(^PSRX(PSONV,"DRI"))) DSPL D PSOUL^PSSLOCK(PSONVXX) Q
"RTN","PSOVER",43,0)
 D:$G(PSOVERPH)&('$G(PSOVERPL)) ULP
"RTN","PSOVER",44,0)
CL2 D:$$GET1^DIQ(52,PSONV,100,"I")'=13 PACK G CLERK
"RTN","PSOVER",45,0)
PATCHK I $D(PSOVER),PSDFN0,PSDFN0'=DFN S (DFN,PSDFN)=PSDFN0 D PACK S (DFN,PSDFN)=PSODFN D ^PSOBUILD,PID^VADPT S PSONAM=$P(^DPT(DFN,0),"^") Q
"RTN","PSOVER",46,0)
 I PSDFN0'=DFN D ^PSOBUILD,PID^VADPT S PSONAM=$P(^DPT(DFN,0),"^")
"RTN","PSOVER",47,0)
 Q
"RTN","PSOVER",48,0)
PACK Q:$$GET1^DIQ(52,PSONV,100,"I")=13  S PPL="" F J=0:0 S J=$O(PSOVER(J)) Q:'J  S PPL=PPL_J_","
"RTN","PSOVER",49,0)
 I PPL]"" S PSOOPT=3,PSOTRVV=1 D ^PSORXL K PSOOPT,PSOTRVV
"RTN","PSOVER",50,0)
 K PSD,PSOVER S PPL="" Q
"RTN","PSOVER",51,0)
QUIT D PACK
"RTN","PSOVER",52,0)
END K CAN,CLS,DA,DEA1,DEA2,DIC,DIE,DR,DRG,DRGG,DUP,DUPRX,DUPRX0,FLDT,I,ISDT,ISSD,J,LSTFL,PHYS,PPL,PSC,PSD,PSDFN,PSDFN0,PSDNEW,PSDOLD,PSMSG,PSOQUIT,PSOTT,PSOVER,PSREA,PSRFLS,PSRX,PSRX1,PSRX2,PSRXREF,PSVERFLG,RFLS,RX0,RX2,RX3,ST,ST0,STAR,X
"RTN","PSOVER",53,0)
 K D0,DQ,N,PHY,RFL,PSI,PSOTHER,PSS,PSOZVER,PI,PTST,SD,PSONAM,PSONULN,RFDATE,RFL1,RXF,Z,DRUG,II,RFLL,DRGX,DIPGM,PSOCNT,A1,C,ST00,FLAGST,STEXT,PSOCLK,PSOCQ,PSOVERPL,PSOVERPX,PSOVERPH,PSOVERLX,VERLFLAG,PSONVXX D KVA^VADPT
"RTN","PSOVER",54,0)
 K PSONOOR,PSOSIG,DIR,DUOUT,DTOUT,DIRUT,DIROUT,INA,MED,SER1,PSOVORD,PSOINTV,PSOVQUIT,PSVFLAG,PSOOVNOD,PSOOVSTA
"RTN","PSOVER",55,0)
 Q
"RTN","PSOVER",56,0)
DSPL ;
"RTN","PSOVER",57,0)
 Q:$P(^PSRX(PSONV,"STA"),"^")=13
"RTN","PSOVER",58,0)
 S DA=PSONV
"RTN","PSOVER",59,0)
 D SAVE
"RTN","PSOVER",60,0)
 S PSVFLAG=1 D ^PSOVER1 I $G(PSORX("DFLG")) K PSVFLAG
"RTN","PSOVER",61,0)
 Q
"RTN","PSOVER",62,0)
DGDGI ;process drug interaction for non verified rxs
"RTN","PSOVER",63,0)
 K DIRUT,DTOUT,PSORX("DFLG")
"RTN","PSOVER",64,0)
 S SER1=$S('$G(PSOSIG):$P(^PS(52.4,PSONV,0),"^",9),1:$P(^PSRX(PSONV,"DRI"),"^")),PSVFLAG=1
"RTN","PSOVER",65,0)
 S MED=$S('$G(PSOSIG):$P(^PS(52.4,PSONV,0),"^",10),1:$P(^PSRX(PSONV,"DRI"),"^",2))
"RTN","PSOVER",66,0)
 K LOCKARRY,PSOVMSGX S VERLFLAG=0 I $G(MED) F LOCKINA=1:1 S PSOLKVRX=$P(MED,",",LOCKINA) Q:$G(PSOLKVRX)=""!($G(VERLFLAG))  D LK1
"RTN","PSOVER",67,0)
 K PSOVMSGX
"RTN","PSOVER",68,0)
 S PSVERFLG=0,IFN=PSONV,INT=^PSRX(IFN,0) N PSOOLDFN S PSOOLDFN=DFN
"RTN","PSOVER",69,0)
 F INA=1:1 S PSODFN=DFN Q:$P(SER1,",",INA)=""!($G(MED)="")  D  Q:$G(PSOVQUIT)!$G(PSORX("DFLG"))
"RTN","PSOVER",70,0)
 .I $P(SER1,",",INA) S SER=^PS(56,$P(SER1,",",INA),0)
"RTN","PSOVER",71,0)
 .E  S $P(SER,"^",4)=$S($P(SER1,",",INA)="Critical":1,1:2)
"RTN","PSOVER",72,0)
 .S RX=^PSRX(PSONV,0),STA=+$G(^("STA")),$P(RX,"^",15)=STA,PSOOPT=1
"RTN","PSOVER",73,0)
 .W !!!,$P(^DPT(DFN,0),"^"),?39,"ID#: ",$E($P(^(0),"^",9),1,3)_"-"_$E($P(^(0),"^",9),4,5)_"-"_$E($P(^(0),"^",9),6,9),?57,"RX: ",$P(^PSRX(PSONV,0),"^")
"RTN","PSOVER",74,0)
 .I STA'=13 D FULL^VALM1 D SAVE,^PSOVER1  S:'$G(DFN) DFN=PSOOLDFN
"RTN","PSOVER",75,0)
 Q:$G(PSORX("DFLG"))  Q:$G(DIRUT)!($G(DTOUT))
"RTN","PSOVER",76,0)
 I '$G(PSVERFLG),$P(^PSRX(PSONV,"STA"),"^")=4!($P(^("STA"),"^")=1) S $P(^PSRX(PSONV,"STA"),"^")=1 D DSPL G DONE
"RTN","PSOVER",77,0)
 I '$D(^PS(52.4,"ADI",PSONV,1)),$P(^PSRX(PSONV,"STA"),"^")=1 D DSPL G DONEX:$G(DIRUT)!($G(DTOUT)) G DONE
"RTN","PSOVER",78,0)
DONE ;
"RTN","PSOVER",79,0)
 I $P(^PSRX(PSONV,"STA"),"^")=4 S ^PS(52.4,"ADI",PSONV,1)=""
"RTN","PSOVER",80,0)
 K PSOVORD I $P(^PSRX(PSONV,"STA"),"^")'=1,$P(^("STA"),"^")'=4 K ^PSRX(PSONV,"DRI")
"RTN","PSOVER",81,0)
 S PSOTHER="" F  S PSOTHER=$O(PSOTHER(PSOTHER)) Q:PSOTHER=""  D
"RTN","PSOVER",82,0)
 .I $G(PSOTHER),$P($G(^PSRX(PSOTHER,"STA")),"^")=1,$P($G(^PS(52.4,PSOTHER,0)),"^",10)="" S PSONV=PSOTHER D DSPL
"RTN","PSOVER",83,0)
 D:$D(LOCKARRY) ULK1
"RTN","PSOVER",84,0)
DONEX K PSOOPT,SER,LOCKARRY,LOCKINA,PSOLKVRX,DTOUT,DIRUT,PSORX("DFLG"),PSOOVNOD,PSOOVSTA
"RTN","PSOVER",85,0)
 Q
"RTN","PSOVER",86,0)
OERR ;
"RTN","PSOVER",87,0)
 N PSOEDITF,PSOVEDIT,PSOOORN,XQORNOD,Y,PSOVBCK S PSOVEDIT=0
"RTN","PSOVER",88,0)
 K PSONOOR,PSODLQT,PSOVER,PSVERFLG,PSOVORD,PSOSIG I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item!",VALMBCK="" Q
"RTN","PSOVER",89,0)
 I $G(PSOTPBFG) N PSOTPPEN,PSOTPPEX,PSOTPPE9 S PSOTPPEN=$P(PSOLST($P(PSLST,",",ORD)),"^",2),PSOTPPEX=0,PSOTPPE9=1 D VOPN^PSOTPCAN I PSOTPPEX S VALMBCK="" K PSOTPPEN,PSOTPPEX,PSOTPPE9 Q
"RTN","PSOVER",90,0)
 K PSOTPPEN,PSOTPPEX,PSOTPPE9,PSORX("DFLG")
"RTN","PSOVER",91,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOVER",92,0)
 I '$D(^PSRX(+$P(PSOLST($P(PSLST,",",ORD)),"^",2),"PKI")),'$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Unauthorized Action!",VALMBCK="" Q
"RTN","PSOVER",93,0)
 I $D(^PSRX(+$P(PSOLST($P(PSLST,",",ORD)),"^",2),"PKI")) N FL S FL=0 D  I FL Q
"RTN","PSOVER",94,0)
 .I $P($G(^PSRX(+$P(PSOLST($P(PSLST,",",ORD)),"^",2),"PKI")),"^"),'$D(^XUSEC("PSDRPH",DUZ)) S VALMSG="Digitally Signed Order - PSDRPH key required",VALMBCK="",FL=1 Q
"RTN","PSOVER",95,0)
 .I $P($G(^PSRX(+$P(PSOLST($P(PSLST,",",ORD)),"^",2),"PKI")),"^",2),'$D(^XUSEC("PSDRPH",DUZ)) S VALMSG="CS Order - PSDRPH key is required",VALMBCK="",FL=1 Q
"RTN","PSOVER",96,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Unauthorized Action!",VALMBCK="" Q
"RTN","PSOVER",97,0)
 S PSOVRXN=$P(PSOLST($P(PSLST,",",ORD)),"^",2),PSOVDFN=$P($G(^PSRX(PSOVRXN,0)),"^",2)
"RTN","PSOVER",98,0)
 S PSOPLCK=$$L^PSSLOCK(PSOVDFN,0) I '$G(PSOPLCK) S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is editing orders for this patient.") S VALMBCK="" K PSOPLCK Q
"RTN","PSOVER",99,0)
 K PSOPLCK D PSOL^PSSLOCK(PSOVRXN) I '$G(PSOMSG) D UL^PSSLOCK(PSOVDFN) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.") K PSOMSG S VALMBCK="" Q
"RTN","PSOVER",100,0)
 N PSODFN S (PSOZVER,PSLSTVER)=1
"RTN","PSOVER",101,0)
 D FULL^VALM1 S (PSONV,X,DA)=$P(PSOLST($P(PSLST,",",ORD)),"^",2)
"RTN","PSOVER",102,0)
 I '$D(^PS(52.4,PSONV,0)) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOVER",103,0)
 S PSOOVNOD=^PS(52.4,PSONV,0),PSOOVSTA=$P(^PSRX(PSONV,"STA"),"^")
"RTN","PSOVER",104,0)
 K DIC S DIC(0)="NZ",DIC=52.4 D ^DIC K DIC I Y<1 D  D:'$G(PSLSTVER) ULB Q:'$G(PSLSTVER)
"RTN","PSOVER",105,0)
 .I $P($G(^PSRX(+PSONV,"STA")),"^")'=1,$P($G(^("STA")),"^")'=4 K PSONV,DA,X,Y,PSOZVER,PSLSTVER S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOVER",106,0)
 .S PSLSTVER=2
"RTN","PSOVER",107,0)
 .S DIC="^PS(52.4,",DLAYGO=52.4,(DINUM,X)=PSONV,DIC(0)="L" K DD,DO D FILE^DICN K DD,DO,DIC,DINUM,DLAYGO
"RTN","PSOVER",108,0)
 .S ^PS(52.4,PSONV,0)=PSONV_"^"_$P(^PSRX(PSONV,0),"^",2)_"^"_+$P(^(0),"^",16)_"^^"_$E($P($G(^(2)),"^"),1,7)_"^"_PSONV_"^"_$E($P($G(^(2)),"^",6),1,7)
"RTN","PSOVER",109,0)
 .S DIK="^PS(52.4,",DA=PSONV D IX^DIK K DIK S Y(0)=^PS(52.4,PSONV,0),(X,DA)=PSONV
"RTN","PSOVER",110,0)
 D STAT^PSODGDG2 G:FLAGST EOJ
"RTN","PSOVER",111,0)
 N LST S (DFN,PSDFN,PSODFN)=$P(^PSRX(PSONV,0),"^",2),PPL="",PSONAM=$P(^DPT(PSDFN,0),"^")
"RTN","PSOVER",112,0)
 D PID^VADPT S PSOVORD=PSONV
"RTN","PSOVER",113,0)
 I $D(^PS(52.4,"ADI",PSONV,1)) D DGDGI G:$G(PSOVQUIT)!$G(PSORX("DFLG")) EOJ G PPL
"RTN","PSOVER",114,0)
 I $D(^PSRX(PSONV,"DRI")) S PSOSIG=1 D DGDGI G:$G(PSOVQUIT)!$G(PSORX("DFLG")) EOJ G PPL
"RTN","PSOVER",115,0)
 G:$G(PSORX("DFLG")) EOJ D DSPL
"RTN","PSOVER",116,0)
PPL I $G(PSLSTVER)=2,$D(^PS(52.4,PSONV,0)) S DA=PSONV,DIK="^PS(52.4," D ^DIK K DIK,DA
"RTN","PSOVER",117,0)
 G EOJ:'$O(PSOVER(0))
"RTN","PSOVER",118,0)
 S PSONVLP="" F  S PSONVLP=$O(PSOVER(PSONVLP)) Q:PSONVLP=""  D
"RTN","PSOVER",119,0)
 .D MARKV^PSOTPCAN
"RTN","PSOVER",120,0)
 .I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSONVLP_"," Q
"RTN","PSOVER",121,0)
 .F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSOVER",122,0)
 .I $L(PSORX("PSOL",PSOX2))+$L(PSONVLP)<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSONVLP_","
"RTN","PSOVER",123,0)
 .E  S PSORX("PSOL",PSOX2+1)=PSONVLP_","
"RTN","PSOVER",124,0)
EOJ D ULB,END
"RTN","PSOVER",125,0)
 K D,DGDG,MW,PSONVLP,P,PCOMX,PDA,PSPRXN,RX,PSD,PSOSTA,PSLSTVER,PSOVORD,PSVFLAG
"RTN","PSOVER",126,0)
 I $G(PSOCLK),$G(PSLST) K PSLST
"RTN","PSOVER",127,0)
 I $G(PSOCLK)!($G(PSOPOCK)) D FULL^VALM1 K VALMBCK D ^PSOBUILD,BLD^PSOORUT1 S Y=0 F  S Y=$O(PSOLST(Y)) Q:Y=""  I $P(PSOLST(Y),"^",2)=PSONV S PSLST=","_Y Q
"RTN","PSOVER",128,0)
 I $G(^PSRX(PSONV,"STA"))'=1&($G(^PSRX(PSONV,"STA"))'=4) S VALMBCK="Q" G EOJ2
"RTN","PSOVER",129,0)
 I '$G(PSOCLK)!('$G(PSOPOCK)) S VALMBCK="R" S:$G(PSOVBCK) VALMBCK="Q"
"RTN","PSOVER",130,0)
EOJ2 ;
"RTN","PSOVER",131,0)
 K PSONV,Y
"RTN","PSOVER",132,0)
 L -^PSRX($P(PSOLST(ORN),"^",2))
"RTN","PSOVER",133,0)
 Q
"RTN","PSOVER",134,0)
LPAT ;
"RTN","PSOVER",135,0)
 K PSOVERPL
"RTN","PSOVER",136,0)
 I '$G(PSOVERPX) Q
"RTN","PSOVER",137,0)
 S PSOPLCK=$$L^PSSLOCK(PSOVERPX,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S (PSOVERPL,PSOVERLX)=1
"RTN","PSOVER",138,0)
 K PSOPLCK
"RTN","PSOVER",139,0)
 Q
"RTN","PSOVER",140,0)
ULP ;
"RTN","PSOVER",141,0)
 I '$G(PSOVERPH) Q
"RTN","PSOVER",142,0)
 D UL^PSSLOCK(PSOVERPH) K PSOVERPH
"RTN","PSOVER",143,0)
 Q
"RTN","PSOVER",144,0)
LRX ;
"RTN","PSOVER",145,0)
 K PSOMSG I '$G(PSONV) Q
"RTN","PSOVER",146,0)
 D PSOL^PSSLOCK(PSONV) I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),! D  K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSOVER",147,0)
 .I $G(PSDFN) W "for patient "_$P($G(^DPT(PSDFN,0)),"^")_".",!
"RTN","PSOVER",148,0)
 Q
"RTN","PSOVER",149,0)
ULRX ;
"RTN","PSOVER",150,0)
 I '$G(PSONV) Q
"RTN","PSOVER",151,0)
 D PSOUL^PSSLOCK(PSONV)
"RTN","PSOVER",152,0)
 Q
"RTN","PSOVER",153,0)
LK1 ;
"RTN","PSOVER",154,0)
 I '$G(PSOLKVRX) Q
"RTN","PSOVER",155,0)
 D PSOL^PSSLOCK(PSOLKVRX) I '$G(PSOMSG) S VERLFLAG=1,PSOVMSGX=$P($G(PSOMSG),"^",2) Q
"RTN","PSOVER",156,0)
 S LOCKARRY(PSOLKVRX)=PSOLKVRX
"RTN","PSOVER",157,0)
 Q
"RTN","PSOVER",158,0)
ULK1 ;
"RTN","PSOVER",159,0)
 I '$D(LOCKARRY) Q
"RTN","PSOVER",160,0)
 S PSOVOLK="" F  S PSOVOLK=$O(LOCKARRY(PSOVOLK)) Q:$G(PSOVOLK)=""  D PSOUL^PSSLOCK(PSOVOLK)
"RTN","PSOVER",161,0)
 K PSOVOLK
"RTN","PSOVER",162,0)
 Q
"RTN","PSOVER",163,0)
ULB ;
"RTN","PSOVER",164,0)
 I $G(PSOVDFN) D UL^PSSLOCK(PSOVDFN)
"RTN","PSOVER",165,0)
 I $G(PSOVRXN) D PSOUL^PSSLOCK(PSOVRXN)
"RTN","PSOVER",166,0)
 K PSOVDFN,PSOVRXN
"RTN","PSOVER",167,0)
 Q
"RTN","PSOVER",168,0)
SAVE ;
"RTN","PSOVER",169,0)
 K PSOOVNOD,PSOOVSTA S (PSOOVNOD,PSOOVSTA)="",PSOOVNOD=^PS(52.4,PSONV,0),PSOOVSTA=$P(^PSRX(PSONV,"STA"),"^")
"RTN","PSOVER",170,0)
 Q
"RTN","PSOVER1")
0^16^B126246906
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207,148,243,268,281,324,358,251,375,387,379,390,372,416**;DEC 1997;Build 32
"RTN","PSOVER1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSOVER1",10,0)
 ;External reference to ^PS(4 supported by DBIA 2229
"RTN","PSOVER1",11,0)
 ;External reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSOVER1",12,0)
 ;External reference to ^DPT( supported by DBIA 3097
"RTN","PSOVER1",13,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOVER1",14,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOVER1",15,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOVER1",16,0)
REDO ;
"RTN","PSOVER1",17,0)
 I '$G(PSOCLK) Q:$G(PSVERFLG)
"RTN","PSOVER1",18,0)
 S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",19,0)
 S PSOVQUIT=0,PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",20,0)
 S PSOY(0)=^PSDRUG(PSODRUG("IEN"),0),PSOY=PSODRUG("IEN")_"^"_$P(PSOY(0),"^")
"RTN","PSOVER1",21,0)
 D SET^PSODRG
"RTN","PSOVER1",22,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",23,0)
 ;
"RTN","PSOVER1",24,0)
EDIT ;
"RTN","PSOVER1",25,0)
 S (PSDNEW,PSDOLD)="",PSDOLD=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV
"RTN","PSOVER1",26,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",27,0)
 I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",28,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to proceed with verification and order checks."
"RTN","PSOVER1",29,0)
 D ^DIR K DIR W ! I $G(DIRUT)!($G(DTOUT)) S PSOVBCK=1 G OUT
"RTN","PSOVER1",30,0)
 ;PSOPOCK=1 called from Process Order Check option; PSOCLK=1 means initiated from Rx verify by clerk.
"RTN","PSOVER1",31,0)
 I Y="Y",($G(PSOCLK)!($G(PSOPOCK))) D FULLEDT S VALMBCK="R" G KILL:$$CHECK(PSONV) G EDIT
"RTN","PSOVER1",32,0)
 I Y="Y",$G(PSOACT)]"" S VALMBCK="R",PSVERFLG=1 G OUT  ;this pops the user back to the med profile screen when verify is called from Patient Prescription Processing
"RTN","PSOVER1",33,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",34,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",35,0)
 G ORDCHK:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",36,0)
 ;
"RTN","PSOVER1",37,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",38,0)
 K PSD(PSDOLD) S PSDNEW="",PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",39,0)
 ;
"RTN","PSOVER1",40,0)
 S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) D ^PSORXPR G OUT:$G(DIRUT)
"RTN","PSOVER1",41,0)
 G OUT:$D(DIRUT)!($D(DTOUT))
"RTN","PSOVER1",42,0)
 I '$G(PSOCLK) S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) W !,"CHANGE",! D ^PSORXPR G OUT:$D(DIRUT)!($D(DTOUT)) G EDIT
"RTN","PSOVER1",43,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",44,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",45,0)
 W !!,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"")
"RTN","PSOVER1",46,0)
 D HD^PSODDPR2() D ^PSODSPL D SHOW2^PSOVER G EDIT Q
"RTN","PSOVER1",47,0)
 ;
"RTN","PSOVER1",48,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",49,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(4,DA,0),"^",7)=X Q
"RTN","PSOVER1",50,0)
 ;
"RTN","PSOVER1",51,0)
ORDCHK ;
"RTN","PSOVER1",52,0)
 S RX0=^PSRX(PSONV,0)
"RTN","PSOVER1",53,0)
 D ORDCK
"RTN","PSOVER1",54,0)
 I $G(PSOQUIT) S:$G(PSOCLK) PSOQUIT=0 S:'$G(PSOCLK) PSORX("DFLG")=1  ;if verify by clerk continue on with the next Rx; if not exit
"RTN","PSOVER1",55,0)
 I $G(PSOVQUIT)!$G(PSORX("DFLG")) G OUT
"RTN","PSOVER1",56,0)
 ;------
"RTN","PSOVER1",57,0)
VERIFY ; 
"RTN","PSOVER1",58,0)
 D FULL^VALM1 G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",59,0)
 W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"") W:$D(PSODRUG("NAME")) !,PSODRUG("NAME"),!
"RTN","PSOVER1",60,0)
 S DIR("A")="VERIFY FOR "_PSONAM_" ? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",61,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",62,0)
 D ^DIR K DIR
"RTN","PSOVER1",63,0)
 I Y="N"!("Q^"[$E(Y)) D  G OUT
"RTN","PSOVER1",64,0)
 .S (PSVERFLG,PSOVBCK)=1,PSORX("DFLG")=1
"RTN","PSOVER1",65,0)
 .S:$D(PSOOVNOD) ^PS(52.4,PSONV,0)=PSOOVNOD S:$G(PSOOVSTA) $P(^PSRX(PSONV,"STA"),"^")=PSOOVSTA
"RTN","PSOVER1",66,0)
 .S:PSOOVSTA=4 ^PS(52.4,"ADI",PSONV,1)=""
"RTN","PSOVER1",67,0)
 G DELETE:Y="D"
"RTN","PSOVER1",68,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",69,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",70,0)
 K ^PSRX(PSONV,"DRI"),SPFL
"RTN","PSOVER1",71,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",72,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",73,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",74,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",75,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",76,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",77,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",78,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",79,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",80,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",81,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",82,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",83,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",84,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",85,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",86,0)
 I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) D  G KILL
"RTN","PSOVER1",87,0)
 .S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^(2),"^",2),RXF=0
"RTN","PSOVER1",88,0)
 .D UPSUS S PSTRIVER=1 D SUS^PSORXL
"RTN","PSOVER1",89,0)
 .K PSORX("FILL DATE"),PSTRIVER
"RTN","PSOVER1",90,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",91,0)
 S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",92,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",93,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","") ;S VALMBCK=""
"RTN","PSOVER1",94,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOVER1",95,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOVER1",96,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOVER1",97,0)
 .N RXN,PSODAOC S RXN=PSONV,PSODAOC="Rx Backdoor VERIFIED NEW Order Acceptance_OP"
"RTN","PSOVER1",98,0)
 .D DAOC^PSONEW
"RTN","PSOVER1",99,0)
 .K ^TMP("PSODAOC",$J),RET
"RTN","PSOVER1",100,0)
 ;
"RTN","PSOVER1",101,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSOVER1",102,0)
 N ACTION
"RTN","PSOVER1",103,0)
 I $$SUBMIT^PSOBPSUT(PSONV) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSOVER1",104,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSONV,,,$S($O(^PSRX(PSONV,1,0)):"RF",1:"OF"))
"RTN","PSOVER1",105,0)
 . ; Quit if there is an unresolved Tricare non-billable reject code, PSO*7*358
"RTN","PSOVER1",106,0)
 . I $$PSOET^PSOREJP3(PSONV) S ACTION="Q" Q
"RTN","PSOVER1",107,0)
 . I $$FIND^PSOREJUT(PSONV) D
"RTN","PSOVER1",108,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSONV,0,"79,88","OF","IOQ","Q")
"RTN","PSOVER1",109,0)
 ;
"RTN","PSOVER1",110,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",111,0)
OUT ;
"RTN","PSOVER1",112,0)
 I '$G(PSOCLK) S:$G(DIRUT)!($G(DTOUT)) PSORX("DFLG")=1 K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN S VALMBCK="Q" Q
"RTN","PSOVER1",113,0)
 I $G(PSOCLK) S PSORX("DFLG")=0 K UPFLAGX D CLEAN Q
"RTN","PSOVER1",114,0)
DELETE K UPFLAGX D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",115,0)
QUIT S PSOQUIT="" D CLEAN Q
"RTN","PSOVER1",116,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",117,0)
 Q
"RTN","PSOVER1",118,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",119,0)
 I $G(PSODOSEX) K PSODOSEX Q
"RTN","PSOVER1",120,0)
 N PSOWRITE
"RTN","PSOVER1",121,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",122,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",123,0)
 .I $P(^TMP("PSORXDC",$J,RORD,0),"^")="P" D  Q
"RTN","PSOVER1",124,0)
 ..S PSOR=^PS(52.41,RORD,0)
"RTN","PSOVER1",125,0)
 ..S DNM=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSOVER1",126,0)
 ..W $C(7),!," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Pending Order "_DNM_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",127,0)
 .W !," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Rx #"_$P(^PSRX(RORD,0),"^")_" "_$P(^TMP("PSORXDC",$J,RORD,0),"^",7)_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",128,0)
 I $G(PSOWRITE)&('$G(PSOWRIT)) W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSOVER1",129,0)
 K ^TMP("PSORXDC",$J),RORD,PRNXZ,ORNZZ,PSOR
"RTN","PSOVER1",130,0)
 Q
"RTN","PSOVER1",131,0)
KV1 ;
"RTN","PSOVER1",132,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",133,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",134,0)
 Q
"RTN","PSOVER1",135,0)
NVA ;
"RTN","PSOVER1",136,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",137,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",138,0)
 S (Y,FLG)=""
"RTN","PSOVER1",139,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",140,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",141,0)
 Q
"RTN","PSOVER1",142,0)
REMOTE ; 
"RTN","PSOVER1",143,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",144,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",145,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",146,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSOVER1",147,0)
 .I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSOVER1",148,0)
 ..I $T(REMOTE^PSORX1)]"" Q
"RTN","PSOVER1",149,0)
 ..W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",150,0)
 .W !!,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",151,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",152,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL) ;D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",153,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",154,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",155,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",156,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",157,0)
 Q
"RTN","PSOVER1",158,0)
NOALRGY ;
"RTN","PSOVER1",159,0)
 N PSODFN,PSODRUG
"RTN","PSOVER1",160,0)
 S PSODFN=$P(^PSRX(PSONV,0),"^",2),PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",161,0)
 D NOALRGY^PSODRG
"RTN","PSOVER1",162,0)
 Q
"RTN","PSOVER1",163,0)
 ;
"RTN","PSOVER1",164,0)
ORDCK ;
"RTN","PSOVER1",165,0)
 N ORN,ORNZZ,PSOLST,Y,PSOODFN S ORN=PSONV,PSOLST(PSONV)=PSONV_"^"_PSONV,PSOVORD=1
"RTN","PSOVER1",166,0)
 N DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV
"RTN","PSOVER1",167,0)
 S ORNZZ=ORN,PRNXZ(ORN)=PSOLST(ORN),PSORENW("OIRXN")=PSONV,PSOODFN=DFN
"RTN","PSOVER1",168,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",169,0)
 D SHOW^PSOVER D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",170,0)
 S (PSODRUG("IEN"),PSDRUG("IEN"))=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",171,0)
 N PSOVINF S PSOVINF=^PSDRUG(PSDRUG("IEN"),0),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",172,0)
 S PSODRUG("VA CLASS")=$P(PSOVINF,"^",2),(DRG,PSODRUG("NAME"))=$P(^PSDRUG(PSDRUG("IEN"),0),"^")
"RTN","PSOVER1",173,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSDRUG("IEN"),"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOVER1",174,0)
 S PSODRUG("MAXDOSE")=$P(PSOVINF,"^",4),PSODRUG("DEA")=$P(PSOVINF,"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(PSDRUG("IEN"),"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOVER1",175,0)
 S PSODRUG("SIG")=$P(PSOVINF,"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(PSDRUG("IEN"),$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(PSDRUG("IEN"),660.1))
"RTN","PSOVER1",176,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,PSONV,81)
"RTN","PSOVER1",177,0)
 K PSOVINF
"RTN","PSOVER1",178,0)
 D POST^PSODRG S DFN=PSOODFN
"RTN","PSOVER1",179,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",180,0)
 I $G(PSVERFLG),$G(PSOCLK) S PSVERFLG=0
"RTN","PSOVER1",181,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",182,0)
 Q:PSORX("DFLG")
"RTN","PSOVER1",183,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("V")
"RTN","PSOVER1",184,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",185,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",186,0)
 Q:PSORX("DFLG")!($G(PSOQUIT))
"RTN","PSOVER1",187,0)
 S PSOLST(ORNZZ)=PRNXZ(ORNZZ),ORN=ORNZZ K PSORENW("OIRXN")
"RTN","PSOVER1",188,0)
 Q
"RTN","PSOVER1",189,0)
 ;
"RTN","PSOVER1",190,0)
FULLEDT  ;
"RTN","PSOVER1",191,0)
 D FULL^VALM1
"RTN","PSOVER1",192,0)
 N RX,FILL,OPSOLST,OPSLST,OLDDA,PSODRUG,REJ
"RTN","PSOVER1",193,0)
 S (RX,PSORXED("IRXN"))=PSONV
"RTN","PSOVER1",194,0)
 M OPSOLST=PSOLST,OPSLST=PSLST,ODA=DA
"RTN","PSOVER1",195,0)
 N PSOSITE,ORN,PSOPAR,PSOLIST,PSOSD
"RTN","PSOVER1",196,0)
 S PSOSITE=$$RXSITE^PSOBPSUT(RX,""),ORN=RX
"RTN","PSOVER1",197,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PSOLIST(1)=ORN_","
"RTN","PSOVER1",198,0)
 D EPH^PSORXEDT
"RTN","PSOVER1",199,0)
 M PSOLST=OPSOLST,PSLST=OPSLST S VALMBCK="R" S:$D(OLDDA) DA=OLDDA
"RTN","PSOVER1",200,0)
 Q
"RTN","PSOVER1",201,0)
 ;
"RTN","PSOVER1",202,0)
DRIDOSE(DA,RX0) ;where DA is RXIEN and RX0 is zero node of file 52 for the RXIEN
"RTN","PSOVER1",203,0)
 N T,RXN,RXX,SCRIPT,SEV,X,SER,PSOSERV,PSOSCPT,PSODOSF,RX
"RTN","PSOVER1",204,0)
 S RX=RX0
"RTN","PSOVER1",205,0)
 S RXN=$P(RX0,"^")
"RTN","PSOVER1",206,0)
 I $D(^PS(52.4,RX,0))!($D(^PSRX(RX,"DRI"))) D
"RTN","PSOVER1",207,0)
 . Q:'$P($G(^PS(52.4,RX,0)),"^",8)&('$D(^PSRX(RX,"DRI")))
"RTN","PSOVER1",208,0)
 .W !!,"*** During order, there were DRUG-DRUG INTERACTION for the following RX(s):"
"RTN","PSOVER1",209,0)
 I $P($G(^PS(52.4,RX,0)),"^",8) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",210,0)
 . S SER=$P(^PS(56,SEV(X),0),"^",4) S:$G(SER)=1 PSOSERV=1
"RTN","PSOVER1",211,0)
 . S PSOSCPT(RXX(X))="     "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION    "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",212,0)
 I $D(^PSRX(RX,"DRI")) S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",213,0)
 .S SER=$P(^PS(56,SEV(X),0),"^",4)
"RTN","PSOVER1",214,0)
 .S PSOSCPT(RXX(X))="     "_$P($G(^PSRX(RXX(X),0)),"^")_"  "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION  "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",215,0)
 S SCRIPT="" F  S SCRIPT=$O(PSOSCPT(SCRIPT)) Q:SCRIPT=""  W !,PSOSCPT(SCRIPT)
"RTN","PSOVER1",216,0)
 I $$DS^PSSDSAPI,$D(^PS(52.4,RX,1)) S T=$P(^PS(52.4,RX,1),"^") D  W:PSODOSF'="" !,"*** Dose Warning: ",PSODOSF
"RTN","PSOVER1",217,0)
 . S PSODOSF="",PSODOSF=$S(T=4:"DOSAGE EXCEEDS MAX SINGLE DOSE",T=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",T=2:"MAX SINGLE DOSE",T=1:"DAILY DOSE RANGE",1:"")
"RTN","PSOVER1",218,0)
 W !
"RTN","PSOVER1",219,0)
 Q
"RTN","PSOVER1",220,0)
CHECK(PSONV) ;
"RTN","PSOVER1",221,0)
 N PSOSTAT S PSOSTAT=$$GET1^DIQ(52,PSONV,100,"I")
"RTN","PSOVER1",222,0)
 I ",11,12,13,14,15,"[(","_PSOSTAT_",") Q 1
"RTN","PSOVER1",223,0)
 Q 0
"VER")
8.0^22.0
**INSTALL NAME**
GMRA*4.0*47
"BLD",8450,0)
GMRA*4.0*47^ADVERSE REACTION TRACKING^0^3130703^y
"BLD",8450,1,0)
^^3^3^3121120^
"BLD",8450,1,1,0)
This is a companion patch to the Order Entry/Results Reporting (OE/RR) 
"BLD",8450,1,2,0)
version 3.0 software patch number 345 (OR*3.0*345). See the patch message
"BLD",8450,1,3,0)
for a full listing of issues addressed and installation instructions.
"BLD",8450,4,0)
^9.64PA^^
"BLD",8450,6)
1^
"BLD",8450,6.3)
21
"BLD",8450,"KRN",0)
^9.67PA^779.2^20
"BLD",8450,"KRN",.4,0)
.4
"BLD",8450,"KRN",.401,0)
.401
"BLD",8450,"KRN",.402,0)
.402
"BLD",8450,"KRN",.403,0)
.403
"BLD",8450,"KRN",.5,0)
.5
"BLD",8450,"KRN",.84,0)
.84
"BLD",8450,"KRN",3.6,0)
3.6
"BLD",8450,"KRN",3.8,0)
3.8
"BLD",8450,"KRN",9.2,0)
9.2
"BLD",8450,"KRN",9.8,0)
9.8
"BLD",8450,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",8450,"KRN",9.8,"NM",1,0)
GMRAFX3^^0^B70101558
"BLD",8450,"KRN",9.8,"NM",2,0)
GMRAUTL2^^0^B90558602
"BLD",8450,"KRN",9.8,"NM","B","GMRAFX3",1)

"BLD",8450,"KRN",9.8,"NM","B","GMRAUTL2",2)

"BLD",8450,"KRN",19,0)
19
"BLD",8450,"KRN",19.1,0)
19.1
"BLD",8450,"KRN",101,0)
101
"BLD",8450,"KRN",409.61,0)
409.61
"BLD",8450,"KRN",771,0)
771
"BLD",8450,"KRN",779.2,0)
779.2
"BLD",8450,"KRN",870,0)
870
"BLD",8450,"KRN",8989.51,0)
8989.51
"BLD",8450,"KRN",8989.52,0)
8989.52
"BLD",8450,"KRN",8994,0)
8994
"BLD",8450,"KRN","B",.4,.4)

"BLD",8450,"KRN","B",.401,.401)

"BLD",8450,"KRN","B",.402,.402)

"BLD",8450,"KRN","B",.403,.403)

"BLD",8450,"KRN","B",.5,.5)

"BLD",8450,"KRN","B",.84,.84)

"BLD",8450,"KRN","B",3.6,3.6)

"BLD",8450,"KRN","B",3.8,3.8)

"BLD",8450,"KRN","B",9.2,9.2)

"BLD",8450,"KRN","B",9.8,9.8)

"BLD",8450,"KRN","B",19,19)

"BLD",8450,"KRN","B",19.1,19.1)

"BLD",8450,"KRN","B",101,101)

"BLD",8450,"KRN","B",409.61,409.61)

"BLD",8450,"KRN","B",771,771)

"BLD",8450,"KRN","B",779.2,779.2)

"BLD",8450,"KRN","B",870,870)

"BLD",8450,"KRN","B",8989.51,8989.51)

"BLD",8450,"KRN","B",8989.52,8989.52)

"BLD",8450,"KRN","B",8994,8994)

"BLD",8450,"QDEF")
^^^^^^^^^^YES
"BLD",8450,"QUES",0)
^9.62^^
"BLD",8450,"REQB",0)
^9.611^1^1
"BLD",8450,"REQB",1,0)
GMRA*4.0*45^2
"BLD",8450,"REQB","B","GMRA*4.0*45",1)

"MBREQ")
1
"PKG",247,-1)
1^1
"PKG",247,0)
ADVERSE REACTION TRACKING^GMRA^Adverse Reaction Tracking package
"PKG",247,22,0)
^9.49I^1^1
"PKG",247,22,1,0)
4.0^2960328^2960718^11595
"PKG",247,22,1,"PAH",1,0)
47^3130703^10000000068
"PKG",247,22,1,"PAH",1,1,0)
^^3^3^3130703
"PKG",247,22,1,"PAH",1,1,1,0)
This is a companion patch to the Order Entry/Results Reporting (OE/RR) 
"PKG",247,22,1,"PAH",1,1,2,0)
version 3.0 software patch number 345 (OR*3.0*345). See the patch message
"PKG",247,22,1,"PAH",1,1,3,0)
for a full listing of issues addressed and installation instructions.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","GMRAFX3")
0^1^B70101558
"RTN","GMRAFX3",1,0)
GMRAFX3 ;SLC/DAN Update existing entries to new reactant ;11/20/12  07:54
"RTN","GMRAFX3",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,23,20,45,47**;Mar 29, 1996;Build 21
"RTN","GMRAFX3",3,0)
 ;DBIA SECTION
"RTN","GMRAFX3",4,0)
 ;10018 - DIE
"RTN","GMRAFX3",5,0)
 ;2056  - DIQ
"RTN","GMRAFX3",6,0)
 ;3154  - ORQ1
"RTN","GMRAFX3",7,0)
 ;4134  - ORCHECK
"RTN","GMRAFX3",8,0)
 ;4135  - ORKCHK
"RTN","GMRAFX3",9,0)
 ;10026 - DIR
"RTN","GMRAFX3",10,0)
 ;
"RTN","GMRAFX3",11,0)
UIE ;Update individual entries
"RTN","GMRAFX3",12,0)
 N DFN,GMRAOUT,GMRAING,GMRADRCL,DIE,DA,DR,AIFN,SIGN,TIME,SUB,ORX,GMRAORX,GMRAOC,GI,FND,COM,SIEN,DIR,Y
"RTN","GMRAFX3",13,0)
 S GMRADONE=0 ;Flag to keep track of updated entries
"RTN","GMRAFX3",14,0)
 S DFN=$P($G(^GMR(120.8,GMRAPA,0)),U) Q:'+DFN
"RTN","GMRAFX3",15,0)
 W !!,"For patient ",$$GET1^DIQ(2,DFN_",",.01),!
"RTN","GMRAFX3",16,0)
 I $D(GMRAAR) D
"RTN","GMRAFX3",17,0)
 .S DIR(0)="Y",DIR("A")="Use reactant "_GMRAAR(0),DIR("B")="Y" D ^DIR
"RTN","GMRAFX3",18,0)
 .K:'Y GMRAAR
"RTN","GMRAFX3",19,0)
 .Q
"RTN","GMRAFX3",20,0)
 I '$D(GMRAAR) D ^GMRAFX2 I $D(GMRAAR) D RUSURE(.GMRASURE) ;20 Get new reactant
"RTN","GMRAFX3",21,0)
 I '$D(GMRAAR)!('$G(GMRASURE)) K GMRAAR Q  ;20 stop if no reactant selected or if user doesn't want to use selected reactant
"RTN","GMRAFX3",22,0)
 S GMRAOUT=0
"RTN","GMRAFX3",23,0)
 I $$DUP W !,"Patient already has an active allergy for this reactant.",!,"Duplicate not allowed.",! D WAIT Q
"RTN","GMRAFX3",24,0)
 I $$DUPCHK^GMRAPES0(GMRAAR(0),DFN,GMRAPA) Q  ;Checks to see if reactant previously entered in error.
"RTN","GMRAFX3",25,0)
 ;Update reactant, allergy and signed off fields
"RTN","GMRAFX3",26,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR=".02////"_GMRAAR(0)_";1////^S X=GMRAAR"_";3.1////"_GMRAAR("O")_";15///1" D ^DIE
"RTN","GMRAFX3",27,0)
 I $D(^GMR(120.85,"C",GMRAPA)) D  ;Observed reaction, need to update data
"RTN","GMRAFX3",28,0)
 .S AIFN=0
"RTN","GMRAFX3",29,0)
 .F  S AIFN=$O(^GMR(120.85,"C",GMRAPA,AIFN)) Q:'+AIFN  D
"RTN","GMRAFX3",30,0)
 ..S SIEN=$O(^GMR(120.85,AIFN,3,"B",$P(^XTMP("GMRAFX",LTYPE,"IDX",+NMBR),"^"),0)) Q:'+SIEN  ;Was previous reactant stored as "suspected agent"
"RTN","GMRAFX3",31,0)
 ..S DA(1)=AIFN,DA=SIEN
"RTN","GMRAFX3",32,0)
 ..S DIE="^GMR(120.85,DA(1),3,",DR=".01////^S X=GMRAAR(0)" D ^DIE ;Update suspected agent to new value
"RTN","GMRAFX3",33,0)
 D DELMUL(2),DELMUL(3) ;Delete drug ingredient/drug classes multiples
"RTN","GMRAFX3",34,0)
 I GMRAAR("O")["D" D UPDATE^GMRAPES1 ;If reactant type is Drug then add appropriate ingredients and classes
"RTN","GMRAFX3",35,0)
 S GMRADONE=1 ;Update complete
"RTN","GMRAFX3",36,0)
 S COM="Updated using clean up process.  Changed reactant from "_$P(^XTMP("GMRAFX",LTYPE,"IDX",+NMBR),"^",2)_$S(LTYPE="FREE":" (free text) ",LTYPE="ING":" (ingredient) ",1:" (drug class) ")_"to "_GMRAAR(0)_"(file - "_$P(GMRAAR,";",2)_")"
"RTN","GMRAFX3",37,0)
 D ADCOM^GMRAFX(GMRAPA,"O",COM) ;Add a comment for this update
"RTN","GMRAFX3",38,0)
 ;Do order checking here - compare existing orders against new allergy information.
"RTN","GMRAFX3",39,0)
 W !,"Performing order checking..."
"RTN","GMRAFX3",40,0)
 K ^TMP("ORR",$J),GMRAOC,ORX
"RTN","GMRAFX3",41,0)
 D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAFX3",42,0)
 S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAFX3",43,0)
 I '^TMP("ORR",$J,TIME,"TOT") W "patient has no active orders." Q  ;20 No orders found
"RTN","GMRAFX3",44,0)
 S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAFX3",45,0)
 .D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAFX3",46,0)
 M GMRAORX=ORX K ORX ;19
"RTN","GMRAFX3",47,0)
 N ORDODSG S ORDODSG=0
"RTN","GMRAFX3",48,0)
 D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT",,.ORDODSG)
"RTN","GMRAFX3",49,0)
 S GI=0,FND=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAFX3",50,0)
 .Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAFX3",51,0)
 .;Q:$D(^OR(100,$P(GMRAOC(GI),U),9,"B",3))  ;23 If order check exists can't be for this data
"RTN","GMRAFX3",52,0)
 .Q:$$ANYARTOC^GMRAUTL2($P(GMRAOC(GI),U))  ;23 If order check exists can't be for this data
"RTN","GMRAFX3",53,0)
 .W !,"Patient has a(n) ",$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)," order for",$P($P(GMRAOC(GI),U,4),":",2),", order #",$P(GMRAOC(GI),U)
"RTN","GMRAFX3",54,0)
 .S FND=1
"RTN","GMRAFX3",55,0)
 W:'FND "No problems found"
"RTN","GMRAFX3",56,0)
 D WAIT
"RTN","GMRAFX3",57,0)
 Q
"RTN","GMRAFX3",58,0)
 ;
"RTN","GMRAFX3",59,0)
DELMUL(FIELD) ;Delete multiple FIELD from GMR ALLERGY file
"RTN","GMRAFX3",60,0)
 N MIEN,DA,DIE,DR
"RTN","GMRAFX3",61,0)
 S MIEN=0 F  S MIEN=$O(^GMR(120.8,GMRAPA,FIELD,MIEN)) Q:'+MIEN  D
"RTN","GMRAFX3",62,0)
 .S DA(1)=GMRAPA,DA=MIEN
"RTN","GMRAFX3",63,0)
 .S DIE="^GMR(120.8,DA(1),FIELD,",DR=".01///@" D ^DIE ;Delete entry
"RTN","GMRAFX3",64,0)
 Q
"RTN","GMRAFX3",65,0)
 ;
"RTN","GMRAFX3",66,0)
DUP() ;Function returns true (1) if selected reactant is a duplicate
"RTN","GMRAFX3",67,0)
 N LOOP,FND
"RTN","GMRAFX3",68,0)
 S LOOP=0,FND=0
"RTN","GMRAFX3",69,0)
 F  S LOOP=$O(^GMR(120.8,"B",DFN,LOOP)) Q:'+LOOP!(FND)  D
"RTN","GMRAFX3",70,0)
 .I $P(^GMR(120.8,LOOP,0),U,3)=GMRAAR&('$D(^GMR(120.8,LOOP,"ER"))) S FND=1
"RTN","GMRAFX3",71,0)
 Q FND
"RTN","GMRAFX3",72,0)
 ;
"RTN","GMRAFX3",73,0)
WAIT ;Issues press enter to return prompt
"RTN","GMRAFX3",74,0)
 N DIR
"RTN","GMRAFX3",75,0)
 S DIR(0)="E",DIR("A")="Press enter to continue" D ^DIR
"RTN","GMRAFX3",76,0)
 Q
"RTN","GMRAFX3",77,0)
 ;
"RTN","GMRAFX3",78,0)
GETNUM(ACTION) ; -- Return numbers to act on, if action chosen first
"RTN","GMRAFX3",79,0)
 N X,Y,DIR,MAX,DTOUT
"RTN","GMRAFX3",80,0)
 S MAX=$S($D(^TMP($J,LTYPE,"IDX2")):$G(^TMP($J,LTYPE,"IDX2",0)),1:$G(VALMCNT)) Q:MAX'>0 ""
"RTN","GMRAFX3",81,0)
 I ACTION="DET" W !!,"Please choose only one entry for the detailed display."
"RTN","GMRAFX3",82,0)
 S DIR(0)="LAO^1:"_MAX,DIR("A")="Select Entries from list: "
"RTN","GMRAFX3",83,0)
 S DIR("?")="Enter the items you wish to act on, as a range or list of numbers."
"RTN","GMRAFX3",84,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","GMRAFX3",85,0)
 I $D(Y(1)) W !,">>>Too many entries selected, try using smaller ranges" H 2 S Y="^"
"RTN","GMRAFX3",86,0)
 I $L($G(Y),",")>2,ACTION="DET" W !,">>You may only choose ONE group for detailed display." H 2 S Y="^"
"RTN","GMRAFX3",87,0)
 Q Y
"RTN","GMRAFX3",88,0)
 ;
"RTN","GMRAFX3",89,0)
UPDATE ;Update display to account for changes to the list
"RTN","GMRAFX3",90,0)
 N CNT,SP1,SP2,SP3
"RTN","GMRAFX3",91,0)
 I VALMAR["GMRADET" N VALMAR S VALMAR="^XTMP(""GMRAFX"",LTYPE)"
"RTN","GMRAFX3",92,0)
 S CNT=^XTMP("GMRAFX",LTYPE,"GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))-1
"RTN","GMRAFX3",93,0)
 S ^XTMP("GMRAFX",LTYPE,"GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))=CNT K ^($P(ENTRY,U,2),GMRAJ)
"RTN","GMRAFX3",94,0)
 S SP1=4-$L(+NUM),SP2=40-$L($P(ENTRY,U)),SP3=$S(CNT:16-$L(CNT)\2,1:2)
"RTN","GMRAFX3",95,0)
 D SET^VALM10(+NUM,+NUM_$$REPEAT^XLFSTR(" ",SP1)_$P(ENTRY,U,2)_$$REPEAT^XLFSTR(" ",(SP2+SP3))_$S(CNT:CNT,1:"** FIXED **"))
"RTN","GMRAFX3",96,0)
 Q
"RTN","GMRAFX3",97,0)
 ;
"RTN","GMRAFX3",98,0)
LOCK(ENTRY) ;Lock entry in 120.8
"RTN","GMRAFX3",99,0)
 N LOCK
"RTN","GMRAFX3",100,0)
 S LOCK=1
"RTN","GMRAFX3",101,0)
 L +^XTMP("GMRAFX",LTYPE,"IDX",ENTRY):1
"RTN","GMRAFX3",102,0)
 I '$T D FULL^VALM1 S VALMBCK="R" W !,"The ",$P(^XTMP("GMRAFX",LTYPE,"IDX",ENTRY),U)," group is being edited by another user" D WAIT S LOCK=0
"RTN","GMRAFX3",103,0)
 Q LOCK
"RTN","GMRAFX3",104,0)
 ;
"RTN","GMRAFX3",105,0)
AR ;Add/edit patient reactions
"RTN","GMRAFX3",106,0)
 N LCV,DFN,SUB
"RTN","GMRAFX3",107,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",108,0)
 W !!,"You should use this option to add NEW reactions only.  If you mark"
"RTN","GMRAFX3",109,0)
 W !,"existing entries as entered in error from within this option it will"
"RTN","GMRAFX3",110,0)
 W !,"not update the utility's display until the list is rebuilt upon re-entry"
"RTN","GMRAFX3",111,0)
 W !,"of this option.  This could cause confusion as the list will no longer"
"RTN","GMRAFX3",112,0)
 W !,"be accurate.",!
"RTN","GMRAFX3",113,0)
 I '$G(NMBR2) D WAIT,EN1^GMRAPEM0 Q
"RTN","GMRAFX3",114,0)
 F LCV=1:1:$L(NMBR2,",")-1 S SUB=$P(NMBR2,",",LCV) S DFN=+$P($G(^GMR(120.8,+$P($G(^TMP($J,LTYPE,"IDX2",SUB)),U,2),0)),U) I DFN W !!,"Now working with patient ",$$GET1^DIQ(2,DFN,.01),! D WAIT D EN2^GMRAPEM0
"RTN","GMRAFX3",115,0)
 Q
"RTN","GMRAFX3",116,0)
 ;
"RTN","GMRAFX3",117,0)
DSPREACT ;Display detailed information about the reactant
"RTN","GMRAFX3",118,0)
 N DIC,DA,GMRAI,STOP,NUM2,DIR,Y,DIRUT
"RTN","GMRAFX3",119,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",120,0)
 I '$G(NMBR2) S NMBR2=$$GETNUM("") Q:'+NMBR2
"RTN","GMRAFX3",121,0)
 F GMRAI=1:1:($L(NMBR2,",")-1) D  Q:$G(STOP)
"RTN","GMRAFX3",122,0)
 .S NUM2=$P(NMBR2,",",GMRAI)
"RTN","GMRAFX3",123,0)
 .S DA=$P(^TMP($J,LTYPE,"IDX2",NUM2),U,2) Q:'DA
"RTN","GMRAFX3",124,0)
 .S DIC="^GMR(120.8,"
"RTN","GMRAFX3",125,0)
 .W ! D EN^DIQ
"RTN","GMRAFX3",126,0)
 .S DIR(0)="E",DIR("A")="Press return to continue or '^' to stop" D ^DIR
"RTN","GMRAFX3",127,0)
 .S:$D(DIRUT) STOP=1
"RTN","GMRAFX3",128,0)
 .Q
"RTN","GMRAFX3",129,0)
 Q
"RTN","GMRAFX3",130,0)
 ;
"RTN","GMRAFX3",131,0)
GETTYPE(LTYPE) ;Function determines which list to work with
"RTN","GMRAFX3",132,0)
 N DIR,X,Y
"RTN","GMRAFX3",133,0)
 S DIR(0)="SO^1:Free Text;2:Ingredient;3:Drug Class"
"RTN","GMRAFX3",134,0)
 S DIR("A")="Select the list you wish to work with"
"RTN","GMRAFX3",135,0)
 D ^DIR K DIR
"RTN","GMRAFX3",136,0)
 S LTYPE=$S(Y=1:"FREE",Y=2:"ING",Y=3:"DRUG",1:0)
"RTN","GMRAFX3",137,0)
 Q LTYPE
"RTN","GMRAFX3",138,0)
 ;
"RTN","GMRAFX3",139,0)
EIE ;Mark individual entry as entered in error
"RTN","GMRAFX3",140,0)
 N DIE,DA,DR,Y,DIK,DFN,OROLD,VAIN,X,GMRAOUT
"RTN","GMRAFX3",141,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR="15///1;22///1;23///NOW;24////"_$G(DUZ,.5) ;20
"RTN","GMRAFX3",142,0)
 D ^DIE ;Entered in error on date/time by user
"RTN","GMRAFX3",143,0)
 D ADCOM^GMRAFX(GMRAPA,"E","Marked Entered in Error during clean up process")
"RTN","GMRAFX3",144,0)
 I $$NKASCR^GMRANKA($P(^GMR(120.8,GMRAPA,0),U)) D
"RTN","GMRAFX3",145,0)
 .S DIK="^GMR(120.86,",DA=$P(^GMR(120.8,GMRAPA,0),U)
"RTN","GMRAFX3",146,0)
 .D ^DIK ;If patient's last allergy marked as entered in error then delete assessment
"RTN","GMRAFX3",147,0)
 .W !!,"**NOTE: By marking this reaction as entered in error, ",$$GET1^DIQ(2,DA,.01,"E"),!,"no longer has an assessment on file.  You may reassess this patient",!
"RTN","GMRAFX3",148,0)
 .W "now by answering the following prompt or hit return to do it later.",!
"RTN","GMRAFX3",149,0)
 .D NKAASK^GMRANKA(DA)
"RTN","GMRAFX3",150,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAFX3",151,0)
 S GMRAOUT=0
"RTN","GMRAFX3",152,0)
 D EN1^GMRAEAB ;Sends entered in error bulletin to appropriate mail groups
"RTN","GMRAFX3",153,0)
 S DFN=$P(GMRAPA(0),U)
"RTN","GMRAFX3",154,0)
 D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA ENTERED IN ERROR")_";ORD(101," ;19
"RTN","GMRAFX3",155,0)
 D:X EN^XQOR ;Process protocols hanging off of "entered in error" protocol
"RTN","GMRAFX3",156,0)
 Q
"RTN","GMRAFX3",157,0)
 ;
"RTN","GMRAFX3",158,0)
RUSURE(GMRASURE) ;20 Make sure selection from ingredient or drug class file is ok
"RTN","GMRAFX3",159,0)
 ;entire section added in patch 20
"RTN","GMRAFX3",160,0)
 N DIR,Y,X
"RTN","GMRAFX3",161,0)
 S GMRASURE=1
"RTN","GMRAFX3",162,0)
 I $G(GMRAAR)["50.416"!($G(GMRAAR)["50.605") D
"RTN","GMRAFX3",163,0)
 .S DIR("A")="Are you sure you want to use this reactant"
"RTN","GMRAFX3",164,0)
 .S DIR("A",1)="You are about to update the entry with a selection from"
"RTN","GMRAFX3",165,0)
 .S DIR("A",2)="the "_$S($G(GMRAAR)["50.416":"INGREDIENT",1:"VA DRUG CLASS")_" file.  By doing that you are"
"RTN","GMRAFX3",166,0)
 .S DIR("A",3)="limiting the information available for order checking."
"RTN","GMRAFX3",167,0)
 .S DIR("A",4)=""
"RTN","GMRAFX3",168,0)
 .S DIR("A",5)="In general, it is better to choose from one of the drug related files"
"RTN","GMRAFX3",169,0)
 .S DIR("A",6)="as that ensures that drug class and ingredient information are part"
"RTN","GMRAFX3",170,0)
 .S DIR("A",7)="of the patient's allergy definition and will provide better allergy"
"RTN","GMRAFX3",171,0)
 .S DIR("A",8)="order checking."
"RTN","GMRAFX3",172,0)
 .S DIR("A",9)=""
"RTN","GMRAFX3",173,0)
 .S DIR(0)="Y",DIR("B")="NO"
"RTN","GMRAFX3",174,0)
 .D ^DIR S GMRASURE=+Y
"RTN","GMRAFX3",175,0)
 Q
"RTN","GMRAUTL2")
0^2^B90558602
"RTN","GMRAUTL2",1,0)
GMRAUTL2 ;SLC/DAN - New style index utilities, update utility for 120.8 ;11/20/12  08:09
"RTN","GMRAUTL2",2,0)
 ;;4.0;Adverse Reaction Tracking;**23,36,41,45,47**;Mar 29, 1996;Build 21
"RTN","GMRAUTL2",3,0)
 ;DBIA Section
"RTN","GMRAUTL2",4,0)
 ;%ZTLOAD    - 10063
"RTN","GMRAUTL2",5,0)
 ;DIE        - 10018
"RTN","GMRAUTL2",6,0)
 ;FILE^DIE   - 2053
"RTN","GMRAUTL2",7,0)
 ;UPDATE^DIE - 2053
"RTN","GMRAUTL2",8,0)
 ;DIQ        - 2056
"RTN","GMRAUTL2",9,0)
 ;ORCHECK    - 4859
"RTN","GMRAUTL2",10,0)
 ;ORKCHK     - 4135
"RTN","GMRAUTL2",11,0)
 ;ORQOR2     - 3458
"RTN","GMRAUTL2",12,0)
 ;ORX8       - 2467
"RTN","GMRAUTL2",13,0)
 ;PSN50P41   - 4531
"RTN","GMRAUTL2",14,0)
 ;PSN50P65   - 4543
"RTN","GMRAUTL2",15,0)
 ;XLFDT      - 10103
"RTN","GMRAUTL2",16,0)
 ;XTID       - 4631
"RTN","GMRAUTL2",17,0)
 ;
"RTN","GMRAUTL2",18,0)
 N GMRAI,GMRAC,ENTRY
"RTN","GMRAUTL2",19,0)
 Q:$G(X1(1))=$G(X2(1))  ;Entry unchanged
"RTN","GMRAUTL2",20,0)
 S ENTRY=DA(1)_";GMRD(120.82,"_"^"_$P(^GMRD(120.82,DA(1),0),"^")
"RTN","GMRAUTL2",21,0)
 I $G(X1(1))>0,$G(X2(1))>0 S:$G(GMRAT)="ING" GMRAI("D",X1(1))="",GMRAI("A",X2(1))="" S:$G(GMRAT)="CLASS" GMRAC("D",X1(1))="",GMRAC("A",X2(1))="" ;Edited existing entry
"RTN","GMRAUTL2",22,0)
 I $G(X1(1))>0,$G(X2(1))="" S:$G(GMRAT)="ING" GMRAI("D",X1(1))="" S:$G(GMRAT)="CLASS" GMRAC("D",X1(1))="" ;Entry deleted
"RTN","GMRAUTL2",23,0)
 I $G(X1(1))="",$G(X2(1))>0 S:$G(GMRAT)="ING" GMRAI("A",X2(1))="" S:$G(GMRAT)="CLASS" GMRAC("A",X2(1))="" ;New entry
"RTN","GMRAUTL2",24,0)
 D QUP ;Queue updating of existing entries and order checking
"RTN","GMRAUTL2",25,0)
 Q
"RTN","GMRAUTL2",26,0)
 ;
"RTN","GMRAUTL2",27,0)
QUP ;Queue the update
"RTN","GMRAUTL2",28,0)
 N ZTRTN,ZTIO,ZTDTH,ZTDESC,ZTSAVE
"RTN","GMRAUTL2",29,0)
 S ZTRTN="UPDATE^GMRAUTL2(ENTRY,.GMRAI,.GMRAC)",ZTIO="GMRA UPDATE RESOURCE",ZTDTH=$H,ZTDESC="Update existing allergies",ZTSAVE("*")="" D ^%ZTLOAD Q
"RTN","GMRAUTL2",30,0)
 ;
"RTN","GMRAUTL2",31,0)
UPDATE(ENTRY,ING,CLASS) ;Update existing entries in 120.8 with new information.
"RTN","GMRAUTL2",32,0)
 ;Entry is IEN;File reference^Text of file entry - 6;GMRD(120.82,^STRAWBERRIES
"RTN","GMRAUTL2",33,0)
 ;ING - Array of ingredients - "A",IEN for those to be added and "D",IEN for those to be deleted
"RTN","GMRAUTL2",34,0)
 ;CLASS - Array of drug classes - "A",IEN for those to be added and "D",IEN for those to be deleted
"RTN","GMRAUTL2",35,0)
 ;
"RTN","GMRAUTL2",36,0)
 N ALLERGY,POINTER,ACTION,SUB,SUBI,SUBC,DFN,GMRAS,GMRACOM,UPDATED
"RTN","GMRAUTL2",37,0)
 S ALLERGY=$P(ENTRY,"^",2) Q:ALLERGY=""
"RTN","GMRAUTL2",38,0)
 S POINTER=$P(ENTRY,"^") Q:POINTER=""
"RTN","GMRAUTL2",39,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,"C",ALLERGY,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",40,0)
 .S DFN=$P(^GMR(120.8,SUB,0),U)
"RTN","GMRAUTL2",41,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",42,0)
 .Q:$P(^GMR(120.8,SUB,0),"^",3)'=POINTER  ;Same text name but not the same entry
"RTN","GMRAUTL2",43,0)
 .Q:$G(^GMR(120.8,SUB,"ER"))>0  ;Entered in error
"RTN","GMRAUTL2",44,0)
 .S GMRACOM=0
"RTN","GMRAUTL2",45,0)
 .F ACTION="A","D" D
"RTN","GMRAUTL2",46,0)
 ..S SUBI=0 F  S SUBI=$O(ING(ACTION,SUBI)) Q:'+SUBI  D
"RTN","GMRAUTL2",47,0)
 ...I ACTION="A" D ADD("I",SUB,SUBI,.GMRAS) I $G(GMRAS) S ING(ACTION,SUBI)=1,GMRACOM=1,UPDATED(DFN)=""
"RTN","GMRAUTL2",48,0)
 ...I ACTION="D" D DEL("I",SUB,SUBI,.GMRAS) I $G(GMRAS) S ING(ACTION,SUBI)=1,GMRACOM=1
"RTN","GMRAUTL2",49,0)
 ..S SUBC=0 F  S SUBC=$O(CLASS(ACTION,SUBC)) Q:'+SUBC  D
"RTN","GMRAUTL2",50,0)
 ...I ACTION="A" D ADD("C",SUB,SUBC,.GMRAS) I $G(GMRAS) S CLASS(ACTION,SUBC)=1,UPDATED(DFN)="",GMRACOM=1
"RTN","GMRAUTL2",51,0)
 ...I ACTION="D" D DEL("C",SUB,SUBC,.GMRAS) I $G(GMRAS) S GMRACOM=1,CLASS(ACTION,SUBC)=1
"RTN","GMRAUTL2",52,0)
 .I $G(GMRACOM) D ADDCOM
"RTN","GMRAUTL2",53,0)
 I $D(UPDATED) D CHKORD ;New order checks now?
"RTN","GMRAUTL2",54,0)
 Q
"RTN","GMRAUTL2",55,0)
 ;
"RTN","GMRAUTL2",56,0)
ADD(TYPE,ALENT,SUBENT,GMRAS) ;Adds entry to appropriate multiple
"RTN","GMRAUTL2",57,0)
 N FILE,FDA,EM
"RTN","GMRAUTL2",58,0)
 S GMRAS=1
"RTN","GMRAUTL2",59,0)
 I $D(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT)) S GMRAS=0 Q  ;Entry already exists
"RTN","GMRAUTL2",60,0)
 L +^GMR(120.8,ALENT):20 I '$T Q
"RTN","GMRAUTL2",61,0)
 S FILE=$S(TYPE="I":120.802,1:120.803)
"RTN","GMRAUTL2",62,0)
 S FDA(FILE,"+1,"_ALENT_",",.01)=SUBENT
"RTN","GMRAUTL2",63,0)
 D UPDATE^DIE("","FDA",,"EM")
"RTN","GMRAUTL2",64,0)
 L -^GMR(120.8,ALENT)
"RTN","GMRAUTL2",65,0)
 Q
"RTN","GMRAUTL2",66,0)
 ;
"RTN","GMRAUTL2",67,0)
DEL(TYPE,ALENT,SUBENT,GMRAS) ;Delete entry from multiple
"RTN","GMRAUTL2",68,0)
 N FILE,FDA,EM,ENTRY
"RTN","GMRAUTL2",69,0)
 S GMRAS=1
"RTN","GMRAUTL2",70,0)
 I '$D(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT)) S GMRAS=0 Q  ;No entry to delete
"RTN","GMRAUTL2",71,0)
 L +^GMR(120.8,ALENT):20 I '$T Q
"RTN","GMRAUTL2",72,0)
 S ENTRY=$O(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT,0)) Q:'+ENTRY
"RTN","GMRAUTL2",73,0)
 S FILE=$S(TYPE="I":120.802,1:120.803)
"RTN","GMRAUTL2",74,0)
 S FDA(FILE,ENTRY_","_ALENT_",",.01)="@"
"RTN","GMRAUTL2",75,0)
 D FILE^DIE("","FDA","EM")
"RTN","GMRAUTL2",76,0)
 L -^GMR(120.8,ALENT)
"RTN","GMRAUTL2",77,0)
 Q
"RTN","GMRAUTL2",78,0)
 ;
"RTN","GMRAUTL2",79,0)
CHKORD ;Check for orders that are now in conflict with existing allergy data
"RTN","GMRAUTL2",80,0)
 N TIME,GMRAOC,ORX,SUB,GMRAORX,GI,CNT,DFN
"RTN","GMRAUTL2",81,0)
 Q:'+$G(DUZ)  ;Don't check if no valid user to send data to
"RTN","GMRAUTL2",82,0)
 K ^TMP("ORR",$J),^TMP($J,"ERR")
"RTN","GMRAUTL2",83,0)
 S DFN=0 F  S DFN=$O(UPDATED(DFN)) Q:'+DFN  D
"RTN","GMRAUTL2",84,0)
 .D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAUTL2",85,0)
 .S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAUTL2",86,0)
 .Q:'^TMP("ORR",$J,TIME,"TOT")  ;No orders found
"RTN","GMRAUTL2",87,0)
 .S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",88,0)
 ..D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAUTL2",89,0)
 .M GMRAORX=ORX K ORX,GMRAOC
"RTN","GMRAUTL2",90,0)
 .N ORDODSG S ORDODSG=0
"RTN","GMRAUTL2",91,0)
 .D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT",,.ORDODSG)
"RTN","GMRAUTL2",92,0)
 .S GI=0,CNT=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAUTL2",93,0)
 ..Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAUTL2",94,0)
 ..;Q:$D(^OR(100,$P(GMRAOC(GI),U),9,"B",3))  ;Quit if existing allergy order check, can't be for this new information
"RTN","GMRAUTL2",95,0)
 ..Q:$$ANYARTOC^GMRAUTL2($P(GMRAOC(GI),U))  ;Quit if existing allergy order check, can't be for this new information
"RTN","GMRAUTL2",96,0)
 ..S CNT=CNT+1,^TMP($J,"ERR",DFN,CNT)=$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)_" order for "_$P($$OI^ORX8($P(GMRAOC(GI),U)),U,2)_",order #"_$P(GMRAOC(GI),U)
"RTN","GMRAUTL2",97,0)
 .K GMRAORX ;Remove previous list of orders
"RTN","GMRAUTL2",98,0)
 D MAIL K ^TMP("ORR",$J),^TMP($J,"ERR")
"RTN","GMRAUTL2",99,0)
 Q
"RTN","GMRAUTL2",100,0)
 ;
"RTN","GMRAUTL2",101,0)
ANYARTOC(GMRAIFN) ;check order to see if there are any allergy order checks
"RTN","GMRAUTL2",102,0)
 N GMRARET,GMRAI
"RTN","GMRAUTL2",103,0)
 S GMRARET=0
"RTN","GMRAUTL2",104,0)
 K ^TMP($J,"GMRAOC")
"RTN","GMRAUTL2",105,0)
 D OCAPI^ORCHECK(+GMRAIFN,"GMRAOC")
"RTN","GMRAUTL2",106,0)
 S GMRAI=0 F  S GMRAI=$O(^TMP($J,"GMRAOC",GMRAI)) Q:'GMRAI  I $G(^TMP($J,"GMRAOC",GMRAI,"OC NUMBER"))=3 S GMRARET=1
"RTN","GMRAUTL2",107,0)
 K ^TMP($J,"GMRAOC")
"RTN","GMRAUTL2",108,0)
 Q GMRARET
"RTN","GMRAUTL2",109,0)
ADDCOM ;Add comment to updated allergy indicating changes
"RTN","GMRAUTL2",110,0)
 D ADDCOM^GMRAUTL3 ;41 Moved section due to space considerations
"RTN","GMRAUTL2",111,0)
 Q
"RTN","GMRAUTL2",112,0)
 ;
"RTN","GMRAUTL2",113,0)
MAIL ;Send message containing potential order checks to user.
"RTN","GMRAUTL2",114,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,CNT,SUB,ERR,TYPE,NUM
"RTN","GMRAUTL2",115,0)
 Q:'$D(^TMP($J,"ERR"))  ;Nothing to report
"RTN","GMRAUTL2",116,0)
 K ^TMP($J,"TEXT"),^TMP($J,"GMRAINFO") ;41 Clear out storage area
"RTN","GMRAUTL2",117,0)
 S XMDUZ="Allergy auto-update program"
"RTN","GMRAUTL2",118,0)
 S XMY($G(DUZ,.5))="" ;Send to user who initiated change or postmaster
"RTN","GMRAUTL2",119,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")="" ;Include mail group to be sure someone gets this message
"RTN","GMRAUTL2",120,0)
 S CNT=1
"RTN","GMRAUTL2",121,0)
 S ^TMP($J,"TEXT",CNT)="The "_$P(ENTRY,U,2)_" reactant was updated.",CNT=CNT+1
"RTN","GMRAUTL2",122,0)
 S ^TMP($J,"TEXT",CNT)="The following drug classes and/or drug ingredients were added:",CNT=CNT+1,^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",123,0)
 F TYPE="GMRAI","GMRAC" D
"RTN","GMRAUTL2",124,0)
 .I $D(@(TYPE)) D
"RTN","GMRAUTL2",125,0)
 ..S ^TMP($J,"TEXT",CNT)=$S(TYPE="GMRAI":"Ingredients",1:"Classes")_": ",CNT=CNT+1
"RTN","GMRAUTL2",126,0)
 ..S NUM=0 F  S NUM=$O(@TYPE@("A",NUM)) Q:'+NUM  S ^TMP($J,"TEXT",CNT)=$G(^TMP($J,"TEXT",CNT))_$S($L($G(^TMP($J,"TEXT",CNT))):",",1:"") D  ;41 added call for data in structure below
"RTN","GMRAUTL2",127,0)
 ...I TYPE="GMRAI" D ZERO^PSN50P41(NUM,,$$DT^XLFDT,"GMRAINFO") ;41 ingredient call
"RTN","GMRAUTL2",128,0)
 ...I TYPE="GMRAC" D C^PSN50P65(NUM,,"GMRAINFO") ;41 drug class call
"RTN","GMRAUTL2",129,0)
 ...S ^TMP($J,"TEXT",CNT)=^TMP($J,"TEXT",CNT)_$G(^TMP($J,"GMRAINFO",NUM,.01)) ;41 add data
"RTN","GMRAUTL2",130,0)
 ..S CNT=CNT+1,^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",131,0)
 S ^TMP($J,"TEXT",CNT)="As a result of the update the following patients have drug-allergy",CNT=CNT+1
"RTN","GMRAUTL2",132,0)
 S ^TMP($J,"TEXT",CNT)="interactions that need to be reviewed to ensure the patient's safety.",CNT=CNT+1
"RTN","GMRAUTL2",133,0)
 S SUB=0 F  S SUB=$O(^TMP($J,"ERR",SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",134,0)
 .S ^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",135,0)
 .S ^TMP($J,"TEXT",CNT)=$$GET1^DIQ(2,SUB_",",.01),CNT=CNT+1
"RTN","GMRAUTL2",136,0)
 .S ERR=0 F  S ERR=$O(^TMP($J,"ERR",SUB,ERR)) Q:'+ERR  S ^TMP($J,"TEXT",CNT)="   "_^TMP($J,"ERR",SUB,ERR),CNT=CNT+1
"RTN","GMRAUTL2",137,0)
 S XMTEXT="^TMP($J,""TEXT"",",XMSUB="Potential order checks from allergy update"
"RTN","GMRAUTL2",138,0)
 D ^XMD
"RTN","GMRAUTL2",139,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAUTL2",140,0)
 Q
"RTN","GMRAUTL2",141,0)
 ;
"RTN","GMRAUTL2",142,0)
TOP10 ;Check top 10 reactions after push of file 120.83
"RTN","GMRAUTL2",143,0)
 N SUB,REAC,REACNO,ARRAY,SUBNM,REACNM,GMRATXT,XMSUB,XMTEXT,XMDUZ,XMY,DIFROM,CNT
"RTN","GMRAUTL2",144,0)
 I '$L($T(SCREEN^XTID)) Q  ;No screening code so quit
"RTN","GMRAUTL2",145,0)
 S SUB=0 F  S SUB=$O(^GMRD(120.84,SUB)) Q:'+SUB  I $D(^GMRD(120.84,SUB,1)) D
"RTN","GMRAUTL2",146,0)
 .S REAC=0 F  S REAC=$O(^GMRD(120.84,SUB,1,REAC)) Q:'+REAC  D
"RTN","GMRAUTL2",147,0)
 ..S REACNO=$P(^GMRD(120.84,SUB,1,REAC,0),U) Q:'+REACNO
"RTN","GMRAUTL2",148,0)
 ..I $$SCREEN^XTID(120.83,.01,REACNO_",") D
"RTN","GMRAUTL2",149,0)
 ...S SUBNM=$P(^GMRD(120.84,SUB,0),U),REACNM=$P(^GMRD(120.83,REACNO,0),U)
"RTN","GMRAUTL2",150,0)
 ...S ARRAY(SUBNM,REACNM)=""
"RTN","GMRAUTL2",151,0)
 I $D(ARRAY) D
"RTN","GMRAUTL2",152,0)
 .S XMDUZ="Data Standardization update of file 120.83",XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAUTL2",153,0)
 .S GMRATXT(1)="The signs/symptoms file has been automatically updated.  You're receiving"
"RTN","GMRAUTL2",154,0)
 .S GMRATXT(2)="this message because one or more signs/symptoms was inactivated during this"
"RTN","GMRAUTL2",155,0)
 .S GMRATXT(3)="update and the term(s) appear in your top ten list and must be replaced."
"RTN","GMRAUTL2",156,0)
 .S GMRATXT(4)="Below you will find the name of the site parameter and the terms that are now"
"RTN","GMRAUTL2",157,0)
 .S GMRATXT(5)="inactive for that entry.  Use the Enter/Edit Site Parameters [GMRA SITE FILE]"
"RTN","GMRAUTL2",158,0)
 .S GMRATXT(6)="option to find and replace these terms."
"RTN","GMRAUTL2",159,0)
 .S GMRATXT(7)=""
"RTN","GMRAUTL2",160,0)
 .S CNT=7
"RTN","GMRAUTL2",161,0)
 .S SUB="" F  S SUB=$O(ARRAY(SUB)) Q:SUB=""  S CNT=CNT+1,GMRATXT(CNT)="Site parameter: "_SUB D  S CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAUTL2",162,0)
 ..S REAC="" F  S REAC=$O(ARRAY(SUB,REAC)) Q:REAC=""  S CNT=CNT+1,GMRATXT(CNT)="Term: "_REAC
"RTN","GMRAUTL2",163,0)
 .S XMTEXT="GMRATXT(",XMSUB="Signs/symptoms require updating"
"RTN","GMRAUTL2",164,0)
 .D ^XMD
"RTN","GMRAUTL2",165,0)
 Q
"RTN","GMRAUTL2",166,0)
 ;
"RTN","GMRAUTL2",167,0)
QREACT ;Queue name update, called from "AC" xref in file 120.82.  Entire section added in patch 23
"RTN","GMRAUTL2",168,0)
 N OTERM,NTERM,ZTRTN,ZTDTH,ZTIO,ZTDESC
"RTN","GMRAUTL2",169,0)
 Q:X1(1)=""!(X2(1)="")  ;Entry is new or has been deleted, no updating required
"RTN","GMRAUTL2",170,0)
 Q:X1(1)=X2(1)  ;Entry has been updated to same value, no updating required
"RTN","GMRAUTL2",171,0)
 S OTERM=X1(1),NTERM=X2(1)
"RTN","GMRAUTL2",172,0)
 S ZTRTN="REACT^GMRAUTL2",ZTIO="GMRA UPDATE RESOURCE",ZTDTH=$H,ZTDESC="UPDATE REACTANT FIELD IN 120.8",ZTSAVE("*")="" D ^%ZTLOAD
"RTN","GMRAUTL2",173,0)
 Q
"RTN","GMRAUTL2",174,0)
 ;
"RTN","GMRAUTL2",175,0)
REACT ;Update REACTANT field with name from 120.82.  Section added with patch 23
"RTN","GMRAUTL2",176,0)
 N IEN,FDA,EM,DFN
"RTN","GMRAUTL2",177,0)
 S IEN=0 F  S IEN=$O(^GMR(120.8,"C",OTERM,IEN)) Q:'+IEN  D
"RTN","GMRAUTL2",178,0)
 .S DFN=$P(^GMR(120.8,IEN,0),U)
"RTN","GMRAUTL2",179,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",180,0)
 .Q:+$G(^GMR(120.8,IEN,"ER"))  ;Don't update if entered in error
"RTN","GMRAUTL2",181,0)
 .L +^GMR(120.8,IEN):20 I '$T Q
"RTN","GMRAUTL2",182,0)
 .S FDA(120.8,IEN_",",.02)=NTERM
"RTN","GMRAUTL2",183,0)
 .D FILE^DIE("","FDA","EM")
"RTN","GMRAUTL2",184,0)
 .L -^GMR(120.8,IEN)
"RTN","GMRAUTL2",185,0)
 Q
"RTN","GMRAUTL2",186,0)
 ;
"RTN","GMRAUTL2",187,0)
QTYPE ;Queue allergy type updates, section added in 36
"RTN","GMRAUTL2",188,0)
 N ENTRY,ZTRTN,ZTIO,ZTDTH,ZTDESC,ZTSAVE
"RTN","GMRAUTL2",189,0)
 S ENTRY=DA_";GMRD(120.82,"_"^"_$P(^GMRD(120.82,DA,0),"^")
"RTN","GMRAUTL2",190,0)
 Q:X1(1)=""!(X2(1)="")
"RTN","GMRAUTL2",191,0)
 Q:X1(1)=X2(1)
"RTN","GMRAUTL2",192,0)
 S ZTRTN="TYPE^GMRAUTL2",ZTIO="",ZTDTH=$H,ZTDESC="Allergy type updates",ZTSAVE("*")="" D ^%ZTLOAD
"RTN","GMRAUTL2",193,0)
 Q
"RTN","GMRAUTL2",194,0)
 ;
"RTN","GMRAUTL2",195,0)
TYPE ;Find related entries in 120.8 and update, section added in 36
"RTN","GMRAUTL2",196,0)
 N ALLERGY,POINTER,DFN,SUB,DR,DIE,DA
"RTN","GMRAUTL2",197,0)
 S ALLERGY=$P(ENTRY,"^",2) Q:ALLERGY=""
"RTN","GMRAUTL2",198,0)
 S POINTER=$P(ENTRY,"^") Q:POINTER=""
"RTN","GMRAUTL2",199,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,"C",ALLERGY,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",200,0)
 .Q:$P(^GMR(120.8,SUB,0),"^",3)'=POINTER  ;Same text name but not the same entry
"RTN","GMRAUTL2",201,0)
 .S DFN=$P(^GMR(120.8,SUB,0),U)
"RTN","GMRAUTL2",202,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",203,0)
 .Q:$G(^GMR(120.8,SUB,"ER"))>0  ;Entered in error
"RTN","GMRAUTL2",204,0)
 .S DR="3.1///"_X2(1),DIE=120.8,DA=SUB D ^DIE ;Update allergy type
"RTN","GMRAUTL2",205,0)
 Q
"VER")
8.0^22.0
**INSTALL NAME**
OR*3.0*311
"BLD",8460,0)
OR*3.0*311^ORDER ENTRY/RESULTS REPORTING^0^3130703^y
"BLD",8460,1,0)
^^3^3^3121130^
"BLD",8460,1,1,0)
CONTAINS FOLLOW-UP FIXES FOR ORDER ENTRY/RESULTS REPORTING SOFTWARE 
"BLD",8460,1,2,0)
VERSION 3.0 PATCH 345 (OR*3*345). REFER TO THE PATCH DESCRIPTION FOR 
"BLD",8460,1,3,0)
INSTALLATION INSTRUCTIONS AND COMPONENT INFORMATION.
"BLD",8460,4,0)
^9.64PA^^
"BLD",8460,6)
8^
"BLD",8460,6.3)
30
"BLD",8460,"INID")
^y
"BLD",8460,"INIT")
POST^ORY311
"BLD",8460,"KRN",0)
^9.67PA^779.2^20
"BLD",8460,"KRN",.4,0)
.4
"BLD",8460,"KRN",.401,0)
.401
"BLD",8460,"KRN",.402,0)
.402
"BLD",8460,"KRN",.403,0)
.403
"BLD",8460,"KRN",.5,0)
.5
"BLD",8460,"KRN",.84,0)
.84
"BLD",8460,"KRN",3.6,0)
3.6
"BLD",8460,"KRN",3.8,0)
3.8
"BLD",8460,"KRN",9.2,0)
9.2
"BLD",8460,"KRN",9.8,0)
9.8
"BLD",8460,"KRN",9.8,"NM",0)
^9.68A^13^10
"BLD",8460,"KRN",9.8,"NM",1,0)
ORCDPS1^^0^B80784611
"BLD",8460,"KRN",9.8,"NM",2,0)
ORCDPS2^^0^B67607141
"BLD",8460,"KRN",9.8,"NM",6,0)
ORCHECK^^0^B120029142
"BLD",8460,"KRN",9.8,"NM",7,0)
ORDSGCHK^^0^B109034124
"BLD",8460,"KRN",9.8,"NM",8,0)
ORKPS1^^0^B80576469
"BLD",8460,"KRN",9.8,"NM",9,0)
ORWDXC^^0^B67359281
"BLD",8460,"KRN",9.8,"NM",10,0)
ORWDXR01^^0^B28161629
"BLD",8460,"KRN",9.8,"NM",11,0)
ORWPT^^0^B64148022
"BLD",8460,"KRN",9.8,"NM",12,0)
ORCMED^^0^B75152203
"BLD",8460,"KRN",9.8,"NM",13,0)
ORY311^^0^B4599008
"BLD",8460,"KRN",9.8,"NM","B","ORCDPS1",1)

"BLD",8460,"KRN",9.8,"NM","B","ORCDPS2",2)

"BLD",8460,"KRN",9.8,"NM","B","ORCHECK",6)

"BLD",8460,"KRN",9.8,"NM","B","ORCMED",12)

"BLD",8460,"KRN",9.8,"NM","B","ORDSGCHK",7)

"BLD",8460,"KRN",9.8,"NM","B","ORKPS1",8)

"BLD",8460,"KRN",9.8,"NM","B","ORWDXC",9)

"BLD",8460,"KRN",9.8,"NM","B","ORWDXR01",10)

"BLD",8460,"KRN",9.8,"NM","B","ORWPT",11)

"BLD",8460,"KRN",9.8,"NM","B","ORY311",13)

"BLD",8460,"KRN",19,0)
19
"BLD",8460,"KRN",19.1,0)
19.1
"BLD",8460,"KRN",101,0)
101
"BLD",8460,"KRN",409.61,0)
409.61
"BLD",8460,"KRN",771,0)
771
"BLD",8460,"KRN",779.2,0)
779.2
"BLD",8460,"KRN",870,0)
870
"BLD",8460,"KRN",8989.51,0)
8989.51
"BLD",8460,"KRN",8989.52,0)
8989.52
"BLD",8460,"KRN",8994,0)
8994
"BLD",8460,"KRN","B",.4,.4)

"BLD",8460,"KRN","B",.401,.401)

"BLD",8460,"KRN","B",.402,.402)

"BLD",8460,"KRN","B",.403,.403)

"BLD",8460,"KRN","B",.5,.5)

"BLD",8460,"KRN","B",.84,.84)

"BLD",8460,"KRN","B",3.6,3.6)

"BLD",8460,"KRN","B",3.8,3.8)

"BLD",8460,"KRN","B",9.2,9.2)

"BLD",8460,"KRN","B",9.8,9.8)

"BLD",8460,"KRN","B",19,19)

"BLD",8460,"KRN","B",19.1,19.1)

"BLD",8460,"KRN","B",101,101)

"BLD",8460,"KRN","B",409.61,409.61)

"BLD",8460,"KRN","B",771,771)

"BLD",8460,"KRN","B",779.2,779.2)

"BLD",8460,"KRN","B",870,870)

"BLD",8460,"KRN","B",8989.51,8989.51)

"BLD",8460,"KRN","B",8989.52,8989.52)

"BLD",8460,"KRN","B",8994,8994)

"BLD",8460,"QDEF")
^^^^^^^^^^
"BLD",8460,"QUES",0)
^9.62^^
"BLD",8460,"REQB",0)
^9.611^3^3
"BLD",8460,"REQB",1,0)
OR*3.0*337^2
"BLD",8460,"REQB",2,0)
OR*3.0*345^2
"BLD",8460,"REQB",3,0)
OR*3.0*371^2
"BLD",8460,"REQB","B","OR*3.0*337",1)

"BLD",8460,"REQB","B","OR*3.0*345",2)

"BLD",8460,"REQB","B","OR*3.0*371",3)

"INIT")
POST^ORY311
"MBREQ")
1
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
311^3130703^11859
"PKG",170,22,1,"PAH",1,1,0)
^^3^3^3130703
"PKG",170,22,1,"PAH",1,1,1,0)
CONTAINS FOLLOW-UP FIXES FOR ORDER ENTRY/RESULTS REPORTING SOFTWARE 
"PKG",170,22,1,"PAH",1,1,2,0)
VERSION 3.0 PATCH 345 (OR*3*345). REFER TO THE PATCH DESCRIPTION FOR 
"PKG",170,22,1,"PAH",1,1,3,0)
INSTALLATION INSTRUCTIONS AND COMPONENT INFORMATION.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","ORCDPS1")
0^1^B80784611
"RTN","ORCDPS1",1,0)
ORCDPS1 ;SLC/MKB-Pharmacy dialog utilities ; 11/30/2012  10:11
"RTN","ORCDPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**94,117,141,149,195,215,243,280,337,311**;Dec 17, 1997;Build 30
"RTN","ORCDPS1",3,0)
 ;
"RTN","ORCDPS1",4,0)
 ; DBIA 2418   START^PSSJORDF   ^TMP("PSJMR",$J)
"RTN","ORCDPS1",5,0)
 ; DBIA 3166   EN^PSSDIN        ^TMP("PSSDIN",$J)
"RTN","ORCDPS1",6,0)
 ; 
"RTN","ORCDPS1",7,0)
EN(TYPE) ; -- entry action for Meds dialogs
"RTN","ORCDPS1",8,0)
 S ORINPT=$$INPT^ORCD,ORCAT=$G(TYPE)
"RTN","ORCDPS1",9,0)
 I 'ORINPT,ORCAT="I" D IMOLOC^ORIMO(.ORINPT,+ORL,+ORVP) S:ORINPT<0 ORINPT=0 ;allow inpt meds at this location?
"RTN","ORCDPS1",10,0)
 I ORCAT="" D
"RTN","ORCDPS1",11,0)
 . I $G(ORENEW)!$G(OREWRITE)!$D(OREDIT),$L($P($G(OR0),U,12)) S ORCAT=$P(OR0,U,12) Q  ;use value from order, via ORCACT4
"RTN","ORCDPS1",12,0)
 . S ORCAT=$S(ORINPT:"I",1:"O")
"RTN","ORCDPS1",13,0)
 S ORDG=+$O(^ORD(100.98,"B",$S(ORCAT="I":"UD RX",1:"O RX"),0))
"RTN","ORCDPS1",14,0)
 K ^TMP("PSJMR",$J),^TMP("PSJNOUN",$J),^TMP("PSJSCH",$J)
"RTN","ORCDPS1",15,0)
 I $G(ORENEW)!$G(OREWRITE)!$G(OREDIT)!$G(ORXFER) D  Q:$G(ORQUIT)
"RTN","ORCDPS1",16,0)
 . I 'ORINPT,ORCAT="I" D  Q:$G(ORQUIT)
"RTN","ORCDPS1",17,0)
 .. N OI S OI=+$O(^OR(100,+$G(ORIFN),.1,"B",0)) Q:OI<1
"RTN","ORCDPS1",18,0)
 .. I '$O(^ORD(101.43,OI,9,"B","IVM RX",0)) S ORQUIT=1 W $C(7),!!,"This order may not be placed at this location!" Q
"RTN","ORCDPS1",19,0)
 . K ORDIALOG($$PTR("START DATE/TIME"),1)
"RTN","ORCDPS1",20,0)
 . K ORDIALOG($$PTR("NOW"),1) Q:ORCAT'="O"
"RTN","ORCDPS1",21,0)
 . N WP S WP=$$PTR("WORD PROCESSING 1")
"RTN","ORCDPS1",22,0)
 . I '$G(ORXFER),'$$DRAFT^ORWDX2($G(ORIFN)) K ORDIALOG(WP,1),^TMP("ORWORD",$J,WP)
"RTN","ORCDPS1",23,0)
 . I $G(OREDIT),'$O(ORDIALOG($$PTR^ORCD("OR GTX INSTRUCTIONS"),0)) K ^TMP("ORWORD",$J)
"RTN","ORCDPS1",24,0)
 I ORINPT,ORCAT="O" W $C(7),!!,"NOTE: This will create an outpatient prescription for an inpatient!",!
"RTN","ORCDPS1",25,0)
 Q
"RTN","ORCDPS1",26,0)
 ;
"RTN","ORCDPS1",27,0)
EN1 ; -- setup Meds dialog for quick order editor using ORDG
"RTN","ORCDPS1",28,0)
 N DG S DG=$P($G(^ORD(100.98,+$G(ORDG),0)),U,3)
"RTN","ORCDPS1",29,0)
 I $P(DG," ")="O"!(DG="SPLY") S ORINPT=0,ORCAT="O"
"RTN","ORCDPS1",30,0)
 E  S ORINPT=1,ORCAT="I"
"RTN","ORCDPS1",31,0)
 K ^TMP("PSJMR",$J),^TMP("PSJNOUN",$J),^TMP("PSJSCH",$J)
"RTN","ORCDPS1",32,0)
 Q
"RTN","ORCDPS1",33,0)
 ;
"RTN","ORCDPS1",34,0)
ENOI ; -- setup OI prompt
"RTN","ORCDPS1",35,0)
 N D S D=$G(ORDIALOG(PROMPT,"D"))
"RTN","ORCDPS1",36,0)
 S:D="S.RX" ORDIALOG(PROMPT,"D")=$S(ORCAT="I":"S.UD RX",1:"S.O RX")
"RTN","ORCDPS1",37,0)
 I ORCAT="I",'ORINPT,D="S.UD RX" D  ;limit to IV meds for outpt's
"RTN","ORCDPS1",38,0)
 . S ORDIALOG(PROMPT,"D")="S.IVM RX" ;ORDG=+$O(^ORD(100.98,"B","O RX",0))
"RTN","ORCDPS1",39,0)
 . S ORDIALOG(PROMPT,"?")="Enter the IV medication you wish to order for this patient."
"RTN","ORCDPS1",40,0)
 Q
"RTN","ORCDPS1",41,0)
 ;
"RTN","ORCDPS1",42,0)
DEA ; -- ck DEA# of ordering provider if SchedII drug
"RTN","ORCDPS1",43,0)
 Q:$G(ORTYPE)="Z"  N DEAFLG,PSOI
"RTN","ORCDPS1",44,0)
 S PSOI=+$P($G(^ORD(101.43,+$G(Y),0)),U,2) Q:PSOI'>0
"RTN","ORCDPS1",45,0)
 S DEAFLG=$$OIDEA^PSSUTLA1(PSOI,ORCAT) Q:DEAFLG'>0  ;ok
"RTN","ORCDPS1",46,0)
 I $G(ORNP),'$L($P($G(^VA(200,+ORNP,"PS")),U,2)),'$L($P($G(^("PS")),U,3)) W $C(7),!,$P($G(^(0)),U)_" must have a DEA# or VA# to order this drug!" K DONE Q
"RTN","ORCDPS1",47,0)
 I DEAFLG=1 W $C(7),!,"This order will require a wet signature!"
"RTN","ORCDPS1",48,0)
 Q
"RTN","ORCDPS1",49,0)
 ;
"RTN","ORCDPS1",50,0)
CHANGED(X) ; -- Kill dependent values when prompt X changes
"RTN","ORCDPS1",51,0)
 N PROMPTS,NAME,PTR,P,I
"RTN","ORCDPS1",52,0)
 S PROMPTS=X I X="OI" D
"RTN","ORCDPS1",53,0)
 . S PROMPTS="INSTRUCTIONS^ROUTE^SCHEDULE^START DATE/TIME^DURATION^AND/THEN^DOSE^DISPENSE DRUG^SIG^PATIENT INSTRUCTIONS^DAYS SUPPLY^QUANTITY^REFILLS^SERVICE CONNECTED"
"RTN","ORCDPS1",54,0)
 . K ORDRUG,ORDOSE,OROUTE,ORSCH,ORSD,ORDSUP,ORQTY,ORQTYUNT,OREFILLS,ORCOPAY
"RTN","ORCDPS1",55,0)
 . K ^TMP("PSJINS",$J),^TMP("PSJMR",$J),^TMP("PSJNOUN",$J),^TMP("PSJSCH",$J)
"RTN","ORCDPS1",56,0)
 I X="DS" S PROMPTS="QUANTITY^REFILLS" K OREFILLS
"RTN","ORCDPS1",57,0)
 F P=1:1:$L(PROMPTS,U) S NAME=$P(PROMPTS,U,P) D
"RTN","ORCDPS1",58,0)
 . S PTR=$$PTR(NAME) Q:'PTR
"RTN","ORCDPS1",59,0)
 . S I=0 F  S I=$O(ORDIALOG(PTR,I)) Q:I'>0  K ORDIALOG(PTR,I)
"RTN","ORCDPS1",60,0)
 . K ORDIALOG(PTR,"LIST"),^TMP("ORWORD",$J,PTR)
"RTN","ORCDPS1",61,0)
 Q
"RTN","ORCDPS1",62,0)
 ;
"RTN","ORCDPS1",63,0)
ORDITM(OI) ; -- Check OI, get dependent info
"RTN","ORCDPS1",64,0)
 Q:OI'>0  ;quit - no value
"RTN","ORCDPS1",65,0)
 N ORPS,ORPSOI S ORPS=$G(^ORD(101.43,+OI,"PS")),ORPSOI=+$P($G(^(0)),U,2)
"RTN","ORCDPS1",66,0)
 S ORIV=$S($P(ORPS,U)=2:1,1:0)
"RTN","ORCDPS1",67,0)
 I $G(ORCAT)="O",'$P(ORPS,U,2) W $C(7),!,"This drug may not be used in an outpatient order." S ORQUIT=1 D WAIT Q
"RTN","ORCDPS1",68,0)
 I $G(ORCAT)="I" D  Q:$G(ORQUIT)
"RTN","ORCDPS1",69,0)
 . I $G(ORINPT),'$P(ORPS,U) W $C(7),!,"This drug may not be used in an inpatient order." S ORQUIT=1 D WAIT Q
"RTN","ORCDPS1",70,0)
 . I '$G(ORINPT),'ORIV W $C(7),!,"This drug may not be ordered for an outpatient." S ORQUIT=1 D WAIT Q
"RTN","ORCDPS1",71,0)
 I $G(ORTYPE)="Q" D  I $G(ORQUIT) D WAIT Q
"RTN","ORCDPS1",72,0)
 . N DEAFLG S DEAFLG=$$OIDEA^PSSUTLA1(ORPSOI,ORCAT) Q:DEAFLG'>0  ;ok
"RTN","ORCDPS1",73,0)
 . I $G(ORNP),'$L($P($G(^VA(200,+ORNP,"PS")),U,2)),'$L($P($G(^("PS")),U,3)) W $C(7),!,$P($G(^(0)),U)_" must have a DEA# or VA# to order this drug!" S ORQUIT=1 Q
"RTN","ORCDPS1",74,0)
 . I DEAFLG=1 W $C(7),!,"This order will require a wet signature!"
"RTN","ORCDPS1",75,0)
OI1 ; -ck NF status
"RTN","ORCDPS1",76,0)
 I $P(ORPS,U,6),'$G(ORENEW) D  ;alternative
"RTN","ORCDPS1",77,0)
 . W !!,"*** This medication is not in the formulary! ***"
"RTN","ORCDPS1",78,0)
 . N PSX,CNT,ORX,DIR,X,Y,DTOUT,DUOUT
"RTN","ORCDPS1",79,0)
 . D EN1^PSSUTIL1(.ORPSOI,ORCAT) I '$O(ORPSOI(0)) D  Q
"RTN","ORCDPS1",80,0)
 .. W !,"    There are no formulary alternatives entered for this item."
"RTN","ORCDPS1",81,0)
 .. W !,"    Please consult with your pharmacy before ordering it."
"RTN","ORCDPS1",82,0)
 . S PSX=0,CNT=0 F  S PSX=$O(ORPSOI(PSX)) Q:PSX'>0  D
"RTN","ORCDPS1",83,0)
 .. S ORX=+$O(^ORD(101.43,"ID",PSX_";99PSP",0)) Q:ORX'>0
"RTN","ORCDPS1",84,0)
 .. S CNT=CNT+1,ORPSOI("OI",CNT)=ORX_U_PSX
"RTN","ORCDPS1",85,0)
 .. S DIR("A",CNT)=$J(CNT,3)_" "_$P($G(^ORD(101.43,ORX,0)),U)
"RTN","ORCDPS1",86,0)
 . S DIR(0)="NAO^1:"_CNT,DIR("A")="Select alternative (or <return> to continue): "
"RTN","ORCDPS1",87,0)
 . S DIR("?")="The medication selected is not in the formulary; you may select one of the above listed alternatives instead, or press <return> to continue processing this order."
"RTN","ORCDPS1",88,0)
 . Q:CNT'>0  W !,"    Formulary alternatives:" D ^DIR
"RTN","ORCDPS1",89,0)
 . I Y'>0 S:$D(DTOUT)!$D(DUOUT) ORQUIT=1 Q
"RTN","ORCDPS1",90,0)
 . D:OI'=+ORPSOI("OI",+Y) CHANGED("OI") ;reset parameters if different
"RTN","ORCDPS1",91,0)
 . S OI=+ORPSOI("OI",+Y),ORDIALOG(PROMPT,INST)=OI,OROI=OI
"RTN","ORCDPS1",92,0)
 . S ORPSOI=+$P(ORPSOI("OI",+Y),U,2)
"RTN","ORCDPS1",93,0)
OI2 ; -get routes, doses [also called from NF^ORCDPS]
"RTN","ORCDPS1",94,0)
 D:'$D(^TMP("PSJMR",$J)) START^PSSJORDF(ORPSOI,$G(ORCAT))  ;DBIA 2418
"RTN","ORCDPS1",95,0)
 I '$D(ORDOSE) D
"RTN","ORCDPS1",96,0)
 . D DOSE^PSSORUTL(.ORDOSE,ORPSOI,$S($G(ORCAT)="I":"U",1:"O"),+ORVP)
"RTN","ORCDPS1",97,0)
 . K:$G(ORDOSE(1))=-1 ORDOSE Q:'$D(ORDOSE)
"RTN","ORCDPS1",98,0)
 . S ORDOSE("LOCAL")=0
"RTN","ORCDPS1",99,0)
 . N DOSAGE
"RTN","ORCDPS1",100,0)
 . S DOSAGE=0 F  S DOSAGE=$O(ORDOSE(DOSAGE)) Q:+$G(DOSAGE)=0  D
"RTN","ORCDPS1",101,0)
 . . S:+$P(ORDOSE(DOSAGE),U,1)=0 ORDOSE("LOCAL")=1
"RTN","ORCDPS1",102,0)
 Q
"RTN","ORCDPS1",103,0)
 ;
"RTN","ORCDPS1",104,0)
NFI(OI) ; -- Show NFI restrictions, if exist
"RTN","ORCDPS1",105,0)
 N PSOI,I,J,LCNT,MAX,X,STOP
"RTN","ORCDPS1",106,0)
 S PSOI=+$P($G(^ORD(101.43,+$G(OI),0)),U,2)
"RTN","ORCDPS1",107,0)
 D EN^PSSDIN(PSOI,"") Q:'$D(^TMP("PSSDIN",$J,"OI",PSOI))  ;DBIA 3166
"RTN","ORCDPS1",108,0)
 S I=0,LCNT=0,MAX=$S($G(IOBM)&$G(IOTM):IOBM-IOTM+1,1:24) W !
"RTN","ORCDPS1",109,0)
 F  S I=$O(^TMP("PSSDIN",$J,"OI",PSOI,I)) Q:I'>0  D
"RTN","ORCDPS1",110,0)
 . S J=0 F  S J=$O(^TMP("PSSDIN",$J,"OI",PSOI,I,J)) Q:J'>0  S X=$G(^(J)) D  Q:$G(STOP)
"RTN","ORCDPS1",111,0)
 .. S LCNT=LCNT+1 I LCNT'<MAX S:'$$CONT STOP=1 Q:$G(STOP)  S LCNT=1
"RTN","ORCDPS1",112,0)
 .. W !,X
"RTN","ORCDPS1",113,0)
 W ! K ^TMP("PSSDIN",$J,"OI",PSOI)
"RTN","ORCDPS1",114,0)
 Q
"RTN","ORCDPS1",115,0)
 ;
"RTN","ORCDPS1",116,0)
CONT() ; -- Cont or stop?
"RTN","ORCDPS1",117,0)
 N X,Y,DIR,DUOUT,DTOUT,DIRUT,DIROUT S DIR(0)="EA"
"RTN","ORCDPS1",118,0)
 S DIR("A")="Press <return> to continue or ^ to stop ..."
"RTN","ORCDPS1",119,0)
 D ^DIR S:$D(DUOUT)!$D(DTOUT) Y=""
"RTN","ORCDPS1",120,0)
 Q +Y
"RTN","ORCDPS1",121,0)
 ;
"RTN","ORCDPS1",122,0)
WAIT ; -- Wait for user
"RTN","ORCDPS1",123,0)
 N X W !,"Press <return> to continue ..." R X:DTIME
"RTN","ORCDPS1",124,0)
 Q
"RTN","ORCDPS1",125,0)
 ;
"RTN","ORCDPS1",126,0)
ROUTES ; -- Get med routes
"RTN","ORCDPS1",127,0)
 Q:$G(ORDIALOG(PROMPT,"LIST"))  N I,X,CNT S (I,CNT)=0
"RTN","ORCDPS1",128,0)
 F  S I=$O(^TMP("PSJMR",$J,I)) Q:I'>0  S X=^(I),CNT=CNT+1,ORDIALOG(PROMPT,"LIST",CNT)=$P(X,U,3)_U_$P(X,U,1,2),ORDIALOG(PROMPT,"LIST","B",$P(X,U))=$P(X,U,3)
"RTN","ORCDPS1",129,0)
 S:$G(CNT) ORDIALOG(PROMPT,"LIST")=CNT
"RTN","ORCDPS1",130,0)
 S:$G(ORTYPE)'="Z" REQD=$S(ORCAT="I":1,$P($G(^ORD(101.43,+$G(OROI),"PS")),U,5):0,1:1)
"RTN","ORCDPS1",131,0)
 Q
"RTN","ORCDPS1",132,0)
 ;
"RTN","ORCDPS1",133,0)
DEFRTE ; -- Get default route
"RTN","ORCDPS1",134,0)
 N INST1 S INST1=$O(ORDIALOG(PROMPT,0)) S:INST1'>0 INST1=INST
"RTN","ORCDPS1",135,0)
 I INST1=INST S Y=+$P($G(^TMP("PSJMR",$J,1)),U,3) K:Y'>0 Y Q
"RTN","ORCDPS1",136,0)
 S Y=+$G(ORDIALOG(PROMPT,INST1)) K:Y'>0 Y S:$G(Y) EDITONLY=1
"RTN","ORCDPS1",137,0)
 Q
"RTN","ORCDPS1",138,0)
 ;
"RTN","ORCDPS1",139,0)
CKSCH ; -- validate schedule [Called from P-S Action]
"RTN","ORCDPS1",140,0)
 N ORX S ORX=ORDIALOG(PROMPT,ORI) Q:ORX=$G(ORESET)  K ORSD
"RTN","ORCDPS1",141,0)
 D EN^PSSGS0(.ORX,$G(ORCAT))
"RTN","ORCDPS1",142,0)
 I $D(ORX) S ORDIALOG(PROMPT,ORI)=ORX D CHANGED("QUANTITY") Q  ;ok
"RTN","ORCDPS1",143,0)
 W $C(7),!,"Enter a standard schedule for administering this medication"
"RTN","ORCDPS1",144,0)
 K DONE I $G(ORCAT)="I" W ".",! Q
"RTN","ORCDPS1",145,0)
 W " or one of your own,",!,"up to 20 characters.",!
"RTN","ORCDPS1",146,0)
 Q
"RTN","ORCDPS1",147,0)
 ;
"RTN","ORCDPS1",148,0)
DEFCONJ ; -- Set default conjuction for previous instance [P-S Action]
"RTN","ORCDPS1",149,0)
 N LAST,DUR,CONJ
"RTN","ORCDPS1",150,0)
 S LAST=$O(ORDIALOG(PROMPT,ORI),-1) Q:LAST'>0  ;first instance
"RTN","ORCDPS1",151,0)
 S CONJ=$$PTR("AND/THEN") Q:$L($G(ORDIALOG(CONJ,LAST)))
"RTN","ORCDPS1",152,0)
 S DUR=$G(ORDIALOG($$PTR("DURATION"),LAST))
"RTN","ORCDPS1",153,0)
 S ORDIALOG(CONJ,LAST)=$S(+DUR'>0:"A",1:"T")
"RTN","ORCDPS1",154,0)
 Q
"RTN","ORCDPS1",155,0)
 ;
"RTN","ORCDPS1",156,0)
ENCONJ ; -- Get allowable values, if req'd for INST
"RTN","ORCDPS1",157,0)
 N P S P=$$PTR("INSTRUCTIONS")
"RTN","ORCDPS1",158,0)
 S REQD=$S($O(ORDIALOG(P,INST)):1,1:0)
"RTN","ORCDPS1",159,0)
 S ORDIALOG(PROMPT,"A")="And/then"_$S(ORCAT="O":"/except: ",1:": ")
"RTN","ORCDPS1",160,0)
 S $P(ORDIALOG(PROMPT,0),U,2)="A:AND;T:THEN;"_$S(ORCAT="O":"X:EXCEPT;",1:"")
"RTN","ORCDPS1",161,0)
 Q
"RTN","ORCDPS1",162,0)
 ;
"RTN","ORCDPS1",163,0)
INPCONJ ;
"RTN","ORCDPS1",164,0)
 N LETTER,DUR
"RTN","ORCDPS1",165,0)
 I $G(X)="" Q
"RTN","ORCDPS1",166,0)
 S LETTER=$$UP^XLFSTR($E(X,1))
"RTN","ORCDPS1",167,0)
 I LETTER'="T" Q
"RTN","ORCDPS1",168,0)
 S DUR=$$PTR("DURATION") I '$L($G(ORDIALOG(DUR,INST))) D
"RTN","ORCDPS1",169,0)
 .W !,"A duration is required when using a 'Then' conjunction."
"RTN","ORCDPS1",170,0)
 .K X
"RTN","ORCDPS1",171,0)
 Q
"RTN","ORCDPS1",172,0)
 ;
"RTN","ORCDPS1",173,0)
DSUP ; -- Get max/default days supply
"RTN","ORCDPS1",174,0)
 N ORX,Y
"RTN","ORCDPS1",175,0)
 S ORX("PATIENT")=+$G(ORVP),ORX("DRUG")=+$G(ORDRUG)
"RTN","ORCDPS1",176,0)
 D DSUP^PSOSIGDS(.ORX) S Y=+$G(ORX("DAYS SUPPLY")) S:Y'>0 Y=90
"RTN","ORCDPS1",177,0)
 ;S $P(ORDIALOG(PROMPT,0),U,2)="1:"_Y ;max allowed
"RTN","ORCDPS1",178,0)
 I '$G(ORDIALOG(PROMPT,1)),$G(ORTYPE)'="Z" S ORDIALOG(PROMPT,1)=Y
"RTN","ORCDPS1",179,0)
 Q
"RTN","ORCDPS1",180,0)
 ;
"RTN","ORCDPS1",181,0)
QTY() ; -- Return default quantity [Expects ORDSUP]
"RTN","ORCDPS1",182,0)
 N INSTR,DOSE,DUR,SCH,I,ORX,X,Y
"RTN","ORCDPS1",183,0)
 S Y="" I $G(ORDSUP)'>0!'$G(ORDRUG) G QTYQ ;need days supply, disp drug
"RTN","ORCDPS1",184,0)
 S INSTR=$$PTR("INSTRUCTIONS")
"RTN","ORCDPS1",185,0)
 S DOSE=$$PTR("DOSE"),CONJ=$$PTR("AND/THEN")
"RTN","ORCDPS1",186,0)
 S DUR=$$PTR("DURATION"),SCH=$$PTR("SCHEDULE")
"RTN","ORCDPS1",187,0)
 S I=0 F  S I=$O(ORDIALOG(INSTR,I)) Q:I'>0  D  Q:'$D(ORX)
"RTN","ORCDPS1",188,0)
 . S X=$P($G(ORDIALOG(DOSE,I)),"&",3) I X'>0 K ORX Q
"RTN","ORCDPS1",189,0)
 . S ORX("DOSE ORDERED",I)=X,ORX("SCHEDULE",I)=$G(ORDIALOG(SCH,I))
"RTN","ORCDPS1",190,0)
 . S X=$G(ORDIALOG(DUR,I)),ORX("DURATION",I)=$$HL7DUR^ORMBLDPS
"RTN","ORCDPS1",191,0)
 . S ORX("CONJUNCTION",I)=$G(ORDIALOG(CONJ,I))
"RTN","ORCDPS1",192,0)
 G:'$D(ORX) QTYQ ;no doses
"RTN","ORCDPS1",193,0)
 S ORX("PATIENT")=+$G(ORVP),ORX("DRUG")=+$G(ORDRUG)
"RTN","ORCDPS1",194,0)
 S ORX("DAYS SUPPLY")=+$G(ORDSUP)
"RTN","ORCDPS1",195,0)
 D QTYX^PSOSIG(.ORX) S Y=$G(ORX("QTY"))
"RTN","ORCDPS1",196,0)
QTYQ Q Y
"RTN","ORCDPS1",197,0)
 ;
"RTN","ORCDPS1",198,0)
MAXREFS ; -- Get max refills allowed [Entry Action]
"RTN","ORCDPS1",199,0)
 Q:$G(ORCAT)'="O"  N ORX,X
"RTN","ORCDPS1",200,0)
 S ORX("ITEM")=+$P($G(^ORD(101.43,+$G(OROI),0)),U,2)
"RTN","ORCDPS1",201,0)
 S ORX("DRUG")=+$G(ORDRUG),ORX("PATIENT")=+$G(ORVP)
"RTN","ORCDPS1",202,0)
 I $G(OREVENT),$$TYPE^OREVNTX(OREVENT)="D" S ORX("DISCHARGE")=1
"RTN","ORCDPS1",203,0)
 S ORX("DAYS SUPPLY")=$G(ORDSUP) D MAX^PSOSIGDS(.ORX)
"RTN","ORCDPS1",204,0)
 S OREFILLS=$G(ORX("MAX")),X=$G(ORDIALOG(PROMPT,INST))
"RTN","ORCDPS1",205,0)
 I OREFILLS'>0 S ORDIALOG(PROMPT,INST)=0 W !,"No refills allowed." Q
"RTN","ORCDPS1",206,0)
 S $P(ORDIALOG(PROMPT,0),U,2)="0:"_OREFILLS
"RTN","ORCDPS1",207,0)
 S ORDIALOG(PROMPT,"A")="Refills (0-"_OREFILLS_"): "
"RTN","ORCDPS1",208,0)
 I X,X>OREFILLS S ORDIALOG(PROMPT,INST)=OREFILLS
"RTN","ORCDPS1",209,0)
 Q
"RTN","ORCDPS1",210,0)
 ;
"RTN","ORCDPS1",211,0)
ASKSC() ; -- Return 1 or 0, if SC prompt should be asked
"RTN","ORCDPS1",212,0)
 I $$SC^PSOCP(+ORVP,+$G(ORDRUG)) Q 0
"RTN","ORCDPS1",213,0)
 ;I $$RXST^IBARXEU(+ORVP)>0 Q 0 ;exempt from copay
"RTN","ORCDPS1",214,0)
 Q 1
"RTN","ORCDPS1",215,0)
 ;
"RTN","ORCDPS1",216,0)
PTR(X) ; -- Return ptr to prompt OR GTX X
"RTN","ORCDPS1",217,0)
 Q +$O(^ORD(101.41,"AB","OR GTX "_X,0))
"RTN","ORCDPS1",218,0)
 ;
"RTN","ORCDPS1",219,0)
EXIT ; -- exit action for Meds
"RTN","ORCDPS1",220,0)
 S:$G(ORXNP) ORNP=ORXNP
"RTN","ORCDPS1",221,0)
 K ORXNP,ORINPT,ORCAT,ORPKG,OROI,ORIV,ORDRUG,ORDOSE,OROUTE,ORSCH,ORSD,ORDSUP,OREFILLS,ORQTY,ORQTYUNT,ORCOPAY,PSJNOPC,ORCOMPLX
"RTN","ORCDPS1",222,0)
 K ^TMP("PSJMR",$J),^TMP("PSJNOUN",$J),^TMP("PSJSCH",$J)
"RTN","ORCDPS1",223,0)
 Q
"RTN","ORCDPS2")
0^2^B67607141
"RTN","ORCDPS2",1,0)
ORCDPS2 ;SLC/MKB-Pharmacy dialog utilities ;12/07/12  08:29
"RTN","ORCDPS2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**94,116,125,131,243,311**;Dec 17, 1997;Build 30
"RTN","ORCDPS2",3,0)
 ;
"RTN","ORCDPS2",4,0)
COMPLEX() ; -- Single or complex?
"RTN","ORCDPS2",5,0)
 N X,Y,DIR,DUOUT,DTOUT,COMPLX
"RTN","ORCDPS2",6,0)
 S COMPLX=$S($O(ORDIALOG(PROMPT,"?"),-1)>1:1,$L($G(ORDIALOG($$PTR("DURATION"),1))):1,1:0)
"RTN","ORCDPS2",7,0)
 I $G(ORTYPE)="Q",$O(ORDIALOG(PROMPT,0)),FIRST Q COMPLX
"RTN","ORCDPS2",8,0)
 I $D(ORENEW)!$D(OREWRITE)!$D(ORXFER)!COMPLX Q COMPLX
"RTN","ORCDPS2",9,0)
 I $D(OREDIT) Q:$D(ORCOMPLX)!COMPLX COMPLX G CP1 ;Q if complex or 'first, else ask
"RTN","ORCDPS2",10,0)
 I 'FIRST S Y=$S($D(ORCOMPLX):ORCOMPLX,1:COMPLX) Q Y
"RTN","ORCDPS2",11,0)
CP1 S DIR(0)="YA",DIR("A")="Complex dose? ",DIR("B")="NO"
"RTN","ORCDPS2",12,0)
 S DIR("?")="Enter YES if you wish to enter multiple sets of dosage instructions, a tapering dose, or to limit the duration of a single dose."
"RTN","ORCDPS2",13,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","ORCDPS2",14,0)
 Q Y
"RTN","ORCDPS2",15,0)
 ;
"RTN","ORCDPS2",16,0)
DOSES ; -- Available common doses
"RTN","ORCDPS2",17,0)
 ;S $P(ORDIALOG(PROMPT,0),U,2)=$S(ORCAT="I":"1:20",1:"1:80")
"RTN","ORCDPS2",18,0)
 S ORDIALOG(PROMPT,"A")="Dose"_$S(ORCAT="I"&$G(ORIV):" or Rate: ",1:": ")
"RTN","ORCDPS2",19,0)
 S $P(ORDIALOG(PROMPT,"?"),",",2)=$S($G(ORIV):" as either a dose amount or infusion rate.",1:" as a dose or amount.")
"RTN","ORCDPS2",20,0)
 I FIRST,'$O(ORDIALOG(PROMPT,0)),$G(ORXFER) D SHOWSIG^ORCMED
"RTN","ORCDPS2",21,0)
 S ORCOMPLX=$$COMPLEX,MULT=+ORCOMPLX I ORCOMPLX="^" S ORQUIT=1 Q
"RTN","ORCDPS2",22,0)
 Q:$G(ORDIALOG(PROMPT,"LIST"))  Q:'$D(ORDOSE)
"RTN","ORCDPS2",23,0)
D1 ; -- Entry from ORCMED,NF^ORCDPS to build list
"RTN","ORCDPS2",24,0)
 N I,J,X,DD,DRUG,DOSE,CONJ,CNT,UD,COST,TEXT
"RTN","ORCDPS2",25,0)
 S (I,CNT)=0,CONJ=$P($G(ORDOSE("MISC")),U,3) S:$L(CONJ) CONJ=" "_CONJ
"RTN","ORCDPS2",26,0)
 F  S I=$O(ORDOSE(I)) Q:I'>0  D
"RTN","ORCDPS2",27,0)
 . S X=ORDOSE(I),DD=+$P(X,U,6),DRUG=ORDOSE("DD",DD)
"RTN","ORCDPS2",28,0)
 . ;  =TotalDose^Units^U/D^Noun^LocalDose^DispDrugIEN^Cost
"RTN","ORCDPS2",29,0)
 . ;DD=Name^Cost^NF^DispUnit^Strength^Units^DoseForm^MaxRefills?
"RTN","ORCDPS2",30,0)
 . S DOSE=$P(X,U,5),UD=$P(X,U,3),COST=$P(X,U,7) Q:'$L(DOSE)
"RTN","ORCDPS2",31,0)
 . I '$P(X,U) S DOSE=DOSE_CONJ_" "_$S($L($P(DRUG,U,5)):$P(DRUG,U,5)_$P(DRUG,U,6),1:$P(DRUG,U))
"RTN","ORCDPS2",32,0)
 . ;I UD S COST="$"_$J(UD*$P(DRUG,U,2),1,3) ;_" per "_UD_" "_$P(X,U,4)
"RTN","ORCDPS2",33,0)
 . S TEXT=DOSE_$S($L(COST):"     $"_COST,1:"")_$S($P(DRUG,U,3):"   (non-formulary)",1:"")
"RTN","ORCDPS2",34,0)
 . S CNT=CNT+1,ORDIALOG(PROMPT,"LIST",CNT)=DOSE_U_TEXT
"RTN","ORCDPS2",35,0)
 . S ORDIALOG(PROMPT,"LIST","B",TEXT)=DOSE
"RTN","ORCDPS2",36,0)
 . S ORDIALOG(PROMPT,"LIST","D",DOSE)=DD ;default DispDrug
"RTN","ORCDPS2",37,0)
 . S ORDOSE("DD",DD,DOSE)=$P(ORDOSE(I),U,1,6)_U_$P(DRUG,U,5,6)
"RTN","ORCDPS2",38,0)
 . S J=0 F  S J=$O(ORDOSE(I,J)) Q:J'>0  D  ;xref alt forms of dose
"RTN","ORCDPS2",39,0)
 .. S DD=+$P(ORDOSE(I,J),U,6),DRUG=$G(ORDOSE("DD",DD))
"RTN","ORCDPS2",40,0)
 .. S ORDOSE("DD",DD,DOSE)=$P(ORDOSE(I,J),U,1,6)_U_$P(DRUG,U,5,6)
"RTN","ORCDPS2",41,0)
 S:CNT ORDIALOG(PROMPT,"LIST")=CNT
"RTN","ORCDPS2",42,0)
 Q
"RTN","ORCDPS2",43,0)
 ;
"RTN","ORCDPS2",44,0)
CHDOSE ; -- Kill dependent values if inst ORI of dose changes
"RTN","ORCDPS2",45,0)
 N X,PROMPTS,P,NAME,DOSE,DD S X=$G(ORDIALOG(PROMPT,ORI))
"RTN","ORCDPS2",46,0)
 ;S X=$$UP^XLFSTR(X),ORDIALOG(PROMPT,ORI)=X ;force uppercase
"RTN","ORCDPS2",47,0)
 I X,X'?1.N.E1.A.E K DONE W $C(7),!,"Enter the amount of this drug that the patient is to receive as a dose,",!,"NOT as the number of units per dose." Q
"RTN","ORCDPS2",48,0)
 I $L(X)>60,'$D(ORDIALOG(PROMPT,"LIST","B",X)) K DONE W $C(7),!,"Instructions may not be longer than 60 characters." Q
"RTN","ORCDPS2",49,0)
 I $G(ORESET)'=X D  ;kill dependent values if new/changed dose
"RTN","ORCDPS2",50,0)
 . S PROMPTS="STRENGTH^DRUG NAME^DOSE^DISPENSE DRUG^DAYS SUPPLY^QUANTITY^REFILLS"
"RTN","ORCDPS2",51,0)
 . F P=1:1:$L(PROMPTS,U) S NAME=$P(PROMPTS,U,P) K ORDIALOG($$PTR(NAME),ORI)
"RTN","ORCDPS2",52,0)
 . K ORQTY,ORQTYUNT,ORDRUG,ORDIALOG($$PTR("DISPENSE DRUG"),1)
"RTN","ORCDPS2",53,0)
 . K ^TMP("ORWORD",$J,$$PTR("SIG"))
"RTN","ORCDPS2",54,0)
 S DOSE=$$PTR("DOSE") I $L(X),'$L($G(ORDIALOG(DOSE,ORI))) D  ;set ID
"RTN","ORCDPS2",55,0)
 . S DD=+$G(ORDIALOG(PROMPT,"LIST","D",X))
"RTN","ORCDPS2",56,0)
 . S:DD ORDIALOG(DOSE,ORI)=$TR($G(ORDOSE("DD",DD,X)),"^","&")
"RTN","ORCDPS2",57,0)
 S DD=+$P($G(ORDIALOG(DOSE,ORI)),"&",6)
"RTN","ORCDPS2",58,0)
 I DD,$P($G(ORDOSE("DD",DD)),U,3) D NF^ORCDPS(DD) ;look for FormAlt
"RTN","ORCDPS2",59,0)
 I 'DD,(+$G(ORDOSE("LOCAL"))) W $C(7),!,"WARNING: Dosage check may not occur."
"RTN","ORCDPS2",60,0)
 Q
"RTN","ORCDPS2",61,0)
 ;
"RTN","ORCDPS2",62,0)
EXDOSE ; -- Exit Action
"RTN","ORCDPS2",63,0)
 Q:'$O(ORDIALOG(PROMPT,0))  N DRUG,MISC,QUIT,LAST
"RTN","ORCDPS2",64,0)
 S ORDRUG=$$DISPDRUG^ORCDPS,DRUG=$G(ORDOSE("DD",+ORDRUG))
"RTN","ORCDPS2",65,0)
 I ORDRUG D  I $G(QUIT) S ORQUIT=1 Q
"RTN","ORCDPS2",66,0)
 . ;I $P(DRUG,U,10),'$L($P($G(^VA(200,+$G(ORNP),"PS")),U,2)),'$L($P($G(^("PS")),U,3)) W $C(7),!,$P($G(^(0)),U)_" must have a DEA# or VA# to order this drug!" S QUIT=1 Q
"RTN","ORCDPS2",67,0)
 . ;I $P(DRUG,U,10)=1 W $C(7),!,"This order will require a wet signature!"
"RTN","ORCDPS2",68,0)
 . S ORDIALOG($$PTR("DISPENSE DRUG"),1)=ORDRUG
"RTN","ORCDPS2",69,0)
 . D:$G(ORCAT)="O" RESETID^ORCDPS
"RTN","ORCDPS2",70,0)
 . N STR,MED S STR=$P(DRUG,U,5)_$P(DRUG,U,6)
"RTN","ORCDPS2",71,0)
 . I STR'>0 S:'$G(ORDOSE(1)) ORDIALOG($$PTR("DRUG NAME"),1)=$P(DRUG,U) Q
"RTN","ORCDPS2",72,0)
 . S MED=$P($G(^ORD(101.43,+$G(OROI),0)),U)
"RTN","ORCDPS2",73,0)
 . I MED'[STR,ORCAT="O"!'$G(ORDOSE(1)) S ORDIALOG($$PTR("STRENGTH"),1)=STR
"RTN","ORCDPS2",74,0)
 I +ORDRUG'>0,ORCAT="O" W $C(7),!,"Cannot determine dispense drug - some defaults and order checks may not occur!"
"RTN","ORCDPS2",75,0)
EXD1 ; -- Kill dangling conjunction, [re]build Sig, get Qty info
"RTN","ORCDPS2",76,0)
 S LAST=$O(ORDIALOG(PROMPT,"?"),-1) K ORDIALOG($$PTR("AND/THEN"),LAST)
"RTN","ORCDPS2",77,0)
 D ADMIN^ORCDPS3 D:$G(ORTYPE)'="Z" SIG ;[re]build Sig/Text
"RTN","ORCDPS2",78,0)
 I ORDRUG,ORCAT="O" D  ;set Qty info
"RTN","ORCDPS2",79,0)
 . S:$L($P(DRUG,U,4)) ORQTYUNT=$P(DRUG,U,4)
"RTN","ORCDPS2",80,0)
 . S MISC=$$ENDCM^PSJORUTL(+ORDRUG),ORQTY=$P(MISC,U,4)
"RTN","ORCDPS2",81,0)
 . W:$L($P(MISC,U,2)) !!,$P(MISC,U,2),!
"RTN","ORCDPS2",82,0)
 Q
"RTN","ORCDPS2",83,0)
 ;
"RTN","ORCDPS2",84,0)
SIG ; -- Create ORDIALOG(SIG) from Instructions PROMPT,ORDOSE,ORDRUG,ORCAT
"RTN","ORCDPS2",85,0)
 ;    Return text in ^TMP("ORWORD",$J,SIG,INST)
"RTN","ORCDPS2",86,0)
 ;   [also called from PSJ^ORCSEND1 to build child orders]
"RTN","ORCDPS2",87,0)
 ;
"RTN","ORCDPS2",88,0)
 N ORT,ORSCH,ORDUR,ORID,ORDD,ORCNJ,ORMISC,ORPREP,ORX,ORI,CNT,ORSIG,ORS,DOSE
"RTN","ORCDPS2",89,0)
 S ORT=$$PTR("ROUTE"),ORSCH=$$PTR("SCHEDULE"),ORDUR=$$PTR("DURATION")
"RTN","ORCDPS2",90,0)
 S ORID=$$PTR("DOSE"),ORCNJ=$$PTR("AND/THEN"),ORS=$$PTR("SIG")
"RTN","ORCDPS2",91,0)
 S ORMISC=$G(ORDOSE("MISC")),ORPREP=$P(ORMISC,U,2)
"RTN","ORCDPS2",92,0)
 S ORX=$S(ORCAT="I":"",ORCAT="O"&(+$G(ISIMO)=1):"",$L($P(ORMISC,U)):$P(ORMISC,U)_" ",1:"") ;"TAKE "
"RTN","ORCDPS2",93,0)
 S (CNT,ORI)=0 F  S ORI=$O(ORDIALOG(PROMPT,ORI)) Q:ORI'>0  D
"RTN","ORCDPS2",94,0)
 . S DOSE=$G(ORDIALOG(PROMPT,ORI)) Q:'$L(DOSE)
"RTN","ORCDPS2",95,0)
 . S ORX=ORX_$$DOSE_$$RTE_$$SCH_$$DUR_$$CONJ
"RTN","ORCDPS2",96,0)
 . S CNT=CNT+1,ORSIG(CNT,0)=ORX,ORX=""
"RTN","ORCDPS2",97,0)
 Q:CNT'>0  S ORSIG(0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORCDPS2",98,0)
 K ^TMP("ORWORD",$J,ORS,1) M ^(1)=ORSIG S ORDIALOG(PROMPT,"FORMAT")="@"
"RTN","ORCDPS2",99,0)
 S ORDIALOG(ORS,1)=$NA(^TMP("ORWORD",$J,ORS,1))
"RTN","ORCDPS2",100,0)
 Q
"RTN","ORCDPS2",101,0)
 ;
"RTN","ORCDPS2",102,0)
PTR(X) ; -- Ptr to prompt OR GTX X
"RTN","ORCDPS2",103,0)
 Q +$O(^ORD(101.41,"AB","OR GTX "_X,0))
"RTN","ORCDPS2",104,0)
 ;
"RTN","ORCDPS2",105,0)
DOSE() ; -- Dosage
"RTN","ORCDPS2",106,0)
 N X0,Y S X0=$G(ORDIALOG(ORID,ORI)) ;ID string
"RTN","ORCDPS2",107,0)
 S Y=DOSE I ORDRUG,$L(X0) D  ;use local dose if common DispDrug
"RTN","ORCDPS2",108,0)
 . S:$L($P(X0,"&",5)) Y=$P(X0,"&",5) ;unless Outpt w/total dose
"RTN","ORCDPS2",109,0)
 . I ORCAT="O",X0 S Y=$$WORD($P(X0,"&",3))_" "_$P(X0,"&",4) ;u/d
"RTN","ORCDPS2",110,0)
 Q Y
"RTN","ORCDPS2",111,0)
 ;
"RTN","ORCDPS2",112,0)
WORD(X) ; -- Words for number X
"RTN","ORCDPS2",113,0)
 N X1,X2,Y S X1=$P(+X,"."),X2=$P(+X,".",2)
"RTN","ORCDPS2",114,0)
 S Y="" I X1 S Y=$S(X1=1:"ONE",X1=2:"TWO",X1=3:"THREE",X1=4:"FOUR",X1=5:"FIVE",X1=6:"SIX",X1=7:"SEVEN",X1=8:"EIGHT",X1=9:"NINE",X1=10:"TEN",1:X1)
"RTN","ORCDPS2",115,0)
 I X2 S Y=Y_$S($L(Y):" AND ",1:"")_$S(X2=5:"ONE-HALF",X2=33!(X2=34):"ONE-THIRD",X2=25:"ONE-FOURTH",X2=66!(X2=67):"TWO-THIRDS",X2=75:"THREE-FOURTHS",1:"."_X2)
"RTN","ORCDPS2",116,0)
 Q Y
"RTN","ORCDPS2",117,0)
 ;
"RTN","ORCDPS2",118,0)
RTE() ; -- Expansion of route
"RTN","ORCDPS2",119,0)
 N X,X0,Y S X=+$G(ORDIALOG(ORT,ORI)) Q:X'>0 ""
"RTN","ORCDPS2",120,0)
 K ^TMP($J,"ORCDPS2 RTE")
"RTN","ORCDPS2",121,0)
 D ALL^PSS51P2(+X,,,,"ORCDPS2 RTE")
"RTN","ORCDPS2",122,0)
 ;S X0=$G(^PS(51.2,+X,0)),Y=""
"RTN","ORCDPS2",123,0)
 I ORCAT="I"!(+$G(ISIMO)=1) S Y=" "_$S($L(^TMP($J,"ORCDPS2 RTE",+X,1)):^TMP($J,"ORCDPS2 RTE",+X,1),1:^TMP($J,"ORCDPS2 RTE",+X,.01))
"RTN","ORCDPS2",124,0)
 ;I ORCAT="I" S Y=" "_$S($L($P(X0,U,3)):$P(X0,U,3),1:$P(X0,U))
"RTN","ORCDPS2",125,0)
 I ORCAT="O",'+$G(ISIMO) S Y=" "_$S($L(ORPREP):ORPREP_" ",1:"")_$S($L(^TMP($J,"ORCDPS2 RTE",+X,4)):^TMP($J,"ORCDPS2 RTE",+X,4),1:^TMP($J,"ORCDPS2 RTE",+X,.01))
"RTN","ORCDPS2",126,0)
 Q Y
"RTN","ORCDPS2",127,0)
 ;
"RTN","ORCDPS2",128,0)
SCH() ; -- [outpatient] expansion of schedule
"RTN","ORCDPS2",129,0)
 N X,Y S X=$G(ORDIALOG(ORSCH,ORI))
"RTN","ORCDPS2",130,0)
 I $L(X),ORCAT="O",'+$G(ISIMO) D SCH^PSSUTIL1(.X)
"RTN","ORCDPS2",131,0)
 S Y=$S($L(X):" "_X,1:"")
"RTN","ORCDPS2",132,0)
 Q Y
"RTN","ORCDPS2",133,0)
 ;
"RTN","ORCDPS2",134,0)
DUR() ; -- Duration
"RTN","ORCDPS2",135,0)
 N X,Y S X=$G(ORDIALOG(ORDUR,ORI)),Y=""
"RTN","ORCDPS2",136,0)
 I X S Y=" FOR "_$$UP^XLFSTR(X)_$S(+X=X:" DAYS",1:"")
"RTN","ORCDPS2",137,0)
 Q Y
"RTN","ORCDPS2",138,0)
 ;
"RTN","ORCDPS2",139,0)
CONJ() ; -- Conjunction
"RTN","ORCDPS2",140,0)
 N X,Y S X=$G(ORDIALOG(ORCNJ,ORI))
"RTN","ORCDPS2",141,0)
 S:$L(X)>1 X=$E(X) S:X="E" S="X"
"RTN","ORCDPS2",142,0)
 S Y=$S(X="T":", THEN",X="X":" EXCEPT",X="A":" AND",1:"")
"RTN","ORCDPS2",143,0)
 Q Y
"RTN","ORCDPS2",144,0)
 ;
"RTN","ORCDPS2",145,0)
DOSETEXT        ; -- Reset dose text in ORDIALOG(INSTR) for backdoor orders
"RTN","ORCDPS2",146,0)
 ;    [Called from ORMPS1 - uses ORCAT,PSOI,ORVP,DRUG,INSTR,DOSE]
"RTN","ORCDPS2",147,0)
 ;
"RTN","ORCDPS2",148,0)
 N ORTYPE,ORDOSE,CONJ,ORDRUG,DRUG0,STRG,ORI,LDOSE,X,PROMPT
"RTN","ORCDPS2",149,0)
 S ORTYPE=$S($G(ORCAT)="I":"U",1:"O")
"RTN","ORCDPS2",150,0)
 D DOSE^PSSORUTL(.ORDOSE,+PSOI,ORTYPE,+ORVP)
"RTN","ORCDPS2",151,0)
 S CONJ=$P($G(ORDOSE("MISC")),U,3) S:$L(CONJ) CONJ=" "_CONJ
"RTN","ORCDPS2",152,0)
 S ORDRUG=+$G(ORDIALOG(DRUG,1)),DRUG0=$G(ORDOSE("DD",ORDRUG))
"RTN","ORCDPS2",153,0)
 S STRG=$P(DRUG0,U,5)_$P(DRUG0,U,6)
"RTN","ORCDPS2",154,0)
 I '$G(ORDOSE(1)) S ORI=0 F  S ORI=$O(ORDIALOG(INSTR,ORI)) Q:ORI'>0  D
"RTN","ORCDPS2",155,0)
 . S LDOSE=$G(ORDIALOG(INSTR,ORI)),X=$G(ORDIALOG(DOSE,ORI)) Q:'$L(X)
"RTN","ORCDPS2",156,0)
 . S:'X ORDIALOG(INSTR,ORI)=LDOSE_CONJ_" "_$S(STRG:STRG,1:$P(DRUG0,U))
"RTN","ORCDPS2",157,0)
 ; -build Sig/Text if not defined
"RTN","ORCDPS2",158,0)
 I '$D(ORDIALOG(+$$PTR("SIG"),1)) S PROMPT=INSTR D SIG
"RTN","ORCDPS2",159,0)
 Q
"RTN","ORCDPS2",160,0)
 ;
"RTN","ORCDPS2",161,0)
PI ; -- Include Pt Instructions w/Sig in Outpt order?
"RTN","ORCDPS2",162,0)
 N X,Y,DIR,DUOUT,DTOUT,DIRUT,ORTX,ORMAX,I,CNT
"RTN","ORCDPS2",163,0)
 I $G(ORCAT)'="O" D CLEARWP Q  ;!'$O(ORDOSE("PI",0))
"RTN","ORCDPS2",164,0)
 Q:$G(ORENEW)  S I=0,ORMAX=57
"RTN","ORCDPS2",165,0)
 I $G(OREDIT)!$G(OREWRITE),$O(^TMP("ORWORD",$J,PROMPT,INST,0)) K ORDOSE("PI") S I=0 F  S I=$O(^TMP("ORWORD",$J,PROMPT,INST,I)) Q:I<1  S ORDOSE("PI",I)=$G(^(I,0))
"RTN","ORCDPS2",166,0)
 I '$O(ORDOSE("PI",0)) D CLEARWP Q
"RTN","ORCDPS2",167,0)
 F  S I=$O(ORDOSE("PI",I)) Q:I'>0  S X=ORDOSE("PI",I) D TXT^ORCHTAB
"RTN","ORCDPS2",168,0)
 S DIR(0)="YA",DIR("A")="Include Patient Instructions in Sig? "
"RTN","ORCDPS2",169,0)
 S DIR("?")="Enter NO if you do not want these instructions included in the sig for this order",DIR("B")=$S($D(^TMP("ORWORD",$J,PROMPT)):"YES",1:"NO")
"RTN","ORCDPS2",170,0)
 W ! S I=0 F  S I=$O(ORTX(I)) Q:I'>0  W !,$S(I=1:"Patient Instructions: ",1:"                      ")_ORTX(I)
"RTN","ORCDPS2",171,0)
 D ^DIR I $D(DUOUT)!$D(DTOUT) S ORQUIT=1 Q
"RTN","ORCDPS2",172,0)
 I Y D  Q  ;save text
"RTN","ORCDPS2",173,0)
 . K ^TMP("ORWORD",$J,PROMPT,INST) S CNT=0
"RTN","ORCDPS2",174,0)
 . S I=0 F  S I=$O(ORDOSE("PI",I)) Q:I'>0  S ^TMP("ORWORD",$J,PROMPT,INST,I,0)=ORDOSE("PI",I),CNT=CNT+1
"RTN","ORCDPS2",175,0)
 . S ^TMP("ORWORD",$J,PROMPT,INST,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORCDPS2",176,0)
 . S ORDIALOG(PROMPT,INST)="^TMP(""ORWORD"","_$J_","_PROMPT_","_INST_")"
"RTN","ORCDPS2",177,0)
 I Y'>0 K ORDIALOG(PROMPT,INST),^TMP("ORWORD",$J,PROMPT,INST)
"RTN","ORCDPS2",178,0)
 Q
"RTN","ORCDPS2",179,0)
 ;
"RTN","ORCDPS2",180,0)
CLEARWP ; -- Clear INST of wp field PROMPT
"RTN","ORCDPS2",181,0)
 K ORDIALOG(PROMPT,INST),^TMP("ORWORD",$J,PROMPT,INST)
"RTN","ORCDPS2",182,0)
 Q
"RTN","ORCHECK")
0^6^B120029142
"RTN","ORCHECK",1,0)
ORCHECK ;SLC/MKB-Order checking calls ;06/28/13  07:51
"RTN","ORCHECK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,70,94,141,215,243,293,280,346,357,352,345,311**;Dec 17, 1997;Build 30
"RTN","ORCHECK",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCHECK",4,0)
DISPLAY ; -- DISPLAY event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",5,0)
 ;    Expects ORVP, ORNMSP, ORTAB, [ORWARD]
"RTN","ORCHECK",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",7,0)
 N ORX,ORY,I
"RTN","ORCHECK",8,0)
 I ORNMSP="PS" D  ;reset to PSJ, PSJI, or PSO
"RTN","ORCHECK",9,0)
 . I $G(ORDG) S I=$P($G(^ORD(100.98,+ORDG,0)),U,3),I=$P(I," ") Q:'$L(I)  S ORNMSP="PS"_$S(I="UD":"I",1:I) Q
"RTN","ORCHECK",10,0)
 . I $G(ORXFER) S I=$P($P(^TMP("OR",$J,ORTAB,0),U,3),";",3) S:I="" I=$G(ORWARD) S ORNMSP="PS"_$S(I:"O",1:"I") ;opposite of list
"RTN","ORCHECK",11,0)
 S ORX(1)="|"_ORNMSP,ORX=1
"RTN","ORCHECK",12,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"DISPLAY") Q:'$D(ORY)
"RTN","ORCHECK",13,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  W !,$P(ORY(I),U,4) ; display only
"RTN","ORCHECK",14,0)
 Q
"RTN","ORCHECK",15,0)
 ;
"RTN","ORCHECK",16,0)
SELECT ; -- SELECT event
"RTN","ORCHECK",17,0)
 ;    Expects ORVP, ORDAILOG(PROMPT,ORI), ORNMSP
"RTN","ORCHECK",18,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",19,0)
 N ORX,ORY,OI,ORDODSG
"RTN","ORCHECK",20,0)
 S OI=+$G(ORDIALOG(PROMPT,ORI)),ORDODSG=0
"RTN","ORCHECK",21,0)
 S ORX=1,ORX(1)=OI_"|"_ORNMSP_"|"_$$USID^ORMBLD(OI)
"RTN","ORCHECK",22,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"SELECT",,.ORDODSG),RETURN:$D(ORY)
"RTN","ORCHECK",23,0)
 Q
"RTN","ORCHECK",24,0)
 ;
"RTN","ORCHECK",25,0)
ACCEPT(MODE) ; -- ACCEPT event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",26,0)
 ;    Expects ORVP, ORDIALOG(), ORNMSP
"RTN","ORCHECK",27,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",28,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",29,0)
 N ORX,ORY,ORZ,OI,ORSTRT,ORI,ORIT,ORID,ORSP,ORDODSG
"RTN","ORCHECK",30,0)
 S:'$L($G(MODE)) MODE="ACCEPT"
"RTN","ORCHECK",31,0)
 S OI=$$PTR^ORCD("OR GTX ORDERABLE ITEM"),ORSTRT=$$START,ORX=0,ORDODSG=0
"RTN","ORCHECK",32,0)
 S ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",33,0)
 I $G(ORDG)=+$O(^ORD(100.98,"B","IV RX",0)) S OI=$$PTR^ORCD("OR GTX ADDITIVE"),ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",34,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,MODE,,.ORDODSG),RETURN:$D(ORY),FDBDOWN(0)
"RTN","ORCHECK",35,0)
 Q
"RTN","ORCHECK",36,0)
STUF S ORIT=ORDIALOG(OI,ORI),ORSP=""
"RTN","ORCHECK",37,0)
 S:ORNMSP="LR" ORSP=+$G(ORDIALOG($$PTR^ORCD("OR GTX SPECIMEN"),ORI))
"RTN","ORCHECK",38,0)
 S ORID=$S($E(ORNMSP,1,2)="PS":$$DRUG(ORIT,OI),1:$$USID^ORMBLD(ORIT))
"RTN","ORCHECK",39,0)
 S ORZ=1,ORZ(1)=ORIT_"|"_ORNMSP_"|"_ORID
"RTN","ORCHECK",40,0)
 I MODE'="ALL" D EN^ORKCHK(.ORY,+ORVP,.ORZ,"SELECT",,.ORDODSG),RETURN:$D(ORY)
"RTN","ORCHECK",41,0)
 S ORX=ORX+1,ORX(ORX)=ORZ(1)_"|"_ORSTRT_"||"_ORSP K ORY,ORZ
"RTN","ORCHECK",42,0)
 Q
"RTN","ORCHECK",43,0)
 ;
"RTN","ORCHECK",44,0)
DELAY(MODE) ; -- Delayed ACCEPT event [called from ORMEVNT]
"RTN","ORCHECK",45,0)
 ;    Expects ORVP, ORIFN
"RTN","ORCHECK",46,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",47,0)
 N ORX,ORY,ORCHECK,ORDODSG S:'$L($G(MODE)) MODE="NOTIF"
"RTN","ORCHECK",48,0)
 S ORDODSG=0
"RTN","ORCHECK",49,0)
 D BLD(+ORIFN),EN^ORKCHK(.ORY,+ORVP,.ORX,MODE,,.ORDODSG) Q:'$D(ORY)
"RTN","ORCHECK",50,0)
 D RETURN I MODE="NOTIF" S ORCHECK("OK")="Notification sent to provider" D OC^ORCSAVE2 Q  ; silent
"RTN","ORCHECK",51,0)
 Q
"RTN","ORCHECK",52,0)
 ;
"RTN","ORCHECK",53,0)
BLD(ORDER) ; -- Build new ORX(#) for ORDER
"RTN","ORCHECK",54,0)
 Q:'$G(ORDER)  Q:'$D(^OR(100,ORDER,0))  ;Q:$P($G(^(3)),U,11)  ;edit/renew
"RTN","ORCHECK",55,0)
 N PKG,START,ORI,ITEM,USID,SPEC,ORDG,PTR,INST,ORXSETIV
"RTN","ORCHECK",56,0)
 S ORXSETIV=0
"RTN","ORCHECK",57,0)
 S ORDG=$P(^OR(100,ORDER,0),U,11),PKG=$$GET1^DIQ(9.4,$P(^(0),U,14)_",",1)
"RTN","ORCHECK",58,0)
 I PKG="PS",$G(ORDG) S ORI=$P($G(^ORD(100.98,+ORDG,0)),U,3),ORI=$P(ORI," "),PKG=PKG_$S(ORI="UD":"I",1:ORI)
"RTN","ORCHECK",59,0)
 S START=$$START(ORDER),ORI=0
"RTN","ORCHECK",60,0)
 I PKG="PSJ" D
"RTN","ORCHECK",61,0)
 .N ORITEMS,IDX
"RTN","ORCHECK",62,0)
 .D MAYBEIV^ORWDXR01(.ORITEMS,ORDER)
"RTN","ORCHECK",63,0)
 .Q:$G(ORITEMS)=""
"RTN","ORCHECK",64,0)
 .F IDX=1:1:$L(ORITEMS,U) D
"RTN","ORCHECK",65,0)
 ..S ORX=+$G(ORX)+1,ORX(ORX)=$P(ORITEMS,U,IDX),$P(ORX(ORX),"|",3)=$$DRUG(+ORX(ORX),$P(ORX(ORX),"|",3),ORDER)
"RTN","ORCHECK",66,0)
 ..S $P(ORX(ORX),"|",4)=START
"RTN","ORCHECK",67,0)
 ..S ORXSETIV=1
"RTN","ORCHECK",68,0)
 Q:ORXSETIV
"RTN","ORCHECK",69,0)
 F  S ORI=$O(^OR(100,ORDER,4.5,"ID","ORDERABLE",ORI)) Q:ORI'>0  D
"RTN","ORCHECK",70,0)
 . S INST=$P($G(^OR(100,ORDER,4.5,ORI,0)),U,3),PTR=$P($G(^(0)),U,2),ITEM=+$G(^(1))
"RTN","ORCHECK",71,0)
 . S USID=$S(PKG?1"PS".E:$$DRUG(ITEM,PTR,ORDER),1:$$USID^ORMBLD(ITEM))
"RTN","ORCHECK",72,0)
 . S SPEC=$S(PKG="LR":$$VALUE^ORCSAVE2(ORDER,"SPECIMEN",INST),1:"")
"RTN","ORCHECK",73,0)
 . S ORX=+$G(ORX)+1,ORX(ORX)=ITEM_"|"_PKG_"|"_USID_"|"_START_"|"_ORDER_"|"_SPEC
"RTN","ORCHECK",74,0)
 Q
"RTN","ORCHECK",75,0)
 ;
"RTN","ORCHECK",76,0)
REMDUPS ;
"RTN","ORCHECK",77,0)
 N IFN,CDL,I,J,CDL2
"RTN","ORCHECK",78,0)
 S IFN=0 F  S IFN=$O(ORCHECK(IFN)) Q:'IFN  D
"RTN","ORCHECK",79,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORCHECK",80,0)
 .. S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORCHECK",81,0)
 ... S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORCHECK",82,0)
 .... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORCHECK",83,0)
 ..... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",84,0)
 ..... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORCHECK",85,0)
 ... I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",86,0)
 Q
"RTN","ORCHECK",87,0)
 ;
"RTN","ORCHECK",88,0)
START(DA) ; -- Returns start date/time
"RTN","ORCHECK",89,0)
 N I,X,Y,%DT S Y=""
"RTN","ORCHECK",90,0)
 I $G(DA) S X=$O(^OR(100,DA,4.5,"ID","START",0)),X=$G(^OR(100,DA,4.5,+X,1))
"RTN","ORCHECK",91,0)
 E  D  ; look in ORDIALOG instead
"RTN","ORCHECK",92,0)
 . S I=0 F  S I=$O(ORDIALOG(I)) Q:I'>0  Q:$P(ORDIALOG(I),U,2)="START"
"RTN","ORCHECK",93,0)
 . S X=$S(I:$G(ORDIALOG(I,1)),1:"")
"RTN","ORCHECK",94,0)
 D AM^ORCSAVE2:X="AM",NEXT^ORCSAVE2:X="NEXT"
"RTN","ORCHECK",95,0)
 D ADMIN^ORCSAVE2("NEXT"):X="NEXTA",ADMIN^ORCSAVE2("CLOSEST"):X="CLOSEST"
"RTN","ORCHECK",96,0)
 I $L(X) S %DT="TX" D ^%DT S:Y'>0 Y=""
"RTN","ORCHECK",97,0)
 Q Y
"RTN","ORCHECK",98,0)
 ;
"RTN","ORCHECK",99,0)
DRUG(OI,PTR,IFN) ; -- Returns 6 ^-piece identifier for Dispense Drug
"RTN","ORCHECK",100,0)
 N ORDD,ORNDF,Y
"RTN","ORCHECK",101,0)
 I ORDG=+$O(^ORD(100.98,"B","IV RX",0)) S ORDD=$$IV G D1
"RTN","ORCHECK",102,0)
 I $G(IFN) S ORDD=$O(^OR(100,IFN,4.5,"ID","DRUG",0)),ORDD=+$G(^OR(100,IFN,4.5,+ORDD,1))
"RTN","ORCHECK",103,0)
 E  S ORDD=+$G(ORDIALOG($$PTR^ORCD("OR GTX DISPENSE DRUG"),1))
"RTN","ORCHECK",104,0)
D1 Q:'ORDD "" S ORNDF=$$ENDCM^PSJORUTL(ORDD)
"RTN","ORCHECK",105,0)
 S Y=$P(ORNDF,U,3)_"^^99NDF^"_ORDD_U_$$NAME50^ORPEAPI(ORDD)_"^99PSD"
"RTN","ORCHECK",106,0)
 Q Y
"RTN","ORCHECK",107,0)
 ;
"RTN","ORCHECK",108,0)
IV() ; -- Get Dispense Drug for IV orderable
"RTN","ORCHECK",109,0)
 N PSOI,TYPE,VOL,ORY
"RTN","ORCHECK",110,0)
 S PSOI=+$P($G(^ORD(101.43,+OI,0)),U,2),VOL=""
"RTN","ORCHECK",111,0)
 S TYPE=$S(PTR=$$PTR^ORCD("OR GTX ADDITIVE"):"A",1:"B")
"RTN","ORCHECK",112,0)
 S:TYPE="B" VOL=$S($G(IFN):$$VALUE^ORCSAVE2(IFN,"VOLUME"),1:+$G(ORDIALOG($$PTR^ORCD("OR GTX VOLUME"),1)))
"RTN","ORCHECK",113,0)
 D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORY)
"RTN","ORCHECK",114,0)
 Q +$G(ORY)
"RTN","ORCHECK",115,0)
 ;
"RTN","ORCHECK",116,0)
LIST(IFN) ; -- Displays list of ORCHECK(IFN) checks
"RTN","ORCHECK",117,0)
 N ORI,ORJ,ORZ,ORMAX,ORTX,ON,OFF
"RTN","ORCHECK",118,0)
 S ORZ=0 F  S ORZ=$O(ORCHECK(IFN,ORZ)) Q:ORZ'>0  D
"RTN","ORCHECK",119,0)
 . S:ORZ=1 ON=IOINHI,OFF=IOINORM S:ORZ'=1 (ON,OFF)="" ; use bold if High
"RTN","ORCHECK",120,0)
 . S ORI=0 F  S ORI=$O(ORCHECK(IFN,ORZ,ORI)) Q:ORI'>0  D
"RTN","ORCHECK",121,0)
 . . S X=$P(ORCHECK(IFN,ORZ,ORI),U,3) I $L(X)<75 W !,ON_">>>  "_X_OFF Q
"RTN","ORCHECK",122,0)
 . . S ORMAX=74 K ORTX D TXT^ORCHTAB Q:'$G(ORTX)  ; wrap
"RTN","ORCHECK",123,0)
 . . F ORJ=1:1:ORTX W !,ON_$S(ORJ=1:">>>  ",1:"      ")_ORTX(ORJ)_OFF
"RTN","ORCHECK",124,0)
 W !
"RTN","ORCHECK",125,0)
 Q
"RTN","ORCHECK",126,0)
 ;
"RTN","ORCHECK",127,0)
CANCEL() ; -- Returns 1 or 0: Cancel order(s)?
"RTN","ORCHECK",128,0)
 N X,Y,DIR,NUM
"RTN","ORCHECK",129,0)
 S NUM=+$G(ORCHECK("IFN")),DIR(0)="YA"
"RTN","ORCHECK",130,0)
 S DIR("A")="Do you want to cancel "_$S(NUM>1:"any of the new orders? ",1:"the new order? ")
"RTN","ORCHECK",131,0)
 S DIR("?",1)="Enter YES to cancel "_$S(NUM>1:"an",1:"the")_" order.  If you wish to override these order checks"
"RTN","ORCHECK",132,0)
 S DIR("?",2)="and release "_$S(NUM>1:"these orders",1:"this order")_", enter NO; you will be prompted for a justification",DIR("?")="if there are any highlighted critical order checks."
"RTN","ORCHECK",133,0)
 D ^DIR
"RTN","ORCHECK",134,0)
 Q +Y
"RTN","ORCHECK",135,0)
 ;
"RTN","ORCHECK",136,0)
REASON() ; -- Reason for overriding order checks
"RTN","ORCHECK",137,0)
 ; I '$D(^XUSEC("ORES",DUZ)),'$D(^XUSEC("ORELSE",DUZ)) Q  ??
"RTN","ORCHECK",138,0)
 N X,Y,DIR
"RTN","ORCHECK",139,0)
 S DIR(0)="FA^2:80^K:X?1."" "" X",DIR("A")="REASON FOR OVERRIDE: "
"RTN","ORCHECK",140,0)
 S DIR("?")="Enter a justification for overriding these order checks, up to 80 characters"
"RTN","ORCHECK",141,0)
 D ^DIR I $D(DTOUT)!$D(DUOUT) S Y="^"
"RTN","ORCHECK",142,0)
 Q Y
"RTN","ORCHECK",143,0)
 ;
"RTN","ORCHECK",144,0)
SESSION ; -- SESSION event [called from ORCSIGN]
"RTN","ORCHECK",145,0)
 ;    Expects ORVP, ORES()
"RTN","ORCHECK",146,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",147,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",148,0)
 N ORX,ORY,ORIFN,I,X,Y,ORGLOB
"RTN","ORCHECK",149,0)
 S ORGLOB=$H
"RTN","ORCHECK",150,0)
 K ^TMP($J,ORGLOB)
"RTN","ORCHECK",151,0)
 S ORIFN=0 F  S ORIFN=$O(ORES(ORIFN)) Q:ORIFN'>0  I +$P(ORIFN,";",2)'>1 D
"RTN","ORCHECK",152,0)
 . I "^14^13^11^10^"'[(U_$P($G(^OR(100,+ORIFN,3)),U,3)_U) Q  ;unreleased
"RTN","ORCHECK",153,0)
 . D BLD(+ORIFN) K ^TMP($J,"OCDATA") Q:'$$OCAPI^ORCHECK(+ORIFN,"OCDATA")
"RTN","ORCHECK",154,0)
 . S ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1
"RTN","ORCHECK",155,0)
 . S I=0 F  S I=$O(^TMP($J,"OCDATA",I)) Q:'I  D
"RTN","ORCHECK",156,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=32,$$ALGASS(+ORIFN)=1 Q
"RTN","ORCHECK",157,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=3 Q
"RTN","ORCHECK",158,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." Q
"RTN","ORCHECK",159,0)
 . . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",160,0)
 . . I $O(^TMP($J,"OCDATA",I,"OC TEXT",1)) D
"RTN","ORCHECK",161,0)
 . . . S ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_"||"_ORGLOB_"&"_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",162,0)
 . . . N ORI S ORI=0 F  S ORI=$O(^TMP($J,"OCDATA",I,"OC TEXT",ORI)) Q:'ORI  S ^TMP($J,"ORK XTRA TXT",ORGLOB,^TMP($J,"OCDATA",I,"OC TEXT",1,0),ORI)=^TMP($J,"OCDATA",I,"OC TEXT",ORI,0)
"RTN","ORCHECK",163,0)
 . . I $D(^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)) D
"RTN","ORCHECK",164,0)
 . . . N ORMONOI S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",""),-1)+1
"RTN","ORCHECK",165,0)
 . . . M ^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)
"RTN","ORCHECK",166,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),17)
"RTN","ORCHECK",167,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")=$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))
"RTN","ORCHECK",168,0)
 . K ^TMP($J,"OCDATA")
"RTN","ORCHECK",169,0)
 I $D(ORX) D EN^ORKCHK(.ORY,+ORVP,.ORX,"SESSION"),RETURN:$D(ORY),FDBDOWN(1),REMDUPS
"RTN","ORCHECK",170,0)
 Q
"RTN","ORCHECK",171,0)
 ;
"RTN","ORCHECK",172,0)
FDBDOWN(ORX) ; -- Checks to see if the FDB was down and if so set appropriate OC
"RTN","ORCHECK",173,0)
 ; expects ORCHECK array of order checks
"RTN","ORCHECK",174,0)
 ; if ORX is 1 then this is getting called from SESSION order checks
"RTN","ORCHECK",175,0)
 Q:'$D(ORCHECK)
"RTN","ORCHECK",176,0)
 ;look for the "not able to be performed" OCs for each type (DSG and ENH), set flag for each to 1 if found and remove them from ORCHECK
"RTN","ORCHECK",177,0)
 N I S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORCHECK",178,0)
 .N ORNEXT,ORDSG,ORENH,ORTHERE
"RTN","ORCHECK",179,0)
 .S ORDSG=0,ORENH=0,ORTHERE=0,ORNEXT=1
"RTN","ORCHECK",180,0)
 .N J S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORCHECK",181,0)
 ..N K S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORCHECK",182,0)
 ...I (K+1)>ORNEXT S ORNEXT=K+1
"RTN","ORCHECK",183,0)
 ...I $G(ORCHECK(I,J,K))[$$DSDWNMSG^ORDSGCHK K ORCHECK(I,J,K) S ORDSG=1
"RTN","ORCHECK",184,0)
 ...I $G(ORCHECK(I,J,K))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." K ORCHECK(I,J,K) S ORENH=1
"RTN","ORCHECK",185,0)
 ...I $G(ORCHECK(I,J,K))["These checks could not be completed for this patient:" S ORTHERE=1
"RTN","ORCHECK",186,0)
 .;if DSG or ENH flag is set then add to ORY
"RTN","ORCHECK",187,0)
 .I ORDSG!(ORENH) D
"RTN","ORCHECK",188,0)
 ..;look to see if message already exists
"RTN","ORCHECK",189,0)
 ..I ORTHERE Q
"RTN","ORCHECK",190,0)
 ..N ORKGLOB S ORKGLOB=$H_","_I
"RTN","ORCHECK",191,0)
 ..N ORMAIN S ORMAIN="These checks could not be completed for this patient:"
"RTN","ORCHECK",192,0)
 ..S ORCHECK(I,2,ORNEXT)="25^2^||"_ORKGLOB_"&"_ORMAIN
"RTN","ORCHECK",193,0)
 ..I $G(ORX) S ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,0)=ORMAIN
"RTN","ORCHECK",194,0)
 ..N ORCNT S ORCNT=1
"RTN","ORCHECK",195,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Drug Interactions"
"RTN","ORCHECK",196,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Duplicate Therapy"
"RTN","ORCHECK",197,0)
 ..I '$G(ORX),ORDSG S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Dosing"
"RTN","ORCHECK",198,0)
 Q
"RTN","ORCHECK",199,0)
 ;
"RTN","ORCHECK",200,0)
RETURN ; -- Return checks in ORCHECK(ORIFN,CDL,#)
"RTN","ORCHECK",201,0)
 N I,IFN,CDL S I=0 F  S I=$O(ORY(I)) Q:I'>0  D
"RTN","ORCHECK",202,0)
 . S IFN=+$P(ORY(I),U) S:'IFN IFN="NEW"
"RTN","ORCHECK",203,0)
 . S CDL=+$P(ORY(I),U,3) S:'CDL CDL=99
"RTN","ORCHECK",204,0)
 . S:'$D(ORCHECK(IFN)) ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1 ; count
"RTN","ORCHECK",205,0)
 . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(IFN,CDL,ORCHECK)=$P(ORY(I),U,2,4)
"RTN","ORCHECK",206,0)
 Q
"RTN","ORCHECK",207,0)
 ;
"RTN","ORCHECK",208,0)
ALGASS(ORIFN) ;see if patient from order has an allergy assessment
"RTN","ORCHECK",209,0)
 N ORDFN S ORDFN=+$P(^OR(100,ORIFN,0),U,2)
"RTN","ORCHECK",210,0)
 K ORARRAY D EN1^GMRAOR1(ORDFN,"ORARRAY")
"RTN","ORCHECK",211,0)
 I ORARRAY'="" Q 1
"RTN","ORCHECK",212,0)
 Q 0
"RTN","ORCHECK",213,0)
OCAPI(IFN,ORPLACE) ;IA #4859
"RTN","ORCHECK",214,0)
 ;LOOK AT ROUTINE OROCAPI1 FOR MORE DETAILED APIS
"RTN","ORCHECK",215,0)
 ;API to get the order checking info for a specific order (IFN)
"RTN","ORCHECK",216,0)
 ;info is stored in ^TMP($J,ORPLACE)
"RTN","ORCHECK",217,0)
 ;               ^TMP($J,ORPLACE,D0,"OC LEVEL")="order check level"
"RTN","ORCHECK",218,0)
 ;                                                 ,"OC NUMBER")="file 100.8 ien"
"RTN","ORCHECK",219,0)
 ;                                                 ,"OC TEXT")="order check text"
"RTN","ORCHECK",220,0)
 ;                                                 ,"OR REASON")="over ride reason text"
"RTN","ORCHECK",221,0)
 ;                                                 ,"OR PROVIDER")="provider DUZ who entered over ride reason"
"RTN","ORCHECK",222,0)
 ;                                                 ,"OR DT")="date/time over ride reason was entered"
"RTN","ORCHECK",223,0)
 ; NOTE on OC LEVEL: 1 is HIGH, 2 is MODERATE, 3 is LOW
"RTN","ORCHECK",224,0)
 N RET,ORN,CNT,I,ORFLAG
"RTN","ORCHECK",225,0)
 S ORN=+IFN,CNT=0,ORFLAG=0
"RTN","ORCHECK",226,0)
 ;if the order is not released then show ACCEPTANCE_CPRS ocs
"RTN","ORCHECK",227,0)
 I "^14^13^11^10^"[(U_$P($G(^OR(100,ORN,3)),U,3)_U) D GETOC5^OROCAPI1(ORN,"ACCEPTANCE_CPRS",.RET) S ORFLAG=1
"RTN","ORCHECK",228,0)
 ;if it has been signed then show SIGNATURE_CPRS ocs
"RTN","ORCHECK",229,0)
 I 'ORFLAG D GETOC5^OROCAPI1(ORN,"SIGNATURE_CPRS",.RET)
"RTN","ORCHECK",230,0)
 I $D(RET) S I=0 F  S I=$O(RET(ORN,"DATA",I)) Q:'I  S CNT=CNT+1 D
"RTN","ORCHECK",231,0)
 .S ^TMP($J,ORPLACE,CNT,"OC NUMBER")=$P($G(RET(ORN,"DATA",I,1)),U)
"RTN","ORCHECK",232,0)
 .S ^TMP($J,ORPLACE,CNT,"OC LEVEL")=$P($G(RET(ORN,"DATA",I,1)),U,2)
"RTN","ORCHECK",233,0)
 .M ^TMP($J,ORPLACE,CNT,"OC TEXT")=RET(ORN,"DATA",I,"OC")
"RTN","ORCHECK",234,0)
 .S ^TMP($J,ORPLACE,CNT,"OR REASON")=$G(RET(ORN,"DATA",I,"OR",1,0))
"RTN","ORCHECK",235,0)
 .S ^TMP($J,ORPLACE,CNT,"OR PROVIDER")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,4),1:"")
"RTN","ORCHECK",236,0)
 .S ^TMP($J,ORPLACE,CNT,"OR DT")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,5),1:"")
"RTN","ORCHECK",237,0)
 .S ^TMP($J,ORPLACE,CNT,"OR STATUS")=$P($G(RET(ORN,"DATA",I,0)),U,2)
"RTN","ORCHECK",238,0)
 .S ^TMP($J,ORPLACE,CNT,"OC INSTANCE")=I
"RTN","ORCHECK",239,0)
 Q CNT
"RTN","ORCHECK",240,0)
 ;
"RTN","ORCHECK",241,0)
ISMONO(ORY) ;returns 1 if there is monograph data for the orderchecks being presented to the user
"RTN","ORCHECK",242,0)
 S ORY=0
"RTN","ORCHECK",243,0)
 Q:'$$PATCH^XPDUTL("OR*3.0*272")
"RTN","ORCHECK",244,0)
 I $D(^TMP($J,"ORMONOGRAPH")) S ORY=1
"RTN","ORCHECK",245,0)
 Q
"RTN","ORCHECK",246,0)
GETMONOL(ORY) ;returns a list of monographs available for the orderchecks being presented to the user
"RTN","ORCHECK",247,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH"))
"RTN","ORCHECK",248,0)
 N I S I=0
"RTN","ORCHECK",249,0)
 F  S I=$O(^TMP($J,"ORMONOGRAPH",I)) Q:'I  D
"RTN","ORCHECK",250,0)
 .S ORY($G(^TMP($J,"ORMONOGRAPH",I,"INT")))=I_U_$G(^TMP($J,"ORMONOGRAPH",I,"INT"))
"RTN","ORCHECK",251,0)
 Q
"RTN","ORCHECK",252,0)
GETMONO(ORY,ORMONO) ;return a monograph
"RTN","ORCHECK",253,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH",ORMONO))
"RTN","ORCHECK",254,0)
 K ^TMP($J,"ORMONORPC")
"RTN","ORCHECK",255,0)
 M ^TMP($J,"ORMONORPC")=^TMP($J,"ORMONOGRAPH",ORMONO,"DATA")
"RTN","ORCHECK",256,0)
 K ^TMP($J,"ORMONORPC",0)
"RTN","ORCHECK",257,0)
 S ORY=$NA(^TMP($J,"ORMONORPC")),@ORY=""
"RTN","ORCHECK",258,0)
 Q
"RTN","ORCHECK",259,0)
DELMONO(ORY) ;delete monograph data
"RTN","ORCHECK",260,0)
 K ^TMP($J,"ORMONOGRAPH"),^TMP($J,"ORMONORPC")
"RTN","ORCHECK",261,0)
 Q
"RTN","ORCHECK",262,0)
GETXTRA(ORY,ORGL,ORRULE) ;get extra text for an order check
"RTN","ORCHECK",263,0)
 ;^TMP($J,"ORK XTRA TXT") stores the text of order checks that are longer than a single line (reminder order checks)
"RTN","ORCHECK",264,0)
 Q:'$D(^TMP($J,"ORK XTRA TXT",ORGL,ORRULE))
"RTN","ORCHECK",265,0)
 M ORY=^TMP($J,"ORK XTRA TXT",ORGL,ORRULE)
"RTN","ORCHECK",266,0)
 Q
"RTN","ORCMED")
0^12^B75152203
"RTN","ORCMED",1,0)
ORCMED ;SLC/MKB - MEDICATION ACTIONS ;06/26/2013  14:29
"RTN","ORCMED",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**4,7,38,48,94,141,178,190,195,243,306,371,311**;Dec 17, 1997;Build 30
"RTN","ORCMED",3,0)
XFER ; -- transfer to in/outpt meds
"RTN","ORCMED",4,0)
 N ORPTLK,ORTYPE,ORXFER,ORSRC,ORCAT,OREVENT,X,ORINPT,ORIDLG,ORODLG,ORIVDLG,ORNMSP,ORCNT,ORI,NMBR,ORIFN,OLDIFN,ORDIALOG,ORDG,ORCHECK,ORQUIT,ORDUZ,ORLOG,FIRST,ORDITM,ORD,ORERR
"RTN","ORCMED",5,0)
 S ORPTLK=$$LOCK^ORX2(+ORVP) I 'ORPTLK D  G XFQ ; lock pt chart
"RTN","ORCMED",6,0)
 . W !!,$C(7),$P(ORPTLK,U,2) H 2
"RTN","ORCMED",7,0)
 . S:'$D(VALMBCK) VALMBCK=""
"RTN","ORCMED",8,0)
 I '$G(ORNMBR) S ORNMBR=$$ORDERS^ORCHART("transfer") G:'ORNMBR XFQ
"RTN","ORCMED",9,0)
 D FULL^VALM1 S VALMBCK="R",ORTYPE="Q",ORXFER=1,ORDUZ=DUZ,ORSRC="X"
"RTN","ORCMED",10,0)
 S X=$P($P($G(^TMP("OR",$J,"CURRENT",0)),U,3),";",3) S:X="" X=$G(ORWARD)
"RTN","ORCMED",11,0)
 S ORCAT=$S(X:"O",1:"I") I ORCAT="I"!$G(ORWARD) D  Q:$G(OREVENT)="^"
"RTN","ORCMED",12,0)
 . W !!,$$CURRENT^OREVNT
"RTN","ORCMED",13,0)
 . S X=$$DELAY^ORCACT I X="^" S OREVENT="^" Q
"RTN","ORCMED",14,0)
 . S:X OREVENT=+$$PTEVENT^OREVNT(+ORVP,1)
"RTN","ORCMED",15,0)
 I '$G(ORL) S ORL=$S($G(OREVENT):$$LOC^OREVNTX(OREVENT),1:$$LOCATION^ORCMENU1) G:ORL="^" XFQ
"RTN","ORCMED",16,0)
 S ORINPT=$$INPT^ORCD,ORNP=$$PROVIDER^ORCMENU1 G:ORNP="^" XFQ
"RTN","ORCMED",17,0)
 I 'ORINPT,ORCAT="I" D IMOLOC^ORIMO(.ORINPT,+ORL,+ORVP) S:ORINPT<0 ORINPT=0 ;allow inpt meds at this location?
"RTN","ORCMED",18,0)
 S ORIDLG=+$O(^ORD(101.41,"AB","PSJ OR PAT OE",0))
"RTN","ORCMED",19,0)
 S ORODLG=+$O(^ORD(101.41,"AB","PSO OERR",0))
"RTN","ORCMED",20,0)
 S ORIVDLG=+$O(^ORD(101.41,"AB","PSJI OR PAT FLUID OE",0))
"RTN","ORCMED",21,0)
 D PROVIDER^ORCDPSIV G:$G(ORQUIT) XFQ ;X:$D(^ORD(101.41,ORDIALOG,3)) ^(3)
"RTN","ORCMED",22,0)
 S ORNMSP="PS" D DISPLAY^ORCHECK
"RTN","ORCMED",23,0)
 S ORCNT=$L(ORNMBR,",") S:$P(ORNMBR,",",ORCNT)'>0 ORCNT=ORCNT-1
"RTN","ORCMED",24,0)
XF1 F ORI=1:1:ORCNT S NMBR=$P(ORNMBR,",",ORI) D:NMBR  I $D(ORQUIT),ORI<ORCNT Q:'$$CONT  ;if not last one, ask
"RTN","ORCMED",25,0)
 . K ORIFN,ORDIALOG,ORDG,ORDOSE,ORCHECK,ORQUIT,ORERR
"RTN","ORCMED",26,0)
 . K ^TMP("PSJMR",$J),^TMP("ORWORD",$J),^TMP("ORSIG",$J)
"RTN","ORCMED",27,0)
 . S OLDIFN=+$P($G(^TMP("OR",$J,ORTAB,"IDX",NMBR)),U,4)
"RTN","ORCMED",28,0)
 . S ORDITM=$$ORDITEM^ORCACT(OLDIFN) D SUBHDR^ORCACT(ORDITM)
"RTN","ORCMED",29,0)
 . I '$$VALID^ORCACT0(OLDIFN,"XFR",.ORERR) W !,ORERR H 2 Q
"RTN","ORCMED",30,0)
 . S ORD=$P($G(^OR(100,OLDIFN,0)),U,5) Q:ORD'["101.41"  ;error msg?
"RTN","ORCMED",31,0)
 . S ORDIALOG=$S(+ORD=ORIVDLG:ORIVDLG,ORCAT="I":ORIDLG,1:ORODLG)
"RTN","ORCMED",32,0)
 . S ORDG=+$P($G(^ORD(101.41,ORDIALOG,0)),U,5)
"RTN","ORCMED",33,0)
 . D GETDLG^ORCD(ORDIALOG),GETORDER^ORCD(OLDIFN)
"RTN","ORCMED",34,0)
 . I ORDIALOG'=ORIVDLG D OUT:ORCAT="I",IN:ORCAT="O" ;convert data
"RTN","ORCMED",35,0)
 . K ORDIALOG($$PTR^ORCD("OR GTX START DATE/TIME"),1)
"RTN","ORCMED",36,0)
 . K ORDIALOG($$PTR^ORCD("OR GTX NOW"),1)
"RTN","ORCMED",37,0)
 . S ORLOG=+$E($$NOW^XLFDT,1,12),FIRST=1
"RTN","ORCMED",38,0)
XF2 . D DIALOG^ORCDLG Q:$G(ORQUIT)&FIRST  K ORQUIT
"RTN","ORCMED",39,0)
 . D ACCEPT^ORCHECK(),DISPLAY^ORCDLG S X=$$OK^ORCDLG I X="^" S ORQUIT=1 Q
"RTN","ORCMED",40,0)
 . I X="E" K ORCHECK S FIRST=0 G XF2
"RTN","ORCMED",41,0)
 . I X="C" W !?10,"... order cancelled.",! Q
"RTN","ORCMED",42,0)
 . I X="P" D
"RTN","ORCMED",43,0)
 . . D EN^ORCSAVE W !?10,$S(ORIFN:"... order placed.",1:"ERROR"),!
"RTN","ORCMED",44,0)
 . . S:$G(ORIFN) ^TMP("ORNEW",$J,ORIFN,1)=""
"RTN","ORCMED",45,0)
 . . I '$D(^TMP("ORECALL",$J,ORDIALOG)) M ^(ORDIALOG)=ORDIALOG M:$D(^TMP("ORWORD",$J)) ^TMP("ORECALL",$J,ORDIALOG)=^TMP("ORWORD",$J) ;save 1st values
"RTN","ORCMED",46,0)
XFQ D EXIT^ORCDPS1 ;X:$D(^ORD(101.41,ORDIALOG,4)) ^(4)
"RTN","ORCMED",47,0)
 K ^TMP("ORWORD",$J),^TMP("ORSIG",$J)
"RTN","ORCMED",48,0)
 D:'$D(^TMP("ORNEW",$J)) UNLOCK^ORX2(+ORVP) ;unlock if no new orders
"RTN","ORCMED",49,0)
 Q
"RTN","ORCMED",50,0)
 ;
"RTN","ORCMED",51,0)
IN ; -- Kill extra values, Reset ID's/DD from Inpt dialog
"RTN","ORCMED",52,0)
 N ORD1,ORDLI,ORDFIN,ORDCNT,ORDORIG,ORDORIGF,P,ORDD
"RTN","ORCMED",53,0)
 F P="START DATE/TIME","NOW" K ORDIALOG($$PTR(P),1)
"RTN","ORCMED",54,0)
 S ORD1=$P($G(ORDIALOG($$PTR("DOSE"),1)),"&",5)
"RTN","ORCMED",55,0)
 S ORDORIG=ORDIALOG($$PTR("INSTRUCTIONS"),1)
"RTN","ORCMED",56,0)
 S ORDD=$G(ORDIALOG($$PTR("DISPENSE DRUG"),1))
"RTN","ORCMED",57,0)
 D DOSES("O")
"RTN","ORCMED",58,0)
 S ORDFIN="",ORDCNT=0,ORDORIGF=0
"RTN","ORCMED",59,0)
 ;look in the new instructions list for the original inpatient instructions and the dose
"RTN","ORCMED",60,0)
 I $L(ORD1) D
"RTN","ORCMED",61,0)
 .S ORDLI=0 F  S ORDLI=$O(ORDIALOG($$PTR("INSTRUCTIONS"),"LIST",ORDLI)) Q:'ORDLI  D
"RTN","ORCMED",62,0)
 ..I $P(ORDIALOG($$PTR("INSTRUCTIONS"),"LIST",ORDLI),U)[ORD1 S ORDFIN=$P(ORDIALOG($$PTR("INSTRUCTIONS"),"LIST",ORDLI),U),ORDCNT=ORDCNT+1
"RTN","ORCMED",63,0)
 ..I $P(ORDIALOG($$PTR("INSTRUCTIONS"),"LIST",ORDLI),U)=ORDORIG S ORDORIGF=1
"RTN","ORCMED",64,0)
 .;look in the returned doses for the local possible dose
"RTN","ORCMED",65,0)
 I '$L(ORD1) D
"RTN","ORCMED",66,0)
 .S ORDOSE=0 F  S ORDOSE=$O(ORDOSE(ORDOSE)) Q:'ORDOSE  D
"RTN","ORCMED",67,0)
 ..I $P(ORDOSE(ORDOSE),U,5)=ORDORIG,($P(ORDOSE(ORDOSE),U,6)=ORDD) S ORDFIN=$P(ORDIALOG(INSTR,"LIST",ORDOSE),U),ORDCNT=ORDCNT+1
"RTN","ORCMED",68,0)
 ;If original instructions was not in the new instructions list then replace the instructions
"RTN","ORCMED",69,0)
 I ORDORIGF=0 D
"RTN","ORCMED",70,0)
 .I ORDCNT=1 S ORDIALOG($$PTR("INSTRUCTIONS"),1)=ORDFIN ;only one item in the list found containing the dose string - set the instructions to the item found
"RTN","ORCMED",71,0)
 .I ORDCNT=0 S ORDIALOG($$PTR("INSTRUCTIONS"),1)="" ;no items in the list found containing the dose string - blank the instructions
"RTN","ORCMED",72,0)
 .I ORDCNT>1 S ORDIALOG($$PTR("INSTRUCTIONS"),1)="" ;more than one item in the list found containing the dose string - blank the instructions
"RTN","ORCMED",73,0)
 Q
"RTN","ORCMED",74,0)
 ;
"RTN","ORCMED",75,0)
OUT ; -- Kill extra values, Reset ID's/DD from Outpt dialog
"RTN","ORCMED",76,0)
 N ORD1,ORDLI,ORDFIN,ORDCNT,ORDORIG,ORDORIGF,INSTR,I,ORDD
"RTN","ORCMED",77,0)
 S ORDD=$G(ORDIALOG($$PTR("DISPENSE DRUG"),1))
"RTN","ORCMED",78,0)
 D DOSES("I")
"RTN","ORCMED",79,0)
 S INSTR=$$PTR("INSTRUCTIONS"),I=0 F  S I=$O(ORDIALOG(INSTR,I)) Q:'I  D
"RTN","ORCMED",80,0)
 .S ORD1=$P($G(ORDIALOG($$PTR("DOSE"),I)),"&",5)
"RTN","ORCMED",81,0)
 .S ORDORIG=ORDIALOG(INSTR,I)
"RTN","ORCMED",82,0)
 .N P I '$O(ORDIALOG(INSTR,0)) D  ;old sig in comments
"RTN","ORCMED",83,0)
 .. N WP S WP=$$PTR("WORD PROCESSING 1") K ^TMP("ORSIG",$J)
"RTN","ORCMED",84,0)
 .. M ^TMP("ORSIG",$J)=^TMP("ORWORD",$J,WP,1)
"RTN","ORCMED",85,0)
 .. K ORDIALOG(WP,1),^TMP("ORWORD",$J,WP,1)
"RTN","ORCMED",86,0)
 .F P="PATIENT INSTRUCTIONS","START DATE/TIME","DAYS SUPPLY","QUANTITY","REFILLS","ROUTING","SERVICE CONNECTED" K ORDIALOG($$PTR(P),I)
"RTN","ORCMED",87,0)
 .I $G(ORDIALOG($$PTR("URGENCY"),I))=99 K ORDIALOG($$PTR("URGENCY"),I)
"RTN","ORCMED",88,0)
 .S ORDFIN="",ORDCNT=0,ORDORIGF=0
"RTN","ORCMED",89,0)
 .;look in the new instructions list for the original instructions and the possible dose
"RTN","ORCMED",90,0)
 .I $L(ORD1) D
"RTN","ORCMED",91,0)
 ..S ORDLI=0 F  S ORDLI=$O(ORDIALOG(INSTR,"LIST",ORDLI)) Q:'ORDLI  D
"RTN","ORCMED",92,0)
 ...I $P(ORDIALOG(INSTR,"LIST",ORDLI),U)[ORD1 S ORDFIN=$P(ORDIALOG(INSTR,"LIST",ORDLI),U),ORDCNT=ORDCNT+1
"RTN","ORCMED",93,0)
 ...I $P(ORDIALOG(INSTR,"LIST",ORDLI),U)=ORDORIG S ORDORIGF=1
"RTN","ORCMED",94,0)
 .;look in the returned doses for the local possible dose
"RTN","ORCMED",95,0)
 .I '$L(ORD1) D
"RTN","ORCMED",96,0)
 ..S ORDOSE=0 F  S ORDOSE=$O(ORDOSE(ORDOSE)) Q:'ORDOSE  D
"RTN","ORCMED",97,0)
 ...I $P(ORDOSE(ORDOSE),U,5)=ORDORIG,($P(ORDOSE(ORDOSE),U,6)=ORDD) S ORDFIN=$P(ORDIALOG(INSTR,"LIST",ORDOSE),U),ORDCNT=ORDCNT+1
"RTN","ORCMED",98,0)
 .;If original instructions was not in the new instructions list then replace the instructions
"RTN","ORCMED",99,0)
 .I ORDORIGF=0 D
"RTN","ORCMED",100,0)
 ..I ORDCNT=1 S ORDIALOG(INSTR,I)=ORDFIN ;only one item in the list found containing the dose string - set the instructions to the item found
"RTN","ORCMED",101,0)
 ..I ORDCNT=0 S ORDIALOG(INSTR,I)="" ;no items in the list found containing the dose string - blank the instructions
"RTN","ORCMED",102,0)
 ..I ORDCNT>1 S ORDIALOG(INSTR,I)="" ;more than one item in the list found containing the dose string - blank the instructions
"RTN","ORCMED",103,0)
 Q
"RTN","ORCMED",104,0)
 ;
"RTN","ORCMED",105,0)
DOSES(TYPE)     ; -- Convert doses to new TYPE, reset ID strings
"RTN","ORCMED",106,0)
 N PSOI,ORMED,PROMPT,DOSE,DRUG,I,X,DD,DRUG0,STR
"RTN","ORCMED",107,0)
 F I="DISPENSE DRUG","STRENGTH","DRUG NAME","SIG" K ORDIALOG($$PTR(I),1)
"RTN","ORCMED",108,0)
 S PSOI=+$P($G(^ORD(101.43,+$G(ORDIALOG($$PTR("ORDERABLE ITEM"),1)),0)),U,2),ORMED=$P($G(^(0)),U)
"RTN","ORCMED",109,0)
 D DOSE^PSSORUTL(.ORDOSE,PSOI,TYPE,+ORVP) I $G(ORDOSE(1))=-1 K ORDOSE
"RTN","ORCMED",110,0)
 S PROMPT=$$PTR("INSTRUCTIONS"),DOSE=$$PTR("DOSE")
"RTN","ORCMED",111,0)
 S DRUG=$$PTR("DISPENSE DRUG") D D1^ORCDPS2
"RTN","ORCMED",112,0)
 S I=0 F  S I=$O(ORDIALOG(PROMPT,I)) Q:I'>0  D
"RTN","ORCMED",113,0)
 . K ORDIALOG(DOSE,I) S X=$G(ORDIALOG(PROMPT,I)) Q:'$L(X)
"RTN","ORCMED",114,0)
 . S X=$$UP^XLFSTR(X),DD=+$G(ORDIALOG(PROMPT,"LIST","D",X)) Q:'DD
"RTN","ORCMED",115,0)
 . S ORDIALOG(DOSE,I)=$TR($G(ORDOSE("DD",DD,X)),"^","&")
"RTN","ORCMED",116,0)
 . S ORDIALOG(DRUG,I)=DD,DRUG0=$G(ORDOSE("DD",DD))
"RTN","ORCMED",117,0)
 . S STR=$P(DRUG0,U,5)_$P(DRUG0,U,6)
"RTN","ORCMED",118,0)
 . I STR'>0 S:'$G(ORDOSE(1)) ORDIALOG($$PTR("DRUG NAME"),1)=$P(DRUG0,U) Q
"RTN","ORCMED",119,0)
 . I ORMED'[STR,TYPE="O"!'$G(ORDOSE(1)) S ORDIALOG($$PTR("STRENGTH"),1)=STR
"RTN","ORCMED",120,0)
 Q
"RTN","ORCMED",121,0)
 ;
"RTN","ORCMED",122,0)
CONT() ; -- Want to continue processing orders?
"RTN","ORCMED",123,0)
 N X,Y,DIR
"RTN","ORCMED",124,0)
 S DIR(0)="YA",DIR("A")="Do you want to continue transferring orders? ",DIR("B")="YES"
"RTN","ORCMED",125,0)
 S DIR("?")="Enter YES to continue transferring the remaining orders selected, or NO to quit this option."
"RTN","ORCMED",126,0)
 D ^DIR
"RTN","ORCMED",127,0)
 Q +Y
"RTN","ORCMED",128,0)
 ;
"RTN","ORCMED",129,0)
SHOWSIG ; -- Show old sig for transfer in ^TMP("ORSIG",$J)
"RTN","ORCMED",130,0)
 N ORTX,I,X,ORMAX S ORMAX=72
"RTN","ORCMED",131,0)
 S I=0 F  S I=$O(^TMP("ORSIG",$J,I)) Q:I'>0  S X=$G(^(I,0)) D:$L(X) TXT^ORCHTAB
"RTN","ORCMED",132,0)
 S I=0 F  S I=$O(ORTX(I)) Q:I'>0  W !,$S(I=1:"(Sig: ",1:"      ")_ORTX(I)
"RTN","ORCMED",133,0)
 W ")"
"RTN","ORCMED",134,0)
 Q
"RTN","ORCMED",135,0)
 ;
"RTN","ORCMED",136,0)
PTR(NAME) ; -- Returns pointer to OR GTX NAME
"RTN","ORCMED",137,0)
 Q +$O(^ORD(101.41,"AB",$E("OR GTX "_NAME,1,63),0))
"RTN","ORCMED",138,0)
 ;
"RTN","ORCMED",139,0)
REFILLS ; -- Request a refill for med orders
"RTN","ORCMED",140,0)
 ;    ORNMBR = #,#,...,# of selected orders
"RTN","ORCMED",141,0)
 ;
"RTN","ORCMED",142,0)
 N ORLK,ORI,NMBR,IDX,ORIFN,ORDITM,ORERR,ORQUIT,OROUT
"RTN","ORCMED",143,0)
 I '$G(ORNMBR) S ORNMBR=$$ORDERS^ORCHART("") G:'ORNMBR RFQ
"RTN","ORCMED",144,0)
 D FREEZE^ORCMENU S VALMBCK="R"
"RTN","ORCMED",145,0)
 S ORNP=$$PROVIDER^ORCMENU1 G:ORNP="^" RFQ
"RTN","ORCMED",146,0)
 S:'$G(ORL) ORL=$$LOCATION^ORCMENU1 G:ORL="^" RFQ
"RTN","ORCMED",147,0)
 S OROUT=$$ROUTING G:OROUT="^" RFQ
"RTN","ORCMED",148,0)
 F ORI=1:1:$L(ORNMBR,",") S NMBR=$P(ORNMBR,",",ORI) D:NMBR  Q:$D(ORQUIT)
"RTN","ORCMED",149,0)
 . S IDX=$G(^TMP("OR",$J,"CURRENT","IDX",NMBR)),ORIFN=+$P(IDX,U,4)
"RTN","ORCMED",150,0)
 . Q:'ORIFN  I '$D(^OR(100,ORIFN,0)) W !,"Invalid order number!" H 2 Q
"RTN","ORCMED",151,0)
 . S ORDITM=$$ORDITEM^ORCACT(ORIFN) D SUBHDR^ORCACT(ORDITM)
"RTN","ORCMED",152,0)
 . I '$$VALID^ORCACT0(ORIFN,"RF",.ORERR) W !,ORERR H 2 Q
"RTN","ORCMED",153,0)
 . S ORLK=$$LOCK1^ORX2(+ORIFN) I 'ORLK W !,$P(ORLK,U,2) H 2 Q
"RTN","ORCMED",154,0)
 . D REF^ORMBLDPS(ORIFN,OROUT),UNLK1^ORX2(+ORIFN)
"RTN","ORCMED",155,0)
 . W !?10,"... refill requested.",$$RETURN
"RTN","ORCMED",156,0)
RFQ Q
"RTN","ORCMED",157,0)
 ;
"RTN","ORCMED",158,0)
RETURN() ; -- press return to cont
"RTN","ORCMED",159,0)
 N X W !,"Press <return> to continue ..." R X:DTIME
"RTN","ORCMED",160,0)
 Q ""
"RTN","ORCMED",161,0)
 ;
"RTN","ORCMED",162,0)
ROUTING() ; -- Routing for refill
"RTN","ORCMED",163,0)
 N X,Y,DIR S DIR(0)="SAM^W:WINDOW;M:MAIL;C:ADMINISTERED IN CLINIC;"
"RTN","ORCMED",164,0)
 S DIR("A")="Routing: ",DIR("B")=$S($D(^PSX(550,"C")):"MAIL",1:"WINDOW")
"RTN","ORCMED",165,0)
 S DIR("?")="Select how the patient is to receive this refill, by mail or at the window or in the clinic"
"RTN","ORCMED",166,0)
 D ^DIR S:$D(DTOUT)!(X["^") Y="^"
"RTN","ORCMED",167,0)
 Q Y
"RTN","ORCMED",168,0)
 ;
"RTN","ORCMED",169,0)
NW ; -- Order New Medication from Meds tab
"RTN","ORCMED",170,0)
 ;    Requires ORDIALOG      = name of pkg dialog
"RTN","ORCMED",171,0)
 ;             OREVENT       = event, if delaying orders
"RTN","ORCMED",172,0)
 ;             OREVENT("TS") = treating spec, if admission or transfer
"RTN","ORCMED",173,0)
 N ORPTLK G:'$L($G(ORDIALOG)) NWQ
"RTN","ORCMED",174,0)
 S ORPTLK=$$LOCK^ORX2(+ORVP) I 'ORPTLK W !!,$C(7),$P(ORPTLK,U,2) H 2 Q
"RTN","ORCMED",175,0)
 D FREEZE^ORCMENU S VALMBCK="R"
"RTN","ORCMED",176,0)
 S ORNP=$$PROVIDER^ORCMENU1 G:ORNP="^" NWQ
"RTN","ORCMED",177,0)
 I '$G(ORL) S ORL=$S($G(OREVENT):$$LOC^OREVNTX(OREVENT),1:$$LOCATION^ORCMENU1) G:ORL["^" NWQ
"RTN","ORCMED",178,0)
 S ORDIALOG=$O(^ORD(101.41,"AB",$E(ORDIALOG,1,63),0)) G:'ORDIALOG NWQ
"RTN","ORCMED",179,0)
 D ADD^ORCDLG,REBLD^ORCMENU:$D(^TMP("ORNEW",$J))
"RTN","ORCMED",180,0)
 K ORDIALOG,^TMP("ORWORD",$J),^TMP("ORECALL",$J) S VALMBCK="R"
"RTN","ORCMED",181,0)
NWQ D:'$D(^TMP("ORNEW",$J)) UNLOCK^ORX2(+ORVP) ;unlock if no new orders
"RTN","ORCMED",182,0)
 Q
"RTN","ORDSGCHK")
0^7^B109034124
"RTN","ORDSGCHK",1,0)
ORDSGCHK ; SLC/AGP - PRE 0.5 DOSE ORDER CHECKS;04/03/13  09:01
"RTN","ORDSGCHK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**280,352,345,311**;Dec 17, 1997;Build 30
"RTN","ORDSGCHK",3,0)
 ;
"RTN","ORDSGCHK",4,0)
EN(ORY,DFN,TYPE,OIL) ;
"RTN","ORDSGCHK",5,0)
 N ARRAY,CNT,NAME
"RTN","ORDSGCHK",6,0)
 ;if renewed order build OIL array
"RTN","ORDSGCHK",7,0)
 I $G(ORREN)=1,+$G(ORIFN)>0 D
"RTN","ORDSGCHK",8,0)
 .;IV orders should only have a null type
"RTN","ORDSGCHK",9,0)
 .I TYPE="" S TYPE="PSIV"
"RTN","ORDSGCHK",10,0)
 .D BLDREN(TYPE,ORIFN,.OIL)
"RTN","ORDSGCHK",11,0)
 ;Build easy array to work with
"RTN","ORDSGCHK",12,0)
 S CNT=0 F  S CNT=$O(OIL(CNT)) Q:CNT'>0  D
"RTN","ORDSGCHK",13,0)
 .S NODE=$G(OIL(CNT)) Q:$P(NODE,U,2)="PSIV"
"RTN","ORDSGCHK",14,0)
 .S NAME=$P(NODE,U,2)
"RTN","ORDSGCHK",15,0)
 .Q:'$P(NODE,U,3)
"RTN","ORDSGCHK",16,0)
 .S ARRAY(NAME,$P(NODE,U,3))=NODE
"RTN","ORDSGCHK",17,0)
 I TYPE="PSH" Q
"RTN","ORDSGCHK",18,0)
 I TYPE="PSIV" D IV(.ORY,DFN,.ARRAY)
"RTN","ORDSGCHK",19,0)
 I TYPE'="PSIV" D NONIV(.ORY,DFN,.ARRAY)
"RTN","ORDSGCHK",20,0)
 Q
"RTN","ORDSGCHK",21,0)
 ;
"RTN","ORDSGCHK",22,0)
BLDREN(TYPE,ORIFN,OUT) ;
"RTN","ORDSGCHK",23,0)
 N CNT,EXTVALUE,ISOI,ITEM,LOC,NAME,NUM,NODE,ORDIALOG,TEXT,VALUE,X0
"RTN","ORDSGCHK",24,0)
 S CNT=$O(OUT(""),-1)
"RTN","ORDSGCHK",25,0)
 S X0=$G(^OR(100,+ORIFN,0))
"RTN","ORDSGCHK",26,0)
 S ORDIALOG=+$P(X0,U,5)
"RTN","ORDSGCHK",27,0)
 D GETDLG^ORCD(ORDIALOG)
"RTN","ORDSGCHK",28,0)
 D GETORDER^ORCD(+ORIFN)
"RTN","ORDSGCHK",29,0)
 S LOC=0 F  S LOC=$O(ORDIALOG(LOC)) Q:LOC'>0  D
"RTN","ORDSGCHK",30,0)
 .S ITEM=$P($G(ORDIALOG(LOC)),U,2)
"RTN","ORDSGCHK",31,0)
 .I ITEM="" Q
"RTN","ORDSGCHK",32,0)
 .I ITEM="COMMENT" Q
"RTN","ORDSGCHK",33,0)
 .S ISOI=$S($G(ORDIALOG(LOC,0))[101.43:1,1:0)
"RTN","ORDSGCHK",34,0)
 .S NUM=0 F  S NUM=$O(ORDIALOG(LOC,NUM)) Q:NUM'>0  D
"RTN","ORDSGCHK",35,0)
 ..I NUM<1 Q
"RTN","ORDSGCHK",36,0)
 ..S VALUE=$G(ORDIALOG(LOC,NUM)),EXTVALUE=""
"RTN","ORDSGCHK",37,0)
 ..I ISOI=1 D
"RTN","ORDSGCHK",38,0)
 ...S EXTVALUE=$P($G(^ORD(101.43,VALUE,0)),U)
"RTN","ORDSGCHK",39,0)
 ...I $P($G(^ORD(101.41,LOC,0)),U)="OR GTX ADDITIVE" S ITEM="ADDITIVE"
"RTN","ORDSGCHK",40,0)
 ..I ITEM="RATE" S EXTVALUE=VALUE
"RTN","ORDSGCHK",41,0)
 ..S TEXT=TYPE_U_ITEM_U_NUM_U_VALUE_U_EXTVALUE
"RTN","ORDSGCHK",42,0)
 ..S CNT=CNT+1,OUT(CNT)=TEXT
"RTN","ORDSGCHK",43,0)
 Q
"RTN","ORDSGCHK",44,0)
 ;
"RTN","ORDSGCHK",45,0)
DURATION(STR) ;
"RTN","ORDSGCHK",46,0)
 N LEN,VAL,UNIT,IVLMT,TVAL
"RTN","ORDSGCHK",47,0)
 S (UNIT,IVLMT)="",VAL=0
"RTN","ORDSGCHK",48,0)
 I $E($$LOW^XLFSTR(STR))="f" D
"RTN","ORDSGCHK",49,0)
 . I STR["for a total of" D  Q
"RTN","ORDSGCHK",50,0)
 . .S VAL=$P(STR," ",5)
"RTN","ORDSGCHK",51,0)
 . .S UNIT=$P(STR," ",6)
"RTN","ORDSGCHK",52,0)
 . .S STR=""
"RTN","ORDSGCHK",53,0)
 . S VAL=$P(STR," ",2)
"RTN","ORDSGCHK",54,0)
 . S UNIT=$E($P(STR," ",3))
"RTN","ORDSGCHK",55,0)
 . S STR=""
"RTN","ORDSGCHK",56,0)
 I $E($$LOW^XLFSTR(STR))="w" D
"RTN","ORDSGCHK",57,0)
 . S TVAL=$P(STR," ",4)
"RTN","ORDSGCHK",58,0)
 . S VAL=+TVAL
"RTN","ORDSGCHK",59,0)
 . S LEN=$F(TVAL,VAL)
"RTN","ORDSGCHK",60,0)
 . I $P(VAL,".")="" S VAL=0_VAL
"RTN","ORDSGCHK",61,0)
 . F  S UNIT=$E(TVAL,LEN) Q:((UNIT'=0)&(UNIT'="."))  D
"RTN","ORDSGCHK",62,0)
 . . S LEN=LEN+1
"RTN","ORDSGCHK",63,0)
 . S STR=""
"RTN","ORDSGCHK",64,0)
 I $L(UNIT),$L(VAL) S IVLMT=VAL_$$UP^XLFSTR(UNIT)
"RTN","ORDSGCHK",65,0)
 I STR'="",IVLMT="" D
"RTN","ORDSGCHK",66,0)
 .I STR["ML" S IVLMT=$P(STR,"M")_"M" Q
"RTN","ORDSGCHK",67,0)
 .I STR["CC" S IVLMT=$P(STR,"C")_"M" Q
"RTN","ORDSGCHK",68,0)
 .S IVLMT=STR
"RTN","ORDSGCHK",69,0)
 Q IVLMT
"RTN","ORDSGCHK",70,0)
 ;
"RTN","ORDSGCHK",71,0)
IV(ORY,DFN,ARRAY) ;
"RTN","ORDSGCHK",72,0)
 N CNT,DRUG,DRUGIEN,DRUGNAME,NAME,NUM,OI,ORBASE,ORPSJARR,STR,STRENGTH
"RTN","ORDSGCHK",73,0)
 ;
"RTN","ORDSGCHK",74,0)
 ;populate single values from order
"RTN","ORDSGCHK",75,0)
 S ORPSJARR("TVOL_DUR")="",ORPSJARR("SCHEDULE")=""
"RTN","ORDSGCHK",76,0)
 I $D(ARRAY("DAYS")) S ORPSJARR("TVOL_DUR")=$$DURATION($P(ARRAY("DAYS",1),U,4))
"RTN","ORDSGCHK",77,0)
 ;S RATE=$P(ARRAY(NAME,1),U,4)
"RTN","ORDSGCHK",78,0)
 S ORPSJARR("MR_IEN")=$P(ARRAY("ROUTE",1),U,4)
"RTN","ORDSGCHK",79,0)
 I $D(ARRAY("SCHEDULE")) S ORPSJARR("SCHEDULE")=$P(ARRAY("SCHEDULE",1),U,4)
"RTN","ORDSGCHK",80,0)
 S ORPSJARR("IV_TYPE")=$S($P(ARRAY("TYPE",1),U,4)="I":1,1:2)
"RTN","ORDSGCHK",81,0)
 I ORPSJARR("IV_TYPE")=2 S ORPSJARR("INF_RATE")=$P(ARRAY("RATE",1),U,5)
"RTN","ORDSGCHK",82,0)
 ;
"RTN","ORDSGCHK",83,0)
 ;build additive first, Drug, Strength/unit, bag
"RTN","ORDSGCHK",84,0)
 F NAME="ADDITIVE","ORDERABLE" D
"RTN","ORDSGCHK",85,0)
 .K DRUG
"RTN","ORDSGCHK",86,0)
 .S CNT=0,NUM=0
"RTN","ORDSGCHK",87,0)
 .F  S NUM=$O(ARRAY(NAME,NUM)) Q:NUM'>0  D
"RTN","ORDSGCHK",88,0)
 ..S CNT=CNT+1
"RTN","ORDSGCHK",89,0)
 ..S NODE=$G(ARRAY(NAME,NUM)),OI=$P(NODE,U,4)
"RTN","ORDSGCHK",90,0)
 ..;
"RTN","ORDSGCHK",91,0)
 ..S DRUGIEN=+$P(^ORD(101.43,OI,0),U,2) I DRUGIEN="" Q  ;PHARMACY OI FROM 101.43
"RTN","ORDSGCHK",92,0)
 ..S DRUGNAME=$P($G(ARRAY(NAME,NUM)),U,5) ;OI NAME
"RTN","ORDSGCHK",93,0)
 ..;
"RTN","ORDSGCHK",94,0)
 ..I NAME="ADDITIVE" D  Q
"RTN","ORDSGCHK",95,0)
 ...S STRENGTH=$P($G(ARRAY("STRENGTH",NUM)),U,4)_" "_$P($G(ARRAY("UNITS",NUM)),U,4)
"RTN","ORDSGCHK",96,0)
 ...S STR=+DRUGIEN_U_DRUGNAME_U_STRENGTH_U_$P($G(ARRAY("ADDFREQ",NUM)),U,4)
"RTN","ORDSGCHK",97,0)
 ...S ORPSJARR("AD",CNT)=STR_U_0
"RTN","ORDSGCHK",98,0)
 ...;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",99,0)
 ...I $G(^TMP($J,"ORENHCHK"))=1 S ORPSJARR("AD",CNT)=STR_U_1
"RTN","ORDSGCHK",100,0)
 ..;
"RTN","ORDSGCHK",101,0)
 ..;Soltution information
"RTN","ORDSGCHK",102,0)
 ..S STR=+DRUGIEN_U_DRUGNAME_U_$P($G(ARRAY("VOLUME",NUM)),U,4)_" ML"
"RTN","ORDSGCHK",103,0)
 ..S ORPSJARR("SOL",CNT)=STR,$P(ORPSJARR("SOL",CNT),U,5)=0
"RTN","ORDSGCHK",104,0)
 ..;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",105,0)
 ..I $G(^TMP($J,"ORENHCHK"))=1 S ORPSJARR("SOL",CNT)=STR,$P(ORPSJARR("SOL",CNT),U,5)=1
"RTN","ORDSGCHK",106,0)
 ;
"RTN","ORDSGCHK",107,0)
 I $D(^TMP($J,"ORDSGCHK_CACHE")) M ^TMP($J,"ORDSGCHK2")=^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORDSGCHK",108,0)
 I '$D(^TMP($J,"ORDSGCHK_CACHE")) D
"RTN","ORDSGCHK",109,0)
 .S ORBASE(1)="ORDSGCHK1"
"RTN","ORDSGCHK",110,0)
 .S ORBASE(2)="ORDSGCHK2"
"RTN","ORDSGCHK",111,0)
 .D DOSE^PSJAPIDS(.ORBASE,DFN,.ORPSJARR)
"RTN","ORDSGCHK",112,0)
 .M ^TMP($J,"ORDSGCHK_CACHE")=^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",113,0)
 D PARSEOUT
"RTN","ORDSGCHK",114,0)
 K ^TMP($J,"ORDSGCHK1"),^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",115,0)
 Q
"RTN","ORDSGCHK",116,0)
 ;
"RTN","ORDSGCHK",117,0)
NONIV(ORY,DFN,ARRAY) ;
"RTN","ORDSGCHK",118,0)
 N CNT,DOSESTR,DRUG,DRUGARR,DRUGIEN,DRUGNAME,DUR,NAME,NODE
"RTN","ORDSGCHK",119,0)
 N OIIEN,ORBASE,ORDRUG,ORPSARR,PACK,PSNODE,SUB,TYPE,USAGE
"RTN","ORDSGCHK",120,0)
 ;
"RTN","ORDSGCHK",121,0)
 ;assume same drug type used throughout the order dialog
"RTN","ORDSGCHK",122,0)
 ;free text dose do not have a drug.
"RTN","ORDSGCHK",123,0)
 S DRUGIEN=$P($G(ARRAY("DRUG",1)),U,4)
"RTN","ORDSGCHK",124,0)
 I +DRUGIEN>0,$$EXMT^PSSDSAPI(DRUGIEN)=1 Q
"RTN","ORDSGCHK",125,0)
 ;if no ARRAY(DOSE) node set it to null to force free text evaluation
"RTN","ORDSGCHK",126,0)
 ;I '$D(ARRAY("DOSE")),$D(ARRAY("INSTR")) N I S I=0 F  S I=$O(ARRAY("INSTR",I)) Q:'I  S ARRAY("DOSE",I)=$P(ARRAY("INSTR",I),U)_"^DOSE^"_I_"^"
"RTN","ORDSGCHK",127,0)
 N I S I=0 F  S I=$O(ARRAY("INSTR",I)) Q:'I  I '$D(ARRAY("DOSE",I))  S ARRAY("DOSE",I)=$P(ARRAY("INSTR",I),U)_"^DOSE^"_I_"^"
"RTN","ORDSGCHK",128,0)
 ;
"RTN","ORDSGCHK",129,0)
 S NAME="" F  S NAME=$O(ARRAY(NAME)) Q:NAME=""  D
"RTN","ORDSGCHK",130,0)
 .S SUB=$$GETSUB(NAME) I SUB="" Q
"RTN","ORDSGCHK",131,0)
 .S CNT=0 F  S CNT=$O(ARRAY(NAME,CNT)) Q:CNT'>0  D
"RTN","ORDSGCHK",132,0)
 ..S NODE=$G(ARRAY(NAME,CNT))
"RTN","ORDSGCHK",133,0)
 ..;
"RTN","ORDSGCHK",134,0)
 ..;get dose information and drug information from Dose Prompt
"RTN","ORDSGCHK",135,0)
 ..I SUB="DOSE" D
"RTN","ORDSGCHK",136,0)
 ...S PACK=$P(NODE,U)
"RTN","ORDSGCHK",137,0)
 ...S TYPE=$S($P(NODE,U)="PSO":"O",1:"I")
"RTN","ORDSGCHK",138,0)
 ...S DOSESTR=$P(NODE,U,4)
"RTN","ORDSGCHK",139,0)
 ...;free text dose
"RTN","ORDSGCHK",140,0)
 ...I DOSESTR="" D
"RTN","ORDSGCHK",141,0)
 ....S ARRAY("ORPSA",CNT)=$$OI2DD^ORKPS($P(ARRAY("ORDERABLE",1),U,4),$E($P(ARRAY("ORDERABLE",1),U,1),3),2)
"RTN","ORDSGCHK",142,0)
 ....Q:'$P(ARRAY("ORPSA",CNT),";",1)
"RTN","ORDSGCHK",143,0)
 ....N ORQUIT S ORQUIT=0
"RTN","ORDSGCHK",144,0)
 ....I $L($G(^OR(100,+ORIFN,4)))>0 D
"RTN","ORDSGCHK",145,0)
 .....N PSIFN S PSIFN=$G(^OR(100,+ORIFN,4))
"RTN","ORDSGCHK",146,0)
 .....S:TYPE="O" PSIFN=$TR(PSIFN,"S","P")_$S(PSIFN?1.N:"R",1:"")
"RTN","ORDSGCHK",147,0)
 .....K ^TMP("PS",$J)
"RTN","ORDSGCHK",148,0)
 .....D OEL^PSOORRL(DFN,PSIFN_";"_TYPE)  ;DBIA 2400
"RTN","ORDSGCHK",149,0)
 .....I '$D(^TMP("PS",$J)) Q
"RTN","ORDSGCHK",150,0)
 .....S ORPSARR(CNT,"DO")=$P($G(ARRAY("INSTR",CNT)),U,4)
"RTN","ORDSGCHK",151,0)
 .....S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",152,0)
 .....S ORDRUG(CNT,"DRUG_IEN")=+$G(^TMP("PS",$J,"DD",1,0))
"RTN","ORDSGCHK",153,0)
 .....S ORDRUG(CNT,"DRUG_NM")=$P($G(^TMP("PS",$J,0)),U)
"RTN","ORDSGCHK",154,0)
 .....S ORQUIT=1
"RTN","ORDSGCHK",155,0)
 .....K ^TMP("PS",$J)
"RTN","ORDSGCHK",156,0)
 ....I ORQUIT=1 Q
"RTN","ORDSGCHK",157,0)
 ....S ORPSARR(CNT,"DO")=$P($G(ARRAY("INSTR",CNT)),U,4)
"RTN","ORDSGCHK",158,0)
 ....S ORDRUG(CNT,"DRUG_NM")=$$TRIM^ORBCMA32($P($G(ARRAY("ORDERABLE",1)),U,5))
"RTN","ORDSGCHK",159,0)
 ....S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",160,0)
 ....S OIIEN=$P($G(ARRAY("ORDERABLE",1)),U,4) ;orderable only exists for first item (in complex order)
"RTN","ORDSGCHK",161,0)
 ....S ORDRUG("OI")=+$P($G(^ORD(101.43,OIIEN,0)),U,2)
"RTN","ORDSGCHK",162,0)
 ....S ORDRUG("PACKAGE")=$S(PACK="PSO":"O",PACK="PSH":"X",1:"I")
"RTN","ORDSGCHK",163,0)
 ....S PSNODE=$G(^ORD(101.43,OIIEN,"PS")),USAGE=""
"RTN","ORDSGCHK",164,0)
 ....I $P(PSNODE,U,4)=1 S USAGE=USAGE_"A"
"RTN","ORDSGCHK",165,0)
 ....I $P(PSNODE,U,3)=1 S USAGE=USAGE_"B"
"RTN","ORDSGCHK",166,0)
 ....S ORDRUG("OI_USAGE")=USAGE
"RTN","ORDSGCHK",167,0)
 ...;
"RTN","ORDSGCHK",168,0)
 ...;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",169,0)
 ...I $G(^TMP($J,"ORENHCHK"))=1,((DOSESTR=""&$D(ORDRUG))!(DOSESTR'="")) S ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",170,0)
 ...Q:DOSESTR=""
"RTN","ORDSGCHK",171,0)
 ...S DRUGIEN=$P(DOSESTR,"&",6)
"RTN","ORDSGCHK",172,0)
 ...K ^TMP($J,"DRUGARR")
"RTN","ORDSGCHK",173,0)
 ...D ZERO^PSS50(DRUGIEN,,,,,"DRUGARR")
"RTN","ORDSGCHK",174,0)
 ...S DRUGNAME=$G(^TMP($J,"DRUGARR",DRUGIEN,.01))
"RTN","ORDSGCHK",175,0)
 ...K ^TMP($J,"DRUGARR")
"RTN","ORDSGCHK",176,0)
 ...;
"RTN","ORDSGCHK",177,0)
 ...;Local Possible Dose
"RTN","ORDSGCHK",178,0)
 ...I $P(DOSESTR,"&")="" D  Q
"RTN","ORDSGCHK",179,0)
 ....S ORPSARR(CNT,"DO")=$P($G(ARRAY("INSTR",CNT)),U,4)
"RTN","ORDSGCHK",180,0)
 ....S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",181,0)
 ....S ORDRUG(CNT,"DRUG_IEN")=DRUGIEN
"RTN","ORDSGCHK",182,0)
 ....S ORDRUG(CNT,"DRUG_NM")=$$GETPSNM^ORKPS(DRUGIEN) ;DRUGNAME
"RTN","ORDSGCHK",183,0)
 ...;
"RTN","ORDSGCHK",184,0)
 ...;Possible Dose
"RTN","ORDSGCHK",185,0)
 ...S ORPSARR(CNT,"DRG_AMT")=$P(DOSESTR,"&")
"RTN","ORDSGCHK",186,0)
 ...S ORPSARR(CNT,"DRG_UNIT")=$P(DOSESTR,"&",2)
"RTN","ORDSGCHK",187,0)
 ...S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",188,0)
 ...S ORDRUG(CNT,"DRUG_IEN")=DRUGIEN
"RTN","ORDSGCHK",189,0)
 ...S ORDRUG(CNT,"DRUG_NM")=$$GETPSNM^ORKPS(DRUGIEN) ;DRUGNAME
"RTN","ORDSGCHK",190,0)
 ..;
"RTN","ORDSGCHK",191,0)
 ..;Additional Order Data
"RTN","ORDSGCHK",192,0)
 ..I SUB="DRATE" D  Q
"RTN","ORDSGCHK",193,0)
 ...S DUR=$P($P(NODE,U,4)," ")
"RTN","ORDSGCHK",194,0)
 ...S ORPSARR(CNT,SUB)=DUR_$$DRATESTR($P($P(NODE,U,4)," ",2))
"RTN","ORDSGCHK",195,0)
 ..S ORPSARR(CNT,SUB)=$P(NODE,U,4)
"RTN","ORDSGCHK",196,0)
 ;
"RTN","ORDSGCHK",197,0)
 I $D(ORDRUG) D
"RTN","ORDSGCHK",198,0)
 .S ORBASE(1)="ORDSGCHK1",ORBASE(2)="ORDSGCHK2"
"RTN","ORDSGCHK",199,0)
 .D DOSE^PSSDSAPD(.ORBASE,DFN,.ORPSARR,.ORDRUG),PARSEOUT
"RTN","ORDSGCHK",200,0)
 .K ^TMP($J,"ORDSGCHK1"),^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",201,0)
 Q
"RTN","ORDSGCHK",202,0)
 ;
"RTN","ORDSGCHK",203,0)
PARSEOUT ;PARSE OUTPUT GLOBAL
"RTN","ORDSGCHK",204,0)
 N ORNBP S ORNBP=""
"RTN","ORDSGCHK",205,0)
 I $D(^TMP($J,"ORDSGCHK2")) D
"RTN","ORDSGCHK",206,0)
 .I $P($G(^TMP($J,"ORDSGCHK2","OUT",0)),U)=-1 S ORNBP=$$DSDWNMSG^ORDSGCHK Q
"RTN","ORDSGCHK",207,0)
 .I $D(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR")) D
"RTN","ORDSGCHK",208,0)
 ..N I S I="" F  S I=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I)) Q:'$L(I)  D
"RTN","ORDSGCHK",209,0)
 ...N J S J="" F  S J=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J)) Q:'$L(J)  D
"RTN","ORDSGCHK",210,0)
 .... I $L($G(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J,"MSG"))) S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J,"MSG") D
"RTN","ORDSGCHK",211,0)
 ..... I $L($G(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J,"TEXT"))) S ORY(ORY)=ORY(ORY)_".  "_$G(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J,"TEXT"))
"RTN","ORDSGCHK",212,0)
 .I $D(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE")) D
"RTN","ORDSGCHK",213,0)
 ..N I S I="" F  S I=$O(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I)) Q:'$L(I)  D
"RTN","ORDSGCHK",214,0)
 ...N J S J="" F  S J=$O(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J)) Q:'$L(J)  D
"RTN","ORDSGCHK",215,0)
 .... I $G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))["could not be performed" S ORNBP=^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J) Q
"RTN","ORDSGCHK",216,0)
 .... I $G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))["Error Summary" S ORNBP=^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J) Q
"RTN","ORDSGCHK",217,0)
 .... I $G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))["Reason(s):" S ORNBP=ORNBP_"."_^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J) Q
"RTN","ORDSGCHK",218,0)
 .... I $G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))["           " S ORNBP=ORNBP_"."_$P(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J),"           ",2) Q
"RTN","ORDSGCHK",219,0)
 .... I $L(ORNBP)>1 S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_ORNBP,ORNBP=""
"RTN","ORDSGCHK",220,0)
 .... I $L($G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))) S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J)
"RTN","ORDSGCHK",221,0)
 .N I S I="" F  S I=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I)) Q:'$L(I)  D
"RTN","ORDSGCHK",222,0)
 ..Q:(I="ERROR")
"RTN","ORDSGCHK",223,0)
 ..N J S J="" F  S J=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J)) Q:'$L(J)  D
"RTN","ORDSGCHK",224,0)
 ...N TYP S TYP="" F  S TYP=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP)) Q:'$L(TYP)  D
"RTN","ORDSGCHK",225,0)
 ....N ORDIEN S ORDIEN=0 F  S ORDIEN=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN)) Q:'ORDIEN  D
"RTN","ORDSGCHK",226,0)
 .....I $L($G(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN))) D
"RTN","ORDSGCHK",227,0)
 ......N OROCTYPE S OROCTYPE="DS"
"RTN","ORDSGCHK",228,0)
 ......I TYP="3_GENERAL" S OROCTYPE="ERR" N ORDIEN2 S ORDIEN2=0 F  S ORDIEN2=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN,ORDIEN2)) Q:'ORDIEN2  D
"RTN","ORDSGCHK",229,0)
 .......S ORY=$G(ORY)+1,ORY(ORY)=OROCTYPE_U_^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN,ORDIEN2)
"RTN","ORDSGCHK",230,0)
 ......Q:OROCTYPE="ERR"
"RTN","ORDSGCHK",231,0)
 ......S ORY=$G(ORY)+1,ORY(ORY)=OROCTYPE_U_^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN)
"RTN","ORDSGCHK",232,0)
 I $L(ORNBP)>1 S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_ORNBP,ORNBP=""
"RTN","ORDSGCHK",233,0)
 Q
"RTN","ORDSGCHK",234,0)
 ;
"RTN","ORDSGCHK",235,0)
GETSUB(NAME) ;
"RTN","ORDSGCHK",236,0)
 I NAME="CONJ" Q "CONJ"
"RTN","ORDSGCHK",237,0)
 I NAME="DAYS" Q "DRATE"
"RTN","ORDSGCHK",238,0)
 I NAME="DOSE" Q "DOSE"
"RTN","ORDSGCHK",239,0)
 I NAME="ROUTE" Q "MR_IEN"
"RTN","ORDSGCHK",240,0)
 I NAME="SCHEDULE" Q "SCHEDULE"
"RTN","ORDSGCHK",241,0)
 Q ""
"RTN","ORDSGCHK",242,0)
 ;
"RTN","ORDSGCHK",243,0)
DRATESTR(ORIN) ;change the form of the DURATION
"RTN","ORDSGCHK",244,0)
 ;DAYS=D,WEEKS=W,MONTHS=L,HOURS=H,MINUTES=M
"RTN","ORDSGCHK",245,0)
 I $$UP^XLFSTR(ORIN)="MONTHS" Q "L"
"RTN","ORDSGCHK",246,0)
 Q $E($$UP^XLFSTR(ORIN))
"RTN","ORDSGCHK",247,0)
 ;
"RTN","ORDSGCHK",248,0)
DSDWNMSG() ;dosage down message (not displayed to user)
"RTN","ORDSGCHK",249,0)
 Q "Drug Dosage checks were not able to be performed."
"RTN","ORKPS1")
0^8^B80576469
"RTN","ORKPS1",1,0)
ORKPS1 ; SLC/CLA - Order checking support procedures for medications ;03/29/13  09:01
"RTN","ORKPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**232,272,346,352,345,311**;Dec 17, 1997;Build 30
"RTN","ORKPS1",3,0)
 Q
"RTN","ORKPS1",4,0)
PROCESS(OI,DFN,ORKDG,ORPROSP,ORGLOBL) ;process data from pharmacy order check API
"RTN","ORKPS1",5,0)
 ;ORPROSP = pharmacy orderable item ien [file #50.7] ^ drug ien [file #50]
"RTN","ORKPS1",6,0)
 ;          NOTE: PIECE 1 WILL ONLY BE FILLED IN FOR ORDERABLE ITEMS THAT RESOLVE TO SUPPLY ITEMS
"RTN","ORKPS1",7,0)
 Q:'$D(^TMP($J))
"RTN","ORKPS1",8,0)
 N II,XX,ZZ,ZZD,ORMTYPE,ORN,ORZ,RCNT,GL,I,J,K,L,M,TDATA,VADMVT,ORX,ORY
"RTN","ORKPS1",9,0)
 S II=1,XX=0,ZZ="",ZZD="",RCNT=0
"RTN","ORKPS1",10,0)
 I $G(^TMP($J,ORGLOBL,"OUT",0))<0 D  Q
"RTN","ORKPS1",11,0)
 .S YY(II)="ERR^Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed. "_$P($G(^TMP($J,ORGLOBL,"OUT",0)),U,2)
"RTN","ORKPS1",12,0)
 .S II=II+1
"RTN","ORKPS1",13,0)
 I $D(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS")) D
"RTN","ORKPS1",14,0)
 .S ORX="" F  S ORX=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX)) Q:'$L(ORX)  D
"RTN","ORKPS1",15,0)
 ..S ORY=0 F  S ORY=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)) Q:'ORY  D
"RTN","ORKPS1",16,0)
 ...I $L($G(ORIFN))>0,$G(ORIFN)=$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,5) Q
"RTN","ORKPS1",17,0)
 ...S YY(II)="ERR^"_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,7)
"RTN","ORKPS1",18,0)
 ...I $L($P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10))>0 S YY(II)=YY(II)_"("_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10)_")"
"RTN","ORKPS1",19,0)
 ...S II=II+1
"RTN","ORKPS1",20,0)
 S ORX="" F ORX="DRUGDRUG","THERAPY" D
"RTN","ORKPS1",21,0)
 .Q:'$D(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR"))
"RTN","ORKPS1",22,0)
 .S ORY="" F  S ORY=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY)) Q:'$L(ORY)  D
"RTN","ORKPS1",23,0)
 ..S ORZ=0 F  S ORZ=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ)) Q:'ORZ  D
"RTN","ORKPS1",24,0)
 ...S YY(II)="ERR^"_$$UPPER^ORWDPS32($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"SEV")))_": "_$P($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,0)),U)_" - "_$G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"TEXT"))
"RTN","ORKPS1",25,0)
 ...S II=II+1
"RTN","ORKPS1",26,0)
 I +$P(ORPROSP,U,2) D
"RTN","ORKPS1",27,0)
 .;set info about the drug being ordered
"RTN","ORKPS1",28,0)
 .S TDATA("NEW","TXT")=""
"RTN","ORKPS1",29,0)
 .S I="" F  S I=$O(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)) Q:'$L(I)  D
"RTN","ORKPS1",30,0)
 ..I $P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,3)=+$P(ORPROSP,U,2) D
"RTN","ORKPS1",31,0)
 ...S TDATA("NEW","TXT")=$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,4)
"RTN","ORKPS1",32,0)
 ...S TDATA("NEW","PROSP")=$P(I,";",3,4)
"RTN","ORKPS1",33,0)
 .S TDATA("NEW","PTYPE")=$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSH":"O",1:"")
"RTN","ORKPS1",34,0)
 .S TDATA("NEW","OTYPE")=$S($G(ORKDG)="PSI":"UD",$G(ORKDG)="PSO":"OP",$G(ORKDG)="PSIV":"IV",$G(ORKDG)="PSH":"NV",1:"")
"RTN","ORKPS1",35,0)
 .I '$L(TDATA("NEW","PTYPE")) D  ;if no display group
"RTN","ORKPS1",36,0)
 ..D ADM^VADPT2
"RTN","ORKPS1",37,0)
 ..S TDATA("NEW","PTYPE")=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS1",38,0)
 ..K VADMVT
"RTN","ORKPS1",39,0)
 D DD(.TDATA,$S(+ORPROSP>0:0,1:1))
"RTN","ORKPS1",40,0)
 Q:'$L($G(TDATA("NEW","PROSP")))
"RTN","ORKPS1",41,0)
 D DI(.TDATA),DT(.TDATA)
"RTN","ORKPS1",42,0)
 Q
"RTN","ORKPS1",43,0)
 ;
"RTN","ORKPS1",44,0)
DI(TDATA) ;add drug interaction checks
"RTN","ORKPS1",45,0)
 N GL,ORSEV,ORDRUG,ORTXT,ORIEN
"RTN","ORKPS1",46,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","DRUGDRUG"))
"RTN","ORKPS1",47,0)
 S J="" F  S J=$O(@GL@(J)) Q:'$L(J)  D
"RTN","ORKPS1",48,0)
 .S K="" F  S K=$O(@GL@(J,K)) Q:'$L(K)  D
"RTN","ORKPS1",49,0)
 ..S L=0 F  S L=$O(@GL@(J,K,L)) Q:'$L(L)  D
"RTN","ORKPS1",50,0)
 ...S M=0 F  S M=$O(@GL@(J,K,L,M)) Q:'M  D
"RTN","ORKPS1",51,0)
 ....N ORNUM,ORSEV,ORDNAME,ORZ,CNT,ORSTAT,ORMON,ORWHICH,ORLINE,ORIDX
"RTN","ORKPS1",52,0)
 ....;get the associated order number
"RTN","ORKPS1",53,0)
 ....S ORNUM=$P(L,";",1,2)
"RTN","ORKPS1",54,0)
 ....;if the status of the associated order is DISCONTINUED then don't add
"RTN","ORKPS1",55,0)
 ....S ORSTAT=$$PHSTAT(DFN,ORNUM)
"RTN","ORKPS1",56,0)
 ....Q:ORSTAT="DISCONTINUED"
"RTN","ORKPS1",57,0)
 ....S ORWHICH=""
"RTN","ORKPS1",58,0)
 ....I $P($P(@GL@(J,K,L,M),U),";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",59,0)
 .....S ORWHICH=K_" ["_$S($P(L,";",3)="PROSPECTIVE":"UNRELEASED",1:ORSTAT)_"]"
"RTN","ORKPS1",60,0)
 ....I $P(L,";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",61,0)
 .....S ORWHICH=$P(@GL@(J,K,L,M),U,4)_" ["
"RTN","ORKPS1",62,0)
 .....S ORWHICH=ORWHICH_$S($P($P(@GL@(J,K,L,M),U),";",3)="PROSPECTIVE":"UNRELEASED",1:$$PHSTAT(DFN,$P($P(@GL@(J,K,L,M),U),";",1,2)))
"RTN","ORKPS1",63,0)
 .....S ORWHICH=ORWHICH_"]"
"RTN","ORKPS1",64,0)
 ....Q:$L(ORWHICH)<2
"RTN","ORKPS1",65,0)
 ....;get text
"RTN","ORKPS1",66,0)
 ....S ORTXT(J,K)=$S($G(ORTXT(J,K))'="":ORTXT(J,K)_" ",1:"")_$P($G(@GL@(J,K,L,M,"CLIN")),"CLINICAL EFFECTS:  ",2),ORTXT(J,K,"ORWHICH")=ORWHICH
"RTN","ORKPS1",67,0)
 ....;set the monograph into the temp global
"RTN","ORKPS1",68,0)
 ....I $D(@GL@(J,K,L,M,"PMON")) D
"RTN","ORKPS1",69,0)
 .....S ^TMP($J,"ORMONOGRAPH")=1+$G(^TMP($J,"ORMONOGRAPH"))
"RTN","ORKPS1",70,0)
 .....S ORMON=^TMP($J,"ORMONOGRAPH")
"RTN","ORKPS1",71,0)
 .....S ^TMP($J,"ORMONOGRAPH",ORMON,"INT")=@GL@(J,K,L,M,"INT")
"RTN","ORKPS1",72,0)
 .....S ORIDX="",ORLINE=1 F  S ORIDX=$O(@GL@(J,K,L,M,"PMON",ORIDX)) Q:+$G(ORIDX)=0  D
"RTN","ORKPS1",73,0)
 ......S ^TMP($J,"ORMONOGRAPH",ORMON,"DATA",ORLINE,0)=@GL@(J,K,L,M,"PMON",ORIDX,0),ORLINE=ORLINE+1
"RTN","ORKPS1",74,0)
 .....S ORTXT(J,K,"MONOGRAPH")=1,ORTXT(J,K,"ORMON",ORMON)=""
"RTN","ORKPS1",75,0)
 ....;get the severity
"RTN","ORKPS1",76,0)
 ....S ORSEV=$$UPPER^ORU($G(@GL@(J,K,L,M,"SEV")))
"RTN","ORKPS1",77,0)
 ....;get the drug name
"RTN","ORKPS1",78,0)
 ....S ORDNAME=K
"RTN","ORKPS1",79,0)
 ....S ORTXT(J,K,"YY")="DI^"_ORSEV_U_ORNUM_U_ORDNAME_U_U_$G(@GL@(J,K,L,M,"INT"))
"RTN","ORKPS1",80,0)
 ;RETURN DATA IN EXPECTED FORMAT
"RTN","ORKPS1",81,0)
 S ORSEV="" F  S ORSEV=$O(ORTXT(ORSEV)) Q:$G(ORSEV)=""  D
"RTN","ORKPS1",82,0)
 .S ORDRUG="" F  S ORDRUG=$O(ORTXT(ORSEV,ORDRUG)) Q:$G(ORDRUG)=""  D
"RTN","ORKPS1",83,0)
 ..S YY(II)=ORTXT(ORSEV,ORDRUG,"YY")
"RTN","ORKPS1",84,0)
 ..S $P(YY(II),U,5)=TDATA("NEW","TXT")_" and "_ORTXT(ORSEV,ORDRUG,"ORWHICH")_" - "_ORTXT(ORSEV,ORDRUG)
"RTN","ORKPS1",85,0)
 ..S ORIEN=0 F  S ORIEN=$O(ORTXT(ORSEV,ORDRUG,"ORMON",ORIEN)) Q:+$G(ORIEN)=0  D
"RTN","ORKPS1",86,0)
 ...S ^TMP($J,"ORMONOGRAPH",ORIEN,"OC")=$P(YY(II),U,5)
"RTN","ORKPS1",87,0)
 ..S:$G(ORTXT(ORSEV,ORDRUG,"MONOGRAPH")) $P(YY(II),U,5)=$P(YY(II),U,5)_" - Monograph Available"
"RTN","ORKPS1",88,0)
 ..S II=II+1
"RTN","ORKPS1",89,0)
 Q
"RTN","ORKPS1",90,0)
 ;
"RTN","ORKPS1",91,0)
DD(TDATA,ORDPROSP) ;add duplicate drug checks
"RTN","ORKPS1",92,0)
 ;ORDPROSP: PERFORM PROSPECTIVE DRUG CHECK
"RTN","ORKPS1",93,0)
 ;          1 FOR YES
"RTN","ORKPS1",94,0)
 ;          0 FOR NO
"RTN","ORKPS1",95,0)
 S XX=0,ZZ=""
"RTN","ORKPS1",96,0)
 F  S XX=$O(^TMP($J,"DD",XX)) Q:XX<1  D
"RTN","ORKPS1",97,0)
 .N ORREM
"RTN","ORKPS1",98,0)
 .S ZZ=$G(^TMP($J,"DD",XX,0)),ORMTYPE=$P($P(ZZ,U,4),";",2)
"RTN","ORKPS1",99,0)
 .S ORREM=$P($P(ZZ,U,4),";") I (ORREM["Z"),$D(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM)) D
"RTN","ORKPS1",100,0)
 ..N ORTXT,ORREM1,ORREMSIG
"RTN","ORKPS1",101,0)
 ..S ORREM1=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM))
"RTN","ORKPS1",102,0)
 ..S ORREMSIG=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM,"SIG",0))
"RTN","ORKPS1",103,0)
 ..S ORTXT=" "_ORREMSIG_" ["_$P(ORREM1,U,4)_" -  Last Fill: "_$P(ORREM1,U,6)_"  Quantity Dispensed: "_$P(ORREM1,U,8)_"] >>"_$P(ORREM1,U)
"RTN","ORKPS1",104,0)
 ..S $P(ZZ,U,2)=$P(ZZ,U,2)_ORTXT
"RTN","ORKPS1",105,0)
 .I +ORDPROSP,$G(TDATA("NEW","PTYPE"))'=$G(ORMTYPE) Q
"RTN","ORKPS1",106,0)
 .S ORN=$P($P(ZZ,U,3),";"),ORZ=""
"RTN","ORKPS1",107,0)
 .I $L($G(ORN))>0,+$G(ORN)=+$G(ORIFN) Q  ;QUIT if dup med ord # = current ord #
"RTN","ORKPS1",108,0)
 .I +$G(ORIFN),+$G(ORN)=$P(^OR(100,+ORIFN,3),U,5) Q  ;QUIT if dup med ord # = the current order #'s REPLACED ORDER (changing an order)
"RTN","ORKPS1",109,0)
 .I +ORDPROSP,+$P(ORPROSP,U,2)'=+ZZ Q
"RTN","ORKPS1",110,0)
 .I $L(ORN),$D(^OR(100,ORN,8,0)) S ORZ=^OR(100,ORN,8,0)
"RTN","ORKPS1",111,0)
 .I $L($G(ORZ)),($P(^OR(100,ORN,8,$P(ORZ,U,3),0),U,2)="DC") Q
"RTN","ORKPS1",112,0)
 .I $L(ORN),$P(^ORD(100.01,$P(^OR(100,ORN,3),U,3),0),U)="DISCONTINUED" Q
"RTN","ORKPS1",113,0)
 .I ZZ'="" S YY(II)="DD^"_ZZ,II=II+1
"RTN","ORKPS1",114,0)
 .S ^TMP($J,"DD",XX,"OC")="" ;set this if this DD entry turned into an OC
"RTN","ORKPS1",115,0)
 Q
"RTN","ORKPS1",116,0)
 ;
"RTN","ORKPS1",117,0)
DT(TDATA) ;add duplicate therapy checks
"RTN","ORKPS1",118,0)
 N I
"RTN","ORKPS1",119,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","THERAPY"))
"RTN","ORKPS1",120,0)
 S I=0 F  S I=$O(@GL@(I)) Q:'I  D
"RTN","ORKPS1",121,0)
 .;get all drug names
"RTN","ORKPS1",122,0)
 .N ORDRUGS,ORCLASS,ORF,ORPROSCNT,ORPROFCNT,DRUGS,ORRETSTR S ORDRUGS="",ORCLASS="",ORF=0,ORPROSCNT=0,ORPROFCNT=0
"RTN","ORKPS1",123,0)
 .S J=0 F  S J=$O(@GL@(I,"DRUGS",J)) Q:'J  D
"RTN","ORKPS1",124,0)
 ..;keep count of PROSPECTIVE drugs
"RTN","ORKPS1",125,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4)=TDATA("NEW","PROSP") S ORF=1
"RTN","ORKPS1",126,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3)="PROSPECTIVE" D
"RTN","ORKPS1",127,0)
 ...S ORPROSCNT=1+$G(ORPROSCNT)
"RTN","ORKPS1",128,0)
 ...I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4)'=TDATA("NEW","PROSP") S ORDRUGS=ORDRUGS_$S($L(ORDRUGS):", ",1:"")_$P($G(@GL@(I,"DRUGS",J)),U,3)_" [UNRELEASED]",DRUGS($P($G(@GL@(I,"DRUGS",J)),U,3))=""
"RTN","ORKPS1",129,0)
 ..;-check each PROFILE drug to see if it is not the same order as the prospective (ORIFN)
"RTN","ORKPS1",130,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3)="PROFILE" D
"RTN","ORKPS1",131,0)
 ...;if not the same then set ORNUM=THE PROFILE DRUG "O;PSNUM"
"RTN","ORKPS1",132,0)
 ...I $P($P($G(@GL@(I,"DRUGS",J)),U),";",2)'=$G(^OR(100,+$G(ORIFN),4)) D
"RTN","ORKPS1",133,0)
 ....I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=$P($G(^OR(100,+$G(ORIFN),3)),U,5)) Q
"RTN","ORKPS1",134,0)
 ....I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=+$G(ORIFN)) Q
"RTN","ORKPS1",135,0)
 ....I $E($G(@GL@(I,"DRUGS",J)),1)="R" S $P(@GL@(I,"DRUGS",J),U,5)="O"
"RTN","ORKPS1",136,0)
 ....I $G(TDATA("NEW","PTYPE"))'=$P($G(@GL@(I,"DRUGS",J)),U,5) Q
"RTN","ORKPS1",137,0)
 ....S ORNUM=$P($P($G(@GL@(I,"DRUGS",J)),U),";",1,2)
"RTN","ORKPS1",138,0)
 ....I $$INDD($P($G(@GL@(I,"DRUGS",J)),U,3))=0 D
"RTN","ORKPS1",139,0)
 .....S ORDRUGS=ORDRUGS_$S($L(ORDRUGS):", ",1:"")_$P($G(@GL@(I,"DRUGS",J)),U,3)_" ["_$$PHSTAT(DFN,ORNUM)_"]"
"RTN","ORKPS1",140,0)
 .....S DRUGS($P($G(@GL@(I,"DRUGS",J)),U,3))=$P($G(@GL@(I,"DRUGS",J)),U,4),ORPROFCNT=ORPROFCNT+1
"RTN","ORKPS1",141,0)
 .Q:'$$CHKDD(.DRUGS)
"RTN","ORKPS1",142,0)
 .;quit if ORNUM is not set and PROSPECTIVE count <=1
"RTN","ORKPS1",143,0)
 .Q:('$L($G(ORNUM))&(ORPROSCNT<2))
"RTN","ORKPS1",144,0)
 .;get all classes
"RTN","ORKPS1",145,0)
 .I ORF S J=0 F  S J=$O(@GL@(I,J)) Q:'J  D
"RTN","ORKPS1",146,0)
 ..S ORCLASS=ORCLASS_$S($L(ORCLASS):", ",1:"")_$G(@GL@(I,J,"CLASS"))
"RTN","ORKPS1",147,0)
 .;assemble return string ("DC"+ORNUM_U_Classes_U_Classes (drugs))
"RTN","ORKPS1",148,0)
 .S ORRETSTR="Duplicate Therapy: Order(s) exist for {"_ORDRUGS_"} in the same therapeutic categor(ies): "_ORCLASS
"RTN","ORKPS1",149,0)
 .I ORF S YY(II)="DC"_U_$G(ORNUM)_U_ORCLASS_U_ORRETSTR,II=II+1
"RTN","ORKPS1",150,0)
 Q
"RTN","ORKPS1",151,0)
 ;
"RTN","ORKPS1",152,0)
PHSTAT(DFN,ORNUM) ;get the status of the order
"RTN","ORKPS1",153,0)
 N RET,J,I
"RTN","ORKPS1",154,0)
 S RET=""
"RTN","ORKPS1",155,0)
 I $P(ORNUM,";")="P" S RET="PENDING"
"RTN","ORKPS1",156,0)
 I $P(ORNUM,";")="N" S RET="ACTIVE NON-VA"
"RTN","ORKPS1",157,0)
 I $P(ORNUM,";")="O" D
"RTN","ORKPS1",158,0)
 .K ^TMP($J,"OROCLST") D RX^PSO52API(DFN,"OROCLST",$P(ORNUM,";",2),,"ST")
"RTN","ORKPS1",159,0)
 .S RET=$P($G(^TMP($J,"OROCLST",DFN,$P(ORNUM,";",2),100)),U,2)
"RTN","ORKPS1",160,0)
 .K ^TMP($J,"OROCLST")
"RTN","ORKPS1",161,0)
 I $P(ORNUM,";")="I"!($E($P(ORNUM,";"),1)="C") D
"RTN","ORKPS1",162,0)
 .N ORLAST,ORPHNUM
"RTN","ORKPS1",163,0)
 .I $E($P(ORNUM,";"),1)="C" S ORLAST=$S($E($P(ORNUM,";"),2)=1:"V",$E($P(ORNUM,";"),2)=2:"U",1:"NV")
"RTN","ORKPS1",164,0)
 .E  S ORLAST=$E(ORNUM,$L(ORNUM))
"RTN","ORKPS1",165,0)
 .I ORLAST="P" S RET="PENDING" Q
"RTN","ORKPS1",166,0)
 .S ORPHNUM=+$P(ORNUM,";",2)
"RTN","ORKPS1",167,0)
 .I ORLAST="U" D
"RTN","ORKPS1",168,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS431^PSS55(DFN,ORPHNUM,"","","OR GET STATUS")
"RTN","ORKPS1",169,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,28)),U,2)
"RTN","ORKPS1",170,0)
 .I ORLAST="V" D
"RTN","ORKPS1",171,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS436^PSS55(DFN,ORPHNUM,"OR GET STATUS")
"RTN","ORKPS1",172,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,100)),U,2)
"RTN","ORKPS1",173,0)
 .I ORLAST="NV" D
"RTN","ORKPS1",174,0)
 ..K ^TMP($J,"OR GET STATUS") D PSJ^PSJ53P1(ORPHNUM,"OR GET STATUS")
"RTN","ORKPS1",175,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,28)),U,2)
"RTN","ORKPS1",176,0)
 .S:$E($P(ORNUM,";"),1)="C" RET=RET_" CLINIC ORDER"
"RTN","ORKPS1",177,0)
 I $P(ORNUM,";")="R" D
"RTN","ORKPS1",178,0)
 .N ORREMOTE S ORREMOTE=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",$P(ORNUM,";",2)))
"RTN","ORKPS1",179,0)
 .S RET=$P(ORREMOTE,U,4)_" >> "_$P(ORREMOTE,U)
"RTN","ORKPS1",180,0)
 I "^PENDING^NON-VERIFIED^NON VERIFIED^INCOMPLETE^DRUG INTERACTIONS^"[(U_RET_U) S RET="PENDING"
"RTN","ORKPS1",181,0)
 Q RET
"RTN","ORKPS1",182,0)
 ;
"RTN","ORKPS1",183,0)
CHKDD(DARRAY) ;check the duplicate drug OCs returned
"RTN","ORKPS1",184,0)
 ;if all drugs in DARRAY are already displayed in a DD OC then don't show the DT OC (return 0)
"RTN","ORKPS1",185,0)
 ;check the ^TMP($J,"DD",I,"OC") node to see if the DD entry turned into an OC
"RTN","ORKPS1",186,0)
 N I S I=0 F  S I=$O(^TMP($J,"DD",I)) Q:'I  D
"RTN","ORKPS1",187,0)
 .I $D(DARRAY($P($G(^TMP($J,"DD",I,0)),U,2))),$D(^TMP($J,"DD",I,"OC")) D
"RTN","ORKPS1",188,0)
 ..K DARRAY($P($G(^TMP($J,"DD",I,0)),U,2))
"RTN","ORKPS1",189,0)
 .N J S J=0 F  S J=$O(DARRAY(J)) Q:'$L(J)  D
"RTN","ORKPS1",190,0)
 ..I DARRAY(J)=$P($G(^TMP($J,"DD",I,0)),U,3),($L(DARRAY(J))>0) D
"RTN","ORKPS1",191,0)
 ...K DARRAY(J)
"RTN","ORKPS1",192,0)
 Q $D(DARRAY)
"RTN","ORKPS1",193,0)
 ;
"RTN","ORKPS1",194,0)
INDD(ORDRUG) ;checks if ORDRUG is in the duplicate drug OCs returned
"RTN","ORKPS1",195,0)
 N RET S RET=0
"RTN","ORKPS1",196,0)
 N I S I=0 F  S I=$O(^TMP($J,"DD",I)) Q:'I  D
"RTN","ORKPS1",197,0)
 .I ORDRUG=$P($G(^TMP($J,"DD",I,0)),U,2),$D(^TMP($J,"DD",I,"OC")) S RET=1
"RTN","ORKPS1",198,0)
 Q RET
"RTN","ORKPS1",199,0)
 ;
"RTN","ORWDXC")
0^9^B67359281
"RTN","ORWDXC",1,0)
ORWDXC ; SLC/KCM - Utilities for Order Checking ;06/28/13  07:53
"RTN","ORWDXC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,141,221,243,280,346,345,311**;Dec 17, 1997;Build 30
"RTN","ORWDXC",3,0)
 ;
"RTN","ORWDXC",4,0)
ON(VAL) ; returns E if order checking enabled, otherwise D
"RTN","ORWDXC",5,0)
 S VAL=$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")
"RTN","ORWDXC",6,0)
 Q
"RTN","ORWDXC",7,0)
FILLID(VAL,DLG) ; Return the FillerID (namespace) for a dialog
"RTN","ORWDXC",8,0)
 N DGRP
"RTN","ORWDXC",9,0)
 S VAL="",DGRP=$P($G(^ORD(101.41,DLG,0)),U,5) Q:'DGRP
"RTN","ORWDXC",10,0)
 S DLG=$$DEFDLG^ORWDXQ(DGRP)
"RTN","ORWDXC",11,0)
 S VAL=$P($G(^ORD(101.41,DLG,0)),U,7),VAL=$$NMSP^ORCD(VAL)
"RTN","ORWDXC",12,0)
 I VAL="PS" D
"RTN","ORWDXC",13,0)
 . N X
"RTN","ORWDXC",14,0)
 . S X=$P($P($G(^ORD(100.98,DGRP,0)),U,3)," ")
"RTN","ORWDXC",15,0)
 . I $L(X) S VAL="PS"_$S(X="UD":"I",1:X)
"RTN","ORWDXC",16,0)
 Q
"RTN","ORWDXC",17,0)
DISPLAY(LST,DFN,FID) ; Return list of Order Checks for a FillerID (namespace)
"RTN","ORWDXC",18,0)
 N I,ORX,ORY
"RTN","ORWDXC",19,0)
 S ORX=1,ORX(1)="|"_FID
"RTN","ORWDXC",20,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"DISPLAY")
"RTN","ORWDXC",21,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  S LST(I)=$P(ORY(I),U,4)
"RTN","ORWDXC",22,0)
 Q
"RTN","ORWDXC",23,0)
ACCEPT(LST,DFN,FID,STRT,ORL,OIL,ORIFN,ORREN)    ; Return list of Order Checks on Accept Order
"RTN","ORWDXC",24,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",25,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",26,0)
 ; ORREN - IF ORREN IS SET TO 1 THEN ORIFN IS THE ORDER GETTING RENEWED
"RTN","ORWDXC",27,0)
 K ^TMP($J,"ORENHCHK")
"RTN","ORWDXC",28,0)
 N X,Y,USID,ORCHECK,ORI,ORX,ORY,%DT,ORDODSG
"RTN","ORWDXC",29,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",30,0)
 S ORL=ORL_";SC(",X=STRT,STRT="",ORDODSG=0
"RTN","ORWDXC",31,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",32,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",33,0)
 ; do the SELECT order checks
"RTN","ORWDXC",34,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",35,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",36,0)
 . S USID=$$USID(OIL(ORI))
"RTN","ORWDXC",37,0)
 . S OIL(ORI,"USID")=USID
"RTN","ORWDXC",38,0)
 . S ORX=ORX+1,ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_USID
"RTN","ORWDXC",39,0)
 . S:$P(OIL(ORI),U,2)="PSIV" $P(ORX(ORX),"|",7)=$P($P(OIL(ORI),U,3),";")
"RTN","ORWDXC",40,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"SELECT",.OIL,.ORDODSG)
"RTN","ORWDXC",41,0)
 I $D(ORY) D RETURN^ORCHECK ; expects ORY, ORCHECK
"RTN","ORWDXC",42,0)
 K ORX,ORY
"RTN","ORWDXC",43,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",44,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",45,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",46,0)
 . S ORX=ORX+1
"RTN","ORWDXC",47,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_OIL(ORI,"USID")_"|"_STRT
"RTN","ORWDXC",48,0)
 . S:$P(OIL(ORI),U,2)="LR" $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",49,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ACCEPT",.OIL,.ORDODSG)
"RTN","ORWDXC",50,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",51,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",52,0)
 D FDBDOWN^ORCHECK(0)
"RTN","ORWDXC",53,0)
 D OPOS(DFN)
"RTN","ORWDXC",54,0)
 D CHK2LST
"RTN","ORWDXC",55,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",56,0)
 Q
"RTN","ORWDXC",57,0)
DELAY(LST,DFN,FID,STRT,ORL,OIL) ; Return list of Order Checks on Accept Delayed
"RTN","ORWDXC",58,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",59,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",60,0)
 N X,Y,ORCHECK,ORI,ORX,ORY,%DT
"RTN","ORWDXC",61,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",62,0)
 S ORL=ORL_";SC(",X=STRT,STRT=""
"RTN","ORWDXC",63,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",64,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",65,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",66,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",67,0)
 . S ORX=ORX+1
"RTN","ORWDXC",68,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_$$USID(OIL(ORI))_"|"_STRT
"RTN","ORWDXC",69,0)
 . I $P(OIL(ORI),U,2)="LR" S $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",70,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ALL",.OIL)
"RTN","ORWDXC",71,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",72,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",73,0)
 D CHK2LST
"RTN","ORWDXC",74,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",75,0)
 Q
"RTN","ORWDXC",76,0)
SESSION(LST,ORVP,ORLST) ; Return list of Order Checks on Release Order
"RTN","ORWDXC",77,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",78,0)
 N ORES,ORCHECK
"RTN","ORWDXC",79,0)
 S ORVP=+ORVP_";DPT("
"RTN","ORWDXC",80,0)
 S I=0 F  S I=$O(ORLST(I)) Q:'I  D
"RTN","ORWDXC",81,0)
 . I +$P(ORLST(I),";",2)'=1 Q  ; order not new
"RTN","ORWDXC",82,0)
 . I $P(ORLST(I),U,3)="0" Q    ; order not being released
"RTN","ORWDXC",83,0)
 . S ORES($P(ORLST(I),U))=""
"RTN","ORWDXC",84,0)
 D SESSION^ORCHECK
"RTN","ORWDXC",85,0)
 D OPOS(+ORVP)
"RTN","ORWDXC",86,0)
 D CHK2LST
"RTN","ORWDXC",87,0)
 D CHECKIT(.LST)
"RTN","ORWDXC",88,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",89,0)
 Q
"RTN","ORWDXC",90,0)
SAVECHK(OK,ORVP,RSN,LST)    ; Save order checks for session
"RTN","ORWDXC",91,0)
 N ORCHECK,ORIFN S OK=1
"RTN","ORWDXC",92,0)
 D LST2CHK
"RTN","ORWDXC",93,0)
 I $L(RSN)>0 S ORCHECK("OK")=RSN
"RTN","ORWDXC",94,0)
 S ORIFN=0 F  S ORIFN=$O(ORCHECK(ORIFN)) Q:'ORIFN  D OC^ORCSAVE2
"RTN","ORWDXC",95,0)
 Q
"RTN","ORWDXC",96,0)
DELORD(OK,ORIFN)      ; Delete order
"RTN","ORWDXC",97,0)
 N STS,DIK,DA
"RTN","ORWDXC",98,0)
 S STS=$P(^OR(100,+ORIFN,8,1,0),U,15),OK=0
"RTN","ORWDXC",99,0)
 I (STS=10)!(STS=11) D  Q  ; makes sure it's an unreleased order
"RTN","ORWDXC",100,0)
 . S DA=+ORIFN,DIK="^OR(100," Q:'DA
"RTN","ORWDXC",101,0)
 . D ^DIK
"RTN","ORWDXC",102,0)
 . S OK=1
"RTN","ORWDXC",103,0)
 . D DELETE^OROCAPI1(+ORIFN)
"RTN","ORWDXC",104,0)
 Q
"RTN","ORWDXC",105,0)
USID(ORITMX) ; Return universal svc ID for an orderable item
"RTN","ORWDXC",106,0)
 ; ORITMX = OI^NMSP^PKGINFO
"RTN","ORWDXC",107,0)
 N RSLT,ORDRUG S RSLT=""
"RTN","ORWDXC",108,0)
 I $E($P(ORITMX,U,2),1,2)="PS" D
"RTN","ORWDXC",109,0)
 . I $P(ORITMX,U,2)="PSIV" D
"RTN","ORWDXC",110,0)
 . . N PSOI,TYPE,VOL S VOL=""
"RTN","ORWDXC",111,0)
 . . S PSOI=+$P($G(^ORD(101.43,+ORITMX,0)),U,2)
"RTN","ORWDXC",112,0)
 . . S TYPE=$P($P(ORITMX,U,3),";")
"RTN","ORWDXC",113,0)
 . . I TYPE="B" S VOL=$P($P(ORITMX,U,3),";",2)
"RTN","ORWDXC",114,0)
 . . D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORDRUG)
"RTN","ORWDXC",115,0)
 . . S ORDRUG=+ORDRUG
"RTN","ORWDXC",116,0)
 . E  S ORDRUG=+$P(ORITMX,U,3)
"RTN","ORWDXC",117,0)
 . S RSLT=$$ENDCM^PSJORUTL(ORDRUG)
"RTN","ORWDXC",118,0)
 . S RSLT=$P(RSLT,U,3)_"^^99NDF^"_ORDRUG_U_$$NAME50^ORPEAPI(ORDRUG)_"^99PSD"
"RTN","ORWDXC",119,0)
 E  S RSLT=$$USID^ORMBLD(+ORITMX)
"RTN","ORWDXC",120,0)
 I +$P(RSLT,U)=0,+($P(RSLT,U,4)=0) S RSLT="" ; has to be null (why?)
"RTN","ORWDXC",121,0)
 Q RSLT
"RTN","ORWDXC",122,0)
 ;
"RTN","ORWDXC",123,0)
CHK2LST ; creates list that can be passed to broker from ORCHECK array
"RTN","ORWDXC",124,0)
 ; expects ORCHECK to be present and populates LST
"RTN","ORWDXC",125,0)
 D REMDUPS ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",126,0)
 N ORIFN,ORID,CDL,I,ILST,LASTIFN,RESERVED,ORCHECK2,ORNUM,OLIST S ILST=0,LASTIFN=0,RESERVED=0,OLIST=0
"RTN","ORWDXC",127,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",128,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",129,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",130,0)
 . . . S ORCHECK2(ORIFN,CDL,+ORCHECK(ORIFN,CDL,I),I)=ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",131,0)
 K ORCHECK
"RTN","ORWDXC",132,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK2(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",133,0)
 . S CDL=0 F  S CDL=$O(ORCHECK2(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",134,0)
 . . S ORNUM=0 F  S ORNUM=$O(ORCHECK2(ORIFN,CDL,ORNUM)) Q:'ORNUM  D
"RTN","ORWDXC",135,0)
 . . . S I=0 F  S I=$O(ORCHECK2(ORIFN,CDL,ORNUM,I)) Q:'I  D
"RTN","ORWDXC",136,0)
 . . . . S OLIST=OLIST+1,ORCHECK(ORIFN,CDL,OLIST)=ORCHECK2(ORIFN,CDL,ORNUM,I)
"RTN","ORWDXC",137,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",138,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",139,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",140,0)
 . . . I LASTIFN'=ORIFN S LASTIFN=ORIFN,RESERVED=ILST+1,ILST=ILST+1 ; saves a spot for the RDI warning at the top of each order's checks
"RTN","ORWDXC",141,0)
 . . . S ORID=ORIFN I +ORID,(+ORID=ORID) S ORID=ORID_";1"
"RTN","ORWDXC",142,0)
 . . . I '$P(ORCHECK(ORIFN,CDL,I),U,2) Q  ; CDL="" means don't show
"RTN","ORWDXC",143,0)
 . . . I $P(ORCHECK(ORIFN,CDL,I),U,1)=99 S LST(RESERVED)=ORID_U_ORCHECK(ORIFN,CDL,I) Q  ;Put RDI warning at the top of each order's checks
"RTN","ORWDXC",144,0)
 . . . S ILST=ILST+1,LST(ILST)=ORID_U_ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",145,0)
 Q
"RTN","ORWDXC",146,0)
LST2CHK ; create ORCHECK array from list passed by broker
"RTN","ORWDXC",147,0)
 N ORIFN,CDL,I,ILST S I=0
"RTN","ORWDXC",148,0)
 S ILST="" F  S ILST=$O(LST("ORCHECKS",ILST)) Q:$L(ILST)'>0  D
"RTN","ORWDXC",149,0)
 . I $D(LST("ORCHECKS",ILST,0)) D
"RTN","ORWDXC",150,0)
 . . N J S J=0 S X=LST("ORCHECKS",ILST,J) F  S J=$O(LST("ORCHECKS",ILST,J)) Q:'J  S X=X_LST("ORCHECKS",ILST,J)
"RTN","ORWDXC",151,0)
 . I '$D(LST("ORCHECKS",ILST,0)) S X=LST("ORCHECKS",ILST)
"RTN","ORWDXC",152,0)
 . S ORIFN=$P(X,U),CDL=$P(X,U,3)
"RTN","ORWDXC",153,0)
 . I +$G(ORIFN)>0,+$G(CDL)>0 D  ;cla 12/16/03
"RTN","ORWDXC",154,0)
 . . S I=I+1,ORCHECK(+ORIFN,CDL,I)=$P(X,U,2,4)
"RTN","ORWDXC",155,0)
 Q
"RTN","ORWDXC",156,0)
CHECKIT(X) ;remove uncessesary duplication of Duplicate Therapy checks
"RTN","ORWDXC",157,0)
 N I,J,Y
"RTN","ORWDXC",158,0)
 S I=0 F  S I=$O(X(I)) Q:'I  I $P(X(I),U,2)=17 D
"RTN","ORWDXC",159,0)
 .Q:$P($G(^ORD(100.8,17,0)),U)'="DUPLICATE DRUG THERAPY"
"RTN","ORWDXC",160,0)
 .N STR S STR=$P($P(X(I),"{",2),"}")
"RTN","ORWDXC",161,0)
 .S J=0 F  S J=J+1 Q:J>$L(STR,", ")  S Y(+X(I),I,J)=$P(STR,", ",J)
"RTN","ORWDXC",162,0)
 S I=0 F  S I=$O(Y(I)) Q:'I  D
"RTN","ORWDXC",163,0)
 .S J=0 F  S J=$O(Y(I,J)) Q:'J  D
"RTN","ORWDXC",164,0)
 ..S K=J F  S K=$O(Y(I,K)) Q:'K!('$D(Y(I,J)))  D
"RTN","ORWDXC",165,0)
 ...N A,B M A=Y(I,J),B=Y(I,K)
"RTN","ORWDXC",166,0)
 ...I $$AINB(.A,.B) K X(J),Y(I,J)
"RTN","ORWDXC",167,0)
 ...Q:'$D(Y(I,J))
"RTN","ORWDXC",168,0)
 ...I $$AINB(.B,.A) K X(K),Y(I,K)
"RTN","ORWDXC",169,0)
 Q
"RTN","ORWDXC",170,0)
AINB(A,B) ;if array A is a subset of array B then return 1, else return 0
"RTN","ORWDXC",171,0)
 N I,RET
"RTN","ORWDXC",172,0)
 S RET=1
"RTN","ORWDXC",173,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I '$$XINA(A(I),.B) S RET=0 Q
"RTN","ORWDXC",174,0)
 Q RET
"RTN","ORWDXC",175,0)
XINA(X,A) ;if string X is an entry in array A then return 1, else return 0
"RTN","ORWDXC",176,0)
 N I,RET
"RTN","ORWDXC",177,0)
 S RET=0
"RTN","ORWDXC",178,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I X=A(I) S RET=1 Q
"RTN","ORWDXC",179,0)
 Q RET
"RTN","ORWDXC",180,0)
REMDUPS ;
"RTN","ORWDXC",181,0)
 N IFN,CDL,I,J,CDL2 S IFN="NEW"
"RTN","ORWDXC",182,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",183,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",184,0)
 .. S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORWDXC",185,0)
 ... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORWDXC",186,0)
 .... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",187,0)
 .... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORWDXC",188,0)
 .. I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",189,0)
 Q
"RTN","ORWDXC",190,0)
REMDUPSX ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",191,0)
 N IFN,CDL,I S IFN="NEW"
"RTN","ORWDXC",192,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",193,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",194,0)
 . . S J=I F  S J=$O(ORCHECK(IFN,CDL,J)) Q:'J  I $G(ORCHECK(IFN,CDL,I))=$G(ORCHECK(IFN,CDL,J)) K ORCHECK(IFN,CDL,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",195,0)
 Q
"RTN","ORWDXC",196,0)
OPOS(DFN) ;handles saving and removing order checks that should only be displayed once per cprs session
"RTN","ORWDXC",197,0)
 ; expects ORCHECK
"RTN","ORWDXC",198,0)
 ; sets these order checks into the "Once Per cprs Session" global ^TMP($J,"OC-OPOS",DFN)
"RTN","ORWDXC",199,0)
 N I,J,K
"RTN","ORWDXC",200,0)
 S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORWDXC",201,0)
 .S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORWDXC",202,0)
 ..S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORWDXC",203,0)
 ...N ORTXT,ORTXT0,ORTXTI,ORXTRAI
"RTN","ORWDXC",204,0)
 ...S ORTXTO="These checks could not be completed for this patient:"
"RTN","ORWDXC",205,0)
 ...Q:(ORCHECK(I,J,K)'[ORTXTO)
"RTN","ORWDXC",206,0)
 ...S ORTXT=ORTXTO
"RTN","ORWDXC",207,0)
 ...S ORXTRAI=$P($P(ORCHECK(I,J,K),"||",2),"&")
"RTN","ORWDXC",208,0)
 ...S ORTXTI=0 F  S ORTXTI=$O(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))  Q:'ORTXTI  D
"RTN","ORWDXC",209,0)
 ....S ORTXT=ORTXT_$G(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))
"RTN","ORWDXC",210,0)
 ...I $D(^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))) K ORCHECK(I,J,K) Q
"RTN","ORWDXC",211,0)
 ...S ^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))="" Q
"RTN","ORWDXC",212,0)
 Q
"RTN","ORWDXR01")
0^10^B28161629
"RTN","ORWDXR01",1,0)
ORWDXR01 ;SLC/JDL - Utilities for Order Actions ;03/25/2013  07:56
"RTN","ORWDXR01",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**187,190,195,215,280,345,311**;Dec 17, 1997;Build 30
"RTN","ORWDXR01",3,0)
CANCHG(ORY,ORIFN,TXTOD) ;
"RTN","ORWDXR01",4,0)
 ;If it's an pending or unsigned unreleased renewed order, can edit=True
"RTN","ORWDXR01",5,0)
 S ORY=0
"RTN","ORWDXR01",6,0)
 Q:'$D(^OR(100,+ORIFN,0))
"RTN","ORWDXR01",7,0)
 I TXTOD D TXTCAN(.ORY) Q
"RTN","ORWDXR01",8,0)
 N OUTGRP,URELSTS,USIGSTS,RNTYPE,PDSTS
"RTN","ORWDXR01",9,0)
 N ODGRP,ODREL,ODSIG,ODTYPE,LSTACT
"RTN","ORWDXR01",10,0)
 S OUTGRP=$O(^ORD(100.98,"B","O RX",0))
"RTN","ORWDXR01",11,0)
 S URELSTS=$O(^ORD(100.01,"B","UNRELEASED",0))
"RTN","ORWDXR01",12,0)
 S PDSTS=$O(^ORD(100.01,"B","PENDING",0))
"RTN","ORWDXR01",13,0)
 S USIGSTS=2 ; unsigned order
"RTN","ORWDXR01",14,0)
 S RNTYPE=2 ; renew action
"RTN","ORWDXR01",15,0)
 ;Data from the order entry
"RTN","ORWDXR01",16,0)
 S LSTACT=$P($G(^OR(100,+ORIFN,3)),U,7)
"RTN","ORWDXR01",17,0)
 S ODGRP=$P($G(^OR(100,+ORIFN,0)),U,11)
"RTN","ORWDXR01",18,0)
 S ODREL=$P($G(^OR(100,+ORIFN,3)),U,3)
"RTN","ORWDXR01",19,0)
 S ODSIG=$P($G(^OR(100,+ORIFN,8,LSTACT,0)),U,4)
"RTN","ORWDXR01",20,0)
 S ODTYPE=$P($G(^OR(100,+ORIFN,3)),U,11)
"RTN","ORWDXR01",21,0)
 I (ODGRP=OUTGRP),(ODREL=URELSTS),(ODSIG=USIGSTS),(ODTYPE=RNTYPE) S ORY=1
"RTN","ORWDXR01",22,0)
 Q
"RTN","ORWDXR01",23,0)
 ;
"RTN","ORWDXR01",24,0)
TXTCAN(ORY) ;
"RTN","ORWDXR01",25,0)
 ;if it's an unsigned unreleased renewed text order, can change=true
"RTN","ORWDXR01",26,0)
 N URELSTS,USIGSTS,RNTYPE
"RTN","ORWDXR01",27,0)
 N ODREL,ODSIG,ODTYPE,LSTACT
"RTN","ORWDXR01",28,0)
 S URELSTS=$O(^ORD(100.01,"B","UNRELEASED",0))
"RTN","ORWDXR01",29,0)
 S USIGSTS=2 ; unsigned order
"RTN","ORWDXR01",30,0)
 S RNTYPE=2 ; renew action
"RTN","ORWDXR01",31,0)
 ;Data from the order entry
"RTN","ORWDXR01",32,0)
 S LSTACT=$P($G(^OR(100,+ORIFN,3)),U,7)
"RTN","ORWDXR01",33,0)
 S ODREL=$P($G(^OR(100,+ORIFN,8,LSTACT,0)),U,15)
"RTN","ORWDXR01",34,0)
 S ODSIG=$P($G(^OR(100,+ORIFN,8,LSTACT,0)),U,4)
"RTN","ORWDXR01",35,0)
 S ODTYPE=$P($G(^OR(100,+ORIFN,3)),U,11)
"RTN","ORWDXR01",36,0)
 I (ODREL=URELSTS),(ODSIG=USIGSTS),(ODTYPE=RNTYPE) S ORY=1
"RTN","ORWDXR01",37,0)
 Q
"RTN","ORWDXR01",38,0)
 ;
"RTN","ORWDXR01",39,0)
SAVCHG(ORY,ORID,PARM1,PARM2,TXTOD) ;
"RTN","ORWDXR01",40,0)
 ;save new changes on the unreleased unsigned renewed order
"RTN","ORWDXR01",41,0)
 Q:'$D(^OR(100,+ORID,0))
"RTN","ORWDXR01",42,0)
 ;Update new start and stop date the text order
"RTN","ORWDXR01",43,0)
 I TXTOD D TXTSAV(.ORY,ORID,PARM1,PARM2) Q
"RTN","ORWDXR01",44,0)
 ;Update new refills and pickup for the med order
"RTN","ORWDXR01",45,0)
 N REFID,PICKID,ACT,IX,TXT,REFPOS,NDQUIT
"RTN","ORWDXR01",46,0)
 S (REFID,PICKID,ACT,REFPOS,NDQUIT)=0,ORY=""
"RTN","ORWDXR01",47,0)
 S ACT=+$P(ORID,";",2) S:ACT'>0 ACT=1
"RTN","ORWDXR01",48,0)
 S REFID=$O(^OR(100,+ORID,4.5,"ID","REFILLS",0))
"RTN","ORWDXR01",49,0)
 S PICKID=$O(^OR(100,+ORID,4.5,"ID","PICKUP",0))
"RTN","ORWDXR01",50,0)
 S:$D(^OR(100,+ORID,4.5,REFID,1)) ^(1)=PARM1
"RTN","ORWDXR01",51,0)
 S:$D(^OR(100,+ORID,4.5,PICKID,1)) ^(1)=PARM2
"RTN","ORWDXR01",52,0)
 S IX=0 F  S IX=$O(^OR(100,+ORID,8,ACT,.1,IX)) Q:('IX)!(NDQUIT)  D
"RTN","ORWDXR01",53,0)
 . S TXT=$G(^OR(100,+ORID,8,ACT,.1,IX,0))
"RTN","ORWDXR01",54,0)
 . I ($$UP^XLFSTR(TXT)["QUANTITY:"),($$UP^XLFSTR(TXT)["REFILLS:") D
"RTN","ORWDXR01",55,0)
 . . S REFPOS=$F($$UP^XLFSTR(TXT),"REFILLS")-$L("REFILLS")-1
"RTN","ORWDXR01",56,0)
 . . S TXT=$E(TXT,1,REFPOS)_"Refills: "_PARM1
"RTN","ORWDXR01",57,0)
 . . S ^OR(100,+ORID,8,ACT,.1,IX,0)=TXT,NDQUIT=1 Q
"RTN","ORWDXR01",58,0)
 D GETBYIFN^ORWORR(.ORY,+ORID)
"RTN","ORWDXR01",59,0)
 Q
"RTN","ORWDXR01",60,0)
 ;
"RTN","ORWDXR01",61,0)
TXTSAV(ORY,ORID,PARM1,PARM2) ;
"RTN","ORWDXR01",62,0)
 ; Update new start and stop date for the unsigned unreleased
"RTN","ORWDXR01",63,0)
 ; renewed text order
"RTN","ORWDXR01",64,0)
 N STRTID,STOPID
"RTN","ORWDXR01",65,0)
 S STRTID=$O(^OR(100,+ORID,4.5,"ID","START",0))
"RTN","ORWDXR01",66,0)
 S STOPID=$O(^OR(100,+ORID,4.5,"ID","STOP",0))
"RTN","ORWDXR01",67,0)
 S:$D(^OR(100,+ORID,4.5,STRTID,1)) ^(1)=PARM1
"RTN","ORWDXR01",68,0)
 S:$D(^OR(100,+ORID,4.5,STOPID,1)) ^(1)=PARM2
"RTN","ORWDXR01",69,0)
 D GETBYIFN^ORWORR(.ORY,+ORID)
"RTN","ORWDXR01",70,0)
 Q
"RTN","ORWDXR01",71,0)
 ;
"RTN","ORWDXR01",72,0)
ISSPLY(ORY,DLGID,QODLG) ;
"RTN","ORWDXR01",73,0)
 ; ORY=1: is "PSO SUPPLY" dialog
"RTN","ORWDXR01",74,0)
 S ORY=""
"RTN","ORWDXR01",75,0)
 Q:'$D(^ORD(101.41,DLGID,0))
"RTN","ORWDXR01",76,0)
 I 'QODLG,($P(^ORD(101.41,DLGID,0),U)="PSO SUPPLY") S ORY=1
"RTN","ORWDXR01",77,0)
 I QODLG D
"RTN","ORWDXR01",78,0)
 . N SPLYDG S SPLYDG=$O(^ORD(100.98,"B","SPLY",0))
"RTN","ORWDXR01",79,0)
 . I $P(^ORD(101.41,DLGID,0),U,5)=SPLYDG S ORY=1
"RTN","ORWDXR01",80,0)
 Q
"RTN","ORWDXR01",81,0)
 ;
"RTN","ORWDXR01",82,0)
OXDATA(ORY,ORIEN) ; Return orderable item data for order check usage
"RTN","ORWDXR01",83,0)
 Q:'$D(^OR(100,+ORIEN,0))
"RTN","ORWDXR01",84,0)
 D MAYBEIV(.ORY,ORIEN,1) I $L($G(ORY))>1 Q
"RTN","ORWDXR01",85,0)
 N DRUGID,OIID,IDX,IDY,DISPIN,DISPOUT,DISPID
"RTN","ORWDXR01",86,0)
 S (DRUGID,OIID,IDX,IDY,DISPIN,DISPOUT)=0
"RTN","ORWDXR01",87,0)
 S DISPID=""
"RTN","ORWDXR01",88,0)
 S DISPIN=$O(^ORD(100.98,"B","UD RX",0))
"RTN","ORWDXR01",89,0)
 S DISPOUT=$O(^ORD(100.98,"B","O RX",0))
"RTN","ORWDXR01",90,0)
 N DISPCM S DISPCM=$O(^ORD(100.98,"B","CLINIC ORDERS",0))
"RTN","ORWDXR01",91,0)
 S DRUGID=$O(^OR(100,+ORIEN,4.5,"ID","DRUG",0))
"RTN","ORWDXR01",92,0)
 S OIID=$O(^OR(100,+ORIEN,4.5,"ID","ORDERABLE",0))
"RTN","ORWDXR01",93,0)
 S DISPID=$P(^OR(100,+ORIEN,0),U,11)
"RTN","ORWDXR01",94,0)
 I DISPID=DISPIN S DISPID="PSI"
"RTN","ORWDXR01",95,0)
 I DISPID=DISPOUT S DISPID="PSO"
"RTN","ORWDXR01",96,0)
 I DISPID=DISPCM S DISPID="PSI"
"RTN","ORWDXR01",97,0)
 I (DISPID'="PSI"),(DISPID'="PSO") Q
"RTN","ORWDXR01",98,0)
 I 'DRUGID,DISPID="PSI" D
"RTN","ORWDXR01",99,0)
 .N ORCHI S ORCHI=0 F  S ORCHI=$O(^OR(100,+ORIEN,2,ORCHI)) Q:'ORCHI  D
"RTN","ORWDXR01",100,0)
 ..N ORCHDRID,ORCHOIID,ORCHIDX,ORCHIDY
"RTN","ORWDXR01",101,0)
 ..S ORCHDRID=$O(^OR(100,+ORCHI,4.5,"ID","DRUG",0))
"RTN","ORWDXR01",102,0)
 ..S ORCHOIID=$O(^OR(100,+ORCHI,4.5,"ID","ORDERABLE",0))
"RTN","ORWDXR01",103,0)
 ..Q:'ORCHDRID
"RTN","ORWDXR01",104,0)
 ..Q:'ORCHOIID
"RTN","ORWDXR01",105,0)
 ..S ORCHIDX=$O(^OR(100,+ORCHI,4.5,ORCHDRID,0))
"RTN","ORWDXR01",106,0)
 ..S ORCHIDY=$O(^OR(100,+ORCHI,4.5,ORCHOIID,0))
"RTN","ORWDXR01",107,0)
 ..I ORCHIDX,ORCHIDY S ORY=$G(^OR(100,+ORCHI,4.5,ORCHOIID,ORCHIDY))_U_DISPID_U_$G(^OR(100,+ORCHI,4.5,ORCHDRID,ORCHIDX))_"|"_$G(ORY)
"RTN","ORWDXR01",108,0)
 Q:'DRUGID
"RTN","ORWDXR01",109,0)
 Q:'OIID
"RTN","ORWDXR01",110,0)
 S IDX=$O(^OR(100,+ORIEN,4.5,DRUGID,0))
"RTN","ORWDXR01",111,0)
 S IDY=$O(^OR(100,+ORIEN,4.5,OIID,0))
"RTN","ORWDXR01",112,0)
 I IDX,IDY,'+DISPID S ORY=$G(^OR(100,+ORIEN,4.5,OIID,IDY))_U_DISPID_U_$G(^OR(100,+ORIEN,4.5,DRUGID,IDX))
"RTN","ORWDXR01",113,0)
 Q
"RTN","ORWDXR01",114,0)
 ;
"RTN","ORWDXR01",115,0)
MAYBEIV(ORY,ORIEN,FORMAT) ; Return orderable item data for iv order check usage
"RTN","ORWDXR01",116,0)
 ;PARAMETERS: ORY   => REFERENCE TO ARRAY THAT STORES ORDERABLE ITEM DATA
"RTN","ORWDXR01",117,0)
 ;            ORIEN => ORDER NUMBER FROM ORDER FILE (#100)
"RTN","ORWDXR01",118,0)
 ;            FORMAT => FLAG DENOTING WHICH FORMAT TO RETURN THE DATA IN:
"RTN","ORWDXR01",119,0)
 ;                      NULL OR ZERO - NEW FORMAT (USING PIPE DELMITER)
"RTN","ORWDXR01",120,0)
 ;                      1 - OLD FORMAT (USING CAROT DELIMITER)
"RTN","ORWDXR01",121,0)
 N X0,ORDIALOG,DELIMIT
"RTN","ORWDXR01",122,0)
 S DELIMIT=$S($G(FORMAT):"|",1:U)
"RTN","ORWDXR01",123,0)
 S X0=^OR(100,+ORIEN,0)
"RTN","ORWDXR01",124,0)
 S ORDIALOG=+$P(X0,U,5)
"RTN","ORWDXR01",125,0)
 D GETDLG^ORCD(ORDIALOG)
"RTN","ORWDXR01",126,0)
 D GETORDER^ORCD(+ORIEN)
"RTN","ORWDXR01",127,0)
 I $D(ORDIALOG("B","SOLUTION")) D
"RTN","ORWDXR01",128,0)
 .N ORI,ORSUB
"RTN","ORWDXR01",129,0)
 .S ORSUB=$P(ORDIALOG("B","SOLUTION"),U,2)
"RTN","ORWDXR01",130,0)
 .S ORI=0 F  S ORI=$O(ORDIALOG(ORSUB,ORI)) Q:'ORI  D
"RTN","ORWDXR01",131,0)
 ..S:DELIMIT="|" ORY=$G(ORY)_"|"_$G(ORDIALOG(ORSUB,ORI))_U_"PSIV"_U_"B;"
"RTN","ORWDXR01",132,0)
 ..S:DELIMIT=U ORY=$G(ORY)_U_$G(ORDIALOG(ORSUB,ORI))_"|"_"PSIV"_"|"_ORSUB_"||"_ORIEN_"||"_"B"
"RTN","ORWDXR01",133,0)
 I $D(ORDIALOG("B","ADDITIVE")) D
"RTN","ORWDXR01",134,0)
 .N ORI,ORSUB
"RTN","ORWDXR01",135,0)
 .S ORSUB=$P(ORDIALOG("B","ADDITIVE"),U,2)
"RTN","ORWDXR01",136,0)
 .S ORI=0 F  S ORI=$O(ORDIALOG(ORSUB,ORI)) Q:'ORI  D
"RTN","ORWDXR01",137,0)
 ..S:DELIMIT="|" ORY=$G(ORY)_"|"_$G(ORDIALOG(ORSUB,ORI))_U_"PSIV"_U_"A"
"RTN","ORWDXR01",138,0)
 ..S:DELIMIT=U ORY=$G(ORY)_U_$G(ORDIALOG(ORSUB,ORI))_"|"_"PSIV"_"|"_ORSUB_"||"_ORIEN_"||"_"A"
"RTN","ORWDXR01",139,0)
 I $L($G(ORY),DELIMIT)>1 S ORY=$P(ORY,DELIMIT,2,$L(ORY,DELIMIT))
"RTN","ORWDXR01",140,0)
 Q
"RTN","ORWDXR01",141,0)
 ;
"RTN","ORWPT")
0^11^B64148022
"RTN","ORWPT",1,0)
ORWPT ; SLC/KCM/REV - Patient Lookup Functions ;03/26/13  09:06
"RTN","ORWPT",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,132,149,206,187,190,215,243,280,306,311**;Dec 17, 1997;Build 30
"RTN","ORWPT",3,0)
 ;
"RTN","ORWPT",4,0)
 ; Ref. to ^UTILITY via IA 10061
"RTN","ORWPT",5,0)
 ;
"RTN","ORWPT",6,0)
IDINFO(REC,DFN) ; Return identifying information for a patient
"RTN","ORWPT",7,0)
 ; PID^DOB^SEX^VET^SC%^WARD^RM-BED^NAME
"RTN","ORWPT",8,0)
 N X0,X1,X101,X3,XV  ; name/dob/sex/ssn, ward, room-bed, sc%, vet
"RTN","ORWPT",9,0)
 S X0=$G(^DPT(DFN,0)),X1=$G(^(.1)),X101=$G(^(.101)),X3=$G(^(.3)),XV=$G(^("VET"))
"RTN","ORWPT",10,0)
 S REC=$$SSN^DPTLK1(DFN)_U_$$DOB^DPTLK1(DFN,2)_U_$P(X0,U,2)_U_$P(XV,U)_U_$P(X3,U,2)_U_$P(X1,U)_U_$P(X101,U)_U_$P(X0,U) ;DG249
"RTN","ORWPT",11,0)
 Q
"RTN","ORWPT",12,0)
PTINQ(REF,DFN) ; Return formatted pt inquiry report
"RTN","ORWPT",13,0)
 K ^TMP("ORDATA",$J,1)
"RTN","ORWPT",14,0)
 D DGINQ^ORCXPND1(DFN)
"RTN","ORWPT",15,0)
 S REF=$NA(^TMP("ORDATA",$J,1))
"RTN","ORWPT",16,0)
 Q
"RTN","ORWPT",17,0)
SCDIS(LST,DFN) ; Return service connected % and rated disabilities
"RTN","ORWPT",18,0)
 N VAEL,VAERR,I,ILST,DIS,SC,X
"RTN","ORWPT",19,0)
 D ELIG^VADPT
"RTN","ORWPT",20,0)
 S LST(1)="Service Connected: "_$S(+VAEL(3):$P(VAEL(3),U,2)_"%",1:"NO")
"RTN","ORWPT",21,0)
 I 'VAEL(4),'$P($G(^DG(391,+VAEL(6),0)),U,2) S LST(2)="NOT A VETERAN." Q
"RTN","ORWPT",22,0)
 S I=0,ILST=1 F  S I=$O(^DPT(DFN,.372,I)) Q:'I  S X=^(I,0) D
"RTN","ORWPT",23,0)
 . S DIS=$P($G(^DIC(31,+X,0)),U) Q:DIS=""
"RTN","ORWPT",24,0)
 . S SC=$S($P(X,U,3):"SC",$P(X,U,3)']"":"not specified",1:"NSC")
"RTN","ORWPT",25,0)
 . S ILST=ILST+1,LST(ILST)=DIS_" ("_$P(X,U,2)_"% "_SC_")"
"RTN","ORWPT",26,0)
 I ILST=1 S LST(2)="Rated Disabilities: NONE STATED"
"RTN","ORWPT",27,0)
 Q
"RTN","ORWPT",28,0)
SHOW ; temporary - show patient inquiry screen
"RTN","ORWPT",29,0)
 N I,Y,DIC S DIC=2,DIC(0)="AEMQ" D ^DIC Q:'Y
"RTN","ORWPT",30,0)
 K ^TMP("ORDATA",$J,1)
"RTN","ORWPT",31,0)
 D DGINQ^ORCXPND1(+Y)
"RTN","ORWPT",32,0)
 S I=0 F  S I=$O(^TMP("ORDATA",$J,1,I)) Q:'I  W !,^(I)
"RTN","ORWPT",33,0)
 K ^TMP("ORDATA",$J,1)
"RTN","ORWPT",34,0)
 Q
"RTN","ORWPT",35,0)
SELCHK(REC,DFN) ; Check for sensitive pt
"RTN","ORWPT",36,0)
 ; SENSITIVE
"RTN","ORWPT",37,0)
 S REC=$$EN1^ORQPT2(DFN)
"RTN","ORWPT",38,0)
 Q
"RTN","ORWPT",39,0)
DIEDON(VAL,DFN) ; Check for a date of death
"RTN","ORWPT",40,0)
 S VAL=+$G(^DPT(DFN,.35))
"RTN","ORWPT",41,0)
 Q
"RTN","ORWPT",42,0)
SELECT(REC,DFN) ; Selects patient & returns key information
"RTN","ORWPT",43,0)
 ;  1    2   3   4    5      6    7    8       9       10      11  12
"RTN","ORWPT",44,0)
 ; NAME^SEX^DOB^SSN^LOCIEN^LOCNM^RMBD^CWAD^SENSITIVE^ADMITTED^CONV^SC^
"RTN","ORWPT",45,0)
 ; 13  14  15  16  17
"RTN","ORWPT",46,0)
 ; SC%^ICN^AGE^TS^TSSVC
"RTN","ORWPT",47,0)
 ;
"RTN","ORWPT",48,0)
 ; for CCOW (RV - 2/27/03)  name="-1", location=error message
"RTN","ORWPT",49,0)
 I '$D(^DPT(+DFN,0)) S REC="-1^^^^^Patient is unknown to CPRS." Q
"RTN","ORWPT",50,0)
 ;
"RTN","ORWPT",51,0)
 N X
"RTN","ORWPT",52,0)
 I $G(XWB("2","RPC"))="ORWPT SELECT" K ^TMP($J,"OC-OPOS") ; delete once per order session order checks
"RTN","ORWPT",53,0)
 K ^TMP("ORWPCE",$J) ; delete PCE 'cache' when switching patients
"RTN","ORWPT",54,0)
 S X=^DPT(DFN,0),REC=$P(X,U,1,3)_U_$P(X,U,9)_U_U_$G(^(.1))_U_$G(^(.101))
"RTN","ORWPT",55,0)
 S X=$P(REC,U,6) I $L(X) S $P(REC,U,5)=+$G(^DIC(42,+$O(^DIC(42,"B",X,0)),44))
"RTN","ORWPT",56,0)
 S $P(REC,U,8)=$$CWAD^ORQPT2(DFN)_U_$$EN1^ORQPT2(DFN)
"RTN","ORWPT",57,0)
 ; I $P(REC,U,9) D EN2^ORQPT2(DFN)  ;update DG security log ; DG249
"RTN","ORWPT",58,0)
 S X=$G(^DPT(DFN,.105)) I X S $P(REC,U,10)=$P($G(^DGPM(X,0)),U)
"RTN","ORWPT",59,0)
 S:'$D(IOST) IOST="P-OTHER"
"RTN","ORWPT",60,0)
 S $P(REC,U,11)=0
"RTN","ORWPT",61,0)
 D ELIG^VADPT S $P(REC,U,12)=$G(VAEL(3)) ;two pieces: SC^SC%
"RTN","ORWPT",62,0)
 I $L($T(GETICN^MPIF001)) S X=+$$GETICN^MPIF001(DFN) S:X>0 $P(REC,U,14)=X
"RTN","ORWPT",63,0)
 S $P(REC,U,15)=$$AGE(DFN,$P(REC,U,3))
"RTN","ORWPT",64,0)
 S $P(REC,U,16)=+$G(^DPT(DFN,.103)) ; treating specialty
"RTN","ORWPT",65,0)
 I +$P(REC,U,16)>0 D
"RTN","ORWPT",66,0)
 . N X,Y,Z
"RTN","ORWPT",67,0)
 . S (X,Y)=""
"RTN","ORWPT",68,0)
 . S X=$$TSDATA^DGACT(45.7,+$P(REC,U,16),.Y,"")
"RTN","ORWPT",69,0)
 . I +X,+$P($G(Y(2)),U,1)>0 S (X,Z)="" S X=$$TSDATA^DGACT(42.4,+$P($G(Y(2)),U,1),.Z,"")
"RTN","ORWPT",70,0)
 . I +X S $P(REC,U,17)=$P($G(Z(3)),U,1) ; treating  specialty service
"RTN","ORWPT",71,0)
 K VAEL,VAERR ;VADPT call to kill?
"RTN","ORWPT",72,0)
 S ^DISV(DUZ,"^DPT(")=DFN
"RTN","ORWPT",73,0)
 Q
"RTN","ORWPT",74,0)
SHARE(VAL,IP,HWND,DFN) ; Set global to share DFN with other applications
"RTN","ORWPT",75,0)
 K ^TMP("ORWCHART",$J),^TMP("ORECALL",$J),^TMP("ORWORD",$J)
"RTN","ORWPT",76,0)
 K ^TMP("ORWDXMQ",$J)
"RTN","ORWPT",77,0)
 S ^TMP("ORWCHART",$J,IP,HWND)=DFN
"RTN","ORWPT",78,0)
 Q
"RTN","ORWPT",79,0)
BYWARD(LST,WARD) ; Return a list of patients in a ward
"RTN","ORWPT",80,0)
 N ILST,DFN
"RTN","ORWPT",81,0)
 I +$G(WARD)<1 S LST(1)="^No ward identified" Q
"RTN","ORWPT",82,0)
 S (ILST,DFN)=0
"RTN","ORWPT",83,0)
 S WARD=$P(^DIC(42,WARD,0),"^")   ;DBIA #36
"RTN","ORWPT",84,0)
 F  S DFN=$O(^DPT("CN",WARD,DFN)) Q:DFN'>0  D
"RTN","ORWPT",85,0)
 . S ILST=ILST+1,LST(ILST)=+DFN_U_$P(^DPT(+DFN,0),U)_U_$G(^DPT(+DFN,.101))
"RTN","ORWPT",86,0)
 I ILST<1 S LST(1)="^No patients found."
"RTN","ORWPT",87,0)
 Q
"RTN","ORWPT",88,0)
LAST5(LST,ID) ; Return a list of patients matching A9999 identifiers
"RTN","ORWPT",89,0)
 N I,IEN,XREF
"RTN","ORWPT",90,0)
 S (I,IEN)=0,XREF=$S($L(ID)=5:"BS5",1:"BS")
"RTN","ORWPT",91,0)
 F  S IEN=$O(^DPT(XREF,ID,IEN)) Q:'IEN  D
"RTN","ORWPT",92,0)
 . S I=I+1,LST(I)=IEN_U_$P(^DPT(IEN,0),U)_U_$$DOB^DPTLK1(IEN,2)_U_$$SSN^DPTLK1(IEN)  ; DG249
"RTN","ORWPT",93,0)
 Q
"RTN","ORWPT",94,0)
 ;
"RTN","ORWPT",95,0)
LAST5RPL(LST,ID) ; ; Return list matching A9999 id's, but from RPL only.
"RTN","ORWPT",96,0)
 N ORRPL,ORCNT,ORPT,ORPIEN
"RTN","ORWPT",97,0)
 ; IA ____ allows read access to NEW PERSON file node 101:
"RTN","ORWPT",98,0)
 S ORRPL=$G(^VA(200,DUZ,101))
"RTN","ORWPT",99,0)
 S ORRPL=$P(ORRPL,U,2)
"RTN","ORWPT",100,0)
 I (('ORRPL)!(ORRPL="")) S LST(0)="" Q
"RTN","ORWPT",101,0)
 ;
"RTN","ORWPT",102,0)
 S (ORCNT,ORPT)=0
"RTN","ORWPT",103,0)
 F  S ORPT=$O(^OR(100.21,ORRPL,10,ORPT)) Q:'ORPT  D
"RTN","ORWPT",104,0)
 .S ORPIEN=+$G(^OR(100.21,ORRPL,10,ORPT,0))
"RTN","ORWPT",105,0)
 .I ((ORPIEN<0)!(ORPIEN="")) Q
"RTN","ORWPT",106,0)
 .S ORCNT=ORCNT+1
"RTN","ORWPT",107,0)
 .S LST(ORCNT)=ORPIEN_U_$P(^DPT(ORPIEN,0),U)_U_$$DOB^DPTLK1(ORPIEN,2)_U_$$SSN^DPTLK1(ORPIEN) ; DG249.
"RTN","ORWPT",108,0)
 ;
"RTN","ORWPT",109,0)
 Q
"RTN","ORWPT",110,0)
 ;
"RTN","ORWPT",111,0)
FULLSSN(LST,ID) ; Return a list of patients matching full SSN entered
"RTN","ORWPT",112,0)
 N I,IEN
"RTN","ORWPT",113,0)
 S (I,IEN)=0
"RTN","ORWPT",114,0)
 F  S IEN=$O(^DPT("SSN",ID,IEN)) Q:'IEN  D
"RTN","ORWPT",115,0)
 . S I=I+1,LST(I)=IEN_U_$P(^DPT(IEN,0),U)_U_$$DOB^DPTLK1(IEN,2)_U_$$SSN^DPTLK1(IEN)  ; DG249
"RTN","ORWPT",116,0)
 Q
"RTN","ORWPT",117,0)
 ;
"RTN","ORWPT",118,0)
FSSNRPL(LST,ID) ; Return list matching Full SSN, but from RPL only.
"RTN","ORWPT",119,0)
 N ORRPL,ORCNT,ORPT,ORLPT,ORPIEN
"RTN","ORWPT",120,0)
 ; IA ____ allows read access to NEW PERSON file node 101:
"RTN","ORWPT",121,0)
 S ORRPL=$G(^VA(200,DUZ,101))
"RTN","ORWPT",122,0)
 S ORRPL=$P(ORRPL,U,2)
"RTN","ORWPT",123,0)
 I (('ORRPL)!(ORRPL="")) S LST(0)="" Q
"RTN","ORWPT",124,0)
 ;
"RTN","ORWPT",125,0)
 S (ORCNT,ORPT)=0
"RTN","ORWPT",126,0)
 F  S ORPT=$O(^DPT("SSN",ID,ORPT)) Q:'ORPT  D
"RTN","ORWPT",127,0)
 .S ORLPT=0
"RTN","ORWPT",128,0)
 .F  S ORLPT=$O(^OR(100.21,ORRPL,10,ORLPT)) Q:'ORLPT  D
"RTN","ORWPT",129,0)
 ..S ORPIEN=+$G(^OR(100.21,ORRPL,10,ORLPT,0))
"RTN","ORWPT",130,0)
 ..I ((ORPIEN<0)!(ORPIEN="")) Q
"RTN","ORWPT",131,0)
 ..I (ORPIEN'=ORPT) Q
"RTN","ORWPT",132,0)
 ..S ORCNT=ORCNT+1
"RTN","ORWPT",133,0)
 ..S LST(ORCNT)=ORPIEN_U_$P(^DPT(ORPIEN,0),U)_U_$$DOB^DPTLK1(ORPIEN,2)_U_$$SSN^DPTLK1(ORPIEN) ; DG249.
"RTN","ORWPT",134,0)
 ;
"RTN","ORWPT",135,0)
 Q
"RTN","ORWPT",136,0)
 ;
"RTN","ORWPT",137,0)
TOP(LST) ; Return top for all patients list (last selected for now)
"RTN","ORWPT",138,0)
 N IEN
"RTN","ORWPT",139,0)
 S IEN=$G(^DISV(DUZ,"^DPT("))
"RTN","ORWPT",140,0)
 I IEN S LST(1)=IEN_U_$P($G(^DPT(IEN,0)),U)
"RTN","ORWPT",141,0)
 Q
"RTN","ORWPT",142,0)
ENCTITL(REC,DFN,LOC,PROV) ; Return external values for encounter
"RTN","ORWPT",143,0)
 ; LOCNAME^LOCABBR^ROOMBED^PROVNAME
"RTN","ORWPT",144,0)
 S $P(REC,U,1)=$P($G(^SC(+LOC,0)),U,1,2)
"RTN","ORWPT",145,0)
 S $P(REC,U,3)=$P($G(^DPT(DFN,.101)),U)
"RTN","ORWPT",146,0)
 S $P(REC,U,4)=$P($G(^VA(200,+PROV,0)),U)
"RTN","ORWPT",147,0)
 Q
"RTN","ORWPT",148,0)
LISTALL(Y,FROM,DIR) ; Return a bolus of patient names.  From is either Name or IEN^Name.
"RTN","ORWPT",149,0)
 N I,IEN,CNT,FROMIEN,ORIDNAME S CNT=44,I=0,FROMIEN=0
"RTN","ORWPT",150,0)
 I $P(FROM,U,2)'="" S FROMIEN=$P(FROM,U,1),FROM=$O(^DPT("B",$P(FROM,U,2)),-DIR)
"RTN","ORWPT",151,0)
 F  S FROM=$O(^DPT("B",FROM),DIR) Q:FROM=""  D  Q:I=CNT
"RTN","ORWPT",152,0)
 . S IEN=FROMIEN,FROMIEN=0 F  S IEN=$O(^DPT("B",FROM,IEN)) Q:'IEN  D  Q:I=CNT
"RTN","ORWPT",153,0)
 . . S ORIDNAME=""
"RTN","ORWPT",154,0)
 . . S ORIDNAME=$G(^DPT(IEN,0)) ; Get zero node name.
"RTN","ORWPT",155,0)
 . . ; S X1=$G(^DPT(IEN,.1))_" "_$G(^DPT(IEN,.101))
"RTN","ORWPT",156,0)
 . . S I=I+1 S Y(I)=IEN_U_FROM_U_U_U_U_$P(ORIDNAME,U) ;_"^"_X ; _"^"_X1  ;"   ("_X_")"
"RTN","ORWPT",157,0)
 Q
"RTN","ORWPT",158,0)
APPTLST(LST,DFN) ; return a list of appointments
"RTN","ORWPT",159,0)
 ; APPTTIME^LOCIEN^LOCNAME^EXTSTATUS
"RTN","ORWPT",160,0)
 N ERR,ERRMSG,VASD,VAERR K ^UTILITY("VASD",$J)  ;IA 10061
"RTN","ORWPT",161,0)
 S VASD("F")=$$HTFM^XLFDT($H-30,1)
"RTN","ORWPT",162,0)
 S VASD("T")=$$HTFM^XLFDT($H+1,1)_".2359"
"RTN","ORWPT",163,0)
 S VASD("W")="123456789"
"RTN","ORWPT",164,0)
 D SDA^ORQRY01(.ERR,.ERRMSG)
"RTN","ORWPT",165,0)
 I ERR K ^UTILITY("VASD",$J) K LST S LST(1)=ERRMSG Q
"RTN","ORWPT",166,0)
 S I=0 F  S I=$O(^UTILITY("VASD",$J,I)) Q:'I  D
"RTN","ORWPT",167,0)
 . S LST(I)=$P(^UTILITY("VASD",$J,I,"I"),U,1,2)_U_$P(^("E"),U,2,3)
"RTN","ORWPT",168,0)
 K ^UTILITY("VASD",$J)
"RTN","ORWPT",169,0)
 Q
"RTN","ORWPT",170,0)
ADMITLST(LST,DFN) ; return a list of admissions
"RTN","ORWPT",171,0)
 ; MOVETIME^LOCIEN^LOCNAME^TYPE
"RTN","ORWPT",172,0)
 N TIM,MOV,X0,Y,MTIM,XTYP,XLOC,HLOC,ILST S ILST=0
"RTN","ORWPT",173,0)
 S TIM="" F  S TIM=$O(^DGPM("ATID1",DFN,TIM)) Q:TIM'>0  D
"RTN","ORWPT",174,0)
 . S MOV=0  F  S MOV=$O(^DGPM("ATID1",DFN,TIM,MOV)) Q:MOV'>0  D
"RTN","ORWPT",175,0)
 . . N VSTR,TIUDA
"RTN","ORWPT",176,0)
 . . S X0=$G(^DGPM(MOV,0)) I X0']"" Q
"RTN","ORWPT",177,0)
 . . S MTIM=$P(X0,U)
"RTN","ORWPT",178,0)
 . . S XTYP=$P($G(^DG(405.1,+$P(X0,U,4),0)),U,1)
"RTN","ORWPT",179,0)
 . . S XLOC=$P($G(^DIC(42,+$P(X0,U,6),0)),U,1),HLOC=+$G(^(44))
"RTN","ORWPT",180,0)
 . . S VSTR=HLOC_";"_MTIM_";H",TIUDA=$$HASDS^TIULX(DFN,VSTR)
"RTN","ORWPT",181,0)
 . . S ILST=ILST+1,LST(ILST)=MTIM_U_HLOC_U_XLOC_U_XTYP_U_MOV_U_TIUDA
"RTN","ORWPT",182,0)
 Q
"RTN","ORWPT",183,0)
CLINRNG(LST) ; return date ranges for clinic appointments
"RTN","ORWPT",184,0)
 S LST(1)="T;T^Today"
"RTN","ORWPT",185,0)
 S LST(2)="T+1;T+1^Tomorrow"
"RTN","ORWPT",186,0)
 S LST(3)="T-1;T-1^Yesterday"
"RTN","ORWPT",187,0)
 S LST(4)="T-7;T^Past Week"
"RTN","ORWPT",188,0)
 S LST(5)="T-31;T^Past Month"
"RTN","ORWPT",189,0)
 S LST(6)="S^Specify Date Range..."
"RTN","ORWPT",190,0)
 Q
"RTN","ORWPT",191,0)
 ;
"RTN","ORWPT",192,0)
 N %,%H,X,SUNDAY,START
"RTN","ORWPT",193,0)
 S LST(1)=DT_";"_DT_"^Today",X=$$HTFM^XLFDT($H+1,1)
"RTN","ORWPT",194,0)
 S LST(2)=X_";"_X_"^Tomorrow"
"RTN","ORWPT",195,0)
 S X=+$H F  Q:X#7=3  S X=X-1                        ; $H#7=3 is Sunday
"RTN","ORWPT",196,0)
 S LST(3)=$$HTFM^XLFDT(X)_";"_$$HTFM^XLFDT(X+6)_"^This Week"
"RTN","ORWPT",197,0)
 S LST(4)=$$HTFM^XLFDT(X+7)_";"_$$HTFM^XLFDT(X+13)_"^Next Week"
"RTN","ORWPT",198,0)
 S LST(5)=$E(DT,1,5)_"01;"_$E(DT,1,5)_"31^This Month"
"RTN","ORWPT",199,0)
 S X=$E(DT,4,5)+1 S:X=13 X=1 S X=$E(DT,1,3)_$TR($J(X,2)," ",0)
"RTN","ORWPT",200,0)
 S LST(6)=X_"01;"_X_"31^Next Month"
"RTN","ORWPT",201,0)
 S LST(7)="^Specify Dates"
"RTN","ORWPT",202,0)
 Q
"RTN","ORWPT",203,0)
DFLTSRC(VAL) ; return default patient list source (T, W, C, P, S)
"RTN","ORWPT",204,0)
 N SRV S SRV=+$G(^VA(200,DUZ,5))
"RTN","ORWPT",205,0)
 S VAL=$$GET^XPAR("ALL^SRV.`"_SRV,"ORLP DEFAULT LIST SOURCE")
"RTN","ORWPT",206,0)
 Q
"RTN","ORWPT",207,0)
SAVDFLT(OK,X) ; save new default patient list settings (X=type^ien^sdt;edt)
"RTN","ORWPT",208,0)
 G SAVDFLT^ORWPT1
"RTN","ORWPT",209,0)
 ;
"RTN","ORWPT",210,0)
DISCHRG(Y,DFN,ADMITDT) ; Get discharge movement information
"RTN","ORWPT",211,0)
 N VAIP
"RTN","ORWPT",212,0)
 I +$G(ADMITDT)=0 S Y=DT Q
"RTN","ORWPT",213,0)
 S VAIP("D")=ADMITDT D 52^VADPT
"RTN","ORWPT",214,0)
 I +VAIP(17)=0 S Y=DT Q
"RTN","ORWPT",215,0)
 S Y=+VAIP(17,1)
"RTN","ORWPT",216,0)
 Q
"RTN","ORWPT",217,0)
CWAD(Y,DFN) ;  returns CWAD flags for a patient
"RTN","ORWPT",218,0)
 S Y=$$CWAD^ORQPT2(DFN)
"RTN","ORWPT",219,0)
 Q
"RTN","ORWPT",220,0)
LEGACY(ORLST,DFN) ; return message if data on the legacy system
"RTN","ORWPT",221,0)
 ; ORLST(0)=1 if data,  ORLST(n)=display message if data
"RTN","ORWPT",222,0)
 S ORLST(0)=0
"RTN","ORWPT",223,0)
 I $L($T(HXDATA^A7RDPAGU)) D
"RTN","ORWPT",224,0)
 . D HXDATA^A7RDPAGU(.ORLST,DFN)
"RTN","ORWPT",225,0)
 . I $O(ORLST(0)) S ORLST(0)=1
"RTN","ORWPT",226,0)
 Q
"RTN","ORWPT",227,0)
INPLOC(REC,DFN) ; Return a patient's current location
"RTN","ORWPT",228,0)
 N X
"RTN","ORWPT",229,0)
 S X=$G(^DPT(DFN,.102)),REC=0
"RTN","ORWPT",230,0)
 I X S X=$P($G(^DGPM(X,0)),U,6)
"RTN","ORWPT",231,0)
 I X S REC=+$G(^DIC(42,X,44))
"RTN","ORWPT",232,0)
 I X S $P(REC,U,2)=$P($G(^DIC(42,X,0)),U,1)
"RTN","ORWPT",233,0)
 I X S X=$P($G(^DIC(42,X,0)),U,3)
"RTN","ORWPT",234,0)
 S $P(REC,U,3)=X
"RTN","ORWPT",235,0)
 Q
"RTN","ORWPT",236,0)
AGE(DFN,BEG) ; returns age based on date of birth and date of death (or DT)
"RTN","ORWPT",237,0)
 N END,X
"RTN","ORWPT",238,0)
 S END=+$G(^DPT(DFN,.35)),END=$S(END:END,1:DT)
"RTN","ORWPT",239,0)
 S X=$E(END,1,3)-$E(BEG,1,3)-($E(END,4,7)<$E(BEG,4,7))
"RTN","ORWPT",240,0)
 Q X
"RTN","ORWPT",241,0)
ROK(X) ; Routine OK (in UCI) (NDBI)
"RTN","ORWPT",242,0)
 S X=$G(X) Q:'$L(X) 0  Q:$L(X)>8 0  X ^%ZOSF("TEST") Q:$T 1  Q 0
"RTN","ORWPT",243,0)
 ;
"RTN","ORWPT",244,0)
 ;NDBI(X) ; National Database Integration site 1 = yes  0 = no
"RTN","ORWPT",245,0)
 ; N R,G S X="A7RDUP" X ^%ZOSF("TEST") S R=$T,G=$S($D(^A7RCP):1,1:0),X=R+G,X=$S(X=2:1,1:0) Q X
"RTN","ORY311")
0^13^B4599008
"RTN","ORY311",1,0)
ORY311 ;ISP/RFR - OR*3*311 POST-INSTALL ROUTINE;06/21/2013  08:27
"RTN","ORY311",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**311**;Dec 17, 1997;Build 30
"RTN","ORY311",3,0)
 Q
"RTN","ORY311",4,0)
POST ;POST-INSTALL ACTIONS
"RTN","ORY311",5,0)
 D MES^XPDUTL(" Setting the dosage order check to mandatory...")
"RTN","ORY311",6,0)
 D MAND
"RTN","ORY311",7,0)
 D MES^XPDUTL(" DONE")
"RTN","ORY311",8,0)
 ;
"RTN","ORY311",9,0)
MAND ;SET DOSAGE ORDER CHECK TO MANDATORY
"RTN","ORY311",10,0)
 ;Parameter is ORK EDITABLE BY USER
"RTN","ORY311",11,0)
 N ORERR,RETURN,ENTITY
"RTN","ORY311",12,0)
 S RETURN=$NA(^TMP($J,"ORPARAMS"))
"RTN","ORY311",13,0)
 K @RETURN
"RTN","ORY311",14,0)
 D ENVAL^XPAR(.RETURN,"ORK PROCESSING FLAG","DRUG DOSAGE",.ORERR,1)
"RTN","ORY311",15,0)
 I +ORERR>0 D  Q
"RTN","ORY311",16,0)
 .N ORTEXT
"RTN","ORY311",17,0)
 .S ORTEXT(1)=" Unable to set the DRUG DOSAGE order check to mandatory."
"RTN","ORY311",18,0)
 .S ORTEXT(2)=" Error encountered while retrieving values for the"
"RTN","ORY311",19,0)
 .S ORTEXT(3)=" ORK PROCESSING FLAG parameter:"
"RTN","ORY311",20,0)
 .S ORTEXT(4)=" "_$P(ORERR,U,2)
"RTN","ORY311",21,0)
 .S ORTEXT(5)=" Please log a Remedy ticket for assistance."
"RTN","ORY311",22,0)
 .D MES^XPDUTL(.ORTEXT)
"RTN","ORY311",23,0)
 S ENTITY="" F  S ENTITY=$O(^TMP($J,"ORPARAMS",ENTITY)) Q:$G(ENTITY)=""  D
"RTN","ORY311",24,0)
 .I ^TMP($J,"ORPARAMS",ENTITY,34)="D" D
"RTN","ORY311",25,0)
 ..D CHG^XPAR(ENTITY,"ORK PROCESSING FLAG","DRUG DOSAGE","E",.ORERR)
"RTN","ORY311",26,0)
 ..I +ORERR>0 D
"RTN","ORY311",27,0)
 ...N DIC,DO,ORTEXT
"RTN","ORY311",28,0)
 ...S DIC=U_$P(ENTITY,";",2)
"RTN","ORY311",29,0)
 ...D DO^DIC1
"RTN","ORY311",30,0)
 ...S ORTEXT(1)=" Error encountered while enabling the DRUG DOSAGE order check for"
"RTN","ORY311",31,0)
 ...S ORTEXT(2)=" the "_$$EXTERNAL^DILFD(8989.5,.01,,ENTITY,"ORERR")_" (#"_+ENTITY_") entry"
"RTN","ORY311",32,0)
 ...S ORTEXT(3)=" in the "_$P(DO,U)_" file:"
"RTN","ORY311",33,0)
 ...S ORTEXT(4)=" "_$P(ORERR,U,2)
"RTN","ORY311",34,0)
 ...S ORTEXT(5)=" Please log a Remedy ticket for assistance."
"RTN","ORY311",35,0)
 ...D MES^XPDUTL(.ORTEXT)
"RTN","ORY311",36,0)
 K ORERR,@RETURN
"RTN","ORY311",37,0)
 D EN^XPAR("SYS","ORK EDITABLE BY USER","DRUG DOSAGE","NO",.ORERR)
"RTN","ORY311",38,0)
 Q
"RTN","ORY311",39,0)
 ;
"VER")
8.0^22.0
**END**
**END**

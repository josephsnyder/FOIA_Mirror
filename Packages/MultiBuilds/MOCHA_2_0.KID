KIDS Distribution saved on Oct 10, 2012@15:15:20
MOCHA 2.0
**KIDS**:MOCHA 2.0 Combined Build 1.0^PSO*7.0*372^PSJ*5.0*252^OR*3.0*345^

**INSTALL NAME**
MOCHA 2.0 Combined Build 1.0
"BLD",7974,0)
MOCHA 2.0 Combined Build 1.0^^1^3121010^y
"BLD",7974,1,0)
^^1^1^3110311^
"BLD",7974,1,1,0)
This is the combined build for MOCHA 2.0.
"BLD",7974,6.3)
15
"BLD",7974,10,0)
^9.63^3^3
"BLD",7974,10,1,0)
PSO*7.0*372^1
"BLD",7974,10,2,0)
PSJ*5.0*252^1
"BLD",7974,10,3,0)
OR*3.0*345^1
"BLD",7974,10,"B","OR*3.0*345",3)

"BLD",7974,10,"B","PSJ*5.0*252",2)

"BLD",7974,10,"B","PSO*7.0*372",1)

"BLD",7974,"KRN",0)
^9.67PA^779.2^20
"BLD",7974,"KRN",.4,0)
.4
"BLD",7974,"KRN",.401,0)
.401
"BLD",7974,"KRN",.402,0)
.402
"BLD",7974,"KRN",.403,0)
.403
"BLD",7974,"KRN",.5,0)
.5
"BLD",7974,"KRN",.84,0)
.84
"BLD",7974,"KRN",3.6,0)
3.6
"BLD",7974,"KRN",3.8,0)
3.8
"BLD",7974,"KRN",9.2,0)
9.2
"BLD",7974,"KRN",9.8,0)
9.8
"BLD",7974,"KRN",19,0)
19
"BLD",7974,"KRN",19.1,0)
19.1
"BLD",7974,"KRN",101,0)
101
"BLD",7974,"KRN",409.61,0)
409.61
"BLD",7974,"KRN",771,0)
771
"BLD",7974,"KRN",779.2,0)
779.2
"BLD",7974,"KRN",870,0)
870
"BLD",7974,"KRN",8989.51,0)
8989.51
"BLD",7974,"KRN",8989.52,0)
8989.52
"BLD",7974,"KRN",8994,0)
8994
"BLD",7974,"KRN","B",.4,.4)

"BLD",7974,"KRN","B",.401,.401)

"BLD",7974,"KRN","B",.402,.402)

"BLD",7974,"KRN","B",.403,.403)

"BLD",7974,"KRN","B",.5,.5)

"BLD",7974,"KRN","B",.84,.84)

"BLD",7974,"KRN","B",3.6,3.6)

"BLD",7974,"KRN","B",3.8,3.8)

"BLD",7974,"KRN","B",9.2,9.2)

"BLD",7974,"KRN","B",9.8,9.8)

"BLD",7974,"KRN","B",19,19)

"BLD",7974,"KRN","B",19.1,19.1)

"BLD",7974,"KRN","B",101,101)

"BLD",7974,"KRN","B",409.61,409.61)

"BLD",7974,"KRN","B",771,771)

"BLD",7974,"KRN","B",779.2,779.2)

"BLD",7974,"KRN","B",870,870)

"BLD",7974,"KRN","B",8989.51,8989.51)

"BLD",7974,"KRN","B",8989.52,8989.52)

"BLD",7974,"KRN","B",8994,8994)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"VER")
8.0^22.0
**INSTALL NAME**
PSO*7.0*372
"BLD",7972,0)
PSO*7.0*372^OUTPATIENT PHARMACY^0^3121010^y
"BLD",7972,1,0)
^^19^19^3110428^
"BLD",7972,1,1,0)
This patch is part of a combined build that makes up the release of 
"BLD",7972,1,2,0)
MEDICATION ORDER CHECK HEALTHCARE APPLICATION (MOCHA) 2.0.
"BLD",7972,1,3,0)
 
"BLD",7972,1,4,0)
MOCHA 2.0 encompasses Pharmacy Data Management (PDM) patch PSS*1*160
"BLD",7972,1,5,0)
and a combined build for Outpatient Pharmacy patch PSO*7*372 and 
"BLD",7972,1,6,0)
Inpatient Medications patch PSJ*5*252.
"BLD",7972,1,7,0)
 
"BLD",7972,1,8,0)
This patch group adds dosing checks that implements a new system that uses
"BLD",7972,1,9,0)
data from First DataBank (FDB).  In this initial phase of dosing
"BLD",7972,1,10,0)
functionality, the Single Dose information will be displayed to
"BLD",7972,1,11,0)
the user.  The following scenarios describe the types of messaging added: 
"BLD",7972,1,12,0)
 
"BLD",7972,1,13,0)
  1. If the dosage entered passes the dosing checks, no message will be
"BLD",7972,1,14,0)
     displayed.
"BLD",7972,1,15,0)
  2. If the dosage entered is too high or too low, the Single Dose warning
"BLD",7972,1,16,0)
     message will be displayed.
"BLD",7972,1,17,0)
  3. If the dose checks were not able to be performed, a generic message
"BLD",7972,1,18,0)
     will be displayed notifying the user that a manual check needs to be
"BLD",7972,1,19,0)
     completed to verify appropriate dosing.
"BLD",7972,4,0)
^9.64PA^52.4^1
"BLD",7972,4,52.4,0)
52.4
"BLD",7972,4,52.4,2,0)
^9.641^52.4^1
"BLD",7972,4,52.4,2,52.4,0)
RX VERIFY  (File-top level)
"BLD",7972,4,52.4,2,52.4,1,0)
^9.6411^8^1
"BLD",7972,4,52.4,2,52.4,1,8,0)
DOSE WARNING
"BLD",7972,4,52.4,222)
y^y^p^^^^n^^n
"BLD",7972,4,52.4,224)

"BLD",7972,4,"APDD",52.4,52.4)

"BLD",7972,4,"APDD",52.4,52.4,8)

"BLD",7972,4,"B",52.4,52.4)

"BLD",7972,6.3)
54
"BLD",7972,"ABPKG")
n
"BLD",7972,"KRN",0)
^9.67PA^779.2^20
"BLD",7972,"KRN",.4,0)
.4
"BLD",7972,"KRN",.401,0)
.401
"BLD",7972,"KRN",.402,0)
.402
"BLD",7972,"KRN",.403,0)
.403
"BLD",7972,"KRN",.5,0)
.5
"BLD",7972,"KRN",.84,0)
.84
"BLD",7972,"KRN",3.6,0)
3.6
"BLD",7972,"KRN",3.8,0)
3.8
"BLD",7972,"KRN",9.2,0)
9.2
"BLD",7972,"KRN",9.8,0)
9.8
"BLD",7972,"KRN",9.8,"NM",0)
^9.68A^44^37
"BLD",7972,"KRN",9.8,"NM",1,0)
PSODOSU2^^0^B105360523
"BLD",7972,"KRN",9.8,"NM",2,0)
PSODOSUT^^0^B130396941
"BLD",7972,"KRN",9.8,"NM",5,0)
PSODOSUN^^0^B80758281
"BLD",7972,"KRN",9.8,"NM",7,0)
PSODIR^^0^B37531921
"BLD",7972,"KRN",9.8,"NM",9,0)
PSOLLL8^^0^B28829603
"BLD",7972,"KRN",9.8,"NM",10,0)
PSOLBLD^^0^B29870176
"BLD",7972,"KRN",9.8,"NM",11,0)
PSODDPR2^^0^B94187291
"BLD",7972,"KRN",9.8,"NM",12,0)
PSODDPR8^^0^B56882045
"BLD",7972,"KRN",9.8,"NM",13,0)
PSOBKDE1^^0^B5570079
"BLD",7972,"KRN",9.8,"NM",14,0)
PSODDPR4^^0^B117470989
"BLD",7972,"KRN",9.8,"NM",15,0)
PSOVER^^0^B88226703
"BLD",7972,"KRN",9.8,"NM",16,0)
PSOVER1^^0^B121964546
"BLD",7972,"KRN",9.8,"NM",17,0)
PSODDPRE^^0^B128090258
"BLD",7972,"KRN",9.8,"NM",18,0)
PSODGDGI^^0^B57055647
"BLD",7972,"KRN",9.8,"NM",19,0)
PSODGDG1^^0^B41929167
"BLD",7972,"KRN",9.8,"NM",20,0)
PSODGDGP^^0^B58836737
"BLD",7972,"KRN",9.8,"NM",21,0)
PSOORRD2^^0^B25093764
"BLD",7972,"KRN",9.8,"NM",22,0)
PSODDPR5^^0^B80336459
"BLD",7972,"KRN",9.8,"NM",23,0)
PSOORED3^^0^B59778178
"BLD",7972,"KRN",9.8,"NM",25,0)
PSOORED6^^0^B68287627
"BLD",7972,"KRN",9.8,"NM",27,0)
PSOORNEW^^0^B90508576
"BLD",7972,"KRN",9.8,"NM",28,0)
PSORENW0^^0^B83644019
"BLD",7972,"KRN",9.8,"NM",29,0)
PSODDPR3^^0^B102289019
"BLD",7972,"KRN",9.8,"NM",30,0)
PSONEW2^^0^B43830604
"BLD",7972,"KRN",9.8,"NM",31,0)
PSOORED4^^0^B55575437
"BLD",7972,"KRN",9.8,"NM",32,0)
PSOORFIN^^0^B64877046
"BLD",7972,"KRN",9.8,"NM",33,0)
PSOORNE1^^0^B72891193
"BLD",7972,"KRN",9.8,"NM",34,0)
PSOORED5^^0^B58202771
"BLD",7972,"KRN",9.8,"NM",35,0)
PSOORFI3^^0^B74671626
"BLD",7972,"KRN",9.8,"NM",36,0)
PSOORFI5^^0^B47045862
"BLD",7972,"KRN",9.8,"NM",37,0)
PSOLMAO^^0^B1901741
"BLD",7972,"KRN",9.8,"NM",39,0)
PSORXEDT^^0^B41063985
"BLD",7972,"KRN",9.8,"NM",40,0)
PSOCAN^^0^B50642727
"BLD",7972,"KRN",9.8,"NM",41,0)
PSOCAN2^^0^B82456941
"BLD",7972,"KRN",9.8,"NM",42,0)
PSOCAN3^^0^B71895056
"BLD",7972,"KRN",9.8,"NM",43,0)
PSOCAN1^^0^B60132005
"BLD",7972,"KRN",9.8,"NM",44,0)
PSODGDG2^^0^B14488972
"BLD",7972,"KRN",9.8,"NM","B","PSOBKDE1",13)

"BLD",7972,"KRN",9.8,"NM","B","PSOCAN",40)

"BLD",7972,"KRN",9.8,"NM","B","PSOCAN1",43)

"BLD",7972,"KRN",9.8,"NM","B","PSOCAN2",41)

"BLD",7972,"KRN",9.8,"NM","B","PSOCAN3",42)

"BLD",7972,"KRN",9.8,"NM","B","PSODDPR2",11)

"BLD",7972,"KRN",9.8,"NM","B","PSODDPR3",29)

"BLD",7972,"KRN",9.8,"NM","B","PSODDPR4",14)

"BLD",7972,"KRN",9.8,"NM","B","PSODDPR5",22)

"BLD",7972,"KRN",9.8,"NM","B","PSODDPR8",12)

"BLD",7972,"KRN",9.8,"NM","B","PSODDPRE",17)

"BLD",7972,"KRN",9.8,"NM","B","PSODGDG1",19)

"BLD",7972,"KRN",9.8,"NM","B","PSODGDG2",44)

"BLD",7972,"KRN",9.8,"NM","B","PSODGDGI",18)

"BLD",7972,"KRN",9.8,"NM","B","PSODGDGP",20)

"BLD",7972,"KRN",9.8,"NM","B","PSODIR",7)

"BLD",7972,"KRN",9.8,"NM","B","PSODOSU2",1)

"BLD",7972,"KRN",9.8,"NM","B","PSODOSUN",5)

"BLD",7972,"KRN",9.8,"NM","B","PSODOSUT",2)

"BLD",7972,"KRN",9.8,"NM","B","PSOLBLD",10)

"BLD",7972,"KRN",9.8,"NM","B","PSOLLL8",9)

"BLD",7972,"KRN",9.8,"NM","B","PSOLMAO",37)

"BLD",7972,"KRN",9.8,"NM","B","PSONEW2",30)

"BLD",7972,"KRN",9.8,"NM","B","PSOORED3",23)

"BLD",7972,"KRN",9.8,"NM","B","PSOORED4",31)

"BLD",7972,"KRN",9.8,"NM","B","PSOORED5",34)

"BLD",7972,"KRN",9.8,"NM","B","PSOORED6",25)

"BLD",7972,"KRN",9.8,"NM","B","PSOORFI3",35)

"BLD",7972,"KRN",9.8,"NM","B","PSOORFI5",36)

"BLD",7972,"KRN",9.8,"NM","B","PSOORFIN",32)

"BLD",7972,"KRN",9.8,"NM","B","PSOORNE1",33)

"BLD",7972,"KRN",9.8,"NM","B","PSOORNEW",27)

"BLD",7972,"KRN",9.8,"NM","B","PSOORRD2",21)

"BLD",7972,"KRN",9.8,"NM","B","PSORENW0",28)

"BLD",7972,"KRN",9.8,"NM","B","PSORXEDT",39)

"BLD",7972,"KRN",9.8,"NM","B","PSOVER",15)

"BLD",7972,"KRN",9.8,"NM","B","PSOVER1",16)

"BLD",7972,"KRN",19,0)
19
"BLD",7972,"KRN",19.1,0)
19.1
"BLD",7972,"KRN",101,0)
101
"BLD",7972,"KRN",409.61,0)
409.61
"BLD",7972,"KRN",771,0)
771
"BLD",7972,"KRN",779.2,0)
779.2
"BLD",7972,"KRN",870,0)
870
"BLD",7972,"KRN",8989.51,0)
8989.51
"BLD",7972,"KRN",8989.52,0)
8989.52
"BLD",7972,"KRN",8994,0)
8994
"BLD",7972,"KRN","B",.4,.4)

"BLD",7972,"KRN","B",.401,.401)

"BLD",7972,"KRN","B",.402,.402)

"BLD",7972,"KRN","B",.403,.403)

"BLD",7972,"KRN","B",.5,.5)

"BLD",7972,"KRN","B",.84,.84)

"BLD",7972,"KRN","B",3.6,3.6)

"BLD",7972,"KRN","B",3.8,3.8)

"BLD",7972,"KRN","B",9.2,9.2)

"BLD",7972,"KRN","B",9.8,9.8)

"BLD",7972,"KRN","B",19,19)

"BLD",7972,"KRN","B",19.1,19.1)

"BLD",7972,"KRN","B",101,101)

"BLD",7972,"KRN","B",409.61,409.61)

"BLD",7972,"KRN","B",771,771)

"BLD",7972,"KRN","B",779.2,779.2)

"BLD",7972,"KRN","B",870,870)

"BLD",7972,"KRN","B",8989.51,8989.51)

"BLD",7972,"KRN","B",8989.52,8989.52)

"BLD",7972,"KRN","B",8994,8994)

"BLD",7972,"QUES",0)
^9.62^^
"BLD",7972,"REQB",0)
^9.611^8^5
"BLD",7972,"REQB",2,0)
PSS*1.0*160^2
"BLD",7972,"REQB",5,0)
PSO*7.0*387^2
"BLD",7972,"REQB",6,0)
PSS*1.0*163^2
"BLD",7972,"REQB",7,0)
PSO*7.0*396^2
"BLD",7972,"REQB",8,0)
PSO*7.0*386^2
"BLD",7972,"REQB","B","PSO*7.0*386",8)

"BLD",7972,"REQB","B","PSO*7.0*387",5)

"BLD",7972,"REQB","B","PSO*7.0*396",7)

"BLD",7972,"REQB","B","PSS*1.0*160",2)

"BLD",7972,"REQB","B","PSS*1.0*163",6)

"FIA",52.4)
RX VERIFY
"FIA",52.4,0)
^PS(52.4,
"FIA",52.4,0,0)
52.4PI
"FIA",52.4,0,1)
y^y^p^^^^n^^n
"FIA",52.4,0,10)

"FIA",52.4,0,11)

"FIA",52.4,0,"RLRO")

"FIA",52.4,0,"VR")
7.0^PSO
"FIA",52.4,52.4)
1
"FIA",52.4,52.4,8)

"IX",52.4,52.4,"DW",0)
52.4^DW^DOSE WARNING^R^^R^IR^I^52.4^^^^^LS
"IX",52.4,52.4,"DW",1)
S ^PS(52.4,"DW",X(1),X(2),DA)=""
"IX",52.4,52.4,"DW",2)
K ^PS(52.4,"DW",X(1),X(2),DA)
"IX",52.4,52.4,"DW",2.5)
K ^PS(52.4,"DW")
"IX",52.4,52.4,"DW",11.1,0)
^.114IA^2^2
"IX",52.4,52.4,"DW",11.1,1,0)
1^F^52.4^.01^^1^F
"IX",52.4,52.4,"DW",11.1,1,3)

"IX",52.4,52.4,"DW",11.1,2,0)
2^F^52.4^8^^2^F
"IX",52.4,52.4,"DW",11.1,2,3)

"MBREQ")
1
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
372^3121010^10000000068
"PKG",141,22,1,"PAH",1,1,0)
^^19^19^3121010
"PKG",141,22,1,"PAH",1,1,1,0)
This patch is part of a combined build that makes up the release of 
"PKG",141,22,1,"PAH",1,1,2,0)
MEDICATION ORDER CHECK HEALTHCARE APPLICATION (MOCHA) 2.0.
"PKG",141,22,1,"PAH",1,1,3,0)
 
"PKG",141,22,1,"PAH",1,1,4,0)
MOCHA 2.0 encompasses Pharmacy Data Management (PDM) patch PSS*1*160
"PKG",141,22,1,"PAH",1,1,5,0)
and a combined build for Outpatient Pharmacy patch PSO*7*372 and 
"PKG",141,22,1,"PAH",1,1,6,0)
Inpatient Medications patch PSJ*5*252.
"PKG",141,22,1,"PAH",1,1,7,0)
 
"PKG",141,22,1,"PAH",1,1,8,0)
This patch group adds dosing checks that implements a new system that uses
"PKG",141,22,1,"PAH",1,1,9,0)
data from First DataBank (FDB).  In this initial phase of dosing
"PKG",141,22,1,"PAH",1,1,10,0)
functionality, the Single Dose information will be displayed to
"PKG",141,22,1,"PAH",1,1,11,0)
the user.  The following scenarios describe the types of messaging added: 
"PKG",141,22,1,"PAH",1,1,12,0)
 
"PKG",141,22,1,"PAH",1,1,13,0)
  1. If the dosage entered passes the dosing checks, no message will be
"PKG",141,22,1,"PAH",1,1,14,0)
     displayed.
"PKG",141,22,1,"PAH",1,1,15,0)
  2. If the dosage entered is too high or too low, the Single Dose warning
"PKG",141,22,1,"PAH",1,1,16,0)
     message will be displayed.
"PKG",141,22,1,"PAH",1,1,17,0)
  3. If the dose checks were not able to be performed, a generic message
"PKG",141,22,1,"PAH",1,1,18,0)
     will be displayed notifying the user that a manual check needs to be
"PKG",141,22,1,"PAH",1,1,19,0)
     completed to verify appropriate dosing.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
37
"RTN","PSOBKDE1")
0^13^B5570079
"RTN","PSOBKDE1",1,0)
PSOBKDE1 ;BIR/MR-Sub-routines for Backdoor Rx Order Edit ;11/25/02
"RTN","PSOBKDE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**117,133,372**;DEC 1997;Build 54
"RTN","PSOBKDE1",3,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOBKDE1",4,0)
 ;
"RTN","PSOBKDE1",5,0)
LST1 ;
"RTN","PSOBKDE1",6,0)
 I ($Y+3)>20 D PAUSE
"RTN","PSOBKDE1",7,0)
 W !,"This is the amount of medication the patient is to receive as one dose"
"RTN","PSOBKDE1",8,0)
 W !,"for this order.  This can be a numeric value, such as 325 or 650 or an"
"RTN","PSOBKDE1",9,0)
 W !,"amount with a unit of measure such as 325MG or 650MG.  You may also enter"
"RTN","PSOBKDE1",10,0)
 W !,"a free text dosage, such as 1 Tablet or 2 Tablets",!
"RTN","PSOBKDE1",11,0)
 ;
"RTN","PSOBKDE1",12,0)
LST I '$D(DOSE("DD")) D  Q
"RTN","PSOBKDE1",13,0)
 . W !,"     No dosages are available"
"RTN","PSOBKDE1",14,0)
 . N X S X=$$GET1^DIQ(50,PSODRUG("IEN"),100,"I")
"RTN","PSOBKDE1",15,0)
 . W $S(X'=""&(DT>X):" because the Drug is now Inactive.",1:"!")
"RTN","PSOBKDE1",16,0)
 . W !,"     Please, enter a free text dosage, or You may select a New"
"RTN","PSOBKDE1",17,0)
 . W !,"     Orderable Item and Dispense Drug for this order, or you can"
"RTN","PSOBKDE1",18,0)
 . W !,"     enter a New Order with an Active Drug."
"RTN","PSOBKDE1",19,0)
 ;
"RTN","PSOBKDE1",20,0)
 W:$P(DOSE("DD",PSODRUG("IEN")),"^",5)]"" !,"VERB: "_$P(DOSE("DD",PSODRUG("IEN")),"^",10)
"RTN","PSOBKDE1",21,0)
LST2 W !,"Available Dosage(s)"
"RTN","PSOBKDE1",22,0)
 F I=0:0 S I=$O(DOSE(I)) Q:'I!('$D(DOSE(I)))  D
"RTN","PSOBKDE1",23,0)
 .W !?5,$J(I,3)_". "_$S($P(DOSE(I),"^"):$P(DOSE(I),"^")_$S($P(DOSE("DD",PSODRUG("IEN")),"^",6)]"":$P(DOSE("DD",PSODRUG("IEN")),"^",6),1:""),$P(DOSE(I),"^",3)'="":$P(DOSE(I),"^",3),1:"Please Enter a Free Text Dosage.")
"RTN","PSOBKDE1",24,0)
 .D PAUSE:($Y+3)>20
"RTN","PSOBKDE1",25,0)
 K DIRUT
"RTN","PSOBKDE1",26,0)
 Q
"RTN","PSOBKDE1",27,0)
 ;
"RTN","PSOBKDE1",28,0)
PAUSE ;
"RTN","PSOBKDE1",29,0)
 K DIR S DIR("A")="Enter RETURN to continue or '^' to exit the list of dosages",DIR(0)="E" W ! D ^DIR
"RTN","PSOBKDE1",30,0)
 I $D(DTOUT)!($D(DUOUT)) S I=9999 Q
"RTN","PSOBKDE1",31,0)
 W @$G(IOF)
"RTN","PSOBKDE1",32,0)
 Q
"RTN","PSOCAN")
0^40^B50642727
"RTN","PSOCAN",1,0)
PSOCAN ;BIR/JMB - Rx discontinue and reinstate ;8/3/06 12:38pm
"RTN","PSOCAN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,24,27,32,37,88,117,131,185,253,251,375,379,372**;DEC 1997;Build 54
"RTN","PSOCAN",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN",4,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN",5,0)
START N PSOODOSP,PSOREINF,PSOONOFC S WARN=0,(DAYS360,SPCANC)=1 D KCAN1^PSOCAN3 W !! S DIR("A")="Discontinue/Reinstate by Rx# or patient name",DIR(0)="SBO^R:RX NUMBER;P:PATIENT NAME"
"RTN","PSOCAN",6,0)
 S DIR("?")="Enter 'R' to discontinue/reinstate by Rx#.  Enter 'P' to discontinue/reinstate by patient name." D ^DIR K DIR
"RTN","PSOCAN",7,0)
 G:$G(DIRUT) KILL^PSOCAN1 K RP S RP=Y G:RP="P" PAT^PSOCAN1
"RTN","PSOCAN",8,0)
NUM D DCORD^PSONEW2
"RTN","PSOCAN",9,0)
 K PSOTECCK,RXSP,PSINV,PSOWUN,PSOULRX D KCAN1^PSOCAN3 S:'$D(PSOCLC) PSOCLC=DUZ S PS="Discontinue" W ! S DIR("A")="Discontinue/Reinstate Prescription(s)#"
"RTN","PSOCAN",10,0)
 S DIR(0)="FO^1:245",DIR("?")="Wand/enter barcode or enter Rx number(s) to discontinued/reinstated. If more than one, separate with commas. Do not exceed 245 characters including commas"
"RTN","PSOCAN",11,0)
 D ^DIR K DIR G:$G(DIRUT) START S OUT=0 I Y["-" D PSOINST^PSOSUPAT G:OUT NUM S (IN,X)=$P(^PSRX($P(Y,"-",2),0),"^") G NO
"RTN","PSOCAN",12,0)
 S IN=Y G RX:Y[","
"RTN","PSOCAN",13,0)
NO I '$O(^PSRX("B",Y,0)) W " Rx Not Found!",! G NUM
"RTN","PSOCAN",14,0)
 S PSPOP=0,DIC=52,DIC(0)="QEMZ" D ^DIC K DIC Q:$G(POERR)&(Y<0)
"RTN","PSOCAN",15,0)
 G:Y<0 NUM S (DA,IFN,PSOULRX)=+Y,RXNUM=Y(0,0),PSODFN=+$P(^PSRX(DA,0),"^",2) I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF"),PSOREINF S PSOODOSP=PSODFN
"RTN","PSOCAN",16,0)
 S PSOWUN=1 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G NUM
"RTN","PSOCAN",17,0)
 K PSOPLCK D PSOL^PSSLOCK(IFN) I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.") K PSOMSG D ULP G NUM
"RTN","PSOCAN",18,0)
 I $P($G(^PSRX(+$G(IFN),"STA")),"^")=12,$P($G(^("PKI")),"^") W !!,"Cannot be Reinstated - Digitally Signed" D ULP G NUM
"RTN","PSOCAN",19,0)
 I $P($G(^PSRX(+$G(IFN),"STA")),"^")=12 S PSOCANRZ=1
"RTN","PSOCAN",20,0)
 E  S PSOCANRD=+$P($G(^PSRX(+$G(IFN),0)),"^",4)
"RTN","PSOCAN",21,0)
 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN)
"RTN","PSOCAN",22,0)
LMNO D CHK S:'$G(DA)&($G(IFN)) DA=IFN
"RTN","PSOCAN",23,0)
 I DEAD!$P(^PSRX(DA,"STA"),"^")'<13,$P(^("STA"),"^")'=16 S PSINV($P(^PSRX(DA,0),"^"))="" D:$G(PSOWUN) ULP,ULRX G EP1
"RTN","PSOCAN",24,0)
 I $G(PSODIV),$P($G(^PSRX(DA,2)),"^",9),$P(^(2),"^",9)'=$G(PSOSITE) S RXREC=DA D DIV D:$G(POERR)&(PSPOP) ULP,ULRX Q:$G(POERR)&(PSPOP)  D:$G(PSOWUN)&($G(PSPOP)) ULP,ULRX G:PSPOP NUM
"RTN","PSOCAN",25,0)
 D ICN^PSODPT(PSODFN)
"RTN","PSOCAN",26,0)
 S PS=$S($P(^PSRX(DA,"STA"),"^")=12:"Reinstate",1:"Discontinue")
"RTN","PSOCAN",27,0)
 I '$G(POERR) N PKIR D
"RTN","PSOCAN",28,0)
 .I $P(^PSRX(DA,"STA"),"^")=1,$P($G(^("PKI")),"^") S PKIR=""
"RTN","PSOCAN",29,0)
 .D ^PSORXPR
"RTN","PSOCAN",30,0)
 D YN S:PS="Reinstate" PS="Discontinue" Q:$G(POERR)&('%)
"RTN","PSOCAN",31,0)
 I '% D ULP,ULRX G NUM
"RTN","PSOCAN",32,0)
 D REA D:'$D(REA)&($G(PSOWUN)) ULP,ULRX Q:'$D(REA)
"RTN","PSOCAN",33,0)
 D COM^PSOCAN1 Q:$G(POERR)&('$D(INCOM))!($D(DIRUT))  I '$D(INCOM)!($D(DIRUT)) D ULP,ULRX G NUM
"RTN","PSOCAN",34,0)
 S RX=$P(^PSRX(DA,0),"^"),PSCAN(RX)=DA_"^"_REA
"RTN","PSOCAN",35,0)
 D:REA="R" REINS^PSOCAN2 Q:$G(PSOQUIT)&($G(PSOREINS))
"RTN","PSOCAN",36,0)
 I REA="R",'$G(PSORX("DFLG")) D DCORD^PSONEW2
"RTN","PSOCAN",37,0)
 K PSOTECCK
"RTN","PSOCAN",38,0)
 D:$G(PSORX("DFLG")) ULP,ULRX
"RTN","PSOCAN",39,0)
 Q:$G(POERR)&($G(PSORX("DFLG")))
"RTN","PSOCAN",40,0)
 G NUM:$G(PSORX("DFLG"))
"RTN","PSOCAN",41,0)
 D:REA="C" CAN
"RTN","PSOCAN",42,0)
 Q:$G(POERR)
"RTN","PSOCAN",43,0)
 D ULP,ULRX G NUM
"RTN","PSOCAN",44,0)
YN D EN^PSOCMOPA I $G(XFLAG)]"" S %=0 K XFLAG Q
"RTN","PSOCAN",45,0)
 W ! S DIR("A")="Are you sure you want to "_PS,DIR(0)="Y",DIR("B")="NO" D ^DIR S %=Y K DIR,DUOUT,DTOUT I 'Y!$D(DIRUT) S VALMBCK="R"
"RTN","PSOCAN",46,0)
 K DIRUT Q
"RTN","PSOCAN",47,0)
REA S REA=+$P(^PSRX(DA,"STA"),"^") I REA=12 S REA="R" Q
"RTN","PSOCAN",48,0)
 I REA,REA'=11 W !?5,$C(7) D
"RTN","PSOCAN",49,0)
 .W "Rx# "_RXNUM_" was"_$S(REA=1:" Non-Verified",REA=13:" Deleted",REA=11:" Expired",REA=5:" Suspended",REA=4:" Pending Due to Drug Interactions",REA=3:" On Hold",REA=14!(REA=15):" Discontinued",REA=16:" Provider Held",1:" In Fill Status")_"."
"RTN","PSOCAN",50,0)
 I REA,REA'=1,REA'=3,REA'=5,REA'=11,REA'<13,REA'=16 K REA W !?10,"Rx Cannot Be Discontinued/Reinstated!" Q
"RTN","PSOCAN",51,0)
 S REA="C" Q
"RTN","PSOCAN",52,0)
CAN N PSODRUG D CAN1^PSOCAN3 Q
"RTN","PSOCAN",53,0)
DIV I '$P($G(PSOSYS),"^",2) W !?10,$C(7),"RX# ",$P(^PSRX(DA,0),"^")," is not a valid choice.  (Different Division)" S PSPOP=1 Q
"RTN","PSOCAN",54,0)
 I $P($G(PSOSYS),"^",3) W !?10,$C(7) S DIR("A")="RX# "_$P(^PSRX(DA,0),"^")_" is from another division.  Continue",DIR(0)="Y",DIR("B")="Y" D ^DIR K DIR S:$G(DIRUT)!('Y) PSPOP=1
"RTN","PSOCAN",55,0)
 Q
"RTN","PSOCAN",56,0)
CHK K VADM,DEAD S DFN=PSODFN D DEM^VADPT I $G(VADM(6))="" S DEAD=0 Q
"RTN","PSOCAN",57,0)
 S (PSODEATH,DEAD)=1 W !!,?10,VADM(1)_" DIED "_$P($G(VADM(6)),"^",2) D CAN^PSOCAN3 K PSODEATH
"RTN","PSOCAN",58,0)
 Q
"RTN","PSOCAN",59,0)
RX N PKI S RXCNT=0,RXSP=1 D TESTRP D COM^PSOCAN1 G:'$D(INCOM)!($D(DIRUT)) NUM K PSINV,PSCAN F II=1:1 S (EN,X)=$P(IN,",",II) Q:$P(IN,",",II)']""  S DIC=52,DIC(0)="QMZ" D ^DIC K DIC S:Y'>0 PSINV(X)="" D:Y>0
"RTN","PSOCAN",60,0)
 .S YY=Y,YY(0,0)=Y(0,0),(PSODFN,DFN)=$P(Y(0),"^",2) D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN)
"RTN","PSOCAN",61,0)
 .D:$G(DFN)>0 CHK I DEAD!($P(^PSRX(+YY,"STA"),"^")=13)!($P(^("STA"),"^")=14) S PSINV(EN)="" Q
"RTN","PSOCAN",62,0)
 .I $P(^PSRX(+YY,"STA"),"^")=12,$P($G(^("PKI")),"^") S PKI=1,PSINV(EN)="" Q
"RTN","PSOCAN",63,0)
 .S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP
"RTN","PSOCAN",64,0)
 .S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN",65,0)
 .;S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP Q
"RTN","PSOCAN",66,0)
 .;E  S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN",67,0)
 K YY G:'$D(PSCAN) INVALD^PSOCAN1 S RX="",RXCNT=0 F  S RX=$O(PSCAN(RX)) Q:RX=""  S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),RXCNT=RXCNT+1  D SHOW^PSOCAN1
"RTN","PSOCAN",68,0)
ASK Q:'$D(PSCAN)  W ! S DIR("A")="OK to "_$S($G(RXCNT)>1:"Change Status",REA="C":"Discontinued",1:"Reinstate"),DIR(0)="Y",DIR("B")="N"
"RTN","PSOCAN",69,0)
 N PSOCNRXV S PSOCNRXV=0
"RTN","PSOCAN",70,0)
 D ^DIR K DIR Q:$G(DIRUT)  I 'Y K PSCAN D INVALD^PSOCAN1 G NUM
"RTN","PSOCAN",71,0)
 K PSOPLCKZ S RX="" F  S RX=$O(PSCAN(RX)) Q:'RX  D
"RTN","PSOCAN",72,0)
 .S PSODFN=+$P($G(^PSRX(+PSCAN(RX),0)),"^",2)
"RTN","PSOCAN",73,0)
 .S PSOPLCK=$$L^PSSLOCK(+$G(PSODFN),0) D:'$G(PSOPLCK)&('$D(PSOPLCKZ(PSODFN))) LOCK^PSOORCPY I '$G(PSOPLCK) S PSOPLCKZ(PSODFN)=PSODFN Q
"RTN","PSOCAN",74,0)
 .D PSOL^PSSLOCK(+PSCAN(RX)) I '$G(PSOMSG) D  D UL^PSSLOCK(PSODFN) Q
"RTN","PSOCAN",75,0)
 ..I $P($G(PSOMSG),"^",2)'="" W !,$P($G(PSOMSG),"^",2),!,"Order "_$P($G(^PSRX(+PSCAN(RX),0)),"^")_"." Q
"RTN","PSOCAN",76,0)
 ..W !,"Another person is editing order "_$P($G(^PSRX(+PSCAN(RX),0)),"^")_"."
"RTN","PSOCAN",77,0)
 .D ACT D PSOUL^PSSLOCK(+PSCAN(RX)),UL^PSSLOCK(PSODFN)
"RTN","PSOCAN",78,0)
 .S PSOCNRXV=1
"RTN","PSOCAN",79,0)
 K PSOPLCKZ W:$G(PSOCNRXV) !,$S($G(RXCNT)>1:"Statuses Changed",REA="C":"Prescription Discontinued",1:"Prescription Reinstated") D INVALD^PSOCAN1 G NUM
"RTN","PSOCAN",80,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 Q
"RTN","PSOCAN",81,0)
 D CAN Q
"RTN","PSOCAN",82,0)
EXP ;S PSINV($P(^PSRX(DA,0),"^"))="" 
"RTN","PSOCAN",83,0)
 Q:$P(^PSRX(DA,"STA"),"^")=12
"RTN","PSOCAN",84,0)
 S $P(^PSRX(DA,"STA"),"^")=11 D ECAN^PSOUTL(DA)
"RTN","PSOCAN",85,0)
 S STAT="SC",PHARMST="ZE",COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3) D EN^PSOHLSN1(DA,STAT,PHARMST,COMM) K COMM,STAT,PHARMST
"RTN","PSOCAN",86,0)
EP1 I '$G(RXSP) D INVALD^PSOCAN1 Q:$G(POERR)  G NUM
"RTN","PSOCAN",87,0)
 Q
"RTN","PSOCAN",88,0)
PSD ;Called from Controlled Subs, PSDRX is internal Rx number
"RTN","PSOCAN",89,0)
 S PSDRFDEL=0
"RTN","PSOCAN",90,0)
 I '$G(PSDRX)!('$D(^PSRX(+$G(PSDRX),0))) Q
"RTN","PSOCAN",91,0)
 I $P($G(^PSRX(PSDRX,"STA")),"^")<12 Q
"RTN","PSOCAN",92,0)
 N DA,NODE,RF,PSOPSDAL,PSODRX,PSODTE,PSODL,SFN,RIFN,PSOSXP,PSOFILDL
"RTN","PSOCAN",93,0)
 S PSODRX=0 F PSODLP=0:0 S PSODLP=$O(^PSRX(PSDRX,1,PSODLP)) Q:'PSODLP  S:$D(^PSRX(PSDRX,1,PSODLP,0)) PSODRX=PSODLP
"RTN","PSOCAN",94,0)
 I 'PSODRX Q
"RTN","PSOCAN",95,0)
 I $P($G(^PSRX(PSDRX,1,PSODRX,0)),"^",18) Q
"RTN","PSOCAN",96,0)
 D PSDREF I $G(PSOFILDL) K PSOFILDL Q
"RTN","PSOCAN",97,0)
 K PSOFILDL,DIE S NODE=0,PSOPSDAL=1,DA(1)=PSDRX,DA=PSODRX,DIE="^PSRX("_DA(1)_",1,",DR=".01///@" D ^DIE K DIE
"RTN","PSOCAN",98,0)
 S PSDRFDEL=1
"RTN","PSOCAN",99,0)
 Q
"RTN","PSOCAN",100,0)
PSDREF ;
"RTN","PSOCAN",101,0)
 N PRDL,PSOCNODE
"RTN","PSOCAN",102,0)
 S PSOFILDL=0
"RTN","PSOCAN",103,0)
 F PRDL=0:0 S PRDL=$O(^PSRX(PSDRX,4,PRDL)) Q:'PRDL  I $G(PSODRX)=$P($G(^PSRX(PSDRX,4,PRDL,0)),"^",3) S PSOCNODE=$G(^(0))
"RTN","PSOCAN",104,0)
 I $G(PSOCNODE)="" Q
"RTN","PSOCAN",105,0)
 I +$P(PSOCNODE,"^",4)<3 S PSOFILDL=1
"RTN","PSOCAN",106,0)
 Q
"RTN","PSOCAN",107,0)
TESTRP ;
"RTN","PSOCAN",108,0)
 N PIIN,PIINFLAG S PIINFLAG=0 F PIIN=1:1 S X=$P(IN,",",PIIN) Q:$P(IN,",",PIIN)']""  K DIC S DIC=52,DIC(0)="QMZ" D ^DIC K DIC I +$G(Y) D
"RTN","PSOCAN",109,0)
 .I $P($G(^PSRX(+Y,"STA")),"^")'=12,'$G(PIINFLAG) S PSOCANRD=+$P($G(^PSRX(+Y,0)),"^",4) S PIINFLAG=1
"RTN","PSOCAN",110,0)
 I '$G(PIINFLAG) S PSOCANRZ=1
"RTN","PSOCAN",111,0)
 Q
"RTN","PSOCAN",112,0)
ULP ;
"RTN","PSOCAN",113,0)
 D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOCAN",114,0)
 Q
"RTN","PSOCAN",115,0)
ULRX ;
"RTN","PSOCAN",116,0)
 I $G(PSOULRX) D PSOUL^PSSLOCK(PSOULRX)
"RTN","PSOCAN",117,0)
 Q
"RTN","PSOCAN1")
0^43^B60132005
"RTN","PSOCAN1",1,0)
PSOCAN1 ;BIR/BHW - modular rx cancel with speed cancel ability ;2/22/93
"RTN","PSOCAN1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,20,24,27,32,131,163,185,238,372**;DEC 1997;Build 54
"RTN","PSOCAN1",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN1",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCAN1",5,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOCAN1",6,0)
 ;External references L, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN1",7,0)
 ;
"RTN","PSOCAN1",8,0)
PAT S RXCNT=0 K X,PSODFN,ASKED,BC,DELCNT,WARN W ! S DIR("A")="Are you entering the patient name or barcode",DIR(0)="SBO^P:Patient Name;B:Barcode"
"RTN","PSOCAN1",9,0)
 S DIR("?")="Enter a P if you are going to enter the patient name.  Enter a B if you are going to enter or wand the barcode."
"RTN","PSOCAN1",10,0)
 D ^DIR K DIR G:$D(DIRUT) ^PSOCAN S BC=Y
"RTN","PSOCAN1",11,0)
BC D KCAN1^PSOCAN3 S OUT=0 I BC="B" W ! S DIR("A")="Enter/wand barcode",DIR(0)="FO^5:20",DIR("?")="Enter the barcode number or wand the barcode to discontinue all prescriptions for one patient" D ^DIR K DIR G:$G(DIRUT) PAT S BCNUM=Y D
"RTN","PSOCAN1",12,0)
 .D PSOINST^PSOSUPAT Q:OUT  S RX=$P(BCNUM,"-",2) D:$D(^PSRX(RX,0))
"RTN","PSOCAN1",13,0)
 ..S PSODFN=$P(^PSRX(RX,0),"^",2) W " ",$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOCAN1",14,0)
 ..D ICN^PSODPT(PSODFN)
"RTN","PSOCAN1",15,0)
 .I '$D(^PSRX(RX,0)) W !,$C(7),"No Prescription record for this barcode." S OUT=1
"RTN","PSOCAN1",16,0)
 G:OUT BC
"RTN","PSOCAN1",17,0)
NAM D KCAN^PSOCAN3 S PSOCANRA=1 I BC="P" W ! S DIC(0)="AEMZQ",DIC="^DPT(" D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<0) PAT S PSODFN=+Y S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSOCAN1",18,0)
 I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF"),PSOREINF S PSOODOSP=PSODFN
"RTN","PSOCAN1",19,0)
 I $G(PSOREINF)!($G(PSORX("DOSING INFO"))) S PSOONOFO=1
"RTN","PSOCAN1",20,0)
 N PSONEW,PSORX S PSFROM="N" D CHK^PSOCAN G:DEAD NAM K PSOSD D ^PSOBUILD S PSOOPT=-1 D ^PSODSPL G:'$D(PSOSD) NAM
"RTN","PSOCAN1",21,0)
 D ONOFF
"RTN","PSOCAN1",22,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G PAT
"RTN","PSOCAN1",23,0)
 W ! S DIR("A")="Discontinue all or specific Rx#'s?",DIR(0)="SBO^A:ALL Rx's;S:SPECIFIC Rx's"
"RTN","PSOCAN1",24,0)
 S DIR("?")="Enter the letter A for all listed Rx's OR the letter for specific Rx's." D ^DIR K DIR I $D(DIRUT) D ULP^PSOCAN G PAT
"RTN","PSOCAN1",25,0)
 S ALL=Y G:Y="S" LINE D RTESTA D COM I '$D(INCOM)!($D(DIRUT)) D ULP^PSOCAN G NAM
"RTN","PSOCAN1",26,0)
 K PSOSDX,PSOSDXY,PENCAN,PSOCANPN S SPEED=1,(DRG,DRUG,IN,STA)="",II=0 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DRUG=$O(PSOSD(STA,DRUG)) Q:DRUG=""  S II=II+1,DRG=DRUG D
"RTN","PSOCAN1",27,0)
 .I STA="PENDING" S DA=$P(PSOSD(STA,DRG),"^",10) S PSOSDX(DA)="" Q
"RTN","PSOCAN1",28,0)
 .;PSO*7*238
"RTN","PSOCAN1",29,0)
 .I STA="ZNONVA" D  Q
"RTN","PSOCAN1",30,0)
 ..D NOW^%DTC
"RTN","PSOCAN1",31,0)
 ..N TMP
"RTN","PSOCAN1",32,0)
 ..S TMP(55.05,PSOOI_","_PSODFN_",",5)=1
"RTN","PSOCAN1",33,0)
 ..S TMP(55.05,PSOOI_","_PSODFN_",",6)=%
"RTN","PSOCAN1",34,0)
 ..D FILE^DIE("","TMP")
"RTN","PSOCAN1",35,0)
 .S PSOCANPN=1
"RTN","PSOCAN1",36,0)
 .D PSPEED
"RTN","PSOCAN1",37,0)
 K SPEED D ASK D:$G(REA)="C"&('$G(PSOSDXY))&($O(PSOSDX(0)))&($G(PSOCANPN))  D:'$G(PSOCANPN)  K PSOCANPN,PSOSDX,PSOSDXY,PENCAN D ULP^PSOCAN G PAT
"RTN","PSOCAN1",38,0)
 .S PENCAN="" F  S PENCAN=$O(PSOSDX(PENCAN)) Q:'PENCAN  S DA=PENCAN D PSOL^PSSLOCK(DA_"S") I $G(PSOMSG) D PEN,PSOUL^PSSLOCK(DA_"S")
"RTN","PSOCAN1",39,0)
LINE W !! S DIR(0)="LO^1:"_$S($G(PSOHI):PSOHI,1:PSOSD),DIR("A")="ENTER THE LINE #",DIR("?",1)="Enter the line number(s) displayed to the left of the Rx#."
"RTN","PSOCAN1",40,0)
 S DIR("?",2)="   Separate the numbers with commas (Example: 3,8,10,7),",DIR("?",3)="   OR a dash (Example: 12-20), OR a combination of commas and",DIR("?",4)="   dashes (Example: 3-5,1,12)."
"RTN","PSOCAN1",41,0)
 S DIR("?")="Do not exceed 245 characters including commas and dashes." D ^DIR K DIR D:$D(DIRUT) ULP^PSOCAN G:$G(DIRUT) KILL I Y["." W !?53,$C(7),"INVALID LINE NUMBER(S)." G LINE
"RTN","PSOCAN1",42,0)
 S LINE=Y K PSCAN,PSOCAN S (DRG,IN,STA)="",CNT=0
"RTN","PSOCAN1",43,0)
 F  S STA=$O(PSOSD(STA))  Q:STA=""  F  S DRG=$O(PSOSD(STA,DRG)) Q:DRG=""  S CNT=CNT+1,PSOCAN(CNT)=$S(STA'="PENDING":$P(PSOSD(STA,DRG),"^"),1:$P(PSOSD(STA,DRG),"^",10)_"^P")
"RTN","PSOCAN1",44,0)
 F CNT=1:1 S PLINE=$P(LINE,",",CNT) Q:'$P(LINE,",",CNT)  S IN=$S(IN="":PSOCAN(PLINE),1:IN_","_PSOCAN(PLINE))
"RTN","PSOCAN1",45,0)
 D RTEST D SPEED D ULP^PSOCAN G:BC="P" NAM G:BC="B" BC
"RTN","PSOCAN1",46,0)
PSPEED S (YY,DA)=$P(PSOSD(STA,DRG),"^"),RX=$P($G(^PSRX(DA,0)),"^") D SPEED1 Q:PSPOP!($D(PSINV(RX)))
"RTN","PSOCAN1",47,0)
 Q:$G(SPEED)&(REA="R")
"RTN","PSOCAN1",48,0)
SHOW S DRG=+$P(^PSRX(DA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:"")
"RTN","PSOCAN1",49,0)
PSHOW S LC=0 W !,$P(^PSRX(DA,0),"^"),"  ",DRG,?52,$S($D(^DPT(+$P(^PSRX(DA,0),"^",2),0)):$P(^(0),"^"),1:"PATIENT UNKNOWN")
"RTN","PSOCAN1",50,0)
 I REA="C" W !?25,"Rx to be Discontinued",! G SHOW1
"RTN","PSOCAN1",51,0)
 W !?21,"*** Rx to be Reinstated ***",!
"RTN","PSOCAN1",52,0)
SHOW1 ;S LC=LC+3 I LC>20 R !,"Press return to continue",X:DTIME G:X'="" SHOW1 S LC=0
"RTN","PSOCAN1",53,0)
 I $Y+4>IOSL K DIR,DUOUT,DTOUT,DIRUT S DIR(0)="E",DIR("A")="Press Return to Continue",DIR("?")="Press Return to continue Listing Orders" D ^DIR K DIR,DTOUT,DIRUT,DUOUT W @IOF
"RTN","PSOCAN1",54,0)
 Q
"RTN","PSOCAN1",55,0)
SPEED1 S PSPOP=0 I $G(PSODIV),+$P($G(^PSRX(DA,2)),"^",9)'=$G(PSOSITE) D:'$G(SPEED) DIV^PSOCAN
"RTN","PSOCAN1",56,0)
 K STAT S STAT=+$P(^PSRX(DA,"STA"),"^"),REA=$E("C00CCCCCCCCCR000C",STAT+1)
"RTN","PSOCAN1",57,0)
 Q:$G(SPEED)&(REA="R")
"RTN","PSOCAN1",58,0)
 I REA="R",$P($G(^PSRX(DA,"PKI")),"^") S PKI=1 S PSINV(RX)="" Q
"RTN","PSOCAN1",59,0)
 I REA=0!(PSPOP)!($P(^PSRX(+YY,"STA"),"^")>12),$P(^("STA"),"^")<16 S PSINV(RX)="" Q
"RTN","PSOCAN1",60,0)
 S:REA'=0&('PSPOP) PSCAN(RX)=DA_"^"_REA,RXCNT=$G(RXCNT)+1
"RTN","PSOCAN1",61,0)
 Q
"RTN","PSOCAN1",62,0)
AREC S:'$G(DEAD) REA=$S($G(REA)="L":"L",1:$P(PSCAN($P(^PSRX(DA,0),"^")),"^",2)) S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOCAN1",63,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOCAN1",64,0)
 D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1) S ^PSRX(DA,"A",ACNT+1,0)=%_"^"_REA_"^"_DUZ_"^"_RFCNT_"^"_$S($G(MSG)]"":MSG,1:$G(ACOM)_$G(INCOM)) S ACOM=""
"RTN","PSOCAN1",65,0)
 I $D(PKIR) N J S J=ACNT+2 D ADR^PSOPKIV1
"RTN","PSOCAN1",66,0)
 D EXP^PSOHELP1
"RTN","PSOCAN1",67,0)
 Q
"RTN","PSOCAN1",68,0)
SPEED D COM Q:'$D(INCOM)!($D(DIRUT))  N PKI K PSINV,PSCAN F II=1:1 S DA=$P(IN,",",II) Q:'$P(IN,",",II)  D
"RTN","PSOCAN1",69,0)
 .I $P(DA,"^",2)="P" S DA=+DA D  Q
"RTN","PSOCAN1",70,0)
 ..D PSOL^PSSLOCK(DA_"S") I $G(PSOMSG) D PEN D PSOUL^PSSLOCK(DA_"S")
"RTN","PSOCAN1",71,0)
 .I $D(^PSRX(DA,0)) S YY=DA,RX=$P(^(0),"^") S:DA<0 PSINV(RX)="" D:DA>0 SPEED1
"RTN","PSOCAN1",72,0)
 G:'$D(PSCAN) INVALD S II="",RXCNT=0 F  S II=$O(PSCAN(II)) Q:II=""  S DA=+PSCAN(II),REA=$P(PSCAN(II),"^",2),RXCNT=RXCNT+1  D SHOW
"RTN","PSOCAN1",73,0)
 ;
"RTN","PSOCAN1",74,0)
ASK G:'$D(PSCAN) INVALD W ! S DIR("A")="OK to "_$S($G(RXCNT)>1:"Change Status",REA="C":"Discontinue",1:"Reinstate"),DIR(0)="Y",DIR("B")="N" D ^DIR K DIR I $D(DIRUT) S:$O(PSOSDX(0)) PSOSDXY=1 Q
"RTN","PSOCAN1",75,0)
 I 'Y S:$O(PSOSDX(0)) PSOSDXY=1 K PSCAN D INVALD Q
"RTN","PSOCAN1",76,0)
 S RX="" F  S RX=$O(PSCAN(RX)) Q:RX=""  D PSOL^PSSLOCK(+PSCAN(RX)) I $G(PSOMSG) D ACT D PSOUL^PSSLOCK(+PSCAN(RX))
"RTN","PSOCAN1",77,0)
 D INVALD Q
"RTN","PSOCAN1",78,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 Q
"RTN","PSOCAN1",79,0)
 D CAN^PSOCAN Q
"RTN","PSOCAN1",80,0)
INVALD K PSCAN Q:'$D(PSINV)  W !! F I=1:1:80 W "="
"RTN","PSOCAN1",81,0)
 W $C(7),!!,"The Following Rx Number(s) Are Invalid Choices, Expired, "_$S($G(PKI):"Digitally Signed",1:""),!,"Discontinued by Provider, or Marked As Deleted:" S II="" F  S II=$O(PSINV(II)) Q:II=""  W !?10,II
"RTN","PSOCAN1",82,0)
 K PSINV I $G(PSOERR)!($G(SPEED)) K DIR,DUOUT,DTOUT,DIRUT S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOCAN1",83,0)
 G KILL Q
"RTN","PSOCAN1",84,0)
LISTPAT S X="?",DIC(0)="EMQ",DIC="^DPT(" D ^DIC K DIC Q
"RTN","PSOCAN1",85,0)
 ;
"RTN","PSOCAN1",86,0)
COM W !
"RTN","PSOCAN1",87,0)
 K MSG  ;Added to prevent INCOM from being superseded in AREC tag if DC comments entered.
"RTN","PSOCAN1",88,0)
 S DIR("A")="Comments"_$S($D(PKIR):"/Reason for DCing",1:""),DIR(0)="F^5:75"
"RTN","PSOCAN1",89,0)
 S DIR("?")="Comments must be entered.  Comments must be 5 to 75 characters and must not contain embedded uparrow"
"RTN","PSOCAN1",90,0)
 S:$D(INCOM) DIR("B")=INCOM
"RTN","PSOCAN1",91,0)
 D ^DIR I $D(DIRUT) K DIR,DTOUT,DUOUT,Y Q
"RTN","PSOCAN1",92,0)
 S INCOM=Y S:$D(PKIR) PKIR=Y K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOCAN1",93,0)
 D NOOR^PSOCAN4
"RTN","PSOCAN1",94,0)
 Q
"RTN","PSOCAN1",95,0)
KILL D KILL^PSOCAN2
"RTN","PSOCAN1",96,0)
 K PSOMSG,PSOPLCK,PSOWUN,PSOULRX
"RTN","PSOCAN1",97,0)
 Q
"RTN","PSOCAN1",98,0)
PEN ;discontinue pending orders
"RTN","PSOCAN1",99,0)
 S PSODAPND=DA
"RTN","PSOCAN1",100,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,DA,0),"^",2),+$P($G(^PS(52.41,DA,"INI")),"^"),DA) S $P(^PS(52.41,DA,0),"^",3)="DC",^PS(52.41,DA,4)=INCOM_" Discontinued by Pharmacy."
"RTN","PSOCAN1",101,0)
 D EN^PSOHLSN(+^PS(52.41,DA,0),"OC",INCOM,PSONOOR)
"RTN","PSOCAN1",102,0)
 S DA=PSODAPND K PSODAPND
"RTN","PSOCAN1",103,0)
 Q
"RTN","PSOCAN1",104,0)
RTEST ;
"RTN","PSOCAN1",105,0)
 Q:'$G(LINE)
"RTN","PSOCAN1",106,0)
 N PCIN,PCINFLAG,PCINX
"RTN","PSOCAN1",107,0)
 S PCINFLAG=0 F PCIN=1:1 S PCINX=$P(LINE,",",PCIN) Q:$P(LINE,",",PCIN)']""  D
"RTN","PSOCAN1",108,0)
 .Q:'$G(PCINX)
"RTN","PSOCAN1",109,0)
 .Q:'$G(PSOCAN(PCINX))
"RTN","PSOCAN1",110,0)
 .I PSOCAN(PCINX)'["^P" I $P($G(^PSRX(+$G(PSOCAN(PCINX)),"STA")),"^")'=12,'$G(PCINFLAG) S PSOCANRD=+$P($G(^PSRX($G(PSOCAN(PCINX)),0)),"^",4) S PCINFLAG=1
"RTN","PSOCAN1",111,0)
 .I PSOCAN(PCINX)["^P",'$G(PCINFLAG) S PSOCANRD=+$P($G(^PS(52.41,+$P(PSOCAN(PCINX),"^"),0)),"^",5) S PCINFLAG=1
"RTN","PSOCAN1",112,0)
 I '$G(PCINFLAG) S PSOCANRZ=1
"RTN","PSOCAN1",113,0)
 Q
"RTN","PSOCAN1",114,0)
RTESTA ;
"RTN","PSOCAN1",115,0)
 N PFIN,PFINZ,PFINFLAG
"RTN","PSOCAN1",116,0)
 S PFINFLAG=0 S PFIN="" F  S PFIN=$O(PSOSD(PFIN)) Q:PFIN=""  S PFINZ="" F  S PFINZ=$O(PSOSD(PFIN,PFINZ)) Q:PFINZ=""  D
"RTN","PSOCAN1",117,0)
 .I $G(PFIN)'="PENDING" I $P($G(^PSRX(+$P($G(PSOSD(PFIN,PFINZ)),"^"),"STA")),"^")'=12,'$G(PFINFLAG) S PSOCANRD=+$P($G(^(0)),"^",4),PFINFLAG=1
"RTN","PSOCAN1",118,0)
 .I $G(PFIN)="PENDING",'$G(PFINFLAG) S PSOCANRD=+$P($G(^PS(52.41,+$P($G(PSOSD(PFIN,PFINZ)),"^",10),0)),"^",5) S PFINFLAG=1
"RTN","PSOCAN1",119,0)
 I '$G(PFINFLAG) S PSOCANRZ=1
"RTN","PSOCAN1",120,0)
 Q
"RTN","PSOCAN1",121,0)
ONOFF ;
"RTN","PSOCAN1",122,0)
 I $G(PSOREINF) S PSORX("DOSING INFO")=1
"RTN","PSOCAN1",123,0)
 I $G(PSORX("DOSING INFO"))&'$G(PSOREINF) S PSOREINF=1
"RTN","PSOCAN1",124,0)
 Q
"RTN","PSOCAN2")
0^41^B82456941
"RTN","PSOCAN2",1,0)
PSOCAN2 ;BHAM ISC/JMB - rx cancel with speed ability drug check ; 2/16/12 3:40pm
"RTN","PSOCAN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,18,62,46,88,164,235,148,259,281,287,251,375,379,396,372**;DEC 1997;Build 54
"RTN","PSOCAN2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCAN2",4,0)
REINS N DODR,ORN
"RTN","PSOCAN2",5,0)
 I $G(PSODFN)'=$G(PSOODOSP) K PSORX("DOSING OFF"),PSOREINF S PSOODOSP=PSODFN
"RTN","PSOCAN2",6,0)
 I $P(^PSRX(DA,2),"^",6)<DT D  Q
"RTN","PSOCAN2",7,0)
 .S Y=$P(^PSRX(DA,2),"^",6) X ^DD("DD")
"RTN","PSOCAN2",8,0)
 .W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" Drug: "_$S($D(^PSDRUG($P(^PSRX(DA,0),"^",6),0)):$P(^(0),"^"),1:""),!,"Expired "_Y_" and cannot be Reinstated!",!
"RTN","PSOCAN2",9,0)
 .D PAUSE^VALM1
"RTN","PSOCAN2",10,0)
 I $D(^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA)) S PSCAN($P(^PSRX(DA,0),"^"))=DA_"^R",DODR=1 D AUTOD G ACT
"RTN","PSOCAN2",11,0)
 I $P(PSOPAR,"^",2),'$D(^XUSEC("PSORPH",DUZ)) N PSOVODA S PSOVODA=DA D DRGDRG Q:$G(PSOQUIT)&($G(PSOREINS))  S DA=PSOVODA Q:PSORX("DFLG")  D VERIFY D  D AREC^PSOCAN1 Q
"RTN","PSOCAN2",12,0)
 .S RX1=$P(^PSRX(DA,0),"^") S:'$D(PSCAN(RX1)) PSCAN(RX1)=DA_"^R" K RX1
"RTN","PSOCAN2",13,0)
ACT W ! F I=1:1:80 W "="
"RTN","PSOCAN2",14,0)
 D ^PSOBUILD S DRG=+$P(^PSRX(DA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:""),HOLDRX=RX
"RTN","PSOCAN2",15,0)
 W !!,RX_"  "_DRG I $G(POERR) S HPOERR=POERR
"RTN","PSOCAN2",16,0)
 D DRGDRG Q:$G(PSOQUIT)&($G(PSOREINS))
"RTN","PSOCAN2",17,0)
 S:$G(HPOERR) POERR=HPOERR S:$G(PSORX("DFLG"))'=1 PSORX("DFLG")=0
"RTN","PSOCAN2",18,0)
 S RX=HOLDRX K HOLDRX,HPOERR Q:$P(^PSRX(+PSCAN(RX),"STA"),"^")'=12!($G(PSORX("DFLG")))
"RTN","PSOCAN2",19,0)
 S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2) D CAN^PSOCAN W !
"RTN","PSOCAN2",20,0)
 N RXIEN S RXIEN=DA
"RTN","PSOCAN2",21,0)
 ;Takes action on reinstated Rx's
"RTN","PSOCAN2",22,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN2",23,0)
 S (LPRT,LREF)="" F LL=0:0 S LL=$O(^PSRX(DA,"L",LL)) Q:'LL  S LPRT=$P($G(^PSRX(DA,"L",LL,0)),"."),LREF=$P($G(^(0)),"^",2)
"RTN","PSOCAN2",24,0)
 I 'RFCNT S FDT=$S($P($G(^PSRX(DA,2)),"^",2)'="":$P($G(^PSRX(DA,2)),"^",2),1:$P($G(^PSRX(DA,2)),"^")) S RELDT=$P(^(2),"^",13),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",25,0)
 I RFCNT S FDT=$P($G(^PSRX(DA,1,RFCNT,0)),"^"),RELDT=$P(^(0),"^",18),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",26,0)
 S Y=FDT D DD^%DT S XFDT=Y I RELDT'="" S Y=RELDT D DD^%DT S XRELDT=Y
"RTN","PSOCAN2",27,0)
 I LPRT'="" S Y=LPRT D DD^%DT S XLPDT=Y
"RTN","PSOCAN2",28,0)
 ;If Rx was released, do nothing
"RTN","PSOCAN2",29,0)
 I RELDT'="" W !,RX_" Reinstated -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:""),?56,"Released: "_$G(XRELDT) H 3 Q
"RTN","PSOCAN2",30,0)
 ;If Rx not released, check fill/refill date for action
"RTN","PSOCAN2",31,0)
 I $G(PSXSYS) D REINS^PSOCMOPA I $G(XFLAG) K XFLAG Q
"RTN","PSOCAN2",32,0)
 W !,"Prescription #"_RX_" REINSTATED!"
"RTN","PSOCAN2",33,0)
 ;
"RTN","PSOCAN2",34,0)
 N PSOTRIC S PSOTRIC="",PSOTRIC=$$TRIC^PSOREJP1(RXIEN,RFCNT,PSOTRIC)
"RTN","PSOCAN2",35,0)
 D SUBMIT^PSOREJU3(RXIEN,RFCNT,PSOTRIC)
"RTN","PSOCAN2",36,0)
 ;
"RTN","PSOCAN2",37,0)
 W !?3,"Prescription #",RX_": "
"RTN","PSOCAN2",38,0)
 W !?6,$S('RFCNT:"  Filled",1:"  Refilled # "_LREF)_": "_XFDT,"  Printed: "_$S(LREF=RFCNT:XLPDT,1:""),"  Released: "_$G(XRELDT),!
"RTN","PSOCAN2",39,0)
 I FDT<DT D
"RTN","PSOCAN2",40,0)
 .Q:$$FIND^PSOREJUT(RXIEN)  ;No label for Rx's with unresolved claims rejects
"RTN","PSOCAN2",41,0)
 .Q:PSOTRIC&($$STATUS^PSOBPSUT(RXIEN,RFCNT)["IN PROGRESS")  ;No labels for TRICARE/CHAMPVA in progress Rx *396
"RTN","PSOCAN2",42,0)
 .I PSOTRIC,$P($G(^PSRX(RXIEN,"STA")),"^")=12 Q  ;No label for TRICARE/CHAMPVA if discontinued via Reject Notification screen *396
"RTN","PSOCAN2",43,0)
 .S DIR("A")="     ** Do you want to print the label now",DIR("B")="N",DIR(0)="Y",DIR("?")="Enter 'Y' to print the label now.  If 'N' is entered, the label may be reprinted through reprint at a later date."
"RTN","PSOCAN2",44,0)
 .D ^DIR K DIR Q:$G(DIRUT)!('Y)  S PPL=RXIEN D Q^PSORXL Q
"RTN","PSOCAN2",45,0)
 I FDT=DT D
"RTN","PSOCAN2",46,0)
 . Q:$$FIND^PSOREJUT(RXIEN)  ;No label for Rx's with unresolved claims rejects
"RTN","PSOCAN2",47,0)
 . Q:PSOTRIC&($$STATUS^PSOBPSUT(RXIEN,RFCNT)["IN PROGRESS")  ;No labels for TRICARE/CHAMPVA in progress Rx *396
"RTN","PSOCAN2",48,0)
 . I PSOTRIC,$P($G(^PSRX(RXIEN,"STA")),"^")=12 Q  ;No label for TRICARE/CHAMPVA if discontinued via Reject Notification screen *396
"RTN","PSOCAN2",49,0)
 . W !?5,"Either print the label using the reprint option "
"RTN","PSOCAN2",50,0)
 . W !?7,"or check later to see if the label has been printed." D WAIT^PSODRG Q
"RTN","PSOCAN2",51,0)
 I FDT>DT&('$G(DODR)) W !?5,"Placing Rx on suspense.  Please wait..." D SUS
"RTN","PSOCAN2",52,0)
 K DODR
"RTN","PSOCAN2",53,0)
 Q
"RTN","PSOCAN2",54,0)
SUS ;Adds rec to suspense
"RTN","PSOCAN2",55,0)
 S ACT=1,RXN=DA,RX0=^PSRX(DA,0),RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK S DA=RXN
"RTN","PSOCAN2",56,0)
 S RXP=$S($D(RXP):RXP,1:0),DIC="^PS(52.5,",DIC(0)="L",X=RXN,DIC("DR")=".02///"_FDT_";.03///"_$P(RX0,"^",2)_";.04///M;.05///"_RXP_";.06////"_$G(PSOSITE)_";2///0" K DD,DO D FILE^DICN
"RTN","PSOCAN2",57,0)
 I +$G(Y),$G(RFCNT)'="" S $P(^PS(52.5,+Y,0),"^",13)=$G(RFCNT)
"RTN","PSOCAN2",58,0)
 S DA=RXN,$P(^PSRX(DA,"STA"),"^")=5,LFD=$E($P(^PSRX(DA,3),"^"),4,5)_"-"_$E($P(^(3),"^"),6,7)_"-"_$E($P(^(3),"^"),2,3)
"RTN","PSOCAN2",59,0)
 S ACOM="RX Placed on Suspense until "_LFD D AREC^PSOCAN1 S ST="SC",PHST="ZS" D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST
"RTN","PSOCAN2",60,0)
 Q
"RTN","PSOCAN2",61,0)
DRGDRG ;Checks for drug/drug interaction, duplicate drug and class
"RTN","PSOCAN2",62,0)
 Q:$P(^PSRX(DA,2),"^",6)<DT
"RTN","PSOCAN2",63,0)
 S (PSORX("DFLG"),PSORXED("DFLG"))=0
"RTN","PSOCAN2",64,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSOCAN2",65,0)
 S STAT=$P(STA,"^",$P(^PSRX(DA,"STA"),"^")+1)
"RTN","PSOCAN2",66,0)
 S X=$P(^PSRX(DA,0),"^",6),DIC="^PSDRUG(",DIC(0)="MZO" D ^DIC K DIC Q:$D(DTOUT)!(Y<0)
"RTN","PSOCAN2",67,0)
 K HOLD S NAME=$P(Y(0),"^") I +$G(PSOSD(STAT,NAME))=+PSCAN(RX) S HOLD(STAT,NAME)=$G(PSOSD(STAT,NAME)) K PSOSD(STAT,NAME)
"RTN","PSOCAN2",68,0)
 S:$G(PSONEW("OLD VAL"))=+Y PSODRG("QFLG")=1
"RTN","PSOCAN2",69,0)
 K PSOY,PSOTECCK S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSOCAN2",70,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S PSOTECCK=1
"RTN","PSOCAN2",71,0)
 S PSORENW("OIRXN")=DA D SET^PSODRG,POST^PSODRG Q:$G(PSOREINS)&$G(PSOQUIT)
"RTN","PSOCAN2",72,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("C")
"RTN","PSOCAN2",73,0)
 S REA=$P(PSCAN($P(^PSRX(PSORENW("OIRXN"),0),"^")),"^",2)
"RTN","PSOCAN2",74,0)
 W ! S:$G(HOLD(STAT,NAME))]"" PSOSD(STAT,NAME)=$G(HOLD(STAT,NAME)) K HOLD,STA,STAT,PSORENW("OIRXN")
"RTN","PSOCAN2",75,0)
 Q
"RTN","PSOCAN2",76,0)
VERIFY ;Put in non-verify file
"RTN","PSOCAN2",77,0)
 S PSRXDA=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXDA,DIC(0)="ML",DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN2",78,0)
 K DD,DO D FILE^DICN K DIC,DLAYGO,DINUM
"RTN","PSOCAN2",79,0)
 S DA=PSRXDA S $P(^PSRX(DA,"STA"),"^")=1
"RTN","PSOCAN2",80,0)
 S ST="SC",PHST="IP",VCOM="Put in non-verified status" D EN^PSOHLSN1(DA,ST,PHST,VCOM) K ST,PHST,VCOM
"RTN","PSOCAN2",81,0)
 Q
"RTN","PSOCAN2",82,0)
HLD N PSDTEST,PDA,CMOP,SUSD I $P(^PSRX(DA,"STA"),"^")=3 D
"RTN","PSOCAN2",83,0)
 .S ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while on hold during Rx cancel. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")=""
"RTN","PSOCAN2",84,0)
 .I $P(^PSRX(DA,0),"^",13),'$O(^PSRX(DA,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(DA,0),"^",13),1,7) D ^DIE K DIE,DR Q
"RTN","PSOCAN2",85,0)
 .S (IFN,SUSD)=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S SUSD=IFN,RFDT=$P(^PSRX(DA,1,IFN,0),"^")
"RTN","PSOCAN2",86,0)
 .Q:'$G(SUSD)  I '$P(^PSRX(DA,1,SUSD,0),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(DA,1,SUSD),^PSRX("AD",RFDT,DA,SUSD),^PSRX(DA,1,"B",RFDT,SUSD),IFN,SUSD,RFDT
"RTN","PSOCAN2",87,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(DA,"L",PDA)) Q:'PDA  I $P($G(^PSRX(DA,"L",PDA,0)),"^",2)=SUSD S PSDTEST=1
"RTN","PSOCAN2",88,0)
 ..K CMOP D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOCAN2",89,0)
 ..S PSDTEST=1
"RTN","PSOCAN2",90,0)
 Q
"RTN","PSOCAN2",91,0)
REF S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I $P($G(^PSRX(DA,1,IFN,0)),"^")=SUSD,'$P(^(0),"^",18) D
"RTN","PSOCAN2",92,0)
 .D DELREF I $G(PSORFDEL) K PSORFDEL Q
"RTN","PSOCAN2",93,0)
 .;PSO*7*259;CHECK IF REFILL RELEASED OR LABEL PRINTED
"RTN","PSOCAN2",94,0)
 .I $P($G(^PSRX(DA,1,IFN,0)),"^",18)]"" Q  ;REFILL RELEASED
"RTN","PSOCAN2",95,0)
 .N PSONODEL,PSOLBL S PSONODEL=0
"RTN","PSOCAN2",96,0)
 .I $P(^PSRX(DA,"STA"),"^")=5 D REF^PSOCAN4 Q:PSONODEL
"RTN","PSOCAN2",97,0)
 .S PSOLBL="" F  S PSOLBL=$O(^PSRX(DA,"L",PSOLBL),-1) Q:'PSOLBL  Q:PSONODEL  Q:$P(^PSRX(DA,"L",PSOLBL,0),"^",2)<IFN  I $P(^PSRX(DA,"L",PSOLBL,0),"^",2)=IFN S PSONODEL=1
"RTN","PSOCAN2",98,0)
 .Q:PSONODEL
"RTN","PSOCAN2",99,0)
 .K PSORFDEL K ^PSRX(DA,1,IFN),^PSRX("AD",SUSD,DA,IFN),^PSRX(DA,1,"B",SUSD,IFN)
"RTN","PSOCAN2",100,0)
 .S $P(^PSRX(DA,1,0),"^",4)=$P(^PSRX(DA,1,0),"^",4)-1,DA(1)=DA
"RTN","PSOCAN2",101,0)
 .S NODE=0 D SPR^PSOUTL K DA(1),RF,NODE
"RTN","PSOCAN2",102,0)
 S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I '$O(^PSRX(DA,1,IFN)) S $P(^PSRX(DA,3),"^")=+$P(^PSRX(DA,1,IFN,0),"^"),$P(^(3),"^",2)=SUSD
"RTN","PSOCAN2",103,0)
 I '$O(^PSRX(DA,1,0)) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,2),"^",2),$P(^PSRX(DA,3),"^",2)=SUSD
"RTN","PSOCAN2",104,0)
 K IFN,SUSD
"RTN","PSOCAN2",105,0)
 Q
"RTN","PSOCAN2",106,0)
KILL K %,ACNT,ACOM,ACT,ALL,BCNUM,CMOP,CNT,DA,DAYS360,DEAD,DRG,DIRUT,DR,DRUG,DTOUT,DUOUT,FDT,HOLD,I,II,IN,IT,JJ,LC,LFD,LINE,LL,LPRT,LREF,LSI,NAME,NDF,NOEXP,NSF,OUT,RXSP,EN,WARN K:'$G(POERR) INCOM
"RTN","PSOCAN2",107,0)
 K PSODRUG,PCNT,POP,PPL,PS,PSFROM,PSINV,PLINE,PSI,PSINV,PSOCAN,PSOCMOP,PSODFN,PSODRG,PSOOPT,PSOSD,PSPOP,PSRXDA,PSS,PSVC,PSONOOR
"RTN","PSOCAN2",108,0)
 K REA,RELDT,RF,RFDATE,RFCNT,RFL,RFL1,RFLL,RP,RX,RX0,RXCNT,RXDA,RXN,RXNUM,RXP,RXREC,RXREF,RXS,SDATE,SPCANC,SS,STAT,SUB,X,XFDT,XLPDT,XRELDT,Y D KVA^VADPT Q
"RTN","PSOCAN2",109,0)
DELREF ;
"RTN","PSOCAN2",110,0)
 N RDL,PSCNODE
"RTN","PSOCAN2",111,0)
 S PSORFDEL=0
"RTN","PSOCAN2",112,0)
 F RDL=0:0 S RDL=$O(^PSRX(DA,4,RDL)) Q:'RDL  I $G(IFN)=$P($G(^PSRX(DA,4,RDL,0)),"^",3) S PSCNODE=$G(^(0))
"RTN","PSOCAN2",113,0)
 I $G(PSCNODE)="" Q
"RTN","PSOCAN2",114,0)
 I +$P(PSCNODE,"^",4)<3 S PSORFDEL=1
"RTN","PSOCAN2",115,0)
 Q
"RTN","PSOCAN2",116,0)
AUTOD ;reinstates Rxs dc'd by date of death
"RTN","PSOCAN2",117,0)
 I $G(^PSRX(DA,"DDSTA"))']"" K ^PSRX("APSOD",+$P(^PSRX(DA,0),"^",2),DA),DODR Q
"RTN","PSOCAN2",118,0)
 S DODS=$P(^PSRX(DA,"DDSTA"),"^"),DODD=$P(^("DDSTA"),"^",2,245)
"RTN","PSOCAN2",119,0)
 S FILE=$P(DODS,";"),STA=$P(DODS,";",2)
"RTN","PSOCAN2",120,0)
 I FILE=52.4 D  Q
"RTN","PSOCAN2",121,0)
 .S RXN=DA,^PS(52.4,DA,0)=DODD,DIK="^PS(52.4," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",122,0)
 .S ST="SC",PHST="IP",ACOM="Date of Death Deleted. Returned to Non-Verified status."
"RTN","PSOCAN2",123,0)
 .K ^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",124,0)
 .S DA=RXN D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,RXN
"RTN","PSOCAN2",125,0)
 I FILE=52.5 D  Q
"RTN","PSOCAN2",126,0)
 .;Adds rec to suspense
"RTN","PSOCAN2",127,0)
 .S RXN=DA,RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK
"RTN","PSOCAN2",128,0)
 .S DIC="^PS(52.5,",DIC(0)="L",X=RXN K DD,DO D FILE^DICN S DA=+Y
"RTN","PSOCAN2",129,0)
 .S ^PS(52.5,DA,0)=DODD,^PS(52.5,DA,"P")=0,LFD=$E($P(^PS(52.5,DA,0),"^",2),4,5)_"-"_$E($P(^(0),"^",2),6,7)_"-"_$E($P(^(0),"^",2),2,3)
"RTN","PSOCAN2",130,0)
 .S DIK="^PS(52.5," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",131,0)
 .S ACOM="Date of Death Deleted. RX Placed on Suspense until "_LFD
"RTN","PSOCAN2",132,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",133,0)
 .I STA=5 S ST="SC",PHST="ZS" D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,LFD
"RTN","PSOCAN2",134,0)
 I FILE=52 S ^PSRX(DA,"STA")=STA I STA=3!(STA=16) D  Q
"RTN","PSOCAN2",135,0)
 .S ^PSRX(DA,"H")=DODD,^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)=""
"RTN","PSOCAN2",136,0)
 .S ACOM="Date of Death Deleted. Medication Returned to"_$S(STA=16:" Provider",1:"")_" Hold Status "_$E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3)_"."
"RTN","PSOCAN2",137,0)
 .D LOG,EN^PSOHLSN1(DA,"OH","",ACOM) K ACOM
"RTN","PSOCAN2",138,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",139,0)
 S ACOM="Date of Death Deleted. Prescription Reinstated." D EN^PSOHLSN1(DA,"SC","CM",ACOM),LOG K ACOM
"RTN","PSOCAN2",140,0)
 K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",141,0)
 Q
"RTN","PSOCAN2",142,0)
LOG K ACNT F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",143,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=$G(RFCNT)+1 S:RF>5 RFCNT=$G(RFCNT)+1
"RTN","PSOCAN2",144,0)
 S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",145,0)
 D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(DA,"A",ACNT,0)=%_"^R^"_DUZ_"^"_RFCNT_"^"_ACOM
"RTN","PSOCAN2",146,0)
 K ^PSRX("APSOD",PSODFN,DA),ACNT,RFCNT,RF,%
"RTN","PSOCAN2",147,0)
 I $P(^PSRX(DA,3),"^",10) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,3),"^",10) ;*396
"RTN","PSOCAN2",148,0)
 S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8)
"RTN","PSOCAN2",149,0)
 S $P(^PSRX(DA,3),"^",5)="",$P(^(3),"^",8)=""
"RTN","PSOCAN2",150,0)
 Q
"RTN","PSOCAN2",151,0)
NVER ;Called from PSOCAN3, needs DA defined
"RTN","PSOCAN2",152,0)
 N PSONVC,PSONVCP,PSONVCC
"RTN","PSOCAN2",153,0)
 S PSONVC="SC",PSONVCP="IP",PSONVCC="Put in non-verified status" D EN^PSOHLSN1(DA,PSONVC,PSONVCP,PSONVCC)
"RTN","PSOCAN2",154,0)
 Q
"RTN","PSOCAN2",155,0)
RMB(IDX) ;remove Rx if found in array BBRX() (Bingo Board)
"RTN","PSOCAN2",156,0)
 N ST4,ST5,ST6,K
"RTN","PSOCAN2",157,0)
 S ST4=BBRX(IDX) Q:ST4'[(DA_",")
"RTN","PSOCAN2",158,0)
 S ST6=""
"RTN","PSOCAN2",159,0)
 F K=1:1 S ST5=$P(ST4,",",K) Q:'ST5  D
"RTN","PSOCAN2",160,0)
 . S:ST5'=DA ST6=ST6_$S('ST6:"",1:",")_ST5
"RTN","PSOCAN2",161,0)
 . S:ST6]"" BBRX(IDX)=ST6_"," K:ST6="" BBRX(IDX)
"RTN","PSOCAN2",162,0)
 I '$D(BBRX) K BINGCRT
"RTN","PSOCAN2",163,0)
 Q
"RTN","PSOCAN2",164,0)
 ;
"RTN","PSOCAN3")
0^42^B71895056
"RTN","PSOCAN3",1,0)
PSOCAN3 ;BIR/RTR/SAB - auto dc rxs due to death ;2/05/97 2:59pm
"RTN","PSOCAN3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,24,27,32,36,94,88,117,131,146,139,132,223,235,148,249,225,324,251,375,379,372**;DEC 1997;Build 54
"RTN","PSOCAN3",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN3",4,0)
 ;External references to L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN3",5,0)
 Q
"RTN","PSOCAN3",6,0)
APSOD(PSODFN) ;called from file #2 date of death xref 'APOSD'
"RTN","PSOCAN3",7,0)
 N D,DA,DB,DC,DE,DG,DH,DI,DIC,DIE,DIG,DIH,DIK,DIR,DIQ,DIU,DIV,DIW,DK,DL,DM,DP,DQ,DU,DV,DW,DR
"RTN","PSOCAN3",8,0)
 S PSODEATH=1 D CAN K PSODEATH
"RTN","PSOCAN3",9,0)
 Q
"RTN","PSOCAN3",10,0)
CAN ;discontinued rxs due to death
"RTN","PSOCAN3",11,0)
 I $G(PSODFN),$D(^PS(52.91,PSODFN,0)) D
"RTN","PSOCAN3",12,0)
 .I '$P($G(^PS(52.91,PSODFN,0)),"^",3)!($P($G(^(0)),"^",3)>DT) S $P(^PS(52.91,PSODFN,0),"^",3)=DT,$P(^PS(52.91,PSODFN,0),"^",4)=5,^PS(52.91,"AX",DT,PSODFN)="" D SET^PSOTPCAN(PSODFN)
"RTN","PSOCAN3",13,0)
 F PSORXJ=0:0 S PSORXJ=$O(^PS(55,PSODFN,"P",PSORXJ)) Q:'PSORXJ  I $D(^(PSORXJ,0)) S PSORX=^(0) S STA=$S($P($G(^PSRX(PSORX,"STA")),"^")<11:1,$P($G(^("STA")),"^")=16:1,1:0) D:STA
"RTN","PSOCAN3",14,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,"STA")),"^")="" D SETC
"RTN","PSOCAN3",15,0)
 .D REVERSE^PSOBPSU1(PSORX,,"DC",7)
"RTN","PSOCAN3",16,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,2)),"^",6)'<DT S PSO0=^(0),PSO2=$G(^(2)) D
"RTN","PSOCAN3",17,0)
 ..S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")
"RTN","PSOCAN3",18,0)
 ..;remove from hold
"RTN","PSOCAN3",19,0)
 ..I $G(^PSRX(PSORX,"H"))]"" D
"RTN","PSOCAN3",20,0)
 ...S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PSRX(PSORX,"H")
"RTN","PSOCAN3",21,0)
 ...K:$P(^PSRX(PSORX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSORX,"H"),"^"),PSORX) S ^PSRX(PSORX,"H")=""
"RTN","PSOCAN3",22,0)
 ...I '$P($G(^PSRX(PSORX,2)),"^",2),$P($G(^(3)),"^") S $P(^PSRX(PSORX,2),"^",2)=$P(^(3),"^")
"RTN","PSOCAN3",23,0)
 ...I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",24,0)
 ..;delete from non-verified file
"RTN","PSOCAN3",25,0)
 ..I $G(^PS(52.4,PSORX,0))]"" S ^PSRX(PSORX,"DDSTA")="52.4;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PS(52.4,PSORX,0),DIK="^PS(52.4,",DA=PSORX D ^DIK K DIK
"RTN","PSOCAN3",26,0)
 ..I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",27,0)
 ..;delete from suspense
"RTN","PSOCAN3",28,0)
 ..D:$O(^PS(52.5,"B",PSORX,0))
"RTN","PSOCAN3",29,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)) I '$G(^PS(52.5,DA,"P")),$G(PSODEATH) S ^PSRX(PSORX,"DDSTA")="52.5;5^"_^PS(52.5,DA,0),^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",30,0)
 ...I $O(^PSRX(PSORX,1,0)),'$G(PSODEATH) S DA=PSORX,SUSD=$P($G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),0)),"^",2) D:'$G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),"P")) REF^PSOCAN2
"RTN","PSOCAN3",31,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)),DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",32,0)
 ..D SETC
"RTN","PSOCAN3",33,0)
 ..;activity record
"RTN","PSOCAN3",34,0)
 ..S (COM,ACOM)=$S($G(PSODEATH):"Date of Death Entered by MAS",1:"Discontinued by Pharmacy")_"."
"RTN","PSOCAN3",35,0)
 ..S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(PSORX,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOCAN3",36,0)
 ..S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(PSORX,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN3",37,0)
 ..D NOW^%DTC S ACNT=ACNT+1,^PSRX(PSORX,"A",0)="^52.3DA^"_ACNT_"^"_ACNT
"RTN","PSOCAN3",38,0)
 ..S ^PSRX(PSORX,"A",ACNT,0)=%_"^"_"C"_"^^"_RFCNT_"^"_"Auto Discontinued Due to Death. "_ACOM
"RTN","PSOCAN3",39,0)
 ..;check for label/release/pending release
"RTN","PSOCAN3",40,0)
 ..D FIL
"RTN","PSOCAN3",41,0)
 ..S STAT="OD",PHARMST="" D EN^PSOHLSN1(PSORX,STAT,PHARMST,COM,"A") K COMM,PHARMST,STAT
"RTN","PSOCAN3",42,0)
 ;dc pending orders
"RTN","PSOCAN3",43,0)
 F PDA=0:0 S PDA=$O(^PS(52.41,"P",PSODFN,PDA)) Q:'PDA  I $P(^PS(52.41,PDA,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") D
"RTN","PSOCAN3",44,0)
 .I $G(PSODEATH) D
"RTN","PSOCAN3",45,0)
 ..S ^PS(52.41,PDA,"DDSTA")=$P(^PS(52.41,PDA,0),"^",3)_";"_+$P($G(^PS(52.41,PDA,"INI")),"^"),^PS(52.41,"APSOD",PSODFN,PDA)=""
"RTN","PSOCAN3",46,0)
 ..S $P(^PS(52.41,PDA,4),"^")="Date of Death Entered by MAS."
"RTN","PSOCAN3",47,0)
 .S $P(^PS(52.41,PDA,0),"^",3)="DC"
"RTN","PSOCAN3",48,0)
 .K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,PDA,"INI")),"^"),PDA)
"RTN","PSOCAN3",49,0)
 .S COM=$S($G(PSODEATH):"Date of Death Entered by MAS.",1:""),PL=$P(^PS(52.41,PDA,0),"^"),$P(^(0),"^",3)="DC"
"RTN","PSOCAN3",50,0)
 .D EN^PSOHLSN(PL,"OC",COM,"A") K COM,PL
"RTN","PSOCAN3",51,0)
 ;dc non-va meds
"RTN","PSOCAN3",52,0)
 D APSOD^PSONVNEW
"RTN","PSOCAN3",53,0)
KILL K %,%H,%T,ACNT,DA,PDA,DIRUT,DTOUT,PSO,PSO0,PSO2,PSOD,PSOD0,PSODFN,PSODL,PSORX,PSORXJ,PSOSD,RF,RFCNT,SUB,TM,TSKDT,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSOCAN3",54,0)
 D KVAR^VADPT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCAN3",55,0)
 Q
"RTN","PSOCAN3",56,0)
CAN1 Q:$G(DODR)
"RTN","PSOCAN3",57,0)
 S PSOMGDFN=$G(PSODFN) ; SAVE IN CASE CANCELING RX THAT WAS MERGED TO ANOTHER DFN
"RTN","PSOCAN3",58,0)
 I $G(^PSRX(DA,"H"))]"" D HLD^PSOCAN2
"RTN","PSOCAN3",59,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7)
"RTN","PSOCAN3",60,0)
 S PSCANVAR=0,RXDA=DA,DA=$O(^PS(52.5,"B",DA,0)) I DA,'$G(^PS(52.5,DA,"P")) S PSCANVAR=1 D
"RTN","PSOCAN3",61,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOCAN3",62,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while suspended. "_$G(COM)
"RTN","PSOCAN3",63,0)
 .S DIK="^PS(52.5," D ^DIK K DIK S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2)
"RTN","PSOCAN3",64,0)
 .D AREC^PSOCAN1 S DA=RXDA I $O(^PSRX(DA,1,0)) D REF^PSOCAN2
"RTN","PSOCAN3",65,0)
 I $G(REA)="C" S DA=$O(^PS(52.5,"B",RXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",66,0)
 I 'PSCANVAR S:$D(SPCANC) ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" during Rx cancel.  "
"RTN","PSOCAN3",67,0)
ADD S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) S:$G(PSOOPT)=3 REA="L"
"RTN","PSOCAN3",68,0)
 D:'$G(PSCANVAR) AREC^PSOCAN1 S:REA="L" REA="C"
"RTN","PSOCAN3",69,0)
 S:REA'="C" $P(^PSRX(DA,"STA"),"^")=0,$P(^(7),"^")=""
"RTN","PSOCAN3",70,0)
 N PSOTPCNZ S PSOTPCNZ=0 I $P(^PSRX(DA,"STA"),"^")'=12 S PSOTPCNZ=1
"RTN","PSOCAN3",71,0)
 S:REA="C"&($P(^PSRX(DA,"STA"),"^")<12)!($P(^("STA"),"^")=16) $P(^PSRX(DA,"STA"),"^")=12 I $P($G(^PSRX(DA,"STA")),"^")=12,$G(PSOTPCNZ) D CAN^PSOTPCAN(DA)
"RTN","PSOCAN3",72,0)
 K PSOTPCNZ
"RTN","PSOCAN3",73,0)
 I REA="R" D
"RTN","PSOCAN3",74,0)
 .I $P(^PSRX(DA,3),"^",8) S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8),$P(^(3),"^",8)=""
"RTN","PSOCAN3",75,0)
 .S $P(^PSRX(DA,3),"^")=$S($P(^PSRX(DA,3),"^",10):$P(^(3),"^",10),$G(PSOCANHD):PSOCANHD,$P(^(3),"^",5):$P(^(3),"^",5),1:$P(^(3),"^")),$P(^(3),"^",5)="",$P(^(3),"^",10)=""
"RTN","PSOCAN3",76,0)
 I REA="C" D
"RTN","PSOCAN3",77,0)
 .S $P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOCAN3",78,0)
 .S:'$P(^PSRX(DA,3),"^",5) $P(^PSRX(DA,3),"^",5)=DT
"RTN","PSOCAN3",79,0)
 .I $O(^PS(52.41,"ARF",DA,0)),'$O(^PS(52.41,"APSOD",PSODFN,0)) S HLDDA=DA,DA=$O(^PS(52.41,"ARF",DA,0)),DIK="^PS(52.41," D ^DIK S DA=HLDDA K HLDDA
"RTN","PSOCAN3",80,0)
 .;check for label/release/pending release
"RTN","PSOCAN3",81,0)
 .I $G(PSOOPT)'=3 D FILX
"RTN","PSOCAN3",82,0)
 S PSONOOR=$S($D(PSONOOR):PSONOOR,1:"D"),STAT=$S(REA="C":"OD",1:"SC"),PHARMST=$S(REA="C":"",1:"CM")
"RTN","PSOCAN3",83,0)
 S COM=$S(REA="C":$S($G(PSOOPT)=3&('$G(DUP)):"Renewed",1:"Discontinued")_" by Pharmacy",1:"Reinstated by Pharmacy")
"RTN","PSOCAN3",84,0)
 D EN^PSOHLSN1(DA,STAT,PHARMST,$S(COM["Discontinued"&($D(INCOM)):INCOM,1:COM),$S($G(PSOOPT)=3&('$G(DUP)):"",1:PSONOOR)) K COM,STAT,PHARMST,PSCANVAR
"RTN","PSOCAN3",85,0)
 I REA="C" D
"RTN","PSOCAN3",86,0)
 .I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOCAN3",87,0)
 I $G(PSOMGDFN)'="" S PSODFN=PSOMGDFN K PSOMGDFN
"RTN","PSOCAN3",88,0)
 S PSVC=$P(^PSRX(DA,0),"^",16)
"RTN","PSOCAN3",89,0)
 Q:(REA="C")!($P(^PSRX(DA,2),"^",10)]"")
"RTN","PSOCAN3",90,0)
 Q:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2))
"RTN","PSOCAN3",91,0)
 S PSRXIN=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXIN,DIC(0)="ML"
"RTN","PSOCAN3",92,0)
 S DIC("DR")="1////"_$G(PSODFN)_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN3",93,0)
 K DD,DO D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM
"RTN","PSOCAN3",94,0)
 K DA,DIK S DA=PSRXIN K PSRXIN S $P(^PSRX(DA,"STA"),"^")=1 D NVER^PSOCAN2
"RTN","PSOCAN3",95,0)
 W !,"Rx # "_$P(^PSRX(DA,0),"^")_" is still non-verified!"
"RTN","PSOCAN3",96,0)
 Q
"RTN","PSOCAN3",97,0)
OERR I '$D(^XUSEC("PSORPH",DUZ)),'$P($G(PSOPAR),"^",2) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOCAN3",98,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOCAN3",99,0)
 K PSOPLCK S PSOCANRD=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",4),PSOCANRA=1
"RTN","PSOCAN3",100,0)
 I $P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^"),$P(^("STA"),"^")=1!($P(^("STA"),"^")=4) S:$G(SPEED) PSONOORS=$G(PSONOOR) D DEL^PSOCAN4 S:$G(PSONOORS)'="" PSONOOR=$G(PSONOORS) K PSONOORS D KCAN D ULP Q
"RTN","PSOCAN3",101,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D KCAN D ULP Q
"RTN","PSOCAN3",102,0)
 I '+^PSRX($P(PSOLST(ORN),"^",2),"OR1"),$P(^("STA"),"^")=12 S VALMSG="Rx Cannot be Reinstated.  No Orderable Item." D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",103,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12,$P($G(^("PKI")),"^") S VALMSG="Cannot be Reinstated - Digitally Signed" D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",104,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 S PSOCANRZ=1
"RTN","PSOCAN3",105,0)
 D HLDHDR^PSOLMUTL S X=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),PS=$S($P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^")=12:"Reinstate: ",1:"Discontinue: ")
"RTN","PSOCAN3",106,0)
 S POERR=1,DFNHLD=PSODFN,DA=$P(PSOLST(ORN),"^",2) N PSOREINS,PSOONOFC S PSOREINS=1
"RTN","PSOCAN3",107,0)
 I $G(PSORX("DOSING OFF")) S PSOREINF=1
"RTN","PSOCAN3",108,0)
 I $P(^PSRX(DA,3),"^",5) S PSOCANHD=$P(^PSRX(DA,3),"^",5)
"RTN","PSOCAN3",109,0)
 D LMNO S:$G(PSOONOFC) PSORX("DOSING OFF")=1 I $G(PSOQUIT) D ULP,KCAN S VALMBCK="R" Q
"RTN","PSOCAN3",110,0)
 D:$P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 RMP
"RTN","PSOCAN3",111,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOCAN3",112,0)
 K POERR,PSCAN,PSI,PSL,PSOREINF S PSODFN=DFNHLD K DFNHLD D ULP
"RTN","PSOCAN3",113,0)
 D KCAN
"RTN","PSOCAN3",114,0)
 Q
"RTN","PSOCAN3",115,0)
ULP D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOCAN3",116,0)
 Q
"RTN","PSOCAN3",117,0)
 ;
"RTN","PSOCAN3",118,0)
LMNO ; Calls LMNO^PSOCAN
"RTN","PSOCAN3",119,0)
 N PSODFN,PSORX,RXN,RX0
"RTN","PSOCAN3",120,0)
 S PSPOP=0,RXNUM=X S PSODFN=+$P(^PSRX(DA,0),"^",2) D LMNO^PSOCAN
"RTN","PSOCAN3",121,0)
 Q
"RTN","PSOCAN3",122,0)
 ;
"RTN","PSOCAN3",123,0)
KCAN ;
"RTN","PSOCAN3",124,0)
 K PSOCANRA,PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ,PSOMSG,PSOCANHD,PSOQUIT
"RTN","PSOCAN3",125,0)
 Q
"RTN","PSOCAN3",126,0)
 ;
"RTN","PSOCAN3",127,0)
KCAN1 ;
"RTN","PSOCAN3",128,0)
 K PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ
"RTN","PSOCAN3",129,0)
 Q
"RTN","PSOCAN3",130,0)
 ;
"RTN","PSOCAN3",131,0)
RMP D RMP^PSOCAN3N
"RTN","PSOCAN3",132,0)
 Q
"RTN","PSOCAN3",133,0)
 ;
"RTN","PSOCAN3",134,0)
FIL Q:'$G(PSORX)
"RTN","PSOCAN3",135,0)
 S PSOFC=PSORX G FILC
"RTN","PSOCAN3",136,0)
FILX Q:'$G(DA)
"RTN","PSOCAN3",137,0)
 S PSOFC=DA
"RTN","PSOCAN3",138,0)
FILC ;
"RTN","PSOCAN3",139,0)
 N PFC,PSOFFLAG
"RTN","PSOCAN3",140,0)
 I $P($G(^PSRX(PSOFC,2)),"^",13) G FILQ
"RTN","PSOCAN3",141,0)
 S PSOFFLAG=0 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,1,PFC)) Q:'PFC!(PSOFFLAG)  I $P($G(^PSRX(PSOFC,1,PFC,0)),"^",18) S PSOFFLAG=1
"RTN","PSOCAN3",142,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",143,0)
 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,"L",PFC)) Q:'PFC!(PSOFFLAG)  I $D(^PSRX(PSOFC,"L",PFC,0)),'$P($G(^(0)),"^",5) S PSOFFLAG=1
"RTN","PSOCAN3",144,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",145,0)
 S PSOFCSUS=$O(^PS(52.5,"B",PSOFC,0))
"RTN","PSOCAN3",146,0)
 I $G(PSOFCSUS),$P($G(^PS(52.5,PSOFCSUS,0)),"^",7)="L"!($P($G(^(0)),"^",7)="X") G FILQ
"RTN","PSOCAN3",147,0)
 S $P(^PSRX(PSOFC,3),"^",8)=$P($G(^PSRX(PSOFC,3)),"^",2)
"RTN","PSOCAN3",148,0)
 S $P(^PSRX(PSOFC,3),"^",2)=$P($G(^PSRX(PSOFC,2)),"^",2)
"RTN","PSOCAN3",149,0)
 I $P($G(^PSRX(PSOFC,"OR1")),"^",3) S $P(^PSRX(PSOFC,3),"^")=$P($G(^PSRX($P(^PSRX(PSOFC,"OR1"),"^",3),3)),"^")
"RTN","PSOCAN3",150,0)
FILQ K PSOFC,PSOFCSUS
"RTN","PSOCAN3",151,0)
 Q
"RTN","PSOCAN3",152,0)
 ;
"RTN","PSOCAN3",153,0)
SETC ;Called from Date of Death
"RTN","PSOCAN3",154,0)
 S $P(^PSRX(PSORX,"STA"),"^")=12,$P(^PSRX(PSORX,3),"^",5)=DT,$P(^PSRX(PSORX,3),"^",10)=$P(^PSRX(PSORX,3),"^") D CAN^PSOTPCAN(PSORX)
"RTN","PSOCAN3",155,0)
 D CHKCMOP^PSOUTL(PSORX,"D")
"RTN","PSOCAN3",156,0)
 Q
"RTN","PSODDPR2")
0^11^B94187291
"RTN","PSODDPR2",1,0)
PSODDPR2 ;BIR/SAB - display enhanced order checks ;11 May 2010  9:06 AM
"RTN","PSODDPR2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,372**;DEC 1997;Build 54
"RTN","PSODDPR2",3,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR2",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR2",5,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR2",6,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR2",7,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789 
"RTN","PSODDPR2",8,0)
 K ^UTILITY($J),PSODRUG("BAD"),THER,THERO,^TMP($J,"PSODCOR"),PSOINTV,PSOVAG,PSODD,PSI,PSORDIT
"RTN","PSODDPR2",9,0)
 I $O(^TMP($J,LIST,"OUT","EXCEPTIONS",""))]"" D EXC^PSODDPR5 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",10,0)
 N COUNT,DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV,PSOLINES,OLDDRG,PSOOLDD
"RTN","PSODDPR2",11,0)
 S (ON,DRG,SV,LSI,DGI,SER,SERS,PSOOLDD)="",(ZZDGDGC,CT,COUNT)=0,$P(PSONULN,"-",79)="-",$P(PSONULN1,"=",79)="=",ZHDR=1
"RTN","PSODDPR2",12,0)
 D NSRT^PSODDPR5 K ^TMP("PSODGI",$J),^TMP("PSOSER",$J),^TMP("PSOSERS",$J),^TMP("PSODGS",$J),^TMP("PSOTDD",$J,1) S (ON,DRG,SV,DGI,SER,SERS,ZVA)="",(ZST,ZORS,CT,COUNT)=0
"RTN","PSODDPR2",13,0)
 F  S SV=$O(ZZDGDG(SV)) Q:SV=""!$G(PSODLQT)  F  S ZST=$O(ZZDGDG(SV,ZST)) Q:'ZST!$G(PSODLQT)  F  S ZORS=$O(ZZDGDG(SV,ZST,ZORS)) Q:'ZORS!$G(PSODLQT)  D
"RTN","PSODDPR2",14,0)
 .F  S ZVA=$O(ZZDGDG(SV,ZST,ZORS,ZVA)) Q:ZVA=""!$G(PSODLQT)  F  S DRG=$O(ZZDGDG(SV,ZST,ZORS,ZVA,DRG)) Q:DRG=""!$G(PSODLQT)  S COUNT=COUNT+1 D DUP^PSODDPR8,BLD2^PSODGDGP
"RTN","PSODDPR2",15,0)
 K HZVA,ZVA,ZORS,ZZDGDG,COUNT,ON,DRG,SV,DGI,PSORX("INTERVENE"),DIR D HD() G EXIT:$G(PSODLQT) I +$G(PSOINTV) D INT G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",16,0)
 I $G(PSORX("DFLG")) W:$G(COPY) !,$C(7),"RX DELETED",! S PSORX("DFLG")=1,POERR("DFLG")=1,VALMBCK="R" G EXIT  Q
"RTN","PSODDPR2",17,0)
 I '$D(^XUSEC("PSORPH",DUZ)) K PSORX("INTERVENE")
"RTN","PSODDPR2",18,0)
 I $G(PSORX("INTERVENE"))]"" D FULL^VALM1,^PSORXI S:'$G(POERR) VALMBCK="R" W !
"RTN","PSODDPR2",19,0)
 I $G(PSORX("DFLG")) G EXIT
"RTN","PSODDPR2",20,0)
 I $O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",""))]"" D  G EXIT:PSODLQT  I ($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",21,0)
 .S NODDERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",22,0)
 .I ($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q
"RTN","PSODDPR2",23,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Interaction Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",24,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON)) Q:ON=""  F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT)) Q:'CT  D
"RTN","PSODDPR2",25,0)
 ..Q:$G(NODDERR)&($P(ON,";")'="Z")
"RTN","PSODDPR2",26,0)
 ..W ?5,$S($P(ON,";")="N":"",$P(ON,";")="R":"Remote Rx for ",$P(ON,";")="O":"Local Rx for ",1:"Prospective Rx for ")
"RTN","PSODDPR2",27,0)
 ..W " "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",28,0)
 ..D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",29,0)
 ;therapy
"RTN","PSODDPR2",30,0)
 ;D HD() G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",31,0)
THER I '$O(^TMP($J,LIST,"OUT","THERAPY",0)) G EXIT
"RTN","PSODDPR2",32,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$P(PSOPAR,"^",2),$G(PSOTECCK) G EXIT
"RTN","PSODDPR2",33,0)
 D NSRT1^PSODDPR5
"RTN","PSODDPR2",34,0)
 N ON,DDTH,CLASS,QTHER,ZDRG,ZTHER K DUPT,THER,THERO I '$P(PSOPAR,"^",10) D NOCAN^PSODDPR5 G ERR
"RTN","PSODDPR2",35,0)
 W @IOF,PSONULN1,! S (SUB,CT,LST,PSOZZ)=0 S THER=1,THERO=0,QTHER=1 K RXDT
"RTN","PSODDPR2",36,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT!$G(PSODLQT)  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB!$G(PSODLQT)  S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^") D
"RTN","PSODDPR2",37,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR2",38,0)
 .S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",39,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR2",40,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR2",41,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR2",42,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",43,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",44,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR2",45,0)
 .S ZOT=$S($P(ON,";")="O":1,$P(ON,";")="R":2,$P(ON,";")="P":3,1:4)
"RTN","PSODDPR2",46,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR2",47,0)
 ..I '$P(^PS(52.41,$P(ON,";",2),0),"^",9) S ZDRG=$P(^PS(50.7,$P(^PS(52.41,$P(ON,";",2),0),"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^") Q
"RTN","PSODDPR2",48,0)
 ..S ZDRG=$P(^PSDRUG($P(^PS(52.41,$P(ON,";",2),0),"^",9),0),"^")
"RTN","PSODDPR2",49,0)
 .I $P(ON,";")="O" S ZDRG=$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR2",50,0)
 .I $P(ON,";")="N" D
"RTN","PSODDPR2",51,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0)
"RTN","PSODDPR2",52,0)
 ..I '$P(DUPRX0,"^",2) S ZDRG=$P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^") Q
"RTN","PSODDPR2",53,0)
 ..S ZDRG=$P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR2",54,0)
 .I $P(ON,";")="R" D
"RTN","PSODDPR2",55,0)
 ..Q:'$D(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)))
"RTN","PSODDPR2",56,0)
 ..S RXREC=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)),ZDRG=$P(RXREC,"^",3)
"RTN","PSODDPR2",57,0)
 .S ZTHER(ZOT_"^"_ZDRG_"^"_ON)=ON K ZDRG
"RTN","PSODDPR2",58,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",59,0)
 I $O(ZTHER(""))]"" D
"RTN","PSODDPR2",60,0)
 .S (PSODUPF,PSODUPC,PSODUPC1)="" F  S PSODUPF=$O(ZTHER(PSODUPF)) Q:PSODUPF=""  S PSODUPC1=PSODUPC1+1
"RTN","PSODDPR2",61,0)
 .S PSODUPF=1,PSODUPC=0,PSODUPC("CLASS")="" D DUPCL S PSODUPF=0  ;get line counts for each duplicate therapy
"RTN","PSODDPR2",62,0)
 .D DUPCL K DDTH,PSODUPC,PSODUPF,PSODUPC1,PSODUPC2
"RTN","PSODDPR2",63,0)
 G EXIT:$G(PSODLQT)  K PSODCTH,RXDT,PSOZZ
"RTN","PSODDPR2",64,0)
 I $P(PSOPAR,"^",10),$O(^TMP($J,"PSODCOR",0)) D DCOR^PSODDPR3 K ^TMP($J,"PSODCOR") W !,PSONULN1,! ;D HD() G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",65,0)
 E  I $D(^XUSEC("PSORPH",DUZ)) S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",66,0)
ERR I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" D  S NODTERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",67,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Therapy Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",68,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON)) Q:ON=""!$G(PSODLQT)  F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT)) Q:'CT!$G(PSODLQT)  D
"RTN","PSODDPR2",69,0)
 ..Q:$G(NODTERR)&($P(ON,";")'="Z")!$G(PSODLQT)
"RTN","PSODDPR2",70,0)
 ..D HD() Q:$G(PSODLQT)  W ?5,$S($P(ON,";")="P":"Pending Order: ",$P(ON,";")="N":"Non-VA Med Order: ",$P(ON,";")="R":"Remote Rx: ",$P(ON,";")="O":"Rx: ",1:"Prospective Rx: ")
"RTN","PSODDPR2",71,0)
 ..D HD() Q:$G(PSODLQT)  W " "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",72,0)
 I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q:$G(PSODLQT)
"RTN","PSODDPR2",73,0)
 D HD()
"RTN","PSODDPR2",74,0)
EXIT ;
"RTN","PSODDPR2",75,0)
 D ^PSOBUILD
"RTN","PSODDPR2",76,0)
 K DSPL,CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSODDPR2",77,0)
 K IT,LST,THER,THERO,^UTILITY($J),DGI,SER,SEV,SERS,BSIG,I,NODDERR,NODTERR,PDRG,DRGI,STATUS,^UTILITY($J,"W"),X,ZX,DIWL,DIWR,DIWF,PSOINTV,ZTHER,PSOVORD,PSODCTH,ZZDGDG,ZZDGDG2
"RTN","PSODDPR2",78,0)
 Q
"RTN","PSODDPR2",79,0)
RX D HD() Q:$G(PSODLQT)  W ! S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",80,0)
 S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),STATUS=+$G(^PSRX(RXREC,"STA")),RXRECLOC=$G(RXREC),J=RXREC D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",81,0)
 I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODDPR2",82,0)
 I STATUS>10,STATUS'=16 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR W @IOF S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC Q
"RTN","PSODDPR2",83,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",84,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",85,0)
 I STATUS=16 W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! K DUP,RXRECLOC S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",86,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",87,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODDPR2",88,0)
 .W !!,"Another person is editing Rx #"_$P($G(^PSRX(RXREC,0)),"^"),!
"RTN","PSODDPR2",89,0)
 K PSOMSG S DIR("A")=$S(STATUS=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(RXREC,0),"^"),DIR(0)="Y",DIR("?")="Enter Y to "_$S(STATUS=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODDPR2",90,0)
 D ^DIR K DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR2",91,0)
 S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S(STATUS=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODDPR2",92,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODDPR2",93,0)
 I 'Y W $C(7)," -Prescription was not "_$S(STATUS=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODDPR2",94,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S(STATUS=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP
"RTN","PSODDPR2",95,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODDPR2",96,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S(STATUS=12:"R",1:"C")
"RTN","PSODDPR2",97,0)
 W !!,"THERAPEUTIC DUPLICATIONS will be discontinued after the acceptance of the new order.",!!
"RTN","PSODDPR2",98,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_ST_"^"_DRG,PSONOOR="D"
"RTN","PSODDPR2",99,0)
 K RXRECLOC,DUP,CLS,PSONOOR,STATUS,ACT,PSONV,REA,SPCANC
"RTN","PSODDPR2",100,0)
 Q
"RTN","PSODDPR2",101,0)
DUPCL ;
"RTN","PSODDPR2",102,0)
 Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC=PSODUPC+1 W:'$G(PSODUPF) @IOF,PSONULN1,!
"RTN","PSODDPR2",103,0)
 I '$G(PSODUPF) W "*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with"
"RTN","PSODDPR2",104,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 N PSODUPCT,PSODUPC2,PSODUPCL S (PSODUPC2,PSODUPCT)=0 S:'$G(PSODUPF) PSODUPCT=2
"RTN","PSODDPR2",105,0)
 ;displays order and therapy
"RTN","PSODDPR2",106,0)
 K DDTH S (PSODUPCL,ZSUB,ZCT)="" F  S ZCT=$O(ZTHER(ZCT)) Q:ZCT=""!($G(PSODLQT))  S ON=ZTHER(ZCT) D
"RTN","PSODDPR2",107,0)
 .S PDODCNT=0,PSODUPC2=PSODUPC2+1 I $G(PSODUPF) S PSODUPC(ZCT)=0
"RTN","PSODDPR2",108,0)
 .I PSODUPC2=PSODUPC2+1
"RTN","PSODDPR2",109,0)
 .I '$G(PSODUPF) D
"RTN","PSODDPR2",110,0)
 ..I PSODUPC2=PSODUPC1,(PSODUPCT+PSODUPC(ZCT)+PSODUPC("CLASS"))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",111,0)
 ..I (PSODUPCT+PSODUPC(ZCT))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",112,0)
 ..S PSODUPCT=PSODUPCT+PSODUPC(ZCT)
"RTN","PSODDPR2",113,0)
 .I $P(ON,";")="O" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D DDRX^PSODDPR8 D
"RTN","PSODDPR2",114,0)
 ..Q:STATUS>5&(STATUS'=16)  Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""  Q:$G(RXDT("O",RXREC))
"RTN","PSODDPR2",115,0)
 ..S RX0=^PSRX(RXREC,0),J=RXREC,RX2=^PSRX(RXREC,2) D STAT^PSOFUNC K RX0,RX2  S PSOZZ=PSOZZ+1,^TMP($J,"PSODCOR",PSOZZ)="52"_"^"_RXREC_"^"_ST_"^"_DRGNM,RXDT("O",RXREC)=1
"RTN","PSODDPR2",116,0)
 .I $P(ON,";")="N" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D ^PSODDPR3
"RTN","PSODDPR2",117,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR2",118,0)
 ..D HD(8) Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! S RXREC=$P(ON,";",2) D PEND^PSODDPR8
"RTN","PSODDPR2",119,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""  Q:$G(RXDT("P",RXREC))  S PSOZZ=PSOZZ+1,DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR2",120,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)="P"_"^"_RXREC_"^^"_$S($P(DUPRX0,"^",9):$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"),1:$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"))
"RTN","PSODDPR2",121,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)=^TMP($J,"PSODCOR",PSOZZ)_"^"_$S('$P(DUPRX0,"^",9):$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"))
"RTN","PSODDPR2",122,0)
 ..S RXDT("P",RXREC)=1
"RTN","PSODDPR2",123,0)
 .I $P(ON,";")="R" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D RDI^PSODDPR3 D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",124,0)
 .I $O(ZTHER(ZCT))'="" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,PSONULN
"RTN","PSODDPR2",125,0)
 D CLASSES^PSODDPR3 Q:$G(PSODLQT)
"RTN","PSODDPR2",126,0)
 I '$G(PSODUPF)&'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODDPR2",127,0)
 .S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF
"RTN","PSODDPR2",128,0)
 .I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",129,0)
 .I '$G(PSODUPF),($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",130,0)
 Q
"RTN","PSODDPR2",131,0)
INT ;
"RTN","PSODDPR2",132,0)
 D INT^PSODDPR5
"RTN","PSODDPR2",133,0)
 Q
"RTN","PSODDPR2",134,0)
HD(PSOLINES,OVRRID) ;
"RTN","PSODDPR2",135,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODDPR2",136,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)<IOSL) Q
"RTN","PSODDPR2",137,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR,PSOLINES,OVRRID
"RTN","PSODDPR2",138,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",139,0)
 W:'$G(PSODUPF) @IOF
"RTN","PSODDPR2",140,0)
 Q
"RTN","PSODDPR3")
0^29^B102289019
"RTN","PSODDPR3",1,0)
PSODDPR3 ;BIR/SAB - display NVA enhanced order checks ;10/04/06 3:38pm
"RTN","PSODDPR3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,372**;DEC 1997;Build 54
"RTN","PSODDPR3",3,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSODDPR3",4,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSODDPR3",5,0)
 ;Reference ^PS(50.7 is supported by DBIA 2223
"RTN","PSODDPR3",6,0)
 ;Reference ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR3",7,0)
NVA S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0) N NVAQ
"RTN","PSODDPR3",8,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! I '$P(DUPRX0,"^",2) W:'$G(PSODUPF) $J("Non-VA Med: ",20)_$P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR3",9,0)
 E  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) $J("Non-VA Med: ",20)_$P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR3",10,0)
 ;W " (Active)"
"RTN","PSODDPR3",11,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Dosage: ",20)_$S($P(DUPRX0,"^",3)]"":$P(DUPRX0,"^",3),1:"<NOT ENTERED>"),$J("Schedule: ",20)_$S($P(DUPRX0,"^",5)]"":$P(DUPRX0,"^",5),1:"<NOT ENTERED>")
"RTN","PSODDPR3",12,0)
 K DSC,DSPL,CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSODDPR3",13,0)
 K LST,THER,THERO,^UTILITY($J),DGI,SER,SEV,SERS,BSIG,I,NODDERR,NODTERR,PDRG,DRGI,IZ
"RTN","PSODDPR3",14,0)
 K ^UTILITY($J,"W"),X,ZX,DIWL,DIWR,DIWF
"RTN","PSODDPR3",15,0)
 Q
"RTN","PSODDPR3",16,0)
MON ;print monograph
"RTN","PSODDPR3",17,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR3",18,0)
 N MONQ,DRGINFO,PVAGDRG,PVAGDRG,VAGDRG,MDRGCNT,MONSEV,PSOMON1,MONTITLE,FDBSEV,SMONTI,MONQ K DIR S DIR(0)="Y",DIR("A")="Display Interaction Monograph",DIR("B")="No" D ^DIR
"RTN","PSODDPR3",19,0)
 S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 W:$G(PSODLQT) !,PSONULN,! K DIR,DTOUT,DUOUT,DIRUT Q:'Y!($G(PSODLQT))
"RTN","PSODDPR3",20,0)
 ;ADD OUTPUT DEVICE
"RTN","PSODDPR3",21,0)
 K IOP,%ZIS,POP S %ZIS="QM" D ^%ZIS
"RTN","PSODDPR3",22,0)
 I POP W !,"NOTHING PRINTED" Q
"RTN","PSODDPR3",23,0)
 E  W !
"RTN","PSODDPR3",24,0)
 I $D(IO("Q")) D  Q
"RTN","PSODDPR3",25,0)
 .S ZTRTN="QUE^PSODDPR3",ZTDESC="Monograph Report of Drug Interactions",ZTSAVE("PSONULN")="",ZTSAVE("SEV")="",ZTSAVE("LIST")=""
"RTN","PSODDPR3",26,0)
 .S ZTSAVE("^TMP($J,LIST,""OUT"",""DRUGDRUG"",SV,DRG,ON,")="",ZTSAVE("ON")="",ZTSAVE("DRG")="",ZTSAVE("CT")="",ZTSAVE("PDRG")=""
"RTN","PSODDPR3",27,0)
 .S ZTSAVE("^TMP($J,""OUT"",""REMOTE"",")="",ZTSAVE("SV")=""
"RTN","PSODDPR3",28,0)
 .D ^%ZTLOAD,^%ZISC W !,"Monograph Queued to Print!",!
"RTN","PSODDPR3",29,0)
 .S:$D(ZTQUEUED) ZTREQ="Q"
"RTN","PSODDPR3",30,0)
 D QUE,^%ZISC
"RTN","PSODDPR3",31,0)
 I $E(IOST)="C",'$G(PSOMONQ) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR W @IOF S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT,DIRUT
"RTN","PSODDPR3",32,0)
 K DIR,DTOUT,DUOUT,^UTILITY($J),DIWL,DIWR,DIWF,X,QX,PMON,RDI,^TMP($J,LIST,"PMON"),RMRX,PSOMON1,PSOMONQ,MONQ,FDBSEV,MONTITLE,SMONTI
"RTN","PSODDPR3",33,0)
 Q
"RTN","PSODDPR3",34,0)
 ;
"RTN","PSODDPR3",35,0)
QUE   S (CT,PMON,MDRGCNT)=0 K ^TMP($J,LIST,"PMON")
"RTN","PSODDPR3",36,0)
 U IO
"RTN","PSODDPR3",37,0)
 ;sort to attain an array of FDBSEV by drug and monograph title.  Note that the PMON array is already sorted by Vista Severity
"RTN","PSODDPR3",38,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT)) Q:'CT  D
"RTN","PSODDPR3",39,0)
 . I $D(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",5,0)) S MONSEV="",MONSEV=^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",5,0) D
"RTN","PSODDPR3",40,0)
 ..S FDBSEV=$P($P(MONSEV,"SEVERITY LEVEL:  ",2),"-",1),FDBSEV=$TR(FDBSEV," ","") S:'$G(FDBSEV) FDBSEV=999999999
"RTN","PSODDPR3",41,0)
 ..S MONTITLE="",MONTITLE=$G(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",3,0)),MONTITLE=$P(MONTITLE,"MONOGRAPH TITLE:  ",2)
"RTN","PSODDPR3",42,0)
 ..S:MONTITLE="" MONTITLE="Zz No title given"
"RTN","PSODDPR3",43,0)
 ..S PSOMON1(DRG,MONTITLE,FDBSEV)=""
"RTN","PSODDPR3",44,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR3",45,0)
 ;sort "PMON" nodes by drug and FDB severity then print monograph; MDRGCNT = monograph drug count - sequential number counting monographs per drug.  If multiple monographs fro same drug allows display of each.
"RTN","PSODDPR3",46,0)
 ;; PMON  = counter of # of lines in the monograph to be displayed; FDBSEV = FDB severity for each monograph within the Vista severity
"RTN","PSODDPR3",47,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT)) Q:'CT!$G(PSODLQT)  D  S PMON=PMON+1,^TMP($J,LIST,"PMON",PMON,0)=""
"RTN","PSODDPR3",48,0)
 .S DRGINFO=^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT),PDRGIEN=$P(DRGINFO,"^",2),DRGIEN=$P(DRGINFO,"^",3)
"RTN","PSODDPR3",49,0)
 .S PVAGDRG=$$GET1^DIQ(50,PDRGIEN,20,"E"),VAGDRG=$$GET1^DIQ(50,DRGIEN,20,"E"),MDRGCNT=MDRGCNT+1
"RTN","PSODDPR3",50,0)
 .I PVAGDRG="" S PVAGDRG=$P(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT),"^",4)
"RTN","PSODDPR3",51,0)
 .I VAGDRG="" S VAGDRG=DRG
"RTN","PSODDPR3",52,0)
 .S SMONTI=$G(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",3,0)),SMONTI=$P(SMONTI,"MONOGRAPH TITLE:  ",2)
"RTN","PSODDPR3",53,0)
 .I $D(PSOMON1(DRG,SMONTI)) S FDBSEV="",FDBSEV=$O(PSOMON1(DRG,SMONTI,FDBSEV))
"RTN","PSODDPR3",54,0)
 .S PMON=PMON+1,^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0)=PSONULN
"RTN","PSODDPR3",55,0)
 .S PMON=PMON+1,^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0)="Professional Monograph",PMON=PMON+1
"RTN","PSODDPR3",56,0)
 .S ^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0)="Drug Interaction with "_PVAGDRG_" and "_VAGDRG,PMON=PMON+1,^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0)=""
"RTN","PSODDPR3",57,0)
 .F QX=0:0 S QX=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",QX)) Q:'QX  D FPMON
"RTN","PSODDPR3",58,0)
 Q:'$O(^TMP($J,LIST,"PMON",0))!$G(PSODLQT)
"RTN","PSODDPR3",59,0)
 K DIR,DTOUT,DUOUT,MONQ U IO W @IOF
"RTN","PSODDPR3",60,0)
 I $P(ON,";")="R" S RMRX=$P(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)),"^",5)
"RTN","PSODDPR3",61,0)
 ;display monograph detailed information
"RTN","PSODDPR3",62,0)
 F FDBSEV=0:0 S FDBSEV=$O(^TMP($J,LIST,"PMON",FDBSEV)) Q:FDBSEV=""!($G(MONQ))  F QXX=0:0 S QXX=$O(^TMP($J,LIST,"PMON",FDBSEV,QXX)) Q:QXX=""!($G(MONQ))  S PSOMONQ=0 D
"RTN","PSODDPR3",63,0)
 .F QX=0:0 S QX=$O(^TMP($J,LIST,"PMON",FDBSEV,QXX,QX)) Q:'QX!($G(PSOMONQ)=1)!($G(MONQ))  W !,^TMP($J,LIST,"PMON",FDBSEV,QXX,QX,0) I $Y+3>IOSL D
"RTN","PSODDPR3",64,0)
 ..I $E(IOST)="C",($Y+3)>IOSL S PSOMONQ=$$PAUSE1()
"RTN","PSODDPR3",65,0)
 ..I PSOMONQ=1 W @IOF Q
"RTN","PSODDPR3",66,0)
 ..I PSOMONQ=2 S MONQ=1
"RTN","PSODDPR3",67,0)
 ..W @IOF,!
"RTN","PSODDPR3",68,0)
 Q
"RTN","PSODDPR3",69,0)
 ;
"RTN","PSODDPR3",70,0)
PAUSE1() ;Allow "^"
"RTN","PSODDPR3",71,0)
 ;Return 0 if X="" ;Return 1 if X="^" ;Return 2 if Not null or "^"
"RTN","PSODDPR3",72,0)
 NEW DIR,DIRUT,DUOUT,X
"RTN","PSODDPR3",73,0)
 W ! K DIR S DIR("A")="Press RETURN to continue, ""^"" to display the next Monograph or ""^^"" to Exit"
"RTN","PSODDPR3",74,0)
 S DIR("?")="Enter ""^"" to go to next Monograph, ""^^"" to exit the Monograph display."
"RTN","PSODDPR3",75,0)
 S DIR(0)="FOU^^K:(X'="""")!(X'[""^"") X"
"RTN","PSODDPR3",76,0)
 D ^DIR
"RTN","PSODDPR3",77,0)
 I X="" Q 0
"RTN","PSODDPR3",78,0)
 I X="^" Q 1
"RTN","PSODDPR3",79,0)
 Q 2
"RTN","PSODDPR3",80,0)
RDI ;RDI orders
"RTN","PSODDPR3",81,0)
 Q:'$D(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)))
"RTN","PSODDPR3",82,0)
 S RXREC=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2))
"RTN","PSODDPR3",83,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("LOCATION: ",20)_$P(RXREC,"^")_"  Remote Rx: "_$P(RXREC,"^",5)
"RTN","PSODDPR3",84,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Drug: ",20)_$P(RXREC,"^",3)_" ("_$P(RXREC,"^",4)_")"
"RTN","PSODDPR3",85,0)
 D FSIG(.FSIG)
"RTN","PSODDPR3",86,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("SIG: ",20) F I=1:1 Q:'$D(FSIG(I))  W:'$G(PSODUPF) ?20,FSIG(I) I $O(FSIG(I)) W:'$G(PSODUPF) !
"RTN","PSODDPR3",87,0)
 I $G(QTHER) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("QTY: ",20)_$P(RXREC,"^",8),?40,$J("Days Supply: ",24)_$P(RXREC,"^",7)
"RTN","PSODDPR3",88,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Last Filled On: ",20)_$P(RXREC,"^",6)
"RTN","PSODDPR3",89,0)
 S ^TMP($J,"PSONRVADD",RXREC,0)=1
"RTN","PSODDPR3",90,0)
 K RXREC,I,FSIG
"RTN","PSODDPR3",91,0)
 Q
"RTN","PSODDPR3",92,0)
FSIG(FSIG) ;Format sig from remote site ;returned in the FSIG array
"RTN","PSODDPR3",93,0)
 K FSIG N FFF,NNN,CNT,FVAR,FVAR1,FLIM,HSIG,II,I
"RTN","PSODDPR3",94,0)
 F I=0:1 Q:'$D(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2),"SIG",I))  S HSIG(I+1)=^(I)
"RTN","PSODDPR3",95,0)
FSTART S (FVAR,FVAR1)="",II=1
"RTN","PSODDPR3",96,0)
 F FFF=0:0 S FFF=$O(HSIG(FFF)) Q:'FFF  S CNT=0 F NNN=1:1:$L(HSIG(FFF)) I $E(HSIG(FFF),NNN)=" "!($L(HSIG(FFF))=NNN) S CNT=CNT+1 D  I $L(FVAR)>50 S FSIG(II)=FLIM_" ",II=II+1,FVAR=FVAR1
"RTN","PSODDPR3",97,0)
 .S FVAR1=$P(HSIG(FFF)," ",(CNT))
"RTN","PSODDPR3",98,0)
 .S FLIM=FVAR
"RTN","PSODDPR3",99,0)
 .S FVAR=$S(FVAR="":FVAR1,1:FVAR_" "_FVAR1)
"RTN","PSODDPR3",100,0)
 I $G(FVAR)'="" S FSIG(II)=FVAR
"RTN","PSODDPR3",101,0)
 I $G(FSIG(1))=""!($G(FSIG(1))=" ") S FSIG(1)=$G(FSIG(2)) K FSIG(2)
"RTN","PSODDPR3",102,0)
FQUIT ;
"RTN","PSODDPR3",103,0)
 Q
"RTN","PSODDPR3",104,0)
DCOR ;dc duplicate therapy
"RTN","PSODDPR3",105,0)
 Q:'$D(^XUSEC("PSORPH",DUZ))!$G(PSODLQT)
"RTN","PSODDPR3",106,0)
 S MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Therapy"
"RTN","PSODDPR3",107,0)
 S ACT="Duplicate Therapy Discontinued while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX"
"RTN","PSODDPR3",108,0)
 N DCN,DCRD,LST S THERO=0 F I=0:0 S I=$O(^TMP($J,"PSODCOR",I)) Q:'I  S THERO=THERO+1
"RTN","PSODDPR3",109,0)
 I THERO=1 D  Q
"RTN","PSODDPR3",110,0)
 .K DIR S DIR(0)="Y",THER(1)=^TMP($J,"PSODCOR",1)
"RTN","PSODDPR3",111,0)
 .S DIR("A")="Discontinue "_$S($P(THER(1),"^")="P":"Pending Order "_$P(THER(1),"^",4),1:"Rx #"_$P(^PSRX($P(THER(1),"^",2),0),"^")_" "_$P(THER(1),"^",4))_" Y/N "
"RTN","PSODDPR3",112,0)
 .D ^DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)  K DIR,DIRUT I 'Y K DIR,THER,THERO,X,Y Q
"RTN","PSODDPR3",113,0)
 .S ^TMP("PSORXDC",$J,$P(THER(1),"^",2),0)=$P(THER(1),"^")_"^"_$P(THER(1),"^",2)_"^"_MSG
"RTN","PSODDPR3",114,0)
 .I $P(THER(1),"^")=52 S ^TMP("PSORXDC",$J,$P(THER(1),"^",2),0)=^TMP("PSORXDC",$J,$P(THER(1),"^",2),0)_"^C^"_ACT_"^"_$P(THER(1),"^",3)_"^"_$P(THER(1),"^",4),PSONOOR="D"
"RTN","PSODDPR3",115,0)
 .S $P(^TMP("PSORXDC",$J,$P(THER(1),"^",2),0),"^",10)=1
"RTN","PSODDPR3",116,0)
 .W !! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPR3",117,0)
 .S X="Duplicate Therapy "_$S($P(THER(1),"^")="P":"Pending Order ",1:"Rx #"_$P(^PSRX($P(THER(1),"^",2),0),"^"))_" "_$P(THER(1),"^",4)_" will be discontinued after the acceptance of the new order." D ^DIWP
"RTN","PSODDPR3",118,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSODDPR3",119,0)
 .K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF W ! H 2
"RTN","PSODDPR3",120,0)
 K DIR S DIR(0)="Y",DIR("A")="Discontinue Orders Y/N ",DIR("B")="No" D ^DIR
"RTN","PSODDPR3",121,0)
 S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR3",122,0)
 I 'Y K DIR,X,Y Q
"RTN","PSODDPR3",123,0)
 K DIR S DIR(0)="LO^1:"_THERO
"RTN","PSODDPR3",124,0)
 F I=1:1:THERO S DIR("A",I)=I_". "_$S($P(^TMP($J,"PSODCOR",I),"^")="P":"Pending Order "_$P(^TMP($J,"PSODCOR",I),"^",4),1:"Rx #"_$P(^PSRX($P(^TMP($J,"PSODCOR",I),"^",2),0),"^")_" "_$P(^TMP($J,"PSODCOR",I),"^",4))
"RTN","PSODDPR3",125,0)
 S DIR("A")="Select Order(s)" D ^DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)  K DIR,DIRUT I 'Y K THER,THERO Q
"RTN","PSODDPR3",126,0)
 S LST=Y(0) F DCRD=1:1:$L(LST,",") Q:$P(LST,",",DCRD)']""!$G(PSODLQT)  D
"RTN","PSODDPR3",127,0)
 .S DCN=$P(LST,",",DCRD),THER(DCN)=^TMP($J,"PSODCOR",DCN)
"RTN","PSODDPR3",128,0)
 .S ^TMP("PSORXDC",$J,$P(THER(DCN),"^",2),0)=$P(THER(DCN),"^")_"^"_$P(THER(DCN),"^",2)_"^"_MSG
"RTN","PSODDPR3",129,0)
 .I $P(THER(DCN),"^")=52 S ^TMP("PSORXDC",$J,$P(THER(DCN),"^",2),0)=^TMP("PSORXDC",$J,$P(THER(DCN),"^",2),0)_"^C^"_ACT_"^"_$P(THER(DCN),"^",3)_"^"_$P(THER(DCN),"^",4),PSONOOR="D"
"RTN","PSODDPR3",130,0)
 .S $P(^TMP("PSORXDC",$J,$P(THER(DCN),"^",2),0),"^",10)=1
"RTN","PSODDPR3",131,0)
 .W ! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPR3",132,0)
 .S X="Duplicate Therapy "_$S($P(THER(DCN),"^")="P":"Pending Order "_$P(THER(DCN),"^",4),1:"Rx #"_$P(^PSRX($P(THER(DCN),"^",2),0),"^")_" "_$P(THER(DCN),"^",4))_" will be discontinued after the acceptance of the new order." D ^DIWP
"RTN","PSODDPR3",133,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSODDPR3",134,0)
 .K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF H 2
"RTN","PSODDPR3",135,0)
 W ! K X,Y,THER,THERO,MSG,ACT,I,DIR
"RTN","PSODDPR3",136,0)
 Q
"RTN","PSODDPR3",137,0)
FPMON ;displays instruction and/or comments
"RTN","PSODDPR3",138,0)
 S PMON=PMON+1,MG=^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",QX,0)
"RTN","PSODDPR3",139,0)
 I MG="" S ^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0)="",PMON=PMON+1 Q
"RTN","PSODDPR3",140,0)
 I $L(MG)>70 F SG=1:1:$L(MG," ") S:$L(($G(^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0)))_" "_$P(MG," ",SG))>80 PMON=PMON+1 S ^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0)=$G(^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0))_$P(MG," ",SG)_" "
"RTN","PSODDPR3",141,0)
 E  S PMON=PMON+1,^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0)=$G(^TMP($J,LIST,"PMON",FDBSEV,MDRGCNT,PMON,0))_MG
"RTN","PSODDPR3",142,0)
 K MG,SG
"RTN","PSODDPR3",143,0)
 Q
"RTN","PSODDPR3",144,0)
VAGEN(PSODD) ;Return the VA GENERIC name
"RTN","PSODDPR3",145,0)
 ;PSODD - IEN (file #50)
"RTN","PSODDPR3",146,0)
 N PSOIEN I '+$G(PSODD) Q ""
"RTN","PSODDPR3",147,0)
 S PSOIEN=+$G(^PSDRUG(PSODD,"ND")) D ZERO^PSN50P6(PSOIEN,,,,"PSOVAG")
"RTN","PSODDPR3",148,0)
 S PSOVAG=$G(^TMP($J,"PSOVAG",PSOIEN,.01)) K ^TMP($J,"PSOVAG")
"RTN","PSODDPR3",149,0)
 Q PSOVAG
"RTN","PSODDPR3",150,0)
INST ;displays instruction and/or comments
"RTN","PSODDPR3",151,0)
 S INST=0 F  S INST=$O(^PS(52.41,RXREC,TY,INST)) Q:'INST  S MIG=^PS(52.41,RXREC,TY,INST,0) D
"RTN","PSODDPR3",152,0)
 .W !,$S(TY=2:"      Instructions: ",TY=3:" Provider Comments: ",1:"")
"RTN","PSODDPR3",153,0)
 .F SG=1:1:$L(MIG," ") D HD^PSODDPR2() Q:$G(PSODLQT)  W:$X+$L($P(MIG," ",SG)_" ")>IOM @$S(TY=3:"!?14",1:"!?19") W $P(MIG," ",SG)_" "
"RTN","PSODDPR3",154,0)
 K INST,TY,MIG,SG
"RTN","PSODDPR3",155,0)
 Q
"RTN","PSODDPR3",156,0)
CLASSES ;display therapeutic duplications classes (called from PSODDPR5 too)
"RTN","PSODDPR3",157,0)
 I '$G(PSODUPF) D
"RTN","PSODDPR3",158,0)
 .I '$G(PSODUPCT)&('$G(PSODUPC("CLASS"))) D HD^PSODDPR2() Q
"RTN","PSODDPR3",159,0)
 .I ($G(PSODUPCT)+PSODUPC("CLASS"))>22 D HD^PSODDPR2(15) S PSODUPCT=0
"RTN","PSODDPR3",160,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR3",161,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF="",ZCT=0 S:$G(PSODUPF) PSODUPC("CLASS")=PSODUPC("CLASS")+1 W:'$G(PSODUPF) !
"RTN","PSODDPR3",162,0)
 S X="Class(es) Involved in Therapeutic Duplication(s): " D ^DIWP
"RTN","PSODDPR3",163,0)
 S (ZCT,ZZCT,ZZZCT)=0 F  S ZZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT)) Q:'ZZCT  S ZCT=0 F  S ZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT)) Q:'ZCT  D
"RTN","PSODDPR3",164,0)
 . S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")
"RTN","PSODDPR3",165,0)
 . S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")_$S($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT))!($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT))):", ",1:" ")
"RTN","PSODDPR3",166,0)
 . D ^DIWP
"RTN","PSODDPR3",167,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S:$G(PSODUPF) PSODUPC("CLASS")=PSODUPC("CLASS")+1 W:'$G(PSODUPF) !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSODDPR3",168,0)
 K ^UTILITY($J,"W"),X,CLASS,DIWL,DIWR,DIWF,ZX,DRG,ZCT,ZZCT,ZZZCT
"RTN","PSODDPR3",169,0)
 S:$G(PSODUPF) PSODUPC("CLASS")=PSODUPC("CLASS")+1 W:'$G(PSODUPF) !,PSONULN1,!
"RTN","PSODDPR3",170,0)
 Q
"RTN","PSODDPR4")
0^14^B117470989
"RTN","PSODDPR4",1,0)
PSODDPR4 ;BHAM - ISC/EJW,SAB - build local OP  & RDI profiles ;07/19/07
"RTN","PSODDPR4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,387,379,372**;DEC 1997;Build 54
"RTN","PSODDPR4",3,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODDPR4",4,0)
 ;External references to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSODDPR4",5,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR4",6,0)
 ;External reference to IN^PSJBLDOC supported by DBIA 5306
"RTN","PSODDPR4",7,0)
 ;External references to ^PSSDSAPM supported by DBIA 5570
"RTN","PSODDPR4",8,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR4",9,0)
 ;External reference to ENCHK^PSJORUT2 supported by DBIA 2376
"RTN","PSODDPR4",10,0)
 ;External reference to IN^PSSHRQ2 supported by DBIA 5369
"RTN","PSODDPR4",11,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR4",12,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR4",13,0)
 ;
"RTN","PSODDPR4",14,0)
BLD(PSODFN,LIST,PDRG,PTY) ;
"RTN","PSODDPR4",15,0)
 ;build OP, RDI, INP MEDS profiles
"RTN","PSODDPR4",16,0)
 ;PTY - P1;P2 where P1="I" for IP & "O" for OP (required), P2=Pharm order# (optional)
"RTN","PSODDPR4",17,0)
 I '$D(PSODFN) W !,"Patient UNDEFINED!",! Q
"RTN","PSODDPR4",18,0)
 I '$D(LIST) W !,"Input Base UNDEFINED!",! Q
"RTN","PSODDPR4",19,0)
 K ^TMP($J,LIST)
"RTN","PSODDPR4",20,0)
ORD N PSODTCUT,X1,X2,ODRG,ORTYP,ORN,DO,IEN,NAME,PROF,PSOON,PSODPSPR S (PROF,CNT)=0
"RTN","PSODDPR4",21,0)
 F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  S IEN=$P(PDRG(ZI),"^"),NAME=$P(PDRG(ZI),"^",2) D DRG
"RTN","PSODDPR4",22,0)
 I $O(^TMP($J,LIST,"IN","PROSPECTIVE",""))="" D:$O(PSODUPSP(0)) DRGSUP Q   ;no prospective drugs to pass in
"RTN","PSODDPR4",23,0)
 S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X D ^PSOBUILD,PROFILE
"RTN","PSODDPR4",24,0)
 K PSOSD D REMOTE D:$P($G(PTY),";")="I" IN^PSJBLDOC(PSODFN,LIST,.PDRG,$G(PTY))
"RTN","PSODDPR4",25,0)
 S ^TMP($J,LIST,"IN","IEN")=PSODFN,^TMP($J,LIST,"IN","DRUGDRUG")="",^TMP($J,LIST,"IN","THERAPY")=""
"RTN","PSODDPR4",26,0)
 S ^TMP($J,LIST,"IN","SOURCE")=$P($G(PTY),";")
"RTN","PSODDPR4",27,0)
 N PSOICT,PSODRUG,PSOY,CNT,ZI
"RTN","PSODDPR4",28,0)
 D IN^PSSHRQ2(LIST) D:$O(PSODUPSP(0)) DRGSUP
"RTN","PSODDPR4",29,0)
 Q
"RTN","PSODDPR4",30,0)
PROFILE ;build profile drug input
"RTN","PSODDPR4",31,0)
 N ID,ORTYP,DD,PSOI,ORN,RECTYP S (STA,DNM)="",DO=0
"RTN","PSODDPR4",32,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  D
"RTN","PSODDPR4",33,0)
 .I STA="PENDING" D  Q
"RTN","PSODDPR4",34,0)
 ..Q:$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",3)="RF"
"RTN","PSODDPR4",35,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ORN=$P(^PS(52.41,RXREC,0),"^"),ODRG=$P(^(0),"^",9),ORTYP="P"
"RTN","PSODDPR4",36,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPR4",37,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",38,0)
 ...S DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",39,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(52.41,RXREC,0),"^",8) D
"RTN","PSODDPR4",40,0)
 ...S DRNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR4",41,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"O") I '$P(DDRG,";") D OIX Q
"RTN","PSODDPR4",42,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",43,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPR4",44,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",45,0)
 ...D ID1
"RTN","PSODDPR4",46,0)
 .I STA="ZNONVA" D  Q
"RTN","PSODDPR4",47,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ODRG=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^",2),ORN=$P($G(^(0)),"^",8),ORTYP="N"
"RTN","PSODDPR4",48,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPR4",49,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",50,0)
 ...S DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",51,0)
  ..E  N PSOI,DDRG,ODRG,SEQN,DDRG,DRNM S PSOI=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^") D
"RTN","PSODDPR4",52,0)
 ...S DRNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR4",53,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"X") I '$P(DDRG,";") D:'$$NVATST^PSODDPRE(PSOI) OIX Q
"RTN","PSODDPR4",54,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",55,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3),DO=DO+1 K PSOI
"RTN","PSODDPR4",56,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",57,0)
 ...D ID1
"RTN","PSODDPR4",58,0)
 .S RXREC=+PSOSD(STA,DNM)
"RTN","PSODDPR4",59,0)
 .I $P($G(PTY),";")="O",$P($G(PTY),";",2)=RXREC Q
"RTN","PSODDPR4",60,0)
 .I $P($G(^PSRX(RXREC,0)),"^",6) S ODRG=$P(^PSRX(RXREC,0),"^",6) D
"RTN","PSODDPR4",61,0)
 ..I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",62,0)
 ..I STA="DISCONTINUED" Q:$$DUPTHER^PSODDPRE(RXREC)  ;screen out duplicate therapy for local orders
"RTN","PSODDPR4",63,0)
 ..S ORN=$P($G(^PSRX(RXREC,"OR1")),"^",2),ORTYP="O",DRNM=$P(^PSDRUG(ODRG,0),"^"),DO=DO+1 D ID
"RTN","PSODDPR4",64,0)
 K RXREC,ID,STA,DNM,SEQN,PSOI,PSODD,P1,P3,OR1,P2,PSODRUG,DD,DRNM,DDRG
"RTN","PSODDPR4",65,0)
 Q
"RTN","PSODDPR4",66,0)
ID N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPR4",67,0)
 S P1=$P($G(^PSDRUG(ODRG,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=+$P(X,"^",7)
"RTN","PSODDPR4",68,0)
ID1 S ^TMP($J,LIST,"IN","PROFILE",ORTYP_";"_RXREC_";PROFILE;"_DO)=SEQN_"^"_ID_"^"_ODRG_"^"_DRNM_"^"_ORN_"^O" K ID
"RTN","PSODDPR4",69,0)
 Q
"RTN","PSODDPR4",70,0)
OIX S ^TMP($J,LIST,"IN","EXCEPTIONS","OI",DRNM)=1_"^"_ORTYP_";"_RXREC_";PROFILE;"_DO
"RTN","PSODDPR4",71,0)
 K TU
"RTN","PSODDPR4",72,0)
 Q
"RTN","PSODDPR4",73,0)
REMOTE ;
"RTN","PSODDPR4",74,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODDPR4",75,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODDPR4",76,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSODDPR4",77,0)
 .I $T(REMOTE^PSORX1)]"" Q
"RTN","PSODDPR4",78,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODDPR4",79,0)
 .W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODDPR4",80,0)
 I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed." D HD^PSODDPR2():(($Y+5)'>IOSL) Q
"RTN","PSODDPR4",81,0)
 N PSORDI,RDIINST,RDIVUID,RDIRX,RDIDNAM,RDISTA,RDISIG,RDIDAYS,RDIQTY,RDIFILL,RDIEXP,RDIISS,RDIFILL,ZI
"RTN","PSODDPR4",82,0)
 N RDIREF,RDIPHYS,PSOPROD,PSOCLASS,DRNM,RDITMP,PSODC,IT,PSOICT,NDF,RDIDI,PSOPRODA,PSOFILE,PSOSIG,PSOSEQN,X
"RTN","PSODDPR4",83,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSODDPR4",84,0)
 S PSORDI=0
"RTN","PSODDPR4",85,0)
 I $T(GET^ORRDI1)]"" S PSORDI=$$GET^ORRDI1(PSODFN,"PSOO")
"RTN","PSODDPR4",86,0)
 I PSORDI<1 Q
"RTN","PSODDPR4",87,0)
 I '$D(^XTMP("ORRDI","PSOO",PSODFN)) Q
"RTN","PSODDPR4",88,0)
 K ^TMP($J,LIST,"OUT","REMOTE")
"RTN","PSODDPR4",89,0)
 D PARSE,FILTER
"RTN","PSODDPR4",90,0)
 I '$D(^TMP($J,LIST,"OUT","REMOTE")) Q
"RTN","PSODDPR4",91,0)
 N DIC D REMO
"RTN","PSODDPR4",92,0)
 Q
"RTN","PSODDPR4",93,0)
REMO ;
"RTN","PSODDPR4",94,0)
  S (PSOON,PSORDI)=0 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI  S RDITMP=^(PSORDI) D  K PSOSEQN
"RTN","PSODDPR4",95,0)
 .Q:$P(RDITMP,"^",2)=""
"RTN","PSODDPR4",96,0)
 .;screen out dc'd remotes
"RTN","PSODDPR4",97,0)
 .I $P($G(^TMP($J,LIST,"OUT","REMOTE",PSORDI)),"^",4)["DISC" D  I $G(PSOON) K PSOON Q
"RTN","PSODDPR4",98,0)
 ..K X,Y,X1,X2
"RTN","PSODDPR4",99,0)
 ..S X=$P(^TMP($J,LIST,"OUT","REMOTE",PSORDI),"^",6) D ^%DT S X1=Y,X2=(+$P(^TMP($J,LIST,"OUT","REMOTE",PSORDI),"^",7)+7)
"RTN","PSODDPR4",100,0)
 ..D C^%DTC I X<DT S PSOON=1 K X,Y,X1,X2
"RTN","PSODDPR4",101,0)
 .;
"RTN","PSODDPR4",102,0)
 .S RDIVUID=$P(RDITMP,"^",2),RDIDNAM=$P(RDITMP,"^",3)
"RTN","PSODDPR4",103,0)
 .I $O(PDRG(0)) F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  I $P(^PSDRUG($P(PDRG(ZI),"^"),0),"^")=RDIDNAM S INDD=+$G(INDD)+1,^TMP($J,"DD",INDD,0)=$P(PDRG(ZI),"^")_"^"_RDIDNAM_"^^"_PSORDI_"Z;O"
"RTN","PSODDPR4",104,0)
 .S DO=$G(DO)+1 D GETIREF^XTID(50.68,.01,RDIVUID,"PSOSEQN",1) I 'PSOSEQN S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=0_"^"_RDIVUID_"^0^"_RDIDNAM_"^^" Q
"RTN","PSODDPR4",105,0)
 .S SEQN="" S SEQN=$O(PSOSEQN(50.68,.01,SEQN)) Q:SEQN=""
"RTN","PSODDPR4",106,0)
 .S P3=+SEQN,SEQN=$P($$PROD0^PSNAPIS(,P3),"^",7)
"RTN","PSODDPR4",107,0)
 .S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=SEQN_"^"_RDIVUID_"^0^"_RDIDNAM_"^^"
"RTN","PSODDPR4",108,0)
 Q
"RTN","PSODDPR4",109,0)
 ;
"RTN","PSODDPR4",110,0)
PARSE ; PULL INFORMATION FROM ^XTMP
"RTN","PSODDPR4",111,0)
 N PSORDI,LOCAL,NEWISS,BADEXP,PSOPRE,PSO30,NEWDC,NEWEXP
"RTN","PSODDPR4",112,0)
 S PSORDI=0 F  S PSORDI=$O(^XTMP("ORRDI","PSOO",PSODFN,PSORDI)) Q:'PSORDI  D
"RTN","PSODDPR4",113,0)
 .S RDISTA=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,5,0))
"RTN","PSODDPR4",114,0)
 .I RDISTA="DELETED" Q
"RTN","PSODDPR4",115,0)
 .S RDIINST=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,1,0))
"RTN","PSODDPR4",116,0)
 .S RDIDNAM=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,2,0))
"RTN","PSODDPR4",117,0)
 .S RDIVUID=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,3,0))
"RTN","PSODDPR4",118,0)
 .I RDIVUID="" Q
"RTN","PSODDPR4",119,0)
 .D GETPROD^PSOORRDI
"RTN","PSODDPR4",120,0)
 .Q:$E($G(PSOCLASS),1,2)="XA"
"RTN","PSODDPR4",121,0)
 .S RDIRX=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,4,0))
"RTN","PSODDPR4",122,0)
 .S RDIQTY=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,6,0))
"RTN","PSODDPR4",123,0)
 .S RDIDAYS=$P(RDIQTY,";",2),RDIQTY=$P(RDIQTY,";")
"RTN","PSODDPR4",124,0)
 .I $E(RDIDAYS)="D" S RDIDAYS=$P(RDIDAYS,"D",2)
"RTN","PSODDPR4",125,0)
 .S RDIEXP=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,7,0))
"RTN","PSODDPR4",126,0)
 .S RDIISS=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,8,0))
"RTN","PSODDPR4",127,0)
 .I RDIEXP?."/" S BADEXP=1 D  I BADEXP Q
"RTN","PSODDPR4",128,0)
 ..I RDIISS?."/" Q
"RTN","PSODDPR4",129,0)
 ..S PSOPRE=$E(DT) I $P(RDIISS,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",130,0)
 ..S NEWISS=PSOPRE_$P(RDIISS,"/",3)_$P(RDIISS,"/")_$P(RDIISS,"/",2) I NEWISS>(DT-10000) S RDIEXP=RDIISS,BADEXP=0
"RTN","PSODDPR4",131,0)
 .I RDISTA["EXPIRE" S PSO30=0 D  I PSO30 Q
"RTN","PSODDPR4",132,0)
 ..S PSOPRE=$E(DT) I $P(RDIEXP,"/",3)>($E(DT,2,3)+1) S PSO30=1 Q
"RTN","PSODDPR4",133,0)
 ..S NEWEXP=PSOPRE_$P(RDIEXP,"/",3)_$P(RDIEXP,"/")_$P(RDIEXP,"/",2)
"RTN","PSODDPR4",134,0)
 ..S X1=NEWEXP,X2=30 D C^%DTC I X<DT S PSO30=1
"RTN","PSODDPR4",135,0)
 .I RDIRX'="" S LOCAL=0 D CHKLOCAL I LOCAL Q
"RTN","PSODDPR4",136,0)
 .S RDIFILL=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,9,0))
"RTN","PSODDPR4",137,0)
 .I RDISTA["DISCONT" S PSO30=0 D  I PSO30 Q
"RTN","PSODDPR4",138,0)
 ..S PSOPRE=$E(DT) I $P(RDIFILL,"/",3)>($E(DT,2,3)+1) S PSO30=1 Q
"RTN","PSODDPR4",139,0)
 ..S NEWDC=PSOPRE_$P(RDIFILL,"/",3)_$P(RDIFILL,"/")_$P(RDIFILL,"/",2)
"RTN","PSODDPR4",140,0)
 ..S X1=NEWDC,X2=30+RDIDAYS D C^%DTC I X<DT S PSO30=1
"RTN","PSODDPR4",141,0)
 .I RDISTA["DRUG INTERACTION" S RDISTA="NON-VERIFIED"
"RTN","PSODDPR4",142,0)
 .S RDIREF=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,10,0))
"RTN","PSODDPR4",143,0)
 .S RDIPHYS=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,11,0))
"RTN","PSODDPR4",144,0)
 .S PSOSIG="" F  S PSOSIG=$O(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,14,PSOSIG)) Q:PSOSIG=""  S PSOSIG(PSOSIG)=^(PSOSIG)
"RTN","PSODDPR4",145,0)
 .S ^TMP($J,LIST,"OUT","REMOTE",PSORDI)=RDIINST_"^"_RDIVUID_"^"_RDIDNAM_"^"_RDISTA_"^"_RDIRX_"^"_RDIFILL_"^"_RDIDAYS_"^"_RDIQTY_"^"_RDIREF_"^"_RDIEXP_"^"_RDIPHYS_"^"_RDIISS
"RTN","PSODDPR4",146,0)
 .S PSOSIG="" F  S PSOSIG=$O(PSOSIG(PSOSIG)) Q:PSOSIG=""  S ^TMP($J,LIST,"OUT","REMOTE",PSORDI,"SIG",PSOSIG)=PSOSIG(PSOSIG)
"RTN","PSODDPR4",147,0)
 Q
"RTN","PSODDPR4",148,0)
 ;
"RTN","PSODDPR4",149,0)
CHKLOCAL ; IF SAME RX NUMBER AND ISSUE DATE - LOCAL RX
"RTN","PSODDPR4",150,0)
 N PSOISS
"RTN","PSODDPR4",151,0)
 I $D(^PSRX("B",RDIRX)) D
"RTN","PSODDPR4",152,0)
 .N PSORX
"RTN","PSODDPR4",153,0)
 .S PSORX=$O(^PSRX("B",RDIRX,"")) I 'PSORX Q
"RTN","PSODDPR4",154,0)
 .S PSOISS=$P($G(^PSRX(PSORX,0)),"^",13)
"RTN","PSODDPR4",155,0)
 .S PSOISS=$E(PSOISS,4,5)_"/"_$E(PSOISS,6,7)_"/"_$E(PSOISS,2,3)
"RTN","PSODDPR4",156,0)
 .I PSOISS=RDIISS S LOCAL=1 Q
"RTN","PSODDPR4",157,0)
 Q
"RTN","PSODDPR4",158,0)
 ;
"RTN","PSODDPR4",159,0)
FILTER ; FOR SAME DRUG VUID FOR SAME SITE, KEEP 1 ENTRY - CHECK BY ACTIVE STATUS FIRST THEN BY GREATEST EXPIRATION DATE
"RTN","PSODDPR4",160,0)
 N XX,RDI,OLDEXP,RDIEXP,RDIEXP2,OLDEXP2,PSORDI,RDISTA,OLDSTA,OLDRDI,ZZ
"RTN","PSODDPR4",161,0)
 S PSORDI=0
"RTN","PSODDPR4",162,0)
 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI  D
"RTN","PSODDPR4",163,0)
 .S XX=$G(^TMP($J,LIST,"OUT","REMOTE",PSORDI)),RDIINST=$P(XX,"^"),RDIVUID=$P(XX,"^",2),RDISTA=$P(XX,"^",4),RDIEXP=$P(XX,"^",10) Q:RDIINST=""  Q:RDIVUID=""  I RDIEXP="" Q
"RTN","PSODDPR4",164,0)
 .I $D(RDI(RDIINST,RDIVUID)) S ZZ=RDI(RDIINST,RDIVUID) D  Q
"RTN","PSODDPR4",165,0)
 ..I RDISTA="ACTIVE"!(RDISTA["SUSPEN") D  Q
"RTN","PSODDPR4",166,0)
 ...S OLDSTA=$P(ZZ,"^",2) I OLDSTA["ACTIVE"!(OLDSTA["SUSPEN") D CHKEXP Q
"RTN","PSODDPR4",167,0)
 ...S OLDRDI=$P(ZZ,"^") K ^TMP($J,LIST,"OUT","REMOTE",OLDRDI) D SETRDI
"RTN","PSODDPR4",168,0)
 ..S OLDSTA=$P(ZZ,"^",2) I OLDSTA["ACTIVE"!(OLDSTA["SUSPEN") K ^TMP($J,LIST,"OUT","REMOTE",PSORDI) Q
"RTN","PSODDPR4",169,0)
 ..D CHKEXP ; ALL OTHER STATUSES - KEEP BY GREATER EXPIRATION DATE
"RTN","PSODDPR4",170,0)
 .D SETRDI
"RTN","PSODDPR4",171,0)
 Q
"RTN","PSODDPR4",172,0)
 ;
"RTN","PSODDPR4",173,0)
CHKEXP ; 
"RTN","PSODDPR4",174,0)
 N PSOPRE
"RTN","PSODDPR4",175,0)
 S OLDEXP=$P(ZZ,"^",3) D  I OLDEXP2>RDIEXP2 K ^TMP($J,"OUT","REMOTE",PSORDI) Q
"RTN","PSODDPR4",176,0)
 .S PSOPRE=$E(DT) I $P(RDIEXP,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",177,0)
 .S RDIEXP2=PSOPRE_$P(RDIEXP,"/",3)_$P(RDIEXP,"/")_$P(RDIEXP,"/",2)
"RTN","PSODDPR4",178,0)
 .S PSOPRE=$E(DT) I $P(OLDEXP,"/",3)>($E(DT,2,3)+1) S PSOPRE=PSOPRE-1
"RTN","PSODDPR4",179,0)
 .S OLDEXP2=PSOPRE_$P(OLDEXP,"/",3)_$P(OLDEXP,"/")_$P(OLDEXP,"/",2)
"RTN","PSODDPR4",180,0)
 S OLDRDI=$P(ZZ,"^") K ^TMP($J,LIST,"OUT","REMOTE",OLDRDI) D SETRDI
"RTN","PSODDPR4",181,0)
 Q
"RTN","PSODDPR4",182,0)
 ;
"RTN","PSODDPR4",183,0)
SETRDI ;
"RTN","PSODDPR4",184,0)
 S RDI(RDIINST,RDIVUID)=PSORDI_"^"_RDISTA_"^"_RDIEXP
"RTN","PSODDPR4",185,0)
 Q
"RTN","PSODDPR4",186,0)
CPRS(PSODFN,LIST,PDRG,PTY) ;
"RTN","PSODDPR4",187,0)
 ;PDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSODDPR4",188,0)
 ;PTY - P1;P2 where P1="I" for IP & "O" for OP (required), P2=Pharm order# (optional)
"RTN","PSODDPR4",189,0)
 I '$G(PSODFN) W !,"Patient UNDEFINED!",! Q
"RTN","PSODDPR4",190,0)
 I '$O(PDRG(0)) W !,"Dispense Drug(s) UNDEFINED!",! Q
"RTN","PSODDPR4",191,0)
 I '$D(LIST) W !,"Input Base UNDEFINED!",! Q
"RTN","PSODDPR4",192,0)
 S ^TMP($J,LIST,"IN","PING")="" D IN^PSSHRQ2(LIST) I $P(^TMP($J,LIST,"OUT",0),"^")=-1 Q
"RTN","PSODDPR4",193,0)
 K ^TMP($J,"ORDERS"),^TMP($J,"DD"),^TMP($J,LIST) N ZII,INDX,INDD,PSODUPSP,PSODUPSY,PSODUPLS S (INDX,INDD)=0,PSODUPSY=$G(PTY),PSODUPLS=LIST
"RTN","PSODDPR4",194,0)
 ;build patient's drug profile outpat/inpat/non-va
"RTN","PSODDPR4",195,0)
 D BLD^PSOORDRG,ENCHK^PSJORUT2(PSODFN,.INDX),NVA^PSOORDRG
"RTN","PSODDPR4",196,0)
 ;dup drug check CPRS ONLY
"RTN","PSODDPR4",197,0)
 S PSOICT="",CNT=0 F ZII=0:0 S ZII=$O(PDRG(ZII)) Q:'ZII  D
"RTN","PSODDPR4",198,0)
 .S PSOY=$P(PDRG(ZII),"^")_"^"_$P($G(^PSDRUG($P(PDRG(ZII),"^"),0)),"^"),PSOY(0)=$G(^PSDRUG(PDRG(ZII),0))
"RTN","PSODDPR4",199,0)
 .S IEN=+PSOY,NAME=$P(PSOY,"^",2),DNM=0 K PSOX1,PSOY
"RTN","PSODDPR4",200,0)
 .F  S DNM=$O(^TMP($J,"ORDERS",DNM)) Q:'DNM  I NAME=$P(^TMP($J,"ORDERS",DNM),"^",3) D
"RTN","PSODDPR4",201,0)
 ..S INDD=$G(INDD)+1,^TMP($J,"DD",INDD,0)=IEN_"^"_NAME_"^"_$P(^TMP($J,"ORDERS",DNM),"^",4)_"^"_$P(^(DNM),"^",5),PSODUPSP(IEN)=PSODUPSY,PSODUPSP(IEN,"NAME")=NAME
"RTN","PSODDPR4",202,0)
 K ^TMP($J,"ORDERS")
"RTN","PSODDPR4",203,0)
 D ORD
"RTN","PSODDPR4",204,0)
 Q
"RTN","PSODDPR4",205,0)
DRG ;
"RTN","PSODDPR4",206,0)
 I $P($G(^PSDRUG(IEN,0)),"^",3)["S"!($E($P($G(^PSDRUG(IEN,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPR4",207,0)
 N ID,SEQN S PSODRUG("NDF")=$S($G(^PSDRUG(IEN,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODDPR4",208,0)
 S ID=$$GETVUID^XTID(50.68,,+$P($G(PSODRUG("NDF")),"A",2)_",")
"RTN","PSODDPR4",209,0)
 S P1=$P($G(^PSDRUG(IEN,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=$P(X,"^",7)
"RTN","PSODDPR4",210,0)
 S CNT=$G(CNT)+1,^TMP($J,LIST,"IN","PROSPECTIVE",$P(PTY,";")_";"_$P(PTY,";",2)_";PROSPECTIVE;"_CNT)=SEQN_"^"_+ID_"^"_IEN_"^"_NAME,PSODPSPR(IEN)=""
"RTN","PSODDPR4",211,0)
 K ID,SEQN,P1,P2,X,DNM
"RTN","PSODDPR4",212,0)
 Q
"RTN","PSODDPR4",213,0)
 ;
"RTN","PSODDPR4",214,0)
DRGSUP ;Create "prospective" nodes for duplicate supply entries 
"RTN","PSODDPR4",215,0)
 N PSODPSID,PSODPSQN,PSODPSP1,PSODPSP2,PSODPSP3,PSODPSXX,PSODPSLP,PSODPSNF,PSODPSCT,PSODPSC1,PSODPSNM
"RTN","PSODDPR4",216,0)
 S PSODPSCT=0
"RTN","PSODDPR4",217,0)
 S PSODPSC1="" F  S PSODPSC1=$O(^TMP($J,PSODUPLS,"IN","PROSPECTIVE",PSODPSC1)) Q:PSODPSC1=""  S PSODPSP3=$P(PSODPSC1,";",4) I PSODPSP3>PSODPSCT S PSODPSCT=PSODPSP3
"RTN","PSODDPR4",218,0)
 S PSODPSLP="" F  S PSODPSLP=$O(PSODUPSP(PSODPSLP)) Q:PSODPSLP=""  D:'$D(PSODPSPR(PSODPSLP))
"RTN","PSODDPR4",219,0)
 .S PSODPSNM=$G(PSODUPSP(PSODPSLP,"NAME"))
"RTN","PSODDPR4",220,0)
 .S PSODPSNF=$S($G(^PSDRUG(PSODPSLP,"ND"))]"":+^PSDRUG(PSODPSLP,"ND")_"A"_$P(^PSDRUG(PSODPSLP,"ND"),"^",3),1:0)
"RTN","PSODDPR4",221,0)
 .S PSODPSID=$$GETVUID^XTID(50.68,,+$P($G(PSODPSNF),"A",2)_",")
"RTN","PSODDPR4",222,0)
 .S PSODPSP1=$P($G(^PSDRUG(PSODPSLP,"ND")),"^"),PSODPSP2=$P($G(^PSDRUG(PSODPSLP,"ND")),"^",3),PSODPSXX=$$PROD0^PSNAPIS(PSODPSP1,PSODPSP2),PSODPSQN=$P(PSODPSXX,"^",7)
"RTN","PSODDPR4",223,0)
 .S PSODPSCT=$G(PSODPSCT)+1,^TMP($J,PSODUPLS,"IN","PROSPECTIVE",$P(PSODUPSY,";")_";"_$P(PSODUPSY,";",2)_";PROSPECTIVE;"_PSODPSCT)=PSODPSQN_"^"_+PSODPSID_"^"_PSODPSLP_"^"_$G(PSODPSNM)
"RTN","PSODDPR4",224,0)
 Q
"RTN","PSODDPR5")
0^22^B80336459
"RTN","PSODDPR5",1,0)
PSODDPR5 ;BIR/SAB - displays OP/rdi/pending/nva orders ;09/320/06 11:33am
"RTN","PSODDPR5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,372**;DEC 1997;Build 54
"RTN","PSODDPR5",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR5",4,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR5",5,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR5",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR5",7,0)
 ;External reference to $$DRG^PSSDSAPM supported by DBIA 5570
"RTN","PSODDPR5",8,0)
 ;
"RTN","PSODDPR5",9,0)
EXC ;displays order check exceptions
"RTN","PSODDPR5",10,0)
 N Q,CT,ONT,OT,ON,TD,ERRTY,OP,OPP,ZEXC,ZREA,X,DIWL,DIWR,DIWF,PSOWROTE
"RTN","PSODDPR5",11,0)
 I ($Y+5)'>IOSL D HD^PSODDPR2() Q:$G(PSODLQT)  ;W @IOF
"RTN","PSODDPR5",12,0)
 S (CT,Q)=0,ONT=""
"RTN","PSODDPR5",13,0)
 F  S ONT=$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT)) Q:ONT=""  F  S CT=$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT)) Q:'CT  D
"RTN","PSODDPR5",14,0)
 .S ZEXC=^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),ZREA=$P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",10)
"RTN","PSODDPR5",15,0)
 .S OT=$P(ONT,";"),ON=$P(ONT,";",2),OP=$P(ONT,";",3),OPP=OT_";"_ON_";"_OP
"RTN","PSODDPR5",16,0)
 .I OT="Z",ZREA="Drug not matched to NDF"!($P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",7)["manual check") S PSODRUG("BAD",PSODRUG("IEN"))=1
"RTN","PSODDPR5",17,0)
 .Q:$G(^TMP($J,"PSEXC","OUT",OPP))
"RTN","PSODDPR5",18,0)
 .S Q=Q+1,ERRTY=$S(OT="R":"RDI",OT="N":"Non-VA",OT="P":"Pending",OT="O":"Rx",1:"")
"RTN","PSODDPR5",19,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPR5",20,0)
 .W ! S X=$P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",7) D ^DIWP
"RTN","PSODDPR5",21,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)  S PSOWROTE=1
"RTN","PSODDPR5",22,0)
 .S:OT'="Z" ^TMP($J,"PSEXC","OUT",OPP)=1
"RTN","PSODDPR5",23,0)
 .Q:ZREA=""
"RTN","PSODDPR5",24,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPR5",25,0)
 .S X="   Reason(s): "_ZREA D ^DIWP
"RTN","PSODDPR5",26,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0) S PSOWROTE=1
"RTN","PSODDPR5",27,0)
 .K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF
"RTN","PSODDPR5",28,0)
 .D:$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT)) HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR5",29,0)
 W !! I $G(PSOWROTE) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 W ! K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSODDPR5",30,0)
 Q
"RTN","PSODDPR5",31,0)
NOCAN ;shows duplicate therapeutic when cancel duplicate class parameter is et to 'no'
"RTN","PSODDPR5",32,0)
 K ^UTILITY($J,"W"),DDTH,DOCPL S DIWL=1,DIWR=78,DIWF="",(CT,SUB)=0 K TCT,TCTP,TCTL,TCTI,ZZQ,ZHDR
"RTN","PSODDPR5",33,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D
"RTN","PSODDPR5",34,0)
 .S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^"),PDRG=$P(^(SUB),"^",3),RXREC=$P(ON,";",2)
"RTN","PSODDPR5",35,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR5",36,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR5",37,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR5",38,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR5",39,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",40,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",41,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR5",42,0)
 .I '$G(ZHDR) D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  W !,PSONULN,!,"*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with",! S ZHDR=1
"RTN","PSODDPR5",43,0)
 Q:'$G(ZHDR)  Q:$G(PSODLQT)
"RTN","PSODDPR5",44,0)
 N ST,STA,STAT,ORT K DOCPL
"RTN","PSODDPR5",45,0)
 S (SUB,CT)=0 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D DUPCL K DDTH
"RTN","PSODDPR5",46,0)
 D DUPCP
"RTN","PSODDPR5",47,0)
 Q
"RTN","PSODDPR5",48,0)
DUPCL ;
"RTN","PSODDPR5",49,0)
 S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^"),PDRG=$P(^(SUB),"^",3),RXREC=$P(ON,";",2)
"RTN","PSODDPR5",50,0)
 I $P(ON,";")="Z" Q
"RTN","PSODDPR5",51,0)
 I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR5",52,0)
 I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR5",53,0)
 I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",54,0)
 I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",55,0)
 I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR5",56,0)
 ;Q:$G(DDTH(ON))
"RTN","PSODDPR5",57,0)
 S ORT=$S($P(ON,";")="N":4,$P(ON,";")="P":3,$P(ON,";")="R":2,1:1)
"RTN","PSODDPR5",58,0)
 S DOCPL(ORT,ON)=""
"RTN","PSODDPR5",59,0)
 Q
"RTN","PSODDPR5",60,0)
DUPCP D HD^PSODDPR2():(($Y+5)'>IOSL) S ORT=0,ON=""  F  S ORT=$O(DOCPL(ORT)) Q:'ORT!$G(PSODLQT)  F  S ON=$O(DOCPL(ORT,ON)) Q:ON=""!$G(PSODLQT)  D
"RTN","PSODDPR5",61,0)
 .I $P(ON,";")="O" D
"RTN","PSODDPR5",62,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  S ST=$P(^PSRX($P(ON,";",2),"STA"),"^")+1
"RTN","PSODDPR5",63,0)
 ..S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED BY PROVIDER^DISCONTINUE EDIT^PROVIDER HOLD"
"RTN","PSODDPR5",64,0)
 ..S STAT=$P(STA,"^",ST) W !?2,"Local Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" ("_STAT_") for "_$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR5",65,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR5",66,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",67,0)
 ..S RXREC=$P(ON,";",2),DNM=$P(^PS(52.41,RXREC,0),"^",9)
"RTN","PSODDPR5",68,0)
 ..S DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR5",69,0)
 ..W !?2,"Pending Order for "
"RTN","PSODDPR5",70,0)
 ..I '$P(DUPRX0,"^",9) W $P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR5",71,0)
 ..E  W $P(^PSDRUG($P(DUPRX0,"^",9),0),"^")
"RTN","PSODDPR5",72,0)
 .I $P(ON,";")="R" N RXDAT D
"RTN","PSODDPR5",73,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",74,0)
 ..S RXDAT=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2))
"RTN","PSODDPR5",75,0)
 ..S RDIRX=$P(RXDAT,"^",5) D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  W !?2,"Remote Rx #"_RDIRX_" ("_$P(RXDAT,"^",4)_") for "_$P(RXDAT,"^",3)
"RTN","PSODDPR5",76,0)
 .I $P(ON,";")="N" D
"RTN","PSODDPR5",77,0)
 ..Q:'$D(^PS(55,PSODFN,"NVA",$P(ON,";",2),0))
"RTN","PSODDPR5",78,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0) N NVAQ
"RTN","PSODDPR5",79,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",80,0)
 ..W !?2,"Non-VA Med for "
"RTN","PSODDPR5",81,0)
 ..I '$P(DUPRX0,"^",2) W $P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR5",82,0)
 ..E  W $P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR5",83,0)
 .S DDTH(ON)=1
"RTN","PSODDPR5",84,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",85,0)
 D CLASSES^PSODDPR3
"RTN","PSODDPR5",86,0)
 D HD^PSODDPR2(0,1) Q:$G(PSODLQT)
"RTN","PSODDPR5",87,0)
 ;K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR,X,Y W @IOF
"RTN","PSODDPR5",88,0)
 Q
"RTN","PSODDPR5",89,0)
REMOTE ;backdoor RDI
"RTN","PSODDPR5",90,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR5",91,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI!$G(PSODLQT)  S RDITMP=^(PSORDI) D  K PSOSEQN
"RTN","PSODDPR5",92,0)
 .I $P(RDITMP,"^",2)="" Q
"RTN","PSODDPR5",93,0)
 .S RDIVUID=$P(RDITMP,"^",2),RDIDNAM=$P(RDITMP,"^",3)
"RTN","PSODDPR5",94,0)
 .I $O(PDRG(0)) F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  I $P(^PSDRUG($P(PDRG(ZI),"^"),0),"^")=RDIDNAM S INDD=+$G(INDD)+1,^TMP($J,"DD",INDD,0)=$P(PDRG(ZI),"^")_"^"_RDIDNAM_"^^"_PSORDI_"Z;O"
"RTN","PSODDPR5",95,0)
 .S DO=$G(DO)+1 D GETIREF^XTID(50.68,.01,RDIVUID,"PSOSEQN",1) I 'PSOSEQN S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=0_"^"_RDIVUID_"^0^"_RDIDNAM_"^^" Q
"RTN","PSODDPR5",96,0)
 .S SEQN="" S SEQN=$O(PSOSEQN(50.68,.01,SEQN)) Q:SEQN=""
"RTN","PSODDPR5",97,0)
 .S P3=+SEQN,SEQN=$P($$PROD0^PSNAPIS(,P3),"^",7)
"RTN","PSODDPR5",98,0)
 .S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=SEQN_"^"_RDIVUID_"^0^"_RDIDNAM_"^^"
"RTN","PSODDPR5",99,0)
 Q
"RTN","PSODDPR5",100,0)
NSRT ;sort of drug interactions ; called by psoddpr2
"RTN","PSODDPR5",101,0)
 Q:$G(PSODLQT)  S COUNT=0,PSOVAG=""
"RTN","PSODDPR5",102,0)
 F  S SV=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV)) Q:SV=""!$G(PSODLQT)  D  Q:$G(PSORX("DFLG"))
"RTN","PSODDPR5",103,0)
 .F  S DRG=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG)) Q:DRG=""!$G(PSODLQT)  F  S ON=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON)) Q:ON=""!$G(PSODLQT)  F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT)) Q:'CT!$G(PSODLQT)  D
"RTN","PSODDPR5",104,0)
 ..I $P(ON,";")="O",$P(^PSRX($P(ON,";",2),"STA"),"^")>5,$P(^PSRX($P(ON,";",2),"STA"),"^")'=16 Q
"RTN","PSODDPR5",105,0)
 ..I $P(ON,";")="R" D RVAGEN Q
"RTN","PSODDPR5",106,0)
 ..I $P(ON,";")="P",'$P($G(^PS(52.41,$P(ON,";",2),0)),"^",9) S PSORDIT=$P($G(^PS(52.41,$P(ON,";",2),0)),"^",8) D:$G(PSORDIT) DVAGEN Q
"RTN","PSODDPR5",107,0)
 ..I $P(ON,";")="N",'$P($G(^PS(55,PSODFN,"NVA",$P(ON,";",2),0)),"^",2) S PSORDIT=$P($G(^PS(55,PSODFN,"NVA",$P(ON,";",2),0)),"^") D:$G(PSORDIT) DVAGEN Q
"RTN","PSODDPR5",108,0)
 ..S PSODD=$O(^PSDRUG("B",DRG,0)) D:PSODD'="" VAGEN^PSODDPR3(PSODD)
"RTN","PSODDPR5",109,0)
 ..S:PSOVAG="" PSOVAG=DRG
"RTN","PSODDPR5",110,0)
 ..S ZOT=$S($P(ON,";")="O":1,$P(ON,";")="R":2,$P(ON,";")="P":3,1:4)
"RTN","PSODDPR5",111,0)
 ..S ZDGDG(SV,ZOT,PSOVAG,DRG)=ON_"^"_CT
"RTN","PSODDPR5",112,0)
 ;
"RTN","PSODDPR5",113,0)
 N SV,TYP,PSOVAG,PSONAM K ZZDGDG,NSRT S (SV,TYP,PSOVAG,PSONAM)=""
"RTN","PSODDPR5",114,0)
 F  S SV=$O(ZDGDG(SV)) Q:SV=""  F  S TYP=$O(ZDGDG(SV,TYP)) Q:TYP=""  F  S PSOVAG=$O(ZDGDG(SV,TYP,PSOVAG)) Q:PSOVAG=""  D
"RTN","PSODDPR5",115,0)
 .F  S PSONAM=$O(ZDGDG(SV,TYP,PSOVAG,PSONAM)) Q:PSONAM=""  D
"RTN","PSODDPR5",116,0)
 ..I '$D(NSRT(SV,PSOVAG)) S NSRT(SV,PSOVAG)=TYP
"RTN","PSODDPR5",117,0)
 ..E  S $P(NSRT(SV,PSOVAG),"^",1)=$P(NSRT(SV,PSOVAG),"^",1)_","_TYP
"RTN","PSODDPR5",118,0)
 ;resort of zdgdg
"RTN","PSODDPR5",119,0)
 N SEV,STOP,PSOVAG,TYP,CNT,CHK
"RTN","PSODDPR5",120,0)
 K ZZDGDG S (SEV,STOP,PSOVAG,TYP)="",CNT=0
"RTN","PSODDPR5",121,0)
 F J=1:1:4 F  S SEV=$O(NSRT(SEV)) Q:SEV=""  F I=1:1:4 F  S PSOVAG=$O(NSRT(SEV,PSOVAG)) Q:PSOVAG=""  D
"RTN","PSODDPR5",122,0)
 .F TYP=1:1:$L(NSRT(SEV,PSOVAG),",") Q:$P(NSRT(SEV,PSOVAG),",",TYP)']""  D
"RTN","PSODDPR5",123,0)
 .S TYP="",TYP=","_$P(NSRT(SEV,PSOVAG),"^",1)_","
"RTN","PSODDPR5",124,0)
 .Q:TYP'[(","_J_",")
"RTN","PSODDPR5",125,0)
 .S STOP=0 F CHK=1:1:4 I TYP[(","_CHK_",")&(CHK<J) S STOP=1
"RTN","PSODDPR5",126,0)
 .Q:STOP
"RTN","PSODDPR5",127,0)
 .S CNT=CNT+1 F I=J:1:4 S TYP=I I $D(ZDGDG(SEV,TYP)) D S2(SEV,TYP,PSOVAG,CNT)
"RTN","PSODDPR5",128,0)
 K NSRT,J,F,ZDGDG,COUNT,CNT
"RTN","PSODDPR5",129,0)
 Q
"RTN","PSODDPR5",130,0)
 ;print order sort
"RTN","PSODDPR5",131,0)
S2(SEV,TYP,PSOVAG,CNT) ;
"RTN","PSODDPR5",132,0)
 N PSONAM S (PSONAM)="",COUNT2=0
"RTN","PSODDPR5",133,0)
 F  S PSONAM=$O(ZDGDG(SEV,TYP,PSOVAG,PSONAM)) Q:PSONAM=""  S COUNT2=COUNT2+1 D
"RTN","PSODDPR5",134,0)
 .S:$G(ZZDGDG2(SEV,PSOVAG)) ZZDGDG2(SEV,PSOVAG)=ZZDGDG2(SEV,PSOVAG)+1 S:'$G(ZZDGDG2(SEV,PSOVAG)) ZZDGDG2(SEV,PSOVAG)=1
"RTN","PSODDPR5",135,0)
 .S ZZDGDG(SEV,CNT,TYP,PSOVAG,PSONAM)=ZDGDG(SEV,TYP,PSOVAG,PSONAM)
"RTN","PSODDPR5",136,0)
 Q
"RTN","PSODDPR5",137,0)
 ;
"RTN","PSODDPR5",138,0)
NSRT1 ;sort out dc'd drug therapies for remote rxs
"RTN","PSODDPR5",139,0)
 S (SUB,CT)=0 K PSODCTH N RXN
"RTN","PSODDPR5",140,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D
"RTN","PSODDPR5",141,0)
 .S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^")
"RTN","PSODDPR5",142,0)
 .I $P(ON,";")="R",$P($G(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2))),"^",4)["DISC" D
"RTN","PSODDPR5",143,0)
 ..S RXN=$P(ON,";",2) K X,Y,X1,X2
"RTN","PSODDPR5",144,0)
 ..S X=$P(^TMP($J,LIST,"OUT","REMOTE",RXN),"^",6) D ^%DT S X1=Y,X2=(+$P(^TMP($J,LIST,"OUT","REMOTE",RXN),"^",7)+7)
"RTN","PSODDPR5",145,0)
 ..D C^%DTC I X<DT S PSODCTH(ON)=1  K X,Y,X1,X2
"RTN","PSODDPR5",146,0)
 Q
"RTN","PSODDPR5",147,0)
 ;
"RTN","PSODDPR5",148,0)
RVAGEN ;va generic for remote drugs
"RTN","PSODDPR5",149,0)
 N PSOVIUD,PSONDF,PSOVAG,DIC
"RTN","PSODDPR5",150,0)
 S PSOVUID=$P(^TMP($J,"PSOPEPS","OUT","REMOTE",$P(ON,";",2)),"^",2) Q:'$G(PSOVUID)
"RTN","PSODDPR5",151,0)
 K PSORDIID S PSOVAGEN="" D GETIREF^XTID("50.68",".01",PSOVUID,"PSORDIID")
"RTN","PSODDPR5",152,0)
 S PSONDF=$O(PSORDIID(50.68,.01,"")) K PSORDIID
"RTN","PSODDPR5",153,0)
 I +PSONDF D DATA^PSN50P68(+PSONDF,,"PSONDF") S PSOVAG=$P($G(^TMP($J,"PSONDF",+PSONDF,.05)),U,2),ZDGDG(SV,2,PSOVAG,DRG)=ON_"^"_CT
"RTN","PSODDPR5",154,0)
 K ^TMP($J,"PSONDF")
"RTN","PSODDPR5",155,0)
 Q
"RTN","PSODDPR5",156,0)
 ;
"RTN","PSODDPR5",157,0)
DVAGEN ;va generic for non-va/pending meds
"RTN","PSODDPR5",158,0)
 S PSI=0 N PSID,PSODD,PSOVAG,PSOSRTPK,PSOSRTDG,PSOSRTDF
"RTN","PSODDPR5",159,0)
 S PSOSRTPK=$S($P(ON,";")="N":"X",1:"O"),PSOVAG=""
"RTN","PSODDPR5",160,0)
 S PSOSRTDG=$P($$DRG^PSSDSAPM(PSORDIT,PSOSRTPK),";")
"RTN","PSODDPR5",161,0)
 D:PSOSRTDG VAGEN^PSODDPR3(PSOSRTDG)
"RTN","PSODDPR5",162,0)
 I PSOVAG="",PSOSRTDG S PSOVAG=$P($G(^PSDRUG(PSOSRTDG,0)),"^")
"RTN","PSODDPR5",163,0)
 I PSOVAG="" S PSOSRTDF=$P($G(^PS(50.7,PSORDIT,0)),"^",2) S PSOVAG=$P($G(^PS(50.7,PSORDIT,0)),"^")_"  "_$S($G(PSOSRTDF):$P($G(^PS(50.606,+PSOSRTDF,0)),"^"),1:"")
"RTN","PSODDPR5",164,0)
 Q:$G(PSOVAG)']""
"RTN","PSODDPR5",165,0)
 S ZOT=$S($P(ON,";")="O":1,$P(ON,";")="R":2,$P(ON,";")="P":3,1:4),ZDGDG(SV,ZOT,PSOVAG,DRG)=ON_"^"_CT,COUNT=COUNT+1
"RTN","PSODDPR5",166,0)
 K PSI,PSID,PSORDIT,PSODD,PSOVAG
"RTN","PSODDPR5",167,0)
 Q
"RTN","PSODDPR5",168,0)
  ;
"RTN","PSODDPR5",169,0)
INT ;
"RTN","PSODDPR5",170,0)
  I $G(PSOVORD),$P(PSOINTV,"^")=1 D  Q
"RTN","PSODDPR5",171,0)
 .K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODDPR5",172,0)
 .W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="Y" D ^DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR5",173,0)
 .K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODDPR5",174,0)
 .I 'Y S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR5",175,0)
 .S DA=PSONV,RXREC=DA,RX=$G(^PSRX(RXREC,0)),PSORX("INTERVENE")=1
"RTN","PSODDPR5",176,0)
 .D CRI^PSODGDG1
"RTN","PSODDPR5",177,0)
 .I $G(OLDDA) S DA=OLDDA K OLDDA
"RTN","PSODDPR5",178,0)
 Q:$G(PSODLQT)!($G(PSORX("DFLG")))
"RTN","PSODDPR5",179,0)
 I $P(PSOINTV,"^") S IT=$P(PSOINTV,"^"),ON=$P(PSOINTV,"^",2) D ^PSODGDGP K DIR S IT=$P(PSOINTV,"^")
"RTN","PSODDPR5",180,0)
 Q
"RTN","PSODDPR8")
0^12^B56882045
"RTN","PSODDPR8",1,0)
PSODDPR8 ;BIR/SAB - display enhanced order checks ;11 May 2010  9:06 AM
"RTN","PSODDPR8",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**390,372**;DEC 1997;Build 54
"RTN","PSODDPR8",3,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR8",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR8",5,0)
 ;External reference to ^PS(52.41 supported by DBIA 2844
"RTN","PSODDPR8",6,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODDPR8",7,0)
 ;External reference to ENCHK^PSJORUT2 supported by DBIA 2376
"RTN","PSODDPR8",8,0)
 ;
"RTN","PSODDPR8",9,0)
DUP ;display drug interaction, clinical effects, and call to display monograph
"RTN","PSODDPR8",10,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR8",11,0)
 S ZZDGDGC=ZZDGDGC+1,ON=$P(ZZDGDG(SV,ZST,ZORS,ZVA,DRG),"^"),CT=$P(ZZDGDG(SV,ZST,ZORS,ZVA,DRG),"^",2),SEV=$G(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"SEV")) K ISTX
"RTN","PSODDPR8",12,0)
 S IT=$S(SEV="Critical":1,SEV="Significant":2,1:0),PDRG=$P(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT),"^",4),DRGI=$P(^(CT),"^",2)
"RTN","PSODDPR8",13,0)
 D HD() Q:$G(PSODLQT)
"RTN","PSODDPR8",14,0)
 I $G(ZHDR) W @IOF,PSONULN,!,"***"_SEV_"*** Drug Interaction with Prospective Drug:",!?20,PDRG_" and",! S ZHDR=0
"RTN","PSODDPR8",15,0)
 E  W !
"RTN","PSODDPR8",16,0)
 I $P(ON,";")="N" D ^PSODDPR3 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",17,0)
 I $P(ON,";")="P" D PEND D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",18,0)
 I $P(ON,";")="O" D DDRX D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",19,0)
 I $P(ON,";")="Z" D DDRX1 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",20,0)
 I $P(ON,";")="R" D RDI^PSODDPR3 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",21,0)
 I '+$G(PSOINTV),IT=2 S PSOINTV=2_"^"_ON
"RTN","PSODDPR8",22,0)
 I IT=1 S PSOINTV=1_"^"_ON
"RTN","PSODDPR8",23,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  I COUNT=ZZDGDG2(SV,ZVA) S COUNT=0 W ! D CL D HD():(($Y+5)'>IOSL)
"RTN","PSODDPR8",24,0)
 Q
"RTN","PSODDPR8",25,0)
 ;
"RTN","PSODDPR8",26,0)
PEND N DUPRX0,RFLS,ISSD,DNM,RXREC,Y
"RTN","PSODDPR8",27,0)
 D HD() Q:$G(PSODLQT)  S RXREC=$P(ON,";",2),DNM=$P(^PS(52.41,RXREC,0),"^",9)
"RTN","PSODDPR8",28,0)
 S DUPRX0=^PS(52.41,RXREC,0),RFLS=$P(DUPRX0,"^",11),ISSD=$P(DUPRX0,"^",6)
"RTN","PSODDPR8",29,0)
 I '$P(DUPRX0,"^",9) D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Pending Order: ",20)_$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR8",30,0)
 E  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Pending Drug: ",20)_$S($P(DUPRX0,"^",9):$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"),1:"No Dispense Drug Selected")
"RTN","PSODDPR8",31,0)
 D FSIG^PSOUTLA("P",RXREC,50)
"RTN","PSODDPR8",32,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("SIG: ",20) F I=0:0 S I=$O(FSIG(I)) Q:'I  W:'$G(PSODUPF) FSIG(I) I $O(FSIG(I)) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("      ",20)
"RTN","PSODDPR8",33,0)
 Q
"RTN","PSODDPR8",34,0)
 ;
"RTN","PSODDPR8",35,0)
DDRX ;
"RTN","PSODDPR8",36,0)
 S RXREC=$P(ON,";",2),DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),($P(RX0,"^",15),STATUS)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPR8",37,0)
 S J=RXREC D STAT^PSOFUNC K RX0,RX2,LSTFD S RXRECLOC=$G(RXREC),DRGNM=$P(^PSDRUG($P(DUPRX0,"^",6),0),"^")
"RTN","PSODDPR8",38,0)
 D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Local RX#: ",20)_$P(DUPRX0,"^"),!,$J("Drug: ",20)_DRGNM_" ("_ST_")"
"RTN","PSODDPR8",39,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,50) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODDPR8",40,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,50)
"RTN","PSODDPR8",41,0)
 D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("SIG: ",20),$G(BSIG(1))
"RTN","PSODDPR8",42,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("     ",20)_$G(BSIG(PSREV)) D HD()
"RTN","PSODDPR8",43,0)
 K BSIG,PSREV
"RTN","PSODDPR8",44,0)
 I $G(QTHER) D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("QTY: ",20)_$P(DUPRX0,"^",7),?44,$J("Days Supply: ",20)_$P(DUPRX0,"^",8)
"RTN","PSODDPR8",45,0)
 D PRSTAT^PSODDPRE(RXREC) S LSTFD=+^PSRX(RXREC,3) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Last Filled On: ",20)_$E(LSTFD,4,5)_"/"_$E(LSTFD,6,7)_"/"_$E(LSTFD,2,3)
"RTN","PSODDPR8",46,0)
 Q
"RTN","PSODDPR8",47,0)
 ;
"RTN","PSODDPR8",48,0)
DDRX1 ;
"RTN","PSODDPR8",49,0)
 W:SV="C" !,$J("Drug: ",21)_$S($D(PSSDIUTL):PDRG,1:DRG)
"RTN","PSODDPR8",50,0)
 W:SV="S" !,$J("Drug: ",24)_$S($D(PSSDIUTL):PDRG,1:DRG)
"RTN","PSODDPR8",51,0)
 Q
"RTN","PSODDPR8",52,0)
 ;
"RTN","PSODDPR8",53,0)
CL Q:$G(PSODLQT)  S ZHDR=1 N CLECNT
"RTN","PSODDPR8",54,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",55,0)
 I IT=2 W !?2,"*** Refer to MONOGRAPH for SIGNIFICANT INTERACTION CLINICAL EFFECTS",!
"RTN","PSODDPR8",56,0)
 I IT=1 W ! D
"RTN","PSODDPR8",57,0)
 .S CLECNT=0 F  S CLECNT=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT)) Q:CLECNT=""  I $D(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT,"CLIN")) D
"RTN","PSODDPR8",58,0)
 ..S CLI="",CLI=$P($G(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CLECNT,"CLIN")),"CLINICAL EFFECTS: ",2)
"RTN","PSODDPR8",59,0)
 ..S LT=75,STX=CLI D FT Q:$G(PSODLQT)  F I=0:0 S I=$O(BSIG(I)) Q:'I  W ?2,BSIG(I),! D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR8",60,0)
 ..W !
"RTN","PSODDPR8",61,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  I $O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT,"PMON",0)) D MON^PSODDPR3 K X,Y
"RTN","PSODDPR8",62,0)
 D HD():(($Y+5)>IOSL)
"RTN","PSODDPR8",63,0)
 Q
"RTN","PSODDPR8",64,0)
 Q
"RTN","PSODDPR8",65,0)
 ;
"RTN","PSODDPR8",66,0)
FT ;format text
"RTN","PSODDPR8",67,0)
 D HD():(($Y+5)>IOSL) Q:$G(PSODLQT)  K BSIG N BBSIG,BVAR,BVAR1,III,ZNT,NNN,BLIM S BBSIG=STX S (BVAR,BVAR1)="",III=1
"RTN","PSODDPR8",68,0)
 S ZNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S ZNT=ZNT+1 D  I $L(BVAR)>LT S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSODDPR8",69,0)
 .S BVAR1=$P(BBSIG," ",(ZNT)),BLIM=BVAR,BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1) D HD(6):(($Y+6)>IOSL)
"RTN","PSODDPR8",70,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSODDPR8",71,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSODDPR8",72,0)
 K LT D HD():(($Y+5)>IOSL)
"RTN","PSODDPR8",73,0)
 Q
"RTN","PSODDPR8",74,0)
 ;
"RTN","PSODDPR8",75,0)
HD(PSOLINES,OVRRID) ;
"RTN","PSODDPR8",76,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODDPR8",77,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)'>IOSL) Q
"RTN","PSODDPR8",78,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODDPR8",79,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSODDPR8",80,0)
 K PSOLINES,OVRRID
"RTN","PSODDPR8",81,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR8",82,0)
 W:'$G(PSODUPF) @IOF
"RTN","PSODDPR8",83,0)
 Q
"RTN","PSODDPR8",84,0)
 ;
"RTN","PSODDPR8",85,0)
 ;
"RTN","PSODDPR8",86,0)
CPRS(PSODFN,PSODSULS,PSODSUOI,PSODSUTY,PSODSUAG) ;
"RTN","PSODDPR8",87,0)
 ;Duplicate supply check for CPRS
"RTN","PSODDPR8",88,0)
 ;PSODFN - Patient
"RTN","PSODDPR8",89,0)
 ;PSODSULS - Literal
"RTN","PSODDPR8",90,0)
 ;PSODSUOI - Orderable Item array in format of PSODSUOI(n)=IEN (#50.7) ^ Orderable Name name
"RTN","PSODDPR8",91,0)
 ;PSODSUTY - P1;P2 where P1 is dialogue ("I" for IV, U for Unit Dose, "O" for Outpatient, "N" for Non-VA Meds (required)), P2=Pharm order# (optional)
"RTN","PSODDPR8",92,0)
 ;PSODSUAG - If 1, indicates TMP global from CPRS^PSODDPR4 call still exists, and add to it
"RTN","PSODDPR8",93,0)
 I '$G(PSODFN) Q
"RTN","PSODDPR8",94,0)
 I '$O(PSODSUOI(0)) Q
"RTN","PSODDPR8",95,0)
 I '$D(PSODSULS) Q
"RTN","PSODDPR8",96,0)
 N INDX,PSODSUDL,PSODSUPK,PSODSURG,PSODSUA1,PSODSUA2,PSODSUNM,PSODSUAP,PSODSUIN,PSODSUII,PSODSUNN,PSODSUDM,PSODSUDC,PSODSUST,PSODSUCC,PSODSULP,PSODSUBB,PSODSUB4
"RTN","PSODDPR8",97,0)
 S PSODSUDL=$P($G(PSODSUTY),";") I PSODSUDL'="I",PSODSUDL'="U",PSODSUDL'="O",PSODSUDL'="N" Q
"RTN","PSODDPR8",98,0)
 S PSODSUPK=$S(PSODSUDL="I":1,PSODSUDL="U":1,1:0),PSODSUCC=0
"RTN","PSODDPR8",99,0)
 S PSODSUA1="" F  S PSODSUA1=$O(PSODSUOI(PSODSUA1)) Q:PSODSUA1=""  D
"RTN","PSODDPR8",100,0)
 .S PSODSUA2="" F  S PSODSUA2=$O(^PSDRUG("ASP",PSODSUA1,PSODSUA2)) Q:PSODSUA2=""  D
"RTN","PSODDPR8",101,0)
 ..S PSODSUNM=$P($G(^PSDRUG(PSODSUA2,0)),"^") Q:PSODSUNM=""
"RTN","PSODDPR8",102,0)
 ..S PSODSUAP=$P($G(^PSDRUG(PSODSUA2,2)),"^",3)
"RTN","PSODDPR8",103,0)
 ..I PSODSUPK,PSODSUAP'["I",PSODSUAP'["U" Q
"RTN","PSODDPR8",104,0)
 ..I PSODSUDL="O",PSODSUAP'["O" Q
"RTN","PSODDPR8",105,0)
 ..I PSODSUDL="N",PSODSUAP'["X" Q
"RTN","PSODDPR8",106,0)
 ..I '$$SUP^PSSDSAPI(PSODSUA2) Q
"RTN","PSODDPR8",107,0)
 ..S PSODSUIN=$P($G(^PSDRUG(PSODSUA2,"I")),"^")
"RTN","PSODDPR8",108,0)
 ..I PSODSUIN,PSODSUIN<DT Q
"RTN","PSODDPR8",109,0)
 ..S PSODSURG(PSODSUA2)=PSODSUNM
"RTN","PSODDPR8",110,0)
 I $O(PSODSURG(""))="" Q
"RTN","PSODDPR8",111,0)
 S INDX=0 K ^TMP($J,"ORDERS") I '$G(PSODSUAG) K ^TMP($J,"DD"),^TMP($J,PSODSULS)
"RTN","PSODDPR8",112,0)
 D BLD^PSOORDRG,ENCHK^PSJORUT2(PSODFN,.INDX),NVA^PSOORDRG I '$D(^TMP($J,"ORDERS")) Q
"RTN","PSODDPR8",113,0)
 S PSODSUDC=0,PSODSUII=""
"RTN","PSODDPR8",114,0)
 I $G(PSODSUAG) D 
"RTN","PSODDPR8",115,0)
 .S PSODSULP="" F  S PSODSULP=$O(^TMP($J,"DD",PSODSULP)) Q:PSODSULP=""  S PSODSUDC=PSODSULP
"RTN","PSODDPR8",116,0)
 .S PSODSUBB="" F  S PSODSUBB=$O(^TMP($J,PSODSULS,"IN","PROSPECTIVE",PSODSUBB)) Q:PSODSUBB=""  I $G(PSODSUTY)=$P(PSODSUBB,";",1,2) S PSODSUB4=$P(PSODSUBB,";",4) I PSODSUB4>PSODSUCC S PSODSUCC=PSODSUB4
"RTN","PSODDPR8",117,0)
 F  S PSODSUII=$O(PSODSURG(PSODSUII)) Q:PSODSUII=""  D
"RTN","PSODDPR8",118,0)
 .S PSODSUNN=PSODSURG(PSODSUII),PSODSUDM=""
"RTN","PSODDPR8",119,0)
 .F  S PSODSUDM=$O(^TMP($J,"ORDERS",PSODSUDM)) Q:PSODSUDM=""  I PSODSUNN=$P(^TMP($J,"ORDERS",PSODSUDM),"^",3) D
"RTN","PSODDPR8",120,0)
 ..S PSODSUDC=PSODSUDC+1,^TMP($J,"DD",PSODSUDC,0)=PSODSUII_"^"_PSODSUNN_"^"_$P(^TMP($J,"ORDERS",PSODSUDM),"^",4)_"^"_$P(^TMP($J,"ORDERS",PSODSUDM),"^",5) D:'$D(PSODSUST(PSODSUII)) PNODE
"RTN","PSODDPR8",121,0)
 K ^TMP($J,"ORDERS")
"RTN","PSODDPR8",122,0)
 Q
"RTN","PSODDPR8",123,0)
 ;
"RTN","PSODDPR8",124,0)
PNODE ;Set prospective node for duplicate supply check for CPRS
"RTN","PSODDPR8",125,0)
 N PSOSPRID,PSOSPRQN,PSOSPRNF,PSOSPRN1,PSOSPRN2,PSOSPRXX
"RTN","PSODDPR8",126,0)
 S PSOSPRNF=$S($G(^PSDRUG(PSODSUII,"ND"))]"":+^PSDRUG(PSODSUII,"ND")_"A"_$P(^PSDRUG(PSODSUII,"ND"),"^",3),1:0)
"RTN","PSODDPR8",127,0)
 S PSOSPRID=$$GETVUID^XTID(50.68,,+$P($G(PSOSPRNF),"A",2)_",")
"RTN","PSODDPR8",128,0)
 S PSOSPRN1=$P($G(^PSDRUG(PSODSUII,"ND")),"^"),PSOSPRN2=$P($G(^PSDRUG(PSODSUII,"ND")),"^",3),PSOSPRXX=$$PROD0^PSNAPIS(PSOSPRN1,PSOSPRN2),PSOSPRQN=$P(PSOSPRXX,"^",7)
"RTN","PSODDPR8",129,0)
 S PSODSUCC=$G(PSODSUCC)+1,^TMP($J,PSODSULS,"IN","PROSPECTIVE",$P(PSODSUTY,";")_";"_$P(PSODSUTY,";",2)_";PROSPECTIVE;"_PSODSUCC)=PSOSPRQN_"^"_+PSOSPRID_"^"_PSODSUII_"^"_$G(PSODSUNN)
"RTN","PSODDPR8",130,0)
 S PSODSUST(PSODSUII)=""
"RTN","PSODDPR8",131,0)
 Q
"RTN","PSODDPRE")
0^17^B128090258
"RTN","PSODDPRE",1,0)
PSODDPRE ;BIR/SAB - Enhanced OP order checks ;09/20/06 3:38pm
"RTN","PSODDPRE",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,387,379,372**;DEC 1997;Build 54
"RTN","PSODDPRE",3,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODDPRE",4,0)
 ;External references to ^PSSDSAPM supported by DBIA 5570
"RTN","PSODDPRE",5,0)
 ;External references to ^PSSHRQ2 supported by DBIA 5369
"RTN","PSODDPRE",6,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPRE",7,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPRE",8,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSODDPRE",9,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPRE",10,0)
 ;External reference to $$SUP^PSSDSAPI supported by DBIA 5425
"RTN","PSODDPRE",11,0)
 ;
"RTN","PSODDPRE",12,0)
 W @IOF
"RTN","PSODDPRE",13,0)
 K IT,^TMP("PSORXDC",$J),^TMP("PSORXDD",$J),CLS,^TMP($J,"PSONVADD"),^TMP($J,"PSONRVADD"),^TMP($J,"PSORDI"),^TMP($J,"PSORMDD")
"RTN","PSODDPRE",14,0)
 N PSONULN,PSODLQT,ZZPSODRG S LIST="PSOPEPS",$P(PSONULN,"-",79)="-",(STA,DNM)=""
"RTN","PSODDPRE",15,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",16,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""!$G(PSORX("DFLG"))  I $P(PSOSD(STA,DNM),"^")'=$G(PSORENW("OIRXN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",17,0)
 .I STA="PENDING" D ^PSODDPR1 Q
"RTN","PSODDPRE",18,0)
 .I STA="ZNONVA" D NVA^PSODDPR1 Q
"RTN","PSODDPRE",19,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",20,0)
 ..I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16) D DUP I $G(PSOTECCK) S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",21,0)
 ..I '$P(PSOPAR,"^",2),$P(PSOPAR,"^",16),$G(PSOTECCK) D DUP Q
"RTN","PSODDPRE",22,0)
 ..I $P(PSOPAR,"^",2),$G(PSOTECCK) D  Q
"RTN","PSODDPRE",23,0)
 ...S DA=+PSOSD(STA,DNM),PSOCLC=DUZ
"RTN","PSODDPRE",24,0)
 ...S MSG="Discontinued During Reinstating Prescription Entry",ACT="Discontinued during Rx Reinstate."
"RTN","PSODDPRE",25,0)
 ...S ^TMP("PSORXDC",$J,DA,0)="52^"_DA_"^"_MSG_"^C^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D",^TMP("PSORXDD",$J)=DNM
"RTN","PSODDPRE",26,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q
"RTN","PSODDPRE",27,0)
 ..I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16) D DUP S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",28,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP
"RTN","PSODDPRE",29,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"PSODRDI")
"RTN","PSODDPRE",30,0)
 Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",31,0)
 M ZZPSODRG=PSODRUG
"RTN","PSODDPRE",32,0)
 S LIST="PSOPEPS" D REMOTE^PSOCPPRE
"RTN","PSODDPRE",33,0)
 M PSODRUG=ZZPSODRG
"RTN","PSODDPRE",34,0)
 Q
"RTN","PSODDPRE",35,0)
OBX  ;process enhanced order checks
"RTN","PSODDPRE",36,0)
 K ZDGDG,ZTHER,IT
"RTN","PSODDPRE",37,0)
 S LIST="PSOPEPS" K PSODLQT,DTOUT,DUOUT,DIRUT,PSODOSD
"RTN","PSODDPRE",38,0)
 I $P(^TMP($J,LIST,"OUT",0),"^")=-1 G EXIT
"RTN","PSODDPRE",39,0)
 W !,"Now Processing Enhanced Order Checks!  Please wait...",! H 2
"RTN","PSODDPRE",40,0)
 D FDB S PDRG=PSODRUG("IEN"),DO=0 D IN^PSSHRQ2(LIST)    ;call 2 fdb
"RTN","PSODDPRE",41,0)
 ;
"RTN","PSODDPRE",42,0)
 K DIR
"RTN","PSODDPRE",43,0)
 I $P(^TMP($J,LIST,"OUT",0),"^")=-1 D DATACK G EXIT
"RTN","PSODDPRE",44,0)
 D ^PSODDPR2 ;if order checks returned
"RTN","PSODDPRE",45,0)
 I '$G(PSOCOPY)&('$G(PSORENW)),$G(PSOQUIT) D
"RTN","PSODDPRE",46,0)
 .I $G(PSOREINS) Q:$G(PSODLQT)  S PSORX("DFLG")=1
"RTN","PSODDPRE",47,0)
 ;
"RTN","PSODDPRE",48,0)
EXIT ;
"RTN","PSODDPRE",49,0)
 D ^PSOBUILD
"RTN","PSODDPRE",50,0)
 K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSODDPRE",51,0)
 K DO,PDRG,IT,PSODLQT
"RTN","PSODDPRE",52,0)
 K ^TMP($J,LIST,"IN","PING"),^TMP($J,LIST,"OUT","EXCEPTIONS"),^TMP($J,"PSOPEPS"),^TMP($J,"PSORDI")
"RTN","PSODDPRE",53,0)
 Q
"RTN","PSODDPRE",54,0)
DUP S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"Duplicate Drug in Local Rx:",!
"RTN","PSODDPRE",55,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Drug"
"RTN","PSODDPRE",56,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPRE",57,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODDPRE",58,0)
 S DA=RXREC
"RTN","PSODDPRE",59,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",60,0)
 W !,$J("Rx: ",24)_$P(^PSRX(+PSOSD(STA,DNM),0),"^")
"RTN","PSODDPRE",61,0)
 W !,$J("Drug: ",24)_$P(DNM,"^")
"RTN","PSODDPRE",62,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODDPRE",63,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSODDPRE",64,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSODDPRE",65,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSODDPRE",66,0)
 K BSIG,PSREV
"RTN","PSODDPRE",67,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",68,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?42,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSODDPRE",69,0)
 S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSODDPRE",70,0)
 W !,$J("Provider: ",24)_PHYS,?42,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSODDPRE",71,0)
 W !,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2
"RTN","PSODDPRE",72,0)
 S LSTFL=+^PSRX(RXREC,3) W ?42,$J("Last filled: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3)
"RTN","PSODDPRE",73,0)
 D PRSTAT(RXREC)
"RTN","PSODDPRE",74,0)
 W !?42,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSODDPRE",75,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODDPRE",76,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 D  Q
"RTN","PSODDPRE",77,0)
 .K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC W @IOF
"RTN","PSODDPRE",78,0)
 .S ^TMP("PSORXDD",$J,RXREC,0)=1
"RTN","PSODDPRE",79,0)
 I '$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) D  Q
"RTN","PSODDPRE",80,0)
 .S PSORX("DFLG")=1 K RXRECLOC,DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue"
"RTN","PSODDPRE",81,0)
 .D ^DIR K DIR
"RTN","PSODDPRE",82,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) D  Q
"RTN","PSODDPRE",83,0)
 .W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",!
"RTN","PSODDPRE",84,0)
 .K DUP,DIR,RXRECLOC S PSORX("DFLG")=1 S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODDPRE",85,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",86,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODDPRE",87,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECLOC,0)),"^"),!
"RTN","PSODDPRE",88,0)
 K PSOMSG S DIR("A")=$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" "_$P(DNM,"^")_" Y/N",DIR(0)="Y"
"RTN","PSODDPRE",89,0)
 S DIR("?")="Enter Y to "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODDPRE",90,0)
 D ^DIR K DIR S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODDPRE",91,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODDPRE",92,0)
 I 'Y W !,$C(7)," -Prescription was not "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODDPRE",93,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP D ULRX K RXRECLOC
"RTN","PSODDPRE",94,0)
 .K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODDPRE",95,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSODDPRE",96,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C")
"RTN","PSODDPRE",97,0)
 W !! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPRE",98,0)
 S X="Rx #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" "_DNM_" will be discontinued after"_$S('$G(PSOTECCK):" the acceptance of the new order.",1:" reinstating the order.") D ^DIWP
"RTN","PSODDPRE",99,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSODDPRE",100,0)
 K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF W !
"RTN","PSODDPRE",101,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D",^TMP("PSORXDD",$J)=DNM H 2
"RTN","PSODDPRE",102,0)
 K RXRECLOC,DUP,CLS,PSONOOR
"RTN","PSODDPRE",103,0)
 Q
"RTN","PSODDPRE",104,0)
FDB ;build drug check input
"RTN","PSODDPRE",105,0)
 N ID,ORTYP,PSOI,ORN S DFN=PSODFN,CT=0
"RTN","PSODDPRE",106,0)
 S ID=+$$GETVUID^XTID(50.68,,+$P(PSODRUG("NDF"),"A",2)_",")
"RTN","PSODDPRE",107,0)
 S P1=$P(PSODRUG("NDF"),"A"),P2=$P(PSODRUG("NDF"),"A",2),X=$$PROD0^PSNAPIS(P1,P2),SEQN=+$P(X,"^",7)
"RTN","PSODDPRE",108,0)
 I 'SEQN K ^TMP($J,LIST,"OUT","EXCEPTIONS"),^TMP($J,LIST,"IN")
"RTN","PSODDPRE",109,0)
 S ^TMP($J,LIST,"IN","PROSPECTIVE","Z;1;PROSPECTIVE;1")=SEQN_"^"_ID_"^"_PSODRUG("IEN")_"^"_$P(^PSDRUG(PSODRUG("IEN"),0),"^")
"RTN","PSODDPRE",110,0)
 S ^TMP($J,LIST,"IN","IEN")=PSODFN,^TMP($J,LIST,"IN","DRUGDRUG")="",^TMP($J,LIST,"IN","THERAPY")=""
"RTN","PSODDPRE",111,0)
 K ID,P1,P2 N ODRG,TU S (STA,DNM)="" I '$G(PSOCOPY),'$G(SEQN) K SEQN Q
"RTN","PSODDPRE",112,0)
 ;build profile drug order checks
"RTN","PSODDPRE",113,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""   D  ;I $P(PSOSD(STA,DNM),"^")'=$G(PSORENW("OIRXN")) S CT=CT+1 D
"RTN","PSODDPRE",114,0)
 .Q:$P(PSOSD(STA,DNM),"^")=$G(PSORENW("OIRXN"))&('$G(PSOCOPY))
"RTN","PSODDPRE",115,0)
 .S CT=CT+1
"RTN","PSODDPRE",116,0)
 .I STA="PENDING" N DDRG D
"RTN","PSODDPRE",117,0)
 ..Q:$G(^TMP("PSORXDC",$J,$P(PSOSD(STA,DNM),"^",10),0))]""
"RTN","PSODDPRE",118,0)
 ..Q:$G(PSODRUG("IEN"))=$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",9)
"RTN","PSODDPRE",119,0)
 ..Q:$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",3)="RF"
"RTN","PSODDPRE",120,0)
 ..Q:$G(^TMP("PSORXPO",$J,$P(PSOSD(STA,DNM),"^",10),0))
"RTN","PSODDPRE",121,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ORN=$P(^PS(52.41,RXREC,0),"^"),ODRG=$P(^(0),"^",9),ORTYP="P"
"RTN","PSODDPRE",122,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPRE",123,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q 
"RTN","PSODDPRE",124,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") D ID
"RTN","PSODDPRE",125,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(52.41,RXREC,0),"^",8) D
"RTN","PSODDPRE",126,0)
 ...S PDNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPRE",127,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"O") I '$P(DDRG,";") D OIX Q
"RTN","PSODDPRE",128,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",129,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPRE",130,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",131,0)
 ...D ID1
"RTN","PSODDPRE",132,0)
 .I STA="ZNONVA" D  Q
"RTN","PSODDPRE",133,0)
 ..Q:$G(^TMP($J,"PSONVADD",$P(PSOSD(STA,DNM),"^",10),0))]""
"RTN","PSODDPRE",134,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ODRG=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^",2),ORN=$P(^(0),"^",8),ORTYP="N"
"RTN","PSODDPRE",135,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPRE",136,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",137,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") D ID
"RTN","PSODDPRE",138,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^") D
"RTN","PSODDPRE",139,0)
 ...S PDNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPRE",140,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"X") I '$P(DDRG,";") D:'$$NVATST(PSOI) OIX Q
"RTN","PSODDPRE",141,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",142,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPRE",143,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",144,0)
 ...D ID1
"RTN","PSODDPRE",145,0)
 .I $P($G(^PSRX(+PSOSD(STA,DNM),0)),"^",6) D
"RTN","PSODDPRE",146,0)
 ..Q:$G(^TMP("PSORXDC",$J,$P(PSOSD(STA,DNM),"^"),0))]""
"RTN","PSODDPRE",147,0)
 ..Q:$G(^TMP("PSORXBO",$J,$P(PSOSD(STA,DNM),"^"),0))
"RTN","PSODDPRE",148,0)
 ..Q:$G(^TMP("PSORXDD",$J,$P(PSOSD(STA,DNM),"^"),0))
"RTN","PSODDPRE",149,0)
 ..;I $P(PSOSD(STA,DNM),"^",2)>5,$P(PSOSD(STA,DNM),"^",2)'=16 Q
"RTN","PSODDPRE",150,0)
 ..S RXREC=+PSOSD(STA,DNM),ODRG=$P(^PSRX(RXREC,0),"^",6),ORN=$P($G(^("OR1")),"^",2),ORTYP="O"
"RTN","PSODDPRE",151,0)
 ..I ODRG D
"RTN","PSODDPRE",152,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",153,0)
 ...I STA="DISCONTINUED" Q:$$DUPTHER(RXREC)
"RTN","PSODDPRE",154,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") D ID
"RTN","PSODDPRE",155,0)
 K RXREC,ID,STA,DNM,PSOI,ORN,ODRG,ORTYP,CT,PDNM,TU,DDRG
"RTN","PSODDPRE",156,0)
 Q
"RTN","PSODDPRE",157,0)
ID N ID,P1,P2 S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",158,0)
 S P1=$P($G(^PSDRUG(ODRG,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=$P(X,"^",7)
"RTN","PSODDPRE",159,0)
ID1 S ^TMP($J,LIST,"IN","PROFILE",ORTYP_";"_RXREC_";PROFILE;"_CT)=SEQN_"^"_ID_"^"_ODRG_"^"_PDNM_"^"_ORN_"^O" K ID
"RTN","PSODDPRE",160,0)
 Q
"RTN","PSODDPRE",161,0)
DUPTHER(RXREC) ;screen out discontinued/duplicate therapy Rx's greater than business rule calculation (cancel date + days supply +7 days)
"RTN","PSODDPRE",162,0)
 ;Note: If the dup allowance is 1 you have to have at least 3 eligible drug orders (or 2 matches) to produce the dupl. therapy warning
"RTN","PSODDPRE",163,0)
 ;Business rule for expired orders is (expiration date+120 days) which is the length of time expired order currently stay on med profile.  No changes for this.
"RTN","PSODDPRE",164,0)
 N X,Y,X1,X2 S X1=$P($G(^PSRX(RXREC,3)),"^",5),X2=(+$P(^PSRX(RXREC,0),"^",8)+7) D C^%DTC I DT>X Q 1
"RTN","PSODDPRE",165,0)
 Q 0
"RTN","PSODDPRE",166,0)
OIX S ^TMP($J,LIST,"IN","EXCEPTIONS","OI",PDNM)=1_"^"_ORTYP_";"_RXREC_";PROFILE;"_CT
"RTN","PSODDPRE",167,0)
 Q
"RTN","PSODDPRE",168,0)
ULRX ;
"RTN","PSODDPRE",169,0)
 I '$G(RXRECLOC) Q
"RTN","PSODDPRE",170,0)
 D PSOUL^PSSLOCK(RXRECLOC)
"RTN","PSODDPRE",171,0)
 Q
"RTN","PSODDPRE",172,0)
 ;
"RTN","PSODDPRE",173,0)
PRSTAT(DA) ;Displays the prescription's status
"RTN","PSODDPRE",174,0)
 N PSOTRANS,PSOREL,PSOCMOP,RXPSTA,PSOX,RFLZRO,PSOLRD,PSORTS,CMOP
"RTN","PSODDPRE",175,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)  S RXPSTA="Processing Status: ",PSOLRD=$P($G(^PSRX(RXREC,2)),"^",13)
"RTN","PSODDPRE",176,0)
 D ^PSOCMOPA I $G(PSOCMOP)]"" D  K CMOP,PSOTRANS,PSOREL
"RTN","PSODDPRE",177,0)
 .S PSOTRANS=$E($P(PSOCMOP,"^",2),4,5)_"/"_$E($P(PSOCMOP,"^",2),6,7)_"/"_$E($P(PSOCMOP,"^",2),2,3)
"RTN","PSODDPRE",178,0)
 .S PSOREL=$S(CMOP("L")=0:$P($G(^PSRX(DA,2)),"^",13),1:$P(^PSRX(DA,1,CMOP("L"),0),"^",18))
"RTN","PSODDPRE",179,0)
 .S PSOREL=$E(PSOREL,4,5)_"/"_$E(PSOREL,6,7)_"/"_$E(PSOREL,2,3)_"@"_$E($P(PSOREL,".",2),1,4)
"RTN","PSODDPRE",180,0)
 .I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSODDPRE",181,0)
 .I $P($G(^PSRX(RXREC,"STA")),"^")=0 W:$$TRANCMOP^PSOUTL(RXREC) ?5,IORVON_IOINHI
"RTN","PSODDPRE",182,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J(RXPSTA,24)_$S($P(PSOCMOP,"^")=0!($P(PSOCMOP,"^")=2):"Transmitted to CMOP on "_PSOTRANS,$P(PSOCMOP,"^")=1:"Released by CMOP on "_PSOREL,1:"Not Dispensed"),IOINORM_IORVOFF
"RTN","PSODDPRE",183,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",184,0)
 I $G(PSOCMOP)']"" D
"RTN","PSODDPRE",185,0)
 .F PSOX=0:0 S PSOX=$O(^PSRX(RXREC,1,PSOX)) Q:'PSOX  D
"RTN","PSODDPRE",186,0)
 ..S RFLZRO=$G(^PSRX(RXREC,1,PSOX,0))
"RTN","PSODDPRE",187,0)
 ..S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R",PSORTS=$P(RFLZRO,"^",16)
"RTN","PSODDPRE",188,0)
 .I '$O(^PSRX(RXREC,1,0)),$P(^PSRX(RXREC,2),"^",15) S PSOLRD=PSOLRD_"^R",PSORTS=$P(^PSRX(RXREC,2),"^",15)
"RTN","PSODDPRE",189,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J(RXPSTA,24)
"RTN","PSODDPRE",190,0)
 .I +$G(PSORTS) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) "Returned to stock on "_$$FMTE^XLFDT(PSORTS,2) Q
"RTN","PSODDPRE",191,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) $S(PSOLRD="":"Not released locally",1:"Released locally on "_$$FMTE^XLFDT($P(PSOLRD,"^"),2)_" "_$P(PSOLRD,"^",2))_$S($P(^PSRX(RXREC,0),"^",11)="W":" (Window)",1:" (Mail)")
"RTN","PSODDPRE",192,0)
 Q
"RTN","PSODDPRE",193,0)
 ;
"RTN","PSODDPRE",194,0)
DATACK ;check FDB returned data to determine whether to continue processing.
"RTN","PSODDPRE",195,0)
 S DIR(0)="E",DIR("A",1)="No Enhanced Order Checks can be performed."
"RTN","PSODDPRE",196,0)
 S DIR("A",2)="   Reason(s): "_$P($G(^TMP($J,LIST,"OUT",0)),"^",2)
"RTN","PSODDPRE",197,0)
 S DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue"
"RTN","PSODDPRE",198,0)
 W ! D ^DIR K DIRUT,DUOUT,DIR,X,Y  W @IOF ;I $P(^TMP($J,LIST,"OUT",0),"^")=1
"RTN","PSODDPRE",199,0)
 Q
"RTN","PSODDPRE",200,0)
 ;
"RTN","PSODDPRE",201,0)
NVATST(PSONVTOI) ; Look for any active Non-VA Dispense Drugs not marked as a supply item
"RTN","PSODDPRE",202,0)
 N PSONVT1,PSONVTFL,PSONVTIN
"RTN","PSODDPRE",203,0)
 S PSONVTFL=1
"RTN","PSODDPRE",204,0)
 F PSONVT1=0:0 S PSONVT1=$O(^PSDRUG("ASP",PSONVTOI,PSONVT1)) Q:'PSONVT1!('PSONVTFL)  D
"RTN","PSODDPRE",205,0)
 .I $P($G(^PSDRUG(PSONVT1,2)),"^",3)'["X" Q
"RTN","PSODDPRE",206,0)
 .S PSONVTIN=$P($G(^PSDRUG(PSONVT1,"I")),"^") I PSONVTIN,PSONVTIN<DT Q
"RTN","PSODDPRE",207,0)
 .S PSONVTFL=$$SUP^PSSDSAPI(PSONVT1)
"RTN","PSODDPRE",208,0)
 Q PSONVTFL
"RTN","PSODGDG1")
0^19^B41929167
"RTN","PSODGDG1",1,0)
PSODGDG1 ;BHAM ISC/SAB - DRUG INTERACTION PROCESSOR ;02/25/94 9:14
"RTN","PSODGDG1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,372**;DEC 1997;Build 54
"RTN","PSODGDG1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSODGDG1",4,0)
 ;
"RTN","PSODGDG1",5,0)
 G PROC^PSODGDG2
"RTN","PSODGDG1",6,0)
PROCESS ;verification
"RTN","PSODGDG1",7,0)
 Q:$P(^PSRX(PSONV,"STA"),"^")=13
"RTN","PSODGDG1",8,0)
 W @IOF W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID")_"  RX #"_$P(INT,"^")
"RTN","PSODGDG1",9,0)
 D CUTDATE^PSOFUNC:'$G(PSODTCUT),^PSOBUILD:'+$G(PSOZVER),^PSODSPL
"RTN","PSODGDG1",10,0)
 S DIR("?",1)="Answer 'YES' if you DO want to "_$S($P(SER,"^",4)=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDG1",11,0)
 S DIR("?",2)="       'NO' if you DON'T want to "_$S($P(SER,"^",4)=1:"continue processing",1:"enter an intervention for")_" this medication,",DIR("?")="    or 'P' to review medication profile."
"RTN","PSODGDG1",12,0)
 W $C(7),$C(7) S DIR("A",1)="",DIR("A",2)="***"_$S($P(SER,"^",4)=1:"CRITICAL",1:"SIGNIFICANT")_"*** "_"Drug Interaction with RX #"_$P(^PSRX($P($P(MED,",",INA),"^"),0),"^"),DIR("A",3)="               Drug: "_$P($G(^PSDRUG($P(^(0),"^",6),0)),"^")
"RTN","PSODGDG1",13,0)
 S DIR(0)="SA^1:YES;0:NO;P:PROFILE",DIR("A")="Do you want to "_$S($P(SER,"^",4)=1:"Continue? ",1:"Intervene? "),DIR("B")="Y" D ^DIR I Y="P" W ! K Y G PROCESS
"RTN","PSODGDG1",14,0)
 I 'Y,$P(SER,"^",4)=1 S PSVERFLG=1
"RTN","PSODGDG1",15,0)
 I Y,$P(SER,"^",4)=1 S PSORX("INTERVENE")=1 K DIR,DTOUT,DIRUT,DIROUT,DUOUT D CRI Q 
"RTN","PSODGDG1",16,0)
 I Y,$P(SER,"^",4)=2 S PSORX("INTERVENE")=2,DA=IFN D INV
"RTN","PSODGDG1",17,0)
 K DIR,DTOUT,DIRUT,DIROUT,DUOUT Q
"RTN","PSODGDG1",18,0)
 Q
"RTN","PSODGDG1",19,0)
CRI ;new interactions
"RTN","PSODGDG1",20,0)
 K DIR I $P(RX,"^",15)=4 D CRITN Q
"RTN","PSODGDG1",21,0)
 S DIR("A",1)="",DIR("A",2)="Do you want to Process or Cancel medication?"
"RTN","PSODGDG1",22,0)
 S DIR("A")="Rx #"_$P($G(^PSRX(DA,0)),"^")_"   "_"Drug: "_$P($G(^PSDRUG($P(^PSRX(DA,0),"^",6),0)),"^")_": "
"RTN","PSODGDG1",23,0)
 S DIR(0)="SA^1:PROCESS;0:CANCEL MEDICATION",DIR("B")="PROCESS"
"RTN","PSODGDG1",24,0)
 K ANSDIR
"RTN","PSODGDG1",25,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication" D ^DIR K DIR
"RTN","PSODGDG1",26,0)
 I $D(DIRUT) S (PSORX("DFLG"),PSVERFLG)=1 Q
"RTN","PSODGDG1",27,0)
 S ANSDIR=Y,PSONV=DA
"RTN","PSODGDG1",28,0)
 D SIG^XUSESIG I X1="" S (PSORX("DFLG"),PSVERFLG)=1 K ANSDIR Q
"RTN","PSODGDG1",29,0)
 I 'ANSDIR N PSOHDINV D  G Q1
"RTN","PSODGDG1",30,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D UPOUT Q
"RTN","PSODGDG1",31,0)
 .S DA=PSONV D RXV S DA=PSONV,PSORX("INTERVENE")=1 D INV S DA=PSONV
"RTN","PSODGDG1",32,0)
 .D PSDEL,HLDINVS,DEL K PSORX("INTERVENE")  S PSVERFLG=1
"RTN","PSODGDG1",33,0)
 I ANSDIR&'$G(PSODIR) S DA=PSONV D HLDINV,INV S DA=PSONV D
"RTN","PSODGDG1",34,0)
 .I '$G(PSVERFLG) D ^PSODGDG2 S $P(^PSRX(PSONV,"STA"),"^")=1 S ZONE=PSONV D ONE
"RTN","PSODGDG1",35,0)
Q1 K DIK,DTOUT,DIRUT,DIROUT,DUOUT,LST,ANSDIR,PSONOOR S PSVERFLG=1
"RTN","PSODGDG1",36,0)
 Q
"RTN","PSODGDG1",37,0)
HLDINV           ;
"RTN","PSODGDG1",38,0)
 I $G(PSORX("INTERVENE")) S PSOHDINV=$G(PSORX("INTERVENE"))
"RTN","PSODGDG1",39,0)
 Q
"RTN","PSODGDG1",40,0)
 ;
"RTN","PSODGDG1",41,0)
 ;
"RTN","PSODGDG1",42,0)
HLDINVS ;
"RTN","PSODGDG1",43,0)
 I $G(PSOHDINV) S PSORX("INTERVENE")=PSOHDINV
"RTN","PSODGDG1",44,0)
 Q
"RTN","PSODGDG1",45,0)
 ;
"RTN","PSODGDG1",46,0)
CRITN ;multiple interactions
"RTN","PSODGDG1",47,0)
 S PSOTHER=$P($P(MED,",",INA),"^") N PSONV
"RTN","PSODGDG1",48,0)
 K DIR S DIR("A",1)="",DIR("A",2)="Do you want to: ",DIR("A",3)=" 1.  Cancel Rx #"_$P(INT,"^")_"  DRUG: "_$P(^PSDRUG($P(INT,"^",6),0),"^")
"RTN","PSODGDG1",49,0)
 S DIR("A",4)=" 2.  Cancel Rx #"_$P(RX,"^")_"  DRUG: "_$P(^PSDRUG($P(RX,"^",6),0),"^"),DIR("A",5)=" 3.  Cancel Both 1 and 2",DIR("A")=" 5.  Leave Both Non-verified (do nothing) ?: ",DIR("A",6)=" 4.  Process Both 1 and 2"
"RTN","PSODGDG1",50,0)
 S DIR(0)="SA^1:1 to be Canceled;2:2 to be Canceled;3:Cancel BOTH 1 and 2;4:ACTIVATE 1 and 2;5:DO NOTHING TO 1 and 2"
"RTN","PSODGDG1",51,0)
 S DIR("?",1)="Enter '1' to Cancel Rx #"_$P(INT,"^")_"  DRUG: "_$P(^PSDRUG($P(INT,"^",6),0),"^"),DIR("?",2)="      '2' to Cancel Rx #"_$P(RX,"^")_"  DRUG: "_$P(^PSDRUG($P(RX,"^",6),0),"^")
"RTN","PSODGDG1",52,0)
 S DIR("?",3)="      '3' or 'B' to Cancel Both 1 and 2",DIR("?",4)="      '4' or 'A' to Activate both RXs",DIR("?")="      '5' or 'D' to do nothing/leave both RXs in a Pending Status" D ^DIR K DIR I Y["^"!(Y=5)!($D(DIRUT)) S PSVERFLG=1 G CRIZ
"RTN","PSODGDG1",53,0)
 S PSAN=Y D SIG^XUSESIG I X1="" K PSAN S (PSORX("DFLG"),PSVERFLG)=1 G CRIZ
"RTN","PSODGDG1",54,0)
 I PSAN=1 D  D KILL Q
"RTN","PSODGDG1",55,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D UPOUT,KILL K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODGDG1",56,0)
 .S DA=IFN D RXV
"RTN","PSODGDG1",57,0)
 .S DA=IFN D PSDEL,DEL
"RTN","PSODGDG1",58,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S DA=IFN D INV S DA=$P(MED,",",INA) S DA=PSOTHER
"RTN","PSODGDG1",59,0)
 .D INV S DA=PSOTHER S $P(^PSRX(PSOTHER,"STA"),"^")=1,ZONE=PSOTHER
"RTN","PSODGDG1",60,0)
 .D ONE K PSONOOR
"RTN","PSODGDG1",61,0)
 I PSAN=2 D  D KILL K PSONOOR Q
"RTN","PSODGDG1",62,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D UPOUT,KILL K PSONOOR,PSORX("INTERVENE") Q
"RTN","PSODGDG1",63,0)
 .S DA=$P(MED,",",INA) D PSDEL,DEL
"RTN","PSODGDG1",64,0)
 .K PSONOOR S:$G(PSOSD) PSOSD=PSOSD-1 S DA=$P(MED,",",INA)
"RTN","PSODGDG1",65,0)
 .D INV S DA=IFN D INV S DA=IFN
"RTN","PSODGDG1",66,0)
 .I 'PSVERFLG,'$P(MED,",",(INA+1)) D ^PSODGDG2 S DA=IFN,$P(^PSRX(DA,"STA"),"^")=1 S ZONE=DA D ONE
"RTN","PSODGDG1",67,0)
 I PSAN=3 D  D KILL K PSONOOR Q
"RTN","PSODGDG1",68,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D UPOUT,KILL K PSONOOR,PSORX("INTERVENE") Q
"RTN","PSODGDG1",69,0)
 .F DA=$P(MED,",",INA),IFN S PSHOLDDA=DA D PSDEL,DEL S DA=PSHOLDDA D INV K DTOUT,DIROUT,DIRUT,DUOUT,PSAN,PSHOLDDA
"RTN","PSODGDG1",70,0)
 I $G(PSAN)=4 S LST=1,PPL="" D
"RTN","PSODGDG1",71,0)
 .S DA=$P(MED,",",INA) D INV S $P(^PSRX(PSOTHER,"STA"),"^")=1 S ZONE=PSOTHER S PSOTHER(PSOTHER)=PSOTHER D ONE
"RTN","PSODGDG1",72,0)
 .S DA=IFN D INV I 'PSVERFLG,'$P(MED,",",(INA+1)) D ^PSODGDG2 S DA=IFN,$P(^PSRX(DA,"STA"),"^")=1 S ZONE=DA D ONE
"RTN","PSODGDG1",73,0)
 .S:$G(PSOSD) PSOSD=PSOSD-2
"RTN","PSODGDG1",74,0)
 D KILL
"RTN","PSODGDG1",75,0)
CRIZ ;
"RTN","PSODGDG1",76,0)
 Q
"RTN","PSODGDG1",77,0)
RXV S DIK="^PS(52.4," D ^DIK Q  ;251;verify there's no dosing checks before deleting
"RTN","PSODGDG1",78,0)
INV D EN1^PSORXI(.DA) K PSORX("INTERVENE") Q
"RTN","PSODGDG1",79,0)
PSDEL Q:$G(STAT)']""
"RTN","PSODGDG1",80,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUE^^DISCONTINUE^DISCONTINUE^HOLD",STAT=$P(STA,"^",$P(^PSRX(DA,"STA"),"^")+1)
"RTN","PSODGDG1",81,0)
 I $P($G(PSOSD(STAT,$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^"))),"^")=DA K PSOSD(STAT,$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^"))
"RTN","PSODGDG1",82,0)
 E  K PSOSD(STAT,$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")_"^"_DA)
"RTN","PSODGDG1",83,0)
 Q
"RTN","PSODGDG1",84,0)
DEL W !!,"Canceling Rx: "_$P($G(^PSRX(DA,0)),"^")_"   "_"Drug: "_$P($G(^PSDRUG($P(^PSRX(DA,0),"^",6),0)),"^"),!
"RTN","PSODGDG1",85,0)
 D ENQ^PSORXDL S PSORX("DFLG")=1
"RTN","PSODGDG1",86,0)
 S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSODGDG1",87,0)
 I $G(PSOPOCK) S VALMBCK="Q"
"RTN","PSODGDG1",88,0)
 Q
"RTN","PSODGDG1",89,0)
ONE S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUE^^DISCONTINUE^DISCONTINUE^HOLD",STAT=$P(STA,"^",$P(^PSRX(ZONE,"STA"),"^")+1)
"RTN","PSODGDG1",90,0)
 I $P($G(PSOSD(STAT,$P(^PSDRUG($P(^PSRX(ZONE,0),"^",6),0),"^"))),"^")=ZONE S $P(PSOSD(STAT,$P(^PSDRUG($P(^PSRX(ZONE,0),"^",6),0),"^")),"^",2)=1
"RTN","PSODGDG1",91,0)
 E  I $G(PSOSD(STAT,$P(^PSDRUG($P(^PSRX(ZONE,0),"^",6),0),"^")_"^"_ZONE)) S $P(PSOSD(STAT,$P(^PSDRUG($P(^PSRX(ZONE,0),"^",6),0),"^")_"^"_ZONE),"^",2)=1
"RTN","PSODGDG1",92,0)
 K ZONE,STA,STAT Q
"RTN","PSODGDG1",93,0)
KILL K DIR,DIK,DTOUT,DIROUT,DIRUT,DUOUT,LST,PPL,PSAN Q
"RTN","PSODGDG1",94,0)
 ;
"RTN","PSODGDG1",95,0)
UPOUT W " ACTION NOT TAKEN!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR S PSVERFLG=1 Q
"RTN","PSODGDG2")
0^44^B14488972
"RTN","PSODGDG2",1,0)
PSODGDG2 ;BIR/RTR-drug drug interaction continued ;8/8/96
"RTN","PSODGDG2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**27,130,251,375,372**;DEC 1997;Build 54
"RTN","PSODGDG2",3,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSODGDG2",4,0)
 ;External references to U, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODGDG2",5,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5424
"RTN","PSODGDG2",6,0)
EN ;Activate or process an Rx
"RTN","PSODGDG2",7,0)
 Q:'$G(DA)
"RTN","PSODGDG2",8,0)
 K ^PS(52.4,"ADI",DA,1),^PSRX(DA,"DRI") F ZZZ=8,9,10 S $P(^PS(52.4,DA,0),"^",ZZZ)=""
"RTN","PSODGDG2",9,0)
 K ZZZ Q
"RTN","PSODGDG2",10,0)
PROC I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) W $C(7),$C(7),!!,"SITE PARAMETERS MUST BE DEFINED !",! G EX
"RTN","PSODGDG2",11,0)
 I '$D(^XUSEC("PSORPH",DUZ)) W $C(7),$C(7),!,"YOU MUST BE A PHARMACIST TO COMPLETE THIS PROCEDURE !",!! Q
"RTN","PSODGDG2",12,0)
 I $P($G(^VA(200,DUZ,20)),"^",4)']"" W $C(7),$C(7),!,"YOU DO NOT HAVE AN ELECTRONIC SIGNATURE CODE !",!! Q
"RTN","PSODGDG2",13,0)
 N PSOODOSP
"RTN","PSODGDG2",14,0)
BEG S DIC="^PS(52.4,",DIC(0)="AQXEZ",DIC("S")="I $D(^PS(52.4,""ADI"",+Y))!($D(^PS(52.4,""DW"",+Y)))"
"RTN","PSODGDG2",15,0)
 S DIC("A")=$S($$DS^PSSDSAPI:"Select RX with Order Checks: ",1:"Select RX with Drug Interaction: ")
"RTN","PSODGDG2",16,0)
 S DIC("W")="W ?$X+5,$P(^DPT($P(^PS(52.4,+Y,0),""^"",2),0),""^"")_"" "",?40,$E($P(^(0),""^"",9),1,3)_""-""_$E($P(^(0),""^"",9),4,5)_""-""_$E($P(^(0),""^"",9),6,9)"
"RTN","PSODGDG2",17,0)
 D ^DIC K DIC G:"^"[$E(X)!($D(DTOUT)) EX
"RTN","PSODGDG2",18,0)
ENT S (PSODFN,PSOVRDFN,DFN,PSDFN)=$P(Y(0),"^",2),PPL="",PSONAM=$P(^DPT(PSDFN,0),"^"),(PSONV,PSONVXX,IFN,DGDG)=+Y D STAT G:FLAGST BEG D ^PSOBUILD
"RTN","PSODGDG2",19,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G BEG
"RTN","PSODGDG2",20,0)
 K PSOPLCK D PSOL^PSSLOCK(PSONV) I '$G(PSOMSG) D UL^PSSLOCK(PSODFN) D  K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR,PSOMSG G BEG
"RTN","PSODGDG2",21,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODGDG2",22,0)
 .W !!,"Another person is editing this order.",!
"RTN","PSODGDG2",23,0)
 I $G(PSOODOSP)'=DFN S PSOODOSP=DFN K PSORX("DOSING OFF")
"RTN","PSODGDG2",24,0)
 D PID^VADPT
"RTN","PSODGDG2",25,0)
 K PSODLQT N PSOPOCK S PSOPOCK=1 D DGDGI^PSOVER
"RTN","PSODGDG2",26,0)
 I $G(VERLFLAG) D UL^PSSLOCK(PSOVRDFN) D PSOUL^PSSLOCK(PSONVXX) K VERLFLAG G BEG
"RTN","PSODGDG2",27,0)
 D PACK^PSOVER
"RTN","PSODGDG2",28,0)
 D UL^PSSLOCK(PSOVRDFN),PSOUL^PSSLOCK(PSONVXX)
"RTN","PSODGDG2",29,0)
 W !! G BEG
"RTN","PSODGDG2",30,0)
EX D END^PSOVER K DTOUT,DIRUT,PSORX,PSOVRDFN,PSONVXX Q
"RTN","PSODGDG2",31,0)
 ;
"RTN","PSODGDG2",32,0)
STAT ;
"RTN","PSODGDG2",33,0)
 S FLAGST=0
"RTN","PSODGDG2",34,0)
 S ST00=$P($G(^PSRX(PSONV,"STA")),"^")
"RTN","PSODGDG2",35,0)
 I $P($G(^PSRX(PSONV,2)),"^",6),+$P($G(^PSRX(PSONV,2)),"^",6)<DT,ST00<12 S $P(^PSRX(PSONV,"STA"),"^")=11,ST00=11
"RTN","PSODGDG2",36,0)
 I ST00=1!(ST00=4) Q
"RTN","PSODGDG2",37,0)
 S FLAGST=1
"RTN","PSODGDG2",38,0)
 K DIK S DA=PSONV,DIK="^PS(52.4," D ^DIK K DIK
"RTN","PSODGDG2",39,0)
 I ST00>10,ST00<16,$O(^PS(52.5,"B",PSONV,0)) S DA=$O(^PS(52.5,"B",PSONV,0)),DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSODGDG2",40,0)
 I ST00>10,ST00<16,$G(^PSRX(PSONV,"H"))]"" K:$P(^PSRX(PSONV,"H"),"^") ^PSRX("AH",$P(^PSRX(PSONV,"H"),"^"),PSONV) S ^PSRX(PSONV,"H")=""
"RTN","PSODGDG2",41,0)
 S STEXT=$S(ST00=0:"Active",ST00=2:"Refill",ST00=3:"Hold",ST00=5:"Suspended",ST00=11:"Expired",ST00=12:"Canceled",ST00=13:"Deleted",ST00=14:"Discontinued",ST00=15:"Discontinued (Edit)",ST00=16:"Provider Hold",1:"Unknown")
"RTN","PSODGDG2",42,0)
 I '$G(CLFLAG) W !!?3,"Rx # ",$P($G(^PSRX(PSONV,0)),"^")," has a status of ",STEXT_".",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press RETURN to continue" D ^DIR W ! K DIR
"RTN","PSODGDG2",43,0)
 Q
"RTN","PSODGDGI")
0^18^B57055647
"RTN","PSODGDGI",1,0)
PSODGDGI ;BIR/SAB - drug drug interaction checker ; 6/28/07 7:36am
"RTN","PSODGDGI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,27,48,130,144,132,188,207,243,274,372**;DEC 1997;Build 54
"RTN","PSODGDGI",3,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSODGDGI",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODGDGI",5,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODGDGI",6,0)
 ;External reference to DDIEX^PSNAPIS supported by DBIA 2574
"RTN","PSODGDGI",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODGDGI",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSODGDGI",9,0)
 Q:$$DDIEX^PSNAPIS($P(PSODRUG("NDF"),"A"),$P(PSODRUG("NDF"),"A",2))
"RTN","PSODGDGI",10,0)
 N PSOICT S (CRIT,DRG,LSI,DGI,DGS,SER,SERS,STA,PSOICT)=""
"RTN","PSODGDGI",11,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""!($G(PSORX("DFLG")))  F  S DRG=$O(PSOSD(STA,DRG)) Q:DRG=""!($G(PSORX("DFLG")))  I $P(PSOSD(STA,DRG),"^",2)<10 D
"RTN","PSODGDGI",12,0)
 .Q:$P(PSOSD(STA,DRG),"^",7)']""
"RTN","PSODGDGI",13,0)
 .S NDF=$P(PSOSD(STA,DRG),"^",7)
"RTN","PSODGDGI",14,0)
 .;New logic to Loop All interactions and filter-up a critical if it exists
"RTN","PSODGDGI",15,0)
 .S IT=0,PSOICT=""
"RTN","PSODGDGI",16,0)
 .F  S IT=$O(^PS(56,"APD",NDF,PSODRUG("NDF"),IT)) Q:'IT  D
"RTN","PSODGDGI",17,0)
 ..Q:$$DDIEX^PSNAPIS($P(NDF,"A"),$P(NDF,"A",2))
"RTN","PSODGDGI",18,0)
 ..Q:$P(^PS(56,IT,0),"^",7)&($P(^PS(56,IT,0),"^",7)<DT)
"RTN","PSODGDGI",19,0)
 ..I 'PSOICT S PSOICT=IT Q
"RTN","PSODGDGI",20,0)
 ..I $P($G(^PS(56,IT,0)),"^",4)=1 S PSOICT=IT Q
"RTN","PSODGDGI",21,0)
 ..Q
"RTN","PSODGDGI",22,0)
 .I 'PSOICT Q
"RTN","PSODGDGI",23,0)
 .S IT=PSOICT
"RTN","PSODGDGI",24,0)
 .I STA="ZNONVA" S DNM=DRG W ! D NVA^PSODRDU1 K DNM,IT,PSOICT Q
"RTN","PSODGDGI",25,0)
 .D BLD Q:+$G(PSORX("DFLG"))
"RTN","PSODGDGI",26,0)
 .Q
"RTN","PSODGDGI",27,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(DGI)]"" S:+CRIT PSONEW("STATUS")=4 W $C(7),!,"DRUG INTERACTION WITH RX #s: "_LSI,! K LSI,DRG,IT,NDF,PSOICT
"RTN","PSODGDGI",28,0)
 K IT
"RTN","PSODGDGI",29,0)
 ; CHECK FOR REMOTE DRUG INTERACTIONS
"RTN","PSODGDGI",30,0)
 I +$G(PSORX("DFLG")) Q
"RTN","PSODGDGI",31,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODGDGI",32,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODGDGI",33,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSODGDGI",34,0)
 .I $T(REMOTE^PSORX1)]"" Q
"RTN","PSODGDGI",35,0)
 .W !,"Remote data not available - Only local order checks processed." D PAUSE^PSOORRD2
"RTN","PSODGDGI",36,0)
 I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !,"Remote data not available - Only local order checks processed." D PAUSE^PSOORRD2 Q
"RTN","PSODGDGI",37,0)
 I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSODGDGI",38,0)
 K ^TMP($J,"DI"_PSODFN),^TMP($J,"DI")
"RTN","PSODGDGI",39,0)
 Q
"RTN","PSODGDGI",40,0)
TECH ;add tech entry to RX VERIFY file (#52.4)
"RTN","PSODGDGI",41,0)
 I +CRIT S PSODI=1,DIC="^PS(52.4,",DLAYGO=52.4,DIC(0)="L",(DINUM,X)=PSOX("IRXN"),DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4///"_DT_";7///"_1_";7.1///"_SER_";7.2///"_DGI K DD,DO D FILE^DICN K DD,DO
"RTN","PSODGDGI",42,0)
 S:$G(DGS)'="" $P(^PSRX(PSOX("IRXN"),"DRI"),"^")=SERS,$P(^PSRX(PSOX("IRXN"),"DRI"),"^",2)=DGS  K PSODI,CRIT,DIC,DLAYGO,DINUM,DGI,DGS,SER,SERS Q
"RTN","PSODGDGI",43,0)
BLD I $D(^XUSEC("PSORPH",DUZ)) D PHARM Q
"RTN","PSODGDGI",44,0)
 S LSI=$P(^PSRX(+PSOSD(STA,DRG),0),"^")_"/"_$P(^PSDRUG($P(^(0),"^",6),0),"^")_","_LSI,DGI=$P(PSOSD(STA,DRG),"^")_","_DGI,SER=IT_","_SER I $P(PSOSD(STA,DRG),"^",9),$P(^PS(56,IT,0),"^",4)=1 S $P(^PSRX(+PSOSD(STA,DRG),"STA"),"^")=4
"RTN","PSODGDGI",45,0)
 I $P(^PS(56,IT,0),"^",4)=2 S SERS=IT_","_SERS,DGS=$P(PSOSD(STA,DRG),"^")_","_DGS
"RTN","PSODGDGI",46,0)
 S:$P(^PS(56,IT,0),"^",4)=1 CRIT=1 Q
"RTN","PSODGDGI",47,0)
PHARM ;pharmacist verification of drug interaction
"RTN","PSODGDGI",48,0)
 D PSOL^PSSLOCK($P(PSOSD(STA,DRG),"^")) I '$G(PSOMSG) D  K PSOMSG S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODGDGI",49,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2) D  Q
"RTN","PSODGDGI",50,0)
 ..W !,"Rx: "_$P($G(^PSRX($P(PSOSD(STA,DRG),"^"),0)),"^")_"    Drug: "_$P($G(^PSDRUG(+$P($G(^(0)),"^",6),0)),"^")
"RTN","PSODGDGI",51,0)
 ..W !,"which interacts with the drug you are entering!",!
"RTN","PSODGDGI",52,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX($P(PSOSD(STA,DRG),"^"),0)),"^")_",",!,"which interacts with the drug you are entering!",!
"RTN","PSODGDGI",53,0)
 S PSODGRLX=$P(PSOSD(STA,DRG),"^")
"RTN","PSODGDGI",54,0)
 S SER=^PS(56,IT,0),DIR("?",1)="Answer 'YES' if you DO want to "_$S($P(SER,"^",4)=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGI",55,0)
 S DIR("?")="       'NO' if you DON'T want to "_$S($P(SER,"^",4)=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGI",56,0)
 W $C(7),$C(7) S DIR("A",1)="***"_$S($P(SER,"^",4)=1:"CRITICAL",1:"SIGNIFICANT")_"*** "_"Drug Interaction with RX #"_$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^"),DIR("A",2)="DRUG: "_$P(DRG,"^")
"RTN","PSODGDGI",57,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to "_$S($P(SER,"^",4)=1:"Continue? ",1:"Intervene? "),DIR("B")="Y" D ^DIR
"RTN","PSODGDGI",58,0)
 I 'Y,$P(SER,"^",4)=1 S PSORX("DFLG")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGI",59,0)
 I Y,$P(SER,"^",4)=1 S PSORX("INTERVENE")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT G CRI Q
"RTN","PSODGDGI",60,0)
 I 'Y,$P(SER,"^",4)=2 K DIR,DTOUT,DIRUT,DIROUT,DUOUT D ULRX Q
"RTN","PSODGDGI",61,0)
 I Y,$P(SER,"^",4)=2 S PSORX("INTERVENE")=2,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGI",62,0)
 D ULRX
"RTN","PSODGDGI",63,0)
 Q
"RTN","PSODGDGI",64,0)
CRI ;process new drug interactions entered by pharmacist
"RTN","PSODGDGI",65,0)
 K DIR G:$P(PSOSD(STA,DRG),"^",9) CRITN S DIR("A",1)="",DIR("A",2)="Do you want to Process medication",DIR("A")=PSODRUG("NAME")_": ",DIR(0)="SA^1:PROCESS;0:ABORT ORDER ENTRY",DIR("B")="P"
"RTN","PSODGDGI",66,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'A' to Abort Order Entry process" D ^DIR K X1,DIR I 'Y S PSORX("DFLG")=1,DGI="" K DTOUT,DIRUT,DIROUT,DUOUT,PSORX("INTERVENE") D ULRX Q
"RTN","PSODGDGI",67,0)
 I $P(SER,"^",4)=1 D
"RTN","PSODGDGI",68,0)
 .D SIG^XUSESIG I X1="" K PSORX("INTERVENE") S PSORX("DFLG")=1 Q
"RTN","PSODGDGI",69,0)
 .S PSORX("INTERVENE")=$P(SER,"^",4)
"RTN","PSODGDGI",70,0)
 K DUOUT,DTOUT,DIRUT,DIROUT D ULRX Q
"RTN","PSODGDGI",71,0)
CRITN ;process multiple new drug interactions
"RTN","PSODGDGI",72,0)
 K X1,DIR S DIR("A",1)="",DIR("A",2)="Do you want to: ",DIR("A",3)=" 1.  Delete NEW medication "_PSODRUG("NAME"),DIR("A",4)=" 2.  Cancel ACTIVE New Rx #"_$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^")_" DRUG: "_$P(DRG,"^")
"RTN","PSODGDGI",73,0)
 S DIR("A",5)=" 3.  Delete 1 and Cancel 2",DIR("A")=" 4.  Continue ?: ",DIR(0)="SA^1:NEW MEDICATION;2:ACTIVE New Rx "_$P(DRG,"^")_";3:BOTH;4:CONTINUE"
"RTN","PSODGDGI",74,0)
 S DIR("?",1)="Enter '1' or 'N' to Delete New Medication and Dispense Rx #"_$P(^PSRX(+PSOSD(STA,DRG),0),"^")
"RTN","PSODGDGI",75,0)
 S DIR("?",2)="      '2' or 'A' to Cancel Active Rx #"_$P(^PSRX(+PSOSD(STA,DRG),0),"^")_" and Dispense New Rx"
"RTN","PSODGDGI",76,0)
 S DIR("?",3)="      '3' or 'B' to Delete 1 and Cancel 2",DIR("?")="      '4' or 'C' to do nothing to either Rx" D ^DIR K DIR
"RTN","PSODGDGI",77,0)
 I Y=1 S PSORX("DFLG")=1,DGI="",PSHLDDRG=PSODRUG("IEN") D  D ULRX Q
"RTN","PSODGDGI",78,0)
 .I $G(PSORXED) D  Q
"RTN","PSODGDGI",79,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) W $C(7)," ACTION NOT TAKEN!",! S PSORX("DFLG")=1 K PSORX("INTERVENE") Q
"RTN","PSODGDGI",80,0)
 ..S DA=$P(PSOLST(ORN),"^",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGI",81,0)
 ..K PSOSD($P(PSOLST(ORN),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGI",82,0)
 .S PSODRUG("IEN")=$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^",6) D FULL^VALM1,^PSORXI
"RTN","PSODGDGI",83,0)
 .S PSODRUG("IEN")=PSHLDDRG,VALMBCK="R"
"RTN","PSODGDGI",84,0)
 .K DTOUT,DIRUT,DIROUT,DUOUT,PSHLDDRG
"RTN","PSODGDGI",85,0)
 .I $G(OR0) D
"RTN","PSODGDGI",86,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",87,0)
 ...W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",88,0)
 ..D DC^PSOORFI2
"RTN","PSODGDGI",89,0)
 I Y=2 S (DA,PSOHOLDA)=+PSOSD(STA,DRG) D  D ULRX Q
"RTN","PSODGDGI",90,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",91,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",92,0)
 .D MESS,ENQ^PSORXDL
"RTN","PSODGDGI",93,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL
"RTN","PSODGDGI",94,0)
 .K PSOSD(STA,DRG),DTOUT,DIROUT,DIRUT,DUOUT,PSOHOLDA
"RTN","PSODGDGI",95,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S VALMBCK="R"
"RTN","PSODGDGI",96,0)
 I Y=3 S (DA,PSOHOLDA)=+PSOSD(STA,DRG) D  S VALMBCK="R"
"RTN","PSODGDGI",97,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",98,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",99,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S PSORX("DFLG")=1 D MESS,ENQ^PSORXDL
"RTN","PSODGDGI",100,0)
 .I $G(OR0) D DC^PSOORFI2
"RTN","PSODGDGI",101,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL K PSOSD(STA,DRG),PSOHOLDA
"RTN","PSODGDGI",102,0)
 .I $G(PSORXED) D
"RTN","PSODGDGI",103,0)
 ..S DA=$P(PSOLST(ORN),"^",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGI",104,0)
 ..K PSOSD($P(PSOLST(ORN),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGI",105,0)
 K DTOUT,DIROUT,DIRUT,DUOUT
"RTN","PSODGDGI",106,0)
 D ULRX
"RTN","PSODGDGI",107,0)
 Q
"RTN","PSODGDGI",108,0)
MESS W !!,"Canceling Rx: "_$P($G(^PSRX(DA,0)),"^")_"   "_"Drug: "_$P($G(^PSDRUG($P(^PSRX(DA,0),"^",6),0)),"^"),! Q
"RTN","PSODGDGI",109,0)
PPL F PSOSL=0:0 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  S PSOX2=PSOSL
"RTN","PSODGDGI",110,0)
 I $G(PSOX2) D
"RTN","PSODGDGI",111,0)
 .F PSOSL=0:1:PSOX2 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  F ENT=1:1:$L(PSORX("PSOL",PSOSL),",") I $P(PSORX("PSOL",PSOSL),",",ENT)=$P(PSOSD(STA,DRG),"^") S PSOL(PSOSL,ENT)=""
"RTN","PSODGDGI",112,0)
 .F PSOL=0:0 S PSOL=$O(PSOL(PSOL)) Q:'PSOL  F ENT=0:0 S ENT=$O(PSOL(PSOL,ENT)) Q:'ENT  D
"RTN","PSODGDGI",113,0)
 ..I ENT=1,'$P(PSORX("PSOL",PSOL),",",2) K PSORX("PSOL",PSOL) Q
"RTN","PSODGDGI",114,0)
 ..I ENT=1,$P(PSORX("PSOL",PSOL),",",2) S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",2,99) Q
"RTN","PSODGDGI",115,0)
 ..S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",1,ENT-1)_","_$P(PSORX("PSOL",PSOL),",",ENT+1,99)
"RTN","PSODGDGI",116,0)
 K PSOX2,PSOSL,PSOL,ENT Q
"RTN","PSODGDGI",117,0)
ULRX ;
"RTN","PSODGDGI",118,0)
 I '$G(PSODGRLX) Q
"RTN","PSODGDGI",119,0)
 D PSOUL^PSSLOCK(PSODGRLX) K PSODGRLX
"RTN","PSODGDGI",120,0)
 Q
"RTN","PSODGDGP")
0^20^B58836737
"RTN","PSODGDGP",1,0)
PSODGDGP ;BIR/SAB - drug drug interaction checker ;4/14/93
"RTN","PSODGDGP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,387,379,391,372**;DEC 1997;Build 54
"RTN","PSODGDGP",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODGDGP",4,0)
 ;External references PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODGDGP",5,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODGDGP",6,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSODGDGP",7,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSODGDGP",8,0)
 N DRG,PSOREMOT S (CRIT,DRG,LSI,DGI,DGS,SER,SERS,STA,PSOICT)="",PSOREMOT=0
"RTN","PSODGDGP",9,0)
 D BLD Q:+$G(PSORX("DFLG"))!($G(PSODLQT))
"RTN","PSODGDGP",10,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(DGI)]"" S:$G(CRIT) PSONEW("STATUS")=4 W $C(7),!,"DRUG INTERACTON WITH RX #s: "_LSI,!
"RTN","PSODGDGP",11,0)
 I '$D(^XUSEC("PSORPH",DUZ)),(","_$G(^TMP("PSOSER",$J,0))_",")[(",1,") S:$D(^TMP("PSODGI",$J,0)) PSONEW("STATUS")=4
"RTN","PSODGDGP",12,0)
 K DRG,NDF,PSOICT,IT,LSI
"RTN","PSODGDGP",13,0)
 I +$G(PSORX("DFLG")) Q
"RTN","PSODGDGP",14,0)
 I +$G(PSODRUG("NDF"))'=0 D
"RTN","PSODGDGP",15,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODGDGP",16,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODGDGP",17,0)
 .;D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSODGDGP",18,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",!! S PSOREMOT=1 D HD^PSODDPR2():(($Y+5)>IOSL) Q
"RTN","PSODGDGP",19,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSODGDGP",20,0)
 .K ^TMP($J,"DI"_PSODFN),^TMP($J,"DI")
"RTN","PSODGDGP",21,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSOREMOT)!($G(DGI)]"") K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue..." D ^DIR K DIR,DUOUT,DTOUT
"RTN","PSODGDGP",22,0)
 Q
"RTN","PSODGDGP",23,0)
TECH ;add tech entry to RX VERIFY file (#52.4); called from new order/copy/renew
"RTN","PSODGDGP",24,0)
 I $$DS^PSSDSAPI,+$G(^TMP("PSODOSF",$J,0)) S ^PS(52.4,PSOXIRXN,1)=^TMP("PSODOSF",$J,0)
"RTN","PSODGDGP",25,0)
 Q:'$D(^TMP("PSODGI",$J,0))
"RTN","PSODGDGP",26,0)
 S $P(^PSRX(PSOXIRXN,"DRI"),"^")=^TMP("PSOSER",$J,0)_"^"_^TMP("PSODGI",$J,0)
"RTN","PSODGDGP",27,0)
 S $P(^PS(52.4,PSOXIRXN,0),"^",8)=1,$P(^PS(52.4,PSOXIRXN,0),"^",9)=^TMP("PSOSER",$J,0),$P(^PS(52.4,PSOXIRXN,0),"^",10)=^TMP("PSODGI",$J,0)
"RTN","PSODGDGP",28,0)
 Q
"RTN","PSODGDGP",29,0)
TECH2(PSOXIRXN,PSODFN,DUZ,PSOX) ;
"RTN","PSODGDGP",30,0)
 I $D(PSOX("NOPSDRPH")) G T3
"RTN","PSODGDGP",31,0)
 Q:$D(^XUSEC("PSORPH",DUZ))
"RTN","PSODGDGP",32,0)
T3 N PSODWARN,PSOSIGNIF,PSOINTSV,PSOTLBL S (PSODWARN,PSOSIGNIF,PSOTLBL,PSOINTSV)=0
"RTN","PSODGDGP",33,0)
 S:$$DS^PSSDSAPI&(+$G(^TMP("PSODOSF",$J,0))) PSODWARN=1  ;dosing drug warning
"RTN","PSODGDGP",34,0)
 I $D(^TMP("PSOSER",$J,0)) S PSOINTSV=$G(^TMP("PSOSER",$J,0)) S:PSOINTSV[1 PSODWARN=1 S:PSOINTSV[2 PSOSIGNIF=1 ;critical and significant drug interaction drug warnings
"RTN","PSODGDGP",35,0)
 I '$G(PSORX("VERIFY")),'PSODWARN&($G(PSOSIGNIF)) D  Q PSOTLBL  ;don't set 52.4 when  verification is off and only signficiant interation
"RTN","PSODGDGP",36,0)
 .S $P(^PSRX(PSOXIRXN,"DRI"),"^")=^TMP("PSOSER",$J,0),$P(^PSRX(PSOXIRXN,"DRI"),"^",2)=^TMP("PSODGI",$J,0) S:'$P(PSOPAR,"^",2) PSOTLBL=1
"RTN","PSODGDGP",37,0)
 I $G(PSODWARN)!($G(PSORX("VERIFY"))) D
"RTN","PSODGDGP",38,0)
 .K DIC,DLAYGO,DINUM,DIADD,X,DD,DO S DIC="^PS(52.4,",DLAYGO=52.4,DINUM=PSOXIRXN,DIC(0)="ML",X=PSOXIRXN
"RTN","PSODGDGP",39,0)
 .D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM S ^PS(52.4,PSOXIRXN,0)=PSOXIRXN_"^"_PSODFN_"^"_DUZ_"^"_"^"_$E(PSOX("LOGIN DATE"),1,7)_"^"_PSOXIRXN_"^"_PSOX("STOP DATE")
"RTN","PSODGDGP",40,0)
 .Q:PSOINTSV'[1&('PSODWARN)
"RTN","PSODGDGP",41,0)
 .D TECH
"RTN","PSODGDGP",42,0)
 I $D(^PS(52.4,PSOXIRXN)) K DIK,DA S DIK="^PS(52.4,",DA=PSOX("IRXN") D IX^DIK K DIK,DA
"RTN","PSODGDGP",43,0)
 I '$G(PSORX("VERIFY")) S:(PSOX("STATUS")=4!$G(PSODWARN)) PSOTLBL=1 ;verification off, dose warn or drug interaction, print technician warning label
"RTN","PSODGDGP",44,0)
 I $G(PSORX("VERIFY")) S PSOTLBL=$S('$G(PSODWARN)&('$G(PSOSIGNIF)):2,'$G(PSODWARN)&($G(PSOSIGNIF)):2,$G(PSODWARN):1,1:0)
"RTN","PSODGDGP",45,0)
 Q PSOTLBL
"RTN","PSODGDGP",46,0)
 ;
"RTN","PSODGDGP",47,0)
BLD I $D(^XUSEC("PSORPH",DUZ)) S PSORX("PHARM")=DUZ D PHARM Q
"RTN","PSODGDGP",48,0)
BLD2 ;
"RTN","PSODGDGP",49,0)
 Q:$P(ON,";")'="O"
"RTN","PSODGDGP",50,0)
 S LSI=$P(^PSRX($P(ON,";",2),0),"^")_"/"_$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")_","_LSI
"RTN","PSODGDGP",51,0)
 I '$D(^TMP("PSODGI",$J,0)) D
"RTN","PSODGDGP",52,0)
 . S ^TMP("PSODGI",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGI",$J,0)),^TMP("PSOSER",$J,0)=IT_","_$G(^TMP("PSOSER",$J,0))
"RTN","PSODGDGP",53,0)
 I ^TMP("PSODGI",$J,0)'[$P(ON,";",2) D
"RTN","PSODGDGP",54,0)
 .S ^TMP("PSODGI",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGI",$J,0))
"RTN","PSODGDGP",55,0)
 .S ^TMP("PSOSER",$J,0)=IT_","_$G(^TMP("PSOSER",$J,0))
"RTN","PSODGDGP",56,0)
 I IT=2 S ^TMP("PSOSERS",$J,0)=IT_","_$G(^TMP("PSOSERS",$J,0)),^TMP("PSODGS",$J,0)=$P(ON,";",2)_","_$G(^TMP("PSODGS",$J,0))
"RTN","PSODGDGP",57,0)
 S:IT=1 ^TMP("PSOTDD",$J,1)=1
"RTN","PSODGDGP",58,0)
 Q
"RTN","PSODGDGP",59,0)
PHARM ;pharmacist verification of drug interaction
"RTN","PSODGDGP",60,0)
 S PSODGRLX=$P(ON,";",2)
"RTN","PSODGDGP",61,0)
 S DIR("?",1)="Answer 'YES' if you DO want to "_$S(IT=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGP",62,0)
 S DIR("?")="       'NO' if you DON'T want to "_$S(IT=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGP",63,0)
 W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to "_$S(IT=1:"Continue? ",1:"Intervene? "),DIR("B")="Y" D ^DIR
"RTN","PSODGDGP",64,0)
 I 'Y,IT=1 S PSODLQT=1,DGI="" S:'$G(PSORXED)&('$G(PSOREINS)) PSORX("DFLG")=1 S:$G(PSORXED)!($G(PSOREINS)) PSOQUIT=1 K DIR,DTOUT,DIRUT,DIROUT,DUOUT Q
"RTN","PSODGDGP",65,0)
 I Y,IT=1 S PSORX("INTERVENE")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT G CRI Q
"RTN","PSODGDGP",66,0)
 I 'Y,IT=2 S:$G(DIRUT) (PSODLQT,PSOQUIT)=1 K DIR,DTOUT,DIRUT,DIROUT,DUOUT D ULRX Q
"RTN","PSODGDGP",67,0)
 I Y,IT=2 S PSORX("INTERVENE")=2,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGP",68,0)
 D ULRX
"RTN","PSODGDGP",69,0)
 Q
"RTN","PSODGDGP",70,0)
CRI ;process new drug interactions entered by pharmacist
"RTN","PSODGDGP",71,0)
 K DIR ;G:$P(PSOSD(STA,DRG),"^",9) CRITN 
"RTN","PSODGDGP",72,0)
 S DIR("A",1)="",DIR("A",2)="Do you want to Process medication",DIR("A")=PSODRUG("NAME")_": ",DIR(0)="SA^1:PROCESS;0:ABORT ORDER ENTRY",DIR("B")="P"
"RTN","PSODGDGP",73,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'A' to Abort Order Entry process" D ^DIR K X1,DIR I 'Y S PSORX("DFLG")=1,DGI="" K DTOUT,DIRUT,DIROUT,DUOUT,PSORX("INTERVENE") D ULRX Q
"RTN","PSODGDGP",74,0)
 I IT=1 D
"RTN","PSODGDGP",75,0)
 .S PSORX("INTERVENE")=IT
"RTN","PSODGDGP",76,0)
 .D SIG^XUSESIG I X1="" K PSORX("INTERVENE") S PSORX("DFLG")=1 Q
"RTN","PSODGDGP",77,0)
 K DUOUT,DTOUT,DIRUT,DIROUT D ULRX Q
"RTN","PSODGDGP",78,0)
CRITN ;process multiple new drug interactions
"RTN","PSODGDGP",79,0)
 K X1,DIR S DIR("A",1)="",DIR("A",2)="Do you want to: ",DIR("A",3)=" 1.  Delete NEW medication "_PSODRUG("NAME"),DIR("A",4)=" 2.  Cancel ACTIVE New Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" DRUG: "_DRG
"RTN","PSODGDGP",80,0)
 S DIR("A",5)=" 3.  Delete 1 and Cancel 2",DIR("A")=" 4.  Continue ?: ",DIR(0)="SA^1:NEW MEDICATION;2:ACTIVE New Rx "_DRG_";3:BOTH;4:CONTINUE"
"RTN","PSODGDGP",81,0)
 S DIR("?",1)="Enter '1' or 'N' to Delete New Medication and Dispense Rx #"_$P(^PSRX($P(ON,";",2),0),"^")
"RTN","PSODGDGP",82,0)
 S DIR("?",2)="      '2' or 'A' to Cancel Active Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" and Dispense New Rx"
"RTN","PSODGDGP",83,0)
 S DIR("?",3)="      '3' or 'B' to Delete 1 and Cancel 2",DIR("?")="      '4' or 'C' to do nothing to either Rx" D ^DIR K DIR
"RTN","PSODGDGP",84,0)
 I Y=1 S PSORX("DFLG")=1,DGI="",PSHLDDRG=PSODRUG("IEN") D  D ULRX Q
"RTN","PSODGDGP",85,0)
 .I $G(PSORXED) D  Q
"RTN","PSODGDGP",86,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) W $C(7)," ACTION NOT TAKEN!",! S PSORX("DFLG")=1 K PSORX("INTERVENE") Q
"RTN","PSODGDGP",87,0)
 ..S DA=$P(ON,";",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGP",88,0)
 ..K PSOSD($P(PSOLST($P(ON,";",2)),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGP",89,0)
 .S PSODRUG("IEN")=$P(^PSRX($P(ON,";",2),0),"^",6) D FULL^VALM1,^PSORXI
"RTN","PSODGDGP",90,0)
 .S PSODRUG("IEN")=PSHLDDRG,VALMBCK="R"
"RTN","PSODGDGP",91,0)
 .K DTOUT,DIRUT,DIROUT,DUOUT,PSHLDDRG
"RTN","PSODGDGP",92,0)
 .I $G(OR0) D
"RTN","PSODGDGP",93,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",94,0)
 ...W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",95,0)
 ..D DC^PSOORFI2
"RTN","PSODGDGP",96,0)
 I Y=2 S (DA,PSOHOLDA)=$P(ON,";",2) D  D ULRX Q
"RTN","PSODGDGP",97,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",98,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",99,0)
 .D MESS,ENQ^PSORXDL
"RTN","PSODGDGP",100,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL
"RTN","PSODGDGP",101,0)
 .K DTOUT,DIROUT,DIRUT,DUOUT,PSOHOLDA
"RTN","PSODGDGP",102,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S VALMBCK="R"
"RTN","PSODGDGP",103,0)
 I Y=3 S (DA,PSOHOLDA)=$P(ON,";",2) D  S VALMBCK="R"
"RTN","PSODGDGP",104,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGP",105,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGP",106,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S PSORX("DFLG")=1 D MESS,ENQ^PSORXDL
"RTN","PSODGDGP",107,0)
 .I $G(OR0) D DC^PSOORFI2
"RTN","PSODGDGP",108,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL K PSOHOLDA
"RTN","PSODGDGP",109,0)
 .I $G(PSORXED) D
"RTN","PSODGDGP",110,0)
 ..S DA=$P(ON,";",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGP",111,0)
 ..K DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGP",112,0)
 K DTOUT,DIROUT,DIRUT,DUOUT
"RTN","PSODGDGP",113,0)
 D ULRX
"RTN","PSODGDGP",114,0)
 Q
"RTN","PSODGDGP",115,0)
MESS W !!,"Canceling Rx: "_$P($G(^PSRX(DA,0)),"^")_"   "_"Drug: "_$P($G(^PSDRUG($P(^PSRX(DA,0),"^",6),0)),"^"),! Q
"RTN","PSODGDGP",116,0)
PPL F PSOSL=0:0 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  S PSOX2=PSOSL
"RTN","PSODGDGP",117,0)
 I $G(PSOX2) D
"RTN","PSODGDGP",118,0)
 .F PSOSL=0:1:PSOX2 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  F ENT=1:1:$L(PSORX("PSOL",PSOSL),",") I $P(PSORX("PSOL",PSOSL),",",ENT)=$P(ON,";",2) S PSOL(PSOSL,ENT)=""
"RTN","PSODGDGP",119,0)
 .F PSOL=0:0 S PSOL=$O(PSOL(PSOL)) Q:'PSOL  F ENT=0:0 S ENT=$O(PSOL(PSOL,ENT)) Q:'ENT  D
"RTN","PSODGDGP",120,0)
 ..I ENT=1,'$P(PSORX("PSOL",PSOL),",",2) K PSORX("PSOL",PSOL) Q
"RTN","PSODGDGP",121,0)
 ..I ENT=1,$P(PSORX("PSOL",PSOL),",",2) S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",2,99) Q
"RTN","PSODGDGP",122,0)
 ..S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",1,ENT-1)_","_$P(PSORX("PSOL",PSOL),",",ENT+1,99)
"RTN","PSODGDGP",123,0)
 K PSOX2,PSOSL,PSOL,ENT Q
"RTN","PSODGDGP",124,0)
ULRX ;
"RTN","PSODGDGP",125,0)
 I '$G(PSODGRLX) Q
"RTN","PSODGDGP",126,0)
 D PSOUL^PSSLOCK(PSODGRLX) K PSODGRLX
"RTN","PSODGDGP",127,0)
 Q
"RTN","PSODIR")
0^7^B37531921
"RTN","PSODIR",1,0)
PSODIR ;BHAM ISC/SAB - asks data for rx order entry ; 9/17/07 5:03pm
"RTN","PSODIR",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**37,46,111,117,146,164,211,264,275,391,372**;DEC 1997;Build 54
"RTN","PSODIR",3,0)
 ;External reference PSDRUG( supported by DBIA 221
"RTN","PSODIR",4,0)
 ;External reference PS(50.7 supported by DBIA 2223
"RTN","PSODIR",5,0)
 ;External reference to VA(200 is supported by DBIA 10060
"RTN","PSODIR",6,0)
 ;----------------------------------------------------------------
"RTN","PSODIR",7,0)
 ;
"RTN","PSODIR",8,0)
PROV(PSODIR) ;
"RTN","PSODIR",9,0)
PROVEN ; Entry point for failed lookup
"RTN","PSODIR",10,0)
 K DIC,X,Y S:$G(PSOFDR)&($G(OR0)) DIC("B")=$P(^VA(200,$P($G(OR0),"^",5),0),"^")
"RTN","PSODIR",11,0)
 I $$PATCH^XPDUTL("PSO*7.0*391"),'$D(PSODIR("CS")),$D(PSODRUG("DEA")) D
"RTN","PSODIR",12,0)
 .N DEA S PSODIR("CS")=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSODIR",13,0)
 I $G(PSODIR("PROVIDER"))]"" S PSODIR("OLD VAL")=PSODIR("PROVIDER")
"RTN","PSODIR",14,0)
 S DIC="^VA(200,",DIC(0)="QEAM",PSODIR("FIELD")=0
"RTN","PSODIR",15,0)
 S DIC("W")="W ""     "",$P(^(""PS""),""^"",9)"
"RTN","PSODIR",16,0)
 S DIC("A")="PROVIDER: ",DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSODIR",17,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" S DIC("S")=DIC("S")_",$P($G(^(""TPB"")),""^""),$P($G(^(""TPB"")),""^"",5)=0"
"RTN","PSODIR",18,0)
 S:$G(PSORX("PROVIDER NAME"))]"" DIC("B")=PSORX("PROVIDER NAME")
"RTN","PSODIR",19,0)
 D ^DIC K DIC
"RTN","PSODIR",20,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PROVX
"RTN","PSODIR",21,0)
 I $D(DTOUT)!$D(DUOUT) S PSODIR("DFLG")=1 G PROVX
"RTN","PSODIR",22,0)
 I '$G(SPEED),Y=-1 G PROVEN
"RTN","PSODIR",23,0)
 Q:$G(SPEED)&(Y=-1)
"RTN","PSODIR",24,0)
 ;PSO*7*211; ADD CHECK FOR DEA# AND VA#
"RTN","PSODIR",25,0)
 I $P($G(PSODIR("CS")),"^",1)!($D(CLOZPAT)) N DEAFLG S DEAFLG=0 D  G PROVEN:DEAFLG
"RTN","PSODIR",26,0)
 .I $$PATCH^XPDUTL("PSO*7.0*391") N NDEA,SDEA S SDEA=$$DRGSCH() S NDEA=$$SDEA^XUSER(0,+Y,SDEA) I $L($P(NDEA,"^"))<3 D
"RTN","PSODIR",27,0)
 ..I NDEA=2 W $C(7),!!,"Provider not authorized to write Federal Schedule "_+SDEA_" prescriptions.",! S DEAFLG=1 Q
"RTN","PSODIR",28,0)
 ..W $C(7),!!,"Provider must have a DEA# or VA# to write prescriptions for this drug.",! S DEAFLG=1
"RTN","PSODIR",29,0)
 .I '$L($P($G(^VA(200,+Y,"PS")),U,2)),'$L($P($G(^VA(200,+Y,"PS")),U,3)) W $C(7),!!,"Provider must have a DEA# or VA#"_$S($D(CLOZPAT):" to write prescriptions for clozapine.",1:""),! S DEAFLG=1
"RTN","PSODIR",30,0)
 ;PSO*7.0*391; Added check for DETOX#
"RTN","PSODIR",31,0)
 I $$PATCH^XPDUTL("PSO*7.0*391"),$$DETOX^PSSOPKI($G(PSODRUG("IEN"))),$$DETOX^XUSER(+Y)="" W $C(7),!!,"Provider must have a DETOX# to order this drug.",! G PROVEN
"RTN","PSODIR",32,0)
 I $D(CLOZPAT),'$D(^XUSEC("YSCL AUTHORIZED",+Y)) D  G PROVEN
"RTN","PSODIR",33,0)
 .W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSODIR",34,0)
 I '$G(PSODRUG("IEN")),'$G(PSORENW("DRUG IEN")) G NODRUG
"RTN","PSODIR",35,0)
NODRUG S PSODIR("PROVIDER")=+Y
"RTN","PSODIR",36,0)
 S (PSODIR("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P(Y,"^",2)
"RTN","PSODIR",37,0)
 I $G(PSODIR("OLD VAL"))'=+Y K PSODIR("GENERIC PROVIDER"),PSODIR("COSIGNING PROVIDER")
"RTN","PSODIR",38,0)
 I $G(PSODIR("OLD VAL"))'=$G(PSODIR("PROVIDER")),$P(Y,"^",2)="PROVIDER,OTHER"!($P(Y,"^",2)="PROVIDER,OUTSIDE") D GENERIC
"RTN","PSODIR",39,0)
 I $P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",7),$P(^("PS"),"^",8) D COSIGN
"RTN","PSODIR",40,0)
 I $G(PSODIR("COSIGNING PROVIDER")),'$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",7) K PSODIR("COSIGNING PROVIDER")
"RTN","PSODIR",41,0)
PROVX K X,Y
"RTN","PSODIR",42,0)
 Q
"RTN","PSODIR",43,0)
 ;
"RTN","PSODIR",44,0)
DRGSCH() ; determine the drug schedule
"RTN","PSODIR",45,0)
 N ND3,SCH
"RTN","PSODIR",46,0)
 S SCH="",ND3=$P($G(^PSDRUG(PSODRUG("IEN"),"ND")),"^",3) S:+ND3 SCH=$$GET1^DIQ(50.68,ND3,19,"I")
"RTN","PSODIR",47,0)
 I SCH'=""!($G(PSODRUG("DEA"))="") Q SCH
"RTN","PSODIR",48,0)
 I "^4^5^"[+PSODRUG("DEA") Q PSODRUG("DEA")
"RTN","PSODIR",49,0)
 Q $S($G(PSODRUG("DEA"))["A":+PSODRUG("DEA"),1:+PSODRUG("DEA")_"n")
"RTN","PSODIR",50,0)
 ;
"RTN","PSODIR",51,0)
GENERIC ;
"RTN","PSODIR",52,0)
 K DIR,DIC,PSODIR("GENERIC PROVIDER")
"RTN","PSODIR",53,0)
 S DIR(0)="52,30"
"RTN","PSODIR",54,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") GENERICX
"RTN","PSODIR",55,0)
 S PSODIR("GENERIC PROVIDER")=Y
"RTN","PSODIR",56,0)
GENERICX K X,Y
"RTN","PSODIR",57,0)
 Q
"RTN","PSODIR",58,0)
 ;
"RTN","PSODIR",59,0)
COSIGN ;
"RTN","PSODIR",60,0)
 K DIC
"RTN","PSODIR",61,0)
 I '$G(PSODIR("COSIGNING PROVIDER")),$P($G(RX3),"^",3) S PSODIR("COSIGNING PROVIDER")=$P(RX3,"^",3) G COSIGN1
"RTN","PSODIR",62,0)
 I $P($G(RX3),"^",3),$P($G(RX3),"^",3)'=$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8) D
"RTN","PSODIR",63,0)
 .W !!,"Previous Co-Signing Provider: "_$P(^VA(200,$P(RX3,"^",3),0),"^")
"RTN","PSODIR",64,0)
 .S PSODIR("COSIGNING PROVIDER")=$S($P(RX3,"^",3)'=PSODIR("COSIGNING PROVIDER"):PSODIR("COSIGNING PROVIDER"),1:$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8))
"RTN","PSODIR",65,0)
COSIGN1 S DIC(0)="QEAM",DIC="^VA(200,",DIC("B")=$S($G(PSODIR("COSIGNING PROVIDER")):$P(^VA(200,PSODIR("COSIGNING PROVIDER"),0),"^"),1:$P(^VA(200,PSODIR("PROVIDER"),"PS"),"^",8))
"RTN","PSODIR",66,0)
 S DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)"
"RTN","PSODIR",67,0)
 S DIC("W")="W ""     "",$P(^(""PS""),""^"",9)",DIC("S")=DIC("S")_",'$P(^(""PS""),""^"",7)"
"RTN","PSODIR",68,0)
 S DIC("A")="COSIGNING PROVIDER: " D ^DIC K DIC
"RTN","PSODIR",69,0)
 I $D(DTOUT)!$D(DUOUT) S PSODIR("DFLG")=1 G COSIGNX
"RTN","PSODIR",70,0)
 S:+Y>0 PSODIR("COSIGNING PROVIDER")=+Y G:Y<0 COSIGN
"RTN","PSODIR",71,0)
COSIGNX K X,Y
"RTN","PSODIR",72,0)
 Q
"RTN","PSODIR",73,0)
DOSE(PSODIR) ;add dosing info
"RTN","PSODIR",74,0)
 N PSODOSNW S PSODOSNW=1
"RTN","PSODIR",75,0)
 D DOSE1^PSOORED5(.PSODIR)
"RTN","PSODIR",76,0)
EX K PSODOSE,PSOSCH,DOSE,DOOR,SCH,VERB,NOUN,DOSEOR,ENT,PSORTE,DRUA,DIR,X,Y,DIRUT,RTE,ERTE,DD,INS1,SINS1
"RTN","PSODIR",77,0)
 Q
"RTN","PSODIR",78,0)
INS(PSODIR) ;patient instructions
"RTN","PSODIR",79,0)
 N DA K INS1,DD,DIR,DIRUT S D=0 F  S D=$O(PSODIR("SIG",D)) Q:'D  S DD=$G(DD)+1
"RTN","PSODIR",80,0)
 I $G(DD)=1 S PSODIR("INS")=$G(PSODIR("SIG",1)) G INSD
"RTN","PSODIR",81,0)
 ;PSO*7*275 remove check for PSOINSFL just check for multi line sig
"RTN","PSODIR",82,0)
 I $G(DD)>1 D  G EX
"RTN","PSODIR",83,0)
 .K ^TMP($J) S D=0 F  S D=$O(PSODIR("SIG",D)) Q:'D  S ^TMP($J,"SIG",D,0)=PSODIR("SIG",D)
"RTN","PSODIR",84,0)
 .S DWPK=2,DWLW=80,DIC="^TMP($J,""SIG""," D EN^DIWE K PSODIR("SIG")
"RTN","PSODIR",85,0)
 .S D=0 F  S D=$O(^TMP($J,"SIG",D)) Q:'D  S PSODIR("SIG",D)=^TMP($J,"SIG",D,0)
"RTN","PSODIR",86,0)
 .D EN^PSOFSIG(.PSODIR,1) K DWLW,D,DWPK,^TMP($J)
"RTN","PSODIR",87,0)
 I $G(PSOINSFL)=0 G INSD
"RTN","PSODIR",88,0)
 I $G(PSOFDR),$G(ORD),$P($G(^PS(52.41,+$G(ORD),"EXT")),"^")'="" G INSD
"RTN","PSODIR",89,0)
 I $G(PSODIR("INS"))']"",$G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S DIR("B")=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSODIR",90,0)
INSD S DIR(0)="52,114" S:$G(PSODIR("INS"))]"" DIR("B")=PSODIR("INS")
"RTN","PSODIR",91,0)
 D DIR G:$G(PSODIR("DFLG"))!(PSODIR("FIELD")) EX
"RTN","PSODIR",92,0)
 I X'="",X'="@" S PSODIR("INS")=Y D SIG^PSOHELP G INSD:'$D(X)
"RTN","PSODIR",93,0)
 I $G(INS1)]"" D EN^DDIOL($E(INS1,2,9999999)) S (PSODIR("SIG",1),PSODIR("SIG"))=$E(INS1,2,9999999)
"RTN","PSODIR",94,0)
 I X="@" K PSODIR("INS"),PSODIR("SIG")
"RTN","PSODIR",95,0)
 D EN^PSOFSIG(.PSODIR,1) I $O(SIG(0)) S SIGOK=1
"RTN","PSODIR",96,0)
 G EX
"RTN","PSODIR",97,0)
 Q
"RTN","PSODIR",98,0)
SINS(PSODIR) ;other lang. patient instructions
"RTN","PSODIR",99,0)
 K SINS1,DIR
"RTN","PSODIR",100,0)
 S DIR(0)="52,114.1" S:$G(PSODIR("SINS"))]"" DIR("B")=PSODIR("SINS")
"RTN","PSODIR",101,0)
 I $G(PSODIR("SINS"))']"",$G(^PS(50.7,PSODRUG("OI"),"INS1"))]"" S DIR("B")=^PS(50.7,PSODRUG("OI"),"INS1")
"RTN","PSODIR",102,0)
 D DIR G:$G(PSODIR("DFLG")) EX
"RTN","PSODIR",103,0)
 I X'="",X'="@" S PSODIR("SINS")=Y D SSIG^PSOHELP
"RTN","PSODIR",104,0)
 I $G(SINS1)]"" D EN^DDIOL($E(SINS1,2,9999999)) S PSODIR("SINS")=$E(SINS1,2,9999999)
"RTN","PSODIR",105,0)
 I X="@" K PSODIR("SINS")
"RTN","PSODIR",106,0)
 G EX
"RTN","PSODIR",107,0)
 Q
"RTN","PSODIR",108,0)
 ;
"RTN","PSODIR",109,0)
DIR ;
"RTN","PSODIR",110,0)
 S PSODIR("FIELD")=0
"RTN","PSODIR",111,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR",112,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR",113,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1 S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR",114,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP
"RTN","PSODIR",115,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT,PSOX
"RTN","PSODIR",116,0)
 Q
"RTN","PSODIR",117,0)
 ;
"RTN","PSODIR",118,0)
JUMP ;
"RTN","PSODIR",119,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR",120,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR",121,0)
 I Y=-1 S PSODIR("FIELD")=$G(PSODIR("FLD")) G JUMPX
"RTN","PSODIR",122,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR",123,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR",124,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR",125,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR",126,0)
JUMPX S X="^"_X
"RTN","PSODIR",127,0)
 Q
"RTN","PSODOSU2")
0^1^B105360523
"RTN","PSODOSU2",1,0)
PSODOSU2 ;BIR/RTR - Dose Check Utility routine continued ;11/18/08
"RTN","PSODOSU2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,372**;DEC 1997;Build 54
"RTN","PSODOSU2",3,0)
 ;
"RTN","PSODOSU2",4,0)
 ;Called from PSODOSUT.  The variable PSODTYPE is expected to be defined.
"RTN","PSODOSU2",5,0)
 ; PSODTYPE values can be N for dosing for new order, copy, and renews, E for edited and display of individual complex doses, and C for complex orders
"RTN","PSODOSU2",6,0)
 ;
"RTN","PSODOSU2",7,0)
EN ;new order, copy, renew, and verify orders
"RTN","PSODOSU2",8,0)
 N PSODLERW,PSODLERL,PSODLERS,PSODLERH,PSOCPXRR,PSODLWW,PSODOSER,PSONFRNF,PSOWMSG
"RTN","PSODOSU2",9,0)
 S (PSODLERF,PSODSEQ,PSODLWW)="" F  S PSODSEQ=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ)) Q:PSODSEQ=""!($G(PSORX("DFLG")))  S PSODLNN1=""  D  D HD
"RTN","PSODOSU2",10,0)
 .S:PSODTYPE'="N" PSODLQT=0 S PSOLASTS=PSODSEQ
"RTN","PSODOSU2",11,0)
 .I PSODTYPE="C" K PSOCPXRR
"RTN","PSODOSU2",12,0)
 .F  S PSODLNN1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) Q:PSODLNN1=""!($G(PSORX("DFLG")))  D
"RTN","PSODOSU2",13,0)
 ..S:PSODTYPE'="E" PSODLECT=0
"RTN","PSODOSU2",14,0)
 ..I PSODTYPE="E" Q:$P(PSODLNN1,";",4)'=PSODLXNT
"RTN","PSODOSU2",15,0)
 ..D ERROR
"RTN","PSODOSU2",16,0)
 ..D EXCEPT
"RTN","PSODOSU2",17,0)
 ..D MESSAGE
"RTN","PSODOSU2",18,0)
 .K PSODLWW
"RTN","PSODOSU2",19,0)
 Q
"RTN","PSODOSU2",20,0)
 ;
"RTN","PSODOSU2",21,0)
ERROR ;format and write dosing error
"RTN","PSODOSU2",22,0)
 I PSODTYPE'="E" S PSODLECT=0
"RTN","PSODOSU2",23,0)
 F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA)) Q:'PSODLERA!($G(PSORX("DFLG")))  D
"RTN","PSODOSU2",24,0)
 .S:PSODTYPE'="E" PSODLECT=PSODLECT+1
"RTN","PSODOSU2",25,0)
 .S:PSODTYPE'="N" PSODLQT=0
"RTN","PSODOSU2",26,0)
 .F PSODLERX="MSG","TEXT" S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA,PSODLERX)) D  K ^UTILITY($J,"W")
"RTN","PSODOSU2",27,0)
 ..S PSODLERZ=0 Q:PSODLERB=""
"RTN","PSODOSU2",28,0)
 ..I PSODTYPE="C"&(PSOCPXB>3) D ERRCOM Q
"RTN","PSODOSU2",29,0)
 ..I PSODTYPE="E" D ERREDIT Q
"RTN","PSODOSU2",30,0)
 ..I PSODTYPE="N"&(PSOCPXB>3) D ERRNEW Q
"RTN","PSODOSU2",31,0)
 ..Q:PSODTYPE="C"&(PSOCPXB<4)
"RTN","PSODOSU2",32,0)
 ..D ERRNEW
"RTN","PSODOSU2",33,0)
 Q
"RTN","PSODOSU2",34,0)
 ;
"RTN","PSODOSU2",35,0)
ERRCOM ;write dosing errors for complex dose summary after accept of an order
"RTN","PSODOSU2",36,0)
 I PSOCPXC D HD I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD
"RTN","PSODOSU2",37,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",38,0)
 S PSODLERF=1 D:PSOCPXC HD I PSODLERZ W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",39,0)
 ;S PSODLERR=1
"RTN","PSODOSU2",40,0)
 D:PSOCPXC
"RTN","PSODOSU2",41,0)
 .D HD W:'PSODLQT&(PSODLECT>1) !
"RTN","PSODOSU2",42,0)
 .N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF
"RTN","PSODOSU2",43,0)
 .D:PSOCPXC HD D:'PSOCPXF&(PSOCPXC) 
"RTN","PSODOSU2",44,0)
 ..Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",45,0)
 .D:PSOCPXC HD S PSOCPXG=$P(PSODLNN1,";",4) I PSOCPXC&('$G(PSOCPXRR(PSOCPXG))) D SUB^PSODOSUT W:'PSODLQT&('PSODLERZ) !
"RTN","PSODOSU2",46,0)
 .D:PSOCPXC HD W:'PSODLQT&(PSODLECT'>1)&(PSODLERX="TEXT")&(PSOCPXC) ! S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",47,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT) ! D
"RTN","PSODOSU2",48,0)
 ..D:PSOCPXC HD W:'$G(PSODLQT) $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR)=1 D SFD
"RTN","PSODOSU2",49,0)
 .S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",50,0)
 Q
"RTN","PSODOSU2",51,0)
 ;
"RTN","PSODOSU2",52,0)
ERREDIT ;write dosing errors for edits or display during complex dose entry
"RTN","PSODOSU2",53,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT !
"RTN","PSODOSU2",54,0)
 D HD I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD I 'PSODLERF W:'PSODLQT !
"RTN","PSODOSU2",55,0)
 S PSODLERF=1 D HD I PSODLERZ W:'PSODLQT !
"RTN","PSODOSU2",56,0)
 ;S PSODLERR=1
"RTN","PSODOSU2",57,0)
 D HD W:'PSODLQT !
"RTN","PSODOSU2",58,0)
 N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",59,0)
 S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD D
"RTN","PSODOSU2",60,0)
 .W:'PSODLQT $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR)=1 D SFD
"RTN","PSODOSU2",61,0)
 S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",62,0)
 Q
"RTN","PSODOSU2",63,0)
 ;
"RTN","PSODOSU2",64,0)
ERRNEW ;write dosing errors for finish, new, copy, renewal and verify
"RTN","PSODOSU2",65,0)
 D HD I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD
"RTN","PSODOSU2",66,0)
 I $L(PSODLERB)>76&(PSOCPXB>1)  S PSODLERL=1
"RTN","PSODOSU2",67,0)
 I 'PSODLERF,PSOCPXB<4 W:'PSODLQT !
"RTN","PSODOSU2",68,0)
 S PSODLERF=1 D HD I PSODLERZ W:'PSODLQT !
"RTN","PSODOSU2",69,0)
 ;S PSODLERR=1
"RTN","PSODOSU2",70,0)
 D HD W:'PSODLQT&(PSODLECT>1) ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF
"RTN","PSODOSU2",71,0)
 D:PSOCPXC HD D:'PSOCPXF&(PSOCPXC)
"RTN","PSODOSU2",72,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",73,0)
 D HD S PSOCPXG=$P(PSODLNN1,";",4) I '$G(PSOCPXRR(PSOCPXG))&(PSOCPXB>1) D SUB^PSODOSUT W:'PSODLQT&('PSODLERZ) !
"RTN","PSODOSU2",74,0)
 D HD W:'PSODLQT&(PSODLECT'>1)&(PSODLERX="TEXT") ! S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",75,0)
 S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD D
"RTN","PSODOSU2",76,0)
 .W:'PSODLQT $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLERR,PSODOSER,PSODLEXR)=1 D SFD
"RTN","PSODOSU2",77,0)
 S PSOLASTD(PSOLASTS)=1,PSONFRNF=1
"RTN","PSODOSU2",78,0)
 Q
"RTN","PSODOSU2",79,0)
 ;
"RTN","PSODOSU2",80,0)
SFD ;
"RTN","PSODOSU2",81,0)
 S PSODELXF=1 S:PSODLERX="TEXT" PSODLERZ=1
"RTN","PSODOSU2",82,0)
 Q
"RTN","PSODOSU2",83,0)
 ;
"RTN","PSODOSU2",84,0)
EXCEPT ;format and write exceptions
"RTN","PSODOSU2",85,0)
 I PSODTYPE="E" S (PSODLERZ)=0
"RTN","PSODOSU2",86,0)
 I $G(PSODOSER) K PSODOSER  ;line feed between error and exceptions
"RTN","PSODOSU2",87,0)
 D EXCEPT^PSODOSUT
"RTN","PSODOSU2",88,0)
 I PSODTYPE="N" D HD W:PSODLERF&('PSODLQT)&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS")))&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE"))) ! S PSODLERZ=0
"RTN","PSODOSU2",89,0)
 I PSODTYPE="C"  D:PSOCPXC HD W:PSODLERF&(PSOCPXC)&('PSODLQT)&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS")))&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE")))&('$G(PSODLWW)) ! S (PSODLERZ,PSODLESM)=0
"RTN","PSODOSU2",90,0)
 F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) Q:'PSODLERA  D
"RTN","PSODOSU2",91,0)
 .S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA))
"RTN","PSODOSU2",92,0)
 .I PSODTYPE="N" D SBAD^PSODOSUT
"RTN","PSODOSU2",93,0)
 .I PSODTYPE="E"!(PSODTYPE="C") D SBAD^PSODOSUT:PSODLERB'=""
"RTN","PSODOSU2",94,0)
 .Q:PSODLERB=""  I PSODTYPE'="C" D HD
"RTN","PSODOSU2",95,0)
 . N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S PSODLEXR=0
"RTN","PSODOSU2",96,0)
 .S (PSODLERF,PSODLALZ)=1
"RTN","PSODOSU2",97,0)
 .;write exceptions for new, copy, renew, verify
"RTN","PSODOSU2",98,0)
 .I PSODTYPE="N" D  Q
"RTN","PSODOSU2",99,0)
 ..D HD I 'PSOCPXF&(PSOCPXC) D
"RTN","PSODOSU2",100,0)
 ...Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",101,0)
 ..I 'PSODLERF W:'PSODLQT&('$G(PSODLWW)) ! D HD S PSODLWW=0
"RTN","PSODOSU2",102,0)
 ..S PSOCPXG=$P(PSODLNN1,";",4)
"RTN","PSODOSU2",103,0)
 ..I '$G(PSOCPXRR(PSOCPXG)),PSOCPXB>1 W:'PSODLQT&(PSODLERZ) ! D SUB^PSODOSUT
"RTN","PSODOSU2",104,0)
 ..D HD W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",105,0)
 ..D WRITEXC
"RTN","PSODOSU2",106,0)
 .;write dosing exceptions for edits or display during complex dose entry
"RTN","PSODOSU2",107,0)
 .I PSODTYPE="E" D
"RTN","PSODOSU2",108,0)
 ..I PSODLERB["please complete a manual check for appropriate Dosing" S PSODCONT=1
"RTN","PSODOSU2",109,0)
 ..D HD W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",110,0)
 ..S DIWL=1,DIWR=76 K ^UTILITY($J,"W")
"RTN","PSODOSU2",111,0)
 ..D WRITEXC
"RTN","PSODOSU2",112,0)
 .;write exceptions for complex orders
"RTN","PSODOSU2",113,0)
 .I PSODTYPE="C"&(PSOCPXB>3) D
"RTN","PSODOSU2",114,0)
 ..D:PSOCPXC HD I 'PSODLERF&('$G(PSODLWW)) W:'PSODLQT&(PSOCPXC) !
"RTN","PSODOSU2",115,0)
 ..D:PSOCPXC
"RTN","PSODOSU2",116,0)
 ...D HD I 'PSOCPXF&(PSOCPXC) D
"RTN","PSODOSU2",117,0)
 ....Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",118,0)
 ...S PSOCPXG=$P(PSODLNN1,";",4) I PSOCPXC&('$G(PSOCPXRR(PSOCPXG))) D HD W:'PSODLQT&(PSOCPXC)&(PSODLESM)&('$G(PSODLWW)) ! D SUB^PSODOSUT
"RTN","PSODOSU2",119,0)
 ...S PSODLESM=1 D HD W:'PSODLQT&('$G(PSODLWW)) !
"RTN","PSODOSU2",120,0)
 ...D:PSOCPXC WRITEXC
"RTN","PSODOSU2",121,0)
 Q
"RTN","PSODOSU2",122,0)
 ;
"RTN","PSODOSU2",123,0)
WRITEXC ;format and write exception messages to the screen
"RTN","PSODOSU2",124,0)
 S PSODLWW=0,DIWL=4,DIWR=76 K ^UTILITY($J,"W")
"RTN","PSODOSU2",125,0)
 I PSODLERB["Range Check Error Summary" S PSODLERS=1 I PSODLERZ W:'PSODLQT ! D HD
"RTN","PSODOSU2",126,0)
 I $G(PSODLERS),$L(PSODLERB)>76&($G(PSOCPXB)>1)  S PSODLERB=$E(PSODLERB,14,999),DIWR=76,DIWL=17,DIWF="W" S PSODLERW=1
"RTN","PSODOSU2",127,0)
 S X=PSODLERB D:'PSODLQT ^DIWP D HD
"RTN","PSODOSU2",128,0)
 I '$G(PSODLERW) S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D
"RTN","PSODOSU2",129,0)
 .W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSONFRNF,PSODELXF,PSODLERZ,PSODLEXR)=1
"RTN","PSODOSU2",130,0)
 I $G(PSODLERW)&('PSODLQT) D ^DIWW K PSODLERW,PSODLERL S PSODLWW=1 S PSOLASTD(PSOLASTS)=2
"RTN","PSODOSU2",131,0)
 K ^UTILITY($J,"W")
"RTN","PSODOSU2",132,0)
 Q
"RTN","PSODOSU2",133,0)
  ;
"RTN","PSODOSU2",134,0)
MESSAGE ;format and write messages
"RTN","PSODOSU2",135,0)
 ;S PSODLFLG=0
"RTN","PSODOSU2",136,0)
 ;I $G(PSODLALZ)&$G(PSOFOERR)&'$G(PSORENWD) W !
"RTN","PSODOSU2",137,0)
 I PSODTYPE="N",$$FEED^PSODOSUT D HD W:'PSODLQT !
"RTN","PSODOSU2",138,0)
 I $G(PSODLERZ)&('PSODLQT) W !  ;line feed for transition between exceptions to messages
"RTN","PSODOSU2",139,0)
 I PSODTYPE="C" I $$FEED^PSODOSUT&(PSOCPXC) D HD W:'PSODLQT !
"RTN","PSODOSU2",140,0)
 S PSODLPL="" F  S PSODLPL=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL)) Q:PSODLPL=""  D
"RTN","PSODOSU2",141,0)
 .F PSODLP1=0:0 S PSODLP1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1)) Q:'PSODLP1  D
"RTN","PSODOSU2",142,0)
 ..I PSODTYPE'="E",PSODLPL="3_GENERAL" S PSODLINS=1 D GENERAL Q
"RTN","PSODOSU2",143,0)
 ..S PSODLMSG=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1))
"RTN","PSODOSU2",144,0)
 ..Q:PSODLMSG=""
"RTN","PSODOSU2",145,0)
 ..I 'PSODLERF W:'PSODLQT&('$G(PSODLWW)) ! D HD
"RTN","PSODOSU2",146,0)
 ..S PSODLERF=1
"RTN","PSODOSU2",147,0)
 ..I PSODTYPE'="C" D HD I '$G(PSODLFLG) W:'PSODLQT&('$G(PSODLWW)) !
"RTN","PSODOSU2",148,0)
 ..I PSODTYPE="C" D  Q:'PSODLQT&(PSOCPXC)&(PSODLESM)  I PSOCPXF&(PSOCPXC) K PSODAILY
"RTN","PSODOSU2",149,0)
 ...D:PSOCPXC HD I '$G(PSODLFLG) W:'PSODLQT&(PSOCPXC)&(PSOCPXF)&('$G(PSODLWW)) !
"RTN","PSODOSU2",150,0)
 ...S PSODLFLG=1 S PSODLEXR=0
"RTN","PSODOSU2",151,0)
 ..I PSODTYPE'="E" S PSODLEXR=0
"RTN","PSODOSU2",152,0)
 ..S PSODLFLG=1 S:PSODLPL="1_SINGLE" PSODLINS=1 S:PSODLPL="2_RANGE" PSODLINR=1
"RTN","PSODOSU2",153,0)
 ..I PSODTYPE="N"  S PSODLFLG=1 D MSGN
"RTN","PSODOSU2",154,0)
 ..I PSODTYPE="E" S PSODLFLG=1 D WRITMSG
"RTN","PSODOSU2",155,0)
 ..I PSODTYPE="C"&(PSOCPXB>3) D MSGC
"RTN","PSODOSU2",156,0)
 Q
"RTN","PSODOSU2",157,0)
 ;
"RTN","PSODOSU2",158,0)
MSGN ;write dosing message for new, copy, renew, and verify
"RTN","PSODOSU2",159,0)
 I 'PSOCPXF&(PSOCPXC)&($G(PSOCPXB)>3) S PSOCPXG=$P(PSODLNN1,";",4) D  K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",160,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",161,0)
 S PSOCPXG=$P(PSODLNN1,";",4) D HD D:'$G(PSOCPXRR(PSOCPXG))&(PSOCPXB>1) SUB^PSODOSUT D
"RTN","PSODOSU2",162,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSU2",163,0)
 .I PSODLPL="2_RANGE",'$G(PSODAILY) D DAILY^PSODOSUT I PSOCPXG'=PSOCPXB K PSODAILY
"RTN","PSODOSU2",164,0)
 .D HD,WRITMSG,HD
"RTN","PSODOSU2",165,0)
 .;I 'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W !
"RTN","PSODOSU2",166,0)
 Q
"RTN","PSODOSU2",167,0)
 ;
"RTN","PSODOSU2",168,0)
MSGC ;write dosing message for edits  or display during complex dose entry
"RTN","PSODOSU2",169,0)
 Q:'PSODLQT&(PSOCPXC)&(PSODLESM)  I PSOCPXF&(PSOCPXC) K PSODAILY
"RTN","PSODOSU2",170,0)
 D:PSOCPXC HD
"RTN","PSODOSU2",171,0)
 I 'PSOCPXF&(PSOCPXC) S PSOCPXG=$P(PSODLNN1,";",4) D  K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",172,0)
 .Q:$G(PSORENWD)&(PSOCPXB<4)  D SUMM^PSODOSUT
"RTN","PSODOSU2",173,0)
 I PSOCPXC S PSOCPXG=$P(PSODLNN1,";",4) D HD D
"RTN","PSODOSU2",174,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSU2",175,0)
 .I '$G(PSOCPXRR(PSOCPXG))&('$G(PSOCPXH)) D SUB^PSODOSUT I $G(PSOCOPY)!($G(PSORENW)) S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSU2",176,0)
 .I PSODLPL="2_RANGE"&PSODLINR&'$G(PSODAILY) D DAILY^PSODOSUT
"RTN","PSODOSU2",177,0)
 .D WRITMSG
"RTN","PSODOSU2",178,0)
 Q
"RTN","PSODOSU2",179,0)
 ;
"RTN","PSODOSU2",180,0)
WRITMSG ;
"RTN","PSODOSU2",181,0)
 W:'PSODLQT&('$G(PSODLWW)) ! S PSODLWW=0
"RTN","PSODOSU2",182,0)
 N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSU2",183,0)
 S PSODELXF=0
"RTN","PSODOSU2",184,0)
 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D
"RTN","PSODOSU2",185,0)
 .D HD W:PSODELXF&('PSODLQT) ! W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODLFLG,PSODELXF,PSONFRNF,PSOWMSG,PSODLEXR)=1
"RTN","PSODOSU2",186,0)
 K ^UTILITY($J,"W") D HD
"RTN","PSODOSU2",187,0)
 I PSODTYPE="E",'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5) W !
"RTN","PSODOSU2",188,0)
 I PSODTYPE="C"!(PSODTYPE="N"),'PSODLQT D
"RTN","PSODOSU2",189,0)
 .D HD S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W ! S PSOLASTD(PSOLASTS)=3
"RTN","PSODOSU2",190,0)
 Q
"RTN","PSODOSU2",191,0)
 ;
"RTN","PSODOSU2",192,0)
GENERAL ;general dosing range information
"RTN","PSODOSU2",193,0)
 N PSOGENF,PSODLERC,PSODLP2
"RTN","PSODOSU2",194,0)
 F PSODLP2=0:0 S PSODLP2=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1,PSODLP2)) Q:'PSODLP2!($G(PSORX("DFLG")))  D
"RTN","PSODOSU2",195,0)
 .S PSODLERC="",PSODLERC=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1,PSODLP2))
"RTN","PSODOSU2",196,0)
 .Q:PSODLERC=""
"RTN","PSODOSU2",197,0)
 .D HD ;I 'PSODLQT&('$G(PSOEDIT))&('$G(PSONEW)) W ! S PSOGENF=1  ;copied order
"RTN","PSODOSU2",198,0)
 .I 'PSODLQT,'$G(PSOEDIT) W ! S PSOGENF=1
"RTN","PSODOSU2",199,0)
 .N X,DIWL,DIWR,DIWF,DIWL,PSODELXR,PSODELXF S PSODLEXR=1
"RTN","PSODOSU2",200,0)
 .S DIWL=4,DIWR=76 K ^UTILITY($J,"W")
"RTN","PSODOSU2",201,0)
 .S X=PSODLERC D ^DIWP
"RTN","PSODOSU2",202,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODELXF,PSODLERZ,PSONFRNF)=1
"RTN","PSODOSU2",203,0)
 .W:$G(PSOEDIT) ! S PSOLASTD(PSOLASTS)=3
"RTN","PSODOSU2",204,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSU2",205,0)
 .W !
"RTN","PSODOSU2",206,0)
 Q
"RTN","PSODOSU2",207,0)
 ;
"RTN","PSODOSU2",208,0)
HD ;
"RTN","PSODOSU2",209,0)
 S:'$G(PSODLQT) PSODLQT=""
"RTN","PSODOSU2",210,0)
 I PSODLQT!(($Y+3)<IOSL)!($G(PSORX("DFLG"))) Q
"RTN","PSODOSU2",211,0)
 W:$G(PSORENWD) !
"RTN","PSODOSU2",212,0)
HD2 ;
"RTN","PSODOSU2",213,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSU2",214,0)
 K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR I 'Y!($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODOSU2",215,0)
 I 'Y S PSODLQT=1 Q
"RTN","PSODOSU2",216,0)
 W @IOF W !
"RTN","PSODOSU2",217,0)
 Q
"RTN","PSODOSU2",218,0)
 ;
"RTN","PSODOSUN")
0^5^B80758281
"RTN","PSODOSUN",1,0)
PSODOSUN ;BIR/RTR - Dose Check Utility routine ;11/18/08
"RTN","PSODOSUN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,379,372**;DEC 1997;Build 54
"RTN","PSODOSUN",3,0)
 ;
"RTN","PSODOSUN",4,0)
DOSE() ;Write Dose output for renew, finish, copy, etc.
"RTN","PSODOSUN",5,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,PSODLFLG,PSODLALZ,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1,PSODLOFF
"RTN","PSODOSUN",6,0)
 N PSODLNN1,PSODLERR,PSODLERX,PSODLQT,PSOCPXG,PSOCPXRR,PSODLEXR,PSODELNX,PSODLECT,PSOCPXF,PSODTYPE,PSOCPXC,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",7,0)
 S (PSODLERF,PSODLERZ,PSODLALZ,PSODLINS,PSODLINR,PSODLERR,PSODLQT,PSOCPXG,PSOCPXF,PSOLASTS,PSOQTOUT,PSOEDOUT,PSODLOFF)=0,PSODTYPE="N",PSOCPXC=1
"RTN","PSODOSUN",8,0)
 I $G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",9,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",10,0)
 W:$G(PSOEDIT)!$G(PSOCOPY)!($G(PSOFOERR)) @IOF I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G END
"RTN","PSODOSUN",11,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",12,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",13,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",14,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",15,0)
 ;PSOCPXB = Number of Dosing Seq
"RTN","PSODOSUN",16,0)
 S PSODLQT=0 K PSOCPXRR
"RTN","PSODOSUN",17,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",18,0)
END ;
"RTN","PSODOSUN",19,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",20,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",21,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",22,0)
 K PSODAILY,DIR,Y,PSODOSEX
"RTN","PSODOSUN",23,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",24,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",25,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",26,0)
 .S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",27,0)
 I '$G(PSODLINS)&'$G(PSODLINR) Q 0
"RTN","PSODOSUN",28,0)
 I '$D(^XUSEC("PSORPH",DUZ)) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",29,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",30,0)
 S DIR("A")=$$GETGN^PSODOSUN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",31,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",32,0)
 D ^DIR K DIR
"RTN","PSODOSUN",33,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",34,0)
 I Y=0 Q 3_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")  ;need to know if user cancelled or not
"RTN","PSODOSUN",35,0)
 K PSODOSEX
"RTN","PSODOSUN",36,0)
 D SIG^XUSESIG I $G(X1)="" Q 1
"RTN","PSODOSUN",37,0)
END2 ;
"RTN","PSODOSUN",38,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",39,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",40,0)
 ;
"RTN","PSODOSUN",41,0)
EVAL(PSODLINS,PSODLINR) ;
"RTN","PSODOSUN",42,0)
 Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",43,0)
 ;
"RTN","PSODOSUN",44,0)
DOSEX(PSODLXNT) ;Write Dose exceptions for order entry/edit
"RTN","PSODOSUN",45,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",46,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODELNX,PSODTYPE,PSODCONT,PSODSEQ,PSODOSX,PSODLOFF
"RTN","PSODOSUN",47,0)
 W @IOF S (PSODLERF,PSODLERZ,PSODLALZ,PSODLINS,PSODLINR,PSODLQT,PSODCONT,PSODLOFF,PSODLERR,PSODLFLG)=0,PSODTYPE="E"
"RTN","PSODOSUN",48,0)
 I PSOCPXB>3,$G(PSORXED)&$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",49,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 D  S PSODLFLG=0,PSODLOFF=1 G ENDX
"RTN","PSODOSUN",50,0)
 .D HD N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",51,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",52,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",53,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",54,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",55,0)
ENDX ;
"RTN","PSODOSUN",56,0)
 S PSODOSX=1
"RTN","PSODOSUN",57,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",58,0)
 K PSOCPXRR
"RTN","PSODOSUN",59,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",60,0)
 ;
"RTN","PSODOSUN",61,0)
 ;This "return to continue" occurs after the last dosing sequence for a complex order with 4 or more dosing sequences during an edit when finishing, placing a new order, copy or edit
"RTN","PSODOSUN",62,0)
 ;
"RTN","PSODOSUN",63,0)
 I '$G(PSOCKCON)&($G(PSOFOERR)) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",64,0)
 .Q:($G(PSODLFLG))&$D(^XUSEC("PSORPH",DUZ))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",65,0)
 .D RETURN
"RTN","PSODOSUN",66,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",67,0)
 ;
"RTN","PSODOSUN",68,0)
 I '$G(PSOFOERR) D  I $G(PSOQTOUT) Q 0
"RTN","PSODOSUN",69,0)
 .Q:$G(PSODLFLG)&$D(^XUSEC("PSORPH",DUZ))
"RTN","PSODOSUN",70,0)
 .I '$G(PSOEDIT) Q:$G(PSODOSNW)&'$G(PSOCPXD)&'$G(PSOCOPY)
"RTN","PSODOSUN",71,0)
 .Q:($G(PSOCOPY)!$G(PSOEDIT))&'$G(PSOCPXV)
"RTN","PSODOSUN",72,0)
 .Q:PSOCPXB>3&$G(PSOCPXV)
"RTN","PSODOSUN",73,0)
 .D RETURN
"RTN","PSODOSUN",74,0)
 Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 1
"RTN","PSODOSUN",75,0)
 ;
"RTN","PSODOSUN",76,0)
 I '$G(PSODLFLG) W !
"RTN","PSODOSUN",77,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR)),$G(PSODLFLG) Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",78,0)
 I 'PSODCONT Q:$G(PSOCPXV) 0
"RTN","PSODOSUN",79,0)
 I $G(PSODLBD4)&'$G(PSODLINS)&'$G(PSODLINR)&('$G(PSODLALZ)) S Y=1 G ENDX2
"RTN","PSODOSUN",80,0)
 K DIR,Y I $D(^XUSEC("PSORPH",DUZ)) S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",81,0)
ENDX2 ;
"RTN","PSODOSUN",82,0)
 K PSODOSEX
"RTN","PSODOSUN",83,0)
 W !
"RTN","PSODOSUN",84,0)
 Q 0
"RTN","PSODOSUN",85,0)
DOSEZ() ;Write Dose output summary for complex orders
"RTN","PSODOSUN",86,0)
 N PSOCPXF,PSOCPXC,PSOCPXRR,PSOCPXG,PSODLESM,PSODELNX,PSOCPXH,PSODTYPE,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODSEQ
"RTN","PSODOSUN",87,0)
 N PSODLINS,PSODLINR,PSODLERA,PSODLERB,PSODLERF,PSODLERZ,PSODLPL,PSODLP1,PSODLMSG,DIR,DUOUT,DTOUT,DIROUT,DIRUT,X,Y,X1
"RTN","PSODOSUN",88,0)
 N PSODLNN1,PSODLERX,PSODLQT,PSODLEXR,PSODLECT,PSODLOFF
"RTN","PSODOSUN",89,0)
 I '$G(PSOTOF) W @IOF
"RTN","PSODOSUN",90,0)
 S (PSODLERF,PSODLERZ,PSODLINS,PSODLINR,PSOCPXF,PSODLQT,PSOCPXH,PSOLASTS,PSOLASTD,PSOQTOUT,PSOEDOUT,PSODLOFF)=0,PSODTYPE="C",PSOCPXC=1
"RTN","PSODOSUN",91,0)
 I $G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) S PSOEDOUT=1
"RTN","PSODOSUN",92,0)
 I PSOCPXB>3,$G(PSOEDOUT) S PSOCPXC=0
"RTN","PSODOSUN",93,0)
 ;I PSOCPXB>3,$G(PSOEDDOS) S PSOCPXC=0  ;don't show summary before accept of order if edit
"RTN","PSODOSUN",94,0)
 I $G(PSOCPXB)<4 S PSOCPXC=0
"RTN","PSODOSUN",95,0)
 Q:$G(PSOCPXB)<4&'$G(PSOFOERR)&('$G(PSODLFLG)) 0
"RTN","PSODOSUN",96,0)
 I $P($G(^TMP($J,"PSOPDOSN","OUT",0)),"^")=-1 S PSODLQT=1 D  S PSODLFLG=0,PSODLOFF=1 G ENDZ
"RTN","PSODOSUN",97,0)
 .D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) !! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF D MESG
"RTN","PSODOSUN",98,0)
 .S X="Reason(s): "_$P(^TMP($J,"PSOPDOSN","OUT",0),"^",2),DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUN",99,0)
 .S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT)&(PSOCPXC) ! D:PSOCPXC HD W:'PSODLQT&(PSOCPXC) "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUN",100,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUN",101,0)
 D EN^PSODOSU2
"RTN","PSODOSUN",102,0)
ENDZ ;
"RTN","PSODOSUN",103,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",104,0)
 K PSODAILY
"RTN","PSODOSUN",105,0)
 I '$G(PSODLALZ),'$G(PSODLFLG),'$G(PSODLERR),'$G(PSODLOFF) Q 0
"RTN","PSODOSUN",106,0)
 D PROMPT Q:$G(PSORX("DFLG"))!$G(PSOQTOUT)!$G(PSODLQT) 0
"RTN","PSODOSUN",107,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",108,0)
 I '$G(PSOCPXF)&(PSOLASTS'=PSOCPXB),PSOEDOUT Q 0
"RTN","PSODOSUN",109,0)
 K PSODOSEX
"RTN","PSODOSUN",110,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT))!($G(PSRX("DFLG"))) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",111,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",112,0)
ENDZC ;
"RTN","PSODOSUN",113,0)
 I '$G(PSODLINS)&('$G(PSODLINR)) Q 0
"RTN","PSODOSUN",114,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(PSODLINS)!($G(PSODLINR))  Q 2_"^"_$$EVAL(PSODLINS,PSODLINR)
"RTN","PSODOSUN",115,0)
 G ENDZ2:$G(PSORX("EDIT"))!($G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4))
"RTN","PSODOSUN",116,0)
 W !!,"Do you want to Process or Cancel medication?" K DIR,Y S DIR("B")="P",DIR(0)="SA^1:PROCESS MEDICATION;0:CANCEL MEDICATION"
"RTN","PSODOSUN",117,0)
 S DIR("A")=$$GETGN(PSODRUG("IEN"))_": "  K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",118,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'C' to Cancel Medication"
"RTN","PSODOSUN",119,0)
 D ^DIR K DIR,PSODOSEX
"RTN","PSODOSUN",120,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1 Q 1
"RTN","PSODOSUN",121,0)
 D SIG^XUSESIG I $G(X1)="" Q 1
"RTN","PSODOSUN",122,0)
ENDZ2 ;
"RTN","PSODOSUN",123,0)
 I $G(PSORX("DFLG")) Q 0
"RTN","PSODOSUN",124,0)
 Q 2_"^"_$S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUN",125,0)
HD ;
"RTN","PSODOSUN",126,0)
 I PSODLQT!(($Y+5)'>IOSL) Q
"RTN","PSODOSUN",127,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUN",128,0)
 I $D(^XUSEC("PSORPH",DUZ)) D  I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODOSEX=1 S:$G(PSOREINS) PSOQUIT=1,PSORX("DFLG")=1 Q 1
"RTN","PSODOSUN",129,0)
 .K DIR,Y S DIR("B")="Y",DIR(0)="Y",DIR("A")="Do you want to Continue" D ^DIR K DIR
"RTN","PSODOSUN",130,0)
 W @IOF W !
"RTN","PSODOSUN",131,0)
 Q
"RTN","PSODOSUN",132,0)
MESG ;Write out System error heading
"RTN","PSODOSUN",133,0)
 I 'PSODLQT D HD W !,"Maximum Single Dose Check could not be performed:",!
"RTN","PSODOSUN",134,0)
 Q
"RTN","PSODOSUN",135,0)
GETGN(PSODRIEN) ;get generic name
"RTN","PSODOSUN",136,0)
 K ^TMP($J,"PSODOSUN GN")
"RTN","PSODOSUN",137,0)
 D DATA^PSS50(PSODRIEN,,,,,"PSODOSUN GN")
"RTN","PSODOSUN",138,0)
 Q $S($D(^TMP($J,"PSODOSUN GN",PSODRIEN,.01)):^TMP($J,"PSODOSUN GN",PSODRIEN,.01),1:"")
"RTN","PSODOSUN",139,0)
 ;
"RTN","PSODOSUN",140,0)
PROMPT ;
"RTN","PSODOSUN",141,0)
 ;assumes that a previous check was made to verify that errors, exceptions or messages are present
"RTN","PSODOSUN",142,0)
 ;if only warnings (exceptions/errors) then display "Press return to continue"; otherwise display "Do you want to continue" prompt.
"RTN","PSODOSUN",143,0)
 ;FINISH and BACKDOOR are separated below in order keep to a mininum the vast number of scenarios to be tested
"RTN","PSODOSUN",144,0)
 I $G(PSODLOFF)&(($Y+5)>IOSL) D RETURN Q
"RTN","PSODOSUN",145,0)
 I $G(PSOFOERR) D  ;FINISH
"RTN","PSODOSUN",146,0)
 .Q:$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))
"RTN","PSODOSUN",147,0)
 .I '$G(PSODLFLG) D
"RTN","PSODOSUN",148,0)
 ..Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",149,0)
 ..I '$G(PSORENWD) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",150,0)
 ..D RETURN
"RTN","PSODOSUN",151,0)
 ;
"RTN","PSODOSUN",152,0)
 I '$G(PSOFOERR)&'$G(PSODLFLG) D  ;BACKDOOR
"RTN","PSODOSUN",153,0)
 .Q:'$G(PSOEDOUT)&$D(^XUSEC("PSORPH",DUZ))&('$G(PSORENWD))  ;messages need the "do you want to continue" prompt instead but need to evaluate here so that it doesn't show up for edits
"RTN","PSODOSUN",154,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",155,0)
 .D RETURN
"RTN","PSODOSUN",156,0)
 ;
"RTN","PSODOSUN",157,0)
 I $G(PSODLFLG)&'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODOSUN",158,0)
 .I '$G(PSORENWD),('$D(^XUSEC("PSORPH",DUZ))&'$G(PSODCAN)) Q:PSOCPXB<4&('$G(PSODOSX))
"RTN","PSODOSUN",159,0)
 .D RETURN
"RTN","PSODOSUN",160,0)
 Q
"RTN","PSODOSUN",161,0)
 ;
"RTN","PSODOSUN",162,0)
RETURN ;
"RTN","PSODOSUN",163,0)
 ;I $G(PSORENWD) Q:($Y+15)<IOSL
"RTN","PSODOSUN",164,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR  S:'Y PSODLQT=1,PSOQTOUT=1,PSORX("DFLG")=1 W @IOF
"RTN","PSODOSUN",165,0)
 Q
"RTN","PSODOSUN",166,0)
 ;
"RTN","PSODOSUN",167,0)
HD3(PSOLINES,OVRRID) ;
"RTN","PSODOSUN",168,0)
 N X,Y,DTOUT,DUOUT,DIR
"RTN","PSODOSUN",169,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODOSUN",170,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)<IOSL) Q
"RTN","PSODOSUN",171,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR,PSOLINES,OVRRID
"RTN","PSODOSUN",172,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUN",173,0)
 W @IOF
"RTN","PSODOSUN",174,0)
 Q
"RTN","PSODOSUT")
0^2^B130396941
"RTN","PSODOSUT",1,0)
PSODOSUT ;BIR/RTR - PRE Dose Check Utility routine ;11/18/08
"RTN","PSODOSUT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,372**;DEC 1997;Build 54
"RTN","PSODOSUT",3,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSODOSUT",4,0)
 ;
"RTN","PSODOSUT",5,0)
 ;DOSE expect PSODLQT to be defined prior to calling it.
"RTN","PSODOSUT",6,0)
 ; PSODLQT=1 means no data will be written to the screen, but a value will be returned.
"RTN","PSODOSUT",7,0)
 ; PSODLQT=0 means data will be written to the screen and a value is returned 
"RTN","PSODOSUT",8,0)
 ;
"RTN","PSODOSUT",9,0)
 ;EVAL(PSODLINS,PSODLINR) ;
"RTN","PSODOSUT",10,0)
 ;Q $S($G(PSODLINS)&($G(PSODLINR)):"MAX SINGLE DOSE & DAILY DOSE RANGE",$G(PSODLINS):"MAX SINGLE DOSE",$G(PSODLINR):"DAILY DOSE RANGE",1:"UNKNOWN")
"RTN","PSODOSUT",11,0)
 ;
"RTN","PSODOSUT",12,0)
SUMM ;
"RTN","PSODOSUT",13,0)
 I 'PSODLQT W !,"   DOSING CHECK SUMMARY:",!!
"RTN","PSODOSUT",14,0)
 S PSOCPXF=1
"RTN","PSODOSUT",15,0)
 Q
"RTN","PSODOSUT",16,0)
 ;
"RTN","PSODOSUT",17,0)
SUB ;Write sub header; called from PSODOSUN
"RTN","PSODOSUT",18,0)
 D HD^PSODOSU2 I 'PSODLQT,'$G(PSODLEXR) W ! S PSODLEXR=0
"RTN","PSODOSUT",19,0)
 D HD^PSODOSU2
"RTN","PSODOSUT",20,0)
 I 'PSODLQT W "   DOSE SEQ "_PSOCPXG_":"
"RTN","PSODOSUT",21,0)
 S PSOCPXRR(PSOCPXG)=1
"RTN","PSODOSUT",22,0)
 Q
"RTN","PSODOSUT",23,0)
 ;
"RTN","PSODOSUT",24,0)
DAILY ;
"RTN","PSODOSUT",25,0)
 I 'PSODLQT W:'$G(PSORENW)!($G(PSOCOPY))!($G(PSORXED)) ! W "   DAILY DOSE RANGE WARNING:"
"RTN","PSODOSUT",26,0)
 S PSODAILY=1
"RTN","PSODOSUT",27,0)
 Q
"RTN","PSODOSUT",28,0)
 ;
"RTN","PSODOSUT",29,0)
COMPLEX ;called from DOSEZ^PSODOSUN
"RTN","PSODOSUT",30,0)
 I 'PSOCPXF&(PSOCPXC) S PSOCPXG=$P(PSODLNN1,";",4) D SUMM K PSODAILY S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSUT",31,0)
 I PSOCPXC S PSOCPXG=$P(PSODLNN1,";",4) D HD D
"RTN","PSODOSUT",32,0)
 .I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
"RTN","PSODOSUT",33,0)
 .I '$G(PSOCPXRR(PSOCPXG))&('$G(PSOCPXH)) D SUB I $G(PSOCOPY)!($G(PSORENW)) S:PSOCPXC&(PSOCPXG=PSOCPXB) PSOCPXH=1
"RTN","PSODOSUT",34,0)
 .I PSODLPL="2_RANGE"&PSODLINR&'$G(PSODAILY) D DAILY
"RTN","PSODOSUT",35,0)
 .D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODOSUT",36,0)
 .N PSODELXF,PSODELXR S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
"RTN","PSODOSUT",37,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUT",38,0)
 .D HD I 'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W !
"RTN","PSODOSUT",39,0)
 Q
"RTN","PSODOSUT",40,0)
 ;
"RTN","PSODOSUT",41,0)
HD ;
"RTN","PSODOSUT",42,0)
 I $G(PSODLQT)!(($Y+5)<IOSL)!($G(PSORX("DFLG"))) Q
"RTN","PSODOSUT",43,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODOSUT",44,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR I 'Y!($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSODLQT=1,PSONEW("DFLG")=1,PSORX("DFLG")=1 Q
"RTN","PSODOSUT",45,0)
 W @IOF
"RTN","PSODOSUT",46,0)
 Q
"RTN","PSODOSUT",47,0)
 ;
"RTN","PSODOSUT",48,0)
SFD ;
"RTN","PSODOSUT",49,0)
 S PSODELXF=1 S:PSODLERX="TEXT" PSODLERZ=1
"RTN","PSODOSUT",50,0)
 Q
"RTN","PSODOSUT",51,0)
 ;
"RTN","PSODOSUT",52,0)
SBAD ;Set Bad Drug flag just in case not set in enhanced check, possibly because Dosage edits are done first
"RTN","PSODOSUT",53,0)
 N PSODLBD1,PSODLBD3
"RTN","PSODOSUT",54,0)
 I PSODLERB["GCNSEQNO"!(PSODLERB["Drug not matched to NDF") D
"RTN","PSODOSUT",55,0)
 .S PSODLBD1=$O(^TMP($J,"PSOPDOSA","OUT","EXCEPTIONS","DOSE",PSODSEQ,PSODLNN1,"")) I PSODLBD1 D
"RTN","PSODOSUT",56,0)
 ..S PSODLBD3=$P($G(^TMP($J,"PSOPDOSA","OUT","EXCEPTIONS","DOSE",PSODSEQ,PSODLNN1,PSODLBD1)),"^",3) I PSODLBD3 S PSODRUG("BAD",PSODLBD3)=1
"RTN","PSODOSUT",57,0)
 Q
"RTN","PSODOSUT",58,0)
 ;
"RTN","PSODOSUT",59,0)
EXCEPT ;don't show "not matched to NDF" or "no GCNSEQNO" errors for dosing - when dosage is edited enhanced order checks are performed again so we don't want to display these type messages for dosing.
"RTN","PSODOSUT",60,0)
 N PSODLER1,PSODLER2
"RTN","PSODOSUT",61,0)
 F PSODLER1=0:0 S PSODLER1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1)) Q:'PSODLER1  D
"RTN","PSODOSUT",62,0)
 .S PSODLER2=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1))
"RTN","PSODOSUT",63,0)
 .I PSODLER2["Drug not matched to NDF"!(PSODLER2["GCNSEQNO") K ^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1)
"RTN","PSODOSUT",64,0)
 ;S PSODLER1=1 I '$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLER1)) K ^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",1)
"RTN","PSODOSUT",65,0)
 Q
"RTN","PSODOSUT",66,0)
 ;
"RTN","PSODOSUT",67,0)
FEED() ; Write Line feed after Exceptions if no message globals follow, and next order has no errors or exceptions, only a message
"RTN","PSODOSUT",68,0)
 I PSODLQT Q 0
"RTN","PSODOSUT",69,0)
 N PSODLNN2
"RTN","PSODOSUT",70,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE")) Q 0
"RTN","PSODOSUT",71,0)
 S PSODLNN2=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1))
"RTN","PSODOSUT",72,0)
 I PSODLNN2="" Q 0
"RTN","PSODOSUT",73,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN2,"ERROR")) Q 0
"RTN","PSODOSUT",74,0)
 I $D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN2,"EXCEPTIONS")) Q 0
"RTN","PSODOSUT",75,0)
 Q 1
"RTN","PSODOSUT",76,0)
 ;
"RTN","PSODOSUT",77,0)
DCHKN ;Called from PSOORNEW, PSOORNE1 & PSOORNEW; Dose Check for Copying an Order
"RTN","PSODOSUT",78,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSONEW("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",79,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSONEW,.PSODRUG)
"RTN","PSODOSUT",80,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA")
"RTN","PSODOSUT",81,0)
 I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",82,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",83,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1 Q
"RTN","PSODOSUT",84,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",85,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",86,0)
 ;I +PSODLNVL=3 D CANCEL(PSONEW("OIRXN")) Q  ;CR2724
"RTN","PSODOSUT",87,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",88,0)
 Q
"RTN","PSODOSUT",89,0)
 ;
"RTN","PSODOSUT",90,0)
DCHKR ;Renewal Dose Check; Called from PSORENW0
"RTN","PSODOSUT",91,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSORENW("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",92,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORENW,.PSODRUG)
"RTN","PSODOSUT",93,0)
 S PSODLNVL=$$DOSE^PSODOSUN
"RTN","PSODOSUT",94,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1
"RTN","PSODOSUT",95,0)
 K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA") I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",96,0)
 D DOSIV
"RTN","PSODOSUT",97,0)
 Q
"RTN","PSODOSUT",98,0)
 ;
"RTN","PSODOSUT",99,0)
DCHKC ;Dose Check on reinstate; Called from PSOCAN2
"RTN","PSODOSUT",100,0)
 N PSODCAN
"RTN","PSODOSUT",101,0)
 I '$D(PSODRUG("IEN")) S:$D(PSORENW("OIRXN")) PSODRUG("IEN")=$$GET1^DIQ(52,PSORENW("OIRXN"),6,"I")
"RTN","PSODOSUT",102,0)
 S PSOCPXB=0 F PSOCPXA=0:0 S PSOCPXA=$O(^PSRX(PSORENW("OIRXN"),6,PSOCPXA)) Q:'PSOCPXA  I $P($G(^PSRX(PSORENW("OIRXN"),6,PSOCPXA,0)),"^")'="" S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",103,0)
 D RX^PSODOSCL(.PSODLBS1,PSORENW("OIRXN"))
"RTN","PSODOSUT",104,0)
 S PSODLNNN=PSORENW("OIRXN"),PSODCAN=1
"RTN","PSODOSUT",105,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN"),^TMP($J,"PSOPDOSA")
"RTN","PSODOSUT",106,0)
 I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",107,0)
 D DOSIV
"RTN","PSODOSUT",108,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1
"RTN","PSODOSUT",109,0)
 Q
"RTN","PSODOSUT",110,0)
 ;
"RTN","PSODOSUT",111,0)
DCHK() ;Dose check after entering Null at the conjunction prompt
"RTN","PSODOSUT",112,0)
 ;For complex Dosing, they will eventually enter null too, so change to call if it was not a complex order, and null was entered
"RTN","PSODOSUT",113,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF 0
"RTN","PSODOSUT",114,0)
 Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",115,0)
 ;D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",116,0)
 N PSODLNNN,PSODLENT,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSODLENT,PSOCPXA,PSOCPXV,PSOTOF,PSOCPXB
"RTN","PSODOSUT",117,0)
 ;Need to make sure Drug Name is what you set in the API
"RTN","PSODOSUT",118,0)
 ;Either pass in name here, or set in PSODOSCL to array name that PSSDSAPD uses, which is still the .01 of File 50
"RTN","PSODOSUT",119,0)
 I $$EXMT^PSSDSAPI(PSODRUG("IEN")) Q 0
"RTN","PSODOSUT",120,0)
 I $G(PSODRUG("BAD",PSODRUG("IEN"))) Q 0
"RTN","PSODOSUT",121,0)
 ;Currently only one prospective drug at a time for Outpatient Dose Check
"RTN","PSODOSUT",122,0)
 ;S PSODLNNN="O;1;PROSPECTIVE;1"
"RTN","PSODOSUT",123,0)
 K ^TMP("PSODOSF",$J)
"RTN","PSODOSUT",124,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",125,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORXED,.PSODRUG)
"RTN","PSODOSUT",126,0)
 S PSODLENT=ENT,PSOCPXV=1,PSOCPXB=0
"RTN","PSODOSUT",127,0)
 S PSOCPXB=0 F PSOCPXA=0:0 S PSOCPXA=$O(PSORXED("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",128,0)
 S PSODLNVL=$$DOSEX^PSODOSUN(PSODLENT) S PSOTOF=1 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^") ^TMP("PSODOSF",$J,0)=1
"RTN","PSODOSUT",129,0)
 I $G(PSOEDDOS) D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",130,0)
 I $P($G(PSODLNVL),"^")=1 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") Q 1
"RTN","PSODOSUT",131,0)
DCHK2 ;Finishing of a complex order
"RTN","PSODOSUT",132,0)
 N PSOCPXC,PSOCPXD
"RTN","PSODOSUT",133,0)
 K PSODLNVL
"RTN","PSODOSUT",134,0)
 S PSOCPXD=1 ;flag for MOCHA 2.0, used to not display enter to continue prompt after errors/exceptions list which displays just after last dose sequence.  MOCHA 2.0 does not display errors or exceptions.
"RTN","PSODOSUT",135,0)
 ;S (PSOCPXB)=0 ;setting PSOCPXB=0 makes dosing summery not display when cycling through individual doses of a complex order.  Dose summary should only show after accept of order.
"RTN","PSODOSUT",136,0)
 S PSODLNVL=$$DOSEZ^PSODOSUN K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN")
"RTN","PSODOSUT",137,0)
 I $G(PSOEDDOS) D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG")) 0
"RTN","PSODOSUT",138,0)
 I $P($G(PSODLNVL),"^")=1 Q 1
"RTN","PSODOSUT",139,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) W ! Q 0
"RTN","PSODOSUT",140,0)
 I '$G(PSODLNVL) Q 0
"RTN","PSODOSUT",141,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",142,0)
 I $D(PSORX("EDIT"))!($G(PSORXED)&$G(PSORXED)&$G(PSOEDDOS))!($G(PSOCOPY)&$G(PSODLBD4)) Q 0
"RTN","PSODOSUT",143,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",144,0)
 W !
"RTN","PSODOSUT",145,0)
 Q 0
"RTN","PSODOSUT",146,0)
 ;
"RTN","PSODOSUT",147,0)
DCHK1 ;Dose check after entering a value at the Conjunction prompt
"RTN","PSODOSUT",148,0)
 Q:$G(PSORX("DFLG"))!($G(PSODLQT))
"RTN","PSODOSUT",149,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF
"RTN","PSODOSUT",150,0)
 ;D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG"))
"RTN","PSODOSUT",151,0)
 N PSODLNNN,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSODLENT,PSOCPXB
"RTN","PSODOSUT",152,0)
 ;Need to make sure Drug Name is what you set in the API
"RTN","PSODOSUT",153,0)
 ;Either pass in name here, or set in PSODOSCL to array name that PSSDSAPD uses, which is still the .01 of File 50
"RTN","PSODOSUT",154,0)
 I $$EXMT^PSSDSAPI(PSODRUG("IEN")) Q
"RTN","PSODOSUT",155,0)
 I $G(PSODRUG("BAD",PSODRUG("IEN"))) Q
"RTN","PSODOSUT",156,0)
 ;Currently only one prospective drug at a time for Outpatient Dose Check
"RTN","PSODOSUT",157,0)
 ;S PSODLNNN="O;1;PROSPECTIVE;1"
"RTN","PSODOSUT",158,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",159,0)
 D FIN^PSODOSCL(.PSODLBS1,.PSORXED,.PSODRUG)
"RTN","PSODOSUT",160,0)
 S PSODLENT=ENT,PSOCPXB=0
"RTN","PSODOSUT",161,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(PSORXED("DOSE",PSOCPXA)) Q:'PSOCPXA  S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",162,0)
 S PSODLNVL=$$DOSEX^PSODOSUN(PSODLENT)
"RTN","PSODOSUT",163,0)
 D HD:(($Y+5)>IOSL) Q:$G(PSORX("DFLG"))
"RTN","PSODOSUT",164,0)
 K ^TMP($J,"PSOPDOSA") K ^TMP($J,"PSOPDOSN") I $P($G(PSODLNVL),"^")=1 S PSORXED("DFLG")=1 Q
"RTN","PSODOSUT",165,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",166,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) W ! Q
"RTN","PSODOSUT",167,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",168,0)
 I $$EN3^PSORXI(PSODLNVT) W !!,"Unable to log intervention, cannot find intervention type.",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",169,0)
 W !
"RTN","PSODOSUT",170,0)
 Q
"RTN","PSODOSUT",171,0)
 ;
"RTN","PSODOSUT",172,0)
CONVMSG(MESS) ;Convert DOSE CHECK message to numeric value for field 8 of ^PS(52.4
"RTN","PSODOSUT",173,0)
 ;For MOCHA 2.0, only returning "DOSAGE EXCEEDS MAX SINGLE DOSE" when a dosing error is present.
"RTN","PSODOSUT",174,0)
 N PSODOSF
"RTN","PSODOSUT",175,0)
 S MESS="DOSAGE EXCEEDS MAX SINGLE DOSE"
"RTN","PSODOSUT",176,0)
 S PSODOSF=$S(MESS="DOSAGE EXCEEDS MAX SINGLE DOSE":4,MESS="MAX SINGLE DOSE & DAILY DOSE RANGE":3,MESS="MAX SINGLE DOSE":2,MESS="DAILY DOSE RANGE":1,1:"")
"RTN","PSODOSUT",177,0)
 Q PSODOSF
"RTN","PSODOSUT",178,0)
 ;
"RTN","PSODOSUT",179,0)
DCHKV ;Dose check when verifying an order
"RTN","PSODOSUT",180,0)
 N PSODOSF,PSOLINE,PSOVERFL,PSOVCAN
"RTN","PSODOSUT",181,0)
 S PSOVERFL=1
"RTN","PSODOSUT",182,0)
 F PSOCPXA=0:0 S PSOCPXA=$O(^PSRX(PSONV,6,PSOCPXA)) Q:'PSOCPXA  I $P($G(^PSRX(PSONV,6,PSOCPXA,0)),"^")'="" S PSOCPXB=PSOCPXB+1
"RTN","PSODOSUT",183,0)
 D RX^PSODOSCL(.PSODLBS1,PSONV)
"RTN","PSODOSUT",184,0)
 S $P(PSOLINE,"-",79)="-"
"RTN","PSODOSUT",185,0)
 S PSODLNNN=PSONV
"RTN","PSODOSUT",186,0)
 S PSODLNVL=$$DOSE^PSODOSUN K ^TMP($J,"PSOPDOSN") K ^TMP($J,"PSOPDOSA") I $P($G(PSODLNVL),"^")=1 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",187,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2))
"RTN","PSODOSUT",188,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",189,0)
 I +PSODLNVL=3 D  Q:PSOVCAN
"RTN","PSODOSUT",190,0)
 . D SIG^XUSESIG I X1="" S (PSORX("DFLG"),PSVERFLG)=1 Q
"RTN","PSODOSUT",191,0)
 . D NOOR^PSOCAN4
"RTN","PSODOSUT",192,0)
 . I $G(DIRUT) D UPOUT^PSODGDG1,KILL^PSODGDG1 K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODOSUT",193,0)
 . S PSOVCAN=1
"RTN","PSODOSUT",194,0)
 . S DA=PSONV D RXV^PSODGDG1 S DA=PSONV D INV^PSODGDG1 S DA=PSONV D PSDEL^PSODGDG1,DEL^PSODGDG1
"RTN","PSODOSUT",195,0)
 . K DIK,LST,PSONOOR S PSVERFLG=1
"RTN","PSODOSUT",196,0)
 S PSODLNVT=$P(PSODLNVL,"^",2),PSODOSF=1
"RTN","PSODOSUT",197,0)
 I +PSODLNVL=3 S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",198,0)
 S DA=PSONV,RX=$G(^PSRX(PSONV,0)) D DOSIV  ;CRI^PSODGDG1
"RTN","PSODOSUT",199,0)
 Q
"RTN","PSODOSUT",200,0)
 ;
"RTN","PSODOSUT",201,0)
DOSIV ;DOSE INTERVENTION
"RTN","PSODOSUT",202,0)
 I PSOFROM="C",'$D(^XUSEC("PSORPH",DUZ)) Q
"RTN","PSODOSUT",203,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S:$P($G(PSODLNVL),"^")=2 ^TMP("PSODOSF",$J,0)=$$CONVMSG($P(PSODLNVL,"^",2)) Q
"RTN","PSODOSUT",204,0)
 I '$G(PSODLNVL) Q
"RTN","PSODOSUT",205,0)
 S PSODLNVT=$P(PSODLNVL,"^",2)
"RTN","PSODOSUT",206,0)
DOSIV1 ;
"RTN","PSODOSUT",207,0)
 I $$EN3^PSORXI(PSODLNVT) D
"RTN","PSODOSUT",208,0)
 . W !!,"Unable to log intervention, cannot find intervention type.",!
"RTN","PSODOSUT",209,0)
 . K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODOSUT",210,0)
 Q
"RTN","PSODOSUT",211,0)
 ;
"RTN","PSODOSUT",212,0)
CANCEL(PSONV) ;CR2724 -  where PSONV = RXIEN 
"RTN","PSODOSUT",213,0)
 D SIG^XUSESIG I X1="" S PSORX("DFLG")=1 Q
"RTN","PSODOSUT",214,0)
 D NOOR^PSOCAN4
"RTN","PSODOSUT",215,0)
 I $G(DIRUT) D UPOUT^PSODGDG1,KILL^PSODGDG1 K PSONORR,PSORX("INTERVENE") Q
"RTN","PSODOSUT",216,0)
 S DA=PSONV D INV^PSODGDG1 S DA=PSONV D PSDEL^PSODGDG1,DEL^PSODGDG1
"RTN","PSODOSUT",217,0)
 K DIK,LST,PSONOOR
"RTN","PSODOSUT",218,0)
 Q
"RTN","PSODOSUT",219,0)
 ;
"RTN","PSODOSUT",220,0)
DOSCK(PSOFROM,MSG) ;
"RTN","PSODOSUT",221,0)
 ;D HD
"RTN","PSODOSUT",222,0)
 N PSODONOF S PSODONOF="" D DOSEOFF Q:'+PSODONOF
"RTN","PSODOSUT",223,0)
 I $G(PSORX("DFLG"))!($G(PSODOSD)) S PSORX("DFLG")=1 K PSODOSD Q
"RTN","PSODOSUT",224,0)
 N PSODLNNN,PSODLNVL,PSODLNVT,X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT,PSODLBS1,PSOCPXA,PSOCPXB,PSOCPXC
"RTN","PSODOSUT",225,0)
 Q:$$EXMT^PSSDSAPI(PSODRUG("IEN"))
"RTN","PSODOSUT",226,0)
 Q:$G(PSODRUG("BAD",PSODRUG("IEN")))
"RTN","PSODOSUT",227,0)
 K ^TMP($J,"PSOPDOSN"),^TMP($J,"PSOPDOSA"),^TMP("PSODOSF",$J) S PSODLBS1(1)="PSOPDOSA",PSODLBS1(3)="PSOPDOSN"
"RTN","PSODOSUT",228,0)
 I ($D(DTOUT))!($D(DUOUT))!($G(DIRUT))!($G(PSODLQT)) K PSODLQT,DTOUT,DUOUT,DIRUT,PSORX("DFLG") Q
"RTN","PSODOSUT",229,0)
 ;D CLEAR^VALM1
"RTN","PSODOSUT",230,0)
 S PSOCPXB=0
"RTN","PSODOSUT",231,0)
 I PSOFROM="V" D DCHKV Q  ;PSOVER1 - verification 
"RTN","PSODOSUT",232,0)
 I PSOFROM="N" D DCHKN Q  ;PSOORNE1 & PSOORNEW - new & copy
"RTN","PSODOSUT",233,0)
 I PSOFROM="R" D DCHKR Q  ;PSORENW0 - renewal
"RTN","PSODOSUT",234,0)
 I PSOFROM="C" D DCHKC Q  ;PSOCAN2 - cancel
"RTN","PSODOSUT",235,0)
 Q
"RTN","PSODOSUT",236,0)
 ;
"RTN","PSODOSUT",237,0)
RCONVMS(MESS) ;Convert DOSE CHECK from numeric to alpha
"RTN","PSODOSUT",238,0)
 N PSODOSF
"RTN","PSODOSUT",239,0)
 S MESS=4  ;For MOCHA 2.0, only returning "DOSAGE EXCEEDS MAX SINGLE DOSE" when a dosing error is present.
"RTN","PSODOSUT",240,0)
 S PSODOSF=$S(MESS=4:"DOSAGE EXCEEDS MAX SINGLE DOSE",MESS=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",MESS=2:"MAX SINGLE DOSE",MESS=1:"DAILY DOSE RANGE",1:"")
"RTN","PSODOSUT",241,0)
 Q PSODOSF
"RTN","PSODOSUT",242,0)
 ;
"RTN","PSODOSUT",243,0)
DOSEOFF ;
"RTN","PSODOSUT",244,0)
 S PSODONOF=$$DS^PSSDSAPI
"RTN","PSODOSUT",245,0)
DOSEOFF2 ;
"RTN","PSODOSUT",246,0)
 I $G(PSORX("DOSING OFF")),+PSODONOF K PSORX("DOSING OFF"),PSOREINF,PSOONOFC Q
"RTN","PSODOSUT",247,0)
 Q:+PSODONOF
"RTN","PSODOSUT",248,0)
 I ($G(PSOONOFC)!$G(PSOREINF)),'+PSODONOF S PSORX("DOSING OFF")=1  ;Reinstate news PSORX array so have to work around it
"RTN","PSODOSUT",249,0)
 Q:$G(PSORX("DOSING OFF"))  ;only display 'dosing off' message once per patient 
"RTN","PSODOSUT",250,0)
 N PSODOFFC
"RTN","PSODOSUT",251,0)
 I '+PSODONOF&($P(PSODONOF,"^",2)'="") D
"RTN","PSODOSUT",252,0)
 .S X=$P(PSODONOF,"^",2),DIWL=1,DIWR=73 K ^UTILITY($J,"W") D ^DIWP W !
"RTN","PSODOSUT",253,0)
 .S PSODOFFC=0 F PSODOFFC=0:0 S PSODOFFC=$O(^UTILITY($J,"W",DIWL,PSODOFFC)) Q:'PSODOFFC  W !?5,$G(^UTILITY($J,"W",DIWL,PSODOFFC,0))
"RTN","PSODOSUT",254,0)
 .N DIR,DIRUT,DUOUT,X,Y S DIR(0)="E"
"RTN","PSODOSUT",255,0)
 .S DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue"
"RTN","PSODOSUT",256,0)
 .W ! D ^DIR K DIRUT,DUOUT,DIR,X,Y W !
"RTN","PSODOSUT",257,0)
 .K ^UTILITY($J,"W")
"RTN","PSODOSUT",258,0)
 .S PSORX("DOSING OFF")=1 S:$G(PSOREINS) (PSOREINF,PSOONOFC)=1  ;set this flag to only display 'dosing off' message once per session. 
"RTN","PSODOSUT",259,0)
 Q
"RTN","PSOLBLD")
0^10^B29870176
"RTN","PSOLBLD",1,0)
PSOLBLD ;BHAM ISC/RTR - PRINTS LABEL ;4/14/93
"RTN","PSOLBLD",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**117,251,387,372**;DEC 1997;Build 54
"RTN","PSOLBLD",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOLBLD",4,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSOLBLD",5,0)
 S HOLDCOPY=COPIES
"RTN","PSOLBLD",6,0)
 N PSODOSEW,PSODRGI,PSOLINFD S (PSODOSEW,PSODRGI,PSOLINFD)=0
"RTN","PSOLBLD",7,0)
START ;
"RTN","PSOLBLD",8,0)
 K PSOSERV
"RTN","PSOLBLD",9,0)
 S COPIES=COPIES-1,Y=$P(^PSRX(RX,2),"^",6) X ^DD("DD") S EXPDT=Y,Y=$P(^PSRX(RX,0),"^",13) X ^DD("DD") S ISD=Y
"RTN","PSOLBLD",10,0)
 S Y=DATE X ^DD("DD") S DATE1=Y D NOW^%DTC S Y=% X ^DD("DD") S NOW=Y
"RTN","PSOLBLD",11,0)
 S:'$P($G(^PS(59,+$G(PSOSITE),1)),"^",28) TB1=38,TB2=50,TB3=83 S:$P($G(^PS(59,+$G(PSOSITE),1)),"^",28) TB1=54,TB2=66,TB3=102
"RTN","PSOLBLD",12,0)
 I '$D(^PS(52.4,RX,0)),$P(^PSRX(RX,"STA"),"^")=4 D UNKNOWN D  Q
"RTN","PSOLBLD",13,0)
 .I $P(PSOPAR,"^",31),$P($G(^PSRX(RX,"STA")),"^")=4 D BLANK W @IOF
"RTN","PSOLBLD",14,0)
L1 W !?TB3 W:$G(RXRP(RX)) "(REPRINT)" I '$G(RXRP(RX)) W $P(PS2,"^",2)," ","("_$P(RXY,"^",16)_"/"_$S(+$G(VRPH):VRPH,1:" ")_")"_" ",$P(NOW,":",1,2)
"RTN","PSOLBLD",15,0)
L2 W ! I ($P(^PSRX(RX,"STA"),"^")=4)!($D(^PSRX(RX,"DRI"))&('$G(RXF))&('$G(RXP))) W ?TB1,"PRESCRIPTION # "_RXN_" HAS"
"RTN","PSOLBLD",16,0)
 W ?TB3,RXN,"  ",DATE1,"  Fill ",RXF+1," of ",1+$P(RXY,"^",9)
"RTN","PSOLBLD",17,0)
 I ($P(^PSRX(RX,"STA"),"^")=4)!($D(^PSRX(RX,"DRI"))&('$G(RXF))&('$G(RXP))) W !?TB1,"CAUSED A DRUG-DRUG INTERACTION" S PSOLINFD=1
"RTN","PSOLBLD",18,0)
 W:'$G(PSOLINFD) ! S PSOLINFD=0 W ?TB3,PNM,"  ",SSNP S PSODRGI=1
"RTN","PSOLBLD",19,0)
 I ($P(^PSRX(RX,"STA"),"^")=4)!($D(^PSRX(RX,"DRI"))&('$G(RXF))&('$G(RXP))) W !?TB1,"WITH THE FOLLOWING PRESCRIPTION(S):" S PSOLINFD=1
"RTN","PSOLBLD",20,0)
 W:'$G(PSOLINFD) ! S PSOLINFD=0 W ?TB3,$S($G(OSGY(1))]"":OSGY(1),1:$G(SGY(1)))
"RTN","PSOLBLD",21,0)
L5 W !,?TB3,$S($G(OSGY(2))]"":OSGY(2),1:$G(SGY(2)))
"RTN","PSOLBLD",22,0)
 I $G(SGY(3))'="" F SSG=3:1 Q:$G(SGY(SSG))=""  W !,?TB3,$S($G(OSGY(SSG))]"":OSGY(SSG),1:$G(SGY(SSG)))
"RTN","PSOLBLD",23,0)
L6 I $D(^PS(52.4,RX,0)) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOLBLD",24,0)
 .S SER=SEV(X) S:$G(SER)=1 PSOSERV=1 W !?TB1,$P($G(^PSRX(RXX(X),0)),"^"),?TB2,$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")," INTERACTION",!?TB1,"  ",$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^") S:SER=1 PSODRGI=1
"RTN","PSOLBLD",25,0)
 I '$D(^PS(52.4,RX,0)),$D(^PSRX(RX,"DRI")) S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOLBLD",26,0)
 .S SER=SEV(X) W !,?TB1,$P($G(^PSRX(RXX(X),0)),"^"),?TB2,$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")," INTERACTION",!?TB1,"  ",$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^") S:SER=1 PSODRGI=1
"RTN","PSOLBLD",27,0)
 I $$DS^PSSDSAPI,($D(^PS(52.4,RX,1))) S T="",T=$P(^PS(52.4,RX,1),"^") D
"RTN","PSOLBLD",28,0)
 .S T=$$RCONVMS^PSODOSUT(T) W !!?TB1,T S:T>0 PSODOSEW=1
"RTN","PSOLBLD",29,0)
L7 W !
"RTN","PSOLBLD",30,0)
L8 W !,?TB1,"THIS PRESCRIPTION WAS ENTERED BY: ",?TB3,"Qty: "_$G(QTY),"   ",$G(PHYS)
"RTN","PSOLBLD",31,0)
L9 W !,?TB1,TECH,?TB3,"Tech__________RPh__________"
"RTN","PSOLBLD",32,0)
L10 W !,?TB1,"THIS PRESCRIPTION ",$S('$G(PSOSERV):"MAY REQUIRE",1:"REQUIRES"),?TB3,DRUG
"RTN","PSOLBLD",33,0)
L11 W !,?TB1,$S('$G(PSOSERV):"REVIEWING BY A PHARMACIST",1:"INTERVENTION BY A PHARMACIST"),?TB3,"Routing: "_$S("W"[$E(MW):MW,1:MW_" MAIL")
"RTN","PSOLBLD",34,0)
L12 W !,?TB3,"Days supply: ",$G(DAYS)," Cap: "_$S(PSCAP:"**NON-SFTY**",1:"SAFETY")
"RTN","PSOLBLD",35,0)
L13 W !,?TB3,"Isd: ",ISD," Exp: ",EXPDT
"RTN","PSOLBLD",36,0)
L14 W !,?TB3,"Last Fill: ",$G(PSOLASTF)
"RTN","PSOLBLD",37,0)
L15 W !,?TB3,"Pat. Stat ",PATST," Clinic: ",PSCLN
"RTN","PSOLBLD",38,0)
L16 W !,@IOF
"RTN","PSOLBLD",39,0)
 I COPIES>0 G START
"RTN","PSOLBLD",40,0)
 S COPIES=HOLDCOPY K HOLDCOPY
"RTN","PSOLBLD",41,0)
STORE ;LABEL PRINT NODE
"RTN","PSOLBLD",42,0)
 D NOW^%DTC S NOW=% K %,%H,%I I $G(RXF)="" S RXF=0 F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=I
"RTN","PSOLBLD",43,0)
 F IR=0 F FDA=0:0 S FDA=$O(^PSRX(RX,"L",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOLBLD",44,0)
 S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR,PSRXSET=""
"RTN","PSOLBLD",45,0)
 S PSRXSET=NOW_"^"_RXF_"^"_$S($G(PCOMX)]"":$G(PCOMX),1:"From RX number "_$P(^PSRX(RX,0),"^"))
"RTN","PSOLBLD",46,0)
 S PSRXSET=PSRXSET_$S(PSODRGI&(PSODOSEW)&$$DS^PSSDSAPI:" Drug-Drug interaction/dose warning",PSODRGI:" Drug-Drug interaction",PSODOSEW&$$DS^PSSDSAPI:" Dose Warning",1:"")_$S($G(RXRP(RX)):" (Reprint)",1:"")_"^"_PDUZ_"^1"
"RTN","PSOLBLD",47,0)
 S ^PSRX(RX,"L",IR,0)=PSRXSET K PSRXSET
"RTN","PSOLBLD",48,0)
 K:$D(^PS(52.4,RX,0)) RXF,IR,FDA,NOW,I
"RTN","PSOLBLD",49,0)
 I '$D(PSSPND),$P(PSOPAR,"^",18),$D(^PS(52.4,RX,0)) D CHCK2^PSOTRLBL
"RTN","PSOLBLD",50,0)
 I $P(PSOPAR,"^",31),$P($G(^PSRX(RX,"STA")),"^")=4 D BLANK W @IOF
"RTN","PSOLBLD",51,0)
END K:$D(^PS(52.4,RX,0)) PSCLN,DATE1,DRUG,RFLMSG,COPIES,DRUG,LMI,LINE,PS,PS1,PS2,INT,ISD,I1,MW,STATE,SIDE,SGY,PATST,PRTFL,PHYS,SGC,VRPH,NLWS,X1,X2,X,Y,TECH,EXPDT,NURSE,SEV,SCRIPT,RXX,SGY,SER,SSG,RXY,SIGPH,PS55,PS55X K TB1,TB2,TB3,PSOSERV
"RTN","PSOLBLD",52,0)
 Q
"RTN","PSOLBLD",53,0)
UNKNOWN W !!!,?TB1,"PRESCRIPTION # ",$P(^PSRX(RX,0),"^")
"RTN","PSOLBLD",54,0)
 W !,?TB1,"  ",$P(^PSDRUG($P(^PSRX(RX,0),"^",6),0),"^"),?TB3,$P(PS2,"^",2)_" ("_$P(RXY,"^",16)_"/"_$S(+$G(VRPH):VRPH,1:" ")_")"_" ",$P($P(NOW,":",1,2),"@")
"RTN","PSOLBLD",55,0)
 W !,?TB3,RXN,"  ",DATE1," Fill ",RXF+1," of ",1+$P(RXY,"^",9)
"RTN","PSOLBLD",56,0)
 W !,?TB1,"The above prescription has a status",?TB3,PNM,"  ",SSNP
"RTN","PSOLBLD",57,0)
 W !,?TB1,"of PENDING due to a DRUG-DRUG INTERACTION.",?TB3,$S($G(OSGY(1))]"":OSGY(1),1:$G(SGY(1)))
"RTN","PSOLBLD",58,0)
 I $G(SGY(2))'="" F SSG=2:1 Q:$G(SGY(SSG))=""  W !,?TB3,$S($G(OSGY(SSG))]"":OSGY(SSG),1:$G(SGY(SSG)))
"RTN","PSOLBLD",59,0)
 W !,?TB1,"Please review printouts of all labels"
"RTN","PSOLBLD",60,0)
 W !,?TB1,"for this patient that follow." D STORE
"RTN","PSOLBLD",61,0)
 W @IOF K PSCLN,DATE1,DRUG,RFLMSG,COPIES,DRUG,LMI,LINE,PS,PS1,PS2,INT,ISD,I1,MW,STATE,SIDE,SIGPH,SGY,PATST,PRTFL,PHYS,SGC,VRPH,NLWS,X1,X2,X,Y,TECH,EXPDT,NURSE,SEV,SCRIPT,RXX,SGY,SER,SSG,RXY,TB1,TB2,TB3,PSOSERV Q
"RTN","PSOLBLD",62,0)
 ;
"RTN","PSOLBLD",63,0)
BLANK ;label between patients
"RTN","PSOLBLD",64,0)
 F ZBLANK=1:1:10 W !
"RTN","PSOLBLD",65,0)
 W !,"**********************NEXT PATIENT*************",?54,"*********NEXT PATIENT***********NEXT PATIENT***"
"RTN","PSOLBLD",66,0)
 K ZBLANK Q
"RTN","PSOLLL8")
0^9^B28829603
"RTN","PSOLLL8",1,0)
PSOLLL8 ;BIR/JLC - LASER LABEL - CRITICAL INTERACTION ;12/13/02
"RTN","PSOLLL8",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,251,387,367,372**;DEC 1997;Build 54
"RTN","PSOLLL8",3,0)
 ;Reference to PS(56 supported by DBIA 2229
"RTN","PSOLLL8",4,0)
 ;Reference to PSDRUG supported by DBIA 221
"RTN","PSOLLL8",5,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5424
"RTN","PSOLLL8",6,0)
 ;
"RTN","PSOLLL8",7,0)
 S HOLDCOPY=COPIES
"RTN","PSOLLL8",8,0)
START ;
"RTN","PSOLLL8",9,0)
 ;
"RTN","PSOLLL8",10,0)
 I $G(PSOIO("CDII"))]"" X PSOIO("CDII")
"RTN","PSOLLL8",11,0)
 I $G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLL8",12,0)
 K PSOSERV N PSODOSEW,PSODRGI,PSRXSET S (PSODOSEW,PSODRGI)=0
"RTN","PSOLLL8",13,0)
 S COPIES=COPIES-1,Y=$P(^PSRX(RX,2),"^",6) X ^DD("DD") S EXPDT=Y,Y=$P(^PSRX(RX,0),"^",13) X ^DD("DD") S ISD=Y
"RTN","PSOLLL8",14,0)
 S Y=DATE X ^DD("DD") S DATE1=Y D NOW^%DTC S Y=% X ^DD("DD") S NOW=Y
"RTN","PSOLLL8",15,0)
 I '$D(^PS(52.4,RX,0)),$P(^PSRX(RX,"STA"),"^")=4 D UNKNOWN Q
"RTN","PSOLLL8",16,0)
 I '$G(RXRP(RX)) S T=$P(PS2,"^",2)_" "_"("_$P(RXY,"^",16)_"/"_$S(+$G(VRPH):VRPH,1:" ")_")"_" "_$P(NOW,":",1,2) D PRINT(T)
"RTN","PSOLLL8",17,0)
2 ;
"RTN","PSOLLL8",18,0)
 I $D(^PSRX(RX,"DRI")) D M1 S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOLLL8",19,0)
 .S:SEV(X)=1 PSOSERV=1
"RTN","PSOLLL8",20,0)
 .S T=$P($G(^PSRX(RXX(X),0)),"^")_"  "_$S(SEV(X)=1:"CRITICAL",SEV(X)=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION   "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^") S:SEV(X)=1 PSODRGI=1 D PRINT(T)
"RTN","PSOLLL8",21,0)
 I '$D(^PSRX(RX,"DRI")),$D(^PS(52.4,RX,0)) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) D M2:SCRIPT="" I SCRIPT'="" D M1 F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOLLL8",22,0)
 .S:SEV(X)=1 PSOSERV=1
"RTN","PSOLLL8",23,0)
 .S T=$P($G(^PSRX(RXX(X),0)),"^")_"     "_$S(SEV(X)=1:"CRITICAL",SEV(X)=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION    "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^") S:SEV(X)=1 PSODRGI=1 D PRINT(T)
"RTN","PSOLLL8",24,0)
 I $$DS^PSSDSAPI,($D(^PS(52.4,RX,1))) S T="",T=$P(^PS(52.4,RX,1),"^") D  D:T'="" PRINT(T)
"RTN","PSOLLL8",25,0)
 . S T=$$RCONVMS^PSODOSUT(T),PSODOSEW=1
"RTN","PSOLLL8",26,0)
 S T="This prescription was entered by: "_TECH_"." D PRINT(T)
"RTN","PSOLLL8",27,0)
 S T="This prescription "_$S('$G(PSOSERV):"may require",1:"requires")_" "_$S('$G(PSOSERV):"reviewing",1:"intervention")_" by a pharmacist." D PRINT(T)
"RTN","PSOLLL8",28,0)
 S T=DATE1_"  Fill "_(RXF+1)_" of "_(1+$P(RXY,"^",9)) D PRINT(T)
"RTN","PSOLLL8",29,0)
 S T=PNM_"  "_SSNP D PRINT(T)
"RTN","PSOLLL8",30,0)
 F SSG=1:1 Q:$G(SGY(SSG))=""  S T=SGY(SSG) D PRINT(T)
"RTN","PSOLLL8",31,0)
 S T="Qty: "_$G(QTY)_"   "_$G(PHYS) D PRINT(T)
"RTN","PSOLLL8",32,0)
 S T="Tech__________RPh__________" D PRINT(T)
"RTN","PSOLLL8",33,0)
 S T=DRUG D PRINT(T)
"RTN","PSOLLL8",34,0)
 S T="Routing: "_$S("W"[$E(MW):MW,1:MW_" MAIL") D PRINT(T)
"RTN","PSOLLL8",35,0)
 S T="Days supply: "_$G(DAYS)_" Cap: "_$S(PSCAP:"**NON-SFTY**",1:"SAFETY") D PRINT(T)
"RTN","PSOLLL8",36,0)
 S T="Isd: "_ISD_" Exp: "_EXPDT D PRINT(T)
"RTN","PSOLLL8",37,0)
 S T="Last Fill: "_$G(PSOFLAST) D PRINT(T)
"RTN","PSOLLL8",38,0)
 S T="Pat. Stat "_PATST_" Clinic: "_PSCLN D PRINT(T)
"RTN","PSOLLL8",39,0)
 W @IOF
"RTN","PSOLLL8",40,0)
 I COPIES>0 G START
"RTN","PSOLLL8",41,0)
 S COPIES=HOLDCOPY K HOLDCOPY
"RTN","PSOLLL8",42,0)
STORE ;LABEL PRINT NODE
"RTN","PSOLLL8",43,0)
 D NOW^%DTC S NOW=% K %,%H,%I I $G(RXF)="" S RXF=0 F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=I
"RTN","PSOLLL8",44,0)
 F IR=0 F FDA=0:0 S FDA=$O(^PSRX(RX,"L",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOLLL8",45,0)
 ;S IR=IR+1,^PSRX(RX,"L",0)="^52.032DA^"_IR_"^"_IR,^PSRX(RX,"L",IR,0)=NOW_"^"_RXF_"^"_$S($G(PCOMX)]"":$G(PCOMX),1:"From RX number "_$P(^PSRX(RX,0),"^"))_" Drug-Drug interaction"_$S($G(RXRP(RX)):" (Reprint)",1:"")_"^"_PDUZ_"^1"
"RTN","PSOLLL8",46,0)
 S IR=IR+1,PSRXSET="^52.032DA^"_IR_"^"_IR
"RTN","PSOLLL8",47,0)
 S PSRXSET=NOW_"^"_RXF_"^"_$S($G(PCOMX)]"":$G(PCOMX),1:"From RX number "_$P(^PSRX(RX,0),"^"))
"RTN","PSOLLL8",48,0)
 S PSRXSET=PSRXSET_$S(PSODRGI&(PSODOSEW)&$$DS^PSSDSAPI:" Drug-Drug interaction/dose warning",PSODRGI:" Drug-Drug interaction",PSODOSEW&$$DS^PSSDSAPI:" Dose Warning",1:"")_$S($G(RXRP(RX)):" (Reprint)",1:"")_"^"_PDUZ_"^1"
"RTN","PSOLLL8",49,0)
 S ^PSRX(RX,"L",IR,0)=PSRXSET
"RTN","PSOLLL8",50,0)
 ;
"RTN","PSOLLL8",51,0)
 ;Storing FDA Medication Guide filename in the Prescription file
"RTN","PSOLLL8",52,0)
 I $$MGONFILE^PSOFDAUT(RX) D
"RTN","PSOLLL8",53,0)
 . I $G(RXRP(RX)),'$G(RXRP(RX,"MG")) Q
"RTN","PSOLLL8",54,0)
 . S ^PSRX(RX,"L",IR,"FDA")=$P($$MGONFILE^PSOFDAUT(RX),"^",2)
"RTN","PSOLLL8",55,0)
 ; 
"RTN","PSOLLL8",56,0)
 K:$D(^PS(52.4,RX,0)) RXF,IR,FDA,NOW,I
"RTN","PSOLLL8",57,0)
END K:$D(^PS(52.4,RX,0)) PSCLN,DATE1,DRUG,RFLMSG,COPIES,DRUG,LMI,LINE,PS,PS1,PS2,INT,ISD,I1,MW,STATE,SIDE,SGY,PATST,PRTFL,PHYS,SGC,VRPH,NLWS,X1,X2,X,Y,TECH,EXPDT,NURSE,SEV,SCRIPT,RXX,SGY,SER,SSG,RXY,SIGPH,PS55,PS55X K PSOSERV
"RTN","PSOLLL8",58,0)
 Q
"RTN","PSOLLL8",59,0)
UNKNOWN S PSOY=PSOY+(3*PSOYI),T="",$P(T,"*",100)="" D PRINT(T)
"RTN","PSOLLL8",60,0)
 S T="THIS PRESCRIPTION HAS CAUSED A DRUG-DRUG INTERACTION " D PRINT(T)
"RTN","PSOLLL8",61,0)
 S T="",$P(T,"*",100)="" D PRINT(T)
"RTN","PSOLLL8",62,0)
 S T="PRESCRIPTION # "_$P(^PSRX(RX,0),"^")_"  "_$P(^PSDRUG($P(^PSRX(RX,0),"^",6),0),"^") D PRINT(T)
"RTN","PSOLLL8",63,0)
 S T="The above prescription has a status of PENDING due to a DRUG-DRUG INTERACTION." D PRINT(T)
"RTN","PSOLLL8",64,0)
 S T=PNM_"  "_SSNP D PRINT(T)
"RTN","PSOLLL8",65,0)
 S T=$P(PS2,"^",2)_" ("_$P(RXY,"^",16)_"/"_$S(+$G(VRPH):VRPH,1:" ")_")"_" "_$P($P(NOW,":",1,2),"@") D PRINT(T)
"RTN","PSOLLL8",66,0)
 S T=RXN_"  "_DATE1_" Fill "_(RXF+1)_" of "_(1+$P(RXY,"^",9)) D PRINT(T)
"RTN","PSOLLL8",67,0)
 F SSG=1:1 Q:$G(SGY(SSG))=""  S T=SGY(SSG) D PRINT(T)
"RTN","PSOLLL8",68,0)
 S PSOY=PSOY+PSOYI,T="Please review printouts of all labels for this patient that follow." D PRINT(T),STORE
"RTN","PSOLLL8",69,0)
 W @IOF K PSCLN,DATE1,DRUG,RFLMSG,COPIES,DRUG,LMI,LINE,PS,PS1,PS2,INT,ISD,I1,MW,STATE,SIDE,SIGPH,SGY,PATST,PRTFL,PHYS,SGC,VRPH,NLWS,X1,X2,X,Y,TECH,EXPDT,NURSE,SEV,SCRIPT,RXX,SGY,SER,SSG,RXY,PSOSERV Q
"RTN","PSOLLL8",70,0)
 ;
"RTN","PSOLLL8",71,0)
PRINT(T) ;
"RTN","PSOLLL8",72,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLL8",73,0)
 W T,!
"RTN","PSOLLL8",74,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLL8",75,0)
 Q
"RTN","PSOLLL8",76,0)
 ;
"RTN","PSOLLL8",77,0)
M1 ;
"RTN","PSOLLL8",78,0)
 S PSOY=PSOY+PSOYI,T="Rx# "_RXN_" has caused a DRUG-DRUG INTERACTION with the following prescription(s):" D PRINT(T)
"RTN","PSOLLL8",79,0)
 Q 
"RTN","PSOLLL8",80,0)
M2 ;
"RTN","PSOLLL8",81,0)
 S PSOY=PSOY+PSOYI,T="",T="Rx# "_RXN D PRINT(T)
"RTN","PSOLLL8",82,0)
 Q
"RTN","PSOLMAO")
0^37^B1901741
"RTN","PSOLMAO",1,0)
PSOLMAO ;BHAM ISC/LC - ACTIVE ORDERS ;14-MAR-1995
"RTN","PSOLMAO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,251,387,372**;DEC 1997;Build 54
"RTN","PSOLMAO",3,0)
 ;External reference to TERM^VALM0 supported by DBIA 2615
"RTN","PSOLMAO",4,0)
EN ; -- main entry point for PSO LM ACTION ORDER
"RTN","PSOLMAO",5,0)
 D EN^VALM("PSO LM ACTIVE ORDERS")
"RTN","PSOLMAO",6,0)
 Q
"RTN","PSOLMAO",7,0)
 ;
"RTN","PSOLMAO",8,0)
HDR ; -- header code
"RTN","PSOLMAO",9,0)
 D HDR^PSOLMUTL
"RTN","PSOLMAO",10,0)
 Q
"RTN","PSOLMAO",11,0)
 ;
"RTN","PSOLMAO",12,0)
INIT ; -- init variables and list array
"RTN","PSOLMAO",13,0)
 S VALMCNT=PSOPF D RV^PSOORFL
"RTN","PSOLMAO",14,0)
 Q
"RTN","PSOLMAO",15,0)
 ;
"RTN","PSOLMAO",16,0)
HELP ; -- help code
"RTN","PSOLMAO",17,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","PSOLMAO",18,0)
 Q
"RTN","PSOLMAO",19,0)
 ;
"RTN","PSOLMAO",20,0)
EXIT ; -- exit code
"RTN","PSOLMAO",21,0)
 D KILL^VALM10() K PSODCREV,PSOONOFC S PSOQFLG=1
"RTN","PSOLMAO",22,0)
 Q
"RTN","PSOLMAO",23,0)
 ;
"RTN","PSOLMAO",24,0)
EXPND ; -- expand code
"RTN","PSOLMAO",25,0)
 Q
"RTN","PSOLMAO",26,0)
 ;
"RTN","PSOLMAO",27,0)
PENTRY ;
"RTN","PSOLMAO",28,0)
 D KILL^VALM10()
"RTN","PSOLMAO",29,0)
 N PSORVIEN
"RTN","PSOLMAO",30,0)
 I $O(PSODCREV(0)) F PSORVIEN=0:0 S PSORVIEN=$O(PSODCREV(PSORVIEN)) Q:'PSORVIEN  D
"RTN","PSOLMAO",31,0)
 .I '$D(IORVON),$D(IOST(0)) D ENS^%ZISS,TERM^VALM0
"RTN","PSOLMAO",32,0)
 .D CNTRL^VALM10(PSORVIEN,1,80,IORVON,IORVOFF,0)
"RTN","PSOLMAO",33,0)
 K PSORVIEN
"RTN","PSOLMAO",34,0)
 S VALMCNT=$G(PSOPF)
"RTN","PSOLMAO",35,0)
 Q:'$G(VALMCNT)
"RTN","PSOLMAO",36,0)
 N PSLIST S PSLIST=0 F PSLIST=1:1:VALMCNT I $D(^TMP("PSOPF",$J,PSLIST,"RV")) D
"RTN","PSOLMAO",37,0)
 . D CNTRL^VALM10(PSLIST,1,3,IORVON,IORVOFF,0)
"RTN","PSOLMAO",38,0)
 Q
"RTN","PSONEW2")
0^30^B43830604
"RTN","PSONEW2",1,0)
PSONEW2 ;BIR/DSD - displays new rx information for edit ;7/17/06 6:59pm
"RTN","PSONEW2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,37,46,71,94,124,139,157,143,226,237,239,225,251,375,372**;DEC 1997;Build 54
"RTN","PSONEW2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSONEW2",4,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSONEW2",5,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSONEW2",6,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSONEW2",7,0)
 ; This routine displays the entered new rx information and
"RTN","PSONEW2",8,0)
 ; asks if correct, if not allows editing of the data.
"RTN","PSONEW2",9,0)
 ;------------------------------------------------------------
"RTN","PSONEW2",10,0)
 ;PSO*237 issue expired error message
"RTN","PSONEW2",11,0)
 ;
"RTN","PSONEW2",12,0)
START ;
"RTN","PSONEW2",13,0)
 S (PSONEW("DFLG"),PSONEW2("QFLG"))=0
"RTN","PSONEW2",14,0)
 D STOP
"RTN","PSONEW2",15,0)
 D DISPLAY ; Displays information
"RTN","PSONEW2",16,0)
 ;Copay exemption checks
"RTN","PSONEW2",17,0)
 D SCP^PSORN52D
"RTN","PSONEW2",18,0)
 S PSONEWFF=1,PSOFLAG=1 K PSOANSQ,PSOANSQD S PSOCPZ("DFLG")=0,PSONEW("NEWCOPAY")=0
"RTN","PSONEW2",19,0)
 ;can't check PSOSCA for <50 here because of PSOBILL check in PSOCPB
"RTN","PSONEW2",20,0)
 I (PSOSCP<50&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1)),$G(DUZ("AG"))="V" D COPAY^PSOCPB W !
"RTN","PSONEW2",21,0)
 I PSOSCA&(PSOSCP>49)!((PSOSCA!(PSOBILL=2))&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1))!(PSOSCP>49&(PSOBILL=2)) D SC^PSOMLLD2
"RTN","PSONEW2",22,0)
 I $G(PSOCPZ("DFLG")) K PSONEWFF,PSOANSQD,PSOCPZ("DFLG"),PSONEW("NEWCOPAY") S DIRUT="",PSONEW("DFLG")=1 D ASKX G END
"RTN","PSONEW2",23,0)
 ;IF MILL BILL, AND COPAY (*******TEST THE COPAY CHECK)
"RTN","PSONEW2",24,0)
 I $$DT^PSOMLLDT D  I $G(PSOCPZ("DFLG")) K PSONEWFF,PSOANSQD,PSOANSQ,PSOCPZ("DFLG"),PSONEW("NEWCOPAY") S DIRUT="",PSONEW("DFLG")=1 D ASKX G END
"RTN","PSONEW2",25,0)
 .;New prompts Quit after first '^'
"RTN","PSONEW2",26,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D CV^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("CV"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",27,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D VEH^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("VEH"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",28,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D RAD^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("RAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",29,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D PGW^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("PGW"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",30,0)
 .I $D(PSOIBQS(PSODFN,"SHAD")) D SHAD^PSOMLLD2 I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("SHAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",31,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D MST^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("MST"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",32,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D HNC^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("HNC"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",33,0)
 K PSOCPZ("DFLG"),PSONEWFF
"RTN","PSONEW2",34,0)
 D ASK K:$G(PSONEW("DFLG")) PSOANSQ G:PSONEW2("QFLG")!PSONEW("DFLG") END
"RTN","PSONEW2",35,0)
 S PSORX("EDIT")=1 D EN^PSOORNE1(.PSONEW),FULL^VALM1 G:$G(PSORX("FN")) END  I '$G(PSORX("FN")) S PSONEW("DFLG")=1 K PSOANSQ G END ;D EDIT
"RTN","PSONEW2",36,0)
 G:'$G(PSONEW("DFLG")) START
"RTN","PSONEW2",37,0)
 S PSONEW("QFLG")=1,PSONEW("DFLG")=0
"RTN","PSONEW2",38,0)
END D EOJ
"RTN","PSONEW2",39,0)
 Q
"RTN","PSONEW2",40,0)
 ;------------------------------------------------------------
"RTN","PSONEW2",41,0)
STOP K PSEXDT,X,%DT S PSON52("QFLG")=0
"RTN","PSONEW2",42,0)
 S X1=PSOID,X2=PSONEW("DAYS SUPPLY")*(PSONEW("# OF REFILLS")+1)\1
"RTN","PSONEW2",43,0)
 S X2=$S(PSONEW("DAYS SUPPLY")=X2:X2,+$G(PSONEW("CS")):184,1:366)
"RTN","PSONEW2",44,0)
 I X2<30 D
"RTN","PSONEW2",45,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSONEW2",46,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSONEW2",47,0)
 D C^%DTC I PSONEW("FILL DATE")>$P(X,".") S PSEXDT=1_"^"_$P(X,".")
"RTN","PSONEW2",48,0)
 K X1,X2,X,%DT
"RTN","PSONEW2",49,0)
 Q
"RTN","PSONEW2",50,0)
DISPLAY ;
"RTN","PSONEW2",51,0)
 D:+$$DS^PSSDSAPI&($G(PSOFOERR)) HD3^PSODOSUN()
"RTN","PSONEW2",52,0)
 W !!,"Rx # ",PSONEW("RX #")
"RTN","PSONEW2",53,0)
 W ?23,$E(PSONEW("FILL DATE"),4,5),"/",$E(PSONEW("FILL DATE"),6,7),"/",$E(PSONEW("FILL DATE"),2,3),!,$G(PSORX("NAME")),?30,"#",PSONEW("QTY")
"RTN","PSONEW2",54,0)
 I $G(SIGOK),$O(SIG(0)) D  K D G TRN
"RTN","PSONEW2",55,0)
 .F D=0:0 S D=$O(SIG(D)) W !,SIG(D) Q:'$O(SIG(D))  D:+$$DS^PSSDSAPI&($G(PSOFOERR)) HD3^PSODOSUN(7)
"RTN","PSONEW2",56,0)
 E  S X=PSONEW("SIG") D SIGONE^PSOHELP W !,$G(INS1) D:+$$DS^PSSDSAPI&($G(PSOFOERR)) HD3^PSODOSUN(7)
"RTN","PSONEW2",57,0)
TRN ;I $G(PSOPRC) F I=0:0 S I=$O(PRC(I)) Q:'I  W !,PRC(I)
"RTN","PSONEW2",58,0)
 W !!,$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:PSODRUG("NAME"))
"RTN","PSONEW2",59,0)
 W !,PSONEW("PROVIDER NAME"),?25,PSORX("CLERK CODE"),!,"# of Refills: ",PSONEW("# OF REFILLS"),! D:+$$DS^PSSDSAPI&($G(PSOFOERR)) HD3^PSODOSUN()
"RTN","PSONEW2",60,0)
 Q
"RTN","PSONEW2",61,0)
 ;
"RTN","PSONEW2",62,0)
ASK ;
"RTN","PSONEW2",63,0)
 K DIR,X,Y S DIR("A")="Is this correct"
"RTN","PSONEW2",64,0)
 S DIR(0)="Y",DIR("B")="YES" D ^DIR K DIR I $D(DIRUT) S PSONEW("DFLG")=1 G ASKX
"RTN","PSONEW2",65,0)
ASK1 I Y D  S PSONEW2("QFLG")=1
"RTN","PSONEW2",66,0)
 .S:$G(PSONEW("MAIL/WINDOW"))["W" BINGCRT=Y,BINGRTE="W"
"RTN","PSONEW2",67,0)
 .D:+$G(PSEXDT)
"RTN","PSONEW2",68,0)
 ..S Y=PSONEW("FILL DATE") X ^DD("DD") W !!,$C(7),Y_" fill date is greater than possible expiration date of " S Y=$P(PSEXDT,"^",2) X ^DD("DD") W Y_"."
"RTN","PSONEW2",69,0)
 .D DCORD K RORD,^TMP("PSORXDC",$J)
"RTN","PSONEW2",70,0)
ASKX I $D(DIRUT) D
"RTN","PSONEW2",71,0)
 .I +$G(PSEXDT) K DIRUT S (PSONEW2("QFLG"),PSONEW2("DFLG"),PSONEW("DFLG"),Y)=1
"RTN","PSONEW2",72,0)
 K X,Y,DIRUT,DTOUT,DUOUT
"RTN","PSONEW2",73,0)
 D:+$G(PSEXDT) PAUSE^VALM1
"RTN","PSONEW2",74,0)
 Q
"RTN","PSONEW2",75,0)
DCORD ;dc rxs and pending orders after new order is entered
"RTN","PSONEW2",76,0)
 I $G(PSORX("DFLG")) K ^TMP("PSORXDC",$J) Q
"RTN","PSONEW2",77,0)
 F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D @$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"PEN",1:"RX52")
"RTN","PSONEW2",78,0)
 I $G(PSORX("FN")) S VALMBCK="Q",PSOFROM="NEW"
"RTN","PSONEW2",79,0)
 K RORD,PSOTECCK H 2
"RTN","PSONEW2",80,0)
 Q
"RTN","PSONEW2",81,0)
PEN ;pending ^tmp("psorxdc",$j,rord,0)="p^"_rord_"^"_msg
"RTN","PSONEW2",82,0)
 N PSOR,DNM S PSOR=^PS(52.41,RORD,0) S $P(^PS(52.41,RORD,0),"^",3)="DC",^PS(52.41,RORD,4)=$P(^TMP("PSORXDC",$J,RORD,0),"^",3)
"RTN","PSONEW2",83,0)
 K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,RORD,"INI")),"^"),RORD)
"RTN","PSONEW2",84,0)
 S DNM=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSONEW2",85,0)
 D EN^PSOHLSN($P(^PS(52.41,RORD,0),"^"),"OC",$P(^TMP("PSORXDC",$J,RORD,0),"^",3),"D")
"RTN","PSONEW2",86,0)
 I $G(PSOTECCK),'$D(^XUSEC("PSORPH",DUZ)) G PENX
"RTN","PSONEW2",87,0)
 W $C(7),! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSONEW2",88,0)
 S X=" Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Pending Order "_DNM_" has been discontinued..." D ^DIWP
"RTN","PSONEW2",89,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSONEW2",90,0)
PENX K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF W !
"RTN","PSONEW2",91,0)
 D PSOUL^PSSLOCK(RORD_"S") K ^TMP("PSORXDC",$J,RORD,0)
"RTN","PSONEW2",92,0)
 Q
"RTN","PSONEW2",93,0)
RX52 ;rxs in file 52 ^tmp("psorxdc",$j,rord,0)=52^rord^msg^rea^act^sta^dnm
"RTN","PSONEW2",94,0)
 S PSCAN($P(^PSRX(RORD,0),"^"))=RORD_"^"_$P(^TMP("PSORXDC",$J,RORD,0),"^",4)
"RTN","PSONEW2",95,0)
 S MSG=$P(^TMP("PSORXDC",$J,RORD,0),"^",3),REA=$P(^(0),"^",4),ACT=$P(^(0),"^",5)
"RTN","PSONEW2",96,0)
 N PSONOOR S PSONOOR="D",DUP=1,DA=RORD D CAN^PSOCAN K PSONOOR
"RTN","PSONEW2",97,0)
 I $G(PSOTECCK),'$D(^XUSEC("PSORPH",DUZ)) G RX52X
"RTN","PSONEW2",98,0)
 W $C(7),! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSONEW2",99,0)
 S X=" Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Rx #"_$P(^PSRX(RORD,0),"^")_" "_$P(^TMP("PSORXDC",$J,RORD,0),"^",7)_" has been discontinued..." D ^DIWP
"RTN","PSONEW2",100,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSONEW2",101,0)
RX52X K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF W !
"RTN","PSONEW2",102,0)
 K PSOSD($P(^TMP("PSORXDC",$J,RORD,0),"^",6),$P(^TMP("PSORXDC",$J,RORD,0),"^",7))
"RTN","PSONEW2",103,0)
 D PSOUL^PSSLOCK(RORD) K ^TMP("PSORXDC",$J,RORD,0)
"RTN","PSONEW2",104,0)
 Q
"RTN","PSONEW2",105,0)
 ;
"RTN","PSONEW2",106,0)
EDIT ;
"RTN","PSONEW2",107,0)
 S PSORX("EDIT")=1
"RTN","PSONEW2",108,0)
 D ^PSONEW3
"RTN","PSONEW2",109,0)
 S PSONEW("DFLG")=$S($G(PSORX("DFLG")):1,1:0)
"RTN","PSONEW2",110,0)
 Q
"RTN","PSONEW2",111,0)
 ;
"RTN","PSONEW2",112,0)
EOJ ;
"RTN","PSONEW2",113,0)
 K PSONEW2,PSORX("EDIT"),PSORX("DFLG"),PSOEDIT,PSOSCA
"RTN","PSONEW2",114,0)
 Q
"RTN","PSONEW2",115,0)
 ;
"RTN","PSONEW2",116,0)
EN1(PSONEW2) ; Entry point to just display and ask if okay
"RTN","PSONEW2",117,0)
 S PSONEW("DFLG")=0
"RTN","PSONEW2",118,0)
 I $G(^PSRX(PSONEW2("IRXN"),0))']"" S PSONEW("DFLG")=1 G EN1X
"RTN","PSONEW2",119,0)
 S PSOX=^PSRX(PSONEW2("IRXN"),0),PSONEW("TRADE NAME")=$G(^("TN")),PSONEW("FILL DATE")=$P($G(^(2)),"^",2)
"RTN","PSONEW2",120,0)
 S PSONEW("RX #")=$P(PSOX,"^"),PSORX("NAME")=$P(^DPT($P(PSOX,"^",2),0),"^")
"RTN","PSONEW2",121,0)
 S PSONEW("QTY")=$P(PSOX,"^",7),PSODRUG("NAME")=$P(^PSDRUG($P(PSOX,"^",6),0),"^"),PSONEW("# OF REFILLS")=$P(PSOX,"^",9)
"RTN","PSONEW2",122,0)
 S PSORX("CLERK CODE")=$P(^VA(200,$P(PSOX,"^",16),0),"^")
"RTN","PSONEW2",123,0)
 S:$G(PSONEW("PROVIDER NAME"))="" PSONEW("PROVIDER NAME")=$P(^VA(200,$P(PSOX,"^",4),0),"^")
"RTN","PSONEW2",124,0)
 S PSONEW("SIG")=$P($G(^PSRX(PSONEW2("IRXN"),"SIG")),"^")
"RTN","PSONEW2",125,0)
 D DISPLAY
"RTN","PSONEW2",126,0)
 D ASK
"RTN","PSONEW2",127,0)
 I PSONEW("DFLG")=1 S PSONEW2("DFLG")=1
"RTN","PSONEW2",128,0)
EN1X ;
"RTN","PSONEW2",129,0)
 Q
"RTN","PSONEW2",130,0)
 ;
"RTN","PSONEW2",131,0)
EXPR ;Display Expired error message                               ;PSO*237
"RTN","PSONEW2",132,0)
 S PSONEW("DFLG")=1
"RTN","PSONEW2",133,0)
 W $C(7)
"RTN","PSONEW2",134,0)
 S VALMSG="Order is older than 365 days and can't be finished"
"RTN","PSONEW2",135,0)
 S XQORM("B")="DC"
"RTN","PSONEW2",136,0)
 Q
"RTN","PSOORED3")
0^23^B59778178
"RTN","PSOORED3",1,0)
PSOORED3 ;BIR/SAB-edit finished orders through backdoor ;10/20/06 11:09am
"RTN","PSOORED3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,99,117,133,148,249,251,379,372**;DEC 1997;Build 54
"RTN","PSOORED3",3,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED3",4,0)
 ;called from psoored2
"RTN","PSOORED3",5,0)
 D DOLST
"RTN","PSOORED3",6,0)
 ;
"RTN","PSOORED3",7,0)
DOSE ;adds dosing info
"RTN","PSOORED3",8,0)
 I '$G(PSORXED("ENT")) F  S I=$O(PSORXED("DOSE",I)) Q:'I  S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORED3",9,0)
 K ROU,UNITN,STRE,PSODOSE,RTE,NOUN,VERB M PSODOSE=PSORXED
"RTN","PSOORED3",10,0)
 D KV K FIELD,DOSEOR,DOOR,X,Y,UNITS S ENT=1
"RTN","PSOORED3",11,0)
ASK S ROU="PSOORED3" D ASK^PSOBKDED K ROU I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",12,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED3",13,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED3",14,0)
 ;
"RTN","PSOORED3",15,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED3",16,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED3",17,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",18,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED3",19,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED3",20,0)
DUPD ;
"RTN","PSOORED3",21,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED3",22,0)
 D DUPD^PSOOREDX
"RTN","PSOORED3",23,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED3",24,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED3",25,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",26,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED3",27,0)
 D STR^PSOOREDX
"RTN","PSOORED3",28,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED3",29,0)
 D CNON
"RTN","PSOORED3",30,0)
 N PSONDEF
"RTN","PSOORED3",31,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED3",32,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED3",33,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",34,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED3",35,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED3",36,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED3",37,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED3",38,0)
RTE S:$G(PSORXED("ROUTE",ENT))']"" DRET=1
"RTN","PSOORED3",39,0)
 K JUMP S ROU="PSOORED3" D RTE^PSOBKDED K ROU
"RTN","PSOORED3",40,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",41,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",42,0)
 I $G(QUIT) K QUIT,ROU Q
"RTN","PSOORED3",43,0)
 ;
"RTN","PSOORED3",44,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED3",45,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",46,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED3",47,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED3",48,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED3",49,0)
 ;
"RTN","PSOORED3",50,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN MONTHS, WEEKS, DAYS, HOURS OR MINUTES)"
"RTN","PSOORED3",51,0)
 S DIR("B")=$S($G(DUR)]"":DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED3",52,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED3",53,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",54,0)
 D DUR1^PSOOREDX
"RTN","PSOORED3",55,0)
 ;
"RTN","PSOORED3",56,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED3",57,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",58,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED3",59,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED3",60,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED3",61,0)
 ;
"RTN","PSOORED3",62,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED3",63,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EXQ S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED3",64,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSOQUIT=1 G EXQ
"RTN","PSOORED3",65,0)
 I PSOSAVX="",$G(PSORXED)!$D(PSOEDDOS) K PSOCKCON
"RTN","PSOORED3",66,0)
 K PSOSAVX
"RTN","PSOORED3",67,0)
 ;
"RTN","PSOORED3",68,0)
 S DENT=$O(PSORXED("DOSE",ENT)) I DENT,(ENT+1)'=DENT D
"RTN","PSOORED3",69,0)
 .K PSORXED("DOSE",DENT),PSORXED("NOUN",DENT),PSORXED("VERB",DENT),PSORXED("DOSE ORDERED",DENT),PSORXED("ROUTE",DENT),PSORXED("ODOSE",DENT)
"RTN","PSOORED3",70,0)
 .K PSORXED("SCHEDULE",DENT),PSORXED("DURATION",DENT),PSORXED("CONJUNCTION",DENT),DENT
"RTN","PSOORED3",71,0)
 I $G(FIELD)]"" K FIELD S QUIT=1
"RTN","PSOORED3",72,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D
"RTN","PSOORED3",73,0)
 .F D=0:0 S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED3",74,0)
 D EN^PSOFSIG(.PSORXED) D VER^PSOORED7:'$G(PSOVER) I $G(CKX),'$G(PSOSIGFL) D M1 K CKX
"RTN","PSOORED3",75,0)
 I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",76,0)
 K QTY,QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",77,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED3",78,0)
 K QTYHLD Q:$G(PSOVER)!($G(PSOREEDQ))
"RTN","PSOORED3",79,0)
UDSIG I $O(SIG(0)) D
"RTN","PSOORED3",80,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED3",81,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED3",82,0)
 .D NOW^%DTC I $G(QTY) S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^Quantity Updated "_"("_$P(^PSRX(PSORXED("IRXN"),0),"^",7)_")",$P(^PSRX(PSORXED("IRXN"),0),"^",7)=$G(PSORXED("QTY")) K QTY
"RTN","PSOORED3",83,0)
 .S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED3",84,0)
 ..I '$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^") Q
"RTN","PSOORED3",85,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED3",86,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",87,0)
 .K SIG,A,I
"RTN","PSOORED3",88,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED3",89,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED3",90,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED3",91,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,1)=$G(PSORXED("ODOSE",I))
"RTN","PSOORED3",92,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1
"RTN","PSOORED3",93,0)
 G EX
"RTN","PSOORED3",94,0)
 Q
"RTN","PSOORED3",95,0)
EX ;
"RTN","PSOORED3",96,0)
 K PSORXED("DOSE"),DOSE,DUPD,SCH,PSORXED("NOUN"),PSORXED("VERB"),VERB,NOUN,PSORXED("DOSE ORDERED"),DOSEOR,PSORXED("ROUTE"),ENT,PSORTE,SIG,PSODOSE
"RTN","PSOORED3",97,0)
 K PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),DURA,X,Y,PSORXED("ODOSE")
"RTN","PSOORED3",98,0)
EX1 K STRE,UNITN,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ERTE,ROU
"RTN","PSOORED3",99,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORED3",100,0)
 Q
"RTN","PSOORED3",101,0)
EXQ K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) S PSORXED("DFLG")=1 D M1 G EX
"RTN","PSOORED3",102,0)
 Q
"RTN","PSOORED3",103,0)
M1 D M1^PSOOREDX
"RTN","PSOORED3",104,0)
 Q
"RTN","PSOORED3",105,0)
DOLST1(PSORXED) ;
"RTN","PSOORED3",106,0)
 ;
"RTN","PSOORED3",107,0)
DOLST F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),6,I)) Q:'I  S INST=^(I,0) D
"RTN","PSOORED3",108,0)
 .S PSORXED("DOSE",I)=$P(INST,"^"),PSORXED("DOSE ORDERED",I)=$P(INST,"^",2),PSORXED("UNITS",I)=$P(INST,"^",3),PSORXED("NOUN",I)=$P(INST,"^",4)
"RTN","PSOORED3",109,0)
 .I $P(INST,"^",5)]"" D
"RTN","PSOORED3",110,0)
 ..S PSORXED("DURATION",I)=$S($E($P(INST,"^",5),1)'?.N:$E($P(INST,"^",5),2,99)_$E($P(INST,"^",5),1),1:$P(INST,"^",5))
"RTN","PSOORED3",111,0)
 .S PSORXED("ROUTE",I)=$P(INST,"^",7),PSORXED("SCHEDULE",I)=$P(INST,"^",8)
"RTN","PSOORED3",112,0)
 .S PSORXED("CONJUNCTION",I)=$P(INST,"^",6),PSORXED("VERB",I)=$P(INST,"^",9),OLENT=I
"RTN","PSOORED3",113,0)
 .S PSORXED("ODOSE",I)=$G(^PSRX(PSORXED("IRXN"),6,I,1))
"RTN","PSOORED3",114,0)
 K:'$O(PSORXED("DOSE",0)) PSORXED("ENT"),OLENT
"RTN","PSOORED3",115,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORED3",116,0)
 Q
"RTN","PSOORED3",117,0)
UPDSIG ;updates sig
"RTN","PSOORED3",118,0)
 K ^PSRX(PSORXED("IRXN"),"SIG1") S ^PSRX(PSORXED("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSOORED3",119,0)
 S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1
"RTN","PSOORED3",120,0)
 S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",121,0)
 Q
"RTN","PSOORED3",122,0)
JUMP ;jump to fields
"RTN","PSOORED3",123,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED3",124,0)
 D FNM^PSOOREDX
"RTN","PSOORED3",125,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED3",126,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED3",127,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED3",128,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED3",129,0)
 G EX
"RTN","PSOORED3",130,0)
 Q
"RTN","PSOORED3",131,0)
 ;
"RTN","PSOORED3",132,0)
CNON ;
"RTN","PSOORED3",133,0)
 I $G(NOUN)'="" Q
"RTN","PSOORED3",134,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOORED3",135,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOORED3",136,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOORED3",137,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOORED3",138,0)
 I PSONLG'>3 Q
"RTN","PSOORED3",139,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOORED3",140,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOORED3",141,0)
 ;test noun of (S)
"RTN","PSOORED3",142,0)
 K NOUN ; NOT SURE ABOUT THIS???
"RTN","PSOORED3",143,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOORED3",144,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOORED3",145,0)
 Q
"RTN","PSOORED4")
0^31^B55575437
"RTN","PSOORED4",1,0)
PSOORED4 ;BIR/SAB - Edit front door dosing ;07/13/00
"RTN","PSOORED4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,91,78,99,111,117,133,159,148,251,391,372**;DEC 1997;Build 54
"RTN","PSOORED4",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOORED4",4,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED4",5,0)
 ;External reference to PS(51.1 supported by DBIA 2225
"RTN","PSOORED4",6,0)
 ;called from psoornew
"RTN","PSOORED4",7,0)
 ;
"RTN","PSOORED4",8,0)
DOSE(PSORXED) ;
"RTN","PSOORED4",9,0)
 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORED4",10,0)
 K ROU,STRE,UNITN,PSODOSE M PSODOSE=PSORXED
"RTN","PSOORED4",11,0)
 D KV K FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=PSORXED("ENT")
"RTN","PSOORED4",12,0)
ASK I $G(ORD) W !!,"Possible SIG: " D
"RTN","PSOORED4",13,0)
 .;Coded only for outside orders with no Patient Instructions
"RTN","PSOORED4",14,0)
 .I $O(SIG(""))="",$G(ORD),$P($G(^PS(52.41,ORD,"EXT")),"^")'="" D SIGS^PSOHCPRS
"RTN","PSOORED4",15,0)
 .S INST=0 F  S INST=$O(SIG(INST)) Q:'INST  S MIG=SIG(INST) D
"RTN","PSOORED4",16,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORED4",17,0)
 K SG,INST,MIG
"RTN","PSOORED4",18,0)
 S ROU="PSOORED4",II=ENT D ASK^PSOBKDED K ROU,II I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",19,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED4",20,0)
 ;
"RTN","PSOORED4",21,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED4",22,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED4",23,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",24,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED4",25,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED4",26,0)
DUPD ;
"RTN","PSOORED4",27,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED4",28,0)
 D DUPD^PSOOREDX
"RTN","PSOORED4",29,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:1) S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED4",30,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED4",31,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",32,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED4",33,0)
 D STR^PSOOREDX
"RTN","PSOORED4",34,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED4",35,0)
 D CNON^PSOORED3
"RTN","PSOORED4",36,0)
 N PSONDEF
"RTN","PSOORED4",37,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED4",38,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED4",39,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",40,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED4",41,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED4",42,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED4",43,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED4",44,0)
 ;
"RTN","PSOORED4",45,0)
RTE K JUMP S ROU="PSOORED4" D RTE^PSOBKDED K ROU
"RTN","PSOORED4",46,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED4",47,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",48,0)
 ;
"RTN","PSOORED4",49,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED4",50,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",51,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED4",52,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED4",53,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED4",54,0)
 ;
"RTN","PSOORED4",55,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED4",56,0)
 S DIR("B")=$S($G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",57,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED4",58,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",59,0)
 D DUR1^PSOOREDX
"RTN","PSOORED4",60,0)
 ;
"RTN","PSOORED4",61,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED4",62,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED4",63,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED4",64,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED4",65,0)
 I X="@",$D(PSORXED("CONJUNCTION",ENT)) D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED4",66,0)
 ;
"RTN","PSOORED4",67,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED4",68,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSONEW("DFLG")) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED4",69,0)
 E  K PSOCKCON D DCHK1^PSODOSUT I $D(DTOUT)!($D(DUOUT)) S PSORX("DFLG")=1,PSONEW("DFLG")=1 G EX  ;don't need to print the full summary, just the last sequence.
"RTN","PSOORED4",70,0)
 I PSOSAVX="",$G(PSORXED) K PSOCKCON,PSOEDDOS
"RTN","PSOORED4",71,0)
 K PSOSAVX
"RTN","PSOORED4",72,0)
 ;
"RTN","PSOORED4",73,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED4",74,0)
 D EN^PSOFSIG(.PSORXED),VERI I $G(CKX),'$G(PSOSIGFL) D MP1 K CKX
"RTN","PSOORED4",75,0)
 I $G(PSOSIGFL)=1 D  I $$PATCH^XPDUTL("PSO*7.0*391"),'$G(PSOSIGFL) Q
"RTN","PSOORED4",76,0)
 .I $$PATCH^XPDUTL("PSO*7.0*391"),$D(OR0),$P(OR0,"^",24)=1 S VALMSG="Digitally Signed Order - No such changes allowed." K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D  Q
"RTN","PSOORED4",77,0)
 ..I $D(PSOBDR) K PSODRUG M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",78,0)
 .S PSORXED("ENT")=ENT,SIGOK=1,VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOORED4",79,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED4",80,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED4",81,0)
 K QTYHLD
"RTN","PSOORED4",82,0)
 I '$G(PSORXED("QTY")),$P(OR0,"^",10) S PSORXED("QTY")=$P(OR0,"^",10)
"RTN","PSOORED4",83,0)
EX ;
"RTN","PSOORED4",84,0)
 K PSOBDR,PSOBDRG,PSOSCH,DUPD,STRE,UNITN,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSODOSE,OLENT,FIELD,FLDNM,AR,NM,ENT,STRE,UNITN,PSODOSE,ERTE,ROU
"RTN","PSOORED4",85,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOORED4",86,0)
 Q
"RTN","PSOORED4",87,0)
EXQ ;
"RTN","PSOORED4",88,0)
 K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) D MP1
"RTN","PSOORED4",89,0)
 I $D(PSOBDR) M PSODRUG=PSOBDR K PSOBDR,PSOBDRG
"RTN","PSOORED4",90,0)
 G EX Q
"RTN","PSOORED4",91,0)
MP1 D MP1^PSOOREDX
"RTN","PSOORED4",92,0)
 Q
"RTN","PSOORED4",93,0)
VERI ;checks for changes to dosing instructions
"RTN","PSOORED4",94,0)
 S ENTS=0
"RTN","PSOORED4",95,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S ENTS=$G(ENTS)+1
"RTN","PSOORED4",96,0)
 I ENTS<OLENT!(ENTS>OLENT) S PSOSIGFL=1 Q
"RTN","PSOORED4",97,0)
 F I=1:1:OLENT D
"RTN","PSOORED4",98,0)
 .I PSODOSE("DOSE",I)'=$G(PSORXED("DOSE",I)) S PSOSIGFL=1
"RTN","PSOORED4",99,0)
 .I $G(PSODOSE("DURATION",I))]"" D
"RTN","PSOORED4",100,0)
 ..S DURATION=$S($E(PSODOSE("DURATION",I),1)'?.N:$E(PSODOSE("DURATION",I),2,99)_$E(PSODOSE("DURATION",I),1),1:PSODOSE("DURATION",I))
"RTN","PSOORED4",101,0)
 ..I +DURATION'=+$G(PSORXED("DURATION",I)) S PSOSIGFL=1
"RTN","PSOORED4",102,0)
 .I $G(PSODOSE("CONJUNCTION",I))'=$G(PSORXED("CONJUNCTION",I)) S PSOSIGFL=1
"RTN","PSOORED4",103,0)
 .I PSODOSE("ROUTE",I)'=$G(PSORXED("ROUTE",I)) S PSOSIGFL=1
"RTN","PSOORED4",104,0)
 .I PSODOSE("SCHEDULE",I)'=$G(PSORXED("SCHEDULE",I)) S PSOSIGFL=1
"RTN","PSOORED4",105,0)
 K DURATION Q
"RTN","PSOORED4",106,0)
JUMP ;jump to fields
"RTN","PSOORED4",107,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED4",108,0)
 D FNM^PSOOREDX
"RTN","PSOORED4",109,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED4",110,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED4",111,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED4",112,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED4",113,0)
 G EX
"RTN","PSOORED4",114,0)
 Q
"RTN","PSOORED4",115,0)
HLP ;help text for med route
"RTN","PSOORED4",116,0)
 D FULL^VALM1 W !,"Please enter how patient will use the medication!"
"RTN","PSOORED4",117,0)
 S DIC=51.2,X="??",DIC(0)="M",DIC("S")="I $P(^PS(51.2,+Y,0),""^"",4)" D ^DIC K DIC,X,Y
"RTN","PSOORED4",118,0)
 Q
"RTN","PSOORED4",119,0)
SCHLP ;
"RTN","PSOORED4",120,0)
 D FULL^VALM1 W !,"You can choose an entry from the Administration Schedule File (#51.1),",!,"Medication Instruction File (#51) or enter free text."
"RTN","PSOORED4",121,0)
 W !,"The free text entry cannot contain more than 2 spaces or be greater than 20",!,"characters in length."
"RTN","PSOORED4",122,0)
 W ! S DIR(0)="S^A:Administration Schedule File;M:Medication Instruction File;B:Both;F:Free Text",DIR("B")="Both"
"RTN","PSOORED4",123,0)
 S DIR("A")="Do you want to list from" D ^DIR I Y="F"!($G(DIRUT)) K X,Y G X
"RTN","PSOORED4",124,0)
 S LBL=Y G @LBL
"RTN","PSOORED4",125,0)
A ;display 51.1 entries only
"RTN","PSOORED4",126,0)
B K X,Y,DIC S X="??",DIC="^PS(51.1,",DIC(0)="QES",DIC("W")="D DICW^PSOORED4",D="APPSJ" W ! D IX^DIC
"RTN","PSOORED4",127,0)
 K DIC,X I LBL="A"!($G(DTOUT)) K LBL G X
"RTN","PSOORED4",128,0)
 I Y=-1!($G(DUOUT)) K DIR,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to continue with the Medication Instruction File"
"RTN","PSOORED4",129,0)
 D ^DIR I 'Y!($G(DTOUT)) K DIR,X,Y G X
"RTN","PSOORED4",130,0)
M K X,Y,DIC S DIC=51,X="??",DIC(0)="M" D ^DIC K DIC,X,Y,DTOUT,DUOUT,LBL
"RTN","PSOORED4",131,0)
X S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>3)!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOORED4",132,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED4",133,0)
 Q
"RTN","PSOORED4",134,0)
DICW ;
"RTN","PSOORED4",135,0)
 S Z=$P(^PS(51.1,+Y,0),"^",5),Z=$S(Z="O":-1,Z="S":1,Z="R":-2,1:0) W:Z "  ",$S(Z>0:"SHIFT",Z=-2:"RANGE",1:"ONE-TIME")
"RTN","PSOORED4",136,0)
 I Z'<0,$D(PSJW),$D(^(PSJPP'="PSJ"+1,PSJW,0)),$P(^(0),"^",Z+2)]"" W "  ",$P(^(0),"^",Z+2)
"RTN","PSOORED4",137,0)
 ;Naked reference on DICW+2 is from DICW+1, ^PS(51.1,+Y,0)
"RTN","PSOORED4",138,0)
 Q
"RTN","PSOORED5")
0^34^B58202771
"RTN","PSOORED5",1,0)
PSOORED5 ;BIR/SAB-Rxs without dosing info ;07/20/00
"RTN","PSOORED5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,75,78,100,99,117,133,251,372**;DEC 1997;Build 54
"RTN","PSOORED5",3,0)
 ;^PS(51.2 - DBIA 2226
"RTN","PSOORED5",4,0)
 ;^PS(50.7 - DBIA 2223
"RTN","PSOORED5",5,0)
 ;^PSDRUG - DBIA 221
"RTN","PSOORED5",6,0)
 ;^PS(55 - DBIA 2228
"RTN","PSOORED5",7,0)
 ;called by psoored2 and psodir
"RTN","PSOORED5",8,0)
 ;pre-poe rxs and new backdoor rxs
"RTN","PSOORED5",9,0)
DOSE1(PSORXED) ;for new rxs
"RTN","PSOORED5",10,0)
DOSE ;pre-poe rx
"RTN","PSOORED5",11,0)
 D KV K ROU,STRE,FIELD,DOSEOR,DUPD,X,Y,UNITS S ENT=1,OLENT=ENT
"RTN","PSOORED5",12,0)
ASK S ROU="PSOORED5" D ASK^PSOBKDED K ROU G:$D(DIRUT) EX
"RTN","PSOORED5",13,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED5",14,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED5",15,0)
 ;
"RTN","PSOORED5",16,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED5",17,0)
 I $G(PSORX("EDIT"))']"" W:$G(PSORXED("VERB",ENT))]"" !,"VERB: "_PSORXED("VERB",ENT) G DUPD
"RTN","PSOORED5",18,0)
VER D VER^PSOOREDX
"RTN","PSOORED5",19,0)
 I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED5",20,0)
 G:$D(DTOUT)!($D(DUOUT)) EX I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED5",21,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED5",22,0)
DUPD ;
"RTN","PSOORED5",23,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED5",24,0)
 D KV S DIR(0)="52.0113,1",DIR("A")="DISPENSE UNITS PER DOSE"_$S($G(PSORXED("NOUN",ENT))]"":"("_PSORXED("NOUN",ENT)_")",1:"")
"RTN","PSOORED5",25,0)
 I '$G(PSORXED("DOSE",ENT)),$G(PSORXED("DOSE",ENT-1)) S PSORXED("DOSE",ENT)=PSORXED("DOSE",ENT-1)
"RTN","PSOORED5",26,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),$G(DUPD)]"":DUPD,1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED5",27,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED5",28,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",29,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED5",30,0)
 D STR^PSOOREDX
"RTN","PSOORED5",31,0)
 ;
"RTN","PSOORED5",32,0)
NOU1 G:'$D(DUPD) RTE D CNON^PSOORED3 N PSONDEF
"RTN","PSOORED5",33,0)
 I $G(NOUN)]"",$G(PSORX("EDIT"))']"" S PSORXED("NOUN",ENT)=NOUN W !,"NOUN: "_$G(NOUN) G RTE
"RTN","PSOORED5",34,0)
 I $G(PSORX("EDIT"))']"",$G(PSORXED("NOUN",ENT))]"" W !,"NOUN: "_PSORXED("NOUN",ENT) G RTE
"RTN","PSOORED5",35,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED5",36,0)
 G:$D(DTOUT)!($D(DUOUT)) EX I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED5",37,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED5",38,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED5",39,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED5",40,0)
 ;
"RTN","PSOORED5",41,0)
RTE I $G(ENT)>1,$G(PSORX("EDIT"))']"",$G(PSORXED("ROUTE",ENT-1)),$G(PSORXED("ROUTE",ENT))']"" S PSORXED("ROUTE",ENT)=PSORXED("ROUTE",ENT-1) G SCH
"RTN","PSOORED5",42,0)
 I '$G(DRET),'$G(PSORXED("ROUTE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",6) S PSORXED("ROUTE",ENT)=$P(^PS(50.7,PSODRUG("OI"),0),"^",6)
"RTN","PSOORED5",43,0)
 I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOORED5",44,0)
 I $G(RTE) K RTE
"RTN","PSOORED5",45,0)
 D KV S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOORED5",46,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",47,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE" G JUMP
"RTN","PSOORED5",48,0)
 I $D(DTOUT)!($D(DUOUT)) S PSODIR("DFLG")=1 Q
"RTN","PSOORED5",49,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" G SCH
"RTN","PSOORED5",50,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^") W X_" "_$G(ERTE) G SCH
"RTN","PSOORED5",51,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOORED5",52,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOORED5",53,0)
 ;
"RTN","PSOORED5",54,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED5",55,0)
 G:$D(DTOUT)!($D(DUOUT)) EX S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED5",56,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED5",57,0)
 S:$G(PSORXED("ENT"))<ENT PSORXED("ENT")=ENT
"RTN","PSOORED5",58,0)
 ;
"RTN","PSOORED5",59,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN DAYS, HOURS OR MINUTES)"
"RTN","PSOORED5",60,0)
 S DIR("B")=$S($D(DUR):DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED5",61,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED5",62,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",63,0)
 D DUR1^PSOOREDX
"RTN","PSOORED5",64,0)
 ;
"RTN","PSOORED5",65,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED5",66,0)
 G:$D(DTOUT)!($D(DUOUT)) EX
"RTN","PSOORED5",67,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED5",68,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED5",69,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EX G:'Y CON S:'$G(COPY) PSOSIGFL=1 D UPD^PSOOREDX G CON
"RTN","PSOORED5",70,0)
 ;
"RTN","PSOORED5",71,0)
 N PSODLBD4 S PSOSAVX=X,PSODLBD4=1
"RTN","PSOORED5",72,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S PSOCKCON=1 D DCHK1^PSODOSUT G:$G(PSORXED("DFLG"))!($G(PSORX("DFLG"))) EX S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED5",73,0)
 E  K PSOCKCON I $$DCHK^PSODOSUT S PSORXED("DFLG")=1,PSORX("DFLG")=1 G EX
"RTN","PSOORED5",74,0)
 I PSOSAVX="",$G(PSORXED)!($D(PSOEDDOS)) K PSOCKCON
"RTN","PSOORED5",75,0)
 K PSOSAVX
"RTN","PSOORED5",76,0)
 ;
"RTN","PSOORED5",77,0)
 S X=$G(PSORXED("INS")) D SIG^PSOHELP S:$G(INS1)]"" PSORXED("SIG")=$E(INS1,2,9999999)
"RTN","PSOORED5",78,0)
 D EN^PSOFSIG(.PSORXED) I $O(SIG(0)) S PSORXED("ENT")=ENT,SIGOK=1
"RTN","PSOORED5",79,0)
 Q:$G(PSOREEDT)!($G(PSOORRNW))
"RTN","PSOORED5",80,0)
 K QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED5",81,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED5",82,0)
 K QTYHLD Q:$G(PSOFROM)="NEW"!($G(COPY))!($G(PSOFROM))!($G(PSOREEDT))
"RTN","PSOORED5",83,0)
 Q:$G(PSOSIGFL)  D
"RTN","PSOORED5",84,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED5",85,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED5",86,0)
 .S:'$D(^PSRX(PSORXED("IRXN"),"A",0)) ^PSRX(PSORXED("IRXN"),"A",0)="^52.3DA^"
"RTN","PSOORED5",87,0)
 .S $P(^PSRX(PSORXED("IRXN"),"A",0),"^",3)=$P($G(^PSRX(PSORXED("IRXN"),"A",0)),"^",3)+1,$P(^(0),"^",4)=$P($G(^(0)),"^",4)+1
"RTN","PSOORED5",88,0)
 .D NOW^%DTC S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED5",89,0)
 ..I '$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^") Q
"RTN","PSOORED5",90,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED5",91,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1" K SIG,A,I
"RTN","PSOORED5",92,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED5",93,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED5",94,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED5",95,0)
 .I $G(PSORXED("DOSE",I))]"" S ^PSRX(PSORXED("IRXN"),6,I,1)=PSORXED("DOSE",I)
"RTN","PSOORED5",96,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1 G EX
"RTN","PSOORED5",97,0)
 Q
"RTN","PSOORED5",98,0)
EX I $D(DUOUT)!($D(DTOUT)) S PSONEW("DFLG")=1
"RTN","PSOORED5",99,0)
 ;I $D(DUOUT)!($D(DTOUT)) S:'$G(PSORX("EDIT")) PSONEW("DFLG")=1
"RTN","PSOORED5",100,0)
 G:$G(PSOSIGFL)!($G(PSORX("EDIT")))!($G(PSORXED))!($G(PSOREEDT)) EX1
"RTN","PSOORED5",101,0)
 K PSORXED("DOSE"),PSORXED("NOUN"),PSORXED("VERB"),PSORXED("DOSE ORDERED"),PSORXED("ROUTE"),SIG,PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),PSORXED("ODOSE")
"RTN","PSOORED5",102,0)
EX1 K UNITN,STRE,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ENT,PSORTE,DURA,ERTE,ROU
"RTN","PSOORED5",103,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED5",104,0)
 Q
"RTN","PSOORED5",105,0)
UPD ;updates dosing array
"RTN","PSOORED5",106,0)
 D UPD^PSOORED6
"RTN","PSOORED5",107,0)
 Q
"RTN","PSOORED5",108,0)
JUMP ;
"RTN","PSOORED5",109,0)
 I $G(PSORXED("SCHEDULE",1))']"" W $C(7),!!,"All Dosing Instructions must be entered before Jumping to other Fields!",!! G @FIELD
"RTN","PSOORED5",110,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED5",111,0)
 D FNM^PSOOREDX
"RTN","PSOORED5",112,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED5",113,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED5",114,0)
 D KV
"RTN","PSOORED5",115,0)
 I $G(PSOFROM)'="NEW",'$G(COPY) S DIR("A",1)="* Indicates which fields will create a New Order"
"RTN","PSOORED5",116,0)
 S DIR("A")="Select Field by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED5",117,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED5",118,0)
 G EX
"RTN","PSOORED5",119,0)
 Q
"RTN","PSOORED5",120,0)
LAN ;
"RTN","PSOORED5",121,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOORED5",122,0)
 I $G(OR0),'$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D  K QI,QII Q
"RTN","PSOORED5",123,0)
 .Q:$G(OTHDOS(II))
"RTN","PSOORED5",124,0)
 .F QI=0:0 S QI=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",QI)) Q:'QI  D  Q:$G(QII)
"RTN","PSOORED5",125,0)
 ..Q:$G(PSONEW("DOSE",II))']""
"RTN","PSOORED5",126,0)
 ..I PSONEW("DOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^") S PSONEW("ODOSE",II)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",QI,0),"^",4),QII=1
"RTN","PSOORED5",127,0)
 I $G(Y),$P($G(DOSE(Y)),"^",13)]"" S PSORXED("ODOSE",ENT)=$P(DOSE(Y),"^",13) Q
"RTN","PSOORED5",128,0)
 K QII F I=0:0 S I=$O(^PSDRUG(PSODRUG("IEN"),"DOS2",I)) Q:'I  I DOSE=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^") D  Q:$G(QII)
"RTN","PSOORED5",129,0)
 .S PSORXED("ODOSE",ENT)=$P(^PSDRUG(PSODRUG("IEN"),"DOS2",I,0),"^",4),QII=1
"RTN","PSOORED5",130,0)
 K QII,I
"RTN","PSOORED5",131,0)
 Q
"RTN","PSOORED5",132,0)
 ;
"RTN","PSOORED6")
0^25^B68287627
"RTN","PSOORED6",1,0)
PSOORED6 ;BIR/SAB - edit orders from backdoor ;03/06/96
"RTN","PSOORED6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**78,104,117,133,143,219,148,247,268,260,269,251,372**;DEC 1997;Build 54
"RTN","PSOORED6",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORED6",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED6",5,0)
 ;External reference ^PS(50.606 supported by DBIA 2174
"RTN","PSOORED6",6,0)
DRG ;select drug
"RTN","PSOORED6",7,0)
 S PSORX("EDIT")=1,RX0HLD=RX0
"RTN","PSOORED6",8,0)
 S PSODRUG("IEN")=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),1:$P(RX0,"^",6)),PSODRUG("NAME")=$S($G(PSODRUG("NAME"))]"":PSODRUG("NAME"),1:$P(^PSDRUG($P(RX0,"^",6),0),"^"))
"RTN","PSOORED6",9,0)
 D ^PSODRG I PSODRUG("IEN")=$P(RX0,"^",6) K PSORXED("FLD",6)
"RTN","PSOORED6",10,0)
 D:PSODRUG("IEN")'=$P(RX0,"^",6)  I $G(PSORX("DFLG")) K PSORXED("FLD",6) S PSORXED("DFLG")=1 Q
"RTN","PSOORED6",11,0)
 .S ^TMP("PSORXBO",$J,RX0,0)=1
"RTN","PSOORED6",12,0)
 .D POST^PSODRG
"RTN","PSOORED6",13,0)
 .I '$O(^PSRX(PSORXED("IRXN"),1,0)) S PSORXED("FLD",17)=$G(PSODRUG("COST"))
"RTN","PSOORED6",14,0)
 .I $G(PSORX("DFLG")) K PSORXED("FLD",6),PSODRUG,PSOOIFLG,PSOSIGFL,VALMSG Q
"RTN","PSOORED6",15,0)
 .D KV S DIR(0)="Y",DIR("B")="YES"
"RTN","PSOORED6",16,0)
 .S DIR("A",1)="You have changed the dispense drug from"
"RTN","PSOORED6",17,0)
 .S DIR("A",2)=$P(^PSDRUG($P(PSORXED("RX0"),"^",6),0),"^")_" to "_$P(^PSDRUG(PSODRUG("IEN"),0),"^")_"."
"RTN","PSOORED6",18,0)
 .I $P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2),$O(^PSRX(PSORXED("IRXN"),"SIG1",0)) S DIR("A",3)="" D
"RTN","PSOORED6",19,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S DIR("A",3+I)=$S(I=1:"Current SIG: ",1:"")_$G(^PSRX(PSORXED("IRXN"),"SIG1",I,0))
"RTN","PSOORED6",20,0)
 .S DIR("A")="Do You want to Edit the SIG"
"RTN","PSOORED6",21,0)
 .D ^DIR K DIR I $D(DIRUT) S PSORX("DFLG")=1 D M1
"RTN","PSOORED6",22,0)
 .Q:$D(DIRUT)
"RTN","PSOORED6",23,0)
 .I 'Y D  D DOLST^PSOORED3 D DCHK1^PSODOSUT Q
"RTN","PSOORED6",24,0)
 .. I '$G(PSORXED("ENT")) F  S I=$O(PSORXED("DOSE",I)) Q:'I  S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORED6",25,0)
 .. S ENT=1
"RTN","PSOORED6",26,0)
 .S PSOREEDQ=1 D DOLST^PSOORED3,DOSE^PSOORED3 K PSOREEDQ
"RTN","PSOORED6",27,0)
 .I '$O(PSORXED("DOSE",0)) S PSORX("DFLG")=1 Q
"RTN","PSOORED6",28,0)
 .D:$G(PSOSIGFL) M2
"RTN","PSOORED6",29,0)
 S RX0=RX0HLD K RX0HLD I $G(PSODRUG("OI"))=$G(PSOI) D  Q
"RTN","PSOORED6",30,0)
 .D:$O(^TMP("PSORXDC",$J,0))
"RTN","PSOORED6",31,0)
 ..W !!,"This edit will discontinue the duplicate Rx & change the dispensed drug!"
"RTN","PSOORED6",32,0)
 ..K DIR,X,Y S DIR("A")="Do You Want to Proceed",DIR("B")="NO",DIR(0)="Y"
"RTN","PSOORED6",33,0)
 ..D ^DIR K DIR S:'Y!($D(DIRUT)) PSORXED("DFLG")=1 D:Y DCORD^PSONEW2
"RTN","PSOORED6",34,0)
 .Q:$G(PSORXED("DFLG"))
"RTN","PSOORED6",35,0)
 .I PSODRUG("IEN")'=$P(RX0,"^",6) D
"RTN","PSOORED6",36,0)
 ..S PSORXED("FLD",6)=PSODRUG("IEN"),PSORXED("FLD",39.2)=PSOI
"RTN","PSOORED6",37,0)
 .S:$G(PSODRUG("TRADE NAME"))]"" PSORXED("FLD",6.5)=PSODRUG("TRADE NAME")
"RTN","PSOORED6",38,0)
 .S:$G(PSODRUG("NDC"))]"" PSORXED("FLD",27)=PSODRUG("NDC")
"RTN","PSOORED6",39,0)
 .S:$G(PSODRUG("DAW"))]"" PSORXED("FLD",81)=PSODRUG("DAW")
"RTN","PSOORED6",40,0)
 W !!,"New Orderable Item selected. This edit will create a new prescription!",! D PAUSE^VALM1 S VALMSG="New Orderable Item selected. This edit will create a new prescription!" S (PSOOIFLG,PSOSIGFL)=1
"RTN","PSOORED6",41,0)
 Q
"RTN","PSOORED6",42,0)
PSOCOU ;patient counseling
"RTN","PSOORED6",43,0)
 K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED",DR=41 D EN^DIQ1 K DIC,DIQ
"RTN","PSOORED6",44,0)
 D KV S DIR(0)="52,41" S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR) D ^DIR K DIR,PSORXED(52,DA,DR)
"RTN","PSOORED6",45,0)
 I $D(DIRUT) K PSORXED("FLD",41) D KV Q
"RTN","PSOORED6",46,0)
 S PSORXED("FLD",DR)=Y D  K DIRUT
"RTN","PSOORED6",47,0)
 .I Y D  Q
"RTN","PSOORED6",48,0)
 ..K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED",DR=42 D EN^DIQ1 K DIC,DIQ
"RTN","PSOORED6",49,0)
 ..K DIR,DIRUT S DIR(0)="52,42" S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR) D ^DIR K DIR,PSORXED(52,DA,DR)
"RTN","PSOORED6",50,0)
 ..I $D(DIRUT) K PSORXED("FLD",41),DUOUT,DTOUT Q
"RTN","PSOORED6",51,0)
 ..S PSORXED("FLD",42)=Y
"RTN","PSOORED6",52,0)
 .S PSORXED("FLD",41)=0,PSORXED("FLD",42)="@"
"RTN","PSOORED6",53,0)
 Q
"RTN","PSOORED6",54,0)
PSOI ;select orderable item
"RTN","PSOORED6",55,0)
 W !!,"Current Orderable Item: "_$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSOORED6",56,0)
 S DIC("B")=$P(^PS(50.7,PSOI,0),"^"),DIC="^PS(50.7,",DIC(0)="AEMQZ"
"RTN","PSOORED6",57,0)
 S DIC("S")="I '$P(^PS(50.7,+Y,0),""^"",4)!($P(^(0),""^"",4)'<DT) N PSOF,PSOL S (PSOF,PSOL)=0 F  S PSOL=$O(^PSDRUG(""ASP"",+Y,PSOL)) Q:PSOF!'PSOL  "
"RTN","PSOORED6",58,0)
 S DIC("S")=DIC("S")_"I $P($G(^PSDRUG(PSOL,2)),U,3)[""O"",'$G(^(""I""))!($G(^(""I""))'<DT) S PSOF=1"
"RTN","PSOORED6",59,0)
 S D="B^C" D MIX^DIC1 I "^"[X S PSORXED("DFLG")=1 Q
"RTN","PSOORED6",60,0)
 G:Y<1 PSOI Q:PSOI=+Y
"RTN","PSOORED6",61,0)
 S PSODRUG("OI")=+Y,PSODRUG("OIN")=Y(0,0) K DIC
"RTN","PSOORED6",62,0)
 I PSOI'=PSODRUG("OI") W !!,"New Orderable Item selected. This edit will create a new prescription!",! D  K PSHOLDD Q
"RTN","PSOORED6",63,0)
 .D PAUSE^VALM1 I ($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) S PSORX("DFLG")=1 D M1 Q
"RTN","PSOORED6",64,0)
 .D M2
"RTN","PSOORED6",65,0)
 .S PSHOLDD=$G(PSODRUG("IEN")) K PSODRUG("IEN"),PSODRUG("NAME") S PSODRUG("DEA")="",(PSOOIFLG,PSOSIGFL)=1
"RTN","PSOORED6",66,0)
 .D DREN^PSOORNW2
"RTN","PSOORED6",67,0)
 .I $G(PSHOLDD),$G(PSODRUG("IEN")),$G(PSHOLDD)'=$G(PSODRUG("IEN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSOORED6",68,0)
 ..I $G(PSORX("DFLG")) K PSODRUG S PSODRUG("IEN")=$G(PSHOLDD),PSODRUG("NAME")=$P($G(^PSDRUG(PSODRUG("IEN"),0)),"^") K PSOOIFLG,PSOSIGFL S VALMSG=""
"RTN","PSOORED6",69,0)
 .I '$G(PSODRUG("IEN")) W !!,"DRUG NAME REQUIRED!" D 2^PSOORNW1
"RTN","PSOORED6",70,0)
 .I '$G(PSODRUG("IEN")) K PSORXED("FLD"),INDEL,^TMP($J,"INS1"),PSOSIGFL,VALMSG S PSORXED("DFLG")=1,VALMSG="Dispense Drug NOT Selected!" Q
"RTN","PSOORED6",71,0)
 .D FULL^VALM1,POST^PSODRG S VALMBCK="R"
"RTN","PSOORED6",72,0)
 .I PSORX("DFLG") K PSORXED("FLD"),INDEL,^TMP($J,"INS1"),PSOSIGFL,VALMSG Q
"RTN","PSOORED6",73,0)
 .D KV S DIR(0)="Y",DIR("B")="NO",DIR("A",1)="You have changed the Orderable Item from"
"RTN","PSOORED6",74,0)
 .S DIR("A",2)=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,PSOI,0),"^",2),0),"^")_" to "_PSODRUG("OIN")_" "_$P(^PS(50.606,$P(^PS(50.7,PSODRUG("OI"),0),"^",2),0),"^"),DIR("A")="Do You want to Edit the SIG"
"RTN","PSOORED6",75,0)
 .D ^DIR K DIR I $D(DIRUT) K PSODRUG("OIN"),PSOOIFLG,PSOSIGFL S PSODRUG("OI")=PSOI,VALMSG="",PSORX("DFLG")=1 Q
"RTN","PSOORED6",76,0)
 .I 'Y S PSORX("DFLG")=1 Q
"RTN","PSOORED6",77,0)
 .S PSOREEDQ=1 D DOLST^PSOORED3,DOSE^PSOORED3 K PSOREEDQ
"RTN","PSOORED6",78,0)
 .I '$O(PSORXED("DOSE",0)) S PSORX("DFLG")=1 Q
"RTN","PSOORED6",79,0)
 .D:$G(PSOSIGFL) M2
"RTN","PSOORED6",80,0)
 S PSORXED("FLD",39.2)=PSOI
"RTN","PSOORED6",81,0)
 Q
"RTN","PSOORED6",82,0)
NCPDP ;Reverse previously billed Rx on an edited orderable item or drug. 
"RTN","PSOORED6",83,0)
 N RX,NPSOY
"RTN","PSOORED6",84,0)
 S RX=$G(PSORXED("IRXN")) I RX="" D
"RTN","PSOORED6",85,0)
 . S NPSOY=$O(PSONEW("OLD LAST RX#","")),NPSOY=$G(PSONEW("OLD LAST RX#",NPSOY)),RX=$O(^PSRX("B",NPSOY,RX))
"RTN","PSOORED6",86,0)
 I 'RX Q
"RTN","PSOORED6",87,0)
 D REVERSE^PSOBPSU1(RX,,"DC",7) S NCPDPFLG=0
"RTN","PSOORED6",88,0)
 Q
"RTN","PSOORED6",89,0)
UPDATE ;add new data to file
"RTN","PSOORED6",90,0)
 N RXREF,UPDATE,FLDS,CHGNDC
"RTN","PSOORED6",91,0)
 Q:'$G(PSORXED("IRXN"))
"RTN","PSOORED6",92,0)
 I $O(PSORXED("FLD",0))!($G(^TMP($J,"INS1",0))]"")!($G(INSDEL))!($O(PSORXED("ODOSE",0))) D  G:'Y UPDX
"RTN","PSOORED6",93,0)
 .K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED6",94,0)
 .S DIR(0)="Y",DIR("A")="Are You Sure You Want to Update Rx "_$P(^PSRX(PSORXED("IRXN"),0),"^"),DIR("B")="Yes"
"RTN","PSOORED6",95,0)
 .D ^DIR K DIR I 'Y D M1 Q
"RTN","PSOORED6",96,0)
 .I $D(^PSRX(PSORXED("IRXN"),1,0))  D
"RTN","PSOORED6",97,0)
 ..S RXREF=$P(^PSRX(PSORXED("IRXN"),0),"^",9)-$P(^PSRX(PSORXED("IRXN"),1,0),"^",4)
"RTN","PSOORED6",98,0)
 .E  S RXREF=0
"RTN","PSOORED6",99,0)
 .K X,DIRUT,DUOUT,DTOUT
"RTN","PSOORED6",100,0)
 I $D(PSORXED("FLD",39.3)) D UPDATE^PSODIAG  ;update ICD's after edit
"RTN","PSOORED6",101,0)
 ; - Retrieving fields before changes that are relevant for 3rd Party Billing
"RTN","PSOORED6",102,0)
 D GETS^DIQ(52,PSORXED("IRXN")_",","4;7;8;20;22;27;81","I","FLDS")
"RTN","PSOORED6",103,0)
 K Y S DA=PSORXED("IRXN"),DIE="^PSRX(",FLD=0
"RTN","PSOORED6",104,0)
 F  S FLD=$O(PSORXED("FLD",FLD)) Q:'FLD  D
"RTN","PSOORED6",105,0)
 .I FLD=12!(FLD=24)!(FLD=35) D  Q
"RTN","PSOORED6",106,0)
 ..I FLD=12,PSORXED("FLD",12)="@" S $P(^PSRX(DA,3),"^",7)="" Q
"RTN","PSOORED6",107,0)
 ..I FLD=12,PSORXED("FLD",12)]"" S $P(^PSRX(DA,3),"^",7)=PSORXED("FLD",12) Q
"RTN","PSOORED6",108,0)
 ..I FLD=24,PSORXED("FLD",24)="@" S $P(^PSRX(DA,2),"^",4)="" Q
"RTN","PSOORED6",109,0)
 ..I FLD=24,PSORXED("FLD",24)]"" S $P(^PSRX(DA,2),"^",4)=PSORXED("FLD",24) Q
"RTN","PSOORED6",110,0)
 ..I FLD=35,PSORXED("FLD",35)="@" S $P(^PSRX(DA,"MP"),"^")="" Q
"RTN","PSOORED6",111,0)
 ..I FLD=35,PSORXED("FLD",35)]"" S $P(^PSRX(DA,"MP"),"^")=PSORXED("FLD",35) Q
"RTN","PSOORED6",112,0)
 .I FLD=114 D  Q
"RTN","PSOORED6",113,0)
 ..I PSORXED("FLD",114)="@" K ^PSRX(DA,"INS"),^PSRX(DA,"INS1")
"RTN","PSOORED6",114,0)
 ..I PSORXED("FLD",114)'="@" D
"RTN","PSOORED6",115,0)
 ...S ^PSRX(DA,"INS")=PSORXED("FLD",114)
"RTN","PSOORED6",116,0)
 ...S X=PSORXED("FLD",114) D SIG^PSOHELP Q:$G(INS1)']""
"RTN","PSOORED6",117,0)
 ...S PSORXED("SIG",1)=$E(INS1,2,9999999) K ^PSRX(DA,"INS1")
"RTN","PSOORED6",118,0)
 ...S ^PSRX(DA,"INS1",0)="^52.0115^1^1^"_DT_"^^"
"RTN","PSOORED6",119,0)
 ...S ^PSRX(DA,"INS1",1,0)=PSORXED("SIG",1)
"RTN","PSOORED6",120,0)
 ..D DOLST^PSOORED3 K:PSORXED("FLD",114)="@" PSORXED("SIG") D EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3
"RTN","PSOORED6",121,0)
 .I FLD=27 D  Q
"RTN","PSOORED6",122,0)
 ..I PSORXED("FLD",27)'=$$GETNDC^PSONDCUT(DA,0) D
"RTN","PSOORED6",123,0)
 ...S CHGNDC=1
"RTN","PSOORED6",124,0)
 ...D RXACT^PSOBPSU2(DA,0,"NDC changed from "_$$GETNDC^PSONDCUT(DA,0)_" to "_PSORXED("FLD",27)_".","E")
"RTN","PSOORED6",125,0)
 ..D SAVNDC^PSONDCUT(DA,0,PSORXED("FLD",27),0,1)
"RTN","PSOORED6",126,0)
 .I FLD=81 D SAVDAW^PSODAWUT(DA,0,PSORXED("FLD",81)) Q
"RTN","PSOORED6",127,0)
 .S DR=FLD_"////"_PSORXED("FLD",FLD) D ^DIE
"RTN","PSOORED6",128,0)
 .I FLD=4 D UDPROV^PSOOREDT Q
"RTN","PSOORED6",129,0)
 ;
"RTN","PSOORED6",130,0)
 ; - Re-submitting Rx to ECME due to edits
"RTN","PSOORED6",131,0)
 D RESUB^PSOORED7
"RTN","PSOORED6",132,0)
 ;
"RTN","PSOORED6",133,0)
 I $G(INSDEL) K ^PSRX(DA,"INS"),^PSRX(DA,"INS1") D DOLST^PSOORED3 K PSORXED("SIG") D EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3 G UPDX
"RTN","PSOORED6",134,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED6",135,0)
 .K ^PSRX(DA,"INS"),^PSRX(DA,"INS1"),DD,PSORXED("SIG")
"RTN","PSOORED6",136,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S (PSORXED("SIG",I),^PSRX(DA,"INS1",I,0))=^TMP($J,"INS1",I,0),DD=$G(DD)+1
"RTN","PSOORED6",137,0)
 .S ^PSRX(DA,"INS1",0)=^TMP($J,"INS1",0)
"RTN","PSOORED6",138,0)
 .I DD=1 S ^PSRX(DA,"INS")=^PSRX(DA,"INS1",1,0)
"RTN","PSOORED6",139,0)
 .D DOLST^PSOORED3,EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3
"RTN","PSOORED6",140,0)
 ;
"RTN","PSOORED6",141,0)
UPDX ;
"RTN","PSOORED6",142,0)
 K DIE,DA,DR,FLD,X,Y,PSORXED("FLD"),DD,^TMP($J,"INS1")
"RTN","PSOORED6",143,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED6",144,0)
 Q
"RTN","PSOORED6",145,0)
UPD ;updates dosing array
"RTN","PSOORED6",146,0)
 S HENT=ENT
"RTN","PSOORED6",147,0)
UPD1 ;
"RTN","PSOORED6",148,0)
 I $G(PSORXED("CONJUNCTION",(HENT+1)))]"" S PSORXED("CONJUNCTION",HENT)=PSORXED("CONJUNCTION",(HENT+1)) D  G UPD
"RTN","PSOORED6",149,0)
 .K PSORXED("CONJUNCTION",(HENT+1))
"RTN","PSOORED6",150,0)
 .I $D(PSORXED("DOSE",(HENT+2))) D
"RTN","PSOORED6",151,0)
 ..S PSORXED("DOSE",(HENT+1))=PSORXED("DOSE",(HENT+2))
"RTN","PSOORED6",152,0)
 ..S PSORXED("ODOSE",(HENT+1))=$G(PSORXED("ODOSE",(HENT+2)))
"RTN","PSOORED6",153,0)
 ..S PSORXED("DOSE ORDERED",(HENT+1))=$G(PSORXED("DOSE ORDERED",(HENT+2)))
"RTN","PSOORED6",154,0)
 ..S PSORXED("UNITS",(HENT+1))=$G(PSORXED("UNITS",(HENT+2)))
"RTN","PSOORED6",155,0)
 ..S PSORXED("NOUN",(HENT+1))=$G(PSORXED("NOUN",(HENT+2)))
"RTN","PSOORED6",156,0)
 ..S PSORXED("DURATION",(HENT+1))=$G(PSORXED("DURATION",(HENT+2)))
"RTN","PSOORED6",157,0)
 ..S PSORXED("CONJUNCTION",(HENT+1))=$G(PSORXED("CONJUNCTION",(HENT+2)))
"RTN","PSOORED6",158,0)
 ..S PSORXED("ROUTE",(HENT+1))=$G(PSORXED("ROUTE",(HENT+2)))
"RTN","PSOORED6",159,0)
 ..S PSORXED("SCHEDULE",(HENT+1))=$G(PSORXED("SCHEDULE",(HENT+2)))
"RTN","PSOORED6",160,0)
 ..S PSORXED("VERB",(HENT+1))=$G(PSORXED("VERB",(HENT+2)))
"RTN","PSOORED6",161,0)
 ..K PSORXED("DOSE",(HENT+2)),PSORXED("ODOSE",(HENT+2)),PSORXED("DOSE ORDERED",(HENT+2))
"RTN","PSOORED6",162,0)
 ..K PSORXED("UNITS",(HENT+2)),PSORXED("NOUN",(HENT+2)),PSORXED("DURATION",(HENT+2)),PSORXED("ROUTE",(HENT+2)),PSORXED("SCHEDULE",(HENT+2)),PSORXED("VERB",(HENT+2))
"RTN","PSOORED6",163,0)
 .S HENT=HENT+1
"RTN","PSOORED6",164,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S SENT=$G(SENT)+1
"RTN","PSOORED6",165,0)
 Q
"RTN","PSOORED6",166,0)
 ;
"RTN","PSOORED6",167,0)
M1 D M1^PSOOREDX
"RTN","PSOORED6",168,0)
 Q
"RTN","PSOORED6",169,0)
M2 D M2^PSOOREDX
"RTN","PSOORED6",170,0)
 Q
"RTN","PSOORFI3")
0^35^B74671626
"RTN","PSOORFI3",1,0)
PSOORFI3 ;BIR/RTR-finish CPRS orders by Clinic ; 4/26/11 2:05pm
"RTN","PSOORFI3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,27,32,46,84,99,130,117,139,172,225,300,384,372**;DEC 1997;Build 54
"RTN","PSOORFI3",3,0)
 ;SC(-2675,40.8-728,51.2-2226,50.607-2221,55-2228,PSSLOCK-2789,DPT-10035,ORX2-867
"RTN","PSOORFI3",4,0)
 ;
"RTN","PSOORFI3",5,0)
 K ^TMP($J,"PSOCL"),^TMP($J,"PSOCLX"),PSOCLIN,PSOCLINF,PSOXINST
"RTN","PSOORFI3",6,0)
 N PSOCFLAG,PSONPTRX,PSOINPTR,PSCLP,PSOCLINS,PSOSTC,PSOLGD,PSODIEN,PSOCTMP
"RTN","PSOORFI3",7,0)
 K DIR S DIR(0)="SMB^C:CLINIC;S:SORT GROUP;E:EXIT",DIR("A")="Select By",DIR("B")="Clinic",DIR("?",1)="Enter 'C' to process orders for one individual Clinic,"
"RTN","PSOORFI3",8,0)
 S DIR("?",2)="      'S' to process orders for all Clinics associated with a Sort Group,",DIR("?",3)="      '^' or 'E' to exit" S DIR("?")=" "
"RTN","PSOORFI3",9,0)
 W ! D ^DIR K DIR I $D(DTOUT)!($D(DUOUT))!(Y="E") W ! G EXIT
"RTN","PSOORFI3",10,0)
 I Y="S" G SORT
"RTN","PSOORFI3",11,0)
CLIN W ! K DIC S DIC="^SC(",DIC(0)="QEAMZ",DIC("A")="Select CLINIC: " D ^DIC K DIC I Y<1!($D(DTOUT))!($D(DUOUT)) G EXIT
"RTN","PSOORFI3",12,0)
 S PSOCLIN=+Y,PSOCLINF=1 D CHECK I $G(PSOCFLAG) D INSTNM^PSOORFI2 W !!,"You are signed in under the "_$G(PSODINST)_" CPRS Ordering",!,"Institution, which does not match the Institution for this Clinic!",! K PSODINST G CLIN
"RTN","PSOORFI3",13,0)
 S ^TMP($J,"PSOCL",PSOCLIN)=PSOCLIN K PSOCLIN G START
"RTN","PSOORFI3",14,0)
SORT W ! K DIC S DIC="^PS(59.8,",DIC(0)="QEAMZ",DIC("A")="Select CLINIC SORT GROUP: " D ^DIC K DIC I Y<1!($D(DTOUT))!($D(DUOUT)) G EXIT
"RTN","PSOORFI3",15,0)
 S PSOCLINS=+Y
"RTN","PSOORFI3",16,0)
 K ^TMP($J,"PSOCL"),^TMP($J,"PSOCLX") F PSCLP=0:0 S PSCLP=$O(^PS(59.8,PSOCLINS,1,PSCLP)) Q:'PSCLP  S PSOSTC=+$P($G(^PS(59.8,PSOCLINS,1,PSCLP,0)),"^") S:$G(PSOSTC)&($D(^SC(PSOSTC,0))) ^TMP($J,"PSOCL",PSOSTC)=PSOSTC
"RTN","PSOORFI3",17,0)
 I '$O(^TMP($J,"PSOCL",0)) W !!,"There are no Clinics associated with this Sort Group!",! K ^TMP($J,"PSOCL") G SORT
"RTN","PSOORFI3",18,0)
 F PSCLP=0:0 S PSCLP=$O(^TMP($J,"PSOCL",PSCLP)) Q:'PSCLP  S PSOCLIN=PSCLP D CHECK I $G(PSOCFLAG) S ^TMP($J,"PSOCLX",PSCLP)=PSCLP K ^TMP($J,"PSOCL",PSCLP)
"RTN","PSOORFI3",19,0)
 I $O(^TMP($J,"PSOCLX",0)) H 1 W @IOF W !,"Orders for these Clinics in the Sort Group will not be displayed for Finishing",!,"because the CPRS Ordering Institution does not match the Institution that is",!,"associated with the Clinic:",! D
"RTN","PSOORFI3",20,0)
 .F PSCLP=0:0 S PSCLP=$O(^TMP($J,"PSOCLX",PSCLP)) Q:'PSCLP  D:($Y+4)>IOSL  W !,$P($G(^SC(PSCLP,0)),"^")
"RTN","PSOORFI3",21,0)
 ..W ! K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" D ^DIR K DIR W @IOF
"RTN","PSOORFI3",22,0)
 I $O(^TMP($J,"PSOCLX",0)) D EOP
"RTN","PSOORFI3",23,0)
 K ^TMP($J,"PSOCLX") I '$O(^TMP($J,"PSOCL",0)) W !!,"There are no Clinics that have a matching Institution!",! D EOP G SORT
"RTN","PSOORFI3",24,0)
 ;
"RTN","PSOORFI3",25,0)
 S PSOCLINF=2
"RTN","PSOORFI3",26,0)
START K MEDP,MEDA,PSOQUIT,POERR("QFLG"),POERR("DFLG"),DIR
"RTN","PSOORFI3",27,0)
 G:'$O(^TMP($J,"PSOCL",0)) EXIT
"RTN","PSOORFI3",28,0)
 S PATA=0 F PSOCLIN=0:0 S PSOCLIN=$O(^TMP($J,"PSOCL",PSOCLIN)) Q:'PSOCLIN!($G(POERR("QFLG")))  F PSOLGD=0:0 S PSOLGD=$O(^PS(52.41,"ACL",PSOCLIN,PSOLGD)) Q:'PSOLGD!($G(POERR("QFLG")))  D
"RTN","PSOORFI3",29,0)
 .F PSODIEN=0:0 S PSODIEN=$O(^PS(52.41,"ACL",PSOCLIN,PSOLGD,PSODIEN)) Q:'PSODIEN!($G(POERR("QFLG")))  D
"RTN","PSOORFI3",30,0)
 ..I $P($G(^PS(52.41,PSODIEN,0)),"^",3)'="NW",$P($G(^(0)),"^",3)'="RNW",$P($G(^(0)),"^",3)'="RF" Q
"RTN","PSOORFI3",31,0)
 ..I $G(PSOPINST)'=$P($G(^PS(52.41,PSODIEN,"INI")),"^") Q
"RTN","PSOORFI3",32,0)
 ..Q:$G(PAT($P(^PS(52.41,PSODIEN,0),"^",2)))=$P(^PS(52.41,PSODIEN,0),"^",2)  S PAT=$P(^PS(52.41,PSODIEN,0),"^",2)
"RTN","PSOORFI3",33,0)
 ..I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI3",34,0)
 ..D LK^PSOORFIN I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI3",35,0)
 ..I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP^PSOORFIN Q
"RTN","PSOORFI3",36,0)
 ..S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(+$G(PAT),0)),"^"),PATA=PAT
"RTN","PSOORFI3",37,0)
 ..D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) K PSOFIN S POERR("QFLG")=0 S PSONOLCK=1,PSOPTLOK=PAT D OERR^PSORX1 S PSOFIN=1 D QU^PSOORFIN S X=PSOPTLOK D KLLP^PSOORFIN,ULP^PSOORFIN,KLL^PSOORFIN Q
"RTN","PSOORFI3",38,0)
 ..D SDFN^PSOORFIN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP^PSOORFIN K PSOQFLG Q
"RTN","PSOORFI3",39,0)
 ..S PAT(PAT)=PAT
"RTN","PSOORFI3",40,0)
 ..F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))  I '$P($G(^PS(52.41,ORD,0)),"^",23) D
"RTN","PSOORFI3",41,0)
 ...S PSODFN=PAT D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOORFI3",42,0)
 ...D LK1^PSOORFIN,ORD^PSOORFIN S X=PAT D ULP^PSOORFIN
"RTN","PSOORFI3",43,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI3",44,0)
 ;
"RTN","PSOORFI3",45,0)
EXIT K ^TMP($J,"PSOCL"),^TMP($J,"PSOCLX"),PSOCLIN,PSOCLINF,PSOXINST G EX^PSOORFIN
"RTN","PSOORFI3",46,0)
 Q
"RTN","PSOORFI3",47,0)
CHECK ; check Institution
"RTN","PSOORFI3",48,0)
 K PSOXINST,PSOCFLAG
"RTN","PSOORFI3",49,0)
 I $P($G(^SC(PSOCLIN,0)),"^",4),$P($G(^(0)),"^",4)'=$G(PSOPINST) S PSOCFLAG=1 Q
"RTN","PSOORFI3",50,0)
 I $P($G(^SC(PSOCLIN,0)),"^",4) Q
"RTN","PSOORFI3",51,0)
 S PSONPTRX=$P($G(^SC(PSOCLIN,0)),"^",15)
"RTN","PSOORFI3",52,0)
 I '$G(PSONPTRX) S PSONPTRX=$O(^DG(40.8,0))
"RTN","PSOORFI3",53,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOORFI3",54,0)
 S PSOINPTR=+$$SITE^VASITE(DT,PSONPTRX) I PSOINPTR'=$G(PSOPINST) S PSOCFLAG=1
"RTN","PSOORFI3",55,0)
 Q
"RTN","PSOORFI3",56,0)
EOP W ! K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" D ^DIR K DIR
"RTN","PSOORFI3",57,0)
 Q
"RTN","PSOORFI3",58,0)
L1 ;Lock single order
"RTN","PSOORFI3",59,0)
 I '$G(ORD) Q
"RTN","PSOORFI3",60,0)
 K PSOMSG D PSOL^PSSLOCK(+ORD_"S") I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"This Order is being edited by another person."),! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSOORFI3",61,0)
 Q
"RTN","PSOORFI3",62,0)
UL1 ;Unlock single order
"RTN","PSOORFI3",63,0)
 I '$G(ORD) Q
"RTN","PSOORFI3",64,0)
 I '$D(^PS(52.41,ORD,0)) D  Q
"RTN","PSOORFI3",65,0)
 . D UNLK1^ORX2(+$G(OR0))
"RTN","PSOORFI3",66,0)
 . Q
"RTN","PSOORFI3",67,0)
 D PSOUL^PSSLOCK(+ORD_"S")
"RTN","PSOORFI3",68,0)
 Q
"RTN","PSOORFI3",69,0)
DOSE ;pending orders
"RTN","PSOORFI3",70,0)
 K DOENT S DS=1
"RTN","PSOORFI3",71,0)
 F I=0:0 S I=$O(^PS(52.41,ORD,1,I)) Q:'I  S DOSE=$G(^PS(52.41,ORD,1,I,1)),DOSE1=$G(^(2)) D  D DOSE1
"RTN","PSOORFI3",72,0)
 .S PSONEW("DOSE",I)=$P(DOSE1,"^"),PSONEW("DOSE ORDERED",I)=$P(DOSE1,"^",2),PSONEW("UNITS",I)=$P(DOSE,"^",9),PSONEW("NOUN",I)=$P(DOSE,"^",5)
"RTN","PSOORFI3",73,0)
 .S:$P(DOSE,"^",9) UNITS=$P(^PS(50.607,$P(DOSE,"^",9),0),"^")
"RTN","PSOORFI3",74,0)
 .S PSONEW("VERB",I)=$P(DOSE,"^",10),PSONEW("ROUTE",I)=$P(DOSE,"^",8)
"RTN","PSOORFI3",75,0)
 .S ROUTE="" S:$P(DOSE,"^",8) ROUTE=$P(^PS(51.2,$P(DOSE,"^",8),0),"^") ;PSO*7*384
"RTN","PSOORFI3",76,0)
 .S PSONEW("SCHEDULE",I)=$P(DOSE,"^"),PSONEW("DURATION",I)=$P(DOSE,"^",2)
"RTN","PSOORFI3",77,0)
 .S DOENT=$G(DOENT)+1 S PSONEW("CONJUNCTION",I)=$S($P(DOSE,"^",6)="A":"AND",$P(DOSE,"^",6)="S":"THEN",$P(DOSE,"^",6)="X":"EXCEPT",1:"")
"RTN","PSOORFI3",78,0)
 .I 'PSONEW("DOSE ORDERED",I),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI3",79,0)
 .S:$G(DS) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)"
"RTN","PSOORFI3",80,0)
 S PSONEW("ENT")=DOENT K DOSE,DOSE1,I,UNITS,ROUTE,DOENT
"RTN","PSOORFI3",81,0)
 Q
"RTN","PSOORFI3",82,0)
DOSE1 I $G(DS)=1 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        *Dosage:" D FMD G DU
"RTN","PSOORFI3",83,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            *Dosage:" D FMD
"RTN","PSOORFI3",84,0)
DU I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI3",85,0)
 I PSONEW("DOSE ORDERED",I),$G(PSONEW("VERB",I))]"" D
"RTN","PSOORFI3",86,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI3",87,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Dispense Units: "_$S($E(PSONEW("DOSE ORDERED",I),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",I)
"RTN","PSOORFI3",88,0)
 I PSONEW("NOUN",I) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Noun: "_PSONEW("NOUN",I)
"RTN","PSOORFI3",89,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="             *Route: "_$G(ROUTE)
"RTN","PSOORFI3",90,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOORFI3",91,0)
 I $P(DOSE,"^",2)]"" D
"RTN","PSOORFI3",92,0)
 .S DUR=$S($E($P(DOSE,"^",2),1)'?.N:$E($P(DOSE,"^",2),2,99)_$E($P(DOSE,"^",2),1),1:$P(DOSE,"^",2))
"RTN","PSOORFI3",93,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Duration: "_DUR_" ("_$S($P(DOSE,"^",2)["M":"MINUTES",$P(DOSE,"^",2)["H":"HOURS",$P(DOSE,"^",2)["L":"MONTHS",$P(DOSE,"^",2)["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOORFI3",94,0)
 I $P(DOSE,"^",6)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       *Conjunction: "_$S($P(DOSE,"^",6)="A":"AND",$P(DOSE,"^",6)="S":"THEN",$P(DOSE,"^",6)="X":"EXCEPT",1:"")
"RTN","PSOORFI3",95,0)
 Q
"RTN","PSOORFI3",96,0)
DOSE2 ;displays pending order after edits
"RTN","PSOORFI3",97,0)
 S DS=1
"RTN","PSOORFI3",98,0)
 F I=1:1:PSONEW("ENT") Q:'I  D  D DOSE3 K COJ
"RTN","PSOORFI3",99,0)
 .S:$G(PSONEW("UNITS",I))]"" UNITS=$P(^PS(50.607,PSONEW("UNITS",I),0),"^") S:$G(PSONEW("ROUTE",I))]"" ROUTE=$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOORFI3",100,0)
 .S DUR=$G(PSONEW("DURATION",I)) S:$G(PSONEW("CONJUNCTION",I))]"" COJ=PSONEW("CONJUNCTION",I)
"RTN","PSOORFI3",101,0)
 .S NOUN=PSONEW("NOUN",I),VERB=$G(PSONEW("VERB",I))
"RTN","PSOORFI3",102,0)
 .I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI3",103,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI3",104,0)
 .S:$G(DS) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)"
"RTN","PSOORFI3",105,0)
 K I,UNITS,ROUTE,DUR,COJ,VERB,NOUN
"RTN","PSOORFI3",106,0)
 Q
"RTN","PSOORFI3",107,0)
DOSE3 I $G(DS)=1 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        *Dosage:" D FMD G DO
"RTN","PSOORFI3",108,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            *Dosage:" D FMD
"RTN","PSOORFI3",109,0)
DO I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI3",110,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI3",111,0)
 I $G(PSONEW("DOSE ORDERED",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Dispense Units: "_$S($E(PSONEW("DOSE ORDERED",I),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",I)
"RTN","PSOORFI3",112,0)
 I $G(PSONEW("DOSE ORDERED",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               NOUN: "_PSONEW("NOUN",I)
"RTN","PSOORFI3",113,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="             *Route: "_$G(ROUTE)
"RTN","PSOORFI3",114,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOORFI3",115,0)
 I $G(DUR)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Duration: "_DUR_" ("_$S(DUR["M":"MINUTES",DUR["H":"HOURS",DUR["L":"MONTHS",DUR["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOORFI3",116,0)
 I $G(COJ)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       *Conjunction: "_$S(COJ="A":"AND",COJ="T":"THEN",COJ="X":"EXCEPT",1:"")
"RTN","PSOORFI3",117,0)
 Q
"RTN","PSOORFI3",118,0)
FMD Q:$G(PSONEW("DOSE",II))']""  S MIG=PSONEW("DOSE",II)
"RTN","PSOORFI3",119,0)
 I $E(MIG,1)=".",$G(PSONEW("DOSE ORDERED",II)) S MIG="0"_MIG
"RTN","PSOORFI3",120,0)
 F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI3",121,0)
 I $G(UNITS)]"" S:$L(^TMP("PSOPO",$J,IEN,0)_" ("_UNITS_")")>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" ("_UNITS_")"
"RTN","PSOORFI3",122,0)
 K DS,MIG,SG
"RTN","PSOORFI3",123,0)
 I '$G(PSONEW("DOSE ORDERED",II)),$P($G(^PS(55,PSODFN,"LAN")),"^") D LAN^PSOORED5
"RTN","PSOORFI3",124,0)
 Q
"RTN","PSOORFI3",125,0)
SQR ;
"RTN","PSOORFI3",126,0)
 D SQR^PSOORFIN
"RTN","PSOORFI3",127,0)
 Q
"RTN","PSOORFI3",128,0)
SQN ;
"RTN","PSOORFI3",129,0)
 K MAXRF,PSOSIG,MPSDY,PSOMAX,STA,PSORX0,ORCHK,ORDRG
"RTN","PSOORFI3",130,0)
 I $G(PSOQUIT) S PSOQQ=1 K PSOQUIT
"RTN","PSOORFI3",131,0)
 Q
"RTN","PSOORFI5")
0^36^B47045862
"RTN","PSOORFI5",1,0)
PSOORFI5 ;BIR/SJA-finish cprs orders ; 8/27/08 4:47pm
"RTN","PSOORFI5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,315,266,391,372**;DEC 1997;Build 54
"RTN","PSOORFI5",3,0)
 ;External references UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORFI5",4,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOORFI5",5,0)
 ;
"RTN","PSOORFI5",6,0)
FLG W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="FLAGGED^FLAGGED"
"RTN","PSOORFI5",7,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",8,0)
 .Q:'$D(^PS(52.41,PSOD,0))!('$P($G(^PS(52.41,PSOD,0)),"^",23))
"RTN","PSOORFI5",9,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",10,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",11,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",12,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",13,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",14,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",15,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",16,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",17,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",18,0)
 ..I $P($G(^PS(52.41,ORD,0)),"^",23) D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",19,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",20,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",21,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",22,0)
 G EX
"RTN","PSOORFI5",23,0)
 ;
"RTN","PSOORFI5",24,0)
PRI ; Called from PSOORFIN due to it's routine size.
"RTN","PSOORFI5",25,0)
 K DIR S PSOSORT="PRIORITY"
"RTN","PSOORFI5",26,0)
 S DIR("A")="Select Priority",DIR(0)="SBM^S:STAT;E:EMERGENCY;R:ROUTINE",DIR("B")="ROUTINE"
"RTN","PSOORFI5",27,0)
 D ^DIR G:$D(DIRUT) EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFI5",28,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",29,0)
 .Q:$P($G(^PS(52.41,PSOD,0)),"^",23)
"RTN","PSOORFI5",30,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFI5",31,0)
 .;PSO*7*266
"RTN","PSOORFI5",32,0)
 .I PAT'=PATA K PSORX("DOSING OFF") D LBL^PSOORFIN
"RTN","PSOORFI5",33,0)
 .I '$O(^PS(52.41,"AP",PAT,PSRT,0)) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",34,0)
 .D PRI^PSOORFI2 I $G(PSZFIN) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",35,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",36,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP Q
"RTN","PSOORFI5",37,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",38,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",39,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",40,0)
 .D PP S ORD=0 D @PSRT S PAT(PAT)=PAT
"RTN","PSOORFI5",41,0)
 .S X=PAT D ULP
"RTN","PSOORFI5",42,0)
 ;PSO*7*266
"RTN","PSOORFI5",43,0)
 D LBL^PSOORFIN
"RTN","PSOORFI5",44,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",45,0)
EX D EX^PSOORFI1
"RTN","PSOORFI5",46,0)
 Q
"RTN","PSOORFI5",47,0)
LK D LOCK^PSOORFI1
"RTN","PSOORFI5",48,0)
 Q
"RTN","PSOORFI5",49,0)
LK1 D LOCK1^PSOORFI1 Q
"RTN","PSOORFI5",50,0)
QU I $G(PSOQUIT) S POERR("QFLG")=1 K PSOQUIT
"RTN","PSOORFI5",51,0)
 S:$G(PSOQFLG) PAT(PAT)=PAT
"RTN","PSOORFI5",52,0)
 Q
"RTN","PSOORFI5",53,0)
ULP K PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOORFI5",54,0)
 D CLEAN^PSOVER1
"RTN","PSOORFI5",55,0)
 I '$G(X) Q
"RTN","PSOORFI5",56,0)
 D UL^PSSLOCK(X) Q
"RTN","PSOORFI5",57,0)
KLL K PSOPTLOK
"RTN","PSOORFI5",58,0)
 Q
"RTN","PSOORFI5",59,0)
KLLP K PSONOLCK
"RTN","PSOORFI5",60,0)
 Q
"RTN","PSOORFI5",61,0)
SPL D SPL^PSOORFI4
"RTN","PSOORFI5",62,0)
 Q
"RTN","PSOORFI5",63,0)
SDFN S PSODFN=+$G(PSODFN)
"RTN","PSOORFI5",64,0)
 Q
"RTN","PSOORFI5",65,0)
PP D PP^PSOORFI4
"RTN","PSOORFI5",66,0)
 Q
"RTN","PSOORFI5",67,0)
KQ K PSOQUIT,POERR("QFLG")
"RTN","PSOORFI5",68,0)
 Q
"RTN","PSOORFI5",69,0)
S D S^PSOORFI2 ; Process STAT priority
"RTN","PSOORFI5",70,0)
 Q
"RTN","PSOORFI5",71,0)
 ;
"RTN","PSOORFI5",72,0)
E D E^PSOORFI2 ; Process EMERGENCY priority
"RTN","PSOORFI5",73,0)
 Q
"RTN","PSOORFI5",74,0)
 ;
"RTN","PSOORFI5",75,0)
R D R^PSOORFI2 ; Process ROUTINE priority
"RTN","PSOORFI5",76,0)
 Q
"RTN","PSOORFI5",77,0)
 ;
"RTN","PSOORFI5",78,0)
LMDISP(ORD) ; Backdoor ListManager Display of Flag/Unflag Informaiton
"RTN","PSOORFI5",79,0)
 N FLAG
"RTN","PSOORFI5",80,0)
 K FLAGLINE S ORD=+$G(ORD) I 'ORD Q
"RTN","PSOORFI5",81,0)
 ;
"RTN","PSOORFI5",82,0)
 I '$G(^PS(52.41,ORD,"FLG")) Q
"RTN","PSOORFI5",83,0)
 ; S X=IORVON_"Flagged"_IORVOFF
"RTN","PSOORFI5",84,0)
 D GETS^DIQ(52.41,ORD,"33;34;35;36;37;38","IE","FLAG")
"RTN","PSOORFI5",85,0)
 S L1="Flagged by "_$E(FLAG(52.41,ORD_",",34,"E"),1,30)_" on "_$$FMTE^XLFDT(FLAG(52.41,ORD_",",33,"I"),2)_": "
"RTN","PSOORFI5",86,0)
 S LEN=80-$L(L1),L1=L1_$E(FLAG(52.41,ORD_",",35,"E"),1,LEN),L2=$E(FLAG(52.41,ORD_",",35,"E"),LEN+1,999)
"RTN","PSOORFI5",87,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L1,FLAGLINE(IEN)=7
"RTN","PSOORFI5",88,0)
 I L2'="" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L2
"RTN","PSOORFI5",89,0)
 I FLAG(52.41,ORD_",",36,"I")'="" D
"RTN","PSOORFI5",90,0)
 . S L1="Unflagged by "_$E(FLAG(52.41,ORD_",",37,"E"),1,30)_" on "_$$FMTE^XLFDT(FLAG(52.41,ORD_",",36,"I"),2)_": "
"RTN","PSOORFI5",91,0)
 . S LEN=80-$L(L1),L1=L1_$E(FLAG(52.41,ORD_",",38,"E"),1,LEN),L2=$E(FLAG(52.41,ORD_",",38,"E"),LEN+1,999)
"RTN","PSOORFI5",92,0)
 . S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L1,FLAGLINE(IEN)=9
"RTN","PSOORFI5",93,0)
 . I L2'="" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=L2
"RTN","PSOORFI5",94,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" "
"RTN","PSOORFI5",95,0)
 Q
"RTN","PSOORFI5",96,0)
 ;
"RTN","PSOORFI5",97,0)
CS ; Digitally Signed CS - PSO*7*391
"RTN","PSOORFI5",98,0)
 K DIR N PSOCSRT S DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;B:BOTH;E:EXIT",DIR("B")="BOTH" D ^DIR
"RTN","PSOORFI5",99,0)
 Q:$D(DIRUT)!(Y="E")
"RTN","PSOORFI5",100,0)
 S PSOCSRT=$S(Y="B":1,1:Y)
"RTN","PSOORFI5",101,0)
 W !!,"Select a schedule(s)"
"RTN","PSOORFI5",102,0)
 K DIR S PSOSORT="DIGITALLY SIGNED"
"RTN","PSOORFI5",103,0)
 S DIR("A")="Select Schedule(s)",DIR(0)="S^1:SCHEDULE II;2:SCHEDULES III - V;3:SCHEDULES II - V;E:EXIT",DIR("B")=3
"RTN","PSOORFI5",104,0)
 D ^DIR G:$D(DIRUT)!(Y="E") EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFI5",105,0)
 N PDEA,OR0 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFI5",106,0)
 .Q:'$D(^PS(52.41,PSOD,0))
"RTN","PSOORFI5",107,0)
 .S OR0=^PS(52.41,PSOD,0)
"RTN","PSOORFI5",108,0)
 .Q:$P(OR0,"^",23)!('$P(OR0,"^",24))
"RTN","PSOORFI5",109,0)
 .S PDEA=0 D PDEA Q:'PDEA!(PDEA'=PSRT)
"RTN","PSOORFI5",110,0)
 .I 'PSOCSRT,PSOCSRT'=$P(OR0,"^",17) Q
"RTN","PSOORFI5",111,0)
 .Q:$G(PAT($P(OR0,"^",2)))=$P(OR0,"^",2)  S PAT=$P(OR0,"^",2)
"RTN","PSOORFI5",112,0)
 .I PAT'=PATA K PSORX("DOSING OFF") I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",113,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFI5",114,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFI5",115,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFI5",116,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFI5",117,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFI5",118,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFI5",119,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFI5",120,0)
 ..Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFI5",121,0)
 ..S OR0=^PS(52.41,ORD,0)
"RTN","PSOORFI5",122,0)
 ..Q:$P(OR0,"^",23)!('$P(OR0,"^",24))
"RTN","PSOORFI5",123,0)
 ..I 'PSOCSRT,PSOCSRT'=$P(OR0,"^",17) Q
"RTN","PSOORFI5",124,0)
 ..Q:$P(OR0,"^",3)="DC"!($P(OR0,"^",3)="DE")
"RTN","PSOORFI5",125,0)
 ..S PDEA=0 D PDEA Q:'PDEA!(PDEA'=PSRT)
"RTN","PSOORFI5",126,0)
 ..D PP,LK1,ORD^PSOORFIN
"RTN","PSOORFI5",127,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFI5",128,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL^PSOORFIN
"RTN","PSOORFI5",129,0)
 I $G(PSOQUIT) K PSOQUIT D EX G ^PSOORFIN
"RTN","PSOORFI5",130,0)
 G EX
"RTN","PSOORFI5",131,0)
 ;
"RTN","PSOORFI5",132,0)
PDEA ;
"RTN","PSOORFI5",133,0)
 I +$P(OR0,"^",9) S PDEA=$P($G(^PSDRUG($P(OR0,"^",9),0)),"^",3)
"RTN","PSOORFI5",134,0)
 E  S PDEA=$$OIDEA^PSSUTLA1($P(OR0,"^",8),"O")
"RTN","PSOORFI5",135,0)
 S PDEA=$S(PDEA[2:1,PDEA[3!(PDEA[4)!(PDEA[5):2,1:0)
"RTN","PSOORFI5",136,0)
 I PDEA,PSRT=3 S PDEA=3
"RTN","PSOORFI5",137,0)
 Q
"RTN","PSOORFI5",138,0)
 ;
"RTN","PSOORFI5",139,0)
PRV(PROV,DRG,ORN) ;
"RTN","PSOORFI5",140,0)
 N DETN,DEA,I,LBL,VADD,SPC
"RTN","PSOORFI5",141,0)
 I PROV="" Q
"RTN","PSOORFI5",142,0)
 S DEA=$$DEA^XUSER(0,PROV)
"RTN","PSOORFI5",143,0)
 S LBL=$S(DEA["-":" VA#: ",1:"DEA#: ") I $G(ADDS) S LBL=" "_LBL
"RTN","PSOORFI5",144,0)
 I DRG,$$DETOX^PSSOPKI(DRG) S DETN=$$DETOX^XUSER(PROV)
"RTN","PSOORFI5",145,0)
 S $P(SPC," ",($S($G(ADDS):30,1:33)-$L(DEA)))=" "
"RTN","PSOORFI5",146,0)
 I (DEA'="")!($G(DETN)'="") S IEN=IEN+1,$E(^TMP("PSOPO",$J,IEN,0),16)=LBL_DEA_$S($G(DETN)]"":SPC_"DETOX#: "_$G(DETN),1:"")
"RTN","PSOORFI5",147,0)
 I $G(ORN) D PRVAD^PSOPKIV2 I $G(VADD(1))]"" D
"RTN","PSOORFI5",148,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"       Site Address: "_VADD(1)
"RTN","PSOORFI5",149,0)
 .S:VADD(2)'="" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"                     "_VADD(2) S:VADD(3)'="" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(ADDS):" ",1:"")_"                     "_VADD(3)
"RTN","PSOORFI5",150,0)
 Q
"RTN","PSOORFI5",151,0)
 ;
"RTN","PSOORFIN")
0^32^B64877046
"RTN","PSOORFIN",1,0)
PSOORFIN ;BIR/SAB-finish cprs orders ; 8/27/08 4:57pm
"RTN","PSOORFIN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,15,27,32,44,46,84,106,111,117,131,146,139,195,225,315,266,338,391,372**;DEC 1997;Build 54
"RTN","PSOORFIN",3,0)
 ;PSSLOCK-2789,PSDRUG-221,50.7-2223,55-2228,50.606-2174
"RTN","PSOORFIN",4,0)
 ;PSO*7*266 Change order of calling ^PSOBING1 and ^PSORXL
"RTN","PSOORFIN",5,0)
 ;
"RTN","PSOORFIN",6,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) D MSG^PSODPT G EX
"RTN","PSOORFIN",7,0)
 D INST^PSOORFI2 I $G(PSOIQUIT) K PSOIQUIT G EX
"RTN","PSOORFIN",8,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSOORFIN",9,0)
 S (PSOFIN,POERR)=1
"RTN","PSOORFIN",10,0)
 K PSOBCK,MEDA,MEDP,SRT,DIR D KQ
"RTN","PSOORFIN",11,0)
 S DIR("?")="^D ST^PSOORFI1",DIR("A")="Select By",DIR("B")="PATIENT"
"RTN","PSOORFIN",12,0)
 S DIR(0)="SMB^PA:PATIENT;RT:ROUTE;PR:PRIORITY;CL:CLINIC;FL:FLAGGED;E:EXIT"
"RTN","PSOORFIN",13,0)
 I $$PATCH^XPDUTL("PSO*7.0*391") S DIR(0)="SMB^PA:PATIENT;RT:ROUTE;PR:PRIORITY;CL:CLINIC;FL:FLAGGED;CS:CONTROLLED SUBSTANCES;E:EXIT"
"RTN","PSOORFIN",14,0)
 D ^DIR I $D(DIRUT)!(Y="E") G EX
"RTN","PSOORFIN",15,0)
 K:Y="FL" ^TMP($J,"PSOFLPO") ;file not needed when selection="FL"
"RTN","PSOORFIN",16,0)
 G:Y="PA" PAT G:Y="PR" PRI^PSOORFI5 G:Y="CL" ^PSOORFI3 G:Y="FL" FLG^PSOORFI5 G:Y="CS"&($$PATCH^XPDUTL("PSO*7.0*391")) CS^PSOORFI5
"RTN","PSOORFIN",17,0)
 K DIR S PSOSORT="ROUTE"
"RTN","PSOORFIN",18,0)
 S DIR("?")="^D RT^PSOORFI1",DIR("A")="Route",DIR(0)="SBM^W:WINDOW;M:MAIL;C:CLINIC;E:EXIT",DIR("B")="WINDOW"
"RTN","PSOORFIN",19,0)
 D ^DIR G:$D(DIRUT)!(Y="E") EX S PSOSORT=PSOSORT_"^"_Y,PSRT=Y
"RTN","PSOORFIN",20,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFIN",21,0)
 .Q:$P($G(^PS(52.41,PSOD,0)),"^",23)
"RTN","PSOORFIN",22,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFIN",23,0)
 .;PSO*7*266
"RTN","PSOORFIN",24,0)
 .I PAT'=PATA D LBL
"RTN","PSOORFIN",25,0)
 .I '$O(^PS(52.41,"AC",PAT,PSRT,0)) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",26,0)
 .D RTE^PSOORFI2 I $G(PSZFIN) S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",27,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",28,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP Q
"RTN","PSOORFIN",29,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFIN",30,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFIN",31,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFIN",32,0)
 .D PP S ORD=0 D @PSRT S PAT(PAT)=PAT
"RTN","PSOORFIN",33,0)
 .S X=PAT D ULP
"RTN","PSOORFIN",34,0)
 ;PSO*7*266
"RTN","PSOORFIN",35,0)
 K POERR("QFLG"),PSOQFLG,PSOPTPST,MAIL,WIN,CLI D LBL
"RTN","PSOORFIN",36,0)
 I $G(PSOQUIT) K PSOQUIT D EX G PSOORFIN
"RTN","PSOORFIN",37,0)
EX D EX^PSOORFI1
"RTN","PSOORFIN",38,0)
 Q
"RTN","PSOORFIN",39,0)
W D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S MAIL=1
"RTN","PSOORFIN",40,0)
 Q:$G(POERR("QFLG"))  I $G(MAIL) S ORD=0 D
"RTN","PSOORFIN",41,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",42,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",43,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",44,0)
 Q
"RTN","PSOORFIN",45,0)
M D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S WIN=1
"RTN","PSOORFIN",46,0)
 Q:$G(POERR("QFLG"))  I $G(WIN) S ORD=0 D
"RTN","PSOORFIN",47,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD
"RTN","PSOORFIN",48,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",49,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",50,0)
 Q
"RTN","PSOORFIN",51,0)
C D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"C",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD S CLI=1
"RTN","PSOORFIN",52,0)
 Q:$G(POERR("QFLG"))  I $G(CLI) S ORD=0 D
"RTN","PSOORFIN",53,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"M",ORD)) Q:'ORD!($G(POERR("QFLG")))  I $P(^PS(52.41,ORD,0),"^",3)'="DC",$P(^(0),"^",3)'="DE" D LK1,ORD
"RTN","PSOORFIN",54,0)
 .Q:$G(POERR("QFLG"))
"RTN","PSOORFIN",55,0)
 .D KQ F  S ORD=$O(^PS(52.41,"AC",PAT,"W",ORD)) Q:'ORD!($G(POERR("QFLG")))  D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") LK1,ORD
"RTN","PSOORFIN",56,0)
 Q
"RTN","PSOORFIN",57,0)
PAT W ! K MEDP,MEDA,POERR("DFLG"),DIR D KQ S PSOSORT="PATIENT"
"RTN","PSOORFIN",58,0)
 S DIR("?")="^D PT^PSOORFI1",DIR("A")="All Patients or Single Patient",DIR(0)="SBM^A:ALL;S:SINGLE;E:EXIT",DIR("B")="SINGLE"
"RTN","PSOORFIN",59,0)
 D ^DIR K DIR G:$D(DIRUT)!(Y="E") EX I Y="S" S PSOSORT=PSOSORT_"^"_"SINGLE" G SPAT
"RTN","PSOORFIN",60,0)
 S PSOSORT=PSOSORT_"^ALL"
"RTN","PSOORFIN",61,0)
 S LG=0,PATA=0 F  S LG=$O(^PS(52.41,"AD",LG)) Q:'LG!($G(POERR("QFLG")))  F PSOD=0:0 S PSOD=$O(^PS(52.41,"AD",LG,PSOPINST,PSOD)) Q:'PSOD!($G(POERR("QFLG")))  D
"RTN","PSOORFIN",62,0)
 .Q:'$D(^PS(52.41,PSOD,0))!($P($G(^PS(52.41,PSOD,0)),"^",23))
"RTN","PSOORFIN",63,0)
 .Q:$G(PAT($P(^PS(52.41,PSOD,0),"^",2)))=$P(^PS(52.41,PSOD,0),"^",2)  S PAT=$P(^PS(52.41,PSOD,0),"^",2)
"RTN","PSOORFIN",64,0)
 .;PSO*7*266
"RTN","PSOORFIN",65,0)
 .I PAT'=PATA D LBL
"RTN","PSOORFIN",66,0)
 .D LK I $G(POERR("QFLG")) K POERR("QFLG") S PSOLK=1,PAT(PAT)=PAT Q
"RTN","PSOORFIN",67,0)
 .I $$CHK^PSODPT(PAT_"^"_$P($G(^DPT(PAT,0)),"^"),1,1)<0 S PSOLK=1,PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG,PSOQQ Q
"RTN","PSOORFIN",68,0)
 .S (PSODFN,Y)=PAT_"^"_$P($G(^DPT(PAT,0)),"^"),PATA=PAT
"RTN","PSOORFIN",69,0)
 .D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSODFN I $G(MEDP) D SPL D OERR^PSORX1 S PSOFIN=1 D QU S X=PSOPTLOK D KLLP,ULP,KLL Q
"RTN","PSOORFIN",70,0)
 .D SDFN D POST^PSOORFI1 I $G(PSOQFLG)!($G(PSOQUIT)) S:$G(PSOQUIT) POERR("QFLG")=1 S:$G(PSOQFLG) PAT(PAT)=PAT S X=PAT D ULP K PSOQFLG Q
"RTN","PSOORFIN",71,0)
 .S PAT(PAT)=PAT
"RTN","PSOORFIN",72,0)
 .F ORD=0:0 S ORD=$O(^PS(52.41,"AOR",PAT,PSOPINST,ORD)) Q:'ORD!($G(POERR("QFLG")))!($G(PSOQQ))  D
"RTN","PSOORFIN",73,0)
 ..I '$P($G(^PS(52.41,ORD,0)),"^",23) D PP,LK1,ORD
"RTN","PSOORFIN",74,0)
 .S X=PAT D ULP K PSOQQ
"RTN","PSOORFIN",75,0)
 I $O(PSORX("PSOL",0))!($D(RXRS)) D LBL
"RTN","PSOORFIN",76,0)
 I $G(PSOQUIT) K PSOQUIT D EX G PSOORFIN
"RTN","PSOORFIN",77,0)
 G EX
"RTN","PSOORFIN",78,0)
 ;PSO*7*266 kill BINGCRT,BINGRTE when selecting pat.
"RTN","PSOORFIN",79,0)
SPAT K MEDA,MEDP,PSOQFLG,PSORX("FN"),BINGCRT,BINGRTE D KQ,KV^PSOVER1
"RTN","PSOORFIN",80,0)
 S DIR(0)="FO^2:30",DIR("A")="Select Patient",DIR("?")="^D HELP^PSOORFI2" D ^DIR I $E(X)="?" G SPAT
"RTN","PSOORFIN",81,0)
 G:$D(DIRUT) EX D KV^PSOVER1
"RTN","PSOORFIN",82,0)
 S DIC(0)="EQM",DIC=2,DIC("S")="I $D(^PS(52.41,""AOR"",+Y,PSOPINST))"
"RTN","PSOORFIN",83,0)
 D ^DIC K DIC G:"^"[X EX G:Y=-1 SPAT S (PSODFN,PAT)=+Y,PSOFINY=Y
"RTN","PSOORFIN",84,0)
 D LK I $G(POERR("QFLG")) G SPAT
"RTN","PSOORFIN",85,0)
 N SNGLPAT S SNGLPAT=1
"RTN","PSOORFIN",86,0)
 ;PSO*7*266
"RTN","PSOORFIN",87,0)
 D:'$G(MEDA) PROFILE^PSOORFI2 S Y=PSOFINY I $G(MEDP) D SPL D OERR^PSORX1 D LBL S PSOFIN=1,X=PSOPTLOK D KLLP,ULP,KLL G SPAT
"RTN","PSOORFIN",88,0)
 D PP,SDFN,POST^PSOORFI1 D:$G(PSOQFLG)  G:$G(PSOQFLG) EX I $G(PSOQUIT) S:$G(PSOQUIT) POERR("QFLG")=1 S X=PAT D ULP G SPAT
"RTN","PSOORFIN",89,0)
 .S X=PAT D ULP
"RTN","PSOORFIN",90,0)
 S ORD=0 F  S ORD=$O(^PS(52.41,"P",PAT,ORD)) Q:'ORD!($G(POERR("QFLG")))  D:'$P($G(^PS(52.41,ORD,0)),"^",23)
"RTN","PSOORFIN",91,0)
 .D:$P(^PS(52.41,ORD,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE")&($P(^(0),"^",3)'="HD") LK1,ORD
"RTN","PSOORFIN",92,0)
 ;PSO*7*266
"RTN","PSOORFIN",93,0)
 D LBL
"RTN","PSOORFIN",94,0)
 S PSOFIN=1,X=PAT D ULP G SPAT
"RTN","PSOORFIN",95,0)
ORD I $G(PSOBCK) N LST,ORN
"RTN","PSOORFIN",96,0)
 E  S PSOLOUD=1 D:$P($G(^PS(55,PAT,0)),"^",6)'=2 EN^PSOHLUP(PAT) K PSOLOUD
"RTN","PSOORFIN",97,0)
 K DRET,SIG,^TMP("PSORXDC",$J) Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOORFIN",98,0)
 I $G(PSOFIN),$P($G(^PS(52.41,ORD,"INI")),"^")'=$G(PSOPINST) Q
"RTN","PSOORFIN",99,0)
 D L1^PSOORFI3 I '$G(PSOMSG) K PSOMSG Q
"RTN","PSOORFIN",100,0)
 I '$D(^PS(52.41,ORD,0)) K PSOMSG Q
"RTN","PSOORFIN",101,0)
 K DRET,SIG,PSOPRC,PHI,PRC,PSOSIGFL,OBX,PSOMSG,PSOFOERR S OR0=^PS(52.41,ORD,0)
"RTN","PSOORFIN",102,0)
 I $P(OR0,"^",24),($P(OR0,"^",3)="RNW"!($P(OR0,"^",3)="NW")) N PKI,PKI1,PKIR,PKIE,PKID S PKI=0 D CER^PSOPKIV1 I PKI<1 K OR0 Q
"RTN","PSOORFIN",103,0)
 S (PSOFOERR,PSOFDR)=1,OI=$P(OR0,"^",8),PSORX("SC")=$P(OR0,"^",16)
"RTN","PSOORFIN",104,0)
 I $O(^PS(52.41,ORD,2,0)) S PHI=^PS(52.41,ORD,2,0),T=0 F  S T=$O(^PS(52.41,ORD,2,T)) Q:'T  S PHI(T)=^PS(52.41,ORD,2,T,0)
"RTN","PSOORFIN",105,0)
 I $P($G(^PS(52.41,ORD,"EXT")),"^")'="" K PHI I $O(^PS(52.41,ORD,"SIG",0)) S PHI=$G(^PS(52.41,ORD,"SIG",0)),T=0 F  S T=$O(^PS(52.41,ORD,"SIG",T)) Q:'T  S PHI(T)=$G(^PS(52.41,ORD,"SIG",T,0))
"RTN","PSOORFIN",106,0)
 I $O(^PS(52.41,ORD,3,0)) S PRC=^PS(52.41,ORD,3,0),T=0 F  S T=$O(^PS(52.41,ORD,3,T)) Q:'T  S PRC(T)=^PS(52.41,ORD,3,T,0)
"RTN","PSOORFIN",107,0)
 I $P(OR0,"^",3)="RNW",$D(^PSRX(+$P(OR0,"^",21),0)) D  G SUCC ;process renews
"RTN","PSOORFIN",108,0)
 .K PSOREEDT S (PSOORRNW,PSOFDR)=1,PSORENW("OIRXN")=$P(OR0,"^",21),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"))=0 D ^PSOORRNW,SQR
"RTN","PSOORFIN",109,0)
 I $P(OR0,"^",3)="RF",$D(^PSRX(+$P(OR0,"^",19),0)) D RF^PSOORFI2 G SUCC
"RTN","PSOORFIN",110,0)
 N PSODRUG,PSONEW S PSOFROM="PENDING" D:'$G(PSOTPBFG) DSPL^PSOTPCAN(ORD) D DSPL^PSOORFI1,SQN^PSOORFI3
"RTN","PSOORFIN",111,0)
SUCC ;
"RTN","PSOORFIN",112,0)
 D UL1^PSOORFI3,FULL^VALM1
"RTN","PSOORFIN",113,0)
 D:$P($G(^PS(52.41,+$G(ORD),0)),"^",3)'="NW"&($P($G(^(0)),"^",3)'="RNW")&($P($G(^(0)),"^",3)'="HD")&($P($G(^(0)),"^",3)'="RF")
"RTN","PSOORFIN",114,0)
 .K PSOSD("PENDING",$S('$G(OID):$P(^PS(50.7,$P(OR0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(OR0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(OR0,"^",9),0),"^")))
"RTN","PSOORFIN",115,0)
 S:$G(POERR("DFLG")) POERR("QFLG")=1 K POERR("DFLG"),PSONEW,ACP,OR0,DRET,SIG,OID,OI,PSORX("SC"),PSORX("CLINIC"),PSODRUG,PSOFOERR
"RTN","PSOORFIN",116,0)
 Q
"RTN","PSOORFIN",117,0)
 ;PSO*7*266 change order of bingo checks.
"RTN","PSOORFIN",118,0)
LBL I $O(PSORX("PSOL",0))!($D(RXRS)) S PSOFROM="NEW" D ^PSORXL K PSORX("PSOL"),PPL,RXRS
"RTN","PSOORFIN",119,0)
 D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,PSONEW,BBFLG,BBRX,PSORX("DOSING OFF"),PSOONOFC
"RTN","PSOORFIN",120,0)
 Q
"RTN","PSOORFIN",121,0)
CHK ;
"RTN","PSOORFIN",122,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W !,$C(7),"Outpatient Division MUST be selected!",! G EX
"RTN","PSOORFIN",123,0)
 D INST1^PSOORFI2
"RTN","PSOORFIN",124,0)
 S PSZCNT=0 F PSZZI=0:0 S PSZZI=$O(^PS(59,PSZZI)) Q:'PSZZI  S PSZCNT=PSZCNT+1
"RTN","PSOORFIN",125,0)
 S TC=0 F TO=0:0 S TO=$O(^PS(52.41,"AOR",TO)) Q:'TO  F TZ=0:0 S TZ=$O(^PS(52.41,"AOR",TO,TZ)) Q:'TZ  F PSTZ=0:0 S PSTZ=$O(^PS(52.41,"AOR",TO,TZ,PSTZ)) Q:'PSTZ  S TC=TC+1
"RTN","PSOORFIN",126,0)
 W !!?10,$C(7),"Orders to be completed"_$S(PSZCNT=1:": ",1:" for all divisions: ")_TC,! Q:'TC
"RTN","PSOORFIN",127,0)
 D SUMM^PSOORNE1 K PSZZI,PSZCNT,PSTZ
"RTN","PSOORFIN",128,0)
 Q
"RTN","PSOORFIN",129,0)
 ;
"RTN","PSOORFIN",130,0)
LK D LOCK^PSOORFI1
"RTN","PSOORFIN",131,0)
 Q
"RTN","PSOORFIN",132,0)
LK1 D LOCK1^PSOORFI1 Q
"RTN","PSOORFIN",133,0)
QU I $G(PSOQUIT) S POERR("QFLG")=1 K PSOQUIT
"RTN","PSOORFIN",134,0)
 S:$G(PSOQFLG) PAT(PAT)=PAT
"RTN","PSOORFIN",135,0)
 Q
"RTN","PSOORFIN",136,0)
ULP K PSORX("MAIL/WINDOW"),PSORX("METHOD OF PICK-UP")
"RTN","PSOORFIN",137,0)
 D CLEAN^PSOVER1
"RTN","PSOORFIN",138,0)
 I '$G(X) Q
"RTN","PSOORFIN",139,0)
 D UL^PSSLOCK(X) Q
"RTN","PSOORFIN",140,0)
KLL K PSOPTLOK Q
"RTN","PSOORFIN",141,0)
KLLP K PSONOLCK Q
"RTN","PSOORFIN",142,0)
SPL D SPL^PSOORFI4 Q
"RTN","PSOORFIN",143,0)
SDFN S PSODFN=+$G(PSODFN) Q
"RTN","PSOORFIN",144,0)
PP D PP^PSOORFI4 Q
"RTN","PSOORFIN",145,0)
KQ K PSOQUIT,POERR("QFLG") Q
"RTN","PSOORFIN",146,0)
SQR ;
"RTN","PSOORFIN",147,0)
 K PSOORRNW,PSOOPT,PSOREEDT,PSOQUIT S POERR("DFLG")=0
"RTN","PSOORFIN",148,0)
 Q
"RTN","PSOORNE1")
0^33^B72891193
"RTN","PSOORNE1",1,0)
PSOORNE1 ;BIR/SAB - Display new orders from backdoor ;03/06/95
"RTN","PSOORNE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,21,27,32,37,46,71,94,104,117,133,148,279,251,372**;DEC 1997;Build 54
"RTN","PSOORNE1",3,0)
 ;External reference to ^PS(55 is supported by DBIA 2228
"RTN","PSOORNE1",4,0)
EN(PSONEW) D DSPL^PSOORNE3,^PSOLMPO2
"RTN","PSOORNE1",5,0)
 Q
"RTN","PSOORNE1",6,0)
EDT N FLD,LST K DIR,DUOUT,DIRUT S DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:14" D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DTOUT S VALMBCK="" Q
"RTN","PSOORNE1",7,0)
EDTSEL S:'$G(COPY) PSOEDIT=1 S (PSONEW("DFLG"),PSONEW("FIELD"),PSONEW3)=0
"RTN","PSOORNE1",8,0)
 I +Y S LST=Y D HLDHDR^PSOLMUTL D  Q:$G(PSORX("DFLG"))!($G(PSORX("QFLG")))  S VALMBCK="R" G DSPL^PSOORNE3
"RTN","PSOORNE1",9,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""  D @(+$P(LST,",",FLD)) Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE1",10,0)
 E  S VALMBCK="" D FULL^VALM1
"RTN","PSOORNE1",11,0)
 D RDSPL G DSPL^PSOORNE3
"RTN","PSOORNE1",12,0)
 Q
"RTN","PSOORNE1",13,0)
ACP K VALMSG,DIR,PSORX("DFLG") D VER I $G(PSONEW2("QFLG"))!($G(PSORX("DFLG"))) S VALMBCK="Q" K PSONEW2 Q
"RTN","PSOORNE1",14,0)
 N PSONOBCK S PSONOBCK=$S($G(PSOSIGFL):1,1:0)
"RTN","PSOORNE1",15,0)
 D NOOR^PSONEW I $D(DIRUT) S PSONEW("DFLG")=1 K DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",16,0)
 D RXNCHK,RDSPL
"RTN","PSOORNE1",17,0)
 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 K DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",18,0)
 D DISPLAY^PSONEW2
"RTN","PSOORNE1",19,0)
 D ^PSONEWG I $G(PSOCPZ("DFLG")) S PSONEW("DFLG")=1 K PSOANSQ,DIR,X,Y,DIRUT,DUOUT,DTOUT,PSOCPZ("DFLG"),PSOANSQD Q
"RTN","PSOORNE1",20,0)
 K PSOCPZ("DFLG")
"RTN","PSOORNE1",21,0)
 K DIR,DIRUT,X,Y S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this correct" D ^DIR
"RTN","PSOORNE1",22,0)
 I $D(DIRUT) S PSONEW("DFLG")=1 K PSOANSQ,PSOANSQD,DIR,X,Y,DIRUT,DUOUT,DTOUT Q
"RTN","PSOORNE1",23,0)
 I 'Y S VALMBCK="R" K PSOANSQ,DIR,X,Y,DIRUT,DUOUT,DTOUT D DSPL^PSOORNE3 Q
"RTN","PSOORNE1",24,0)
 W "..." K PSOANSQD,DIR,X,Y,DIRUT,DUOUT,DTOUT D DCORD^PSONEW2
"RTN","PSOORNE1",25,0)
 I $G(NCPDPFLG) D NCPDP^PSOORED6
"RTN","PSOORNE1",26,0)
 K:$G(COPY)!($G(PSOSIGFL)) PRC,PHI
"RTN","PSOORNE1",27,0)
 S:'$G(PSOID) PSOID=DT S (PSORX("FN"),PSONEW("POE"))=1 D EN^PSON52(.PSONEW) ; Files entry in File 52
"RTN","PSOORNE1",28,0)
 I $G(PSOBEDT) D
"RTN","PSOORNE1",29,0)
 .I '$D(^TMP("PSOBEDT",$J,PSODFN,0)) S ^TMP("PSOBEDT",$J,PSODFN,0)=PSORXED("IRXN") S:$G(PSONEW("MAIL/WINDOW"))["W" ^TMP("PSOBEDT",$J,PSODFN,1)=1 Q
"RTN","PSOORNE1",30,0)
 .S ^TMP("PSOBEDT",$J,PSODFN,0)=^TMP("PSOBEDT",$J,PSODFN,0)_","_PSORXED("IRXN")
"RTN","PSOORNE1",31,0)
 .I $G(PSONEW("MAIL/WINDOW"))["W" S ^TMP("PSOBEDT",$J,PSODFN,1)=1
"RTN","PSOORNE1",32,0)
 D NPSOSD^PSOUTIL(.PSONEW) ; Adds newly added rx to PSOSD array
"RTN","PSOORNE1",33,0)
 D ^PSOBUILD S VALMBCK="Q"
"RTN","PSOORNE1",34,0)
 K PSONEW("# OF REFILLS"),PSONEW("DAYS SUPPLY"),SDA,SEG1,SSN1,STA,Z4,ZDA
"RTN","PSOORNE1",35,0)
 Q:$G(COPY)  S PSONEW("DFLG")=0
"RTN","PSOORNE1",36,0)
 Q
"RTN","PSOORNE1",37,0)
VER I $G(PSOAC),$G(PSODRUG("NAME"))']"" D FULL^VALM1,2^PSOORNW1
"RTN","PSOORNE1",38,0)
 I $G(PSODRUG("NAME"))']"" S VALMSG="A Dispense Drug Must be Chosen!" S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",39,0)
 I '$G(PSONEW("ENT")) W !,"Dosing Instruction Missing!!",! D  I PSONEW("DFLG")=1 S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",40,0)
 .S PSOORRNW=1
"RTN","PSOORNE1",41,0)
 .K VALMSG D FULL^VALM1 W !,"Drug: "_PSODRUG("NAME")
"RTN","PSOORNE1",42,0)
 .I $O(SIG(0)) F I=1:1 Q:$G(SIG(I))']""  W !,SIG(I)
"RTN","PSOORNE1",43,0)
 .E   I $G(^PSRX(PSONEW("OIRXN"),"SIG"))]"" S X=$P(^PSRX(PSONEW("OIRXN"),"SIG"),"^") D SIGONE^PSOHELP W !,$E($G(INS1),2,250)
"RTN","PSOORNE1",44,0)
 .W ! D 5 K PSOORRNW I PSONEW("DFLG")=1 D M3 Q
"RTN","PSOORNE1",45,0)
 .D 6 D:PSONEW("DFLG")=1 M3
"RTN","PSOORNE1",46,0)
 D:$G(COPY) PROV^PSOUTIL(.PSORENW) I PSONEW("DFLG")=1 S PSONEW2("QFLG")=1 Q
"RTN","PSOORNE1",47,0)
 N PSODOSD D FULL^VALM1,POST^PSODRG:'$G(PSOSIGFL)
"RTN","PSOORNE1",48,0)
 I $G(POERR("DFLG"))=1 S (PSONEW("DFLG"),PSONEW2("QFLG"))=1 Q
"RTN","PSOORNE1",49,0)
 I $G(PSODOSD) S (PSONEW("DFLG"),PSONEW2("QFLG"))=1 Q
"RTN","PSOORNE1",50,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") K PSONOOR I $G(PSORX("DFLG")) S VALMBCK="Q" Q
"RTN","PSOORNE1",51,0)
 I +$G(PSEXDT) D
"RTN","PSOORNE1",52,0)
 .D FULL^VALM1 S:$G(PSONEW("MAIL/WINDOW"))["W" BINGCRT="Y",BINGRTE="W"
"RTN","PSOORNE1",53,0)
 .D:+$G(PSEXDT)
"RTN","PSOORNE1",54,0)
 ..S Y=PSONEW("FILL DATE") X ^DD("DD") W !!,$C(7),Y_" fill date is greater than possible expiration date of " S Y=$P(PSEXDT,"^",2) X ^DD("DD") W Y_"."
"RTN","PSOORNE1",55,0)
 .S PSONEW2("QFLG")=1,VALMBCK="R" D PAUSE^VALM1
"RTN","PSOORNE1",56,0)
 Q
"RTN","PSOORNE1",57,0)
1 I $G(PSOSIGFL) S PSOAC=1 D 2^PSOORNW1 K PSOAC D RDSPL G DSPL^PSOORNE3 Q
"RTN","PSOORNE1",58,0)
 D 6^PSOBKDED D RDSPL G DSPL^PSOORNE3 Q
"RTN","PSOORNE1",59,0)
 ;
"RTN","PSOORNE1",60,0)
2 D 3^PSOBKDED Q
"RTN","PSOORNE1",61,0)
 ;
"RTN","PSOORNE1",62,0)
3 D 1^PSOBKDED Q
"RTN","PSOORNE1",63,0)
 ;
"RTN","PSOORNE1",64,0)
4 D 2^PSOBKDED Q
"RTN","PSOORNE1",65,0)
 ;
"RTN","PSOORNE1",66,0)
5 I '$G(PSODRUG("IEN")) W !,"DRUG NAME REQUIRED!" D 2^PSOORNW1 I '$G(PSODRUG("IEN")) S VALMSG="No Dispense Drug Selected" Q
"RTN","PSOORNE1",67,0)
 W !!,"Drug: "_PSODRUG("NAME") D 10^PSOBKDED Q
"RTN","PSOORNE1",68,0)
 ;
"RTN","PSOORNE1",69,0)
6 D INS^PSOBKDED Q:$G(PSONEW("DFLG"))  I $P($G(^PS(55,PSODFN,"LAN")),"^") D SINS^PSODIR(.PSONEW)
"RTN","PSOORNE1",70,0)
 Q
"RTN","PSOORNE1",71,0)
 ;
"RTN","PSOORNE1",72,0)
7 D 8^PSOBKDED Q
"RTN","PSOORNE1",73,0)
 ;
"RTN","PSOORNE1",74,0)
8 D 7^PSOBKDED Q
"RTN","PSOORNE1",75,0)
 ;
"RTN","PSOORNE1",76,0)
9 D 9^PSOBKDED Q
"RTN","PSOORNE1",77,0)
 ;
"RTN","PSOORNE1",78,0)
10 D 12^PSOBKDED Q
"RTN","PSOORNE1",79,0)
 ;
"RTN","PSOORNE1",80,0)
11 D 5^PSOBKDED Q
"RTN","PSOORNE1",81,0)
 ;
"RTN","PSOORNE1",82,0)
12 D 4^PSOBKDED Q
"RTN","PSOORNE1",83,0)
 ;
"RTN","PSOORNE1",84,0)
13 D 11^PSOBKDED Q
"RTN","PSOORNE1",85,0)
 ;
"RTN","PSOORNE1",86,0)
14 D 13^PSOBKDED Q
"RTN","PSOORNE1",87,0)
 ;
"RTN","PSOORNE1",88,0)
SUMM ;print break down of orders to be finished
"RTN","PSOORNE1",89,0)
 K ^TMP($J,"PSOCZT"),^TMP($J,"PSODPAT"),PAT,RT,DIR,DUOUT,DIRUT,PSZLQUIT
"RTN","PSOORNE1",90,0)
 S DIR("A")="Do you want an Order Summary",DIR(0)="Y",DIR("B")="No"
"RTN","PSOORNE1",91,0)
 D ^DIR K DIR I 'Y!($D(DIRUT)) K Y,X,DIRUT Q
"RTN","PSOORNE1",92,0)
 K PSOINPRT,DIQ,^UTILITY("DIQ1",$J) I $G(PSOPINST) S DA=PSOPINST,DIC=4,DIQ(0)="E",DR=".01" D EN^DIQ1 S PSOINPRT=$G(^UTILITY("DIQ1",$J,4,DA,.01,"E")) K ^UTILITY("DIQ1",$J),DA,DR,DIC,DIQ
"RTN","PSOORNE1",93,0)
 I $D(^PS(52.41,"ACL")) N PSOCLSUM D SUMMCL I $G(PSOCLSUM) K PSOINPRT Q
"RTN","PSOORNE1",94,0)
 F PSI=0:0 S PSI=$O(^PS(52.41,"AOR",PSI)) Q:'PSI  F PSID=0:0 S PSID=$O(^PS(52.41,"AOR",PSI,PSID)) Q:'PSID  F PIN=0:0 S PIN=$O(^PS(52.41,"AOR",PSI,PSID,PIN)) Q:'PIN  D
"RTN","PSOORNE1",95,0)
 .I '$D(^TMP($J,"PSOCZT",PSID,"PAT")) F PZA="PAT","WIN","MAIL","CLIN" S ^TMP($J,"PSOCZT",PSID,PZA)=0
"RTN","PSOORNE1",96,0)
 .I '$D(^TMP($J,"PSODPAT",PSID,PSI)) S ^TMP($J,"PSODPAT",PSID,PSI)=1,^TMP($J,"PSOCZT",PSID,"PAT")=^TMP($J,"PSOCZT",PSID,"PAT")+1
"RTN","PSOORNE1",97,0)
 .S PZROUT=$P($G(^PS(52.41,PIN,0)),"^",17) I PZROUT'="" S ^TMP($J,"PSOCZT",PSID,$S(PZROUT="C":"CLIN",PZROUT="M":"MAIL",1:"WIN"))=^TMP($J,"PSOCZT",PSID,$S(PZROUT="C":"CLIN",PZROUT="M":"MAIL",1:"WIN"))+1
"RTN","PSOORNE1",98,0)
 W @IOF W !?20,"Pending Outpatient Medication Orders",! I $G(PSZCNT)>1 W ?20,"(signed in under "_$G(PSOINPRT)_")",!
"RTN","PSOORNE1",99,0)
 F PSOINL=0:0 S PSOINL=$O(^TMP($J,"PSOCZT",PSOINL)) Q:'PSOINL!($G(PSZLQUIT))  D
"RTN","PSOORNE1",100,0)
 .I ($Y+6)>IOSL K DIR S DIR(0)="E" D ^DIR K DIR D:$G(Y)  I '$G(Y) S PSZLQUIT=1 W ! Q
"RTN","PSOORNE1",101,0)
 ..W @IOF W !?20,"Pending Outpatient Medication Orders",! I $G(PSZCNT)>1 W ?20,"(signed in under "_$G(PSOINPRT)_")",!
"RTN","PSOORNE1",102,0)
 .K ^UTILITY("DIQ1",$J),DIQ,PSOINPRX S DA=$G(PSOINL),DIC=4,DIQ(0)="E",DR=".01" D EN^DIQ1 S PSOINPRX=$G(^UTILITY("DIQ1",$J,4,DA,.01,"E")) K ^UTILITY("DIQ1",$J),DA,DR,DIC,DIQ
"RTN","PSOORNE1",103,0)
 .;PSO*7*279 Change division to Institution
"RTN","PSOORNE1",104,0)
 .W !,"Institution: ",$G(PSOINPRX)
"RTN","PSOORNE1",105,0)
 .W !,"Patients: "_$G(^TMP($J,"PSOCZT",PSOINL,"PAT"))_"  Window: "_$G(^("WIN"))_"  Mail: "_$G(^("MAIL"))_"  Clinic: "_$G(^("CLIN")),!
"RTN","PSOORNE1",106,0)
 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSOORNE1",107,0)
 K ^TMP($J,"PSOCZT"),^TMP($J,"PSODPAT"),RT,PSOINPRT,PSOINPRX,PSI,PSID,PIN,PZA,PZROUT,PSOINL,PSZLQUIT
"RTN","PSOORNE1",108,0)
 Q
"RTN","PSOORNE1",109,0)
SUMMCL ;
"RTN","PSOORNE1",110,0)
 ;PSO*7*279 Change Division to Institution
"RTN","PSOORNE1",111,0)
 W ! K DIR S DIR(0)="SMB^I:INSTITUTION;C:CLINIC",DIR("A")="Do you want the summary by Institution or Clinic",DIR("B")="Institution",DIR("?")=" "
"RTN","PSOORNE1",112,0)
 S DIR("?",1)="Enter 'I' to see the summary by Institution, and within Institution the orders",DIR("?",2)="shown by Mail, Window, or Administered in Clinic.",DIR("?",3)="Enter 'C' to see the summary by Clinic, along with Clinic Sort Groups."
"RTN","PSOORNE1",113,0)
 D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSOCLSUM=1 Q
"RTN","PSOORNE1",114,0)
 Q:$G(Y)="I"
"RTN","PSOORNE1",115,0)
 S PSOCLSUM=1
"RTN","PSOORNE1",116,0)
 K ^TMP($J,"PSOLOC"),^TMP($J,"PSOLOCP") N PSCX,PSCXL,PSLX,PSCIN,PSCPT,PSCNDE,PSNCL,PSNPAT,PSCLOUT,PSCSFLAG,PCCNT,PSOCAG
"RTN","PSOORNE1",117,0)
 F PSCX=0:0 S PSCX=$O(^PS(52.41,"ACL",PSCX)) Q:'PSCX  F PSLX=0:0 S PSLX=$O(^PS(52.41,"ACL",PSCX,PSLX)) Q:'PSLX  F PSCIN=0:0 S PSCIN=$O(^PS(52.41,"ACL",PSCX,PSLX,PSCIN)) Q:'PSCIN  S PSCPT=+$P($G(^PS(52.41,PSCIN,0)),"^",2) D:PSCPT
"RTN","PSOORNE1",118,0)
 .S PSCNDE=$G(^PS(52.41,PSCIN,0))
"RTN","PSOORNE1",119,0)
 .I $P(PSCNDE,"^",3)'="NW",$P(PSCNDE,"^",3)'="RNW",$P(PSCNDE,"^",3)'="RF" Q
"RTN","PSOORNE1",120,0)
 .I $P(PSCNDE,"^",13)="" Q
"RTN","PSOORNE1",121,0)
 .S PSNCL=+$P(PSCNDE,"^",13),PSNPAT=+$P(PSCNDE,"^",2)
"RTN","PSOORNE1",122,0)
 .I '$D(^TMP($J,"PSOLOC",PSNCL)) S ^TMP($J,"PSOLOC",PSNCL)="1^1",^TMP($J,"PSOLOCP",PSNCL,PSNPAT)="" Q
"RTN","PSOORNE1",123,0)
 .S $P(^TMP($J,"PSOLOC",PSNCL),"^",2)=$P(^TMP($J,"PSOLOC",PSNCL),"^",2)+1
"RTN","PSOORNE1",124,0)
 .I '$D(^TMP($J,"PSOLOCP",PSNCL,PSNPAT)) S $P(^TMP($J,"PSOLOC",PSNCL),"^")=$P(^TMP($J,"PSOLOC",PSNCL),"^")+1
"RTN","PSOORNE1",125,0)
 .S ^TMP($J,"PSOLOCP",PSNCL,PSNPAT)=""
"RTN","PSOORNE1",126,0)
 I '$O(^TMP($J,"PSOLOC",0)) G SUMMQ
"RTN","PSOORNE1",127,0)
 W @IOF W !?20,"Pending Outpatient Medication Orders" I $G(PSZCNT)>1 W !?20,"(signed in under "_$G(PSOINPRT)_")"
"RTN","PSOORNE1",128,0)
 F PSCXL=0:0 S PSCXL=$O(^TMP($J,"PSOLOC",PSCXL)) Q:'PSCXL!($G(PSCLOUT))  D
"RTN","PSOORNE1",129,0)
 .I ($Y+7)>IOSL D CLDIR Q:$G(PSCLOUT)
"RTN","PSOORNE1",130,0)
 .W !!,"Clinic:   ",$P($G(^SC(+PSCXL,0)),"^")
"RTN","PSOORNE1",131,0)
 .W !,"Patients: ",$P($G(^TMP($J,"PSOLOC",PSCXL)),"^"),?16,"Orders: ",$P($G(^TMP($J,"PSOLOC",PSCXL)),"^",2)
"RTN","PSOORNE1",132,0)
 .W !,"In Sort Groups:"
"RTN","PSOORNE1",133,0)
 .S (PCCNT,PSCSFLAG)=0 F PSCSORT=0:0 S PSCSORT=$O(^PS(59.8,PSCSORT)) Q:'PSCSORT!($G(PSCLOUT))  I $D(^PS(59.8,PSCSORT,1,"B",PSCXL)) S PSOCAG=0 D
"RTN","PSOORNE1",134,0)
 ..S PSCSFLAG=1 S:($Y+5)>IOSL&(PCCNT) PSOCAG=1 D:($Y+5)>IOSL&(PCCNT) CLDIR Q:$G(PSCLOUT)  W:$G(PSOCAG) !,"Clinic: "_$P($G(^SC(PSCXL,0)),"^")_"   cont." W:$G(PCCNT)>0 ! W ?16,$P($G(^PS(59.8,PSCSORT,0)),"^") S PCCNT=1
"RTN","PSOORNE1",135,0)
 .I '$G(PSCSFLAG) W ?16,"*** NO CLINIC SORT GROUPS ***"
"RTN","PSOORNE1",136,0)
 I '$G(PSCLOUT) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press <RET> to continue"  D ^DIR K DIR
"RTN","PSOORNE1",137,0)
SUMMQ K ^TMP($J,"PSOLOC"),^TMP($J,"PSOLOCP")
"RTN","PSOORNE1",138,0)
 Q
"RTN","PSOORNE1",139,0)
CLDIR K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press <RET> to continue, '^' to exit" D ^DIR K DIR I Y'=1 S PSCLOUT=1 Q
"RTN","PSOORNE1",140,0)
 W @IOF
"RTN","PSOORNE1",141,0)
 Q
"RTN","PSOORNE1",142,0)
RXNCHK I $G(PSONEW("RX #"))']"" D RXNCHK^PSOORNE5
"RTN","PSOORNE1",143,0)
 Q
"RTN","PSOORNE1",144,0)
RDSPL D RDSPL^PSOORNE5
"RTN","PSOORNE1",145,0)
 Q
"RTN","PSOORNE1",146,0)
M3 D M3^PSOOREDX
"RTN","PSOORNE1",147,0)
 Q
"RTN","PSOORNE1",148,0)
 ;
"RTN","PSOORNEW")
0^27^B90508576
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,391,372**;DEC 1997;Build 54
"RTN","PSOORNEW",3,0)
 ;^PS(50.7 -2223
"RTN","PSOORNEW",4,0)
 ;^PSDRUG -221
"RTN","PSOORNEW",5,0)
 ;^PS(50.606 -2174
"RTN","PSOORNEW",6,0)
 ;^PS(55 -2228
"RTN","PSOORNEW",7,0)
 ;EN1^ORCFLAG -3620
"RTN","PSOORNEW",8,0)
 ;
"RTN","PSOORNEW",9,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",10,0)
 ;
"RTN","PSOORNEW",11,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",12,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",13,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",14,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",15,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",16,0)
 .S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",17,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",18,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",19,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",20,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",21,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",23,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",24,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",25,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",26,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",27,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",29,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",34,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",35,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",36,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",38,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",39,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",40,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",41,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",42,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",43,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",45,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",47,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",48,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",49,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",50,0)
 I $$PATCH^XPDUTL("PSO*7.0*391"),$P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_+$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",51,0)
 E  S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",52,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",53,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",56,0)
 I $$PATCH^XPDUTL("PSO*7.0*391") D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",57,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",58,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",59,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",60,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",61,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",62,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",63,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",64,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",65,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",66,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",67,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",68,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",69,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",70,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",71,0)
 Q
"RTN","PSOORNEW",72,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",73,0)
 Q
"RTN","PSOORNEW",74,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",75,0)
EDTSEL N LST,FLD,OUT D KV S OUT=0
"RTN","PSOORNEW",76,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",77,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",78,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",79,0)
 Q
"RTN","PSOORNEW",80,0)
ACP ;
"RTN","PSOORNEW",81,0)
 N DIR,Y S Y=0
"RTN","PSOORNEW",82,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",83,0)
 . D FULL^VALM1
"RTN","PSOORNEW",84,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",85,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",86,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",87,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",88,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",89,0)
 . D KV
"RTN","PSOORNEW",90,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",91,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",92,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",93,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",94,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",95,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",96,0)
 ;
"RTN","PSOORNEW",97,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",98,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",99,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",100,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",101,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",102,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",103,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",104,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",105,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",106,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",107,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",108,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",109,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",110,0)
 ;
"RTN","PSOORNEW",111,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",112,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",113,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",114,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",115,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",116,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",117,0)
 S PSONEW("POE")=1 D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$$PATCH^XPDUTL("PSO*7.0*391")&($G(PKI)=89802020) ALERT^PSOPKIV1
"RTN","PSOORNEW",118,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",119,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",120,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",121,0)
 Q
"RTN","PSOORNEW",122,0)
KV K DIRUT,DUOUT,DTOUT,DIR
"RTN","PSOORNEW",123,0)
 Q
"RTN","PSOORNEW",124,0)
REF D REF^PSOORFI4
"RTN","PSOORNEW",125,0)
 Q
"RTN","PSOORNEW",126,0)
1 I $$PATCH^XPDUTL("PSO*7.0*391"),$P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",127,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",128,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",129,0)
 ;
"RTN","PSOORNEW",130,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",131,0)
 ;
"RTN","PSOORNEW",132,0)
3 I $$PATCH^XPDUTL("PSO*7.0*391"),$G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",133,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",134,0)
 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",135,0)
 ;
"RTN","PSOORNEW",136,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",137,0)
 ;
"RTN","PSOORNEW",138,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",139,0)
 ;
"RTN","PSOORNEW",140,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",141,0)
 ;
"RTN","PSOORNEW",142,0)
13 I $$PATCH^XPDUTL("PSO*7.0*391"),$P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",143,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",144,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",145,0)
 ;
"RTN","PSOORNEW",146,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",147,0)
 ;
"RTN","PSOORNEW",148,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",149,0)
 D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",150,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",151,0)
 Q
"RTN","PSOORNEW",152,0)
 ;
"RTN","PSOORNEW",153,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",154,0)
 ;
"RTN","PSOORNEW",155,0)
8 D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",156,0)
 ;
"RTN","PSOORNEW",157,0)
10 I $$PATCH^XPDUTL("PSO*7.0*391"),$P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",158,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",159,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",160,0)
 ;
"RTN","PSOORNEW",161,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",162,0)
 ;
"RTN","PSOORNEW",163,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",164,0)
 ;
"RTN","PSOORNEW",165,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",166,0)
 ;
"RTN","PSOORNEW",167,0)
DRGMSG ;
"RTN","PSOORNEW",168,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",169,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",170,0)
 K SG
"RTN","PSOORNEW",171,0)
 Q
"RTN","PSOORNEW",172,0)
 ;
"RTN","PSOORNEW",173,0)
PZ ;
"RTN","PSOORNEW",174,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",175,0)
 Q
"RTN","PSOORRD2")
0^21^B25093764
"RTN","PSOORRD2",1,0)
PSOORRD2 ;BHAM-ISC/EJW - Remote Data Interoperability Order Checks - backdoor ;06/26/05
"RTN","PSOORRD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**207,251,387,372**;DEC 1997;Build 54
"RTN","PSOORRD2",3,0)
 ;
"RTN","PSOORRD2",4,0)
DUP ;Remote order - duplicate drug
"RTN","PSOORRD2",5,0)
 N PSOD0,PSOD1,PSOREMX,RDIINST,FSIG,PSOULN,PSOLF,PSORDI
"RTN","PSOORRD2",6,0)
 S $P(PSOULN,"-",79)="",PSOT="DD"
"RTN","PSOORRD2",7,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,"DD",PSORDI)) Q:'PSORDI  S PSOD0=^TMP($J,"DD",PSORDI,0),PSOD1=^(1),PSOREMX=$P($P(PSOD0,"^",4),";"),RDIINST=$P(PSOD0,"^",5),PSOLF=$P(PSOD1,"^",3) D
"RTN","PSOORRD2",8,0)
 .W !,PSOULN,!
"RTN","PSOORRD2",9,0)
 .W "Duplicate Drug in Remote Rx:",!
"RTN","PSOORRD2",10,0)
 .W $J("Location Name: ",20)_RDIINST,!
"RTN","PSOORRD2",11,0)
 .W $J("Rx #: ",20)_$E(PSOREMX,1,$L(PSOREMX)-1),!
"RTN","PSOORRD2",12,0)
 .W $J("Drug: ",20)_$P(PSOD1,"^"),!
"RTN","PSOORRD2",13,0)
 .D FSIG(.FSIG)
"RTN","PSOORRD2",14,0)
 .W $J("SIG: ",20) F I=1:1 Q:'$D(FSIG(I))  W ?20,FSIG(I),!
"RTN","PSOORRD2",15,0)
 .W $J("QTY: ",20)_$P(PSOD1,"^",5),?44,$J("Refills remaining: ",20)_$P(PSOD1,"^",6)
"RTN","PSOORRD2",16,0)
 .W !,$J("Provider: ",20)_$P(PSOD1,"^",8),?44,$J("Issued: ",20)_$P(PSOD1,"^",9)
"RTN","PSOORRD2",17,0)
 .W !,$J("Status: ",20)_$P(PSOD1,"^",2),?44,$J("Last filled on: ",20)_PSOLF
"RTN","PSOORRD2",18,0)
 .W !?44,$J("Days Supply: ",20)_$P(PSOD1,"^",4)
"RTN","PSOORRD2",19,0)
 .W !,PSOULN,!
"RTN","PSOORRD2",20,0)
 .D PAUSE
"RTN","PSOORRD2",21,0)
 .S ^TMP($J,"PSORMDD",PSORDI,0)=1
"RTN","PSOORRD2",22,0)
 K PSOT
"RTN","PSOORRD2",23,0)
 Q
"RTN","PSOORRD2",24,0)
 ;
"RTN","PSOORRD2",25,0)
CLS ;Remote order - duplicate drug class
"RTN","PSOORRD2",26,0)
 N PSOD0,PSOD1,PSOREMX,RDIINST,FSIG,PSOULN,PSOLF,PSORDI
"RTN","PSOORRD2",27,0)
 S $P(PSOULN,"-",79)="",PSOT="DC"
"RTN","PSOORRD2",28,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,"DC",PSORDI)) Q:'PSORDI  S PSOD0=^TMP($J,"DC",PSORDI,0),PSOD1=^(1),PSOREMX=$P($P(PSOD0,"^",6),";"),RDIINST=$P(PSOD0,"^",7),PSOLF=$P(PSOD1,"^",3) D
"RTN","PSOORRD2",29,0)
 .W !,PSOULN,!
"RTN","PSOORRD2",30,0)
 .W "     *** SAME CLASS *** OF DRUG IN REMOTE RX FOR ",$P(PSOD1,"^"),!
"RTN","PSOORRD2",31,0)
 .W ">> ",RDIINST,!
"RTN","PSOORRD2",32,0)
 .W "CLASS: ",$P(PSOD0,"^"),!
"RTN","PSOORRD2",33,0)
 .W $J("Rx #: ",20)_$E(PSOREMX,1,$L(PSOREMX)-1),!
"RTN","PSOORRD2",34,0)
 .W $J("Status: ",20),$P(PSOD1,"^",2)
"RTN","PSOORRD2",35,0)
 .W ?44,$J("Issued: ",20),$P(PSOD1,"^",9)
"RTN","PSOORRD2",36,0)
 .D FSIG(.FSIG)
"RTN","PSOORRD2",37,0)
 .W !,$J("SIG: ",20) F I=1:1 Q:'$D(FSIG(I))  W ?20,FSIG(I),!
"RTN","PSOORRD2",38,0)
 .W $J("QTY: ",20),$P(PSOD1,"^",5),!
"RTN","PSOORRD2",39,0)
 .W $J("Provider: ",20),$P(PSOD1,"^",8)
"RTN","PSOORRD2",40,0)
 .W ?44,$J("Refills remaining: ",20),$P(PSOD1,"^",6)
"RTN","PSOORRD2",41,0)
 .W !?44,$J("Last filled on: ",20),PSOLF
"RTN","PSOORRD2",42,0)
 .W !?44,$J("Days Supply: ",20),$P(PSOD1,"^",4)
"RTN","PSOORRD2",43,0)
 .D PAUSE
"RTN","PSOORRD2",44,0)
 K PSOT
"RTN","PSOORRD2",45,0)
 Q
"RTN","PSOORRD2",46,0)
FSIG(FSIG) ;Format sig from remote site
"RTN","PSOORRD2",47,0)
 ;returned in the FSIG array
"RTN","PSOORRD2",48,0)
 N FFF,NNN,CNT,FVAR,FVAR1,FLIM,HSIG,II,I
"RTN","PSOORRD2",49,0)
 F I=0:1 Q:'$D(^TMP($J,PSOT,PSORDI,1,I))  S HSIG(I+1)=^(I)
"RTN","PSOORRD2",50,0)
FSTART S (FVAR,FVAR1)="",II=1
"RTN","PSOORRD2",51,0)
 F FFF=0:0 S FFF=$O(HSIG(FFF)) Q:'FFF  S CNT=0 F NNN=1:1:$L(HSIG(FFF)) I $E(HSIG(FFF),NNN)=" "!($L(HSIG(FFF))=NNN) S CNT=CNT+1 D  I $L(FVAR)>52 S FSIG(II)=FLIM_" ",II=II+1,FVAR=FVAR1
"RTN","PSOORRD2",52,0)
 .S FVAR1=$P(HSIG(FFF)," ",(CNT))
"RTN","PSOORRD2",53,0)
 .S FLIM=FVAR
"RTN","PSOORRD2",54,0)
 .S FVAR=$S(FVAR="":FVAR1,1:FVAR_" "_FVAR1)
"RTN","PSOORRD2",55,0)
 I $G(FVAR)'="" S FSIG(II)=FVAR
"RTN","PSOORRD2",56,0)
 I $G(FSIG(1))=""!($G(FSIG(1))=" ") S FSIG(1)=$G(FSIG(2)) K FSIG(2)
"RTN","PSOORRD2",57,0)
FQUIT Q
"RTN","PSOORRD2",58,0)
SIGNIF ;
"RTN","PSOORRD2",59,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")="Y" W ! D ^DIR
"RTN","PSOORRD2",60,0)
 I Y I '$D(PSORX("INTERVENE")) S PSORX("INTERVENE")=2
"RTN","PSOORRD2",61,0)
 I '$G(Y) K DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y Q
"RTN","PSOORRD2",62,0)
 Q
"RTN","PSOORRD2",63,0)
 ;
"RTN","PSOORRD2",64,0)
PAUSE ;
"RTN","PSOORRD2",65,0)
 K DIR W ! S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue..." D ^DIR W ! K DIR
"RTN","PSOORRD2",66,0)
 Q
"RTN","PSOORRD2",67,0)
DRGINT ;DRUG-DRUG INTERACTION WITH ORDER FROM REMOTE SITE
"RTN","PSOORRD2",68,0)
 N PSOD0,PSOD1,PSOREMX,RDIINST,FSIG,PSOULN,PSOLF,PSOINT,PSORDI
"RTN","PSOORRD2",69,0)
 S $P(PSOULN,"-",79)="",PSOT="DI"
"RTN","PSOORRD2",70,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,"DI",PSORDI)) Q:'PSORDI  Q:$G(PSORX("DFLG"))  S PSOD0=^TMP($J,"DI",PSORDI,0),PSOD1=^(1),PSOREMX=$P($P(PSOD0,"^",8),";"),RDIINST=$P(PSOD0,"^",9),PSOLF=$P(PSOD1,"^",3) D
"RTN","PSOORRD2",71,0)
 .S PSOINT=$P(PSOD0,"^",4)
"RTN","PSOORRD2",72,0)
 .W !,PSOULN,!
"RTN","PSOORRD2",73,0)
 .W ">> ",RDIINST,!
"RTN","PSOORRD2",74,0)
 .W ?5,"** ",PSOINT," ** DRUG-DRUG interaction ",$P(PSOD0,"^",5)," & ",$P(PSOD0,"^",6),!
"RTN","PSOORRD2",75,0)
 .W ?5,"Remote RX # ",$E(PSOREMX,1,$L(PSOREMX)-1)," Drug: ",$P(PSOD1,"^"),!
"RTN","PSOORRD2",76,0)
 .W $J("Status: ",20),$P(PSOD1,"^",2)
"RTN","PSOORRD2",77,0)
 .W ?44,$J("Issued: ",20),$P(PSOD1,"^",9)
"RTN","PSOORRD2",78,0)
 .D FSIG(.FSIG)
"RTN","PSOORRD2",79,0)
 .W !,$J("SIG: ",20) F I=1:1 Q:'$D(FSIG(I))  W ?20,FSIG(I),!
"RTN","PSOORRD2",80,0)
 .W $J("QTY: ",20),$P(PSOD1,"^",5),!
"RTN","PSOORRD2",81,0)
 .W $J("Provider: ",20),$P(PSOD1,"^",8)
"RTN","PSOORRD2",82,0)
 .W !?44,$J("Refills remaining: ",20),$P(PSOD1,"^",6)
"RTN","PSOORRD2",83,0)
 .W !?44,$J("Last filled on: ",20),PSOLF
"RTN","PSOORRD2",84,0)
 .W !?44,$J("Days Supply: ",20),$P(PSOD1,"^",4)
"RTN","PSOORRD2",85,0)
 .I '$D(^XUSEC("PSORPH",DUZ)) Q  ; CLERK/TECH ENTRY
"RTN","PSOORRD2",86,0)
 .I PSOINT'="CRITICAL" D SIGNIF
"RTN","PSOORRD2",87,0)
 .I PSOINT="CRITICAL" D CRI
"RTN","PSOORRD2",88,0)
 K PSOT,PSORDI
"RTN","PSOORRD2",89,0)
 Q
"RTN","PSOORRD2",90,0)
 ;
"RTN","PSOORRD2",91,0)
CRI ;process new drug interactions entered by pharmacist
"RTN","PSOORRD2",92,0)
 K DIR S DIR("A",1)="",DIR("A",2)="Do you want to Process medication",DIR("A")=PSODRUG("NAME")_": ",DIR(0)="SA^1:PROCESS;0:ABORT ORDER ENTRY",DIR("B")="P"
"RTN","PSOORRD2",93,0)
 S DIR("?",1)="Enter '1' or 'P' to Process medication",DIR("?")="      '^' to EXIT",DIR("?",2)="      '0' or 'A' to Abort Order Entry process" D ^DIR K X1,DIR I 'Y S PSORX("DFLG")=1,DGI="" K DTOUT,DIRUT,DIROUT,DUOUT,PSORX("INTERVENE") Q
"RTN","PSOORRD2",94,0)
 D SIG^XUSESIG I X1="" K PSORX("INTERVENE") S PSORX("DFLG")=1 Q
"RTN","PSOORRD2",95,0)
 S PSORX("INTERVENE")=1
"RTN","PSOORRD2",96,0)
 K DUOUT,DTOUT,DIRUT,DIROUT
"RTN","PSOORRD2",97,0)
 Q
"RTN","PSORENW0")
0^28^B83644019
"RTN","PSORENW0",1,0)
PSORENW0 ;IHS/DSD/JCM-renew main driver continuation ;2/8/06 8:40am
"RTN","PSORENW0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,59,64,46,71,96,100,130,237,206,251,375,379,372**;DEC 1997;Build 54
"RTN","PSORENW0",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW0",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW0",5,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW0",6,0)
 ;
"RTN","PSORENW0",7,0)
 ;PSO*237 was not adding to Clozapine Override file, fix
"RTN","PSORENW0",8,0)
PROCESS ;
"RTN","PSORENW0",9,0)
 D ^PSORENW1
"RTN","PSORENW0",10,0)
 D INST2^PSORENW
"RTN","PSORENW0",11,0)
 I $D(PSORX("BAR CODE")),PSODFN'=PSORENW("PSODFN") D NEWPT
"RTN","PSORENW0",12,0)
 S PSORENW("DFLG")=0,PSORENW("FILL DATE")=PSORNW("FILL DATE")
"RTN","PSORENW0",13,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW0",14,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW0",15,0)
 D CHECK G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",16,0)
 D FILDATE
"RTN","PSORENW0",17,0)
 D DRUG G:PSORENW("DFLG")!PSORX("DFLG") PROCESSX
"RTN","PSORENW0",18,0)
 D RXN G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",19,0)
 D STOP^PSORENW1,OERR^PSORENW1:$G(PSOFDR)
"RTN","PSORENW0",20,0)
DSPL K PSOEDT,PSOLM D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",21,0)
 S PSORENW("QFLG")=0 D:'$G(PSOFDR) EDIT
"RTN","PSORENW0",22,0)
 G:PSORENW("DFLG")!$G(PSORX("FN")) PROCESSX
"RTN","PSORENW0",23,0)
 G:'$G(PSORX("FN"))&('$G(PSORENW("QFLG"))) DSPL
"RTN","PSORENW0",24,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) I PSORENW("DFLG")=1 G PROCESSX
"RTN","PSORENW0",25,0)
 I $G(NEWDOSE),PSORENW("ENT")>0 K NEWDOSE G DSPL
"RTN","PSORENW0",26,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW0",27,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW0",28,0)
 D CAN,DCORD^PSONEW2
"RTN","PSORENW0",29,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W"
"RTN","PSORENW0",30,0)
 ;PSO*237 add to Clozapine Override file
"RTN","PSORENW0",31,0)
ANQ I $G(ANQDATA)]"" D NOW^%DTC G:$D(^PS(52.52,"B",%)) ANQ D
"RTN","PSORENW0",32,0)
 . K DD,DO S DIC="^PS(52.52,",DIC(0)="L",DLAYGO=52.52,X=%
"RTN","PSORENW0",33,0)
 . D FILE^DICN K DIC,DLAYGO,DD,DO,DA,DR
"RTN","PSORENW0",34,0)
 . N PS52 S (PS52,DA)=+Y,DIE="^PS(52.52,",DR="1////"_PSORENW("IRXN")
"RTN","PSORENW0",35,0)
 . D ^DIE K DIE,DA,DR
"RTN","PSORENW0",36,0)
 . S $P(^PS(52.52,PS52,0),"^",3,6)=ANQDATA
"RTN","PSORENW0",37,0)
 . K ANQDATA,X,Y,%,ANQREM
"RTN","PSORENW0",38,0)
 ;
"RTN","PSORENW0",39,0)
PROCESSX N PSORWRIT I PSORENW("DFLG")!$G(PSORX("DFLG")) S PSOBBCLK=1 W:'$G(POERR) !,$C(7),"RENEWED RX DELETED",! S PSOWRIT=1,PSORERR=1 D
"RTN","PSORENW0",40,0)
 .D:$P($G(PSOLST(+$G(ORN))),"^",2) PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) S POERR("DFLG")=1 D CLEAN^PSOVER1 D
"RTN","PSORENW0",41,0)
 ..W !! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT,DUOUT S VALMBCK="Q"
"RTN","PSORENW0",42,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW0",43,0)
 K PRC,PHI,PSOQUIT,BBRN,BBRN1,PSORENW,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC"),PSORX("FN")
"RTN","PSORENW0",44,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW0",45,0)
 D CLEAN^PSOVER1
"RTN","PSORENW0",46,0)
 Q
"RTN","PSORENW0",47,0)
 ;
"RTN","PSORENW0",48,0)
CHECK ;
"RTN","PSORENW0",49,0)
 I '$D(PSORX("BAR CODE")),PSORENW("PSODFN")'=PSODFN D  G CHECKX
"RTN","PSORENW0",50,0)
 .W !!,?5,$C(7),"Can't renew Rx # "_$P(PSORENW("RX0"),"^")_", it is not for this patient." S PSORENW("DFLG")=1
"RTN","PSORENW0",51,0)
 .S:$G(POERR) VALMSG="Can't renew Rx # "_$P(PSORENW("RX0"),"^")_", not for this patient.",VALMBCK="R"
"RTN","PSORENW0",52,0)
 ;Invalid dosage check
"RTN","PSORENW0",53,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=PSORENW("OIRXN") D CDOSE
"RTN","PSORENW0",54,0)
 I PSOOLPF!(PSONOSIG) D  G CHECKX
"RTN","PSORENW0",55,0)
 .S PSORENW("DFLG")=1
"RTN","PSORENW0",56,0)
 .W !!,$C(7),"Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_$S(PSOOLPF:", invalid dosage of "_$G(PSOOLPD),1:", Missing Sig")
"RTN","PSORENW0",57,0)
 .S:$G(POERR) VALMSG="Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_$S(PSOOLPF:", invalid Dosage of "_$G(PSOOLPD),1:", Missing Sig") S VALMBCK="R"
"RTN","PSORENW0",58,0)
 .I '$G(PSORNSPD) W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSORENW0",59,0)
 .I $G(PSORNSPD) W !
"RTN","PSORENW0",60,0)
 ;
"RTN","PSORENW0",61,0)
 S (PSOS,PSOX,PSOY)="" K ACOM,DIR,DIRUT,DIRUT,DUOUT
"RTN","PSORENW0",62,0)
 I $G(PSOSD) F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""!(PSORENW("DFLG"))  I PSORENW("OIRXN")=+PSOSD(PSOS,PSOX) S PSOY=PSOSD(PSOS,PSOX) I $TR($P(PSOY,"^",3),"B")]"" D  K ACOM,DIR,DIRUT,DIRUT,DUOUT
"RTN","PSORENW0",63,0)
 . S PSORENW("DFLG")=1
"RTN","PSORENW0",64,0)
 . W !,$C(7),"Cannot renew Rx # ",$P(PSORENW("RX0"),"^")
"RTN","PSORENW0",65,0)
 . S PSOREA=$P(PSOY,"^",3),PSOSTAT=+PSORENW("STA")
"RTN","PSORENW0",66,0)
 . D STATUS^PSOUTIL(PSOREA,PSOSTAT) K PSOREA,PSOSTAT
"RTN","PSORENW0",67,0)
 .I $G(ACOM)]"" D
"RTN","PSORENW0",68,0)
 ..S DRG=$P(^PSDRUG($P(^PSRX(PSORENW("OIRXN"),0),"^",6),0),"^")
"RTN","PSORENW0",69,0)
 ..W ! S DIR(0)="Y",DIR("A",1)="Do you want to Discontinue this Pending Order",DIR("A")="for "_DRG,DIR("B")="No"
"RTN","PSORENW0",70,0)
 ..D ^DIR I 'Y!($D(DIRUT)) Q
"RTN","PSORENW0",71,0)
 ..D NOOR^PSOCAN4 Q:$D(DIRUT)  D DE^PSOORFI2
"RTN","PSORENW0",72,0)
 .Q
"RTN","PSORENW0",73,0)
 I PSOY="",'$G(PSOORRNW) D
"RTN","PSORENW0",74,0)
 .W !,$C(7),"Cannot renew Rx # ",$P(PSORENW("RX0"),"^")," later Rx exists." S PSORENW("DFLG")=1
"RTN","PSORENW0",75,0)
 .S:$G(POERR) VALMSG="Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_" later Rx exists.",VALMBCK="R"
"RTN","PSORENW0",76,0)
 K PSOX,PSOY G:PSORENW("DFLG") CHECKX
"RTN","PSORENW0",77,0)
 ;
"RTN","PSORENW0",78,0)
 I $A($E(PSORENW("ORX #"),$L(PSORENW("ORX #"))))'<90 D  Q
"RTN","PSORENW0",79,0)
 . W !,$C(7),"Cannot renew Rx # "_PSORENW("ORX #")_", Max number of renewals reached."
"RTN","PSORENW0",80,0)
 .S:$G(POERR)!('$G(SPEED)) (ACOM,VALMSG)="Cannot renew Rx # "_PSORENW("ORX #")_", Max number reached.",VALMBCK="R"
"RTN","PSORENW0",81,0)
 . S PSORENW("DFLG")=1
"RTN","PSORENW0",82,0)
 .I $G(OR0)]"" D
"RTN","PSORENW0",83,0)
 ..S DRG=$P(^PSDRUG($P(^PSRX(PSORENW("OIRXN"),0),"^",6),0),"^")
"RTN","PSORENW0",84,0)
 ..W ! S DIR(0)="Y",DIR("A",1)="Do you want to Discontinue this Pending Order",DIR("A")="for "_DRG,DIR("B")="No"
"RTN","PSORENW0",85,0)
 ..D ^DIR I 'Y!($D(DIRUT)) Q
"RTN","PSORENW0",86,0)
 ..D NOOR^PSOCAN4 Q:$D(DIRUT)  D DE^PSOORFI2
"RTN","PSORENW0",87,0)
 .K ACOM Q
"RTN","PSORENW0",88,0)
 D CHKDIV G:PSORENW("DFLG") CHECKX
"RTN","PSORENW0",89,0)
 ;
"RTN","PSORENW0",90,0)
 D CHKPRV^PSOUTIL
"RTN","PSORENW0",91,0)
CHECKX Q
"RTN","PSORENW0",92,0)
 ;
"RTN","PSORENW0",93,0)
CHKDIV ;
"RTN","PSORENW0",94,0)
 G:$P(PSORENW("RX2"),"^",9)=+PSOSITE CHKDIVX
"RTN","PSORENW0",95,0)
 W !?5,$C(7),"RX # ",$P(PSORENW("RX0"),"^")," is for (",$P(^PS(59,$P(PSORENW("RX2"),"^",9),0),"^"),") division."
"RTN","PSORENW0",96,0)
 I '$P($G(PSOSYS),"^",2) S PSORENW("DFLG")=1 G CHKDIVX
"RTN","PSORENW0",97,0)
 D:$P($G(PSOSYS),"^",3) DIR
"RTN","PSORENW0",98,0)
CHKDIVX Q
"RTN","PSORENW0",99,0)
 ;
"RTN","PSORENW0",100,0)
DRUG ;
"RTN","PSORENW0",101,0)
 K PSOY
"RTN","PSORENW0",102,0)
 S PSOY=PSORENW("DRUG IEN"),PSOY(0)=^PSDRUG(PSOY,0),PSORENWD=1
"RTN","PSORENW0",103,0)
 I '$P($G(^PSDRUG(PSOY,2)),"^") D  Q:$G(PSORX("DFLG"))
"RTN","PSORENW0",104,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW0",105,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW0",106,0)
 D SET^PSODRG
"RTN","PSORENW0",107,0)
 D POST^PSODRG D:'PSORX("DFLG") DOSCK^PSODOSUT("R") S:$G(PSORX("DFLG")) PSORENW("DFLG")=1 ;remove order checks for v7. do allergy checks only
"RTN","PSORENW0",108,0)
 S PSONOOR=PSORENW("NOO")
"RTN","PSORENW0",109,0)
 K PSORX("INTERVENE")
"RTN","PSORENW0",110,0)
 S:$D(PSONEW("STATUS")) PSORENW("STATUS")=PSONEW("STATUS")
"RTN","PSORENW0",111,0)
 K PSOY,PSONEW("STATUS"),PSORENWD
"RTN","PSORENW0",112,0)
 Q
"RTN","PSORENW0",113,0)
 ;
"RTN","PSORENW0",114,0)
RXN ;
"RTN","PSORENW0",115,0)
 K PSOX
"RTN","PSORENW0",116,0)
 S PSOX=$E(PSORENW("ORX #"),$L(PSORENW("ORX #")))
"RTN","PSORENW0",117,0)
 S PSORENW("NRX #")=$S(PSOX?1N:PSORENW("ORX #")_"A",1:$E(PSORENW("ORX #"),1,$L(PSORENW("ORX #"))-1)_$C($A(PSOX)+1))
"RTN","PSORENW0",118,0)
RETRY I $O(^PSRX("B",PSORENW("NRX #"),0)) D  G:'$G(PSORENW("DFLG")) RETRY
"RTN","PSORENW0",119,0)
 .W:$A($E(PSORENW("NRX #"),$L(PSORENW("ORX #"))))'=90 !,"Rx # "_PSORENW("NRX #")_" is already on file."
"RTN","PSORENW0",120,0)
 .S:$G(PSOFDR) VALMSG="Rx # "_PSORENW("NRX #")_" is already on file."
"RTN","PSORENW0",121,0)
 .I $A($E(PSORENW("NRX #"),$L(PSORENW("ORX #"))))=90 D
"RTN","PSORENW0",122,0)
 ..W !,"Rx # "_PSORENW("NRX #")_" is already on file. Cannot renew Rx #"_PSORENW("ORX #")_".",!,"A new Rx must be entered.",!
"RTN","PSORENW0",123,0)
 ..S:$G(PSOFDR) VALMSG="Rx # "_PSORENW("NRX #")_" is already on file. Cannot renew Rx #"_PSORENW("ORX #")_". A new Rx must be entered."
"RTN","PSORENW0",124,0)
 ..K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSORENW0",125,0)
 ..S:$G(POERR)!($G(PSOFDR)) VALMSG="Cannot renew Rx # "_PSORENW("ORX #")_", Max number reached.",VALMBCK="R" S PSORENW("DFLG")=1
"RTN","PSORENW0",126,0)
 .S PSOX=$E(PSORENW("NRX #"),$L(PSORENW("NRX #")))
"RTN","PSORENW0",127,0)
 .S PSORENW("NRX #")=$S(PSOX?1N:PSORENW("NRX #")_"A",1:$E(PSORENW("NRX #"),1,$L(PSORENW("NRX #"))-1)_$C($A(PSOX)+1))
"RTN","PSORENW0",128,0)
RXNX K PSOX
"RTN","PSORENW0",129,0)
 Q
"RTN","PSORENW0",130,0)
 ;
"RTN","PSORENW0",131,0)
FILDATE ;
"RTN","PSORENW0",132,0)
 S PSORENW("IRXN")=PSORENW("OIRXN")
"RTN","PSORENW0",133,0)
 D NEXT^PSOUTIL(.PSORENW)
"RTN","PSORENW0",134,0)
 I PSORENW("FILL DATE")<$P(PSORENW("RX3"),"^",2) D
"RTN","PSORENW0",135,0)
 .D RENFDT^PSOUTIL(.PSORENW)
"RTN","PSORENW0",136,0)
 .I PSORENW("FILL DATE")<DT,PSORENW("FILL DATE")<PSORNW("FILL DATE") S (Y,PSORENW("FILL DATE"))=DT X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSORENW0",137,0)
 K PSORENW("IRXN")
"RTN","PSORENW0",138,0)
 Q
"RTN","PSORENW0",139,0)
 ;
"RTN","PSORENW0",140,0)
EDIT ;
"RTN","PSORENW0",141,0)
 K DIR,X,Y
"RTN","PSORENW0",142,0)
 S DIR(0)="Y",DIR("B")=$S($G(DUZ("AG"))'="I":"Y",$G(PSEXDT):"Y",1:"N")
"RTN","PSORENW0",143,0)
 S DIR("A")="Edit renewed Rx ",DIR("?")="Answer YES to edit the renewed Rx, NO not to."
"RTN","PSORENW0",144,0)
 D ^DIR K DIR S:$D(DIRUT) PSORENW("DFLG")=1
"RTN","PSORENW0",145,0)
 G:PSORENW("DFLG") EDITX
"RTN","PSORENW0",146,0)
 K PSOQUIT,PSORX("FN") I Y D INIT^PSORENW3,EN^PSOORNE4(.PSORENW) S:$G(PSOQUIT) PSORENW("DFLG")=1 I '$G(PSORX("FN")) D FULL^VALM1 Q
"RTN","PSORENW0",147,0)
 Q:$G(PSORX("FN"))
"RTN","PSORENW0",148,0)
EDITX S PSOEDT=1,VALMBCK="Q" K X,Y,DIRUT,DTOUT,DUOUT S PSORENW("QFLG")=1
"RTN","PSORENW0",149,0)
 Q
"RTN","PSORENW0",150,0)
 ;
"RTN","PSORENW0",151,0)
DELETE ;
"RTN","PSORENW0",152,0)
 K DA,DIK
"RTN","PSORENW0",153,0)
 S DA=$O(^PS(52.5,"B",PSORENW("OIRXN"),0)),DIK="^PS(52.5,"
"RTN","PSORENW0",154,0)
 D ^DIK K DIK,DIC
"RTN","PSORENW0",155,0)
 Q
"RTN","PSORENW0",156,0)
 ;
"RTN","PSORENW0",157,0)
CAN ;
"RTN","PSORENW0",158,0)
 K REA,DA,MSG
"RTN","PSORENW0",159,0)
 S REA="C",DA=PSORENW("OIRXN")
"RTN","PSORENW0",160,0)
 S MSG="Renewed"_$S($G(PSOFDR):" from CPRS",1:"")
"RTN","PSORENW0",161,0)
 S PSCAN(PSORENW("ORX #"))=DA_"^C"
"RTN","PSORENW0",162,0)
 D CAN^PSOCAN
"RTN","PSORENW0",163,0)
 K REA,DA,MSG,PSCAN
"RTN","PSORENW0",164,0)
 Q
"RTN","PSORENW0",165,0)
 ;
"RTN","PSORENW0",166,0)
DIR ;
"RTN","PSORENW0",167,0)
 S DIR(0)="Y",DIR("A")="CONTINUE ",DIR("B")="N"
"RTN","PSORENW0",168,0)
 S DIR("?")="Answer YES to Continue, NO to bypass"
"RTN","PSORENW0",169,0)
 D ^DIR K DIR
"RTN","PSORENW0",170,0)
 S:$D(DIRUT)!('Y) PSORENW("DFLG")=1
"RTN","PSORENW0",171,0)
DIRX K DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSORENW0",172,0)
 Q
"RTN","PSORENW0",173,0)
NEWPT ;
"RTN","PSORENW0",174,0)
 S PSOQFLG=0
"RTN","PSORENW0",175,0)
 S PSODFN=PSORENW("PSODFN")
"RTN","PSORENW0",176,0)
 D ^PSOPTPST I PSOQFLG S PSORENW("DFLG")=1,PSOQFLG=0 G NEWPTX
"RTN","PSORENW0",177,0)
 D PROFILE^PSOREF1
"RTN","PSORENW0",178,0)
NEWPTX Q
"RTN","PSORENW0",179,0)
 ;
"RTN","PSORENW0",180,0)
EN(PSORENW)        ; Entry Point for Batch Barcode Option
"RTN","PSORENW0",181,0)
 S PSORENRX=$G(PSOBBC("OIRXN"))
"RTN","PSORENW0",182,0)
 I $G(PSORENRX) D PSOL^PSSLOCK(PSORENRX) I '$G(PSOMSG) D  K DIR,PSOMSG W ! S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR W ! Q
"RTN","PSORENW0",183,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P(PSOMSG,"^",2) Q
"RTN","PSORENW0",184,0)
 .W $C(7),!!,"Another person is editing Rx "_$P($G(^PSRX(PSORENRX,0)),"^")
"RTN","PSORENW0",185,0)
 K PSOMSG,PSOBBCLK S PSOBARCD=1 D PROCESS K PSOBARCD
"RTN","PSORENW0",186,0)
 D KLIB^PSORENW1
"RTN","PSORENW0",187,0)
 I $G(PSORENRX),$G(PSOBBCLK) D PSOUL^PSSLOCK(PSORENRX)
"RTN","PSORENW0",188,0)
 K PSORENRX,PSOBBCLK
"RTN","PSORENW0",189,0)
 Q
"RTN","PSORENW0",190,0)
CDOSE ;Validate Dosage field on Renewal, Copy, Edit
"RTN","PSORENW0",191,0)
 ;PSOOCPRX must be set to internal Rx number
"RTN","PSORENW0",192,0)
 Q:'$G(PSOOCPRX)
"RTN","PSORENW0",193,0)
 N PSOOLP,PSOOKZ
"RTN","PSORENW0",194,0)
 S PSOOLP="",(PSOOLPF,PSONOSIG)=0 F  S PSOOLP=$O(^PSRX(PSOOCPRX,6,PSOOLP)) Q:PSOOLP=""!(PSOOLPF)  I $P($G(^PSRX(PSOOCPRX,6,PSOOLP,0)),"^")["0.." S PSOOLPD=$P($G(^(0)),"^"),PSOOLPF=1
"RTN","PSORENW0",195,0)
 Q:PSOOLPF
"RTN","PSORENW0",196,0)
 S PSOOKZ=0
"RTN","PSORENW0",197,0)
 I $P($G(^PSRX(PSOOCPRX,"SIG")),"^",2) S PSOOLP="" F  S PSOOLP=$O(^PSRX(PSOOCPRX,"SIG1",PSOOLP)) Q:PSOOLP=""!(PSOOKZ)  I $G(^PSRX(PSOOCPRX,"SIG1",PSOOLP,0))'="" S PSOOKZ=1
"RTN","PSORENW0",198,0)
 I '$P($G(^PSRX(PSOOCPRX,"SIG")),"^",2),$P($G(^("SIG")),"^")'="" S PSOOKZ=1
"RTN","PSORENW0",199,0)
 I 'PSOOKZ S PSONOSIG=1
"RTN","PSORENW0",200,0)
 Q
"RTN","PSORENW0",201,0)
 ;
"RTN","PSORXEDT")
0^39^B41063985
"RTN","PSORXEDT",1,0)
PSORXEDT ;BIR/SAB-edit rx routine ;10/21/98
"RTN","PSORXEDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**21,23,44,71,146,185,148,253,372**;DEC 1997;Build 54
"RTN","PSORXEDT",3,0)
 ;Ref. ^PS(55 supp. IA 2228
"RTN","PSORXEDT",4,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) G EOJ Q
"RTN","PSORXEDT",5,0)
 K PSODRUG,PSOLIST,DIR,DIRUT,DUOUT,X,Y,PSOFROM,^TMP("PSOBEDT",$J),NOPP,CLOZPST
"RTN","PSORXEDT",6,0)
 N PSOODOSP
"RTN","PSORXEDT",7,0)
 W !! S DIR(0)="FAO^1:245",DIR("A")="Edit Rx(s) => ",DIR("?",1)="Enter Rx Number or A List of numbers Separated",DIR("?")="by Commas, e.g. 1234A,345,937002Q."
"RTN","PSORXEDT",8,0)
 D ^DIR K DIR G:$D(DIRUT) EOJ
"RTN","PSORXEDT",9,0)
 S END=$L(X,","),BAD=0
"RTN","PSORXEDT",10,0)
 F I=1:1:END S RXM=$P(X,",",I) I +RXM F J=I+1:1:END S DUP=$P(X,",",J) I DUP=RXM S $P(X,",",J)="" W !?5,$C(7),"Duplicate Rx # "_RXM_"  was found in your list, ignoring it!",! S BAD=1
"RTN","PSORXEDT",11,0)
 S PSORLST=$P(X,",") F I=2:1:END S RXM=$P(X,",",I) S:RXM'?1.N.A BAD=1 I RXM?1.N.A S PSORLST=PSORLST_","_RXM
"RTN","PSORXEDT",12,0)
 F I=1:1:$L(PSORLST) S RXM=$P(PSORLST,",",I) I +RXM F J=I+1:1:END S DUP=$P(PSORLST,",",J) I DUP=RXM S $P(PSORLST,",",J)=""
"RTN","PSORXEDT",13,0)
BAD I PSORLST D  I 'Y K Y G PSORXEDT
"RTN","PSORXEDT",14,0)
 .W !?15,"=> "_PSORLST
"RTN","PSORXEDT",15,0)
 .K DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OKAY ",DIR("B")="Yes"
"RTN","PSORXEDT",16,0)
 .D ^DIR K DIR
"RTN","PSORXEDT",17,0)
 .I 'Y!$D(DIRUT) K X,PSORLST,BAD
"RTN","PSORXEDT",18,0)
 K BAD I 'PSORLST K PSORLST G PSORXEDT
"RTN","PSORXEDT",19,0)
 F I=1:1:$L(PSORLST,",") S RXM=$P(PSORLST,",",I) S GOOD=$D(^PSRX("B",RXM)) D
"RTN","PSORXEDT",20,0)
 .I 'GOOD W !!?5,"Couldn't Find RX # "_RXM H 3 Q
"RTN","PSORXEDT",21,0)
 .S RXN=$O(^PSRX("B",RXM,0)) D  I $P(^PSRX(RXN,"STA"),"^")=13 W !!?5,"Rx # "_RXM_" is marked for Deletion." H 3 Q
"RTN","PSORXEDT",22,0)
 ..I $G(RXN),$P($G(^PS(55,+$P($G(^PSRX(RXN,0)),"^",2),0)),"^",6)'=2 S PSOLOUD=1 D EN^PSOHLUP(+$P($G(^PSRX(RXN,0)),"^",2)) K PSOLOUD
"RTN","PSORXEDT",23,0)
 .D LIST K GOOD
"RTN","PSORXEDT",24,0)
 K GOOD,END
"RTN","PSORXEDT",25,0)
EPH ; - Entry for Epharmacy Rx Edit (PSOREJP1)
"RTN","PSORXEDT",26,0)
 F PSOT1=1:1 Q:'$D(PSOLIST(PSOT1))  F PSOLST2=1:1:$L(PSOLIST(PSOT1),",") S ORN=$P(PSOLIST(PSOT1),",",PSOLST2) D:+ORN PT
"RTN","PSORXEDT",27,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORXEDT",28,0)
 K POP,PSOLIST,TM,TM1 G:'$O(PSORX("PSOL",0)) NX
"RTN","PSORXEDT",29,0)
 D:$G(PSORX("PSOL",1))]"" ^PSORXL K PSORX G:$G(NOBG) NX
"RTN","PSORXEDT",30,0)
PRF G:'$P(PSOPAR,"^",8)!($G(NOPP)="H")!($G(NOPP)="S")!('$D(^TMP("PSOBEDT",$J))) BBG
"RTN","PSORXEDT",31,0)
 I $O(^TMP("PSOBEDT",$J,0)),$P(PSOPAR,"^",8) S PSOFROM="NEW",PSOION=ION K RXRS
"RTN","PSORXEDT",32,0)
 G:$D(PSOPROP)&($G(PSOPROP)'=ION) QUP
"RTN","PSORXEDT",33,0)
 I '$D(PSOPROP)!($G(PSOPROP)=ION) D  G:$G(POP)!($E(IOST)["C")!(PSOION=ION) BBG
"RTN","PSORXEDT",34,0)
 .S PSOION=ION W !,"Profiles must be sent to Printer !!",! K IOP,%ZIS,IO("Q"),POP
"RTN","PSORXEDT",35,0)
 .S %ZIS="MNQ",%ZIS("A")="Select Profile Device: " D ^%ZIS K %ZIS("A")
"RTN","PSORXEDT",36,0)
 .Q:$G(POP)!($E(IOST)["C")!(PSOION=ION)  S PSOPROP=ION
"RTN","PSORXEDT",37,0)
QUP S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X,HOLDRPAS=$G(PSOPRPAS),PSOPRPAS=$P(PSOPAR,"^",13)
"RTN","PSORXEDT",38,0)
 F DFN=0:0 S DFN=$O(^TMP("PSOBEDT",$J,DFN)) Q:'DFN  S PPL=^TMP("PSOBEDT",$J,DFN,0) D
"RTN","PSORXEDT",39,0)
 .S ZTRTN="DQ^PSOPRF",ZTIO=PSOPROP,ZTDESC="Outpatient Pharmacy Patient Profiles",ZTDTH=$H
"RTN","PSORXEDT",40,0)
 .F G="PSOPAR","PSODTCUT","PSOPRPAS","DFN","PSOSITE","NEW1","NEW11","PSOBMST","PFIO","PPL" S:$D(@G) ZTSAVE(G)=""
"RTN","PSORXEDT",41,0)
 .D ^%ZTLOAD
"RTN","PSORXEDT",42,0)
 W:$D(ZTSK) !,"PROFILE(S) QUEUED to PRINT",!! K G,ZTSK D ^%ZISC
"RTN","PSORXEDT",43,0)
 S PSOPRPAS=$G(HOLDRPAS) K:PSOPRPAS']"" PSOPRPAS K HOLDRPAS
"RTN","PSORXEDT",44,0)
BBG K DFN F PSODFN=0:0 S PSODFN=$O(^TMP("PSOBEDT",$J,PSODFN)) Q:'PSODFN  I $G(^TMP("PSOBEDT",$J,PSODFN,1)),$D(DISGROUP) S TM=$P($G(^TMP("PSOBB",$J)),"^"),TM1=$P($G(^($J)),"^",2),PPL=^TMP("PSOBEDT",$J,PSODFN,0) D ^PSOBING1
"RTN","PSORXEDT",45,0)
NX ;
"RTN","PSORXEDT",46,0)
 K %X,%Y,ACTREF,ACTREN,D,D0,DAT,DFN,DIC,DIQ,DQ,DRG,END,FDR,PSOBEDT,TM,TM1,PSOT1,PSOLST2,NOBG,BBFLG,BINGCRT,BINGRTE,C,CC,CMOP,COM,CT,D1,DI,DREN,BBRX,PSOFROM,POP,PSORX("QFLG"),IT,PSOERR,PSOBCK,PSOBM,PPL
"RTN","PSORXEDT",47,0)
 K ^TMP("PSOBEDT",$J),^TMP("PSOBB",$J),ZTSK,NOPP,VALMSG,VALMBCK D EOJ
"RTN","PSORXEDT",48,0)
END Q
"RTN","PSORXEDT",49,0)
 ;---------------------------------------------------------
"RTN","PSORXEDT",50,0)
PT ;
"RTN","PSORXEDT",51,0)
 N PSOTXEDT,PSOTPEXT S PSOTXEDT=$P($G(^PSRX(ORN,0)),"^",2) I PSOTXEDT I $D(^PS(52.91,PSOTXEDT,0)) I '$P(^PS(52.91,PSOTXEDT,0),"^",3)!($P(^(0),"^",3)>DT) D PDIR^PSOTPCAN(PSOTXEDT) I $G(PSOTPEXT) K PSOTPEXT,PSOTXEDT D EOJ Q
"RTN","PSORXEDT",52,0)
 K PSOTXEDT,PSOTPEXT
"RTN","PSORXEDT",53,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",54,0)
 S $P(PSOLST(ORN),"^",2)=ORN,(PSOBEDT)=1
"RTN","PSORXEDT",55,0)
 S (DFN,PSODFN)=+$P(^PSRX(ORN,0),"^",2),PSORX("NAME")=$P(^DPT(DFN,0),"^") I PSODFN'=$G(PSOODOSP) K PSORX("DOSING OFF") S PSOODOSP=PSODFN
"RTN","PSORXEDT",56,0)
 D ICN^PSODPT(DFN)
"RTN","PSORXEDT",57,0)
 S RX0=^PSRX(ORN,0),RX2=$G(^(2)),RX3=$G(^(3))
"RTN","PSORXEDT",58,0)
 D:$G(DUZ("AG"))="V" COPAY^PSOPTPST ; Deals with copay
"RTN","PSORXEDT",59,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) D ^VADPT,ADD^VADPT
"RTN","PSORXEDT",60,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSORXEDT",61,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2)
"RTN","PSORXEDT",62,0)
 S ^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSORXEDT",63,0)
 S POERR=1 D RE^PSODEM K POERR,VALMBCK
"RTN","PSORXEDT",64,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSORXEDT",65,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSORXEDT",66,0)
 S ^TMP("PSOHDR",$J,9,0)="",^TMP("PSOHDR",$J,10,0)=""
"RTN","PSORXEDT",67,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSORXEDT",68,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORXEDT",69,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORXEDT",70,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORXEDT",71,0)
 D CLEAR^VALM1
"RTN","PSORXEDT",72,0)
 S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSORXEDT",73,0)
 S $P(PSOLST(ORN),"^",3)=$P(STA,"^",$P(^PSRX(ORN,"STA"),"^")+1),PSLST=ORN,ORD=1
"RTN","PSORXEDT",74,0)
 D ACT^PSOORNE2
"RTN","PSORXEDT",75,0)
EOJ ;
"RTN","PSORXEDT",76,0)
 K INS1,HDR,IK,INDT,LOG,NODE,ORN,P1,PSI,PSL,PSOLION,PSNP,PSOACT,PSOBM,PSOCLC,PSOCNT,PSODD,PSODFN,PSOHD,PSOJ,PSOLST,PSOOI,PSOPF,PSLST
"RTN","PSORXEDT",77,0)
 K PSOIBQS,PSORLST,PSOSD,PSOSIG,PSPRXN,PSORX0,PSORX1,PTST,REFL,RF,RFD,RIFN,RLD,RPH,RTS,RX0,RX1,RX2,RX3,RXM,RXOR,SIG,SIGOK
"RTN","PSORXEDT",78,0)
 D KVA^VADPT K SLPPL,ST,STA,^TMP("PS",$J),PSOQFLG,PSORXED,PSOEDIT,DIR,DIRUT,DUOUT,DTOUT,PSOLOUD,GMRAL,GG,FEV,ACNT
"RTN","PSORXEDT",79,0)
 D FULL^VALM1 K ^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J),PAT
"RTN","PSORXEDT",80,0)
 K JJ,K,MM,PSDAYS,PSOAC,PSOAL,PSOCOU,PSOCOUU,PSONEW,PSODRUG,PSONOOR,PSRX0,QTY,REA,RFCNT,RFDT,RXDA,RXFL,RXREF,SUB,X,Z,ZII
"RTN","PSORXEDT",81,0)
 K ACOM,CRIT,DA,DDH,DGI,DGS,PSONEW3,SER,SERS,ZONE,RN,RXN,PSOX,PSOERR,ORD,PSOBCK,PSOBILL,SURX,PSORX("QFLG"),PSORX("FN"),CLOZPAT
"RTN","PSORXEDT",82,0)
 Q
"RTN","PSORXEDT",83,0)
LIST ;
"RTN","PSORXEDT",84,0)
 I $G(^PSRX(RXN,0))']"" W !,$C(7),"Rx data is not on file !",! G LISTX
"RTN","PSORXEDT",85,0)
 I $P(^PSRX(RXN,0),"^",15)=13 S PSVD=1 W !,$C(7),"Rx # "_RXM_" has been deleted."
"RTN","PSORXEDT",86,0)
 S RXN1=RXN,RXM1=RXM D:'$G(PSVD) LST1 W "." S RXN=RXN1,RXM=RXM1 K RXN1,RXM1
"RTN","PSORXEDT",87,0)
 F  S RXN=$O(^PSRX("B",RXM,RXN)) Q:'RXN  D
"RTN","PSORXEDT",88,0)
 .I $G(^PSRX(RXN,0))']"" Q
"RTN","PSORXEDT",89,0)
 .I $P(^PSRX(RXN,0),"^",15)=13 Q
"RTN","PSORXEDT",90,0)
 .D LST1
"RTN","PSORXEDT",91,0)
 K RXN1 G LISTX
"RTN","PSORXEDT",92,0)
 Q
"RTN","PSORXEDT",93,0)
LST1 I $G(PSOLIST(1))']"" S PSOLIST(1)=RXN_"," G LISTX
"RTN","PSORXEDT",94,0)
 F PSOX1=0:0 S PSOX1=$O(PSOLIST(PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORXEDT",95,0)
 I $L(PSOLIST(PSOX2))+$L(RXN)<220 S:RXN_","'[PSOLIST(PSOX2) PSOLIST(PSOX2)=PSOLIST(PSOX2)_RXN_","
"RTN","PSORXEDT",96,0)
 E  S:RXN_","'[PSOLIST(PSOX2+1) PSOLIST(PSOX2+1)=RXN_","
"RTN","PSORXEDT",97,0)
LISTX K PSOX1,PSOX2,RXN,PSVD
"RTN","PSORXEDT",98,0)
 Q
"RTN","PSOVER")
0^15^B88226703
"RTN","PSOVER",1,0)
PSOVER ;BIR/SAB - verify rx's by clerk ;07/03/95
"RTN","PSOVER",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**16,21,27,117,131,146,251,375,387,379,391,372**;DEC 1997;Build 54
"RTN","PSOVER",3,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER",4,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOVER",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! Q
"RTN","PSOVER",6,0)
 Q:'$D(^XUSEC("PSORPH",DUZ))  S PSOZVER=1
"RTN","PSOVER",7,0)
PAT K PSOTT,PSOACT,PSOVER,PSOQUIT,PSORX("DFLG"),DTOUT,DIRUT,PSOVQUIT W !! S DIC("A")="Enter PATIENT NAME (or ^C to verify for a clerk): ",DIC="^DPT(",DIC("S")="I $D(^PS(52.4,""C"",+Y))",DIC(0)="QEAMZ" D ^DIC K DIC G CLERK:$E(X,1,2)="^C",END:Y'>0
"RTN","PSOVER",8,0)
 S PSONV=0,(DFN,PSDFN,PSODFN)=+Y,PPL="",PSONAM=$P(^DPT(PSDFN,0),"^") D ^PSOBUILD
"RTN","PSOVER",9,0)
L1 D PID^VADPT S PSONV=$O(^PS(52.4,"C",PSDFN,PSONV)) I 'PSONV D:$$GET1^DIQ(52,PSONV,100,"I")'=13 PACK G PAT
"RTN","PSOVER",10,0)
 F DGDG=0:0 S DGDG=$O(^PS(52.4,"C",PSDFN,DGDG)) S PSONV=DGDG K PSOSIG,PSOTHER Q:'DGDG!($G(PSOQUIT))  D  Q:$G(DIRUT)
"RTN","PSOVER",11,0)
 .I $D(^PS(52.4,"ADI",DGDG,1)) S PSONV=DGDG D DGDGI Q
"RTN","PSOVER",12,0)
 .I $D(^PSRX(PSONV,"DRI")) S PSOSIG=1 D DGDGI Q
"RTN","PSOVER",13,0)
 .D:'$D(^PS(52.4,"ADI",PSONV,1))&('$D(^PSRX(PSONV,"DRI"))) DSPL Q
"RTN","PSOVER",14,0)
 G QUIT:$D(PSOSD)
"RTN","PSOVER",15,0)
 ;
"RTN","PSOVER",16,0)
SHOW I '$D(PSOSD) W !,$C(7),"This patient has no prescriptions on file",!! Q
"RTN","PSOVER",17,0)
 I ($Y+5)>IOSL D HD^PSODDPR2(5) Q:$G(PSODLQT)
"RTN","PSOVER",18,0)
 W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"")
"RTN","PSOVER",19,0)
 D ^PSODSPL
"RTN","PSOVER",20,0)
SHOW2 ;
"RTN","PSOVER",21,0)
 I ($Y+5)>IOSL D HD^PSODDPR2() Q
"RTN","PSOVER",22,0)
 Q:$Y<5
"RTN","PSOVER",23,0)
 N DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","PSOVER",24,0)
 K DIR W ! S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOVER",25,0)
 W @IOF
"RTN","PSOVER",26,0)
 Q
"RTN","PSOVER",27,0)
 ;
"RTN","PSOVER",28,0)
CLERK D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! G END
"RTN","PSOVER",29,0)
 K PSOVERPL,PSOVERPX,PSOVERPH,PSOVERLX,PSOVERQ,PSORX("DFLG"),DIRUT,DTOUT,PSOVQUIT
"RTN","PSOVER",30,0)
 K PSOQUIT,PSOCQ,PSOVORD,PSOINTV S PSOCLK=1 W ! S DIC="^VA(200,",DIC(0)="AEQM",DIC("S")="I $D(^PS(52.4,""D"",+Y))",DIC("A")="Enter Clerk Name: "
"RTN","PSOVER",31,0)
 D ^DIC K DIC K:Y'>0!($D(DTOUT)) PSORX G END:Y'>0!($D(DTOUT))
"RTN","PSOVER",32,0)
 N PSOODOSP S PSOTT=+Y,(PSONV,PSDFN0)=0,PPL="" K PSOVER,PSONAM
"RTN","PSOVER",33,0)
CL1 F DGDG=0:0 S DGDG=$O(^PS(52.4,"D",PSOTT,DGDG)) Q:'DGDG!($G(PSOQUIT))!($G(PSOCQ))  D  Q:$D(DIRUT)
"RTN","PSOVER",34,0)
 .S PSOVQUIT=0,(DFN,PSOVERPX,PSDFN,PSODFN)=$P(^PS(52.4,DGDG,0),"^",2),PSONV=DGDG D  D PATCHK K PSOSIG,PSOTHER
"RTN","PSOVER",35,0)
 ..I $G(PSOODOSP)'=DFN S PSOODOSP=DFN K PSORX("DOSING OFF")
"RTN","PSOVER",36,0)
 .S CLFLAG=1 D STAT^PSODGDG2 K CLFLAG D:'$G(FLAGST)  Q:$D(DIRUT)
"RTN","PSOVER",37,0)
 ..S PSONVXX=PSONV I $G(PSOVERPH)=$G(PSOVERPX),$G(PSOVERLX) Q
"RTN","PSOVER",38,0)
 ..I $G(PSOVERPH)'=$G(PSOVERPX) K PSOVERLX D:$G(PSOVERPH)&('$G(PSOVERPL)) ULP S PSOVERPH=PSOVERPX D LPAT I $G(PSOVERPL) Q
"RTN","PSOVER",39,0)
 ..S PSDFN0=PSDFN D LRX I '$G(PSOMSG) Q
"RTN","PSOVER",40,0)
 ..K PSOMSG I $D(^PS(52.4,"ADI",DGDG,1)) S PSONV=DGDG D DSPL D PSOUL^PSSLOCK(PSONVXX) Q
"RTN","PSOVER",41,0)
 ..I $D(^PSRX(PSONV,"DRI")) S PSOSIG=1 D DSPL D PSOUL^PSSLOCK(PSONVXX) Q
"RTN","PSOVER",42,0)
 ..D:'$D(^PS(52.4,"ADI",PSONV,1))&('$D(^PSRX(PSONV,"DRI"))) DSPL D PSOUL^PSSLOCK(PSONVXX) Q
"RTN","PSOVER",43,0)
 D:$G(PSOVERPH)&('$G(PSOVERPL)) ULP
"RTN","PSOVER",44,0)
CL2 D:$$GET1^DIQ(52,PSONV,100,"I")'=13 PACK G CLERK
"RTN","PSOVER",45,0)
PATCHK I $D(PSOVER),PSDFN0,PSDFN0'=DFN S (DFN,PSDFN)=PSDFN0 D PACK S (DFN,PSDFN)=PSODFN D ^PSOBUILD,PID^VADPT S PSONAM=$P(^DPT(DFN,0),"^") Q
"RTN","PSOVER",46,0)
 I PSDFN0'=DFN D ^PSOBUILD,PID^VADPT S PSONAM=$P(^DPT(DFN,0),"^")
"RTN","PSOVER",47,0)
 Q
"RTN","PSOVER",48,0)
PACK Q:$$GET1^DIQ(52,PSONV,100,"I")=13  S PPL="" F J=0:0 S J=$O(PSOVER(J)) Q:'J  S PPL=PPL_J_","
"RTN","PSOVER",49,0)
 I PPL]"" S PSOOPT=3,PSOTRVV=1 D ^PSORXL K PSOOPT,PSOTRVV
"RTN","PSOVER",50,0)
 K PSD,PSOVER S PPL="" Q
"RTN","PSOVER",51,0)
QUIT D PACK
"RTN","PSOVER",52,0)
END K CAN,CLS,DA,DEA1,DEA2,DIC,DIE,DR,DRG,DRGG,DUP,DUPRX,DUPRX0,FLDT,I,ISDT,ISSD,J,LSTFL,PHYS,PPL,PSC,PSD,PSDFN,PSDFN0,PSDNEW,PSDOLD,PSMSG,PSOQUIT,PSOTT,PSOVER,PSREA,PSRFLS,PSRX,PSRX1,PSRX2,PSRXREF,PSVERFLG,RFLS,RX0,RX2,RX3,ST,ST0,STAR,X
"RTN","PSOVER",53,0)
 K D0,DQ,N,PHY,RFL,PSI,PSOTHER,PSS,PSOZVER,PI,PTST,SD,PSONAM,PSONULN,RFDATE,RFL1,RXF,Z,DRUG,II,RFLL,DRGX,DIPGM,PSOCNT,A1,C,ST00,FLAGST,STEXT,PSOCLK,PSOCQ,PSOVERPL,PSOVERPX,PSOVERPH,PSOVERLX,VERLFLAG,PSONVXX D KVA^VADPT
"RTN","PSOVER",54,0)
 K PSONOOR,PSOSIG,DIR,DUOUT,DTOUT,DIRUT,DIROUT,INA,MED,SER1,PSOVORD,PSOINTV,PSOVQUIT,PSVFLAG,PSOOVNOD,PSOOVSTA
"RTN","PSOVER",55,0)
 Q
"RTN","PSOVER",56,0)
DSPL ;
"RTN","PSOVER",57,0)
 Q:$P(^PSRX(PSONV,"STA"),"^")=13
"RTN","PSOVER",58,0)
 S DA=PSONV
"RTN","PSOVER",59,0)
 D SAVE
"RTN","PSOVER",60,0)
 S PSVFLAG=1 D ^PSOVER1 I $G(PSORX("DFLG")) K PSVFLAG
"RTN","PSOVER",61,0)
 Q
"RTN","PSOVER",62,0)
DGDGI ;process drug interaction for non verified rxs
"RTN","PSOVER",63,0)
 K DIRUT,DTOUT,PSORX("DFLG")
"RTN","PSOVER",64,0)
 S SER1=$S('$G(PSOSIG):$P(^PS(52.4,PSONV,0),"^",9),1:$P(^PSRX(PSONV,"DRI"),"^")),PSVFLAG=1
"RTN","PSOVER",65,0)
 S MED=$S('$G(PSOSIG):$P(^PS(52.4,PSONV,0),"^",10),1:$P(^PSRX(PSONV,"DRI"),"^",2))
"RTN","PSOVER",66,0)
 K LOCKARRY,PSOVMSGX S VERLFLAG=0 I $G(MED) F LOCKINA=1:1 S PSOLKVRX=$P(MED,",",LOCKINA) Q:$G(PSOLKVRX)=""!($G(VERLFLAG))  D LK1
"RTN","PSOVER",67,0)
 K PSOVMSGX
"RTN","PSOVER",68,0)
 S PSVERFLG=0,IFN=PSONV,INT=^PSRX(IFN,0) N PSOOLDFN S PSOOLDFN=DFN
"RTN","PSOVER",69,0)
 F INA=1:1 S PSODFN=DFN Q:$P(SER1,",",INA)=""!($G(MED)="")  D  Q:$G(PSOVQUIT)!$G(PSORX("DFLG"))
"RTN","PSOVER",70,0)
 .I $P(SER1,",",INA) S SER=^PS(56,$P(SER1,",",INA),0)
"RTN","PSOVER",71,0)
 .E  S $P(SER,"^",4)=$S($P(SER1,",",INA)="Critical":1,1:2)
"RTN","PSOVER",72,0)
 .S RX=^PSRX(PSONV,0),STA=+$G(^("STA")),$P(RX,"^",15)=STA,PSOOPT=1
"RTN","PSOVER",73,0)
 .W !!!,$P(^DPT(DFN,0),"^"),?39,"ID#: ",$E($P(^(0),"^",9),1,3)_"-"_$E($P(^(0),"^",9),4,5)_"-"_$E($P(^(0),"^",9),6,9),?57,"RX: ",$P(^PSRX(PSONV,0),"^")
"RTN","PSOVER",74,0)
 .I STA'=13 D FULL^VALM1 D SAVE,^PSOVER1  S:'$G(DFN) DFN=PSOOLDFN
"RTN","PSOVER",75,0)
 Q:$G(PSORX("DFLG"))  Q:$G(DIRUT)!($G(DTOUT))
"RTN","PSOVER",76,0)
 I '$G(PSVERFLG),$P(^PSRX(PSONV,"STA"),"^")=4!($P(^("STA"),"^")=1) S $P(^PSRX(PSONV,"STA"),"^")=1 D DSPL G DONE
"RTN","PSOVER",77,0)
 I '$D(^PS(52.4,"ADI",PSONV,1)),$P(^PSRX(PSONV,"STA"),"^")=1 D DSPL G DONEX:$G(DIRUT)!($G(DTOUT)) G DONE
"RTN","PSOVER",78,0)
DONE ;
"RTN","PSOVER",79,0)
 I $P(^PSRX(PSONV,"STA"),"^")=4 S ^PS(52.4,"ADI",PSONV,1)=""
"RTN","PSOVER",80,0)
 K PSOVORD I $P(^PSRX(PSONV,"STA"),"^")'=1,$P(^("STA"),"^")'=4 K ^PSRX(PSONV,"DRI")
"RTN","PSOVER",81,0)
 S PSOTHER="" F  S PSOTHER=$O(PSOTHER(PSOTHER)) Q:PSOTHER=""  D
"RTN","PSOVER",82,0)
 .I $G(PSOTHER),$P($G(^PSRX(PSOTHER,"STA")),"^")=1,$P($G(^PS(52.4,PSOTHER,0)),"^",10)="" S PSONV=PSOTHER D DSPL
"RTN","PSOVER",83,0)
 D:$D(LOCKARRY) ULK1
"RTN","PSOVER",84,0)
DONEX K PSOOPT,SER,LOCKARRY,LOCKINA,PSOLKVRX,DTOUT,DIRUT,PSORX("DFLG"),PSOOVNOD,PSOOVSTA
"RTN","PSOVER",85,0)
 Q
"RTN","PSOVER",86,0)
OERR ;
"RTN","PSOVER",87,0)
 N PSOEDITF,PSOVEDIT,PSOOORN,XQORNOD,Y,PSOVBCK S PSOVEDIT=0
"RTN","PSOVER",88,0)
 K PSONOOR,PSODLQT,PSOVER,PSVERFLG,PSOVORD,PSOSIG I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item!",VALMBCK="" Q
"RTN","PSOVER",89,0)
 I $G(PSOTPBFG) N PSOTPPEN,PSOTPPEX,PSOTPPE9 S PSOTPPEN=$P(PSOLST($P(PSLST,",",ORD)),"^",2),PSOTPPEX=0,PSOTPPE9=1 D VOPN^PSOTPCAN I PSOTPPEX S VALMBCK="" K PSOTPPEN,PSOTPPEX,PSOTPPE9 Q
"RTN","PSOVER",90,0)
 K PSOTPPEN,PSOTPPEX,PSOTPPE9,PSORX("DFLG")
"RTN","PSOVER",91,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOVER",92,0)
 I '$D(^PSRX(+$P(PSOLST($P(PSLST,",",ORD)),"^",2),"PKI")),'$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Unauthorized Action!",VALMBCK="" Q
"RTN","PSOVER",93,0)
 I $$PATCH^XPDUTL("PSO*7.0*391"),$D(^PSRX(+$P(PSOLST($P(PSLST,",",ORD)),"^",2),"PKI")) N FL S FL=0 D  I FL Q
"RTN","PSOVER",94,0)
 .I $P($G(^PSRX(+$P(PSOLST($P(PSLST,",",ORD)),"^",2),"PKI")),"^"),'$D(^XUSEC("PSDRPH",DUZ)) S VALMSG="Digitally Signed Order - PSDRPH key required",VALMBCK="",FL=1 Q
"RTN","PSOVER",95,0)
 .I $P($G(^PSRX(+$P(PSOLST($P(PSLST,",",ORD)),"^",2),"PKI")),"^",2),'$D(^XUSEC("PSDRPH",DUZ)) S VALMSG="CS Order - PSDRPH key is required",VALMBCK="",FL=1 Q
"RTN","PSOVER",96,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Unauthorized Action!",VALMBCK="" Q
"RTN","PSOVER",97,0)
 S PSOVRXN=$P(PSOLST($P(PSLST,",",ORD)),"^",2),PSOVDFN=$P($G(^PSRX(PSOVRXN,0)),"^",2)
"RTN","PSOVER",98,0)
 S PSOPLCK=$$L^PSSLOCK(PSOVDFN,0) I '$G(PSOPLCK) S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is editing orders for this patient.") S VALMBCK="" K PSOPLCK Q
"RTN","PSOVER",99,0)
 K PSOPLCK D PSOL^PSSLOCK(PSOVRXN) I '$G(PSOMSG) D UL^PSSLOCK(PSOVDFN) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.") K PSOMSG S VALMBCK="" Q
"RTN","PSOVER",100,0)
 N PSODFN S (PSOZVER,PSLSTVER)=1
"RTN","PSOVER",101,0)
 D FULL^VALM1 S (PSONV,X,DA)=$P(PSOLST($P(PSLST,",",ORD)),"^",2)
"RTN","PSOVER",102,0)
 I '$D(^PS(52.4,PSONV,0)) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOVER",103,0)
 S PSOOVNOD=^PS(52.4,PSONV,0),PSOOVSTA=$P(^PSRX(PSONV,"STA"),"^")
"RTN","PSOVER",104,0)
 K DIC S DIC(0)="NZ",DIC=52.4 D ^DIC K DIC I Y<1 D  D:'$G(PSLSTVER) ULB Q:'$G(PSLSTVER)
"RTN","PSOVER",105,0)
 .I $P($G(^PSRX(+PSONV,"STA")),"^")'=1,$P($G(^("STA")),"^")'=4 K PSONV,DA,X,Y,PSOZVER,PSLSTVER S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOVER",106,0)
 .S PSLSTVER=2
"RTN","PSOVER",107,0)
 .S DIC="^PS(52.4,",DLAYGO=52.4,(DINUM,X)=PSONV,DIC(0)="L" K DD,DO D FILE^DICN K DD,DO,DIC,DINUM,DLAYGO
"RTN","PSOVER",108,0)
 .S ^PS(52.4,PSONV,0)=PSONV_"^"_$P(^PSRX(PSONV,0),"^",2)_"^"_+$P(^(0),"^",16)_"^^"_$E($P($G(^(2)),"^"),1,7)_"^"_PSONV_"^"_$E($P($G(^(2)),"^",6),1,7)
"RTN","PSOVER",109,0)
 .S DIK="^PS(52.4,",DA=PSONV D IX^DIK K DIK S Y(0)=^PS(52.4,PSONV,0),(X,DA)=PSONV
"RTN","PSOVER",110,0)
 D STAT^PSODGDG2 G:FLAGST EOJ
"RTN","PSOVER",111,0)
 N LST S (DFN,PSDFN,PSODFN)=$P(^PSRX(PSONV,0),"^",2),PPL="",PSONAM=$P(^DPT(PSDFN,0),"^")
"RTN","PSOVER",112,0)
 D PID^VADPT S PSOVORD=PSONV
"RTN","PSOVER",113,0)
 I $D(^PS(52.4,"ADI",PSONV,1)) D DGDGI G:$G(PSOVQUIT)!$G(PSORX("DFLG")) EOJ G PPL
"RTN","PSOVER",114,0)
 I $D(^PSRX(PSONV,"DRI")) S PSOSIG=1 D DGDGI G:$G(PSOVQUIT)!$G(PSORX("DFLG")) EOJ G PPL
"RTN","PSOVER",115,0)
 G:$G(PSORX("DFLG")) EOJ D DSPL
"RTN","PSOVER",116,0)
PPL I $G(PSLSTVER)=2,$D(^PS(52.4,PSONV,0)) S DA=PSONV,DIK="^PS(52.4," D ^DIK K DIK,DA
"RTN","PSOVER",117,0)
 G EOJ:'$O(PSOVER(0))
"RTN","PSOVER",118,0)
 S PSONVLP="" F  S PSONVLP=$O(PSOVER(PSONVLP)) Q:PSONVLP=""  D
"RTN","PSOVER",119,0)
 .D MARKV^PSOTPCAN
"RTN","PSOVER",120,0)
 .I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSONVLP_"," Q
"RTN","PSOVER",121,0)
 .F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSOVER",122,0)
 .I $L(PSORX("PSOL",PSOX2))+$L(PSONVLP)<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSONVLP_","
"RTN","PSOVER",123,0)
 .E  S PSORX("PSOL",PSOX2+1)=PSONVLP_","
"RTN","PSOVER",124,0)
EOJ D ULB,END
"RTN","PSOVER",125,0)
 K D,DGDG,MW,PSONVLP,P,PCOMX,PDA,PSPRXN,RX,PSD,PSOSTA,PSLSTVER,PSOVORD,PSVFLAG
"RTN","PSOVER",126,0)
 I $G(PSOCLK),$G(PSLST) K PSLST
"RTN","PSOVER",127,0)
 I $G(PSOCLK)!($G(PSOPOCK)) D FULL^VALM1 K VALMBCK D ^PSOBUILD,BLD^PSOORUT1 S Y=0 F  S Y=$O(PSOLST(Y)) Q:Y=""  I $P(PSOLST(Y),"^",2)=PSONV S PSLST=","_Y Q
"RTN","PSOVER",128,0)
 I $G(^PSRX(PSONV,"STA"))'=1&($G(^PSRX(PSONV,"STA"))'=4) S VALMBCK="Q" G EOJ2
"RTN","PSOVER",129,0)
 I '$G(PSOCLK)!('$G(PSOPOCK)) S VALMBCK="R" S:$G(PSOVBCK) VALMBCK="Q"
"RTN","PSOVER",130,0)
EOJ2 ;
"RTN","PSOVER",131,0)
 K PSONV,Y
"RTN","PSOVER",132,0)
 L -^PSRX($P(PSOLST(ORN),"^",2))
"RTN","PSOVER",133,0)
 Q
"RTN","PSOVER",134,0)
LPAT ;
"RTN","PSOVER",135,0)
 K PSOVERPL
"RTN","PSOVER",136,0)
 I '$G(PSOVERPX) Q
"RTN","PSOVER",137,0)
 S PSOPLCK=$$L^PSSLOCK(PSOVERPX,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S (PSOVERPL,PSOVERLX)=1
"RTN","PSOVER",138,0)
 K PSOPLCK
"RTN","PSOVER",139,0)
 Q
"RTN","PSOVER",140,0)
ULP ;
"RTN","PSOVER",141,0)
 I '$G(PSOVERPH) Q
"RTN","PSOVER",142,0)
 D UL^PSSLOCK(PSOVERPH) K PSOVERPH
"RTN","PSOVER",143,0)
 Q
"RTN","PSOVER",144,0)
LRX ;
"RTN","PSOVER",145,0)
 K PSOMSG I '$G(PSONV) Q
"RTN","PSOVER",146,0)
 D PSOL^PSSLOCK(PSONV) I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),! D  K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSOVER",147,0)
 .I $G(PSDFN) W "for patient "_$P($G(^DPT(PSDFN,0)),"^")_".",!
"RTN","PSOVER",148,0)
 Q
"RTN","PSOVER",149,0)
ULRX ;
"RTN","PSOVER",150,0)
 I '$G(PSONV) Q
"RTN","PSOVER",151,0)
 D PSOUL^PSSLOCK(PSONV)
"RTN","PSOVER",152,0)
 Q
"RTN","PSOVER",153,0)
LK1 ;
"RTN","PSOVER",154,0)
 I '$G(PSOLKVRX) Q
"RTN","PSOVER",155,0)
 D PSOL^PSSLOCK(PSOLKVRX) I '$G(PSOMSG) S VERLFLAG=1,PSOVMSGX=$P($G(PSOMSG),"^",2) Q
"RTN","PSOVER",156,0)
 S LOCKARRY(PSOLKVRX)=PSOLKVRX
"RTN","PSOVER",157,0)
 Q
"RTN","PSOVER",158,0)
ULK1 ;
"RTN","PSOVER",159,0)
 I '$D(LOCKARRY) Q
"RTN","PSOVER",160,0)
 S PSOVOLK="" F  S PSOVOLK=$O(LOCKARRY(PSOVOLK)) Q:$G(PSOVOLK)=""  D PSOUL^PSSLOCK(PSOVOLK)
"RTN","PSOVER",161,0)
 K PSOVOLK
"RTN","PSOVER",162,0)
 Q
"RTN","PSOVER",163,0)
ULB ;
"RTN","PSOVER",164,0)
 I $G(PSOVDFN) D UL^PSSLOCK(PSOVDFN)
"RTN","PSOVER",165,0)
 I $G(PSOVRXN) D PSOUL^PSSLOCK(PSOVRXN)
"RTN","PSOVER",166,0)
 K PSOVDFN,PSOVRXN
"RTN","PSOVER",167,0)
 Q
"RTN","PSOVER",168,0)
SAVE ;
"RTN","PSOVER",169,0)
 K PSOOVNOD,PSOOVSTA S (PSOOVNOD,PSOOVSTA)="",PSOOVNOD=^PS(52.4,PSONV,0),PSOOVSTA=$P(^PSRX(PSONV,"STA"),"^")
"RTN","PSOVER",170,0)
 Q
"RTN","PSOVER1")
0^16^B121964546
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207,148,243,268,281,324,358,251,375,387,379,372**;DEC 1997;Build 54
"RTN","PSOVER1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSOVER1",10,0)
 ;External reference to ^PS(4 supported by DBIA 2229
"RTN","PSOVER1",11,0)
 ;External reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSOVER1",12,0)
 ;External reference to ^DPT( supported by DBIA 3097
"RTN","PSOVER1",13,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOVER1",14,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOVER1",15,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOVER1",16,0)
REDO ;
"RTN","PSOVER1",17,0)
 I '$G(PSOCLK) Q:$G(PSVERFLG)
"RTN","PSOVER1",18,0)
 S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",19,0)
 S PSOVQUIT=0,PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",20,0)
 S PSOY(0)=^PSDRUG(PSODRUG("IEN"),0),PSOY=PSODRUG("IEN")_"^"_$P(PSOY(0),"^")
"RTN","PSOVER1",21,0)
 D SET^PSODRG
"RTN","PSOVER1",22,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",23,0)
 ;
"RTN","PSOVER1",24,0)
EDIT ;
"RTN","PSOVER1",25,0)
 S (PSDNEW,PSDOLD)="",PSDOLD=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV
"RTN","PSOVER1",26,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",27,0)
 I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",28,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to proceed with verification and order checks."
"RTN","PSOVER1",29,0)
 D ^DIR K DIR W ! I $G(DIRUT)!($G(DTOUT)) S PSOVBCK=1 G OUT
"RTN","PSOVER1",30,0)
 ;PSOPOCK=1 called from Process Order Check option; PSOCLK=1 means initiated from Rx verify by clerk.
"RTN","PSOVER1",31,0)
 I Y="Y",($G(PSOCLK)!($G(PSOPOCK))) D FULLEDT S VALMBCK="R" G KILL:$$CHECK(PSONV) G EDIT
"RTN","PSOVER1",32,0)
 I Y="Y",$G(PSOACT)]"" S VALMBCK="R",PSVERFLG=1 G OUT  ;this pops the user back to the med profile screen when verify is called from Patient Prescription Processing
"RTN","PSOVER1",33,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",34,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",35,0)
 G ORDCHK:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",36,0)
 ;
"RTN","PSOVER1",37,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",38,0)
 K PSD(PSDOLD) S PSDNEW="",PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",39,0)
 ;
"RTN","PSOVER1",40,0)
 S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) D ^PSORXPR G OUT:$G(DIRUT)
"RTN","PSOVER1",41,0)
 G OUT:$D(DIRUT)!($D(DTOUT))
"RTN","PSOVER1",42,0)
 I '$G(PSOCLK) S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) W !,"CHANGE",! D ^PSORXPR G OUT:$D(DIRUT)!($D(DTOUT)) G EDIT
"RTN","PSOVER1",43,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",44,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",45,0)
 W !!,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"")
"RTN","PSOVER1",46,0)
 D HD^PSODDPR2() D ^PSODSPL D SHOW2^PSOVER G EDIT Q
"RTN","PSOVER1",47,0)
 ;
"RTN","PSOVER1",48,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",49,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(4,DA,0),"^",7)=X Q
"RTN","PSOVER1",50,0)
 ;
"RTN","PSOVER1",51,0)
ORDCHK ;
"RTN","PSOVER1",52,0)
 S RX0=^PSRX(PSONV,0)
"RTN","PSOVER1",53,0)
 D ORDCK
"RTN","PSOVER1",54,0)
 I $G(PSOQUIT) S:$G(PSOCLK) PSOQUIT=0 S:'$G(PSOCLK) PSORX("DFLG")=1  ;if verify by clerk continue on with the next Rx; if not exit
"RTN","PSOVER1",55,0)
 I $G(PSOVQUIT)!$G(PSORX("DFLG")) G OUT
"RTN","PSOVER1",56,0)
 ;------
"RTN","PSOVER1",57,0)
VERIFY ; 
"RTN","PSOVER1",58,0)
 D FULL^VALM1 G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",59,0)
 W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"") W:$D(PSODRUG("NAME")) !,PSODRUG("NAME"),!
"RTN","PSOVER1",60,0)
 S DIR("A")="VERIFY FOR "_PSONAM_" ? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",61,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",62,0)
 D ^DIR K DIR
"RTN","PSOVER1",63,0)
 I Y="N"!("Q^"[$E(Y)) D  G OUT
"RTN","PSOVER1",64,0)
 .S (PSVERFLG,PSOVBCK)=1,PSORX("DFLG")=1
"RTN","PSOVER1",65,0)
 .S:$D(PSOOVNOD) ^PS(52.4,PSONV,0)=PSOOVNOD S:$G(PSOOVSTA) $P(^PSRX(PSONV,"STA"),"^")=PSOOVSTA
"RTN","PSOVER1",66,0)
 .S:PSOOVSTA=4 ^PS(52.4,"ADI",PSONV,1)=""
"RTN","PSOVER1",67,0)
 G DELETE:Y="D"
"RTN","PSOVER1",68,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",69,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",70,0)
 K ^PSRX(PSONV,"DRI"),SPFL
"RTN","PSOVER1",71,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",72,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",73,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",74,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",75,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",76,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",77,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",78,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",79,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",80,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",81,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",82,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",83,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",84,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",85,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",86,0)
 I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) D  G KILL
"RTN","PSOVER1",87,0)
 .S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^(2),"^",2),RXF=0
"RTN","PSOVER1",88,0)
 .D UPSUS S PSTRIVER=1 D SUS^PSORXL
"RTN","PSOVER1",89,0)
 .K PSORX("FILL DATE"),PSTRIVER
"RTN","PSOVER1",90,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",91,0)
 S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",92,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",93,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","") ;S VALMBCK=""
"RTN","PSOVER1",94,0)
 ;
"RTN","PSOVER1",95,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSOVER1",96,0)
 N ACTION
"RTN","PSOVER1",97,0)
 I $$SUBMIT^PSOBPSUT(PSONV) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSOVER1",98,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSONV,,,$S($O(^PSRX(PSONV,1,0)):"RF",1:"OF"))
"RTN","PSOVER1",99,0)
 . ; Quit if there is an unresolved Tricare non-billable reject code, PSO*7*358
"RTN","PSOVER1",100,0)
 . I $$PSOET^PSOREJP3(PSONV) S ACTION="Q" Q
"RTN","PSOVER1",101,0)
 . I $$FIND^PSOREJUT(PSONV) D
"RTN","PSOVER1",102,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSONV,0,"79,88","OF","IOQ","Q")
"RTN","PSOVER1",103,0)
 ;
"RTN","PSOVER1",104,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",105,0)
OUT ;
"RTN","PSOVER1",106,0)
 I '$G(PSOCLK) S:$G(DIRUT)!($G(DTOUT)) PSORX("DFLG")=1 K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN S VALMBCK="Q" Q
"RTN","PSOVER1",107,0)
 I $G(PSOCLK) S PSORX("DFLG")=0 K UPFLAGX D CLEAN Q
"RTN","PSOVER1",108,0)
DELETE K UPFLAGX D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",109,0)
QUIT S PSOQUIT="" D CLEAN Q
"RTN","PSOVER1",110,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",111,0)
 Q
"RTN","PSOVER1",112,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",113,0)
 I $G(PSODOSEX) K PSODOSEX Q
"RTN","PSOVER1",114,0)
 N PSOWRITE
"RTN","PSOVER1",115,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",116,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",117,0)
 .I $P(^TMP("PSORXDC",$J,RORD,0),"^")="P" D  Q
"RTN","PSOVER1",118,0)
 ..S PSOR=^PS(52.41,RORD,0)
"RTN","PSOVER1",119,0)
 ..S DNM=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSOVER1",120,0)
 ..W $C(7),!," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Pending Order "_DNM_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",121,0)
 .W !," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Rx #"_$P(^PSRX(RORD,0),"^")_" "_$P(^TMP("PSORXDC",$J,RORD,0),"^",7)_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",122,0)
 I $G(PSOWRITE)&('$G(PSOWRIT)) W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSOVER1",123,0)
 K ^TMP("PSORXDC",$J),RORD,PRNXZ,ORNZZ,PSOR
"RTN","PSOVER1",124,0)
 Q
"RTN","PSOVER1",125,0)
KV1 ;
"RTN","PSOVER1",126,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",127,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",128,0)
 Q
"RTN","PSOVER1",129,0)
NVA ;
"RTN","PSOVER1",130,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",131,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",132,0)
 S (Y,FLG)=""
"RTN","PSOVER1",133,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",134,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",135,0)
 Q
"RTN","PSOVER1",136,0)
REMOTE ; 
"RTN","PSOVER1",137,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",138,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",139,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",140,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSOVER1",141,0)
 .I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSOVER1",142,0)
 ..I $T(REMOTE^PSORX1)]"" Q
"RTN","PSOVER1",143,0)
 ..W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",144,0)
 .W !!,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",145,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",146,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL) ;D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",147,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",148,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",149,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",150,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",151,0)
 Q
"RTN","PSOVER1",152,0)
NOALRGY ;
"RTN","PSOVER1",153,0)
 N PSODFN,PSODRUG
"RTN","PSOVER1",154,0)
 S PSODFN=$P(^PSRX(PSONV,0),"^",2),PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",155,0)
 D NOALRGY^PSODRG
"RTN","PSOVER1",156,0)
 Q
"RTN","PSOVER1",157,0)
 ;
"RTN","PSOVER1",158,0)
ORDCK ;
"RTN","PSOVER1",159,0)
 N ORN,ORNZZ,PSOLST,Y,PSOODFN S ORN=PSONV,PSOLST(PSONV)=PSONV_"^"_PSONV,PSOVORD=1
"RTN","PSOVER1",160,0)
 N DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV
"RTN","PSOVER1",161,0)
 S ORNZZ=ORN,PRNXZ(ORN)=PSOLST(ORN),PSORENW("OIRXN")=PSONV,PSOODFN=DFN
"RTN","PSOVER1",162,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",163,0)
 D SHOW^PSOVER D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",164,0)
 S (PSODRUG("IEN"),PSDRUG("IEN"))=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",165,0)
 N PSOVINF S PSOVINF=^PSDRUG(PSDRUG("IEN"),0),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",166,0)
 S PSODRUG("VA CLASS")=$P(PSOVINF,"^",2),(DRG,PSODRUG("NAME"))=$P(^PSDRUG(PSDRUG("IEN"),0),"^")
"RTN","PSOVER1",167,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSDRUG("IEN"),"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOVER1",168,0)
 S PSODRUG("MAXDOSE")=$P(PSOVINF,"^",4),PSODRUG("DEA")=$P(PSOVINF,"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(PSDRUG("IEN"),"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOVER1",169,0)
 S PSODRUG("SIG")=$P(PSOVINF,"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(PSDRUG("IEN"),$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(PSDRUG("IEN"),660.1))
"RTN","PSOVER1",170,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,PSONV,81)
"RTN","PSOVER1",171,0)
 K PSOVINF
"RTN","PSOVER1",172,0)
 D POST^PSODRG S DFN=PSOODFN
"RTN","PSOVER1",173,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",174,0)
 I $G(PSVERFLG),$G(PSOCLK) S PSVERFLG=0
"RTN","PSOVER1",175,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",176,0)
 Q:PSORX("DFLG")!($G(PSOQUIT))
"RTN","PSOVER1",177,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("V")
"RTN","PSOVER1",178,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",179,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",180,0)
 Q:PSORX("DFLG")
"RTN","PSOVER1",181,0)
 S PSOLST(ORNZZ)=PRNXZ(ORNZZ),ORN=ORNZZ K PSORENW("OIRXN")
"RTN","PSOVER1",182,0)
 Q
"RTN","PSOVER1",183,0)
 ;
"RTN","PSOVER1",184,0)
FULLEDT  ;
"RTN","PSOVER1",185,0)
 D FULL^VALM1
"RTN","PSOVER1",186,0)
 N RX,FILL,OPSOLST,OPSLST,OLDDA,PSODRUG,REJ
"RTN","PSOVER1",187,0)
 S (RX,PSORXED("IRXN"))=PSONV
"RTN","PSOVER1",188,0)
 M OPSOLST=PSOLST,OPSLST=PSLST,ODA=DA
"RTN","PSOVER1",189,0)
 N PSOSITE,ORN,PSOPAR,PSOLIST,PSOSD
"RTN","PSOVER1",190,0)
 S PSOSITE=$$RXSITE^PSOBPSUT(RX,""),ORN=RX
"RTN","PSOVER1",191,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PSOLIST(1)=ORN_","
"RTN","PSOVER1",192,0)
 D EPH^PSORXEDT
"RTN","PSOVER1",193,0)
 M PSOLST=OPSOLST,PSLST=OPSLST S VALMBCK="R" S:$D(OLDDA) DA=OLDDA
"RTN","PSOVER1",194,0)
 Q
"RTN","PSOVER1",195,0)
 ;
"RTN","PSOVER1",196,0)
DRIDOSE(DA,RX0) ;where DA is RXIEN and RX0 is zero node of file 52 for the RXIEN
"RTN","PSOVER1",197,0)
 N T,RXN,RXX,SCRIPT,SEV,X,SER,PSOSERV,PSOSCPT,PSODOSF,RX
"RTN","PSOVER1",198,0)
 S RX=RX0
"RTN","PSOVER1",199,0)
 S RXN=$P(RX0,"^")
"RTN","PSOVER1",200,0)
 I $D(^PS(52.4,RX,0))!($D(^PSRX(RX,"DRI"))) D
"RTN","PSOVER1",201,0)
 . Q:'$P($G(^PS(52.4,RX,0)),"^",8)&('$D(^PSRX(RX,"DRI")))
"RTN","PSOVER1",202,0)
 .W !!,"*** During order, there were DRUG-DRUG INTERACTION for the following RX(s):"
"RTN","PSOVER1",203,0)
 I $P($G(^PS(52.4,RX,0)),"^",8) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",204,0)
 . S SER=$P(^PS(56,SEV(X),0),"^",4) S:$G(SER)=1 PSOSERV=1
"RTN","PSOVER1",205,0)
 . S PSOSCPT(RXX(X))="     "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION    "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",206,0)
 I $D(^PSRX(RX,"DRI")) S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",207,0)
 .S SER=$P(^PS(56,SEV(X),0),"^",4)
"RTN","PSOVER1",208,0)
 .S PSOSCPT(RXX(X))="     "_$P($G(^PSRX(RXX(X),0)),"^")_"  "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION  "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",209,0)
 S SCRIPT="" F  S SCRIPT=$O(PSOSCPT(SCRIPT)) Q:SCRIPT=""  W !,PSOSCPT(SCRIPT)
"RTN","PSOVER1",210,0)
 I $$DS^PSSDSAPI,$D(^PS(52.4,RX,1)) S T=$P(^PS(52.4,RX,1),"^") D  W:PSODOSF'="" !,"*** Dose Warning: ",PSODOSF
"RTN","PSOVER1",211,0)
 . S PSODOSF="",PSODOSF=$S(T=4:"DOSAGE EXCEEDS MAX SINGLE DOSE",T=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",T=2:"MAX SINGLE DOSE",T=1:"DAILY DOSE RANGE",1:"")
"RTN","PSOVER1",212,0)
 W !
"RTN","PSOVER1",213,0)
 Q
"RTN","PSOVER1",214,0)
CHECK(PSONV) ;
"RTN","PSOVER1",215,0)
 N PSOSTAT S PSOSTAT=$$GET1^DIQ(52,PSONV,100,"I")
"RTN","PSOVER1",216,0)
 I ",11,12,13,14,15,"[(","_PSOSTAT_",") Q 1
"RTN","PSOVER1",217,0)
 Q 0
"VER")
8.0^22.0
"^DD",52.4,52.4,8,0)
DOSE WARNING^S^0:UNKNOWN;1:DAILY DOSE RANGE;2:MAX SINGLE DOSE;3:MAX SINGLE DOSE & DAILY DOSE RANGE;4:DOSAGE EXCEEDS MAX SINGLE DOSE;^1;1^Q
"^DD",52.4,52.4,8,1,0)
^.1^^0
"^DD",52.4,52.4,8,3)
Enter 4 FOR DOSAGE EXCEEDS MAX SINGLE DOSE.
"^DD",52.4,52.4,8,21,0)
^^4^4^3120913^^
"^DD",52.4,52.4,8,21,1,0)
This field is used to indicate when a dose warning has been received, and 
"^DD",52.4,52.4,8,21,2,0)
it will be denoted by the appropriate set of codes value.  This value is
"^DD",52.4,52.4,8,21,3,0)
defined automatically upon order entry completion of technician entered 
"^DD",52.4,52.4,8,21,4,0)
orders.
"^DD",52.4,52.4,8,23,0)
^^2^2^3120913^
"^DD",52.4,52.4,8,23,1,0)
For MOCHA 2.0, only 4 for DOSAGE EXCEEDS MAX SINGLE DOSE will be
"^DD",52.4,52.4,8,23,2,0)
used.
"^DD",52.4,52.4,8,"DT")
3120913
**INSTALL NAME**
PSJ*5.0*252
"BLD",7973,0)
PSJ*5.0*252^INPATIENT MEDICATIONS^0^3121010^y
"BLD",7973,1,0)
^^19^19^3110803^^^
"BLD",7973,1,1,0)
This patch is part of a combined build that makes up the release of 
"BLD",7973,1,2,0)
MEDICATION ORDER CHECK HEALTHCARE APPLICATION (MOCHA) 2.0.
"BLD",7973,1,3,0)
 
"BLD",7973,1,4,0)
MOCHA 2.0 encompasses Pharmacy Data Management (PDM) patch PSS*1*160
"BLD",7973,1,5,0)
and a combined build for Outpatient Pharmacy patch PSO*7*372 and 
"BLD",7973,1,6,0)
Inpatient Medications patch PSJ*5*252.
"BLD",7973,1,7,0)
 
"BLD",7973,1,8,0)
This patch group adds dosing checks that implements a new system that uses
"BLD",7973,1,9,0)
data from First DataBank (FDB).  In this initial phase of dosing
"BLD",7973,1,10,0)
functionality, the Single Dose information will be displayed to
"BLD",7973,1,11,0)
the user.  The following scenarios describe the types of messaging added: 
"BLD",7973,1,12,0)
 
"BLD",7973,1,13,0)
  1. If the dosage entered passes the dosing checks, no message will be
"BLD",7973,1,14,0)
     displayed.
"BLD",7973,1,15,0)
  2. If the dosage entered is too high or too low, the Single Dose warning
"BLD",7973,1,16,0)
     message will be displayed.
"BLD",7973,1,17,0)
  3. If the dose checks were not able to be performed, a generic message
"BLD",7973,1,18,0)
     will be displayed notifying the user that a manual check needs to be
"BLD",7973,1,19,0)
     completed to verify appropriate dosing.
"BLD",7973,4,0)
^9.64PA^^
"BLD",7973,6)
35^
"BLD",7973,6.3)
69
"BLD",7973,"ABPKG")
n
"BLD",7973,"KRN",0)
^9.67PA^779.2^20
"BLD",7973,"KRN",.4,0)
.4
"BLD",7973,"KRN",.4,"NM",0)
^9.68A^^
"BLD",7973,"KRN",.401,0)
.401
"BLD",7973,"KRN",.402,0)
.402
"BLD",7973,"KRN",.403,0)
.403
"BLD",7973,"KRN",.5,0)
.5
"BLD",7973,"KRN",.84,0)
.84
"BLD",7973,"KRN",3.6,0)
3.6
"BLD",7973,"KRN",3.8,0)
3.8
"BLD",7973,"KRN",9.2,0)
9.2
"BLD",7973,"KRN",9.8,0)
9.8
"BLD",7973,"KRN",9.8,"NM",0)
^9.68A^33^17
"BLD",7973,"KRN",9.8,"NM",12,0)
PSIVOCDS^^0^B114348606
"BLD",7973,"KRN",9.8,"NM",13,0)
PSIVORE^^0^B43371041
"BLD",7973,"KRN",9.8,"NM",14,0)
PSJAPIDS^^0^B34568784
"BLD",7973,"KRN",9.8,"NM",15,0)
PSIVEDT^^0^B51363050
"BLD",7973,"KRN",9.8,"NM",17,0)
PSJOE^^0^B88042799
"BLD",7973,"KRN",9.8,"NM",18,0)
PSJOE1^^0^B28274486
"BLD",7973,"KRN",9.8,"NM",19,0)
PSIVOPT^^0^B58375431
"BLD",7973,"KRN",9.8,"NM",22,0)
PSJOC^^0^B24678878
"BLD",7973,"KRN",9.8,"NM",24,0)
PSJOCDI^^0^B84788026
"BLD",7973,"KRN",9.8,"NM",26,0)
PSJOCDS^^0^B73599009
"BLD",7973,"KRN",9.8,"NM",27,0)
PSJOCDSD^^0^B25300673
"BLD",7973,"KRN",9.8,"NM",28,0)
PSJOCOR^^0^B3732046
"BLD",7973,"KRN",9.8,"NM",29,0)
PSJGMRA^^0^B22580264
"BLD",7973,"KRN",9.8,"NM",30,0)
PSJLIFN^^0^B29270381
"BLD",7973,"KRN",9.8,"NM",31,0)
PSJOCERR^^0^B3766638
"BLD",7973,"KRN",9.8,"NM",32,0)
PSJMISC2^^0^B12038651
"BLD",7973,"KRN",9.8,"NM",33,0)
PSJBLDOC^^0^B27080671
"BLD",7973,"KRN",9.8,"NM","B","PSIVEDT",15)

"BLD",7973,"KRN",9.8,"NM","B","PSIVOCDS",12)

"BLD",7973,"KRN",9.8,"NM","B","PSIVOPT",19)

"BLD",7973,"KRN",9.8,"NM","B","PSIVORE",13)

"BLD",7973,"KRN",9.8,"NM","B","PSJAPIDS",14)

"BLD",7973,"KRN",9.8,"NM","B","PSJBLDOC",33)

"BLD",7973,"KRN",9.8,"NM","B","PSJGMRA",29)

"BLD",7973,"KRN",9.8,"NM","B","PSJLIFN",30)

"BLD",7973,"KRN",9.8,"NM","B","PSJMISC2",32)

"BLD",7973,"KRN",9.8,"NM","B","PSJOC",22)

"BLD",7973,"KRN",9.8,"NM","B","PSJOCDI",24)

"BLD",7973,"KRN",9.8,"NM","B","PSJOCDS",26)

"BLD",7973,"KRN",9.8,"NM","B","PSJOCDSD",27)

"BLD",7973,"KRN",9.8,"NM","B","PSJOCERR",31)

"BLD",7973,"KRN",9.8,"NM","B","PSJOCOR",28)

"BLD",7973,"KRN",9.8,"NM","B","PSJOE",17)

"BLD",7973,"KRN",9.8,"NM","B","PSJOE1",18)

"BLD",7973,"KRN",19,0)
19
"BLD",7973,"KRN",19,"NM",0)
^9.68A^^
"BLD",7973,"KRN",19.1,0)
19.1
"BLD",7973,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",7973,"KRN",101,0)
101
"BLD",7973,"KRN",409.61,0)
409.61
"BLD",7973,"KRN",771,0)
771
"BLD",7973,"KRN",779.2,0)
779.2
"BLD",7973,"KRN",870,0)
870
"BLD",7973,"KRN",8989.51,0)
8989.51
"BLD",7973,"KRN",8989.52,0)
8989.52
"BLD",7973,"KRN",8994,0)
8994
"BLD",7973,"KRN","B",.4,.4)

"BLD",7973,"KRN","B",.401,.401)

"BLD",7973,"KRN","B",.402,.402)

"BLD",7973,"KRN","B",.403,.403)

"BLD",7973,"KRN","B",.5,.5)

"BLD",7973,"KRN","B",.84,.84)

"BLD",7973,"KRN","B",3.6,3.6)

"BLD",7973,"KRN","B",3.8,3.8)

"BLD",7973,"KRN","B",9.2,9.2)

"BLD",7973,"KRN","B",9.8,9.8)

"BLD",7973,"KRN","B",19,19)

"BLD",7973,"KRN","B",19.1,19.1)

"BLD",7973,"KRN","B",101,101)

"BLD",7973,"KRN","B",409.61,409.61)

"BLD",7973,"KRN","B",771,771)

"BLD",7973,"KRN","B",779.2,779.2)

"BLD",7973,"KRN","B",870,870)

"BLD",7973,"KRN","B",8989.51,8989.51)

"BLD",7973,"KRN","B",8989.52,8989.52)

"BLD",7973,"KRN","B",8994,8994)

"BLD",7973,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7973,"QUES",0)
^9.62^^
"BLD",7973,"REQB",0)
^9.611^2^2
"BLD",7973,"REQB",1,0)
PSJ*5.0*270^2
"BLD",7973,"REQB",2,0)
PSJ*5.0*271^2
"BLD",7973,"REQB","B","PSJ*5.0*270",1)

"BLD",7973,"REQB","B","PSJ*5.0*271",2)

"MBREQ")
1
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
252^3121010^11857
"PKG",197,22,1,"PAH",1,1,0)
^^19^19^3121010
"PKG",197,22,1,"PAH",1,1,1,0)
This patch is part of a combined build that makes up the release of 
"PKG",197,22,1,"PAH",1,1,2,0)
MEDICATION ORDER CHECK HEALTHCARE APPLICATION (MOCHA) 2.0.
"PKG",197,22,1,"PAH",1,1,3,0)
 
"PKG",197,22,1,"PAH",1,1,4,0)
MOCHA 2.0 encompasses Pharmacy Data Management (PDM) patch PSS*1*160
"PKG",197,22,1,"PAH",1,1,5,0)
and a combined build for Outpatient Pharmacy patch PSO*7*372 and 
"PKG",197,22,1,"PAH",1,1,6,0)
Inpatient Medications patch PSJ*5*252.
"PKG",197,22,1,"PAH",1,1,7,0)
 
"PKG",197,22,1,"PAH",1,1,8,0)
This patch group adds dosing checks that implements a new system that uses
"PKG",197,22,1,"PAH",1,1,9,0)
data from First DataBank (FDB).  In this initial phase of dosing
"PKG",197,22,1,"PAH",1,1,10,0)
functionality, the Single Dose information will be displayed to
"PKG",197,22,1,"PAH",1,1,11,0)
the user.  The following scenarios describe the types of messaging added: 
"PKG",197,22,1,"PAH",1,1,12,0)
 
"PKG",197,22,1,"PAH",1,1,13,0)
  1. If the dosage entered passes the dosing checks, no message will be
"PKG",197,22,1,"PAH",1,1,14,0)
     displayed.
"PKG",197,22,1,"PAH",1,1,15,0)
  2. If the dosage entered is too high or too low, the Single Dose warning
"PKG",197,22,1,"PAH",1,1,16,0)
     message will be displayed.
"PKG",197,22,1,"PAH",1,1,17,0)
  3. If the dose checks were not able to be performed, a generic message
"PKG",197,22,1,"PAH",1,1,18,0)
     will be displayed notifying the user that a manual check needs to be
"PKG",197,22,1,"PAH",1,1,19,0)
     completed to verify appropriate dosing.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
17
"RTN","PSIVEDT")
0^15^B51363050
"RTN","PSIVEDT",1,0)
PSIVEDT ;BIR/MLM-EDIT IV ORDER ;10 Feb 98 / 3:23 PM
"RTN","PSIVEDT",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**4,110,127,133,134,181,252**;16 DEC 97;Build 69
"RTN","PSIVEDT",3,0)
 ;
"RTN","PSIVEDT",4,0)
 ; Reference to ^DD(53.1 is supported by DBIA 2256.
"RTN","PSIVEDT",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSIVEDT",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSIVEDT",7,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSIVEDT",8,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSIVEDT",9,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVEDT",10,0)
 ;
"RTN","PSIVEDT",11,0)
EDIT ;
"RTN","PSIVEDT",12,0)
 ;Store the DRG array.  If it changed then to do an OC
"RTN","PSIVEDT",13,0)
 NEW TMPDRG,PSJFLG57
"RTN","PSIVEDT",14,0)
 D SAVEDRG^PSIVEDRG(.TMPDRG,.DRG)
"RTN","PSIVEDT",15,0)
 I $G(DFN)&($G(PSJORD)["V") I $$COMPLEX^PSJOE(DFN,PSJORD) D
"RTN","PSIVEDT",16,0)
 . N X,Y,PARENT,P2ND S P2ND=$S($G(^PS(55,PSGP,"IV",+PSJORD,.2)):$G(^PS(55,PSGP,"IV",+PSJORD,.2)),1:$G(^PS(55,PSGP,5,+PSJORD,.2)))
"RTN","PSIVEDT",17,0)
 . S PARENT=$P(P2ND,"^",8)
"RTN","PSIVEDT",18,0)
 . I PARENT D FULL^VALM1 W !!?5,"This order is part of a complex order. Please review the following ",!?5,"associated orders before changing this order." D CMPLX^PSJCOM1(PSGP,PARENT,PSJORD)
"RTN","PSIVEDT",19,0)
 S DONE=0
"RTN","PSIVEDT",20,0)
 F PSIVE=1:1 S:DONE&$E(PSIVAC)="C" OREND=1 Q:PSIVE>$L(EDIT,U)!(DONE)  Q:'$L($P(EDIT,U,PSIVE))  D @($P(EDIT,U,PSIVE)) S:$E(PSIVAC,2)="N" PSIVOK=PSIVOK_U_$P(EDIT,U,PSIVE) I $E(X)=U,$L(X)>1 S:PSIVE>1 PSIVE=PSIVE-1 F  D FF Q:Y<0  D @Y Q:$E(X)'=U
"RTN","PSIVEDT",21,0)
 I $G(PSJOCCHK) K PSJOCCHK D OC^PSIVOC
"RTN","PSIVEDT",22,0)
 K EDIT,PSIVOK,PSGDI
"RTN","PSIVEDT",23,0)
 ;If quit then restore DRG( to pre-edit state
"RTN","PSIVEDT",24,0)
 I $G(PSGORQF) D SAVEDRG^PSIVEDRG(.DRG,.TMPDRG)
"RTN","PSIVEDT",25,0)
 Q
"RTN","PSIVEDT",26,0)
 ;
"RTN","PSIVEDT",27,0)
1 ; Provider.
"RTN","PSIVEDT",28,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+$G(ON),0)),"^",24)="R" D  Q
"RTN","PSIVEDT",29,0)
 . W !!?5,"This is Renewal order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",30,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",31,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",32,0)
 S P(6)=$S('$G(^VA(200,+P(6),"PS")):"",'$P(^("PS"),U,4):P(6),$P(^("PS"),U,4)<DT:"",1:P(6))
"RTN","PSIVEDT",33,0)
 W !,"PROVIDER: "_$S($P(P(6),U,2)]"":$P(P(6),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(X=""&P(6)) Q
"RTN","PSIVEDT",34,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS^PSIVEDT1 G 1
"RTN","PSIVEDT",35,0)
 I X]"" K DIC S DIC=200,DIC(0)="EQMZ",DIC("S")="I $D(^(""PS"")),^(""PS""),$S('$P(^(""PS""),U,4):1,$P(^(""PS""),U,4)>DT:1,1:0)" D ^DIC K DIC I Y>0 S P(6)=+Y_U_Y(0,0) Q
"RTN","PSIVEDT",36,0)
 S F1=53.1,F2=1 D ENHLP^PSIVORC1 W $C(7),!!,"A Provider must be entered.",!! G 1
"RTN","PSIVEDT",37,0)
 Q
"RTN","PSIVEDT",38,0)
 ;
"RTN","PSIVEDT",39,0)
3 ; Med Route.
"RTN","PSIVEDT",40,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",41,0)
 . W !!?5,"Med Route may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",42,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",43,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Med Route may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",44,0)
 S P(6)=$S('$G(^VA(200,+P(6),"PS")):"",'$P(^("PS"),U,4):P(6),$P(^("PS"),U,4)<DT:"",1:P(6))
"RTN","PSIVEDT",45,0)
 I P("MR")="" D
"RTN","PSIVEDT",46,0)
 .N AD,SOL,OI,RT,RTCNT
"RTN","PSIVEDT",47,0)
 .S AD=0 F  S AD=$O(DRG("AD",AD)) Q:'AD  S OI=$P(DRG("AD",AD),"^",6) I OI S OI(OI)=""
"RTN","PSIVEDT",48,0)
 .S SOL=0 F  S SOL=$O(DRG("SOL",SOL)) Q:'SOL  S OI=$P(DRG("SOL",SOL),"^",6) I OI S OI(OI)=""
"RTN","PSIVEDT",49,0)
 .S OI="" F  S OI=$O(OI(OI)) Q:'OI  S RT=$P(^PS(50.7,OI,0),"^",6) S:RT="" RT="NONE" S RT(RT)=$P($G(^PS(51.2,+RT,0)),"^",3)
"RTN","PSIVEDT",50,0)
 .S RT="" F RTCNT=0:1 S RT=$O(RT(RT)) Q:RT=""
"RTN","PSIVEDT",51,0)
 .Q:RTCNT>1
"RTN","PSIVEDT",52,0)
 .S RT=$O(RT("")) I RT]"" S P("MR")=RT_"^"_$G(RT(RT))
"RTN","PSIVEDT",53,0)
 W !,"MED ROUTE: "_$S($P(P("MR"),U,2)]"":$P(P("MR"),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I X=U!(X=""&P("MR"))!($E(X)=U) Q
"RTN","PSIVEDT",54,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS^PSIVEDT1 G 3
"RTN","PSIVEDT",55,0)
 I X]"" K DIC S DIC=51.2,DIC(0)="EQMZ",DIC("S")="I $P(^(0),U,4)" D ^DIC K DIC I Y>0 S P("MR")=+Y_U_$P(Y(0),U,3) S:$E($G(PSJOCFG),1,2)="FN" PSJFNDS=1 Q
"RTN","PSIVEDT",56,0)
 S F1=53.1,F2=3 D ENHLP^PSIVORC1 W $C(7),!!,"A Med Route must be entered." G 3
"RTN","PSIVEDT",57,0)
 Q
"RTN","PSIVEDT",58,0)
 ;
"RTN","PSIVEDT",59,0)
10 ; Start Date.
"RTN","PSIVEDT",60,0)
 D 10^PSIVEDT1
"RTN","PSIVEDT",61,0)
 I $E($G(PSJOCFG),1,2)="FN" S PSJFNDS=1
"RTN","PSIVEDT",62,0)
 Q
"RTN","PSIVEDT",63,0)
 ;
"RTN","PSIVEDT",64,0)
25 ; Stop Date.
"RTN","PSIVEDT",65,0)
 D 25^PSIVEDT1
"RTN","PSIVEDT",66,0)
 I $E($G(PSJOCFG),1,2)="FN" S PSJFNDS=1
"RTN","PSIVEDT",67,0)
 Q
"RTN","PSIVEDT",68,0)
26 ; Schedule
"RTN","PSIVEDT",69,0)
 D 26^PSIVEDT1
"RTN","PSIVEDT",70,0)
 Q
"RTN","PSIVEDT",71,0)
 ;
"RTN","PSIVEDT",72,0)
39 ; Admin Times.
"RTN","PSIVEDT",73,0)
 D 39^PSIVEDT1
"RTN","PSIVEDT",74,0)
 Q
"RTN","PSIVEDT",75,0)
 ;
"RTN","PSIVEDT",76,0)
57 ; Additive.
"RTN","PSIVEDT",77,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",78,0)
 . W !!?5,"Additive may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",79,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",80,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",81,0)
 I $E(PSIVAC)="O" W !!,"Only additives marked for use in IV Fluid Order Entry may be selected."
"RTN","PSIVEDT",82,0)
 S FIL=52.6,DRGT="AD",DRGTN="ADDITIVE" D DRG^PSIVEDRG,DKILL
"RTN","PSIVEDT",83,0)
 ;I $G(X)="^" G DKILL
"RTN","PSIVEDT",84,0)
 ;If Solution prompt is next then wait to do dose checks after all solutions are entered.
"RTN","PSIVEDT",85,0)
 ;PSJFLG57 is set so OC is triggered when the user entered ^ADDITIVE.
"RTN","PSIVEDT",86,0)
 I $$COMPARE^PSJMISC(.DRG,.TMPDRG) D
"RTN","PSIVEDT",87,0)
 . D ENSTOP^PSIVCAL
"RTN","PSIVEDT",88,0)
 . I $S($G(PSJFLG57):1,($G(EDIT)'["58"):1,1:0) K PSJFLG57,PSJOCCHK D OC^PSIVOC
"RTN","PSIVEDT",89,0)
 I $G(X)="^" G DKILL
"RTN","PSIVEDT",90,0)
 Q
"RTN","PSIVEDT",91,0)
 ;
"RTN","PSIVEDT",92,0)
58 ; Solution.
"RTN","PSIVEDT",93,0)
 NEW PSJCMPFG
"RTN","PSIVEDT",94,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",95,0)
 . W !!?5,"Solution may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",96,0)
 S FIL=52.7,DRGT="SOL",DRGTN="SOLUTION" D DRG^PSIVEDRG
"RTN","PSIVEDT",97,0)
 ;I $G(X)="^" G DKILL
"RTN","PSIVEDT",98,0)
 ;I $G(X)']"^",$$COMPARE^PSJMISC(.DRG,.TMPDRG) D OC^PSIVOC
"RTN","PSIVEDT",99,0)
 S PSJCMPFG=$$COMPARE^PSJMISC(.DRG,.TMPDRG)
"RTN","PSIVEDT",100,0)
 I 'PSJCMPFG,$$COMPARE^PSJMISC(.DRG,.TMPDRG,1) D
"RTN","PSIVEDT",101,0)
 . NEW X,PSJALLGY
"RTN","PSIVEDT",102,0)
 . K PSJALLGY
"RTN","PSIVEDT",103,0)
 . D SETDD^PSIVOC(1)
"RTN","PSIVEDT",104,0)
 . D GMRAOC^PSJOC
"RTN","PSIVEDT",105,0)
 . K PSJALLGY
"RTN","PSIVEDT",106,0)
 I PSJCMPFG K PSJOCCHK D ENSTOP^PSIVCAL D OC^PSIVOC
"RTN","PSIVEDT",107,0)
 K PSJCMPFG
"RTN","PSIVEDT",108,0)
 I $G(X)="^" G DKILL
"RTN","PSIVEDT",109,0)
 ;
"RTN","PSIVEDT",110,0)
DKILL ; Kill for drug edit.
"RTN","PSIVEDT",111,0)
 K DRGI,DRGN,DRGT,DRGTN,FIL,PSIVSTR
"RTN","PSIVEDT",112,0)
 Q
"RTN","PSIVEDT",113,0)
 ;
"RTN","PSIVEDT",114,0)
59 ; Infusion Rate.
"RTN","PSIVEDT",115,0)
 D 59^PSIVEDT1
"RTN","PSIVEDT",116,0)
 Q
"RTN","PSIVEDT",117,0)
 ;
"RTN","PSIVEDT",118,0)
62 ; IV Room.
"RTN","PSIVEDT",119,0)
 N DIR S DIR(0)="PA^59.5",DIR("A")="IV Room: ",DIR("??")="^S F1=59.5,F2=.01 D ENHLP^PSIVORC1" S:P("IVRM") DIR("B")=$P(P("IVRM"),U,2)
"RTN","PSIVEDT",120,0)
 D ^DIR Q:$D(DIRUT)  I Y>0 S P("IVRM")=Y W $P($P(Y,U,2),X,2)
"RTN","PSIVEDT",121,0)
 Q
"RTN","PSIVEDT",122,0)
 ;
"RTN","PSIVEDT",123,0)
63 ; Remarks.
"RTN","PSIVEDT",124,0)
 D 63^PSIVEDT1
"RTN","PSIVEDT",125,0)
 Q
"RTN","PSIVEDT",126,0)
 ;
"RTN","PSIVEDT",127,0)
64 ; Other Print Info.
"RTN","PSIVEDT",128,0)
 D 64^PSIVEDT1
"RTN","PSIVEDT",129,0)
 Q
"RTN","PSIVEDT",130,0)
 ;
"RTN","PSIVEDT",131,0)
66 ; Provider's comments.
"RTN","PSIVEDT",132,0)
 N DA,DIE,DIR S DA=PSIVUP,DIE="^PS(53.45,",DR=4 D ^DIE S PSGSI=X,Y=1
"RTN","PSIVEDT",133,0)
 Q
"RTN","PSIVEDT",134,0)
 ;
"RTN","PSIVEDT",135,0)
101 ; Orderable Item.
"RTN","PSIVEDT",136,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",137,0)
 . W !!?5,"This is Renewal order. Orderable Item may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",138,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",139,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Orderable Item may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",140,0)
 W !,"Orderable Item: "_$S(P("PD"):$P(P("PD"),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(X=""&P("PD")) Q
"RTN","PSIVEDT",141,0)
 I X]"" N DIC S DIC="^PS(50.7,",DIC(0)="EMQZ",DIC("B")=$S(P("PD")]"":+$P(("PD"),U),1:""),DIC("S")="S PSJSCT=1 I $$DRGSC^PSIVUTL(Y,PSJSCT) K PSJSCT" D ^DIC K DIC I Y>0 S P("PD")=Y Q
"RTN","PSIVEDT",142,0)
 W $C(7),!!,"Orderable Item is required!",!! G 101
"RTN","PSIVEDT",143,0)
 Q
"RTN","PSIVEDT",144,0)
109 ; Dosage Ordered.
"RTN","PSIVEDT",145,0)
 W !,"DOSAGE ORDERED: "_$S(P("DO")]"":P("DO")_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(P("DO")]""&(X="")) Q
"RTN","PSIVEDT",146,0)
 I X="???" D ORFLDS^PSIVEDT1 G 109
"RTN","PSIVEDT",147,0)
 D:X]"" CHK^DIE(53.1,109,"",X,.X) I $G(X)="^" W $C(7),!!,"Enter the dosage in which the Orderable Item entered should be dispensed.",! W "Answer must be 1-20 characters in length." G 109
"RTN","PSIVEDT",148,0)
 S P("DO")=X
"RTN","PSIVEDT",149,0)
 Q
"RTN","PSIVEDT",150,0)
 ;
"RTN","PSIVEDT",151,0)
FF ; up-arrow to another field.
"RTN","PSIVEDT",152,0)
 N DIC S X=$P(X,U,2),DIC="^DD(53.1,",DIC(0)="QEM",DIC("S")="I U_PSIVOK_U[(U_+Y_U)" D ^DIC K DIC S Y=+Y
"RTN","PSIVEDT",153,0)
 I Y=57 S PSJFLG57=1
"RTN","PSIVEDT",154,0)
 Q
"RTN","PSIVEDT",155,0)
 ;
"RTN","PSIVEDT",156,0)
NEWDRG ; Ask if adding a new drug.
"RTN","PSIVEDT",157,0)
 K DIR S DIR(0)="Y",DIR("A")="Are you adding "_$P(TDRG,U,2)_" as a new "_$S(DRGT="AD":"additive",1:"solution")_" for this order",DIR("B")="NO" D ^DIR I $D(DTOUT)!$D(DUOUT) Q
"RTN","PSIVEDT",158,0)
 I Y S (DRGI,DRG(DRGT,0))=DRG(DRGT,0)+1,DRG=TDRG,DRG(DRGT,+DRGI)=+DRG_U_$P(DRG,U,2) I DRGT="SOL" S X=$G(^PS(52.7,+DRG,0)),$P(DRG(DRGT,DRG),U,3)=$P(X,U,3)
"RTN","PSIVEDT",159,0)
 Q
"RTN","PSIVOCDS")
0^12^B114348606
"RTN","PSIVOCDS",1,0)
PSIVOCDS ;BIR/MV - PROCESS DOSING ORDER CHECKS FOR IV ;6 Jun 07 / 3:37 PM
"RTN","PSIVOCDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSIVOCDS",3,0)
 ;
"RTN","PSIVOCDS",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIVOCDS",5,0)
 ; Reference to ^PSDRUG is supported by DBIA #2192.
"RTN","PSIVOCDS",6,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425.
"RTN","PSIVOCDS",7,0)
 ; Reference to ^PSSFDBRT is supported by DBIA #5496.
"RTN","PSIVOCDS",8,0)
 ; Reference to $$CONV^PSSDSAPK is supported by DBIA #5497.
"RTN","PSIVOCDS",9,0)
 ;
"RTN","PSIVOCDS",10,0)
IN(PSJBASE) ;
"RTN","PSIVOCDS",11,0)
 ;PSJBASE - Base(Literal value for TMP global)- Required
"RTN","PSIVOCDS",12,0)
 ;PSIVDDSV(AD/SOL,CNT)=P1..P9
"RTN","PSIVOCDS",13,0)
 ; P1=Drug IEN; P2=Dspl name(add/sol or CPRS OI; P3=Numeric dose & unit; P4=Bottle #
"RTN","PSIVOCDS",14,0)
 ; P5=""; P6=""; P7=""; P8=Strength/Vol; P9=Unit
"RTN","PSIVOCDS",15,0)
 ;
"RTN","PSIVOCDS",16,0)
 ;These two flags below are set when stuff freq, duration to 1 & Duration rate = dose rate
"RTN","PSIVOCDS",17,0)
 ;They are used by the output routine to generate the appropriate output messages.
"RTN","PSIVOCDS",18,0)
 ;PSJFDB(PSJCNT,"INF_ERROR")="" & PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",19,0)
 ;
"RTN","PSIVOCDS",20,0)
 NEW ON,PSJCNT,PSJCNTX,PSJONEFG,PSJRT,PSIVAS,PSIVAS0,PSIVDDSV,PSPDRG,PSJALLGY,X,PSJP8,PSJP8NUM,PSJP8UNT,PSJP8TME,PSJOIX
"RTN","PSIVOCDS",21,0)
 K PSJOCDS,PSJFDB,PSIVDDSV,PSPDRG,PSJALLGY
"RTN","PSIVOCDS",22,0)
 S PSJCNT=0
"RTN","PSIVOCDS",23,0)
 S PSJRT=$P($$MRT^PSSDSAPI(+P("MR")),U,2)
"RTN","PSIVOCDS",24,0)
 ;Set Flag to indicate CPRS OI had no active AD/SOL.
"RTN","PSIVOCDS",25,0)
 S PSJOIX="" F  S PSJOIX=$O(PSJIV("OI_ERROR",PSJOIX)) Q:PSJOIX=""  D
"RTN","PSIVOCDS",26,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSIVOCDS",27,0)
 . S PSJFDB(PSJCNT,"RX_NUM")="I;;PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",28,0)
 . S PSJFDB(PSJCNT,"DRUG_NM")=PSJOIX
"RTN","PSIVOCDS",29,0)
 . S PSJFDB(PSJCNT,"OI")=$P(PSJIV("OI_ERROR",PSJOIX),U,2)
"RTN","PSIVOCDS",30,0)
 . S PSJFDB(PSJCNT,"OI_ERROR",PSJOIX)=$P(PSJIV("OI_ERROR",PSJOIX),U)_U_"I;;PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",31,0)
 D SETDD^PSIVOC(1)
"RTN","PSIVOCDS",32,0)
 I ($G(PSIVDDSV("TOT_VOL"))=""),($G(PSJIV("TOT_VOL"))]"") S PSIVDDSV("TOT_VOL")=PSJIV("TOT_VOL")
"RTN","PSIVOCDS",33,0)
 F PSIVAS="AD","SOL" F PSJCNTX=0:0 S PSJCNTX=$O(PSIVDDSV(PSIVAS,PSJCNTX)) Q:'PSJCNTX  D
"RTN","PSIVOCDS",34,0)
 . S PSIVAS0=$G(PSIVDDSV(PSIVAS,PSJCNTX))
"RTN","PSIVOCDS",35,0)
 .;PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" now FDB handles both units for this drug.
"RTN","PSIVOCDS",36,0)
 .;I PSIVAS="SOL" S X=$$LITER($P(PSIVAS0,U,8)) I X]"" D
"RTN","PSIVOCDS",37,0)
 .;. S $P(PSIVAS0,U,8)=$P(X,U)
"RTN","PSIVOCDS",38,0)
 .;. S $P(PSIVAS0,U,9)=$P(X,U,2)
"RTN","PSIVOCDS",39,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSIVOCDS",40,0)
 . D COMMON
"RTN","PSIVOCDS",41,0)
 . I P("DTYP")=1 D IVPB
"RTN","PSIVOCDS",42,0)
 . I P("DTYP")>1 D IV
"RTN","PSIVOCDS",43,0)
 Q
"RTN","PSIVOCDS",44,0)
IV ;Setup input data for Continuous IV (admixture, hyperal)
"RTN","PSIVOCDS",45,0)
 NEW PSJXRT,PSJP8ERR
"RTN","PSIVOCDS",46,0)
 S PSJP8=$$P8^PSJMISC2(P(8))
"RTN","PSIVOCDS",47,0)
 D BASIC
"RTN","PSIVOCDS",48,0)
 S PSJP8NUM=+$P(PSJP8,U)
"RTN","PSIVOCDS",49,0)
 S PSJP8UNT=$P(PSJP8,U,2)
"RTN","PSIVOCDS",50,0)
 S PSJP8TME=$P(PSJP8,U,3)
"RTN","PSIVOCDS",51,0)
 ;All premix are using the "Continuous Infusion" Route logic. This is so Potassium gets both single
"RTN","PSIVOCDS",52,0)
 ;and max dosing checks.  Cisplatin premix won't work since FDB can't process as "Continuous Infusion"
"RTN","PSIVOCDS",53,0)
 I PSIVAS="SOL" D PREMIX Q
"RTN","PSIVOCDS",54,0)
 S PSJXRT=$$RTESCRN(PSJRT)
"RTN","PSIVOCDS",55,0)
 I $$ISONEAD(),$$ISALLBAG(),('$$CLASS(PSJFDB(PSJCNT,"DRUG_IEN"))),(PSJXRT'=0),$$FDBRT(PSJFDB(PSJCNT,"DRUG_IEN"),PSJXRT) D ONEAD(PSJXRT) Q
"RTN","PSIVOCDS",56,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",57,0)
 D CONTIV
"RTN","PSIVOCDS",58,0)
 Q
"RTN","PSIVOCDS",59,0)
IVPB ;Setup input data for Schedule IV
"RTN","PSIVOCDS",60,0)
 NEW X,PSJP9,PSJP15
"RTN","PSIVOCDS",61,0)
 S PSJOCDS(PSJCNT,"DRUG_AMT")=$P(PSIVAS0,U,8)
"RTN","PSIVOCDS",62,0)
 S PSJOCDS(PSJCNT,"DRUG_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",63,0)
 I '+$G(PSJIV("DUR")) D
"RTN","PSIVOCDS",64,0)
 . S X=$$DURATION()
"RTN","PSIVOCDS",65,0)
 . S PSJOCDS(PSJCNT,"DRATE")=$S(+X:X_"M",1:"")
"RTN","PSIVOCDS",66,0)
 I +$G(PSJIV("DUR"))<1440,(+$G(PSJIV("DUR"))>0) S PSJOCDS(PSJCNT,"DRATE")=PSJIV("DUR")
"RTN","PSIVOCDS",67,0)
 S PSJOCDS(PSJCNT,"MR_IEN")=+P("MR")
"RTN","PSIVOCDS",68,0)
 S PSJOCDS(PSJCNT,"DO")=""
"RTN","PSIVOCDS",69,0)
 S PSJOCDS(PSJCNT,"SCHEDULE")=P(9)
"RTN","PSIVOCDS",70,0)
 ;
"RTN","PSIVOCDS",71,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=$S('+$P(PSIVAS0,U,8):"",1:$P(PSIVAS0,U,8))
"RTN","PSIVOCDS",72,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",73,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",74,0)
 ;
"RTN","PSIVOCDS",75,0)
 S PSJONEFG=0
"RTN","PSIVOCDS",76,0)
 I $$ONE^PSJORPOE(P(9))!$$ONCALL^PSJMISC(P(9)) S PSJONEFG=1 D SINGLE Q
"RTN","PSIVOCDS",77,0)
 I +$G(PSJIV("DOSE_CNT")) S PSJFDB(PSJCNT,"FREQ")=$G(PSJIV("DOSE_CNT")) Q
"RTN","PSIVOCDS",78,0)
 I +$G(PSJOCDS(PSJCNT,"DRATE")) D UND24HRS^PSJOCDS(+PSJOCDS(PSJCNT,"DRATE"),$G(P(11)),$G(P(15)),$G(P(2)),$G(P(3)),$G(P(9))) Q
"RTN","PSIVOCDS",79,0)
 I 'PSJONEFG D
"RTN","PSIVOCDS",80,0)
 . S X="",PSJP9=P(9)
"RTN","PSIVOCDS",81,0)
 . S PSJP15=P(15)
"RTN","PSIVOCDS",82,0)
 . I (P(9)["PRN"),'$O(^PS(51.1,"AC","PSJ",P(9),0)) S PSJP15=""
"RTN","PSIVOCDS",83,0)
 . I P(15)="D",(P(11)]"") S $P(PSJP9,"@",2)=P(11)
"RTN","PSIVOCDS",84,0)
 . I P(9)]"" S X=$P($$FRQ^PSSDSAPI(PSJP9,PSJP15,"I"),U)
"RTN","PSIVOCDS",85,0)
 . I X="" S X=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",86,0)
 . S PSJFDB(PSJCNT,"FREQ")=X
"RTN","PSIVOCDS",87,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",88,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",89,0)
 Q
"RTN","PSIVOCDS",90,0)
SINGLE ;Set fields needed for Single Dose type
"RTN","PSIVOCDS",91,0)
 ; Can't get FDB to return correct data for Continuous Infusion /w Single dose so all Continuous will be sent in as Maintenance.
"RTN","PSIVOCDS",92,0)
 I PSJFDB(PSJCNT,"ROUTE")=("CONTINUOUS INFUSION") Q
"RTN","PSIVOCDS",93,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="SINGLE DOSE"
"RTN","PSIVOCDS",94,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",95,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",96,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DOSE_RATE")
"RTN","PSIVOCDS",97,0)
 Q
"RTN","PSIVOCDS",98,0)
COMMON ;Set common data for all IV types
"RTN","PSIVOCDS",99,0)
 S PSJFDB(PSJCNT,"RX_NUM")="I;"_$G(PSJPON)_";PROSPECTIVE;"_PSJCNT
"RTN","PSIVOCDS",100,0)
 ;Set Flag to indicate CPRS OI had no active AD/SOL.
"RTN","PSIVOCDS",101,0)
 ;S PSJOIX="" F  S PSJOIX=$O(PSJIV("OI_ERROR",PSJOIX)) Q:PSJOIX=""  S PSJFDB("OI_ERROR",PSJOIX)=$P(PSJIV("OI_ERROR",PSJOIX),U)_U_PSJFDB(PSJCNT,"RX_NUM")
"RTN","PSIVOCDS",102,0)
 S PSJFDB(PSJCNT,"DRUG_IEN")=$P(PSIVAS0,U)
"RTN","PSIVOCDS",103,0)
 S PSJFDB(PSJCNT,"DRUG_NM")=$P(PSIVAS0,U,2)_" "_$P(PSIVAS0,U,3)
"RTN","PSIVOCDS",104,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",105,0)
 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",106,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="MAINTENANCE"
"RTN","PSIVOCDS",107,0)
 S PSJFDB(PSJCNT,"SPECIFIC")=1
"RTN","PSIVOCDS",108,0)
 ;This is set when CPRS sends Duration without entering a solution.
"RTN","PSIVOCDS",109,0)
 I $D(PSJIV("FRQ_ERROR")) S PSJFDB(PSJCNT,"FRQ_ERROR")="",PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",110,0)
 Q
"RTN","PSIVOCDS",111,0)
BASIC ;Set basic data for non schedule IVs
"RTN","PSIVOCDS",112,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",113,0)
 S PSJFDB(PSJCNT,"FREQ")=""
"RTN","PSIVOCDS",114,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",115,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",116,0)
 ; SDA is set to the additive strength or volume of the solution.
"RTN","PSIVOCDS",117,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=$P(PSIVAS0,U,8)
"RTN","PSIVOCDS",118,0)
 Q
"RTN","PSIVOCDS",119,0)
FREEDOSE ;Set data for free text dose
"RTN","PSIVOCDS",120,0)
 ;"GENERAL" info only needed to pass in Dose Route and Dose Type.
"RTN","PSIVOCDS",121,0)
 ;"Exception" node sets here to get the specified error back for free text dosing.
"RTN","PSIVOCDS",122,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",123,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",124,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DOSE_RATE")
"RTN","PSIVOCDS",125,0)
 S PSJFDB(PSJCNT,"INF_ERROR")=""
"RTN","PSIVOCDS",126,0)
 I $G(PSJP8ERR)=2!($G(PSJP8ERR)=4) S PSJFDB(PSJCNT,"WT_ERROR")=""
"RTN","PSIVOCDS",127,0)
 I $G(PSJP8ERR)=3!($G(PSJP8ERR)=4) S PSJFDB(PSJCNT,"HT_ERROR")=""
"RTN","PSIVOCDS",128,0)
 Q
"RTN","PSIVOCDS",129,0)
ONEAD(PSJRT) ;Setup data for 'Continuous Infusion' IV type
"RTN","PSIVOCDS",130,0)
 NEW PSJCLASS,PSJX
"RTN","PSIVOCDS",131,0)
 ;PSJRT - FDB converted routes from $$RTESCRN
"RTN","PSIVOCDS",132,0)
 ;If the route is not specified in FDB for this drug then default to value set in BASIC^PSIVOCDS
"RTN","PSIVOCDS",133,0)
 ;I '$$FDBRT(PSJFDB(PSJCNT,"DRUG_IEN"),PSJRT) Q
"RTN","PSIVOCDS",134,0)
 ;S PSJRT=$$RTESCRN(PSJRT)
"RTN","PSIVOCDS",135,0)
 ;
"RTN","PSIVOCDS",136,0)
 I $G(PSJRT)=0!($G(PSJRT)="") Q
"RTN","PSIVOCDS",137,0)
 ;Check to make sure the infusion rate is in form of "ml/hr" before applying the calculation
"RTN","PSIVOCDS",138,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",139,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",140,0)
 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",141,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",142,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",143,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",144,0)
 I PSJP8UNT="MILLILITERS",(PSJP8TME="HOUR") D
"RTN","PSIVOCDS",145,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=$$SDACI()
"RTN","PSIVOCDS",146,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(PSIVAS0,U,9)
"RTN","PSIVOCDS",147,0)
 I PSJP8UNT'="MILLILITERS" D
"RTN","PSIVOCDS",148,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",149,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=PSJP8NUM
"RTN","PSIVOCDS",150,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=PSJP8UNT
"RTN","PSIVOCDS",151,0)
 . S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",152,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",153,0)
 Q
"RTN","PSIVOCDS",154,0)
CONTIV ;Set data needed for continuous IV with multiple drugs
"RTN","PSIVOCDS",155,0)
 NEW PSJFREQ,PSJDIFF
"RTN","PSIVOCDS",156,0)
 S PSJDIFF=+$$DURATION()
"RTN","PSIVOCDS",157,0)
 ; Order has duration <24 hrs
"RTN","PSIVOCDS",158,0)
 I PSJDIFF D UND24HRS
"RTN","PSIVOCDS",159,0)
 ; Order has duration >= 24 hrs
"RTN","PSIVOCDS",160,0)
 I 'PSJDIFF S PSJFDB(PSJCNT,"FREQ")=$$IVFREQ
"RTN","PSIVOCDS",161,0)
 ;
"RTN","PSIVOCDS",162,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSIVOCDS",163,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSIVOCDS",164,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSIVOCDS",165,0)
 Q
"RTN","PSIVOCDS",166,0)
ISONEAD() ;Return 1 if there's only one additive
"RTN","PSIVOCDS",167,0)
 NEW X,PSJX
"RTN","PSIVOCDS",168,0)
 I $D(PSIVDDSV("AD")),$D(PSIVDDSV("SOL")) Q 0
"RTN","PSIVOCDS",169,0)
 I $O(PSIVDDSV("SOL",0)) Q 0
"RTN","PSIVOCDS",170,0)
 S PSJX=0
"RTN","PSIVOCDS",171,0)
 F X=0:0 S X=$O(PSIVDDSV("AD",X)) Q:'X  S PSJX=PSJX+1 Q:PSJX>1
"RTN","PSIVOCDS",172,0)
 I PSJX>1 Q 0
"RTN","PSIVOCDS",173,0)
 Q 1
"RTN","PSIVOCDS",174,0)
ISALLBAG() ;Return 1 if not additive not in all bags
"RTN","PSIVOCDS",175,0)
 ;***this call assuming only 1 additive entered in the order
"RTN","PSIVOCDS",176,0)
 NEW X,PSIVAS0
"RTN","PSIVOCDS",177,0)
 S X=$O(PSIVDDSV("AD",0))
"RTN","PSIVOCDS",178,0)
 S PSIVAS0=$G(PSIVDDSV("AD",X))
"RTN","PSIVOCDS",179,0)
 I $P(PSIVAS0,U,4)]"" Q 0
"RTN","PSIVOCDS",180,0)
 Q 1
"RTN","PSIVOCDS",181,0)
ISNOADD() ;Return 1 if there's no additives
"RTN","PSIVOCDS",182,0)
 NEW X,PSJX
"RTN","PSIVOCDS",183,0)
 I $O(PSIVDDSV("AD",0)) Q 0
"RTN","PSIVOCDS",184,0)
 I $D(PSIVDDSV("SOL")) Q 1
"RTN","PSIVOCDS",185,0)
 Q 0
"RTN","PSIVOCDS",186,0)
PREMIX ;The route is always set to "Continuous Infusion" & the FREQUENCY must set to 1
"RTN","PSIVOCDS",187,0)
 NEW X
"RTN","PSIVOCDS",188,0)
 S PSJFDB(PSJCNT,"ROUTE")=$$RTESCRN(PSJRT)
"RTN","PSIVOCDS",189,0)
 I PSJFDB(PSJCNT,"ROUTE")=0 S PSJFDB(PSJCNT,"ROUTE")=PSJRT
"RTN","PSIVOCDS",190,0)
 I PSJP8="" D FREEDOSE Q
"RTN","PSIVOCDS",191,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",192,0)
 S PSJFDB(PSJCNT,"DOSE_AMT")=PSJP8NUM
"RTN","PSIVOCDS",193,0)
 S PSJFDB(PSJCNT,"DOSE_UNIT")=PSJP8UNT
"RTN","PSIVOCDS",194,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")=PSJP8TME
"RTN","PSIVOCDS",195,0)
 S PSJFDB(PSJCNT,"DURATION_RT")=PSJP8TME
"RTN","PSIVOCDS",196,0)
 ;PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" now FDB handles both units for this drug.
"RTN","PSIVOCDS",197,0)
 ;S PSJFDB(PSJCNT,"ROUTE")="CONTINUOUS INFUSION"
"RTN","PSIVOCDS",198,0)
 ;I PSJP8UNT="MILLILITERS" S X=$$LITER(PSJP8NUM) I X]"" D
"RTN","PSIVOCDS",199,0)
 ;. S PSJFDB(PSJCNT,"DOSE_AMT")=$P(X,U)
"RTN","PSIVOCDS",200,0)
 ;. S PSJFDB(PSJCNT,"DOSE_UNIT")=$P(X,U,2)
"RTN","PSIVOCDS",201,0)
 Q
"RTN","PSIVOCDS",202,0)
SDACI() ;Return Single Dose Amount for ad for 'CONTINUOUS INFUSION' FDB Route (Not classed at "VT" or "TN")
"RTN","PSIVOCDS",203,0)
 ;Single Dose Amount(PSJSDA):
"RTN","PSIVOCDS",204,0)
 ; For Additive - PSJSDA=(Strength/Tot vol)*Infusion Rate
"RTN","PSIVOCDS",205,0)
 ; If can't calculate then return null
"RTN","PSIVOCDS",206,0)
 NEW PSJSDA,X
"RTN","PSIVOCDS",207,0)
 S PSJSDA=""
"RTN","PSIVOCDS",208,0)
 I $D(PSIVDDSV("AD")) D
"RTN","PSIVOCDS",209,0)
 . S X=+$G(PSIVDDSV("TOT_VOL")) Q:'X
"RTN","PSIVOCDS",210,0)
 . S PSJSDA=($P(PSIVAS0,U,8)/X)*PSJP8NUM
"RTN","PSIVOCDS",211,0)
 I '+PSJSDA S PSJSDA=$P(PSIVAS0,U,8),PSJFDB(PSJCNT,"INF_ERROR")=""
"RTN","PSIVOCDS",212,0)
 Q PSJSDA
"RTN","PSIVOCDS",213,0)
CLASS(PSJDD) ;Check if the Drug contains "VT" & "TN" classes
"RTN","PSIVOCDS",214,0)
 ;Return 1 if "VT" or "TN"
"RTN","PSIVOCDS",215,0)
 ;Return 0 if not
"RTN","PSIVOCDS",216,0)
 Q:'+$G(PSJDD) 0
"RTN","PSIVOCDS",217,0)
 NEW PSJCLASS
"RTN","PSIVOCDS",218,0)
 S PSJCLASS=$P($G(^PSDRUG(+PSJDD,0)),U,2)
"RTN","PSIVOCDS",219,0)
 ;I (PSJCLASS["TN")!(PSJCLASS["VT") Q 1
"RTN","PSIVOCDS",220,0)
 I PSJCLASS["VT" Q 1
"RTN","PSIVOCDS",221,0)
 Q 0
"RTN","PSIVOCDS",222,0)
IVFREQ() ;Return the frequency for an continuous IV
"RTN","PSIVOCDS",223,0)
 ; Hours needed to run a bag is defined as: Total Volume / Infusion rate
"RTN","PSIVOCDS",224,0)
 ; # of bags needed for a day is defined as: 24 / Hours need to run a bag
"RTN","PSIVOCDS",225,0)
 ; PSJFREQ is either in Q#H or N for # of admin per day
"RTN","PSIVOCDS",226,0)
 NEW PSJFREQ,PSJBOT,PSJX,X,PSJTOTBG,PSJTOTBT,PSJTOTV,PSJBAGX
"RTN","PSIVOCDS",227,0)
 S (PSJFREQ,PSJTOTBG,PSJTOTBT)=0
"RTN","PSIVOCDS",228,0)
 S PSJTOTV=+$G(PSIVDDSV("TOT_VOL"))
"RTN","PSIVOCDS",229,0)
 ;CONV^PSSDSAPK converts # of hours to run a bag to either Q#H or n for number of admin per day
"RTN","PSIVOCDS",230,0)
 I +PSJTOTV,PSJP8NUM D
"RTN","PSIVOCDS",231,0)
 . ;I $P(PSIVAS0,U,4)="",(+PSJTOTV#PSJP8NUM) D
"RTN","PSIVOCDS",232,0)
 . I +PSJTOTV#PSJP8NUM D
"RTN","PSIVOCDS",233,0)
 .. S PSJFDB(PSJCNT,"DOSE_AMT")=$$ADJSDA(+PSJTOTV,PSJP8NUM,+PSJFDB(PSJCNT,"DOSE_AMT"),1)
"RTN","PSIVOCDS",234,0)
 . S PSJBAGX=PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",235,0)
 . I PSJBAGX<1 S PSJFREQ="Q1H"
"RTN","PSIVOCDS",236,0)
 . S:PSJBAGX'<1 PSJFREQ=$$CONV^PSSDSAPK(PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",237,0)
 . S PSJTOTBG=24/(+PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",238,0)
 I PSIVAS="AD" D BOTTLE(PSJTOTBG,$P(PSIVAS0,U,4)) D
"RTN","PSIVOCDS",239,0)
 . I PSJTOTBG<1,'(+PSJTOTV#PSJP8NUM) S PSJFDB(PSJCNT,"DOSE_AMT")=$$ADJSDA(+PSJTOTV,PSJP8NUM,+PSJFDB(PSJCNT,"DOSE_AMT"),0)
"RTN","PSIVOCDS",240,0)
 I PSJFREQ=""!(PSJFREQ=0) S PSJFREQ=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",241,0)
 Q PSJFREQ
"RTN","PSIVOCDS",242,0)
ADJSDA(PSJTOTV,PSJINFRT,PSJSDA,PSJNOTE) ;Adjust SDA
"RTN","PSIVOCDS",243,0)
 NEW PSJBAGX,X
"RTN","PSIVOCDS",244,0)
 I $S(+PSJTOTV:0,+PSJINFRT:0,+PSJSDA:0,1:1) Q ""
"RTN","PSIVOCDS",245,0)
 S PSJBAGX=+PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",246,0)
 I PSJBAGX<1 S PSJSDA=PSJSDA/PSJBAGX
"RTN","PSIVOCDS",247,0)
 I PSJBAGX'<1 D
"RTN","PSIVOCDS",248,0)
 . S X=$J(PSJBAGX,"",0)
"RTN","PSIVOCDS",249,0)
 . S PSJSDA=PSJSDA/(+PSJTOTV)*PSJP8NUM*($S(X<24:X,1:24))
"RTN","PSIVOCDS",250,0)
 . I +$G(PSJNOTE) D
"RTN","PSIVOCDS",251,0)
 .. S PSJFDB(PSJCNT,"ADJ_MSG")="PLEASE NOTE: The single dose of the IV Additive has been adjusted to reflect the amount of drug infused over the nearest whole number of hours ("_($S(X<24:X,1:24)*PSJINFRT)_" ML over "_$S(X<24:X,1:24)_" hours)."
"RTN","PSIVOCDS",252,0)
 Q PSJSDA
"RTN","PSIVOCDS",253,0)
UND24HRS ;Calculate freq for order <24 hrs
"RTN","PSIVOCDS",254,0)
 NEW PSJTOTV,PSJBAG,PSJMNBAG,PSJTOTBG,PSJFREQ,PSJHRS
"RTN","PSIVOCDS",255,0)
 ;PSJFREQ,PSJBOT,PSJX,X,PSJTOTBG,PSJTOTBT,PSJTOTV,PSJMNBAG,PSJDIFF
"RTN","PSIVOCDS",256,0)
 S (PSJFREQ,PSJBAG,PSJMNBAG)=0
"RTN","PSIVOCDS",257,0)
 S PSJTOTV=+$G(PSIVDDSV("TOT_VOL"))
"RTN","PSIVOCDS",258,0)
 I +PSJTOTV,PSJP8NUM D
"RTN","PSIVOCDS",259,0)
 . S PSJHRS=PSJTOTV/PSJP8NUM
"RTN","PSIVOCDS",260,0)
 . S PSJMNBAG=PSJHRS*60
"RTN","PSIVOCDS",261,0)
 . S PSJTOTBG=24/PSJHRS
"RTN","PSIVOCDS",262,0)
 I '+PSJMNBAG D  Q
"RTN","PSIVOCDS",263,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",264,0)
 . S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",265,0)
 S:+PSJMNBAG PSJBAG=PSJDIFF/PSJMNBAG
"RTN","PSIVOCDS",266,0)
 ; If the order is for < 24 hrs & Freq < 1 then adjust the SDA & Freq set to 1
"RTN","PSIVOCDS",267,0)
 I PSJBAG<1 D  Q
"RTN","PSIVOCDS",268,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSIVOCDS",269,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=PSJBAG*(PSJFDB(PSJCNT,"DOSE_AMT"))
"RTN","PSIVOCDS",270,0)
 ;
"RTN","PSIVOCDS",271,0)
 S PSJFREQ=$J(PSJBAG,"",0)
"RTN","PSIVOCDS",272,0)
 I PSIVAS="AD" D BOTTLE(PSJFREQ,$P(PSIVAS0,U,4))
"RTN","PSIVOCDS",273,0)
 S PSJFDB(PSJCNT,"FREQ")=PSJFREQ
"RTN","PSIVOCDS",274,0)
 Q
"RTN","PSIVOCDS",275,0)
 ;
"RTN","PSIVOCDS",276,0)
BOTTLE(PSJTOTBG,PSJBOT) ;Set freq to either specified bottle or # needed for the duration/24hrs of the order
"RTN","PSIVOCDS",277,0)
 NEW PSJTOTBT,X,PSJX
"RTN","PSIVOCDS",278,0)
 Q:'+$G(PSJTOTBG)
"RTN","PSIVOCDS",279,0)
 ;
"RTN","PSIVOCDS",280,0)
 ;PSJ*5*252 - ADJSDA already adjusted the SDA so recal SDA is not needed
"RTN","PSIVOCDS",281,0)
 I PSJTOTBG<1 S PSJFREQ=1 Q
"RTN","PSIVOCDS",282,0)
 Q:$G(PSJBOT)=""
"RTN","PSIVOCDS",283,0)
 S PSJTOTBT=0
"RTN","PSIVOCDS",284,0)
 F X=1:1:$L(PSJBOT,",") S PSJX=$P(PSJBOT,",",X) S:+PSJX PSJTOTBT=PSJTOTBT+1
"RTN","PSIVOCDS",285,0)
 S PSJFREQ=$S(PSJTOTBT>PSJTOTBG:PSJTOTBG,1:PSJTOTBT)
"RTN","PSIVOCDS",286,0)
 I PSJTOTV#PSJP8NUM,(PSJTOTBT>PSJTOTBG) D
"RTN","PSIVOCDS",287,0)
 . S PSJFREQ=$$CONV^PSSDSAPK(PSJTOTV/PSJP8NUM)
"RTN","PSIVOCDS",288,0)
 I PSJFREQ=0 S PSJFREQ=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSIVOCDS",289,0)
 Q
"RTN","PSIVOCDS",290,0)
DURATION() ;
"RTN","PSIVOCDS",291,0)
 ;If PSJIV("DUR") is passed in from CPRS then return the minutes if <1440 otherwise return ""
"RTN","PSIVOCDS",292,0)
 ;If not call from CPRS then calculate from start, stop date
"RTN","PSIVOCDS",293,0)
 NEW PSJX,X,PSJP8X
"RTN","PSIVOCDS",294,0)
 S PSJX=""
"RTN","PSIVOCDS",295,0)
 I +$G(PSJIV("DUR")) D  Q X
"RTN","PSIVOCDS",296,0)
 .S PSJX=+$G(PSJIV("DUR"))
"RTN","PSIVOCDS",297,0)
 .S X=$S(PSJX<1440:PSJX,1:"")
"RTN","PSIVOCDS",298,0)
 I +$G(PSJIV("TOT_VOL")) D  Q X
"RTN","PSIVOCDS",299,0)
 . S PSJP8X=$S(+$G(PSJP8NUM):PSJP8NUM,+P(8):+P(8),1:0)
"RTN","PSIVOCDS",300,0)
 . S:PSJP8X PSJX=(+PSJIV("TOT_VOL")/PSJP8X)*60
"RTN","PSIVOCDS",301,0)
 . S X=$S(PSJX<1440:PSJX,1:"")
"RTN","PSIVOCDS",302,0)
 S X=$$DURATION^PSJOCDS($G(P(2)),$G(P(3)))
"RTN","PSIVOCDS",303,0)
 Q X
"RTN","PSIVOCDS",304,0)
FDBRT(PSJDD,PSJRT) ;Check if the ordered route can be admin by FDB for this drug
"RTN","PSIVOCDS",305,0)
 ;PSJDD = Drug IEN
"RTN","PSIVOCDS",306,0)
 ;PSJRT = Route entered for the order that mapped to FDB route
"RTN","PSIVOCDS",307,0)
 ;Return 1 if the route can admin by FDB; 0 if this route is not specify for this drug
"RTN","PSIVOCDS",308,0)
 NEW PSJFDBRT
"RTN","PSIVOCDS",309,0)
 I '+$G(PSJDD)!$G(PSJRT)="" Q 0
"RTN","PSIVOCDS",310,0)
 D GROUTE^PSSFDBRT(PSJDD,.PSJFDBRT)
"RTN","PSIVOCDS",311,0)
 I +$G(PSJFDBRT(0))=-1 Q 1
"RTN","PSIVOCDS",312,0)
 I $D(PSJFDBRT(PSJRT)) Q 1
"RTN","PSIVOCDS",313,0)
 Q 0
"RTN","PSIVOCDS",314,0)
RTESCRN(PSJRT) ; Screen routes for none "VT or "TN"
"RTN","PSIVOCDS",315,0)
 ;Return 0 or FDB equivalent if the ordered route is one of the six below.
"RTN","PSIVOCDS",316,0)
 ;PSJRT - Ordered route
"RTN","PSIVOCDS",317,0)
 I PSJRT="EPIDURAL" Q "CONTINUOUS EPIDURAL"
"RTN","PSIVOCDS",318,0)
 I PSJRT="INTRA-ARTERIAL" Q "CONT INTRAARTER INF"
"RTN","PSIVOCDS",319,0)
 I PSJRT="INFILTRATION" Q "CONTINUOUS INFILTRAT"
"RTN","PSIVOCDS",320,0)
 I PSJRT="INTRACAUDAL" Q "CONT CAUDAL INFUSION"
"RTN","PSIVOCDS",321,0)
 I PSJRT="INTRAOSSEOUS" Q "CONT INTRAOSSEOUS"
"RTN","PSIVOCDS",322,0)
 I PSJRT="INTRATHECAL" Q "CONT INTRATHECAL INF"
"RTN","PSIVOCDS",323,0)
 I PSJRT="INTRAVENOUS" Q "CONTINUOUS INFUSION"
"RTN","PSIVOCDS",324,0)
 I PSJRT="NEBULIZATION" Q "CONT NEBULIZATION"
"RTN","PSIVOCDS",325,0)
 I PSJRT="SUBCUTANEOUS" Q "CONT SUBCUTAN INFUSI"
"RTN","PSIVOCDS",326,0)
 Q 0
"RTN","PSIVOCDS",327,0)
LITER(PSJVOLP8) ; Convert the unit from ML to L for premix contains potassium
"RTN","PSIVOCDS",328,0)
 ; PSJ*5*252 (6/29/11) - No longer need to convert "ML" to "L" for this drug now that FDB handles both units.
"RTN","PSIVOCDS",329,0)
 ; FDB only accept Liter for this type for drug
"RTN","PSIVOCDS",330,0)
 ; PSJVOLP8 - Either = volume or the infusion rate
"RTN","PSIVOCDS",331,0)
 NEW PSJVAGEN,PSJSDA,PSJUNIT
"RTN","PSIVOCDS",332,0)
 Q:$G(PSJVOLP8)=""
"RTN","PSIVOCDS",333,0)
 S PSJVAGEN=$$VAGEN^PSJMISC($P(PSIVAS0,U))
"RTN","PSIVOCDS",334,0)
 I PSJVAGEN["POTASSIUM" D
"RTN","PSIVOCDS",335,0)
 . S PSJSDA=+(PSJVOLP8/1000)
"RTN","PSIVOCDS",336,0)
 . S PSJUNIT="L"
"RTN","PSIVOCDS",337,0)
 I '+$G(PSJSDA)!($G(PSJUNIT)="") Q ""
"RTN","PSIVOCDS",338,0)
 Q PSJSDA_U_PSJUNIT
"RTN","PSIVOPT")
0^19^B58375431
"RTN","PSIVOPT",1,0)
PSIVOPT ;BIR/PR,MLM-OPTION DRIVER ; 1/4/12 7:36am
"RTN","PSIVOPT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**17,27,58,88,104,110,155,181,271,252**;16 DEC 97;Build 69
"RTN","PSIVOPT",3,0)
 ;
"RTN","PSIVOPT",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191
"RTN","PSIVOPT",5,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192        
"RTN","PSIVOPT",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231
"RTN","PSIVOPT",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173
"RTN","PSIVOPT",8,0)
 ;
"RTN","PSIVOPT",9,0)
 NEW PSIVLOCK S PSIVLOCK=0
"RTN","PSIVOPT",10,0)
 ;I ON["P" L +^PS(53.1,+ON):1 S:'$T PSIVLOCK=1
"RTN","PSIVOPT",11,0)
 I ON["V" L +^PS(55,DFN,"IV",+ON55):1 S:'$T PSIVLOCK=1
"RTN","PSIVOPT",12,0)
 I PSIVLOCK W !,$C(7),$C(7),"This order is being edited by another user. Try later." G K
"RTN","PSIVOPT",13,0)
 ;W ! L +^PS(55,DFN,"IV",+ON55):1 I '$T W !,$C(7),$C(7),"This order is being edited by another user. Try later." G K
"RTN","PSIVOPT",14,0)
 I PSIVAC="O"!(PSIVAC="H") S PSIVAC=PSIVAC_"(DFN,ON,P(17),P(3))"
"RTN","PSIVOPT",15,0)
 S TEX="Active order ***" I $D(UWLFLAG),UWLFLAG="1.001" S XED=0 D @PSIVAC G K
"RTN","PSIVOPT",16,0)
 S DONE=0 F  D ACT Q:DONE
"RTN","PSIVOPT",17,0)
 ;
"RTN","PSIVOPT",18,0)
UNLOCK ; Unlock order.
"RTN","PSIVOPT",19,0)
 ;I ON["P" L -^PS(53.1,+ON)
"RTN","PSIVOPT",20,0)
 ;E  L -^PS(55,DFN,"IV",+ON55)
"RTN","PSIVOPT",21,0)
 I ON["V" L -^PS(55,DFN,"IV",+ON55)
"RTN","PSIVOPT",22,0)
 ;
"RTN","PSIVOPT",23,0)
K ; Kill variables. *271
"RTN","PSIVOPT",24,0)
 K %,DA,DIE,DIK,DLAYGO,DNE,DR,DRG,DRGI,DRGT,ERR,HELP,J,OD,P,P16,PSIVAL,PSIVC,PSIVLOG,PSIVNOL,PSIVOK,PSIVOPT,PSIVREA,SCRNPRO,TEX,XED,ZZND
"RTN","PSIVOPT",25,0)
 Q
"RTN","PSIVOPT",26,0)
ACT ; Prompt for order action.
"RTN","PSIVOPT",27,0)
 K PSJIVBD NEW PSGFDX,PSGSDX S (PSJORD,ON)=ON55
"RTN","PSIVOPT",28,0)
 S PSJCOM=$S(ON["V":$P($G(^PS(55,DFN,"IV",+ON,.2)),"^",8),1:$P($G(^PS(53.1,+ON,.2)),"^",8))
"RTN","PSIVOPT",29,0)
 D:ON["V" EN^PSJLIORD(DFN,ON)
"RTN","PSIVOPT",30,0)
 I ON["P",($P($G(^PS(53.1,+ON,0)),U,9)="N"),'PSJCOM D GT531^PSIVORFA(DFN,ON),VF^PSIVORC2 S DONE=1 Q
"RTN","PSIVOPT",31,0)
 I ON["P",PSJCOM Q:'$$LOCK^PSJOEA(DFN,PSJCOM)  N PSJO,ON,PSJORD S PSJO=0 F  S PSJO=$O(^PS(53.1,"ACX",PSJCOM,PSJO)) Q:'PSJO  Q:$G(Y)="Q"  S (PSJORD,ON)=PSJO_"P" D
"RTN","PSIVOPT",32,0)
 .D:($P($G(^PS(53.1,+ON,0)),U,9)="N") GT531^PSIVORFA(DFN,ON),VF^PSIVORC2
"RTN","PSIVOPT",33,0)
 .D:($P($G(^PS(53.1,+ON,0)),U,9)="P") EN^PSJLIFN
"RTN","PSIVOPT",34,0)
 I $G(PSJCOM) N PSJORD S PSJORD=PSJCOM D CHK^PSJOEA1
"RTN","PSIVOPT",35,0)
 I ON'["V",'+$G(PSJCOM) D EN^PSJLIFN
"RTN","PSIVOPT",36,0)
 S DONE=1
"RTN","PSIVOPT",37,0)
 Q
"RTN","PSIVOPT",38,0)
 ;
"RTN","PSIVOPT",39,0)
CK ; Check if drugs are still valid.
"RTN","PSIVOPT",40,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F DRGI=0:0 S DRGI=$O(DRG(DRGT,DRGI)) Q:'DRGI  D
"RTN","PSIVOPT",41,0)
 .S DRG=+$P(DRG(DRGT,DRGI),U),X=$G(^PS(FIL,DRG,"I")) I $S('X:0,DT<X:0,1:1)!$S('$G(^PSDRUG(+$P($G(^PS(FIL,DRG,0)),U,2),"I")):0,^("I")>DT:0,1:1) S ERR=1
"RTN","PSIVOPT",42,0)
 Q
"RTN","PSIVOPT",43,0)
 ;
"RTN","PSIVOPT",44,0)
D ; Discontinue order.
"RTN","PSIVOPT",45,0)
 D D^PSIVOPT2
"RTN","PSIVOPT",46,0)
 Q
"RTN","PSIVOPT",47,0)
 ;
"RTN","PSIVOPT",48,0)
O(DFN,ON,STAT,STOP) ; On/Off Call
"RTN","PSIVOPT",49,0)
 D NOW^%DTC I STAT="H",STOP<% D EXPIR Q
"RTN","PSIVOPT",50,0)
 I "OA"'[STAT W !,$C(7),"Only active orders may be placed on hold." Q
"RTN","PSIVOPT",51,0)
 S PSIVALT=1,PSIVREA=$S(STAT'="O":"O",1:"C"),(P(17),STAT)=$S(PSIVREA="O":"O",1:"A") W:PSIVREA="C" ?$X+4,$C(7),TEX
"RTN","PSIVOPT",52,0)
 D UPSTAT,LOG^PSIVORAL D:STAT="A" CKO^PSIVCHK
"RTN","PSIVOPT",53,0)
 Q
"RTN","PSIVOPT",54,0)
 ;
"RTN","PSIVOPT",55,0)
E ; Entry for Pharmacy edit
"RTN","PSIVOPT",56,0)
 N PSJEDIT1 D E^PSIVOPT1
"RTN","PSIVOPT",57,0)
 Q
"RTN","PSIVOPT",58,0)
 ;
"RTN","PSIVOPT",59,0)
R ; Renew order.
"RTN","PSIVOPT",60,0)
 NEW PSJOCFG
"RTN","PSIVOPT",61,0)
 S PSJOCFG="RENEW IV"
"RTN","PSIVOPT",62,0)
 D R^PSIVOPT2
"RTN","PSIVOPT",63,0)
 K PSJOCFG
"RTN","PSIVOPT",64,0)
 Q
"RTN","PSIVOPT",65,0)
 ;
"RTN","PSIVOPT",66,0)
H(DFN,ON,STAT,STOP)          ; Place order on hold.
"RTN","PSIVOPT",67,0)
 D NOW^%DTC I STAT="H" I STOP<% D EXPIR Q
"RTN","PSIVOPT",68,0)
 I "HA"'[STAT W !,$C(7),"Only active orders may be placed on hold." Q
"RTN","PSIVOPT",69,0)
 D NATURE^PSIVOREN I '$D(P("NAT")) W !!,"Order unchanged." Q
"RTN","PSIVOPT",70,0)
 S PSIVALT=1,PSIVREA=$S(STAT'="H":"H",1:"U"),(P(17),STAT)=$S(PSIVREA="H":"H",1:"A") W:PSIVREA="U" ?$X+4,$C(7),TEX
"RTN","PSIVOPT",71,0)
 D UPSTAT,LOG^PSIVORAL,HOLD^PSIVOE,ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,$S(PSIVREA="H":"H1",1:"H0")) D:STAT="A" CKO^PSIVCHK
"RTN","PSIVOPT",72,0)
 Q
"RTN","PSIVOPT",73,0)
 ;
"RTN","PSIVOPT",74,0)
S ; View order.
"RTN","PSIVOPT",75,0)
 D @$S(ON55["V":"GT55^PSIVORFB",1:"GT531^PSIVORFA("_DFN_","""_ON55_""")") W @IOF D EN^PSIVORV2
"RTN","PSIVOPT",76,0)
 Q
"RTN","PSIVOPT",77,0)
 ;
"RTN","PSIVOPT",78,0)
EXPIR ; Update status of expired orders.
"RTN","PSIVOPT",79,0)
 I STAT="H" S PSIVREA="H",P(17)="E"
"RTN","PSIVOPT",80,0)
 S STAT="E" D UPSTAT,EXPIR^PSIVOE W $C(7),"  This order has expired."
"RTN","PSIVOPT",81,0)
 Q
"RTN","PSIVOPT",82,0)
 ;
"RTN","PSIVOPT",83,0)
UPSTAT ; Update orders status.
"RTN","PSIVOPT",84,0)
 N DA,DR,DIE,PSIVACT S PSIVACT=1,DA=+ON55,DA(1)=DFN,DIE="^PS(55,"_DFN_",""IV"",",DR="100///"_P(17)_$S($G(PSIVREA)="H":";149///1",$G(PSIVREA)="U":";149///@",1:"") D ^DIE
"RTN","PSIVOPT",85,0)
 Q
"RTN","PSIVOPT",86,0)
 ;
"RTN","PSIVOPT",87,0)
ENIN ; Entry for inpatient order entry/profile options.
"RTN","PSIVOPT",88,0)
 N DFN,ON,P,PSIVAC S PSIVAC="C" I PSJORD["P" S (P("PON"),ON)=+PSJORD_"P",DFN=PSGP D SHOW1^PSIVORC Q
"RTN","PSIVOPT",89,0)
 S (P("PON"),ON,ON55)=+PSJORD_"V",DFN=PSGP D GT55^PSIVORFB,EN^PSIVORV2,PSIVOPT:'$D(PSJPRF)
"RTN","PSIVOPT",90,0)
 L -^PS(55,DFN,"IV",+PSJORD)
"RTN","PSIVOPT",91,0)
 Q
"RTN","PSIVOPT",92,0)
 ;
"RTN","PSIVOPT",93,0)
ENARI(DFN,ON,PSGUOW,PSIVAL) ; Auto-reinstate IV orders if movement is deleted.
"RTN","PSIVOPT",94,0)
 ;Create a list of recipients beyond normal mail group
"RTN","PSIVOPT",95,0)
 S PSGORNUM=$S($G(PSGORD):PSGORD,$G(PSJORD):PSJORD,$G(OR55):OR55,1:"")
"RTN","PSIVOPT",96,0)
 I $G(PSGORNUM) D
"RTN","PSIVOPT",97,0)
 .I $D(^PS(55,PSGP,"IV",+PSGORNUM,0)),$P(^PS(55,PSGP,"IV",+PSGORNUM,0),U,6)'="" S PSJSENTO($J,$P(^PS(55,PSGP,"IV",+PSGORNUM,0),U,6))="" ; Provider
"RTN","PSIVOPT",98,0)
 .I $D(^PS(55,PSGP,"IV",+PSGORNUM,2)),$P(^PS(55,PSGP,"IV",+PSGORNUM,2),U,11)'="" S PSJSENTO($J,$P(^PS(55,PSGP,"IV",+PSGORNUM,2),U,11))="" ; Entered by
"RTN","PSIVOPT",99,0)
 .I $D(^PS(55,PSGP,"IV",+PSGORNUM,4)),$P(^PS(55,PSGP,"IV",+PSGORNUM,4),U,1)'="" S PSJSENTO($J,$P(^PS(55,PSGP,"IV",+PSGORNUM,4),U,1))="" ; Verifying Nurse
"RTN","PSIVOPT",100,0)
 ; find pharmacist that finished the IV order
"RTN","PSIVOPT",101,0)
 N PSJX,ENTBY S PSJX=$G(^PS(55,PSGP,"IV",+ON,"A",1,0))
"RTN","PSIVOPT",102,0)
 I $P(PSJX,U,2)="F" S ENTBY=$$VA200($P(PSJX,U,3)) I ENTBY'="" S PSJSENTO($J,ENTBY)=""
"RTN","PSIVOPT",103,0)
 ;
"RTN","PSIVOPT",104,0)
 I $G(PSGALO)'=18530,$G(PSGORNUM),$$IVDUPADD^PSIVOPT(PSGP,+PSGORNUM) S ^TMP("PSJNOTUNDC",$J,PSGP,+PSGORNUM_"V")="" Q
"RTN","PSIVOPT",105,0)
 N DA,DR,DIE,DIK,PSIVREA,PSIVALCK,PSIVOPT,PSIVALT,X,Y
"RTN","PSIVOPT",106,0)
 S X=$G(^PS(55,DFN,"IV",+ON,"ADC")) I X K ^PS(55,"ADC",X,DFN,+ON),^PS(55,DFN,"IV",+ON,"ADC")
"RTN","PSIVOPT",107,0)
 ;S PSIVACT=1,DR=$S(+$P($G(^PS(55,DFN,"IV",+ON,4)),U,18)=1:"100///H",+$P($G(^PS(55,DFN,"IV",+ON,0)),U,10)=1:"100///H",1:"100///A")_";.03////"_+$P($G(^PS(55,DFN,"IV",+ON,2)),U,7)_";109///@;116///@;121///@;157////@"
"RTN","PSIVOPT",108,0)
 S PSIVACT=1,DR=$S(+$P($G(^PS(55,DFN,"IV",+ON,0)),U,10)=1:"100///H;157///HP",+$P($G(^PS(55,DFN,"IV",+ON,4)),U,18)=1:"100///H;157///@",1:"100///A;157///@")_";.03////"_+$P($G(^PS(55,DFN,"IV",+ON,2)),U,7)_";109///@;116///@;121///@"
"RTN","PSIVOPT",109,0)
 S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON,DA(1)=DFN
"RTN","PSIVOPT",110,0)
 N CHKIT S CHKIT=$G(^PS(55,DFN,"IV",+ON,2)) I $P(CHKIT,U,6)["P",($P(CHKIT,U,9)="R") S DR=DR_";114///@;123///@"
"RTN","PSIVOPT",111,0)
 D ^DIE
"RTN","PSIVOPT",112,0)
 S ^TMP("PSJUNDC",$J,DFN,ON_"V")=""
"RTN","PSIVOPT",113,0)
 S ON55=ON,P(17)="A",PSIVREA=$S($D(PSJUNDC):"AI",1:"I"),PSIVALCK="STOP",(PSIVOPT,PSIVALT)=1,PSIVAL=$P($G(^PS(53.3,+PSIVAL,0)),U) D LOG^PSIVORAL
"RTN","PSIVOPT",114,0)
 ;* S Y=^PS(55,DFN,"IV",+ON,0),P(3)=+$P(Y,U,3),ORIFN=$P(Y,U,21),P(12)="" D:'$D(PSJIVORF) ORPARM^PSIVOREN I PSJIVORF D
"RTN","PSIVOPT",115,0)
 S Y=^PS(55,DFN,"IV",+ON,0),P(3)=+$P(Y,U,3),P(12)="" D:'$D(PSJIVORF) ORPARM^PSIVOREN I PSJIVORF D
"RTN","PSIVOPT",116,0)
 .D EN1^PSJHL2(DFN,"SC",+ON55_"V","AUTO REINSTATED")
"RTN","PSIVOPT",117,0)
 S PSGTOL=$S($D(PSJUNDC):3,1:2)
"RTN","PSIVOPT",118,0)
 Q:$S('$D(PSJUNDC):0,PSGALO=18540:1,1:'$P($G(PSJSYSW0),U,15))
"RTN","PSIVOPT",119,0)
 I $D(^PS(53.41,1,1,PSGUOW,1,DFN,1,3,1,+ON)) K DIK,DA S DIK="^PS(53.41,1,1,"_PSGUOW_",1,"_DFN_",1,3,1,",DA=+ON,DA(1)=1,DA(2)=PSGP,DA(3)=PSGUOW,DA(4)=3 D ^DIK
"RTN","PSIVOPT",120,0)
 E  K DA D ENLBL^PSIVOPT(PSGTOL,PSGUOW,DFN,3,+ON,"RE")
"RTN","PSIVOPT",121,0)
 Q
"RTN","PSIVOPT",122,0)
 ;
"RTN","PSIVOPT",123,0)
ENINP(DFN,ON) ; Entry from Inpatient Profile.
"RTN","PSIVOPT",124,0)
 N PSIVAC,ON55 S PSIVAC="PRO" D @($S(ON["V":"GT55^PSIVORFB",1:"GT531^PSIVORFA("_DFN_","""_ON_""")")),ENNH^PSIVORV2(ON)
"RTN","PSIVOPT",125,0)
 Q
"RTN","PSIVOPT",126,0)
ENLBL(PSGTOL,PSGUOW,PSGP,PSGTOO,DA,RES) ;
"RTN","PSIVOPT",127,0)
 ;Queue MAR labels for IV orders.
"RTN","PSIVOPT",128,0)
 Q:'$D(^DPT(PSGP,.1))  I '$D(PSJSYSW0) N PSJACPF,PSJACNWP S PSJACPF=11 D WP^PSJAC Q:'PSJSYSL
"RTN","PSIVOPT",129,0)
 N P,X,Y
"RTN","PSIVOPT",130,0)
 S X=$P(PSJSYSW0,U,2),Y=$P($G(^PS(55,PSGP,"IV",DA,0)),U,4)
"RTN","PSIVOPT",131,0)
 S Y=$S(Y="A":4,Y="H":5,Y="C":6,1:3) I X=1!(X[Y) D NOW^%DTC S PSGDT=% D ENL^PSGVDS S ^PS(55,DFN,"IV",DA,7)=PSGDT_U_RES
"RTN","PSIVOPT",132,0)
 Q
"RTN","PSIVOPT",133,0)
 ;
"RTN","PSIVOPT",134,0)
IVDUPADD(PSGP,ORDERNUM) ;
"RTN","PSIVOPT",135,0)
 N PSJCOM
"RTN","PSIVOPT",136,0)
 S DUPLOOP=0
"RTN","PSIVOPT",137,0)
 S DUPFOUND=0
"RTN","PSIVOPT",138,0)
 ;Loop through the additives of order to reinstate
"RTN","PSIVOPT",139,0)
 S PSJCOM=+$P($G(^PS(55,+PSGP,"IV",ORDERNUM,.2)),"^",8) F  S DUPLOOP=$O(^PS(55,PSGP,"IV",ORDERNUM,"AD",DUPLOOP)) Q:((DUPLOOP="")!(DUPFOUND))  D
"RTN","PSIVOPT",140,0)
 .;Get the additive code no.
"RTN","PSIVOPT",141,0)
 .S TARGET=$P(^PS(55,PSGP,"IV",ORDERNUM,"AD",DUPLOOP,0),"^",1)
"RTN","PSIVOPT",142,0)
 .D NOW^%DTC
"RTN","PSIVOPT",143,0)
 .S DATELOOP=%
"RTN","PSIVOPT",144,0)
 .;Loop through the current orders for the patient by date
"RTN","PSIVOPT",145,0)
 .F  S DATELOOP=$O(^PS(55,PSGP,"IV","AIS",DATELOOP)) Q:((DATELOOP="")!(DUPFOUND))  D
"RTN","PSIVOPT",146,0)
 ..S EXISTORD=""
"RTN","PSIVOPT",147,0)
 ..;Loop through the orders for date by order number
"RTN","PSIVOPT",148,0)
 ..F  S EXISTORD=$O(^PS(55,PSGP,"IV","AIS",DATELOOP,EXISTORD)) Q:((EXISTORD="")!(DUPFOUND))  D
"RTN","PSIVOPT",149,0)
 ...;Loop through additives for the existing order
"RTN","PSIVOPT",150,0)
 ...I PSJCOM>0 Q:+$P($G(^PS(55,+PSGP,"IV",EXISTORD,.2)),"^",8)
"RTN","PSIVOPT",151,0)
 ...S EXISTADD=0
"RTN","PSIVOPT",152,0)
 ...F  S EXISTADD=$O(^PS(55,PSGP,"IV",EXISTORD,"AD",EXISTADD)) Q:((EXISTADD="")!(DUPFOUND))  D 
"RTN","PSIVOPT",153,0)
 ....;Extract the Additive Code number for the Order
"RTN","PSIVOPT",154,0)
 ....S MATCHADD=$P(^PS(55,PSGP,"IV",EXISTORD,"AD",EXISTADD,0),"^",1)
"RTN","PSIVOPT",155,0)
 ....;If the existing order and the order to be reinstated have the same additive code then return FOUND=TRUE
"RTN","PSIVOPT",156,0)
 ....I MATCHADD=TARGET D
"RTN","PSIVOPT",157,0)
 .....S DUPFOUND=1
"RTN","PSIVOPT",158,0)
 Q DUPFOUND
"RTN","PSIVOPT",159,0)
 ;
"RTN","PSIVOPT",160,0)
VA200(X) ;Return the IEN for the user.
"RTN","PSIVOPT",161,0)
 ; X = User name
"RTN","PSIVOPT",162,0)
 NEW DIC,Y S DIC="^VA(200,",DIC(0)="NZ" D ^DIC
"RTN","PSIVOPT",163,0)
 I +Y=-1 Q ""
"RTN","PSIVOPT",164,0)
 Q $P(Y,U)
"RTN","PSIVORE")
0^13^B43371041
"RTN","PSIVORE",1,0)
PSIVORE ;BIR/PR,MLM-ORDER ENTRY ;1 APR 08 / 2:37 PM
"RTN","PSIVORE",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**18,29,50,56,58,81,110,127,133,157,203,213,181,252**;16 DEC 97;Build 69
"RTN","PSIVORE",3,0)
 ;
"RTN","PSIVORE",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIVORE",5,0)
 ; Reference to ^ORX2 is supported by DBIA #867
"RTN","PSIVORE",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVORE",7,0)
 ; Reference to ^DICN is supported by DBIA 10009.
"RTN","PSIVORE",8,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSIVORE",9,0)
 ; Reference to EN^VALM is supported by DBIA 10118.
"RTN","PSIVORE",10,0)
 ; Reference to ^VADPT is supported by DBIA 10061.
"RTN","PSIVORE",11,0)
 ;
"RTN","PSIVORE",12,0)
 N PSJNEW,PSJOUT,PSGPTMP,PPAGE,FLAG S PSJNEW=1
"RTN","PSIVORE",13,0)
 ;
"RTN","PSIVORE",14,0)
 D SITE Q:'$G(PSIVQ)  K PSIVQ S PSGOP=""
"RTN","PSIVORE",15,0)
 ;
"RTN","PSIVORE",16,0)
BEG ;Get patient and make sure he is living.
"RTN","PSIVORE",17,0)
 L +^PS(53.45,DUZ):1 E  D LOCKERR^PSJOE G Q
"RTN","PSIVORE",18,0)
 ;* F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  D ASK
"RTN","PSIVORE",19,0)
 ;* F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  S X=DFN_";DPT(" D LK^ORX2 Q:'Y  D ASK S X=DFN_";DPT(" D ULK^ORX2
"RTN","PSIVORE",20,0)
 NEW PSJLK
"RTN","PSIVORE",21,0)
 F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  S PSJLK='$$L^PSSLOCK(DFN,1) Q:PSJLK  D ASK,UL^PSSLOCK(DFN)
"RTN","PSIVORE",22,0)
 I PSGOP,$P(PSJSYSL,"^",2)]"" D ENQL^PSGLW
"RTN","PSIVORE",23,0)
 G Q
"RTN","PSIVORE",24,0)
 ;
"RTN","PSIVORE",25,0)
ASK ;See if patient has been admitted.
"RTN","PSIVORE",26,0)
 I VADM(6) W !?5,"Patient has died." Q
"RTN","PSIVORE",27,0)
 I 'VAIN(4) K DIK S DIR(0)="Y",DIR("A")="Do you wish to continue",DIR("B")="NO",DIR("??")="^S HELP=""ADMYN"" D ^PSIVHLP1" W !,"This patient has not been admitted." D ^DIR K DIR Q:'Y
"RTN","PSIVORE",28,0)
 S:VAIN(4) WSCHADM=+VAIN(4)
"RTN","PSIVORE",29,0)
 ;
"RTN","PSIVORE",30,0)
SETN ;Set up patient 0 node if needed.
"RTN","PSIVORE",31,0)
 I '$D(^PS(55,DFN,0)) K DO,DA,DD,DIC,PSIVFN S:$D(^(5.1)) PSIVFN=^(5.1) K:$D(PSIVFN) ^(5.1) S (DINUM,X)=DFN,DIC(0)="L",DIC="^PS(55," D FILE^DICN S:$D(PSIVFN) ^PS(55,DFN,5.1)=PSIVFN D  K DIC,PSIVFN,DO,DA,DD,DINUM
"RTN","PSIVORE",32,0)
 .; Mark PSJ and PSO as converted
"RTN","PSIVORE",33,0)
 .S $P(^PS(55,DFN,5.1),"^",11)=2
"RTN","PSIVORE",34,0)
 S PSJNARC=1
"RTN","PSIVORE",35,0)
 S PSGP=DFN,PSJPWD=+VAIN(4),PSIVAC="P",PSIVBR="D ^PSIVOPT" D HK,ENCHS1^PSIV Q:'$D(DFN)
"RTN","PSIVORE",36,0)
 Q
"RTN","PSIVORE",37,0)
 ;
"RTN","PSIVORE",38,0)
NEW ;Ask to enter new order.
"RTN","PSIVORE",39,0)
 D:'$D(VADM(1)) DEM^VADPT
"RTN","PSIVORE",40,0)
 K P,PSIVCHG,PSIVTYPE,PSJOE,DIR S DIR(0)="Y",DIR("A")="New order for "_VADM(1),DIR("B")="YES",DIR("??")="^S HELP=""NEWORD"" D ^PSIVHLP" D ^DIR K DIR Q:'Y
"RTN","PSIVORE",41,0)
 NEW X S X=DFN_";DPT(" D LK^ORX2 Q:'Y  S PSJLSORX=1
"RTN","PSIVORE",42,0)
INMED K ON55,PSJOUT S (P(4),P("OT"),P("FRES"))="" D NEW55^PSIVORFB I '$D(ON55) D ULK G:'$D(PSJOE)&('$D(PSJOUT)) NEW G Q
"RTN","PSIVORE",43,0)
 NEW PSJOCFG
"RTN","PSIVORE",44,0)
 S PSJOCFG="NEW OE IV"
"RTN","PSIVORE",45,0)
 S P("RES")="N",PSIVAC="PN",P("PON")=ON55,PSIVUP=+$$GTPCI^PSIVUTL D NEW^PSIVORE2 I $G(P(2))="" D DEL55^PSIVORE2 D ULK G:'$D(PSJOE) NEW Q
"RTN","PSIVORE",46,0)
 D OK L -^PS(55,DFN,"IV",+ON55) D ULK K PSJOCFG G:'$D(PSJOE) NEW
"RTN","PSIVORE",47,0)
 ;
"RTN","PSIVORE",48,0)
Q ; Kill and exit.
"RTN","PSIVORE",49,0)
 L:'$D(PSJOE) -^PS(53.45,DUZ) S PSJNKF=1 D Q^PSIV
"RTN","PSIVORE",50,0)
 K FIL,I1,ND,PC,PDM,PSGDT,PSGID,PSGLMT,PSGSI,PSJNARC,PSIVAC,PSIVCHG,PSIVUP,PSIVX,PSJOPC
"RTN","PSIVORE",51,0)
 Q
"RTN","PSIVORE",52,0)
 ;
"RTN","PSIVORE",53,0)
ULK ;
"RTN","PSIVORE",54,0)
 Q:'$G(PSJLSORX)  ;If NEW^PSIVORE did not lock, don't kill it here.
"RTN","PSIVORE",55,0)
 NEW X S X=DFN_";DPT(" D ULK^ORX2 K PSJLSORX
"RTN","PSIVORE",56,0)
 Q
"RTN","PSIVORE",57,0)
HK ;Queue job to print MAR labels generated for this patient.
"RTN","PSIVORE",58,0)
 I PSGOP,PSGOP'=DFN D
"RTN","PSIVORE",59,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSIVORE",60,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,U,2)]"" ENQL^PSGLW
"RTN","PSIVORE",61,0)
 S PSGOP=DFN
"RTN","PSIVORE",62,0)
 Q
"RTN","PSIVORE",63,0)
 ;
"RTN","PSIVORE",64,0)
SITE ;See if site parameters are ok.
"RTN","PSIVORE",65,0)
 K PSIVQ D ^PSIVXU Q:$D(XQUIT)
"RTN","PSIVORE",66,0)
 I '$D(PSIVSN)!('$D(PSIVSITE)) W $C(7),$C(7),!!,"You have no IV ROOM parameters ... PLEASE ... PLEASE ...",!,"Exit this package and reenter properly !!",!! Q
"RTN","PSIVORE",67,0)
 D ORPARM^PSIVOREN S PSIVQ=1
"RTN","PSIVORE",68,0)
 Q
"RTN","PSIVORE",69,0)
 ;
"RTN","PSIVORE",70,0)
OK ;Print example label, run order through checker, ask if it is ok.
"RTN","PSIVORE",71,0)
 S P16=0,PSIVEXAM=1,(PSIVNOL,PSIVCT)=1 D GTOT^PSIVUTL(P(4)) I $G(P("PD"))="" D GTPD^PSIVORE2
"RTN","PSIVORE",72,0)
 D ^PSIVCHK I $D(DUOUT) S X="^" G DOA
"RTN","PSIVORE",73,0)
 I ERR=1 S X="N" G BAD
"RTN","PSIVORE",74,0)
 W ! D ^PSIVORLB K PSIVEXAM S Y=P(2) W !,"Start date: " X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),?30," Stop date: " S Y=P(3) X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),!
"RTN","PSIVORE",75,0)
 ;PSJ*5*157 EFD for IVs
"RTN","PSIVORE",76,0)
 D EFDIV^PSJUTL($G(ZZND))
"RTN","PSIVORE",77,0)
 D:'$G(PSGORQF) IN^PSJOCDS($G(ON55),"IV","") I $G(PSGORQF) D DEL55 Q
"RTN","PSIVORE",78,0)
 W:$G(PSIVCHG) !,"*** This change will cause a new order to be created. ***"
"RTN","PSIVORE",79,0)
 I '$G(PSIVCOPY) G:PSIVAC["R" OK1 S X="Is this O.K.: ^"_$S(ERR:"NO",1:"YES")_"^^NO"_$S(ERR'=1:",YES",1:"") D ENQ^PSIV
"RTN","PSIVORE",80,0)
 S PSJIVBD=1 ;var use to indicate order enter from back door
"RTN","PSIVORE",81,0)
BAD ;; I X["N" D GSTRING^PSIVORE1,^PSIVORV2,GTFLDS^PSIVORFE G OK
"RTN","PSIVORE",82,0)
 I ON55["V",($G(P(21))="") S P(17)="N"
"RTN","PSIVORE",83,0)
 I X["N" NEW PSGEBN,PSGLI S (P("INS"),PSGEBN,PSGLI)="",(PSJORD,ON)=ON55 D EN^VALM("PSJ LM IV AC/EDIT") S VALMBCK="Q" Q
"RTN","PSIVORE",84,0)
 I X["?" S HELP="OK" D ^PSIVHLP G OK
"RTN","PSIVORE",85,0)
DOA I X["^" D DEL55^PSIVORE2 Q
"RTN","PSIVORE",86,0)
 Q:$$NONVF("SN")
"RTN","PSIVORE",87,0)
OK1 S PSJORL=$$ENORL^PSJUTL($G(VAIN(4))),P(17)="A",ORSTS=6,ON=ON55,PSJORNP=+P(6)
"RTN","PSIVORE",88,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN
"RTN","PSIVORE",89,0)
 I PSJIVORF D NATURE^PSIVOREN I '$D(P("NAT")) D DEL55^PSIVORE2 Q
"RTN","PSIVORE",90,0)
 D SET55^PSIVORFB
"RTN","PSIVORE",91,0)
 I PSJIVORF,($G(P(22))=.5) D CLINIC^PSIVOREN
"RTN","PSIVORE",92,0)
 I PSJIVORF D SET^PSIVORFE S ORNATR=P("NAT"),ON=+ON55,OD=P(2) D EN1^PSJHL2(DFN,"SN",+ON55_"V","SEND ORDER NUMBER") ;,EN1^PSJHL2(DFN,"SC",+ON55_"V","NEW ORDER CREATED")
"RTN","PSIVORE",93,0)
 D VF1^PSJLIACT("V","ORDER ENTERED AS ACTIVE BY ",1)
"RTN","PSIVORE",94,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"N")
"RTN","PSIVORE",95,0)
 ;
"RTN","PSIVORE",96,0)
CAL ;Calculate doses.
"RTN","PSIVORE",97,0)
 ;S OD=P(2) D EN,^PSIVORE1,^PSIVOPT
"RTN","PSIVORE",98,0)
 S OD=P(2) D EN,^PSIVOPT
"RTN","PSIVORE",99,0)
 Q
"RTN","PSIVORE",100,0)
 ;
"RTN","PSIVORE",101,0)
EN ;Update schedule interval P(15) only on continuous orders.
"RTN","PSIVORE",102,0)
 ;This includes Hyp/Adm/Continuous Syringes/Chemos =>P(5)=0
"RTN","PSIVORE",103,0)
 Q:'$D(DFN)!('$D(ON55))  Q:$P(^PS(55,DFN,"IV",+ON55,0),U,4)="P"!($P(^(0),U,5))!($P(^(0),U,23)="P")
"RTN","PSIVORE",104,0)
 D SPSOL S XXX=$P(^PS(55,DFN,"IV",+ON55,0),U,8) G:'SPSOL ENQ I XXX?1N.N.1".".N1" ml/hr"!(XXX?1"0."1N1" ml/hr") S P(15)=$S('XXX:0,1:SPSOL\XXX*60+(SPSOL#XXX/XXX*60+.5)\1),$P(^PS(55,DFN,"IV",+ON55,0),U,15)=P(15) G ENQ
"RTN","PSIVORE",105,0)
 S P(15)=$S('$P(XXX,"@",2):0,1:1440/$P(XXX,"@",2)\1),$P(^PS(55,DFN,"IV",+ON55,0),U,15)=P(15)
"RTN","PSIVORE",106,0)
ENQ K SPSOL,XXX Q
"RTN","PSIVORE",107,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(^PS(55,DFN,"IV",+ON55,"SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(^(XXX,0),U,2)
"RTN","PSIVORE",108,0)
 K XXX Q
"RTN","PSIVORE",109,0)
ENIN ;Entry for Combined IV/UD order entry. Called by PSJOE0.
"RTN","PSIVORE",110,0)
 D HOLDHDR^PSJOE
"RTN","PSIVORE",111,0)
 W !
"RTN","PSIVORE",112,0)
 N PSJOUT S (DONE,FLAG)=0,PSIVAC="PN"
"RTN","PSIVORE",113,0)
ENIN1 ;
"RTN","PSIVORE",114,0)
 N DA,DIR,PSJOE,PSJPCAF,PSJSYSL,WSCHADM,PSJALLGY S:$G(VAIN(4)) WSCHADM=VAIN(4)
"RTN","PSIVORE",115,0)
 K P,PSIVCHG,PSJCOM
"RTN","PSIVORE",116,0)
 S PSJOE=1,DIR(0)="55.01,.04O",DIR("A")="Select IV TYPE" D ^DIR
"RTN","PSIVORE",117,0)
 I X]"",X'="^",$P("^PROFILE",X)="" S PSJOEPF=X Q
"RTN","PSIVORE",118,0)
 S:$D(DTOUT) X="^" I "^"[X S PSJORQF=PSJORQF+$S(X="^":2,$G(FLAG):0,1:1),X="." Q
"RTN","PSIVORE",119,0)
 S FLAG=1,PSIVTYPE=Y,(P(5),P(23))="" I "SC"[Y D @(Y_"^PSIVORC1") S $P(PSIVTYPE,U,2)=P(23)
"RTN","PSIVORE",120,0)
 D INMED G:'$D(PSJOUT) ENIN S:$D(PSJOUT) PSJORQF=2
"RTN","PSIVORE",121,0)
 Q
"RTN","PSIVORE",122,0)
NONVF(PSJOC)  ;If file at NonVF then quit with 1
"RTN","PSIVORE",123,0)
 NEW PSGOEAV S PSGOEAV=+$P(PSJSYSP0,U,9)
"RTN","PSIVORE",124,0)
 I +PSJSYSU=3,PSGOEAV Q 0
"RTN","PSIVORE",125,0)
 I +PSJSYSU=1,PSGOEAV Q 0
"RTN","PSIVORE",126,0)
 K DA D ENGNN^PSGOETO S ON=DA_"P",P(17)="N",P("REN")=0
"RTN","PSIVORE",127,0)
 D GTPD^PSIVORE2
"RTN","PSIVORE",128,0)
 D NATURE^PSIVOREN I '$D(P("NAT")) D:ON55["V" DEL55 Q 1
"RTN","PSIVORE",129,0)
 D:$G(VAIN(4))="" CLINIC^PSIVOREN
"RTN","PSIVORE",130,0)
 W !,"...transcribing this non-verified order...."
"RTN","PSIVORE",131,0)
 D PUT531^PSIVORFA
"RTN","PSIVORE",132,0)
 D:$G(PSJOC)]"" EN1^PSJHL2(DFN,PSJOC,ON,"SEND ORDER NUMBER")
"RTN","PSIVORE",133,0)
 D:ON55["V" DEL55
"RTN","PSIVORE",134,0)
 NEW PSJORD S (ON55,PSJORD)=ON
"RTN","PSIVORE",135,0)
 D VF^PSIVORC2
"RTN","PSIVORE",136,0)
 Q 1
"RTN","PSIVORE",137,0)
DEL55 ;
"RTN","PSIVORE",138,0)
 Q:ON55["P"
"RTN","PSIVORE",139,0)
 S X=$G(^PS(55,DFN,"IV",+ON55,0))
"RTN","PSIVORE",140,0)
 I $P(X,U,21)]"",($G(^PS(55,DFN,"IV",+ON55,2))]"") S $P(^(2),U,6)=ON,$P(^PS(53.1,+ON,0),U,25)=ON55 Q
"RTN","PSIVORE",141,0)
 NEW PSIVORFA S PSIVORFA=1
"RTN","PSIVORE",142,0)
 D DEL55^PSIVORE2
"RTN","PSIVORE",143,0)
 Q 
"RTN","PSJAPIDS")
0^14^B34568784
"RTN","PSJAPIDS",1,0)
PSJAPIDS ;BIR/MV - API TO PROCESS DOSING ORDER CHECKS FOR IV ;6 Jun 07 / 3:37 PM
"RTN","PSJAPIDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSJAPIDS",3,0)
 ;
"RTN","PSJAPIDS",4,0)
 ; Reference to ^PSDRUG is supported by DBIA #2192.
"RTN","PSJAPIDS",5,0)
 ; Reference to ^PS(51.1 is supported by DBIA# 2177.
"RTN","PSJAPIDS",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJAPIDS",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJAPIDS",8,0)
 ; Reference to ^PSSDSAPI is supported by DBIA# 5425.
"RTN","PSJAPIDS",9,0)
 ; Reference to DRT^PSSDSAPD is supported by DBIA# 5617.
"RTN","PSJAPIDS",10,0)
 ; Reference to DOSE^PSSDSAPD is supported by DBIA# 5426.
"RTN","PSJAPIDS",11,0)
 ;
"RTN","PSJAPIDS",12,0)
DOSE(PSJBASE,DFN,PSJIV) ;
"RTN","PSJAPIDS",13,0)
 ;PSJBASE(1)=PSJBASE - Base1(Literal value for TMP global)- Required
"RTN","PSJAPIDS",14,0)
 ;PSJBASE(2)=PSJBASE1 - Base2(Literal value for Screened display TMP global)- Required
"RTN","PSJAPIDS",15,0)
 ;PSJDFN - Patient Internal Entry Number
"RTN","PSJAPIDS",16,0)
 ;PSJIV(Px) - See DBIA #5385...P4 can be "ALL", "See Comments", or bottle number(s)
"RTN","PSJAPIDS",17,0)
 ;PSJIV("TVOL_VOL") - Contains nUnit where n is # & Unit is either H,D,L,M, or DOSES
"RTN","PSJAPIDS",18,0)
 ;PSJIV(X,"OI_ERROR",OI Name) - OI ien ^ Pharm # ^ Enhance flag(use in ENHFLG sub routine)
"RTN","PSJAPIDS",19,0)
 NEW DRG,P,PSIVAS,PSIVNM,PSJDD,PSJFDB,PSJOCDS,PSIVTDUR,PSJTOTVL,X
"RTN","PSJAPIDS",20,0)
 I $$PING()=-1 D  Q
"RTN","PSJAPIDS",21,0)
 . F X=0:0 S X=$O(PSJBASE(X)) Q:'X  D
"RTN","PSJAPIDS",22,0)
 .. M ^TMP($J,PSJBASE(X),"OUT")=^TMP($J,"PSJPRE","OUT")
"RTN","PSJAPIDS",23,0)
 Q:$G(PSJIV("IV_TYPE"))=""
"RTN","PSJAPIDS",24,0)
 Q:'+$G(DFN)
"RTN","PSJAPIDS",25,0)
 S PSJTOTVL=0
"RTN","PSJAPIDS",26,0)
 F X=0:0 S X=$O(PSJBASE(X)) Q:'X  K:PSJBASE(X)]"" ^TMP($J,PSJBASE(1))
"RTN","PSJAPIDS",27,0)
 S P("DTYP")=+PSJIV("IV_TYPE")
"RTN","PSJAPIDS",28,0)
 S P("MR")=$G(PSJIV("MR_IEN"))
"RTN","PSJAPIDS",29,0)
 S P(8)=$G(PSJIV("INF_RATE"))
"RTN","PSJAPIDS",30,0)
 S P(9)=$G(PSJIV("SCHEDULE"))
"RTN","PSJAPIDS",31,0)
 ;Admin times and Freq are not available from CPRS
"RTN","PSJAPIDS",32,0)
 S P(11)=""
"RTN","PSJAPIDS",33,0)
 S P(15)=""
"RTN","PSJAPIDS",34,0)
 D SETDRG
"RTN","PSJAPIDS",35,0)
 S PSJIV("DUR")="",PSJIV("TOT_VOL")=""
"RTN","PSJAPIDS",36,0)
 I PSJIV("TVOL_DUR")]"" D
"RTN","PSJAPIDS",37,0)
 . S PSIVTDUR=$$UP^XLFSTR(PSJIV("TVOL_DUR"))
"RTN","PSJAPIDS",38,0)
 . I PSIVTDUR["M" S PSJIV("TOT_VOL")=+PSIVTDUR
"RTN","PSJAPIDS",39,0)
 . I PSIVTDUR["L" S PSJIV("TOT_VOL")=+PSIVTDUR*1000,PSIVTDUR=PSJIV("TOT_VOL")_"M"
"RTN","PSJAPIDS",40,0)
 . ;get dose count for intermittent
"RTN","PSJAPIDS",41,0)
 . I P("DTYP")=1 D DURATION(PSIVTDUR,P(9)) Q
"RTN","PSJAPIDS",42,0)
 . ;Convert PSJIV("DUR") to minutes
"RTN","PSJAPIDS",43,0)
 . I P("DTYP")=2,$S(PSIVTDUR["H":1,PSIVTDUR["D":1,1:0) S PSJIV("DUR")=$$DRT^PSSDSAPD(PSIVTDUR)
"RTN","PSJAPIDS",44,0)
 D IN^PSIVOCDS(PSJBASE(1))
"RTN","PSJAPIDS",45,0)
 D ENHFLG
"RTN","PSJAPIDS",46,0)
 I $$CHKDS() S PSJFDB("PACKAGE")="I" D DOSE^PSSDSAPD(.PSJBASE,DFN,.PSJOCDS,.PSJFDB)
"RTN","PSJAPIDS",47,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSJAPIDS",48,0)
 Q
"RTN","PSJAPIDS",49,0)
CHKDS() ;Check if dosing check should be performed
"RTN","PSJAPIDS",50,0)
 ;PSJFLG=1 means dosing check should be performed
"RTN","PSJAPIDS",51,0)
 NEW PSJX,PSJFLG
"RTN","PSJAPIDS",52,0)
 I $G(PSJFDB(1,"ENH"))=0 Q 1
"RTN","PSJAPIDS",53,0)
 S PSJFLG=0
"RTN","PSJAPIDS",54,0)
 F PSJX=0:0 S PSJX=$O(PSJFDB(PSJX)) Q:'PSJX  Q:PSJFLG  D
"RTN","PSJAPIDS",55,0)
 . I '$D(PSJFDB(PSJX,"OI_ERROR")) S PSJFLG=1 Q
"RTN","PSJAPIDS",56,0)
 . I +$G(PSJFDB(PSJX,"OI")),$$SETENH(1,+PSJFDB(PSJX,"OI")) S PSJFLG=1
"RTN","PSJAPIDS",57,0)
 Q PSJFLG
"RTN","PSJAPIDS",58,0)
SETDRG ;
"RTN","PSJAPIDS",59,0)
 NEW PSIVX,PSIVX0,PSJDD,PSGDT,PSJCNT,%
"RTN","PSJAPIDS",60,0)
 D NOW^%DTC S PSGDT=%
"RTN","PSJAPIDS",61,0)
 F PSIVAS="AD","SOL" S PSJCNT=0 F PSIVX=0:0 S PSIVX=$O(PSJIV(PSIVAS,PSIVX)) Q:'PSIVX  D
"RTN","PSJAPIDS",62,0)
 .S PSIVX0=$G(PSJIV(PSIVAS,PSIVX))
"RTN","PSJAPIDS",63,0)
 .D:PSIVAS="AD" SETAD(+PSIVX0,$P(PSIVX0,U,2),$P(PSIVX0,U,5))
"RTN","PSJAPIDS",64,0)
 .D:PSIVAS="SOL" SETSOL(+PSIVX0,$P(PSIVX0,U,2),$P(PSIVX0,U,5))
"RTN","PSJAPIDS",65,0)
 Q
"RTN","PSJAPIDS",66,0)
SETAD(PSJOI,PSJOINM,PSJFLG) ;Check if additive is active then set the DRG array
"RTN","PSJAPIDS",67,0)
 ;PSJOI - 50.7 ien
"RTN","PSJAPIDS",68,0)
 ;PSJOINM - CPRS OI name
"RTN","PSJAPIDS",69,0)
 ;PSJFLG - 1 if the Enhanced order checks were done.  0 if not.
"RTN","PSJAPIDS",70,0)
 Q:'+$G(PSJOI)
"RTN","PSJAPIDS",71,0)
 NEW PSJOK,PSIVIEN,PSJINACT
"RTN","PSJAPIDS",72,0)
 S PSJOK=0
"RTN","PSJAPIDS",73,0)
 F PSIVIEN=0:0 S PSIVIEN=$O(^PS(52.6,"AOI",PSJOI,PSIVIEN)) Q:'PSIVIEN  Q:PSJOK  D
"RTN","PSJAPIDS",74,0)
 . S PSJINACT=$G(^PS(52.6,PSIVIEN,"I"))
"RTN","PSJAPIDS",75,0)
 . I PSJINACT]"",(PSJINACT'>PSGDT) Q
"RTN","PSJAPIDS",76,0)
 . I $G(^PS(52.6,PSIVIEN,0))]"" D
"RTN","PSJAPIDS",77,0)
 .. S PSJOK=1
"RTN","PSJAPIDS",78,0)
 .. S PSJCNT=PSJCNT+1
"RTN","PSJAPIDS",79,0)
 .. S DRG("AD",PSJCNT)=PSIVIEN_U_$P(PSIVX0,U,2)_U_$P(PSIVX0,U,3)_U_$S('+$P(PSIVX0,U,4):"",1:$P(PSIVX0,U,4))
"RTN","PSJAPIDS",80,0)
 .. S PSJDD=+$$IVDDRG^PSJMISC("AD",PSIVIEN)
"RTN","PSJAPIDS",81,0)
 .. S:+PSJDD PSJIV("DRG",PSJDD)=+$G(PSJFLG)
"RTN","PSJAPIDS",82,0)
 ;I 'PSJOK,($G(PSJOINM)]"") S PSJIV("OI_ERROR",PSJOINM)=4_U_PSJOI_U_$$SETENH($G(PSJFLG),PSJOI)
"RTN","PSJAPIDS",83,0)
 I 'PSJOK,($G(PSJOINM)]"") S PSJIV("OI_ERROR",PSJOINM)=4_U_PSJOI_U_1
"RTN","PSJAPIDS",84,0)
 Q
"RTN","PSJAPIDS",85,0)
SETSOL(PSJOI,PSJOINM,PSJFLG) ;Check if solution is active then set then DRG array
"RTN","PSJAPIDS",86,0)
 ;PSJOI - 50.7 ien
"RTN","PSJAPIDS",87,0)
 ;PSJOINM - CPRS OI name
"RTN","PSJAPIDS",88,0)
 ;PSJFLG - 1 if the Enhanced order checks were done.  0 if not.
"RTN","PSJAPIDS",89,0)
 Q:'+$G(PSJOI)
"RTN","PSJAPIDS",90,0)
 NEW PSJOK,PSIVIEN,PSJINACT,PSJPREMX
"RTN","PSJAPIDS",91,0)
 S PSJOK=0,PSJPREMX=0
"RTN","PSJAPIDS",92,0)
 F PSIVIEN=0:0 S PSIVIEN=$O(^PS(52.7,"AOI",PSJOI,PSIVIEN)) Q:'PSIVIEN  Q:PSJOK  D
"RTN","PSJAPIDS",93,0)
 . I '+$P($G(^PS(52.7,+PSIVIEN,0)),U,2) Q
"RTN","PSJAPIDS",94,0)
 . S PSJINACT=$G(^PS(52.7,PSIVIEN,"I"))
"RTN","PSJAPIDS",95,0)
 . I PSJINACT]"",(PSJINACT'>PSGDT) Q
"RTN","PSJAPIDS",96,0)
 . I '$$PREMIX^PSJMISC(+PSIVIEN) S PSJPREMX=1
"RTN","PSJAPIDS",97,0)
 . I $G(^PS(52.7,PSIVIEN,0))]"" D
"RTN","PSJAPIDS",98,0)
 .. S PSJOK=1
"RTN","PSJAPIDS",99,0)
 .. S PSJCNT=PSJCNT+1
"RTN","PSJAPIDS",100,0)
 .. S DRG("SOL",PSJCNT)=PSIVIEN_U_$P(PSIVX0,U,2)_U_$P(PSIVX0,U,3)
"RTN","PSJAPIDS",101,0)
 .. S PSJTOTVL=PSJTOTVL+(+$P(PSIVX0,U,3))
"RTN","PSJAPIDS",102,0)
 .. S PSJDD=+$$IVDDRG^PSJMISC("SOL",PSIVIEN)
"RTN","PSJAPIDS",103,0)
 .. S:+PSJDD PSJIV("DRG",PSJDD)=+$G(PSJFLG)
"RTN","PSJAPIDS",104,0)
 ;I 'PSJOK,($G(PSJOINM)]"") S PSJIV("OI_ERROR",PSJOINM)=4_U_PSJOI_U_$$SETENH($G(PSJFLG),PSJOI)
"RTN","PSJAPIDS",105,0)
 I 'PSJOK,($G(PSJOINM)]"") S PSJIV("OI_ERROR",PSJOINM)=4_U_PSJOI_U_1
"RTN","PSJAPIDS",106,0)
 Q
"RTN","PSJAPIDS",107,0)
SETENH(PSJFLG,PSJOI) ;Reset PSJFLG to 0 only if GCN message is needed for the dosing check
"RTN","PSJAPIDS",108,0)
 NEW PSJDD
"RTN","PSJAPIDS",109,0)
 I '+$D(PSJFLG) Q 0
"RTN","PSJAPIDS",110,0)
 I PSJFLG=0 Q 0
"RTN","PSJAPIDS",111,0)
 I '+$G(PSJOI) Q PSJFLG
"RTN","PSJAPIDS",112,0)
 ;If PSJFLG=1 (CPRS did DI & DT) then check if no GCN for any of the DDs tie to OI then reset PSJFLG=0 to signal PDM
"RTN","PSJAPIDS",113,0)
 ; to get the check done for the OI error.
"RTN","PSJAPIDS",114,0)
 S PSJDDFLG=0
"RTN","PSJAPIDS",115,0)
 F PSJDD=0:0 S PSJDD=$O(^PSDRUG("ASP",PSJOI,PSJDD)) Q:'PSJDD  Q:PSJDDFLG  D
"RTN","PSJAPIDS",116,0)
 . I +$$GCN^PSJMISC(PSJDD) S PSJDDFLG=1 Q
"RTN","PSJAPIDS",117,0)
 Q PSJDDFLG
"RTN","PSJAPIDS",118,0)
ENHFLG ;Set the enhance flag so dosing error message won't display if enhance OC already displayed.
"RTN","PSJAPIDS",119,0)
 NEW PSJX,PSJOINM
"RTN","PSJAPIDS",120,0)
 F PSJX=0:0 S PSJX=$O(PSJFDB(PSJX)) Q:'PSJX  D
"RTN","PSJAPIDS",121,0)
 . ;If "OI_ERROR" existed than set the "ENH" flag for that PSJX set
"RTN","PSJAPIDS",122,0)
 . S PSJOINM=$O(PSJFDB(PSJX,"OI_ERROR",""))
"RTN","PSJAPIDS",123,0)
 . I PSJOINM]"" D  Q
"RTN","PSJAPIDS",124,0)
 .. S PSJFDB(PSJX,"ENH")=$P($G(PSJIV("OI_ERROR",PSJOINM)),U,3)
"RTN","PSJAPIDS",125,0)
 . I '$D(PSJFDB(PSJX,"DRUG_IEN")) Q
"RTN","PSJAPIDS",126,0)
 . S PSJFDB(PSJX,"ENH")=+$G(PSJIV("DRG",+PSJFDB(PSJX,"DRUG_IEN")))
"RTN","PSJAPIDS",127,0)
 Q
"RTN","PSJAPIDS",128,0)
DURATION(PSJDUR,PSJSCH) ;Figure out date dose limit send by CPRS
"RTN","PSJAPIDS",129,0)
 ;Set PSJIV("DOSE_CNT") only for duration < 24 hrs & set PSJIV("DUR") to # minutes specified in the duration field
"RTN","PSJAPIDS",130,0)
 NEW PSJDOW,PSJCNT,PSJDUR1,PSJCNT1
"RTN","PSJAPIDS",131,0)
 I $G(PSJDUR)="" Q
"RTN","PSJAPIDS",132,0)
 I $G(PSJSCH)="" Q
"RTN","PSJAPIDS",133,0)
 S PSJDUR1=0,PSJCNT1=""
"RTN","PSJAPIDS",134,0)
 S PSJDOW=$$DOW(PSJSCH)
"RTN","PSJAPIDS",135,0)
 ; PSJDUR1 - Duration in minutes (#_M)
"RTN","PSJAPIDS",136,0)
 I $S(PSJDUR["DOSES":0,PSJDUR["H":1,PSJDUR["D":1,1:0) S PSJDUR1=$$DRT^PSSDSAPD(PSJDUR)_"M" S PSJIV("DUR")=+PSJDUR1
"RTN","PSJAPIDS",137,0)
 ;
"RTN","PSJAPIDS",138,0)
 S PSJCNT=$$FRQ^PSSDSAPI(PSJSCH,PSJDOW,"I",PSJDUR1)
"RTN","PSJAPIDS",139,0)
 ; PSJCNT1 - Dose count from Duration
"RTN","PSJAPIDS",140,0)
 I PSJDUR["DOSES" S PSJCNT1=+PSJDUR
"RTN","PSJAPIDS",141,0)
 I PSJDUR["M" D
"RTN","PSJAPIDS",142,0)
 . I '+$G(PSJTOTVL) S PSJIV("FRQ_ERROR")="" Q
"RTN","PSJAPIDS",143,0)
 . I +PSJDUR>(PSJTOTVL*(+$P(PSJCNT,U,2))) S PSJIV("DUR")=""
"RTN","PSJAPIDS",144,0)
 . S PSJCNT1=(+PSJDUR)/PSJTOTVL
"RTN","PSJAPIDS",145,0)
 ; Set dose count to the less between Duration or schedule
"RTN","PSJAPIDS",146,0)
 I PSJCNT1,(PSJCNT1<+PSJCNT) D
"RTN","PSJAPIDS",147,0)
 . I PSJCNT1'=$J(PSJCNT1,"",0) S PSJIV("FRQ_ERROR")="" Q
"RTN","PSJAPIDS",148,0)
 . S PSJIV("DOSE_CNT")=PSJCNT1
"RTN","PSJAPIDS",149,0)
 . S:+$P(PSJCNT,U,2) PSJIV("DUR")=(1440/$P(PSJCNT,U,2))*PSJCNT1
"RTN","PSJAPIDS",150,0)
 ; Set dose count for duration in day/hour
"RTN","PSJAPIDS",151,0)
 I +PSJDUR1,($P(PSJCNT,U)<$P(PSJCNT,U,2)) S PSJIV("DOSE_CNT")=+PSJCNT
"RTN","PSJAPIDS",152,0)
 Q
"RTN","PSJAPIDS",153,0)
DOW(PSJSCH) ;Check if Schedule is a date of week
"RTN","PSJAPIDS",154,0)
 ;Return "D" if date of week
"RTN","PSJAPIDS",155,0)
 NEW PSJSCHNO,PSJDOW,PSJFOUND
"RTN","PSJAPIDS",156,0)
 I $G(PSJSCH)="" Q ""
"RTN","PSJAPIDS",157,0)
 S PSJDOW=0,PSJFOUND=0
"RTN","PSJAPIDS",158,0)
 F PSJSCHNO=0:0 S PSJSCHNO=$O(^PS(51.1,"APPSJ",PSJSCH,PSJSCHNO)) Q:'PSJSCHNO!(PSJDOW)  D
"RTN","PSJAPIDS",159,0)
 .I $P($G(^PS(51.1,PSJSCHNO,0)),"^",5)="D" S PSJDOW=1
"RTN","PSJAPIDS",160,0)
 .I $D(^PS(51.1,PSJSCHNO,0)) S PSJFOUND=1
"RTN","PSJAPIDS",161,0)
 I PSJDOW Q "D"
"RTN","PSJAPIDS",162,0)
 I PSJFOUND Q ""
"RTN","PSJAPIDS",163,0)
 I PSJSCH["@" Q "D"
"RTN","PSJAPIDS",164,0)
 Q ""
"RTN","PSJAPIDS",165,0)
PING() ;Return -1 if the system is down.
"RTN","PSJAPIDS",166,0)
 S ^TMP($J,"PSJPRE","IN","PING")=""
"RTN","PSJAPIDS",167,0)
 D IN^PSSHRQ2("PSJPRE")
"RTN","PSJAPIDS",168,0)
 Q +$G(^TMP($J,"PSJPRE","OUT",0))
"RTN","PSJBLDOC")
0^33^B27080671
"RTN","PSJBLDOC",1,0)
PSJBLDOC ;BIR/MV - API to build ^TMP for prospective and PSJ profile drugs ;03 Aug 98 / 8:42 AM
"RTN","PSJBLDOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,263,252**;16 DEC 97;Build 69
"RTN","PSJBLDOC",3,0)
 ;
"RTN","PSJBLDOC",4,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJBLDOC",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJBLDOC",6,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBLDOC",7,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJBLDOC",8,0)
 ; Reference to ^PSSDSAPM is supported by DBIA# 5570.
"RTN","PSJBLDOC",9,0)
 ;
"RTN","PSJBLDOC",10,0)
IN(DFN,LIST,PDRG,PTYP) ;
"RTN","PSJBLDOC",11,0)
 ;Build the IPM profiles and the prospective drugs list for both PSO & PSJ if PDRG is passed in.
"RTN","PSJBLDOC",12,0)
 ;DFN - PATIENT DFN
"RTN","PSJBLDOC",13,0)
 ;LIST - BASE
"RTN","PSJBLDOC",14,0)
 ;PDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSJBLDOC",15,0)
 ;       Where n is a sequential number.  Drug name can be OI, Generic name from #50 or Additive/sol name
"RTN","PSJBLDOC",16,0)
 ;PTYP - P1;P2 where P1="I" for Inpatient & "O" for Outpatient, P2= PSJ order#
"RTN","PSJBLDOC",17,0)
 NEW PSJONCNT,PSJDCNT,PSJDRGND,PSJWON
"RTN","PSJBLDOC",18,0)
 S PSJONCNT=0
"RTN","PSJBLDOC",19,0)
 S PSJWON=$P($G(PTYP),";",2)
"RTN","PSJBLDOC",20,0)
 D PROFILE(DFN,PSJWON)
"RTN","PSJBLDOC",21,0)
 Q
"RTN","PSJBLDOC",22,0)
PROFILE(DFN,PSJWON)     ;Setup ^TMP for the active meds to be on the OC profile list.
"RTN","PSJBLDOC",23,0)
 ;DFN:    Patient internal entry number
"RTN","PSJBLDOC",24,0)
 ;PSJWON: The current order number being working on.  It can be null.
"RTN","PSJBLDOC",25,0)
 ;        It is the order being work on (RN, FN..) and should be on the prospective list.
"RTN","PSJBLDOC",26,0)
 ;Output: ^TMP($J,"ORDERS",PSJINX)=DRUG CLASS^NATIONAL DRUG FILE ENTRY
"RTN","PSJBLDOC",27,0)
 ;        _"A"_PSNDFA PRODUCT NAME ENTRY_DISPENSE DRUG NAME^OE/RR #
"RTN","PSJBLDOC",28,0)
 ;        _ORDER NUMBER(P/I/V)_";I"
"RTN","PSJBLDOC",29,0)
 ;
"RTN","PSJBLDOC",30,0)
 NEW BDT,COD,DDRUG,DDRUGND,EDT,F,ON,ON1,PST,WBDT,X,PSJORIEN,%
"RTN","PSJBLDOC",31,0)
 S PSJWON=$G(PSJWON)
"RTN","PSJBLDOC",32,0)
 D NOW^%DTC S (BDT,WBDT)=%,EDT=9999999
"RTN","PSJBLDOC",33,0)
 S F="^PS(55,DFN,5," F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  S COD=ON_"U" D:COD'=PSJWON UD
"RTN","PSJBLDOC",34,0)
 S F="^PS(53.1," F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  D
"RTN","PSJBLDOC",35,0)
 . S COD=ON_"P" Q:COD=PSJWON
"RTN","PSJBLDOC",36,0)
 . I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",37,0)
 . I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) D PIV Q
"RTN","PSJBLDOC",38,0)
 . D UD
"RTN","PSJBLDOC",39,0)
 S WBDT=BDT F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  S COD=ON_"V" D:COD'=PSJWON IV
"RTN","PSJBLDOC",40,0)
 K PSJWON
"RTN","PSJBLDOC",41,0)
 Q
"RTN","PSJBLDOC",42,0)
UD ;Get the dispense drugs for the Unit Dose orders.
"RTN","PSJBLDOC",43,0)
 NEW X,PSJQUIT,PSJCNT,DDRUG,DDRUGN,PSJX,PSJOI,PSJEXPDD
"RTN","PSJBLDOC",44,0)
 S X=@(F_ON_",0)")
"RTN","PSJBLDOC",45,0)
 Q:$P(X,U,9)="R"
"RTN","PSJBLDOC",46,0)
 Q:$P(X,U,9)="D"
"RTN","PSJBLDOC",47,0)
 Q:$P(X,U,9)="E"
"RTN","PSJBLDOC",48,0)
 S PSJORIEN=$P(X,U,21),DDRUG=0
"RTN","PSJBLDOC",49,0)
 ;
"RTN","PSJBLDOC",50,0)
 ;Use the first active DD within the order. If >1 DD, use OI_Dosage form for display name
"RTN","PSJBLDOC",51,0)
 S ON1=0,PSJCNT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'ON1  S PSJCNT=PSJCNT+1
"RTN","PSJBLDOC",52,0)
 S PSJOI=+$G(@(F_ON_",.2)"))
"RTN","PSJBLDOC",53,0)
 S ON1=0,PSJQUIT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'+ON1!PSJQUIT  S DDRUG=@(F_ON_",1,"_ON1_",0)") D
"RTN","PSJBLDOC",54,0)
 . Q:'+DDRUG
"RTN","PSJBLDOC",55,0)
 . S PSJX=$P(DDRUG,U,3)
"RTN","PSJBLDOC",56,0)
 . I PSJX]"",(PSJX'>BDT) Q
"RTN","PSJBLDOC",57,0)
 . D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD) S PSJQUIT=1
"RTN","PSJBLDOC",58,0)
 ;Quit when an active DD within the order if found
"RTN","PSJBLDOC",59,0)
 Q:+$G(PSJQUIT)
"RTN","PSJBLDOC",60,0)
 ;
"RTN","PSJBLDOC",61,0)
 ;No DD found from the order. Get one from the OI
"RTN","PSJBLDOC",62,0)
 I '+PSJOI D SETIN("PROFILE","NOT FOUND: "_COD,"",COD,1) Q
"RTN","PSJBLDOC",63,0)
 S DDRUG=$P($$DRG^PSSDSAPM(+PSJOI,"I"),U)
"RTN","PSJBLDOC",64,0)
 I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD) Q
"RTN","PSJBLDOC",65,0)
 ;
"RTN","PSJBLDOC",66,0)
 ;Get the first DD from OI (CCR5665 - set exception if pending order has no DD assigned and none is active. PSJ*5*252 t9)
"RTN","PSJBLDOC",67,0)
 I ($G(COD)'["P"),('+DDRUG) S DDRUG=$O(^PSDRUG("ASP",PSJOI,0)) I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD) Q
"RTN","PSJBLDOC",68,0)
 ;
"RTN","PSJBLDOC",69,0)
 ;Set exception when no DD found
"RTN","PSJBLDOC",70,0)
 I '+DDRUG D SETIN("PROFILE",$$OIDF^PSJLMUT1(+$G(PSJOI)),"",COD,1) Q
"RTN","PSJBLDOC",71,0)
 Q
"RTN","PSJBLDOC",72,0)
PIV ;Get the dispense drugs for the Pending IV orders.
"RTN","PSJBLDOC",73,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM
"RTN","PSJBLDOC",74,0)
 S PSJX=^PS(53.1,+ON,0),PSJORIEN=$P(PSJX,U,21) Q:$P(PSJX,U,27)="R"
"RTN","PSJBLDOC",75,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",76,0)
 . S PSJX=^PS(53.1,+ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",77,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",78,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4) Q
"RTN","PSJBLDOC",79,0)
 . D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD)
"RTN","PSJBLDOC",80,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",81,0)
 . S PSJX=^PS(53.1,+ON,"SOL",ON1,0) D
"RTN","PSJBLDOC",82,0)
 . I $$PREMIX^PSJMISC(+PSJX) D
"RTN","PSJBLDOC",83,0)
 .. S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",84,0)
 .. S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",85,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4) Q
"RTN","PSJBLDOC",86,0)
 .. D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD)
"RTN","PSJBLDOC",87,0)
 Q
"RTN","PSJBLDOC",88,0)
IV ;Get the dispense drugs for the IV orders.
"RTN","PSJBLDOC",89,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM
"RTN","PSJBLDOC",90,0)
 S PSJX=^PS(55,DFN,"IV",ON,0),PSJORIEN=$P(PSJX,U,21)
"RTN","PSJBLDOC",91,0)
 Q:$P(PSJX,U,17)="R"
"RTN","PSJBLDOC",92,0)
 Q:$P(PSJX,U,17)="D"
"RTN","PSJBLDOC",93,0)
 Q:$P(PSJX,U,17)="E"
"RTN","PSJBLDOC",94,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",95,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",96,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",97,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4) Q
"RTN","PSJBLDOC",98,0)
 . D SETIN("PROFILE",PSJNM,DDRUG,COD)
"RTN","PSJBLDOC",99,0)
 ; Only include Pre-mix in the OC.
"RTN","PSJBLDOC",100,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",101,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"SOL",ON1,0)
"RTN","PSJBLDOC",102,0)
 . I $$PREMIX^PSJMISC(+PSJX) D
"RTN","PSJBLDOC",103,0)
 .. S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",104,0)
 .. S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",105,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4) Q
"RTN","PSJBLDOC",106,0)
 .. D SETIN("PROFILE",PSJNM,DDRUG,COD)
"RTN","PSJBLDOC",107,0)
 Q
"RTN","PSJBLDOC",108,0)
SETIN(PSJFLG,PSJNM,DDRUG,ON,PSJCODE) ;Set ^TMP($J,"PSJPRE,"IN" arrays.
"RTN","PSJBLDOC",109,0)
 ;ON = ON with "U/V/P"
"RTN","PSJBLDOC",110,0)
 ;PSJFLG = "PROSPECTIVE" or "PROFILE"
"RTN","PSJBLDOC",111,0)
 ;PSJNM = This should be the AD/SOL print name or IV order.  Use Dispense drug name if U/D order
"RTN","PSJBLDOC",112,0)
 ;PSJPON = 4 piece pharmacy order #
"RTN","PSJBLDOC",113,0)
 NEW PSJPON
"RTN","PSJBLDOC",114,0)
 Q:$G(PSJFLG)=""
"RTN","PSJBLDOC",115,0)
 S PSJONCNT=$G(PSJONCNT)+1
"RTN","PSJBLDOC",116,0)
 S PSJPON="I;"_ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",117,0)
 I '+$G(DDRUG) D  Q
"RTN","PSJBLDOC",118,0)
 . I +$G(PSJCODE) D NODD($G(PSJCODE),PSJNM,PSJPON,LIST)
"RTN","PSJBLDOC",119,0)
 Q:$$SUP^PSSDSAPI(+DDRUG)
"RTN","PSJBLDOC",120,0)
 I $G(PSJNM)="" S PSJNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",121,0)
 S ^TMP($J,LIST,"IN",PSJFLG,PSJPON)=+$$GCN^PSJMISC(+DDRUG)_U_$$GTVUID^PSJMISC(+DDRUG)_U_+DDRUG_U_PSJNM_U_$G(PSJORIEN)_U_"I"
"RTN","PSJBLDOC",122,0)
 Q
"RTN","PSJBLDOC",123,0)
IV0(PSJAD,PSIVIEN) ;Return ad/sol zero node
"RTN","PSJBLDOC",124,0)
 ;PSJAD = "AD" is passed in if it additive, otherwise it's null
"RTN","PSJBLDOC",125,0)
 I PSJAD="AD" Q $G(^PS(52.6,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",126,0)
 I $G(PSJAD)="" Q $G(^PS(52.7,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",127,0)
 Q ""
"RTN","PSJBLDOC",128,0)
NODD(PSJCODE,PSJOIDF,PSJPON,PSJBASE) ;Set ^TMP for OI without a dispense drug
"RTN","PSJBLDOC",129,0)
 ;PSJCODE - A numeric code to trigger the appropriate exception message 
"RTN","PSJBLDOC",130,0)
 ;PSJOIDF - Orderable Item name_Dose form (can be CPRS OI)
"RTN","PSJBLDOC",131,0)
 ;PSJPON - Pharmacy order #
"RTN","PSJBLDOC",132,0)
 ;PSJBASE - Base subscript
"RTN","PSJBLDOC",133,0)
 Q:$G(PSJOIDF)=""
"RTN","PSJBLDOC",134,0)
 Q:$G(PSJBASE)=""
"RTN","PSJBLDOC",135,0)
 Q:'+$G(PSJCODE)
"RTN","PSJBLDOC",136,0)
 ;S PSJIV("OI_ERROR",PSJOIDF)=$G(PSJCODE)_U_$G(PSJPON)
"RTN","PSJBLDOC",137,0)
 S ^TMP($J,PSJBASE,"IN","EXCEPTIONS","OI",PSJOIDF)=PSJCODE_U_$G(PSJPON)
"RTN","PSJBLDOC",138,0)
 Q
"RTN","PSJGMRA")
0^29^B22580264
"RTN","PSJGMRA",1,0)
PSJGMRA ;BIR/MV - Retrieve and display Allergy data ;6 Jun 07 / 3:37 PM
"RTN","PSJGMRA",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,270,252**;16 DEC 97;Build 69
"RTN","PSJGMRA",3,0)
 ;
"RTN","PSJGMRA",4,0)
 ; Reference to ^PS(50.605 is supported by DBIA 696.
"RTN","PSJGMRA",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSJGMRA",6,0)
 ; Reference to ^TMP("GMRAOC" supported by DBIA 4848.
"RTN","PSJGMRA",7,0)
 ; Reference to GETDATA^GMRAOR supported by DBIA 4847.
"RTN","PSJGMRA",8,0)
 ;
"RTN","PSJGMRA",9,0)
EN(DFN,PSJDD) ;
"RTN","PSJGMRA",10,0)
 ;DFN - Patient IEN
"RTN","PSJGMRA",11,0)
 ;PSJDD - ^PSDRUG IEN
"RTN","PSJGMRA",12,0)
 NEW PTR,GMRAING,PSJACK,PSJCLCNT,PSJFLG,PSJVACL,DIW,DIWF,DIWI,DIWL,DIWR,DIWT,DIWTC,DIWX,PSJNEW
"RTN","PSJGMRA",13,0)
 Q:'+$G(DFN)
"RTN","PSJGMRA",14,0)
 Q:'+$G(PSJDD)
"RTN","PSJGMRA",15,0)
 K ^TMP("GMRAOC",$J),^TMP($J,"PSJCLS"),PSJVACL
"RTN","PSJGMRA",16,0)
 S PSJACK=0
"RTN","PSJGMRA",17,0)
 S PTR=$P($G(^PSDRUG(PSJDD,"ND")),U)_"."_$P($G(^PSDRUG(PSJDD,"ND")),U,3)
"RTN","PSJGMRA",18,0)
 I +PTR S PSJACK=$$NDF()
"RTN","PSJGMRA",19,0)
 S PSJCLCNT=$$CLASS()
"RTN","PSJGMRA",20,0)
 D DISP
"RTN","PSJGMRA",21,0)
 K ^TMP("GMRAOC",$J),^TMP($J,"PSJCLS")
"RTN","PSJGMRA",22,0)
 Q
"RTN","PSJGMRA",23,0)
NDF() ;Process NDF drug
"RTN","PSJGMRA",24,0)
 NEW PSJLP
"RTN","PSJGMRA",25,0)
 S PSJACK=0
"RTN","PSJGMRA",26,0)
 K ^TMP("GMRAOC",$J)
"RTN","PSJGMRA",27,0)
 S PSJACK=$$ORCHK^GMRAOR(DFN,"DR",PTR)
"RTN","PSJGMRA",28,0)
 Q PSJACK
"RTN","PSJGMRA",29,0)
CLASS() ;
"RTN","PSJGMRA",30,0)
 NEW PSJLEN,PSJLOC,PSJCLCHK,PSJCLNM,PSJDDCL,INVCL,INVCNT
"RTN","PSJGMRA",31,0)
 S PSJDDCL=$P($G(^PSDRUG(+PSJDD,0)),U,2)
"RTN","PSJGMRA",32,0)
 S PSJLEN=4,PSJCLCNT=0
"RTN","PSJGMRA",33,0)
 I $E(PSJDDCL,1,4)="CN10" S PSJLEN=5 ;look at 5 chars if ANALGESICS
"RTN","PSJGMRA",34,0)
 ;
"RTN","PSJGMRA",35,0)
 K GMRADRCL,^TMP("GMRAOC",$J,"APC"),^TMP($J,"PSJCLS")
"RTN","PSJGMRA",36,0)
 D GETDATA^GMRAOR(DFN)
"RTN","PSJGMRA",37,0)
 I '$D(^TMP("GMRAOC",$J,"APC")) Q 0
"RTN","PSJGMRA",38,0)
 ;
"RTN","PSJGMRA",39,0)
 S PSJVACL="" F  S PSJVACL=$O(^TMP("GMRAOC",$J,"APC",PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",40,0)
 .;*PSJ*5*270 - Check for invalid drug class, print warning message
"RTN","PSJGMRA",41,0)
 . S PSJLOC=^TMP("GMRAOC",$J,"APC",PSJVACL),PSJCLNM=$P($G(^PS(50.605,+$O(^PS(50.605,"B",PSJVACL,0)),0)),U,2)
"RTN","PSJGMRA",42,0)
 . I $G(PSJCLNM)="" S INVCL(PSJVACL)="" Q
"RTN","PSJGMRA",43,0)
 . S PSJVACL(PSJVACL)=PSJVACL_U_PSJCLNM_" ("_PSJLOC_")"
"RTN","PSJGMRA",44,0)
 . S PSJCLCNT=PSJCLCNT+1
"RTN","PSJGMRA",45,0)
 I $D(INVCL) D
"RTN","PSJGMRA",46,0)
 . W $C(7),!!,"WARNING: The following drug class does not exist in the VA DRUG CLASS file",!
"RTN","PSJGMRA",47,0)
 . W "         (#50.605).  Please do a manual Drug-Allergy order check and notify",!
"RTN","PSJGMRA",48,0)
 . W "         the pharmacy ADPAC for follow up.",!
"RTN","PSJGMRA",49,0)
 . S INVCNT="" F  S INVCNT=$O(INVCL(INVCNT)) Q:INVCNT=""  W !,"VA Drug Class: ",INVCNT
"RTN","PSJGMRA",50,0)
 . W ! S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR W !
"RTN","PSJGMRA",51,0)
 ;
"RTN","PSJGMRA",52,0)
 S PSJCLCHK=0,PSJVACL="" F  S PSJVACL=$O(PSJVACL(PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",53,0)
 .I $E(PSJDDCL,1,PSJLEN)=$E(PSJVACL,1,PSJLEN) D
"RTN","PSJGMRA",54,0)
 .. S PSJCLCHK=PSJCLCHK+1
"RTN","PSJGMRA",55,0)
 .. S ^TMP($J,"PSJCLS",PSJCLCHK)=PSJVACL_" "_$P(PSJVACL(PSJVACL),"^",2)
"RTN","PSJGMRA",56,0)
 K ^TMP("GMRAOC",$J)
"RTN","PSJGMRA",57,0)
 Q PSJCLCHK
"RTN","PSJGMRA",58,0)
DISP ;
"RTN","PSJGMRA",59,0)
 NEW PSJLOC,PSJNIEN,PSJNM,PSJVACL,X,PSJX
"RTN","PSJGMRA",60,0)
 S PSJFLG=0
"RTN","PSJGMRA",61,0)
 S PSJX=$O(^TMP("GMRAOC",$J,"APC",""))
"RTN","PSJGMRA",62,0)
 I '$G(PSJACK)&'$G(PSJCLCNT) Q
"RTN","PSJGMRA",63,0)
 S PSJFLG=1
"RTN","PSJGMRA",64,0)
 W $C(7),!!,"A Drug-Allergy Reaction exists for this medication and/or class!"
"RTN","PSJGMRA",65,0)
 W !!,?3,"Drug: "_$P($G(^PSDRUG(PSJDD,0)),"^")
"RTN","PSJGMRA",66,0)
 I PSJACK D
"RTN","PSJGMRA",67,0)
 . S PSJX=""
"RTN","PSJGMRA",68,0)
 . F X=0:0 S X=$O(GMRAING(X)) Q:'X  D
"RTN","PSJGMRA",69,0)
 .. S PSJX=PSJX_$S(PSJX="":"",1:", ")_GMRAING(X)
"RTN","PSJGMRA",70,0)
 . I PSJX]"" W !?6,"Ingredients: " D MYWRITE^PSJMISC(PSJX,19,75)
"RTN","PSJGMRA",71,0)
 D:PSJCLCNT DISPCL
"RTN","PSJGMRA",72,0)
 D:PSJFLG INTERV("ALLERGY")
"RTN","PSJGMRA",73,0)
 Q
"RTN","PSJGMRA",74,0)
DISPCL ;Display class(es)
"RTN","PSJGMRA",75,0)
 NEW PSJX,X
"RTN","PSJGMRA",76,0)
 Q:'$D(^TMP($J,"PSJCLS"))
"RTN","PSJGMRA",77,0)
 S PSJX=""
"RTN","PSJGMRA",78,0)
 S PSJVACL="" F  S PSJVACL=$O(^TMP($J,"PSJCLS",PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",79,0)
 . S PSJX=PSJX_$S(PSJX="":"",1:", ")_^TMP($J,"PSJCLS",PSJVACL)
"RTN","PSJGMRA",80,0)
 . S PSJFLG=1
"RTN","PSJGMRA",81,0)
 I PSJX]"" D
"RTN","PSJGMRA",82,0)
 . W !,?6,"Drug Class: "
"RTN","PSJGMRA",83,0)
 . D MYWRITE^PSJMISC(PSJX,19,75)
"RTN","PSJGMRA",84,0)
 Q
"RTN","PSJGMRA",85,0)
 ;
"RTN","PSJGMRA",86,0)
INTERV(PSJRXREQ,PSJDD1) ;Prompt if user to log an intervention for significant interaction
"RTN","PSJGMRA",87,0)
 ;PSPRXREQ - intervention type
"RTN","PSJGMRA",88,0)
 ;PSJDD1 - Prospective drug name
"RTN","PSJGMRA",89,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJGMRA",90,0)
 I $G(PSGORQF)=1 Q
"RTN","PSJGMRA",91,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")=$S($G(PSJRXREQ)="ALLERGY":"YES",1:"NO")
"RTN","PSJGMRA",92,0)
 I $G(PSJDD1)]"" S DIR("A")="Do you want to Intervene with "_PSJDD1_"? "
"RTN","PSJGMRA",93,0)
 W ! D ^DIR
"RTN","PSJGMRA",94,0)
 S DIR("?",1)="Answer 'YES' if you DO want to enter an intervention for this medication,"
"RTN","PSJGMRA",95,0)
 S DIR("?")="       'NO' if you DON'T want to enter an intervention for this medication,"
"RTN","PSJGMRA",96,0)
 I Y S PSGP=DFN D ^PSJRXI W !
"RTN","PSJGMRA",97,0)
 Q 
"RTN","PSJGMRA",98,0)
RINTERV(PSJRXREQ,PSJDD1) ;Prompt user to log an intervention for critical interaction
"RTN","PSJGMRA",99,0)
 ;PSPRXREQ - intervention type
"RTN","PSJGMRA",100,0)
 ;PSJDD1 - Prospective drug name
"RTN","PSJGMRA",101,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJGMRA",102,0)
 K PSGORQF
"RTN","PSJGMRA",103,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="NO"
"RTN","PSJGMRA",104,0)
 I $G(PSJDD1)]"" S DIR("A")="Do you want to Continue with "_PSJDD1_"? "
"RTN","PSJGMRA",105,0)
 S DIR("?",1)="Enter 'NO' if you wish to exit without continuing with the order,",DIR("?")="or 'YES' to continue with the order entry process."
"RTN","PSJGMRA",106,0)
 D ^DIR
"RTN","PSJGMRA",107,0)
 I 'Y S PSGORQF=1 S VALMBCK="R" Q
"RTN","PSJGMRA",108,0)
 I Y S PSGP=DFN D ^PSJRXI W !
"RTN","PSJGMRA",109,0)
 Q
"RTN","PSJLIFN")
0^30^B29270381
"RTN","PSJLIFN",1,0)
PSJLIFN ;BIR/MV-IV FINISH USING LM ;13 Jan 98 / 11:32 AM
"RTN","PSJLIFN",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**1,29,34,37,42,47,50,56,94,80,116,110,181,261,252**;16 DEC 97;Build 69
"RTN","PSJLIFN",3,0)
 ;
"RTN","PSJLIFN",4,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178.
"RTN","PSJLIFN",5,0)
 ; Reference to ^PS(52.6 supported by DBIA #1231.
"RTN","PSJLIFN",6,0)
 ; Reference to ^PS(52.7 supported by DBIA #2173.
"RTN","PSJLIFN",7,0)
 ; Reference to ^PSDRUG( is supported by DBIA #2192.
"RTN","PSJLIFN",8,0)
 ; Reference to ^PSOORDRG is supported by DBIA #2190.
"RTN","PSJLIFN",9,0)
 ; Reference to ^%DT is supported by DBIA #10003.
"RTN","PSJLIFN",10,0)
 ; Reference to ^VALM is supported by DBIA #10118.
"RTN","PSJLIFN",11,0)
 ; Reference to ^VALM1 is supported by DBIA #10116.
"RTN","PSJLIFN",12,0)
 ; Reference to RE^VALM4 is supported by DBIA #10120.
"RTN","PSJLIFN",13,0)
 ;
"RTN","PSJLIFN",14,0)
EN ; Display order with numbers.
"RTN","PSJLIFN",15,0)
 L +^PS(53.1,+PSJORD):1 I '$T W !,$C(7),$C(7),"This order is being edited by another user. Try later." D PAUSE^VALM1 Q
"RTN","PSJLIFN",16,0)
 NEW PSJOCFG
"RTN","PSJLIFN",17,0)
 S PSJOCFG="FN IV"
"RTN","PSJLIFN",18,0)
 D PENDING K PSJREN,PSJOCFG
"RTN","PSJLIFN",19,0)
 L -^PS(53.1,+PSJORD)
"RTN","PSJLIFN",20,0)
 Q
"RTN","PSJLIFN",21,0)
PENDING ; Process pending order.
"RTN","PSJLIFN",22,0)
 ;* PSIVFN1 is used so it will display the AC/Edit screen
"RTN","PSJLIFN",23,0)
 ;* instead of go to the "IS this O.K." prompt
"RTN","PSJLIFN",24,0)
 ;* PSIVACEP only when accept the order. Original screen won't redisp.
"RTN","PSJLIFN",25,0)
 ;* PSJLMX is defined in WRTDRG^PSIVUTL and it was being call in PSJLIVMD & PSJLIVFD
"RTN","PSJLIFN",26,0)
 ;*        to count # of AD/SOL 
"RTN","PSJLIFN",27,0)
 NEW PSIVFN1,PSIVACEP,PSJLMX,PSIVOI,PSJOCCHK,PSJFNDS
"RTN","PSJLIFN",28,0)
 K PSJIVBD ;This variable was left over from the new backdoor order entry.
"RTN","PSJLIFN",29,0)
 ; PSJOCCHK is set so if EDIT was use instead of FN to finish order the OC is triggered
"RTN","PSJLIFN",30,0)
 S PSJOCCHK=1
"RTN","PSJLIFN",31,0)
 ;* PSJFNDS is set so dosing is trigger during finishing without changes to the add/sol
"RTN","PSJLIFN",32,0)
 S PSJFNDS=1
"RTN","PSJLIFN",33,0)
 S PSIVAC="CF" S (P("PON"),ON)=+PSJORD_"P",DFN=PSGP
"RTN","PSJLIFN",34,0)
 S PSIVUP=+$$GTPCI^PSIVUTL D GT531^PSIVORFA(DFN,ON)
"RTN","PSJLIFN",35,0)
 D:'$D(P("OT")) GTOT^PSIVUTL(P(4))
"RTN","PSJLIFN",36,0)
 NEW PSJL
"RTN","PSJLIFN",37,0)
 N PSIVNUM,PSJSTAR S PSIVNUM=1
"RTN","PSJLIFN",38,0)
 Q:ON'=PSJORD
"RTN","PSJLIFN",39,0)
 I $G(PSJLYN)]"" Q:ON'=PSJLYN
"RTN","PSJLIFN",40,0)
 S PSJMAI=ON
"RTN","PSJLIFN",41,0)
 I P("OT")="I" D  Q
"RTN","PSJLIFN",42,0)
 . S PSJSTAR="(5)^(7)^(9)^(10)"
"RTN","PSJLIFN",43,0)
 . D EN^VALM("PSJ LM IV INPT PENDING") ;; ^PSJLIVMD
"RTN","PSJLIFN",44,0)
 S PSJSTAR="(1)^(2)^(3)^(5)^(7)^(9)"
"RTN","PSJLIFN",45,0)
 D GTDATA D EN^VALM("PSJ LM IV PENDING") ;; ^PSJLIVFD
"RTN","PSJLIFN",46,0)
 K PSJMAI Q
"RTN","PSJLIFN",47,0)
 ;
"RTN","PSJLIFN",48,0)
DISPLAY ;
"RTN","PSJLIFN",49,0)
 S PSGACT=""
"RTN","PSJLIFN",50,0)
 S VALMSG="Press Return to continue"
"RTN","PSJLIFN",51,0)
 D:$E(P("OT"))="I" EN^VALM("PSJ LM IV INPT DISPLAY")
"RTN","PSJLIFN",52,0)
 D:$E(P("OT"))'="I" EN^VALM("PSJ LM IV DISPLAY")
"RTN","PSJLIFN",53,0)
 K PSJDISP
"RTN","PSJLIFN",54,0)
 S:'$G(PSJHIS) VALMBCK=""
"RTN","PSJLIFN",55,0)
 Q
"RTN","PSJLIFN",56,0)
GTDATA ;
"RTN","PSJLIFN",57,0)
 ;* D:P(4)="" 53^PSIVORC1 Q:P(4)=""  S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSJLIFN",58,0)
 S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSJLIFN",59,0)
 I 'P(2) D
"RTN","PSJLIFN",60,0)
 .I P("RES")="R" S PSJREN=1
"RTN","PSJLIFN",61,0)
 .D ENT^PSIVCAL K %DT S X=P(2),%DT="RTX" D ^%DT S P(2)=+Y
"RTN","PSJLIFN",62,0)
 I 'P(3) D ENSTOP^PSIVCAL K %DT S X=P(3),%DT="RTX" D ^%DT S P(3)=+Y
"RTN","PSJLIFN",63,0)
 I 'P("MR") S P("MR")=$O(^PS(51.2,"B","INTRAVENOUS",0))_"^IV"
"RTN","PSJLIFN",64,0)
 Q
"RTN","PSJLIFN",65,0)
FINISH ; Prompt for missing data
"RTN","PSJLIFN",66,0)
 ;* Ord chk for Inpat. pending only. Pend renew should not be checked.
"RTN","PSJLIFN",67,0)
 ;* PSIVOCON needed so this order will be excluded from the order
"RTN","PSJLIFN",68,0)
 ;*          list(ORDCHK^PSJLMUT1)
"RTN","PSJLIFN",69,0)
 ;* PSGORQF defined means cancel the order due to order check.
"RTN","PSJLIFN",70,0)
 ;Q:'$$LS^PSSLOCK(DFN,PSJORD)
"RTN","PSJLIFN",71,0)
 N PSJCOM,PSIVEDIT S PSJCOM=+$P($G(^PS(53.1,+PSJORD,.2)),"^",8)
"RTN","PSJLIFN",72,0)
 K PSJIVBD,PSGRDTX,PSIVEDIT
"RTN","PSJLIFN",73,0)
 N FIL,PSIVS,DRGOC,PSIVXD,DRGTMP,PSIVOCON,PSGORQF,ON55,NSFF K PSGORQF S NSFF=1
"RTN","PSJLIFN",74,0)
 S (ON,PSIVOCON,ON55,PSGORD)=PSJORD Q:PSJORD'=PSJMAI  I $G(PSJLYN)]"" Q:PSJORD'=PSJLYN
"RTN","PSJLIFN",75,0)
 D UDVARS^PSJLIORD
"RTN","PSJLIFN",76,0)
 I $G(PSJPROT)=3,'$$ENIVUD^PSGOEF1(PSJORD) K NSFF Q
"RTN","PSJLIFN",77,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIFN",78,0)
 ;PRE UAT group requested to not show the second screen since FDB OC has more text and provider override reason appears after 2nd screen 
"RTN","PSJLIFN",79,0)
 ; force the display of the second screen if CPRS order checks exist
"RTN","PSJLIFN",80,0)
 ;I $O(^PS(53.1,+PSJORD,12,0))!$O(^PS(53.1,+PSJORD,10,0)) D
"RTN","PSJLIFN",81,0)
 ;.Q:$G(PSJLMX)=1   ;no second screen to display
"RTN","PSJLIFN",82,0)
 ;.S VALMBG=16 D RE^VALM4,PAUSE^VALM1 S VALMBG=1
"RTN","PSJLIFN",83,0)
 S P("OPI")=$$ENPC^PSJUTL("V",+PSIVUP,60,P("OPI"))
"RTN","PSJLIFN",84,0)
 ;I $E(P("OT"))="I" D GTDATA Q:P(4)=""
"RTN","PSJLIFN",85,0)
 ;I $E(P("OT"))="I",'$D(DRG("AD")),('$D(DRG("SOL"))) D
"RTN","PSJLIFN",86,0)
 I $G(P("RES"))'="R" D 53^PSIVORC1
"RTN","PSJLIFN",87,0)
 I $G(P(4))]"",$G(P(15))]"",$G(P(9))]"",$$SCHREQ^PSJLIVFD(.P) D
"RTN","PSJLIFN",88,0)
 . N PSGS0XT,X,PSJNSS S PSJNSS=1,X=P(9),PSGS0XT=P(15) D Q2^PSGS0
"RTN","PSJLIFN",89,0)
 I P(4)="" D RE^VALM4 Q
"RTN","PSJLIFN",90,0)
 I $E(P("OT"))="I" D GTDATA  D
"RTN","PSJLIFN",91,0)
 . I '$D(DRG("AD")),('$D(DRG("SOL"))) S DNE=0 D GTIVDRG^PSIVORC2 S P(3)="" D ENSTOP^PSIVCAL
"RTN","PSJLIFN",92,0)
 S VALMBG=1
"RTN","PSJLIFN",93,0)
 I $E(P("OT"))="F" S DNE=0 I $G(PSGORQF) D RE^VALM4 Q
"RTN","PSJLIFN",94,0)
 I $G(PSGORQF) S VALMBCK="R",P(4)="" K DRG Q
"RTN","PSJLIFN",95,0)
 S PSIVEDIT=""
"RTN","PSJLIFN",96,0)
 S PSIVOK="1^3^10^25^26^39^57^58^59^63^64" D CKFLDS^PSIVORC1 I EDIT]"" D EDIT^PSIVEDT
"RTN","PSJLIFN",97,0)
 ;S PSIVOK="1^3^10^25^26^39^57^58^59^63^64" D CKFLDS^PSIVORC1 I EDIT]"" S PSIVEDIT=EDIT D EDIT^PSIVEDT
"RTN","PSJLIFN",98,0)
 ;I $G(EDIT)="" D OC^PSIVOC D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","") Q:$G(PSGORQF)
"RTN","PSJLIFN",99,0)
 I $D(PSIVEDIT) D OC^PSIVOC
"RTN","PSJLIFN",100,0)
 ;PSJ*5*261 - Remedy #490875 PSPO 2040 
"RTN","PSJLIFN",101,0)
 D ENSTOP^PSIVCAL
"RTN","PSJLIFN",102,0)
 ;D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","")
"RTN","PSJLIFN",103,0)
 I $G(PSGORQF) D GT531^PSIVORFA(DFN,ON) Q
"RTN","PSJLIFN",104,0)
 I $G(DONE) S VALMBCK="R" Q
"RTN","PSJLIFN",105,0)
 ;* PSJFNDS is set so dosing is trigger during finishing without changes to the add/sol
"RTN","PSJLIFN",106,0)
 ;S PSJFNDS=1
"RTN","PSJLIFN",107,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIFN",108,0)
 S:$G(PSIVACEP) VALMBCK="Q"
"RTN","PSJLIFN",109,0)
 ;Reset PSJFNDS so if FN again, the dosing check is triggered.
"RTN","PSJLIFN",110,0)
 S:'$G(PSIVACEP) PSJFNDS=1
"RTN","PSJLIFN",111,0)
 I $G(PSGORQF) S VALMBG=1 D RE^VALM4
"RTN","PSJLIFN",112,0)
 K NSFF
"RTN","PSJLIFN",113,0)
 Q
"RTN","PSJLIFN",114,0)
ORDCHK ;* Do order check for Inpatient Meds IV.
"RTN","PSJLIFN",115,0)
 ; PSGORQF is defined (CONT^PSGSICHK) if not log an intervention
"RTN","PSJLIFN",116,0)
 ; No longer use after PSJ*5*181
"RTN","PSJLIFN",117,0)
 K PSGORQF
"RTN","PSJLIFN",118,0)
 Q
"RTN","PSJLIFN",119,0)
 ;NEW DRGOC
"RTN","PSJLIFN",120,0)
 ;D OCORD Q:$G(PSGORQF) 
"RTN","PSJLIFN",121,0)
 ;D GTIVDRG^PSIVORC2 S P(3)="" D ENSTOP^PSIVCAL
"RTN","PSJLIFN",122,0)
ORDCHKA ;* Do order check against existing orders on the profile
"RTN","PSJLIFN",123,0)
 ;No longer use as of PSJ*5*181
"RTN","PSJLIFN",124,0)
 Q
"RTN","PSJLIFN",125,0)
 F PSIVAS="AD","SOL" Q:$G(PSGORQF)  S FIL=$S(PSIVAS="AD":52.6,1:52.7) D
"RTN","PSJLIFN",126,0)
 . F PSIVX=0:0 S PSIVX=$O(DRG(PSIVAS,PSIVX)) Q:'PSIVX!($G(PSGORQF))  D
"RTN","PSJLIFN",127,0)
 .. S DRGTMP=DRG(PSIVAS,PSIVX)
"RTN","PSJLIFN",128,0)
 .. ;* Do only 1 duplicate warning when order has >1 of the same additive
"RTN","PSJLIFN",129,0)
 .. Q:$D(PSJADTMP(+DRGTMP))
"RTN","PSJLIFN",130,0)
 .. D ORDERCHK^PSIVEDRG(PSGP,ON,$D(DRGOC(ON)))
"RTN","PSJLIFN",131,0)
 .. S DRGOC(ON,PSIVAS,PSIVX)=DRG(PSIVAS,PSIVX)
"RTN","PSJLIFN",132,0)
 .. S PSJADTMP(+DRGTMP)=""
"RTN","PSJLIFN",133,0)
 K PSJADTMP
"RTN","PSJLIFN",134,0)
 Q
"RTN","PSJLIFN",135,0)
OCORD ;* Do order check for each drug against the drugs within the order.
"RTN","PSJLIFN",136,0)
 ;OCORD was called by ORDCHK.  This entry point is no longer use as of PSJ*5*181
"RTN","PSJLIFN",137,0)
 Q
"RTN","PSJLIFN",138,0)
 NEW X,Y,DDRUG,PSIVX,PSJAD,PSJSOL,TMPDRG
"RTN","PSJLIFN",139,0)
 D SAVEDRG^PSIVEDRG(.TMPDRG,.DRG)
"RTN","PSJLIFN",140,0)
 ; Find the corresponding DD for the additive within the order
"RTN","PSJLIFN",141,0)
 F X=0:0 S X=$O(DRG("AD",X)) Q:'X  D
"RTN","PSJLIFN",142,0)
 . S DDRUG=$P($G(^PS(52.6,+DRG("AD",X),0)),U,2)
"RTN","PSJLIFN",143,0)
 . S:+DDRUG (DDRUG(DDRUG),PSJAD(DDRUG))=$D(DDRUG(DDRUG))+1
"RTN","PSJLIFN",144,0)
 ;
"RTN","PSJLIFN",145,0)
 ; Find the corresponding DD for the solution
"RTN","PSJLIFN",146,0)
 ;
"RTN","PSJLIFN",147,0)
 F X=0:0 S X=$O(DRG("SOL",X)) Q:'X  D
"RTN","PSJLIFN",148,0)
 . S DDRUG=$P($G(^PS(52.7,+DRG("SOL",X),0)),U,2)
"RTN","PSJLIFN",149,0)
 . S:+DDRUG (DDRUG(DDRUG),PSJSOL(DDRUG))=$D(DDRUG(DDRUG))+1
"RTN","PSJLIFN",150,0)
 ;
"RTN","PSJLIFN",151,0)
 ; Loop thru each additive to check for DD,DI & DC against the
"RTN","PSJLIFN",152,0)
 ; order's dispense drugs
"RTN","PSJLIFN",153,0)
 ;
"RTN","PSJLIFN",154,0)
 NEW PSJDFN,INTERVEN S INTERVEN=""
"RTN","PSJLIFN",155,0)
 S PSJDFN=DFN ;DFN will be killed when call ^PSOORDRG
"RTN","PSJLIFN",156,0)
 F PSIVX=0:0 S PSIVX=$O(PSJAD(PSIVX)) Q:'PSIVX  D
"RTN","PSJLIFN",157,0)
 . K DDRUG(PSIVX) D DRGCHK^PSOORDRG(PSJDFN,PSIVX,.DDRUG)
"RTN","PSJLIFN",158,0)
 . I PSJAD(PSIVX)>1 S ^TMP($J,"DD",1,0)=PSIVX_U_$P($G(^PSDRUG(PSIVX,0)),U)_"^^"_ON_";I"
"RTN","PSJLIFN",159,0)
 . NEW TYPE F TYPE="DD","DI","DC" D ORDCHK^PSJLIFNI(PSJDFN,TYPE)
"RTN","PSJLIFN",160,0)
 F PSIVX=0:0 S PSIVX=$O(PSJSOL(PSIVX)) Q:'PSIVX  D
"RTN","PSJLIFN",161,0)
 . K DDRUG(PSIVX) D DRGCHK^PSOORDRG(PSJDFN,PSIVX,.DDRUG)
"RTN","PSJLIFN",162,0)
 . NEW TYPE F TYPE="DI" D ORDCHK^PSJLIFNI(PSJDFN,TYPE)
"RTN","PSJLIFN",163,0)
 S DFN=PSJDFN
"RTN","PSJLIFN",164,0)
 D SAVEDRG^PSIVEDRG(.DRG,.TMPDRG)
"RTN","PSJLIFN",165,0)
 Q
"RTN","PSJMISC2")
0^32^B12038651
"RTN","PSJMISC2",1,0)
PSJMISC2 ;BIR/MV - MISC. CALLS FOR IV DOSING CHECKS;6 Jun 07 / 3:37 PM
"RTN","PSJMISC2",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSJMISC2",3,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425
"RTN","PSJMISC2",4,0)
 ;
"RTN","PSJMISC2",5,0)
P8(PSJINFRT) ;Set infusion rate in term of numeric, dose unit over time unit
"RTN","PSJMISC2",6,0)
 ;PSJINFRT - Infusion Rate
"RTN","PSJMISC2",7,0)
 ;Return either Null or numeric^doseUnit^timeUnit
"RTN","PSJMISC2",8,0)
 ;PWJP8ERR - Must be clean up by calling routine.
"RTN","PSJMISC2",9,0)
 ;PSJP8ERR = 1 - "FRQ_ERROR"
"RTN","PSJMISC2",10,0)
 ;PSJP8ERR = 2 - "WT_ERROR"
"RTN","PSJMISC2",11,0)
 ;PSJP8ERR = 3 - "HT_ERROR"
"RTN","PSJMISC2",12,0)
 ;PSJP8ERR = 4 - Set both WT & HT error
"RTN","PSJMISC2",13,0)
 ;
"RTN","PSJMISC2",14,0)
 I $G(PSJINFRT)="" Q ""
"RTN","PSJMISC2",15,0)
 NEW X,PSJBSA,PSJBSAFG,PSJHT,PSJWT,PSJWTFG,PSJTIME,PSJUNIT,PSJP1,PSJP2,PSJNUT,PSJUP8
"RTN","PSJMISC2",16,0)
 K PSJP8ERR
"RTN","PSJMISC2",17,0)
 S PSJUP8=$$UP^XLFSTR(PSJINFRT)
"RTN","PSJMISC2",18,0)
 I $S(PSJUP8["TITRATE AT ":0,PSJUP8["TITRATE":1,1:0) S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",19,0)
 I PSJUP8["BOLUS" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",20,0)
 S PSJP1=$P(PSJUP8,"@")
"RTN","PSJMISC2",21,0)
 S:PSJP1["INFUSE OVER " PSJP1=$P(PSJP1,"INFUSE OVER ",2)
"RTN","PSJMISC2",22,0)
 S:PSJP1["INFUSE AT " PSJP1=$P(PSJP1,"INFUSE AT ",2)
"RTN","PSJMISC2",23,0)
 S:PSJP1["INFUSE " PSJP1=$P(PSJP1,"INFUSE ",2)
"RTN","PSJMISC2",24,0)
 S:PSJP1["OVER " PSJP1=$P(PSJP1,"OVER ",2)
"RTN","PSJMISC2",25,0)
 S:PSJP1["START AT " PSJP1=$P(PSJP1,"START AT ",2)
"RTN","PSJMISC2",26,0)
 S:PSJP1["TITRATE AT " PSJP1=$P(PSJP1,"TITRATE AT ",2)
"RTN","PSJMISC2",27,0)
 I PSJP1[" TO " S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",28,0)
 S:PSJP1["," PSJP1=$TR(PSJP1,",","")
"RTN","PSJMISC2",29,0)
 S PSJP1=$TR(PSJP1," ")
"RTN","PSJMISC2",30,0)
 I '+PSJP1 S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",31,0)
 ;
"RTN","PSJMISC2",32,0)
 S PSJP2=$P(PSJUP8,"@",2)
"RTN","PSJMISC2",33,0)
 I PSJUP8["@",$S(PSJP2=0:0,'+PSJP2:1,1:0) S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",34,0)
 ;
"RTN","PSJMISC2",35,0)
 I PSJP1'["/" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",36,0)
 ;Process ml/hr, mg/day... types
"RTN","PSJMISC2",37,0)
 NEW PSJUOTME
"RTN","PSJMISC2",38,0)
 I $S(PSJP1["/KG/":0,PSJP1["/M2/":0,1:1) S PSJUOTME=$$UNTOTME(PSJP1) Q PSJUOTME
"RTN","PSJMISC2",39,0)
 ;
"RTN","PSJMISC2",40,0)
 ;If Infusion rate contains /KG/, /M2/ and also contains ML/HR
"RTN","PSJMISC2",41,0)
 I PSJP1["ML/HR" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",42,0)
 ;
"RTN","PSJMISC2",43,0)
 ;Set patient parameter
"RTN","PSJMISC2",44,0)
 S X=$$BSA^PSSDSAPI($G(DFN))
"RTN","PSJMISC2",45,0)
 S PSJHT=+$P(X,U),PSJWT=+$P(X,U,2),PSJBSA=+$P(X,U,3)
"RTN","PSJMISC2",46,0)
 S PSJTIME=$P(PSJP1,"/",3)
"RTN","PSJMISC2",47,0)
 S PSJTIME=$$TIME(PSJTIME)
"RTN","PSJMISC2",48,0)
 S X=$P(PSJP1,"/"),PSJUNIT=$P(X,+X,2)
"RTN","PSJMISC2",49,0)
 I PSJP1["." S PSJUNIT=$$UNIT(PSJUNIT)
"RTN","PSJMISC2",50,0)
 S PSJUNIT=$$UNIT^PSSDSAPI(PSJUNIT)
"RTN","PSJMISC2",51,0)
 ;
"RTN","PSJMISC2",52,0)
 ;Calculate SDA using weight
"RTN","PSJMISC2",53,0)
 I PSJP1["/KG/" S PSJWTFG=$$WT() Q PSJWTFG
"RTN","PSJMISC2",54,0)
 ;
"RTN","PSJMISC2",55,0)
 ;Calculate SDA using  BSA
"RTN","PSJMISC2",56,0)
 I PSJP1["/M2/" S PSJBSAFG=$$BSA() Q PSJBSAFG
"RTN","PSJMISC2",57,0)
 ;
"RTN","PSJMISC2",58,0)
 Q ""
"RTN","PSJMISC2",59,0)
WT() ;
"RTN","PSJMISC2",60,0)
 NEW X
"RTN","PSJMISC2",61,0)
 I $S(PSJUNIT="":1,PSJTIME="":1,'PSJWT:1,'+PSJP1:1,1:0) S PSJP8ERR=2 Q ""
"RTN","PSJMISC2",62,0)
 S X=(+PSJP1*PSJWT)_U_PSJUNIT_U_PSJTIME
"RTN","PSJMISC2",63,0)
 Q X
"RTN","PSJMISC2",64,0)
BSA() ;
"RTN","PSJMISC2",65,0)
 NEW X
"RTN","PSJMISC2",66,0)
 I $S(PSJUNIT="":1,PSJTIME="":1,'PSJBSA:1,'+PSJP1:1,1:0) D  Q ""
"RTN","PSJMISC2",67,0)
 . I $G(PSJHT)=0,($G(PSJWT)=0) S PSJP8ERR=4 Q
"RTN","PSJMISC2",68,0)
 . I $G(PSJHT)=0 S PSJP8ERR=3 Q
"RTN","PSJMISC2",69,0)
 . I $G(PSJWT)=0 S PSJP8ERR=2
"RTN","PSJMISC2",70,0)
 S X=(+PSJP1*PSJBSA)_U_PSJUNIT_U_PSJTIME
"RTN","PSJMISC2",71,0)
 Q X
"RTN","PSJMISC2",72,0)
UNTOTME(PSJINF) ;Process Infusion rate for format of Num Unit/time. Ex: 8MG/HR, 125ML/HR, 1000UNITS/HR@TITRATE
"RTN","PSJMISC2",73,0)
 ;Return n^unit^time if infusion rate contain numeric + Unit over time (8MG/HR;125ML/HR) format in p1^p2^p3
"RTN","PSJMISC2",74,0)
 ;Otherwise return null
"RTN","PSJMISC2",75,0)
 ;PSJINF is already have "OVER" and whatever from "@" removed
"RTN","PSJMISC2",76,0)
 NEW PSJNUM,PSJP1S1,PSJP1S2,PSJUNIT,PSJTIME
"RTN","PSJMISC2",77,0)
 I $G(PSJINF)="" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",78,0)
 S PSJNUM=+PSJINF
"RTN","PSJMISC2",79,0)
 I 'PSJNUM S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",80,0)
 S PSJP1S1=$P(PSJINF,"/")
"RTN","PSJMISC2",81,0)
 S PSJP1S2=$P(PSJINF,"/",2)
"RTN","PSJMISC2",82,0)
 ; Should be free text if in format: "8MG/HRML/HR" PSJP1S2="HRML/HR"
"RTN","PSJMISC2",83,0)
 I PSJP1S2["ML/HR" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",84,0)
 S PSJUNIT=$P(PSJP1S1,PSJNUM,2)
"RTN","PSJMISC2",85,0)
 S PSJUNIT=$$UNIT^PSSDSAPI(PSJUNIT)
"RTN","PSJMISC2",86,0)
 I PSJUNIT="" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",87,0)
 S PSJTIME=$$TIME(PSJP1S2)
"RTN","PSJMISC2",88,0)
 I PSJTIME="" S PSJP8ERR=1 Q ""
"RTN","PSJMISC2",89,0)
 Q PSJNUM_U_PSJUNIT_U_PSJTIME
"RTN","PSJMISC2",90,0)
TIME(PSJTIME) ;
"RTN","PSJMISC2",91,0)
 Q:$G(PSJTIME)="" ""
"RTN","PSJMISC2",92,0)
 I PSJTIME="MIN" Q "MINUTE"
"RTN","PSJMISC2",93,0)
 I PSJTIME="MINUTE" Q "MINUTE"
"RTN","PSJMISC2",94,0)
 I PSJTIME="MINUTES" Q "MINUTE"
"RTN","PSJMISC2",95,0)
 I PSJTIME="HR" Q "HOUR"
"RTN","PSJMISC2",96,0)
 I PSJTIME="HOUR" Q "HOUR"
"RTN","PSJMISC2",97,0)
 I PSJTIME="HOURS" Q "HOUR"
"RTN","PSJMISC2",98,0)
 I PSJTIME="DAY" Q "DAY"
"RTN","PSJMISC2",99,0)
 I PSJTIME="DAYS" Q "DAY"
"RTN","PSJMISC2",100,0)
 Q ""
"RTN","PSJMISC2",101,0)
UNIT(PSJUNIT) ;Remove extra zero after decimal point
"RTN","PSJMISC2",102,0)
 NEW PSJX
"RTN","PSJMISC2",103,0)
 I $G(PSJUNIT)=""!($G(PSJUNIT)=0) Q ""
"RTN","PSJMISC2",104,0)
 F  S PSJX=$E(PSJUNIT,1,1) Q:PSJX'=0  S:PSJX=0 PSJUNIT=$E(PSJUNIT,2,$L(PSJUNIT))
"RTN","PSJMISC2",105,0)
 Q PSJUNIT
"RTN","PSJOC")
0^22^B24678878
"RTN","PSJOC",1,0)
PSJOC ;BIR/MV - NEW ORDER CHECKS DRIVER ;6 Jun 07 / 3:37 PM
"RTN","PSJOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSJOC",3,0)
 ;
"RTN","PSJOC",4,0)
 ; Reference to ^PSODDPR4 is supported by DBIA# 5366.
"RTN","PSJOC",5,0)
 ; Reference to ^PSSHRQ2 is supported by DBIA# 5369.
"RTN","PSJOC",6,0)
 ;
"RTN","PSJOC",7,0)
OC(PSPDRG,PSJPTYP) ;
"RTN","PSJOC",8,0)
 ;PSPDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug Name
"RTN","PSJOC",9,0)
 ;Where n is a sequential number.  The Drug Name can be OI, Generic name from #50, or Add/Sol name
"RTN","PSJOC",10,0)
 ;PSJPTYP - P1 ; P2
"RTN","PSJOC",11,0)
 ; Where P1 is "I" for Inpatient, "O" for Outpatient
"RTN","PSJOC",12,0)
 ;       P2 is the Inpatient Order Number (for PSJ use only)
"RTN","PSJOC",13,0)
 ;PSJOCERR(DRUG NAME)="Reason text". Where Drug Name can be either OI name or AD/SOL name.
"RTN","PSJOC",14,0)
 NEW PSJOCERR
"RTN","PSJOC",15,0)
 ;Quit OC if FDB link is down.  PSGORQF is defined if user wish to stop the order process
"RTN","PSJOC",16,0)
 I $$SYS^PSJOCERR() Q
"RTN","PSJOC",17,0)
 ;
"RTN","PSJOC",18,0)
 D BLD^PSODDPR4(DFN,"PSJPRE",.PSPDRG,PSJPTYP)
"RTN","PSJOC",19,0)
 D DISPLAY
"RTN","PSJOC",20,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSJOC",21,0)
 Q
"RTN","PSJOC",22,0)
DISPLAY ;
"RTN","PSJOC",23,0)
 NEW PSJPAUSE,PSJOLDSV,PSJDNM,PSJMON,PSJOC,PSJOCDT,PSJOCDTL,PSJOCLST,PSJP,PSJS,PSJPON,PSJDN,PSJSEV,PSJECNT
"RTN","PSJOC",24,0)
 D GMRAOC
"RTN","PSJOC",25,0)
 Q:'$$DSPSERR()
"RTN","PSJOC",26,0)
 D FULL^VALM1
"RTN","PSJOC",27,0)
 W @IOF,"Now Processing Enhanced Order Checks!  Please wait...",!
"RTN","PSJOC",28,0)
 ; If there are no OC or errors to display, this var will trigger a pause before continue /w the order
"RTN","PSJOC",29,0)
 S PSJPAUSE=1
"RTN","PSJOC",30,0)
 D DRUGERR
"RTN","PSJOC",31,0)
 ;Process drug interaction & drug interception
"RTN","PSJOC",32,0)
 D DI^PSJOCDI
"RTN","PSJOC",33,0)
 Q:$G(PSGORQF)
"RTN","PSJOC",34,0)
 D DSPERR^PSJOCERR("DRUGDRUG")
"RTN","PSJOC",35,0)
 ;Process duplicate therapy order checks
"RTN","PSJOC",36,0)
 D DT^PSJOCDT
"RTN","PSJOC",37,0)
 D:'$G(PSGORQF) DSPERR^PSJOCERR("THERAPY")
"RTN","PSJOC",38,0)
 Q:$G(PSGORQF)
"RTN","PSJOC",39,0)
 D:$G(PSJPAUSE) PAUSE^PSJLMUT1
"RTN","PSJOC",40,0)
 Q
"RTN","PSJOC",41,0)
 ;
"RTN","PSJOC",42,0)
GMRAOC ;Display allergy & CPRS OC regardless if FDB is connected
"RTN","PSJOC",43,0)
 D ALLERGY
"RTN","PSJOC",44,0)
 D CPRS^PSJOCOR(.PSPDRG)
"RTN","PSJOC",45,0)
 Q
"RTN","PSJOC",46,0)
ALLERGY ;Do allergy order check
"RTN","PSJOC",47,0)
 ;The allergy check will be processed for each of the dispense drug stores in the PSJALLGY array
"RTN","PSJOC",48,0)
 ;PSJALLGY(X)="" Where X is the disp drug IEN.  PSJALLGY array store all dispense drugs use in an order
"RTN","PSJOC",49,0)
 ;
"RTN","PSJOC",50,0)
 NEW PSJDD
"RTN","PSJOC",51,0)
 F PSJDD=0:0 S PSJDD=$O(PSJALLGY(PSJDD)) Q:'PSJDD  D EN^PSJGMRA(DFN,PSJDD)
"RTN","PSJOC",52,0)
 Q
"RTN","PSJOC",53,0)
DSPORD(ON,PSJNLST) ;Display the order data
"RTN","PSJOC",54,0)
 ;ON - ON_U/V/P ex: 21V
"RTN","PSJOC",55,0)
 ;PSJNLST - It's number list and also use to trigger pg break, line break
"RTN","PSJOC",56,0)
 NEW PSJCOL,PSJX,PSJOC,PSJLINE,X
"RTN","PSJOC",57,0)
 Q:ON=""
"RTN","PSJOC",58,0)
 S PSJLINE=1,PSJCOL=1
"RTN","PSJOC",59,0)
 I ON'["V" D DSPLORDU^PSJLMUT1(DFN,ON)
"RTN","PSJOC",60,0)
 I ON["V" D DSPLORDV^PSJLMUT1(DFN,ON)
"RTN","PSJOC",61,0)
 F PSJX=0:0 S PSJX=$O(PSJOC(ON,PSJX)) Q:'PSJX  D
"RTN","PSJOC",62,0)
 . I $G(PSJNLST)="",(($Y+6)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",63,0)
 . W !
"RTN","PSJOC",64,0)
 . I $G(PSJNLST) W:(PSJX=1) PSJNLST W:(PSJX>1) ?$L(PSJNLST)
"RTN","PSJOC",65,0)
 . S X=PSJOC(ON,PSJX)
"RTN","PSJOC",66,0)
 . W $E(X,9,$L(X))
"RTN","PSJOC",67,0)
 W !
"RTN","PSJOC",68,0)
 Q
"RTN","PSJOC",69,0)
 ;
"RTN","PSJOC",70,0)
DRUGERR ;Display drug level errors
"RTN","PSJOC",71,0)
 NEW PSJPON,PSJN,PSJNV,PSJDSPFG,PSJPERR,PSJX
"RTN","PSJOC",72,0)
 ;Only display the exceptions once per patient. Use the exception from prospective drug if exception(s) existed for the 
"RTN","PSJOC",73,0)
 ; same drug on the profile.
"RTN","PSJOC",74,0)
 ;PSJEXCPT(PSJDNM_REASON) - Array for invalid drugs that already display to once within a pt selection
"RTN","PSJOC",75,0)
 S PSJDSPFG=0
"RTN","PSJOC",76,0)
 S PSJPERR=$$PROSPERR()
"RTN","PSJOC",77,0)
 I PSJPERR D  Q
"RTN","PSJOC",78,0)
 . I PSJDSPFG D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",79,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",80,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOC",81,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOC",82,0)
 .. I $P(PSJPON,";",3)'="PROFILE" Q
"RTN","PSJOC",83,0)
 .. I '$$ERRCHK("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOC",84,0)
 .. I '$$ERRCHK("PROFILE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOC",85,0)
 .. D DSPDRGER()
"RTN","PSJOC",86,0)
 I PSJDSPFG D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",87,0)
 Q
"RTN","PSJOC",88,0)
DSPDRGER(PSJDSFLG) ;
"RTN","PSJOC",89,0)
 NEW PSJTXT
"RTN","PSJOC",90,0)
 S PSJTXT=$P(PSJNV,U,7)
"RTN","PSJOC",91,0)
 S X="Enhanced Order Checks cannot "
"RTN","PSJOC",92,0)
 I $G(PSJDSFLG),(PSJTXT[X) S PSJTXT="Dosing Checks could not "_$P(PSJTXT,X,2)
"RTN","PSJOC",93,0)
 S PSJDSPFG=1
"RTN","PSJOC",94,0)
 K PSJPAUSE
"RTN","PSJOC",95,0)
 I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",96,0)
 W !
"RTN","PSJOC",97,0)
 D WRITE^PSJMISC(PSJTXT,,79)
"RTN","PSJOC",98,0)
 D:$P(PSJNV,U,10)]"" WRITE^PSJMISC("Reason(s): "_$P(PSJNV,U,10),3,79)
"RTN","PSJOC",99,0)
 W !
"RTN","PSJOC",100,0)
 Q
"RTN","PSJOC",101,0)
ERRCHK(PSJTYPE,PSJX) ;
"RTN","PSJOC",102,0)
 ;PSJTYPE - Either "PROFILE" or "PROSPECTIVE"
"RTN","PSJOC",103,0)
 ;PSJX - Drug name_Error reason
"RTN","PSJOC",104,0)
 ;Return 1 if this error drug has not displayed to the user.
"RTN","PSJOC",105,0)
 I $G(PSJX)="" Q 0
"RTN","PSJOC",106,0)
 I $G(PSJTYPE)="" Q 0
"RTN","PSJOC",107,0)
 I PSJTYPE="PROFILE",'$D(PSJEXCPT(PSJTYPE,PSJX)) S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",108,0)
 I PSJTYPE="PROSPECTIVE",'$D(PSJEXCPT(PSJTYPE,PSJX)) S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",109,0)
 Q 0
"RTN","PSJOC",110,0)
PING(PSJMSG) ;Check if FDB is down.  Return 0 if it is
"RTN","PSJOC",111,0)
 ;pass in a message to customize the display
"RTN","PSJOC",112,0)
 S ^TMP($J,"PSJPRE","IN","PING")=""
"RTN","PSJOC",113,0)
 D IN^PSSHRQ2("PSJPRE")
"RTN","PSJOC",114,0)
 Q $$DSPSERR($G(PSJMSG))
"RTN","PSJOC",115,0)
DSPSERR(PSJMSG) ;Display system errors
"RTN","PSJOC",116,0)
 NEW X
"RTN","PSJOC",117,0)
 S X=$G(^TMP($J,"PSJPRE","OUT",0))
"RTN","PSJOC",118,0)
 I $P(X,U)=-1 D NOFDB($P(X,U,2),$G(PSJMSG))
"RTN","PSJOC",119,0)
 Q $S($P(X,U)=-1:0,1:1)
"RTN","PSJOC",120,0)
NOFDB(PSJX,PSJMSG) ;Display connection down message
"RTN","PSJOC",121,0)
 NEW X
"RTN","PSJOC",122,0)
 Q:$G(PSJX)=""
"RTN","PSJOC",123,0)
 I $G(PSJMSG)]"" W !!,"Maximum Single Dose Check could not be performed"
"RTN","PSJOC",124,0)
 I $G(PSJMSG)="" W !!,"No Enhanced Order Checks can be performed."
"RTN","PSJOC",125,0)
 W !,"   Reason(s): ",PSJX,!!
"RTN","PSJOC",126,0)
 K PSJX
"RTN","PSJOC",127,0)
 D:$G(PSJMSG)["Maximum Single" PAUSE^PSJLMUT1
"RTN","PSJOC",128,0)
 Q
"RTN","PSJOC",129,0)
PROSPERR() ;Display exceptions for prospective drug
"RTN","PSJOC",130,0)
 NEW PSJPON,PSJN,PSJNV,PSJPERR
"RTN","PSJOC",131,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",132,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOC",133,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOC",134,0)
 .. I $P(PSJPON,";",3)="PROFILE" Q 
"RTN","PSJOC",135,0)
 .. I ($P(PSJPON,";",3)="PROSPECTIVE") S PSJX='$$ERRCHK("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10))
"RTN","PSJOC",136,0)
 .. D DSPDRGER()
"RTN","PSJOC",137,0)
 ;If the prospective drug(s) is caught in the exception, the exception for profile drug(s) is not display.
"RTN","PSJOC",138,0)
 ;  The exception for the prospective is the only one need to display.
"RTN","PSJOC",139,0)
 S PSJPERR=1
"RTN","PSJOC",140,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJPON)) Q:PSJPON=""  Q:'PSJPERR  D
"RTN","PSJOC",141,0)
 . I $D(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q
"RTN","PSJOC",142,0)
 . S PSJPERR=0
"RTN","PSJOC",143,0)
 Q PSJPERR
"RTN","PSJOCDI")
0^24^B84788026
"RTN","PSJOCDI",1,0)
PSJOCDI ;BIR/MV - DISPLAY DRUG INTERACTION ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCDI",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSJOCDI",3,0)
 ;
"RTN","PSJOCDI",4,0)
 ; Reference to ^PSODRDU2 is supported by DBIA #2189.
"RTN","PSJOCDI",5,0)
DI ;
"RTN","PSJOCDI",6,0)
 NEW PSJDN,PSJDNM,PSJMON,PSJOCLST,PSJPON,PSJSEV,PSJHDR,PSJRDI,PSJ2,PSJONFLG,PSJCRTCL,PSJSORT,PSJGROUP
"RTN","PSJOCDI",7,0)
 ;If interception occurred, display message to user
"RTN","PSJOCDI",8,0)
 ;
"RTN","PSJOCDI",9,0)
 ;Store VUID from Remote data in PSJRDI(PSJON)=VUID.
"RTN","PSJOCDI",10,0)
 D RDIVUID
"RTN","PSJOCDI",11,0)
 S PSJ2=0
"RTN","PSJOCDI",12,0)
 ;Loop through drug drug order checks output
"RTN","PSJOCDI",13,0)
 S PSJSEV="" F  S PSJSEV=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV)) Q:PSJSEV=""!($G(PSGORQF))  D
"RTN","PSJOCDI",14,0)
 . S PSJDNM="" F  S PSJDNM=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM)) Q:PSJDNM=""!($G(PSGORQF))  D
"RTN","PSJOCDI",15,0)
 .. S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON)) Q:PSJPON=""!($G(PSGORQF))  D
"RTN","PSJOCDI",16,0)
 ... F PSJDN=0:0 S PSJDN=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN)) Q:'PSJDN!($G(PSGORQF))  D SORTORD
"RTN","PSJOCDI",17,0)
 I $O(PSJOCLST(""))="" Q
"RTN","PSJOCDI",18,0)
 D CRITICAL
"RTN","PSJOCDI",19,0)
 D DSPLOC
"RTN","PSJOCDI",20,0)
 I $D(^TMP($J,"PSJPRE","OUT","DRUGDRUG","S")) D
"RTN","PSJOCDI",21,0)
 . W !,"*** REFER TO MONOGRAPH FOR SIGNIFICANT INTERACTION CLINICAL EFFECTS",!
"RTN","PSJOCDI",22,0)
 D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",23,0)
 W !
"RTN","PSJOCDI",24,0)
 D MON^PSJMON(.PSJMON)
"RTN","PSJOCDI",25,0)
 D:$G(PSJONFLG) INTERV
"RTN","PSJOCDI",26,0)
 Q
"RTN","PSJOCDI",27,0)
DSPLOC ;Display drug drug interaction - sorted by severity, prospective drug (50,.01), profile drug (VAgen name), package, seq#
"RTN","PSJOCDI",28,0)
 NEW PSJDN,PSJDNV,PSJPON,PSJP,PSJX,X,PSJXSEV,PSJXNM,PSJXNM1,PSJXSORT,PSJXDN,PSJSORT,PSJPSPEC,PSJPROFL,PSJ2,PSJSEV,PSJHDRS,PSJDSPON
"RTN","PSJOCDI",29,0)
 ;
"RTN","PSJOCDI",30,0)
 K PSJPAUSE
"RTN","PSJOCDI",31,0)
 ;Get the last drug in the sort list so a '=' line is printed instead of '.'
"RTN","PSJOCDI",32,0)
 S PSJLINE=".",PSJHDRS=""
"RTN","PSJOCDI",33,0)
 S PSJXSEV=$O(PSJOCLST(""),-1)
"RTN","PSJOCDI",34,0)
 S PSJXNM=$O(PSJOCLST(PSJXSEV,""),-1)
"RTN","PSJOCDI",35,0)
 S PSJXNM1=$O(PSJOCLST(PSJXSEV,PSJXNM,""),-1)
"RTN","PSJOCDI",36,0)
 S PSJXSORT=$O(PSJOCLST(PSJXSEV,PSJXNM,PSJXNM1,""),-1)
"RTN","PSJOCDI",37,0)
 S PSJXDN=$O(PSJOCLST(PSJXSEV,PSJXNM,PSJXNM1,PSJXSORT,""),-1)
"RTN","PSJOCDI",38,0)
 ;
"RTN","PSJOCDI",39,0)
 ;S PSJSEV="" F  S PSJSEV=$O(PSJOCLST(PSJSEV)) Q:PSJSEV=""  D
"RTN","PSJOCDI",40,0)
 ;Displaying Critical orders
"RTN","PSJOCDI",41,0)
 S PSJSEV="C"
"RTN","PSJOCDI",42,0)
 I $D(PSJCRTCL) D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",43,0)
 F PSJSORT=0:0 S PSJSORT=$O(PSJCRTCL(PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",44,0)
 . F PSJGROUP=0:0 S PSJGROUP=$O(PSJCRTCL(PSJSORT,PSJGROUP)) Q:'PSJGROUP  D
"RTN","PSJOCDI",45,0)
 .. S X=$G(PSJCRTCL(PSJSORT,PSJGROUP))
"RTN","PSJOCDI",46,0)
 .. D DSPCRTCL($P(X,U),$P(X,U,2))
"RTN","PSJOCDI",47,0)
 ;Displaying Significant orders
"RTN","PSJOCDI",48,0)
 K PSJDSPON
"RTN","PSJOCDI",49,0)
 S PSJSEV="S"
"RTN","PSJOCDI",50,0)
 S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",51,0)
 . D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",52,0)
 . F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",53,0)
 .. F PSJ2=0:0 S PSJ2=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",54,0)
 ... S PSJDNV=PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT,PSJ2)
"RTN","PSJOCDI",55,0)
 ... D DISPON
"RTN","PSJOCDI",56,0)
 . W !
"RTN","PSJOCDI",57,0)
 Q
"RTN","PSJOCDI",58,0)
DSPCRTCL(PSJPSPEC,PSJPROFL) ;Display Critical orders
"RTN","PSJOCDI",59,0)
 NEW PSJSORT,PSJ2
"RTN","PSJOCDI",60,0)
 Q:$G(PSJPSPEC)=""
"RTN","PSJOCDI",61,0)
 Q:$G(PSJPROFL)=""
"RTN","PSJOCDI",62,0)
 F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",63,0)
 . F PSJ2=0:0 S PSJ2=$O(PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",64,0)
 .. S PSJDNV=PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)
"RTN","PSJOCDI",65,0)
 .. D DISPON
"RTN","PSJOCDI",66,0)
 Q
"RTN","PSJOCDI",67,0)
DISPON ; Display orders & clin effects if applied.
"RTN","PSJOCDI",68,0)
 F X=1:1:10 S PSJP(X)=$P(PSJDNV,U,X)
"RTN","PSJOCDI",69,0)
 I ($G(PSJHDR)'=$P(PSJDNV,U,3))!(PSJHDRS'=PSJSEV) S PSJHDR=$P(PSJDNV,U,3),PSJHDRS=PSJSEV K PSJDSPON D HDR(PSJHDR)
"RTN","PSJOCDI",70,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",71,0)
 I PSJSORT=10 S PSJONFLG=1 D DSPDRG(PSJP(4),$P(PSJDNV,U,2))
"RTN","PSJOCDI",72,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",73,0)
 I PSJSORT>10 S PSJONFLG=1 D
"RTN","PSJOCDI",74,0)
 . I $D(PSJDSPON($P(PSJP(4),";",2))) Q
"RTN","PSJOCDI",75,0)
 . S PSJDSPON($P(PSJP(4),";",2))=""
"RTN","PSJOCDI",76,0)
 . D EN^PSODRDU2(DFN,PSJP(4),"PSJPRE")
"RTN","PSJOCDI",77,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",78,0)
 I PSJSEV=PSJXSEV,(PSJPSPEC=PSJXNM),(PSJSORT=PSJXSORT),(PSJ2=PSJXDN) S PSJLINE="="
"RTN","PSJOCDI",79,0)
 I PSJSEV="C",$$DSPLCLIN(PSJ2) D CLIN(PSJP(5),PSJP(2),PSJP(4),PSJP(1),PSJLINE)
"RTN","PSJOCDI",80,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC() W @IOF
"RTN","PSJOCDI",81,0)
 Q
"RTN","PSJOCDI",82,0)
SORTORD ;Sort drug drug output to display in order of: Inpatient, Active Rx, Remote Rx, Pending Rx, Non_VA
"RTN","PSJOCDI",83,0)
 NEW PDJDNV,PSJX
"RTN","PSJOCDI",84,0)
 S PSJDNV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN))
"RTN","PSJOCDI",85,0)
 I $E(PSJPON,1,1)'="I" D
"RTN","PSJOCDI",86,0)
 . S PSJX=$E($P(PSJPON,";"),1,1)
"RTN","PSJOCDI",87,0)
 . D OCLST($S(PSJX="O":20,PSJX="R":30,PSJX="P":40,PSJX="N":50,1:""))
"RTN","PSJOCDI",88,0)
 I $E(PSJPON,1,1)="I" D OCLST(10)
"RTN","PSJOCDI",89,0)
 Q
"RTN","PSJOCDI",90,0)
OCLST(PSJ1) ;Sort orders into array to display later
"RTN","PSJOCDI",91,0)
 ;PSJOCLST(PSJSEV("C",PSJPSPEC,PSJPROFL,PSJ1-package,PSJ2)=P1...P6 (P1=SEQ NO, P2=Drug Name(Profile), P3=Drug Name(Prospective)
"RTN","PSJOCDI",92,0)
 ;  (P4=Pharm order# ,P5=Severity, P6=P3 IEN)
"RTN","PSJOCDI",93,0)
 ;PSJOCLST(PSJSEV("S",PSJPSPEC,PSJ1-package,PSJ2)=P1...P6 (P1=SEQ NO, P2=Drug Name(Profile), P3=Drug Name(Prospective)
"RTN","PSJOCDI",94,0)
 ;  (P4=Pharm order# ,P5=Severity, P6=P3 IEN)
"RTN","PSJOCDI",95,0)
 ;PSJSEV: Sort first by severity
"RTN","PSJOCDI",96,0)
 ;PSJ1: 10=PSJ Order
"RTN","PSJOCDI",97,0)
 ;      20=PSO Active Rx
"RTN","PSJOCDI",98,0)
 ;      30=Remote Rx
"RTN","PSJOCDI",99,0)
 ;      40=PSO pending
"RTN","PSJOCDI",100,0)
 ;      50=Non-VA
"RTN","PSJOCDI",101,0)
 ;PSJ2: A counter
"RTN","PSJOCDI",102,0)
 NEW PSJDNV,PSJMONTI,PSJMONV,PSJVAGEN,PSJON1,PSJON2,PSJONFG,PSJPSPEC,PSJPROFL
"RTN","PSJOCDI",103,0)
 Q:'$G(PSJ1)
"RTN","PSJOCDI",104,0)
 S PSJ2=$G(PSJ2)+1
"RTN","PSJOCDI",105,0)
 S PSJDNV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN))
"RTN","PSJOCDI",106,0)
 S PSJPSPEC=$P(PSJDNV,U,4) S:PSJPSPEC="" PSJPSPEC="UNKNOWN DRUG NAME"
"RTN","PSJOCDI",107,0)
 ; Criticals are grouped by profile VAGEN name and then package type
"RTN","PSJOCDI",108,0)
 I PSJSEV="C" D
"RTN","PSJOCDI",109,0)
 . S PSJVAGEN=$$VAGEN^PSJMISC(+$P(PSJDNV,U,3)) I PSJVAGEN="" S PSJVAGEN=PSJDNM
"RTN","PSJOCDI",110,0)
 . S PSJOCLST(PSJSEV,PSJPSPEC,PSJVAGEN,PSJ1,PSJ2)=PSJDN_U_$G(PSJDNM)_U_$P(PSJDNV,U,4)_U_PSJPON_U_PSJSEV_U_$P(PSJDNV,U,2)
"RTN","PSJOCDI",111,0)
 ; Significants are grouped by package type so Inpatient orders display first
"RTN","PSJOCDI",112,0)
 I PSJSEV="S" D 
"RTN","PSJOCDI",113,0)
 . S PSJOCLST(PSJSEV,PSJPSPEC,PSJ1,PSJ2)=PSJDN_U_$G(PSJDNM)_U_$P(PSJDNV,U,4)_U_PSJPON_U_PSJSEV_U_$P(PSJDNV,U,2)
"RTN","PSJOCDI",114,0)
 S PSJMONTI=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN,"PMON",3,0))
"RTN","PSJOCDI",115,0)
 S PSJMONTI=$P(PSJMONTI,"MONOGRAPH TITLE:  ",2) Q:PSJMONTI=""
"RTN","PSJOCDI",116,0)
 S PSJVAGEN=$$VAGEN^PSJMISC(+$P(PSJDNV,U,3))
"RTN","PSJOCDI",117,0)
 I PSJVAGEN="",'+$P(PSJDNV,U,3) S PSJVAGEN=$$GENVUID^PSJMISC($G(PSJRDI(PSJPON)))
"RTN","PSJOCDI",118,0)
 Q:PSJVAGEN=""
"RTN","PSJOCDI",119,0)
 S PSJVAGEN=PSJVAGEN_"+"_$P(PSJDNV,U,4)
"RTN","PSJOCDI",120,0)
 S PSJMONV=$G(PSJMON(PSJVAGEN,PSJMONTI))
"RTN","PSJOCDI",121,0)
 I PSJMONTI]"" D
"RTN","PSJOCDI",122,0)
 . S $P(PSJMON(PSJVAGEN,PSJMONTI),U,1,7)=PSJDN_U_$G(PSJDNM)_U_+$P(PSJDNV,U,3)_U_$P(PSJDNV,U,4)_U_+$P(PSJDNV,U,2)_U_PSJPON_U_PSJSEV
"RTN","PSJOCDI",123,0)
 . S $P(PSJMON(PSJVAGEN,PSJMONTI),U,11)=PSJVAGEN
"RTN","PSJOCDI",124,0)
 I PSJMONV]"" D
"RTN","PSJOCDI",125,0)
 . I $P(PSJMONV,U,7)'=PSJSEV S $P(PSJMON(PSJVAGEN,PSJMONTI),U,9)=1
"RTN","PSJOCDI",126,0)
 . S PSJONFG=0
"RTN","PSJOCDI",127,0)
 . S PSJON1=$P($P(PSJMONV,U,6),";")
"RTN","PSJOCDI",128,0)
 . S PSJON2=$P(PSJPON,";")
"RTN","PSJOCDI",129,0)
 . I PSJON1="I",PSJON2'="I" S PSJONFG=1
"RTN","PSJOCDI",130,0)
 . I PSJON1'="I",PSJON2="I" S PSJONFG=1
"RTN","PSJOCDI",131,0)
 . I PSJONFG S $P(PSJMON(PSJVAGEN,PSJMONTI),U,10)=1
"RTN","PSJOCDI",132,0)
 K PSJON1,PSJON2,PSJONFG
"RTN","PSJOCDI",133,0)
 Q
"RTN","PSJOCDI",134,0)
CLIN(PSJSEV,PSJDNM,PSJPON,PSJDN,PSJLINE) ;
"RTN","PSJOCDI",135,0)
 ;No longer need to display the clinical effect for Significant
"RTN","PSJOCDI",136,0)
 Q:PSJSEV="S"
"RTN","PSJOCDI",137,0)
 NEW PSJCLINV,PSJNDX,PSJX
"RTN","PSJOCDI",138,0)
 I $G(PSJLINE)="" S PSJLINE="."
"RTN","PSJOCDI",139,0)
 F PSJDNX=0:0 S PSJDNX=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDNX)) Q:'PSJDNX  D
"RTN","PSJOCDI",140,0)
 . S PSJCLINV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDNX,"CLIN"))
"RTN","PSJOCDI",141,0)
 . W !
"RTN","PSJOCDI",142,0)
 . S PSJX=$P(PSJCLINV,"CLINICAL EFFECTS:  ",2) I ($Y+($L(PSJX)\65)+4)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",143,0)
 . D WRITE^PSJMISC(PSJX)
"RTN","PSJOCDI",144,0)
 W !
"RTN","PSJOCDI",145,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(0,0) W @IOF
"RTN","PSJOCDI",146,0)
 Q
"RTN","PSJOCDI",147,0)
INTERV ;Log intervention.  Required for Critical.
"RTN","PSJOCDI",148,0)
 ;Critical interaction MUST log an intervention before continue with the order
"RTN","PSJOCDI",149,0)
 ;Only log one intervention for a prospective drug & log it for the higher severity
"RTN","PSJOCDI",150,0)
 NEW PSJSEV,PSJDD,PSJDN,PSJNDV,PSJTYPE,PSJINTVD,PSJPROFL
"RTN","PSJOCDI",151,0)
 K PSJDDSV,PSJINTVD
"RTN","PSJOCDI",152,0)
 ;Required intervention for each of the prospective drug with critical interactions
"RTN","PSJOCDI",153,0)
 F PSJSEV="C" Q:$G(PSGORQF)  S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",154,0)
 . S PSJPROFL="" F  S PSJPROFL=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL)) Q:PSJPROFL=""  D
"RTN","PSJOCDI",155,0)
 .. F PSJTYPE=0:0 S PSJTYPE=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE)) Q:'PSJTYPE  D
"RTN","PSJOCDI",156,0)
 ... F PSJDN=0:0 S PSJDN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE,PSJDN)) Q:'PSJDN  Q:$G(PSGORQF)  D
"RTN","PSJOCDI",157,0)
 .... S PSJNDV=$G(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE,PSJDN)),PSJDD=$P(PSJNDV,U,6)
"RTN","PSJOCDI",158,0)
 .... ;I ($P($P(PSJNDV,U,4),";",1)="I"),('$D(PSJINTVD($P(PSJNDV,U,3)))) D
"RTN","PSJOCDI",159,0)
 .... I '$D(PSJINTVD($P(PSJNDV,U,3))) D
"RTN","PSJOCDI",160,0)
 ..... S (PSJINTVD($P(PSJNDV,U,3)))=""
"RTN","PSJOCDI",161,0)
 ..... D RINTERV^PSJGMRA("CRITICAL DRUG INTERACTION",$P(PSJNDV,U,3))
"RTN","PSJOCDI",162,0)
 ;
"RTN","PSJOCDI",163,0)
 ; Optional intervention for each of the prospective drug(not the same as critical) with significant interactions
"RTN","PSJOCDI",164,0)
 F PSJSEV="S" Q:$G(PSGORQF)  S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",165,0)
 . F PSJTYPE=0:0 S PSJTYPE=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE)) Q:'PSJTYPE  D
"RTN","PSJOCDI",166,0)
 .. F PSJDN=0:0 S PSJDN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE,PSJDN)) Q:'PSJDN  Q:$G(PSGORQF)  D
"RTN","PSJOCDI",167,0)
 ... S PSJNDV=$G(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE,PSJDN)),PSJDD=$P(PSJNDV,U,6)
"RTN","PSJOCDI",168,0)
 ... I '$D(PSJINTVD($P(PSJNDV,U,3))) D
"RTN","PSJOCDI",169,0)
 .... S (PSJINTVD($P(PSJNDV,U,3)))=""
"RTN","PSJOCDI",170,0)
 .... D INTERV^PSJGMRA("SIGNIFICANT DRUG INTERACTION",$P(PSJNDV,U,3))
"RTN","PSJOCDI",171,0)
 Q
"RTN","PSJOCDI",172,0)
HDR(PSJDNM) ;Display the intro text on drug interaction
"RTN","PSJOCDI",173,0)
 W !,"This patient is receiving the following order(s) that have a "
"RTN","PSJOCDI",174,0)
 W $S($G(PSJSEV)="C":"CRITICAL",$G(PSJSEV)="S":"SIGNIFICANT",1:"")_" Drug"
"RTN","PSJOCDI",175,0)
 W !,"Interaction with "_$G(PSJDNM)_":",!
"RTN","PSJOCDI",176,0)
 Q
"RTN","PSJOCDI",177,0)
DSPDRG(PSJPON,PSJDNM) ;Display order info or drug name from prospective.
"RTN","PSJOCDI",178,0)
 Q:$G(PSJPON)=""
"RTN","PSJOCDI",179,0)
 I $P(PSJPON,";",3)="PROSPECTIVE" W !?8,$G(PSJDNM),! Q
"RTN","PSJOCDI",180,0)
 I $D(PSJDSPON($P(PSJPON,";",2))) Q
"RTN","PSJOCDI",181,0)
 S PSJDSPON($P(PSJPON,";",2))=""
"RTN","PSJOCDI",182,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",183,0)
 D DSPORD^PSJOC($P(PSJPON,";",2))
"RTN","PSJOCDI",184,0)
 Q
"RTN","PSJOCDI",185,0)
RDIVUID ;Loop thru the "IN" global to store the VUID for remote Rx
"RTN","PSJOCDI",186,0)
 NEW PSJPON,PSJVUID
"RTN","PSJOCDI",187,0)
 K PSJRDI
"RTN","PSJOCDI",188,0)
 S PSJPON=""
"RTN","PSJOCDI",189,0)
 F  S PSJPON=$O(^TMP($J,"PSJPRE","IN","PROFILE",PSJPON)) Q:PSJPON=""  I $E(PSJPON,1,1)="R" D
"RTN","PSJOCDI",190,0)
 . S PSJVUID=$P($G(^TMP($J,"PSJPRE","IN","PROFILE",PSJPON)),U,2)
"RTN","PSJOCDI",191,0)
 . S:+PSJVUID PSJRDI(PSJPON)=PSJVUID
"RTN","PSJOCDI",192,0)
 Q
"RTN","PSJOCDI",193,0)
DSPLCLIN(PSJ2) ;If the next drug on the list is diff the flag to display the clin effects.
"RTN","PSJOCDI",194,0)
 NEW PSJCLINC,PSJCLINN,PSJDNVC,PSJDNVN,PSJPC,PSJPN,PSJ2N,PSJSORTN
"RTN","PSJOCDI",195,0)
 I $G(PSJ2)="" Q 0
"RTN","PSJOCDI",196,0)
 S PSJDNVC=PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)
"RTN","PSJOCDI",197,0)
 F X=1:1:10 S PSJPC(X)=$P(PSJDNVC,U,X)
"RTN","PSJOCDI",198,0)
 S PSJ2N=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2))
"RTN","PSJOCDI",199,0)
 I 'PSJ2N S PSJSORTN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORTN 1
"RTN","PSJOCDI",200,0)
 S PSJ2N=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,0)) Q:'PSJ2N 1
"RTN","PSJOCDI",201,0)
 S PSJDNVN=PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2N)
"RTN","PSJOCDI",202,0)
 F X=1:1:10 S PSJPN(X)=$P(PSJDNVN,U,X)
"RTN","PSJOCDI",203,0)
 I $S(PSJPC(5)="":1,PSJPC(2)="":1,PSJPC(4)="":1,'+PSJPC(1):1,PSJPN(5)="":1,PSJPN(2)="":1,PSJPN(4)="":1,'+PSJPN(1):1,1:0) Q 0
"RTN","PSJOCDI",204,0)
 S PSJCLINC=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJPC(5),PSJPC(2),PSJPC(4),PSJPC(1),"CLIN"))
"RTN","PSJOCDI",205,0)
 S PSJCLINN=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJPN(5),PSJPN(2),PSJPN(4),PSJPN(1),"CLIN"))
"RTN","PSJOCDI",206,0)
 I (PSJCLINC'=PSJCLINN) Q 1
"RTN","PSJOCDI",207,0)
 Q 0
"RTN","PSJOCDI",208,0)
CRITICAL ;
"RTN","PSJOCDI",209,0)
 NEW PSJGROUP,PSJNEXT
"RTN","PSJOCDI",210,0)
 S PSJGROUP=0,PSJNEXT=0
"RTN","PSJOCDI",211,0)
 S PSJSEV="C"
"RTN","PSJOCDI",212,0)
 S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",213,0)
 . S PSJPROFL="" F  S PSJPROFL=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL)) Q:PSJPROFL=""  D
"RTN","PSJOCDI",214,0)
 .. S PSJNEXT=0
"RTN","PSJOCDI",215,0)
 .. S PSJGROUP=PSJGROUP+1
"RTN","PSJOCDI",216,0)
 .. F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",217,0)
 ... Q:PSJNEXT
"RTN","PSJOCDI",218,0)
 ... F PSJ2=0:0 S PSJ2=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",219,0)
 .... Q:PSJNEXT
"RTN","PSJOCDI",220,0)
 .... S PSJCRTCL(PSJSORT,PSJGROUP)=PSJPSPEC_U_PSJPROFL
"RTN","PSJOCDI",221,0)
 .... S PSJNEXT=1
"RTN","PSJOCDI",222,0)
 Q
"RTN","PSJOCDS")
0^26^B73599009
"RTN","PSJOCDS",1,0)
PSJOCDS ;BIR/MV - SET INPUT DATA FOR DOSING ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCDS",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSJOCDS",3,0)
 ;
"RTN","PSJOCDS",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOCDS",5,0)
 ; Reference to ^PSSORPH is supported by DBIA #3234.
"RTN","PSJOCDS",6,0)
 ; Reference to ^PSSDSAPI is supported by DBIA #5425.
"RTN","PSJOCDS",7,0)
 ; Reference to ^PSSDSAPD is supported by DBIA #5426.
"RTN","PSJOCDS",8,0)
 ; Reference to FULL^VALM1 and PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOCDS",9,0)
 ;
"RTN","PSJOCDS",10,0)
 ;The Dose API will be processed separately than the DD & DT order checks
"RTN","PSJOCDS",11,0)
 ;
"RTN","PSJOCDS",12,0)
IN(PSJPON,PSJTYPE,PSJDD) ;
"RTN","PSJOCDS",13,0)
 ;PSJPON - Order number
"RTN","PSJOCDS",14,0)
 ;PSJPTYPE - UD/IV
"RTN","PSJOCDS",15,0)
 ;PSJDD - Dispense drug IEN (for UD order only)
"RTN","PSJOCDS",16,0)
 ;
"RTN","PSJOCDS",17,0)
 ;PSJOVR array is defined when OVERLAP^PSGOEF2 is called.
"RTN","PSJOCDS",18,0)
 ;
"RTN","PSJOCDS",19,0)
 NEW PSJDSOFF
"RTN","PSJOCDS",20,0)
 D FULL^VALM1
"RTN","PSJOCDS",21,0)
 S PSJDSOFF=$$DS^PSSDSAPI()
"RTN","PSJOCDS",22,0)
 I '+PSJDSOFF D DOSEOFF^PSJOCDSD($P(PSJDSOFF,U,2)) Q
"RTN","PSJOCDS",23,0)
 NEW PSJOCDS,PSJFDB,PSJBASE,PSJOVR,PSJOVRLP,PSJX
"RTN","PSJOCDS",24,0)
 K PSJOCDS,PSJFDB
"RTN","PSJOCDS",25,0)
 I '$$PING^PSJOC("Maximum Single Dose Check could not be performed") Q
"RTN","PSJOCDS",26,0)
 K ^TMP($J,"PSJPRE"),^TMP($J,"PSJPRE1")
"RTN","PSJOCDS",27,0)
 S PSJBASE(1)="PSJPRE",PSJBASE(3)="PSJPRE1"
"RTN","PSJOCDS",28,0)
 ;
"RTN","PSJOCDS",29,0)
 ;;**** Commented out complex dosing
"RTN","PSJOCDS",30,0)
 ;;PSJOCDSC("CX","PSJCOM") is to flag if dosing checks needs to handle complex orders.
"RTN","PSJOCDS",31,0)
 ;;*I '$D(PSJOCDSC("CX","PSJCOM")) D
"RTN","PSJOCDS",32,0)
 ;;*. I $G(PSJCOM),$$CONJ^PSJOCDSC() S PSJOCDSC("CX","PSJCOM")=1
"RTN","PSJOCDS",33,0)
 ;;*I $G(PSJOCDSC("CX","PSJCOM")),'$D(PSJOCDSC("CX","ACX")) D SETLST^PSJOCDSC(PSJPON)
"RTN","PSJOCDS",34,0)
 ;;*I PSJTYPE="UD" D UD I $G(PSJOCDSC("CX","PSJCOM")) D COMPLEX^PSJOCDSC Q
"RTN","PSJOCDS",35,0)
 ;;*I PSJTYPE="IV" D IN^PSIVOCDS("PSJPRE") D:$G(PSJOCDSC("CX","PSJCOM")) IV^PSJOCDSC(PSJPON),UPDLST^PSJOCDSC(PSJPON,2)
"RTN","PSJOCDS",36,0)
 ;;**** End Complex dosing
"RTN","PSJOCDS",37,0)
 ;
"RTN","PSJOCDS",38,0)
 ;;****To be removed when complex dosing is ready
"RTN","PSJOCDS",39,0)
 I PSJTYPE="UD" D UD
"RTN","PSJOCDS",40,0)
 I PSJTYPE="IV" D IN^PSIVOCDS("PSJPRE")
"RTN","PSJOCDS",41,0)
 ;;****END
"RTN","PSJOCDS",42,0)
 ;
"RTN","PSJOCDS",43,0)
 I '$D(PSJFDB) Q
"RTN","PSJOCDS",44,0)
 ;;*If complex order then set conjunction to "Then" so low dose warning is screened out.
"RTN","PSJOCDS",45,0)
 ;;*I $G(PSJCOM),$$ALLTHEN^PSJOCDSC() D
"RTN","PSJOCDS",46,0)
 ;;*. F PSJX=0:0 S PSJX=$O(PSJOCDS(PSJX)) Q:'PSJX  S PSJOCDS(PSJX,"CONJ")="T"
"RTN","PSJOCDS",47,0)
 D DOSE^PSSDSAPD(.PSJBASE,DFN,.PSJOCDS,.PSJFDB)
"RTN","PSJOCDS",48,0)
 D DISPLAY^PSJOCDSD
"RTN","PSJOCDS",49,0)
 ;I '$G(PSGORQF),(PSJTYPE="IV"),$G(PSJOCDSC("CX","PSJCOM")) D NODAILY^PSJOCDSP(PSJPON)
"RTN","PSJOCDS",50,0)
 K ^TMP($J,"PSJPRE"),^TMP($J,"PSJPRE1")
"RTN","PSJOCDS",51,0)
 Q
"RTN","PSJOCDS",52,0)
UD ;Process data from a UD order
"RTN","PSJOCDS",53,0)
 NEW PSJDS,PSJFREQ,X
"RTN","PSJOCDS",54,0)
 ;At this state a dispense drug should be selected already.  But just incase...
"RTN","PSJOCDS",55,0)
 Q:'+PSJDD
"RTN","PSJOCDS",56,0)
 K PSJOCDS,PSJFDB
"RTN","PSJOCDS",57,0)
 ;If the drug is to be exempted then exclude it from the dose check
"RTN","PSJOCDS",58,0)
 Q:$$EXMT^PSSDSAPI(PSJDD)
"RTN","PSJOCDS",59,0)
 S PSJCNT=1
"RTN","PSJOCDS",60,0)
 S PSJDS=""
"RTN","PSJOCDS",61,0)
 ;
"RTN","PSJOCDS",62,0)
 S X=$$DOSE()
"RTN","PSJOCDS",63,0)
 S PSJOCDS(PSJCNT,"DRG_AMT")=$P(X,U)
"RTN","PSJOCDS",64,0)
 S PSJOCDS(PSJCNT,"DRG_UNIT")=$P(X,U,2)
"RTN","PSJOCDS",65,0)
 S PSJOCDS(PSJCNT,"DO")=$P(X,U,3)
"RTN","PSJOCDS",66,0)
 ;
"RTN","PSJOCDS",67,0)
 S X=$$DATES(PSJPON)
"RTN","PSJOCDS",68,0)
 S X=$$DURATION($P(X,U),$P(X,U,2))
"RTN","PSJOCDS",69,0)
 ;S X=$$DURATION($G(PSGSD),$G(PSGFD))
"RTN","PSJOCDS",70,0)
 S PSJOCDS(PSJCNT,"DRATE")=$S(+X:X_"M",1:"")
"RTN","PSJOCDS",71,0)
 ;S PSJOCDS(PSJCNT,"DUR")=X
"RTN","PSJOCDS",72,0)
 ;S PSJOCDS(PSJCNT,"DUR_RT")=$S(+X:"MINUTE",1:"")
"RTN","PSJOCDS",73,0)
 S PSJOCDS(PSJCNT,"MR_IEN")=$G(PSGMR)
"RTN","PSJOCDS",74,0)
 S PSJOCDS(PSJCNT,"SCHEDULE")=$G(PSGSCH)
"RTN","PSJOCDS",75,0)
 D FDBDATA
"RTN","PSJOCDS",76,0)
 ;D LITER
"RTN","PSJOCDS",77,0)
 Q
"RTN","PSJOCDS",78,0)
FDBDATA ;Set data needed by FDB's Dose API
"RTN","PSJOCDS",79,0)
 ;Use the OI + Dosage form when display drug name.  If OI IEN doesn't exist, use DD name
"RTN","PSJOCDS",80,0)
 NEW PSJOINM,PSJXSCH,X
"RTN","PSJOCDS",81,0)
 S PSJFDB(PSJCNT,"RX_NUM")="I;"_PSJPON_";PROSPECTIVE;"_PSJCNT
"RTN","PSJOCDS",82,0)
 S PSJFDB(PSJCNT,"DRUG_IEN")=PSJDD
"RTN","PSJOCDS",83,0)
 S PSJOINM=$$DRGNM^PSGSICHK()
"RTN","PSJOCDS",84,0)
 S PSJFDB(PSJCNT,"DRUG_NM")=$S(PSJOINM]"":PSJOINM,1:$$DN^PSJMISC(+PSJDD))
"RTN","PSJOCDS",85,0)
 I PSJOCDS(PSJCNT,"DO")=(PSJOCDS(PSJCNT,"DRG_AMT")_PSJOCDS(PSJCNT,"DRG_UNIT")) D
"RTN","PSJOCDS",86,0)
 . Q:PSJOCDS(PSJCNT,"DO")=""
"RTN","PSJOCDS",87,0)
 .;Strip off leading zero otherwise FDB triggers an "Invalid or Undefined Dose"
"RTN","PSJOCDS",88,0)
 . S X=PSJOCDS(PSJCNT,"DRG_AMT")
"RTN","PSJOCDS",89,0)
 . S PSJFDB(PSJCNT,"DOSE_AMT")=$S(+X=0:X,1:+X)
"RTN","PSJOCDS",90,0)
 . S PSJFDB(PSJCNT,"DOSE_UNIT")=$$UNIT^PSSDSAPI(PSJOCDS(PSJCNT,"DRG_UNIT"))
"RTN","PSJOCDS",91,0)
 S PSJFDB(PSJCNT,"DOSE_RATE")="DAY"
"RTN","PSJOCDS",92,0)
 ;
"RTN","PSJOCDS",93,0)
 S X="",PSJXSCH=PSGSCH
"RTN","PSJOCDS",94,0)
 I $G(PSGS0XT)="" S PSGS0XT=$$DOW^PSJAPIDS(PSGSCH)
"RTN","PSJOCDS",95,0)
 I $G(PSGS0XT)="D",$G(PSGS0Y)]"" S $P(PSJXSCH,"@",2)=$G(PSGS0Y)
"RTN","PSJOCDS",96,0)
 I $G(PSGSCH)]"" S X=$P($$FRQ^PSSDSAPI(PSJXSCH,$G(PSGS0XT),"I"),U)
"RTN","PSJOCDS",97,0)
 I X="" S X=1 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSJOCDS",98,0)
 S PSJFDB(PSJCNT,"FREQ")=X
"RTN","PSJOCDS",99,0)
 S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSJOCDS",100,0)
 S PSJFDB(PSJCNT,"DURATION_RT")="DAY"
"RTN","PSJOCDS",101,0)
 S PSJFDB(PSJCNT,"ROUTE")=$P($$MRT^PSSDSAPI($G(PSGMR)),U,2)
"RTN","PSJOCDS",102,0)
 S PSJFDB(PSJCNT,"DOSE_TYPE")="MAINTENANCE"
"RTN","PSJOCDS",103,0)
 S PSJFDB(PSJCNT,"SPECIFIC")=1
"RTN","PSJOCDS",104,0)
 ;Set data for onetime or <24 hours order
"RTN","PSJOCDS",105,0)
 S X=$$ONE^PSJORPOE($G(PSGSCH))
"RTN","PSJOCDS",106,0)
 I +X!($G(PSGST)="O")!+$$ONCALL^PSJMISC($G(PSGSCH),$G(PSGST)) D  Q
"RTN","PSJOCDS",107,0)
 . K PSJFDB(PSJCNT,"FRQ_ERROR")
"RTN","PSJOCDS",108,0)
 . S PSJFDB(PSJCNT,"DOSE_TYPE")="SINGLE DOSE"
"RTN","PSJOCDS",109,0)
 . S PSJFDB(PSJCNT,"DURATION")=1
"RTN","PSJOCDS",110,0)
 . S PSJFDB(PSJCNT,"DURATION_RT")=PSJFDB(PSJCNT,"DURATION_RT")
"RTN","PSJOCDS",111,0)
 . S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSJOCDS",112,0)
 I +PSJOCDS(PSJCNT,"DRATE") D UND24HRS(+PSJOCDS(PSJCNT,"DRATE"),$G(PSGAT),$G(PSGS0XT),PSGSD,PSGFD,PSGSCH)
"RTN","PSJOCDS",113,0)
 Q
"RTN","PSJOCDS",114,0)
LITER ;FDB requires "L" instead of ML for the particular conditions below
"RTN","PSJOCDS",115,0)
 ;PSJ*5*252 (6/29/11)- This module is longer called since FDB handles either "ML" or "L" now.
"RTN","PSJOCDS",116,0)
 NEW PSJXDO
"RTN","PSJOCDS",117,0)
 Q:'$G(PSJDD)
"RTN","PSJOCDS",118,0)
 Q:$G(PSJFDB(1,"ROUTE"))'="INTRAVENOUS"
"RTN","PSJOCDS",119,0)
 Q:$G(PSGST)'="R"
"RTN","PSJOCDS",120,0)
 Q:$$VAGEN^PSJMISC(PSJDD)'["POTASSIUM"
"RTN","PSJOCDS",121,0)
 Q:$$CLASS^PSJMISC(PSJDD)'="TN102"
"RTN","PSJOCDS",122,0)
 S PSJXDO=PSJOCDS(PSJCNT,"DO")
"RTN","PSJOCDS",123,0)
 I PSJXDO["ML" D
"RTN","PSJOCDS",124,0)
 . Q:'+PSJXDO
"RTN","PSJOCDS",125,0)
 . S (PSJOCDS(PSJCNT,"DRG_AMT"),PSJFDB(PSJCNT,"DOSE_AMT"))=+(+PSJXDO/1000)
"RTN","PSJOCDS",126,0)
 . S (PSJOCDS(1,"DRG_UNIT"),PSJFDB(PSJCNT,"DOSE_UNIT"))="L"
"RTN","PSJOCDS",127,0)
 Q
"RTN","PSJOCDS",128,0)
UND24HRS(PSJDUR,PSGAT,PSGS0XT,PSGSD,PSGFD,PSGSCH) ;
"RTN","PSJOCDS",129,0)
 ;*** This line tag is called by ^PSIVOCDS also ***
"RTN","PSJOCDS",130,0)
 ;PSJDUR - order duration in minutes
"RTN","PSJOCDS",131,0)
 ;PSGAT - admin times
"RTN","PSJOCDS",132,0)
 ;PSGS0XT - Order Frequency
"RTN","PSJOCDS",133,0)
 NEW PSJNDOSE,PSJFRQ1,PSJFRQ2,PSJFRQX,PSJX
"RTN","PSJOCDS",134,0)
 Q:'+$G(PSJDUR)
"RTN","PSJOCDS",135,0)
 ; Set frequency to # of amdin times
"RTN","PSJOCDS",136,0)
 I ($G(PSGAT)]"") D  Q
"RTN","PSJOCDS",137,0)
 . S PSJX=$$DATES(PSJPON)
"RTN","PSJOCDS",138,0)
 . S PSJNDOSE=$$CNTDOSE($P(PSJX,U),$P(PSJX,U,2))
"RTN","PSJOCDS",139,0)
 . I PSJNDOSE S PSJFDB(PSJCNT,"FREQ")=PSJNDOSE Q
"RTN","PSJOCDS",140,0)
 ; Set frequency based on frequency(51.1)
"RTN","PSJOCDS",141,0)
 S PSJFRQ2=+$P($$FRQ^PSSDSAPI($G(PSGSCH),$G(PSGS0XT),"I"),U)
"RTN","PSJOCDS",142,0)
 ; If frequency is there then set freq = duration in min / freq in min
"RTN","PSJOCDS",143,0)
 I +$G(PSGS0XT) S PSJFRQ1=(+PSJDUR)/PSGS0XT
"RTN","PSJOCDS",144,0)
 ; Calculate freq from number of dose admin per day
"RTN","PSJOCDS",145,0)
 I '+$G(PSGS0XT),PSJFRQ2 S PSJFRQ1=(PSJFRQ2/24)*(+PSJDUR/60)
"RTN","PSJOCDS",146,0)
 S PSJFDB(PSJCNT,"FREQ")=$J($G(PSJFRQ1),"",0)
"RTN","PSJOCDS",147,0)
 I PSJFDB(PSJCNT,"FREQ")'=0 Q
"RTN","PSJOCDS",148,0)
 ; If no admin times or frequency(51.1) set error
"RTN","PSJOCDS",149,0)
 S PSJFDB(PSJCNT,"FREQ")=1
"RTN","PSJOCDS",150,0)
 S PSJFDB(PSJCNT,"FRQ_ERROR")=""
"RTN","PSJOCDS",151,0)
 Q
"RTN","PSJOCDS",152,0)
CNTDOSE(PSGSD,PSGFD) ;Count # of admins to set the Freq to
"RTN","PSJOCDS",153,0)
 ;only do this if the start & stop dates are within 24 hours.
"RTN","PSJOCDS",154,0)
 NEW PSJX,PSJADMIN,PSJCNT,PSJSTRTM,PSJSTPTM,PSJDTFLG
"RTN","PSJOCDS",155,0)
 I $G(PSGAT)="" Q 0
"RTN","PSJOCDS",156,0)
 I $G(PSGSD)="" Q 0
"RTN","PSJOCDS",157,0)
 I $G(PSGFD)="" Q 0
"RTN","PSJOCDS",158,0)
 I ($$FMDIFF^XLFDT(PSGFD,PSGSD,2)/60)>1440 Q 0
"RTN","PSJOCDS",159,0)
 S PSJCNT=0
"RTN","PSJOCDS",160,0)
 S PSJSTRTM=$E($P(PSGSD,".",2)_"0000",1,4)
"RTN","PSJOCDS",161,0)
 S PSJSTPTM=$E($P(PSGFD,".",2)_"0000",1,4)
"RTN","PSJOCDS",162,0)
 S PSJDTFLG=0
"RTN","PSJOCDS",163,0)
 I $P(PSGSD,".")=$P(PSGFD,".") S PSJDTFLG=1
"RTN","PSJOCDS",164,0)
 F PSJX=1:1 S PSJADMIN=$P(PSGAT,"-",PSJX) Q:PSJADMIN=""  D
"RTN","PSJOCDS",165,0)
 . S PSJADMIN=$E($P(PSGAT,"-",PSJX)_"0000",1,4)
"RTN","PSJOCDS",166,0)
 . I PSJDTFLG D  Q
"RTN","PSJOCDS",167,0)
 .. I (PSJSTRTM'>PSJADMIN),(PSJADMIN<PSJSTPTM) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",168,0)
 . I (PSJSTRTM'>PSJADMIN) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",169,0)
 . I (PSJSTPTM>PSJADMIN) S PSJCNT=PSJCNT+1
"RTN","PSJOCDS",170,0)
 Q PSJCNT
"RTN","PSJOCDS",171,0)
DURATION(PSGSD,PSGFD) ;Figure out the duration from the start, stop dates
"RTN","PSJOCDS",172,0)
 ;Return the diff between Stop - Start date in minutes.  If > 1 day then return null
"RTN","PSJOCDS",173,0)
 NEW PSJDIFF
"RTN","PSJOCDS",174,0)
 I '$D(PSGFD)!'$D(PSGSD) Q ""
"RTN","PSJOCDS",175,0)
 S PSJDIFF=$$FMDIFF^XLFDT(PSGFD,PSGSD,2)/60
"RTN","PSJOCDS",176,0)
 I (PSJDIFF<1440) Q PSJDIFF
"RTN","PSJOCDS",177,0)
 Q ""
"RTN","PSJOCDS",178,0)
DOSE() ;Figure out the dose, unit, & dosage Ordered
"RTN","PSJOCDS",179,0)
 ;Return 3 pieces: Numeric Dose ^ Unit ^ Dosage Ordered
"RTN","PSJOCDS",180,0)
 NEW PSJDS,PSJND0,PSJND2,X,PSJX,PSJXDOX,PSJNDS,PSJALLGY
"RTN","PSJOCDS",181,0)
 S PSJDS=""
"RTN","PSJOCDS",182,0)
 ;Subsequence orders in the Complex order has the PSGDO from the first order. Get new PSGDO
"RTN","PSJOCDS",183,0)
 I $G(PSJPON)["U",$S($G(PSJCOM):1,$G(PSGRENEW):1,1:0) S PSGDO=$P($G(^PS(55,DFN,5,+PSJPON,.2)),U,2)
"RTN","PSJOCDS",184,0)
 ;If the dose & unit exist use them
"RTN","PSJOCDS",185,0)
 I +$G(PSJDOSE("DO"))_$P($G(PSJDOSE("DO")),U,2)=$G(PSGDO) Q PSJDOSE("DO")_U_$G(PSGDO)
"RTN","PSJOCDS",186,0)
 ;Get dd, dose, unit from the order
"RTN","PSJOCDS",187,0)
 I $G(PSGORD)]"",'+$G(PSJDD) D
"RTN","PSJOCDS",188,0)
 . I PSGORD["P" S PSJND2=$G(^PS(53.1,+PSGORD,.2)),PSJDD=$O(^PS(53.1,+PSGORD,1,"B",0))
"RTN","PSJOCDS",189,0)
 . I PSGORD["U" S PSJND2=$G(^PS(55,DFN,5,+PSGORD,.2)),PSJDD=$O(^PS(53.1,+DFN,5,+PSGORD,1,"B",0))
"RTN","PSJOCDS",190,0)
 ;If no numeric dose and there is a dosage ordered then get dose & unit from the order
"RTN","PSJOCDS",191,0)
 I $D(PSGORD),$G(PSGDO)]"" D
"RTN","PSJOCDS",192,0)
 . S PSJDS=$P($G(PSJND2),U,5,6)
"RTN","PSJOCDS",193,0)
 Q:+PSJDS PSJDS_U_$G(PSGDO)
"RTN","PSJOCDS",194,0)
 ;Get dispense unit per dose and figure out numeric and unit
"RTN","PSJOCDS",195,0)
 I +$G(PSJDD),($G(PSGDO)]"") D
"RTN","PSJOCDS",196,0)
 . S PSJDS=$$DOSE1()
"RTN","PSJOCDS",197,0)
 . I $P($G(PSJXDOX(1)),U,11)=$$UP^XLFSTR(PSGDO) Q:+PSJDS
"RTN","PSJOCDS",198,0)
 . S PSJDS=""
"RTN","PSJOCDS",199,0)
 . S PSJX=$G(PSJXDOX(1))
"RTN","PSJOCDS",200,0)
 . I +PSJX S X=+PSGDO/+PSJX S PSJDS=$$DOSE1(X)
"RTN","PSJOCDS",201,0)
 . I $P($G(PSJXDOX(1)),U,11)=$$UP^XLFSTR(PSGDO) Q:+PSJDS
"RTN","PSJOCDS",202,0)
 . S PSJDS=""
"RTN","PSJOCDS",203,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",204,0)
 I +$G(PSJDD),($G(PSGDO)=""),($G(PSGORD)="") D
"RTN","PSJOCDS",205,0)
 . S PSJDS=$$DOSE1($S(+$G(PSGUD):PSGUD,1:1))
"RTN","PSJOCDS",206,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",207,0)
 ;Figure out dose & unit from the dispense drug.  Dosage Ordered is required for multiple dispense drugs
"RTN","PSJOCDS",208,0)
 I $G(PSGDO)="" D
"RTN","PSJOCDS",209,0)
 . S PSJND0=$$DD53P45^PSJMISC()
"RTN","PSJOCDS",210,0)
 . I PSJND0="" S PSJND0=$G(PSGDRG)
"RTN","PSJOCDS",211,0)
 . S X=+$P(PSJND0,U,2) S PSJDS=$$DOSE1($S(X:X,1:1))
"RTN","PSJOCDS",212,0)
 Q:+PSJDS PSJDS
"RTN","PSJOCDS",213,0)
 Q "^^"_$G(PSGDO)
"RTN","PSJOCDS",214,0)
DOSE1(PSJDUP) ;
"RTN","PSJOCDS",215,0)
 ;PSJDUP - Dispense unit per dose
"RTN","PSJOCDS",216,0)
 NEW PSJDS
"RTN","PSJOCDS",217,0)
 Q:'+$G(PSJDD)
"RTN","PSJOCDS",218,0)
 K PSJXDOX
"RTN","PSJOCDS",219,0)
 S PSJDS=""
"RTN","PSJOCDS",220,0)
 D DOSE^PSSORPH(.PSJXDOX,+PSJDD,"U",,$G(PSJDUP))
"RTN","PSJOCDS",221,0)
 S:$G(PSJXDOX(1)) PSJDS=$P(PSJXDOX(1),U,1,2)_U_$P(PSJXDOX(1),U)_$P(PSJXDOX(1),U,2)
"RTN","PSJOCDS",222,0)
 Q PSJDS
"RTN","PSJOCDS",223,0)
DATES(PSJPON) ;Check the correct Start, Stop dates to use
"RTN","PSJOCDS",224,0)
 ;PSJOCDSC("CX",PSGsd/PSGfd,on)=default PSGsd/PSGfd date _^_ PSGsd/PSGfd _^_PSJFLG
"RTN","PSJOCDS",225,0)
 ;PSJP1 = Start date; PSJP2 = Stop date; PSJFLG = 1 if start or stop date has changed.
"RTN","PSJOCDS",226,0)
 ;For some reasons, PSGSD redefined to cal start date for Complex order (one with duration),
"RTN","PSJOCDS",227,0)
 ; PSGFD redefined to cal stop date.  These 2 fields reflect the default start, stop dates if they
"RTN","PSJOCDS",228,0)
 ; were edited.
"RTN","PSJOCDS",229,0)
 ;
"RTN","PSJOCDS",230,0)
 NEW PSJXSD,PSJXFD,PSJP1,PSJP2,PSJFLG,X
"RTN","PSJOCDS",231,0)
 I '+$G(PSJPON) Q $G(PSGSD)_U_$G(PSGFD)_U_0
"RTN","PSJOCDS",232,0)
 S PSJFLG=0
"RTN","PSJOCDS",233,0)
 S PSJP1=$G(PSGSD),PSJP2=$G(PSGFD)
"RTN","PSJOCDS",234,0)
 I $D(PSJOCDSC("CX","PSGSD")) D
"RTN","PSJOCDS",235,0)
 . S PSJXSD=$G(PSJOCDSC("CX","PSGSD",+PSJPON))
"RTN","PSJOCDS",236,0)
 . S PSJXFD=$G(PSJOCDSC("CX","PSGFD",+PSJPON))
"RTN","PSJOCDS",237,0)
 . I PSGSD=$P(PSJXSD,U,2) S PSJP1=$P(PSJXSD,U)
"RTN","PSJOCDS",238,0)
 .;
"RTN","PSJOCDS",239,0)
 . I $P(PSJXFD,U,2)]"",(PSGFD=$P(PSJXFD,U,2)) S PSJP2=$P(PSJXFD,U)
"RTN","PSJOCDS",240,0)
 . I $P(PSJXFD,U,2)="" S $P(PSJXFD,U,2)=PSGFD,PSJP2=PSGFD
"RTN","PSJOCDS",241,0)
 .;
"RTN","PSJOCDS",242,0)
 .; I $P(PSJXFD,U,2)="" S $P(PSJXFD,U,2)=PSGFD
"RTN","PSJOCDS",243,0)
 .; I PSGFD=$P(PSJXFD,U,2) S PSJP2=$P(PSJXFD,U)
"RTN","PSJOCDS",244,0)
 . I (PSJXSD]"")!(PSJXFD]"") D
"RTN","PSJOCDS",245,0)
 .. I $S($G(PSGSD)'=$P(PSJXSD,U,2):1,$G(PSGFD)'=$P(PSJXFD,U,2):1,1:0) S PSJFLG=1
"RTN","PSJOCDS",246,0)
 . S X=$G(^PS(53.1,+PSJPON,2.5))
"RTN","PSJOCDS",247,0)
 . ;Reset PSJP1 & PSJP2 from the order is needed when complex order defaulted to IV but FN as UD,
"RTN","PSJOCDS",248,0)
 . ; the calc Start/stop dates were used therefore the duration was not considered.
"RTN","PSJOCDS",249,0)
 . I (PSJPON["P"),(PSJFLG=0),($P(X,U,2)]"") S PSJP1=$P(X,U,1),PSJP2=$P(X,U,3)
"RTN","PSJOCDS",250,0)
 Q PSJP1_U_PSJP2_U_PSJFLG
"RTN","PSJOCDSD")
0^27^B25300673
"RTN","PSJOCDSD",1,0)
PSJOCDSD ;BIR/MV - PROCESS DOSING ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCDSD",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSJOCDSD",3,0)
 ;
"RTN","PSJOCDSD",4,0)
DISPLAY ;Display dose checks
"RTN","PSJOCDSD",5,0)
 NEW PSJPON,PSJDSPFG,PSJCNT0,DR
"RTN","PSJOCDSD",6,0)
 D FULL^VALM1
"RTN","PSJOCDSD",7,0)
 Q:'$$DSPSERR^PSJOC("Maximum Single Dose Check could not be performed")
"RTN","PSJOCDSD",8,0)
 D EXCEPTN2
"RTN","PSJOCDSD",9,0)
 K PSJDSPFG
"RTN","PSJOCDSD",10,0)
 F PSJCNT0=0:0 S PSJCNT0=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0)) Q:'PSJCNT0  Q:$G(PSGORQF)  D
"RTN","PSJOCDSD",11,0)
 . S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON)) Q:PSJPON=""  Q:$G(PSGORQF)  D
"RTN","PSJOCDSD",12,0)
 .. Q:PSJPON=0
"RTN","PSJOCDSD",13,0)
 .. D ERROR
"RTN","PSJOCDSD",14,0)
 .. D EXCEPTN
"RTN","PSJOCDSD",15,0)
 .. D WARNING
"RTN","PSJOCDSD",16,0)
 K PSJDSPFG
"RTN","PSJOCDSD",17,0)
 Q
"RTN","PSJOCDSD",18,0)
DOSEOFF(PSJMSG) ;
"RTN","PSJOCDSD",19,0)
 ;Display message if dosing had turned off (once per patient session)
"RTN","PSJOCDSD",20,0)
 Q:$D(PSJEXCPT("DOSE",0))
"RTN","PSJOCDSD",21,0)
 S PSJEXCPT("DOSE",0)=""
"RTN","PSJOCDSD",22,0)
 W !!,$G(PSJMSG),!
"RTN","PSJOCDSD",23,0)
 D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",24,0)
 Q
"RTN","PSJOCDSD",25,0)
WARNING ;Display warning messages
"RTN","PSJOCDSD",26,0)
 NEW PSJSGLE,PSJRNGE,PSJMSG,PSJDD,PSJTYPE
"RTN","PSJOCDSD",27,0)
 W @IOF
"RTN","PSJOCDSD",28,0)
 S PSJMSG=""
"RTN","PSJOCDSD",29,0)
 S (PSJSGLE,PSJRNGE)=0
"RTN","PSJOCDSD",30,0)
 I '$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)),'$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",0)) W !
"RTN","PSJOCDSD",31,0)
 S PSJTYPE="" F  S PSJTYPE=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE)) Q:PSJTYPE=""  D
"RTN","PSJOCDSD",32,0)
 . W !
"RTN","PSJOCDSD",33,0)
 . F PSJDD=0:0 S PSJDD=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD)) Q:'PSJDD  D
"RTN","PSJOCDSD",34,0)
 .. Q:$G(PSGORQF)
"RTN","PSJOCDSD",35,0)
 .. S PSJMSG=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD))
"RTN","PSJOCDSD",36,0)
 .. I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",37,0)
 .. D WRITE^PSJMISC(PSJMSG,3)
"RTN","PSJOCDSD",38,0)
 .. S:PSJTYPE["1_SINGLE" PSJSGLE=1_U_PSJDD
"RTN","PSJOCDSD",39,0)
 .. S:PSJTYPE["2_RANGE" PSJRNGE=1_U_PSJDD
"RTN","PSJOCDSD",40,0)
 .. S:PSJTYPE["3_GENERAL" PSJDSPFG=1
"RTN","PSJOCDSD",41,0)
 Q:$G(PSGORQF)
"RTN","PSJOCDSD",42,0)
 D INTERV
"RTN","PSJOCDSD",43,0)
 Q
"RTN","PSJOCDSD",44,0)
INTERV ;Process intervention for dosing check
"RTN","PSJOCDSD",45,0)
 NEW PSJDD
"RTN","PSJOCDSD",46,0)
 S PSJDD=$S(+PSJSGLE:$P(PSJSGLE,U,2),1:$P(PSJRNGE,U,2))
"RTN","PSJOCDSD",47,0)
 I 'PSJDD,'$D(PSJOCFG) Q
"RTN","PSJOCDSD",48,0)
 K PSJDSPFG
"RTN","PSJOCDSD",49,0)
 W !
"RTN","PSJOCDSD",50,0)
 I +PSJSGLE,+PSJRNGE D RINTERV^PSJGMRA("MAX SINGLE DOSE & DAILY DOSE RANGE") Q
"RTN","PSJOCDSD",51,0)
 I +PSJRNGE D RINTERV^PSJGMRA("DAILY DOSE RANGE") Q
"RTN","PSJOCDSD",52,0)
 I +PSJSGLE D RINTERV^PSJGMRA("MAX SINGLE DOSE") Q
"RTN","PSJOCDSD",53,0)
 Q
"RTN","PSJOCDSD",54,0)
ERROR ; Process errors
"RTN","PSJOCDSD",55,0)
 NEW PSJCNT,PSJNV
"RTN","PSJOCDSD",56,0)
 ;PSJDSPFG - Display pause if there were errors
"RTN","PSJOCDSD",57,0)
 ;Check for system error one more time.
"RTN","PSJOCDSD",58,0)
 S PSJDSPFG=0
"RTN","PSJOCDSD",59,0)
 I $O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",0)) W !!
"RTN","PSJOCDSD",60,0)
 F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCDSD",61,0)
 . W !
"RTN","PSJOCDSD",62,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"MSG"))
"RTN","PSJOCDSD",63,0)
 . I PSJNV]"" D WRITE^PSJMISC(PSJNV,1) S PSJDSPFG=1
"RTN","PSJOCDSD",64,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"TEXT"))
"RTN","PSJOCDSD",65,0)
 . I PSJNV]"" D WRITE^PSJMISC(PSJNV,1) S PSJDSPFG=1
"RTN","PSJOCDSD",66,0)
 D:$G(PSJDSPFG) PAUSE^PSJLMUT1
"RTN","PSJOCDSD",67,0)
 Q
"RTN","PSJOCDSD",68,0)
EXCEPTN ; Process exceptions
"RTN","PSJOCDSD",69,0)
 NEW PSJCNT,PSJNV,PSJSPACE,PSJQFLG1
"RTN","PSJOCDSD",70,0)
 ;PSJDSPFG - Display pause if there were errors
"RTN","PSJOCDSD",71,0)
 ;Check for system error one more time.
"RTN","PSJOCDSD",72,0)
 ;PSJOCFG - flag when order is Renew, Copy or New OE
"RTN","PSJOCDSD",73,0)
 S PSJDSPFG=0,PSJSPACE=0
"RTN","PSJOCDSD",74,0)
 I $O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)) W !!
"RTN","PSJOCDSD",75,0)
 F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCDSD",76,0)
 . S PSJQFLG1=0
"RTN","PSJOCDSD",77,0)
 . ;I $D(PSJOCFG),$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))["Dosing Checks could not be performed",($G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT+1))["Drug not matched to NDF") Q
"RTN","PSJOCDSD",78,0)
 . I $D(PSJOCFG),($G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT+1))["Drug not matched to NDF") Q
"RTN","PSJOCDSD",79,0)
 . I $D(PSJOCFG),$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))["Drug not matched to NDF" Q
"RTN","PSJOCDSD",80,0)
 . I $D(PSJOCFG),$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))["Order Checks could not be done" Q
"RTN","PSJOCDSD",81,0)
 . I $D(PSJOCFG),$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))["Maximum Single Dose Check could not be done" Q
"RTN","PSJOCDSD",82,0)
 . S PSJDSPFG=1
"RTN","PSJOCDSD",83,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))
"RTN","PSJOCDSD",84,0)
 . I PSJNV]"" D
"RTN","PSJOCDSD",85,0)
 .. I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",86,0)
 .. ;If the output has 13 leading spaces, strip it off so the display is indenting correctly
"RTN","PSJOCDSD",87,0)
 .. I $E(PSJNV,1,13)="             " S PSJSPACE=13,PSJNV=$P(PSJNV,"             ",2)
"RTN","PSJOCDSD",88,0)
 .. D WRITE^PSJMISC(PSJNV,PSJSPACE+3)
"RTN","PSJOCDSD",89,0)
 D:$G(PSJDSPFG) PAUSE^PSJLMUT1
"RTN","PSJOCDSD",90,0)
 Q
"RTN","PSJOCDSD",91,0)
EXCEPTN2 ; Process exceptions on prospective drug
"RTN","PSJOCDSD",92,0)
 NEW PSJPON,PSJN,PSJNV
"RTN","PSJOCDSD",93,0)
 K PSJDSPFG
"RTN","PSJOCDSD",94,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOCDSD",95,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOCDSD",96,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOCDSD",97,0)
 .. I $P(PSJPON,";",3)="PROFILE" Q
"RTN","PSJOCDSD",98,0)
 .. I '$$ERRCHK^PSJOC("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOCDSD",99,0)
 .. Q:'$D(PSJOCFG)
"RTN","PSJOCDSD",100,0)
 .. W !
"RTN","PSJOCDSD",101,0)
 .. D DSPDRGER^PSJOC(1)
"RTN","PSJOCDSD",102,0)
 I $G(PSJDSPFG) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",103,0)
 Q
"RTN","PSJOCERR")
0^31^B3766638
"RTN","PSJOCERR",1,0)
PSJOCERR ;BIR/MV - ERROR HANDLING FOR ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCERR",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSJOCERR",3,0)
 ;
"RTN","PSJOCERR",4,0)
SYS() ;
"RTN","PSJOCERR",5,0)
 ;If the system is down, pause and continue with Allergy and CPRS OC
"RTN","PSJOCERR",6,0)
 I '$$PING^PSJOC() D  Q 1
"RTN","PSJOCERR",7,0)
 . K ^TMP($J,"PSJPRE")
"RTN","PSJOCERR",8,0)
 . D PAUSE^PSJMISC(1,1)
"RTN","PSJOCERR",9,0)
 . D GMRAOC^PSJOC
"RTN","PSJOCERR",10,0)
 Q 0
"RTN","PSJOCERR",11,0)
DRUG ;
"RTN","PSJOCERR",12,0)
 Q
"RTN","PSJOCERR",13,0)
ORDER ;
"RTN","PSJOCERR",14,0)
 Q
"RTN","PSJOCERR",15,0)
SETERR(PSJBASE,PSJPON,PSJCODE,PSJDNM) ;
"RTN","PSJOCERR",16,0)
 ;PSJBASE - Base(Literal value for TMP global)
"RTN","PSJOCERR",17,0)
 ;PSJPON - 4th pieces pharmacy order #
"RTN","PSJOCERR",18,0)
 ;PSJCODE - Exception code for a specific error message to be returned
"RTN","PSJOCERR",19,0)
 ;PSJDNM - Display drug name (DD or AD/SOL)
"RTN","PSJOCERR",20,0)
 I $G(PSJBASE)="" Q
"RTN","PSJOCERR",21,0)
 I $G(PSJPON)="" Q
"RTN","PSJOCERR",22,0)
 I '$G(PSJCODE) Q
"RTN","PSJOCERR",23,0)
 S ^TMP($J,PSJBASE,"IN","EXCEPTIONS","DOSE",PSJPON)=PSJCODE_U_$G(PSJDNM)
"RTN","PSJOCERR",24,0)
 Q
"RTN","PSJOCERR",25,0)
DSPERR(PSJTYPE) ;Display drug level errors
"RTN","PSJOCERR",26,0)
 ;PSJTYPE = "DRUGDRUG" or "THERAPY"
"RTN","PSJOCERR",27,0)
 ;PSJOCER(MSG_TEXT) - Array to keep track of errors that already displayed
"RTN","PSJOCERR",28,0)
 ;PSJDSPFG - If 1 then display a Pause if an error was displayed.
"RTN","PSJOCERR",29,0)
 Q:$G(PSJTYPE)=""
"RTN","PSJOCERR",30,0)
 NEW ON,PSJPON,PSJCNT,PSJMSG
"RTN","PSJOCERR",31,0)
 S PSJDSPFG=0
"RTN","PSJOCERR",32,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT",PSJTYPE,"ERROR",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOCERR",33,0)
 . F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE","OUT",PSJTYPE,"ERROR",PSJPON,PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCERR",34,0)
 .. S PSJMSG=$G(^TMP($J,"PSJPRE","OUT",PSJTYPE,"ERROR",PSJPON,PSJCNT,"MSG"))
"RTN","PSJOCERR",35,0)
 .. S PSJTXT=$G(^TMP($J,"PSJPRE","OUT",PSJTYPE,"ERROR",PSJPON,PSJCNT,"TEXT"))
"RTN","PSJOCERR",36,0)
 .. I '$$ERRCHK(PSJMSG_PSJTXT) Q
"RTN","PSJOCERR",37,0)
 .. S PSJDSPFG=1
"RTN","PSJOCERR",38,0)
 .. K PSJPAUSE
"RTN","PSJOCERR",39,0)
 .. I ($Y+6)>IOSL D PAUSE^PSJMISC(1,1) W @IOF
"RTN","PSJOCERR",40,0)
 .. I PSJMSG]"" W !! D WRITE^PSJMISC(PSJMSG)
"RTN","PSJOCERR",41,0)
 .. I PSJTXT]"" D WRITE^PSJMISC("  Reason(s): "_PSJTXT)
"RTN","PSJOCERR",42,0)
 I PSJDSPFG D PAUSE^PSJMISC(1,1) W @IOF
"RTN","PSJOCERR",43,0)
 Q
"RTN","PSJOCERR",44,0)
ERRCHK(PSJX) ;
"RTN","PSJOCERR",45,0)
 ;PSJX - Drug name_Error reason
"RTN","PSJOCERR",46,0)
 ;Return 1 if this error drug has not displayed to the user.
"RTN","PSJOCERR",47,0)
 I $G(PSJX)="" Q 0
"RTN","PSJOCERR",48,0)
 I '$D(PSJOCER(PSJX)) S PSJOCER(PSJX)="" Q 1
"RTN","PSJOCERR",49,0)
 Q 0
"RTN","PSJOCOR")
0^28^B3732046
"RTN","PSJOCOR",1,0)
PSJOCOR ;BIR/MV - DISPLAY CPRS ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCOR",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252**;16 DEC 97;Build 69
"RTN","PSJOCOR",3,0)
 ;
"RTN","PSJOCOR",4,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJOCOR",5,0)
 ; Reference to ^OROCAPI is supported by DBIA# 5367.
"RTN","PSJOCOR",6,0)
 ;
"RTN","PSJOCOR",7,0)
CPRS(PSPDRG) ;Perform Aminoglycoside checks for IV drugs
"RTN","PSJOCOR",8,0)
 ;PSPDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSJOCOR",9,0)
 ;Only need to display Aminoglycoside once for an order.  If PSJQUIT is set that means it already displayed
"RTN","PSJOCOR",10,0)
 NEW PSJDD,PSJQUIT,PSJPAUSE,PSJCNT,VAIN
"RTN","PSJOCOR",11,0)
 S PSJPAUSE=0
"RTN","PSJOCOR",12,0)
 W !!
"RTN","PSJOCOR",13,0)
 F PSJCNT=0:0 S PSJCNT=$O(PSPDRG(PSJCNT)) Q:'PSJCNT  Q:$G(PSJQUIT)  S PSJDD=+PSPDRG(PSJCNT) D
"RTN","PSJOCOR",14,0)
 .  D DOC(DFN,$$OROI(+PSJDD))
"RTN","PSJOCOR",15,0)
 .  D GOC(DFN,($P(PSPDRG(PSJCNT),U,2)))
"RTN","PSJOCOR",16,0)
 .  D AOC(DFN,$$VAPROD(+PSJDD))
"RTN","PSJOCOR",17,0)
 D:PSJPAUSE PAUSE^PSJMISC()
"RTN","PSJOCOR",18,0)
 Q
"RTN","PSJOCOR",19,0)
 ;
"RTN","PSJOCOR",20,0)
OROI(PSJDD) ;Get CPRS OI
"RTN","PSJOCOR",21,0)
 ;PSJDD - Drug IEN(#50)
"RTN","PSJOCOR",22,0)
 NEW PSJOI
"RTN","PSJOCOR",23,0)
 Q:'+$G(PSJDD) ""
"RTN","PSJOCOR",24,0)
 S PSJOI=+$P($G(^PSDRUG(+PSJDD,2)),U)
"RTN","PSJOCOR",25,0)
 Q:'PSJOI ""
"RTN","PSJOCOR",26,0)
 Q $$OITM^ORX8(PSJOI,"99PSP")
"RTN","PSJOCOR",27,0)
 ;
"RTN","PSJOCOR",28,0)
DOC(DFN,PSJOROI) ;DANGEREOUS MEDS FOR PAT > 64 ORDER CHECK
"RTN","PSJOCOR",29,0)
 ;DFN - Patient IEN
"RTN","PSJOCOR",30,0)
 ;PSJOROI - CPRS orderable item IEN
"RTN","PSJOCOR",31,0)
 NEW X
"RTN","PSJOCOR",32,0)
 Q:'+$G(DFN)
"RTN","PSJOCOR",33,0)
 Q:'+$G(PSJOROI)
"RTN","PSJOCOR",34,0)
 S X=$P($$DOC^OROCAPI(DFN,+PSJOROI),U,4)
"RTN","PSJOCOR",35,0)
 I X]"" S PSJPAUSE=1 W "***Dangerous Meds for Patient >64***",!! D WRITE^PSJMISC(X)
"RTN","PSJOCOR",36,0)
 Q
"RTN","PSJOCOR",37,0)
 ;
"RTN","PSJOCOR",38,0)
GOC(DFN,PSJDNM) ;GLUCOPHAGE LAB RESULTS ORDER CHECK
"RTN","PSJOCOR",39,0)
 ;PSJDNM - Drug name from file 50
"RTN","PSJOCOR",40,0)
 NEW X
"RTN","PSJOCOR",41,0)
 Q:'+$G(DFN)
"RTN","PSJOCOR",42,0)
 Q:$G(PSJDNM)=""
"RTN","PSJOCOR",43,0)
 S X=$P($$GOC^OROCAPI(DFN,PSJDNM),U,4)
"RTN","PSJOCOR",44,0)
 I X]"" S PSJPAUSE=1,PSJQUIT=1 W "***Metformin Lab Results***",!! D WRITE^PSJMISC(X)
"RTN","PSJOCOR",45,0)
 Q
"RTN","PSJOCOR",46,0)
 ;
"RTN","PSJOCOR",47,0)
AOC(DFN,PSJPROD) ;AMINOGLYCOSIDE ORDERED ORDER CHECK
"RTN","PSJOCOR",48,0)
 ;PSJPROD - VA Product File (#50.68) IEN.
"RTN","PSJOCOR",49,0)
 ;PSJQUIT is set so Aminoglycoside is only warn once per session.
"RTN","PSJOCOR",50,0)
 NEW X
"RTN","PSJOCOR",51,0)
 Q:'+$G(DFN)
"RTN","PSJOCOR",52,0)
 Q:'+$G(PSJPROD)
"RTN","PSJOCOR",53,0)
 S X=$P($$AOC^OROCAPI(DFN,+PSJPROD),U,4)
"RTN","PSJOCOR",54,0)
 I X]"" S PSJPAUSE=1,PSJQUIT=1 W "***Aminoglycoside Ordered****",!! D WRITE^PSJMISC(X)
"RTN","PSJOCOR",55,0)
 Q
"RTN","PSJOCOR",56,0)
 ;
"RTN","PSJOCOR",57,0)
VAPROD(PSJDD) ;Return VA PRODUCT IEN (50.68)
"RTN","PSJOCOR",58,0)
 ;PSJDD - Dispense drug IEN (50)
"RTN","PSJOCOR",59,0)
 Q $P($G(^PSDRUG(+PSJDD,"ND")),U,3)
"RTN","PSJOCOR",60,0)
 ; 
"RTN","PSJOE")
0^17^B88042799
"RTN","PSJOE",1,0)
PSJOE ;BIR/MLM-INPATIENT ORDER ENTRY ;23 Jun 98 / 1:46 PM
"RTN","PSJOE",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**7,26,29,33,42,50,56,72,58,85,95,80,110,111,133,140,151,149,181,252**;16 DEC 97;Build 69
"RTN","PSJOE",3,0)
 ;
"RTN","PSJOE",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOE",5,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSJOE",6,0)
 ; Reference to FULL^VALM1 and PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSJOE",8,0)
 ; Reference to ^DPT is supported by DBIA #10035.
"RTN","PSJOE",9,0)
 ; Reference to ^ORCFLAG is supported by DBIA #3620.
"RTN","PSJOE",10,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJOE",11,0)
 ;
"RTN","PSJOE",12,0)
EN ; Start Inpatient LM OE
"RTN","PSJOE",13,0)
 N PSJLK,PSJNEWOE,PSJLMCON,PSJPROT,XQORS,VALMEVL D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",14,0)
 I $D(XQUIT) K XQUIT G DONE
"RTN","PSJOE",15,0)
 K PSGVBY,PSJPR S (PSJOL,PSJACOK,PSGOP,PSGNEF,PSGOEAV,PSGPXN)="" L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE^PSJOE
"RTN","PSJOE",16,0)
 F  S (PSJLMCON,PSGPTMP)=0 D ^PSJP,HK Q:PSGP'>0  S PSJPROT=3,DFN=PSGP D ^PSJAC D  I PSJLK D UL^PSSLOCK(PSGP)
"RTN","PSJOE",17,0)
 .K ^TMP("PSJ",$J)
"RTN","PSJOE",18,0)
 .S PSJLK=$$L^PSSLOCK(PSGP,1) I 'PSJLK W !,$C(7),$P(PSJLK,U,2) Q
"RTN","PSJOE",19,0)
 .K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",20,0)
 .N NXTPT S NXTPT=0 F  Q:$G(NXTPT)  D
"RTN","PSJOE",21,0)
 ..K PSGRDTX
"RTN","PSJOE",22,0)
 ..I $G(PSJLMCON)!$G(PSJNEWOE) D
"RTN","PSJOE",23,0)
 ...S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSJOE",24,0)
 ...S PSJLMPRO=1,PSJLMCON=1,PSJNEWOE=0 D EN^VALM("PSJ LM OE")
"RTN","PSJOE",25,0)
 ..I $G(PSJNEWOE)!($G(VALMBCK)="Q") S PSJNEWOE=0 Q
"RTN","PSJOE",26,0)
 ..I $G(PSJLMCON)&$G(PSJLMPRO)&'$D(^TMP("PSJ",$J)) D  Q
"RTN","PSJOE",27,0)
 ...S PSJLMCON=0,PSJLMPRO=0 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",28,0)
 ...I $G(PSJNEWOE) S NXTPT=0 Q
"RTN","PSJOE",29,0)
 ...S NXTPT=1
"RTN","PSJOE",30,0)
 ..S NXTPT=1,PSJNEWOE=0
"RTN","PSJOE",31,0)
 .S PSJOL="S"
"RTN","PSJOE",32,0)
 .I $G(PSGPXN) I $P(PSJSYSW0,U,29)]""!($G(PSJCOM)) S PSGPXPT=PSGP D  K PSGPXPT S PSGPXN=0
"RTN","PSJOE",33,0)
 ..N DFN,PSGP,PSJPXDP
"RTN","PSJOE",34,0)
 ..I $P(PSJSYSW0,U,29)="" S PSJPDXP=1 D
"RTN","PSJOE",35,0)
 ...;N IO,ION,IOS D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",36,0)
 ...D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",37,0)
 ..S (PSGP,DFN)=PSGPXPT D ^PSGPER S:$G(PSJPDXP) $P(PSJSYSW0,U,29)="" K PSJPDXP
"RTN","PSJOE",38,0)
 .D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",39,0)
 K PSJLMPRO,^TMP("PSJPRO",$J),^TMP("PSJ",$J),^TMP("PSJON",$J)
"RTN","PSJOE",40,0)
DONE ;
"RTN","PSJOE",41,0)
 K PSJEXCPT,PSJOCER,^TMP($J,"PSJPRE")
"RTN","PSJOE",42,0)
 K AC,ACTION,D1,D2,MI,N,ON,P3,PNOW,PSIVAT,PSIVLN,PSIVSTR L -^PS(53.45,PSJSYSP)
"RTN","PSJOE",43,0)
 K DA,DRG,NE,PSGCF,PSGCANFL,PSGNEDFD,PSGNEF,PSGNEFD,PSGNEPR,PSGNESD,PSJACOK,PSJOE,PSJOECNT,PSJOEPF,PSJORD,PSGOEA,PSGOEAV,PSGOL,PSGOS,PSGON,PSGOP,PSGORD,PSGS0XT,PSGS0Y,RCT,ST,WD,XREF,Z,PSJIVORF,PSJIVPCL
"RTN","PSJOE",44,0)
 K PSGOEORF,PSIVREA,PSJOPC,PSJORL,PSJORPCL,PSJORTOI,RF,WSCHADM,PSJLM,PSJCT
"RTN","PSJOE",45,0)
 K DIU,DRGI,FLAG,FQC,ND2,PRI,PSGOE,PSGPRI,PSGSDN,PSGOEDMR,PSGOEPR,PSGPTS,PSGTOL,PSGTOO,PSGUOW,PSJIVOF,PSJOCNT,PSJON,PSJORQF,PSJORTOU,PSJORVP
"RTN","PSJOE",46,0)
 G:$G(PSGPXN) ^PSGPER1 D ENIVKV^PSGSETU
"RTN","PSJOE",47,0)
 Q
"RTN","PSJOE",48,0)
HK ; Housekeeping (a nice COBOL term)
"RTN","PSJOE",49,0)
 I PSGOP,PSGOP'=PSGP D
"RTN","PSJOE",50,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSJOE",51,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,"^",2)]"" ENQL^PSGLW
"RTN","PSJOE",52,0)
 Q:PSGP<0
"RTN","PSJOE",53,0)
 S (DFN,PSGOP)=PSGP,X=""
"RTN","PSJOE",54,0)
 Q
"RTN","PSJOE",55,0)
SELECT ; Select order from list
"RTN","PSJOE",56,0)
 ;Variable PSJOCDSC is used in Complex order dosing checks
"RTN","PSJOE",57,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX,PSJOCDSC K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J)
"RTN","PSJOE",58,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON
"RTN","PSJOE",59,0)
 I "^"[X S VALMQUIT=1 Q
"RTN","PSJOE",60,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL!($G(Y)<0)  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",61,0)
 .K PSJOCDSC
"RTN","PSJOE",62,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA Q:PSJORD=""!($G(Y)<0)  Q:PSJORD=+PSJORD  D
"RTN","PSJOE",63,0)
 ..Q:('$$LS^PSSLOCK(PSGP,PSJORD))
"RTN","PSJOE",64,0)
 ..Q:PSJORD=+PSJORD
"RTN","PSJOE",65,0)
 ..S PSGORD=""
"RTN","PSJOE",66,0)
 ..D DISACTIO(PSGP,PSJORD,"") S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",67,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",68,0)
 S VALMBCK="Q"
"RTN","PSJOE",69,0)
 K PSJLM,PSJOCDSC
"RTN","PSJOE",70,0)
 Q
"RTN","PSJOE",71,0)
DISACTIO(DFN,PSJORD,PSJPNV)       ; Display UD order and allow actions.
"RTN","PSJOE",72,0)
 ; PSJORD - Order #_location Code (P:53.1,V:55.01,U:55.06)
"RTN","PSJOE",73,0)
 ; PSJPNV - Invoked from Pending/NV option; (gets different hidden menu)
"RTN","PSJOE",74,0)
 N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55
"RTN","PSJOE",75,0)
 D OLDCOM^PSJOE0(DFN,PSJORD)
"RTN","PSJOE",76,0)
 S PSGP=DFN D ENIV^PSJAC I PSJORD["V" D EN^PSJLIORD(DFN,PSJORD) Q
"RTN","PSJOE",77,0)
 D GETUD^PSJLMGUD(DFN,PSJORD)
"RTN","PSJOE",78,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",79,0)
 S:$G(PSJTUD) PSGPD=$G(PSJCOI),PSGPDN=$$OINAME^PSJLMUTL(+PSGPD)
"RTN","PSJOE",80,0)
 K PSGOENG I '$D(PSGPRF) D  Q:$G(PSGOENG)
"RTN","PSJOE",81,0)
 . I PSJORD["U" L +^PS(55,PSGP,5,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",82,0)
 . I PSJORD["P" L +^PS(53.1,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",83,0)
 . I $G(PSGOENG) W !,"This order is being edited by another terminal.",! S PSGOENG=1 K DIR S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSJOE",84,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD)
"RTN","PSJOE",85,0)
 I PSJORD["P" S PSJXX1=$G(^PS(53.1,+PSJORD,0)) I PSGP'=$P(PSJXX1,U,15)!(DFN'=$P(PSJXX1,U,15)) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",86,0)
 I PSJORD["P" D  S PSJXX1=$P($G(^PS(53.1,+PSJORD,0)),U,9) I $S($G(PSJIVFLG):1,$G(Y)<0:1,"PADE"[PSJXX1:1,1:0) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",87,0)
 .I $P(PSJXX1,U,9)="N",($P(PSJXX1,U,4)'="U") D  Q
"RTN","PSJOE",88,0)
 .. S P("PON")=PSJORD,PSIVFLG=1
"RTN","PSJOE",89,0)
 .. N ON S ON=PSJORD D VF^PSIVORC2
"RTN","PSJOE",90,0)
 .I $P(PSJXX1,U,9)="P" D  Q
"RTN","PSJOE",91,0)
 ..S:$G(PSJTUD) $P(PSJXX1,U,4)="U"
"RTN","PSJOE",92,0)
 ..I $P(PSJXX1,U,4)="U" D  Q:$G(PSJIVFLG)
"RTN","PSJOE",93,0)
 ... N VAIP S CLINIC=$G(^PS(53.1,+PSJORD,"DSS")),APPT=$P(CLINIC,"^",2),CLINIC=$P(CLINIC,"^") I $$PATCH^XPDUTL("SD*5.3*285"),$$SDIMO^SDAMA203(CLINIC,DFN)>-1 Q
"RTN","PSJOE",94,0)
 ... Q:'PSJPDD  W !!,"Cannot process an Out-patient Unit Dose order for ",$P($G(^DPT(+PSGP,0)),U) D PAUSE^VALM1 S PSJIVFLG=1
"RTN","PSJOE",95,0)
 ..NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJOE",96,0)
 ..D REQDT^PSJLIVMD(PSJORD)
"RTN","PSJOE",97,0)
 ..I $P(PSJXX1,U,4)="U",($G(PSGSCH)="") W !!,"Invalid schedule, can't finish this order" D PAUSE^VALM1 Q
"RTN","PSJOE",98,0)
 ..I $P(PSJXX1,U,4)="U" N PSJLM,PSJOCFG S PSJLM=1,PSGORD=PSJORD,PSJOCFG="FN UD" D START^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD) S:$G(PSJTUD) PSJOCFG="FN UD" D @$S($G(PSJTUD):"FINISH^PSGOEF",1:"EN^VALM(""PSJ LM PENDING EDIT"")") K PSJOCFG Q
"RTN","PSJOE",99,0)
 ..I $P(PSJXX1,U,4)'="U",PSGP=$P(PSJXX1,U,15),DFN=$P(PSJXX1,U,15) S PSJLYN=PSJORD,PSJOCFG="FN IV" D EN^PSJLIFN S PSJIVFLG=1 K PSJLYN,PSJMAI,PSJOCFG
"RTN","PSJOE",100,0)
 I $G(PSIVFLG) K PSIVFLG Q
"RTN","PSJOE",101,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD),PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSJORD),ENSFE^PSGOEE0(PSGP,PSJORD),EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE",102,0)
 I PSJORD["P" L -^PS(53.1,+PSJORD)
"RTN","PSJOE",103,0)
 I PSJORD["U" L -^PS(55,PSGP,5,+PSJORD)
"RTN","PSJOE",104,0)
 ;Send SN to CPRS if auto-verify OFF and Order Set Entry and no 21st piece
"RTN","PSJOE",105,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",106,0)
 I $D(PSGOES),'PSGOEAV,$D(PSGORD),PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSJOE",107,0)
 D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",108,0)
 Q
"RTN","PSJOE",109,0)
EDIT(PSGP,PSGORD,PROMPT) ;
"RTN","PSJOE",110,0)
 I "DE"[$$GTSTATUS(PSGP,PSGORD) W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",111,0)
 I PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",112,0)
 S PSGNEDFD="" D HOLDHDR,@$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") I 'Y D ABORT^PSGOEE Q
"RTN","PSJOE",113,0)
 I PSGORD["P" D ENF^PSGOEE Q
"RTN","PSJOE",114,0)
 D ACT^PSGOEE
"RTN","PSJOE",115,0)
 Q
"RTN","PSJOE",116,0)
RENEW(PSGP,PSGORD) ;
"RTN","PSJOE",117,0)
 ;PSJOCFG - If defined, it's for new order, renew or copy. ^PSJOCDSD using this flag to not display drug error.
"RTN","PSJOE",118,0)
 NEW PSJOCFG
"RTN","PSJOE",119,0)
 S PSJOCFG="RENEW UD"
"RTN","PSJOE",120,0)
 D HOLDHDR
"RTN","PSJOE",121,0)
 I 'PSJSYSU,$P($G(^PS(55,PSGP,5,+PSGORD,4)),U,15),$P($G(^(4)),U,16) W !!,"This order is already marked for renewal!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJOE",122,0)
 I 'PSGRRF D ^PSGOER K PSJOCFG Q
"RTN","PSJOE",123,0)
 D ^PSGOERI
"RTN","PSJOE",124,0)
 K PSJOCFG
"RTN","PSJOE",125,0)
 Q
"RTN","PSJOE",126,0)
GTSTATUS(DFN,ON)   ;
"RTN","PSJOE",127,0)
 I ON["P" Q $P($G(^PS(53.1,+ON,0)),U,9)
"RTN","PSJOE",128,0)
 I ON["U" Q $P($G(^PS(55,DFN,5,+ON,0)),U,9)
"RTN","PSJOE",129,0)
 Q $P($G(^PS(55,DFN,"IV",+ON,0)),U,17)
"RTN","PSJOE",130,0)
DC(DFN,PSJORD) ; DC IV, UD, or pending orders.
"RTN","PSJOE",131,0)
 D HOLDHDR
"RTN","PSJOE",132,0)
 S X=$$GTSTATUS(DFN,PSJORD) I X="D"!(X="DE")!(X="R") W !,$S(X="R":"This order has a pending renewal and cannot be DISCONTINUED.",1:"This order has already been DISCONTINUED.") D PAUSE^VALM1 Q
"RTN","PSJOE",133,0)
 D ENO^PSGOEC(DFN,PSJORD) ;,GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S VALMBCK="Q"
"RTN","PSJOE",134,0)
 S VALMBCK="Q"
"RTN","PSJOE",135,0)
 Q
"RTN","PSJOE",136,0)
HOLD(DFN,PSJORD) ; Change order's status from ACTIVE<->HOLD
"RTN","PSJOE",137,0)
 D HOLDHDR
"RTN","PSJOE",138,0)
 I PSJORD["V" D H^PSIVOPT(DFN,PSJORD,P(17),P(3))
"RTN","PSJOE",139,0)
 I PSJORD'["V" D H^PSGOE1(DFN,PSJORD)
"RTN","PSJOE",140,0)
 D GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S PSGACT=$$ENACTION^PSGOE1(DFN,PSJORD),VALMBCK="R"
"RTN","PSJOE",141,0)
 Q
"RTN","PSJOE",142,0)
COPY(PSGP,PSGORD)  ; Copy an order (does not discontinue original order)
"RTN","PSJOE",143,0)
 NEW PSJOCFG
"RTN","PSJOE",144,0)
 I $D(PSGCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",145,0)
 I PSGORD["P" W !!,"You cannot copy this "_$S($G(PSGSTAT)]"":PSGSTAT,1:"PENDING IV")_" order." D PAUSE^VALM1 Q
"RTN","PSJOE",146,0)
 I PSGORD["V" D  Q
"RTN","PSJOE",147,0)
 .I $G(PSIVCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",148,0)
 .S PSJOCFG="COPY IV"
"RTN","PSJOE",149,0)
 .D COPY^PSIVOD(PSGP,PSGORD) K PSJOCFG Q
"RTN","PSJOE",150,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")
"RTN","PSJOE",151,0)
 D ^PSJHVARS
"RTN","PSJOE",152,0)
 I $P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSJOE",153,0)
 S PSJOCFG="COPY UD"
"RTN","PSJOE",154,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU
"RTN","PSJOE",155,0)
 S PSGCOPY=1
"RTN","PSJOE",156,0)
 D FULL^VALM1,^PSGOD
"RTN","PSJOE",157,0)
 S VALMBCK="R"
"RTN","PSJOE",158,0)
 K PSGCOPY,PSJOCFG
"RTN","PSJOE",159,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSGORD) ; resets PSGACT after copy
"RTN","PSJOE",160,0)
 I $G(PSGPXN) N PSGTMPXN S PSGTMPXN=PSGPXN
"RTN","PSJOE",161,0)
 D RESTORE^PSJHVARS I $G(PSGTMPXN) S PSGPXN=PSGTMPXN
"RTN","PSJOE",162,0)
 Q
"RTN","PSJOE",163,0)
UPDATE ; Refresh array, actions, & display.
"RTN","PSJOE",164,0)
 D GETUD^PSJLMGUD(DFN,ON),INIT^PSJLMUDE(DFN,ON) S VALMBCK="R"
"RTN","PSJOE",165,0)
 Q
"RTN","PSJOE",166,0)
FINISH ;
"RTN","PSJOE",167,0)
 D FINISH^PSGOEF,PAUSE^VALM1
"RTN","PSJOE",168,0)
 Q
"RTN","PSJOE",169,0)
LOG(DFN,PSGORD)        ;
"RTN","PSJOE",170,0)
 D FULL^VALM1,ENLM^PSGOEL(DFN,PSGORD),PAUSE^VALM1 S VALMBCK="R"
"RTN","PSJOE",171,0)
 Q
"RTN","PSJOE",172,0)
NEWSEL ;
"RTN","PSJOE",173,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX,PSJOCDSC K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J)
"RTN","PSJOE",174,0)
 S X=$P(XQORNOD(0),"=",2)
"RTN","PSJOE",175,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0)
"RTN","PSJOE",176,0)
 D ENCHK^PSGON I '$O(PSGODDD(0)) S VALMQUIT=1 Q
"RTN","PSJOE",177,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",178,0)
 .K PSJOCDSC
"RTN","PSJOE",179,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA
"RTN","PSJOE",180,0)
 .Q:PSJORD=+PSJORD 
"RTN","PSJOE",181,0)
 .Q:PSJORD=""!($G(Y)<0)  Q:('$$LS^PSSLOCK(PSGP,PSJORD))  D
"RTN","PSJOE",182,0)
 ..S PSGORD=""
"RTN","PSJOE",183,0)
 ..S ON=PSJORD
"RTN","PSJOE",184,0)
 ..D DISACTIO(PSGP,PSJORD,$G(PSJPNV)) S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",185,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",186,0)
 ..I $G(PSJNOL) K PSJNOL I $D(ON),ON'=PSJORD D UNL^PSSLOCK(PSGP,ON)
"RTN","PSJOE",187,0)
 ..Q:$G(Y)<0
"RTN","PSJOE",188,0)
 S VALMBCK="Q"
"RTN","PSJOE",189,0)
 K PSJLM,PSJOCDSC
"RTN","PSJOE",190,0)
 Q
"RTN","PSJOE",191,0)
HOLDHDR ; Freeze header text while processing order actions
"RTN","PSJOE",192,0)
 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSJOE",193,0)
 Q
"RTN","PSJOE",194,0)
LOCKERR ;
"RTN","PSJOE",195,0)
 W !!,$C(7),"You are entering or editing an Inpatient Medication order in another session.",!,"Only one order entry/edit session is allowed for a user at a time.",!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJOE",196,0)
 Q
"RTN","PSJOE",197,0)
FLAG(DFN,PSJORD) ;Flag order through CPRS entry point.
"RTN","PSJOE",198,0)
 N ORIFN,NODE0
"RTN","PSJOE",199,0)
 S NODE0=$S(PSJORD["V":$G(^PS(55,DFN,"IV",+PSJORD,0)),PSJORD["U":$G(^PS(55,DFN,5,+PSJORD,0)),1:^PS(53.1,+PSJORD,0))
"RTN","PSJOE",200,0)
 S ORIFN=$P(NODE0,"^",21)
"RTN","PSJOE",201,0)
 D EN1^ORCFLAG(ORIFN)
"RTN","PSJOE",202,0)
 D PAUSE^VALM1
"RTN","PSJOE",203,0)
 Q
"RTN","PSJOE",204,0)
COMPLEX(DFN,ON) ;
"RTN","PSJOE",205,0)
 N NDP2,COM
"RTN","PSJOE",206,0)
 S NDP2=$S(ON["P":$G(^PS(53.1,+ON,.2)),ON["U":$G(^PS(55,DFN,5,+ON,.2)),ON["V":$G(^PS(55,DFN,"IV",+ON,.2)),1:"")
"RTN","PSJOE",207,0)
 S COM=$P(NDP2,"^",8) I COM Q 1
"RTN","PSJOE",208,0)
 Q 0
"RTN","PSJOE1")
0^18^B28274486
"RTN","PSJOE1",1,0)
PSJOE1 ;BIR/CML3-UD OE FOR COMBINED OE ;29 JAN 99 / 9:44 AM
"RTN","PSJOE1",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**2,7,25,30,47,56,64,179,181,252**;16 DEC 97;Build 69
"RTN","PSJOE1",3,0)
 ;
"RTN","PSJOE1",4,0)
 ; Reference to ^DICN is supported by DBIA# 10009
"RTN","PSJOE1",5,0)
 ; Reference to ^VALM is supported by DBIA# 10118
"RTN","PSJOE1",6,0)
 ;
"RTN","PSJOE1",7,0)
 S PC=0 G AD
"RTN","PSJOE1",8,0)
 ;
"RTN","PSJOE1",9,0)
EN ;
"RTN","PSJOE1",10,0)
 S PC=0
"RTN","PSJOE1",11,0)
 ;
"RTN","PSJOE1",12,0)
AD ; Ask Drug
"RTN","PSJOE1",13,0)
 ;PSJOCFG - If defined, it's for new order, renew or copy. ^PSJOCDSD using this flag to not display drug error.
"RTN","PSJOE1",14,0)
 K PSJOCFG
"RTN","PSJOE1",15,0)
 N PSJNORD,PSGORQF,PSGSDX,PSGFDX,PSGNEFDO,PSGEDTOI,PSJOCFG S PSJOCFG="NEW UD" S PSJNORD=1 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC,@IOSTBM,IORC
"RTN","PSJOE1",16,0)
 K PSGORQF
"RTN","PSJOE1",17,0)
 D ^PSGOE7
"RTN","PSJOE1",18,0)
 I $G(PSGORQF) S PSJORQF=1 G DONE
"RTN","PSJOE1",19,0)
 S PC=1,PSJORQF=0 I X?1"S."1.E D ^PSGOES G AD
"RTN","PSJOE1",20,0)
 D ^PSGOE4:'$P(PSJSYSP0,"^",12),^PSGOE3:$P(PSJSYSP0,"^",12)
"RTN","PSJOE1",21,0)
 G:$G(PSGOROE1)=1 AD
"RTN","PSJOE1",22,0)
 K PSGEFN,PSGOEEF,PSGOEE,PSGOEOS S PSGEFN="1:13" F X=1:1:13 S PSGEFN(X)=""
"RTN","PSJOE1",23,0)
 S PSGPDN=$$OINAME^PSJLMUTL(PSGPDRG),PSGPD=PSGPDRG,PSGOINST="",PSGSDN=$$ENDD^PSGMI(PSGNESD)_U_$$ENDTC^PSGMI(PSGNESD),PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD)
"RTN","PSJOE1",24,0)
 S PSGAT=PSGS0Y,PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT),PSGLI=PSGDT,PSGEBN=$$ENNPN^PSGMI(DUZ),PSGSTAT=$S(PSGOEAV:"ACTIVE",1:"NON-VERIFIED")
"RTN","PSJOE1",25,0)
 D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSJOE1",26,0)
 S PSGSD=PSGNESD,PSGFD=PSGNEFD
"RTN","PSJOE1",27,0)
 K PSJACEPT S VALMBCK="Q" D:$D(Y) EN^VALM("PSJU LM ACCEPT")
"RTN","PSJOE1",28,0)
 I $G(PSJACEPT)=1 D
"RTN","PSJOE1",29,0)
 . D OC
"RTN","PSJOE1",30,0)
 . ;D:'$G(PSGORQF) IN^PSJOCDS($G(PSGORD),"UD",+$G(PSGDRG))
"RTN","PSJOE1",31,0)
 ;If intervention is not log then quit
"RTN","PSJOE1",32,0)
 I $G(PSGORQF)=1 S PSJACEPT=0
"RTN","PSJOE1",33,0)
 S PSJNOO=-1 I $G(PSJACEPT)=1 S PSJNOO=$$ENNOO^PSJUTL5("N")
"RTN","PSJOE1",34,0)
 I $G(PSJNOO)<0 K PSJACEPT W !,"No order created." G AD
"RTN","PSJOE1",35,0)
 K PSGOEE D ^PSGOETO S PSJORD=PSGORD I PSGOEAV D  G AD
"RTN","PSJOE1",36,0)
 .I '$D(PSGOEE),+PSJSYSU=3 D EN^PSGPEN(PSGORD)
"RTN","PSJOE1",37,0)
 S PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD),^PSGOE1,EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE1",38,0)
 G AD
"RTN","PSJOE1",39,0)
 Q
"RTN","PSJOE1",40,0)
OC ;
"RTN","PSJOE1",41,0)
 NEW PSJDD,PSJALLGY,PSJALGY1
"RTN","PSJOE1",42,0)
 K PSGORQF
"RTN","PSJOE1",43,0)
 D FULL^VALM1
"RTN","PSJOE1",44,0)
 S PSJDD=+$$DD53P45^PSJMISC() I 'PSJDD S PSGORQF=1 Q
"RTN","PSJOE1",45,0)
 I +$G(PSGEDTOI) D
"RTN","PSJOE1",46,0)
 . S PSJALGY1=1
"RTN","PSJOE1",47,0)
 . D ENDDC^PSGSICHK($G(PSGP),PSJDD)
"RTN","PSJOE1",48,0)
 D:'$G(PSGORQF) IN^PSJOCDS($G(PSGORD),"UD",PSJDD)
"RTN","PSJOE1",49,0)
 Q
"RTN","PSJOE1",50,0)
EDIT(PROMPT) ;
"RTN","PSJOE1",51,0)
 ; Edit fields in a UD order.
"RTN","PSJOE1",52,0)
 ; PROMPT=0 - Select fields to edit by number.
"RTN","PSJOE1",53,0)
 ; PROMPT=1 - Prompt to select fields for editing.
"RTN","PSJOE1",54,0)
 ;
"RTN","PSJOE1",55,0)
 ;* D @$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") Q:'Y  S PSGOEEG=3 D EDIT^PSGOEE ;$S(PSGOEEWF[53.1:3,1:5) D:Y EDIT^PSGOEE
"RTN","PSJOE1",56,0)
 D @$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") Q:'Y  S:$G(PSJNEWOE) PSGOEEWF="^PS(53.1," S PSGOEEG=$S('$D(PSGOEEWF):3,PSGOEEWF[53.1:3,1:5) D EDIT^PSGOEE
"RTN","PSJOE1",57,0)
 I $G(PSJNEWOE) S PSGOEENO=0,DR="",VALMBCK="R"
"RTN","PSJOE1",58,0)
 I '$G(PSJNEWOE) D ENNOU^PSGOEE0 I 'PSGOEENO,DR="" S VALMBCK="R" Q
"RTN","PSJOE1",59,0)
 I 'PSGOEENO,$D(PSGOES) D ENNOU^PSGOEE0  ; only update on order sets
"RTN","PSJOE1",60,0)
 ;*179 No longer call CKDT^PSGOEE from here.
"RTN","PSJOE1",61,0)
 ;I 'PSGOEENO,$G(PSGPDNX)=1 D CKDT^PSGOEE
"RTN","PSJOE1",62,0)
 I $G(PSGOEER)["101^PSGOE8" S PSGEDTOI=1
"RTN","PSJOE1",63,0)
 K VALMSG I PSGOEENO D
"RTN","PSJOE1",64,0)
 .S VALMSG="This change will cause a new order to be created." D GTSTATUS^PSGOEE,CHKDD^PSGOEE
"RTN","PSJOE1",65,0)
 .S PSGEBN=$$ENNPN^PSGMI(DUZ),PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT),PSGLI=PSGDT
"RTN","PSJOE1",66,0)
 D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGSD_"^^"_PSGFD)
"RTN","PSJOE1",67,0)
 D INIT^PSJLMUDE(PSGP,$G(PSGORD))
"RTN","PSJOE1",68,0)
 Q
"RTN","PSJOE1",69,0)
DONE ;
"RTN","PSJOE1",70,0)
 K %,DA,DIC,DIE,DR,DRG,DRGN,DRGO,ND,OC,ORIFN,ORIT,ORPK,ORSTOP,ORSTRT,ORSTS,ORTX,PC,PSGDO,PSGMR,PSGMRN,PSGNEDFD,PSGNEFD,PSGNESD,PSGOES,PSGOROE1,PSGORD,PSGS0XT,PSGS0Y,PSGSCH,PSGSI,PSGX,Y,Z Q
"RTN","PSJOE1",71,0)
 K PSGEDTOI,PSJOCFG
"RTN","PSJOE1",72,0)
 ;
"RTN","PSJOE1",73,0)
GDO ;
"RTN","PSJOE1",74,0)
 W !!,"Drug is not found in Formulary List." F  S %=1 W !,"Would you like to try to search the list again" D YN^DICN Q:%  D TAM
"RTN","PSJOE1",75,0)
 Q:%<2
"RTN","PSJOE1",76,0)
FTD ;
"RTN","PSJOE1",77,0)
 R !!,"Enter FREE TEXT DRUG: ",PSGDRGN:DTIME E  W $C(7) S PSGDRGN="^" Q
"RTN","PSJOE1",78,0)
 Q:"^"[PSGDRGN  S X=$S(PSGDRGN'?.ANP:"Control character(s)",PSGDRGN["^":"Up-arrow ('^') in text",$L(PSGDRGN)>39:"Response longer than 39 characters",1:"") I X]"" W $C(7),"  ??",!?2,"(",X," not allowed.)" G FTD
"RTN","PSJOE1",79,0)
 Q:PSGDRGN'?1."?"
"RTN","PSJOE1",80,0)
 W !!?2,"ENTER DRUG ORDERED (1-39 CHARACTERS).",!?2,"Since the drug cannot be found in the DRUG file, enter the drug name here",!,"exactly as ordered.  Press the RETURN key (or enter an '^') to skip over this",!,"drug, or to again search the"
"RTN","PSJOE1",81,0)
 W " DRUG file for this one." G FTD
"RTN","PSJOE1",82,0)
 ;
"RTN","PSJOE1",83,0)
TAM ; Try Again Message
"RTN","PSJOE1",84,0)
 W !!,"  Enter a 'Y' to try again to find the drug ordered from the Formulary.  (The",!,"order cannot become active until a Formulary drug has been entered.)  Enter 'N'",!,"to enter the drug ordered as free text for later reference."
"RTN","PSJOE1",85,0)
 W "  Enter '^' to exit.",! Q
"VER")
8.0^22.0
**INSTALL NAME**
OR*3.0*345
"BLD",8006,0)
OR*3.0*345^ORDER ENTRY/RESULTS REPORTING^0^3121010^y
"BLD",8006,4,0)
^9.64PA^^
"BLD",8006,6)
19^
"BLD",8006,6.3)
32
"BLD",8006,"ABPKG")
n
"BLD",8006,"KRN",0)
^9.67PA^779.2^20
"BLD",8006,"KRN",.4,0)
.4
"BLD",8006,"KRN",.401,0)
.401
"BLD",8006,"KRN",.402,0)
.402
"BLD",8006,"KRN",.403,0)
.403
"BLD",8006,"KRN",.5,0)
.5
"BLD",8006,"KRN",.84,0)
.84
"BLD",8006,"KRN",3.6,0)
3.6
"BLD",8006,"KRN",3.8,0)
3.8
"BLD",8006,"KRN",9.2,0)
9.2
"BLD",8006,"KRN",9.8,0)
9.8
"BLD",8006,"KRN",9.8,"NM",0)
^9.68A^13^12
"BLD",8006,"KRN",9.8,"NM",1,0)
ORDSGCHK^^0^B109352032
"BLD",8006,"KRN",9.8,"NM",3,0)
ORWDXC^^0^B66801106
"BLD",8006,"KRN",9.8,"NM",4,0)
ORCHECK^^0^B118737509
"BLD",8006,"KRN",9.8,"NM",5,0)
ORWDXR01^^0^B28161629
"BLD",8006,"KRN",9.8,"NM",6,0)
ORKPS^^0^B95306003
"BLD",8006,"KRN",9.8,"NM",7,0)
ORRDI2^^0^B31690107
"BLD",8006,"KRN",9.8,"NM",8,0)
ORKPS1^^0^B72321793
"BLD",8006,"KRN",9.8,"NM",9,0)
ORKCHK6^^0^B31183287
"BLD",8006,"KRN",9.8,"NM",10,0)
ORKCHK^^0^B42660256
"BLD",8006,"KRN",9.8,"NM",11,0)
ORKCHK4^^0^B27733732
"BLD",8006,"KRN",9.8,"NM",12,0)
OROCAPI1^^0^B44544805
"BLD",8006,"KRN",9.8,"NM",13,0)
ORKCHK5^^0^B46374630
"BLD",8006,"KRN",9.8,"NM","B","ORCHECK",4)

"BLD",8006,"KRN",9.8,"NM","B","ORDSGCHK",1)

"BLD",8006,"KRN",9.8,"NM","B","ORKCHK",10)

"BLD",8006,"KRN",9.8,"NM","B","ORKCHK4",11)

"BLD",8006,"KRN",9.8,"NM","B","ORKCHK5",13)

"BLD",8006,"KRN",9.8,"NM","B","ORKCHK6",9)

"BLD",8006,"KRN",9.8,"NM","B","ORKPS",6)

"BLD",8006,"KRN",9.8,"NM","B","ORKPS1",8)

"BLD",8006,"KRN",9.8,"NM","B","OROCAPI1",12)

"BLD",8006,"KRN",9.8,"NM","B","ORRDI2",7)

"BLD",8006,"KRN",9.8,"NM","B","ORWDXC",3)

"BLD",8006,"KRN",9.8,"NM","B","ORWDXR01",5)

"BLD",8006,"KRN",19,0)
19
"BLD",8006,"KRN",19,"NM",0)
^9.68A^^0
"BLD",8006,"KRN",19.1,0)
19.1
"BLD",8006,"KRN",101,0)
101
"BLD",8006,"KRN",409.61,0)
409.61
"BLD",8006,"KRN",771,0)
771
"BLD",8006,"KRN",779.2,0)
779.2
"BLD",8006,"KRN",870,0)
870
"BLD",8006,"KRN",8989.51,0)
8989.51
"BLD",8006,"KRN",8989.52,0)
8989.52
"BLD",8006,"KRN",8994,0)
8994
"BLD",8006,"KRN","B",.4,.4)

"BLD",8006,"KRN","B",.401,.401)

"BLD",8006,"KRN","B",.402,.402)

"BLD",8006,"KRN","B",.403,.403)

"BLD",8006,"KRN","B",.5,.5)

"BLD",8006,"KRN","B",.84,.84)

"BLD",8006,"KRN","B",3.6,3.6)

"BLD",8006,"KRN","B",3.8,3.8)

"BLD",8006,"KRN","B",9.2,9.2)

"BLD",8006,"KRN","B",9.8,9.8)

"BLD",8006,"KRN","B",19,19)

"BLD",8006,"KRN","B",19.1,19.1)

"BLD",8006,"KRN","B",101,101)

"BLD",8006,"KRN","B",409.61,409.61)

"BLD",8006,"KRN","B",771,771)

"BLD",8006,"KRN","B",779.2,779.2)

"BLD",8006,"KRN","B",870,870)

"BLD",8006,"KRN","B",8989.51,8989.51)

"BLD",8006,"KRN","B",8989.52,8989.52)

"BLD",8006,"KRN","B",8994,8994)

"BLD",8006,"QUES",0)
^9.62^^
"BLD",8006,"REQB",0)
^9.611^2^2
"BLD",8006,"REQB",1,0)
OR*3.0*346^2
"BLD",8006,"REQB",2,0)
OR*3.0*357^2
"BLD",8006,"REQB","B","OR*3.0*346",1)

"BLD",8006,"REQB","B","OR*3.0*357",2)

"MBREQ")
1
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
345^3121010^11859
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","ORCHECK")
0^4^B118737509
"RTN","ORCHECK",1,0)
ORCHECK ;SLC/MKB-Order checking calls ;08/22/12  09:21
"RTN","ORCHECK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,70,94,141,215,243,293,280,346,357,345**;Dec 17, 1997;Build 32
"RTN","ORCHECK",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCHECK",4,0)
DISPLAY ; -- DISPLAY event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",5,0)
 ;    Expects ORVP, ORNMSP, ORTAB, [ORWARD]
"RTN","ORCHECK",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",7,0)
 N ORX,ORY,I
"RTN","ORCHECK",8,0)
 I ORNMSP="PS" D  ;reset to PSJ, PSJI, or PSO
"RTN","ORCHECK",9,0)
 . I $G(ORDG) S I=$P($G(^ORD(100.98,+ORDG,0)),U,3),I=$P(I," ") Q:'$L(I)  S ORNMSP="PS"_$S(I="UD":"I",1:I) Q
"RTN","ORCHECK",10,0)
 . I $G(ORXFER) S I=$P($P(^TMP("OR",$J,ORTAB,0),U,3),";",3) S:I="" I=$G(ORWARD) S ORNMSP="PS"_$S(I:"O",1:"I") ;opposite of list
"RTN","ORCHECK",11,0)
 S ORX(1)="|"_ORNMSP,ORX=1
"RTN","ORCHECK",12,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"DISPLAY") Q:'$D(ORY)
"RTN","ORCHECK",13,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  W !,$P(ORY(I),U,4) ; display only
"RTN","ORCHECK",14,0)
 Q
"RTN","ORCHECK",15,0)
 ;
"RTN","ORCHECK",16,0)
SELECT ; -- SELECT event
"RTN","ORCHECK",17,0)
 ;    Expects ORVP, ORDAILOG(PROMPT,ORI), ORNMSP
"RTN","ORCHECK",18,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",19,0)
 N ORX,ORY,OI,ORDODSG
"RTN","ORCHECK",20,0)
 S OI=+$G(ORDIALOG(PROMPT,ORI)),ORDODSG=0
"RTN","ORCHECK",21,0)
 S ORX=1,ORX(1)=OI_"|"_ORNMSP_"|"_$$USID^ORMBLD(OI)
"RTN","ORCHECK",22,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"SELECT",,.ORDODSG),RETURN:$D(ORY)
"RTN","ORCHECK",23,0)
 Q
"RTN","ORCHECK",24,0)
 ;
"RTN","ORCHECK",25,0)
ACCEPT(MODE) ; -- ACCEPT event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",26,0)
 ;    Expects ORVP, ORDIALOG(), ORNMSP
"RTN","ORCHECK",27,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",28,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",29,0)
 N ORX,ORY,ORZ,OI,ORSTRT,ORI,ORIT,ORID,ORSP,ORDODSG
"RTN","ORCHECK",30,0)
 S:'$L($G(MODE)) MODE="ACCEPT"
"RTN","ORCHECK",31,0)
 S OI=$$PTR^ORCD("OR GTX ORDERABLE ITEM"),ORSTRT=$$START,ORX=0,ORDODSG=0
"RTN","ORCHECK",32,0)
 S ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",33,0)
 I $G(ORDG)=+$O(^ORD(100.98,"B","IV RX",0)) S OI=$$PTR^ORCD("OR GTX ADDITIVE"),ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",34,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,MODE,,.ORDODSG),RETURN:$D(ORY),FDBDOWN(0)
"RTN","ORCHECK",35,0)
 Q
"RTN","ORCHECK",36,0)
STUF S ORIT=ORDIALOG(OI,ORI),ORSP=""
"RTN","ORCHECK",37,0)
 S:ORNMSP="LR" ORSP=+$G(ORDIALOG($$PTR^ORCD("OR GTX SPECIMEN"),ORI))
"RTN","ORCHECK",38,0)
 S ORID=$S($E(ORNMSP,1,2)="PS":$$DRUG(ORIT,OI),1:$$USID^ORMBLD(ORIT))
"RTN","ORCHECK",39,0)
 S ORZ=1,ORZ(1)=ORIT_"|"_ORNMSP_"|"_ORID
"RTN","ORCHECK",40,0)
 I MODE'="ALL" D EN^ORKCHK(.ORY,+ORVP,.ORZ,"SELECT",,.ORDODSG),RETURN:$D(ORY)
"RTN","ORCHECK",41,0)
 S ORX=ORX+1,ORX(ORX)=ORZ(1)_"|"_ORSTRT_"||"_ORSP K ORY,ORZ
"RTN","ORCHECK",42,0)
 Q
"RTN","ORCHECK",43,0)
 ;
"RTN","ORCHECK",44,0)
DELAY(MODE) ; -- Delayed ACCEPT event [called from ORMEVNT]
"RTN","ORCHECK",45,0)
 ;    Expects ORVP, ORIFN
"RTN","ORCHECK",46,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",47,0)
 N ORX,ORY,ORCHECK,ORDODSG S:'$L($G(MODE)) MODE="NOTIF"
"RTN","ORCHECK",48,0)
 S ORDODSG=0
"RTN","ORCHECK",49,0)
 D BLD(+ORIFN),EN^ORKCHK(.ORY,+ORVP,.ORX,MODE,,.ORDODSG) Q:'$D(ORY)
"RTN","ORCHECK",50,0)
 D RETURN I MODE="NOTIF" S ORCHECK("OK")="Notification sent to provider" D OC^ORCSAVE2 Q  ; silent
"RTN","ORCHECK",51,0)
 Q
"RTN","ORCHECK",52,0)
 ;
"RTN","ORCHECK",53,0)
BLD(ORDER) ; -- Build new ORX(#) for ORDER
"RTN","ORCHECK",54,0)
 Q:'$G(ORDER)  Q:'$D(^OR(100,ORDER,0))  ;Q:$P($G(^(3)),U,11)  ;edit/renew
"RTN","ORCHECK",55,0)
 N PKG,START,ORI,ITEM,USID,SPEC,ORDG,PTR,INST
"RTN","ORCHECK",56,0)
 S ORDG=$P(^OR(100,ORDER,0),U,11),PKG=$$GET1^DIQ(9.4,$P(^(0),U,14)_",",1)
"RTN","ORCHECK",57,0)
 I PKG="PS",$G(ORDG) S ORI=$P($G(^ORD(100.98,+ORDG,0)),U,3),ORI=$P(ORI," "),PKG=PKG_$S(ORI="UD":"I",1:ORI)
"RTN","ORCHECK",58,0)
 S START=$$START(ORDER),ORI=0
"RTN","ORCHECK",59,0)
 I PKG="PSJ" D
"RTN","ORCHECK",60,0)
 .N ORITEMS,IDX
"RTN","ORCHECK",61,0)
 .D MAYBEIV^ORWDXR01(.ORITEMS,ORDER)
"RTN","ORCHECK",62,0)
 .Q:$G(ORITEMS)=""
"RTN","ORCHECK",63,0)
 .F IDX=1:1:$L(ORITEMS,U) D
"RTN","ORCHECK",64,0)
 ..S ORX=+$G(ORX)+1,ORX(ORX)=$P(ORITEMS,U,IDX),$P(ORX(ORX),"|",3)=$$DRUG(+ORX(ORX),$P(ORX(ORX),"|",3),ORDER)
"RTN","ORCHECK",65,0)
 ..S $P(ORX(ORX),"|",4)=START
"RTN","ORCHECK",66,0)
 Q:+$G(ORX)>0
"RTN","ORCHECK",67,0)
 F  S ORI=$O(^OR(100,ORDER,4.5,"ID","ORDERABLE",ORI)) Q:ORI'>0  D
"RTN","ORCHECK",68,0)
 . S INST=$P($G(^OR(100,ORDER,4.5,ORI,0)),U,3),PTR=$P($G(^(0)),U,2),ITEM=+$G(^(1))
"RTN","ORCHECK",69,0)
 . S USID=$S(PKG?1"PS".E:$$DRUG(ITEM,PTR,ORDER),1:$$USID^ORMBLD(ITEM))
"RTN","ORCHECK",70,0)
 . S SPEC=$S(PKG="LR":$$VALUE^ORCSAVE2(ORDER,"SPECIMEN",INST),1:"")
"RTN","ORCHECK",71,0)
 . S ORX=+$G(ORX)+1,ORX(ORX)=ITEM_"|"_PKG_"|"_USID_"|"_START_"|"_ORDER_"|"_SPEC
"RTN","ORCHECK",72,0)
 Q
"RTN","ORCHECK",73,0)
 ;
"RTN","ORCHECK",74,0)
REMDUPS ;
"RTN","ORCHECK",75,0)
 N IFN,CDL,I,J,CDL2
"RTN","ORCHECK",76,0)
 S IFN=0 F  S IFN=$O(ORCHECK(IFN)) Q:'IFN  D
"RTN","ORCHECK",77,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORCHECK",78,0)
 .. S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORCHECK",79,0)
 ... S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORCHECK",80,0)
 .... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORCHECK",81,0)
 ..... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",82,0)
 ..... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORCHECK",83,0)
 ... I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",84,0)
 Q
"RTN","ORCHECK",85,0)
 ;
"RTN","ORCHECK",86,0)
START(DA) ; -- Returns start date/time
"RTN","ORCHECK",87,0)
 N I,X,Y,%DT S Y=""
"RTN","ORCHECK",88,0)
 I $G(DA) S X=$O(^OR(100,DA,4.5,"ID","START",0)),X=$G(^OR(100,DA,4.5,+X,1))
"RTN","ORCHECK",89,0)
 E  D  ; look in ORDIALOG instead
"RTN","ORCHECK",90,0)
 . S I=0 F  S I=$O(ORDIALOG(I)) Q:I'>0  Q:$P(ORDIALOG(I),U,2)="START"
"RTN","ORCHECK",91,0)
 . S X=$S(I:$G(ORDIALOG(I,1)),1:"")
"RTN","ORCHECK",92,0)
 D AM^ORCSAVE2:X="AM",NEXT^ORCSAVE2:X="NEXT"
"RTN","ORCHECK",93,0)
 D ADMIN^ORCSAVE2("NEXT"):X="NEXTA",ADMIN^ORCSAVE2("CLOSEST"):X="CLOSEST"
"RTN","ORCHECK",94,0)
 I $L(X) S %DT="TX" D ^%DT S:Y'>0 Y=""
"RTN","ORCHECK",95,0)
 Q Y
"RTN","ORCHECK",96,0)
 ;
"RTN","ORCHECK",97,0)
DRUG(OI,PTR,IFN) ; -- Returns 6 ^-piece identifier for Dispense Drug
"RTN","ORCHECK",98,0)
 N ORDD,ORNDF,Y
"RTN","ORCHECK",99,0)
 I ORDG=+$O(^ORD(100.98,"B","IV RX",0)) S ORDD=$$IV G D1
"RTN","ORCHECK",100,0)
 I $G(IFN) S ORDD=$O(^OR(100,IFN,4.5,"ID","DRUG",0)),ORDD=+$G(^OR(100,IFN,4.5,+ORDD,1))
"RTN","ORCHECK",101,0)
 E  S ORDD=+$G(ORDIALOG($$PTR^ORCD("OR GTX DISPENSE DRUG"),1))
"RTN","ORCHECK",102,0)
D1 Q:'ORDD "" S ORNDF=$$ENDCM^PSJORUTL(ORDD)
"RTN","ORCHECK",103,0)
 S Y=$P(ORNDF,U,3)_"^^99NDF^"_ORDD_U_$$NAME50^ORPEAPI(ORDD)_"^99PSD"
"RTN","ORCHECK",104,0)
 Q Y
"RTN","ORCHECK",105,0)
 ;
"RTN","ORCHECK",106,0)
IV() ; -- Get Dispense Drug for IV orderable
"RTN","ORCHECK",107,0)
 N PSOI,TYPE,VOL,ORY
"RTN","ORCHECK",108,0)
 S PSOI=+$P($G(^ORD(101.43,+OI,0)),U,2),VOL=""
"RTN","ORCHECK",109,0)
 S TYPE=$S(PTR=$$PTR^ORCD("OR GTX ADDITIVE"):"A",1:"B")
"RTN","ORCHECK",110,0)
 S:TYPE="B" VOL=$S($G(IFN):$$VALUE^ORCSAVE2(IFN,"VOLUME"),1:+$G(ORDIALOG($$PTR^ORCD("OR GTX VOLUME"),1)))
"RTN","ORCHECK",111,0)
 D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORY)
"RTN","ORCHECK",112,0)
 Q +$G(ORY)
"RTN","ORCHECK",113,0)
 ;
"RTN","ORCHECK",114,0)
LIST(IFN) ; -- Displays list of ORCHECK(IFN) checks
"RTN","ORCHECK",115,0)
 N ORI,ORJ,ORZ,ORMAX,ORTX,ON,OFF
"RTN","ORCHECK",116,0)
 S ORZ=0 F  S ORZ=$O(ORCHECK(IFN,ORZ)) Q:ORZ'>0  D
"RTN","ORCHECK",117,0)
 . S:ORZ=1 ON=IOINHI,OFF=IOINORM S:ORZ'=1 (ON,OFF)="" ; use bold if High
"RTN","ORCHECK",118,0)
 . S ORI=0 F  S ORI=$O(ORCHECK(IFN,ORZ,ORI)) Q:ORI'>0  D
"RTN","ORCHECK",119,0)
 . . S X=$P(ORCHECK(IFN,ORZ,ORI),U,3) I $L(X)<75 W !,ON_">>>  "_X_OFF Q
"RTN","ORCHECK",120,0)
 . . S ORMAX=74 K ORTX D TXT^ORCHTAB Q:'$G(ORTX)  ; wrap
"RTN","ORCHECK",121,0)
 . . F ORJ=1:1:ORTX W !,ON_$S(ORJ=1:">>>  ",1:"      ")_ORTX(ORJ)_OFF
"RTN","ORCHECK",122,0)
 W !
"RTN","ORCHECK",123,0)
 Q
"RTN","ORCHECK",124,0)
 ;
"RTN","ORCHECK",125,0)
CANCEL() ; -- Returns 1 or 0: Cancel order(s)?
"RTN","ORCHECK",126,0)
 N X,Y,DIR,NUM
"RTN","ORCHECK",127,0)
 S NUM=+$G(ORCHECK("IFN")),DIR(0)="YA"
"RTN","ORCHECK",128,0)
 S DIR("A")="Do you want to cancel "_$S(NUM>1:"any of the new orders? ",1:"the new order? ")
"RTN","ORCHECK",129,0)
 S DIR("?",1)="Enter YES to cancel "_$S(NUM>1:"an",1:"the")_" order.  If you wish to override these order checks"
"RTN","ORCHECK",130,0)
 S DIR("?",2)="and release "_$S(NUM>1:"these orders",1:"this order")_", enter NO; you will be prompted for a justification",DIR("?")="if there are any highlighted critical order checks."
"RTN","ORCHECK",131,0)
 D ^DIR
"RTN","ORCHECK",132,0)
 Q +Y
"RTN","ORCHECK",133,0)
 ;
"RTN","ORCHECK",134,0)
REASON() ; -- Reason for overriding order checks
"RTN","ORCHECK",135,0)
 ; I '$D(^XUSEC("ORES",DUZ)),'$D(^XUSEC("ORELSE",DUZ)) Q  ??
"RTN","ORCHECK",136,0)
 N X,Y,DIR
"RTN","ORCHECK",137,0)
 S DIR(0)="FA^2:80^K:X?1."" "" X",DIR("A")="REASON FOR OVERRIDE: "
"RTN","ORCHECK",138,0)
 S DIR("?")="Enter a justification for overriding these order checks, up to 80 characters"
"RTN","ORCHECK",139,0)
 D ^DIR I $D(DTOUT)!$D(DUOUT) S Y="^"
"RTN","ORCHECK",140,0)
 Q Y
"RTN","ORCHECK",141,0)
 ;
"RTN","ORCHECK",142,0)
SESSION ; -- SESSION event [called from ORCSIGN]
"RTN","ORCHECK",143,0)
 ;    Expects ORVP, ORES()
"RTN","ORCHECK",144,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",145,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",146,0)
 N ORX,ORY,ORIFN,I,X,Y,ORGLOB
"RTN","ORCHECK",147,0)
 S ORGLOB=$H
"RTN","ORCHECK",148,0)
 K ^TMP($J,ORGLOB)
"RTN","ORCHECK",149,0)
 S ORIFN=0 F  S ORIFN=$O(ORES(ORIFN)) Q:ORIFN'>0  I +$P(ORIFN,";",2)'>1 D
"RTN","ORCHECK",150,0)
 . I "^14^13^11^10^"'[(U_$P($G(^OR(100,+ORIFN,3)),U,3)_U) Q  ;unreleased
"RTN","ORCHECK",151,0)
 . D BLD(+ORIFN) K ^TMP($J,"OCDATA") Q:'$$OCAPI^ORCHECK(+ORIFN,"OCDATA")
"RTN","ORCHECK",152,0)
 . S ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1
"RTN","ORCHECK",153,0)
 . S I=0 F  S I=$O(^TMP($J,"OCDATA",I)) Q:'I  D
"RTN","ORCHECK",154,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=32,$$ALGASS(+ORIFN)=1 Q
"RTN","ORCHECK",155,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=3 Q
"RTN","ORCHECK",156,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." Q
"RTN","ORCHECK",157,0)
 . . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",158,0)
 . . I $O(^TMP($J,"OCDATA",I,"OC TEXT",1)) D
"RTN","ORCHECK",159,0)
 . . . S ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_"||"_ORGLOB_"&"_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",160,0)
 . . . N ORI S ORI=0 F  S ORI=$O(^TMP($J,"OCDATA",I,"OC TEXT",ORI)) Q:'ORI  S ^TMP($J,"ORK XTRA TXT",ORGLOB,^TMP($J,"OCDATA",I,"OC TEXT",1,0),ORI)=^TMP($J,"OCDATA",I,"OC TEXT",ORI,0)
"RTN","ORCHECK",161,0)
 . . I $D(^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)) D
"RTN","ORCHECK",162,0)
 . . . N ORMONOI S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",""),-1)+1
"RTN","ORCHECK",163,0)
 . . . M ^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)
"RTN","ORCHECK",164,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),17)
"RTN","ORCHECK",165,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")=$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))
"RTN","ORCHECK",166,0)
 . K ^TMP($J,"OCDATA")
"RTN","ORCHECK",167,0)
 I $D(ORX) D EN^ORKCHK(.ORY,+ORVP,.ORX,"SESSION"),RETURN:$D(ORY),FDBDOWN(1),REMDUPS
"RTN","ORCHECK",168,0)
 Q
"RTN","ORCHECK",169,0)
 ;
"RTN","ORCHECK",170,0)
FDBDOWN(ORX) ; -- Checks to see if the FDB was down and if so set appropriate OC
"RTN","ORCHECK",171,0)
 ; expects ORCHECK array of order checks
"RTN","ORCHECK",172,0)
 ; if ORX is 1 then this is getting called from SESSION order checks
"RTN","ORCHECK",173,0)
 Q:'$D(ORCHECK)
"RTN","ORCHECK",174,0)
 ;look for the "not able to be performed" OCs for each type (DSG and ENH), set flag for each to 1 if found and remove them from ORCHECK
"RTN","ORCHECK",175,0)
 N I S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORCHECK",176,0)
 .N ORNEXT,ORDSG,ORENH,ORTHERE
"RTN","ORCHECK",177,0)
 .S ORDSG=0,ORENH=0,ORTHERE=0,ORNEXT=1
"RTN","ORCHECK",178,0)
 .N J S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORCHECK",179,0)
 ..N K S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORCHECK",180,0)
 ...I (K+1)>ORNEXT S ORNEXT=K+1
"RTN","ORCHECK",181,0)
 ...I $G(ORCHECK(I,J,K))[$$DSDWNMSG^ORDSGCHK K ORCHECK(I,J,K) S ORDSG=1
"RTN","ORCHECK",182,0)
 ...I $G(ORCHECK(I,J,K))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." K ORCHECK(I,J,K) S ORENH=1
"RTN","ORCHECK",183,0)
 ...I $G(ORCHECK(I,J,K))["These checks could not be completed for this patient:" S ORTHERE=1
"RTN","ORCHECK",184,0)
 .;if DSG or ENH flag is set then add to ORY
"RTN","ORCHECK",185,0)
 .I ORDSG!(ORENH) D
"RTN","ORCHECK",186,0)
 ..;look to see if message already exists
"RTN","ORCHECK",187,0)
 ..I ORTHERE Q
"RTN","ORCHECK",188,0)
 ..N ORKGLOB S ORKGLOB=$H_","_I
"RTN","ORCHECK",189,0)
 ..N ORMAIN S ORMAIN="These checks could not be completed for this patient:"
"RTN","ORCHECK",190,0)
 ..S ORCHECK(I,2,ORNEXT)="25^2^||"_ORKGLOB_"&"_ORMAIN
"RTN","ORCHECK",191,0)
 ..I $G(ORX) S ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,0)=ORMAIN
"RTN","ORCHECK",192,0)
 ..N ORCNT S ORCNT=1
"RTN","ORCHECK",193,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Drug Interactions"
"RTN","ORCHECK",194,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Duplicate Therapy"
"RTN","ORCHECK",195,0)
 ..I '$G(ORX),ORDSG S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Dosing"
"RTN","ORCHECK",196,0)
 Q
"RTN","ORCHECK",197,0)
 ;
"RTN","ORCHECK",198,0)
RETURN ; -- Return checks in ORCHECK(ORIFN,CDL,#)
"RTN","ORCHECK",199,0)
 N I,IFN,CDL S I=0 F  S I=$O(ORY(I)) Q:I'>0  D
"RTN","ORCHECK",200,0)
 . S IFN=+$P(ORY(I),U) S:'IFN IFN="NEW"
"RTN","ORCHECK",201,0)
 . S CDL=+$P(ORY(I),U,3) S:'CDL CDL=99
"RTN","ORCHECK",202,0)
 . S:'$D(ORCHECK(IFN)) ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1 ; count
"RTN","ORCHECK",203,0)
 . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(IFN,CDL,ORCHECK)=$P(ORY(I),U,2,4)
"RTN","ORCHECK",204,0)
 Q
"RTN","ORCHECK",205,0)
 ;
"RTN","ORCHECK",206,0)
ALGASS(ORIFN) ;see if patient from order has an allergy assessment
"RTN","ORCHECK",207,0)
 N ORDFN S ORDFN=+$P(^OR(100,ORIFN,0),U,2)
"RTN","ORCHECK",208,0)
 K ORARRAY D EN1^GMRAOR1(ORDFN,"ORARRAY")
"RTN","ORCHECK",209,0)
 I ORARRAY'="" Q 1
"RTN","ORCHECK",210,0)
 Q 0
"RTN","ORCHECK",211,0)
OCAPI(IFN,ORPLACE) ;IA #4859
"RTN","ORCHECK",212,0)
 ;LOOK AT ROUTINE OROCAPI1 FOR MORE DETAILED APIS
"RTN","ORCHECK",213,0)
 ;API to get the order checking info for a specific order (IFN)
"RTN","ORCHECK",214,0)
 ;info is stored in ^TMP($J,ORPLACE)
"RTN","ORCHECK",215,0)
 ;               ^TMP($J,ORPLACE,D0,"OC LEVEL")="order check level"
"RTN","ORCHECK",216,0)
 ;                                                 ,"OC NUMBER")="file 100.8 ien"
"RTN","ORCHECK",217,0)
 ;                                                 ,"OC TEXT")="order check text"
"RTN","ORCHECK",218,0)
 ;                                                 ,"OR REASON")="over ride reason text"
"RTN","ORCHECK",219,0)
 ;                                                 ,"OR PROVIDER")="provider DUZ who entered over ride reason"
"RTN","ORCHECK",220,0)
 ;                                                 ,"OR DT")="date/time over ride reason was entered"
"RTN","ORCHECK",221,0)
 ; NOTE on OC LEVEL: 1 is HIGH, 2 is MODERATE, 3 is LOW
"RTN","ORCHECK",222,0)
 N RET,ORN,CNT,I,ORFLAG
"RTN","ORCHECK",223,0)
 S ORN=+IFN,CNT=0,ORFLAG=0
"RTN","ORCHECK",224,0)
 ;if the order is not released then show ACCEPTANCE_CPRS ocs
"RTN","ORCHECK",225,0)
 I "^14^13^11^10^"[(U_$P($G(^OR(100,ORN,3)),U,3)_U) D GETOC5^OROCAPI1(ORN,"ACCEPTANCE_CPRS",.RET) S ORFLAG=1
"RTN","ORCHECK",226,0)
 ;if it has been signed then show SIGNATURE_CPRS ocs
"RTN","ORCHECK",227,0)
 I 'ORFLAG D GETOC5^OROCAPI1(ORN,"SIGNATURE_CPRS",.RET)
"RTN","ORCHECK",228,0)
 I $D(RET) S I=0 F  S I=$O(RET(ORN,"DATA",I)) Q:'I  S CNT=CNT+1 D
"RTN","ORCHECK",229,0)
 .S ^TMP($J,ORPLACE,CNT,"OC NUMBER")=$P($G(RET(ORN,"DATA",I,1)),U)
"RTN","ORCHECK",230,0)
 .S ^TMP($J,ORPLACE,CNT,"OC LEVEL")=$P($G(RET(ORN,"DATA",I,1)),U,2)
"RTN","ORCHECK",231,0)
 .M ^TMP($J,ORPLACE,CNT,"OC TEXT")=RET(ORN,"DATA",I,"OC")
"RTN","ORCHECK",232,0)
 .S ^TMP($J,ORPLACE,CNT,"OR REASON")=$G(RET(ORN,"DATA",I,"OR",1,0))
"RTN","ORCHECK",233,0)
 .S ^TMP($J,ORPLACE,CNT,"OR PROVIDER")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,4),1:"")
"RTN","ORCHECK",234,0)
 .S ^TMP($J,ORPLACE,CNT,"OR DT")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,5),1:"")
"RTN","ORCHECK",235,0)
 .S ^TMP($J,ORPLACE,CNT,"OR STATUS")=$P($G(RET(ORN,"DATA",I,0)),U,2)
"RTN","ORCHECK",236,0)
 .S ^TMP($J,ORPLACE,CNT,"OC INSTANCE")=I
"RTN","ORCHECK",237,0)
 Q CNT
"RTN","ORCHECK",238,0)
 ;
"RTN","ORCHECK",239,0)
ISMONO(ORY) ;returns 1 if there is monograph data for the orderchecks being presented to the user
"RTN","ORCHECK",240,0)
 S ORY=0
"RTN","ORCHECK",241,0)
 Q:'$$PATCH^XPDUTL("OR*3.0*272")
"RTN","ORCHECK",242,0)
 I $D(^TMP($J,"ORMONOGRAPH")) S ORY=1
"RTN","ORCHECK",243,0)
 Q
"RTN","ORCHECK",244,0)
GETMONOL(ORY) ;returns a list of monographs available for the orderchecks being presented to the user
"RTN","ORCHECK",245,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH"))
"RTN","ORCHECK",246,0)
 N I S I=0
"RTN","ORCHECK",247,0)
 F  S I=$O(^TMP($J,"ORMONOGRAPH",I)) Q:'I  D
"RTN","ORCHECK",248,0)
 .S ORY($G(^TMP($J,"ORMONOGRAPH",I,"INT")))=I_U_$G(^TMP($J,"ORMONOGRAPH",I,"INT"))
"RTN","ORCHECK",249,0)
 Q
"RTN","ORCHECK",250,0)
GETMONO(ORY,ORMONO) ;return a monograph
"RTN","ORCHECK",251,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH",ORMONO))
"RTN","ORCHECK",252,0)
 K ^TMP($J,"ORMONORPC")
"RTN","ORCHECK",253,0)
 M ^TMP($J,"ORMONORPC")=^TMP($J,"ORMONOGRAPH",ORMONO,"DATA")
"RTN","ORCHECK",254,0)
 K ^TMP($J,"ORMONORPC",0)
"RTN","ORCHECK",255,0)
 S ORY=$NA(^TMP($J,"ORMONORPC")),@ORY=""
"RTN","ORCHECK",256,0)
 Q
"RTN","ORCHECK",257,0)
DELMONO(ORY) ;delete monograph data
"RTN","ORCHECK",258,0)
 K ^TMP($J,"ORMONOGRAPH"),^TMP($J,"ORMONORPC")
"RTN","ORCHECK",259,0)
 Q
"RTN","ORCHECK",260,0)
GETXTRA(ORY,ORGL,ORRULE) ;get extra text for an order check
"RTN","ORCHECK",261,0)
 ;^TMP($J,"ORK XTRA TXT") stores the text of order checks that are longer than a single line (reminder order checks)
"RTN","ORCHECK",262,0)
 Q:'$D(^TMP($J,"ORK XTRA TXT",ORGL,ORRULE))
"RTN","ORCHECK",263,0)
 M ORY=^TMP($J,"ORK XTRA TXT",ORGL,ORRULE)
"RTN","ORCHECK",264,0)
 Q
"RTN","ORDSGCHK")
0^1^B109352032
"RTN","ORDSGCHK",1,0)
ORDSGCHK ; SLC/AGP - PRE 0.5 DOSE ORDER CHECKS;10/05/12  07:54;04/23/12  10:18
"RTN","ORDSGCHK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**280,345**;Dec 17, 1997;Build 32
"RTN","ORDSGCHK",3,0)
 ;
"RTN","ORDSGCHK",4,0)
EN(ORY,DFN,TYPE,OIL) ;
"RTN","ORDSGCHK",5,0)
 N ARRAY,CNT,NAME
"RTN","ORDSGCHK",6,0)
 ;if renewed order build OIL array
"RTN","ORDSGCHK",7,0)
 I $G(ORREN)=1,+$G(ORIFN)>0 D
"RTN","ORDSGCHK",8,0)
 .;IV orders should only have a null type
"RTN","ORDSGCHK",9,0)
 .I TYPE="" S TYPE="PSIV"
"RTN","ORDSGCHK",10,0)
 .D BLDREN(TYPE,ORIFN,.OIL)
"RTN","ORDSGCHK",11,0)
 ;Build easy array to work with
"RTN","ORDSGCHK",12,0)
 S CNT=0 F  S CNT=$O(OIL(CNT)) Q:CNT'>0  D
"RTN","ORDSGCHK",13,0)
 .S NODE=$G(OIL(CNT)) Q:$P(NODE,U,2)="PSIV"
"RTN","ORDSGCHK",14,0)
 .S NAME=$P(NODE,U,2)
"RTN","ORDSGCHK",15,0)
 .Q:'$P(NODE,U,3)
"RTN","ORDSGCHK",16,0)
 .S ARRAY(NAME,$P(NODE,U,3))=NODE
"RTN","ORDSGCHK",17,0)
 I TYPE="PSH" Q
"RTN","ORDSGCHK",18,0)
 I TYPE="PSIV" D IV(.ORY,DFN,.ARRAY)
"RTN","ORDSGCHK",19,0)
 I TYPE'="PSIV" D NONIV(.ORY,DFN,.ARRAY)
"RTN","ORDSGCHK",20,0)
 Q
"RTN","ORDSGCHK",21,0)
 ;
"RTN","ORDSGCHK",22,0)
BLDREN(TYPE,ORIFN,OUT) ;
"RTN","ORDSGCHK",23,0)
 N CNT,EXTVALUE,ISOI,ITEM,LOC,NAME,NUM,NODE,ORDIALOG,TEXT,VALUE,X0
"RTN","ORDSGCHK",24,0)
 S CNT=$O(OUT(""),-1)
"RTN","ORDSGCHK",25,0)
 S X0=$G(^OR(100,+ORIFN,0))
"RTN","ORDSGCHK",26,0)
 S ORDIALOG=+$P(X0,U,5)
"RTN","ORDSGCHK",27,0)
 D GETDLG^ORCD(ORDIALOG)
"RTN","ORDSGCHK",28,0)
 D GETORDER^ORCD(+ORIFN)
"RTN","ORDSGCHK",29,0)
 S LOC=0 F  S LOC=$O(ORDIALOG(LOC)) Q:LOC'>0  D
"RTN","ORDSGCHK",30,0)
 .S ITEM=$P($G(ORDIALOG(LOC)),U,2)
"RTN","ORDSGCHK",31,0)
 .I ITEM="" Q
"RTN","ORDSGCHK",32,0)
 .I ITEM="COMMENT" Q
"RTN","ORDSGCHK",33,0)
 .S ISOI=$S($G(ORDIALOG(LOC,0))[101.43:1,1:0)
"RTN","ORDSGCHK",34,0)
 .S NUM=0 F  S NUM=$O(ORDIALOG(LOC,NUM)) Q:NUM'>0  D
"RTN","ORDSGCHK",35,0)
 ..I NUM<1 Q
"RTN","ORDSGCHK",36,0)
 ..S VALUE=$G(ORDIALOG(LOC,NUM)),EXTVALUE=""
"RTN","ORDSGCHK",37,0)
 ..I ISOI=1 D
"RTN","ORDSGCHK",38,0)
 ...S EXTVALUE=$P($G(^ORD(101.43,VALUE,0)),U)
"RTN","ORDSGCHK",39,0)
 ...I $P($G(^ORD(101.41,LOC,0)),U)="OR GTX ADDITIVE" S ITEM="ADDITIVE"
"RTN","ORDSGCHK",40,0)
 ..I ITEM="RATE" S EXTVALUE=VALUE
"RTN","ORDSGCHK",41,0)
 ..S TEXT=TYPE_U_ITEM_U_NUM_U_VALUE_U_EXTVALUE
"RTN","ORDSGCHK",42,0)
 ..S CNT=CNT+1,OUT(CNT)=TEXT
"RTN","ORDSGCHK",43,0)
 Q
"RTN","ORDSGCHK",44,0)
 ;
"RTN","ORDSGCHK",45,0)
DURATION(STR) ;
"RTN","ORDSGCHK",46,0)
 N LEN,VAL,UNIT,IVLMT,TVAL
"RTN","ORDSGCHK",47,0)
 S (UNIT,IVLMT)="",VAL=0
"RTN","ORDSGCHK",48,0)
 I $E($$LOW^XLFSTR(STR))="f" D
"RTN","ORDSGCHK",49,0)
 . I STR["for a total of" D  Q
"RTN","ORDSGCHK",50,0)
 . .S VAL=$P(STR," ",5)
"RTN","ORDSGCHK",51,0)
 . .S UNIT=$P(STR," ",6)
"RTN","ORDSGCHK",52,0)
 . .S STR=""
"RTN","ORDSGCHK",53,0)
 . S VAL=$P(STR," ",2)
"RTN","ORDSGCHK",54,0)
 . S UNIT=$E($P(STR," ",3))
"RTN","ORDSGCHK",55,0)
 . S STR=""
"RTN","ORDSGCHK",56,0)
 I $E($$LOW^XLFSTR(STR))="w" D
"RTN","ORDSGCHK",57,0)
 . S TVAL=$P(STR," ",4)
"RTN","ORDSGCHK",58,0)
 . S VAL=+TVAL
"RTN","ORDSGCHK",59,0)
 . S LEN=$F(TVAL,VAL)
"RTN","ORDSGCHK",60,0)
 . I $P(VAL,".")="" S VAL=0_VAL
"RTN","ORDSGCHK",61,0)
 . F  S UNIT=$E(TVAL,LEN) Q:((UNIT'=0)&(UNIT'="."))  D
"RTN","ORDSGCHK",62,0)
 . . S LEN=LEN+1
"RTN","ORDSGCHK",63,0)
 . S STR=""
"RTN","ORDSGCHK",64,0)
 I $L(UNIT),$L(VAL) S IVLMT=VAL_$$UP^XLFSTR(UNIT)
"RTN","ORDSGCHK",65,0)
 I STR'="",IVLMT="" D
"RTN","ORDSGCHK",66,0)
 .I STR["ML" S IVLMT=$P(STR,"M")_"M" Q
"RTN","ORDSGCHK",67,0)
 .I STR["CC" S IVLMT=$P(STR,"C")_"M" Q
"RTN","ORDSGCHK",68,0)
 .S IVLMT=STR
"RTN","ORDSGCHK",69,0)
 Q IVLMT
"RTN","ORDSGCHK",70,0)
 ;
"RTN","ORDSGCHK",71,0)
IV(ORY,DFN,ARRAY) ;
"RTN","ORDSGCHK",72,0)
 N CNT,DRUG,DRUGIEN,DRUGNAME,NAME,NUM,OI,ORBASE,ORPSJARR,STR,STRENGTH
"RTN","ORDSGCHK",73,0)
 ;
"RTN","ORDSGCHK",74,0)
 ;populate single values from order
"RTN","ORDSGCHK",75,0)
 S ORPSJARR("TVOL_DUR")="",ORPSJARR("SCHEDULE")=""
"RTN","ORDSGCHK",76,0)
 I $D(ARRAY("DAYS")) S ORPSJARR("TVOL_DUR")=$$DURATION($P(ARRAY("DAYS",1),U,4))
"RTN","ORDSGCHK",77,0)
 ;S RATE=$P(ARRAY(NAME,1),U,4)
"RTN","ORDSGCHK",78,0)
 S ORPSJARR("MR_IEN")=$P(ARRAY("ROUTE",1),U,4)
"RTN","ORDSGCHK",79,0)
 I $D(ARRAY("SCHEDULE")) S ORPSJARR("SCHEDULE")=$P(ARRAY("SCHEDULE",1),U,4)
"RTN","ORDSGCHK",80,0)
 S ORPSJARR("IV_TYPE")=$S($P(ARRAY("TYPE",1),U,4)="I":1,1:2)
"RTN","ORDSGCHK",81,0)
 I ORPSJARR("IV_TYPE")=2 S ORPSJARR("INF_RATE")=$P(ARRAY("RATE",1),U,5)
"RTN","ORDSGCHK",82,0)
 ;
"RTN","ORDSGCHK",83,0)
 ;build additive first, Drug, Strength/unit, bag
"RTN","ORDSGCHK",84,0)
 F NAME="ADDITIVE","ORDERABLE" D
"RTN","ORDSGCHK",85,0)
 .K DRUG
"RTN","ORDSGCHK",86,0)
 .S CNT=0,NUM=0
"RTN","ORDSGCHK",87,0)
 .F  S NUM=$O(ARRAY(NAME,NUM)) Q:NUM'>0  D
"RTN","ORDSGCHK",88,0)
 ..S CNT=CNT+1
"RTN","ORDSGCHK",89,0)
 ..S NODE=$G(ARRAY(NAME,NUM)),OI=$P(NODE,U,4)
"RTN","ORDSGCHK",90,0)
 ..;
"RTN","ORDSGCHK",91,0)
 ..S DRUGIEN=+$P(^ORD(101.43,OI,0),U,2) I DRUGIEN="" Q  ;PHARMACY OI FROM 101.43
"RTN","ORDSGCHK",92,0)
 ..S DRUGNAME=$P($G(ARRAY(NAME,NUM)),U,5) ;OI NAME
"RTN","ORDSGCHK",93,0)
 ..;
"RTN","ORDSGCHK",94,0)
 ..I NAME="ADDITIVE" D  Q
"RTN","ORDSGCHK",95,0)
 ...S STRENGTH=$P($G(ARRAY("STRENGTH",NUM)),U,4)_" "_$P($G(ARRAY("UNITS",NUM)),U,4)
"RTN","ORDSGCHK",96,0)
 ...S STR=+DRUGIEN_U_DRUGNAME_U_STRENGTH_U_$P($G(ARRAY("ADDFREQ",NUM)),U,4)
"RTN","ORDSGCHK",97,0)
 ...S ORPSJARR("AD",CNT)=STR_U_0
"RTN","ORDSGCHK",98,0)
 ...;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",99,0)
 ...I $G(^TMP($J,"ORENHCHK"))=1 S ORPSJARR("AD",CNT)=STR_U_1
"RTN","ORDSGCHK",100,0)
 ..;
"RTN","ORDSGCHK",101,0)
 ..;Soltution information
"RTN","ORDSGCHK",102,0)
 ..S STR=+DRUGIEN_U_DRUGNAME_U_$P($G(ARRAY("VOLUME",NUM)),U,4)_" ML"
"RTN","ORDSGCHK",103,0)
 ..S ORPSJARR("SOL",CNT)=STR,$P(ORPSJARR("SOL",CNT),U,5)=0
"RTN","ORDSGCHK",104,0)
 ..;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",105,0)
 ..I $G(^TMP($J,"ORENHCHK"))=1 S ORPSJARR("SOL",CNT)=STR,$P(ORPSJARR("SOL",CNT),U,5)=1
"RTN","ORDSGCHK",106,0)
 ;
"RTN","ORDSGCHK",107,0)
 I $D(^TMP($J,"ORDSGCHK_CACHE")) M ^TMP($J,"ORDSGCHK2")=^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORDSGCHK",108,0)
 I '$D(^TMP($J,"ORDSGCHK_CACHE")) D
"RTN","ORDSGCHK",109,0)
 .S ORBASE(1)="ORDSGCHK1"
"RTN","ORDSGCHK",110,0)
 .S ORBASE(2)="ORDSGCHK2"
"RTN","ORDSGCHK",111,0)
 .D DOSE^PSJAPIDS(.ORBASE,DFN,.ORPSJARR)
"RTN","ORDSGCHK",112,0)
 .M ^TMP($J,"ORDSGCHK_CACHE")=^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",113,0)
 D PARSEOUT
"RTN","ORDSGCHK",114,0)
 K ^TMP($J,"ORDSGCHK1"),^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",115,0)
 Q
"RTN","ORDSGCHK",116,0)
 ;
"RTN","ORDSGCHK",117,0)
NONIV(ORY,DFN,ARRAY) ;
"RTN","ORDSGCHK",118,0)
 N CNT,DOSESTR,DRUG,DRUGARR,DRUGIEN,DRUGNAME,DUR,NAME,NODE
"RTN","ORDSGCHK",119,0)
 N OIIEN,ORBASE,ORDRUG,ORPSARR,PACK,PSNODE,SUB,TYPE,USAGE
"RTN","ORDSGCHK",120,0)
 ;
"RTN","ORDSGCHK",121,0)
 ;assume same drug type used throughout the order dialog
"RTN","ORDSGCHK",122,0)
 ;free text dose do not have a drug.
"RTN","ORDSGCHK",123,0)
 S DRUGIEN=$P($G(ARRAY("DRUG",1)),U,4)
"RTN","ORDSGCHK",124,0)
 I +DRUGIEN>0,$$EXMT^PSSDSAPI(DRUGIEN)=1 Q
"RTN","ORDSGCHK",125,0)
 ;if no ARRAY(DOSE) node set it to null to force free text evaluation
"RTN","ORDSGCHK",126,0)
 ;I '$D(ARRAY("DOSE")),$D(ARRAY("INSTR")) N I S I=0 F  S I=$O(ARRAY("INSTR",I)) Q:'I  S ARRAY("DOSE",I)=$P(ARRAY("INSTR",I),U)_"^DOSE^"_I_"^"
"RTN","ORDSGCHK",127,0)
 N I S I=0 F  S I=$O(ARRAY("INSTR",I)) Q:'I  I '$D(ARRAY("DOSE",I))  S ARRAY("DOSE",I)=$P(ARRAY("INSTR",I),U)_"^DOSE^"_I_"^"
"RTN","ORDSGCHK",128,0)
 ;
"RTN","ORDSGCHK",129,0)
 S NAME="" F  S NAME=$O(ARRAY(NAME)) Q:NAME=""  D
"RTN","ORDSGCHK",130,0)
 .S SUB=$$GETSUB(NAME) I SUB="" Q
"RTN","ORDSGCHK",131,0)
 .S CNT=0 F  S CNT=$O(ARRAY(NAME,CNT)) Q:CNT'>0  D
"RTN","ORDSGCHK",132,0)
 ..S NODE=$G(ARRAY(NAME,CNT))
"RTN","ORDSGCHK",133,0)
 ..;
"RTN","ORDSGCHK",134,0)
 ..;get dose information and drug information from Dose Prompt
"RTN","ORDSGCHK",135,0)
 ..I SUB="DOSE" D
"RTN","ORDSGCHK",136,0)
 ...S PACK=$P(NODE,U)
"RTN","ORDSGCHK",137,0)
 ...S TYPE=$S($P(NODE,U)="PSO":"O",1:"I")
"RTN","ORDSGCHK",138,0)
 ...S DOSESTR=$P(NODE,U,4)
"RTN","ORDSGCHK",139,0)
 ...;free text dose
"RTN","ORDSGCHK",140,0)
 ...I DOSESTR="" D
"RTN","ORDSGCHK",141,0)
 ....S ARRAY("ORPSA",CNT)=$$OI2DD^ORKPS($P(ARRAY("ORDERABLE",1),U,4),$E($P(ARRAY("ORDERABLE",1),U,1),3),2)
"RTN","ORDSGCHK",142,0)
 ....Q:'$P(ARRAY("ORPSA",CNT),";",1)
"RTN","ORDSGCHK",143,0)
 ....N ORQUIT S ORQUIT=0
"RTN","ORDSGCHK",144,0)
 ....I $G(ORREN)=1 D
"RTN","ORDSGCHK",145,0)
 .....N PSIFN S PSIFN=$G(^OR(100,+ORIFN,4))
"RTN","ORDSGCHK",146,0)
 .....S:TYPE="O" PSIFN=$TR(PSIFN,"S","P")_$S(PSIFN?1.N:"R",1:"")
"RTN","ORDSGCHK",147,0)
 .....K ^TMP("PS",$J)
"RTN","ORDSGCHK",148,0)
 .....D OEL^PSOORRL(DFN,PSIFN_";"_TYPE)  ;DBIA 2400
"RTN","ORDSGCHK",149,0)
 .....I '$D(^TMP("PS",$J)) Q
"RTN","ORDSGCHK",150,0)
 .....S ORPSARR(CNT,"DO")=$P($G(ARRAY("INSTR",CNT)),U,4)
"RTN","ORDSGCHK",151,0)
 .....S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",152,0)
 .....S ORDRUG(CNT,"DRUG_IEN")=+$G(^TMP("PS",$J,"DD",1,0))
"RTN","ORDSGCHK",153,0)
 .....S ORDRUG(CNT,"DRUG_NM")=$P($G(^TMP("PS",$J,0)),U)
"RTN","ORDSGCHK",154,0)
 .....S ORQUIT=1
"RTN","ORDSGCHK",155,0)
 .....K ^TMP("PS",$J)
"RTN","ORDSGCHK",156,0)
 ....I ORQUIT=1 Q
"RTN","ORDSGCHK",157,0)
 ....S ORPSARR(CNT,"DO")=$P($G(ARRAY("INSTR",CNT)),U,4)
"RTN","ORDSGCHK",158,0)
 ....S ORDRUG(CNT,"DRUG_NM")=$$TRIM^ORBCMA32($P($G(ARRAY("ORDERABLE",1)),U,5))
"RTN","ORDSGCHK",159,0)
 ....S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",160,0)
 ....S OIIEN=$P($G(ARRAY("ORDERABLE",1)),U,4) ;orderable only exists for first item (in complex order)
"RTN","ORDSGCHK",161,0)
 ....S ORDRUG("OI")=+$P($G(^ORD(101.43,OIIEN,0)),U,2)
"RTN","ORDSGCHK",162,0)
 ....S ORDRUG("PACKAGE")=$S(PACK="PSO":"O",PACK="PSH":"X",1:"I")
"RTN","ORDSGCHK",163,0)
 ....S PSNODE=$G(^ORD(101.43,OIIEN,"PS")),USAGE=""
"RTN","ORDSGCHK",164,0)
 ....I $P(PSNODE,U,4)=1 S USAGE=USAGE_"A"
"RTN","ORDSGCHK",165,0)
 ....I $P(PSNODE,U,3)=1 S USAGE=USAGE_"B"
"RTN","ORDSGCHK",166,0)
 ....S ORDRUG("OI_USAGE")=USAGE
"RTN","ORDSGCHK",167,0)
 ...;
"RTN","ORDSGCHK",168,0)
 ...;check if enhanced order checks were done for this drug order and if so set ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",169,0)
 ...I $G(^TMP($J,"ORENHCHK"))=1,((DOSESTR=""&$D(ORDRUG))!(DOSESTR'="")) S ORDRUG(CNT,"ENH")=1
"RTN","ORDSGCHK",170,0)
 ...Q:DOSESTR=""
"RTN","ORDSGCHK",171,0)
 ...S DRUGIEN=$P(DOSESTR,"&",6)
"RTN","ORDSGCHK",172,0)
 ...K ^TMP($J,"DRUGARR")
"RTN","ORDSGCHK",173,0)
 ...D ZERO^PSS50(DRUGIEN,,,,,"DRUGARR")
"RTN","ORDSGCHK",174,0)
 ...S DRUGNAME=$G(^TMP($J,"DRUGARR",DRUGIEN,.01))
"RTN","ORDSGCHK",175,0)
 ...K ^TMP($J,"DRUGARR")
"RTN","ORDSGCHK",176,0)
 ...;
"RTN","ORDSGCHK",177,0)
 ...;Local Possible Dose
"RTN","ORDSGCHK",178,0)
 ...I $P(DOSESTR,"&")="" D  Q
"RTN","ORDSGCHK",179,0)
 ....S ORPSARR(CNT,"DO")=$P($G(ARRAY("INSTR",CNT)),U,4)
"RTN","ORDSGCHK",180,0)
 ....S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",181,0)
 ....S ORDRUG(CNT,"DRUG_IEN")=DRUGIEN
"RTN","ORDSGCHK",182,0)
 ....S ORDRUG(CNT,"DRUG_NM")=$$GETPSNM^ORKPS(DRUGIEN) ;DRUGNAME
"RTN","ORDSGCHK",183,0)
 ...;
"RTN","ORDSGCHK",184,0)
 ...;Possible Dose
"RTN","ORDSGCHK",185,0)
 ...S ORPSARR(CNT,"DRG_AMT")=$P(DOSESTR,"&")
"RTN","ORDSGCHK",186,0)
 ...S ORPSARR(CNT,"DRG_UNIT")=$P(DOSESTR,"&",2)
"RTN","ORDSGCHK",187,0)
 ...S ORDRUG(CNT,"RX_NUM")=TYPE_";1;PROSPECTIVE;"_CNT
"RTN","ORDSGCHK",188,0)
 ...S ORDRUG(CNT,"DRUG_IEN")=DRUGIEN
"RTN","ORDSGCHK",189,0)
 ...S ORDRUG(CNT,"DRUG_NM")=$$GETPSNM^ORKPS(DRUGIEN) ;DRUGNAME
"RTN","ORDSGCHK",190,0)
 ..;
"RTN","ORDSGCHK",191,0)
 ..;Additional Order Data
"RTN","ORDSGCHK",192,0)
 ..I SUB="DRATE" D  Q
"RTN","ORDSGCHK",193,0)
 ...S DUR=$P($P(NODE,U,4)," ")
"RTN","ORDSGCHK",194,0)
 ...S ORPSARR(CNT,SUB)=DUR_$$DRATESTR($P($P(NODE,U,4)," ",2))
"RTN","ORDSGCHK",195,0)
 ..S ORPSARR(CNT,SUB)=$P(NODE,U,4)
"RTN","ORDSGCHK",196,0)
 ;
"RTN","ORDSGCHK",197,0)
 I $D(ORDRUG) D
"RTN","ORDSGCHK",198,0)
 .S ORBASE(1)="ORDSGCHK1",ORBASE(2)="ORDSGCHK2"
"RTN","ORDSGCHK",199,0)
 .D DOSE^PSSDSAPD(.ORBASE,DFN,.ORPSARR,.ORDRUG),PARSEOUT
"RTN","ORDSGCHK",200,0)
 .K ^TMP($J,"ORDSGCHK1"),^TMP($J,"ORDSGCHK2")
"RTN","ORDSGCHK",201,0)
 Q
"RTN","ORDSGCHK",202,0)
 ;
"RTN","ORDSGCHK",203,0)
PARSEOUT ;PARSE OUTPUT GLOBAL
"RTN","ORDSGCHK",204,0)
 N ORNBP S ORNBP=""
"RTN","ORDSGCHK",205,0)
 I $D(^TMP($J,"ORDSGCHK2")) D
"RTN","ORDSGCHK",206,0)
 .I $P($G(^TMP($J,"ORDSGCHK2","OUT",0)),U)=-1 S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_$$DSDWNMSG^ORDSGCHK Q
"RTN","ORDSGCHK",207,0)
 .I $D(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR")) D
"RTN","ORDSGCHK",208,0)
 ..N I S I="" F  S I=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I)) Q:'$L(I)  D
"RTN","ORDSGCHK",209,0)
 ...N J S J="" F  S J=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J)) Q:'$L(J)  D
"RTN","ORDSGCHK",210,0)
 .... I $L($G(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J,"MSG"))) S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J,"MSG") D
"RTN","ORDSGCHK",211,0)
 ..... I $L($G(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J,"TEXT"))) S ORY(ORY)=ORY(ORY)_".  "_$G(^TMP($J,"ORDSGCHK2","OUT","DOSE","ERROR",I,J,"TEXT"))
"RTN","ORDSGCHK",212,0)
 .I $D(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE")) D
"RTN","ORDSGCHK",213,0)
 ..N I S I="" F  S I=$O(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I)) Q:'$L(I)  D
"RTN","ORDSGCHK",214,0)
 ...N J S J="" F  S J=$O(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J)) Q:'$L(J)  D
"RTN","ORDSGCHK",215,0)
 .... I $G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))["could not be performed" S ORNBP=^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J) Q
"RTN","ORDSGCHK",216,0)
 .... I $G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))["Error Summary" S ORNBP=^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J) Q
"RTN","ORDSGCHK",217,0)
 .... I $G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))["Reason(s):" S ORNBP=ORNBP_"."_^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J) Q
"RTN","ORDSGCHK",218,0)
 .... I $G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))["           " S ORNBP=ORNBP_"."_$P(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J),"           ",2) Q
"RTN","ORDSGCHK",219,0)
 .... I $L(ORNBP)>1 S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_ORNBP,ORNBP=""
"RTN","ORDSGCHK",220,0)
 .... I $L($G(^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J))) S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_^TMP($J,"ORDSGCHK2","OUT","EXCEPTIONS","DOSE",I,J)
"RTN","ORDSGCHK",221,0)
 .N I S I="" F  S I=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I)) Q:'$L(I)  D
"RTN","ORDSGCHK",222,0)
 ..Q:(I="ERROR")
"RTN","ORDSGCHK",223,0)
 ..N J S J="" F  S J=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J)) Q:'$L(J)  D
"RTN","ORDSGCHK",224,0)
 ...N TYP S TYP="" F  S TYP=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP)) Q:'$L(TYP)  D
"RTN","ORDSGCHK",225,0)
 ....N ORDIEN S ORDIEN=0 F  S ORDIEN=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN)) Q:'ORDIEN  D
"RTN","ORDSGCHK",226,0)
 .....I $L($G(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN))) D
"RTN","ORDSGCHK",227,0)
 ......N OROCTYPE S OROCTYPE="DS"
"RTN","ORDSGCHK",228,0)
 ......I TYP="3_GENERAL" S OROCTYPE="ERR" N ORDIEN2 S ORDIEN2=0 F  S ORDIEN2=$O(^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN,ORDIEN2)) Q:'ORDIEN2  D
"RTN","ORDSGCHK",229,0)
 .......S ORY=$G(ORY)+1,ORY(ORY)=OROCTYPE_U_^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN,ORDIEN2)
"RTN","ORDSGCHK",230,0)
 ......Q:OROCTYPE="ERR"
"RTN","ORDSGCHK",231,0)
 ......S ORY=$G(ORY)+1,ORY(ORY)=OROCTYPE_U_^TMP($J,"ORDSGCHK2","OUT","DOSE",I,J,TYP,"MESSAGE",ORDIEN)
"RTN","ORDSGCHK",232,0)
 I $L(ORNBP)>1 S ORY=$G(ORY)+1,ORY(ORY)="ERR^"_ORNBP,ORNBP=""
"RTN","ORDSGCHK",233,0)
 Q
"RTN","ORDSGCHK",234,0)
 ;
"RTN","ORDSGCHK",235,0)
GETSUB(NAME) ;
"RTN","ORDSGCHK",236,0)
 I NAME="CONJ" Q "CONJ"
"RTN","ORDSGCHK",237,0)
 I NAME="DAYS" Q "DRATE"
"RTN","ORDSGCHK",238,0)
 I NAME="DOSE" Q "DOSE"
"RTN","ORDSGCHK",239,0)
 I NAME="ROUTE" Q "MR_IEN"
"RTN","ORDSGCHK",240,0)
 I NAME="SCHEDULE" Q "SCHEDULE"
"RTN","ORDSGCHK",241,0)
 Q ""
"RTN","ORDSGCHK",242,0)
 ;
"RTN","ORDSGCHK",243,0)
DRATESTR(ORIN) ;change the form of the DURATION
"RTN","ORDSGCHK",244,0)
 ;DAYS=D,WEEKS=W,MONTHS=L,HOURS=H,MINUTES=M
"RTN","ORDSGCHK",245,0)
 I $$UP^XLFSTR(ORIN)="MONTHS" Q "L"
"RTN","ORDSGCHK",246,0)
 Q $E($$UP^XLFSTR(ORIN))
"RTN","ORDSGCHK",247,0)
 ;
"RTN","ORDSGCHK",248,0)
DSDWNMSG() ;dosage down message (not displayed to user)
"RTN","ORDSGCHK",249,0)
 Q "Drug Dosage checks were not able to be performed."
"RTN","ORKCHK")
0^10^B42660256
"RTN","ORKCHK",1,0)
ORKCHK ; SLC/CLA - Main routine called by OE/RR to initiate order checks ;04/24/12  11:49
"RTN","ORKCHK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,94,105,123,232,267,243,280,345**;Dec 17, 1997;Build 32
"RTN","ORKCHK",3,0)
EN(ORKY,ORKDFN,ORKA,ORKMODE,OROIL,ORDODSG) ;initiate order checking
"RTN","ORKCHK",4,0)
 ;ORKY: array of returned msgs in format: ornum^orderchk ien^clin danger^msg
"RTN","ORKCHK",5,0)
 ;ORKDFN: patient dfn
"RTN","ORKCHK",6,0)
 ;ORKA: array of order information in the format:
"RTN","ORKCHK",7,0)
 ; orderable item ien|
"RTN","ORKCHK",8,0)
 ; display group-filler app|
"RTN","ORKCHK",9,0)
 ; nat'l id^nat'l text^nat'l code sys^local id^local text^local code sys|
"RTN","ORKCHK",10,0)
 ; effective d/t|
"RTN","ORKCHK",11,0)
 ; order number|
"RTN","ORKCHK",12,0)
 ; filler data (LR: specimen ien, PS: meds prev ordered during this session in format med1^med2^...)
"RTN","ORKCHK",13,0)
 ;ORKMODE: mode/event trigger (DISPLAY,SELECT,ACCEPT,SESSION,ALL,NOTIF)
"RTN","ORKCHK",14,0)
 ; PS: meds previously ordered during this session med1^med2^...
"RTN","ORKCHK",15,0)
 ;OROIL: array containing the order info passed in (oly for ACCEPT mode)
"RTN","ORKCHK",16,0)
 ;ORDODSG: flag that denotes if dosage checks should be performed
"RTN","ORKCHK",17,0)
 ;         1 for perform dosage checks
"RTN","ORKCHK",18,0)
 ;         0 for do not perform dosage checks
"RTN","ORKCHK",19,0)
 N ORKQ,ORKN S ORKQ=0,ORKN=1
"RTN","ORKCHK",20,0)
 S:+$G(ORKDFN)<1 ORKY(ORKN)="^^^Order Checking Unavailable - invalid patient id",ORKQ=1,ORKN=ORKN+1
"RTN","ORKCHK",21,0)
 S:'$L($G(ORKMODE)) ORKY(ORKN)="^^^Order Checking Unavailable - invalid mode/event",ORKQ=1,ORKN=ORKN+1
"RTN","ORKCHK",22,0)
 Q:$G(ORKQ)=1
"RTN","ORKCHK",23,0)
 Q:+$G(ORKA)<1
"RTN","ORKCHK",24,0)
 N ORKX,ORKS,DNGR,ORENT,ORKENT,ORKNENT,ORNUM,ORKOFF,ORKTMODE
"RTN","ORKCHK",25,0)
 N ORKADUZ,ORKNDUZ,ORKI,ORKPRIM,ORKNMSG,ORKMSG,ORKLOG,ORKLD,ORKLI,ORKOI
"RTN","ORKCHK",26,0)
 N ORKDG,ORKLPS,ORKPSA,ORKCNT,ORKDGI,ORIVORDR
"RTN","ORKCHK",27,0)
 ;
"RTN","ORKCHK",28,0)
 ;save array of orders for use in session processing:
"RTN","ORKCHK",29,0)
 M ^TMP("ORKA",$J)=ORKA
"RTN","ORKCHK",30,0)
 ;
"RTN","ORKCHK",31,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKCHK",32,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKCHK",33,0)
 N DFN,ORKLOC
"RTN","ORKCHK",34,0)
 S DFN=ORKDFN,VA200="" D OERR^VADPT
"RTN","ORKCHK",35,0)
 S ORKLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKCHK",36,0)
 K VA200,VAIN
"RTN","ORKCHK",37,0)
 ;
"RTN","ORKCHK",38,0)
 ;get user's service/section flag:
"RTN","ORKCHK",39,0)
 N ORKSRV
"RTN","ORKCHK",40,0)
 S ORKSRV=$$GET1^DIQ(200,DUZ,29,"I") I +ORKSRV>0 S ORKSRV=$P(ORKSRV,U)
"RTN","ORKCHK",41,0)
 ;
"RTN","ORKCHK",42,0)
 ;log order check debug messages (or not)
"RTN","ORKCHK",43,0)
 S ORKLOG=$$GET^XPAR("DIV^SYS^PKG","ORK DEBUG ENABLE/DISABLE",1,"I")
"RTN","ORKCHK",44,0)
 I $G(ORKLOG)="D" K ^XTMP("ORKLOG") S ^XTMP("ORKLOG",0)=""
"RTN","ORKCHK",45,0)
 I +$P($G(^XTMP("ORKLOG",0)),U,3)>5000 K ^XTMP("ORKLOG")
"RTN","ORKCHK",46,0)
 ;
"RTN","ORKCHK",47,0)
 ;if SESSION mode & pharmacy order occurred in session get unsigned med orders
"RTN","ORKCHK",48,0)
 I ORKMODE="SESSION" D
"RTN","ORKCHK",49,0)
 .S ORKDG=$P(ORKA(1),"|",2)
"RTN","ORKCHK",50,0)
 .I $E($G(ORKDG),1,2)="PS" D
"RTN","ORKCHK",51,0)
 ..S ORKDGI=0,ORKDGI=$O(^ORD(100.98,"B","PHARMACY",ORKDGI))
"RTN","ORKCHK",52,0)
 ..K ^TMP("ORR",$J)
"RTN","ORKCHK",53,0)
 ..D EN^ORQ1(DFN_";DPT(",ORKDGI,11,"","","",0,0)
"RTN","ORKCHK",54,0)
 ..;store unsigned med orders in ^TMP("ORR",$J for processing in ORKPS
"RTN","ORKCHK",55,0)
 ;
"RTN","ORKCHK",56,0)
 ;main processing loop:
"RTN","ORKCHK",57,0)
 S (ORKX,ORIVORDR)="" F  S ORKX=$O(ORKA(ORKX)) Q:ORKX=""  D
"RTN","ORKCHK",58,0)
 .S ORKOI=$P(ORKA(ORKX),"|")
"RTN","ORKCHK",59,0)
 .;
"RTN","ORKCHK",60,0)
 .;log debug msgs if parameter is enabled:
"RTN","ORKCHK",61,0)
 .I $G(ORKLOG)="E" D
"RTN","ORKCHK",62,0)
 ..S ORKLD=$$NOW^XLFDT
"RTN","ORKCHK",63,0)
 ..S ORKLI=0
"RTN","ORKCHK",64,0)
 ..I +$P($G(^XTMP("ORKLOG",0)),U,3)<1 S $P(^XTMP("ORKLOG",0),U,3)=0
"RTN","ORKCHK",65,0)
 ..S ORKCNT=$P(^XTMP("ORKLOG",0),U,3)+1
"RTN","ORKCHK",66,0)
 ..S ^XTMP("ORKLOG",0)=$$FMADD^XLFDT(ORKLD,3,"","","")_U_ORKLD_U_ORKCNT
"RTN","ORKCHK",67,0)
 ..S ^XTMP("ORKLOG",ORKLD,ORKDFN,+$G(ORKOI),ORKMODE,DUZ,ORKLI)=ORKA(ORKX)
"RTN","ORKCHK",68,0)
 .;
"RTN","ORKCHK",69,0)
 .S ORKDG=$P(ORKA(ORKX),"|",2),ORKTMODE=""
"RTN","ORKCHK",70,0)
 .S ORKENT="USR^LOC.`"_+$G(ORKLOC)_"^SRV.`"_+$G(ORKSRV)_"^DIV^SYS^PKG"
"RTN","ORKCHK",71,0)
 .Q:'$L($G(ORKDG))
"RTN","ORKCHK",72,0)
 .;
"RTN","ORKCHK",73,0)
 .;if pharmacy order and multiple pharmacy orders in session add data node:
"RTN","ORKCHK",74,0)
 .I $E(ORKDG,1,2)="PS",($L($G(ORKPSA))) D
"RTN","ORKCHK",75,0)
 ..S $P(ORKA(ORKX),"|",6)=ORKPSA
"RTN","ORKCHK",76,0)
 .;
"RTN","ORKCHK",77,0)
 .S ORNUM=$P(ORKA(ORKX),"|",5)
"RTN","ORKCHK",78,0)
 .; get correct DUZ for notification processing if in NOTIF mode:
"RTN","ORKCHK",79,0)
 .I ORKMODE="NOTIF" D
"RTN","ORKCHK",80,0)
 ..S:+$G(ORNUM)>0 ORKNDUZ=$$ORDERER^ORQOR2(ORNUM) ;ordering provider
"RTN","ORKCHK",81,0)
 ..S:+$G(ORNUM)<1 ORKNDUZ=$P($$PRIM^ORQPTQ4(ORKDFN),U) ;prim provider
"RTN","ORKCHK",82,0)
 ..I +$G(ORKNDUZ)>0 D
"RTN","ORKCHK",83,0)
 ...S ORKSRV=$$GET1^DIQ(200,ORKNDUZ,29,"I") I +ORKSRV>0 S ORKSRV=$P(ORKSRV,U)
"RTN","ORKCHK",84,0)
 ...S ORKNENT="USR.`"_+ORKNDUZ_"^LOC.`"_+$G(ORKLOC)_"^SRV.`"_+$G(ORKSRV)_"^DIV^SYS^PKG"
"RTN","ORKCHK",85,0)
 ..S:+$G(ORKNDUZ)<1 ORKNENT="LOC.`"_+$G(ORKLOC)_"^DIV^SYS^PKG"
"RTN","ORKCHK",86,0)
 .S ORENT=$S(ORKMODE="NOTIF":ORKNENT,1:ORKENT)
"RTN","ORKCHK",87,0)
 .;
"RTN","ORKCHK",88,0)
 .;If the order is a delayed release order (NOTIF) process all nodes.
"RTN","ORKCHK",89,0)
 .;If it is a renewal, edit or delayed signature order (ALL) process all
"RTN","ORKCHK",90,0)
 .;modes except SESSION which gets processed just before signature:
"RTN","ORKCHK",91,0)
 .I ORKMODE="NOTIF"!(ORKMODE="ALL") S ORKTMODE=ORKMODE D
"RTN","ORKCHK",92,0)
 ..D EN^ORKCHK3(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)  ;DISPLAY
"RTN","ORKCHK",93,0)
 ..D EN^ORKCHK4(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE,.OROIL,.ORIVORDR,.ORDODSG)  ;SELECT
"RTN","ORKCHK",94,0)
 ..D EN^ORKCHK5(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE,.OROIL,.ORDODSG)  ;ACCEPT
"RTN","ORKCHK",95,0)
 ..I ORKMODE="NOTIF" D EN^ORKCHK6(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)  ;SESSION
"RTN","ORKCHK",96,0)
 ..S ORKMODE=ORKTMODE
"RTN","ORKCHK",97,0)
 .;
"RTN","ORKCHK",98,0)
 .;Process regular orders/modes:
"RTN","ORKCHK",99,0)
 .I '$L($G(ORKTMODE)) D
"RTN","ORKCHK",100,0)
 ..I ORKMODE="DISPLAY" D EN^ORKCHK3(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)
"RTN","ORKCHK",101,0)
 ..I ORKMODE="SELECT" D EN^ORKCHK4(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE,.OROIL,.ORIVORDR,.ORDODSG)
"RTN","ORKCHK",102,0)
 ..I ORKMODE="ACCEPT" D EN^ORKCHK5(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE,.OROIL,.ORDODSG)
"RTN","ORKCHK",103,0)
 ..I ORKMODE="SESSION" D EN^ORKCHK6(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)
"RTN","ORKCHK",104,0)
 ;
"RTN","ORKCHK",105,0)
 ;set messages into sorting array then into ORKY ORKS("ORK",clinical danger level,oi,msg)=ornum^order check ien^clin danger level^message
"RTN","ORKCHK",106,0)
 S ORKX="",ORKI=1
"RTN","ORKCHK",107,0)
 F  S ORKX=$O(ORKS("ORK",ORKX)) Q:ORKX=""  D
"RTN","ORKCHK",108,0)
 .S ORKY(ORKI)=ORKS("ORK",ORKX)
"RTN","ORKCHK",109,0)
 .;S ORKY(ORKI)=$E(ORKS("ORK",ORKX),1,500)
"RTN","ORKCHK",110,0)
 .;
"RTN","ORKCHK",111,0)
 .;log debug msgs if parameter is enabled:
"RTN","ORKCHK",112,0)
 .I $G(ORKLOG)="E" D
"RTN","ORKCHK",113,0)
 ..S ORKLI=$G(ORKLI)+1
"RTN","ORKCHK",114,0)
 ..S ^XTMP("ORKLOG",$$NOW^XLFDT,ORKDFN,+$G(ORKOI),ORKMODE,DUZ,ORKLI)=ORKY(ORKI)
"RTN","ORKCHK",115,0)
 ..S $P(^XTMP("ORKLOG",0),U,3)=$P($G(^XTMP("ORKLOG",0)),U,3)+1
"RTN","ORKCHK",116,0)
 .;
"RTN","ORKCHK",117,0)
 .;send moderate and high danger order checks for delayed orders as notifications:
"RTN","ORKCHK",118,0)
 .I ORKMODE="NOTIF" S DNGR=$P(ORKY(ORKI),U,3) I $G(DNGR)<3 D
"RTN","ORKCHK",119,0)
 ..S ORKADUZ="",ORNUM=$P(ORKY(ORKI),U)
"RTN","ORKCHK",120,0)
 ..S:+$G(ORKNDUZ)>0 ORKADUZ(ORKNDUZ)=""
"RTN","ORKCHK",121,0)
 ..S ORKNMSG="Order check: "_$P(ORKY(ORKI),U,4)
"RTN","ORKCHK",122,0)
 ..D EN^ORB3(54,ORKDFN,$G(ORNUM),.ORKADUZ,ORKNMSG,"")
"RTN","ORKCHK",123,0)
 .S ORKI=ORKI+1
"RTN","ORKCHK",124,0)
 ;
"RTN","ORKCHK",125,0)
 K ^TMP("ORKA",$J),^TMP("ORR",$J)
"RTN","ORKCHK",126,0)
 I $G(ORKLOG)="E" D
"RTN","ORKCHK",127,0)
 .S ORKLI=$G(ORKLI)+1
"RTN","ORKCHK",128,0)
 .S ^XTMP("ORKLOG",$$NOW^XLFDT,ORKDFN,+$G(ORKOI),ORKMODE,DUZ,ORKLI)="LEAVING ORDER CHECKING"
"RTN","ORKCHK",129,0)
 .S $P(^XTMP("ORKLOG",0),U,3)=$P($G(^XTMP("ORKLOG",0)),U,3)+1
"RTN","ORKCHK",130,0)
 D CHKRMT
"RTN","ORKCHK",131,0)
 Q
"RTN","ORKCHK",132,0)
 ;
"RTN","ORKCHK",133,0)
CHKRMT ;
"RTN","ORKCHK",134,0)
 N I,ORQFLAG
"RTN","ORKCHK",135,0)
 S ORQFLAG=1
"RTN","ORKCHK",136,0)
 S I=0 F  S I=$O(ORKA(I)) Q:'I  I $E($P(ORKA(I),"|",2),1,2)="PS"!($E($P(ORKA(I),"|",2),1,2)="RA") S ORQFLAG=0
"RTN","ORKCHK",137,0)
 Q:$G(ORQFLAG)
"RTN","ORKCHK",138,0)
 Q:'$$HAVEHDR^ORRDI1
"RTN","ORKCHK",139,0)
 Q:$$LDPTTVAL^ORRDI2($G(DFN))
"RTN","ORKCHK",140,0)
 Q:$P($G(^XTMP("ORRDI","PSOO",ORKDFN,0)),U,3)'<0&($P($G(^XTMP("ORRDI","ART",ORKDFN,0)),U,3)'<0)
"RTN","ORKCHK",141,0)
 I $G(ORKMODE)="ACCEPT" D
"RTN","ORKCHK",142,0)
 . N IFN
"RTN","ORKCHK",143,0)
 . S IFN=$O(ORKY(""),-1)+1
"RTN","ORKCHK",144,0)
 . S ORKY(IFN)="^99^2^Remote Order Checking not available - checks done on local data only"
"RTN","ORKCHK",145,0)
 . K ^TMP($J,"ORRDI") S ^TMP($J,"ORRDI",ORKDFN)=1
"RTN","ORKCHK",146,0)
 I $G(ORKMODE)="SESSION" D
"RTN","ORKCHK",147,0)
 . N I,IFN,ORARR
"RTN","ORKCHK",148,0)
 . S IFN=$O(ORKY(""),-1)
"RTN","ORKCHK",149,0)
 . S I=0 F  S I=$O(ORKY(I)) Q:'I  S ORARR(+ORKY(I))=""
"RTN","ORKCHK",150,0)
 . S I=0 F  S I=$O(ORARR(I)) Q:'I  S IFN=IFN+1,ORKY(IFN)=I_"^99^2^Remote Order Checking not available - checks done on local data only"
"RTN","ORKCHK",151,0)
 . K ^TMP($J,"ORRDI") S ^TMP($J,"ORRDI",ORKDFN)=1
"RTN","ORKCHK",152,0)
 Q
"RTN","ORKCHK4")
0^11^B27733732
"RTN","ORKCHK4",1,0)
ORKCHK4 ; SLC/CLA - Support routine called by ORKCHK to do SELECT mode order checks ;05/10/12  11:56
"RTN","ORKCHK4",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,87,94,123,162,190,249,272,345**;Dec 17, 1997;Build 32
"RTN","ORKCHK4",3,0)
 Q
"RTN","ORKCHK4",4,0)
 ;
"RTN","ORKCHK4",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE,OROIL,ORIVRAN,ORDODSG) ;perform order checking for orderable item selection
"RTN","ORKCHK4",6,0)
 ;ORIVRAN: FLAG THAT DENOTES IF CHECK^ORKPS HAS ALREADY RUN FOR THIS INFUSION ORDER
"RTN","ORKCHK4",7,0)
 ;         1 FOR ALREADY EXECUTED
"RTN","ORKCHK4",8,0)
 ;         EMPTY STRING FOR NOT YET EXECUTED
"RTN","ORKCHK4",9,0)
 ;ORDODSG: FLAG THAT DENOTES IF DOSAGE CHECKS SHOULD BE PERFORMED
"RTN","ORKCHK4",10,0)
 ;         1 FOR PERFORM DOSAGE CHECKS
"RTN","ORKCHK4",11,0)
 ;         0 FOR DO NOT PERFORM DOSAGE CHECKS
"RTN","ORKCHK4",12,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK4",13,0)
 ;
"RTN","ORKCHK4",14,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK4",15,0)
 N ORKMSG,ORKTXT
"RTN","ORKCHK4",16,0)
 ;
"RTN","ORKCHK4",17,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2)
"RTN","ORKCHK4",18,0)
 S HL7=$P(ORKA,"|",3),ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5)
"RTN","ORKCHK4",19,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK4",20,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK4",21,0)
 ;
"RTN","ORKCHK4",22,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK4",23,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SELECT")
"RTN","ORKCHK4",24,0)
 Q
"RTN","ORKCHK4",25,0)
 ;
"RTN","ORKCHK4",26,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK4",27,0)
 N ORPSPKG,ORPSA,ORKDD
"RTN","ORKCHK4",28,0)
 N ORCRITN,ORCRITF,ORCRITD,ORSIGN,ORSIGF,ORSIGD,ORDUPN,ORDUPF,ORDUPD,ORDUPCN,ORDUPCF,ORDUPCD
"RTN","ORKCHK4",29,0)
 ;
"RTN","ORKCHK4",30,0)
 D PARAMS("CRITICAL DRUG INTERACTION",.ORCRITN,.ORCRITF,.ORCRITD)
"RTN","ORKCHK4",31,0)
 D PARAMS("SIGNIFICANT DRUG INTERACTION",.ORSIGN,.ORSIGF,.ORSIGD)
"RTN","ORKCHK4",32,0)
 D PARAMS("DUPLICATE DRUG ORDER",.ORDUPN,.ORDUPF,.ORDUPD)
"RTN","ORKCHK4",33,0)
 D PARAMS("DUPLICATE DRUG THERAPY",.ORDUPCN,.ORDUPCF,.ORDUPCD)
"RTN","ORKCHK4",34,0)
 ;
"RTN","ORKCHK4",35,0)
 ;dispense drug selected:
"RTN","ORKCHK4",36,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK4",37,0)
 .D RXOCS
"RTN","ORKCHK4",38,0)
 .S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK4",39,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SELECT")
"RTN","ORKCHK4",40,0)
 ;
"RTN","ORKCHK4",41,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK4",42,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK4",43,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK4",44,0)
 .I "IOH"[ORPSPKG D
"RTN","ORKCHK4",45,0)
 ..S ORPSA=$$OI2DD^ORKPS(OI,ORPSPKG,1)
"RTN","ORKCHK4",46,0)
 ..I +ORPSA D
"RTN","ORKCHK4",47,0)
 ...S HL7LTXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK4",48,0)
 ...S HL7NPTR=$P(ORPSA,";",2)
"RTN","ORKCHK4",49,0)
 ...S HL7LPTR=+ORPSA
"RTN","ORKCHK4",50,0)
 ...S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK4",51,0)
 ...S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK4",52,0)
 ...S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK4",53,0)
 ...S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK4",54,0)
 ..D RXOCS
"RTN","ORKCHK4",55,0)
 ..S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK4",56,0)
 ..Q:HL7LTXT=""
"RTN","ORKCHK4",57,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SELECT")
"RTN","ORKCHK4",58,0)
 ;ONLY DISPLAY THE ERROR MESSAGE FOR A FREE-TEXT DOSAGE WHEN PHARMACY SAYS TO
"RTN","ORKCHK4",59,0)
 I +$P($G(ORPSA),";",5)=1 D
"RTN","ORKCHK4",60,0)
 .N ORKSMSG,OROITXT,ORDOSE
"RTN","ORKCHK4",61,0)
 .S OROITXT=$P($G(^ORD(101.43,OI,0)),U),ORDOSE=$$DS^PSSDSAPI
"RTN","ORKCHK4",62,0)
 .I $L(OROITXT)>0 S OROITXT=" for drug "_$$TRIM^XLFSTR(OROITXT)
"RTN","ORKCHK4",63,0)
 .S ORKMSG="Order checks could not be done"_OROITXT_". Please complete a manual check for Drug Interactions"
"RTN","ORKCHK4",64,0)
 .S ORKMSG=ORKMSG_$S(ORDOSE:",",1:" and")_" Duplicate Therapy"
"RTN","ORKCHK4",65,0)
 .I ORDOSE S ORKMSG=ORKMSG_" and appropriate Dosing"
"RTN","ORKCHK4",66,0)
 .S ORKMSG=ORKMSG_"."
"RTN","ORKCHK4",67,0)
 .S ORKS("ORK",2_$E(ORKMSG,1,225))=ORNUM_U_25_U_3_U_ORKMSG,ORDODSG=0
"RTN","ORKCHK4",68,0)
 Q
"RTN","ORKCHK4",69,0)
 ;
"RTN","ORKCHK4",70,0)
RXOCS ;drug-drug interaction, duplicate drug order, duplicate drug class
"RTN","ORKCHK4",71,0)
 Q:ORCRITF_ORSIGF_ORDUPF_ORDUPCF'["E"  ;quit if none are "E"nabled
"RTN","ORKCHK4",72,0)
 N ORKRX,ORPSNUM,ORY,CHK,XX
"RTN","ORKCHK4",73,0)
 D CHECK^ORKPS(.ORKRX,ORKDFN,HL7LPTR_U_HL7LTXT,OI,ORKDG,.OROIL,+$P($G(ORPSA),";",4),$P(ORKA,"|",7),.ORIVRAN,.ORDODSG)
"RTN","ORKCHK4",74,0)
 S CHK=0,XX="" F  S CHK=$O(ORKRX(CHK)) Q:'CHK  D
"RTN","ORKCHK4",75,0)
 .S XX=ORKRX(CHK)
"RTN","ORKCHK4",76,0)
 .;
"RTN","ORKCHK4",77,0)
 .;get errors/exceptions/checks not done
"RTN","ORKCHK4",78,0)
 .I $P(XX,U)="ERR" D
"RTN","ORKCHK4",79,0)
 ..S ORKS("ORK",2_$E($P(XX,U,2),1,225))=ORNUM_U_25_U_3_U_$P(XX,U,2)
"RTN","ORKCHK4",80,0)
 .;
"RTN","ORKCHK4",81,0)
 .;critical drug interaction:
"RTN","ORKCHK4",82,0)
 .I $P(XX,U)="DI",$P(XX,U,2)="CRITICAL" D
"RTN","ORKCHK4",83,0)
 ..Q:ORCRITF="D"
"RTN","ORKCHK4",84,0)
 ..S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK4",85,0)
 ..S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK4",86,0)
 ..S ORKS("ORK",ORCRITD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORCRITN_U_ORCRITD_U_ORKTXT
"RTN","ORKCHK4",87,0)
 .;
"RTN","ORKCHK4",88,0)
 .;significant drug interaction:
"RTN","ORKCHK4",89,0)
 .I $P(XX,U)="DI",$P(XX,U,2)="SIGNIFICANT" D
"RTN","ORKCHK4",90,0)
 ..Q:ORSIGF="D"
"RTN","ORKCHK4",91,0)
 ..S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK4",92,0)
 ..S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK4",93,0)
 ..S ORKS("ORK",ORSIGD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORSIGN_U_ORSIGD_U_ORKTXT
"RTN","ORKCHK4",94,0)
 .;
"RTN","ORKCHK4",95,0)
 .;duplicate drug:
"RTN","ORKCHK4",96,0)
 .I $P(XX,U)="DD" D
"RTN","ORKCHK4",97,0)
 ..Q:ORDUPF="D"
"RTN","ORKCHK4",98,0)
 ..S ORPSNUM=$P(XX,U,4)  ;get the associated order number
"RTN","ORKCHK4",99,0)
 ..S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK4",100,0)
 ..I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) D
"RTN","ORKCHK4",101,0)
 ...D TEXT^ORQ12(.ORY,ORPSNUM,"")
"RTN","ORKCHK4",102,0)
 ...S ORKTXT=ORKTXT_$S($D(ORY(2))=1:" "_$$TRIM^XLFSTR(ORY(2)),1:"")_" ["_$P($G(^ORD(100.01,+$P(^OR(100,+ORPSNUM,3),U,3),0)),U,1)_"]"
"RTN","ORKCHK4",103,0)
 ..S ORKMSG="Duplicate drug order: "_ORKTXT
"RTN","ORKCHK4",104,0)
 ..S ORKS("ORK",ORDUPD_","_$G(ORNUM)_","_ORPSNUM_",Duplicate drug order: "_$E($P(XX,U,3),1,200))=ORNUM_U_ORDUPN_U_ORDUPD_U_ORKMSG_U_$G(ORPSNUM)
"RTN","ORKCHK4",105,0)
 .;
"RTN","ORKCHK4",106,0)
 .;duplicate class: NOW DRUG THERAPY
"RTN","ORKCHK4",107,0)
 .I $P(XX,U)="DC" D
"RTN","ORKCHK4",108,0)
 ..Q:ORDUPCF="D"
"RTN","ORKCHK4",109,0)
 ..S ORPSNUM=$P(XX,U,2)  ;get the associated order number
"RTN","ORKCHK4",110,0)
 ..S ORKMSG=$P(XX,U,4)
"RTN","ORKCHK4",111,0)
 ..S ORKS("ORK",ORDUPCD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORDUPCN_U_ORDUPCD_U_ORKMSG
"RTN","ORKCHK4",112,0)
 Q
"RTN","ORKCHK4",113,0)
 ;
"RTN","ORKCHK4",114,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK4",115,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK4",116,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK4",117,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK4",118,0)
 Q
"RTN","ORKCHK5")
0^13^B46374630
"RTN","ORKCHK5",1,0)
ORKCHK5 ; SLC/CLA - Support routine called by ORKCHK to do ACCEPT mode order checks ;08/22/12  09:21
"RTN","ORKCHK5",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123,190,280,357,345**;Dec 17, 1997;Build 32
"RTN","ORKCHK5",3,0)
 Q
"RTN","ORKCHK5",4,0)
 ;
"RTN","ORKCHK5",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE,OROIL,ORDODSG) ;perform order checking for orderable item acceptance
"RTN","ORKCHK5",6,0)
 ;ORDODSG: FLAG THAT DENOTES IF DOSAGE CHECKS SHOULD BE PERFORMED
"RTN","ORKCHK5",7,0)
 ;         1 FOR PERFORM DOSAGE CHECKS
"RTN","ORKCHK5",8,0)
 ;         0 FOR DO NOT PERFORM DOSAGE CHECKS
"RTN","ORKCHK5",9,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK5",10,0)
 ;
"RTN","ORKCHK5",11,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK5",12,0)
 N OCN,DNGR,ORKMSG,ORKPDATA,ORKOCNUM
"RTN","ORKCHK5",13,0)
 ;
"RTN","ORKCHK5",14,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK5",15,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK5",16,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK5",17,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK5",18,0)
 I ORKDG="GMRC",'$L(ODT) S ODT=$$NOW^XLFDT  ;def consult order d/t is now
"RTN","ORKCHK5",19,0)
 ;
"RTN","ORKCHK5",20,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK5",21,0)
 I $E(ORKDG,1,2)'="PS",($E(ORKDG,1,2)'="LR"),($L($G(OI))),($L($G(ODT))),(ORKTMODE'="ALL") D DUPOR
"RTN","ORKCHK5",22,0)
 I $E(ORKDG,1,2)="LR",($L($G(OI))),($L($G(ODT))),(ORKTMODE'="ALL") D
"RTN","ORKCHK5",23,0)
 .D DUPLAB
"RTN","ORKCHK5",24,0)
 .D LABFREQ
"RTN","ORKCHK5",25,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",26,0)
 D REMCHK(.ORKS,OI,ORKDFN) ;do reminder order checks
"RTN","ORKCHK5",27,0)
 Q
"RTN","ORKCHK5",28,0)
 ;
"RTN","ORKCHK5",29,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK5",30,0)
 N ORPSPKG,ORPSA,ORKDD
"RTN","ORKCHK5",31,0)
 N ORALLRN,ORALLRF,ORALLRD
"RTN","ORKCHK5",32,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK5",33,0)
 ;
"RTN","ORKCHK5",34,0)
 D:+ORDODSG DSGCHK(.ORKS,ORKDFN,.OROIL,ORKA) ;do pharmacy dosage checks
"RTN","ORKCHK5",35,0)
 ;dispense drug selected:
"RTN","ORKCHK5",36,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK5",37,0)
 .D RXOCS
"RTN","ORKCHK5",38,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",39,0)
 ;
"RTN","ORKCHK5",40,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK5",41,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK5",42,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK5",43,0)
 .I ORPSPKG="H" S ORPSPKG="X"  ;change to "X" if "H"erbal/non-VA med
"RTN","ORKCHK5",44,0)
 .I "IOX"[ORPSPKG D OI2DD(.ORPSA,OI,ORPSPKG)
"RTN","ORKCHK5",45,0)
 .S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKCHK5",46,0)
 ..S HL7LTXT=ORPSA(ORKDD)
"RTN","ORKCHK5",47,0)
 ..S HL7NPTR=$P(ORKDD,";",2)
"RTN","ORKCHK5",48,0)
 ..S HL7LPTR=+ORKDD
"RTN","ORKCHK5",49,0)
 ..S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK5",50,0)
 ..S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK5",51,0)
 ..S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK5",52,0)
 ..S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK5",53,0)
 ..D RXOCS
"RTN","ORKCHK5",54,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",55,0)
 Q
"RTN","ORKCHK5",56,0)
 ;
"RTN","ORKCHK5",57,0)
RXOCS ;drug-allergy interaction
"RTN","ORKCHK5",58,0)
 Q:ORALLRF="D"
"RTN","ORKCHK5",59,0)
 N ORKAL
"RTN","ORKCHK5",60,0)
 I $L($G(HL7NPTR)),($G(HL7NCOD)="99NDF") D
"RTN","ORKCHK5",61,0)
 .D RXN^ORQQAL(.ORKAL,ORKDFN,"DR",HL7NPTR,$G(HL7LPTR)) I (ORKAL>0) D
"RTN","ORKCHK5",62,0)
 ..Q:$L($P(ORKAL,U,2))<1
"RTN","ORKCHK5",63,0)
 ..S ORKMSG="Previous adverse reaction to: "_$P(ORKAL,U,2)
"RTN","ORKCHK5",64,0)
 ..S ORKS("ORK",ORALLRD_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_ORALLRN_U_ORALLRD_U_ORKMSG
"RTN","ORKCHK5",65,0)
 Q
"RTN","ORKCHK5",66,0)
 ;
"RTN","ORKCHK5",67,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKCHK5",68,0)
 N PSOI
"RTN","ORKCHK5",69,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKCHK5",70,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKCHK5",71,0)
 Q:+$G(PSOI)<1
"RTN","ORKCHK5",72,0)
 D DRG^PSSUTIL1(.ORPSA,PSOI,ORPSPKG)
"RTN","ORKCHK5",73,0)
 Q
"RTN","ORKCHK5",74,0)
 ;
"RTN","ORKCHK5",75,0)
DUPOR ;duplicate orders for non-pharmacy and non-lab:
"RTN","ORKCHK5",76,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","DUPLICATE ORDER",OCN))
"RTN","ORKCHK5",77,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",78,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",79,0)
 N ORKOR S ORKOR=0
"RTN","ORKCHK5",80,0)
 D DUP^ORKOR(.ORKOR,ORKDFN,OI,ODT,ORKDG) I (ORKOR>0) D
"RTN","ORKCHK5",81,0)
 .S ORKOCNUM=+$P(ORKOR,U)
"RTN","ORKCHK5",82,0)
 .S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",83,0)
 .S ORKMSG="Duplicate order: "_$P(ORKOR,U,2)
"RTN","ORKCHK5",84,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_ORKOCNUM_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG_U_ORKOCNUM
"RTN","ORKCHK5",85,0)
 Q
"RTN","ORKCHK5",86,0)
 ;
"RTN","ORKCHK5",87,0)
DUPLAB ;duplicate laboratory orders:
"RTN","ORKCHK5",88,0)
 N ORKLR,OCI
"RTN","ORKCHK5",89,0)
 S ORKLR=0,OCI=""
"RTN","ORKCHK5",90,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","DUPLICATE ORDER",OCN))
"RTN","ORKCHK5",91,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",92,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",93,0)
 S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",94,0)
 D DUP^ORKLR(.ORKLR,OI,ORKDFN,ODT,ORKPDATA)
"RTN","ORKCHK5",95,0)
 F  S OCI=$O(ORKLR(OCI)) Q:OCI=""  D
"RTN","ORKCHK5",96,0)
 .S ORKOCNUM=+$P(ORKLR(OCI),U)
"RTN","ORKCHK5",97,0)
 .S ORKMSG="Duplicate order: "_$P(ORKLR(OCI),U,2)
"RTN","ORKCHK5",98,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_ORKOCNUM_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG_U_ORKOCNUM
"RTN","ORKCHK5",99,0)
 Q
"RTN","ORKCHK5",100,0)
 ;
"RTN","ORKCHK5",101,0)
LABFREQ ;lab order frequency restrictions:
"RTN","ORKCHK5",102,0)
 N ORKLR,OCI
"RTN","ORKCHK5",103,0)
 S ORKLR=0,OCI=""
"RTN","ORKCHK5",104,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","LAB ORDER FREQ RESTRICTIONS",OCN))
"RTN","ORKCHK5",105,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",106,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",107,0)
 S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",108,0)
 D ORFREQ^ORKLR2(.ORKLR,OI,ORKDFN_";DPT(",ODT,ORKPDATA)
"RTN","ORKCHK5",109,0)
 S OCI="" F  S OCI=$O(ORKLR(OCI)) Q:OCI=""  D
"RTN","ORKCHK5",110,0)
 .S ORKMSG=$P(ORKLR(OCI),U,2)
"RTN","ORKCHK5",111,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG
"RTN","ORKCHK5",112,0)
 Q
"RTN","ORKCHK5",113,0)
 ;
"RTN","ORKCHK5",114,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK5",115,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK5",116,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK5",117,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK5",118,0)
 Q
"RTN","ORKCHK5",119,0)
REMCHK(ORRET,OROI,ORDFN) ; DO REMINDER ORDER CHECKS
"RTN","ORKCHK5",120,0)
 ;
"RTN","ORKCHK5",121,0)
 N ORKGLOB S ORKGLOB=$H
"RTN","ORKCHK5",122,0)
 ;order check for TEST OC for this OI
"RTN","ORKCHK5",123,0)
 N ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",124,0)
 D PARAMS("CLINICAL REMINDER TEST",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",125,0)
 I ORKFLAG'="D" D
"RTN","ORKCHK5",126,0)
 .D ORDERCHK^PXRMORCH(ORDFN,OROI,1,0,0)
"RTN","ORKCHK5",127,0)
 .Q:'$D(^TMP($J,OROI))
"RTN","ORKCHK5",128,0)
 .N ORCDL S ORCDL="" F  S ORCDL=$O(^TMP($J,OROI,ORCDL)) Q:'$L(ORCDL)  S ORKDNGR=$S(ORCDL="H":1,ORCDL="M":2,1:3) D
"RTN","ORKCHK5",129,0)
 ..N ORRULE S ORRULE="" F  S ORRULE=$O(^TMP($J,OROI,ORCDL,ORRULE)) Q:'$L(ORRULE)  D
"RTN","ORKCHK5",130,0)
 ...S ORRET("ORK",ORCDL_","_$G(ORNUM)_","_ORKNUM_","_ORRULE)=ORNUM_U_ORKNUM_U_ORCDL_U_"||"_ORKGLOB_"&"_ORRULE
"RTN","ORKCHK5",131,0)
 ...M ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORRULE)=^TMP($J,OROI,ORCDL,ORRULE)
"RTN","ORKCHK5",132,0)
 .K ^TMP($J,OROI)
"RTN","ORKCHK5",133,0)
 ;order checks for LIVE OC for this OI
"RTN","ORKCHK5",134,0)
 K ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",135,0)
 D PARAMS("CLINICAL REMINDER LIVE",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",136,0)
 Q:ORKFLAG="D"
"RTN","ORKCHK5",137,0)
 D ORDERCHK^PXRMORCH(ORDFN,OROI,0,0,0)
"RTN","ORKCHK5",138,0)
 Q:'$D(^TMP($J,OROI))
"RTN","ORKCHK5",139,0)
 N ORCDL S ORCDL="" F  S ORCDL=$O(^TMP($J,OROI,ORCDL)) Q:'$L(ORCDL)  S ORKDNGR=$S(ORCDL="H":1,ORCDL="M":2,1:3) D
"RTN","ORKCHK5",140,0)
 .N ORRULE S ORRULE="" F  S ORRULE=$O(^TMP($J,OROI,ORCDL,ORRULE)) Q:'$L(ORRULE)  D
"RTN","ORKCHK5",141,0)
 ..S ORRET("ORK",ORCDL_","_$G(ORNUM)_","_ORKNUM_","_ORRULE)=ORNUM_U_ORKNUM_U_ORCDL_U_"||"_ORKGLOB_"&"_ORRULE
"RTN","ORKCHK5",142,0)
 ..M ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORRULE)=^TMP($J,OROI,ORCDL,ORRULE)
"RTN","ORKCHK5",143,0)
 K ^TMP($J,OROI)
"RTN","ORKCHK5",144,0)
 Q
"RTN","ORKCHK5",145,0)
 ;
"RTN","ORKCHK5",146,0)
DSGCHK(ORRET,ORDFN,OROIL,ORKA) ;DO DOSAGE ORDER CHECKS
"RTN","ORKCHK5",147,0)
 Q:'$$PATCH^XPDUTL("PSS*1.0*117")
"RTN","ORKCHK5",148,0)
 Q:$G(XQY0)="OR BCMA ORDER COM"
"RTN","ORKCHK5",149,0)
 N ORTYPE,ORY,ORI,ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",150,0)
 D PARAMS("DRUG DOSAGE",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",151,0)
 Q:ORKFLAG="D"  ;this checks if the order check is turned on or not
"RTN","ORKCHK5",152,0)
 I '$$DS^PSSDSAPI D  Q
"RTN","ORKCHK5",153,0)
 .N ORDWNMSG S ORDWNMSG=$$DSDWNMSG^ORDSGCHK
"RTN","ORKCHK5",154,0)
 .S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_ORDWNMSG)=ORNUM_U_25_U_2_ORDWNMSG
"RTN","ORKCHK5",155,0)
 S ORTYPE=$P(ORKA,"|",2)
"RTN","ORKCHK5",156,0)
 D EN^ORDSGCHK(.ORY,ORDFN,ORTYPE,.OROIL)
"RTN","ORKCHK5",157,0)
 N ORI S ORI=0 F  S ORI=$O(ORY(ORI)) Q:'ORI  D
"RTN","ORKCHK5",158,0)
 .I $P(ORY(ORI),U)="ERR" S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_$E($P(ORY(ORI),U,2),1,225))=ORNUM_U_25_U_2_U_$P(ORY(ORI),U,2)
"RTN","ORKCHK5",159,0)
 .I $P(ORY(ORI),U)="DS" S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_$E($P(ORY(ORI),U,2),1,225))=ORNUM_U_ORKNUM_U_ORKDNGR_U_$P(ORY(ORI),U,2)
"RTN","ORKCHK5",160,0)
 Q
"RTN","ORKCHK6")
0^9^B31183287
"RTN","ORKCHK6",1,0)
ORKCHK6 ; SLC/CLA - Support routine called by ORKCHK to do SESSION mode order checks ;05/10/12  13:30
"RTN","ORKCHK6",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,87,94,123,162,190,249,280,272,346,345**;Dec 17, 1997;Build 32
"RTN","ORKCHK6",3,0)
 Q
"RTN","ORKCHK6",4,0)
 ;
"RTN","ORKCHK6",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE) ;perform order checking for entire ordering session
"RTN","ORKCHK6",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK6",7,0)
 ;
"RTN","ORKCHK6",8,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK6",9,0)
 N ORKMSG,ORKDGI,ORKTXT,ORKPDATA,ORIFN
"RTN","ORKCHK6",10,0)
 ;
"RTN","ORKCHK6",11,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK6",12,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK6",13,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK6",14,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK6",15,0)
 S ORIFN=ORNUM
"RTN","ORKCHK6",16,0)
 ;
"RTN","ORKCHK6",17,0)
 S:ORKDG="PSJ" ORKDG="PSI"
"RTN","ORKCHK6",18,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK6",19,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",20,0)
 Q
"RTN","ORKCHK6",21,0)
 ;
"RTN","ORKCHK6",22,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK6",23,0)
 N ORPSPKG,ORPSA,ORRXDONE
"RTN","ORKCHK6",24,0)
 N ORCRITN,ORCRITF,ORCRITD,ORSIGN,ORSIGF,ORSIGD,ORDUPN,ORDUPF,ORDUPD,ORDUPC,ORDUPCF,ORDUPCD,ORALLRN,ORALLRF,ORALLRD,ORDUPCN
"RTN","ORKCHK6",25,0)
 ;
"RTN","ORKCHK6",26,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK6",27,0)
 D PARAMS("CRITICAL DRUG INTERACTION",.ORCRITN,.ORCRITF,.ORCRITD)
"RTN","ORKCHK6",28,0)
 D PARAMS("SIGNIFICANT DRUG INTERACTION",.ORSIGN,.ORSIGF,.ORSIGD)
"RTN","ORKCHK6",29,0)
 D PARAMS("DUPLICATE DRUG ORDER",.ORDUPN,.ORDUPF,.ORDUPD)
"RTN","ORKCHK6",30,0)
 D PARAMS("DUPLICATE DRUG THERAPY",.ORDUPCN,.ORDUPCF,.ORDUPCD)
"RTN","ORKCHK6",31,0)
 ;
"RTN","ORKCHK6",32,0)
 S ORRXDONE=0 ;flag to set if RXOCS gets called
"RTN","ORKCHK6",33,0)
 ;dispense drug selected:
"RTN","ORKCHK6",34,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",35,0)
 .D RXOCS
"RTN","ORKCHK6",36,0)
 .S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK6",37,0)
 .S ORRXDONE=1
"RTN","ORKCHK6",38,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",39,0)
 ;
"RTN","ORKCHK6",40,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK6",41,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK6",42,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK6",43,0)
 .I "IOH"[ORPSPKG D
"RTN","ORKCHK6",44,0)
 ..S ORPSA=$$OI2DD^ORKPS(OI,ORPSPKG,1)
"RTN","ORKCHK6",45,0)
 ..I +ORPSA D
"RTN","ORKCHK6",46,0)
 ...S HL7LTXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",47,0)
 ...S HL7NPTR=$P(ORPSA,";",2)
"RTN","ORKCHK6",48,0)
 ...S HL7LPTR=+ORPSA
"RTN","ORKCHK6",49,0)
 ...S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK6",50,0)
 ...S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK6",51,0)
 ...S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK6",52,0)
 ...S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK6",53,0)
 ..D RXOCS
"RTN","ORKCHK6",54,0)
 ..S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK6",55,0)
 ..S ORRXDONE=1
"RTN","ORKCHK6",56,0)
 ..Q:HL7LTXT=""
"RTN","ORKCHK6",57,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",58,0)
 I ORRXDONE=0 D
"RTN","ORKCHK6",59,0)
 .N ORKSMSG,OROITXT
"RTN","ORKCHK6",60,0)
 .S OROITXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",61,0)
 .I $L(OROITXT)>0 S OROITXT=" for "_$$TRIM^XLFSTR(OROITXT)
"RTN","ORKCHK6",62,0)
 .S ORKMSG="Enhanced order checks cannot be done"_OROITXT_". Please perform a manual check for Drug-Interactions, Duplicate Therapy"
"RTN","ORKCHK6",63,0)
 .I $$DS^PSSDSAPI S ORKMSG=ORKMSG_" and Dosing"
"RTN","ORKCHK6",64,0)
 .S ORKS("ORK",2_$E(ORKMSG,1,225))=ORNUM_U_25_U_3_U_ORKMSG
"RTN","ORKCHK6",65,0)
 Q
"RTN","ORKCHK6",66,0)
 ;
"RTN","ORKCHK6",67,0)
RXOCS ;drug-drug interaction, duplicate drug order, duplicate drug class
"RTN","ORKCHK6",68,0)
 Q:ORCRITF_ORSIGF_ORDUPF_ORDUPCF_ORALLRF'["E"  ;quit if none are "E"nabled
"RTN","ORKCHK6",69,0)
 N ORKRX,ORPSNUM,ORY,CHK,XX
"RTN","ORKCHK6",70,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",71,0)
 .D CHKSESS^ORKPS(.ORKRX,ORKDFN,HL7LPTR_U_HL7LTXT,OI,ORKPDATA,ORKDG,+$P($G(ORPSA),";",4),$P(ORKA,"|",7))
"RTN","ORKCHK6",72,0)
 .S CHK=0,XX="" F  S CHK=$O(ORKRX(CHK)) Q:'CHK  D
"RTN","ORKCHK6",73,0)
 ..S XX=ORKRX(CHK)
"RTN","ORKCHK6",74,0)
 ..;
"RTN","ORKCHK6",75,0)
 ..;get errors/exceptions/checks not done
"RTN","ORKCHK6",76,0)
 ..I $P(XX,U)="ERR" S ORKS("ORK",2_$E($P(XX,U,2),1,225)_","_$G(ORNUM))=ORNUM_U_25_U_3_U_$P(XX,U,2)
"RTN","ORKCHK6",77,0)
 ..;
"RTN","ORKCHK6",78,0)
 ..;critical drug interaction:
"RTN","ORKCHK6",79,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="CRITICAL" D
"RTN","ORKCHK6",80,0)
 ...Q:ORCRITF="D"
"RTN","ORKCHK6",81,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",82,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",83,0)
 ...S ORKS("ORK",ORCRITD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORCRITN_U_ORCRITD_U_ORKTXT
"RTN","ORKCHK6",84,0)
 ..;
"RTN","ORKCHK6",85,0)
 ..;significant drug interaction:
"RTN","ORKCHK6",86,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="SIGNIFICANT" D
"RTN","ORKCHK6",87,0)
 ...Q:ORSIGF="D"
"RTN","ORKCHK6",88,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",89,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",90,0)
 ...S ORKS("ORK",ORSIGD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORSIGN_U_ORSIGD_U_ORKTXT
"RTN","ORKCHK6",91,0)
 ..;
"RTN","ORKCHK6",92,0)
 ..;duplicate drug:
"RTN","ORKCHK6",93,0)
 ..I $P(XX,U)="DD" D
"RTN","ORKCHK6",94,0)
 ...Q:ORDUPF="D"
"RTN","ORKCHK6",95,0)
 ...S ORPSNUM=$P(XX,U,4)  ;get the associated order number
"RTN","ORKCHK6",96,0)
 ...S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK6",97,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) D
"RTN","ORKCHK6",98,0)
 ....D TEXT^ORQ12(.ORY,ORPSNUM,"")
"RTN","ORKCHK6",99,0)
 ....S ORKTXT=ORKTXT_$S($D(ORY(2))=1:" "_$$TRIM^XLFSTR(ORY(2)),1:"")_" ["_$P($G(^ORD(100.01,+$P(^OR(100,+ORPSNUM,3),U,3),0)),U,1)_"]"
"RTN","ORKCHK6",100,0)
 ...S ORKMSG="Duplicate drug order: "_ORKTXT
"RTN","ORKCHK6",101,0)
 ...S ORKS("ORK",ORDUPD_","_$G(ORNUM)_","_ORPSNUM_",Duplicate drug order: "_$E($P(XX,U,3),1,200))=ORNUM_U_ORDUPN_U_ORDUPD_U_ORKMSG_U_$G(ORPSNUM)
"RTN","ORKCHK6",102,0)
 ..;
"RTN","ORKCHK6",103,0)
 ..;duplicate class: NOW DRUG THERAPY
"RTN","ORKCHK6",104,0)
 ..I $P(XX,U)="DC" D
"RTN","ORKCHK6",105,0)
 ...Q:ORDUPCF="D"
"RTN","ORKCHK6",106,0)
 ...S ORPSNUM=$P(XX,U,2)  ;get the associated order number
"RTN","ORKCHK6",107,0)
 ...S ORKMSG=$P(XX,U,4)
"RTN","ORKCHK6",108,0)
 ...S ORKS("ORK",ORDUPCD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORDUPCN_U_ORDUPCD_U_ORKMSG
"RTN","ORKCHK6",109,0)
 Q:ORALLRF="D"
"RTN","ORKCHK6",110,0)
 N ORKAL
"RTN","ORKCHK6",111,0)
 I $L($G(HL7NPTR)),($G(HL7NCOD)="99NDF") D
"RTN","ORKCHK6",112,0)
 .D RXN^ORQQAL(.ORKAL,ORKDFN,"DR",HL7NPTR,$G(HL7LPTR)) I (ORKAL>0) D
"RTN","ORKCHK6",113,0)
 ..Q:$L($P(ORKAL,U,2))<1
"RTN","ORKCHK6",114,0)
 ..S ORKMSG="Previous adverse reaction to: "_$P(ORKAL,U,2)
"RTN","ORKCHK6",115,0)
 ..S ORKS("ORK",ORALLRD_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_ORALLRN_U_ORALLRD_U_ORKMSG
"RTN","ORKCHK6",116,0)
 Q
"RTN","ORKCHK6",117,0)
 ;
"RTN","ORKCHK6",118,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK6",119,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK6",120,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK6",121,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK6",122,0)
 Q
"RTN","ORKPS")
0^6^B95306003
"RTN","ORKPS",1,0)
ORKPS ; slc/CLA - Order checking support procedures for medications ;05/10/12  08:10
"RTN","ORKPS",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123,141,190,232,316,272,346,345**;Dec 17, 1997;Build 32
"RTN","ORKPS",3,0)
 Q
"RTN","ORKPS",4,0)
CHECK(YY,DFN,MED,OI,ORKDG,OROIL,ORSUPPLY,ORIVTYPE,ORIVRAN,ORDODSG) ; return drug order checks
"RTN","ORKPS",5,0)
 ;YY:    returned array of data
"RTN","ORKPS",6,0)
 ;DFN:   patient id
"RTN","ORKPS",7,0)
 ;MED:   drug ien [file #50] ^ generic name [file #50]
"RTN","ORKPS",8,0)
 ;OI:    orderable item ien [file #101.43]
"RTN","ORKPS",9,0)
 ;ORKDG: display group (should be PSI, PSIV, PSO or PSH)
"RTN","ORKPS",10,0)
 ;OROIL: list of items ordered
"RTN","ORKPS",11,0)
 ;ORSUPPLY: pharmacy orderable item ien [file #50.7] if it resolves to one or more supply items
"RTN","ORKPS",12,0)
 ;          0 if the pharmacy orderable item does not resolve to any supply items
"RTN","ORKPS",13,0)
 ;ORIVTYPE: the MED type as sent from Infusion Order Dialog
"RTN","ORKPS",14,0)
 ;          A for additive
"RTN","ORKPS",15,0)
 ;          B for base
"RTN","ORKPS",16,0)
 ;ORIVRAN: FLAG THAT DENOTES IF ALL COMPONENTS OF INFUSION ORDER HAVE ALREADY BEEN PROCESSED
"RTN","ORKPS",17,0)
 ;         1 FOR ALREADY PROCESSED
"RTN","ORKPS",18,0)
 ;         EMPTY STRING FOR NOT YET PROCESSED
"RTN","ORKPS",19,0)
 ;ORDODSG: FLAG THAT DENOTES IF DOSAGE CHECKS SHOULD BE PERFORMED
"RTN","ORKPS",20,0)
 ;         1 FOR PERFORM DOSAGE CHECKS
"RTN","ORKPS",21,0)
 ;         0 FOR DO NOT PERFORM DOSAGE CHECKS
"RTN","ORKPS",22,0)
 ; returned info: varies for ^TMP($J x-ref - refer to listings below
"RTN","ORKPS",23,0)
 N OR2CRITN,OR2CRITF,OR2CRITD,OR2SIGN,OR2SIGF,OR2SIGD,OR2DUPN,OR2DUPF,OR2DUPD,OR2DUPCN,OR2DUPCF,OR2DUPCD
"RTN","ORKPS",24,0)
 N ORPHDG,ORKSOIA,ORDOCHKS
"RTN","ORKPS",25,0)
 D PARAMS^ORKCHK6("CRITICAL DRUG INTERACTION",.OR2CRITN,.OR2CRITF,.OR2CRITD)
"RTN","ORKPS",26,0)
 D PARAMS^ORKCHK6("SIGNIFICANT DRUG INTERACTION",.OR2SIGN,.OR2SIGF,.OR2SIGD)
"RTN","ORKPS",27,0)
 D PARAMS^ORKCHK6("DUPLICATE DRUG THERAPY",.OR2DUPCN,.OR2DUPCF,.OR2DUPCD)
"RTN","ORKPS",28,0)
 N ORDFN,ORKA,ORPTY,ORPHOI,OROILI,ORKAI S ORDFN=DFN
"RTN","ORKPS",29,0)
 S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",30,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",31,0)
 S ORPHDG=$S(ORKDG="PSI":"U",ORKDG="PSIV":"I",ORKDG="PSO":"O",ORKDG="PSH":"N",1:"")
"RTN","ORKPS",32,0)
 I $G(ORIVTYPE)'="A" D  Q:'ORDOCHKS  ; Don't do checks if pharmacy does not want us to
"RTN","ORKPS",33,0)
 .S ORDOCHKS=$$PRE^PSSDSAPK(ORPHOI,ORPHDG)
"RTN","ORKPS",34,0)
 .S:'ORDODSG ORDODSG=ORDOCHKS
"RTN","ORKPS",35,0)
 S:$G(ORIVTYPE)="A" ORDODSG=1
"RTN","ORKPS",36,0)
 I +MED,('ORIVRAN) S ORKA(1)=MED_U_$$GETPSNM(+MED),ORKAI=1
"RTN","ORKPS",37,0)
 ;ADD ALL COMPONENTS OF IV ORDER SO WE ONLY HAVE TO DO A SINGLE PRE CALL
"RTN","ORKPS",38,0)
 I ORKDG="PSIV",('ORIVRAN) D
"RTN","ORKPS",39,0)
 .S ORIVRAN=1,OROILI=0 F  S OROILI=$O(OROIL(OROILI)) Q:'OROILI  D
"RTN","ORKPS",40,0)
 ..N OR2OI,OR2PSOI,OR2PHDG
"RTN","ORKPS",41,0)
 ..I 'OROIL(OROILI) Q
"RTN","ORKPS",42,0)
 ..I +OROIL(OROILI)=OI Q
"RTN","ORKPS",43,0)
 ..S OR2OI=+OROIL(OROILI)
"RTN","ORKPS",44,0)
 ..S OR2PSOI=+$P($G(^ORD(101.43,+OR2OI,0)),U,2)
"RTN","ORKPS",45,0)
 ..S OR2PHDG=$P(OROIL(OROILI),U,2)
"RTN","ORKPS",46,0)
 ..S OR2PHDG=$S(OR2PHDG="PSI":"U",OR2PHDG="PSIV":"I",OR2PHDG="PSO":"O",OR2PHDG="PSH":"N",1:"")
"RTN","ORKPS",47,0)
 ..Q:OR2PHDG'="I"
"RTN","ORKPS",48,0)
 ..I $P($P(OROIL(OROILI),U,3),";")="B",$$PRE^PSSDSAPK(OR2PSOI,OR2PHDG)=0 Q
"RTN","ORKPS",49,0)
 ..I $P($P(OROIL(OROILI),U,3),";")="B",$P($P(OROIL(OROILI),U,3),";",2)="",$G(ORREN)=1 D
"RTN","ORKPS",50,0)
 ...N ORVOLID,ORVOLVAL S ORVOLVAL="",ORVOLID=$O(^OR(100,+$G(ORIFN),4.5,"ID","VOLUME",""))
"RTN","ORKPS",51,0)
 ...I ORVOLID>0 S ORVOLVAL=$G(^OR(100,+$G(ORIFN),4.5,ORVOLID,1))
"RTN","ORKPS",52,0)
 ...S OROIL(OROILI)=OROIL(OROILI)_ORVOLVAL
"RTN","ORKPS",53,0)
 ..N ORUSID
"RTN","ORKPS",54,0)
 ..S ORUSID=$$USID^ORWDXC(OROIL(OROILI))
"RTN","ORKPS",55,0)
 ..S ORKAI=ORKAI+1,ORKA(ORKAI)=$P(ORUSID,U,4)_U_$$GETPSNM($P(ORUSID,U,4))
"RTN","ORKPS",56,0)
 D:$D(ORKA) CPRS^PSODDPR4(ORDFN,"OROCOUT"_ORPTY,.ORKA,ORPTY_+$G(^OR(100,+$G(ORIFN),4)))
"RTN","ORKPS",57,0)
 I +ORSUPPLY D
"RTN","ORKPS",58,0)
 .S ORKSOIA(+ORSUPPLY)=""
"RTN","ORKPS",59,0)
 .D CPRS^PSODDPR8(ORDFN,"OROCOUT"_ORPTY,.ORKSOIA,ORPHDG_";"_+$G(^OR(100,+$G(ORNUM),4)),$S($D(ORKA):1,1:""))
"RTN","ORKPS",60,0)
 I $D(ORKA)!($D(ORKSOIA))!(ORIVRAN) D
"RTN","ORKPS",61,0)
 .S:OR2CRITF_OR2SIGF_OR2DUPCF["E" ^TMP($J,"ORENHCHK")=1
"RTN","ORKPS",62,0)
 .D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORSUPPLY_U_+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",63,0)
 Q
"RTN","ORKPS",64,0)
CHKSESS(YY,DFN,MED,OI,ORKPDATA,ORKDG,ORSUPPLY,ORIVTYPE) ; return drug order checks for session
"RTN","ORKPS",65,0)
 ;ORSUPPLY: pharmacy orderable item ien [file #50.7] if it resolves to one or more supply items
"RTN","ORKPS",66,0)
 ;          0 if the pharmacy orderable item does not resolve to any supply items
"RTN","ORKPS",67,0)
 ;ORIVTYPE: the MED type as sent from Infusion Order Dialog
"RTN","ORKPS",68,0)
 ;          A for additive
"RTN","ORKPS",69,0)
 ;          B for base
"RTN","ORKPS",70,0)
 N ORKDGI,ORKDRUG,ORKDRUGA,ORKORN,HOR,SEQ,CNT,CNTX,ORKOI,ORPHOI
"RTN","ORKPS",71,0)
 N ORKFLG,ORSESS,ORPSPKG,ORPSA,ORSNUM,ORNUM,DUPX,DUPORN,ORPTY
"RTN","ORKPS",72,0)
 N ORKSOIA,ORRET,ORDFN,ORPHDG S ORDFN=DFN
"RTN","ORKPS",73,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",74,0)
 S ORPHDG=$S(ORKDG="PSI":"U",ORKDG="PSIV":"I",ORKDG="PSO":"O",ORKDG="PSH":"N",1:"")
"RTN","ORKPS",75,0)
 I '$D(^TMP($J,"OROCOUT"_ORPTY)) D
"RTN","ORKPS",76,0)
 .S ORKFLG=0
"RTN","ORKPS",77,0)
 .S ORNUM=$P(ORKA,"|",5)
"RTN","ORKPS",78,0)
 .S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",79,0)
 .I $G(ORIVTYPE)'="A",'$$PRE^PSSDSAPK(ORPHOI,ORPHDG) Q  ; Don't do checks if pharmacy does not want us to
"RTN","ORKPS",80,0)
 .;get other session med orders:
"RTN","ORKPS",81,0)
 .I $D(^TMP("ORKA",$J)) D
"RTN","ORKPS",82,0)
 ..S CNT=^TMP("ORKA",$J) F CNTX=1:1:CNT D
"RTN","ORKPS",83,0)
 ...S ORSESS=$G(^TMP("ORKA",$J,CNTX))
"RTN","ORKPS",84,0)
 ...Q:'$L(ORSESS)
"RTN","ORKPS",85,0)
 ...S ORPSPKG=$P(ORSESS,"|",2)
"RTN","ORKPS",86,0)
 ...Q:'$L(ORPSPKG)
"RTN","ORKPS",87,0)
 ...Q:$E(ORPSPKG,1,2)'="PS"
"RTN","ORKPS",88,0)
 ...S ORSNUM=$P(ORSESS,"|",5)
"RTN","ORKPS",89,0)
 ...S ORKOI=$P(ORSESS,"|")
"RTN","ORKPS",90,0)
 ...;quit if same order/oi:
"RTN","ORKPS",91,0)
 ...Q:((+$G(ORNUM)=+$G(ORSNUM))&(+$G(OI)=+$G(ORKOI)))
"RTN","ORKPS",92,0)
 ...S:ORPSPKG="PSJ" ORPSPKG="PSI"
"RTN","ORKPS",93,0)
 ...S ORKDRUG=$P($P(ORSESS,"|",3),U,4)
"RTN","ORKPS",94,0)
 ...;if no disp drug selected get disp drug(s) from OI:
"RTN","ORKPS",95,0)
 ...I +$G(ORKDRUG)<1,$L(ORKOI),"IOH"[$E(ORPSPKG,3) D
"RTN","ORKPS",96,0)
 ....S ORRET=$$OI2DD(ORKOI,$E(ORPSPKG,3),1)
"RTN","ORKPS",97,0)
 ....I +$P(ORRET,";",4) S ORKSOIA(+$P(ORRET,";",4))=""
"RTN","ORKPS",98,0)
 ....I +ORRET S ORKDRUG=+ORRET
"RTN","ORKPS",99,0)
 ...Q:+$G(ORKDRUG)<1
"RTN","ORKPS",100,0)
 ...;if dispense drug selected add to array:
"RTN","ORKPS",101,0)
 ...S ORKDRUGA(ORKDRUG_";"_ORPSPKG_";"_ORSNUM)=ORSNUM_U_$$GETPSNM(+ORKDRUG)
"RTN","ORKPS",102,0)
 .;get unsigned medication orders:
"RTN","ORKPS",103,0)
 .S HOR=0,SEQ=0
"RTN","ORKPS",104,0)
 .S HOR=$O(^TMP("ORR",$J,HOR))
"RTN","ORKPS",105,0)
 .I +$G(HOR)>0 D
"RTN","ORKPS",106,0)
 ..F  S SEQ=$O(^TMP("ORR",$J,HOR,SEQ)) Q:+SEQ<1  D
"RTN","ORKPS",107,0)
 ...S ORKORN=+$P(^TMP("ORR",$J,HOR,SEQ),U),DUPORN=0
"RTN","ORKPS",108,0)
 ...Q:+$G(ORKORN)<1
"RTN","ORKPS",109,0)
 ...Q:+ORKORN=+ORNUM
"RTN","ORKPS",110,0)
 ...Q:$P(^OR(100,+ORKORN,8,$P(^OR(100,+ORKORN,8,0),U,3),0),U,2)="DC"
"RTN","ORKPS",111,0)
 ...Q:$P(^ORD(100.01,$P(^OR(100,+ORKORN,3),U,3),0),U)="DISCONTINUED"
"RTN","ORKPS",112,0)
 ...S ORKDRUG=$$VALUE^ORCSAVE2(+ORKORN,"DRUG") ;get disp drug for order
"RTN","ORKPS",113,0)
 ...S ORPSPKG=$$DGRX^ORQOR2(+ORKORN)
"RTN","ORKPS",114,0)
 ...S ORPSPKG=$S(ORPSPKG="UNIT DOSE MEDICATIONS":"PSI",ORPSPKG="OUTPATIENT MEDICATIONS":"PSO",ORPSPKG="IV MEDICATIONS":"PSIV",ORPSPKG="NON-VA MEDICATIONS":"PSH",1:"")
"RTN","ORKPS",115,0)
 ...S DUPX="" F  S DUPX=$O(ORKDRUGA(DUPX)) Q:'DUPX!(DUPORN=1)  D
"RTN","ORKPS",116,0)
 ....S:ORKORN=ORKDRUGA(DUPX) DUPORN=1
"RTN","ORKPS",117,0)
 ...Q:DUPORN=1  ;quit if already processed drug order
"RTN","ORKPS",118,0)
 ...I +$G(ORKDRUG)<1,$L(ORPSPKG)>0 D
"RTN","ORKPS",119,0)
 ....N OROI S OROI=$$OI^ORX8(+ORKORN)
"RTN","ORKPS",120,0)
 ....S ORRET=$$OI2DD(+OROI,$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSH":"O",1:"O"),1)
"RTN","ORKPS",121,0)
 ....I +$P(ORRET,";",4) S ORKSOIA(+$P(ORRET,";",4))=""
"RTN","ORKPS",122,0)
 ....I +ORRET S ORKDRUG=+ORRET
"RTN","ORKPS",123,0)
 ...;only process vs. unsigned med order if disp drug is assoc w/order:
"RTN","ORKPS",124,0)
 ...Q:+$G(ORKDRUG)<1
"RTN","ORKPS",125,0)
 ...S ORKDRUGA(+ORKDRUG_";"_ORPSPKG_";"_ORKORN)=ORKORN_U_$$GETPSNM(+ORKDRUG)
"RTN","ORKPS",126,0)
 .N ORPROSP,CNT
"RTN","ORKPS",127,0)
 .S CNT=1
"RTN","ORKPS",128,0)
 .S:+MED ORPROSP(CNT)=MED_U_$$GETPSNM(+MED)_U_+$G(ORNUM),CNT=CNT+1
"RTN","ORKPS",129,0)
 .N I S I="" F  S I=$O(ORKDRUGA(I)) Q:'I  S ORPROSP(CNT)=+I_U_$P(ORKDRUGA(I),U,2)_U_$P(ORKDRUGA(I),U,1),CNT=CNT+1
"RTN","ORKPS",130,0)
 .D SHRNKPR
"RTN","ORKPS",131,0)
 .D CPRS^PSODDPR4(DFN,"OROCOUT"_ORPTY,.ORPROSP,ORPTY_+$G(^OR(100,+$G(ORNUM),4)))
"RTN","ORKPS",132,0)
 .S:+ORSUPPLY ORKSOIA(+ORSUPPLY)=""
"RTN","ORKPS",133,0)
 .D:$D(ORKSOIA)>9 CPRS^PSODDPR8(DFN,"OROCOUT"_ORPTY,.ORKSOIA,ORPHDG_";"_+$G(^OR(100,+$G(ORNUM),4)),1)
"RTN","ORKPS",134,0)
 D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORSUPPLY_U_+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",135,0)
 Q
"RTN","ORKPS",136,0)
SHRNKPR ;REMOVE DUPLICATS FROM PROSPECTIVE LIST
"RTN","ORKPS",137,0)
 Q:'$D(ORPROSP)
"RTN","ORKPS",138,0)
 N ORX,ORI S ORI=0 F  S ORI=$O(ORPROSP(ORI)) Q:'ORI  S ORX=ORPROSP(ORI) D
"RTN","ORKPS",139,0)
 .N ORJ S ORJ=ORI F  S ORJ=$O(ORPROSP(ORJ)) Q:'ORJ  I ORX=ORPROSP(ORJ) K ORPROSP(ORJ)
"RTN","ORKPS",140,0)
 Q
"RTN","ORKPS",141,0)
GETPSNM(ORIEN) ;GET THE FILE 50 .01 FIELD FROM A FILE 50 IEN
"RTN","ORKPS",142,0)
 N RET K ^TMP($J,"ORRETNM")
"RTN","ORKPS",143,0)
 D NDF^PSS50(ORIEN,,,,,"ORRETNM") S RET=$G(^TMP($J,"ORRETNM",ORIEN,.01))
"RTN","ORKPS",144,0)
 K ^TMP($J,"ORRETNM")
"RTN","ORKPS",145,0)
 Q RET
"RTN","ORKPS",146,0)
TAKEMED(ORKDFN,ORKMED) ;extrinsic function returns med orderable item if any
"RTN","ORKPS",147,0)
 ;active med patient is taking contains any piece of ORKMED
"RTN","ORKPS",148,0)
 ;ORKDFN   patient DFN
"RTN","ORKPS",149,0)
 ;ORKMED   meds to check vs. active med list in format MED1^MED2^MED3...
"RTN","ORKPS",150,0)
 Q:'$L($G(ORKDFN)) "0^Patient not identified."
"RTN","ORKPS",151,0)
 Q:'$L($G(ORKMED)) "0^Medication not identified."
"RTN","ORKPS",152,0)
 N ORKARX,ORKY,ORI,ORJ,ORCNT,ORKMEDP,ORKRSLT
"RTN","ORKPS",153,0)
 D LIST^ORQQPS(.ORKY,ORKDFN,"","")
"RTN","ORKPS",154,0)
 Q:$P(ORKY(1),U)="" "0^No active meds found."
"RTN","ORKPS",155,0)
 S ORKRSLT="0^No matching meds found."
"RTN","ORKPS",156,0)
 S ORCNT=$L(ORKMED,U)
"RTN","ORKPS",157,0)
 S ORI=0 F  S ORI=$O(ORKY(ORI)) Q:ORI<1  D
"RTN","ORKPS",158,0)
 .S ORKARX=$P(ORKY(ORI),U,2)
"RTN","ORKPS",159,0)
 .F ORJ=1:1:ORCNT S ORKMEDP=$P(ORKMED,U,ORJ) D
"RTN","ORKPS",160,0)
 ..I $L(ORKMEDP),($$UP^XLFSTR(ORKARX)[ORKMEDP) S ORKRSLT="1^"_ORKARX ;DJE/VM *316 use uppercase in comparison
"RTN","ORKPS",161,0)
 Q ORKRSLT
"RTN","ORKPS",162,0)
POLYRX(DFN) ;extrins funct rtns 1 if patient exceeds polypharmacy, 0 if not
"RTN","ORKPS",163,0)
 N ORSLT,ORENT,ORLOC,ORPAR,ORMEDS
"RTN","ORKPS",164,0)
 S ORSLT=0
"RTN","ORKPS",165,0)
 Q:'$L(DFN) ORSLT
"RTN","ORKPS",166,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",167,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",168,0)
 K VA200,VAIN
"RTN","ORKPS",169,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",170,0)
 S ORPAR=$$GET^XPAR(ORENT,"ORK POLYPHARMACY",1,"I")
"RTN","ORKPS",171,0)
 S ORMEDS=$$NUMRX(DFN)
"RTN","ORKPS",172,0)
 I $G(ORMEDS)>$G(ORPAR) S ORSLT=1
"RTN","ORKPS",173,0)
 Q ORSLT
"RTN","ORKPS",174,0)
GLCREAT(DFN) ;extrinsic function returns patient's (DFN) most recent serum
"RTN","ORKPS",175,0)
 ; creatinine within # of days from parameter ORK GLUCOPHAGE CREATININE
"RTN","ORKPS",176,0)
 ; results format: test id^result units flag ref range collect d/t^result
"RTN","ORKPS",177,0)
 ; used by order check GLUCOPHAGE-LAB RESULTS
"RTN","ORKPS",178,0)
 N ORLOC,ORPAR,ORDAYS
"RTN","ORKPS",179,0)
 N BDT,CDT,ORY,ORX,ORZ,TEST,ORI,ORJ,CREARSLT,LABFILE,SPECFILE,SPECIMEN,VAIN,VADM,RSLTS
"RTN","ORKPS",180,0)
 Q:'$L(DFN) "0^"
"RTN","ORKPS",181,0)
 S ORDAYS=$$GCDAYS(DFN)
"RTN","ORKPS",182,0)
 Q:'$L(ORDAYS) "0^"
"RTN","ORKPS",183,0)
 D NOW^%DTC
"RTN","ORKPS",184,0)
 S BDT=$$FMADD^XLFDT(%,"-"_ORDAYS,"","","")
"RTN","ORKPS",185,0)
 K %
"RTN","ORKPS",186,0)
 Q:'$L($G(BDT)) "0^"
"RTN","ORKPS",187,0)
 S LABFILE=$$TERMLKUP^ORB31(.ORY,"SERUM CREATININE")
"RTN","ORKPS",188,0)
 Q:'$D(ORY) "0^" ;no link between SERUM CREATININE and local lab test
"RTN","ORKPS",189,0)
 Q:$G(LABFILE)'=60 "0^"
"RTN","ORKPS",190,0)
 S SPECFILE=$$TERMLKUP^ORB31(.ORX,"SERUM SPECIMEN")
"RTN","ORKPS",191,0)
 Q:'$D(ORX) "0^" ;no link between SERUM SPECIMEN and local specimen
"RTN","ORKPS",192,0)
 Q:$G(SPECFILE)'=61 "0^"
"RTN","ORKPS",193,0)
 F ORI=1:1:ORY D
"RTN","ORKPS",194,0)
 .S TEST=$P(ORY(ORI),U)
"RTN","ORKPS",195,0)
 .Q:+$G(TEST)<1
"RTN","ORKPS",196,0)
 .F ORJ=1:1:ORX D
"RTN","ORKPS",197,0)
 ..S SPECIMEN=$P(ORX(ORJ),U)
"RTN","ORKPS",198,0)
 ..Q:+$G(SPECIMEN)<1
"RTN","ORKPS",199,0)
 ..S ORZ=$$LOCL^ORQQLR1(DFN,TEST,SPECIMEN)
"RTN","ORKPS",200,0)
 ..Q:'$L($G(ORZ))
"RTN","ORKPS",201,0)
 ..S CDT=$P(ORZ,U,7)
"RTN","ORKPS",202,0)
 ..I CDT'<BDT S RSLTS(CDT)=ORZ,CREARSLT=1  ;*SMT Use RSLTS as array.
"RTN","ORKPS",203,0)
 Q:+$G(CREARSLT)<1 "0^"
"RTN","ORKPS",204,0)
 S CDT=$O(RSLTS(0)),ORZ=RSLTS(CDT)  ;*SMT
"RTN","ORKPS",205,0)
 Q $P(ORZ,U)_U_$P(ORZ,U,3)_" "_$P(ORZ,U,4)_" "_$P(ORZ,U,5)_" ("_$P(ORZ,U,6)_")  "_$$FMTE^XLFDT(CDT,"2P")_U_$P(ORZ,U,3)
"RTN","ORKPS",206,0)
GCDAYS(DFN) ;extrinsic function to return number of days to look for
"RTN","ORKPS",207,0)
 ; glucophage serum creatinine result
"RTN","ORKPS",208,0)
 Q:'$L(DFN) ""
"RTN","ORKPS",209,0)
 N ORLOC,ORENT,ORDAYS
"RTN","ORKPS",210,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKPS",211,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKPS",212,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",213,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",214,0)
 K VA200,VAIN
"RTN","ORKPS",215,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",216,0)
 S ORDAYS=$$GET^XPAR(ORENT,"ORK GLUCOPHAGE CREATININE",1,"I")
"RTN","ORKPS",217,0)
 Q:$L(ORDAYS) ORDAYS
"RTN","ORKPS",218,0)
 Q ""
"RTN","ORKPS",219,0)
SUPPLY(OI) ;extrinsic function returns 1 (true) if the orderable item is
"RTN","ORKPS",220,0)
 ; a supply
"RTN","ORKPS",221,0)
 Q:+$G(OI)<1 ""
"RTN","ORKPS",222,0)
 N OITEXT
"RTN","ORKPS",223,0)
 S OITEXT=$G(^ORD(101.43,OI,0))
"RTN","ORKPS",224,0)
 Q:'$L(OITEXT) ""
"RTN","ORKPS",225,0)
 S OITEXT=$P(OITEXT,U)
"RTN","ORKPS",226,0)
 Q:$D(^ORD(101.43,"S.SPLY",OITEXT)) 1
"RTN","ORKPS",227,0)
 Q ""
"RTN","ORKPS",228,0)
NUMRX(DFN) ;extrinsic funct returns number of active meds patient is taking
"RTN","ORKPS",229,0)
 N NUMRX,ORPTYPE,ORX,ORY,ORS,ORNUM,ORPRENEW,VADMVT
"RTN","ORKPS",230,0)
 S NUMRX=0
"RTN","ORKPS",231,0)
 Q:+$G(DFN)<1 NUMRX
"RTN","ORKPS",232,0)
 ;check to determine if inpatient or outpatient:
"RTN","ORKPS",233,0)
 D ADM^VADPT2
"RTN","ORKPS",234,0)
 S ORPTYPE=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS",235,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",236,0)
 D OCL^PSOORRL(DFN,"","")  ;if no date range, returns active meds for pt
"RTN","ORKPS",237,0)
 N X
"RTN","ORKPS",238,0)
 S X=0
"RTN","ORKPS",239,0)
 F  S X=$O(^TMP("PS",$J,X)) Q:X<1  D
"RTN","ORKPS",240,0)
 .S ORX=$G(^TMP("PS",$J,X,0))
"RTN","ORKPS",241,0)
 .S ORY=$P(ORX,U)
"RTN","ORKPS",242,0)
 .S ORNUM=$P(ORX,U,8) ;order entry order number
"RTN","ORKPS",243,0)
 .S ORS=$P(ORX,U,9) ;medication status from pharmacy
"RTN","ORKPS",244,0)
 .S ORPRENEW=$P(ORX,U,14)  ;pending renewal flag (1: pending renewal)
"RTN","ORKPS",245,0)
 .Q:+ORX<1
"RTN","ORKPS",246,0)
 .Q:$P(ORY,";",2)'=ORPTYPE  ;quit if med is not pt type (inpt/outpt)
"RTN","ORKPS",247,0)
 .;quit if status is a non-active type:
"RTN","ORKPS",248,0)
 .Q:$G(ORS)="EXPIRED"
"RTN","ORKPS",249,0)
 .Q:$G(ORS)["DISCONTINUE"
"RTN","ORKPS",250,0)
 .Q:$G(ORS)="DELETED"
"RTN","ORKPS",251,0)
 .Q:+$G(ORPRENEW)>0
"RTN","ORKPS",252,0)
 .Q:$$SUPPLY($$OI^ORQOR2(ORNUM))=1  ;quit if a supply
"RTN","ORKPS",253,0)
 .S NUMRX=NUMRX+1
"RTN","ORKPS",254,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",255,0)
 Q NUMRX
"RTN","ORKPS",256,0)
OI2DD(OROI,ORPSPKG,ORCHKTYP)       ;rtn dispense drugs for a PS OI
"RTN","ORKPS",257,0)
 ;ORCHKTYP: TYPE OF ORDER CHECK SYSTEM IS PERFORMING
"RTN","ORKPS",258,0)
 ;          1 FOR ENHANCED ORDER CHECKS
"RTN","ORKPS",259,0)
 ;          2 FOR DOSAGE ORDER CHECK
"RTN","ORKPS",260,0)
 N PSOI,ORRET
"RTN","ORKPS",261,0)
 Q:'$D(^ORD(101.43,OROI,0)) ""
"RTN","ORKPS",262,0)
 S PSOI=+$P(^ORD(101.43,OROI,0),U,2)
"RTN","ORKPS",263,0)
 Q:PSOI<1 ""
"RTN","ORKPS",264,0)
 S:ORPSPKG="H" ORPSPKG="X"  ;if non-va med need to pass api "X"
"RTN","ORKPS",265,0)
 S ORRET=$$DRG^PSSDSAPM(PSOI,ORPSPKG,ORCHKTYP)
"RTN","ORKPS",266,0)
 I ORCHKTYP=1,(+$P(ORRET,";",4)) S $P(ORRET,";",4)=PSOI
"RTN","ORKPS",267,0)
 Q ORRET
"RTN","ORKPS1")
0^8^B72321793
"RTN","ORKPS1",1,0)
ORKPS1 ; SLC/CLA - Order checking support procedures for medications ;07/24/12  08:53
"RTN","ORKPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**232,272,346,345**;Dec 17, 1997;Build 32
"RTN","ORKPS1",3,0)
 Q
"RTN","ORKPS1",4,0)
PROCESS(OI,DFN,ORKDG,ORPROSP,ORGLOBL) ;process data from pharmacy order check API
"RTN","ORKPS1",5,0)
 ;ORPROSP = pharmacy orderable item ien [file #50.7] ^ drug ien [file #50]
"RTN","ORKPS1",6,0)
 ;          NOTE: PIECE 1 WILL ONLY BE FILLED IN FOR ORDERABLE ITEMS THAT RESOLVE TO SUPPLY ITEMS
"RTN","ORKPS1",7,0)
 Q:'$D(^TMP($J))
"RTN","ORKPS1",8,0)
 N II,XX,ZZ,ZZD,ORMTYPE,ORN,ORZ,RCNT,GL,I,J,K,L,M,TDATA,VADMVT,ORX,ORY
"RTN","ORKPS1",9,0)
 S II=1,XX=0,ZZ="",ZZD="",RCNT=0
"RTN","ORKPS1",10,0)
 I $G(^TMP($J,ORGLOBL,"OUT",0))<0 D  Q
"RTN","ORKPS1",11,0)
 .S YY(II)="ERR^Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed. "_$P($G(^TMP($J,ORGLOBL,"OUT",0)),U,2)
"RTN","ORKPS1",12,0)
 .S II=II+1
"RTN","ORKPS1",13,0)
 I $D(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS")) D
"RTN","ORKPS1",14,0)
 .S ORX="" F  S ORX=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX)) Q:'$L(ORX)  D
"RTN","ORKPS1",15,0)
 ..S ORY=0 F  S ORY=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)) Q:'ORY  D
"RTN","ORKPS1",16,0)
 ...I $L($G(ORIFN))>0,$G(ORIFN)=$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,5) Q
"RTN","ORKPS1",17,0)
 ...S YY(II)="ERR^"_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,7)
"RTN","ORKPS1",18,0)
 ...I $L($P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10))>0 S YY(II)=YY(II)_"("_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10)_")"
"RTN","ORKPS1",19,0)
 ...S II=II+1
"RTN","ORKPS1",20,0)
 S ORX="" F ORX="DRUGDRUG","THERAPY" D
"RTN","ORKPS1",21,0)
 .Q:'$D(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR"))
"RTN","ORKPS1",22,0)
 .S ORY="" F  S ORY=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY)) Q:'$L(ORY)  D
"RTN","ORKPS1",23,0)
 ..S ORZ=0 F  S ORZ=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ)) Q:'ORZ  D
"RTN","ORKPS1",24,0)
 ...S YY(II)="ERR^"_$$UPPER^ORWDPS32($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"SEV")))_": "_$P($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,0)),U)_" - "_$G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"TEXT"))
"RTN","ORKPS1",25,0)
 ...S II=II+1
"RTN","ORKPS1",26,0)
 I +$P(ORPROSP,U,2) D
"RTN","ORKPS1",27,0)
 .;set info about the drug being ordered
"RTN","ORKPS1",28,0)
 .S TDATA("NEW","TXT")=""
"RTN","ORKPS1",29,0)
 .S I="" F  S I=$O(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)) Q:'$L(I)  D
"RTN","ORKPS1",30,0)
 ..I $P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,3)=+$P(ORPROSP,U,2) D
"RTN","ORKPS1",31,0)
 ...S TDATA("NEW","TXT")=$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,4)
"RTN","ORKPS1",32,0)
 ...S TDATA("NEW","PROSP")=$P(I,";",3,4)
"RTN","ORKPS1",33,0)
 .S TDATA("NEW","PTYPE")=$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSH":"O",1:"")
"RTN","ORKPS1",34,0)
 .S TDATA("NEW","OTYPE")=$S($G(ORKDG)="PSI":"UD",$G(ORKDG)="PSO":"OP",$G(ORKDG)="PSIV":"IV",$G(ORKDG)="PSH":"NV",1:"")
"RTN","ORKPS1",35,0)
 .I '$L(TDATA("NEW","PTYPE")) D  ;if no display group
"RTN","ORKPS1",36,0)
 ..D ADM^VADPT2
"RTN","ORKPS1",37,0)
 ..S TDATA("NEW","PTYPE")=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS1",38,0)
 ..K VADMVT
"RTN","ORKPS1",39,0)
 D DD(.TDATA,$S(+ORPROSP>0:0,1:1))
"RTN","ORKPS1",40,0)
 Q:'$L($G(TDATA("NEW","PROSP")))
"RTN","ORKPS1",41,0)
 D DI(.TDATA),DT(.TDATA)
"RTN","ORKPS1",42,0)
 Q
"RTN","ORKPS1",43,0)
 ;
"RTN","ORKPS1",44,0)
DI(TDATA) ;add drug interaction checks
"RTN","ORKPS1",45,0)
 N GL
"RTN","ORKPS1",46,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","DRUGDRUG"))
"RTN","ORKPS1",47,0)
 S J="" F  S J=$O(@GL@(J)) Q:'$L(J)  D
"RTN","ORKPS1",48,0)
 .S K="" F  S K=$O(@GL@(J,K)) Q:'$L(K)  D
"RTN","ORKPS1",49,0)
 ..S L=0 F  S L=$O(@GL@(J,K,L)) Q:'$L(L)  D
"RTN","ORKPS1",50,0)
 ...S M=0 F  S M=$O(@GL@(J,K,L,M)) Q:'M  D
"RTN","ORKPS1",51,0)
 ....N ORTXT,ORNUM,ORSEV,ORDNAME,ORZ,CNT,ORSTAT,ORMON,ORWHICH
"RTN","ORKPS1",52,0)
 ....S ORWHICH=""
"RTN","ORKPS1",53,0)
 ....I $P($P(@GL@(J,K,L,M),U),";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",54,0)
 .....S ORWHICH=K
"RTN","ORKPS1",55,0)
 .....I $P(L,";",3)="PROSPECTIVE" S ORWHICH=ORWHICH_" [UNRELEASED]" Q
"RTN","ORKPS1",56,0)
 .....S ORWHICH=ORWHICH_" ["_$$PHSTAT(DFN,$P(L,";",1,2))_"]"
"RTN","ORKPS1",57,0)
 ....I $P(L,";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",58,0)
 .....S ORWHICH=$P(@GL@(J,K,L,M),U,4)
"RTN","ORKPS1",59,0)
 .....I $P($P(@GL@(J,K,L,M),U),";",3)="PROSPECTIVE" S ORWHICH=ORWHICH_" [UNRELEASED]" Q
"RTN","ORKPS1",60,0)
 .....S ORWHICH=ORWHICH_" ["_$$PHSTAT(DFN,$P($P(@GL@(J,K,L,M),U),";",1,2))_"]"
"RTN","ORKPS1",61,0)
 ....Q:$L(ORWHICH)<2
"RTN","ORKPS1",62,0)
 ....;get the associated order number
"RTN","ORKPS1",63,0)
 ....S ORNUM=$P(L,";",1,2)
"RTN","ORKPS1",64,0)
 ....;get text
"RTN","ORKPS1",65,0)
 ....S ORTXT=TDATA("NEW","TXT")_" and "_ORWHICH_" - "_$P($G(@GL@(J,K,L,M,"CLIN")),"CLINICAL EFFECTS:  ",2)
"RTN","ORKPS1",66,0)
 ....;loop through the PMON nodes to get the CLINICAL EFFECTS
"RTN","ORKPS1",67,0)
 ....;N PMON S PMON=0 F  S PMON=$O(@GL@(J,K,L,M,"PMON",PMON)) Q:'PMON  D
"RTN","ORKPS1",68,0)
 ....;.I $L($G(@GL@(J,K,L,M,"PMON",PMON,0)),"CLINICAL EFFECTS:  ")>1 S ORTXT=TDATA("NEW","TXT")_" & "_K_$S($P(L,";")="P":"[PENDING]",ORNUM:"["_$$PHSTAT(DFN,ORNUM)_"]",1:"")_" - "_$P(@GL@(J,K,L,M,"PMON",PMON,0),"CLINICAL EFFECTS:  ",2)
"RTN","ORKPS1",69,0)
 ....;set the monograph into the temp global
"RTN","ORKPS1",70,0)
 ....I $D(@GL@(J,K,L,M,"PMON")) D
"RTN","ORKPS1",71,0)
 .....S ^TMP($J,"ORMONOGRAPH")=1+$G(^TMP($J,"ORMONOGRAPH"))
"RTN","ORKPS1",72,0)
 .....S ORMON=^TMP($J,"ORMONOGRAPH")
"RTN","ORKPS1",73,0)
 .....S ^TMP($J,"ORMONOGRAPH",ORMON,"OC")=ORTXT
"RTN","ORKPS1",74,0)
 .....S ^TMP($J,"ORMONOGRAPH",ORMON,"INT")=@GL@(J,K,L,M,"INT")
"RTN","ORKPS1",75,0)
 .....M ^TMP($J,"ORMONOGRAPH",ORMON,"DATA")=@GL@(J,K,L,M,"PMON")
"RTN","ORKPS1",76,0)
 ....;get the severity
"RTN","ORKPS1",77,0)
 ....S ORSEV=$$UPPER^ORU($G(@GL@(J,K,L,M,"SEV")))
"RTN","ORKPS1",78,0)
 ....;get the drug name
"RTN","ORKPS1",79,0)
 ....S ORDNAME=K
"RTN","ORKPS1",80,0)
 ....;if the status of the associated order is DISCONTINUED then don't add
"RTN","ORKPS1",81,0)
 ....S ORSTAT=$$PHSTAT(DFN,ORNUM)
"RTN","ORKPS1",82,0)
 ....Q:ORSTAT="DISCONTINUED"
"RTN","ORKPS1",83,0)
 ....;set info into order check array
"RTN","ORKPS1",84,0)
 ....S YY(II)="DI^"_ORSEV_U_ORNUM_U_ORDNAME_U_ORTXT_" - Monograph Available"_U_$G(@GL@(J,K,L,M,"INT"))
"RTN","ORKPS1",85,0)
 ....S II=II+1
"RTN","ORKPS1",86,0)
 Q
"RTN","ORKPS1",87,0)
 ;
"RTN","ORKPS1",88,0)
DD(TDATA,ORDPROSP) ;add duplicate drug checks
"RTN","ORKPS1",89,0)
 ;ORDPROSP: PERFORM PROSPECTIVE DRUG CHECK
"RTN","ORKPS1",90,0)
 ;          1 FOR YES
"RTN","ORKPS1",91,0)
 ;          0 FOR NO
"RTN","ORKPS1",92,0)
 S XX=0,ZZ=""
"RTN","ORKPS1",93,0)
 F  S XX=$O(^TMP($J,"DD",XX)) Q:XX<1  D
"RTN","ORKPS1",94,0)
 .N ORREM
"RTN","ORKPS1",95,0)
 .S ZZ=$G(^TMP($J,"DD",XX,0)),ORMTYPE=$P($P(ZZ,U,4),";",2)
"RTN","ORKPS1",96,0)
 .S ORREM=$P($P(ZZ,U,4),";") I (ORREM["Z"),$D(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM)) D
"RTN","ORKPS1",97,0)
 ..N ORTXT,ORREM1,ORREMSIG
"RTN","ORKPS1",98,0)
 ..S ORREM1=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM))
"RTN","ORKPS1",99,0)
 ..S ORREMSIG=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM,"SIG",0))
"RTN","ORKPS1",100,0)
 ..S ORTXT=" "_ORREMSIG_" ["_$P(ORREM1,U,4)_" -  Last Fill: "_$P(ORREM1,U,6)_"  Quantity Dispensed: "_$P(ORREM1,U,8)_"] >>"_$P(ORREM1,U)
"RTN","ORKPS1",101,0)
 ..S $P(ZZ,U,2)=$P(ZZ,U,2)_ORTXT
"RTN","ORKPS1",102,0)
 .I +ORDPROSP,$G(TDATA("NEW","PTYPE"))'=$G(ORMTYPE) Q
"RTN","ORKPS1",103,0)
 .S ORN=$P($P(ZZ,U,3),";"),ORZ=""
"RTN","ORKPS1",104,0)
 .I $L($G(ORN))>0,+$G(ORN)=+$G(ORIFN) Q  ;QUIT if dup med ord # = current ord #
"RTN","ORKPS1",105,0)
 .I +$G(ORIFN),+$G(ORN)=$P(^OR(100,+ORIFN,3),U,5) Q  ;QUIT if dup med ord # = the current order #'s REPLACED ORDER (changing an order)
"RTN","ORKPS1",106,0)
 .I +ORDPROSP,+$P(ORPROSP,U,2)'=+ZZ Q
"RTN","ORKPS1",107,0)
 .I $L(ORN),$D(^OR(100,ORN,8,0)) S ORZ=^OR(100,ORN,8,0)
"RTN","ORKPS1",108,0)
 .I $L($G(ORZ)),($P(^OR(100,ORN,8,$P(ORZ,U,3),0),U,2)="DC") Q
"RTN","ORKPS1",109,0)
 .I $L(ORN),$P(^ORD(100.01,$P(^OR(100,ORN,3),U,3),0),U)="DISCONTINUED" Q
"RTN","ORKPS1",110,0)
 .I ZZ'="" S YY(II)="DD^"_ZZ,II=II+1
"RTN","ORKPS1",111,0)
 .S ^TMP($J,"DD",XX,"OC")="" ;set this if this DD entry turned into an OC
"RTN","ORKPS1",112,0)
 Q
"RTN","ORKPS1",113,0)
 ;
"RTN","ORKPS1",114,0)
DT(TDATA) ;add duplicate therapy checks
"RTN","ORKPS1",115,0)
 N I
"RTN","ORKPS1",116,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","THERAPY"))
"RTN","ORKPS1",117,0)
 S I=0 F  S I=$O(@GL@(I)) Q:'I  D
"RTN","ORKPS1",118,0)
 .;get all drug names
"RTN","ORKPS1",119,0)
 .N ORDRUGS,ORCLASS,ORF,ORPROSCNT,ORPROFCNT,DRUGS,ORRETSTR S ORDRUGS="",ORCLASS="",ORF=0,ORPROSCNT=0,ORPROFCNT=0
"RTN","ORKPS1",120,0)
 .S J=0 F  S J=$O(@GL@(I,"DRUGS",J)) Q:'J  D
"RTN","ORKPS1",121,0)
 ..;keep count of PROSPECTIVE drugs
"RTN","ORKPS1",122,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4)=TDATA("NEW","PROSP") S ORF=1
"RTN","ORKPS1",123,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3)="PROSPECTIVE" D
"RTN","ORKPS1",124,0)
 ...S ORPROSCNT=1+$G(ORPROSCNT)
"RTN","ORKPS1",125,0)
 ...I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4)'=TDATA("NEW","PROSP") S ORDRUGS=ORDRUGS_$S($L(ORDRUGS):", ",1:"")_$P($G(@GL@(I,"DRUGS",J)),U,3)_" [UNRELEASED]",DRUGS($P($G(@GL@(I,"DRUGS",J)),U,3))=""
"RTN","ORKPS1",126,0)
 ..;-check each PROFILE drug to see if it is not the same order as the prospective (ORIFN)
"RTN","ORKPS1",127,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3)="PROFILE" D
"RTN","ORKPS1",128,0)
 ...;if not the same then set ORNUM=THE PROFILE DRUG "O;PSNUM"
"RTN","ORKPS1",129,0)
 ...I $P($P($G(@GL@(I,"DRUGS",J)),U),";",2)'=$G(^OR(100,+$G(ORIFN),4)) D
"RTN","ORKPS1",130,0)
 ....I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=$P($G(^OR(100,+$G(ORIFN),3)),U,5)) Q
"RTN","ORKPS1",131,0)
 ....I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=+$G(ORIFN)) Q
"RTN","ORKPS1",132,0)
 ....I $E($G(@GL@(I,"DRUGS",J)),1)="R" S $P(@GL@(I,"DRUGS",J),U,5)="O"
"RTN","ORKPS1",133,0)
 ....I $G(TDATA("NEW","PTYPE"))'=$P($G(@GL@(I,"DRUGS",J)),U,5) Q
"RTN","ORKPS1",134,0)
 ....S ORNUM=$P($P($G(@GL@(I,"DRUGS",J)),U),";",1,2)
"RTN","ORKPS1",135,0)
 ....S ORDRUGS=ORDRUGS_$S($L(ORDRUGS):", ",1:"")_$P($G(@GL@(I,"DRUGS",J)),U,3)_" ["_$$PHSTAT(DFN,ORNUM)_"]"
"RTN","ORKPS1",136,0)
 ....S DRUGS($P($G(@GL@(I,"DRUGS",J)),U,3))=$P($G(@GL@(I,"DRUGS",J)),U,4),ORPROFCNT=ORPROFCNT+1
"RTN","ORKPS1",137,0)
 .Q:'$$CHKDD(.DRUGS)
"RTN","ORKPS1",138,0)
 .;quit if ORNUM is not set and PROSPECTIVE count <=1
"RTN","ORKPS1",139,0)
 .Q:('$L($G(ORNUM))&(ORPROSCNT<2))
"RTN","ORKPS1",140,0)
 .;get all classes
"RTN","ORKPS1",141,0)
 .I ORF S J=0 F  S J=$O(@GL@(I,J)) Q:'J  D
"RTN","ORKPS1",142,0)
 ..S ORCLASS=ORCLASS_$S($L(ORCLASS):", ",1:"")_$G(@GL@(I,J,"CLASS"))
"RTN","ORKPS1",143,0)
 .;assemble return string ("DC"+ORNUM_U_Classes_U_Classes (drugs))
"RTN","ORKPS1",144,0)
 .S ORRETSTR="Duplicate Therapy: Order(s) exist for {"_ORDRUGS_"} in the same therapeutic categor(ies): "_ORCLASS
"RTN","ORKPS1",145,0)
 .I ORF S YY(II)="DC"_U_$G(ORNUM)_U_ORCLASS_U_ORRETSTR,II=II+1
"RTN","ORKPS1",146,0)
 Q
"RTN","ORKPS1",147,0)
 ;
"RTN","ORKPS1",148,0)
PHSTAT(DFN,ORNUM) ;get the status of the order
"RTN","ORKPS1",149,0)
 N RET,J,I
"RTN","ORKPS1",150,0)
 S RET=""
"RTN","ORKPS1",151,0)
 I $P(ORNUM,";")="P" S RET="PENDING"
"RTN","ORKPS1",152,0)
 I $P(ORNUM,";")="N" S RET="ACTIVE NON-VA"
"RTN","ORKPS1",153,0)
 I $P(ORNUM,";")="O" D
"RTN","ORKPS1",154,0)
 .K ^TMP($J,"OROCLST") D RX^PSO52API(DFN,"OROCLST",$P(ORNUM,";",2),,"ST")
"RTN","ORKPS1",155,0)
 .S RET=$P($G(^TMP($J,"OROCLST",DFN,$P(ORNUM,";",2),100)),U,2)
"RTN","ORKPS1",156,0)
 .K ^TMP($J,"OROCLST")
"RTN","ORKPS1",157,0)
 I $P(ORNUM,";")="I" D
"RTN","ORKPS1",158,0)
 .N ORLAST,ORPHNUM
"RTN","ORKPS1",159,0)
 .S ORLAST=$E(ORNUM,$L(ORNUM))
"RTN","ORKPS1",160,0)
 .I ORLAST="P" S RET="PENDING" Q
"RTN","ORKPS1",161,0)
 .S ORPHNUM=+$P(ORNUM,";",2)
"RTN","ORKPS1",162,0)
 .I ORLAST="U" D  Q
"RTN","ORKPS1",163,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS431^PSS55(DFN,ORPHNUM,"","","OR GET STATUS")
"RTN","ORKPS1",164,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,28)),U,2)
"RTN","ORKPS1",165,0)
 .I ORLAST="V" D  Q
"RTN","ORKPS1",166,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS436^PSS55(DFN,ORPHNUM,"OR GET STATUS")
"RTN","ORKPS1",167,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,100)),U,2)
"RTN","ORKPS1",168,0)
 I $P(ORNUM,";")="R" D
"RTN","ORKPS1",169,0)
 .N ORREMOTE S ORREMOTE=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",$P(ORNUM,";",2)))
"RTN","ORKPS1",170,0)
 .S RET=$P(ORREMOTE,U,4)_" >> "_$P(ORREMOTE,U)
"RTN","ORKPS1",171,0)
 I "^PENDING^NON-VERIFIED^NON VERIFIED^INCOMPLETE^DRUG INTERACTIONS^"[(U_RET_U) S RET="PENDING"
"RTN","ORKPS1",172,0)
 Q RET
"RTN","ORKPS1",173,0)
 ;
"RTN","ORKPS1",174,0)
CHKDD(DARRAY) ;check the duplicate drug OCs returned
"RTN","ORKPS1",175,0)
 ;if all drugs in DARRAY are already displayed in a DD OC then don't show the DT OC (return 0)
"RTN","ORKPS1",176,0)
 ;check the ^TMP($J,"DD",I,"OC") node to see if the DD entry turned into an OC
"RTN","ORKPS1",177,0)
 N I S I=0 F  S I=$O(^TMP($J,"DD",I)) Q:'I  D
"RTN","ORKPS1",178,0)
 .I $D(DARRAY($P($G(^TMP($J,"DD",I,0)),U,2))),$D(^TMP($J,"DD",I,"OC")) D
"RTN","ORKPS1",179,0)
 ..K DARRAY($P($G(^TMP($J,"DD",I,0)),U,2))
"RTN","ORKPS1",180,0)
 .N J S J=0 F  S J=$O(DARRAY(J)) Q:'$L(J)  D
"RTN","ORKPS1",181,0)
 ..I DARRAY(J)=$P($G(^TMP($J,"DD",I,0)),U,3),($L(DARRAY(J))>0) D
"RTN","ORKPS1",182,0)
 ...K DARRAY(J)
"RTN","ORKPS1",183,0)
 Q $D(DARRAY)
"RTN","ORKPS1",184,0)
 ;
"RTN","OROCAPI1")
0^12^B44544805
"RTN","OROCAPI1",1,0)
OROCAPI1 ; JMH - ORDER CHECK INSTANCES File APIs;8/24/07 ;09/14/11  08:26
"RTN","OROCAPI1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**293,346,345**;Dec 17, 1997;Build 32
"RTN","OROCAPI1",3,0)
SAVEOC(ORL,RET) ;SAVE A GROUP OF ORDER CHECKS
"RTN","OROCAPI1",4,0)
 ;ORL=LIST OF ORDER CHECKS
"RTN","OROCAPI1",5,0)
 ;(D0,1)=ORDER NUMBER (FILE 100)^
"RTN","OROCAPI1",6,0)
 ;       OCCURANCE DESCRIPTOR^
"RTN","OROCAPI1",7,0)
 ;       USER (FILE 200)^
"RTN","OROCAPI1",8,0)
 ;       OCCURANCE D/T^
"RTN","OROCAPI1",9,0)
 ;       ORDER CHECK NUMBER (FILE 100.8)^
"RTN","OROCAPI1",10,0)
 ;       CLINICAL DANGER LEVEL
"RTN","OROCAPI1",11,0)
 ;   (D0,2)=ORDER CHECK NARRATIVE
"RTN","OROCAPI1",12,0)
 ;   (D0,3)=OVERRIDE REASON
"RTN","OROCAPI1",13,0)
 ;RET=RETURN ARRAY OF IENS BY ORL(D0)
"RTN","OROCAPI1",14,0)
 ;    RET(D0,IEN)=""
"RTN","OROCAPI1",15,0)
 N I S I=0 F  S I=$O(ORL(I)) Q:'I  D
"RTN","OROCAPI1",16,0)
 .N DA,DR,DIC,X,Y,DIE,ORSTATUS,ORN,ORDANG,DW,DV,%,D,DC,DE,DH,DI,DIEL,DIFLD,DIP,DK,DM,DP,DQ
"RTN","OROCAPI1",17,0)
 .S ORN=+ORL(I,1)
"RTN","OROCAPI1",18,0)
 .Q:'ORN!('$D(^OR(100,ORN)))
"RTN","OROCAPI1",19,0)
 .Q:'$P(ORL(I,1),U,5)  ;QUIT IF NO ORDER CHECK NUMBER
"RTN","OROCAPI1",20,0)
 .Q:'$L($G(ORL(I,2)))  ;QUIT IF NO ORDER CHECK TEXT
"RTN","OROCAPI1",21,0)
 .N ORFDART,ORIENRT,ORMSGRT
"RTN","OROCAPI1",22,0)
 .K ^TMP("DIERR",$J)
"RTN","OROCAPI1",23,0)
 .S ORFDART(100.05,"+1,",.01)=ORN
"RTN","OROCAPI1",24,0)
 .D UPDATE^DIE("","ORFDART","ORIENRT","ORMSGRT")
"RTN","OROCAPI1",25,0)
 .I $D(ORIENRT(1)) S DA=ORIENRT(1)
"RTN","OROCAPI1",26,0)
 .I $D(ORMSGRT) D
"RTN","OROCAPI1",27,0)
 .K ^TMP("DIERR",$J)
"RTN","OROCAPI1",28,0)
 .Q:'$G(DA)
"RTN","OROCAPI1",29,0)
 .S RET(I,DA)=""
"RTN","OROCAPI1",30,0)
 .S DIC="^ORD(100.05,",DIC(0)="F",X=ORN
"RTN","OROCAPI1",31,0)
 .S DIE=DIC,ORSTATUS=$P($G(^OR(100,ORN,3)),U,3),ORDANG=$S($P($G(ORL(I,1)),U,6):$P($G(ORL(I,1)),U,6),1:$$GET^XPAR("ALL","ORK CLINICAL DANGER LEVEL",$P($G(ORL(I,1)),U,5),"I"))
"RTN","OROCAPI1",32,0)
 .S DR="1////"_ORSTATUS_";2////"_$P($G(ORL(I,1)),U,2)_";3////"_$P($G(ORL(I,1)),U,3)_";4////"_$P($G(ORL(I,1)),U,4)_";5////"_$P($G(ORL(I,1)),U,5)_";6////"_ORDANG_";8///"_$TR($G(ORL(I,2)),";",",")_";7///"_$TR($G(ORL(I,3)),";",",")
"RTN","OROCAPI1",33,0)
 .D ^DIE
"RTN","OROCAPI1",34,0)
 .;set ^ORD(100.05,DA,2) if ORL(DO,2,1) exists
"RTN","OROCAPI1",35,0)
 .I $D(ORL(I,2))=11 N J S J=0 F  S J=$O(ORL(I,2,J)) Q:'J  S ^ORD(100.05,DA,2,J+1,0)=ORL(I,2,J)
"RTN","OROCAPI1",36,0)
 Q
"RTN","OROCAPI1",37,0)
GETOC1(IEN,RET) ;GET A SINGLE ORDER CHECK
"RTN","OROCAPI1",38,0)
    ;IEN = 100.05 IEN
"RTN","OROCAPI1",39,0)
    ;RET = RETURNED 100.05 DATA FOR IEN
"RTN","OROCAPI1",40,0)
    K RET
"RTN","OROCAPI1",41,0)
    Q:'$G(IEN)
"RTN","OROCAPI1",42,0)
    Q:'$D(^ORD(100.05,IEN))
"RTN","OROCAPI1",43,0)
    S RET(IEN,0)=$G(^ORD(100.05,IEN,0))
"RTN","OROCAPI1",44,0)
    S RET(IEN,1)=$G(^ORD(100.05,IEN,1))
"RTN","OROCAPI1",45,0)
    M RET(IEN,"OC")=^ORD(100.05,IEN,2)
"RTN","OROCAPI1",46,0)
    K RET(IEN,"OC",0)
"RTN","OROCAPI1",47,0)
    M RET(IEN,"OR")=^ORD(100.05,IEN,3)
"RTN","OROCAPI1",48,0)
    K RET(IEN,"OR",0)
"RTN","OROCAPI1",49,0)
    Q
"RTN","OROCAPI1",50,0)
GETOC2(ORD,RET) ;GET ALL 100.05 IENS FOR A SPECIFIC ORDER
"RTN","OROCAPI1",51,0)
    ;ORD = 100 IEN
"RTN","OROCAPI1",52,0)
    ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",53,0)
    K RET
"RTN","OROCAPI1",54,0)
    Q:'$G(ORD)
"RTN","OROCAPI1",55,0)
    N I S I=0 F  S I=$O(^ORD(100.05,"B",ORD,I)) Q:'I  S RET(ORD,I)=""
"RTN","OROCAPI1",56,0)
    Q
"RTN","OROCAPI1",57,0)
GETOC3(ORD,OCC,RET) ;GET ALL 100.05 IENS FOR A SPECIFIC ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",58,0)
    ;ORD = 100 IEN
"RTN","OROCAPI1",59,0)
    ;OCC = OCCURANCE STRING
"RTN","OROCAPI1",60,0)
    ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",61,0)
    K RET
"RTN","OROCAPI1",62,0)
    Q:'$G(ORD)
"RTN","OROCAPI1",63,0)
    Q:'$L(OCC)
"RTN","OROCAPI1",64,0)
    N I S I=0 F  S I=$O(^ORD(100.05,"C",ORD,OCC,I)) Q:'I  S RET(ORD,I)=""
"RTN","OROCAPI1",65,0)
    Q
"RTN","OROCAPI1",66,0)
GETOC4(ORD,RET) ;GET DATA FOR ALL 100.05 RECORDS OF A SPECIFIC ORDER
"RTN","OROCAPI1",67,0)
 ;ORD = 100 IEN
"RTN","OROCAPI1",68,0)
 ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",69,0)
 K RET
"RTN","OROCAPI1",70,0)
 Q:'$G(ORD)
"RTN","OROCAPI1",71,0)
 N RET2
"RTN","OROCAPI1",72,0)
 D GETOC2(ORD,.RET)
"RTN","OROCAPI1",73,0)
 Q:'$D(RET)
"RTN","OROCAPI1",74,0)
 N I S I=0 F  S I=$O(RET(ORD,I)) Q:'I  D
"RTN","OROCAPI1",75,0)
 .D GETOC1(I,.RET2)
"RTN","OROCAPI1",76,0)
 .M RET(ORD,"DATA")=RET2
"RTN","OROCAPI1",77,0)
 Q
"RTN","OROCAPI1",78,0)
GETOC5(ORD,OCC,RET) ;GET DATA FOR ALL 100.05 RECORDS OF A SPECIFIC ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",79,0)
 ;ORD = 100 IEN
"RTN","OROCAPI1",80,0)
 ;OCC = OCCURANCE STRING
"RTN","OROCAPI1",81,0)
 ;RET = LIST OF 100.05 IENS WITH DATA
"RTN","OROCAPI1",82,0)
 K RET
"RTN","OROCAPI1",83,0)
 Q:'$G(ORD)
"RTN","OROCAPI1",84,0)
 Q:'$L(OCC)
"RTN","OROCAPI1",85,0)
 N RET2
"RTN","OROCAPI1",86,0)
 D GETOC3(ORD,OCC,.RET)
"RTN","OROCAPI1",87,0)
 Q:'$D(RET)
"RTN","OROCAPI1",88,0)
 N I S I=0 F  S I=$O(RET(ORD,I)) Q:'I  D
"RTN","OROCAPI1",89,0)
 .D GETOC1(I,.RET2)
"RTN","OROCAPI1",90,0)
 .M RET(ORD,"DATA")=RET2
"RTN","OROCAPI1",91,0)
 Q
"RTN","OROCAPI1",92,0)
CONVERT ;CONVERT EXISTING FILE 100 NODE 9 ENTRIES OVER TO FILE 100.05
"RTN","OROCAPI1",93,0)
 N I,J,ORK,DESC
"RTN","OROCAPI1",94,0)
 S I=0
"RTN","OROCAPI1",95,0)
 I $G(^XTMP("ORK FILE CONVERSION")) S I=+^XTMP("ORK FILE CONVERSION")
"RTN","OROCAPI1",96,0)
 F  S I=$O(^OR(100,I)) Q:'I  I $D(^OR(100,I,9)) I '$D(^ORD(100.05,"B",I)) D CONVERT1(I)
"RTN","OROCAPI1",97,0)
 S I=0
"RTN","OROCAPI1",98,0)
 F  S I=$O(^XTMP("ORK FILE CONVERSION","ERRORS",I)) Q:'I  D DELETE(I)
"RTN","OROCAPI1",99,0)
 K ^XTMP("ORK FILE CONVERSION","LAST ERRORS")
"RTN","OROCAPI1",100,0)
 M ^XTMP("ORK FILE CONVERSION","LAST ERRORS")=^XTMP("ORK FILE CONVERSION","ERRORS")
"RTN","OROCAPI1",101,0)
 K ^XTMP("ORK FILE CONVERSION","ERRORS")
"RTN","OROCAPI1",102,0)
 S ^XTMP("ORK FILE CONVERSION")=0
"RTN","OROCAPI1",103,0)
 D MAIL
"RTN","OROCAPI1",104,0)
 Q
"RTN","OROCAPI1",105,0)
CONVERT1(I) ;CONVERT EXISTING FILE 100 NODE 9 ENTRIES OVER TO FILE 100.05 FOR 1 ORDER
"RTN","OROCAPI1",106,0)
 N $ETRAP,$ESTACK
"RTN","OROCAPI1",107,0)
 S $ETRAP="D ERR^OROCAPI1 Q"
"RTN","OROCAPI1",108,0)
 N J,ORK,DESC,RET
"RTN","OROCAPI1",109,0)
 S DESC="SIGNATURE_CPRS"
"RTN","OROCAPI1",110,0)
 S ^XTMP("ORK FILE CONVERSION",0)=$$FMADD^XLFDT($$NOW^XLFDT,90)_U_$$NOW^XLFDT
"RTN","OROCAPI1",111,0)
 I ",11,13,14,"[(","_$P($G(^OR(100,I,3)),U,3)_",") S DESC="ACCEPTANCE_CPRS"
"RTN","OROCAPI1",112,0)
 S J=0 F  S J=$O(^OR(100,I,9,J)) Q:'J  D
"RTN","OROCAPI1",113,0)
 .N X0,X1 S X0=$G(^OR(100,I,9,J,0)),X1=$G(^OR(100,I,9,J,1))
"RTN","OROCAPI1",114,0)
 .N ORKDT S ORKDT=$S($P(X0,U,6):$P(X0,U,6),1:$P($G(^OR(100,I,0)),U,7))
"RTN","OROCAPI1",115,0)
 .S ORK(J,1)=I_U_DESC_U_$P(X0,U,5)_U_ORKDT_U_$P(X0,U)
"RTN","OROCAPI1",116,0)
 .S ORK(J,2)=X1
"RTN","OROCAPI1",117,0)
 .S ORK(J,3)=$P(X0,U,4)
"RTN","OROCAPI1",118,0)
 I $D(ORK) D SAVEOC^OROCAPI1(.ORK,.RET)
"RTN","OROCAPI1",119,0)
 S ^XTMP("ORK FILE CONVERSION")=I
"RTN","OROCAPI1",120,0)
 Q
"RTN","OROCAPI1",121,0)
COPY(ORD1,ORD2) ;COPY THE ORDER CHECKS FROM ORDER 1 TO ORDER 2
"RTN","OROCAPI1",122,0)
 N RET,ORK,I
"RTN","OROCAPI1",123,0)
 D GETOC4(ORD1,.RET) S I=0 F  S I=$O(RET(ORD1,"DATA",I)) Q:'I  D
"RTN","OROCAPI1",124,0)
 .S ORK(I,1)=ORD2_U_$P($G(RET(ORD1,"DATA",I,0)),U,3)_U_$P($G(RET(ORD1,"DATA",I,0)),U,4)_U_$P($G(RET(ORD1,"DATA",I,0)),U,5)_U_$P($G(RET(ORD1,"DATA",I,1)),U,1)
"RTN","OROCAPI1",125,0)
 .S ORK(I,2)=$G(RET(ORD1,"DATA",I,"OC",1,0))
"RTN","OROCAPI1",126,0)
 .S ORK(I,3)=$G(RET(ORD1,"DATA",I,"OR",1,0))
"RTN","OROCAPI1",127,0)
 D SAVEOC(.ORK)
"RTN","OROCAPI1",128,0)
 Q
"RTN","OROCAPI1",129,0)
OCCNT(ORD) ;RETURN 1 IF THERE ARE ORDER CHECKS AND 0 IF NOT
"RTN","OROCAPI1",130,0)
 N RET,Y D GETOC2(ORD,.RET)
"RTN","OROCAPI1",131,0)
 S Y=0 I $D(RET) S Y=1
"RTN","OROCAPI1",132,0)
 Q Y
"RTN","OROCAPI1",133,0)
DELETE(ORD) ;DELETE ALL OF THE OC INSTANCES FOR AN ORDER
"RTN","OROCAPI1",134,0)
 N RET,I,DIK,DA D GETOC2(ORD,.RET)
"RTN","OROCAPI1",135,0)
 S I=0 F  S I=$O(RET(ORD,I)) Q:'I  S DA=I,DIK="^ORD(100.05," D ^DIK
"RTN","OROCAPI1",136,0)
 Q
"RTN","OROCAPI1",137,0)
DELOCC(ORD,OCC) ;DELETE ALL OF THE OC INSTANCES FOR AN ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",138,0)
 N RET,I,DIK,DA D GETOC3(ORD,OCC,.RET)
"RTN","OROCAPI1",139,0)
 S I=0 F  S I=$O(RET(ORD,I)) Q:'I  S DA=I,DIK="^ORD(100.05," D ^DIK
"RTN","OROCAPI1",140,0)
 Q
"RTN","OROCAPI1",141,0)
ERR ;
"RTN","OROCAPI1",142,0)
 S ^XTMP("ORK FILE CONVERSION","ERRORS",ORN)=""
"RTN","OROCAPI1",143,0)
 S ^XTMP("ORK FILE CONVERSION")=ORN
"RTN","OROCAPI1",144,0)
 D UNWIND^%ZTER
"RTN","OROCAPI1",145,0)
 Q
"RTN","OROCAPI1",146,0)
MAIL ;send mail message to installer if any errors encountered during conversion process
"RTN","OROCAPI1",147,0)
 Q:'$D(^XTMP("ORK FILE CONVERSION","LAST ERRORS"))
"RTN","OROCAPI1",148,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,XMMG,ORTXT,I,J
"RTN","OROCAPI1",149,0)
 S XMDUZ="PATCH OR*3*293 ORDER CHECK CONVERSION" S:$G(DUZ) XMY(^XTMP("ORK FILE CONVERSION","INSTALLER"))=""
"RTN","OROCAPI1",150,0)
 S I=0,I=I+1,^TMP($J,"ORTXT",I)=""
"RTN","OROCAPI1",151,0)
 S I=I+1,^TMP($J,"ORTXT",I)="While converting order check information from file 100 node 9 over to file"
"RTN","OROCAPI1",152,0)
 S I=I+1,^TMP($J,"ORTXT",I)="100.05, data errors were discovered for the order numbers listed below."
"RTN","OROCAPI1",153,0)
 S I=I+1,^TMP($J,"ORTXT",I)="All other order data converted appropriately."
"RTN","OROCAPI1",154,0)
 S I=I+1,^TMP($J,"ORTXT",I)="We recommend correcting the data, and then re-running the"
"RTN","OROCAPI1",155,0)
 S I=I+1,^TMP($J,"ORTXT",I)="conversion utility from programmer prompt as follows:"
"RTN","OROCAPI1",156,0)
 S I=I+1,^TMP($J,"ORTXT",I)="    D CONVERT^OROCAPI1"
"RTN","OROCAPI1",157,0)
 S I=I+1,^TMP($J,"ORTXT",I)="NOTE: re-running the conversion utility will only convert those orders that"
"RTN","OROCAPI1",158,0)
 S I=I+1,^TMP($J,"ORTXT",I)="did not convert properly the first time."
"RTN","OROCAPI1",159,0)
 S I=I+1,^TMP($J,"ORTXT",I)=""
"RTN","OROCAPI1",160,0)
 S I=I+1,^TMP($J,"ORTXT",I)="LIST OF ORDERS WITH CORRUPTED ORDER CHECK DATA"
"RTN","OROCAPI1",161,0)
 S I=I+1,^TMP($J,"ORTXT",I)="=============================================="
"RTN","OROCAPI1",162,0)
 S J=0 F  S J=$O(^XTMP("ORK FILE CONVERSION","LAST ERRORS",J)) Q:'J  S I=I+1,^TMP($J,"ORTXT",I)=J
"RTN","OROCAPI1",163,0)
 S XMTEXT="^TMP($J,""ORTXT"",",XMSUB="PATCH OR*3*293 CONVERSION ERRORS!"
"RTN","OROCAPI1",164,0)
 D ^XMD
"RTN","OROCAPI1",165,0)
 Q
"RTN","ORRDI2")
0^7^B31690107
"RTN","ORRDI2",1,0)
ORRDI2 ; SLC/JMH - RDI routine for user interface and data cleanup; 3/24/05 2:31 ;02/08/12  08:36
"RTN","ORRDI2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**232,294,345**;Dec 17, 1997;Build 32
"RTN","ORRDI2",3,0)
 ;
"RTN","ORRDI2",4,0)
SET ;utility to set RDI related parameters
"RTN","ORRDI2",5,0)
 I '$$PATCH^XPDUTL("OR*3.0*238") D  Q
"RTN","ORRDI2",6,0)
 . W !,"This menu is locked until patch OR*3.0*238 is installed."
"RTN","ORRDI2",7,0)
 N QUIT,QUITALL
"RTN","ORRDI2",8,0)
 W !!,"Sets System wide parameters to control order checking against"
"RTN","ORRDI2",9,0)
 W !,"  remote data",!
"RTN","ORRDI2",10,0)
 F  Q:$G(QUIT)!($G(QUITALL))  D
"RTN","ORRDI2",11,0)
 . N VAL,VALEXT,DIR,DTOUT,Y
"RTN","ORRDI2",12,0)
 . S VAL=$$GET^XPAR("SYS","OR RDI HAVE HDR")
"RTN","ORRDI2",13,0)
 . S VALEXT="NO" I VAL=1 S VALEXT="YES"
"RTN","ORRDI2",14,0)
 . S DIR("A")="HAVE AN HDR"
"RTN","ORRDI2",15,0)
 . S DIR("B")=VALEXT
"RTN","ORRDI2",16,0)
 . S DIR("?")="^D HELP1^ORRDI2"
"RTN","ORRDI2",17,0)
 . S DIR(0)="Y"
"RTN","ORRDI2",18,0)
 . D ^DIR
"RTN","ORRDI2",19,0)
 . I $G(Y)="^"!($G(DTOUT)) S QUITALL=1
"RTN","ORRDI2",20,0)
 . I $G(Y)=1!($G(Y)=0) S QUIT=1 D
"RTN","ORRDI2",21,0)
 . . D EN^XPAR("SYS","OR RDI HAVE HDR",,Y)
"RTN","ORRDI2",22,0)
 I $G(QUITALL) Q
"RTN","ORRDI2",23,0)
 I '$$GET^XPAR("SYS","OR RDI HAVE HDR") Q
"RTN","ORRDI2",24,0)
 S QUIT=0
"RTN","ORRDI2",25,0)
 F  Q:$G(QUIT)!($G(QUITALL))  D
"RTN","ORRDI2",26,0)
 . N VAL,VALEXT,DIR,DTOUT,Y
"RTN","ORRDI2",27,0)
 . S VAL=$$GET^XPAR("SYS","OR RDI CACHE TIME")
"RTN","ORRDI2",28,0)
 . S VALEXT=$G(VAL,0)
"RTN","ORRDI2",29,0)
 . S DIR("A")="CACHE TIME (Minutes)"
"RTN","ORRDI2",30,0)
 . S DIR("B")=VALEXT
"RTN","ORRDI2",31,0)
 . S DIR("?")="^D HELP3^ORRDI2"
"RTN","ORRDI2",32,0)
 . S DIR(0)="N^0:9999:0"
"RTN","ORRDI2",33,0)
 . D ^DIR
"RTN","ORRDI2",34,0)
 . I $G(Y)="^"!($G(DTOUT)) S QUITALL=1
"RTN","ORRDI2",35,0)
 . I $G(Y)>-1 S QUIT=1 D
"RTN","ORRDI2",36,0)
 . . D EN^XPAR("SYS","OR RDI CACHE TIME",,Y)
"RTN","ORRDI2",37,0)
 Q
"RTN","ORRDI2",38,0)
HELP1 ;
"RTN","ORRDI2",39,0)
 W "Set this to ""YES"" if this system has an HDR system that"
"RTN","ORRDI2",40,0)
 W !,"  it uses to access remote data."
"RTN","ORRDI2",41,0)
 Q
"RTN","ORRDI2",42,0)
HELP3 ;
"RTN","ORRDI2",43,0)
 W "Set this to the number of minutes that the retrieved data is "
"RTN","ORRDI2",44,0)
 W !,"  to be considered valid for order checking purposes."
"RTN","ORRDI2",45,0)
 Q
"RTN","ORRDI2",46,0)
LIST ;
"RTN","ORRDI2",47,0)
 W !
"RTN","ORRDI2",48,0)
 W $$GET^XPAR("SYS","OR RDI HAVE HDR")," "
"RTN","ORRDI2",49,0)
 W $$GET^XPAR("SYS","OR RDI CACHE TIME")
"RTN","ORRDI2",50,0)
 Q
"RTN","ORRDI2",51,0)
CLEANUP ;
"RTN","ORRDI2",52,0)
 N VAL,NOW,THRESH,DOM,DFN,TIME
"RTN","ORRDI2",53,0)
 S VAL=$$GET^XPAR("SYS","OR RDI CACHE TIME")
"RTN","ORRDI2",54,0)
 S NOW=$$NOW^XLFDT
"RTN","ORRDI2",55,0)
 S THRESH=$$FMADD^XLFDT(NOW,,,-VAL)
"RTN","ORRDI2",56,0)
 S DFN=0
"RTN","ORRDI2",57,0)
 F DOM="PSOO","ART" F  S DFN=$O(^XTMP("ORRDI",DOM,DFN)) Q:'DFN  D
"RTN","ORRDI2",58,0)
 . S TIME=$G(^XTMP("ORRDI",DOM,DFN,0))
"RTN","ORRDI2",59,0)
 . I TIME<THRESH K ^XTMP("ORRDI",DOM,DFN)
"RTN","ORRDI2",60,0)
 ;clear out metrics data older than 5 days
"RTN","ORRDI2",61,0)
 N ORDT,ORDIFF S ORDT=0
"RTN","ORRDI2",62,0)
 F  S ORDT=$O(^XTMP("ORRDI","METRICS",ORDT)) Q:'ORDT  S ORDIFF=$$FMDIFF^XLFDT($$NOW^XLFDT,ORDT,1) Q:ORDIFF<5  K ^XTMP("ORRDI","METRICS",ORDT)
"RTN","ORRDI2",63,0)
 ; checking if OUTAGE task crashed or hasn't completed successfully
"RTN","ORRDI2",64,0)
 I $$DOWNXVAL D
"RTN","ORRDI2",65,0)
 .I $$FMDIFF^XLFDT($$NOW^XLFDT,$$PINGXVAL,2)>($$PINGPVAL*2) D SPAWN^ORRDI2
"RTN","ORRDI2",66,0)
 Q
"RTN","ORRDI2",67,0)
DOWNRPC(ORY) ;can be used in an RPC to check if RDI is in an OUTAGE state (HDR DOWN)
"RTN","ORRDI2",68,0)
 S ORY=$$DOWNXVAL
"RTN","ORRDI2",69,0)
 Q
"RTN","ORRDI2",70,0)
DICNPVAL() ;parameter value for dummy patient ICN
"RTN","ORRDI2",71,0)
 Q $$GET^XPAR("ALL","ORRDI DUMMY ICN")
"RTN","ORRDI2",72,0)
FAILPVAL() ;parameter value for failure threshold
"RTN","ORRDI2",73,0)
 Q $$GET^XPAR("ALL","ORRDI FAIL THRESH")
"RTN","ORRDI2",74,0)
SUCCPVAL() ;parameter value for success threshold
"RTN","ORRDI2",75,0)
 Q $$GET^XPAR("ALL","ORRDI SUCCEED THRESH")
"RTN","ORRDI2",76,0)
PINGPVAL() ;parameter value for ping frequency
"RTN","ORRDI2",77,0)
 Q $$GET^XPAR("ALL","ORRDI PING FREQ")
"RTN","ORRDI2",78,0)
DOWNXVAL() ;xtmp value for OUTAGE state
"RTN","ORRDI2",79,0)
 Q $G(^XTMP("ORRDI","OUTAGE INFO","DOWN"))
"RTN","ORRDI2",80,0)
FAILXVAL() ;xtmp value for number of failed reads
"RTN","ORRDI2",81,0)
 Q $G(^XTMP("ORRDI","OUTAGE INFO","FAILURES"))
"RTN","ORRDI2",82,0)
SUCCXVAL() ;xtmp value for number of successful reads
"RTN","ORRDI2",83,0)
 Q $G(^XTMP("ORRDI","OUTAGE INFO","SUCCEEDS"))
"RTN","ORRDI2",84,0)
PINGXVAL() ;xtmp value for last ping time
"RTN","ORRDI2",85,0)
 Q $G(^XTMP("ORRDI","OUTAGE INFO","DOWN","LAST PING"))
"RTN","ORRDI2",86,0)
LDPTTVAL(DFN) ;tmp value for if the local data only message has been shown to the user during ordering session
"RTN","ORRDI2",87,0)
 Q $G(^TMP($J,"ORRDI",DFN))
"RTN","ORRDI2",88,0)
SPAWN ;subroutine to spawn the DOWNTSK task
"RTN","ORRDI2",89,0)
 K ^XTMP("ORRDI","ART"),^XTMP("ORRDI","PSOO")
"RTN","ORRDI2",90,0)
 N ZTDESC,ZTRTN,ZTSAVE,ZTIO,ZTSK,ZTDTH
"RTN","ORRDI2",91,0)
 S ZTDESC="RDI TASK TO CHECK IF HDR IS UP"
"RTN","ORRDI2",92,0)
 S ZTRTN="DOWNTSK^ORRDI2"
"RTN","ORRDI2",93,0)
 S ZTIO="NULL"
"RTN","ORRDI2",94,0)
 S ZTDTH=$$NOW^XLFDT+.000001
"RTN","ORRDI2",95,0)
 D ^%ZTLOAD
"RTN","ORRDI2",96,0)
 Q
"RTN","ORRDI2",97,0)
DOWNTSK ;subroutine to check if HDR is back up
"RTN","ORRDI2",98,0)
 N ORLE S ORLE=0
"RTN","ORRDI2",99,0)
 S ^XTMP("ORRDI","OUTAGE LOG",$$NOW^XLFDT)="GOING DOWN"
"RTN","ORRDI2",100,0)
 F  Q:(($$SUCCXVAL'<$$SUCCPVAL)!('$$DOWNXVAL))  D
"RTN","ORRDI2",101,0)
 .N WAIT,RSLT
"RTN","ORRDI2",102,0)
 .S WAIT=$$FMDIFF^XLFDT($$NOW^XLFDT,$$PINGXVAL,2)
"RTN","ORRDI2",103,0)
 .S WAIT=$$PINGPVAL-WAIT
"RTN","ORRDI2",104,0)
 .;wait until the proper # of seconds has expired before retrying
"RTN","ORRDI2",105,0)
 .I WAIT>0 H WAIT
"RTN","ORRDI2",106,0)
 .S ^XTMP("ORRDI","OUTAGE INFO","DOWN","LAST PING")=$$NOW^XLFDT
"RTN","ORRDI2",107,0)
 .;send dummy message
"RTN","ORRDI2",108,0)
 .S RSLT=$$TESTCALL
"RTN","ORRDI2",109,0)
 .;if successful increment success counter
"RTN","ORRDI2",110,0)
 .I RSLT=1 S ^XTMP("ORRDI","OUTAGE INFO","SUCCEEDS")=1+$$SUCCXVAL
"RTN","ORRDI2",111,0)
 .;if failure set success counter to 0
"RTN","ORRDI2",112,0)
 .I RSLT'=1 S ^XTMP("ORRDI","OUTAGE INFO","SUCCEEDS")=0
"RTN","ORRDI2",113,0)
 K ^XTMP("ORRDI","OUTAGE INFO")
"RTN","ORRDI2",114,0)
 S ^XTMP("ORRDI","OUTAGE LOG",$$NOW^XLFDT)="BACK UP"
"RTN","ORRDI2",115,0)
 Q
"RTN","ORRDI2",116,0)
TCOLD() ;call to send a test call to CDS...returns 1 if successful, 0 OR -9 if not
"RTN","ORRDI2",117,0)
 N ORREQ,ORXML,ORRET,XML,ORERR
"RTN","ORRDI2",118,0)
 S ORREQ="/isAlive"
"RTN","ORRDI2",119,0)
 S ORXML=$$GETREST^XOBWLIB("CDS WEB SERVICE","CDS SERVER")
"RTN","ORRDI2",120,0)
 S ORRET=$$GET^XOBWLIB(ORXML,ORREQ,.ORERR,1)
"RTN","ORRDI2",121,0)
 I 'ORRET Q 0
"RTN","ORRDI2",122,0)
 While (ORXML.HttpResponse.Data.AtEnd = 0) {S XML=ORXML.HttpResponse.Data.Read(100)}
"RTN","ORRDI2",123,0)
 Q:XML="true" 1
"RTN","ORRDI2",124,0)
 Q 0
"RTN","ORRDI2",125,0)
TESTCALL() ;call to send a test call to CDS...returns 1 if successful, 0 or -9 if not
"RTN","ORRDI2",126,0)
 N ORREQ,ORXML,ORRET,ORERR ;;CHANGE add ORERR to NEW list
"RTN","ORRDI2",127,0)
 N $ETRAP,$ESTACK SET $ETRAP="DO ERRH^ORRDI2" ;;CHANGE set error trap
"RTN","ORRDI2",128,0)
 I $L($G(^XTMP("ORRDI","TESTREQ")))'>0 Q $$TCOLD() ;USES isAlive IF NO TEST REQUEST IS PRESENT
"RTN","ORRDI2",129,0)
 S ORREQ=$G(^XTMP("ORRDI","TESTREQ"))
"RTN","ORRDI2",130,0)
 S ORXML=$$GETREST^XOBWLIB("CDS WEB SERVICE","CDS SERVER")
"RTN","ORRDI2",131,0)
 S ORRET=$$GET^XOBWLIB(ORXML,ORREQ,.ORERR,1) ;;CHANGE change force error to 1
"RTN","ORRDI2",132,0)
 I 'ORRET Q 0
"RTN","ORRDI2",133,0)
 K ^TMP($J,"ORRDI")
"RTN","ORRDI2",134,0)
 D PARSE^ORRDI1(ORXML.HttpResponse.Data)
"RTN","ORRDI2",135,0)
 I $L($$MSGERR^ORRDI1)>0 K ^TMP($J,"ORRDI") Q 0
"RTN","ORRDI2",136,0)
 K ^TMP($J,"ORRDI")
"RTN","ORRDI2",137,0)
 Q 1
"RTN","ORRDI2",138,0)
ERRH  ; error handler for TESTCALL/TCOLD
"RTN","ORRDI2",139,0)
 SET:'$DATA(ORERR) ORERR=$$EOFAC^XOBWLIB() ; create error object if needed
"RTN","ORRDI2",140,0)
 IF '+$GET(ZTSK) DO ERRDISP^XOBWLIB(.ORERR) W !! ;non-task: interactive error display
"RTN","ORRDI2",141,0)
 ;ELSE  I $G(ORLE)#15=0 DO ZTER^XOBWLIB(ORERR) ; tasked: expand into XOBEOARR, store in error log
"RTN","ORRDI2",142,0)
 S ORLE=$G(ORLE)+1
"RTN","ORRDI2",143,0)
 DO UNWIND^%ZTER ; throw to MenuMan, TaskMan or next higher error handler
"RTN","ORRDI2",144,0)
 QUIT
"RTN","ORWDXC")
0^3^B66801106
"RTN","ORWDXC",1,0)
ORWDXC ; SLC/KCM - Utilities for Order Checking ;07/24/12  08:32
"RTN","ORWDXC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,141,221,243,280,346,345**;Dec 17, 1997;Build 32
"RTN","ORWDXC",3,0)
 ;
"RTN","ORWDXC",4,0)
ON(VAL) ; returns E if order checking enabled, otherwise D
"RTN","ORWDXC",5,0)
 S VAL=$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")
"RTN","ORWDXC",6,0)
 Q
"RTN","ORWDXC",7,0)
FILLID(VAL,DLG) ; Return the FillerID (namespace) for a dialog
"RTN","ORWDXC",8,0)
 N DGRP
"RTN","ORWDXC",9,0)
 S VAL="",DGRP=$P($G(^ORD(101.41,DLG,0)),U,5) Q:'DGRP
"RTN","ORWDXC",10,0)
 S DLG=$$DEFDLG^ORWDXQ(DGRP)
"RTN","ORWDXC",11,0)
 S VAL=$P($G(^ORD(101.41,DLG,0)),U,7),VAL=$$NMSP^ORCD(VAL)
"RTN","ORWDXC",12,0)
 I VAL="PS" D
"RTN","ORWDXC",13,0)
 . N X
"RTN","ORWDXC",14,0)
 . S X=$P($P($G(^ORD(100.98,DGRP,0)),U,3)," ")
"RTN","ORWDXC",15,0)
 . I $L(X) S VAL="PS"_$S(X="UD":"I",1:X)
"RTN","ORWDXC",16,0)
 Q
"RTN","ORWDXC",17,0)
DISPLAY(LST,DFN,FID) ; Return list of Order Checks for a FillerID (namespace)
"RTN","ORWDXC",18,0)
 N I,ORX,ORY
"RTN","ORWDXC",19,0)
 S ORX=1,ORX(1)="|"_FID
"RTN","ORWDXC",20,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"DISPLAY")
"RTN","ORWDXC",21,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  S LST(I)=$P(ORY(I),U,4)
"RTN","ORWDXC",22,0)
 Q
"RTN","ORWDXC",23,0)
ACCEPT(LST,DFN,FID,STRT,ORL,OIL,ORIFN,ORREN)    ; Return list of Order Checks on Accept Order
"RTN","ORWDXC",24,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",25,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",26,0)
 ; ORREN - IF ORREN IS SET TO 1 THEN ORIFN IS THE ORDER GETTING RENEWED
"RTN","ORWDXC",27,0)
 K ^TMP($J,"ORENHCHK")
"RTN","ORWDXC",28,0)
 N X,Y,USID,ORCHECK,ORI,ORX,ORY,%DT,ORDODSG
"RTN","ORWDXC",29,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",30,0)
 S ORL=ORL_";SC(",X=STRT,STRT="",ORDODSG=0
"RTN","ORWDXC",31,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",32,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",33,0)
 ; do the SELECT order checks
"RTN","ORWDXC",34,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",35,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",36,0)
 . S USID=$$USID(OIL(ORI))
"RTN","ORWDXC",37,0)
 . S OIL(ORI,"USID")=USID
"RTN","ORWDXC",38,0)
 . S ORX=ORX+1,ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_USID
"RTN","ORWDXC",39,0)
 . S:$P(OIL(ORI),U,2)="PSIV" $P(ORX(ORX),"|",7)=$P($P(OIL(ORI),U,3),";")
"RTN","ORWDXC",40,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"SELECT",.OIL,.ORDODSG)
"RTN","ORWDXC",41,0)
 I $D(ORY) D RETURN^ORCHECK ; expects ORY, ORCHECK
"RTN","ORWDXC",42,0)
 K ORX,ORY
"RTN","ORWDXC",43,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",44,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",45,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",46,0)
 . S ORX=ORX+1
"RTN","ORWDXC",47,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_OIL(ORI,"USID")_"|"_STRT
"RTN","ORWDXC",48,0)
 . S:$P(OIL(ORI),U,2)="LR" $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",49,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ACCEPT",.OIL,.ORDODSG)
"RTN","ORWDXC",50,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",51,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",52,0)
 D FDBDOWN^ORCHECK(0)
"RTN","ORWDXC",53,0)
 D OPOS(DFN)
"RTN","ORWDXC",54,0)
 D CHK2LST
"RTN","ORWDXC",55,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",56,0)
 Q
"RTN","ORWDXC",57,0)
DELAY(LST,DFN,FID,STRT,ORL,OIL) ; Return list of Order Checks on Accept Delayed
"RTN","ORWDXC",58,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",59,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",60,0)
 N X,Y,ORCHECK,ORI,ORX,ORY,%DT
"RTN","ORWDXC",61,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",62,0)
 S ORL=ORL_";SC(",X=STRT,STRT=""
"RTN","ORWDXC",63,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",64,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",65,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",66,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",67,0)
 . S ORX=ORX+1
"RTN","ORWDXC",68,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_$$USID(OIL(ORI))_"|"_STRT
"RTN","ORWDXC",69,0)
 . I $P(OIL(ORI),U,2)="LR" S $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",70,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ALL",.OIL)
"RTN","ORWDXC",71,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",72,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",73,0)
 D CHK2LST
"RTN","ORWDXC",74,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",75,0)
 Q
"RTN","ORWDXC",76,0)
SESSION(LST,ORVP,ORLST) ; Return list of Order Checks on Release Order
"RTN","ORWDXC",77,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",78,0)
 N ORES,ORCHECK
"RTN","ORWDXC",79,0)
 S ORVP=+ORVP_";DPT("
"RTN","ORWDXC",80,0)
 S I=0 F  S I=$O(ORLST(I)) Q:'I  D
"RTN","ORWDXC",81,0)
 . I +$P(ORLST(I),";",2)'=1 Q  ; order not new
"RTN","ORWDXC",82,0)
 . I $P(ORLST(I),U,3)="0" Q    ; order not being released
"RTN","ORWDXC",83,0)
 . S ORES($P(ORLST(I),U))=""
"RTN","ORWDXC",84,0)
 D SESSION^ORCHECK
"RTN","ORWDXC",85,0)
 D OPOS(+ORVP)
"RTN","ORWDXC",86,0)
 D CHK2LST
"RTN","ORWDXC",87,0)
 D CHECKIT(.LST)
"RTN","ORWDXC",88,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",89,0)
 Q
"RTN","ORWDXC",90,0)
SAVECHK(OK,ORVP,RSN,LST)    ; Save order checks for session
"RTN","ORWDXC",91,0)
 N ORCHECK,ORIFN S OK=1
"RTN","ORWDXC",92,0)
 D LST2CHK
"RTN","ORWDXC",93,0)
 I $L(RSN)>0 S ORCHECK("OK")=RSN
"RTN","ORWDXC",94,0)
 S ORIFN=0 F  S ORIFN=$O(ORCHECK(ORIFN)) Q:'ORIFN  D OC^ORCSAVE2
"RTN","ORWDXC",95,0)
 Q
"RTN","ORWDXC",96,0)
DELORD(OK,ORIFN)      ; Delete order
"RTN","ORWDXC",97,0)
 N STS,DIK,DA
"RTN","ORWDXC",98,0)
 S STS=$P(^OR(100,+ORIFN,8,1,0),U,15),OK=0
"RTN","ORWDXC",99,0)
 I (STS=10)!(STS=11) D  Q  ; makes sure it's an unreleased order
"RTN","ORWDXC",100,0)
 . S DA=+ORIFN,DIK="^OR(100," Q:'DA
"RTN","ORWDXC",101,0)
 . D ^DIK
"RTN","ORWDXC",102,0)
 . S OK=1
"RTN","ORWDXC",103,0)
 . D DELETE^OROCAPI1(+ORIFN)
"RTN","ORWDXC",104,0)
 Q
"RTN","ORWDXC",105,0)
USID(ORITMX) ; Return universal svc ID for an orderable item
"RTN","ORWDXC",106,0)
 ; ORITMX = OI^NMSP^PKGINFO
"RTN","ORWDXC",107,0)
 N RSLT,ORDRUG S RSLT=""
"RTN","ORWDXC",108,0)
 I $E($P(ORITMX,U,2),1,2)="PS" D
"RTN","ORWDXC",109,0)
 . I $P(ORITMX,U,2)="PSIV" D
"RTN","ORWDXC",110,0)
 . . N PSOI,TYPE,VOL S VOL=""
"RTN","ORWDXC",111,0)
 . . S PSOI=+$P($G(^ORD(101.43,+ORITMX,0)),U,2)
"RTN","ORWDXC",112,0)
 . . S TYPE=$P($P(ORITMX,U,3),";")
"RTN","ORWDXC",113,0)
 . . I TYPE="B" S VOL=$P($P(ORITMX,U,3),";",2)
"RTN","ORWDXC",114,0)
 . . D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORDRUG)
"RTN","ORWDXC",115,0)
 . . S ORDRUG=+ORDRUG
"RTN","ORWDXC",116,0)
 . E  S ORDRUG=+$P(ORITMX,U,3)
"RTN","ORWDXC",117,0)
 . S RSLT=$$ENDCM^PSJORUTL(ORDRUG)
"RTN","ORWDXC",118,0)
 . S RSLT=$P(RSLT,U,3)_"^^99NDF^"_ORDRUG_U_$$NAME50^ORPEAPI(ORDRUG)_"^99PSD"
"RTN","ORWDXC",119,0)
 E  S RSLT=$$USID^ORMBLD(+ORITMX)
"RTN","ORWDXC",120,0)
 I +$P(RSLT,U)=0,+($P(RSLT,U,4)=0) S RSLT="" ; has to be null (why?)
"RTN","ORWDXC",121,0)
 Q RSLT
"RTN","ORWDXC",122,0)
 ;
"RTN","ORWDXC",123,0)
CHK2LST ; creates list that can be passed to broker from ORCHECK array
"RTN","ORWDXC",124,0)
 ; expects ORCHECK to be present and populates LST
"RTN","ORWDXC",125,0)
 D REMDUPS ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",126,0)
 N ORIFN,ORID,CDL,I,ILST,LASTIFN,RESERVED,ORCHECK2,ORNUM,OLIST S ILST=0,LASTIFN=0,RESERVED=0,OLIST=0
"RTN","ORWDXC",127,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",128,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",129,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",130,0)
 . . . S ORCHECK2(ORIFN,CDL,+ORCHECK(ORIFN,CDL,I),I)=ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",131,0)
 K ORCHECK
"RTN","ORWDXC",132,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK2(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",133,0)
 . S CDL=0 F  S CDL=$O(ORCHECK2(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",134,0)
 . . S ORNUM=0 F  S ORNUM=$O(ORCHECK2(ORIFN,CDL,ORNUM)) Q:'ORNUM  D
"RTN","ORWDXC",135,0)
 . . . S I=0 F  S I=$O(ORCHECK2(ORIFN,CDL,ORNUM,I)) Q:'I  D
"RTN","ORWDXC",136,0)
 . . . . S OLIST=OLIST+1,ORCHECK(ORIFN,CDL,OLIST)=ORCHECK2(ORIFN,CDL,ORNUM,I)
"RTN","ORWDXC",137,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",138,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",139,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",140,0)
 . . . I LASTIFN'=ORIFN S LASTIFN=ORIFN,RESERVED=ILST+1,ILST=ILST+1 ; saves a spot for the RDI warning at the top of each order's checks
"RTN","ORWDXC",141,0)
 . . . S ORID=ORIFN I +ORID,(+ORID=ORID) S ORID=ORID_";1"
"RTN","ORWDXC",142,0)
 . . . I '$P(ORCHECK(ORIFN,CDL,I),U,2) Q  ; CDL="" means don't show
"RTN","ORWDXC",143,0)
 . . . I $P(ORCHECK(ORIFN,CDL,I),U,1)=99 S LST(RESERVED)=ORID_U_ORCHECK(ORIFN,CDL,I) Q  ;Put RDI warning at the top of each order's checks
"RTN","ORWDXC",144,0)
 . . . S ILST=ILST+1,LST(ILST)=ORID_U_ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",145,0)
 Q
"RTN","ORWDXC",146,0)
LST2CHK ; create ORCHECK array from list passed by broker
"RTN","ORWDXC",147,0)
 N ORIFN,CDL,I,ILST S I=0
"RTN","ORWDXC",148,0)
 S ILST="" F  S ILST=$O(LST("ORCHECKS",ILST)) Q:$L(ILST)'>0  D
"RTN","ORWDXC",149,0)
 . I $D(LST("ORCHECKS",ILST,0)) D
"RTN","ORWDXC",150,0)
 . . N J S J=0 S X=LST("ORCHECKS",ILST,J) F  S J=$O(LST("ORCHECKS",ILST,J)) Q:'J  S X=X_LST("ORCHECKS",ILST,J)
"RTN","ORWDXC",151,0)
 . I '$D(LST("ORCHECKS",ILST,0)) S X=LST("ORCHECKS",ILST)
"RTN","ORWDXC",152,0)
 . S ORIFN=$P(X,U),CDL=$P(X,U,3)
"RTN","ORWDXC",153,0)
 . I +$G(ORIFN)>0,+$G(CDL)>0 D  ;cla 12/16/03
"RTN","ORWDXC",154,0)
 . . S I=I+1,ORCHECK(+ORIFN,CDL,I)=$P(X,U,2,4)
"RTN","ORWDXC",155,0)
 Q
"RTN","ORWDXC",156,0)
CHECKIT(X) ;remove uncessesary duplication of Duplicate Therapy checks
"RTN","ORWDXC",157,0)
 N I,J,Y
"RTN","ORWDXC",158,0)
 S I=0 F  S I=$O(X(I)) Q:'I  I $P(X(I),U,2)=17 D
"RTN","ORWDXC",159,0)
 .Q:$P($G(^ORD(100.8,17,0)),U)'="DUPLICATE DRUG THERAPY"
"RTN","ORWDXC",160,0)
 .N STR S STR=$P($P(X(I),"{",2),"}")
"RTN","ORWDXC",161,0)
 .S J=0 F  S J=J+1 Q:J>$L(STR,", ")  S Y(+X(I),I,J)=$P(STR,", ",J)
"RTN","ORWDXC",162,0)
 S I=0 F  S I=$O(Y(I)) Q:'I  D
"RTN","ORWDXC",163,0)
 .S J=0 F  S J=$O(Y(I,J)) Q:'J  D
"RTN","ORWDXC",164,0)
 ..S K=J F  S K=$O(Y(I,K)) Q:'K  D
"RTN","ORWDXC",165,0)
 ...N A,B M A=Y(I,J),B=Y(I,K)
"RTN","ORWDXC",166,0)
 ...I $$AINB(.A,.B) K X(J)
"RTN","ORWDXC",167,0)
 ...I $$AINB(.B,.A) K X(K)
"RTN","ORWDXC",168,0)
 Q
"RTN","ORWDXC",169,0)
AINB(A,B) ;if array A is a subset of array B then return 1, else return 0
"RTN","ORWDXC",170,0)
 N I,RET
"RTN","ORWDXC",171,0)
 S RET=1
"RTN","ORWDXC",172,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I '$$XINA(A(I),.B) S RET=0 Q
"RTN","ORWDXC",173,0)
 Q RET
"RTN","ORWDXC",174,0)
XINA(X,A) ;if string X is an entry in array A then return 1, else return 0
"RTN","ORWDXC",175,0)
 N I,RET
"RTN","ORWDXC",176,0)
 S RET=0
"RTN","ORWDXC",177,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I X=A(I) S RET=1 Q
"RTN","ORWDXC",178,0)
 Q RET
"RTN","ORWDXC",179,0)
REMDUPS ;
"RTN","ORWDXC",180,0)
 N IFN,CDL,I,J,CDL2 S IFN="NEW"
"RTN","ORWDXC",181,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",182,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",183,0)
 .. S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORWDXC",184,0)
 ... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORWDXC",185,0)
 .... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",186,0)
 .... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORWDXC",187,0)
 .. I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",188,0)
 Q
"RTN","ORWDXC",189,0)
REMDUPSX ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",190,0)
 N IFN,CDL,I S IFN="NEW"
"RTN","ORWDXC",191,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",192,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",193,0)
 . . S J=I F  S J=$O(ORCHECK(IFN,CDL,J)) Q:'J  I $G(ORCHECK(IFN,CDL,I))=$G(ORCHECK(IFN,CDL,J)) K ORCHECK(IFN,CDL,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",194,0)
 Q
"RTN","ORWDXC",195,0)
OPOS(DFN) ;handles saving and removing order checks that should only be displayed once per cprs session
"RTN","ORWDXC",196,0)
 ; expects ORCHECK
"RTN","ORWDXC",197,0)
 ; sets these order checks into the "Once Per cprs Session" global ^TMP($J,"OC-OPOS",DFN)
"RTN","ORWDXC",198,0)
 N I,J,K
"RTN","ORWDXC",199,0)
 S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORWDXC",200,0)
 .S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORWDXC",201,0)
 ..S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORWDXC",202,0)
 ...N ORTXT,ORTXT0,ORTXTI,ORXTRAI
"RTN","ORWDXC",203,0)
 ...S ORTXTO="These checks could not be completed for this patient:"
"RTN","ORWDXC",204,0)
 ...Q:(ORCHECK(I,J,K)'[ORTXTO)
"RTN","ORWDXC",205,0)
 ...S ORTXT=ORTXTO
"RTN","ORWDXC",206,0)
 ...S ORXTRAI=$P($P(ORCHECK(I,J,K),"||",2),"&")
"RTN","ORWDXC",207,0)
 ...S ORTXTI=0 F  S ORTXTI=$O(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))  Q:'ORTXTI  D
"RTN","ORWDXC",208,0)
 ....S ORTXT=ORTXT_$G(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))
"RTN","ORWDXC",209,0)
 ...I $D(^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))) K ORCHECK(I,J,K) Q
"RTN","ORWDXC",210,0)
 ...S ^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))="" Q
"RTN","ORWDXC",211,0)
 Q
"RTN","ORWDXR01")
0^5^B28161629
"RTN","ORWDXR01",1,0)
ORWDXR01 ;SLC/JDL - Utilities for Order Actions ;09/06/12  13:01
"RTN","ORWDXR01",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**187,190,195,215,280,243,345**;Dec 17, 1997;Build 32
"RTN","ORWDXR01",3,0)
CANCHG(ORY,ORIFN,TXTOD) ;
"RTN","ORWDXR01",4,0)
 ;If it's an pending or unsigned unreleased renewed order, can edit=True
"RTN","ORWDXR01",5,0)
 S ORY=0
"RTN","ORWDXR01",6,0)
 Q:'$D(^OR(100,+ORIFN,0))
"RTN","ORWDXR01",7,0)
 I TXTOD D TXTCAN(.ORY) Q
"RTN","ORWDXR01",8,0)
 N OUTGRP,URELSTS,USIGSTS,RNTYPE,PDSTS
"RTN","ORWDXR01",9,0)
 N ODGRP,ODREL,ODSIG,ODTYPE,LSTACT
"RTN","ORWDXR01",10,0)
 S OUTGRP=$O(^ORD(100.98,"B","O RX",0))
"RTN","ORWDXR01",11,0)
 S URELSTS=$O(^ORD(100.01,"B","UNRELEASED",0))
"RTN","ORWDXR01",12,0)
 S PDSTS=$O(^ORD(100.01,"B","PENDING",0))
"RTN","ORWDXR01",13,0)
 S USIGSTS=2 ; unsigned order
"RTN","ORWDXR01",14,0)
 S RNTYPE=2 ; renew action
"RTN","ORWDXR01",15,0)
 ;Data from the order entry
"RTN","ORWDXR01",16,0)
 S LSTACT=$P($G(^OR(100,+ORIFN,3)),U,7)
"RTN","ORWDXR01",17,0)
 S ODGRP=$P($G(^OR(100,+ORIFN,0)),U,11)
"RTN","ORWDXR01",18,0)
 S ODREL=$P($G(^OR(100,+ORIFN,3)),U,3)
"RTN","ORWDXR01",19,0)
 S ODSIG=$P($G(^OR(100,+ORIFN,8,LSTACT,0)),U,4)
"RTN","ORWDXR01",20,0)
 S ODTYPE=$P($G(^OR(100,+ORIFN,3)),U,11)
"RTN","ORWDXR01",21,0)
 I (ODGRP=OUTGRP),(ODREL=URELSTS),(ODSIG=USIGSTS),(ODTYPE=RNTYPE) S ORY=1
"RTN","ORWDXR01",22,0)
 Q
"RTN","ORWDXR01",23,0)
 ;
"RTN","ORWDXR01",24,0)
TXTCAN(ORY) ;
"RTN","ORWDXR01",25,0)
 ;if it's an unsigned unreleased renewed text order, can change=true
"RTN","ORWDXR01",26,0)
 N URELSTS,USIGSTS,RNTYPE
"RTN","ORWDXR01",27,0)
 N ODREL,ODSIG,ODTYPE,LSTACT
"RTN","ORWDXR01",28,0)
 S URELSTS=$O(^ORD(100.01,"B","UNRELEASED",0))
"RTN","ORWDXR01",29,0)
 S USIGSTS=2 ; unsigned order
"RTN","ORWDXR01",30,0)
 S RNTYPE=2 ; renew action
"RTN","ORWDXR01",31,0)
 ;Data from the order entry
"RTN","ORWDXR01",32,0)
 S LSTACT=$P($G(^OR(100,+ORIFN,3)),U,7)
"RTN","ORWDXR01",33,0)
 S ODREL=$P($G(^OR(100,+ORIFN,8,LSTACT,0)),U,15)
"RTN","ORWDXR01",34,0)
 S ODSIG=$P($G(^OR(100,+ORIFN,8,LSTACT,0)),U,4)
"RTN","ORWDXR01",35,0)
 S ODTYPE=$P($G(^OR(100,+ORIFN,3)),U,11)
"RTN","ORWDXR01",36,0)
 I (ODREL=URELSTS),(ODSIG=USIGSTS),(ODTYPE=RNTYPE) S ORY=1
"RTN","ORWDXR01",37,0)
 Q
"RTN","ORWDXR01",38,0)
 ;
"RTN","ORWDXR01",39,0)
SAVCHG(ORY,ORID,PARM1,PARM2,TXTOD) ;
"RTN","ORWDXR01",40,0)
 ;save new changes on the unreleased unsigned renewed order
"RTN","ORWDXR01",41,0)
 Q:'$D(^OR(100,+ORID,0))
"RTN","ORWDXR01",42,0)
 ;Update new start and stop date the text order
"RTN","ORWDXR01",43,0)
 I TXTOD D TXTSAV(.ORY,ORID,PARM1,PARM2) Q
"RTN","ORWDXR01",44,0)
 ;Update new refills and pickup for the med order
"RTN","ORWDXR01",45,0)
 N REFID,PICKID,ACT,IX,TXT,REFPOS,NDQUIT
"RTN","ORWDXR01",46,0)
 S (REFID,PICKID,ACT,REFPOS,NDQUIT)=0,ORY=""
"RTN","ORWDXR01",47,0)
 S ACT=+$P(ORID,";",2) S:ACT'>0 ACT=1
"RTN","ORWDXR01",48,0)
 S REFID=$O(^OR(100,+ORID,4.5,"ID","REFILLS",0))
"RTN","ORWDXR01",49,0)
 S PICKID=$O(^OR(100,+ORID,4.5,"ID","PICKUP",0))
"RTN","ORWDXR01",50,0)
 S:$D(^OR(100,+ORID,4.5,REFID,1)) ^(1)=PARM1
"RTN","ORWDXR01",51,0)
 S:$D(^OR(100,+ORID,4.5,PICKID,1)) ^(1)=PARM2
"RTN","ORWDXR01",52,0)
 S IX=0 F  S IX=$O(^OR(100,+ORID,8,ACT,.1,IX)) Q:('IX)!(NDQUIT)  D
"RTN","ORWDXR01",53,0)
 . S TXT=$G(^OR(100,+ORID,8,ACT,.1,IX,0))
"RTN","ORWDXR01",54,0)
 . I ($$UP^XLFSTR(TXT)["QUANTITY:"),($$UP^XLFSTR(TXT)["REFILLS:") D
"RTN","ORWDXR01",55,0)
 . . S REFPOS=$F($$UP^XLFSTR(TXT),"REFILLS")-$L("REFILLS")-1
"RTN","ORWDXR01",56,0)
 . . S TXT=$E(TXT,1,REFPOS)_"Refills: "_PARM1
"RTN","ORWDXR01",57,0)
 . . S ^OR(100,+ORID,8,ACT,.1,IX,0)=TXT,NDQUIT=1 Q
"RTN","ORWDXR01",58,0)
 D GETBYIFN^ORWORR(.ORY,+ORID)
"RTN","ORWDXR01",59,0)
 Q
"RTN","ORWDXR01",60,0)
 ;
"RTN","ORWDXR01",61,0)
TXTSAV(ORY,ORID,PARM1,PARM2) ;
"RTN","ORWDXR01",62,0)
 ; Update new start and stop date for the unsigned unreleased
"RTN","ORWDXR01",63,0)
 ; renewed text order
"RTN","ORWDXR01",64,0)
 N STRTID,STOPID
"RTN","ORWDXR01",65,0)
 S STRTID=$O(^OR(100,+ORID,4.5,"ID","START",0))
"RTN","ORWDXR01",66,0)
 S STOPID=$O(^OR(100,+ORID,4.5,"ID","STOP",0))
"RTN","ORWDXR01",67,0)
 S:$D(^OR(100,+ORID,4.5,STRTID,1)) ^(1)=PARM1
"RTN","ORWDXR01",68,0)
 S:$D(^OR(100,+ORID,4.5,STOPID,1)) ^(1)=PARM2
"RTN","ORWDXR01",69,0)
 D GETBYIFN^ORWORR(.ORY,+ORID)
"RTN","ORWDXR01",70,0)
 Q
"RTN","ORWDXR01",71,0)
 ;
"RTN","ORWDXR01",72,0)
ISSPLY(ORY,DLGID,QODLG) ;
"RTN","ORWDXR01",73,0)
 ; ORY=1: is "PSO SUPPLY" dialog
"RTN","ORWDXR01",74,0)
 S ORY=""
"RTN","ORWDXR01",75,0)
 Q:'$D(^ORD(101.41,DLGID,0))
"RTN","ORWDXR01",76,0)
 I 'QODLG,($P(^ORD(101.41,DLGID,0),U)="PSO SUPPLY") S ORY=1
"RTN","ORWDXR01",77,0)
 I QODLG D
"RTN","ORWDXR01",78,0)
 . N SPLYDG S SPLYDG=$O(^ORD(100.98,"B","SPLY",0))
"RTN","ORWDXR01",79,0)
 . I $P(^ORD(101.41,DLGID,0),U,5)=SPLYDG S ORY=1
"RTN","ORWDXR01",80,0)
 Q
"RTN","ORWDXR01",81,0)
 ;
"RTN","ORWDXR01",82,0)
OXDATA(ORY,ORIEN) ; Return orderable item data for order check usage
"RTN","ORWDXR01",83,0)
 Q:'$D(^OR(100,+ORIEN,0))
"RTN","ORWDXR01",84,0)
 D MAYBEIV(.ORY,ORIEN,1) I $L($G(ORY))>1 Q
"RTN","ORWDXR01",85,0)
 N DRUGID,OIID,IDX,IDY,DISPIN,DISPOUT,DISPID
"RTN","ORWDXR01",86,0)
 S (DRUGID,OIID,IDX,IDY,DISPIN,DISPOUT)=0
"RTN","ORWDXR01",87,0)
 S DISPID=""
"RTN","ORWDXR01",88,0)
 S DISPIN=$O(^ORD(100.98,"B","UD RX",0))
"RTN","ORWDXR01",89,0)
 S DISPOUT=$O(^ORD(100.98,"B","O RX",0))
"RTN","ORWDXR01",90,0)
 N DISPCM S DISPCM=$O(^ORD(100.98,"B","CLINIC ORDERS",0))
"RTN","ORWDXR01",91,0)
 S DRUGID=$O(^OR(100,+ORIEN,4.5,"ID","DRUG",0))
"RTN","ORWDXR01",92,0)
 S OIID=$O(^OR(100,+ORIEN,4.5,"ID","ORDERABLE",0))
"RTN","ORWDXR01",93,0)
 S DISPID=$P(^OR(100,+ORIEN,0),U,11)
"RTN","ORWDXR01",94,0)
 I DISPID=DISPIN S DISPID="PSI"
"RTN","ORWDXR01",95,0)
 I DISPID=DISPOUT S DISPID="PSO"
"RTN","ORWDXR01",96,0)
 I DISPID=DISPCM S DISPID="PSI"
"RTN","ORWDXR01",97,0)
 I (DISPID'="PSI"),(DISPID'="PSO") Q
"RTN","ORWDXR01",98,0)
 I 'DRUGID,DISPID="PSI" D
"RTN","ORWDXR01",99,0)
 .N ORCHI S ORCHI=0 F  S ORCHI=$O(^OR(100,+ORIEN,2,ORCHI)) Q:'ORCHI  D
"RTN","ORWDXR01",100,0)
 ..N ORCHDRID,ORCHOIID,ORCHIDX,ORCHIDY
"RTN","ORWDXR01",101,0)
 ..S ORCHDRID=$O(^OR(100,+ORCHI,4.5,"ID","DRUG",0))
"RTN","ORWDXR01",102,0)
 ..S ORCHOIID=$O(^OR(100,+ORCHI,4.5,"ID","ORDERABLE",0))
"RTN","ORWDXR01",103,0)
 ..Q:'ORCHDRID
"RTN","ORWDXR01",104,0)
 ..Q:'ORCHOIID
"RTN","ORWDXR01",105,0)
 ..S ORCHIDX=$O(^OR(100,+ORCHI,4.5,ORCHDRID,0))
"RTN","ORWDXR01",106,0)
 ..S ORCHIDY=$O(^OR(100,+ORCHI,4.5,ORCHOIID,0))
"RTN","ORWDXR01",107,0)
 ..I ORCHIDX,ORCHIDY S ORY=$G(^OR(100,+ORCHI,4.5,ORCHOIID,ORCHIDY))_U_DISPID_U_$G(^OR(100,+ORCHI,4.5,ORCHDRID,ORCHIDX))_"|"_$G(ORY)
"RTN","ORWDXR01",108,0)
 Q:'DRUGID
"RTN","ORWDXR01",109,0)
 Q:'OIID
"RTN","ORWDXR01",110,0)
 S IDX=$O(^OR(100,+ORIEN,4.5,DRUGID,0))
"RTN","ORWDXR01",111,0)
 S IDY=$O(^OR(100,+ORIEN,4.5,OIID,0))
"RTN","ORWDXR01",112,0)
 I IDX,IDY,'+DISPID S ORY=$G(^OR(100,+ORIEN,4.5,OIID,IDY))_U_DISPID_U_$G(^OR(100,+ORIEN,4.5,DRUGID,IDX))
"RTN","ORWDXR01",113,0)
 Q
"RTN","ORWDXR01",114,0)
 ;
"RTN","ORWDXR01",115,0)
MAYBEIV(ORY,ORIEN,FORMAT) ; Return orderable item data for iv order check usage
"RTN","ORWDXR01",116,0)
 ;PARAMETERS: ORY   => REFERENCE TO ARRAY THAT STORES ORDERABLE ITEM DATA
"RTN","ORWDXR01",117,0)
 ;            ORIEN => ORDER NUMBER FROM ORDER FILE (#100)
"RTN","ORWDXR01",118,0)
 ;            FORMAT => FLAG DENOTING WHICH FORMAT TO RETURN THE DATA IN:
"RTN","ORWDXR01",119,0)
 ;                      NULL OR ZERO - NEW FORMAT (USING PIPE DELMITER)
"RTN","ORWDXR01",120,0)
 ;                      1 - OLD FORMAT (USING CAROT DELIMITER)
"RTN","ORWDXR01",121,0)
 N X0,ORDIALOG,DELIMIT
"RTN","ORWDXR01",122,0)
 S DELIMIT=$S($G(FORMAT):"|",1:U)
"RTN","ORWDXR01",123,0)
 S X0=^OR(100,+ORIEN,0)
"RTN","ORWDXR01",124,0)
 S ORDIALOG=+$P(X0,U,5)
"RTN","ORWDXR01",125,0)
 D GETDLG^ORCD(ORDIALOG)
"RTN","ORWDXR01",126,0)
 D GETORDER^ORCD(+ORIEN)
"RTN","ORWDXR01",127,0)
 I $D(ORDIALOG("B","SOLUTION")) D
"RTN","ORWDXR01",128,0)
 .N ORI,ORSUB
"RTN","ORWDXR01",129,0)
 .S ORSUB=$P(ORDIALOG("B","SOLUTION"),U,2)
"RTN","ORWDXR01",130,0)
 .S ORI=0 F  S ORI=$O(ORDIALOG(ORSUB,ORI)) Q:'ORI  D
"RTN","ORWDXR01",131,0)
 ..S:DELIMIT="|" ORY=$G(ORY)_"|"_$G(ORDIALOG(ORSUB,ORI))_U_"PSIV"_U_"B;"
"RTN","ORWDXR01",132,0)
 ..S:DELIMIT=U ORY=$G(ORY)_U_$G(ORDIALOG(ORSUB,ORI))_"|"_"PSIV"_"|"_ORSUB_"||"_ORIEN_"||"_"B"
"RTN","ORWDXR01",133,0)
 I $D(ORDIALOG("B","ADDITIVE")) D
"RTN","ORWDXR01",134,0)
 .N ORI,ORSUB
"RTN","ORWDXR01",135,0)
 .S ORSUB=$P(ORDIALOG("B","ADDITIVE"),U,2)
"RTN","ORWDXR01",136,0)
 .S ORI=0 F  S ORI=$O(ORDIALOG(ORSUB,ORI)) Q:'ORI  D
"RTN","ORWDXR01",137,0)
 ..S:DELIMIT="|" ORY=$G(ORY)_"|"_$G(ORDIALOG(ORSUB,ORI))_U_"PSIV"_U_"A"
"RTN","ORWDXR01",138,0)
 ..S:DELIMIT=U ORY=$G(ORY)_U_$G(ORDIALOG(ORSUB,ORI))_"|"_"PSIV"_"|"_ORSUB_"||"_ORIEN_"||"_"A"
"RTN","ORWDXR01",139,0)
 I $L($G(ORY),DELIMIT)>1 S ORY=$P(ORY,DELIMIT,2,$L(ORY,DELIMIT))
"RTN","ORWDXR01",140,0)
 Q
"RTN","ORWDXR01",141,0)
 ;
"VER")
8.0^22.0
**END**
**END**

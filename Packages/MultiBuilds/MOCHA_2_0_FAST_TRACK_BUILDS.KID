KIDS Distribution saved on Feb 12, 2014@15:39:13
MOCHA 2.0 FAST TRACK BUILDS
**KIDS**:MOCHA 2.0 FAST TRACK BUILDS 1.0^PSJ*5.0*299^PSO*7.0*431^

**INSTALL NAME**
MOCHA 2.0 FAST TRACK BUILDS 1.0
"BLD",8838,0)
MOCHA 2.0 FAST TRACK BUILDS 1.0^^1^3140212^y
"BLD",8838,6.3)
2
"BLD",8838,10,0)
^9.63^2^2
"BLD",8838,10,1,0)
PSJ*5.0*299^1
"BLD",8838,10,2,0)
PSO*7.0*431^1
"BLD",8838,10,"B","PSJ*5.0*299",1)

"BLD",8838,10,"B","PSO*7.0*431",2)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"VER")
8.0^22.0
**INSTALL NAME**
PSJ*5.0*299
"BLD",8628,0)
PSJ*5.0*299^INPATIENT MEDICATIONS^0^3140212^y
"BLD",8628,4,0)
^9.64PA^^
"BLD",8628,6.3)
11
"BLD",8628,"INID")
^n
"BLD",8628,"INIT")
PSJ299PO
"BLD",8628,"KRN",0)
^9.67PA^779.2^20
"BLD",8628,"KRN",.4,0)
.4
"BLD",8628,"KRN",.401,0)
.401
"BLD",8628,"KRN",.402,0)
.402
"BLD",8628,"KRN",.403,0)
.403
"BLD",8628,"KRN",.5,0)
.5
"BLD",8628,"KRN",.84,0)
.84
"BLD",8628,"KRN",3.6,0)
3.6
"BLD",8628,"KRN",3.8,0)
3.8
"BLD",8628,"KRN",9.2,0)
9.2
"BLD",8628,"KRN",9.8,0)
9.8
"BLD",8628,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",8628,"KRN",9.8,"NM",1,0)
PSJBLDOC^^0^B54439928
"BLD",8628,"KRN",9.8,"NM",2,0)
PSJCLNOC^^0^B86092468
"BLD",8628,"KRN",9.8,"NM",3,0)
PSJIMO1^^0^B65823354
"BLD",8628,"KRN",9.8,"NM",4,0)
PSJO1^^0^B46556084
"BLD",8628,"KRN",9.8,"NM",5,0)
PSGOEC^^0^B75500256
"BLD",8628,"KRN",9.8,"NM",6,0)
PSJ299PO^^0^B12136182
"BLD",8628,"KRN",9.8,"NM",7,0)
PSJLIACT^^0^B51186933
"BLD",8628,"KRN",9.8,"NM",8,0)
PSIVORFB^^0^B84688439
"BLD",8628,"KRN",9.8,"NM",9,0)
PSIVORA^^0^B29175721
"BLD",8628,"KRN",9.8,"NM",10,0)
PSJHL6^^0^B32286288
"BLD",8628,"KRN",9.8,"NM","B","PSGOEC",5)

"BLD",8628,"KRN",9.8,"NM","B","PSIVORA",9)

"BLD",8628,"KRN",9.8,"NM","B","PSIVORFB",8)

"BLD",8628,"KRN",9.8,"NM","B","PSJ299PO",6)

"BLD",8628,"KRN",9.8,"NM","B","PSJBLDOC",1)

"BLD",8628,"KRN",9.8,"NM","B","PSJCLNOC",2)

"BLD",8628,"KRN",9.8,"NM","B","PSJHL6",10)

"BLD",8628,"KRN",9.8,"NM","B","PSJIMO1",3)

"BLD",8628,"KRN",9.8,"NM","B","PSJLIACT",7)

"BLD",8628,"KRN",9.8,"NM","B","PSJO1",4)

"BLD",8628,"KRN",19,0)
19
"BLD",8628,"KRN",19.1,0)
19.1
"BLD",8628,"KRN",101,0)
101
"BLD",8628,"KRN",409.61,0)
409.61
"BLD",8628,"KRN",771,0)
771
"BLD",8628,"KRN",779.2,0)
779.2
"BLD",8628,"KRN",870,0)
870
"BLD",8628,"KRN",8989.51,0)
8989.51
"BLD",8628,"KRN",8989.52,0)
8989.52
"BLD",8628,"KRN",8994,0)
8994
"BLD",8628,"KRN","B",.4,.4)

"BLD",8628,"KRN","B",.401,.401)

"BLD",8628,"KRN","B",.402,.402)

"BLD",8628,"KRN","B",.403,.403)

"BLD",8628,"KRN","B",.5,.5)

"BLD",8628,"KRN","B",.84,.84)

"BLD",8628,"KRN","B",3.6,3.6)

"BLD",8628,"KRN","B",3.8,3.8)

"BLD",8628,"KRN","B",9.2,9.2)

"BLD",8628,"KRN","B",9.8,9.8)

"BLD",8628,"KRN","B",19,19)

"BLD",8628,"KRN","B",19.1,19.1)

"BLD",8628,"KRN","B",101,101)

"BLD",8628,"KRN","B",409.61,409.61)

"BLD",8628,"KRN","B",771,771)

"BLD",8628,"KRN","B",779.2,779.2)

"BLD",8628,"KRN","B",870,870)

"BLD",8628,"KRN","B",8989.51,8989.51)

"BLD",8628,"KRN","B",8989.52,8989.52)

"BLD",8628,"KRN","B",8994,8994)

"BLD",8628,"QUES",0)
^9.62^^
"BLD",8628,"REQB",0)
^9.611^2^2
"BLD",8628,"REQB",1,0)
PSJ*5.0*257^2
"BLD",8628,"REQB",2,0)
PSJ*5.0*270^2
"BLD",8628,"REQB","B","PSJ*5.0*257",1)

"BLD",8628,"REQB","B","PSJ*5.0*270",2)

"INIT")
PSJ299PO
"MBREQ")
1
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
299^3140212^10000000068
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","PSGOEC")
0^5^B75500256
"RTN","PSGOEC",1,0)
PSGOEC ;BIR/CML3-CANCEL ORDERS ;02 Mar 99 / 9:29 AM
"RTN","PSGOEC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**23,58,110,175,201,134,181,260,288,257,299**;16 DEC 97;Build 11
"RTN","PSGOEC",3,0)
 ;
"RTN","PSGOEC",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSGOEC",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789.
"RTN","PSGOEC",6,0)
 ; 
"RTN","PSGOEC",7,0)
ENA ; all orders
"RTN","PSGOEC",8,0)
 D ENCV^PSGSETU Q:$D(XQUIT)  S CF=$P(PSJSYSP0,U,5) N ND,ND1 S ND="$D(^PS(55,PSGP,5,PSGDA,4)),$P(^(4),U,12),$P(^(4),U,13)",ND1="$D(^PS(53.1,PSGDA,4)),$P(^(4),U,12),$P(^(4),U,13)"
"RTN","PSGOEC",9,0)
 F  W !!,"Do you want to ",$S(CF:"discontinue",1:"mark for discontinuation")," all of this patient's orders" S %=1 D YN^DICN Q:%  D ENCAM^PSGOEM
"RTN","PSGOEC",10,0)
 S PSGCF=0 Q:%<0  S PSGCF=1,T=$E("T",'PSJSYSU) G:%=1 ENCA F T=0:0 S T=$O(^PS(55,PSGP,5,"AUS",T)) Q:'T  F PSGDA=0:0 S PSGDA=$O(^PS(55,PSGP,5,"AUS",T,PSGDA)) Q:'PSGDA  I @ND Q
"RTN","PSGOEC",11,0)
 E  F PSGDA=0:0 S PSGDA=$O(^PS(53.1,"AC",PSGP,PSGDA)) Q:'PSGDA  I @ND1 Q
"RTN","PSGOEC",12,0)
 E  G DONE
"RTN","PSGOEC",13,0)
 W !!,"SOME OR ALL OF THESE ORDERS HAVE" D ENUMK^PSGOEM Q:%'=1
"RTN","PSGOEC",14,0)
 W !!,"...a few moments, please..." S PSGAL("C")=PSJSYSU*10+21400
"RTN","PSGOEC",15,0)
 F T=PSGDT:0 S T=$O(^PS(55,PSGP,5,"AUS",T)) Q:'T  F PSGDA=0:0 S PSGDA=$O(^PS(55,PSGP,5,"AUS",T,PSGDA)) Q:'PSGDA  I @ND W "." D RS,^PSGAL5
"RTN","PSGOEC",16,0)
 F PSGDA=0:0 S PSGDA=$O(^PS(53.1,"AC",PSGP,PSGDA)) Q:'PSGDA  I @ND1 W "." D RS
"RTN","PSGOEC",17,0)
 W " . . . DONE!" G DONE
"RTN","PSGOEC",18,0)
ENCA ;
"RTN","PSGOEC",19,0)
 D NOW^%DTC S (Q1,PSGDT)=+$E(%,1,12) F  S Q1=$O(^PS(55,PSGP,5,"AUS",Q1)) Q:'Q1  F Q2=0:0 S Q2=$O(^PS(55,PSGP,5,"AUS",Q1,Q2)) Q:'Q2  I $P($G(^PS(55,PSGP,5,Q2,0)),"^",21) Q
"RTN","PSGOEC",20,0)
 E  F Q2=0:0 S Q2=$O(^PS(53.1,"AC",PSGP,Q2)) Q:'Q2  I $P($G(^PS(53.1,Q2,0)),U,21) Q
"RTN","PSGOEC",21,0)
 I  S PSJNOO=$$ENNOO^PSJUTL5("D") I PSJNOO<0!('$$REQPROV) D  G DONE
"RTN","PSGOEC",22,0)
 .W !!,$C(7),"No changes made to this order." D PAUSE^VALM1
"RTN","PSGOEC",23,0)
 S PSGALR=$S('$D(PSGALO):20,PSGALO?4N&($E(PSGALO)=1):10,1:20) I $P(PSJSYSP0,U,5) D ENHE^PSJADT0 S PSGOP=PSGP D ASET
"RTN","PSGOEC",24,0)
 F SD=PSGDT:0 S SD=$O(^PS(55,PSGP,5,"AUS",SD)) Q:'SD  F PSGORD=0:0 S PSGORD=$O(^PS(55,PSGP,5,"AUS",SD,PSGORD)) Q:'PSGORD  S PSGORD=+PSGORD_"A" D AC
"RTN","PSGOEC",25,0)
 D NSET S CF=$P(PSJSYSP0,U,5) F PSGORD=0:0 S PSGORD=$O(^PS(53.1,"AC",PSGP,PSGORD)) Q:'PSGORD  S PSGORD=+PSGORD_"N" D NC
"RTN","PSGOEC",26,0)
 W " . . . DONE!" K PSGORD G DONE
"RTN","PSGOEC",27,0)
ENO(PSGP,PSGORD) ; single order
"RTN","PSGOEC",28,0)
 I PSGSTAT="D" W !,"This order has already been DISCONTINUED." D PAUSE^VALM1 Q
"RTN","PSGOEC",29,0)
 S CF=$S($P(PSJSYSP0,U,5):1,PSGORD["U":0,1:($P($G(^PS(53.1,+PSGORD,0)),U,25)=""&($P($G(^(4)),U,7)=DUZ)))
"RTN","PSGOEC",30,0)
 S PSJCOM=+$S(PSGORD["U":$P($G(^PS(55,PSGP,5,+PSGORD,.2)),"^",8),1:$P($G(^PS(53.1,+PSGORD,.2)),"^",8))
"RTN","PSGOEC",31,0)
 I 'CF,PSJCOM W !!,"This order is part of a complex order and CANNOT be marked for discontinuation." Q
"RTN","PSGOEC",32,0)
 I $$PNDRNOK(PSGORD) N PSJDCTYP S PSJDCTYP=$$PNDRNA(PSGORD) D:(PSJDCTYP=1!(PSJDCTYP=2)) PNDRN($G(PSJDCTYP),PSGORD) G DONE
"RTN","PSGOEC",33,0)
 ;I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSGORD)
"RTN","PSGOEC",34,0)
 ;F  W !!,"Do you want to ",$S(PSJCOM:"discontinue this series of complex orders",CF:"discontinue this order",1:"mark this order for discontinuation") S %=$S($G(PSJOCFLG):2,1:1) D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSGOEC",35,0)
 ;I %<0 S VALMBCK="" Q
"RTN","PSGOEC",36,0)
 I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSGORD)
"RTN","PSGOEC",37,0)
 I PSJCOM F  W !!,"Do you want to discontinue this series of complex orders" S %=$S($G(PSJOCFLG):2,1:1) D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSGOEC",38,0)
 I 'PSJCOM,CF,'$D(PSJDCDTF) F  W !!,"Do you want to discontinue this order" S %=$S($G(PSJOCFLG):2,1:1) D YN^DICN Q:%  D ENCOM^PSGOEM I %<0 S VALMBCK="" Q
"RTN","PSGOEC",39,0)
 I 'PSJCOM,CF,$D(PSJDCDTF) F  W !!,"Enter DC to discontinue the above order or press <RETURN> to continue:" S %=$S($G(PSJOCFLG):2,1:1) D TST4DC W:%=2 !,"No action taken!" Q:%  D ENDC^PSGOEM I %<0 S VALMBCK="" Q
"RTN","PSGOEC",40,0)
 I 'PSJCOM,'CF,'$D(PSJDCDTF) F  W !!,"Do you want mark this order for discontinuation" S %=$S($G(PSJOCFLG):2,1:1) D YN^DICN Q:%  D ENCOM^PSGOEM I %<0 S VALMBCK="" Q
"RTN","PSGOEC",41,0)
 G:%=1 SOC I $S(PSGORD["U":$D(^PS(55,PSGP,5,+PSGORD,4)),1:$D(^PS(53.1,+PSGORD,4))),$P(^(4),U,12) W !!,"THIS ORDER HAS"
"RTN","PSGOEC",42,0)
 I  D ENUMK^PSGOEM I %=1 W "..." K DA S:PSGORD["A" PSGAL("C")=PSJSYSU*10+21400,DA=+PSGORD,DA(1)=PSGP D RS,^PSGAL5:PSGORD["A" W " . . . DONE!"
"RTN","PSGOEC",43,0)
 G DONE
"RTN","PSGOEC",44,0)
SOC ;
"RTN","PSGOEC",45,0)
 I 'CF,'$P($S(PSGORD["U":$G(^PS(55,PSGP,5,+PSGORD,0)),1:$G(^PS(53.1,+PSGORD,0))),U,21) W !!,"...one moment, please..."
"RTN","PSGOEC",46,0)
 E  I CF,'($G(PSJDCTYP)=2) S PSJNOO=$$ENNOO^PSJUTL5("D") I PSJNOO<0 D ABORT^PSGOEE G DONE
"RTN","PSGOEC",47,0)
 ; prompt for requesting provider
"RTN","PSGOEC",48,0)
 I '($G(PSJDCTYP)=2) I CF,'$$REQPROV D ABORT^PSGOEE G DONE
"RTN","PSGOEC",49,0)
 K DA D NOW^%DTC S PSGDT=%,T=$E("T",'PSJSYSU),PSGALR=20,DA=+PSGORD,DA(1)=PSGP
"RTN","PSGOEC",50,0)
 I 'PSJCOM D
"RTN","PSGOEC",51,0)
 .I PSGORD["U" D ASET:CF,AC
"RTN","PSGOEC",52,0)
 .I PSGORD'["U" D NSET:CF,NC
"RTN","PSGOEC",53,0)
 I PSJCOM N COMFLG S COMFLG=0 D
"RTN","PSGOEC",54,0)
 . I PSGORD["P" Q:('$$LOCK^PSJOEA(PSGP,PSJCOM))  D 
"RTN","PSGOEC",55,0)
 .. N O S O="" F  S O=$O(^PS(53.1,"ACX",PSJCOM,O)) Q:O=""  S (PSGORD,PSJORD)=O_"P" D NSET,NC
"RTN","PSGOEC",56,0)
 .I PSGORD["U" N O,OO S O=0,OO="" F  S O=$O(^PS(55,"ACX",PSJCOM,O)) Q:'O  F  S OO=$O(^PS(55,"ACX",PSJCOM,O,OO)) Q:OO=""  Q:COMFLG  D
"RTN","PSGOEC",57,0)
 .. Q:OO=PSGORD  I '$$LS^PSSLOCK(DFN,OO) S COMFLG=1 Q
"RTN","PSGOEC",58,0)
 I PSJCOM Q:COMFLG  N O,OO S O=0,OO="" F  S O=$O(^PS(55,"ACX",PSJCOM,O)) Q:'O  F  S OO=$O(^PS(55,"ACX",PSJCOM,O,OO)) Q:OO=""  D
"RTN","PSGOEC",59,0)
 . I OO["V" S ON55=OO D D1^PSIVOPT2 S PSIVALT=1,PSIVALCK="STOP",PSIVREA="D",ON=ON55,P(3)=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3) D
"RTN","PSGOEC",60,0)
 .. D LOG^PSIVORAL N PSJORD S PSJORD=ON55,P(3)=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3),P("NAT")=PSJNOO D HL^PSIVORA
"RTN","PSGOEC",61,0)
 . I OO["U" N PSGORD,PSJORD S (PSGORD,PSJORD)=OO D ASET^PSGOEC,AC^PSGOEC
"RTN","PSGOEC",62,0)
 Q
"RTN","PSGOEC",63,0)
D1 N %,DA,DIE,DIU,STP,NSTOP
"RTN","PSGOEC",64,0)
 D NOW^%DTC S NSTOP=+$E(%,1,12),STP=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3),NSTOP=+$S(STP>NSTOP:NSTOP,1:STP),P(17)="D"
"RTN","PSGOEC",65,0)
 S DA(1)=DFN,DA=+ON55,DIE="^PS(55,"_DFN_",""IV"",",DR="109////"_NSTOP_$S('$P($G(^PS(55,DFN,"IV",+ON55,2)),U,7):";116////"_STP,1:"")_";100///D;.03////"_NSTOP,PSIVACT=1 D ^DIE
"RTN","PSGOEC",66,0)
 I $S($G(PSIVAC)="OD":0,$G(PSIVAC)'="AD":1,$G(PSGALO)<1060:0,1:$P($G(PSJSYSW0),U,15)) S X=$S($G(PSIVAC)="AD":1,1:2) D ENLBL^PSIVOPT(X,$S(X=1:+$G(PSGUOW),1:DUZ),DFN,3,+ON55,$E("AD",1,3-X))
"RTN","PSGOEC",67,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN Q:'PSJIVORF  ;* S ORIFN=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,21) Q:'ORIFN
"RTN","PSGOEC",68,0)
 Q
"RTN","PSGOEC",69,0)
OUT ;
"RTN","PSGOEC",70,0)
 W $S(PSJCOM:"...ORDER ",1:"...ORDERS "),$S(CF:"DISCONTINUED!",1:"MARKED!") S PSGCANFL=1
"RTN","PSGOEC",71,0)
DONE ;
"RTN","PSGOEC",72,0)
 K CF,DA,DIE,DP,DR,ORIFN,ORETURN,PSGAL,PSGALR,PSGDA,SD,ST,T,UCF,Y,PSJDCTYP Q
"RTN","PSGOEC",73,0)
ASET ;
"RTN","PSGOEC",74,0)
 S DIE="^PS(55,"_PSGP_",5,",DR="136////@;28////"_$S($P($G(^PS(55,PSGP,5,+$G(PSJORD),0)),U,27)="E":"DE",$D(PSGEDIT):"DE",1:"D")_";Q;34////"_PSGDT_$S(T]"":";49////1",1:"")
"RTN","PSGOEC",75,0)
 Q
"RTN","PSGOEC",76,0)
NSET ;
"RTN","PSGOEC",77,0)
 S DIE="^PS(53.1,",DR="28////"_$S($P($G(^PS(53.1,+$G(PSJORD),0)),U,27)="E":"DE",$D(PSGEDIT):"DE",1:"D")_$S(T]"":";42////1",1:"")_";25////"_PSGDT Q
"RTN","PSGOEC",78,0)
AC ;
"RTN","PSGOEC",79,0)
 I 'CF K DA S $P(^PS(55,PSGP,5,+PSGORD,4),U,11,14)="^1^"_DUZ_U_PSGDT,PSGAL("C")=13040,DA=+PSGORD,DA(1)=PSGP D ^PSGAL5
"RTN","PSGOEC",80,0)
 I 'CF,$D(PSJSYSO) S PSGORD=+PSGORD_"A",PSGPOSA="C",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOEC",81,0)
 Q:'CF  K DA,ORIFN S PSGAL("C")=PSJSYSU*10+4000,DA=+PSGORD,DA(1)=PSGP D ^PSGAL5 S $P(^(2),U,3)=$P(^PS(55,PSGP,5,+PSGORD,2),U,4) D ^DIE S ^PS(55,"AUE",PSGP,+PSGORD)=""
"RTN","PSGOEC",82,0)
 I '$D(PSJSYSL) S PSJSYSL=""
"RTN","PSGOEC",83,0)
 I PSJSYSL K DA S $P(^PS(55,PSGP,5,+PSGORD,7),U,1,2)=PSGDT_U_$S($D(PSGEDIT):"DE",1:"D"),PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD,DA(1)=PSGP D ENL^PSGVDS
"RTN","PSGOEC",84,0)
 S ORIFN=$P($G(^PS(55,PSGP,5,+PSGORD,0)),U,21) D:ORIFN DCOR^PSGOECS
"RTN","PSGOEC",85,0)
 Q
"RTN","PSGOEC",86,0)
NC ;
"RTN","PSGOEC",87,0)
 D KILL531^PSJIMO1(PSGP,"",+PSGORD)
"RTN","PSGOEC",88,0)
 I 'CF S $P(^PS(53.1,+PSGORD,4),"^",11,14)="^1^"_DUZ_U_PSGDT
"RTN","PSGOEC",89,0)
 I 'CF,$D(PSJSYSO) S PSGORD=+PSGORD_"N",PSGPOSA="C",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOEC",90,0)
 Q:'CF  S PSGSTAT=$P($G(^PS(53.1,+PSGORD,0)),U,9),PSGORIFN=$P($G(^(0)),U,21)
"RTN","PSGOEC",91,0)
 I PSGSTAT'="U" K DA,ORIFN S DA=+PSGORD D ^DIE I PSJSYSL,PSJSYSL<3,(PSGSTAT'="P") S $P(^PS(53.1,+PSGORD,7),U,1,2)=PSGDT_U_$S($D(PSGEDIT):"DE",1:"D"),PSGTOO=2,PSGUOW=DUZ,PSGTOL=2 D ENL^PSGVDS
"RTN","PSGOEC",92,0)
 I PSGSTAT="U" K DA S DA=+PSGORD,DIK="^PS(53.1," D ^DIK
"RTN","PSGOEC",93,0)
 I PSGORIFN S ORIFN=PSGORIFN D DCOR^PSGOECS
"RTN","PSGOEC",94,0)
 Q
"RTN","PSGOEC",95,0)
T ;
"RTN","PSGOEC",96,0)
 F  W !!,"Is this due to the patient being transferred" S %=2 D YN^DICN Q:%  D ENCTM^PSGOEM1
"RTN","PSGOEC",97,0)
 S T=$S(%<0:"^",1:$E("T",%=1)) Q
"RTN","PSGOEC",98,0)
RS ;
"RTN","PSGOEC",99,0)
 ; naked ref below is from variable ND1, ^PS(53.1,PSGDA,4)
"RTN","PSGOEC",100,0)
 S $P(^(4),U,11,14)="^^^" Q
"RTN","PSGOEC",101,0)
 ;
"RTN","PSGOEC",102,0)
REQPROV()          ;
"RTN","PSGOEC",103,0)
 I $G(PSJDCTYP)=2 Q 1
"RTN","PSGOEC",104,0)
 K PSJDCPRV,DIC,DUOUT,DTOUT,Y
"RTN","PSGOEC",105,0)
 N PROVIDER,PROVNAME,RESULT,RSB S RESULT=0
"RTN","PSGOEC",106,0)
 S PROVIDER=+$P($G(^PS(55,DFN,5.1)),"^",2),PROVNAME=""
"RTN","PSGOEC",107,0)
 I PROVIDER>0 D
"RTN","PSGOEC",108,0)
 .S DIC=200,DR="53.1;53.4",DIQ="RSB",DIQ(0)="I",DA=PROVIDER D EN^DIQ1
"RTN","PSGOEC",109,0)
 .K DIC,DR,DA,DIQ
"RTN","PSGOEC",110,0)
 .I $G(RSB(200,PROVIDER,53.1,"I"))="1"&(($G(RSB(200,PROVIDER,53.4,"I"))="")!($G(RSB(200,PROVIDER,53.4,"I"))>DT)) D
"RTN","PSGOEC",111,0)
 ..S DIC=200,DA=PROVIDER,DR=".01",DIQ="RSB",DIQ(0)="E" D EN^DIQ1
"RTN","PSGOEC",112,0)
 ..S PROVNAME=$G(RSB(200,PROVIDER,.01,"E")) K DA,DIQ,DR
"RTN","PSGOEC",113,0)
 K DIC S DIC=200,DIC(0)="AEMQZ"
"RTN","PSGOEC",114,0)
 S:PROVNAME]"" DIC("B")=PROVNAME
"RTN","PSGOEC",115,0)
 S DIC("A")="Requesting PROVIDER: "
"RTN","PSGOEC",116,0)
 S DIC("S")="I $D(^(""PS"")),^(""PS""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)>DT)" D ^DIC K DIC
"RTN","PSGOEC",117,0)
 I +Y>0,'$D(DUOUT),'$D(DTOUT) S RESULT=1,PSJDCPRV=+Y
"RTN","PSGOEC",118,0)
 Q RESULT
"RTN","PSGOEC",119,0)
 ;
"RTN","PSGOEC",120,0)
PNDRNA(ORDER) ; Ask Discontinue Pending Renewal only, or both Pending Renew and Renewed Order
"RTN","PSGOEC",121,0)
 ; Perform this action only for pending renewals
"RTN","PSGOEC",122,0)
 I '$G(ORDER)!'($G(ORDER)["P") Q 3
"RTN","PSGOEC",123,0)
 ; Quit if original order is no longer active
"RTN","PSGOEC",124,0)
 N ORIGORD,ORIGSTOP S ORIGORD=$P($G(^PS(53.1,+ORDER,0)),"^",25) Q:'ORIGORD  D  I ORIGSTOP<$G(PSGDT) Q 1
"RTN","PSGOEC",125,0)
 .S ORIGSTOP=$S(ORIGORD["U":$P($G(^PS(55,PSGP,5,+ORIGORD,2)),"^",4),ORIGORD["V":$P($G(^PS(55,PSGP,"IV",+ORIGORD,0)),"^",3),1:"")
"RTN","PSGOEC",126,0)
 N NDP2
"RTN","PSGOEC",127,0)
 S NDP2=^PS(53.1,+ORDER,.2) S DRG=NDP2,DO=$P(DRG,"^",2) S DRG=$$ENPDN^PSGMI($P(DRG,"^"))
"RTN","PSGOEC",128,0)
 S ND2=^PS(53.1,+ORDER,2) S SCH=$P(ND2,"^"),START=$P(ND2,"^",2),START=$$FMTE^XLFDT(START,2)
"RTN","PSGOEC",129,0)
 W !!?5,DRG_" "_DO
"RTN","PSGOEC",130,0)
 W !?5,"This order has a pending status. If this pending order"
"RTN","PSGOEC",131,0)
 W !?5,"is discontinued, the original order may still be active."
"RTN","PSGOEC",132,0)
 S DIR("A")="Select order(s) to discontinue"
"RTN","PSGOEC",133,0)
 S DIR(0)="S^1:DC BOTH Orders;2:DC Pending Order;3:Cancel - No Action Taken"
"RTN","PSGOEC",134,0)
 S DIR("L",1)="1 - DC BOTH Orders"
"RTN","PSGOEC",135,0)
 S DIR("L",2)="2 - DC Pending Order"
"RTN","PSGOEC",136,0)
 S DIR("L",3)="3 - Cancel - No Action Taken" D ^DIR
"RTN","PSGOEC",137,0)
 ; Reverse order - Y=1 - Pending only  Y=2:BOTH
"RTN","PSGOEC",138,0)
 S Y=$S(Y=1:2,Y=2:1,1:3)
"RTN","PSGOEC",139,0)
 Q Y
"RTN","PSGOEC",140,0)
 ;
"RTN","PSGOEC",141,0)
PNDRN(PSJDCTYP,ORDER) ; Perform Discontinue action for Pending order only or both Pending and Renewed
"RTN","PSGOEC",142,0)
 ; Perform this action only for pending renewals
"RTN","PSGOEC",143,0)
 N PSGORD S PSGORD=ORDER
"RTN","PSGOEC",144,0)
 Q:'$G(PSGORD)!'($G(PSGORD)["P")
"RTN","PSGOEC",145,0)
 I PSJDCTYP=1 G SOC
"RTN","PSGOEC",146,0)
 I PSJDCTYP=2 S PSJDCTYP=1 D SOC Q:'$G(PSJDCTYP)  D
"RTN","PSGOEC",147,0)
 .I ($G(PSJNOO)<0) Q
"RTN","PSGOEC",148,0)
 .N ND5310 S ND5310=$G(^PS(53.1,+PSGORD,0))
"RTN","PSGOEC",149,0)
 .N PSGORD S PSGORD=$P(ND5310,"^",25) I PSGORD S PSJDCTYP=2 D SOC K PSJDCTYP
"RTN","PSGOEC",150,0)
 Q
"RTN","PSGOEC",151,0)
 ;
"RTN","PSGOEC",152,0)
PNDRNOK(ORDER) ; Execute DC Pending Renew enhancement only if 
"RTN","PSGOEC",153,0)
 ;                  1) Renewal order is pending/non-verified, and 
"RTN","PSGOEC",154,0)
 ;                  2) Original order is not DC'd or Expired
"RTN","PSGOEC",155,0)
 Q:'$G(PSGORD)!'($G(PSGORD)["P") 0
"RTN","PSGOEC",156,0)
 N ORIGORD,ORIGSTOP S ORIGORD=$P($G(^PS(53.1,+ORDER,0)),"^",25) Q:'ORIGORD 0  D  I ORIGSTOP<$G(PSGDT) Q 0
"RTN","PSGOEC",157,0)
 .S ORIGSTOP=$S(ORIGORD["U":$P($G(^PS(55,PSGP,5,+ORIGORD,2)),"^",4),ORIGORD["V":$P($G(^PS(55,PSGP,"IV",+ORIGORD,0)),"^",3),1:"")
"RTN","PSGOEC",158,0)
 Q:'($P($G(^PS(53.1,+PSGORD,0)),U,24)="R") 0
"RTN","PSGOEC",159,0)
 Q 1
"RTN","PSGOEC",160,0)
 ;
"RTN","PSGOEC",161,0)
TST4DC ; Test for DC at prompt
"RTN","PSGOEC",162,0)
 R X:$S($D(DTIME):DTIME,1:300) I '$T S %=2 Q
"RTN","PSGOEC",163,0)
 S %=$S(X="DC":1,X="Dc":1,X="dc":1,X="dC":1,X="D":1,X="d":1,X="":2,X="^":2,X]"":"",1:2)
"RTN","PSGOEC",164,0)
 Q
"RTN","PSIVORA")
0^9^B29175721
"RTN","PSIVORA",1,0)
PSIVORA ;BIR/MLM-MAIN DRIVER FOR IV FLUIDS - OE/RR INTERFACE ;08 JAN 97 / 2:47 PM
"RTN","PSIVORA",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**29,41,110,134,299**;16 DEC 97;Build 11
"RTN","PSIVORA",3,0)
 ;
"RTN","PSIVORA",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIVORA",5,0)
 ;
"RTN","PSIVORA",6,0)
EN ; Entry point called by IV Fluid protocol.
"RTN","PSIVORA",7,0)
 S X=ORACTION,PSIVAC="O"_$S(X=0:"N",X=1:"E",X=2:"R",X=4:"H",X=6:"D",X="8":"S",1:"") S:X'=5&(X'=7) PSIVUP=+$$GTPCI^PSIVUTL
"RTN","PSIVORA",8,0)
 S (PSGP,DFN)=+ORVP,PSJACNWP=1 D ^PSJAC I "578"[ORACTION D @ORACTION,DONE^PSIVORA1 Q
"RTN","PSIVORA",9,0)
 D ENCPP^PSIVOREN Q:'PSJIVORF!('PSJORF)  D EN1,DONE^PSIVORA1
"RTN","PSIVORA",10,0)
 Q
"RTN","PSIVORA",11,0)
 ;
"RTN","PSIVORA",12,0)
EN1 ; Take action on existing order.
"RTN","PSIVORA",13,0)
 S PSJORD=$G(ORPK) I ORGY>8 D @ORGY Q
"RTN","PSIVORA",14,0)
 I 'ORACTION D ^PSIVORFE Q
"RTN","PSIVORA",15,0)
 I '$G(ORPK) W !,"INSUFFICIENT INFORMATION, CANNOT CONTINUE." S OREND=1 Q
"RTN","PSIVORA",16,0)
 I ORPK["V",($P($G(^PS(55,DFN,"IV",+ORPK,0)),U,17)="O") D ONCALL^PSIVORV1 Q
"RTN","PSIVORA",17,0)
 I ORACTION<3 S P("FRES")=$S(ORPK["V":$P($G(^PS(55,DFN,"IV",+ORPK,2)),U,9),1:$P($G(^PS(53.1,+ORPK,0)),U,27)) I P("FRES")]"" D @$S(P("FRES")="R":"ALLREN^PSIVORV1",1:"ALLED^PSIVORV1") Q
"RTN","PSIVORA",18,0)
 S PSJORSTS=ORSTS,PSJORIFN=ORIFN L +@$S(PSJORD["V":"^PS(55,DFN,""IV"",+PSJORD)",1:"^PS(53.1,+PSJORD)"):1 E  D LOCKERR^PSIVORA1 Q
"RTN","PSIVORA",19,0)
 D @ORACTION L -@$S(PSJORD["V":"^PS(55,DFN,""IV"",+PSJORD)",1:"^PS(53.1,+PSJORD)")
"RTN","PSIVORA",20,0)
 Q
"RTN","PSIVORA",21,0)
 ;
"RTN","PSIVORA",22,0)
1 ; Edit an existing order.
"RTN","PSIVORA",23,0)
 D EDIT^PSIVORA1
"RTN","PSIVORA",24,0)
 Q
"RTN","PSIVORA",25,0)
 ;
"RTN","PSIVORA",26,0)
2 ; Renew
"RTN","PSIVORA",27,0)
 D RENEW^PSIVORA1
"RTN","PSIVORA",28,0)
 Q
"RTN","PSIVORA",29,0)
 ;
"RTN","PSIVORA",30,0)
3 ; Flag
"RTN","PSIVORA",31,0)
 Q
"RTN","PSIVORA",32,0)
 ;
"RTN","PSIVORA",33,0)
4 ; Hold
"RTN","PSIVORA",34,0)
 I ORSTS'=3,ORSTS'=6 W !,$C(7),"Only ACTIVE orders may be placed on HOLD." S OREND=1 Q
"RTN","PSIVORA",35,0)
 S PSIVREA=$S(ORSTS=6:"H",1:"U"),ON55=PSJORD,$P(^PS(55,DFN,"IV",+ON55,0),U,10)=$S(PSIVREA="H":1,1:""),Y=$G(^PS(55,DFN,"IV",+ON55,0)),P(3)=$P(Y,U,3),P(17)=$P(Y,U,17)
"RTN","PSIVORA",36,0)
 D NOW^%DTC I ORSTS=3,P(3)<% S P(17)="E" D UPSTAT^PSIVOPT S ORSTS=7 W $C(7),"  This order has expired." Q
"RTN","PSIVORA",37,0)
 S XED=0,PSIVALT=2,P(17)=$S(PSIVREA="H":"H",1:"A") D UPSTAT^PSIVOPT,LOG^PSIVORAL S ORSTS=$S(PSIVREA="H":3,1:6)
"RTN","PSIVORA",38,0)
 Q
"RTN","PSIVORA",39,0)
 ;
"RTN","PSIVORA",40,0)
5 ; Event
"RTN","PSIVORA",41,0)
 N DA,DIE,DR,ON,P,PSIVACT,X
"RTN","PSIVORA",42,0)
 S ON=ORPK I ON["V" S X=$G(^PS(55,+ORVP,"IV",+ON,0)),P(3)=$P(X,U,3),P(17)=$P(X,U,17)
"RTN","PSIVORA",43,0)
 I ON'["V" S P(3)=$P($G(^PS(53.1,+ON,2)),U,4),P(17)=$P($G(^PS(53.1,+ON,0)),U,9)
"RTN","PSIVORA",44,0)
 Q:"AR"'[P(17)  D NOW^%DTC Q:P(3)>%
"RTN","PSIVORA",45,0)
 I ON["V" S DR="100///E",DIE="^PS(55,"_+ORVP_",""IV"",",DA(1)=+ORVP
"RTN","PSIVORA",46,0)
 I ON'["V" S DR="28///E",DIE="^PS(53.1,"
"RTN","PSIVORA",47,0)
 S PSIVACT=1,DA=+ON D ^DIE S ORSTS=7
"RTN","PSIVORA",48,0)
 Q
"RTN","PSIVORA",49,0)
 ;
"RTN","PSIVORA",50,0)
6 ; Cancel - Delete pending or unreleased orders from Nonverified orders
"RTN","PSIVORA",51,0)
 ; (53.1) and Orders (100) files.
"RTN","PSIVORA",52,0)
 I ORSTS=1 W $C(7),!,"This order has already been DISCONTINUED." Q
"RTN","PSIVORA",53,0)
 I ORSTS=7 W $C(7),!,"Expired orders cannot be DISCONTINUED." Q
"RTN","PSIVORA",54,0)
 I PSJORD'["V",ORSTS=11 D  Q
"RTN","PSIVORA",55,0)
 .S P("OLDON")=$P($G(^PS(53.1,+PSJORD,0)),U,25) I P("OLDON")  D
"RTN","PSIVORA",56,0)
 ..I P("OLDON")["V",$D(^PS(55,DFN,"IV",+P("OLDON"),2)) S PSJRES=$P(^(2),U,9) S:PSJRES'="R" $P(^(2),U,6)="",$P(^(2),U,9)="" ;; D:PSJRES="R" ENBKOUT^PSJOREN(DFN,PSJORD)
"RTN","PSIVORA",57,0)
 ..I P("OLDON")'["V",$D(^PS(53.1,+P("OLDON"),0)) S PSJRES=$P(^(0),U,27) S:PSJRES'="R" $P(^(0),U,26,27)="^" I PSJRES="R" ;; D ENBKOUT^PSJOREN(DFN,PSJORD)
"RTN","PSIVORA",58,0)
 .K DA,DIK S DIK="^PS(53.1,",DA=+PSJORD D ^DIK S PSGP=DFN,X="P" D ENSK^PSGAXR K DA,DIK S ORIFN=PSJORIFN,ORSTS="K" Q
"RTN","PSIVORA",59,0)
 ;
"RTN","PSIVORA",60,0)
DC ; DC order from Pharmacy complete function.
"RTN","PSIVORA",61,0)
 I PSJORD["V",'PSJCOM N PSIVREA S ON55=PSJORD,X=$G(^PS(55,DFN,"IV",+ON55,0)),P(3)=$P(X,U,3),P(17)=$P(X,U,17),PSIVREA="D",PSIVALT=2,PSIVALCK="STOP" D D^PSIVOPT2 D HL Q
"RTN","PSIVORA",62,0)
 I PSJORD["V",PSJCOM N PSIVREA S ON55=PSJORD,X=$G(^PS(55,DFN,"IV",+ON55,0)),P(3)=$P(X,U,3),P(17)=$P(X,U,17),PSIVREA="D",PSIVALT=2,PSIVALCK="STOP" D D^PSIVOPT2 Q
"RTN","PSIVORA",63,0)
 N DA,DR,DIE,PSJND S DA=+PSJORD,PSJND=$G(^PS(53.1,DA,0)),P("OLDON")=$P(PSJND,U,25),DIE="^PS(53.1,",DR="28///"_$S($P(PSJND,U,27)="E":"DE",1:"D") D ^DIE
"RTN","PSIVORA",64,0)
 D KILL531^PSJIMO1(DFN,"",+PSJORD)
"RTN","PSIVORA",65,0)
 D HL
"RTN","PSIVORA",66,0)
 Q
"RTN","PSIVORA",67,0)
HL ;
"RTN","PSIVORA",68,0)
 Q:'$D(P("NAT"))
"RTN","PSIVORA",69,0)
 NEW PSJCD,PSJTX,PSJOTMP
"RTN","PSIVORA",70,0)
 I PSJORD["P" N PSJNOO S PSJCD="OC",PSJTX="ORDER CANCELED",PSJNOO=$G(P("NAT"))
"RTN","PSIVORA",71,0)
 E  S PSJCD="OD",PSJTX="ORDER DISCONTINUED"
"RTN","PSIVORA",72,0)
 S PSJOTMP=$G(P("OT")) S P("OT")="F" D EN1^PSJHL2(DFN,PSJCD,PSJORD,PSJTX)
"RTN","PSIVORA",73,0)
 Q
"RTN","PSIVORA",74,0)
 ;
"RTN","PSIVORA",75,0)
7 ; Purge
"RTN","PSIVORA",76,0)
 N ND S ND=$S(ORPK["V":$P($G(^PS(55,+ORVP,"IV",+ORPK,0)),U,17)_U_$P($G(^(0)),U,3),1:$P($G(^PS(53.1,+ORPK,0)),U,9)_U_$P($G(^(2)),U,4))
"RTN","PSIVORA",77,0)
 Q:"DE"'[$P(ND,U)  S X1=+$P(ND,U,2),X2=30 D C^%DTC S ND=X D NOW^%DTC Q:ND>%
"RTN","PSIVORA",78,0)
 I ORPK["V",$D(^PS(55,+ORVP,"IV",+ORPK,0)) S $P(^(0),U,21)=""
"RTN","PSIVORA",79,0)
 I ORPK'["V",$D(^PS(53.1,+ORPK,0)) S $P(^(0),U,21)=""
"RTN","PSIVORA",80,0)
 S ORSTS="K"
"RTN","PSIVORA",81,0)
 Q
"RTN","PSIVORA",82,0)
 ;
"RTN","PSIVORA",83,0)
8 ; Print
"RTN","PSIVORA",84,0)
 K DIR S DIR(0)="E" D ^DIR K DIR I $D(DUOUT)!'($D(ORPK)) S OREND=1 Q
"RTN","PSIVORA",85,0)
 S:'$G(PSIVUP) PSIVUP=+$$GTPCI^PSIVUTL S:'$D(PSIVAC) PSIVAC="OS" S (ON,ON55)=ORPK,DFN=+ORVP D @$S(ON["V":"GT55^PSIVORFB",1:"GT531^PSIVORFA("_DFN_","""_ON_""")"),ENDT^PSIVORV1
"RTN","PSIVORA",86,0)
 Q
"RTN","PSIVORA",87,0)
 ;
"RTN","PSIVORA",88,0)
9 ; Release order (status=incomplete in 53.1, pending in 100)
"RTN","PSIVORA",89,0)
 S X=ORACTION I X=4!(X=6) D @ORACTION Q
"RTN","PSIVORA",90,0)
 Q:"36"[ORSTS  N ON,PSJORIFN S PSJORIFN=ORIFN,ON=ORPK L +^PS(53.1,+ON):1 E  D LOCKERR^PSIVORA1 Q
"RTN","PSIVORA",91,0)
 S Y=$G(^PS(53.1,+ON,0)),P("RES")=$P(Y,U,24),P("OLDON")=$P(Y,U,25)
"RTN","PSIVORA",92,0)
 N DA,DIE,DR,OREND S DR="28////P",DIE="^PS(53.1,",DA=+ON D ^DIE
"RTN","PSIVORA",93,0)
 I P("OLDON")]"" K DA,DIE,DR S DA=P("OLDON") D
"RTN","PSIVORA",94,0)
 .I DA["V" S DA(1)=+ORPV,DIE="^PS(55,"_DA(1)_",""IV"",",DR="114////"_+ON_"P"_";123////"_P("RES")
"RTN","PSIVORA",95,0)
 .E  S DIE="^PS(53.1,",DR="105////"_ON_"P"_";107////"_P("RES") I P("RES")="E",$P($G(^PS(53.1,+P("OLDON"),0)),U,9)="D" S DR=DR_";28////DE"
"RTN","PSIVORA",96,0)
 .S DA=+DA L +@(DIE_DA_")"):1 E  D LOCKERR^PSIVORA1 Q
"RTN","PSIVORA",97,0)
 .D ^DIE L -@(DIE_DA_")")
"RTN","PSIVORA",98,0)
 L -^PS(53.1,+ON) D DONE^PSIVORA1
"RTN","PSIVORA",99,0)
 Q
"RTN","PSIVORA",100,0)
 ;
"RTN","PSIVORA",101,0)
10 ; Verify
"RTN","PSIVORA",102,0)
 Q
"RTN","PSIVORFB")
0^8^B84688439
"RTN","PSIVORFB",1,0)
PSIVORFB ;BIR/MLM-FILE/RETRIEVE ORDERS IN ^PS(55 ;25 Sep 98 / 2:24 PM
"RTN","PSIVORFB",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**3,18,28,68,58,85,110,111,120,134,213,161,181,273,267,285,257,299**;16 DEC 97;Build 11
"RTN","PSIVORFB",3,0)
 ;
"RTN","PSIVORFB",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSIVORFB",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178.
"RTN","PSIVORFB",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA #1231.
"RTN","PSIVORFB",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA #2173.
"RTN","PSIVORFB",8,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSIVORFB",9,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177.
"RTN","PSIVORFB",10,0)
 ; Reference to ^PSUHL is supported by DBIA #4803.
"RTN","PSIVORFB",11,0)
 ; 
"RTN","PSIVORFB",12,0)
NEW55 ; Get new order number in 55.
"RTN","PSIVORFB",13,0)
 N DA,DD,DO,DIC,DLAYGO,X,Y,PSIVLIM,MINS,PSJDSTP1,PSJDSTP2,A,PSJCLIN,PSJDNM,PSJPROV,PSJWARD,PSJPAO,PSJALRT
"RTN","PSIVORFB",14,0)
 I ($G(PSIVAC)="PN"),$G(PSJSYSP) D KILL^PSJBCMA5(+$G(PSJSYSP))
"RTN","PSIVORFB",15,0)
 I $D(^PS(55,+DFN)),'$D(^PS(55,+DFN,0)) D ENSET0^PSGNE3(+DFN)
"RTN","PSIVORFB",16,0)
 ;*273 - Set PSIVSITE if not set.
"RTN","PSIVORFB",17,0)
 I $G(PSJORD)["V"!($G(PSJORD)["P"),$G(P(2))]"" D
"RTN","PSIVORFB",18,0)
 . I '$G(PSIVSITE) S PSIVSN=$P(P("IVRM"),"^") D ENCHK^PSIVSET
"RTN","PSIVORFB",19,0)
 . D LIMSTOP(.PSJDSTP1,.PSJDSTP2)
"RTN","PSIVORFB",20,0)
 I ($G(PSJORD)["P"!($G(PSJORD)["V"))&$G(PSIVLIM) I $$CMPLIM(PSJORD,PSJDSTP1,PSJDSTP2) D
"RTN","PSIVORFB",21,0)
 . D
"RTN","PSIVORFB",22,0)
 .. S PSJPROV=DUZ I PSJORD["P" S PSJPROV=$P($G(^PS(53.1,+PSJORD,0)),"^",2)
"RTN","PSIVORFB",23,0)
 .. I PSJORD["V" S PSJPROV=$P($G(^PS(55,DFN,"IV",+PSJORD,0)),"^",6)
"RTN","PSIVORFB",24,0)
 .. D NOW^%DTC S XQA(PSJPROV)="",XQAID="PSJ,"_DFN_";"_PSJPROV_";"_%,XQADATA=""
"RTN","PSIVORFB",25,0)
 .. D
"RTN","PSIVORFB",26,0)
 ... I PSJORD["P" S A=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSIVORFB",27,0)
 ... I PSJORD["V" S A=$G(^PS(55,PSGP,"IV",+PSJORD,"DSS"))
"RTN","PSIVORFB",28,0)
 ... S PSJCLIN=$P(A,"^") I PSJCLIN]"" S PSJCLIN=$P(^SC(PSJCLIN,0),"^")
"RTN","PSIVORFB",29,0)
 .. S A=$G(^DPT(DFN,0)),PSJWARD=$G(^(.1))
"RTN","PSIVORFB",30,0)
 .. S XQAMSG=$P(A,"^")_" ("_$E($P(A,"^"))_$E($P(A,"^",9),6,9)_"): ["_$S(PSJWARD]"":$E(PSJWARD,1,10),$G(PSJCLIN)]"":$E(PSJCLIN,1,10),1:"UNKNOWN")_"] "
"RTN","PSIVORFB",31,0)
 .. S A=$O(DRG("AD",0)) I A]"" S A=DRG("AD",A)
"RTN","PSIVORFB",32,0)
 .. I A="" S A=$O(DRG("SOL",0)) I A]"" S A=DRG("SOL",A)
"RTN","PSIVORFB",33,0)
 .. S PSJDNM=$P(^PS(50.7,+$P(A,"^",6),0),"^")
"RTN","PSIVORFB",34,0)
 .. S XQAMSG=XQAMSG_PSJDNM_" your DURATION not used for stop date/time"
"RTN","PSIVORFB",35,0)
 .. D SETUP^XQALERT
"RTN","PSIVORFB",36,0)
 .. S PSJALRT=$$FMTDUR^PSJLIVMD($S(PSJORD["P":$P($G(^PS(53.1,+PSJORD,2.5)),"^",4),PSJORD["IV":$P($G(^PS(55,DFN,"IV",+PSJORD,2.5)),"^",4),1:"UNK"))
"RTN","PSIVORFB",37,0)
 S DIC="^PS(55,",DIC(0)="LN",DLAYGO=55,(DINUM,X)=+DFN D ^DIC Q:Y<0
"RTN","PSIVORFB",38,0)
LOCK0 F  L +^PS(55,DFN,"IV",0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSIVORFB",39,0)
 S ND=$S($D(^PS(55,DFN,"IV",0)):^(0),1:"^55.01") F DA=$P(ND,"^",3)+1:1 W "." I '$D(^PS(55,DFN,"IV",DA)) S $P(ND,"^",3)=DA,$P(ND,"^",4)=$P(ND,"^",4)+1,^PS(55,DFN,"IV",0)=ND Q
"RTN","PSIVORFB",40,0)
 L +^PS(55,DFN,"IV",+DA):$S($G(DILOCKTM)>0:DILOCKTM,1:3) E  G LOCK0
"RTN","PSIVORFB",41,0)
 S ^PS(55,DFN,"IV",+DA,0)=+DA,^PS(55,DFN,"IV","B",+DA,+DA)=""
"RTN","PSIVORFB",42,0)
 L -^PS(55,DFN,"IV",0) S ON55=+DA_"V"
"RTN","PSIVORFB",43,0)
 I $G(PSJALRT)]"" S PSIVAL="IV LIMIT OVERRIDDEN ("_$G(PSJALRT)_"): ALERT SENT",PSIVALT="",PSIVREA="E" D
"RTN","PSIVORFB",44,0)
 .D LOG^PSIVORAL S P("LIMIT")="",P("OVRIDE")=1 K IVLIM,IVLIMIT
"RTN","PSIVORFB",45,0)
 .S $P(^PS(55,DFN,"IV",+ON55,2.5),"^",4)="" S:$G(PSJORD)["P" $P(^PS(53.1,+PSJORD,2.5),"^",4)=""
"RTN","PSIVORFB",46,0)
 .K PSIVAL,PSIVREA,PSIVALT
"RTN","PSIVORFB",47,0)
 I $G(PSIVCOPY)=1,$G(OLDON) I (OLDON["V")&(OLDON'=(+DA_"V")) D GETOPI^PSJBCMA5(DFN,OLDON)
"RTN","PSIVORFB",48,0)
 I $P($G(^PS(53.45,+$G(DUZ),6,0)),"^",3) D
"RTN","PSIVORFB",49,0)
 .N PSJTROPI,PSJNVO S PSJNVO=$G(P("NEWON")) I (PSJNVO["P") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO) Q
"RTN","PSIVORFB",50,0)
 .I ($G(P("PON"))["P"),($G(ON55)["V") S PSJNVO=P("PON") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO) Q
"RTN","PSIVORFB",51,0)
 .D FILEOPI^PSJBCMA5(DFN,ON55) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,ON55)
"RTN","PSIVORFB",52,0)
 Q
"RTN","PSIVORFB",53,0)
SET55 ; Move data from local variables to 55.
"RTN","PSIVORFB",54,0)
 I '$D(ON55) W !,"*** Can't create this order at this time ***" Q
"RTN","PSIVORFB",55,0)
 N DA,DIK,ND,PSIVACT,PSIVDUR,PSJTROPI,PSJTROPL
"RTN","PSIVORFB",56,0)
 I (($P($G(ZZND),"^",3))=""&($G(PSGS0XT)="")) S P(15)="" ;*285 - Prevent frequency hangover when changing from non-null to null
"RTN","PSIVORFB",57,0)
 S:'$D(P(21)) (P(21),P("21FLG"))="" S ND(0)=+ON55,P(22)=$S(VAIN(4):+VAIN(4),1:.5) F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSIVORFB",58,0)
 S ND(.3)=$G(P("INS")),ND(2.5)="" N X S X=$S($G(PSGORD):PSGORD,1:$G(ON)) I X D
"RTN","PSIVORFB",59,0)
 .N PKG S PKG=$E(X,$L(X)) S PKG=$S(PKG="V":"""IV""",PKG="U":5,PKG="P":"P",1:"") Q:PKG=""
"RTN","PSIVORFB",60,0)
 .S PSIVDUR=$$GETDUR^PSJLIVMD(DFN,+X,$E(X,$L(X)),1) Q:PSIVDUR=""
"RTN","PSIVORFB",61,0)
 .I $G(IVLIMIT) S ND(2.5)="^^^"_PSIVDUR K IVLIMIT Q
"RTN","PSIVORFB",62,0)
 S $P(ND(0),U,17)="A",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(P("NAT"))_U_U_U_$G(P("PRNTON"))
"RTN","PSIVORFB",63,0)
 F X=0,1,2.5,3,.2,.3 S ^PS(55,DFN,"IV",+ON55,X)=ND(X)
"RTN","PSIVORFB",64,0)
 ; PSJ*5*213 - if Piggyback, intermittent syringe, or
"RTN","PSIVORFB",65,0)
 ; intermittent chemotherapy, and frequency is null, attempt to
"RTN","PSIVORFB",66,0)
 ; set frequency again based on P(15),PSGS0XT, and piece 3 of ZZND if they exist.
"RTN","PSIVORFB",67,0)
 ; If this still is null, attempt to re-set based upon the schedule name.
"RTN","PSIVORFB",68,0)
 I $G(P("IVCAT"))="I"!($P($G(ND(0)),U,4)?1(1"P",1"S",1"C"))&($P($G(ND(0)),U,15)="") D
"RTN","PSIVORFB",69,0)
 . I $P($G(ND(0)),U,4)="S",$P($G(ND(0)),U,5)'=1 Q  ;Not intermittent syringe
"RTN","PSIVORFB",70,0)
 . I $P($G(ND(0)),U,4)="C",$P($G(ND(0)),U,23)?1(1"A",1"H") Q  ;Not chemo piggyback or syringe
"RTN","PSIVORFB",71,0)
 . I $P($G(ND(0)),U,4)="C",$P($G(ND(0)),U,23)="S",$P($G(ND(0)),U,5)'=1 Q  ;Not intermitent chemo syringe
"RTN","PSIVORFB",72,0)
 . S $P(^PS(55,DFN,"IV",+ON55,0),U,15)=$S($G(P(15))'="":P(15),$G(PSGS0XT)'="":PSGS0XT,$P($G(ZZND),"^",3)'="":$P(ZZND,"^",3),1:$$GETFRQ($P($G(ND(0)),U,9))) K PSJFRQ,PSJSKED
"RTN","PSIVORFB",73,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,1,4)=P("LOG")_U_+P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSIVORFB",74,0)
 S X=^PS(55,DFN,0) I $P(X,"^",7)="" S $P(X,"^",7)=$P($P(P("LOG"),"^"),"."),$P(X,"^",8)="A",^(0)=X D LOGDFN^PSUHL(DFN)
"RTN","PSIVORFB",75,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,11)=+P("CLRK")
"RTN","PSIVORFB",76,0)
 S:+$G(P("CLIN")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=P("CLIN")
"RTN","PSIVORFB",77,0)
 S:+$G(P("APPT")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^",2)=P("APPT")
"RTN","PSIVORFB",78,0)
 S:+$G(P("NINIT")) ^PS(55,DFN,"IV",+ON55,4)=P("NINIT")_U_P("NINITDT")
"RTN","PSIVORFB",79,0)
 I '$D(^PS(53.45,PSJSYSP,6)),($G(P("NEWON"))["P") S PSJTROPI=P("NEWON") S PSJTROPL=$$GETOPI^PSJBCMA5(DFN,PSJTROPI)
"RTN","PSIVORFB",80,0)
 I $G(^PS(53.45,PSJSYSP,6))!$P($G(^PS(53.45,PSJSYSP,6,0)),"^",3) D
"RTN","PSIVORFB",81,0)
 . I $G(PSJCOM),$G(PSJCOMSI),$G(PSJORD)["V" M ^TMP("PSJOPI",$J,6)=^PS(53.45,PSJSYSP,6)
"RTN","PSIVORFB",82,0)
 . D FILEOPI^PSJBCMA5(DFN,ON55) K ^TMP("PSJOPI",$J,6)
"RTN","PSIVORFB",83,0)
 I '$G(PSIVCHG)!($G(PSJREN)&($G(PSIVCHG)=2)) I $G(P("PON")),P("PON")'=ON55 D
"RTN","PSIVORFB",84,0)
 . N X S X=$S(P("PON")["P":"^PS(53.1,+P(""PON""),12,0)",P("PON")["V"&$G(PSJREN):"^PS(55,DFN,""IV"",+P(""PON""),5,0)",1:"") Q:X=""
"RTN","PSIVORFB",85,0)
 . I $O(@X) S %X=X,%Y="^PS(55,"_DFN_",""IV"","_+ON55_",5," D %XY^%RCR
"RTN","PSIVORFB",86,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSIVORFB",87,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK
"RTN","PSIVORFB",88,0)
 I $G(PSJCOM),$G(PSJCOMSI),$G(PSJORD)["V" K PSJCOMSI N PSJCHILD,PSJOEORD S PSJOEORD=0 F  S PSJOEORD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD)) Q:'PSJOEORD  D
"RTN","PSIVORFB",89,0)
 . N PSJCHILD S PSJCHILD=0 F  S PSJCHILD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD,PSJCHILD)) Q:'PSJCHILD  S PSJCHILD(+PSJCHILD)=PSJCOM
"RTN","PSIVORFB",90,0)
 . S PSJCHILD=0 F  S PSJCHILD=$O(PSJCHILD(PSJCHILD)) Q:'PSJCHILD  D
"RTN","PSIVORFB",91,0)
 .. Q:PSJCHILD=PSJORD  K DR,DA,DIE,ORD S DR="31////"_$P($G(P("OPI")),"^",1,2),DA(1)=DFN
"RTN","PSIVORFB",92,0)
 .. N ON,ON55 S (ON,ON55)=+PSJCHILD_"V" S:+$G(PSJPINIT)'>0 PSJPINIT=DUZ S PSIVALT=1,PSIVAL="COMPLEX ORDER" D ENTACT^PSIVAL D
"RTN","PSIVORFB",93,0)
 ... I $P($G(^PS(55,DFN,"IV",+ON55,3)),"^")'=$P(P("OPI"),"^") S P("FC")="OTHER PRINT INFO^"_$P($G(^(3)),"^")_U_$P(P("OPI"),"^") D GTFC^PSIVORAL
"RTN","PSIVORFB",94,0)
 ... I $D(^PS(55,DFN,"IV",+ON55,0)) S ^PS(55,DFN,"IV",+ON55,3)=P("OPI") D EN1^PSJHL2(DFN,"XX",ON55)
"RTN","PSIVORFB",95,0)
 ... M ^PS(55,DFN,"IV",+ON55,10)=^TMP("PSJOPI",$J,6)
"RTN","PSIVORFB",96,0)
 K ^TMP("PSJOPI",$J)
"RTN","PSIVORFB",97,0)
 Q
"RTN","PSIVORFB",98,0)
 ;
"RTN","PSIVORFB",99,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSIVORFB",100,0)
 K ^PS(55,DFN,"IV",+ON55,DRGT) S ^PS(55,DFN,"IV",+ON55,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSIVORFB",101,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSIVORFB",102,0)
 .S Y=^PS(55,DFN,"IV",+ON55,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSIVORFB",103,0)
 .S ^PS(55,DFN,"IV",+ON55,DRGT,0)=Y,Y=$P(DRG(DRGT,X),U)_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^PS(55,DFN,"IV",+ON55,DRGT,+DRG,0)=Y
"RTN","PSIVORFB",104,0)
 Q
"RTN","PSIVORFB",105,0)
GT55 ; Retrieve data from 55 into local array
"RTN","PSIVORFB",106,0)
 K DRG,DRGN,P S:'$D(ON55) ON55=ON S P("REN")="",Y=$G(^PS(55,DFN,"IV",+ON55,0)) F X=1:1:25 S P(X)=$P(Y,U,X)
"RTN","PSIVORFB",107,0)
 S P("21FLG")=P(21)
"RTN","PSIVORFB",108,0)
 S P("PON")=ON55,PSJORIFN=P(21),P(6)=P(6)_U_$P($G(^VA(200,+P(6),0)),U),(DRG,DRGN)="",P("REM")=$G(^PS(55,DFN,"IV",+ON55,1))
"RTN","PSIVORFB",109,0)
 S Y=$G(^PS(55,DFN,"IV",+ON55,2)),P("LOG")=$P(Y,U),P("IVRM")=$P(Y,U,2)_U_$P($G(^PS(59.5,+$P(Y,U,2),0)),U)
"RTN","PSIVORFB",110,0)
 S P("CLRK")=$P(Y,U,11)_U_$P($G(^VA(200,+$P(Y,U,11),0)),U),P("RES")=$P(Y,U,8),P("FRES")=$P(Y,U,9),P("SYRS")=$P(Y,U,4),P("OPI")=$G(^PS(55,DFN,"IV",+ON55,3))
"RTN","PSIVORFB",111,0)
 S P("INS")=$G(^PS(55,DFN,"IV",+ON55,.3))
"RTN","PSIVORFB",112,0)
 S P("CLIN")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^"),P("APPT")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^",2)
"RTN","PSIVORFB",113,0)
 S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSIVORFB",114,0)
 D:'$D(PSJLABEL) GTPC(ON55) S ND=$G(^PS(55,DFN,"IV",+ON55,.2)),P("PD")=$S($P(ND,U):$P(ND,U)_U_$$OIDF^PSJLMUT1(+ND)_U_$P($G(^PS(50.7,+ND,0)),U),1:""),P("DO")=$P(ND,U,2),P("PRY")=$P(ND,U,4),P("NAT")=$P(ND,U,5),(PSJCOM,P("PRNTON"))=$P(ND,U,8)
"RTN","PSIVORFB",115,0)
 I P("PRY")="D",'+P("IVRM") S P("IVRM")=+$G(PSIVSN)_U_$P($G(^PS(59.5,+$G(PSIVSN),0)),U)
"RTN","PSIVORFB",116,0)
 S P("MR")=$P(ND,U,3),ND=$G(^PS(51.2,+P("MR"),0)),P("MR")=P("MR")_U_$S($P(ND,U,3)]"":$P(ND,U,3),1:$P(ND,U)) D GTCUM
"RTN","PSIVORFB",117,0)
 D GTDRG,GTOT^PSIVUTL(P(4))
"RTN","PSIVORFB",118,0)
 N ND2P5 S ND2P5=$G(^PS(55,DFN,"IV",+ON55,2.5)) D
"RTN","PSIVORFB",119,0)
 .S P("DUR")=$P(ND2P5,"^",2)
"RTN","PSIVORFB",120,0)
 .S P("LIMIT")=$P(ND2P5,"^",4)
"RTN","PSIVORFB",121,0)
 .S P("IVCAT")=$P(ND2P5,"^",5)
"RTN","PSIVORFB",122,0)
K ; Kill and exit.
"RTN","PSIVORFB",123,0)
 K FIL,ND
"RTN","PSIVORFB",124,0)
 Q
"RTN","PSIVORFB",125,0)
GTDRG ; Get drug info and place in DRG(.
"RTN","PSIVORFB",126,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F Y=0:0 S Y=$O(^PS(55,DFN,"IV",+ON55,DRGT,Y)) Q:'Y  D
"RTN","PSIVORFB",127,0)
 .; naked ref below refers to line above
"RTN","PSIVORFB",128,0)
 .S DRG=$G(^(Y,0)),ND=$G(^PS(FIL,+DRG,0)),(DRGI,DRG(DRGT,0))=$G(DRG(DRGT,0))+1
"RTN","PSIVORFB",129,0)
 .S DRG(DRGT,+DRGI)=+DRG_U_$P(ND,U)_U_$P(DRG,U,2)_U_$P(DRG,U,3)_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSIVORFB",130,0)
 Q
"RTN","PSIVORFB",131,0)
 ;
"RTN","PSIVORFB",132,0)
GTCUM ; Retrieve dispensing info.
"RTN","PSIVORFB",133,0)
 S ND=$G(^PS(55,DFN,"IV",+ON55,9)),P("LF")=$P(ND,U),P("LFA")=$P(ND,U,2),P("CUM")=$P(ND,U,3)
"RTN","PSIVORFB",134,0)
 Q
"RTN","PSIVORFB",135,0)
 ;
"RTN","PSIVORFB",136,0)
GTPC(ON) ; Retrieve Provider Comments and create "scratch" fields to edit
"RTN","PSIVORFB",137,0)
 Q
"RTN","PSIVORFB",138,0)
 ;
"RTN","PSIVORFB",139,0)
SETNEW ; Create new order and set
"RTN","PSIVORFB",140,0)
 D NEW55,SET55
"RTN","PSIVORFB",141,0)
 Q
"RTN","PSIVORFB",142,0)
 ;
"RTN","PSIVORFB",143,0)
CMPLIM(PSJORD,PSJDSTP1,PSJDSTP2) ; Compare stop date of order against IV Limit
"RTN","PSIVORFB",144,0)
 I $P($G(^PS(53.1,+PSJORD,0)),"^",25)]"" D CHKD Q:PSJPAO 0
"RTN","PSIVORFB",145,0)
 I $G(PSJDSTP1),$E(+PSJDSTP1,1,11)'=$E(+P(3),1,11),+PSJDSTP2'=+P(3) Q 1
"RTN","PSIVORFB",146,0)
 Q 0
"RTN","PSIVORFB",147,0)
 ;
"RTN","PSIVORFB",148,0)
LIMSTOP(PSJDSTP1,PSJDSTP2) ; Calculate default stop date using IV Limit
"RTN","PSIVORFB",149,0)
 ;      Output: PSJDSTP1 - Default stop using duration only
"RTN","PSIVORFB",150,0)
 ;              PSJDSTP2 - Default stop using duration and IV parameters for time
"RTN","PSIVORFB",151,0)
 S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",152,0)
 I 'PSIVLIM,PSIVLIM]"" S PSIVLIM=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD)
"RTN","PSIVORFB",153,0)
 I PSIVLIM]"" D
"RTN","PSIVORFB",154,0)
 . S MINS=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD),PSJDSTP1=$$FMADD^XLFDT(P(2),,,MINS)
"RTN","PSIVORFB",155,0)
 . S X=$P(PSJDSTP1,"."),PSJDSTP2=X_$S($P($G(PSIVSITE),"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14))
"RTN","PSIVORFB",156,0)
 Q
"RTN","PSIVORFB",157,0)
 ;
"RTN","PSIVORFB",158,0)
GETFRQ(PSJSKED) ;Get frequency using name of schedule
"RTN","PSIVORFB",159,0)
 I PSJSKED="" K PSJSKED Q ""
"RTN","PSIVORFB",160,0)
 S (PSJCNTX,PSJFRQ)=""
"RTN","PSIVORFB",161,0)
 I $D(^PS(51.1,"APPSJ",PSJSKED)) F  S PSJCNTX=$O(^PS(51.1,"APPSJ",PSJSKED,PSJCNTX)) Q:PSJCNTX=""  D  Q:$G(PSJFRQ)'=""
"RTN","PSIVORFB",162,0)
 . I $P($G(^PS(51.1,PSJCNTX,0)),U,3)'="" S PSJFRQ=$P(^PS(51.1,PSJCNTX,0),U,3)
"RTN","PSIVORFB",163,0)
 K PSJCNTX
"RTN","PSIVORFB",164,0)
 Q PSJFRQ
"RTN","PSIVORFB",165,0)
 ;
"RTN","PSIVORFB",166,0)
CHKD ;Check for a previous active order and compare the duration
"RTN","PSIVORFB",167,0)
 N PSJPO,A,PSJDUR
"RTN","PSIVORFB",168,0)
 S PSJDUR=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",169,0)
 S PSJPAO=0,PSJPO=PSJORD
"RTN","PSIVORFB",170,0)
CHKDR S PSJPO=$P($G(^PS(53.1,+PSJPO,0)),"^",25) Q:PSJPO=""
"RTN","PSIVORFB",171,0)
 I PSJPO["P" G CHKDR
"RTN","PSIVORFB",172,0)
 I PSJPO["V" S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJPO) I PSJDUR'=PSIVLIM S PSJPAO=1 Q
"RTN","PSIVORFB",173,0)
 G CHKDR
"RTN","PSIVORFB",174,0)
 ;
"RTN","PSIVORFB",175,0)
LOGOPI(DFN,ON55) ; Log OPI activity into activity log
"RTN","PSIVORFB",176,0)
 N PSJPICHK
"RTN","PSIVORFB",177,0)
 I ON55["V" D
"RTN","PSIVORFB",178,0)
 .I ($G(P("PON"))["V"),($G(ON55)["V"),(ON55'=P("PON")) D
"RTN","PSIVORFB",179,0)
 ..K PSJARRY1,PSJARRY2 M PSJARRY1=^PS(53.45,+$G(PSJSYSP),6),PSJARRY2=^PS(55,DFN,"IV",+P("PON"),10) S PSJPICHK='$$DIFFAR^PSJBCMA5(.PSJARRY1,.PSJARRY2)
"RTN","PSIVORFB",180,0)
 .Q:$G(PSJPICHK)
"RTN","PSIVORFB",181,0)
 .N PSIVALCK,PSIVRA,PSIVLN,PSIVLSTA S PSIVLN=$O(^PS(55,DFN,"IV",+ON55,"A",""),-1)+1
"RTN","PSIVORFB",182,0)
 .K PSJARRY1,PSJARRY2 S PSJARRY1="",PSJARRY2="" M PSJARRY1=^PS(53.45,+$G(PSJSYSP),6),PSJARRY2=^PS(55,DFN,"IV",+ON55,10) Q:'$$DIFFAR^PSJBCMA5(.PSJARRY1,.PSJARRY2)
"RTN","PSIVORFB",183,0)
 .S P("FC")="OTHER PRINT INFO^"_$P($G(^PS(55,DFN,"IV",+ON55,3)),"^")_U_$P($G(P("OPI")),"^"),PSIVALCK="OPI",PSIVREA="E" D LOG^PSIVORAL
"RTN","PSIVORFB",184,0)
 K PSJARRY1,PSJARRY2
"RTN","PSIVORFB",185,0)
 Q
"RTN","PSJ299PO")
0^6^B12136182
"RTN","PSJ299PO",1,0)
PSJ299PO ;BIR/LE-Post Install routine for patch PSJ*5*299 ;05/1/13
"RTN","PSJ299PO",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**299**;9/30/97;Build 11
"RTN","PSJ299PO",3,0)
 ;
"RTN","PSJ299PO",4,0)
QUE ;
"RTN","PSJ299PO",5,0)
 N NAMSP,PATCH,JOBN,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,Y,ZTQUEUED,ZTREQ,ZTSAVE,CNT,SBJM,RESTART,SMSG
"RTN","PSJ299PO",6,0)
 S NAMSP="PSJ299PO"
"RTN","PSJ299PO",7,0)
 S JOBN="PSJ*5*299 Post Install"
"RTN","PSJ299PO",8,0)
 S PATCH="PSJ*5*299"
"RTN","PSJ299PO",9,0)
 S Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSJ299PO",10,0)
 ;
"RTN","PSJ299PO",11,0)
 I '$G(RESTART) D
"RTN","PSJ299PO",12,0)
 .D BMES^XPDUTL("=============================================================")
"RTN","PSJ299PO",13,0)
 .D MES^XPDUTL("Queuing background job for "_JOBN_"...")
"RTN","PSJ299PO",14,0)
 .D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSJ299PO",15,0)
 .D MES^XPDUTL("A MailMan message will be sent to the installer upon Post")
"RTN","PSJ299PO",16,0)
 .D MES^XPDUTL("Install Completion.  This may take 2-3 hours.")
"RTN","PSJ299PO",17,0)
 .D MES^XPDUTL("==============================================================")
"RTN","PSJ299PO",18,0)
 E  D
"RTN","PSJ299PO",19,0)
 .W !,"============================================================="
"RTN","PSJ299PO",20,0)
 .W !,"Queuing background job for "_JOBN_"..."
"RTN","PSJ299PO",21,0)
 .W !,"A MailMan message will be sent to the installer upon Post"
"RTN","PSJ299PO",22,0)
 .W !,"Install Completion.  This may take 2-3 hours."
"RTN","PSJ299PO",23,0)
 .W !,"=============================================================="
"RTN","PSJ299PO",24,0)
 ;
"RTN","PSJ299PO",25,0)
 S ZTRTN="EN^"_NAMSP,ZTIO=""
"RTN","PSJ299PO",26,0)
 S (SBJM,ZTDESC)="Background job for "_JOBN
"RTN","PSJ299PO",27,0)
 S ZTSAVE("JOBN")="",ZTSAVE("ZTDTH")="",ZTSAVE("DUZ")="",ZTSAVE("SBJM")=""
"RTN","PSJ299PO",28,0)
 D ^%ZTLOAD
"RTN","PSJ299PO",29,0)
 D:$D(ZTSK)
"RTN","PSJ299PO",30,0)
 . S SMSG="*** Task #"_ZTSK_" Queued! ***"
"RTN","PSJ299PO",31,0)
 . I '$G(RESTART) D MES^XPDUTL(SMSG)
"RTN","PSJ299PO",32,0)
 . E  W !,SMSG
"RTN","PSJ299PO",33,0)
 . I '$G(RESTART) D BMES^XPDUTL("")
"RTN","PSJ299PO",34,0)
 . S ZTSAVE("ZTSK")=""
"RTN","PSJ299PO",35,0)
 I '$G(RESTART) D BMES^XPDUTL("")
"RTN","PSJ299PO",36,0)
 K XPDQUES
"RTN","PSJ299PO",37,0)
 Q
"RTN","PSJ299PO",38,0)
 ;
"RTN","PSJ299PO",39,0)
EN ;Do Mail Message
"RTN","PSJ299PO",40,0)
 N DFN,DA,STARTH,STOPH,SUBJ
"RTN","PSJ299PO",41,0)
 S STARTH=$$HTE^XLFDT(ZTDTH)
"RTN","PSJ299PO",42,0)
 K DIK S DIK="^PS(53.1,",DIK(1)="113^CIMO" D ENALL2^DIK,ENALL^DIK
"RTN","PSJ299PO",43,0)
 S DFN=0 F  S DFN=$O(^PS(55,DFN)) Q:'DFN  S DA(1)=DFN D
"RTN","PSJ299PO",44,0)
 .K DIK S DIK="^PS(55,"_DA(1)_",5,",DIK(1)="130^CIMOU" D ENALL2^DIK,ENALL^DIK
"RTN","PSJ299PO",45,0)
 .K DIK S DIK="^PS(55,"_DA(1)_",5,",DIK(1)="130^CIMOCLU" D ENALL2^DIK,ENALL^DIK
"RTN","PSJ299PO",46,0)
 .K DIK S DIK="^PS(55,"_DA(1)_","_"""IV"""_",",DIK(1)="136^CIMOI" D ENALL2^DIK,ENALL^DIK
"RTN","PSJ299PO",47,0)
 .K DIK S DIK="^PS(55,"_DA(1)_","_"""IV"""_",",DIK(1)="136^CIMOCLI" D ENALL2^DIK,ENALL^DIK
"RTN","PSJ299PO",48,0)
 K DIK
"RTN","PSJ299PO",49,0)
 ;
"RTN","PSJ299PO",50,0)
 ;Send message
"RTN","PSJ299PO",51,0)
 S CNT=1
"RTN","PSJ299PO",52,0)
 S Y=$$NOW^XLFDT S STOPH=$$FMTH^XLFDT(Y),STOPH=$$HTE^XLFDT(STOPH)
"RTN","PSJ299PO",53,0)
 S SUBJ="PSJ*5*299 POST INSTALL Complete"
"RTN","PSJ299PO",54,0)
 S MSG(CNT)="The IMO Clinic cross references have been re-indexed:",CNT=CNT+1
"RTN","PSJ299PO",55,0)
 S MSG(CNT)=" ",CNT=CNT+1
"RTN","PSJ299PO",56,0)
 S MSG(CNT)="     File 53.1 - CIMO",CNT=CNT+1
"RTN","PSJ299PO",57,0)
 S MSG(CNT)="      File 55  - CIMOU and CIMOCLU for Unit Dose Sub-file.",CNT=CNT+1
"RTN","PSJ299PO",58,0)
 S MSG(CNT)="      File 55  - CIMOI AND CIMOCLI for IV Sub-file.",CNT=CNT+1
"RTN","PSJ299PO",59,0)
 S MSG(CNT)=" ",CNT=CNT+1
"RTN","PSJ299PO",60,0)
 S MSG(CNT)="The background job "_ZTSK_" began "_STARTH_" and ",CNT=CNT+1
"RTN","PSJ299PO",61,0)
 S MSG(CNT)="ended "_STOPH_".",CNT=CNT+1
"RTN","PSJ299PO",62,0)
 D MAIL(.MSG,SUBJ)
"RTN","PSJ299PO",63,0)
 Q
"RTN","PSJ299PO",64,0)
 ;
"RTN","PSJ299PO",65,0)
MAIL(MSG,SBJ) ; Send out some mail!
"RTN","PSJ299PO",66,0)
 N DIFROM,XMDUZ,XMSUB,XMTEXT,XMY,I
"RTN","PSJ299PO",67,0)
 S XMDUZ="INPT PHARMACY",XMSUB=SBJM,XMTEXT="MSG("
"RTN","PSJ299PO",68,0)
 S XMY(DUZ)=""
"RTN","PSJ299PO",69,0)
 D ^XMD
"RTN","PSJ299PO",70,0)
 Q ""
"RTN","PSJ299PO",71,0)
 ;
"RTN","PSJ299PO",72,0)
RESTART ;restart post install if error occurs
"RTN","PSJ299PO",73,0)
 I $G(DUZ)="" W !,"Your DUZ is not defined.  It must be defined to run this routine." Q
"RTN","PSJ299PO",74,0)
 S RESTART=1
"RTN","PSJ299PO",75,0)
 D QUE
"RTN","PSJ299PO",76,0)
 Q
"RTN","PSJBLDOC")
0^1^B54439928
"RTN","PSJBLDOC",1,0)
PSJBLDOC ;BIR/MV - API to build ^TMP for prospective and PSJ profile drugs ;03 Aug 98 / 8:42 AM
"RTN","PSJBLDOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,263,260,295,252,257,299**;16 DEC 97;Build 11
"RTN","PSJBLDOC",3,0)
 ;
"RTN","PSJBLDOC",4,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJBLDOC",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJBLDOC",6,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBLDOC",7,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJBLDOC",8,0)
 ; Reference to ^PSSDSAPM is supported by DBIA# 5570.
"RTN","PSJBLDOC",9,0)
 ;
"RTN","PSJBLDOC",10,0)
IN(DFN,LIST,PDRG,PTYP) ;
"RTN","PSJBLDOC",11,0)
 ;Build the IPM profiles and the prospective drugs list for both PSO & PSJ if PDRG is passed in.
"RTN","PSJBLDOC",12,0)
 ;DFN - PATIENT DFN
"RTN","PSJBLDOC",13,0)
 ;LIST - BASE
"RTN","PSJBLDOC",14,0)
 ;PDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSJBLDOC",15,0)
 ;       Where n is a sequential number.  Drug name can be OI, Generic name from #50 or Additive/sol name
"RTN","PSJBLDOC",16,0)
 ;PTYP - P1;P2 where P1="I" for Inpatient & "O" for Outpatient, P2= PSJ order#
"RTN","PSJBLDOC",17,0)
 NEW PSJONCNT,PSJDCNT,PSJDRGND,PSJWON
"RTN","PSJBLDOC",18,0)
 S PSJONCNT=0
"RTN","PSJBLDOC",19,0)
 S PSJWON=$P($G(PTYP),";",2)
"RTN","PSJBLDOC",20,0)
 D PROFILE(DFN,PSJWON,PTYP)
"RTN","PSJBLDOC",21,0)
 K ^TMP($J,"PSJPRE","CLINIC")
"RTN","PSJBLDOC",22,0)
 Q
"RTN","PSJBLDOC",23,0)
PROFILE(DFN,PSJWON,PTYP)     ;Setup ^TMP for the active meds to be on the OC profile list.
"RTN","PSJBLDOC",24,0)
 ;DFN:    Patient internal entry number
"RTN","PSJBLDOC",25,0)
 ;PSJWON: The current order number being working on.  It can be null.
"RTN","PSJBLDOC",26,0)
 ;        It is the order being work on (RN, FN..) and should be on the prospective list.
"RTN","PSJBLDOC",27,0)
 ;Output: ^TMP($J,"ORDERS",PSJINX)=DRUG CLASS^NATIONAL DRUG FILE ENTRY
"RTN","PSJBLDOC",28,0)
 ;        _"A"_PSNDFA PRODUCT NAME ENTRY_DISPENSE DRUG NAME^OE/RR #
"RTN","PSJBLDOC",29,0)
 ;        _ORDER NUMBER(P/I/V)_";I"
"RTN","PSJBLDOC",30,0)
 ;
"RTN","PSJBLDOC",31,0)
 NEW BDT,COD,DDRUG,DDRUGND,EDT,F,ON,ON1,PST,WBDT,X,PSJORIEN,%,PSJCLCOD,PSJCLINF,PSJCLIND,PSJTYPCL,PSJCLNPR
"RTN","PSJBLDOC",32,0)
 S PSJWON=$G(PSJWON),PSJCLCOD=""
"RTN","PSJBLDOC",33,0)
 ;
"RTN","PSJBLDOC",34,0)
 ;Must display any DC/Expired clinic orders within largest number of days defined for whichever clinic has the oldest date defined for ORDER CHECK DC/EXPIRED DAYS field
"RTN","PSJBLDOC",35,0)
 ;under the CLINIC DEFINITION file (#53.46)
"RTN","PSJBLDOC",36,0)
 ;Active, non-verified, pending, hold clinic orders must be displayed in the clinic display format.
"RTN","PSJBLDOC",37,0)
 D CLINICS^PSJCLNOC(DFN)  ;get clinic orders for this patient and set ^TMP($J,"PSJPRE","CLINIC",IEN,FILE_TYPE)=""
"RTN","PSJBLDOC",38,0)
 I $D(^TMP($J,"PSJPRE","CLINIC")) S PSJCLNPR=1 D
"RTN","PSJBLDOC",39,0)
 .S (PSJTYPCL,ON)="" F  S ON=$O(^TMP($J,"PSJPRE","CLINIC",ON)) Q:ON=""  F  S PSJTYPCL=$O(^TMP($J,"PSJPRE","CLINIC",ON,PSJTYPCL)) Q:PSJTYPCL=""  D
"RTN","PSJBLDOC",40,0)
 ..S F="^PS(55,DFN,5,"
"RTN","PSJBLDOC",41,0)
 ..I PSJTYPCL["55U" S COD=ON_"U",PSJCLCOD=2 D:COD'=PSJWON UD Q
"RTN","PSJBLDOC",42,0)
 ..I PSJTYPCL["55I" S COD=ON_"V" S PSJCLCOD=1 D:COD'=PSJWON IV Q
"RTN","PSJBLDOC",43,0)
 ..S F="^PS(53.1,"
"RTN","PSJBLDOC",44,0)
 ..S COD=ON_"P" Q:COD=PSJWON!($D(PSJVFF)&(COD=$G(PSJORD)))
"RTN","PSJBLDOC",45,0)
 ..I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",46,0)
 ..I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) S PSJCLCOD=3 D PIV Q
"RTN","PSJBLDOC",47,0)
 ..I $$GET1^DIQ(53.1,+ON,4,"I")="I" S PSJCLCOD=5
"RTN","PSJBLDOC",48,0)
 ..S PSJCLCOD=4 D UD
"RTN","PSJBLDOC",49,0)
 S PSJCLNPR=1
"RTN","PSJBLDOC",50,0)
 ;
"RTN","PSJBLDOC",51,0)
 D NOW^%DTC S (BDT,WBDT)=%,EDT=9999999  ; WBDT SET THIS WAY BEFORE CLINIC OC DISPLAY ADDED
"RTN","PSJBLDOC",52,0)
 S F="^PS(55,DFN,5," F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  S COD=ON_"U",PSJCLCOD=2 D:COD'=PSJWON UD
"RTN","PSJBLDOC",53,0)
 S WBDT=BDT,F="^PS(53.1,",PSJCLCOD="" F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  D
"RTN","PSJBLDOC",54,0)
 . S COD=ON_"P" Q:COD=PSJWON!($D(PSJVFF)&(COD=$G(PSJORD)))
"RTN","PSJBLDOC",55,0)
 . I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",56,0)
 . I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) S PSJCLCOD=3 D PIV Q
"RTN","PSJBLDOC",57,0)
 . S PSJCLCOD=4
"RTN","PSJBLDOC",58,0)
 . I $$GET1^DIQ(53.1,+ON,4,"I")="I" S PSJCLCOD=5
"RTN","PSJBLDOC",59,0)
 . D UD
"RTN","PSJBLDOC",60,0)
 S WBDT=BDT F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  S COD=ON_"V" S PSJCLCOD=1 D:COD'=PSJWON IV
"RTN","PSJBLDOC",61,0)
 K PSJWON
"RTN","PSJBLDOC",62,0)
 Q
"RTN","PSJBLDOC",63,0)
UD ;Get the dispense drugs for the Unit Dose orders.
"RTN","PSJBLDOC",64,0)
 NEW X,PSJQUIT,PSJCNT,DDRUG,DDRUGN,PSJX,PSJOI,PSJEXPDD,PSJUTMP,PSJEDOVR,PSJCLNX,PSJCLDAT,PSJCLDAY,PSJSTOP
"RTN","PSJBLDOC",65,0)
 S X=@(F_ON_",0)")
"RTN","PSJBLDOC",66,0)
 Q:$P(X,U,9)="R"
"RTN","PSJBLDOC",67,0)
 S (PSJEDOVR,PSJCLINF,PSJCLNX,PSJCLDAY,PSJSTOP)=0,PSJCLDAT="",PSJCLNX=$P(X,U,9)
"RTN","PSJBLDOC",68,0)
 I $D(^TMP($J,"PSJPRE","CLINIC",+ON,$S(PSJCLCOD=5:"531I",PSJCLCOD=2:"55U",1:"531U"))) S PSJCLINF=1
"RTN","PSJBLDOC",69,0)
 I PSJCLCOD=4!(PSJCLCOD=5) Q:PSJCLINF&($P(X,U,9)'="P"&($P(X,U,9)'="N"))
"RTN","PSJBLDOC",70,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",71,0)
 Q:$P(X,U,9)["D"&('PSJCLINF)
"RTN","PSJBLDOC",72,0)
 Q:$P(X,U,9)="E"&('PSJCLINF)
"RTN","PSJBLDOC",73,0)
 S PSJORIEN=$P(X,U,21),DDRUG=0
"RTN","PSJBLDOC",74,0)
 ;
"RTN","PSJBLDOC",75,0)
 ;Use the first active DD within the order. If >1 DD, use OI_Dosage form for display name
"RTN","PSJBLDOC",76,0)
 S ON1=0,PSJCNT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'ON1  S PSJCNT=PSJCNT+1
"RTN","PSJBLDOC",77,0)
 S PSJOI=+$G(@(F_ON_",.2)"))
"RTN","PSJBLDOC",78,0)
 S ON1=0,PSJQUIT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'+ON1!PSJQUIT  S DDRUG=@(F_ON_",1,"_ON1_",0)") D
"RTN","PSJBLDOC",79,0)
 . Q:'+DDRUG
"RTN","PSJBLDOC",80,0)
 . S PSJX=$P(DDRUG,U,3)
"RTN","PSJBLDOC",81,0)
 . I 'PSJCLINF,PSJX]"",(PSJX'>BDT) Q
"RTN","PSJBLDOC",82,0)
 . D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) S PSJQUIT=1
"RTN","PSJBLDOC",83,0)
 ;Quit when an active DD within the order if found
"RTN","PSJBLDOC",84,0)
 Q:+$G(PSJQUIT)
"RTN","PSJBLDOC",85,0)
 ;
"RTN","PSJBLDOC",86,0)
 ;No DD found from the order. Get one from the OI
"RTN","PSJBLDOC",87,0)
 I '+PSJOI D SETIN("PROFILE","NOT FOUND: "_COD,"",COD,1,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",88,0)
 S DDRUG=$P($$DRG^PSSDSAPM(+PSJOI,"I"),U)
"RTN","PSJBLDOC",89,0)
 I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",90,0)
 ;
"RTN","PSJBLDOC",91,0)
 ;Get the first DD from OI (CCR5665 - set exception if pending order has no DD assigned and none is active. PSJ*5*252 t9)
"RTN","PSJBLDOC",92,0)
 I ($G(COD)'["P"),('+DDRUG) S DDRUG=$O(^PSDRUG("ASP",PSJOI,0)) I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",93,0)
 ;
"RTN","PSJBLDOC",94,0)
 ;Set exception when no DD found
"RTN","PSJBLDOC",95,0)
 I '+DDRUG D SETIN("PROFILE",$$OIDF^PSJLMUT1(+$G(PSJOI)),"",COD,1,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",96,0)
 Q
"RTN","PSJBLDOC",97,0)
PIV ;Get the dispense drugs for the Pending IV orders.
"RTN","PSJBLDOC",98,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM,PSJCLNTY
"RTN","PSJBLDOC",99,0)
 S PSJX=^PS(53.1,+ON,0),PSJORIEN=$P(PSJX,U,21) Q:$P(PSJX,U,27)="R"
"RTN","PSJBLDOC",100,0)
 S (PSJEDOVR,PSJCLINF,PSJCLNTY)=0,PSJCLNTY=$$GET1^DIQ(53.1,+ON,4,"I")
"RTN","PSJBLDOC",101,0)
 S:$D(^TMP($J,"PSJPRE","CLINIC",+ON,531_PSJCLNTY)) PSJCLINF=1
"RTN","PSJBLDOC",102,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",103,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",104,0)
 . S PSJX=^PS(53.1,+ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",105,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",106,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",107,0)
 . D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",108,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",109,0)
 . S PSJX=^PS(53.1,+ON,"SOL",ON1,0) D
"RTN","PSJBLDOC",110,0)
 . I $$PREMIX^PSJMISC(+PSJX) D
"RTN","PSJBLDOC",111,0)
 .. S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",112,0)
 .. S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",113,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",114,0)
 .. D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",115,0)
 Q
"RTN","PSJBLDOC",116,0)
IV ;Get the dispense drugs for the IV orders.
"RTN","PSJBLDOC",117,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM,PSJCLNX,PSJSTOP
"RTN","PSJBLDOC",118,0)
 S PSJX=^PS(55,DFN,"IV",ON,0),PSJORIEN=$P(PSJX,U,21),(PSJCLINF,PSJCLNX)=0,PSJCLNX=$P(PSJX,U,17)
"RTN","PSJBLDOC",119,0)
 Q:$P(PSJX,U,17)="R"
"RTN","PSJBLDOC",120,0)
 I $D(^TMP($J,"PSJPRE","CLINIC",+ON,"55I")) S PSJCLINF=1
"RTN","PSJBLDOC",121,0)
 I PSJCLCOD=4!(PSJCLCOD=5) Q:PSJCLINF&($P(PSJX,U,17)'="P"&($P(PSJX,U,17)'="N"))
"RTN","PSJBLDOC",122,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",123,0)
 Q:$P(PSJX,U,17)["D"&('PSJCLINF)
"RTN","PSJBLDOC",124,0)
 Q:$P(PSJX,U,17)="E"&('PSJCLINF)
"RTN","PSJBLDOC",125,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",126,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",127,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",128,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",129,0)
 . D SETIN("PROFILE",PSJNM,DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",130,0)
 ; Only include Pre-mix in the OC.
"RTN","PSJBLDOC",131,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",132,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"SOL",ON1,0)
"RTN","PSJBLDOC",133,0)
 . I $$PREMIX^PSJMISC(+PSJX) D
"RTN","PSJBLDOC",134,0)
 .. S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",135,0)
 .. S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",136,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",137,0)
 .. D SETIN("PROFILE",PSJNM,DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",138,0)
 Q
"RTN","PSJBLDOC",139,0)
SETIN(PSJFLG,PSJNM,DDRUG,ON,PSJCODE,PSJCLCOD,PSJCLINF) ;Set ^TMP($J,"PSJPRE,"IN" arrays.
"RTN","PSJBLDOC",140,0)
 ;ON = ON with "U/V/P"
"RTN","PSJBLDOC",141,0)
 ;PSJFLG = "PROSPECTIVE" or "PROFILE"
"RTN","PSJBLDOC",142,0)
 ;PSJNM = This should be the AD/SOL print name or IV order.  Use Dispense drug name if U/D order
"RTN","PSJBLDOC",143,0)
 ;PSJPON = 4 piece pharmacy order #
"RTN","PSJBLDOC",144,0)
 NEW PSJPON
"RTN","PSJBLDOC",145,0)
 Q:$G(PSJFLG)=""
"RTN","PSJBLDOC",146,0)
 S PSJONCNT=$G(PSJONCNT)+1
"RTN","PSJBLDOC",147,0)
 S PSJPON=$S(PSJCLINF:"C"_PSJCLCOD_";",1:"I;")_ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",148,0)
 I $P(PSJCODE,";")="O" S PSJPON="C"_PSJCLCOD_";"_+ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",149,0)
 I '+$G(DDRUG) D  Q
"RTN","PSJBLDOC",150,0)
 . I +$G(PSJCODE) D NODD($G(PSJCODE),PSJNM,PSJPON,LIST)
"RTN","PSJBLDOC",151,0)
 Q:$$SUP^PSSDSAPI(+DDRUG)
"RTN","PSJBLDOC",152,0)
 I $G(PSJNM)="" S PSJNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",153,0)
 S PSJFLG=$S($G(PSJDGCK):"PROSPECTIVE",1:"PROFILE") ;when using DX hidden action
"RTN","PSJBLDOC",154,0)
 S ^TMP($J,LIST,"IN",PSJFLG,PSJPON)=+$$GCN^PSJMISC(+DDRUG)_U_$$GTVUID^PSJMISC(+DDRUG)_U_+DDRUG_U_PSJNM_U_$G(PSJORIEN)_U_"I"_U_PSJCLCOD_";"_PSJCLINF
"RTN","PSJBLDOC",155,0)
 Q
"RTN","PSJBLDOC",156,0)
IV0(PSJAD,PSIVIEN) ;Return ad/sol zero node
"RTN","PSJBLDOC",157,0)
 ;PSJAD = "AD" is passed in if it additive, otherwise it's null
"RTN","PSJBLDOC",158,0)
 I PSJAD="AD" Q $G(^PS(52.6,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",159,0)
 I $G(PSJAD)="" Q $G(^PS(52.7,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",160,0)
 Q ""
"RTN","PSJBLDOC",161,0)
NODD(PSJCODE,PSJOIDF,PSJPON,PSJBASE) ;Set ^TMP for OI without a dispense drug
"RTN","PSJBLDOC",162,0)
 ;PSJCODE - A numeric code to trigger the appropriate exception message 
"RTN","PSJBLDOC",163,0)
 ;PSJOIDF - Orderable Item name_Dose form (can be CPRS OI)
"RTN","PSJBLDOC",164,0)
 ;PSJPON - Pharmacy order #
"RTN","PSJBLDOC",165,0)
 ;PSJBASE - Base subscript
"RTN","PSJBLDOC",166,0)
 Q:$G(PSJOIDF)=""
"RTN","PSJBLDOC",167,0)
 Q:$G(PSJBASE)=""
"RTN","PSJBLDOC",168,0)
 Q:'+$G(PSJCODE)
"RTN","PSJBLDOC",169,0)
 ;S PSJIV("OI_ERROR",PSJOIDF)=$G(PSJCODE)_U_$G(PSJPON)
"RTN","PSJBLDOC",170,0)
 S ^TMP($J,PSJBASE,"IN","EXCEPTIONS","OI",PSJOIDF)=PSJCODE_U_$G(PSJPON)
"RTN","PSJBLDOC",171,0)
 Q
"RTN","PSJCLNOC")
0^2^B86092468
"RTN","PSJCLNOC",1,0)
PSJCLNOC ;BIR/LE - Clinic Order Check Utilities ;26 FEB 12 / 12:42 PM
"RTN","PSJCLNOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**260,257,299**;16 DEC 97;Build 11
"RTN","PSJCLNOC",3,0)
 ;Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSJCLNOC",4,0)
 ;
"RTN","PSJCLNOC",5,0)
CLINICS(PSJDFN) ;
"RTN","PSJCLNOC",6,0)
 ;Only clinics with yes to ADMINISTER INPATIENT MEDS in SET UP A CLINIC option and Rx's where a clinic and appt date/time are defined for the Rx are stored in 
"RTN","PSJCLNOC",7,0)
 ;the CIMO, CIMOU and CIMOI cross references. 
"RTN","PSJCLNOC",8,0)
 N X,X1,X2,PSJSTDT,PSJCLIN,PSJCLINF,ORDID,PSJSTA,PSJUTMP,PSJTYP,PSJCANEX,PSJCLCOD,PST,PSJSTPDT,PSJTODAY,PSJCLIN,PSJXREF,PSJAPTDT,CLNDAYS,CLNDAY,OLDEST,PSJSTOP
"RTN","PSJCLNOC",9,0)
 N CLFILIEN,PSJTYPE,PSJSTAT
"RTN","PSJCLNOC",10,0)
 D NOW^%DTC S PSJTODAY=%
"RTN","PSJCLNOC",11,0)
 K ^TMP($J,"PSJPRE","CLINIC")
"RTN","PSJCLNOC",12,0)
 S (PSJSTDT,PSJCLIN,PSJCLINF,ORDID,PSJCLIN,CLFILIEN,CLNDAYS,CLNDAY,OLDEST)=""
"RTN","PSJCLNOC",13,0)
 S X1=PSJTODAY,X2=-120 D C^%DTC S (CLNDAY,PSJSTDT)=X
"RTN","PSJCLNOC",14,0)
 S PSJXREF="CIMOU"
"RTN","PSJCLNOC",15,0)
 F  S PSJCLIN=$O(^PS(55,PSJXREF,PSJDFN,PSJCLIN)) Q:PSJCLIN=""  D GETCLINF D
"RTN","PSJCLNOC",16,0)
 .F  S PSJSTDT=$O(^PS(55,PSJXREF,PSJDFN,PSJCLIN,PSJSTDT)) Q:PSJSTDT=""  F  S ORDID=$O(^PS(55,PSJXREF,PSJDFN,PSJCLIN,PSJSTDT,PSJDFN,ORDID)) Q:ORDID=""  D
"RTN","PSJCLNOC",17,0)
 ..D SETTMP
"RTN","PSJCLNOC",18,0)
 S PSJXREF="CIMOI",(PSJCLIN,ORDID)="",PSJSTDT=CLNDAY
"RTN","PSJCLNOC",19,0)
 F  S PSJCLIN=$O(^PS(55,PSJDFN,"IV",PSJXREF,PSJCLIN)) Q:PSJCLIN=""  D GETCLINF D
"RTN","PSJCLNOC",20,0)
 .F  S PSJSTDT=$O(^PS(55,PSJDFN,"IV",PSJXREF,PSJCLIN,PSJSTDT)) Q:PSJSTDT=""  F  S ORDID=$O(^PS(55,PSJDFN,"IV",PSJXREF,PSJCLIN,PSJSTDT,ORDID)) Q:ORDID=""  D
"RTN","PSJCLNOC",21,0)
 ..D SETTMP
"RTN","PSJCLNOC",22,0)
 ;
"RTN","PSJCLNOC",23,0)
D531 ;
"RTN","PSJCLNOC",24,0)
 S X1=PSJTODAY,X2=-120 D C^%DTC S (CLNDAY,PSJSTDT)=X
"RTN","PSJCLNOC",25,0)
 S (PSJSTDT,PSJCLIN,PSJCLINF,ORDID,PSJCLIN,CLFILIEN,CLNDAYS,CLNDAY,PSJTYPE)="",X1=PSJTODAY,X2=-120 D C^%DTC S PSJSTDT=X
"RTN","PSJCLNOC",26,0)
 F  S PSJCLIN=$O(^PS(53.1,"CIMO",PSJDFN,PSJCLIN)) Q:PSJCLIN=""  F  S ORDID=$O(^PS(53.1,"CIMO",PSJDFN,PSJCLIN,ORDID)) Q:ORDID=""  D
"RTN","PSJCLNOC",27,0)
 .S PSJSTAT=$$GET1^DIQ(53.1,ORDID,28)
"RTN","PSJCLNOC",28,0)
 .Q:PSJSTAT'="P"&(PSJSTAT'="N")
"RTN","PSJCLNOC",29,0)
 .S CLFILIEN="",CLFILIEN=$O(^PS(53.46,"B",PSJCLIN,CLFILIEN)),(CLNDAYS,CLNDAY,OLDEST)=""
"RTN","PSJCLNOC",30,0)
 .S CLNDAYS=$$GET1^DIQ(53.46,CLFILIEN,6)
"RTN","PSJCLNOC",31,0)
 .S PSJTYPE=$$GET1^DIQ(53.1,ORDID,4,"I")
"RTN","PSJCLNOC",32,0)
 .I CLNDAYS="" S CLNDAYS=30
"RTN","PSJCLNOC",33,0)
 .S X1=PSJTODAY,X2=-CLNDAYS D C^%DTC S (PSJSTDT,CLNDAY)=X
"RTN","PSJCLNOC",34,0)
 .S ^TMP($J,"PSJPRE","CLINIC",ORDID,531_PSJTYPE)=CLNDAYS_"^"_PSJSTDT_"^"_PSJCLIN
"RTN","PSJCLNOC",35,0)
 Q
"RTN","PSJCLNOC",36,0)
 ;
"RTN","PSJCLNOC",37,0)
SETTMP ;
"RTN","PSJCLNOC",38,0)
 S ^TMP($J,"PSJPRE","CLINIC",ORDID,$S(PSJXREF="CIMOU":"55U",1:"55I"))=CLNDAYS_"^"_PSJSTDT_"^"_PSJCLIN
"RTN","PSJCLNOC",39,0)
 Q
"RTN","PSJCLNOC",40,0)
 ;
"RTN","PSJCLNOC",41,0)
GETCLINF ;
"RTN","PSJCLNOC",42,0)
 S CLFILIEN="",CLFILIEN=$O(^PS(53.46,"B",PSJCLIN,CLFILIEN)),(CLNDAYS,CLNDAY,OLDEST)=""
"RTN","PSJCLNOC",43,0)
 S CLNDAYS=$$GET1^DIQ(53.46,CLFILIEN,6)
"RTN","PSJCLNOC",44,0)
 I CLNDAYS="" S CLNDAYS=30
"RTN","PSJCLNOC",45,0)
 S X1=PSJTODAY,X2=-CLNDAYS D C^%DTC S (PSJSTDT,CLNDAY)=X
"RTN","PSJCLNOC",46,0)
 ;S OLDEST="",OLDEST=$G(^TMP($J,"PSJPRE","CLINIC","OLDEST")) I CLNDAYS>OLDEST S ^TMP($J,"PSJPRE","CLINIC","OLDEST")=CLNDAYS
"RTN","PSJCLNOC",47,0)
 Q
"RTN","PSJCLNOC",48,0)
 ;----------------------------------
"RTN","PSJCLNOC",49,0)
CANEXP(DFN,ON,PSJCLCOD) ;
"RTN","PSJCLNOC",50,0)
 N FILE,ORTYPE,PIECE,FLDS,FLD1,FLD2,FLD3
"RTN","PSJCLNOC",51,0)
 S ORTYPE=$P(PSJCLCOD,";")
"RTN","PSJCLNOC",52,0)
 I ORTYPE=1 S FILE=55.06,FLDS=".03;100;109",FLD1=.03,FLD2=109,FLD3=100
"RTN","PSJCLNOC",53,0)
 I ORTYPE=2 S FILE=55.06,FLDS="28;34;48",FLD1=34,FLD2=48,FLD3=28
"RTN","PSJCLNOC",54,0)
 I ORTYPE=3!(ORTYPE=4) S FILE=53.1,FLDS="25;28;38",FLD1=25,FLD2=38,FLD3=28
"RTN","PSJCLNOC",55,0)
 ;
"RTN","PSJCLNOC",56,0)
CE ;check to see if Rx is outside the stop date + 90 days time frame
"RTN","PSJCLNOC",57,0)
 N CANEXPDT,PSJUTMP,PSJDCEXD,X1,X2,X,PSJCLNX
"RTN","PSJCLNOC",58,0)
 S (PSJCLNX,PSJDCEXD,CANEXPDT,X,X1,X2)=""
"RTN","PSJCLNOC",59,0)
 D GETS^DIQ(FILE,ON_","_DFN,FLDS,"I","PSJUTMP")
"RTN","PSJCLNOC",60,0)
 S:$D(PSJUTMP(FILE,ON_","_DFN_",",FLD3,"I")) PSJCLNX=PSJUTMP(FILE,ON_","_DFN_",",FLD3,"I")
"RTN","PSJCLNOC",61,0)
 S:'$D(PSJCLNX) PSJCLNX="" Q:PSJCLNX=""!('$D(PSJCLNX)) 0
"RTN","PSJCLNOC",62,0)
 I PSJCLNX="D" S:$D(PSJUTMP(FILE,ON_","_DFN_",",FLD1,"I")) CANEXPDT=PSJUTMP(FILE,ON_","_DFN_",",FLD1,"I")
"RTN","PSJCLNOC",63,0)
 I PSJCLNX="E"!(CANEXPDT="") S:$D(PSJUTMP(FILE,ON_","_DFN_",",FLD2,"I")) CANEXPDT=PSJUTMP(FILE,ON_","_DFN_",",FLD2,"I")
"RTN","PSJCLNOC",64,0)
 I CANEXPDT="" Q 0
"RTN","PSJCLNOC",65,0)
 S X1=CANEXPDT,X2=90 D C^%DTC S PSJDCEXD=X
"RTN","PSJCLNOC",66,0)
 I BDT>PSJDCEXD Q 0
"RTN","PSJCLNOC",67,0)
 Q 1
"RTN","PSJCLNOC",68,0)
 ;---------------------------------
"RTN","PSJCLNOC",69,0)
SETIN(PSJFLG,PSJPON,PSJNM,PSJCLCOD) ;
"RTN","PSJCLNOC",70,0)
 N TMP,STATUS,STARTDT,STOPDT,SCHEDULE,DOSAGE,ORDID,PSJCDFN,TYPE,FLG,INFUSE
"RTN","PSJCLNOC",71,0)
 S ORDID=$P(PSJCLCOD,";",1),PSJCDFN=$P(PSJCLCOD,";",3)
"RTN","PSJCLNOC",72,0)
 S TYPE="IN"
"RTN","PSJCLNOC",73,0)
 S ^TMP($J,LIST,"CLINIC",PSJPON)=ORDID_"^"_PSJCDFN_"^"_PSJNM_"^"_$P(PSJCLCOD,";",2)
"RTN","PSJCLNOC",74,0)
 Q
"RTN","PSJCLNOC",75,0)
 ;
"RTN","PSJCLNOC",76,0)
GET(PSJCON,PSJCDFN,ORDID,PSJCCODE,PSJNM,PSJCGET)  ;
"RTN","PSJCLNOC",77,0)
 N TYPE,LIST
"RTN","PSJCLNOC",78,0)
 S TYPE="IN",LIST="PSJPRE",(DOSAGE,STATUS,STARTDT,STOPDT,SCHEDULE,INFUSE,STARTDTF,STOPDTF)=""
"RTN","PSJCLNOC",79,0)
 I PSJCCODE=1 S FLG=0 D GETF55
"RTN","PSJCLNOC",80,0)
 I PSJCCODE=2 S FLG=1 D GETF55
"RTN","PSJCLNOC",81,0)
 I PSJCCODE=3 D GETF531
"RTN","PSJCLNOC",82,0)
 I PSJCCODE=4!(PSJCCODE=5) D GETF531
"RTN","PSJCLNOC",83,0)
 Q
"RTN","PSJCLNOC",84,0)
 ;
"RTN","PSJCLNOC",85,0)
GETF55 ;get file 55 clinic info
"RTN","PSJCLNOC",86,0)
 D GETS^DIQ($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN,$S(FLG:"10;26;28;34;59;109",1:".02;.03;.08;.09;100;131"),,"TMP")
"RTN","PSJCLNOC",87,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:28,1:100))) STATUS=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:28,1:100))
"RTN","PSJCLNOC",88,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:10,1:.02))) STARTDT=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:10,1:.02))
"RTN","PSJCLNOC",89,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:34,1:.03))) STOPDT=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:34,1:.03))
"RTN","PSJCLNOC",90,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:26,1:.09))) SCHEDULE=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:26,1:.09))
"RTN","PSJCLNOC",91,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:109,1:131))) DOSAGE=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:109,1:131))
"RTN","PSJCLNOC",92,0)
 S:$D(TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:59,1:.08))) INFUSE=TMP($S(FLG:55.06,1:55.01),ORDID_","_PSJCDFN_",",$S(FLG:59,1:.08))
"RTN","PSJCLNOC",93,0)
 S PSJCGET(ORDID)=STATUS_"^"_STARTDT_"^"_STOPDT_"^"_SCHEDULE_"^"_DOSAGE_"^"_INFUSE_"^"_PSJNM
"RTN","PSJCLNOC",94,0)
 Q:PSJCCODE=2!(PSJCCODE=4)
"RTN","PSJCLNOC",95,0)
 ;IV additives and solutions
"RTN","PSJCLNOC",96,0)
 N ON1,PSJX,DDRUG,PSJ0,PSJDNAM
"RTN","PSJCLNOC",97,0)
 S ON1=0 F  S ON1=$O(^PS(55,PSJCDFN,"IV",ORDID,"AD",ON1)) Q:'ON1!(ON1'?1N.N)   D
"RTN","PSJCLNOC",98,0)
 . S PSJX=^PS(55,PSJCDFN,"IV",ORDID,"AD",ON1,0),PSJ0=$$IV0^PSJBLDOC("AD",+PSJX)
"RTN","PSJCLNOC",99,0)
 . S DDRUG=$P(PSJ0,U,2),PSJDNAM=$P(PSJ0,U)_" "_$P(PSJX,U,2)
"RTN","PSJCLNOC",100,0)
 . S PSJCGET(ORDID,"ADDITIVE",ON1)=PSJDNAM_"^"_DDRUG_"^"_ORDID_"^"_$P(PSJX,"^",3)
"RTN","PSJCLNOC",101,0)
 ; Pre-mix in the OC.
"RTN","PSJCLNOC",102,0)
 S ON1=0 F  S ON1=$O(^PS(55,PSJCDFN,"IV",ORDID,"SOL",ON1)) Q:'ON1!(ON1'?1N.N)   D
"RTN","PSJCLNOC",103,0)
 . S PSJX=^PS(55,PSJCDFN,"IV",ORDID,"SOL",ON1,0)
"RTN","PSJCLNOC",104,0)
 . S PSJ0=$$IV0^PSJBLDOC("",+PSJX),DDRUG=$P(PSJ0,U,2)
"RTN","PSJCLNOC",105,0)
 . S PSJDNAM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJCLNOC",106,0)
 . S PSJCGET(ORDID,"SOLUTION",ON1)=PSJDNAM_"^"_DDRUG_"^"_INFUSE
"RTN","PSJCLNOC",107,0)
 Q
"RTN","PSJCLNOC",108,0)
 ;
"RTN","PSJCLNOC",109,0)
GETF531 ;get file 53.1 clinic info
"RTN","PSJCLNOC",110,0)
 D GETS^DIQ(53.1,ORDID_","_PSJCDFN,"28;10;25;26;27;109;115;116;117",,"TMP")
"RTN","PSJCLNOC",111,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",28)) STATUS=TMP(53.1,ORDID_","_PSJCDFN_",",28)
"RTN","PSJCLNOC",112,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",10)) STARTDT=TMP(53.1,ORDID_","_PSJCDFN_",",10)
"RTN","PSJCLNOC",113,0)
 I STARTDT="" S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",115)) STARTDT=TMP(53.1,ORDID_","_PSJCDFN_",",115) S:STARTDT'="" STARTDTF=1
"RTN","PSJCLNOC",114,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",116)) DURATION=TMP(53.1,ORDID_","_PSJCDFN_",",116)
"RTN","PSJCLNOC",115,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",25)) STOPDT=TMP(53.1,ORDID_","_PSJCDFN_",",25)
"RTN","PSJCLNOC",116,0)
 I STOPDT="" S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",117)) STOPDT=TMP(53.1,ORDID_","_PSJCDFN_",",117) S:STOPDT'="" STOPDTF=1
"RTN","PSJCLNOC",117,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",27)) ORDDATE=TMP(53.1,ORDID_","_PSJCDFN_",",27)
"RTN","PSJCLNOC",118,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",26)) SCHEDULE=TMP(53.1,ORDID_","_PSJCDFN_",",26)
"RTN","PSJCLNOC",119,0)
 S:$D(TMP(53.1,ORDID_","_PSJCDFN_",",109)) DOSAGE=TMP(53.1,ORDID_","_PSJCDFN_",",109)
"RTN","PSJCLNOC",120,0)
 S PSJCGET(ORDID)=STATUS_"^"_STARTDT_"^"_STOPDT_"^"_SCHEDULE_"^"_DOSAGE_"^"_INFUSE_"^"_PSJNM_"^"_STARTDTF_"^"_STOPDTF_"^"_ORDDATE
"RTN","PSJCLNOC",121,0)
  ;IV additives and solutions
"RTN","PSJCLNOC",122,0)
 N ON1,PSJX,DDRUG,ADDITIVE,SOLUTION,PSJ0,PSJDNAM
"RTN","PSJCLNOC",123,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,ORDID,"AD",ON1)) Q:'ON1!(ON1'?1N.N)  D
"RTN","PSJCLNOC",124,0)
 . S PSJX=^PS(53.1,ORDID,"AD",ON1,0),PSJ0=$$IV0^PSJBLDOC("AD",+PSJX)
"RTN","PSJCLNOC",125,0)
 . S DDRUG=$P(PSJ0,U,2),PSJDNAM=$P(PSJ0,U)_" "_$P(PSJX,U,2)
"RTN","PSJCLNOC",126,0)
 . S PSJCGET(ORDID,"ADDITIVE",ON1)=PSJDNAM_"^"_DDRUG_"^"_ORDID_"^"_$P(PSJX,"^",3)
"RTN","PSJCLNOC",127,0)
 ; Pre-mix in the OC.
"RTN","PSJCLNOC",128,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,ORDID,"SOL",ON1)) Q:'ON1!(ON1'?1N.N)   D
"RTN","PSJCLNOC",129,0)
 . S PSJX=^PS(53.1,ORDID,"SOL",ON1,0)
"RTN","PSJCLNOC",130,0)
 . S PSJ0=$$IV0^PSJBLDOC("",+PSJX)
"RTN","PSJCLNOC",131,0)
 . S DDRUG=$P(PSJ0,U,2)
"RTN","PSJCLNOC",132,0)
 . S PSJDNAM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJCLNOC",133,0)
 . S PSJCGET(ORDID,"SOLUTION",ON1)=PSJDNAM_"^"_DDRUG_"^"_INFUSE
"RTN","PSJCLNOC",134,0)
 Q
"RTN","PSJCLNOC",135,0)
 ;
"RTN","PSJCLNOC",136,0)
DISPCLN(PSJP,PSJCLINF) ;
"RTN","PSJCLNOC",137,0)
 N DRGNAME,STATUS,STARTDT,STOPDT,SCHEDULE,ORDID,DOSAGE,DATA,PSJDSPON,PSJCON,PSJCDFN,PSJCGET,INFUSE,PSJCCODE,DURATION,STARTDTF,STOPDTF,ORDDATE
"RTN","PSJCLNOC",138,0)
 I $G(PSJSORT)>10 S PSJDSPON($P(PSJP(4),";",2))=""
"RTN","PSJCLNOC",139,0)
DISP2 ;
"RTN","PSJCLNOC",140,0)
 S PSJCON=PSJP(4),PSJCGET=""
"RTN","PSJCLNOC",141,0)
 S PSJCDFN=DFN
"RTN","PSJCLNOC",142,0)
 S ORDID=$P(PSJCON,";",2),ORDID=+ORDID
"RTN","PSJCLNOC",143,0)
 S PSJCCODE=$P(PSJCLINF,";",1)
"RTN","PSJCLNOC",144,0)
 S (DRGNAME,PSJNM)=PSJP(2)
"RTN","PSJCLNOC",145,0)
 D GET(PSJCON,PSJCDFN,ORDID,PSJCCODE,PSJNM,.PSJCGET)
"RTN","PSJCLNOC",146,0)
 S DATA="",DATA=PSJCGET(ORDID)
"RTN","PSJCLNOC",147,0)
 Q:DATA=""
"RTN","PSJCLNOC",148,0)
 S (STATUS,STARTDT,STOPDT,SCHEDULE,DOSAGE)=""
"RTN","PSJCLNOC",149,0)
 S STATUS=$P(DATA,"^",1),STARTDT=$P(DATA,"^",2),STOPDT=$P(DATA,"^",3),SCHEDULE=$P(DATA,"^",4),DOSAGE=$P(DATA,"^",5)
"RTN","PSJCLNOC",150,0)
 S STARTDTF=$P(DATA,"^",8),STOPDTF=$P(DATA,"^",9),ORDDATE=$P(DATA,"^",10)
"RTN","PSJCLNOC",151,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJCLNOC",152,0)
 W !,$J("Clinic Order: ",23)_DRGNAME_" ("_STATUS_")"
"RTN","PSJCLNOC",153,0)
 I $D(PSJCGET(ORDID,"ADDITIVE"))!($D(PSJCGET(ORDID,"SOLUTION"))) D IVDISP G EXIT
"RTN","PSJCLNOC",154,0)
 W !,$J("Schedule: ",23),SCHEDULE
"RTN","PSJCLNOC",155,0)
 W !,$J("Dosage: ",23),DOSAGE
"RTN","PSJCLNOC",156,0)
 I STARTDT=""&(ORDDATE'="") W !,$J("Order Date: ",23),ORDDATE
"RTN","PSJCLNOC",157,0)
 I STARTDT'="" W !,$J($S($G(STARTDTF):"Requested Start Date: ",1:"Start Date: "),23),STARTDT
"RTN","PSJCLNOC",158,0)
 E  W !,$J("Start Date: ",23),"********"
"RTN","PSJCLNOC",159,0)
 I STOPDT'="" W !,$J($S($G(STOPDTF):"Requested Stop Date: ",1:"Stop Date: "),23),STOPDT
"RTN","PSJCLNOC",160,0)
 E  W !,$J("Stop Date: ",23),"********"
"RTN","PSJCLNOC",161,0)
 W !
"RTN","PSJCLNOC",162,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJCLNOC",163,0)
EXIT ;
"RTN","PSJCLNOC",164,0)
 K PSJCGET
"RTN","PSJCLNOC",165,0)
 Q 
"RTN","PSJCLNOC",166,0)
 ;
"RTN","PSJCLNOC",167,0)
CLNDISP(PSJCLINF) ;
"RTN","PSJCLNOC",168,0)
 N DRGNAME,STATUS,STARTDT,STOPDT,SCHEDULE,ORDID,DOSAGE,DATA,PSJDSPON,PSJCON,PSJCDFN,PSJCGET,INFUSE,PSJCCODE,PSJP,STARTDTF,STOPDTF,ORDDATE
"RTN","PSJCLNOC",169,0)
 S PSJP(2)=PSJCLINF(3)
"RTN","PSJCLNOC",170,0)
 S PSJP(4)=PSJCLINF(2)
"RTN","PSJCLNOC",171,0)
 D DISP2
"RTN","PSJCLNOC",172,0)
 Q
"RTN","PSJCLNOC",173,0)
 ;
"RTN","PSJCLNOC",174,0)
IVDISP ;
"RTN","PSJCLNOC",175,0)
 N SEQ,ADATA,SDATA,DNAM,BOTTLE,AFLG,SFLG,SSEQ,SNAM,ADDS
"RTN","PSJCLNOC",176,0)
 S ADDS="",SEQ=0 F  S SEQ=$O(PSJCGET(ORDID,"ADDITIVE",SEQ)) Q:SEQ=""  D
"RTN","PSJCLNOC",177,0)
 .S ADATA=PSJCGET(ORDID,"ADDITIVE",SEQ)
"RTN","PSJCLNOC",178,0)
 .S DNAM=$P(ADATA,"^")
"RTN","PSJCLNOC",179,0)
 .Q:DNAM=DRGNAME
"RTN","PSJCLNOC",180,0)
 .S BOTTLE=$P(ADATA,"^",4)
"RTN","PSJCLNOC",181,0)
 .I '$G(AFLG) S ADDS=DNAM S:BOTTLE'="" ADDS=ADDS_" ("_BOTTLE_")"
"RTN","PSJCLNOC",182,0)
 .I $G(AFLG) S ADDS=ADDS_", "_DNAM S:BOTTLE'="" ADDS=ADDS_" ("_BOTTLE_")"
"RTN","PSJCLNOC",183,0)
 .W:'$G(AFLG) !,$J("Other Additive(s): ",23)
"RTN","PSJCLNOC",184,0)
 .S:'$G(AFLG) AFLG=1
"RTN","PSJCLNOC",185,0)
 I $G(AFLG) D MYWRITE^PSJMISC(ADDS,23,78)
"RTN","PSJCLNOC",186,0)
 S (SDATA,SNAM,INFUSE,SFLG)="",SSEQ=0
"RTN","PSJCLNOC",187,0)
 S SSEQ=0 F  S SSEQ=$O(PSJCGET(ORDID,"SOLUTION",SSEQ)) Q:SSEQ=""  D
"RTN","PSJCLNOC",188,0)
 .S SDATA=PSJCGET(ORDID,"SOLUTION",SSEQ)
"RTN","PSJCLNOC",189,0)
 .S SNAM=$P(SDATA,"^",1),INFUSE=$P(SDATA,"^",3)
"RTN","PSJCLNOC",190,0)
 .W:'$G(SFLG) !,$J("Solution(s): ",23)_SNAM_" "_INFUSE
"RTN","PSJCLNOC",191,0)
 .I $G(SFLG) W !?23,SNAM_" "_INFUSE
"RTN","PSJCLNOC",192,0)
 .S SFLG=1
"RTN","PSJCLNOC",193,0)
 W:SCHEDULE'="" !,$J("Schedule: ",23),SCHEDULE
"RTN","PSJCLNOC",194,0)
 I STARTDT=""&(ORDDATE'="") W !,$J("Order Date: ",23),ORDDATE
"RTN","PSJCLNOC",195,0)
 I STARTDT'="" W !,$J($S($G(STARTDTF):"Requested Start Date: ",1:"Start Date: "),23),STARTDT
"RTN","PSJCLNOC",196,0)
 E  W !,$J("Start Date: ",23),"********"
"RTN","PSJCLNOC",197,0)
 I STOPDT'="" W !,$J($S($G(STOPDTF):"Requested Stop Date: ",1:"Stop Date: "),23),STOPDT
"RTN","PSJCLNOC",198,0)
 E  W !,$J("Stop Date: ",23),"********"
"RTN","PSJCLNOC",199,0)
 W !
"RTN","PSJCLNOC",200,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJCLNOC",201,0)
 Q
"RTN","PSJHL6")
0^10^B32286288
"RTN","PSJHL6",1,0)
PSJHL6 ;BIR/LDT-ACTIONS ON HL7 MESSAGES FROM OE/RR (CONT) ;02 Mar 99 / 9:26 AM
"RTN","PSJHL6",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**1,11,27,34,40,42,51,59,88,98,181,263,299**;16 DEC 97;Build 11
"RTN","PSJHL6",3,0)
 ;
"RTN","PSJHL6",4,0)
 ; Reference to EN^ORERR is supported by DBIA# 2187.
"RTN","PSJHL6",5,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL6",6,0)
 ;
"RTN","PSJHL6",7,0)
CANCEL ;Cancel or Discontinue orders thru OE/RR
"RTN","PSJHL6",8,0)
 N DA,DR,DIE,STATUS,STPDT,NODE,NODE2,PSREASON,PSIVACT,PSIVALT,ON55,PSIVREA,PSIVALCK,P,PSJADC
"RTN","PSJHL6",9,0)
 S NODE=$G(@(RXORDER_"0)")),NODE2=$G(@(RXORDER_"2)"))
"RTN","PSJHL6",10,0)
 I 'NODE S PSREASON="Invalid Pharmacy order number" D  Q
"RTN","PSJHL6",11,0)
 .S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(PSREASON_"/DC Msg",.PSJMSG)
"RTN","PSJHL6",12,0)
 .D EN1^PSJHLERR(PSJHLDFN,$S(PSOC="CA":"UC",1:"UD"),$P(ORDER,U),PSREASON)
"RTN","PSJHL6",13,0)
 I RXON["P",PSJHLDFN'=$P(NODE,U,15) S ORDCON="Patient does not match/Discontinue Msg" D  Q
"RTN","PSJHL6",14,0)
 .S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON,.PSJMSG)
"RTN","PSJHL6",15,0)
 .D EN1^PSJHLERR(PSJHLDFN,$S(PSOC="CA":"UC",1:"UD"),$P(ORDER,U),ORDCON)
"RTN","PSJHL6",16,0)
 S $P(@(RXORDER_"0)"),"^",21)=$P(ORDER,"^",1)
"RTN","PSJHL6",17,0)
 S STATUS=$S(RXON["V":$P(NODE,"^",17),1:$P(NODE,"^",9))
"RTN","PSJHL6",18,0)
 S STPDT=$S(RXON["V":$P(NODE,"^",3),1:$P(NODE2,"^",4))
"RTN","PSJHL6",19,0)
 I "AHNOPR"'[STATUS D @STATUS S PSREASON=PSREASON_" orders may not be "_$S(PSOC="CA":"cancelled",1:"discontinued") D EN1^PSJHL2(PSJHLDFN,$S(PSOC="CA":"UC",1:"UD"),RXON,PSREASON) Q
"RTN","PSJHL6",20,0)
 S:(RXON["A")!(RXON["U")!(RXON["V") DA(1)=PSJHLDFN,DA=+RXON
"RTN","PSJHL6",21,0)
 S PSJADC=$S($G(ORDCON)="A":"DA",1:"DP")
"RTN","PSJHL6",22,0)
 D NOW^%DTC
"RTN","PSJHL6",23,0)
 S DIE=$S(RXON["V":"^PS(55,"_PSJHLDFN_",""IV"",",(RXON["N")!(RXON["P"):"^PS(53.1,",1:"^PS(55,"_PSJHLDFN_",5,"),DA=+RXON
"RTN","PSJHL6",24,0)
 I (RXON["N")!(RXON["P") D KILL531^PSJIMO1(PSJHLDFN,"",+RXON)
"RTN","PSJHL6",25,0)
 S DR=$S(RXON["V":"100////D;157////"_PSJADC_";116////^S X=STPDT;.03////",(RXON["N")!(RXON["P"):"28////D;25////",1:"25////^S X=STPDT;28////D;136////"_PSJADC_";34////")_$S($G(ORDCON)="A"&($G(PSJASTP)'=""):$G(PSJASTP),1:%)
"RTN","PSJHL6",26,0)
 I RXON["A"!(RXON["U") S PSGAL("C")=$S($G(ORDCON)="A":1040,1:4000) D ^PSGAL5
"RTN","PSJHL6",27,0)
 I RXON["V" S PSIVACT=1,PSIVALT=$S($G(ORDCON)="A":"",1:2),PSIVAL=$S($G(ORDCON)="A":"AUTO DISCONTINUED  (TREATING SPECIALTY TRANSFER)",1:""),ON55=RXON,PSIVREA="D",P(3)=STPDT
"RTN","PSJHL6",28,0)
 S:$G(ORDCON)="A" DR=$S(RXON["V":DR_";121////1",RXON["N"!(RXON["P"):DR_";42////1",1:DR_";49////1")
"RTN","PSJHL6",29,0)
 D ^DIE
"RTN","PSJHL6",30,0)
 S:$G(ORDCON)="A" $P(^PS(55,PSJHLDFN,5.1),"^")=""
"RTN","PSJHL6",31,0)
 I RXON["V" N DFN S DFN=PSJHLDFN D LOG^PSIVORAL
"RTN","PSJHL6",32,0)
 D EN1^PSJHL2(PSJHLDFN,$S(PSOC="CA":"CR",1:"DR"),RXON)
"RTN","PSJHL6",33,0)
 D NOW^%DTC I "ANR"[STATUS I STPDT<% D EXPIR Q
"RTN","PSJHL6",34,0)
 D AUE(PSJHLDFN,RXON)
"RTN","PSJHL6",35,0)
 Q
"RTN","PSJHL6",36,0)
 ;
"RTN","PSJHL6",37,0)
HOLD ;Place orders on hold thru OE/RR and check for expired orders
"RTN","PSJHL6",38,0)
 N DA,DR,DIE,STATUS,STPDT,NODE,NODE2,PSREASON,PSIVACT,PSIVALT,PSIVREA,ON55
"RTN","PSJHL6",39,0)
 S NODE=$G(@(RXORDER_"0)")),NODE2=$G(@(RXORDER_"2)"))
"RTN","PSJHL6",40,0)
 I 'NODE S PSREASON="Invalid Pharmacy order number" D  Q
"RTN","PSJHL6",41,0)
 .S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(PSREASON_"/Hold Msg",.PSJMSG)
"RTN","PSJHL6",42,0)
 .D EN1^PSJHLERR(PSJHLDFN,"UH",$P(ORDER,U),PSREASON)
"RTN","PSJHL6",43,0)
 S $P(@(RXORDER_"0)"),"^",21)=$P(ORDER,"^",1)
"RTN","PSJHL6",44,0)
 S STATUS=$S(RXON["V":$P(NODE,"^",17),1:$P(NODE,"^",9))
"RTN","PSJHL6",45,0)
 S STPDT=$S(RXON["V":$P(NODE,"^",3),1:$P(NODE2,"^",4))
"RTN","PSJHL6",46,0)
 D NOW^%DTC I "ANR"[STATUS I STPDT<% D EXPIR
"RTN","PSJHL6",47,0)
 I STATUS'="A" D @STATUS S PSREASON=PSREASON_" orders may not be placed on hold" D EN1^PSJHL2(PSJHLDFN,"UH",RXON,PSREASON) Q
"RTN","PSJHL6",48,0)
 I STATUS="A" D
"RTN","PSJHL6",49,0)
 .S DA(1)=PSJHLDFN,DA=+RXON
"RTN","PSJHL6",50,0)
 .S DIE=$S(RXON["V":"^PS(55,"_PSJHLDFN_",""IV"",",1:"^PS(55,"_PSJHLDFN_",5,")
"RTN","PSJHL6",51,0)
 .S DR=$S(RXON["V":"100////H;157////HP;120////1;149////1",1:"28////H;136////HP;56////1;59////A;59.1////1;60////@;61////@;62////@;58////"_%)
"RTN","PSJHL6",52,0)
 I RXON["A"!(RXON["U") S PSGAL("C")=8500 D ^PSGAL5
"RTN","PSJHL6",53,0)
 S:RXON["V" PSIVACT=1,PSIVALT=2,PSIVREA="H",ON55=RXON
"RTN","PSJHL6",54,0)
 D ^DIE
"RTN","PSJHL6",55,0)
 I RXON["V" N DFN S DFN=PSJHLDFN D LOG^PSIVORAL
"RTN","PSJHL6",56,0)
 D EN1^PSJHL2(PSJHLDFN,"HR",RXON)
"RTN","PSJHL6",57,0)
 D NOW^%DTC I "ANR"[STATUS I STPDT<% D EXPIR Q
"RTN","PSJHL6",58,0)
 D AUE(PSJHLDFN,RXON)
"RTN","PSJHL6",59,0)
 Q
"RTN","PSJHL6",60,0)
 ;
"RTN","PSJHL6",61,0)
UNHOLD ;Change status of orders placed on hold thru OE/RR & check for expired orders
"RTN","PSJHL6",62,0)
 N DA,DR,DIE,STATUS,STPDT,NODE,NODE2,NODE4,HFLAG,PSREASON,PSIVACT,PSIVALT,PSIVREA,ON55
"RTN","PSJHL6",63,0)
 S NODE=$G(@(RXORDER_"0)")),NODE2=$G(@(RXORDER_"2)")),NODE4=$G(@(RXORDER_"4)"))
"RTN","PSJHL6",64,0)
 I 'NODE S PSREASON="Invalid Pharmacy order number" D  Q
"RTN","PSJHL6",65,0)
 .S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(PSREASON_"/Unhold Msg",.PSJMSG)
"RTN","PSJHL6",66,0)
 .D EN1^PSJHLERR(PSJHLDFN,"UR",$P(ORDER,U),PSREASON)
"RTN","PSJHL6",67,0)
 S $P(@(RXORDER_"0)"),"^",21)=$P(ORDER,"^",1)
"RTN","PSJHL6",68,0)
 S STATUS=$S(RXON["V":$P(NODE,"^",17),1:$P(NODE,"^",9))
"RTN","PSJHL6",69,0)
 S STPDT=$S(RXON["V":$P(NODE,"^",3),1:$P(NODE2,"^",4))
"RTN","PSJHL6",70,0)
 S HFLAG=$S(RXON["V":$P(NODE,"^",10),1:$P(NODE4,"^",26))
"RTN","PSJHL6",71,0)
 I 'HFLAG S PSREASON="Orders placed on hold by Pharmacy may not be removed from hold through CPRS." D EN1^PSJHL2(PSJHLDFN,"UR",RXON,PSREASON) Q
"RTN","PSJHL6",72,0)
 I "H"'[STATUS D @STATUS S PSREASON=PSREASON_" orders may not be taken off hold" D EN1^PSJHL2(PSJHLDFN,"UR",RXON,PSREASON) Q
"RTN","PSJHL6",73,0)
 I STATUS="H" S DA(1)=PSJHLDFN,DA=+RXON,DIE=$S(RXON["V":"^PS(55,"_PSJHLDFN_",""IV"",",1:"^PS(55,"_PSJHLDFN_",5,")
"RTN","PSJHL6",74,0)
 D NOW^%DTC
"RTN","PSJHL6",75,0)
 S DR=$S(RXON["V":"100////A;157////@;120////@;149////@",1:"28////A;136////@;56////@;57////@;58////@;59////@;59.1////@;60////1;62////"_%)
"RTN","PSJHL6",76,0)
 I RXON["A"!(RXON["U") S PSGAL("C")=8000 D ^PSGAL5
"RTN","PSJHL6",77,0)
 S:RXON["V" PSIVACT=1,PSIVALT=2,PSIVREA="U",ON55=RXON
"RTN","PSJHL6",78,0)
 D ^DIE
"RTN","PSJHL6",79,0)
 I RXON["V" N DFN S DFN=PSJHLDFN D LOG^PSIVORAL
"RTN","PSJHL6",80,0)
 D EN1^PSJHL2(PSJHLDFN,"OR",RXON)
"RTN","PSJHL6",81,0)
 D NOW^%DTC I "A"[STATUS I STPDT<% D EXPIR Q
"RTN","PSJHL6",82,0)
 D AUE(PSJHLDFN,RXON)
"RTN","PSJHL6",83,0)
 Q
"RTN","PSJHL6",84,0)
EXPIR ;Change status of order to expired and send notice to OE/RR
"RTN","PSJHL6",85,0)
 N DA,DIE,DR,PSGPO,PSIVACT
"RTN","PSJHL6",86,0)
 S STATUS="E",(PSGPO,PSIVACT)=1,DA=+RXON,DA(1)=PSJHLDFN,DIE=$S(RXON["V":"^PS(55,"_PSJHLDFN_",""IV"",",1:"^PS(55,"_PSJHLDFN_",5,"),DR=$S(RXON["V":"100////E",1:"28////E") D ^DIE
"RTN","PSJHL6",87,0)
 S PSJHLMTN="ORM" D EN1^PSJHL2(PSJHLDFN,"SC",RXON) S PSJHLMTN="ORR"
"RTN","PSJHL6",88,0)
 ;D AUE(PSJHLDFN,RXON)
"RTN","PSJHL6",89,0)
 Q
"RTN","PSJHL6",90,0)
AUE(PSJHLDFN,ON)        ; Set "AUE" xref for 55.06 if hold/unhold
"RTN","PSJHL6",91,0)
 I ON["A"!(ON["U") S ^PS(55,"AUE",PSJHLDFN,+ON)=""
"RTN","PSJHL6",92,0)
 Q
"RTN","PSJHL6",93,0)
 ;
"RTN","PSJHL6",94,0)
A S PSREASON="Active" Q
"RTN","PSJHL6",95,0)
D S PSREASON="Discontinued" Q
"RTN","PSJHL6",96,0)
I S PSREASON="Incomplete" Q
"RTN","PSJHL6",97,0)
N S PSREASON="Non-verified" Q
"RTN","PSJHL6",98,0)
U S PSREASON="Unreleased" Q
"RTN","PSJHL6",99,0)
P S PSREASON="Pending" Q
"RTN","PSJHL6",100,0)
DE S PSREASON="Discontinued (edit)" Q
"RTN","PSJHL6",101,0)
E S PSREASON="Expired" Q
"RTN","PSJHL6",102,0)
H S PSREASON="Hold" Q
"RTN","PSJHL6",103,0)
R S PSREASON="Renewed" Q
"RTN","PSJHL6",104,0)
RE S PSREASON="Reinstated" Q
"RTN","PSJHL6",105,0)
DR S PSREASON="Discontinued (renewal)" Q
"RTN","PSJHL6",106,0)
O S PSREASON="On call" Q
"RTN","PSJIMO1")
0^3^B65823354
"RTN","PSJIMO1",1,0)
PSJIMO1 ;BIR/LE-IMO UTILITIES AND XREFS ;16 Mar 99 / 10:22 AM
"RTN","PSJIMO1",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**257,299**;16 DEC 97;Build 11
"RTN","PSJIMO1",3,0)
 ;
"RTN","PSJIMO1",4,0)
IMO(CLINICS) ;called from ENCD^PSGFILED WHICH IS CLINIC DEFINITION OPTION IN INPATIENT MEDS
"RTN","PSJIMO1",5,0)
 W !!,"Verifying IMO clinic cross references...",!
"RTN","PSJIMO1",6,0)
 N CLINFLG,IMOCLIEN,PSJIMOCL,PSJCLIN,FLAG S FLAG=""
"RTN","PSJIMO1",7,0)
 S (CLINFLG,CLINIC,PSJIMOCL,IMOCLIEN)=""
"RTN","PSJIMO1",8,0)
 F  S IMOCLIEN=$O(CLINICS(IMOCLIEN)) Q:IMOCLIEN=""  S PSJIMOCL=$$GET1^DIQ(53.46,IMOCLIEN,.01,"I"),CLINFLG=$$GET1^DIQ(44,PSJIMOCL,2802,"I") D
"RTN","PSJIMO1",9,0)
 .I 'CLINFLG D IMOKILL(PSJIMOCL,CLINFLG) Q  ;CLINFLG=ADIMINISTER INPATIENT MEDS? true means IMO clinic; false means not IMO
"RTN","PSJIMO1",10,0)
 .I CLINFLG D IMOSET(PSJIMOCL,CLINFLG)
"RTN","PSJIMO1",11,0)
 I FLAG W !,"IMO cross references have been updated.",!
"RTN","PSJIMO1",12,0)
 Q
"RTN","PSJIMO1",13,0)
 ;
"RTN","PSJIMO1",14,0)
IMOSET(PSJCLIN,PSJIMOF) ;
"RTN","PSJIMO1",15,0)
 ;Clinic order means Yes is answered to ADMINISTER INPATIENT MEDS field in file 44, a clinic and appointment date/time is defined.
"RTN","PSJIMO1",16,0)
 ;Q:$D(^PS("CIMOCLU",CLINIC))!($D(^PS("CIMOCLI",CLINIC)))
"RTN","PSJIMO1",17,0)
 N CLNDAYS,PSJAPTDT,PSJTODAY,X1,X2,PATIENT,PSJSTDT,PS55IEN,PS531IEN,PSJXREF,PSJTYPE,APPTDT,PSJUTMP,PSJSTART
"RTN","PSJIMO1",18,0)
 S CLNDAYS=$$GET1^DIQ(53.46,CLINIC,6)
"RTN","PSJIMO1",19,0)
 S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",20,0)
 D NOW^%DTC S (X1,PSJTODAY)=%,X2=-CLNDAYS D C^%DTC S PSJSTART=X
"RTN","PSJIMO1",21,0)
 ;FILE 55
"RTN","PSJIMO1",22,0)
 F PSJXREF="AUDC","AIVC" S PSJSTDT=PSJSTART F  S PSJSTDT=$O(^PS(55,PSJXREF,PSJSTDT)) Q:PSJSTDT=""  D
"RTN","PSJIMO1",23,0)
 .S PATIENT="" F  S PATIENT=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT)) Q:PATIENT=""  S PS55IEN="" F  S PS55IEN=$O(^PS(55,PSJXREF,PSJSTDT,PSJCLIN,PATIENT,PS55IEN)) Q:PS55IEN=""  D
"RTN","PSJIMO1",24,0)
 ..I PSJXREF="AUDC" S PSJAPTDT=$$GET1^DIQ(55.06,PS55IEN_","_PATIENT_",",131) I PSJAPTDT'="" S ^PS(55,"CIMOU",PATIENT,PSJCLIN,PSJSTDT,PATIENT,PS55IEN)=""
"RTN","PSJIMO1",25,0)
 ..I PSJXREF="AIVC" S PSJAPTDT=$$GET1^DIQ(55.01,PS55IEN_","_PATIENT_",",139) I PSJAPTDT'="" S ^PS(55,PATIENT,"IV","CIMOI",PSJCLIN,PSJSTDT,PS55IEN)=""
"RTN","PSJIMO1",26,0)
 ..I PSJAPTDT'="" S FLAG=1
"RTN","PSJIMO1",27,0)
 ;
"RTN","PSJIMO1",28,0)
 ;FILE 53.1
"RTN","PSJIMO1",29,0)
 S (PATIENT,PS531IEN)=""
"RTN","PSJIMO1",30,0)
 F  S PATIENT=$O(^PS(53.1,"AD",PSJCLIN,PATIENT)) Q:PATIENT=""  F  S PS531IEN=$O(^PS(53.1,"AD",PSJCLIN,PATIENT,PS531IEN)) Q:PS531IEN=""  D
"RTN","PSJIMO1",31,0)
 .K PSJUTMP D GETS^DIQ(53.1,PS531IEN,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",32,0)
 .S (APPTDT,PSJTYPE)=""
"RTN","PSJIMO1",33,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",126,"I")) APPTDT=PSJUTMP(53.1,PS531IEN_",",126,"I")
"RTN","PSJIMO1",34,0)
 .S:$D(PSJUTMP(53.1,PS531IEN_",",28,"I")) PSJTYPE=PSJUTMP(53.1,PS531IEN_",",28,"I")
"RTN","PSJIMO1",35,0)
 .Q:PSJTYPE'="P"&(PSJTYPE'="N")
"RTN","PSJIMO1",36,0)
 .Q:APPTDT=""!'CLINFLG
"RTN","PSJIMO1",37,0)
 .S ^PS(53.1,"CIMO",PATIENT,PSJCLIN,PS531IEN)="",FLAG=1
"RTN","PSJIMO1",38,0)
 Q
"RTN","PSJIMO1",39,0)
 ;
"RTN","PSJIMO1",40,0)
IMOKILL(CLINIC) ;
"RTN","PSJIMO1",41,0)
 I $D(^PS(55,"CIMOCLU",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",42,0)
 .K ^PS(55,"CIMOU",PATIENT,CLINIC)
"RTN","PSJIMO1",43,0)
 I $D(^PS(55,"CIMOCLI",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(55,"CIMOCLU",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",44,0)
 .K ^PS(55,PATIENT,"IV","CIMOI",CLINIC)
"RTN","PSJIMO1",45,0)
 K ^PS(55,"CIMOCLU",CLINIC),^PS(55,"CIMOCLI",CLINIC)
"RTN","PSJIMO1",46,0)
 I $D(^PS(53.1,"AD",CLINIC)) S PATIENT="" F  S PATIENT=$O(^PS(53.1,"AD",CLINIC,PATIENT)) Q:PATIENT=""  D
"RTN","PSJIMO1",47,0)
 .I $D(^PS(53.1,"CIMO",PATIENT,CLINIC)) K ^PS(53.1,"CIMO",PATIENT,CLINIC)
"RTN","PSJIMO1",48,0)
 Q
"RTN","PSJIMO1",49,0)
 ;
"RTN","PSJIMO1",50,0)
CIMOU(PSGP,PSJDA55,PSCLINIC,PSJDA531) ;IMO UNIT DOSE FILE 55 CROSS REFERENCE SET
"RTN","PSJIMO1",51,0)
 N PSJCLINI,CLINFLG,PSJIVIEN,PSJSTAT
"RTN","PSJIMO1",52,0)
 S PSJSTAT=""
"RTN","PSJIMO1",53,0)
 I '$G(PSCLINIC) S PSCLINIC="",PSCLINIC=$$GET1^DIQ(55.06,+PSJDA55_","_PSGP_",",130,"I")
"RTN","PSJIMO1",54,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",55,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",56,0)
 Q:'CLINFLG
"RTN","PSJIMO1",57,0)
 D GETS^DIQ(55.06,+PSJDA55_","_PSGP_",","34;131","I","PSJCLINI")
"RTN","PSJIMO1",58,0)
 I CLINFLG&($G(PSJCLINI(55.06,+PSJDA55_","_PSGP_",","131","I"))) D
"RTN","PSJIMO1",59,0)
 .S ^PS(55,"CIMOU",PSGP,PSCLINIC,PSJCLINI(55.06,+PSJDA55_","_PSGP_",","34","I"),PSGP,+PSJDA55)=""
"RTN","PSJIMO1",60,0)
 .S ^PS(55,"CIMOCLU",PSCLINIC,PSGP,+PSJDA55)=""
"RTN","PSJIMO1",61,0)
 S PSJIVIEN=$$GET1^DIQ(55.06,+PSJDA55_","_DFN_",",104)  ;pick up ien from file 55 since PSJORD/PSGORD can't be trusted.
"RTN","PSJIMO1",62,0)
 S:PSJIVIEN="" PSJIVIEN=PSJDA531
"RTN","PSJIMO1",63,0)
 I '$D(^PS(53.1,"CIMO",PSGP,PSCLINIC,PSJIVIEN)) S PSJIVIEN=PSJDA531  ;for edits, if no CIMO entry, use the passed in IEN.  Non-edits will always have an entry.
"RTN","PSJIMO1",64,0)
 I +$G(PSJIVIEN) D KILL531(PSGP,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",65,0)
 Q
"RTN","PSJIMO1",66,0)
 ;
"RTN","PSJIMO1",67,0)
CIMOI(DFN,PSJDA55,PSCLINIC,PSJDA531) ;IMO IV FILE 55 CROSS REFERENCE SET
"RTN","PSJIMO1",68,0)
 N PSJCLINI,CLINFLG,PSJIVIEN,PSJSTAT
"RTN","PSJIMO1",69,0)
 S PSJSTAT=""
"RTN","PSJIMO1",70,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(55.01,+PSJDA55_","_DFN_",",136,"I")
"RTN","PSJIMO1",71,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",72,0)
 S CLINFLG="",CLINFLG=$$GET1^DIQ(44,PSCLINIC,2802,"I")  ;Only set xref if IMO clinic
"RTN","PSJIMO1",73,0)
 Q:'CLINFLG
"RTN","PSJIMO1",74,0)
 D GETS^DIQ(55.01,+PSJDA55_","_DFN_",",".03","I","PSJCLINI")
"RTN","PSJIMO1",75,0)
 I $D(PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I")) D
"RTN","PSJIMO1",76,0)
 .S ^PS(55,DFN,"IV","CIMOI",PSCLINIC,PSJCLINI(55.01,+PSJDA55_","_DFN_",",".03","I"),+PSJDA55)=""
"RTN","PSJIMO1",77,0)
 .S ^PS(55,"CIMOCLI",PSCLINIC,DFN,+PSJDA55)=""
"RTN","PSJIMO1",78,0)
 S PSJIVIEN=$$GET1^DIQ(55.01,+ON55_","_DFN_",",113)  ;if there, pick up ien from file 55 since PSJORD/PSGORD can't be trusted.
"RTN","PSJIMO1",79,0)
 I PSJIVIEN=""&(+$G(PSJDA531)) S PSJIVIEN=PSJDA531
"RTN","PSJIMO1",80,0)
 ;I '$D(^PS(53.1,"CIMO",PSGP,PSCLINIC,PSJIVIEN)) S PSJIVIEN=PSJDA531  ;for edits, if no CIMO entry, use the passed in IEN.  Non-edits will always have an entry.
"RTN","PSJIMO1",81,0)
 I +$G(PSJIVIEN) D KILL531(DFN,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",82,0)
 Q
"RTN","PSJIMO1",83,0)
 ;
"RTN","PSJIMO1",84,0)
KILL531(PSJCLPAT,PSCLINIC,PSJIVIEN) ;
"RTN","PSJIMO1",85,0)
 I '$G(PSCLINIC) S PSCLINIC=$$GET1^DIQ(53.1,+PSJIVIEN_","_PSJCLPAT_",",113,"I")
"RTN","PSJIMO1",86,0)
 Q:PSCLINIC=""
"RTN","PSJIMO1",87,0)
 I $D(^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSJIVIEN)) K ^PS(53.1,"CIMO",PSJCLPAT,PSCLINIC,+PSJIVIEN)
"RTN","PSJIMO1",88,0)
 Q
"RTN","PSJIMO1",89,0)
 ;
"RTN","PSJIMO1",90,0)
GETCLN(PSGP,ORDER) ; Return Clinic IEN for a given patient/order combination
"RTN","PSJIMO1",91,0)
 I '$G(ORDER) Q ""
"RTN","PSJIMO1",92,0)
 N CLN S CLN=$S(ORDER["P":$G(^PS(53.1,+ORDER,"DSS")),ORDER["V":$G(^PS(55,PSGP,"IV",+ORDER,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+ORDER,8)),1:"")
"RTN","PSJIMO1",93,0)
 I 'CLN,(ORDER=+ORDER) D
"RTN","PSJIMO1",94,0)
 .I $D(^PS(53.1,"ACX",+ORDER)) N PSJORD S PSJORD=0 F  S PSJORD=$O(^PS(53.1,"ACX",+ORDER,PSJORD)) Q:'PSJORD!$G(CLN)  S CLN=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSJIMO1",95,0)
 .I $D(^PS(55,"ACX",+ORDER)) N ACX2,PSJORD S ACX2="" F  S ACX2=$O(^PS(55,"ACX",+ORDER,ACX2)) Q:'ACX2!$G(CLN)  S PSJORD=0 F  S PSJORD=$O(^PS(55,"ACX",+ORDER,ACX2,PSJORD)) Q:'PSJORD!$G(CLN)  D
"RTN","PSJIMO1",96,0)
 ..S CLN=$S(PSJORD["P":$G(^PS(53.1,+PSJORD,"DSS")),PSJORD["V":$G(^PS(55,PSGP,"IV",+PSJORD,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+PSJORD,8)),1:"")
"RTN","PSJIMO1",97,0)
 Q +CLN
"RTN","PSJIMO1",98,0)
 ;
"RTN","PSJIMO1",99,0)
CHECK() ;SET CONDITION FOR CIMOU XREF IN FILE 55
"RTN","PSJIMO1",100,0)
 ;UNIT DOSE - X2(1)=PATIENT, X2(2)=CLINIC, X2(3)=STOP DATE
"RTN","PSJIMO1",101,0)
 N PSJAPPTD,X S X=0
"RTN","PSJIMO1",102,0)
 Q:'$$IMOCHK(X2(2)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",103,0)
 S PSJAPPTD=$$GET1^DIQ(55.06,DA_","_X2(1)_",",131,"I")
"RTN","PSJIMO1",104,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",105,0)
 Q X
"RTN","PSJIMO1",106,0)
 ;
"RTN","PSJIMO1",107,0)
CHECK2() ;SET CONDITION FOR CIMOI XREF IN FILE 55
"RTN","PSJIMO1",108,0)
 ;IV - DA(1)=PATIENT, X2(1)=CLINIC, X2(2)=STOP DATE, DA=SUBFILE IEN
"RTN","PSJIMO1",109,0)
 N PSJAPPTD,X S X=0
"RTN","PSJIMO1",110,0)
 Q:'$$IMOCHK(X2(1)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",111,0)
 S PSJAPPTD=$$GET1^DIQ(55.01,DA_","_DA(1)_",",139,"I")
"RTN","PSJIMO1",112,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",113,0)
 Q X
"RTN","PSJIMO1",114,0)
 ;
"RTN","PSJIMO1",115,0)
IMOCHK(PSJIMOCL) ;determine if clinic is an IMO clinic; returns 1 if IMO or 0 not IMO
"RTN","PSJIMO1",116,0)
 Q:'$G(PSJIMOCL) 0
"RTN","PSJIMO1",117,0)
 N PSJCFLAG
"RTN","PSJIMO1",118,0)
 S PSJCFLAG=$$GET1^DIQ(44,PSJIMOCL,2802,"I")
"RTN","PSJIMO1",119,0)
 Q PSJCFLAG
"RTN","PSJIMO1",120,0)
 ;
"RTN","PSJIMO1",121,0)
CHECK3() ;SET CONDITION FOR CIMO XREF IN FILE 53.1
"RTN","PSJIMO1",122,0)
 ;  DA=IEN, X(1)=PATIENT, X(2)=CLINIC
"RTN","PSJIMO1",123,0)
 N PSJCFLAG,PSJAPPTD,X,PSJTYPE,PSJUTMP S X=0
"RTN","PSJIMO1",124,0)
 Q:'$$IMOCHK(X2(2)) 0  ;don't set clinic x-refs where clinic isn't marked as IMO.
"RTN","PSJIMO1",125,0)
 D GETS^DIQ(53.1,DA,"28;126","I","PSJUTMP")
"RTN","PSJIMO1",126,0)
 S X=0,(PSJAPPTD,PSJTYPE)=""
"RTN","PSJIMO1",127,0)
 S:$D(PSJUTMP(53.1,DA_",",126,"I")) PSJAPPTD=PSJUTMP(53.1,DA_",",126,"I")
"RTN","PSJIMO1",128,0)
 S:$D(PSJUTMP(53.1,DA_",",28,"I")) PSJTYPE=PSJUTMP(53.1,DA_",",28,"I")
"RTN","PSJIMO1",129,0)
 Q:PSJTYPE'="P"&(PSJTYPE'="N") 0  ;only pending and non-verified orders are allowed in the xref
"RTN","PSJIMO1",130,0)
 S:PSJAPPTD'="" X=1
"RTN","PSJIMO1",131,0)
 Q X
"RTN","PSJIMO1",132,0)
 ;
"RTN","PSJIMO1",133,0)
TEST ;KILL ALL IMO CROSS REFERENCES FOR A PARTICULAR CLINIC AND PATIENT
"RTN","PSJIMO1",134,0)
 N PSJTESCL,PSJTESPA
"RTN","PSJIMO1",135,0)
TEST2 ;
"RTN","PSJIMO1",136,0)
 K DIC S DIC="^PS(53.46,",DIC(0)="AELMQ",DIC("A")="Select CLINIC: ",DLAYGO=53.46 D ^DIC K DIC G DONE:Y=""!(Y<1)
"RTN","PSJIMO1",137,0)
 S PSJTESCL=$P(Y,"^",2)
"RTN","PSJIMO1",138,0)
 K DIC,PSGP,Y W !!,"Select "_$S($D(PSGDICA):PSGDICA_" ",1:"")_"PATIENT: " R X:DTIME S:'$T X="^" W:'$T $C(7) I "^"[X S (Y,PSGP)=-1 S QFLG=1 G DONE
"RTN","PSJIMO1",139,0)
 K DIC S DIC="^DPT(",DIC("W")="D DPT^PSJDPT",DIC(0)="QEMZ" D ^DPTLK K DIC
"RTN","PSJIMO1",140,0)
 S PSJTESPA=$P(Y,"^")
"RTN","PSJIMO1",141,0)
 ;
"RTN","PSJIMO1",142,0)
 K ^PS(55,PSJTESPA,"IV","CIMOI",PSJTESCL)
"RTN","PSJIMO1",143,0)
 K ^PS(55,"CIMOCLI",PSJTESCL)
"RTN","PSJIMO1",144,0)
 K ^PS(55,"CIMOU",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",145,0)
 K ^PS(55,"CIMOCLU",PSJTESCL)
"RTN","PSJIMO1",146,0)
 K ^PS(53.1,"CIMO",PSJTESPA,PSJTESCL)
"RTN","PSJIMO1",147,0)
 W !,"DELETED",!
"RTN","PSJIMO1",148,0)
DONE ;
"RTN","PSJIMO1",149,0)
 Q
"RTN","PSJIMO1",150,0)
 ;
"RTN","PSJIMO1",151,0)
CLEAN(DFN) ;Delete old entriers from clinic order xref; CALLED WHEN USER EXITS PATIENT IN IOE
"RTN","PSJIMO1",152,0)
 ;----get top of the range of dates stored for each clinic
"RTN","PSJIMO1",153,0)
 N PSCLINIC,PSTYPE,ENDDATE,RXDATE,CLNDAYS,CLNARRY,PSJIEN
"RTN","PSJIMO1",154,0)
 S (PSTYPE,PSCLINIC,CLNDAYS,CLNARRY)=""
"RTN","PSJIMO1",155,0)
 F PSTYPE="CIMOCLU","CIMOCLI" F  S PSCLINIC=$O(^PS(55,PSTYPE,PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",156,0)
 .S CLNDAYS=$$GET1^DIQ(53.46,PSCLINIC,6) S:CLNDAYS="" CLNDAYS=30  ;default to 30 days if not defined
"RTN","PSJIMO1",157,0)
 .D NOW^%DTC S X1=%,X2=-CLNDAYS D C^%DTC S CLNARRY($S(PSTYPE="CIMOCLU":"U",1:"V"),PSCLINIC)=X
"RTN","PSJIMO1",158,0)
 ;----kill x-refs for all unit dose entries older than the clinic begin date
"RTN","PSJIMO1",159,0)
 I $D(CLNARRY("U")) S PSCLINIC="" F  S PSCLINIC=$O(CLNARRY("U",PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",160,0)
 .S (RXDATE,ENDDATE)="",ENDDATE=CLNARRY("U",PSCLINIC)
"RTN","PSJIMO1",161,0)
 .F  S RXDATE=$O(^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE)) Q:RXDATE=""  I RXDATE<ENDDATE K ^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE) D
"RTN","PSJIMO1",162,0)
 ..S PSJIEN="" F  S PSJIEN=$O(^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE,DFN,PSJIEN)) Q:PSJIEN=""  K ^PS(55,"CIMOU",DFN,PSCLINIC,RXDATE,DFN,PSJIEN)
"RTN","PSJIMO1",163,0)
 ;----kill x-refs for all IV entries older than the clinic begin date
"RTN","PSJIMO1",164,0)
 I $D(CLNARRY("V")) S PSCLINIC="" F  S PSCLINIC=$O(CLNARRY("V",PSCLINIC)) Q:PSCLINIC=""  D
"RTN","PSJIMO1",165,0)
 .S (RXDATE,ENDDATE)="",ENDDATE=CLNARRY("V",PSCLINIC)
"RTN","PSJIMO1",166,0)
 .F  S RXDATE=$O(^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE)) Q:RXDATE=""  I RXDATE<ENDDATE K ^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE) D
"RTN","PSJIMO1",167,0)
 ..S PSJIEN="" F  S PSJIEN=$O(^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE,PSJIEN)) Q:PSJIEN=""  K ^PS(55,DFN,"IV","CIMOI",PSCLINIC,RXDATE,PSJIEN)
"RTN","PSJIMO1",168,0)
 Q
"RTN","PSJIMO1",169,0)
 ;
"RTN","PSJLIACT")
0^7^B51186933
"RTN","PSJLIACT",1,0)
PSJLIACT ;BIR/MV-IV ACTION ;28 Jul 98 / 8:50 AM
"RTN","PSJLIACT",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**15,47,62,58,82,97,80,110,111,134,181,247,260,275,299**;16 DEC 97;Build 11
"RTN","PSJLIACT",3,0)
 ;
"RTN","PSJLIACT",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJLIACT",5,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA 2410.
"RTN","PSJLIACT",6,0)
 ;
"RTN","PSJLIACT",7,0)
DC ; Discontinue order
"RTN","PSJLIACT",8,0)
 K PSGORQF
"RTN","PSJLIACT",9,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",10,0)
 S PSJCOM=+$S(PSJORD["V":$P($G(^PS(55,DFN,"IV",+PSJORD,.2)),"^",8),1:$P($G(^PS(53.1,+PSJORD,.2)),"^",8))
"RTN","PSJLIACT",11,0)
 I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSJORD)
"RTN","PSJLIACT",12,0)
 I PSJCOM F  W !!,"Do you want to discontinue this order" S %=1 D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSJLIACT",13,0)
 I PSJCOM,%'=1 S VALMBK="" Q
"RTN","PSJLIACT",14,0)
 I $G(ON55)["P",$G(PSIVOORD) S PSJORD=ON55 ;*247 - Correct DCing newly copied orders
"RTN","PSJLIACT",15,0)
 I PSJORD["V" D DC^PSIVORA D:'$G(PSJOCFLG) EN^PSJLIORD(DFN,ON) Q
"RTN","PSJLIACT",16,0)
 I PSJORD["P" N ON S ON=PSJORD D DISCONT^PSIVORC
"RTN","PSJLIACT",17,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",18,0)
 Q
"RTN","PSJLIACT",19,0)
ACEDIT ; Display LM screen and AC and EDit actions
"RTN","PSJLIACT",20,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",21,0)
 S VALMBCK=$S($G(PSIVACEP):"Q",1:"R")
"RTN","PSJLIACT",22,0)
 Q
"RTN","PSJLIACT",23,0)
AEEXIT ; Call for EXIT CODE in PSJ LM IV AC/EDIT
"RTN","PSJLIACT",24,0)
 K PSGORQF
"RTN","PSJLIACT",25,0)
 D:ON["V" GT55^PSIVORFB
"RTN","PSJLIACT",26,0)
 I ON["P" D GT531^PSIVORFA(DFN,ON) D:P("OT")'="I" GTDATA^PSJLIFN
"RTN","PSJLIACT",27,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",28,0)
 K PSIVENO
"RTN","PSJLIACT",29,0)
 Q
"RTN","PSJLIACT",30,0)
EDIT ; Edit order
"RTN","PSJLIACT",31,0)
 K PSIVFN1 NEW PSIVNBD
"RTN","PSJLIACT",32,0)
 I $D(PSGACT),PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJLIACT",33,0)
 D EDIT1
"RTN","PSJLIACT",34,0)
 Q:$D(PSIVNBD)!($G(PSIVCOPY)&'$G(PSIVENO))
"RTN","PSJLIACT",35,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",36,0)
 S VALMBCK=$S($G(PSIVFN1):"Q",1:"R")
"RTN","PSJLIACT",37,0)
 Q
"RTN","PSJLIACT",38,0)
EDIT1 ;
"RTN","PSJLIACT",39,0)
 K PSGORQF
"RTN","PSJLIACT",40,0)
 ;Ensure P() is defined
"RTN","PSJLIACT",41,0)
 I $D(P)<10 S XQORQUIT=1,P("PON")="",PSIVNBD=1 D  Q
"RTN","PSJLIACT",42,0)
 .W !,"WARNING: An error has occurred. Changes will not be saved"
"RTN","PSJLIACT",43,0)
 .D PAUSE^VALM1
"RTN","PSJLIACT",44,0)
 .S VALMBCK="Q"
"RTN","PSJLIACT",45,0)
 I "ANP"'[P(17) W !,"You cannot edit an inactive order" D PAUSE^VALM1 Q
"RTN","PSJLIACT",46,0)
 S:$G(ON55)="" ON55=$G(PSJORD)
"RTN","PSJLIACT",47,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",48,0)
 ;* Edit a new back door order
"RTN","PSJLIACT",49,0)
 I ($G(ON55)["V"&($G(P("21FLG"))="")) D  Q
"RTN","PSJLIACT",50,0)
 . D GSTRING^PSIVORE1,GTFLDS^PSIVORFE
"RTN","PSJLIACT",51,0)
 . I $G(ON55)["V",'$G(DONE) D OK^PSIVORE
"RTN","PSJLIACT",52,0)
 . S VALMBCK="Q",PSIVNBD=1
"RTN","PSJLIACT",53,0)
 ;* Edit an active order
"RTN","PSJLIACT",54,0)
 I $G(ON55)["V" NEW PSJEDIT1 D E^PSIVOPT1 D  Q
"RTN","PSJLIACT",55,0)
 . I $G(PSJIVBD) K PSJIVBD D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",56,0)
 I $G(ON55)["P" D EDIT^PSIVORC ;Edit incomplete order.
"RTN","PSJLIACT",57,0)
 K P("OVRIDE")
"RTN","PSJLIACT",58,0)
 Q
"RTN","PSJLIACT",59,0)
ACCEPT ; Accept order
"RTN","PSJLIACT",60,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",61,0)
 ;Accept IV from back door.
"RTN","PSJLIACT",62,0)
 I $G(PSJIVBD) K PSJIVBD D OK^PSIVORE S VALMBCK="Q" Q
"RTN","PSJLIACT",63,0)
 ;D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","") Q:$G(PSGORQF)
"RTN","PSJLIACT",64,0)
 I ON["V" D ACCEPT^PSIVOPT1 Q
"RTN","PSJLIACT",65,0)
 S PSIVFN1=1
"RTN","PSJLIACT",66,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIACT",67,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",68,0)
 Q
"RTN","PSJLIACT",69,0)
R ; Renewal
"RTN","PSJLIACT",70,0)
 K PSGORQF
"RTN","PSJLIACT",71,0)
 S PSJREN=1
"RTN","PSJLIACT",72,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",73,0)
 NEW PSIVAC S PSIVAC="PR" K PSGFDX
"RTN","PSJLIACT",74,0)
 D R^PSIVOPT
"RTN","PSJLIACT",75,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",76,0)
 K PSJREN
"RTN","PSJLIACT",77,0)
 Q
"RTN","PSJLIACT",78,0)
H ; Hold
"RTN","PSJLIACT",79,0)
 K PSGORQF
"RTN","PSJLIACT",80,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",81,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",82,0)
 D H^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",83,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",84,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",85,0)
 Q
"RTN","PSJLIACT",86,0)
L ; Activity Log
"RTN","PSJLIACT",87,0)
 NEW PSIVLAB,PSIVLOG,PSJHIS S (PSIVLAB,PSIVLOG)=1
"RTN","PSJLIACT",88,0)
 D EN^PSIVVW1
"RTN","PSJLIACT",89,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",90,0)
 S VALMBCK="R"
"RTN","PSJLIACT",91,0)
 Q
"RTN","PSJLIACT",92,0)
O ; On Call
"RTN","PSJLIACT",93,0)
 K PSGORQF
"RTN","PSJLIACT",94,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",95,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",96,0)
 D O^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",97,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",98,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",99,0)
 Q
"RTN","PSJLIACT",100,0)
VF ; Make the order active **ENHANCEMENTS MADE IN PSJ*5.0*260
"RTN","PSJLIACT",101,0)
 NEW PSIVCHG,PSGORQF,PSJVFF S PSIVCHG=0
"RTN","PSJLIACT",102,0)
 IF VALM("TITLE")="ACTIVE IV " W !!,">>>  Verify may not be selected at this point." D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJLIACT",103,0)
 ELSE  IF $G(PSGSTAT)="NON-VERIFIED",$G(PSJNEWOE)=0 S PSJVFF=1 D EN^PSJGMRA($G(DFN),$G(PSGPD)),OC^PSIVOC D:'$G(PSGORQF) IN^PSJOCDS($G(PSGORD),"IV","") K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",104,0)
 ELSE  IF '$G(PSGORQF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",105,0)
 ELSE  IF $G(PSIVFN1),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",106,0)
 ELSE  IF $G(PSGDEF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",107,0)
 ELSE  IF $G(PSIVCOPY),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",108,0)
 D ACTIVE^PSIVORC2
"RTN","PSJLIACT",109,0)
 Q
"RTN","PSJLIACT",110,0)
VF1(PSIVREA,PSIVAL,PSIVLOG) ;
"RTN","PSJLIACT",111,0)
 ;Update 4 node and set activity log.
"RTN","PSJLIACT",112,0)
 ;PSIVREA: the reason use by LOG^PSIVORAL
"RTN","PSJLIACT",113,0)
 ;PSIVAL : the description reason
"RTN","PSJLIACT",114,0)
 ;PSIVLOG: Log an activity if = 1
"RTN","PSJLIACT",115,0)
 K PSGORQF
"RTN","PSJLIACT",116,0)
 I '+$G(OD)!($L($G(OD))>16) K OD
"RTN","PSJLIACT",117,0)
 D:+PSJSYSU=3 ^PSIVORE1
"RTN","PSJLIACT",118,0)
 NEW DIE,DA,DR,PSJX,XX,PSIVACT,PSJRQND
"RTN","PSJLIACT",119,0)
 S PSIVACT=1
"RTN","PSJLIACT",120,0)
 S PSJX=$G(^PS(55,DFN,"IV",+ON55,4)),XX=""
"RTN","PSJLIACT",121,0)
 I $P(PSJX,U)="" S XX=";143////0"
"RTN","PSJLIACT",122,0)
 I $P(PSJX,U,4)="" S XX=XX_U_";142////0"
"RTN","PSJLIACT",123,0)
 D NOW^%DTC
"RTN","PSJLIACT",124,0)
 S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",125,0)
 I +PSJSYSU=3 S DR="140////"_DUZ_";141////"_$E(%,1,12)_";142////1"_$P(XX,U)
"RTN","PSJLIACT",126,0)
 I +PSJSYSU=1 S DR="16////"_DUZ_";17////"_$E(%,1,12)_";143////1"_$P(XX,U,2)
"RTN","PSJLIACT",127,0)
 I $G(P("PRY"))="D" S DR=DR_";.22////"_+P("IVRM")
"RTN","PSJLIACT",128,0)
 D ^DIE
"RTN","PSJLIACT",129,0)
 ; If pending IV renew is edited during finish, go back and DE the original active order left in RENEWED status
"RTN","PSJLIACT",130,0)
 S PREREN=$S(ON55["V":$G(@(DIE_"+ON55,2)")),1:""),PREREN=$P(PREREN,"^",5) I PREREN D  K PREREN
"RTN","PSJLIACT",131,0)
 . I PREREN["P" S PREREN=$G(@("^PS(53.1,+PREREN,0)")),PREREN=$P(PREREN,"^",25)
"RTN","PSJLIACT",132,0)
 . I PREREN["V" N PRERENOD S PRERENOD=$G(@("^PS(55,DFN,""IV"",+PREREN,0)")) I $P(PRERENOD,"^",17)="R",($G(P("RES"))="E") D
"RTN","PSJLIACT",133,0)
 ..  S DIE="^PS(55,"_DFN_",""IV"",",DA=+PREREN,DA(1)=DFN
"RTN","PSJLIACT",134,0)
 ..  S DR="100////D;.03////"_PSGDT S ORIGSTOP=$P($G(@("^PS(55,DFN,""IV"",+PREREN,2)")),"^",3) I ORIGSTOP S DR=DR_";116////"_ORIGSTOP
"RTN","PSJLIACT",135,0)
 ..  D ^DIE D EN1^PSJHL2(DFN,"SC",PREREN)
"RTN","PSJLIACT",136,0)
 K DR,DIE,DA
"RTN","PSJLIACT",137,0)
 I (+PSJSYSU=3)&($G(P("PRY"))="D") D
"RTN","PSJLIACT",138,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSJLIACT",139,0)
 .Q:Y="N"
"RTN","PSJLIACT",140,0)
 .D MAIN^TIUEDIT(3,.TIUDA,DFN,"","","","",1)
"RTN","PSJLIACT",141,0)
 Q:'$G(PSIVLOG)
"RTN","PSJLIACT",142,0)
 I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D
"RTN","PSJLIACT",143,0)
 . NEW DIC,DA,X,Y,XX,DO D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJLIACT",144,0)
 . S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJLIACT",145,0)
 . S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJLIACT",146,0)
 . S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJLIACT",147,0)
 . D FILE^DICN
"RTN","PSJLIACT",148,0)
 NEW PSIVALCK
"RTN","PSJLIACT",149,0)
 S PSIVREA="V",PSIVALT=""
"RTN","PSJLIACT",150,0)
 S PSIVAL=PSIVAL_$S(+PSJSYSU=3:"PHARMACIST",1:"NURSE")
"RTN","PSJLIACT",151,0)
 D LOG^PSIVORAL K PSIVAL,PSIVREA,PSIVLN
"RTN","PSJLIACT",152,0)
 I $G(PSJORD)["P" S PSIVREA="V",PSIVALT="",PSGRDTX=$G(^PS(53.1,+PSJORD,2.5)) D
"RTN","PSJLIACT",153,0)
 . I $G(PSGRDTX) S PSIVAL="Requested Start Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U))) D LOG^PSIVORAL
"RTN","PSJLIACT",154,0)
 . I $P(PSGRDTX,U,3) S PSIVREA="V",PSIVALT="" S PSIVAL="Requested Stop Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U,3))) D LOG^PSIVORAL
"RTN","PSJLIACT",155,0)
 N DUR I $G(PSJORD) S DUR=$$GETDUR^PSJLIVMD(DFN,+PSJORD,$S(PSJORD["P":"P",1:"IV"),1) I DUR]""  D
"RTN","PSJLIACT",156,0)
 . K DR S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",157,0)
 . S DR=$S($G(IVLIMIT):"152////"_DUR,1:"151////"_DUR) K IVLIMIT
"RTN","PSJLIACT",158,0)
 . D ^DIE
"RTN","PSJLIACT",159,0)
 D EN1^PSJHL2(DFN,"SC",ON55)
"RTN","PSJLIACT",160,0)
 D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSJLIACT",161,0)
 I '$D(^PS(55,DFN,"IV","CIMOI",+ON55)) D CIMOI^PSJIMO1(DFN,ON55,"",$G(PSJORD))
"RTN","PSJLIACT",162,0)
 E  I +$G(PSJORD) D KILL531^PSJIMO1(DFN,"",PSJORD)
"RTN","PSJLIACT",163,0)
 D GT55^PSIVORFB S OLDON=$P($G(^PS(55,DFN,"IV",+ON55,2)),"^",5),P("OLDON")=OLDON
"RTN","PSJLIACT",164,0)
 N PSJPRIO,PSJSCH,NODE0,NODEP2 S NODE0=$G(^PS(55,DFN,"IV",+ON55,0)),NODEP2=$G(^PS(55,DFN,"IV",+ON55,.2))
"RTN","PSJLIACT",165,0)
 S PSJPRIO=$P(NODEP2,"^",4),PSJSCH=$P(NODE0,"^",9)
"RTN","PSJLIACT",166,0)
 I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCH)="NOW")!($G(PSJSCH)["STAT") D NOTIFY^PSJHL4(ON55,DFN,$G(PSJPRIO),$G(PSJSCH))
"RTN","PSJLIACT",167,0)
 Q
"RTN","PSJO1")
0^4^B46556084
"RTN","PSJO1",1,0)
PSJO1 ;BIR/CML3,PR-GET UNIT DOSE/IV ORDERS FOR INPATIENT ;15 May 98 / 9:28 AM
"RTN","PSJO1",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**3,47,56,58,109,110,127,162,181,275,292,299**;16 DEC 97;Build 11
"RTN","PSJO1",3,0)
 ;
"RTN","PSJO1",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJO1",5,0)
 ; Reference to ^%DTC is supported by DBIA# 10000.
"RTN","PSJO1",6,0)
 ; Reference to ^%ZOSV is supported by DBIA# 10097.
"RTN","PSJO1",7,0)
 ; Reference to XLFDT is supported by DBIA# 10103.
"RTN","PSJO1",8,0)
 ;
"RTN","PSJO1",9,0)
ECHK ;
"RTN","PSJO1",10,0)
 S C="A",ON=+O_"U",START=$G(^PS(55,PSGP,5,+O,2)),STOP=$P(START,U,4),START=$P(START,U,2) S:PSJOS START=-START
"RTN","PSJO1",11,0)
 I +START>PSGDT,(STOP>PSGDT) G SET
"RTN","PSJO1",12,0)
 S ND=$G(^PS(55,PSGP,5,+O,0)) G:$S($P(ND,"^",9)="":1,1:"DE"'[$P(ND,"^",9)) SET S ND4=$G(^PS(55,PSGP,5,+O,4)) I ST'="O",SD'<PSGODT,$S($P(ND,"^",9)="E":$P(ND4,"^",16),1:0)
"RTN","PSJO1",13,0)
 E  I ST="O",$P(ND,"^",9)="E",$S('$P(ND4,"^",UDU):1,SD<PSGODT:0,1:$P(ND4,"^",16))
"RTN","PSJO1",14,0)
 E  I PSJOL="S",(STOP>$P($G(PSJDCEXP),U,2)) S C="DF" G SET
"RTN","PSJO1",15,0)
 E  Q:PSJOL="S"  S C="O"
"RTN","PSJO1",16,0)
 ;
"RTN","PSJO1",17,0)
SET ;
"RTN","PSJO1",18,0)
 I ON["P",($D(PRNTON)!($D(P("PRNTON")))) N PSJOK S PSJOK=$$COMCHK($S($G(P("PRNTON"))]"":P("PRNTON"),$G(PRNTON)]"":PRNTON,1:""),PSJPTYP) Q:'PSJOK
"RTN","PSJO1",19,0)
 NEW DRUGNAME,CLINFLAG D DRGDISP^PSJLMUT1(PSGP,ON,40,0,.DRUGNAME,1)
"RTN","PSJO1",20,0)
 S DN=DRUGNAME(1),SUB=$S(PSJOS:START,1:$E(DN,1,40))
"RTN","PSJO1",21,0)
 I ON["P",$G(P("PRNTON"))]"",$G(PRNTON)=+P("PRNTON") Q
"RTN","PSJO1",22,0)
 I ON["P",$G(P("PRNTON"))]"" S PRNTON=+P("PRNTON"),ON=+P("PRNTON")
"RTN","PSJO1",23,0)
 S CLINFLAG=$$CLINIC(PSGP,ON) I CLINFLAG]"" D
"RTN","PSJO1",24,0)
 .N CLINSORT,SORT S CLINSORT=$$CLINSORT(C)
"RTN","PSJO1",25,0)
 .S C="Cz^"_CLINFLAG_"^"_CLINSORT_"^"_C
"RTN","PSJO1",26,0)
 S ^TMP("PSJ",$J,C,$S(PSJOS:SUB,1:ST),$S(PSJOS:ST,1:SUB),ON)=DN_"^"_$G(NF),PSJOCNT=PSJOCNT+1 Q
"RTN","PSJO1",27,0)
 ;
"RTN","PSJO1",28,0)
IVSET ;Set IV data in ^TMP("PSJ",$J,.
"RTN","PSJO1",29,0)
 N DRG,DRGT,ON55,ORTX,P,STAT,TYP,X,Y,NAME,ND
"RTN","PSJO1",30,0)
 I ON["V" S ON55=ON,Y=$G(^PS(55,DFN,"IV",+ON,0)) F X=2,3,4,9,17 S P(X)=$P(Y,U,X)
"RTN","PSJO1",31,0)
 I ON["V",(P(2)=""),(P(3)="") Q
"RTN","PSJO1",32,0)
 I ON'["V" S ND=$G(^PS(53.1,+ON,0)) I 'ND K ^PS(53.1,"AS",SD,PSGP,+ON) Q
"RTN","PSJO1",33,0)
 I ON'["V",ND S P(17)=$P($G(^PS(53.1,+ON,0)),U,9),Y=$G(^PS(53.1,+ON,2)),P(9)=$P(Y,U),P(2)=$P(Y,U,2),P(3)=$P(Y,U,4),P(4)=$P($G(^PS(53.1,+ON,8)),U),P("PRNTON")=$P($G(^PS(53.1,+ON,.2)),U,8)
"RTN","PSJO1",34,0)
 I ON'["V",P("PRNTON")]"" N PSJOK S PSJOK=$$COMCHK(P("PRNTON"),PSJPTYP) Q:'PSJOK
"RTN","PSJO1",35,0)
 D @$S(ON["V":"GTDRG^PSIVORFB",1:"GTDRG^PSIVORFA"),GTOT^PSIVUTL(P(4))
"RTN","PSJO1",36,0)
 I $G(DRG) S DRGT=$S($G(DRG("AD",1))]"":$P($G(DRG("AD",1)),U,2),1:$P($G(DRG("SOL",1)),U,2)),ORTX=DRGT
"RTN","PSJO1",37,0)
 I $G(ORTX)="",(ON'["V") D DRGDISP^PSJLMUT1(PSGP,+ON_"P",40,"",.NAME,1) S ORTX=NAME(1)
"RTN","PSJO1",38,0)
 ;* I $G(ORTX)=""!(ON'["V") D DRGDISP^PSJLMUT1(PSGP,+ON_"P",40,"",.NAME,1) S ORTX=NAME(1)
"RTN","PSJO1",39,0)
 S:$G(ORTX)="" ORTX="NOT FOUND"
"RTN","PSJO1",40,0)
 ;
"RTN","PSJO1",41,0)
IVSET1 ;
"RTN","PSJO1",42,0)
 ;* S TYP=$S(P(2)=P(3):"O",1:"C"),STAT=$S("ED"[P(17):"O",P(17)="P":"P",1:"A")
"RTN","PSJO1",43,0)
 N PSJCLIN,CLINSORT
"RTN","PSJO1",44,0)
 S TYP=$$ONE^PSJBCMA(PSGP,ON,P(9),P(2),P(3)) I TYP'="O" S TYP=$S(ON["P":"z",1:"C")
"RTN","PSJO1",45,0)
 S STAT=$S($G(PSJPRI)="D":"A","ED"[P(17):"O",P(17)="P":"P",1:"A")
"RTN","PSJO1",46,0)
 I P(17)="P" S STAT="C"_$S($P($G(^PS(53.1,+ON,.2)),U,8)]"":"D",$P($G(^PS(53.1,+ON,.2)),U,4)="S":"A",$P($G(^(0)),U,24)="R":"C",1:"B")
"RTN","PSJO1",47,0)
 I PSJOL="S",(STAT="O"),(P(3)>$P($G(PSJDCEXP),U,2)) S STAT="DF"
"RTN","PSJO1",48,0)
 I ON["P",$G(P("PRNTON"))]"",PRNTON=+P("PRNTON") Q
"RTN","PSJO1",49,0)
 I ON["P",$G(P("PRNTON"))]"" S PRNTON=+P("PRNTON"),ON=+P("PRNTON")
"RTN","PSJO1",50,0)
 S PSJCLIN=$$CLINIC(PSGP,ON) I PSJCLIN]"" D
"RTN","PSJO1",51,0)
 .N STAT2 S STAT2=$S($P(STAT,"^",4)]"":$P(STAT,"^",4),1:STAT)
"RTN","PSJO1",52,0)
 .N CLINSORT S CLINSORT=$$CLINSORT(STAT) S STAT="Cz^"_PSJCLIN_"^"_CLINSORT_"^"_STAT2
"RTN","PSJO1",53,0)
 S ^TMP("PSJ",$J,STAT,$S(PSJOS:-P(2),1:TYP),$S(PSJOS:TYP,1:ORTX),ON)="^F",PSJOCNT=PSJOCNT+1
"RTN","PSJO1",54,0)
 Q
"RTN","PSJO1",55,0)
 ;
"RTN","PSJO1",56,0)
ENU ; update status field to reflect expired orders, if necessary
"RTN","PSJO1",57,0)
 W !!,"...a few moments, I have some updating to do..."
"RTN","PSJO1",58,0)
ENUNM ;
"RTN","PSJO1",59,0)
 F Q=+PSJPAD:0 S Q=$O(^PS(55,PSGP,5,"AUS",Q)) Q:'Q!(Q>PSGDT)  S UPD=Q F QQ=0:0 S QQ=$O(^PS(55,PSGP,5,"AUS",Q,QQ)) Q:'QQ  I $D(^PS(55,PSGP,5,QQ,0)),"DEH"'[$E($P(^(0),"^",9)) D
"RTN","PSJO1",60,0)
 .N DIE,DA,DR,X,Y,QQON S QQON=QQ,DIE="^PS(55,"_PSGP_",5,",DA(1)=PSGP,DA=+QQON,DR="28////E" D ^DIE
"RTN","PSJO1",61,0)
 .S ORIFN=$P(^PS(55,PSGP,5,+QQON,0),"^",21) D EN1^PSJHL2(PSGP,"SC",QQON_"U")
"RTN","PSJO1",62,0)
 K UPD Q
"RTN","PSJO1",63,0)
 ;
"RTN","PSJO1",64,0)
EN(PSJPTYP) ; enter here
"RTN","PSJO1",65,0)
 ; PSJPTYP=1:UD ONLY, 2:IV ONLY, 3:BOTH
"RTN","PSJO1",66,0)
 N PSJX,PSJY
"RTN","PSJO1",67,0)
 S PSJDCEXP=$$RECDCEXP^PSJP()
"RTN","PSJO1",68,0)
 S PSJOL=$G(PSJOL)  ; Initialize if no 'View Profile' option selected
"RTN","PSJO1",69,0)
 I PSJOL="L",$D(XRTL) D T0^%ZOSV
"RTN","PSJO1",70,0)
 K ^TMP("PSJ",$J) D NOW^%DTC S PSGDT=+$E(%,1,12),DT=$$DT^XLFDT,PSJOS=$P(PSJSYSP0,"^",11),UDU=$S($P(PSJSYSU,";",3)>1:3,1:1)
"RTN","PSJO1",71,0)
 S PSJOCNT=0 I PSJPTYP>1 F PSJORD=0:0 S PSJORD=$O(^PS(55,DFN,"IV",PSJORD)) Q:'PSJORD  D
"RTN","PSJO1",72,0)
 .S PSJX=$G(^PS(55,DFN,"IV",+PSJORD,0))
"RTN","PSJO1",73,0)
 .S PSJY=$P(PSJX,U,17)
"RTN","PSJO1",74,0)
 .I $P(PSJX,U,3)<PSGDT,"AR"[PSJY S $P(^PS(55,DFN,"IV",+PSJORD,0),U,17)="E",PSJY="E",ON=+PSJORD D EXPIR^PSIVOE
"RTN","PSJO1",75,0)
 .I +PSJSYSU=3,('+$P($G(^PS(55,DFN,"IV",+PSJORD,4)),U,4)),($P($G(^(.2)),U,4)="D") S PSJPRI="D"
"RTN","PSJO1",76,0)
 .I $S($G(PSJPRI)="D":1,PSJY="P":0,PSJOL="L":1,$P(PSJX,U,3)>$P($G(PSJDCEXP),U,2):1,1:"DPE"'[PSJY) S ON=+PSJORD_"V" D IVSET K PSJPRI,ON
"RTN","PSJO1",77,0)
 D NOW^%DTC S PSJIVOF=PSJOCNT,PSGDT=%,(X1,DT)=$P(%,"."),X2=-2 D C^%DTC S PSGODT=X_(PSGDT#1),HDT=$$ENDTC^PSGMI(PSGDT)
"RTN","PSJO1",78,0)
 D ENUNM
"RTN","PSJO1",79,0)
 I PSJPTYP'=2 F ST="C","O","OC","P","R" F SD=+$P(PSJDCEXP,"^",2):0 S SD=$O(^PS(55,PSGP,5,"AU",ST,SD)) Q:'SD  F O=0:0 S O=$O(^PS(55,PSGP,5,"AU",ST,SD,O)) Q:'O  D ECHK
"RTN","PSJO1",80,0)
 Q:$D(PSGONNV)
"RTN","PSJO1",81,0)
 ;I PSJPTYP'=2 F SD="I","N" S O=0 F  S O=$O(^PS(53.1,"AS",SD,PSGP,O)) Q:'O  S ON=+O_"P",X=$P($G(^PS(53.1,+O,0)),U,4) I $S(PSJPTYP=3:1,PSJPTYP=1&("FI"[X):0,1:1) D NVSET
"RTN","PSJO1",82,0)
 N PRNTON F SD="I","N" S (PRNTON,O)=0 F  S O=$O(^PS(53.1,"AS",SD,PSGP,O)) Q:'O  S ON=+O_"P",X=$P($G(^PS(53.1,+O,0)),U,4) I $S(PSJPTYP=3:1,PSJPTYP=1&("FI"[X):0,1:1) D NVSET
"RTN","PSJO1",83,0)
 ;I $S(+PSJSYSU=3:1,1:$D(PSGLPF)) S O=0,SD="P" F  S O=$O(^PS(53.1,"AS",SD,PSGP,O)) Q:'O  S ON=O_"P",X=$P($G(^PS(53.1,+O,0)),U,4) I $S(PSJPTYP=3:1,PSJPTYP=1&("FI"[X):0,1:1) D @$S("FI"[X:"IVSET",1:"NVSET")
"RTN","PSJO1",84,0)
 N PRNTON S (PRNTON,O)=0,SD="P" F  S O=$O(^PS(53.1,"AS",SD,PSGP,O)) Q:'O  S ON=O_"P",X=$P($G(^PS(53.1,+O,0)),U,4) I $S(PSJPTYP=3:1,PSJPTYP=1&("FI"[X):0,1:1) D @$S("FI"[X:"IVSET",1:"NVSET")
"RTN","PSJO1",85,0)
 I PSJOL="L",$D(XRT0) S XRTN="PSJO1" D T1^%ZOSV
"RTN","PSJO1",86,0)
 D CLEAN^PSJIMO1(PSGP)
"RTN","PSJO1",87,0)
 Q
"RTN","PSJO1",88,0)
 ;
"RTN","PSJO1",89,0)
NVSET ; Set up orders from 53.1.
"RTN","PSJO1",90,0)
 N ND S ND=$G(^PS(53.1,O,0)) I 'ND D  Q
"RTN","PSJO1",91,0)
 .K ^PS(53.1,"AS",SD,PSGP,O)
"RTN","PSJO1",92,0)
 I $P(ND,U,15),$G(PSGP) I PSGP'=$P(ND,U,15) D  Q
"RTN","PSJO1",93,0)
 .K ^PS(53.1,"AS",SD,PSGP,O)
"RTN","PSJO1",94,0)
 I $P(ND,U,9)["D" D  Q
"RTN","PSJO1",95,0)
 .K ^PS(53.1,"AS",SD,PSGP,O)
"RTN","PSJO1",96,0)
 .N ND2 S ND2=$G(^PS(53.1,O,.2)) I $P(ND2,U,8) K ^PS(53.1,"ACX",$P(ND2,U,8))
"RTN","PSJO1",97,0)
 S ST=$P($G(^PS(53.1,O,0)),U,7),START=-$P($G(^(2)),U,2),P("PRNTON")=$P($G(^PS(53.1,O,.2)),"^",8) S:ST="" ST="z"
"RTN","PSJO1",98,0)
 S C=$S(((SD="N")&($P($G(^PS(53.1,O,.2)),U,8)]"")):"BD",SD="N":"BA",SD="I":"BB",$P($G(^PS(53.1,O,.2)),U,8)]"":"CD",$P($G(^PS(53.1,O,.2)),U,4)="S":"CA",$P($G(^(0)),U,24)="R":"CC",1:"CB")
"RTN","PSJO1",99,0)
 ;I C="CC" S C=$$CKPC^PSGOU(PSGP,+$P($G(^PS(53.1,O,0)),U,25),O)
"RTN","PSJO1",100,0)
 D SET
"RTN","PSJO1",101,0)
 Q
"RTN","PSJO1",102,0)
 ;
"RTN","PSJO1",103,0)
KILL ;
"RTN","PSJO1",104,0)
 K P,STAT,TYP,ORTX,N,JJ
"RTN","PSJO1",105,0)
 Q
"RTN","PSJO1",106,0)
COMCHK(PSJCOM,PSJPTYP) ;Check complex orders for order type
"RTN","PSJO1",107,0)
 S OK=0
"RTN","PSJO1",108,0)
 I PSJCOM=0 S OK=1 Q OK
"RTN","PSJO1",109,0)
 I PSJCOM=""  Q OK
"RTN","PSJO1",110,0)
 I PSJPTYP="" Q OK
"RTN","PSJO1",111,0)
 I '$D(^PS(53.1,"ACX",PSJCOM)) Q OK
"RTN","PSJO1",112,0)
 S OK=1 I PSJPTYP=3 Q OK
"RTN","PSJO1",113,0)
 N PSJON S PSJON=""
"RTN","PSJO1",114,0)
 F  S PSJON=$O(^PS(53.1,"ACX",PSJCOM,PSJON)) Q:'PSJON  D  Q:OK=0
"RTN","PSJO1",115,0)
 .I $P($G(^PS(53.1,PSJON,0)),"^",9)["D" K ^PS(53.1,"ACX",PSJCOM)
"RTN","PSJO1",116,0)
 .I $P($G(^PS(53.1,PSJON,0)),"^",4)'="U",PSJPTYP=1 S OK=0 Q
"RTN","PSJO1",117,0)
 .I $P($G(^PS(53.1,PSJON,0)),"^",4)="U",PSJPTYP=2 S OK=0 Q
"RTN","PSJO1",118,0)
 Q OK
"RTN","PSJO1",119,0)
 ;
"RTN","PSJO1",120,0)
CLINIC(PSGP,ORDER) ; Return Clinic Name for a given patient/order combination
"RTN","PSJO1",121,0)
 I '$G(ORDER) Q ""
"RTN","PSJO1",122,0)
 N CLN S CLN=$S(ORDER["P":$G(^PS(53.1,+ORDER,"DSS")),ORDER["V":$G(^PS(55,PSGP,"IV",+ORDER,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+ORDER,8)),1:"")
"RTN","PSJO1",123,0)
 I 'CLN,(ORDER=+ORDER) D
"RTN","PSJO1",124,0)
 .I $D(^PS(53.1,"ACX",+ORDER)) N PSJORD S PSJORD=0 F  S PSJORD=$O(^PS(53.1,"ACX",+ORDER,PSJORD)) Q:'PSJORD!$G(CLN)  S CLN=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSJO1",125,0)
 .I $D(^PS(55,"ACX",+ORDER)) N ACX2,PSJORD S ACX2="" F  S ACX2=$O(^PS(55,"ACX",+ORDER,ACX2)) Q:'ACX2!$G(CLN)  S PSJORD=0 F  S PSJORD=$O(^PS(55,"ACX",+ORDER,ACX2,PSJORD)) Q:'PSJORD!$G(CLN)  D
"RTN","PSJO1",126,0)
 ..S CLN=$S(PSJORD["P":$G(^PS(53.1,+PSJORD,"DSS")),PSJORD["V":$G(^PS(55,PSGP,"IV",+PSJORD,"DSS")),ORDER["U":$G(^PS(55,PSGP,5,+PSJORD,8)),1:"")
"RTN","PSJO1",127,0)
 S CLN=$S($P(CLN,"^",2):$$GET1^DIQ(44,+CLN,.01),1:"")
"RTN","PSJO1",128,0)
 Q CLN
"RTN","PSJO1",129,0)
 ;
"RTN","PSJO1",130,0)
CLINSORT(C) ; Return integer sort value based on order status
"RTN","PSJO1",131,0)
 I $P(C,"^")="Cz" N CTMP S CTMP=C N C S C=$P(CTMP,"^",4)
"RTN","PSJO1",132,0)
 S SORT=$S($E(C)="A":3,$E(C)["C"!($E(C)["P"):1,($E(C)["B"):2,($E(C)["DF"):4,1:5)
"RTN","PSJO1",133,0)
 Q SORT
"VER")
8.0^22.0
**INSTALL NAME**
PSO*7.0*431
"BLD",8629,0)
PSO*7.0*431^OUTPATIENT PHARMACY^0^3140212^y
"BLD",8629,1,0)
^^22^22^3130828^
"BLD",8629,1,1,0)
 
"BLD",8629,1,2,0)
This patch is a MOCHA 2.0 fast track release patch to correct an issue 
"BLD",8629,1,3,0)
found late in IOC testing process for MOCHA 2.0.  The following is the 
"BLD",8629,1,4,0)
needed modification:
"BLD",8629,1,5,0)
 
"BLD",8629,1,6,0)
 
"BLD",8629,1,7,0)
1. For order level dosing order check messages that do not require the
"BLD",8629,1,8,0)
pharmacist to enter a signature code on the order and where there are more
"BLD",8629,1,9,0)
than three disabilities defined for the patient, the dose message in
"BLD",8629,1,10,0)
Outpatient Pharmacy for a pending order scrolls off the screen.  Examples
"BLD",8629,1,11,0)
of the message would be "FDB dosing information is not available for this
"BLD",8629,1,12,0)
drug" or "Drug not matched to NDF".
"BLD",8629,1,13,0)
 
"BLD",8629,1,14,0)
For Max Single Dose messages, the pharmacist is correctly required to sign
"BLD",8629,1,15,0)
the order and enter an intervention.  Pharmacists do have the opportunity
"BLD",8629,1,16,0)
to see the CPRS dosing message when the pending order is first opened in
"BLD",8629,1,17,0)
Outpatient Pharmacy.  The CPRS message is the same message the scrolls off
"BLD",8629,1,18,0)
the screen.
"BLD",8629,1,19,0)
 
"BLD",8629,1,20,0)
To correct this, an "Enter to continue" will be displayed to keep the 
"BLD",8629,1,21,0)
dose message from scrolling off the screen when the number of 
"BLD",8629,1,22,0)
disabilities to be displayed exceeds the screen length.
"BLD",8629,4,0)
^9.64PA^^
"BLD",8629,6.3)
5
"BLD",8629,"ABPKG")
n
"BLD",8629,"KRN",0)
^9.67PA^779.2^20
"BLD",8629,"KRN",.4,0)
.4
"BLD",8629,"KRN",.401,0)
.401
"BLD",8629,"KRN",.402,0)
.402
"BLD",8629,"KRN",.403,0)
.403
"BLD",8629,"KRN",.5,0)
.5
"BLD",8629,"KRN",.84,0)
.84
"BLD",8629,"KRN",3.6,0)
3.6
"BLD",8629,"KRN",3.8,0)
3.8
"BLD",8629,"KRN",9.2,0)
9.2
"BLD",8629,"KRN",9.8,0)
9.8
"BLD",8629,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",8629,"KRN",9.8,"NM",1,0)
PSOORNEW^^0^B92549598
"BLD",8629,"KRN",9.8,"NM",2,0)
PSOMLLD2^^0^B30902022
"BLD",8629,"KRN",9.8,"NM",3,0)
PSOCPB^^0^B84573403
"BLD",8629,"KRN",9.8,"NM","B","PSOCPB",3)

"BLD",8629,"KRN",9.8,"NM","B","PSOMLLD2",2)

"BLD",8629,"KRN",9.8,"NM","B","PSOORNEW",1)

"BLD",8629,"KRN",19,0)
19
"BLD",8629,"KRN",19.1,0)
19.1
"BLD",8629,"KRN",101,0)
101
"BLD",8629,"KRN",409.61,0)
409.61
"BLD",8629,"KRN",771,0)
771
"BLD",8629,"KRN",779.2,0)
779.2
"BLD",8629,"KRN",870,0)
870
"BLD",8629,"KRN",8989.51,0)
8989.51
"BLD",8629,"KRN",8989.52,0)
8989.52
"BLD",8629,"KRN",8994,0)
8994
"BLD",8629,"KRN","B",.4,.4)

"BLD",8629,"KRN","B",.401,.401)

"BLD",8629,"KRN","B",.402,.402)

"BLD",8629,"KRN","B",.403,.403)

"BLD",8629,"KRN","B",.5,.5)

"BLD",8629,"KRN","B",.84,.84)

"BLD",8629,"KRN","B",3.6,3.6)

"BLD",8629,"KRN","B",3.8,3.8)

"BLD",8629,"KRN","B",9.2,9.2)

"BLD",8629,"KRN","B",9.8,9.8)

"BLD",8629,"KRN","B",19,19)

"BLD",8629,"KRN","B",19.1,19.1)

"BLD",8629,"KRN","B",101,101)

"BLD",8629,"KRN","B",409.61,409.61)

"BLD",8629,"KRN","B",771,771)

"BLD",8629,"KRN","B",779.2,779.2)

"BLD",8629,"KRN","B",870,870)

"BLD",8629,"KRN","B",8989.51,8989.51)

"BLD",8629,"KRN","B",8989.52,8989.52)

"BLD",8629,"KRN","B",8994,8994)

"BLD",8629,"QUES",0)
^9.62^^
"BLD",8629,"REQB",0)
^9.611^1^1
"BLD",8629,"REQB",1,0)
PSO*7.0*416^2
"BLD",8629,"REQB","B","PSO*7.0*416",1)

"MBREQ")
1
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
431^3140212
"PKG",141,22,1,"PAH",1,1,0)
^^22^22^3140212
"PKG",141,22,1,"PAH",1,1,1,0)
 
"PKG",141,22,1,"PAH",1,1,2,0)
This patch is a MOCHA 2.0 fast track release patch to correct an issue 
"PKG",141,22,1,"PAH",1,1,3,0)
found late in IOC testing process for MOCHA 2.0.  The following is the 
"PKG",141,22,1,"PAH",1,1,4,0)
needed modification:
"PKG",141,22,1,"PAH",1,1,5,0)
 
"PKG",141,22,1,"PAH",1,1,6,0)
 
"PKG",141,22,1,"PAH",1,1,7,0)
1. For order level dosing order check messages that do not require the
"PKG",141,22,1,"PAH",1,1,8,0)
pharmacist to enter a signature code on the order and where there are more
"PKG",141,22,1,"PAH",1,1,9,0)
than three disabilities defined for the patient, the dose message in
"PKG",141,22,1,"PAH",1,1,10,0)
Outpatient Pharmacy for a pending order scrolls off the screen.  Examples
"PKG",141,22,1,"PAH",1,1,11,0)
of the message would be "FDB dosing information is not available for this
"PKG",141,22,1,"PAH",1,1,12,0)
drug" or "Drug not matched to NDF".
"PKG",141,22,1,"PAH",1,1,13,0)
 
"PKG",141,22,1,"PAH",1,1,14,0)
For Max Single Dose messages, the pharmacist is correctly required to sign
"PKG",141,22,1,"PAH",1,1,15,0)
the order and enter an intervention.  Pharmacists do have the opportunity
"PKG",141,22,1,"PAH",1,1,16,0)
to see the CPRS dosing message when the pending order is first opened in
"PKG",141,22,1,"PAH",1,1,17,0)
Outpatient Pharmacy.  The CPRS message is the same message the scrolls off
"PKG",141,22,1,"PAH",1,1,18,0)
the screen.
"PKG",141,22,1,"PAH",1,1,19,0)
 
"PKG",141,22,1,"PAH",1,1,20,0)
To correct this, an "Enter to continue" will be displayed to keep the 
"PKG",141,22,1,"PAH",1,1,21,0)
dose message from scrolling off the screen when the number of 
"PKG",141,22,1,"PAH",1,1,22,0)
disabilities to be displayed exceeds the screen length.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSOCPB")
0^3^B84573403
"RTN","PSOCPB",1,0)
PSOCPB ;BIR/BaB - pharmacy co-pay application cont'd ;1/30/07 9:08am
"RTN","PSOCPB",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**72,71,85,185,143,219,239,201,263,303,431**;DEC 1997;Build 5
"RTN","PSOCPB",3,0)
 ;
"RTN","PSOCPB",4,0)
 ;REF/IA
"RTN","PSOCPB",5,0)
 ;DIS^SDROUT2/112
"RTN","PSOCPB",6,0)
 ;^IBARX/125
"RTN","PSOCPB",7,0)
 ;VADPT/10061
"RTN","PSOCPB",8,0)
 ;SWSTAT^IBBAPI/4663
"RTN","PSOCPB",9,0)
COPAY ;
"RTN","PSOCPB",10,0)
 ;Called by PSON52,PSORN52...Requires PSOCPAY,PSOBILL,DEA=PSDEA,PSOFLAG
"RTN","PSOCPB",11,0)
 ;PSOFLAG=1 NEW, PSOFLAG=0 RENEW
"RTN","PSOCPB",12,0)
 S PSOSAVE=PSOCPAY ; Save original status of PSOCPAY
"RTN","PSOCPB",13,0)
 I '$G(PSOSCP)!('$G(PSOSCA)) D SCP^PSORN52D  ;CIDC-must ask sc if flagged for it in enrollment
"RTN","PSOCPB",14,0)
 I $G(PSODRUG("DEA"))["S"!($G(PSODRUG("DEA"))["I")!($G(PSODRUG("DEA"))["N") S PSOCPAY=0
"RTN","PSOCPB",15,0)
 G:+PSOBILL'=2&('$G(PSOSCA)) COPAY2
"RTN","PSOCPB",16,0)
 D FULL^VALM1
"RTN","PSOCPB",17,0)
 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSOCPB",18,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSOCPB",19,0)
 S DFN=+$G(PSODFN) D CHKPAG^PSOMLLD2,DIS^SDROUT2
"RTN","PSOCPB",20,0)
ASK ;
"RTN","PSOCPB",21,0)
 N PSOUFLAG S PSOUFLAG=0
"RTN","PSOCPB",22,0)
 K PSOCPZ("DFLG"),PSONEW("NEWCOPAY")
"RTN","PSOCPB",23,0)
 W ! K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOCPB",24,0)
 I $G(PSORX("SC"))="SC"!($G(PSORX("SC"))="NSC")!($G(PSOSCOTH)) D
"RTN","PSOCPB",25,0)
 . W:PSOSCP<50&($G(PSODRUG("DEA"))'["S")&($G(PSODRUG("DEA"))'["I")&($G(PSODRUG("DEA"))'["N") !,"This Rx has been flagged by the provider as: "_$S($G(PSOSCOTH):"NO COPAY",$G(PSORX("SC"))="SC":"NO COPAY",1:"COPAY"),! I $G(PSOSCOTX) S PSOSCOTX=2
"RTN","PSOCPB",26,0)
 S DIR("A")="Was treatment for Service Connected condition",DIR(0)="Y"
"RTN","PSOCPB",27,0)
 S DIR("?")="Enter 'Yes' if this prescription is for a Service Connected condition"
"RTN","PSOCPB",28,0)
 I $G(PSORX("SC"))]""!($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))'="") S DIR("B")=$S($G(PSORX("SC"))="SC":"YES",$G(PSORX("SC"))="NSC":"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",1:"")
"RTN","PSOCPB",29,0)
 I $G(PSONEWFF),$G(PSOFLAG) I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) S DIR("B")=$S($G(PSOANSQD("SC"))=1:"YES",1:"NO")
"RTN","PSOCPB",30,0)
 I $G(DIR("B"))="YES"!($G(DIR("B"))="NO") S PSOUFLAG=$G(DIR("B"))
"RTN","PSOCPB",31,0)
 I $G(DIR("B"))="" K DIR("B")
"RTN","PSOCPB",32,0)
 D ^DIR
"RTN","PSOCPB",33,0)
 I $G(Y)=1!($G(Y)=0) S PSOANSQ("SC")=$G(Y) I $G(PSONEWFF),$G(PSOFLAG) S PSOANSQD("SC")=$G(Y)
"RTN","PSOCPB",34,0)
 I PSOFLAG I Y["^"!($D(DTOUT))!($D(DUOUT)) S PSOCPZ("DFLG")=1
"RTN","PSOCPB",35,0)
 S:Y=0 Y=2
"RTN","PSOCPB",36,0)
 S PSOANSR=+Y I 'PSOANSR,'PSOFLAG D  S $P(PSOCPAY,"^")=$S($G(PSOUFLAG)="NO":1,1:0) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR G COPAY2
"RTN","PSOCPB",37,0)
 .W !!,"This Renewal has been designated as "_$S($G(PSOUFLAG)="YES":"SERVICE CONNECTED",1:"NON-SERVICE CONNECTED.")
"RTN","PSOCPB",38,0)
 .W:PSOSCP<50&($G(PSODRUG("DEA"))'["S")&($G(PSODRUG("DEA"))'["I")&($G(PSODRUG("DEA"))'["N") !,"Please use the 'Reset Copay Status/Cancel Charges' option to make corrections."
"RTN","PSOCPB",39,0)
 .S PSOANSQ("SC")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOCPB",40,0)
 I $G(PSOFLAG),$G(PSOCPZ("DFLG")) G EXIT
"RTN","PSOCPB",41,0)
 S:PSOANSR=1 PSOCPAY=0 S:PSOANSR=2 $P(PSOCPAY,"^")=1
"RTN","PSOCPB",42,0)
COPAY2 ;
"RTN","PSOCPB",43,0)
 N PSOPFS S PSOPFS=$$SWSTAT^IBBAPI()
"RTN","PSOCPB",44,0)
 I +PSOCPAY=1,($P(PSOCPAY,"^",2)=1)!($P(PSOCPAY,"^",2)=2) D
"RTN","PSOCPB",45,0)
 .;set IB node in ^PSRX for copay if xactn type is 1 or 2
"RTN","PSOCPB",46,0)
 .S PSONEW("NEWCOPAY")=$P($G(PSOCPAY),"^",2)_"^^"_$S(+$G(PSOPFS):"",1:$P($G(PSOCPAY),"^",2))
"RTN","PSOCPB",47,0)
EXIT ;
"RTN","PSOCPB",48,0)
 S PSOCPAY=PSOSAVE ;Restore val of PSOCPAY
"RTN","PSOCPB",49,0)
 K PSOSAVE,PSOANSR,DIR,DUOUT,DIRUT,DTOUT,Y,X
"RTN","PSOCPB",50,0)
 Q
"RTN","PSOCPB",51,0)
RESET ;RESET COPAY STATUS
"RTN","PSOCPB",52,0)
 K PSOSUMM,PSOPFS,PSOPFSA,PSOLFIL,PSOPFSG
"RTN","PSOCPB",53,0)
 I '$D(PSOPAR) D ^PSOLSET G RESET
"RTN","PSOCPB",54,0)
 W ! S DIC="^PSRX(",DIC(0)="AEQZ" D ^DIC K DIC G:Y<0 EXT S PSODA=+Y
"RTN","PSOCPB",55,0)
 W !,?17,"PATIENT: ",$P($G(^DPT($P(^PSRX(PSODA,0),"^",2),0)),"^")
"RTN","PSOCPB",56,0)
 D ICN^PSODPT($P(^PSRX(PSODA,0),"^",2))
"RTN","PSOCPB",57,0)
 S PSORXN=$P(^PSRX(PSODA,0),"^"),PREA="R"
"RTN","PSOCPB",58,0)
 S PCOPAY=$G(^PSRX(PSODA,"IB"))
"RTN","PSOCPB",59,0)
 W !!,"Rx # ",PSORXN," is a ",$S(+PCOPAY:"Copay",1:"No Copay")," prescription"
"RTN","PSOCPB",60,0)
 S PSOLFIL=$$LF^PSOPFSU1(PSODA) D PFSA^PSOPFSU1(PSODA,PSOLFIL,3)  ;PSOCPC def PSOPFSA=1 if OP SC/EI's change.
"RTN","PSOCPB",61,0)
 D EXEMCHK^PSOCPC ; CHECK/CHANGE EXEMPTION FLAGS
"RTN","PSOCPB",62,0)
 S PSOIBQ=$G(^PSRX(PSODA,"IBQ"))
"RTN","PSOCPB",63,0)
 I '$G(^PSRX(PSODA,"IB")),PSOIBQ'["1" D  G ASKCAN
"RTN","PSOCPB",64,0)
 . K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to reset the status to COPAY" D ^DIR K DIR
"RTN","PSOCPB",65,0)
 . I Y'=1 Q
"RTN","PSOCPB",66,0)
 . S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset : " D ^DIC K DIC I Y'<0 S PSORSN=+Y
"RTN","PSOCPB",67,0)
 . S PREA="R",PSOOLD="No Copay",PSONW="Copay",PSOCOMM="" D ACTLOG^PSOCPA
"RTN","PSOCPB",68,0)
 . S PSI=0,PSOCOMM="Copay status of this Rx has been reset to COPAY." D SETSUMM^PSOCPC
"RTN","PSOCPB",69,0)
 . S $P(^PSRX(PSODA,"IB"),"^")=1 ;Reset flag to COPAY
"RTN","PSOCPB",70,0)
 ;
"RTN","PSOCPB",71,0)
 I $G(^PSRX(PSODA,"IB")) D  G ASKCAN
"RTN","PSOCPB",72,0)
 . K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to reset the status to NO COPAYMENT" D ^DIR K DIR
"RTN","PSOCPB",73,0)
 . I Y'=1 Q
"RTN","PSOCPB",74,0)
 . S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset : " D ^DIC K DIC I Y'<0 S PSORSN=+Y
"RTN","PSOCPB",75,0)
 . S PREA="R",PSOOLD="Copay",PSONW="No Copay",PSOCOMM="" D ACTLOG^PSOCPA
"RTN","PSOCPB",76,0)
 . S PSI=0,PSOCOMM="Copay status of this Rx has been reset to NO COPAY." D SETSUMM^PSOCPC
"RTN","PSOCPB",77,0)
 . S $P(^PSRX(PSODA,"IB"),"^")="" ;Reset flag to NO COPAY
"RTN","PSOCPB",78,0)
ASKCAN D ASKCAN^PSOCPD
"RTN","PSOCPB",79,0)
 I '$D(PSOSUMM) S PSI=0,PSOCOMM="No action taken" D SETSUMM^PSOCPC
"RTN","PSOCPB",80,0)
 D PRTSUMM
"RTN","PSOCPB",81,0)
 I $P($G(PSOPFS),"^",3)>0&(+$G(PSOPFSA)) D CHRG^PSOPFSU1(PSODA,PSOLFIL,"CG",PSOPFS)
"RTN","PSOCPB",82,0)
RESETE K PSODA,PSORXN,PSORSN,PSOREF,X,Y,PCOPAY,PREA,PSOCOMM,PSI
"RTN","PSOCPB",83,0)
 G RESET
"RTN","PSOCPB",84,0)
EXT K PSODA,PSORXN,PSORSN,PSOREF,X,Y,PCOPAY,PREA,PSOCOPAY
"RTN","PSOCPB",85,0)
 Q
"RTN","PSOCPB",86,0)
BILLED ;Collect IB nums,cancel chrgs,reset flag.
"RTN","PSOCPB",87,0)
 W !!,"**********Charges are on file for this Rx.**********"
"RTN","PSOCPB",88,0)
 Q
"RTN","PSOCPB",89,0)
BILL2 ;
"RTN","PSOCPB",90,0)
 N PSOPREV ; VAR FOR PREV CANCELLED
"RTN","PSOCPB",91,0)
 S PSOPREV=0
"RTN","PSOCPB",92,0)
 S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset or Charge Cancellation : " D ^DIC K DIC G ENDMSG:Y<0 S PSORSN=+Y
"RTN","PSOCPB",93,0)
 S X=PSOPAR7_"^"_+$P(^PSRX(PSODA,0),"^",2)_"^^"_DUZ
"RTN","PSOCPB",94,0)
 S SAVX=X
"RTN","PSOCPB",95,0)
 I $D(PSOCAN) D:'$G(PSOPFS)  I +$G(PSOPFS)!($G(PSOPFSG)) D PFS^PSOPFSU1 G BILL2END:'$D(PSOCAN)
"RTN","PSOCPB",96,0)
 . N III S III="" F  S III=$O(PSOCAN(III)) Q:III=""  I PSOCAN(III)["PFS" S PSOPFSG=1 Q  ;PFSS switch off, check for prev cots billing
"RTN","PSOCPB",97,0)
 D POTBILL2
"RTN","PSOCPB",98,0)
 I '$D(PSOCAN) G BILL2END
"RTN","PSOCPB",99,0)
 I $G(CANTYPE) D PREVCAN I $O(X(""))="" Q
"RTN","PSOCPB",100,0)
 I '$G(CANTYPE) S I="" F  S I=$O(PSOCAN(I)) Q:I=""  S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN
"RTN","PSOCPB",101,0)
 D CANCEL^IBARX
"RTN","PSOCPB",102,0)
 I $G(CANTYPE) D MSG
"RTN","PSOCPB",103,0)
 I '$D(Y) Q
"RTN","PSOCPB",104,0)
 I +Y=-1 Q
"RTN","PSOCPB",105,0)
 I $D(Y(PSORXN)),+Y(PSORXN)'=-1 S $P(^PSRX(PSODA,"IB"),"^",2)=+Y(PSORXN) K Y(PSORXN) S PREA="C",PSOREF=0,PSOOLD="",PSONW="" D ACTLOG^PSOCPA I '$G(CANTYPE) D MSG
"RTN","PSOCPB",106,0)
 F PSOREF=0:0 S PSOREF=$O(Y(PSOREF)) Q:PSOREF=""  I +Y(PSOREF)'=-1 S ^PSRX(PSODA,1,PSOREF,"IB")=+Y(PSOREF) S PREA="C",PSOOLD="",PSONW="" D ACTLOG^PSOCPA I '$G(CANTYPE) D MSG
"RTN","PSOCPB",107,0)
BILL2END K X,Y,SAVX,PSOREF,PSOCAN
"RTN","PSOCPB",108,0)
 Q
"RTN","PSOCPB",109,0)
 ;
"RTN","PSOCPB",110,0)
POTBILL2 ;see if any potential charges (entries from file 354.71 -- bills that exceeded cap prev) to be cancelled before cancelling regular charges
"RTN","PSOCPB",111,0)
 N X,I
"RTN","PSOCPB",112,0)
 S X=SAVX
"RTN","PSOCPB",113,0)
 I $T(CANIBAM^IBARX)="" Q
"RTN","PSOCPB",114,0)
 S I="" F  S I=$O(PSOCAN(I)) Q:I=""  I PSOCAN(I)["^CAP" S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN K PSOCAN(I)
"RTN","PSOCPB",115,0)
 I $O(X(""))="" Q
"RTN","PSOCPB",116,0)
 S PSOPREV=1
"RTN","PSOCPB",117,0)
 D CANIBAM^IBARX
"RTN","PSOCPB",118,0)
 I $D(X(PSORXN)) S $P(^PSRX(PSODA,"IB"),"^",4)="" S PREA="C",PSOREF=0,PSOCOMM="Potential charge cancelled",PSOOLD="",PSONW="" D ACTLOG^PSOCPA D POTMSG K X(PSORXN)
"RTN","PSOCPB",119,0)
 F PSOREF=0:0 S PSOREF=$O(X(PSOREF)) Q:PSOREF=""  Q:PSOREF>11  S $P(^PSRX(PSODA,1,PSOREF,"IB"),"^",2)="" S PREA="C",PSOCOMM="Potential charge cancelled",PSOOLD="",PSONW="" D ACTLOG^PSOCPA D POTMSG
"RTN","PSOCPB",120,0)
 K PSOREF,PREA,PSOCOMM
"RTN","PSOCPB",121,0)
 Q
"RTN","PSOCPB",122,0)
REFILL S PSOREF=0
"RTN","PSOCPB",123,0)
 F  S PSOREF=$O(^PSRX(PSODA,1,PSOREF)) Q:PSOREF'?1N.N  D
"RTN","PSOCPB",124,0)
 . I $D(^PSRX(PSODA,1,PSOREF,"PFS")) S:$P($G(^PSRX(PSODA,1,PSOREF,"PFS")),"^",2) X(PSOREF)="^"_$G(PSORSN) Q
"RTN","PSOCPB",125,0)
 . I $D(^PSRX(PSODA,1,PSOREF,"IB")),+^("IB")>0 S X(PSOREF)=+^PSRX(PSODA,1,PSOREF,"IB")_"^"_$G(PSORSN)
"RTN","PSOCPB",126,0)
 S PSOREF=0 F  S PSOREF=$O(^PSRX(PSODA,1,PSOREF)) Q:PSOREF'?1N.N  I '$D(X(PSOREF)),+$P($G(^PSRX(PSODA,1,PSOREF,"IB")),"^",2) S XX(PSOREF)=+$P(^PSRX(PSODA,1,PSOREF,"IB"),"^",2)_"^"_$G(PSORSN) ; IF ONLY ENTRY FROM 354.71 SAVE IT
"RTN","PSOCPB",127,0)
 Q
"RTN","PSOCPB",128,0)
SETCP ;IF NOT COPAY MAKE ELIG CALL/SET FLAG FOR FUTURE
"RTN","PSOCPB",129,0)
 W ! S X=PSOPAR7_"^"_+$P(^PSRX(PSODA,0),"^",2)
"RTN","PSOCPB",130,0)
 D XTYPE^IBARX
"RTN","PSOCPB",131,0)
 I +Y=-1 W !!,"Error in processing Copay eligibility, no action taken." Q
"RTN","PSOCPB",132,0)
 S (ACTYP,BL)="",(PSOBILL,PSOCPAY)=0
"RTN","PSOCPB",133,0)
CP ;
"RTN","PSOCPB",134,0)
 S ACTYP=$O(Y(ACTYP)) G:'ACTYP CP1
"RTN","PSOCPB",135,0)
 F I=0:0 S BL=$O(Y(ACTYP,BL)) Q:BL=""  I BL>0 S PSOBILL=BL,PSOCPAY=ACTYP
"RTN","PSOCPB",136,0)
 G CP
"RTN","PSOCPB",137,0)
CP1 K ACTYP,BL,I
"RTN","PSOCPB",138,0)
 I (PSOBILL'>0)!(PSOCPAY=0) G INELIG
"RTN","PSOCPB",139,0)
 S $P(^PSRX(PSODA,"IB"),"^")=PSOCPAY
"RTN","PSOCPB",140,0)
 W !,"COPAY status on this Rx has been reset.",!,"*** Future refills will be classified as COPAY."
"RTN","PSOCPB",141,0)
 S PREA="R",PSOOLD="No Copay",PSONW="Copay"
"RTN","PSOCPB",142,0)
 D ACTLOG^PSOCPA
"RTN","PSOCPB",143,0)
 Q
"RTN","PSOCPB",144,0)
INELIG W !,"This Rx does not meet patient eligibility requirement for Copay.",!,"****** Status unchanged *******"
"RTN","PSOCPB",145,0)
 S Y=-1
"RTN","PSOCPB",146,0)
 Q
"RTN","PSOCPB",147,0)
ENDMSG K X W !,"Unable to process CHARGE REMOVAL without REASON for Reset."
"RTN","PSOCPB",148,0)
 R !,"ENTER a REASON now?  (Y/N) ",X:DTIME Q:'$T
"RTN","PSOCPB",149,0)
 I ($E(X)["?")!("YyNn^"'[$E(X)) W !,"Enter YES to select REASON and RESET STATUS." G ENDMSG
"RTN","PSOCPB",150,0)
 I "Yy"[$E(X) G BILL2
"RTN","PSOCPB",151,0)
 Q
"RTN","PSOCPB",152,0)
MSG ;
"RTN","PSOCPB",153,0)
 S PSI=0
"RTN","PSOCPB",154,0)
 I $G(CANTYPE) S PSOCOMM="Rx # "_PSORXN_" - All copay charges cancelled" D SETSUMM^PSOCPC K PSOCOMM Q
"RTN","PSOCPB",155,0)
 S PSOCOMM="Rx # "_PSORXN_" - "_$S(PSOREF=0:"Original fill",1:"Refill "_PSOREF)_" copay charge cancelled"
"RTN","PSOCPB",156,0)
 D SETSUMM^PSOCPC
"RTN","PSOCPB",157,0)
 K PSOCOMM
"RTN","PSOCPB",158,0)
 Q
"RTN","PSOCPB",159,0)
POTMSG ;
"RTN","PSOCPB",160,0)
 S PSI=0
"RTN","PSOCPB",161,0)
 I $G(CANTYPE) Q  ; (MESSAGE WILL GET SET LATER)
"RTN","PSOCPB",162,0)
 S PSOCOMM="Rx # "_PSORXN_" - "_$S(PSOREF=0:"Original fill",1:"Refill "_PSOREF)_" potential copay charge cancelled"
"RTN","PSOCPB",163,0)
 D SETSUMM^PSOCPC
"RTN","PSOCPB",164,0)
 K PSOCOMM
"RTN","PSOCPB",165,0)
 Q
"RTN","PSOCPB",166,0)
MSGNOCAN ;
"RTN","PSOCPB",167,0)
 S PSI=0
"RTN","PSOCPB",168,0)
 S PSOCOMM="Rx # "_PSORXN_" - All copay charges have already been cancelled." D SETSUMM^PSOCPC K PSOCOMM
"RTN","PSOCPB",169,0)
 Q
"RTN","PSOCPB",170,0)
 ;
"RTN","PSOCPB",171,0)
PRTSUMM ; prt sum of actions in reset/cancel
"RTN","PSOCPB",172,0)
 I '$D(PSOSUMM) Q
"RTN","PSOCPB",173,0)
 W !
"RTN","PSOCPB",174,0)
 S PSI=""
"RTN","PSOCPB",175,0)
 F  S PSI=$O(PSOSUMM(PSI)) Q:PSI=""  W !,PSOSUMM(PSI)
"RTN","PSOCPB",176,0)
 K PSOSUMM
"RTN","PSOCPB",177,0)
 Q
"RTN","PSOCPB",178,0)
PREVCAN ; PREVIEW CANCELS IF "ALL" IS SELECTED
"RTN","PSOCPB",179,0)
 N I,PSOBILL
"RTN","PSOCPB",180,0)
 S I="" F  S I=$O(PSOCAN(I)) Q:I=""  D  I PSOBILL S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN
"RTN","PSOCPB",181,0)
 . S PSOBILL=1 I $T(STATUS^IBARX)'="" I PSOCAN(I)'["CAP" S PSOBILL=$$STATUS^IBARX($P(PSOCAN(I),"^",2)) S:PSOBILL=2 PSOBILL=0 ; PREVIOUSLY CANCELLED
"RTN","PSOCPB",182,0)
 I $O(X(""))="" D
"RTN","PSOCPB",183,0)
 . I PSOPREV D MSG Q
"RTN","PSOCPB",184,0)
 . D MSGNOCAN
"RTN","PSOCPB",185,0)
 Q
"RTN","PSOCPB",186,0)
 ;
"RTN","PSOMLLD2")
0^2^B30902022
"RTN","PSOMLLD2",1,0)
PSOMLLD2 ;BIR/LE - Service Connection Check for SC>50% ;02/27/04
"RTN","PSOMLLD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,219,239,225,431**;DEC 1997;Build 5
"RTN","PSOMLLD2",3,0)
 ;External reference SDC022 supported by DBIA 1579
"RTN","PSOMLLD2",4,0)
 ;External reference DIS^SDROUT2 private by DBIA 112
"RTN","PSOMLLD2",5,0)
 ;External reference $$GETSHAD^DGUTL3 supported by DBIA 4462
"RTN","PSOMLLD2",6,0)
 ;External reference ^DPT(DFN,.372 private by DBIA 1476
"RTN","PSOMLLD2",7,0)
SC ;This routine is used for SC>50% - OUTSIDE OF COPAY - DFN AND PSOSCP VARIABLES ARE EXPECTED TO BE PRESENT WHEN CALLED
"RTN","PSOMLLD2",8,0)
 ; Requires: DFN, PSOSCP, PSOSCA 
"RTN","PSOMLLD2",9,0)
 I '$G(DFN) N DFN S DFN=+$G(PSODFN)
"RTN","PSOMLLD2",10,0)
 ;I $G(DFN) I '$$SC^SDCO22(DFN) D  Q  ;if SC>49 don't ask if api says not to
"RTN","PSOMLLD2",11,0)
 ;. K PSOANSQ("SC>50"),PSOANSQD("SC>50") I $G(PSOX("IRXN")) K PSOANSQ(PSOX("IRXN"),"SC>50")
"RTN","PSOMLLD2",12,0)
SC2 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSOMLLD2",13,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSOMLLD2",14,0)
 D CHKPAG,DIS^SDROUT2
"RTN","PSOMLLD2",15,0)
 N PSOUFLAG S PSOUFLAG=0 K DIR S DIR(0)="Y"
"RTN","PSOMLLD2",16,0)
 S DIR("A")="Was treatment for a Service Connected condition"
"RTN","PSOMLLD2",17,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition related",DIR("?",2)="to Service Connected."
"RTN","PSOMLLD2",18,0)
 I '$G(PSOFLAG) D
"RTN","PSOMLLD2",19,0)
 . I PSOSCP<50 S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",1:"") I DIR("B")="" K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",20,0)
 . I PSOSCP<50&($D(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))) S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=1:"YES",1:"") I DIR("B")=""  K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",21,0)
 . I PSOSCP>49 S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=1:"YES",1:"") I DIR("B")=""  K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",22,0)
 . I '$D(DIR("B"))&($D(PSOANSQD("SC>50"))!($D(PSOANSQD("SC")))) D  I '$D(DIR("B")) K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",23,0)
 .. I $D(PSOANSQD("SC>50")) I $G(PSOANSQD("SC>50"))=0!($G(PSOANSQD("SC>50"))=1) S (PSOUFLAG,DIR("B"))=$S($G(PSOANSQD("SC>50"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",24,0)
 .. I $D(PSOANSQD("SC")) I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) S (PSOUFLAG,DIR("B"))=$S($G(PSOANSQD("SC"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",25,0)
 I $G(PSORX("SC"))]""!($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))'="") S DIR("B")=$S($G(PSORX("SC"))="SC":"YES",$G(PSORX("SC"))="NSC":"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",1:"")
"RTN","PSOMLLD2",26,0)
 ;
"RTN","PSOMLLD2",27,0)
 I $G(PSOFLAG),$G(PSONEWFF) I $G(PSOANSQD("SC>50"))=0!($G(PSOANSQD("SC>50"))=1) S DIR("B")=$S($G(PSOANSQD("SC>50"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",28,0)
 I $G(DIR("B"))="YES"!($G(DIR("B"))="NO") S PSOUFLAG=$G(DIR("B"))
"RTN","PSOMLLD2",29,0)
 I $G(DIR("B"))="" K DIR("B")
"RTN","PSOMLLD2",30,0)
 W ! D ^DIR K DIR
"RTN","PSOMLLD2",31,0)
 I $G(Y)=1!($G(Y)=0) D  I $G(PSONEWFF),$G(PSOFLAG) S PSOANSQD("SC>50")=$G(Y)
"RTN","PSOMLLD2",32,0)
 . I $G(PSOX("IRXN")) S PSOANSQ(PSOX("IRXN"),"SC>50")=+Y
"RTN","PSOMLLD2",33,0)
 . S PSOANSQ("SC>50")=+Y
"RTN","PSOMLLD2",34,0)
 I PSOFLAG I Y["^"!($D(DTOUT))!($D(DUOUT)) S PSOCPZ("DFLG")=1
"RTN","PSOMLLD2",35,0)
 S:Y=0 Y=2
"RTN","PSOMLLD2",36,0)
 S PSOANSR=+Y I 'PSOANSR,'PSOFLAG D  S $P(PSOCPAY,"^")=$S($G(PSOUFLAG)="NO":1,1:0) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR Q
"RTN","PSOMLLD2",37,0)
 .W !!,"This Renewal has been designated as "_$S($G(PSOUFLAG)="YES":"SERVICE CONNECTED",1:"NON-SERVICE CONNECTED.")
"RTN","PSOMLLD2",38,0)
 .;W !,"Please use the 'Reset Copay Status/Cancel Charges' option to make  corrections."
"RTN","PSOMLLD2",39,0)
 .S PSOANSQ("SC>50")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOMLLD2",40,0)
 I $G(PSOFLAG),$G(PSOCPZ("DFLG")) G EXIT
"RTN","PSOMLLD2",41,0)
 S:PSOANSR=1 PSOCPAY=0 S:PSOANSR=2 $P(PSOCPAY,"^")=1
"RTN","PSOMLLD2",42,0)
EXIT ;
"RTN","PSOMLLD2",43,0)
 K PSOANSR,DIR,DUOUT,DIRUT,DTOUT,Y,X,PSOSCA
"RTN","PSOMLLD2",44,0)
 Q
"RTN","PSOMLLD2",45,0)
 ;
"RTN","PSOMLLD2",46,0)
PAUSE K DIR W ! S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOMLLD2",47,0)
 Q
"RTN","PSOMLLD2",48,0)
 ;
"RTN","PSOMLLD2",49,0)
SHAD ; PROJ 112/SHAD Question
"RTN","PSOMLLD2",50,0)
 I $G(PSODFN),$L($T(GETSHAD^DGUTL3)) I $$GETSHAD^DGUTL3(PSODFN)'=1 D  Q
"RTN","PSOMLLD2",51,0)
 . K PSOANSQ("SHAD"),PSOANSQD("SHAD") I $G(PSOX("IRXN")) K PSOANSQ(PSOX("IRXN"),"SHAD")
"RTN","PSOMLLD2",52,0)
 N PSOUFLAG S PSOUFLAG=0
"RTN","PSOMLLD2",53,0)
 K DIR S DIR(0)="Y"
"RTN","PSOMLLD2",54,0)
 S DIR("A")="Was treatment related to PROJ 112/SHAD"
"RTN","PSOMLLD2",55,0)
 S DIR("?")=" "
"RTN","PSOMLLD2",56,0)
 S DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition due to"
"RTN","PSOMLLD2",57,0)
 S DIR("?",2)="Shipboard Hazard and Defense (SHAD) exposure."
"RTN","PSOMLLD2",58,0)
 S DIR("?",3)="This response will be used to determine whether or not a copay should"
"RTN","PSOMLLD2",59,0)
 S DIR("?",4)="be applied to the prescription."
"RTN","PSOMLLD2",60,0)
 I '$G(PSOFLAG) D
"RTN","PSOMLLD2",61,0)
 . S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SHAD"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SHAD"))=1:"YES",1:"")
"RTN","PSOMLLD2",62,0)
 . I DIR("B")="" K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",63,0)
 I $G(PSOFLAG),$G(PSONEWFF) D
"RTN","PSOMLLD2",64,0)
 . I $G(PSOANSQD("SHAD"))=0!($G(PSOANSQD("SHAD"))=1) D
"RTN","PSOMLLD2",65,0)
 . . S DIR("B")=$S($G(PSOANSQD("SHAD"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",66,0)
 W ! D ^DIR K DIR
"RTN","PSOMLLD2",67,0)
 I $G(PSOFLAG) W ! D  Q
"RTN","PSOMLLD2",68,0)
 . I Y["^"!($D(DUOUT))!($G(DTOUT)) S PSOCPZ("DFLG")=1 Q
"RTN","PSOMLLD2",69,0)
 . S PSOANSQ("SHAD")=Y
"RTN","PSOMLLD2",70,0)
 . I $G(PSONEWFF) S PSOANSQD("SHAD")=Y
"RTN","PSOMLLD2",71,0)
 I Y["^"!($D(DUOUT))!($D(DTOUT)) D  Q
"RTN","PSOMLLD2",72,0)
 . W !!,"This Renewal has been designated as"_$S($G(PSOUFLAG)="YES":"",1:" NOT")_" being used for treatment of "
"RTN","PSOMLLD2",73,0)
 . W !,"Shipboard Hazard and Defense (SHAD) exposure." D:$G(PSOSCP)<50 MESS^PSOMLLDT D PAUSE
"RTN","PSOMLLD2",74,0)
 . S PSOANSQ(PSOX("IRXN"),"SHAD")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOMLLD2",75,0)
 I $G(PSOX("IRXN")) S PSOANSQ(PSOX("IRXN"),"SHAD")=Y
"RTN","PSOMLLD2",76,0)
 E  S PSOANSQ("SHAD")=Y
"RTN","PSOMLLD2",77,0)
 Q
"RTN","PSOMLLD2",78,0)
 ;
"RTN","PSOMLLD2",79,0)
CHKPAG ;
"RTN","PSOMLLD2",80,0)
 N PSODISCT,PSOIIIII,PSOIIII1 S (PSOIIII,PSODISCT)=0,PSOIIII1=""
"RTN","PSOMLLD2",81,0)
 F PSOIIII=0:0 S PSOIIII=$O(^DPT(DFN,.372,PSOIIII)) Q:'PSOIIII  S PSOIIII1=$G(^DPT(DFN,.372,PSOIIII,0)) I $P(PSOIIII1,"^",3) S PSODISCT=PSODISCT+1
"RTN","PSOMLLD2",82,0)
 I PSODISCT>3&$G(PSOORNEW) D HD^PSODDPR2(1,1)
"RTN","PSOMLLD2",83,0)
 Q
"RTN","PSOORNEW")
0^1^B92549598
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,390,391,372,416,431**;DEC 1997;Build 5
"RTN","PSOORNEW",3,0)
 ;^PS(50.7 -2223
"RTN","PSOORNEW",4,0)
 ;^PSDRUG -221
"RTN","PSOORNEW",5,0)
 ;^PS(50.606 -2174
"RTN","PSOORNEW",6,0)
 ;^PS(55 -2228
"RTN","PSOORNEW",7,0)
 ;EN1^ORCFLAG -3620
"RTN","PSOORNEW",8,0)
 ;
"RTN","PSOORNEW",9,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",10,0)
 ;
"RTN","PSOORNEW",11,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",12,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",13,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",14,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",15,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",16,0)
 .S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",17,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",18,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",19,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",20,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",21,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",22,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",23,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",24,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",25,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",26,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",27,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",28,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",29,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",30,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",34,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",35,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",36,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",37,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",38,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",39,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",40,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",41,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",42,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",43,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",44,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",45,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",47,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",48,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",49,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",50,0)
 S IEN=IEN+1
"RTN","PSOORNEW",51,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_+$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",52,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",53,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",57,0)
 D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",58,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",59,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",60,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",62,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",63,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",64,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",65,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",66,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",67,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",68,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",69,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",70,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",71,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",72,0)
 Q
"RTN","PSOORNEW",73,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",74,0)
 Q
"RTN","PSOORNEW",75,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",76,0)
EDTSEL N LST,FLD,OUT D KV S OUT=0
"RTN","PSOORNEW",77,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",78,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",79,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",80,0)
 Q
"RTN","PSOORNEW",81,0)
ACP ;
"RTN","PSOORNEW",82,0)
 N PSOORNEW,DIR,Y S Y=0,PSOORNEW=1
"RTN","PSOORNEW",83,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",84,0)
 . D FULL^VALM1
"RTN","PSOORNEW",85,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",86,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",87,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",88,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",89,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",90,0)
 . D KV
"RTN","PSOORNEW",91,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",92,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",93,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",94,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",95,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",96,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",97,0)
 ;
"RTN","PSOORNEW",98,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",99,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",100,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",101,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",102,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",103,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",104,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",105,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",106,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",107,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",108,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",109,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",110,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",111,0)
 ;
"RTN","PSOORNEW",112,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",113,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",114,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",115,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",116,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",117,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",118,0)
 S PSONEW("POE")=1 D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNEW",119,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNEW",120,0)
 I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOORNEW",121,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNEW",122,0)
 .S RXN=PSONEW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"Order Acceptance_OP"
"RTN","PSOORNEW",123,0)
 .D DAOC^PSONEW
"RTN","PSOORNEW",124,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",125,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",126,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",127,0)
 Q
"RTN","PSOORNEW",128,0)
KV K DIRUT,DUOUT,DTOUT,DIR,PSOEDDOS
"RTN","PSOORNEW",129,0)
 Q
"RTN","PSOORNEW",130,0)
REF D REF^PSOORFI4
"RTN","PSOORNEW",131,0)
 Q
"RTN","PSOORNEW",132,0)
1 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",133,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",134,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",135,0)
 ;
"RTN","PSOORNEW",136,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",137,0)
 ;
"RTN","PSOORNEW",138,0)
3 I $G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",139,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",140,0)
 N PSOEDDOS S PSOEDDOS=1 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",141,0)
 ;
"RTN","PSOORNEW",142,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",143,0)
 ;
"RTN","PSOORNEW",144,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",145,0)
 ;
"RTN","PSOORNEW",146,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",147,0)
 ;
"RTN","PSOORNEW",148,0)
13 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",149,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",150,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",151,0)
 ;
"RTN","PSOORNEW",152,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",153,0)
 ;
"RTN","PSOORNEW",154,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",155,0)
 N CPRN S CPRN=+$P($G(OR0),"^",24) D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",156,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",157,0)
 Q
"RTN","PSOORNEW",158,0)
 ;
"RTN","PSOORNEW",159,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",160,0)
 ;
"RTN","PSOORNEW",161,0)
8 N CPRN S CPRN=+$P($G(OR0),"^",24) D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",162,0)
 ;
"RTN","PSOORNEW",163,0)
10 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",164,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",165,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",166,0)
 ;
"RTN","PSOORNEW",167,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",168,0)
 ;
"RTN","PSOORNEW",169,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",170,0)
 ;
"RTN","PSOORNEW",171,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",172,0)
 ;
"RTN","PSOORNEW",173,0)
DRGMSG ;
"RTN","PSOORNEW",174,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",175,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",176,0)
 K SG
"RTN","PSOORNEW",177,0)
 Q
"RTN","PSOORNEW",178,0)
 ;
"RTN","PSOORNEW",179,0)
PZ ;
"RTN","PSOORNEW",180,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",181,0)
 Q
"VER")
8.0^22.0
**END**
**END**

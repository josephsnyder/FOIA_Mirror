KIDS Distribution saved on Feb 04, 2016@14:52:49
MOCHA ENH 2 GMRA OR PSJ PSO
**KIDS**:MOCHA ENH 2 COMBINED BUILD 1.0^GMRA*4.0*46^OR*3.0*269^PSJ*5.0*281^PSO*7.0*411^

**INSTALL NAME**
MOCHA ENH 2 COMBINED BUILD 1.0
"BLD",9238,0)
MOCHA ENH 2 COMBINED BUILD 1.0^^1^3160204^y
"BLD",9238,6.3)
31
"BLD",9238,10,0)
^9.63^4^4
"BLD",9238,10,1,0)
GMRA*4.0*46^1
"BLD",9238,10,2,0)
OR*3.0*269^1
"BLD",9238,10,3,0)
PSJ*5.0*281^1
"BLD",9238,10,4,0)
PSO*7.0*411^1
"BLD",9238,10,"B","GMRA*4.0*46",1)

"BLD",9238,10,"B","OR*3.0*269",2)

"BLD",9238,10,"B","PSJ*5.0*281",3)

"BLD",9238,10,"B","PSO*7.0*411",4)

"BLD",9238,"KRN",0)
^9.67PA^779.2^20
"BLD",9238,"KRN",.4,0)
.4
"BLD",9238,"KRN",.401,0)
.401
"BLD",9238,"KRN",.402,0)
.402
"BLD",9238,"KRN",.403,0)
.403
"BLD",9238,"KRN",.5,0)
.5
"BLD",9238,"KRN",.84,0)
.84
"BLD",9238,"KRN",3.6,0)
3.6
"BLD",9238,"KRN",3.8,0)
3.8
"BLD",9238,"KRN",9.2,0)
9.2
"BLD",9238,"KRN",9.8,0)
9.8
"BLD",9238,"KRN",19,0)
19
"BLD",9238,"KRN",19.1,0)
19.1
"BLD",9238,"KRN",101,0)
101
"BLD",9238,"KRN",409.61,0)
409.61
"BLD",9238,"KRN",771,0)
771
"BLD",9238,"KRN",779.2,0)
779.2
"BLD",9238,"KRN",870,0)
870
"BLD",9238,"KRN",8989.51,0)
8989.51
"BLD",9238,"KRN",8989.52,0)
8989.52
"BLD",9238,"KRN",8994,0)
8994
"BLD",9238,"KRN","B",.4,.4)

"BLD",9238,"KRN","B",.401,.401)

"BLD",9238,"KRN","B",.402,.402)

"BLD",9238,"KRN","B",.403,.403)

"BLD",9238,"KRN","B",.5,.5)

"BLD",9238,"KRN","B",.84,.84)

"BLD",9238,"KRN","B",3.6,3.6)

"BLD",9238,"KRN","B",3.8,3.8)

"BLD",9238,"KRN","B",9.2,9.2)

"BLD",9238,"KRN","B",9.8,9.8)

"BLD",9238,"KRN","B",19,19)

"BLD",9238,"KRN","B",19.1,19.1)

"BLD",9238,"KRN","B",101,101)

"BLD",9238,"KRN","B",409.61,409.61)

"BLD",9238,"KRN","B",771,771)

"BLD",9238,"KRN","B",779.2,779.2)

"BLD",9238,"KRN","B",870,870)

"BLD",9238,"KRN","B",8989.51,8989.51)

"BLD",9238,"KRN","B",8989.52,8989.52)

"BLD",9238,"KRN","B",8994,8994)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"VER")
8.0^22.0
**INSTALL NAME**
GMRA*4.0*46
"BLD",9231,0)
GMRA*4.0*46^ADVERSE REACTION TRACKING^0^3160204^y
"BLD",9231,1,0)
^^5^5^3120914^
"BLD",9231,1,1,0)
UPDATES ADVERSE REACTION TRACKING TO RETURN SIGN/SYMPTOM DATA WITH 
"BLD",9231,1,2,0)
COMPUTERIZED PATIENT RECORD SYSTEM (CPRS) ORDER CHECK MESSAGES AND TO 
"BLD",9231,1,3,0)
INLUCDE HEALTH DATA REPOSITORY (HDR) DATA WITH THE EN1^GMRADPT 
"BLD",9231,1,4,0)
APPLICATION PROGRAMMING INTERFACE (API). REFER TO THE PATCH DESCRIPTION 
"BLD",9231,1,5,0)
FOR ADDITIONAL INFORMATION.
"BLD",9231,4,0)
^9.64PA^^
"BLD",9231,6)
8^
"BLD",9231,6.3)
62
"BLD",9231,"INID")
^y
"BLD",9231,"INIT")
POST^GMRAY46
"BLD",9231,"KRN",0)
^9.67PA^779.2^20
"BLD",9231,"KRN",.4,0)
.4
"BLD",9231,"KRN",.401,0)
.401
"BLD",9231,"KRN",.402,0)
.402
"BLD",9231,"KRN",.403,0)
.403
"BLD",9231,"KRN",.5,0)
.5
"BLD",9231,"KRN",.84,0)
.84
"BLD",9231,"KRN",3.6,0)
3.6
"BLD",9231,"KRN",3.8,0)
3.8
"BLD",9231,"KRN",9.2,0)
9.2
"BLD",9231,"KRN",9.8,0)
9.8
"BLD",9231,"KRN",9.8,"NM",0)
^9.68A^8^8
"BLD",9231,"KRN",9.8,"NM",1,0)
GMRADPT^^0^B83164261
"BLD",9231,"KRN",9.8,"NM",2,0)
GMRAOR^^0^B151697530
"BLD",9231,"KRN",9.8,"NM",3,0)
GMRAPENC^^0^B5910833
"BLD",9231,"KRN",9.8,"NM",4,0)
GMRAOR1^^0^B6022298
"BLD",9231,"KRN",9.8,"NM",5,0)
GMRAOR2^^0^B14577566
"BLD",9231,"KRN",9.8,"NM",6,0)
GMRADSP0^^0^B2615214
"BLD",9231,"KRN",9.8,"NM",7,0)
GMRAHDR^^0^B21589009
"BLD",9231,"KRN",9.8,"NM",8,0)
GMRAOR0^^0^B35767706
"BLD",9231,"KRN",9.8,"NM","B","GMRADPT",1)

"BLD",9231,"KRN",9.8,"NM","B","GMRADSP0",6)

"BLD",9231,"KRN",9.8,"NM","B","GMRAHDR",7)

"BLD",9231,"KRN",9.8,"NM","B","GMRAOR",2)

"BLD",9231,"KRN",9.8,"NM","B","GMRAOR0",8)

"BLD",9231,"KRN",9.8,"NM","B","GMRAOR1",4)

"BLD",9231,"KRN",9.8,"NM","B","GMRAOR2",5)

"BLD",9231,"KRN",9.8,"NM","B","GMRAPENC",3)

"BLD",9231,"KRN",19,0)
19
"BLD",9231,"KRN",19.1,0)
19.1
"BLD",9231,"KRN",101,0)
101
"BLD",9231,"KRN",409.61,0)
409.61
"BLD",9231,"KRN",771,0)
771
"BLD",9231,"KRN",779.2,0)
779.2
"BLD",9231,"KRN",870,0)
870
"BLD",9231,"KRN",8989.51,0)
8989.51
"BLD",9231,"KRN",8989.52,0)
8989.52
"BLD",9231,"KRN",8994,0)
8994
"BLD",9231,"KRN","B",.4,.4)

"BLD",9231,"KRN","B",.401,.401)

"BLD",9231,"KRN","B",.402,.402)

"BLD",9231,"KRN","B",.403,.403)

"BLD",9231,"KRN","B",.5,.5)

"BLD",9231,"KRN","B",.84,.84)

"BLD",9231,"KRN","B",3.6,3.6)

"BLD",9231,"KRN","B",3.8,3.8)

"BLD",9231,"KRN","B",9.2,9.2)

"BLD",9231,"KRN","B",9.8,9.8)

"BLD",9231,"KRN","B",19,19)

"BLD",9231,"KRN","B",19.1,19.1)

"BLD",9231,"KRN","B",101,101)

"BLD",9231,"KRN","B",409.61,409.61)

"BLD",9231,"KRN","B",771,771)

"BLD",9231,"KRN","B",779.2,779.2)

"BLD",9231,"KRN","B",870,870)

"BLD",9231,"KRN","B",8989.51,8989.51)

"BLD",9231,"KRN","B",8989.52,8989.52)

"BLD",9231,"KRN","B",8994,8994)

"BLD",9231,"QDEF")
^^^^^^^^^^YES
"BLD",9231,"QUES",0)
^9.62^^
"BLD",9231,"REQB",0)
^9.611^2^2
"BLD",9231,"REQB",1,0)
GMRA*4.0*10^2
"BLD",9231,"REQB",2,0)
GMRA*4.0*44^2
"BLD",9231,"REQB","B","GMRA*4.0*10",1)

"BLD",9231,"REQB","B","GMRA*4.0*44",2)

"INIT")
POST^GMRAY46
"MBREQ")
1
"PKG",247,-1)
1^1
"PKG",247,0)
ADVERSE REACTION TRACKING^GMRA^Adverse Reaction Tracking package
"PKG",247,20,0)
^9.402P^1^1
"PKG",247,20,1,0)
2^^GMRAMRG
"PKG",247,20,1,1)

"PKG",247,20,"B",2,1)

"PKG",247,22,0)
^9.49I^1^1
"PKG",247,22,1,0)
4.0^2960328^2960718^11595
"PKG",247,22,1,"PAH",1,0)
46^3160204^11931
"PKG",247,22,1,"PAH",1,1,0)
^^5^5^3160204
"PKG",247,22,1,"PAH",1,1,1,0)
UPDATES ADVERSE REACTION TRACKING TO RETURN SIGN/SYMPTOM DATA WITH 
"PKG",247,22,1,"PAH",1,1,2,0)
COMPUTERIZED PATIENT RECORD SYSTEM (CPRS) ORDER CHECK MESSAGES AND TO 
"PKG",247,22,1,"PAH",1,1,3,0)
INLUCDE HEALTH DATA REPOSITORY (HDR) DATA WITH THE EN1^GMRADPT 
"PKG",247,22,1,"PAH",1,1,4,0)
APPLICATION PROGRAMMING INTERFACE (API). REFER TO THE PATCH DESCRIPTION 
"PKG",247,22,1,"PAH",1,1,5,0)
FOR ADDITIONAL INFORMATION.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","GMRADPT")
0^1^B83164261
"RTN","GMRADPT",1,0)
GMRADPT ;HIRMFO/RM,WAA - UTILITY TO GATHER PATIENT DATA ;11/16/2015  09:31
"RTN","GMRADPT",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,10,46**;Mar 29, 1996;Build 62
"RTN","GMRADPT",3,0)
EN1 ; ENTRY TO GATHER PATIENT A/AR DATA
"RTN","GMRADPT",4,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #10099
"RTN","GMRADPT",5,0)
 ;*BD
"RTN","GMRADPT",6,0)
 N GMRAOTH,GMRAV1
"RTN","GMRADPT",7,0)
 Q:'$D(DFN)
"RTN","GMRADPT",8,0)
 I '$D(GMRA)#2 S GMRA="0^0^111"
"RTN","GMRADPT",9,0)
 K GMRAL
"RTN","GMRADPT",10,0)
 S GMRAV1=1,GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRADPT",11,0)
 D DPT
"RTN","GMRADPT",12,0)
 Q
"RTN","GMRADPT",13,0)
 ;*ED
"RTN","GMRADPT",14,0)
EN2 ; ENTRY TO GATHER PATIENT A/AR DATA
"RTN","GMRADPT",15,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #10099
"RTN","GMRADPT",16,0)
 ;INPUT VARIABLES:
"RTN","GMRADPT",17,0)
 ;
"RTN","GMRADPT",18,0)
 ; DFN             Pointer to Patient file.
"RTN","GMRADPT",19,0)
 ; GMRA (OPTIONAL) A^B^C^D   DEFAULT="0^0^111^0"
"RTN","GMRADPT",20,0)
 ;    where  A = 0 return all reactions (allergic/non-allergic).
"RTN","GMRADPT",21,0)
 ;               1 return allergies only.
"RTN","GMRADPT",22,0)
 ;               2 return non-allergies only.
"RTN","GMRADPT",23,0)
 ;           B = 0 return all data (verified or non-verified).
"RTN","GMRADPT",24,0)
 ;               1 return only verified data.
"RTN","GMRADPT",25,0)
 ;               2 return only non-verified data.
"RTN","GMRADPT",26,0)
 ;           C = X_Y_Z
"RTN","GMRADPT",27,0)
 ;               where X, Y, and Z are either 0 or 1.  1 would mean to
"RTN","GMRADPT",28,0)
 ;               return an Adverse Reaction of that particular type,
"RTN","GMRADPT",29,0)
 ;               and zero means do not return an Adverse Reaction of
"RTN","GMRADPT",30,0)
 ;               that type.
"RTN","GMRADPT",31,0)
 ;               X is for TYPE=OTHER
"RTN","GMRADPT",32,0)
 ;               Y is for TYPE=FOOD
"RTN","GMRADPT",33,0)
 ;               Z is for TYPE=DRUG.
"RTN","GMRADPT",34,0)
 ;               E.g., 001 (return drug only), 111 (returns all types),
"RTN","GMRADPT",35,0)
 ;               and 010 (returns food only).
"RTN","GMRADPT",36,0)
 ;           D = 0 return local allergies only
"RTN","GMRADPT",37,0)
 ;               1 return local and remote allergies
"RTN","GMRADPT",38,0)
 ;OUTPUT VARIABLES:
"RTN","GMRADPT",39,0)
 ; GMRAL = 1 if patient has Adverse Reaction
"RTN","GMRADPT",40,0)
 ;         0 if patient has no known Adverse Reaction
"RTN","GMRADPT",41,0)
 ;      null if patient has not been asked about Adverse Reaction
"RTN","GMRADPT",42,0)
 ; GMRAL(PTR) = A^B^C^D^E^F^G^H^I^J^K
"RTN","GMRADPT",43,0)
 ;    where PTR = Either pointer to 120.8 for local reactions or 
"RTN","GMRADPT",44,0)
 ;                'R' appended with pointer to ^XTMP("ORRDI","ART",DFN, for remote reactions
"RTN","GMRADPT",45,0)
 ;          A = Pointer to Patient file.
"RTN","GMRADPT",46,0)
 ;          B = Free text of causative agent.
"RTN","GMRADPT",47,0)
 ;         *C = Type of reaction, where D is drug, F is food, and O is
"RTN","GMRADPT",48,0)
 ;              other.
"RTN","GMRADPT",49,0)
 ;          D = 1 if Adverse Reaction has been verified
"RTN","GMRADPT",50,0)
 ;              0 if Adverse Reaction has not been verified
"RTN","GMRADPT",51,0)
 ;          E = 0 if this is an allergic reaction
"RTN","GMRADPT",52,0)
 ;              1 if this is not an allergic reaction
"RTN","GMRADPT",53,0)
 ;        **F = the mechanism of reaction in the format:
"RTN","GMRADPT",54,0)
 ;              External format;Internal format
"RTN","GMRADPT",55,0)
 ;              (ALLERGY;0, PHARMACOLOGIC;2, UNKNOWN;U).
"RTN","GMRADPT",56,0)
 ;          G = Type of reaction.
"RTN","GMRADPT",57,0)
 ;              where   D = drug
"RTN","GMRADPT",58,0)
 ;                     DF = drug/food
"RTN","GMRADPT",59,0)
 ;                    DFO = drug/food/other
"RTN","GMRADPT",60,0)
 ;                     DO = drug/other
"RTN","GMRADPT",61,0)
 ;                      F = food
"RTN","GMRADPT",62,0)
 ;                     FO = food/other
"RTN","GMRADPT",63,0)
 ;                      O = other
"RTN","GMRADPT",64,0)
 ;          H = the mechanism of reaction in the format:
"RTN","GMRADPT",65,0)
 ;              External format;Internal format
"RTN","GMRADPT",66,0)
 ;              (ALLERGY;A, PHARMACOLOGIC;P, UNKNOWN;U)
"RTN","GMRADPT",67,0)
 ;          I = variable pointer to the causative agent returned in piece B
"RTN","GMRADPT",68,0)
 ;          J = observed/historical of the reaction in the format:
"RTN","GMRADPT",69,0)
 ;              External format;Internal format
"RTN","GMRADPT",70,0)
 ; GMRAL(PTR,"S",COUNT) = S^D
"RTN","GMRADPT",71,0)
 ;    where COUNT = number 1 to number of signs/symptoms for this
"RTN","GMRADPT",72,0)
 ;                  reaction.
"RTN","GMRADPT",73,0)
 ;              S = a sign/symptom for this reaction in the format:
"RTN","GMRADPT",74,0)
 ;                  External format;Internal format
"RTN","GMRADPT",75,0)
 ;              D = date/time sign/symptom entered in the format:
"RTN","GMRADPT",76,0)
 ;                  External format;Internal format
"RTN","GMRADPT",77,0)
 ; GMRAL(PTR,"O",COUNT) = S^D
"RTN","GMRADPT",78,0)
 ;    where COUNT = number 1 to number of observations for this
"RTN","GMRADPT",79,0)
 ;                  reaction.
"RTN","GMRADPT",80,0)
 ;              S = a severity for this reaction in the format:
"RTN","GMRADPT",81,0)
 ;                  External format;Internal format
"RTN","GMRADPT",82,0)
 ;              D = date/time of observation in the format:
"RTN","GMRADPT",83,0)
 ;                  External format;Internal format
"RTN","GMRADPT",84,0)
 ; GMRAL(PTR,"SITE") = SITE
"RTN","GMRADPT",85,0)
 ;    where SITE = reporting institution in the format:
"RTN","GMRADPT",86,0)
 ;                 Institution File (#4) Pointer^Station Name^Station Number
"RTN","GMRADPT",87,0)
 ;                 Note: This will only exist for remote reactions
"RTN","GMRADPT",88,0)
 ;
"RTN","GMRADPT",89,0)
 ;*  NOTE: This piece will no longer be supported after 9/1/97,
"RTN","GMRADPT",90,0)
 ;         Please use piece G.
"RTN","GMRADPT",91,0)
 ;** NOTE: This piece will no longer be supported after 9/1/97,
"RTN","GMRADPT",92,0)
 ;         Please use piece H.
"RTN","GMRADPT",93,0)
 ;
"RTN","GMRADPT",94,0)
 ;*BD
"RTN","GMRADPT",95,0)
 D DPT2
"RTN","GMRADPT",96,0)
 Q
"RTN","GMRADPT",97,0)
 ;*ED
"RTN","GMRADPT",98,0)
DPT ;
"RTN","GMRADPT",99,0)
 ;*BD
"RTN","GMRADPT",100,0)
 ;Read NKA Node in file 120.86
"RTN","GMRADPT",101,0)
 S GMRAL=$P($G(^GMR(120.86,DFN,0)),U,2)
"RTN","GMRADPT",102,0)
 ;Do not set GMRAL array if patient is unassessed or NKA.
"RTN","GMRADPT",103,0)
 I GMRAL=0 Q  ;PATIENT HAS NO KNOWN ALLERGIES
"RTN","GMRADPT",104,0)
 F GMRAREC=0:0 S GMRAREC=$O(^GMR(120.8,"B",DFN,GMRAREC)) Q:GMRAREC'>0  S GMRANODE=$S($D(^GMR(120.8,GMRAREC,0)):^(0),1:"") D:GMRANODE SETAL(0)
"RTN","GMRADPT",105,0)
 I GMRAL=1,+$O(GMRAL(0))'>0 S GMRAL=0 ;if flag is set to 1 (reactions exist), then make certain the reactions are passed in the GMRAL array
"RTN","GMRADPT",106,0)
 K GMRA,GMRANODE,GMRAOSOF,GMRAREC,GMRATCNT
"RTN","GMRADPT",107,0)
 Q
"RTN","GMRADPT",108,0)
DPT2 ;DO NOT CALL THIS ENTRY POINT AS IT WILL BE DELETED IN THE FUTURE. USE EN2 INSTEAD.
"RTN","GMRADPT",109,0)
 ;*ED
"RTN","GMRADPT",110,0)
 N GMRAOTH,REMOTE,MECH,IDX,GMRANODE,GMRAOSOF,GMRAREC,GMRATCNT
"RTN","GMRADPT",111,0)
 Q:'$D(DFN)
"RTN","GMRADPT",112,0)
 I '$D(GMRA)#2 S GMRA="0^0^111^0"
"RTN","GMRADPT",113,0)
 K GMRAL
"RTN","GMRADPT",114,0)
 S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRADPT",115,0)
 S REMOTE=$S(+$P(GMRA,U,4):$$HDRDATA^GMRAHDR,1:0)
"RTN","GMRADPT",116,0)
 S GMRAL=$$NKA^GMRANKA(DFN)
"RTN","GMRADPT",117,0)
 I +GMRAL=0,$P(GMRA,U,4),($D(^XTMP("ORRDI","ART",DFN,"ASSESSMENT"))>9) D
"RTN","GMRADPT",118,0)
 .S IDX=0 F  S IDX=$O(^XTMP("ORRDI","ART",DFN,"ASSESSMENT",IDX)) Q:'IDX  D
"RTN","GMRADPT",119,0)
 ..N RETURN
"RTN","GMRADPT",120,0)
 ..S RETURN=$$INTERNAL(120.86,1,^XTMP("ORRDI","ART",DFN,"ASSESSMENT",1))
"RTN","GMRADPT",121,0)
 ..I RETURN=1 S GMRAL=1
"RTN","GMRADPT",122,0)
 ..I GMRAL'=1,(RETURN=0) S GMRAL=0
"RTN","GMRADPT",123,0)
 Q:+GMRAL=0
"RTN","GMRADPT",124,0)
 D MECH
"RTN","GMRADPT",125,0)
 F GMRAREC=0:0 S GMRAREC=$O(^GMR(120.8,"B",DFN,GMRAREC)) Q:GMRAREC'>0  S GMRANODE=$S($D(^GMR(120.8,GMRAREC,0)):^(0),1:"") D:GMRANODE SETAL(0)
"RTN","GMRADPT",126,0)
 I +$G(REMOTE)>0 D
"RTN","GMRADPT",127,0)
 .N INDEX
"RTN","GMRADPT",128,0)
 .S INDEX=0 F  S INDEX=$O(^XTMP("ORRDI","ART",DFN,INDEX)) Q:+$G(INDEX)=0  D
"RTN","GMRADPT",129,0)
 ..N GMRANODE,GMRAREC,RETURN
"RTN","GMRADPT",130,0)
 ..S GMRAREC=$NA(^XTMP("ORRDI","ART",DFN,INDEX))
"RTN","GMRADPT",131,0)
 ..S RETURN=$$INTERNAL(120.8,17,$G(@GMRAREC@("MECHANISM",0)))
"RTN","GMRADPT",132,0)
 ..S:RETURN'=-1 $P(GMRANODE,U,14)=RETURN
"RTN","GMRADPT",133,0)
 ..S RETURN=$$UP^XLFSTR($E($G(@GMRAREC@("VERIFIED",0)),1))
"RTN","GMRADPT",134,0)
 ..S $P(GMRANODE,U,16)=$S(RETURN="Y":1,RETURN="N":0,1:"")
"RTN","GMRADPT",135,0)
 ..S $P(GMRANODE,U,20)=$P($G(@GMRAREC@("TYPE",0)),U,1)
"RTN","GMRADPT",136,0)
 ..D SETAL(1)
"RTN","GMRADPT",137,0)
 I GMRAL=1,$O(GMRAL(0))="" S GMRAL=0
"RTN","GMRADPT",138,0)
 K GMRA
"RTN","GMRADPT",139,0)
 Q
"RTN","GMRADPT",140,0)
INTERNAL(FILE,FIELD,VALUE) ;RETURN INTERNAL VALUE OF VUID
"RTN","GMRADPT",141,0)
 ;PARAMETERS: FILE => FILE NUMBER WHERE THE DATA RESIDES
"RTN","GMRADPT",142,0)
 ;            FIELD => FIELD NUMBER WHERE THE DATA RESIDES
"RTN","GMRADPT",143,0)
 ;            VALUE => CARET-DELIMITED STRING WHERE THE FIRST
"RTN","GMRADPT",144,0)
 ;                     PIECE CONTAINS THE VUID
"RTN","GMRADPT",145,0)
 ;RETURNS: -1 => BAD INPUT PARAMETERS
"RTN","GMRADPT",146,0)
 ;         INTERNAL VALUE OF VUID
"RTN","GMRADPT",147,0)
 N RETURN
"RTN","GMRADPT",148,0)
 S RETURN=-1
"RTN","GMRADPT",149,0)
 Q:$G(VALUE)="" RETURN
"RTN","GMRADPT",150,0)
 N GMRARRAY
"RTN","GMRADPT",151,0)
 D GETIREF^XTID(FILE,,$P(VALUE,U,1),"GMRARRAY")
"RTN","GMRADPT",152,0)
 S:$D(GMRARRAY(FILE,FIELD))>9 RETURN=$O(GMRARRAY(FILE,FIELD,""))
"RTN","GMRADPT",153,0)
 Q RETURN
"RTN","GMRADPT",154,0)
SETAL(REMOTE) ;DETERMINE WHETHER TO RETURN CURRENT ALLERGY
"RTN","GMRADPT",155,0)
 ;PARAMETER: REMOTE => 0 IF ALLERGY IS LOCAL, 1 IF IT IS REMOTE
"RTN","GMRADPT",156,0)
 N %,GMRAI,GMRASIGN
"RTN","GMRADPT",157,0)
 I 'REMOTE,(+$G(^GMR(120.8,GMRAREC,"ER"))) Q  ;IF LOCAL AND ENTERED IN ERROR QUIT (REMOTE ENTERED IN ERROR ALREADY FILTERED)
"RTN","GMRADPT",158,0)
 I GMRAL'=1 S GMRAL=1 ; PATIENT HAS ALLERGIES
"RTN","GMRADPT",159,0)
 S GMRAI=0 ; BEGIN CHECK FOR ADR/ALL CRITERIA
"RTN","GMRADPT",160,0)
 I '$P(GMRA,"^") S GMRAI=1
"RTN","GMRADPT",161,0)
 E  I $P(GMRA,"^")=1 S:$F("AU",$P(GMRANODE,"^",14))>1 GMRAI=1
"RTN","GMRADPT",162,0)
 E  S:$F("P",$P(GMRANODE,"^",14))>1 GMRAI=1
"RTN","GMRADPT",163,0)
 Q:'GMRAI  ; QUIT IF ADR/ALL CRITERIA NOT MET
"RTN","GMRADPT",164,0)
 Q:2-$P(GMRA,"^",2)=(1-$P(GMRANODE,"^",16))  ;QUIT IF VER/NON VER CRITERIA NOT MET
"RTN","GMRADPT",165,0)
 S GMRAI=0 ; BEGIN CHECK FOR ALLERGY TYPE CRITERIA
"RTN","GMRADPT",166,0)
 F %=1:1:3 I $E($P(GMRA,"^",3),%),$P(GMRANODE,"^",20)[$E("OFD",%) S GMRAI=1 Q
"RTN","GMRADPT",167,0)
 Q:'GMRAI  ; QUIT IF ALLERGY TYPE CRITERIA NOT MET
"RTN","GMRADPT",168,0)
 D DATA(.GMRAREC,.GMRAL)
"RTN","GMRADPT",169,0)
 Q
"RTN","GMRADPT",170,0)
DATA(GMRAREC,GMRAL) ;RETRIEVE THE APPROPRIATE DATA
"RTN","GMRADPT",171,0)
 ;PARAMETERS: GMRAREC => REFERENCE TO THE VARIABLE CONTAINING THE CURRENT ALLERGY'S IEN
"RTN","GMRADPT",172,0)
 ;            GMRAL => REFERENCE TO THE ARRAY IN WHICH TO RETURN DATA
"RTN","GMRADPT",173,0)
 D:+$G(GMRAREC)>0 PASS(.GMRAREC,.GMRAL)
"RTN","GMRADPT",174,0)
 D:+$G(GMRAREC)=0 REMOTE(.GMRAL,.GMRAREC)
"RTN","GMRADPT",175,0)
 Q
"RTN","GMRADPT",176,0)
PASS(GMRAREC,GMRAL) ;RETRIEVE LOCAL DATA
"RTN","GMRADPT",177,0)
 ;PARAMETERS: GMRAREC => IEN OF THE CURRENT ALLERGY
"RTN","GMRADPT",178,0)
 ;            GMRAL => ARRAY IN WHICH TO RETURN DATA
"RTN","GMRADPT",179,0)
 N GMRANODE,%,GMRAX,GMRAY,GMRAZ,GMRAKC
"RTN","GMRADPT",180,0)
 I '$D(MECH) D
"RTN","GMRADPT",181,0)
 .D MECH
"RTN","GMRADPT",182,0)
 .S GMRAKC=1
"RTN","GMRADPT",183,0)
 S GMRANODE=$G(^GMR(120.8,GMRAREC,0)) Q:GMRANODE=""
"RTN","GMRADPT",184,0)
 S %=$P(GMRANODE,U,14)
"RTN","GMRADPT",185,0)
 S GMRAL(GMRAREC)=$P(GMRANODE,U,1,2)_U_$E($P(GMRANODE,U,20))_U_+$P(GMRANODE,U,16)_U_$S(%="A"!(%="U"):0,1:1)
"RTN","GMRADPT",186,0)
 S GMRAL(GMRAREC)=GMRAL(GMRAREC)_U_$S(%="A":"ALLERGY;0",%="P":"PHARMACOLOGIC;2",%="U":"UNKNOWN;U",1:"")_U_$P(GMRANODE,U,20)_U_$G(MECH(%))
"RTN","GMRADPT",187,0)
 S GMRAL(GMRAREC)=GMRAL(GMRAREC)_U_$P(GMRANODE,U,3)
"RTN","GMRADPT",188,0)
 ;*BD
"RTN","GMRADPT",189,0)
 I '$G(GMRAV1) D
"RTN","GMRADPT",190,0)
 .;*ED
"RTN","GMRADPT",191,0)
 .S %=$P(GMRANODE,U,6)
"RTN","GMRADPT",192,0)
 .S GMRAL(GMRAREC)=GMRAL(GMRAREC)_U_$$EXTERNAL^DILFD(120.8,6,,%)_";"_%
"RTN","GMRADPT",193,0)
 .I $D(^GMR(120.85,"C",GMRAREC))>9 D
"RTN","GMRADPT",194,0)
 ..N IEN,IDX
"RTN","GMRADPT",195,0)
 ..S IEN=0 F  S IEN=$O(^GMR(120.85,"C",GMRAREC,IEN)) Q:'+IEN  D
"RTN","GMRADPT",196,0)
 ...S IDX=1+$G(IDX),%=$P($G(^GMR(120.85,IEN,0)),U,14)
"RTN","GMRADPT",197,0)
 ...S GMRAL(GMRAREC,"O",IDX)=$$EXTERNAL^DILFD(120.85,14.5,,%)_";"_%_U
"RTN","GMRADPT",198,0)
 ...S %=$P($G(^GMR(120.85,IEN,0)),U)
"RTN","GMRADPT",199,0)
 ...S GMRAL(GMRAREC,"O",IDX)=GMRAL(GMRAREC,"O",IDX)_$$EXTERNAL^DILFD(120.85,.01,,%)_";"_%
"RTN","GMRADPT",200,0)
 I $O(^GMR(120.8,GMRAREC,10,0)) D
"RTN","GMRADPT",201,0)
 .S GMRAX=0,GMRAY=1 F  S GMRAX=$O(^GMR(120.8,GMRAREC,10,GMRAX)) Q:GMRAX<1  D
"RTN","GMRADPT",202,0)
 ..S GMRAZ=$G(^GMR(120.8,GMRAREC,10,GMRAX,0))
"RTN","GMRADPT",203,0)
 ..Q:GMRAZ=""
"RTN","GMRADPT",204,0)
 ..S GMRAZ(1)=$S(+GMRAZ'=GMRAOTH:$P($G(^GMRD(120.83,+GMRAZ,0)),U)_";"_+GMRAZ,1:$P(GMRAZ,U,2)_";"_+GMRAZ)
"RTN","GMRADPT",205,0)
 ..;*BD
"RTN","GMRADPT",206,0)
 ..I '$G(GMRAV1) D
"RTN","GMRADPT",207,0)
 ...;*ED (CLEAN UP PERIODS)
"RTN","GMRADPT",208,0)
 ...S GMRAZ(1)=GMRAZ(1)_U_$$FMTE^XLFDT($P(GMRAZ,U,4))_";"_$P(GMRAZ,U,4)
"RTN","GMRADPT",209,0)
 ..S GMRAL(GMRAREC,"S",GMRAY)=GMRAZ(1),GMRAY=GMRAY+1
"RTN","GMRADPT",210,0)
 K:+$G(GMRAKC) MECH
"RTN","GMRADPT",211,0)
 Q
"RTN","GMRADPT",212,0)
REMOTE(GMRAL,NODE) ;RETRIEVE REMOTE DATA
"RTN","GMRADPT",213,0)
 ;PARAMETERS: GMRAL => ARRAY IN WHICH TO RETURN DATA
"RTN","GMRADPT",214,0)
 ;            NODE => IEN OF THE CURRENT ALLERGY
"RTN","GMRADPT",215,0)
 S MECH=$P(GMRANODE,U,14)
"RTN","GMRADPT",216,0)
 ;A, B, & C
"RTN","GMRADPT",217,0)
 S GMRAL("R"_INDEX)=DFN_U_$G(@NODE@("REACTANT",0))_U_U
"RTN","GMRADPT",218,0)
 ;D
"RTN","GMRADPT",219,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_+$P(GMRANODE,U,16)_U
"RTN","GMRADPT",220,0)
 ;E & F
"RTN","GMRADPT",221,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_$S(MECH="A"!(MECH="U"):0,1:1)_U_U
"RTN","GMRADPT",222,0)
 ;G
"RTN","GMRADPT",223,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_$P(GMRANODE,U,20)_U
"RTN","GMRADPT",224,0)
 ;H
"RTN","GMRADPT",225,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_$S(MECH'="":$G(MECH(MECH)),1:"")_U
"RTN","GMRADPT",226,0)
 ;I
"RTN","GMRADPT",227,0)
 N VUID,FILE,IEN,GLOBAL,RETURN,ERROR,GMRARRAY
"RTN","GMRADPT",228,0)
 S VUID=$P($G(@NODE@("GMRALLERGY",0)),U,1)
"RTN","GMRADPT",229,0)
 S FILE=$P($P($G(@NODE@("GMRALLERGY",0)),U,3),"99VA",2)
"RTN","GMRADPT",230,0)
 I FILE>0 D
"RTN","GMRADPT",231,0)
 .D FILE^DID(FILE,,"GLOBAL NAME","RETURN","ERROR")
"RTN","GMRADPT",232,0)
 .Q:$D(ERROR)
"RTN","GMRADPT",233,0)
 .D GETIREF^XTID(FILE,,VUID,"GMRARRAY")
"RTN","GMRADPT",234,0)
 .S IEN=0 F  S IEN=$O(GMRARRAY(FILE,.01,IEN)) Q:+$G(IEN)=0  D
"RTN","GMRADPT",235,0)
 ..S $P(GMRAL("R"_INDEX),U,9)=+IEN_";"_$P(RETURN("GLOBAL NAME"),U,2)
"RTN","GMRADPT",236,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_U
"RTN","GMRADPT",237,0)
 ;J
"RTN","GMRADPT",238,0)
 N OBSHIS
"RTN","GMRADPT",239,0)
 I $D(@NODE@("OBS/HISTORICAL"))>9 D
"RTN","GMRADPT",240,0)
 .N GMRARRAY
"RTN","GMRADPT",241,0)
 .D GETIREF^XTID(120.8,,$P($G(@NODE@("OBS/HISTORICAL",0)),U,1),"GMRARRAY")
"RTN","GMRADPT",242,0)
 .S OBSHIS=$O(GMRARRAY(120.8,6,"")),OBSHIS=$$EXTERNAL^DILFD(120.8,6,,OBSHIS)_";"_OBSHIS
"RTN","GMRADPT",243,0)
 S GMRAL("R"_INDEX)=GMRAL("R"_INDEX)_$G(OBSHIS)
"RTN","GMRADPT",244,0)
 ;K
"RTN","GMRADPT",245,0)
 I $D(@NODE@("SEVERITY"))>9 D
"RTN","GMRADPT",246,0)
 .S GMRAL("R"_INDEX,"O",1)=$P($G(@NODE@("SEVERITY",0)),U,2)_";"_$P($G(@NODE@("SEVERITY",0)),U)_U
"RTN","GMRADPT",247,0)
 N SINDEX,DATE
"RTN","GMRADPT",248,0)
 S SINDEX=0 F  S SINDEX=$O(@NODE@("SIGNS/SYMPTOMS",SINDEX)) Q:+$G(SINDEX)=0  D
"RTN","GMRADPT",249,0)
 .I $P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,3)="L" D
"RTN","GMRADPT",250,0)
 ..S GMRAL("R"_INDEX,"S",SINDEX)=$P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,2)_";"_GMRAOTH
"RTN","GMRADPT",251,0)
 .I $P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,3)'="L" D
"RTN","GMRADPT",252,0)
 ..N GMRARRAY
"RTN","GMRADPT",253,0)
 ..S VUID=$P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,1)
"RTN","GMRADPT",254,0)
 ..S FILE=$P($P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,3),"99VA",2)
"RTN","GMRADPT",255,0)
 ..D GETIREF^XTID(FILE,,VUID,"GMRARRAY")
"RTN","GMRADPT",256,0)
 ..S IEN=0 F  S IEN=$O(GMRARRAY(FILE,.01,IEN)) Q:+$G(IEN)=0  D
"RTN","GMRADPT",257,0)
 ...S GMRAL("R"_INDEX,"S",SINDEX)=$P($G(@NODE@("SIGNS/SYMPTOMS",SINDEX)),U,2)_";"_+IEN
"RTN","GMRADPT",258,0)
 .S DATE=$$HL7TFM^XLFDT($G(@NODE@("SIGNS/SYMPTOMS",SINDEX,"DATE_ENTERED",0)))
"RTN","GMRADPT",259,0)
 .S $P(GMRAL("R"_INDEX,"S",SINDEX),U,2)=$$FMTE^XLFDT(DATE)_";"_DATE
"RTN","GMRADPT",260,0)
 S GMRAL("R"_INDEX,"SITE")=$G(@NODE@("FACILITY",0))
"RTN","GMRADPT",261,0)
MECH ;CREATE MECHANISM ARRAY
"RTN","GMRADPT",262,0)
 S MECH("A")="ALLERGY;A",MECH("P")="PHARMACOLOGIC;P",MECH("U")="UNKNOWN;U"
"RTN","GMRADPT",263,0)
 Q
"RTN","GMRADSP0")
0^6^B2615214
"RTN","GMRADSP0",1,0)
GMRADSP0 ;HIRMFO/WAA - DISPLAY ALLERGY ;08/01/2013  09:58
"RTN","GMRADSP0",2,0)
 ;;4.0;Adverse Reaction Tracking;**46**;Mar 29, 1996;Build 62
"RTN","GMRADSP0",3,0)
EN1(GMRAL) ; This routine will print all the reaction in the GMRAL array
"RTN","GMRADSP0",4,0)
 ; for the given DFN.
"RTN","GMRADSP0",5,0)
 ;   Input variables:
"RTN","GMRADSP0",6,0)
 ;       GMRAL = An array of all the patient allergies.
"RTN","GMRADSP0",7,0)
 ;
"RTN","GMRADSP0",8,0)
 K ^TMP($J,"GMRALST")
"RTN","GMRADSP0",9,0)
 N GMRATYPE,GMRALN,GMRANAME,GMRAPA
"RTN","GMRADSP0",10,0)
 I $D(XRTL) D T0^%ZOSV ; START RT
"RTN","GMRADSP0",11,0)
 S GMRAOUT=0,GMRAOSOF=1
"RTN","GMRADSP0",12,0)
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV ; STOP RT
"RTN","GMRADSP0",13,0)
 ;sort list builder subroutine
"RTN","GMRADSP0",14,0)
 ;This subroutine builds the a ^TMP array in the following format:
"RTN","GMRADSP0",15,0)
 ;   ^TMP($J,"GMRALST",type,name,ien)=""
"RTN","GMRADSP0",16,0)
 I GMRAL S GMRAPA=0 F  S GMRAPA=$O(GMRAL(GMRAPA)) Q:GMRAPA<1  D
"RTN","GMRADSP0",17,0)
 .S ^TMP($J,"GMRALST",$P(GMRAL(GMRAPA),U,7),$P(GMRAL(GMRAPA),U,2),GMRAPA)=""
"RTN","GMRADSP0",18,0)
 .Q
"RTN","GMRADSP0",19,0)
ALLTYP ;Loop through the list created by the sort subroutine and print.
"RTN","GMRADSP0",20,0)
 D HEAD^GMRADSP8
"RTN","GMRADSP0",21,0)
 S GMRATYPE="" F  S GMRATYPE=$O(^TMP($J,"GMRALST",GMRATYPE)) Q:GMRATYPE=""  D  Q:GMRAOUT
"RTN","GMRADSP0",22,0)
 .S GMRANAME="" F  S GMRANAME=$O(^TMP($J,"GMRALST",GMRATYPE,GMRANAME)) Q:GMRANAME=""  D  Q:GMRAOUT
"RTN","GMRADSP0",23,0)
 .. S GMRAPA=0 F  S GMRAPA=$O(^TMP($J,"GMRALST",GMRATYPE,GMRANAME,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAOUT
"RTN","GMRADSP0",24,0)
 ...N GMALN
"RTN","GMRADSP0",25,0)
 ...D DISBLD^GMRADSP1(GMRAPA,.GMALN)
"RTN","GMRADSP0",26,0)
 ...D DISPLAY^GMRADSP8(.GMALN) Q:GMRAOUT
"RTN","GMRADSP0",27,0)
 ...Q
"RTN","GMRADSP0",28,0)
 ..Q
"RTN","GMRADSP0",29,0)
 .Q
"RTN","GMRADSP0",30,0)
 S:GMRAOUT GMRAOUT=2-GMRAOUT
"RTN","GMRADSP0",31,0)
 Q
"RTN","GMRADSP0",32,0)
EXIT ;Exit
"RTN","GMRADSP0",33,0)
 K ^TMP($J,"GMRALST")
"RTN","GMRADSP0",34,0)
 S:GMRAOUT GMRAOUT=2-GMRAOUT
"RTN","GMRADSP0",35,0)
 Q
"RTN","GMRAHDR")
0^7^B21589009
"RTN","GMRAHDR",1,0)
GMRAHDR ;SLC/DAN - HDR CALLS FOR ART ;01/13/2014  07:54
"RTN","GMRAHDR",2,0)
 ;;4.0;Adverse Reaction Tracking;**18,24,26,42,46**;Mar 29, 1996;Build 62
"RTN","GMRAHDR",3,0)
 ;
"RTN","GMRAHDR",4,0)
 ;The variable GMRADONT can be set before making a call to this
"RTN","GMRAHDR",5,0)
 ;routine if you'd like to be able to change data but not have it
"RTN","GMRAHDR",6,0)
 ;sent to the HDR.  If GMRADONT has a positive value then nothing
"RTN","GMRAHDR",7,0)
 ;will be queued to be sent to the HDR.
"RTN","GMRAHDR",8,0)
 ;A check will also be made for the existence of XDRDVALF to indicate
"RTN","GMRAHDR",9,0)
 ;whether a patient merge is taking place.  If so, then data isn't
"RTN","GMRAHDR",10,0)
 ;sent to the HDR.
"RTN","GMRAHDR",11,0)
 ;
"RTN","GMRAHDR",12,0)
SETADR ;Call here when updating data
"RTN","GMRAHDR",13,0)
 N IEN,OIEN
"RTN","GMRAHDR",14,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send HDR information if variable is set
"RTN","GMRAHDR",15,0)
 S IEN=$S($D(DA)=1:DA,1:DA($O(DA("?"),-1)))
"RTN","GMRAHDR",16,0)
 I +$P($G(^GMR(120.8,IEN,0)),U,12)=0 Q  ;Stop if it isn't signed off yet
"RTN","GMRAHDR",17,0)
 I $$TESTPAT^VADPT($P(^GMR(120.8,IEN,0),U)) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",18,0)
 D TASK("ADR",IEN) ;26 Schedule entry to be sent to HDR
"RTN","GMRAHDR",19,0)
 I $P($G(^GMR(120.8,IEN,0)),U,6)="o" S OIEN=+$O(^GMR(120.85,"C",IEN,0)) I $D(^GMR(120.85,OIEN,0)),'+$G(^GMR(120.8,IEN,"ER")) D TASK("OBS",OIEN) ;If observed reaction, send observed data on sign off
"RTN","GMRAHDR",20,0)
 Q
"RTN","GMRAHDR",21,0)
 ;
"RTN","GMRAHDR",22,0)
KILLADR ;Call here when data is deleted
"RTN","GMRAHDR",23,0)
 N IEN
"RTN","GMRAHDR",24,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data to HDR if variable is set
"RTN","GMRAHDR",25,0)
 S IEN=$S($D(DA)=1:DA,1:DA($O(DA("?"),-1)))
"RTN","GMRAHDR",26,0)
 I $P($G(^GMR(120.8,IEN,0)),U,12)=0 Q  ;Stop if it isn't signed off yet
"RTN","GMRAHDR",27,0)
 I $$TESTPAT^VADPT($P(^GMR(120.8,IEN,0),U)) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",28,0)
 D TASK("ADR",IEN) ;26 Schedule entry to be sent to the HDR
"RTN","GMRAHDR",29,0)
 Q
"RTN","GMRAHDR",30,0)
 ;
"RTN","GMRAHDR",31,0)
SETAA ;Action taken when assessment is changed
"RTN","GMRAHDR",32,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data if variable is set
"RTN","GMRAHDR",33,0)
 I $$TESTPAT^VADPT(DA) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",34,0)
 D TASK("ASMT",DA)
"RTN","GMRAHDR",35,0)
 Q
"RTN","GMRAHDR",36,0)
 ;
"RTN","GMRAHDR",37,0)
KILLAA ;Action taken when value is deleted
"RTN","GMRAHDR",38,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data to HDR if variable is set
"RTN","GMRAHDR",39,0)
 I $$TESTPAT^VADPT(DA) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",40,0)
 D TASK("ASMT",DA)
"RTN","GMRAHDR",41,0)
 Q
"RTN","GMRAHDR",42,0)
 ;
"RTN","GMRAHDR",43,0)
SETOB ;Make call to HDR when observation data is added or edited
"RTN","GMRAHDR",44,0)
 N IEN,AIEN
"RTN","GMRAHDR",45,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data to HDR if variable is set
"RTN","GMRAHDR",46,0)
 S IEN=$S($D(DA)=1:DA,1:DA($O(DA("?"),-1)))
"RTN","GMRAHDR",47,0)
 S AIEN=+$P($G(^GMR(120.85,IEN,0)),U,15) Q:'+AIEN  ;Stop if there's no related reaction
"RTN","GMRAHDR",48,0)
 I $P($G(^GMR(120.8,AIEN,0)),U,12)=0 Q  ;Stop if related reaction not signed off
"RTN","GMRAHDR",49,0)
 I $$TESTPAT^VADPT($P(^GMR(120.8,AIEN,0),U)) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",50,0)
 D TASK("OBS",IEN)
"RTN","GMRAHDR",51,0)
 Q
"RTN","GMRAHDR",52,0)
 ;
"RTN","GMRAHDR",53,0)
KILLOB ;Action upon deletion of observation data
"RTN","GMRAHDR",54,0)
 N IEN,AIEN
"RTN","GMRAHDR",55,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data to HDR if variable is set
"RTN","GMRAHDR",56,0)
 S IEN=$S($D(DA)=1:DA,1:DA($O(DA("?"),-1)))
"RTN","GMRAHDR",57,0)
 S AIEN=+$P($G(^GMR(120.85,IEN,0)),U,15) Q:'AIEN  ;Quit if there's no related reaction
"RTN","GMRAHDR",58,0)
 I +$P($G(^GMR(120.8,AIEN,0)),U,12)=0 Q  ;Quit if related reaction not signed off
"RTN","GMRAHDR",59,0)
 I $$TESTPAT^VADPT($P(^GMR(120.8,AIEN,0),U)) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",60,0)
 D TASK("OBS",IEN)
"RTN","GMRAHDR",61,0)
 Q
"RTN","GMRAHDR",62,0)
 ;
"RTN","GMRAHDR",63,0)
TASK(TYPE,IEN) ;Create task, if needed, and add entry to list of items to be sent to HDR
"RTN","GMRAHDR",64,0)
 N ZTRTN,ZTDESC,ZTDTH,ZTSK,ZTIO
"RTN","GMRAHDR",65,0)
 F  L +^XTMP("GMRAHDR"):1 Q:$T  ;Control global so no new entries are added
"RTN","GMRAHDR",66,0)
 ;Check if task exists, if so and it's older than 10 minutes and it's not scheduled to run, get a new task.  Added w/patch 42
"RTN","GMRAHDR",67,0)
 I $D(^XTMP("GMRAHDR","TASK")) I $$FMDIFF^XLFDT($$NOW^XLFDT,$P(^XTMP("GMRAHDR",0),U,2),2)>600 I '$$TSKOK(+$G(^XTMP("GMRAHDR","TASK"))) K ^XTMP("GMRAHDR","TASK") ;42
"RTN","GMRAHDR",68,0)
 I '$D(^XTMP("GMRAHDR")) S ^XTMP("GMRAHDR",0)=$$FMADD^XLFDT(DT,30)_U_$$NOW^XLFDT_U_"Send allergy data to HDR"
"RTN","GMRAHDR",69,0)
 I '$D(^XTMP("GMRAHDR","TASK")) D
"RTN","GMRAHDR",70,0)
 .S ZTRTN="DQ^GMRAHDR",ZTDESC="Transmit allergy data to HDR",ZTDTH=$$HADD^XLFDT($H,,,2),ZTIO="" D ^%ZTLOAD S ^XTMP("GMRAHDR","TASK")=ZTSK
"RTN","GMRAHDR",71,0)
 S ^XTMP("GMRAHDR",TYPE,IEN)="" ;Store off entry to be sent later
"RTN","GMRAHDR",72,0)
 L -^XTMP("GMRAHDR") ;Release lock
"RTN","GMRAHDR",73,0)
 Q
"RTN","GMRAHDR",74,0)
 ;
"RTN","GMRAHDR",75,0)
DQ ;Send data to HDR
"RTN","GMRAHDR",76,0)
 N GMRAERR,TYPE,IEN,A
"RTN","GMRAHDR",77,0)
 F  L +^XTMP("GMRAHDR"):1 Q:$T  ;Get control of global
"RTN","GMRAHDR",78,0)
 F TYPE="ADR","ASMT","OBS" I $D(^XTMP("GMRAHDR",TYPE)) D
"RTN","GMRAHDR",79,0)
 .S IEN=0 F  S IEN=$O(^XTMP("GMRAHDR",TYPE,IEN)) Q:'+IEN  I $L($T(QUEUE^VDEFQM)) S A=$$QUEUE^VDEFQM("ORU^R01","SUBTYPE="_$S(TYPE="ADR":"ALGY",TYPE="ASMT":"ADAS",1:"ADRA")_"^IEN="_IEN,.GMRAERR)
"RTN","GMRAHDR",80,0)
 K ^XTMP("GMRAHDR")
"RTN","GMRAHDR",81,0)
 L -^XTMP("GMRAHDR")
"RTN","GMRAHDR",82,0)
 Q
"RTN","GMRAHDR",83,0)
 ;
"RTN","GMRAHDR",84,0)
TSKOK(ZTSK) ;Check to see if task is active.  Section added in patch 42
"RTN","GMRAHDR",85,0)
 D ISQED^%ZTLOAD
"RTN","GMRAHDR",86,0)
 Q +ZTSK(0)
"RTN","GMRAHDR",87,0)
HDRDATA() ;RETRIEVE HDR DATA
"RTN","GMRAHDR",88,0)
 ;RETURN: -1 => HDR DOES NOT EXIST OR IS NOT AVAILABLE
"RTN","GMRAHDR",89,0)
 ;        # => NUMBER OF RETRIEVED REACTIONS
"RTN","GMRAHDR",90,0)
 N RETURN
"RTN","GMRAHDR",91,0)
 Q:'$L($T(HAVEHDR^ORRDI1)) -1
"RTN","GMRAHDR",92,0)
 Q:'$$HAVEHDR^ORRDI1 -1
"RTN","GMRAHDR",93,0)
 S RETURN=$$GET^ORRDI1(DFN,"ART")
"RTN","GMRAHDR",94,0)
 Q RETURN
"RTN","GMRAOR")
0^2^B151697530
"RTN","GMRAOR",1,0)
GMRAOR ;HIRMFO/WAA,RM - ORDER CHECK UTILITY ;11/23/2015  07:14
"RTN","GMRAOR",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,13,26,37,41,42,44,46**;Mar 29, 1996;Build 62
"RTN","GMRAOR",3,0)
 Q
"RTN","GMRAOR",4,0)
ORCHK(DFN,TYP,PTR,LOC) ;DETERMINE IF PATIENT HAS ADVERSE REACTION TO AGENT
"RTN","GMRAOR",5,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #2378
"RTN","GMRAOR",6,0)
 ;*BD
"RTN","GMRAOR",7,0)
 N GMRAFLG,GMRACM,DA,GMRAV1,GMRAOTH
"RTN","GMRAOR",8,0)
 S GMRAFLG=0,GMRAV1=1,GMRAOTH=+$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR",9,0)
 I $G(DFN)<1!("^CM^DR^IN^CL^"'[("^"_$G(TYP)_"^"))!($G(TYP)'="CM"&($G(PTR)<1)) S GMRAFLG=""
"RTN","GMRAOR",10,0)
 E  D
"RTN","GMRAOR",11,0)
 .K GMRAING,GMRADRCL,GMRAIEN
"RTN","GMRAOR",12,0)
 .D GETDATA(DFN)
"RTN","GMRAOR",13,0)
 .I TYP="CM" S GMRAFLG=$$RAD(DFN,+$G(LOC))
"RTN","GMRAOR",14,0)
 .I TYP="DR" S GMRAFLG=$$DRUG(DFN,PTR)
"RTN","GMRAOR",15,0)
 .I TYP="IN" S GMRAFLG=$$ING(DFN,PTR)
"RTN","GMRAOR",16,0)
 .I TYP="CL" S GMRAFLG=$$CLASS(DFN,PTR)
"RTN","GMRAOR",17,0)
 K ^TMP("GMRAOC",$J)
"RTN","GMRAOR",18,0)
 Q GMRAFLG
"RTN","GMRAOR",19,0)
 ;*ED
"RTN","GMRAOR",20,0)
 Q $$ORCHK2(DFN,TYP,PTR,LOC)
"RTN","GMRAOR",21,0)
ORCHK2(DFN,TYP,PTR,LOC,RETURN) ;DETERMINE IF PATIENT HAS ADVERSE REACTION TO AGENT
"RTN","GMRAOR",22,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #2378
"RTN","GMRAOR",23,0)
 ;PARAMETERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",24,0)
 ;            TYP => TYPE OF CHECK TO PERFORM
"RTN","GMRAOR",25,0)
 ;                   "CM": CONTRAST MEDIA
"RTN","GMRAOR",26,0)
 ;                   "DR": DRUG
"RTN","GMRAOR",27,0)
 ;                   "IN": DRUG INGREDIENT
"RTN","GMRAOR",28,0)
 ;                   "CL": DRUG CLASS
"RTN","GMRAOR",29,0)
 ;            PTR => AGENT
"RTN","GMRAOR",30,0)
 ;                   TYP="CM", PTR IS IGNORED
"RTN","GMRAOR",31,0)
 ;                   TYP="DR", PTR=PSNDA.PSNVPN.LPTR, WHERE
"RTN","GMRAOR",32,0)
 ;                             PSNDA IS IEN IN VA GENERIC FILE (#50.6),
"RTN","GMRAOR",33,0)
 ;                             PSNVPN IS IEN IN VA PRODUCT FILE (#50.68), AND
"RTN","GMRAOR",34,0)
 ;                             LPTR IS IEN IN DRUG FILE (#50)
"RTN","GMRAOR",35,0)
 ;                   TYP="IN", PTR=IEN IN DRUG INGREDIENTS FILE (#50.416)
"RTN","GMRAOR",36,0)
 ;                   TYP="CL", PTR=IEN IN VA DRUG CLASS FILE (#50.605)
"RTN","GMRAOR",37,0)
 ;            LOC => FOR TYP="CM" ONLY, 1 TO RETURN LOCATION(S) IN SECOND CARET PIECE OF $$ORCHK
"RTN","GMRAOR",38,0)
 ;                   FOR TYP="CM" ONLY, 0 OR UNDEFINED TO NOT RETURN LOCATION(S) IN SECOND CARET PIECE OF $$ORCHK
"RTN","GMRAOR",39,0)
 ;            RETURN => FOR TYP="DR" ONLY, NAME OF ARRAY IN WHICH TO RETURN ORDER CHECK MESSAGES AND REACTION DATA
"RTN","GMRAOR",40,0)
 ;RETURN: -1 => BAD PARAMETERS
"RTN","GMRAOR",41,0)
 ;        EMPTY STRING => NO ASSESSMENT
"RTN","GMRAOR",42,0)
 ;        0 => NO REACTION
"RTN","GMRAOR",43,0)
 ;        1 => FOR TYP="CM", PATIENT HAS REACTION
"RTN","GMRAOR",44,0)
 ;             FOR TYP="IN" AND TYP="CL", PATIENT HAS REACTION; INGREDIENT(S) RETURNED IN GMRAING() AND
"RTN","GMRAOR",45,0)
 ;                                        DRUG CLASS(ES) IN GMRADRCL()
"RTN","GMRAOR",46,0)
 ;             FOR TYP="DR", PATIENT HAS REACTION
"RTN","GMRAOR",47,0)
 I +$G(DFN)<1!("^CM^DR^IN^CL^"'[(U_$G(TYP)_U)) Q -1
"RTN","GMRAOR",48,0)
 I $G(TYP)="DR",PTR'?.N.1".".N.1".".N Q -1
"RTN","GMRAOR",49,0)
 I +$G(PTR)<1,($G(TYP)="IN"!($G(TYP)="CL")) Q -1
"RTN","GMRAOR",50,0)
 I +$G(LOC)>0,($G(TYP)'="CM") Q -1
"RTN","GMRAOR",51,0)
 I $G(TYP)="DR" I $G(RETURN)=""!($G(RETURN)="RETURN") Q -1
"RTN","GMRAOR",52,0)
 K GMRAING,GMRADRCL,GMRAREAC
"RTN","GMRAOR",53,0)
 N GMRAFLG,GMRASESS,IDX,GMRAOTH
"RTN","GMRAOR",54,0)
 S GMRAFLG=0,GMRASESS="",GMRAOTH=+$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR",55,0)
 ;*BD MOVE CODE IN LINETAG TO HERE
"RTN","GMRAOR",56,0)
 D GETDATA(DFN)
"RTN","GMRAOR",57,0)
 ;*ED
"RTN","GMRAOR",58,0)
 S GMRASESS=$$NKA^GMRANKA(DFN)
"RTN","GMRAOR",59,0)
 I +GMRASESS=0,($D(^XTMP("ORRDI","ART",DFN,"ASSESSMENT"))>9) D
"RTN","GMRAOR",60,0)
 .S IDX=0 F  S IDX=$O(^XTMP("ORRDI","ART",DFN,"ASSESSMENT",IDX)) Q:'IDX  D
"RTN","GMRAOR",61,0)
 ..I $P(^XTMP("ORRDI","ART",DFN,"ASSESSMENT",IDX),U,2)="YES" S GMRASESS=1
"RTN","GMRAOR",62,0)
 ..I GMRASESS'=1,($P(^XTMP("ORRDI","ART",DFN,"ASSESSMENT",IDX),U,2)'="YES") S GMRASESS=0
"RTN","GMRAOR",63,0)
 Q:'+GMRASESS GMRASESS
"RTN","GMRAOR",64,0)
 I TYP="CM" S GMRAFLG=$$RAD(DFN,+$G(LOC))
"RTN","GMRAOR",65,0)
 I TYP="DR" S GMRAFLG=$$DRUG(DFN,PTR)
"RTN","GMRAOR",66,0)
 I TYP="IN" S GMRAFLG=$$ING(DFN,PTR)
"RTN","GMRAOR",67,0)
 I TYP="CL" S GMRAFLG=$$CLASS(DFN,PTR)
"RTN","GMRAOR",68,0)
 K ^TMP("GMRAOC",$J)
"RTN","GMRAOR",69,0)
 Q GMRAFLG
"RTN","GMRAOR",70,0)
RAD(DFN,LOC) ;CONTRAST MEDIA CHECK
"RTN","GMRAOR",71,0)
 ;PARAMTERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",72,0)
 ;           LOC => 1 TO RETURN LOCATION(S)
"RTN","GMRAOR",73,0)
 ;                  0 OR UNDEFINED TO NOT RETURN LOCATION(S)
"RTN","GMRAOR",74,0)
 ;RETURN: HAS_REACTION^LOCATION(S), WHERE
"RTN","GMRAOR",75,0)
 ;        HAS_REACTION IS 0 FOR PATIENT DOES NOT HAVE A REACTION
"RTN","GMRAOR",76,0)
 ;        AND 1 IS FOR PATIENT HAS REACTION AND
"RTN","GMRAOR",77,0)
 ;        LOCATION(S) IS A SCREEN-PRINTABLE STRING OF ALL THE LOCATIONS DOCUMENTING
"RTN","GMRAOR",78,0)
 ;        A REACTION
"RTN","GMRAOR",79,0)
 N FLG,DC,DELIMIT,REACT,SITES,SITE,GMRACM,COUNT
"RTN","GMRAOR",80,0)
 ;*BD
"RTN","GMRAOR",81,0)
 N LOCAL,REMOTE
"RTN","GMRAOR",82,0)
 ;*ED
"RTN","GMRAOR",83,0)
 S FLG=0,DC="DX10" F  S DC=$O(^TMP("GMRAOC",$J,"APC",DC)) Q:DC'["DX10"  D
"RTN","GMRAOR",84,0)
 .S FLG=1
"RTN","GMRAOR",85,0)
 .I $G(LOC) D
"RTN","GMRAOR",86,0)
 ..;*BD
"RTN","GMRAOR",87,0)
 ..I $G(GMRAV1) D
"RTN","GMRAOR",88,0)
 ...I $G(^TMP("GMRAOC",$J,"APC",DC))["LOCAL" S LOCAL=1
"RTN","GMRAOR",89,0)
 ...I $G(^TMP("GMRAOC",$J,"APC",DC))["REMOTE" S REMOTE=1
"RTN","GMRAOR",90,0)
 ..I '$G(GMRAV1) D
"RTN","GMRAOR",91,0)
 ...;*ED (C U DOTS)
"RTN","GMRAOR",92,0)
 ...S REACT="" F  S REACT=$O(^TMP("GMRAOC",$J,"APC",DC,REACT)) Q:REACT=""  D
"RTN","GMRAOR",93,0)
 ....Q:$D(SITES(REACT))
"RTN","GMRAOR",94,0)
 ....S SITES=1+$G(SITES),SITES(REACT)=$$GET1^DIQ(4,$P(^TMP("GMRAOC",$J,"APC",DC,REACT),U),.01)
"RTN","GMRAOR",95,0)
 ....S SITES(REACT)=SITES(REACT)_" entered on "_$$FMTE^XLFDT($P(^TMP("GMRAOC",$J,"APC",DC,REACT),U,3))
"RTN","GMRAOR",96,0)
 I $G(LOC) D
"RTN","GMRAOR",97,0)
 .;*BD
"RTN","GMRAOR",98,0)
 .I $G(GMRAV1) D
"RTN","GMRAOR",99,0)
 ..S GMRACM=$S($G(LOCAL)&($G(REMOTE)):"LOCAL AND REMOTE SITE(S)",$G(LOCAL):"LOCAL",$G(REMOTE):"REMOTE SITE(S)",1:"")
"RTN","GMRAOR",100,0)
 .I '$G(GMRAV1) D
"RTN","GMRAOR",101,0)
 ..;*ED (C U DOTS)
"RTN","GMRAOR",102,0)
 ..S DELIMIT=", ",SITE="",COUNT=1
"RTN","GMRAOR",103,0)
 ..F  S SITE=$O(SITES(SITE)) Q:SITE=""  D
"RTN","GMRAOR",104,0)
 ...S:COUNT=SITES DELIMIT=" and "
"RTN","GMRAOR",105,0)
 ...S GMRACM=$S($G(GMRACM)'="":GMRACM_DELIMIT,1:"")_SITES(SITE),COUNT=COUNT+1
"RTN","GMRAOR",106,0)
 Q FLG_$S($G(GMRACM)'="":U_GMRACM,1:"")
"RTN","GMRAOR",107,0)
DRUG(DFN,PTR) ;DRUG CHECK
"RTN","GMRAOR",108,0)
 ;PARAMTERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",109,0)
 ;           PTR => PSNDA.PSNVPN.LPTR, WHERE
"RTN","GMRAOR",110,0)
 ;                  PSNDA IS IEN IN VA GENERIC FILE (#50.6),
"RTN","GMRAOR",111,0)
 ;                  PSNVPN IS IEN IN VA PRODUCT FILE (#50.68), AND
"RTN","GMRAOR",112,0)
 ;                  LPTR IS IEN IN DRUG FILE (#50)
"RTN","GMRAOR",113,0)
 ;RETURN: 1 => REACTION TO DRUG
"RTN","GMRAOR",114,0)
 ;        0 => NO REACTION TO DRUG
"RTN","GMRAOR",115,0)
 N %,FLG,GMRAC,GMRADR,GMRAI,PSNVPN,PSNDA,LPTR,GMRANVPN,GMRANDA,REACT,CLASS,GMRALIST
"RTN","GMRAOR",116,0)
 N TMPFLG,REACS,NODE
"RTN","GMRAOR",117,0)
 S (FLG,TMPFLG)=0,GMRANDA=$P(PTR,"."),GMRANVPN=$P(PTR,".",2),LPTR=$P(PTR,".",3)
"RTN","GMRAOR",118,0)
 I GMRANDA>0,($G(@($$NDFREF_GMRANDA_",0)"))'="") D
"RTN","GMRAOR",119,0)
 .;INGREDIENT
"RTN","GMRAOR",120,0)
 .I $T(DISPDRG^PSNNGR)]"",GMRANVPN]"" D
"RTN","GMRAOR",121,0)
 ..S NODE="PSNDD",PSNDA=GMRANDA,PSNVPN=GMRANVPN
"RTN","GMRAOR",122,0)
 ..K ^TMP(NODE,$J)
"RTN","GMRAOR",123,0)
 ..D DISPDRG^PSNNGR
"RTN","GMRAOR",124,0)
 .I $T(DISPDRG^PSNNGR)=""!(GMRANVPN="") D
"RTN","GMRAOR",125,0)
 ..S NODE="PSN"
"RTN","GMRAOR",126,0)
 ..K ^TMP(NODE,$J)
"RTN","GMRAOR",127,0)
 ..D ^PSNNGR
"RTN","GMRAOR",128,0)
 .S GMRAI=0,%=1 F  S GMRAI=$O(^TMP(NODE,$J,GMRAI)) Q:GMRAI<1  I $D(^TMP("GMRAOC",$J,"API",GMRAI)) D
"RTN","GMRAOR",129,0)
 ..S FLG=1
"RTN","GMRAOR",130,0)
 ..;*BD (C U % VAR)
"RTN","GMRAOR",131,0)
 ..I $G(GMRAV1) S GMRAING(%)=^TMP(NODE,$J,GMRAI)_$$FAC(^TMP("GMRAOC",$J,"API",GMRAI)),%=%+1
"RTN","GMRAOR",132,0)
 ..I '$G(GMRAV1) D
"RTN","GMRAOR",133,0)
 ...;*ED (C U DOTS)
"RTN","GMRAOR",134,0)
 ...S REACT="" F  S REACT=$O(^TMP("GMRAOC",$J,"API",GMRAI,REACT)) Q:REACT=""  D
"RTN","GMRAOR",135,0)
 ....S REACS(REACT)=$G(^TMP("GMRAOC",$J,"API",GMRAI,REACT))
"RTN","GMRAOR",136,0)
 ....I $G(REACS(REACT,"ING"))'[GMRAI S REACS(REACT,"ING")=$S($D(REACS(REACT,"ING")):REACS(REACT,"ING")_"~",1:"")_^TMP(NODE,$J,GMRAI)_U_GMRAI
"RTN","GMRAOR",137,0)
 .K ^TMP(NODE,$J)
"RTN","GMRAOR",138,0)
 .;*BD
"RTN","GMRAOR",139,0)
 .I $G(GMRAV1),FLG Q
"RTN","GMRAOR",140,0)
 .;*ED
"RTN","GMRAOR",141,0)
 .;DRUG CLASS
"RTN","GMRAOR",142,0)
 .I GMRANVPN D  Q
"RTN","GMRAOR",143,0)
 ..S CLASS=$$DCLCODE^PSNAPIS(GMRANDA,GMRANVPN)
"RTN","GMRAOR",144,0)
 ..S TMPFLG=$$PCCHK(CLASS)
"RTN","GMRAOR",145,0)
 ..S:TMPFLG>0 FLG=TMPFLG
"RTN","GMRAOR",146,0)
 .S GMRALIST=$$CLIST^PSNAPIS(GMRANDA,.GMRALIST) Q:'$G(GMRALIST)
"RTN","GMRAOR",147,0)
 .S GMRALIST=0 F  S GMRALIST=$O(GMRALIST(GMRALIST)) Q:'GMRALIST  D
"RTN","GMRAOR",148,0)
 ..S TMPFLG=$$PCCHK($P(GMRALIST(GMRALIST),U,2))
"RTN","GMRAOR",149,0)
 ..S:TMPFLG>0 FLG=TMPFLG
"RTN","GMRAOR",150,0)
 ;*BD
"RTN","GMRAOR",151,0)
 Q:$G(GMRAV1) FLG
"RTN","GMRAOR",152,0)
 ;*ED
"RTN","GMRAOR",153,0)
 I +LPTR>0 D
"RTN","GMRAOR",154,0)
 .;GMR ALLERGY
"RTN","GMRAOR",155,0)
 .N IEN,NAME
"RTN","GMRAOR",156,0)
 .S IEN=0 F  S IEN=$O(^GMR(120.8,"B",DFN,IEN)) Q:'+IEN!(+FLG=3)  D
"RTN","GMRAOR",157,0)
 ..I $P($G(^GMR(120.8,IEN,0)),U,3)=(LPTR_";PSDRUG("),('$P($G(^GMR(120.8,IEN,"ER")),U)) D
"RTN","GMRAOR",158,0)
 ...D DATA^PSS50(LPTR,,,,,"GMRALST")
"RTN","GMRAOR",159,0)
 ...S NAME=$G(^TMP($J,"GMRALST",LPTR,.01))
"RTN","GMRAOR",160,0)
 ...K ^TMP($J,"GMRALST")
"RTN","GMRAOR",161,0)
 ...D ADDLDATA($NA(REACS(IEN)),IEN)
"RTN","GMRAOR",162,0)
 ...S FLG=3
"RTN","GMRAOR",163,0)
 ...I $G(REACS(IEN,"REC"))'[NAME S REACS(IEN,"REC")=$S($D(REACS(IEN,"REC")):"~",1:"")_NAME_U_LPTR
"RTN","GMRAOR",164,0)
 .;DRUG CLASS
"RTN","GMRAOR",165,0)
 .I 'GMRANDA D
"RTN","GMRAOR",166,0)
 ..S TMPFLG=$$PCCHK($$DRP2VACL^GMRAPENC(LPTR))
"RTN","GMRAOR",167,0)
 ..S:TMPFLG>0 FLG=TMPFLG
"RTN","GMRAOR",168,0)
 S:FLG>0 FLG=1
"RTN","GMRAOR",169,0)
 K @RETURN
"RTN","GMRAOR",170,0)
 N STYPE,IPIECE,OPIECE,FIELDS,ITEM,FILE,NODE,FIELD,MSGNUM,RINDEX,SITE,SEV
"RTN","GMRAOR",171,0)
 S STYPE("L")="LOCAL",STYPE("R")="REMOTE"
"RTN","GMRAOR",172,0)
 S FIELDS(1,3)="120.8^4^3",FIELDS(1.1,1)="120.85^.01|14.5+^4",FIELDS(2,1)="120.81^.01*^5"
"RTN","GMRAOR",173,0)
 S FIELDS(2,2)="120.8^^6",FIELDS(2,3)="120.8^^7"
"RTN","GMRAOR",174,0)
 S FIELDS(2,3,"OTRANSFORM")="S Y=$S(Y["";PS(50.605,"":$P($G(^PS(50.605,+Y,0)),U,2),1:$P($G(@(U_$P(Y,"";"",2)_+Y_"",0)"")),U)) S:Y="""" Y=""UNKNOWN"""
"RTN","GMRAOR",175,0)
 S FIELDS(1,4)="120.8^6^8"
"RTN","GMRAOR",176,0)
 I $D(REACS)>9 D
"RTN","GMRAOR",177,0)
 .S REACT="" F  S REACT=$O(REACS(REACT)) Q:REACT=""  D
"RTN","GMRAOR",178,0)
 ..S REACT(1)=$S($P(REACS(REACT),U,7)'="":$P(REACS(REACT),U,7),1:$P(REACS(REACT),U,6))
"RTN","GMRAOR",179,0)
 ..S REACT(2)=$P(REACS(REACT),U,8) S:REACT(2)="" REACT(2)="UNKNOWN"
"RTN","GMRAOR",180,0)
 ..S REACT(3)=$P(REACS(REACT),U,4) S:REACT(3)="" REACT(3)="UNKNOWN"
"RTN","GMRAOR",181,0)
 ..I $D(RINDEX(REACT(1),REACT(2),REACT(3))) S MSGNUM=$O(RINDEX(REACT(1),REACT(2),REACT(3),0))
"RTN","GMRAOR",182,0)
 ..E  S MSGNUM(0)=1+$G(MSGNUM(0)),MSGNUM=MSGNUM(0),RINDEX(REACT(1),REACT(2),REACT(3),MSGNUM)=""
"RTN","GMRAOR",183,0)
 ..S @RETURN@(MSGNUM,REACT)=REACS(REACT),SITE=$P(REACS(REACT),U),@RETURN@(MSGNUM,"MESSAGE",1)=1+$G(@RETURN@(MSGNUM,"MESSAGE",1))
"RTN","GMRAOR",184,0)
 ..F NODE="ING","CLS","REC" I $D(REACS(REACT,NODE)) F ITEM=1:1:$L(REACS(REACT,NODE),"~")  D
"RTN","GMRAOR",185,0)
 ...S $P(@RETURN@(MSGNUM,"MESSAGE","OFFENDERS",NODE),"~",ITEM)=$P($P(REACS(REACT,NODE),"~",ITEM),U)
"RTN","GMRAOR",186,0)
 ...S $P(@RETURN@(MSGNUM,REACT,NODE),"~",ITEM)=$P($P(REACS(REACT,NODE),"~",ITEM),U,2)
"RTN","GMRAOR",187,0)
 ..S @RETURN@(MSGNUM,"MESSAGE",1,SITE)=$$GET1^DIQ(4,$P(REACS(REACT),U)_",",.01)_U_STYPE($P(REACS(REACT),U,2))_U
"RTN","GMRAOR",188,0)
 ..S NODE=0 F  S NODE=$O(FIELDS(NODE)) Q:NODE=""  S OPIECE=0 F  S OPIECE=$O(FIELDS(NODE,OPIECE)) Q:OPIECE=""  D
"RTN","GMRAOR",189,0)
 ...S FILE=$P(FIELDS(NODE,OPIECE),U),FIELD=$P(FIELDS(NODE,OPIECE),U,2),IPIECE=$P(FIELDS(NODE,OPIECE),U,3)
"RTN","GMRAOR",190,0)
 ...I NODE=1 S RETURN=$NA(@RETURN@(MSGNUM,"MESSAGE",NODE,SITE))
"RTN","GMRAOR",191,0)
 ...I $L(NODE,".")=2 S RETURN=$NA(@RETURN@(MSGNUM,"MESSAGE",$P(NODE,"."),SITE,$P(NODE,".",2)))
"RTN","GMRAOR",192,0)
 ...I NODE'=1,NODE'["."  S RETURN=$NA(@RETURN@(MSGNUM,"MESSAGE",NODE))
"RTN","GMRAOR",193,0)
 ...I FIELD>0,FIELD'["*",FIELD'["+" S $P(@RETURN,U,OPIECE)=$$EXTERNAL^DILFD(FILE,FIELD,,$P(REACS(REACT),U,IPIECE))
"RTN","GMRAOR",194,0)
 ...I 'FIELD,'$D(FIELDS(NODE,OPIECE,"OTRANSFORM")) S $P(@RETURN,U,OPIECE)=$P(REACS(REACT),U,IPIECE)
"RTN","GMRAOR",195,0)
 ...I $D(FIELDS(NODE,OPIECE,"OTRANSFORM")) N Y S Y=$P(REACS(REACT),U,IPIECE) X:Y'="" FIELDS(NODE,OPIECE,"OTRANSFORM") S $P(@RETURN,U,OPIECE)=Y
"RTN","GMRAOR",196,0)
 ...I FIELD["*" D
"RTN","GMRAOR",197,0)
 ....N TEXT,DELIMIT,ITEMS,STR,COUNT,NEWIVAL
"RTN","GMRAOR",198,0)
 ....S DELIMIT=", ",COUNT=0,COUNT(1)=1
"RTN","GMRAOR",199,0)
 ....I $P($G(@RETURN),U,OPIECE)'="" F ITEM=1:1:$L($P(@RETURN,U,OPIECE),",")  S STR=$P($P(@RETURN,U,OPIECE),",",ITEM) S:$E(STR,1,5)=" and " STR=$E(STR,6,*) S ITEMS(STR)="",COUNT=1+$G(COUNT)
"RTN","GMRAOR",200,0)
 ....I $P(REACS(REACT),U,IPIECE)'="" F ITEM=1:1:$L($P(REACS(REACT),U,IPIECE),"~")  D
"RTN","GMRAOR",201,0)
 .....S STR=$P($P(REACS(REACT),U,IPIECE),"~",ITEM),$P(NEWIVAL,"~",ITEM)=+STR
"RTN","GMRAOR",202,0)
 .....I STR["-" S STR=$P(STR,"-",2)
"RTN","GMRAOR",203,0)
 .....E  S STR=$$EXTERNAL^DILFD(FILE,+FIELD,,STR)
"RTN","GMRAOR",204,0)
 .....I STR'="",'$D(ITEMS(STR)) S ITEMS(STR)="",COUNT=1+$G(COUNT)
"RTN","GMRAOR",205,0)
 ....S ITEM="" F  S ITEM=$O(ITEMS(ITEM)) Q:ITEM=""  D
"RTN","GMRAOR",206,0)
 .....S:COUNT(1)=COUNT DELIMIT=" and "
"RTN","GMRAOR",207,0)
 .....S TEXT=$S($G(TEXT)'="":TEXT_DELIMIT,1:"")_ITEM,COUNT(1)=1+COUNT(1)
"RTN","GMRAOR",208,0)
 ....S $P(@RETURN,U,OPIECE)=$G(TEXT),RETURN=$P(RETURN,"(")
"RTN","GMRAOR",209,0)
 ....I $G(NEWIVAL)'="",NEWIVAL'=$P(@RETURN@(MSGNUM,REACT),U,IPIECE) S $P(@RETURN@(MSGNUM,REACT),U,IPIECE)=NEWIVAL
"RTN","GMRAOR",210,0)
 ...I FIELD["+" D
"RTN","GMRAOR",211,0)
 ....N FNUM,ITEMS
"RTN","GMRAOR",212,0)
 ....F ITEM=1:1:$L($P(REACS(REACT),U,IPIECE),"~")  N STR F FNUM=1:1:$L(FIELD,"|")  D  S:STR'="" ITEMS(ITEM)=STR
"RTN","GMRAOR",213,0)
 .....S STR=$S($G(STR)'="":STR_U,1:"")_$$EXTERNAL^DILFD(FILE,+$P(FIELD,"|",FNUM),,$P($P($P(REACS(REACT),U,IPIECE),"~",ITEM),"|",FNUM))
"RTN","GMRAOR",214,0)
 ....M:$D(ITEMS)>9 @RETURN=ITEMS
"RTN","GMRAOR",215,0)
 ...S RETURN=$P(RETURN,"(")
"RTN","GMRAOR",216,0)
 .S @RETURN=MSGNUM(0)
"RTN","GMRAOR",217,0)
 Q FLG
"RTN","GMRAOR",218,0)
 ;*BD
"RTN","GMRAOR",219,0)
FAC(NODE) ;
"RTN","GMRAOR",220,0)
 N FAC
"RTN","GMRAOR",221,0)
 S FAC=$S($L(NODE):" ("_NODE_")",1:"")
"RTN","GMRAOR",222,0)
 Q FAC
"RTN","GMRAOR",223,0)
 ;*ED
"RTN","GMRAOR",224,0)
DRCL(CODE) ;POPULATE GMRADRCL()
"RTN","GMRAOR",225,0)
 ;PARAMTER: CODE => FIVE CHARACTER DRUG CLASS CODE TO ADD
"RTN","GMRAOR",226,0)
 ;RETURN: 0 => CODE NOT ADDED TO ARRAY
"RTN","GMRAOR",227,0)
 ;        2 => CODE ADDED TO THE ARRAY OR ALREADY EXISTS IN ARRAY
"RTN","GMRAOR",228,0)
 I '$L(CODE) Q 0
"RTN","GMRAOR",229,0)
 N CLSFN,REACT,RETURN,IEN
"RTN","GMRAOR",230,0)
 I '$D(^TMP("GMRAOC",$J,"APC",CODE)) S RETURN=$S($D(GMRADRCL):2,1:0)
"RTN","GMRAOR",231,0)
 Q:$D(RETURN) RETURN
"RTN","GMRAOR",232,0)
 Q:$D(GMRADRCL(CODE)) 2
"RTN","GMRAOR",233,0)
 Q:CODE="HA000" 0
"RTN","GMRAOR",234,0)
 S CLSFN=$$CODE2CL^GMRAPENC(CODE)
"RTN","GMRAOR",235,0)
 S IEN=$$CODE2CLP^GMRAPENC(CODE)
"RTN","GMRAOR",236,0)
 ;*BD (C U % VAR)
"RTN","GMRAOR",237,0)
 I $G(GMRAV1) D
"RTN","GMRAOR",238,0)
 .N J
"RTN","GMRAOR",239,0)
 .S J=$S('$D(GMRADRCL):1,1:$O(GMRADRCL(999),-1)+1)
"RTN","GMRAOR",240,0)
 .S GMRADRCL(J)=CODE_U_CLSFN_$$FAC(^TMP("GMRAOC",$J,"APC",CODE))
"RTN","GMRAOR",241,0)
 I '$G(GMRAV1) D
"RTN","GMRAOR",242,0)
 .;*ED (C U DOTS)
"RTN","GMRAOR",243,0)
 .S REACT="" F  S REACT=$O(^TMP("GMRAOC",$J,"APC",CODE,REACT)) Q:REACT=""  D
"RTN","GMRAOR",244,0)
 ..S REACS(REACT)=$G(^TMP("GMRAOC",$J,"APC",CODE,REACT))
"RTN","GMRAOR",245,0)
 ..I $G(REACS(REACT,"CLS"))'[CODE S REACS(REACT,"CLS")=$S($D(REACS(REACT,"CLS")):REACS(REACT,"CLS")_"~",1:"")_CODE_" "_CLSFN_U_IEN
"RTN","GMRAOR",246,0)
 Q 2
"RTN","GMRAOR",247,0)
PCCHK(VACLASS) ;PARTIAL DRUG CLASS CHECK
"RTN","GMRAOR",248,0)
 Q:$L($G(VACLASS))<4 0
"RTN","GMRAOR",249,0)
 N CL,I,RETURN
"RTN","GMRAOR",250,0)
 S CL=$S($E(VACLASS,1,4)="CN10":5,1:4),RETURN=0
"RTN","GMRAOR",251,0)
 S I="" F  S I=$O(^TMP("GMRAOC",$J,"APC",I)) Q:'$L(I)  D
"RTN","GMRAOR",252,0)
 .I $E(I,1,CL)=$E(VACLASS,1,CL) S RETURN=$$DRCL(I)
"RTN","GMRAOR",253,0)
 Q RETURN
"RTN","GMRAOR",254,0)
ING(DFN,PTR) ;DRUG INGREDIENT CHECK
"RTN","GMRAOR",255,0)
 ;PARAMTERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",256,0)
 ;           PTR => IEN IN THE DRUG INGREDIENTS FILE (#50.416)
"RTN","GMRAOR",257,0)
 ;RETURN: 0 => NO REACTION
"RTN","GMRAOR",258,0)
 ;        1 => REACTION
"RTN","GMRAOR",259,0)
 N GMRAX,FLG
"RTN","GMRAOR",260,0)
 S FLG=0,GMRAX=0
"RTN","GMRAOR",261,0)
 ;*BD
"RTN","GMRAOR",262,0)
 I $G(GMRAV1) D
"RTN","GMRAOR",263,0)
 .F  S GMRAX=$O(^GMR(120.8,"API",DFN,PTR,GMRAX)) Q:GMRAX<1  S FLG=1,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",264,0)
 I '$G(GMRAV1) D
"RTN","GMRAOR",265,0)
 .;*ED (C U DOTS)
"RTN","GMRAOR",266,0)
 .K ^TMP($J,"GMRALST") D ZERO^PSN50P41(PTR,,,"GMRALST")
"RTN","GMRAOR",267,0)
 .F  S GMRAX=$O(^TMP("GMRAOC",$J,"API",PTR,GMRAX)) Q:GMRAX=""  D
"RTN","GMRAOR",268,0)
 ..S FLG=1,GMRAING(GMRAX)=$G(^TMP($J,"GMRALST",PTR,.01))_"|"_PTR_U_$G(^TMP("GMRAOC",$J,"API",PTR,GMRAX))
"RTN","GMRAOR",269,0)
 .K ^TMP($J,"GMRALST")
"RTN","GMRAOR",270,0)
 Q FLG
"RTN","GMRAOR",271,0)
CLASS(DFN,PTR) ;DRUG CLASS CHECK
"RTN","GMRAOR",272,0)
 ;PARAMTERS: DFN => IEN IN THE PATIENT FILE (#2)
"RTN","GMRAOR",273,0)
 ;           PTR => IEN IN THE VA DRUG CLASS FILE (#50.605)
"RTN","GMRAOR",274,0)
 ;RETURN: 0 => NO REACTION
"RTN","GMRAOR",275,0)
 ;        1 => REACTION
"RTN","GMRAOR",276,0)
 N GMRAC,GMRAX,FLG,CLSFN
"RTN","GMRAOR",277,0)
 S GMRAX=0,FLG=0,GMRAC=$$CLP2CODE^GMRAPENC(PTR),CLSFN=$$CODE2CL^GMRAPENC(GMRAC)
"RTN","GMRAOR",278,0)
 I GMRAC'="" D
"RTN","GMRAOR",279,0)
 .;*BD
"RTN","GMRAOR",280,0)
 .I $G(GMRAV1) D
"RTN","GMRAOR",281,0)
 ..F  S GMRAX=$O(^GMR(120.8,"APC",DFN,GMRAC,GMRAX)) Q:GMRAX<1  S FLG=2,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",282,0)
 .I '$G(GMRAV1) D
"RTN","GMRAOR",283,0)
 ..;*ED (C U DOTS)
"RTN","GMRAOR",284,0)
 ..F  S GMRAX=$O(^TMP("GMRAOC",$J,"APC",GMRAC,GMRAX)) Q:GMRAX=""  D
"RTN","GMRAOR",285,0)
 ...S FLG=2
"RTN","GMRAOR",286,0)
 ...S GMRADRCL(GMRAX)=CLSFN_"|"_PTR_U_$G(^TMP("GMRAOC",$J,"APC",GMRAC,GMRAX))
"RTN","GMRAOR",287,0)
 Q FLG
"RTN","GMRAOR",288,0)
NDFREF() ;VERSION-DEPENDENT GLOBAL LOCATION OF VA GENERIC FILE (#50.6)
"RTN","GMRAOR",289,0)
 ;RETURN: GLOBAL LOCATION OF VA GENERIC FILE (#50.6)
"RTN","GMRAOR",290,0)
 I $$VERSION^XPDUTL("PSN")<4 Q "^PSNDF("
"RTN","GMRAOR",291,0)
 Q "^PSNDF(50.6,"
"RTN","GMRAOR",292,0)
GETDATA(DFN) ;OBTAIN ADVERSE REACTION DATA
"RTN","GMRAOR",293,0)
 ;PARAMTER: DFN => IEN IN THE PATIENT (#2) FILE
"RTN","GMRAOR",294,0)
 K ^TMP("GMRAOC",$J)
"RTN","GMRAOR",295,0)
 D REMOTE^GMRAOR0(DFN),LOCAL(DFN)
"RTN","GMRAOR",296,0)
 Q
"RTN","GMRAOR",297,0)
LOCAL(DFN) ;OBTAIN DATA STORED LOCALLY
"RTN","GMRAOR",298,0)
 ;PARAMTER: DFN => IEN IN THE PATIENT (#2) FILE
"RTN","GMRAOR",299,0)
 N J
"RTN","GMRAOR",300,0)
 S J=0 F  S J=$O(^GMR(120.8,"API",DFN,J)) Q:'+J  D
"RTN","GMRAOR",301,0)
 .D LDATA("API",DFN,J)
"RTN","GMRAOR",302,0)
 S J="" F  S J=$O(^GMR(120.8,"APC",DFN,J)) Q:J=""  D
"RTN","GMRAOR",303,0)
 .D LDATA("APC",DFN,J)
"RTN","GMRAOR",304,0)
 Q
"RTN","GMRAOR",305,0)
LDATA(NODE,DFN,J) ;OBTAIN EACH REACTION'S LOCALLY STORED DATA ELEMENTS
"RTN","GMRAOR",306,0)
 ;PARAMTERS: NODE => CURRENT INDEX IN FILE #120.8
"RTN","GMRAOR",307,0)
 ;                   EITHER "API" OR "APC".
"RTN","GMRAOR",308,0)
 ;           DFN => IEN IN THE PATIENT (#2) FILE
"RTN","GMRAOR",309,0)
 ;           J => CURRENT INGREDIENT OR CLASS
"RTN","GMRAOR",310,0)
 N PAIEN
"RTN","GMRAOR",311,0)
 S PAIEN=0 F  S PAIEN=$O(^GMR(120.8,NODE,DFN,J,PAIEN)) Q:+$G(PAIEN)=0  D
"RTN","GMRAOR",312,0)
 .Q:$P($G(^GMR(120.8,PAIEN,"ER")),U)
"RTN","GMRAOR",313,0)
 .;*BD
"RTN","GMRAOR",314,0)
 .S ^TMP("GMRAOC",$J,NODE,J)=$$SETNODE^GMRAOR1($G(^TMP("GMRAOC",$J,NODE,J)),"LOCAL")
"RTN","GMRAOR",315,0)
 .Q:+$G(GMRAV1)
"RTN","GMRAOR",316,0)
 .;*ED
"RTN","GMRAOR",317,0)
 .D ADDLDATA($NA(^TMP("GMRAOC",$J,NODE,J,PAIEN)),PAIEN)
"RTN","GMRAOR",318,0)
 Q
"RTN","GMRAOR",319,0)
ADDLDATA(GLOBAL,PAIEN) ;OBTAIN LOCALLY STORED DATA ELEMENTS FOR ONE REACTION
"RTN","GMRAOR",320,0)
 ;PARAMETERS: GLOBAL => GLOBAL REFERENCE WHERE TO RETURN THE DATA
"RTN","GMRAOR",321,0)
 ;            PAIEN => IEN IN FILE #120.8
"RTN","GMRAOR",322,0)
 N SITE
"RTN","GMRAOR",323,0)
 S SITE=$$SITE^VASITE(),SITE=$P(SITE,U)_U_"L"_U
"RTN","GMRAOR",324,0)
 S @GLOBAL=SITE_$P(^GMR(120.8,PAIEN,0),U,4)
"RTN","GMRAOR",325,0)
 N REACT,IEN
"RTN","GMRAOR",326,0)
 S REACT=0 F  S REACT=$O(^GMR(120.8,PAIEN,10,REACT)) Q:+$G(REACT)=0  D
"RTN","GMRAOR",327,0)
 .S REACT("VALUE")=$P($G(^GMR(120.8,PAIEN,10,REACT,0)),U)
"RTN","GMRAOR",328,0)
 .I REACT("VALUE")=GMRAOTH D
"RTN","GMRAOR",329,0)
 ..S REACT("VALUE")=REACT("VALUE")_"-"_$P($G(^GMR(120.8,PAIEN,10,REACT,0)),U,2)
"RTN","GMRAOR",330,0)
 ..I $P(REACT("VALUE"),"-",2)="" D
"RTN","GMRAOR",331,0)
 ...I GMRAOTH>0 S $P(REACT("VALUE"),"-",2)=$P($G(^GMRD(120.83,GMRAOTH,0)),U)
"RTN","GMRAOR",332,0)
 ...E  K REACT("VALUE")
"RTN","GMRAOR",333,0)
 .S:$D(REACT("VALUE")) $P(@GLOBAL,U,5)=$S($P($G(@GLOBAL),U,5)'="":$P(@GLOBAL,U,5)_"~",1:"")_REACT("VALUE")
"RTN","GMRAOR",334,0)
 S $P(@GLOBAL,U,6)=$P(^GMR(120.8,PAIEN,0),U,2)
"RTN","GMRAOR",335,0)
 S $P(@GLOBAL,U,7)=$P(^GMR(120.8,PAIEN,0),U,3)
"RTN","GMRAOR",336,0)
 S $P(@GLOBAL,U,8)=$P(^GMR(120.8,PAIEN,0),U,6)
"RTN","GMRAOR",337,0)
 S $P(@GLOBAL,U,9)="V"
"RTN","GMRAOR",338,0)
 Q:$D(^GMR(120.85,"C",PAIEN))<10
"RTN","GMRAOR",339,0)
 S IEN=0 F  S IEN=$O(^GMR(120.85,"C",PAIEN,IEN)) Q:'+IEN  D
"RTN","GMRAOR",340,0)
 .S $P(@GLOBAL,U,4)=$S($P($G(@GLOBAL),U,4)'="":$P(@GLOBAL,U,4)_"~",1:"")_$P($G(^GMR(120.85,IEN,0)),U)_"|"_$P($G(^(0)),U,14)
"RTN","GMRAOR",341,0)
 Q
"RTN","GMRAOR0")
0^8^B35767706
"RTN","GMRAOR0",1,0)
GMRAOR0 ;HIRMFO/WAA,FPT - OERR HL7 UTILITY;10/29/2015  08:25
"RTN","GMRAOR0",2,0)
 ;;4.0;Adverse Reaction Tracking;**4,46**;Mar 29, 1996;Build 62
"RTN","GMRAOR0",3,0)
DUPCHK(DFN,GMRALL) ;CHECK FOR DUPS
"RTN","GMRAOR0",4,0)
 ;Input variable:
"RTN","GMRAOR0",5,0)
 ;         DFN = Patient DFN
"RTN","GMRAOR0",6,0)
 ;      GMRALL = Free text of allergy
"RTN","GMRAOR0",7,0)
 ;
"RTN","GMRAOR0",8,0)
 ;return variable:
"RTN","GMRAOR0",9,0)
 ;     GMRAFLG = (0,1,-1)
"RTN","GMRAOR0",10,0)
 ;               0   Patient has no matching reactions on file
"RTN","GMRAOR0",11,0)
 ;               1   Patient has a matching reaction.
"RTN","GMRAOR0",12,0)
 ;              -1   Patient has a matching reaction but is E/E
"RTN","GMRAOR0",13,0)
 ;
"RTN","GMRAOR0",14,0)
 ;********************************************************************
"RTN","GMRAOR0",15,0)
 N GMRAFLG,GMRAPA
"RTN","GMRAOR0",16,0)
 S GMRAFLG=0,GMRAPA=0
"RTN","GMRAOR0",17,0)
 ;Loop through all the patient's reaction and look for matches
"RTN","GMRAOR0",18,0)
 F  S GMRAPA=$O(^GMR(120.8,"B",DFN,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAFLG=1
"RTN","GMRAOR0",19,0)
 .Q:GMRALL'=$P($G(^GMR(120.8,GMRAPA,0)),U,2)  ;Not a match
"RTN","GMRAOR0",20,0)
 .I +$G(^GMR(120.8,GMRAPA,"ER")) S GMRAFLG=-1 Q  ;E/E
"RTN","GMRAOR0",21,0)
 .S GMRAFLG=1 ;Matching allergy.
"RTN","GMRAOR0",22,0)
 .Q
"RTN","GMRAOR0",23,0)
 Q GMRAFLG
"RTN","GMRAOR0",24,0)
 ;********************************************************************
"RTN","GMRAOR0",25,0)
 ;CONTINUATION FROM GMRAOR
"RTN","GMRAOR0",26,0)
REMOTE(DFN) ;OBTAIN DATA STORED REMOTELY
"RTN","GMRAOR0",27,0)
 ;PARAMTER: DFN => IEN IN THE PATIENT (#2) FILE
"RTN","GMRAOR0",28,0)
 Q:$$HDRDATA^GMRAHDR()<1
"RTN","GMRAOR0",29,0)
 N J
"RTN","GMRAOR0",30,0)
 S J=0 F  S J=$O(^XTMP("ORRDI","ART",DFN,J)) Q:'+J  D
"RTN","GMRAOR0",31,0)
 .N SEVERE,SYMPTOM,AGENT,CLASSES,INGS,DATE,IN,DC,GL,IEN,DD,INDEX,DATA,REACT,IN,OBSHIS
"RTN","GMRAOR0",32,0)
 .N VUID,FILE,GMRARAY,DC,GMRAING,GMRADC,K,INGLST,I,PRIM
"RTN","GMRAOR0",33,0)
 .S GL=$NA(^XTMP("ORRDI","ART",DFN,J)),DATE=""
"RTN","GMRAOR0",34,0)
 .I +$G(@GL@("ORIGINATION DATE/TIME",0))'=0 S DATE=$$HL7TFM^XLFDT(@GL@("ORIGINATION DATE/TIME",0))
"RTN","GMRAOR0",35,0)
 .S DATA=$P($G(@GL@("FACILITY",0)),U)_U_"R"_U_DATE
"RTN","GMRAOR0",36,0)
 .S REACT=$G(@GL@("GMRALLERGY",0))
"RTN","GMRAOR0",37,0)
 .I REACT'="" D
"RTN","GMRAOR0",38,0)
 ..S VUID=$P(REACT,U,1)
"RTN","GMRAOR0",39,0)
 ..S FILE=$P($P(REACT,U,3),"99VA",2)
"RTN","GMRAOR0",40,0)
 ..D GETIREF^XTID(FILE,,VUID,"GMRARAY")
"RTN","GMRAOR0",41,0)
 ..D FILE^DID(FILE,,"GLOBAL NAME","DD")
"RTN","GMRAOR0",42,0)
 ..S IEN=0 F  S IEN=$O(GMRARAY(FILE,.01,IEN)) Q:+$G(IEN)=0  D
"RTN","GMRAOR0",43,0)
 ...S AGENT=+IEN_";"_$P(DD("GLOBAL NAME"),U,2)
"RTN","GMRAOR0",44,0)
 ..K VUID,FILE,GMRARAY,IEN
"RTN","GMRAOR0",45,0)
 .I $D(@GL@("SEVERITY"))>9 D
"RTN","GMRAOR0",46,0)
 ..S SEVERE="|"_$P(@GL@("SEVERITY",0),U)
"RTN","GMRAOR0",47,0)
 .I $D(@GL@("SIGNS/SYMPTOMS"))>9 D
"RTN","GMRAOR0",48,0)
 ..S INDEX=0 F  S INDEX=$O(@GL@("SIGNS/SYMPTOMS",INDEX)) Q:+$G(INDEX)=0  D
"RTN","GMRAOR0",49,0)
 ...I $P($G(@GL@("SIGNS/SYMPTOMS",INDEX)),U,3)="L" D
"RTN","GMRAOR0",50,0)
 ....S SYMPTOM=$S($G(SYMPTOM)'="":SYMPTOM_"~",1:"")_GMRAOTH_"-"_$P($G(@GL@("SIGNS/SYMPTOMS",INDEX)),U,2)
"RTN","GMRAOR0",51,0)
 ...I $P($G(@GL@("SIGNS/SYMPTOMS",INDEX)),U,3)'="L" D
"RTN","GMRAOR0",52,0)
 ....S VUID=$P(@GL@("SIGNS/SYMPTOMS",INDEX),U,1)
"RTN","GMRAOR0",53,0)
 ....S FILE=$P($P(@GL@("SIGNS/SYMPTOMS",INDEX),U,3),"99VA",2)
"RTN","GMRAOR0",54,0)
 ....D GETIREF^XTID(FILE,,VUID,"GMRARAY")
"RTN","GMRAOR0",55,0)
 ....S IEN=0 F  S IEN=$O(GMRARAY(FILE,.01,IEN)) Q:+$G(IEN)=0  S SYMPTOM=$S($G(SYMPTOM)'="":SYMPTOM_"~",1:"")_+IEN
"RTN","GMRAOR0",56,0)
 ....K VUID,FILE,GMRARAY,IEN
"RTN","GMRAOR0",57,0)
 .I $D(@GL@("OBS/HISTORICAL"))>9 D
"RTN","GMRAOR0",58,0)
 ..D GETIREF^XTID(120.8,,$P($G(@GL@("OBS/HISTORICAL",0)),U,1),"GMRARAY")
"RTN","GMRAOR0",59,0)
 ..S OBSHIS=$O(GMRARAY(120.8,6,""))
"RTN","GMRAOR0",60,0)
 ..K GMRARAY
"RTN","GMRAOR0",61,0)
 .S DATA=DATA_U_$G(SEVERE)_U_$G(SYMPTOM)_U_$G(@GL@("REACTANT",0))_U_$G(AGENT)_U_$G(OBSHIS)
"RTN","GMRAOR0",62,0)
 .I $D(^XTMP("ORRDI","ART",DFN,J,"DRUG INGREDIENTS")) D
"RTN","GMRAOR0",63,0)
 ..S IN=0 F  S IN=$O(^XTMP("ORRDI","ART",DFN,J,"DRUG INGREDIENTS",IN)) Q:'+IN  D
"RTN","GMRAOR0",64,0)
 ...S VUID=$P(@GL@("DRUG INGREDIENTS",IN),U),FILE=$P(^(IN),U,3)
"RTN","GMRAOR0",65,0)
 ...S FILE=$P(FILE,"99VA",2)
"RTN","GMRAOR0",66,0)
 ...D GETIREF^XTID(FILE,,VUID,"GMRARAY")
"RTN","GMRAOR0",67,0)
 ...S IEN=0 F  S IEN=$O(GMRARAY(FILE,.01,IEN)) Q:'+IEN  D
"RTN","GMRAOR0",68,0)
 ....;*BD
"RTN","GMRAOR0",69,0)
 ....S ^TMP("GMRAOC",$J,"API",+IEN)=$$SETNODE^GMRAOR1($G(^TMP("GMRAOC",$J,"API",+IEN)),"REMOTE SITE(S)")
"RTN","GMRAOR0",70,0)
 ....;*ED
"RTN","GMRAOR0",71,0)
 ....S:'$D(INGS(+IEN)) INGS(+IEN)=""
"RTN","GMRAOR0",72,0)
 ...K VUID,FILE,GMRARAY,IEN
"RTN","GMRAOR0",73,0)
 .I $D(@GL@("DRUG CLASSES")) D
"RTN","GMRAOR0",74,0)
 ..S DC=0 F  S DC=$O(@GL@("DRUG CLASSES",DC)) Q:'+DC  D
"RTN","GMRAOR0",75,0)
 ...;*BD
"RTN","GMRAOR0",76,0)
 ...N DCLASS
"RTN","GMRAOR0",77,0)
 ...S DCLASS=$P(@GL@("DRUG CLASSES",DC),U,4)
"RTN","GMRAOR0",78,0)
 ...S ^TMP("GMRAOC",$J,"APC",DCLASS)=$$SETNODE^GMRAOR1($G(^TMP("GMRAOC",$J,"APC",DCLASS)),"REMOTE SITE(S)")
"RTN","GMRAOR0",79,0)
 ...;*ED
"RTN","GMRAOR0",80,0)
 ...S VUID=$P(@GL@("DRUG CLASSES",DC),U,1),FILE=$P($P(^(DC),U,3),"99VA",2)
"RTN","GMRAOR0",81,0)
 ...D GETIREF^XTID(FILE,,VUID,"GMRARAY")
"RTN","GMRAOR0",82,0)
 ...S IEN=0 F  S IEN=$O(GMRARAY(FILE,.01,IEN)) Q:'+IEN  D
"RTN","GMRAOR0",83,0)
 ....S:'$D(CLASSES(+IEN)) CLASSES(+IEN)=$P(@GL@("DRUG CLASSES",DC),U,4)
"RTN","GMRAOR0",84,0)
 ...K GMRARAY
"RTN","GMRAOR0",85,0)
 .D FIND(REACT,.GMRAING,.GMRADC) I $D(GMRAING)!($D(GMRADC)) D
"RTN","GMRAOR0",86,0)
 ..S K=0 F  S K=$O(GMRAING(K)) Q:'+K  D
"RTN","GMRAOR0",87,0)
 ...;*BD
"RTN","GMRAOR0",88,0)
 ...S ^TMP("GMRAOC",$J,"API",K)=$$SETNODE^GMRAOR1($G(^TMP("GMRAOC",$J,"API",K)),"REMOTE SITE(S)")
"RTN","GMRAOR0",89,0)
 ...;*ED
"RTN","GMRAOR0",90,0)
 ...S:'$D(INGS(K)) INGS(K)=""
"RTN","GMRAOR0",91,0)
 ..S K="" F  S K=$O(GMRADC(K)) Q:K=""  D
"RTN","GMRAOR0",92,0)
 ...;*BD
"RTN","GMRAOR0",93,0)
 ...S ^TMP("GMRAOC",$J,"APC",GMRADC(K))=$$SETNODE^GMRAOR1($G(^TMP("GMRAOC",$J,"APC",GMRADC(K))),"REMOTE SITE(S)")
"RTN","GMRAOR0",94,0)
 ...;*ED
"RTN","GMRAOR0",95,0)
 ...S:'$D(CLASSES(K)) CLASSES(K)=GMRADC(K)
"RTN","GMRAOR0",96,0)
 .S $P(DATA,U,9)="V"
"RTN","GMRAOR0",97,0)
 .S IN="" F  S IN=$O(INGS(IN)) Q:IN=""  S ^TMP("GMRAOC",$J,"API",IN,"R"_J)=$G(DATA)
"RTN","GMRAOR0",98,0)
 .S DC="" F  S DC=$O(CLASSES(DC)) Q:DC=""  S ^TMP("GMRAOC",$J,"APC",CLASSES(DC),"R"_J)=$G(DATA)
"RTN","GMRAOR0",99,0)
 I $D(^TMP("GMRAOC",$J,"API")) D
"RTN","GMRAOR0",100,0)
 .N I,INGLST
"RTN","GMRAOR0",101,0)
 .S I=0 F  S I=$O(^TMP("GMRAOC",$J,"API",I)) Q:'I  D
"RTN","GMRAOR0",102,0)
 ..N PRIM
"RTN","GMRAOR0",103,0)
 ..S PRIM=$$PRIMARY(I)
"RTN","GMRAOR0",104,0)
 ..I PRIM M INGLST(PRIM)=^TMP("GMRAOC",$J,"API",I) K ^TMP("GMRAOC",$J,"API",I)
"RTN","GMRAOR0",105,0)
 .S I=0 F  S I=$O(INGLST(I)) Q:'I  M ^TMP("GMRAOC",$J,"API",I)=INGLST(I)
"RTN","GMRAOR0",106,0)
 Q
"RTN","GMRAOR0",107,0)
FIND(REACT,ING,DC) ;DETERMINE DRUG INGREDIENTS AND CLASSES FOR REACTANT USING LOCAL DATA
"RTN","GMRAOR0",108,0)
 ;PARAMETERS: REACT => REACTANT TO RETURN DRUG INGREDIENTS AND CLASSES FOR
"RTN","GMRAOR0",109,0)
 ;                     FORMAT: VUID^NAME^FILE, WHERE VUID IS UNIQUE ID FOR REACTANT,
"RTN","GMRAOR0",110,0)
 ;                             NAME IS THE NAME OF THE REACTANT, AND FILE IS THE FILE
"RTN","GMRAOR0",111,0)
 ;                             CONTAINING THE REACTANT, IN THE FORMAT 99VA#
"RTN","GMRAOR0",112,0)
 ;                             EX.: 4637287^EGGS^99VA120.82
"RTN","GMRAOR0",113,0)
 ;            ING => ARRAY REFERENCE TO RETURN DRUG INGREDIENTS IN
"RTN","GMRAOR0",114,0)
 ;            DC => ARRAY REFERENCE TO RETRUN DRUG CLASSES IN
"RTN","GMRAOR0",115,0)
 Q:$G(REACT)=""
"RTN","GMRAOR0",116,0)
 N VUID,FILE,PSNDA,GMRAIEN,LIST,GMRAI,GMRALIST,GMRARAY,J,SUB
"RTN","GMRAOR0",117,0)
 S VUID=$P(REACT,U)
"RTN","GMRAOR0",118,0)
 S FILE=$P(REACT,U,3)
"RTN","GMRAOR0",119,0)
 S FILE=$P(FILE,"99VA",2)
"RTN","GMRAOR0",120,0)
 D GETIREF^XTID(,,VUID,"GMRARAY")
"RTN","GMRAOR0",121,0)
 S FILE="" F  S FILE=$O(GMRARAY(FILE)) Q:FILE=""  D
"RTN","GMRAOR0",122,0)
 .S GMRAIEN=0 F  S GMRAIEN=$O(GMRARAY(FILE,.01,GMRAIEN)) Q:'+GMRAIEN  D
"RTN","GMRAOR0",123,0)
 ..I FILE=50.6 D
"RTN","GMRAOR0",124,0)
 ...K ^TMP("PSN",$J) S PSNDA=+GMRAIEN D ^PSNNGR
"RTN","GMRAOR0",125,0)
 ...S GMRAI=0 F  S GMRAI=$O(^TMP("PSN",$J,GMRAI)) Q:GMRAI<1  S ING(GMRAI)=""
"RTN","GMRAOR0",126,0)
 ...K ^TMP("PSN",$J),GMRARAY
"RTN","GMRAOR0",127,0)
 ...S PSNDA=+GMRAIEN,GMRALIST=$$CLIST^PSNAPIS(PSNDA,.GMRALIST) Q:'$G(GMRALIST)
"RTN","GMRAOR0",128,0)
 ...S GMRALIST=0 F  S GMRALIST=$O(GMRALIST(GMRALIST)) Q:'GMRALIST  S DC(GMRALIST)=$P(GMRALIST(GMRALIST),U,2)
"RTN","GMRAOR0",129,0)
 ..I FILE=120.82 D
"RTN","GMRAOR0",130,0)
 ...S SUB=0 F  S SUB=$O(^GMRD(120.82,+GMRAIEN,"ING",SUB)) Q:'+SUB  S ING(+$P($G(^GMRD(120.82,+GMRAIEN,"ING",SUB,0)),U))=""
"RTN","GMRAOR0",131,0)
 ...S SUB=0 F  S SUB=$O(^GMRD(120.82,+GMRAIEN,"CLASS",SUB)) Q:'+SUB  S DC(+$P($G(^GMRD(120.82,+GMRAIEN,"CLASS",SUB,0)),U))=$P($$CLASS2^PSNAPIS(+$P($G(^GMRD(120.82,+GMRAIEN,"CLASS",SUB,0)),U)),U)
"RTN","GMRAOR0",132,0)
 ..I FILE=50.605 D
"RTN","GMRAOR0",133,0)
 ...S DC(+GMRAIEN)=$P($$CLASS2^PSNAPIS(+GMRAIEN),U)
"RTN","GMRAOR0",134,0)
 ..I FILE=50.416 D
"RTN","GMRAOR0",135,0)
 ...S ING(+GMRAIEN)=""
"RTN","GMRAOR0",136,0)
 Q
"RTN","GMRAOR0",137,0)
PRIMARY(INGIEN) ;DETERMINE IF AN INGREDIENT IS A PRIMARY INGREDIENT
"RTN","GMRAOR0",138,0)
 ;PARAMTER: INGIEN => IEN IN THE DRUG INGREDIENTS FILE (#50.416)
"RTN","GMRAOR0",139,0)
 ;RETURN: 0 => INGIEN IS PRIMARY
"RTN","GMRAOR0",140,0)
 ;        # => IEN IN THE DRUG INGREDIENTS FILE OF INGIEN'S PRIMARY INGREDIENT
"RTN","GMRAOR0",141,0)
 N RETURN
"RTN","GMRAOR0",142,0)
 K ^TMP($J,"GMRALIST")
"RTN","GMRAOR0",143,0)
 D ZERO^PSN50P41(INGIEN,,,"GMRALIST")
"RTN","GMRAOR0",144,0)
 S RETURN=+$G(^TMP($J,"GMRALIST",INGIEN,2))
"RTN","GMRAOR0",145,0)
 K ^TMP($J,"GMRALIST")
"RTN","GMRAOR0",146,0)
 Q RETURN
"RTN","GMRAOR1")
0^4^B6022298
"RTN","GMRAOR1",1,0)
GMRAOR1 ;HIRMFO/RM,WAA - OERR UTILITIES ;05/29/2015  10:12
"RTN","GMRAOR1",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,41,46**;Mar 29, 1996;Build 62
"RTN","GMRAOR1",3,0)
EN1(DFN,ARRAY) ;RETURN CONDENSED LIST OF PATIENT REACTIONS
"RTN","GMRAOR1",4,0)
 ;CONTROLLED BY CONTROLLED SUBSCRIPTION INTEGRATION AGREEMENT #2421
"RTN","GMRAOR1",5,0)
 ;PARAMETERS: DFN => INTERNAL ENTRY NUMBER (IEN) OF THE PATIENT
"RTN","GMRAOR1",6,0)
 ;                   IN THE PATIENT FILE (#2).
"RTN","GMRAOR1",7,0)
 ;            ARRAY => NAME OF THE ARRAY IN WHICH TO RETURN THE
"RTN","GMRAOR1",8,0)
 ;                     REACTIONS. IF NOTHING IS PASSED IN, DATA
"RTN","GMRAOR1",9,0)
 ;                     IS RETURNED IN THE GMRARXN ARRAY.
"RTN","GMRAOR1",10,0)
 ;            GMRA => REACTION SEARCH CRITERIA; REFER TO ^GMRADPT
"RTN","GMRAOR1",11,0)
 ;                    FOR DETAILS
"RTN","GMRAOR1",12,0)
 ;            GMRAIDT => WHEN SET, WILL RETURN THE DATE ENTERED FOR
"RTN","GMRAOR1",13,0)
 ;                       THE SIGN/SYMPTOM IN THE SECOND SEMI-COLON
"RTN","GMRAOR1",14,0)
 ;                       PIECE
"RTN","GMRAOR1",15,0)
 Q:+$G(DFN)'>0
"RTN","GMRAOR1",16,0)
 S ARRAY=$G(ARRAY,"GMRARXN")
"RTN","GMRAOR1",17,0)
 Q:ARRAY="GMRAL"
"RTN","GMRAOR1",18,0)
 N GMRAL
"RTN","GMRAOR1",19,0)
 K @ARRAY
"RTN","GMRAOR1",20,0)
 D EN2^GMRADPT
"RTN","GMRAOR1",21,0)
 I GMRAL D
"RTN","GMRAOR1",22,0)
 .N GMRAIEN,GMRASS
"RTN","GMRAOR1",23,0)
 .S GMRAIEN="" F  S GMRAIEN=$O(GMRAL(GMRAIEN)) Q:GMRAIEN=""  D
"RTN","GMRAOR1",24,0)
 ..N GMRAGMR,GMRAIDX,GMRASEV
"RTN","GMRAOR1",25,0)
 ..S @ARRAY=1+$G(@ARRAY)
"RTN","GMRAOR1",26,0)
 ..I $P(GMRAL(GMRAIEN),U,7)["D" D
"RTN","GMRAOR1",27,0)
 ...S GMRAGMR=$$EXTERNAL^DILFD(120.8,1,,$P(GMRAL(GMRAIEN),U,9))
"RTN","GMRAOR1",28,0)
 ...I $P(GMRAL(GMRAIEN),U,2)'=GMRAGMR,($P(GMRAL(GMRAIEN),U,9)'["50.605") S @ARRAY@(@ARRAY)=GMRAGMR_" ["_$P(GMRAL(GMRAIEN),U,2)_"]"
"RTN","GMRAOR1",29,0)
 ..I $P(GMRAL(GMRAIEN),U,7)'["D"!('$D(@ARRAY@(@ARRAY))) D
"RTN","GMRAOR1",30,0)
 ...S @ARRAY@(@ARRAY)=$P(GMRAL(GMRAIEN),U,2)
"RTN","GMRAOR1",31,0)
 ..S GMRAIDX=0 F  S GMRAIDX=$O(GMRAL(GMRAIEN,"O",GMRAIDX)) Q:'+GMRAIDX  D
"RTN","GMRAOR1",32,0)
 ...I $P($P(GMRAL(GMRAIEN,"O",GMRAIDX),U),";",2)>$G(GMRASEV) S GMRASEV=$P($P(GMRAL(GMRAIEN,"O",GMRAIDX),U),";",2)
"RTN","GMRAOR1",33,0)
 ..I $G(GMRASEV)>0 S GMRASEV=$$EXTERNAL^DILFD(120.85,14.5,,GMRASEV)
"RTN","GMRAOR1",34,0)
 ..S @ARRAY@(@ARRAY)=@ARRAY@(@ARRAY)_U_$G(GMRASEV)_U_GMRAIEN
"RTN","GMRAOR1",35,0)
 ..S GMRASS=0 F  S GMRASS=$O(GMRAL(GMRAIEN,"S",GMRASS)) Q:GMRASS<1  D
"RTN","GMRAOR1",36,0)
 ...S @ARRAY@(@ARRAY,"S",GMRASS)=$P($P(GMRAL(GMRAIEN,"S",GMRASS),U),";")_$S($G(GMRAIDT):";"_$P($P(GMRAL(GMRAIEN,"S",GMRASS),U,2),";",2),1:"")
"RTN","GMRAOR1",37,0)
 S @ARRAY=GMRAL
"RTN","GMRAOR1",38,0)
 Q
"RTN","GMRAOR1",39,0)
 ;*BD
"RTN","GMRAOR1",40,0)
SETNODE(ITEM,DATA) ;
"RTN","GMRAOR1",41,0)
 N VALUE
"RTN","GMRAOR1",42,0)
 S VALUE=""
"RTN","GMRAOR1",43,0)
 I ITEM[DATA S VALUE=ITEM Q VALUE
"RTN","GMRAOR1",44,0)
 I DATA="LOCAL" D  Q VALUE
"RTN","GMRAOR1",45,0)
 .I ITEM="" S VALUE="LOCAL" Q
"RTN","GMRAOR1",46,0)
 .I ITEM["REMOTE SITE(S)" S VALUE="LOCAL AND REMOTE SITE(S)"
"RTN","GMRAOR1",47,0)
 I DATA="REMOTE SITE(S)" D  Q VALUE
"RTN","GMRAOR1",48,0)
 .I ITEM="" S VALUE="REMOTE SITE(S)" Q
"RTN","GMRAOR1",49,0)
 .I ITEM["LOCAL" S VALUE="LOCAL AND REMOTE SITE(S)"
"RTN","GMRAOR1",50,0)
 Q VALUE
"RTN","GMRAOR1",51,0)
 ;*ED
"RTN","GMRAOR2")
0^5^B14577566
"RTN","GMRAOR2",1,0)
GMRAOR2 ;HIRMFO/RM - OERR UTILITIES ;08/09/2013 09:36
"RTN","GMRAOR2",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,41,46**;Mar 29, 1996;Build 62
"RTN","GMRAOR2",3,0)
EN1(IEN,ARRAY) ;RETURNS DATA FOR SPECIFIC ADVERSE REACTION
"RTN","GMRAOR2",4,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #2422
"RTN","GMRAOR2",5,0)
 ;*BD
"RTN","GMRAOR2",6,0)
 N GMRAV1
"RTN","GMRAOR2",7,0)
 S GMRAV1=1
"RTN","GMRAOR2",8,0)
 ;*ED
"RTN","GMRAOR2",9,0)
 D DATA($G(IEN),$G(ARRAY,"GMRACT"))
"RTN","GMRAOR2",10,0)
 Q
"RTN","GMRAOR2",11,0)
EN2(IEN,ARRAY) ;RETURNS DATA FOR SPECIFIC ADVERSE REACTION
"RTN","GMRAOR2",12,0)
 ;CONTROLLED BY SUPPORTED INTEGRATION AGREEMENT #2422
"RTN","GMRAOR2",13,0)
 ;PARAMETERS: IEN => INTERNAL ENTRY NUMBER IN PATIENT ALLERGIES FILE (#120.8)
"RTN","GMRAOR2",14,0)
 ;            ARRAY => NAME OF THE ARRAY IN WHICH TO RETURN THE
"RTN","GMRAOR2",15,0)
 ;                     REACTION DATA. IF NOTHING IS PASSED IN, DATA
"RTN","GMRAOR2",16,0)
 ;                     IS RETURNED IN THE GMRACT ARRAY.
"RTN","GMRAOR2",17,0)
 D DATA($G(IEN),$G(ARRAY,"GMRACT"))
"RTN","GMRAOR2",18,0)
 Q
"RTN","GMRAOR2",19,0)
DATA(IEN,ARRAY) ;ASSEMBLE DATA TO RETURN
"RTN","GMRAOR2",20,0)
 ;PARAMETERS: IEN => IEN IN FILE #120.8
"RTN","GMRAOR2",21,0)
 ;            ARRAY => NAME OF THE ARRAY IN WHICH TO RETURN THE
"RTN","GMRAOR2",22,0)
 ;                     REACTION DATA.
"RTN","GMRAOR2",23,0)
 Q:$G(IEN)=""
"RTN","GMRAOR2",24,0)
 N GMRAPA,GMRAOTH,GMRAI,GMRAGMR,GMRAORIG,GMRAIDX
"RTN","GMRAOR2",25,0)
 K @ARRAY
"RTN","GMRAOR2",26,0)
 S GMRAPA=IEN,GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAOR2",27,0)
 ;*BD
"RTN","GMRAOR2",28,0)
 I $G(GMRAV1) S @ARRAY=$P(GMRAPA(0),U,2)_U
"RTN","GMRAOR2",29,0)
 I '$G(GMRAV1) D
"RTN","GMRAOR2",30,0)
 .;*ED (C U DOTS)
"RTN","GMRAOR2",31,0)
 .I $P(GMRAPA(0),U,20)["D" D
"RTN","GMRAOR2",32,0)
 ..S GMRAGMR=$$EXTERNAL^DILFD(120.8,1,,$P(GMRAPA(0),U,3))
"RTN","GMRAOR2",33,0)
 ..I $P(GMRAPA(0),U,2)'=GMRAGMR S @ARRAY=GMRAGMR_" ["_$P(GMRAPA(0),U,2)_"]"_U
"RTN","GMRAOR2",34,0)
 .I $P(GMRAPA(0),U,20)'["D"!('$D(@ARRAY)) D
"RTN","GMRAOR2",35,0)
 ..S @ARRAY=$P(GMRAPA(0),U,2)_U
"RTN","GMRAOR2",36,0)
 S GMRAORIG=$P(GMRAPA(0),U,5)
"RTN","GMRAOR2",37,0)
 I +GMRAORIG>0 D
"RTN","GMRAOR2",38,0)
 .S @ARRAY=@ARRAY_$$GET1^DIQ(120.8,GMRAPA_",",5)_U_$$GET1^DIQ(200,GMRAORIG_",",8)_U
"RTN","GMRAOR2",39,0)
 I +GMRAORIG=0 D
"RTN","GMRAOR2",40,0)
 .S @ARRAY=@ARRAY_"<None>"_U_U
"RTN","GMRAOR2",41,0)
 S @ARRAY=@ARRAY_$S($P(GMRAPA(0),U,16)=1:"",1:"NOT ")_"VERIFIED"_U
"RTN","GMRAOR2",42,0)
 S @ARRAY=@ARRAY_$S($P(GMRAPA(0),U,6)="o":"OBSERVED",$P(GMRAPA(0),U,6)="h":"HISTORICAL",1:"")_U
"RTN","GMRAOR2",43,0)
 S @ARRAY=@ARRAY_$S($P(GMRAPA(0),U,14)="A":"ALLERGY",$P(GMRAPA(0),U,14)="P":"PHARMACOLOGIC",$P(GMRAPA(0),U,14)="U":"UNKNOWN",1:"")_U
"RTN","GMRAOR2",44,0)
 S @ARRAY=@ARRAY_$$OUTTYPE^GMRAUTL($P(GMRAPA(0),U,20))_U_$S($P(GMRAPA(0),U,16)&('$P(GMRAPA(0),U,18)):"<auto-verified>",1:$$GET1^DIQ(120.8,GMRAPA_",",21))_U_$P(GMRAPA(0),U,17)
"RTN","GMRAOR2",45,0)
 S @ARRAY=@ARRAY_U_$$FMTE^XLFDT($P(GMRAPA(0),U,4))
"RTN","GMRAOR2",46,0)
 ;Comments
"RTN","GMRAOR2",47,0)
 S GMRAI=0 F GMRAIDX=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,26,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",48,0)
 .N GMRACOM
"RTN","GMRAOR2",49,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,26,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",50,0)
 .S @ARRAY@("C",GMRAIDX)=$P(GMRACOM,U)_U_$S($P(GMRACOM,U,3)="V":"VERIFIER",$P(GMRACOM,U,3)="O":"ORIGINATOR",1:"")_U_$$GET1^DIQ(200,$P(GMRACOM,U,2)_",",.01)
"RTN","GMRAOR2",51,0)
 .M @ARRAY@("C",GMRAIDX)=^GMR(120.8,GMRAPA,26,GMRAI,2)
"RTN","GMRAOR2",52,0)
 ;Observer information from file #120.85
"RTN","GMRAOR2",53,0)
 S GMRAI=0 F GMRAIDX=1:1 S GMRAI=$O(^GMR(120.85,"C",GMRAPA,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",54,0)
 .N GMRACOM
"RTN","GMRAOR2",55,0)
 .S GMRACOM=$G(^GMR(120.85,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",56,0)
 .S @ARRAY@("O",GMRAIDX)=$P(GMRACOM,U)_U_$S($P(GMRACOM,U,14)=1:"MILD",$P(GMRACOM,U,14)=2:"MODERATE",$P(GMRACOM,U,14)=3:"SEVERE",1:"")
"RTN","GMRAOR2",57,0)
 ;Signs/Symptoms
"RTN","GMRAOR2",58,0)
 S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR2",59,0)
 S GMRAI=0 F GMRAIDX=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,10,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",60,0)
 .N GMRAZ
"RTN","GMRAOR2",61,0)
 .S GMRAZ=$G(^GMR(120.8,GMRAPA,10,GMRAI,0)) Q:GMRAZ=""
"RTN","GMRAOR2",62,0)
 .S @ARRAY@("S",GMRAIDX)=$S(+GMRAZ'=GMRAOTH:$P($G(^GMRD(120.83,+GMRAZ,0)),U),1:$P(GMRAZ,U,2))_$S($P(GMRAZ,U,4)'="":" ("_$$FMTE^XLFDT($P(GMRAZ,U,4),2)_")",1:"")
"RTN","GMRAOR2",63,0)
 ;VA Drug Classes
"RTN","GMRAOR2",64,0)
 S GMRAI=0 F GMRAIDX=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,3,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",65,0)
 .N GMRACOM
"RTN","GMRAOR2",66,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,3,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",67,0)
 .S @ARRAY@("V",GMRAIDX)=$$CLP2CLDA^GMRAPENC(GMRACOM)
"RTN","GMRAOR2",68,0)
 ;Drug Ingredients
"RTN","GMRAOR2",69,0)
 S GMRAI=0 F GMRAIDX=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,2,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",70,0)
 .N GMRACOM
"RTN","GMRAOR2",71,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,2,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",72,0)
 .S @ARRAY@("I",GMRAIDX)=$$INP2INNA^GMRAPENC(GMRACOM)
"RTN","GMRAOR2",73,0)
 Q
"RTN","GMRAPENC")
0^3^B5910833
"RTN","GMRAPENC",1,0)
GMRAPENC ;SLC/JMH - Pharmacy API calls ;12/06/12  14:55
"RTN","GMRAPENC",2,0)
 ;;4.0;Adverse Reaction Tracking;**41,46**;Mar 29, 1996;Build 62
"RTN","GMRAPENC",3,0)
 ;
"RTN","GMRAPENC",4,0)
 ;$$DRP2CLP^GMRAPENC(50 IEN) => 50.605 IEN
"RTN","GMRAPENC",5,0)
 ;$$CODE2CLP^GMRAPENC(DRUG CLASS CODE) => 50.605 IEN
"RTN","GMRAPENC",6,0)
 ;$$CODE2CL^GMRAPENC(DRUG CLASS CODE) => 50.605 CLASS NAME
"RTN","GMRAPENC",7,0)
 ;$$DRP2VACL^GMRAPENC(50 IEN) => 50.605 CLASS NAME
"RTN","GMRAPENC",8,0)
 ;$$DRP2CODE^GMRAPENC(50 IEN) => 50.605 CLASS CODE
"RTN","GMRAPENC",9,0)
 ;$$CLP2CODE^GMRAPENC(50.605 IEN) => 50.605 CLASS CODE
"RTN","GMRAPENC",10,0)
 ;$$CLP2CLDA^GMRAPENC(50.605 IEN) => 50.605 CLASS CODE ^ 50.605 CLASSIFICATION
"RTN","GMRAPENC",11,0)
 ;$$INP2INNA^GMRAPENC(50.416 IEN) => 50.416 INGREDIENT NAME
"RTN","GMRAPENC",12,0)
 ;
"RTN","GMRAPENC",13,0)
DRP2CLP(GMRAIEN) ;
"RTN","GMRAPENC",14,0)
 ;GMRAIEN = FILE 50 POINTER
"RTN","GMRAPENC",15,0)
 ;RETURN = FILE 50.605 POINTER
"RTN","GMRAPENC",16,0)
 N GMRARET
"RTN","GMRAPENC",17,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",18,0)
 D DATA^PSS50(GMRAIEN,,,,,"GMRADATA")
"RTN","GMRAPENC",19,0)
 S GMRARET=+$G(^TMP($J,"GMRADATA",GMRAIEN,25))
"RTN","GMRAPENC",20,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",21,0)
 Q GMRARET
"RTN","GMRAPENC",22,0)
CODE2CLP(GMRACODE) ;
"RTN","GMRAPENC",23,0)
 ;GMRACODE = DRUG CLASS CODE
"RTN","GMRAPENC",24,0)
 ;RETURN = FILE 50.605 POINTER
"RTN","GMRAPENC",25,0)
 N GMRARET
"RTN","GMRAPENC",26,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",27,0)
 D IEN^PSN50P65(,GMRACODE,"GMRADATA")
"RTN","GMRAPENC",28,0)
 S GMRARET=$O(^TMP($J,"GMRADATA","B",GMRACODE,""))
"RTN","GMRAPENC",29,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",30,0)
 Q GMRARET
"RTN","GMRAPENC",31,0)
CODE2CL(GMRACODE) ;
"RTN","GMRAPENC",32,0)
 ;GMRACODE = DRUG CLASS CODE
"RTN","GMRAPENC",33,0)
 ;RETURN = DRUG CLASS NAME
"RTN","GMRAPENC",34,0)
 N GMRARET
"RTN","GMRAPENC",35,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",36,0)
 D IEN^PSN50P65(,GMRACODE,"GMRADATA")
"RTN","GMRAPENC",37,0)
 S GMRARET=$O(^TMP($J,"GMRADATA","B",GMRACODE,""))
"RTN","GMRAPENC",38,0)
 I GMRARET S GMRARET=$G(^TMP($J,"GMRADATA",GMRARET,1))
"RTN","GMRAPENC",39,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",40,0)
 Q GMRARET
"RTN","GMRAPENC",41,0)
DRP2VACL(GMRAIEN) ;
"RTN","GMRAPENC",42,0)
 ;GMRAIEN = FILE 50 POINTER
"RTN","GMRAPENC",43,0)
 ;RETURN = VA CLASSIFICATION
"RTN","GMRAPENC",44,0)
 N GMRARET
"RTN","GMRAPENC",45,0)
 D DATA^PSS50(GMRAIEN,,,,,"GMRADATA")
"RTN","GMRAPENC",46,0)
 S GMRARET=$G(^TMP($J,"GMRADATA",GMRAIEN,2))
"RTN","GMRAPENC",47,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",48,0)
 Q GMRARET
"RTN","GMRAPENC",49,0)
DRP2CODE(GMRAIEN) ;
"RTN","GMRAPENC",50,0)
 ;GMRAIEN = FILE 50 POINTER
"RTN","GMRAPENC",51,0)
 ;RETURN = DRUG CLASS CODE
"RTN","GMRAPENC",52,0)
 N GMRARET
"RTN","GMRAPENC",53,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",54,0)
 D DATA^PSS50(GMRAIEN,,,,,"GMRADATA")
"RTN","GMRAPENC",55,0)
 S GMRARET=$P($G(^TMP($J,"GMRADATA",GMRAIEN,25)),U,2)
"RTN","GMRAPENC",56,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",57,0)
 Q GMRARET
"RTN","GMRAPENC",58,0)
CLP2CODE(GMRAIEN) ;
"RTN","GMRAPENC",59,0)
 ;GMRAIEN = FILE 50.605 POINTER
"RTN","GMRAPENC",60,0)
 ;RETURN = DRUG CLASS CODE
"RTN","GMRAPENC",61,0)
 N GMRARET
"RTN","GMRAPENC",62,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",63,0)
 D C^PSN50P65(GMRAIEN,,"GMRADATA")
"RTN","GMRAPENC",64,0)
 S GMRARET=$G(^TMP($J,"GMRADATA",GMRAIEN,.01))
"RTN","GMRAPENC",65,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",66,0)
 Q GMRARET
"RTN","GMRAPENC",67,0)
CLP2CLDA(GMRAIEN) ;
"RTN","GMRAPENC",68,0)
 ;GMRAIEN = FILE 50.605 POINTER
"RTN","GMRAPENC",69,0)
 ;RETURN = DRUG CLASS CODE^DRUG CLASS CLASSIFICATION
"RTN","GMRAPENC",70,0)
 N GMRARET
"RTN","GMRAPENC",71,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",72,0)
 D C^PSN50P65(GMRAIEN,,"GMRADATA")
"RTN","GMRAPENC",73,0)
 S GMRARET=$G(^TMP($J,"GMRADATA",GMRAIEN,.01))_U_$G(^TMP($J,"GMRADATA",GMRAIEN,1))
"RTN","GMRAPENC",74,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",75,0)
 Q GMRARET
"RTN","GMRAPENC",76,0)
INP2INNA(GMRAIEN) ;
"RTN","GMRAPENC",77,0)
 ;GMRAIEN = FILE 50.416 POINTER
"RTN","GMRAPENC",78,0)
 ;RETURN = DRUG INGREDIENT NAME
"RTN","GMRAPENC",79,0)
 N GMRARET
"RTN","GMRAPENC",80,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",81,0)
 D ZERO^PSN50P41(GMRAIEN,,,"GMRADATA")
"RTN","GMRAPENC",82,0)
 S GMRARET=$G(^TMP($J,"GMRADATA",GMRAIEN,.01))
"RTN","GMRAPENC",83,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",84,0)
 Q GMRARET
"RTN","GMRAY46")
0^^B247357
"RTN","GMRAY46",1,0)
GMRAY46 ;ISP/RFR - POST INSTALL FOR PATCH 46 ;01/13/2014  09:37
"RTN","GMRAY46",2,0)
 ;;4.0;Adverse Reaction Tracking;**46**;Mar 29, 1996;Build 62
"RTN","GMRAY46",3,0)
 Q
"RTN","GMRAY46",4,0)
POST ;POST INSTALLATION TASKS
"RTN","GMRAY46",5,0)
 ;REMOVE ANY REMAINING ORDER CHECK ^XTMP NODES
"RTN","GMRAY46",6,0)
 I $D(^XTMP("GMRAOC")) D
"RTN","GMRAY46",7,0)
 .D BMES^XPDUTL("Deleting ^XTMP(""GMRAOC"") global node...")
"RTN","GMRAY46",8,0)
 .K ^XTMP("GMRAOC")
"RTN","GMRAY46",9,0)
 .D MES^XPDUTL("DONE")
"RTN","GMRAY46",10,0)
 Q
"VER")
8.0^22.0
**INSTALL NAME**
OR*3.0*269
"BLD",9235,0)
OR*3.0*269^ORDER ENTRY/RESULTS REPORTING^0^3160204^y
"BLD",9235,1,0)
^^6^6^3120914^
"BLD",9235,1,1,0)
CONTAINS ROUTINE UPDATES THAT WILL ENABLE COMPUTERIZED PATIENT RECORD 
"BLD",9235,1,2,0)
SYSTEM (CPRS) VERSION 1.0.29 TO DISPLAY SIGNS/SYMPTOMS WITH MEDICATION 
"BLD",9235,1,3,0)
ORDER CHECK MESSAGES AND WILL ENABLE REMOTE DATA INTEROPERABILITY (RDI) 
"BLD",9235,1,4,0)
TO RETRIEVE SIGN/SYMPTOM, SEVERITY, AND OBSERVED/HISTORICAL DATA FOR AN 
"BLD",9235,1,5,0)
ADVERSE REACTION FROM THE HEALTH DATA REPOSITORY (HDR). REFER TO THE 
"BLD",9235,1,6,0)
PATCH DESCRIPTION FOR INSTALLATION INSTRUCTIONS AND FURTHER INFORMATION.
"BLD",9235,4,0)
^9.64PA^100.05^1
"BLD",9235,4,100.05,0)
100.05
"BLD",9235,4,100.05,222)
y^y^f^^^^n
"BLD",9235,4,"B",100.05,100.05)

"BLD",9235,6)
14^
"BLD",9235,6.3)
85
"BLD",9235,"INI")
PRE^ORY269
"BLD",9235,"INID")
^y^n
"BLD",9235,"INIT")
POST^ORY269
"BLD",9235,"KRN",0)
^9.67PA^779.2^20
"BLD",9235,"KRN",.4,0)
.4
"BLD",9235,"KRN",.401,0)
.401
"BLD",9235,"KRN",.402,0)
.402
"BLD",9235,"KRN",.403,0)
.403
"BLD",9235,"KRN",.5,0)
.5
"BLD",9235,"KRN",.84,0)
.84
"BLD",9235,"KRN",3.6,0)
3.6
"BLD",9235,"KRN",3.8,0)
3.8
"BLD",9235,"KRN",9.2,0)
9.2
"BLD",9235,"KRN",9.8,0)
9.8
"BLD",9235,"KRN",9.8,"NM",0)
^9.68A^20^20
"BLD",9235,"KRN",9.8,"NM",1,0)
ORKCHK5^^0^B87020125
"BLD",9235,"KRN",9.8,"NM",2,0)
ORKCHK6^^0^B28204591
"BLD",9235,"KRN",9.8,"NM",3,0)
OROCAPI1^^0^B59785777
"BLD",9235,"KRN",9.8,"NM",4,0)
ORQQAL^^0^B15654998
"BLD",9235,"KRN",9.8,"NM",5,0)
ORRDI1^^0^B165641370
"BLD",9235,"KRN",9.8,"NM",6,0)
ORCHECK^^0^B120466042
"BLD",9235,"KRN",9.8,"NM",7,0)
ORWDXC^^0^B72504942
"BLD",9235,"KRN",9.8,"NM",8,0)
ORCSAVE^^0^B98204455
"BLD",9235,"KRN",9.8,"NM",9,0)
ORCSAVE2^^0^B85557974
"BLD",9235,"KRN",9.8,"NM",10,0)
ORY26901^^0^B70829648
"BLD",9235,"KRN",9.8,"NM",11,0)
ORY26902^^0^B80510090
"BLD",9235,"KRN",9.8,"NM",12,0)
ORY26903^^0^B60307349
"BLD",9235,"KRN",9.8,"NM",13,0)
ORY26904^^0^B65797598
"BLD",9235,"KRN",9.8,"NM",14,0)
ORY26905^^0^B54406345
"BLD",9235,"KRN",9.8,"NM",15,0)
ORY269ES^^0^B12638325
"BLD",9235,"KRN",9.8,"NM",16,0)
ORY2691^^0^B40554138
"BLD",9235,"KRN",9.8,"NM",17,0)
ORY2692^^0^B26767922
"BLD",9235,"KRN",9.8,"NM",18,0)
ORY2693^^0^B13000330
"BLD",9235,"KRN",9.8,"NM",19,0)
ORY2694^^0^B13530470
"BLD",9235,"KRN",9.8,"NM",20,0)
ORY2690^^0^B15650231
"BLD",9235,"KRN",9.8,"NM","B","ORCHECK",6)

"BLD",9235,"KRN",9.8,"NM","B","ORCSAVE",8)

"BLD",9235,"KRN",9.8,"NM","B","ORCSAVE2",9)

"BLD",9235,"KRN",9.8,"NM","B","ORKCHK5",1)

"BLD",9235,"KRN",9.8,"NM","B","ORKCHK6",2)

"BLD",9235,"KRN",9.8,"NM","B","OROCAPI1",3)

"BLD",9235,"KRN",9.8,"NM","B","ORQQAL",4)

"BLD",9235,"KRN",9.8,"NM","B","ORRDI1",5)

"BLD",9235,"KRN",9.8,"NM","B","ORWDXC",7)

"BLD",9235,"KRN",9.8,"NM","B","ORY2690",20)

"BLD",9235,"KRN",9.8,"NM","B","ORY26901",10)

"BLD",9235,"KRN",9.8,"NM","B","ORY26902",11)

"BLD",9235,"KRN",9.8,"NM","B","ORY26903",12)

"BLD",9235,"KRN",9.8,"NM","B","ORY26904",13)

"BLD",9235,"KRN",9.8,"NM","B","ORY26905",14)

"BLD",9235,"KRN",9.8,"NM","B","ORY2691",16)

"BLD",9235,"KRN",9.8,"NM","B","ORY2692",17)

"BLD",9235,"KRN",9.8,"NM","B","ORY2693",18)

"BLD",9235,"KRN",9.8,"NM","B","ORY2694",19)

"BLD",9235,"KRN",9.8,"NM","B","ORY269ES",15)

"BLD",9235,"KRN",19,0)
19
"BLD",9235,"KRN",19.1,0)
19.1
"BLD",9235,"KRN",101,0)
101
"BLD",9235,"KRN",409.61,0)
409.61
"BLD",9235,"KRN",771,0)
771
"BLD",9235,"KRN",779.2,0)
779.2
"BLD",9235,"KRN",870,0)
870
"BLD",9235,"KRN",8989.51,0)
8989.51
"BLD",9235,"KRN",8989.52,0)
8989.52
"BLD",9235,"KRN",8994,0)
8994
"BLD",9235,"KRN","B",.4,.4)

"BLD",9235,"KRN","B",.401,.401)

"BLD",9235,"KRN","B",.402,.402)

"BLD",9235,"KRN","B",.403,.403)

"BLD",9235,"KRN","B",.5,.5)

"BLD",9235,"KRN","B",.84,.84)

"BLD",9235,"KRN","B",3.6,3.6)

"BLD",9235,"KRN","B",3.8,3.8)

"BLD",9235,"KRN","B",9.2,9.2)

"BLD",9235,"KRN","B",9.8,9.8)

"BLD",9235,"KRN","B",19,19)

"BLD",9235,"KRN","B",19.1,19.1)

"BLD",9235,"KRN","B",101,101)

"BLD",9235,"KRN","B",409.61,409.61)

"BLD",9235,"KRN","B",771,771)

"BLD",9235,"KRN","B",779.2,779.2)

"BLD",9235,"KRN","B",870,870)

"BLD",9235,"KRN","B",8989.51,8989.51)

"BLD",9235,"KRN","B",8989.52,8989.52)

"BLD",9235,"KRN","B",8994,8994)

"BLD",9235,"QDEF")
^^^^^^^^^^YES
"BLD",9235,"QUES",0)
^9.62^^
"BLD",9235,"REQB",0)
^9.611^11^7
"BLD",9235,"REQB",5,0)
OR*3.0*352^2
"BLD",9235,"REQB",6,0)
OR*3.0*306^2
"BLD",9235,"REQB",7,0)
OR*3.0*311^2
"BLD",9235,"REQB",8,0)
OR*3.0*346^2
"BLD",9235,"REQB",9,0)
OR*3.0*286^2
"BLD",9235,"REQB",10,0)
GMRA*4.0*46^2
"BLD",9235,"REQB",11,0)
OR*3.0*395^2
"BLD",9235,"REQB","B","GMRA*4.0*46",10)

"BLD",9235,"REQB","B","OR*3.0*286",9)

"BLD",9235,"REQB","B","OR*3.0*306",6)

"BLD",9235,"REQB","B","OR*3.0*311",7)

"BLD",9235,"REQB","B","OR*3.0*346",8)

"BLD",9235,"REQB","B","OR*3.0*352",5)

"BLD",9235,"REQB","B","OR*3.0*395",11)

"FIA",100.05)
ORDER CHECK INSTANCES
"FIA",100.05,0)
^ORD(100.05,
"FIA",100.05,0,0)
100.05PI
"FIA",100.05,0,1)
y^y^f^^^^n
"FIA",100.05,0,10)

"FIA",100.05,0,11)

"FIA",100.05,0,"RLRO")

"FIA",100.05,0,"VR")
3.0^OR
"FIA",100.05,100.05)
0
"FIA",100.05,100.06)
0
"FIA",100.05,100.07)
0
"FIA",100.05,100.08)
0
"FIA",100.05,100.11)
0
"FIA",100.05,100.113)
0
"FIA",100.05,100.114)
0
"FIA",100.05,100.13)
0
"FIA",100.05,100.14)
0
"FIA",100.05,100.515)
0
"FIA",100.05,100.517)
0
"FIA",100.05,100.5173)
0
"FIA",100.05,100.5174)
0
"FIA",100.05,100.5175)
0
"FIA",100.05,100.57)
0
"FIA",100.05,100.58)
0
"FIA",100.05,100.72)
0
"INI")
PRE^ORY269
"INIT")
POST^ORY269
"IX",100.05,100.05,"C",0)
100.05^C^USED FOR FINDING ORDER CHECKS BASED ON OCCURENCE^R^^R^IR^I^100.05^^^^^LS
"IX",100.05,100.05,"C",.1,0)
^^2^2^3090121^
"IX",100.05,100.05,"C",.1,1,0)
This Index is used to increase the performance of the lookup of order 
"IX",100.05,100.05,"C",.1,2,0)
check instances based on the Occurrence descriptor and the Order number.
"IX",100.05,100.05,"C",1)
S ^ORD(100.05,"C",X(1),$E(X(2),1,30),DA)=""
"IX",100.05,100.05,"C",2)
K ^ORD(100.05,"C",X(1),$E(X(2),1,30),DA)
"IX",100.05,100.05,"C",2.5)
K ^ORD(100.05,"C")
"IX",100.05,100.05,"C",11.1,0)
^.114IA^2^2
"IX",100.05,100.05,"C",11.1,1,0)
1^F^100.05^.01^^1^F
"IX",100.05,100.05,"C",11.1,2,0)
2^F^100.05^2^30^2^F
"IX",100.05,100.05,"D",0)
100.05^D^Used for finding an order check based on its type.^R^^F^IR^I^100.05^^^^^LS
"IX",100.05,100.05,"D",1)
S ^ORD(100.05,"D",X,DA)=""
"IX",100.05,100.05,"D",2)
K ^ORD(100.05,"D",X,DA)
"IX",100.05,100.05,"D",2.5)
K ^ORD(100.05,"D")
"IX",100.05,100.05,"D",11.1,0)
^.114IA^2^1
"IX",100.05,100.05,"D",11.1,2,0)
1^F^100.05^5^^1^F
"MBREQ")
1
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
269^3160204^11931
"PKG",170,22,1,"PAH",1,1,0)
^^6^6^3160204
"PKG",170,22,1,"PAH",1,1,1,0)
CONTAINS ROUTINE UPDATES THAT WILL ENABLE COMPUTERIZED PATIENT RECORD 
"PKG",170,22,1,"PAH",1,1,2,0)
SYSTEM (CPRS) VERSION 1.0.29 TO DISPLAY SIGNS/SYMPTOMS WITH MEDICATION 
"PKG",170,22,1,"PAH",1,1,3,0)
ORDER CHECK MESSAGES AND WILL ENABLE REMOTE DATA INTEROPERABILITY (RDI) 
"PKG",170,22,1,"PAH",1,1,4,0)
TO RETRIEVE SIGN/SYMPTOM, SEVERITY, AND OBSERVED/HISTORICAL DATA FOR AN 
"PKG",170,22,1,"PAH",1,1,5,0)
ADVERSE REACTION FROM THE HEALTH DATA REPOSITORY (HDR). REFER TO THE 
"PKG",170,22,1,"PAH",1,1,6,0)
PATCH DESCRIPTION FOR INSTALLATION INSTRUCTIONS AND FURTHER INFORMATION.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
21
"RTN","ORCHECK")
0^6^B120466042
"RTN","ORCHECK",1,0)
ORCHECK ;SLC/MKB-Order checking calls ;05/14/14  11:46
"RTN","ORCHECK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,70,94,141,215,243,293,280,346,357,352,345,311,269**;Dec 17, 1997;Build 85
"RTN","ORCHECK",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCHECK",4,0)
DISPLAY ; -- DISPLAY event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",5,0)
 ;    Expects ORVP, ORNMSP, ORTAB, [ORWARD]
"RTN","ORCHECK",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",7,0)
 N ORX,ORY,I
"RTN","ORCHECK",8,0)
 I ORNMSP="PS" D  ;reset to PSJ, PSJI, or PSO
"RTN","ORCHECK",9,0)
 . I $G(ORDG) S I=$P($G(^ORD(100.98,+ORDG,0)),U,3),I=$P(I," ") Q:'$L(I)  S ORNMSP="PS"_$S(I="UD":"I",1:I) Q
"RTN","ORCHECK",10,0)
 . I $G(ORXFER) S I=$P($P(^TMP("OR",$J,ORTAB,0),U,3),";",3) S:I="" I=$G(ORWARD) S ORNMSP="PS"_$S(I:"O",1:"I") ;opposite of list
"RTN","ORCHECK",11,0)
 S ORX(1)="|"_ORNMSP,ORX=1
"RTN","ORCHECK",12,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"DISPLAY") Q:'$D(ORY)
"RTN","ORCHECK",13,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  W !,$P(ORY(I),U,4) ; display only
"RTN","ORCHECK",14,0)
 Q
"RTN","ORCHECK",15,0)
 ;
"RTN","ORCHECK",16,0)
SELECT ; -- SELECT event
"RTN","ORCHECK",17,0)
 ;    Expects ORVP, ORDAILOG(PROMPT,ORI), ORNMSP
"RTN","ORCHECK",18,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",19,0)
 N ORX,ORY,OI,ORDODSG
"RTN","ORCHECK",20,0)
 S OI=+$G(ORDIALOG(PROMPT,ORI)),ORDODSG=0
"RTN","ORCHECK",21,0)
 S ORX=1,ORX(1)=OI_"|"_ORNMSP_"|"_$$USID^ORMBLD(OI)
"RTN","ORCHECK",22,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"SELECT",,.ORDODSG),RETURN:$D(ORY)
"RTN","ORCHECK",23,0)
 Q
"RTN","ORCHECK",24,0)
 ;
"RTN","ORCHECK",25,0)
ACCEPT(MODE) ; -- ACCEPT event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",26,0)
 ;    Expects ORVP, ORDIALOG(), ORNMSP
"RTN","ORCHECK",27,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",28,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",29,0)
 N ORX,ORY,ORZ,OI,ORSTRT,ORI,ORIT,ORID,ORSP,ORDODSG
"RTN","ORCHECK",30,0)
 S:'$L($G(MODE)) MODE="ACCEPT"
"RTN","ORCHECK",31,0)
 S OI=$$PTR^ORCD("OR GTX ORDERABLE ITEM"),ORSTRT=$$START,ORX=0,ORDODSG=0
"RTN","ORCHECK",32,0)
 S ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",33,0)
 I $G(ORDG)=+$O(^ORD(100.98,"B","IV RX",0)) S OI=$$PTR^ORCD("OR GTX ADDITIVE"),ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",34,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,MODE,,.ORDODSG),RETURN:$D(ORY),FDBDOWN(0)
"RTN","ORCHECK",35,0)
 Q
"RTN","ORCHECK",36,0)
STUF S ORIT=ORDIALOG(OI,ORI),ORSP=""
"RTN","ORCHECK",37,0)
 S:ORNMSP="LR" ORSP=+$G(ORDIALOG($$PTR^ORCD("OR GTX SPECIMEN"),ORI))
"RTN","ORCHECK",38,0)
 S ORID=$S($E(ORNMSP,1,2)="PS":$$DRUG(ORIT,OI),1:$$USID^ORMBLD(ORIT))
"RTN","ORCHECK",39,0)
 S ORZ=1,ORZ(1)=ORIT_"|"_ORNMSP_"|"_ORID
"RTN","ORCHECK",40,0)
 I MODE'="ALL" D EN^ORKCHK(.ORY,+ORVP,.ORZ,"SELECT",,.ORDODSG),RETURN:$D(ORY)
"RTN","ORCHECK",41,0)
 S ORX=ORX+1,ORX(ORX)=ORZ(1)_"|"_ORSTRT_"||"_ORSP K ORY,ORZ
"RTN","ORCHECK",42,0)
 Q
"RTN","ORCHECK",43,0)
 ;
"RTN","ORCHECK",44,0)
DELAY(MODE) ; -- Delayed ACCEPT event [called from ORMEVNT]
"RTN","ORCHECK",45,0)
 ;    Expects ORVP, ORIFN
"RTN","ORCHECK",46,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",47,0)
 N ORX,ORY,ORCHECK,ORDODSG S:'$L($G(MODE)) MODE="NOTIF"
"RTN","ORCHECK",48,0)
 S ORDODSG=0
"RTN","ORCHECK",49,0)
 D BLD(+ORIFN),EN^ORKCHK(.ORY,+ORVP,.ORX,MODE,,.ORDODSG) Q:'$D(ORY)
"RTN","ORCHECK",50,0)
 D RETURN I MODE="NOTIF" S ORCHECK("OK")="Notification sent to provider" D OC^ORCSAVE2 Q  ; silent
"RTN","ORCHECK",51,0)
 Q
"RTN","ORCHECK",52,0)
 ;
"RTN","ORCHECK",53,0)
BLD(ORDER) ; -- Build new ORX(#) for ORDER
"RTN","ORCHECK",54,0)
 Q:'$G(ORDER)  Q:'$D(^OR(100,ORDER,0))  ;Q:$P($G(^(3)),U,11)  ;edit/renew
"RTN","ORCHECK",55,0)
 N PKG,START,ORI,ITEM,USID,SPEC,ORDG,PTR,INST,ORXSETIV
"RTN","ORCHECK",56,0)
 S ORXSETIV=0
"RTN","ORCHECK",57,0)
 S ORDG=$P(^OR(100,ORDER,0),U,11),PKG=$$GET1^DIQ(9.4,$P(^(0),U,14)_",",1)
"RTN","ORCHECK",58,0)
 I PKG="PS",$G(ORDG) S ORI=$P($G(^ORD(100.98,+ORDG,0)),U,3),ORI=$P(ORI," "),PKG=PKG_$S(ORI="UD":"I",1:ORI)
"RTN","ORCHECK",59,0)
 S START=$$START(ORDER),ORI=0
"RTN","ORCHECK",60,0)
 I PKG="PSJ" D
"RTN","ORCHECK",61,0)
 .N ORITEMS,IDX
"RTN","ORCHECK",62,0)
 .D MAYBEIV^ORWDXR01(.ORITEMS,ORDER)
"RTN","ORCHECK",63,0)
 .Q:$G(ORITEMS)=""
"RTN","ORCHECK",64,0)
 .F IDX=1:1:$L(ORITEMS,U) D
"RTN","ORCHECK",65,0)
 ..S ORX=+$G(ORX)+1,ORX(ORX)=$P(ORITEMS,U,IDX),$P(ORX(ORX),"|",3)=$$DRUG(+ORX(ORX),$P(ORX(ORX),"|",3),ORDER)
"RTN","ORCHECK",66,0)
 ..S $P(ORX(ORX),"|",4)=START
"RTN","ORCHECK",67,0)
 ..S ORXSETIV=1
"RTN","ORCHECK",68,0)
 Q:ORXSETIV
"RTN","ORCHECK",69,0)
 F  S ORI=$O(^OR(100,ORDER,4.5,"ID","ORDERABLE",ORI)) Q:ORI'>0  D
"RTN","ORCHECK",70,0)
 . S INST=$P($G(^OR(100,ORDER,4.5,ORI,0)),U,3),PTR=$P($G(^(0)),U,2),ITEM=+$G(^(1))
"RTN","ORCHECK",71,0)
 . S USID=$S(PKG?1"PS".E:$$DRUG(ITEM,PTR,ORDER),1:$$USID^ORMBLD(ITEM))
"RTN","ORCHECK",72,0)
 . S SPEC=$S(PKG="LR":$$VALUE^ORCSAVE2(ORDER,"SPECIMEN",INST),1:"")
"RTN","ORCHECK",73,0)
 . S ORX=+$G(ORX)+1,ORX(ORX)=ITEM_"|"_PKG_"|"_USID_"|"_START_"|"_ORDER_"|"_SPEC
"RTN","ORCHECK",74,0)
 Q
"RTN","ORCHECK",75,0)
 ;
"RTN","ORCHECK",76,0)
REMDUPS ;
"RTN","ORCHECK",77,0)
 N IFN,CDL,I,J,CDL2
"RTN","ORCHECK",78,0)
 S IFN=0 F  S IFN=$O(ORCHECK(IFN)) Q:'IFN  D
"RTN","ORCHECK",79,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORCHECK",80,0)
 .. S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORCHECK",81,0)
 ... S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORCHECK",82,0)
 .... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORCHECK",83,0)
 ..... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",84,0)
 ..... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORCHECK",85,0)
 ... I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",86,0)
 Q
"RTN","ORCHECK",87,0)
 ;
"RTN","ORCHECK",88,0)
START(DA) ; -- Returns start date/time
"RTN","ORCHECK",89,0)
 N I,X,Y,%DT S Y=""
"RTN","ORCHECK",90,0)
 I $G(DA) S X=$O(^OR(100,DA,4.5,"ID","START",0)),X=$G(^OR(100,DA,4.5,+X,1))
"RTN","ORCHECK",91,0)
 E  D  ; look in ORDIALOG instead
"RTN","ORCHECK",92,0)
 . S I=0 F  S I=$O(ORDIALOG(I)) Q:I'>0  Q:$P(ORDIALOG(I),U,2)="START"
"RTN","ORCHECK",93,0)
 . S X=$S(I:$G(ORDIALOG(I,1)),1:"")
"RTN","ORCHECK",94,0)
 D AM^ORCSAVE2:X="AM",NEXT^ORCSAVE2:X="NEXT"
"RTN","ORCHECK",95,0)
 D ADMIN^ORCSAVE2("NEXT"):X="NEXTA",ADMIN^ORCSAVE2("CLOSEST"):X="CLOSEST"
"RTN","ORCHECK",96,0)
 I $L(X) S %DT="TX" D ^%DT S:Y'>0 Y=""
"RTN","ORCHECK",97,0)
 Q Y
"RTN","ORCHECK",98,0)
 ;
"RTN","ORCHECK",99,0)
DRUG(OI,PTR,IFN) ; -- Returns 6 ^-piece identifier for Dispense Drug
"RTN","ORCHECK",100,0)
 N ORDD,ORNDF,Y
"RTN","ORCHECK",101,0)
 I ORDG=+$O(^ORD(100.98,"B","IV RX",0)) S ORDD=$$IV G D1
"RTN","ORCHECK",102,0)
 I $G(IFN) S ORDD=$O(^OR(100,IFN,4.5,"ID","DRUG",0)),ORDD=+$G(^OR(100,IFN,4.5,+ORDD,1))
"RTN","ORCHECK",103,0)
 E  S ORDD=+$G(ORDIALOG($$PTR^ORCD("OR GTX DISPENSE DRUG"),1))
"RTN","ORCHECK",104,0)
D1 Q:'ORDD "" S ORNDF=$$ENDCM^PSJORUTL(ORDD)
"RTN","ORCHECK",105,0)
 S Y=$P(ORNDF,U,3)_"^^99NDF^"_ORDD_U_$$NAME50^ORPEAPI(ORDD)_"^99PSD"
"RTN","ORCHECK",106,0)
 Q Y
"RTN","ORCHECK",107,0)
 ;
"RTN","ORCHECK",108,0)
IV() ; -- Get Dispense Drug for IV orderable
"RTN","ORCHECK",109,0)
 N PSOI,TYPE,VOL,ORY
"RTN","ORCHECK",110,0)
 S PSOI=+$P($G(^ORD(101.43,+OI,0)),U,2),VOL=""
"RTN","ORCHECK",111,0)
 S TYPE=$S(PTR=$$PTR^ORCD("OR GTX ADDITIVE"):"A",1:"B")
"RTN","ORCHECK",112,0)
 S:TYPE="B" VOL=$S($G(IFN):$$VALUE^ORCSAVE2(IFN,"VOLUME"),1:+$G(ORDIALOG($$PTR^ORCD("OR GTX VOLUME"),1)))
"RTN","ORCHECK",113,0)
 D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORY)
"RTN","ORCHECK",114,0)
 Q +$G(ORY)
"RTN","ORCHECK",115,0)
 ;
"RTN","ORCHECK",116,0)
LIST(IFN) ; -- Displays list of ORCHECK(IFN) checks
"RTN","ORCHECK",117,0)
 N ORI,ORJ,ORZ,ORMAX,ORTX,ON,OFF
"RTN","ORCHECK",118,0)
 S ORZ=0 F  S ORZ=$O(ORCHECK(IFN,ORZ)) Q:ORZ'>0  D
"RTN","ORCHECK",119,0)
 . S:ORZ=1 ON=IOINHI,OFF=IOINORM S:ORZ'=1 (ON,OFF)="" ; use bold if High
"RTN","ORCHECK",120,0)
 . S ORI=0 F  S ORI=$O(ORCHECK(IFN,ORZ,ORI)) Q:ORI'>0  D
"RTN","ORCHECK",121,0)
 . . S X=$P(ORCHECK(IFN,ORZ,ORI),U,3) I $L(X)<75 W !,ON_">>>  "_X_OFF Q
"RTN","ORCHECK",122,0)
 . . S ORMAX=74 K ORTX D TXT^ORCHTAB Q:'$G(ORTX)  ; wrap
"RTN","ORCHECK",123,0)
 . . F ORJ=1:1:ORTX W !,ON_$S(ORJ=1:">>>  ",1:"      ")_ORTX(ORJ)_OFF
"RTN","ORCHECK",124,0)
 W !
"RTN","ORCHECK",125,0)
 Q
"RTN","ORCHECK",126,0)
 ;
"RTN","ORCHECK",127,0)
CANCEL() ; -- Returns 1 or 0: Cancel order(s)?
"RTN","ORCHECK",128,0)
 N X,Y,DIR,NUM
"RTN","ORCHECK",129,0)
 S NUM=+$G(ORCHECK("IFN")),DIR(0)="YA"
"RTN","ORCHECK",130,0)
 S DIR("A")="Do you want to cancel "_$S(NUM>1:"any of the new orders? ",1:"the new order? ")
"RTN","ORCHECK",131,0)
 S DIR("?",1)="Enter YES to cancel "_$S(NUM>1:"an",1:"the")_" order.  If you wish to override these order checks"
"RTN","ORCHECK",132,0)
 S DIR("?",2)="and release "_$S(NUM>1:"these orders",1:"this order")_", enter NO; you will be prompted for a justification",DIR("?")="if there are any highlighted critical order checks."
"RTN","ORCHECK",133,0)
 D ^DIR
"RTN","ORCHECK",134,0)
 Q +Y
"RTN","ORCHECK",135,0)
 ;
"RTN","ORCHECK",136,0)
REASON() ; -- Reason for overriding order checks
"RTN","ORCHECK",137,0)
 ; I '$D(^XUSEC("ORES",DUZ)),'$D(^XUSEC("ORELSE",DUZ)) Q  ??
"RTN","ORCHECK",138,0)
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","ORCHECK",139,0)
 S DIR(0)="FA^2:80^K:X?1."" "" X",DIR("A")="REASON FOR OVERRIDE: "
"RTN","ORCHECK",140,0)
 S DIR("?")="Enter a justification for overriding these order checks, up to 80 characters"
"RTN","ORCHECK",141,0)
 D ^DIR I $D(DTOUT)!$D(DUOUT) S Y="^"
"RTN","ORCHECK",142,0)
 Q Y
"RTN","ORCHECK",143,0)
 ;
"RTN","ORCHECK",144,0)
SESSION ; -- SESSION event [called from ORCSIGN]
"RTN","ORCHECK",145,0)
 ;    Expects ORVP, ORES()
"RTN","ORCHECK",146,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",147,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",148,0)
 N ORX,ORY,ORIFN,I,X,Y,ORGLOB
"RTN","ORCHECK",149,0)
 S ORGLOB=$H
"RTN","ORCHECK",150,0)
 K ^TMP($J,ORGLOB)
"RTN","ORCHECK",151,0)
 S ORIFN=0 F  S ORIFN=$O(ORES(ORIFN)) Q:ORIFN'>0  I +$P(ORIFN,";",2)'>1 D
"RTN","ORCHECK",152,0)
 . I "^14^13^11^10^"'[(U_$P($G(^OR(100,+ORIFN,3)),U,3)_U) Q  ;unreleased
"RTN","ORCHECK",153,0)
 . D BLD(+ORIFN) K ^TMP($J,"OCDATA") Q:'$$OCAPI^ORCHECK(+ORIFN,"OCDATA")
"RTN","ORCHECK",154,0)
 . S ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1
"RTN","ORCHECK",155,0)
 . S I=0 F  S I=$O(^TMP($J,"OCDATA",I)) Q:'I  D
"RTN","ORCHECK",156,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=32,$$ALGASS(+ORIFN)=1 Q
"RTN","ORCHECK",157,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=3 Q
"RTN","ORCHECK",158,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." Q
"RTN","ORCHECK",159,0)
 . . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",160,0)
 . . I $O(^TMP($J,"OCDATA",I,"OC TEXT",1)) D
"RTN","ORCHECK",161,0)
 . . . S ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_"||"_ORGLOB_"&"_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",162,0)
 . . . N ORI S ORI=0 F  S ORI=$O(^TMP($J,"OCDATA",I,"OC TEXT",ORI)) Q:'ORI  S ^TMP($J,"ORK XTRA TXT",ORGLOB,^TMP($J,"OCDATA",I,"OC TEXT",1,0),ORI)=^TMP($J,"OCDATA",I,"OC TEXT",ORI,0)
"RTN","ORCHECK",163,0)
 . . I $D(^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)) D
"RTN","ORCHECK",164,0)
 . . . N ORMONOI S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",""),-1)+1
"RTN","ORCHECK",165,0)
 . . . M ^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)
"RTN","ORCHECK",166,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),17)
"RTN","ORCHECK",167,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")=$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))
"RTN","ORCHECK",168,0)
 . K ^TMP($J,"OCDATA")
"RTN","ORCHECK",169,0)
 I $D(ORX) D EN^ORKCHK(.ORY,+ORVP,.ORX,"SESSION"),RETURN:$D(ORY),FDBDOWN(1),REMDUPS
"RTN","ORCHECK",170,0)
 Q
"RTN","ORCHECK",171,0)
 ;
"RTN","ORCHECK",172,0)
FDBDOWN(ORX) ; -- Checks to see if the FDB was down and if so set appropriate OC
"RTN","ORCHECK",173,0)
 ; expects ORCHECK array of order checks
"RTN","ORCHECK",174,0)
 ; if ORX is 1 then this is getting called from SESSION order checks
"RTN","ORCHECK",175,0)
 Q:'$D(ORCHECK)
"RTN","ORCHECK",176,0)
 ;look for the "not able to be performed" OCs for each type (DSG and ENH), set flag for each to 1 if found and remove them from ORCHECK
"RTN","ORCHECK",177,0)
 N I S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORCHECK",178,0)
 .N ORNEXT,ORDSG,ORENH,ORTHERE
"RTN","ORCHECK",179,0)
 .S ORDSG=0,ORENH=0,ORTHERE=0,ORNEXT=1
"RTN","ORCHECK",180,0)
 .N J S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORCHECK",181,0)
 ..N K S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORCHECK",182,0)
 ...I (K+1)>ORNEXT S ORNEXT=K+1
"RTN","ORCHECK",183,0)
 ...I $G(ORCHECK(I,J,K))[$$DSDWNMSG^ORDSGCHK K ORCHECK(I,J,K) S ORDSG=1
"RTN","ORCHECK",184,0)
 ...I $G(ORCHECK(I,J,K))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." K ORCHECK(I,J,K) S ORENH=1
"RTN","ORCHECK",185,0)
 ...I $G(ORCHECK(I,J,K))["These checks could not be completed for this patient:" S ORTHERE=1
"RTN","ORCHECK",186,0)
 .;if DSG or ENH flag is set then add to ORY
"RTN","ORCHECK",187,0)
 .I ORDSG!(ORENH) D
"RTN","ORCHECK",188,0)
 ..;look to see if message already exists
"RTN","ORCHECK",189,0)
 ..I ORTHERE Q
"RTN","ORCHECK",190,0)
 ..N ORKGLOB S ORKGLOB=$H_","_I
"RTN","ORCHECK",191,0)
 ..N ORMAIN S ORMAIN="These checks could not be completed for this patient:"
"RTN","ORCHECK",192,0)
 ..S ORCHECK(I,2,ORNEXT)="25^2^||"_ORKGLOB_"&"_ORMAIN
"RTN","ORCHECK",193,0)
 ..I $G(ORX) S ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,0)=ORMAIN
"RTN","ORCHECK",194,0)
 ..N ORCNT S ORCNT=1
"RTN","ORCHECK",195,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Drug Interactions"
"RTN","ORCHECK",196,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Duplicate Therapy"
"RTN","ORCHECK",197,0)
 ..I '$G(ORX),ORDSG S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Dosing"
"RTN","ORCHECK",198,0)
 Q
"RTN","ORCHECK",199,0)
 ;
"RTN","ORCHECK",200,0)
RETURN ; -- Return checks in ORCHECK(ORIFN,CDL,#)
"RTN","ORCHECK",201,0)
 N I,IFN,CDL S I=0 F  S I=$O(ORY(I)) Q:I'>0  D
"RTN","ORCHECK",202,0)
 . S IFN=+$P(ORY(I),U) S:'IFN IFN="NEW"
"RTN","ORCHECK",203,0)
 . S CDL=+$P(ORY(I),U,3) S:'CDL CDL=99
"RTN","ORCHECK",204,0)
 . S:'$D(ORCHECK(IFN)) ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1 ; count
"RTN","ORCHECK",205,0)
 . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(IFN,CDL,ORCHECK)=$P(ORY(I),U,2,4)
"RTN","ORCHECK",206,0)
 Q
"RTN","ORCHECK",207,0)
 ;
"RTN","ORCHECK",208,0)
ALGASS(ORIFN) ;see if patient from order has an allergy assessment
"RTN","ORCHECK",209,0)
 N ORDFN S ORDFN=+$P(^OR(100,ORIFN,0),U,2)
"RTN","ORCHECK",210,0)
 K ORARRAY D EN1^GMRAOR1(ORDFN,"ORARRAY")
"RTN","ORCHECK",211,0)
 I ORARRAY'="" Q 1
"RTN","ORCHECK",212,0)
 Q 0
"RTN","ORCHECK",213,0)
OCAPI(IFN,ORPLACE) ;IA #4859
"RTN","ORCHECK",214,0)
 ;LOOK AT ROUTINE OROCAPI1 FOR MORE DETAILED APIS
"RTN","ORCHECK",215,0)
 ;API to get the order checking info for a specific order (IFN)
"RTN","ORCHECK",216,0)
 ;info is stored in ^TMP($J,ORPLACE)
"RTN","ORCHECK",217,0)
 ;               ^TMP($J,ORPLACE,D0,"OC LEVEL")="order check level"
"RTN","ORCHECK",218,0)
 ;                                                 ,"OC NUMBER")="file 100.8 ien"
"RTN","ORCHECK",219,0)
 ;                                                 ,"OC TEXT")="order check text"
"RTN","ORCHECK",220,0)
 ;                                                 ,"OR REASON")="over ride reason text"
"RTN","ORCHECK",221,0)
 ;                                                 ,"OR PROVIDER")="provider DUZ who entered over ride reason"
"RTN","ORCHECK",222,0)
 ;                                                 ,"OR DT")="date/time over ride reason was entered"
"RTN","ORCHECK",223,0)
 ; NOTE on OC LEVEL: 1 is HIGH, 2 is MODERATE, 3 is LOW
"RTN","ORCHECK",224,0)
 N RET,ORN,CNT,I,ORFLAG
"RTN","ORCHECK",225,0)
 S ORN=+IFN,CNT=0,ORFLAG=0
"RTN","ORCHECK",226,0)
 ;if the order is not released then show ACCEPTANCE_CPRS ocs
"RTN","ORCHECK",227,0)
 I "^14^13^11^10^"[(U_$P($G(^OR(100,ORN,3)),U,3)_U) D GETOC5^OROCAPI1(ORN,"ACCEPTANCE_CPRS",.RET) S ORFLAG=1
"RTN","ORCHECK",228,0)
 ;if it has been signed then show SIGNATURE_CPRS ocs
"RTN","ORCHECK",229,0)
 I 'ORFLAG D GETOC5^OROCAPI1(ORN,"SIGNATURE_CPRS",.RET)
"RTN","ORCHECK",230,0)
 I $D(RET) S I=0 F  S I=$O(RET(ORN,"DATA",I)) Q:'I  S CNT=CNT+1 D
"RTN","ORCHECK",231,0)
 .S ^TMP($J,ORPLACE,CNT,"OC NUMBER")=$P($P($G(RET(ORN,"DATA",I,1)),U),";",2)
"RTN","ORCHECK",232,0)
 .S ^TMP($J,ORPLACE,CNT,"OC LEVEL")=$P($G(RET(ORN,"DATA",I,1)),U,2)
"RTN","ORCHECK",233,0)
 .M ^TMP($J,ORPLACE,CNT,"OC TEXT")=RET(ORN,"DATA",I,"OC")
"RTN","ORCHECK",234,0)
 .S ^TMP($J,ORPLACE,CNT,"OR REASON")=$G(RET(ORN,"DATA",I,"OR",1,0))
"RTN","ORCHECK",235,0)
 .S ^TMP($J,ORPLACE,CNT,"OR PROVIDER")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,4),1:"")
"RTN","ORCHECK",236,0)
 .S ^TMP($J,ORPLACE,CNT,"OR DT")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,5),1:"")
"RTN","ORCHECK",237,0)
 .S ^TMP($J,ORPLACE,CNT,"OR STATUS")=$P($G(RET(ORN,"DATA",I,0)),U,2)
"RTN","ORCHECK",238,0)
 .S ^TMP($J,ORPLACE,CNT,"OC INSTANCE")=I
"RTN","ORCHECK",239,0)
 Q CNT
"RTN","ORCHECK",240,0)
 ;
"RTN","ORCHECK",241,0)
ISMONO(ORY) ;returns 1 if there is monograph data for the orderchecks being presented to the user
"RTN","ORCHECK",242,0)
 S ORY=0
"RTN","ORCHECK",243,0)
 Q:'$$PATCH^XPDUTL("OR*3.0*272")
"RTN","ORCHECK",244,0)
 I $D(^TMP($J,"ORMONOGRAPH")) S ORY=1
"RTN","ORCHECK",245,0)
 Q
"RTN","ORCHECK",246,0)
GETMONOL(ORY) ;returns a list of monographs available for the orderchecks being presented to the user
"RTN","ORCHECK",247,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH"))
"RTN","ORCHECK",248,0)
 N I S I=0
"RTN","ORCHECK",249,0)
 F  S I=$O(^TMP($J,"ORMONOGRAPH",I)) Q:'I  D
"RTN","ORCHECK",250,0)
 .S ORY($G(^TMP($J,"ORMONOGRAPH",I,"INT")))=I_U_$G(^TMP($J,"ORMONOGRAPH",I,"INT"))
"RTN","ORCHECK",251,0)
 Q
"RTN","ORCHECK",252,0)
GETMONO(ORY,ORMONO) ;return a monograph
"RTN","ORCHECK",253,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH",ORMONO))
"RTN","ORCHECK",254,0)
 K ^TMP($J,"ORMONORPC")
"RTN","ORCHECK",255,0)
 M ^TMP($J,"ORMONORPC")=^TMP($J,"ORMONOGRAPH",ORMONO,"DATA")
"RTN","ORCHECK",256,0)
 K ^TMP($J,"ORMONORPC",0)
"RTN","ORCHECK",257,0)
 S ORY=$NA(^TMP($J,"ORMONORPC")),@ORY=""
"RTN","ORCHECK",258,0)
 Q
"RTN","ORCHECK",259,0)
DELMONO(ORY) ;delete monograph data
"RTN","ORCHECK",260,0)
 K ^TMP($J,"ORMONOGRAPH"),^TMP($J,"ORMONORPC")
"RTN","ORCHECK",261,0)
 Q
"RTN","ORCHECK",262,0)
GETXTRA(ORY,ORGL,ORRULE) ;get extra text for an order check
"RTN","ORCHECK",263,0)
 ;^TMP($J,"ORK XTRA TXT") stores the text of order checks that are longer than a single line (reminder order checks)
"RTN","ORCHECK",264,0)
 Q:'$D(^TMP($J,"ORK XTRA TXT",ORGL,ORRULE))
"RTN","ORCHECK",265,0)
 M ORY=^TMP($J,"ORK XTRA TXT",ORGL,ORRULE)
"RTN","ORCHECK",266,0)
 Q
"RTN","ORCSAVE")
0^8^B98204455
"RTN","ORCSAVE",1,0)
ORCSAVE ;SLC/MKB/JDL-Save ;05/14/14  11:44
"RTN","ORCSAVE",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,70,73,92,94,116,141,163,187,190,195,243,303,293,280,306,286,269**;Dec 17, 1997;Build 85
"RTN","ORCSAVE",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCSAVE",4,0)
 ;
"RTN","ORCSAVE",5,0)
 ; DBIA 10103   ^XLFDT
"RTN","ORCSAVE",6,0)
 ;
"RTN","ORCSAVE",7,0)
 ;
"RTN","ORCSAVE",8,0)
NEW(ORDIALOG,ORDG,ORPKG,ORCAT,OREVENT,ORDUZ,ORLOG) ; -- New order
"RTN","ORCSAVE",9,0)
 ; Returns ORIFN = [new] order number, if created/saved
"RTN","ORCSAVE",10,0)
 D EN
"RTN","ORCSAVE",11,0)
 Q
"RTN","ORCSAVE",12,0)
 ;
"RTN","ORCSAVE",13,0)
XX ; -- save new/unreleased edited order into Orders file
"RTN","ORCSAVE",14,0)
 ;    Requires: ORDIALOG() = array of dialog values
"RTN","ORCSAVE",15,0)
 ;              ORIFN      = IFN of original order that was edited
"RTN","ORCSAVE",16,0)
 ;
"RTN","ORCSAVE",17,0)
 N OLDIFN S ORIFN=+ORIFN,OLDIFN=0
"RTN","ORCSAVE",18,0)
 I $S($P(^OR(100,ORIFN,3),U,3)=11:0,$P(^(3),U,3)'=10:1,$P(^(8,1,0),U,4)=2:0,1:1) S OLDIFN=ORIFN K ORIFN ; create new order if released or delayed&signed
"RTN","ORCSAVE",19,0)
 D EN Q:'ORIFN  S:'$G(ORDA) ORDA=1
"RTN","ORCSAVE",20,0)
 I $G(OLDIFN) D  ;save links between orders
"RTN","ORCSAVE",21,0)
 . S $P(^OR(100,ORIFN,3),U,5)=OLDIFN,$P(^(3),U,11)=1
"RTN","ORCSAVE",22,0)
 . S $P(^OR(100,OLDIFN,3),U,6)=ORIFN S:$D(^(5)) ^OR(100,ORIFN,5)=^OR(100,OLDIFN,5)
"RTN","ORCSAVE",23,0)
 I $D(^OR(100,+OLDIFN,0)) D
"RTN","ORCSAVE",24,0)
 . Q:'$G(OREVTDF)
"RTN","ORCSAVE",25,0)
 . N OLDEVT,OLDSTS,LSTACT,PATID,NOW,WHEN
"RTN","ORCSAVE",26,0)
 . S (OLDEVT,OLDSTS,LSTACT)=0
"RTN","ORCSAVE",27,0)
 . S NOW=$$NOW^XLFDT
"RTN","ORCSAVE",28,0)
 . S OLDEVT=$P(^OR(100,+OLDIFN,0),U,17),OLDSTS=$P(^OR(100,+OLDIFN,3),U,3)
"RTN","ORCSAVE",29,0)
 . ; Active status = 6 from #100.01
"RTN","ORCSAVE",30,0)
 . I (OLDEVT>0),OLDSTS=6 D
"RTN","ORCSAVE",31,0)
 . . S $P(^OR(100,+ORIFN,0),U,17)=OLDEVT
"RTN","ORCSAVE",32,0)
 . . S $P(^OR(100,+ORIFN,3),U,3)=11
"RTN","ORCSAVE",33,0)
 . . S LSTACT=$P($G(^OR(100,+ORIFN,3)),U,7)
"RTN","ORCSAVE",34,0)
 . . I $D(^OR(100,+ORIFN,8,LSTACT,0)) D
"RTN","ORCSAVE",35,0)
 . . . S $P(^OR(100,+ORIFN,8,LSTACT,0),U,15)=11
"RTN","ORCSAVE",36,0)
 . . . S PATID=$P(^OR(100,+ORIFN,0),U,2)
"RTN","ORCSAVE",37,0)
 . . . S WHEN=$P(^OR(100,+ORIFN,8,LSTACT,0),U)
"RTN","ORCSAVE",38,0)
 . . . S ^OR(100,"AC",PATID,9999999-WHEN,+ORIFN,LSTACT)=""
"RTN","ORCSAVE",39,0)
 Q
"RTN","ORCSAVE",40,0)
 ;
"RTN","ORCSAVE",41,0)
RN ; -- save new/unreleased renewal order into Orders file
"RTN","ORCSAVE",42,0)
 ;    Requires: ORDIALOG() = array of new dialog values
"RTN","ORCSAVE",43,0)
 ;              ORIFN      = IFN of original order that was renewed
"RTN","ORCSAVE",44,0)
 ;
"RTN","ORCSAVE",45,0)
 N OLDIFN S OLDIFN=+ORIFN K ORIFN
"RTN","ORCSAVE",46,0)
 D EN Q:'ORIFN  S:'$G(ORDA) ORDA=1
"RTN","ORCSAVE",47,0)
 S $P(^OR(100,ORIFN,3),U,5)=OLDIFN,$P(^(3),U,11)=2
"RTN","ORCSAVE",48,0)
 S $P(^OR(100,OLDIFN,3),U,6)=ORIFN S:$D(^(5)) ^OR(100,ORIFN,5)=^OR(100,OLDIFN,5)
"RTN","ORCSAVE",49,0)
 Q
"RTN","ORCSAVE",50,0)
 ;
"RTN","ORCSAVE",51,0)
EN ; -- save new/unreleased order in ORDIALOG() into Orders file
"RTN","ORCSAVE",52,0)
 ;    Requires: ORVP, ORNP [and ORL, ORTS, ORAPPT if available]
"RTN","ORCSAVE",53,0)
 ;    If defined: ORCAT,ORPKG,ORDG,ORLOG,ORDUZ,OREVENT,ORDCNTRL,ORSRC
"RTN","ORCSAVE",54,0)
 ;     (else use values from ORDIALOG and current state)
"RTN","ORCSAVE",55,0)
 ;
"RTN","ORCSAVE",56,0)
 N PKG,NOW,NODE,CNT,CDL,I,X,STS,SIGNREQD,LOC,TRSPEC,NATR,CATG,DG,LOG,USR,TYPE,ORK
"RTN","ORCSAVE",57,0)
 Q:'$G(ORVP)  Q:'$G(ORDIALOG)  Q:'$D(^ORD(101.41,+ORDIALOG,0))
"RTN","ORCSAVE",58,0)
 S NOW=$$NOW^XLFDT,SIGNREQD=+$P(^ORD(101.41,+ORDIALOG,0),U,6)
"RTN","ORCSAVE",59,0)
 S CATG=$S($L($G(ORCAT)):ORCAT,1:$S($$INPT^ORCD:"I",1:"O"))
"RTN","ORCSAVE",60,0)
 S PKG=$S($G(ORPKG):ORPKG,1:$P(^ORD(101.41,+ORDIALOG,0),U,7))
"RTN","ORCSAVE",61,0)
 S LOG=$S($G(ORLOG):ORLOG,1:+$E(NOW,1,12)),USR=$S($G(ORDUZ):ORDUZ,1:DUZ)
"RTN","ORCSAVE",62,0)
 I $G(ORIFN),$D(^OR(100,ORIFN,0)) S STS=$P(^(3),U,3) G EN2 ; unrel order
"RTN","ORCSAVE",63,0)
 S DG=$S($G(ORDG):+ORDG,1:$P(^ORD(101.41,+ORDIALOG,0),U,5))
"RTN","ORCSAVE",64,0)
 I $G(OREVENT),"^PSO^RA^"'["^"_$$GET1^DIQ(9.4,+PKG_",",1)_"^",'$G(DGPMT) S LOC="",TRSPEC="" ; p286 added radiology package
"RTN","ORCSAVE",65,0)
 E  S LOC=$G(ORL),TRSPEC=$G(ORTS)
"RTN","ORCSAVE",66,0)
 S TYPE=$S("^B^C^X^P^0^"[(U_$G(ORSRC)_U):ORSRC,$G(ORDCNTRL)="SN":"P",1:0)
"RTN","ORCSAVE",67,0)
 ;S LOG=$S($G(ORLOG):ORLOG,1:+$E(NOW,1,12)),USR=$S($G(ORDUZ):ORDUZ,1:DUZ) moved up before EN2 call
"RTN","ORCSAVE",68,0)
 S NATR=+$O(^ORD(100.02,"C","E",0)) ;assume Elec Entered until changed
"RTN","ORCSAVE",69,0)
 S STS=$S($G(OREVENT):10,1:11),ORIFN=$$NEXTIFN Q:'ORIFN
"RTN","ORCSAVE",70,0)
EN1 S ^OR(100,ORIFN,0)=ORIFN_U_ORVP_U_U_$G(ORNP)_U_+ORDIALOG_";ORD(101.41,^"_USR_U_LOG_U_U_U_LOC_U_DG_U_CATG_U_TRSPEC_U_PKG_U_U_SIGNREQD_U_$G(OREVENT)_U_$G(ORAPPT)
"RTN","ORCSAVE",71,0)
 S ^OR(100,ORIFN,3)=LOG_"^90^"_STS_U_$S($G(ORIT):ORIT_";ORD(101.41,",1:"")_U_$G(ORDIALOG("PREV"))_"^^1^^^^"_TYPE
"RTN","ORCSAVE",72,0)
 S ^OR(100,ORIFN,8,0)="^100.008DA^1^1",^OR(100,ORIFN,8,1,0)=LOG_"^NW^"_$G(ORNP)_U_$S(SIGNREQD:2,1:3)_"^^^^^^^^"_NATR_U_USR_"^1^"_STS,^OR(100,ORIFN,8,"C","NW",1)=""
"RTN","ORCSAVE",73,0)
 S ^OR(100,"AF",LOG,ORIFN,1)=""
"RTN","ORCSAVE",74,0)
 S ^OR(100,"ACT",ORVP,9999999-LOG,+DG,ORIFN,1)=""
"RTN","ORCSAVE",75,0)
 S:STS'=10 ^OR(100,"AC",ORVP,9999999-LOG,ORIFN,1)=""
"RTN","ORCSAVE",76,0)
 S:SIGNREQD ^OR(100,"AS",ORVP,9999999-LOG,ORIFN,1)=""
"RTN","ORCSAVE",77,0)
 S:$G(OREVENT) ^OR(100,"AEVNT",ORVP,OREVENT,ORIFN)=""
"RTN","ORCSAVE",78,0)
 ;check if OR GTX STUDY REASON is in ORDIALOG and strip out control characters
"RTN","ORCSAVE",79,0)
 N ORRFSID
"RTN","ORCSAVE",80,0)
 S ORRFSID=$O(^ORD(101.41,"B","OR GTX STUDY REASON",""))
"RTN","ORCSAVE",81,0)
 I ORRFSID,$D(ORDIALOG(ORRFSID,1)) D
"RTN","ORCSAVE",82,0)
 .N X,I
"RTN","ORCSAVE",83,0)
 .S X=ORDIALOG(ORRFSID,1)
"RTN","ORCSAVE",84,0)
 .F I=1:1:31 S X=$TR(X,$C(I))
"RTN","ORCSAVE",85,0)
 .S ORDIALOG(ORRFSID,1)=X
"RTN","ORCSAVE",86,0)
EN2 S ORIFN=+ORIFN D RESPONSE ; save responses
"RTN","ORCSAVE",87,0)
 I $P(^OR(100,ORIFN,0),"^",5) D  ;Copy orders PKI fix
"RTN","ORCSAVE",88,0)
 . N OI,ORPKIU
"RTN","ORCSAVE",89,0)
 . S OI=+$O(^OR(100,ORIFN,4.5,"ID","ORDERABLE",0)),OI=+$G(^OR(100,ORIFN,4.5,OI,1)) Q:'OI
"RTN","ORCSAVE",90,0)
 . I PKG'=$O(^DIC(9.4,"B","OUTPATIENT PHARMACY",0)) Q
"RTN","ORCSAVE",91,0)
 . S ORPKIU=0 I $D(^ORD(100.7,"C",DUZ)) S ORPKIU=1
"RTN","ORCSAVE",92,0)
 . D PKI^ORWDPS1(.ORY,OI,CATG,+ORVP,ORPKIU)
"RTN","ORCSAVE",93,0)
 . I $E($G(ORY))=2 S ORDEA=ORY
"RTN","ORCSAVE",94,0)
 K ^OR(100,ORIFN,8,1,.1) D ORDTEXT^ORCSAVE1(ORIFN_";1") ; order text
"RTN","ORCSAVE",95,0)
 S NODE=^OR(100,ORIFN,8,1,0) D  S ^OR(100,ORIFN,8,1,0)=NODE
"RTN","ORCSAVE",96,0)
 . S $P(NODE,U,3)=$G(ORNP)
"RTN","ORCSAVE",97,0)
 . S $P(NODE,U,13)=USR
"RTN","ORCSAVE",98,0)
 S NODE=$G(^OR(100,ORIFN,0)) D  S ^OR(100,ORIFN,0)=NODE
"RTN","ORCSAVE",99,0)
 . S $P(NODE,U,4)=$G(ORNP) ; COST?
"RTN","ORCSAVE",100,0)
 . S I=$O(^OR(100,ORIFN,4.5,"ID","LOCATION",0))
"RTN","ORCSAVE",101,0)
 . I I,$P(NODE,U,10) S X=+$G(^OR(100,ORIFN,4.5,+I,1)) S:X $P(NODE,U,10)=X_";SC(" ;reset Loc if prev value
"RTN","ORCSAVE",102,0)
 . S I=$O(^OR(100,ORIFN,4.5,"ID","CLASS",0))
"RTN","ORCSAVE",103,0)
 . I I S X=$G(^OR(100,ORIFN,4.5,+I,1)) S:"^I^O^"[(U_X_U) $P(NODE,U,12)=X
"RTN","ORCSAVE",104,0)
 S $P(^OR(100,ORIFN,3),U)=NOW
"RTN","ORCSAVE",105,0)
 D DELOCC^OROCAPI1(ORIFN,"ACCEPTANCE_CPRS")
"RTN","ORCSAVE",106,0)
 I $G(ORCHECK) D  ; save order checks
"RTN","ORCSAVE",107,0)
 . S (CNT,CDL)=0 F  S CDL=$O(ORCHECK("NEW",CDL)) Q:CDL'>0  S I=0 D
"RTN","ORCSAVE",108,0)
 . . F  S I=$O(ORCHECK("NEW",CDL,I)) Q:I'>0  D
"RTN","ORCSAVE",109,0)
 . . . I $D(ORCHECK("NEW",CDL,I,0)) D
"RTN","ORCSAVE",110,0)
 . . . . N J S J=0,ORCHECK("NEW",CDL,I)=ORCHECK("NEW",CDL,I,J) F  S J=$O(ORCHECK("NEW",CDL,I,J)) Q:'J  S ORCHECK("NEW",CDL,I)=ORCHECK("NEW",CDL,I)_ORCHECK("NEW",CDL,I,J)
"RTN","ORCSAVE",111,0)
 . . . S X=ORCHECK("NEW",CDL,I)
"RTN","ORCSAVE",112,0)
 . . . S ORK(I,1)=+ORIFN_U_"ACCEPTANCE_CPRS"_U_DUZ_U_$$NOW^XLFDT_U_$P(X,U)_U_CDL
"RTN","ORCSAVE",113,0)
 . . . S ORK(I,2,1)=$P(X,U,3)
"RTN","ORCSAVE",114,0)
 . . . I $E(ORK(I,2,1),0,2)="||" D
"RTN","ORCSAVE",115,0)
 . . . . N ORGLOB,ORRULE,ORI,ORLINE
"RTN","ORCSAVE",116,0)
 . . . . S ORGLOB=$P($P(ORK(I,2,1),"||",2),"&"),ORRULE=$P($P(ORK(I,2,1),"||",2),"&",2)
"RTN","ORCSAVE",117,0)
 . . . . S ORK(I,2,1)=ORRULE,ORI=0,ORLINE=2
"RTN","ORCSAVE",118,0)
 . . . . F  S ORI=$O(^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI)) Q:'ORI  S ORK(I,2,ORLINE)=^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI),ORLINE=ORLINE+1
"RTN","ORCSAVE",119,0)
 . I $D(ORK) D
"RTN","ORCSAVE",120,0)
 . . N OCRET,ORKI
"RTN","ORCSAVE",121,0)
 . . D SAVEOC^OROCAPI1(.ORK,.OCRET)
"RTN","ORCSAVE",122,0)
 . . S ORKI=0 F  S ORKI=$O(ORK(ORKI)) Q:'ORKI  D
"RTN","ORCSAVE",123,0)
 . . . N OCINST,OCTXT S OCTXT=$G(ORK(ORKI,2,1))
"RTN","ORCSAVE",124,0)
 . . . S OCINST=$O(OCRET(ORKI,0))
"RTN","ORCSAVE",125,0)
 . . . N ORMONOI,ORMONOQ S ORMONOI=0,ORMONOQ=0 F  Q:ORMONOQ=1  S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",ORMONOI)) Q:'ORMONOI  D
"RTN","ORCSAVE",126,0)
 . . . . I OCTXT[$G(^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")) D
"RTN","ORCSAVE",127,0)
 . . . . . S ORMONOQ=1
"RTN","ORCSAVE",128,0)
 . . . . . S ^ORD(100.05,OCINST,17)=^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")
"RTN","ORCSAVE",129,0)
 . . . . . M ^ORD(100.05,OCINST,16)=^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")
"RTN","ORCSAVE",130,0)
 . . . . . S ^ORD(100.05,OCINST,16,0)="^^"_$O(^ORD(100.05,OCINST,16,""),-1)_U_$O(^ORD(100.05,OCINST,16,""),-1)_U_+$$NOW^XLFDT_U
"RTN","ORCSAVE",131,0)
 . . K ^TMP($J,"ORMONOGRAPH")
"RTN","ORCSAVE",132,0)
 . . K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCSAVE",133,0)
 K ORDEA
"RTN","ORCSAVE",134,0)
ENQ Q
"RTN","ORCSAVE",135,0)
 ;
"RTN","ORCSAVE",136,0)
NEXTIFN() ; -- Returns next available ORIFN
"RTN","ORCSAVE",137,0)
 N I,HDR,LAST,TOTAL,DA
"RTN","ORCSAVE",138,0)
 L +^OR(100,0):$S($G(DILOCKTM)>0:DILOCKTM,1:5)
"RTN","ORCSAVE",139,0)
 I '$T Q "^"
"RTN","ORCSAVE",140,0)
 S HDR=$G(^OR(100,0)),TOTAL=+$P(HDR,U,4),LAST=$O(^OR(100,"?"),-1)
"RTN","ORCSAVE",141,0)
 S I=LAST\1 F I=(I+1):1 Q:'$D(^OR(100,I,0))
"RTN","ORCSAVE",142,0)
 S DA=I,^OR(100,DA,0)=DA,$P(HDR,U,3,4)=DA_U_(TOTAL+1)
"RTN","ORCSAVE",143,0)
 S ^OR(100,0)=HDR L -^OR(100,0)
"RTN","ORCSAVE",144,0)
 Q DA
"RTN","ORCSAVE",145,0)
 ;
"RTN","ORCSAVE",146,0)
RESPONSE ; -- Save responses in ORDIALOG() into ^OR(100,ORIFN,4.5)
"RTN","ORCSAVE",147,0)
 N PROMPT,CNT,ITM,TYPE,INST,VALUE,I,START,PAT,X
"RTN","ORCSAVE",148,0)
 S PAT=$P(^OR(100,ORIFN,0),U,2),START=$P(^(0),U,8) K ^(4.5)
"RTN","ORCSAVE",149,0)
 S (PROMPT,CNT)=0 F  S PROMPT=$O(ORDIALOG(PROMPT)) Q:PROMPT'>0  D
"RTN","ORCSAVE",150,0)
 . S ITM=$G(ORDIALOG(PROMPT)) Q:'ITM
"RTN","ORCSAVE",151,0)
 . S TYPE=$E($G(ORDIALOG(PROMPT,0))) Q:'$L(TYPE)
"RTN","ORCSAVE",152,0)
 . S INST=0 F  S INST=$O(ORDIALOG(PROMPT,INST)) Q:INST'>0  D
"RTN","ORCSAVE",153,0)
 . . S VALUE=$G(ORDIALOG(PROMPT,INST)) Q:VALUE=""  S CNT=CNT+1
"RTN","ORCSAVE",154,0)
 . . S ^OR(100,ORIFN,4.5,CNT,0)=+ITM_U_PROMPT_U_INST_U_$P(ITM,U,2)
"RTN","ORCSAVE",155,0)
 . . S:$L($P(ITM,U,2)) ^OR(100,ORIFN,4.5,"ID",$P(ITM,U,2),CNT)=""
"RTN","ORCSAVE",156,0)
 . . I VALUE<1,TYPE="N" S VALUE=0_+VALUE I VALUE="00" S VALUE=0
"RTN","ORCSAVE",157,0)
 . . S:TYPE'="W" ^OR(100,ORIFN,4.5,CNT,1)=VALUE
"RTN","ORCSAVE",158,0)
 . . M:TYPE="W" ^OR(100,ORIFN,4.5,CNT,2)=@VALUE ; array root
"RTN","ORCSAVE",159,0)
 S ^OR(100,ORIFN,4.5,0)="^100.045A^"_CNT_U_CNT
"RTN","ORCSAVE",160,0)
R1 ; [Reset] Orderables
"RTN","ORCSAVE",161,0)
 I $D(^OR(100,ORIFN,.1)) S I=0 F  S I=$O(^OR(100,ORIFN,.1,I)) Q:I'>0  S X=$G(^(I,0)) I X,PAT,START K ^OR(100,"AOI",X,PAT,9999999-START,ORIFN) ; kill xref
"RTN","ORCSAVE",162,0)
 K ^OR(100,ORIFN,.1) I $D(^OR(100,ORIFN,4.5,"ID","ORDERABLE")) D
"RTN","ORCSAVE",163,0)
 . S (I,CNT)=0
"RTN","ORCSAVE",164,0)
 . F  S I=$O(^OR(100,ORIFN,4.5,"ID","ORDERABLE",I)) Q:I'>0  D
"RTN","ORCSAVE",165,0)
 . . S X=$G(^OR(100,ORIFN,4.5,I,1)) Q:'X
"RTN","ORCSAVE",166,0)
 . . S CNT=CNT+1,^OR(100,ORIFN,.1,CNT,0)=X,^OR(100,ORIFN,.1,"B",X,CNT)=""
"RTN","ORCSAVE",167,0)
 . . I PAT,START S ^OR(100,"AOI",X,PAT,9999999-START,ORIFN)=""
"RTN","ORCSAVE",168,0)
 . S ^OR(100,ORIFN,.1,0)="^100.001PA^"_CNT_U_CNT
"RTN","ORCSAVE",169,0)
 Q
"RTN","ORCSAVE",170,0)
 ;
"RTN","ORCSAVE",171,0)
RESUME(IFN) ; -- add Response nodes for RESUME tray service
"RTN","ORCSAVE",172,0)
 ; S ^OR(100,+IFN,4.5,<next>,0)=DT_"^^^RESUME",^(1)=1
"RTN","ORCSAVE",173,0)
 ;
"RTN","ORCSAVE",174,0)
 N X,Y,DA,DIC,DLAYGO
"RTN","ORCSAVE",175,0)
 S DIC="^OR(100,"_+IFN_",4.5,",DIC(0)="LX",DA(1)=+IFN,X=DT
"RTN","ORCSAVE",176,0)
 S DIC("DR")=".04///RESUME",DIC("P")=$P(^DD(100,4.5,0),U,2),DLAYGO=100
"RTN","ORCSAVE",177,0)
 D ^DIC S:Y ^OR(100,+IFN,4.5,+Y,1)=1
"RTN","ORCSAVE",178,0)
 Q
"RTN","ORCSAVE",179,0)
 ;
"RTN","ORCSAVE",180,0)
PROVIDER(ORDER,PROV) ; -- Change PROVider assigned to ORDER
"RTN","ORCSAVE",181,0)
 Q:'$G(ORDER)  Q:'$G(PROV)
"RTN","ORCSAVE",182,0)
 N ORACT S ORACT=+$P(ORDER,";",2) S:'ORACT ORACT=1
"RTN","ORCSAVE",183,0)
 S $P(^OR(100,+ORDER,8,ORACT,0),U,3)=PROV
"RTN","ORCSAVE",184,0)
 S:ORACT=1 $P(^OR(100,+ORDER,0),U,4)=PROV
"RTN","ORCSAVE",185,0)
 Q
"RTN","ORCSAVE",186,0)
 ;
"RTN","ORCSAVE",187,0)
ACTION(CODE,DA,PROV,REASON,WHEN,WHO) ; -- save new action
"RTN","ORCSAVE",188,0)
 N NEXT,TOTAL,HDR,LAST,X,PAT,DGRP,SIG,NATR,TXT S DA=+DA
"RTN","ORCSAVE",189,0)
 Q:'$D(^OR(100,DA,0)) 0 Q:$G(CODE)'?2U 0
"RTN","ORCSAVE",190,0)
 S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12) S:'$G(WHO) WHO=DUZ
"RTN","ORCSAVE",191,0)
 S NATR=+$O(^ORD(100.02,"C","E",0)) ;assume Elec Entered until changed
"RTN","ORCSAVE",192,0)
 S PAT=$P(^OR(100,DA,0),U,2),DGRP=$P(^(0),U,11),SIG=$P(^(0),U,16),X=+$P($G(^(3)),U,7),HDR=$G(^(8,0))
"RTN","ORCSAVE",193,0)
 S:X'>0 X=1 S TXT=$P($G(^OR(100,DA,8,X,0)),U,14) ;current actn's txt ptr
"RTN","ORCSAVE",194,0)
 S:HDR="" HDR="^100.008DA^^" S TOTAL=+$P(HDR,U,4)
"RTN","ORCSAVE",195,0)
 S LAST=$O(^OR(100,DA,8,"C",CODE,"?"),-1) I LAST D
"RTN","ORCSAVE",196,0)
 . S X=$G(^OR(100,DA,8,LAST,0)) Q:$P(X,U,15)'=11  Q:$P(X,U,4)'=2
"RTN","ORCSAVE",197,0)
 . S NEXT=LAST I PAT,$P(X,U) D  ; kill old xref entries
"RTN","ORCSAVE",198,0)
 . . K:DGRP ^OR(100,"ACT",PAT,(9999999-$P(X,U)),DGRP,DA,NEXT)
"RTN","ORCSAVE",199,0)
 . . K ^OR(100,"AC",PAT,(9999999-$P(X,U)),DA,NEXT),^OR(100,"AS",PAT,(9999999-$P(X,U)),DA,NEXT),^OR(100,"AF",$P(X,U),DA,NEXT)
"RTN","ORCSAVE",200,0)
 S:'$G(NEXT) NEXT=$O(^OR(100,DA,8,"?"),-1)+1,TOTAL=TOTAL+1
"RTN","ORCSAVE",201,0)
 S ^OR(100,DA,8,NEXT,0)=WHEN_U_CODE_U_$G(PROV)_U_$S(SIG:2,1:3)_"^^^^^^^^"_NATR_U_WHO_U_TXT_"^11",^OR(100,DA,8,"C",CODE,NEXT)=""
"RTN","ORCSAVE",202,0)
 S ^OR(100,"AF",WHEN,DA,NEXT)=""
"RTN","ORCSAVE",203,0)
 I PAT,DGRP S ^OR(100,"ACT",PAT,9999999-WHEN,DGRP,DA,NEXT)=""
"RTN","ORCSAVE",204,0)
 I PAT S ^OR(100,"AC",PAT,9999999-WHEN,DA,NEXT)=""
"RTN","ORCSAVE",205,0)
 I SIG S ^OR(100,"AS",PAT,9999999-WHEN,DA,NEXT)=""
"RTN","ORCSAVE",206,0)
 S:$L($G(REASON)) ^OR(100,DA,8,NEXT,1)=REASON
"RTN","ORCSAVE",207,0)
 S $P(HDR,U,3,4)=NEXT_U_TOTAL,^OR(100,DA,8,0)=HDR
"RTN","ORCSAVE",208,0)
 Q NEXT
"RTN","ORCSAVE",209,0)
 ;
"RTN","ORCSAVE",210,0)
SET(DLG) ; -- Create new parent for order set ORDIALOG
"RTN","ORCSAVE",211,0)
 ; Returns ORPIFN = ifn of new parent order for set
"RTN","ORCSAVE",212,0)
 ;
"RTN","ORCSAVE",213,0)
 Q:'$G(ORVP)  Q:'$G(DLG)  N OR0,PKG,NOW,CATG,STS,ORLOC,TRSPEC,X
"RTN","ORCSAVE",214,0)
 S OR0=$G(^ORD(101.41,DLG,0)) Q:OR0=""  S ORPIFN=$$NEXTIFN Q:'ORPIFN
"RTN","ORCSAVE",215,0)
 S PKG=$O(^DIC(9.4,"C","OR",0)),CATG=$S($$INPT^ORCD:"I",1:"O"),STS=$S($G(OREVENT):10,1:11),NOW=$S($G(ORSLOG):ORSLOG,1:+$E($$NOW^XLFDT,1,12))
"RTN","ORCSAVE",216,0)
 I $G(OREVENT) S ORLOC="",TRSPEC=""
"RTN","ORCSAVE",217,0)
 S ^OR(100,ORPIFN,0)=ORPIFN_U_ORVP_U_U_$G(ORNP)_U_DLG_";ORD(101.41,^"_DUZ_U_NOW_U_U_U_ORLOC_U_U_CATG_U_TRSPEC_U_PKG_"^^^"_$G(OREVENT),^(3)=NOW_"^90^"_STS_U_$S($G(ORIT):ORIT_"ORD(101.41,",1:"")_"^^^1^^^^0^^"_+$P(OR0,U,6)
"RTN","ORCSAVE",218,0)
 S ^OR(100,ORPIFN,8,0)="^100.008DA^1^1",^(1,0)=NOW_"^NW^"_$G(ORNP)_"^^^^^^^^^^"_DUZ_"^^"_STS,^OR(100,ORPIFN,8,"C","NW",1)="",^OR(100,"AF",NOW,ORPIFN,1)=""
"RTN","ORCSAVE",219,0)
 S ^OR(100,"ACT",ORVP,9999999-NOW,ORPIFN,1)=""
"RTN","ORCSAVE",220,0)
 S:STS=11 ^OR(100,"AC",ORVP,9999999-NOW,ORPIFN,1)=""
"RTN","ORCSAVE",221,0)
 ; AEVNT ??
"RTN","ORCSAVE",222,0)
 S ^OR(100,ORPIFN,1,0)="^100.011^1^1",^(1,0)=$P(OR0,U,2) ; Order text
"RTN","ORCSAVE",223,0)
 Q
"RTN","ORCSAVE2")
0^9^B85557974
"RTN","ORCSAVE2",1,0)
ORCSAVE2 ;SLC/MKB - UTILITIES TO UPDATE AN ORDER ;04/10/15  11:23
"RTN","ORCSAVE2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**4,27,56,70,94,116,190,157,215,265,243,293,280,346,269**;Dec 17, 1997;Build 85
"RTN","ORCSAVE2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCSAVE2",4,0)
 ;
"RTN","ORCSAVE2",5,0)
 ;
"RTN","ORCSAVE2",6,0)
STATUS(IFN,ST) ; -- Update status of order
"RTN","ORCSAVE2",7,0)
 Q:'$G(IFN)  Q:'$D(^OR(100,+IFN,0))  Q:$P($G(^(3)),U,3)=$G(ST)  ;no change
"RTN","ORCSAVE2",8,0)
 Q:'$G(ST)  Q:'$D(^ORD(100.01,+ST,0))
"RTN","ORCSAVE2",9,0)
 N NODE0,NODE3,ORNOW,DA,XACT,PROV,ORVP
"RTN","ORCSAVE2",10,0)
 S NODE3=$G(^OR(100,+IFN,3)),ORVP=$P($G(^(0)),U,2),ORNOW=$$NOW^XLFDT
"RTN","ORCSAVE2",11,0)
 S $P(NODE3,U)=ORNOW,$P(NODE3,U,3)=ST,^OR(100,+IFN,3)=NODE3
"RTN","ORCSAVE2",12,0)
 I (ST<3)!(ST=12)!(ST=13),$G(ORDCNTRL)'="ZC" D DATES(+IFN,,+$E(ORNOW,1,12))
"RTN","ORCSAVE2",13,0)
 I "^1^2^7^12^13^15^"[(U_ST_U) D CANCEL^ORCSEND(+IFN),UNOTIF^ORCSIGN
"RTN","ORCSAVE2",14,0)
 I $P(NODE3,U,9) D CKPARENT($P(NODE3,U,9)) ; ck siblings to update parent
"RTN","ORCSAVE2",15,0)
 D SETALL^ORDD100(+IFN)
"RTN","ORCSAVE2",16,0)
 Q
"RTN","ORCSAVE2",17,0)
 ;
"RTN","ORCSAVE2",18,0)
CKPARENT(ORIFN) ; -- Update status of parent order, if appropriate
"RTN","ORCSAVE2",19,0)
 N ORSTS,ALLRELSD,ALLDONE,DC,COMP,CH,CHSTS,ACTIVE,LAPS
"RTN","ORCSAVE2",20,0)
 Q:'$D(^OR(100,ORIFN,0))  S ORSTS=$P($G(^(3)),U,3)
"RTN","ORCSAVE2",21,0)
 I (ORSTS=11)!(ORSTS=10) S ALLRELSD=1 D  Q  ;Parent unrel'd - ck children
"RTN","ORCSAVE2",22,0)
 . F CH=0:0 S CH=$O(^OR(100,ORIFN,2,CH)) Q:CH'>0  D  Q:'ALLRELSD
"RTN","ORCSAVE2",23,0)
 . . I '$D(^OR(100,CH)) K ^OR(100,ORIFN,2,CH) Q
"RTN","ORCSAVE2",24,0)
 . . S CHSTS=$P($G(^OR(100,CH,3)),U,3) S:CHSTS=11 ALLRELSD=0
"RTN","ORCSAVE2",25,0)
 . I ALLRELSD D STATUS(ORIFN,5) ; update Parent order to pending
"RTN","ORCSAVE2",26,0)
 S ALLDONE=1,(DC,COMP,LAPS,ACTIVE)=0
"RTN","ORCSAVE2",27,0)
 F CH=0:0 S CH=$O(^OR(100,ORIFN,2,CH)) Q:CH'>0  D  Q:'ALLDONE
"RTN","ORCSAVE2",28,0)
 . I '$D(^OR(100,CH)) K ^OR(100,ORIFN,2,CH) Q
"RTN","ORCSAVE2",29,0)
 . S CHSTS=$P($G(^OR(100,CH,3)),U,3) I CHSTS=14 S LAPS=1 Q
"RTN","ORCSAVE2",30,0)
 . I "^1^12^13^"[(U_CHSTS_U) S DC=1 Q
"RTN","ORCSAVE2",31,0)
 . I "^2^7^"[(U_CHSTS_U) S COMP=1 Q
"RTN","ORCSAVE2",32,0)
 . S ALLDONE=0 S:CHSTS=6 ACTIVE=1
"RTN","ORCSAVE2",33,0)
 I ALLDONE S ORSTS=$S(COMP:2,DC:1,LAPS:14,1:"") D:ORSTS STATUS(ORIFN,ORSTS) Q
"RTN","ORCSAVE2",34,0)
 I ACTIVE,ORSTS'=6 D STATUS(ORIFN,6) ;at least child active
"RTN","ORCSAVE2",35,0)
 Q
"RTN","ORCSAVE2",36,0)
 ;
"RTN","ORCSAVE2",37,0)
RELEASE(ORDER,ACTION,WHEN,WHO,NATURE) ; -- Mark order as released to service
"RTN","ORCSAVE2",38,0)
 S:'$G(ACTION) ACTION=1 S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12) S:'$G(WHO) WHO=DUZ
"RTN","ORCSAVE2",39,0)
 Q:'$G(ORDER)  N OR0 S OR0=$G(^OR(100,ORDER,8,ACTION,0))
"RTN","ORCSAVE2",40,0)
 S:$L($G(NATURE)) $P(OR0,U,12)=$S(NATURE:NATURE,1:+$O(^ORD(100.02,"C",NATURE,0)))
"RTN","ORCSAVE2",41,0)
 S:($P(OR0,U,15)=10)!($P(OR0,U,15)=11) $P(OR0,U,15)=""
"RTN","ORCSAVE2",42,0)
 ;S $P(OR0,U,16,17)=WHEN_U_WHO,^OR(100,"AR",ORVP,9999999-WHEN,ORDER,ACTION)=""
"RTN","ORCSAVE2",43,0)
 S $P(OR0,U,16,17)=WHEN_U_WHO
"RTN","ORCSAVE2",44,0)
 S ^OR(100,ORDER,8,ACTION,0)=OR0
"RTN","ORCSAVE2",45,0)
 I $P(OR0,U,2)="NW",'$P(^OR(100,ORDER,0),U,8) D STARTDT(ORDER)
"RTN","ORCSAVE2",46,0)
 ;Set the "AR" index.
"RTN","ORCSAVE2",47,0)
 D RS^ORDD100(ORDER,ACTION,ORVP,WHEN)
"RTN","ORCSAVE2",48,0)
 Q
"RTN","ORCSAVE2",49,0)
 ;
"RTN","ORCSAVE2",50,0)
STARTDT(DA) ; -- resolve Start and Stop dates from Responses
"RTN","ORCSAVE2",51,0)
 N X,Y,%DT,ORDG,ORT,ORLAB
"RTN","ORCSAVE2",52,0)
 S ORDG=$P($G(^ORD(100.98,+$P(^OR(100,DA,0),U,11),0)),U,3)
"RTN","ORCSAVE2",53,0)
 S ORLAB="^LAB^CH^HEMA^MI^AP^AU^EM^SP^CY^BB^"[(U_ORDG_U),ORT=""
"RTN","ORCSAVE2",54,0)
 S:ORDG="E/L T" ORT=$$VALUE(DA,"TIME") S:ORDG="MEAL" ORT=$$MEALTIME^ORCDFHO(DA)
"RTN","ORCSAVE2",55,0)
STRT S X=$$VALUE(DA,"START") I '$L(X) D WS^ORDD100 Q  S:$L(ORT) X=X_"@"_ORT
"RTN","ORCSAVE2",56,0)
 D AM:X="AM",NEXT:X="NEXT",ADMIN("NEXT"):X="NEXTA",ADMIN("CLOSEST"):X="CLOSEST"
"RTN","ORCSAVE2",57,0)
 S %DT="T" D ^%DT Q:Y'>0  S:$E($P(Y,".",2),1,2)=24 Y=$P(Y,".")_".2359"
"RTN","ORCSAVE2",58,0)
 S $P(^OR(100,DA,0),U,8)=Y D SS^ORDD100,WS^ORDD100,OI1^ORDD100A(DA)
"RTN","ORCSAVE2",59,0)
STOP I ORLAB S X=$$VALUE(DA,"DAYS") Q:X'>1  S X=$$FMADD^XLFDT(Y,(X-1))
"RTN","ORCSAVE2",60,0)
 I 'ORLAB S X=$$VALUE(DA,"STOP") Q:'$L(X)  S:$L(ORT) X=X_"@"_ORT
"RTN","ORCSAVE2",61,0)
 S %DT="T" D ^%DT Q:Y'>0  S:$E($P(Y,".",2),1,2)=24 Y=$P(Y,".")_".2359"
"RTN","ORCSAVE2",62,0)
 S $P(^OR(100,DA,0),U,9)=Y D ES^ORDD100A
"RTN","ORCSAVE2",63,0)
 Q
"RTN","ORCSAVE2",64,0)
 ;
"RTN","ORCSAVE2",65,0)
NEXT ; -- Resolve next lab collection to FM date/time
"RTN","ORCSAVE2",66,0)
 N ORTIME,ORDAY,NOW,NEXT,ENT
"RTN","ORCSAVE2",67,0)
 ;is referenced by DBIA #964
"RTN","ORCSAVE2",68,0)
 S ENT=$S($P($G(^SC(+$G(ORL),0)),U,4):+$P(^(0),U,4),1:+$G(DUZ(2)))_";DIC(4," S:ENT'>0 ENT="ALL"
"RTN","ORCSAVE2",69,0)
 D GETLST^XPAR(.ORTIME,ENT,"LR PHLEBOTOMY COLLECTION","N")
"RTN","ORCSAVE2",70,0)
 S NOW=$P($H,",",2),ORDAY=$S($O(ORTIME(NOW)):"T",1:"T+1")
"RTN","ORCSAVE2",71,0)
 S ORDAY=$$NEXTCOLL^ORCDLR1(ORDAY) S:ORDAY["+" NOW=0
"RTN","ORCSAVE2",72,0)
 S NEXT=$O(ORTIME(NOW)),X=ORDAY_"@"_$P($G(ORTIME(+NEXT)),U)
"RTN","ORCSAVE2",73,0)
 Q
"RTN","ORCSAVE2",74,0)
 ;
"RTN","ORCSAVE2",75,0)
AM ; -- Resolve AM lab collection to FM date/time
"RTN","ORCSAVE2",76,0)
 N ORTIME,ORDAY,AM,NOW,ENT
"RTN","ORCSAVE2",77,0)
 ;is referenced by DBIA #964
"RTN","ORCSAVE2",78,0)
 S ENT=$S($P($G(^SC(+$G(ORL),0)),U,4):+$P(^(0),U,4),1:+$G(DUZ(2)))_";DIC(4," S:ENT'>0 ENT="ALL"
"RTN","ORCSAVE2",79,0)
 D GETLST^XPAR(.ORTIME,ENT,"LR PHLEBOTOMY COLLECTION","N")
"RTN","ORCSAVE2",80,0)
 S AM=$O(ORTIME(0)),NOW=$P($H,",",2)
"RTN","ORCSAVE2",81,0)
 S ORDAY=$S(AM=$O(ORTIME(NOW)):"T",1:"T+1")
"RTN","ORCSAVE2",82,0)
 S X=$$NEXTCOLL^ORCDLR1(ORDAY)_"@"_$P($G(ORTIME(+AM)),U)
"RTN","ORCSAVE2",83,0)
 Q
"RTN","ORCSAVE2",84,0)
 ;
"RTN","ORCSAVE2",85,0)
ADMIN(START) ; -- Resolve next/closest administration times to FM date/time
"RTN","ORCSAVE2",86,0)
 N PAT,SCH,OI,LOC,Y,I
"RTN","ORCSAVE2",87,0)
 I $G(DA) D  ;get data from order DA
"RTN","ORCSAVE2",88,0)
 . S PAT=+$P($G(^OR(100,DA,0)),U,2),LOC=""
"RTN","ORCSAVE2",89,0)
 . S I=+$O(^OR(100,DA,4.5,"ID","INSTR",0)),I=+$P($G(^OR(100,DA,4.5,I,0)),U,3) ;first
"RTN","ORCSAVE2",90,0)
 . S SCH=$$VALUE(DA,"SCHEDULE",I),OI=$$VALUE(DA,"ORDERABLE")
"RTN","ORCSAVE2",91,0)
 I '$G(DA) D  ;or look in ORDIALOG() instead
"RTN","ORCSAVE2",92,0)
 . S I=+$O(ORDIALOG($$PTR^ORCD("OR GTX INSTRUCTIONS"),0))
"RTN","ORCSAVE2",93,0)
 . S PAT=$G(ORVP),SCH=$G(ORDIALOG($$PTR^ORCD("OR GTX SCHEDULE"),I))
"RTN","ORCSAVE2",94,0)
 . S OI=$G(ORDIALOG($$PTR^ORCD("OR GTX ORDERABLE ITEM"),1)),LOC=""
"RTN","ORCSAVE2",95,0)
 S OI=+$P($G(^ORD(101.43,+OI,0)),U,2) ;PSOI
"RTN","ORCSAVE2",96,0)
 ;is referenced by DBIA #3167
"RTN","ORCSAVE2",97,0)
 S Y=$$RESOLVE^PSJORPOE(PAT,SCH,OI,START,LOC),X=$P(Y,U,2)
"RTN","ORCSAVE2",98,0)
 Q
"RTN","ORCSAVE2",99,0)
 ;
"RTN","ORCSAVE2",100,0)
SIGN(DA,WHO,WHEN,HOW,WHAT) ; -- affix ES to order
"RTN","ORCSAVE2",101,0)
 Q:'$G(DA)  S:'$G(WHAT) WHAT=1
"RTN","ORCSAVE2",102,0)
 N X S X=$G(^OR(100,DA,8,WHAT,0)) D S2^ORDD100(DA,WHAT) ; kill AS xref
"RTN","ORCSAVE2",103,0)
 S $P(X,U,4,7)=$G(HOW)_U_$G(WHO)_U_$E($G(WHEN),1,12)_U_$S(HOW=0:DUZ,1:"")
"RTN","ORCSAVE2",104,0)
 ; S:$G(WHO) $P(X,U,3)=WHO ; reset provider to signer
"RTN","ORCSAVE2",105,0)
 S ^OR(100,DA,8,WHAT,0)=X
"RTN","ORCSAVE2",106,0)
 D:$G(HOW)=2 S1^ORDD100(DA,WHAT) ; reset AS xref
"RTN","ORCSAVE2",107,0)
 Q
"RTN","ORCSAVE2",108,0)
 ;
"RTN","ORCSAVE2",109,0)
SIGSTS(IFN,ACT) ; -- Set SigSts for backdoor orders [Called from ^ORM* rtns]
"RTN","ORCSAVE2",110,0)
 ; Expects ORNATR, ORVP, ORNP to be defined
"RTN","ORCSAVE2",111,0)
 Q:'$G(IFN)  Q:'$G(ACT)  N X,OR0 S OR0=+$P($G(^OR(100,+IFN,8,ACT,0)),U)
"RTN","ORCSAVE2",112,0)
 S X=$S($$SIGNREQD^ORCACT1(+IFN):$$SIGSTS^ORX1(ORNATR),1:3)
"RTN","ORCSAVE2",113,0)
 K ^OR(100,"AS",ORVP,9999999-OR0,+IFN,ACT)
"RTN","ORCSAVE2",114,0)
 S $P(^OR(100,+IFN,8,ACT,0),U,4)=X
"RTN","ORCSAVE2",115,0)
 I X=2 S ^OR(100,"AS",ORVP,9999999-OR0,+IFN,ACT)="" D NOTIF^ORCSIGN
"RTN","ORCSAVE2",116,0)
 Q
"RTN","ORCSAVE2",117,0)
 ;
"RTN","ORCSAVE2",118,0)
UNVEIL(IFN) ; -- unveil new order
"RTN","ORCSAVE2",119,0)
 S $P(^OR(100,IFN,3),U,8)=""
"RTN","ORCSAVE2",120,0)
 Q
"RTN","ORCSAVE2",121,0)
 ;
"RTN","ORCSAVE2",122,0)
DELETE(ORDER) ; -- delete order [action]
"RTN","ORCSAVE2",123,0)
 N DIK,DA,DAD
"RTN","ORCSAVE2",124,0)
 I $P(ORDER,";",2)>1 S DA=+$P(ORDER,";",2),DA(1)=+ORDER,DIK="^OR(100,"_DA(1)_",8," D:DA ^DIK Q
"RTN","ORCSAVE2",125,0)
 S DAD=+$P($G(^OR(100,+ORDER,3)),U,9) I DAD S DIK="^OR(100,"_DAD_",2,",DA(1)=DAD,DA=+ORDER D ^DIK ; remove link to child from parent
"RTN","ORCSAVE2",126,0)
 K DA S DA=+ORDER,DIK="^OR(100," D ^DIK ;remove order, text
"RTN","ORCSAVE2",127,0)
 D DELETE^OROCAPI1(+ORDER)
"RTN","ORCSAVE2",128,0)
 Q
"RTN","ORCSAVE2",129,0)
 ;
"RTN","ORCSAVE2",130,0)
VERIFY(IFN,DA,TYPE,WHO,WHEN) ; -- order verified
"RTN","ORCSAVE2",131,0)
 Q:'$G(IFN)  Q:'$G(DA)  Q:"^N^C^R^"'[(U_$G(TYPE)_U)
"RTN","ORCSAVE2",132,0)
 I $G(^TMP($J,"OR MOB APP"))="CPRS" Q
"RTN","ORCSAVE2",133,0)
 N FLD S FLD=$S(TYPE="N":8,TYPE="C":10,1:18)
"RTN","ORCSAVE2",134,0)
 S:'$G(WHO) WHO=DUZ S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSAVE2",135,0)
 S $P(^OR(100,IFN,8,DA,0),U,FLD,FLD+1)=WHO_U_WHEN
"RTN","ORCSAVE2",136,0)
 D:$L($T(VER^EDPFMON)) VER^EDPFMON(IFN)
"RTN","ORCSAVE2",137,0)
 Q
"RTN","ORCSAVE2",138,0)
 ;
"RTN","ORCSAVE2",139,0)
COMP(IFN,WHO,WHEN) ; -- order completed
"RTN","ORCSAVE2",140,0)
 Q:'$G(IFN)  S:'$G(WHO) WHO=DUZ S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSAVE2",141,0)
 D DATES(+IFN,,WHEN),STATUS(+IFN,2)
"RTN","ORCSAVE2",142,0)
 S $P(^OR(100,+IFN,6),U,6,7)=WHEN_U_WHO
"RTN","ORCSAVE2",143,0)
 D:$L($T(COMP^EDPFMON)) COMP^EDPFMON(IFN)
"RTN","ORCSAVE2",144,0)
 Q
"RTN","ORCSAVE2",145,0)
 ;
"RTN","ORCSAVE2",146,0)
DATES(DA,START,STOP) ; -- Update start/stop dates for order DA
"RTN","ORCSAVE2",147,0)
 Q:'$G(DA)  I $G(START) D
"RTN","ORCSAVE2",148,0)
 . Q:START=$P(^OR(100,DA,0),U,8)
"RTN","ORCSAVE2",149,0)
 . D SK^ORDD100,WK^ORDD100,OI2^ORDD100A(DA)
"RTN","ORCSAVE2",150,0)
 . S $P(^OR(100,DA,0),U,8)=START
"RTN","ORCSAVE2",151,0)
 . D SS^ORDD100,WS^ORDD100,OI1^ORDD100A(DA)
"RTN","ORCSAVE2",152,0)
 I $G(STOP) D
"RTN","ORCSAVE2",153,0)
 . ;Q:STOP=$P(^OR(100,DA,0),U,9)  ;ck xref anyway
"RTN","ORCSAVE2",154,0)
 . D EK^ORDD100A S $P(^OR(100,DA,0),U,9)=STOP D ES^ORDD100A
"RTN","ORCSAVE2",155,0)
 Q
"RTN","ORCSAVE2",156,0)
 ;
"RTN","ORCSAVE2",157,0)
OC ; -- Save order checks in ORCHECK() in ^OR(100,+ORIFN,9) ON SIGNATURE IN CPRS
"RTN","ORCSAVE2",158,0)
 Q:'$G(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))
"RTN","ORCSAVE2",159,0)
 D DELOCC^OROCAPI1(+ORIFN,"SIGNATURE_CPRS")
"RTN","ORCSAVE2",160,0)
 N I,J,ORK,CNT,OC,OROCRET,ORKI
"RTN","ORCSAVE2",161,0)
 S CNT=0
"RTN","ORCSAVE2",162,0)
 S I=0 F  S I=$O(ORCHECK(+ORIFN,I)) Q:'I  D
"RTN","ORCSAVE2",163,0)
 . S J=0 F  S J=$O(ORCHECK(+ORIFN,I,J)) Q:'J  D
"RTN","ORCSAVE2",164,0)
 . . S OC=ORCHECK(+ORIFN,I,J)
"RTN","ORCSAVE2",165,0)
 . . S CNT=CNT+1
"RTN","ORCSAVE2",166,0)
 . . S ORK(CNT,1)=+ORIFN_U_"SIGNATURE_CPRS"_U_DUZ_U_$$NOW^XLFDT_U_+OC_U_I
"RTN","ORCSAVE2",167,0)
 . . S ORK(CNT,2,1)=$P(OC,U,3)
"RTN","ORCSAVE2",168,0)
 . . S ORK(CNT,3)=$S(I=1:$G(ORCHECK("OK")),1:"")
"RTN","ORCSAVE2",169,0)
 . . I $E(ORK(CNT,2,1),0,2)="||" D
"RTN","ORCSAVE2",170,0)
 . . . N ORGLOB,ORRULE,ORI,ORICNT
"RTN","ORCSAVE2",171,0)
 . . . S ORGLOB=$P($P(ORK(CNT,2,1),"||",2),"&"),ORRULE=$P($P(ORK(CNT,2,1),"||",2),"&",2)
"RTN","ORCSAVE2",172,0)
 . . . S ORK(CNT,2,1)=ORRULE,ORICNT=2,ORI=1
"RTN","ORCSAVE2",173,0)
 . . . F  S ORI=$O(^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI)) Q:'ORI  S ORK(CNT,2,ORICNT)=^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI),ORICNT=ORICNT+1
"RTN","ORCSAVE2",174,0)
 I $D(ORK) D SAVEOC^OROCAPI1(.ORK,.OROCRET)
"RTN","ORCSAVE2",175,0)
 S ORKI=0 F  S ORKI=$O(ORK(ORKI)) Q:'ORKI  D
"RTN","ORCSAVE2",176,0)
 . N OCINST,OCTXT S OCTXT=$G(ORK(ORKI,2,1))
"RTN","ORCSAVE2",177,0)
 . S OCINST=$O(OROCRET(ORKI,0))
"RTN","ORCSAVE2",178,0)
 . N ORMONOI,ORMONOQ S ORMONOI=0,ORMONOQ=0 F  Q:ORMONOQ=1  S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",ORMONOI)) Q:'ORMONOI  D
"RTN","ORCSAVE2",179,0)
 . . I OCTXT[$G(^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")) D
"RTN","ORCSAVE2",180,0)
 . . . S ORMONOQ=1
"RTN","ORCSAVE2",181,0)
 . . . S ^ORD(100.05,OCINST,17)=^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")
"RTN","ORCSAVE2",182,0)
 . . . M ^ORD(100.05,OCINST,16)=^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")
"RTN","ORCSAVE2",183,0)
 . . . S ^ORD(100.05,OCINST,16,0)="^^"_$O(^ORD(100.05,OCINST,16,""),-1)_U_$O(^ORD(100.05,OCINST,16,""),-1)_U_+$$NOW^XLFDT_U
"RTN","ORCSAVE2",184,0)
 K ^TMP($J,"ORMONOGRAPH")
"RTN","ORCSAVE2",185,0)
 Q
"RTN","ORCSAVE2",186,0)
 ;
"RTN","ORCSAVE2",187,0)
VALUE(IFN,ID,INST) ; -- Returns value of prompt by identifier ID
"RTN","ORCSAVE2",188,0)
 I '$G(IFN)!('$D(^OR(100,+$G(IFN),0)))!($G(ID)="") Q ""
"RTN","ORCSAVE2",189,0)
 N I,Y S I=0,Y="" S:'$G(INST) INST=1
"RTN","ORCSAVE2",190,0)
 F  S I=$O(^OR(100,IFN,4.5,"ID",ID,I)) Q:I'>0  I $P($G(^OR(100,IFN,4.5,+I,0)),U,3)=INST S Y=$G(^(1)) Q
"RTN","ORCSAVE2",191,0)
 Q Y
"RTN","ORCSAVE2",192,0)
 ;
"RTN","ORCSAVE2",193,0)
SC(ORX,ORIFN) ; -- save responses to SC questions
"RTN","ORCSAVE2",194,0)
 Q:'$G(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))  ;invalid order number
"RTN","ORCSAVE2",195,0)
 N OR5,I,P S OR5=$G(^OR(100,+ORIFN,5)),P=0
"RTN","ORCSAVE2",196,0)
 F I="SC","MST","AO","IR","EC","HNC","CV","SHD" S P=P+1 S:$D(ORX(I)) $P(OR5,U,P)=ORX(I)
"RTN","ORCSAVE2",197,0)
 S ^OR(100,+ORIFN,5)=OR5
"RTN","ORCSAVE2",198,0)
 Q
"RTN","ORCSAVE2",199,0)
 ;
"RTN","ORCSAVE2",200,0)
CANCEL(ORDER) ; -- cancel order [action]
"RTN","ORCSAVE2",201,0)
 N ORA,DIE,DA,DR,ORX
"RTN","ORCSAVE2",202,0)
 S ORDER=$G(ORDER),ORA=+$P(ORDER,";",2) Q:'ORA!('ORDER)
"RTN","ORCSAVE2",203,0)
 I $D(^OR(100,+ORDER,8,ORA)) D
"RTN","ORCSAVE2",204,0)
 .S ORX="Unsigned/unreleased order cancelled by provider"
"RTN","ORCSAVE2",205,0)
 .S DIE="^OR(100,"_+ORDER_",8,",DA=ORA,DA(1)=+ORDER
"RTN","ORCSAVE2",206,0)
 .S DR="4////5;15////13;1////^S X=ORX" D ^DIE
"RTN","ORCSAVE2",207,0)
 I ORA=1 D
"RTN","ORCSAVE2",208,0)
 .K DA S DIE="^OR(100,",DA=+ORDER,DR="5////13" D ^DIE
"RTN","ORCSAVE2",209,0)
 Q
"RTN","ORCSAVE2",210,0)
 ;
"RTN","ORCSAVE2",211,0)
LAPSE(ORDER) ; -- lapse order [action]
"RTN","ORCSAVE2",212,0)
 N ORA S ORA=+$P(ORDER,";",2)
"RTN","ORCSAVE2",213,0)
 Q:'$D(^OR(100,+ORDER,0))  Q:'ORA!('ORDER)
"RTN","ORCSAVE2",214,0)
 I $D(^OR(100,+ORDER,8,ORA)) D
"RTN","ORCSAVE2",215,0)
 .N DIE,DA,DR
"RTN","ORCSAVE2",216,0)
 .S DIE="^OR(100,"_+ORDER_",8,",DA=ORA,DA(1)=+ORDER
"RTN","ORCSAVE2",217,0)
 .S DR="4////5;15////14" D ^DIE,DELALRT^ORCSAVE1(ORDER) ; DELALRT call added to fix CQ #17536 (TC). [v28.1]
"RTN","ORCSAVE2",218,0)
 I ORA=1 D
"RTN","ORCSAVE2",219,0)
 .N DIE,DA,DR
"RTN","ORCSAVE2",220,0)
 .S DIE="^OR(100,",DA=+ORDER,DR="5////14"
"RTN","ORCSAVE2",221,0)
 .D ^DIE,ALPS(DA,ORA)
"RTN","ORCSAVE2",222,0)
 Q
"RTN","ORCSAVE2",223,0)
ALPS(DA,ORACT,TYPE) ;set the lapse index ^OR(100,"ALPS")
"RTN","ORCSAVE2",224,0)
 N ORVP,X,OR0,ORLOG
"RTN","ORCSAVE2",225,0)
 S OR0=$G(^OR(100,DA,8,ORACT,0))
"RTN","ORCSAVE2",226,0)
 S ORLOG=$P(OR0,U),ORVP=$P($G(^OR(100,DA,0)),U,2)
"RTN","ORCSAVE2",227,0)
 I ORVP,ORLOG S ^OR(100,"ALPS",ORVP,9999999-ORLOG,DA,ORACT)=$G(TYPE)
"RTN","ORCSAVE2",228,0)
 S ^OR(100,DA,10)=$$NOW^XLFDT
"RTN","ORCSAVE2",229,0)
 Q
"RTN","ORCSAVE2",230,0)
 ;
"RTN","ORCSAVE2",231,0)
RESP(IFN,PRMT,VAL,INST) ; -- update a single Response VALue
"RTN","ORCSAVE2",232,0)
 S IFN=+$G(IFN),VAL=$G(VAL),PRMT=+$O(^ORD(101.41,"AB",PRMT,0))
"RTN","ORCSAVE2",233,0)
 N ID,DA,DIK S:'$G(INST) INST=1
"RTN","ORCSAVE2",234,0)
 S ID=$P($G(^ORD(101.41,PRMT,1)),U,3) Q:'$L(ID)
"RTN","ORCSAVE2",235,0)
 S DA=0 F  S DA=$O(^OR(100,IFN,4.5,"ID",ID,DA)) Q:DA<1  Q:$P($G(^OR(100,IFN,4.5,DA,0)),U,3)=INST
"RTN","ORCSAVE2",236,0)
 I 'DA D:$L(VAL)  Q  ;add
"RTN","ORCSAVE2",237,0)
 . N DO,DIC,DLG,X
"RTN","ORCSAVE2",238,0)
 . S DIC="^OR(100,"_IFN_",4.5,",DA(1)=IFN,DIC(0)="FL"
"RTN","ORCSAVE2",239,0)
 . S DIC("DR")=".02///"_PRMT_";.03///"_INST_";.04///"_ID
"RTN","ORCSAVE2",240,0)
 . S DLG=+$P($G(^OR(100,IFN,0)),U,5)
"RTN","ORCSAVE2",241,0)
 . S X=+$O(^ORD(101.41,DLG,10,"D",PRMT,0))
"RTN","ORCSAVE2",242,0)
 . D FILE^DICN S:Y ^OR(100,IFN,4.5,+Y,1)=VAL
"RTN","ORCSAVE2",243,0)
 I $L(VAL) S ^OR(100,IFN,4.5,DA,1)=VAL Q  ;change
"RTN","ORCSAVE2",244,0)
 S DIK="^OR(100,"_IFN_",4.5,",DA(1)=IFN D ^DIK ;delete
"RTN","ORCSAVE2",245,0)
 Q
"RTN","ORKCHK5")
0^1^B87020125
"RTN","ORKCHK5",1,0)
ORKCHK5 ;SLC/CLA - SUPPORT ROUTINE FOR ACCEPT MODE ORDER CHECKS ;05/29/2015  07:42
"RTN","ORKCHK5",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123,190,280,357,345,269**;Dec 17, 1997;Build 85
"RTN","ORKCHK5",3,0)
 Q
"RTN","ORKCHK5",4,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE,OROIL,ORDODSG) ;perform order checking for orderable item acceptance
"RTN","ORKCHK5",5,0)
 ;ORDODSG: FLAG THAT DENOTES IF DOSAGE CHECKS SHOULD BE PERFORMED
"RTN","ORKCHK5",6,0)
 ;         1 FOR PERFORM DOSAGE CHECKS
"RTN","ORKCHK5",7,0)
 ;         0 FOR DO NOT PERFORM DOSAGE CHECKS
"RTN","ORKCHK5",8,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK5",9,0)
 ;
"RTN","ORKCHK5",10,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK5",11,0)
 N OCN,DNGR,ORKMSG,ORKPDATA,ORKOCNUM
"RTN","ORKCHK5",12,0)
 ;
"RTN","ORKCHK5",13,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK5",14,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK5",15,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK5",16,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK5",17,0)
 I ORKDG="GMRC",'$L(ODT) S ODT=$$NOW^XLFDT  ;def consult order d/t is now
"RTN","ORKCHK5",18,0)
 ;
"RTN","ORKCHK5",19,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK5",20,0)
 I $E(ORKDG,1,2)'="PS",($E(ORKDG,1,2)'="LR"),($L($G(OI))),($L($G(ODT))),(ORKTMODE'="ALL") D DUPOR
"RTN","ORKCHK5",21,0)
 I $E(ORKDG,1,2)="LR",($L($G(OI))),($L($G(ODT))),(ORKTMODE'="ALL") D
"RTN","ORKCHK5",22,0)
 .D DUPLAB
"RTN","ORKCHK5",23,0)
 .D LABFREQ
"RTN","ORKCHK5",24,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",25,0)
 D REMCHK(.ORKS,OI,ORKDFN) ;do reminder order checks
"RTN","ORKCHK5",26,0)
 Q
"RTN","ORKCHK5",27,0)
 ;
"RTN","ORKCHK5",28,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK5",29,0)
 N ORPSPKG,ORPSA,ORKDD
"RTN","ORKCHK5",30,0)
 N ORALLRN,ORALLRF,ORALLRD
"RTN","ORKCHK5",31,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK5",32,0)
 ;
"RTN","ORKCHK5",33,0)
 D:+ORDODSG DSGCHK(.ORKS,ORKDFN,.OROIL,ORKA) ;do pharmacy dosage checks
"RTN","ORKCHK5",34,0)
 ;dispense drug selected:
"RTN","ORKCHK5",35,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK5",36,0)
 .D RXOCS
"RTN","ORKCHK5",37,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",38,0)
 ;
"RTN","ORKCHK5",39,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK5",40,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK5",41,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK5",42,0)
 .I ORPSPKG="H" S ORPSPKG="X"  ;change to "X" if "H"erbal/non-VA med
"RTN","ORKCHK5",43,0)
 .I "IOX"[ORPSPKG D OI2DD(.ORPSA,OI,ORPSPKG)
"RTN","ORKCHK5",44,0)
 .S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKCHK5",45,0)
 ..S HL7LTXT=ORPSA(ORKDD)
"RTN","ORKCHK5",46,0)
 ..S HL7NPTR=$P(ORKDD,";",2)
"RTN","ORKCHK5",47,0)
 ..S HL7LPTR=+ORKDD
"RTN","ORKCHK5",48,0)
 ..S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK5",49,0)
 ..S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK5",50,0)
 ..S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK5",51,0)
 ..S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK5",52,0)
 ..D RXOCS
"RTN","ORKCHK5",53,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",54,0)
 Q
"RTN","ORKCHK5",55,0)
 ;
"RTN","ORKCHK5",56,0)
RXOCS ;drug-allergy interaction
"RTN","ORKCHK5",57,0)
 Q:ORALLRF="D"
"RTN","ORKCHK5",58,0)
 N DATA,J,DELIMIT,CRC16,FCOUNT,NUM
"RTN","ORKCHK5",59,0)
 Q:$$ORCHK2^GMRAOR(ORKDFN,"DR",$G(HL7NPTR)_$S($G(HL7NPTR)'[".":".",1:"")_"."_$G(HL7LPTR),,"DATA")<1
"RTN","ORKCHK5",60,0)
 F J=1:1:DATA  D
"RTN","ORKCHK5",61,0)
 .N SIGN,GMRALLER,REACTANT,TEXT,ITM,ITEMS,NODE,COUNT,SEVERE,K,SITE
"RTN","ORKCHK5",62,0)
 .S FCOUNT=2,GMRALLER=$P(DATA(J,"MESSAGE",2),U,3),REACTANT=$P(DATA(J,"MESSAGE",2),U,2)
"RTN","ORKCHK5",63,0)
 .;Previous [SEVERITY] adverse reaction
"RTN","ORKCHK5",64,0)
 .S K="" F  S K=$O(DATA(J,K)) Q:K=""!(K'="MESSAGE")
"RTN","ORKCHK5",65,0)
 .I K'="" D
"RTN","ORKCHK5",66,0)
 ..S SITE=$P(DATA(J,K),U),SEVERE=$P(DATA(J,K),U,4)
"RTN","ORKCHK5",67,0)
 ..I SEVERE'="" F ITM=1:1:$L(SEVERE,"~")  I $P($P(SEVERE,"~",ITM),"|",2)>$G(SEVERE("MSG")) S SEVERE("MSG")=$P($P(SEVERE,"~",ITM),"|",2),SEVERE("MSG","NODE")=ITM
"RTN","ORKCHK5",68,0)
 .S ORKMSG="Previous "_$S($G(SEVERE("MSG","NODE"))'="":$P(DATA(J,"MESSAGE",1,SITE,1,SEVERE("MSG","NODE")),U,2)_" ",1:"")_"adverse reaction "
"RTN","ORKCHK5",69,0)
 .;to [GMR ALLERGY]
"RTN","ORKCHK5",70,0)
 .I GMRALLER="",(REACTANT'="") S GMRALLER=REACTANT
"RTN","ORKCHK5",71,0)
 .I GMRALLER'="" S ORKMSG=ORKMSG_"to "_GMRALLER_" "
"RTN","ORKCHK5",72,0)
 .;[[REACTANT]]
"RTN","ORKCHK5",73,0)
 .S ORKMSG=ORKMSG_$S(GMRALLER'=REACTANT:"["_REACTANT_"] ",1:"")
"RTN","ORKCHK5",74,0)
 .S ORKMSG=$P(ORKMSG,"[] ")
"RTN","ORKCHK5",75,0)
 .;(based on {INGREDIENT [DRUG_INGREDIENT]|DRUG CLASS [DRUG CLASS]|REACTANT [REACTANT]})
"RTN","ORKCHK5",76,0)
 .F NODE="ING","CLS","REC"  I $D(DATA(J,"MESSAGE","OFFENDERS",NODE)) D
"RTN","ORKCHK5",77,0)
 ..S DELIMIT=", ",TEXT=""
"RTN","ORKCHK5",78,0)
 ..F ITM=1:1:$L(DATA(J,"MESSAGE","OFFENDERS",NODE),"~") D
"RTN","ORKCHK5",79,0)
 ...S:ITM=$L(DATA(J,"MESSAGE","OFFENDERS",NODE),"~") DELIMIT=" and "
"RTN","ORKCHK5",80,0)
 ...S TEXT=$S($G(TEXT)'="":TEXT_DELIMIT,1:"")_$P(DATA(J,"MESSAGE","OFFENDERS",NODE),"~",ITM)
"RTN","ORKCHK5",81,0)
 ..S TEXT(1)=$S(NODE="ING":"DRUG INGREDIENT",NODE="CLS":"DRUG CLASS",NODE="REC":"REACTANT",1:"")
"RTN","ORKCHK5",82,0)
 ..I TEXT[" and " S TEXT(1)=TEXT(1)_$S(NODE="CLS":"ES",1:"S")
"RTN","ORKCHK5",83,0)
 ..S TEXT("OUT")=$S($G(TEXT("OUT"))'="":TEXT("OUT")_"~",1:"")_TEXT(1)_" "_TEXT
"RTN","ORKCHK5",84,0)
 .S DELIMIT=", ",TEXT=""
"RTN","ORKCHK5",85,0)
 .F ITM=1:1:$L(TEXT("OUT"),"~")  D
"RTN","ORKCHK5",86,0)
 ..S:ITM=$L(TEXT("OUT"),"~") DELIMIT=" and "
"RTN","ORKCHK5",87,0)
 ..S TEXT=$S($G(TEXT)'="":TEXT_DELIMIT,1:"")_$P(TEXT("OUT"),"~",ITM)
"RTN","ORKCHK5",88,0)
 .S:$G(TEXT)'="" ORKMSG=ORKMSG_"(based on "_TEXT_") "
"RTN","ORKCHK5",89,0)
 .;resulted in [SIGNS/SYMPTOMS]
"RTN","ORKCHK5",90,0)
 .I $P(DATA(J,"MESSAGE",2),U)'="" S ORKMSG=ORKMSG_"resulted in "_$P(DATA(J,"MESSAGE",2),U)_" "
"RTN","ORKCHK5",91,0)
 .;([STATION NAME] entered on [DOCUMENTATION DATE/TIME]).
"RTN","ORKCHK5",92,0)
 .K TEXT
"RTN","ORKCHK5",93,0)
 .S DELIMIT=", ",COUNT=1,COUNT("TOTAL")=DATA(J,"MESSAGE",1)
"RTN","ORKCHK5",94,0)
 .S ITM=0 F  S ITM=$O(DATA(J,"MESSAGE",1,ITM)) Q:ITM=""  D
"RTN","ORKCHK5",95,0)
 ..S:COUNT=COUNT("TOTAL") DELIMIT=" and "
"RTN","ORKCHK5",96,0)
 ..S TEXT=$S($G(TEXT)'="":TEXT_DELIMIT,1:"")_$P(DATA(J,"MESSAGE",1,ITM),U)_" entered on "_$P(DATA(J,"MESSAGE",1,ITM),U,3)
"RTN","ORKCHK5",97,0)
 ..S COUNT=1+COUNT
"RTN","ORKCHK5",98,0)
 .S ORKMSG=ORKMSG_"("_TEXT_")."
"RTN","ORKCHK5",99,0)
 .S ORKS("ORK",ORALLRD_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_ORALLRN_U_ORALLRD_U_ORKMSG
"RTN","ORKCHK5",100,0)
 .;SAVE DATA FOR ORDER CHECK INSTANCES FILE ENTRY
"RTN","ORKCHK5",101,0)
 .S CRC16=$$CRC16^XLFCRC(ORKMSG),NUM=0
"RTN","ORKCHK5",102,0)
 .S ITM="" F  S ITM=$O(DATA(J,ITM)) Q:ITM=""  D
"RTN","ORKCHK5",103,0)
 ..Q:ITM="MESSAGE"
"RTN","ORKCHK5",104,0)
 ..S NUM=1+$G(NUM)
"RTN","ORKCHK5",105,0)
 ..K:NUM=1 ^TMP("OROCIDATA",$J,CRC16)
"RTN","ORKCHK5",106,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,.01)=$P(DATA(J,ITM),U,6)
"RTN","ORKCHK5",107,0)
 ..S:$P(DATA(J,ITM),U,7)'="" ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,2)=$P(DATA(J,ITM),U,7)
"RTN","ORKCHK5",108,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,6)=$P(DATA(J,ITM),U,2)
"RTN","ORKCHK5",109,0)
 ..S:$P(DATA(J,ITM),U,2)="R" ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,7)=$P(DATA(J,ITM),U)
"RTN","ORKCHK5",110,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,8)=$P(DATA(J,ITM),U,3)
"RTN","ORKCHK5",111,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,9)=$$UP^XLFSTR($P(DATA(J,ITM),U,8))
"RTN","ORKCHK5",112,0)
 ..S:$G(SEVERE("MSG"))'="" ^TMP("OROCIDATA",$J,CRC16,100.517,NUM,10)=SEVERE("MSG")
"RTN","ORKCHK5",113,0)
 ..F ITM(1)=1:1:$L($P(DATA(J,ITM),U,5),"~") S ^TMP("OROCIDATA",$J,CRC16,"SIGN",NUM,"+"_ITM(1)_",")=$P($P(DATA(J,ITM),U,5),"~",ITM(1))
"RTN","ORKCHK5",114,0)
 ..S FCOUNT=ITM(1)+1
"RTN","ORKCHK5",115,0)
 ..S ^TMP("OROCIDATA",$J,CRC16,100.05,84)=$P(DATA(J,ITM),U,9)
"RTN","ORKCHK5",116,0)
 ..F NODE="ING","CLS"  I $D(DATA(J,ITM,NODE)) F ITM(1)=1:1:$L(DATA(J,ITM,NODE),"~")  D
"RTN","ORKCHK5",117,0)
 ...S ^TMP("OROCIDATA",$J,CRC16,$S(NODE="ING":"INGREDIENT",NODE="CLS":"CLASS",1:""),NUM,"+"_FCOUNT_",")=$P(DATA(J,ITM,NODE),"~",ITM(1)),FCOUNT=FCOUNT+1
"RTN","ORKCHK5",118,0)
 Q
"RTN","ORKCHK5",119,0)
 ;
"RTN","ORKCHK5",120,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKCHK5",121,0)
 N PSOI
"RTN","ORKCHK5",122,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKCHK5",123,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKCHK5",124,0)
 Q:+$G(PSOI)<1
"RTN","ORKCHK5",125,0)
 D DRG^PSSUTIL1(.ORPSA,PSOI,ORPSPKG)
"RTN","ORKCHK5",126,0)
 Q
"RTN","ORKCHK5",127,0)
 ;
"RTN","ORKCHK5",128,0)
DUPOR ;duplicate orders for non-pharmacy and non-lab:
"RTN","ORKCHK5",129,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","DUPLICATE ORDER",OCN))
"RTN","ORKCHK5",130,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",131,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",132,0)
 N ORKOR S ORKOR=0
"RTN","ORKCHK5",133,0)
 D DUP^ORKOR(.ORKOR,ORKDFN,OI,ODT,ORKDG) I (ORKOR>0) D
"RTN","ORKCHK5",134,0)
 .S ORKOCNUM=+$P(ORKOR,U)
"RTN","ORKCHK5",135,0)
 .S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",136,0)
 .S ORKMSG="Duplicate order: "_$P(ORKOR,U,2)
"RTN","ORKCHK5",137,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_ORKOCNUM_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG_U_ORKOCNUM
"RTN","ORKCHK5",138,0)
 Q
"RTN","ORKCHK5",139,0)
 ;
"RTN","ORKCHK5",140,0)
DUPLAB ;duplicate laboratory orders:
"RTN","ORKCHK5",141,0)
 N ORKLR,OCI
"RTN","ORKCHK5",142,0)
 S ORKLR=0,OCI=""
"RTN","ORKCHK5",143,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","DUPLICATE ORDER",OCN))
"RTN","ORKCHK5",144,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",145,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",146,0)
 S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",147,0)
 D DUP^ORKLR(.ORKLR,OI,ORKDFN,ODT,ORKPDATA)
"RTN","ORKCHK5",148,0)
 F  S OCI=$O(ORKLR(OCI)) Q:OCI=""  D
"RTN","ORKCHK5",149,0)
 .S ORKOCNUM=+$P(ORKLR(OCI),U)
"RTN","ORKCHK5",150,0)
 .S ORKMSG="Duplicate order: "_$P(ORKLR(OCI),U,2)
"RTN","ORKCHK5",151,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_ORKOCNUM_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG_U_ORKOCNUM
"RTN","ORKCHK5",152,0)
 Q
"RTN","ORKCHK5",153,0)
 ;
"RTN","ORKCHK5",154,0)
LABFREQ ;lab order frequency restrictions:
"RTN","ORKCHK5",155,0)
 N ORKLR,OCI
"RTN","ORKCHK5",156,0)
 S ORKLR=0,OCI=""
"RTN","ORKCHK5",157,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","LAB ORDER FREQ RESTRICTIONS",OCN))
"RTN","ORKCHK5",158,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",159,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",160,0)
 S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",161,0)
 D ORFREQ^ORKLR2(.ORKLR,OI,ORKDFN_";DPT(",ODT,ORKPDATA)
"RTN","ORKCHK5",162,0)
 S OCI="" F  S OCI=$O(ORKLR(OCI)) Q:OCI=""  D
"RTN","ORKCHK5",163,0)
 .S ORKMSG=$P(ORKLR(OCI),U,2)
"RTN","ORKCHK5",164,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG
"RTN","ORKCHK5",165,0)
 Q
"RTN","ORKCHK5",166,0)
 ;
"RTN","ORKCHK5",167,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK5",168,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK5",169,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK5",170,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK5",171,0)
 Q
"RTN","ORKCHK5",172,0)
REMCHK(ORRET,OROI,ORDFN) ; DO REMINDER ORDER CHECKS
"RTN","ORKCHK5",173,0)
 ;
"RTN","ORKCHK5",174,0)
 N ORKGLOB S ORKGLOB=$H
"RTN","ORKCHK5",175,0)
 ;order check for TEST OC for this OI
"RTN","ORKCHK5",176,0)
 N ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",177,0)
 D PARAMS("CLINICAL REMINDER TEST",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",178,0)
 I ORKFLAG'="D" D
"RTN","ORKCHK5",179,0)
 .D ORDERCHK^PXRMORCH(ORDFN,OROI,1,0,0)
"RTN","ORKCHK5",180,0)
 .Q:'$D(^TMP($J,OROI))
"RTN","ORKCHK5",181,0)
 .N ORCDL S ORCDL="" F  S ORCDL=$O(^TMP($J,OROI,ORCDL)) Q:'$L(ORCDL)  S ORKDNGR=$S(ORCDL="H":1,ORCDL="M":2,1:3) D
"RTN","ORKCHK5",182,0)
 ..N ORRULE S ORRULE="" F  S ORRULE=$O(^TMP($J,OROI,ORCDL,ORRULE)) Q:'$L(ORRULE)  D
"RTN","ORKCHK5",183,0)
 ...S ORRET("ORK",ORCDL_","_$G(ORNUM)_","_ORKNUM_","_ORRULE)=ORNUM_U_ORKNUM_U_ORCDL_U_"||"_ORKGLOB_"&"_ORRULE
"RTN","ORKCHK5",184,0)
 ...M ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORRULE)=^TMP($J,OROI,ORCDL,ORRULE)
"RTN","ORKCHK5",185,0)
 .K ^TMP($J,OROI)
"RTN","ORKCHK5",186,0)
 ;order checks for LIVE OC for this OI
"RTN","ORKCHK5",187,0)
 K ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",188,0)
 D PARAMS("CLINICAL REMINDER LIVE",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",189,0)
 Q:ORKFLAG="D"
"RTN","ORKCHK5",190,0)
 D ORDERCHK^PXRMORCH(ORDFN,OROI,0,0,0)
"RTN","ORKCHK5",191,0)
 Q:'$D(^TMP($J,OROI))
"RTN","ORKCHK5",192,0)
 N ORCDL S ORCDL="" F  S ORCDL=$O(^TMP($J,OROI,ORCDL)) Q:'$L(ORCDL)  S ORKDNGR=$S(ORCDL="H":1,ORCDL="M":2,1:3) D
"RTN","ORKCHK5",193,0)
 .N ORRULE S ORRULE="" F  S ORRULE=$O(^TMP($J,OROI,ORCDL,ORRULE)) Q:'$L(ORRULE)  D
"RTN","ORKCHK5",194,0)
 ..S ORRET("ORK",ORCDL_","_$G(ORNUM)_","_ORKNUM_","_ORRULE)=ORNUM_U_ORKNUM_U_ORCDL_U_"||"_ORKGLOB_"&"_ORRULE
"RTN","ORKCHK5",195,0)
 ..M ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORRULE)=^TMP($J,OROI,ORCDL,ORRULE)
"RTN","ORKCHK5",196,0)
 K ^TMP($J,OROI)
"RTN","ORKCHK5",197,0)
 Q
"RTN","ORKCHK5",198,0)
 ;
"RTN","ORKCHK5",199,0)
DSGCHK(ORRET,ORDFN,OROIL,ORKA) ;DO DOSAGE ORDER CHECKS
"RTN","ORKCHK5",200,0)
 Q:'$$PATCH^XPDUTL("PSS*1.0*117")
"RTN","ORKCHK5",201,0)
 Q:$G(XQY0)="OR BCMA ORDER COM"
"RTN","ORKCHK5",202,0)
 N ORTYPE,ORY,ORI,ORKNUM,ORKFLAG,ORKDNGR
"RTN","ORKCHK5",203,0)
 D PARAMS("DRUG DOSAGE",.ORKNUM,.ORKFLAG,.ORKDNGR)
"RTN","ORKCHK5",204,0)
 Q:ORKFLAG="D"  ;this checks if the order check is turned on or not
"RTN","ORKCHK5",205,0)
 I '$$DS^PSSDSAPI D  Q
"RTN","ORKCHK5",206,0)
 .N ORDWNMSG S ORDWNMSG=$$DSDWNMSG^ORDSGCHK
"RTN","ORKCHK5",207,0)
 .S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_ORDWNMSG)=ORNUM_U_25_U_2_ORDWNMSG
"RTN","ORKCHK5",208,0)
 S ORTYPE=$P(ORKA,"|",2)
"RTN","ORKCHK5",209,0)
 D EN^ORDSGCHK(.ORY,ORDFN,ORTYPE,.OROIL)
"RTN","ORKCHK5",210,0)
 N ORI S ORI=0 F  S ORI=$O(ORY(ORI)) Q:'ORI  D
"RTN","ORKCHK5",211,0)
 .I $P(ORY(ORI),U)="ERR" S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_$E($P(ORY(ORI),U,2),1,225))=ORNUM_U_25_U_2_U_$P(ORY(ORI),U,2)
"RTN","ORKCHK5",212,0)
 .I $P(ORY(ORI),U)="DS" S ORRET("ORK",ORKDNGR_","_$G(ORNUM)_","_$E($P(ORY(ORI),U,2),1,225))=ORNUM_U_ORKNUM_U_ORKDNGR_U_$P(ORY(ORI),U,2)
"RTN","ORKCHK5",213,0)
 Q
"RTN","ORKCHK6")
0^2^B28204591
"RTN","ORKCHK6",1,0)
ORKCHK6 ; SLC/CLA - Support routine called by ORKCHK to do SESSION mode order checks ;08/18/14  08:37
"RTN","ORKCHK6",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,87,94,123,162,190,249,280,272,346,345,269**;Dec 17, 1997;Build 85
"RTN","ORKCHK6",3,0)
 Q
"RTN","ORKCHK6",4,0)
 ;
"RTN","ORKCHK6",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE) ;perform order checking for entire ordering session
"RTN","ORKCHK6",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK6",7,0)
 ;
"RTN","ORKCHK6",8,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK6",9,0)
 N ORKMSG,ORKDGI,ORKTXT,ORKPDATA,ORIFN
"RTN","ORKCHK6",10,0)
 ;
"RTN","ORKCHK6",11,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK6",12,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK6",13,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK6",14,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK6",15,0)
 S ORIFN=ORNUM
"RTN","ORKCHK6",16,0)
 ;
"RTN","ORKCHK6",17,0)
 S:ORKDG="PSJ" ORKDG="PSI"
"RTN","ORKCHK6",18,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK6",19,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",20,0)
 Q
"RTN","ORKCHK6",21,0)
 ;
"RTN","ORKCHK6",22,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK6",23,0)
 N ORPSPKG,ORPSA,ORRXDONE
"RTN","ORKCHK6",24,0)
 N ORCRITN,ORCRITF,ORCRITD,ORSIGN,ORSIGF,ORSIGD,ORDUPN,ORDUPF,ORDUPD,ORDUPC,ORDUPCF,ORDUPCD,ORALLRN,ORALLRF,ORALLRD,ORDUPCN
"RTN","ORKCHK6",25,0)
 ;
"RTN","ORKCHK6",26,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK6",27,0)
 D PARAMS("CRITICAL DRUG INTERACTION",.ORCRITN,.ORCRITF,.ORCRITD)
"RTN","ORKCHK6",28,0)
 D PARAMS("SIGNIFICANT DRUG INTERACTION",.ORSIGN,.ORSIGF,.ORSIGD)
"RTN","ORKCHK6",29,0)
 D PARAMS("DUPLICATE DRUG ORDER",.ORDUPN,.ORDUPF,.ORDUPD)
"RTN","ORKCHK6",30,0)
 D PARAMS("DUPLICATE DRUG THERAPY",.ORDUPCN,.ORDUPCF,.ORDUPCD)
"RTN","ORKCHK6",31,0)
 ;
"RTN","ORKCHK6",32,0)
 S ORRXDONE=0 ;flag to set if RXOCS gets called
"RTN","ORKCHK6",33,0)
 ;dispense drug selected:
"RTN","ORKCHK6",34,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",35,0)
 .D RXOCS
"RTN","ORKCHK6",36,0)
 .S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK6",37,0)
 .S ORRXDONE=1
"RTN","ORKCHK6",38,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",39,0)
 ;
"RTN","ORKCHK6",40,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK6",41,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK6",42,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK6",43,0)
 .I "IOH"[ORPSPKG D
"RTN","ORKCHK6",44,0)
 ..S ORPSA=$$OI2DD^ORKPS(OI,ORPSPKG,1)
"RTN","ORKCHK6",45,0)
 ..I +ORPSA D
"RTN","ORKCHK6",46,0)
 ...S HL7LTXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",47,0)
 ...S HL7NPTR=$P(ORPSA,";",2)
"RTN","ORKCHK6",48,0)
 ...S HL7LPTR=+ORPSA
"RTN","ORKCHK6",49,0)
 ...S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK6",50,0)
 ...S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK6",51,0)
 ...S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK6",52,0)
 ...S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK6",53,0)
 ..D RXOCS
"RTN","ORKCHK6",54,0)
 ..S:$P(ORKA,"|",7)'="" $P(ORKA,"|",7)=""
"RTN","ORKCHK6",55,0)
 ..S ORRXDONE=1
"RTN","ORKCHK6",56,0)
 ..Q:HL7LTXT=""
"RTN","ORKCHK6",57,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",58,0)
 I ORRXDONE=0 D
"RTN","ORKCHK6",59,0)
 .N ORKSMSG,OROITXT
"RTN","ORKCHK6",60,0)
 .S OROITXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",61,0)
 .I $L(OROITXT)>0 S OROITXT=" for "_$$TRIM^XLFSTR(OROITXT)
"RTN","ORKCHK6",62,0)
 .S ORKMSG="Enhanced order checks cannot be done"_OROITXT_". Please perform a manual check for Drug-Interactions, Duplicate Therapy"
"RTN","ORKCHK6",63,0)
 .I $$DS^PSSDSAPI S ORKMSG=ORKMSG_" and Dosing"
"RTN","ORKCHK6",64,0)
 .S ORKS("ORK",2_$E(ORKMSG,1,225))=ORNUM_U_25_U_3_U_ORKMSG
"RTN","ORKCHK6",65,0)
 Q
"RTN","ORKCHK6",66,0)
 ;
"RTN","ORKCHK6",67,0)
RXOCS ;drug-drug interaction, duplicate drug order, duplicate drug class
"RTN","ORKCHK6",68,0)
 Q:ORCRITF_ORSIGF_ORDUPF_ORDUPCF_ORALLRF'["E"  ;quit if none are "E"nabled
"RTN","ORKCHK6",69,0)
 N ORKRX,ORPSNUM,ORY,CHK,XX
"RTN","ORKCHK6",70,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",71,0)
 .D CHKSESS^ORKPS(.ORKRX,ORKDFN,HL7LPTR_U_HL7LTXT,OI,ORKPDATA,ORKDG,+$P($G(ORPSA),";",4),$P(ORKA,"|",7))
"RTN","ORKCHK6",72,0)
 .S CHK=0,XX="" F  S CHK=$O(ORKRX(CHK)) Q:'CHK  D
"RTN","ORKCHK6",73,0)
 ..S XX=ORKRX(CHK)
"RTN","ORKCHK6",74,0)
 ..;
"RTN","ORKCHK6",75,0)
 ..;get errors/exceptions/checks not done
"RTN","ORKCHK6",76,0)
 ..I $P(XX,U)="ERR" S ORKS("ORK",2_$E($P(XX,U,2),1,225)_","_$G(ORNUM))=ORNUM_U_25_U_3_U_$P(XX,U,2)
"RTN","ORKCHK6",77,0)
 ..;
"RTN","ORKCHK6",78,0)
 ..;critical drug interaction:
"RTN","ORKCHK6",79,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="CRITICAL" D
"RTN","ORKCHK6",80,0)
 ...Q:ORCRITF="D"
"RTN","ORKCHK6",81,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",82,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",83,0)
 ...S ORKS("ORK",ORCRITD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORCRITN_U_ORCRITD_U_ORKTXT
"RTN","ORKCHK6",84,0)
 ..;
"RTN","ORKCHK6",85,0)
 ..;significant drug interaction:
"RTN","ORKCHK6",86,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="SIGNIFICANT" D
"RTN","ORKCHK6",87,0)
 ...Q:ORSIGF="D"
"RTN","ORKCHK6",88,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",89,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",90,0)
 ...S ORKS("ORK",ORSIGD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKTXT,1,225))=ORNUM_U_ORSIGN_U_ORSIGD_U_ORKTXT
"RTN","ORKCHK6",91,0)
 ..;
"RTN","ORKCHK6",92,0)
 ..;duplicate drug:
"RTN","ORKCHK6",93,0)
 ..I $P(XX,U)="DD" D
"RTN","ORKCHK6",94,0)
 ...Q:ORDUPF="D"
"RTN","ORKCHK6",95,0)
 ...S ORPSNUM=$P(XX,U,4)  ;get the associated order number
"RTN","ORKCHK6",96,0)
 ...S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK6",97,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) D
"RTN","ORKCHK6",98,0)
 ....D TEXT^ORQ12(.ORY,ORPSNUM,"")
"RTN","ORKCHK6",99,0)
 ....S ORKTXT=ORKTXT_$S($D(ORY(2))=1:" "_$$TRIM^XLFSTR(ORY(2)),1:"")_" ["_$P($G(^ORD(100.01,+$P(^OR(100,+ORPSNUM,3),U,3),0)),U,1)_"]"
"RTN","ORKCHK6",100,0)
 ...S ORKMSG="Duplicate drug order: "_ORKTXT
"RTN","ORKCHK6",101,0)
 ...S ORKS("ORK",ORDUPD_","_$G(ORNUM)_","_ORPSNUM_",Duplicate drug order: "_$E($P(XX,U,3),1,200))=ORNUM_U_ORDUPN_U_ORDUPD_U_ORKMSG_U_$G(ORPSNUM)
"RTN","ORKCHK6",102,0)
 ..;
"RTN","ORKCHK6",103,0)
 ..;duplicate class: NOW DRUG THERAPY
"RTN","ORKCHK6",104,0)
 ..I $P(XX,U)="DC" D
"RTN","ORKCHK6",105,0)
 ...Q:ORDUPCF="D"
"RTN","ORKCHK6",106,0)
 ...S ORPSNUM=$P(XX,U,2)  ;get the associated order number
"RTN","ORKCHK6",107,0)
 ...S ORKMSG=$P(XX,U,4)
"RTN","ORKCHK6",108,0)
 ...S ORKS("ORK",ORDUPCD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORDUPCN_U_ORDUPCD_U_ORKMSG
"RTN","ORKCHK6",109,0)
 D RXOCS^ORKCHK5
"RTN","ORKCHK6",110,0)
 Q
"RTN","ORKCHK6",111,0)
 ;
"RTN","ORKCHK6",112,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK6",113,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK6",114,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK6",115,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK6",116,0)
 Q
"RTN","OROCAPI1")
0^3^B59785777
"RTN","OROCAPI1",1,0)
OROCAPI1 ;SLC/JMH - ORDER CHECK INSTANCES FILE APIS; 02/04/2015  12:18
"RTN","OROCAPI1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**293,346,345,269**;Dec 17, 1997;Build 85
"RTN","OROCAPI1",3,0)
SAVEOC(ORL,RET) ;SAVE A GROUP OF ORDER CHECKS
"RTN","OROCAPI1",4,0)
 ;ORL=LIST OF ORDER CHECKS
"RTN","OROCAPI1",5,0)
 ;(D0,1)=ORDER NUMBER (FILE 100)^
"RTN","OROCAPI1",6,0)
 ;       OCCURANCE DESCRIPTOR^
"RTN","OROCAPI1",7,0)
 ;       USER (FILE 200)^
"RTN","OROCAPI1",8,0)
 ;       OCCURANCE D/T^
"RTN","OROCAPI1",9,0)
 ;       ORDER CHECK NUMBER (FILE 100.8)^
"RTN","OROCAPI1",10,0)
 ;       CLINICAL DANGER LEVEL
"RTN","OROCAPI1",11,0)
 ;   (D0,2,D1)=ORDER CHECK NARRATIVE
"RTN","OROCAPI1",12,0)
 ;   (D0,3)=OVERRIDE REASON
"RTN","OROCAPI1",13,0)
 ;RET=RETURN ARRAY OF IENS BY ORL(D0)
"RTN","OROCAPI1",14,0)
 ;    RET(D0,IEN)=""
"RTN","OROCAPI1",15,0)
 N I S I=0 F  S I=$O(ORL(I)) Q:'I  D
"RTN","OROCAPI1",16,0)
 .N DA,DR,DIC,X,Y,DIE,ORSTATUS,ORN,ORDANG,DW,DV,%,D,DC,DE,DH,DI,DIEL,DIFLD,DIP,DK,DM,DP,DQ,ORKMSG,DTOUT
"RTN","OROCAPI1",17,0)
 .N ORFDART,ORIENRT,ORMSGRT,J,ERROR,IEN
"RTN","OROCAPI1",18,0)
 .S ORN=+ORL(I,1)
"RTN","OROCAPI1",19,0)
 .Q:'ORN!('$D(^OR(100,ORN)))
"RTN","OROCAPI1",20,0)
 .Q:'$P(ORL(I,1),U,5)  ;QUIT IF NO ORDER CHECK NUMBER
"RTN","OROCAPI1",21,0)
 .Q:'$D(ORL(I,2))  ;QUIT IF NO ORDER CHECK TEXT
"RTN","OROCAPI1",22,0)
 .I $G(FLDS("ORDUZ"))]"" S $P(ORL(I,1),"^",3)=$G(FLDS("ORDUZ"))
"RTN","OROCAPI1",23,0)
 .K ^TMP("DIERR",$J)
"RTN","OROCAPI1",24,0)
 .S ORFDART(100.05,"+1,",.01)=ORN
"RTN","OROCAPI1",25,0)
 .D UPDATE^DIE("","ORFDART","ORIENRT","ORMSGRT")
"RTN","OROCAPI1",26,0)
 .I $D(ORIENRT(1)) S DA=ORIENRT(1)
"RTN","OROCAPI1",27,0)
 .Q:'$G(DA)
"RTN","OROCAPI1",28,0)
 .S RET(I,DA)=""
"RTN","OROCAPI1",29,0)
 .S DIC="^ORD(100.05,",DIC(0)="F",X=ORN
"RTN","OROCAPI1",30,0)
 .S DIE=DIC,ORSTATUS=$P($G(^OR(100,ORN,3)),U,3),ORDANG=$S($P($G(ORL(I,1)),U,6):$P($G(ORL(I,1)),U,6),1:$$GET^XPAR("ALL","ORK CLINICAL DANGER LEVEL",$P($G(ORL(I,1)),U,5),"I"))
"RTN","OROCAPI1",31,0)
 .S DR="1////"_ORSTATUS_";2////"_$P($G(ORL(I,1)),U,2)_";3////"_$P($G(ORL(I,1)),U,3)_";4////"_$P($G(ORL(I,1)),U,4)_";5////"_$P($G(ORL(I,1)),U,5)_";6////"_ORDANG_";7///"_$TR($G(ORL(I,3)),";",",")
"RTN","OROCAPI1",32,0)
 .D ^DIE
"RTN","OROCAPI1",33,0)
 .D WP^DIE(100.05,DA_",",8,,"ORL("_I_",2)","ERROR")
"RTN","OROCAPI1",34,0)
 .S J=0 F  S J=$O(ORL(I,2,J)) Q:'J  S ORKMSG=$G(ORKMSG)_ORL(I,2,J)
"RTN","OROCAPI1",35,0)
 .;SAVE ALLERGY DATA IF IT EXISTS
"RTN","OROCAPI1",36,0)
 .N CRC16,ORDA
"RTN","OROCAPI1",37,0)
 .S CRC16=$$CRC16^XLFCRC(ORKMSG),ORDA=DA
"RTN","OROCAPI1",38,0)
 .I $D(^TMP("OROCIDATA",$J,CRC16)) D
"RTN","OROCAPI1",39,0)
 ..N FDA,CLASS,ING,SIGN,ERROR,NUM
"RTN","OROCAPI1",40,0)
 ..S FDA(100.05,ORDA_",",84)=$G(^TMP("OROCIDATA",$J,CRC16,100.05,84))
"RTN","OROCAPI1",41,0)
 ..D FILE^DIE("K","FDA","ERROR")
"RTN","OROCAPI1",42,0)
 ..S NUM=0 F  S NUM=$O(^TMP("OROCIDATA",$J,CRC16,100.517,NUM)) Q:'NUM  D
"RTN","OROCAPI1",43,0)
 ...M FDA(100.517,"+1,"_ORDA_",")=^TMP("OROCIDATA",$J,CRC16,100.517,NUM)
"RTN","OROCAPI1",44,0)
 ...D:$D(FDA) UPDATE^DIE(,"FDA","IEN","ERROR")
"RTN","OROCAPI1",45,0)
 ...S CLASS="" F  S CLASS=$O(^TMP("OROCIDATA",$J,CRC16,"CLASS",NUM,CLASS)) Q:$G(CLASS)=""  D
"RTN","OROCAPI1",46,0)
 ....S FDA(100.5173,CLASS_IEN(1)_","_ORDA_",",.01)=^TMP("OROCIDATA",$J,CRC16,"CLASS",NUM,CLASS)
"RTN","OROCAPI1",47,0)
 ...S ING="" F  S ING=$O(^TMP("OROCIDATA",$J,CRC16,"INGREDIENT",NUM,ING)) Q:$G(ING)=""  D
"RTN","OROCAPI1",48,0)
 ....S FDA(100.5174,ING_IEN(1)_","_ORDA_",",.01)=^TMP("OROCIDATA",$J,CRC16,"INGREDIENT",NUM,ING)
"RTN","OROCAPI1",49,0)
 ...S SIGN="" F  S SIGN=$O(^TMP("OROCIDATA",$J,CRC16,"SIGN",NUM,SIGN)) Q:$G(SIGN)=""  D
"RTN","OROCAPI1",50,0)
 ....S FDA(100.5175,SIGN_IEN(1)_","_ORDA_",",.01)=^TMP("OROCIDATA",$J,CRC16,"SIGN",NUM,SIGN)
"RTN","OROCAPI1",51,0)
 ...D:$D(FDA) UPDATE^DIE(,"FDA",,"ERROR")
"RTN","OROCAPI1",52,0)
 ...K FDA,IEN
"RTN","OROCAPI1",53,0)
 ..K ^TMP("OROCIDATA",$J,CRC16)
"RTN","OROCAPI1",54,0)
 Q
"RTN","OROCAPI1",55,0)
GETOC1(IEN,RET) ;GET A SINGLE ORDER CHECK
"RTN","OROCAPI1",56,0)
 ;IEN = 100.05 IEN
"RTN","OROCAPI1",57,0)
 ;RET = RETURNED 100.05 DATA FOR IEN
"RTN","OROCAPI1",58,0)
 K RET
"RTN","OROCAPI1",59,0)
 Q:'$G(IEN)
"RTN","OROCAPI1",60,0)
 Q:'$D(^ORD(100.05,IEN))
"RTN","OROCAPI1",61,0)
 S RET(IEN,0)=$G(^ORD(100.05,IEN,0))
"RTN","OROCAPI1",62,0)
 S RET(IEN,1)=$G(^ORD(100.05,IEN,1))
"RTN","OROCAPI1",63,0)
 S $P(RET(IEN,1),U,1)=$P(^ORD(100.8,$P(RET(IEN,1),U,1),0),U,1)_";"_$P(RET(IEN,1),U,1)
"RTN","OROCAPI1",64,0)
 M RET(IEN,"OC")=^ORD(100.05,IEN,2)
"RTN","OROCAPI1",65,0)
 K RET(IEN,"OC",0)
"RTN","OROCAPI1",66,0)
 M RET(IEN,"OR")=^ORD(100.05,IEN,3)
"RTN","OROCAPI1",67,0)
 K RET(IEN,"OR",0)
"RTN","OROCAPI1",68,0)
 M RET(IEN,"OI")=^OR(100,$P(RET(IEN,0),U,1),.1)
"RTN","OROCAPI1",69,0)
 N OIEN
"RTN","OROCAPI1",70,0)
 S OIEN="" F  S OIEN=$O(RET(IEN,"OI",OIEN)) Q:$G(OIEN)=""  D
"RTN","OROCAPI1",71,0)
 .I +OIEN=0 K RET(IEN,"OI",OIEN) Q
"RTN","OROCAPI1",72,0)
 .S RET(IEN,"OI",OIEN,0)=$P(^ORD(101.43,RET(IEN,"OI",OIEN,0),0),U,1,2)
"RTN","OROCAPI1",73,0)
 Q
"RTN","OROCAPI1",74,0)
GETOC2(ORD,RET) ;GET ALL 100.05 IENS FOR A SPECIFIC ORDER
"RTN","OROCAPI1",75,0)
 ;ORD = 100 IEN
"RTN","OROCAPI1",76,0)
 ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",77,0)
 K RET
"RTN","OROCAPI1",78,0)
 Q:'$G(ORD)
"RTN","OROCAPI1",79,0)
 N I S I=0 F  S I=$O(^ORD(100.05,"B",ORD,I)) Q:'I  S RET(ORD,I)=""
"RTN","OROCAPI1",80,0)
 Q
"RTN","OROCAPI1",81,0)
GETOC3(ORD,OCC,RET) ;GET ALL 100.05 IENS FOR A SPECIFIC ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",82,0)
 ;ORD = 100 IEN
"RTN","OROCAPI1",83,0)
 ;OCC = OCCURANCE STRING
"RTN","OROCAPI1",84,0)
 ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",85,0)
 K RET
"RTN","OROCAPI1",86,0)
 Q:'$G(ORD)
"RTN","OROCAPI1",87,0)
 Q:'$L(OCC)
"RTN","OROCAPI1",88,0)
 N I S I=0 F  S I=$O(^ORD(100.05,"C",ORD,OCC,I)) Q:'I  S RET(ORD,I)=""
"RTN","OROCAPI1",89,0)
 Q
"RTN","OROCAPI1",90,0)
GETOC4(ORD,RET) ;GET DATA FOR ALL 100.05 RECORDS OF A SPECIFIC ORDER
"RTN","OROCAPI1",91,0)
 ;ORD = 100 IEN
"RTN","OROCAPI1",92,0)
 ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",93,0)
 K RET
"RTN","OROCAPI1",94,0)
 Q:'$G(ORD)
"RTN","OROCAPI1",95,0)
 N RET2
"RTN","OROCAPI1",96,0)
 D GETOC2(ORD,.RET)
"RTN","OROCAPI1",97,0)
 Q:'$D(RET)
"RTN","OROCAPI1",98,0)
 N I S I=0 F  S I=$O(RET(ORD,I)) Q:'I  D
"RTN","OROCAPI1",99,0)
 .D GETOC1(I,.RET2)
"RTN","OROCAPI1",100,0)
 .I '$D(RET(ORD,"OI")) M RET(ORD,"OI")=RET2(I,"OI")
"RTN","OROCAPI1",101,0)
 .K RET2(I,"OI")
"RTN","OROCAPI1",102,0)
 .M RET(ORD,"DATA")=RET2
"RTN","OROCAPI1",103,0)
 Q
"RTN","OROCAPI1",104,0)
GETOC5(ORD,OCC,RET) ;GET DATA FOR ALL 100.05 RECORDS OF A SPECIFIC ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",105,0)
 ;ORD = 100 IEN
"RTN","OROCAPI1",106,0)
 ;OCC = OCCURANCE STRING
"RTN","OROCAPI1",107,0)
 ;RET = LIST OF 100.05 IENS WITH DATA
"RTN","OROCAPI1",108,0)
 K RET
"RTN","OROCAPI1",109,0)
 Q:'$G(ORD)
"RTN","OROCAPI1",110,0)
 Q:'$L(OCC)
"RTN","OROCAPI1",111,0)
 N RET2
"RTN","OROCAPI1",112,0)
 D GETOC3(ORD,OCC,.RET)
"RTN","OROCAPI1",113,0)
 Q:'$D(RET)
"RTN","OROCAPI1",114,0)
 N I S I=0 F  S I=$O(RET(ORD,I)) Q:'I  D
"RTN","OROCAPI1",115,0)
 .D GETOC1(I,.RET2)
"RTN","OROCAPI1",116,0)
 .I '$D(RET(ORD,"OI")) M RET(ORD,"OI")=RET2(I,"OI")
"RTN","OROCAPI1",117,0)
 .K RET2(I,"OI")
"RTN","OROCAPI1",118,0)
 .M RET(ORD,"DATA")=RET2
"RTN","OROCAPI1",119,0)
 Q
"RTN","OROCAPI1",120,0)
CONVERT ;CONVERT EXISTING FILE 100 NODE 9 ENTRIES OVER TO FILE 100.05
"RTN","OROCAPI1",121,0)
 N I,J,ORK,DESC
"RTN","OROCAPI1",122,0)
 S I=0
"RTN","OROCAPI1",123,0)
 I $G(^XTMP("ORK FILE CONVERSION")) S I=+^XTMP("ORK FILE CONVERSION")
"RTN","OROCAPI1",124,0)
 F  S I=$O(^OR(100,I)) Q:'I  I $D(^OR(100,I,9)) I '$D(^ORD(100.05,"B",I)) D CONVERT1(I)
"RTN","OROCAPI1",125,0)
 S I=0
"RTN","OROCAPI1",126,0)
 F  S I=$O(^XTMP("ORK FILE CONVERSION","ERRORS",I)) Q:'I  D DELETE(I)
"RTN","OROCAPI1",127,0)
 K ^XTMP("ORK FILE CONVERSION","LAST ERRORS")
"RTN","OROCAPI1",128,0)
 M ^XTMP("ORK FILE CONVERSION","LAST ERRORS")=^XTMP("ORK FILE CONVERSION","ERRORS")
"RTN","OROCAPI1",129,0)
 K ^XTMP("ORK FILE CONVERSION","ERRORS")
"RTN","OROCAPI1",130,0)
 S ^XTMP("ORK FILE CONVERSION")=0
"RTN","OROCAPI1",131,0)
 D MAIL
"RTN","OROCAPI1",132,0)
 Q
"RTN","OROCAPI1",133,0)
CONVERT1(I) ;CONVERT EXISTING FILE 100 NODE 9 ENTRIES OVER TO FILE 100.05 FOR 1 ORDER
"RTN","OROCAPI1",134,0)
 N $ETRAP,$ESTACK
"RTN","OROCAPI1",135,0)
 S $ETRAP="D ERR^OROCAPI1 Q"
"RTN","OROCAPI1",136,0)
 N J,ORK,DESC,RET
"RTN","OROCAPI1",137,0)
 S DESC="SIGNATURE_CPRS"
"RTN","OROCAPI1",138,0)
 S ^XTMP("ORK FILE CONVERSION",0)=$$FMADD^XLFDT($$NOW^XLFDT,90)_U_$$NOW^XLFDT
"RTN","OROCAPI1",139,0)
 I ",11,13,14,"[(","_$P($G(^OR(100,I,3)),U,3)_",") S DESC="ACCEPTANCE_CPRS"
"RTN","OROCAPI1",140,0)
 S J=0 F  S J=$O(^OR(100,I,9,J)) Q:'J  D
"RTN","OROCAPI1",141,0)
 .N X0,X1 S X0=$G(^OR(100,I,9,J,0)),X1=$G(^OR(100,I,9,J,1))
"RTN","OROCAPI1",142,0)
 .N ORKDT S ORKDT=$S($P(X0,U,6):$P(X0,U,6),1:$P($G(^OR(100,I,0)),U,7))
"RTN","OROCAPI1",143,0)
 .S ORK(J,1)=I_U_DESC_U_$P(X0,U,5)_U_ORKDT_U_$P(X0,U)
"RTN","OROCAPI1",144,0)
 .S ORK(J,2)=X1
"RTN","OROCAPI1",145,0)
 .S ORK(J,3)=$P(X0,U,4)
"RTN","OROCAPI1",146,0)
 I $D(ORK) D SAVEOC^OROCAPI1(.ORK,.RET)
"RTN","OROCAPI1",147,0)
 S ^XTMP("ORK FILE CONVERSION")=I
"RTN","OROCAPI1",148,0)
 Q
"RTN","OROCAPI1",149,0)
COPY(ORD1,ORD2) ;COPY THE ORDER CHECKS FROM ORDER 1 TO ORDER 2
"RTN","OROCAPI1",150,0)
 N RET,I,DIC,DIK
"RTN","OROCAPI1",151,0)
 D GETOC2(ORD1,.RET)
"RTN","OROCAPI1",152,0)
 S DIC="^ORD(100.05,",DIC(0)="F",DIK=DIC
"RTN","OROCAPI1",153,0)
 S I=0 F  S I=$O(RET(ORD1,I)) Q:+$G(I)=0  D
"RTN","OROCAPI1",154,0)
 .;CREATE THE NEW ENTRY
"RTN","OROCAPI1",155,0)
 .N X,DO,Y,DTOUT,DUOUT,DA
"RTN","OROCAPI1",156,0)
 .S X=ORD2 D FILE^DICN
"RTN","OROCAPI1",157,0)
 .Q:'DA
"RTN","OROCAPI1",158,0)
 .;COPY EXISTING DATA
"RTN","OROCAPI1",159,0)
 .K ^TMP($J,"OROCAPI1")
"RTN","OROCAPI1",160,0)
 .M ^TMP($J,"OROCAPI1")=^ORD(100.05,I)
"RTN","OROCAPI1",161,0)
 .S $P(^TMP($J,"OROCAPI1",0),U,1)=ORD2
"RTN","OROCAPI1",162,0)
 .M ^ORD(100.05,DA)=^TMP($J,"OROCAPI1")
"RTN","OROCAPI1",163,0)
 .;UPDATE CROSS-REFERENCES
"RTN","OROCAPI1",164,0)
 .D IX1^DIK
"RTN","OROCAPI1",165,0)
 K ^TMP($J,"OROCAPI1")
"RTN","OROCAPI1",166,0)
 Q
"RTN","OROCAPI1",167,0)
OCCNT(ORD) ;RETURN 1 IF THERE ARE ORDER CHECKS AND 0 IF NOT
"RTN","OROCAPI1",168,0)
 N RET,Y D GETOC2(ORD,.RET)
"RTN","OROCAPI1",169,0)
 S Y=0 I $D(RET) S Y=1
"RTN","OROCAPI1",170,0)
 Q Y
"RTN","OROCAPI1",171,0)
DELETE(ORD) ;DELETE ALL OF THE OC INSTANCES FOR AN ORDER
"RTN","OROCAPI1",172,0)
 N RET,I,DIK,DA D GETOC2(ORD,.RET)
"RTN","OROCAPI1",173,0)
 S I=0 F  S I=$O(RET(ORD,I)) Q:'I  S DA=I,DIK="^ORD(100.05," D ^DIK
"RTN","OROCAPI1",174,0)
 Q
"RTN","OROCAPI1",175,0)
DELOCC(ORD,OCC) ;DELETE ALL OF THE OC INSTANCES FOR AN ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",176,0)
 N RET,I,DIK,DA D GETOC3(ORD,OCC,.RET)
"RTN","OROCAPI1",177,0)
 S I=0 F  S I=$O(RET(ORD,I)) Q:'I  S DA=I,DIK="^ORD(100.05," D ^DIK
"RTN","OROCAPI1",178,0)
 Q
"RTN","OROCAPI1",179,0)
ERR ;
"RTN","OROCAPI1",180,0)
 S ^XTMP("ORK FILE CONVERSION","ERRORS",ORN)=""
"RTN","OROCAPI1",181,0)
 S ^XTMP("ORK FILE CONVERSION")=ORN
"RTN","OROCAPI1",182,0)
 D UNWIND^%ZTER
"RTN","OROCAPI1",183,0)
 Q
"RTN","OROCAPI1",184,0)
MAIL ;send mail message to installer if any errors encountered during conversion process
"RTN","OROCAPI1",185,0)
 Q:'$D(^XTMP("ORK FILE CONVERSION","LAST ERRORS"))
"RTN","OROCAPI1",186,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,XMMG,ORTXT,I,J
"RTN","OROCAPI1",187,0)
 S XMDUZ="PATCH OR*3*293 ORDER CHECK CONVERSION" S:$G(DUZ) XMY(^XTMP("ORK FILE CONVERSION","INSTALLER"))=""
"RTN","OROCAPI1",188,0)
 S I=0,I=I+1,^TMP($J,"ORTXT",I)=""
"RTN","OROCAPI1",189,0)
 S I=I+1,^TMP($J,"ORTXT",I)="While converting order check information from file 100 node 9 over to file"
"RTN","OROCAPI1",190,0)
 S I=I+1,^TMP($J,"ORTXT",I)="100.05, data errors were discovered for the order numbers listed below."
"RTN","OROCAPI1",191,0)
 S I=I+1,^TMP($J,"ORTXT",I)="All other order data converted appropriately."
"RTN","OROCAPI1",192,0)
 S I=I+1,^TMP($J,"ORTXT",I)="We recommend correcting the data, and then re-running the"
"RTN","OROCAPI1",193,0)
 S I=I+1,^TMP($J,"ORTXT",I)="conversion utility from programmer prompt as follows:"
"RTN","OROCAPI1",194,0)
 S I=I+1,^TMP($J,"ORTXT",I)="    D CONVERT^OROCAPI1"
"RTN","OROCAPI1",195,0)
 S I=I+1,^TMP($J,"ORTXT",I)="NOTE: re-running the conversion utility will only convert those orders that"
"RTN","OROCAPI1",196,0)
 S I=I+1,^TMP($J,"ORTXT",I)="did not convert properly the first time."
"RTN","OROCAPI1",197,0)
 S I=I+1,^TMP($J,"ORTXT",I)=""
"RTN","OROCAPI1",198,0)
 S I=I+1,^TMP($J,"ORTXT",I)="LIST OF ORDERS WITH CORRUPTED ORDER CHECK DATA"
"RTN","OROCAPI1",199,0)
 S I=I+1,^TMP($J,"ORTXT",I)="=============================================="
"RTN","OROCAPI1",200,0)
 S J=0 F  S J=$O(^XTMP("ORK FILE CONVERSION","LAST ERRORS",J)) Q:'J  S I=I+1,^TMP($J,"ORTXT",I)=J
"RTN","OROCAPI1",201,0)
 S XMTEXT="^TMP($J,""ORTXT"",",XMSUB="PATCH OR*3*293 CONVERSION ERRORS!"
"RTN","OROCAPI1",202,0)
 D ^XMD
"RTN","OROCAPI1",203,0)
 Q
"RTN","ORQQAL")
0^4^B15654998
"RTN","ORQQAL",1,0)
ORQQAL ;SLC/CLA,JFR - FUNCTIONS THAT RETURN PATIENT ADVERSE REACTION DATA ;11/16/2015  09:32
"RTN","ORQQAL",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**9,85,162,190,216,232,243,269**;Dec 17, 1997;Build 85
"RTN","ORQQAL",3,0)
LIST(ORAY,ORPT) ; RETURN PATIENT'S ALLERGY/ADVERSE REACTION INFO:
"RTN","ORQQAL",4,0)
 ; null:no allergy assessment, 0:no known allergies, 1:pt has allergies
"RTN","ORQQAL",5,0)
 ; if 1 also get: allergen/reactant^reaction/symptom^severity^allergy ien
"RTN","ORQQAL",6,0)
 N I,J,K,GMRARXN,GMRA
"RTN","ORQQAL",7,0)
 S I=1,J=0,K=0
"RTN","ORQQAL",8,0)
 D EN1^GMRAOR1(ORPT,"GMRARXN")
"RTN","ORQQAL",9,0)
 I $G(GMRARXN)="" S ORAY(I)="^No Allergy Assessment"
"RTN","ORQQAL",10,0)
 I $G(GMRARXN)=0 S ORAY(I)="^No Known Allergies"
"RTN","ORQQAL",11,0)
 I $G(GMRARXN)=1 F  S J=$O(GMRARXN(J)) Q:J=""  S ORAY(I)=$P(GMRARXN(J),"^",3)_"^"_$P(GMRARXN(J),"^")_"^"_$P(GMRARXN(J),"^",2) D SIGNS S I=I+1
"RTN","ORQQAL",12,0)
 S:'$D(ORAY(1)) ORAY(1)="^No allergies found."
"RTN","ORQQAL",13,0)
 Q
"RTN","ORQQAL",14,0)
SIGNS S K=0,N=0 F  S K=$O(GMRARXN(J,"S",K)) Q:K'>0  D
"RTN","ORQQAL",15,0)
 .I N=0 S ORAY(I)=ORAY(I)_"^"_$P(GMRARXN(J,"S",K),";")
"RTN","ORQQAL",16,0)
 .E  S ORAY(I)=ORAY(I)_";"_$P(GMRARXN(J,"S",K),";")
"RTN","ORQQAL",17,0)
 .S N=N+1
"RTN","ORQQAL",18,0)
 Q
"RTN","ORQQAL",19,0)
LRPT(ORAY,ORPT) ; RETURN PT'S ALLERGY/ADVERSE REACTION INFO IN REPORT FORMAT:
"RTN","ORQQAL",20,0)
 ; null:no allergy assessment, 0:no known allergies, 1:pt has allergies
"RTN","ORQQAL",21,0)
 ; if 1 also get: allergen/reactant^reaction/symptom^severity^allergy ien
"RTN","ORQQAL",22,0)
 N I,J,K,SEVER,CR,GMRAIDT ;216
"RTN","ORQQAL",23,0)
 S CR=$CHAR(13)
"RTN","ORQQAL",24,0)
 S I=1,J=0,K=0,SEVER="",GMRAIDT=1 ;216
"RTN","ORQQAL",25,0)
 D EN1^GMRAOR1(ORPT,"GMRARXN")
"RTN","ORQQAL",26,0)
 I $G(GMRARXN)="" S ORAY(I)="No Allergy Assessment"
"RTN","ORQQAL",27,0)
 I $G(GMRARXN)=0 S ORAY(I)="No Known Allergies"
"RTN","ORQQAL",28,0)
 I $G(GMRARXN)=1 F  S J=$O(GMRARXN(J)) Q:J=""  D
"RTN","ORQQAL",29,0)
 .S SEVER=$P(GMRARXN(J),U,2)
"RTN","ORQQAL",30,0)
 .S ORAY(I)=$P(GMRARXN(J),U)_"     "_$S($L($G(SEVER)):"[Severity: "_SEVER_"]",1:""),I=I+1
"RTN","ORQQAL",31,0)
 .S K=0,N=0 F  S K=$O(GMRARXN(J,"S",K)) Q:K'>0  D
"RTN","ORQQAL",32,0)
 ..I N=0 S ORAY(I)="    Signs/symptoms: "_$P(GMRARXN(J,"S",K),";")
"RTN","ORQQAL",33,0)
 ..E     S ORAY(I)="                    "_$P(GMRARXN(J,"S",K),";")
"RTN","ORQQAL",34,0)
 ..I $P(GMRARXN(J,"S",K),";",2) S ORAY(I)=ORAY(I)_" ("_$$FMTE^XLFDT($P(GMRARXN(J,"S",K),";",2),2)_")" ;216
"RTN","ORQQAL",35,0)
 ..S N=N+1,I=I+1
"RTN","ORQQAL",36,0)
 .S ORAY(I)=" ",I=I+1
"RTN","ORQQAL",37,0)
 S:'$D(ORAY(1)) ORAY(1)="No allergies found."
"RTN","ORQQAL",38,0)
 K GMRARXN
"RTN","ORQQAL",39,0)
 Q
"RTN","ORQQAL",40,0)
DETAIL(ORAY,DFN,ALLR,ID) ; RETURN DETAILED ALLERGY INFO FOR SPECIFIED ALLERGIC REACTION:
"RTN","ORQQAL",41,0)
 D EN2^GMRAOR2(ALLR,"GMRACT")
"RTN","ORQQAL",42,0)
 N CR,OX,OH S CR=$CHAR(13),I=1
"RTN","ORQQAL",43,0)
 S ORAY(I)="    Causative agent: "_$P(GMRACT,U),I=I+1
"RTN","ORQQAL",44,0)
 S ORAY(I)=" Nature of Reaction: "_$S($P(GMRACT,U,6)="ALLERGY":"Allergy",$P(GMRACT,U,6)="PHARMACOLOGIC":"Adverse Reaction",$P(GMRACT,U,6)="UNKNOWN":"Unknown",1:""),I=I+1 ;216
"RTN","ORQQAL",45,0)
 S ORAY(I)=" ",I=I+1
"RTN","ORQQAL",46,0)
 I $D(GMRACT("S",1)) D SYMP
"RTN","ORQQAL",47,0)
 I $D(GMRACT("V",1)) D CLAS
"RTN","ORQQAL",48,0)
 S ORAY(I)="         Originator: "_$P(GMRACT,U,2)_$S($L($P(GMRACT,U,3)):" ("_$P(GMRACT,U,3)_")",1:""),I=I+1 ;216
"RTN","ORQQAL",49,0)
 S ORAY(I)="         Originated: "_$P(GMRACT,U,10),I=I+1 ;216
"RTN","ORQQAL",50,0)
 I $D(GMRACT("O",1)) D OBS
"RTN","ORQQAL",51,0)
 S ORAY(I)="           Verified: "_$S($P(GMRACT,U,4)="VERIFIED":$P(GMRACT,U,8),1:"No"),I=I+1 ;216
"RTN","ORQQAL",52,0)
 S ORAY(I)="Observed/Historical: "_$S($P(GMRACT,U,5)="OBSERVED":"Observed",$P(GMRACT,U,5)="HISTORICAL":"Historical",1:""),I=I+1
"RTN","ORQQAL",53,0)
 I $D(GMRACT("C",1)) D COM
"RTN","ORQQAL",54,0)
 K GMRACT
"RTN","ORQQAL",55,0)
 Q
"RTN","ORQQAL",56,0)
SYMP S K=0,N=0 F  S K=$O(GMRACT("S",K)) Q:K'>0  D
"RTN","ORQQAL",57,0)
 .I N=0 S ORAY(I)="     Signs/symptoms: "_GMRACT("S",K),I=I+1
"RTN","ORQQAL",58,0)
 .E  S ORAY(I)="                     "_GMRACT("S",K),I=I+1
"RTN","ORQQAL",59,0)
 .S N=N+1
"RTN","ORQQAL",60,0)
 S ORAY(I)=" ",I=I+1
"RTN","ORQQAL",61,0)
 K N,K
"RTN","ORQQAL",62,0)
 Q
"RTN","ORQQAL",63,0)
CLAS S K=0,N=0 F  S K=$O(GMRACT("V",K)) Q:K'>0  D
"RTN","ORQQAL",64,0)
 .I N=0 S ORAY(I)="       Drug Classes: "_$P(GMRACT("V",K),U,2),I=I+1
"RTN","ORQQAL",65,0)
 .E  S ORAY(I)="                     "_$P(GMRACT("V",K),U,2),I=I+1
"RTN","ORQQAL",66,0)
 .S N=N+1
"RTN","ORQQAL",67,0)
 S ORAY(I)=" ",I=I+1
"RTN","ORQQAL",68,0)
 K N,K
"RTN","ORQQAL",69,0)
 Q
"RTN","ORQQAL",70,0)
OBS S K=0,N=0 F  S K=$O(GMRACT("O",K)) Q:K'>0  D
"RTN","ORQQAL",71,0)
 .I N=0 D
"RTN","ORQQAL",72,0)
 ..S Y=$P(GMRACT("O",K),U) D DD^%DT
"RTN","ORQQAL",73,0)
 ..S ORAY(I)=" Obs dates/severity: "_Y_" "_$P(GMRACT("O",K),U,2),I=I+1
"RTN","ORQQAL",74,0)
 .E  D
"RTN","ORQQAL",75,0)
 ..S Y=$P(GMRACT("O",K),U) D DD^%DT
"RTN","ORQQAL",76,0)
 ..S ORAY(I)="                     "_Y_" "_$P(GMRACT("O",K),U,2),I=I+1
"RTN","ORQQAL",77,0)
 .S N=N+1
"RTN","ORQQAL",78,0)
 S ORAY(I)=" ",I=I+1
"RTN","ORQQAL",79,0)
 K N,K,Y
"RTN","ORQQAL",80,0)
 Q
"RTN","ORQQAL",81,0)
COM S K=0,N=0,ORAY(I)=" ",I=I+1
"RTN","ORQQAL",82,0)
 F  S K=$O(GMRACT("C",K)) Q:K'>0  D
"RTN","ORQQAL",83,0)
 .I N=0 S ORAY(I)="Comments:",I=I+1
"RTN","ORQQAL",84,0)
 .S Y=$P(GMRACT("C",K),U) D DD^%DT
"RTN","ORQQAL",85,0)
 .S ORAY(I)="   "_Y_" by "_$P(GMRACT("C",K),U,2),I=I+1
"RTN","ORQQAL",86,0)
 .I $D(GMRACT("C",K,1,0)) S L=0 F  S L=$O(GMRACT("C",K,L)) Q:L'>0  D
"RTN","ORQQAL",87,0)
 ..S ORAY(I)=GMRACT("C",K,L,0),I=I+1
"RTN","ORQQAL",88,0)
 .S N=N+1
"RTN","ORQQAL",89,0)
 S ORAY(I)=" ",I=I+1
"RTN","ORQQAL",90,0)
 K N,K,L,Y
"RTN","ORQQAL",91,0)
 Q
"RTN","ORRDI1")
0^5^B165641370
"RTN","ORRDI1",1,0)
ORRDI1 ;SLC/JMH - RDI ROUTINES FOR API SUPPORTING CDS DATA ;10/28/2015  15:59
"RTN","ORRDI1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**232,294,306,269**;Dec 17, 1997;Build 85
"RTN","ORRDI1",3,0)
 ;
"RTN","ORRDI1",4,0)
GET(DFN,DOMAIN) ;API for packages to call in order to get data from HDR for
"RTN","ORRDI1",5,0)
 I '$L($G(DOMAIN)) S DOMAIN="ART"
"RTN","ORRDI1",6,0)
 ; check if in OUTAGE state and quit if so
"RTN","ORRDI1",7,0)
 I $$DOWNXVAL^ORRDI2 D  Q -1
"RTN","ORRDI1",8,0)
 .K ^XTMP("ORRDI",DOMAIN,DFN)
"RTN","ORRDI1",9,0)
 .S ^XTMP("ORRDI",DOMAIN,DFN,0)="^^-1"
"RTN","ORRDI1",10,0)
 ;  order checking purposes
"RTN","ORRDI1",11,0)
 N I,ORCACHE,ORRET,ORRECDT
"RTN","ORRDI1",12,0)
 ;check if data was just retrieved a short time ago and if so return
"RTN","ORRDI1",13,0)
 S ORRECDT=$P($G(^XTMP("ORRDI",DOMAIN,DFN,0)),U) I 'ORRECDT S ORRECDT=3000101
"RTN","ORRDI1",14,0)
 S ORCACHE=$$GET^XPAR("SYS","OR RDI CACHE TIME")
"RTN","ORRDI1",15,0)
 I $$FMDIFF^XLFDT($$NOW^XLFDT,ORRECDT,2)<(60*ORCACHE),$P(^XTMP("ORRDI",DOMAIN,DFN,0),U,3)>-1 S ORRET=$P(^XTMP("ORRDI",DOMAIN,DFN,0),U,3)
"RTN","ORRDI1",16,0)
 ;check if there has been an HDR down condition within last minute
"RTN","ORRDI1",17,0)
 I $$FMDIFF^XLFDT($$NOW^XLFDT,$P($G(^XTMP("ORRDI","PSOO",DFN,0)),U),2)<60,$P($G(^XTMP("ORRDI","PSOO",DFN,0)),U,3)<0 S ORRET=$P($G(^XTMP("ORRDI","PSOO",DFN,0)),U,3)
"RTN","ORRDI1",18,0)
 I $$FMDIFF^XLFDT($$NOW^XLFDT,$P($G(^XTMP("ORRDI","ART",DFN,0)),U),2)<60,$P($G(^XTMP("ORRDI","ART",DFN,0)),U,3)<0 S ORRET=$P($G(^XTMP("ORRDI","ART",DFN,0)),U,3)
"RTN","ORRDI1",19,0)
 ;if data is not "fresh" then go get it
"RTN","ORRDI1",20,0)
 I '$L($G(ORRET)) D
"RTN","ORRDI1",21,0)
 .S ORRET=$$RETRIEVE(DFN,DOMAIN)
"RTN","ORRDI1",22,0)
 .I ORRET>-1 S ^XTMP("ORRDI","OUTAGE INFO","FAILURES")=0
"RTN","ORRDI1",23,0)
 .I ORRET'>-1 D
"RTN","ORRDI1",24,0)
 ..Q:$P(ORRET,U,2)="PATIENT ICN NOT FOUND"
"RTN","ORRDI1",25,0)
 ..I ORRET=-9 S ORRET="-1^PROCESSING ERROR" Q
"RTN","ORRDI1",26,0)
 ..S ^XTMP("ORRDI","OUTAGE INFO","FAILURES")=$$FAILXVAL^ORRDI2+1
"RTN","ORRDI1",27,0)
 ..I $$FAILXVAL^ORRDI2'<$$FAILPVAL^ORRDI2 D
"RTN","ORRDI1",28,0)
 ...S ^XTMP("ORRDI","OUTAGE INFO","DOWN")=1
"RTN","ORRDI1",29,0)
 ...D SPAWN^ORRDI2
"RTN","ORRDI1",30,0)
 S $P(^XTMP("ORRDI",DOMAIN,DFN,0),U,3,4)=ORRET
"RTN","ORRDI1",31,0)
 Q ORRET
"RTN","ORRDI1",32,0)
 ;
"RTN","ORRDI1",33,0)
RETRIEVE(DFN,DOMAIN) ;GET DATA
"RTN","ORRDI1",34,0)
 N $ES,$ET
"RTN","ORRDI1",35,0)
 S $ET="D ERRHNDL^ORRDI1(DFN) Q -1"
"RTN","ORRDI1",36,0)
 N Y,ORCSTART,ORPSTART,ORCDIF,ORPDIF,ORALNUM,ORPSNUM,ORREQ,ORXML,ORERR,ORRET,ORY,START,FACIL,ICN
"RTN","ORRDI1",37,0)
 K ^TMP($J,"ORRDI")
"RTN","ORRDI1",38,0)
 S ORY=-1
"RTN","ORRDI1",39,0)
 I '$L($G(DOMAIN)) S DOMAIN="ART"
"RTN","ORRDI1",40,0)
 ;GET ICN
"RTN","ORRDI1",41,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","ORRDI1",42,0)
 I +ICN<0 Q -1_"^PATIENT ICN NOT FOUND"
"RTN","ORRDI1",43,0)
 S START=$$FMADD^XLFDT($P($$NOW^XLFDT,"."),-30)
"RTN","ORRDI1",44,0)
 S START=$$FMTHL7^XLFDT(START)
"RTN","ORRDI1",45,0)
 S START=$E(START,1,4)_"-"_$E(START,5,6)_"-"_$E(START,7,8)
"RTN","ORRDI1",46,0)
 S FACIL=$P($$SITE^VASITE,U,3)
"RTN","ORRDI1",47,0)
 ;format request XML
"RTN","ORRDI1",48,0)
 S ORREQ="/readClinicalData1?&templateId=RDIAllergiesPharmacyRead40013&"
"RTN","ORRDI1",49,0)
 S ORREQ=ORREQ_"filterRequest=<?xml version=""1.0"" encoding=""UTF-8""?>"
"RTN","ORRDI1",50,0)
 S ORREQ=ORREQ_"<filter:filter vhimVersion=""Vhim_4_00"" xmlns:filter=""Filter"" "
"RTN","ORRDI1",51,0)
 S ORREQ=ORREQ_"xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance"">"
"RTN","ORRDI1",52,0)
 S ORREQ=ORREQ_"<filterId>RDI_ALLERGY_RX_SINGLE_PATIENT_FILTER</filterId><patients><NationalId>"_ICN_"</NationalId>"
"RTN","ORRDI1",53,0)
 S ORREQ=ORREQ_"<excludeIdentifiers><assigningAuthority>USVHA</assigningAuthority>"
"RTN","ORRDI1",54,0)
 S ORREQ=ORREQ_"<assigningFacility>"_FACIL_"</assigningFacility></excludeIdentifiers></patients>"
"RTN","ORRDI1",55,0)
 S ORREQ=ORREQ_"<entryPointFilter queryName=""IC-Standardized""><domainEntryPoint>IntoleranceCondition</domainEntryPoint>"
"RTN","ORRDI1",56,0)
 S ORREQ=ORREQ_"<xpathQuery><xpath>intoleranceConditions[((gmrAllergyAgent[(code!='') and (codingSystem = '99"
"RTN","ORRDI1",57,0)
 S ORREQ=ORREQ_"VHA_ERT' or contains(.,'99VA'))]) or (drugClass/code[(code!='') and (codingSystem = '99VHA_ERT' or co"
"RTN","ORRDI1",58,0)
 S ORREQ=ORREQ_"ntains(.,'99VA'))]) or (drugIngredient/code[(code!='') and (codingSystem = '99VHA_ERT' or contain"
"RTN","ORRDI1",59,0)
 S ORREQ=ORREQ_"s(.,'99VA'))])) and (status = 'F')]</xpath></xpathQuery></entryPointFilter>"
"RTN","ORRDI1",60,0)
 S ORREQ=ORREQ_"<entryPointFilter queryName=""OMP-Standardized"">"
"RTN","ORRDI1",61,0)
 S ORREQ=ORREQ_"<domainEntryPoint>OutpatientMedicationPromise</domainEntryPoint>"
"RTN","ORRDI1",62,0)
 S ORREQ=ORREQ_"<startDate>"_START_"</startDate><xpathQuery><xpath>outpatientMedicationPromises[pharmacyRe"
"RTN","ORRDI1",63,0)
 S ORREQ=ORREQ_"quest/orderedMedication/medicationCode[(code!='') and (codingSystem = '99VHA_ERT' or contain"
"RTN","ORRDI1",64,0)
 S ORREQ=ORREQ_"s(.,'99VA'))]]</xpath></xpathQuery></entryPointFilter><entryPointFilter queryName=""AA-Standardized"">"
"RTN","ORRDI1",65,0)
 S ORREQ=ORREQ_"<domainEntryPoint>AllergyAssessment</domainEntryPoint></entryPointFilter></filter:filter>"
"RTN","ORRDI1",66,0)
 S ORCSTART=$ZH
"RTN","ORRDI1",67,0)
 S ORREQ=ORREQ_"&filterId=RDI_ALLERGY_RX_SINGLE_PATIENT_FILTER&requestId="_FACIL_"RDI"_$$NOW^XLFDT_";"_ORCSTART
"RTN","ORRDI1",68,0)
 ;make call to HDR
"RTN","ORRDI1",69,0)
 S ORXML=$$GETREST^XOBWLIB("CDS WEB SERVICE","CDS SERVER")
"RTN","ORRDI1",70,0)
 S ORRET=$$GET^XOBWLIB(ORXML,ORREQ,.ORERR,0)
"RTN","ORRDI1",71,0)
 S ORCDIF=$ZH-ORCSTART
"RTN","ORRDI1",72,0)
 I ORRET D  Q ORY
"RTN","ORRDI1",73,0)
 .;parse out xml into temp global
"RTN","ORRDI1",74,0)
 .S ORPSTART=$ZH
"RTN","ORRDI1",75,0)
 .D PARSE(ORXML.HttpResponse.Data)
"RTN","ORRDI1",76,0)
 .S ORPDIF=$ZH-ORCSTART-ORCDIF
"RTN","ORRDI1",77,0)
 .;move from temp global into ^XTMP("ORRDI" domain globals
"RTN","ORRDI1",78,0)
 .S ORALNUM=$$AL(DFN)
"RTN","ORRDI1",79,0)
 .S ORPSNUM=$$PS(DFN)
"RTN","ORRDI1",80,0)
 .S ^XTMP("ORRDI","ART",DFN,0)=$$NOW^XLFDT_U_U_ORALNUM
"RTN","ORRDI1",81,0)
 .S ^XTMP("ORRDI","PSOO",DFN,0)=$$NOW^XLFDT_U_U_ORPSNUM
"RTN","ORRDI1",82,0)
 .S ^XTMP("ORRDI",0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","ORRDI1",83,0)
 .I DOMAIN="ART" S ORY=ORALNUM
"RTN","ORRDI1",84,0)
 .I DOMAIN="PSOO" S ORY=ORPSNUM
"RTN","ORRDI1",85,0)
 .I +ORY>-1 S ^XTMP("ORRDI","TESTREQ")=ORREQ
"RTN","ORRDI1",86,0)
 .;set metrics for data retrieval and parsing
"RTN","ORRDI1",87,0)
 .S ^XTMP("ORRDI","METRICS",$$NOW^XLFDT,ORCSTART)=DFN_U_ORCDIF_U_ORPDIF_U_ORALNUM_U_ORPSNUM
"RTN","ORRDI1",88,0)
 .K ^TMP($J,"ORRDI")
"RTN","ORRDI1",89,0)
 I 'ORRET!(ORERR) S ^XTMP("ORRDI","METRICS",$$NOW^XLFDT,ORCSTART)=DFN_U_"ERROR" D  Q "-1^"_ORERR
"RTN","ORRDI1",90,0)
 .S ^XTMP("ORRDI","ART",DFN,0)=U_U_"-1^"_ORERR
"RTN","ORRDI1",91,0)
 .S ^XTMP("ORRDI","PSOO",DFN,0)=U_U_"-1^"_ORERR
"RTN","ORRDI1",92,0)
 Q -1
"RTN","ORRDI1",93,0)
 ;
"RTN","ORRDI1",94,0)
PS(DFN) ;expects ^TMP($J,"ORRDI")
"RTN","ORRDI1",95,0)
 K ^XTMP("ORRDI","PSOO",DFN)
"RTN","ORRDI1",96,0)
 N ORQ S ORQ=$$MSGERR Q:($L(ORQ)>0) -1_U_ORQ
"RTN","ORRDI1",97,0)
 N I,GL,CNT
"RTN","ORRDI1",98,0)
 S CNT=0,GL=$NA(^TMP($J,"ORRDI","ClinicalData",0,"patient",0,"outpatientMedicationPromises"))
"RTN","ORRDI1",99,0)
 S I="" F  S I=$O(@GL@(I)) Q:'$L(I)  D
"RTN","ORRDI1",100,0)
 .S CNT=CNT+1
"RTN","ORRDI1",101,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,1,0)=$G(@GL@(I,"pharmacyRequest",0,"orderingInstitutionIdentifier",0,"name",0))
"RTN","ORRDI1",102,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,2,0)=$G(@GL@(I,"pharmacyRequest",0,"orderedMedication",0,"medicationCode",0,"displayText",0))
"RTN","ORRDI1",103,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,3,0)=$G(@GL@(I,"pharmacyRequest",0,"orderedMedication",0,"medicationCode",0,"code",0))
"RTN","ORRDI1",104,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,4,0)=$G(@GL@(I,"prescriptionId",0))
"RTN","ORRDI1",105,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,5,0)=$G(@GL@(I,"pharmacyRequest",0,"statusModifier",0,"displayText",0))
"RTN","ORRDI1",106,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,6,0)=$G(@GL@(I,"originalDispense",0,"quantityDispensed",0,"value",0))_";"_$G(@GL@(I,"originalDispense",0,"daysSupply",0))
"RTN","ORRDI1",107,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,7,0)=$$DTCONV($G(@GL@(I,"expirationDate",0,"literal",0)))
"RTN","ORRDI1",108,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,8,0)=$$DTCONV($G(@GL@(I,"pharmacyRequest",0,"orderDate",0,"literal",0)))
"RTN","ORRDI1",109,0)
 .N K S K="" F  S K=$O(@GL@(I,"refillDispense",K)) Q:'$L(K)  D
"RTN","ORRDI1",110,0)
 ..I $G(@GL@(I,"refillDispense",K,"fillDate",0,"literal",0)) D
"RTN","ORRDI1",111,0)
 ...S ^XTMP("ORRDI","PSOO",DFN,I+1,9,0)=$$DTCONV($G(@GL@(I,"refillDispense",K,"fillDate",0,"literal",0)))
"RTN","ORRDI1",112,0)
 .I '$G(^XTMP("ORRDI","PSOO",DFN,I+1,9,0)) S ^XTMP("ORRDI","PSOO",DFN,I+1,9,0)=$$DTCONV($G(@GL@(I,"originalDispense",0,"fillDate",0,"literal",0)))
"RTN","ORRDI1",113,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,10,0)=$G(@GL@(I,"numberOfRefillsAuthorized",0))
"RTN","ORRDI1",114,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,11,0)=$G(@GL@(I,"originalDispense",0,"currentProvider",0,"name",0,"family",0))_","_$G(@GL@(I,"originalDispense",0,"currentProvider",0,"name",0,"given",0))
"RTN","ORRDI1",115,0)
 .S ^XTMP("ORRDI","PSOO",DFN,I+1,12,0)=$G(@GL@(I,"originalDispense",0,"dispensedDrug",0,"drugUnitPrice",0,"value",0))
"RTN","ORRDI1",116,0)
 .N L S L="" F  S L=$O(@GL@(I,"sig",L)) Q:'$L(L)  S ^XTMP("ORRDI","PSOO",DFN,I+1,14,0)=$G(^XTMP("ORRDI","PSOO",DFN,I+1,14,0))_" "_$G(@GL@(I,"sig",L))
"RTN","ORRDI1",117,0)
 .I '$D(^XTMP("ORRDI","PSOO",DFN,I+1,14,0)) S ^XTMP("ORRDI","PSOO",DFN,I+1,14,0)=""
"RTN","ORRDI1",118,0)
 .;S ^XTMP("ORRDI","PSOO",DFN,I+1,14,0)=$G(@GL@(I,"sig",0))
"RTN","ORRDI1",119,0)
 Q CNT
"RTN","ORRDI1",120,0)
 ;
"RTN","ORRDI1",121,0)
AL(DFN) ;expects ^TMP($J,"ORRDI")
"RTN","ORRDI1",122,0)
 K ^XTMP("ORRDI","ART",DFN)
"RTN","ORRDI1",123,0)
 N ORQ S ORQ=$$MSGERR Q:($L(ORQ)>0) -1_U_ORQ
"RTN","ORRDI1",124,0)
 N I,GL,CNT
"RTN","ORRDI1",125,0)
 S CNT=0,GL=$NA(^TMP($J,"ORRDI","ClinicalData",0,"patient",0,"intoleranceConditions"))
"RTN","ORRDI1",126,0)
 S I="" F  S I=$O(@GL@(I)) Q:'$L(I)  D
"RTN","ORRDI1",127,0)
 .S CNT=CNT+1
"RTN","ORRDI1",128,0)
 .I $D(@GL@(I,"patient",0,"identifier",0,"assigningFacility",0)) D
"RTN","ORRDI1",129,0)
 ..N RETURN
"RTN","ORRDI1",130,0)
 ..D F4^XUAF4($G(@GL@(I,"patient",0,"identifier",0,"assigningFacility",0)),.RETURN)
"RTN","ORRDI1",131,0)
 ..I +RETURN>0 D
"RTN","ORRDI1",132,0)
 ...S ^XTMP("ORRDI","ART",DFN,I+1,"FACILITY",0)=RETURN_U_$S(RETURN("VA NAME")'="":RETURN("VA NAME"),1:RETURN("NAME"))_U_RETURN("STATION NUMBER")
"RTN","ORRDI1",133,0)
 ..I +RETURN=0 D
"RTN","ORRDI1",134,0)
 ...S ^XTMP("ORRDI","ART",DFN,I+1,"FACILITY",0)=U_U_$G(@GL@(I,"patient",0,"identifier",0,"assigningFacility",0))
"RTN","ORRDI1",135,0)
 .I $G(@GL@(I,"gmrAllergyAgent",0,"code",0)),$E($G(@GL@(I,"gmrAllergyAgent",0,"codingSystem",0)),1,4)="99VA" D
"RTN","ORRDI1",136,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"GMRALLERGY",0)=@GL@(I,"gmrAllergyAgent",0,"code",0)_U_@GL@(I,"gmrAllergyAgent",0,"displayText",0)_U_@GL@(I,"gmrAllergyAgent",0,"codingSystem",0)
"RTN","ORRDI1",137,0)
 .I $D(@GL@(I,"agent",0,"code",0))#2 D
"RTN","ORRDI1",138,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"REACTANT",0)=$G(@GL@(I,"agent",0,"code",0))
"RTN","ORRDI1",139,0)
 .I $D(@GL@(I,"reaction")) D
"RTN","ORRDI1",140,0)
 ..N J S J="" F  S J=$O(@GL@(I,"reaction",J))  Q:'$L(J)  D
"RTN","ORRDI1",141,0)
 ...I $E($G(@GL@(I,"reaction",J,"reaction",0,"codingSystem",0)),1,4)="99VA" D
"RTN","ORRDI1",142,0)
 ....S ^XTMP("ORRDI","ART",DFN,I+1,"SIGNS/SYMPTOMS",J+1)=$G(@GL@(I,"reaction",J,"reaction",0,"code",0))_U_@GL@(I,"reaction",J,"reaction",0,"displayText",0)_U_@GL@(I,"reaction",J,"reaction",0,"codingSystem",0)
"RTN","ORRDI1",143,0)
 ...I $E($G(@GL@(I,"reaction",J,"reaction",0,"codingSystem",0)),1,4)'="99VA" D
"RTN","ORRDI1",144,0)
 ....S ^XTMP("ORRDI","ART",DFN,I+1,"SIGNS/SYMPTOMS",J+1)=U_@GL@(I,"reaction",J,"reaction",0,"displayText",0)_U_$TR(@GL@(I,"reaction",J,"reaction",0,"codingSystem",0),"`~!@#$%^&*()-_=+[{]}\|;:'"",<.>/?")
"RTN","ORRDI1",145,0)
 ...I $G(@GL@(I,"reaction",J,"observationTime",0,"literal",0))'="" D
"RTN","ORRDI1",146,0)
 ....S ^XTMP("ORRDI","ART",DFN,I+1,"SIGNS/SYMPTOMS",J+1,"DATE_ENTERED",0)=@GL@(I,"reaction",J,"observationTime",0,"literal",0)
"RTN","ORRDI1",147,0)
 .I $D(@GL@(I,"informationSourceCategory")) D
"RTN","ORRDI1",148,0)
 ..Q:$E($G(@GL@(I,"informationSourceCategory",0,"codingSystem",0)),1,4)'="99VA"
"RTN","ORRDI1",149,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"OBS/HISTORICAL",0)=$G(@GL@(I,"informationSourceCategory",0,"code",0))_U_@GL@(I,"informationSourceCategory",0,"displayText",0)_U_@GL@(I,"informationSourceCategory",0,"codingSystem",0)
"RTN","ORRDI1",150,0)
 .I $D(@GL@(I,"mechanism",0)) D
"RTN","ORRDI1",151,0)
 ..Q:$E($G(@GL@(I,"mechanism",0,"codingSystem",0)),1,4)'="99VA"
"RTN","ORRDI1",152,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"MECHANISM",0)=$G(@GL@(I,"mechanism",0,"code",0))_U_@GL@(I,"mechanism",0,"displayText",0)_U_@GL@(I,"mechanism",0,"codingSystem",0)
"RTN","ORRDI1",153,0)
 .I $D(@GL@(I,"severity",0)) D
"RTN","ORRDI1",154,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"SEVERITY",0)=$G(@GL@(I,"severity",0,"value",0,"code",0))_U_$G(@GL@(I,"severity",0,"value",0,"displayText",0))
"RTN","ORRDI1",155,0)
 .I $D(@GL@(I,"verified",0)) D
"RTN","ORRDI1",156,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"VERIFIED",0)=$G(@GL@(I,"verified",0))
"RTN","ORRDI1",157,0)
 .I $D(@GL@(I,"allergyType",0)) D
"RTN","ORRDI1",158,0)
 ..Q:$E($G(@GL@(I,"allergyType",0,"codingSystem",0)),1,4)'="L"
"RTN","ORRDI1",159,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"TYPE",0)=$G(@GL@(I,"allergyType",0,"code",0))_U_@GL@(I,"allergyType",0,"displayText",0)_U_@GL@(I,"allergyType",0,"codingSystem",0)
"RTN","ORRDI1",160,0)
 .I $D(@GL@(I,"observationTime",0,"literal",0)) D
"RTN","ORRDI1",161,0)
 ..;observationTime is mapped to ORIGINATION DATE/TIME field in file #120.8
"RTN","ORRDI1",162,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"ORIGINATION DATE/TIME",0)=$G(@GL@(I,"observationTime",0,"literal",0))
"RTN","ORRDI1",163,0)
 .I $D(@GL@(I,"author",0)) D
"RTN","ORRDI1",164,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"AUTHOR",0)=$G(@GL@(I,"author",0,"practitioner",0,"name",0,"family",0))_U
"RTN","ORRDI1",165,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"AUTHOR",0)=^XTMP("ORRDI","ART",DFN,I+1,"AUTHOR",0)_$G(@GL@(I,"author",0,"practitioner",0,"name",0,"given",0))_U
"RTN","ORRDI1",166,0)
 ..S ^XTMP("ORRDI","ART",DFN,I+1,"AUTHOR",0)=^XTMP("ORRDI","ART",DFN,I+1,"AUTHOR",0)_$G(@GL@(I,"author",0,"practitioner",0,"name",0,"middle",0))
"RTN","ORRDI1",167,0)
 .I $D(@GL@(I,"drugIngredient")) D
"RTN","ORRDI1",168,0)
 ..N J S J="" F  S J=$O(@GL@(I,"drugIngredient",J))  Q:'$L(J)  D
"RTN","ORRDI1",169,0)
 ...I $G(@GL@(I,"drugIngredient",J,"code",0,"code",0)),$E($G(@GL@(I,"drugIngredient",J,"code",0,"codingSystem",0)),1,4)="99VA" D
"RTN","ORRDI1",170,0)
 ....S ^XTMP("ORRDI","ART",DFN,I+1,"DRUG INGREDIENTS",J+1)=@GL@(I,"drugIngredient",J,"code",0,"code",0)_U_@GL@(I,"drugIngredient",J,"code",0,"displayText",0)_U_@GL@(I,"drugIngredient",J,"code",0,"codingSystem",0)
"RTN","ORRDI1",171,0)
 .I $D(@GL@(I,"drugClass")) D
"RTN","ORRDI1",172,0)
 ..N J S J="" F  S J=$O(@GL@(I,"drugClass",J))  Q:'$L(J)  D
"RTN","ORRDI1",173,0)
 ...Q:$E($G(@GL@(I,"drugClass",0,"code",0,"codingSystem",0)),1,4)'="99VA"
"RTN","ORRDI1",174,0)
 ...S ^XTMP("ORRDI","ART",DFN,I+1,"DRUG CLASSES",J+1)=@GL@(I,"drugClass",J,"code",0,"code",0)_U_@GL@(I,"drugClass",J,"code",0,"displayText",0)_U_$G(@GL@(I,"drugClass",J,"code",0,"codingSystem",0))
"RTN","ORRDI1",175,0)
 ...S ^XTMP("ORRDI","ART",DFN,I+1,"DRUG CLASSES",J+1)=^XTMP("ORRDI","ART",DFN,I+1,"DRUG CLASSES",J+1)_U_$G(@GL@(I,"drugClass",J,"code",0,"alternateCode",0))
"RTN","ORRDI1",176,0)
 S GL=$NA(^TMP($J,"ORRDI","ClinicalData",0,"patient",0,"allergyAssessments"))
"RTN","ORRDI1",177,0)
 S I="" F  S I=$O(@GL@(I)) Q:'$L(I)  D
"RTN","ORRDI1",178,0)
 .S ^XTMP("ORRDI","ART",DFN,"ASSESSMENT",I+1)=$G(@GL@(I,"assessmentValue",0,"code",0))_U_$G(@GL@(I,"assessmentValue",0,"displayText",0))_U_$G(@GL@(I,"assessmentValue",0,"codingSystem",0))
"RTN","ORRDI1",179,0)
 .N RETURN
"RTN","ORRDI1",180,0)
 .D F4^XUAF4($G(@GL@(I,"patient",0,"identifier",0,"assigningFacility",0)),.RETURN)
"RTN","ORRDI1",181,0)
 .I +RETURN>0 D
"RTN","ORRDI1",182,0)
 ..S ^XTMP("ORRDI","ART",DFN,"ASSESSMENT",I+1,"FACILITY",0)=RETURN_U_$S(RETURN("VA NAME")'="":RETURN("VA NAME"),1:RETURN("NAME"))_U_RETURN("STATION NUMBER")
"RTN","ORRDI1",183,0)
 .I +RETURN=0 D
"RTN","ORRDI1",184,0)
 ..S ^XTMP("ORRDI","ART",DFN,"ASSESSMENT",I+1,"FACILITY",0)=U_U_$G(@GL@(I,"patient",0,"identifier",0,"assigningFacility",0))
"RTN","ORRDI1",185,0)
 Q CNT
"RTN","ORRDI1",186,0)
 ;
"RTN","ORRDI1",187,0)
HAVEHDR() ;call to check if this system has an HDR to perform order checks
"RTN","ORRDI1",188,0)
 ;  against
"RTN","ORRDI1",189,0)
 ;check parameter to see if there is an HDR and returns positive if so
"RTN","ORRDI1",190,0)
 I $$GET^XPAR("SYS","OR RDI HAVE HDR") Q 1
"RTN","ORRDI1",191,0)
 ;returns negative because the parameter indicates there is no HDR
"RTN","ORRDI1",192,0)
 Q 0
"RTN","ORRDI1",193,0)
 ;
"RTN","ORRDI1",194,0)
DTCONV(DATE) ;convert date in hl7 format to mm/dd/yy
"RTN","ORRDI1",195,0)
 I '$L(DATE) Q ""
"RTN","ORRDI1",196,0)
 Q $E(DATE,5,6)_"/"_$E(DATE,7,8)_"/"_$E(DATE,3,4)
"RTN","ORRDI1",197,0)
 ;
"RTN","ORRDI1",198,0)
PARSE(STREAM) ;
"RTN","ORRDI1",199,0)
 N %XML,GL
"RTN","ORRDI1",200,0)
 S GL=$NA(^TMP($J,"ORRDI"))
"RTN","ORRDI1",201,0)
 K @GL
"RTN","ORRDI1",202,0)
 N STATUS,READER,XOBERR,S
"RTN","ORRDI1",203,0)
 S STATUS=##class(%XML.TextReader).ParseStream(STREAM,.READER,,,,,1)
"RTN","ORRDI1",204,0)
 I $$STATCHK^XOBWLIB(STATUS,.XOBERR,1) D
"RTN","ORRDI1",205,0)
 .N BREAK
"RTN","ORRDI1",206,0)
 .S BREAK=0 F  Q:BREAK||READER.EOF||'READER.Read()  D
"RTN","ORRDI1",207,0)
 ..N X
"RTN","ORRDI1",208,0)
 ..I READER.NodeType="element" D SPUSH(.S,READER.LocalName)
"RTN","ORRDI1",209,0)
 ..I READER.NodeType="endelement" D SPOP(.S,.X)
"RTN","ORRDI1",210,0)
 ..I READER.NodeType="chars" D SPUT(.S,READER.Value)
"RTN","ORRDI1",211,0)
 Q
"RTN","ORRDI1",212,0)
 ;
"RTN","ORRDI1",213,0)
SPUSH(S,X) ;places X on the stack S and returns the current level of the stack
"RTN","ORRDI1",214,0)
 N I S I=$O(S(""),-1)+1,S(I)=X
"RTN","ORRDI1",215,0)
 Q I
"RTN","ORRDI1",216,0)
 ;
"RTN","ORRDI1",217,0)
SPOP(S,X) ;removes the top item from the stack S and put it into the variable X and returns the level that X was at
"RTN","ORRDI1",218,0)
 N I S I=$O(S(""),-1)
"RTN","ORRDI1",219,0)
 I I S X=S(I) K S(I)
"RTN","ORRDI1",220,0)
 N J S J=$O(S(I),-1) I J S S(J,X)=$G(S(J,X))+1
"RTN","ORRDI1",221,0)
 Q I
"RTN","ORRDI1",222,0)
 ;
"RTN","ORRDI1",223,0)
SPEEK(S,X) ;same as SPOP except the top item is not removed
"RTN","ORRDI1",224,0)
 N I S I=$O(S(""),-1)
"RTN","ORRDI1",225,0)
 I I S X=S(I)
"RTN","ORRDI1",226,0)
 Q I
"RTN","ORRDI1",227,0)
 ;
"RTN","ORRDI1",228,0)
SPUT(S,X) ;implementation specific, uses the stack to form a global node
"RTN","ORRDI1",229,0)
 N I,STR
"RTN","ORRDI1",230,0)
 S STR=$P(GL,")")
"RTN","ORRDI1",231,0)
 S I=0 F  S I=$O(S(I)) Q:'I  D
"RTN","ORRDI1",232,0)
 .S STR=STR_","_""""_S(I)_""""_","
"RTN","ORRDI1",233,0)
 .N NUM S NUM=0
"RTN","ORRDI1",234,0)
 .I $D(S(I-1,S(I))) S NUM=+$G(S(I-1,S(I)))
"RTN","ORRDI1",235,0)
 .S STR=STR_NUM
"RTN","ORRDI1",236,0)
 S STR=STR_")"
"RTN","ORRDI1",237,0)
 I $D(@STR) S @STR=@STR_X
"RTN","ORRDI1",238,0)
 I '$D(@STR) S @STR=X
"RTN","ORRDI1",239,0)
 Q STR
"RTN","ORRDI1",240,0)
 ;
"RTN","ORRDI1",241,0)
MSGERR() ;check errors from XML return
"RTN","ORRDI1",242,0)
 ;returns empty string "" if there was no error
"RTN","ORRDI1",243,0)
 ;returns empty string "" if the only error was "ALL_PATIENT_IDS_EXCLUDED"
"RTN","ORRDI1",244,0)
 ;otherwise returns the exceptionMessage string from the errorSection
"RTN","ORRDI1",245,0)
 N ORRET S ORRET=""
"RTN","ORRDI1",246,0)
 I $D(^TMP($J,"ORRDI","ClinicalData",0,"errorSection")) D
"RTN","ORRDI1",247,0)
 .N I F I="fatalErrors","errors","warnings" D
"RTN","ORRDI1",248,0)
 ..N J S J="" F  S J=$O(^TMP($J,"ORRDI","ClinicalData",0,"errorSection",0,I,J)) Q:J=""  D
"RTN","ORRDI1",249,0)
 ...N ORSTR S ORSTR=$G(^TMP($J,"ORRDI","ClinicalData",0,"errorSection",0,I,J,"errorCode",0))
"RTN","ORRDI1",250,0)
 ...I ORSTR'="ALL_PATIENT_IDS_EXCLUDED" S ORRET=ORSTR
"RTN","ORRDI1",251,0)
 Q ORRET
"RTN","ORRDI1",252,0)
ERRHNDL(DFN) ;handle any errors that may get thrown in call to GET^ORRDI1
"RTN","ORRDI1",253,0)
 K ^TMP($J,"ORRDI"),^XTMP("ORRDI","PSOO",DFN),^XTMP("ORRDI","ART",DFN)
"RTN","ORRDI1",254,0)
 D UNWIND^%ZTER
"RTN","ORRDI1",255,0)
 Q
"RTN","ORWDXC")
0^7^B72504942
"RTN","ORWDXC",1,0)
ORWDXC ; SLC/KCM - Utilities for Order Checking ;01/28/15  09:02
"RTN","ORWDXC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,141,221,243,280,346,345,311,395,269**;Dec 17, 1997;Build 85
"RTN","ORWDXC",3,0)
 ;
"RTN","ORWDXC",4,0)
ON(VAL) ; returns E if order checking enabled, otherwise D
"RTN","ORWDXC",5,0)
 S VAL=$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")
"RTN","ORWDXC",6,0)
 Q
"RTN","ORWDXC",7,0)
FILLID(VAL,DLG) ; Return the FillerID (namespace) for a dialog
"RTN","ORWDXC",8,0)
 N DGRP
"RTN","ORWDXC",9,0)
 S VAL="",DGRP=$P($G(^ORD(101.41,DLG,0)),U,5) Q:'DGRP
"RTN","ORWDXC",10,0)
 S DLG=$$DEFDLG^ORWDXQ(DGRP)
"RTN","ORWDXC",11,0)
 S VAL=$P($G(^ORD(101.41,DLG,0)),U,7),VAL=$$NMSP^ORCD(VAL)
"RTN","ORWDXC",12,0)
 I VAL="PS" D
"RTN","ORWDXC",13,0)
 . N X
"RTN","ORWDXC",14,0)
 . S X=$P($P($G(^ORD(100.98,DGRP,0)),U,3)," ")
"RTN","ORWDXC",15,0)
 . I $L(X) S VAL="PS"_$S(X="UD":"I",1:X)
"RTN","ORWDXC",16,0)
 Q
"RTN","ORWDXC",17,0)
DISPLAY(LST,DFN,FID) ; Return list of Order Checks for a FillerID (namespace)
"RTN","ORWDXC",18,0)
 N I,ORX,ORY
"RTN","ORWDXC",19,0)
 S ORX=1,ORX(1)="|"_FID
"RTN","ORWDXC",20,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"DISPLAY")
"RTN","ORWDXC",21,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  S LST(I)=$P(ORY(I),U,4)
"RTN","ORWDXC",22,0)
 Q
"RTN","ORWDXC",23,0)
ACCEPT(LST,DFN,FID,STRT,ORL,OIL,ORIFN,ORREN)    ; Return list of Order Checks on Accept Order
"RTN","ORWDXC",24,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",25,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",26,0)
 ; ORREN - IF ORREN IS SET TO 1 THEN ORIFN IS THE ORDER GETTING RENEWED
"RTN","ORWDXC",27,0)
 K ^TMP($J,"ORENHCHK")
"RTN","ORWDXC",28,0)
 N X,Y,USID,ORCHECK,ORI,ORX,ORY,%DT,ORDODSG
"RTN","ORWDXC",29,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",30,0)
 S ORL=ORL_";SC(",X=STRT,STRT="",ORDODSG=0
"RTN","ORWDXC",31,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",32,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",33,0)
 ; do the SELECT order checks
"RTN","ORWDXC",34,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",35,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",36,0)
 . S USID=$$USID(OIL(ORI))
"RTN","ORWDXC",37,0)
 . S OIL(ORI,"USID")=USID
"RTN","ORWDXC",38,0)
 . S ORX=ORX+1,ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_USID
"RTN","ORWDXC",39,0)
 . S:$P(OIL(ORI),U,2)="PSIV" $P(ORX(ORX),"|",7)=$P($P(OIL(ORI),U,3),";")
"RTN","ORWDXC",40,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"SELECT",.OIL,.ORDODSG)
"RTN","ORWDXC",41,0)
 I $D(ORY) D RETURN^ORCHECK ; expects ORY, ORCHECK
"RTN","ORWDXC",42,0)
 K ORX,ORY
"RTN","ORWDXC",43,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",44,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",45,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",46,0)
 . S ORX=ORX+1
"RTN","ORWDXC",47,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_OIL(ORI,"USID")_"|"_STRT
"RTN","ORWDXC",48,0)
 . S:$P(OIL(ORI),U,2)="LR" $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",49,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ACCEPT",.OIL,.ORDODSG)
"RTN","ORWDXC",50,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",51,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",52,0)
 D FDBDOWN^ORCHECK(0)
"RTN","ORWDXC",53,0)
 D OPOS(DFN)
"RTN","ORWDXC",54,0)
 D CHK2LST
"RTN","ORWDXC",55,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",56,0)
 Q
"RTN","ORWDXC",57,0)
DELAY(LST,DFN,FID,STRT,ORL,OIL) ; Return list of Order Checks on Accept Delayed
"RTN","ORWDXC",58,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",59,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",60,0)
 N X,Y,ORCHECK,ORI,ORX,ORY,%DT
"RTN","ORWDXC",61,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",62,0)
 S ORL=ORL_";SC(",X=STRT,STRT=""
"RTN","ORWDXC",63,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",64,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",65,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",66,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",67,0)
 . S ORX=ORX+1
"RTN","ORWDXC",68,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_$$USID(OIL(ORI))_"|"_STRT
"RTN","ORWDXC",69,0)
 . I $P(OIL(ORI),U,2)="LR" S $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",70,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ALL",.OIL)
"RTN","ORWDXC",71,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",72,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",73,0)
 D CHK2LST
"RTN","ORWDXC",74,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD"),^TMP($J,"ORDSGCHK_CACHE")
"RTN","ORWDXC",75,0)
 Q
"RTN","ORWDXC",76,0)
SESSION(LST,ORVP,ORLST) ; Return list of Order Checks on Release Order
"RTN","ORWDXC",77,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",78,0)
 N ORES,ORCHECK
"RTN","ORWDXC",79,0)
 S ORVP=+ORVP_";DPT("
"RTN","ORWDXC",80,0)
 S I=0 F  S I=$O(ORLST(I)) Q:'I  D
"RTN","ORWDXC",81,0)
 . I +$P(ORLST(I),";",2)'=1 Q  ; order not new
"RTN","ORWDXC",82,0)
 . I $P(ORLST(I),U,3)="0" Q    ; order not being released
"RTN","ORWDXC",83,0)
 . S ORES($P(ORLST(I),U))=""
"RTN","ORWDXC",84,0)
 D SESSION^ORCHECK
"RTN","ORWDXC",85,0)
 D OPOS(+ORVP)
"RTN","ORWDXC",86,0)
 D CHK2LST
"RTN","ORWDXC",87,0)
 D CHECKIT(.LST)
"RTN","ORWDXC",88,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",89,0)
 Q
"RTN","ORWDXC",90,0)
SAVECHK(OK,ORVP,RSN,LST)    ; Save order checks for session
"RTN","ORWDXC",91,0)
 N ORCHECK,ORIFN S OK=1
"RTN","ORWDXC",92,0)
 D LST2CHK
"RTN","ORWDXC",93,0)
 I $L(RSN)>0 S ORCHECK("OK")=RSN
"RTN","ORWDXC",94,0)
 S ORIFN=0 F  S ORIFN=$O(ORCHECK(ORIFN)) Q:'ORIFN  D OC^ORCSAVE2
"RTN","ORWDXC",95,0)
 Q
"RTN","ORWDXC",96,0)
DELORD(OK,ORIFN)      ; Delete order
"RTN","ORWDXC",97,0)
 N STS,DIK,DA
"RTN","ORWDXC",98,0)
 S STS=$P(^OR(100,+ORIFN,8,1,0),U,15),OK=0
"RTN","ORWDXC",99,0)
 I (STS=10)!(STS=11) D  Q  ; makes sure it's an unreleased order
"RTN","ORWDXC",100,0)
 . ;*400 - Delete unused replacement order
"RTN","ORWDXC",101,0)
 . N OLDIFN,DA,DIE,DR S OLDIFN=$P(^OR(100,+ORIFN,3),U,5) I $G(OLDIFN) D
"RTN","ORWDXC",102,0)
 . . S DA=+OLDIFN,DIE="^OR(100,",DR="9.1///@"
"RTN","ORWDXC",103,0)
 . . D ^DIE K DA,DIE,DR
"RTN","ORWDXC",104,0)
 . S DA=+ORIFN,DIK="^OR(100," Q:'DA
"RTN","ORWDXC",105,0)
 . D ^DIK
"RTN","ORWDXC",106,0)
 . S OK=1
"RTN","ORWDXC",107,0)
 . D DELETE^OROCAPI1(+ORIFN)
"RTN","ORWDXC",108,0)
 Q
"RTN","ORWDXC",109,0)
USID(ORITMX) ; Return universal svc ID for an orderable item
"RTN","ORWDXC",110,0)
 ; ORITMX = OI^NMSP^PKGINFO
"RTN","ORWDXC",111,0)
 N RSLT,ORDRUG S RSLT=""
"RTN","ORWDXC",112,0)
 I $E($P(ORITMX,U,2),1,2)="PS" D
"RTN","ORWDXC",113,0)
 . I $P(ORITMX,U,2)="PSIV" D
"RTN","ORWDXC",114,0)
 . . N PSOI,TYPE,VOL S VOL=""
"RTN","ORWDXC",115,0)
 . . S PSOI=+$P($G(^ORD(101.43,+ORITMX,0)),U,2)
"RTN","ORWDXC",116,0)
 . . S TYPE=$P($P(ORITMX,U,3),";")
"RTN","ORWDXC",117,0)
 . . I TYPE="B" S VOL=$P($P(ORITMX,U,3),";",2)
"RTN","ORWDXC",118,0)
 . . D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORDRUG)
"RTN","ORWDXC",119,0)
 . . S ORDRUG=+ORDRUG
"RTN","ORWDXC",120,0)
 . E  S ORDRUG=+$P(ORITMX,U,3)
"RTN","ORWDXC",121,0)
 . S RSLT=$$ENDCM^PSJORUTL(ORDRUG)
"RTN","ORWDXC",122,0)
 . S RSLT=$P(RSLT,U,3)_"^^99NDF^"_ORDRUG_U_$$NAME50^ORPEAPI(ORDRUG)_"^99PSD"
"RTN","ORWDXC",123,0)
 E  S RSLT=$$USID^ORMBLD(+ORITMX)
"RTN","ORWDXC",124,0)
 I +$P(RSLT,U)=0,+($P(RSLT,U,4)=0) S RSLT="" ; has to be null (why?)
"RTN","ORWDXC",125,0)
 Q RSLT
"RTN","ORWDXC",126,0)
 ;
"RTN","ORWDXC",127,0)
CHK2LST ; creates list that can be passed to broker from ORCHECK array
"RTN","ORWDXC",128,0)
 ; expects ORCHECK to be present and populates LST
"RTN","ORWDXC",129,0)
 D REMDUPS ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",130,0)
 N ORIFN,ORID,CDL,I,ILST,LASTIFN,RESERVED,ORCHECK2,ORNUM,OLIST,SORT
"RTN","ORWDXC",131,0)
 S ILST=0,LASTIFN=0,RESERVED=0,OLIST=0,SORT=""
"RTN","ORWDXC",132,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",133,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",134,0)
 . . S SORT=$S(+SORT=0:CDL,CDL<+SORT:CDL,1:+SORT)
"RTN","ORWDXC",135,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",136,0)
 . . . S ORCHECK2(ORIFN,CDL,+ORCHECK(ORIFN,CDL,I),I)=ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",137,0)
 . S:SORT'="" SORT(SORT,ORIFN)="",SORT=""
"RTN","ORWDXC",138,0)
 K ORCHECK
"RTN","ORWDXC",139,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK2(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",140,0)
 . S CDL=0 F  S CDL=$O(ORCHECK2(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",141,0)
 . . S ORNUM=0 F  S ORNUM=$O(ORCHECK2(ORIFN,CDL,ORNUM)) Q:'ORNUM  D
"RTN","ORWDXC",142,0)
 . . . S I=0 F  S I=$O(ORCHECK2(ORIFN,CDL,ORNUM,I)) Q:'I  D
"RTN","ORWDXC",143,0)
 . . . . S OLIST=OLIST+1,ORCHECK(ORIFN,CDL,OLIST)=ORCHECK2(ORIFN,CDL,ORNUM,I)
"RTN","ORWDXC",144,0)
 S SORT=0 F  S SORT=$O(SORT(SORT)) Q:'SORT  D
"RTN","ORWDXC",145,0)
 . S ORIFN="" F  S ORIFN=$O(SORT(SORT,ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",146,0)
 . . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",147,0)
 . . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",148,0)
 . . . . I LASTIFN'=ORIFN S LASTIFN=ORIFN,RESERVED=ILST+1,ILST=ILST+1 ; saves a spot for the RDI warning at the top of each order's checks
"RTN","ORWDXC",149,0)
 . . . . S ORID=ORIFN I +ORID,(+ORID=ORID) S ORID=ORID_";1"
"RTN","ORWDXC",150,0)
 . . . . I '$P(ORCHECK(ORIFN,CDL,I),U,2) Q  ; CDL="" means don't show
"RTN","ORWDXC",151,0)
 . . . . I $P(ORCHECK(ORIFN,CDL,I),U,1)=99 S LST(RESERVED)=ORID_U_ORCHECK(ORIFN,CDL,I) Q  ;Put RDI warning at the top of each order's checks
"RTN","ORWDXC",152,0)
 . . . . S ILST=ILST+1,LST(ILST)=ORID_U_ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",153,0)
 Q
"RTN","ORWDXC",154,0)
LST2CHK ; create ORCHECK array from list passed by broker
"RTN","ORWDXC",155,0)
 N ORIFN,CDL,I,ILST S I=0
"RTN","ORWDXC",156,0)
 S ILST="" F  S ILST=$O(LST("ORCHECKS",ILST)) Q:$L(ILST)'>0  D
"RTN","ORWDXC",157,0)
 . I $D(LST("ORCHECKS",ILST,0)) D
"RTN","ORWDXC",158,0)
 . . N J S J=0 S X=LST("ORCHECKS",ILST,J) F  S J=$O(LST("ORCHECKS",ILST,J)) Q:'J  S X=X_LST("ORCHECKS",ILST,J)
"RTN","ORWDXC",159,0)
 . I '$D(LST("ORCHECKS",ILST,0)) S X=LST("ORCHECKS",ILST)
"RTN","ORWDXC",160,0)
 . S ORIFN=$P(X,U),CDL=$P(X,U,3)
"RTN","ORWDXC",161,0)
 . I +$G(ORIFN)>0,+$G(CDL)>0 D  ;cla 12/16/03
"RTN","ORWDXC",162,0)
 . . S I=I+1,ORCHECK(+ORIFN,CDL,I)=$P(X,U,2,4)
"RTN","ORWDXC",163,0)
 Q
"RTN","ORWDXC",164,0)
CHECKIT(X) ;remove uncessesary duplication of Duplicate Therapy checks
"RTN","ORWDXC",165,0)
 N I,J,Y
"RTN","ORWDXC",166,0)
 S I=0 F  S I=$O(X(I)) Q:'I  I $P(X(I),U,2)=17 D
"RTN","ORWDXC",167,0)
 .Q:$P($G(^ORD(100.8,17,0)),U)'="DUPLICATE DRUG THERAPY"
"RTN","ORWDXC",168,0)
 .N STR S STR=$P($P(X(I),"{",2),"}")
"RTN","ORWDXC",169,0)
 .S J=0 F  S J=J+1 Q:J>$L(STR,", ")  S Y(+X(I),I,J)=$P(STR,", ",J)
"RTN","ORWDXC",170,0)
 S I=0 F  S I=$O(Y(I)) Q:'I  D
"RTN","ORWDXC",171,0)
 .S J=0 F  S J=$O(Y(I,J)) Q:'J  D
"RTN","ORWDXC",172,0)
 ..S K=J F  S K=$O(Y(I,K)) Q:'K!('$D(Y(I,J)))  D
"RTN","ORWDXC",173,0)
 ...N A,B M A=Y(I,J),B=Y(I,K)
"RTN","ORWDXC",174,0)
 ...I $$AINB(.A,.B) K X(J),Y(I,J)
"RTN","ORWDXC",175,0)
 ...Q:'$D(Y(I,J))
"RTN","ORWDXC",176,0)
 ...I $$AINB(.B,.A) K X(K),Y(I,K)
"RTN","ORWDXC",177,0)
 Q
"RTN","ORWDXC",178,0)
AINB(A,B) ;if array A is a subset of array B then return 1, else return 0
"RTN","ORWDXC",179,0)
 N I,RET
"RTN","ORWDXC",180,0)
 S RET=1
"RTN","ORWDXC",181,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I '$$XINA(A(I),.B) S RET=0 Q
"RTN","ORWDXC",182,0)
 Q RET
"RTN","ORWDXC",183,0)
XINA(X,A) ;if string X is an entry in array A then return 1, else return 0
"RTN","ORWDXC",184,0)
 N I,RET
"RTN","ORWDXC",185,0)
 S RET=0
"RTN","ORWDXC",186,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I X=A(I) S RET=1 Q
"RTN","ORWDXC",187,0)
 Q RET
"RTN","ORWDXC",188,0)
REMDUPS ;
"RTN","ORWDXC",189,0)
 N IFN,CDL,I,J,CDL2 S IFN="NEW"
"RTN","ORWDXC",190,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",191,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",192,0)
 .. S CDL2=0 F  S CDL2=$O(ORCHECK(IFN,CDL2)) Q:'CDL2  D
"RTN","ORWDXC",193,0)
 ... S J=I F  S J=$O(ORCHECK(IFN,CDL2,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL2,J)),U,3),";",",") D
"RTN","ORWDXC",194,0)
 .... I CDL2<=CDL K ORCHECK(IFN,CDL2,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",195,0)
 .... I CDL2>CDL S $P(ORCHECK(IFN,CDL,I),U,7)="X"
"RTN","ORWDXC",196,0)
 .. I $P(ORCHECK(IFN,CDL,I),U,7)="X" K ORCHECK(IFN,CDL,I) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",197,0)
 Q
"RTN","ORWDXC",198,0)
REMDUPSX ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",199,0)
 N IFN,CDL,I S IFN="NEW"
"RTN","ORWDXC",200,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",201,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",202,0)
 . . S J=I F  S J=$O(ORCHECK(IFN,CDL,J)) Q:'J  I $G(ORCHECK(IFN,CDL,I))=$G(ORCHECK(IFN,CDL,J)) K ORCHECK(IFN,CDL,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",203,0)
 Q
"RTN","ORWDXC",204,0)
OPOS(DFN) ;handles saving and removing order checks that should only be displayed once per cprs session
"RTN","ORWDXC",205,0)
 ; expects ORCHECK
"RTN","ORWDXC",206,0)
 ; sets these order checks into the "Once Per cprs Session" global ^TMP($J,"OC-OPOS",DFN)
"RTN","ORWDXC",207,0)
 N I,J,K
"RTN","ORWDXC",208,0)
 S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORWDXC",209,0)
 .S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORWDXC",210,0)
 ..S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORWDXC",211,0)
 ...N ORTXT,ORTXTO,ORTXT0,ORTXTI,ORXTRAI
"RTN","ORWDXC",212,0)
 ...S ORTXTO="These checks could not be completed for this patient:"
"RTN","ORWDXC",213,0)
 ...Q:(ORCHECK(I,J,K)'[ORTXTO)
"RTN","ORWDXC",214,0)
 ...S ORTXT=ORTXTO
"RTN","ORWDXC",215,0)
 ...S ORXTRAI=$P($P(ORCHECK(I,J,K),"||",2),"&")
"RTN","ORWDXC",216,0)
 ...S ORTXTI=0 F  S ORTXTI=$O(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))  Q:'ORTXTI  D
"RTN","ORWDXC",217,0)
 ....S ORTXT=ORTXT_$G(^TMP($J,"ORK XTRA TXT",ORXTRAI,ORTXTO,ORTXTI))
"RTN","ORWDXC",218,0)
 ...I $D(^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))) K ORCHECK(I,J,K) Q
"RTN","ORWDXC",219,0)
 ...S ^TMP($J,"OC-OPOS",DFN,$E(ORTXT,1,225))="" Q
"RTN","ORWDXC",220,0)
 Q
"RTN","ORY269")
0^^B18452228
"RTN","ORY269",1,0)
ORY269 ;ISP/RFR - DATA DICTIONARY CLEANUP ;12/15/2015  12:01
"RTN","ORY269",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17, 1997;Build 85
"RTN","ORY269",3,0)
 Q
"RTN","ORY269",4,0)
PRE ;Pre-install
"RTN","ORY269",5,0)
 ;IF THE FILE ALREADY EXITS, DELETE THE DATA DICTIONARY
"RTN","ORY269",6,0)
 I $D(^DIC(100.05))>0 D
"RTN","ORY269",7,0)
 .N FILE
"RTN","ORY269",8,0)
 .D FILE^DID(100.05,,"NAME","FILE")
"RTN","ORY269",9,0)
 .D BMES^XPDUTL("Deleting existing "_$G(FILE("NAME"))_" data dictionary while preserving data...")
"RTN","ORY269",10,0)
 .N DIU
"RTN","ORY269",11,0)
 .S DIU="^ORD(100.05,",DIU(0)="T"
"RTN","ORY269",12,0)
 .D EN^DIU2
"RTN","ORY269",13,0)
 .D MES^XPDUTL("DONE")
"RTN","ORY269",14,0)
 Q
"RTN","ORY269",15,0)
POST ;Post-install
"RTN","ORY269",16,0)
 I '$D(^ORD(100.8,99)) D
"RTN","ORY269",17,0)
 .D BMES^XPDUTL("Creating new ORDER CHECKS entry...")
"RTN","ORY269",18,0)
 .N FDA,IEN,DESCRIPTION,ERROR
"RTN","ORY269",19,0)
 .S FDA(100.8,"+1,",.01)="REMOTE DATA UNAVAILABLE"
"RTN","ORY269",20,0)
 .S FDA(100.8,"+1,",2)="DESCRIPTION"
"RTN","ORY269",21,0)
 .S DESCRIPTION(1,0)="Triggered by the order checking system, this order check is generated when"
"RTN","ORY269",22,0)
 .S DESCRIPTION(2,0)="the remote data interoperability (RDI) client is unable to obtain all"
"RTN","ORY269",23,0)
 .S DESCRIPTION(3,0)="available data from the Health Data Repository (HDR)."
"RTN","ORY269",24,0)
 .S IEN(1)=99
"RTN","ORY269",25,0)
 .D UPDATE^DIE(,"FDA","IEN","ERROR")
"RTN","ORY269",26,0)
 .I $D(ERROR) D ERROR("Unable to add the REMOTE DATA UNAVAILABLE entry",.ERROR)
"RTN","ORY269",27,0)
 .I '$D(ERROR) D MES^XPDUTL("DONE")
"RTN","ORY269",28,0)
 D ^ORY269ES
"RTN","ORY269",29,0)
 N FILE
"RTN","ORY269",30,0)
 I $Q(^ORD(100.05,0))']"^ORD(100.05," D BMES^XPDUTL("No data to convert.") Q
"RTN","ORY269",31,0)
 D FILE^DID(100.05,,"NAME","FILE")
"RTN","ORY269",32,0)
 D BMES^XPDUTL("Converting existing data in the "_$G(FILE("NAME"))_" file...")
"RTN","ORY269",33,0)
 N XPDIDTOT,RECCOUNT
"RTN","ORY269",34,0)
 S XPDIDTOT=+$P(^ORD(100.05,0),U,4),RECCOUNT=0
"RTN","ORY269",35,0)
 D UPDATE^XPDID(RECCOUNT)
"RTN","ORY269",36,0)
 N I
"RTN","ORY269",37,0)
 S I=0 F  S I=$O(^ORD(100.05,I)) Q:'I  D
"RTN","ORY269",38,0)
 .I $D(^ORD(100.05,I,2)) D
"RTN","ORY269",39,0)
 ..N COUNT
"RTN","ORY269",40,0)
 ..S COUNT=$O(^ORD(100.05,I,2,"?"),-1)
"RTN","ORY269",41,0)
 ..I $P(^ORD(100.05,I,2,0),U,3,4)'=(COUNT_U_COUNT) S $P(^ORD(100.05,I,2,0),U,3,5)=COUNT_U_COUNT_U_DT
"RTN","ORY269",42,0)
 .I $D(^ORD(100.05,I,4)),('$D(^ORD(100.05,I,5))) D
"RTN","ORY269",43,0)
 ..N X,P01
"RTN","ORY269",44,0)
 ..S X=0 F  S X=$O(^ORD(100.05,I,4,X)) Q:'X  D
"RTN","ORY269",45,0)
 ...N DAT,DRG,CUA,INT,DB,LOC,OH,SEV
"RTN","ORY269",46,0)
 ...S DAT=^ORD(100.05,I,4,X,0),DRG=$P(DAT,U),LOC=$P(DAT,U,2),CUA=$P(DAT,U,3),INT=$P(DAT,U,5),DB=$P(DAT,U,6)
"RTN","ORY269",47,0)
 ...S OH=$P(DAT,U,7),SEV=$P(DAT,U,8)
"RTN","ORY269",48,0)
 ...I $G(DRG)]"",($D(^PSDRUG(DRG))) D
"RTN","ORY269",49,0)
 ....S ^ORD(100.05,I,5,0)="100.06PA^1^1",^ORD(100.05,I,5,1,0)=DRG,^ORD(100.05,I,5,"B",DRG,1)=""
"RTN","ORY269",50,0)
 ....S $P(^ORD(100.05,I,4,X,0),U)="" K ^ORD(100.05,I,4,"B",DRG,X)
"RTN","ORY269",51,0)
 ...I $G(INT)]"",($D(^APSPQA(32.4,INT))) S ^ORD(100.05,I,8)=INT,$P(^ORD(100.05,I,4,X,0),U,5)=""
"RTN","ORY269",52,0)
 ...I $G(CUA)[";" D
"RTN","ORY269",53,0)
 ....N NODE S NODE=U_$P(CUA,";",2)_$P(CUA,";")_")"
"RTN","ORY269",54,0)
 ....I $D(@NODE) S $P(^ORD(100.05,I,4,X,0),U,2)=CUA,$P(^ORD(100.05,I,4,X,0),U,3)=""
"RTN","ORY269",55,0)
 ...I "^L^R^"[(U_$G(LOC)_U) S $P(^ORD(100.05,I,4,X,0),U,3)=LOC
"RTN","ORY269",56,0)
 ...I "^C^V^"[(U_$G(DB)_U) S $P(^ORD(100.05,I,8),U,4)=DB,$P(^ORD(100.05,I,4,X,0),U,6)=""
"RTN","ORY269",57,0)
 ...I $P(^ORD(100.05,I,4,X,0),U)="" D
"RTN","ORY269",58,0)
 ....I $P(^ORD(100.05,I,4,X,0),U,2)["50.605" D
"RTN","ORY269",59,0)
 .....S $P(^ORD(100.05,I,4,X,0),U)=$$GET1^DIQ(50.605,$P($P(^ORD(100.05,I,4,X,0),U,2),";")_",",1)
"RTN","ORY269",60,0)
 ....I $P(^ORD(100.05,I,4,X,0),U,2)'["50.605" D
"RTN","ORY269",61,0)
 .....S $P(^ORD(100.05,I,4,X,0),U)=$$EXTERNAL^DILFD(100.517,2,,$P(^ORD(100.05,I,4,X,0),U,2))
"RTN","ORY269",62,0)
 ....S P01=$P(^ORD(100.05,I,4,X,0),U) I P01'="" S ^ORD(100.05,I,4,"B",P01,X)=""
"RTN","ORY269",63,0)
 ....I P01="" D 
"RTN","ORY269",64,0)
 .....N MSGS S MSGS(1)="Record #"_I_" is corrupt.",MSGS(2)="The .01 field does not have a valid value."
"RTN","ORY269",65,0)
 .....S MSGS(3)="Please contact your help desk for assistance in correcting this record."
"RTN","ORY269",66,0)
 .....D BMES^XPDUTL(.MSGS)
"RTN","ORY269",67,0)
 ...I "^O^H^"[(U_$G(OH)_U) S $P(^ORD(100.05,I,4,X,0),U,6)=OH,$P(^ORD(100.05,I,4,X,0),U,7)=""
"RTN","ORY269",68,0)
 ...I "^1^2^3^"[(U_$G(SEV)_U) S $P(^ORD(100.05,I,4,X,0),U,7)=SEV,$P(^ORD(100.05,I,4,X,0),U,8)=""
"RTN","ORY269",69,0)
 ...I $L(^ORD(100.05,I,4,X,0),U)=8 S ^ORD(100.05,I,4,X,0)=$P(^ORD(100.05,I,4,X,0),U,1,7)
"RTN","ORY269",70,0)
 .I $D(^ORD(100.05,I,15)) D
"RTN","ORY269",71,0)
 ..S $P(^ORD(100.05,I,11),U,3)=$P(^ORD(100.05,I,15),U,1)
"RTN","ORY269",72,0)
 ..K ^ORD(100.05,I,15)
"RTN","ORY269",73,0)
 .S RECCOUNT=RECCOUNT+1 D:'(RECCOUNT#100) UPDATE^XPDID(RECCOUNT)
"RTN","ORY269",74,0)
 D UPDATE^XPDID(XPDIDTOT)
"RTN","ORY269",75,0)
 D MES^XPDUTL("DONE")
"RTN","ORY269",76,0)
 Q
"RTN","ORY269",77,0)
ERROR(TEXT,ERROR) ;OUTPUT FILEMAN ERROR MESSAGE(S)
"RTN","ORY269",78,0)
 N ORMSG,IDX
"RTN","ORY269",79,0)
 S ORMSG(1)=" "
"RTN","ORY269",80,0)
 S ORMSG(2)="ERROR: "_TEXT_"."
"RTN","ORY269",81,0)
 S ORMSG(3)="VA FileMan Error #"_ERROR("DIERR",1)_":"
"RTN","ORY269",82,0)
 F IDX=1:1:+$O(ERROR("DIERR",1,"TEXT","A"),-1) D
"RTN","ORY269",83,0)
 .S ORMSG(IDX+2)=ERROR("DIERR",1,"TEXT",IDX)
"RTN","ORY269",84,0)
 D BMES^XPDUTL(.ORMSG)
"RTN","ORY269",85,0)
 Q
"RTN","ORY2690")
0^20^B15650231
"RTN","ORY2690",1,0)
ORY2690 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY2690",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY2690",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY2690",4,0)
 ;
"RTN","ORY2690",5,0)
S ;
"RTN","ORY2690",6,0)
 ;
"RTN","ORY2690",7,0)
 Q
"RTN","ORY2690",8,0)
 ;
"RTN","ORY2690",9,0)
WARN(RTN,MSG,LINES) ;
"RTN","ORY2690",10,0)
 ;
"RTN","ORY2690",11,0)
 Q:$G(OCXAUTO)
"RTN","ORY2690",12,0)
 ;
"RTN","ORY2690",13,0)
 N DASH,LINE,NLINE,PLINE
"RTN","ORY2690",14,0)
 ;
"RTN","ORY2690",15,0)
 S DASH="",$P(DASH,"-",(55-$L(MSG)-2))="-"
"RTN","ORY2690",16,0)
 W !!,"--------------",MSG,DASH
"RTN","ORY2690",17,0)
 ;
"RTN","ORY2690",18,0)
 W !,RTN,?10,"[CPRS30.FO.DOMAIN.EXT] -> [",$$NETNAME^OCXSEND,"] Line"
"RTN","ORY2690",19,0)
 ;
"RTN","ORY2690",20,0)
 I $O(LINES($O(LINES(0)))) W "s: "
"RTN","ORY2690",21,0)
 E  W ": "
"RTN","ORY2690",22,0)
 ;
"RTN","ORY2690",23,0)
 S LINE=0 F  S LINE=$O(LINES(LINE)) Q:'LINE  D
"RTN","ORY2690",24,0)
 .W:($X>60) !,?40
"RTN","ORY2690",25,0)
 .S NLINE=LINE F  S PLINE=NLINE,NLINE=$O(LINES(NLINE)) Q:(NLINE-PLINE-1)
"RTN","ORY2690",26,0)
 .I (PLINE=LINE) W " ",LINE
"RTN","ORY2690",27,0)
 .E  W " ",LINE,"-",PLINE S LINE=PLINE
"RTN","ORY2690",28,0)
 ;
"RTN","ORY2690",29,0)
 W ! Q
"RTN","ORY2690",30,0)
 ;
"RTN","ORY2690",31,0)
TEXT(RTN,LINE) ;
"RTN","ORY2690",32,0)
 ;
"RTN","ORY2690",33,0)
 N TEXT X "S TEXT=$T(+"_(+LINE)_"^"_RTN_")" Q TEXT
"RTN","ORY2690",34,0)
 ;
"RTN","ORY2690",35,0)
HEADER ;
"RTN","ORY2690",36,0)
 ;
"RTN","ORY2690",37,0)
 W !," Created: JUL 26,2013 at 06:56  at  CPRS30.FO.DOMAIN.EXT"
"RTN","ORY2690",38,0)
 W !," Current Date: ",$$NOW,"  at  ",$$NETNAME^OCXSEND,!!
"RTN","ORY2690",39,0)
 S LASTFILE=0 K ^TMP("OCXRULE",$J)
"RTN","ORY2690",40,0)
 S ^TMP("OCXRULE",$J)=($P($H,",",2)+($H*86400)+(1*60*60))_" <- ^TMP ENTRY EXPIRATION DATE FOR ^OCXOPURG"
"RTN","ORY2690",41,0)
 Q
"RTN","ORY2690",42,0)
 ;
"RTN","ORY2690",43,0)
GETFILE(FILE,RECNAME,ARRAY) ;
"RTN","ORY2690",44,0)
 ;
"RTN","ORY2690",45,0)
 N CHECK,GLNEXT,GLREF,LINES,REC,DD,FLD
"RTN","ORY2690",46,0)
 S REC=$$LOOKUP(FILE,RECNAME)
"RTN","ORY2690",47,0)
 I 'REC W !!,$$FILENAME^OCXSENDD(FILE),": ",RECNAME Q 0
"RTN","ORY2690",48,0)
 I (REC=-1) W !!,$$FILENAME^OCXSENDD(FILE),": ",RECNAME,"  duplicate local entries.",! Q 0
"RTN","ORY2690",49,0)
 I (REC=-2) W !!,$$FILENAME^OCXSENDD(FILE)," (",FILE,") local file not found." W ! Q:$$PAUSE -10 Q REC
"RTN","ORY2690",50,0)
 I (REC<0) W !!,$$FILENAME^OCXSENDD(FILE),": ",RECNAME,"  unknown lookup error." W ! Q:$$PAUSE -10 Q REC
"RTN","ORY2690",51,0)
 I (REC>0) D
"RTN","ORY2690",52,0)
 .S CHECK=0,LINES=0
"RTN","ORY2690",53,0)
 .D GETREC($$FILE^OCXSENDD(FILE,"GLOBAL NAME"),"ARRAY(",REC,.ARRAY)
"RTN","ORY2690",54,0)
 .S GLREF="ARRAY" F  S GLREF=$Q(@GLREF) Q:'$L(GLREF)  Q:'($E(GLREF,1,6)="ARRAY(")  K:'$L(@GLREF) @GLREF
"RTN","ORY2690",55,0)
 ;
"RTN","ORY2690",56,0)
 Q REC
"RTN","ORY2690",57,0)
 ;
"RTN","ORY2690",58,0)
LKUPARRY(DD,KEY,ARRAY) ;
"RTN","ORY2690",59,0)
 ;
"RTN","ORY2690",60,0)
 N D0 S D0=0 F  S D0=$O(ARRAY(DD,D0)) Q:'D0  Q:($G(ARRAY(DD,D0,.01,"E"))=KEY)
"RTN","ORY2690",61,0)
 Q D0
"RTN","ORY2690",62,0)
 ;
"RTN","ORY2690",63,0)
LOOKUP(FILE,KEY) ;
"RTN","ORY2690",64,0)
 I $O(^TMP("OCXRULE",$J,"B",FILE,KEY,0)) Q 0
"RTN","ORY2690",65,0)
 N RECNAM,REC,D0,CNT,SHORT S (REC,CNT)=0
"RTN","ORY2690",66,0)
 S GL=$$FILE^OCXSENDD(FILE,"GLOBAL NAME") Q:'$L(GL) -2 S GL=$E(GL,1,$L(GL)-1)_")"
"RTN","ORY2690",67,0)
 S SHORT=$E(KEY,1,30),RECNAM=SHORT D  F  S RECNAM=$O(@GL@("B",RECNAM)) Q:'$L(RECNAM)  Q:'($E(RECNAM,1,$L(SHORT))=SHORT)  D
"RTN","ORY2690",68,0)
 .S D0=0 F  S D0=$O(@GL@("B",RECNAM,D0)) Q:'D0  I ($P($G(@GL@(D0,0)),U,1)=KEY) S CNT=CNT+1,REC=D0_U_RECNAME
"RTN","ORY2690",69,0)
 Q:(CNT>1) -1
"RTN","ORY2690",70,0)
 S:$L($P(REC,U,2)) ^TMP("OCXRULE",$J,"A",FILE,$P(REC,U,2))=""
"RTN","ORY2690",71,0)
 Q +REC
"RTN","ORY2690",72,0)
 ;
"RTN","ORY2690",73,0)
GETREC(GL,PATH,D0,REM) ;
"RTN","ORY2690",74,0)
 ;
"RTN","ORY2690",75,0)
 Q:'($P($G(@(GL_"0)")),U,2))
"RTN","ORY2690",76,0)
 N S1,DATA,DD
"RTN","ORY2690",77,0)
 S DATA="" D DIQ(GL,D0,.DATA)
"RTN","ORY2690",78,0)
 S DD=$O(DATA(0)) Q:'DD
"RTN","ORY2690",79,0)
 ;
"RTN","ORY2690",80,0)
 I $L($$FILE^OCXSENDD(DD,"NAME")) S PATH=PATH_""""_DD_":"_D0_""""
"RTN","ORY2690",81,0)
 I '$L($$FILE^OCXSENDD(DD,"NAME")) S PATH=PATH_","""_DD_":"_D0_""""
"RTN","ORY2690",82,0)
 M @(PATH_")")=DATA(DD,D0)
"RTN","ORY2690",83,0)
 ;
"RTN","ORY2690",84,0)
 S S1="" F  S S1=$O(@(GL_D0_","_$$SUB(S1)_")")) Q:'$L(S1)  I ($D(@(GL_D0_","_$$SUB(S1)_")"))>3) D
"RTN","ORY2690",85,0)
 .N D1,GLREF S GLREF=GL_D0_","_$$SUB(S1)_","
"RTN","ORY2690",86,0)
 .S D1=0 F  S D1=$O(@(GLREF_D1_")")) Q:'D1  D GETREC(GLREF,PATH,D1,.REM)
"RTN","ORY2690",87,0)
 ;
"RTN","ORY2690",88,0)
 Q
"RTN","ORY2690",89,0)
 ;
"RTN","ORY2690",90,0)
SUB(X) Q:'(X=+X) """"_X_"""" Q X
"RTN","ORY2690",91,0)
 ;
"RTN","ORY2690",92,0)
DIQ(DIC,DA,OCXARY) ;
"RTN","ORY2690",93,0)
 N DR,DIQ S DR=".01:99999",DIQ="OCXARY(",DIQ(0)="EN" D EN^DIQ1
"RTN","ORY2690",94,0)
 Q
"RTN","ORY2690",95,0)
 ;
"RTN","ORY2690",96,0)
PAUSE() W "  Press Enter " R X:DTIME W ! Q (X[U)
"RTN","ORY2690",97,0)
 ;
"RTN","ORY2690",98,0)
NOW() N X,Y,%DT S X="N",%DT="T" D ^%DT S Y=$$DATE^OCXSENDD(Y) S:(Y["@") Y=$P(Y,"@",1)_" at "_$P(Y,"@",2) Q Y
"RTN","ORY2690",99,0)
 ;
"RTN","ORY26901")
0^10^B70829648
"RTN","ORY26901",1,0)
ORY26901 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY26901",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY26901",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY26901",4,0)
 ;
"RTN","ORY26901",5,0)
S ;
"RTN","ORY26901",6,0)
 ;
"RTN","ORY26901",7,0)
 D DOT^ORY269ES
"RTN","ORY26901",8,0)
 ;
"RTN","ORY26901",9,0)
 ;
"RTN","ORY26901",10,0)
 K REMOTE,LOCAL,OPCODE,REF
"RTN","ORY26901",11,0)
 F LINE=1:1:500 S TEXT=$P($T(DATA+LINE),";",2,999) Q:TEXT  I $L(TEXT) D  Q:QUIT
"RTN","ORY26901",12,0)
 .S ^TMP("OCXRULE",$J,$O(^TMP("OCXRULE",$J,"A"),-1)+1)=TEXT
"RTN","ORY26901",13,0)
 ;
"RTN","ORY26901",14,0)
 G ^ORY26902
"RTN","ORY26901",15,0)
 ;
"RTN","ORY26901",16,0)
 Q
"RTN","ORY26901",17,0)
 ;
"RTN","ORY26901",18,0)
DATA ;
"RTN","ORY26901",19,0)
 ;
"RTN","ORY26901",20,0)
 ;;ROOT^OCXS(860.2,0)^ORDER CHECK RULE^860.2I
"RTN","ORY26901",21,0)
 ;;ROOT^OCXS(860.3,0)^ORDER CHECK ELEMENT^860.3
"RTN","ORY26901",22,0)
 ;;ROOT^OCXS(860.4,0)^ORDER CHECK DATA FIELD^860.4I
"RTN","ORY26901",23,0)
 ;;ROOT^OCXS(860.5,0)^ORDER CHECK DATA SOURCE^860.5
"RTN","ORY26901",24,0)
 ;;ROOT^OCXS(860.6,0)^ORDER CHECK DATA CONTEXT^860.6
"RTN","ORY26901",25,0)
 ;;ROOT^OCXS(860.8,0)^ORDER CHECK COMPILER FUNCTIONS^860.8
"RTN","ORY26901",26,0)
 ;;ROOT^OCXS(860.9,0)^ORDER CHECK NATIONAL TERM^860.9
"RTN","ORY26901",27,0)
 ;;ROOT^OCXS(863,0)^OCX MDD CLASS^863
"RTN","ORY26901",28,0)
 ;;ROOT^OCXS(863.1,0)^OCX MDD APPLICATION^863.1
"RTN","ORY26901",29,0)
 ;;ROOT^OCXS(863.2,0)^OCX MDD SUBJECT^863.2
"RTN","ORY26901",30,0)
 ;;ROOT^OCXS(863.3,0)^OCX MDD LINK^863.3I
"RTN","ORY26901",31,0)
 ;;ROOT^OCXS(863.4,0)^OCX MDD ATTRIBUTE^863.4
"RTN","ORY26901",32,0)
 ;;ROOT^OCXS(863.5,0)^OCX MDD VALUES^863.5
"RTN","ORY26901",33,0)
 ;;ROOT^OCXS(863.6,0)^OCX MDD METHOD^863.6
"RTN","ORY26901",34,0)
 ;;ROOT^OCXS(863.7,0)^OCX MDD PUBLIC FUNCTION^863.7
"RTN","ORY26901",35,0)
 ;;ROOT^OCXS(863.8,0)^OCX MDD PARAMETER^863.8
"RTN","ORY26901",36,0)
 ;;ROOT^OCXS(863.9,0)^OCX MDD CONDITION/FUNCTION^863.9I
"RTN","ORY26901",37,0)
 ;;ROOT^OCXS(864,0)^OCX MDD SITE PREFERENCES^864P
"RTN","ORY26901",38,0)
 ;;ROOT^OCXS(864.1,0)^OCX MDD DATATYPE^864.1
"RTN","ORY26901",39,0)
 ;;ROOT^OCXD(860.1,0)^ORDER CHECK PATIENT ACTIVE DATA^860.1P
"RTN","ORY26901",40,0)
 ;;ROOT^OCXD(860.7,0)^ORDER CHECK PATIENT RULE EVENT^860.7P
"RTN","ORY26901",41,0)
 ;;ROOT^OCXD(861,0)^ORDER CHECK RAW DATA LOG^861
"RTN","ORY26901",42,0)
 ;;SOF^863.8  OCX MDD PARAMETER
"RTN","ORY26901",43,0)
 ;;KEY^863.8:^DATA TYPE
"RTN","ORY26901",44,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",45,0)
 ;;D^DATA TYPE
"RTN","ORY26901",46,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",47,0)
 ;;D^DATA TYPE
"RTN","ORY26901",48,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",49,0)
 ;;D^An MDD data type; i.e., an entry in the OCX MDD DATA TYPE file.
"RTN","ORY26901",50,0)
 ;;R^"863.8:","863.84:6",.01,"E"
"RTN","ORY26901",51,0)
 ;;D^QUERY
"RTN","ORY26901",52,0)
 ;;R^"863.8:","863.84:6",1,"E"
"RTN","ORY26901",53,0)
 ;;D^Enter the datatype
"RTN","ORY26901",54,0)
 ;;R^"863.8:","863.84:7",.01,"E"
"RTN","ORY26901",55,0)
 ;;D^DIC
"RTN","ORY26901",56,0)
 ;;R^"863.8:","863.84:7",1,"E"
"RTN","ORY26901",57,0)
 ;;D^864.1
"RTN","ORY26901",58,0)
 ;;R^"863.8:","863.84:8",.01,"E"
"RTN","ORY26901",59,0)
 ;;D^DATA TYPE
"RTN","ORY26901",60,0)
 ;;R^"863.8:","863.84:8",1,"E"
"RTN","ORY26901",61,0)
 ;;D^POINTER TO A FILEMAN FILE
"RTN","ORY26901",62,0)
 ;;R^"863.8:","863.84:9",.01,"E"
"RTN","ORY26901",63,0)
 ;;D^DIC LOOKUP INDEX STRING
"RTN","ORY26901",64,0)
 ;;R^"863.8:","863.84:9",1,"E"
"RTN","ORY26901",65,0)
 ;;D^B^C
"RTN","ORY26901",66,0)
 ;;EOR^
"RTN","ORY26901",67,0)
 ;;KEY^863.8:^DIC
"RTN","ORY26901",68,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",69,0)
 ;;D^DIC
"RTN","ORY26901",70,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",71,0)
 ;;D^DIC
"RTN","ORY26901",72,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",73,0)
 ;;D^An open reference used to specify the file in a DIC lookup
"RTN","ORY26901",74,0)
 ;;R^"863.8:","863.84:1",.01,"E"
"RTN","ORY26901",75,0)
 ;;D^DATA TYPE
"RTN","ORY26901",76,0)
 ;;R^"863.8:","863.84:1",1,"E"
"RTN","ORY26901",77,0)
 ;;D^POINTER TO A FILEMAN FILE
"RTN","ORY26901",78,0)
 ;;R^"863.8:","863.84:2",.01,"E"
"RTN","ORY26901",79,0)
 ;;D^DIC
"RTN","ORY26901",80,0)
 ;;R^"863.8:","863.84:2",1,"E"
"RTN","ORY26901",81,0)
 ;;D^1
"RTN","ORY26901",82,0)
 ;;R^"863.8:","863.84:3",.01,"E"
"RTN","ORY26901",83,0)
 ;;D^QUERY
"RTN","ORY26901",84,0)
 ;;R^"863.8:","863.84:3",1,"E"
"RTN","ORY26901",85,0)
 ;;D^Enter the name of the file you are pointing to
"RTN","ORY26901",86,0)
 ;;EOR^
"RTN","ORY26901",87,0)
 ;;KEY^863.8:^DIC LOOKUP INDEX STRING
"RTN","ORY26901",88,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",89,0)
 ;;D^DIC LOOKUP INDEX STRING
"RTN","ORY26901",90,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",91,0)
 ;;D^DICIX
"RTN","ORY26901",92,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",93,0)
 ;;D^Contains the names of indices to be used in a DIC lookup in a comma
"RTN","ORY26901",94,0)
 ;;R^"863.8:",1,2
"RTN","ORY26901",95,0)
 ;;D^delimited string.
"RTN","ORY26901",96,0)
 ;;R^"863.8:","863.84:1",.01,"E"
"RTN","ORY26901",97,0)
 ;;D^DATA TYPE
"RTN","ORY26901",98,0)
 ;;R^"863.8:","863.84:1",1,"E"
"RTN","ORY26901",99,0)
 ;;D^FREE TEXT
"RTN","ORY26901",100,0)
 ;;R^"863.8:","863.84:2",.01,"E"
"RTN","ORY26901",101,0)
 ;;D^QUERY
"RTN","ORY26901",102,0)
 ;;R^"863.8:","863.84:2",1,"E"
"RTN","ORY26901",103,0)
 ;;D^Enter a DIC lookup index string
"RTN","ORY26901",104,0)
 ;;R^"863.8:","863.84:3",.01,"E"
"RTN","ORY26901",105,0)
 ;;D^HELP MESSAGE
"RTN","ORY26901",106,0)
 ;;R^"863.8:","863.84:3",1,"E"
"RTN","ORY26901",107,0)
 ;;D^This is an '^' delimited string which contains the names of indices which are to be used in a DIC lookup; e.g., B^C^DOB.
"RTN","ORY26901",108,0)
 ;;EOR^
"RTN","ORY26901",109,0)
 ;;KEY^863.8:^FILE
"RTN","ORY26901",110,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",111,0)
 ;;D^FILE
"RTN","ORY26901",112,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",113,0)
 ;;D^FILE
"RTN","ORY26901",114,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",115,0)
 ;;D^The internal entry number of a file.
"RTN","ORY26901",116,0)
 ;;R^"863.8:","863.84:6",.01,"E"
"RTN","ORY26901",117,0)
 ;;D^QUERY
"RTN","ORY26901",118,0)
 ;;R^"863.8:","863.84:6",1,"E"
"RTN","ORY26901",119,0)
 ;;D^File
"RTN","ORY26901",120,0)
 ;;R^"863.8:","863.84:7",.01,"E"
"RTN","ORY26901",121,0)
 ;;D^DATA TYPE
"RTN","ORY26901",122,0)
 ;;R^"863.8:","863.84:7",1,"E"
"RTN","ORY26901",123,0)
 ;;D^POINTER TO A FILEMAN FILE
"RTN","ORY26901",124,0)
 ;;R^"863.8:","863.84:8",.01,"E"
"RTN","ORY26901",125,0)
 ;;D^DIC
"RTN","ORY26901",126,0)
 ;;R^"863.8:","863.84:8",1,"E"
"RTN","ORY26901",127,0)
 ;;D^1
"RTN","ORY26901",128,0)
 ;;EOR^
"RTN","ORY26901",129,0)
 ;;KEY^863.8:^FM MASK
"RTN","ORY26901",130,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",131,0)
 ;;D^FM MASK
"RTN","ORY26901",132,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",133,0)
 ;;D^FM MASK
"RTN","ORY26901",134,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",135,0)
 ;;D^Tag^routine where code is located to parse the FM DD and override the parameter value
"RTN","ORY26901",136,0)
 ;;R^"863.8:","863.84:4",.01,"E"
"RTN","ORY26901",137,0)
 ;;D^QUERY
"RTN","ORY26901",138,0)
 ;;R^"863.8:","863.84:4",1,"E"
"RTN","ORY26901",139,0)
 ;;D^Enter tag^routine where the FM MASK parser is located
"RTN","ORY26901",140,0)
 ;;R^"863.8:","863.84:5",.01,"E"
"RTN","ORY26901",141,0)
 ;;D^DATA TYPE
"RTN","ORY26901",142,0)
 ;;R^"863.8:","863.84:5",1,"E"
"RTN","ORY26901",143,0)
 ;;D^LINE TAG
"RTN","ORY26901",144,0)
 ;;EOR^
"RTN","ORY26901",145,0)
 ;;KEY^863.8:^FREE TEXT MAXIMUM LENGTH
"RTN","ORY26901",146,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",147,0)
 ;;D^FREE TEXT MAXIMUM LENGTH
"RTN","ORY26901",148,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",149,0)
 ;;D^FMAX
"RTN","ORY26901",150,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",151,0)
 ;;D^Maximum string length allowed
"RTN","ORY26901",152,0)
 ;;R^"863.8:",2,"E"
"RTN","ORY26901",153,0)
 ;;D^245
"RTN","ORY26901",154,0)
 ;;R^"863.8:","863.84:3",.01,"E"
"RTN","ORY26901",155,0)
 ;;D^QUERY
"RTN","ORY26901",156,0)
 ;;R^"863.8:","863.84:3",1,"E"
"RTN","ORY26901",157,0)
 ;;D^Maximum text string length allowed
"RTN","ORY26901",158,0)
 ;;R^"863.8:","863.84:4",.01,"E"
"RTN","ORY26901",159,0)
 ;;D^FM MASK
"RTN","ORY26901",160,0)
 ;;R^"863.8:","863.84:4",1,"E"
"RTN","ORY26901",161,0)
 ;;D^FMAX^OCXF6
"RTN","ORY26901",162,0)
 ;;R^"863.8:","863.84:5",.01,"E"
"RTN","ORY26901",163,0)
 ;;D^DATA TYPE
"RTN","ORY26901",164,0)
 ;;R^"863.8:","863.84:5",1,"E"
"RTN","ORY26901",165,0)
 ;;D^POSITIVE INTEGER
"RTN","ORY26901",166,0)
 ;;EOR^
"RTN","ORY26901",167,0)
 ;;KEY^863.8:^HELP MESSAGE
"RTN","ORY26901",168,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",169,0)
 ;;D^HELP MESSAGE
"RTN","ORY26901",170,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",171,0)
 ;;D^HELP
"RTN","ORY26901",172,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",173,0)
 ;;D^A text string 1-250 characters long which overrides the Fileman help
"RTN","ORY26901",174,0)
 ;;R^"863.8:",1,2
"RTN","ORY26901",175,0)
 ;;D^message.
"RTN","ORY26901",176,0)
 ;;R^"863.8:","863.84:10",.01,"E"
"RTN","ORY26901",177,0)
 ;;D^QUERY
"RTN","ORY26901",178,0)
 ;;R^"863.8:","863.84:10",1,"E"
"RTN","ORY26901",179,0)
 ;;D^Enter a brief help message
"RTN","ORY26901",180,0)
 ;;R^"863.8:","863.84:8",.01,"E"
"RTN","ORY26901",181,0)
 ;;D^DATA TYPE
"RTN","ORY26901",182,0)
 ;;R^"863.8:","863.84:8",1,"E"
"RTN","ORY26901",183,0)
 ;;D^FREE TEXT
"RTN","ORY26901",184,0)
 ;;R^"863.8:","863.84:9",.01,"E"
"RTN","ORY26901",185,0)
 ;;D^FM MASK
"RTN","ORY26901",186,0)
 ;;R^"863.8:","863.84:9",1,"E"
"RTN","ORY26901",187,0)
 ;;D^HELP^OCXF6
"RTN","ORY26901",188,0)
 ;;EOR^
"RTN","ORY26901",189,0)
 ;;KEY^863.8:^LOOP QUERY
"RTN","ORY26901",190,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",191,0)
 ;;D^LOOP QUERY
"RTN","ORY26901",192,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",193,0)
 ;;D^LOOP QUERY
"RTN","ORY26901",194,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",195,0)
 ;;D^Alternate query used when repeated answers are required
"RTN","ORY26901",196,0)
 ;;R^"863.8:","863.84:1",.01,"E"
"RTN","ORY26901",197,0)
 ;;D^DATA TYPE
"RTN","ORY26901",198,0)
 ;;R^"863.8:","863.84:1",1,"E"
"RTN","ORY26901",199,0)
 ;;D^FREE TEXT
"RTN","ORY26901",200,0)
 ;;R^"863.8:","863.84:2",.01,"E"
"RTN","ORY26901",201,0)
 ;;D^QUERY
"RTN","ORY26901",202,0)
 ;;R^"863.8:","863.84:2",1,"E"
"RTN","ORY26901",203,0)
 ;;D^Enter loop query text
"RTN","ORY26901",204,0)
 ;;R^"863.8:","863.84:3",.01,"E"
"RTN","ORY26901",205,0)
 ;;D^HELP MESSAGE
"RTN","ORY26901",206,0)
 ;;R^"863.8:","863.84:3",1,"E"
"RTN","ORY26901",207,0)
 ;;D^This is the query text for all entries after the first one
"RTN","ORY26901",208,0)
 ;;EOR^
"RTN","ORY26901",209,0)
 ;;KEY^863.8:^MANDATORY MESSAGE
"RTN","ORY26901",210,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",211,0)
 ;;D^MANDATORY MESSAGE
"RTN","ORY26901",212,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",213,0)
 ;;D^MAND MSG
"RTN","ORY26901",214,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",215,0)
 ;;D^Message sent to user telling him that his entry is mandatory
"RTN","ORY26901",216,0)
 ;;R^"863.8:",2,"E"
"RTN","ORY26901",217,0)
 ;;D^Mandatory answer.  You must enter a value or '^' to exit.
"RTN","ORY26901",218,0)
 ;;R^"863.8:","863.84:4",.01,"E"
"RTN","ORY26901",219,0)
 ;;D^QUERY
"RTN","ORY26901",220,0)
 ;;R^"863.8:","863.84:4",1,"E"
"RTN","ORY26901",221,0)
 ;;D^Enter message
"RTN","ORY26901",222,0)
 ;;R^"863.8:","863.84:5",.01,"E"
"RTN","ORY26901",223,0)
 ;;D^DATA TYPE
"RTN","ORY26901",224,0)
 ;;R^"863.8:","863.84:5",1,"E"
"RTN","ORY26901",225,0)
 ;;D^FREE TEXT
"RTN","ORY26901",226,0)
 ;;EOR^
"RTN","ORY26901",227,0)
 ;;KEY^863.8:^OCXO EXTERNAL FUNCTION CALL
"RTN","ORY26901",228,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",229,0)
 ;;D^OCXO EXTERNAL FUNCTION CALL
"RTN","ORY26901",230,0)
 ;;EOR^
"RTN","ORY26901",231,0)
 ;;KEY^863.8:^OCXO HL7 SEGMENT ID
"RTN","ORY26901",232,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",233,0)
 ;;D^OCXO HL7 SEGMENT ID
"RTN","ORY26901",234,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",235,0)
 ;;D^HL7SEGID
"RTN","ORY26901",236,0)
 ;;EOR^
"RTN","ORY26901",237,0)
 ;;KEY^863.8:^OCXO UP-ARROW PIECE NUMBER
"RTN","ORY26901",238,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",239,0)
 ;;D^OCXO UP-ARROW PIECE NUMBER
"RTN","ORY26901",240,0)
 ;;EOR^
"RTN","ORY26901",241,0)
 ;;KEY^863.8:^OCXO VARIABLE NAME
"RTN","ORY26901",242,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",243,0)
 ;;D^OCXO VARIABLE NAME
"RTN","ORY26901",244,0)
 ;;EOR^
"RTN","ORY26901",245,0)
 ;;KEY^863.8:^OCXO VT-BAR PIECE NUMBER
"RTN","ORY26901",246,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",247,0)
 ;;D^OCXO VT-BAR PIECE NUMBER
"RTN","ORY26901",248,0)
 ;;EOR^
"RTN","ORY26901",249,0)
 ;;KEY^863.8:^QUERY
"RTN","ORY26901",250,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",251,0)
 ;;D^QUERY
"RTN","ORY26901",252,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",253,0)
 ;;D^QUERY
"RTN","ORY26901",254,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",255,0)
 ;;D^Used with methods that manage interactive dialogues.  Equivalent to DIC("A")
"RTN","ORY26901",256,0)
 ;;R^"863.8:","863.84:1",.01,"E"
"RTN","ORY26901",257,0)
 ;;D^DATA TYPE
"RTN","ORY26901",258,0)
 ;;R^"863.8:","863.84:1",1,"E"
"RTN","ORY26901",259,0)
 ;;D^FREE TEXT
"RTN","ORY26901",260,0)
 ;;R^"863.8:","863.84:2",.01,"E"
"RTN","ORY26901",261,0)
 ;;D^QUERY
"RTN","ORY26901",262,0)
 ;;R^"863.8:","863.84:2",1,"E"
"RTN","ORY26901",263,0)
 ;;D^Enter the query (free text string)
"RTN","ORY26901",264,0)
 ;;EOR^
"RTN","ORY26901",265,0)
 ;;KEY^863.8:^REPEAT THE QUERY
"RTN","ORY26901",266,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26901",267,0)
 ;;D^REPEAT THE QUERY
"RTN","ORY26901",268,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26901",269,0)
 ;;D^LOOP
"RTN","ORY26901",270,0)
 ;;R^"863.8:",1,1
"RTN","ORY26901",271,0)
 ;;D^Set this = 1 to repetitively ask the user to enter a value
"RTN","ORY26901",272,0)
 ;;R^"863.8:","863.84:1",.01,"E"
"RTN","ORY26901",273,0)
 ;;D^DATA TYPE
"RTN","ORY26901",274,0)
 ;;R^"863.8:","863.84:1",1,"E"
"RTN","ORY26901",275,0)
 ;;D^YES NO
"RTN","ORY26901",276,0)
 ;;R^"863.8:","863.84:2",.01,"E"
"RTN","ORY26901",277,0)
 ;;D^HELP MESSAGE
"RTN","ORY26901",278,0)
 ;1;
"RTN","ORY26901",279,0)
 ;
"RTN","ORY26902")
0^11^B80510090
"RTN","ORY26902",1,0)
ORY26902 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY26902",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY26902",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY26902",4,0)
 ;
"RTN","ORY26902",5,0)
S ;
"RTN","ORY26902",6,0)
 ;
"RTN","ORY26902",7,0)
 D DOT^ORY269ES
"RTN","ORY26902",8,0)
 ;
"RTN","ORY26902",9,0)
 ;
"RTN","ORY26902",10,0)
 K REMOTE,LOCAL,OPCODE,REF
"RTN","ORY26902",11,0)
 F LINE=1:1:500 S TEXT=$P($T(DATA+LINE),";",2,999) Q:TEXT  I $L(TEXT) D  Q:QUIT
"RTN","ORY26902",12,0)
 .S ^TMP("OCXRULE",$J,$O(^TMP("OCXRULE",$J,"A"),-1)+1)=TEXT
"RTN","ORY26902",13,0)
 ;
"RTN","ORY26902",14,0)
 G ^ORY26903
"RTN","ORY26902",15,0)
 ;
"RTN","ORY26902",16,0)
 Q
"RTN","ORY26902",17,0)
 ;
"RTN","ORY26902",18,0)
DATA ;
"RTN","ORY26902",19,0)
 ;
"RTN","ORY26902",20,0)
 ;;R^"863.8:","863.84:2",1,"E"
"RTN","ORY26902",21,0)
 ;;D^Answer 'YES' if you want the user to repetitively enter a value.
"RTN","ORY26902",22,0)
 ;;R^"863.8:","863.84:3",.01,"E"
"RTN","ORY26902",23,0)
 ;;D^QUERY
"RTN","ORY26902",24,0)
 ;;R^"863.8:","863.84:3",1,"E"
"RTN","ORY26902",25,0)
 ;;D^Is the query repetitive
"RTN","ORY26902",26,0)
 ;;EOR^
"RTN","ORY26902",27,0)
 ;;KEY^863.8:^TERMINATOR
"RTN","ORY26902",28,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26902",29,0)
 ;;D^TERMINATOR
"RTN","ORY26902",30,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26902",31,0)
 ;;D^TERMINATOR
"RTN","ORY26902",32,0)
 ;;R^"863.8:",1,1
"RTN","ORY26902",33,0)
 ;;D^A text string terminator; e.g., '?', ': ', '=>'
"RTN","ORY26902",34,0)
 ;;R^"863.8:",2,"E"
"RTN","ORY26902",35,0)
 ;;D^:
"RTN","ORY26902",36,0)
 ;;R^"863.8:","863.84:4",.01,"E"
"RTN","ORY26902",37,0)
 ;;D^QUERY
"RTN","ORY26902",38,0)
 ;;R^"863.8:","863.84:4",1,"E"
"RTN","ORY26902",39,0)
 ;;D^Enter text string terminator
"RTN","ORY26902",40,0)
 ;;R^"863.8:","863.84:5",.01,"E"
"RTN","ORY26902",41,0)
 ;;D^DATA TYPE
"RTN","ORY26902",42,0)
 ;;R^"863.8:","863.84:5",1,"E"
"RTN","ORY26902",43,0)
 ;;D^FREE TEXT
"RTN","ORY26902",44,0)
 ;;R^"863.8:","863.84:6",.01,"E"
"RTN","ORY26902",45,0)
 ;;D^FREE TEXT MAXIMUM LENGTH
"RTN","ORY26902",46,0)
 ;;R^"863.8:","863.84:6",1,"E"
"RTN","ORY26902",47,0)
 ;;D^9
"RTN","ORY26902",48,0)
 ;;EOR^
"RTN","ORY26902",49,0)
 ;;KEY^863.8:^VALUE CALL
"RTN","ORY26902",50,0)
 ;;R^"863.8:",.01,"E"
"RTN","ORY26902",51,0)
 ;;D^VALUE CALL
"RTN","ORY26902",52,0)
 ;;R^"863.8:",.02,"E"
"RTN","ORY26902",53,0)
 ;;D^VAL CALL
"RTN","ORY26902",54,0)
 ;;R^"863.8:",.03,"E"
"RTN","ORY26902",55,0)
 ;;D^NO
"RTN","ORY26902",56,0)
 ;;R^"863.8:",1,1
"RTN","ORY26902",57,0)
 ;;D^tag^routine which manages the dialogue for collecting and validating a value
"RTN","ORY26902",58,0)
 ;;R^"863.8:","863.84:3",.01,"E"
"RTN","ORY26902",59,0)
 ;;D^QUERY
"RTN","ORY26902",60,0)
 ;;R^"863.8:","863.84:3",1,"E"
"RTN","ORY26902",61,0)
 ;;D^Enter tag^routine
"RTN","ORY26902",62,0)
 ;;R^"863.8:","863.84:4",.01,"E"
"RTN","ORY26902",63,0)
 ;;D^DATA TYPE
"RTN","ORY26902",64,0)
 ;;R^"863.8:","863.84:4",1,"E"
"RTN","ORY26902",65,0)
 ;;D^LINE TAG
"RTN","ORY26902",66,0)
 ;;EOR^
"RTN","ORY26902",67,0)
 ;;EOF^OCXS(863.8)^1
"RTN","ORY26902",68,0)
 ;;SOF^864.1  OCX MDD DATATYPE
"RTN","ORY26902",69,0)
 ;;KEY^864.1:^GENERIC
"RTN","ORY26902",70,0)
 ;;R^"864.1:",.01,"E"
"RTN","ORY26902",71,0)
 ;;D^GENERIC
"RTN","ORY26902",72,0)
 ;;R^"864.1:",.02,"E"
"RTN","ORY26902",73,0)
 ;;D^GENERIC
"RTN","ORY26902",74,0)
 ;;R^"864.1:","864.11:11",.01,"E"
"RTN","ORY26902",75,0)
 ;;D^MANDATORY MESSAGE
"RTN","ORY26902",76,0)
 ;;R^"864.1:","864.11:11",1,"E"
"RTN","ORY26902",77,0)
 ;;D^This answer is mandatory.  Enter a response or press '^' to exit.
"RTN","ORY26902",78,0)
 ;;R^"864.1:","864.11:12",.01,"E"
"RTN","ORY26902",79,0)
 ;;D^TERMINATOR
"RTN","ORY26902",80,0)
 ;;R^"864.1:","864.11:12",1,"E"
"RTN","ORY26902",81,0)
 ;;D^:
"RTN","ORY26902",82,0)
 ;;R^"864.1:","864.11:13",.01,"E"
"RTN","ORY26902",83,0)
 ;;D^LOOP QUERY
"RTN","ORY26902",84,0)
 ;;R^"864.1:","864.11:13",1,"E"
"RTN","ORY26902",85,0)
 ;;D^Enter another value
"RTN","ORY26902",86,0)
 ;;R^"864.1:","864.11:7",.01,"E"
"RTN","ORY26902",87,0)
 ;;D^VALUE CALL
"RTN","ORY26902",88,0)
 ;;R^"864.1:","864.11:7",1,"E"
"RTN","ORY26902",89,0)
 ;;D^GEN^OCXFDMOM
"RTN","ORY26902",90,0)
 ;;R^"864.1:","864.11:8",.01,"E"
"RTN","ORY26902",91,0)
 ;;D^QUERY
"RTN","ORY26902",92,0)
 ;;R^"864.1:","864.11:8",1,"E"
"RTN","ORY26902",93,0)
 ;;D^Enter a value
"RTN","ORY26902",94,0)
 ;;R^"864.1:","864.11:9",.01,"E"
"RTN","ORY26902",95,0)
 ;;D^HELP MESSAGE
"RTN","ORY26902",96,0)
 ;;R^"864.1:","864.11:9",1,"E"
"RTN","ORY26902",97,0)
 ;;D^ 
"RTN","ORY26902",98,0)
 ;;EOR^
"RTN","ORY26902",99,0)
 ;;KEY^864.1:^NUMERIC
"RTN","ORY26902",100,0)
 ;;R^"864.1:",.01,"E"
"RTN","ORY26902",101,0)
 ;;D^NUMERIC
"RTN","ORY26902",102,0)
 ;;R^"864.1:",.02,"E"
"RTN","ORY26902",103,0)
 ;;D^NUMERIC
"RTN","ORY26902",104,0)
 ;;R^"864.1:",2,"E"
"RTN","ORY26902",105,0)
 ;;D^GENERIC
"RTN","ORY26902",106,0)
 ;;R^"864.1:","864.11:1",.01,"E"
"RTN","ORY26902",107,0)
 ;;D^VALUE CALL
"RTN","ORY26902",108,0)
 ;;R^"864.1:","864.11:1",1,"E"
"RTN","ORY26902",109,0)
 ;;D^NU^OCXFDNU
"RTN","ORY26902",110,0)
 ;;R^"864.1:","864.11:2",.01,"E"
"RTN","ORY26902",111,0)
 ;;D^QUERY
"RTN","ORY26902",112,0)
 ;;R^"864.1:","864.11:2",1,"E"
"RTN","ORY26902",113,0)
 ;;D^Enter a number
"RTN","ORY26902",114,0)
 ;;R^"864.1:","864.11:3",.01,"E"
"RTN","ORY26902",115,0)
 ;;D^LOOP QUERY
"RTN","ORY26902",116,0)
 ;;R^"864.1:","864.11:3",1,"E"
"RTN","ORY26902",117,0)
 ;;D^Enter another number
"RTN","ORY26902",118,0)
 ;;R^"864.1:","864.11:4",.01,"E"
"RTN","ORY26902",119,0)
 ;;D^REPEAT THE QUERY
"RTN","ORY26902",120,0)
 ;;R^"864.1:","864.11:4",1,"E"
"RTN","ORY26902",121,0)
 ;;D^0
"RTN","ORY26902",122,0)
 ;;EOR^
"RTN","ORY26902",123,0)
 ;;EOF^OCXS(864.1)^1
"RTN","ORY26902",124,0)
 ;;SOF^863.4  OCX MDD ATTRIBUTE
"RTN","ORY26902",125,0)
 ;;KEY^863.4:^CONTRAST MEDIA ALLERGY FLAG
"RTN","ORY26902",126,0)
 ;;R^"863.4:",.01,"E"
"RTN","ORY26902",127,0)
 ;;D^CONTRAST MEDIA ALLERGY FLAG
"RTN","ORY26902",128,0)
 ;;R^"863.4:","863.41:1",.01,"E"
"RTN","ORY26902",129,0)
 ;;D^DATA TYPE
"RTN","ORY26902",130,0)
 ;;R^"863.4:","863.41:1",1,"E"
"RTN","ORY26902",131,0)
 ;;D^BOOLEAN
"RTN","ORY26902",132,0)
 ;;EOR^
"RTN","ORY26902",133,0)
 ;;KEY^863.4:^CONTRAST MEDIA ALLERGY LOC
"RTN","ORY26902",134,0)
 ;;R^"863.4:",.01,"E"
"RTN","ORY26902",135,0)
 ;;D^CONTRAST MEDIA ALLERGY LOC
"RTN","ORY26902",136,0)
 ;;R^"863.4:","863.41:1",.01,"E"
"RTN","ORY26902",137,0)
 ;;D^DATA TYPE
"RTN","ORY26902",138,0)
 ;;R^"863.4:","863.41:1",1,"E"
"RTN","ORY26902",139,0)
 ;;D^FREE TEXT
"RTN","ORY26902",140,0)
 ;;EOR^
"RTN","ORY26902",141,0)
 ;;KEY^863.4:^IEN
"RTN","ORY26902",142,0)
 ;;R^"863.4:",.01,"E"
"RTN","ORY26902",143,0)
 ;;D^IEN
"RTN","ORY26902",144,0)
 ;;R^"863.4:","863.41:1",.01,"E"
"RTN","ORY26902",145,0)
 ;;D^DATA TYPE
"RTN","ORY26902",146,0)
 ;;R^"863.4:","863.41:1",1,"E"
"RTN","ORY26902",147,0)
 ;;D^NUMERIC
"RTN","ORY26902",148,0)
 ;;EOR^
"RTN","ORY26902",149,0)
 ;;KEY^863.4:^ORDER PATIENT
"RTN","ORY26902",150,0)
 ;;R^"863.4:",.01,"E"
"RTN","ORY26902",151,0)
 ;;D^ORDER PATIENT
"RTN","ORY26902",152,0)
 ;;R^"863.4:","863.41:1",.01,"E"
"RTN","ORY26902",153,0)
 ;;D^DATA TYPE
"RTN","ORY26902",154,0)
 ;;R^"863.4:","863.41:1",1,"E"
"RTN","ORY26902",155,0)
 ;;D^NUMERIC
"RTN","ORY26902",156,0)
 ;;EOR^
"RTN","ORY26902",157,0)
 ;;EOF^OCXS(863.4)^1
"RTN","ORY26902",158,0)
 ;;SOF^863.2  OCX MDD SUBJECT
"RTN","ORY26902",159,0)
 ;;KEY^863.2:^PATIENT
"RTN","ORY26902",160,0)
 ;;R^"863.2:",.01,"E"
"RTN","ORY26902",161,0)
 ;;D^PATIENT
"RTN","ORY26902",162,0)
 ;;R^"863.2:","863.21:1",.01,"E"
"RTN","ORY26902",163,0)
 ;;D^FILE
"RTN","ORY26902",164,0)
 ;;R^"863.2:","863.21:1",1,"E"
"RTN","ORY26902",165,0)
 ;;D^2
"RTN","ORY26902",166,0)
 ;;EOR^
"RTN","ORY26902",167,0)
 ;;EOF^OCXS(863.2)^1
"RTN","ORY26902",168,0)
 ;;SOF^863.3  OCX MDD LINK
"RTN","ORY26902",169,0)
 ;;KEY^863.3:^PATIENT.CONT_MED_ALGY
"RTN","ORY26902",170,0)
 ;;R^"863.3:",.01,"E"
"RTN","ORY26902",171,0)
 ;;D^PATIENT.CONT_MED_ALGY
"RTN","ORY26902",172,0)
 ;;R^"863.3:",.02,"E"
"RTN","ORY26902",173,0)
 ;;D^PATIENT
"RTN","ORY26902",174,0)
 ;;R^"863.3:",.05,"E"
"RTN","ORY26902",175,0)
 ;;D^CONTRAST MEDIA ALLERGY FLAG
"RTN","ORY26902",176,0)
 ;;R^"863.3:",.06,"E"
"RTN","ORY26902",177,0)
 ;;D^99
"RTN","ORY26902",178,0)
 ;;R^"863.3:","863.32:1",.01,"E"
"RTN","ORY26902",179,0)
 ;;D^OCXO EXTERNAL FUNCTION CALL
"RTN","ORY26902",180,0)
 ;;R^"863.3:","863.32:1",1,"E"
"RTN","ORY26902",181,0)
 ;;D^ORCHK2^GMRAOR(|PATIENT IEN|,"CM","")
"RTN","ORY26902",182,0)
 ;;EOR^
"RTN","ORY26902",183,0)
 ;;KEY^863.3:^PATIENT.CON_MEDIA_LOCATION
"RTN","ORY26902",184,0)
 ;;R^"863.3:",.01,"E"
"RTN","ORY26902",185,0)
 ;;D^PATIENT.CON_MEDIA_LOCATION
"RTN","ORY26902",186,0)
 ;;R^"863.3:",.02,"E"
"RTN","ORY26902",187,0)
 ;;D^PATIENT
"RTN","ORY26902",188,0)
 ;;R^"863.3:",.05,"E"
"RTN","ORY26902",189,0)
 ;;D^CONTRAST MEDIA ALLERGY LOC
"RTN","ORY26902",190,0)
 ;;R^"863.3:",.06,"E"
"RTN","ORY26902",191,0)
 ;;D^99
"RTN","ORY26902",192,0)
 ;;R^"863.3:","863.32:1",.01,"E"
"RTN","ORY26902",193,0)
 ;;D^OCXO EXTERNAL FUNCTION CALL
"RTN","ORY26902",194,0)
 ;;R^"863.3:","863.32:1",1,"E"
"RTN","ORY26902",195,0)
 ;;D^ORCHK2^GMRAOR(|PATIENT IEN|,"CM","",1)
"RTN","ORY26902",196,0)
 ;;R^"863.3:","863.32:2",.01,"E"
"RTN","ORY26902",197,0)
 ;;D^OCXO UP-ARROW PIECE NUMBER
"RTN","ORY26902",198,0)
 ;;R^"863.3:","863.32:2",1,"E"
"RTN","ORY26902",199,0)
 ;;D^2
"RTN","ORY26902",200,0)
 ;;EOR^
"RTN","ORY26902",201,0)
 ;;KEY^863.3:^PATIENT.HL7_PATIENT_ID
"RTN","ORY26902",202,0)
 ;;R^"863.3:",.01,"E"
"RTN","ORY26902",203,0)
 ;;D^PATIENT.HL7_PATIENT_ID
"RTN","ORY26902",204,0)
 ;;R^"863.3:",.02,"E"
"RTN","ORY26902",205,0)
 ;;D^PATIENT
"RTN","ORY26902",206,0)
 ;;R^"863.3:",.04,"E"
"RTN","ORY26902",207,0)
 ;;D^HL7
"RTN","ORY26902",208,0)
 ;;R^"863.3:",.05,"E"
"RTN","ORY26902",209,0)
 ;;D^IEN
"RTN","ORY26902",210,0)
 ;;R^"863.3:",.06,"E"
"RTN","ORY26902",211,0)
 ;;D^99
"RTN","ORY26902",212,0)
 ;;R^"863.3:","863.32:1",.01,"E"
"RTN","ORY26902",213,0)
 ;;D^OCXO HL7 SEGMENT ID
"RTN","ORY26902",214,0)
 ;;R^"863.3:","863.32:2",.01,"E"
"RTN","ORY26902",215,0)
 ;;D^OCXO VT-BAR PIECE NUMBER
"RTN","ORY26902",216,0)
 ;;R^"863.3:","863.32:3",.01,"E"
"RTN","ORY26902",217,0)
 ;;D^OCXO VARIABLE NAME
"RTN","ORY26902",218,0)
 ;;R^"863.3:","863.32:3",1,"E"
"RTN","ORY26902",219,0)
 ;;D^OCXODATA("PID",3)
"RTN","ORY26902",220,0)
 ;;EOR^
"RTN","ORY26902",221,0)
 ;;KEY^863.3:^PATIENT.IEN
"RTN","ORY26902",222,0)
 ;;R^"863.3:",.01,"E"
"RTN","ORY26902",223,0)
 ;;D^PATIENT.IEN
"RTN","ORY26902",224,0)
 ;;R^"863.3:",.02,"E"
"RTN","ORY26902",225,0)
 ;;D^PATIENT
"RTN","ORY26902",226,0)
 ;;R^"863.3:",.05,"E"
"RTN","ORY26902",227,0)
 ;;D^IEN
"RTN","ORY26902",228,0)
 ;;R^"863.3:",.06,"E"
"RTN","ORY26902",229,0)
 ;;D^99
"RTN","ORY26902",230,0)
 ;;R^"863.3:","863.32:1",.01,"E"
"RTN","ORY26902",231,0)
 ;;D^OCXO VARIABLE NAME
"RTN","ORY26902",232,0)
 ;;R^"863.3:","863.32:1",1,"E"
"RTN","ORY26902",233,0)
 ;;D^DFN
"RTN","ORY26902",234,0)
 ;;EOR^
"RTN","ORY26902",235,0)
 ;;KEY^863.3:^PATIENT.OERR_ORDER_PATIENT
"RTN","ORY26902",236,0)
 ;;R^"863.3:",.01,"E"
"RTN","ORY26902",237,0)
 ;;D^PATIENT.OERR_ORDER_PATIENT
"RTN","ORY26902",238,0)
 ;;R^"863.3:",.02,"E"
"RTN","ORY26902",239,0)
 ;;D^PATIENT
"RTN","ORY26902",240,0)
 ;;R^"863.3:",.05,"E"
"RTN","ORY26902",241,0)
 ;;D^ORDER PATIENT
"RTN","ORY26902",242,0)
 ;;R^"863.3:",.06,"E"
"RTN","ORY26902",243,0)
 ;;D^5567
"RTN","ORY26902",244,0)
 ;;R^"863.3:","863.32:1",.01,"E"
"RTN","ORY26902",245,0)
 ;;D^OCXO VARIABLE NAME
"RTN","ORY26902",246,0)
 ;;R^"863.3:","863.32:1",1,"E"
"RTN","ORY26902",247,0)
 ;;D^OCXORD
"RTN","ORY26902",248,0)
 ;;R^"863.3:","863.32:2",.01,"E"
"RTN","ORY26902",249,0)
 ;;D^OCXO UP-ARROW PIECE NUMBER
"RTN","ORY26902",250,0)
 ;;R^"863.3:","863.32:2",1,"E"
"RTN","ORY26902",251,0)
 ;;D^1
"RTN","ORY26902",252,0)
 ;;EOR^
"RTN","ORY26902",253,0)
 ;;EOF^OCXS(863.3)^1
"RTN","ORY26902",254,0)
 ;;SOF^860.9  ORDER CHECK NATIONAL TERM
"RTN","ORY26902",255,0)
 ;;KEY^860.9:^ANGIOGRAM (PERIPHERAL)
"RTN","ORY26902",256,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",257,0)
 ;;D^ANGIOGRAM (PERIPHERAL)
"RTN","ORY26902",258,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",259,0)
 ;;D^101.43
"RTN","ORY26902",260,0)
 ;;EOR^
"RTN","ORY26902",261,0)
 ;;KEY^860.9:^BLOOD SPECIMEN
"RTN","ORY26902",262,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",263,0)
 ;;D^BLOOD SPECIMEN
"RTN","ORY26902",264,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",265,0)
 ;;D^61
"RTN","ORY26902",266,0)
 ;;EOR^
"RTN","ORY26902",267,0)
 ;;KEY^860.9:^DANGEROUS MEDS FOR PTS > 64
"RTN","ORY26902",268,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",269,0)
 ;;D^DANGEROUS MEDS FOR PTS > 64
"RTN","ORY26902",270,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",271,0)
 ;;D^101.43
"RTN","ORY26902",272,0)
 ;;R^"860.9:",2,"E"
"RTN","ORY26902",273,0)
 ;;D^I $P($G(^ORD(100.98,$P($G(^ORD(101.43,+Y,0)),U,5),0)),U)="PHARMACY"
"RTN","ORY26902",274,0)
 ;;EOR^
"RTN","ORY26902",275,0)
 ;;KEY^860.9:^DNR
"RTN","ORY26902",276,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",277,0)
 ;;D^DNR
"RTN","ORY26902",278,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",279,0)
 ;;D^101.43
"RTN","ORY26902",280,0)
 ;;EOR^
"RTN","ORY26902",281,0)
 ;;KEY^860.9:^EGFR
"RTN","ORY26902",282,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",283,0)
 ;;D^EGFR
"RTN","ORY26902",284,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",285,0)
 ;;D^60
"RTN","ORY26902",286,0)
 ;;EOR^
"RTN","ORY26902",287,0)
 ;;KEY^860.9:^FOOD-DRUG INTERACTION MED
"RTN","ORY26902",288,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",289,0)
 ;;D^FOOD-DRUG INTERACTION MED
"RTN","ORY26902",290,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",291,0)
 ;;D^101.43
"RTN","ORY26902",292,0)
 ;;R^"860.9:",2,"E"
"RTN","ORY26902",293,0)
 ;;D^I $P($G(^ORD(100.98,$P($G(^ORD(101.43,+Y,0)),U,5),0)),U)="PHARMACY"
"RTN","ORY26902",294,0)
 ;;EOR^
"RTN","ORY26902",295,0)
 ;;KEY^860.9:^NPO
"RTN","ORY26902",296,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",297,0)
 ;;D^NPO
"RTN","ORY26902",298,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",299,0)
 ;;D^101.43
"RTN","ORY26902",300,0)
 ;;EOR^
"RTN","ORY26902",301,0)
 ;;KEY^860.9:^ONE TIME MED
"RTN","ORY26902",302,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",303,0)
 ;;D^ONE TIME MED
"RTN","ORY26902",304,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",305,0)
 ;;D^51.1
"RTN","ORY26902",306,0)
 ;;R^"860.9:",2,"E"
"RTN","ORY26902",307,0)
 ;;D^I $E($P(^(0),U,4),1,2)="PS"
"RTN","ORY26902",308,0)
 ;;EOR^
"RTN","ORY26902",309,0)
 ;;KEY^860.9:^PARTIAL THROMBOPLASTIN TIME
"RTN","ORY26902",310,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",311,0)
 ;;D^PARTIAL THROMBOPLASTIN TIME
"RTN","ORY26902",312,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",313,0)
 ;;D^101.43
"RTN","ORY26902",314,0)
 ;;EOR^
"RTN","ORY26902",315,0)
 ;;KEY^860.9:^PROTHROMBIN TIME
"RTN","ORY26902",316,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",317,0)
 ;;D^PROTHROMBIN TIME
"RTN","ORY26902",318,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",319,0)
 ;;D^101.43
"RTN","ORY26902",320,0)
 ;;EOR^
"RTN","ORY26902",321,0)
 ;;KEY^860.9:^SERUM CREATININE
"RTN","ORY26902",322,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",323,0)
 ;;D^SERUM CREATININE
"RTN","ORY26902",324,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",325,0)
 ;;D^60
"RTN","ORY26902",326,0)
 ;;EOR^
"RTN","ORY26902",327,0)
 ;;KEY^860.9:^SERUM SPECIMEN
"RTN","ORY26902",328,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",329,0)
 ;;D^SERUM SPECIMEN
"RTN","ORY26902",330,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",331,0)
 ;;D^61
"RTN","ORY26902",332,0)
 ;;EOR^
"RTN","ORY26902",333,0)
 ;;KEY^860.9:^SERUM UREA NITROGEN
"RTN","ORY26902",334,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",335,0)
 ;;D^SERUM UREA NITROGEN
"RTN","ORY26902",336,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26902",337,0)
 ;;D^60
"RTN","ORY26902",338,0)
 ;;EOR^
"RTN","ORY26902",339,0)
 ;;KEY^860.9:^THROMBOPLASTIN TIME PARTIAL
"RTN","ORY26902",340,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26902",341,0)
 ;;D^THROMBOPLASTIN TIME PARTIAL
"RTN","ORY26902",342,0)
 ;1;
"RTN","ORY26902",343,0)
 ;
"RTN","ORY26903")
0^12^B60307349
"RTN","ORY26903",1,0)
ORY26903 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY26903",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY26903",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY26903",4,0)
 ;
"RTN","ORY26903",5,0)
S ;
"RTN","ORY26903",6,0)
 ;
"RTN","ORY26903",7,0)
 D DOT^ORY269ES
"RTN","ORY26903",8,0)
 ;
"RTN","ORY26903",9,0)
 ;
"RTN","ORY26903",10,0)
 K REMOTE,LOCAL,OPCODE,REF
"RTN","ORY26903",11,0)
 F LINE=1:1:500 S TEXT=$P($T(DATA+LINE),";",2,999) Q:TEXT  I $L(TEXT) D  Q:QUIT
"RTN","ORY26903",12,0)
 .S ^TMP("OCXRULE",$J,$O(^TMP("OCXRULE",$J,"A"),-1)+1)=TEXT
"RTN","ORY26903",13,0)
 ;
"RTN","ORY26903",14,0)
 G ^ORY26904
"RTN","ORY26903",15,0)
 ;
"RTN","ORY26903",16,0)
 Q
"RTN","ORY26903",17,0)
 ;
"RTN","ORY26903",18,0)
DATA ;
"RTN","ORY26903",19,0)
 ;
"RTN","ORY26903",20,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26903",21,0)
 ;;D^60
"RTN","ORY26903",22,0)
 ;;EOR^
"RTN","ORY26903",23,0)
 ;;KEY^860.9:^WBC
"RTN","ORY26903",24,0)
 ;;R^"860.9:",.01,"E"
"RTN","ORY26903",25,0)
 ;;D^WBC
"RTN","ORY26903",26,0)
 ;;R^"860.9:",.02,"E"
"RTN","ORY26903",27,0)
 ;;D^60
"RTN","ORY26903",28,0)
 ;;EOR^
"RTN","ORY26903",29,0)
 ;;EOF^OCXS(860.9)^1
"RTN","ORY26903",30,0)
 ;;SOF^860.8  ORDER CHECK COMPILER FUNCTIONS
"RTN","ORY26903",31,0)
 ;;KEY^860.8:^CONVERT DATE FROM FILEMAN FORMAT TO OCX FORMAT
"RTN","ORY26903",32,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26903",33,0)
 ;;D^CONVERT DATE FROM FILEMAN FORMAT TO OCX FORMAT
"RTN","ORY26903",34,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26903",35,0)
 ;;D^DT2INT
"RTN","ORY26903",36,0)
 ;;R^"860.8:",1,1
"RTN","ORY26903",37,0)
 ;;D^  ;DT2INT(OCXDT) ;      This Local Extrinsic Function converts a date into an integer
"RTN","ORY26903",38,0)
 ;;R^"860.8:",1,2
"RTN","ORY26903",39,0)
 ;;D^  ; ; By taking the Years, Months, Days, Hours and Minutes converting
"RTN","ORY26903",40,0)
 ;;R^"860.8:",1,3
"RTN","ORY26903",41,0)
 ;;D^  ; ; Them into Seconds and then adding them all together into one big integer
"RTN","ORY26903",42,0)
 ;;R^"860.8:",100,1
"RTN","ORY26903",43,0)
 ;;D^  ;DT2INT(OCXDT) ;      This Local Extrinsic Function converts a date into an integer
"RTN","ORY26903",44,0)
 ;;R^"860.8:",100,2
"RTN","ORY26903",45,0)
 ;;D^  ; ; By taking the Years, Months, Days, Hours and Minutes converting
"RTN","ORY26903",46,0)
 ;;R^"860.8:",100,3
"RTN","ORY26903",47,0)
 ;;D^  ; ; Them into Seconds and then adding them all together into one big integer
"RTN","ORY26903",48,0)
 ;;R^"860.8:",100,4
"RTN","ORY26903",49,0)
 ;;D^  ; ;
"RTN","ORY26903",50,0)
 ;;R^"860.8:",100,5
"RTN","ORY26903",51,0)
 ;;D^  ; Q:'$L($G(OCXDT)) ""
"RTN","ORY26903",52,0)
 ;;R^"860.8:",100,6
"RTN","ORY26903",53,0)
 ;;D^  ; N OCXDIFF,OCXVAL S (OCXDIFF,OCXVAL)=0
"RTN","ORY26903",54,0)
 ;;R^"860.8:",100,7
"RTN","ORY26903",55,0)
 ;;D^  ; ;
"RTN","ORY26903",56,0)
 ;;R^"860.8:",100,8
"RTN","ORY26903",57,0)
 ;;D^  ; I $L(OCXDT),'OCXDT,(OCXDT[" at ") D  ; EXTERNAL EXPERT SYSTEM FORMAT 1 TO EXTERNAL FORMAT
"RTN","ORY26903",58,0)
 ;;R^"860.8:",100,9
"RTN","ORY26903",59,0)
 ;;D^  ; .N OCXHR,OCXMIN,OCXTIME
"RTN","ORY26903",60,0)
 ;;R^"860.8:",100,10
"RTN","ORY26903",61,0)
 ;;D^  ; .S OCXTIME=$P($P(OCXDT," at ",2),".",1),OCXHR=$P(OCXTIME,":",1),OCXMIN=$P(OCXTIME,":",2)
"RTN","ORY26903",62,0)
 ;;R^"860.8:",100,11
"RTN","ORY26903",63,0)
 ;;D^  ; .S:(OCXDT["Midnight") OCXHR=00
"RTN","ORY26903",64,0)
 ;;R^"860.8:",100,12
"RTN","ORY26903",65,0)
 ;;D^  ; .S:(OCXDT["PM") OCXHR=OCXHR+12
"RTN","ORY26903",66,0)
 ;;R^"860.8:",100,13
"RTN","ORY26903",67,0)
 ;;D^  ; .S OCXDT=$P(OCXDT," at ")_"@"_$E(OCXHR+100,2,3)_$E(OCXMIN+100,2,3)
"RTN","ORY26903",68,0)
 ;;R^"860.8:",100,14
"RTN","ORY26903",69,0)
 ;;D^  ; ;
"RTN","ORY26903",70,0)
 ;;R^"860.8:",100,15
"RTN","ORY26903",71,0)
 ;;D^  ; I $L(OCXDT),(OCXDT?1.2N1"/"1.2N.1" ".2N.1":".2N) D  ; EXTERNAL EXPERT SYSTEM FORMAT 2 TO EXTERNAL FORMAT
"RTN","ORY26903",72,0)
 ;;R^"860.8:",100,16
"RTN","ORY26903",73,0)
 ;;D^  ; .N OCXMON
"RTN","ORY26903",74,0)
 ;;R^"860.8:",100,17
"RTN","ORY26903",75,0)
 ;;D^  ; .S OCXMON=$P("January^February^March^April^May^June^July^August^September^October^November^December",U,$P(OCXDT,"/",1))
"RTN","ORY26903",76,0)
 ;;R^"860.8:",100,18
"RTN","ORY26903",77,0)
 ;;D^  ; .I $L($P(OCXDT," ",2)) S OCXDT=OCXMON_" "_$P($P(OCXDT," ",1),"/",2)_"@"_$TR($P(OCXDT," ",2),":","")
"RTN","ORY26903",78,0)
 ;;R^"860.8:",100,19
"RTN","ORY26903",79,0)
 ;;D^  ; .E  S OCXDT=OCXMON_" "_$P($P(OCXDT," ",1),"/",2)
"RTN","ORY26903",80,0)
 ;;R^"860.8:",100,20
"RTN","ORY26903",81,0)
 ;;D^  ; ;
"RTN","ORY26903",82,0)
 ;;R^"860.8:",100,21
"RTN","ORY26903",83,0)
 ;;D^  ; I $L(OCXDT),(OCXDT?1.2N1"/"1.2N1"/"1.2N.1" ".2N.1":".2N) D  ; EXTERNAL EXPERT SYSTEM FORMAT 3 TO EXTERNAL FORMAT
"RTN","ORY26903",84,0)
 ;;R^"860.8:",100,22
"RTN","ORY26903",85,0)
 ;;D^  ; .N OCXMON
"RTN","ORY26903",86,0)
 ;;R^"860.8:",100,23
"RTN","ORY26903",87,0)
 ;;D^  ; .S OCXMON=$P("January^February^March^April^May^June^July^August^September^October^November^December",U,$P(OCXDT,"/",1))
"RTN","ORY26903",88,0)
 ;;R^"860.8:",100,24
"RTN","ORY26903",89,0)
 ;;D^  ; .I $L($P(OCXDT," ",2)) S OCXDT=OCXMON_" "_$P($P(OCXDT," ",1),"/",2)_","_$P($P(OCXDT," ",1),"/",3)_"@"_$TR($P(OCXDT," ",2),":","")
"RTN","ORY26903",90,0)
 ;;R^"860.8:",100,25
"RTN","ORY26903",91,0)
 ;;D^  ; .E  S OCXDT=OCXMON_" "_$P($P(OCXDT," ",1),"/",2)_", "_$P($P(OCXDT," ",1),"/",3)
"RTN","ORY26903",92,0)
 ;;R^"860.8:",100,26
"RTN","ORY26903",93,0)
 ;;D^  ; ;
"RTN","ORY26903",94,0)
 ;;R^"860.8:",100,27
"RTN","ORY26903",95,0)
 ;;D^  ; I $L(OCXDT),'OCXDT D  ; EXTERNAL FORMAT TO INTERNAL FILEMAN FORMAT
"RTN","ORY26903",96,0)
 ;;R^"860.8:",100,28
"RTN","ORY26903",97,0)
 ;;D^  ; .I (OCXDT["@0000") S OCXDT=$P(OCXDT,"@",1),OCXDIFF=1
"RTN","ORY26903",98,0)
 ;;R^"860.8:",100,29
"RTN","ORY26903",99,0)
 ;;D^  ; .N %DT,X,Y S X=OCXDT,%DT="" S:(OCXDT["@")!(OCXDT="N") %DT="T" D ^%DT S OCXDT=+Y
"RTN","ORY26903",100,0)
 ;;R^"860.8:",100,30
"RTN","ORY26903",101,0)
 ;;D^  ; ;
"RTN","ORY26903",102,0)
 ;;R^"860.8:",100,31
"RTN","ORY26903",103,0)
 ;;D^  ; I ($L(OCXDT\1)>7) S OCXDT=$$HL7TFM^XLFDT(OCXDT)  ; HL7 FORMAT TO INTERNAL FILEMAN FORMAT
"RTN","ORY26903",104,0)
 ;;R^"860.8:",100,32
"RTN","ORY26903",105,0)
 ;;D^  ; ;
"RTN","ORY26903",106,0)
 ;;R^"860.8:",100,33
"RTN","ORY26903",107,0)
 ;;D^  ; I ($L(OCXDT\1)=7) S OCXDT=$$FMTH^XLFDT(+OCXDT)   ; INTERNAL FILEMAN FORMAT TO $H FORMAT
"RTN","ORY26903",108,0)
 ;;R^"860.8:",100,34
"RTN","ORY26903",109,0)
 ;;D^  ; ;
"RTN","ORY26903",110,0)
 ;;R^"860.8:",100,35
"RTN","ORY26903",111,0)
 ;;D^  ; I (OCXDT?5N1","1.5N) S OCXVAL=(OCXDT*86400)+$P(OCXDT,",",2)     ;  $H FORMAT TO EXPERT SYSTEM INTERNAL FORMAT
"RTN","ORY26903",112,0)
 ;;R^"860.8:",100,36
"RTN","ORY26903",113,0)
 ;;D^  ; ;
"RTN","ORY26903",114,0)
 ;;R^"860.8:",100,37
"RTN","ORY26903",115,0)
 ;;D^  ; Q OCXVAL
"RTN","ORY26903",116,0)
 ;;R^"860.8:",100,38
"RTN","ORY26903",117,0)
 ;;D^  ; ;
"RTN","ORY26903",118,0)
 ;;EOR^
"RTN","ORY26903",119,0)
 ;;KEY^860.8:^CONVERT DATE FROM OCX FORMAT TO READABLE FORMAT
"RTN","ORY26903",120,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26903",121,0)
 ;;D^CONVERT DATE FROM OCX FORMAT TO READABLE FORMAT
"RTN","ORY26903",122,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26903",123,0)
 ;;D^INT2DT
"RTN","ORY26903",124,0)
 ;;R^"860.8:",1,1
"RTN","ORY26903",125,0)
 ;;D^  ;INT2DT(OCXDT,OCXF) ;      This Local Extrinsic Function converts an OCX internal format
"RTN","ORY26903",126,0)
 ;;R^"860.8:",1,2
"RTN","ORY26903",127,0)
 ;;D^  ; ; date into an Externl Format (Human Readable) date.   'OCXF=SHORT FORMAT OCXF=LONG FORMAT
"RTN","ORY26903",128,0)
 ;;R^"860.8:",1,3
"RTN","ORY26903",129,0)
 ;;D^  ; ;
"RTN","ORY26903",130,0)
 ;;R^"860.8:",100,1
"RTN","ORY26903",131,0)
 ;;D^  ;INT2DT(OCXDT,OCXF) ;      This Local Extrinsic Function converts an OCX internal format
"RTN","ORY26903",132,0)
 ;;R^"860.8:",100,2
"RTN","ORY26903",133,0)
 ;;D^  ; ; date into an Externl Format (Human Readable) date.   'OCXF=SHORT FORMAT OCXF=LONG FORMAT
"RTN","ORY26903",134,0)
 ;;R^"860.8:",100,3
"RTN","ORY26903",135,0)
 ;;D^  ; ;
"RTN","ORY26903",136,0)
 ;;R^"860.8:",100,4
"RTN","ORY26903",137,0)
 ;;D^  ; Q:'$L($G(OCXDT)) "" S OCXF=+$G(OCXF)
"RTN","ORY26903",138,0)
 ;;R^"860.8:",100,5
"RTN","ORY26903",139,0)
 ;;D^  ; N OCXYR,OCXLPYR,OCXMON,OCXDAY,OCXHR,OCXMIN,OCXSEC,OCXCYR
"RTN","ORY26903",140,0)
 ;;R^"860.8:",100,6
"RTN","ORY26903",141,0)
 ;;D^  ; S (OCXYR,OCXLPYR,OCXMON,OCXDAY,OCXHR,OCXMIN,OCXSEC,OCXAP)=""
"RTN","ORY26903",142,0)
 ;;R^"860.8:",100,7
"RTN","ORY26903",143,0)
 ;;D^  ; S OCXSEC=$E(OCXDT#60+100,2,3),OCXDT=OCXDT\60
"RTN","ORY26903",144,0)
 ;;R^"860.8:",100,8
"RTN","ORY26903",145,0)
 ;;D^  ; S OCXMIN=$E(OCXDT#60+100,2,3),OCXDT=OCXDT\60
"RTN","ORY26903",146,0)
 ;;R^"860.8:",100,9
"RTN","ORY26903",147,0)
 ;;D^  ; S OCXHR=$E(OCXDT#24+100,2,3),OCXDT=OCXDT\24
"RTN","ORY26903",148,0)
 ;;R^"860.8:",100,10
"RTN","ORY26903",149,0)
 ;;D^  ; S OCXCYR=($H\1461)*4+1841+(($H#1461)\365)
"RTN","ORY26903",150,0)
 ;;R^"860.8:",100,11
"RTN","ORY26903",151,0)
 ;;D^  ; S OCXYR=(OCXDT\1461)*4+1841,OCXDT=OCXDT#1461
"RTN","ORY26903",152,0)
 ;;R^"860.8:",100,12
"RTN","ORY26903",153,0)
 ;;D^  ; S OCXLPYR=(OCXDT\365),OCXDT=OCXDT-(OCXLPYR*365),OCXYR=OCXYR+OCXLPYR
"RTN","ORY26903",154,0)
 ;;R^"860.8:",100,13
"RTN","ORY26903",155,0)
 ;;D^  ; S OCXCNT="031^059^090^120^151^181^212^243^273^304^334^365"
"RTN","ORY26903",156,0)
 ;;R^"860.8:",100,14
"RTN","ORY26903",157,0)
 ;;D^  ; S:(OCXLPYR=3) OCXCNT="031^060^091^121^152^182^213^244^274^305^335^366"
"RTN","ORY26903",158,0)
 ;;R^"860.8:",100,15
"RTN","ORY26903",159,0)
 ;;D^  ; F OCXMON=1:1:12 Q:(OCXDT<$P(OCXCNT,U,OCXMON))
"RTN","ORY26903",160,0)
 ;;R^"860.8:",100,16
"RTN","ORY26903",161,0)
 ;;D^  ; S OCXDAY=OCXDT-$P(OCXCNT,U,OCXMON-1)+1
"RTN","ORY26903",162,0)
 ;;R^"860.8:",100,17
"RTN","ORY26903",163,0)
 ;;D^  ; I OCXF S OCXMON=$P("January^February^March^April^May^June^July^August^September^October^November^December",U,OCXMON)
"RTN","ORY26903",164,0)
 ;;R^"860.8:",100,18
"RTN","ORY26903",165,0)
 ;;D^  ; E  S OCXMON=$E(OCXMON+100,2,3)
"RTN","ORY26903",166,0)
 ;;R^"860.8:",100,19
"RTN","ORY26903",167,0)
 ;;D^  ; S OCXAP=$S('OCXHR:"Midnight",(OCXHR=12):"Noon",(OCXHR<12):"AM",1:"PM")
"RTN","ORY26903",168,0)
 ;;R^"860.8:",100,20
"RTN","ORY26903",169,0)
 ;;D^  ; I OCXF S OCXHR=OCXHR#12 S:'OCXHR OCXHR=12
"RTN","ORY26903",170,0)
 ;;R^"860.8:",100,21
"RTN","ORY26903",171,0)
 ;;D^  ; Q:'OCXF $E(OCXMON+100,2,3)_"/"_$E(OCXDAY+100,2,3)_$S((OCXCYR=OCXYR):" "_OCXHR_":"_OCXMIN,1:"/"_$E(OCXYR,3,4))
"RTN","ORY26903",172,0)
 ;;R^"860.8:",100,22
"RTN","ORY26903",173,0)
 ;;D^  ; Q:(OCXHR+OCXMIN+OCXSEC) OCXMON_" "_OCXDAY_","_OCXYR_" at "_OCXHR_":"_OCXMIN_"."_OCXSEC_" "_OCXAP
"RTN","ORY26903",174,0)
 ;;R^"860.8:",100,23
"RTN","ORY26903",175,0)
 ;;D^  ; Q OCXMON_" "_OCXDAY_","_OCXYR
"RTN","ORY26903",176,0)
 ;;R^"860.8:",100,24
"RTN","ORY26903",177,0)
 ;;D^  ; ;
"RTN","ORY26903",178,0)
 ;;EOR^
"RTN","ORY26903",179,0)
 ;;KEY^860.8:^ELAPSED ORDER CHECK TIME LOGGER
"RTN","ORY26903",180,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26903",181,0)
 ;;D^ELAPSED ORDER CHECK TIME LOGGER
"RTN","ORY26903",182,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26903",183,0)
 ;;D^TIMELOG
"RTN","ORY26903",184,0)
 ;;R^"860.8:",100,1
"RTN","ORY26903",185,0)
 ;;D^  ;TIMELOG(OCXMODE,OCXCALL) ; Log an entry in the Elapsed time log.
"RTN","ORY26903",186,0)
 ;;R^"860.8:",100,2
"RTN","ORY26903",187,0)
 ;;D^  ; ;
"RTN","ORY26903",188,0)
 ;;R^"860.8:",100,3
"RTN","ORY26903",189,0)
 ;;D^  ; ;
"RTN","ORY26903",190,0)
 ;;R^"860.8:",100,4
"RTN","ORY26903",191,0)
 ;;D^  ; Q 0
"RTN","ORY26903",192,0)
 ;;R^"860.8:",100,5
"RTN","ORY26903",193,0)
 ;;D^  ; ;
"RTN","ORY26903",194,0)
 ;;EOR^
"RTN","ORY26903",195,0)
 ;;KEY^860.8:^EQUALS TERM OPERATOR
"RTN","ORY26903",196,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26903",197,0)
 ;;D^EQUALS TERM OPERATOR
"RTN","ORY26903",198,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26903",199,0)
 ;1;
"RTN","ORY26903",200,0)
 ;
"RTN","ORY26904")
0^13^B65797598
"RTN","ORY26904",1,0)
ORY26904 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY26904",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY26904",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY26904",4,0)
 ;
"RTN","ORY26904",5,0)
S ;
"RTN","ORY26904",6,0)
 ;
"RTN","ORY26904",7,0)
 D DOT^ORY269ES
"RTN","ORY26904",8,0)
 ;
"RTN","ORY26904",9,0)
 ;
"RTN","ORY26904",10,0)
 K REMOTE,LOCAL,OPCODE,REF
"RTN","ORY26904",11,0)
 F LINE=1:1:500 S TEXT=$P($T(DATA+LINE),";",2,999) Q:TEXT  I $L(TEXT) D  Q:QUIT
"RTN","ORY26904",12,0)
 .S ^TMP("OCXRULE",$J,$O(^TMP("OCXRULE",$J,"A"),-1)+1)=TEXT
"RTN","ORY26904",13,0)
 ;
"RTN","ORY26904",14,0)
 G ^ORY26905
"RTN","ORY26904",15,0)
 ;
"RTN","ORY26904",16,0)
 Q
"RTN","ORY26904",17,0)
 ;
"RTN","ORY26904",18,0)
DATA ;
"RTN","ORY26904",19,0)
 ;
"RTN","ORY26904",20,0)
 ;;D^EQTERM
"RTN","ORY26904",21,0)
 ;;R^"860.8:",100,1
"RTN","ORY26904",22,0)
 ;;D^  ;EQTERM(DATA,TERM) ;
"RTN","ORY26904",23,0)
 ;;R^"860.8:",100,2
"RTN","ORY26904",24,0)
 ;;D^  ; ;
"RTN","ORY26904",25,0)
 ;;R^"860.8:",100,3
"RTN","ORY26904",26,0)
 ;;D^T+; I $G(OCXTRACE) W !,"%%%%",?20," Execution trace  DATA: ",$G(DATA),"   TERM: ",$G(TERM)
"RTN","ORY26904",27,0)
 ;;R^"860.8:",100,4
"RTN","ORY26904",28,0)
 ;;D^  ; N OCXF,OCXL
"RTN","ORY26904",29,0)
 ;;R^"860.8:",100,5
"RTN","ORY26904",30,0)
 ;;D^  ; ;
"RTN","ORY26904",31,0)
 ;;R^"860.8:",100,6
"RTN","ORY26904",32,0)
 ;;D^  ; S OCXL="",OCXF=$$TERMLKUP(TERM,.OCXL)
"RTN","ORY26904",33,0)
 ;;R^"860.8:",100,7
"RTN","ORY26904",34,0)
 ;;D^T-; Q:'OCXF 0
"RTN","ORY26904",35,0)
 ;;R^"860.8:",100,8
"RTN","ORY26904",36,0)
 ;;D^T+; I 'OCXF W:$G(OCXTRACE) !,"%%%%",?20," Term '",TERM,"' not in Order Check National Term File" Q 0
"RTN","ORY26904",37,0)
 ;;R^"860.8:",100,9
"RTN","ORY26904",38,0)
 ;;D^T+; I '$O(OCXL(0)) W:$G(OCXTRACE) !,"%%%%",?20," There are no local terms listed for the National Term '",TERM,"'." Q 0
"RTN","ORY26904",39,0)
 ;;R^"860.8:",100,10
"RTN","ORY26904",40,0)
 ;;D^T+; I ($D(OCXL(DATA))!$D(OCXL("B",DATA))) W:$G(OCXTRACE) !,"%%%%",?20," Data equals Term" Q 1
"RTN","ORY26904",41,0)
 ;;R^"860.8:",100,11
"RTN","ORY26904",42,0)
 ;;D^T-; I ($D(OCXL(DATA))!$D(OCXL("B",DATA))) Q 1
"RTN","ORY26904",43,0)
 ;;R^"860.8:",100,12
"RTN","ORY26904",44,0)
 ;;D^T-; Q 0
"RTN","ORY26904",45,0)
 ;;R^"860.8:",100,13
"RTN","ORY26904",46,0)
 ;;D^T+; W:$G(OCXTRACE) !,"%%%%",?20," Data does not equal Term" Q 0
"RTN","ORY26904",47,0)
 ;;R^"860.8:",100,14
"RTN","ORY26904",48,0)
 ;;D^  ; ;
"RTN","ORY26904",49,0)
 ;;EOR^
"RTN","ORY26904",50,0)
 ;;KEY^860.8:^FILE DATA IN PATIENT ACTIVE DATA FILE
"RTN","ORY26904",51,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26904",52,0)
 ;;D^FILE DATA IN PATIENT ACTIVE DATA FILE
"RTN","ORY26904",53,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26904",54,0)
 ;;D^FILE
"RTN","ORY26904",55,0)
 ;;R^"860.8:",1,1
"RTN","ORY26904",56,0)
 ;;D^  ;FILE(DFN,OCXELE,OCXDFL) ;     This Local Extrinsic Function files data
"RTN","ORY26904",57,0)
 ;;R^"860.8:",1,2
"RTN","ORY26904",58,0)
 ;;D^  ; ;     in the Order Check Patient Data File
"RTN","ORY26904",59,0)
 ;;R^"860.8:",1,3
"RTN","ORY26904",60,0)
 ;;D^  ; ;
"RTN","ORY26904",61,0)
 ;;R^"860.8:",100,1
"RTN","ORY26904",62,0)
 ;;D^  ;FILE(DFN,OCXELE,OCXDFL) ;     This Local Extrinsic Function logs a validated event/element.
"RTN","ORY26904",63,0)
 ;;R^"860.8:",100,2
"RTN","ORY26904",64,0)
 ;;D^  ; ;
"RTN","ORY26904",65,0)
 ;;R^"860.8:",100,3
"RTN","ORY26904",66,0)
 ;;D^T+; I $G(OCXTRACE) W !,"%%%%",?20," Execution trace  DFN: ",DFN,"   OCXELE: ",+$G(OCXELE),"   OCXDFL: ",$G(OCXDFL)
"RTN","ORY26904",67,0)
 ;;R^"860.8:",100,4
"RTN","ORY26904",68,0)
 ;;D^  ; N OCXTIMN,OCXTIML,OCXTIMT1,OCXTIMT2,OCXDATA,OCXPC,OCXPC,OCXVAL,OCXSUB,OCXDFI
"RTN","ORY26904",69,0)
 ;;R^"860.8:",100,5
"RTN","ORY26904",70,0)
 ;;D^  ; S DFN=+$G(DFN),OCXELE=+$G(OCXELE)
"RTN","ORY26904",71,0)
 ;;R^"860.8:",100,6
"RTN","ORY26904",72,0)
 ;;D^  ; ;
"RTN","ORY26904",73,0)
 ;;R^"860.8:",100,7
"RTN","ORY26904",74,0)
 ;;D^  ; Q:'DFN 1 Q:'OCXELE 1 K OCXDATA
"RTN","ORY26904",75,0)
 ;;R^"860.8:",100,8
"RTN","ORY26904",76,0)
 ;;D^  ; ;
"RTN","ORY26904",77,0)
 ;;R^"860.8:",100,9
"RTN","ORY26904",78,0)
 ;;D^  ; S OCXDATA(DFN,OCXELE)=1
"RTN","ORY26904",79,0)
 ;;R^"860.8:",100,10
"RTN","ORY26904",80,0)
 ;;D^  ; F OCXPC=1:1:$L(OCXDFL,",") S OCXDFI=$P(OCXDFL,",",OCXPC) I OCXDFI D
"RTN","ORY26904",81,0)
 ;;R^"860.8:",100,11
"RTN","ORY26904",82,0)
 ;;D^  ; .S OCXVAL=$G(OCXDF(+OCXDFI)),OCXDATA(DFN,OCXELE,+OCXDFI)=OCXVAL
"RTN","ORY26904",83,0)
 ;;R^"860.8:",100,12
"RTN","ORY26904",84,0)
 ;;D^T+; .I $G(OCXTRACE) W !,"%%%%",?20,"   ",$P($G(^OCXS(860.4,+OCXDFI,0)),U,1)," = """,OCXVAL,""""
"RTN","ORY26904",85,0)
 ;;R^"860.8:",100,13
"RTN","ORY26904",86,0)
 ;;D^  ; ;
"RTN","ORY26904",87,0)
 ;;R^"860.8:",100,14
"RTN","ORY26904",88,0)
 ;;D^  ; M ^TMP("OCXCHK",$J,DFN)=OCXDATA(DFN)
"RTN","ORY26904",89,0)
 ;;R^"860.8:",100,15
"RTN","ORY26904",90,0)
 ;;D^  ; ;
"RTN","ORY26904",91,0)
 ;;R^"860.8:",100,16
"RTN","ORY26904",92,0)
 ;;D^  ; Q 0
"RTN","ORY26904",93,0)
 ;;R^"860.8:",100,17
"RTN","ORY26904",94,0)
 ;;D^  ; ;
"RTN","ORY26904",95,0)
 ;;EOR^
"RTN","ORY26904",96,0)
 ;;KEY^860.8:^GENERATE STRING CHECKSUM
"RTN","ORY26904",97,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26904",98,0)
 ;;D^GENERATE STRING CHECKSUM
"RTN","ORY26904",99,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26904",100,0)
 ;;D^CKSUM
"RTN","ORY26904",101,0)
 ;;R^"860.8:",100,1
"RTN","ORY26904",102,0)
 ;;D^  ;CKSUM(STR) ;
"RTN","ORY26904",103,0)
 ;;R^"860.8:",100,2
"RTN","ORY26904",104,0)
 ;;D^  ; ;
"RTN","ORY26904",105,0)
 ;;R^"860.8:",100,3
"RTN","ORY26904",106,0)
 ;;D^  ; N CKSUM,PTR,ASC S CKSUM=0
"RTN","ORY26904",107,0)
 ;;R^"860.8:",100,4
"RTN","ORY26904",108,0)
 ;;D^  ; S STR=$TR(STR,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","ORY26904",109,0)
 ;;R^"860.8:",100,5
"RTN","ORY26904",110,0)
 ;;D^  ; F PTR=$L(STR):-1:1 S ASC=$A(STR,PTR)-42 I (ASC>0),(ASC<51) S CKSUM=CKSUM*2+ASC
"RTN","ORY26904",111,0)
 ;;R^"860.8:",100,6
"RTN","ORY26904",112,0)
 ;;D^  ; Q +CKSUM
"RTN","ORY26904",113,0)
 ;;R^"860.8:",100,7
"RTN","ORY26904",114,0)
 ;;D^  ; ;
"RTN","ORY26904",115,0)
 ;;EOR^
"RTN","ORY26904",116,0)
 ;;KEY^860.8:^GET DATA FROM THE ACTIVE DATA FILE
"RTN","ORY26904",117,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26904",118,0)
 ;;D^GET DATA FROM THE ACTIVE DATA FILE
"RTN","ORY26904",119,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26904",120,0)
 ;;D^GETDATA
"RTN","ORY26904",121,0)
 ;;R^"860.8:",100,1
"RTN","ORY26904",122,0)
 ;;D^  ;GETDATA(DFN,OCXL,OCXDFI) ;     This Local Extrinsic Function returns runtime data
"RTN","ORY26904",123,0)
 ;;R^"860.8:",100,2
"RTN","ORY26904",124,0)
 ;;D^  ; ;
"RTN","ORY26904",125,0)
 ;;R^"860.8:",100,3
"RTN","ORY26904",126,0)
 ;;D^  ; N OCXE,VAL,PC S VAL=""
"RTN","ORY26904",127,0)
 ;;R^"860.8:",100,4
"RTN","ORY26904",128,0)
 ;;D^  ; F PC=1:1:$L(OCXL,U) S OCXE=$P(OCXL,U,PC) I OCXE S VAL=$G(^TMP("OCXCHK",$J,DFN,OCXE,OCXDFI)) Q:$L(VAL)
"RTN","ORY26904",129,0)
 ;;R^"860.8:",100,5
"RTN","ORY26904",130,0)
 ;;D^  ; Q VAL
"RTN","ORY26904",131,0)
 ;;R^"860.8:",100,6
"RTN","ORY26904",132,0)
 ;;D^  ; ;
"RTN","ORY26904",133,0)
 ;;EOR^
"RTN","ORY26904",134,0)
 ;;KEY^860.8:^IN LIST OPERATOR
"RTN","ORY26904",135,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26904",136,0)
 ;;D^IN LIST OPERATOR
"RTN","ORY26904",137,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26904",138,0)
 ;;D^LIST
"RTN","ORY26904",139,0)
 ;;R^"860.8:",100,1
"RTN","ORY26904",140,0)
 ;;D^  ;LIST(DATA,LIST) ;   IS THE DATA FIELD IN THE LIST
"RTN","ORY26904",141,0)
 ;;R^"860.8:",100,2
"RTN","ORY26904",142,0)
 ;;D^  ; ;
"RTN","ORY26904",143,0)
 ;;R^"860.8:",100,3
"RTN","ORY26904",144,0)
 ;;D^T+; W:$G(OCXTRACE) !,"%%%%",?20,"     $$LIST(""",DATA,""",""",LIST,""")"
"RTN","ORY26904",145,0)
 ;;R^"860.8:",100,4
"RTN","ORY26904",146,0)
 ;;D^  ; S:'($E(LIST,1)=",") LIST=","_LIST S:'($E(LIST,$L(LIST))=",") LIST=LIST_"," S DATA=","_DATA_","
"RTN","ORY26904",147,0)
 ;;R^"860.8:",100,5
"RTN","ORY26904",148,0)
 ;;D^  ; Q (LIST[DATA)
"RTN","ORY26904",149,0)
 ;;R^"860.8:",100,6
"RTN","ORY26904",150,0)
 ;;D^  ; ;
"RTN","ORY26904",151,0)
 ;;EOR^
"RTN","ORY26904",152,0)
 ;;KEY^860.8:^LOCAL TERM LOOKUP
"RTN","ORY26904",153,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26904",154,0)
 ;;D^LOCAL TERM LOOKUP
"RTN","ORY26904",155,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26904",156,0)
 ;;D^TERMLKUP
"RTN","ORY26904",157,0)
 ;;R^"860.8:",1,1
"RTN","ORY26904",158,0)
 ;;D^ 
"RTN","ORY26904",159,0)
 ;;R^"860.8:",1,2
"RTN","ORY26904",160,0)
 ;;D^  This function allows a local site to define to Order Checking
"RTN","ORY26904",161,0)
 ;;R^"860.8:",1,3
"RTN","ORY26904",162,0)
 ;;D^ a term specific to that site. (ie. Lab Test Name, Radiology
"RTN","ORY26904",163,0)
 ;;R^"860.8:",1,4
"RTN","ORY26904",164,0)
 ;;D^ procedure name, etc.)
"RTN","ORY26904",165,0)
 ;;R^"860.8:",1,5
"RTN","ORY26904",166,0)
 ;;D^ 
"RTN","ORY26904",167,0)
 ;;R^"860.8:",100,1
"RTN","ORY26904",168,0)
 ;;D^  ;TERMLKUP(OCXTERM,OCXFILE) ;
"RTN","ORY26904",169,0)
 ;;R^"860.8:",100,2
"RTN","ORY26904",170,0)
 ;;D^  ; ;
"RTN","ORY26904",171,0)
 ;;R^"860.8:",100,3
"RTN","ORY26904",172,0)
 ;;D^  ; Q
"RTN","ORY26904",173,0)
 ;;R^"860.8:",100,4
"RTN","ORY26904",174,0)
 ;;D^  ; ;
"RTN","ORY26904",175,0)
 ;;EOR^
"RTN","ORY26904",176,0)
 ;;KEY^860.8:^NEW RULE MESSAGE
"RTN","ORY26904",177,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26904",178,0)
 ;;D^NEW RULE MESSAGE
"RTN","ORY26904",179,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26904",180,0)
 ;;D^NEWRULE
"RTN","ORY26904",181,0)
 ;;R^"860.8:",100,1
"RTN","ORY26904",182,0)
 ;;D^  ;NEWRULE(OCXDFN,OCXORD,OCXRUL,OCXREL,OCXNOTF,OCXMESS) ; Has this rule already been triggered for this order number
"RTN","ORY26904",183,0)
 ;;R^"860.8:",100,2
"RTN","ORY26904",184,0)
 ;;D^  ; ;
"RTN","ORY26904",185,0)
 ;;R^"860.8:",100,3
"RTN","ORY26904",186,0)
 ;;D^L+; S OCXERR=$$TIMELOG("M","NEWRULE("_(+$G(OCXDFN))_","_(+$G(OCXORD))_","_(+$G(OCXRUL))_","_(+$G(OCXREL))_","_(+$G(OCXNOTF))_","_$G(OCXMESS)_")")
"RTN","ORY26904",187,0)
 ;;R^"860.8:",100,4
"RTN","ORY26904",188,0)
 ;;D^  ; ;
"RTN","ORY26904",189,0)
 ;;R^"860.8:",100,5
"RTN","ORY26904",190,0)
 ;;D^  ; Q:'$G(OCXDFN) 0 Q:'$G(OCXRUL) 0
"RTN","ORY26904",191,0)
 ;;R^"860.8:",100,6
"RTN","ORY26904",192,0)
 ;;D^  ; Q:'$G(OCXREL) 0  Q:'$G(OCXNOTF) 0  Q:'$L($G(OCXMESS)) 0
"RTN","ORY26904",193,0)
 ;;R^"860.8:",100,7
"RTN","ORY26904",194,0)
 ;;D^  ; S OCXORD=+$G(OCXORD),OCXDFN=+OCXDFN
"RTN","ORY26904",195,0)
 ;;R^"860.8:",100,8
"RTN","ORY26904",196,0)
 ;;D^  ; ;
"RTN","ORY26904",197,0)
 ;;R^"860.8:",100,9
"RTN","ORY26904",198,0)
 ;;D^  ; N OCXNDX,OCXDATA,OCXDFI,OCXELE,OCXGR,OCXTIME,OCXCKSUM,OCXTSP,OCXTSPL
"RTN","ORY26904",199,0)
 ;;R^"860.8:",100,10
"RTN","ORY26904",200,0)
 ;;D^  ; ;
"RTN","ORY26904",201,0)
 ;;R^"860.8:",100,11
"RTN","ORY26904",202,0)
 ;;D^  ; S OCXTIME=(+$H)
"RTN","ORY26904",203,0)
 ;;R^"860.8:",100,12
"RTN","ORY26904",204,0)
 ;;D^  ; S OCXCKSUM=$$CKSUM(OCXMESS)
"RTN","ORY26904",205,0)
 ;;R^"860.8:",100,13
"RTN","ORY26904",206,0)
 ;;D^  ; ;
"RTN","ORY26904",207,0)
 ;;R^"860.8:",100,14
"RTN","ORY26904",208,0)
 ;;D^  ; S OCXTSP=($H*86400)+$P($H,",",2)
"RTN","ORY26904",209,0)
 ;;R^"860.8:",100,15
"RTN","ORY26904",210,0)
 ;;D^  ; S OCXTSPL=($G(^OCXD(860.7,"AT",OCXTIME,OCXDFN,OCXRUL,+OCXORD,OCXCKSUM))+$G(OCXTSPI,300))
"RTN","ORY26904",211,0)
 ;;R^"860.8:",100,16
"RTN","ORY26904",212,0)
 ;;D^  ; ;
"RTN","ORY26904",213,0)
 ;;R^"860.8:",100,17
"RTN","ORY26904",214,0)
 ;;D^  ; Q:(OCXTSPL>OCXTSP) 0
"RTN","ORY26904",215,0)
 ;;R^"860.8:",100,18
"RTN","ORY26904",216,0)
 ;;D^  ; ;
"RTN","ORY26904",217,0)
 ;;R^"860.8:",100,19
"RTN","ORY26904",218,0)
 ;;D^  ; K OCXDATA
"RTN","ORY26904",219,0)
 ;;R^"860.8:",100,20
"RTN","ORY26904",220,0)
 ;;D^  ; S OCXDATA(OCXDFN,0)=OCXDFN
"RTN","ORY26904",221,0)
 ;;R^"860.8:",100,21
"RTN","ORY26904",222,0)
 ;;D^  ; S OCXDATA("B",OCXDFN,OCXDFN)=""
"RTN","ORY26904",223,0)
 ;;R^"860.8:",100,22
"RTN","ORY26904",224,0)
 ;;D^  ; S OCXDATA("AT",OCXTIME,OCXDFN,OCXRUL,+OCXORD,OCXCKSUM)=OCXTSP
"RTN","ORY26904",225,0)
 ;;R^"860.8:",100,23
"RTN","ORY26904",226,0)
 ;;D^  ; ;
"RTN","ORY26904",227,0)
 ;;R^"860.8:",100,24
"RTN","ORY26904",228,0)
 ;;D^  ; S OCXGR="^OCXD(860.7"
"RTN","ORY26904",229,0)
 ;;R^"860.8:",100,25
"RTN","ORY26904",230,0)
 ;;D^T+; D SETAP(OCXGR_")",0,"Patient",$P($G(^DPT(OCXDFN,0)),U,1),.OCXDATA,OCXDFN)
"RTN","ORY26904",231,0)
 ;;R^"860.8:",100,26
"RTN","ORY26904",232,0)
 ;;D^T-; D SETAP(OCXGR_")",0,.OCXDATA,OCXDFN)
"RTN","ORY26904",233,0)
 ;;R^"860.8:",100,27
"RTN","ORY26904",234,0)
 ;;D^  ; ;
"RTN","ORY26904",235,0)
 ;;R^"860.8:",100,28
"RTN","ORY26904",236,0)
 ;;D^  ; K OCXDATA
"RTN","ORY26904",237,0)
 ;;R^"860.8:",100,29
"RTN","ORY26904",238,0)
 ;;D^  ; S OCXDATA(OCXRUL,0)=OCXRUL_U_(OCXTIME)_U_(+OCXORD)
"RTN","ORY26904",239,0)
 ;;R^"860.8:",100,30
"RTN","ORY26904",240,0)
 ;;D^  ; S OCXDATA(OCXRUL,"M")=OCXMESS
"RTN","ORY26904",241,0)
 ;;R^"860.8:",100,31
"RTN","ORY26904",242,0)
 ;;D^  ; S OCXDATA("B",OCXRUL,OCXRUL)=""
"RTN","ORY26904",243,0)
 ;;R^"860.8:",100,32
"RTN","ORY26904",244,0)
 ;;D^  ; S OCXGR=OCXGR_","_OCXDFN_",1"
"RTN","ORY26904",245,0)
 ;;R^"860.8:",100,33
"RTN","ORY26904",246,0)
 ;;D^T+; D SETAP(OCXGR_")","860.71P","Rule",$P($G(^OCXS(860.2,OCXRUL,0)),U,1),.OCXDATA,OCXRUL)
"RTN","ORY26904",247,0)
 ;;R^"860.8:",100,34
"RTN","ORY26904",248,0)
 ;1;
"RTN","ORY26904",249,0)
 ;
"RTN","ORY26905")
0^14^B54406345
"RTN","ORY26905",1,0)
ORY26905 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY26905",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY26905",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY26905",4,0)
 ;
"RTN","ORY26905",5,0)
S ;
"RTN","ORY26905",6,0)
 ;
"RTN","ORY26905",7,0)
 D DOT^ORY269ES
"RTN","ORY26905",8,0)
 ;
"RTN","ORY26905",9,0)
 ;
"RTN","ORY26905",10,0)
 K REMOTE,LOCAL,OPCODE,REF
"RTN","ORY26905",11,0)
 F LINE=1:1:500 S TEXT=$P($T(DATA+LINE),";",2,999) Q:TEXT  I $L(TEXT) D  Q:QUIT
"RTN","ORY26905",12,0)
 .S ^TMP("OCXRULE",$J,$O(^TMP("OCXRULE",$J,"A"),-1)+1)=TEXT
"RTN","ORY26905",13,0)
 ;
"RTN","ORY26905",14,0)
 ;
"RTN","ORY26905",15,0)
 ;
"RTN","ORY26905",16,0)
 Q
"RTN","ORY26905",17,0)
 ;
"RTN","ORY26905",18,0)
DATA ;
"RTN","ORY26905",19,0)
 ;
"RTN","ORY26905",20,0)
 ;;D^T-; D SETAP(OCXGR_")","860.71P",.OCXDATA,OCXRUL)
"RTN","ORY26905",21,0)
 ;;R^"860.8:",100,35
"RTN","ORY26905",22,0)
 ;;D^  ; ;
"RTN","ORY26905",23,0)
 ;;R^"860.8:",100,36
"RTN","ORY26905",24,0)
 ;;D^  ; K OCXDATA
"RTN","ORY26905",25,0)
 ;;R^"860.8:",100,37
"RTN","ORY26905",26,0)
 ;;D^  ; S OCXDATA(OCXREL,0)=OCXREL
"RTN","ORY26905",27,0)
 ;;R^"860.8:",100,38
"RTN","ORY26905",28,0)
 ;;D^  ; S OCXDATA("B",OCXREL,OCXREL)=""
"RTN","ORY26905",29,0)
 ;;R^"860.8:",100,39
"RTN","ORY26905",30,0)
 ;;D^  ; S OCXGR=OCXGR_","_OCXRUL_",1"
"RTN","ORY26905",31,0)
 ;;R^"860.8:",100,40
"RTN","ORY26905",32,0)
 ;;D^T+; D SETAP(OCXGR_")","860.712","Relation",OCXREL,.OCXDATA,OCXREL)
"RTN","ORY26905",33,0)
 ;;R^"860.8:",100,41
"RTN","ORY26905",34,0)
 ;;D^T-; D SETAP(OCXGR_")","860.712",.OCXDATA,OCXREL)
"RTN","ORY26905",35,0)
 ;;R^"860.8:",100,42
"RTN","ORY26905",36,0)
 ;;D^  ; ;
"RTN","ORY26905",37,0)
 ;;R^"860.8:",100,43
"RTN","ORY26905",38,0)
 ;;D^  ; S OCXELE=0 F  S OCXELE=$O(^OCXS(860.2,OCXRUL,"C","C",OCXELE)) Q:'OCXELE  D
"RTN","ORY26905",39,0)
 ;;R^"860.8:",100,44
"RTN","ORY26905",40,0)
 ;;D^  ; .;
"RTN","ORY26905",41,0)
 ;;R^"860.8:",100,45
"RTN","ORY26905",42,0)
 ;;D^  ; .N OCXGR1
"RTN","ORY26905",43,0)
 ;;R^"860.8:",100,46
"RTN","ORY26905",44,0)
 ;;D^  ; .S OCXGR1=OCXGR_","_OCXREL_",1"
"RTN","ORY26905",45,0)
 ;;R^"860.8:",100,47
"RTN","ORY26905",46,0)
 ;;D^  ; .K OCXDATA
"RTN","ORY26905",47,0)
 ;;R^"860.8:",100,48
"RTN","ORY26905",48,0)
 ;;D^  ; .S OCXDATA(OCXELE,0)=OCXELE
"RTN","ORY26905",49,0)
 ;;R^"860.8:",100,49
"RTN","ORY26905",50,0)
 ;;D^  ; .S OCXDATA(OCXELE,"TIME")=OCXTIME
"RTN","ORY26905",51,0)
 ;;R^"860.8:",100,50
"RTN","ORY26905",52,0)
 ;;D^  ; .S OCXDATA(OCXELE,"LOG")=$G(OCXOLOG)
"RTN","ORY26905",53,0)
 ;;R^"860.8:",100,51
"RTN","ORY26905",54,0)
 ;;D^  ; .S OCXDATA("B",OCXELE,OCXELE)=""
"RTN","ORY26905",55,0)
 ;;R^"860.8:",100,52
"RTN","ORY26905",56,0)
 ;;D^  ; .K ^OCXD(860.7,OCXDFN,1,OCXRUL,1,OCXREL,1,OCXELE)
"RTN","ORY26905",57,0)
 ;;R^"860.8:",100,53
"RTN","ORY26905",58,0)
 ;;D^T+; .D SETAP(OCXGR1_")","860.7122P","Element",$P($G(^OCXS(860.3,OCXELE,0)),U,1),.OCXDATA,OCXELE)
"RTN","ORY26905",59,0)
 ;;R^"860.8:",100,54
"RTN","ORY26905",60,0)
 ;;D^T-; .D SETAP(OCXGR1_")","860.7122P",.OCXDATA,OCXELE)
"RTN","ORY26905",61,0)
 ;;R^"860.8:",100,55
"RTN","ORY26905",62,0)
 ;;D^  ; .;
"RTN","ORY26905",63,0)
 ;;R^"860.8:",100,56
"RTN","ORY26905",64,0)
 ;;D^  ; .S OCXDFI=0 F  S OCXDFI=$O(^TMP("OCXCHK",$J,OCXDFN,OCXELE,OCXDFI)) Q:'OCXDFI  D
"RTN","ORY26905",65,0)
 ;;R^"860.8:",100,57
"RTN","ORY26905",66,0)
 ;;D^  ; ..N OCXGR2
"RTN","ORY26905",67,0)
 ;;R^"860.8:",100,58
"RTN","ORY26905",68,0)
 ;;D^  ; ..S OCXGR2=OCXGR1_","_OCXELE_",1"
"RTN","ORY26905",69,0)
 ;;R^"860.8:",100,59
"RTN","ORY26905",70,0)
 ;;D^  ; ..K OCXDATA
"RTN","ORY26905",71,0)
 ;;R^"860.8:",100,60
"RTN","ORY26905",72,0)
 ;;D^  ; ..S OCXDATA(OCXDFI,0)=OCXDFI
"RTN","ORY26905",73,0)
 ;;R^"860.8:",100,61
"RTN","ORY26905",74,0)
 ;;D^  ; ..S OCXDATA(OCXDFI,"VAL")=^TMP("OCXCHK",$J,OCXDFN,OCXELE,OCXDFI)
"RTN","ORY26905",75,0)
 ;;R^"860.8:",100,62
"RTN","ORY26905",76,0)
 ;;D^  ; ..S OCXDATA("B",OCXDFI,OCXDFI)=""
"RTN","ORY26905",77,0)
 ;;R^"860.8:",100,63
"RTN","ORY26905",78,0)
 ;;D^T+; ..D SETAP(OCXGR2_")","860.71223P","Data Field",$P($G(^OCXS(860.4,OCXDFI,0)),U,1),.OCXDATA,OCXDFI)
"RTN","ORY26905",79,0)
 ;;R^"860.8:",100,64
"RTN","ORY26905",80,0)
 ;;D^T-; ..D SETAP(OCXGR2_")","860.71223P",.OCXDATA,OCXDFI)
"RTN","ORY26905",81,0)
 ;;R^"860.8:",100,65
"RTN","ORY26905",82,0)
 ;;D^  ; ;
"RTN","ORY26905",83,0)
 ;;R^"860.8:",100,66
"RTN","ORY26905",84,0)
 ;;D^  ; Q 1
"RTN","ORY26905",85,0)
 ;;R^"860.8:",100,67
"RTN","ORY26905",86,0)
 ;;D^  ; ;
"RTN","ORY26905",87,0)
 ;;R^"860.8:",100,68
"RTN","ORY26905",88,0)
 ;;D^T+;SETAP(ROOT,DD,ITEM,ITEMNAME,DATA,DA) ;  Set Rule Event data
"RTN","ORY26905",89,0)
 ;;R^"860.8:",100,69
"RTN","ORY26905",90,0)
 ;;D^T-;SETAP(ROOT,DD,DATA,DA) ;  Set Rule Event data
"RTN","ORY26905",91,0)
 ;;R^"860.8:",100,70
"RTN","ORY26905",92,0)
 ;;D^  ; M @ROOT=DATA
"RTN","ORY26905",93,0)
 ;;R^"860.8:",100,71
"RTN","ORY26905",94,0)
 ;;D^  ; I +$G(DD) S @ROOT@(0)="^"_($G(DD))_"^"_($P($G(@ROOT@(0)),U,3)+1)_"^"_$G(DA)
"RTN","ORY26905",95,0)
 ;;R^"860.8:",100,72
"RTN","ORY26905",96,0)
 ;;D^  ; I '$G(DD) S $P(@ROOT@(0),U,3,4)=($P($G(@ROOT@(0)),U,3)+1)_"^"_$G(DA)
"RTN","ORY26905",97,0)
 ;;R^"860.8:",100,73
"RTN","ORY26905",98,0)
 ;;D^T+; W:$G(OCXTRACE) !,"File Active Data ",$G(ITEM),": ",$G(ITEMNAME)
"RTN","ORY26905",99,0)
 ;;R^"860.8:",100,74
"RTN","ORY26905",100,0)
 ;;D^  ; ;
"RTN","ORY26905",101,0)
 ;;R^"860.8:",100,75
"RTN","ORY26905",102,0)
 ;;D^  ; Q
"RTN","ORY26905",103,0)
 ;;R^"860.8:",100,76
"RTN","ORY26905",104,0)
 ;;D^  ; ;
"RTN","ORY26905",105,0)
 ;;R^"860.8:",100,77
"RTN","ORY26905",106,0)
 ;;D^  ; ;
"RTN","ORY26905",107,0)
 ;;EOR^
"RTN","ORY26905",108,0)
 ;;KEY^860.8:^RETURN POINTED TO VALUE
"RTN","ORY26905",109,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26905",110,0)
 ;;D^RETURN POINTED TO VALUE
"RTN","ORY26905",111,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26905",112,0)
 ;;D^POINTER
"RTN","ORY26905",113,0)
 ;;R^"860.8:",1,1
"RTN","ORY26905",114,0)
 ;;D^  ;POINTER(OCXFILE,D0) ;    This Local Extrinsic Function gets the value of the name field
"RTN","ORY26905",115,0)
 ;;R^"860.8:",1,2
"RTN","ORY26905",116,0)
 ;;D^  ; ;  of record D0 in file OCXFILE
"RTN","ORY26905",117,0)
 ;;R^"860.8:",100,1
"RTN","ORY26905",118,0)
 ;;D^  ;POINTER(OCXFILE,D0) ;    This Local Extrinsic Function gets the value of the name field
"RTN","ORY26905",119,0)
 ;;R^"860.8:",100,2
"RTN","ORY26905",120,0)
 ;;D^  ; ;  of record D0 in file OCXFILE
"RTN","ORY26905",121,0)
 ;;R^"860.8:",100,3
"RTN","ORY26905",122,0)
 ;;D^T+; I $G(OCXTRACE) W !,"%%%%",?20,"   FILE: ",$G(OCXFILE),"  D0: ",$G(D0)
"RTN","ORY26905",123,0)
 ;;R^"860.8:",100,4
"RTN","ORY26905",124,0)
 ;;D^  ; Q:'$G(D0) "" Q:'$L($G(OCXFILE)) ""
"RTN","ORY26905",125,0)
 ;;R^"860.8:",100,5
"RTN","ORY26905",126,0)
 ;;D^  ; N GLREF
"RTN","ORY26905",127,0)
 ;;R^"860.8:",100,6
"RTN","ORY26905",128,0)
 ;;D^  ; I '(OCXFILE=(+OCXFILE)) S GLREF=U_OCXFILE
"RTN","ORY26905",129,0)
 ;;R^"860.8:",100,7
"RTN","ORY26905",130,0)
 ;;D^  ; E  S GLREF=$$FILE^OCXBDTD(+OCXFILE,"GLOBAL NAME") Q:'$L(GLREF) ""
"RTN","ORY26905",131,0)
 ;;R^"860.8:",100,8
"RTN","ORY26905",132,0)
 ;;D^T+; I $G(OCXTRACE) W !,"%%%%",?20," GLREF: ",GLREF,"  RESOLVES TO: ",$P($G(@(GLREF_(+D0)_",0)")),U,1)
"RTN","ORY26905",133,0)
 ;;R^"860.8:",100,9
"RTN","ORY26905",134,0)
 ;;D^  ; Q $P($G(@(GLREF_(+D0)_",0)")),U,1)
"RTN","ORY26905",135,0)
 ;;R^"860.8:",100,10
"RTN","ORY26905",136,0)
 ;;D^  ; ;
"RTN","ORY26905",137,0)
 ;;EOR^
"RTN","ORY26905",138,0)
 ;;KEY^860.8:^STRING CONTAINS ONE OF A LIST OF VALUES
"RTN","ORY26905",139,0)
 ;;R^"860.8:",.01,"E"
"RTN","ORY26905",140,0)
 ;;D^STRING CONTAINS ONE OF A LIST OF VALUES
"RTN","ORY26905",141,0)
 ;;R^"860.8:",.02,"E"
"RTN","ORY26905",142,0)
 ;;D^CLIST
"RTN","ORY26905",143,0)
 ;;R^"860.8:",100,1
"RTN","ORY26905",144,0)
 ;;D^  ;CLIST(DATA,LIST) ;   DOES THE DATA FIELD CONTAIN AN ELEMENT IN THE LIST
"RTN","ORY26905",145,0)
 ;;R^"860.8:",100,2
"RTN","ORY26905",146,0)
 ;;D^  ; ;
"RTN","ORY26905",147,0)
 ;;R^"860.8:",100,3
"RTN","ORY26905",148,0)
 ;;D^T+; W:$G(OCXTRACE) !!,"$$CLIST(",DATA,",""",LIST,""")"
"RTN","ORY26905",149,0)
 ;;R^"860.8:",100,4
"RTN","ORY26905",150,0)
 ;;D^  ; N PC F PC=1:1:$L(LIST,","),0 I PC,$L($P(LIST,",",PC)),(DATA[$P(LIST,",",PC)) Q
"RTN","ORY26905",151,0)
 ;;R^"860.8:",100,5
"RTN","ORY26905",152,0)
 ;;D^  ; Q ''PC
"RTN","ORY26905",153,0)
 ;;EOR^
"RTN","ORY26905",154,0)
 ;;EOF^OCXS(860.8)^1
"RTN","ORY26905",155,0)
 ;;SOF^860.6  ORDER CHECK DATA CONTEXT
"RTN","ORY26905",156,0)
 ;;KEY^860.6:^CPRS ORDER PROTOCOL
"RTN","ORY26905",157,0)
 ;;R^"860.6:",.01,"E"
"RTN","ORY26905",158,0)
 ;;D^CPRS ORDER PROTOCOL
"RTN","ORY26905",159,0)
 ;;R^"860.6:",.02,"E"
"RTN","ORY26905",160,0)
 ;;D^OERR
"RTN","ORY26905",161,0)
 ;;R^"860.6:",1,"E"
"RTN","ORY26905",162,0)
 ;;D^DATA DRIVEN
"RTN","ORY26905",163,0)
 ;;EOR^
"RTN","ORY26905",164,0)
 ;;KEY^860.6:^DATABASE LOOKUP
"RTN","ORY26905",165,0)
 ;;R^"860.6:",.01,"E"
"RTN","ORY26905",166,0)
 ;;D^DATABASE LOOKUP
"RTN","ORY26905",167,0)
 ;;R^"860.6:",.02,"E"
"RTN","ORY26905",168,0)
 ;;D^DL
"RTN","ORY26905",169,0)
 ;;R^"860.6:",1,"E"
"RTN","ORY26905",170,0)
 ;;D^PACKAGE LOOKUP
"RTN","ORY26905",171,0)
 ;;EOR^
"RTN","ORY26905",172,0)
 ;;KEY^860.6:^GENERIC HL7 MESSAGE ARRAY
"RTN","ORY26905",173,0)
 ;;R^"860.6:",.01,"E"
"RTN","ORY26905",174,0)
 ;;D^GENERIC HL7 MESSAGE ARRAY
"RTN","ORY26905",175,0)
 ;;R^"860.6:",.02,"E"
"RTN","ORY26905",176,0)
 ;;D^HL7
"RTN","ORY26905",177,0)
 ;;R^"860.6:",1,"E"
"RTN","ORY26905",178,0)
 ;;D^DATA DRIVEN
"RTN","ORY26905",179,0)
 ;;EOR^
"RTN","ORY26905",180,0)
 ;;EOF^OCXS(860.6)^1
"RTN","ORY26905",181,0)
 ;;SOF^860.5  ORDER CHECK DATA SOURCE
"RTN","ORY26905",182,0)
 ;;KEY^860.5:^DATABASE LOOKUP
"RTN","ORY26905",183,0)
 ;;R^"860.5:",.01,"E"
"RTN","ORY26905",184,0)
 ;;D^DATABASE LOOKUP
"RTN","ORY26905",185,0)
 ;;R^"860.5:",.02,"E"
"RTN","ORY26905",186,0)
 ;;D^DATABASE LOOKUP
"RTN","ORY26905",187,0)
 ;;EOR^
"RTN","ORY26905",188,0)
 ;;KEY^860.5:^HL7 PATIENT ID SEGMENT
"RTN","ORY26905",189,0)
 ;;R^"860.5:",.01,"E"
"RTN","ORY26905",190,0)
 ;;D^HL7 PATIENT ID SEGMENT
"RTN","ORY26905",191,0)
 ;;R^"860.5:",.02,"E"
"RTN","ORY26905",192,0)
 ;;D^GENERIC HL7 MESSAGE ARRAY
"RTN","ORY26905",193,0)
 ;;EOR^
"RTN","ORY26905",194,0)
 ;;KEY^860.5:^OERR ORDER EVENT FLAG PROTOCOL
"RTN","ORY26905",195,0)
 ;;R^"860.5:",.01,"E"
"RTN","ORY26905",196,0)
 ;;D^OERR ORDER EVENT FLAG PROTOCOL
"RTN","ORY26905",197,0)
 ;;R^"860.5:",.02,"E"
"RTN","ORY26905",198,0)
 ;;D^CPRS ORDER PROTOCOL
"RTN","ORY26905",199,0)
 ;;EOR^
"RTN","ORY26905",200,0)
 ;;EOF^OCXS(860.5)^1
"RTN","ORY26905",201,0)
 ;;SOF^860.4  ORDER CHECK DATA FIELD
"RTN","ORY26905",202,0)
 ;;KEY^860.4:^PATIENT IEN
"RTN","ORY26905",203,0)
 ;;R^"860.4:",.01,"E"
"RTN","ORY26905",204,0)
 ;;D^PATIENT IEN
"RTN","ORY26905",205,0)
 ;;R^"860.4:",101,"E"
"RTN","ORY26905",206,0)
 ;;D^NUMERIC
"RTN","ORY26905",207,0)
 ;;R^"860.4:","860.41:CPRS ORDER PROTOCOL^860.6",.01,"E"
"RTN","ORY26905",208,0)
 ;;D^CPRS ORDER PROTOCOL
"RTN","ORY26905",209,0)
 ;;R^"860.4:","860.41:CPRS ORDER PROTOCOL^860.6",.02,"E"
"RTN","ORY26905",210,0)
 ;;D^OERR ORDER EVENT FLAG PROTOCOL
"RTN","ORY26905",211,0)
 ;;R^"860.4:","860.41:CPRS ORDER PROTOCOL^860.6",1,"E"
"RTN","ORY26905",212,0)
 ;;D^PATIENT.OERR_ORDER_PATIENT
"RTN","ORY26905",213,0)
 ;;R^"860.4:","860.41:DATABASE LOOKUP^860.6",.01,"E"
"RTN","ORY26905",214,0)
 ;;D^DATABASE LOOKUP
"RTN","ORY26905",215,0)
 ;;R^"860.4:","860.41:DATABASE LOOKUP^860.6",.02,"E"
"RTN","ORY26905",216,0)
 ;;D^DATABASE LOOKUP
"RTN","ORY26905",217,0)
 ;;R^"860.4:","860.41:DATABASE LOOKUP^860.6",1,"E"
"RTN","ORY26905",218,0)
 ;;D^PATIENT.IEN
"RTN","ORY26905",219,0)
 ;;R^"860.4:","860.41:GENERIC HL7 MESSAGE ARRAY^860.6",.01,"E"
"RTN","ORY26905",220,0)
 ;;D^GENERIC HL7 MESSAGE ARRAY
"RTN","ORY26905",221,0)
 ;;R^"860.4:","860.41:GENERIC HL7 MESSAGE ARRAY^860.6",.02,"E"
"RTN","ORY26905",222,0)
 ;;D^HL7 PATIENT ID SEGMENT
"RTN","ORY26905",223,0)
 ;;R^"860.4:","860.41:GENERIC HL7 MESSAGE ARRAY^860.6",1,"E"
"RTN","ORY26905",224,0)
 ;;D^PATIENT.HL7_PATIENT_ID
"RTN","ORY26905",225,0)
 ;;EOR^
"RTN","ORY26905",226,0)
 ;;EOF^OCXS(860.4)^1
"RTN","ORY26905",227,0)
 ;1;
"RTN","ORY26905",228,0)
 ;
"RTN","ORY2691")
0^16^B40554138
"RTN","ORY2691",1,0)
ORY2691 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY2691",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY2691",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY2691",4,0)
 ;
"RTN","ORY2691",5,0)
S ;
"RTN","ORY2691",6,0)
 ;
"RTN","ORY2691",7,0)
 Q
"RTN","ORY2691",8,0)
 ;
"RTN","ORY2691",9,0)
 ;
"RTN","ORY2691",10,0)
COMPARE(L,R) ;
"RTN","ORY2691",11,0)
 ;
"RTN","ORY2691",12,0)
 Q:$$RES("R") 1
"RTN","ORY2691",13,0)
 ;
"RTN","ORY2691",14,0)
 Q:'$L($O(L(""))) $$ADDREC^ORY2692("R")
"RTN","ORY2691",15,0)
 ;
"RTN","ORY2691",16,0)
 N C,OCXDD M C=L,C=R S OCXDD=$O(C("")) Q $$MULT("C",OCXDD)
"RTN","ORY2691",17,0)
 ;
"RTN","ORY2691",18,0)
 Q 0
"RTN","ORY2691",19,0)
 ;
"RTN","ORY2691",20,0)
RES(REF) ;
"RTN","ORY2691",21,0)
 ;
"RTN","ORY2691",22,0)
 N QUIT,SUB
"RTN","ORY2691",23,0)
 S QUIT=0
"RTN","ORY2691",24,0)
 S SUB="" F  S SUB=$O(@REF@(SUB)) Q:'$L(SUB)  I (SUB[":") D  Q:QUIT
"RTN","ORY2691",25,0)
 .N DD,DA
"RTN","ORY2691",26,0)
 .S DD=$P(SUB,":",1),DA=$P(SUB,":",2)
"RTN","ORY2691",27,0)
 .I $L(DA),'(DA=+DA) D  Q:QUIT
"RTN","ORY2691",28,0)
 ..N DANEW,SUBNEW
"RTN","ORY2691",29,0)
 ..S DANEW=$O(^OCXS($P(DA,U,2),"B",$P(DA,U,1),0))
"RTN","ORY2691",30,0)
 ..I 'DANEW W !!,$P($G(^OCXS(+$P(DA,U,2),0)),U,1),": ",$P(DA,U,1),"  could not resolve name.",!!,"    End Transport." S QUIT=1 Q
"RTN","ORY2691",31,0)
 ..S SUBNEW=DD_":"_DANEW
"RTN","ORY2691",32,0)
 ..I $D(@REF@(SUBNEW)) W !!," multiple #",DANEW," already existed." S QUIT=1 Q
"RTN","ORY2691",33,0)
 ..M @REF@(SUBNEW)=@REF@(SUB)
"RTN","ORY2691",34,0)
 ..K @REF@(SUB)
"RTN","ORY2691",35,0)
 ..S SUB=""
"RTN","ORY2691",36,0)
 .I $L(SUB),($D(@REF@(SUB))>9) S QUIT=$$RES($NA(@REF@(SUB)))
"RTN","ORY2691",37,0)
 ;
"RTN","ORY2691",38,0)
 Q QUIT
"RTN","ORY2691",39,0)
 ;
"RTN","ORY2691",40,0)
MULT(CREF,OCXDD) ;
"RTN","ORY2691",41,0)
 ;
"RTN","ORY2691",42,0)
 N OCXSUB,LREF,RREF,QUIT,OCXFLD
"RTN","ORY2691",43,0)
 S LREF="L"_$E(CREF,2,$L(CREF)),RREF="R"_$E(CREF,2,$L(CREF))
"RTN","ORY2691",44,0)
 ;
"RTN","ORY2691",45,0)
 S QUIT=0,OCXFLD="" F  S OCXFLD=$O(@CREF@(OCXDD,OCXFLD)) Q:'$L(OCXFLD)  D  Q:QUIT
"RTN","ORY2691",46,0)
 .I (OCXFLD[":") D  Q:QUIT
"RTN","ORY2691",47,0)
 ..Q:$$EXFLD(+OCXFLD,0)
"RTN","ORY2691",48,0)
 ..I '$D(@LREF@(OCXDD,OCXFLD,.01,"E")) D  M @LREF@(OCXDD,OCXFLD)=@RREF@(OCXDD,OCXFLD)
"RTN","ORY2691",49,0)
 ...D WARN("Missing multiple:",CREF,OCXDD,OCXFLD)
"RTN","ORY2691",50,0)
 ...S QUIT=$$ADDMULT^ORY2693(CREF,OCXDD,OCXFLD)
"RTN","ORY2691",51,0)
 ..I '$D(@RREF@(OCXDD,OCXFLD,.01,"E")) D  M @RREF@(OCXDD,OCXFLD)=@LREF@(OCXDD,OCXFLD)
"RTN","ORY2691",52,0)
 ...D WARN("Extra multiple:",CREF,OCXDD,OCXFLD)
"RTN","ORY2691",53,0)
 ...S QUIT=$$DELMULT^ORY2693($$APPEND(CREF,OCXDD),OCXFLD)
"RTN","ORY2691",54,0)
 .;
"RTN","ORY2691",55,0)
 .I (OCXFLD=+OCXFLD),'$$EXFLD(+OCXDD,OCXFLD) D
"RTN","ORY2691",56,0)
 ..I ($O(@CREF@(OCXDD,OCXFLD,""))="E") D  Q
"RTN","ORY2691",57,0)
 ...I $L($G(@RREF@(OCXDD,OCXFLD,"E"))),'$L($G(@LREF@(OCXDD,OCXFLD,"E"))) D  Q
"RTN","ORY2691",58,0)
 ....D WARN("Data Value Missing in "_$$NETNAME^OCXSEND,CREF,OCXDD,OCXFLD,"E")
"RTN","ORY2691",59,0)
 ....S QUIT=$$EDITFLD^ORY2694(CREF,OCXDD,OCXFLD,"E")
"RTN","ORY2691",60,0)
 ...I $L($G(@LREF@(OCXDD,OCXFLD,"E"))),'$L($G(@RREF@(OCXDD,OCXFLD,"E"))) D  Q
"RTN","ORY2691",61,0)
 ....D WARN("Extra Data Value in "_$$NETNAME^OCXSEND,CREF,OCXDD,OCXFLD,"E")
"RTN","ORY2691",62,0)
 ....S QUIT=$$DELFLD^ORY2694(CREF,OCXDD,OCXFLD,"E")
"RTN","ORY2691",63,0)
 ...I '(@LREF@(OCXDD,OCXFLD,"E")=@RREF@(OCXDD,OCXFLD,"E")) D
"RTN","ORY2691",64,0)
 ....D WARN("Inconsistent Data",CREF,OCXDD,OCXFLD,"E")
"RTN","ORY2691",65,0)
 ....S QUIT=$$EDITFLD^ORY2694(CREF,OCXDD,OCXFLD,"E")
"RTN","ORY2691",66,0)
 ..S OCXSUB=0 F  Q:QUIT  S OCXSUB=$O(@CREF@(OCXDD,OCXFLD,OCXSUB)) Q:'OCXSUB  I '($G(@RREF@(OCXDD,OCXFLD,OCXSUB))=$G(@LREF@(OCXDD,OCXFLD,OCXSUB))) D  Q
"RTN","ORY2691",67,0)
 ...D WARN("Inconsistent word Data",CREF,OCXDD,OCXFLD,OCXSUB)
"RTN","ORY2691",68,0)
 ...S QUIT=$$LOADWORD^ORY2692(RREF,OCXDD,OCXFLD,OCXSUB)
"RTN","ORY2691",69,0)
 .;
"RTN","ORY2691",70,0)
 .I 'QUIT,(OCXFLD[":") S QUIT=$$MULT($$APPEND(CREF,OCXDD),OCXFLD)
"RTN","ORY2691",71,0)
 Q QUIT
"RTN","ORY2691",72,0)
 ;
"RTN","ORY2691",73,0)
APPEND(ARRAY,OCXSUB) ;
"RTN","ORY2691",74,0)
 S:'(OCXSUB=+OCXSUB) OCXSUB=""""_OCXSUB_""""
"RTN","ORY2691",75,0)
 Q:'(ARRAY["(") ARRAY_"("_OCXSUB_")"
"RTN","ORY2691",76,0)
 Q $E(ARRAY,1,$L(ARRAY)-1)_","_OCXSUB_")"
"RTN","ORY2691",77,0)
 ;
"RTN","ORY2691",78,0)
EXFLD(FILE,OCXFLD) ;
"RTN","ORY2691",79,0)
 N OCXFNAM
"RTN","ORY2691",80,0)
 S OCXFNAM=$$FIELD^OCXSENDD(FILE,OCXFLD,"LABEL")
"RTN","ORY2691",81,0)
 I (OCXFNAM["UNIQUE OBJECT IDENTIFIER") Q 1
"RTN","ORY2691",82,0)
 I (FILE=860.2),(OCXFLD=.02) Q 1
"RTN","ORY2691",83,0)
 I (FILE=860.22),(OCXFLD=4) Q 1
"RTN","ORY2691",84,0)
 I (FILE=860.3),(OCXFLD=3) Q 1
"RTN","ORY2691",85,0)
 I (FILE=860.9),(OCXFLD=1) Q 1
"RTN","ORY2691",86,0)
 I (FILE=860.91) Q 1
"RTN","ORY2691",87,0)
 I (FILE=860.801) Q 1
"RTN","ORY2691",88,0)
 I (FILE=860.81) Q 1
"RTN","ORY2691",89,0)
 I (FILE=861.01) Q 1
"RTN","ORY2691",90,0)
 I (FILE=863.02) Q 1
"RTN","ORY2691",91,0)
 I (FILE=863.54) Q 1
"RTN","ORY2691",92,0)
 I (FILE=863.61) Q 1
"RTN","ORY2691",93,0)
 I (FILE=863.72) Q 1
"RTN","ORY2691",94,0)
 I (FILE=863.81) Q 1
"RTN","ORY2691",95,0)
 I ($E(OCXFNAM,1)="*") Q 1
"RTN","ORY2691",96,0)
 Q 0
"RTN","ORY2691",97,0)
 ;
"RTN","ORY2691",98,0)
WARN(MSG,CREF,OCXDD,OCXFLD,OCXSUB) ;
"RTN","ORY2691",99,0)
 ;
"RTN","ORY2691",100,0)
 Q:$G(OCXAUTO)
"RTN","ORY2691",101,0)
 ;
"RTN","ORY2691",102,0)
 N D0,DASH,OCXDDPTH,OCXDPTR,FILE,FILEID,LREF,OCXPTR,RREF
"RTN","ORY2691",103,0)
 ;
"RTN","ORY2691",104,0)
 S DASH="",$P(DASH,"-",(55-$L(MSG)))="-"
"RTN","ORY2691",105,0)
 W !!,"------------",MSG,DASH
"RTN","ORY2691",106,0)
 D DSPHDR(CREF,OCXDD,OCXFLD)
"RTN","ORY2691",107,0)
 I $D(OCXSUB) D DSPFLD(CREF,OCXDD,OCXFLD,OCXSUB)
"RTN","ORY2691",108,0)
 I '$D(OCXSUB) D DSPREC(CREF,OCXDD,OCXFLD)
"RTN","ORY2691",109,0)
 ;
"RTN","ORY2691",110,0)
 W ! Q
"RTN","ORY2691",111,0)
 ;
"RTN","ORY2691",112,0)
DSPREC(CREF,OCXDD,OCXFLD) ;
"RTN","ORY2691",113,0)
 ;
"RTN","ORY2691",114,0)
 N OCXDPTR,OCXDDPTH,LEVL,OCXCREF,OCXSUB
"RTN","ORY2691",115,0)
 S OCXCREF=$$APPEND($$APPEND(CREF,OCXDD),OCXFLD)
"RTN","ORY2691",116,0)
 S OCXDDPTH=$P($P(OCXCREF,"(",2),")",1),LEVL=$L(OCXDDPTH,",")
"RTN","ORY2691",117,0)
 S OCXSUB="" F  S OCXSUB=$O(@OCXCREF@(OCXSUB)) Q:'$L(OCXSUB)  D
"RTN","ORY2691",118,0)
 .;
"RTN","ORY2691",119,0)
 .I '(OCXSUB[":"),'((OCXSUB=.01)&$O(@OCXCREF@(OCXSUB))) D
"RTN","ORY2691",120,0)
 ..N LINE
"RTN","ORY2691",121,0)
 ..Q:$$EXFLD(+OCXFLD,OCXSUB)
"RTN","ORY2691",122,0)
 ..I OCXFLD W !,?(5+((LEVL)*4)),$$FIELD^OCXSENDD(+OCXFLD,OCXSUB,"LABEL"),": ",$G(@OCXCREF@(OCXSUB,"E"))
"RTN","ORY2691",123,0)
 ..S LINE=0 F  S LINE=$O(@OCXCREF@(OCXSUB,LINE)) Q:'LINE  D
"RTN","ORY2691",124,0)
 ...W !,?(5+(LEVL*4)),$J(LINE,3),">",@OCXCREF@(OCXSUB,LINE)
"RTN","ORY2691",125,0)
 .;
"RTN","ORY2691",126,0)
 .I (OCXSUB[":") D
"RTN","ORY2691",127,0)
 ..N D0,OCXDD,FILENAME
"RTN","ORY2691",128,0)
 ..S D0=+$P(OCXSUB,":",2),OCXDD=+OCXSUB
"RTN","ORY2691",129,0)
 ..S FILENAME=$$FILENAME^OCXSENDD(OCXDD)
"RTN","ORY2691",130,0)
 ..I $L(FILENAME) W !,?(5+($L(LEVL)*4)),FILENAME
"RTN","ORY2691",131,0)
 ..E  W !!,?(5+(LEVL*4)),FILENAME
"RTN","ORY2691",132,0)
 ..W " ",D0,": ",$G(@OCXCREF@(OCXSUB,.01,"E"))
"RTN","ORY2691",133,0)
 ..D DSPREC($$APPEND(CREF,OCXDD),OCXFLD,OCXSUB)
"RTN","ORY2691",134,0)
 ;
"RTN","ORY2691",135,0)
 Q
"RTN","ORY2691",136,0)
 ;
"RTN","ORY2691",137,0)
DSPHDR(CREF,OCXDD,OCXFLD) ;
"RTN","ORY2691",138,0)
 ;
"RTN","ORY2691",139,0)
 N D0,FILE,FILEID,OCXPTR,OCXDDPTH
"RTN","ORY2691",140,0)
 S OCXDDPTH=$P($P($$APPEND($$APPEND(CREF,OCXDD),OCXFLD),"(",2),")",1)
"RTN","ORY2691",141,0)
 S FILE="" F OCXPTR=1:1:$L(OCXDDPTH,",") D
"RTN","ORY2691",142,0)
 .N OCXDD,D0,FILEID
"RTN","ORY2691",143,0)
 .S FILEID=$P(OCXDDPTH,",",OCXPTR)
"RTN","ORY2691",144,0)
 .I (FILEID[":") D
"RTN","ORY2691",145,0)
 ..S D0=+$P(FILEID,":",2),OCXDD=+$E(FILEID,2,$L(FILEID))
"RTN","ORY2691",146,0)
 ..W !,?(5+(OCXPTR*4)),$$FILENAME^OCXSENDD(OCXDD)
"RTN","ORY2691",147,0)
 ..S:$L(FILE) FILE=FILE_"," S FILE=FILE_FILEID
"RTN","ORY2691",148,0)
 ..I $D(@("L("_FILE_",.01,""E"")")) W ": ",@("L("_FILE_",.01,""E"")") W:D0 " [",D0,"]"
"RTN","ORY2691",149,0)
 ..E  I $D(@("R("_FILE_",.01,""E"")")) W ": ",@("R("_FILE_",.01,""E"")") W:D0 " [",D0,"]"
"RTN","ORY2691",150,0)
 ;
"RTN","ORY2691",151,0)
 Q
"RTN","ORY2691",152,0)
 ;
"RTN","ORY2691",153,0)
DSPFLD(CREF,OCXDD,OCXFLD,OCXSUB) ;
"RTN","ORY2691",154,0)
 ;
"RTN","ORY2691",155,0)
 N OCXDPTR,LREF,RREF,OCXDDPTH
"RTN","ORY2691",156,0)
 ;
"RTN","ORY2691",157,0)
 S OCXDDPTH=$P($P($$APPEND(CREF,OCXDD),"(",2),")",1)
"RTN","ORY2691",158,0)
 S LREF="L("_OCXDDPTH_")",RREF="R("_OCXDDPTH_")"
"RTN","ORY2691",159,0)
 W !,?(5+(($L(OCXDDPTH,",")+1)*4)),$$FIELD^OCXSENDD(OCXDD,OCXFLD,"LABEL")," field [",OCXFLD,"]"
"RTN","ORY2691",160,0)
 I OCXSUB W " Line #",OCXSUB
"RTN","ORY2691",161,0)
 ;
"RTN","ORY2691",162,0)
 W:($D(@RREF@(OCXFLD,OCXSUB))) !,?(5+(($L(OCXDDPTH,",")+2)*4)),"(R) CPRS30.FO.DOMAIN.EXT: ",@RREF@(OCXFLD,OCXSUB)
"RTN","ORY2691",163,0)
 W:($D(@LREF@(OCXFLD,OCXSUB))) !,?(5+(($L(OCXDDPTH,",")+2)*4)),"(L) ",$$NETNAME^OCXSEND,": ",@LREF@(OCXFLD,OCXSUB)
"RTN","ORY2691",164,0)
 ;
"RTN","ORY2691",165,0)
 Q
"RTN","ORY2691",166,0)
 ;
"RTN","ORY2691",167,0)
 W !,?10 Q 0 Q $$PAUSE
"RTN","ORY2691",168,0)
 ;
"RTN","ORY2691",169,0)
PAUSE() W "  Press Enter " R X:DTIME W ! Q (X[U)
"RTN","ORY2691",170,0)
 ;
"RTN","ORY2691",171,0)
NOW() N X,Y,%DT S X="N",%DT="T" D ^%DT S Y=$$DATE^OCXSENDD(Y) S:(Y["@") Y=$P(Y,"@",1)_" at "_$P(Y,"@",2) Q Y
"RTN","ORY2691",172,0)
 ;
"RTN","ORY2692")
0^17^B26767922
"RTN","ORY2692",1,0)
ORY2692 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY2692",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY2692",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY2692",4,0)
 ;
"RTN","ORY2692",5,0)
S ;
"RTN","ORY2692",6,0)
 ;  Record Utilities
"RTN","ORY2692",7,0)
 Q
"RTN","ORY2692",8,0)
 ;
"RTN","ORY2692",9,0)
ADDREC(OCXCREF) ;
"RTN","ORY2692",10,0)
 ;
"RTN","ORY2692",11,0)
 N QUIT,OCXDD,OCXDA,OCXGREF,OCXNAME
"RTN","ORY2692",12,0)
 S OCXDD=$O(@OCXCREF@("")) Q:'OCXDD 0
"RTN","ORY2692",13,0)
 S OCXNAME=$G(@OCXCREF@(OCXDD,.01,"E"))
"RTN","ORY2692",14,0)
 ;
"RTN","ORY2692",15,0)
 W "   record missing..."
"RTN","ORY2692",16,0)
 I (OCXFLAG["D") Q 0
"RTN","ORY2692",17,0)
 ;
"RTN","ORY2692",18,0)
 S OCXDA=0 D CREATE(OCXCREF,OCXDD,.OCXDA,0)
"RTN","ORY2692",19,0)
 S:$L(OCXNAME) ^TMP("OCXRULE",$J,"A",+OCXDD,OCXNAME)=""
"RTN","ORY2692",20,0)
 ;
"RTN","ORY2692",21,0)
 Q 0
"RTN","ORY2692",22,0)
 ;
"RTN","ORY2692",23,0)
CREATE(OCXCREF,OCXDD,OCXDA,OCXLVL) ;
"RTN","ORY2692",24,0)
 ;
"RTN","ORY2692",25,0)
 N OCXFLD,OCXGREF,OCXKEY
"RTN","ORY2692",26,0)
 ;
"RTN","ORY2692",27,0)
 I $L(OCXDA),'(OCXDA=+OCXDA) W !!,"Unresolved subscript." Q
"RTN","ORY2692",28,0)
 ;
"RTN","ORY2692",29,0)
 S OCXKEY=@OCXCREF@(OCXDD,.01,"E")
"RTN","ORY2692",30,0)
 S OCXGREF=$$GETREF(+OCXDD,.OCXDA,OCXLVL) Q:'$L(OCXGREF)
"RTN","ORY2692",31,0)
 I 'OCXDA D
"RTN","ORY2692",32,0)
 .S OCXDA=$O(^TMP("OCXRULE",$J,"B",+OCXDD,OCXKEY,0)) Q:OCXDA
"RTN","ORY2692",33,0)
 .S OCXDA=$O(@(OCXGREF_""" "")"),-1)+1
"RTN","ORY2692",34,0)
 .F OCXDA=OCXDA:1 Q:'$D(@(OCXGREF_OCXDA_",0)"))
"RTN","ORY2692",35,0)
 .I $D(@(OCXGREF_OCXDA_",0)")) S OCXDA=0
"RTN","ORY2692",36,0)
 ;
"RTN","ORY2692",37,0)
 I 'OCXDA W !!,"Error adding record..." Q
"RTN","ORY2692",38,0)
 ;
"RTN","ORY2692",39,0)
 I '$D(@(OCXGREF_"0)")) S @(OCXGREF_"0)")=U_$$FILEHDR^OCXSENDD(+OCXDD)_U_U
"RTN","ORY2692",40,0)
 ;
"RTN","ORY2692",41,0)
 S OCXFLD=0 F  S OCXFLD=$O(@OCXCREF@(OCXDD,OCXFLD)) Q:'OCXFLD  Q:(OCXFLD[":")  I '$$EXFLD^ORY2691(+OCXDD,OCXFLD) D
"RTN","ORY2692",42,0)
 .I $L($G(@OCXCREF@(OCXDD,OCXFLD,"E"))) D DIE(OCXDD,OCXGREF,OCXFLD,@OCXCREF@(OCXDD,OCXFLD,"E"),.OCXDA,OCXLVL)
"RTN","ORY2692",43,0)
 .I $O(@OCXCREF@(OCXDD,OCXFLD,0)) D WORD(OCXDD,OCXGREF,OCXFLD,.OCXDA,OCXCREF)
"RTN","ORY2692",44,0)
 ;
"RTN","ORY2692",45,0)
 D PUSH(.OCXDA)
"RTN","ORY2692",46,0)
 S OCXFLD="" F  S OCXFLD=$O(@OCXCREF@(OCXDD,OCXFLD)) Q:'$L(OCXFLD)  I (OCXFLD[":") D
"RTN","ORY2692",47,0)
 .S OCXDA=$P(OCXFLD,":",2) W ! D CREATE($$APPEND(OCXCREF,OCXDD),OCXFLD,.OCXDA,OCXLVL+1)
"RTN","ORY2692",48,0)
 D POP(.OCXDA)
"RTN","ORY2692",49,0)
 Q
"RTN","ORY2692",50,0)
 ;
"RTN","ORY2692",51,0)
LOADWORD(RREF,OCXDD,OCXFLD,OCXSUB) ;
"RTN","ORY2692",52,0)
 ;
"RTN","ORY2692",53,0)
 N QUIT,DDPATH,INDEX,OCXDA,OCXGREF
"RTN","ORY2692",54,0)
 S DDPATH=$P($P($$APPEND(RREF,OCXDD),"(",2),")",1)
"RTN","ORY2692",55,0)
 F INDEX=1:1:$L(DDPATH,",") S OCXDA($L(DDPATH,",")-INDEX)=+$P($P(DDPATH,",",INDEX),":",2)
"RTN","ORY2692",56,0)
 S OCXDA=$G(OCXDA(0)) K OCXDA(0)
"RTN","ORY2692",57,0)
 Q:(OCXFLAG["D") 0
"RTN","ORY2692",58,0)
 I (OCXFLAG["A") S QUIT=$$READ("Y"," Do you want to reload the local '"_$$FIELD^OCXSENDD(+OCXDD,+OCXFLD,"LABEL")_"' field ?","YES") Q:'QUIT (QUIT[U)
"RTN","ORY2692",59,0)
 S OCXGREF=$$GETREF(+OCXDD,.OCXDA,$L(DDPATH,",")-1) Q:'$L(OCXGREF)
"RTN","ORY2692",60,0)
 D WORD(OCXDD,OCXGREF,OCXFLD,.OCXDA,RREF)
"RTN","ORY2692",61,0)
 Q 0
"RTN","ORY2692",62,0)
 ;
"RTN","ORY2692",63,0)
GETREF(OCXDD,OCXDA,OCXLVL) ;
"RTN","ORY2692",64,0)
 ;
"RTN","ORY2692",65,0)
 Q:'OCXDD ""
"RTN","ORY2692",66,0)
 ;
"RTN","ORY2692",67,0)
 N OCXIENS,OCXERR,OCXX
"RTN","ORY2692",68,0)
 S OCXIENS=$$IENS^DILF(.OCXDA),OCXERR=""
"RTN","ORY2692",69,0)
 S OCXX=$$ROOT^DILFD(OCXDD,OCXIENS,0,OCXERR)
"RTN","ORY2692",70,0)
 Q OCXX
"RTN","ORY2692",71,0)
 ;
"RTN","ORY2692",72,0)
WORD(DD,GREF,FLD,DA,RREF) ;
"RTN","ORY2692",73,0)
 ;
"RTN","ORY2692",74,0)
 N SUB,GLROOT,LINE
"RTN","ORY2692",75,0)
 S SUB=$P($$FIELD^OCXSENDD(+DD,FLD,"GLOBAL SUBSCRIPT LOCATION"),";",1) S:'(SUB=+SUB) SUB=""""_SUB_""""
"RTN","ORY2692",76,0)
 S GLROOT=GREF_DA_","_SUB_")" K @GLROOT
"RTN","ORY2692",77,0)
 S LINE=0 F  S LINE=$O(@RREF@(DD,FLD,LINE)) Q:'LINE  D
"RTN","ORY2692",78,0)
 .S @GLROOT@($O(@GLROOT@(""),-1)+1,0)=@RREF@(DD,FLD,LINE)
"RTN","ORY2692",79,0)
 S LINE=$O(@GLROOT@(""),-1),@GLROOT@(0)=U_U_LINE_U_LINE_U_$$DATE("T")_U
"RTN","ORY2692",80,0)
 ;
"RTN","ORY2692",81,0)
 Q
"RTN","ORY2692",82,0)
 ;
"RTN","ORY2692",83,0)
DATE(X) N %DT,Y S %DT="" D ^%DT Q +Y
"RTN","ORY2692",84,0)
 ;
"RTN","ORY2692",85,0)
DIE(OCXDD,OCXDIC,OCXFLD,OCXVAL,OCXDA,OCXLVL) ;
"RTN","ORY2692",86,0)
 ;
"RTN","ORY2692",87,0)
 N DIC,DIE,X,Y,DR,DA,OCXDVAL,OCXPTR,OCXGREF,D0,OCXSCR
"RTN","ORY2692",88,0)
 S (D0,DA)=OCXDA,(DIC,DIE)=OCXDIC,DR=""
"RTN","ORY2692",89,0)
 S:OCXLVL D0=OCXDA(1),DR="S DA(1)="_(+D0)_",D0="_(+D0)_";"
"RTN","ORY2692",90,0)
 S:OCXVAL="?" OCXVAL="? " S DR=DR_OCXFLD_"///^S X=OCXVAL"
"RTN","ORY2692",91,0)
 I '(OCXVAL="@") W !,?(OCXLVL*5),$$FIELD^OCXSENDD(+OCXDD,OCXFLD,"LABEL"),": ",OCXVAL
"RTN","ORY2692",92,0)
 ;
"RTN","ORY2692",93,0)
 I '(OCXVAL="@") D
"RTN","ORY2692",94,0)
 .N OCXIEN,SHORT
"RTN","ORY2692",95,0)
 .S OCXPTR=+$P($$FIELD^OCXSENDD(+OCXDD,OCXFLD,"SPECIFIER"),"P",2)
"RTN","ORY2692",96,0)
 .Q:'OCXPTR
"RTN","ORY2692",97,0)
 .S OCXGREF="^"_$$FIELD^OCXSENDD(+OCXDD,OCXFLD,"POINTER")
"RTN","ORY2692",98,0)
 .I '($E(OCXGREF,1,4)="^OCX"),'(OCXGREF="^ORD(100.9,"),'(OCXGREF="^ORD(100.8,") Q
"RTN","ORY2692",99,0)
 .Q:$$DIC(OCXGREF,OCXVAL,0)
"RTN","ORY2692",100,0)
 .S OCXIEN=$$DIC(OCXGREF,OCXVAL,1)
"RTN","ORY2692",101,0)
 .S ^TMP("OCXRULE",$J,"B",OCXPTR,OCXVAL,OCXIEN)=""
"RTN","ORY2692",102,0)
 ;
"RTN","ORY2692",103,0)
 S OCXSCR=1
"RTN","ORY2692",104,0)
 D ^DIE
"RTN","ORY2692",105,0)
 ;
"RTN","ORY2692",106,0)
 ; I $D(Y) -> DIE FILER ERROR
"RTN","ORY2692",107,0)
 I $D(Y) W "   ^DIE filer data error..." S OCXDIER=$G(OCXDIER)+1
"RTN","ORY2692",108,0)
 I '$D(Y) W "    ...Correct data Filed"
"RTN","ORY2692",109,0)
 ;
"RTN","ORY2692",110,0)
 Q
"RTN","ORY2692",111,0)
 ;
"RTN","ORY2692",112,0)
DIC(DIC,X,OCXADD) N OCXSCR S DIC(0)="",OCXSCR=1 S:OCXADD DIC(0)="L" D ^DIC Q:(+Y>0) +Y Q 0
"RTN","ORY2692",113,0)
 ;
"RTN","ORY2692",114,0)
PUSH(OCXDA) ;
"RTN","ORY2692",115,0)
 N OCXSUB S OCXSUB="" F  S OCXSUB=$O(OCXDA(OCXSUB),-1) Q:'OCXSUB  S OCXDA(OCXSUB+1)=OCXDA(OCXSUB)
"RTN","ORY2692",116,0)
 S OCXDA(1)=OCXDA,OCXDA=0
"RTN","ORY2692",117,0)
 Q
"RTN","ORY2692",118,0)
 ;
"RTN","ORY2692",119,0)
POP(OCXDA) ;
"RTN","ORY2692",120,0)
 N OCXSUB S OCXSUB="" F  S OCXSUB=$O(OCXDA(OCXSUB)) Q:'OCXSUB  S OCXDA(OCXSUB)=$G(OCXDA(OCXSUB+1))
"RTN","ORY2692",121,0)
 S OCXDA=OCXDA(1) K OCXDA($O(OCXDA(""),-1))
"RTN","ORY2692",122,0)
 Q
"RTN","ORY2692",123,0)
 ;
"RTN","ORY2692",124,0)
APPEND(ARRAY,OCXSUB) ;
"RTN","ORY2692",125,0)
 S:'(OCXSUB=+OCXSUB) OCXSUB=""""_OCXSUB_""""
"RTN","ORY2692",126,0)
 Q:'(ARRAY["(") ARRAY_"("_OCXSUB_")"
"RTN","ORY2692",127,0)
 Q $E(ARRAY,1,$L(ARRAY)-1)_","_OCXSUB_")"
"RTN","ORY2692",128,0)
 ;
"RTN","ORY2692",129,0)
READ(OCXZ0,OCXZA,OCXZB,OCXZL) ;
"RTN","ORY2692",130,0)
 N OCXLINE,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","ORY2692",131,0)
 Q:'$L($G(OCXZ0)) U
"RTN","ORY2692",132,0)
 S DIR(0)=OCXZ0
"RTN","ORY2692",133,0)
 S:$L($G(OCXZA)) DIR("A")=OCXZA
"RTN","ORY2692",134,0)
 S:$L($G(OCXZB)) DIR("B")=OCXZB
"RTN","ORY2692",135,0)
 F OCXLINE=1:1:($G(OCXZL)-1) W !
"RTN","ORY2692",136,0)
 D ^DIR
"RTN","ORY2692",137,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q U
"RTN","ORY2692",138,0)
 Q Y
"RTN","ORY2692",139,0)
 ;
"RTN","ORY2692",140,0)
PAUSE() W "  Press Enter " R X:DTIME W ! Q (X[U)
"RTN","ORY2692",141,0)
 ;
"RTN","ORY2693")
0^18^B13000330
"RTN","ORY2693",1,0)
ORY2693 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY2693",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY2693",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY2693",4,0)
 ;
"RTN","ORY2693",5,0)
S ;
"RTN","ORY2693",6,0)
 ;  Multiple Utilities
"RTN","ORY2693",7,0)
 Q
"RTN","ORY2693",8,0)
 ;
"RTN","ORY2693",9,0)
ADDMULT(OCXCREF,OCXDD,OCXFLD) ;
"RTN","ORY2693",10,0)
 ;
"RTN","ORY2693",11,0)
 ;
"RTN","ORY2693",12,0)
 N QUIT,OCXDA,OCXGREF,OCXNAME,DDPATH,INDEX
"RTN","ORY2693",13,0)
 ;
"RTN","ORY2693",14,0)
 S DDPATH=$P($P($$APPEND($$APPEND(OCXCREF,OCXDD),OCXFLD),"(",2),")",1)
"RTN","ORY2693",15,0)
 F INDEX=1:1:$L(DDPATH,",") S OCXDA($L(DDPATH,",")-INDEX)=+$P($P(DDPATH,",",INDEX),":",2)
"RTN","ORY2693",16,0)
 S OCXDA=$G(OCXDA(0)) K OCXDA(0)
"RTN","ORY2693",17,0)
 ;
"RTN","ORY2693",18,0)
 Q:(OCXFLAG["D") 0
"RTN","ORY2693",19,0)
 I (OCXFLAG["A") S QUIT=$$READ("Y"," Do you want to add a local '"_$$FILENAME^OCXSENDD(+OCXFLD)_"' multiple ?","YES") Q:'QUIT (QUIT[U)
"RTN","ORY2693",20,0)
 ;
"RTN","ORY2693",21,0)
 S OCXGREF=$$GETREF^ORY2692(+OCXFLD,.OCXDA,1)
"RTN","ORY2693",22,0)
 D CREATE($$APPEND(OCXCREF,OCXDD),OCXFLD,.OCXDA,1)
"RTN","ORY2693",23,0)
 ;
"RTN","ORY2693",24,0)
 Q 0
"RTN","ORY2693",25,0)
 ;
"RTN","ORY2693",26,0)
DELMULT(OCXCREF,OCXDD) ;
"RTN","ORY2693",27,0)
 ;
"RTN","ORY2693",28,0)
 N QUIT,OCXGREF,DA,INDEX,DDPATH
"RTN","ORY2693",29,0)
 ;
"RTN","ORY2693",30,0)
 Q:(OCXFLAG["D") 0
"RTN","ORY2693",31,0)
 I (OCXFLAG["A") S QUIT=$$READ("Y"," Do you want to delete the local '"_$$FILENAME^OCXSENDD(+OCXDD)_"' multiple ?","YES") Q:'QUIT (QUIT[U)
"RTN","ORY2693",32,0)
 ;
"RTN","ORY2693",33,0)
 S DDPATH=$P($P($$APPEND(OCXCREF,OCXDD),"(",2),")",1)
"RTN","ORY2693",34,0)
 F INDEX=1:1:$L(DDPATH,",") S DA($L(DDPATH,",")-INDEX)=+$P($P(DDPATH,",",INDEX),":",2)
"RTN","ORY2693",35,0)
 S DA=$G(DA(0)) K DA(0)
"RTN","ORY2693",36,0)
 S OCXGREF=$$GETREF^ORY2692(+OCXDD,.DA,1)
"RTN","ORY2693",37,0)
 ;
"RTN","ORY2693",38,0)
 D DIE^ORY2692(+OCXDD,OCXGREF,.01,"@",.DA,$L(DDPATH,",")-1)
"RTN","ORY2693",39,0)
 K @OCXCREF@(OCXDD) W !!,"  deleted..."
"RTN","ORY2693",40,0)
 ;
"RTN","ORY2693",41,0)
 Q 0
"RTN","ORY2693",42,0)
 ;
"RTN","ORY2693",43,0)
CREATE(OCXCREF,OCXDD,OCXDA,OCXLVL) ;
"RTN","ORY2693",44,0)
 ;
"RTN","ORY2693",45,0)
 N OCXFLD,OCXGREF
"RTN","ORY2693",46,0)
 ;
"RTN","ORY2693",47,0)
 S OCXGREF=$$GETREF^ORY2692(+OCXDD,.OCXDA,OCXLVL) Q:'$L(OCXGREF)  S:'OCXDA OCXDA=$O(@(OCXGREF_"""@"")"),-1)+1
"RTN","ORY2693",48,0)
 ;
"RTN","ORY2693",49,0)
 I '$D(@(OCXGREF_"0)")) S @(OCXGREF_"0)")=U_$$FILEHDR^OCXSENDD(+OCXDD)_U_U
"RTN","ORY2693",50,0)
 ;
"RTN","ORY2693",51,0)
 S OCXFLD=0 F  S OCXFLD=$O(@OCXCREF@(OCXDD,OCXFLD)) Q:'OCXFLD  Q:(OCXFLD[":")  I '$$EXFLD^ORY2691(+OCXDD,OCXFLD) D
"RTN","ORY2693",52,0)
 .I $L($G(@OCXCREF@(OCXDD,OCXFLD,"E"))) D DIE^ORY2692(OCXDD,OCXGREF,OCXFLD,@OCXCREF@(OCXDD,OCXFLD,"E"),.OCXDA,OCXLVL)
"RTN","ORY2693",53,0)
 ;
"RTN","ORY2693",54,0)
 D PUSH(.OCXDA)
"RTN","ORY2693",55,0)
 S OCXFLD="" F  S OCXFLD=$O(@OCXCREF@(OCXDD,OCXFLD)) Q:'$L(OCXFLD)  I (OCXFLD[":") D
"RTN","ORY2693",56,0)
 .S OCXDA=$P(OCXFLD,":",2) W ! D CREATE($$APPEND(OCXCREF,OCXDD),OCXFLD,.OCXDA,OCXLVL+1)
"RTN","ORY2693",57,0)
 D POP(.OCXDA)
"RTN","ORY2693",58,0)
 Q
"RTN","ORY2693",59,0)
 ;
"RTN","ORY2693",60,0)
PUSH(OCXDA) ;
"RTN","ORY2693",61,0)
 N OCXSUB S OCXSUB="" F  S OCXSUB=$O(OCXDA(OCXSUB),-1) Q:'OCXSUB  S OCXDA(OCXSUB+1)=OCXDA(OCXSUB)
"RTN","ORY2693",62,0)
 S OCXDA(1)=OCXDA,OCXDA=0
"RTN","ORY2693",63,0)
 Q
"RTN","ORY2693",64,0)
 ;
"RTN","ORY2693",65,0)
POP(OCXDA) ;
"RTN","ORY2693",66,0)
 N OCXSUB S OCXSUB="" F  S OCXSUB=$O(OCXDA(OCXSUB)) Q:'OCXSUB  S OCXDA(OCXSUB)=$G(OCXDA(OCXSUB+1))
"RTN","ORY2693",67,0)
 S OCXDA=OCXDA(1) K OCXDA($O(OCXDA(""),-1))
"RTN","ORY2693",68,0)
 Q
"RTN","ORY2693",69,0)
 ;
"RTN","ORY2693",70,0)
APPEND(ARRAY,OCXSUB) ;
"RTN","ORY2693",71,0)
 S:'(OCXSUB=+OCXSUB) OCXSUB=""""_OCXSUB_""""
"RTN","ORY2693",72,0)
 Q:'(ARRAY["(") ARRAY_"("_OCXSUB_")"
"RTN","ORY2693",73,0)
 Q $E(ARRAY,1,$L(ARRAY)-1)_","_OCXSUB_")"
"RTN","ORY2693",74,0)
 ;
"RTN","ORY2693",75,0)
READ(OCXZ0,OCXZA,OCXZB,OCXZL) ;
"RTN","ORY2693",76,0)
 N OCXLINE,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","ORY2693",77,0)
 Q:'$L($G(OCXZ0)) U
"RTN","ORY2693",78,0)
 S DIR(0)=OCXZ0
"RTN","ORY2693",79,0)
 S:$L($G(OCXZA)) DIR("A")=OCXZA
"RTN","ORY2693",80,0)
 S:$L($G(OCXZB)) DIR("B")=OCXZB
"RTN","ORY2693",81,0)
 F OCXLINE=1:1:($G(OCXZL)-1) W !
"RTN","ORY2693",82,0)
 D ^DIR
"RTN","ORY2693",83,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q U
"RTN","ORY2693",84,0)
 Q Y
"RTN","ORY2693",85,0)
 ;
"RTN","ORY2693",86,0)
PAUSE() W "  Press Enter " R X:DTIME W ! Q (X[U)
"RTN","ORY2693",87,0)
 ;
"RTN","ORY2694")
0^19^B13530470
"RTN","ORY2694",1,0)
ORY2694 ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY2694",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY2694",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY2694",4,0)
 ;
"RTN","ORY2694",5,0)
S ;
"RTN","ORY2694",6,0)
 ;  Field Utilities
"RTN","ORY2694",7,0)
 Q
"RTN","ORY2694",8,0)
 ;
"RTN","ORY2694",9,0)
EDITFLD(OCXCREF,OCXDD,OCXFLD,OCXSUB) ;
"RTN","ORY2694",10,0)
 ;
"RTN","ORY2694",11,0)
 N DDPATH,OCXDA,OCXPC,OCXLVL,QUIT
"RTN","ORY2694",12,0)
 ;
"RTN","ORY2694",13,0)
 S QUIT=0,DDPATH=$P($P($$APPEND(OCXCREF,OCXDD),"(",2),")",1)
"RTN","ORY2694",14,0)
 S OCXLVL=$L(DDPATH,",")
"RTN","ORY2694",15,0)
 F OCXPC=1:1:OCXLVL S OCXDA(OCXLVL-OCXPC)=+$P($P(DDPATH,",",OCXPC),":",2)
"RTN","ORY2694",16,0)
 S OCXDA=OCXDA(0) K OCXDA(0)
"RTN","ORY2694",17,0)
 I $L($G(@OCXCREF@(OCXDD,OCXFLD,"E"))) D
"RTN","ORY2694",18,0)
 .N RESP
"RTN","ORY2694",19,0)
 .Q:(OCXFLAG["D")
"RTN","ORY2694",20,0)
 .I (OCXFLAG["A") S RESP=$$READ("Y"," Do you want to change the local '"_$$FILENAME^OCXSENDD(+OCXDD)_"' field ?","YES") I 'RESP S QUIT=(RESP[U) Q
"RTN","ORY2694",21,0)
 .S OCXGREF=$$GETREF^ORY2692(+OCXDD,.OCXDA,OCXLVL-1) Q:'$L(OCXGREF)
"RTN","ORY2694",22,0)
 .D DIE^ORY2692(OCXDD,OCXGREF,OCXFLD,@OCXCREF@(OCXDD,OCXFLD,"E"),.OCXDA,OCXLVL-1)
"RTN","ORY2694",23,0)
 ;
"RTN","ORY2694",24,0)
 Q QUIT
"RTN","ORY2694",25,0)
 ;
"RTN","ORY2694",26,0)
DELFLD(OCXCREF,OCXDD,OCXFLD,OCXSUB) ;
"RTN","ORY2694",27,0)
 ;
"RTN","ORY2694",28,0)
 N DDPATH,OCXDA,OCXPC,OCXLVL,QUIT,RESP
"RTN","ORY2694",29,0)
 ;
"RTN","ORY2694",30,0)
 S QUIT=0,DDPATH=$P($P($$APPEND(OCXCREF,OCXDD),"(",2),")",1)
"RTN","ORY2694",31,0)
 S OCXLVL=$L(DDPATH,",")
"RTN","ORY2694",32,0)
 F OCXPC=1:1:OCXLVL S OCXDA(OCXLVL-OCXPC)=+$P($P(DDPATH,",",OCXPC),":",2)
"RTN","ORY2694",33,0)
 S OCXDA=OCXDA(0) K OCXDA(0)
"RTN","ORY2694",34,0)
 Q:(OCXFLAG["D") 0
"RTN","ORY2694",35,0)
 I (OCXFLAG["A") S RESP=$$READ("Y"," Do you want to Delete the local '"_$$FILENAME^OCXSENDD(+OCXDD)_"' value ?","YES") I 'RESP S QUIT=(RESP[U) Q QUIT
"RTN","ORY2694",36,0)
 S OCXGREF=$$GETREF^ORY2692(+OCXDD,.OCXDA,OCXLVL-1) Q:'$L(OCXGREF)
"RTN","ORY2694",37,0)
 D DIE^ORY2692(OCXDD,OCXGREF,OCXFLD,"@",.OCXDA,OCXLVL-1)
"RTN","ORY2694",38,0)
 ;
"RTN","ORY2694",39,0)
 Q QUIT
"RTN","ORY2694",40,0)
 ;
"RTN","ORY2694",41,0)
CREATE(OCXCREF,OCXDD,OCXDA,OCXLVL) ;
"RTN","ORY2694",42,0)
 ;
"RTN","ORY2694",43,0)
 N OCXFLD,OCXGREF
"RTN","ORY2694",44,0)
 ;
"RTN","ORY2694",45,0)
 S OCXGREF=$$GETREF^ORY2692(+OCXDD,.OCXDA,OCXLVL) Q:'$L(OCXGREF)  S:'OCXDA OCXDA=$O(@(OCXGREF_"""@"")"),-1)+1
"RTN","ORY2694",46,0)
 ;
"RTN","ORY2694",47,0)
 I '$D(@(OCXGREF_"0)")) S @(OCXGREF_"0)")=U_$$FILEHDR^OCXSENDD(+OCXDD)_U_U
"RTN","ORY2694",48,0)
 ;
"RTN","ORY2694",49,0)
 S OCXFLD=0 F  S OCXFLD=$O(@OCXCREF@(OCXDD,OCXFLD)) Q:'OCXFLD  Q:(OCXFLD[":")  I '$$EXFLD^ORY2691(+OCXDD,OCXFLD) D
"RTN","ORY2694",50,0)
 .I $L($G(@OCXCREF@(OCXDD,OCXFLD,"E"))) D DIE^ORY2692(OCXDD,OCXGREF,OCXFLD,@OCXCREF@(OCXDD,OCXFLD,"E"),.OCXDA,OCXLVL)
"RTN","ORY2694",51,0)
 ;
"RTN","ORY2694",52,0)
 D PUSH(.OCXDA)
"RTN","ORY2694",53,0)
 S OCXFLD="" F  S OCXFLD=$O(@OCXCREF@(OCXDD,OCXFLD)) Q:'$L(OCXFLD)  I (OCXFLD[":") D
"RTN","ORY2694",54,0)
 .S OCXDA=$P(OCXFLD,":",2) W ! D CREATE($$APPEND(OCXCREF,OCXDD),OCXFLD,.OCXDA,OCXLVL+1)
"RTN","ORY2694",55,0)
 D POP(.OCXDA)
"RTN","ORY2694",56,0)
 Q
"RTN","ORY2694",57,0)
 ;
"RTN","ORY2694",58,0)
PUSH(OCXDA) ;
"RTN","ORY2694",59,0)
 N OCXSUB S OCXSUB="" F  S OCXSUB=$O(OCXDA(OCXSUB),-1) Q:'OCXSUB  S OCXDA(OCXSUB+1)=OCXDA(OCXSUB)
"RTN","ORY2694",60,0)
 S OCXDA(1)=OCXDA,OCXDA=0
"RTN","ORY2694",61,0)
 Q
"RTN","ORY2694",62,0)
 ;
"RTN","ORY2694",63,0)
POP(OCXDA) ;
"RTN","ORY2694",64,0)
 N OCXSUB S OCXSUB="" F  S OCXSUB=$O(OCXDA(OCXSUB)) Q:'OCXSUB  S OCXDA(OCXSUB)=$G(OCXDA(OCXSUB+1))
"RTN","ORY2694",65,0)
 S OCXDA=OCXDA(1) K OCXDA($O(OCXDA(""),-1))
"RTN","ORY2694",66,0)
 Q
"RTN","ORY2694",67,0)
 ;
"RTN","ORY2694",68,0)
APPEND(ARRAY,OCXSUB) ;
"RTN","ORY2694",69,0)
 S:'(OCXSUB=+OCXSUB) OCXSUB=""""_OCXSUB_""""
"RTN","ORY2694",70,0)
 Q:'(ARRAY["(") ARRAY_"("_OCXSUB_")"
"RTN","ORY2694",71,0)
 Q $E(ARRAY,1,$L(ARRAY)-1)_","_OCXSUB_")"
"RTN","ORY2694",72,0)
 ;
"RTN","ORY2694",73,0)
READ(OCXZ0,OCXZA,OCXZB,OCXZL) ;
"RTN","ORY2694",74,0)
 N OCXLINE,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","ORY2694",75,0)
 Q:'$L($G(OCXZ0)) U
"RTN","ORY2694",76,0)
 S DIR(0)=OCXZ0
"RTN","ORY2694",77,0)
 S:$L($G(OCXZA)) DIR("A")=OCXZA
"RTN","ORY2694",78,0)
 S:$L($G(OCXZB)) DIR("B")=OCXZB
"RTN","ORY2694",79,0)
 F OCXLINE=1:1:($G(OCXZL)-1) W !
"RTN","ORY2694",80,0)
 D ^DIR
"RTN","ORY2694",81,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q U
"RTN","ORY2694",82,0)
 Q Y
"RTN","ORY2694",83,0)
 ;
"RTN","ORY2694",84,0)
PAUSE() W "  Press Enter " R X:DTIME W ! Q (X[U)
"RTN","ORY2694",85,0)
 ;
"RTN","ORY269ES")
0^15^B12638325
"RTN","ORY269ES",1,0)
ORY269ES ;SLC/RJS,CLA - OCX PACKAGE RULE TRANSPORT ROUTINE (Delete after Install of OR*3*269) ;JUL 26,2013 at 06:56
"RTN","ORY269ES",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**269**;Dec 17,1997;Build 85
"RTN","ORY269ES",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY269ES",4,0)
 ;
"RTN","ORY269ES",5,0)
S ;
"RTN","ORY269ES",6,0)
 ;
"RTN","ORY269ES",7,0)
 N OCXDIER,QUIT,LINE,TEXT,REMOTE,LOCAL,D0,OPCODE,REF,OCXFLAG S QUIT=0
"RTN","ORY269ES",8,0)
 N OCXAUTO,OCZSCR
"RTN","ORY269ES",9,0)
 ;
"RTN","ORY269ES",10,0)
 D DOT
"RTN","ORY269ES",11,0)
 I $L($T(VERSION^OCXOCMP)),($$VERSION^OCXOCMP="ORDER CHECK EXPERT version 1.01 released OCT 29,1998"),1
"RTN","ORY269ES",12,0)
 E  D  Q
"RTN","ORY269ES",13,0)
 .W !
"RTN","ORY269ES",14,0)
 .W !,"Rule Transport aborted, version mismatch."
"RTN","ORY269ES",15,0)
 .W !,"Current Local version: ",$$VERSION^OCXOCMP
"RTN","ORY269ES",16,0)
 .W !,"   Rule Transport Version: ORDER CHECK EXPERT version 1.01 released OCT 29,1998"
"RTN","ORY269ES",17,0)
 I '$D(DTIME) W !!,"DTIME not defined !!",!! Q
"RTN","ORY269ES",18,0)
 W !!,"Order Check Expert System Rule Transporter"
"RTN","ORY269ES",19,0)
 W !," Created: JUL 26,2013 at 06:56  at  CPRS30.FO.DOMAIN.EXT"
"RTN","ORY269ES",20,0)
 W !," Current Date: ",$$NOW^ORY2690,"  at  ",$$NETNAME^OCXSEND,!!
"RTN","ORY269ES",21,0)
 S LASTFILE=0 K ^TMP("OCXRULE",$J)
"RTN","ORY269ES",22,0)
 S ^TMP("OCXRULE",$J)=($P($H,",",2)+($H*86400)+(1*60*60))_" <- ^TMP ENTRY EXPIRATION DATE FOR ^OCXOPURG"
"RTN","ORY269ES",23,0)
 S OCXFLAG="O"
"RTN","ORY269ES",24,0)
 ;
"RTN","ORY269ES",25,0)
RUN ;
"RTN","ORY269ES",26,0)
 ;
"RTN","ORY269ES",27,0)
 W !,"Loading Data " D ^ORY26901
"RTN","ORY269ES",28,0)
 ;
"RTN","ORY269ES",29,0)
 S LINE=0 F  S LINE=$O(^TMP("OCXRULE",$J,LINE)) Q:'LINE   D  Q:QUIT
"RTN","ORY269ES",30,0)
 .D:'(LINE#50) STATUS^OCXOPOST(LINE,$O(^TMP("OCXRULE",$J," "),-1))
"RTN","ORY269ES",31,0)
 .S TEXT=$G(^TMP("OCXRULE",$J,LINE)) I $L(TEXT) D  Q:QUIT
"RTN","ORY269ES",32,0)
 ..S TEXT=$P(TEXT,";",2,999),OPCODE=$P(TEXT,U,1),TEXT=$P(TEXT,U,2,999)
"RTN","ORY269ES",33,0)
 ..;
"RTN","ORY269ES",34,0)
 ..I OPCODE="KEY" D DOT S LOCAL="",D0=$$GETFILE^ORY2690(+$P(TEXT,U,1),$P(TEXT,U,2),.LOCAL) S QUIT=(D0=(-10)) Q
"RTN","ORY269ES",35,0)
 ..I OPCODE="R" S REF="REMOTE("_$P(TEXT,":",1)_":"_D0_$P(TEXT,":",2,99)_")" Q
"RTN","ORY269ES",36,0)
 ..I OPCODE="D",$D(REF) S @REF=$P(TEXT,U,1,999) K REF Q
"RTN","ORY269ES",37,0)
 ..;
"RTN","ORY269ES",38,0)
 ..I OPCODE="EOR" S QUIT=$$COMPARE^ORY2691(.LOCAL,.REMOTE) K LOCAL,REMOTE Q
"RTN","ORY269ES",39,0)
 ..I OPCODE="EOF" K LOCAL,REMOTE Q
"RTN","ORY269ES",40,0)
 ..I OPCODE="SOF" W !,"  Installing '",TEXT,"' records... " Q
"RTN","ORY269ES",41,0)
 ..I OPCODE="ROOT" D  Q
"RTN","ORY269ES",42,0)
 ...N FILE,DATA
"RTN","ORY269ES",43,0)
 ...S FILE=U_$P(TEXT,U,1),DATA=$P(TEXT,U,2,3)
"RTN","ORY269ES",44,0)
 ...I ($P($G(@FILE),U,1,2)=DATA) Q
"RTN","ORY269ES",45,0)
 ...S $P(@FILE,U,1,2)=DATA
"RTN","ORY269ES",46,0)
 ...W !,"  Restoring file #",(+$P(DATA,U,2))," zero node"
"RTN","ORY269ES",47,0)
 ..;
"RTN","ORY269ES",48,0)
 ..W !,"Unknown OpCode: ",OPCODE,"  in: ",TEXT S QUIT=$$PAUSE^ORY2690 W !
"RTN","ORY269ES",49,0)
 ;
"RTN","ORY269ES",50,0)
 K ^TMP("OCXRULE",$J)
"RTN","ORY269ES",51,0)
 ;
"RTN","ORY269ES",52,0)
 I $D(^OCXS) D
"RTN","ORY269ES",53,0)
 .N FILE,DO,PD0,CNT
"RTN","ORY269ES",54,0)
 .S FILE=0 F  S FILE=$O(^OCXS(FILE)) Q:'FILE  D
"RTN","ORY269ES",55,0)
 ..S D0=0 F CNT=0:1 S PD0=D0,D0=$O(^OCXS(FILE,D0)) Q:'D0
"RTN","ORY269ES",56,0)
 ..S $P(^OCXS(FILE,0),U,3,4)=CNT_U_PD0
"RTN","ORY269ES",57,0)
 ;
"RTN","ORY269ES",58,0)
 I $G(OCXDIER) D
"RTN","ORY269ES",59,0)
 .W !!!!!!!
"RTN","ORY269ES",60,0)
 .W !,?5,"******************** Warning ******************** "
"RTN","ORY269ES",61,0)
 .W !,?7,+$G(OCXDIER)," data filing error",$S(($G(OCXDIER)=1):"",1:"s"),"."
"RTN","ORY269ES",62,0)
 .W !,?7,"Some expert system rules may be incomplete."
"RTN","ORY269ES",63,0)
 .W !,?5,"******************** Warning ******************** "
"RTN","ORY269ES",64,0)
 I '$G(OCXDIER) W !!,?5," No data filing errors."
"RTN","ORY269ES",65,0)
 W !!,"Transport Finished..."
"RTN","ORY269ES",66,0)
 ;
"RTN","ORY269ES",67,0)
 D
"RTN","ORY269ES",68,0)
 .N OCXOETIM
"RTN","ORY269ES",69,0)
 .D BMES^XPDUTL("---Creating Order Check Routines-----------------------------------")
"RTN","ORY269ES",70,0)
 .D AUTO^OCXOCMP
"RTN","ORY269ES",71,0)
 ;
"RTN","ORY269ES",72,0)
 Q
"RTN","ORY269ES",73,0)
 ;
"RTN","ORY269ES",74,0)
DOT Q:$G(OCXAUTO)  W:($X>70) ! W " ." Q
"RTN","ORY269ES",75,0)
 ;
"RTN","ORY269ES",76,0)
READ(OCXZ0,OCXZA,OCXZB,OCXZL) ;
"RTN","ORY269ES",77,0)
 N OCXLINE,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","ORY269ES",78,0)
 Q:'$L($G(OCXZ0)) U
"RTN","ORY269ES",79,0)
 S DIR(0)=OCXZ0
"RTN","ORY269ES",80,0)
 S:$L($G(OCXZA)) DIR("A")=OCXZA
"RTN","ORY269ES",81,0)
 S:$L($G(OCXZB)) DIR("B")=OCXZB
"RTN","ORY269ES",82,0)
 F OCXLINE=1:1:($G(OCXZL)-1) W !
"RTN","ORY269ES",83,0)
 D ^DIR
"RTN","ORY269ES",84,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q U
"RTN","ORY269ES",85,0)
 Q Y
"RTN","ORY269ES",86,0)
 ;
"SEC","^DD",100.05,100.05,14,8.5)

"SEC","^DIC",100.05,100.05,0,"AUDIT")
@
"SEC","^DIC",100.05,100.05,0,"DD")
@
"SEC","^DIC",100.05,100.05,0,"DEL")
@
"SEC","^DIC",100.05,100.05,0,"LAYGO")
@
"SEC","^DIC",100.05,100.05,0,"WR")
@
"VER")
8.0^22.0
"^DD",100.05,100.05,0)
FIELD^^86^26
"^DD",100.05,100.05,0,"DDA")
N
"^DD",100.05,100.05,0,"DT")
3140403
"^DD",100.05,100.05,0,"ID",2)
W "   ",$P(^(0),U,3)
"^DD",100.05,100.05,0,"ID",5)
S %I=Y,Y=$S('$D(^(1)):"",$D(^ORD(100.8,+$P(^(1),U,1),0))#2:$P(^(0),U,1),1:""),C=$P(^DD(100.8,.01,0),U,2) D Y^DIQ:Y]"" W "   ",Y,@("$E("_DIC_"%I,0),0)") S Y=%I K %I
"^DD",100.05,100.05,0,"IX","B",100.05,.01)

"^DD",100.05,100.05,0,"NM","ORDER CHECK INSTANCES")

"^DD",100.05,100.05,0,"VRPK")
OR
"^DD",100.05,100.05,.01,0)
ORDER^RP100'^OR(100,^0;1^Q
"^DD",100.05,100.05,.01,1,0)
^.1
"^DD",100.05,100.05,.01,1,1,0)
100.05^B
"^DD",100.05,100.05,.01,1,1,1)
S ^ORD(100.05,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.05,.01,1,1,2)
K ^ORD(100.05,"B",$E(X,1,30),DA)
"^DD",100.05,100.05,.01,3)
Select the order that this order check is in reference to.
"^DD",100.05,100.05,.01,21,0)
^^1^1^3121119^
"^DD",100.05,100.05,.01,21,1,0)
The order that this order check is related to.
"^DD",100.05,100.05,.01,"DT")
3121119
"^DD",100.05,100.05,1,0)
STATUS^P100.01'^ORD(100.01,^0;2^Q
"^DD",100.05,100.05,1,3)
Enter the status of the order when the order check occurred.
"^DD",100.05,100.05,1,21,0)
^^1^1^3121119^
"^DD",100.05,100.05,1,21,1,0)
This is the status of the order when the order check occurred.
"^DD",100.05,100.05,1,"DT")
3121119
"^DD",100.05,100.05,2,0)
OCCURRENCE^F^^0;3^K:$L(X)>40!($L(X)<1) X
"^DD",100.05,100.05,2,3)
Enter a descriptor tag between 1 and 40 characters.
"^DD",100.05,100.05,2,21,0)
^^6^6^3090116^
"^DD",100.05,100.05,2,21,1,0)
This is a description field that the application where the order check 
"^DD",100.05,100.05,2,21,2,0)
occurred can use to describe where/when the order check took place.  For 
"^DD",100.05,100.05,2,21,3,0)
instance, CPRS will use ACCEPTANCE_CPRS when the order check happened at 
"^DD",100.05,100.05,2,21,4,0)
order acceptance inside of the CPRS application. CPRS will use 
"^DD",100.05,100.05,2,21,5,0)
SIGNATURE_CPRS when the order check happened at order signature inside of 
"^DD",100.05,100.05,2,21,6,0)
the CPRS application.
"^DD",100.05,100.05,2,"DT")
3130228
"^DD",100.05,100.05,3,0)
USER^P200'^VA(200,^0;4^Q
"^DD",100.05,100.05,3,3)
Enter the user who saw this order check.
"^DD",100.05,100.05,3,21,0)
^^1^1^3121119^
"^DD",100.05,100.05,3,21,1,0)
This is the user that saw the order check.
"^DD",100.05,100.05,3,"DT")
3121119
"^DD",100.05,100.05,4,0)
OCCURRENCE DATE/TIME^D^^0;5^S %DT="ESTX" D ^%DT S X=Y K:X<1 X
"^DD",100.05,100.05,4,3)
Enter the date/time of the order check.
"^DD",100.05,100.05,4,21,0)
^^1^1^3130205^
"^DD",100.05,100.05,4,21,1,0)
This is the date/time when the order check was generated.
"^DD",100.05,100.05,4,"DT")
3130206
"^DD",100.05,100.05,5,0)
ORDER CHECK^P100.8'^ORD(100.8,^1;1^Q
"^DD",100.05,100.05,5,3)
Enter the type of the order check.
"^DD",100.05,100.05,5,21,0)
^^1^1^3121119^
"^DD",100.05,100.05,5,21,1,0)
This is the type of the order check.
"^DD",100.05,100.05,5,"DT")
3121119
"^DD",100.05,100.05,6,0)
CLINICAL DANGER LEVEL^S^1:HIGH;2:MODERATE;3:LOW;^1;2^Q
"^DD",100.05,100.05,6,3)
Enter the clinical danger level of this order check.
"^DD",100.05,100.05,6,21,0)
^^2^2^3121119^
"^DD",100.05,100.05,6,21,1,0)
This is the clinical danger level of the order check type at the time this
"^DD",100.05,100.05,6,21,2,0)
order check was generated.
"^DD",100.05,100.05,6,"DT")
3121119
"^DD",100.05,100.05,7,0)
OVERRIDE REASON^100.57^^3;0
"^DD",100.05,100.05,7,21,0)
^^2^2^3121119^
"^DD",100.05,100.05,7,21,1,0)
This field represents the reason that the user is overriding the order
"^DD",100.05,100.05,7,21,2,0)
check and continuing with placing the order.
"^DD",100.05,100.05,8,0)
ORDER CHECK MESSAGE^100.58^^2;0
"^DD",100.05,100.05,8,21,0)
^^2^2^3090115^
"^DD",100.05,100.05,8,21,1,0)
This field stores the text of the order check that was presented to the 
"^DD",100.05,100.05,8,21,2,0)
user.
"^DD",100.05,100.05,13,0)
PHARMACIST OVERRIDE COMMENTS^F^^11;1^K:$L(X)>80!($L(X)<1) X
"^DD",100.05,100.05,13,3)
Enter the reason that the pharmacist is overriding the order check.
"^DD",100.05,100.05,13,21,0)
^^2^2^3121119^
"^DD",100.05,100.05,13,21,1,0)
This field represents the reason that the pharmacist is overriding the 
"^DD",100.05,100.05,13,21,2,0)
order check and continuing with placing the order.
"^DD",100.05,100.05,13,"DT")
3121119
"^DD",100.05,100.05,14,0)
PHARMACIST^P200'^VA(200,^11;2^Q
"^DD",100.05,100.05,14,3)
Enter the pharmacist who entered the pharmacist override comments.
"^DD",100.05,100.05,14,21,0)
^^1^1^3121119^
"^DD",100.05,100.05,14,21,1,0)
This is the pharmacist who entered the pharmacist override comments.
"^DD",100.05,100.05,14,"DT")
3121119
"^DD",100.05,100.05,14.1,0)
PHARMACIST COMMENTS DATE/TIME^D^^11;3^S %DT="ESTX" D ^%DT S X=Y K:X<1 X
"^DD",100.05,100.05,14.1,3)
Enter the date/time that the Pharmacist Override Comments were entered.
"^DD",100.05,100.05,14.1,21,0)
^^2^2^3130206^
"^DD",100.05,100.05,14.1,21,1,0)
This field represents the date and time that the Pharmacist Override 
"^DD",100.05,100.05,14.1,21,2,0)
Comments were entered.
"^DD",100.05,100.05,14.1,"DT")
3130206
"^DD",100.05,100.05,15,0)
MONOGRAPH^100.515^^16;0
"^DD",100.05,100.05,15,21,0)
^^1^1^3120305^
"^DD",100.05,100.05,15,21,1,0)
This field stores the monograph for drug-drug interactions.
"^DD",100.05,100.05,16,0)
MONOGRAPH TERM^F^^17;1^K:$L(X)>150!($L(X)<1) X
"^DD",100.05,100.05,16,3)
Enter the term (1-150 characters) to display to the user when selecting from a monograph list.
"^DD",100.05,100.05,16,21,0)
^^2^2^3090618^
"^DD",100.05,100.05,16,21,1,0)
This is the term that will be displayed to the user when selecting from a 
"^DD",100.05,100.05,16,21,2,0)
list of monographs to view.
"^DD",100.05,100.05,16,"DT")
3121121
"^DD",100.05,100.05,17,0)
DRUG ALLERGIES^100.517A^^4;0
"^DD",100.05,100.05,17,21,0)
^^1^1^3130208^
"^DD",100.05,100.05,17,21,1,0)
These are the drug allergies that were displayed during order entry.
"^DD",100.05,100.05,50,0)
DISPENSE DRUGS^100.06PA^^5;0
"^DD",100.05,100.05,50,21,0)
^^1^1^3121119^
"^DD",100.05,100.05,50,21,1,0)
The dispense drug(s) associated with the order check.
"^DD",100.05,100.05,60,0)
GROUP ONE PHARMACY ORDERS^100.07VA^^6;0
"^DD",100.05,100.05,60,21,0)
^.001^3^3^3140327^^^^
"^DD",100.05,100.05,60,21,1,0)
Contains the interacting pharmacy pending inpatient orders, pending
"^DD",100.05,100.05,60,21,2,0)
outpatient orders and outpatient prescriptions for duplicate drugs, 
"^DD",100.05,100.05,60,21,3,0)
drug-drug interactions, Clozapine and duplicate therapy order checks.
"^DD",100.05,100.05,60,"DT")
3121116
"^DD",100.05,100.05,70,0)
GROUP TWO PHARMACY ORDERS^100.11A^^7;0
"^DD",100.05,100.05,70,21,0)
^.001^4^4^3140327^^
"^DD",100.05,100.05,70,21,1,0)
Contains the interacting pharmacy non-VA medication, unit dose, and IV
"^DD",100.05,100.05,70,21,2,0)
order numbers, as well as remote outpatient prescriptions, for the
"^DD",100.05,100.05,70,21,3,0)
duplicate drugs, drug-drug interactions, Clozapine and duplicate therapy
"^DD",100.05,100.05,70,21,4,0)
order checks.
"^DD",100.05,100.05,70,"DT")
3121116
"^DD",100.05,100.05,81,0)
INTERVENTION^P9009032.4'^APSPQA(32.4,^8;1^Q
"^DD",100.05,100.05,81,3)
Enter the pharmacy intervention for this order check.
"^DD",100.05,100.05,81,21,0)
^^1^1^3121119^
"^DD",100.05,100.05,81,21,1,0)
This is the pharmacy intervention that was taken for this order check.
"^DD",100.05,100.05,81,"DT")
3121119
"^DD",100.05,100.05,82,0)
CLOZAPINE DISPENSING FREQUENCY^S^W:WEEKLY;B:BI-WEEKLY;M:MONTHLY;^8;2^Q
"^DD",100.05,100.05,82,3)
Select how often Clozapine prescriptions may be written for this patient.
"^DD",100.05,100.05,82,21,0)
^^2^2^3130208^
"^DD",100.05,100.05,82,21,1,0)
This is how often the patient is authorized to receive a Clozapine dosage 
"^DD",100.05,100.05,82,21,2,0)
at the time this order check was generated.
"^DD",100.05,100.05,82,"DT")
3130208
"^DD",100.05,100.05,83,0)
DRUG INTERACTION SEVERITY^S^C:CRITICAL;S:SIGNIFICANT;^8;3^Q
"^DD",100.05,100.05,83,3)
Enter the severity of the drug-drug interaction.
"^DD",100.05,100.05,83,21,0)
^^1^1^3121213^
"^DD",100.05,100.05,83,21,1,0)
This field indicates the severity of the drug-drug interaction.
"^DD",100.05,100.05,83,"DT")
3121213
"^DD",100.05,100.05,84,0)
DATABASE^S^C:COTS;V:VISTA;^8;4^Q
"^DD",100.05,100.05,84,3)
Select the system that generated this order check instance.
"^DD",100.05,100.05,84,21,0)
^^1^1^3130422^
"^DD",100.05,100.05,84,21,1,0)
This is the type of system that generated this order check instance.
"^DD",100.05,100.05,84,"DT")
3130422
"^DD",100.05,100.05,85,0)
CROC OI^P101.43'^ORD(101.43,^12;1^Q
"^DD",100.05,100.05,85,.1)
CLINICAL REMINDERS ORDER CHECK ORDERABLE ITEM
"^DD",100.05,100.05,85,3)
Enter an Orderable Item
"^DD",100.05,100.05,85,21,0)
^^3^3^3140403^
"^DD",100.05,100.05,85,21,1,0)
This field contains an ORDERABLE ITEM file (101.43) IEN.  This field is 
"^DD",100.05,100.05,85,21,2,0)
only set when the ORDER CHECK field (#5) is 35 OR 36 which are the 
"^DD",100.05,100.05,85,21,3,0)
Clinical Reminder Order Checks
"^DD",100.05,100.05,85,23,0)
^^1^1^3140403^
"^DD",100.05,100.05,85,23,1,0)
Pointer to file 101.43
"^DD",100.05,100.05,85,"DT")
3140403
"^DD",100.05,100.05,86,0)
CROC RULE^P801.1'^PXD(801.1,^12;2^Q
"^DD",100.05,100.05,86,.1)
CLINICAL REMINDER ORDER CHECK RULE
"^DD",100.05,100.05,86,3)
Enter a Reminder Order Check Rule
"^DD",100.05,100.05,86,21,0)
^^3^3^3140403^
"^DD",100.05,100.05,86,21,1,0)
This field contains a REMINDER ORDER CHECK RULES file (801) IEN.  This 
"^DD",100.05,100.05,86,21,2,0)
field is only set when the ORDER CHECK field (#5) is 35 OR 36 which are 
"^DD",100.05,100.05,86,21,3,0)
the Clinical Reminder Order Checks
"^DD",100.05,100.05,86,23,0)
^^1^1^3140403^
"^DD",100.05,100.05,86,23,1,0)
Pointer to file 801.1
"^DD",100.05,100.05,86,"DT")
3140403
"^DD",100.05,100.05,90,0)
CLOZAPINE LAB RESULTS^100.08P^^9;0
"^DD",100.05,100.05,90,21,0)
^^1^1^3121119^
"^DD",100.05,100.05,90,21,1,0)
Contains the lab result(s) for Clozapine order checks.
"^DD",100.05,100.05,100,0)
CLINICAL EFFECTS^100.13^^10;0
"^DD",100.05,100.05,100,21,0)
^^1^1^3121213^
"^DD",100.05,100.05,100,21,1,0)
Contains the clinical effects for drug-drug interaction order checks.
"^DD",100.05,100.06,0)
DISPENSE DRUGS SUB-FIELD^^.01^1
"^DD",100.05,100.06,0,"DT")
3121119
"^DD",100.05,100.06,0,"IX","B",100.06,.01)

"^DD",100.05,100.06,0,"NM","DISPENSE DRUGS")

"^DD",100.05,100.06,0,"UP")
100.05
"^DD",100.05,100.06,.01,0)
DISPENSE DRUG^MP50'^PSDRUG(^0;1^Q
"^DD",100.05,100.06,.01,1,0)
^.1
"^DD",100.05,100.06,.01,1,1,0)
100.06^B
"^DD",100.05,100.06,.01,1,1,1)
S ^ORD(100.05,DA(1),5,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.06,.01,1,1,2)
K ^ORD(100.05,DA(1),5,"B",$E(X,1,30),DA)
"^DD",100.05,100.06,.01,3)
Enter the dispense drug associated with the order check.
"^DD",100.05,100.06,.01,21,0)
^^1^1^3121119^
"^DD",100.05,100.06,.01,21,1,0)
The dispense drug associated with the order check.
"^DD",100.05,100.06,.01,"DT")
3121119
"^DD",100.05,100.07,0)
GROUP ONE PHARMACY ORDERS SUB-FIELD^^2^3
"^DD",100.05,100.07,0,"DT")
3140327
"^DD",100.05,100.07,0,"IX","B",100.07,.01)

"^DD",100.05,100.07,0,"NM","GROUP ONE PHARMACY ORDERS")

"^DD",100.05,100.07,0,"UP")
100.05
"^DD",100.05,100.07,.01,0)
GROUP ONE PHARMACY ORDER^MV^^0;1^
"^DD",100.05,100.07,.01,1,0)
^.1
"^DD",100.05,100.07,.01,1,1,0)
100.07^B
"^DD",100.05,100.07,.01,1,1,1)
S ^ORD(100.05,DA(1),6,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.07,.01,1,1,2)
K ^ORD(100.05,DA(1),6,"B",$E(X,1,30),DA)
"^DD",100.05,100.07,.01,1,1,3)
Required for Variable Pointer
"^DD",100.05,100.07,.01,3)
Select the interacting pharmacy pending inpatient order, pending outpatient order or outpatient prescription.
"^DD",100.05,100.07,.01,21,0)
^^3^3^3121116^
"^DD",100.05,100.07,.01,21,1,0)
Contains the interacting pharmacy pending inpatient order, pending 
"^DD",100.05,100.07,.01,21,2,0)
outpatient order or outpatient prescription for the duplicate
"^DD",100.05,100.07,.01,21,3,0)
drug, drug-drug interaction, Clozapine and duplicate therapy order check.
"^DD",100.05,100.07,.01,"DT")
3121119
"^DD",100.05,100.07,.01,"V",0)
^.12P^^3
"^DD",100.05,100.07,.01,"V",1,0)
52.41^OUTPATIENT PENDING ORDERS^1^OPP^n^n
"^DD",100.05,100.07,.01,"V",2,0)
53.1^INPATIENT RX^2^IP^n^n
"^DD",100.05,100.07,.01,"V",3,0)
52^OUTPATIENT RX^3^OPR^n^n
"^DD",100.05,100.07,1,0)
ADDITIVE^100.14P^^1;0
"^DD",100.05,100.07,1,21,0)
^^3^3^3140327^
"^DD",100.05,100.07,1,21,1,0)
This field contains the interacting IV 
"^DD",100.05,100.07,1,21,2,0)
Additive(s) for drug interactions and 
"^DD",100.05,100.07,1,21,3,0)
duplicate therapy order checks.
"^DD",100.05,100.07,1,23,0)
^^3^3^3140327^
"^DD",100.05,100.07,1,23,1,0)
This field is used during display of the Order
"^DD",100.05,100.07,1,23,2,0)
Check History activity log to identify which 
"^DD",100.05,100.07,1,23,3,0)
IV Additive(s) interacted with the drug ordered.
"^DD",100.05,100.07,2,0)
SOLUTION^100.72P^^2;0
"^DD",100.05,100.07,2,21,0)
^^3^3^3140327^
"^DD",100.05,100.07,2,21,1,0)
This field contains the interacting IV 
"^DD",100.05,100.07,2,21,2,0)
Solution(s) for drug interactions and
"^DD",100.05,100.07,2,21,3,0)
duplicate therapy order checks.
"^DD",100.05,100.07,2,23,0)
^^3^3^3140327^
"^DD",100.05,100.07,2,23,1,0)
This field is used during display of the Order
"^DD",100.05,100.07,2,23,2,0)
Check History activity log to identify which 
"^DD",100.05,100.07,2,23,3,0)
IV Solution(s) interacted with the drug ordered.
"^DD",100.05,100.08,0)
CLOZAPINE LAB RESULTS SUB-FIELD^^.01^1
"^DD",100.05,100.08,0,"DT")
3121101
"^DD",100.05,100.08,0,"IX","B",100.08,.01)

"^DD",100.05,100.08,0,"NM","CLOZAPINE LAB RESULTS")

"^DD",100.05,100.08,0,"UP")
100.05
"^DD",100.05,100.08,.01,0)
CLOZAPINE LAB RESULT^MP63'^LR(^0;1^Q
"^DD",100.05,100.08,.01,1,0)
^.1
"^DD",100.05,100.08,.01,1,1,0)
100.08^B
"^DD",100.05,100.08,.01,1,1,1)
S ^ORD(100.05,DA(1),9,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.08,.01,1,1,2)
K ^ORD(100.05,DA(1),9,"B",$E(X,1,30),DA)
"^DD",100.05,100.08,.01,3)
Select the Clozapine lab result.
"^DD",100.05,100.08,.01,21,0)
^^1^1^3121119^
"^DD",100.05,100.08,.01,21,1,0)
Contains the current lab results for a Clozapine order check.
"^DD",100.05,100.08,.01,"DT")
3121119
"^DD",100.05,100.11,0)
GROUP TWO PHARMACY ORDERS SUB-FIELD^^4^4
"^DD",100.05,100.11,0,"DT")
3140327
"^DD",100.05,100.11,0,"IX","B",100.11,.01)

"^DD",100.05,100.11,0,"NM","GROUP TWO PHARMACY ORDERS")

"^DD",100.05,100.11,0,"UP")
100.05
"^DD",100.05,100.11,.01,0)
GROUP TWO PHARMACY ORDER^MF^^0;1^K:$L(X)>20!($L(X)<1) X
"^DD",100.05,100.11,.01,1,0)
^.1
"^DD",100.05,100.11,.01,1,1,0)
100.11^B
"^DD",100.05,100.11,.01,1,1,1)
S ^ORD(100.05,DA(1),7,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.11,.01,1,1,2)
K ^ORD(100.05,DA(1),7,"B",$E(X,1,30),DA)
"^DD",100.05,100.11,.01,3)
Enter the interacting pharmacy non-VA medication, unit dose, IV order, or remote outpatient prescription number (1-20 characters in length).
"^DD",100.05,100.11,.01,21,0)
^^4^4^3121119^
"^DD",100.05,100.11,.01,21,1,0)
Contains the interacting pharmacy non-VA medication, unit dose, and IV
"^DD",100.05,100.11,.01,21,2,0)
order number, as well as the remote outpatient prescription, for the
"^DD",100.05,100.11,.01,21,3,0)
duplicate drugs, drug-drug interactions, Clozapine and duplicate therapy
"^DD",100.05,100.11,.01,21,4,0)
order check.
"^DD",100.05,100.11,.01,23,0)
^^13^13^3121121^
"^DD",100.05,100.11,.01,23,1,0)
Data is formatted as follows:
"^DD",100.05,100.11,.01,23,2,0)
 
"^DD",100.05,100.11,.01,23,3,0)
"N;ien" => Non-VA Medications
"^DD",100.05,100.11,.01,23,4,0)
           ^PS(55,DFN,"NVA",ien)
"^DD",100.05,100.11,.01,23,5,0)
 
"^DD",100.05,100.11,.01,23,6,0)
"R;rx#" => Remote Outpatient
"^DD",100.05,100.11,.01,23,7,0)
           Prescription Number
"^DD",100.05,100.11,.01,23,8,0)
 
"^DD",100.05,100.11,.01,23,9,0)
"U;ien" => Unit Dose Medications
"^DD",100.05,100.11,.01,23,10,0)
           ^PS(55,DFN,5,ien)
"^DD",100.05,100.11,.01,23,11,0)
 
"^DD",100.05,100.11,.01,23,12,0)
"V;ien" => IV Medications
"^DD",100.05,100.11,.01,23,13,0)
           ^PS(55,DFN,"IV",ien)
"^DD",100.05,100.11,.01,"DT")
3121121
"^DD",100.05,100.11,2,0)
REMOTE LOCATION^P4'^DIC(4,^0;2^Q
"^DD",100.05,100.11,2,3)
Select the remote institution that filled this outpatient prescription (leave blank for all other order types).
"^DD",100.05,100.11,2,21,0)
^^3^3^3131216^
"^DD",100.05,100.11,2,21,1,0)
If the outpatient prescription was reported at a non-local institution, 
"^DD",100.05,100.11,2,21,2,0)
this field will identify that institution. For all other order types, 
"^DD",100.05,100.11,2,21,3,0)
this field will be blank.
"^DD",100.05,100.11,2,"DT")
3131216
"^DD",100.05,100.11,3,0)
ADDITIVE^100.113P^^1;0
"^DD",100.05,100.11,3,21,0)
^^3^3^3140327^
"^DD",100.05,100.11,3,21,1,0)
This field contains interacting IV 
"^DD",100.05,100.11,3,21,2,0)
Additive(s) for drug interactions and
"^DD",100.05,100.11,3,21,3,0)
duplicate therapy order checks.
"^DD",100.05,100.11,3,23,0)
^^4^4^3140327^
"^DD",100.05,100.11,3,23,1,0)
This field is used during display of the 
"^DD",100.05,100.11,3,23,2,0)
Order Check History activity log to identify 
"^DD",100.05,100.11,3,23,3,0)
which IV Additive(s) interacted with the drug 
"^DD",100.05,100.11,3,23,4,0)
ordered.
"^DD",100.05,100.11,4,0)
SOLUTION^100.114P^^2;0
"^DD",100.05,100.11,4,21,0)
^^3^3^3140327^
"^DD",100.05,100.11,4,21,1,0)
This field contains interacting IV 
"^DD",100.05,100.11,4,21,2,0)
Solution(s) for drug interactions and
"^DD",100.05,100.11,4,21,3,0)
duplicate therapy order checks.  
"^DD",100.05,100.11,4,23,0)
^^4^4^3140327^
"^DD",100.05,100.11,4,23,1,0)
This field is used during display of the 
"^DD",100.05,100.11,4,23,2,0)
Order Check History activity log to identify 
"^DD",100.05,100.11,4,23,3,0)
which IV Solutions(s) interacted with the 
"^DD",100.05,100.11,4,23,4,0)
drug ordered.
"^DD",100.05,100.113,0)
ADDITIVE SUB-FIELD^^.01^1
"^DD",100.05,100.113,0,"DT")
3140327
"^DD",100.05,100.113,0,"IX","B",100.113,.01)

"^DD",100.05,100.113,0,"NM","ADDITIVE")

"^DD",100.05,100.113,0,"UP")
100.11
"^DD",100.05,100.113,.01,0)
ADDITIVE^MP52.6^PS(52.6,^0;1^Q
"^DD",100.05,100.113,.01,1,0)
^.1
"^DD",100.05,100.113,.01,1,1,0)
100.113^B
"^DD",100.05,100.113,.01,1,1,1)
S ^ORD(100.05,DA(2),7,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.113,.01,1,1,2)
K ^ORD(100.05,DA(2),7,DA(1),1,"B",$E(X,1,30),DA)
"^DD",100.05,100.113,.01,3)
Enter the interacting IV Additive for the order check.
"^DD",100.05,100.113,.01,"DT")
3140327
"^DD",100.05,100.114,0)
SOLUTION SUB-FIELD^^.01^1
"^DD",100.05,100.114,0,"DT")
3140327
"^DD",100.05,100.114,0,"IX","B",100.114,.01)

"^DD",100.05,100.114,0,"NM","SOLUTION")

"^DD",100.05,100.114,0,"UP")
100.11
"^DD",100.05,100.114,.01,0)
SOLUTION^MMP52.7^PS(52.7,^0;1^Q
"^DD",100.05,100.114,.01,1,0)
^.1
"^DD",100.05,100.114,.01,1,1,0)
100.114^B
"^DD",100.05,100.114,.01,1,1,1)
S ^ORD(100.05,DA(2),7,DA(1),2,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.114,.01,1,1,2)
K ^ORD(100.05,DA(2),7,DA(1),2,"B",$E(X,1,30),DA)
"^DD",100.05,100.114,.01,3)
Enter the interacting IV Solution for the order check.
"^DD",100.05,100.114,.01,"DT")
3140327
"^DD",100.05,100.13,0)
CLINICAL EFFECTS SUB-FIELD^^.01^1
"^DD",100.05,100.13,0,"DT")
3121213
"^DD",100.05,100.13,0,"NM","CLINICAL EFFECTS")

"^DD",100.05,100.13,0,"UP")
100.05
"^DD",100.05,100.13,.01,0)
CLINICAL EFFECTS^Wx^^0;1^Q
"^DD",100.05,100.13,.01,3)
Enter the clinical effects for this drug-drug interaction order check.
"^DD",100.05,100.13,.01,21,0)
^^1^1^3121213^
"^DD",100.05,100.13,.01,21,1,0)
Contains the clinical effects for drug-drug interaction order checks.
"^DD",100.05,100.13,.01,"DT")
3121213
"^DD",100.05,100.14,0)
ADDITIVE SUB-FIELD^^.01^1
"^DD",100.05,100.14,0,"DT")
3140327
"^DD",100.05,100.14,0,"IX","B",100.14,.01)

"^DD",100.05,100.14,0,"NM","ADDITIVE")

"^DD",100.05,100.14,0,"UP")
100.07
"^DD",100.05,100.14,.01,0)
ADDITIVE^MP52.6^PS(52.6,^0;1^Q
"^DD",100.05,100.14,.01,1,0)
^.1
"^DD",100.05,100.14,.01,1,1,0)
100.14^B
"^DD",100.05,100.14,.01,1,1,1)
S ^ORD(100.05,DA(2),6,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.14,.01,1,1,2)
K ^ORD(100.05,DA(2),6,DA(1),1,"B",$E(X,1,30),DA)
"^DD",100.05,100.14,.01,3)
Enter the interacting IV Additive for the order check.
"^DD",100.05,100.14,.01,"DT")
3140327
"^DD",100.05,100.515,0)
MONOGRAPH SUB-FIELD^^.01^1
"^DD",100.05,100.515,0,"DT")
3120202
"^DD",100.05,100.515,0,"NM","MONOGRAPH")

"^DD",100.05,100.515,0,"UP")
100.05
"^DD",100.05,100.515,.01,0)
MONOGRAPH^W^^0;1^Q
"^DD",100.05,100.515,.01,3)
Enter the monograph text received from pharmacy.
"^DD",100.05,100.515,.01,21,0)
^^2^2^3120202^
"^DD",100.05,100.515,.01,21,1,0)
This field will hold the monograph data that pharmacy sends back with 
"^DD",100.05,100.515,.01,21,2,0)
Drug Interaction order checks.
"^DD",100.05,100.515,.01,"DT")
3120202
"^DD",100.05,100.517,0)
DRUG ALLERGIES SUB-FIELD^^10^10
"^DD",100.05,100.517,0,"DT")
3131126
"^DD",100.05,100.517,0,"IX","B",100.517,.01)

"^DD",100.05,100.517,0,"NM","DRUG ALLERGIES")

"^DD",100.05,100.517,0,"UP")
100.05
"^DD",100.05,100.517,.01,0)
REACTANT^F^^0;1^K:$L(X)>64!($L(X)<1) X
"^DD",100.05,100.517,.01,1,0)
^.1
"^DD",100.05,100.517,.01,1,1,0)
100.517^B
"^DD",100.05,100.517,.01,1,1,1)
S ^ORD(100.05,DA(1),4,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.517,.01,1,1,2)
K ^ORD(100.05,DA(1),4,"B",$E(X,1,30),DA)
"^DD",100.05,100.517,.01,3)
Enter the name of the agent that caused this drug allergy (1 to 64 characters).
"^DD",100.05,100.517,.01,21,0)
^^5^5^3130725^
"^DD",100.05,100.517,.01,21,1,0)
The name of the agent that caused this drug allergy.  Remote drug 
"^DD",100.05,100.517,.01,21,2,0)
allergies with a CAUSATIVE AGENT field value that points to the DRUG file
"^DD",100.05,100.517,.01,21,3,0)
(#50) will not have a value in that field on the local system but will
"^DD",100.05,100.517,.01,21,4,0)
have a value for this field.  This is the result of the DRUG file's lack 
"^DD",100.05,100.517,.01,21,5,0)
of standardization across all sites.
"^DD",100.05,100.517,.01,"DT")
3131126
"^DD",100.05,100.517,2,0)
CAUSATIVE AGENT^V^^0;2^
"^DD",100.05,100.517,2,3)
Select the agent that caused this drug allergy.
"^DD",100.05,100.517,2,21,0)
^^1^1^3130823^
"^DD",100.05,100.517,2,21,1,0)
The agent that caused this drug allergy.
"^DD",100.05,100.517,2,"DT")
3130823
"^DD",100.05,100.517,2,"V",0)
^.12P^5^5
"^DD",100.05,100.517,2,"V",1,0)
120.82^GMR ALLERGIES^1^A^n^n
"^DD",100.05,100.517,2,"V",1,1)

"^DD",100.05,100.517,2,"V",1,2)

"^DD",100.05,100.517,2,"V",2,0)
50.416^DRUG INGREDIENTS^2^I^n^n
"^DD",100.05,100.517,2,"V",2,1)

"^DD",100.05,100.517,2,"V",2,2)

"^DD",100.05,100.517,2,"V",3,0)
50.605^VA DRUG CLASS^3^C^n^n
"^DD",100.05,100.517,2,"V",3,1)

"^DD",100.05,100.517,2,"V",3,2)

"^DD",100.05,100.517,2,"V",4,0)
50.6^VA GENERIC^4^N^n^n
"^DD",100.05,100.517,2,"V",4,1)

"^DD",100.05,100.517,2,"V",4,2)

"^DD",100.05,100.517,2,"V",5,0)
50^DRUG^5^D^n^n
"^DD",100.05,100.517,2,"V",5,1)

"^DD",100.05,100.517,2,"V",5,2)

"^DD",100.05,100.517,3,0)
VA DRUG CLASSES^100.5173PA^^1;0
"^DD",100.05,100.517,3,21,0)
^^1^1^3130725^
"^DD",100.05,100.517,3,21,1,0)
These are the drug classes associated with this drug allergy.
"^DD",100.05,100.517,3,"DT")
3121011
"^DD",100.05,100.517,4,0)
DRUG INGREDIENTS^100.5174PA^^2;0
"^DD",100.05,100.517,4,21,0)
^^1^1^3121119^
"^DD",100.05,100.517,4,21,1,0)
These are the drug ingredients associated with this drug allergy.
"^DD",100.05,100.517,4,"DT")
3110915
"^DD",100.05,100.517,5,0)
SIGNS/SYMPTOMS^100.5175PA^^3;0
"^DD",100.05,100.517,5,21,0)
^^1^1^3130115^
"^DD",100.05,100.517,5,21,1,0)
These are the signs and symptoms of the drug allergy.
"^DD",100.05,100.517,6,0)
LOCATION TYPE^S^L:LOCAL;R:REMOTE;B:LOCAL AND REMOTE;^0;3^Q
"^DD",100.05,100.517,6,3)
Select the location type where this drug allergy was entered.
"^DD",100.05,100.517,6,21,0)
^^1^1^3130823^
"^DD",100.05,100.517,6,21,1,0)
The location type where this drug allergy was entered.
"^DD",100.05,100.517,6,"DT")
3130823
"^DD",100.05,100.517,7,0)
REMOTE LOCATION^P4'^DIC(4,^0;4^Q
"^DD",100.05,100.517,7,3)
Select the remote institution that reported this drug allergy (leave blank if local).
"^DD",100.05,100.517,7,21,0)
^^3^3^3130823^
"^DD",100.05,100.517,7,21,1,0)
If the drug allergy was reported at a non-local institution, this field 
"^DD",100.05,100.517,7,21,2,0)
will identify that institution. For drug allergies that were reported in 
"^DD",100.05,100.517,7,21,3,0)
this system's institution, this field will be blank.
"^DD",100.05,100.517,7,"DT")
3130823
"^DD",100.05,100.517,8,0)
ORIGINATION DATE/TIME^D^^0;5^S %DT="ESTXR" D ^%DT S X=Y K:X<1 X
"^DD",100.05,100.517,8,3)
Enter the date/time when the drug allergy was documented.
"^DD",100.05,100.517,8,21,0)
^^1^1^3130823^
"^DD",100.05,100.517,8,21,1,0)
Date/time the drug allergy was entered into the system.
"^DD",100.05,100.517,8,"DT")
3130823
"^DD",100.05,100.517,9,0)
OBSERVED/HISTORICAL^S^O:OBSERVED;H:HISTORICAL;^0;6^Q
"^DD",100.05,100.517,9,3)
Enter whether the drug allergy was observed or was provided by the patient.
"^DD",100.05,100.517,9,21,0)
^^2^2^3130823^
"^DD",100.05,100.517,9,21,1,0)
Indicates whether this drug allergy was observed by VA personnel, or if 
"^DD",100.05,100.517,9,21,2,0)
it is historical data gathered about the patient.
"^DD",100.05,100.517,9,"DT")
3130823
"^DD",100.05,100.517,10,0)
SEVERITY^S^1:MILD;2:MODERATE;3:SEVERE;^0;7^Q
"^DD",100.05,100.517,10,3)
Select the severity of the drug allergy.
"^DD",100.05,100.517,10,21,0)
^^1^1^3130823^
"^DD",100.05,100.517,10,21,1,0)
This field indicates the severity of this drug allergy.
"^DD",100.05,100.517,10,"DT")
3130823
"^DD",100.05,100.5173,0)
VA DRUG CLASSES SUB-FIELD^^.01^1
"^DD",100.05,100.5173,0,"DT")
3110915
"^DD",100.05,100.5173,0,"IX","B",100.5173,.01)

"^DD",100.05,100.5173,0,"NM","VA DRUG CLASSES")

"^DD",100.05,100.5173,0,"UP")
100.517
"^DD",100.05,100.5173,.01,0)
VA DRUG CLASS^P50.605'O^PS(50.605,^0;1^Q
"^DD",100.05,100.5173,.01,1,0)
^.1
"^DD",100.05,100.5173,.01,1,1,0)
100.5173^B
"^DD",100.05,100.5173,.01,1,1,1)
S ^ORD(100.05,DA(2),4,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.5173,.01,1,1,2)
K ^ORD(100.05,DA(2),4,DA(1),1,"B",$E(X,1,30),DA)
"^DD",100.05,100.5173,.01,2)
S Y(0)=Y S Y=$S($D(^PS(50.605,+Y,0)):$P(^(0),U,2)_" ("_$P(^(0),U)_")",1:"UNKNOWN")
"^DD",100.05,100.5173,.01,2.1)
S Y=$S($D(^PS(50.605,+Y,0)):$P(^(0),U,2)_" ("_$P(^(0),U)_")",1:"UNKNOWN")
"^DD",100.05,100.5173,.01,3)
Enter the VA drug class associated with the drug allergy.
"^DD",100.05,100.5173,.01,21,0)
^^1^1^3130725^
"^DD",100.05,100.5173,.01,21,1,0)
The VA drug class associated with the drug allergy.
"^DD",100.05,100.5173,.01,"DT")
3121126
"^DD",100.05,100.5174,0)
DRUG INGREDIENTS SUB-FIELD^^.01^1
"^DD",100.05,100.5174,0,"DT")
3110915
"^DD",100.05,100.5174,0,"IX","B",100.5174,.01)

"^DD",100.05,100.5174,0,"NM","DRUG INGREDIENTS")

"^DD",100.05,100.5174,0,"UP")
100.517
"^DD",100.05,100.5174,.01,0)
DRUG INGREDIENT^P50.416'^PS(50.416,^0;1^Q
"^DD",100.05,100.5174,.01,1,0)
^.1
"^DD",100.05,100.5174,.01,1,1,0)
100.5174^B
"^DD",100.05,100.5174,.01,1,1,1)
S ^ORD(100.05,DA(2),4,DA(1),2,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.5174,.01,1,1,2)
K ^ORD(100.05,DA(2),4,DA(1),2,"B",$E(X,1,30),DA)
"^DD",100.05,100.5174,.01,3)
Enter the drug ingredient associated with the drug allergy.
"^DD",100.05,100.5174,.01,21,0)
^^1^1^3121119^
"^DD",100.05,100.5174,.01,21,1,0)
This is the drug ingredient associated with the drug allergy.
"^DD",100.05,100.5174,.01,"DT")
3121119
"^DD",100.05,100.5175,0)
SIGNS/SYMPTOMS SUB-FIELD^^.01^1
"^DD",100.05,100.5175,0,"DT")
3110915
"^DD",100.05,100.5175,0,"IX","B",100.5175,.01)

"^DD",100.05,100.5175,0,"NM","SIGNS/SYMPTOMS")

"^DD",100.05,100.5175,0,"UP")
100.517
"^DD",100.05,100.5175,.01,0)
SIGN/SYMPTOM^P120.83'^GMRD(120.83,^0;1^Q
"^DD",100.05,100.5175,.01,1,0)
^.1
"^DD",100.05,100.5175,.01,1,1,0)
100.5175^B
"^DD",100.05,100.5175,.01,1,1,1)
S ^ORD(100.05,DA(2),4,DA(1),3,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.5175,.01,1,1,2)
K ^ORD(100.05,DA(2),4,DA(1),3,"B",$E(X,1,30),DA)
"^DD",100.05,100.5175,.01,3)
Enter the sign or symptom of the drug allergy.
"^DD",100.05,100.5175,.01,21,0)
^^1^1^3121119^
"^DD",100.05,100.5175,.01,21,1,0)
This is a sign or symptom of the drug allergy.
"^DD",100.05,100.5175,.01,"DT")
3121119
"^DD",100.05,100.57,0)
OVERRIDE REASON SUB-FIELD^^.01^1
"^DD",100.05,100.57,0,"DT")
3070622
"^DD",100.05,100.57,0,"NM","OVERRIDE REASON")

"^DD",100.05,100.57,0,"UP")
100.05
"^DD",100.05,100.57,.01,0)
OVERRIDE REASON^W^^0;1
"^DD",100.05,100.57,.01,"DT")
3070622
"^DD",100.05,100.58,0)
ORDER CHECK MESSAGE SUB-FIELD^^.01^1
"^DD",100.05,100.58,0,"DT")
3070622
"^DD",100.05,100.58,0,"NM","ORDER CHECK MESSAGE")

"^DD",100.05,100.58,0,"UP")
100.05
"^DD",100.05,100.58,.01,0)
ORDER CHECK MESSAGE^W^^0;1
"^DD",100.05,100.58,.01,"DT")
3070622
"^DD",100.05,100.72,0)
SOLUTION SUB-FIELD^^.01^1
"^DD",100.05,100.72,0,"DT")
3140327
"^DD",100.05,100.72,0,"IX","B",100.72,.01)

"^DD",100.05,100.72,0,"NM","SOLUTION")

"^DD",100.05,100.72,0,"UP")
100.07
"^DD",100.05,100.72,.01,0)
SOLUTION^MP52.7^PS(52.7,^0;1^Q
"^DD",100.05,100.72,.01,1,0)
^.1
"^DD",100.05,100.72,.01,1,1,0)
100.72^B
"^DD",100.05,100.72,.01,1,1,1)
S ^ORD(100.05,DA(2),6,DA(1),2,"B",$E(X,1,30),DA)=""
"^DD",100.05,100.72,.01,1,1,2)
K ^ORD(100.05,DA(2),6,DA(1),2,"B",$E(X,1,30),DA)
"^DD",100.05,100.72,.01,3)
Enter the interacting IV Solution for the order check.
"^DD",100.05,100.72,.01,"DT")
3140327
"^DIC",100.05,100.05,0)
ORDER CHECK INSTANCES^100.05
"^DIC",100.05,100.05,0,"GL")
^ORD(100.05,
"^DIC",100.05,100.05,"%",0)
^1.005^^0
"^DIC",100.05,100.05,"%D",0)
^^2^2^3090121^
"^DIC",100.05,100.05,"%D",1,0)
The purpose of this file is to create a repository for instances of order 
"^DIC",100.05,100.05,"%D",2,0)
checks that are presented to the users of VISTA across all applications.  
"^DIC",100.05,"B","ORDER CHECK INSTANCES",100.05)

**INSTALL NAME**
PSJ*5.0*281
"BLD",9236,0)
PSJ*5.0*281^INPATIENT MEDICATIONS^0^3160204^y
"BLD",9236,4,0)
^9.64PA^^
"BLD",9236,6)
2^
"BLD",9236,6.3)
113
"BLD",9236,"ABPKG")
n
"BLD",9236,"KRN",0)
^9.67PA^779.2^20
"BLD",9236,"KRN",.4,0)
.4
"BLD",9236,"KRN",.401,0)
.401
"BLD",9236,"KRN",.402,0)
.402
"BLD",9236,"KRN",.403,0)
.403
"BLD",9236,"KRN",.5,0)
.5
"BLD",9236,"KRN",.84,0)
.84
"BLD",9236,"KRN",3.6,0)
3.6
"BLD",9236,"KRN",3.8,0)
3.8
"BLD",9236,"KRN",9.2,0)
9.2
"BLD",9236,"KRN",9.8,0)
9.8
"BLD",9236,"KRN",9.8,"NM",0)
^9.68A^49^43
"BLD",9236,"KRN",9.8,"NM",1,0)
PSGOEE^^0^B101870372
"BLD",9236,"KRN",9.8,"NM",4,0)
PSJCROC^^0^B43248221
"BLD",9236,"KRN",9.8,"NM",5,0)
PSJOC^^0^B62583664
"BLD",9236,"KRN",9.8,"NM",6,0)
PSJOCDI^^0^B167459978
"BLD",9236,"KRN",9.8,"NM",7,0)
PSJOCDT^^0^B60637562
"BLD",9236,"KRN",9.8,"NM",8,0)
PSJRXI^^0^B24100017
"BLD",9236,"KRN",9.8,"NM",9,0)
PSGOE7^^0^B30726260
"BLD",9236,"KRN",9.8,"NM",10,0)
PSJDGCK^^0^B20128970
"BLD",9236,"KRN",9.8,"NM",13,0)
PSJDGAL2^^0^B168266917
"BLD",9236,"KRN",9.8,"NM",14,0)
PSJGMRA^^0^B45646088
"BLD",9236,"KRN",9.8,"NM",15,0)
PSGOEV^^0^B91287532
"BLD",9236,"KRN",9.8,"NM",16,0)
PSIV^^0^B30874670
"BLD",9236,"KRN",9.8,"NM",17,0)
PSIVEDT^^0^B52868787
"BLD",9236,"KRN",9.8,"NM",18,0)
PSIVORC1^^0^B80384488
"BLD",9236,"KRN",9.8,"NM",19,0)
PSIVORC2^^0^B62051926
"BLD",9236,"KRN",9.8,"NM",20,0)
PSJLIACT^^0^B53210467
"BLD",9236,"KRN",9.8,"NM",21,0)
PSJOE^^0^B103230773
"BLD",9236,"KRN",9.8,"NM",22,0)
PSJHL3^^0^B97470088
"BLD",9236,"KRN",9.8,"NM",23,0)
PSJLMUT1^^0^B73799409
"BLD",9236,"KRN",9.8,"NM",24,0)
PSJMUTL^^0^B37714348
"BLD",9236,"KRN",9.8,"NM",25,0)
PSJNEWOC^^0^B184689659
"BLD",9236,"KRN",9.8,"NM",26,0)
PSGOEF^^0^B103709466
"BLD",9236,"KRN",9.8,"NM",27,0)
PSGOER^^0^B85734604
"BLD",9236,"KRN",9.8,"NM",28,0)
PSJNEWOA^^0^B26088515
"BLD",9236,"KRN",9.8,"NM",29,0)
PSJOCDSD^^0^B40217839
"BLD",9236,"KRN",9.8,"NM",30,0)
PSGOER0^^0^B23514547
"BLD",9236,"KRN",9.8,"NM",31,0)
PSGOERS^^0^B39916956
"BLD",9236,"KRN",9.8,"NM",32,0)
PSJBLDOC^^0^B59046189
"BLD",9236,"KRN",9.8,"NM",33,0)
PSIVEDRG^^0^B50902632
"BLD",9236,"KRN",9.8,"NM",35,0)
PSIVORE^^0^B44481597
"BLD",9236,"KRN",9.8,"NM",36,0)
PSJOCOR^^0^B3958232
"BLD",9236,"KRN",9.8,"NM",37,0)
PSIVOPT1^^0^B48890773
"BLD",9236,"KRN",9.8,"NM",38,0)
PSGOD^^0^B24552546
"BLD",9236,"KRN",9.8,"NM",39,0)
PSIVOD^^0^B14160821
"BLD",9236,"KRN",9.8,"NM",40,0)
PSJOE1^^0^B30534447
"BLD",9236,"KRN",9.8,"NM",41,0)
PSJCOM^^0^B41203922
"BLD",9236,"KRN",9.8,"NM",43,0)
PSJCOMR^^0^B79145175
"BLD",9236,"KRN",9.8,"NM",44,0)
PSJOEA2^^0^B32521096
"BLD",9236,"KRN",9.8,"NM",45,0)
PSJCOMV^^0^B41513309
"BLD",9236,"KRN",9.8,"NM",46,0)
PSJCOM1^^0^B48577144
"BLD",9236,"KRN",9.8,"NM",47,0)
PSGOES^^0^B22743395
"BLD",9236,"KRN",9.8,"NM",48,0)
PSJLMUTL^^0^B56775239
"BLD",9236,"KRN",9.8,"NM",49,0)
PSGSICH1^^0^B130843550
"BLD",9236,"KRN",9.8,"NM","B","PSGOD",38)

"BLD",9236,"KRN",9.8,"NM","B","PSGOE7",9)

"BLD",9236,"KRN",9.8,"NM","B","PSGOEE",1)

"BLD",9236,"KRN",9.8,"NM","B","PSGOEF",26)

"BLD",9236,"KRN",9.8,"NM","B","PSGOER",27)

"BLD",9236,"KRN",9.8,"NM","B","PSGOER0",30)

"BLD",9236,"KRN",9.8,"NM","B","PSGOERS",31)

"BLD",9236,"KRN",9.8,"NM","B","PSGOES",47)

"BLD",9236,"KRN",9.8,"NM","B","PSGOEV",15)

"BLD",9236,"KRN",9.8,"NM","B","PSGSICH1",49)

"BLD",9236,"KRN",9.8,"NM","B","PSIV",16)

"BLD",9236,"KRN",9.8,"NM","B","PSIVEDRG",33)

"BLD",9236,"KRN",9.8,"NM","B","PSIVEDT",17)

"BLD",9236,"KRN",9.8,"NM","B","PSIVOD",39)

"BLD",9236,"KRN",9.8,"NM","B","PSIVOPT1",37)

"BLD",9236,"KRN",9.8,"NM","B","PSIVORC1",18)

"BLD",9236,"KRN",9.8,"NM","B","PSIVORC2",19)

"BLD",9236,"KRN",9.8,"NM","B","PSIVORE",35)

"BLD",9236,"KRN",9.8,"NM","B","PSJBLDOC",32)

"BLD",9236,"KRN",9.8,"NM","B","PSJCOM",41)

"BLD",9236,"KRN",9.8,"NM","B","PSJCOM1",46)

"BLD",9236,"KRN",9.8,"NM","B","PSJCOMR",43)

"BLD",9236,"KRN",9.8,"NM","B","PSJCOMV",45)

"BLD",9236,"KRN",9.8,"NM","B","PSJCROC",4)

"BLD",9236,"KRN",9.8,"NM","B","PSJDGAL2",13)

"BLD",9236,"KRN",9.8,"NM","B","PSJDGCK",10)

"BLD",9236,"KRN",9.8,"NM","B","PSJGMRA",14)

"BLD",9236,"KRN",9.8,"NM","B","PSJHL3",22)

"BLD",9236,"KRN",9.8,"NM","B","PSJLIACT",20)

"BLD",9236,"KRN",9.8,"NM","B","PSJLMUT1",23)

"BLD",9236,"KRN",9.8,"NM","B","PSJLMUTL",48)

"BLD",9236,"KRN",9.8,"NM","B","PSJMUTL",24)

"BLD",9236,"KRN",9.8,"NM","B","PSJNEWOA",28)

"BLD",9236,"KRN",9.8,"NM","B","PSJNEWOC",25)

"BLD",9236,"KRN",9.8,"NM","B","PSJOC",5)

"BLD",9236,"KRN",9.8,"NM","B","PSJOCDI",6)

"BLD",9236,"KRN",9.8,"NM","B","PSJOCDSD",29)

"BLD",9236,"KRN",9.8,"NM","B","PSJOCDT",7)

"BLD",9236,"KRN",9.8,"NM","B","PSJOCOR",36)

"BLD",9236,"KRN",9.8,"NM","B","PSJOE",21)

"BLD",9236,"KRN",9.8,"NM","B","PSJOE1",40)

"BLD",9236,"KRN",9.8,"NM","B","PSJOEA2",44)

"BLD",9236,"KRN",9.8,"NM","B","PSJRXI",8)

"BLD",9236,"KRN",19,0)
19
"BLD",9236,"KRN",19,"NM",0)
^9.68A^^
"BLD",9236,"KRN",19.1,0)
19.1
"BLD",9236,"KRN",101,0)
101
"BLD",9236,"KRN",101,"NM",0)
^9.68A^1^1
"BLD",9236,"KRN",101,"NM",1,0)
PSJ DISPLAY DRUG ALLERGIES^^0
"BLD",9236,"KRN",101,"NM","B","PSJ DISPLAY DRUG ALLERGIES",1)

"BLD",9236,"KRN",409.61,0)
409.61
"BLD",9236,"KRN",771,0)
771
"BLD",9236,"KRN",779.2,0)
779.2
"BLD",9236,"KRN",870,0)
870
"BLD",9236,"KRN",8989.51,0)
8989.51
"BLD",9236,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",9236,"KRN",8989.52,0)
8989.52
"BLD",9236,"KRN",8994,0)
8994
"BLD",9236,"KRN","B",.4,.4)

"BLD",9236,"KRN","B",.401,.401)

"BLD",9236,"KRN","B",.402,.402)

"BLD",9236,"KRN","B",.403,.403)

"BLD",9236,"KRN","B",.5,.5)

"BLD",9236,"KRN","B",.84,.84)

"BLD",9236,"KRN","B",3.6,3.6)

"BLD",9236,"KRN","B",3.8,3.8)

"BLD",9236,"KRN","B",9.2,9.2)

"BLD",9236,"KRN","B",9.8,9.8)

"BLD",9236,"KRN","B",19,19)

"BLD",9236,"KRN","B",19.1,19.1)

"BLD",9236,"KRN","B",101,101)

"BLD",9236,"KRN","B",409.61,409.61)

"BLD",9236,"KRN","B",771,771)

"BLD",9236,"KRN","B",779.2,779.2)

"BLD",9236,"KRN","B",870,870)

"BLD",9236,"KRN","B",8989.51,8989.51)

"BLD",9236,"KRN","B",8989.52,8989.52)

"BLD",9236,"KRN","B",8994,8994)

"BLD",9236,"QUES",0)
^9.62^^
"BLD",9236,"REQB",0)
^9.611^10^9
"BLD",9236,"REQB",1,0)
PSJ*5.0*160^2
"BLD",9236,"REQB",2,0)
PSJ*5.0*199^2
"BLD",9236,"REQB",4,0)
PSJ*5.0*286^2
"BLD",9236,"REQB",5,0)
PSJ*5.0*299^2
"BLD",9236,"REQB",6,0)
PSJ*5.0*305^2
"BLD",9236,"REQB",7,0)
PSJ*5.0*309^2
"BLD",9236,"REQB",8,0)
PSS*1.0*175^2
"BLD",9236,"REQB",9,0)
PSJ*5.0*320^2
"BLD",9236,"REQB",10,0)
PSJ*5.0*254^2
"BLD",9236,"REQB","B","PSJ*5.0*160",1)

"BLD",9236,"REQB","B","PSJ*5.0*199",2)

"BLD",9236,"REQB","B","PSJ*5.0*254",10)

"BLD",9236,"REQB","B","PSJ*5.0*286",4)

"BLD",9236,"REQB","B","PSJ*5.0*299",5)

"BLD",9236,"REQB","B","PSJ*5.0*305",6)

"BLD",9236,"REQB","B","PSJ*5.0*309",7)

"BLD",9236,"REQB","B","PSJ*5.0*320",9)

"BLD",9236,"REQB","B","PSS*1.0*175",8)

"KRN",101,5993,-1)
0^1
"KRN",101,5993,0)
PSJ DISPLAY DRUG ALLERGIES^Display Drug Allergies^^A^^^^^^^^INPATIENT MEDICATIONS
"KRN",101,5993,1,0)
^101.06^1^1^3120123^^
"KRN",101,5993,1,1,0)
displays signs/symptoms of an allergy associated to a med order.
"KRN",101,5993,2,0)
^101.02A^1^1
"KRN",101,5993,2,1,0)
DA
"KRN",101,5993,2,"B","DA",1)

"KRN",101,5993,15)
S VALMBCK="R"
"KRN",101,5993,20)
D ^PSJDGAL2
"KRN",101,5993,99)
63663,50963
"MBREQ")
1
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
281^3160204^10000000070
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
43
"RTN","PSGOD")
0^38^B24552546
"RTN","PSGOD",1,0)
PSGOD ;BIR/CML3-CREATES NEW ORDER FROM OLD ONE ;22 SEP 97 / 2:56 PM 
"RTN","PSGOD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**67,58,111,133,181,286,281**;16 DEC 97;Build 113
"RTN","PSGOD",3,0)
 ;
"RTN","PSGOD",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGOD",5,0)
 ;
"RTN","PSGOD",6,0)
 ;*286 - Do not allow copied Unit Dose orders for outpatients
"RTN","PSGOD",7,0)
 D INP^VADPT I 'VAIN(4) W !,"You cannot copy Unit Dose orders for this patient!" H 2 Q
"RTN","PSGOD",8,0)
 I $P($G(^PS(55,PSGP,5,+PSJORD,0)),"^",22) D  Q
"RTN","PSGOD",9,0)
 .W !,"This order is marked 'Not To Be Given' and can't be copied!" H 2
"RTN","PSGOD",10,0)
 F  W !!,"Do you want to copy this order" S %=2 D YN^DICN Q:%  D CH
"RTN","PSGOD",11,0)
 G:%'=1 DONE
"RTN","PSGOD",12,0)
 ;
"RTN","PSGOD",13,0)
 W !!,"...copying..." N OLDON
"RTN","PSGOD",14,0)
 K PSGORQF
"RTN","PSGOD",15,0)
 N PSGPDRG,Q
"RTN","PSGOD",16,0)
 S PSGOEPR=$P($G(^PS(55,PSGP,5.1)),"^",2),OLDON=PSGORD,Q=""
"RTN","PSGOD",17,0)
 ;K PSGODN S F=$S((PSGORD["N")!(PSGORD["P"):"^PS(53.1,"_+PSGORD_",",1:"^PS(55,"_PSGP_",5,"_+PSGORD_",") F N=0,.2,2,6 S PSGODN(N)=$G(@(F_N_")"))
"RTN","PSGOD",18,0)
 K PSGODN S F=$S(PSGORD["P":"^PS(53.1,"_+PSGORD_",",1:"^PS(55,"_PSGP_",5,"_+PSGORD_",") F N=0,.2,2,6 S PSGODN(N)=$G(@(F_N_")"))
"RTN","PSGOD",19,0)
 S PSGPR=$P(PSGODN(0),"^",2),PSGMR=$P(PSGODN(0),"^",3),PSGSM=$P(PSGODN(0),"^",5),PSGHSM=$P(PSGODN(0),"^",6),PSGST=$P(PSGODN(0),"^",7)
"RTN","PSGOD",20,0)
 S PSGPDRG=+PSGODN(.2),PSGDO=$P(PSGODN(.2),"^",2)
"RTN","PSGOD",21,0)
 S PSGSI=PSGODN(6)
"RTN","PSGOD",22,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(55,PSGP,5,+PSGORD, or ^PS(55,PSGP,"IV",+PSGORD, or ^PS(53.1,+PSGORD
"RTN","PSGOD",23,0)
 S PSGODN(3)=0 F Q=0:0 S Q=$O(@(F_"3,"_Q_")")) Q:'Q  I $D(^(Q,0)) S PSGODN(3,Q)=^(0),PSGODN(3)=PSGODN(3)+1 S ^PS(53.45,PSJSYSP,1,Q,0)=^(0)
"RTN","PSGOD",24,0)
 ;S:PSGODN(12)>0 ^PS(53.45,PSJSYSP,4,0)="^53.4504" S:PSGODN(3)>0 ^PS(53.45,PSJSYSP,1,0)="^53.4501"
"RTN","PSGOD",25,0)
 S:PSGODN(3)>0 ^PS(53.45,PSJSYSP,1,0)="^53.4501"
"RTN","PSGOD",26,0)
 ; The naked reference below refers to the full reference inside indirection to ^PS(55,PSGP,5,+PSGORD, or ^PS(55,PSGP,"IV",+PSGORD, or ^PS(53.1,+PSGORD  
"RTN","PSGOD",27,0)
 S (PSGODN(1),Q)=0 F  S Q=$O(@(F_"1,"_Q_")")) Q:'Q  S ND=$G(^(Q,0)) I ND,'$P(ND,"^",3) S PSGODN(1)=PSGODN(1)+1,PSGODN(1,PSGODN(1))=$P(ND,"^",1,2) S ^PS(53.45,PSJSYSP,2,PSGODN(1),0)=^(0)
"RTN","PSGOD",28,0)
 S PSGS0Y=$P(PSGODN(2),"^",5),PSGS0XT=$P(PSGODN(2),"^",6),PSGNESD="",PSGSCH=$P(PSGODN(2),U)
"RTN","PSGOD",29,0)
 S PSGODF=1,PSGNEDFD=$P($$GTNEDFD^PSGOE7("U",+PSGPDRG),U)_"^^"_PSGST_"^"_PSGSCH
"RTN","PSGOD",30,0)
 W "." D ^PSGNE3
"RTN","PSGOD",31,0)
 K PSGEFN,PSGOEEF,PSGOEE,PSGOEOS S PSGEFN="1:13" F X=1:1:13 S PSGEFN(X)=""
"RTN","PSGOD",32,0)
 S PSGPDN=$$OINAME^PSJLMUTL(PSGPDRG),PSGOINST="",PSGSDN=$$ENDD^PSGMI(PSGNESD)_U_$$ENDTC^PSGMI(PSGNESD),PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD)
"RTN","PSGOD",33,0)
 S PSGAT=PSGS0Y,PSGEBN=DUZ,PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT),PSGEBN=$$ENNPN^PSGMI(DUZ),PSGSTAT=$S(PSGOEAV:"ACTIVE",1:"NON-VERIFIED")
"RTN","PSGOD",34,0)
 W "." D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSGOD",35,0)
 I $G(PSGSCH)]"" D
"RTN","PSGOD",36,0)
 .N X S X=PSGSCH N SWD,SDW,XABB,QX D ENOS^PSGS0 I $G(X)=""!$G(PSJNSS) S CHK=1 K PSJNSS Q
"RTN","PSGOD",37,0)
 .I $G(PSGAT)="",$G(PSGS0Y) S PSGAT=PSGS0Y
"RTN","PSGOD",38,0)
 .I $G(PSGAT),($G(PSGS0Y)="") S PSGS0Y=PSGAT
"RTN","PSGOD",39,0)
 .I $G(PSGS0XT)="D",$G(PSGS0Y)="" S CHK=1 D  K PSJNSS
"RTN","PSGOD",40,0)
 ..W ! K DIR S DIR(0)="FOA",DIR("A")="   WARNING - Admin times are required for DAY OF WEEK schedules    " D ^DIR K DIR
"RTN","PSGOD",41,0)
 S PSGSD=PSGNESD,PSGFD=PSGNEFD
"RTN","PSGOD",42,0)
 K PSJACEPT S VALMBCK="Q" D:$D(Y) EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOD",43,0)
 I $G(PSJACEPT)=1 D OC S:$D(PSGORQF) PSJACEPT=0 S:$G(PSJACEPT)=1 VALMBCK="",PSJNOO=$$ENNOO^PSJUTL5("N")
"RTN","PSGOD",44,0)
 I '$G(PSJACEPT)!($G(PSJNOO)<0) W:'$G(PSJCOFLG) !!,"Order not copied." D PAUSE^VALM1:'$G(PSJCOFLG) G ORIG    ;PSJCOFLG set in PSODGAL1 for allergies
"RTN","PSGOD",45,0)
 S PSGNESD=PSGSD,PSGNEFD=PSGFD
"RTN","PSGOD",46,0)
 K PSGOEE D ^PSGOETO S PSJORD=PSGORD I PSGOEAV D
"RTN","PSGOD",47,0)
 .I '$D(PSGOEE),+PSJSYSU=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOD",48,0)
 .D SETOC^PSJNEWOC(PSGORD) ;RTC 178789 Store allergy if auto vf is on
"RTN","PSGOD",49,0)
 D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD),^PSGOE1,EN^VALM("PSJ LM UD ACTION")
"RTN","PSGOD",50,0)
 ;RTC 178789 - store allery if not verified the newly copied order
"RTN","PSGOD",51,0)
 I ($G(PSGORD)["P"),($P($G(^PS(53.1,+PSGORD,0)),U,9)="N"),($G(PSJOCFG)="COPY UD") D SETOC^PSJNEWOC(PSGORD)
"RTN","PSGOD",52,0)
 ;
"RTN","PSGOD",53,0)
 S PSGCANFL=0,(PSGORD,PSJORD)=OLDON W !!,"You are finished with the new order.",!,"The following ACTION prompt is for the original order."
"RTN","PSGOD",54,0)
 K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOD",55,0)
ORIG ;Redisplay original order
"RTN","PSGOD",56,0)
 D GETUD^PSJLMGUD(PSGP,OLDON),INIT^PSJLMUDE(PSGP,OLDON)
"RTN","PSGOD",57,0)
DONE ;
"RTN","PSGOD",58,0)
 K %,%H,%I,DA,F,N,PSGODN,PSGODF,PSGS0XT,PSGS0Y,PSGNESD,PSGTOL,PSGTOO,PSGUOW,X,Y,^PS(53.45,PSJSYSP,1),^PS(53.45,PSJSYSP,2)
"RTN","PSGOD",59,0)
 K PSGPR,PSGMR,PSGSM,PSGHSM,PSGST,PSGPDRG,PSGDO,PSGNEDFD,PSGSCH,PSGNEFD
"RTN","PSGOD",60,0)
 Q
"RTN","PSGOD",61,0)
 ;
"RTN","PSGOD",62,0)
CH ;
"RTN","PSGOD",63,0)
 W !!?2,"Answer 'YES' to have a new, non-verified order created for this patient,",!,"using the information from this order.  (The START and STOP dates will be",!,"recalculated.)  Enter 'NO' (or '^') to stop now." Q
"RTN","PSGOD",64,0)
 ;
"RTN","PSGOD",65,0)
WH ;
"RTN","PSGOD",66,0)
 W !!?2,"Answer 'YES' to take action on this new order.  Enter 'NO' (or '^') to return",!,"to the original order now." Q
"RTN","PSGOD",67,0)
 ;
"RTN","PSGOD",68,0)
OC ;Perform order checks
"RTN","PSGOD",69,0)
 NEW PSJDD,X,PSJALLGY
"RTN","PSGOD",70,0)
 ;*286 - Order checks on current dispense drugs
"RTN","PSGOD",71,0)
 F X=0:0 S X=$O(^PS(53.45,PSJSYSP,2,X)) Q:'X  D
"RTN","PSGOD",72,0)
 . S PSJDD=$G(^PS(53.45,PSJSYSP,2,X,0))
"RTN","PSGOD",73,0)
 . I +PSJDD S PSJALLGY(+PSJDD)=""
"RTN","PSGOD",74,0)
 ;S X=+$O(PSGODN(1,0)) Q:'X  S PSJDD=+$G(PSGODN(1,X)) Q:'PSJDD
"RTN","PSGOD",75,0)
 S PSJDD=+$O(PSJALLGY(0)) Q:'PSJDD
"RTN","PSGOD",76,0)
 D FULL^VALM1
"RTN","PSGOD",77,0)
 D ENDDC^PSGSICHK($G(PSGP),PSJDD) Q:$D(PSGORQF)
"RTN","PSGOD",78,0)
 D IN^PSJOCDS($G(PSGORD),"UD",PSJDD)
"RTN","PSGOD",79,0)
 Q
"RTN","PSGOE7")
0^9^B30726260
"RTN","PSGOE7",1,0)
PSGOE7 ;BIR/CML3 - SELECT DRUG ;15 MAY 00 1:43 PM
"RTN","PSGOE7",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**9,26,34,52,55,50,87,111,181,254,267,260,288,281**;16 DEC 97;Build 113
"RTN","PSGOE7",3,0)
 ;
"RTN","PSGOE7",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180
"RTN","PSGOE7",5,0)
 ; Reference to ^PS(59.7 is supported by DBIA 2181
"RTN","PSGOE7",6,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192
"RTN","PSGOE7",7,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSGOE7",8,0)
 ;
"RTN","PSGOE7",9,0)
 ; NFI-UD chgs for FR#: 1
"RTN","PSGOE7",10,0)
 ; 
"RTN","PSGOE7",11,0)
 ;S PSGDICS="U"_$S($D(PSJOERR):",I",1:"")
"RTN","PSGOE7",12,0)
 S PSGDICS="U"
"RTN","PSGOE7",13,0)
 ;
"RTN","PSGOE7",14,0)
AD ; Ask Drug
"RTN","PSGOE7",15,0)
 K PSJDOSE,PSJDOX ;var array use in ^PSJDOSE
"RTN","PSGOE7",16,0)
 K PSGODO,^TMP("PSJINTER",$J) D KILL^PSJBCMA5(+$G(PSJSYSP))
"RTN","PSGOE7",17,0)
 K DIC S DIC="^PS(50.7,",DIC(0)="EMQZVT",D="B^C" I '$P(PSJSYSU,";",4) S DIC("S")="I $$ENOISC^PSJUTL(Y,""U"")"
"RTN","PSGOE7",18,0)
 E  D
"RTN","PSGOE7",19,0)
 .I '$D(PSJDGCK) S DIC("T")="",DIC="^PSDRUG(",DIC("S")="I +$G(^PSDRUG(+Y,2)),$P($G(^PSDRUG(+Y,2)),""^"",3)[""U"" S X(1)=+$G(^(""I"")) I $S('X(1):1,1:X(1)>DT)",D="B^C^VAPN^VAC^NDC^XATC"
"RTN","PSGOE7",20,0)
 .I $D(PSJDGCK) S DIC("T")="",DIC="^PSDRUG(",DIC("S")="I +$G(^PSDRUG(+Y,2)),$$GCN^PSGOE7(+Y),$$PKGFLG^PSGOE7($P($G(^PSDRUG(+Y,2)),""^"",3)) S X(1)=+$G(^(""I"")) I $S('X(1):1,1:X(1)>DT)",D="B^C^VAPN^VAC^NDC^XATC"
"RTN","PSGOE7",21,0)
 ;
"RTN","PSGOE7",22,0)
AD1 ;
"RTN","PSGOE7",23,0)
 K PSGORD,PSJORD,PSJALLGY,PSGUSRX,^TMP("PSJINTER",$J),^PS(53.45,+$G(PSJSYSP),5),^PS(53.45,+$G(PSJSYSP),6)
"RTN","PSGOE7",24,0)
 K ^TMP("PSODAOC",$J)
"RTN","PSGOE7",25,0)
 S PSGORQF=0 R !!,"Select DRUG: ",X:DTIME I '$T W $C(7) S X="^"
"RTN","PSGOE7",26,0)
 ; -- save off value of X in PSGUSRX so variable can be reliable checked at DO tag
"RTN","PSGOE7",27,0)
 S PSGUSRX=X
"RTN","PSGOE7",28,0)
 I $D(PSJDGCK) I ($G(PSJOCNT)'>1&(X="")) D  Q
"RTN","PSGOE7",29,0)
 .W !!,"Not enough active profile drugs to perform drug check",!
"RTN","PSGOE7",30,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSGOE7",31,0)
 I $D(PSJDGCK),X="" N PSGDGCKF S PSGDGCKF=1 G DGCKX
"RTN","PSGOE7",32,0)
 I ("^"[X)!(X="") S PSGORQF=1 G DONE
"RTN","PSGOE7",33,0)
 G:X?1"S."1.E DONE
"RTN","PSGOE7",34,0)
 I X?1."?" W !!?2,"Select the medication you wish the patient to receive." W:PSJSYSU<3 "  You should consult",!,"with your pharmacy before ordering any non-formulary medication." W !
"RTN","PSGOE7",35,0)
 D MIX^DIC1 G:X?1."?" AD1 G:"^"[X!(Y'>0) AD1 S (PSGDO,PSGDRG,PSGDRGN,PSGNEDFD,PSGPDRG,PSGPDRGN)=""
"RTN","PSGOE7",36,0)
 I $D(PSJDGCK) I $$PSJSUPCK^PSJDGCK(+Y) G AD1
"RTN","PSGOE7",37,0)
DGCKX I $P(PSJSYSU,";",4) D  G DO
"RTN","PSGOE7",38,0)
 .S:'$D(PSJDGCK) PSGDRG=+Y,PSGDRGN=Y(0,0)
"RTN","PSGOE7",39,0)
 .S:$D(PSJDGCK)&'$D(PSGDGCKF) PSGDRG=+Y,PSGDRGN=Y(0,0)
"RTN","PSGOE7",40,0)
 .S:$D(PSJDGCK)&$D(PSGDGCKF) PSGDRG=$P($$DGCKIEN^PSJDGCK(),";",2),PSGDRGN=$P($G(^PSDRUG(PSGDRG,0)),U)
"RTN","PSGOE7",41,0)
 .D DIN^PSJDIN(+$G(^PSDRUG(PSGDRG,2)),PSGDRG)
"RTN","PSGOE7",42,0)
 .I '$D(PSJDGCK) I $P(Y(0),"^",9) D NF S:Y>0 PSGDRG=+Y(0),PSGDRGN=Y(0,0) D SNFM
"RTN","PSGOE7",43,0)
 .I $D(PSJDGCK)&'$D(PSGDGCKF) I $P(Y(0),"^",9) D NF S:Y>0 PSGDRG=+Y(0),PSGDRGN=Y(0,0) D SNFM
"RTN","PSGOE7",44,0)
 .S PSGPDRG=+$G(^PSDRUG(PSGDRG,2)),PSGPDRGN=$$OINAME^PSJLMUTL(PSGPDRG)
"RTN","PSGOE7",45,0)
 I '$D(PSJDGCK) S PSGPDRG=+Y,PSGPDRGN=$$OINAME^PSJLMUTL(PSGPDRG)
"RTN","PSGOE7",46,0)
 I $D(PSJDGCK)&'$D(PSGDGCKF) S PSGPDRG=+Y,PSGPDRGN=$$OINAME^PSJLMUTL(PSGPDRG)
"RTN","PSGOE7",47,0)
 ;F Q=1:1:$L(PSGDICS) S X=$P(PSGDICS,",",Q) Q:X=""  S PSJLUAPP=$O(^PS(50.3,PSGPDRG,1,"B",X,0)) I PSJLUAPP S X=$G(^PS(50.3,PSGPDRG,1,PSJLUAPP,0)) Q
"RTN","PSGOE7",48,0)
 S X=$O(^PSDRUG("ASP",PSGPDRG,0)) I X,'$O(^(X)) S PSGDRG=X,PSGDRGN=$$ENDDN^PSGMI(X)
"RTN","PSGOE7",49,0)
 ;
"RTN","PSGOE7",50,0)
DO ; dosage ordered
"RTN","PSGOE7",51,0)
 NEW PSJALLGY
"RTN","PSGOE7",52,0)
 S PSGNEDFD=$$GTNEDFD("U",PSGPDRG)
"RTN","PSGOE7",53,0)
 ; -- if PSGDGCKF is set, CK action is being used and no DRUG was entered, do not set PSJALLGY array
"RTN","PSGOE7",54,0)
 I $G(PSGDRG),$P(PSJSYSU,";",4) S:'$G(PSGDGCKF) PSJALLGY(PSGDRG)=$S($G(PSGUSRX)=""&($G(PSGDRG)):"",1:"P") D ENDDC^PSGSICHK(PSGP,PSGDRG) G:$G(PSGORQF) AD
"RTN","PSGOE7",55,0)
 I '$P(PSJSYSU,";",4) S PSGX=PSGPDRG D END^PSGSICHK G:Y<0 AD
"RTN","PSGOE7",56,0)
 S PSGDO=""
"RTN","PSGOE7",57,0)
 ;
"RTN","PSGOE7",58,0)
DONE ;
"RTN","PSGOE7",59,0)
 K DIC,%,%Y,PSGDICS,PSJLUAPP,Q1,Q2,Q3,Z,PSJALLGY,PSGUSRX Q
"RTN","PSGOE7",60,0)
 ;
"RTN","PSGOE7",61,0)
 ;
"RTN","PSGOE7",62,0)
NF ;
"RTN","PSGOE7",63,0)
 S Y=0 W $C(7),!!,"PLEASE NOTE: The selected item is not currently on your medical center's",!?13,"formulary." Q:'$P(PSJSYSU,";",2)
"RTN","PSGOE7",64,0)
 N CNT S CNT=0 F Q1=0:0 S Q1=$O(^PSDRUG(PSGDRG,65,Q1)) Q:'Q1  I $$CHKDRG(+$G(^(Q1,0))) S CNT=CNT+1
"RTN","PSGOE7",65,0)
 I CNT=0 W !!,"There are no formulary alternatives entered for this item." W:PSJSYSU>2 "  You should consult",!,"with your pharmacy before ordering this item." S Y=0 Q
"RTN","PSGOE7",66,0)
 I CNT=1 S Q1=$O(^PSDRUG(PSGDRG,65,0)),Q1=+$G(^(Q1,0)),Q3=$P(^PSDRUG(Q1,0),"^") W !!,Q3," has been entered as a formulary " W:$X>67 ! W "alternative."
"RTN","PSGOE7",67,0)
 I  F Q=1:1 S %=2 W !!,"Is ",$S(Q=1:"this",1:Q3)," acceptable" D YN^DICN Q:%  D NFOH
"RTN","PSGOE7",68,0)
 I CNT=1 S:%=1 (Y(0),Y)=Q1,Y(0,0)=Q3 S:%<0 Y=-1 Q
"RTN","PSGOE7",69,0)
 K DA,DIC S DA(1)=PSGDRG,DIC="^PSDRUG("_PSGDRG_",65,",DIC(0)="AEMQZ",DIC("A")="Select FORMULARY ALTERNATIVE: " W ! D ^DIC K DIC Q
"RTN","PSGOE7",70,0)
 ;
"RTN","PSGOE7",71,0)
NFOH ;
"RTN","PSGOE7",72,0)
 S X="Answer 'YES' to order this formulary alternative ("_Q3_") for the patient instead of the non-formulary item originally selected.  Answer 'NO' to use the drug originally selected."
"RTN","PSGOE7",73,0)
 W !!?2 F Y=1:1:$L(X," ") S Z=$P(X," ",Y) W:$L(Z)+$X+2>IOM ! W Z," "
"RTN","PSGOE7",74,0)
 Q
"RTN","PSGOE7",75,0)
CHKDRG(DRG) ; Determine if dispense drug is valid for Unit Dose.
"RTN","PSGOE7",76,0)
 I $D(^PSDRUG(DRG,0)),$P($G(^(2)),U,3)["U" S X=+$G(^("I")) I 'X!(X>DT) Q DRG
"RTN","PSGOE7",77,0)
 Q 0
"RTN","PSGOE7",78,0)
 ;
"RTN","PSGOE7",79,0)
SNFM ; show non-formulary message
"RTN","PSGOE7",80,0)
 S Y=1 Q:PSJSYSU=3!'$O(^PS(59.7,1,21,0))  W $C(7),! S Q=0 F  S Q=$O(^PS(59.7,1,21,Q)) Q:'Q  W !,$G(^(Q,0))
"RTN","PSGOE7",81,0)
 W ! D READ^PSJUTL S Y=1 Q
"RTN","PSGOE7",82,0)
 ;
"RTN","PSGOE7",83,0)
GTNEDFD(APP,PDRG) ; Find defaults from Orderable Item.
"RTN","PSGOE7",84,0)
 Q $P($G(^PS(50.7,+PDRG,0)),"^",5,8)
"RTN","PSGOE7",85,0)
 N Q,X S X=""
"RTN","PSGOE7",86,0)
 F Q=1:1:$L(APP) S X=$E(APP,Q) Q:X=""  S X=$O(^PS(50.3,+PDRG,1,"B",X,0)) I X S X=$P($G(^PS(50.3,+PDRG,1,X,0)),"^",5,8) Q
"RTN","PSGOE7",87,0)
 Q X
"RTN","PSGOE7",88,0)
 ;
"RTN","PSGOE7",89,0)
PKGFLG(PKF) ;Return 0 for not in range of acceptable package flags, 1 for within range
"RTN","PSGOE7",90,0)
 I $S(PKF["U":1,1:0) Q 1
"RTN","PSGOE7",91,0)
 I $S(PKF["I":1,1:0) Q 1
"RTN","PSGOE7",92,0)
 Q 0
"RTN","PSGOE7",93,0)
 ;
"RTN","PSGOE7",94,0)
GCN(PSGIENID) ;Return 0 for not matched, 1 for matched with no GCNSEQNO, 1^1 for matched with a GCNSEQNO
"RTN","PSGOE7",95,0)
 N PSGNDFID,PSGGCNPT,PSGGCNID
"RTN","PSGOE7",96,0)
 S PSGNDFID=$P($G(^PSDRUG(PSGIENID,"ND")),"^"),PSGGCNPT=$P($G(^PSDRUG(PSGIENID,"ND")),"^",3)
"RTN","PSGOE7",97,0)
 I 'PSGNDFID!('PSGGCNPT) Q 0
"RTN","PSGOE7",98,0)
 S PSGGCNID=$$PROD0^PSNAPIS(PSGNDFID,PSGGCNPT)
"RTN","PSGOE7",99,0)
 I $P(PSGGCNID,"^",7) Q PSGIENID_";"_PSGNDFID_";"_$P(PSGGCNID,"^",7)
"RTN","PSGOE7",100,0)
 Q PSGIENID_";"_PSGNDFID
"RTN","PSGOEE")
0^1^B101870372
"RTN","PSGOEE",1,0)
PSGOEE ;BIR/CML3 - EDIT ACTIVE OR NON-VERIFIED ORDERS ;8/12/10 5:59pm
"RTN","PSGOEE",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**4,7,29,47,64,58,82,91,110,111,112,142,179,181,254,267,268,281**;16 DEC 97;Build 113
"RTN","PSGOEE",3,0)
 ;
"RTN","PSGOEE",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSGOEE",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA# 2789.
"RTN","PSGOEE",6,0)
 ; Reference to ^TMP("PSODAOC",$J is supported by DBIA# 6071.
"RTN","PSGOEE",7,0)
 ;
"RTN","PSGOEE",8,0)
 D NOW^%DTC S PSGDT=% K PSGEFN,PSGOEEF S PSGOEEF=0 I PSGORD["A"!(PSGORD["O") G ACT
"RTN","PSGOEE",9,0)
531 ; edit orders in 53.1
"RTN","PSGOEE",10,0)
ENF ; Entry point
"RTN","PSGOEE",11,0)
 D EN2^PSGOEEW
"RTN","PSGOEE",12,0)
 K PSJACEPT D EDLOOP G:'$G(PSJACEPT) OUT
"RTN","PSGOEE",13,0)
 I $G(PSGOEENO) D
"RTN","PSGOEE",14,0)
 . N PSGOEENO S PSGOEENO=1 D NEW
"RTN","PSGOEE",15,0)
 E  D
"RTN","PSGOEE",16,0)
 . N PSGOEENO S PSGOEENO=0 D UPD
"RTN","PSGOEE",17,0)
 I $G(PSGOEAV) D ACT1 Q
"RTN","PSGOEE",18,0)
 D DONE1
"RTN","PSGOEE",19,0)
 S PSGOEEF=0,PSJORD=PSGORD D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD)
"RTN","PSGOEE",20,0)
 Q
"RTN","PSGOEE",21,0)
ACT ; Perform Edit
"RTN","PSGOEE",22,0)
 NEW PSJALGY1
"RTN","PSGOEE",23,0)
 K PSGOEER
"RTN","PSGOEE",24,0)
 D EN2^PSGOEEW,EDLOOP G:'$G(PSJACEPT) OUT
"RTN","PSGOEE",25,0)
 I $G(PSGOEENO) D
"RTN","PSGOEE",26,0)
 . N PSGOEENO S PSGOEENO=1 D NEW
"RTN","PSGOEE",27,0)
 E  D
"RTN","PSGOEE",28,0)
 . N PSGOEENO S PSGOEENO=0 D UPD
"RTN","PSGOEE",29,0)
 S:$D(PSGOEF)!$G(PSGOEENO) PSGCANFL=-1
"RTN","PSGOEE",30,0)
ACT1 ; Continue editing
"RTN","PSGOEE",31,0)
 D DONE1
"RTN","PSGOEE",32,0)
 S PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD) D:PSGOEAV UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSGOEE",33,0)
 Q
"RTN","PSGOEE",34,0)
EDIT ; Edit
"RTN","PSGOEE",35,0)
 I $G(Y) D ASKOVR(Y,$G(PSGORD),.PSJSTARI)
"RTN","PSGOEE",36,0)
 D FULL^VALM1
"RTN","PSGOEE",37,0)
 W ! S PSGOEER="" F Q=1:1 S Q1=$P(Y,",",Q) Q:'Q1  S X=$P($T(@(PSGOEEG_Q1)),";",3),PSGOEER=PSGOEER_X_";",PSGOEEF(+X)=Q S:Q1=1 PSJALGY1=1
"RTN","PSGOEE",38,0)
 S LIMIT=$L(PSGOEER,";")-1,(PSGDEF,PSGOEE)=0 F  S PSGOEE=PSGOEE+1 Q:PSGOEE>LIMIT  I +$P(PSGOEER,";",PSGOEE)=101 S PSGDEF=1
"RTN","PSGOEE",39,0)
 S PSGOEER=$E(PSGOEER,1,$L(PSGOEER)-1),(MSG,PSGOEE)=0 F  S PSGOEE=PSGOEE+1 Q:PSGOEE>$L(PSGOEER,";")  S F1=$S(PSGOEEG=3:53.1,1:55.06) I 'PSGDEF!((PSGDEF)&(+$P(PSGOEER,";",PSGOEE)'=2)) D @$P(PSGOEER,";",PSGOEE) Q:'PSGOEE
"RTN","PSGOEE",40,0)
 Q
"RTN","PSGOEE",41,0)
EDLOOP ; Continue prompting for fields to edit.
"RTN","PSGOEE",42,0)
 K PSJNOO
"RTN","PSGOEE",43,0)
 D:$G(Y) EDIT
"RTN","PSGOEE",44,0)
 D ENNOU^PSGOEE0 I '$G(PSGOEENO),DR="" S VALMBCK="R" Q
"RTN","PSGOEE",45,0)
 K VALMSG
"RTN","PSGOEE",46,0)
 I '$G(PSGOEENO),$G(PSGPDNX) D CKDT
"RTN","PSGOEE",47,0)
 I $G(PSGOEENO) D
"RTN","PSGOEE",48,0)
 .S VALMSG="This change will cause a new order to be created." D GTSTATUS,CHKDD,CKDT
"RTN","PSGOEE",49,0)
 .S PSGEBN=$$ENNPN^PSGMI(DUZ),PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT)
"RTN","PSGOEE",50,0)
 D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGSD_"^^"_PSGFD)
"RTN","PSGOEE",51,0)
 K VALMBCK,PSJACEPT,PSGPDNX D EN^VALM("PSJU LM ACCEPT") Q:'$G(PSJACEPT)
"RTN","PSGOEE",52,0)
 I $G(PSGS0XT)="D",'$G(PSGS0Y) I ((",P,R,")'[(","_$G(PSGST)_",")) D  Q
"RTN","PSGOEE",53,0)
 .S PSJACEPT=0 W !!,"This is a 'DAY OF THE WEEK' schedule and MUST have admin times." D PAUSE^VALM1
"RTN","PSGOEE",54,0)
 I ($G(PSGOEER)["26^PSGOE9")!($G(PSGOEER)["26^PSGOE8")!($G(PSGOEER)["109^PSGOE9")!($G(PSGOEER)["109^PSGOE8")!($G(PSGOEER)["3^PSGOE9")!($G(PSGOEER)["3^PSGOE8")!($G(PSGOEER)["101^PSGOE9")!($G(PSGOEER)["101^PSGOE8") S PSGOEENO=1
"RTN","PSGOEE",55,0)
 I $G(PSGOEENO)!($G(PSGOEER)["2^PSGOE92")!($G(PSGOEER)["2^PSGOE82") D OC S:($G(PSGOEER)["2^PSGOE82") PSJDSVFY=1
"RTN","PSGOEE",56,0)
 I $G(PSGORQF) S PSJNOO=-1
"RTN","PSGOEE",57,0)
 I '$G(PSJNOO),$G(PSGOEENO) S PSJNOO=$$ENNOO^PSJUTL5("E")
"RTN","PSGOEE",58,0)
 D K1 S PSJACEPT=$S($G(PSJNOO)<0:0,1:1)
"RTN","PSGOEE",59,0)
 S VALMBCK=$S('PSJACEPT:"R",'PSGOEAV:"R",1:"Q")
"RTN","PSGOEE",60,0)
 Q
"RTN","PSGOEE",61,0)
OC ;Perform OC (only when OI or Dosage was edited) & dosing check
"RTN","PSGOEE",62,0)
 NEW PSJDD,PSJALLGY
"RTN","PSGOEE",63,0)
 K PSGORQF
"RTN","PSGOEE",64,0)
 D FULL^VALM1
"RTN","PSGOEE",65,0)
 S PSJDD=+$$DD53P45^PSJMISC() I 'PSJDD S PSGORQF=1 Q
"RTN","PSGOEE",66,0)
 I $G(PSJALGY1)!$G(PSGOEENO) D
"RTN","PSGOEE",67,0)
 . D ENDDC^PSGSICHK(PSGP,PSJDD)
"RTN","PSGOEE",68,0)
 D:'$G(PSGORQF) IN^PSJOCDS($G(PSGORD),"UD",PSJDD)
"RTN","PSGOEE",69,0)
 Q
"RTN","PSGOEE",70,0)
CHKDD ;*** Check inactive Dispense drug within the order.
"RTN","PSGOEE",71,0)
 D CHKDRG^PSGOE2
"RTN","PSGOEE",72,0)
 Q
"RTN","PSGOEE",73,0)
CKDT ; Check if new start/stop dates should be calculated.
"RTN","PSGOEE",74,0)
 S PSGS0Y=$S($D(PSGS0Y):PSGS0Y,1:$G(PSGAT))
"RTN","PSGOEE",75,0)
 ;PSJ*5*179 Recalc start date if Before last given
"RTN","PSGOEE",76,0)
 I ($P($G(PSBSTR),"^")>PSGSD)!('$G(PSGNEWDT)&(PSGSD=$G(PSGOSD))&(PSGFD=$G(PSGOFD)))!($G(PSGOST)'=PSGST)!(PSGSCH'=$G(PSGOSCH))!($G(PSGPDNX)) D
"RTN","PSGOEE",77,0)
 .N PSGOES S PSGOES=1,PSGOFD=PSGFD D ^PSGNE3 I $G(PSGOFD) S PSGNEFD=PSGFD
"RTN","PSGOEE",78,0)
 .S PSGSD=PSGNESD,PSGSDN=$$ENDD^PSGMI(PSGNESD)_U_$$ENDTC^PSGMI(PSGNESD),PSGFD=PSGNEFD,PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD),PSGNEWDT=1
"RTN","PSGOEE",79,0)
 .I $D(PSGOFD),PSGOFD]"",PSGFD'=PSGOFD S PSGOEEF(25)=1
"RTN","PSGOEE",80,0)
 .I $D(PSGOSD),PSGOSD]"",PSGSD'=PSGOSD S PSGOEEF(10)=1
"RTN","PSGOEE",81,0)
 ;BHW;PSJ*5*179;Add EFD call here, removed from PSGOE91
"RTN","PSGOEE",82,0)
 D EFDACT^PSJUTL
"RTN","PSGOEE",83,0)
 Q
"RTN","PSGOEE",84,0)
NEW3 ;
"RTN","PSGOEE",85,0)
 ;S:PSGOEAV PSGOEAV="0^1"
"RTN","PSGOEE",86,0)
NEW ;
"RTN","PSGOEE",87,0)
 I $D(^PS(53.45,+$G(PSJSYSP),5)) N PSJFSI S PSJFSI=1 D FILESI^PSJBCMA5(DFN,PSGORD) N SIARRAY S SIARRAY="" D
"RTN","PSGOEE",88,0)
 .I PSGORD["P" M SIARRAY=^PS(53.1,+PSGORD,15) D NEWNVAL^PSGAL5(PSGORD,6000,"SPECIAL INSTRUCTIONS",,.SIARRAY)
"RTN","PSGOEE",89,0)
 .I PSGORD["U" M SIARRAY=^PS(55,DFN,5,+PSGORD,15) D NEWUDAL^PSGAL5(PSGORD,6000,"SPECIAL INSTRUCTIONS",,.SIARRAY)
"RTN","PSGOEE",90,0)
 W !,"...discontinuing original order..."
"RTN","PSGOEE",91,0)
 I PSGORD["P" S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8) I PSJCOM D NEW^PSJCOM1 Q
"RTN","PSGOEE",92,0)
 ;DC and Unlock order.
"RTN","PSGOEE",93,0)
 S PSGEDIT="DE" D ENOR^PSGOECS,UNL^PSSLOCK(PSGP,PSGORD) K PSGEDIT
"RTN","PSGOEE",94,0)
 W !!," ...creating new order..." W:'PSGOEAV "(you will now work on this new order)"
"RTN","PSGOEE",95,0)
 S PSGS0Y=PSGAT,PSGNESD=PSGSD,PSGNEFD=PSGFD,PSGOEPR=PSGPR,PSGPDRG=PSGPD,PSGPDRGN=PSGPDN,PSGOEE="E"
"RTN","PSGOEE",96,0)
 S PSGOORD=PSGORD D ^PSGOETO K PSGOEOS
"RTN","PSGOEE",97,0)
 I PSGOORD["U" S $P(^PS(55,PSGP,5,+PSGOORD,0),"^",26,27)=PSGORD_"^E"
"RTN","PSGOEE",98,0)
 E  S $P(^PS(53.1,+PSGOORD,0),"^",26,27)=PSGORD_"^E"
"RTN","PSGOEE",99,0)
 I $G(PSJFSI) I $$GETSI^PSJBCMA5(DFN,PSGOORD) D FILESI^PSJBCMA5(DFN,PSGORD)
"RTN","PSGOEE",100,0)
 I 'PSGOEAV,($G(PSGORD)["P"),'$G(^PS(53.1,+PSGORD,2.5)),$G(^PS(53.1,+PSGORD,0)) D
"RTN","PSGOEE",101,0)
 . N DUR S DUR=$$GETDUR^PSJLIVMD(PSGP,PSGORD,$S(PSGORD["P":"P",1:5),1) I DUR]"" K DA,DR,DIE S DIE="^PS(53.1,",DA=+PSGORD,DR="116////"_DUR D ^DIE
"RTN","PSGOEE",102,0)
 I PSGOEAV D
"RTN","PSGOEE",103,0)
 . S ^TMP("PSODAOC",$J,"IP IEN")=PSGORD
"RTN","PSGOEE",104,0)
 . D SETOC^PSJNEWOC(PSGORD) ;PSJ*5*281 stores order checks
"RTN","PSGOEE",105,0)
 I PSGOEAV,+PSJSYSU=3,'$D(PSGOES) D EN^PSGPEN(PSGORD),UNL^PSSLOCK(PSGP,PSGORD) Q
"RTN","PSGOEE",106,0)
 S PSJORD=PSGORD,PSGACT=$$ENACTION^PSGOE1(PSGP,PSGORD)
"RTN","PSGOEE",107,0)
 ;K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSGOEE",108,0)
 Q
"RTN","PSGOEE",109,0)
UPD ;
"RTN","PSGOEE",110,0)
 K DA W !!,"...updating order..."
"RTN","PSGOEE",111,0)
 I PSGORD["P" S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8) I PSJCOM D UPD^PSJCOM Q
"RTN","PSGOEE",112,0)
 I $$DIFFSI^PSJBCMA5(DFN,PSGORD) D
"RTN","PSGOEE",113,0)
 .N SIARRAY M:PSGORD["P" SIARRAY=^PS(53.1,+PSGORD,15) M:PSGORD["U" SIARRAY=^PS(55,DFN,5,+PSGORD,15)
"RTN","PSGOEE",114,0)
 .Q:'$D(SIARRAY)
"RTN","PSGOEE",115,0)
 .I PSGORD["P" D NEWNVAL^PSGAL5(PSGORD,6000,"SPECIAL INSTRUCTIONS",,.SIARRAY)
"RTN","PSGOEE",116,0)
 .I PSGORD["U" D NEWUDAL^PSGAL5(DFN,PSGORD,6000,"SPECIAL INSTRUCTIONS",,.SIARRAY)
"RTN","PSGOEE",117,0)
 ; Set trigger for FIELD (12) Dispense Drug to print a updated pick list.
"RTN","PSGOEE",118,0)
 I PSGORD["U",$D(^PS(53.45,PSJSYSP,2,1,0)),$D(^PS(55,PSGP,5,+PSGORD,1,1,0)) D
"RTN","PSGOEE",119,0)
 .N PSJX12,PSJF12 S PSJF12=0
"RTN","PSGOEE",120,0)
 .F PSJX12=0:1 S PSJX12=$O(^PS(53.45,PSJSYSP,2,PSJX12)) Q:+PSJX12=0  S:$G(^PS(53.45,PSJSYSP,2,PSJX12,0))'=$G(^PS(55,PSGP,5,+PSGORD,1,PSJX12,0)) PSJF12=1
"RTN","PSGOEE",121,0)
 .S:PSJF12 ^PS(55,"AUE",PSGP,+PSGORD)=""
"RTN","PSGOEE",122,0)
 N TMP,PSGSIF S TMP=PSGOEENO N PSGOEENO S PSGOEENO=TMP
"RTN","PSGOEE",123,0)
 N II F II=1:1:$L($G(DR),";") I $E($P($G(DR),";",II),1,7)="122////" S PSGSIF=$P(PSGSI,"^",2),PSGSI=$P(PSGSI,"^") Q
"RTN","PSGOEE",124,0)
 I $G(PSJCOM),$G(PSJCOMSI) K PSJCOMSI,^TMP("PSGSI",$J) M ^TMP("PSGSI",$J,5)=^PS(53.45,PSJSYSP,5) D
"RTN","PSGOEE",125,0)
 .D FILESI^PSJBCMA5(DFN,PSGORD)
"RTN","PSGOEE",126,0)
 .N PSJCHILD,PSJOEORD S PSJOEORD=0 F  S PSJOEORD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD)) Q:'PSJOEORD  D
"RTN","PSGOEE",127,0)
 .. S PSJCHILD=0 F  S PSJCHILD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD,PSJCHILD)) Q:'PSJCHILD  D
"RTN","PSGOEE",128,0)
 ... Q:PSJCHILD=PSGORD  N DR,DA,DIE,ORD S DR=$S(PSJCHILD["V":"31////"_$G(P("OPI")),1:"8////"_$G(PSGSI)) S DR=DR_";"_$S(PSJCHILD["V":146,1:122)_"////"_+$G(PSGSIF)
"RTN","PSGOEE",129,0)
 ... I '$D(^PS(53.45,+$G(PSJSYSP),5)) M ^PS(53.45,+$G(PSJSYSP),5)=^TMP("PSGSI",$J,5)
"RTN","PSGOEE",130,0)
 ... D FILESI^PSJBCMA5(DFN,PSJCHILD)
"RTN","PSGOEE",131,0)
 ... ;PSJ*5*179 Comment edits
"RTN","PSGOEE",132,0)
 ... S DR=$TR(DR,"*") I DR'="" S DA=+PSJCHILD,DIE=$S(PSJCHILD["U":"^PS(55,"_PSGP_",5,",1:"^PS(53.1,") S:DIE["^PS(55," DA(1)=PSGP D ^DIE W "." D EN1^PSJHL2(PSGP,"XX",+PSJCHILD_"U")
"RTN","PSGOEE",133,0)
 . K ^TMP("PSGSI",$J)
"RTN","PSGOEE",134,0)
 S DR=$TR(DR,"*") I DR'="" S DA=+PSGORD,DIE=$S(PSGORD["U":"^PS(55,"_PSGP_",5,",1:"^PS(53.1,") S:DIE["^PS(55," DA(1)=PSGP D ^DIE W "."
"RTN","PSGOEE",135,0)
 F Q=1,3 K @(PSGOEEWF_Q_")") S %X="^PS(53.45,"_PSJSYSP_","_$S(Q=1:2,1:1)_",",%Y=PSGOEEWF_Q_"," K @(PSGOEEWF_Q_")") D %XY^%RCR W "."
"RTN","PSGOEE",136,0)
 S $P(@(PSGOEEWF_"1,0)"),"^",2)=$S(PSGORD["U":55.07,1:53.11)_"P"
"RTN","PSGOEE",137,0)
 I $D(^PS(53.45,+$G(PSJSYSP),5)) D FILESI^PSJBCMA5(DFN,PSJORD)
"RTN","PSGOEE",138,0)
 ; Naked reference on the line below refers to full reference using indirection to either ^PS(55 or ^PS(53.1,
"RTN","PSGOEE",139,0)
 S ND=$G(@($S(PSGORD["U":"^PS(55,"_PSGP_",5,",1:"^PS(53.1,")_+PSGORD_",0)")) I $P(ND,"^",21) S ORIFN=$P(ND,"^",21),ND1=$G(^(.2)),ND2=$G(^(2)) W !,"...updating OE/RR..." D EN1^PSJHL2(PSGP,"XX",PSGORD)
"RTN","PSGOEE",140,0)
 I $$ENACTION^PSGOE1(PSGP,PSGORD)["V" S VALMBCK="R"
"RTN","PSGOEE",141,0)
 I PSJSYSL,PSJSYSL<3 S $P(@($S(PSGORD["U":"^PS(55,"_PSGP_",5,",1:"^PS(53.1,")_+PSGORD_",7)"),"^",1,2)=PSGDT_"^"_$E("D",PSGOEENO)_"E",PSGTOL=2,PSGUOW=DUZ,PSGTOO=PSGORD'["U"+1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOEE",142,0)
 ; **This is where the Automated Dispensing Machine hook is called. Do NOT DELETE or change this location **
"RTN","PSGOEE",143,0)
 D EDIT^PSJADM
"RTN","PSGOEE",144,0)
 ; **END of Interface Hook **
"RTN","PSGOEE",145,0)
 Q
"RTN","PSGOEE",146,0)
OUT ;
"RTN","PSGOEE",147,0)
 D ABORT K PSGNEWDT S PSGCANFL=1 D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD),INIT^PSJLMUDE(PSGP,PSGORD)
"RTN","PSGOEE",148,0)
 Q
"RTN","PSGOEE",149,0)
DONE ;
"RTN","PSGOEE",150,0)
 I PSGORD["P",'$D(PSGOEF),PSGSCH]"",$O(^PS(53.1,+PSGORD,1,0)) D ENF^PSGOEE0
"RTN","PSGOEE",151,0)
DONE1 ;
"RTN","PSGOEE",152,0)
 I PSGORD["U" S X=+PSGORD L -^PS(55,PSGP,5,X)
"RTN","PSGOEE",153,0)
 E  L -^PS(53.1,+PSGORD)
"RTN","PSGOEE",154,0)
 K ^PS(53.45,+PSJSYSP,1),^(2),^(5),^(6)
"RTN","PSGOEE",155,0)
 I '$D(PSGOEF) K PSGSD,PSGSCH,PSGST,PSGFD
"RTN","PSGOEE",156,0)
 K DA,DIE,DIR,DP,DR,DRG,ND,ND0,ND1,ND2,ORIFN,PSGAL,PSGALEF,PSGAT,PSGOEE,PSGOEEF,PSGOEEG,PSGOEEWF,PSGEFN,PSGTOL,PSGTOO,PSGUOW,XREF,PSGEFN,PSGMR,PSGMRN,PSGOROE1,PSGPD,PSGPDN,PSGSI,PSGPR,PSGSM,PSGHSM,PSGSTN,PSGSDN,PSGFDN,PSGPRN
"RTN","PSGOEE",157,0)
 K PSGDO,PSGOEENO Q
"RTN","PSGOEE",158,0)
K1 ;
"RTN","PSGOEE",159,0)
 K BACK,F1,F2,PSGF2,MSG,PSGEFN,PSGNEWDT,PSGOEEND,PSGOPD,PSGOPDN,PSGOMR,PSGOMRN,PSGOSCH,PSGOSI,PSGOPR,PSGOSM,PSGOHSM,PSGOSD,PSGOFD,PSGOST,PSGOPRN,PSGOSTN,PSGOSDN,PSGOFDN,PSGODO,PSGPDRG,PSGPDRGN,PSGOEER
"RTN","PSGOEE",160,0)
 Q
"RTN","PSGOEE",161,0)
 ;
"RTN","PSGOEE",162,0)
ABORT ; Display no change message and pause.
"RTN","PSGOEE",163,0)
 D FULL^VALM1
"RTN","PSGOEE",164,0)
 S (PSGDI,PSGDFLG)='$$DDOK^PSGOE2(PSGOEEWF_"1,",+$G(@(PSGOEEWF_".2)")))
"RTN","PSGOEE",165,0)
 S PSGPFLG='$$OIOK^PSGOE2(+$G(@(PSGOEEWF_".2)")))
"RTN","PSGOEE",166,0)
 I '$G(PSJRNFLG) W !!,$C(7),"No changes made to this order." D PAUSE^VALM1  ;if flag set in PSODGAL1, no repeat message
"RTN","PSGOEE",167,0)
 K PSGOEEF S PSGOEEF=0
"RTN","PSGOEE",168,0)
 Q
"RTN","PSGOEE",169,0)
 ;
"RTN","PSGOEE",170,0)
GTSTATUS ; Determine status of new order and set LM title.
"RTN","PSGOEE",171,0)
 S PSGSTAT=$S($P($G(PSJSYSP0),U,9):"ACTIVE",1:"NON-VERIFIED")
"RTN","PSGOEE",172,0)
 S VALM("TITLE")=PSGSTAT_" UNIT DOSE "_$S(PSGSTAT="PENDING":"("_PSGPRIO_")",1:"")
"RTN","PSGOEE",173,0)
 Q
"RTN","PSGOEE",174,0)
 ;
"RTN","PSGOEE",175,0)
ASKOVR(Y,PSJOVRON,PSJSTARI)  ; Check to see if any starred fields are being edited. If so, ask if they wish to view overrides/interventions if they exist
"RTN","PSGOEE",176,0)
 Q:'$D(Y)!$D(PSJSTARI)  N II,I3,YY S YY=$S(Y:Y,1:$TR($P(Y,"^",4),"="))
"RTN","PSGOEE",177,0)
 Q:'YY  S PSJOVRON=$S($G(PSJOVRON):PSJOVRON,1:$G(PSJORD)) Q:'$G(PSJOVRON)
"RTN","PSGOEE",178,0)
 N PSJORD S PSJORD=PSJOVRON
"RTN","PSGOEE",179,0)
 I '$G(PSJSTARI) F II=1:1:$L(YY,",") Q:$G(PSJSTARI)  S I3=$P(YY,",",II) I I3 S:$G(PSGEFN(I3))!($G(PSJSTAR)[("("_I3_")")) PSJSTARI=1
"RTN","PSGOEE",180,0)
 I $G(PSJSTARI) I ($G(PSJORD)&$G(PSGP)) I $$ASKDISP^PSGSICH1 D FULL^VALM1 D OVRDISP^PSGSICH2(PSGP,PSJORD,3)
"RTN","PSGOEE",181,0)
 Q
"RTN","PSGOEE",182,0)
 ;
"RTN","PSGOEE",183,0)
FIELDS ;
"RTN","PSGOEE",184,0)
31 ;;101^PSGOE8;PSGOPD;PSGPD;101;1
"RTN","PSGOEE",185,0)
32 ;;109^PSGOE8;PSGODO;PSGDO;109;PSGODO]""
"RTN","PSGOEE",186,0)
33 ;;10^PSGOE81;PSGOSD;PSGSD;10;0
"RTN","PSGOEE",187,0)
34 ;;3^PSGOE8;PSGOMR;PSGMR;3;1
"RTN","PSGOEE",188,0)
35 ;;25^PSGOE81;PSGOFD;PSGFD;25;0
"RTN","PSGOEE",189,0)
36 ;;7^PSGOE8;PSGOST;PSGST;7;0
"RTN","PSGOEE",190,0)
37 ;;5^PSGOE82;PSGOSM;PSGSM;5;0
"RTN","PSGOEE",191,0)
38 ;;26^PSGOE8;PSGOSCH;PSGSCH;26;1
"RTN","PSGOEE",192,0)
39 ;;39^PSGOE81;PSGOAT;PSGAT;39;0
"RTN","PSGOEE",193,0)
310 ;;1^PSGOE82;PSGOPR;PSGPR;1;1
"RTN","PSGOEE",194,0)
311 ;;8^PSGOE81;PSGOSI;PSGSI;8;0
"RTN","PSGOEE",195,0)
312 ;;2^PSGOE82;;;2;0
"RTN","PSGOEE",196,0)
313 ;;40^PSGOE82;;;40;0
"RTN","PSGOEE",197,0)
51 ;;101^PSGOE9;PSGOPD;PSGPD;101;1
"RTN","PSGOEE",198,0)
52 ;;109^PSGOE9;PSGODO;PSGDO;109;PSGODO]""
"RTN","PSGOEE",199,0)
53 ;;10^PSGOE91;PSGOSD;PSGSD;10;1
"RTN","PSGOEE",200,0)
54 ;;3^PSGOE9;PSGOMR;PSGMR;3;1
"RTN","PSGOEE",201,0)
55 ;;34^PSGOE91;PSGOFD;PSGFD;34;1 
"RTN","PSGOEE",202,0)
56 ;;7^PSGOE9;PSGOST;PSGST;7;0
"RTN","PSGOEE",203,0)
57 ;;5^PSGOE92;PSGOSM;PSGSM;5;0
"RTN","PSGOEE",204,0)
58 ;;26^PSGOE9;PSGOSCH;PSGSCH;26;1
"RTN","PSGOEE",205,0)
59 ;;41^PSGOE91;PSGOAT;PSGAT;41;0
"RTN","PSGOEE",206,0)
510 ;;1^PSGOE92;PSGOPR;PSGPR;1;1
"RTN","PSGOEE",207,0)
511 ;;8^PSGOE91;PSGOSI;PSGSI;8;0
"RTN","PSGOEE",208,0)
512 ;;2^PSGOE92;;;2;0
"RTN","PSGOEE",209,0)
513 ;;15^PSGOE92;;;15;0
"RTN","PSGOEF")
0^26^B103709466
"RTN","PSGOEF",1,0)
PSGOEF ;BIR/CML3 - FINISH ORDERS ENTERED THROUGH OE/RR ;14 May 98  2:17 PM
"RTN","PSGOEF",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**7,30,29,35,39,47,50,56,80,116,110,111,133,153,134,222,113,181,260,199,281**;16 DEC 97;Build 113
"RTN","PSGOEF",3,0)
 ;
"RTN","PSGOEF",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSGOEF",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192
"RTN","PSGOEF",6,0)
 ; Reference to DOSE^PSSORPH is supported by DBIA 3234.
"RTN","PSGOEF",7,0)
 ; Reference to ^TMP("PSODAOC",$J is supported by DBIA 6071.
"RTN","PSGOEF",8,0)
 ; Reference to FULL^VALM1 is supported by DBIA 10116.
"RTN","PSGOEF",9,0)
 ;
"RTN","PSGOEF",10,0)
START ;
"RTN","PSGOEF",11,0)
 I '$D(^PS(53.1,+PSGORD)) W $C(7),!?3,"Cannot find this pending order (#",+PSGORD,")." Q
"RTN","PSGOEF",12,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12) K PSGFDX,PSGEFN,PSGOEEF,PSGOES,PSGONF,PSGRDTX S PSGOES=1,(PSGOEF,PSGOEEF)=0,PSGOEEG=3
"RTN","PSGOEF",13,0)
 I $D(PSJTUD) S PSGDO=$P($G(^PS(53.1,+PSGORD,.3)),U),(PSGPDRG,PSGPD)=PSJCOI,(PSGPDRGN,PSGPDN)=$$OINAME^PSJLMUTL(PSGPD)
"RTN","PSGOEF",14,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S X=PSGSCH D EN^PSGORS0 D
"RTN","PSGOEF",15,0)
 . S:($D(X)&($P($G(^PS(53.1,+PSGORD,2)),"^",5)="")&($P($G(^PS(53.1,+PSGORD,0)),"^",24)="N")) PSGAT=PSGS0Y
"RTN","PSGOEF",16,0)
 . NEW PSJDOX,PSJDOSE,PSJPIECE,PSJUNIT,PSJX,X
"RTN","PSGOEF",17,0)
 . S X=$G(^PS(53.1,+PSGORD,1,1,0)) Q:'+X
"RTN","PSGOEF",18,0)
 . D DOSE^PSSORPH(.PSJDOX,+X,"U")
"RTN","PSGOEF",19,0)
 . I $S('$D(PSJDOX):1,1:+PSJDOX(1)=-1) Q
"RTN","PSGOEF",20,0)
 . S PSJPIECE=$S($P(PSJDOX(1),U)="":3,1:1)
"RTN","PSGOEF",21,0)
 . S X=^PS(53.1,+PSGORD,.2)
"RTN","PSGOEF",22,0)
 . S:PSJPIECE=3 PSJDOSE=$P(X,U,2)
"RTN","PSGOEF",23,0)
 . S:PSJPIECE=1 PSJDOSE=$P(X,U,5),PSJUNIT=$P(X,U,6)
"RTN","PSGOEF",24,0)
 . F X=0:0 S X=$O(PSJDOX(X)) Q:+$G(PSJX)!'X  D
"RTN","PSGOEF",25,0)
 .. I PSJPIECE=3,($P(PSJDOX(X),U,3)'=PSJDOSE) Q
"RTN","PSGOEF",26,0)
 .. I PSJPIECE=1,($P(PSJDOX(X),U,1)_$P(PSJDOX(X),U,2)'=(PSJDOSE_PSJUNIT)) Q
"RTN","PSGOEF",27,0)
 .. S:+$P(PSJDOX(X),U,12) $P(^PS(53.45,PSJSYSP,2,1,0),U,2)=+$P(PSJDOX(X),U,12),PSJX=1
"RTN","PSGOEF",28,0)
 I PSGEB'=PSGOPR F X=7,11 S Y=$T(@(3_X)),@("PSGEFN("_X_")="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))="",PSGOEEF=PSGOEEF+1
"RTN","PSGOEF",29,0)
 D GTST^PSGOE6(+PSGORD)
"RTN","PSGOEF",30,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S PSGSD="" D:PSGS0Y]""
"RTN","PSGOEF",31,0)
 .N PSJX S PSJX=$P($G(^PS(53.1,+PSGORD,0)),U,25) I PSJX="" Q
"RTN","PSGOEF",32,0)
 .I PSJX["U" S PSGSD=$P($G(^PS(55,DFN,5,+PSJX,2)),U,2) Q
"RTN","PSGOEF",33,0)
 .I PSJX["V" S PSGSD=$P($G(^PS(55,DFN,"IV",+PSJX,0)),U,2) Q
"RTN","PSGOEF",34,0)
 .I PSJX["P" S PSGSD=$P($G(^PS(53.1,+PSJX,2)),U,2)
"RTN","PSGOEF",35,0)
 S:PSGSD="" PSGSD=PSGLI
"RTN","PSGOEF",36,0)
 S PSGNEDFD=$$GTNEDFD^PSGOE7("U",+PSGPD)
"RTN","PSGOEF",37,0)
 S:$P($G(PSGNEDFD),U,3)="" $P(PSGNEDFD,U,3)=PSGST  ; N PSGOEA S PSGOEA="R"
"RTN","PSGOEF",38,0)
 S (PSGNESD,PSGSD)=$$ENSD^PSGNE3(PSGSCH,PSGS0Y,PSGLI,PSGSD)
"RTN","PSGOEF",39,0)
 ;if this is a renewal order, ignore any 'requested start date' received.  Use the system calculated start date.
"RTN","PSGOEF",40,0)
 I $P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" D
"RTN","PSGOEF",41,0)
 . D REQDT^PSJLIVMD(PSGORD)
"RTN","PSGOEF",42,0)
 E  D
"RTN","PSGOEF",43,0)
 . S X=$$DSTART^PSJDCU(DFN,$P(^PS(53.1,+PSGORD,0),U,25)) I X]"" S (PSGNESD,PSGSD)=X K PSGRSD
"RTN","PSGOEF",44,0)
 D   ; Extend the Default Stop Date if needed for the first renewed order.
"RTN","PSGOEF",45,0)
 .N PSGOEAO,PSGWALLO
"RTN","PSGOEF",46,0)
 .I $P($G(^PS(53.1,+PSGORD,0)),U,24)="R" S PSGOEAO=PSGOEA,PSGOEA="R",PSGWALLO=$P(^PS(55,DFN,5.1),U)
"RTN","PSGOEF",47,0)
 .D ENFD^PSGNE3(PSGLI) S PSGFD=$S($G(PSGRDTX(+PSGORD,"PSGFD")):PSGRDTX(+PSGORD,"PSGFD"),1:PSGNEFD)
"RTN","PSGOEF",48,0)
 .I $P($G(^PS(53.1,+PSGORD,0)),U,24)="R" S PSGOEA=PSGOEAO,$P(^PS(55,DFN,5.1),U)=PSGWALLO
"RTN","PSGOEF",49,0)
 N DUR,PSGRNSD S PSGRNSD=+$$LASTREN^PSJLMPRI(DFN,PSGORD) I PSGRNSD S DUR=$$GETDUR^PSJLIVMD(DFN,PSGORD,"P",1) I DUR]"" D
"RTN","PSGOEF",50,0)
 . N DURMIN S DURMIN=$$DURMIN^PSJLIVMD(DUR) I DURMIN S PSGFD=$$FMADD^XLFDT(PSGRNSD,,,DURMIN)
"RTN","PSGOEF",51,0)
 S PSGOFD="",PSGSDN=$$ENDD^PSGMI(PSGSD)_U_$$ENDTC^PSGMI(PSGSD),PSGFDN=$$ENDD^PSGMI(PSGFD)_U_$$ENDTC^PSGMI(PSGFD)
"RTN","PSGOEF",52,0)
 S PSGLIN=$$ENDD^PSGMI(PSGLI)_U_$$ENDTC^PSGMI(PSGLI)
"RTN","PSGOEF",53,0)
 I '$O(^PS(53.45,PSJSYSP,2,0)) N DRG,DRGCNT S DRGCNT=0 D
"RTN","PSGOEF",54,0)
 .F X=0:0 S X=$O(^PSDRUG("ASP",+PSGPD,X)) Q:'X!(DRGCNT>1)  S:$P($G(^PSDRUG(+X,2)),U,3)["U" DRGCNT=DRGCNT+1,DRG=+X
"RTN","PSGOEF",55,0)
 .I DRGCNT=1 K ^PS(53.45,PSJSYSP,2) S ^PS(53.45,PSJSYSP,2,1,0)=DRG_U_1,^PS(53.45,PSJSYSP,2,0)="^53.4502^1^1",PS(53.45,PSJSYSP,2,"B",+DRG,1)=""
"RTN","PSGOEF",56,0)
 Q
"RTN","PSGOEF",57,0)
FINISH ;
"RTN","PSGOEF",58,0)
 ; force display of second screen if CPRS order checks exist
"RTN","PSGOEF",59,0)
 N NSFF,PSGOEF39,PSGEDTOI S NSFF=1 K PSJNSS,PSGEDTOI,PSGOEER,ZZND
"RTN","PSGOEF",60,0)
 I $G(PSGORD),$D(PSGRDTX(+PSGORD)) D  K PSGRDTX
"RTN","PSGOEF",61,0)
 . ;PSJOCDSC stores the default start & stop date ^ cal start & stop date (use in dosing calculation for duration)
"RTN","PSGOEF",62,0)
 . ;for some reasons PSGSD & PSGFD are reset to the cal dates if order has duration defined
"RTN","PSGOEF",63,0)
 . S PSJOCDSC("CX","PSGSD",+PSGORD)=$G(PSGSD)_U_$G(PSGRDTX(+PSGORD,"PSGRSD"))
"RTN","PSGOEF",64,0)
 . S PSJOCDSC("CX","PSGFD",+PSGORD)=$G(PSGFD)_U_$G(PSGRDTX(+PSGORD,"PSGRFD"))
"RTN","PSGOEF",65,0)
 . S:$G(PSGRDTX(+PSGORD,"PSGRSD")) PSGSD=PSGRDTX(+PSGORD,"PSGRSD")
"RTN","PSGOEF",66,0)
 . S:$G(PSGRDTX(+PSGORD,"PSGRFD")) PSGFD=$S($G(PSGRDTX(+PSGORD,"PSGRFD")):PSGRDTX(+PSGORD,"PSGRFD"),1:$G(PSGNEFD))
"RTN","PSGOEF",67,0)
 N PSJCOM S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8)
"RTN","PSGOEF",68,0)
 ; 
"RTN","PSGOEF",69,0)
 ; PSJ*5*222
"RTN","PSGOEF",70,0)
 ; PSJCT1 is a counter variable.  Every piece of a complex order calls PSGOEF.
"RTN","PSGOEF",71,0)
 ; The only time this code is to look for overlapping admin times is when the
"RTN","PSGOEF",72,0)
 ; first part of a complex order is being finished.  This variable will keep track
"RTN","PSGOEF",73,0)
 ; of how many "parts" of the complex order have been checked.
"RTN","PSGOEF",74,0)
 ; 
"RTN","PSGOEF",75,0)
 ; Also, since the user can select multiple complex orders to finish, like selecting
"RTN","PSGOEF",76,0)
 ; orders 1-2 or 1-3 from the profile, PSJCT1A will keep track of whether the parent
"RTN","PSGOEF",77,0)
 ; order number is the same as the first parent order number selected for finishing.
"RTN","PSGOEF",78,0)
 ; Since the PSJCT1 counter variable will still be set if multiple complex orders
"RTN","PSGOEF",79,0)
 ; are selected, PSJCT1 will be re-set to 1 if the parent complex order number (PSJCT1A) is
"RTN","PSGOEF",80,0)
 ; not equal to the original parent order number (PSJCOM).
"RTN","PSGOEF",81,0)
 ; 
"RTN","PSGOEF",82,0)
 S PSJCT1=$G(PSJCT1)+1
"RTN","PSGOEF",83,0)
 I PSJCT1=1 S PSJCT1A=PSJCOM
"RTN","PSGOEF",84,0)
 I $G(PSJCT1A)'=PSJCOM S PSJCT1=1,PSJCT1A=PSJCOM
"RTN","PSGOEF",85,0)
 ; End of flag setting for PSJ*5*222
"RTN","PSGOEF",86,0)
 ;PRE UAT group requested to not show the second screen since FDB OC has more text and provider override reason appears after 2nd screen 
"RTN","PSGOEF",87,0)
 ;I $O(^PS(53.1,+PSGORD,12,0))!$O(^PS(53.1,+PSGORD,10,0)) D
"RTN","PSGOEF",88,0)
 ;.Q:$G(PSJLMX)=1  ; there's no second screen to display
"RTN","PSGOEF",89,0)
 ;.S VALMBG=16 D RE^VALM4,PAUSE^VALM1
"RTN","PSGOEF",90,0)
 D FULL^VALM1
"RTN","PSGOEF",91,0)
 I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSGOEF",92,0)
 I $G(PSJCOM)'="",$G(PSJCT1)=1 D
"RTN","PSGOEF",93,0)
 . D OVERLAP^PSGOEF2 I $G(PSJOVRLP)=1 D
"RTN","PSGOEF",94,0)
 . . N X,X1,DIR
"RTN","PSGOEF",95,0)
 . . W !!,"**WARNING**"
"RTN","PSGOEF",96,0)
 . . W !,"The highlighted admin times for these portions of this complex order overlap.",!!
"RTN","PSGOEF",97,0)
 . . S (X,X1)="" F  S X=$O(^TMP("PSJATOVR",$J,X)) Q:X=""  D
"RTN","PSGOEF",98,0)
 . . . S X1=$G(^TMP("PSJATOVR",$J,X))
"RTN","PSGOEF",99,0)
 . . . W $S($P(X1,"^",4)=1:IORVON,1:""),"Part "_X,IORVOFF," has a schedule of "_$P(X1,"^",2)_" and admin time(s) of "
"RTN","PSGOEF",100,0)
 . . . W $S($P(X1,"^",4)=1:IORVON,1:""),$P(X1,"^",3),IORVOFF
"RTN","PSGOEF",101,0)
 . . . W !
"RTN","PSGOEF",102,0)
 . . . W $S($G(PSJOVR("CONJ",X))="A":"AND",$G(PSJOVR("CONJ",X))="T":"THEN",1:""),!
"RTN","PSGOEF",103,0)
 . . W !,"Please ensure the schedules and administration times are appropriate.",!
"RTN","PSGOEF",104,0)
 . . S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR W !
"RTN","PSGOEF",105,0)
 K ^TMP("PSJATOVR",$J)
"RTN","PSGOEF",106,0)
 I $G(PSJPROT)=3,'$D(PSJTUD),'$$ENIVUD^PSGOEF1(PSGORD) Q
"RTN","PSGOEF",107,0)
 I $G(PSGOSCH)]"" D  S:$G(PSGS0XT)'="" $P(^PS(53.1,+PSGORD,2),"^",6)=PSGS0XT
"RTN","PSGOEF",108,0)
 .N PSGOES,PSGS0Y,PSGSCH S X=PSGOSCH K:$G(PSJTUD) NSFF D ENOS^PSGS0
"RTN","PSGOEF",109,0)
 .I '($G(PSGORD)["P"&($P($G(^PS(53.1,+PSGORD,0)),"^",24)="R")) I $G(X)]""&$G(PSGS0Y) S:$G(PSGAT)="" PSGAT=PSGS0Y
"RTN","PSGOEF",110,0)
 .I $G(PSJNSS) S PSGOSCH="" K PSJNSS
"RTN","PSGOEF",111,0)
 .I $G(PSGORD)["P",$G(PSGAT),$G(PSGS0Y),($G(PSGOSCH)]"") I PSGAT'=PSGS0Y D
"RTN","PSGOEF",112,0)
 ..S PSGNSTAT=1 W $C(7),!!,"PLEASE NOTE:  This order's admin times (",PSGAT,")"
"RTN","PSGOEF",113,0)
 ..W !?13," do not match the ward times (",PSGS0Y,")"
"RTN","PSGOEF",114,0)
 ..W !?13," for this administration schedule (",PSGOSCH,")",!
"RTN","PSGOEF",115,0)
 ..S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR K DIR  W !
"RTN","PSGOEF",116,0)
 I $G(PSGS0XT)="" S $P(^PS(53.1,+PSGORD,2),"^",6)=$S($P($G(ZZND),"^",3)'="":$P(ZZND,"^",3),1:"")
"RTN","PSGOEF",117,0)
 S CHK=0 S:$P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" PSGSI=$$ENPC^PSJUTL("U",+PSJSYSP,180,PSGSI)
"RTN","PSGOEF",118,0)
 I '$G(PSJTUD),$G(PSJNSS),($G(PSGOSCH)]"") D NSSCONT^PSGS0(PSGOSCH,PSGS0XT) K PSJNSS S PSGOSCH=""
"RTN","PSGOEF",119,0)
 S PSGOEFF=PSGOSCH=""+('$O(^PS(53.45,PSJSYSP,2,0))*10)
"RTN","PSGOEF",120,0)
 I PSGOEFF S X=$S(PSGOEFF#2:" a SCHEDULE",1:"")_$S(PSGOEFF=11:" and",1:"")_$S(PSGOEFF>9:" at least one DISPENSE DRUG",1:"")
"RTN","PSGOEF",121,0)
 I 'PSGOEFF I (($G(PSGS0XT)="D")&($G(PSGAT)="")) S X=" Admin Times",PSGOEFF=1,PSGOEF39=1
"RTN","PSGOEF",122,0)
 I PSGOEFF,X]"" S X=X_" before it can be finished."
"RTN","PSGOEF",123,0)
 I PSGOEFF S CHK=1 W $C(7),!!,"PLEASE NOTE: This order must have" F Q=1:1:$L(X," ") S Y=$P(X," ",Q) W:$L(Y)+$X>78 ! W Y," "
"RTN","PSGOEF",124,0)
 I $G(PSGOEF39) S PSGOEE=0,PSGOEFF=0 D  I 'PSGOEE D REFRESH^VALM G DONE
"RTN","PSGOEF",125,0)
 .S F1=53.1,MSG=0,Y=$T(39),@("PSGFN(39)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEEF,PSGOEE)=1 W ! D @$P($T(39),";",3) S CHK=0
"RTN","PSGOEF",126,0)
 I PSGOEFF=1 S F1=53.1,MSG=0,Y=$T(38),@("PSGFN(38)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(38),";",3) S CHK=0 G:'PSGOEE DONE
"RTN","PSGOEF",127,0)
 I PSGOEFF=11 S F1=53.1,MSG=0,Y=$T(32),@("PSGFN(32)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(32),";",3) D  G:'PSGOEE DONE
"RTN","PSGOEF",128,0)
 .S F1=53.1,MSG=0,Y=$T(38),@("PSGFN(38)="_$P(Y,";",7)),PSGOEEF(+$P(Y,";",3))=1,(PSGOEE,PSGOEEF)=1 W ! D @$P($T(38),";",3) S CHK=0
"RTN","PSGOEF",129,0)
 I PSGOEFF>9 S CHK=7 D ENDRG^PSGOEF1(+PSGPD,0) I CHK D ABORTACC Q
"RTN","PSGOEF",130,0)
 I 'PSGOEFF D OC531^PSGOESF ; check every dispense drug from CPRS
"RTN","PSGOEF",131,0)
 S VALMBG=1
"RTN","PSGOEF",132,0)
 I 'PSGOEFF&($D(PSGORQF)) D RE^VALM4 Q
"RTN","PSGOEF",133,0)
 I $G(MSG) K DIR S DIR(0)="E" W !! D ^DIR
"RTN","PSGOEF",134,0)
 I PSGOEFF D:PSGST="" GTST^PSGOE6(+PSGORD)
"RTN","PSGOEF",135,0)
 S PSJLMFIN=1
"RTN","PSGOEF",136,0)
 K PSJACEPT I $O(^PS(53.1,+PSGORD,12,0)) S PSJLMP2=1
"RTN","PSGOEF",137,0)
 S PSGOEENO=0,PSGSTAT=$S($P(PSJSYSP0,U,9):"ACTIVE",1:"NON-VERIFIED")
"RTN","PSGOEF",138,0)
 NEW PSJDOSE,PSJDOX,PSJDSFLG
"RTN","PSGOEF",139,0)
 D DOSECHK^PSJDOSE
"RTN","PSGOEF",140,0)
 S:+$G(PSJDSFLG) VALMSG="Dosage Ordered & Dispense Drug are not compatible"
"RTN","PSGOEF",141,0)
 I PSGODO=PSGDO S PSGOEEF(109)=""
"RTN","PSGOEF",142,0)
 I PSGODO'=PSGDO S PSGOEENO=1,VALMSG="This change will cause a new order to be created  "
"RTN","PSGOEF",143,0)
 D EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOEF",144,0)
 I $G(PSJNSS) D  S PSGOEEF(26)="" K PSJACEPT,PSJNSS
"RTN","PSGOEF",145,0)
 .K DIR S DIR(0)="FOA",DIR("A")="Invalid Schedule" D ^DIR K DIR
"RTN","PSGOEF",146,0)
 I $G(PSGS0XT)="D",'$G(PSGS0Y),'$G(PSGAT),((",P,R,")'[(","_$G(PSGST)_",")) D  S PSGOEEF(39)="" K PSJACEPT
"RTN","PSGOEF",147,0)
 .K DIR S DIR(0)="FOA",DIR("A")="   WARNING - Admin times are required for DAY OF WEEK schedules  " D ^DIR K DIR
"RTN","PSGOEF",148,0)
 ;***PSJ*5*113
"RTN","PSGOEF",149,0)
 I $G(PSGAT)="",(PSGST="C"!(PSGST="R")) D
"RTN","PSGOEF",150,0)
 .I $G(PSGS0XT) Q:$$ODD^PSGS0(PSGS0XT)
"RTN","PSGOEF",151,0)
 .Q:$$PRNOK^PSGS0($G(PSGSCH))
"RTN","PSGOEF",152,0)
 .Q:($P($G(ZZND),"^",5)'="C")
"RTN","PSGOEF",153,0)
 .K PSJACEPT
"RTN","PSGOEF",154,0)
 .K DIR S DIR(0)="FOA",DIR("A")="  WARNING - Admin times are required for CONTINUOUS orders " D ^DIR K DIR
"RTN","PSGOEF",155,0)
 ;***
"RTN","PSGOEF",156,0)
 I '$G(PSJACEPT) D ABORTACC Q
"RTN","PSGOEF",157,0)
 I $G(PSJRNF),$G(^PS(53.1,+PSGORD,4)) D
"RTN","PSGOEF",158,0)
 . W $C(7),!!,"ACCEPTING THIS ORDER WILL CHANGE THE STATUS TO ACTIVE."
"RTN","PSGOEF",159,0)
 . S DIR(0)="Y",DIR("A")="Do you wish to make this order Active",DIR("?",1)="Enter ""N"" if you wish to exit without Activating this order,"
"RTN","PSGOEF",160,0)
 . S DIR("?")="or ""Y"" to continue with the Activation process." D ^DIR S:'Y Y=-1 K DIR
"RTN","PSGOEF",161,0)
 I $G(PSJRNF),$G(Y)=-1 S PSJACEPT=0 D ABORTACC Q
"RTN","PSGOEF",162,0)
 I $G(PSJRNF),$G(Y)=1 S PSGOEAV=1
"RTN","PSGOEF",163,0)
 I $G(PSGEDTOI) D OC^PSJOE1
"RTN","PSGOEF",164,0)
 I $S($G(PSGORQF):0,$G(PSGEDTOI):0,$G(PSGOEER)["109^PSGOE8":1,$G(PSGOEER)["3^PSGOE8":1,$G(PSGOEER)["26^PSGOE8":1,$G(PSGOEER)["10^PSGOE81":1,$G(PSGOEER)["25^PSGOE81":1,1:0) D
"RTN","PSGOEF",165,0)
 . NEW PSJDD S PSJDD=+$$DD53P45^PSJMISC()
"RTN","PSGOEF",166,0)
 . D:$G(PSJDD) IN^PSJOCDS($G(PSGORD),"UD",PSJDD)
"RTN","PSGOEF",167,0)
 I $G(PSGORQF) S PSGOEENO=0,PSJACEPT=0
"RTN","PSGOEF",168,0)
 I PSGOEENO S PSJNOO=$$ENNOO^PSJUTL5("E"),PSJACEPT=$S(PSJNOO<0:0,1:1)
"RTN","PSGOEF",169,0)
ACCEPT ;
"RTN","PSGOEF",170,0)
 N PSGUDFIN S PSGUDFIN=1
"RTN","PSGOEF",171,0)
 S VALMBCK=$S($G(PSJACEPT):"Q",1:"R")
"RTN","PSGOEF",172,0)
 I '$G(PSJACEPT) D ABORTACC Q
"RTN","PSGOEF",173,0)
 K PSGOES,PSGRSD,PSGRSDN D:PSGOEENO NEW3^PSGOEE D:'PSGOEENO UPD^PSGOEF1 I $D(PSGOEF)!PSGOEENO S PSGCANFL=-1
"RTN","PSGOEF",174,0)
 ;saves drug allergy signs/symptoms PSJ*5*260
"RTN","PSGOEF",175,0)
 I $D(^TMP("PSODAOC",$J,"ALLERGY")) D
"RTN","PSGOEF",176,0)
 .N DA,OCCDT,ORN,ORL,Z,RET,PSJDAOC
"RTN","PSGOEF",177,0)
 .S PSJDAOC="IP "_$S($G(PSGORD)["P":"Pending/Non-Verified",$G(PSGORD)["U":"Unit Dose",$G(PSGORD)["V":"IV",1:"")_" Allergy",OCCDT=$$NOW^XLFDT
"RTN","PSGOEF",178,0)
 .I PSGORD["P" S ORN=$P(^PS(53.1,+PSGORD,0),U,21)
"RTN","PSGOEF",179,0)
 .I PSGORD["U" S ORN=$P(^PS(55,DFN,5,+PSGORD,0),U,21)
"RTN","PSGOEF",180,0)
 .I PSGORD["V" S ORN=$P(^PS(55,DFN,"IV",+PSGORD,0),U,21)
"RTN","PSGOEF",181,0)
 .Q:'$G(ORN)
"RTN","PSGOEF",182,0)
 . S PSJAGYSV=1 ;use in ^PSJOE to store allergy (also clean up this var)
"RTN","PSGOEF",183,0)
 .;D SETOC^PSJNEWOC(PSGORD) ;set order checks in 100.05
"RTN","PSGOEF",184,0)
 .;K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSGOEF",185,0)
 D DONE1^PSGOEE
"RTN","PSGOEF",186,0)
 D DONE
"RTN","PSGOEF",187,0)
 Q
"RTN","PSGOEF",188,0)
BYPASS ;
"RTN","PSGOEF",189,0)
 S PSGCANFL=1
"RTN","PSGOEF",190,0)
 ;
"RTN","PSGOEF",191,0)
DONE ;
"RTN","PSGOEF",192,0)
 K CHK,DA,DIE,DR,DRG,MSG,Q1,Q2,PSGNSTAT,PSGEDTOI,PSGOEER,ZZND
"RTN","PSGOEF",193,0)
 K PSJOVR
"RTN","PSGOEF",194,0)
 Q
"RTN","PSGOEF",195,0)
ABORTACC ; Abort Accept process.
"RTN","PSGOEF",196,0)
 K PSJCT1,PSJOVR,PSJOVRLP,PSJCT1A K ^TMP("PSODAOC",$J)
"RTN","PSGOEF",197,0)
 D ABORT^PSGOEE K PSGOEEF D GETUD^PSJLMGUD(PSGP,PSGORD),^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD),INIT^PSJLMUDE(PSGP,PSGORD) S VALMBCK="R",PSGSD=PSGNESD,PSGFD=PSGNEFD Q
"RTN","PSGOEF",198,0)
 ;
"RTN","PSGOEF",199,0)
 ;
"RTN","PSGOEF",200,0)
31 ;;101^PSGOE8;PSGOPD;PSGPD;101;1
"RTN","PSGOEF",201,0)
32 ;;109^PSGOE8;PSGODO;PSGDO;109;PSGODO]""
"RTN","PSGOEF",202,0)
33 ;;10^PSGOE81;PSGOSD;PSGSD;10;0
"RTN","PSGOEF",203,0)
34 ;;3^PSGOE8;PSGOMR;PSGMR;3;1
"RTN","PSGOEF",204,0)
35 ;;25^PSGOE81;PSGOFD;PSGFD;25;0
"RTN","PSGOEF",205,0)
36 ;;7^PSGOE8;PSGOST;PSGST;7;0
"RTN","PSGOEF",206,0)
37 ;;5^PSGOE82;PSGOSM;PSGSM;5;0
"RTN","PSGOEF",207,0)
38 ;;26^PSGOE8;PSGOSCH;PSGSCH;26;1      
"RTN","PSGOEF",208,0)
39 ;;39^PSGOE81;PSGOAT;PSGAT;39;0
"RTN","PSGOEF",209,0)
310 ;;1^PSGOE82;PSGOPR;PSGPR;1;1
"RTN","PSGOEF",210,0)
311 ;;8^PSGOE81;PSGOSI;PSGSI;8;0
"RTN","PSGOEF",211,0)
312 ;;2^PSGOE82;;;2;0
"RTN","PSGOEF",212,0)
313 ;;40^PSGOE82;;;40;0
"RTN","PSGOEF",213,0)
 ;
"RTN","PSGOEF",214,0)
AH ;
"RTN","PSGOEF",215,0)
 W !!?2,"Answer 'YES' to accept this order as a NON-VERIFIED UNIT DOSE order.  Answer",!,"'NO' to edit this order now.  Enter '^' to BYPASS this order, leaving it as",!,"a PENDING INPATIENT order."
"RTN","PSGOEF",216,0)
 Q
"RTN","PSGOER")
0^27^B85734604
"RTN","PSGOER",1,0)
PSGOER ;BIR/CML3 - RENEW A SINGLE ORDER ;4/27/11 9:54am
"RTN","PSGOER",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**11,30,29,35,70,58,95,110,111,133,141,198,181,246,278,281**;16 DEC 97;Build 113
"RTN","PSGOER",3,0)
 ;
"RTN","PSGOER",4,0)
 ; Reference to ^PS(51.1 supported by DBIA 2177.
"RTN","PSGOER",5,0)
 ; Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSGOER",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789.
"RTN","PSGOER",7,0)
 ; Reference to ^PSBAPIPM is supported by DBIA 3564.
"RTN","PSGOER",8,0)
 ; Reference to ^PS(59.7 is supported by DBIA 2181.
"RTN","PSGOER",9,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGOER",10,0)
 ; Reference to ^TMP("PSODAOC",$J is supported by DBIA 6071.
"RTN","PSGOER",11,0)
 ;
"RTN","PSGOER",12,0)
 ; renew a single order
"RTN","PSGOER",13,0)
 I $G(PSJCOM) D ^PSJCOMR Q
"RTN","PSGOER",14,0)
 N PSJEXPIR S PSJEXPIR=$$EXPIRED(PSGP,PSGORD) I PSJEXPIR D  Q
"RTN","PSGOER",15,0)
 .W !!?3,"  THIS ORDER" W:PSJEXPIR'=2 " HAS BEEN INACTIVE FOR ONE OR MORE SCHEDULED",!?8," ADMINISTRATIONS AND"
"RTN","PSGOER",16,0)
 .W " CANNOT BE RENEWED!" D PAUSE^VALM1
"RTN","PSGOER",17,0)
 I $G(PSGSCH)]"",($G(PSGS0XT)="D"),($G(PSGAT)="") D  Q
"RTN","PSGOER",18,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOER",19,0)
 .Q:((",P,R,")[(","_$G(PSGST)_","))
"RTN","PSGOER",20,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!?3,"This order contains a 'DAY OF THE WEEK' schedule without admin times"
"RTN","PSGOER",21,0)
 .W !?11," and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",22,0)
 I $G(PSGSCH)]"",'$$DOW^PSIVUTL(PSGSCH),'$$PRNOK^PSGS0(PSGSCH) I '$D(^PS(51.1,"AC","PSJ",PSGSCH)) D  Q
"RTN","PSGOER",23,0)
 .W !!?3,"This order contains an invalid schedule and CANNOT be renewed!" D PAUSE^VALM1
"RTN","PSGOER",24,0)
 W !! K DIR S DIR(0)="Y",DIR("A")=$S($P(PSJSYSP0,"^",3):"RENEW THIS ORDER",1:"MARK THIS ORDER FOR RENEWAL"),DIR("B")="YES"
"RTN","PSGOER",25,0)
 S DIR("?")="Answer 'YES' to "_$S($P(PSJSYSP0,"^",3):"renew this order",1:"mark this order for renewal")_".  Answer 'NO' (or '^') to stop now." D ^DIR
"RTN","PSGOER",26,0)
 I '$D(DIRUT),Y D NEW S PSGCANFL=1 D DONE Q
"RTN","PSGOER",27,0)
 I '$D(DIRUT),PSJSYSU S PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I $P(PSGND4,"^",15),$P(PSGND4,"^",16) D UNMARK,DONE Q
"RTN","PSGOER",28,0)
 D DONE,ABORT^PSGOEE
"RTN","PSGOER",29,0)
 Q
"RTN","PSGOER",30,0)
 ;
"RTN","PSGOER",31,0)
UNMARK ;  
"RTN","PSGOER",32,0)
 W !!,"THIS ORDER HAS BEEN 'MARKED FOR RENEWAL'.",! K DIR S DIR(0)="Y",DIR("A")="DO YOU WANT TO 'UNMARK IT'",DIR("B")="NO"
"RTN","PSGOER",33,0)
 S DIR("?",1)="  Answer 'YES' to unmark this order.  Answer 'NO' (or '^') to leave the order",DIR("?")="marked.  (An answer is required.)" D ^DIR
"RTN","PSGOER",34,0)
 I 'Y D ABORT^PSGOEE G DONE
"RTN","PSGOER",35,0)
 S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=21180+PSJSYSU D ^PSGAL5 S $P(PSGND4,"^",15,17)="^^",^PS(55,PSGP,5,DA,4)=PSGND4 W "...DONE!"
"RTN","PSGOER",36,0)
 ;
"RTN","PSGOER",37,0)
DONE ;
"RTN","PSGOER",38,0)
 K %DT,DA,DIE,DIR,DR,FDSD,PSGAL,PSGALR,PSGDL,PSGDLS,PSGFD,PSGFOK,PSGND4,PSGOEE,PSGOER0,PSGOER1,PSGOER2,PSGOERDP,PSGPOSA,PSGPOSD,PSGPR,PSGPX,PSGRD,PSGSD,PSGTOL,PSGTOO,PSGUOW,PSGWLL,RF Q
"RTN","PSGOER",39,0)
 ;
"RTN","PSGOER",40,0)
NEW ; get info, write record
"RTN","PSGOER",41,0)
EXTEND ; extend stop date on renewal order
"RTN","PSGOER",42,0)
 N DUOUT,PSJABT,PSGDRG,PSJREN,PSGOREAS S PSGDRG=$P($G(^PS(55,PSGP,5,+PSGORD,1,1,0)),"^"),PSJREN=1
"RTN","PSGOER",43,0)
 I $G(PSGST)="O" N ACT S ACT=$$EN^PSBAPIPM(PSGP,PSGORD) I $P(ACT,"^",2),($P(ACT,"^",3)="G") I $P(ACT,"^",2)>$P($G(^PS(55,PSGP,5,+PSGORD,2)),"^",2) D  Q
"RTN","PSGOER",44,0)
 . W !!?5,"THIS ONE-TIME ORDER HAS ALREADY BEEN GIVEN AND CANNOT BE RENEWED",! S (DIRUT,PSGORQF)=1 D READ
"RTN","PSGOER",45,0)
 ;D OC55
"RTN","PSGOER",46,0)
 ;Q:$D(PSGORQF)  ; quit if not to continue
"RTN","PSGOER",47,0)
 D NOW^%DTC S PSGDT=%,PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I '$P(PSJSYSP0,"^",3) D MARK Q
"RTN","PSGOER",48,0)
 S PSGWLL=$S('$P(PSJSYSW0,"^",4):0,1:+$G(^PS(55,PSGP,5.1))),PSGOEE="R" K PSGOEOS
"RTN","PSGOER",49,0)
 K ^PS(53.45,PSJSYSP,1),^(2) D MOVE(3,1),MOVE(1,2)
"RTN","PSGOER",50,0)
 D DATE^PSGOER0(PSGP,PSGORD,PSGDT) I ($G(X)="^")!'$D(PSGFOK(106))!$G(DUOUT) D DONE,ABORT^PSGOEE S VALMBCK="R",COMQUIT=1 Q
"RTN","PSGOER",51,0)
 ;D OC55
"RTN","PSGOER",52,0)
 ;I $G(PSGORQF) D DONE,ABORT^PSGOEE S VALMBCK="R",COMQUIT=1 Q
"RTN","PSGOER",53,0)
SPEED ;
"RTN","PSGOER",54,0)
 I +$G(PSJSYSU)=3 D EN^PSGPEN(PSGORD)
"RTN","PSGOER",55,0)
 Q:$G(DUOUT)
"RTN","PSGOER",56,0)
 N PSGOEAV S PSGOEAV=+PSJSYSU
"RTN","PSGOER",57,0)
 W !!,"...updating order..." K DA S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=PSJSYSU*10+18000 D ^PSGAL5 W "."
"RTN","PSGOER",58,0)
 I $$LS^PSSLOCK(PSGP,PSGORD) D UPDREN(PSGORD,PSGDT,PSGOEPR,PSGOFD,PSJNOO),UPDRENOE(PSGP,PSGORD,PSGDT) D UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSGOER",59,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSGORD   ;set up which IEN will be used to store order checks
"RTN","PSGOER",60,0)
 D SETOC^PSJNEWOC(PSGORD) ;PSJ*5*281 stores order checks
"RTN","PSGOER",61,0)
 K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSGOER",62,0)
 ;
"RTN","PSGOER",63,0)
 I 'PSGOERDP,$P(PSJSYSW0,"^",4),PSGFD'<PSGWLL S $P(^PS(55,PSGP,5.1),"^")=+PSGFD
"RTN","PSGOER",64,0)
 W ".DONE!" S VALMBCK="Q" Q
"RTN","PSGOER",65,0)
 ;
"RTN","PSGOER",66,0)
MARK ;
"RTN","PSGOER",67,0)
 I $P(PSGND4,"^",15),$P(PSGND4,"^",16) W $C(7),!!?3,"...THIS ORDER IS ALREADY MARKED FOR RENEWAL!..." Q
"RTN","PSGOER",68,0)
 K DA S $P(PSGND4,"^",15,17)="1^"_DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=PSGND4,PSGAL("C")=13180,DA(1)=PSGP,DA=+PSGORD W "." D ^PSGAL5
"RTN","PSGOER",69,0)
 I $D(PSJSYSO) S PSGORD=+PSGORD_"A",PSGPOSA="R",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSGOER",70,0)
 Q
"RTN","PSGOER",71,0)
MOVE(X,Y) ; Move comments/dispense drugs from 55 to 53.45.
"RTN","PSGOER",72,0)
 S Q=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,X,Q)) Q:'Q  S ^PS(53.45,PSJSYSP,Y,Q,0)=$G(^(Q,0))
"RTN","PSGOER",73,0)
 S:Q ^PS(53.45,Y,0)="^53.450"_Y_"P^"_Q_U_Q
"RTN","PSGOER",74,0)
 Q
"RTN","PSGOER",75,0)
OC55 ;* Order checks for Speed finish and regular finish
"RTN","PSGOER",76,0)
 ;PSJ*5*181 - no longer use (OC will be triggered from OC^PSGOER0)
"RTN","PSGOER",77,0)
 Q
"RTN","PSGOER",78,0)
NEWOC55 ;
"RTN","PSGOER",79,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJPDRG,PSJDD,PSJDD0,PSJALLGY
"RTN","PSGOER",80,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSGOER",81,0)
 F PSGDDI=0:0 S PSGDDI=$O(^PS(55,PSGP,5,+PSGORD,1,PSGDDI)) Q:'+PSGDDI  D
"RTN","PSGOER",82,0)
 . S PSJDD0=$G(^PS(55,PSGP,5,+PSGORD,1,PSGDDI,0))
"RTN","PSGOER",83,0)
 . S PSJX=$P(PSJDD0,U,3) I PSJX]"",(PSJX'>$G(PSGDT)) Q
"RTN","PSGOER",84,0)
 . S PSJDD=+PSJDD0
"RTN","PSGOER",85,0)
 . S PSJX=$S('$D(^PSDRUG(+PSJDD,0)):1,$P($G(^(2)),U,3)'["U":1,$G(^("I"))="":0,1:^("I")'>$G(PSGDT))
"RTN","PSGOER",86,0)
 . Q:PSJX
"RTN","PSGOER",87,0)
 . S PSJALLGY(PSJDD)=""
"RTN","PSGOER",88,0)
 S PSJDD=$O(PSJALLGY(0))
"RTN","PSGOER",89,0)
 I '+PSJDD W !!,"No active dispense drug was found" D PAUSE^PSJLMUT1 Q
"RTN","PSGOER",90,0)
 K PSGORQF D ENDDC^PSGSICHK(PSGP,PSJDD)
"RTN","PSGOER",91,0)
 D:'$G(PSGORQF) IN^PSJOCDS(PSGORD,"UD",PSJDD) Q:$G(PSGORQF)
"RTN","PSGOER",92,0)
 Q
"RTN","PSGOER",93,0)
UPDREN(PSGORD,RNWDT,PSGOEPR,PSGOFD,PSJNOO,RDUZ) ; update renewed order
"RTN","PSGOER",94,0)
 N DR,DA,DIC,DIE,DD,DO,PSGRZERO,PSGRFOUR,PSGOORD
"RTN","PSGOER",95,0)
 S DR="",PSGOEENO=0,PSGOORD=PSGORD,PSGNESD=PSGSD Q:'PSGORD!'RNWDT!'PSGOEPR!'PSGOFD  S PSJNOO=$S($G(PSJNOO)]"":$G(PSJNOO),1:"E")
"RTN","PSGOER",96,0)
 S PSGRZERO="^PS(55,"_PSGP_",5,"_+PSGORD_",0)",PSGOEORD=$P(@PSGRZERO,"^",21)
"RTN","PSGOER",97,0)
 ; PSJ*5*141 - changed PSGOEPR to PSGPR for field 1 of the DR string below.
"RTN","PSGOER",98,0)
 S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5," S DR="34////^S X=PSGFD" S:$G(PSGPR) DR=DR_";1////"_PSGPR_";110////"_PSJNOO D ^DIE
"RTN","PSGOER",99,0)
 K DR,DA,DIC,DIE,DD,DO S DIC="^PS(55,"_PSGP_",5,"_+PSGORD_",14,",DIC(0)="L",DIC("P")="55.6114DA",ND14=$G(@(DIC_"0)")),DINUM=$P(ND14,"^",3)+1,DA(2)=PSGP,DA(1)=+PSGORD D
"RTN","PSGOER",100,0)
 . S DIC("DR")=".01////"_$G(RNWDT)_";1////"_$S($G(RDUZ):RDUZ,1:$G(DUZ))_";2////"_$G(PSGOEPR)_";3////"_$G(PSGOFD)_";4////"_+PSGOEORD,X=$G(RNWDT) D FILE^DICN
"RTN","PSGOER",101,0)
 K DR,DA,DIC,DIE,DD,DO S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5,",DR="28////A;105////@;107////@"
"RTN","PSGOER",102,0)
 ;PSJ*5*198
"RTN","PSGOER",103,0)
 S PSGRFOUR="^PS(55,"_PSGP_",5,"_+PSGORD_",4)",PSGRFOUR=@PSGRFOUR I $P(PSGRFOUR,"^",2)<RNWDT S DR=DR_";16////@;17////@" I $G(PSJORD)["P",+PSJSYSU=1 S DR=DR_";18////@;19////@"
"RTN","PSGOER",104,0)
 I '$G(PSJSPEED) I $G(PSGAT)]"",$G(PSGAT)'=$P($G(@(DIE_+PSGORD_",2)")),"^",5) S DR=DR_";41////"_PSGAT
"RTN","PSGOER",105,0)
 D ^DIE
"RTN","PSGOER",106,0)
 ; PSJ*5*278 - Check to re-assign orderable item
"RTN","PSGOER",107,0)
 N PSGPOI S PSGPOI=$$ACTIVE^PSJORREN(PSGP,PSGORD) Q:+PSGPOI=1  ;Quit if no change to OI
"RTN","PSGOER",108,0)
 I +PSGPOI>1,$P(PSGPOI,U,2) D  ;replace OI
"RTN","PSGOER",109,0)
 . N DR,DA,DIE S DA(1)=PSGP,DA=+PSGORD,DIE="^PS(55,"_PSGP_",5,",DR="108///^S X=$P(PSGPOI,U,2)" D ^DIE
"RTN","PSGOER",110,0)
 Q
"RTN","PSGOER",111,0)
UPDRENOE(PSGP,PSGORD,RDATE) ;
"RTN","PSGOER",112,0)
 D EXPOE(PSGP,PSGORD,$G(RDATE)) ; expire original Orders File order
"RTN","PSGOER",113,0)
 I PSGORD'["P" K DA,DR,DIE S DA(1)=DFN,DA=+PSGORD,DIE="^PS(55,"_DFN_$S(PSGORD="U":",5,",1:",""IV"","),DR=$S(DIE["IV":110,1:66)_"////@" D ^DIE
"RTN","PSGOER",114,0)
 D ENUDTX^PSJOREN(PSGP,PSGORD,"NR")
"RTN","PSGOER",115,0)
 D EN1^PSJHL2(PSGP,"SN",PSGORD,"ORDER RENEWED")
"RTN","PSGOER",116,0)
 Q
"RTN","PSGOER",117,0)
READ ; hold screen
"RTN","PSGOER",118,0)
 I $D(IOST) Q:$E(IOST)'="C"
"RTN","PSGOER",119,0)
 W !?5,"Press return to continue  " R X:$S($D(DTIME):DTIME,1:300)
"RTN","PSGOER",120,0)
 Q
"RTN","PSGOER",121,0)
EXPOE(DFN,PSJORDER,EXPDT) ; expire old Orders File entry
"RTN","PSGOER",122,0)
 I PSJORDER["P" S FILE="^PS(53.1,"_+PSJORDER_",0)",PSJORDER=$P(@FILE,"^",25)
"RTN","PSGOER",123,0)
 I (PSJORDER'["U"),(PSJORDER'["V") Q
"RTN","PSGOER",124,0)
 N CURDAT D NOW^%DTC S CURDAT=$$DATE2^PSJUTL2(%)
"RTN","PSGOER",125,0)
 S PSJEXPOE=$S($G(EXPDT):EXPDT,1:CURDAT) D EN1^PSJHL2(DFN,"SC",PSJORDER) K PSJEXPOE
"RTN","PSGOER",126,0)
 Q
"RTN","PSGOER",127,0)
EXPIRED(PSJX,PSJY) ;
"RTN","PSGOER",128,0)
 ; INPUT 
"RTN","PSGOER",129,0)
 ;       PSJX - Pharmacy Patient, pointer to ^PS(55
"RTN","PSGOER",130,0)
 ;       PSJY - Inpatient Order Number(appended with "V" or "U")
"RTN","PSGOER",131,0)
 ; OUTPUT
"RTN","PSGOER",132,0)
 ;   0  -  Order has not exceeded the Expired Time Limit 
"RTN","PSGOER",133,0)
 ;   1  -  Order has exceeded the Expired Time Limit
"RTN","PSGOER",134,0)
 N STOP,STATUS,NOW,CUTOFF,FREQ,LAST,ST,X,DFN,U,PSGDT,SD,WD,PSJPSTO,PSGDW,PSGOC,ZZND,LASTAT,LSTSTR,PSBCNT S DFN=PSJX,U="^",CUTOFF=0
"RTN","PSGOER",135,0)
 S STATUS=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,0)),"^",9),PSJY["V":$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",17),1:"")
"RTN","PSGOER",136,0)
 S NOW=$S($G(PSGDT):PSGDT,1:$$DATE^PSJUTL2())
"RTN","PSGOER",137,0)
 S STOP=$S(PSJY["U":$P($G(^PS(55,PSJX,5,+PSJY,2)),U,4),1:$P($G(^PS(55,PSJX,"IV",+PSJY,0)),"^",3))
"RTN","PSGOER",138,0)
 I NOW<STOP Q 0
"RTN","PSGOER",139,0)
 I PSJY["U" N ND2,ND0 S ND0=$G(^PS(55,PSJX,5,+PSJY,0)),ND2=$G(^PS(55,PSJX,5,+PSJY,2)),FREQ=$P(ND2,"^",6) D
"RTN","PSGOER",140,0)
 .N SCHED S SCHED=$P($G(^PS(55,PSJX,5,+PSJY,2)),"^") I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED)
"RTN","PSGOER",141,0)
 .S LSTSTR=$P(ND2,"^",2)_"^"_$P(ND2,"^",4)_"^"_SCHED_"^"_$P(ND0,"^",7)_"^^"_$P(ND2,"^",5)
"RTN","PSGOER",142,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,($P(ND0,"^",7)="O"),($P(LAST,"^",3)="G") I LAST>$P(ND2,"^",2) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",143,0)
 .I 'LAST!(LAST>$P(ND2,"^",4)) S LAST=$$LASTAT^PSJORP2(DFN,LSTSTR) S:LAST CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",144,0)
 .I SCHED["PRN",($P(LSTSTR,"^",6)="") S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",145,0)
 .I $$DOW^PSIVUTL(SCHED) S CUTOFF=$$NXTDOW(DFN,$P(LSTSTR,"^"),$P(LSTSTR,"^",2),$P(LSTSTR,"^",3),$P(LSTSTR,"^",6)) Q
"RTN","PSGOER",146,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND2,"^",4)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",147,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,,,FREQ) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",148,0)
 I PSJY["V" N LIMIT S LIMIT=$P($G(^PS(59.7,1,31)),"^",4) S LIMIT=$S((LIMIT]""):+LIMIT,1:24) S CUTOFF=$$FMADD^XLFDT(STOP,,LIMIT) D
"RTN","PSGOER",149,0)
 .I '($G(P(4))]"") N P,YP,XP S YP=$G(^PS(55,DFN,"IV",+PSJY,0)) F XP=1:1:23 S P(XP)=$P(YP,U,XP)
"RTN","PSGOER",150,0)
 .Q:'($G(P(4))]"")
"RTN","PSGOER",151,0)
 .Q:'$$SCHREQ^PSJLIVFD(.P)
"RTN","PSGOER",152,0)
 .N INTERVAL,LSTSTR,ND0,SCHED,IVSTYP S ND0=$G(^PS(55,PSJX,"IV",+PSJY,0)),INTERVAL=$P(ND0,"^",15),SCHED=$P(ND0,"^",9) Q:SCHED=""
"RTN","PSGOER",153,0)
 .S IVSTYP=$S($$DOW^PSIVUTL(SCHED):"D",INTERVAL="O":"O",1:"C"),LSTSTR=$P(ND0,"^",2)_"^"_$P(ND0,"^",3)_"^"_SCHED_"^"_IVSTYP_"^^"_$P(ND0,"^",11)
"RTN","PSGOER",154,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I LAST,IVSTYP="O",LAST>$P(ND0,"^",2),($P(LAST,"^",3)="G") S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",155,0)
 .I 'LAST!(LAST>$P(ND0,"^",3))!(LAST&(IVSTYP="O")) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",156,0)
 .I IVSTYP="D" S CUTOFF=$$NXTDOW(LAST,SCHED,$G(P(2)),$P($G(P(9)),"@"),$G(P(11))) Q
"RTN","PSGOER",157,0)
 .I SCHED["PRN" S FREQ=$$PRNFREQ(SCHED) S CUTOFF=$$FMADD^XLFDT(LAST,,,FREQ) Q
"RTN","PSGOER",158,0)
 .S LAST=$$EN^PSBAPIPM(PSJX,PSJY) I 'LAST!(LAST>$P(ND0,"^",3)) S CUTOFF=$$FMADD^XLFDT(NOW,,-1) Q
"RTN","PSGOER",159,0)
 .S $P(LSTSTR,"^")=$$FMADD^XLFDT(LAST,,,,1),$P(LSTSTR,"^",2)=$$FMADD^XLFDT(PSGDT,31) S CUTOFF=$$ENQ^PSJORP2(PSJX,LSTSTR)
"RTN","PSGOER",160,0)
 K LYN,PSBDT,PSBFLAG,PSBSTR
"RTN","PSGOER",161,0)
 Q $S(CUTOFF<NOW:1,1:0)
"RTN","PSGOER",162,0)
 ;
"RTN","PSGOER",163,0)
NXTDOW(DOWDFN,DOWSD,DOWFD,DOWSCH,DOWAT) ;
"RTN","PSGOER",164,0)
 N NXTADM,DOWSTR S DOWSTR=$$FMADD^XLFDT(DOWFD,,,,1)_"^"_$$FMADD^XLFDT(DOWFD,7)_"^"_DOWSCH_"^D^^"_DOWAT S NXTADM=$$ENQ^PSJORP2(DOWDFN,DOWSTR)
"RTN","PSGOER",165,0)
 Q $S(NXTADM:NXTADM,1:DOWSD)
"RTN","PSGOER",166,0)
 ;
"RTN","PSGOER",167,0)
PRNFREQ(SCHED) ;
"RTN","PSGOER",168,0)
 N ZZND,D,DA,X,PSGAT,PSGOES,PSGST,PSJNSS,PSJPWD,TEST,VALMBCK,PSGS0XT,PSGS0Y,PSGDT
"RTN","PSGOER",169,0)
 F X=$P(SCHED,"PRN"),$P(SCHED,"PRN",2),$P(SCHED," PRN"),$P(SCHED,"PRN ",2) Q:$P($G(ZZND),"^",4)  D ADMIN^PSJORPOE
"RTN","PSGOER",170,0)
 Q $S($G(PSGS0XT):PSGS0XT,1:1440)
"RTN","PSGOER0")
0^30^B23514547
"RTN","PSGOER0",1,0)
PSGOER0 ;BIR/CML3 - EDIT FIELDS FOR RENEWAL ;12/09/07  02:22
"RTN","PSGOER0",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**11,45,47,50,63,64,70,69,58,80,110,127,136,181,281**;16 DEC 97;Build 113
"RTN","PSGOER0",3,0)
 ;
"RTN","PSGOER0",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191. 
"RTN","PSGOER0",5,0)
 ; Reference to ^VA(200 is supported by DBIA 10060.
"RTN","PSGOER0",6,0)
 ; Reference to ^DD(55.06 is supported by DBIA 2253.
"RTN","PSGOER0",7,0)
 ; Reference to ^%DT is supported by DBIA 10003.
"RTN","PSGOER0",8,0)
 ; Reference to ^DIC is supported by DBIA 10006.
"RTN","PSGOER0",9,0)
 ;
"RTN","PSGOER0",10,0)
DATE(PSGP,PSGORD,PSGDT) ;
"RTN","PSGOER0",11,0)
 K PSGFOK,PSJNOO,PSGNEDFD,PSGOEPR,PSGOER0,PSGPDRG,PSGOER2,PSGWLL,PSGOERDP,PSGOFD,PSGPRN,PSGPRI,PSGOSD,PSGOPR,PSGRNSD,PSGS0XT,PSGS0Y,PSGST,PSGSCH,PSGSDN
"RTN","PSGOER0",12,0)
 S F1=55.06,PSGWLL=+$G(^PS(55,PSGP,5.1)),PSGOER0=$G(^PS(55,PSGP,5,+PSGORD,0)),PSGPDRG=+$G(^(.2)),PSGOER2=$G(^(2))
"RTN","PSGOER0",13,0)
 NEW XX S XX=$$ACTIVE^PSJORREN(PSGP,PSGORD) S:+XX=2 PSGPDRG=$P(XX,U,2)
"RTN","PSGOER0",14,0)
 I '+XX W !,"No active Orderable Item was found.",! G DONE
"RTN","PSGOER0",15,0)
 S (PSGNEDFD,PSGOERDP)=$P($$GTNEDFD^PSGOE7("U",PSGPDRG),U)
"RTN","PSGOER0",16,0)
 S PSGSCH=$P(PSGOER2,"^"),PSGST=$P(PSGOER0,"^",7),PSGS0Y=$P(PSGOER2,"^",5),PSGS0XT=$P(PSGOER2,"^",6)
"RTN","PSGOER0",17,0)
 S PSGOEPR=+$P(PSGOER0,"^",2),(PSGOPR,PSGPR)=$S($P(PSJSYSU,";",2):DUZ,1:+PSGOEPR)
"RTN","PSGOER0",18,0)
 I $G(PSJSPEED) S PSGPR=$S($P(ND,"^",2):$P(ND,"^",2),1:+PSGOEPR)
"RTN","PSGOER0",19,0)
 S PSGOSD=+$P(PSGOER2,"^",2) S PSGOFD=+$P(PSGOER2,"^",4),PSGPRN=$P($G(^VA(200,PSGPR,0)),"^"),PSGPRI=$S($P(PSJSYSU,";",2):0,1:$P($G(^("PS")),"^",4)),PSGRO=0 S:PSGPRI PSGPRI=PSGPRI'>DT I PSGPRI S (PSGOPR,PSGPR,PSGPRN)=""
"RTN","PSGOER0",20,0)
 S PSGRNSD=$S($G(PSGLI):PSGLI,1:$G(PSGDT))
"RTN","PSGOER0",21,0)
 S PSGSD=$G(PSGOSD)
"RTN","PSGOER0",22,0)
 I PSGSD="" S PSJREN=1,PSGSD=$$ENSD^PSGNE3($S(PSGST["P":"PRN",1:$P(PSGOER2,U)),PSGS0Y,PSGDT,PSGOSD) S:PSGOSD>PSGSD PSGSD=PSGOSD K PSJREN
"RTN","PSGOER0",23,0)
 S PSGSDN=$$ENDD^PSGMI(PSGSD)
"RTN","PSGOER0",24,0)
10 ;
"RTN","PSGOER0",25,0)
 ;W !,"START DATE/TIME: "_PSGSDN
"RTN","PSGOER0",26,0)
O25 ;
"RTN","PSGOER0",27,0)
 N PSGSD,PSGNEFD S PSGSD=PSGDT
"RTN","PSGOER0",28,0)
 D ENWALL^PSGNE3(PSGSD,0,PSGP)
"RTN","PSGOER0",29,0)
 S:'$G(PSGDT) PSGDT=$$DATE2^PSJUTL2($$NOW^XLFDT)
"RTN","PSGOER0",30,0)
 N PSGNESD S PSGNESD=PSGDT D ENFD^PSGNE3(PSGNESD) I $G(PSGNEFD) S (Y,PSGFD)=PSGNEFD
"RTN","PSGOER0",31,0)
 S PSGFOK(10)="" I PSGST="O" S PSGFD=$$ENOSD^PSJDCU(PSJSYSW0,PSGRNSD,PSGP) I PSGFD]"" S Y=PSGRNSD,X=0 G 1
"RTN","PSGOER0",32,0)
D25 K DUR,DURMIN N PKGFLG S PKGFLG=$S(PSGORD["U":5,PSGORD["V":"IV",PSGORD["P":"P",1:"") I PKGFLG]"" S DUR=$$GETDUR^PSJLIVMD(PSGP,+$G(PSGORD),PKGFLG,1) I DUR]"" D
"RTN","PSGOER0",33,0)
 .S DURMIN=($$DURMIN^PSJLIVMD(DUR)\1) I DURMIN>1 S Y=$$FMADD^XLFDT(PSGRNSD,,,DURMIN) I Y>PSGRNSD S PSGFD=Y,X=0
"RTN","PSGOER0",34,0)
 I $P($G(PSGOER2),"^",4)>PSGFD S Y=$P(PSGOER2,"^",4)
"RTN","PSGOER0",35,0)
 I $G(DUR)]"",($G(PSGORD)'["P") S DURMIN=$$DURMIN^PSJLIVMD(DUR)\1 S Y=$$FMADD^XLFDT(PSGDT,,,DURMIN)
"RTN","PSGOER0",36,0)
 S:X&$P(PSJSYSW0,"^",7) $P(Y,".",2)=$P(PSJSYSW0,"^",7) S PSGFD=+Y,PSGFDN=$$ENDD^PSGMI(PSGFD)
"RTN","PSGOER0",37,0)
25 W !,"STOP DATE/TIME: "_PSGFDN_"// " R X:DTIME I X="^"!'$T W:'$T $C(7) S:'$T X="^" S PSGRO=1,COMQUIT=1 G DONE
"RTN","PSGOER0",38,0)
 I X="" W "   "_PSGFDN G W25
"RTN","PSGOER0",39,0)
 I $E(X)="^" D FF G:Y>0 @Y G 25
"RTN","PSGOER0",40,0)
 S PSGF2=25 I X="@"!(X?1."?") W:X="@" $C(7),"  (Required)" S:X="@" X="?" D ENHLP^PSGOEM(55.06,25)
"RTN","PSGOER0",41,0)
 I X=+X,X>0,X'>2000000 G 25:'$$ENDL^PSGDL(PSGSCH,X) K PSGDLS S PSGDL=X,ND2=PSGOER2,$P(ND2,"^",2)=PSGRNSD W " ...dose limit..." D ENGO^PSGDL
"RTN","PSGOER0",42,0)
 K %DT S %DT="ERTX" D ^%DT K %DT G:Y'>0 25 S PSGFD=+Y,PSGFDN=$$ENDD^PSGMI(PSGFD)
"RTN","PSGOER0",43,0)
W25 I PSGFD<PSGDT W $C(7),!!?13,"*** WARNING! THE STOP DATE ENTERED IS IN THE PAST! ***",!
"RTN","PSGOER0",44,0)
 I PSGFD<PSGSD W $C(7),!!?3,"*** The STOP date must be AFTER the START date. ***" G 25
"RTN","PSGOER0",45,0)
 S PSGFOK(25)=""
"RTN","PSGOER0",46,0)
 ;Display Expected First Dose;BHW;PSJ*5*136
"RTN","PSGOER0",47,0)
 D EFDNEW^PSJUTL
"RTN","PSGOER0",48,0)
 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S PSGFOK(1)="" Q
"RTN","PSGOER0",49,0)
1 ; provider
"RTN","PSGOER0",50,0)
 G:+PSJSYSU<3&$P(PSJSYSU,";",2) CHKDD S PSGF2=1
"RTN","PSGOER0",51,0)
A1 ;
"RTN","PSGOER0",52,0)
 W !,"PROVIDER: ",$S(PSGPR:PSGPRN_"// ",1:"") R X:DTIME I X="^"!'$T W:'$T $C(7) S:'$T X="^" S PSGRO=1,COMQUIT=1 G DONE
"RTN","PSGOER0",53,0)
 I $S(X="":'PSGPR,1:X="@") W $C(7),"  (Required)" S X="?" D ENHLP^PSGOEM(55.06,1) G A1
"RTN","PSGOER0",54,0)
 I X="",PSGPR S X=PSGPRN I PSGPR'=PSGPRN,$D(^VA(200,PSGPR,"PS")) W "    "_$P(^("PS"),"^",2)_"    "_$P(^("PS"),"^",3) S PSGFOK(1)="" G OC55
"RTN","PSGOER0",55,0)
 I X?1."?" D ENHLP^PSGOEM(55.06,1)
"RTN","PSGOER0",56,0)
 I $E(X)="^" D FF G:Y>0 @Y G A1
"RTN","PSGOER0",57,0)
 K DIC S DIC="^VA(200,",DIC(0)="EMQZ",DIC("S")="S X(1)=$G(^(""PS"")) I X(1),$S('$P((X(1)),""^"",4):1,1:DT<$P((X(1)),""^"",4))" D ^DIC K DIC I Y'>0 G A1
"RTN","PSGOER0",58,0)
 S PSGPR=+Y,PSGPRN=$P(Y(0,0),"^"),PSGFOK(1)=""
"RTN","PSGOER0",59,0)
OC55 ;
"RTN","PSGOER0",60,0)
 ;Order check for Speed finish is triggered from OC531^PSGOESF
"RTN","PSGOER0",61,0)
 I $G(PSGORD)]"P",$G(PSJSPEED) Q
"RTN","PSGOER0",62,0)
 I $G(PSJOCFG)="SPEED RENEW" G CHKDD
"RTN","PSGOER0",63,0)
 D NEWOC55^PSGOER
"RTN","PSGOER0",64,0)
 I $G(PSGORQF) S COMQUIT=1 G DONE
"RTN","PSGOER0",65,0)
CHKDD ;
"RTN","PSGOER0",66,0)
 G:$G(PSGRENEW) 106
"RTN","PSGOER0",67,0)
 I PSGORD["P"!$$DDOK^PSGOE2("^PS(55,"_PSGP_",5,"_+PSGORD_",1,",PSGPDRG) G 106
"RTN","PSGOER0",68,0)
 ;I PSGORD["P"!'$$CHKDD^PSGOE2("^PS(55,"_PSGP_",5,"_+PSGORD_",") G 106
"RTN","PSGOER0",69,0)
 I $P(PSJSYSU,";")'=3,'$P(PSJSYSP0,U,2) W !!,"This order's dispense drug is invalid, a pharmacist must renew this order." Q
"RTN","PSGOER0",70,0)
 K ^PS(53.45,PSJSYSP,1),^(2)
"RTN","PSGOER0",71,0)
 W !!,"THE DISPENSE DRUG IS MISSING FROM THIS ORDER."
"RTN","PSGOER0",72,0)
 D ENDRG^PSGOEF1(+^PS(55,PSGP,5,+PSGORD,.2),0)
"RTN","PSGOER0",73,0)
 I $G(DUOUT)!'$G(DRG) S COMQUIT=1 Q
"RTN","PSGOER0",74,0)
106 ; nature of order
"RTN","PSGOER0",75,0)
 S PSJNOO=$$ENNOO^PSJUTL5("R") S:PSJNOO<0 COMQUIT=1
"RTN","PSGOER0",76,0)
 S:PSJNOO'<0 PSGFOK(106)=""
"RTN","PSGOER0",77,0)
DONE ;
"RTN","PSGOER0",78,0)
 K F,F0,F1,PSGF2,F3,ND2,PSGDL,PSGDLS,PSGOROE1,PSGRO,SDT,X,Y Q
"RTN","PSGOER0",79,0)
FF ; "^" to another field
"RTN","PSGOER0",80,0)
 K DIC S DIC="^DD(55.06,",DIC(0)="EQ",DIC("S")="I $D(PSGFOK(+Y))",X=$E(X,2,255) D ^DIC K DIC
"RTN","PSGOER0",81,0)
 S Y=+Y Q
"RTN","PSGOERS")
0^31^B39916956
"RTN","PSGOERS",1,0)
PSGOERS ;BIR/CML3 - RENEW SELECTED ORDERS ; 10/23/14 9:30pm
"RTN","PSGOERS",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**11,29,35,47,58,110,281**;16 DEC 97;Build 113
"RTN","PSGOERS",3,0)
 ;
"RTN","PSGOERS",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180
"RTN","PSGOERS",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSGOERS",6,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192
"RTN","PSGOERS",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789
"RTN","PSGOERS",8,0)
 ; Reference to NOW^%DTC is supported by DBIA 10000
"RTN","PSGOERS",9,0)
 ;
"RTN","PSGOERS",10,0)
MARK ; only mark order, not actually renew
"RTN","PSGOERS",11,0)
 W !,"...marking ",PSGPDRGN," ",PSGDO,"..." S $P(^PS(55,PSGP,5,+PSGORD,4),"^",15,17)="1^"_DUZ_"^"_PSGDT,PSGAL("C")=13180 D ^PSGAL5 W "."
"RTN","PSGOERS",12,0)
 I $D(PSJSYSO) S PSGPOSA="R",PSGPOSD=PSGDT,PSGORD=+PSGORD_"A" D ENPOS^PSGVDS
"RTN","PSGOERS",13,0)
 Q
"RTN","PSGOERS",14,0)
RENEW ; mark or renew order
"RTN","PSGOERS",15,0)
 D NOW^%DTC K DA S DA(1)=PSGP,DA=+PSGORD,PSGDT=+$E(%,1,12)
"RTN","PSGOERS",16,0)
 I $G(PSGFD)="" S X=$P(PSGFDN,":",1,2) D ^%DT S:Y>0 PSGFD=Y
"RTN","PSGOERS",17,0)
 ; do order checking
"RTN","PSGOERS",18,0)
 N PSJABT,PSGDRG,PSGOER1,PSGDO,PSGPDRG,PSGPDRGN,PSGOER0,PSGST,PSGOER2,PSGSI,PSGOSD,PSGOFD,PSGNEDFD,PSGNESD,PSGMR,PSGSM,PSGHSM,PSGSCH,PSGS0Y,PSGS0XT,PSGNEFD
"RTN","PSGOERS",19,0)
 ;* S PSGDRG=$P($G(^PS(55,PSGP,5,+PSGORD,1,1,0)),"^")
"RTN","PSGOERS",20,0)
 ;* K PSGORQF D ENDDC^PSGSICHK(PSGP,+PSGDRG)
"RTN","PSGOERS",21,0)
 ;D OC55^PSGOER
"RTN","PSGOERS",22,0)
 ;I $D(PSGORQF) W !!,"  ",PSGOERS2,". ",$P($$DRUGNAME^PSJLMUTL(PSGP,PSGORD),"^")," ",$P(^PS(55,PSGP,5,+PSGORD,.2),"^",2),!,"...No action taken on this order...",! Q
"RTN","PSGOERS",23,0)
 ;* Q:$D(PSGORQF)  ; quit if not to continue
"RTN","PSGOERS",24,0)
 ;
"RTN","PSGOERS",25,0)
 S PSGOER1=$G(^PS(55,PSGP,5,+PSGORD,.2)),PSGDO=$P(PSGOER1,"^",2),PSGPDRG=$P(PSGOER1,"^"),PSGPDRGN=$$ENPDN^PSGMI(PSGPDRG) I '$P(PSJSYSP0,"^",3) G MARK
"RTN","PSGOERS",26,0)
 S PSGOER0=$G(^PS(55,PSGP,5,+PSGORD,0)),PSGST=$P(PSGOER0,"^",7),PSGOER2=$G(^(2)),PSGND4=$G(^(4)),PSGSI=$G(^(6)),PSGOSD=$P(PSGOER2,"^",2),PSGOFD=$P(PSGOER2,"^",4),PSGNEDFD=$P($$GTNEDFD^PSGOE7("U",PSGPDRG),U)_"^^"_PSGST
"RTN","PSGOERS",27,0)
 N PSGOEAV S PSGOEAV=1,PSGOORD=PSGORD W "." K ^PS(53.45,PSJSYSP,1),^(2)
"RTN","PSGOERS",28,0)
 I $$CHKDD() W !!,"...",PSGPDRGN," ",PSGDO," order NOT renewed..." Q
"RTN","PSGOERS",29,0)
 ;W !!,"...renewing ",PSGOERS2,". ",PSGPDRGN," ",PSGDO,"..."
"RTN","PSGOERS",30,0)
 S PSGMR=$P(PSGOER0,"^",3),PSGMRN=$$ENMRN^PSGMI(PSGMR),PSGSM=$P(PSGOER0,"^",5),PSGHSM=$P(PSGOER0,"^",6),PSGPDRG=$P(PSGOER1,"^"),PSGDO=$P(PSGOER1,"^",2)
"RTN","PSGOERS",31,0)
 S PSGSCH=$P(PSGOER2,"^"),PSGS0Y=$P(PSGOER2,"^",5),PSGS0XT=$P(PSGOER2,"^",6),PSGNESD=PSGSD,PSGNEFD=$S(PSGST="O":PSGSD,1:PSGFD)
"RTN","PSGOERS",32,0)
 S:PSJPWD'=$P(PSGOER2,U,10) PSGS0Y=$$ENRNAT^PSGOU($P(PSGOER2,U,10),+PSJPWD,PSGSCH,PSGS0Y)
"RTN","PSGOERS",33,0)
 ;K ^PS(53.45,PSJSYSP,4) S Q=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,12,Q)) Q:'Q  S ^PS(53.45,PSJSYSP,4,Q,0)=$G(^(Q,0))
"RTN","PSGOERS",34,0)
 I $O(^PS(55,PSGP,5,+PSGORD,3,0)) S ^PS(53.45,PSJSYSP,1,0)=^(0),Q=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,3,Q)) Q:'Q  S ^PS(53.45,PSJSYSP,1,Q,0)=$G(^(Q,0))
"RTN","PSGOERS",35,0)
 I '$O(^PS(53.45,PSJSYSP,2,0)) D
"RTN","PSGOERS",36,0)
 .S X=$O(^PS(55,PSGP,5,+PSGORD,1,0)) I X S (Q,Q1)=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,1,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,$S('$P(ND,"^",3):1,1:$P(ND,"^",3)>DT) S Q1=Q1+1,^PS(53.45,PSJSYSP,2,Q1,0)=$P(ND,"^",1,3)
"RTN","PSGOERS",37,0)
 D NEWOC55^PSGOER I $G(PSGORQF) W !!,"...order NOT renewed..." Q
"RTN","PSGOERS",38,0)
 W !!,"...renewing ",PSGOERS2,". ",PSGPDRGN," ",PSGDO,"..."
"RTN","PSGOERS",39,0)
 D SPEED^PSGOER
"RTN","PSGOERS",40,0)
 ; PSGP,PSGORD) D UPDREN(PSGORD,PSGDT,PSGOEPR,PSGOFD,PSJNOO),UPDRENOE(PSGP,PSGORD,PSGDT
"RTN","PSGOERS",41,0)
 ;S:$S(X:Q1,1:0) ^PS(53.45,PSJSYSP,2,0)="^53.4502P^"_Q1_"^"_Q1 D ^PSGOETO I +PSJSYSU=3,PSGOORD["O" D EN^PSGPEN(+PSGORD)
"RTN","PSGOERS",42,0)
 ;W !,"...updating original order...",! K DA S DA(1)=PSGP,DA=+PSGOORD,PSGAL("C")=PSJSYSU*10+18000 D ^PSGAL5
"RTN","PSGOERS",43,0)
 ;I PSGORD'["O",PSGSD<PSGOFD S PSGALR=70,DIE="^PS(55,"_PSGP_",5,",DR="34////"_+PSGSD S:PSGSD'>PSGDT DR=DR_";28////E"
"RTN","PSGOERS",44,0)
 ;I  D ^DIE I $P($G(^PS(55,PSGP,5,+PSGOORD,0)),"^",21) D EN1^PSJHL2(PSGP,"SC",PSGOORD,"ORDER EXPIRED")
"RTN","PSGOERS",45,0)
 ;S $P(PSGND4,"^",12,14)="^^",$P(PSGND4,"^",15,20)="^^^^^",$P(PSGND4,"^",22,24)="^^",^PS(55,PSGP,5,+PSGOORD,4)=PSGND4,$P(^(0),"^",26,27)=PSGORD_"^R"
"RTN","PSGOERS",46,0)
 Q
"RTN","PSGOERS",47,0)
CHKDD() ;
"RTN","PSGOERS",48,0)
 I '$$CHKDD^PSGOE2("^PS(55,"_PSGP_",5,"_+PSGORD_",") Q 0
"RTN","PSGOERS",49,0)
 I $P(PSJSYSU,";")'=3,'$P(PSJSYSP0,U,2) W !!,"This order's dispense drug is invalid, a pharmacist must renew this order." Q 1
"RTN","PSGOERS",50,0)
 W !!,"THE DISPENSE DRUG IS MISSING FROM THIS ORDER."
"RTN","PSGOERS",51,0)
 D ENDRG^PSGOEF1(+^PS(55,PSGP,5,+PSGORD,.2),0)
"RTN","PSGOERS",52,0)
 I $G(DUOUT) W !,"ORDER NOT RENEW."
"RTN","PSGOERS",53,0)
 Q $G(DUOUT)!'$G(DRG)
"RTN","PSGOERS",54,0)
EN ;
"RTN","PSGOERS",55,0)
 NEW PSGORQF,PSJOCFG S PSJOCFG="SPEED RENEW"
"RTN","PSGOERS",56,0)
 Q:'$$HIDDEN^PSJLMUTL("SPEED")  S PSJSPEED=1
"RTN","PSGOERS",57,0)
 N PSGONR,CODE,ST,DRG,ON S PSGOEORF=1 D FULL^VALM1
"RTN","PSGOERS",58,0)
 S CODE="",PSGONR=0 F  S CODE=$O(^TMP("PSJ",$J,CODE)) Q:CODE'="A"  D
"RTN","PSGOERS",59,0)
 .S ST="" F  S ST=$O(^TMP("PSJ",$J,CODE,ST)) Q:ST=""  D
"RTN","PSGOERS",60,0)
 ..S DRG="" F  S DRG=$O(^TMP("PSJ",$J,CODE,ST,DRG)) Q:DRG=""  S ON="" F  S ON=$O(^TMP("PSJ",$J,CODE,ST,DRG,ON)) Q:ON=""  S PSGONR=PSGONR+1
"RTN","PSGOERS",61,0)
 S PSGONW="R",PSGLMT=PSGONR D ENWO^PSGON I "^"[X K X G DONE
"RTN","PSGOERS",62,0)
 S PSGOSD=0 F PSGOERS=1:1:PSGODDD F PSGOERS1=1:1 S PSGOERS2=$P(PSGODDD(PSGOERS),",",PSGOERS1) Q:'PSGOERS2  S Y=+^TMP("PSJON",$J,PSGOERS2),F=$G(^PS(55,PSGP,5,Y,0)),D=$G(^(.2)) D HMSG I F G EN
"RTN","PSGOERS",63,0)
 I $P(PSJSYSP0,"^",3) D  I '$D(PSGFOK) S X="" G DONE
"RTN","PSGOERS",64,0)
 .NEW PSGRENEW S PSGRENEW=1
"RTN","PSGOERS",65,0)
 .S PSGORD=^TMP("PSJON",$J,+PSGODDD(1)),DA=+PSGORD,DA(1)=PSGP,PSGWLL=$S($P(PSJSYSW0,"^",4):+$G(^PS(55,PSGP,5.1)),1:0),PSGOEE="R" W ! D DATE^PSGOER0(PSGP,PSGORD,PSGDT)
"RTN","PSGOERS",66,0)
 .I '$D(PSGFOK(106)) W $C(7),!,"...order",$E("s",$L(PSGODDD(1),",")>2)," NOT renewed..." K PSGFOK Q
"RTN","PSGOERS",67,0)
 .I 'PSGNEDFD,$P(PSJSYSW0,"^",4),PSGFD'<PSGWLL S $P(^PS(55,PSGP,5.1),"^")=+PSGFD
"RTN","PSGOERS",68,0)
 ;W ! F PSGOERS=1:1:PSGODDD F PSGOERS1=1:1 S PSGOERS2=$P(PSGODDD(PSGOERS),",",PSGOERS1) Q:'PSGOERS2  S PSGORD=^TMP("PSJON",$J,PSGOERS2) D RENEW
"RTN","PSGOERS",69,0)
 W !
"RTN","PSGOERS",70,0)
 N EXITLOOP S EXITLOOP=0
"RTN","PSGOERS",71,0)
 F PSGOERS=1:1:PSGODDD D
"RTN","PSGOERS",72,0)
 .F PSGOERS1=1:1 D  Q:EXITLOOP=1
"RTN","PSGOERS",73,0)
 ..S PSGOERS2=$P(PSGODDD(PSGOERS),",",PSGOERS1)
"RTN","PSGOERS",74,0)
 ..I 'PSGOERS2 S EXITLOOP=1 Q
"RTN","PSGOERS",75,0)
 ..S PSGORD=^TMP("PSJON",$J,PSGOERS2)
"RTN","PSGOERS",76,0)
 ..I $$CHKCOM Q
"RTN","PSGOERS",77,0)
 ..I '$$LS^PSSLOCK(DFN,PSGORD) W !,$P($$DRUGNAME^PSJLMUTL(DFN,PSGORD),"^",1),!,"NO ACTION WAS TAKEN",!,$C(7) HANG 1 Q
"RTN","PSGOERS",78,0)
 ..D RENEW
"RTN","PSGOERS",79,0)
 ..; Call the unlock procedure
"RTN","PSGOERS",80,0)
 ..D UNL^PSSLOCK(DFN,PSGORD)
"RTN","PSGOERS",81,0)
 ..I $G(PSGOORD) D UNL^PSSLOCK(DFN,PSGOORD)
"RTN","PSGOERS",82,0)
 S X=""
"RTN","PSGOERS",83,0)
DONE ;
"RTN","PSGOERS",84,0)
 D INIT^PSJLMHED(1)
"RTN","PSGOERS",85,0)
 K DA,DIE,DR,FDSD,PSGAL,PSGALR,PSGFD,PSGFOK,PSGLMT,PSGND4,PSGODDD,PSGOERS,PSGOERS1,PSGOERS2,PSGONW,PSGOPR,PSGORD,PSGOSD,PSGPOSA,PSGPOSD,PSGPR,PSGPX,PSGSD
"RTN","PSGOERS",86,0)
 K PSGST,PSGTOL,PSGTOO,PSGUOW,PSGWLL,PSJSPEED,PSGDT,ND,Q,Q1,PSGDO,PSGOER1,PSGPDRG,PSGPDRGN,PSGOER0,PSGOER2,PSGND4,PSGSI,PSGOSD,PSGOFD,PSGNEDFD,%,Y,F,D
"RTN","PSGOERS",87,0)
 Q
"RTN","PSGOERS",88,0)
GRI ; get renewal info
"RTN","PSGOERS",89,0)
HMSG ; hold/'not to be given' message
"RTN","PSGOERS",90,0)
 S X=$P($G(^PS(50.7,+D,0)),"^") S:X]"" X=X_" "_$P(D,"^",2)
"RTN","PSGOERS",91,0)
 I $P(F,"^",22) S H="has been marked as 'NOT TO BE GIVEN'" D WO Q
"RTN","PSGOERS",92,0)
 I $P(F,"^",9)="H" S H="is ON HOLD" D WO Q
"RTN","PSGOERS",93,0)
 I $P(F,"^",27)]"",$P(F,"^",26) S H="has been "_$S($P(F,"^",24)="E":"EDITED",1:"RENEWED") D WO Q
"RTN","PSGOERS",94,0)
 I ($P($G(^PS(50.7,+D,0)),"^",4)]"")&($P($G(^(0)),"^",4)'>DT) S H="is no longer an active Orderable Item" D WO Q
"RTN","PSGOERS",95,0)
 N PSGDFLG,DRG,DRGPT
"RTN","PSGOERS",96,0)
 S PSGDFLG=1 F DRG=0:0 S DRG=$O(^PSDRUG("ASP",+D,DRG)) Q:'DRG  I $P(^PSDRUG(DRG,2),U,3)["U",($G(^PSDRUG(DRG,"I"))=""!($G(^("I"))>DT)) S PSGDFLG=0 Q
"RTN","PSGOERS",97,0)
 I PSGDFLG S H="is no longer an active Dispense drug" D WO Q
"RTN","PSGOERS",98,0)
 S F=0,X=$P($G(^PS(55,PSGP,5,Y,2)),"^",2) S:X>PSGOSD PSGOSD=X Q
"RTN","PSGOERS",99,0)
WO ;
"RTN","PSGOERS",100,0)
 W $C(7),"  ??",! W:X]"" !,X S H1="Order number "_$G(PSGOERS2)_" "_H_", and cannot be renewed." W ! F H2=1:1:$L(H1," ") S H3=$P(H1," ",H2) W:$L(H3)+$X>78 ! W H3," "
"RTN","PSGOERS",101,0)
 S F=1 K H,H1,H2,H3 Q
"RTN","PSGOERS",102,0)
CHKCOM() ;       Check if this order is a complex order
"RTN","PSGOERS",103,0)
 S PSJCOM=0
"RTN","PSGOERS",104,0)
 I PSGORD=+PSGORD S PSJCOM=PSGORD W !,"  Order ",PSGOERS2," is part of a complex order series, and cannot be renewed.",! H 2 Q PSJCOM
"RTN","PSGOERS",105,0)
 S PSJCOM=$S(PSGORD["U":$P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,8),1:$P($G(^PS(53.1,+PSGORD,.2)),U,8))
"RTN","PSGOERS",106,0)
 I PSJCOM  W !,"  Order ",PSGOERS2," is part of a complex order series, and cannot be renewed.",! H 2
"RTN","PSGOERS",107,0)
 Q PSJCOM
"RTN","PSGOES")
0^47^B22743395
"RTN","PSGOES",1,0)
PSGOES ;BIR/CML3-CREATE ORDERS USING ORDER SET ;19 Feb 99 / 12:53 PM
"RTN","PSGOES",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**12,22,30,34,50,58,111,181,263,309,281**;16 DEC 97;Build 113
"RTN","PSGOES",3,0)
 ;
"RTN","PSGOES",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSGOES",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGOES",6,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGOES",7,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSGOES",8,0)
 ;
"RTN","PSGOES",9,0)
 NEW PSJNOOSV
"RTN","PSGOES",10,0)
 K DIC,PSGOEOS S X=$P(X,"S.",2),DIC="^PS(53.2,",DIC(0)="QEM" D ^DIC K DIC G:Y'>0 DONE W "  (ORDER SET)" S PSGOESDA=+Y,PSGOES=1
"RTN","PSGOES",11,0)
 I '$D(^PS(53.2,+Y,2)) W "    Invalid Order Set" Q
"RTN","PSGOES",12,0)
 I $P(PSJSYSU,";",2) S PSGOESPR=DUZ
"RTN","PSGOES",13,0)
 E  D  G:Y'>0 DONE
"RTN","PSGOES",14,0)
 .S DIC="^VA(200,",DIC(0)="QEAM",DIC("A")="Select PROVIDER: ",X=$P($G(^PS(55,PSGP,5.1)),"^",2) I X S X=$P($G(^VA(200,X,0)),"^") I X]"" S Y=^("PS") I Y,$S('$P(Y,"^",4):1,1:$P(Y,"^",4)>DT) S DIC("B")=X
"RTN","PSGOES",15,0)
 .S DIC("S")="S X(1)=$G(^(""PS"")) I X(1),$S('$P(X(1),""^"",4):1,1:$P(X(1),""^"",4)>DT)" W ! D ^DIC K DIC I Y'>0 W $C(7),!!,"Provider is required for order sets." Q
"RTN","PSGOES",16,0)
 .S PSGOESPR=+Y S:$P($G(^PS(55,PSGP,5.1)),"^",2)'=+Y $P(^(5.1),"^",2)=+Y
"RTN","PSGOES",17,0)
 S (PSJNOO,PSJNOOSV)=$$ENNOO^PSJUTL5("N")
"RTN","PSGOES",18,0)
 I $G(PSJNOO)<0 W !,$C(7),"...order set not entered..." G DONE
"RTN","PSGOES",19,0)
 F PSGOESN=0:0 S PSGOESN=$O(^PS(53.2,PSGOESDA,2,PSGOESN)) Q:'PSGOESN  I $D(^(PSGOESN,0)) S OSND=^(0) I $S($P(OSND,"^",3)="":0,$P(OSND,"^",4)="":0,$P(OSND,"^",4)="OC":1,1:$P(OSND,"^",5)]"") S PSGSI=$P($G(^(1)),"^") D GND Q:PSGQUIT
"RTN","PSGOES",20,0)
 ;
"RTN","PSGOES",21,0)
DONE ;
"RTN","PSGOES",22,0)
 K PSJNOON,PSJNOO,PSJNOOSV
"RTN","PSGOES",23,0)
 S X="S.X" K %DT,N,OSND,PSGOESDA,PSGDDRG,PSGOESI,PSGOES,PSGOEOS,PSGOESN,PSGOESPR,PSGQUIT,PSGX,SDT,STDAY,X1,X2 Q
"RTN","PSGOES",24,0)
 ;
"RTN","PSGOES",25,0)
GND ;
"RTN","PSGOES",26,0)
 NEW PSJOCDS,PSJALLGY,PSJMULDD
"RTN","PSGOES",27,0)
 K PSGOEE,PSGSCH,PSGORD
"RTN","PSGOES",28,0)
 K ^TMP("PSODAOC",$J)
"RTN","PSGOES",29,0)
 S:'$D(PSJNOO) PSJNOO=$G(PSJNOOSV)
"RTN","PSGOES",30,0)
 S (PSGPDRG,PSGX)=+OSND,PSGPDRGN=$P($G(^PS(50.7,PSGPDRG,0)),"^") S:PSGPDRGN="" PSGPDRGN=PSGPDRG W !!,"...entering ",$S(PSGPDRGN'=PSGPDRG:PSGPDRGN,1:"** UNKNOWN **"),"..." K Y,DIRUT D END^PSGSICHK S PSGQUIT=$D(DIRUT) Q:$G(Y)<0
"RTN","PSGOES",31,0)
 S PSGNEDFD=$P(OSND,"^",2,5),PSGMR=$P(OSND,"^",3),PSGST=$P(OSND,"^",4),PSGDO=$P(OSND,"^",9),PSGMRN=$$ENMRN^PSGMI(PSGMR)
"RTN","PSGOES",32,0)
 S:PSGMRN="" PSGMRN=PSGMR D NOW^%DTC S PSGDT=+$E(%,1,12) I PSGST="OC" S PSGSCH="ON CALL",(PSGS0XT,PSGS0Y)=""
"RTN","PSGOES",33,0)
 E  S X=$P(OSND,"^",5) W "." S:X X="`"_X D ENOS^PSGS0 S:$D(X) PSGSCH=X I '$D(X) S (PSGSCH,PSGS0XT,PSGS0Y)=""
"RTN","PSGOES",34,0)
 S (PSGNESD,PSGNEFD)="" W "." I $P(OSND,"^",11)]"" S %DT="T",X=$P(OSND,"^",11) D ^%DT S PSGNESD=Y D ENFD^PSGNE3(PSGDT)
"RTN","PSGOES",35,0)
 D:$P(OSND,"^",11)="" ^PSGNE3 K PSGDRG,PSGORQF,^PS(53.45,PSJSYSP,1),^(2) S (N,Q)=0
"RTN","PSGOES",36,0)
 K PSJALLGY
"RTN","PSGOES",37,0)
 ;If PSJMULDD >1 then the order has mutliple DD and it will flag ENDDC^PSGSICHK to display the OI name instead of DD name
"RTN","PSGOES",38,0)
 S PSJMULDD=0
"RTN","PSGOES",39,0)
 F  S Q=$O(^PS(53.2,PSGOESDA,2,PSGOESN,2,Q)) Q:'Q!$D(PSGORQF)  S PSGDRG=$G(^(Q,0)) I PSGDRG D
"RTN","PSGOES",40,0)
 .S PSJALLGY(+PSGDRG)="",PSJMULDD=PSJMULDD+1
"RTN","PSGOES",41,0)
 .;D ENDDC^PSGSICHK(PSGP,+PSGDRG) Q:$D(PSGORQF)
"RTN","PSGOES",42,0)
 .;D IN^PSJOCDS($G(PSGORD),"UD",+PSGDRG) Q:$D(PSGORQF)
"RTN","PSGOES",43,0)
 .;D CONT^PSJOCDT Q:$D(PSGORQF)
"RTN","PSGOES",44,0)
 .S:$P(PSGDRG,U,2)="" $P(PSGDRG,U,2)=1
"RTN","PSGOES",45,0)
 .S N=N+1,^PS(53.45,PSJSYSP,2,N,0)=PSGDRG,^PS(53.45,PSJSYSP,2,"B",+PSGDRG,N)="" W "."
"RTN","PSGOES",46,0)
 .I $P(^PSDRUG(+PSGDRG,2),U,3)'["U"!($S('+$G(^PSDRUG(+PSGDRG,"I")):0,^("I")'>DT:1,1:0)) S PSGOEAV="0^1" W:PSJSYSU $C(7),!?5,"...AS NON-VERIFIED - DATA INCOMPLETE..."
"RTN","PSGOES",47,0)
 S PSGDRG=$O(PSJALLGY(0)) Q:'+PSGDRG
"RTN","PSGOES",48,0)
 D FULL^VALM1
"RTN","PSGOES",49,0)
 D ENDDC^PSGSICHK(PSGP,+PSGDRG) Q:$D(PSGORQF)
"RTN","PSGOES",50,0)
 D IN^PSJOCDS($G(PSGORD),"UD",+PSGDRG) Q:$D(PSGORQF)
"RTN","PSGOES",51,0)
 ;*309 - Remove second continue prompt
"RTN","PSGOES",52,0)
 ;D CONT^PSJOCDT Q:$D(PSGORQF)
"RTN","PSGOES",53,0)
 I N S ^PS(53.45,PSJSYSP,2,0)="^53.4502P^"_N_"^"_N
"RTN","PSGOES",54,0)
 I $G(PSGORQF) W !,?5,"...ORDER FOR ",PSGPDRGN," NOT ENTERED...",! Q
"RTN","PSGOES",55,0)
 ;I PSGOEAV,$S($D(PSGOEOS):1,'PSGPDRG:1,PSGPDRG=PSGPDRGN:1,'PSGMR:1,PSGMR=PSGMRN:1,PSGSCH="":1,PSGST="":1,'PSGNESD:1,'PSGNEFD:1,+PSJSYSU=3:'N,1:0) S PSGOEAV="0^1" W:('$D(PSGOEOS)&PSJSYSU) $C(7),!?5,"...AS NON-VERIFIED - DATA INCOMPLETE..."
"RTN","PSGOES",56,0)
 I PSGOEAV,$S('PSGPDRG:1,PSGPDRG=PSGPDRGN:1,'PSGMR:1,PSGMR=PSGMRN:1,PSGSCH="":1,PSGST="":1,'PSGNESD:1,'PSGNEFD:1,+PSJSYSU=3:'N,1:0) S PSGOEAV="0^1" W:('$D(PSGOES)&PSJSYSU) $C(7),!?5,"...AS NON-VERIFIED - DATA INCOMPLETE..."
"RTN","PSGOES",57,0)
 S (PSGHSM,PSGSM)="",PSGPR=PSGOESPR D ^PSGOETO S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSGOES",58,0)
 ; pharmacist label check, build label for order set only if auto verify turned on
"RTN","PSGOES",59,0)
 I PSJSYSL>0,(PSGOEAV),($P($G(^PS(55,PSGP,5,$S($D(DA):DA,1:+PSGORD),0)),U,9)="A") D
"RTN","PSGOES",60,0)
 .S $P(^PS(55,PSGP,5,$S($D(DA):DA,1:+PSGORD),7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N" S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOES",61,0)
 ; ward clerk label check 
"RTN","PSGOES",62,0)
 I PSJSYSL>0,$P(PSJSYSU,";",3)<3,"12"[$P(PSJSYSW0,"^",12),'(PSGOEAV) D
"RTN","PSGOES",63,0)
 .I PSGORD["P" S $P(^PS(53.1,$S($D(DA):DA,1:+PSGORD),7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"
"RTN","PSGOES",64,0)
 .I PSGORD'["P" S $P(^PS(55,PSGP,5,$S($D(DA):DA,1:+PSGORD),7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"
"RTN","PSGOES",65,0)
 .S PSGTOL=2,PSGUOW=DUZ,PSGTOO=2,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOES",66,0)
 Q
"RTN","PSGOEV")
0^15^B91287532
"RTN","PSGOEV",1,0)
PSGOEV ;BIR/CML3 - VERIFY (MAKE ACTIVE) ORDERS ;4/16/10 9:18am
"RTN","PSGOEV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**5,7,15,28,33,50,64,58,77,78,80,110,111,133,171,207,241,267,268,260,288,199,281**;16 DEC 97;Build 113
"RTN","PSGOEV",3,0)
 ;
"RTN","PSGOEV",4,0)
 ; Reference to ^ORD(101 supported by DBIA #872.
"RTN","PSGOEV",5,0)
 ; Reference to ^PS(50.7 supported by DBIA #2180.
"RTN","PSGOEV",6,0)
 ; Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSGOEV",7,0)
 ; Reference to ^PSSLOCK supported by DBIA #2789.
"RTN","PSGOEV",8,0)
 ; Reference to ^PSDRUG( supported by DBIA# 2192.
"RTN","PSGOEV",9,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA #2410.
"RTN","PSGOEV",10,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSGOEV",11,0)
 ;
"RTN","PSGOEV",12,0)
EN(PSGORD) ;
"RTN","PSGOEV",13,0)
ENSF ; This entry point is used by Speed finish only.
"RTN","PSGOEV",14,0)
 ; Send SN update to CPRS if auto-verify off and from Order Set entry
"RTN","PSGOEV",15,0)
 S:'$D(PSGOEAV) PSGOEAV=$P($G(PSJSYSP0),"^",9)&$G(PSJSYSU)
"RTN","PSGOEV",16,0)
 I $D(PSGOES),'PSGOEAV,PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSGOEV",17,0)
 D FULL^VALM1 I 'PSJSYSU W $C(7),$C(7),!!," THIS FUNCTION NOT AVAILABLE TO WARD STAFF." Q
"RTN","PSGOEV",18,0)
 S CHK=0 I PSGORD["P" S X=$P($G(^PS(53.1,+PSGORD,0)),"^",19) I X,$D(^PS(55,PSGP,5,$P(^(0),"^",19))) S CHK=+PSGORD,PSGORD=X_"U" L -^PS(53.1,CHK) L +^PS(55,PSGP,5,+PSGORD):1 E  W !!,"Another terminal is editing this order." G DONE
"RTN","PSGOEV",19,0)
 I +PSJSYSU=3 D DDCHK G:CHK DONE
"RTN","PSGOEV",20,0)
 I PSGORD["P" D CHK($G(^PS(53.1,+PSGORD,0)),$G(^(.2)),$G(^(2)))
"RTN","PSGOEV",21,0)
 I $G(PSGSCH)]"" D
"RTN","PSGOEV",22,0)
 .N X,Y,PSGS0Y,PSGS0XT,PSGOES S PSGOES=1 S X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",23,0)
 I $G(CHK) Q:$D(PSJSPEED)  D EN^VALM("PSJU LM ACCEPT") G:'$G(PSJACEPT) DONE ;G VFY
"RTN","PSGOEV",24,0)
 I PSGORD["U" G:'$D(^PS(55,PSGP,5,+PSGORD,4)) VFY I +PSJSYSU=3,$P(^(4),"^",3) W $C(7),!!,"THIS ORDER HAS ALREADY BEEN VERIFIED BY A PHARMACIST." S PSGACT=$P(PSGACT,"V")_$P(PSGACT,"V",2) G DONE
"RTN","PSGOEV",25,0)
 I PSGORD["U" I +PSJSYSU=1,+^PS(55,PSGP,5,+PSGORD,4) W $C(7),!!,"THIS ORDER HAS ALREADY BEEN VERIFIED BY A NURSE." S PSGACT=$P(PSGACT,"V")_$P(PSGACT,"V",2) G DONE
"RTN","PSGOEV",26,0)
 ;
"RTN","PSGOEV",27,0)
VFY ; change status, move to 55, and change label record **ENHANCEMENTS MADE IN PSJ*5.0*260 **CCR 6214 **CCR 6244
"RTN","PSGOEV",28,0)
 I PSGORD["P" S PSJCOM=+$P($G(^PS(53.1,+PSGORD,.2)),"^",8) I PSJCOM D VFY^PSJCOM Q
"RTN","PSGOEV",29,0)
 NEW PSJDOSE,PSJDSFLG,PSJDIS,PSGORQF,PSJCNT,PSJCNT1,PSJCNT2,LIST,PSJFLG,PSGDN SET PSJDIS="",PSJCNT=0,PSJCNT1="",PSJCNT2="",LIST="PSGPRE",PSJFLG="",PSGDN=""
"RTN","PSGOEV",30,0)
 D DOSECHK^PSJDOSE
"RTN","PSGOEV",31,0)
 SET PSJFLG=+$G(PSGORD)
"RTN","PSGOEV",32,0)
 FOR  SET PSJCNT=$O(^PS(53.1,PSJFLG,1,PSJCNT)) Q:'+PSJCNT  D
"RTN","PSGOEV",33,0)
 .IF $D(^PS(53.1,PSJFLG,1,PSJCNT,0)) SET PSGDN=$P($G(^PS(53.1,PSJFLG,1,PSJCNT,0)),U,1)
"RTN","PSGOEV",34,0)
 .IF +$G(PSGDN),($P($G(^PSDRUG(PSGDN,0)),U,3)'["S")&($E($P($G(^PSDRUG(PSGDN,0)),U,2),1,2)'="XA")  D
"RTN","PSGOEV",35,0)
 ..D PROFILE^PSJBLDOC($G(DFN),LIST,"I;"_$G(PSGORD))
"RTN","PSGOEV",36,0)
 ..FOR  SET PSJCNT1=$O(^TMP($J,LIST,"IN","PROFILE",PSJCNT1)) Q:(PSJCNT1="")!(PSJDIS'="")  D
"RTN","PSGOEV",37,0)
 ...SET PSJCNT2=$P(PSJCNT1,";",2)
"RTN","PSGOEV",38,0)
 ...IF PSJCNT2=$G(PSGORD) SET PSJDIS=$P(^TMP($J,LIST,"IN","PROFILE",PSJCNT1),U,3)
"RTN","PSGOEV",39,0)
 ..;**Do order checks if PSJDIS (Dispense drug IEN) has a value
"RTN","PSGOEV",40,0)
 ..;IF $G(PSJNEWOE)=0,'$G(PSJLMFIN),'$G(PSJSTARI),'$G(PSGCOPY),$G(PSJDIS),'$G(PSJSPEED)  D
"RTN","PSGOEV",41,0)
 ..IF '+$G(PSJNEWOE),'$G(PSJLMFIN),'$G(PSJSTARI),'$G(PSGCOPY),$G(PSJDIS),'$G(PSJSPEED)  D
"RTN","PSGOEV",42,0)
 ...D ALLERGY($G(PSJORD),.PSJALLGY),ENDDC^PSGSICHK($G(PSGP),PSJDIS) D:('$G(PSGORQF)&'$G(PSJDSVFY)&'$G(PSJSTARI)) IN^PSJOCDS($G(PSGORD),"UD",PSJDIS) IF $G(PSGORQF) K ^TMP($J,LIST) D:$G(PSJORD)]"" EN^VALM("PSJ LM UD ACTION") QUIT
"RTN","PSGOEV",43,0)
 IF $G(PSGORQF) QUIT
"RTN","PSGOEV",44,0)
 D FULL^VALM1 ;PSJ*5*241
"RTN","PSGOEV",45,0)
 I +$G(PSJDSFLG) D SETVAR^PSJDOSE W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1") I '$$CONT() W !,"...order was not verified..." D PAUSE^VALM1 D  Q:'$G(PSJACEPT)
"RTN","PSGOEV",46,0)
 . S PSGOEEF(109)=1
"RTN","PSGOEV",47,0)
 . S PSJACEPT=0
"RTN","PSGOEV",48,0)
 . ;D EN^VALM("PSJU LM ACCEPT")
"RTN","PSGOEV",49,0)
 D DDCHK G:CHK DONE
"RTN","PSGOEV",50,0)
 I $G(PSGSCH)]"",((",P,R,")'[(","_PSGST_",")) D  I CHK G DONE
"RTN","PSGOEV",51,0)
 .N SWD,SDW,XABB,X,QX S X=$G(PSGSCH) D DW^PSGS0 Q:($G(X)="")  I $G(PSGS0XT)="" S PSGS0XT="D"
"RTN","PSGOEV",52,0)
 .I $G(PSGS0XT)="D",$G(PSGAT)="" S CHK=1 W !!,"This is a 'DAY OF WEEK' schedule and MUST have admin times.",! D PAUSE^VALM1
"RTN","PSGOEV",53,0)
 I $G(PSGSCH)]"" D  I CHK G DONE
"RTN","PSGOEV",54,0)
 .N X,Y,PSGS0XT,PSGS0Y,PSGOES S PSGOES=2,X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",55,0)
 W !,"...a few moments, please..."
"RTN","PSGOEV",56,0)
 I PSGORD["P" D
"RTN","PSGOEV",57,0)
 . N PND0,PSGORDR,PSJPRIO,PSJSCHED S PND0=^PS(53.1,+PSGORD,0) I $P(PND0,U,24)="R" S PSGORDR=$P(PND0,U,25) D  Q
"RTN","PSGOEV",58,0)
 .. N OEORD,OOEORD,FILE55,FILE55N0 S FILE55="^PS(55,"_DFN_$S($P(PND0,U,4)="U":",5,",1:",""IV"","),FILE55N0=FILE55_+PSGORDR_",0)"
"RTN","PSGOEV",59,0)
 .. S OEORD=$P(PND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD D EXPOE^PSGOER(DFN,PSGORD,+$$LASTREN^PSJLMPRI(DFN,PSGORD))
"RTN","PSGOEV",60,0)
 .. S PSGORDP=PSGORD,DIE="^PS(53.1,",DA=+PSGORD,DR="28////A;104////@" W "." D ^DIE
"RTN","PSGOEV",61,0)
 .. D START^PSGOTR(PSGORD,+PSGORDR) I OEORD D
"RTN","PSGOEV",62,0)
 ... K DA,DR,DIE S DA(1)=DFN,DA=+PSGORDR,DIE=FILE55,DR=$S(DIE["IV":110,1:66)_"////"_+OEORD D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSGOEV",63,0)
 ... D EN1^PSJHL2(DFN,"SC",PSGORDR),EN^PSGPEN(PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSGOEV",64,0)
 . S PSGORDP=PSGORD ;Used in ACTLOG to update activity log in 55
"RTN","PSGOEV",65,0)
 . D REQDT^PSJLIVMD(PSGORD)
"RTN","PSGOEV",66,0)
 . S DIE="^PS(53.1,",DA=+PSGORD,DR="28////A" W "." D ^DIE,^PSGOT
"RTN","PSGOEV",67,0)
 . S PSJPRIO=$S(PSGORD["P":$P($G(^PS(53.1,+PSGORD,.2)),"^",4),PSGORD["U":$P($G(^PS(55,DFN,5,+PSGORD,.2)),"^",4),1:$P($G(^PS(55,PSJHLDFN,"IV",+PSGORD,.2)),"^",4))
"RTN","PSGOEV",68,0)
 . S PSJSCHED=$S(PSGORD["P":$P($G(^PS(53.1,+PSGORD,2)),"^"),PSGORD["U":$P($G(^PS(55,DFN,5,+PSGORD,2)),"^"),1:$P($G(^PS(55,PSJHLDFN,"IV",+PSGORD,0)),"^",15))
"RTN","PSGOEV",69,0)
 . I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCHED)="NOW")!($G(PSJSCHED)["STAT") D NOTIFY^PSJHL4(PSGORD,DFN,$G(PSJPRIO),$G(PSJSCHED))
"RTN","PSGOEV",70,0)
 . I $G(PSGRDTX)="" S PSGRDTX=$G(^PS(53.1,+PSGORDP,2.5))
"RTN","PSGOEV",71,0)
 S DA=+PSGORD,DA(1)=PSGP,PSGAL("C")=PSJSYSU*10+22000 D ^PSGAL5 W "." S VND4=$G(^PS(55,PSGP,5,DA,4))
"RTN","PSGOEV",72,0)
 I $G(PSGRDTX) D NEWUDAL^PSGAL5(PSGP,PSGORD,6090,"Requested Start Date",+$G(PSGRDTX))
"RTN","PSGOEV",73,0)
 I $P($G(PSGRDTX),U,3) D NEWUDAL^PSGAL5(PSGP,PSGORD,6090,"Requested Stop Date",+$P($G(PSGRDTX),U,3))
"RTN","PSGOEV",74,0)
 N DUR,DURON S DURON=$S($G(PSGORD):$G(PSGORD),1:"") I DURON D
"RTN","PSGOEV",75,0)
 . S DUR=$S($P($G(PSGRDTX),U,2)]"":$P($G(PSGRDTX),U,2),1:$$GETDUR^PSJLIVMD(PSGP,+DURON,$S($G(DURON)["P":"P",1:5),1),1:"")
"RTN","PSGOEV",76,0)
 I $G(DUR)]"" S $P(^PS(55,PSGP,5,+PSGORD,2.5),"^",2)=DUR
"RTN","PSGOEV",77,0)
 D:$D(PSGORDP) ACTLOG(PSGORDP,PSGP,PSGORD)
"RTN","PSGOEV",78,0)
 K PSGRSD,PSGRFD,PSGALFN
"RTN","PSGOEV",79,0)
 NEW X S X=0 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S X=1
"RTN","PSGOEV",80,0)
 I +PSJSYSU=3,PSGORD'["O",$S(X:0,'$P(VND4,"^",9):1,1:$P(VND4,"^",15)) D EN^PSGPEN(+PSGORD)
"RTN","PSGOEV",81,0)
 S $P(VND4,"^",+PSJSYSU=1+9)=1 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9)
"RTN","PSGOEV",82,0)
 I PSJSYSL>1 S $P(^PS(55,PSGP,5,+PSGORD,7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"_$S($P(^PS(55,PSGP,5,+PSGORD,0),"^",24)="E":"E",1:"") S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSGOEV",83,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=VND4
"RTN","PSGOEV",84,0)
 I '$P(VND4,U,9) S ^PS(55,"APV",PSGP,+PSGORD)=""
"RTN","PSGOEV",85,0)
 I '$P(VND4,U,10) S ^PS(55,"ANV",PSGP,+PSGORD)=""
"RTN","PSGOEV",86,0)
 I $P(VND4,U,9) K ^PS(55,"APV",PSGP,+PSGORD)
"RTN","PSGOEV",87,0)
 I $P(VND4,U,10) K ^PS(55,"ANV",PSGP,+PSGORD)
"RTN","PSGOEV",88,0)
 W:'$D(PSJSPEED) ! W !,"ORDER VERIFIED.",!
"RTN","PSGOEV",89,0)
 I '$D(PSJSPEED) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOEV",90,0)
 S:+PSJSYSU=3 ^PS(55,"AUE",PSGP,+PSGORD)="" S PSGACT="C"_$S('$D(^PS(55,PSGP,5,+PSGORD,4)):"E",$P(^(4),"^",16):"",1:"E")_"RS",PSGCANFL=2
"RTN","PSGOEV",91,0)
 S VALMBCK="Q" D EN1^PSJHL2(PSGP,$S(+PSJSYSU=3:"SC",+PSJSYSU=1:"SC",1:"XX"),+PSGORD_"U")     ; allow status change to be sent for pharmacists & nurses
"RTN","PSGOEV",92,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=$G(PSJORD),^TMP("PSODAOC",$J,"IP NEW IEN")=$G(PSGORD)
"RTN","PSGOEV",93,0)
 ; -- RTC 198753 - clean-up variable - K PSJAGYSV
"RTN","PSGOEV",94,0)
 D SETOC^PSJNEWOC(PSGORD) K PSJAGYSV
"RTN","PSGOEV",95,0)
  ; **This is where the Automated Dispensing Machine hook is called. Do NOT DELETE or change this location **
"RTN","PSGOEV",96,0)
 D NEWJ^PSJADM
"RTN","PSGOEV",97,0)
  ; **END of Interface hook **
"RTN","PSGOEV",98,0)
 D:+PSJSYSU=1 EN1^PSJHL2(PSGP,"ZV",+PSGORD_"U")
"RTN","PSGOEV",99,0)
DONE ;
"RTN","PSGOEV",100,0)
 W:CHK !!,"...order NOT verified..."
"RTN","PSGOEV",101,0)
 I '$D(PSJSPEED),'CHK,+PSJSYSU=3,$G(PSJPRI)="D" D
"RTN","PSGOEV",102,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSGOEV",103,0)
 .Q:Y="N"
"RTN","PSGOEV",104,0)
 .D MAIN^TIUEDIT(3,.TIUDA,PSGP,"","","","",1)
"RTN","PSGOEV",105,0)
 S VALMBCK="Q" K CHK,DA,DIE,F,DP,DR,ND,PSGAL,PSGODA,PSGTOL,PSGTOO,PSGUOW,PSJDOSE,PSJVAR,VND4,X,ZZND Q
"RTN","PSGOEV",106,0)
 ;
"RTN","PSGOEV",107,0)
LBL ;
"RTN","PSGOEV",108,0)
 Q
"RTN","PSGOEV",109,0)
 ;
"RTN","PSGOEV",110,0)
ALLERGY(PSGORD,PSJALLGY) ;setup PSJALLGY when non-vf was selected to verify
"RTN","PSGOEV",111,0)
 NEW PSGDDI,PSJDD,PSJX
"RTN","PSGOEV",112,0)
 I '+$G(PSGORD),($G(PSGORD)'["P") Q
"RTN","PSGOEV",113,0)
 F PSGDDI=0:0 S PSGDDI=$O(^PS(53.1,+PSGORD,1,PSGDDI)) Q:'PSGDDI  D
"RTN","PSGOEV",114,0)
 . S PSJDD=+$G(^PS(53.1,+PSGORD,1,PSGDDI,0))
"RTN","PSGOEV",115,0)
 . S PSJX=$S('$D(^PSDRUG(+PSJDD,0)):1,$P($G(^(2)),U,3)'["U":1,$G(^("I"))="":0,1:^("I")'>$G(DT))
"RTN","PSGOEV",116,0)
 . Q:PSJX
"RTN","PSGOEV",117,0)
 . S PSJALLGY(PSJDD)=""
"RTN","PSGOEV",118,0)
 Q
"RTN","PSGOEV",119,0)
CHK(ND,DRG,ND2) ; checks for data in required fields
"RTN","PSGOEV",120,0)
 ; Input: ND  - ^(PS(53.1,PSGORD,0)
"RTN","PSGOEV",121,0)
 ;        DRG - ^(.2)
"RTN","PSGOEV",122,0)
 ;        ND2 - ^(2)
"RTN","PSGOEV",123,0)
 S Y=$G(Y)
"RTN","PSGOEV",124,0)
 S CHK="" I DRG,$D(^PS(50.7,+DRG,0))
"RTN","PSGOEV",125,0)
 E  S CHK=1
"RTN","PSGOEV",126,0)
 I ND="" S CHK=CHK_23
"RTN","PSGOEV",127,0)
 E  S CHK=CHK_$S($P(ND,"^",3):"",1:2)_$S($P(ND,"^",7)]"":"",1:3)
"RTN","PSGOEV",128,0)
 ;The naked reference on the line below refers to the variable ND which is ^PS(53.1,PSGORD,0).
"RTN","PSGOEV",129,0)
 I ND2="" S CHK=CHK_$S('$D(^(0)):4,$P(^(0),"^",7)="OC":"",1:4)_56
"RTN","PSGOEV",130,0)
 E  S CHK=CHK_$S($P(ND2,"^")]"":"",ND="":4,$P(ND,"^",7)="OC":"",1:4)_$S($P(ND2,"^",2):"",1:5)_$S($P(ND2,"^",4):"",1:6)
"RTN","PSGOEV",131,0)
 I $$CHECK^PSGOE8(PSJSYSP),$P(DRG,U,2)="" S CHK=CHK_8
"RTN","PSGOEV",132,0)
 K PSGDFLG,PSGPFLG S PSGDI=0
"RTN","PSGOEV",133,0)
 S:'$$DDOK^PSGOE2("^PS(53.45,"_PSJSYSP_",2,",+DRG) CHK=CHK_7,(PSGDFLG,PSGDI)=1
"RTN","PSGOEV",134,0)
 S:'$$OIOK^PSGOE2(+DRG) PSGPFLG=1
"RTN","PSGOEV",135,0)
 I 'CHK,$G(PSGSCH)]"" D
"RTN","PSGOEV",136,0)
 .N X,Y,PSGS0Y,PSGS0XT,PSGOES S PSGOES=2,X=PSGSCH D ENOS^PSGS0 I $G(X)="" S CHK=4
"RTN","PSGOEV",137,0)
 Q:'CHK
"RTN","PSGOEV",138,0)
 W $C(7)
"RTN","PSGOEV",139,0)
 ;
"RTN","PSGOEV",140,0)
CHKM ;
"RTN","PSGOEV",141,0)
 D FULL^VALM1 K:CHK Y
"RTN","PSGOEV",142,0)
 ; changed to remove ^DD ref
"RTN","PSGOEV",143,0)
 ; PSJ*5*267 VMP Add the 8th condition
"RTN","PSGOEV",144,0)
 W !!,"THE FOLLOWING ",$S($L(CHK)>1:"ARE",1:"IS")," EITHER INVALID OR MISSING FROM THIS ORDER:" F X=1:1:8 W:CHK[X !?5,$P("ORDERABLE ITEM^MED ROUTE^SCHEDULE TYPE^SCHEDULE^START DATE/TIME^STOP DATE/TIME^DISPENSE DRUG^DOSAGE ORDERED","^",X)
"RTN","PSGOEV",145,0)
 I CHK=7 W !,"Orders with no dispense drugs or multiple dispense drugs",!,"require dosage ordered"
"RTN","PSGOEV",146,0)
 W:CHK]"" !!,$S($L(CHK)>1:"THESE FIELDS ARE",1:"THIS FIELD IS")," NECESSARY FOR VERIFICATION."
"RTN","PSGOEV",147,0)
 N DIR,DUOUT,DTOUT S DIR(0)="E" D ^DIR I $D(DUOUT)!$D(DTOUT) S CHK=1 Q
"RTN","PSGOEV",148,0)
 Q
"RTN","PSGOEV",149,0)
 ;
"RTN","PSGOEV",150,0)
CONT() ;
"RTN","PSGOEV",151,0)
 NEW DIR,DIRUT,Y
"RTN","PSGOEV",152,0)
 W ! K DIR,DIRUT
"RTN","PSGOEV",153,0)
 S DIR(0)="Y",DIR("A")="Would you like to continue verifying the order",DIR("B")="No"
"RTN","PSGOEV",154,0)
 D ^DIR
"RTN","PSGOEV",155,0)
 Q Y
"RTN","PSGOEV",156,0)
 ;
"RTN","PSGOEV",157,0)
DDCHK ; dispense drug check
"RTN","PSGOEV",158,0)
 S DRGF="^PS("_$S(PSGORD["P":"53.1,"_+PSGORD,1:"55,"_PSGP_",5,"_+PSGORD)_",",CHK=$S('$O(@(DRGF_"1,0)")):7,1:0)
"RTN","PSGOEV",159,0)
 S PSGPD=$G(@(DRGF_".2)"))
"RTN","PSGOEV",160,0)
 S CHK=$S('$$DDOK^PSGOE2(DRGF_"1,",PSGPD):7,1:0)
"RTN","PSGOEV",161,0)
 Q:CHK=0
"RTN","PSGOEV",162,0)
 W $C(7),!!,"This order must have at least one valid, active dispense drug to be verified."
"RTN","PSGOEV",163,0)
 ;
"RTN","PSGOEV",164,0)
DDEDIT ;
"RTN","PSGOEV",165,0)
 ;*** Remove all dispense drug for this order
"RTN","PSGOEV",166,0)
 K @(DRGF_"1)")
"RTN","PSGOEV",167,0)
 ; The naked reference below refers to the indirect full reference in DRGF_"1,"_Q_")", which is either ^PS(53.1,+PSGORD,Q) or ^PS(55,DFN,5,+PSGORD,Q)
"RTN","PSGOEV",168,0)
 K ^PS(53.45,PSJSYSP,2) S (X,Q)=0 F  S Q=$O(@(DRGF_"1,"_Q_")")) Q:'Q  S Y=$G(^(Q,0)),X=Q S ^PS(53.45,PSJSYSP,2,Q,0)=Y I Y S ^PS(53.45,PSJSYSP,2,"B",+Y,Q)=""
"RTN","PSGOEV",169,0)
 I X S ^PS(53.45,PSJSYSP,2,0)="^53.4502P^"_X_"^"_X
"RTN","PSGOEV",170,0)
 D ENDRG^PSGOEF1(PSGPD,X)
"RTN","PSGOEV",171,0)
 I 'CHK S %X="^PS(53.45,"_PSJSYSP_",2,",%Y=DRGF_"1," D %XY^%RCR S $P(@(DRGF_"1,0)"),"^",2)=$S(DRGF[53.1:"53.11P",1:"55.07P")
"RTN","PSGOEV",172,0)
 K DRG,DRGF,%X,%Y,PSGPD Q
"RTN","PSGOEV",173,0)
 ;
"RTN","PSGOEV",174,0)
AESCREEN() ;
"RTN","PSGOEV",175,0)
 ; Output: 0 - Required fields missing and DON'T allow accept
"RTN","PSGOEV",176,0)
 ;         1 - Required fields found.
"RTN","PSGOEV",177,0)
 Q:'$G(CHK) 1
"RTN","PSGOEV",178,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSGOEV",179,0)
 I Y="PSJU LM ACCEPT EDIT" Q 1
"RTN","PSGOEV",180,0)
 Q 0
"RTN","PSGOEV",181,0)
ACTLOG(PSGORDP,DFN,PSGORD)  ;Store 53.1 activity log in local array to be moved to 55
"RTN","PSGOEV",182,0)
 ;PSGORDP: IEN from 53.1
"RTN","PSGOEV",183,0)
 ;PSGORD : IEN from 55
"RTN","PSGOEV",184,0)
 NEW PSGX,PSGXDA,PSGAL531,Q,QQ
"RTN","PSGOEV",185,0)
 F PSGX=0:0 S PSGX=$O(^PS(53.1,+PSGORDP,"A",PSGX)) Q:'PSGX  D
"RTN","PSGOEV",186,0)
 . S PSGAL531=$G(^PS(53.1,+PSGORDP,"A",PSGX,0))
"RTN","PSGOEV",187,0)
 . S QQ=$G(^PS(55,DFN,5,+PSGORD,9,0)) S:QQ="" QQ="^55.09D" F Q=$P(QQ,U,3)+1:1 I '$D(^(Q)) S $P(QQ,U,3,4)=Q_U_Q,^(0)=QQ,PSGXDA=Q Q
"RTN","PSGOEV",188,0)
 . S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,0)=PSGAL531
"RTN","PSGOEV",189,0)
 . N TXTLN S TXTLN="" F  S TXTLN=$O(^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN)) Q:TXTLN=""  D
"RTN","PSGOEV",190,0)
 .. I TXTLN=0 S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,1,TXTLN)=^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN) Q
"RTN","PSGOEV",191,0)
 .. S ^PS(55,DFN,5,+PSGORD,9,PSGXDA,1,TXTLN,0)=^PS(53.1,+PSGORDP,"A",PSGX,1,TXTLN,0)
"RTN","PSGOEV",192,0)
 Q
"RTN","PSGSICH1")
0^49^B130843550
"RTN","PSGSICH1",1,0)
PSGSICH1 ;BIR/JCH-PROVIDER & PHARMACY OVERRIDE UTILITIES 1; 01/25/11 1:02pm
"RTN","PSGSICH1",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**254,281**;16 DEC 97;Build 113
"RTN","PSGSICH1",3,0)
 ;
"RTN","PSGSICH1",4,0)
 ; Reference to OCAPI^ORCHECK is supported by DBIA #4859.
"RTN","PSGSICH1",5,0)
 ; Reference to OCCNT^ORACPI1 is supported by DBIA #5637
"RTN","PSGSICH1",6,0)
 ; Reference to ^APSPQA(32.4 is supported by DBIA #2179
"RTN","PSGSICH1",7,0)
 ;
"RTN","PSGSICH1",8,0)
GETPROVL(PSGP,PSGORD,OUTARRAY) ; Get LAST (most recent) Provider Override associated with Inpatient Order
"RTN","PSGSICH1",9,0)
 K OUTARRAY,PSJOCHIS,PSJQUITD,PSJHISTF,PSJOVRAR
"RTN","PSGSICH1",10,0)
 N PSJDSPLN,ILCNT,PSJOVRAR,PSJCUROV,PSJCURIN,PSJTMPX,PSJTMPI,PSJINTAR,PSJINTER,PSJOVDON,PSJDONED,PSJINDEN,PSJBANNR,PSJHISTF,PSJHISTO,PSJIOSL,X,Y,DR,DIR,DIE,DIC,PSJOROIC
"RTN","PSGSICH1",11,0)
 Q:'$G(PSGP)!'$G(PSGORD)
"RTN","PSGSICH1",12,0)
 D GETOORDS^PSGSICH2(PSGP,PSGORD,.PSJOVRAR)
"RTN","PSGSICH1",13,0)
 S PSJOROIC=$$OROICHK^PSGSICH(PSGP,PSGORD,.PSJOVRAR)
"RTN","PSGSICH1",14,0)
 S PSJTMPX="" F  S PSJTMPX=$O(PSJOVRAR(PSGP,PSGORD,PSJTMPX),-1) Q:'PSJTMPX!$G(PSJOVDON)  D
"RTN","PSGSICH1",15,0)
 .S PSJCUROV="" F  S PSJCUROV=$O(PSJOVRAR(PSGP,PSGORD,PSJTMPX,PSJCUROV),-1) Q:'PSJCUROV!$G(PSJOVDON)  D
"RTN","PSGSICH1",16,0)
 ..I PSJCUROV["C",(PSJCUROV'>PSJOROIC) S PSJOVDON=1 Q
"RTN","PSGSICH1",17,0)
 ..Q:(PSJCUROV)'["C"  Q:'$$OCCNT^OROCAPI1(+PSJCUROV)
"RTN","PSGSICH1",18,0)
 ..N PSJTMPOO S PSJTMPOO=$G(PSJOVRAR(PSGP,PSGORD,PSJTMPX,PSJCUROV))
"RTN","PSGSICH1",19,0)
 ..D GETPROVR(PSGP,PSJTMPOO,.OUTARRAY,+PSJCUROV)
"RTN","PSGSICH1",20,0)
 ..I $D(OUTARRAY)>1 S PSJOVDON=1
"RTN","PSGSICH1",21,0)
 K ^TMP($J,"PSJ")
"RTN","PSGSICH1",22,0)
 Q
"RTN","PSGSICH1",23,0)
 ;
"RTN","PSGSICH1",24,0)
GETPROVR(PSGP,PSGORD,OUTARRAY,PSJCPRS) ; Get Provider Override
"RTN","PSGSICH1",25,0)
 ; Input: PSGP - Patient DFN (IEN from Pharmacy Patient (#55) file.
"RTN","PSGSICH1",26,0)
 ;        PSGORD - Inpatient Order number from Pharmacy Patient (#55) file or NON-VERIFIED ORDERS (#53.1) file
"RTN","PSGSICH1",27,0)
 ;        OUTARRAY - Name of array in which override data will be returned
"RTN","PSGSICH1",28,0)
 ;        PSJCPRS - CPRS Order (#100) file IEN from which to retrieve Provider Override
"RTN","PSGSICH1",29,0)
 Q:$G(PSJNEWOE)
"RTN","PSGSICH1",30,0)
 N PSJ,DELIM,TXT,TXT1,TXT2,CAT K OUTARRAY,^TMP($J,"PSJ") S OUTARRAY=""
"RTN","PSGSICH1",31,0)
 S PSJCPRS=$S($G(PSJCPRS):PSJCPRS,PSGORD["U":$P($G(^PS(55,PSGP,5,+PSGORD,0)),U,21),PSGORD["V":$P($G(^PS(55,PSGP,"IV",+PSGORD,0)),U,21),PSGORD["P":$P($G(^PS(53.1,+PSGORD,0)),U,21),1:0)
"RTN","PSGSICH1",32,0)
 Q:'$G(PSJCPRS)
"RTN","PSGSICH1",33,0)
 D OCAPI^ORCHECK(+PSJCPRS,"PSJ"):$G(PSJCPRS)
"RTN","PSGSICH1",34,0)
 I PSJCPRS,$G(^TMP($J,"PSJ",1,"OC TEXT",1,0))'="" D
"RTN","PSGSICH1",35,0)
 .S PSJ=0 F  S PSJ=$O(^TMP($J,"PSJ",PSJ)) Q:'PSJ  D
"RTN","PSGSICH1",36,0)
 ..S TXT=$G(^TMP($J,"PSJ",PSJ,"OC TEXT",1,0))
"RTN","PSGSICH1",37,0)
 ..S CAT=3 S:TXT["CRITICAL drug-drug" CAT=2
"RTN","PSGSICH1",38,0)
 ..S:(TXT["Previous ")&(TXT[" adverse reaction") CAT=1 ;;cmf/281 change
"RTN","PSGSICH1",39,0)
 ..;;S:TXT["Previous adverse reaction" CAT=1 ;;cmf/281 removal
"RTN","PSGSICH1",40,0)
 ..I TXT]"" S OUTARRAY("PROVR",PSGP,+PSGORD,CAT,PSJ,0)=TXT
"RTN","PSGSICH1",41,0)
 .S PSJ=$O(^TMP($J,"PSJ",0))
"RTN","PSGSICH1",42,0)
 .D NAME^PSGSICH($G(^TMP($J,"PSJ",PSJ,"OR PROVIDER")),.X)
"RTN","PSGSICH1",43,0)
 .I X'="" S (TMPOAR,OUTARRAY("PROV",PSGP,+PSGORD,1))="Override Entered By: "_X D
"RTN","PSGSICH1",44,0)
 ..N PSJTITLE S PSJTITLE=$P($G(^VA(200,+^TMP($J,"PSJ",PSJ,"OR PROVIDER"),0)),"^",9) I PSJTITLE D
"RTN","PSGSICH1",45,0)
 ...N DIC,X,Y S DIC="^DIC(3.1,",DIC(0)="NZ" S X="`"_+PSJTITLE D ^DIC I Y S TMPOAR=TMPOAR_" ("_$P(Y,"^",2)_")"
"RTN","PSGSICH1",46,0)
 ..S OUTARRAY("PROV",PSGP,+PSGORD,1)=TMPOAR
"RTN","PSGSICH1",47,0)
 ..S X=$G(^TMP($J,"PSJ",PSJ,"OR DT")) I X D
"RTN","PSGSICH1",48,0)
 ...N PSJIDTMP S PSJIDTMP=$P($TR($$FMTE^XLFDT(X,2),"@","  "),":",1,2) S $P(PSJIDTMP,"/")=$S($L($P(PSJIDTMP,"/"))=1:0,1:"")_+$P(PSJIDTMP,"/") S $P(PSJIDTMP,"/",2)=$S($L($P(PSJIDTMP,"/",2))=1:0,1:"")_+$P(PSJIDTMP,"/",2)
"RTN","PSGSICH1",49,0)
 ...S OUTARRAY("PROV",PSGP,+PSGORD,2)="  Date/Time Entered: "_PSJIDTMP
"RTN","PSGSICH1",50,0)
 ..S OUTARRAY("PROV",PSGP,+PSGORD,3)="    Override Reason: "_$G(^TMP($J,"PSJ",PSJ,"OR REASON"))
"RTN","PSGSICH1",51,0)
 ..N TMPRV,TMPRVNAM S TMPRV=$S(PSGORD["U":$P($G(^PS(55,+PSGP,5,+PSGORD,0)),"^",2),PSGORD["P":$P($G(^PS(53.1,+PSGORD,0)),"^",2),PSGORD["V":$P($G(^PS(55,PSGP,"IV",+PSGORD,0)),"^",6),1:"") D
"RTN","PSGSICH1",52,0)
 ...S TMPRVNAM="" D NAME^PSGSICH(TMPRV,.TMPRVNAM) Q:TMPRVNAM=""
"RTN","PSGSICH1",53,0)
 ...S PSJTITLE=$P($G(^VA(200,+TMPRV,0)),"^",9) I PSJTITLE N DIC,X,Y S DIC="^DIC(3.1,",DIC(0)="NZ" S X="`"_+PSJTITLE D ^DIC I Y S PSJTITLE=$P(Y,"^",2)
"RTN","PSGSICH1",54,0)
 ...I PSJTITLE]"" S TMPRVNAM=TMPRVNAM_" ("_PSJTITLE_")"
"RTN","PSGSICH1",55,0)
 ..S OUTARRAY("PROV",PSGP,+PSGORD,0)="Overriding Provider: "_$G(TMPRVNAM)
"RTN","PSGSICH1",56,0)
 I $G(OUTARRAY("PROV",PSGP,+PSGORD,0))=""!('$D(OUTARRAY("PROVR",PSGP,+PSGORD,1))&'$D(OUTARRAY("PROVR",PSGP,+PSGORD,2))) K OUTARRAY S OUTARRAY=""
"RTN","PSGSICH1",57,0)
 K ^TMP($J,"PSJ")
"RTN","PSGSICH1",58,0)
 Q
"RTN","PSGSICH1",59,0)
 ;
"RTN","PSGSICH1",60,0)
DSPROVR(PSGP,PSGORD,OUTARRAY) ; Display Provider Overrides
"RTN","PSGSICH1",61,0)
 ; INPUT: PSGP - Patient DFN
"RTN","PSGSICH1",62,0)
 ;        PSGORD - Inpatient Order
"RTN","PSGSICH1",63,0)
 ;        OUTARRAY - Array containing Provider Overrides
"RTN","PSGSICH1",64,0)
 Q:$G(PSJNEWOE)!$G(PSJQUITD)
"RTN","PSGSICH1",65,0)
 Q:$D(OUTARRAY)<10
"RTN","PSGSICH1",66,0)
 N PSJDSPLN,TXT2,OCCNT,PSJL,PSJNXT,PSJINDEN,PSJBANNR,PSJIOSL,II,I2,JJ,OC,PSJM
"RTN","PSGSICH1",67,0)
 S PSJIOSL=$S($G(IOSL):IOSL,1:24)
"RTN","PSGSICH1",68,0)
 S PSJBANNR="Provider Overrides for this order" S PSJBANNR=$S($G(PSJOCHIS):"Historical ",1:"Current ")_PSJBANNR
"RTN","PSGSICH1",69,0)
 S $P(PSJDSPLN,"=",76)="=",PSJINDEN=8
"RTN","PSGSICH1",70,0)
 W !!,PSJDSPLN,!?PSJINDEN,"** ",PSJBANNR," **",!,PSJDSPLN,! S OCCNT=6
"RTN","PSGSICH1",71,0)
 F II=0:1:3 W !,$G(OUTARRAY("PROV",PSGP,+PSGORD,II)) S OCCNT=$G(OCCNT)+1
"RTN","PSGSICH1",72,0)
 W ! S CAT=0 F  S CAT=$O(OUTARRAY("PROVR",PSGP,+PSGORD,CAT)) Q:'CAT  D
"RTN","PSGSICH1",73,0)
 .I $G(OCCNT)<4 W !!,PSJDSPLN,!?PSJINDEN,"** ",PSJBANNR," **",!,PSJDSPLN,! S OCCNT=5
"RTN","PSGSICH1",74,0)
 .S OC=0 F  S OC=$O(OUTARRAY("PROVR",PSGP,+PSGORD,CAT,OC)) Q:'OC!$G(PSJQUITD)  D
"RTN","PSGSICH1",75,0)
 ..I $G(OCCNT)<4 W !!,PSJDSPLN,!?PSJINDEN,"** ",PSJBANNR," **",!,PSJDSPLN,! S OCCNT=5
"RTN","PSGSICH1",76,0)
 ..S PSJL=OUTARRAY("PROVR",PSGP,+PSGORD,CAT,OC,0) I $L(PSJL)>77 D
"RTN","PSGSICH1",77,0)
 ...F II=1:1 D  S PSJL=PSJM Q:PSJL=""
"RTN","PSGSICH1",78,0)
 ....S PSJM=$E(PSJL,79,999),PSJL=$E(PSJL,1,78) I PSJM="",PSJL]"" S OUTARRAY("PROVR",PSGP,+PSGORD,CAT,OC,0,II)=PSJL Q
"RTN","PSGSICH1",79,0)
 ....S PSJDONED=0 F I2=$L(PSJL):-1:1 Q:$G(PSJDONED)  I $E(PSJL,I2)=" " S PSJM=$E(PSJL,I2+1,$L(PSJL))_PSJM,PSJL=$E(PSJL,1,I2) S OUTARRAY("PROVR",PSGP,+PSGORD,CAT,OC,0,II)=PSJL,PSJDONED=1
"RTN","PSGSICH1",80,0)
 ...S PSJNXT=0 F  S PSJNXT=$O(OUTARRAY("PROVR",PSGP,+PSGORD,CAT,OC,0,PSJNXT)) Q:'PSJNXT!$G(PSJQUITD)  W !?2,OUTARRAY("PROVR",PSGP,+PSGORD,CAT,OC,0,PSJNXT) S OCCNT=$G(OCCNT)+1
"RTN","PSGSICH1",81,0)
 ...W ! S OCCNT=$G(OCCNT)+1
"RTN","PSGSICH1",82,0)
 ..Q:$G(PSJQUITD)
"RTN","PSGSICH1",83,0)
 ..I $L(OUTARRAY("PROVR",PSGP,+PSGORD,CAT,OC,0))<78 W !?2,OUTARRAY("PROVR",PSGP,+PSGORD,CAT,OC,0),! S OCCNT=$G(OCCNT)+2
"RTN","PSGSICH1",84,0)
 ..I OCCNT>($G(PSJIOSL)-6) D
"RTN","PSGSICH1",85,0)
 ...S JJ=($G(PSJIOSL)-2)-OCCNT F II=1:1:JJ W !
"RTN","PSGSICH1",86,0)
 ...D HLD^PSGSICH S OCCNT=0
"RTN","PSGSICH1",87,0)
 Q:$G(PSJQUITD)
"RTN","PSGSICH1",88,0)
 I OCCNT>4 D
"RTN","PSGSICH1",89,0)
 .I OCCNT<($G(PSJIOSL)) S JJ=($G(PSJIOSL)-2)-OCCNT F II=1:1:JJ W !
"RTN","PSGSICH1",90,0)
 .D HLD^PSGSICH S OCCNT=0
"RTN","PSGSICH1",91,0)
 K ^TMP($J,"PSJ")
"RTN","PSGSICH1",92,0)
 Q
"RTN","PSGSICH1",93,0)
 ;
"RTN","PSGSICH1",94,0)
INTRDIC(PSGP,PSGORD,OUTARRAY,PSJCURIN) ; Retrieve Intervention IEN's for a specific order and store in array
"RTN","PSGSICH1",95,0)
 ; Input: PSGP       - Patient IEN from PATIENT (#2b) file. (required).
"RTN","PSGSICH1",96,0)
 ;        PSGORD  - Inpatient Order from NON-VERIFIED ORDERS (#53.1) file or UD (#62) multiple or IV (#100) multiple of 
"RTN","PSGSICH1",97,0)
 ;                    PHARMACY PATIENT (#55) file.(required)
"RTN","PSGSICH1",98,0)
 ;        OUTARRAY  - Array name, passed by reference, to hold return values.(required)
"RTN","PSGSICH1",99,0)
 ;        PSJCURIN -  Current intervention flag.
"RTN","PSGSICH1",100,0)
 ;                    PSJCURIN = 0 - Return all interventions associated with order PSGORD regardless of date/time.
"RTN","PSGSICH1",101,0)
 ;                    PSJCURIN = 1 - Only return interventions, associated with order PSGORD, logged on the most recent Intervention date/time.
"RTN","PSGSICH1",102,0)
 ;                    PSJCURIN = 2 - Only return interventions, associated with order PJORDER, logged on most recent date, if at least one CRITICAL DRUG-DRUG or ALLERGY ADR was logged on the most recent Intervention date/time.
"RTN","PSGSICH1",103,0)
 ;
"RTN","PSGSICH1",104,0)
 N %,II,INT,FLDI,FLDE,WPLINE,INTERVEN,PSJIDTM,PSJCNDT,PSJINT,PSJCRAL,DA,D0,DIC,DR,DFN,PSJORDER K ^UTILITY("DIQ1",$J) K OUTARRAY S PSJINT="A",DFN=PSGP,PSJORDER=PSGORD
"RTN","PSGSICH1",105,0)
 I $G(PSJCURIN)=2 Q:'$$INTCHKO(DFN,PSJORDER)
"RTN","PSGSICH1",106,0)
 I PSJORDER["P" F II=1:1  S PSJINT=$O(^PS(53.1,+PSJORDER,11,PSJINT),-1) Q:'PSJINT  S INTERVEN=$G(^PS(53.1,+PSJORDER,11,PSJINT,0)),PSJIDTM=$P(INTERVEN,"^",2) D
"RTN","PSGSICH1",107,0)
 .S:(II=1) PSJCNDT=$P(INTERVEN,"^",2) I $G(PSJCURIN)>0 Q:(PSJCNDT'=PSJIDTM)
"RTN","PSGSICH1",108,0)
 .D ONEINTER^PSGSICH(INTERVEN,PSJORDER,PSJIDTM,.OUTARRAY)
"RTN","PSGSICH1",109,0)
 I PSJORDER["U" F II=1:1  S PSJINT=$O(^PS(55,DFN,5,+PSJORDER,10,PSJINT),-1) Q:'PSJINT  S INTERVEN=$G(^PS(55,DFN,5,+PSJORDER,10,PSJINT,0)),PSJIDTM=$P(INTERVEN,"^",2) D
"RTN","PSGSICH1",110,0)
 .S:(II=1) PSJCNDT=$P(INTERVEN,"^",2) I $G(PSJCURIN)>0 Q:(PSJCNDT'=PSJIDTM)
"RTN","PSGSICH1",111,0)
 .D ONEINTER^PSGSICH(INTERVEN,PSJORDER,PSJIDTM,.OUTARRAY)
"RTN","PSGSICH1",112,0)
 I PSJORDER["V" F II=1:1  S PSJINT=$O(^PS(55,DFN,"IV",+PSJORDER,8,PSJINT),-1) Q:'PSJINT  S INTERVEN=$G(^PS(55,DFN,"IV",+PSJORDER,8,PSJINT,0)),PSJIDTM=$P(INTERVEN,"^",2) D
"RTN","PSGSICH1",113,0)
 .S:(II=1) PSJCNDT=$P(INTERVEN,"^",2) I $G(PSJCURIN)>0 Q:(PSJCNDT'=PSJIDTM)
"RTN","PSGSICH1",114,0)
 .D ONEINTER^PSGSICH(INTERVEN,PSJORDER,PSJIDTM,.OUTARRAY)
"RTN","PSGSICH1",115,0)
 K PSJCURIN
"RTN","PSGSICH1",116,0)
 Q
"RTN","PSGSICH1",117,0)
 ;
"RTN","PSGSICH1",118,0)
OVRCHK(PSGP,PSGORD) ; If any Provider Overrides or Pharmacy Interventions exist for order, return 1, otherwise return 0.
"RTN","PSGSICH1",119,0)
 ; INPUT: PATIENT - Patient DFN
"RTN","PSGSICH1",120,0)
 ;          ORDER - Inpatient order
"RTN","PSGSICH1",121,0)
 Q:$D(^TMP("PSJINTER",$J)) 1
"RTN","PSGSICH1",122,0)
 Q:'$G(PSGORD) 0
"RTN","PSGSICH1",123,0)
 N TMPOC,TMPOCI,TMPFLG,FOUND,TMPOUTAR
"RTN","PSGSICH1",124,0)
 I '$G(DFN) N DFN S DFN=PSGP
"RTN","PSGSICH1",125,0)
 I $$INTCHKO(PSGP,PSGORD) Q 1
"RTN","PSGSICH1",126,0)
 K TMPOUTAR D GETPROVL(PSGP,PSGORD,.TMPOUTAR)
"RTN","PSGSICH1",127,0)
 I $O(TMPOUTAR("PROV","")) K TMPOUTAR Q 1
"RTN","PSGSICH1",128,0)
 Q:$G(FOUND) 1
"RTN","PSGSICH1",129,0)
 Q 0
"RTN","PSGSICH1",130,0)
 ;
"RTN","PSGSICH1",131,0)
INTCHKO(PSGP,PSGORD) ; If CRITICAL DRUG or ALLERGY Intervention exists for Inpatient order, return 1, otherwise return 0.
"RTN","PSGSICH1",132,0)
 ; INPUT: PATIENT - Patient DFN
"RTN","PSGSICH1",133,0)
 ;          PSGORD - Inpatient order
"RTN","PSGSICH1",134,0)
 N FOUND,PSJCRAL,II,PATIENT S FOUND=0
"RTN","PSGSICH1",135,0)
 I PSGORD["P" S II=0 F  S II=$O(^PS(53.1,+PSGORD,11,II)) Q:'II!FOUND  D
"RTN","PSGSICH1",136,0)
 .S INTERVEN=$G(^PS(53.1,+PSGORD,11,II,0)) S FOUND=$$INTCHK(+INTERVEN)
"RTN","PSGSICH1",137,0)
 I PSGORD["U" S II=0 F  S II=$O(^PS(55,PSGP,5,+PSGORD,10,II)) Q:'II!FOUND  D
"RTN","PSGSICH1",138,0)
 .S INTERVEN=$G(^PS(55,PSGP,5,+PSGORD,10,II,0)) S FOUND=$$INTCHK(+INTERVEN)
"RTN","PSGSICH1",139,0)
 I PSGORD["V" S II=0 F  S II=$O(^PS(55,PSGP,"IV",+PSGORD,8,II)) Q:'II!FOUND  D
"RTN","PSGSICH1",140,0)
 .S INTERVEN=$G(^PS(55,PSGP,"IV",+PSGORD,8,II,0)) S FOUND=$$INTCHK(+INTERVEN)
"RTN","PSGSICH1",141,0)
 Q FOUND
"RTN","PSGSICH1",142,0)
 ;
"RTN","PSGSICH1",143,0)
INTCHK(INT) ; If classification of specific intervention is CRITICAL DRUG or ALLERGY/ADR, return 1, otherwise return 0
"RTN","PSGSICH1",144,0)
 ; INPUT: INT - Intervention IEN from the APSP Intervention (#9009032.4) file
"RTN","PSGSICH1",145,0)
 Q:'$G(INT) 0
"RTN","PSGSICH1",146,0)
 K PSJCRAL S PSJCRAL=0
"RTN","PSGSICH1",147,0)
 I ",6,18,"[(","_$P($G(^APSPQA(32.4,+INT,0)),"^",7)_",") S PSJCRAL=1
"RTN","PSGSICH1",148,0)
 Q PSJCRAL
"RTN","PSGSICH1",149,0)
 ;
"RTN","PSGSICH1",150,0)
BANNER(BANNER,PSJINDEN) ; Display Provider or Pharmacist Banner
"RTN","PSGSICH1",151,0)
 W ! K PSJDSPLN S $P(PSJDSPLN,"=",76)="=" W !,PSJDSPLN S ILCNT=$G(ILCNT)+1
"RTN","PSGSICH1",152,0)
 S PSJL="** "_BANNER_" **" W !?PSJINDEN,PSJL,!,PSJDSPLN S ILCNT=$G(ILCNT)+2
"RTN","PSGSICH1",153,0)
 S PSJL=""
"RTN","PSGSICH1",154,0)
 Q
"RTN","PSGSICH1",155,0)
 ;
"RTN","PSGSICH1",156,0)
STOREINT ; Store Intervention pointer to Inpatient order
"RTN","PSGSICH1",157,0)
 Q:$G(ERR)=1
"RTN","PSGSICH1",158,0)
 I '$G(PSGORD) N PSGORD S PSGORD=$S($G(ON):ON,$G(PSJORD):PSJORD,1:"")
"RTN","PSGSICH1",159,0)
 Q:'PSGORD
"RTN","PSGSICH1",160,0)
 N ACT,X,Y,INTII,PSJINTFL,INTIINUM,PSJINVDT,PSIVKEEP S PSJINTFL=0
"RTN","PSGSICH1",161,0)
 I $G(PSGOORD)["U" S PSJINTFL=$G(^PS(55,PSGP,5,+PSGOORD,10,1,0)) I PSJINTFL,'$D(^TMP("PSJINTER",$J)) D
"RTN","PSGSICH1",162,0)
 .;Don't carry over old interventions if OI changed
"RTN","PSGSICH1",163,0)
 .I $G(PSGORD)["P" Q:(+$G(^PS(55,PSGP,5,+PSGOORD,.2))'=+$G(^PS(53.1,+PSGORD,.2)))
"RTN","PSGSICH1",164,0)
 .; Don't carry over old interventions if OI changed
"RTN","PSGSICH1",165,0)
 .I $G(PSGORD)["U" Q:(+$G(^PS(55,PSGP,5,+PSGOORD,.2))'=+$G(^PS(55,PSGP,5,+PSGORD,.2)))
"RTN","PSGSICH1",166,0)
 .S INTII="A" F  S INTII=$O(^PS(55,PSGP,5,+PSGOORD,10,INTII),-1) Q:'INTII  S INTIINUM=$G(^(INTII,0)) I INTIINUM S ^TMP("PSJINTER",$J,+INTIINUM)=$P(INTIINUM,"^",2)_"^"_+$G(^PS(55,PSGP,5,+PSGOORD,.2))
"RTN","PSGSICH1",167,0)
 I $G(PSGOORD)["P" S PSJINTFL=$G(^PS(53.1,+PSGOORD,11,1,0)) I PSJINTFL,'$D(^TMP("PSJINTER",$J)) D
"RTN","PSGSICH1",168,0)
 .I $G(PSGORD)["P" Q:(+$G(^PS(53.1,+PSGOORD,.2))'=+$G(^PS(53.1,+PSGORD,.2)))  ; Don't carry over old interventions if OI changed
"RTN","PSGSICH1",169,0)
 .I $G(PSGORD)["U" Q:(+$G(^PS(53.1,+PSGOORD,.2))'=+$G(^PS(55,PSGP,5,+PSGORD,.2)))  ; Don't carry over old interventions if OI changed
"RTN","PSGSICH1",170,0)
 .S INTII="A" F  S INTII=$O(^PS(53.1,+PSGOORD,11,INTII),-1) Q:'INTII  S INTIINUM=$G(^(INTII,0)) I INTIINUM S ^TMP("PSJINTER",$J,+INTIINUM)=$P(INTIINUM,"^",2)_"^"_+$G(^PS(53.1,+PSGOORD,.2))
"RTN","PSGSICH1",171,0)
 I $D(^TMP("PSJINTER",$J)),$G(PSGORD)["V",$D(^PS(55,PSGP,"IV",+PSGORD,8)) S PSIVKEEP=1 Q
"RTN","PSGSICH1",172,0)
 I $D(^TMP("PSJINTER",$J)) S PSJINTER=0 F  S PSJINTER=$O(^TMP("PSJINTER",$J,PSJINTER)) Q:'PSJINTER  D
"RTN","PSGSICH1",173,0)
 .N DR,DA,DIC,DIE,DD,DINUM,DO,KK N PSJOLIDT S PSJINVDT=+$G(^TMP("PSJINTER",$J,PSJINTER)) S:'PSJINVDT PSJINVDT=$G(PSGDT)
"RTN","PSGSICH1",174,0)
 .I ($G(PSGORD)["V") N PSJIVODT S PSJIVODT=+$G(^PS(55,PSGP,"IV",+PSGORD,2)) I +$G(PSJINVDT)>(PSJIVODT)&($$FMDIFF^XLFDT(PSJINVDT,PSJIVODT,2)>90) S PSIVKEEP=1 Q
"RTN","PSGSICH1",175,0)
 .I (PSGORD["V")!((PSGORD["P")&$D(^PS(53.1,+PSGORD,"AD"))) Q:'$$CHKADD^PSGSICH(PSJINTER,PSGP,PSGORD)
"RTN","PSGSICH1",176,0)
 .I PSGORD["P" D
"RTN","PSGSICH1",177,0)
 ..N IC,IG S (IG,IC)=0 F  Q:$G(IG)  S IC=$O(^PS(53.1,+PSGORD,11,IC)) Q:'IC!$G(IG)  S:(+$G(^PS(53.1,+PSGORD,11,IC,0))=+PSJINTER) IG=1
"RTN","PSGSICH1",178,0)
 ..Q:$G(IG)  S DIC="^PS(53.1,"_+PSGORD_",11,",KK=$P($G(^PS(53.1,+PSGORD,11,0)),"^",3)+1 S DIC(0)="L",DIC("P")="53.13PA",DINUM=KK,DA(2)=+PSGORD,DA(1)=KK
"RTN","PSGSICH1",179,0)
 ..S X=+PSJINTER S DIC("DR")=".01////"_+PSJINTER_";1////"_PSJINVDT_";" D FILE^DICN
"RTN","PSGSICH1",180,0)
 .I PSGORD["U" D
"RTN","PSGSICH1",181,0)
 ..S DIC="^PS(55,"_PSGP_",5,"_+PSGORD_",10," S KK=$P($G(^PS(55,PSGP,5,+PSGORD,10,0)),"^",3)+1 S DIC(0)="L",DIC("P")="55.6132PA"
"RTN","PSGSICH1",182,0)
 ..S DINUM=KK,DA(2)=PSGP,DA(1)=+PSGORD S X=+PSJINTER S DIC("DR")=".01////"_+PSJINTER_";1////"_PSJINVDT_";" D FILE^DICN
"RTN","PSGSICH1",183,0)
 .I PSGORD["V" D
"RTN","PSGSICH1",184,0)
 ..S DIC="^PS(55,"_PSGP_",""IV"","_+PSGORD_",8," S KK=$P($G(^PS(55,PSGP,"IV",+PSGORD,8,0)),"^",3)+1 S DIC(0)="L",DIC("P")="55.1153PA"
"RTN","PSGSICH1",185,0)
 ..S DINUM=KK,DA(2)=PSGP,DA(1)=+PSGORD S X=+PSJINTER S DIC("DR")=".01////"_+PSJINTER_";1////"_PSJINVDT_";" D FILE^DICN
"RTN","PSGSICH1",186,0)
 Q:$G(PSIVKEEP)
"RTN","PSGSICH1",187,0)
 K ^TMP("PSJINTER",$J)
"RTN","PSGSICH1",188,0)
 Q
"RTN","PSGSICH1",189,0)
 ;
"RTN","PSGSICH1",190,0)
SETIVINT ; Move intervention pointers from one order to another during finishing
"RTN","PSGSICH1",191,0)
 Q:$G(ERR)=1  ; Order failed validation, don't move interventions
"RTN","PSGSICH1",192,0)
 N DA,DIC,DR
"RTN","PSGSICH1",193,0)
 I $G(PSGORD)["P" D  K ^TMP("PSJINTER",$J) Q
"RTN","PSGSICH1",194,0)
 .I ($G(ON)["V")!($G(ON)["P") D SETIVIN2^PSGSICH(PSGORD,ON) Q
"RTN","PSGSICH1",195,0)
 I $G(PSJORD)["V" D
"RTN","PSGSICH1",196,0)
 .I $G(ON)["P"!(($G(ON)["V")&($G(ON)'=$G(PSJORD))) D SETIVIN2^PSGSICH(PSJORD,ON) Q
"RTN","PSGSICH1",197,0)
 I $G(PSJORD)["P" D
"RTN","PSGSICH1",198,0)
 .I ($G(ON)["V")!($G(ON)["P") D SETIVIN2^PSGSICH(PSJORD,ON) Q
"RTN","PSGSICH1",199,0)
 K ^TMP("PSJINTER",$J)
"RTN","PSGSICH1",200,0)
 Q
"RTN","PSGSICH1",201,0)
 ;
"RTN","PSGSICH1",202,0)
SETUDINT(PSJU1,PSJU2) ; Store Intervention pointers in the UD intervention multiple
"RTN","PSGSICH1",203,0)
 ; INPUT: PSJU1 - Inpatient order from which to copy intervention pointer(s)
"RTN","PSGSICH1",204,0)
 ;        PSJU2 - Inpatient order to copy intervention pointer(s) to
"RTN","PSGSICH1",205,0)
 Q:'$G(DFN)  N DA,DIC,PSJINTER,PSJINCNT,PSJNXTI,DO
"RTN","PSGSICH1",206,0)
 I '$G(PSGDT) N PSGDT D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSGSICH1",207,0)
 I PSJU1["P" D
"RTN","PSGSICH1",208,0)
 .I $G(PSJU2)["P" I $D(^PS(53.1,+PSJU1,11,0)),$D(^PS(53.1,+$G(PSJU2),0)) S PSJINCNT=+$P($G(^PS(53.1,+PSJU2,11,0)),"^",3) D  Q
"RTN","PSGSICH1",209,0)
 ..S PSJNXTI=0 F  S PSJNXTI=$O(^PS(53.1,+$G(PSJU1),11,PSJNXTI)) Q:'PSJNXTI  S PSJINCNT=$G(PSJINCNT)+1 D
"RTN","PSGSICH1",210,0)
 ...S PSJINTER=$G(^PS(53.1,+$G(PSJU1),11,PSJNXTI,0)) Q:'PSJINTER  Q:$D(^PS(53.1,+PSJU2,11,"B",+PSJINTER))
"RTN","PSGSICH1",211,0)
 ...S DIC="^PS(53.1,"_+PSJU2_",11,",DIC(0)="L",DIC("P")="53.13PA",DINUM=PSJINCNT,DA(1)=+PSJU2,DA=PSJINCNT
"RTN","PSGSICH1",212,0)
 ...S X=+PSJINTER,DIC("DR")=".01////"_+PSJINTER_";1////"_$G(PSGDT)_";" D FILE^DICN
"RTN","PSGSICH1",213,0)
 .I '$G(PSJU2) S PSJU2=$P($G(^PS(53.1,+PSJU1,0)),"^",19) Q:'PSJU2  S PSJU2=PSJU2_"U"
"RTN","PSGSICH1",214,0)
 .Q:(+$G(^PS(53.1,+PSJU1,.2))'=+$G(^PS(55,DFN,5,+PSJU2,.2)))  ; Don't carry over old interventions if OI changed
"RTN","PSGSICH1",215,0)
 .I $D(^PS(53.1,+PSJU1,11,0)),$D(^PS(55,DFN,5,+PSJU2,0)) S PSJINCNT=+$P($G(^PS(55,DFN,5,+PSJU2,10,0)),"^",3) D
"RTN","PSGSICH1",216,0)
 ..S PSJNXTI=0 F  S PSJNXTI=$O(^PS(53.1,+$G(PSJU1),11,PSJNXTI)) Q:'PSJNXTI  S PSJINCNT=$G(PSJINCNT)+1 D
"RTN","PSGSICH1",217,0)
 ...S PSJINTER=$G(^PS(53.1,+$G(PSJU1),11,PSJNXTI,0)) Q:'PSJINTER  Q:$D(^PS(55,DFN,5,+$G(PSJU2),10,"B",+PSJINTER))
"RTN","PSGSICH1",218,0)
 ...S DIC="^PS(55,"_+DFN_",5,"_+PSJU2_",10,",DIC(0)="L",DIC("P")="55.6132PA",DA(1)=+PSJU2,DA(2)=DFN,(DINUM,X)=+PSJINCNT
"RTN","PSGSICH1",219,0)
 ...S DIC("DR")=".01////"_+PSJINTER_";1////"_$P(PSJINTER,"^",2)_";" D FILE^DICN
"RTN","PSGSICH1",220,0)
 K ^TMP("PSJINTER",$J)
"RTN","PSGSICH1",221,0)
 Q
"RTN","PSGSICH1",222,0)
 ;
"RTN","PSGSICH1",223,0)
ASKDISP() ; If Provider Overrides or Pharmacy Interventions exist, prompt user to display all.
"RTN","PSGSICH1",224,0)
 N DIR,X,Y
"RTN","PSGSICH1",225,0)
 I $G(PSJORD) Q:'$$OVRCHK($G(DFN),PSJORD) 0
"RTN","PSGSICH1",226,0)
 I $G(PSJNEWOE),'$$ORDEXIST^PSGSICH(DFN,PSJORD) Q 0
"RTN","PSGSICH1",227,0)
 W ! S DIR(0)="E",DIR("A")="Order Check Overrides/Interventions exist for this order. Display? (Y/N)",DIR("B")="Y",DIR(0)="Y" D ^DIR S:$G(Y)="" Y=1
"RTN","PSGSICH1",228,0)
 Q $S(Y=1:1,1:0)
"RTN","PSIV")
0^16^B30874670
"RTN","PSIV",1,0)
PSIV ;BIR/PR,MLM - MISC UTILITIES ;3/19/99 9:45 AM
"RTN","PSIV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**7,16,29,38,53,56,72,58,110,181,267,275,281**;16 DEC 97;Build 113
"RTN","PSIV",3,0)
 ;
"RTN","PSIV",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIV",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA 2789
"RTN","PSIV",6,0)
 ; Reference to ^%DTC is supported by DBIA 10000
"RTN","PSIV",7,0)
 ; Reference to ^DIC is supported by DBIA 10006
"RTN","PSIV",8,0)
 ; Reference to ^DIE is supported by DBIA 10018
"RTN","PSIV",9,0)
 ; Reference to ^DIR is supported by DBIA 10026
"RTN","PSIV",10,0)
 ; Reference to ^VALM is supported by DBIA 10118
"RTN","PSIV",11,0)
 ; Reference to ^VALM1 is supported by DBIA 10116
"RTN","PSIV",12,0)
 ;
"RTN","PSIV",13,0)
ENGETP ;Enter here to select patient.
"RTN","PSIV",14,0)
 K DIC S DIC("W")="W ""  "",$P(^(0),""^"",9) W:$D(^(.1)) ""  "",^(.1)",DIC="^DPT(",DIC(0)="QEM"
"RTN","PSIV",15,0)
 D FULL^VALM1
"RTN","PSIV",16,0)
GETP1 ;
"RTN","PSIV",17,0)
 ;NEW arrays use in order checks
"RTN","PSIV",18,0)
 NEW PSJEXCPT,PSJOCER
"RTN","PSIV",19,0)
 S PSGPTMP=0,PPAGE=1,DFN=-1,X="Select PATIENT:^^^^1" D ENQ Q:"^"[X
"RTN","PSIV",20,0)
 D EN^PSJDPT
"RTN","PSIV",21,0)
 I Y<0 G ENGETP
"RTN","PSIV",22,0)
 N PSGP,PSJACNWP S (PSGP,DFN)=+Y D ENBOTH^PSJAC S PSJORL=$$ENORL^PSJUTL($G(VAIN(4)))
"RTN","PSIV",23,0)
 Q
"RTN","PSIV",24,0)
 ;
"RTN","PSIV",25,0)
ENYN ;Enter here for yes/no responses. This is a general reader that I have
"RTN","PSIV",26,0)
 ;been phasing out with ^DICN
"RTN","PSIV",27,0)
 S X=X_"^Y:YES;N:NO^YES,NO"
"RTN","PSIV",28,0)
 ;
"RTN","PSIV",29,0)
ENQ ;Enter here to read X. This is the general reader that I have
"RTN","PSIV",30,0)
 ;been slowly phasing out
"RTN","PSIV",31,0)
 S QUD=$P(X,"^",2) W !!,$P(X,"^")," " W:QUD]"" QUD,"// " R QUX:DTIME W:'$T $C(7) S:'$T QUX="^" S:QUX="" QUX=QUD I QUX["^"!(QUX["?") G KILL
"RTN","PSIV",32,0)
 I $L(QUX)>500 W "    ??" G ENQ
"RTN","PSIV",33,0)
 S:QUX?1L QUX=$C($A(QUX)-32)
"RTN","PSIV",34,0)
 S QUD=";"_$P(X,"^",3)_";" G:QUD'[(";"_QUX_":") VAR S QUX1=$E(QUD,$F(QUD,QUX_":"),($F(QUD,";",$F(QUD,QUX_":"))-2)) G:QUX1[":" VAR W "    ",QUX1 G KILL
"RTN","PSIV",35,0)
VAR F QUX1=1:1 S QUD=$P($P(X,"^",4),",",QUX1) Q:QUD=""  I $P(QUD,QUX)="" W $S($P(X,"^",2)=QUX:"    "_QUX,1:"")_$P(QUD,QUX,2,99) S QUX=QUD G KILL
"RTN","PSIV",36,0)
PAT I $P(X,"^",5)]"",@$P(X,"^",5,999) G KILL
"RTN","PSIV",37,0)
 W $C(7)," ???" G ENQ
"RTN","PSIV",38,0)
KILL S X=QUX K QUX,QUX1,QUD,PSJDCEXP Q
"RTN","PSIV",39,0)
 ;
"RTN","PSIV",40,0)
ENADM ;Edit administration schedules.
"RTN","PSIV",41,0)
 ; reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIV",42,0)
 S DIC="^PS(51.1,",DIC(0)="QEAML",DLAYGO=51.1 D ^DIC K:+Y<0 %,DA,D0,DIC,DIE,DLAYGO,DR,Z,Y Q:'$D(Y)  S DIE=DIC,DR=".01;1",DA=+Y K DIC D ^DIE G ENADM
"RTN","PSIV",43,0)
 ;
"RTN","PSIV",44,0)
ENOW D NOW^%DTC S Y=% K %,%H,%I
"RTN","PSIV",45,0)
 Q
"RTN","PSIV",46,0)
 ;
"RTN","PSIV",47,0)
ENC ;Get unit of measure for drug selected.
"RTN","PSIV",48,0)
 S X=$P($P(";"_$P(Y,U,3),";"_X_":",2),";")
"RTN","PSIV",49,0)
 Q
"RTN","PSIV",50,0)
 ;
"RTN","PSIV",51,0)
ENCHS ;Needs PSIVBR (Branch point)
"RTN","PSIV",52,0)
 D ENGETP G:DFN<0 Q
"RTN","PSIV",53,0)
 ;* Lock patient if calling FROM PSJI DELETE ORDER.
"RTN","PSIV",54,0)
 I PSIVBR="D ENT^PSIVPGE",('$$L^PSSLOCK(DFN,1)) Q
"RTN","PSIV",55,0)
OE N CONT S CONT=0
"RTN","PSIV",56,0)
 F  Q:CONT  D ENCHS1
"RTN","PSIV",57,0)
 Q:$D(ORVP)
"RTN","PSIV",58,0)
 G ENCHS
"RTN","PSIV",59,0)
ENCHS1 ;
"RTN","PSIV",60,0)
 I '($$AA^PSJDPT(DFN)>0) S CONT=1 Q
"RTN","PSIV",61,0)
 S PSJORQF=0,CONT=0
"RTN","PSIV",62,0)
 S PSJPROT=2,PSJOL="",(PSGOP,PSGP)=DFN
"RTN","PSIV",63,0)
 K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSIV",64,0)
 S VALMCNT=30
"RTN","PSIV",65,0)
 I PSIVBR="D PROCESS^PSIVRD",(PSJOL="N") D ORDNO^PSIVRD Q
"RTN","PSIV",66,0)
 I $G(PSJNEWOE) S PSJOL="S"
"RTN","PSIV",67,0)
 I PSJOL="S"!(PSJOL="L") F  Q:CONT  S P("PT")=PSJOL D
"RTN","PSIV",68,0)
 . S PSJORQF=0,PSJNEWOE=0
"RTN","PSIV",69,0)
 . D ENNB^PSIVACT
"RTN","PSIV",70,0)
 . I '$D(^TMP("PSIV",$J)) D FULL^VALM1 W !!,?30,"NO ORDERS FOUND",! K DIR S DIR(0)="E" D ^DIR W @IOF S CONT=0
"RTN","PSIV",71,0)
 . NEW PSJIVPRF S PSJIVPRF=1
"RTN","PSIV",72,0)
 . S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSIV",73,0)
 . D EN^VALM("PSJ LM IV OE")
"RTN","PSIV",74,0)
 . I $G(VALMBCK)="Q" Q
"RTN","PSIV",75,0)
 . S CONT=1
"RTN","PSIV",76,0)
 ;* Unlock patient if come from PSJI DELETE ORDER
"RTN","PSIV",77,0)
 I '$G(PSJORQF) S CONT=1
"RTN","PSIV",78,0)
 I PSIVBR="D ENT^PSIVPGE" D UL^PSSLOCK(DFN)
"RTN","PSIV",79,0)
 K PSJLMPRO
"RTN","PSIV",80,0)
 Q
"RTN","PSIV",81,0)
SELSO ;SELECT ORDER USING "SO" OPTION
"RTN","PSIV",82,0)
 S PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON,OV
"RTN","PSIV",83,0)
 Q
"RTN","PSIV",84,0)
SELNUM ;SELECT ORDERS WITH NUMBERS
"RTN","PSIV",85,0)
 S PSGLMT=^TMP("PSJPRO",$J,0),X=$P(XQORNOD(0),"=",2) D ENCHK^PSGON,OV
"RTN","PSIV",86,0)
 Q
"RTN","PSIV",87,0)
OV ;
"RTN","PSIV",88,0)
 I '$D(PSGODDD) S VALMBCK="R" Q
"RTN","PSIV",89,0)
 N DONE
"RTN","PSIV",90,0)
 F PSIVOV1=1:1:PSGODDD F PSIVOV2=1:1:$L(PSGODDD(PSIVOV1),",")-1 D
"RTN","PSIV",91,0)
 .S ON=+$P(PSGODDD(PSIVOV1),",",PSIVOV2)
"RTN","PSIV",92,0)
 .S ON=$$GTON(ON)
"RTN","PSIV",93,0)
 .Q:'ON!$G(DONE)
"RTN","PSIV",94,0)
 .D OV1
"RTN","PSIV",95,0)
 S VALMBCK="Q"
"RTN","PSIV",96,0)
 Q
"RTN","PSIV",97,0)
GTON(X) ;
"RTN","PSIV",98,0)
 ;Return the ON node from ^Tmp
"RTN","PSIV",99,0)
 I $G(X)="" Q ""
"RTN","PSIV",100,0)
 I $D(^TMP("PSIV",$J,"AB",X)) Q ^(X)
"RTN","PSIV",101,0)
 I $D(^TMP("PSIV",$J,"NB",X)) Q ^(X)
"RTN","PSIV",102,0)
 I $D(^TMP("PSIV",$J,"PB",X)) Q ^(X)
"RTN","PSIV",103,0)
 I $D(^TMP("PSIV",$J,"XB",X)) Q ^(X)
"RTN","PSIV",104,0)
 I $D(^TMP("PSIV",$J,"NDB",X)) Q ^(X)
"RTN","PSIV",105,0)
 I $D(^TMP("PSIV",$J,"PDB",X)) Q ^(X)
"RTN","PSIV",106,0)
 I $D(^TMP("PSIV",$J,"RDB",X)) Q ^(X)
"RTN","PSIV",107,0)
 ; clinic orders
"RTN","PSIV",108,0)
 N REF,REF2,PSJCLND S (REF,REF2,PSJCLND)="" F  S PSJCLND=$O(^TMP("PSIV",$J,PSJCLND)) Q:($G(REF)]"")  D
"RTN","PSIV",109,0)
 .I $P(PSJCLND,"^",4)="AB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",110,0)
 .I $P(PSJCLND,"^",4)="NB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",111,0)
 .I $P(PSJCLND,"^",4)="PB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",112,0)
 .I $P(PSJCLND,"^",4)="XB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",113,0)
 .I $P(PSJCLND,"^",4)="NDB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",114,0)
 .I $P(PSJCLND,"^",4)="PDB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",115,0)
 .I $P(PSJCLND,"^",4)="RDB" I $D(^TMP("PSIV",$J,PSJCLND,X)) S REF=^(X) Q
"RTN","PSIV",116,0)
 I ($G(REF)]"") Q REF
"RTN","PSIV",117,0)
 Q ""
"RTN","PSIV",118,0)
OV1 ;
"RTN","PSIV",119,0)
 ;PSJENHOC=1 if DI,DT were displayed. This will be used by dosing OC to check if error messages should display or not
"RTN","PSIV",120,0)
 NEW PSJDSVFY,PSJENHOC
"RTN","PSIV",121,0)
 S (ON,ON55,P("PON"))=9999999999-ON_$S(ON["V":"V",1:"P")
"RTN","PSIV",122,0)
 I PSIVBR["D ^PSIVVW1" D
"RTN","PSIV",123,0)
 . S VALMSG="Select either ""AL"" , ""LL"" or ""AL,LL"" for both"
"RTN","PSIV",124,0)
 . S PSJORD=ON D EN^PSJLIPRF
"RTN","PSIV",125,0)
 E  D
"RTN","PSIV",126,0)
 . I PSIVBR="D ^PSIVOPT",'($$LS^PSSLOCK(PSGP,ON)) Q
"RTN","PSIV",127,0)
 . X PSIVBR
"RTN","PSIV",128,0)
 . D:PSIVBR="D ^PSIVOPT" UNL^PSSLOCK(PSGP,ON)
"RTN","PSIV",129,0)
 K:'$D(DUOUT)&($G(Y)'=-1) DONE
"RTN","PSIV",130,0)
 Q
"RTN","PSIV",131,0)
 ;
"RTN","PSIV",132,0)
 ;
"RTN","PSIV",133,0)
ENU ;Get IV additive strength. Called from templates.
"RTN","PSIV",134,0)
 N Y S Y=+^PS(55,DA(2),"IV",DA(1),"AD",DA,0),PSIVSTR=$$ENU^PSIVUTL(Y)
"RTN","PSIV",135,0)
 Q
"RTN","PSIV",136,0)
Q ;
"RTN","PSIV",137,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSIV",138,0)
 K ^TMP("PSIV",$J),^TMP("PSJ",$J),^TMP("PSJPRO",$J),^TMP("PSJALL",$J),^TMP("PSJI",$J),^TMP("PSJON",$J)
"RTN","PSIV",139,0)
 K DRG,DRGI,DRGN,DRGT,ERR,I,JJ,MI,N,N2,ON,ON55,P,P1,P3,P16,P17,PNOW,PS,PSGODD,PSGODDD,PSIV,PSIVAAT,PSIVACT,PSIVADM,PSIVAT
"RTN","PSIV",140,0)
 K PSIVC,PSIVDT,PSIVFLAG,PSIVLN,PSIVNOW,PSIVNU,PSIVON,PSIVOV1,PSIVOV2,PSIVREA,PSIVSTR,PSIVSTRT,PSIVNOL,PSIVTYPE,PSJNKF
"RTN","PSIV",141,0)
 K PSJORF,PSJORIFN,RDWARD,START,STOP,SCHED,USER,V,XT,DUOUT,DTOUT
"RTN","PSIV",142,0)
 K %,%I,DIC,PSIVC,PSIVNU,PSIVON,PSIVREA,PSIVOV1,PSIVOV2,RDWARD,V,VAERR,VW,X,X2,Y,Y1,Z,Z1,Z2
"RTN","PSIV",143,0)
 Q
"RTN","PSIVEDRG")
0^33^B50902632
"RTN","PSIVEDRG",1,0)
PSIVEDRG ;BIR/MLM-ENTER/EDIT DRUGS FOR IV ORDER ;16 Mar 99 / 2:14 PM
"RTN","PSIVEDRG",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**21,33,50,65,74,84,128,147,181,263,281**;16 DEC 97;Build 113
"RTN","PSIVEDRG",3,0)
 ;
"RTN","PSIVEDRG",4,0)
 ; References to ^PS(52.6 supported by DBIA# 1231.
"RTN","PSIVEDRG",5,0)
 ; References to ^PS(52.7 supported by DBIA# 2173.
"RTN","PSIVEDRG",6,0)
 ; Reference to EN^PSOORDRG supported by DBIA# 2190.
"RTN","PSIVEDRG",7,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA #6071.
"RTN","PSIVEDRG",8,0)
 ;
"RTN","PSIVEDRG",9,0)
DRG ; Edit Additive/Solution data
"RTN","PSIVEDRG",10,0)
 NEW DRGOC K PSGORQF ;If PSGORQF=1 abort order after order check. 2/25/15 - no longer NEW PSGORQF ;RTC 151046
"RTN","PSIVEDRG",11,0)
 K PSIVOLD S DRG(2)="" I $D(DRG(DRGT)) S DRGI=+$O(DRG(DRGT,0)) I DRGI S PSIVOLD=1 D SETDRG
"RTN","PSIVEDRG",12,0)
DRG1 ;
"RTN","PSIVEDRG",13,0)
 Q:$G(PSGORQF)
"RTN","PSIVEDRG",14,0)
 I $G(X)="?" K DUOUT
"RTN","PSIVEDRG",15,0)
 D FULL^VALM1
"RTN","PSIVEDRG",16,0)
 W !,"Select ",DRGTN,": "
"RTN","PSIVEDRG",17,0)
 I DRGT=$G(PSIVOI),($G(PSIVOI("DILIST",0))>1) D GTADSOL Q
"RTN","PSIVEDRG",18,0)
 W:DRG(2)]"" DRG(2),"//" R X:DTIME S:'$T X="^" S:X=U DONE=1 I X["^"!(X=""&(DRG(2)="")) D CHKSCMNT Q
"RTN","PSIVEDRG",19,0)
DRG1A I X="" W !,DRGTN,": ",DRG(2),"//" R X:DTIME S:'$T X="^" D:X="^" CHKSCMNT Q:X="^"  I X="" S Y=1 D DRG3 G:DRGT="AD"!($G(P(4))="H") DRG1 Q
"RTN","PSIVEDRG",20,0)
 I X="@",DRG(2)]"" D DEL G:%'=1 DRG1A K DRG(DRGT,DRGI),^TMP("PSODAOC",$J) S DRGI=+$O(DRG(DRGT,0)) S:'DRGI DRG(DRGT,0)=0 D SETDRG G DRG1
"RTN","PSIVEDRG",21,0)
 I X["???",($E(P("OT"))="M"),(PSIVAC["C") D ORFLDS^PSIVEDT1 G DRG1
"RTN","PSIVEDRG",22,0)
 I X'["?" S %=0 D:$D(DRG(DRGT)) CHK G:%=1 DRG1A D DRG2 Q:$G(Y)>0&($G(P(4))'="H"&(DRGT="SOL"))  G DRG1
"RTN","PSIVEDRG",23,0)
 I $D(DRG(DRGT)) W !,"This order includes the following ",DRGTN,"S:",! F Y=0:0 S Y=$O(DRG(DRGT,Y)) Q:'Y  W !,$P(DRG(DRGT,Y),U,2)
"RTN","PSIVEDRG",24,0)
 W !,"YOU MAY ENTER A NEW ",DRGTN,", IF YOU WISH",! D GTSCRN(X) S DIC(0)="EQM" D ^DIC K DIC G DRG1
"RTN","PSIVEDRG",25,0)
 Q
"RTN","PSIVEDRG",26,0)
 ;
"RTN","PSIVEDRG",27,0)
SETDRG ; Put Drug data into DRG(x).
"RTN","PSIVEDRG",28,0)
 F X=1:1:6 S DRG(X)=$P(DRG(DRGT,DRGI),U,X)
"RTN","PSIVEDRG",29,0)
 S X="" I DRG(2)="",DRG(1) S DRG(2)="*** Undefined ***"
"RTN","PSIVEDRG",30,0)
 Q
"RTN","PSIVEDRG",31,0)
DRG2 ;
"RTN","PSIVEDRG",32,0)
 D GTSCRN(X) N PSIVX S PSIVX=X,DIC(0)="EQMZ" D ^DIC K DIC Q:Y<0
"RTN","PSIVEDRG",33,0)
 S PSJIVIEN=+Y
"RTN","PSIVEDRG",34,0)
 NEW PSJNF D NFIV^PSJDIN($S(DRGT="AD":52.6,1:52.7),+PSJIVIEN,.PSJNF)
"RTN","PSIVEDRG",35,0)
 W PSJNF("NF")
"RTN","PSIVEDRG",36,0)
 S PSIVNEW=1,DRGTMP=+Y_U_$P(Y(0),U)_U_$S(DRGT="SOL":$P(Y(0),U,3),1:"")_U_U_$P(Y(0),U,13)_U_$P(Y(0),U,11)
"RTN","PSIVEDRG",37,0)
 I '$D(ON55) NEW ON55 S ON55=ON
"RTN","PSIVEDRG",38,0)
 D ORDERCHK(DFN,ON55,1) I $G(PSGORQF) S X=U,DONE=1 Q
"RTN","PSIVEDRG",39,0)
 D DINIV^PSJDIN($S(DRGT="AD":52.6,1:52.7),+DRGTMP)
"RTN","PSIVEDRG",40,0)
 S (DRG(DRGT,0),DRGI)=$G(DRG(DRGT,0))+1,DRG(DRGT,DRGI)=DRGTMP K PSIVOLD
"RTN","PSIVEDRG",41,0)
 I (PSIVAC="PN"!(PSIVAC="CF")),(DRGT="AD"),$D(^PS(52.6,"C",PSIVX,+DRGTMP)) D ^PSIVQUI Q:$G(PSIVSTR)="QUICK CODE"!$G(PSGORQF)
"RTN","PSIVEDRG",42,0)
DRG3 ;
"RTN","PSIVEDRG",43,0)
 D:DRG(2)]"" DINIV^PSJDIN(FIL,+DRG(1))
"RTN","PSIVEDRG",44,0)
 D SETDRG
"RTN","PSIVEDRG",45,0)
 I DRGT="AD" S X=$P($G(^PS(FIL,+DRG(1),0)),U,3) W !!,"(The units of strength for this additive are in ",$$ENU^PSIVUTL(DRG(1)),")"
"RTN","PSIVEDRG",46,0)
AMT ;
"RTN","PSIVEDRG",47,0)
 I DRGT="SOL",'$G(PSIVOLD),($G(P(4))_$G(P(23))'["S") G DRG4
"RTN","PSIVEDRG",48,0)
1 ; Strength/Volume
"RTN","PSIVEDRG",49,0)
 W !,$S(DRGT="AD":"Strength: ",1:"Volume: ") W:+DRG(3) DRG(3),"//" R X:DTIME S:'$T X="^" Q:X="^"  G:X=""&DRG(3) 2 I X="" W $C(7),$S(DRGT="AD":"Strength",1:"Volume")," is REQUIRED!" G 1
"RTN","PSIVEDRG",50,0)
 D:$D(X) IT G:'$D(X)!($G(X)["?") AMT S DRG(3)=X I X="" D FIELD^DID($S(DRGT="AD":53.157,1:53.158),1,"","XECUTABLE HELP","PSJEX") X PSJEX("XECUTABLE HELP") K PSJEX G AMT
"RTN","PSIVEDRG",51,0)
2 ;
"RTN","PSIVEDRG",52,0)
 I DRGT="AD",$G(P("DTYP"))>1,P(4)'="S",P(23)'="S" K DIR S DIR(0)="53.157,2" S:DRG(4)]"" DIR("B")=DRG(4) D ^DIR Q:$D(DTOUT)!$D(DUOUT)  S:X="@" DRG(4)="" S:Y DRG(4)=Y
"RTN","PSIVEDRG",53,0)
DRG4 ;
"RTN","PSIVEDRG",54,0)
 F X=1:1:6 S $P(DRG(DRGT,DRGI),U,X)=DRG(X)
"RTN","PSIVEDRG",55,0)
 S DRG(2)=""
"RTN","PSIVEDRG",56,0)
 Q
"RTN","PSIVEDRG",57,0)
 ;
"RTN","PSIVEDRG",58,0)
CHKSCMNT ;
"RTN","PSIVEDRG",59,0)
 I $$SEECMENT() W !!,"*** One or more additives has 'See Comments' in the Bottle field.",!,"    Please correct.",!!
"RTN","PSIVEDRG",60,0)
 Q
"RTN","PSIVEDRG",61,0)
SEECMENT() ;
"RTN","PSIVEDRG",62,0)
 ;Return 1 if DRG array still contain "See Comments"
"RTN","PSIVEDRG",63,0)
 NEW PSIVDRGI,PSIVDRG0,PSIVFLG
"RTN","PSIVEDRG",64,0)
 S PSIVFLG=0
"RTN","PSIVEDRG",65,0)
 F PSIVDRGI=0:0 S PSIVDRGI=$O(DRG("AD",PSIVDRGI)) Q:'PSIVDRGI  Q:PSIVFLG  D
"RTN","PSIVEDRG",66,0)
 . S PSIVDRG0=$G(DRG("AD",PSIVDRGI))
"RTN","PSIVEDRG",67,0)
 . I $P(PSIVDRG0,U,4)="See Comments" S PSIVFLG=1
"RTN","PSIVEDRG",68,0)
 Q PSIVFLG
"RTN","PSIVEDRG",69,0)
GTSCRN(PSIVX) ;Set DIC("S") if MD OE or matching drug has already been selected.
"RTN","PSIVEDRG",70,0)
 D:"?"[PSIVX HOLDHDR^PSJOE
"RTN","PSIVEDRG",71,0)
 S X=PSIVX
"RTN","PSIVEDRG",72,0)
 K DA,DIC S DIC=FIL,DIC("S")=$$IVDRGSC^PSIVUTL
"RTN","PSIVEDRG",73,0)
 I $E(PSIVAC)'="P",($P(P("OT"),U)="F") S X(1)=" I $P(X(1),U,13)",DIC("S")=$G(DIC("S"))_$S(DRGT="AD":X(1),$E(PSIVAC)="O":X(1),1:"")
"RTN","PSIVEDRG",74,0)
 Q
"RTN","PSIVEDRG",75,0)
 ;
"RTN","PSIVEDRG",76,0)
IT ; Input Transform for Strength/Volume.
"RTN","PSIVEDRG",77,0)
 I X?1.N,$L(X)>20 S X="?"
"RTN","PSIVEDRG",78,0)
 I X["?" W $C(7) S F1=53.15_$S(DRGT="AD":7,1:8),F2=1 D ENHLP^PSIVORC1 Q
"RTN","PSIVEDRG",79,0)
 I DRGT="AD" K:X'?.6N0.1".".8N!('X) X I $D(X) S:(X<1)&($P(X,".")'=0) X=0_X S X=X_" "_$$ENU^PSIVUTL(DRG(1)) W "   ",X Q
"RTN","PSIVEDRG",80,0)
 I $D(X) K:X=""!(X'?.N0.1".".N)!(X>9999)!(X<.01) X I $D(X) S:(X<1)&($P(X,".")'=0) X=0_X S X=X_" ML" W "   ",X
"RTN","PSIVEDRG",81,0)
 W:'$D(X) $C(7),"??"
"RTN","PSIVEDRG",82,0)
 Q
"RTN","PSIVEDRG",83,0)
 ;
"RTN","PSIVEDRG",84,0)
ORDERCHK(DFN,ON,X) ; Do order check
"RTN","PSIVEDRG",85,0)
 ;* If X is define, include the DRG(X) to the order check
"RTN","PSIVEDRG",86,0)
 ;This module is no longer used as of PSJ*5*181
"RTN","PSIVEDRG",87,0)
 Q
"RTN","PSIVEDRG",88,0)
 I X M:$D(DRG) DRGOC(ON)=DRG
"RTN","PSIVEDRG",89,0)
 NEW TMPDRG,X,XX,Y,PSIVNEW,PSGDRG,PSGDRGN,PSJDD,PSGP
"RTN","PSIVEDRG",90,0)
 D SAVEDRG(.TMPDRG,.DRG) ;Store DRG array in TMPDRG array
"RTN","PSIVEDRG",91,0)
 S PSIVNEW=1,PSGDRGN=$P($G(DRGTMP),U,2)
"RTN","PSIVEDRG",92,0)
 S (PSJDD,PSGDRG)=$P(^PS(FIL,+DRGTMP,0),U,2),PSGP=DFN
"RTN","PSIVEDRG",93,0)
 I FIL="52.6"  D ENDDC^PSGSICHK(DFN,PSGDRG)
"RTN","PSIVEDRG",94,0)
 I FIL="52.7" D
"RTN","PSIVEDRG",95,0)
 . D EN^PSOORDRG(DFN,PSGDRG)
"RTN","PSIVEDRG",96,0)
 . N INTERVEN,PSJIREQ,PSJRXREQ S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSIVEDRG",97,0)
 . S DFN=PSGP K PSJPDRG
"RTN","PSIVEDRG",98,0)
 . D IVSOL^PSGSICHK
"RTN","PSIVEDRG",99,0)
 D SAVEDRG(.DRG,.TMPDRG) ;Restore DRG array from TMPDRG array
"RTN","PSIVEDRG",100,0)
 D ENSTOP^PSIVCAL
"RTN","PSIVEDRG",101,0)
 Q
"RTN","PSIVEDRG",102,0)
SAVEDRG(NEW,OLD)   ;Store/restore DRG array.
"RTN","PSIVEDRG",103,0)
 K NEW
"RTN","PSIVEDRG",104,0)
 S:$G(OLD) NEW=OLD
"RTN","PSIVEDRG",105,0)
 F X=0:0 S X=$O(OLD(X)) Q:'X  S NEW(X)=OLD(X)
"RTN","PSIVEDRG",106,0)
 F XX="AD","SOL" D
"RTN","PSIVEDRG",107,0)
 . I $D(OLD(XX,0))#10=1 S NEW(XX,0)=OLD(XX,0)
"RTN","PSIVEDRG",108,0)
 . F X=0:0 S X=$O(OLD(XX,X)) Q:'X  S NEW(XX,X)=OLD(XX,X)
"RTN","PSIVEDRG",109,0)
 Q
"RTN","PSIVEDRG",110,0)
 ;
"RTN","PSIVEDRG",111,0)
CHK ; Check if drug is already part of order
"RTN","PSIVEDRG",112,0)
 N DDONE,I,TDRG,TDRGP,J F TDRG=0:0 S TDRG=$O(DRG(DRGT,TDRG)) Q:'TDRG!$G(DDONE)  D
"RTN","PSIVEDRG",113,0)
 .I $$UPPER^VALM1($E($P(DRG(DRGT,+TDRG),U,2),1,$L(X)))=$$UPPER^VALM1(X) W $P($$UPPER^VALM1($P(DRG(DRGT,+TDRG),U,2)),$$UPPER^VALM1(X),2) D ASKCHK Q
"RTN","PSIVEDRG",114,0)
 .S TDRGP=$P(DRG(DRGT,TDRG),U) F J=0:0 S J=$O(^PS(FIL,TDRGP,3,J)) Q:'J!$G(DDONE)  I $$UPPER^VALM1($E($P(^PS(FIL,TDRGP,3,J,0),U),1,$L(X)))=$$UPPER^VALM1(X) D  D ASKCHK Q
"RTN","PSIVEDRG",115,0)
 ..W $P($$UPPER^VALM1($P(^PS(FIL,TDRGP,3,J,0),U)),$$UPPER^VALM1(X),2)," ",$P(DRG(DRGT,TDRG),U,2)
"RTN","PSIVEDRG",116,0)
 Q
"RTN","PSIVEDRG",117,0)
 ;
"RTN","PSIVEDRG",118,0)
ASKCHK ; Do you want a drug that was previously selected.
"RTN","PSIVEDRG",119,0)
 S I=DRG(DRGT,TDRG) W " ",$P(I,U,3),$S($P(I,U,4):" ("_$P(I,U,4)_")",1:""),!,"...OK" S %=1 D YN^DICN
"RTN","PSIVEDRG",120,0)
 I %=1 S X="",DRGI=TDRG,(DDONE,PSIVOLD)=1 D SETDRG Q
"RTN","PSIVEDRG",121,0)
 W !,X
"RTN","PSIVEDRG",122,0)
 Q
"RTN","PSIVEDRG",123,0)
 ;
"RTN","PSIVEDRG",124,0)
DEL ;
"RTN","PSIVEDRG",125,0)
 W !?3,"SURE YOU WANT TO DELETE" S %=0 D YN^DICN S X="" I %'=1 W "  <NOTHING DELETED>"
"RTN","PSIVEDRG",126,0)
 Q
"RTN","PSIVEDRG",127,0)
GTADSOL ;Prompt for an ad/sol if there were multiple ad/sol matched to an OI
"RTN","PSIVEDRG",128,0)
 ;PSIVOI array is defined in GTIVDRG^PSIVORC2
"RTN","PSIVEDRG",129,0)
 NEW DIR,ND,X,Y
"RTN","PSIVEDRG",130,0)
 S DIR(0)="LA^1:"_+PSIVOI("DILIST",0)
"RTN","PSIVEDRG",131,0)
 S DIR("?")="Please select "_$S(PSIVOI="AD":"an Additive or Quick Code",1:"a Solution")_" from the list"
"RTN","PSIVEDRG",132,0)
 F X=0:0 S X=$O(PSIVOI("DILIST",X)) Q:'X  D
"RTN","PSIVEDRG",133,0)
 . S DIR("A",X)="  "_X_"  "_$S($P(PSIVOI("DILIST",X,0),U,4)="QC":"  - "_$P(PSIVOI("DILIST",X,0),U,2)_" -",1:$P(PSIVOI("DILIST",X,0),U,2))_$S(PSIVOI="SOL":"  "_$P(PSIVOI("DILIST",X,0),U,3),1:"")
"RTN","PSIVEDRG",134,0)
 S DIR("A")="Select (1 - "_+PSIVOI("DILIST",0)_"): "
"RTN","PSIVEDRG",135,0)
 D ^DIR
"RTN","PSIVEDRG",136,0)
 I +Y D
"RTN","PSIVEDRG",137,0)
 . NEW PSIVOIND S PSIVOIND=PSIVOI("DILIST",+Y,0)
"RTN","PSIVEDRG",138,0)
 . W "  "_$P(PSIVOIND,U,2)_$S(PSIVOI="SOL":"  "_$P(PSIVOIND,U,3),1:"")
"RTN","PSIVEDRG",139,0)
 . S ND=$G(^PS($S(PSIVOI="AD":52.6,1:52.7),+PSIVOIND,0))
"RTN","PSIVEDRG",140,0)
 . S DRG(PSIVOI,0)=1
"RTN","PSIVEDRG",141,0)
 . S DRG(PSIVOI,1)=+PSIVOIND_U_$P(ND,U)_U_$S(PSIVOI="SOL":$P(ND,U,3),1:"")_U_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSIVEDRG",142,0)
 . S DRGI=1 D SETDRG
"RTN","PSIVEDRG",143,0)
 . I $P(PSIVOI("DILIST",+Y,0),U,4)="QC",DRGT="AD",$D(^PS(52.6,"C",$P(PSIVOI("DILIST",+Y,0),U,2),+PSIVOI("DILIST",+Y,0))) D   Q:$G(PSIVSTR)="QUICK CODE"!$G(PSGORQF)
"RTN","PSIVEDRG",144,0)
 .. S (X,PSIVX)=$P(PSIVOI("DILIST",+Y,0),U,2),(PSJIVIEN,Y)=+PSIVOI("DILIST",+Y,0) D
"RTN","PSIVEDRG",145,0)
 ... N PSJNF D NFIV^PSJDIN(52.6,+PSJIVIEN,.PSJNF) W PSJNF("NF")
"RTN","PSIVEDRG",146,0)
 ... S DRGTMP=DRG(DRGT,1)
"RTN","PSIVEDRG",147,0)
 ... I '$D(ON55) N ON55 S ON55=ON
"RTN","PSIVEDRG",148,0)
 ... D ORDERCHK(DFN,ON55,1) I $G(PSGORQF) S X=U,DONE=1 Q
"RTN","PSIVEDRG",149,0)
 ... D DINIV^PSJDIN(52.6,+DRGTMP)
"RTN","PSIVEDRG",150,0)
 ... D ^PSIVQUI
"RTN","PSIVEDRG",151,0)
 . I $P(PSIVOI("DILIST",+Y,0),U,4)'="QC" S DRGTMP=DRG(DRGT,1) D ORDERCHK(DFN,ON55,1) I $G(PSGORQF) S X=U,DONE=1 Q
"RTN","PSIVEDRG",152,0)
 . I PSIVOI="AD" D
"RTN","PSIVEDRG",153,0)
 .. N FIL S FIL=52.6 D DRG3
"RTN","PSIVEDRG",154,0)
 K PSIVOI
"RTN","PSIVEDRG",155,0)
 Q
"RTN","PSIVEDT")
0^17^B52868787
"RTN","PSIVEDT",1,0)
PSIVEDT ;BIR/MLM - EDIT IV ORDER ;2/10/98 3:23 PM
"RTN","PSIVEDT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**4,110,127,133,134,181,252,281**;16 DEC 97;Build 113
"RTN","PSIVEDT",3,0)
 ;
"RTN","PSIVEDT",4,0)
 ; Reference to ^PS(53.1 is supported by DBIA 2256.
"RTN","PSIVEDT",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSIVEDT",6,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSIVEDT",7,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSIVEDT",8,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVEDT",9,0)
 ;
"RTN","PSIVEDT",10,0)
EDIT ;
"RTN","PSIVEDT",11,0)
 ;Store the DRG array.  If it changed then to do an OC
"RTN","PSIVEDT",12,0)
 NEW TMPDRG,PSJFLG57,PSIVE,PSIALLFL
"RTN","PSIVEDT",13,0)
 D SAVEDRG^PSIVEDRG(.TMPDRG,.DRG)
"RTN","PSIVEDT",14,0)
 I $G(DFN)&($G(PSJORD)["V") I $$COMPLEX^PSJOE(DFN,PSJORD) D
"RTN","PSIVEDT",15,0)
 . N X,Y,PARENT,P2ND S P2ND=$S($G(^PS(55,PSGP,"IV",+PSJORD,.2)):$G(^PS(55,PSGP,"IV",+PSJORD,.2)),1:$G(^PS(55,PSGP,5,+PSJORD,.2)))
"RTN","PSIVEDT",16,0)
 . S PARENT=$P(P2ND,"^",8)
"RTN","PSIVEDT",17,0)
 . I PARENT D FULL^VALM1 W !!?5,"This order is part of a complex order. Please review the following ",!?5,"associated orders before changing this order." D CMPLX^PSJCOM1(PSGP,PARENT,PSJORD)
"RTN","PSIVEDT",18,0)
 S DONE=0
"RTN","PSIVEDT",19,0)
 F PSIVE=1:1 S:DONE&$E(PSIVAC)="C" OREND=1 Q:PSIVE>$L(EDIT,U)!(DONE)  Q:'$L($P(EDIT,U,PSIVE))  D @($P(EDIT,U,PSIVE)) S:$E(PSIVAC,2)="N" PSIVOK=PSIVOK_U_$P(EDIT,U,PSIVE) I $E(X)=U,$L(X)>1 S:PSIVE>1 PSIVE=PSIVE-1 F  D FF Q:Y<0  D @Y Q:$E(X)'=U
"RTN","PSIVEDT",20,0)
 I $G(PSGORQF) K PSIVEDIT S PSJOCCHK=1,PSIVENO=1 ;RTC 151046
"RTN","PSIVEDT",21,0)
 I '$G(PSGORQF),$G(PSJOCCHK) K PSJOCCHK,PSIVENO D OC^PSIVOC
"RTN","PSIVEDT",22,0)
 K EDIT,PSIVOK,PSGDI
"RTN","PSIVEDT",23,0)
 ;If quit then restore DRG( to pre-edit state
"RTN","PSIVEDT",24,0)
 I $G(PSGORQF) D SAVEDRG^PSIVEDRG(.DRG,.TMPDRG)
"RTN","PSIVEDT",25,0)
 Q
"RTN","PSIVEDT",26,0)
 ;
"RTN","PSIVEDT",27,0)
1 ; Provider.
"RTN","PSIVEDT",28,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+$G(ON),0)),"^",24)="R" D  Q
"RTN","PSIVEDT",29,0)
 . W !!?5,"This is Renewal order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",30,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",31,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",32,0)
 S P(6)=$S('$G(^VA(200,+P(6),"PS")):"",'$P(^("PS"),U,4):P(6),$P(^("PS"),U,4)<DT:"",1:P(6))
"RTN","PSIVEDT",33,0)
 W !,"PROVIDER: "_$S($P(P(6),U,2)]"":$P(P(6),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(X=""&P(6)) Q
"RTN","PSIVEDT",34,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS^PSIVEDT1 G 1
"RTN","PSIVEDT",35,0)
 I X]"" K DIC S DIC=200,DIC(0)="EQMZ",DIC("S")="I $D(^(""PS"")),^(""PS""),$S('$P(^(""PS""),U,4):1,$P(^(""PS""),U,4)>DT:1,1:0)" D ^DIC K DIC I Y>0 S P(6)=+Y_U_Y(0,0) Q
"RTN","PSIVEDT",36,0)
 S F1=53.1,F2=1 D ENHLP^PSIVORC1 W $C(7),!!,"A Provider must be entered.",!! G 1
"RTN","PSIVEDT",37,0)
 Q
"RTN","PSIVEDT",38,0)
 ;
"RTN","PSIVEDT",39,0)
3 ; Med Route.
"RTN","PSIVEDT",40,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",41,0)
 . W !!?5,"Med Route may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",42,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",43,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Med Route may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",44,0)
 S P(6)=$S('$G(^VA(200,+P(6),"PS")):"",'$P(^("PS"),U,4):P(6),$P(^("PS"),U,4)<DT:"",1:P(6))
"RTN","PSIVEDT",45,0)
 I P("MR")="" D
"RTN","PSIVEDT",46,0)
 .N AD,SOL,OI,RT,RTCNT
"RTN","PSIVEDT",47,0)
 .S AD=0 F  S AD=$O(DRG("AD",AD)) Q:'AD  S OI=$P(DRG("AD",AD),"^",6) I OI S OI(OI)=""
"RTN","PSIVEDT",48,0)
 .S SOL=0 F  S SOL=$O(DRG("SOL",SOL)) Q:'SOL  S OI=$P(DRG("SOL",SOL),"^",6) I OI S OI(OI)=""
"RTN","PSIVEDT",49,0)
 .S OI="" F  S OI=$O(OI(OI)) Q:'OI  S RT=$P(^PS(50.7,OI,0),"^",6) S:RT="" RT="NONE" S RT(RT)=$P($G(^PS(51.2,+RT,0)),"^",3)
"RTN","PSIVEDT",50,0)
 .S RT="" F RTCNT=0:1 S RT=$O(RT(RT)) Q:RT=""
"RTN","PSIVEDT",51,0)
 .Q:RTCNT>1
"RTN","PSIVEDT",52,0)
 .S RT=$O(RT("")) I RT]"" S P("MR")=RT_"^"_$G(RT(RT))
"RTN","PSIVEDT",53,0)
 W !,"MED ROUTE: "_$S($P(P("MR"),U,2)]"":$P(P("MR"),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I X=U!(X=""&P("MR"))!($E(X)=U) Q
"RTN","PSIVEDT",54,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS^PSIVEDT1 G 3
"RTN","PSIVEDT",55,0)
 I X]"" K DIC S DIC=51.2,DIC(0)="EQMZ",DIC("S")="I $P(^(0),U,4)" D ^DIC K DIC I Y>0 S P("MR")=+Y_U_$P(Y(0),U,3) S:$E($G(PSJOCFG),1,2)="FN" PSJFNDS=1 Q
"RTN","PSIVEDT",56,0)
 S F1=53.1,F2=3 D ENHLP^PSIVORC1 W $C(7),!!,"A Med Route must be entered." G 3
"RTN","PSIVEDT",57,0)
 Q
"RTN","PSIVEDT",58,0)
 ;
"RTN","PSIVEDT",59,0)
10 ; Start Date.
"RTN","PSIVEDT",60,0)
 D 10^PSIVEDT1
"RTN","PSIVEDT",61,0)
 I $E($G(PSJOCFG),1,2)="FN" S PSJFNDS=1
"RTN","PSIVEDT",62,0)
 Q
"RTN","PSIVEDT",63,0)
 ;
"RTN","PSIVEDT",64,0)
25 ; Stop Date.
"RTN","PSIVEDT",65,0)
 D 25^PSIVEDT1
"RTN","PSIVEDT",66,0)
 I $E($G(PSJOCFG),1,2)="FN" S PSJFNDS=1
"RTN","PSIVEDT",67,0)
 Q
"RTN","PSIVEDT",68,0)
26 ; Schedule
"RTN","PSIVEDT",69,0)
 D 26^PSIVEDT1
"RTN","PSIVEDT",70,0)
 Q
"RTN","PSIVEDT",71,0)
 ;
"RTN","PSIVEDT",72,0)
39 ; Admin Times.
"RTN","PSIVEDT",73,0)
 D 39^PSIVEDT1
"RTN","PSIVEDT",74,0)
 Q
"RTN","PSIVEDT",75,0)
 ;
"RTN","PSIVEDT",76,0)
57 ; Additive.
"RTN","PSIVEDT",77,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",78,0)
 . W !!?5,"Additive may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",79,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",80,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Provider may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",81,0)
 I $E(PSIVAC)="O" W !!,"Only additives marked for use in IV Fluid Order Entry may be selected."
"RTN","PSIVEDT",82,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSIVEDT",83,0)
 S FIL=52.6,DRGT="AD",DRGTN="ADDITIVE" D DRG^PSIVEDRG,DKILL
"RTN","PSIVEDT",84,0)
 ;I $G(X)="^" G DKILL
"RTN","PSIVEDT",85,0)
 ;If Solution prompt is next then wait to do dose checks after all solutions are entered.
"RTN","PSIVEDT",86,0)
 ;PSJFLG57 is set so OC is triggered when the user entered ^ADDITIVE.
"RTN","PSIVEDT",87,0)
 I $$COMPARE^PSJMISC(.DRG,.TMPDRG) D
"RTN","PSIVEDT",88,0)
 . D ENSTOP^PSIVCAL
"RTN","PSIVEDT",89,0)
 . I $S($G(PSJFLG57):1,($G(EDIT)'["58"):1,1:0) K PSJFLG57,PSJOCCHK D OC^PSIVOC S:$G(EDIT)]"" PSJENHOC=1
"RTN","PSIVEDT",90,0)
 I $G(X)="^" G DKILL
"RTN","PSIVEDT",91,0)
 Q
"RTN","PSIVEDT",92,0)
 ;
"RTN","PSIVEDT",93,0)
58 ; Solution.
"RTN","PSIVEDT",94,0)
 NEW PSJCMPFG
"RTN","PSIVEDT",95,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",96,0)
 . W !!?5,"Solution may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",97,0)
 S FIL=52.7,DRGT="SOL",DRGTN="SOLUTION" D DRG^PSIVEDRG
"RTN","PSIVEDT",98,0)
 ;I $G(X)="^" G DKILL
"RTN","PSIVEDT",99,0)
 ;I $G(X)']"^",$$COMPARE^PSJMISC(.DRG,.TMPDRG) D OC^PSIVOC
"RTN","PSIVEDT",100,0)
 S PSJCMPFG=$$COMPARE^PSJMISC(.DRG,.TMPDRG)
"RTN","PSIVEDT",101,0)
 I 'PSJCMPFG,$$COMPARE^PSJMISC(.DRG,.TMPDRG,1) D
"RTN","PSIVEDT",102,0)
 . NEW X,PSJALLGY
"RTN","PSIVEDT",103,0)
 . K PSJALLGY
"RTN","PSIVEDT",104,0)
 . D SETDD^PSIVOC(1)
"RTN","PSIVEDT",105,0)
 . D GMRAOC^PSJOC S:'$G(PSGORQF) PSIALLFL=1
"RTN","PSIVEDT",106,0)
 . K PSJALLGY
"RTN","PSIVEDT",107,0)
 Q:$G(PSGORQF)
"RTN","PSIVEDT",108,0)
 I PSJCMPFG K PSJOCCHK D ENSTOP^PSIVCAL D OC^PSIVOC S:$G(EDIT)]"" PSJENHOC=1
"RTN","PSIVEDT",109,0)
 K PSJCMPFG
"RTN","PSIVEDT",110,0)
 I $G(X)="^" G DKILL
"RTN","PSIVEDT",111,0)
 ;
"RTN","PSIVEDT",112,0)
DKILL ; Kill for drug edit.
"RTN","PSIVEDT",113,0)
 K DRGI,DRGN,DRGT,DRGTN,FIL,PSIVSTR
"RTN","PSIVEDT",114,0)
 Q
"RTN","PSIVEDT",115,0)
 ;
"RTN","PSIVEDT",116,0)
59 ; Infusion Rate.
"RTN","PSIVEDT",117,0)
 D 59^PSIVEDT1
"RTN","PSIVEDT",118,0)
 Q
"RTN","PSIVEDT",119,0)
 ;
"RTN","PSIVEDT",120,0)
62 ; IV Room.
"RTN","PSIVEDT",121,0)
 N DIR S DIR(0)="PA^59.5",DIR("A")="IV Room: ",DIR("??")="^S F1=59.5,F2=.01 D ENHLP^PSIVORC1" S:P("IVRM") DIR("B")=$P(P("IVRM"),U,2)
"RTN","PSIVEDT",122,0)
 D ^DIR Q:$D(DIRUT)  I Y>0 S P("IVRM")=Y W $P($P(Y,U,2),X,2)
"RTN","PSIVEDT",123,0)
 Q
"RTN","PSIVEDT",124,0)
 ;
"RTN","PSIVEDT",125,0)
63 ; Remarks.
"RTN","PSIVEDT",126,0)
 D 63^PSIVEDT1
"RTN","PSIVEDT",127,0)
 Q
"RTN","PSIVEDT",128,0)
 ;
"RTN","PSIVEDT",129,0)
64 ; Other Print Info.
"RTN","PSIVEDT",130,0)
 D 64^PSIVEDT1
"RTN","PSIVEDT",131,0)
 Q
"RTN","PSIVEDT",132,0)
 ;
"RTN","PSIVEDT",133,0)
66 ; Provider's comments.
"RTN","PSIVEDT",134,0)
 N DA,DIE,DIR,DR S DA=PSIVUP,DIE="^PS(53.45,",DR=4 D ^DIE S PSGSI=X,Y=1
"RTN","PSIVEDT",135,0)
 Q
"RTN","PSIVEDT",136,0)
 ;
"RTN","PSIVEDT",137,0)
101 ; Orderable Item.
"RTN","PSIVEDT",138,0)
 I $G(P("RES"))="R" I $G(PSJORD)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVEDT",139,0)
 . W !!?5,"This is Renewal order. Orderable Item may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",140,0)
 I $G(DFN)&($G(ON)["V") I $$COMPLEX^PSJOE(DFN,ON) D  Q
"RTN","PSIVEDT",141,0)
 .Q:$G(PSJBKDR)  W !!?5,"This is a Complex Order. Orderable Item may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVEDT",142,0)
 W !,"Orderable Item: "_$S(P("PD"):$P(P("PD"),U,2)_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(X=""&P("PD")) Q
"RTN","PSIVEDT",143,0)
 I X]"" N DIC S DIC="^PS(50.7,",DIC(0)="EMQZ",DIC("B")=$S(P("PD")]"":+$P(("PD"),U),1:""),DIC("S")="S PSJSCT=1 I $$DRGSC^PSIVUTL(Y,PSJSCT) K PSJSCT" D ^DIC K DIC I Y>0 S P("PD")=Y Q
"RTN","PSIVEDT",144,0)
 W $C(7),!!,"Orderable Item is required!",!! G 101
"RTN","PSIVEDT",145,0)
 Q
"RTN","PSIVEDT",146,0)
109 ; Dosage Ordered.
"RTN","PSIVEDT",147,0)
 W !,"DOSAGE ORDERED: "_$S(P("DO")]"":P("DO")_"//",1:"") R X:DTIME S:'$T X=U S:X=U DONE=1 I $E(X)=U!(P("DO")]""&(X="")) Q
"RTN","PSIVEDT",148,0)
 I X="???" D ORFLDS^PSIVEDT1 G 109
"RTN","PSIVEDT",149,0)
 D:X]"" CHK^DIE(53.1,109,"",X,.X) I $G(X)="^" W $C(7),!!,"Enter the dosage in which the Orderable Item entered should be dispensed.",! W "Answer must be 1-20 characters in length." G 109
"RTN","PSIVEDT",150,0)
 S P("DO")=X
"RTN","PSIVEDT",151,0)
 Q
"RTN","PSIVEDT",152,0)
 ;
"RTN","PSIVEDT",153,0)
FF ; up-arrow to another field.
"RTN","PSIVEDT",154,0)
 N DIC S X=$P(X,U,2),DIC="^DD(53.1,",DIC(0)="QEM",DIC("S")="I U_PSIVOK_U[(U_+Y_U)" D ^DIC K DIC S Y=+Y
"RTN","PSIVEDT",155,0)
 I Y=57 S PSJFLG57=1
"RTN","PSIVEDT",156,0)
 Q
"RTN","PSIVEDT",157,0)
 ;
"RTN","PSIVEDT",158,0)
NEWDRG ; Ask if adding a new drug.
"RTN","PSIVEDT",159,0)
 K DIR S DIR(0)="Y",DIR("A")="Are you adding "_$P(TDRG,U,2)_" as a new "_$S(DRGT="AD":"additive",1:"solution")_" for this order",DIR("B")="NO" D ^DIR I $D(DTOUT)!$D(DUOUT) Q
"RTN","PSIVEDT",160,0)
 I Y S (DRGI,DRG(DRGT,0))=DRG(DRGT,0)+1,DRG=TDRG,DRG(DRGT,+DRGI)=+DRG_U_$P(DRG,U,2) I DRGT="SOL" S X=$G(^PS(52.7,+DRG,0)),$P(DRG(DRGT,DRG),U,3)=$P(X,U,3)
"RTN","PSIVEDT",161,0)
 Q
"RTN","PSIVOD")
0^39^B14160821
"RTN","PSIVOD",1,0)
PSIVOD ;BIR/JCH-CREATE NEW IV ORDER FROM OLD ONE ;25 Nov 98 / 3:34 PM
"RTN","PSIVOD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**110,127,181,281**;16 DEC 97;Build 113
"RTN","PSIVOD",3,0)
 ;
"RTN","PSIVOD",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVOD",5,0)
 ; Reference to ^ORX2 is supported by DBIA 867.
"RTN","PSIVOD",6,0)
 ;
"RTN","PSIVOD",7,0)
COPY(DFN,OLDON) ;Ask to enter new order.
"RTN","PSIVOD",8,0)
 N PSIVOORD,OLDP,PSIVCOPY,PSGCOPY,I,% M OLDP=P
"RTN","PSIVOD",9,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")  D ^PSJHVARS
"RTN","PSIVOD",10,0)
 I $P($G(^PS(55,PSGP,"IV",+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) D  G Q
"RTN","PSIVOD",11,0)
 .W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSIVOD",12,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU S PSIVOORD=PSJORD
"RTN","PSIVOD",13,0)
 D FULL^VALM1
"RTN","PSIVOD",14,0)
 F  W !!,"Do you want to copy this order" S %=2 D YN^DICN Q:%  D CH
"RTN","PSIVOD",15,0)
 G:%'=1 Q
"RTN","PSIVOD",16,0)
 S P("RES")="N",PSIVAC="PN",P("PON")=ON55,PSIVUP=+$$GTPCI^PSIVUTL,PSJORD=ON55,PSGORD=PSJORD
"RTN","PSIVOD",17,0)
 N OLDACT,PSIVCHG S OLDACT=PSGACT S PSGACT=PSGACT_"E",P(17)="N",(P("LOG"),P("LF"))="",P(21)="" K P("NAT")
"RTN","PSIVOD",18,0)
 S:'$G(PSGDT) PSGDT=$$DATE^PSJUTL2() S P("LOG")=PSGDT,P("PRNTON")=""
"RTN","PSIVOD",19,0)
 D ENT^PSIVCAL,ENSTOP^PSIVCAL S ND4="^^^^" F I=5,6,8,9 S $P(ND2,"^",I)=""
"RTN","PSIVOD",20,0)
 S P(17)=$S($G(PSGOEAV):"A",1:"N") S P("CLRK")=DUZ_"^"_$P($G(^VA(200,+DUZ,0)),"^")
"RTN","PSIVOD",21,0)
 S PSIVCHG=0,PSJNEWOE=0,PSIVCOPY=1,VALMBCK="Q" K PSIVACEP
"RTN","PSIVOD",22,0)
 NEW PSGORQF K PSGORQF D OC^PSIVOC G:$G(PSGORQF) Q
"RTN","PSIVOD",23,0)
 N PSGORD,ON,ON55,PSJORD D NEW55^PSIVORFB S (PSJORD,ON)=ON55,PSIVCOPY=2
"RTN","PSIVOD",24,0)
 D EN^VALM("PSJ LM IV AC/EDIT")
"RTN","PSIVOD",25,0)
 I $G(P("NAT"))=""&($G(PSJORNAT)="") D  G Q
"RTN","PSIVOD",26,0)
 .D FULL^VALM1 W !!,"Order not copied" D PAUSE^VALM1
"RTN","PSIVOD",27,0)
 W !!,"...copying..."
"RTN","PSIVOD",28,0)
 ;RTC 178789 - not to store allergy OC until either verify or quit as non-vf order
"RTN","PSIVOD",29,0)
 ;D SETOC^PSJNEWOC(ON55)
"RTN","PSIVOD",30,0)
 ;
"RTN","PSIVOD",31,0)
 I '$G(PSGOEAV) D INMED
"RTN","PSIVOD",32,0)
 ;
"RTN","PSIVOD",33,0)
 D FULL^VALM1 W !!?5,"You are finished with the new order.",!,"The following ACTION prompt is for the original order." D PAUSE^VALM1
"RTN","PSIVOD",34,0)
Q ; Kill and exit.
"RTN","PSIVOD",35,0)
 L:'$D(PSJOE) -^PS(53.45,DUZ) S PSJNKF=1 D Q^PSIV
"RTN","PSIVOD",36,0)
 K FIL,I1,ND,PC,PDM,PSGDT,PSGID,PSGLMT,PSGSI,PSJNARC,PSIVAC,PSIVCHG,PSIVUP,PSIVX,PSJOPC,PSJAGYSV
"RTN","PSIVOD",37,0)
 S VALMBCK="R"
"RTN","PSIVOD",38,0)
 I '$G(PSGDT) S PSGDT=$$DATE^PSJUTL2
"RTN","PSIVOD",39,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSIVOORD) ; resets PSGACT after copy
"RTN","PSIVOD",40,0)
 D RESTORE^PSJHVARS
"RTN","PSIVOD",41,0)
 K P M P=OLDP
"RTN","PSIVOD",42,0)
 Q
"RTN","PSIVOD",43,0)
 ;
"RTN","PSIVOD",44,0)
INMED ;
"RTN","PSIVOD",45,0)
 K PSJACEPT S VALMBCK="Q",PSIVCOPY=2,PSIVCHG=0 ;D ACEDIT^PSJLIACT
"RTN","PSIVOD",46,0)
 N ON55TMP,P21TMP S ON55TMP=ON55,P21TMP=$G(P(21)) S P(21)="" I $G(ON55)["P",($G(PSJORD)["V") S ON55=PSJORD
"RTN","PSIVOD",47,0)
 D DEL55^PSIVORE2 I $G(ON55TMP)]"" S ON55=ON55TMP,P(21)=P21TMP
"RTN","PSIVOD",48,0)
 ;S (PSJORNAT,P("NAT"))="W"
"RTN","PSIVOD",49,0)
 ;D OK^PSIVORE
"RTN","PSIVOD",50,0)
 D EN^VALM("PSJ LM IV INPT ACTIVE")
"RTN","PSIVOD",51,0)
 ;RTC 178789 - Store allergy OC as non-vf order
"RTN","PSIVOD",52,0)
 D:$G(ON55)["P" SETOC^PSJNEWOC($G(ON55))
"RTN","PSIVOD",53,0)
 L -^PS(55,DFN,"IV",+ON55) D ULK
"RTN","PSIVOD",54,0)
 I $G(P("NAT"))="" D  G Q
"RTN","PSIVOD",55,0)
 .D FULL^VALM1 W !!,"Order not copied" D PAUSE^VALM1
"RTN","PSIVOD",56,0)
 Q
"RTN","PSIVOD",57,0)
ULK ;
"RTN","PSIVOD",58,0)
 Q:'$G(PSJLSORX)  ;If NEW^PSIVORE did not lock, don't kill it here.
"RTN","PSIVOD",59,0)
 NEW X S X=DFN_";DPT(" D ULK^ORX2 K PSJLSORX
"RTN","PSIVOD",60,0)
 Q
"RTN","PSIVOD",61,0)
HK ;Queue job to print MAR labels generated for this patient.
"RTN","PSIVOD",62,0)
 I PSGOP,PSGOP'=DFN D
"RTN","PSIVOD",63,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSIVOD",64,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,U,2)]"" ENQL^PSGLW
"RTN","PSIVOD",65,0)
 S PSGOP=DFN
"RTN","PSIVOD",66,0)
 Q
"RTN","PSIVOD",67,0)
 ;
"RTN","PSIVOD",68,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(^PS(55,DFN,"IV",+ON55,"SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(^(XXX,0),U,2)
"RTN","PSIVOD",69,0)
 K XXX Q
"RTN","PSIVOD",70,0)
CH ;
"RTN","PSIVOD",71,0)
 W !!?2,"Answer 'YES' to have a new, non-verified order created for this patient,"
"RTN","PSIVOD",72,0)
 W !,"using the information from this order.  (The START and STOP dates will be",!,"recalculated.)  Enter 'NO' (or '^') to stop now."
"RTN","PSIVOD",73,0)
 Q
"RTN","PSIVOPT1")
0^37^B48890773
"RTN","PSIVOPT1",1,0)
PSIVOPT1 ;BIR/MLM-EDIT/DC ORDER (BACKDOOR) ;22 OCT 97 / 3:14 PM
"RTN","PSIVOPT1",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**29,58,101,110,127,181,258,279,281**;16 DEC 97;Build 113
"RTN","PSIVOPT1",3,0)
 ;
"RTN","PSIVOPT1",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIVOPT1",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVOPT1",6,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSIVOPT1",7,0)
 ;
"RTN","PSIVOPT1",8,0)
E ; Edit order through Pharmacy.
"RTN","PSIVOPT1",9,0)
 N PSIEDITO S PSIEDITO=1
"RTN","PSIVOPT1",10,0)
 D GSTRING^PSIVORE1,GTFLDS^PSIVORFE
"RTN","PSIVOPT1",11,0)
 I '$G(PSIVENO) S PSIVENO=1 D EN^VALM("PSJ LM IV AC/EDIT") S VALMBCK="Q"
"RTN","PSIVOPT1",12,0)
 Q
"RTN","PSIVOPT1",13,0)
ACCEPT ; To be called by ACCEPT^PSJLIACT
"RTN","PSIVOPT1",14,0)
 NEW PSIVDSFG
"RTN","PSIVOPT1",15,0)
 D CKNEW
"RTN","PSIVOPT1",16,0)
 D:'$G(PSGORQF) DOSING
"RTN","PSIVOPT1",17,0)
 Q:$G(PSGORQF)
"RTN","PSIVOPT1",18,0)
 ;Don't create new order if Inf rate changed not supposed too set PSIVCHG=1
"RTN","PSIVOPT1",19,0)
 I PSIVCHG,'$G(PSJEDIT1) D
"RTN","PSIVOPT1",20,0)
 .S P("OLDON")=ON55,Y=$G(^PS(55,DFN,"IV",+ON55,0)) D NOW^%DTC S P("LOG")=$E(%,1,12) K %
"RTN","PSIVOPT1",21,0)
 .S P("CLRK")=DUZ_U_$P($G(^VA(200,DUZ,0)),U)
"RTN","PSIVOPT1",22,0)
 .I $G(PSGSDX)!$G(PSGFDX) Q
"RTN","PSIVOPT1",23,0)
 .I $P(Y,U,2)=P(2),$P(Y,U,3)=P(3) D ENT^PSIVCAL S X=P(2),%DT="T" D ^%DT S P(2)=$E(Y,1,12),PSJEDIT1=1 D ENSTOP^PSIVCAL
"RTN","PSIVOPT1",24,0)
 I $G(PSGORQF) S VALMBCK="Q" W !,"Order unchanged." D PAUSE^PSJMISC(1,) Q
"RTN","PSIVOPT1",25,0)
 D OK^PSIVOPT2
"RTN","PSIVOPT1",26,0)
 I X["N" S VALMBCK="R" Q
"RTN","PSIVOPT1",27,0)
 I X["^" D GT55^PSIVORFB W !,"Order unchanged." Q
"RTN","PSIVOPT1",28,0)
 I $G(P("21FLG"))]"" D CKNEW,@$S(PSIVCHG:"NEWORD",1:"UPDATE") Q:$D(X)
"RTN","PSIVOPT1",29,0)
 S PSJORL=$$ENORL^PSJUTL($G(VAIN(4))) S ON=ON55,OD=P(2)
"RTN","PSIVOPT1",30,0)
 D:ON["V" EN^PSIVORE
"RTN","PSIVOPT1",31,0)
 I $G(PSJIVORF),PSIVCHG D EN1^PSJHL2(DFN,"SN",ON55,"NEW ORDER") NEW PSIVXX S PSIVXX=$$LS^PSSLOCK(DFN,ON55)
"RTN","PSIVOPT1",32,0)
 S ^TMP("PSODAOC",$J,"IP NEW IEN")=ON55
"RTN","PSIVOPT1",33,0)
 D SETOC^PSJNEWOC(ON55)
"RTN","PSIVOPT1",34,0)
 S PSIVACEP=1
"RTN","PSIVOPT1",35,0)
 Q
"RTN","PSIVOPT1",36,0)
 ;
"RTN","PSIVOPT1",37,0)
DOSING ;
"RTN","PSIVOPT1",38,0)
 NEW TMPDRG
"RTN","PSIVOPT1",39,0)
 ;PSIVDSFG is set when changes to fields (except Schedule for continuous IV type) that caused a new order to create.
"RTN","PSIVOPT1",40,0)
 D TMPDRG^PSJMISC(DFN,$G(ON55),.TMPDRG)
"RTN","PSIVOPT1",41,0)
 I $S($G(PSIVDSFG):0,$G(PSIVCHG):1,1:0)!$$COMPARE^PSJMISC(.DRG,.TMPDRG,$S(P("DTYP")=1:0,1:1))!$$INFRATE^PSJMISC(DFN,ON55,P(8),P("DTYP")) D
"RTN","PSIVOPT1",42,0)
 . D IN^PSJOCDS($G(ON),"IV","")
"RTN","PSIVOPT1",43,0)
 I $G(PSGORQF) S VALMBCK="Q"
"RTN","PSIVOPT1",44,0)
 Q
"RTN","PSIVOPT1",45,0)
CKNEW ; Check if new order is to be created.
"RTN","PSIVOPT1",46,0)
 N DNE,ND,TDRG,PSJCHG,TMPDRG S (DNE,PSIVCHG,PSIVDSFG)=0
"RTN","PSIVOPT1",47,0)
 Q:PSIVCHG
"RTN","PSIVOPT1",48,0)
 D TMPDRG^PSJMISC(DFN,$G(ON55),.TMPDRG)
"RTN","PSIVOPT1",49,0)
 I $$COMPARE^PSJMISC(.DRG,.TMPDRG,$S(P("DTYP")=1:0,1:1)) S PSIVCHG=1
"RTN","PSIVOPT1",50,0)
 K TMPDRG
"RTN","PSIVOPT1",51,0)
 Q:PSIVCHG
"RTN","PSIVOPT1",52,0)
 F DRGT="AD","SOL" F DRGI=0:0 S DRGI=$O(DRG(DRGT,DRGI)) Q:'DRGI  I $P(P("OT"),U)="F",'$P(DRG(DRGT,DRGI),U,5) S P("OT")="I"
"RTN","PSIVOPT1",53,0)
 ;I $G(DRG("AD",0))+$S(P("DTYP")=1:0,1:+$G(DRG("SOL",0)))'=DRG("DRGC") S PSIVCHG=1 Q
"RTN","PSIVOPT1",54,0)
 S ND(0)=$G(^PS(55,DFN,"IV",+ON55,0)),ND("PD")=$G(^PS(55,DFN,"IV",+ON55,.2))
"RTN","PSIVOPT1",55,0)
 N X S X=$S($P(ND(0),U,8)["@":$P($P(ND(0),U,8),"@"),1:$P(ND(0),U,8))
"RTN","PSIVOPT1",56,0)
 S ND=$S($E(P("OT"))="I":$P(ND("PD"),U,1,2)_U,1:"")_$P(ND("PD"),U,3)_U_$S($E(P("OT"))'="I":X_U,1:"")_+$P(ND(0),U,6)_U_$P(ND(0),U,2)_U_$P(ND(0),U,3)
"RTN","PSIVOPT1",57,0)
 S:ND'=($S($E(P("OT"))="I":+P("PD")_U_$G(P("DO"))_U,1:"")_+P("MR")_U_$S($E(P("OT"))'="I":$S(P(8)["@":$P(P(8),"@"),1:P(8))_U,1:"")_+P(6)_U_P(2)_U_P(3)) PSIVCHG=1
"RTN","PSIVOPT1",58,0)
 I 'PSIVCHG I $P(ND(0),U,9)'=P(9) S:(P("DTYP")'=1) PSIVDSFG=1 S PSIVCHG=1
"RTN","PSIVOPT1",59,0)
 ;S ND=$S($E(P("OT"))="I":$P(ND("PD"),U,1,2)_U,1:"")_$P(ND("PD"),U,3)_U_$S($E(P("OT"))'="I":X_U,1:"")_+$P(ND(0),U,6)_U_$P(ND(0),U,2)_U_$P(ND(0),U,3)_U_$P(ND(0),U,9)
"RTN","PSIVOPT1",60,0)
 ;S:ND'=($S($E(P("OT"))="I":+P("PD")_U_$G(P("DO"))_U,1:"")_+P("MR")_U_$S($E(P("OT"))'="I":$S(P(8)["@":$P(P(8),"@"),1:P(8))_U,1:"")_+P(6)_U_P(2)_U_P(3)_U_P(9)) PSIVCHG=1
"RTN","PSIVOPT1",61,0)
 ;* S ND=$S($E(P("OT"))="I":$P(ND("PD"),U,1,2)_U,1:"")_$P(ND("PD"),U,3)_U_$S($E(P("OT"))'="I":$P(ND(0),U,8)_U,1:"")_+$P(ND(0),U,6)_U_$P(ND(0),U,2)_U_$P(ND(0),U,3)_U_$P(ND(0),U,9)
"RTN","PSIVOPT1",62,0)
 ;* S:ND'=($S($E(P("OT"))="I":+P("PD")_U_$G(P("DO"))_U,1:"")_+P("MR")_U_$S($E(P("OT"))'="I":P(8)_U,1:"")_+P(6)_U_P(2)_U_P(3)_U_P(9)) PSIVCHG=1
"RTN","PSIVOPT1",63,0)
 Q
"RTN","PSIVOPT1",64,0)
 ;
"RTN","PSIVOPT1",65,0)
UPDATE ; Update original order.
"RTN","PSIVOPT1",66,0)
 I '$G(PSJSYSP) N PSJSYSP S PSJSYSP=$S($G(DUZ):DUZ,1:$J)
"RTN","PSIVOPT1",67,0)
 N PSJIBDT,PSJINIV S PSJINIV=0
"RTN","PSIVOPT1",68,0)
 S PSIVALT=1,PSIVALCK="EN",PSIVREA="E",ON=ON55 K P("OLDON") D LOG^PSIVORAL
"RTN","PSIVOPT1",69,0)
 D SET55^PSIVORFB I $G(P("NUMLBL")) S $P(^PS(55,DFN,"IV",+ON55,11),"^")=$G(P("NUMLBL")) K P("NUMLBL")
"RTN","PSIVOPT1",70,0)
 D PSBPOIV^PSJIBAG(DFN,ON55,,.PSJINIV)
"RTN","PSIVOPT1",71,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"E")
"RTN","PSIVOPT1",72,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN K X Q:'PSJIVORF
"RTN","PSIVOPT1",73,0)
 S PSJORIFN=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,21) Q:'PSJORIFN
"RTN","PSIVOPT1",74,0)
 S P("NAT")=""
"RTN","PSIVOPT1",75,0)
 D EN1^PSJHL2(DFN,"XX",+ON55_"V","UPDATED ORDER")
"RTN","PSIVOPT1",76,0)
 I $G(PSJINIV),'$G(PSIVCHG) W ! D
"RTN","PSIVOPT1",77,0)
 .N DIR,X,Y,PSJIRPLB S DIR(0)="Y",DIR("B")="NO",DIR("A")="Print new replacement labels",DIR("?")="Enter YES to print new IV labels to replace inactivated IV labels" D ^DIR
"RTN","PSIVOPT1",78,0)
 .I ($G(Y)>0) K DIR S PSJIRPLB=1 D ^PSIVORE1
"RTN","PSIVOPT1",79,0)
 K X
"RTN","PSIVOPT1",80,0)
 Q
"RTN","PSIVOPT1",81,0)
 ;
"RTN","PSIVOPT1",82,0)
NEWORD ; DC orig. order, get new order no.
"RTN","PSIVOPT1",83,0)
 N PSJIBDT,PSIEDFIR S PSJIBDT=1
"RTN","PSIVOPT1",84,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN I PSJIVORF D NATURE^PSIVOREN I '$D(P("NAT")) S X=1 W !,"Order unchanged." Q
"RTN","PSIVOPT1",85,0)
 S P("RES")="E",P("OLDON")=$S($G(PSIVCOPY)=2:"",1:ON55),P(16)="" ; INC000000801240 / MWA (VMP)
"RTN","PSIVOPT1",86,0)
 S PSJAGYSV=1
"RTN","PSIVOPT1",87,0)
 Q:$$NONVF()
"RTN","PSIVOPT1",88,0)
 I '($G(PSIVCOPY)=2) K ON55 D NEW55^PSIVORFB
"RTN","PSIVOPT1",89,0)
 S (P("PON"),P("NEWON"),ON)=ON55,ON55=P("OLDON") S:($G(PSIVCOPY)=2) P("OLDON")=""
"RTN","PSIVOPT1",90,0)
 I $P($G(^PS(55,DFN,"IV",+P("OLDON"),0)),U,17)="A" D D1^PSIVOPT2 D
"RTN","PSIVOPT1",91,0)
 . I PSJIVORF,$P($G(^PS(55,DFN,"IV",+ON55,0)),U,21) S PSIEDFIR=1 D EN1^PSJHL2(DFN,"OD",+ON55_"V","ORDER DISCONTINUED") K PSIEDFIR
"RTN","PSIVOPT1",92,0)
 . S P("21FLG")="" W !!,"Original order discontinued...",!!
"RTN","PSIVOPT1",93,0)
 . D UNL^PSSLOCK(DFN,+ON55_"V")
"RTN","PSIVOPT1",94,0)
 F ON55=P("NEWON"),P("OLDON") K DA,DIE,DR D
"RTN","PSIVOPT1",95,0)
 .S DA(1)=DFN,DA=+ON55,DIE="^PS(55,"_DFN_",""IV"",",DR=$S((ON55=P("NEWON")&(+ON55'=+P("OLDON"))):"113////"_P("OLDON")_";122////E",1:"114////"_P("NEWON")_";123////E") D ^DIE
"RTN","PSIVOPT1",96,0)
 .I ON55=P("NEWON") N CLINAPPT S CLINAPPT=$G(^PS(55,DFN,"IV",+P("OLDON"),"DSS")) D
"RTN","PSIVOPT1",97,0)
 ..S:CLINAPPT DR=DR_";136////"_+CLINAPPT S:$P(CLINAPPT,"^",2) DR=DR_";139////"_$P(CLINAPPT,"^",2)
"RTN","PSIVOPT1",98,0)
 .D ^DIE
"RTN","PSIVOPT1",99,0)
 .Q:ON55=P("OLDON")&($P($G(^PS(55,DFN,"IV",+P("OLDON"),0)),U,17)'="D")
"RTN","PSIVOPT1",100,0)
 .D:ON55=P("NEWON") SET55^PSIVORFB
"RTN","PSIVOPT1",101,0)
 .D:ON55=P("NEWON") VF1^PSJLIACT("","",0)
"RTN","PSIVOPT1",102,0)
 .D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,$S(ON55=P("NEWON"):"N",1:"DE"))
"RTN","PSIVOPT1",103,0)
 .S PSIVREA="E",PSIVAL="Order "_$S(ON55=P("OLDON"):"discontinued",1:"created")_" due to edit" S:ON55=P("OLDON") PSIVALCK="STOP" D LOG^PSIVORAL
"RTN","PSIVOPT1",104,0)
 L -^PS(55,DFN,"IV",+P("OLDON")) ;D NEWENT^PSIVORFE
"RTN","PSIVOPT1",105,0)
 K X S ON55=P("NEWON"),P(17)="A" Q:'PSJIVORF  D SET^PSIVORFE
"RTN","PSIVOPT1",106,0)
 Q
"RTN","PSIVOPT1",107,0)
 ;
"RTN","PSIVOPT1",108,0)
NEWSTOP ; Set stop date for DC and renewals.
"RTN","PSIVOPT1",109,0)
 S ND=$G(^PS(55,DFN,"IV",+ON55,0)),Y=+$P(ND,U,3),$P(^PS(55,DFN,"IV",+P("OLDON"),2),U,7)=Y,NSTOP=$S(NSTOP>Y:Y,1:NSTOP),$P(^PS(55,DFN,"IV",+ON55,0),U,3)=NSTOP
"RTN","PSIVOPT1",110,0)
 K DA,DIK S DIK="^PS(55,"_DFN_",""IV"",",DA(1)=DFN,DA=+P("OLDON") D IX^DIK K DA,DIK
"RTN","PSIVOPT1",111,0)
 Q
"RTN","PSIVOPT1",112,0)
NONVF()   ;
"RTN","PSIVOPT1",113,0)
 NEW PSGOEAV S PSGOEAV=+$P(PSJSYSP0,U,9)
"RTN","PSIVOPT1",114,0)
 I +PSJSYSU=3,PSGOEAV Q 0
"RTN","PSIVOPT1",115,0)
 I +PSJSYSU=1,PSGOEAV Q 0
"RTN","PSIVOPT1",116,0)
 K DA D ENGNN^PSGOETO S (ON,P("NEWON"))=DA_"P",P(17)="N"
"RTN","PSIVOPT1",117,0)
 S (P("DO"),P("PD"))=""
"RTN","PSIVOPT1",118,0)
 D GTPD^PSIVORE2,PUT531^PSIVORFA
"RTN","PSIVOPT1",119,0)
 I $P($G(^PS(55,DFN,"IV",+P("OLDON"),0)),U,17)="A" D D1^PSIVOPT2 D
"RTN","PSIVOPT1",120,0)
 . I PSJIVORF,$P($G(^PS(55,DFN,"IV",+P("OLDON"),0)),U,21) D EN1^PSJHL2(DFN,"OD",+ON55_"V","ORDER DISCONTINUED")
"RTN","PSIVOPT1",121,0)
 . S P("21FLG")="" W !!,"Original order discontinued...",!!
"RTN","PSIVOPT1",122,0)
 . D UNL^PSSLOCK(DFN,+P("OLDON")_"V")
"RTN","PSIVOPT1",123,0)
 F ON55=P("NEWON"),P("OLDON") K DA,DIE,DR D
"RTN","PSIVOPT1",124,0)
 . S DA=+ON55
"RTN","PSIVOPT1",125,0)
 . S:ON55=P("NEWON") DIE="^PS(53.1,",DR="104////"_P("OLDON")_";103////E"
"RTN","PSIVOPT1",126,0)
 . S:ON55=P("OLDON") DA(1)=DFN,DIE="^PS(55,"_DFN_",""IV"",",DR="114////"_P("NEWON")_";123////E"
"RTN","PSIVOPT1",127,0)
 . D ^DIE
"RTN","PSIVOPT1",128,0)
 . Q:ON55=P("OLDON")&($P($G(^PS(55,DFN,"IV",+P("OLDON"),0)),U,17)'="D")
"RTN","PSIVOPT1",129,0)
 . I ON55=P("OLDON") D
"RTN","PSIVOPT1",130,0)
 .. D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,$S(ON55=P("NEWON"):"N",1:"DE"))
"RTN","PSIVOPT1",131,0)
 .. S PSIVALT="",PSIVREA="E",PSIVAL="Order discontinued due to edit" S PSIVALCK="STOP" D LOG^PSIVORAL
"RTN","PSIVOPT1",132,0)
 . I ON55=P("NEWON") D NEWNVAL^PSGAL5(ON55,4100,"","") I $G(PSJIBDT)?7N1"."1.N D NEWNVAL^PSGAL5(ON55,6000,"LABEL INVALID DATE",PSJIBDT)
"RTN","PSIVOPT1",133,0)
 L -^PS(55,DFN,"IV",+P("OLDON"))
"RTN","PSIVOPT1",134,0)
 K X S (ON,ON55)=P("NEWON")
"RTN","PSIVOPT1",135,0)
 D EN1^PSJHL2(DFN,"SN",ON,"ORDER CREATED")
"RTN","PSIVOPT1",136,0)
 S ^TMP("PSODAOC",$J,"IP NEW IEN")=ON
"RTN","PSIVOPT1",137,0)
 ;RTC 178789 - not to store allergy OC until either verify or quit as non-vf order
"RTN","PSIVOPT1",138,0)
 ;D SETOC^PSJNEWOC(ON)
"RTN","PSIVOPT1",139,0)
 S X=$$LS^PSSLOCK(DFN,ON)
"RTN","PSIVOPT1",140,0)
 D GT531^PSIVORFA(DFN,ON)
"RTN","PSIVOPT1",141,0)
 I ON["P" N CLINAPPT S CLINAPPT=$G(^PS(55,DFN,"IV",+ON,"DSS")) I CLINAPPT D  K DIE,DA,DR
"RTN","PSIVOPT1",142,0)
 . S:CLINAPPT DR="136////"_+CLINAPPT_";" S:$P(CLINAPPT,"^",2) DR=DR_"139////"_$P(CLINAPPT,"^",2)_";" D ^DIE
"RTN","PSIVOPT1",143,0)
 S VALMBCK="Q"
"RTN","PSIVOPT1",144,0)
 S PSGACT="EL"
"RTN","PSIVOPT1",145,0)
 I P(17)="N",(P("OLDON")=""),(P("CLRK")=DUZ) S PSGACT="ELD"
"RTN","PSIVOPT1",146,0)
 I +PSJSYSU=3!(+PSJSYSU=1) S PSGACT="DELV"
"RTN","PSIVOPT1",147,0)
 Q 1
"RTN","PSIVORC1")
0^18^B80384488
"RTN","PSIVORC1",1,0)
PSIVORC1 ;BIR/MLM - PROCESS INCOMPLETE IV ORDER - CONT ;13 Jan 98  11:36 AM
"RTN","PSIVORC1",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**1,37,69,110,157,134,181,263,270,279,281**;16 DEC 97;Build 113
"RTN","PSIVORC1",3,0)
 ;
"RTN","PSIVORC1",4,0)
 ; Reference to ^DD("DD" is supported by DBIA 10017.
"RTN","PSIVORC1",5,0)
 ; Reference to ^DD( is supported by DBIA 2255.
"RTN","PSIVORC1",6,0)
 ; Reference to ^VA(200 is supported by DBIA 10060.
"RTN","PSIVORC1",7,0)
 ; Reference to ^%DT is supported by DBIA 10003.
"RTN","PSIVORC1",8,0)
 ; Reference to ^%DTC is supported by DBIA 10000.
"RTN","PSIVORC1",9,0)
 ; Reference to ^DID is supported by DBIA 2052.
"RTN","PSIVORC1",10,0)
 ; Reference to ^VALM is supported by DBIA 10118.
"RTN","PSIVORC1",11,0)
 ; Reference to ^PS(51.1 supported by DBIA #2177.
"RTN","PSIVORC1",12,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSIVORC1",13,0)
 ;
"RTN","PSIVORC1",14,0)
53 ; IV Type
"RTN","PSIVORC1",15,0)
 I $G(PSGORD)["P",$G(PSGAT),($G(P(9))]"") D
"RTN","PSIVORC1",16,0)
 .N X,PSGS0Y,PSGS0XT,ZZ,LYN,ZZND,ZZNDW S X=P(9) S PSGS0Y="",ZZ=0 D FIND^DIC(51.1,,,,X,,"APPSJ",,,"LYN")
"RTN","PSIVORC1",17,0)
 .S ZZ=$O(LYN("DILIST",2,ZZ)) I ZZ S ZZ=+LYN("DILIST",2,ZZ) I ZZ S ZZND=$G(^PS(51.1,ZZ,0)) S PSGST=$P(ZZND,U,5),PSGS0XT=$P(ZZND,U,3) I $G(PSJPWD) D
"RTN","PSIVORC1",18,0)
 ..N ZZNDW S ZZNDW=$G(^PS(51.1,ZZ,1,PSJPWD,0)) I $P(ZZNDW,"^",2)]"" S PSGS0Y=$P(ZZNDW,"^",2),$P(ZZND,"^",2)=PSGS0Y
"RTN","PSIVORC1",19,0)
 .S ZZ=0 F  S ZZ=$O(LYN("DILIST",1,ZZ)) Q:'ZZ  I $G(LYN("DILIST",1,ZZ))'=X K LYN("DILIST",1,ZZ),LYN("DILIST",2,ZZ),LYN("DILIST","ID",ZZ,1)
"RTN","PSIVORC1",20,0)
 .I $D(PSJPWD) S ZZ=0 F  S ZZ=$O(LYN("DILIST",2,ZZ)) Q:'ZZ  I $P($G(^PS(51.1,+LYN("DILIST",2,ZZ),1,+PSJPWD,0)),U,2)]"" S PSGS0Y=$P($G(^(0)),U,2)
"RTN","PSIVORC1",21,0)
 .I '$G(PSGS0Y) S ZZ=0 F  S ZZ=$O(LYN("DILIST",2,ZZ)) Q:'ZZ  Q:PSGS0Y]""  I $G(LYN("DILIST","ID",ZZ,1))]"" S PSGS0Y=$G(LYN("DILIST","ID",ZZ,1))
"RTN","PSIVORC1",22,0)
 .Q:(PSGS0Y=PSGAT)!'$G(PSGS0Y)!($G(IVCAT)="C")
"RTN","PSIVORC1",23,0)
 .S PSGNSTAT=1 W $C(7),!!,"PLEASE NOTE:  This order's admin times (",PSGAT,")"
"RTN","PSIVORC1",24,0)
 .W !?13," do not match the ward times (",PSGS0Y,")"
"RTN","PSIVORC1",25,0)
 .W !?13," for this administration schedule (",P(9),")",!
"RTN","PSIVORC1",26,0)
 .S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR K DIR  W !
"RTN","PSIVORC1",27,0)
 S DONE=0 N DIR S DIR(0)="SNA^A:ADMIXTURE;C:CHEMOTHERAPY;H:HYPERAL;P:PIGGYBACK;S:SYRINGE",DIR("A")="IV TYPE: "
"RTN","PSIVORC1",28,0)
 I $G(P("RES"))'="R",$G(PSGORD)["P" N IVCAT,IVTYPTMP S IVCAT=$P($G(^PS(53.1,+PSGORD,2.5)),"^",5) S IVTYPTMP=$S((P(9)]""):"P",$G(P(5)):"P",$G(P(23))="P":"P",1:"")
"RTN","PSIVORC1",29,0)
 S DIR("B")=$S($G(IVCAT)="C"!($G(IVTYPTMP)="A"):"ADMIXTURE",$G(IVCAT)="I"!($G(IVTYPTMP)="P"):"PIGGYBACK",1:"ADMIXTURE")
"RTN","PSIVORC1",30,0)
 D DIRQ,^DIR S:$D(DTOUT)!(X="^") DONE=1 Q:DONE  G:$E(X)="^" 53 S P(4)=Y D:"CS"[P(4) @P(4)
"RTN","PSIVORC1",31,0)
 ;*PSJ*5*270 - Remove bottle from IVPB
"RTN","PSIVORC1",32,0)
 N PSG53 I Y="P" D
"RTN","PSIVORC1",33,0)
 .N ADCNT,PSGBTL F ADCNT=0:0 S ADCNT=$O(^PS(53.1,+PSGORD,"AD",ADCNT)) Q:('ADCNT)!$G(PSGBTL)  D
"RTN","PSIVORC1",34,0)
 ..I $P(^PS(53.1,+PSGORD,"AD",ADCNT,0),U,3)]"" S PSGBTL=1
"RTN","PSIVORC1",35,0)
 .I '$G(PSGBTL) Q
"RTN","PSIVORC1",36,0)
 .W !!,"A bottle value is not allowed with a Piggyback IV order.  Do you wish to delete the bottle value(s)"
"RTN","PSIVORC1",37,0)
 .S %=1 D YN^DICN I %'=1 S PSG53=1 Q
"RTN","PSIVORC1",38,0)
 .N DIE,DA,DR
"RTN","PSIVORC1",39,0)
 .F ADCNT=0:0 S ADCNT=$O(^PS(53.1,+PSGORD,"AD",ADCNT)) Q:'ADCNT  D
"RTN","PSIVORC1",40,0)
 ..S $P(DRG("AD",ADCNT),U,4)=""
"RTN","PSIVORC1",41,0)
 I $G(PSG53) G 53
"RTN","PSIVORC1",42,0)
 ;*End PSJ*5*270
"RTN","PSIVORC1",43,0)
 N PSGINFAT S PSGINFAT=0 I ((P(4)="P")!$G(P(5))!($G(P(23))="P")) I P(8)["@" D
"RTN","PSIVORC1",44,0)
 .W !!,"Infusion Rate contains ""@"" (not allowed with an Intermittent IV order)",!
"RTN","PSIVORC1",45,0)
 .D 59 S:'(P(8)["@") P("NUMLBL")="" I P(8)["@" S PSGINFAT=1
"RTN","PSIVORC1",46,0)
 I $G(PSGINFAT) G 53
"RTN","PSIVORC1",47,0)
 I PSIVAC'="PN" D ENT^PSIVCAL K %DT S X=P(2),%DT="RTX" D ^%DT S P(2)=+Y D ENSTOP^PSIVCAL K %DT S X=P(3),%DT="RTX" D ^%DT S P(3)=+Y
"RTN","PSIVORC1",48,0)
OTYP ; Get order type, display type.
"RTN","PSIVORC1",49,0)
 S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3) S:PSIVAC'="CF" P("OT")=$S(P(4)="A":"F",P(4)="H":"H",1:"I")
"RTN","PSIVORC1",50,0)
 Q
"RTN","PSIVORC1",51,0)
 ;
"RTN","PSIVORC1",52,0)
C ; Edit Chemo order
"RTN","PSIVORC1",53,0)
 N DIR S DIR(0)="SA^A:ADMIXTURE;P:PIGGYBACK;S:SYRINGE",DIR("A")="CHEMOTHERAPY TYPE: " D DIRQ,^DIR S:$D(DTOUT)!(X=U) DONE=1 Q:$E(X)="^"!(DONE)  S P(23)=Y D:P(23)["S" S
"RTN","PSIVORC1",54,0)
 Q
"RTN","PSIVORC1",55,0)
 ;
"RTN","PSIVORC1",56,0)
S ; Edit Syringe order
"RTN","PSIVORC1",57,0)
56 ; Intermittent Syringe
"RTN","PSIVORC1",58,0)
 N DIR S DIR(0)="Y",DIR("??")="^S F1=53.1,F2=56 D ENHLP^PSIVORC1",DIR("A")="INTERMITTENT SYRINGE" D ^DIR Q:$D(DIRUT)  S P(5)=Y
"RTN","PSIVORC1",59,0)
 ;
"RTN","PSIVORC1",60,0)
55 ; Syringe Size
"RTN","PSIVORC1",61,0)
 N DA,DIR S DIR(0)="53.1,55" D ^DIR I $D(DTOUT)!$D(DUOUT) S DONE=1 Q
"RTN","PSIVORC1",62,0)
 S P("SYRS")=Y
"RTN","PSIVORC1",63,0)
 Q
"RTN","PSIVORC1",64,0)
 ;
"RTN","PSIVORC1",65,0)
DIRQ ; Set DIR("?") for IV Type prompt.
"RTN","PSIVORC1",66,0)
 S DIR("?")="Enter a code from the list above.",DIR("??")="^S F1=55.01,F2="_$S(DIR("A")["CHEMO":106,1:.04)_" D ENHLP^PSIVORC1"
"RTN","PSIVORC1",67,0)
 S DIR("?",1)="CHOOSE FROM:",Y=$P(DIR(0),U,2) F X=1:1:5 S DIR("?",X+1)="              "_$P($P(Y,";",X),":")_"    "_$P($P(Y,";",X),":",2)
"RTN","PSIVORC1",68,0)
 Q
"RTN","PSIVORC1",69,0)
 ;
"RTN","PSIVORC1",70,0)
CKFLDS ; Find required fields missing data.
"RTN","PSIVORC1",71,0)
 NEW PSIVASX,PSIVASY,FIL,DRGTMP
"RTN","PSIVORC1",72,0)
 S EDIT="" F PSIVASX="AD","SOL" D
"RTN","PSIVORC1",73,0)
 .I '$D(DRG(PSIVASX)) S EDIT=EDIT_U_$S(PSIVASX="AD":57,1:58) Q
"RTN","PSIVORC1",74,0)
 .S DNE=0 F PSIVASY=0:0 S PSIVASY=$O(DRG(PSIVASX,PSIVASY)) Q:'PSIVASY!DNE  D
"RTN","PSIVORC1",75,0)
 .. I $P(DRG(PSIVASX,PSIVASY),U,3)="" S EDIT=EDIT_U_$S(PSIVASX="AD":57,1:58),DNE=1
"RTN","PSIVORC1",76,0)
 .. I $P(DRG(PSIVASX,PSIVASY),U,4)="See Comments",(EDIT'["57") S EDIT=EDIT_U_$S(PSIVASX="AD":57,1:58),DNE=1
"RTN","PSIVORC1",77,0)
 S:'P("MR") EDIT=EDIT_U_3 F X=8,6,2,3 I P(X)="" S EDIT=EDIT_U_$S(X=8:59,X=6:1,X=2:10,X=3:25,1:"")
"RTN","PSIVORC1",78,0)
 I P("DTYP")=1 S:P(9)="" EDIT=EDIT_U_26 S:P(11)="" EDIT=EDIT_U_39
"RTN","PSIVORC1",79,0)
 S:$E(EDIT,1)=U EDIT=$E(EDIT,2,999)
"RTN","PSIVORC1",80,0)
 Q
"RTN","PSIVORC1",81,0)
 ;
"RTN","PSIVORC1",82,0)
DONE ; Kill variables and exit
"RTN","PSIVORC1",83,0)
 K ACTION,AD,DFN,DNE,DONE,DONE1,DRG,DRGI,DRGN,DRGT,DRGTN,EDIT,ERR,F1,F2,FIL,HDT,J,LN,LN2,ND,ON,ON1,ON55,ORIFN,P,P16,PC,PDM,PG,PN,PNME,PNOW,PSGLMT,PSGODDD
"RTN","PSIVORC1",84,0)
 K PSGSS,PSGSSH,PSIV,PSIVAC,PSIVAT,PSIVCV,PSIVE,PSIVHD,PSIVLN,PSIVOK,PSIVOLD,PSIVORUT,PSIVREA,PSIVSC1,PSIVSTR,PSIVSTRT,PSIVTYPE,PSIVUP,PSIVX,PSIVX1
"RTN","PSIVORC1",85,0)
 K PSJIVORF,PSJORF,PSJORIFN,PSJORL,PSJORNP,PSJORPF,PSJORSTS,PSJIVOF,PSJNKF,PSJORD,RB,RF,SOL,STOP,TYP,UL80,WD,WDN,WG,^TMP("PSIV",$J) D ENIVKV^PSGSETU
"RTN","PSIVORC1",86,0)
 Q
"RTN","PSIVORC1",87,0)
ENHLP ; order entry fields' help
"RTN","PSIVORC1",88,0)
 N PSJHP,PSJX,PSJD
"RTN","PSIVORC1",89,0)
 ;From within this routine, F1 and F2 will refer to file 53.1,field 56, file 55.01,field 106, or file 55.01,field .04
"RTN","PSIVORC1",90,0)
 D FIELD^DID(F1,F2,"","HELP-PROMPT","PSJHP")
"RTN","PSIVORC1",91,0)
 I X="?",$D(PSJHP("HELP-PROMPT")) S F=$G(PSJHP("HELP-PROMPT")) W !?5 F F0=1:1:$L(F," ") S F3=$P(F," ",F0) W:$L(F3)+$X>78 !?5 W F3_" "
"RTN","PSIVORC1",92,0)
 ;
"RTN","PSIVORC1",93,0)
 W:$D(^DD(F1,F2,12)) !,"("_^(12)_")" D FIELD^DID(F1,F2,"","XECUTABLE HELP","PSJX") I $D(PSJX("XECUTABLE HELP")) X PSJX("XECUTABLE HELP")
"RTN","PSIVORC1",94,0)
 ;
"RTN","PSIVORC1",95,0)
 ; new code
"RTN","PSIVORC1",96,0)
 D FIELD^DID(F1,F2,"","DESCRIPTION","PSJD") NEW F
"RTN","PSIVORC1",97,0)
 G:$S($G(X)="?":1,1:'$O(PSJD("DESCRIPTION",0))) SC F F=0:0 S F=$O(PSJD("DESCRIPTION",F)) Q:'F  I $D(PSJD("DESCRIPTION",F)) W !?2,PSJD("DESCRIPTION",F)
"RTN","PSIVORC1",98,0)
SC ;
"RTN","PSIVORC1",99,0)
 I F2=5!(F2=6) W !,"CHOOSE FROM:",!?8,0,?16,"NO",!?8,1,?16,"YES" Q
"RTN","PSIVORC1",100,0)
 Q
"RTN","PSIVORC1",101,0)
COMPLTE ;
"RTN","PSIVORC1",102,0)
 NEW PSIVDSFG S PSIVDSFG=0
"RTN","PSIVORC1",103,0)
 S P16=0,PSIVEXAM=1,(PSIVNOL,PSIVCT)=1 D GTOT^PSIVUTL(P(4)) D ^PSIVCHK I $D(DUOUT) W $C(7),!,"Order Unchanged.",! Q
"RTN","PSIVORC1",104,0)
 G:'$D(PSIVFN1) EDIT1
"RTN","PSIVORC1",105,0)
 I ERR=1 S Y=0 G EDIT1
"RTN","PSIVORC1",106,0)
 D CKORD^PSIVORC2 I $G(PSJFNDS)!$S($G(PSIVDSFG):0,PSIVCHG:1,1:0)!$$INFRATE^PSJMISC(DFN,ON,P(8),P("DTYP")) D
"RTN","PSIVORC1",107,0)
 . K PSJFNDS
"RTN","PSIVORC1",108,0)
 . I $$SEECMENT^PSIVEDRG() S PSGORQF=1 W !!,"*** One or more Additives has an invalid value for the bottle number(s).",! D PAUSE^PSJMISC() Q
"RTN","PSIVORC1",109,0)
 . S PSJDSVFY=1
"RTN","PSIVORC1",110,0)
 . D IN^PSJOCDS($G(ON),"IV","")
"RTN","PSIVORC1",111,0)
 . Q:$G(PSGORQF)
"RTN","PSIVORC1",112,0)
 . Q:'PSIVCHG
"RTN","PSIVORC1",113,0)
 D NOW^%DTC S P("LOG")=$E(%,1,12),P("CLRK")=DUZ_U_$P($G(^VA(200,DUZ,0)),U),P("INS")=""
"RTN","PSIVORC1",114,0)
 Q:$G(PSGORQF)
"RTN","PSIVORC1",115,0)
 W ! D ^PSIVORLB K PSIVEXAM S Y=P(2)
"RTN","PSIVORC1",116,0)
 W !,"Start date: " X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),?30," Stop date: " S Y=P(3) X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),!
"RTN","PSIVORC1",117,0)
EDIT ;
"RTN","PSIVORC1",118,0)
 I ERR=1 W !,"Please re-edit this order" K DIR S DIR(0)="E" D ^DIR K DIR W:'Y $C(7),"order unchanged." Q:'Y  S Y=0 G EDIT1
"RTN","PSIVORC1",119,0)
 ;PSJ*5*157 EFD FOR IV
"RTN","PSIVORC1",120,0)
 D EFDIV^PSJUTL($G(ZZND))
"RTN","PSIVORC1",121,0)
 W:$G(PSIVCHG) !,"*** This change will cause a new order to be created. ***"
"RTN","PSIVORC1",122,0)
 K DIR S DIR(0)="Y",DIR("A")="Is this O.K.",DIR("B")=$S(ERR:"NO",1:"YES"),DIR("?",1)="Enter ""Y"" to make this an active order (only allowed if no errors were"
"RTN","PSIVORC1",123,0)
 S DIR("?")="found in order), ""N"" to edit the order, or ""^"" to leave order unchanged.",DIR("??")="^S HELP=""EDIT"" D ^PSIVHLP"
"RTN","PSIVORC1",124,0)
 D ^DIR K DIR I $D(DIRUT) K DIRUT W $C(7),"Order unchanged." Q
"RTN","PSIVORC1",125,0)
 ;*  Kill Unit dose variables when calling from ^PSJLIFNI.
"RTN","PSIVORC1",126,0)
 I +Y,$G(PSJLIFNI) D
"RTN","PSIVORC1",127,0)
 . K ND,ND4,ND6,NDP2
"RTN","PSIVORC1",128,0)
 . K PSGAT,PSGCANFL,PSGDI,PSGDO,PSGDT,PSGEB,PSGEBN,PSGEFN,PSGFD,PSGFDN
"RTN","PSIVORC1",129,0)
 . K PSGHSM,PSGLI,PSGLIN,PSGLMT,PSGMR,PSGMRN,PSGNEDFD,PSGNEF,PSGNEFD
"RTN","PSIVORC1",130,0)
 . K PSGNESD,PSGOAT,PSGODO,PSGODT,PSGEA,PSGOEAV,PSGOEEF
"RTN","PSIVORC1",131,0)
 . K PSGOEEWF,PSGOEEG,PSGOEF,PSGOENG,PSGOES,PSGOFD,PSGOFDN,PSGOHSM
"RTN","PSIVORC1",132,0)
 . K PSGOINST,PSGOMR,PSGOMRN,PSGONC
"RTN","PSIVORC1",133,0)
 . K PSGOPD,PSOPDN,PSGOPR,PSGOPRN,PSGOSD,PSGOSDN,PSGOSI,PSGOSM
"RTN","PSIVORC1",134,0)
 . K PSGOST,PSGOSTN
"RTN","PSIVORC1",135,0)
 . K PSGPD,PSGPDN,PSGPDRG,PSGDRGN,PSGPFLG,PSGPI,PSGPR,PSGPRIO,PSGPRN
"RTN","PSIVORC1",136,0)
 . K PSGPTMP,PSGRRF,PSG0XT,PSGS0Y,PSGSCH,PSGSD,PSGSDN,PSGSI,PSGSM
"RTN","PSIVORC1",137,0)
 . K PSGST,PSGSTAT,PSGSTN,PSJACNWP,PSJACOK,PSJCOI
"RTN","PSIVORC1",138,0)
EDIT1 ;
"RTN","PSIVORC1",139,0)
 NEW XFLG,PSIVY S PSIVY=$G(Y)
"RTN","PSIVORC1",140,0)
 NEW X S X=$G(^TMP("PSJI",$J,0)),VALMBG=$S((X<17):1,1:(X-(X#16)))
"RTN","PSIVORC1",141,0)
 N PSINVON S PSINVON=ON I PSINVON["P" N PRVON S PRVON=$P($G(^PS(53.1,+ON,0)),"^",25) I PRVON["V" S PSINVON=PRVON
"RTN","PSIVORC1",142,0)
 I PSIVY=0!'$G(PSIVFN1) S PSIVFN1=1 D EN^VALM("PSJ LM IV AC/EDIT") Q
"RTN","PSIVORC1",143,0)
 S PSIVCHG=0 D EDCHK^PSIVORC2 K PSIVCHG I $G(PSJCOM) S ^TMP("PSJCOM",$J,+ON,17)=$G(P("NUMLBL")) K P("NUMLBL")
"RTN","PSIVORC1",144,0)
 S VALMBCK="Q",PSIVACEP=1
"RTN","PSIVORC1",145,0)
 Q
"RTN","PSIVORC1",146,0)
59 ; Infusion Rate
"RTN","PSIVORC1",147,0)
 N P8BADDEF S P8BADDEF=0
"RTN","PSIVORC1",148,0)
 I $G(P("RES"))="R" I $G(ON)["P",$P($G(^PS(53.1,+ON,0)),"^",24)="R" D  Q
"RTN","PSIVORC1",149,0)
 . Q:'$G(PSIVRENW)  W !!?5,"This is a Renewal Order. Infusion Rate may not be edited at this point." D PAUSE^VALM1
"RTN","PSIVORC1",150,0)
 W !,"INFUSION RATE: ",$G(P(8))_"//" R X:DTIME S:'$T X=U S:X=U DONE=1 I $S($E(X)=U:1,X]"":0,1:'(P(8)["@")) D:'$G(DONE) EXPINF^PSIVEDT1(.X) G:$G(P8BADDEF) 59 Q
"RTN","PSIVORC1",151,0)
 I (("C^P"[P(4))!(("C^S"[P(4))&(P(5)=1)))&((X["@")!((X="")&(P(8)["@"))) D  G 59
"RTN","PSIVORC1",152,0)
 .W $C(7),!!?2,"'@' is not permitted for Intermittent IV's",!
"RTN","PSIVORC1",153,0)
 I (X["^") D  G 59
"RTN","PSIVORC1",154,0)
 .W $C(7),!!?2,"'^' is not permitted",!
"RTN","PSIVORC1",155,0)
 I X=""&(("C^P"[P(4))!(("C^S"[P(4))&(P(5)=1))) Q
"RTN","PSIVORC1",156,0)
 I X="@" D DEL^PSIVEDRG S:%=1 P(8)="" G 59
"RTN","PSIVORC1",157,0)
 I X["???",($E(P("OT"))="I"),(PSIVAC["C") D ORFLDS^PSIVEDT1 G 59
"RTN","PSIVORC1",158,0)
 I X["?" S F1=53.1,F2=59 D ENHLP^PSIVORC1 G 59
"RTN","PSIVORC1",159,0)
 D EXPINF^PSIVEDT1(.X)
"RTN","PSIVORC1",160,0)
 I ($L(X)>30!($L(X)=1)),(X'?1N) D  G 59
"RTN","PSIVORC1",161,0)
 .W $C(7),!!?3,"Free text entries must contain a minimum of 2 characters",!?3,"and a maximum of 30 characters",!
"RTN","PSIVORC1",162,0)
 I X]"" D ENI^PSIVSP W:'$D(X) $C(7)," ??" G:'$D(X) 59 S P(8)=X
"RTN","PSIVORC1",163,0)
 I P(8)="" W $C(7),!!,"An infusion rate must be entered!" G 59
"RTN","PSIVORC1",164,0)
 Q
"RTN","PSIVORC1",165,0)
PSBPOIV ; Invalid IV bags based on BCMA IV parameters
"RTN","PSIVORC1",166,0)
 Q:'$G(DFN)  Q:'$G(ON55)  Q:'($G(ON55)["V")  Q:'$D(^PS(55,DFN,"IV",+ON55,0))
"RTN","PSIVORC1",167,0)
 I $P($G(^PS(55,DFN,"IV",+ON55,2)),"^",5)!($G(P("RES"))="R")!($G(P("FRES"))="R") D PSBPOIV^PSJIBAG(DFN,ON55)
"RTN","PSIVORC1",168,0)
 Q
"RTN","PSIVORC1",169,0)
 ;
"RTN","PSIVORC1",170,0)
SETNML55 ; Set NUMBER OF LABELS into ^PS(55,DFN,"IV",+ON55,0
"RTN","PSIVORC1",171,0)
 ;          Added to PROTOCOL PSJI LM VERIFY after call to VF^PSJLIACT
"RTN","PSIVORC1",172,0)
 ;          Made necessary by 11th hour code conflicts caused by MOCHA 2.0
"RTN","PSIVORC1",173,0)
 Q:'$D(P("NUMLBL"))  Q:'$G(DFN)  Q:'($G(ON55)["V")  Q:'$G(^PS(55,DFN,"IV",+ON55,0))
"RTN","PSIVORC1",174,0)
 S $P(^PS(55,DFN,"IV",+ON55,11),"^",1)=$G(P("NUMLBL"))
"RTN","PSIVORC1",175,0)
 Q
"RTN","PSIVORC1",176,0)
SETNL531 ;  Set NUMBER OF LABELS into ^PS(53.1,+PSGORD,8
"RTN","PSIVORC1",177,0)
 ;          Added to PROTOCOL PSJI LM VERIFY after call to VF^PSJLIACT
"RTN","PSIVORC1",178,0)
 ;          Made necessary by 11th hour code conflicts caused by MOCHA 2.0
"RTN","PSIVORC1",179,0)
 Q:'$D(P("NUMLBL"))  Q:'$G(DFN)  Q:'$G(PSGORD)  Q:'$G(^PS(53.1,+PSGORD,0))  ; $D is intentional - may edit from something to nothing
"RTN","PSIVORC1",180,0)
 S $P(^PS(53.1,+PSGORD,17),"^",1)=$G(P("NUMLBL"))
"RTN","PSIVORC1",181,0)
 Q
"RTN","PSIVORC2")
0^19^B62051926
"RTN","PSIVORC2",1,0)
PSIVORC2 ;BIR/MLM - PROCESS INCOMPLETE IV ORDER - CONT ;22 OCT 97  3:16 PM
"RTN","PSIVORC2",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**29,49,50,65,58,85,101,110,127,151,181,267,275,257,281**;16 DEC 97;Build 113
"RTN","PSIVORC2",3,0)
 ;
"RTN","PSIVORC2",4,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178
"RTN","PSIVORC2",5,0)
 ; Reference to ^PS(55 is supported by DBIA #2191
"RTN","PSIVORC2",6,0)
 ; Reference to EN1^ORCFLAG is supported by DBIA #3620.
"RTN","PSIVORC2",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVORC2",8,0)
 ; Reference to ^TMP("PSODAOC",$J is supported by# DBIA 6071
"RTN","PSIVORC2",9,0)
 ;
"RTN","PSIVORC2",10,0)
EDCHK ;Update or create new order in 55.
"RTN","PSIVORC2",11,0)
 D CKORD D:'$G(PSJIVORF) ORPARM^PSIVOREN I 'PSJIVORF W !,"Either the Inpatient Medications or the IV Medications package is not on, please check the Order Parameters file" Q
"RTN","PSIVORC2",12,0)
 I PSIVCHG,PSJIVORF D NATURE^PSIVOREN I '$D(P("NAT")) W $C(7),"Order unchanged" Q
"RTN","PSIVORC2",13,0)
 S:PSIVCHG P("21FLG")=""
"RTN","PSIVORC2",14,0)
 I $G(PSJCOM) D IV^PSJCOMV Q
"RTN","PSIVORC2",15,0)
 Q:$$NONVF()
"RTN","PSIVORC2",16,0)
ACTIVE ;
"RTN","PSIVORC2",17,0)
 S PSJCOM=P("PRNTON")
"RTN","PSIVORC2",18,0)
 I PSJCOM D VFYIV^PSJCOMV Q
"RTN","PSIVORC2",19,0)
 S P("RES")=$P($G(^PS(53.1,+ON,0)),U,24)
"RTN","PSIVORC2",20,0)
 I P("RES")="R" S P("NEWON")=P("OLDON") S PSJOSTOP="" D
"RTN","PSIVORC2",21,0)
 .N PSJTROPI,PSJNVO S PSJNVO=$G(P("NEWON")) I (PSJNVO["P") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO) Q
"RTN","PSIVORC2",22,0)
 .I ($G(P("PON"))["P"),($G(ON55)=P("PON")) S PSJNVO=P("PON") D FILEOPI^PSJBCMA5(DFN,PSJNVO) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,PSJNVO)
"RTN","PSIVORC2",23,0)
 .I $G(P("NEWON")) D FILEOPI^PSJBCMA5(DFN,P("NEWON")) S PSJTROPI=$$GETOPI^PSJBCMA5(DFN,P("NEWON"))
"RTN","PSIVORC2",24,0)
 .D RUPDATE^PSIVOREN(DFN,ON,P(2)) I $P($G(^PS(53.45,+$G(PSJSYSP),6,0)),"^",3)
"RTN","PSIVORC2",25,0)
 I P("RES")'="R" S PSJORD=ON,P(17)="A",ORSTS=6,PSJORNP=P(6) D SETNEW^PSIVORFB S P("NEWON")=ON55 D @$S(PSIVCHG:"NEWORD",1:"OLDORD")
"RTN","PSIVORC2",26,0)
 I $G(PSJIOPIV) D MVOPI^PSJBCMA5($G(DFN),$G(PSJORD),$G(ON55)),MVOPIAL^PSJBCMA5($G(DFN),$G(PSJORD),$G(ON55))
"RTN","PSIVORC2",27,0)
 S (ON55,ON)=P("NEWON"),OD=P(2) D EN^PSIVORE
"RTN","PSIVORC2",28,0)
 D CIMOI^PSJIMO1(DFN,ON55,"",$G(PSJORD))
"RTN","PSIVORC2",29,0)
 D VF1^PSJLIACT("F","ORDER VERIFIED BY ",1)
"RTN","PSIVORC2",30,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"N")
"RTN","PSIVORC2",31,0)
 I $G(^PS(55,DFN,"IV",+ON55,4)) D EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSIVORC2",32,0)
 L -^PS(53.1,+$G(PSJORD)) L -^PS(55,DFN,"IV",+ON55)
"RTN","PSIVORC2",33,0)
 Q
"RTN","PSIVORC2",34,0)
 ;
"RTN","PSIVORC2",35,0)
CKORD ;Check if new order is to be created.
"RTN","PSIVORC2",36,0)
 I $G(PSIVCOPY) S PSIVCHG=0 Q
"RTN","PSIVORC2",37,0)
 N ND,PSJCHG S PSIVCHG=0,ND(0)=$G(^PS(53.1,+ON,0)),ND("PD")=$G(^PS(53.1,+ON,.2))_U_$P(ND(0),U,3)
"RTN","PSIVORC2",38,0)
 N X S X=$P($G(^PS(53.1,+ON,8)),U,5),X=$S(P(8)["@":$P(X,"@"),1:X)
"RTN","PSIVORC2",39,0)
 ;S ND=$S($E(P("OT"))="I":P(8)_U_$P(ND(0),U,3)_U_+$P(ND("PD"),U),1:X_U_+$P(ND(0),U,3))_U_+P("PD"))
"RTN","PSIVORC2",40,0)
 S ND=$S($E(P("OT"))="I":P(8),1:X)_U_+$P(ND(0),U,3)_U_+$P(ND("PD"),U)
"RTN","PSIVORC2",41,0)
 S ND=ND_U_$S($P(ND(0),U,2)=+P("CLRK"):+$P(ND(0),U,2),1:+P(6))
"RTN","PSIVORC2",42,0)
 I ND'=($S($E(P("OT"))="I":P(8),P(8)["@":$P(P(8),"@"),1:P(8))_U_+P("MR")_U_+P("PD")_U_+P(6)) S PSIVCHG=1
"RTN","PSIVORC2",43,0)
 I 'PSIVCHG I $P($G(^PS(53.1,+ON,2)),U)'=P(9) S:($G(P("DTYP"))'=1) PSIVDSFG=1 S PSIVCHG=1
"RTN","PSIVORC2",44,0)
 N ND,TDRG,TMPDRG
"RTN","PSIVORC2",45,0)
 Q:PSIVCHG
"RTN","PSIVORC2",46,0)
 D TMPDRG1^PSJMISC(DFN,$G(ON),.TMPDRG)
"RTN","PSIVORC2",47,0)
 I $$COMPARE^PSJMISC(.DRG,.TMPDRG,$S(P("DTYP")=1:0,1:1)) S PSIVCHG=1
"RTN","PSIVORC2",48,0)
 K TMPDRG
"RTN","PSIVORC2",49,0)
 Q:PSIVCHG
"RTN","PSIVORC2",50,0)
 Q
"RTN","PSIVORC2",51,0)
CKPC ;
"RTN","PSIVORC2",52,0)
 ;PSJ*5*181 Note - No longer use by *181
"RTN","PSIVORC2",53,0)
 ;
"RTN","PSIVORC2",54,0)
 Q:PSIVCHG  I $E(P("OT"))'="I" D
"RTN","PSIVORC2",55,0)
 .;
"RTN","PSIVORC2",56,0)
 .; Check IV drugs for changes.
"RTN","PSIVORC2",57,0)
 .S DNE=0 F DRGT="AD","SOL" I $D(DRG(DRGT)) S FIL="52."_$S(DRGT="AD":6,1:7) D
"RTN","PSIVORC2",58,0)
 ..N ND,TDRG,ON1 F DRGI=0:0 S DRGI=$O(DRG(DRGT,DRGI)) Q:'DRGI!DNE  S TDRG(+$P(DRG(DRGT,DRGI),U),DRGI)=DRGI,TDRG("CNT")=+$G(TDRG("CNT"))+1
"RTN","PSIVORC2",59,0)
 ..F ON1=0:0 S ON1=$O(^PS(53.1,+ON,DRGT,ON1)) Q:'+ON1!DNE  S ND=$G(^PS(53.1,+ON,DRGT,ON1,0)),ND("CNT")=$G(ND("CNT"))+1 D
"RTN","PSIVORC2",60,0)
 ...S DRG=+$P(ND,U) S:'$D(TDRG(+DRG)) (DNE,PSIVCHG)=1 F DRGI=0:0 S DRGI=$O(TDRG(+DRG,DRGI)) Q:'DRGI!DNE  I $P($G(DRG(DRGT,DRGI)),U)_U_$P($G(DRG(DRGT,DRGI)),U,3)'=$P(ND,U,1,2) S (DNE,PSIVCHG)=1
"RTN","PSIVORC2",61,0)
 ..S:$G(ND("CNT"))'=$G(TDRG("CNT")) (DNE,PSIVCHG)=1 K ND,TDRG
"RTN","PSIVORC2",62,0)
 Q
"RTN","PSIVORC2",63,0)
 ;
"RTN","PSIVORC2",64,0)
OLDORD ; Update old order, update order links.
"RTN","PSIVORC2",65,0)
 Q:P("RES")="R"
"RTN","PSIVORC2",66,0)
 S P("OLDON")=$P($G(^PS(53.1,+ON,0)),U,25) I P("OLDON")'=ON55 S $P(^PS(55,DFN,"IV",+ON55,2),U,8)=P("RES"),$P(^(2),U,5)=P("OLDON") I P("OLDON") D
"RTN","PSIVORC2",67,0)
 .I P("OLDON")["V",$D(^PS(55,DFN,"IV",+P("OLDON"),0)) S $P(^(2),U,6)=ON55,$P(^(2),U,9)=P("RES")
"RTN","PSIVORC2",68,0)
 .I P("OLDON")["A",$D(^PS(55,DFN,5,+P("OLDON"),0)) S $P(^(0),U,26,27)=ON55_U_P("RES")
"RTN","PSIVORC2",69,0)
 .I $S(P("OLDON")["P":1,P("OLDON")["N":1,1:0),$D(^PS(53.1,+P("OLDON"),0)) S $P(^(0),U,26,27)=ON55_U_P("RES")
"RTN","PSIVORC2",70,0)
 D PUT531^PSIVORFA S $P(^PS(53.1,+ON,0),U,25,26)="^",ON=ON55 D UPD100^PSIVORFA
"RTN","PSIVORC2",71,0)
 Q
"RTN","PSIVORC2",72,0)
 ;
"RTN","PSIVORC2",73,0)
NEWORD ; Create new order, update order links.
"RTN","PSIVORC2",74,0)
 Q:P("RES")="R"
"RTN","PSIVORC2",75,0)
 S $P(^PS(53.1,+ON,0),U,26,27)=P("NEWON")_U_"E",PSIVAC="CE",PSJORNAT=P("NAT") D DC^PSIVORA
"RTN","PSIVORC2",76,0)
 S P("NEWON")=$P($G(^PS(53.1,+PSJORD,0)),U,26),$P(^PS(55,DFN,"IV",+P("NEWON"),2),U,5)=PSJORD,$P(^(2),U,8)="E",ON=ON55
"RTN","PSIVORC2",77,0)
 I PSJIVORF D EN1^PSJHL2(DFN,"SN",+ON55_"V","NEW ORDER CREATED")
"RTN","PSIVORC2",78,0)
 Q
"RTN","PSIVORC2",79,0)
 ;
"RTN","PSIVORC2",80,0)
GTIVDRG ; Try to find an IV drug from the Orderable Item.
"RTN","PSIVORC2",81,0)
 ; If there is only 1 match to OI then stuff in DRG otherwise prompt user to select which
"RTN","PSIVORC2",82,0)
 ; ad/sol matched to OI
"RTN","PSIVORC2",83,0)
 K PSIVOI NEW FIL,ND,SCR,PSJNOW
"RTN","PSIVORC2",84,0)
 D NOW^%DTC S PSJNOW=%
"RTN","PSIVORC2",85,0)
 S SCR("S")="S ND=$P($G(^(""I"")),U) I ND=""""!(ND>PSJNOW)"
"RTN","PSIVORC2",86,0)
 F FIL=52.6,52.7 D FIND^DIC(FIL,,"@;.01;2","QXP",+P("PD"),,"AOI",SCR("S"),,"PSIVOI") I +PSIVOI("DILIST",0)>0 D  Q
"RTN","PSIVORC2",87,0)
 . S DRGT=$S(FIL=52.6:"AD",1:"SOL"),PSIVOI=DRGT
"RTN","PSIVORC2",88,0)
 . I PSIVOI="AD" D
"RTN","PSIVORC2",89,0)
 .. N XX,XXX,QC S XX=0 F  S XX=$O(PSIVOI("DILIST",XX)) Q:XX=""  S XXX=+PSIVOI("DILIST",XX,0) D LIST^DIC(52.61,","_XXX_",","@;.01","PQ",,,,,,,"PSIVQC") D
"RTN","PSIVORC2",90,0)
 ... I +$G(PSIVQC("DILIST",0))>0 S QC=0 F  S QC=$O(PSIVQC("DILIST",QC)) Q:QC=""  S PSIVOI("DILIST",XX,QC,0)=PSIVQC("DILIST",QC,0)
"RTN","PSIVORC2",91,0)
 ... K PSIVQC("DILIST",0),PSIVQC("DILIST",0,"MAP")
"RTN","PSIVORC2",92,0)
 .. D RESET
"RTN","PSIVORC2",93,0)
 . I +PSIVOI("DILIST",0)=1 D
"RTN","PSIVORC2",94,0)
 .. S DRG=+PSIVOI("DILIST",1,0)
"RTN","PSIVORC2",95,0)
 .. S DNE=1,DRG(DRGT,0)=1,ND=$G(^PS(FIL,+DRG,0)),DRG(DRGT,1)=+DRG_U_$P(ND,U)_U_$S(FIL=52.7:$P(ND,U,3),1:"")_U_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSIVORC2",96,0)
 K:+PSIVOI("DILIST",0)<2 PSIVOI
"RTN","PSIVORC2",97,0)
 Q
"RTN","PSIVORC2",98,0)
 ;
"RTN","PSIVORC2",99,0)
EDIT ; Edit incomplete order
"RTN","PSIVORC2",100,0)
 K PSIVENO
"RTN","PSIVORC2",101,0)
 S PSIVAC="CE"
"RTN","PSIVORC2",102,0)
 I $E(P("OT"))="I",'$D(DRG("AD")),('$D(DRG("SOL"))) D GTIVDRG
"RTN","PSIVORC2",103,0)
 I P(4)="" D 53^PSIVORC1 Q:P(4)=""  D ^PSIVORV2
"RTN","PSIVORC2",104,0)
 D GSTRING^PSIVORE1,GTFLDS^PSIVORFE ;S (PSIVOK,EDIT)="57^58^59^3"_$S(P("DTYP")=1:"^26^39",1:"")_"^63^64^"_$S($E(P("OT"))="I":"101^109^",1:"")_"10^25"_$S(+P(6)'=+P("CLRK"):"^1",1:"") D GTFLDS^PSIVORFE
"RTN","PSIVORC2",105,0)
 Q:$G(DONE)
"RTN","PSIVORC2",106,0)
 I '$G(PSIVENO) S PSIVENO=1 D EN^VALM("PSJ LM IV AC/EDIT") S VALMBCK="Q"
"RTN","PSIVORC2",107,0)
 Q
"RTN","PSIVORC2",108,0)
 ;
"RTN","PSIVORC2",109,0)
FINISH ; Ask only for missing data in incomplete IV order.
"RTN","PSIVORC2",110,0)
 S P("OPI")=$$ENPC^PSJUTL("V",+PSIVUP,60,P("OPI")) I $E(P("OT"))="I",'$D(DRG("AD")),('$D(DRG("SOL"))) S DNE=0 D GTIVDRG
"RTN","PSIVORC2",111,0)
 D:P(4)="" 53^PSIVORC1 Q:P(4)=""  S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSIVORC2",112,0)
 I 'P(2) D ENT^PSIVCAL K %DT S X=P(2),%DT="RTX" D ^%DT S P(2)=+Y
"RTN","PSIVORC2",113,0)
 I 'P(3) D ENSTOP^PSIVCAL K %DT S X=P(3),%DT="RTX" D ^%DT S P(3)=+Y
"RTN","PSIVORC2",114,0)
 I 'P("MR") S P("MR")=$O(^PS(51.2,"B","INTRAVENOUS",0))_"^IV"
"RTN","PSIVORC2",115,0)
 S PSIVOK="1^3^10^25^26^39^57^58^59^63^64" D CKFLDS^PSIVORC1 D:EDIT]"" EDIT^PSIVEDT G COMPLTE^PSIVORC1
"RTN","PSIVORC2",116,0)
 Q
"RTN","PSIVORC2",117,0)
NONVF() ; Updated 53.1 status to non-verified after finish.
"RTN","PSIVORC2",118,0)
 NEW PSGOEAV S PSGOEAV=+$P(PSJSYSP0,U,9)
"RTN","PSIVORC2",119,0)
 S ^TMP("PSODAOC",$J,"IP NEW IEN")=ON
"RTN","PSIVORC2",120,0)
 ;;;;D SETOC^PSJNEWOC(ON)
"RTN","PSIVORC2",121,0)
 I +PSJSYSU=3,PSGOEAV Q 0
"RTN","PSIVORC2",122,0)
 I +PSJSYSU=1,PSGOEAV Q 0
"RTN","PSIVORC2",123,0)
 I PSIVCHG D NWNONVF Q 1
"RTN","PSIVORC2",124,0)
 S P(17)="N",P("REN")=0
"RTN","PSIVORC2",125,0)
 D GTPD^PSIVORE2
"RTN","PSIVORC2",126,0)
 W !,"...transcribing this non-verified order...."
"RTN","PSIVORC2",127,0)
 S $P(^PS(53.1,+ON,.2),U)=""
"RTN","PSIVORC2",128,0)
 D PUT531^PSIVORFA
"RTN","PSIVORC2",129,0)
 D NEWNVAL^PSGAL5(ON,$S(+PSJSYSU=1:22000,+PSJSYSU=3:22005,1:22006),"","")
"RTN","PSIVORC2",130,0)
 I ($G(PSJINFIN)=2) D NEWNVAL^PSGAL5(ON,6000,"OTHER PRINT INFO")
"RTN","PSIVORC2",131,0)
 NEW PSIVORFA S PSIVORFA=1 D:ON["V" DEL55^PSIVORE2
"RTN","PSIVORC2",132,0)
 D VF
"RTN","PSIVORC2",133,0)
 Q 1
"RTN","PSIVORC2",134,0)
NWNONVF ;Create non-verified due to edit
"RTN","PSIVORC2",135,0)
 K DA D ENGNN^PSGOETO S P("NEWON")=DA_"P",P(17)="N",P("REN")=0
"RTN","PSIVORC2",136,0)
 I $D(^PS(53.45,PSJSYSP,6,1)) D FILEOPI^PSJBCMA5(DFN,P("NEWON"))
"RTN","PSIVORC2",137,0)
 S PSJORD=ON,$P(^PS(53.1,+ON,0),U,26,27)=P("NEWON")_U_"E",PSIVAC="CE",PSJORNAT=P("NAT") D DC^PSIVORA
"RTN","PSIVORC2",138,0)
 S P("OLDON")=ON,ON=P("NEWON")
"RTN","PSIVORC2",139,0)
 I $D(^PS(53.1,+P("OLDON"),12)) M ^PS(53.1,+P("NEWON"),12)=^PS(53.1,+P("OLDON"),12)
"RTN","PSIVORC2",140,0)
 S P("RES")="E"
"RTN","PSIVORC2",141,0)
 S P("DO")="" D GTPD^PSIVORE2 ;Get dosage order if not defined for IPM IV
"RTN","PSIVORC2",142,0)
 D PUT531^PSIVORFA
"RTN","PSIVORC2",143,0)
 S $P(^PS(53.1,+ON,0),U,25,26)=P("OLDON")_U_""
"RTN","PSIVORC2",144,0)
 D NEWNVAL^PSGAL5(ON,$S(+PSJSYSU=1:22000,+PSJSYSU=3:22005,1:22006),"","")
"RTN","PSIVORC2",145,0)
 D EN1^PSJHL2(DFN,"SN",ON,"SEND ORDER NUMBER")
"RTN","PSIVORC2",146,0)
 S ^TMP("PSODAOC",$J,"IP NEW IEN")=ON
"RTN","PSIVORC2",147,0)
 ;;;;D SETOC^PSJNEWOC(ON)
"RTN","PSIVORC2",148,0)
 S:$D(PSGP)#10 PSJNOL=$$LS^PSSLOCK(PSGP,ON)
"RTN","PSIVORC2",149,0)
 D VF
"RTN","PSIVORC2",150,0)
 Q
"RTN","PSIVORC2",151,0)
VF ; Display Verify screen
"RTN","PSIVORC2",152,0)
 Q:ON'["P"
"RTN","PSIVORC2",153,0)
 K PSJIVBD
"RTN","PSIVORC2",154,0)
 D GT531^PSIVORFA(DFN,ON)
"RTN","PSIVORC2",155,0)
 S:$G(ON)]"" (ON55,PSJORD)=ON ;* CCR 6700
"RTN","PSIVORC2",156,0)
 S PSGACT="EL"
"RTN","PSIVORC2",157,0)
 I P(17)="N",(P("OLDON")=""),(+P("CLRK")=DUZ) S PSGACT="ELD"
"RTN","PSIVORC2",158,0)
 I +PSJSYSU=3!(+PSJSYSU=1) S PSGACT="DELV"
"RTN","PSIVORC2",159,0)
 I +PSJSYSU=3,$L($T(EN1^ORCFLAG)) S PSGACT=PSGACT_"G"
"RTN","PSIVORC2",160,0)
 I P("OT")="I" S PSJSTAR="(1)^(5)^(7)^(9)^(10)"
"RTN","PSIVORC2",161,0)
 I P("OT")'="I" S PSJSTAR="(1)^(2)^(3)^(5)^(7)^(9)"
"RTN","PSIVORC2",162,0)
 D EN^VALM("PSJ LM IV INPT ACTIVE")
"RTN","PSIVORC2",163,0)
 ;RTC 178746 - Only store allergy if not verified after entering the order
"RTN","PSIVORC2",164,0)
 I ($G(ON)["P"),($S(($G(PSJOCFG)="NEW OE IV"):1,($G(PSJOCFG)="FN IV"):1,$G(PSIVENO):1,1:0)) D SETOC^PSJNEWOC(ON)
"RTN","PSIVORC2",165,0)
 Q
"RTN","PSIVORC2",166,0)
 ;
"RTN","PSIVORC2",167,0)
RESET ;Reset PSIVOI("DILIST") for additives with quick codes
"RTN","PSIVORC2",168,0)
 N XX,XXX,CNT S CNT=0
"RTN","PSIVORC2",169,0)
 S XX=0 F  S XX=$O(PSIVOI("DILIST",XX)) Q:XX=""  S CNT=CNT+1,LYN(CNT)=PSIVOI("DILIST",XX,0) D
"RTN","PSIVORC2",170,0)
 . S XXX=0 F  S XXX=$O(PSIVOI("DILIST",XX,XXX)) Q:XXX=""  S CNT=CNT+1,LYN(CNT)=$P(PSIVOI("DILIST",XX,0),"^")_"^"_$P(PSIVOI("DILIST",XX,XXX,0),"^",2)_"^"_$P(PSIVOI("DILIST",XX,XXX,0),"^")_"^"_"QC"
"RTN","PSIVORC2",171,0)
 K PSIVOI("DILIST")
"RTN","PSIVORC2",172,0)
 S PSIVOI("DILIST",0)=CNT_"^*^0^"
"RTN","PSIVORC2",173,0)
 S XX=0 F  S XX=$O(LYN(XX)) Q:'XX  S PSIVOI("DILIST",XX,0)=LYN(XX)
"RTN","PSIVORC2",174,0)
 K LYN
"RTN","PSIVORC2",175,0)
 Q
"RTN","PSIVORE")
0^35^B44481597
"RTN","PSIVORE",1,0)
PSIVORE ;BIR/PR,MLM-ORDER ENTRY ;1 APR 08 / 2:37 PM
"RTN","PSIVORE",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**18,29,50,56,58,81,110,127,133,157,203,213,181,252,305,281**;16 DEC 97;Build 113
"RTN","PSIVORE",3,0)
 ;
"RTN","PSIVORE",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIVORE",5,0)
 ; Reference to ^ORX2 is supported by DBIA #867
"RTN","PSIVORE",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVORE",7,0)
 ; Reference to ^DICN is supported by DBIA #10009.
"RTN","PSIVORE",8,0)
 ; Reference to ^DIR is supported by DBIA #10026.
"RTN","PSIVORE",9,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSIVORE",10,0)
 ; Reference to ^VADPT is supported by DBIA #10061.
"RTN","PSIVORE",11,0)
 ; Reference to ^DD("DD" is supported by DBIA #999.
"RTN","PSIVORE",12,0)
 ; Reference to ^TMP("PSODAOC",$J is supported by #DBIA 6071.
"RTN","PSIVORE",13,0)
 ;
"RTN","PSIVORE",14,0)
 N PSJNEW,PSJOUT,PSGPTMP,PPAGE,FLAG S PSJNEW=1
"RTN","PSIVORE",15,0)
 ;
"RTN","PSIVORE",16,0)
 D SITE Q:'$G(PSIVQ)  K PSIVQ S PSGOP=""
"RTN","PSIVORE",17,0)
 ;
"RTN","PSIVORE",18,0)
BEG ;Get patient and make sure he is living.
"RTN","PSIVORE",19,0)
 L +^PS(53.45,DUZ):1 E  D LOCKERR^PSJOE G Q
"RTN","PSIVORE",20,0)
 ;* F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  D ASK
"RTN","PSIVORE",21,0)
 ;* F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  S X=DFN_";DPT(" D LK^ORX2 Q:'Y  D ASK S X=DFN_";DPT(" D ULK^ORX2
"RTN","PSIVORE",22,0)
 NEW PSJLK
"RTN","PSIVORE",23,0)
 F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  S PSJLK='$$L^PSSLOCK(DFN,1) Q:PSJLK  D ASK,UL^PSSLOCK(DFN)
"RTN","PSIVORE",24,0)
 I PSGOP,$P(PSJSYSL,"^",2)]"" D ENQL^PSGLW
"RTN","PSIVORE",25,0)
 G Q
"RTN","PSIVORE",26,0)
 ;
"RTN","PSIVORE",27,0)
ASK ;See if patient has been admitted.
"RTN","PSIVORE",28,0)
 I VADM(6) W !?5,"Patient has died." Q
"RTN","PSIVORE",29,0)
 I 'VAIN(4) K DIK S DIR(0)="Y",DIR("A")="Do you wish to continue",DIR("B")="NO",DIR("??")="^S HELP=""ADMYN"" D ^PSIVHLP1" W !,"This patient has not been admitted." D ^DIR K DIR Q:'Y
"RTN","PSIVORE",30,0)
 S:VAIN(4) WSCHADM=+VAIN(4)
"RTN","PSIVORE",31,0)
 ;
"RTN","PSIVORE",32,0)
SETN ;Set up patient 0 node if needed.
"RTN","PSIVORE",33,0)
 I '$D(^PS(55,DFN,0)) K DO,DA,DD,DIC,PSIVFN S:$D(^(5.1)) PSIVFN=^(5.1) K:$D(PSIVFN) ^(5.1) S (DINUM,X)=DFN,DIC(0)="L",DIC="^PS(55," D FILE^DICN S:$D(PSIVFN) ^PS(55,DFN,5.1)=PSIVFN D  K DIC,PSIVFN,DO,DA,DD,DINUM
"RTN","PSIVORE",34,0)
 .; Mark PSJ and PSO as converted
"RTN","PSIVORE",35,0)
 .S $P(^PS(55,DFN,5.1),"^",11)=2
"RTN","PSIVORE",36,0)
 S PSJNARC=1
"RTN","PSIVORE",37,0)
 S PSGP=DFN,PSJPWD=+VAIN(4),PSIVAC="P",PSIVBR="D ^PSIVOPT" D HK,ENCHS1^PSIV Q:'$D(DFN)
"RTN","PSIVORE",38,0)
 Q
"RTN","PSIVORE",39,0)
 ;
"RTN","PSIVORE",40,0)
NEW ;Ask to enter new order.
"RTN","PSIVORE",41,0)
 D:'$D(VADM(1)) DEM^VADPT
"RTN","PSIVORE",42,0)
 K P,PSIVCHG,PSIVTYPE,PSJOE,DIR S DIR(0)="Y",DIR("A")="New order for "_VADM(1),DIR("B")="YES",DIR("??")="^S HELP=""NEWORD"" D ^PSIVHLP" D ^DIR K DIR Q:'Y
"RTN","PSIVORE",43,0)
 NEW X S X=DFN_";DPT(" D LK^ORX2 Q:'Y  S PSJLSORX=1
"RTN","PSIVORE",44,0)
INMED K ON55,PSJOUT S (P(4),P("OT"),P("FRES"))="" D NEW55^PSIVORFB I '$D(ON55) D ULK G:'$D(PSJOE)&('$D(PSJOUT)) NEW G Q
"RTN","PSIVORE",45,0)
 NEW PSJOCFG
"RTN","PSIVORE",46,0)
 S PSJOCFG="NEW OE IV"
"RTN","PSIVORE",47,0)
 S P("RES")="N",PSIVAC="PN",P("PON")=ON55,PSIVUP=+$$GTPCI^PSIVUTL D NEW^PSIVORE2 I $G(P(2))="" D DEL55^PSIVORE2 D ULK G:'$D(PSJOE) NEW Q
"RTN","PSIVORE",48,0)
 D OK L -^PS(55,DFN,"IV",+ON55) D ULK K PSJOCFG G:'$D(PSJOE) NEW
"RTN","PSIVORE",49,0)
 ;
"RTN","PSIVORE",50,0)
Q ; Kill and exit.
"RTN","PSIVORE",51,0)
 L:'$D(PSJOE) -^PS(53.45,DUZ) S PSJNKF=1 D Q^PSIV
"RTN","PSIVORE",52,0)
 K FIL,I1,ND,PC,PDM,PSGDT,PSGID,PSGLMT,PSGSI,PSJNARC,PSIVAC,PSIVCHG,PSIVUP,PSIVX,PSJOPC
"RTN","PSIVORE",53,0)
 Q
"RTN","PSIVORE",54,0)
 ;
"RTN","PSIVORE",55,0)
ULK ;
"RTN","PSIVORE",56,0)
 Q:'$G(PSJLSORX)  ;If NEW^PSIVORE did not lock, don't kill it here.
"RTN","PSIVORE",57,0)
 NEW X S X=DFN_";DPT(" D ULK^ORX2 K PSJLSORX
"RTN","PSIVORE",58,0)
 Q
"RTN","PSIVORE",59,0)
HK ;Queue job to print MAR labels generated for this patient.
"RTN","PSIVORE",60,0)
 I PSGOP,PSGOP'=DFN D
"RTN","PSIVORE",61,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSIVORE",62,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,U,2)]"" ENQL^PSGLW
"RTN","PSIVORE",63,0)
 S PSGOP=DFN
"RTN","PSIVORE",64,0)
 Q
"RTN","PSIVORE",65,0)
 ;
"RTN","PSIVORE",66,0)
SITE ;See if site parameters are ok.
"RTN","PSIVORE",67,0)
 K PSIVQ D ^PSIVXU Q:$D(XQUIT)
"RTN","PSIVORE",68,0)
 I '$D(PSIVSN)!('$D(PSIVSITE)) W $C(7),$C(7),!!,"You have no IV ROOM parameters ... PLEASE ... PLEASE ...",!,"Exit this package and reenter properly !!",!! Q
"RTN","PSIVORE",69,0)
 D ORPARM^PSIVOREN S PSIVQ=1
"RTN","PSIVORE",70,0)
 Q
"RTN","PSIVORE",71,0)
 ;
"RTN","PSIVORE",72,0)
OK ;Print example label, run order through checker, ask if it is ok.
"RTN","PSIVORE",73,0)
 S P16=0,PSIVEXAM=1,(PSIVNOL,PSIVCT)=1 D GTOT^PSIVUTL(P(4)) I $G(P("PD"))="" D GTPD^PSIVORE2
"RTN","PSIVORE",74,0)
 D ^PSIVCHK I $D(DUOUT) S X="^" G DOA
"RTN","PSIVORE",75,0)
 I ERR=1 S X="N" G BAD
"RTN","PSIVORE",76,0)
 W ! D ^PSIVORLB K PSIVEXAM S Y=P(2) W !,"Start date: " X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),?30," Stop date: " S Y=P(3) X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),!
"RTN","PSIVORE",77,0)
 ;PSJ*5*157 EFD for IVs
"RTN","PSIVORE",78,0)
 D EFDIV^PSJUTL($G(ZZND))
"RTN","PSIVORE",79,0)
 D:'$G(PSGORQF) IN^PSJOCDS($G(ON55),"IV","") I $G(PSGORQF) D DEL55 Q
"RTN","PSIVORE",80,0)
 W:$G(PSIVCHG) !,"*** This change will cause a new order to be created. ***"
"RTN","PSIVORE",81,0)
 I '$G(PSIVCOPY) G:PSIVAC["R" OK1 S X="Is this O.K.: ^"_$S(ERR:"NO",1:"YES")_"^^NO"_$S(ERR'=1:",YES",1:"") D ENQ^PSIV
"RTN","PSIVORE",82,0)
 S PSJIVBD=1 ;var use to indicate order enter from back door
"RTN","PSIVORE",83,0)
BAD ;; I X["N" D GSTRING^PSIVORE1,^PSIVORV2,GTFLDS^PSIVORFE G OK
"RTN","PSIVORE",84,0)
 I ON55["V",($G(P(21))="") S P(17)="N"
"RTN","PSIVORE",85,0)
 I X["N" NEW PSGEBN,PSGLI S (P("INS"),PSGEBN,PSGLI)="",(PSJORD,ON)=ON55 D EN^VALM("PSJ LM IV AC/EDIT") S VALMBCK="Q" Q
"RTN","PSIVORE",86,0)
 I X["?" S HELP="OK" D ^PSIVHLP G OK
"RTN","PSIVORE",87,0)
DOA I X["^" D DEL55^PSIVORE2 Q
"RTN","PSIVORE",88,0)
 Q:$$NONVF("SN")
"RTN","PSIVORE",89,0)
OK1 S PSJORL=$$ENORL^PSJUTL($G(VAIN(4))),P(17)="A",ORSTS=6,ON=ON55,PSJORNP=+P(6)
"RTN","PSIVORE",90,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN
"RTN","PSIVORE",91,0)
 I PSJIVORF D NATURE^PSIVOREN I '$D(P("NAT")) D DEL55^PSIVORE2 Q
"RTN","PSIVORE",92,0)
 D SET55^PSIVORFB
"RTN","PSIVORE",93,0)
 I PSJIVORF,($G(P(22))=.5) D CLINIC^PSIVOREN
"RTN","PSIVORE",94,0)
 I PSJIVORF D SET^PSIVORFE S ORNATR=P("NAT"),ON=+ON55,OD=P(2) D EN1^PSJHL2(DFN,"SN",+ON55_"V","SEND ORDER NUMBER") ;,EN1^PSJHL2(DFN,"SC",+ON55_"V","NEW ORDER CREATED")
"RTN","PSIVORE",95,0)
 D VF1^PSJLIACT("V","ORDER ENTERED AS ACTIVE BY ",1)
"RTN","PSIVORE",96,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"N")
"RTN","PSIVORE",97,0)
 ;
"RTN","PSIVORE",98,0)
CAL ;Calculate doses.
"RTN","PSIVORE",99,0)
 ;S OD=P(2) D EN,^PSIVORE1,^PSIVOPT
"RTN","PSIVORE",100,0)
 S OD=P(2) D EN,^PSIVOPT
"RTN","PSIVORE",101,0)
 Q
"RTN","PSIVORE",102,0)
 ;
"RTN","PSIVORE",103,0)
EN ;Update schedule interval P(15) only on continuous orders.
"RTN","PSIVORE",104,0)
 ;This includes Hyp/Adm/Continuous Syringes/Chemos =>P(5)=0
"RTN","PSIVORE",105,0)
 Q:'$D(DFN)!('$D(ON55))  Q:$P(^PS(55,DFN,"IV",+ON55,0),U,4)="P"!($P(^(0),U,5))!($P(^(0),U,23)="P")
"RTN","PSIVORE",106,0)
 D SPSOL S XXX=$P(^PS(55,DFN,"IV",+ON55,0),U,8) G:'SPSOL ENQ I XXX?1N.N.1".".N1" ml/hr"!(XXX?1"0."1N1" ml/hr") S P(15)=$S('XXX:0,1:SPSOL\XXX*60+(SPSOL#XXX/XXX*60+.5)\1),$P(^PS(55,DFN,"IV",+ON55,0),U,15)=P(15) G ENQ
"RTN","PSIVORE",107,0)
 S P(15)=$S('$P(XXX,"@",2):0,1:1440/$P(XXX,"@",2)\1),$P(^PS(55,DFN,"IV",+ON55,0),U,15)=P(15)
"RTN","PSIVORE",108,0)
ENQ K SPSOL,XXX Q
"RTN","PSIVORE",109,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(^PS(55,DFN,"IV",+ON55,"SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(^(XXX,0),U,2)
"RTN","PSIVORE",110,0)
 K XXX Q
"RTN","PSIVORE",111,0)
ENIN ;Entry for Combined IV/UD order entry. Called by PSJOE0.
"RTN","PSIVORE",112,0)
 D HOLDHDR^PSJOE
"RTN","PSIVORE",113,0)
 W !
"RTN","PSIVORE",114,0)
 N PSJOUT S (DONE,FLAG)=0,PSIVAC="PN"
"RTN","PSIVORE",115,0)
ENIN1 ;
"RTN","PSIVORE",116,0)
 ;*305
"RTN","PSIVORE",117,0)
 N DA,DIR,PSJOE,PSJPCAF,PSJSYSL,WSCHADM,PSJALLGY,PSJEXMSG S:$G(VAIN(4)) WSCHADM=VAIN(4)
"RTN","PSIVORE",118,0)
 K P,PSIVCHG,PSJCOM,^TMP("PSODAOC",$J)
"RTN","PSIVORE",119,0)
 S PSJOE=1,DIR(0)="55.01,.04O",DIR("A")="Select IV TYPE" D ^DIR
"RTN","PSIVORE",120,0)
 I X]"",X'="^",$P("^PROFILE",X)="" S PSJOEPF=X Q
"RTN","PSIVORE",121,0)
 S:$D(DTOUT) X="^" I "^"[X S PSJORQF=PSJORQF+$S(X="^":2,$G(FLAG):0,1:1),X="." Q
"RTN","PSIVORE",122,0)
 S FLAG=1,PSIVTYPE=Y,(P(5),P(23))="" I "SC"[Y D @(Y_"^PSIVORC1") S $P(PSIVTYPE,U,2)=P(23)
"RTN","PSIVORE",123,0)
 D INMED G:'$D(PSJOUT) ENIN S:$D(PSJOUT) PSJORQF=2
"RTN","PSIVORE",124,0)
 Q
"RTN","PSIVORE",125,0)
NONVF(PSJOC)  ;If file at NonVF then quit with 1
"RTN","PSIVORE",126,0)
 NEW PSGOEAV S PSGOEAV=+$P(PSJSYSP0,U,9)
"RTN","PSIVORE",127,0)
 I +PSJSYSU=3,PSGOEAV Q 0
"RTN","PSIVORE",128,0)
 I +PSJSYSU=1,PSGOEAV Q 0
"RTN","PSIVORE",129,0)
 K DA D ENGNN^PSGOETO S ON=DA_"P",P(17)="N",P("REN")=0
"RTN","PSIVORE",130,0)
 D GTPD^PSIVORE2
"RTN","PSIVORE",131,0)
 D NATURE^PSIVOREN I '$D(P("NAT")) D:ON55["V" DEL55 Q 1
"RTN","PSIVORE",132,0)
 D:$G(VAIN(4))="" CLINIC^PSIVOREN
"RTN","PSIVORE",133,0)
 W !,"...transcribing this non-verified order...."
"RTN","PSIVORE",134,0)
 D PUT531^PSIVORFA
"RTN","PSIVORE",135,0)
 D:$G(PSJOC)]"" EN1^PSJHL2(DFN,PSJOC,ON,"SEND ORDER NUMBER")
"RTN","PSIVORE",136,0)
 ;RTC 178746 - Don't store allergy here
"RTN","PSIVORE",137,0)
 ;D SETOC^PSJNEWOC(ON)
"RTN","PSIVORE",138,0)
 D:ON55["V" DEL55
"RTN","PSIVORE",139,0)
 NEW PSJORD S (ON55,PSJORD)=ON
"RTN","PSIVORE",140,0)
 D VF^PSIVORC2
"RTN","PSIVORE",141,0)
 Q 1
"RTN","PSIVORE",142,0)
DEL55 ;
"RTN","PSIVORE",143,0)
 Q:ON55["P"
"RTN","PSIVORE",144,0)
 S X=$G(^PS(55,DFN,"IV",+ON55,0))
"RTN","PSIVORE",145,0)
 I $P(X,U,21)]"",($G(^PS(55,DFN,"IV",+ON55,2))]"") S $P(^(2),U,6)=ON,$P(^PS(53.1,+ON,0),U,25)=ON55 Q
"RTN","PSIVORE",146,0)
 NEW PSIVORFA S PSIVORFA=1
"RTN","PSIVORE",147,0)
 D DEL55^PSIVORE2
"RTN","PSIVORE",148,0)
 Q 
"RTN","PSJBLDOC")
0^32^B59046189
"RTN","PSJBLDOC",1,0)
PSJBLDOC ;BIR/MV - API to build ^TMP for prospective and PSJ profile drugs ;03 Aug 98 / 8:42 AM
"RTN","PSJBLDOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,263,260,295,252,257,299,281**;16 DEC 97;Build 113
"RTN","PSJBLDOC",3,0)
 ;
"RTN","PSJBLDOC",4,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJBLDOC",5,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJBLDOC",6,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBLDOC",7,0)
 ; Reference to ^PSDRUG( is supported by DBIA# 2192.
"RTN","PSJBLDOC",8,0)
 ; Reference to ^PSSDSAPI is supported by DBIA# 5425.
"RTN","PSJBLDOC",9,0)
 ; Reference to ^PSSDSAPM is supported by DBIA# 5570.
"RTN","PSJBLDOC",10,0)
 ;
"RTN","PSJBLDOC",11,0)
IN(DFN,LIST,PDRG,PTYP) ;
"RTN","PSJBLDOC",12,0)
 ;Build the IPM profiles and the prospective drugs list for both PSO & PSJ if PDRG is passed in.
"RTN","PSJBLDOC",13,0)
 ;DFN - PATIENT DFN
"RTN","PSJBLDOC",14,0)
 ;LIST - BASE
"RTN","PSJBLDOC",15,0)
 ;PDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSJBLDOC",16,0)
 ;       Where n is a sequential number.  Drug name can be OI, Generic name from #50 or Additive/sol name
"RTN","PSJBLDOC",17,0)
 ;PTYP - P1;P2 where P1="I" for Inpatient & "O" for Outpatient, P2= PSJ order#
"RTN","PSJBLDOC",18,0)
 NEW PSJONCNT,PSJDCNT,PSJDRGND,PSJWON
"RTN","PSJBLDOC",19,0)
 S PSJONCNT=0
"RTN","PSJBLDOC",20,0)
 S PSJWON=$P($G(PTYP),";",2)
"RTN","PSJBLDOC",21,0)
 D PROFILE(DFN,PSJWON,PTYP)
"RTN","PSJBLDOC",22,0)
 K ^TMP($J,"PSJPRE","CLINIC")
"RTN","PSJBLDOC",23,0)
 Q
"RTN","PSJBLDOC",24,0)
PROFILE(DFN,PSJWON,PTYP)     ;Setup ^TMP for the active meds to be on the OC profile list.
"RTN","PSJBLDOC",25,0)
 ;DFN:    Patient internal entry number
"RTN","PSJBLDOC",26,0)
 ;PSJWON: The current order number being working on.  It can be null.
"RTN","PSJBLDOC",27,0)
 ;        It is the order being work on (RN, FN..) and should be on the prospective list.
"RTN","PSJBLDOC",28,0)
 ;Output: ^TMP($J,"ORDERS",PSJINX)=DRUG CLASS^NATIONAL DRUG FILE ENTRY
"RTN","PSJBLDOC",29,0)
 ;        _"A"_PSNDFA PRODUCT NAME ENTRY_DISPENSE DRUG NAME^OE/RR #
"RTN","PSJBLDOC",30,0)
 ;        _ORDER NUMBER(P/I/V)_";I"
"RTN","PSJBLDOC",31,0)
 ;
"RTN","PSJBLDOC",32,0)
 NEW BDT,COD,DDRUG,DDRUGND,EDT,F,ON,ON1,PST,WBDT,X,PSJORIEN,%,PSJCLCOD,PSJCLINF,PSJCLIND,PSJTYPCL,PSJCLNPR
"RTN","PSJBLDOC",33,0)
 S PSJWON=$G(PSJWON),PSJCLCOD=""
"RTN","PSJBLDOC",34,0)
 ;
"RTN","PSJBLDOC",35,0)
 ;Must display any DC/Expired clinic orders within largest number of days defined for whichever clinic has the oldest date defined for ORDER CHECK DC/EXPIRED DAYS field
"RTN","PSJBLDOC",36,0)
 ;under the CLINIC DEFINITION file (#53.46)
"RTN","PSJBLDOC",37,0)
 ;Active, non-verified, pending, hold clinic orders must be displayed in the clinic display format.
"RTN","PSJBLDOC",38,0)
 D CLINICS^PSJCLNOC(DFN)  ;get clinic orders for this patient and set ^TMP($J,"PSJPRE","CLINIC",IEN,FILE_TYPE)=""
"RTN","PSJBLDOC",39,0)
 I $D(^TMP($J,"PSJPRE","CLINIC")) S PSJCLNPR=1 D
"RTN","PSJBLDOC",40,0)
 .S (PSJTYPCL,ON)="" F  S ON=$O(^TMP($J,"PSJPRE","CLINIC",ON)) Q:ON=""  F  S PSJTYPCL=$O(^TMP($J,"PSJPRE","CLINIC",ON,PSJTYPCL)) Q:PSJTYPCL=""  D
"RTN","PSJBLDOC",41,0)
 ..S F="^PS(55,DFN,5,"
"RTN","PSJBLDOC",42,0)
 ..I PSJTYPCL["55U" S COD=ON_"U",PSJCLCOD=2 D:COD'=PSJWON UD Q
"RTN","PSJBLDOC",43,0)
 ..I PSJTYPCL["55I" S COD=ON_"V" S PSJCLCOD=1 D:COD'=PSJWON IV Q
"RTN","PSJBLDOC",44,0)
 ..S F="^PS(53.1,"
"RTN","PSJBLDOC",45,0)
 ..S COD=ON_"P" Q:COD=PSJWON!($D(PSJVFF)&(COD=$G(PSJORD)))
"RTN","PSJBLDOC",46,0)
 ..I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",47,0)
 ..I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) S PSJCLCOD=3 D PIV Q
"RTN","PSJBLDOC",48,0)
 ..I $$GET1^DIQ(53.1,+ON,4,"I")="I" S PSJCLCOD=5
"RTN","PSJBLDOC",49,0)
 ..S PSJCLCOD=4 D UD
"RTN","PSJBLDOC",50,0)
 S PSJCLNPR=1
"RTN","PSJBLDOC",51,0)
 ;
"RTN","PSJBLDOC",52,0)
 D NOW^%DTC S (BDT,WBDT)=%,EDT=9999999  ; WBDT SET THIS WAY BEFORE CLINIC OC DISPLAY ADDED
"RTN","PSJBLDOC",53,0)
 S F="^PS(55,DFN,5," F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  S COD=ON_"U",PSJCLCOD=2 D:COD'=PSJWON UD
"RTN","PSJBLDOC",54,0)
 S WBDT=BDT,F="^PS(53.1,",PSJCLCOD="" F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  D
"RTN","PSJBLDOC",55,0)
 . S COD=ON_"P" Q:COD=PSJWON!($D(PSJVFF)&(COD=$G(PSJORD)))
"RTN","PSJBLDOC",56,0)
 . I $G(PSJCOM),($G(PSJWON)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+ON))
"RTN","PSJBLDOC",57,0)
 . I $O(^PS(53.1,+ON,"AD",0))!$O(^PS(53.1,+ON,"SOL",0)) S PSJCLCOD=3 D PIV Q
"RTN","PSJBLDOC",58,0)
 . S PSJCLCOD=4
"RTN","PSJBLDOC",59,0)
 . I $$GET1^DIQ(53.1,+ON,4,"I")="I" S PSJCLCOD=5
"RTN","PSJBLDOC",60,0)
 . D UD
"RTN","PSJBLDOC",61,0)
 S WBDT=BDT F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  Q:$D(^TMP($J,"PSJPRE","CLINIC",ON))  S COD=ON_"V" S PSJCLCOD=1 D:COD'=PSJWON IV
"RTN","PSJBLDOC",62,0)
 K PSJWON
"RTN","PSJBLDOC",63,0)
 Q
"RTN","PSJBLDOC",64,0)
UD ;Get the dispense drugs for the Unit Dose orders.
"RTN","PSJBLDOC",65,0)
 NEW X,PSJQUIT,PSJCNT,DDRUG,DDRUGN,PSJX,PSJOI,PSJEXPDD,PSJUTMP,PSJEDOVR,PSJCLNX,PSJCLDAT,PSJCLDAY,PSJSTOP
"RTN","PSJBLDOC",66,0)
 S X=@(F_ON_",0)")
"RTN","PSJBLDOC",67,0)
 Q:$P(X,U,9)="R"
"RTN","PSJBLDOC",68,0)
 S (PSJEDOVR,PSJCLINF,PSJCLNX,PSJCLDAY,PSJSTOP)=0,PSJCLDAT="",PSJCLNX=$P(X,U,9)
"RTN","PSJBLDOC",69,0)
 I $D(^TMP($J,"PSJPRE","CLINIC",+ON,$S(PSJCLCOD=5:"531I",PSJCLCOD=2:"55U",1:"531U"))) S PSJCLINF=1
"RTN","PSJBLDOC",70,0)
 I PSJCLCOD=4!(PSJCLCOD=5) Q:PSJCLINF&($P(X,U,9)'="P"&($P(X,U,9)'="N"))
"RTN","PSJBLDOC",71,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",72,0)
 Q:$P(X,U,9)["D"&('PSJCLINF)
"RTN","PSJBLDOC",73,0)
 Q:$P(X,U,9)="E"&('PSJCLINF)
"RTN","PSJBLDOC",74,0)
 S PSJORIEN=$P(X,U,21),DDRUG=0
"RTN","PSJBLDOC",75,0)
 ;
"RTN","PSJBLDOC",76,0)
 ;Use the first active DD within the order. If >1 DD, use OI_Dosage form for display name
"RTN","PSJBLDOC",77,0)
 S ON1=0,PSJCNT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'ON1  S PSJCNT=PSJCNT+1
"RTN","PSJBLDOC",78,0)
 S PSJOI=+$G(@(F_ON_",.2)"))
"RTN","PSJBLDOC",79,0)
 S ON1=0,PSJQUIT=0 F  S ON1=$O(@(F_ON_",1,"_ON1_")")) Q:'+ON1!PSJQUIT  S DDRUG=@(F_ON_",1,"_ON1_",0)") D
"RTN","PSJBLDOC",80,0)
 . Q:'+DDRUG
"RTN","PSJBLDOC",81,0)
 . S PSJX=$P(DDRUG,U,3)
"RTN","PSJBLDOC",82,0)
 . I 'PSJCLINF,PSJX]"",(PSJX'>BDT) Q
"RTN","PSJBLDOC",83,0)
 . D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) S PSJQUIT=1
"RTN","PSJBLDOC",84,0)
 ;Quit when an active DD within the order if found
"RTN","PSJBLDOC",85,0)
 Q:+$G(PSJQUIT)
"RTN","PSJBLDOC",86,0)
 ;
"RTN","PSJBLDOC",87,0)
 ;No DD found from the order. Get one from the OI
"RTN","PSJBLDOC",88,0)
 I '+PSJOI D SETIN("PROFILE","NOT FOUND: "_COD,"",COD,1,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",89,0)
 S DDRUG=$P($$DRG^PSSDSAPM(+PSJOI,"I"),U)
"RTN","PSJBLDOC",90,0)
 I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",91,0)
 ;
"RTN","PSJBLDOC",92,0)
 ;Get the first DD from OI (CCR5665 - set exception if pending order has no DD assigned and none is active. PSJ*5*252 t9)
"RTN","PSJBLDOC",93,0)
 I ($G(COD)'["P"),('+DDRUG) S DDRUG=$O(^PSDRUG("ASP",PSJOI,0)) I +DDRUG D SETIN("PROFILE",$S(PSJCNT>1:$$OIDF^PSJLMUT1(+$G(PSJOI)),1:$P($G(^PSDRUG(DDRUG,0)),U)),+DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",94,0)
 ;
"RTN","PSJBLDOC",95,0)
 ;Set exception when no DD found
"RTN","PSJBLDOC",96,0)
 I '+DDRUG D SETIN("PROFILE",$$OIDF^PSJLMUT1(+$G(PSJOI)),"",COD,1,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",97,0)
 Q
"RTN","PSJBLDOC",98,0)
PIV ;Get the dispense drugs for the Pending IV orders.
"RTN","PSJBLDOC",99,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM,PSJCLNTY,PSJDDNM
"RTN","PSJBLDOC",100,0)
 S PSJX=^PS(53.1,+ON,0),PSJORIEN=$P(PSJX,U,21) Q:$P(PSJX,U,27)="R"
"RTN","PSJBLDOC",101,0)
 S (PSJEDOVR,PSJCLINF,PSJCLNTY)=0,PSJCLNTY=$$GET1^DIQ(53.1,+ON,4,"I")
"RTN","PSJBLDOC",102,0)
 S:$D(^TMP($J,"PSJPRE","CLINIC",+ON,531_PSJCLNTY)) PSJCLINF=1
"RTN","PSJBLDOC",103,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",104,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",105,0)
 . S PSJX=^PS(53.1,+ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",106,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",107,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",108,0)
 . D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",109,0)
 S ON1=0 F  S ON1=$O(^PS(53.1,+ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",110,0)
 . S PSJX=^PS(53.1,+ON,"SOL",ON1,0)
"RTN","PSJBLDOC",111,0)
 . S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",112,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",113,0)
 . I $$PREMIX^PSJMISC(+PSJX) D  Q
"RTN","PSJBLDOC",114,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",115,0)
 .. D SETIN("PROFILE",$P(PSJ0,U)_" "_$P(PSJX,U,2),$P(PSJ0,U,2),COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",116,0)
 . ;Do allergy check for non-premix as well
"RTN","PSJBLDOC",117,0)
 . I $G(PSJDGCK) D
"RTN","PSJBLDOC",118,0)
 .. S PSJDDNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",119,0)
 .. S:$G(PSJDDNM)]"" PSJALLGY("Z",PSJDDNM,DDRUG)=""
"RTN","PSJBLDOC",120,0)
 Q
"RTN","PSJBLDOC",121,0)
IV ;Get the dispense drugs for the IV orders.
"RTN","PSJBLDOC",122,0)
 NEW PSJ0,PSJX,DDRUG,PSJNM,PSJCLNX,PSJSTOP,PSJDDNM
"RTN","PSJBLDOC",123,0)
 S PSJX=^PS(55,DFN,"IV",ON,0),PSJORIEN=$P(PSJX,U,21),(PSJCLINF,PSJCLNX)=0,PSJCLNX=$P(PSJX,U,17)
"RTN","PSJBLDOC",124,0)
 Q:$P(PSJX,U,17)="R"
"RTN","PSJBLDOC",125,0)
 I $D(^TMP($J,"PSJPRE","CLINIC",+ON,"55I")) S PSJCLINF=1
"RTN","PSJBLDOC",126,0)
 I PSJCLCOD=4!(PSJCLCOD=5) Q:PSJCLINF&($P(PSJX,U,17)'="P"&($P(PSJX,U,17)'="N"))
"RTN","PSJBLDOC",127,0)
 Q:$P($G(PTYP),";",1)="O"&('$G(PSJCLINF))
"RTN","PSJBLDOC",128,0)
 Q:$P(PSJX,U,17)["D"&('PSJCLINF)
"RTN","PSJBLDOC",129,0)
 Q:$P(PSJX,U,17)="E"&('PSJCLINF)
"RTN","PSJBLDOC",130,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"AD",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",131,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"AD",ON1,0),PSJ0=$$IV0("AD",+PSJX)
"RTN","PSJBLDOC",132,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",133,0)
 . I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",134,0)
 . D SETIN("PROFILE",PSJNM,DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",135,0)
 ; Only include Pre-mix in the OC.
"RTN","PSJBLDOC",136,0)
 S ON1=0 F  S ON1=$O(^PS(55,DFN,"IV",ON,"SOL",ON1)) Q:'ON1  D
"RTN","PSJBLDOC",137,0)
 . S PSJX=^PS(55,DFN,"IV",ON,"SOL",ON1,0)
"RTN","PSJBLDOC",138,0)
 . S PSJ0=$$IV0("",+PSJX)
"RTN","PSJBLDOC",139,0)
 . S PSJNM=$P(PSJ0,U)_" "_$P(PSJX,U,2),DDRUG=$P(PSJ0,U,2)
"RTN","PSJBLDOC",140,0)
 . I $$PREMIX^PSJMISC(+PSJX) D  Q
"RTN","PSJBLDOC",141,0)
 .. I '+DDRUG D SETIN("PROFILE",PSJNM,"",COD,4,PSJCLCOD,PSJCLINF) Q
"RTN","PSJBLDOC",142,0)
 .. D SETIN("PROFILE",PSJNM,DDRUG,COD,PTYP,PSJCLCOD,PSJCLINF)
"RTN","PSJBLDOC",143,0)
 . ;Do allergy check for non-premix as well
"RTN","PSJBLDOC",144,0)
 . I $G(PSJDGCK) D
"RTN","PSJBLDOC",145,0)
 .. S PSJDDNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",146,0)
 .. S:$G(PSJDDNM)]"" PSJALLGY("Z",PSJDDNM,DDRUG)=""
"RTN","PSJBLDOC",147,0)
 Q
"RTN","PSJBLDOC",148,0)
SETIN(PSJFLG,PSJNM,DDRUG,ON,PSJCODE,PSJCLCOD,PSJCLINF) ;Set ^TMP($J,"PSJPRE,"IN" arrays.
"RTN","PSJBLDOC",149,0)
 ;ON = ON with "U/V/P"
"RTN","PSJBLDOC",150,0)
 ;PSJFLG = "PROSPECTIVE" or "PROFILE"
"RTN","PSJBLDOC",151,0)
 ;PSJNM = This should be the AD/SOL print name or IV order.  Use Dispense drug name if U/D order
"RTN","PSJBLDOC",152,0)
 ;PSJPON = 4 piece pharmacy order #
"RTN","PSJBLDOC",153,0)
 NEW PSJPON
"RTN","PSJBLDOC",154,0)
 Q:$G(PSJFLG)=""
"RTN","PSJBLDOC",155,0)
 ;S:$G(PSJDGCK) PSJFLG="PROSPECTIVE" ;when using CK hidden action
"RTN","PSJBLDOC",156,0)
 S PSJONCNT=$G(PSJONCNT)+1
"RTN","PSJBLDOC",157,0)
 S PSJPON=$S(PSJCLINF:"C"_PSJCLCOD_";",1:"I;")_ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",158,0)
 I $P(PSJCODE,";")="O" S PSJPON="C"_PSJCLCOD_";"_+ON_";"_PSJFLG_";"_PSJONCNT
"RTN","PSJBLDOC",159,0)
 I '+$G(DDRUG) D  Q
"RTN","PSJBLDOC",160,0)
 . I +$G(PSJCODE) D NODD($G(PSJCODE),PSJNM,PSJPON,LIST)
"RTN","PSJBLDOC",161,0)
 Q:$$SUP^PSSDSAPI(+DDRUG)
"RTN","PSJBLDOC",162,0)
 I $G(PSJNM)="" S PSJNM=$P($G(^PSDRUG(+DDRUG,0)),U)
"RTN","PSJBLDOC",163,0)
 S PSJFLG=$S($G(PSJDGCK):"PROSPECTIVE",1:"PROFILE") ;when using CK hidden action
"RTN","PSJBLDOC",164,0)
 S ^TMP($J,LIST,"IN",PSJFLG,PSJPON)=+$$GCN^PSJMISC(+DDRUG)_U_$$GTVUID^PSJMISC(+DDRUG)_U_+DDRUG_U_PSJNM_U_$G(PSJORIEN)_U_"I"_U_PSJCLCOD_";"_PSJCLINF
"RTN","PSJBLDOC",165,0)
 Q
"RTN","PSJBLDOC",166,0)
IV0(PSJAD,PSIVIEN) ;Return ad/sol zero node
"RTN","PSJBLDOC",167,0)
 ;PSJAD = "AD" is passed in if it additive, otherwise it's null
"RTN","PSJBLDOC",168,0)
 I PSJAD="AD" Q $G(^PS(52.6,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",169,0)
 I $G(PSJAD)="" Q $G(^PS(52.7,+$G(PSIVIEN),0))
"RTN","PSJBLDOC",170,0)
 Q ""
"RTN","PSJBLDOC",171,0)
NODD(PSJCODE,PSJOIDF,PSJPON,PSJBASE) ;Set ^TMP for OI without a dispense drug
"RTN","PSJBLDOC",172,0)
 ;PSJCODE - A numeric code to trigger the appropriate exception message 
"RTN","PSJBLDOC",173,0)
 ;PSJOIDF - Orderable Item name_Dose form (can be CPRS OI)
"RTN","PSJBLDOC",174,0)
 ;PSJPON - Pharmacy order #
"RTN","PSJBLDOC",175,0)
 ;PSJBASE - Base subscript
"RTN","PSJBLDOC",176,0)
 Q:$G(PSJOIDF)=""
"RTN","PSJBLDOC",177,0)
 Q:$G(PSJBASE)=""
"RTN","PSJBLDOC",178,0)
 Q:'+$G(PSJCODE)
"RTN","PSJBLDOC",179,0)
 ;S PSJIV("OI_ERROR",PSJOIDF)=$G(PSJCODE)_U_$G(PSJPON)
"RTN","PSJBLDOC",180,0)
 S ^TMP($J,PSJBASE,"IN","EXCEPTIONS","OI",PSJOIDF)=PSJCODE_U_$G(PSJPON)
"RTN","PSJBLDOC",181,0)
 Q
"RTN","PSJCOM")
0^41^B41203922
"RTN","PSJCOM",1,0)
PSJCOM ;BIR/CML3-FINISH COMPLEX UNIT DOSE ORDERS ENTERED THROUGH OE/RR ;02 Feb 2001  12:20 PM
"RTN","PSJCOM",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**110,186,267,281**;16 DEC 97;Build 113
"RTN","PSJCOM",3,0)
 ;
"RTN","PSJCOM",4,0)
 ; Reference to ^VALM1 is supported by DBIA 10116.
"RTN","PSJCOM",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJCOM",6,0)
 ; Reference to ^%DTC is supported by DBIA 10000.
"RTN","PSJCOM",7,0)
 ; Reference to ^%RCR is supported by DBIA 10022.
"RTN","PSJCOM",8,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSJCOM",9,0)
 ; Reference to ^TIUEDIT is supported by DBIA 2410.
"RTN","PSJCOM",10,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071.
"RTN","PSJCOM",11,0)
 ;
"RTN","PSJCOM",12,0)
UPD ;
"RTN","PSJCOM",13,0)
 Q:'PSJCOM
"RTN","PSJCOM",14,0)
 M ^TMP("PSJCOM",$J,+PSGORD)=^PS(53.1,+PSGORD)
"RTN","PSJCOM",15,0)
 I PSGST="",(PSGSCH="NOW"!(PSGSCH="ONCE")) S PSGST="O"
"RTN","PSJCOM",16,0)
 S $P(^TMP("PSJCOM",$J,+PSGORD,0),"^",9)="N",$P(^(0),"^",4)="U",$P(^(0),"^",7)=PSGST,$P(^TMP("PSJCOM",$J,+PSGORD,2),"^",2)=PSGSD,$P(^(2),"^",4)=PSGFD
"RTN","PSJCOM",17,0)
 I $D(PSGSI),$P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S ^TMP("PSJCOM",$J,+PSGORD,6)=PSGSI
"RTN","PSJCOM",18,0)
 I $D(PSGSI),$P($G(^PS(53.1,+PSGORD,0)),U,24)="R" S $P(^TMP("PSJCOM",$J,+PSGORD,6),U)=$P(PSGSI,U) I $P(PSGSI,U)="" S $P(^TMP("PSJCOM",$J,+PSGORD,6),U,2)=""
"RTN","PSJCOM",19,0)
 S:$D(PSGSCH) $P(^TMP("PSJCOM",$J,+PSGORD,2),"^")=PSGSCH
"RTN","PSJCOM",20,0)
 I PSGSM,PSGOHSM'=PSGHSM S $P(^TMP("PSJCOM",$J,+PSGORD,0),"^",5)=PSGSM,$P(^TMP("PSJCOM",$J,+PSGORD,0),"^",6)=PSGHSM
"RTN","PSJCOM",21,0)
 W "."
"RTN","PSJCOM",22,0)
 S PSGOEEWF="^TMP(""PSJCOM"",$J,+PSGORD,"
"RTN","PSJCOM",23,0)
 F Q=1,3 K @(PSGOEEWF_Q_")") S %X="^PS(53.45,"_PSJSYSP_","_$S(Q=1:2,1:1)_",",%Y=PSGOEEWF_Q_"," K @(PSGOEEWF_Q_")") D %XY^%RCR W "."  ;MOU-0100-30945
"RTN","PSJCOM",24,0)
 S PSGND=$G(^TMP("PSJCOM",$J,+PSGORD,0)),X=$P(PSGND,U,24)
"RTN","PSJCOM",25,0)
 S PSJOWALL=+$G(^PS(55,PSGP,5.1))
"RTN","PSJCOM",26,0)
 I $S(X="R":1,+$G(^PS(55,PSGP,5.1))>PSGDT:0,1:X'="E") S X=$G(^TMP("PSJCOM",$J,+PSGORD,2)) D ENWALL^PSGNE3(+$P(X,U,2),+$P(X,U,4),PSGP)
"RTN","PSJCOM",27,0)
 S $P(^TMP("PSJCOM",$J,+PSGORD,.2),U,2)=PSGDO,$P(^TMP("PSJCOM",$J,+PSGORD,2),U,5)=PSGAT S:$G(PSGS0XT) $P(^(2),U,6)=PSGS0XT
"RTN","PSJCOM",28,0)
 I 'PSGOEAV D NEWNVAL(PSGORD,$S(+PSJSYSU=3:22005,1:22000))
"RTN","PSJCOM",29,0)
 I $D(^PS(53.45,DUZ,5,1,0)) D FILESI^PSJBCMA5(PSGP,PSGORD) N SIARRAY S SIARRAY="" D NEWNVAL^PSGAL5(PSGORD,6000,"SPECIAL INSTRUCTIONS",,.SIARRAY)
"RTN","PSJCOM",30,0)
 I PSGOEAV,+PSJSYSU=3 D VFY Q
"RTN","PSJCOM",31,0)
 I PSGOEAV,$G(PSJRNF) D VFY
"RTN","PSJCOM",32,0)
 Q
"RTN","PSJCOM",33,0)
VFY ; change status, move to 55, and change label record
"RTN","PSJCOM",34,0)
 Q:'PSJCOM
"RTN","PSJCOM",35,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSGORD
"RTN","PSJCOM",36,0)
 D SETOC^PSJNEWOC(PSGORD)
"RTN","PSJCOM",37,0)
 I '$D(^TMP("PSJCOM",$J,+PSGORD)) M ^TMP("PSJCOM",$J,+PSGORD)=^PS(53.1,+PSGORD)
"RTN","PSJCOM",38,0)
 NEW PSJDOSE,PSJDSFLG
"RTN","PSJCOM",39,0)
 D DOSECHK^PSJDOSE
"RTN","PSJCOM",40,0)
 I +$G(PSJDSFLG) D SETVAR^PSJDOSE W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1") I '$$CONT() W !,"...order was not verified..." D PAUSE^VALM1 D  Q:'$G(PSJACEPT)
"RTN","PSJCOM",41,0)
 . S PSGOEEF(109)=1
"RTN","PSJCOM",42,0)
 . S PSJACEPT=0
"RTN","PSJCOM",43,0)
 D DDCHK G:CHK DONE
"RTN","PSJCOM",44,0)
 W !,"...a few moments, please..."
"RTN","PSJCOM",45,0)
 I PSGORD["P" D
"RTN","PSJCOM",46,0)
 . S PSGORDP=PSGORD ;Used in ACTLOG to update activity log in ^TMP
"RTN","PSJCOM",47,0)
 . I '$D(^TMP("PSJCOM2",$J,+PSGORD)) D  Q
"RTN","PSJCOM",48,0)
 .. NEW PSGX S PSGX=$G(^TMP("PSJCOM",$J,+PSGORD,2.5)),PSGRSD=$P(PSGX,U),PSGRFD=$P(PSGX,U,3)
"RTN","PSJCOM",49,0)
 .. S $P(^TMP("PSJCOM",$J,+PSGORD,0),"^",9)="A" W "." ;D ^PSGOT
"RTN","PSJCOM",50,0)
 .  NEW PSGX S PSGX=$G(^TMP("PSJCOM2",$J,+PSGORD,2.5)),PSGRSD=$P(PSGX,U),PSGRFD=$P(PSGX,U,3)
"RTN","PSJCOM",51,0)
 .  S $P(^TMP("PSJCOM2",$J,+PSGORD,0),"^",9)="A" W "." ;D ^PSGOT
"RTN","PSJCOM",52,0)
 D NEWNVAL(+PSGORD,(PSJSYSU*10+22000)) W "."
"RTN","PSJCOM",53,0)
 S VND4=$S('$D(^TMP("PSJCOM2",$J,+PSGORD)):$G(^TMP("PSJCOM",$J,+PSGORD,4)),1:$G(^TMP("PSJCOM2",$J,+PSGORD,4)))
"RTN","PSJCOM",54,0)
 I $G(PSGRSD) D
"RTN","PSJCOM",55,0)
 . S PSGRSD=$$ENDTC^PSGMI(PSGRSD) D NEWNVAL(PSGORD,6090,"Requested Start Date",PSGRSD)
"RTN","PSJCOM",56,0)
 . S PSGRFD=$$ENDTC^PSGMI(PSGRFD) D NEWNVAL(PSGORD,6090,"Requested Stop Date",PSGRFD)
"RTN","PSJCOM",57,0)
 N DUR,DURORD S DURON=$S($G(ON)&($G(PSGORD)["U"):ON,$G(PSGORD):PSGORD,1:"") Q:'DURON  D
"RTN","PSJCOM",58,0)
 . S DUR=$S($P($G(PSGRDTX),U,2)]"":$P($G(PSGRDTX),U,2),1:$$GETDUR^PSJLIVMD(PSGP,+DURON,$S($G(DURON)["P":"P",$G(DURON)["V":"IV",1:5),1),1:"")
"RTN","PSJCOM",59,0)
 I DUR]"" S $P(^TMP("PSJCOM2",$J,+PSGORD,2.5),"^",2)=DUR
"RTN","PSJCOM",60,0)
 ;D:$D(PSGORDP) ACTLOG(PSGORDP,PSGP,PSGORD)
"RTN","PSJCOM",61,0)
 K PSGRSD,PSGRFD,PSGALFN
"RTN","PSJCOM",62,0)
 NEW X S X=0 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S X=1
"RTN","PSJCOM",63,0)
 I +PSJSYSU=3,PSGORD'["O",$S(X:0,'$P(VND4,"^",16):1,1:$P(VND4,"^",15)) ;D EN^PSGPEN(+PSGORD)
"RTN","PSJCOM",64,0)
 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9)
"RTN","PSJCOM",65,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)=""
"RTN","PSJCOM",66,0)
 S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT
"RTN","PSJCOM",67,0)
 S:'$D(^TMP("PSJCOM2",$J,+PSGORD)) ^TMP("PSJCOM",$J,+PSGORD,4)=VND4 S:$D(^TMP("PSJCOM2",$J,+PSGORD)) ^TMP("PSJCOM2",$J,+PSGORD,4)=VND4
"RTN","PSJCOM",68,0)
 W:'$D(PSJSPEED) ! W !,"ORDER VERIFIED.",!
"RTN","PSJCOM",69,0)
 I '$D(PSJSPEED) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSJCOM",70,0)
 S VALMBCK="Q"
"RTN","PSJCOM",71,0)
 S ^TMP("PSJCOM",$J)="A" S:$D(^TMP("PSJCOM2",$J,+PSGORD)) ^TMP("PSJCOM2",$J)="A"
"RTN","PSJCOM",72,0)
 ;
"RTN","PSJCOM",73,0)
DONE ;
"RTN","PSJCOM",74,0)
 W:CHK !!,"...order NOT verified..."
"RTN","PSJCOM",75,0)
 I '$D(PSJSPEED),'CHK,+PSJSYSU=3,$G(PSJPRI)="D" D
"RTN","PSJCOM",76,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSJCOM",77,0)
 .Q:Y="N"
"RTN","PSJCOM",78,0)
 .D MAIN^TIUEDIT(3,.TIUDA,PSGP,"","","","",1)
"RTN","PSJCOM",79,0)
 S VALMBCK="Q" K CHK,DA,DIE,F,DP,DR,ND,PSGAL,PSGODA,PSJDOSE,PSJVAR,VND4,X,%X,%Y,Q,QQ Q
"RTN","PSJCOM",80,0)
 ;
"RTN","PSJCOM",81,0)
DDCHK ; dispense drug check
"RTN","PSJCOM",82,0)
 S DRGF=$S('$D(^TMP("PSJCOM2",$J,+PSGORD)):"^TMP(""PSJCOM"","_$J_","_+PSGORD_",",1:"^TMP(""PSJCOM2"","_$J_","_+PSGORD_","),CHK=$S('$O(@(DRGF_"1,0)")):7,1:0)
"RTN","PSJCOM",83,0)
 S PSGPD=$G(@(DRGF_".2)"))
"RTN","PSJCOM",84,0)
 S CHK=$S('$$DDOK^PSGOE2(DRGF_"1,",PSGPD):7,1:0)
"RTN","PSJCOM",85,0)
 Q:CHK=0
"RTN","PSJCOM",86,0)
 W $C(7),!!,"This order must have at least one valid, active dispense drug to be verified."
"RTN","PSJCOM",87,0)
 ;
"RTN","PSJCOM",88,0)
CONT() ;
"RTN","PSJCOM",89,0)
 NEW DIR,DIRUT,Y
"RTN","PSJCOM",90,0)
 W ! K DIR,DIRUT
"RTN","PSJCOM",91,0)
 S DIR(0)="Y",DIR("A")="Would you like to continue verifying the order",DIR("B")="No"
"RTN","PSJCOM",92,0)
 D ^DIR
"RTN","PSJCOM",93,0)
 Q Y
"RTN","PSJCOM",94,0)
 ;
"RTN","PSJCOM",95,0)
NEWNVAL(PSGALORD,PSGALC,PSGFLD,PSGOLD)  ;
"RTN","PSJCOM",96,0)
 ;
"RTN","PSJCOM",97,0)
 ;Where  PSGALORD = PSGORD (Required)
"RTN","PSJCOM",98,0)
 ;       PSGALC   = ACTIVITY CODE FROM #53.3 (Required)
"RTN","PSJCOM",99,0)
 ;       PSGFLD   = FIELD THAT CHANGED (Free text, optional)
"RTN","PSJCOM",100,0)
 ;       PSGOLD   = THE FIELDS OLD DATA VALUE (Free text, optional)
"RTN","PSJCOM",101,0)
 ;
"RTN","PSJCOM",102,0)
 ;N PSGALORD,PSGALC,PSGFLD,PSGOLD
"RTN","PSJCOM",103,0)
 ;
"RTN","PSJCOM",104,0)
 ; Create 0 node activity log for order if none exists, and get next entry number
"RTN","PSJCOM",105,0)
 I '$D(^TMP("PSJCOM2",$J,+PSGALORD)) D  Q
"RTN","PSJCOM",106,0)
 . S QQ=$G(^TMP("PSJCOM",$J,+PSGALORD,"A",0)) S:QQ="" QQ="^53.1119D" F Q=$P(QQ,"^",3)+1:1 I '$D(^(Q)) S $P(QQ,"^",3,4)=Q_"^"_Q,^(0)=QQ,PSGAL("N")=Q Q
"RTN","PSJCOM",107,0)
 . ;Set up data to be held in activity log record
"RTN","PSJCOM",108,0)
 . D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJCOM",109,0)
 . I $L($G(PSGOLD))>170 S PSGOLD=$E(PSGOLD,1,167)_"..." ; Use of ... indicates old data field was greater than 170 characters
"RTN","PSJCOM",110,0)
 . S Q=%_"^"_$S(PSGALC=6010:"AUTO CANCEL",$D(DUZ)[0:"UNKNOWN",DUZ]"":DUZ,1:"UNKNOWN")_"^"_PSGALC_"^"_$S($D(PSGFLD):PSGFLD,1:"")_"^"_$S($D(PSGOLD):PSGOLD,1:"")
"RTN","PSJCOM",111,0)
 . ; Create activity log entry
"RTN","PSJCOM",112,0)
 . S ^TMP("PSJCOM",$J,+PSGALORD,"A",PSGAL("N"),0)=Q
"RTN","PSJCOM",113,0)
 S QQ=$G(^TMP("PSJCOM2",$J,+PSGALORD,"A",0)) S:QQ="" QQ="^53.1119D" F Q=$P(QQ,"^",3)+1:1 I '$D(^(Q)) S $P(QQ,"^",3,4)=Q_"^"_Q,^(0)=QQ,PSGAL("N")=Q Q
"RTN","PSJCOM",114,0)
 ;Set up data to be held in activity log record
"RTN","PSJCOM",115,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJCOM",116,0)
 I $L($G(PSGOLD))>170 S PSGOLD=$E(PSGOLD,1,167)_"..." ; Use of ... indicates old data field was greater than 170 characters
"RTN","PSJCOM",117,0)
 S Q=%_"^"_$S(PSGALC=6010:"AUTO CANCEL",$D(DUZ)[0:"UNKNOWN",DUZ]"":DUZ,1:"UNKNOWN")_"^"_PSGALC_"^"_$S($D(PSGFLD):PSGFLD,1:"")_"^"_$S($D(PSGOLD):PSGOLD,1:"")
"RTN","PSJCOM",118,0)
 ; Create activity log entry
"RTN","PSJCOM",119,0)
 S ^TMP("PSJCOM2",$J,+PSGALORD,"A",PSGAL("N"),0)=Q
"RTN","PSJCOM",120,0)
 Q
"RTN","PSJCOM1")
0^46^B48577144
"RTN","PSJCOM1",1,0)
PSJCOM1 ;BIR/CML3-DISPLAY COMPLEX ORDERS FOR DISCONTINUE ;02 Feb 2001  12:20 PM
"RTN","PSJCOM1",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**110,127,281**;16 DEC 97;Build 113
"RTN","PSJCOM1",3,0)
 ;
"RTN","PSJCOM1",4,0)
 ; Reference to ^VALM1 is supported by DBIA 10116.
"RTN","PSJCOM1",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJCOM1",6,0)
 ; Reference to ^%DTC is supported by DBIA 10000.
"RTN","PSJCOM1",7,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJCOM1",8,0)
 ; Reference to ^DIE is supported by DBIA 10018.
"RTN","PSJCOM1",9,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSJCOM1",10,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSJCOM1",11,0)
 ;
"RTN","PSJCOM1",12,0)
CMPLX(PSGP,ON,PSGORD) ;
"RTN","PSJCOM1",13,0)
 D PAUSE K PSJCM
"RTN","PSJCOM1",14,0)
 N PSJLINE,PSX,PSCM
"RTN","PSJCOM1",15,0)
 S PSJLINE=1
"RTN","PSJCOM1",16,0)
 I PSGORD["P" N PSJO S PSJO=0 F  S PSJO=$O(^PS(53.1,"ACX",ON,PSJO)) Q:'PSJO  D
"RTN","PSJCOM1",17,0)
 .Q:PSJO=+PSGORD  S PSJOO=PSGORD D DSPLORDU(PSGP,PSJO_"P") S PSJCM(PSJO_"P",PSJLINE)="",PSJLINE=PSJLINE+1
"RTN","PSJCOM1",18,0)
 I PSGORD'["P" N PSJO,PSJOO S PSJOO="",PSJO=0 F  S PSJO=$O(^PS(55,"ACX",ON,PSJO)) Q:'PSJO  F  S PSJOO=$O(^PS(55,"ACX",ON,PSJO,PSJOO)) Q:PSJOO=""  D
"RTN","PSJCOM1",19,0)
 .Q:PSJOO=PSGORD  D:PSJOO["U" DSPLORDU(PSGP,PSJOO) D:PSJOO["V" DSPLORDV(PSGP,PSJOO) S PSJCM(PSJOO,PSJLINE)="",PSJLINE=PSJLINE+1
"RTN","PSJCOM1",20,0)
 N ON S ON="" F  S ON=$O(PSJCM(ON)) Q:ON=""  D
"RTN","PSJCOM1",21,0)
 .W ! F PSX=0:0 S PSX=$O(PSJCM(ON,PSX)) Q:'PSX  D
"RTN","PSJCOM1",22,0)
 ..W !,PSJCM(ON,PSX) D:'(PSX#6) PAUSE
"RTN","PSJCOM1",23,0)
 W !
"RTN","PSJCOM1",24,0)
 Q
"RTN","PSJCOM1",25,0)
 ;
"RTN","PSJCOM1",26,0)
CMPLX2(PSGP,ON,PSGORD) ;
"RTN","PSJCOM1",27,0)
 Q:$G(PSGORD)'["U"
"RTN","PSJCOM1",28,0)
 N PSJLINE S PSJLINE=0
"RTN","PSJCOM1",29,0)
 D FULL^VALM1
"RTN","PSJCOM1",30,0)
 D DSPLORDU(PSGP,PSGORD)
"RTN","PSJCOM1",31,0)
 W ! S PSJLINE="" F  S PSJLINE=$O(PSJCM(PSGORD,PSJLINE)) Q:PSJLINE=""  W !,PSJCM(PSGORD,PSJLINE) D:'((PSJLINE+1)#6) PAUSE
"RTN","PSJCOM1",32,0)
 D EN^PSGPEN(PSGORD)
"RTN","PSJCOM1",33,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSJO_"P",^TMP("PSODAOC",$J,"IP NEW IEN")=PSGORD
"RTN","PSJCOM1",34,0)
 D SETOC^PSJNEWOC(PSGORD)
"RTN","PSJCOM1",35,0)
 W !
"RTN","PSJCOM1",36,0)
 Q
"RTN","PSJCOM1",37,0)
 ;
"RTN","PSJCOM1",38,0)
UPDATE ; Refresh array, actions, & display.
"RTN","PSJCOM1",39,0)
 D GETUD^PSJLMGUD(DFN,ON),INIT^PSJLMUDE(DFN,ON) S VALMBCK="R"
"RTN","PSJCOM1",40,0)
 Q
"RTN","PSJCOM1",41,0)
HOLDHDR ; Freeze header text while processing order actions
"RTN","PSJCOM1",42,0)
 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSJCOM1",43,0)
 Q
"RTN","PSJCOM1",44,0)
 ;
"RTN","PSJCOM1",45,0)
DSPLORDU(PSGP,ON)   ; Display UD order for order check as in the Inpat Profile.
"RTN","PSJCOM1",46,0)
 NEW DRUGNAME,F,NODE0,NODE2,PSJID,PSJX,SCH,SD,STAT,X,Y K PSJCM
"RTN","PSJCOM1",47,0)
 S F=$S(ON["U":"^PS(55,PSGP,5,"_+ON_",",1:"^PS(53.1,"_+ON_",")
"RTN","PSJCOM1",48,0)
 S NODE0=$G(@(F_"0)")),NODE2=$G(@(F_"2)"))
"RTN","PSJCOM1",49,0)
 D DRGDISP^PSJLMUT1(PSGP,ON,39,54,.DRUGNAME,0)
"RTN","PSJCOM1",50,0)
 I ON["P",$P(NODE0,U,4)="F" D DSPLORDV(PSGP,ON) Q
"RTN","PSJCOM1",51,0)
 S SCH=$P(NODE0,U,7)
"RTN","PSJCOM1",52,0)
 S STAT=$P(NODE0,U,9)
"RTN","PSJCOM1",53,0)
 D NOW^%DTC I "A"[STAT I $P(NODE2,U,4)<% D EXPIRE S STAT="E"
"RTN","PSJCOM1",54,0)
 I STAT="A",$P(NODE0,U,27)="R" S STAT="R"
"RTN","PSJCOM1",55,0)
 I STAT'="P" S PSJID=$E($$ENDTC^PSGMI($P(NODE2,U,2)),1,5),SD=$E($$ENDTC^PSGMI($P(NODE2,U,4)),1,5)
"RTN","PSJCOM1",56,0)
 I STAT="P" S (PSJID,SD)="*****",SCH="?"
"RTN","PSJCOM1",57,0)
 F PSJX=0:0 S PSJX=$O(DRUGNAME(PSJX)) Q:'PSJX  D
"RTN","PSJCOM1",58,0)
 . S:PSJX=1 X=SCH_"  "_PSJID_"  "_SD_"  "_$E(STAT,1)
"RTN","PSJCOM1",59,0)
 . S:PSJX=1 DRUGNAME(1)=$$SETSTR^VALM1(X,$E(DRUGNAME(1),1,40),42,20)
"RTN","PSJCOM1",60,0)
 . S PSJCM(ON,PSJLINE)="        "_DRUGNAME(PSJX)
"RTN","PSJCOM1",61,0)
 . S PSJLINE=PSJLINE+1
"RTN","PSJCOM1",62,0)
 Q
"RTN","PSJCOM1",63,0)
DSPLORDV(DFN,ON)   ; Display IV order for order check as in the Inpat Profile.
"RTN","PSJCOM1",64,0)
 N DRG,DRGI,DRGT,DRGX,FIL,ND,ON55,P,PSJIVFLG,PSJORIFN,TYP,X,Y
"RTN","PSJCOM1",65,0)
 S TYP="?" I ON["V" D
"RTN","PSJCOM1",66,0)
 .S Y=$G(^PS(55,DFN,"IV",+ON,0)) F X=2,3,4,5,8,9,17,23 S P(X)=$P(Y,U,X)
"RTN","PSJCOM1",67,0)
 .D NOW^%DTC I "A"[P(17) I P(3)<% D EXPIRE S P(17)="E"
"RTN","PSJCOM1",68,0)
 .S TYP=$$ONE^PSJBCMA(DFN,ON,P(9),P(2),P(3)) I TYP'="O" S TYP="C"
"RTN","PSJCOM1",69,0)
 .S ON55=ON,P("OT")=$S(P(4)="A":"F",P(4)="H":"H",1:"I") D GTDRG^PSIVORFB,GTOT^PSIVUTL(P(4))
"RTN","PSJCOM1",70,0)
 S PSJCT=0,PSJL=""
"RTN","PSJCOM1",71,0)
 I ON'["V" S (P(2),P(3))="",P(17)=$P($G(^PS(53.1,+ON,0)),U,9),Y=$G(^(8)),P(4)=$P(Y,U),P(8)=$P(Y,U,5),P(9)=$P($G(^(2)),U) D GTDRG^PSIVORFA,GTOT^PSIVUTL(P(4))
"RTN","PSJCOM1",72,0)
 S PSJIVFLG=1 D PIVAD,SOL
"RTN","PSJCOM1",73,0)
 Q
"RTN","PSJCOM1",74,0)
SOL ;
"RTN","PSJCOM1",75,0)
 S PSJL=$S($G(PSJIVFLG):PSJL,1:"")_"        in"
"RTN","PSJCOM1",76,0)
 S DRG=0 F  S DRG=+$O(DRG("SOL",DRG)) Q:'DRG  D NAME^PSIVUTL(DRG("SOL",DRG),39,.NAME,0) S DRGX=0 F  S DRGX=$O(NAME(DRGX)) Q:'DRGX  S PSJL=$$SETSTR^VALM1(NAME(DRGX),PSJL,12,60) D:$G(PSJIVFLG) PIV1 D SETTMP S PSJL="      "
"RTN","PSJCOM1",77,0)
 Q
"RTN","PSJCOM1",78,0)
PIVAD ; Print IV Additives.
"RTN","PSJCOM1",79,0)
 F DRG=0:0 S DRG=$O(DRG("AD",DRG)) Q:'DRG  D NAME^PSIVUTL(DRG("AD",DRG),39,.NAME,1) F DRGX=0:0 S DRGX=$O(NAME(DRGX)) Q:'DRGX  S PSJL=$$SETSTR^VALM1(NAME(DRGX),PSJL,9,60) D:$G(PSJIVFLG) PIV1 D SETTMP
"RTN","PSJCOM1",80,0)
 Q
"RTN","PSJCOM1",81,0)
 ;
"RTN","PSJCOM1",82,0)
PIV1 ; Print Sched type, start/stop dates, and status.
"RTN","PSJCOM1",83,0)
 K PSJIVFLG
"RTN","PSJCOM1",84,0)
 F X=2,3 S P(X)=$E($$ENDTC^PSGMI(P(X)),1,$S($D(PSJEXTP):8,1:5))
"RTN","PSJCOM1",85,0)
 I '$D(PSJEXTP) S PSJL=$$SETSTR^VALM1(TYP,PSJL,50,1),PSJL=$$SETSTR^VALM1(P(2),PSJL,53,7),PSJL=$$SETSTR^VALM1(P(3),PSJL,60,7),PSJL=$$SETSTR^VALM1(P(17),PSJL,67,1)
"RTN","PSJCOM1",86,0)
 E  S PSJL=$$SETSTR^VALM1(TYP,PSJL,50,1),PSJL=$$SETSTR^VALM1(P(2),53,7),PSJL=$$SETSTR^VALM1(P(3),PSJL,63,7),PSJL=$$SETSTR^VALM1(P(17),PSJL,73,1)
"RTN","PSJCOM1",87,0)
 Q
"RTN","PSJCOM1",88,0)
SETTMP ;
"RTN","PSJCOM1",89,0)
 S PSJCM(ON,PSJLINE)=PSJL,PSJLINE=PSJLINE+1
"RTN","PSJCOM1",90,0)
 Q
"RTN","PSJCOM1",91,0)
PAUSE ;
"RTN","PSJCOM1",92,0)
 K DIR W ! S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR W !
"RTN","PSJCOM1",93,0)
 Q
"RTN","PSJCOM1",94,0)
NEW ;
"RTN","PSJCOM1",95,0)
 Q:'PSJCOM
"RTN","PSJCOM1",96,0)
 Q:PSGORD'["P"
"RTN","PSJCOM1",97,0)
 M ^TMP("PSJCOM",$J,+PSGORD)=^PS(53.1,+PSGORD)
"RTN","PSJCOM1",98,0)
 S PSGS0Y=PSGAT,PSGNESD=PSGSD,PSGNEFD=PSGFD,PSGOEPR=PSGPR,PSGPDRG=PSGPD,PSGPDRGN=PSGPDN,PSGOEE="E"
"RTN","PSJCOM1",99,0)
 S $P(^TMP("PSJCOM",$J,+PSGORD,0),"^",27)="E",$P(^(0),"^",9)="DE"
"RTN","PSJCOM1",100,0)
 W:'$D(PSGOEE)&'$D(PSGOES) !!,"...transcribing this ",$S($D(PSGOES):"",'PSGOEAV:"non-verified ",1:"active "),"order..." S PSGOETOF=1 S:PSGSM="" PSGSM=0
"RTN","PSJCOM1",101,0)
 ;I PSGPR'=PSGOEPR D:'$D(^PS(55,PSGP,0)) ENSET0^PSGNE3(PSGP) S $P(^PS(55,PSGP,5.1),U,2)=PSGPR,PSGOEPR=PSGPR
"RTN","PSJCOM1",102,0)
 K ND4,DA D NOW^%DTC S PSGDT=+$E(%,1,12),DA=+PSGORD
"RTN","PSJCOM1",103,0)
 S PSJOWALL=+$G(^PS(55,PSGP,5.1))
"RTN","PSJCOM1",104,0)
 I $D(^PS(51.2,+PSGMR,0)),$P(^(0),U,3)]"" S PSGMRN=$P(^(0),U,3)
"RTN","PSJCOM1",105,0)
 I PSGS0XT="D",'PSGS0Y S PSGS0Y=$E(PSGNESD_"00011",9,12)
"RTN","PSJCOM1",106,0)
 S ND=DA_U_PSGPR_U_PSGMR_"^U^"_PSGSM_U_PSGHSM_U_PSGST_"^^"_$S(PSGOEAV:"A",1:"N")_"^^^^^"_PSGDT_U_PSGP_U_PSGDT S:PSGNEDFD $P(ND,U,$P(PSGNEDFD,U)["L"+10)=+PSGNEDFD
"RTN","PSJCOM1",107,0)
 S:$D(PSGOEE) $P(ND,U,24,25)=PSGOEE_U_PSGORD S:'PSGOEAV $P(ND,U,18)=DA S ND2=PSGSCH_U_$S(+PSGNESD=PSGNESD:+PSGNESD,1:"")_"^^"_+PSGNEFD_U_PSGS0Y_U_PSGS0XT_"^^^^"_+PSJPWD
"RTN","PSJCOM1",108,0)
 ;I PSGOEAV S F=^PS(55,PSGP,0) I $P(F,"^",7)="" S $P(F,"^",7)=$P($P(ND,"^",16),"."),$P(F,"^",8)="A",^(0)=F
"RTN","PSJCOM1",109,0)
 S $P(ND4,U,7)=DUZ I PSGOEAV,PSJSYSU D
"RTN","PSJCOM1",110,0)
 .S $P(ND4,U,PSJSYSU,PSJSYSU+1)=DUZ_U_PSGDT,$P(ND4,U,+PSJSYSU=1+9)=1,$P(ND4,U,+PSJSYSU=3+9)=0
"RTN","PSJCOM1",111,0)
 .S $P(ND4,U,9,10)=+$P(ND4,U,9)_U_+$P(ND4,U,10)
"RTN","PSJCOM1",112,0)
 S F="^TMP(""PSJCOM2"","_$J_","_DA_",",@(F_"0)")=ND
"RTN","PSJCOM1",113,0)
 ; Naked references below refers to full reference in F which is ^TMP("PSJCOM2",$J,DA,
"RTN","PSJCOM1",114,0)
 S @(F_".2)")=PSGPDRG_U_PSGDO_U_PSJNOO S:$G(PSJDOSE("DO"))]"" $P(^(.2),U,5,6)=$P(PSJDOSE("DO"),U,1,2) S:PSJCOM]"" $P(^(.2),"^",8)=PSJCOM
"RTN","PSJCOM1",115,0)
 I '$D(PSJDOSE("DO")),$D(PSGORD) S $P(@(F_".2)"),U,5,6)=$P(@("^PS("_$S(PSGORD["U":"55,"_PSGP_",5",1:53.1)_","_+PSGORD_",.2)"),U,5,6)
"RTN","PSJCOM1",116,0)
 ; Naked references below refers to full reference in F which is ^TMP("PSJCOM2",$J,DA,
"RTN","PSJCOM1",117,0)
 S @(F_"2)")=$P(ND2,"^",1,6),^(4)=ND4 S:PSGSI]"" ^(6)=PSGSI
"RTN","PSJCOM1",118,0)
 ; Naked references below refers to full reference in F which is ^TMP("PSJCOM2",$J,DA,
"RTN","PSJCOM1",119,0)
 S (C,X)=0 F  S X=$O(^PS(53.45,PSJSYSP,2,X)) Q:'X  S D=$G(^(X,0)) I D,$S('$P(D,U,3):1,1:$P(D,U,3)>DT) S C=C+1,@(F_"1,"_C_",0)")=$P(D,U,1,2),@(F_"1,""B"","_+D_","_C_")")=""
"RTN","PSJCOM1",120,0)
 S:C @(F_"1,0)")=U_$S(PSGOEAV:55.07,1:53.11)_"P^"_C_U_C
"RTN","PSJCOM1",121,0)
 ; Naked references below refers to full reference in F which is ^TMP("PSJCOM2",$J,DA,
"RTN","PSJCOM1",122,0)
 S (C,Q)=0 F  S Q=$O(^PS(53.45,PSJSYSP,1,Q)) Q:'Q  S X=$G(^(Q,0)) S:X]"" C=C+1,@(F_"3,"_C_",0)")=X
"RTN","PSJCOM1",123,0)
 S:C @(F_"3,0)")=U_$S(PSGOEAV:55.08,1:53.12)_U_C_U_C
"RTN","PSJCOM1",124,0)
 S:C @(F_"12,0)")=U_$S(PSGOEAV:55.0612,1:53.1012)_U_C_U_C
"RTN","PSJCOM1",125,0)
 W "."
"RTN","PSJCOM1",126,0)
OUT ;
"RTN","PSJCOM1",127,0)
 K PSGOETOF
"RTN","PSJCOM1",128,0)
DONE ;
"RTN","PSJCOM1",129,0)
 K C,D,ND,ND2,ND4,PSGDO,PSGDRG,PSGDRGN,PSGFOK,PSGHSM,PSGMR,PSGMRN,PSGNEDFD,PSGNEFD,PSGNESD,PSGPDRG,PSGPDRGN,PSGSI,PSGSTN,PSJDOSE,%,Q
"RTN","PSJCOM1",130,0)
 Q
"RTN","PSJCOM1",131,0)
EXPIRE ;Change status of order to expired and send notice to OE/RR
"RTN","PSJCOM1",132,0)
 N DA,DIE,DR,PSGPO,PSIVACT
"RTN","PSJCOM1",133,0)
 Q:'$G(PSJOO)!($G(PSJOO)["P")
"RTN","PSJCOM1",134,0)
 S STATUS="E",(PSGPO,PSIVACT)=1,DA=+PSJOO,DA(1)=PSGP,DIE=$S(PSJOO["V":"^PS(55,"_PSGP_",""IV"",",1:"^PS(55,"_PSGP_",5,"),DR=$S(PSJOO["V":"100////E",1:"28////E") D ^DIE
"RTN","PSJCOM1",135,0)
 D EN1^PSJHL2(PSGP,"SC",PSJOO)
"RTN","PSJCOM1",136,0)
 Q
"RTN","PSJCOMR")
0^43^B79145175
"RTN","PSJCOMR",1,0)
PSJCOMR ;BIR/CML3-RENEW A COMPLEX ORDER SERIES ;07 MAR 96 / 1:23 PM
"RTN","PSJCOMR",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**110,127,136,157,181,268,281**;16 DEC 97;Build 113
"RTN","PSJCOMR",3,0)
 ;
"RTN","PSJCOMR",4,0)
 ; Reference to ^PS(55 supported by DBIA 2191
"RTN","PSJCOMR",5,0)
 ; Reference to ^PSSLOCK supported by DBIA 2789
"RTN","PSJCOMR",6,0)
 ; Reference to NOW^%DTC supported by DBIA 10000
"RTN","PSJCOMR",7,0)
 ; Reference to ^DIR supported by DBIA 10026
"RTN","PSJCOMR",8,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSJCOMR",9,0)
 ; Reference to ^DD("DD" supported by DBIA 999
"RTN","PSJCOMR",10,0)
 ;
"RTN","PSJCOMR",11,0)
 ; renew a complex order series
"RTN","PSJCOMR",12,0)
 Q:'PSJCOM  K COMQUIT,PSGORQF
"RTN","PSJCOMR",13,0)
 W !!,"This order is part of a complex order. If you "_$S($P(PSJSYSP0,"^",3):"RENEW",1:"MARK")_" this order the",!,"following orders will be "_$S($P(PSJSYSP0,"^",3):"RENEWED",1:"MARKED")_" too." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSGORD)
"RTN","PSJCOMR",14,0)
 W !! K DIR S DIR(0)="Y",DIR("A")=$S($P(PSJSYSP0,"^",3):"RENEW THIS COMPLEX ORDER SERIES",1:"MARK THIS COMPLEX ORDER SERIES FOR RENEWAL"),DIR("B")="YES"
"RTN","PSJCOMR",15,0)
 S DIR("?")="Answer 'YES' to "_$S($P(PSJSYSP0,"^",3):"renew this complex order series",1:"mark this complex order series for renewal")_".  Answer 'NO' (or '^') to stop now." D ^DIR K DIR
"RTN","PSJCOMR",16,0)
 I 'Y N DIR D ABORT G DONE
"RTN","PSJCOMR",17,0)
 I '$D(DIRUT),Y D NEW S PSGCANFL=1 D DONE Q
"RTN","PSJCOMR",18,0)
 I '$D(DIRUT),PSJSYSU I $P(PSGND4,"^",15),$P(PSGND4,"^",16) D UNMARK,DONE Q
"RTN","PSJCOMR",19,0)
 D DONE,ABORT^PSGOEE
"RTN","PSJCOMR",20,0)
 Q
"RTN","PSJCOMR",21,0)
 ;
"RTN","PSJCOMR",22,0)
UNMARK ;  
"RTN","PSJCOMR",23,0)
 W !!,"THIS COMPLEX ORDER SERIES HAS BEEN 'MARKED FOR RENEWAL'.",! K DIR S DIR(0)="Y",DIR("A")="DO YOU WANT TO 'UNMARK IT'",DIR("B")="NO"
"RTN","PSJCOMR",24,0)
 S DIR("?",1)="  Answer 'YES' to unmark this complex order series.  Answer 'NO' (or '^') to leave the complex",DIR("?")="order series marked.  (An answer is required.)" D ^DIR
"RTN","PSJCOMR",25,0)
 I 'Y N DIR D ABORT^PSGOEE G DONE
"RTN","PSJCOMR",26,0)
 N PSGORD,XX,X S XX=0,X="" F  S XX=$O(^PS(55,"ACX",PSJCOM,XX)) Q:'XX  F  S X=$O(^PS(55,"ACX",PSJCOM,XX,X)) Q:X=""  S PSGORD=X D
"RTN","PSJCOMR",27,0)
 .S PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4))
"RTN","PSJCOMR",28,0)
 .S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=21180+PSJSYSU D ^PSGAL5 S $P(PSGND4,"^",15,17)="^^",^PS(55,PSGP,5,DA,4)=PSGND4 W "...DONE!"
"RTN","PSJCOMR",29,0)
 ;
"RTN","PSJCOMR",30,0)
DONE ;
"RTN","PSJCOMR",31,0)
 K %DT,DA,DIE,DIR,DR,FDSD,PSGAL,PSGALR,PSGDL,PSGDLS,PSGFD,PSGFOK,PSGND4,PSGOEE,PSGOER0,PSGOER1,PSGOER2
"RTN","PSJCOMR",32,0)
 K PSGOERDP,PSGOPR,PSGOSD,PSGPOSA,PSGPOSD,PSGPR,PSGPX,PSGRD,PSGSD,PSGTOL,PSGTOO,PSGUOW,PSGWLL,RF,%
"RTN","PSJCOMR",33,0)
 Q
"RTN","PSJCOMR",34,0)
 ;
"RTN","PSJCOMR",35,0)
NEW ; get info, write record
"RTN","PSJCOMR",36,0)
 K ^TMP("PSJCOMR",$J)
"RTN","PSJCOMR",37,0)
 N DUOUT,PSGORD,TMPP,TMPO,PS55ACX,TMPDUZ,TMPOE,COMQUIT S TMPP=0 K PS55ACX M PS55ACX(55,"ACX",PSJCOM)=^PS(55,"ACX",PSJCOM)
"RTN","PSJCOMR",38,0)
 F  S TMPP=$O(PS55ACX(55,"ACX",PSJCOM,TMPP)) Q:'TMPP!$G(COMQUIT)  D
"RTN","PSJCOMR",39,0)
 . S TMPO=0 F  S TMPO=$O(PS55ACX(55,"ACX",PSJCOM,TMPP,TMPO)) Q:TMPO=""!$G(COMQUIT)  S PSGORD=TMPO D:PSGORD["U" NEWUD  I PSGORD["V" D NEWIV
"RTN","PSJCOMR",40,0)
 I $G(COMQUIT)!$G(DUOUT)  W !!,"By not verifying all the orders, none of the orders will be verified." D PAUSE^VALM1 Q
"RTN","PSJCOMR",41,0)
 I '$G(COMQUIT)&'$G(DUOUT) S TMPOE=0 F  S TMPOE=$O(^PS(55,"ACX",PSJCOM,TMPOE)) Q:TMPOE=""  S TMPO=0 F  S TMPO=$O(^PS(55,"ACX",PSJCOM,TMPOE,TMPO)) Q:'TMPO!$G(COMQUIT)  S PSGORD=TMPO D
"RTN","PSJCOMR",42,0)
 . K VSTRING S VSTRING=$G(^TMP("PSJCOMR",$J,PSJCOM,TMPO)) I PSGORD'=$P(VSTRING,"^",2) S COMQUIT=1 Q
"RTN","PSJCOMR",43,0)
 . S PSGP=$P(VSTRING,"^"),PSGDT=$P(VSTRING,"^",3),PSGOEPR=$P(VSTRING,"^",4),PSGOFD=$P(VSTRING,"^",5),PSGFD=$P(VSTRING,"^",6),PSJNOO=$P(VSTRING,"^",7),TMPDUZ=$P(VSTRING,"^",8)
"RTN","PSJCOMR",44,0)
 . D:PSGORD["U" FILEUD D:PSGORD["V" FILEIV
"RTN","PSJCOMR",45,0)
 K ^TMP("PSJCOMR",$J),VSTRING
"RTN","PSJCOMR",46,0)
 Q
"RTN","PSJCOMR",47,0)
NEWUD N PSJABT,PSGDRG,PSJREN,X,XX,PSGORDP,UDSTRING S PSGDRG=$P($G(^PS(55,PSGP,5,+PSGORD,1,1,0)),"^"),PSJREN=1
"RTN","PSJCOMR",48,0)
 ;D OC55
"RTN","PSJCOMR",49,0)
 Q:$D(PSGORQF)  ; quit if not to continue
"RTN","PSJCOMR",50,0)
 D NOW^%DTC S PSGDT=%,PSGND4=$G(^PS(55,PSGP,5,+PSGORD,4)) I '$P(PSJSYSP0,"^",3) D MARK Q
"RTN","PSJCOMR",51,0)
 S PSGWLL=$S('$P(PSJSYSW0,"^",4):0,1:+$G(^PS(55,PSGP,5.1))),PSGOEE="R" K PSGOEOS
"RTN","PSJCOMR",52,0)
 K ^PS(53.45,PSJSYSP,1),^(2) D MOVE(3,1),MOVE(1,2)
"RTN","PSJCOMR",53,0)
 D DATE^PSGOER0(PSGP,PSGORD,PSGDT) I '$D(PSGFOK(106)) D DONE,ABORT^PSGOEE S VALMBCK="R" Q
"RTN","PSJCOMR",54,0)
 W !!,"...updating order..." N PSGOEAV S PSGOEAV=+PSJSYSU,PSGOORD=PSGORD,PSGOER1=$G(^PS(55,PSGP,5,+PSGORD,.2)),PSGSI=$G(^(6)) W "."
"RTN","PSJCOMR",55,0)
 S PSGMR=$P(PSGOER0,"^",3),PSGSM=$P(PSGOER0,"^",5),PSGHSM=$P(PSGOER0,"^",6)
"RTN","PSJCOMR",56,0)
 S PSGMRN=$$ENMRN^PSGMI(PSGMR),PSGPDRGN=$$ENPDN^PSGMI(PSGPDRG),PSGDO=$P(PSGOER1,"^",2),PSGSCH=$P(PSGOER2,"^")
"RTN","PSJCOMR",57,0)
 S PSGS0Y=$P(PSGOER2,"^",5),PSGS0XT=$P(PSGOER2,"^",6),PSGNESD=PSGSD,PSGNEFD=PSGFD
"RTN","PSJCOMR",58,0)
 S:PSJPWD'=$P(PSGOER2,U,10) PSGS0Y=$$ENRNAT^PSGOU($P(PSGOER2,U,10),+PSJPWD,PSGSCH,PSGS0Y)
"RTN","PSJCOMR",59,0)
 S UDSTRING=PSGP_"^"_PSGORD_"^"_PSGDT_"^"_PSGOEPR_"^"_PSGOFD_"^"_PSGFD_"^"_PSJNOO F II=1:1:$L(UDSTRING,"^") I $P(UDSTRING,"^",II)="" K UDSTRING
"RTN","PSJCOMR",60,0)
 I '$D(UDSTRING) S COMQUIT=1 Q
"RTN","PSJCOMR",61,0)
 S:$G(DUZ) UDSTRING=UDSTRING_"^"_DUZ D TEMP(UDSTRING)
"RTN","PSJCOMR",62,0)
 Q
"RTN","PSJCOMR",63,0)
 ;
"RTN","PSJCOMR",64,0)
FILEUD ;
"RTN","PSJCOMR",65,0)
 ;Changed the reference to the type "O" for order numbers previously in v4.5
"RTN","PSJCOMR",66,0)
 N X,PSJORD,PSGOERDP,PSGOREAS,PSGRZERO S PSJORD=PSGORD K PSJPREX
"RTN","PSJCOMR",67,0)
 ;Make sure Admin times for parent don't carry to children;BHW;PSJ*5*136
"RTN","PSJCOMR",68,0)
 S X=$$LS^PSSLOCK(PSGP,PSGORD)  S PSGRTWO=^PS(55,+$G(PSGP),5,+PSGORD,2) S PSGRZERO="^PS(55,"_PSGP_",5,"_+PSGORD_",0)",PSGOREAS=$P(@(PSGRZERO),"^",24) D
"RTN","PSJCOMR",69,0)
 . S (PSGAT,PSGS0Y)=$P(PSGRTWO,"^",5)
"RTN","PSJCOMR",70,0)
 . S $P(@PSGRZERO,"^",24)="R" D UPDREN^PSGOER(PSGORD,PSGDT,PSGOEPR,PSGOFD,PSJNOO,$G(TMPDUZ)),UPDRENOE^PSGOER(PSGP,PSGORD) S $P(@PSGRZERO,"^",24)=PSGOREAS
"RTN","PSJCOMR",71,0)
 I +$G(PSJSYSU)=3,$G(PSJCOM) D CMPLX2^PSJCOM1(PSGP,PSJCOM,PSGORD) I $G(PSGPXN) S PSJPREX=1
"RTN","PSJCOMR",72,0)
 W !!,"...updating order..." K DA S DA(1)=PSGP,DA=+PSGORD,PSGAL("C")=PSJSYSU*10+18000 D ^PSGAL5 W "."
"RTN","PSJCOMR",73,0)
 I '$G(PSGOERDP),$P(PSJSYSW0,"^",4) I $G(PSGFD),$G(PSGWLL),(PSGFD'<PSGWLL) S $P(^PS(55,PSGP,5.1),"^")=+PSGFD
"RTN","PSJCOMR",74,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSGORD
"RTN","PSJCOMR",75,0)
 D SETOC^PSJNEWOC(PSGORD)
"RTN","PSJCOMR",76,0)
 ; ** This is where the Automated Dispensing Machine hook is called. Do NOT DELETE or change location **
"RTN","PSJCOMR",77,0)
 D RENEW^PSJADM
"RTN","PSJCOMR",78,0)
 ; ** END of INTERFACE Hook **
"RTN","PSJCOMR",79,0)
 D UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSJCOMR",80,0)
 W ".DONE!" S VALMBCK="Q"
"RTN","PSJCOMR",81,0)
 Q
"RTN","PSJCOMR",82,0)
 ;
"RTN","PSJCOMR",83,0)
MARK ;
"RTN","PSJCOMR",84,0)
 I $P(PSGND4,"^",15),$P(PSGND4,"^",16) W $C(7),!!?3,"...THIS ORDER IS ALREADY MARKED FOR RENEWAL!..." Q
"RTN","PSJCOMR",85,0)
 K DA S $P(PSGND4,"^",15,17)="1^"_DUZ_"^"_PSGDT,^PS(55,PSGP,5,+PSGORD,4)=PSGND4,PSGAL("C")=13180,DA(1)=PSGP,DA=+PSGORD W "." D ^PSGAL5
"RTN","PSJCOMR",86,0)
 I $D(PSJSYSO) S PSGORD=+PSGORD_"A",PSGPOSA="R",PSGPOSD=PSGDT D ENPOS^PSGVDS
"RTN","PSJCOMR",87,0)
 Q
"RTN","PSJCOMR",88,0)
MOVE(X,Y) ; Move comments/dispense drugs from 55 to 53.45.
"RTN","PSJCOMR",89,0)
 S Q=0 F  S Q=$O(^PS(55,PSGP,5,+PSGORD,X,Q)) Q:'Q  S ^PS(53.45,PSJSYSP,Y,Q,0)=$G(^(Q,0))
"RTN","PSJCOMR",90,0)
 S:Q ^PS(53.45,Y,0)="^53.450"_Y_"P^"_Q_U_Q
"RTN","PSJCOMR",91,0)
 Q
"RTN","PSJCOMR",92,0)
OC55 ;* Order checks for Speed finish and regular finish
"RTN","PSJCOMR",93,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJPDRG,PSJDD,PSJALLGY
"RTN","PSJCOMR",94,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSJCOMR",95,0)
 F PSGDDI=0:0 S PSGDDI=$O(^PS(55,PSGP,5,+PSGORD,1,PSGDDI)) Q:'PSGDDI  D
"RTN","PSJCOMR",96,0)
 . S PSJDD=+$G(^PS(55,PSGP,5,+PSGORD,1,PSGDDI,0))
"RTN","PSJCOMR",97,0)
 . S PSJALLGY(PSJDD)=""
"RTN","PSJCOMR",98,0)
 K PSGORQF D ENDDC^PSGSICHK(PSGP,PSJDD)
"RTN","PSJCOMR",99,0)
 Q
"RTN","PSJCOMR",100,0)
 ;
"RTN","PSJCOMR",101,0)
RIV ; Renew order.
"RTN","PSJCOMR",102,0)
 Q:'PSJCOM  N PSGORD,TMPP,TMPO S (TMPP,TMPO)=0 K PS55ACX M PS55ACX(55,"ACX",PSJCOM)=^PS(55,"ACX",PSJCOM)
"RTN","PSJCOMR",103,0)
 F  S TMPP=$O(PS55ACX(55,"ACX",PSJCOM,TMPP)) Q:'TMPP  S TMPO=0 F  S TMPO=$O(PS55ACX(55,"ACX",PSJCOM,TMPP,TMPO)) Q:TMPO=""  D
"RTN","PSJCOMR",104,0)
 . S PSGORD=TMPO D:PSGORD["U" NEWUD  D:PSGORD["V" NEWIV
"RTN","PSJCOMR",105,0)
 Q
"RTN","PSJCOMR",106,0)
NEWIV ;Renew complex IV orders
"RTN","PSJCOMR",107,0)
 N X,XX
"RTN","PSJCOMR",108,0)
 I P(17)="D",P(12) N ERR D RI W:$G(ERR)=1 $C(7),"  Order unchanged." Q:$G(ERR)<2
"RTN","PSJCOMR",109,0)
 K PSGORQF S PSIVRNFG=1 D ORDCHK^PSJLIFN K PSIVRNFG Q:$G(PSGORQF)  W !
"RTN","PSJCOMR",110,0)
 I $G(PSGORD)["V" S ON55=PSGORD S P("OLDON")=$P(^PS(55,DFN,"IV",+PSGORD,2),"^",5) S:'P("OLDON") P("OLDON")=ON55
"RTN","PSJCOMR",111,0)
 ;
"RTN","PSJCOMR",112,0)
R1 N PSIVND0,PSIVND2,PSIVREAS,PSIVOFD,IVSTRING,P2,PSJBKDR S PSJBKDR=1
"RTN","PSJCOMR",113,0)
 S P("NEWON")=ON55,(PSIVOK,EDIT)="25^1",P2=P(2) S P(2)=$$DATE^PSJUTL2 D EDIT^PSIVEDT S P(2)=P2 I X="^" D RD Q
"RTN","PSJCOMR",114,0)
 S:+VAIN(4)'=$P($G(^PS(55,DFN,"IV",+P("OLDON"),2)),U,10) P(11)=$$ENRNAT^PSGOU($P($G(^PS(55,DFN,"IV",+P("OLDON"),2)),U,10),+VAIN(4),P(9),P(11))
"RTN","PSJCOMR",115,0)
 S PSIVCHG=2
"RTN","PSJCOMR",116,0)
 D OK G:X["N" R1 I X=U D RD Q
"RTN","PSJCOMR",117,0)
 S P(17)="A",P("RES")="R",P("FRES")="" D:'$D(PSJIVORF) ORPARM^PSIVOREN I PSJIVORF D  Q:'$D(P("NAT"))
"RTN","PSJCOMR",118,0)
 .D NATURE^PSIVOREN I '$D(P("NAT")) D RD S COMQUIT=1 Q
"RTN","PSJCOMR",119,0)
 .S ON=ON55 ;D SET^PSIVORFE
"RTN","PSJCOMR",120,0)
 S P(16)="",PSJORIFN="",PSIVACT=1,P("21FLG")="",PSIVOFD=$P($G(^PS(55,DFN,"IV",+PSGORD,0)),"^",3)
"RTN","PSJCOMR",121,0)
 S IVSTRING=DFN_"^"_ON55_"^"_$$DATE^PSJUTL2()_"^"_+$G(P(6))_"^"_PSIVOFD_"^"_P(3)_"^"_P("NAT") F II=1:1:$L(IVSTRING,"^") I $P(IVSTRING,"^",II)="" K IVSTRING
"RTN","PSJCOMR",122,0)
 I '$D(IVSTRING) S COMQUIT=1 Q
"RTN","PSJCOMR",123,0)
 S:$G(DUZ) IVSTRING=IVSTRING_"^"_DUZ D TEMP(IVSTRING)
"RTN","PSJCOMR",124,0)
 Q
"RTN","PSJCOMR",125,0)
 ;
"RTN","PSJCOMR",126,0)
FILEIV ;
"RTN","PSJCOMR",127,0)
 N X,ON,ON55,PSJORD,P,PSIVTMP,PSIVZERO,OREAS
"RTN","PSJCOMR",128,0)
 S X=$$LS^PSSLOCK(DFN,+PSGORD_"V") S PSIVZERO="^PS(55,"_DFN_",""IV"","_+PSGORD_",0)" S PSIVTMP0=$G(@PSIVZERO) Q:'PSIVTMP0
"RTN","PSJCOMR",129,0)
 S PSIVTMP2="^PS(55,"_DFN_",""IV"","_+PSGORD_",2)",OREAS=$P(PSIVTMP2,"^",8),$P(@PSIVTMP2,"^",8)="R"
"RTN","PSJCOMR",130,0)
 F I=1:1:$L(PSIVTMP0,"^") S P(I)=$P(PSIVTMP0,"^",I)
"RTN","PSJCOMR",131,0)
 S (ON,ON55,PSJORD)=PSGORD,P(3)=PSGFD,P(6)=PSGOEPR,P("NAT")=PSJNOO,PSIVOFD=PSGOFD D RUPDATE^PSIVOREN(DFN,ON55,P(2))
"RTN","PSJCOMR",132,0)
 Q:'PSJIVORF
"RTN","PSJCOMR",133,0)
 D EN1^PSJHL2(DFN,"SN",+ON55_"V","ORDER RENEWED")
"RTN","PSJCOMR",134,0)
 S OD=P(2) D EN^PSIVORE
"RTN","PSJCOMR",135,0)
 D VF1^PSJLIACT("","",0),UNL^PSSLOCK(DFN,+ON55_"V") S $P(@PSIVTMP2,"^",8)=OREAS
"RTN","PSJCOMR",136,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"R")
"RTN","PSJCOMR",137,0)
 Q
"RTN","PSJCOMR",138,0)
 ;
"RTN","PSJCOMR",139,0)
TEMP(VARS) ;
"RTN","PSJCOMR",140,0)
 Q:'PSJCOM  S ^TMP("PSJCOMR",$J,PSJCOM,PSGORD)=VARS
"RTN","PSJCOMR",141,0)
 Q
"RTN","PSJCOMR",142,0)
 ;
"RTN","PSJCOMR",143,0)
RD ; Delete for renew.
"RTN","PSJCOMR",144,0)
 D DEL55^PSIVORE2 S (ON55,P("PON"))=P("OLDON") D GT55^PSIVORFB
"RTN","PSJCOMR",145,0)
 Q
"RTN","PSJCOMR",146,0)
 ;
"RTN","PSJCOMR",147,0)
OK ;Print example label, run order through checker, ask if it is ok.
"RTN","PSJCOMR",148,0)
 S P16=0,PSIVEXAM=1,(PSIVNOL,PSIVCT)=1 D GTOT^PSIVUTL(P(4)) I ($G(P("PD"))="") D GTPD^PSIVORE2
"RTN","PSJCOMR",149,0)
 D ^PSIVCHK I $D(DUOUT) S X="^" Q
"RTN","PSJCOMR",150,0)
 I ERR=1 S X="N" Q
"RTN","PSJCOMR",151,0)
 W ! D ^PSIVORLB K PSIVEXAM S Y=P(2) W !,"Start date: " X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),?30," Stop date: " S Y=P(3) X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),!
"RTN","PSJCOMR",152,0)
 D EFDIV^PSJUTL($G(ZZND))
"RTN","PSJCOMR",153,0)
 S X="Is this O.K.: ^"_$S(ERR:"N",1:"Y")_"^^NO"_$S(ERR'=1:",YES",1:"") D ENQ^PSIV I X["?" S HELP="OK" D ^PSIVHLP G OK
"RTN","PSJCOMR",154,0)
 Q
"RTN","PSJCOMR",155,0)
 ;
"RTN","PSJCOMR",156,0)
RI ; Reinstate Auto-DC'ed order.
"RTN","PSJCOMR",157,0)
 N DA,DIE,DIR,DIU,DR,PSIVACT,PSIVALT,PSIVALCK,PSIVREA W !!,$C(7),"This order has been Auto-DC'ed."
"RTN","PSJCOMR",158,0)
 S DIR(0)="Y",DIR("A")="Reinstate this order" D ^DIR K DIR I 'Y S ERR=1 Q
"RTN","PSJCOMR",159,0)
 D NOW^%DTC I %>$P($G(^PS(55,DFN,"IV",+ON55,2)),U,7) D
"RTN","PSJCOMR",160,0)
 .K DIR S ERR=1,DIR(0)="Y",DIR("A",1)="The original stop date of this order has past.",DIR("A")="Do you wish to renew this order" D ^DIR K DIR S ERR=$S(Y:2,1:1)
"RTN","PSJCOMR",161,0)
 Q:$G(ERR)  S X=$G(^VA(200,+P(6),"PS")) I $S('X:1,'$P(X,U,4):0,DT<$P(X,U,4):0,1:1) S ERR=1
"RTN","PSJCOMR",162,0)
 I $G(ERR) W !!,$C(7),"This order's provider is no longer valid. Please enter a valid provider." S (EDIT,PSIVOK)=1 D EDIT^PSIVEDT I $G(DONE) W $C(7),"Order unchanged." S ERR=1 Q
"RTN","PSJCOMR",163,0)
 N PSGALO S PSGALO=18530 D ENARI^PSIVOPT(DFN,ON,DUZ,PSGALO)
"RTN","PSJCOMR",164,0)
 Q
"RTN","PSJCOMR",165,0)
 ;
"RTN","PSJCOMR",166,0)
ABORT ; No changes
"RTN","PSJCOMR",167,0)
 W !!,$C(7),"No changes made to this order." D PAUSE^VALM1 K PSGOEEF S PSGOEEF=0
"RTN","PSJCOMR",168,0)
 Q
"RTN","PSJCOMV")
0^45^B41513309
"RTN","PSJCOMV",1,0)
PSJCOMV ;BIR/CML3-FINISH COMPLEX IV ORDERS ENTERED THROUGH OE/RR ;02 Feb 2001  12:20 PM
"RTN","PSJCOMV",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**110,127,267,257,281**;16 DEC 97;Build 113
"RTN","PSJCOMV",3,0)
 ;
"RTN","PSJCOMV",4,0)
 ; Reference to ^%DTC is supported by DBIA 10000
"RTN","PSJCOMV",5,0)
 ; Reference to ^DIR is supported by DBIA 10026
"RTN","PSJCOMV",6,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSJCOMV",7,0)
 ;
"RTN","PSJCOMV",8,0)
 ;
"RTN","PSJCOMV",9,0)
IV ; Move IV data in local variables to ^TMP
"RTN","PSJCOMV",10,0)
 Q:'PSJCOM  Q:ON'["P"
"RTN","PSJCOMV",11,0)
 M ^TMP("PSJCOM",$J,+ON)=^PS(53.1,+ON)
"RTN","PSJCOMV",12,0)
 S P(17)="N"
"RTN","PSJCOMV",13,0)
 K ND S ND(0)=+ON_U_+P(6)_U_$S(+P("MR"):+P("MR"),1:"")_U_$P(P("OT"),U)_U_U_U_"C",$P(ND(0),U,9)=P(17),$P(ND(0),U,21)=$G(P(21))
"RTN","PSJCOMV",14,0)
 S $P(ND(0),U,14,16)=P("LOG")_U_DFN_U_P("LOG"),$P(ND(0),U,24,26)=$G(P("RES"))_U_$G(P("OLDON"))_U_$G(P("NEWON")) S ND(2)=P(9)_U_P(2)_U_U_P(3)_U_P(11)_U_P(15),$P(ND(4),U,7,9)=+P("CLRK")_U_U_P("REN")
"RTN","PSJCOMV",15,0)
 S ND(8)=P(4)_U_P(23)_U_P("SYRS")_U_P(5)_U_P(8)_"^^"_P(7),ND(9)=$S($L(P("REM")_P("OPI")):P("REM")_U_P("OPI"),1:"")
"RTN","PSJCOMV",16,0)
 S:+$G(P("CLIN")) ^TMP("PSJCOM",$J,+ON,"DSS")=P("CLIN")
"RTN","PSJCOMV",17,0)
 F X=0,2,4,8,9 S ^TMP("PSJCOM",$J,+ON,X)=ND(X)
"RTN","PSJCOMV",18,0)
 S:'+$G(^TMP("PSJCOM",$J,+ON,.2)) $P(^(.2),U,1,3)=+P("PD")_U_P("DO")_U_$G(P("NAT"))
"RTN","PSJCOMV",19,0)
 F DRGT="AD","SOL" D:$D(DRG(DRGT)) PTD531
"RTN","PSJCOMV",20,0)
 I '+$P(PSJSYSP0,"^",9) D NEWNVAL^PSJCOM(ON,$S(+PSJSYSU=3:22005,1:22000))
"RTN","PSJCOMV",21,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=ON
"RTN","PSJCOMV",22,0)
 D SETOC^PSJNEWOC(ON)
"RTN","PSJCOMV",23,0)
 I +PSJSYSU=3,+$P(PSJSYSP0,U,9) D VFYIV Q
"RTN","PSJCOMV",24,0)
 I +PSJSYSU=1,+$P(PSJSYSP0,U,9),$G(PSJIRNF) D VFYIV
"RTN","PSJCOMV",25,0)
 I $G(PSIVENO),($P(^PS(53.1,+PSJORD,0),U,9)="N") D EN^VALM("PSJ LM IV INPT ACTIVE")
"RTN","PSJCOMV",26,0)
 Q
"RTN","PSJCOMV",27,0)
 ;
"RTN","PSJCOMV",28,0)
VFYIV ;
"RTN","PSJCOMV",29,0)
 Q:'PSJCOM
"RTN","PSJCOMV",30,0)
 D KILL531^PSJIMO1(DFN,"",+ON)
"RTN","PSJCOMV",31,0)
 I '$D(^TMP("PSJCOM",$J,+ON)) M ^TMP("PSJCOM",$J,+ON)=^PS(53.1,+ON) D
"RTN","PSJCOMV",32,0)
 . N CHILD,ORDER S ORDER=0 F  S ORDER=$O(^PS(53.1,"ACX",PSJCOM,ORDER)) Q:'ORDER  D
"RTN","PSJCOMV",33,0)
 .. I '$D(^TMP("PSJCOM",$J,+ORDER)) M ^TMP("PSJCOM",$J,+ORDER)=^PS(53.1,+ORDER)
"RTN","PSJCOMV",34,0)
 I ON["P" D
"RTN","PSJCOMV",35,0)
 . S P(17)="A"
"RTN","PSJCOMV",36,0)
 . S PSGORDP=ON ;Used in ACTLOG to update activity log in ^TMP
"RTN","PSJCOMV",37,0)
 . NEW PSGX S PSGX=$S($D(^TMP("PSJCOM2",$J,+ON,2.5)):$G(^TMP("PSJCOM2",$J,+ON,2.5)),1:$G(^TMP("PSJCOM2",$J,+ON,2.5))),PSGRSD=$P(PSGX,U),PSGRFD=$P(PSGX,U,3)
"RTN","PSJCOMV",38,0)
 . S:$D(^TMP("PSJCOM2",$J,+ON,0)) $P(^TMP("PSJCOM2",$J,+ON,0),"^",9)=P(17) S:'$D(^TMP("PSJCOM2",$J,+ON,0)) $P(^TMP("PSJCOM",$J,+ON,0),"^",9)=P(17) W "." ;D ^PSGOT
"RTN","PSJCOMV",39,0)
 D NEWNVAL^PSJCOM(ON,(PSJSYSU*10+22000)) W "."
"RTN","PSJCOMV",40,0)
 S VND4=$S('$D(^TMP("PSJCOM2",$J,+ON)):$G(^TMP("PSJCOM",$J,+ON,4)),1:$G(^TMP("PSJCOM2",$J,+ON,4)))
"RTN","PSJCOMV",41,0)
 S VND2P5=$$GETDUR^PSJLIVMD(DFN,ON,$E(ON,$L(ON)),1) I VND2P5]"" D
"RTN","PSJCOMV",42,0)
 . S:'$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM",$J,+ON,2.5)="^"_VND2P5 Q
"RTN","PSJCOMV",43,0)
 . S:$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM2",$J,+ON,2.5)="^"_VND2P5
"RTN","PSJCOMV",44,0)
 I $G(PSGRSD) D
"RTN","PSJCOMV",45,0)
 . S PSGRSD=$$ENDTC^PSGMI(PSGRSD) D NEWNVAL^PSJCOM(ON,6090,"Requested Start Date",PSGRSD)
"RTN","PSJCOMV",46,0)
 . S PSGRFD=$$ENDTC^PSGMI(PSGRFD) D NEWNVAL^PSJCOM(ON,6090,"Requested Stop Date",PSGRFD)
"RTN","PSJCOMV",47,0)
 K PSGRSD,PSGRFD,PSGALFN
"RTN","PSJCOMV",48,0)
 NEW X S X=0 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S X=1
"RTN","PSJCOMV",49,0)
 I +PSJSYSU=3,ON'["O",$S(X:0,'$P(VND4,"^",16):1,1:$P(VND4,"^",15)) ; D EN^PSGPEN(+ON)
"RTN","PSJCOMV",50,0)
 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9)
"RTN","PSJCOMV",51,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT,^TMP("PSJCOM",$J,+ON,4)=VND4
"RTN","PSJCOMV",52,0)
 S:'$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM",$J,+ON,4)=VND4 S:$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM2",$J,+ON,4)=VND4
"RTN","PSJCOMV",53,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSJORD
"RTN","PSJCOMV",54,0)
 W:'$D(PSJSPEED) ! W !,"ORDER VERIFIED.",!
"RTN","PSJCOMV",55,0)
 I '$D(PSJSPEED) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSJCOMV",56,0)
 S VALMBCK="Q"
"RTN","PSJCOMV",57,0)
 S ^TMP("PSJCOM",$J)="A" S:$D(^TMP("PSJCOM2",$J,+ON)) ^TMP("PSJCOM2",$J)="A" Q
"RTN","PSJCOMV",58,0)
 ;
"RTN","PSJCOMV",59,0)
PTD531 ; Move drug data from local array into ^TMP
"RTN","PSJCOMV",60,0)
 K ^TMP("PSJCOM",$J,DRGT) S ^TMP("PSJCOM",$J,+ON,DRGT,0)=$S(DRGT="AD":"^53.157^0^0",1:"^53.158^0^0")
"RTN","PSJCOMV",61,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSJCOMV",62,0)
 .S X1=$P(DRG(DRGT,X),U),Y=^TMP("PSJCOM",$J,+ON,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJCOMV",63,0)
 .S ^TMP("PSJCOM",$J,+ON,DRGT,0)=Y,Y=+X1_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^TMP("PSJCOM",$J,+ON,DRGT,+DRG,0)=Y
"RTN","PSJCOMV",64,0)
 Q
"RTN","PSJCOMV",65,0)
 ;
"RTN","PSJCOMV",66,0)
NEWIV ;Create new IV order in appropriate file format
"RTN","PSJCOMV",67,0)
 M ^TMP("PSJCOM2",$J,+ON)=^PS(53.1,+ON)
"RTN","PSJCOMV",68,0)
 S $P(^TMP("PSJCOM",$J,+ON,0),"^",9)="DE",P("OLDON")=+ON_"P",P("RES")="E"
"RTN","PSJCOMV",69,0)
 I +$P(PSJSYSP0,U,9) D NEWAIV Q
"RTN","PSJCOMV",70,0)
 S ND(0)=+ON_U_+P(6)_U_$S(+P("MR"):+P("MR"),1:"")_U_$P(P("OT"),U)_U_U_U_"C",$P(ND(0),U,9)=P(17),$P(ND(0),U,21)=$G(P(21))
"RTN","PSJCOMV",71,0)
 S $P(ND(0),U,14,16)=P("LOG")_U_DFN_U_P("LOG"),$P(ND(0),U,24,26)=$G(P("RES"))_U_$G(P("OLDON"))_U_$G(P("NEWON")) S ND(2)=P(9)_U_P(2)_U_U_P(3)_U_P(11)_U_P(15),$P(ND(4),U,7,9)=+P("CLRK")_U_U_P("REN")
"RTN","PSJCOMV",72,0)
 S ND(8)=P(4)_U_P(23)_U_P("SYRS")_U_P(5)_U_P(8)_"^^"_P(7),ND(9)=$S($L(P("REM")_P("OPI")):P("REM")_U_P("OPI"),1:"")
"RTN","PSJCOMV",73,0)
 S:+$G(P("CLIN")) ^TMP("PSJCOM2",$J,+ON,"DSS")=P("CLIN")
"RTN","PSJCOMV",74,0)
 F X=0,2,4,8,9 S ^TMP("PSJCOM2",$J,+ON,X)=ND(X)
"RTN","PSJCOMV",75,0)
 S:'+$G(^TMP("PSJCOM2",$J,+ON,.2)) $P(^(.2),U,1,3)=+P("PD")_U_P("DO")_U_$G(P("NAT"))
"RTN","PSJCOMV",76,0)
 I $G(P("PRNTON"))]"" S $P(^TMP("PSJCOM2",$J,+ON,.2),"^",8)=$G(P("PRNTON"))
"RTN","PSJCOMV",77,0)
 F DRGT="AD","SOL" D:$D(DRG(DRGT)) PTD5312
"RTN","PSJCOMV",78,0)
 D EN^VALM("PSJ LM IV INPT ACTIVE")
"RTN","PSJCOMV",79,0)
 Q
"RTN","PSJCOMV",80,0)
 ;
"RTN","PSJCOMV",81,0)
PTD5312 ; Move drug data from local array into ^TMP
"RTN","PSJCOMV",82,0)
 K ^TMP("PSJCOM2",$J,DRGT) S ^TMP("PSJCOM2",$J,+ON,DRGT,0)=$S(DRGT="AD":"^53.157^0^0",1:"^53.158^0^0")
"RTN","PSJCOMV",83,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSJCOMV",84,0)
 .S X1=$P(DRG(DRGT,X),U),Y=^TMP("PSJCOM2",$J,+ON,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJCOMV",85,0)
 .S ^TMP("PSJCOM2",$J,+ON,DRGT,0)=Y,Y=+X1_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^TMP("PSJCOM2",$J,+ON,DRGT,+DRG,0)=Y
"RTN","PSJCOMV",86,0)
 Q
"RTN","PSJCOMV",87,0)
 ;
"RTN","PSJCOMV",88,0)
NEWAIV ;Creates new IV order in the file 55 format
"RTN","PSJCOMV",89,0)
 N DA,DIK,ND,PSIVACT
"RTN","PSJCOMV",90,0)
 I '$D(PSGDT) D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJCOMV",91,0)
 S:'$D(P(21)) (P(21),P("21FLG"))="" S ND(0)=+ON,P(22)=$S(VAIN(4):+VAIN(4),1:.5) F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSJCOMV",92,0)
 S ND(.3)=$G(P("INS"))
"RTN","PSJCOMV",93,0)
 S $P(ND(0),U,17)="A",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(P("NAT"))_U_U_U_$G(P("PRNTON"))
"RTN","PSJCOMV",94,0)
 F X=0,1,3,.2,.3 S ^TMP("PSJCOM2",$J,+ON,X)=ND(X)
"RTN","PSJCOMV",95,0)
 S $P(^TMP("PSJCOM2",$J,+ON,2),U,1,4)=P("LOG")_U_+P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSJCOMV",96,0)
 S $P(^TMP("PSJCOM2",$J,+ON,2),U,11)=+P("CLRK")
"RTN","PSJCOMV",97,0)
 S:+$G(P("CLIN")) ^TMP("PSJCOM2",$J,+ON,"DSS")=P("CLIN")
"RTN","PSJCOMV",98,0)
 S:+$G(P("NINIT")) ^TMP("PSJCOM2",$J,+ON,4)=P("NINIT")_U_P("NINITDT")
"RTN","PSJCOMV",99,0)
 I +PSJSYSU=3 S $P(^TMP("PSJCOM2",$J,+ON,4),"^",4)=DUZ,$P(^TMP("PSJCOM2",$J,+ON,4),"^",5)=PSGDT,$P(^TMP("PSJCOM2",$J,+ON,4),"^",9)=1
"RTN","PSJCOMV",100,0)
 I +PSJSYSU=1 S $P(^TMP("PSJCOM2",$J,+ON,4),"^",10)=1
"RTN","PSJCOMV",101,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSJCOMV",102,0)
 Q
"RTN","PSJCOMV",103,0)
 ;
"RTN","PSJCOMV",104,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSJCOMV",105,0)
 K ^TMP("PSJCOM2",$J,+ON,DRGT) S ^TMP("PSJCOM2",$J,+ON,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSJCOMV",106,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSJCOMV",107,0)
 .S Y=^TMP("PSJCOM2",$J,+ON,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJCOMV",108,0)
 .S ^TMP("PSJCOM2",$J,+ON,DRGT,0)=Y,Y=$P(DRG(DRGT,X),U)_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^TMP("PSJCOM2",$J,+ON,DRGT,+DRG,0)=Y
"RTN","PSJCOMV",109,0)
 Q
"RTN","PSJCROC")
0^4^B43248221
"RTN","PSJCROC",1,0)
PSJCROC ;HP/MJE - CLINICAL REMINDER ORDER CHECKS FOR IP OC ;09/22/11 5:00pm
"RTN","PSJCROC",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**281**;16 DEC 97;Build 113
"RTN","PSJCROC",3,0)
 ;
"RTN","PSJCROC",4,0)
 ;Reference to ORDERCHK^PXRMORCH supported by DBIA 5531
"RTN","PSJCROC",5,0)
 ;Reference to SIG^XUSESIG supported by DBIA 10050
"RTN","PSJCROC",6,0)
 ;Reference to ^ORD(101.43 supported by DBIA 5430
"RTN","PSJCROC",7,0)
 ;
"RTN","PSJCROC",8,0)
CK(CDRG1) ;CHECK FOR CROCS AGAINST PROSPECTIVE DRUG
"RTN","PSJCROC",9,0)
 N PSJFIRST
"RTN","PSJCROC",10,0)
 S $P(CROCLN,"=",75)="=",$P(CROCLN2,"-",75)="-"
"RTN","PSJCROC",11,0)
 W "Now processing Clinical Reminder Order Checks. Please wait ..."
"RTN","PSJCROC",12,0)
 D ORDERCHK^PXRMORCH(DFN,-1,0,CDRG1,0)
"RTN","PSJCROC",13,0)
 ;H:'$D(^TMP($J,CDRG1)) 2
"RTN","PSJCROC",14,0)
 S (CROCSTA,CROCDNM,CROCNUM,CROCSTR,CROCHFLG)="" N DIRUT
"RTN","PSJCROC",15,0)
 I $D(^TMP($J,CDRG1)) D
"RTN","PSJCROC",16,0)
 .S CROCHFLG=2,CROCNR=0 ;W CROCLN
"RTN","PSJCROC",17,0)
 .F  S CROCSTA=$O(^TMP($J,CDRG1,CROCSTA)) Q:CROCSTA=""!$G(PSGORQF)  D
"RTN","PSJCROC",18,0)
 ..I CROCSTA=1 S CROCHFLG=1
"RTN","PSJCROC",19,0)
 ..F  S CROCDNM=$O(^TMP($J,CDRG1,CROCSTA,CROCDNM)) Q:CROCDNM=""!$G(PSGORQF)  D
"RTN","PSJCROC",20,0)
 ...S CROCSTA2=$S(CROCSTA=1:"HIGH",CROCSTA=2:"MEDIUM",CROCSTA=3:"LOW",1:"UNKNOWN")
"RTN","PSJCROC",21,0)
 ...I '$G(PSJFIRST) W !!,CROCLN S PSJFIRST=1
"RTN","PSJCROC",22,0)
 ...W !,"*** Clinical Reminder Order Check | Severity: "_CROCSTA2_" ***",!
"RTN","PSJCROC",23,0)
 ...W !,CROCDNM,!
"RTN","PSJCROC",24,0)
 ...F  S CROCNUM=$O(^TMP($J,CDRG1,CROCSTA,CROCDNM,CROCNUM)) Q:CROCNUM=""!$G(PSGORQF)  D
"RTN","PSJCROC",25,0)
 ....I ($Y+5)>IOSL,$E(IOST)="C" D
"RTN","PSJCROC",26,0)
 .....W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSJCROC",27,0)
 ....;RTC 182375
"RTN","PSJCROC",28,0)
 ....;W !,^TMP($J,CDRG1,CROCSTA,CROCDNM,CROCNUM) S PSJCROCF=1
"RTN","PSJCROC",29,0)
 ....D LONGTEXT($G(^TMP($J,CDRG1,CROCSTA,CROCDNM,CROCNUM)),79)
"RTN","PSJCROC",30,0)
 ....S PSJCROCF=1
"RTN","PSJCROC",31,0)
 ...W !!,CROCLN2 I ($Y+5)>IOSL,$E(IOST)="C" W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSJCROC",32,0)
 K ^TMP($J,CDRG1)
"RTN","PSJCROC",33,0)
 I $G(PSJDGCK) K CROCSTA,CROCDNM,CROCNUM,CROCSTR,CROCHFLG,CROCLN,CROCLN2,CDRG1 Q
"RTN","PSJCROC",34,0)
 I CROCHFLG=1 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="Y" D ^DIR K DIR
"RTN","PSJCROC",35,0)
 I CROCHFLG=1,Y["^"!(Y=0)!($D(DIRUT)) S (PSGORQF)=1 Q
"RTN","PSJCROC",36,0)
 I CROCHFLG=1 D SIG^XUSESIG I X1="" W !!,"Signature Code not valid" S (PSGORQF)=1 H 2 Q
"RTN","PSJCROC",37,0)
 I CROCHFLG=1 I X1'="" D EN3^PSJRXI("CLINICAL REMINDER",CDRG1)
"RTN","PSJCROC",38,0)
 I CROCHFLG>1 W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")="N" D ^DIR K DIR
"RTN","PSJCROC",39,0)
 I CROCHFLG>1,Y=1 D EN3^PSJRXI("CLINICAL REMINDER",CDRG1)
"RTN","PSJCROC",40,0)
 K CROCSTA,CROCDNM,CROCNUM,CROCSTR,CROCHFLG,CROCLN,CROCLN2,CDRG1,Y
"RTN","PSJCROC",41,0)
 Q
"RTN","PSJCROC",42,0)
 ;
"RTN","PSJCROC",43,0)
CKIVI ;Log IV interventions
"RTN","PSJCROC",44,0)
 N DIRUT
"RTN","PSJCROC",45,0)
 I $G(PSJDGCK) K CROCSTA,CROCDNM,CROCNUM,CROCSTR,CROCHFLG,CROCLN,CROCLN2,CDRG1 Q
"RTN","PSJCROC",46,0)
 I CROCHFLG=1 D
"RTN","PSJCROC",47,0)
 .S CROCIXN1="" F  S CROCIXN1=$O(^TMP($J,"CROCDRG",1,CROCIXN1)) Q:CROCIXN1=""!($G(PSGORQF)=1)  D
"RTN","PSJCROC",48,0)
 ..F CROCIXN2=0:0 S CROCIXN2=$O(^TMP($J,"CROCDRG",1,CROCIXN1,CROCIXN2)) Q:'CROCIXN2!($G(PSGORQF)=1)  D
"RTN","PSJCROC",49,0)
 ...W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue with "_^TMP($J,"CROCDRG",1,CROCIXN1,CROCIXN2)_"? ",DIR("B")="Y" D ^DIR K DIR
"RTN","PSJCROC",50,0)
 ...I Y["^"!(Y=0)!($D(DIRUT)) S PSGORQF=1 Q
"RTN","PSJCROC",51,0)
 ...D SIG^XUSESIG I X1="" W !!,"Signature Code not valid" S PSGORQF=1 H 2 Q
"RTN","PSJCROC",52,0)
 ...I X1'="" D EN3^PSJRXI("CLINICAL REMINDER",^TMP($J,"CROCDRG",1,CROCIXN1,CROCIXN2))
"RTN","PSJCROC",53,0)
 I CROCHFLG=2!($D(^TMP($J,"CROCDRG",2)))!($D(^TMP($J,"CROCDRG",3))) D
"RTN","PSJCROC",54,0)
 .I $G(PSGORQF)=1 Q
"RTN","PSJCROC",55,0)
 .F CROCIXN1=1:0 S CROCIXN1=$O(^TMP($J,"CROCDRG",CROCIXN1)) Q:'CROCIXN1  D
"RTN","PSJCROC",56,0)
 ..S CROCIXN2="" F  S CROCIXN2=$O(^TMP($J,"CROCDRG",CROCIXN1,CROCIXN2)) Q:CROCIXN2=""  D
"RTN","PSJCROC",57,0)
 ...I CROCIXN1=2,$D(^TMP($J,"CROCDRG",1,CROCIXN2)) Q
"RTN","PSJCROC",58,0)
 ...I CROCIXN1=3,$D(^TMP($J,"CROCDRG",2,CROCIXN2))!($D(^TMP($J,"CROCDRG",1,CROCIXN2))) Q
"RTN","PSJCROC",59,0)
 ...F CROCIXN3=0:0 S CROCIXN3=$O(^TMP($J,"CROCDRG",CROCIXN1,CROCIXN2,CROCIXN3)) Q:'CROCIXN3  D
"RTN","PSJCROC",60,0)
 ....S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene with "_^TMP($J,"CROCDRG",CROCIXN1,CROCIXN2,CROCIXN3)_"? ",DIR("B")="N" D ^DIR K DIR
"RTN","PSJCROC",61,0)
 ....I Y=1 D EN3^PSJRXI("CLINICAL REMINDER",^TMP($J,"CROCDRG",CROCIXN1,CROCIXN2,CROCIXN3))
"RTN","PSJCROC",62,0)
 K CROCSTA,CROCDNM,CROCNUM,CROCSTR,CROCHFLG,CROCLN,CROCLN2,CDRG1,CROCIXN1,CROCIXN2,CROCIXN3,Y,^TMP($J,"CROCDRG")
"RTN","PSJCROC",63,0)
 Q
"RTN","PSJCROC",64,0)
 ; 
"RTN","PSJCROC",65,0)
CKIV(CDRG2,IVFLG) ;CHECK FOR CROCS AGAINST PROSPECTIVE IV ORDER
"RTN","PSJCROC",66,0)
 S (CROCSTA2,CROCDNM2,CROCNUM2)="" S CROCCTR=1 N PHROI
"RTN","PSJCROC",67,0)
 I IVFLG="A" S PHROI=$$GET1^DIQ(52.6,CDRG2,15,"I")
"RTN","PSJCROC",68,0)
 I IVFLG="S" S PHROI=$$GET1^DIQ(52.7,CDRG2,9,"I")
"RTN","PSJCROC",69,0)
 S ODRI=$O(^ORD(101.43,"ID",PHROI_";99PSP",0))
"RTN","PSJCROC",70,0)
 D ORDERCHK^PXRMORCH(DFN,ODRI,0,-1,0)
"RTN","PSJCROC",71,0)
 I $D(^TMP($J,$G(ODRI))) D
"RTN","PSJCROC",72,0)
 .S CROCNR=0
"RTN","PSJCROC",73,0)
 .F  S CROCSTA2=$O(^TMP($J,ODRI,CROCSTA2)) Q:CROCSTA2=""  D
"RTN","PSJCROC",74,0)
 ..I IVFLG="A" S ^TMP($J,"CROCDRG",CROCSTA2,$P(TMPDRG1("AD",CRIV),"^",2)_" "_$P(TMPDRG1("AD",CRIV),"^",3),CRIV)=$P(TMPDRG1("AD",CRIV),"^",2)_" "_$P(TMPDRG1("AD",CRIV),"^",3)
"RTN","PSJCROC",75,0)
 ..I IVFLG="S" S ^TMP($J,"CROCDRG",CROCSTA2,$P(TMPDRG1("SOL",CRIV),"^",2)_" "_$P(TMPDRG1("SOL",CRIV),"^",3),CRIV)=$P(TMPDRG1("SOL",CRIV),"^",2)_" "_$P(TMPDRG1("SOL",CRIV),"^",3)
"RTN","PSJCROC",76,0)
 ..S CROCCTR=CROCCTR+1
"RTN","PSJCROC",77,0)
 ..F  S CROCDNM2=$O(^TMP($J,ODRI,CROCSTA2,CROCDNM2)) Q:CROCDNM2=""  D
"RTN","PSJCROC",78,0)
 ...F  S CROCNUM2=$O(^TMP($J,ODRI,CROCSTA2,CROCDNM2,CROCNUM2)) Q:CROCNUM2=""  D
"RTN","PSJCROC",79,0)
 ....S ^TMP($J,"CROCIV",CROCSTA2,CROCDNM2,CROCNUM2)=^TMP($J,ODRI,CROCSTA2,CROCDNM2,CROCNUM2)
"RTN","PSJCROC",80,0)
 K ^TMP($J,$G(ODRI)),CROCCTR,CROCSTA2,CROCDNM2,CROCNUM2,CROCSTR2,CROCHFLG2,ODRI,IVFLG,CDRG2
"RTN","PSJCROC",81,0)
 Q
"RTN","PSJCROC",82,0)
 ;
"RTN","PSJCROC",83,0)
CKIVD ;DISPLAY IV CROCS
"RTN","PSJCROC",84,0)
 S (CROCSTA,CROCDNM,CROCNUM,CROCSTR,CROCHFLG)="" S CROCNMF=0
"RTN","PSJCROC",85,0)
 N PSJFIRST
"RTN","PSJCROC",86,0)
 I $D(^TMP($J,"CROCIV")) D
"RTN","PSJCROC",87,0)
 .S CROCHFLG=2 ;W !!,CROCLN
"RTN","PSJCROC",88,0)
 .F  S CROCSTA=$O(^TMP($J,"CROCIV",CROCSTA)) Q:CROCSTA=""!$G(PSGORQF)  D
"RTN","PSJCROC",89,0)
 ..I CROCSTA=1 S CROCHFLG=1
"RTN","PSJCROC",90,0)
 ..F  S CROCDNM=$O(^TMP($J,"CROCIV",CROCSTA,CROCDNM)) Q:CROCDNM=""!$G(PSGORQF)  D
"RTN","PSJCROC",91,0)
 ...S CROCSTA2=$S(CROCSTA=1:"HIGH",CROCSTA=2:"MEDIUM",CROCSTA=3:"LOW",1:"UNKNOWN")
"RTN","PSJCROC",92,0)
 ...I '$G(PSJFIRST) W !!,CROCLN S PSJFIRST=1
"RTN","PSJCROC",93,0)
 ...W !,"*** Clinical Reminder Order Check | Severity: "_CROCSTA2_" ***",!
"RTN","PSJCROC",94,0)
 ...W !,CROCDNM,! S:'CROCNMF CDRG1=CROCDNM S CROCNMF=1
"RTN","PSJCROC",95,0)
 ...F  S CROCNUM=$O(^TMP($J,"CROCIV",CROCSTA,CROCDNM,CROCNUM)) Q:CROCNUM=""!$G(PSGORQF)  D
"RTN","PSJCROC",96,0)
 ....I ($Y+5)>IOSL,$E(IOST)="C" D
"RTN","PSJCROC",97,0)
 .....W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSJCROC",98,0)
 ....;RTC 182375
"RTN","PSJCROC",99,0)
 ....;W !,^TMP($J,"CROCIV",CROCSTA,CROCDNM,CROCNUM) S PSJCROCF=1
"RTN","PSJCROC",100,0)
 ....D LONGTEXT($G(^TMP($J,"CROCIV",CROCSTA,CROCDNM,CROCNUM)),79)
"RTN","PSJCROC",101,0)
 ....S PSJCROCF=1
"RTN","PSJCROC",102,0)
 ...W !!,CROCLN2 I ($Y+5)>IOSL,$E(IOST)="C" W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSJCROC",103,0)
 K ^TMP($J,"CROCIV"),CROCNMF G CKIVI
"RTN","PSJCROC",104,0)
 Q
"RTN","PSJCROC",105,0)
 ;
"RTN","PSJCROC",106,0)
LONGTEXT(PSJTXT,PSJLEN) ;
"RTN","PSJCROC",107,0)
 ; The ^DIWP can only handle up to 999 characters. This call is used for long text. 
"RTN","PSJCROC",108,0)
 I $G(PSJTXT)="" Q
"RTN","PSJCROC",109,0)
 I '+$G(PSJLEN) S PSJLEN=79
"RTN","PSJCROC",110,0)
 NEW PSJCNT,PSJLINE,PSJOUT,PSJSTR,PSJSTRB,PSJSTRE,PSJSTRL,PSJX
"RTN","PSJCROC",111,0)
 S PSJSTR="",PSJLINE=0,(PSJSTRL,PSJCNT,PSJSTRB,PSJSTRE)=1
"RTN","PSJCROC",112,0)
 ;
"RTN","PSJCROC",113,0)
 ; If string has no blank space.
"RTN","PSJCROC",114,0)
 I $L(PSJTXT," ")=1,$L(PSJTXT)>PSJLEN D  D DSPLTXT(.PSJOUT) Q
"RTN","PSJCROC",115,0)
 . S PSJLINE=$L(PSJTXT)\PSJLEN+$S($L(PSJTXT)#PSJLEN:1,1:0)
"RTN","PSJCROC",116,0)
 . F PSJX=1:1:PSJLINE-1 D
"RTN","PSJCROC",117,0)
 .. S PSJSTR="",PSJSTRE=PSJLEN*PSJX+1
"RTN","PSJCROC",118,0)
 .. S PSJSTR=$E(PSJTXT,PSJSTRB,PSJSTRE),PSJOUT(PSJCNT)=PSJSTR,PSJCNT=PSJCNT+1,PSJSTRB=PSJSTRE+1
"RTN","PSJCROC",119,0)
 . I PSJSTRB,PSJSTRE S PSJOUT(PSJCNT+1)=$E(PSJTXT,PSJSTRB,$L(PSJTXT))
"RTN","PSJCROC",120,0)
 ;
"RTN","PSJCROC",121,0)
 ; This is for text contains at least a space
"RTN","PSJCROC",122,0)
 F PSJX=1:1:$L(PSJTXT," ") D
"RTN","PSJCROC",123,0)
 . I ($L(PSJSTR)+$L($P(PSJTXT," ",PSJX)))>PSJLEN S PSJSTR="",PSJCNT=PSJCNT+1
"RTN","PSJCROC",124,0)
 . S PSJSTR=PSJSTR_$P(PSJTXT," ",PSJX)_" "
"RTN","PSJCROC",125,0)
 . S PSJOUT(PSJCNT)=PSJSTR
"RTN","PSJCROC",126,0)
 D DSPLTXT(.PSJOUT)
"RTN","PSJCROC",127,0)
 Q
"RTN","PSJCROC",128,0)
DSPLTXT(PSJOUT) ;
"RTN","PSJCROC",129,0)
 Q:'$D(PSJOUT)
"RTN","PSJCROC",130,0)
 NEW PSJX
"RTN","PSJCROC",131,0)
 F PSJX=0:0 S PSJX=$O(PSJOUT(PSJX)) Q:'PSJX  D
"RTN","PSJCROC",132,0)
 . I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJCROC",133,0)
 . W !,$G(PSJOUT(PSJX))
"RTN","PSJCROC",134,0)
 Q
"RTN","PSJDGAL2")
0^13^B168266917
"RTN","PSJDGAL2",1,0)
PSJDGAL2 ;BIR/SAB - displays stored DRUG ALLERGY w/sign/symptoms ;10/27/11  02:22
"RTN","PSJDGAL2",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**260,281**;16 DEC 97;Build 113
"RTN","PSJDGAL2",3,0)
 ;External reference to ^PS(50.605, supported by DBIA 696
"RTN","PSJDGAL2",4,0)
 ;External reference to GETOC4^OROCAPI1 supported by DBIA 5729
"RTN","PSJDGAL2",5,0)
 ;External reference to ^ORD(100.05 supported by DBIA 5731
"RTN","PSJDGAL2",6,0)
 ;External reference to ^GMRD(120.83 supported by DBIA 5767
"RTN","PSJDGAL2",7,0)
 ;External reference to ^PS(55 supported by DBIA 2191
"RTN","PSJDGAL2",8,0)
 ;External reference to ^PS(50.416 supported by DBIA 4998
"RTN","PSJDGAL2",9,0)
 ;External Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSJDGAL2",10,0)
 ;
"RTN","PSJDGAL2",11,0)
START ; This routine is called when the hidden option 'DA' is typed from the IP Medication screen
"RTN","PSJDGAL2",12,0)
 N PSJNOALL
"RTN","PSJDGAL2",13,0)
 ; If allergy is not stored in 100.05 then don't allow DA at that point.
"RTN","PSJDGAL2",14,0)
 I $D(^TMP("PSODAOC",$J,"ALLERGY")) W !,"DA is not a valid selection." H 1 Q
"RTN","PSJDGAL2",15,0)
 I +$G(PSJAGYSV),$D(^TMP("PSODAOC",$J)) W !,"DA is not a valid selection." H 1 Q
"RTN","PSJDGAL2",16,0)
 I '$G(PSJORD) W !!,"NO Drug Allergy Order Checks found." S PSJNOALL=1 G EXT
"RTN","PSJDGAL2",17,0)
 N ZORN,X,RET,DA,ZCNT,ZCNTT,XXI,ZZQ,DA,ZI,IT,SEVT,SEVN,ZFND,ZDA,ZDATB,ZST,ZQS,ZDATE,ZERO,PSJPROV,PSJDGORD,PSJDALOC
"RTN","PSJDGAL2",18,0)
 N FLAG2,PRTFLG,PSJASORT,PSJQUIT,PSJZERO,PSJREA,PSJTYPE,PSJRSITE,PSJASEV,PSJASEV2,PSJRDATA,ZIIEN,DIE,DIR,DR,DIC
"RTN","PSJDGAL2",19,0)
 N PSJQUIT,DIWF,DIWL,DIWR,II,PSJTSTMD,IEN,PSJSSITE,PSJDAOC,PSJDRGCL,PSJCAGNT,PSJDATA,PROSPECT,PSJDOI,PSJDOIN,PSJOIN
"RTN","PSJDGAL2",20,0)
 S (FLAG2,ZCNT,ZCNTT,ZFND,PSJQUIT,IEN,PSJDGORD)=0
"RTN","PSJDGAL2",21,0)
 D FULL^VALM1
"RTN","PSJDGAL2",22,0)
 ;gets drug allergy order chks PSJ*5*260
"RTN","PSJDGAL2",23,0)
 D
"RTN","PSJDGAL2",24,0)
 .; -- RTC 187974 - remove check for variable - !($G(PSJDSVFY))
"RTN","PSJDGAL2",25,0)
 .I $G(PSIVCOPY) S PSJDGORD=$S($G(ON)["P":ON,$G(ON55)["P":ON55,1:"") S:$G(PSJDGORD) ZORN=+$P(^PS(53.1,+PSJDGORD,0),U,21),PSJDALOC=+PSJDGORD_"P" Q
"RTN","PSJDGAL2",26,0)
 .I $G(PSJORD)["P" S PSJDGORD=$G(PSJORD) S:$G(PSJDGORD) ZORN=+$P(^PS(53.1,+PSJDGORD,0),U,21),PSJDALOC=+PSJDGORD_"P" Q
"RTN","PSJDGAL2",27,0)
 .I $G(PSJORD)["U" S PSJDGORD=$G(PSJORD) S:$G(PSJDGORD) ZORN=+$P(^PS(55,DFN,5,+PSJDGORD,0),U,21),PSJDALOC=DFN_"U"_+PSJDGORD Q
"RTN","PSJDGAL2",28,0)
 .I $G(PSJORD)["V" S PSJDGORD=$G(PSJORD) S:$G(PSJDGORD) ZORN=+$P(^PS(55,DFN,"IV",+PSJDGORD,0),U,21),PSJDALOC=DFN_"V"_+PSJDGORD
"RTN","PSJDGAL2",29,0)
 .Q:+$G(ZORN)
"RTN","PSJDGAL2",30,0)
 .I $G(ON)["P"!($G(ON55)["P") S PSJDGORD=$S($G(ON)["P":ON,$G(ON55)["P":ON55,1:"") S ZORN=+$P(^PS(53.1,+PSJDGORD,0),U,21),PSJDALOC=+PSJDGORD_"P" Q
"RTN","PSJDGAL2",31,0)
 .I $G(ON)["U"!($G(ON55)["U") S PSJDGORD=$S($G(ON)["U":ON,$G(ON55)["U":ON55,1:"") S ZORN=+$P(^PS(55,DFN,5,+PSJDGORD,0),U,21),PSJDALOC=DFN_"U"_+PSJDGORD Q
"RTN","PSJDGAL2",32,0)
 .I $G(ON)["V"!($G(ON55)["V") S PSJDGORD=$S($G(ON)["V":ON,$G(ON55)["V":ON55,1:"") S ZORN=+$P(^PS(55,DFN,"IV",+PSJDGORD,0),U,21),PSJDALOC=DFN_"V"_+PSJDGORD
"RTN","PSJDGAL2",33,0)
 ;
"RTN","PSJDGAL2",34,0)
 S:'$D(PSJDAOC) PSJDAOC="IP"
"RTN","PSJDGAL2",35,0)
 I '$G(ZORN) W !!,"NO Drug Allergy Order Checks found." G EXT
"RTN","PSJDGAL2",36,0)
 D SET3^PSJNEWOC  ;set up variables for order check
"RTN","PSJDGAL2",37,0)
 S PSJDAOC=$G(PSJDAOC)_"Allergy"
"RTN","PSJDGAL2",38,0)
 I $L(PSJDAOC)>40 S PSJDAOC=$E(PSJDAOC,1,40)
"RTN","PSJDGAL2",39,0)
 K ^TMP("PSJDAOCD",$J),^TMP("PSJAL",$J),RET S RET=""
"RTN","PSJDGAL2",40,0)
 D GETOC4^OROCAPI1(ZORN,.RET)
"RTN","PSJDGAL2",41,0)
 I $O(RET(ZORN,"DATA",""))="" S FLAG2=1
"RTN","PSJDGAL2",42,0)
 ;
"RTN","PSJDGAL2",43,0)
 F ZI=0:0 S ZI=$O(RET(ZORN,"DATA",ZI)) Q:'ZI  I +$P(RET(ZORN,"DATA",ZI,1),";",2)=3 S ZCNTT=1
"RTN","PSJDGAL2",44,0)
 I 'ZCNTT S FLAG2=1 W !!,"NO Drug Allergy Order Checks found." S PSJNOALL=1 G EXT
"RTN","PSJDGAL2",45,0)
 ;
"RTN","PSJDGAL2",46,0)
SORT ;build sort by severity, reactant/causitive agent
"RTN","PSJDGAL2",47,0)
 K PSJASORT
"RTN","PSJDGAL2",48,0)
 N ZIIEN,ZSIEN,ZSIGNS,SIGN,SIGNS,PSJPTLOC,PSJINST,PSJDCLAS,PSJIEN70,PSJIEN60,PSJDFLAG,PSJRETI,PSJAIENS,PSJDRCL2
"RTN","PSJDGAL2",49,0)
 N PSJFROM1,PSJREAB,PSJREAS,I
"RTN","PSJDGAL2",50,0)
 F ZI=0:0 S ZI=$O(RET(ZORN,"DATA",ZI)) Q:'ZI  I $D(RET(ZORN,"DATA",ZI,1)) D
"RTN","PSJDGAL2",51,0)
 .Q:+$P(RET(ZORN,"DATA",ZI,1),";",2)'=3
"RTN","PSJDGAL2",52,0)
 .I $G(RET(ZORN,"DATA",ZI,"OR",1,0))]"" S ^TMP("PSJDAOCD",$J,"AOR",$G(RET(ZORN,"DATA",ZI,"OR",1,0)))=""
"RTN","PSJDGAL2",53,0)
 .K PSJAIENS
"RTN","PSJDGAL2",54,0)
 .S ZIIEN=0 F  S ZIIEN=$O(^ORD(100.05,ZI,4,ZIIEN)) Q:ZIIEN=""  I $D(^ORD(100.05,ZI,4,ZIIEN,0)) D
"RTN","PSJDGAL2",55,0)
 ..Q:$P(^ORD(100.05,ZI,0),"^",3)["CPRS"
"RTN","PSJDGAL2",56,0)
 ..S (PSJZERO,PSJREAB,PSJREA,PSJREAS,PSJTYPE,PSJRSITE,PSJSSITE,PSJASEV,PSJASEV2,PSJDRGCL,PSJIEN70,PSJIEN60,PSJDFLAG,PSJRETI,PSJFROM1)=""
"RTN","PSJDGAL2",57,0)
 ..;
"RTN","PSJDGAL2",58,0)
 ..D GETS^DIQ(100.05,ZI,"70*","I","PSJIEN70"),GETS^DIQ(100.05,ZI,"60*","I","PSJIEN60")
"RTN","PSJDGAL2",59,0)
 ..S PSJDFLAG="",PSJDFLAG=$$GETORD^PSJNEWOA(ZI,PSJDGORD,PSJDFLAG)
"RTN","PSJDGAL2",60,0)
 ..Q:'PSJDFLAG
"RTN","PSJDGAL2",61,0)
 ..;
"RTN","PSJDGAL2",62,0)
 ..S PSJZERO=$G(^ORD(100.05,ZI,4,ZIIEN,0))
"RTN","PSJDGAL2",63,0)
 ..S PSJREAB=$P(PSJZERO,"^"),PSJFROM1=$P(PSJZERO,"^",2),PSJASEV=$P(PSJZERO,"^",7),PSJTYPE=$P(PSJZERO,"^",3)
"RTN","PSJDGAL2",64,0)
 ..S PSJRSITE=$P(PSJZERO,"^",4),PSJASEV2=$S(PSJASEV=3:"A",PSJASEV="2":"B",PSJASEV=1:"C",1:"D")
"RTN","PSJDGAL2",65,0)
 ..I PSJREAB["/" D  S PSJREA=$E(PSJREA,3,$L(PSJREA))
"RTN","PSJDGAL2",66,0)
 ...F I=1:1 S PSJREAS=$P(PSJREAB,"/",I) Q:PSJREAS=""  S PSJREA=PSJREA_"/ "_PSJREAS
"RTN","PSJDGAL2",67,0)
 ..I PSJREAB'["/" S PSJREA=PSJREAB
"RTN","PSJDGAL2",68,0)
 ..;DRUG CLASS
"RTN","PSJDGAL2",69,0)
 ..S (PSJCAGNT,PSJDRGCL,PSJDCLAS,PSJDRCL2)=""
"RTN","PSJDGAL2",70,0)
 ..F ZZQ=0:0 S ZZQ=$O(^ORD(100.05,ZI,4,ZIIEN,1,ZZQ)) Q:'ZZQ!(ZZQ'?1N.N)  D
"RTN","PSJDGAL2",71,0)
 ...S PSJDRCL2=^ORD(100.05,ZI,4,ZIIEN,1,ZZQ,0),PSJDCLAS=1
"RTN","PSJDGAL2",72,0)
 ...S PSJDRGCL=PSJDRGCL_"|"_$$GET1^DIQ(50.605,PSJDRCL2,1)
"RTN","PSJDGAL2",73,0)
 ..I PSJDRGCL'?1A.AP  S PSJDRGCL=$E(PSJDRGCL,2,999)
"RTN","PSJDGAL2",74,0)
 ..S:PSJDRGCL=""!(PSJDRGCL="|") PSJDRGCL="aaaa"
"RTN","PSJDGAL2",75,0)
 ..S PSJCAGNT=$S(PSJDRGCL'="aaaa":PSJDRGCL,1:$P(PSJREA,"|",1))
"RTN","PSJDGAL2",76,0)
 ..S (PSJDOI,PSJDOIN,PROSPECT,DRUGIEN)=""
"RTN","PSJDGAL2",77,0)
 ..;
"RTN","PSJDGAL2",78,0)
 ..I $D(^ORD(100.05,ZI,5,1,0)) S DRUGIEN=^ORD(100.05,ZI,5,1,0)
"RTN","PSJDGAL2",79,0)
 ..I DRUGIEN'="" D
"RTN","PSJDGAL2",80,0)
 ...S DRUG=$$GET1^DIQ(50,DRUGIEN,.01,"E"),PSJOIN=$$GET1^DIQ(50,DRUGIEN,2.1,"E")
"RTN","PSJDGAL2",81,0)
 ...S PROSPECT=DRUG  ;GENERIC NAME
"RTN","PSJDGAL2",82,0)
 ...I $G(PSJDGORD)["V"!($G(PSJDGORD)["P")&($D(^PS(53.1,+$G(PSJDGORD),"AD"))) S PROSPECT=PSJOIN  ;orderable item if IV
"RTN","PSJDGAL2",83,0)
 ..Q:PROSPECT=""
"RTN","PSJDGAL2",84,0)
 ..I PSJTYPE="L" S PSJRSITE=$$INST^PSJGMRA($G(PSJDALOC))
"RTN","PSJDGAL2",85,0)
 ..;
"RTN","PSJDGAL2",86,0)
 ..I $D(PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,0)) D
"RTN","PSJDGAL2",87,0)
 ...S:PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,0)'[(ZIIEN_"^"_ZI) PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,0)=PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,0)_"|"_ZIIEN_"^"_ZI_"^"_PSJCAGNT
"RTN","PSJDGAL2",88,0)
 ..I '$D(PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,0)) S PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,0)=ZIIEN_"^"_ZI_"^"_PSJCAGNT
"RTN","PSJDGAL2",89,0)
 ..S PSJDATA="",PSJDATA=PSJTYPE_"|"_PSJRSITE_"|"_$P(PSJZERO,"^",5)
"RTN","PSJDGAL2",90,0)
 ..I $D(PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,1)) D
"RTN","PSJDGAL2",91,0)
 ...S:PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,1)'[PSJDATA PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,1)=PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,1)_"^"_PSJDATA
"RTN","PSJDGAL2",92,0)
 ..I '$D(PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,1)) S PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,1)=PSJDATA,FLAG2=1
"RTN","PSJDGAL2",93,0)
 ..;SIGNS AND SYMPTOMS
"RTN","PSJDGAL2",94,0)
 ..S ZSIEN="" F  S ZSIEN=$O(^ORD(100.05,ZI,4,ZIIEN,3,ZSIEN)) Q:ZSIEN=""  I $D(^ORD(100.05,ZI,4,ZIIEN,3,ZSIEN,0)) D
"RTN","PSJDGAL2",95,0)
 ...S ZSIGNS=^ORD(100.05,ZI,4,ZIIEN,3,ZSIEN,0)
"RTN","PSJDGAL2",96,0)
 ...I '$D(PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,2)) S PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,2)=ZSIGNS Q
"RTN","PSJDGAL2",97,0)
 ...S:PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,2)'[("|"_ZSIGNS_"|") PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,2)=PSJASORT(PROSPECT,PSJASEV2,PSJREA,PSJFROM1,2)_"|"_ZSIGNS
"RTN","PSJDGAL2",98,0)
 ;
"RTN","PSJDGAL2",99,0)
 I 'FLAG2 W !!,"NO Drug Allergy Order Checks found." S PSJNOALL=1 G EXT
"RTN","PSJDGAL2",100,0)
 ;
"RTN","PSJDGAL2",101,0)
LOOP ;
"RTN","PSJDGAL2",102,0)
 ;**** Begin looping through sort
"RTN","PSJDGAL2",103,0)
 S (PSJASEV,PSJREA,PSJTYPE,ZIIEN,PROSPECT,PSJDRGCL,PSJCAGNT,PSJFROM1)=""
"RTN","PSJDGAL2",104,0)
 F  S PROSPECT=$O(PSJASORT(PROSPECT)) Q:PROSPECT=""  D
"RTN","PSJDGAL2",105,0)
 .S IEN=$G(IEN)+1,^TMP("PSJAL",$J,IEN,0)="A Drug-Allergy Reaction exists for this medication and/or class!"
"RTN","PSJDGAL2",106,0)
 .S IEN=$G(IEN)+1,^TMP("PSJAL",$J,IEN,0)=" "
"RTN","PSJDGAL2",107,0)
 .F  S PSJASEV=$O(PSJASORT(PROSPECT,PSJASEV)) Q:PSJASEV=""  D
"RTN","PSJDGAL2",108,0)
 ..F  S PSJCAGNT=$O(PSJASORT(PROSPECT,PSJASEV,PSJCAGNT)) Q:PSJCAGNT=""  d
"RTN","PSJDGAL2",109,0)
 ...F  S PSJFROM1=$O(PSJASORT(PROSPECT,PSJASEV,PSJCAGNT,PSJFROM1)) Q:PSJFROM1=""  D ADOC
"RTN","PSJDGAL2",110,0)
 ;
"RTN","PSJDGAL2",111,0)
PRT ; print allergy information to screen
"RTN","PSJDGAL2",112,0)
 D FULL^VALM1 W @IOF
"RTN","PSJDGAL2",113,0)
 N ZZ,PRTFLG,PRTFLG3 S (PRTFLG3,PRTFLG)=0
"RTN","PSJDGAL2",114,0)
 W $C(7),!
"RTN","PSJDGAL2",115,0)
 S ZZ="" F  S ZZ=$O(^TMP("PSJAL",$J,ZZ)) Q:ZZ=""  D  G EXIT:PSJQUIT
"RTN","PSJDGAL2",116,0)
 .S PSJDATA="",PSJDATA=$G(^TMP("PSJAL",$J,ZZ,0))
"RTN","PSJDGAL2",117,0)
 .I PRTFLG D
"RTN","PSJDGAL2",118,0)
 ..I PSJDATA["A Drug-Allergy Reaction exists for this medication and/or class" D EXT S (PRTFLG3,PRTFLG)=0
"RTN","PSJDGAL2",119,0)
 .I PSJDATA["Prospective Drug" S PRTFLG3=PRTFLG3+1
"RTN","PSJDGAL2",120,0)
 .I PRTFLG,PRTFLG3>1,PSJDATA["Prospective Drug" D EXT W !
"RTN","PSJDGAL2",121,0)
 .W !,PSJDATA S PRTFLG=1 I ($Y+3)>IOSL D FF
"RTN","PSJDGAL2",122,0)
 ;
"RTN","PSJDGAL2",123,0)
 K DIR,DUOUT,DIRUT
"RTN","PSJDGAL2",124,0)
 G EXIT:PSJQUIT
"RTN","PSJDGAL2",125,0)
 I $G(PRTFLG) W ! D FF
"RTN","PSJDGAL2",126,0)
 G EXIT
"RTN","PSJDGAL2",127,0)
 Q
"RTN","PSJDGAL2",128,0)
 ;
"RTN","PSJDGAL2",129,0)
ADOC ;
"RTN","PSJDGAL2",130,0)
 N ING,SS,DC,OH,CAG,CAUS,SEVT,SEVN,ZALL,Z,ZX,ZALL,FIRST,DRUGIEN,DRUG,DRUGS,ZCX,PSJWCA,CAUS2,CAUS3,ZLOC,PSJCAR,FLAG,I,ZDATE
"RTN","PSJDGAL2",131,0)
 N SITE,SITET,SITED,I,ZDATA,PSJSITE,PSJCSITE,CAUS4,PSJRDAT2,PSJNCOM,PSJNCOM1,PSJCOI,PSJCU,PSJCDF,PSJCPROS
"RTN","PSJDGAL2",132,0)
 S (PSJRSITE,PSJRDATA)=""
"RTN","PSJDGAL2",133,0)
 S PSJRDATA=PSJASORT(PROSPECT,PSJASEV,PSJCAGNT,PSJFROM1,0)
"RTN","PSJDGAL2",134,0)
 ;RTC 190465 - DA not display when allergy contains 2 or more VA Classes
"RTN","PSJDGAL2",135,0)
 ;F I=1:1 S PSJRDAT2=$P(PSJRDATA,"|",I) Q:PSJRDAT2=""
"RTN","PSJDGAL2",136,0)
 ;S:(I-1)>0 XXI=$P(PSJRDATA,"|",I-1)
"RTN","PSJDGAL2",137,0)
 ;S ZI=$P(XXI,"^",2),XXI=+XXI
"RTN","PSJDGAL2",138,0)
 S ZI=$P(PSJRDATA,"^",2),XXI=+PSJRDATA
"RTN","PSJDGAL2",139,0)
 S PSJRSITE=PSJASORT(PROSPECT,PSJASEV,PSJCAGNT,PSJFROM1,1)
"RTN","PSJDGAL2",140,0)
 ;
"RTN","PSJDGAL2",141,0)
 Q:XXI'>0
"RTN","PSJDGAL2",142,0)
 Q:'+ZI
"RTN","PSJDGAL2",143,0)
 Q:$P($G(^ORD(100.05,ZI,4,XXI,0)),"^")']""
"RTN","PSJDGAL2",144,0)
 S (SEVT,SEVN,CAUS,CAUS3,CAUS2,CAUS4,PSJWCA,PSJCAR,OH,DRUG,DRUGS,X,ING,SS,DC,ZALL,ZLOC,ZDATE)=""
"RTN","PSJDGAL2",145,0)
 S ZALL=$G(^ORD(100.05,ZI,4,XXI,0)),ZLOC=$P(ZALL,"^",3)
"RTN","PSJDGAL2",146,0)
 S CAUS=$P(ZALL,"^",1),CAUS2=$P($P(ZALL,"^",2),";"),CAUS3=$$GET1^DIQ(50.6,CAUS2,.01,"E")
"RTN","PSJDGAL2",147,0)
 S SEVT=$P(ZALL,"^",7),SEVN=$S(SEVT=1:"MILD",SEVT=2:"MODERATE",SEVT=3:"SEVERE",1:"Not Entered")
"RTN","PSJDGAL2",148,0)
 S ^TMP("PSJDAOCD",$J,"CA",CAUS)=""
"RTN","PSJDGAL2",149,0)
 S CAUS=PSJCAGNT,PSJCSITE=""
"RTN","PSJDGAL2",150,0)
 ;**** PARSE OUT SITES
"RTN","PSJDGAL2",151,0)
 I CAUS'?1A.AP S CAUS=$P(ZALL,"^",1)
"RTN","PSJDGAL2",152,0)
 I PSJRSITE'["^" D
"RTN","PSJDGAL2",153,0)
 .S ZDATE=$P(PSJRSITE,"|",3),ZDATE=$S(ZDATE'="":$E(ZDATE,4,5)_"/"_$E(ZDATE,6,7)_"/"_$E(ZDATE,2,3),1:"")
"RTN","PSJDGAL2",154,0)
 .S PSJCSITE=$P(PSJRSITE,"|",2),PSJCSITE=$$GET1^DIQ(4,PSJCSITE,.01)
"RTN","PSJDGAL2",155,0)
 .S PSJCSITE=$S(PSJCSITE'="":PSJCSITE,ZLOC="L":"LOCAL",ZLOC="R":"REMOTE",1:"Not Given")
"RTN","PSJDGAL2",156,0)
 .S PSJCAR=CAUS_" ("_PSJCSITE_" - "_ZDATE_")"
"RTN","PSJDGAL2",157,0)
 I PSJRSITE["^" D  S:PSJCAR'="" PSJCAR=CAUS_" ("_$E(PSJCAR,3,999)_")"
"RTN","PSJDGAL2",158,0)
 .F I=1:1 S ZDATA=$P(PSJRSITE,"^",I) Q:ZDATA=""  S PSJCSITE="" D
"RTN","PSJDGAL2",159,0)
 ..S ZDATE=$P(ZDATA,"|",3),ZDATE=$S(ZDATE'="":$E(ZDATE,4,5)_"/"_$E(ZDATE,6,7)_"/"_$E(ZDATE,2,3),1:"")
"RTN","PSJDGAL2",160,0)
 ..S PSJCSITE=$P(ZDATA,"|",2),PSJCSITE=$$GET1^DIQ(4,PSJCSITE,.01)
"RTN","PSJDGAL2",161,0)
 ..S PSJCSITE=$S(PSJCSITE'="":PSJCSITE,ZLOC="L":"LOCAL",ZLOC="R":"REMOTE",1:"Not Given")
"RTN","PSJDGAL2",162,0)
 ..S PSJCAR=PSJCAR_", "_PSJCSITE_" - "_ZDATE
"RTN","PSJDGAL2",163,0)
 ;****
"RTN","PSJDGAL2",164,0)
 I PSJCAR="" S PSJCAR=CAUS
"RTN","PSJDGAL2",165,0)
 S (PSJNCOM1,PSJCPROS)="" S PSJNCOM1=$$FINDC($G(PSJORD)) S:+$G(PSJNCOM1) PSJCPROS=$P(PSJNCOM1,"^",2),PSJNCOM1=$P(PSJNCOM1,"^")
"RTN","PSJDGAL2",166,0)
 S IEN=$G(IEN)+1,^TMP("PSJAL",$J,IEN,0)="   Prospective Drug: "_$S($G(PSJNCOM1):PSJCPROS,1:PROSPECT)
"RTN","PSJDGAL2",167,0)
 S OH=$$UPPER($P(ZALL,"^",6)),^TMP("PSJDAOCD",$J,"OH")=OH
"RTN","PSJDGAL2",168,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=58,DIWF=""
"RTN","PSJDGAL2",169,0)
 S X=PSJCAR
"RTN","PSJDGAL2",170,0)
 D ^DIWP S FIRST=1
"RTN","PSJDGAL2",171,0)
 F ZCX=0:0 S ZCX=$O(^UTILITY($J,"W",1,ZCX)) Q:'ZCX  S:$D(^UTILITY($J,"W",1,ZCX,0)) IEN=$G(IEN)+1,^TMP("PSJAL",$J,IEN,0)=$S(FIRST:"    Causative Agent: "_^UTILITY($J,"W",1,ZCX,0),1:"                     "_^UTILITY($J,"W",1,ZCX,0)) S FIRST=0
"RTN","PSJDGAL2",172,0)
 S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)="Historical/Observed: "_$S(OH="H":"HISTORICAL",OH="O":"OBSERVED",1:"Not Entered")
"RTN","PSJDGAL2",173,0)
 S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)="           Severity: "_$G(SEVN)
"RTN","PSJDGAL2",174,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=58,DIWF=""
"RTN","PSJDGAL2",175,0)
INGRED ;
"RTN","PSJDGAL2",176,0)
 ; DRUG INGREDIENT
"RTN","PSJDGAL2",177,0)
 S FLAG=0 K ^TMP("PSJDAOCD",$J,"DI") N PSJDRCL3
"RTN","PSJDGAL2",178,0)
 F ZZQ=0:0 S ZZQ=$O(^ORD(100.05,ZI,4,XXI,2,ZZQ)) Q:'ZZQ  S ^TMP("PSJDAOCD",$J,"DI",$P(^PS(50.416,$P(^ORD(100.05,ZI,4,XXI,2,ZZQ,0),"^"),0),"^"))="",FLAG=1
"RTN","PSJDGAL2",179,0)
 S X=""
"RTN","PSJDGAL2",180,0)
 F  S ING=$O(^TMP("PSJDAOCD",$J,"DI",ING)) Q:ING=""  S X=X_", "_ING
"RTN","PSJDGAL2",181,0)
 S X=$E(X,3,999)
"RTN","PSJDGAL2",182,0)
 ;S X=$P(ZALL,"^",1)
"RTN","PSJDGAL2",183,0)
 I X'="" D
"RTN","PSJDGAL2",184,0)
 .D ^DIWP
"RTN","PSJDGAL2",185,0)
 .S FIRST=1
"RTN","PSJDGAL2",186,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S:$D(^UTILITY($J,"W",1,ZX,0)) IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)=$S(FIRST:"        Ingredients: "_^UTILITY($J,"W",1,ZX,0),1:"                      "_^UTILITY($J,"W",1,ZX,0)) S FIRST=0
"RTN","PSJDGAL2",187,0)
SIGNS ;
"RTN","PSJDGAL2",188,0)
 ; SIGNS/SYMPTOMS
"RTN","PSJDGAL2",189,0)
 K ^UTILITY($J,"W"),^TMP("PSJDAOCD",$J,"SS") S DIWL=1,DIWR=58,DIWF="",ING=""
"RTN","PSJDGAL2",190,0)
 S (X,SIGNS,SIGN)="",SIGNS=$G(PSJASORT(PROSPECT,PSJASEV,PSJCAGNT,PSJFROM1,2))
"RTN","PSJDGAL2",191,0)
 I SIGNS'="" F ZZQ=1:1 S SIGN=$P(SIGNS,"|",ZZQ) Q:SIGN=""  D
"RTN","PSJDGAL2",192,0)
 .I $G(^GMRD(120.83,SIGN,0))]"" S ^TMP("PSJDAOCD",$J,"SS",$P(^GMRD(120.83,SIGN,0),"^"))=""
"RTN","PSJDGAL2",193,0)
 S X="",FIRST=1
"RTN","PSJDGAL2",194,0)
 I $O(^TMP("PSJDAOCD",$J,"SS",""))]"" S SS="" D
"RTN","PSJDGAL2",195,0)
 .F  S SS=$O(^TMP("PSJDAOCD",$J,"SS",SS)) Q:SS=""  S X=X_", "_SS
"RTN","PSJDGAL2",196,0)
 S X=$E(X,3,999) D ^DIWP
"RTN","PSJDGAL2",197,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)=$S(FIRST:"     Signs/Symptoms: "_$S(SIGNS="":"None Entered",1:^UTILITY($J,"W",1,ZX,0)),1:"                     "_^UTILITY($J,"W",1,ZX,0)) S FIRST=0
"RTN","PSJDGAL2",198,0)
 K ^UTILITY($J,"W")
"RTN","PSJDGAL2",199,0)
 ; DRUG CLASS
"RTN","PSJDGAL2",200,0)
 S DIWL=1,DIWR=58,DIWF="" K ^TMP("PSJDAOCD",$J,"DC")
"RTN","PSJDGAL2",201,0)
 F ZZQ=0:0 S ZZQ=$O(^ORD(100.05,ZI,4,XXI,1,ZZQ)) Q:'ZZQ  D
"RTN","PSJDGAL2",202,0)
 .S PSJDRCL3="",PSJDRCL3=$P(^PS(50.605,+$P(^ORD(100.05,ZI,4,XXI,1,ZZQ,0),"^"),0),"^") S ^TMP("PSJDAOCD",$J,"DC",+$P(^ORD(100.05,ZI,4,XXI,1,ZZQ,0),"^"))=PSJDRCL3_" "_$P($G(^PS(50.605,+$P($G(^ORD(100.05,ZI,4,XXI,1,ZZQ,0)),"^"),0)),"^",2)
"RTN","PSJDGAL2",203,0)
 S X="",FIRST=1
"RTN","PSJDGAL2",204,0)
 F DC=0:0 S DC=$O(^TMP("PSJDAOCD",$J,"DC",DC)) Q:'DC  S X=X_", "_^TMP("PSJDAOCD",$J,"DC",DC)  D
"RTN","PSJDGAL2",205,0)
 .I $L(X)>234 S X=$E(X,3,999) D ^DIWP S X=""
"RTN","PSJDGAL2",206,0)
 I X'="" S X=$E(X,3,999)
"RTN","PSJDGAL2",207,0)
 I X'="" D
"RTN","PSJDGAL2",208,0)
 .D ^DIWP
"RTN","PSJDGAL2",209,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)=$S(FIRST:"         Drug Class: "_^UTILITY($J,"W",1,ZX,0),1:"                     "_^UTILITY($J,"W",1,ZX,0)) S FIRST=0
"RTN","PSJDGAL2",210,0)
 .K ^UTILITY($J,"W") N Z,ZX
"RTN","PSJDGAL2",211,0)
 D INV ; intervention
"RTN","PSJDGAL2",212,0)
 Q
"RTN","PSJDGAL2",213,0)
 ;
"RTN","PSJDGAL2",214,0)
UPPER(PSJUCS) ;
"RTN","PSJDGAL2",215,0)
 Q $TR(PSJUCS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSJDGAL2",216,0)
 ;
"RTN","PSJDGAL2",217,0)
LOWER(PSJLCS) ;
"RTN","PSJDGAL2",218,0)
 Q $TR(PSJLCS,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","PSJDGAL2",219,0)
 ;
"RTN","PSJDGAL2",220,0)
EXT ;
"RTN","PSJDGAL2",221,0)
 K DIR,DUOUT,DIRUT,ZFND
"RTN","PSJDGAL2",222,0)
 I $G(PSJNOALL) D FULL^VALM1,PAUSE^VALM1 S VALMBCK="R" K PSJQUIT,DIR,DUOUT,DIRUT Q 
"RTN","PSJDGAL2",223,0)
 D FF
"RTN","PSJDGAL2",224,0)
 I $D(DIRUT) G EXIT
"RTN","PSJDGAL2",225,0)
 Q
"RTN","PSJDGAL2",226,0)
EXIT ;
"RTN","PSJDGAL2",227,0)
 I $G(PSJNOALL) D FULL^VALM1,PAUSE^VALM1 K PSJQUIT
"RTN","PSJDGAL2",228,0)
 S VALMBCK="R" K DIR,DUOUT,DIRUT,^TMP("PSJDAOCD",$J),^TMP("PSJAL",$J),ZPGK
"RTN","PSJDGAL2",229,0)
 Q
"RTN","PSJDGAL2",230,0)
 ;
"RTN","PSJDGAL2",231,0)
INV ;display intervention
"RTN","PSJDGAL2",232,0)
 ;changed to add Provider & Pharmacist and put in current sequence [ST - 6.17.2014]
"RTN","PSJDGAL2",233,0)
 S IEN=$G(IEN)+1,^TMP("PSJAL",$J,IEN,0)=" "
"RTN","PSJDGAL2",234,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=55,DIWF=""
"RTN","PSJDGAL2",235,0)
 S PSJPROV="",PSJPROV="N/A - Order Check Not Evaluated by Provider"
"RTN","PSJDGAL2",236,0)
 I $O(^TMP("PSJDAOCD",$J,"AOR",""))]"" S PSJPROV=$O(^TMP("PSJDAOCD",$J,"AOR",""))
"RTN","PSJDGAL2",237,0)
 S X=PSJPROV,FIRST=1 D ^DIWP
"RTN","PSJDGAL2",238,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)=$S(FIRST:"Provider Override Reason: "_^UTILITY($J,"W",1,ZX,0),1:"                          "_^UTILITY($J,"W",1,ZX,0)) S FIRST=0
"RTN","PSJDGAL2",239,0)
 S IEN=$G(IEN)+1,^TMP("PSJAL",$J,IEN,0)=" "
"RTN","PSJDGAL2",240,0)
 ;
"RTN","PSJDGAL2",241,0)
 I $P($G(^ORD(100.05,ZI,8)),"^")="" D  Q
"RTN","PSJDGAL2",242,0)
 .S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)="Pharmacist Intervention Not Entered"
"RTN","PSJDGAL2",243,0)
 K DIC,DR,DIQ,DA,INTY S DIC=9009032.4,DA=$P($G(^ORD(100.05,ZI,8)),"^"),DR=".01;.03;.04;.08",DIQ="INTY" D EN^DIQ1
"RTN","PSJDGAL2",244,0)
 S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)="Intervention Date: "_INTY(9009032.4,DA,.01)
"RTN","PSJDGAL2",245,0)
 S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)="         Provider: "_$S($G(INTY(9009032.4,DA,.03))]"":INTY(9009032.4,DA,.03),1:"Not Entered")
"RTN","PSJDGAL2",246,0)
 S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)="       Pharmacist: "_$S($G(INTY(9009032.4,DA,.04))]"":INTY(9009032.4,DA,.04),1:"Not Entered")
"RTN","PSJDGAL2",247,0)
 S IEN=IEN+1,^TMP("PSJAL",$J,IEN,0)="   Recommendation: "_INTY(9009032.4,DA,.08)
"RTN","PSJDGAL2",248,0)
 K DIC,DR,DIQ,DA,INTY
"RTN","PSJDGAL2",249,0)
 Q
"RTN","PSJDGAL2",250,0)
 ;
"RTN","PSJDGAL2",251,0)
FF ;
"RTN","PSJDGAL2",252,0)
 W !
"RTN","PSJDGAL2",253,0)
 S DIR(0)="E",DIR("A")="Press Return to Continue",DIR("?")="Press Return to Redisplay Rx."
"RTN","PSJDGAL2",254,0)
 D ^DIR S:$D(DUOUT)!($D(DTOUT)) PSJQUIT=1
"RTN","PSJDGAL2",255,0)
 K DIR,DUOUT,DIRUT,DTOUT,L
"RTN","PSJDGAL2",256,0)
 W @IOF
"RTN","PSJDGAL2",257,0)
 Q
"RTN","PSJDGAL2",258,0)
 ;
"RTN","PSJDGAL2",259,0)
FINDC(PSJORD) ;determine if order is part of a complex UD order
"RTN","PSJDGAL2",260,0)
 ;for complex UD orders display format:  orderable item doseform (units) ex: MORPHINE TAB,SA (100MG)
"RTN","PSJDGAL2",261,0)
 Q:PSJORD=""
"RTN","PSJDGAL2",262,0)
 N PSJCOMD,PSJCOI,PSJCU,PSJCDF,PSJCPROS
"RTN","PSJDGAL2",263,0)
 S (PSJCOMD,PSJCOI,PSJCU,PSJCDF,PSJCPROS,PSJNCOM)=""
"RTN","PSJDGAL2",264,0)
 I $G(PSJORD)["P"!($G(PSJORD)["N") D FINDCP
"RTN","PSJDGAL2",265,0)
 E  D FINDCA
"RTN","PSJDGAL2",266,0)
 Q PSJNCOM_"^"_PSJCPROS
"RTN","PSJDGAL2",267,0)
 ;
"RTN","PSJDGAL2",268,0)
FINDCP ;COMPLEX PENDING ORDER
"RTN","PSJDGAL2",269,0)
 S PSJNCOM=+$P($G(^PS(53.1,+PSJORD,.2)),"^",8)
"RTN","PSJDGAL2",270,0)
 I $G(PSJNCOM) D
"RTN","PSJDGAL2",271,0)
 .D GETS^DIQ(53.1,+PSJORD,"108;109","EI","PSJCOMD")
"RTN","PSJDGAL2",272,0)
 .S PSJCU=PSJCOMD(53.1,+PSJORD_",",109,"E"),PSJCOI=PSJCOMD(53.1,+PSJORD_",",108,"E")
"RTN","PSJDGAL2",273,0)
 .I PSJCOI'="" S PSJCDF=$$GET1^DIQ(50.7,$G(PSJCOMD(53.1,+PSJORD_",",108,"I")),.02,"E")
"RTN","PSJDGAL2",274,0)
 .S PSJCPROS=$S(PSJCOI'="":PSJCOI_" "_PSJCDF_" ("_PSJCU_")",1:PROSPECT)
"RTN","PSJDGAL2",275,0)
 Q
"RTN","PSJDGAL2",276,0)
 ;
"RTN","PSJDGAL2",277,0)
FINDCA ;COMPLEX ACTIVE ORDER
"RTN","PSJDGAL2",278,0)
 N PSJCPRSO S PSJCPRSO="",PSJCPRSO=$$GET1^DIQ(55.06,+PSJORD_","_DFN_",",125,"I")
"RTN","PSJDGAL2",279,0)
 Q:PSJCPRSO=""
"RTN","PSJDGAL2",280,0)
 I $D(^PS(55,"ACX",PSJCPRSO)) S PSJNCOM=1 D
"RTN","PSJDGAL2",281,0)
 .D GETS^DIQ(55.06,+PSJORD_","_DFN_",","108;109","IE","PSJCOMD")
"RTN","PSJDGAL2",282,0)
 .S PSJCOI=$G(PSJCOMD(55.06,+PSJORD_","_DFN_",",108,"E")),PSJCU=$G(PSJCOMD(55.06,+PSJORD_","_DFN_",",109,"E"))
"RTN","PSJDGAL2",283,0)
 .I PSJCOI'="" S PSJCDF=$$GET1^DIQ(50.7,$G(PSJCOMD(55.06,+PSJORD_",742,",108,"I")),.02,"E")
"RTN","PSJDGAL2",284,0)
 .S PSJCPROS=$S(PSJCOI'="":PSJCOI_" "_PSJCDF_" ("_PSJCU_")",1:PROSPECT)
"RTN","PSJDGAL2",285,0)
 Q
"RTN","PSJDGCK")
0^10^B20128970
"RTN","PSJDGCK",1,0)
PSJDGCK ;HP/MJE - Drug Interaction Utility ;09/22/11 5:00pm
"RTN","PSJDGCK",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**260,288,281**;16 DEC 97;Build 113
"RTN","PSJDGCK",3,0)
 ;External references to ^PSSDSAPM supported by DBIA 5570
"RTN","PSJDGCK",4,0)
 ;
"RTN","PSJDGCK",5,0)
DGCK ;
"RTN","PSJDGCK",6,0)
 S PSJDGCK=1,PSJDGCKX=1
"RTN","PSJDGCK",7,0)
 D FULL^VALM1
"RTN","PSJDGCK",8,0)
 I $D(PSJDGCK)&($G(VALM("TITLE"))="IV Order Entry") D EN^PSJO1(2)
"RTN","PSJDGCK",9,0)
 I $$DGCKIEN^PSJDGCK()=""!$P($$DGCKIEN^PSJDGCK(),";",2)=0 D
"RTN","PSJDGCK",10,0)
 .W !!,"Not enough active profile drugs to perform drug check",!
"RTN","PSJDGCK",11,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSJDGCK",12,0)
 E  D ^PSGOE7
"RTN","PSJDGCK",13,0)
DGCKEND S VALMBCK="R"
"RTN","PSJDGCK",14,0)
 K PSJDGCK,^TMP($J,"PSJALGDD")
"RTN","PSJDGCK",15,0)
 Q
"RTN","PSJDGCK",16,0)
 ;
"RTN","PSJDGCK",17,0)
DGCKIENX() ;
"RTN","PSJDGCK",18,0)
 ;Where:  PSJDGCK1=STATUS, PSJDGCK2=?, PSJDGCK3=ORDERABLE ITEM, PSJDGCK4=FILE IEN,P PSJDGCK7=DRUG NAME;FILE 50 IEN
"RTN","PSJDGCK",19,0)
 N PSJDGCK7 S PSJDGCK7="" I '$D(^TMP("PSJ",$J)) Q PSJDGCK7
"RTN","PSJDGCK",20,0)
 I $D(PSJDGCK) D
"RTN","PSJDGCK",21,0)
 .N PSJDGCK1,PSJDGCK2,PSJDGCK3,PSJDGCK4,PSJDGCK5,PSJDGCK6 S (PSJDGCK1,PSJDGCK2,PSJDGCK3,PSJDGCK4,PSJDGCK5,PSJDGCK6)=""
"RTN","PSJDGCK",22,0)
 .S PSJDGCK1=$O(^TMP("PSJ",$J,PSJDGCK1)),PSJDGCK2=$O(^TMP("PSJ",$J,PSJDGCK1,PSJDGCK2)),PSJDGCK3=$O(^TMP("PSJ",$J,PSJDGCK1,PSJDGCK2,PSJDGCK3)),PSJDGCK4=$O(^TMP("PSJ",$J,PSJDGCK1,PSJDGCK2,PSJDGCK3,PSJDGCK4))
"RTN","PSJDGCK",23,0)
 .I PSJDGCK4["U" D  K ^TMP($J,"PSJALGDD") Q:$G(PSJDGCKQ)
"RTN","PSJDGCK",24,0)
 ..D PSS431^PSS55(DFN,+PSJDGCK4,"","","PSJALGDD")
"RTN","PSJDGCK",25,0)
 ..S PSJDGCK9="",PSJDGCK9=$G(^TMP($J,"PSJALGDD",+PSJDGCK4,"DDRUG",1,.01)) Q:PSJDGCK9=""
"RTN","PSJDGCK",26,0)
 ..S PSJDGCK7=$P(PSJDGCK9,"^",2)_";"_$P(PSJDGCK9,"^")
"RTN","PSJDGCK",27,0)
 ..I $P(PSJDGCK7,";",2)'="" S PSJDGCKQ=1
"RTN","PSJDGCK",28,0)
 ..S PSJDGCK5=$$GET1^DIQ(55.06,+PSJDGCK4_","_DFN_",",108,"I"),PSJDGCK6=$$DRG^PSSDSAPM(+PSJDGCK5,"I"),PSJDGCK7=$$GET1^DIQ(50,$P(PSJDGCK6,";"),.01,"E")
"RTN","PSJDGCK",29,0)
 .I PSJDGCK4["V" S PSJDGCK5=$$GET1^DIQ(55.01,+PSJDGCK4_","_DFN_",",130,"I"),PSJDGCK6=$$DRG^PSSDSAPM(+PSJDGCK5,"I"),PSJDGCK7=$$GET1^DIQ(50,$P(PSJDGCK6,";"),.01,"E")
"RTN","PSJDGCK",30,0)
 .I PSJDGCK4["P"!(PSJDGCK4["N") S PSJDGCK5=$$GET1^DIQ(53.1,+PSJDGCK4_","_DFN_",",108,"I"),PSJDGCK6=$$DRG^PSSDSAPM(+PSJDGCK5,"I"),PSJDGCK7=$$GET1^DIQ(50,$P(PSJDGCK6,";"),.01,"E")
"RTN","PSJDGCK",31,0)
 .S PSJDGCK7=PSJDGCK7_";"_$P(PSJDGCK6,";")
"RTN","PSJDGCK",32,0)
 Q PSJDGCK7
"RTN","PSJDGCK",33,0)
 ;
"RTN","PSJDGCK",34,0)
PSJSUPCK(CHK) ;
"RTN","PSJDGCK",35,0)
 I $D(PSGDGCKF) Q 0
"RTN","PSJDGCK",36,0)
 I '($P($G(^PSDRUG(CHK,0)),"^",3)["S"!($E($P($G(^PSDRUG(CHK,0)),"^",2),1,2)="XA")) K CHK Q 0
"RTN","PSJDGCK",37,0)
 W !,"You have selected a supply item, please select another drug"
"RTN","PSJDGCK",38,0)
 W !,"or leave blank and hit enter for Profile Order Checks."
"RTN","PSJDGCK",39,0)
 K CHK
"RTN","PSJDGCK",40,0)
 Q 1
"RTN","PSJDGCK",41,0)
 ;
"RTN","PSJDGCK",42,0)
DGCKIEN() ;
"RTN","PSJDGCK",43,0)
 ;Where:  PSJDGCK1=STATUS, PSJDGCK2=?, PSJDGCK3=ORDERABLE ITEM, PSJDGCK4=FILE IEN,P PSJDGCK7=DRUG NAME;FILE 50 IEN
"RTN","PSJDGCK",44,0)
 N PSJDGCK7 S PSJDGCK7="" I '$D(^TMP("PSJ",$J)) Q PSJDGCK7
"RTN","PSJDGCK",45,0)
 N PSJDGCK1,PSJDGCK2,PSJDGCK3,PSJDGCK4,PSJDGCK5,PSJDGCK6,PSJDGCK8 S (PSJDGCK1,PSJDGCK2,PSJDGCK3,PSJDGCK4,PSJDGCK5,PSJDGCK6,PSJDGCK8)="" D
"RTN","PSJDGCK",46,0)
 .F  S PSJDGCK1=$O(^TMP("PSJ",$J,PSJDGCK1)) Q:PSJDGCK1=""!PSJDGCK8  D 
"RTN","PSJDGCK",47,0)
 ..F  S PSJDGCK2=$O(^TMP("PSJ",$J,PSJDGCK1,PSJDGCK2)) Q:PSJDGCK2=""!PSJDGCK8  D
"RTN","PSJDGCK",48,0)
 ...F  S PSJDGCK3=$O(^TMP("PSJ",$J,PSJDGCK1,PSJDGCK2,PSJDGCK3)) Q:PSJDGCK3=""!PSJDGCK8  D
"RTN","PSJDGCK",49,0)
 ....F  S PSJDGCK4=$O(^TMP("PSJ",$J,PSJDGCK1,PSJDGCK2,PSJDGCK3,PSJDGCK4)) Q:PSJDGCK4=""!PSJDGCK8  D
"RTN","PSJDGCK",50,0)
 .....D DGCKIEN2
"RTN","PSJDGCK",51,0)
 K PSJDGCK1,PSJDGCK2,PSJDGCK3,PSJDGCK4,PSJDGCK5,PSJDGCK6,PSJDGCK8
"RTN","PSJDGCK",52,0)
 Q PSJDGCK7
"RTN","PSJDGCK",53,0)
 ;
"RTN","PSJDGCK",54,0)
DGCKIEN2 ;
"RTN","PSJDGCK",55,0)
 N PSJDGCK9,PSJDGCKQ
"RTN","PSJDGCK",56,0)
 I PSJDGCK4["U" D  K ^TMP($J,"PSJALGDD") Q:$G(PSJDGCKQ)
"RTN","PSJDGCK",57,0)
 .D PSS431^PSS55(DFN,+PSJDGCK4,"","","PSJALGDD")
"RTN","PSJDGCK",58,0)
 .;^TMP(543879344,"PSJALGDD",17,"DDRUG",1,.01)="9116^PENICILLIN GK 20 MILLION UNIT VIAL INJ"
"RTN","PSJDGCK",59,0)
 .S PSJDGCK9="",PSJDGCK9=$G(^TMP($J,"PSJALGDD",+PSJDGCK4,"DDRUG",1,.01)) Q:PSJDGCK9=""
"RTN","PSJDGCK",60,0)
 .S PSJDGCK7=$P(PSJDGCK9,"^",2)_";"_$P(PSJDGCK9,"^") K ^TMP($J,"PSJALGDD")
"RTN","PSJDGCK",61,0)
 .I $P(PSJDGCK7,";",2)'="" S PSJDGCKQ=1 Q
"RTN","PSJDGCK",62,0)
 .S PSJDGCK5=$$GET1^DIQ(55.06,+PSJDGCK4_","_DFN_",",108,"I"),PSJDGCK6=$$DRG^PSSDSAPM(+PSJDGCK5,"I"),PSJDGCK7=$$GET1^DIQ(50,$P(PSJDGCK6,";"),.01,"E")
"RTN","PSJDGCK",63,0)
 I PSJDGCK4["V" S PSJDGCK5=$$GET1^DIQ(55.01,+PSJDGCK4_","_DFN_",",130,"I"),PSJDGCK6=$$DRG^PSSDSAPM(+PSJDGCK5,"I"),PSJDGCK7=$$GET1^DIQ(50,$P(PSJDGCK6,";"),.01,"E")
"RTN","PSJDGCK",64,0)
 I PSJDGCK4["P"!(PSJDGCK4["N") S PSJDGCK5=$$GET1^DIQ(53.1,+PSJDGCK4_","_DFN_",",108,"I"),PSJDGCK6=$$DRG^PSSDSAPM(+PSJDGCK5,"I"),PSJDGCK7=$$GET1^DIQ(50,$P(PSJDGCK6,";"),.01,"E")
"RTN","PSJDGCK",65,0)
 S PSJDGCK7=PSJDGCK7_";"_$P(PSJDGCK6,";") I $P(PSJDGCK7,";",2)'=0 S PSJDGCK8=1 Q
"RTN","PSJDGCK",66,0)
 Q
"RTN","PSJGMRA")
0^14^B45646088
"RTN","PSJGMRA",1,0)
PSJGMRA ;BIR/MV - Retrieve and display Allergy data ;6 Jun 07  3:37 PM
"RTN","PSJGMRA",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,270,260,252,257,281**;16 DEC 97;Build 113
"RTN","PSJGMRA",3,0)
 ;
"RTN","PSJGMRA",4,0)
 ; Reference to ^PS(50.605 is supported by DBIA 696.
"RTN","PSJGMRA",5,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSJGMRA",6,0)
 ; Reference to ^TMP("GMRAOC" supported by DBIA 4848.
"RTN","PSJGMRA",7,0)
 ; Reference to GETDATA^GMRAOR supported by DBIA 4847.
"RTN","PSJGMRA",8,0)
 ; Reference to ORCHK2^GMRAOR supported by DBIA 2378.
"RTN","PSJGMRA",9,0)
 ; Reference to ^PSODGAL1 supported by DBIA 5764.
"RTN","PSJGMRA",10,0)
 ; Reference to ^PS(50.7 supported by DBIA 2180.
"RTN","PSJGMRA",11,0)
 ;
"RTN","PSJGMRA",12,0)
EN(DFN,PSJDD) ;
"RTN","PSJGMRA",13,0)
 ;DFN - Patient IEN
"RTN","PSJGMRA",14,0)
 ;PSJDD - ^PSDRUG IEN
"RTN","PSJGMRA",15,0)
 Q:'+$G(DFN)
"RTN","PSJGMRA",16,0)
 Q:'+$G(PSJDD)
"RTN","PSJGMRA",17,0)
 N PTR,GMRAING,PSJACK,PSJCLCNT,PSJFLG,PSJVACL,DIW,DIWF,DIWI,DIWL,DIWR,DIWT,DIWTC,DIWX,PSJNEW,X,Y,PSODRUG,PSODFN,PSJAOC
"RTN","PSJGMRA",18,0)
 K DIC,PSJVACL,^TMP("GMRAOC",$J),^TMP($J,"PSJCLS"),^TMP("PSJDAI",$J)
"RTN","PSJGMRA",19,0)
 S DIC=50,DIC(0)="MQZV",X=PSJDD D ^DIC K DIC Q:Y=-1
"RTN","PSJGMRA",20,0)
 S PSODRUG("IEN")=PSJDD,PSODRUG("VA CLASS")=$P(Y(0),"^",2),PSODRUG("NAME")=$P(Y(0),"^")
"RTN","PSJGMRA",21,0)
 S:+$G(^PSDRUG(+Y,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSJGMRA",22,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSJDD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSJGMRA",23,0)
 ;changed in psj*5*260
"RTN","PSJGMRA",24,0)
 S PSJAOC=1,PSODFN=DFN D ^PSODGAL1
"RTN","PSJGMRA",25,0)
 S:$G(PSGORQF) VALMBCK="R" G END
"RTN","PSJGMRA",26,0)
 ;
"RTN","PSJGMRA",27,0)
 S PSJACK=0
"RTN","PSJGMRA",28,0)
 S PTR=$P($G(^PSDRUG(PSJDD,"ND")),U)_"."_$P($G(^PSDRUG(PSJDD,"ND")),U,3)
"RTN","PSJGMRA",29,0)
 I +PTR S PSJACK=$$NDF()
"RTN","PSJGMRA",30,0)
 S PSJCLCNT=$$CLASS()
"RTN","PSJGMRA",31,0)
 D DISP
"RTN","PSJGMRA",32,0)
END ;
"RTN","PSJGMRA",33,0)
 K ^TMP("GMRAOC",$J),^TMP($J,"PSJCLS")
"RTN","PSJGMRA",34,0)
 Q
"RTN","PSJGMRA",35,0)
NDF() ;Process NDF drug
"RTN","PSJGMRA",36,0)
 NEW PSJLP
"RTN","PSJGMRA",37,0)
 S PSJACK=0
"RTN","PSJGMRA",38,0)
 K ^TMP("GMRAOC",$J)
"RTN","PSJGMRA",39,0)
 S PSJACK=$$ORCHK2^GMRAOR(DFN,"DR",PTR)
"RTN","PSJGMRA",40,0)
 Q PSJACK
"RTN","PSJGMRA",41,0)
CLASS() ;
"RTN","PSJGMRA",42,0)
 NEW PSJLEN,PSJLOC,PSJCLCHK,PSJCLNM,PSJDDCL,INVCL,INVCNT
"RTN","PSJGMRA",43,0)
 S PSJDDCL=$P($G(^PSDRUG(+PSJDD,0)),U,2)
"RTN","PSJGMRA",44,0)
 S PSJLEN=4,PSJCLCNT=0
"RTN","PSJGMRA",45,0)
 I $E(PSJDDCL,1,4)="CN10" S PSJLEN=5 ;look at 5 chars if ANALGESICS
"RTN","PSJGMRA",46,0)
 ;
"RTN","PSJGMRA",47,0)
 K GMRADRCL,^TMP("GMRAOC",$J,"APC"),^TMP($J,"PSJCLS")
"RTN","PSJGMRA",48,0)
 D GETDATA^GMRAOR(DFN)
"RTN","PSJGMRA",49,0)
 I '$D(^TMP("GMRAOC",$J,"APC")) Q 0
"RTN","PSJGMRA",50,0)
 ;
"RTN","PSJGMRA",51,0)
 S PSJVACL="" F  S PSJVACL=$O(^TMP("GMRAOC",$J,"APC",PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",52,0)
 .;*PSJ*5*270 - Check for invalid drug class, print warning message
"RTN","PSJGMRA",53,0)
 . S PSJLOC=^TMP("GMRAOC",$J,"APC",PSJVACL),PSJCLNM=$P($G(^PS(50.605,+$O(^PS(50.605,"B",PSJVACL,0)),0)),U,2)
"RTN","PSJGMRA",54,0)
 . I $G(PSJCLNM)="" S INVCL(PSJVACL)="" Q
"RTN","PSJGMRA",55,0)
 . S PSJVACL(PSJVACL)=PSJVACL_U_PSJCLNM_" ("_PSJLOC_")"
"RTN","PSJGMRA",56,0)
 . S PSJCLCNT=PSJCLCNT+1
"RTN","PSJGMRA",57,0)
 I $D(INVCL) D
"RTN","PSJGMRA",58,0)
 . W $C(7),!!,"WARNING: The following drug class does not exist in the VA DRUG CLASS file",!
"RTN","PSJGMRA",59,0)
 . W "         (#50.605).  Please do a manual Drug-Allergy order check and notify",!
"RTN","PSJGMRA",60,0)
 . W "         the pharmacy ADPAC for follow up.",!
"RTN","PSJGMRA",61,0)
 . S INVCNT="" F  S INVCNT=$O(INVCL(INVCNT)) Q:INVCNT=""  W !,"VA Drug Class: ",INVCNT
"RTN","PSJGMRA",62,0)
 . W ! S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR W !
"RTN","PSJGMRA",63,0)
 ;
"RTN","PSJGMRA",64,0)
 S PSJCLCHK=0,PSJVACL="" F  S PSJVACL=$O(PSJVACL(PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",65,0)
 .I $E(PSJDDCL,1,PSJLEN)=$E(PSJVACL,1,PSJLEN) D
"RTN","PSJGMRA",66,0)
 .. S PSJCLCHK=PSJCLCHK+1
"RTN","PSJGMRA",67,0)
 .. S ^TMP($J,"PSJCLS",PSJCLCHK)=PSJVACL_" "_$P(PSJVACL(PSJVACL),"^",2)
"RTN","PSJGMRA",68,0)
 K ^TMP("GMRAOC",$J)
"RTN","PSJGMRA",69,0)
 Q PSJCLCHK
"RTN","PSJGMRA",70,0)
DISP ;
"RTN","PSJGMRA",71,0)
 NEW PSJLOC,PSJNIEN,PSJNM,PSJVACL,X,PSJX
"RTN","PSJGMRA",72,0)
 S PSJFLG=0
"RTN","PSJGMRA",73,0)
 S PSJX=$O(^TMP("GMRAOC",$J,"APC",""))
"RTN","PSJGMRA",74,0)
 I '$G(PSJACK)&'$G(PSJCLCNT) Q
"RTN","PSJGMRA",75,0)
 S PSJFLG=1
"RTN","PSJGMRA",76,0)
 W $C(7),!!,"A Drug-Allergy Reaction exists for this medication and/or class!"
"RTN","PSJGMRA",77,0)
 W !!,?3,"Drug: "_$P($G(^PSDRUG(PSJDD,0)),"^")
"RTN","PSJGMRA",78,0)
 I PSJACK D
"RTN","PSJGMRA",79,0)
 . S PSJX=""
"RTN","PSJGMRA",80,0)
 . F X=0:0 S X=$O(GMRAING(X)) Q:'X  D
"RTN","PSJGMRA",81,0)
 .. S PSJX=PSJX_$S(PSJX="":"",1:", ")_GMRAING(X)
"RTN","PSJGMRA",82,0)
 . I PSJX]"" W !?6,"Ingredients: " D MYWRITE^PSJMISC(PSJX,19,75)
"RTN","PSJGMRA",83,0)
 D:PSJCLCNT DISPCL
"RTN","PSJGMRA",84,0)
 D:(PSJFLG&'$D(PSJDGCK)) INTERV("ALLERGY")
"RTN","PSJGMRA",85,0)
 Q
"RTN","PSJGMRA",86,0)
DISPCL ;Display class(es)
"RTN","PSJGMRA",87,0)
 NEW PSJX,X
"RTN","PSJGMRA",88,0)
 Q:'$D(^TMP($J,"PSJCLS"))
"RTN","PSJGMRA",89,0)
 S PSJX=""
"RTN","PSJGMRA",90,0)
 S PSJVACL="" F  S PSJVACL=$O(^TMP($J,"PSJCLS",PSJVACL)) Q:PSJVACL=""  D
"RTN","PSJGMRA",91,0)
 . S PSJX=PSJX_$S(PSJX="":"",1:", ")_^TMP($J,"PSJCLS",PSJVACL)
"RTN","PSJGMRA",92,0)
 . S PSJFLG=1
"RTN","PSJGMRA",93,0)
 I PSJX]"" D
"RTN","PSJGMRA",94,0)
 . W !,?6,"Drug Class: "
"RTN","PSJGMRA",95,0)
 . D MYWRITE^PSJMISC(PSJX,19,75)
"RTN","PSJGMRA",96,0)
 Q
"RTN","PSJGMRA",97,0)
 ;
"RTN","PSJGMRA",98,0)
INTERV(PSJRXREQ,PSJDD1) ;Prompt if user to log an intervention for significant interaction
"RTN","PSJGMRA",99,0)
 ;PSPRXREQ - intervention type
"RTN","PSJGMRA",100,0)
 ;PSJDD1 - Prospective drug name
"RTN","PSJGMRA",101,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJGMRA",102,0)
 I $G(PSGORQF)=1 Q
"RTN","PSJGMRA",103,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")=$S($G(PSJRXREQ)="ALLERGY":"YES",1:"NO")
"RTN","PSJGMRA",104,0)
 I $G(PSJDD1)]"" S DIR("A")="Do you want to Intervene with "_PSJDD1_"? "
"RTN","PSJGMRA",105,0)
 W ! D ^DIR
"RTN","PSJGMRA",106,0)
 S DIR("?",1)="Answer 'YES' if you DO want to enter an intervention for this medication,"
"RTN","PSJGMRA",107,0)
 S DIR("?")="       'NO' if you DON'T want to enter an intervention for this medication,"
"RTN","PSJGMRA",108,0)
 I Y S PSGP=DFN D ^PSJRXI W !
"RTN","PSJGMRA",109,0)
 Q 
"RTN","PSJGMRA",110,0)
RINTERV(PSJRXREQ,PSJDD1) ;Prompt user to log an intervention for critical interaction
"RTN","PSJGMRA",111,0)
 ;PSPRXREQ - intervention type
"RTN","PSJGMRA",112,0)
 ;PSJDD1 - Prospective drug name
"RTN","PSJGMRA",113,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJGMRA",114,0)
 K PSGORQF
"RTN","PSJGMRA",115,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="NO"
"RTN","PSJGMRA",116,0)
 I $G(PSJDD1)]"" S DIR("A")="Do you want to Continue with "_PSJDD1_"? "
"RTN","PSJGMRA",117,0)
 S DIR("?",1)="Enter 'NO' if you wish to exit without continuing with the order,",DIR("?")="or 'YES' to continue with the order entry process."
"RTN","PSJGMRA",118,0)
 D ^DIR
"RTN","PSJGMRA",119,0)
 I 'Y S PSGORQF=1 S VALMBCK="R" Q
"RTN","PSJGMRA",120,0)
 I Y S PSGP=DFN D ^PSJRXI W !
"RTN","PSJGMRA",121,0)
 Q
"RTN","PSJGMRA",122,0)
 ;
"RTN","PSJGMRA",123,0)
INST(PSJALCO) ;Find Institution for order
"RTN","PSJGMRA",124,0)
 N PSJALCR,PSJALCMC,PSJALCCL,PSJALCWA,PSJALCIV,PSJALCIN,PSJALCND,PSJALCP1,PSJALCP2
"RTN","PSJGMRA",125,0)
 I PSJALCO="" Q +$$SITE^VASITE(DT)
"RTN","PSJGMRA",126,0)
 S PSJALCR=""
"RTN","PSJGMRA",127,0)
 ;
"RTN","PSJGMRA",128,0)
 I PSJALCO["P" D  G INSTM
"RTN","PSJGMRA",129,0)
 .S PSJALCCL=$P($G(^PS(53.1,+PSJALCO,"DSS")),"^") I PSJALCCL S PSJALCND=$G(^SC(PSJALCCL,0)) D  Q
"RTN","PSJGMRA",130,0)
 ..S PSJALCIN=$P(PSJALCND,"^",4) I PSJALCIN S PSJALCR=PSJALCIN Q
"RTN","PSJGMRA",131,0)
 ..S PSJALCMC=$P(PSJALCND,"^",15)
"RTN","PSJGMRA",132,0)
 .S PSJALCIV=$P($G(^PS(53.1,+PSJALCO,8)),"^",8) I PSJALCIV D  Q
"RTN","PSJGMRA",133,0)
 ..S PSJALCMC=$P($G(^PS(59.5,+PSJALCIV,0)),"^",4) Q
"RTN","PSJGMRA",134,0)
 .D INSTW
"RTN","PSJGMRA",135,0)
 ;
"RTN","PSJGMRA",136,0)
 I PSJALCO["U" S PSJALCP1=$P(PSJALCO,"U"),PSJALCP2=$P(PSJALCO,"U",2) D  G INSTM
"RTN","PSJGMRA",137,0)
 .S PSJALCCL=$P($G(^PS(55,PSJALCP1,5,PSJALCP2,8)),"^") I PSJALCCL S PSJALCND=$G(^SC(PSJALCCL,0)) D  Q
"RTN","PSJGMRA",138,0)
 ..S PSJALCIN=$P(PSJALCND,"^",4) I PSJALCIN S PSJALCR=PSJALCIN Q
"RTN","PSJGMRA",139,0)
 ..S PSJALCMC=$P(PSJALCND,"^",15)
"RTN","PSJGMRA",140,0)
 .D INSTW
"RTN","PSJGMRA",141,0)
 ;
"RTN","PSJGMRA",142,0)
 I PSJALCO["V" S PSJALCP1=$P(PSJALCO,"V"),PSJALCP2=$P(PSJALCO,"V",2) D  G INSTM
"RTN","PSJGMRA",143,0)
 .S PSJALCCL=$P($G(^PS(55,PSJALCP1,"IV",PSJALCP2,"DSS")),"^") I PSJALCCL S PSJALCND=$G(^SC(PSJALCCL,0)) D  Q
"RTN","PSJGMRA",144,0)
 ..S PSJALCIN=$P(PSJALCND,"^",4) I PSJALCIN S PSJALCR=PSJALCIN Q
"RTN","PSJGMRA",145,0)
 ..S PSJALCMC=$P(PSJALCND,"^",15)
"RTN","PSJGMRA",146,0)
 .S PSJALCIV=$P($G(^PS(55,PSJALCP1,"IV",PSJALCP2,2)),"^",2) I PSJALCIV D  Q
"RTN","PSJGMRA",147,0)
 ..S PSJALCMC=$P($G(^PS(59.5,+PSJALCIV,0)),"^",4) Q
"RTN","PSJGMRA",148,0)
 .D INSTW
"RTN","PSJGMRA",149,0)
 ;
"RTN","PSJGMRA",150,0)
 Q +$$SITE^VASITE(DT)
"RTN","PSJGMRA",151,0)
INSTM ;
"RTN","PSJGMRA",152,0)
 I PSJALCR Q PSJALCR
"RTN","PSJGMRA",153,0)
 I $G(PSJALCMC) Q +$$SITE^VASITE(DT,PSJALCMC)
"RTN","PSJGMRA",154,0)
 Q +$$SITE^VASITE(DT)
"RTN","PSJGMRA",155,0)
 ;
"RTN","PSJGMRA",156,0)
INSTW ;
"RTN","PSJGMRA",157,0)
 S PSJALCWA=$$INSTV I PSJALCWA D
"RTN","PSJGMRA",158,0)
 .S PSJALCCL=$P($G(^DIC(42,+PSJALCWA,44)),"^") I PSJALCCL D  Q:PSJALCR
"RTN","PSJGMRA",159,0)
 ..S PSJALCND=$G(^SC(PSJALCCL,0)) S PSJALCIN=$P(PSJALCND,"^",4) I PSJALCIN S PSJALCR=PSJALCIN Q
"RTN","PSJGMRA",160,0)
 ..S PSJALCMC=$P(PSJALCND,"^",15)
"RTN","PSJGMRA",161,0)
 .I '$G(PSJALCMC) S PSJALCMC=$P($G(^DIC(42,+PSJALCWA,0)),"^",11)
"RTN","PSJGMRA",162,0)
 Q
"RTN","PSJGMRA",163,0)
 ;
"RTN","PSJGMRA",164,0)
INSTV() ;Retrieve Ward
"RTN","PSJGMRA",165,0)
 I '$G(DFN) Q 0
"RTN","PSJGMRA",166,0)
 N VAHOW,VAROOT,VAINDT,VAIN,VAERR
"RTN","PSJGMRA",167,0)
 D INP^VADPT
"RTN","PSJGMRA",168,0)
 Q +$G(VAIN(4))
"RTN","PSJHL3")
0^22^B97470088
"RTN","PSJHL3",1,0)
PSJHL3 ;BIR/RLW - PHARMACY ORDER SEGMENTS ; 8/19/14 2:08pm
"RTN","PSJHL3",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**1,11,14,40,42,47,50,56,58,92,101,102,123,110,111,152,134,226,267,260,281**;16 DEC 97;Build 113
"RTN","PSJHL3",3,0)
 ;
"RTN","PSJHL3",4,0)
 ; Reference to ^PS(50.606 is supported by DBIA# 2174.
"RTN","PSJHL3",5,0)
 ; Reference to ^PS(50.607 is supported by DBIA# 2221.        
"RTN","PSJHL3",6,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180.
"RTN","PSJHL3",7,0)
 ; Reference to ^PS(51.2 is supported by DBIA# 2178.
"RTN","PSJHL3",8,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJHL3",9,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJHL3",10,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL3",11,0)
 ; Reference to ^PSDRUG( is supported by DBIA# 2192.
"RTN","PSJHL3",12,0)
 ; Reference to ^PSNDF( is supported by DBIA# 2195.
"RTN","PSJHL3",13,0)
 ; Reference to ^VA(200 is supported by DBIA# 10060.
"RTN","PSJHL3",14,0)
 ; Reference to ^PSNAPIS is supported by DBIA# 2531.
"RTN","PSJHL3",15,0)
 ; Reference to ^XLFDT is supported by DBIA# 10103.
"RTN","PSJHL3",16,0)
 ; Reference to ^PSSUTIL1 is supported by DBIA# 3179.
"RTN","PSJHL3",17,0)
 ; Reference to ^ORHLESC is supported by DBIA# 4922.
"RTN","PSJHL3",18,0)
 ;
"RTN","PSJHL3",19,0)
 ;*267 Change NTE|21 so it can send over the Long Wp Special Inst/
"RTN","PSJHL3",20,0)
 ;     Other Prt Info fields if populated.
"RTN","PSJHL3",21,0)
 ;
"RTN","PSJHL3",22,0)
EN1(PSJHLDFN,PSOC,PSJORDER) ; start here
"RTN","PSJHL3",23,0)
 ; passed in are PSJHLDFN (patient ien)
"RTN","PSJHL3",24,0)
 ;               PSJORDER (file root of order)
"RTN","PSJHL3",25,0)
 ;               OC (order control code - NW for new order, OK for finished order, OC for order canceled)
"RTN","PSJHL3",26,0)
 I $G(PSJHLDFN)']""!$G(PSOC)']""!$G(PSJORDER)']"" W !,"INSUFFICIENT DATA FOR ^PSJHL3" Q
"RTN","PSJHL3",27,0)
 N COMMENTS,DDIEA,DDNUM,DOSE,DOSEFORM,DOSEOR,NAME,DURATION,IVTYPE,NODE1,NODE2,NDNODE,OINODE,PSGPLS,PSGPLF,PRODNAME,SPDIEN,UNIT,UNITS,CNT,DDIEN,SCHEDULE,PSGST
"RTN","PSJHL3",28,0)
 D INIT
"RTN","PSJHL3",29,0)
 S IVTYPE=$S(RXORDER["U":"",1:$$IVTYPE^PSJHLU(PSJORDER))
"RTN","PSJHL3",30,0)
 D RXO,RXE,RXR D ZRX
"RTN","PSJHL3",31,0)
 D CALL^PSJHLU(PSJI)
"RTN","PSJHL3",32,0)
 ;PSJ*5*260 ADDED ALLERGY SETS HERE AND PSJ*5*281 MOVED ALLERGY SETS TO SETOC^PSJNEWOC
"RTN","PSJHL3",33,0)
 Q
"RTN","PSJHL3",34,0)
INIT ; initialize HL7 variables
"RTN","PSJHL3",35,0)
 D INIT^PSJHLU
"RTN","PSJHL3",36,0)
 Q
"RTN","PSJHL3",37,0)
RXO ; pharmacy prescription order segment (used to send Orderable Item to OE/RR)
"RTN","PSJHL3",38,0)
 S LIMIT=17 X PSJCLEAR
"RTN","PSJHL3",39,0)
 S FIELD(0)="RXO"
"RTN","PSJHL3",40,0)
 S OINODE=$G(@(PSJORDER_".2)"))
"RTN","PSJHL3",41,0)
 S SPDIEN=+$P(OINODE,"^"),DOSEOR=$$UP^XLFSTR($$ESC^ORHLESC($P(OINODE,"^",2))),DOSE=$P(OINODE,"^",5),UNIT=$P(OINODE,"^",6) S:'$G(PSJBCBU) UNIT=$$ESC^ORHLESC(UNIT)
"RTN","PSJHL3",42,0)
 S FIELD(1)=$S(SPDIEN=0:"^^^^",1:"^^^"_SPDIEN_"^")
"RTN","PSJHL3",43,0)
 I SPDIEN S DOSEFORM=$P($G(^PS(50.7,SPDIEN,0)),"^",2),NAME=$P($G(^PS(50.606,+DOSEFORM,0)),"^") S:'$G(PSJBCBU) NAME=$$ESC^ORHLESC(NAME) S FIELD(1)=FIELD(1)_$$ESC^ORHLESC($P($G(^PS(50.7,SPDIEN,0)),"^"))_" "_NAME
"RTN","PSJHL3",44,0)
 S FIELD(1)=FIELD(1)_"^99PSP"
"RTN","PSJHL3",45,0)
 N IVLNOD S IVLNOD=$G(@(PSJORDER_"2.5)")) D
"RTN","PSJHL3",46,0)
 .S IVLIM=$P(IVLNOD,"^",4) I IVLIM?1"a".N S IVLIM="doses"_$P(IVLIM,"a",2)
"RTN","PSJHL3",47,0)
 .S $P(FIELD(1),"^",3)=IVLIM
"RTN","PSJHL3",48,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY^PSJHL2
"RTN","PSJHL3",49,0)
 Q
"RTN","PSJHL3",50,0)
RXE ; pharmacy encoded order segment
"RTN","PSJHL3",51,0)
 NEW PSJF1P1
"RTN","PSJHL3",52,0)
 S (UNITS,NDNODE,SPDIEN,PRODNAME,DDNUM,DDIEN,CNT)="",LIMIT=26 X PSJCLEAR
"RTN","PSJHL3",53,0)
 S FIELD(0)="RXE"
"RTN","PSJHL3",54,0)
 S NODE1=$G(@(PSJORDER_"0)")),NODE2=$G(@(PSJORDER_"2)")),NODEPT2=$G(@(PSJORDER_".2)"))
"RTN","PSJHL3",55,0)
 I $G(PSGST)="" N PSGST D
"RTN","PSJHL3",56,0)
 .I $G(RXORDER)["V" N X,ZZND,LYN,PSGS0XT,PSGS0Y,PSGOES S PSGOES=1 S X=$G(P(9)) I X]"" D EN^PSGS0 S:$G(ZZND)'="" PSGST=$P(ZZND,"^",5) Q
"RTN","PSJHL3",57,0)
 .S PSGST=$P($G(NODE1),"^",7)
"RTN","PSJHL3",58,0)
 I RXORDER["V" D IVRXE Q
"RTN","PSJHL3",59,0)
 I RXORDER["P",IVTYPE="F" D IVRXE Q
"RTN","PSJHL3",60,0)
 I RXORDER["P",$P(NODE1,"^",4)="H" D IVRXE Q
"RTN","PSJHL3",61,0)
 N RENEW S RENEW=$$LASTREN^PSJLMPRI(PSJHLDFN,RXORDER)
"RTN","PSJHL3",62,0)
 S PSGPLS=$S($G(PSJEXPOE):$P(NODE2,"^",2),RENEW>$P(NODE2,"^",2):RENEW,1:$P(NODE2,"^",2))
"RTN","PSJHL3",63,0)
 S PSGPLF=$S($G(PSJEXPOE):PSJEXPOE,1:$P(NODE2,"^",4))
"RTN","PSJHL3",64,0)
 S FIELD(1)="^"_$S($G(PSJBCBU):$P(NODE2,"^"),1:$$ESC^ORHLESC($P(NODE2,"^")))_"&"_$P(NODE2,"^",5)_"^^"_$$FMTHL7^XLFDT(PSGPLS)_"^"_$$FMTHL7^XLFDT(PSGPLF)_"^"_$P($G(NODEPT2),"^",4)_"^"_$G(PSGST)
"RTN","PSJHL3",65,0)
 S FIELD(21)="^"_$P(NODE2,"^",5)_"^99PSA^^^"
"RTN","PSJHL3",66,0)
 I ($G(DOSEOR)']"")!($O(@(PSJORDER_"1,"" "")"),-1)=1) D
"RTN","PSJHL3",67,0)
 .S (CNT,DDNUM)=0 F  S DDNUM=$O(@(PSJORDER_"1,"_DDNUM_")")) Q:'DDNUM  Q:CNT=1  S DDIEN=+$G(@(PSJORDER_"1,"_DDNUM_",0)")) D
"RTN","PSJHL3",68,0)
 ..S PSJF1P1=$S($P(@(PSJORDER_"1,"_DDNUM_",0)"),"^",2)="":"1",1:$P(@(PSJORDER_"1,"_DDNUM_",0)"),"^",2))
"RTN","PSJHL3",69,0)
 ..S:DOSE]"" FIELD(1)=DOSE_"&"_UNIT_"&"_PSJF1P1_"&"_FIELD(1)
"RTN","PSJHL3",70,0)
 ..S:DOSE="" FIELD(1)=$$FINDDOSE(DDIEN,PSJF1P1,DOSEOR)_FIELD(1)
"RTN","PSJHL3",71,0)
 ..S $P(FIELD(1),"^",8)=$S($G(DOSEOR)]"":$G(DOSEOR),1:"DOSAGE NOT FOUND")
"RTN","PSJHL3",72,0)
 ..S:$P(FIELD(1),"^",8)="" $P(FIELD(1),"^",8)=$$ESC^ORHLESC($G(@(PSJORDER_".3)")))
"RTN","PSJHL3",73,0)
 ..S NDNODE=$G(^PSDRUG(DDIEN,"ND"))
"RTN","PSJHL3",74,0)
 ..;  CHANGE FOR NEW NDF CALL
"RTN","PSJHL3",75,0)
 ..S PRODNAME=$S($T(^PSNAPIS)]"":$$PROD0^PSNAPIS(+NDNODE,$P(NDNODE,"^",3)),$G(^PSNDF(+NDNODE,5,+$P(NDNODE,"^",3),0))]"":^(0),1:"N/A")
"RTN","PSJHL3",76,0)
 ..S:PRODNAME="" PRODNAME="N/A"
"RTN","PSJHL3",77,0)
 ..S FIELD(2)=$S(PRODNAME="N/A":"^^",1:+NDNODE_"."_+$P(NDNODE,"^",3)_"^"_$P(NDNODE,"^",2)_"^"_"99NDF")_"^"_DDIEN_"^"_$S($G(PSJBCBU):$P($G(^PSDRUG(DDIEN,0)),"^"),1:$$ESC^ORHLESC($P($G(^PSDRUG(DDIEN,0)),"^")))_"^"_"99PSD"
"RTN","PSJHL3",78,0)
 ..S UNITS=$S(PRODNAME="N/A":"N/A",1:$S($T(^PSNAPIS)]"":$P($$DFSU^PSNAPIS(+NDNODE,$P(NDNODE,"^",3)),"^",5),1:$P($G(^PSNDF(+NDNODE,2,+$P(PRODNAME,"^",2),3,+$P(PRODNAME,"^",3),4,+$P(PRODNAME,"^",4),0)),"^")))
"RTN","PSJHL3",79,0)
 ..S FIELD(5)="^^^"_$$ESC^ORHLESC(UNITS)_"^"_$$ESC^ORHLESC($P($G(^PS(50.607,UNITS,0)),"^"))_"^99PSU"
"RTN","PSJHL3",80,0)
 ..S FIELD(6)="^^^"_$$ESC^ORHLESC($G(DOSEFORM))_"^"_$$ESC^ORHLESC($P($G(^PS(50.606,+$G(DOSEFORM),0)),"^"))_"^99PSF"
"RTN","PSJHL3",81,0)
 ..S FIELD(25)=$$EN^PSSUTIL1(DDIEN),FIELD(26)=$P(FIELD(25),"|",2),FIELD(25)=$P(FIELD(25),"|")
"RTN","PSJHL3",82,0)
 ..I $P(FIELD(25),"^",5)]"" S $P(FIELD(25),"^",5)=$$ESC^ORHLESC($P(FIELD(25),"^",5))
"RTN","PSJHL3",83,0)
 ..S CNT=CNT+1
"RTN","PSJHL3",84,0)
 E  S $P(FIELD(1),"^",8)=$$ESC^ORHLESC(DOSEOR)
"RTN","PSJHL3",85,0)
 S NAME=$P($G(^VA(200,DUZ,0)),"^") S:'$G(PSJBCBU) NAME=$$ESC^ORHLESC(NAME) S FIELD(14)=DUZ_"^"_NAME_"^"_"99NP"
"RTN","PSJHL3",86,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY^PSJHL2
"RTN","PSJHL3",87,0)
 D SEGMENT2^PSJHLU
"RTN","PSJHL3",88,0)
 Q
"RTN","PSJHL3",89,0)
IVRXE ; RXE segment for IV orders
"RTN","PSJHL3",90,0)
 ; If an Inpatient Med IV order, send RXE w/dispense drug info.  
"RTN","PSJHL3",91,0)
 ; If an IV FLUID order, send start/stop date and duration in the RXE
"RTN","PSJHL3",92,0)
 ; and send an RXC for each additive and solution.
"RTN","PSJHL3",93,0)
 N ADSNODE,PSJRENEW S PSJRENEW=$$LASTREN^PSJLMPRI(PSJHLDFN,RXORDER)
"RTN","PSJHL3",94,0)
 I RXORDER["V" S PSGPLS=$S($G(PSJEXPOE):$P(NODE1,"^",2),PSJRENEW>$P(NODE1,"^",2):PSJRENEW,1:$P(NODE1,"^",2)),PSGPLF=$S($G(PSJEXPOE):PSJEXPOE,1:$P(NODE1,"^",3))
"RTN","PSJHL3",95,0)
 E  S PSGPLS=$P(NODE2,"^",2),PSGPLF=$P(NODE2,"^",4)
"RTN","PSJHL3",96,0)
 S FIELD(1)="^"_$S(PSJORDER["IV":($P(NODE1,"^",9)_"&"_$P(NODE1,"^",11)),1:$P(NODE2,"^"))_"^^"_$$FMTHL7^XLFDT(PSGPLS)_"^"_$$FMTHL7^XLFDT(PSGPLF)_"^"_$G(P("PRY"))
"RTN","PSJHL3",97,0)
 S FIELD(21)="^"_$S(PSJORDER["IV":$P(NODE1,"^",11),1:$P(NODE2,"^",5))_"^99PSA^^^"
"RTN","PSJHL3",98,0)
 S NAME=$P($G(^VA(200,DUZ,0)),"^") S:'$G(PSJBCBU) NAME=$$ESC^ORHLESC(NAME)
"RTN","PSJHL3",99,0)
 S FIELD(14)=DUZ_"^"_NAME_"^"_"99NP"
"RTN","PSJHL3",100,0)
 N X,Y
"RTN","PSJHL3",101,0)
 I RXORDER["V" S INFUSE=$P(NODE1,"^",8)
"RTN","PSJHL3",102,0)
 E  S INFUSE=$P($G(@(PSJORDER_"8)")),"^",5)
"RTN","PSJHL3",103,0)
 I INFUSE?1N.N1" ml/hr" S FIELD(23)=+INFUSE,Y=$P(INFUSE,+INFUSE,2),Y=$$TRIM^XLFSTR(Y,"LR"," "),FIELD(24)="^^^^"_Y_"^PSU"
"RTN","PSJHL3",104,0)
 I FIELD(23)="",FIELD(24)="" S FIELD(23)=INFUSE
"RTN","PSJHL3",105,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY^PSJHL2
"RTN","PSJHL3",106,0)
 K SEGMENT I RXORDER["V" S JJ=0 F  S JJ=$O(@(PSJORDER_"5,"_JJ_")")) Q:'JJ  S SEGMENT(JJ-1)=$S($G(PSJBCBU):$G(@(PSJORDER_"5,"_JJ_",0)")),1:$$ESC^ORHLESC($G(@(PSJORDER_"5,"_JJ_",0)"))))
"RTN","PSJHL3",107,0)
 E  S JJ=0 F  S JJ=$O(@(PSJORDER_"12,"_JJ_")")) Q:'JJ  S SEGMENT(JJ-1)=$S($G(PSJBCBU):$G(@(PSJORDER_"12,"_JJ_",0)")),1:$G(@(PSJORDER_"12,"_JJ_",0)")))
"RTN","PSJHL3",108,0)
 I $D(SEGMENT(0)) S SEGMENT(0)="NTE|6|L|"_SEGMENT(0) D
"RTN","PSJHL3",109,0)
 .D SET^PSJHLU K SEGMENT,JJ
"RTN","PSJHL3",110,0)
 ;build NTE 21 with Special Inst/Other Prt Info Wp fields     *267
"RTN","PSJHL3",111,0)
 N QQ K ^TMP("PSJBCMA5",$J)
"RTN","PSJHL3",112,0)
 D GETSIOPI^PSJBCMA5(PSJHLDFN,RXORDER,1) I ($G(^TMP("PSJBCMA5",$J,PSJHLDFN,RXORDER,1))["Instructions too long. See Order View or BCMA for full text"),($G(PSJORD)["P"),($G(RXORDER)["V") D
"RTN","PSJHL3",113,0)
 .N OPIAL,OPIALFLG S OPIAL=0,OPIALFLG=0 F  S OPIAL=$O(^PS(55,PSJHLDFN,"IV",+RXORDER,"A",OPIAL)) Q:'OPIAL  I ($G(^PS(55,PSJHLDFN,"IV",+RXORDER,"A",OPIAL,1,1,0))["OTHER PRINT INFO") S OPIALFLG=1
"RTN","PSJHL3",114,0)
 .Q:$P($G(^PS(55,PSJHLDFN,"IV",+RXORDER,2)),"^",8)'="N"!$G(OPIALFLG)  D GETSIOPI^PSJBCMA5(PSJHLDFN,PSJORD,1)
"RTN","PSJHL3",115,0)
 .N LINES,TEXT1 S LINES=($G(^TMP("PSJBCMA5",$J,PSJHLDFN,PSJORD))),TEXT1=$G(^TMP("PSJBCMA5",$J,PSJHLDFN,PSJORD,1))
"RTN","PSJHL3",116,0)
 .Q:LINES<1!(LINES=1&(TEXT1'["Instructions too long. See Order View or BCMA for full text"))
"RTN","PSJHL3",117,0)
 .K ^TMP("PSJBCMA5",$J,PSJHLDFN,RXORDER) M ^TMP("PSJBCMA5",$J,PSJHLDFN,RXORDER)=^TMP("PSJBCMA5",$J,PSJHLDFN,PSJORD) K ^TMP("PSJBCMA5",$J,PSJHLDFN,PSJORD)
"RTN","PSJHL3",118,0)
 I RXORDER["V"!(RXORDER["U") I ($G(PSJORD)["P"),($P($G(^PS(53.1,+PSJORD,0)),"^",25)=RXORDER) D
"RTN","PSJHL3",119,0)
 .D GETSIOPI^PSJBCMA5(PSJHLDFN,PSJORD,1)
"RTN","PSJHL3",120,0)
 .N LINES,TEXT1 S LINES=($G(^TMP("PSJBCMA5",$J,PSJHLDFN,PSJORD))),TEXT1=$G(^TMP("PSJBCMA5",$J,PSJHLDFN,PSJORD,1))
"RTN","PSJHL3",121,0)
 .Q:LINES<1!(LINES=1&(TEXT1["Instructions too long. See Order View or BCMA for full text"))
"RTN","PSJHL3",122,0)
 .K ^TMP("PSJBCMA5",$J,PSJHLDFN,RXORDER) M ^TMP("PSJBCMA5",$J,PSJHLDFN,RXORDER)=^TMP("PSJBCMA5",$J,PSJHLDFN,PSJORD) K ^TMP("PSJBCMA5",$J,PSJHLDFN,PSJORD)
"RTN","PSJHL3",123,0)
 F QQ=0:0 S QQ=$O(^TMP("PSJBCMA5",$J,PSJHLDFN,RXORDER,QQ)) Q:'QQ  D
"RTN","PSJHL3",124,0)
 .I QQ=1 S SEGMENT(0)="NTE|21|L|"_$$ESC^ORHLESC(^TMP("PSJBCMA5",$J,PSJHLDFN,RXORDER,QQ)) S:$G(PSJBCBU) SEGMENT(0)=SEGMENT(0)_"\.br\" Q
"RTN","PSJHL3",125,0)
 .S SEGMENT(QQ-1)=$$ESC^ORHLESC(^TMP("PSJBCMA5",$J,PSJHLDFN,RXORDER,QQ))
"RTN","PSJHL3",126,0)
 .I $G(PSJBCBU) S SEGMENT(QQ-1)=SEGMENT(QQ-1)_"\.br\"
"RTN","PSJHL3",127,0)
 I RXORDER["V",'$D(SEGMENT(0)) N OPIHDR S OPIHDR=$D(^PS(55,PSJHLDFN,"IV",+RXORDER,10,0)) I $P(OPIHDR,"^",2),'$P(OPIHDR,"^",3) S SEGMENT(0)="NTE|21|L|"
"RTN","PSJHL3",128,0)
 I $D(SEGMENT(0)) D SET^PSJHLU K SEGMENT,^TMP("PSJBCMA5",$J)
"RTN","PSJHL3",129,0)
 ;end   *267
"RTN","PSJHL3",130,0)
RXC ;component segments
"RTN","PSJHL3",131,0)
 N ADDITIVE,SOLUTION,SUB,TYPE,AD,SOL,PTR,NUM,UTMP,XTMP
"RTN","PSJHL3",132,0)
 S LIMIT=24 X PSJCLEAR
"RTN","PSJHL3",133,0)
 S FIELD(0)="RXC"
"RTN","PSJHL3",134,0)
 ; In the line below, the naked reference refers to the full global reference represented in PSJORDER_TYPE...
"RTN","PSJHL3",135,0)
 ; This could be a reference to either ^PS(53.1 or ^PS(55
"RTN","PSJHL3",136,0)
 S AD="AD",SOL="SOL" F TYPE="AD","SOL" S SUB=0 F  S SUB=$O(@(PSJORDER_TYPE_","_SUB_")")) Q:SUB=""  S NODE1=$G(^(SUB,0)) Q:NODE1=""  D
"RTN","PSJHL3",137,0)
 .S FIELD(1)=$S(TYPE="AD":"A",1:"B")
"RTN","PSJHL3",138,0)
 .I FIELD(1)="A",($P(NODE1,U,3)="") S $P(NODE1,U,3)="A"
"RTN","PSJHL3",139,0)
 .S PTR=+$S(TYPE="AD":+$P($G(^PS(52.6,$P(NODE1,"^"),0)),"^",11),1:+$P($G(^PS(52.7,$P(NODE1,"^"),0)),"^",11))
"RTN","PSJHL3",140,0)
 .S FIELD(2)="^^^"_$S($G(PSJBCBU):+$P(NODE1,"^"),1:PTR)_"^"_$S($G(PSJBCBU):$S(TYPE="AD":$P($G(^PS(52.6,+$P(NODE1,"^"),0)),"^"),1:$P($G(^PS(52.7,+$P(NODE1,"^"),0)),"^")_" "_$P($G(^(0)),U,4)),1:$P($G(^PS(50.7,PTR,0)),"^"))
"RTN","PSJHL3",141,0)
 .S:(TYPE="AD"&$G(PSJBCBU)) FIELD(2)=FIELD(2)_$S($P(NODE1,"^",3)]"":" BOTTLE: "_$P(NODE1,"^",3),1:"")
"RTN","PSJHL3",142,0)
 .S FIELD(2)=FIELD(2)_"^99PSP"
"RTN","PSJHL3",143,0)
 .S FIELD(3)=$P($P(NODE1,"^",2)," ")
"RTN","PSJHL3",144,0)
 .S FIELD(4)=$P($P(NODE1,"^",2)," ",2)
"RTN","PSJHL3",145,0)
 .S FIELD(5)=$P(NODE1,"^",3)
"RTN","PSJHL3",146,0)
 .F XTMP=1:1:14 S UTMP($P("ML^LITER^MCG^MG^GM^UNITS^IU^MEQ^MM^MU^THOUU^MG-PE^NANOGRAM^MMOL","^",XTMP))="PSIV-"_XTMP
"RTN","PSJHL3",147,0)
 .S NUM="" S:FIELD(4)'="" NUM=$G(UTMP(FIELD(4)))
"RTN","PSJHL3",148,0)
 .S FIELD(4)="^^^"_NUM_"^"_FIELD(4)_"^99OTH"
"RTN","PSJHL3",149,0)
 .D SEGMENT^PSJHLU(LIMIT),DISPLAY^PSJHL2
"RTN","PSJHL3",150,0)
 Q
"RTN","PSJHL3",151,0)
RXR ; med route segment
"RTN","PSJHL3",152,0)
 S LIMIT=4 X PSJCLEAR
"RTN","PSJHL3",153,0)
 S FIELD(0)="RXR"
"RTN","PSJHL3",154,0)
 I PSJORDER["IV" S FIELD(1)="^^^"_$P($G(@(PSJORDER_".2)")),"^",3) Q:$P(FIELD(1),U,4)=""  D
"RTN","PSJHL3",155,0)
 .N PSJUNITS S PSJUNITS=$S($G(PSJBCBU):$P($G(^PS(51.2,+$P(FIELD(1),"^",4),0)),"^"),1:$$ESC^ORHLESC($P($G(^PS(51.2,+$P(FIELD(1),"^",4),0)),"^")))
"RTN","PSJHL3",156,0)
 .S FIELD(1)=FIELD(1)_"^"_PSJUNITS_"^99PSR"
"RTN","PSJHL3",157,0)
 .S:$G(PSJBCBU) FIELD(4)="^^^"_$P($G(@(PSJORDER_"0)")),"^",4)_"^"_$$CODES^PSIVUTL($P($G(@(PSJORDER_"0)")),"^",4),55.01,.04)_"^99PSR"
"RTN","PSJHL3",158,0)
 I PSJORDER[53.1 S FIELD(1)="^^^"_$P($G(@(PSJORDER_"0)")),"^",3) Q:$P(FIELD(1),U,4)=""  D
"RTN","PSJHL3",159,0)
 .N PSJUNITS S PSJUNITS=$S($G(PSJBCBU):$P($G(^PS(51.2,+$P(FIELD(1),"^",4),0)),"^"),1:$$ESC^ORHLESC($P($G(^PS(51.2,+$P(FIELD(1),"^",4),0)),"^")))
"RTN","PSJHL3",160,0)
 .S FIELD(1)=FIELD(1)_"^"_PSJUNITS_"^99PSR"
"RTN","PSJHL3",161,0)
 .S:$G(PSJBCBU) FIELD(4)="^^^"_$P($G(@(PSJORDER_"0)")),"^",4)_"^"_$$CODES^PSIVUTL($P($G(@(PSJORDER_"0)")),"^",4),53.1,4)_"^99PSR"
"RTN","PSJHL3",162,0)
 S:FIELD(1)="" FIELD(1)="^^^"_$P(NODE1,"^",3)_"^"_$S($G(PSJBCBU):$P($G(^PS(51.2,+$P(NODE1,"^",3),0)),"^"),1:$$ESC^ORHLESC($P($G(^PS(51.2,+$P(NODE1,"^",3),0)),"^")))_"^99PSR"
"RTN","PSJHL3",163,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY^PSJHL2
"RTN","PSJHL3",164,0)
 Q
"RTN","PSJHL3",165,0)
ZRX ; pharmacy Z-segment
"RTN","PSJHL3",166,0)
 D ZRX^PSJHLU
"RTN","PSJHL3",167,0)
 Q
"RTN","PSJHL3",168,0)
CNT ;Count dispense drugs for an order
"RTN","PSJHL3",169,0)
 S (CNT,DDNUM)=0 F  S DDNUM=$O(@(PSJORDER_"1,"_DDNUM_")")) Q:'DDNUM  S CNT=CNT+1
"RTN","PSJHL3",170,0)
 Q
"RTN","PSJHL3",171,0)
FINDDOSE(PSJDD,PSJF1P1,PSJDO) ;
"RTN","PSJHL3",172,0)
 ;PSJDD - IEN file #50
"RTN","PSJHL3",173,0)
 ;PSJF1P1 - Unit Per Dose
"RTN","PSJHL3",174,0)
 ;PSJDO - Dosage Ordered
"RTN","PSJHL3",175,0)
 ;PSJOUT - Dose&Unit&UPD& 
"RTN","PSJHL3",176,0)
 ;PSJOUT="" - for freetext (not calculated dose or multi ingredient drug)
"RTN","PSJHL3",177,0)
 NEW PSJDO1,PSJDO2,PSJDOSE,PSJOUT
"RTN","PSJHL3",178,0)
 I '+$G(PSJDD)!'+$G(PSJF1P1)!($G(PSJDO)="") Q ""
"RTN","PSJHL3",179,0)
 S PSJOUT=""
"RTN","PSJHL3",180,0)
 S PSJDOSE=$$DOSE1^PSJOCDS(PSJF1P1)
"RTN","PSJHL3",181,0)
 I +PSJDOSE D
"RTN","PSJHL3",182,0)
 . I $TR(PSJDO," ")=$P(PSJDOSE,U,3) S PSJOUT=$P(PSJDOSE,U)_"&"_$P(PSJDOSE,U,2)_"&"_PSJF1P1_"&" Q
"RTN","PSJHL3",183,0)
 . I $P(PSJDOSE,U,2)["/" S PSJOUT="" Q
"RTN","PSJHL3",184,0)
 . I $TR(PSJDO," ")'=$P(PSJDOSE,U,3) S PSJOUT="&&"_PSJF1P1_"&"
"RTN","PSJHL3",185,0)
 Q PSJOUT
"RTN","PSJLIACT")
0^20^B53210467
"RTN","PSJLIACT",1,0)
PSJLIACT ;BIR/MV - IV ACTION ;28 Jul 98  8:50 AM
"RTN","PSJLIACT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**15,47,62,58,82,97,80,110,111,134,181,247,260,275,257,299,281**;16 DEC 97;Build 113
"RTN","PSJLIACT",3,0)
 ;
"RTN","PSJLIACT",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJLIACT",5,0)
 ; Reference to MAIN^TIUEDIT is supported by DBIA 2410.
"RTN","PSJLIACT",6,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071.
"RTN","PSJLIACT",7,0)
 ;
"RTN","PSJLIACT",8,0)
DC ; Discontinue order
"RTN","PSJLIACT",9,0)
 K PSGORQF
"RTN","PSJLIACT",10,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",11,0)
 S PSJCOM=+$S(PSJORD["V":$P($G(^PS(55,DFN,"IV",+PSJORD,.2)),"^",8),1:$P($G(^PS(53.1,+PSJORD,.2)),"^",8))
"RTN","PSJLIACT",12,0)
 I PSJCOM W !!,"This order is part of a complex order. If you discontinue this order the",!,"following orders will be discontinued too (unless the stop date has already",!,"been reached)." D CMPLX^PSJCOM1(PSGP,PSJCOM,PSJORD)
"RTN","PSJLIACT",13,0)
 I PSJCOM F  W !!,"Do you want to discontinue this order" S %=1 D YN^DICN Q:%  D ENCOM^PSGOEM
"RTN","PSJLIACT",14,0)
 I PSJCOM,%'=1 S VALMBK="" Q
"RTN","PSJLIACT",15,0)
 I $G(ON55)["P",$G(PSIVOORD) S PSJORD=ON55 ;*247 - Correct DCing newly copied orders
"RTN","PSJLIACT",16,0)
 I PSJORD["V" D DC^PSIVORA D:'$G(PSJOCFLG) EN^PSJLIORD(DFN,ON) Q
"RTN","PSJLIACT",17,0)
 I PSJORD["P" N ON S ON=PSJORD D DISCONT^PSIVORC
"RTN","PSJLIACT",18,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",19,0)
 Q
"RTN","PSJLIACT",20,0)
ACEDIT ; Display LM screen and AC and EDit actions
"RTN","PSJLIACT",21,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",22,0)
 S VALMBCK=$S($G(PSIVACEP):"Q",1:"R")
"RTN","PSJLIACT",23,0)
 Q
"RTN","PSJLIACT",24,0)
AEEXIT ; Call for EXIT CODE in PSJ LM IV AC/EDIT
"RTN","PSJLIACT",25,0)
 K PSGORQF
"RTN","PSJLIACT",26,0)
 D:ON["V" GT55^PSIVORFB
"RTN","PSJLIACT",27,0)
 I ON["P" D GT531^PSIVORFA(DFN,ON) D:P("OT")'="I" GTDATA^PSJLIFN
"RTN","PSJLIACT",28,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",29,0)
 K PSIVENO
"RTN","PSJLIACT",30,0)
 Q
"RTN","PSJLIACT",31,0)
EDIT ; Edit order
"RTN","PSJLIACT",32,0)
 K PSIVFN1
"RTN","PSJLIACT",33,0)
 I $D(PSGACT),PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJLIACT",34,0)
 D EDIT1
"RTN","PSJLIACT",35,0)
 Q:$D(PSIVNBD)!($G(PSIVCOPY)&'$G(PSIVENO))
"RTN","PSJLIACT",36,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",37,0)
 S VALMBCK=$S($G(PSIVFN1):"Q",1:"R")
"RTN","PSJLIACT",38,0)
 Q
"RTN","PSJLIACT",39,0)
EDIT1 ;
"RTN","PSJLIACT",40,0)
 K PSGORQF,PSJOCCHK,PSIVENO
"RTN","PSJLIACT",41,0)
 ;Ensure P() is defined
"RTN","PSJLIACT",42,0)
 I $D(P)<10 S XQORQUIT=1,P("PON")="",PSIVNBD=1 D  Q
"RTN","PSJLIACT",43,0)
 .W !,"WARNING: An error has occurred. Changes will not be saved"
"RTN","PSJLIACT",44,0)
 .D PAUSE^VALM1
"RTN","PSJLIACT",45,0)
 .S VALMBCK="Q"
"RTN","PSJLIACT",46,0)
 I "ANP"'[P(17) W !,"You cannot edit an inactive order" D PAUSE^VALM1 Q
"RTN","PSJLIACT",47,0)
 S:$G(ON55)="" ON55=$G(PSJORD)
"RTN","PSJLIACT",48,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",49,0)
 N PSIEDITO S PSIEDITO=1
"RTN","PSJLIACT",50,0)
 ;* Edit a new back door order
"RTN","PSJLIACT",51,0)
 I ($G(ON55)["V"&($G(P("21FLG"))="")) D  Q
"RTN","PSJLIACT",52,0)
 . D GSTRING^PSIVORE1,GTFLDS^PSIVORFE
"RTN","PSJLIACT",53,0)
 . I $G(ON55)["V",'$G(DONE) D OK^PSIVORE
"RTN","PSJLIACT",54,0)
 . S VALMBCK="Q",PSIVNBD=1
"RTN","PSJLIACT",55,0)
 ;* Edit an active order
"RTN","PSJLIACT",56,0)
 I $G(ON55)["V" NEW PSJEDIT1 D E^PSIVOPT1 D  Q
"RTN","PSJLIACT",57,0)
 . I $G(PSJIVBD) K PSJIVBD D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",58,0)
 I $G(ON55)["P" D EDIT^PSIVORC ;Edit incomplete order.
"RTN","PSJLIACT",59,0)
 K P("OVRIDE")
"RTN","PSJLIACT",60,0)
 Q
"RTN","PSJLIACT",61,0)
ACCEPT ; Accept order
"RTN","PSJLIACT",62,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",63,0)
 ;Accept IV from back door.
"RTN","PSJLIACT",64,0)
 I $G(PSJIVBD) K PSJIVBD D OK^PSIVORE S VALMBCK="Q" Q
"RTN","PSJLIACT",65,0)
 ;D:'$G(PSGORQF) IN^PSJOCDS($G(ON),"IV","") Q:$G(PSGORQF)
"RTN","PSJLIACT",66,0)
 I ON["V" D ACCEPT^PSIVOPT1 S:'$G(PSGORQF) PSJDSVFY=1 Q
"RTN","PSJLIACT",67,0)
 S PSIVFN1=1
"RTN","PSJLIACT",68,0)
 D COMPLTE^PSIVORC1
"RTN","PSJLIACT",69,0)
 K ^TMP("PSODAOC",$J)
"RTN","PSJLIACT",70,0)
 S VALMBCK="Q"
"RTN","PSJLIACT",71,0)
 Q
"RTN","PSJLIACT",72,0)
R ; Renewal
"RTN","PSJLIACT",73,0)
 K PSGORQF,PSJOCCHK,PSIVENO
"RTN","PSJLIACT",74,0)
 S PSJREN=1
"RTN","PSJLIACT",75,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",76,0)
 NEW PSIVAC S PSIVAC="PR" K PSGFDX
"RTN","PSJLIACT",77,0)
 D R^PSIVOPT
"RTN","PSJLIACT",78,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",79,0)
 K PSJREN,^TMP("PSODAOC",$J)
"RTN","PSJLIACT",80,0)
 Q
"RTN","PSJLIACT",81,0)
H ; Hold
"RTN","PSJLIACT",82,0)
 K PSGORQF
"RTN","PSJLIACT",83,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",84,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",85,0)
 D H^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",86,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",87,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",88,0)
 Q
"RTN","PSJLIACT",89,0)
L ; Activity Log
"RTN","PSJLIACT",90,0)
 NEW PSIVLAB,PSIVLOG,PSJHIS S (PSIVLAB,PSIVLOG)=1
"RTN","PSJLIACT",91,0)
 D EN^PSIVVW1
"RTN","PSJLIACT",92,0)
 D EN^PSJLIVMD
"RTN","PSJLIACT",93,0)
 S VALMBCK="R"
"RTN","PSJLIACT",94,0)
 Q
"RTN","PSJLIACT",95,0)
O ; On Call
"RTN","PSJLIACT",96,0)
 K PSGORQF
"RTN","PSJLIACT",97,0)
 NEW TEX S TEX="Active order ***"
"RTN","PSJLIACT",98,0)
 D HOLDHDR^PSJOE
"RTN","PSJLIACT",99,0)
 D O^PSIVOPT(DFN,ON,P(17),P(3))
"RTN","PSJLIACT",100,0)
 D:P(17)="A" PAUSE^VALM1
"RTN","PSJLIACT",101,0)
 D EN^PSJLIORD(DFN,ON)
"RTN","PSJLIACT",102,0)
 Q
"RTN","PSJLIACT",103,0)
VF ; Make the order active **ENHANCEMENTS MADE IN PSJ*5.0*260
"RTN","PSJLIACT",104,0)
 NEW PSIVCHG,PSGORQF,PSJVFF S PSIVCHG=0
"RTN","PSJLIACT",105,0)
 ;IF VALM("TITLE")="ACTIVE IV " W !!,">>>  Verify may not be selected at this point." D PAUSE^VALM1 S VALMBCK="R" Q  ;PSJ*5*281 CCR 6995 Remedy ticket 861870
"RTN","PSJLIACT",106,0)
 ;ELSE  IF $G(PSGSTAT)="NON-VERIFIED",$G(PSJNEWOE)=0 S PSJVFF=1 D EN^PSJGMRA($G(DFN),$G(PSGPD)),IN^PSJOCDS($G(PSGORD),"IV",""),OC^PSIVOC K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",107,0)
 ;PSGSTAT may not set for IV orders. Checking PSJOCFG so DI,DT is not displayed again for FN, CO, RN...
"RTN","PSJLIACT",108,0)
 IF (($G(PSGSTAT)="NON-VERIFIED")!($G(P(17))="N")&($G(PSJOCFG)="")),'+$G(PSJNEWOE) D
"RTN","PSJLIACT",109,0)
 .S PSJVFF=1 D:'$G(PSJENHOC)&'$G(PSGORQF) OC^PSIVOC D:('$G(PSGORQF)&'$G(PSJDSVFY)) IN^PSJOCDS($G(PSGORD),"IV","") K PSJVFF Q:$G(PSGORQF)
"RTN","PSJLIACT",110,0)
 Q:$G(PSGORQF)
"RTN","PSJLIACT",111,0)
 ELSE  IF '$G(PSGORQF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",112,0)
 ELSE  IF $G(PSIVFN1),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",113,0)
 ELSE  IF $G(PSGDEF),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",114,0)
 ELSE  IF $G(PSIVCOPY),(ON["V") S ON55=ON D VF1("V","ORDER VERIFIED BY ",1) Q
"RTN","PSJLIACT",115,0)
 D ACTIVE^PSIVORC2
"RTN","PSJLIACT",116,0)
 Q
"RTN","PSJLIACT",117,0)
VF1(PSIVREA,PSIVAL,PSIVLOG) ;
"RTN","PSJLIACT",118,0)
 ;Update 4 node and set activity log.
"RTN","PSJLIACT",119,0)
 ;PSIVREA: the reason use by LOG^PSIVORAL
"RTN","PSJLIACT",120,0)
 ;PSIVAL : the description reason
"RTN","PSJLIACT",121,0)
 ;PSIVLOG: Log an activity if = 1
"RTN","PSJLIACT",122,0)
 K PSGORQF
"RTN","PSJLIACT",123,0)
 I '+$G(OD)!($L($G(OD))>16) K OD
"RTN","PSJLIACT",124,0)
 D:+PSJSYSU=3 ^PSIVORE1
"RTN","PSJLIACT",125,0)
 NEW DIE,DA,DR,PSJX,XX,PSIVACT,PSJRQND
"RTN","PSJLIACT",126,0)
 S PSIVACT=1
"RTN","PSJLIACT",127,0)
 S PSJX=$G(^PS(55,DFN,"IV",+ON55,4)),XX=""
"RTN","PSJLIACT",128,0)
 I $P(PSJX,U)="" S XX=";143////0"
"RTN","PSJLIACT",129,0)
 I $P(PSJX,U,4)="" S XX=XX_U_";142////0"
"RTN","PSJLIACT",130,0)
 D NOW^%DTC
"RTN","PSJLIACT",131,0)
 S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",132,0)
 I +PSJSYSU=3 S DR="140////"_DUZ_";141////"_$E(%,1,12)_";142////1"_$P(XX,U)
"RTN","PSJLIACT",133,0)
 I +PSJSYSU=1 S DR="16////"_DUZ_";17////"_$E(%,1,12)_";143////1"_$P(XX,U,2)
"RTN","PSJLIACT",134,0)
 I $G(P("PRY"))="D" S DR=DR_";.22////"_+P("IVRM")
"RTN","PSJLIACT",135,0)
 D ^DIE
"RTN","PSJLIACT",136,0)
 ; If pending IV renew is edited during finish, go back and DE the original active order left in RENEWED status
"RTN","PSJLIACT",137,0)
 S PREREN=$S(ON55["V":$G(@(DIE_"+ON55,2)")),1:""),PREREN=$P(PREREN,"^",5) I PREREN D  K PREREN
"RTN","PSJLIACT",138,0)
 . I PREREN["P" S PREREN=$G(@("^PS(53.1,+PREREN,0)")),PREREN=$P(PREREN,"^",25)
"RTN","PSJLIACT",139,0)
 . I PREREN["V" N PRERENOD S PRERENOD=$G(@("^PS(55,DFN,""IV"",+PREREN,0)")) I $P(PRERENOD,"^",17)="R",($G(P("RES"))="E") D
"RTN","PSJLIACT",140,0)
 ..  S DIE="^PS(55,"_DFN_",""IV"",",DA=+PREREN,DA(1)=DFN
"RTN","PSJLIACT",141,0)
 ..  S DR="100////D;.03////"_PSGDT S ORIGSTOP=$P($G(@("^PS(55,DFN,""IV"",+PREREN,2)")),"^",3) I ORIGSTOP S DR=DR_";116////"_ORIGSTOP
"RTN","PSJLIACT",142,0)
 ..  D ^DIE D EN1^PSJHL2(DFN,"SC",PREREN)
"RTN","PSJLIACT",143,0)
 K DR,DIE,DA
"RTN","PSJLIACT",144,0)
 I (+PSJSYSU=3)&($G(P("PRY"))="D") D
"RTN","PSJLIACT",145,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSJLIACT",146,0)
 .Q:Y="N"
"RTN","PSJLIACT",147,0)
 .D MAIN^TIUEDIT(3,.TIUDA,DFN,"","","","",1)
"RTN","PSJLIACT",148,0)
 Q:'$G(PSIVLOG)
"RTN","PSJLIACT",149,0)
 I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D
"RTN","PSJLIACT",150,0)
 . NEW DIC,DA,X,Y,XX,DO D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJLIACT",151,0)
 . S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJLIACT",152,0)
 . S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJLIACT",153,0)
 . S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJLIACT",154,0)
 . D FILE^DICN
"RTN","PSJLIACT",155,0)
 NEW PSIVALCK
"RTN","PSJLIACT",156,0)
 S PSIVREA="V",PSIVALT=""
"RTN","PSJLIACT",157,0)
 S PSIVAL=PSIVAL_$S(+PSJSYSU=3:"PHARMACIST",1:"NURSE")
"RTN","PSJLIACT",158,0)
 D LOG^PSIVORAL K PSIVAL,PSIVREA,PSIVLN
"RTN","PSJLIACT",159,0)
 I $G(PSJORD)["P" S PSIVREA="V",PSIVALT="",PSGRDTX=$G(^PS(53.1,+PSJORD,2.5)) D
"RTN","PSJLIACT",160,0)
 . I $G(PSGRDTX) S PSIVAL="Requested Start Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U))) D LOG^PSIVORAL
"RTN","PSJLIACT",161,0)
 . I $P(PSGRDTX,U,3) S PSIVREA="V",PSIVALT="" S PSIVAL="Requested Stop Date: "_$$ENDTC^PSGMI($$DATE2^PSJUTL2($P(PSGRDTX,U,3))) D LOG^PSIVORAL
"RTN","PSJLIACT",162,0)
 N DUR I $G(PSJORD) S DUR=$$GETDUR^PSJLIVMD(DFN,+PSJORD,$S(PSJORD["P":"P",1:"IV"),1) I DUR]""  D
"RTN","PSJLIACT",163,0)
 . K DR S DIE="^PS(55,"_DFN_",""IV"",",DA=+ON55,DA(1)=DFN
"RTN","PSJLIACT",164,0)
 . S DR=$S($G(IVLIMIT):"152////"_DUR,1:"151////"_DUR) K IVLIMIT
"RTN","PSJLIACT",165,0)
 . D ^DIE
"RTN","PSJLIACT",166,0)
 S ^TMP("PSODAOC",$J,"IP NEW IEN")=ON55
"RTN","PSJLIACT",167,0)
 D EN1^PSJHL2(DFN,"SC",ON55),SETOC^PSJNEWOC(ON55)
"RTN","PSJLIACT",168,0)
 D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSJLIACT",169,0)
 I '$D(^PS(55,DFN,"IV","CIMOI",+ON55)) D CIMOI^PSJIMO1(DFN,ON55,"",$G(PSJORD))
"RTN","PSJLIACT",170,0)
 E  I +$G(PSJORD) D KILL531^PSJIMO1(DFN,"",PSJORD)
"RTN","PSJLIACT",171,0)
 D GT55^PSIVORFB S OLDON=$P($G(^PS(55,DFN,"IV",+ON55,2)),"^",5),P("OLDON")=OLDON
"RTN","PSJLIACT",172,0)
 N PSJPRIO,PSJSCH,NODE0,NODEP2 S NODE0=$G(^PS(55,DFN,"IV",+ON55,0)),NODEP2=$G(^PS(55,DFN,"IV",+ON55,.2))
"RTN","PSJLIACT",173,0)
 S PSJPRIO=$P(NODEP2,"^",4),PSJSCH=$P(NODE0,"^",9)
"RTN","PSJLIACT",174,0)
 I (",S,A,")[(","_$G(PSJPRIO)_",")!($G(PSJSCH)="NOW")!($G(PSJSCH)["STAT") D NOTIFY^PSJHL4(ON55,DFN,$G(PSJPRIO),$G(PSJSCH))
"RTN","PSJLIACT",175,0)
 Q
"RTN","PSJLMUT1")
0^23^B73799409
"RTN","PSJLMUT1",1,0)
PSJLMUT1 ;BIR/MLM - DRUG NAME DISPLAY ;05 Feb 98  1:39 PM
"RTN","PSJLMUT1",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**4,27,29,49,58,107,110,146,175,201,181,281**;16 DEC 97;Build 113
"RTN","PSJLMUT1",3,0)
 ;
"RTN","PSJLMUT1",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJLMUT1",5,0)
 ; Reference to ^PS(50.7 is supported by DBIA# 2180.
"RTN","PSJLMUT1",6,0)
 ; Reference to ^PS(50.606 is supported by DBIA# 2174.
"RTN","PSJLMUT1",7,0)
 ; Reference to EN^PSODRDU2 is supported by DBIA# 2189.
"RTN","PSJLMUT1",8,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSJLMUT1",9,0)
 ;
"RTN","PSJLMUT1",10,0)
DRGDISP(DFN,ON,NL,GL,NAME,DRUGONLY)       ;
"RTN","PSJLMUT1",11,0)
 ;; DRUGONLY = 1/0 - Only the drug name will be returned.
"RTN","PSJLMUT1",12,0)
 ;; NL       = The drug name display length
"RTN","PSJLMUT1",13,0)
 ;; GL       = The give line display length, total length-6 ("Give: ")
"RTN","PSJLMUT1",14,0)
 ;; NAME(X)  = Drug name and give line in displayable format.
"RTN","PSJLMUT1",15,0)
 ;; ON       = IEN#_U/P (U=Unit Dose; P=Pending)
"RTN","PSJLMUT1",16,0)
 ;
"RTN","PSJLMUT1",17,0)
 NEW F,OIND,MARX,MR,NOTGV,SCH,PSGUPDDO,PSGGV,X,PSGX,PSGINS,DRUGNAME
"RTN","PSJLMUT1",18,0)
 K NAME S PSGINS=""
"RTN","PSJLMUT1",19,0)
 S:ON["U" F="^PS(55,DFN,5,+ON,"
"RTN","PSJLMUT1",20,0)
 I ON["P" S F="^PS(53.1,+ON,",X=$G(@(F_".3)")),PSGINS=$S(X]"":X,1:"")
"RTN","PSJLMUT1",21,0)
 I $G(@(F_"0)"))="" S NAME(1)="NOT FOUND" Q
"RTN","PSJLMUT1",22,0)
 S OIND=$G(@(F_".2)")),PSGUPDDO=$P(OIND,U,2),X=@(F_"0)"),NOTGV=$P(X,U,22),MR=$$ENMRN^PSGMI(+$P(X,U,3))
"RTN","PSJLMUT1",23,0)
 I '+OIND,($P(X,U,4)'="U") NEW DRG D GTDRG^PSIVORFA F X="AD","SOL" Q:+OIND  F PSGX=0:0 S PSGX=$O(DRG(X,PSGX)) Q:'PSGX  S OIND=$P(DRG(X,PSGX),U,6) Q:+OIND
"RTN","PSJLMUT1",24,0)
 S SCH=$P($G(@(F_"2)")),U)
"RTN","PSJLMUT1",25,0)
 I +$O(@(F_"1,0)")),'+$O(@(F_"1,1)")),PSGUPDDO="" D DD(F,.DRUGNAME)
"RTN","PSJLMUT1",26,0)
 S:($G(DRUGNAME)=""!($G(DRUGNAME)["NOT FOUND")) DRUGNAME=$$OIDF(OIND)
"RTN","PSJLMUT1",27,0)
 ;S PSGGV=$S(NOTGV:"*** NOT TO BE GIVEN *** ",1:"")_PSGINS_PSGUPDDO_" "_MR_" "_SCH
"RTN","PSJLMUT1",28,0)
 S PSGGV=$S(NOTGV:"*** NOT TO BE GIVEN *** ",1:"")_$S(('$D(PSJPDDDP)&('$L(PSGUPDDO))):PSGINS,1:PSGUPDDO)_" "_MR_" "_SCH
"RTN","PSJLMUT1",29,0)
 S PSGX=0 K PSJPDDDP
"RTN","PSJLMUT1",30,0)
 D TXT^PSGMUTL(DRUGNAME,NL) F X=0:0 S X=$O(MARX(X)) Q:'X  S NAME(X)=$S(X>1:"  ",1:"")_MARX(X),PSGX=X
"RTN","PSJLMUT1",31,0)
 Q:+DRUGONLY
"RTN","PSJLMUT1",32,0)
 D TXT^PSGMUTL(PSGGV,GL) F X=0:0 S X=$O(MARX(X)) Q:'X  D
"RTN","PSJLMUT1",33,0)
 . I X=1 S NAME(PSGX+X)="Give: "_MARX(X) Q
"RTN","PSJLMUT1",34,0)
 . S NAME(PSGX+X)=$S(X>1:"      ",1:"")_MARX(X)
"RTN","PSJLMUT1",35,0)
 Q
"RTN","PSJLMUT1",36,0)
OIDF(OIND)    ; Return Orderable Item name and Dosage form.
"RTN","PSJLMUT1",37,0)
 ;; +OIND = orderable item IEN
"RTN","PSJLMUT1",38,0)
 NEW X,NAME
"RTN","PSJLMUT1",39,0)
 S X=$G(^PS(50.7,+OIND,0))
"RTN","PSJLMUT1",40,0)
 S:$P(X,U)]"" NAME=$P(X,U)_" "_$P($G(^PS(50.606,+$P(X,U,2),0)),U)
"RTN","PSJLMUT1",41,0)
 Q $S($G(NAME)]"":NAME,1:"NOT FOUND "_+OIND_";PS(50.7")
"RTN","PSJLMUT1",42,0)
 ;
"RTN","PSJLMUT1",43,0)
DD(F,NAME)        ; Return Dispense drug name.
"RTN","PSJLMUT1",44,0)
 ;; F = "^PS(55,DFN,5,+ON," or "^PS(53.1,+ON,"
"RTN","PSJLMUT1",45,0)
 NEW X K NAME
"RTN","PSJLMUT1",46,0)
 S X=$O(@(F_"1,0)")),X=$G(@(F_"1,"_+X_",0)"))
"RTN","PSJLMUT1",47,0)
 I $P(X,U)]"" S NAME=$P($G(^PSDRUG(+X,0)),U)
"RTN","PSJLMUT1",48,0)
 E  S NAME="NOT FOUND "_+X_";PSDRUG"
"RTN","PSJLMUT1",49,0)
 I '$O(@(F_"1,1)")),+$P(X,U,2)>1 S PSGUPDDO=+$P(X,U,2)
"RTN","PSJLMUT1",50,0)
 S PSJPDDDP=1
"RTN","PSJLMUT1",51,0)
 Q
"RTN","PSJLMUT1",52,0)
DSPLORDU(PSGP,ON)   ; Display UD order for order check as in the Inpat Profile.
"RTN","PSJLMUT1",53,0)
 NEW DRUGNAME,F,NODE0,NODE2,PSJID,PSJX,SCH,SD,STAT,X,Y
"RTN","PSJLMUT1",54,0)
 S F=$S(ON["U":"^PS(55,PSGP,5,"_+ON_",",1:"^PS(53.1,"_+ON_",")
"RTN","PSJLMUT1",55,0)
 S NODE0=$G(@(F_"0)")),NODE2=$G(@(F_"2)"))
"RTN","PSJLMUT1",56,0)
 D DRGDISP^PSJLMUT1(PSGP,ON,39,54,.DRUGNAME,0)
"RTN","PSJLMUT1",57,0)
 I ON["P",$P(NODE0,U,4)="F" D DSPLORDV(PSGP,ON) Q
"RTN","PSJLMUT1",58,0)
 S SCH=$P(NODE0,U,7)
"RTN","PSJLMUT1",59,0)
 S STAT=$P(NODE0,U,9) I STAT="A",$P(NODE0,U,27)="R" S STAT="R"
"RTN","PSJLMUT1",60,0)
 I STAT'="P" S PSJID=$E($$ENDTC^PSGMI($P(NODE2,U,2)),1,5),SD=$E($$ENDTC^PSGMI($P(NODE2,U,4)),1,5)
"RTN","PSJLMUT1",61,0)
 I STAT="P" S (PSJID,SD)="*****",SCH="?"
"RTN","PSJLMUT1",62,0)
 F PSJX=0:0 S PSJX=$O(DRUGNAME(PSJX)) Q:'PSJX  D
"RTN","PSJLMUT1",63,0)
 . S:PSJX=1 X=SCH_"  "_PSJID_"  "_SD_"  "_$E(STAT,1)
"RTN","PSJLMUT1",64,0)
 . S:PSJX=1 DRUGNAME(1)=$$SETSTR^VALM1(X,$E(DRUGNAME(1),1,40),42,20)
"RTN","PSJLMUT1",65,0)
 . S PSJOC(ON,PSJLINE)="        "_DRUGNAME(PSJX)
"RTN","PSJLMUT1",66,0)
 . S PSJLINE=PSJLINE+1
"RTN","PSJLMUT1",67,0)
 Q
"RTN","PSJLMUT1",68,0)
DSPLORDV(DFN,ON)   ; Display IV order for order check as in the Inpat Profile.
"RTN","PSJLMUT1",69,0)
 N DRG,DRGI,DRGT,DRGX,FIL,ND,ON55,P,PSJIVFLG,PSJORIFN,TYP,X,Y,COMPDRG
"RTN","PSJLMUT1",70,0)
 S TYP="?" I ON["V" D
"RTN","PSJLMUT1",71,0)
 .S Y=$G(^PS(55,DFN,"IV",+ON,0)) F X=2,3,4,5,8,9,17,23 S P(X)=$P(Y,U,X)
"RTN","PSJLMUT1",72,0)
 .S TYP=$$ONE^PSJBCMA(DFN,ON,P(9),P(2),P(3)) I TYP'="O" S TYP="C"
"RTN","PSJLMUT1",73,0)
 .S ON55=ON,P("OT")=$S(P(4)="A":"F",P(4)="H":"H",1:"I") D GTDRG^PSIVORFB,GTOT^PSIVUTL(P(4))
"RTN","PSJLMUT1",74,0)
 S PSJCT=0,PSJL=""
"RTN","PSJLMUT1",75,0)
 I ON'["V" S (P(2),P(3))="",P(17)=$P($G(^PS(53.1,+ON,0)),U,9),Y=$G(^(8)),P(4)=$P(Y,U),P(8)=$P(Y,U,5),P(9)=$P($G(^(2)),U) D GTDRG^PSIVORFA,GTOT^PSIVUTL(P(4))
"RTN","PSJLMUT1",76,0)
 S PSJIVFLG=1 D PIVAD,SOL
"RTN","PSJLMUT1",77,0)
 Q
"RTN","PSJLMUT1",78,0)
SOL ;
"RTN","PSJLMUT1",79,0)
 S PSJL=$S($G(PSJIVFLG):PSJL,1:"")_"         in"
"RTN","PSJLMUT1",80,0)
 S DRG=0 F  S DRG=+$O(DRG("SOL",DRG)) Q:'DRG  D NAME^PSIVUTL(DRG("SOL",DRG),37,.NAME,0) S DRGX=0 F  S DRGX=$O(NAME(DRGX)) Q:'DRGX  D
"RTN","PSJLMUT1",81,0)
 .S COMPDRG="",COMPDRG=$P(DRG("SOL",DRG),"^",2)_" "_$P(DRG("SOL",DRG),"^",3)
"RTN","PSJLMUT1",82,0)
 .I PSJL["   in" D
"RTN","PSJLMUT1",83,0)
 ..I $D(PSJP(2)),COMPDRG=PSJP(2) S NAME(DRGX)="*"_NAME(DRGX) Q
"RTN","PSJLMUT1",84,0)
 ..I $D(PSJOCDT(10,COMPDRG))!($D(PSJOCDT(20,COMPDRG))) D  Q  ;PSJ*5*281 - identify the interacting drugs with an *
"RTN","PSJLMUT1",85,0)
 ...S NAME(DRGX)="*"_NAME(DRGX) Q
"RTN","PSJLMUT1",86,0)
 .I PSJL'["   in" S NAME(DRGX)=NAME(DRGX)
"RTN","PSJLMUT1",87,0)
 .S PSJL=$$SETSTR^VALM1(NAME(DRGX),PSJL,13,60) D:$G(PSJIVFLG) PIV1 D SETTMP S PSJL="       "
"RTN","PSJLMUT1",88,0)
 Q
"RTN","PSJLMUT1",89,0)
PIVAD ; Print IV Additives.
"RTN","PSJLMUT1",90,0)
 F DRG=0:0 S DRG=$O(DRG("AD",DRG)) Q:'DRG  D NAME^PSIVUTL(DRG("AD",DRG),39,.NAME,1) F DRGX=0:0 S DRGX=$O(NAME(DRGX)) Q:'DRGX  D
"RTN","PSJLMUT1",91,0)
 .D  ;PSJ*5*281 - identify the interacting drugs with an *
"RTN","PSJLMUT1",92,0)
 ..I $D(PSJP(2)),NAME(DRGX)=PSJP(2) S NAME(DRGX)="*"_NAME(DRGX) Q
"RTN","PSJLMUT1",93,0)
 ..I $D(PSJOCDT(10,NAME(DRGX)))!($D(PSJOCDT(20,NAME(DRGX)))) S NAME(DRGX)="*"_NAME(DRGX) Q
"RTN","PSJLMUT1",94,0)
 ..S NAME(DRGX)=" "_NAME(DRGX)
"RTN","PSJLMUT1",95,0)
 .S PSJL=$$SETSTR^VALM1(NAME(DRGX),PSJL,9,60) D:$G(PSJIVFLG) PIV1 D SETTMP
"RTN","PSJLMUT1",96,0)
 Q
"RTN","PSJLMUT1",97,0)
 ;
"RTN","PSJLMUT1",98,0)
PIV1 ; Print Sched type, start/stop dates, and status.
"RTN","PSJLMUT1",99,0)
 K PSJIVFLG
"RTN","PSJLMUT1",100,0)
 F X=2,3 S P(X)=$E($$ENDTC^PSGMI(P(X)),1,$S($D(PSJEXTP):8,1:5))
"RTN","PSJLMUT1",101,0)
 I '$D(PSJEXTP) S PSJL=$$SETSTR^VALM1(TYP,PSJL,50,1),PSJL=$$SETSTR^VALM1(P(2),PSJL,53,7),PSJL=$$SETSTR^VALM1(P(3),PSJL,60,7),PSJL=$$SETSTR^VALM1(P(17),PSJL,67,1)
"RTN","PSJLMUT1",102,0)
 E  S PSJL=$$SETSTR^VALM1(TYP,PSJL,50,1),PSJL=$$SETSTR^VALM1(P(2),53,7),PSJL=$$SETSTR^VALM1(P(3),PSJL,63,7),PSJL=$$SETSTR^VALM1(P(17),PSJL,73,1)
"RTN","PSJLMUT1",103,0)
 Q
"RTN","PSJLMUT1",104,0)
SETTMP ;
"RTN","PSJLMUT1",105,0)
 S PSJOC(ON,PSJLINE)=PSJL,PSJLINE=PSJLINE+1
"RTN","PSJLMUT1",106,0)
 Q
"RTN","PSJLMUT1",107,0)
ORDCHK(DFN,TYPE,PIECE)   ;
"RTN","PSJLMUT1",108,0)
 ;TYPE ="DD" - Duplicate drug
"RTN","PSJLMUT1",109,0)
 ;     ="DC" - Duplicate class
"RTN","PSJLMUT1",110,0)
 ;     -"DI" - Drug Interaction
"RTN","PSJLMUT1",111,0)
 ;PIECE = The piece order number is return from ^TMP($J,"DD"...
"RTN","PSJLMUT1",112,0)
 ;PSJOC(ON,x) = Array of inpatient orders to be displayed
"RTN","PSJLMUT1",113,0)
 ;
"RTN","PSJLMUT1",114,0)
 NEW ON,PSJL,PSIVX,PSJOC,PSJORIEN,PSJPACK,PSJLINE
"RTN","PSJLMUT1",115,0)
 S PSJOC=0,PSJLINE=1
"RTN","PSJLMUT1",116,0)
 F PSIVX=0:0 S PSIVX=$O(^TMP($J,TYPE,PSIVX)) Q:'PSIVX  D
"RTN","PSJLMUT1",117,0)
 . S PSJPACK=$P(^TMP($J,TYPE,PSIVX,0),U,PIECE)
"RTN","PSJLMUT1",118,0)
 . I $G(PSGORD) S PSJORD=PSGORD ; Set PSJORD if PSGORD exists and is not Null
"RTN","PSJLMUT1",119,0)
 . I $G(PSJORD)]"" I $S($D(PSJORD):$G(PSJORD),1:$G(PSGORD))'["V",$P(PSJPACK,";")=$S($D(PSJORD):$G(PSJORD),1:$G(PSGORD)) Q  ; don't flag order that is being renewed as duplicate, only checks Unit Dose orders
"RTN","PSJLMUT1",120,0)
 . I $G(PSJCOM),($G(PSJORD)["P") Q:$D(^PS(53.1,"ACX",PSJCOM,+PSJPACK))
"RTN","PSJLMUT1",121,0)
 . ; Don't flag if pending renewal from CPRS
"RTN","PSJLMUT1",122,0)
 . I $G(PSJORD)]"",(PSJORD["P"),($P($G(^PS(53.1,+PSJORD,0)),"^",24)="R"),($P(PSJPACK,";")["U"),($P($G(^PS(55,DFN,5,+$P(PSJPACK,";"),0)),"^",27)="R"),($P($G(^PS(55,DFN,5,+$P(PSJPACK,";"),0)),"^",26)=PSJORD) Q
"RTN","PSJLMUT1",123,0)
 . I $G(PSIVRNFG),$G(ON55)["V",$P(PSJPACK,";")=$G(ON55) Q  ;PSIVRNFG set and kill in R+2^PSIVOPT2. Needed to do dupl. check on new order but not renew.
"RTN","PSJLMUT1",124,0)
 . S PSJORIEN=$P(^TMP($J,TYPE,PSIVX,0),U,PIECE-1)
"RTN","PSJLMUT1",125,0)
 . I TYPE="DI",($P(^TMP($J,TYPE,PSIVX,0),U,4)="CRITICAL") S PSJIREQ=1
"RTN","PSJLMUT1",126,0)
 . ; Adding Drug Interactions check for use in Intervention defaults in PSJRXI.
"RTN","PSJLMUT1",127,0)
 . I TYPE="DI" S PSJRXREQ=$S($P(^TMP($J,TYPE,PSIVX,0),U,4)="CRITICAL":"CRITICAL DRUG INTERACTION",1:"SIGNIFICANT DRUG INTERACTION")
"RTN","PSJLMUT1",128,0)
 . ;I $P(PSJPACK,";",2)["O" D  Q
"RTN","PSJLMUT1",129,0)
 . N X S X=$P(PSJPACK,";",2) I X["O" D  Q
"RTN","PSJLMUT1",130,0)
 ..  D:PSJFST=1 PAUSE
"RTN","PSJLMUT1",131,0)
 ..  W !!,"The patient has this "_$S($P(PSJPACK,";")["N":"Non-VA Meds",$P(PSJPACK,";",2)["O":"Outpatient",1:"")_" order:",!
"RTN","PSJLMUT1",132,0)
 ..  I $D(^TMP($J,TYPE,PSIVX,1)) D SHOR^PSJLMUT2(TYPE,PSIVX),PAUSE S PSJFST=$S(PSJFST=0:PSJFST+2,1:PSJFST+1) Q
"RTN","PSJLMUT1",133,0)
 ..  D EN^PSODRDU2(DFN,PSJPACK,"PSJPRE"),PAUSE S PSJPDRG=1,PSJFST=$S(PSJFST=0:PSJFST+2,1:PSJFST+1)
"RTN","PSJLMUT1",134,0)
 . S ON=$P(PSJPACK,";") Q:$D(PSJOC(ON))
"RTN","PSJLMUT1",135,0)
 . I ON=$G(PSIVOCON),+PSJORIEN Q
"RTN","PSJLMUT1",136,0)
 . I ON=$G(PSIVOCON),'+PSJORIEN D SETPSJOC Q
"RTN","PSJLMUT1",137,0)
 . ;S PSJOC=PSJOC+1,PSJPDRG=1 D:PSJOC=1 WRITE(TYPE)
"RTN","PSJLMUT1",138,0)
 . I ON["V" D
"RTN","PSJLMUT1",139,0)
 .. I '$O(^PS(55,DFN,"IV",+ON,0)) D SETPSJOC Q
"RTN","PSJLMUT1",140,0)
 .. D DSPLORDV(DFN,ON) S PSJOC=PSJOC+1
"RTN","PSJLMUT1",141,0)
 . I ON'["V" D DSPLORDU(DFN,ON) S PSJOC=PSJOC+1
"RTN","PSJLMUT1",142,0)
 . S PSJOC(ON,PSJLINE)="",PSJLINE=PSJLINE+1
"RTN","PSJLMUT1",143,0)
 D:PSJOC WRITE(TYPE)
"RTN","PSJLMUT1",144,0)
 S ON="" F  S ON=$O(PSJOC(ON)) Q:ON=""  W ! S PSJLINE=PSJLINE+1,PSJFST=PSJFST+1 D
"RTN","PSJLMUT1",145,0)
 . F PSIVX=0:0 S PSIVX=$O(PSJOC(ON,PSIVX)) Q:'PSIVX  W !,PSJOC(ON,PSIVX) S PSJLINE=PSJLINE+1 D:'(PSIVX#6) PAUSE
"RTN","PSJLMUT1",146,0)
 W !
"RTN","PSJLMUT1",147,0)
 Q
"RTN","PSJLMUT1",148,0)
SETPSJOC ;Set PSJOC array to be displayed later
"RTN","PSJLMUT1",149,0)
 NEW PIECE S PIECE=$S(TYPE="DC":4,1:2)
"RTN","PSJLMUT1",150,0)
 S X=$$SETSTR^VALM1($P(^TMP($J,TYPE,PSIVX,0),U,PIECE),"",9,40)
"RTN","PSJLMUT1",151,0)
 S X=$$SETSTR^VALM1("* EXISTS IN CURRENT ORDER *",X,50,27)
"RTN","PSJLMUT1",152,0)
 S PSJOC(ON,PSJLINE)=X,PSJLINE=PSJLINE+1,PSJOC=PSJOC+1
"RTN","PSJLMUT1",153,0)
 Q
"RTN","PSJLMUT1",154,0)
WRITE(TYPE)        ;Display order check description
"RTN","PSJLMUT1",155,0)
 S PSJPDRG=1
"RTN","PSJLMUT1",156,0)
 I TYPE="DD" W !!,"This patient is already receiving the following order",$S(PSJOC>1:"s",1:"")," for ",$S($G(PSJDD)]"":$P($G(^PSDRUG(PSJDD,0)),U),1:"this drug"),":",!
"RTN","PSJLMUT1",157,0)
 I TYPE="DC" W !!,"This patient is already receiving ",$S(PSJOC>1:"orders",1:"an order")," for the following drug",$S(PSJOC>1:"s",1:"")," in the same",!,"class as ",$S($G(PSJDD)]"":$P($G(^PSDRUG(PSJDD,0)),U),1:"the drug selected"),":",!
"RTN","PSJLMUT1",158,0)
 I TYPE="DI" W !!,"This patient is receiving the following medication",$S(PSJOC>1:"s",1:"")," that ha",$S(PSJOC>1:"ve",1:"s")," an interaction",!,"with ",$P($G(^PSDRUG(PSJDD,0)),U),":",!
"RTN","PSJLMUT1",159,0)
 Q
"RTN","PSJLMUT1",160,0)
PAUSE ;
"RTN","PSJLMUT1",161,0)
 K DIR W ! S DIR(0)="EA",DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue..." D ^DIR W !
"RTN","PSJLMUT1",162,0)
 Q
"RTN","PSJLMUTL")
0^48^B56775239
"RTN","PSJLMUTL",1,0)
PSJLMUTL ;BIR/MLM - INPATIENT LISTMAN UTILITIES ; 9/12/07 10:28am
"RTN","PSJLMUTL",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**7,67,58,85,111,160,198,320,281**;16 DEC 97;Build 113
"RTN","PSJLMUTL",3,0)
 ;
"RTN","PSJLMUTL",4,0)
 ; Reference to ^ORD(101 is supported by DBIA #872.
"RTN","PSJLMUTL",5,0)
 ; Reference to ^PS(50.606 is supported by DBIA #2174.
"RTN","PSJLMUTL",6,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSJLMUTL",7,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJLMUTL",8,0)
 ; Reference to ^PSDRUG( is supported by DBIA #2192.
"RTN","PSJLMUTL",9,0)
 ; Reference to ^GMRAPEM0 is supported by DBIA #190.
"RTN","PSJLMUTL",10,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJLMUTL",11,0)
 ; Reference to SELECTED^VSIT is supported by DBIA #1905.
"RTN","PSJLMUTL",12,0)
 ;
"RTN","PSJLMUTL",13,0)
NEWALL(DFN) ; Enter Allergy info.
"RTN","PSJLMUTL",14,0)
 ;
"RTN","PSJLMUTL",15,0)
 D FULL^VALM1,EN2^GMRAPEM0
"RTN","PSJLMUTL",16,0)
 Q
"RTN","PSJLMUTL",17,0)
DISALL(DFN) ; Display brief patient info list.
"RTN","PSJLMUTL",18,0)
 K ^TMP("PSJALL",$J) N PSJLN,X,Y,PSGALG,PSGRALG,PSGLDR,PSJGMRAL,PSJWHERE S PSJWHERE="PSJLMUTL"
"RTN","PSJLMUTL",19,0)
 D ATS^PSJMUTL(57,57,2)
"RTN","PSJLMUTL",20,0)
 I (PSJGMRAL=0) S ^TMP("PSJALL",$J,1,0)=" Allergies/Reactions: "_"NKA",PSJLN=2 G RAD
"RTN","PSJLMUTL",21,0)
 I (PSJGMRAL="") S ^TMP("PSJALL",$J,1,0)=" Allergies/Reactions: No Allergy Assessment",PSJLN=2 G RAD
"RTN","PSJLMUTL",22,0)
 I ($G(PSGVALG(1))="NKA")!((PSGVALG=0)&(PSGALG=0)) D
"RTN","PSJLMUTL",23,0)
 .S ^TMP("PSJALL",$J,1,0)="           Allergies: "_$G(PSGVALG(1)),PSJLN=2,X=1
"RTN","PSJLMUTL",24,0)
 I ($G(PSGVALG(1))'="NKA")&((PSGVALG>0)!(PSGALG>0)) D
"RTN","PSJLMUTL",25,0)
 .S ^TMP("PSJALL",$J,1,0)="Allergies - Verified: "_$G(PSGVALG(1)),PSJLN=2,X=1
"RTN","PSJLMUTL",26,0)
 .F  S X=$O(PSGVALG(X)) Q:'X  S ^TMP("PSJALL",$J,PSJLN,0)="                        "_PSGVALG(X),PSJLN=PSJLN+1
"RTN","PSJLMUTL",27,0)
 .S ^TMP("PSJALL",$J,PSJLN,0)="        Non-Verified: "_$S($G(PSGALG(1))=0:"",1:$G(PSGALG(1))),PSJLN=PSJLN+1,X=1
"RTN","PSJLMUTL",28,0)
 .F  S X=$O(PSGALG(X)) Q:'X  S ^TMP("PSJALL",$J,PSJLN,0)="                        "_PSGALG(X),PSJLN=PSJLN+1
"RTN","PSJLMUTL",29,0)
RAD D RAD^PSJMUTL
"RTN","PSJLMUTL",30,0)
 I ($G(PSGVADR(1))="NKA")!((PSGVADR=0)&(PSGADR=0)) D
"RTN","PSJLMUTL",31,0)
 .S ^TMP("PSJALL",$J,PSJLN,0)="",^TMP("PSJALL",$J,PSJLN+1,0)="   Adverse Reactions: "_$G(PSGADR(1)),PSJLN=PSJLN+2,X=1
"RTN","PSJLMUTL",32,0)
 I ($G(PSGVADR(1))'="NKA")&((PSGVADR>0)!(PSGADR>0)) D
"RTN","PSJLMUTL",33,0)
 .S ^TMP("PSJALL",$J,PSJLN,0)="",^TMP("PSJALL",$J,PSJLN+1,0)="Reactions - Verified: "_$G(PSGVADR(1)),PSJLN=PSJLN+2,X=1
"RTN","PSJLMUTL",34,0)
 .F  S X=$O(PSGVADR(X)) Q:'X  S ^TMP("PSJALL",$J,PSJLN,0)="              "_PSGVADR(X),PSJLN=PSJLN+1
"RTN","PSJLMUTL",35,0)
 .S ^TMP("PSJALL",$J,PSJLN,0)="        Non-Verified: "_$G(PSGADR(1)),PSJLN=PSJLN+2,X=1
"RTN","PSJLMUTL",36,0)
 .F  S X=$O(PSGADR(X)) Q:'X  S ^TMP("PSJALL",$J,PSJLN,0)="              "_PSGADR(X),PSJLN=PSJLN+1
"RTN","PSJLMUTL",37,0)
 ;
"RTN","PSJLMUTL",38,0)
NARRATIV ; print inpatient/outpatient narratives
"RTN","PSJLMUTL",39,0)
 N PSJCLHD
"RTN","PSJLMUTL",40,0)
 S ^TMP("PSJALL",$J,PSJLN,0)="" D SETNAR("PSJALL",$G(^PS(55,DFN,5.3)),"In")
"RTN","PSJLMUTL",41,0)
 S ^TMP("PSJALL",$J,PSJLN+1,0)="" D SETNAR("PSJALL",$G(^PS(55,DFN,1)),"Out")
"RTN","PSJLMUTL",42,0)
 D SDA S PSJLN=0 F X=0:0 S X=$O(^TMP("PSJALL",$J,X)) Q:'X  S PSJLN=PSJLN+1
"RTN","PSJLMUTL",43,0)
 I '$G(PSJCLHD)!'$G(VALMCNT) S VALMCNT=PSJLN
"RTN","PSJLMUTL",44,0)
 Q
"RTN","PSJLMUTL",45,0)
 ;
"RTN","PSJLMUTL",46,0)
SDA N PSJPAD,PSJCLIN,PSJCLINO,PSJAPD,PSJSCI,PSJCLOK,VAERR K ^TMP("PSJVSIT"),PSJDBUN S $P(PSJPAD," ",26)=" "
"RTN","PSJLMUTL",47,0)
 Q:'$$PATCH^XPDUTL("SD*5.3*285")
"RTN","PSJLMUTL",48,0)
 D NOW^%DTC S VASD("F")=$P(%,".")-1
"RTN","PSJLMUTL",49,0)
 D SDA^VADPT S:$G(VAERR)=2 (PSJCLHD,PSJDBUN)=2 I $O(^UTILITY("VASD",$J,"")) M PSJUTL=^UTILITY("VASD",$J) D
"RTN","PSJLMUTL",50,0)
 . S PSJSCDT0=0
"RTN","PSJLMUTL",51,0)
 . F  S PSJSCDT0=$O(PSJUTL(PSJSCDT0)) Q:'PSJSCDT0  D
"RTN","PSJLMUTL",52,0)
 .. S PSJCLINO=$P($G(PSJUTL(PSJSCDT0,"E")),U,2),PSJCLIN=$P($G(PSJUTL(PSJSCDT0,"I")),U,2)
"RTN","PSJLMUTL",53,0)
 .. S PSJSCI=$G(PSJUTL(PSJSCDT0,"I")),PSJAPD=$$FMTE^XLFDT(+PSJSCI) Q:(PSJCLIN="")!(PSJAPD="")
"RTN","PSJLMUTL",54,0)
 .. S PSJCLOK=1 D SDAUTHCL^SDAMA203(PSJCLIN,.PSJCLOK) Q:(PSJCLOK<1)
"RTN","PSJLMUTL",55,0)
 .. S ^TMP("PSJVSIT",$J,+PSJSCI,PSJCLIN,"V")=$E(PSJCLINO_PSJPAD,1,25)_"  "_$TR(PSJAPD,"@","/"),PSJCLHD=1
"RTN","PSJLMUTL",56,0)
 .. D ENC(DFN,PSJCLIN)
"RTN","PSJLMUTL",57,0)
 I $G(PSJCLHD) S PSJLN=PSJLN+1 S ^TMP("PSJALL",$J,PSJLN,0)="Clinic:"_$E(PSJPAD,1,20)_"Date/Time of Appointment:",PSJLN=PSJLN+1 I $G(PSJCLHD)=2 D
"RTN","PSJLMUTL",58,0)
 . S ^TMP("PSJALL",$J,PSJLN,0)=" Scheduling database is unavailable",PSJLN=PSJLN+1
"RTN","PSJLMUTL",59,0)
 N VDAT S VDAT=0 F  S VDAT=$O(^TMP("PSJVSIT",$J,VDAT)) Q:'VDAT  S VCLIN=0 F  S VCLIN=$O(^TMP("PSJVSIT",$J,VDAT,VCLIN)) Q:'VCLIN  D
"RTN","PSJLMUTL",60,0)
 . F VTYP="E","V" S VDATA=$G(^TMP("PSJVSIT",$J,VDAT,VCLIN,VTYP)) I VDATA]"" S ^TMP("PSJALL",$J,PSJLN,0)=VDATA,PSJLN=PSJLN+1
"RTN","PSJLMUTL",61,0)
 I $G(PSJCLHD) S VALMCNT=((PSJLN+11\11)*11),PSJX=$O(^TMP("PSJALL",$J,9999),-1) ; F I=PSJX:1:VALMCNT S ^TMP("PSJALL",$J,I,0)=""
"RTN","PSJLMUTL",62,0)
 K PSJUTL,PSJCLHD
"RTN","PSJLMUTL",63,0)
 Q
"RTN","PSJLMUTL",64,0)
 ;
"RTN","PSJLMUTL",65,0)
ENC(SDPATDFN,SDCLIEN) ;
"RTN","PSJLMUTL",66,0)
 I '$G(PSGDT) D NOW^%DTC S PSGDT=% ;*281
"RTN","PSJLMUTL",67,0)
 N SDFROM,DT,SUBVIS,VIS S SDSTART=$$FMADD^XLFDT($P(PSGDT,"."),-1),SDEND=$$FMADD^XLFDT($P(PSGDT,"."),+365) K ^TMP("VSIT",$J)
"RTN","PSJLMUTL",68,0)
 D SELECTED^VSIT(SDPATDFN,SDSTART,SDEND,SDCLIEN) N VIS S VIS=0 F  S VIS=$O(^TMP("VSIT",$J,VIS)) Q:'VIS  D
"RTN","PSJLMUTL",69,0)
 . S SUBVIS=0 F  S SUBVIS=$O(^TMP("VSIT",$J,VIS,SUBVIS)) Q:'SUBVIS  D
"RTN","PSJLMUTL",70,0)
 .. S PSJSCI=$P(^TMP("VSIT",$J,VIS,SUBVIS),U),PSJAPD=$$FMTE^XLFDT(PSJSCI,1) Q:PSJSCI<1!(PSJAPD="")
"RTN","PSJLMUTL",71,0)
 .. S ^TMP("PSJVSIT",$J,PSJSCI,PSJCLIN,"E")=$E(PSJCLINO_PSJPAD,1,25)_"  "_$TR(PSJAPD,"@","/")_" *Encounter",PSJCLHD=1
"RTN","PSJLMUTL",72,0)
 Q
"RTN","PSJLMUTL",73,0)
 ;
"RTN","PSJLMUTL",74,0)
SETNAR(SUB,NARR,TYPE) ; Set up Narrative info.
"RTN","PSJLMUTL",75,0)
 S NARR=TYPE_"patient Narrative: "_NARR,Y="" S:TYPE="In" NARR=" "_NARR
"RTN","PSJLMUTL",76,0)
 S START=1 F  D  Q:NARR=""
"RTN","PSJLMUTL",77,0)
 .I $L($P(NARR," "))>79 S PSJ=$E(NARR,START,START+79),NARR=$E(NARR,START+80,$L(NARR)) Q
"RTN","PSJLMUTL",78,0)
 .I $L(NARR)>79 S PSJ=$P(NARR," ",1,$L($E(NARR,1,80)," ")-1),NARR=$E($P(NARR,PSJ,2),2,$L(NARR)) D SET Q
"RTN","PSJLMUTL",79,0)
 .S PSJ=NARR,NARR="" D SET
"RTN","PSJLMUTL",80,0)
 Q
"RTN","PSJLMUTL",81,0)
 ;
"RTN","PSJLMUTL",82,0)
SET ; Set ^TMP for narratives.
"RTN","PSJLMUTL",83,0)
 S ^TMP(SUB,$J,PSJLN,0)=PSJ,PSJLN=PSJLN+1
"RTN","PSJLMUTL",84,0)
 Q
"RTN","PSJLMUTL",85,0)
 ;
"RTN","PSJLMUTL",86,0)
ACTIONS() ;
"RTN","PSJLMUTL",87,0)
 N DIC,X,Y
"RTN","PSJLMUTL",88,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSJLMUTL",89,0)
 I Y="PSJ LM DC" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",90,0)
 I Y="PSJU LM EDIT" Q $S(PSGACT["E":1,1:0)
"RTN","PSJLMUTL",91,0)
 I Y="PSJU LM RENEW" Q $S(PSGACT["R":1,1:0)
"RTN","PSJLMUTL",92,0)
 I Y="PSJ LM HOLD" Q $S(PSGACT["H":1,1:0)
"RTN","PSJLMUTL",93,0)
 I Y="PSJU LM VERIFY" Q $S(PSGACT["V":1,1:0)
"RTN","PSJLMUTL",94,0)
 I Y="PSJ LM EDIT NEW" Q $S(PSGACT["E":1,1:0)
"RTN","PSJLMUTL",95,0)
 I Y="PSJ LM FLAG" Q $S(PSGACT["G":1,1:0)
"RTN","PSJLMUTL",96,0)
 Q 1
"RTN","PSJLMUTL",97,0)
RNACT() ;
"RTN","PSJLMUTL",98,0)
 I '$G(PSJRNF),'$G(PSJIRNF) Q 0
"RTN","PSJLMUTL",99,0)
 NEW X S X=$G(^PS(53.1,+PSJORD,0))
"RTN","PSJLMUTL",100,0)
 S PSGACT=""
"RTN","PSJLMUTL",101,0)
 I $S(+$P(X,U,13):1,$G(PSJRNF)&($P(X,U,4)="U"):1,$G(PSJIRNF)&($P(X,U,4)'="U"):1,1:0) S PSGACT="BFDE"
"RTN","PSJLMUTL",102,0)
 NEW X,Y
"RTN","PSJLMUTL",103,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSJLMUTL",104,0)
 I Y="PSJ LM DC" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",105,0)
 I Y="PSJ LM BYPASS" Q $S(PSGACT["B":1,1:0)
"RTN","PSJLMUTL",106,0)
 I Y="PSJ LM FINISH" Q $S(PSGACT["F":1,1:0)
"RTN","PSJLMUTL",107,0)
 I Y="PSJI LM DISCONTINUE" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",108,0)
 I Y="PSJI LM EDIT" Q $S(PSGACT["E":1,1:0)
"RTN","PSJLMUTL",109,0)
 I Y="PSJI LM FINISH" Q $S(PSGACT["F":1,1:0)
"RTN","PSJLMUTL",110,0)
 I Y="PSJ LM FLAG" Q 0
"RTN","PSJLMUTL",111,0)
 Q 1
"RTN","PSJLMUTL",112,0)
 ;
"RTN","PSJLMUTL",113,0)
TECHACT() ; Allowable actions for IV technician (PSJI PHARM TECH)
"RTN","PSJLMUTL",114,0)
 Q:'$G(PSJITECH) 0
"RTN","PSJLMUTL",115,0)
 NEW X S X=$G(^PS(53.1,+PSJORD,0))
"RTN","PSJLMUTL",116,0)
 I $S(+$P(X,U,13):1,$P(X,U,4)'="U":1,1:0) S PSGACT="F"
"RTN","PSJLMUTL",117,0)
 N DIC,X,Y
"RTN","PSJLMUTL",118,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSJLMUTL",119,0)
 I Y="PSJ LM DC" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",120,0)
 I Y="PSJ LM BYPASS" Q $S(PSGACT["B":1,1:0)
"RTN","PSJLMUTL",121,0)
 I Y="PSJ LM FINISH" Q $S(PSGACT["F":1,1:0)
"RTN","PSJLMUTL",122,0)
 I Y="PSJI LM DISCONTINUE" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",123,0)
 I Y="PSJI LM EDIT" Q $S(PSGACT["E":1,1:0)
"RTN","PSJLMUTL",124,0)
 I Y="PSJI LM FINISH" Q $S(PSGACT["F":1,1:0)
"RTN","PSJLMUTL",125,0)
 I Y="PSJ LM FLAG" Q 0
"RTN","PSJLMUTL",126,0)
 Q 1
"RTN","PSJLMUTL",127,0)
PATINFO()         ; Determines if detailed allergy info can be displayed.
"RTN","PSJLMUTL",128,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSJLMUTL",129,0)
 I Y="PSJ LM SHOW PROFILE",$D(PSJLMPRO) Q 0
"RTN","PSJLMUTL",130,0)
 Q 1
"RTN","PSJLMUTL",131,0)
HIDDEN(CHK) ; Determines if certain Hidden actions are to be available.
"RTN","PSJLMUTL",132,0)
 I CHK="JUMP",'$G(PSJPNV) D NA("Jump is only available through Non-Verified/Pending Orders option.") Q 0
"RTN","PSJLMUTL",133,0)
 I CHK="SPEED",'$D(PSJUDPRF) D NA("Speed options are only available from the Unit Dose Order Entry Profile.") Q 0
"RTN","PSJLMUTL",134,0)
 ;PSJ*5*198;GMZ;Remove copy function from this option
"RTN","PSJLMUTL",135,0)
 I CHK="COPY",('$D(PSGACT)!($G(PSGACT)="")) D NA("Copy is not allowed from this option.") Q 0
"RTN","PSJLMUTL",136,0)
 Q 1
"RTN","PSJLMUTL",137,0)
 ;
"RTN","PSJLMUTL",138,0)
NA(TXT) ;
"RTN","PSJLMUTL",139,0)
 D FULL^VALM1 W !!,TXT,!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJLMUTL",140,0)
 Q
"RTN","PSJLMUTL",141,0)
 ;
"RTN","PSJLMUTL",142,0)
UPR(DFN)         ; UPDATE PATIENT SPECIFIC DATA IN 55
"RTN","PSJLMUTL",143,0)
 N DIE,DR S PSJC10=VALMCNT
"RTN","PSJLMUTL",144,0)
 S DA=DFN,DIE="^PS(55,",DR="62.2;62.01" D ^DIE,DISALL^PSJLMUTL(DFN)
"RTN","PSJLMUTL",145,0)
 S VALMCNT=PSJC10 K PSJC10
"RTN","PSJLMUTL",146,0)
 Q
"RTN","PSJLMUTL",147,0)
 ;
"RTN","PSJLMUTL",148,0)
DETALL(DFN)        ; Enter Detailed Allergy Display list.
"RTN","PSJLMUTL",149,0)
 D EN^VALM("PSJ LM ALLERGY DISPLAY")
"RTN","PSJLMUTL",150,0)
 Q
"RTN","PSJLMUTL",151,0)
BRFALL(DFN)        ;
"RTN","PSJLMUTL",152,0)
 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJLMUTL",153,0)
 Q
"RTN","PSJLMUTL",154,0)
PAUSE ;
"RTN","PSJLMUTL",155,0)
 N DIR S DIR(0)="E" D ^DIR
"RTN","PSJLMUTL",156,0)
 Q
"RTN","PSJLMUTL",157,0)
DRUGNAME(DFN,ON) ; Find drug name to display
"RTN","PSJLMUTL",158,0)
 ;If order is in 55:
"RTN","PSJLMUTL",159,0)
 ;.If Dosage Ordered is found, returns OI_U_Dosage Ordered.
"RTN","PSJLMUTL",160,0)
 ;.If no Dosage Ordered, returns Dispense Drug only.
"RTN","PSJLMUTL",161,0)
 ;If order in 53.1:
"RTN","PSJLMUTL",162,0)
 ;.If Dosage Ordered, returns OI_U_Dosage Ordered.
"RTN","PSJLMUTL",163,0)
 ;.If Dispense Drug is found, returns Dispense Drug name_U_Instructions.
"RTN","PSJLMUTL",164,0)
 ;.If no dispense drug, returns OI_U_Instructions.
"RTN","PSJLMUTL",165,0)
 I ON["U" D  Q DN
"RTN","PSJLMUTL",166,0)
 .S OIND=$G(^PS(55,DFN,5,+ON,.2))
"RTN","PSJLMUTL",167,0)
 .I $P(OIND,U,2)]"",($G(^PS(50.7,+OIND,0))]"") S DN=$$OINAME(OIND)_U_.2 Q
"RTN","PSJLMUTL",168,0)
 .S X=+$O(^PS(55,DFN,5,+ON,1,0)),X=$G(^PS(55,DFN,5,+ON,1,X,0)) I $P(X,U)]"" S DN=$$DDNAME(+X)_"^^"_$P(X,"^",2) Q  ;$S($P(OIND,U,2)]"":.2,1:.3) Q
"RTN","PSJLMUTL",169,0)
 .S DN=$$OINAME(+OIND)_U_.3 Q
"RTN","PSJLMUTL",170,0)
 S OIND=$G(^PS(53.1,+ON,.2)) Q:$P(OIND,U,2)]"" $$OINAME(OIND)_U_.2
"RTN","PSJLMUTL",171,0)
 S X=+$O(^PS(53.1,+ON,1,0)) I X,'$O(^PS(53.1,+ON,1,X)) S X=$G(^PS(53.1,+ON,1,X,0)) I $P(X,U)]"" Q $$DDNAME(+X)_U_.3_$P(X,"^",2)
"RTN","PSJLMUTL",172,0)
 Q $$OINAME(OIND)_U_.3
"RTN","PSJLMUTL",173,0)
 ;
"RTN","PSJLMUTL",174,0)
DDNAME(X) ; 
"RTN","PSJLMUTL",175,0)
 Q $$FOUND($P($G(^PSDRUG(+X,0)),U),X,"PSDRUG(,")
"RTN","PSJLMUTL",176,0)
 ;
"RTN","PSJLMUTL",177,0)
OINAME(ND) ; Return Orderable Item Name_" "_Dose Form_U_Dosage Ordered
"RTN","PSJLMUTL",178,0)
 N DF,DNME,X
"RTN","PSJLMUTL",179,0)
 S X=$G(^PS(50.7,+ND,0)),DNME="" S:X]"" DF=$P($G(^PS(50.606,+$P(X,U,2),0)),U),DNME=$P(X,U)_" "_DF
"RTN","PSJLMUTL",180,0)
 Q $$FOUND(DNME,+ND,"PS(50.7")
"RTN","PSJLMUTL",181,0)
 ;
"RTN","PSJLMUTL",182,0)
FOUND(DNME,DN,FN) ;
"RTN","PSJLMUTL",183,0)
 Q $S(DNME]"":DNME,1:"NOT FOUND "_DN_";"_FN)
"RTN","PSJMUTL")
0^24^B37714348
"RTN","PSJMUTL",1,0)
PSJMUTL ;BIR/MV - UTLILITY USE FOR QUEUING...  ;25 Nov 98  9:13 AM
"RTN","PSJMUTL",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**8,21,31,160,281**;16 DEC 97;Build 113
"RTN","PSJMUTL",3,0)
 ; References to ^PS(52.7 supported by DBIA #2173
"RTN","PSJMUTL",4,0)
 ; Reference to ^ORRDI1 is supported by DBIA 4659
"RTN","PSJMUTL",5,0)
 ; Reference to ^XTMP("ORRDI" is supported by DBIA 4660
"RTN","PSJMUTL",6,0)
 ; Reference to ^GMRADPT supported by DBIA #10099
"RTN","PSJMUTL",7,0)
SELDEV() ;*** Ask for device type for report to output to ***
"RTN","PSJMUTL",8,0)
 K IOP,%ZIS,POP,IO("Q")
"RTN","PSJMUTL",9,0)
 S %ZIS("A")="Select output device: ",%ZIS("B")="",%ZIS="Q"
"RTN","PSJMUTL",10,0)
 D ^%ZIS S PSJSTOP=$S(POP:1,1:0) I POP W !,"** No device selected or Report printed **" D EXIT
"RTN","PSJMUTL",11,0)
 Q $G(PSJSTOP)
"RTN","PSJMUTL",12,0)
 ;
"RTN","PSJMUTL",13,0)
SETSORTQ(XDESC,XSAVE,ZTRTN)     ;Queue to sort.  D SETDEV^PSJMUTL(X,Y)
"RTN","PSJMUTL",14,0)
 N I,X
"RTN","PSJMUTL",15,0)
 K IO("Q"),ZTSAVE,ZTDTH,ZTSK
"RTN","PSJMUTL",16,0)
 S ZTDESC=XDESC,PSGIO=ION,ZTIO=""
"RTN","PSJMUTL",17,0)
 S PSGIODOC="" I $G(IO("DOC"))]"" S PSGIODOC=IO("DOC")
"RTN","PSJMUTL",18,0)
 F I=1:1  S X=$P(XSAVE,";",I) Q:X=""  S ZTSAVE(X)=""
"RTN","PSJMUTL",19,0)
 D ^%ZTLOAD
"RTN","PSJMUTL",20,0)
 Q
"RTN","PSJMUTL",21,0)
 ;
"RTN","PSJMUTL",22,0)
SETPRTQ(XDESC,XSAVE,ZTRTN)         ;Queue to printer.  D SETPRTQ^PSJMUTL(X,Y)
"RTN","PSJMUTL",23,0)
 N I,X
"RTN","PSJMUTL",24,0)
 S ZTIO=PSGIO,ZTDESC=XDESC,ZTDTH=$H,%ZIS="QN",IOP=PSGIO
"RTN","PSJMUTL",25,0)
 I $G(PSGIODOC)]"" S ZTIO=ZTIO_";"_PSGIODOC
"RTN","PSJMUTL",26,0)
 F I=1:1  S X=$P(XSAVE,";",I) Q:X=""  S ZTSAVE(X)=""
"RTN","PSJMUTL",27,0)
 D ^%ZIS,^%ZTLOAD
"RTN","PSJMUTL",28,0)
 Q
"RTN","PSJMUTL",29,0)
 ;
"RTN","PSJMUTL",30,0)
EXITDEV ;
"RTN","PSJMUTL",31,0)
 I $E(IOST)="C",('$G(PSJSTOP)) K DIR W ! S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSJMUTL",32,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSJMUTL",33,0)
 S IOP="HOME" D ^%ZISC
"RTN","PSJMUTL",34,0)
 Q
"RTN","PSJMUTL",35,0)
 ;
"RTN","PSJMUTL",36,0)
PRTCHK(PGCT) ;
"RTN","PSJMUTL",37,0)
 I $E(IOST)="C",PGCT K DIR W ! S DIR(0)="E" D ^DIR S:'Y PSJSTOP=1
"RTN","PSJMUTL",38,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S (ZSTOP,PSJSTOP)=1
"RTN","PSJMUTL",39,0)
 I $G(PSJSTOP) W !!?20,"...Report stopped at user request..." K DIR S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSJMUTL",40,0)
 Q $G(PSJSTOP)
"RTN","PSJMUTL",41,0)
 ;
"RTN","PSJMUTL",42,0)
EXIT ;
"RTN","PSJMUTL",43,0)
 K %,%H,%I,%ZIS,ZTDESC,ZTDTH,ZTIO,ZTSAVE,ZTRTN
"RTN","PSJMUTL",44,0)
 W:$E(IOST)="C"&($Y) @IOF
"RTN","PSJMUTL",45,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSJMUTL",46,0)
 S IOP="HOME" D ^%ZISC
"RTN","PSJMUTL",47,0)
 Q
"RTN","PSJMUTL",48,0)
ATS(REG,EXP,LN) ;
"RTN","PSJMUTL",49,0)
 ;*** Split allergies and adverse reactions from the allergy package.
"RTN","PSJMUTL",50,0)
 ;*** INPUT ***
"RTN","PSJMUTL",51,0)
 ;*** REG - the length the allergies and adv. reactions display on 1 pg.
"RTN","PSJMUTL",52,0)
 ;*** EXP - the length that will display on extra page.
"RTN","PSJMUTL",53,0)
 ;*** LN  - for MAR, allergies and reations are display on 1 line.
"RTN","PSJMUTL",54,0)
 ;        - for Profile, display allergies and reactions on separate ln.
"RTN","PSJMUTL",55,0)
 ;*** OUTPUT ***
"RTN","PSJMUTL",56,0)
 ;*** PSGALG - Allergies array.
"RTN","PSJMUTL",57,0)
 ;*** PSGADR - Adverse Reactions array.
"RTN","PSJMUTL",58,0)
 ;***** rlw - 1/16/96 added PSGVALG for verified allergies and PSGVADR for verified adverse reactions.
"RTN","PSJMUTL",59,0)
GETGMRA ;
"RTN","PSJMUTL",60,0)
 N GMRA,GMRAL,GMRANKA,GMRAOTH,LEN,X,Y,TYPE,NAME,SORT,ALG,VALG,ADR,VADR,ALGCT,VALGCT,ADRCT,VADRCT,VERIFIED
"RTN","PSJMUTL",61,0)
 K PSGADR,PSGALG,PSGVADR,PSGVALG
"RTN","PSJMUTL",62,0)
 S (VALGCT,ALGCT,VADRCT,ADRCT,PSGVALG,PSGALG,PSGVADR,PSGADR)=0,(PSGVALG(1),PSGALG(1),PSGVADR(1),PSGADR(1))=""
"RTN","PSJMUTL",63,0)
 S:'$G(DFN)&$G(PSGP) DFN=PSGP
"RTN","PSJMUTL",64,0)
 S:'$G(PSGP)&$G(DFN) PSGP=DFN
"RTN","PSJMUTL",65,0)
 S GMRA="0^0^111",DFN=PSGP D ^GMRADPT
"RTN","PSJMUTL",66,0)
 I $G(PSJWHERE)="PSJLMUTL" S PSJGMRAL=GMRAL Q:(GMRAL="")!(GMRAL=0)
"RTN","PSJMUTL",67,0)
 I GMRAL="" S:$E(IOST)="P" (PSGVALG,PSGALG,PSGVADR,PSGADR)=20,$P(PSGALG(1),"_",20)=" ",(PSGVALG(1),PSGADR(1),PSGVADR(1))=PSGALG(1) Q
"RTN","PSJMUTL",68,0)
 I GMRAL=0 S (PSGVALG,PSGALG)=3,(PSGALG(1),PSGVALG(1))="NKA" S:$E(IOST)="P" PSGADR=20,$P(PSGADR(1),"_",20)=" ",PSGVADR=20,PSGVADR(1)=PSGADR(1) Q
"RTN","PSJMUTL",69,0)
 ;
"RTN","PSJMUTL",70,0)
SORT ;*** Set up the allergies and adv. reactions arrays.
"RTN","PSJMUTL",71,0)
 F X=0:0 S X=$O(GMRAL(X)) Q:'X  S TYPE=$P(GMRAL(X),U,5),NAME=$P(GMRAL(X),U,2),VERIFIED=$P(GMRAL(X),U,4) D
"RTN","PSJMUTL",72,0)
 .S SORT=$P(GMRAL(X),U,7),SORT=$S(SORT="D":1,SORT="DF":2,SORT="DFO":3,SORT="DO":4,SORT="F":5,SORT="FO":6,1:7)
"RTN","PSJMUTL",73,0)
 .S:(TYPE=0)&(VERIFIED=1) PSGVALG=PSGVALG+$L(NAME),VALGCT=VALGCT+1,VALG(SORT_NAME)=""
"RTN","PSJMUTL",74,0)
 .S:(TYPE=0)&(VERIFIED=0) PSGALG=PSGALG+$L(NAME),ALGCT=ALGCT+1,ALG(SORT_NAME)=""
"RTN","PSJMUTL",75,0)
 .S:(TYPE>0)&(VERIFIED=0) PSGADR=PSGADR+$L(NAME),ADRCT=ADRCT+1,ADR(SORT_NAME)=""
"RTN","PSJMUTL",76,0)
 .S:(TYPE>0)&(VERIFIED=1) PSGVADR=PSGVADR+$L(NAME),VADRCT=VADRCT+1,VADR(SORT_NAME)=""
"RTN","PSJMUTL",77,0)
 ;
"RTN","PSJMUTL",78,0)
CALLEN ;*** Calculate the total length for allergy and adv.reaction arrays.
"RTN","PSJMUTL",79,0)
 S:VALGCT>1 PSGVALG=PSGVALG+((VALGCT-1)*2) S:$E(IOST)="P"&'PSGVALG PSGVALG=20,$P(PSGVALG(1),"_",20)=" "
"RTN","PSJMUTL",80,0)
 S:ALGCT>1 PSGALG=PSGALG+((ALGCT-1)*2) S:$E(IOST)="P"&'PSGALG PSGALG=20,$P(PSGALG(1),"_",20)=" "
"RTN","PSJMUTL",81,0)
 S:VADRCT>1 PSGVADR=PSGVADR+((VADRCT-1)*2) S:$E(IOST)="P"&'PSGVADR PSGVADR=20,$P(PSGVADR(1),"_",20)=" "
"RTN","PSJMUTL",82,0)
 S:ADRCT>1 PSGADR=PSGADR+((ADRCT-1)*2) S:$E(IOST)="P"&'PSGADR PSGADR=20,$P(PSGADR(1),"_",20)=" "
"RTN","PSJMUTL",83,0)
 S (VALGCT,ALGCT,VADRCT,ADRCT)=1
"RTN","PSJMUTL",84,0)
 S:LN=1 LEN=$S((PSGALG+PSGVALG+PSGADR+PSGVADR)>REG:EXP,1:REG)
"RTN","PSJMUTL",85,0)
 S:LN>1 LEN=$S($S(PSGALG>REG:1,PSGADR>REG:1,PSGVALG>REG:1,PSGVADR>REG:1,1:0):EXP,1:REG)
"RTN","PSJMUTL",86,0)
 ;
"RTN","PSJMUTL",87,0)
SETARRAY ;*** Concatenate allergies and adv. reaction together into display len.
"RTN","PSJMUTL",88,0)
 S (X,Y)="" F  S X=$O(VALG(X)) Q:X=""  S:LEN'>($L(Y)+$L(X)+1) PSGVALG(VALGCT)=Y_",",Y="",VALGCT=VALGCT+1 S:Y]"" Y=Y_", " S Y=Y_$E(X,2,$L(X))
"RTN","PSJMUTL",89,0)
 S:$G(PSGVALG(VALGCT))="" PSGVALG(VALGCT)=Y
"RTN","PSJMUTL",90,0)
 S (X,Y)="" F  S X=$O(ALG(X)) Q:X=""  S:LEN'>($L(Y)+$L(X)+1) PSGALG(ALGCT)=Y_",",Y="",ALGCT=ALGCT+1 S:Y]"" Y=Y_", " S Y=Y_$E(X,2,$L(X))
"RTN","PSJMUTL",91,0)
 S:$G(PSGALG(ALGCT))="" PSGALG(ALGCT)=Y
"RTN","PSJMUTL",92,0)
 S (X,Y)="" F  S X=$O(ADR(X)) Q:X=""  S:LEN'>($L(Y)+$L(X)+1) PSGADR(ADRCT)=Y_",",Y="",ADRCT=ADRCT+1 S:Y]"" Y=Y_", " S Y=Y_$E(X,2,$L(X))
"RTN","PSJMUTL",93,0)
 S:$G(PSGADR(ADRCT))="" PSGADR(ADRCT)=Y
"RTN","PSJMUTL",94,0)
 S (X,Y)="" F  S X=$O(VADR(X)) Q:X=""  S:LEN'>($L(Y)+$L(X)+1) PSGVADR(VADRCT)=Y_",",Y="",VADRCT=VADRCT+1 S:Y]"" Y=Y_", " S Y=Y_$E(X,2,$L(X))
"RTN","PSJMUTL",95,0)
 S:$G(PSGVADR(VADRCT))="" PSGVADR(VADRCT)=Y
"RTN","PSJMUTL",96,0)
 Q
"RTN","PSJMUTL",97,0)
 ;
"RTN","PSJMUTL",98,0)
NAMENEED(DRGX,LEN,NEED)  ;*** Return the number of lines needed.
"RTN","PSJMUTL",99,0)
 ;*
"RTN","PSJMUTL",100,0)
 ;* DRG - AD/SOL     LEN - Drug name length   NEED - line needed
"RTN","PSJMUTL",101,0)
 ;*
"RTN","PSJMUTL",102,0)
 S NEED=0
"RTN","PSJMUTL",103,0)
 F X=0:0 S X=$O(DRG(DRGX,X)) Q:'X  D NAME^PSIVUTL(DRG(DRGX,X),LEN,.NAME,1) S NEED=NEED+$S($G(NAME(2))]"":2,1:1) I DRGX="SOL",$P(^PS(52.7,+DRG(DRGX,X),0),U,4)]"" S NEED=NEED+1
"RTN","PSJMUTL",104,0)
 Q
"RTN","PSJMUTL",105,0)
RAD ;
"RTN","PSJMUTL",106,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSJMUTL",107,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSJMUTL",108,0)
 S PSGRALG=1,PSGRALG(1)="No remote data available"
"RTN","PSJMUTL",109,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSJMUTL",110,0)
 I $T(GET^ORRDI1)]"" D GET^ORRDI1(DFN,"ART") D
"RTN","PSJMUTL",111,0)
 . N S1,REAC,A,FILE,LEN K ^TMP($J,"PSJART")
"RTN","PSJMUTL",112,0)
 . S S1=0,LEN=57,PSGRALG=1,PSGRALG(1)="" F  S S1=$O(^XTMP("ORRDI","ART",DFN,S1)) Q:'S1  D
"RTN","PSJMUTL",113,0)
 ..S A=$G(^XTMP("ORRDI","ART",DFN,S1,"GMRALLERGY",0)),REAC=$P(A,"^",2) ;RTC 231778
"RTN","PSJMUTL",114,0)
 ..Q:REAC=""  ;RTC 231778
"RTN","PSJMUTL",115,0)
 ..S FILE=$P($P(A,"^",3),"99VA",2)
"RTN","PSJMUTL",116,0)
 ..I FILE'=50.6,FILE'=120.82,FILE'=50.605,FILE'=50.416 Q
"RTN","PSJMUTL",117,0)
 ..S ^TMP($J,"PSJART",REAC)=""
"RTN","PSJMUTL",118,0)
 . S REAC="" F  S REAC=$O(^TMP($J,"PSJART",REAC)) Q:REAC=""  D
"RTN","PSJMUTL",119,0)
 .. I $L(PSGRALG(PSGRALG))+$L(REAC)<LEN S PSGRALG(PSGRALG)=PSGRALG(PSGRALG)_REAC_", " Q
"RTN","PSJMUTL",120,0)
 .. S PSGRALG=PSGRALG+1,PSGRALG(PSGRALG)="                "_REAC_", ",LEN=77
"RTN","PSJMUTL",121,0)
 . S A=$L(PSGRALG(PSGRALG)) I $E(PSGRALG(PSGRALG),A-1,A)=", " S PSGRALG(PSGRALG)=$E(PSGRALG(PSGRALG),1,A-2)
"RTN","PSJMUTL",122,0)
REMOTE2 ;
"RTN","PSJMUTL",123,0)
 S ^TMP("PSJALL",$J,PSJLN,0)="              Remote: "_$G(PSGRALG(1)),PSJLN=PSJLN+1
"RTN","PSJMUTL",124,0)
 F I=2:1:PSGRALG S ^TMP("PSJALL",$J,PSJLN,0)=PSGRALG(I),PSJLN=PSJLN+1
"RTN","PSJMUTL",125,0)
 Q 
"RTN","PSJNEWOA")
0^28^B26088515
"RTN","PSJNEWOA",1,0)
PSJNEWOA ;BIR/SAB - STORES BACKDOOR ORDER CHECKS IN FILE #100.05 ;11/08/2012
"RTN","PSJNEWOA",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**281**;16 DEC 97;Build 113
"RTN","PSJNEWOA",3,0)
 ;External reference to ^TMP("PSODAOC",$J is supported by DBIA# 6071
"RTN","PSJNEWOA",4,0)
 ;External reference to GETOC4^OROCAPI1 supported by DBIA 5729
"RTN","PSJNEWOA",5,0)
 ;External reference to ^ORD(100.05 supported by DBIA 5731
"RTN","PSJNEWOA",6,0)
 ;External reference to ^PS(55 supported by DBIA 2191
"RTN","PSJNEWOA",7,0)
 ;
"RTN","PSJNEWOA",8,0)
 ;Inpatient: When verifying order within the same session, pull allergies from non-verified order to verified order
"RTN","PSJNEWOA",9,0)
 ;called from VF1^PSJLIACT and PSJHL3
"RTN","PSJNEWOA",10,0)
VF ;unit dose or pending
"RTN","PSJNEWOA",11,0)
 Q:'$G(^TMP("PSODAOC",$J,"IP IEN"))
"RTN","PSJNEWOA",12,0)
 N PSJORET,PSJZORN,RXORDER,PSJDGVER,PSJOORD,ON55
"RTN","PSJNEWOA",13,0)
 S (PSJZORN,PSJORET,PSJOORD,PSJORET)="",PSJDGVER=1,PSJOORD=$G(^TMP("PSODAOC",$J,"IP IEN"))
"RTN","PSJNEWOA",14,0)
 I $G(PSJSPEED) S PSJOORD=$G(ON55)
"RTN","PSJNEWOA",15,0)
 S (ON55,RXORDER)=$G(^TMP("PSODAOC",$J,"IP NEW IEN"))
"RTN","PSJNEWOA",16,0)
 D VF2
"RTN","PSJNEWOA",17,0)
 Q
"RTN","PSJNEWOA",18,0)
VF1 ;IV or edit
"RTN","PSJNEWOA",19,0)
 N PSJDGORD,PSJORET,PSJZORN,RXORDER,ON55
"RTN","PSJNEWOA",20,0)
 I $G(PSIVCOPY),($G(ON55)["V") K ^TMP("PSODAOC",$J,"ALLERGY")
"RTN","PSJNEWOA",21,0)
 S (PSJZORN,PSJORET)="",(ON55,RXORDER)=$G(^TMP("PSODAOC",$J,"IP NEW IEN"))
"RTN","PSJNEWOA",22,0)
 S PSJDGORD=$G(^TMP("PSODAOC",$J,"IP IEN"))
"RTN","PSJNEWOA",23,0)
VF2 ;
"RTN","PSJNEWOA",24,0)
 I $G(PSJDGVER)&($G(PSJOORD)) D
"RTN","PSJNEWOA",25,0)
 .I PSJOORD["P"!(PSJOORD["N") S PSJZORN=+$P(^PS(53.1,+PSJOORD,0),U,21) Q
"RTN","PSJNEWOA",26,0)
 ;
"RTN","PSJNEWOA",27,0)
 I '$G(PSJREN)&('$G(PSJDGVER))&($G(PSJDGORD)) D
"RTN","PSJNEWOA",28,0)
 .I PSJDGORD["P"!(PSJDGORD["N") S PSJZORN=+$P($G(^PS(53.1,+PSJDGORD,0)),U,21) Q
"RTN","PSJNEWOA",29,0)
 .S PSJZORN=$S(PSJDGORD["V":$P($G(^PS(55,DFN,"IV",+PSJDGORD,0)),"^",21),PSJDGORD["U":$P($G(^PS(55,DFN,5,+PSJDGORD,0)),"^",21),1:"")
"RTN","PSJNEWOA",30,0)
 I $G(PSJREN)&('$G(PSJDGVER))&($G(PSJDGORD)) S PSJZORN=$S(PSJDGORD["V":$P($G(^PS(55,DFN,"IV",+PSJDGORD,0)),"^",21),PSJDGORD["U":$P($G(^PS(55,DFN,5,+PSJDGORD,0)),"^",21),1:"")
"RTN","PSJNEWOA",31,0)
 Q:'PSJZORN
"RTN","PSJNEWOA",32,0)
 D GETOC4^OROCAPI1(PSJZORN,.PSJORET)
"RTN","PSJNEWOA",33,0)
 I $O(PSJORET(PSJZORN,"DATA",""))="" K ^TMP("PSODAOC",$J) Q
"RTN","PSJNEWOA",34,0)
 ;
"RTN","PSJNEWOA",35,0)
VF3 ;
"RTN","PSJNEWOA",36,0)
 N PSJZI,PSJZIIEN,PSJNRET,PSJACNT,PSJACNT1,PSJACNT2,PSJIEN60,PSJIEN70,PSJRETI,PSJDFLAG,PSJZERO,PSOZH,PSJOZI
"RTN","PSJNEWOA",37,0)
 S (PSJACNT,PSJACNT1)=0
"RTN","PSJNEWOA",38,0)
 F PSJZI=0:0 S PSJZI=$O(PSJORET(PSJZORN,"DATA",PSJZI)) Q:'PSJZI  I $D(PSJORET(PSJZORN,"DATA",PSJZI,1)) D
"RTN","PSJNEWOA",39,0)
 .Q:+$P(PSJORET(PSJZORN,"DATA",PSJZI,1),";",2)'=3
"RTN","PSJNEWOA",40,0)
 .K PSJAIENS
"RTN","PSJNEWOA",41,0)
 .I $G(PSJOZI)'=PSJZI S PSJZIIEN=0
"RTN","PSJNEWOA",42,0)
 .S PSJOZI=PSJZI,PSJACNT=PSJACNT+1
"RTN","PSJNEWOA",43,0)
 .F  S PSJZIIEN=$O(^ORD(100.05,PSJZI,4,PSJZIIEN)) Q:PSJZIIEN=""  I $D(^ORD(100.05,PSJZI,4,PSJZIIEN,0)) D
"RTN","PSJNEWOA",44,0)
 ..Q:$P(^ORD(100.05,PSJZI,0),"^",3)["CPRS"
"RTN","PSJNEWOA",45,0)
 ..D GETS^DIQ(100.05,PSJZI,"60*","I","PSJIEN60"),GETS^DIQ(100.05,PSJZI,"70*","I","PSJIEN70")
"RTN","PSJNEWOA",46,0)
 ..S PSJDFLAG="",PSJDFLAG=$$GETORD(PSJZI,$S($G(PSJDGVER):$G(PSJOORD),1:PSJDGORD),PSJDFLAG)
"RTN","PSJNEWOA",47,0)
 ..Q:'$G(PSJDFLAG)
"RTN","PSJNEWOA",48,0)
 ..;
"RTN","PSJNEWOA",49,0)
 ..S PSJACNT1=PSJACNT1+1
"RTN","PSJNEWOA",50,0)
 ..S ^TMP("PSODAOC",$J,"ALLERGY",PSJACNT,"ALLERGY PKG")="IP^"_$S($G(PSJOCFG)]"":$P(PSJOCFG," ")_" ",1:"")_"^"_ON55_"^"_PSJZORN
"RTN","PSJNEWOA",51,0)
 ..;S:$D(^ORD(100.05,PSJZI,8)) ^TMP("PSODAOC",$J,"ALLERGY",PSJACNT,"INTERVENTION")=^ORD(100.05,PSJZI,8)
"RTN","PSJNEWOA",52,0)
 ..S ^TMP("PSODAOC",$J,"ALLERGY","PROVR")=$G(PSJORET(PSJZI,"DATA",PSJZIIEN,"OR",1,0))
"RTN","PSJNEWOA",53,0)
 ..;
"RTN","PSJNEWOA",54,0)
 ..D SETTMP
"RTN","PSJNEWOA",55,0)
 ;
"RTN","PSJNEWOA",56,0)
VF4 ;
"RTN","PSJNEWOA",57,0)
 S PSOZH="Allergy",RXORDER=ON55,PSJAOC1=1
"RTN","PSJNEWOA",58,0)
 S (ON55,RXORDER)=$G(^TMP("PSODAOC",$J,"IP NEW IEN"))
"RTN","PSJNEWOA",59,0)
 I $D(^TMP("PSODAOC",$J,"ALLERGY")) D VF2^PSJNEWOC
"RTN","PSJNEWOA",60,0)
 K ^TMP("PSODAOC",$J,"ALLERGY")
"RTN","PSJNEWOA",61,0)
 Q
"RTN","PSJNEWOA",62,0)
 ;
"RTN","PSJNEWOA",63,0)
SETTMP ;
"RTN","PSJNEWOA",64,0)
 N PSJSUBS,PSJACNT2
"RTN","PSJNEWOA",65,0)
 S ^TMP("PSODAOC",$J,"ALLERGY",PSJACNT,4,PSJZIIEN,0)=$G(^ORD(100.05,PSJZI,4,PSJZIIEN,0))
"RTN","PSJNEWOA",66,0)
 ;
"RTN","PSJNEWOA",67,0)
 I $D(^ORD(100.05,PSJZI,4,PSJZIIEN,1,0)) S PSJSUBS=1 D SET1
"RTN","PSJNEWOA",68,0)
 I $D(^ORD(100.05,PSJZI,4,PSJZIIEN,2,0)) S PSJSUBS=2 D SET1
"RTN","PSJNEWOA",69,0)
 I $D(^ORD(100.05,PSJZI,4,PSJZIIEN,3,0)) S PSJSUBS=3 D SET1
"RTN","PSJNEWOA",70,0)
 I $D(^ORD(100.05,PSJZI,5,0)) S PSJSUBS=5 D SET2
"RTN","PSJNEWOA",71,0)
 I $D(^ORD(100.05,PSJZI,11,0)) S ^TMP("PSODAOC",$J,"ALLERGY",PSJACNT,"PHARM")=^ORD(100.05,PSJZI,11,0)
"RTN","PSJNEWOA",72,0)
 ;WILL NEED TO SET PHARM INFO 100.05
"RTN","PSJNEWOA",73,0)
 Q
"RTN","PSJNEWOA",74,0)
 ;
"RTN","PSJNEWOA",75,0)
SET1 ;
"RTN","PSJNEWOA",76,0)
 F PSJACNT2=0:0 S PSJACNT2=$O(^ORD(100.05,PSJZI,4,PSJZIIEN,PSJSUBS,PSJACNT2)) Q:PSJACNT2'?1N.N  D
"RTN","PSJNEWOA",77,0)
 .I $D(^ORD(100.05,PSJZI,4,PSJZIIEN,PSJSUBS,PSJACNT2,0)) D
"RTN","PSJNEWOA",78,0)
 ..S ^TMP("PSODAOC",$J,"ALLERGY",PSJACNT,4,PSJZIIEN,PSJSUBS,PSJACNT2,0)=^ORD(100.05,PSJZI,4,PSJZIIEN,PSJSUBS,PSJACNT2,0)
"RTN","PSJNEWOA",79,0)
 Q
"RTN","PSJNEWOA",80,0)
 ;
"RTN","PSJNEWOA",81,0)
SET2 ;
"RTN","PSJNEWOA",82,0)
 F PSJACNT2=0:0 S PSJACNT2=$O(^ORD(100.05,PSJZI,PSJSUBS,PSJACNT2)) Q:PSJACNT2'?1N.N  D
"RTN","PSJNEWOA",83,0)
 .I $D(^ORD(100.05,PSJZI,PSJSUBS,PSJACNT2,0)) D
"RTN","PSJNEWOA",84,0)
 ..S ^TMP("PSODAOC",$J,"ALLERGY",PSJACNT,"ALLERGY DD",PSJSUBS,PSJACNT2,0)=^ORD(100.05,PSJZI,PSJSUBS,PSJACNT2,0)
"RTN","PSJNEWOA",85,0)
 Q
"RTN","PSJNEWOA",86,0)
 ;
"RTN","PSJNEWOA",87,0)
GETORD(PSJSUBS,PSJORDR,PSJTRUE) ;
"RTN","PSJNEWOA",88,0)
 I PSJORDR["U"!(PSJORDR["V") D
"RTN","PSJNEWOA",89,0)
 .I $D(PSJIEN70(100.11,"1,"_PSJSUBS_",",.01,"I")) S PSJRETI=PSJIEN70(100.11,"1,"_PSJSUBS_",",.01,"I") S:PSJORDR=($P(PSJRETI,";",2)_$P(PSJRETI,";")) PSJTRUE=1 Q
"RTN","PSJNEWOA",90,0)
 .I $D(PSJIEN70(100.07,"1,"_PSJSUBS_",",.01,"I")) S PSJRETI=PSJIEN70(100.07,"1,"_PSJSUBS_",",.01,"I") S:PSJORDR=($P(PSJRETI,";",2)_$P(PSJRETI,";")) PSJTRUE=1
"RTN","PSJNEWOA",91,0)
 I PSJORDR["P"!(PSJORDR["N") D 
"RTN","PSJNEWOA",92,0)
 .I $D(PSJIEN60(100.517,"1,"_PSJSUBS_",",.01,"I")) S PSJRETI=PSJIEN60(100.517,"1,"_PSJSUBS_",",.01,"I") I PSJRETI["PS(53.1" S:+PSJORDR=$P(PSJRETI,";") PSJTRUE=1 Q
"RTN","PSJNEWOA",93,0)
 .I $D(PSJIEN60(100.07,"1,"_PSJSUBS_",",.01,"I")) S PSJRETI=PSJIEN60(100.07,"1,"_PSJSUBS_",",.01,"I") I PSJRETI["PS(53.1" S:+PSJORDR=$P(PSJRETI,";") PSJTRUE=1
"RTN","PSJNEWOA",94,0)
 Q PSJTRUE
"RTN","PSJNEWOC")
0^25^B184689659
"RTN","PSJNEWOC",1,0)
PSJNEWOC ;BIR/SAB - STORES BACKDOOR ORDER CHECKS IN FILE #100.05 ;11/08/2012
"RTN","PSJNEWOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**281**;16 DEC 97;Build 113
"RTN","PSJNEWOC",3,0)
 ;External reference to SAVEOC^OROCAPI1 supported by DBIA 5729
"RTN","PSJNEWOC",4,0)
 ;External reference to ^ORD(100.05, supported by DBIA 5731
"RTN","PSJNEWOC",5,0)
 ;External reference to ^TMP("PSODAOC",$J is supported by DBIA 6071
"RTN","PSJNEWOC",6,0)
 ;External reference to DAOC^PSONEWOA is supported by DBIA 6072
"RTN","PSJNEWOC",7,0)
 ;External reference to ^PS(55 is supported by DBIA 2191
"RTN","PSJNEWOC",8,0)
 ;---------------------------------------------------------------
"RTN","PSJNEWOC",9,0)
ACT ;
"RTN","PSJNEWOC",10,0)
 ;store order checks
"RTN","PSJNEWOC",11,0)
 N PSJAOC1,DA,DR,DIC,DIE,RXORDER,X,Y
"RTN","PSJNEWOC",12,0)
 S RXORDER=$G(^TMP("PSODAOC",$J,"IP IEN")),RXN=+RXORDER  ; this set in routines that call ^PSJNEWOC
"RTN","PSJNEWOC",13,0)
 ;
"RTN","PSJNEWOC",14,0)
ACT3 ;
"RTN","PSJNEWOC",15,0)
 I '$D(^TMP("PSODAOC",$J)),$G(PSJVERFY) D  Q
"RTN","PSJNEWOC",16,0)
 .D SET3
"RTN","PSJNEWOC",17,0)
 .N ORDNUM,OCHISIEN,X,OLDOCCUR
"RTN","PSJNEWOC",18,0)
 .S ORDNUM=$$GET1^DIQ(55.06,+RXORDER_","_DFN_",",$S(RXORDER["U":66,1:110),"I")
"RTN","PSJNEWOC",19,0)
 .Q:ORDNUM=""
"RTN","PSJNEWOC",20,0)
 .I $D(^ORD(100.05,"B",ORDNUM)) D
"RTN","PSJNEWOC",21,0)
 ..S OCHISIEN="" F  S OCHISIEN=$O(^ORD(100.05,"B",ORDNUM,OCHISIEN)) Q:OCHISIEN=""  D
"RTN","PSJNEWOC",22,0)
 ...K DA,DIC,DIE,DR
"RTN","PSJNEWOC",23,0)
 ...S DA=OCHISIEN,DIE="^ORD(100.05,",DR="2///"_PSJDAOC
"RTN","PSJNEWOC",24,0)
 ...D ^DIE
"RTN","PSJNEWOC",25,0)
 ;
"RTN","PSJNEWOC",26,0)
ACT2 ;
"RTN","PSJNEWOC",27,0)
 ;I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D NORDI^PSJNEWO1
"RTN","PSJNEWOC",28,0)
 ;I $G(^TMP("PSJDAOC",$J,"CLOZ",0))]"" S PSOZH="Clozapine" D CLOZ^PSONEWO1
"RTN","PSJNEWOC",29,0)
 ;I $D(^TMP("PSJDAOC",$J,"CROC")) D CROCLOG^PSJCROC
"RTN","PSJNEWOC",30,0)
 ;I $D(^TMP($J,"CROCIV")) D CRIVLOG^PSJCROC
"RTN","PSJNEWOC",31,0)
 I $D(^TMP("PSODAOC",$J,"ALLERGY")) S PSJAOC1=1 D DAOC K PSJAOC1 ;drug allergies
"RTN","PSJNEWOC",32,0)
 ;I $D(^TMP("PSJDAOC",$J,"DI",0))]"" S PSJKIND="DI",PSJZH="Drug Interaction" D SET ;drug interaction
"RTN","PSJNEWOC",33,0)
 ;I $D(^TMP("PSJDAOC",$J,"DT")) S PSJKIND="DT",PSJZH="Duplicate Therapy" D SET ;dup drug therapy
"RTN","PSJNEWOC",34,0)
 ;I $O(^TMP("PSJDAOC",$J,"CPRS",0)) D CPRS ;cprs order checks
"RTN","PSJNEWOC",35,0)
 ;I $G(^TMP("PSJDAOC",$J,"NOSYS",1,0))]"" D NOSYS ;fdb down
"RTN","PSJNEWOC",36,0)
 ;I $O(^TMP("PSJDAOC",$J,"EXEC",0)) D EXEC ;order chk execeptions
"RTN","PSJNEWOC",37,0)
 ;I $O(^TMP("PSJDAOC",$J,"DRG","ERROR",0))!($O(^TMP("PSJDAOC",$J,"THP","ERROR",0))) D ERROR ;order chk errors
"RTN","PSJNEWOC",38,0)
 ;I $O(^TMP("PSJDAOC",$J,"DOSE","ERROR",0)) D DERROR^PSJNEWO1 ;dosing order chk errors
"RTN","PSJNEWOC",39,0)
 ;I $O(^TMP("PSJDAOC",$J,"DOSE","EXEC",0)) D DEXEC^PSJNEWO1 ;dosing order chk exceptions
"RTN","PSJNEWOC",40,0)
 ;I $O(^TMP("PSJDAOC",$J,"DOSE","MSG",0)) D DMSG^PSJNEWO1 ;dosing order chk messages
"RTN","PSJNEWOC",41,0)
 ;I $G(^TMP("PSJDAOC",$J,"DOSE NOSYS",1,0))]"" D NODSYS^PSJNEWO1 ;dosing fdb down
"RTN","PSJNEWOC",42,0)
 ;;K ^TMP("PSJDAOC",$J) killed elsewhere
"RTN","PSJNEWOC",43,0)
 K RET,PSJDAOC,PI,ZORMGS,RXN
"RTN","PSJNEWOC",44,0)
 Q
"RTN","PSJNEWOC",45,0)
 ;
"RTN","PSJNEWOC",46,0)
VF1(PSGORD) ;
"RTN","PSJNEWOC",47,0)
 ;Q:+$G(PSGORD)=""
"RTN","PSJNEWOC",48,0)
 N RXORDER,DA,DR,DIC,DIE,PSJAOC1,X,Y
"RTN","PSJNEWOC",49,0)
 S RXORDER=$G(^TMP("PSODAOC",$J,"IP NEW IEN"))
"RTN","PSJNEWOC",50,0)
 D ACT3
"RTN","PSJNEWOC",51,0)
 Q
"RTN","PSJNEWOC",52,0)
 ;
"RTN","PSJNEWOC",53,0)
VF2 ;verify within same session
"RTN","PSJNEWOC",54,0)
 N PSJAOC1,DA,DR,DIC,DIE,RXORDER,X,Y
"RTN","PSJNEWOC",55,0)
 S PSJAOC1=1,RXORDER=$G(^TMP("PSODAOC",$J,"IP NEW IEN"))
"RTN","PSJNEWOC",56,0)
 D DAOC^PSONEWOA
"RTN","PSJNEWOC",57,0)
 I '$G(PSJREN) D
"RTN","PSJNEWOC",58,0)
 .; -- RTC 227903 - r 544306095 w $J for IP IEN and IP NEW IEN
"RTN","PSJNEWOC",59,0)
 .K ^TMP("PSODAOC",$J,"ALLERGY"),^TMP("PSODAOC",$J,"IP IEN"),^TMP("PSODAOC",$J,"IP NEW IEN")
"RTN","PSJNEWOC",60,0)
 Q
"RTN","PSJNEWOC",61,0)
 ;
"RTN","PSJNEWOC",62,0)
DAOC ;allergy
"RTN","PSJNEWOC",63,0)
 N PSJDATA
"RTN","PSJNEWOC",64,0)
 S PSJDATA="IP",PSJDATA=PSJDATA_"^"_$S($D(PSJOCFG):PSJOCFG,1:"")_"^"_RXORDER_"^"_$G(ORN)
"RTN","PSJNEWOC",65,0)
 S ^TMP("PSODAOC",$J,"ALLERGY","ALLERGY PKG")=PSJDATA
"RTN","PSJNEWOC",66,0)
 S PSOZH="Allergy"
"RTN","PSJNEWOC",67,0)
 D DAOC^PSONEWOA
"RTN","PSJNEWOC",68,0)
 I '$G(PSJREN) D
"RTN","PSJNEWOC",69,0)
 .; -- RTC 227903 - r 544306095 w $J for IP IEN and IP NEW IEN
"RTN","PSJNEWOC",70,0)
 .K ^TMP("PSODAOC",$J,"ALLERGY"),^TMP("PSODAOC",$J,"IP IEN"),^TMP("PSODAOC",$J,"IP NEW IEN")
"RTN","PSJNEWOC",71,0)
 Q
"RTN","PSJNEWOC",72,0)
 ;
"RTN","PSJNEWOC",73,0)
SET ;DEFINED 100.05
"RTN","PSJNEWOC",74,0)
 N DA,DR,DIC,DIE,OCCDT,ORN,ORL,RET,SEV,ZOC,ZZX,ZTOT,ZDRG,ZORT,ZCHK,ZCLZ,ZX,PSJDAOCN,PSOSTYP,CLASS,CLASSIEN,STATUS,ODA,ZVA,ADDSOLS
"RTN","PSJNEWOC",75,0)
 S RXN=+RXORDER
"RTN","PSJNEWOC",76,0)
 ;S PSJDAOC=$$LBL(RXN)
"RTN","PSJNEWOC",77,0)
 S OCCDT=$$NOW^XLFDT ;,ORN=$P(^PSRX(RXN,"OR1"),"^",2),ZCLZ=""
"RTN","PSJNEWOC",78,0)
 S ORN=$S(RXORDER["N"!(RXORDER["P"):$$GET1^DIQ(53.1,RXN,49),RXORDER["U":$$GET1^DIQ(55.06,RXN_","_DFN_",",66),RXORDER["V":$$GET1^DIQ(55.01,RXN_","_DFN_",",110),1:-1)
"RTN","PSJNEWOC",79,0)
 Q:ORN=-1
"RTN","PSJNEWOC",80,0)
 ;
"RTN","PSJNEWOC",81,0)
BEGIN ;
"RTN","PSJNEWOC",82,0)
 S (ZCLZ,SEV,ZVA)="",ZX=0
"RTN","PSJNEWOC",83,0)
 F  S SEV=$O(^TMP("PSJDAOC",$J,PSJKIND,SEV)) Q:SEV=""!(SEV="Z")  F  S ZVA=$O(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA)) Q:ZVA=""  D
"RTN","PSJNEWOC",84,0)
 .N IT,SEVERITY S (PSOSTYP,SEVERITY,IT,ODA)=""
"RTN","PSJNEWOC",85,0)
 .K DA,DR,DIC,DIE
"RTN","PSJNEWOC",86,0)
 .D GETADD
"RTN","PSJNEWOC",87,0)
 .I PSJKIND="DI" D
"RTN","PSJNEWOC",88,0)
 ..S IT=$G(^TMP("PSJDAOC",$J,"DI","Z","INT")),SEVERITY=$S(SEV="C":18,1:31)
"RTN","PSJNEWOC",89,0)
 .I PSJKIND="DT" S SEVERITY=17
"RTN","PSJNEWOC",90,0)
 .K DA,RET,ORL
"RTN","PSJNEWOC",91,0)
 .D SET3
"RTN","PSJNEWOC",92,0)
 .S ORL(1,1)=ORN_"^"_PSJDAOC_"^"_DUZ_"^"_OCCDT_"^"_SEVERITY_"^"
"RTN","PSJNEWOC",93,0)
 .I $L($P(ORL(1,1),"^",2))>40 S $P(ORL(1,1),"^",2)=$E($P(ORL(1,1),"^",2),1,40)
"RTN","PSJNEWOC",94,0)
 .S ORL(1,2,1)=PSJZH_" exists for this medication."
"RTN","PSJNEWOC",95,0)
 .D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSJNEWOC",96,0)
 .S DA=$O(RET(1,0)) Q:'DA
"RTN","PSJNEWOC",97,0)
 .S:ODA'=DA ODA=DA
"RTN","PSJNEWOC",98,0)
 .S DR="1///6"
"RTN","PSJNEWOC",99,0)
 .S:$G(IT) DR=DR_";81///"_IT
"RTN","PSJNEWOC",100,0)
 .S DIE="^ORD(100.05,",DR=DR_$S(PSJKIND="DI":";83///"_SEV_";84///C",PSJKIND="DD":";84///V",1:";84///C")
"RTN","PSJNEWOC",101,0)
 .I $E(DR,1)=";" S DR=$E(DR,2,999)
"RTN","PSJNEWOC",102,0)
 .D ^DIE
"RTN","PSJNEWOC",103,0)
 .D SET2
"RTN","PSJNEWOC",104,0)
 Q
"RTN","PSJNEWOC",105,0)
 ;
"RTN","PSJNEWOC",106,0)
SET2 ;
"RTN","PSJNEWOC",107,0)
 ; #50 - DISPENSE DRUGS^100.06PA^^5;0
"RTN","PSJNEWOC",108,0)
 I $D(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,50)) S X="",X=$O(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,50,X)) D
"RTN","PSJNEWOC",109,0)
 .K DIC,DIE
"RTN","PSJNEWOC",110,0)
 .S DA(1)=DA,DIC="^ORD(100.05,"_DA(1)_",5,",DIC(0)="Z"
"RTN","PSJNEWOC",111,0)
 .D FILE^DICN
"RTN","PSJNEWOC",112,0)
 ;
"RTN","PSJNEWOC",113,0)
GRP1 ;
"RTN","PSJNEWOC",114,0)
 ; #60 - GROUP ONE PHARMACY ORDERS^100.07VA^^6;0
"RTN","PSJNEWOC",115,0)
 ; OP PENDING ORDERS - IEN;PS(52.41,
"RTN","PSJNEWOC",116,0)
 ; IP RX - IEN;PS(53.1,
"RTN","PSJNEWOC",117,0)
 ; OP RX - IEN;PSRX(
"RTN","PSJNEWOC",118,0)
 N ZORT,ZIEN,NODE
"RTN","PSJNEWOC",119,0)
 S ZX=0 K DIC,DIE
"RTN","PSJNEWOC",120,0)
 I $D(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,60)) F  S ZX=$O(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,60,ZX)) Q:'ZX!(ZX="CL")  D
"RTN","PSJNEWOC",121,0)
 .S ZORT="",ZORT=^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,60,ZX,0)
"RTN","PSJNEWOC",122,0)
 .S DA(1)=DA,X=ZORT,DIC="^ORD(100.05,"_DA(1)_",6,",DIC(0)="Z"
"RTN","PSJNEWOC",123,0)
 .D FILE^DICN
"RTN","PSJNEWOC",124,0)
 .K DIC
"RTN","PSJNEWOC",125,0)
 .S ODA(1)=DA(1)
"RTN","PSJNEWOC",126,0)
 .S NODE=6 D IV
"RTN","PSJNEWOC",127,0)
 ;
"RTN","PSJNEWOC",128,0)
GRP2 ;
"RTN","PSJNEWOC",129,0)
 ;GROUP TWO PHARMACY ORDER FIELD (#70)
"RTN","PSJNEWOC",130,0)
 ;Data is formatted as follows:
"RTN","PSJNEWOC",131,0)
 ;"N;ien" => Non-VA Medications  ^PS(55,DFN,"NVA",ien)
"RTN","PSJNEWOC",132,0)
 ;"R;rx#" => Remote Outpatient   ^PSRX(ien  Prescription Number
"RTN","PSJNEWOC",133,0)
 ;^TMP("PSJDAOC",545384920,"DI","C","WARFARIN NA 10MG TAB",70,1,0)="R;1^7134039^ACTIVE^BOISE, ID"
"RTN","PSJNEWOC",134,0)
 N PSJRSITE,PSJRIEN,PSJRSTAT,PSJRIEN,PSJRSTAT,PSJRSITE,PSJRSITI,PSJRDRG,PSJREMD
"RTN","PSJNEWOC",135,0)
 S ZX=0,(PSJRIEN,PSJRSITE,PSJREMD)=""
"RTN","PSJNEWOC",136,0)
 I $D(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,70)) F  S ZX=$O(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,70,ZX)) Q:'ZX  D
"RTN","PSJNEWOC",137,0)
 .S ZORT="",ZORT=^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,70,ZX,0)
"RTN","PSJNEWOC",138,0)
 .S (PSJRIEN,PSJRSITI,PSJRSITE)=""
"RTN","PSJNEWOC",139,0)
 .;I $P(ZORT,";")="R" S PSJRIEN=$P(ZORT,"^",2),PSJRSITE=$P(ZORT,"^",4),PSJRSITI=$O(^DIC(4,"B",PSJRSITE,PSJRSITI)),PSJRDRG=$P(ZORT,"^",5),ZORT="R;"_PSJRIEN
"RTN","PSJNEWOC",140,0)
 .I $P(ZORT,";")="R" D
"RTN","PSJNEWOC",141,0)
 ..S PSJRIEN=$P($P(ZORT,"^"),";",2),PSJRSITE=$P($P(ZORT,"^"),";",3),PSJRDRG=$P(ZORT,"^",2)
"RTN","PSJNEWOC",142,0)
 ..S:PSJRSITE'="" PSJRSITI=$O(^DIC(4,"B",PSJRSITE,PSJRSITI))
"RTN","PSJNEWOC",143,0)
 ..S ZORT="R;"_PSJRIEN_"^"_PSJRSITI
"RTN","PSJNEWOC",144,0)
 .K DIC
"RTN","PSJNEWOC",145,0)
 .S DA(1)=DA,X=ZORT,DIC="^ORD(100.05,"_DA(1)_",7,",DIC(0)="Z"
"RTN","PSJNEWOC",146,0)
 .D FILE^DICN
"RTN","PSJNEWOC",147,0)
 .S NODE=7 D IV
"RTN","PSJNEWOC",148,0)
 ;
"RTN","PSJNEWOC",149,0)
CLINEFF ;clinical effects
"RTN","PSJNEWOC",150,0)
 ;TMP("PSJDAOC",545384920,"DI","C","WARFARIN NA 10MG TAB","CL",0)
"RTN","PSJNEWOC",151,0)
 N PSJFILE,PSJIENS,PSJCLEFF,DIWL,DIWR,DIWF,DINUM,DR,OLDX,OLD,PSJER
"RTN","PSJNEWOC",152,0)
 Q:'$D(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"CL",1,0))
"RTN","PSJNEWOC",153,0)
 K DIC,DIE,DR,^UTILITY($J,"W")
"RTN","PSJNEWOC",154,0)
 S DIWL=1,DIWR=78,DIWF="",(DINUM,PSJCLEFF,OLDX)=""
"RTN","PSJNEWOC",155,0)
 I SEV="S" S X="*** Refer to MONOGRAPH for SIGNIFICANT INTERACTION CLINICAL EFFECTS" D ^DIWP G CLINEFF1
"RTN","PSJNEWOC",156,0)
 F  S PSJCLEFF=$O(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"CL",PSJCLEFF)) Q:PSJCLEFF=""  D  S OLDX=X
"RTN","PSJNEWOC",157,0)
 .S X="",X=^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"CL",PSJCLEFF,0) I X'=OLDX D ^DIWP
"RTN","PSJNEWOC",158,0)
CLINEFF1 ;
"RTN","PSJNEWOC",159,0)
 K DA,DIC,DIE,DR,DIR
"RTN","PSJNEWOC",160,0)
 S DA(1)=ODA
"RTN","PSJNEWOC",161,0)
 S X="",DIC="^ORD(100.05,"_DA(1)_",10,",DIC(0)="Z"
"RTN","PSJNEWOC",162,0)
 S (DA,DINUM)=$O(^ORD(100.05,DA(1),10,9999),-1)+1
"RTN","PSJNEWOC",163,0)
 D FILE^DICN
"RTN","PSJNEWOC",164,0)
 K DIC,DIE,DR,DIR
"RTN","PSJNEWOC",165,0)
 S PSJFILE=100.05,PSJCLEFF="",PSJCLEFF=$NA(^UTILITY($J,"W",1))
"RTN","PSJNEWOC",166,0)
 D WP^DIE(PSJFILE,DA(1),100,"",PSJCLEFF,"PSJER")
"RTN","PSJNEWOC",167,0)
 K ^UTILITY($J,"W")
"RTN","PSJNEWOC",168,0)
 ;
"RTN","PSJNEWOC",169,0)
 ;for some strange reason if you put the following code before CLINEFF the clinical effects aren't stored.
"RTN","PSJNEWOC",170,0)
 K DIC,DIE,DIR,DA
"RTN","PSJNEWOC",171,0)
 S DA=ODA
"RTN","PSJNEWOC",172,0)
 I $P(ZORT,";")="R" D
"RTN","PSJNEWOC",173,0)
 .S DIE="^ORD(100.05,"_DA_",7,",DA(2)=DA,DA(1)=7,DR="2///"_PSJRSITI
"RTN","PSJNEWOC",174,0)
 .S DA=99999,(PSJREMD,DA)=$O(^ORD(100.05,DA(2),7,DA),-1)
"RTN","PSJNEWOC",175,0)
 .D ^DIE
"RTN","PSJNEWOC",176,0)
 Q
"RTN","PSJNEWOC",177,0)
 ;
"RTN","PSJNEWOC",178,0)
IV ;IV additive and solutions
"RTN","PSJNEWOC",179,0)
 N ZSIEN,DACNT,NODE2,IVTYPE,IVSOL,DA,DIE,DR,DIC
"RTN","PSJNEWOC",180,0)
 S (ZSIEN,IVSOL,ZIEN,DACNT)="",ZSIEN=$P(ZORT,";",2)_$P(ZORT,";"),NODE2=1
"RTN","PSJNEWOC",181,0)
 I $D(ADDSOLS(ZSIEN)) F IVTYPE="A","S" F  S ZIEN=$O(ADDSOLS(ZSIEN,IVTYPE,ZIEN)) Q:ZIEN=""  D
"RTN","PSJNEWOC",182,0)
 .I IVTYPE="S"&('$G(IVSOL)) S DACNT="",NODE2=2,IVSOL=1
"RTN","PSJNEWOC",183,0)
 .S DACNT=DACNT+1
"RTN","PSJNEWOC",184,0)
 .D ADDSOL
"RTN","PSJNEWOC",185,0)
 Q
"RTN","PSJNEWOC",186,0)
 ;
"RTN","PSJNEWOC",187,0)
ADDSOL ;set interacting Additives and solutions for IV's
"RTN","PSJNEWOC",188,0)
 ;^TMP("PSJDAOC",545555046,"DI","C","FLUCONAZOLE 100 MG","ADD",1,0)="36V^38"
"RTN","PSJNEWOC",189,0)
 N IVIENS,DINUM,X,LAYGO,PSOCNT,X
"RTN","PSJNEWOC",190,0)
 S (DA,DA(2),DA(1),X)="",DA(2)=ODA,DA(1)=DACNT,PSOCNT=0
"RTN","PSJNEWOC",191,0)
 S LAYGO=$S(NODE=6&(IVTYPE="A"):100.14,NODE=6&(IVTYPE="S"):100.72,NODE=7&(IVTYPE="A"):100.113,NODE=7&(IVTYPE="S"):100.114)
"RTN","PSJNEWOC",192,0)
 S DIC="^ORD(100.05,"_DA(2)_","_NODE_","_DACNT_","_NODE2_",",DIC(0)="LZ"
"RTN","PSJNEWOC",193,0)
 S (DA,DINUM)=$O(^ORD(100.05,DA(2),NODE,DACNT,NODE2,9999),-1)+1
"RTN","PSJNEWOC",194,0)
 S X=ZIEN,DR=".01///"_X
"RTN","PSJNEWOC",195,0)
 D FILE^DICN K DD,DO
"RTN","PSJNEWOC",196,0)
 Q
"RTN","PSJNEWOC",197,0)
 ;
"RTN","PSJNEWOC",198,0)
GETADD ;interacting Additives for IV's
"RTN","PSJNEWOC",199,0)
 N IVIENS
"RTN","PSJNEWOC",200,0)
 I $D(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"ADD")) F  S ZX=$O(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"ADD",ZX)) Q:'ZX  D
"RTN","PSJNEWOC",201,0)
 .S IVIENS="",IVIENS=^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"ADD",ZX,0)
"RTN","PSJNEWOC",202,0)
 .S ADDSOLS($P(IVIENS,"^"),"A",$P(IVIENS,"^",2))=""
"RTN","PSJNEWOC",203,0)
 ;
"RTN","PSJNEWOC",204,0)
GETSOLS ;interacting solutions for IV's
"RTN","PSJNEWOC",205,0)
 I $D(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"SOL")) F  S ZX=$O(^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"SOL",ZX)) Q:'ZX  D
"RTN","PSJNEWOC",206,0)
 .S IVIENS="",IVIENS=^TMP("PSJDAOC",$J,PSJKIND,SEV,ZVA,"SOL",ZX,0)
"RTN","PSJNEWOC",207,0)
 .S ADDSOLS("S",$P(IVIENS,"^"),"S",$P(IVIENS,"^",2))=""
"RTN","PSJNEWOC",208,0)
 Q
"RTN","PSJNEWOC",209,0)
 ;
"RTN","PSJNEWOC",210,0)
SET3 ;
"RTN","PSJNEWOC",211,0)
 ; set the variables needed for all order checks
"RTN","PSJNEWOC",212,0)
 N PSJVER,STOP,SETORDER
"RTN","PSJNEWOC",213,0)
 S:'$D(PSJOCFG) PSJOCFG=""
"RTN","PSJNEWOC",214,0)
 I '$G(PSJEDITO),$G(PSJVFY) D  Q:$G(STOP)
"RTN","PSJNEWOC",215,0)
 .I PSJORD["P",PSJORD'=PSGORD D
"RTN","PSJNEWOC",216,0)
 ..Q:PSGORD=""
"RTN","PSJNEWOC",217,0)
 ..S PSJDAOC="IP "_$S(PSGORD["U":"UD",PSGORD["V":"IV",$G(ON55)["V":"IV",$G(ON55)["U":"UD",1:"")_" RPh Verification "_$S($G(PSJOCFG)]"":$P(PSJOCFG," ")_" ",1:""),STOP=1
"RTN","PSJNEWOC",218,0)
 ;
"RTN","PSJNEWOC",219,0)
 I $G(PSIEDITO) D  Q:$G(STOP)
"RTN","PSJNEWOC",220,0)
 .I '$G(PSIOCVFY) D
"RTN","PSJNEWOC",221,0)
 ..S PSJDAOC="IP Pending Non-Verified "_$S($G(PSJOCFG)]"":$P(PSJOCFG," ")_" ",1:""),STOP=1
"RTN","PSJNEWOC",222,0)
 ;
"RTN","PSJNEWOC",223,0)
 I $G(PSIOCVFY)!(PSJOCFG["RENEW") D  Q:$G(STOP)
"RTN","PSJNEWOC",224,0)
 .S PSJVER="",PSJVER=$S(RXORDER["P"&(PSGORD["U"):"UD",RXORDER["U":"UD",RXORDER["P"&(PSGORD["V"):"IV",RXORDER["V":"IV",$D(^PS(53.1,+RXORDER)):"IV",$G(ON55)["V":"IV",$G(ON55)["U":"UD",1:"")
"RTN","PSJNEWOC",225,0)
 .S PSJDAOC="IP "_PSJVER_" RPh Verification "_$S($G(PSJOCFG)]"":$P(PSJOCFG," ")_" ",1:""),STOP=1
"RTN","PSJNEWOC",226,0)
 .K PSIEDITO
"RTN","PSJNEWOC",227,0)
 ;
"RTN","PSJNEWOC",228,0)
 S PSJDAOC="IP "_$S($G(PSJOCFG)]"":$P(PSJOCFG," ")_" ",1:"")
"RTN","PSJNEWOC",229,0)
 S PSJDAOC=$S(PSJORD["P"!(PSJORD["N"):"IP Pending Non-Verified "_$S($G(PSJOCFG)]"":$P(PSJOCFG," ")_" ",1:""),PSJORD["U"!(PSJORD["V"):"IP RPh Verification ",1:"")
"RTN","PSJNEWOC",230,0)
 ;I $D(^PS(55,+RXORDER)) D
"RTN","PSJNEWOC",231,0)
 I $G(PSJVERFY)!($G(PSIOCVFY)) D
"RTN","PSJNEWOC",232,0)
 .S PSJVER=$S(RXORDER["P"&(PSGORD["U"):"UD",RXORDER["U":"UD",RXORDER["P"&(PSGORD["V"):"IV",RXORDER["V":"IV",$G(ON55)["V":"IV",$G(ON55)["U":"UD",1:"")
"RTN","PSJNEWOC",233,0)
 .S PSJDAOC="IP "_PSJVER_" RPh Verification "_$S($G(PSJOCFG)]"":$P(PSJOCFG," ")_" ",1:"")
"RTN","PSJNEWOC",234,0)
 Q
"RTN","PSJNEWOC",235,0)
 ;
"RTN","PSJNEWOC",236,0)
CPRS N XZX,ZORMSG,ZDRG F XZX=0:0 S XZX=$O(^TMP("PSJDAOC",$J,"CPRS",XZX)) Q:'XZX  D CPRSA
"RTN","PSJNEWOC",237,0)
 K ^TMP("PSJDAOC",$J,"CPRS")
"RTN","PSJNEWOC",238,0)
 Q
"RTN","PSJNEWOC",239,0)
CPRSA N DA,OCCDT,ORL,Z,RET,ORTY,ZDRG,ORN,RXN
"RTN","PSJNEWOC",240,0)
 S RXN=+RXORDER
"RTN","PSJNEWOC",241,0)
 S ORN=$S(RXORDER["N"!(RXORDER["P"):$$GET1^DIQ(53.1,RXN,49),RXORDER["U":$$GET1^DIQ(55.06,RXN_","_DFN_",",66),RXORDER["V":$$GET1^DIQ(55.01,RXN_","_DFN_",",110),1:-1)
"RTN","PSJNEWOC",242,0)
 Q:ORN=-1
"RTN","PSJNEWOC",243,0)
 S OCCDT=$$NOW^XLFDT
"RTN","PSJNEWOC",244,0)
 S ZDRG=$P(^TMP("PSJDAOC",$J,"CPRS",XZX,0),"^"),ZORMGS=$P(^(0),"^",2),ORTY=$P(^(0),"^",3)
"RTN","PSJNEWOC",245,0)
 D SET3
"RTN","PSJNEWOC",246,0)
 S ORL(1,1)=ORN_"^"_PSJDAOC_"^"_DUZ_"^"_OCCDT_"^"_ORTY_"^"
"RTN","PSJNEWOC",247,0)
 I $L($P(ORL(1,1),"^",2))>40 S $P(ORL(1,1),"^",2)=$E($P(ORL(1,1),"^",2),1,40)
"RTN","PSJNEWOC",248,0)
 S ORL(1,2,1)=ZORMGS
"RTN","PSJNEWOC",249,0)
 D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSJNEWOC",250,0)
 S DA=$O(RET(1,0)) Q:'DA
"RTN","PSJNEWOC",251,0)
 S DIE="^ORD(100.05,",DR="1///6;84///V" D ^DIE
"RTN","PSJNEWOC",252,0)
 D
"RTN","PSJNEWOC",253,0)
 .N DIC  ; #50 - DISPENSE DRUGS^100.06PA^^5;0
"RTN","PSJNEWOC",254,0)
 .S DA(1)=DA,X=ZDRG,DIC="^ORD(100.05,"_DA(1)_",5,",DIC(0)="Z"
"RTN","PSJNEWOC",255,0)
 .D FILE^DICN
"RTN","PSJNEWOC",256,0)
 D
"RTN","PSJNEWOC",257,0)
 .N DIC  ; #70 - GROUP TWO PHARMACY ORDERS^100.11A^^7;0
"RTN","PSJNEWOC",258,0)
 .;S X=faux variable pointer based on order type
"RTN","PSJNEWOC",259,0)
 .;Data is formatted as follows:
"RTN","PSJNEWOC",260,0)
 .; 
"RTN","PSJNEWOC",261,0)
 .;"N;ien" => Non-VA Medications
"RTN","PSJNEWOC",262,0)
 .;           ^PS(55,DFN,"NVA",ien)
"RTN","PSJNEWOC",263,0)
 .; 
"RTN","PSJNEWOC",264,0)
 .;"R;rx#" => Remote Outpatient
"RTN","PSJNEWOC",265,0)
 .;           Prescription Number
"RTN","PSJNEWOC",266,0)
 .; 
"RTN","PSJNEWOC",267,0)
 .;"U;ien" => Unit Dose Medications
"RTN","PSJNEWOC",268,0)
 .;           ^PS(55,DFN,5,ien)
"RTN","PSJNEWOC",269,0)
 .; 
"RTN","PSJNEWOC",270,0)
 .;"V;ien" => IV Medications
"RTN","PSJNEWOC",271,0)
 .;           ^PS(55,DFN,"IV",ien)
"RTN","PSJNEWOC",272,0)
 .;S X=$S(RXORDER["P":"P;"_+RXORDER_";PS(53.11",RXORDER["U":"U;"_+RXORDER_";PS(55,"_DFN_",5,",RXORDER["V":"V;"_+RXORDER_";PS(55,"_DFN_",IV",RXORDER["N":"N;"_+RXORDER_";PS(55.05,"_DFN_",NVA")
"RTN","PSJNEWOC",273,0)
 .S X=$S(RXORDER["P":"P;"_+RXORDER,RXORDER["U":"U;"_+RXORDER,RXORDER["V":"V;"_+RXORDER,RXORDER["N":"N;"_+RXORDER)
"RTN","PSJNEWOC",274,0)
 .S DA(1)=DA,DIC="^ORD(100.05,"_DA(1)_",7,",DIC(0)="Z"
"RTN","PSJNEWOC",275,0)
 .D FILE^DICN
"RTN","PSJNEWOC",276,0)
 .Q
"RTN","PSJNEWOC",277,0)
 Q
"RTN","PSJNEWOC",278,0)
 ;
"RTN","PSJNEWOC",279,0)
NOSYS ;
"RTN","PSJNEWOC",280,0)
 N DA,OCCDT,ORL,Z,RET,PSJDAOC,RXN,ORN
"RTN","PSJNEWOC",281,0)
 S RXN=+RXORDER
"RTN","PSJNEWOC",282,0)
 S ORN=$S(RXORDER["N"!(RXORDER["P"):$$GET1^DIQ(53.1,RXN,49),RXORDER["U":$$GET1^DIQ(55.06,RXN_","_DFN_",",66),RXORDER["V":$$GET1^DIQ(55.01,RXN_","_DFN_",",110),1:-1)
"RTN","PSJNEWOC",283,0)
 Q:ORN=-1
"RTN","PSJNEWOC",284,0)
 S OCCDT=$$NOW^XLFDT
"RTN","PSJNEWOC",285,0)
 D SET3
"RTN","PSJNEWOC",286,0)
 S ORL(1,1)=ORN_"^"_PSJDAOC_"^"_DUZ_"^"_OCCDT_"^25^"
"RTN","PSJNEWOC",287,0)
 I $L($P(ORL(1,1),"^",2))>40 S $P(ORL(1,1),"^",2)=$E($P(ORL(1,1),"^",2),1,40)
"RTN","PSJNEWOC",288,0)
 S ORL(1,2,1)="Order Checks could not be done, please complete a manual check for Drug Interactions and Duplicate Therapy. "_^TMP("PSJDAOC",$J,"NOSYS",1,0)
"RTN","PSJNEWOC",289,0)
 D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSJNEWOC",290,0)
 S DA=$O(RET(1,0)) Q:'DA
"RTN","PSJNEWOC",291,0)
 S DIE="^ORD(100.05,",DR="84///C" D ^DIE
"RTN","PSJNEWOC",292,0)
 Q
"RTN","PSJNEWOC",293,0)
EXEC ;order chk exeception
"RTN","PSJNEWOC",294,0)
 N DA,OCCDT,ORL,RET,SEV,ZOC,ZZX,ZTOT,ZDRG,ZORT,ZCHK,ORN,RXN
"RTN","PSJNEWOC",295,0)
 S RXN=+RXORDER
"RTN","PSJNEWOC",296,0)
 S ORN=$S(RXORDER["N"!(RXORDER["P"):$$GET1^DIQ(53.1,RXN,49),RXORDER["U":$$GET1^DIQ(55.06,RXN_","_DFN_",",66),RXORDER["V":$$GET1^DIQ(55.01,RXN_","_DFN_",",110),1:-1)
"RTN","PSJNEWOC",297,0)
 Q:ORN=-1
"RTN","PSJNEWOC",298,0)
 F ZOC=0:0 S ZOC=$O(^TMP("PSJDAOC",$J,"EXEC",ZOC)) Q:'ZOC  D
"RTN","PSJNEWOC",299,0)
 .S OCCDT=$$NOW^XLFDT
"RTN","PSJNEWOC",300,0)
 .D SET3
"RTN","PSJNEWOC",301,0)
 .S ORL(1,1)=ORN_"^"_PSJDAOC_"^"_DUZ_"^"_OCCDT_"^25^"
"RTN","PSJNEWOC",302,0)
 .I $L($P(ORL(1,1),"^",2))>40 S $P(ORL(1,1),"^",2)=$E($P(ORL(1,1),"^",2),1,40)
"RTN","PSJNEWOC",303,0)
 .S ORL(1,2,1)=^TMP("PSJDAOC",$J,"EXEC",ZOC)
"RTN","PSJNEWOC",304,0)
 .D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSJNEWOC",305,0)
 .S DA=$O(RET(1,0)) Q:'DA
"RTN","PSJNEWOC",306,0)
 .S DIE="^ORD(100.05,",DR="84///C" D ^DIE
"RTN","PSJNEWOC",307,0)
 .Q
"RTN","PSJNEWOC",308,0)
 Q
"RTN","PSJNEWOC",309,0)
ERROR ;order drug chk errors
"RTN","PSJNEWOC",310,0)
 N DA,OCCDT,ORL,Z,RET,PSJDAOC,RX,ORN,RXN
"RTN","PSJNEWOC",311,0)
 S RXN=+RXORDER
"RTN","PSJNEWOC",312,0)
 S ORN=$S(RXORDER["N"!(RXORDER["P"):$$GET1^DIQ(53.1,RXN,49),RXORDER["U":$$GET1^DIQ(55.06,RXN_","_DFN_",",66),RXORDER["V":$$GET1^DIQ(55.01,RXN_","_DFN_",",110),1:-1)
"RTN","PSJNEWOC",313,0)
 Q:ORN=-1
"RTN","PSJNEWOC",314,0)
 F ZOC=0:0 S ZOC=$O(^TMP("PSJDAOC",$J,"DRG","ERROR",ZOC)) Q:'ZOC  D
"RTN","PSJNEWOC",315,0)
 .S OCCDT=$$NOW^XLFDT
"RTN","PSJNEWOC",316,0)
 .D SET3
"RTN","PSJNEWOC",317,0)
 .S ORL(1,1)=ORN_"^"_PSJDAOC_"^"_DUZ_"^"_OCCDT_"^25^"
"RTN","PSJNEWOC",318,0)
 .I $L($P(ORL(1,1),"^",2))>40 S $P(ORL(1,1),"^",2)=$E($P(ORL(1,1),"^",2),1,40)
"RTN","PSJNEWOC",319,0)
 .S ORL(1,2,1)=^TMP("PSJDAOC",$J,"DRG","ERROR",ZOC)
"RTN","PSJNEWOC",320,0)
 .D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSJNEWOC",321,0)
 .S DA=$O(RET(1,0)) Q:'DA
"RTN","PSJNEWOC",322,0)
 .S DIE="^ORD(100.05,",DR="84///C" D ^DIE
"RTN","PSJNEWOC",323,0)
 .Q
"RTN","PSJNEWOC",324,0)
 ;
"RTN","PSJNEWOC",325,0)
 N DA,OCCDT,ORL,Z,RET,PSJDAOC,RXN,ORN
"RTN","PSJNEWOC",326,0)
 S RXN=+RXORDER
"RTN","PSJNEWOC",327,0)
 S ORN=$S(RXORDER["N"!(RXORDER["P"):$$GET1^DIQ(53.1,RXN,49),RXORDER["U":$$GET1^DIQ(55.06,RXN_","_DFN_",",66),RXORDER["V":$$GET1^DIQ(55.01,RXN_","_DFN_",",110),1:-1)
"RTN","PSJNEWOC",328,0)
 Q:ORN=-1
"RTN","PSJNEWOC",329,0)
 F ZOC=0:0 S ZOC=$O(^TMP("PSODAOC",$J,"THP","ERROR",ZOC)) Q:'ZOC  D
"RTN","PSJNEWOC",330,0)
 .S OCCDT=$$NOW^XLFDT
"RTN","PSJNEWOC",331,0)
 .D SET3
"RTN","PSJNEWOC",332,0)
 .S ORL(1,1)=ORN_"^"_PSJDAOC_"^"_DUZ_"^"_OCCDT_"^25^"
"RTN","PSJNEWOC",333,0)
 .S ORL(1,2,1)=^TMP("PSODAOC",$J,"THP","ERROR",ZOC)
"RTN","PSJNEWOC",334,0)
 .D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSJNEWOC",335,0)
 .S DA=$O(RET(1,0)) Q:'DA
"RTN","PSJNEWOC",336,0)
 .S DIE="^ORD(100.05,",DR="84///C" D ^DIE
"RTN","PSJNEWOC",337,0)
 .Q
"RTN","PSJNEWOC",338,0)
 Q
"RTN","PSJNEWOC",339,0)
 ;
"RTN","PSJNEWOC",340,0)
SETOC(PSJORDNM) ;SET ORDER CHECKS IN TO FILE 100.05
"RTN","PSJNEWOC",341,0)
 ;PSJ*5*260
"RTN","PSJNEWOC",342,0)
 ;verify within same session - store allergies just seen for non-verified order
"RTN","PSJNEWOC",343,0)
 Q:'$G(PSJORDNM)
"RTN","PSJNEWOC",344,0)
 N PSJORDN1,X,Y,DIR,DIC,DIE,DR,DA S PSJORDN1=PSJORDNM
"RTN","PSJNEWOC",345,0)
 I '$D(^TMP("PSODAOC",$J,"ALLERGY")) D
"RTN","PSJNEWOC",346,0)
 .D VF1^PSJNEWOA ;IV
"RTN","PSJNEWOC",347,0)
 ;
"RTN","PSJNEWOC",348,0)
 I $D(^TMP("PSODAOC",$J,"ALLERGY")) D
"RTN","PSJNEWOC",349,0)
 .N DA,OCCDT,ORN,ORL,Z,RET,PSJDAOC,RXN
"RTN","PSJNEWOC",350,0)
 .S RXORDER=PSJORDN1
"RTN","PSJNEWOC",351,0)
 .S RXN=+RXORDER,^TMP("PSODAOC",$J,"IP IEN")=RXORDER  ;set up which IEN will be used to store order checks
"RTN","PSJNEWOC",352,0)
 .S PSJDAOC="IP "_$S(RXORDER["P":"Pending/Non-Verified",RXORDER["U":"UD",RXORDER["V":"IV",1:"")_" Allergy",OCCDT=$$NOW^XLFDT
"RTN","PSJNEWOC",353,0)
 .I RXORDER["P" S ORN=$P(^PS(53.1,+RXORDER,0),U,21)
"RTN","PSJNEWOC",354,0)
 .I RXORDER["U" S ORN=$P(^PS(55,DFN,5,+RXORDER,0),U,21)
"RTN","PSJNEWOC",355,0)
 .I RXORDER["V" S ORN=$P(^PS(55,DFN,"IV",+RXORDER,0),U,21)
"RTN","PSJNEWOC",356,0)
 .Q:'$G(ORN)
"RTN","PSJNEWOC",357,0)
 .D DAOC2
"RTN","PSJNEWOC",358,0)
 Q
"RTN","PSJNEWOC",359,0)
 ;
"RTN","PSJNEWOC",360,0)
DAOC2 ;I +$G(PSGORD) S ^TMP("PSODAOC",$J,"IP IEN")=PSGORD   ;set up which IEN will be used to store order checks
"RTN","PSJNEWOC",361,0)
 D ACT^PSJNEWOC ;psj*5*281 stores order checks
"RTN","PSJNEWOC",362,0)
 Q:$G(PSJEDITO)!($G(PSIEDITO))
"RTN","PSJNEWOC",363,0)
 Q
"RTN","PSJOC")
0^5^B62583664
"RTN","PSJOC",1,0)
PSJOC ;BIR/MV - NEW ORDER CHECKS DRIVER ; 9/10/14 10:53pm
"RTN","PSJOC",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,260,252,257,281**;16 DEC 97;Build 113
"RTN","PSJOC",3,0)
 ;
"RTN","PSJOC",4,0)
 ; Reference to ^PSODDPR4 is supported by DBIA# 5366.
"RTN","PSJOC",5,0)
 ; Reference to ^PSSHRQ2 is supported by DBIA# 5369.
"RTN","PSJOC",6,0)
 ;
"RTN","PSJOC",7,0)
OC(PSPDRG,PSJPTYP) ;
"RTN","PSJOC",8,0)
 ;PSPDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug Name
"RTN","PSJOC",9,0)
 ;Where n is a sequential number.  The Drug Name can be OI, Generic name from #50, or Add/Sol name
"RTN","PSJOC",10,0)
 ;PSJPTYP - P1 ; P2
"RTN","PSJOC",11,0)
 ; Where P1 is "I" for Inpatient, "O" for Outpatient
"RTN","PSJOC",12,0)
 ;       P2 is the Inpatient Order Number (for PSJ use only)
"RTN","PSJOC",13,0)
 ;PSJOCERR(DRUG NAME)="Reason text". Where Drug Name can be either OI name or AD/SOL name.
"RTN","PSJOC",14,0)
 NEW PSJOCERR
"RTN","PSJOC",15,0)
 ;Quit OC if FDB link is down.  PSGORQF is defined if user wish to stop the order process
"RTN","PSJOC",16,0)
 I $$SYS^PSJOCERR() Q
"RTN","PSJOC",17,0)
 ;
"RTN","PSJOC",18,0)
 I $D(PSJDGCK) W !!,"Building MEDS profile please wait...",!
"RTN","PSJOC",19,0)
 D BLD^PSODDPR4(DFN,"PSJPRE",.PSPDRG,PSJPTYP)
"RTN","PSJOC",20,0)
 D DISPLAY
"RTN","PSJOC",21,0)
 K ^TMP($J,"PSJPRE")
"RTN","PSJOC",22,0)
 Q
"RTN","PSJOC",23,0)
DISPLAY ;
"RTN","PSJOC",24,0)
 NEW PSJPAUSE,PSJOLDSV,PSJDNM,PSJMON,PSJOC,PSJOCDT,PSJOCDTL,PSJOCLST,PSJP,PSJS,PSJPON,PSJDN,PSJSEV,PSJECNT
"RTN","PSJOC",25,0)
 N CROCLN,CROCLN2,PSJTOFFL,PSJCROCF,PSJDRGIF,PSJDERF2,PSJDUPTF
"RTN","PSJOC",26,0)
 D FULL^VALM1 W @IOF
"RTN","PSJOC",27,0)
 D GMRAOC Q:$G(PSGORQF)
"RTN","PSJOC",28,0)
 S $P(CROCLN,"=",75)="=",$P(CROCLN2,"-",75)="-",CROCNR=1
"RTN","PSJOC",29,0)
 I '$D(PSJDGCKX) D
"RTN","PSJOC",30,0)
 .I '$D(TMPDRG1("AD",0))&('$D(TMPDRG1("SOL",0)))&($G(PSPDRG(1))) D CK^PSJCROC($P(PSPDRG(1),"^")) I $G(PSGORQF) Q
"RTN","PSJOC",31,0)
 .I $G(TMPDRG1("AD",0))>0!$G(TMPDRG1("SOL",0))>0 W "Now processing Clinical Reminder Order Checks. Please wait ..."
"RTN","PSJOC",32,0)
 .I $G(TMPDRG1("AD",0))>0 F CRIV=0:0 S CRIV=$O(TMPDRG1("AD",CRIV)) Q:'CRIV  D CKIV^PSJCROC($P(TMPDRG1("AD",CRIV),"^",1),"A")
"RTN","PSJOC",33,0)
 .I $G(TMPDRG1("SOL",0))>0 F CRIV=0:0 S CRIV=$O(TMPDRG1("SOL",CRIV)) Q:'CRIV  D CKIV^PSJCROC($P(TMPDRG1("SOL",CRIV),"^",1),"S")
"RTN","PSJOC",34,0)
 .I $G(TMPDRG1("AD",0))>0!$G(TMPDRG1("SOL",0))>0 D CKIVD^PSJCROC I $G(PSGORQF) S VALMBCK="R" Q
"RTN","PSJOC",35,0)
 K CRIV,CROCPFLG,CROCNR,PSJDGCKX
"RTN","PSJOC",36,0)
 I $G(PSGORQF) Q
"RTN","PSJOC",37,0)
 Q:'$$DSPSERR()
"RTN","PSJOC",38,0)
 W !!,"Now Processing Enhanced Order Checks! Please wait...",! S PSJTOFFL=1
"RTN","PSJOC",39,0)
 ; If there are no OC or errors to display, this var will trigger a pause before continue /w the order
"RTN","PSJOC",40,0)
 S PSJPAUSE=1
"RTN","PSJOC",41,0)
 D DRUGERR
"RTN","PSJOC",42,0)
 I $D(PSJDGCK) W:'$D(^TMP($J,"PSJPRE","OUT","DRUGDRUG"))&'$D(^TMP($J,"PSJPRE","OUT","THERAPY",1)) !,"No Order Check Warnings Found",!
"RTN","PSJOC",43,0)
 ;Process drug interaction & drug interception
"RTN","PSJOC",44,0)
 D DI^PSJOCDI
"RTN","PSJOC",45,0)
 Q:$G(PSGORQF)
"RTN","PSJOC",46,0)
 D DSPERR^PSJOCERR("DRUGDRUG")
"RTN","PSJOC",47,0)
 ;Process duplicate therapy order checks
"RTN","PSJOC",48,0)
 D:'$D(PSJDGCK) DT^PSJOCDT
"RTN","PSJOC",49,0)
 I $D(PSJDGCK) D:$D(^TMP($J,"PSJPRE","OUT","THERAPY")) DTDGCK^PSJOCDT
"RTN","PSJOC",50,0)
 D:'$G(PSGORQF) DSPERR^PSJOCERR("THERAPY")
"RTN","PSJOC",51,0)
 I '$G(PSJTOFFL) W !!,"Now Processing Enhanced Order Checks! Please wait...",! I $G(PSIVCOPY)&('$D(PSJDGCK)) D PAUSE^PSJLMUT1
"RTN","PSJOC",52,0)
 I $D(PSJDGCK),'$D(^TMP($J,"PSJPRE","OUT","THERAPY")) D PAUSE^PSJLMUT1 Q  ;DX action
"RTN","PSJOC",53,0)
 Q:$G(PSGORQF)
"RTN","PSJOC",54,0)
 I '$G(PSJDERF2)&('$G(PSJDRGIF))&('$G(PSJDUPTF)) K PSJPAUSE H 2
"RTN","PSJOC",55,0)
 I $G(PSJDERF2)&('$G(PSJDRGIF))&('$G(PSJDUPTF))&(($Y+3)<IOSL) S PSJPAUSE=1 ;error but no drug interaction or dup therapy
"RTN","PSJOC",56,0)
 ;I ($G(PSGCOPY)!($G(PSIVCOPY))) S PSJPAUSE=1
"RTN","PSJOC",57,0)
 I '$D(PSJDGCK) D:$G(PSJPAUSE) PAUSE^PSJLMUT1
"RTN","PSJOC",58,0)
 Q
"RTN","PSJOC",59,0)
 ;
"RTN","PSJOC",60,0)
GMRAOC ;Display allergy & CPRS OC regardless if FDB is connected
"RTN","PSJOC",61,0)
 D ALLERGY Q:$G(PSGORQF)
"RTN","PSJOC",62,0)
 D CPRS^PSJOCOR(.PSPDRG)
"RTN","PSJOC",63,0)
 Q
"RTN","PSJOC",64,0)
ALLERGY ;Do allergy order check
"RTN","PSJOC",65,0)
 ;The allergy check will be processed for each of the dispense drug stores in the PSJALLGY array
"RTN","PSJOC",66,0)
 ;PSJALLGY(X)="" Where X is the disp drug IEN.  PSJALLGY array store all dispense drugs use in an order
"RTN","PSJOC",67,0)
 ;
"RTN","PSJOC",68,0)
 D FULL^VALM1
"RTN","PSJOC",69,0)
 I $G(PSIALLFL) K PSIALLFL Q
"RTN","PSJOC",70,0)
 W !!,"Now doing allergy checks.  Please wait..."
"RTN","PSJOC",71,0)
 N PSJAOC,DACNT,PSJDGFLG,PSJDGDRG S PSJAOC=1
"RTN","PSJOC",72,0)
 I '$D(PSJDGCK) D   ;sort by generic dispensed drug name
"RTN","PSJOC",73,0)
 .NEW PSJDD,PSJGDDN,PSJALGCT,PSJALLGS S PSJDD=""
"RTN","PSJOC",74,0)
 .F  S PSJDD=$O(PSJALLGY(PSJDD)) Q:'PSJDD!(PSJDD'?1N.N)  S PSJGDDN="",PSJGDDN=$$GET1^DIQ(50,PSJDD,.01) D
"RTN","PSJOC",75,0)
 ..I PSJGDDN="" S PSJALLGY("AA",PSJDD_"Z",PSJDD)="" Q
"RTN","PSJOC",76,0)
 ..S PSJALLGY("AA",PSJGDDN,PSJDD)=""
"RTN","PSJOC",77,0)
 .S (PSJDD,PSJGGDN)=""
"RTN","PSJOC",78,0)
 .F  S PSJGGDN=$O(PSJALLGY("AA",PSJGGDN)) Q:PSJGGDN=""!($G(PSGORQF))  F  S PSJDD=$O(PSJALLGY("AA",PSJGGDN,PSJDD)) Q:PSJDD=""!($G(PSGORQF))  D
"RTN","PSJOC",79,0)
 ..S PSJALGCT=$G(PSJALGCT)+1 D EN^PSJGMRA(DFN,PSJDD)
"RTN","PSJOC",80,0)
 K PSJALLGY("AA")
"RTN","PSJOC",81,0)
 I $D(PSJDGCK) D  ;CK ACTION
"RTN","PSJOC",82,0)
 .S PSJXX="" F  S PSJXX=$O(PSJALLGY(PSJXX)) Q:PSJXX=""!(PSJXX'?1N.N)  D
"RTN","PSJOC",83,0)
 ..S PSJGDDN="",PSJGDDN=$$GET1^DIQ(50,PSJXX,.01)
"RTN","PSJOC",84,0)
 ..I PSJGDDN="" S PSJALLGY($S(PSJALLGY(PSJXX)="P":"A",1:"Z"),PSJDD_"Z",PSJGDDN,PSJXX)="" Q
"RTN","PSJOC",85,0)
 ..S PSJALLGY($S(PSJALLGY(PSJXX)="P":"A",1:"Z"),PSJGDDN,PSJXX)=""
"RTN","PSJOC",86,0)
 .S (PSJALLGS,PSJXX,PSJGDDN)="",(PSJDGFLG,PSJYY)=1
"RTN","PSJOC",87,0)
 .F  S PSJXX=$O(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJXX)) Q:PSJXX=""  D
"RTN","PSJOC",88,0)
 ..S PSJCKDRG=$P(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJXX),U,3)
"RTN","PSJOC",89,0)
 ..S PSJGDDN=$$GET1^DIQ(50,PSJCKDRG,.01)
"RTN","PSJOC",90,0)
 ..S PSJALLGY($S($G(PSJALLGY(PSJCKDRG))="P":"A",1:"Z"),PSJGDDN_"Z",PSJCKDRG)=""
"RTN","PSJOC",91,0)
 ..I $G(PSJALLGY(PSJCKDRG))="P",$D(PSJALLGY("A",PSJGDDN,PSJCKDRG)) K PSJALLGY("A",PSJGDDN,PSJCKDRG)
"RTN","PSJOC",92,0)
 ..I $D(PSJALLGY(PSJCKDRG)) K PSJALLGY(PSJCKDRG)
"RTN","PSJOC",93,0)
 .S (PSJCC,PSJDD)=""
"RTN","PSJOC",94,0)
 .;CK action - If the manually entered drug is same as a profile drug, display as a profile drug.
"RTN","PSJOC",95,0)
 .F  S PSJDD=$O(PSJALLGY("A",PSJDD)) Q:PSJDD=""  F  S PSJCC=$O(PSJALLGY("A",PSJDD,PSJCC)) Q:PSJCC=""  D
"RTN","PSJOC",96,0)
 ..I $D(PSJALLGY("Z",PSJDD,PSJCC)) K PSJALLGY("A",PSJDD,PSJCC)
"RTN","PSJOC",97,0)
 .S (PSJALLGS,PSJDD,PSJCC)=""
"RTN","PSJOC",98,0)
 .F  S PSJALLGS=$O(PSJALLGY(PSJALLGS)) Q:PSJALLGS=""  F  S PSJCC=$O(PSJALLGY(PSJALLGS,PSJCC)) Q:PSJCC=""!($G(PSGORQF))  D
"RTN","PSJOC",99,0)
 ..F  S PSJDD=$O(PSJALLGY(PSJALLGS,PSJCC,PSJDD)) Q:PSJDD=""!($G(PSGORQF))  S:PSJALLGS="A" PSJDGFLG=0 D EN^PSJGMRA(DFN,PSJDD) S PSJDGFLG=1
"RTN","PSJOC",100,0)
 K PSJXX,PSJYY,PSJDD,PSJCC,PSJALLGY,DACNT,PSJGGDN
"RTN","PSJOC",101,0)
 Q
"RTN","PSJOC",102,0)
DSPORD(ON,PSJNLST,PSJCLINF) ;Display the order data
"RTN","PSJOC",103,0)
 ;ON - ON_U/V/P ex: 21V
"RTN","PSJOC",104,0)
 ;PSJNLST - It's number list and also use to trigger pg break, line break
"RTN","PSJOC",105,0)
 NEW PSJCOL,PSJX,PSJOC,PSJLINE,X
"RTN","PSJOC",106,0)
 Q:ON=""
"RTN","PSJOC",107,0)
 S:'$D(PSJCLINF) PSJCLINF=";0"
"RTN","PSJOC",108,0)
 S PSJLINE=1,PSJCOL=1
"RTN","PSJOC",109,0)
 I $P(PSJCLINF,";",2) D CLNDISP^PSJCLNOC(.PSJCLINF) D  Q
"RTN","PSJOC",110,0)
 .I $G(PSJNLST)="",(($Y+6)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",111,0)
 I ON'["V" D DSPLORDU^PSJLMUT1(DFN,ON)
"RTN","PSJOC",112,0)
 I ON["V" D DSPLORDV^PSJLMUT1(DFN,ON)
"RTN","PSJOC",113,0)
 F PSJX=0:0 S PSJX=$O(PSJOC(ON,PSJX)) Q:'PSJX  D
"RTN","PSJOC",114,0)
 . I $G(PSJNLST)="",(($Y+6)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",115,0)
 . W !
"RTN","PSJOC",116,0)
 . I $G(PSJNLST) W:(PSJX=1) PSJNLST W:(PSJX>1) ?$L(PSJNLST)
"RTN","PSJOC",117,0)
 . S X=PSJOC(ON,PSJX)
"RTN","PSJOC",118,0)
 . W $E(X,9,$L(X))
"RTN","PSJOC",119,0)
 W !
"RTN","PSJOC",120,0)
 Q
"RTN","PSJOC",121,0)
 ;
"RTN","PSJOC",122,0)
DRUGERR ;Display drug level errors
"RTN","PSJOC",123,0)
 NEW PSJPON,PSJN,PSJNV,PSJDSPFG,PSJPERR,PSJX,PSJLINEF
"RTN","PSJOC",124,0)
 ;Only display the exceptions once per patient. Use the exception from prospective drug if exception(s) existed for the 
"RTN","PSJOC",125,0)
 ; same drug on the profile.
"RTN","PSJOC",126,0)
 ;PSJEXCPT(PSJDNM_REASON) - Array for invalid drugs that already display to once within a pt selection
"RTN","PSJOC",127,0)
 S PSJDSPFG=0
"RTN","PSJOC",128,0)
 S PSJPERR=$$PROSPERR()
"RTN","PSJOC",129,0)
 I PSJPERR D  Q
"RTN","PSJOC",130,0)
 . I PSJDSPFG&(($Y+4)>IOSL) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",131,0)
 I $D(PSJEXCPT("PROFILE")),'$G(PSJDGCK) Q
"RTN","PSJOC",132,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",133,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOC",134,0)
 .. I '$G(PSJLINEF) W ! S PSJLINEF=1
"RTN","PSJOC",135,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOC",136,0)
 .. ;I ($P(PSJPON,";",3)="PROSPECTIVE") S PSJX='$$ERRCHK("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10))
"RTN","PSJOC",137,0)
 .. I ($P(PSJPON,";",3)'="PROFILE") Q
"RTN","PSJOC",138,0)
 .. I '$$ERRCHK("PROFILE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOC",139,0)
 .. D DSPDRGER()
"RTN","PSJOC",140,0)
 I PSJDSPFG&(($Y+4)>IOSL) D PAUSE^PSJLMUT1 W @IOF S PSJDERR2=1
"RTN","PSJOC",141,0)
 Q
"RTN","PSJOC",142,0)
DSPDRGER(PSJDSFLG) ;
"RTN","PSJOC",143,0)
 NEW PSJTXT
"RTN","PSJOC",144,0)
 S PSJTXT=$P(PSJNV,U,7)
"RTN","PSJOC",145,0)
 ;W:$G(PSGCOPY)!($G(PSIVCOPY)) !
"RTN","PSJOC",146,0)
 S X="Enhanced Order Checks cannot "
"RTN","PSJOC",147,0)
 I $G(PSJDSFLG),(PSJTXT[X) S PSJTXT="Dosing Checks could not "_$P(PSJTXT,X,2)
"RTN","PSJOC",148,0)
 S PSJDSPFG=1
"RTN","PSJOC",149,0)
 K PSJPAUSE
"RTN","PSJOC",150,0)
 I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOC",151,0)
 W !
"RTN","PSJOC",152,0)
 D WRITE^PSJMISC(PSJTXT,,79)
"RTN","PSJOC",153,0)
 I $P(PSJNV,U,10)]"" D WRITE^PSJMISC("Reason(s): "_$P(PSJNV,U,10),3,79) S PSJDERF2=1
"RTN","PSJOC",154,0)
 ;W !
"RTN","PSJOC",155,0)
 Q
"RTN","PSJOC",156,0)
ERRCHK(PSJTYPE,PSJX) ;
"RTN","PSJOC",157,0)
 ;PSJTYPE - Either "PROFILE" or "PROSPECTIVE"
"RTN","PSJOC",158,0)
 ;PSJX - Drug name_Error reason
"RTN","PSJOC",159,0)
 ;Return 1 if this error drug has not displayed to the user.
"RTN","PSJOC",160,0)
 I $G(PSJX)="" Q 0
"RTN","PSJOC",161,0)
 I $G(PSJTYPE)="" Q 0
"RTN","PSJOC",162,0)
 ;I PSJTYPE="PROFILE",'$D(PSJEXCPT(PSJTYPE,PSJX)) S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",163,0)
 I PSJTYPE="PROFILE" S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",164,0)
 I PSJTYPE="PROSPECTIVE",'$D(PSJEXCPT(PSJTYPE,PSJX)) S PSJEXCPT(PSJTYPE,PSJX)="" Q 1
"RTN","PSJOC",165,0)
 Q 0
"RTN","PSJOC",166,0)
PING(PSJMSG) ;Check if FDB is down.  Return 0 if it is
"RTN","PSJOC",167,0)
 ;pass in a message to customize the display
"RTN","PSJOC",168,0)
 S ^TMP($J,"PSJPRE","IN","PING")=""
"RTN","PSJOC",169,0)
 D IN^PSSHRQ2("PSJPRE")
"RTN","PSJOC",170,0)
 Q $$DSPSERR($G(PSJMSG))
"RTN","PSJOC",171,0)
DSPSERR(PSJMSG) ;Display system errors
"RTN","PSJOC",172,0)
 NEW X
"RTN","PSJOC",173,0)
 S X=$G(^TMP($J,"PSJPRE","OUT",0))
"RTN","PSJOC",174,0)
 I $P(X,U)=-1 D NOFDB($P(X,U,2),$G(PSJMSG))
"RTN","PSJOC",175,0)
 Q $S($P(X,U)=-1:0,1:1)
"RTN","PSJOC",176,0)
NOFDB(PSJX,PSJMSG) ;Display connection down message
"RTN","PSJOC",177,0)
 NEW X
"RTN","PSJOC",178,0)
 Q:$G(PSJX)=""
"RTN","PSJOC",179,0)
 I $G(PSJMSG)]"" W !!,"Maximum Single Dose Check could not be performed"
"RTN","PSJOC",180,0)
 I $G(PSJMSG)="" W !!,"No Enhanced Order Checks can be performed."
"RTN","PSJOC",181,0)
 W !,"   Reason(s): ",PSJX,!!
"RTN","PSJOC",182,0)
 K PSJX
"RTN","PSJOC",183,0)
 D:$G(PSJMSG)["Maximum Single" PAUSE^PSJLMUT1
"RTN","PSJOC",184,0)
 Q
"RTN","PSJOC",185,0)
PROSPERR() ;Display exceptions for prospective drug
"RTN","PSJOC",186,0)
 NEW PSJPON,PSJN,PSJNV,PSJPERR
"RTN","PSJOC",187,0)
 ;If all prospectives are caught in the exception then display them only and omit the profile drugs
"RTN","PSJOC",188,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",189,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOC",190,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOC",191,0)
 .. I $P(PSJPON,";",3)="PROFILE" Q 
"RTN","PSJOC",192,0)
 .. I ($P(PSJPON,";",3)="PROSPECTIVE") S PSJX='$$ERRCHK("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10))
"RTN","PSJOC",193,0)
 .. D DSPDRGER() S PSJDSPFG=1
"RTN","PSJOC",194,0)
 ;If the prospective drug(s) is caught in the exception, the exception for profile drug(s) is not display.
"RTN","PSJOC",195,0)
 ;  The exception for the prospective is the only one need to display.
"RTN","PSJOC",196,0)
 S PSJPERR=1
"RTN","PSJOC",197,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOC",198,0)
 . I $D(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q
"RTN","PSJOC",199,0)
 . S (PSJDSPFG,PSJPERR)=0
"RTN","PSJOC",200,0)
 Q PSJPERR
"RTN","PSJOCDI")
0^6^B167459978
"RTN","PSJOCDI",1,0)
PSJOCDI ;BIR/MV - DISPLAY DRUG INTERACTION ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCDI",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,260,252,257,281**;16 DEC 97;Build 113
"RTN","PSJOCDI",3,0)
 ;Reference to ^PSODRDU2 is supported by DBIA #2189
"RTN","PSJOCDI",4,0)
 ;Reference to ^PS(55 is supported by DBIA #2191
"RTN","PSJOCDI",5,0)
 ;
"RTN","PSJOCDI",6,0)
DI ;
"RTN","PSJOCDI",7,0)
 NEW PSJDN,PSJDNM,PSJMON,PSJOCLST,PSJPON,PSJSEV,PSJHDR,PSJRDI,PSJ2,PSJONFLG,PSJCRTCL,PSJSORT,PSJGROUP,PSJCLINF,PSJDXOPT
"RTN","PSJOCDI",8,0)
 ;If interception occurred, display message to user
"RTN","PSJOCDI",9,0)
 ;
"RTN","PSJOCDI",10,0)
 ;Store VUID from Remote data in PSJRDI(PSJON)=VUID.
"RTN","PSJOCDI",11,0)
 D RDIVUID
"RTN","PSJOCDI",12,0)
 S PSJ2=0
"RTN","PSJOCDI",13,0)
 ;Loop through drug drug order checks output
"RTN","PSJOCDI",14,0)
 S PSJSEV="" F  S PSJSEV=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV)) Q:PSJSEV=""!($G(PSGORQF))  D
"RTN","PSJOCDI",15,0)
 . S PSJDNM="" F  S PSJDNM=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM)) Q:PSJDNM=""!($G(PSGORQF))  D
"RTN","PSJOCDI",16,0)
 .. S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON)) Q:PSJPON=""!($G(PSGORQF))  D
"RTN","PSJOCDI",17,0)
 ... S PSJCLINF="",PSJDXOPT=$S($G(PSJDGCK):"PROSPECTIVE",1:"PROFILE")
"RTN","PSJOCDI",18,0)
 ... S PSJCLINF="",PSJCLINF=$P($G(^TMP($J,"PSJPRE","IN",PSJDXOPT,PSJPON)),"^",7)
"RTN","PSJOCDI",19,0)
 ... F PSJDN=0:0 S PSJDN=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN)) Q:'PSJDN!($G(PSGORQF))  D SORTORD
"RTN","PSJOCDI",20,0)
 I $O(PSJOCLST(""))="" Q
"RTN","PSJOCDI",21,0)
 D CRITICAL
"RTN","PSJOCDI",22,0)
 D DSPLOC
"RTN","PSJOCDI",23,0)
 I $D(^TMP($J,"PSJPRE","OUT","DRUGDRUG","S")) D
"RTN","PSJOCDI",24,0)
 . W !,"*** REFER TO MONOGRAPH FOR SIGNIFICANT INTERACTION CLINICAL EFFECTS",!
"RTN","PSJOCDI",25,0)
 D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",26,0)
 W !
"RTN","PSJOCDI",27,0)
 D MON^PSJMON(.PSJMON)
"RTN","PSJOCDI",28,0)
 D:$G(PSJONFLG)&('$D(PSJDGCK)) INTERV
"RTN","PSJOCDI",29,0)
 Q
"RTN","PSJOCDI",30,0)
DSPLOC ;Display drug drug interaction - sorted by severity, prospective drug (50,.01), profile drug (VAgen name), package, seq#
"RTN","PSJOCDI",31,0)
 NEW PSJDN,PSJDNV,PSJPON,PSJP,PSJX,X,PSJXSEV,PSJXNM,PSJXNM1,PSJXSORT,PSJXDN,PSJSORT,PSJPSPEC,PSJPROFL,PSJ2,PSJSEV,PSJHDRS,PSJDSPON,PSJCLINF
"RTN","PSJOCDI",32,0)
 ;
"RTN","PSJOCDI",33,0)
 K PSJPAUSE
"RTN","PSJOCDI",34,0)
 I '$G(PSJDRGIF) D PAUSE^PSJMISC(1,0) W @IOF D LINE^PSJMISC("=",81) S PSJDEFLG=1
"RTN","PSJOCDI",35,0)
 ;Get the last drug in the sort list so a '=' line is printed instead of '.'
"RTN","PSJOCDI",36,0)
 S PSJLINE=".",PSJHDRS=""
"RTN","PSJOCDI",37,0)
 S PSJXSEV=$O(PSJOCLST(""),-1)
"RTN","PSJOCDI",38,0)
 S PSJXNM=$O(PSJOCLST(PSJXSEV,""),-1)
"RTN","PSJOCDI",39,0)
 S PSJXNM1=$O(PSJOCLST(PSJXSEV,PSJXNM,""),-1)
"RTN","PSJOCDI",40,0)
 S PSJXSORT=$O(PSJOCLST(PSJXSEV,PSJXNM,PSJXNM1,""),-1)
"RTN","PSJOCDI",41,0)
 S PSJXDN=$O(PSJOCLST(PSJXSEV,PSJXNM,PSJXNM1,PSJXSORT,""),-1)
"RTN","PSJOCDI",42,0)
 ;
"RTN","PSJOCDI",43,0)
 ;S PSJSEV="" F  S PSJSEV=$O(PSJOCLST(PSJSEV)) Q:PSJSEV=""  D
"RTN","PSJOCDI",44,0)
 ;Displaying Critical orders
"RTN","PSJOCDI",45,0)
 S PSJSEV="C"
"RTN","PSJOCDI",46,0)
 ;I $D(PSJCRTCL) D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",47,0)
 F PSJSORT=0:0 S PSJSORT=$O(PSJCRTCL(PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",48,0)
 . F PSJGROUP=0:0 S PSJGROUP=$O(PSJCRTCL(PSJSORT,PSJGROUP)) Q:'PSJGROUP  D
"RTN","PSJOCDI",49,0)
 .. S X=$G(PSJCRTCL(PSJSORT,PSJGROUP))
"RTN","PSJOCDI",50,0)
 .. D DSPCRTCL($P(X,U),$P(X,U,2))
"RTN","PSJOCDI",51,0)
 ;Displaying Significant orders
"RTN","PSJOCDI",52,0)
 K PSJDSPON
"RTN","PSJOCDI",53,0)
 S PSJSEV="S"
"RTN","PSJOCDI",54,0)
 S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",55,0)
 . D LINE^PSJMISC("=",81)
"RTN","PSJOCDI",56,0)
 . F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",57,0)
 .. F PSJ2=0:0 S PSJ2=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",58,0)
 ... S PSJDNV=PSJOCLST(PSJSEV,PSJPSPEC,PSJSORT,PSJ2)
"RTN","PSJOCDI",59,0)
 ... D DISPON
"RTN","PSJOCDI",60,0)
 . W !
"RTN","PSJOCDI",61,0)
 Q
"RTN","PSJOCDI",62,0)
DSPCRTCL(PSJPSPEC,PSJPROFL) ;Display Critical orders
"RTN","PSJOCDI",63,0)
 NEW PSJSORT,PSJ2
"RTN","PSJOCDI",64,0)
 Q:$G(PSJPSPEC)=""
"RTN","PSJOCDI",65,0)
 Q:$G(PSJPROFL)=""
"RTN","PSJOCDI",66,0)
 F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",67,0)
 . F PSJ2=0:0 S PSJ2=$O(PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",68,0)
 .. S PSJDNV=PSJOCLST("C",PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)
"RTN","PSJOCDI",69,0)
 .. D DISPON
"RTN","PSJOCDI",70,0)
 Q
"RTN","PSJOCDI",71,0)
DISPON ; Display orders & clin effects if applied.
"RTN","PSJOCDI",72,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",73,0)
 F X=1:1:11 S PSJP(X)=$P(PSJDNV,U,X)
"RTN","PSJOCDI",74,0)
 S PSJCLINF=$P(PSJDNV,U,12)
"RTN","PSJOCDI",75,0)
 I ($G(PSJHDR)'=$P(PSJDNV,U,3))!(PSJHDRS'=PSJSEV) S PSJHDR=$P(PSJDNV,U,3),PSJHDRS=PSJSEV K PSJDSPON D HDR(PSJHDR)
"RTN","PSJOCDI",76,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",77,0)
 I PSJSORT=10 D
"RTN","PSJOCDI",78,0)
 . S (PSJDRGIF,PSJONFLG)=1
"RTN","PSJOCDI",79,0)
 . I $P(PSJCLINF,";",2) D DISPCLN^PSJCLNOC(.PSJP,PSJCLINF) Q
"RTN","PSJOCDI",80,0)
 . D DSPDRG(PSJP(4),$P(PSJDNV,U,2),PSJCLINF)
"RTN","PSJOCDI",81,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",82,0)
 I PSJSORT>10 S (PSJDRGIF,PSJONFLG)=1 D  ;PSJDRGIF - drug interaction displayed
"RTN","PSJOCDI",83,0)
 . I $D(PSJDSPON($P(PSJP(4),";",2))) Q
"RTN","PSJOCDI",84,0)
 . S PSJDSPON($P(PSJP(4),";",2))=""
"RTN","PSJOCDI",85,0)
 . I $P($P(PSJDNV,U,12),";",2) D DISPCLN^PSJCLNOC(.PSJP,PSJCLINF) Q
"RTN","PSJOCDI",86,0)
 . D EN^PSODRDU2(DFN,PSJP(4),"PSJPRE")
"RTN","PSJOCDI",87,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",88,0)
DISPON2 ;
"RTN","PSJOCDI",89,0)
 I PSJSEV=PSJXSEV,(PSJPSPEC=PSJXNM),(PSJSORT=PSJXSORT),(PSJ2=PSJXDN) S PSJLINE="="
"RTN","PSJOCDI",90,0)
 I PSJSEV="C",$$DSPLCLIN(PSJ2) D CLIN(PSJP(5),PSJP(2),PSJP(4),PSJP(1),PSJLINE)
"RTN","PSJOCDI",91,0)
 I ($Y+6)>IOSL D PAUSE^PSJMISC() W @IOF
"RTN","PSJOCDI",92,0)
 Q
"RTN","PSJOCDI",93,0)
SORTORD ;Sort drug drug output to display in order of: Inpatient, Active Rx, Remote Rx, Pending Rx, Non_VA
"RTN","PSJOCDI",94,0)
 NEW PDJDNV,PSJX
"RTN","PSJOCDI",95,0)
 S PSJDNV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN))
"RTN","PSJOCDI",96,0)
 I $E(PSJPON,1,1)'="I" D
"RTN","PSJOCDI",97,0)
 . S PSJX=$E($P(PSJPON,";"),1,1)
"RTN","PSJOCDI",98,0)
 . D OCLST($S(PSJX["C":10,PSJX="O":20,PSJX="R":30,PSJX="P":40,PSJX="N":50,1:""),PSJCLINF)
"RTN","PSJOCDI",99,0)
 I $E(PSJPON,1,1)="I" D OCLST(10,PSJCLINF)
"RTN","PSJOCDI",100,0)
 Q
"RTN","PSJOCDI",101,0)
OCLST(PSJ1,PSJCLINF) ;Sort orders into array to display later
"RTN","PSJOCDI",102,0)
 ;PSJOCLST(PSJSEV("C",PSJPSPEC,PSJPROFL,PSJ1-package,PSJ2)=P1...P6 (P1=SEQ NO, P2=Drug Name(Profile), P3=Drug Name(Prospective)
"RTN","PSJOCDI",103,0)
 ;  (P4=Pharm order# ,P5=Severity, P6=P3 IEN)
"RTN","PSJOCDI",104,0)
 ;PSJOCLST(PSJSEV("S",PSJPSPEC,PSJ1-package,PSJ2)=P1...P12 (P1=SEQ NO, P2=Drug Name(Profile), P3=Drug Name(Prospective), P12=PSJCLINF
"RTN","PSJOCDI",105,0)
 ;  (P4=Pharm order# ,P5=Severity, P6=P3 IEN)
"RTN","PSJOCDI",106,0)
 ;PSJSEV: Sort first by severity
"RTN","PSJOCDI",107,0)
 ;PSJ1: 10=PSJ Order
"RTN","PSJOCDI",108,0)
 ;      20=PSO Active Rx
"RTN","PSJOCDI",109,0)
 ;      30=Remote Rx
"RTN","PSJOCDI",110,0)
 ;      40=PSO pending
"RTN","PSJOCDI",111,0)
 ;      50=Non-VA
"RTN","PSJOCDI",112,0)
 ;PSJ2: A counter
"RTN","PSJOCDI",113,0)
 NEW PSJDNV,PSJMONTI,PSJMONV,PSJVAGEN,PSJON1,PSJON2,PSJONFG,PSJPSPEC,PSJPROFL
"RTN","PSJOCDI",114,0)
 Q:'$G(PSJ1)
"RTN","PSJOCDI",115,0)
 S PSJ2=$G(PSJ2)+1
"RTN","PSJOCDI",116,0)
 S PSJDNV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN))
"RTN","PSJOCDI",117,0)
 S PSJPSPEC=$P(PSJDNV,U,4) S:PSJPSPEC="" PSJPSPEC="UNKNOWN DRUG NAME"
"RTN","PSJOCDI",118,0)
 ; Criticals are grouped by profile VAGEN name and then package type
"RTN","PSJOCDI",119,0)
 I PSJSEV="C" D
"RTN","PSJOCDI",120,0)
 . S PSJVAGEN=$$VAGEN^PSJMISC(+$P(PSJDNV,U,3)) I PSJVAGEN="" S PSJVAGEN=PSJDNM
"RTN","PSJOCDI",121,0)
 . S PSJOCLST(PSJSEV,PSJPSPEC,PSJVAGEN,PSJ1,PSJ2)=PSJDN_U_$G(PSJDNM)_U_$P(PSJDNV,U,4)_U_PSJPON_U_PSJSEV_U_$P(PSJDNV,U,2)_"^^^^^^"_PSJCLINF
"RTN","PSJOCDI",122,0)
 ; Significants are grouped by package type so Inpatient orders display first
"RTN","PSJOCDI",123,0)
 I PSJSEV="S" D 
"RTN","PSJOCDI",124,0)
 . S PSJOCLST(PSJSEV,PSJPSPEC,PSJ1,PSJ2)=PSJDN_U_$G(PSJDNM)_U_$P(PSJDNV,U,4)_U_PSJPON_U_PSJSEV_U_$P(PSJDNV,U,2)_"^^^^^^"_PSJCLINF
"RTN","PSJOCDI",125,0)
 S PSJMONTI=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDN,"PMON",3,0))
"RTN","PSJOCDI",126,0)
 S PSJMONTI=$P(PSJMONTI,"MONOGRAPH TITLE:  ",2) Q:PSJMONTI=""
"RTN","PSJOCDI",127,0)
 S PSJVAGEN=$$VAGEN^PSJMISC(+$P(PSJDNV,U,3))
"RTN","PSJOCDI",128,0)
 I PSJVAGEN="",'+$P(PSJDNV,U,3) S PSJVAGEN=$$GENVUID^PSJMISC($G(PSJRDI(PSJPON)))
"RTN","PSJOCDI",129,0)
 Q:PSJVAGEN=""
"RTN","PSJOCDI",130,0)
 S PSJVAGEN=PSJVAGEN_"+"_$P(PSJDNV,U,4)
"RTN","PSJOCDI",131,0)
 S PSJMONV=$G(PSJMON(PSJVAGEN,PSJMONTI))
"RTN","PSJOCDI",132,0)
 I PSJMONTI]"" D
"RTN","PSJOCDI",133,0)
 . S $P(PSJMON(PSJVAGEN,PSJMONTI),U,1,7)=PSJDN_U_$G(PSJDNM)_U_+$P(PSJDNV,U,3)_U_$P(PSJDNV,U,4)_U_+$P(PSJDNV,U,2)_U_PSJPON_U_PSJSEV
"RTN","PSJOCDI",134,0)
 . S $P(PSJMON(PSJVAGEN,PSJMONTI),U,11)=PSJVAGEN
"RTN","PSJOCDI",135,0)
 I PSJMONV]"" D
"RTN","PSJOCDI",136,0)
 . I $P(PSJMONV,U,7)'=PSJSEV S $P(PSJMON(PSJVAGEN,PSJMONTI),U,9)=1
"RTN","PSJOCDI",137,0)
 . S PSJONFG=0
"RTN","PSJOCDI",138,0)
 . S PSJON1=$P($P(PSJMONV,U,6),";")
"RTN","PSJOCDI",139,0)
 . S PSJON2=$P(PSJPON,";")
"RTN","PSJOCDI",140,0)
 . I PSJON1="I",PSJON2'="I" S PSJONFG=1
"RTN","PSJOCDI",141,0)
 . I PSJON1'="I",PSJON2="I" S PSJONFG=1
"RTN","PSJOCDI",142,0)
 . I PSJONFG S $P(PSJMON(PSJVAGEN,PSJMONTI),U,10)=1
"RTN","PSJOCDI",143,0)
 K PSJON1,PSJON2,PSJONFG
"RTN","PSJOCDI",144,0)
 Q
"RTN","PSJOCDI",145,0)
CLIN(PSJSEV,PSJDNM,PSJPON,PSJDN,PSJLINE) ;
"RTN","PSJOCDI",146,0)
 ;No longer need to display the clinical effect for Significant
"RTN","PSJOCDI",147,0)
 Q:PSJSEV="S"
"RTN","PSJOCDI",148,0)
 NEW PSJCLINV,PSJNDX,PSJX
"RTN","PSJOCDI",149,0)
 I $G(PSJLINE)="" S PSJLINE="."
"RTN","PSJOCDI",150,0)
 F PSJDNX=0:0 S PSJDNX=$O(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDNX)) Q:'PSJDNX  D
"RTN","PSJOCDI",151,0)
 . S PSJCLINV=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJSEV,PSJDNM,PSJPON,PSJDNX,"CLIN"))
"RTN","PSJOCDI",152,0)
 . W !
"RTN","PSJOCDI",153,0)
 . S PSJX=$P(PSJCLINV,"CLINICAL EFFECTS:  ",2) I ($Y+($L(PSJX)\65)+4)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",154,0)
 . D WRITE^PSJMISC(PSJX)
"RTN","PSJOCDI",155,0)
 W !
"RTN","PSJOCDI",156,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(0,0) W @IOF
"RTN","PSJOCDI",157,0)
 Q
"RTN","PSJOCDI",158,0)
INTERV ;Log intervention.  Required for Critical.
"RTN","PSJOCDI",159,0)
 ;Critical interaction MUST log an intervention before continue with the order
"RTN","PSJOCDI",160,0)
 ;Only log one intervention for a prospective drug & log it for the higher severity
"RTN","PSJOCDI",161,0)
 NEW PSJSEV,PSJDD,PSJDN,PSJNDV,PSJTYPE,PSJINTVD,PSJPROFL
"RTN","PSJOCDI",162,0)
 K PSJDDSV,PSJINTVD
"RTN","PSJOCDI",163,0)
 ;Required intervention for each of the prospective drug with critical interactions
"RTN","PSJOCDI",164,0)
 F PSJSEV="C" Q:$G(PSGORQF)  S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",165,0)
 . S PSJPROFL="" F  S PSJPROFL=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL)) Q:PSJPROFL=""  D
"RTN","PSJOCDI",166,0)
 .. F PSJTYPE=0:0 S PSJTYPE=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE)) Q:'PSJTYPE  D
"RTN","PSJOCDI",167,0)
 ... F PSJDN=0:0 S PSJDN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE,PSJDN)) Q:'PSJDN  Q:$G(PSGORQF)  D
"RTN","PSJOCDI",168,0)
 .... S PSJNDV=$G(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJTYPE,PSJDN)),PSJDD=$P(PSJNDV,U,6)
"RTN","PSJOCDI",169,0)
 .... ;I ($P($P(PSJNDV,U,4),";",1)="I"),('$D(PSJINTVD($P(PSJNDV,U,3)))) D
"RTN","PSJOCDI",170,0)
 .... I '$D(PSJINTVD($P(PSJNDV,U,3))) D
"RTN","PSJOCDI",171,0)
 ..... S (PSJINTVD($P(PSJNDV,U,3)))=""
"RTN","PSJOCDI",172,0)
 ..... D:'$D(PSJDGCK) RINTERV^PSJGMRA("CRITICAL DRUG INTERACTION",$P(PSJNDV,U,3))
"RTN","PSJOCDI",173,0)
 ;
"RTN","PSJOCDI",174,0)
 ; Optional intervention for each of the prospective drug(not the same as critical) with significant interactions
"RTN","PSJOCDI",175,0)
 F PSJSEV="S" Q:$G(PSGORQF)  S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",176,0)
 . F PSJTYPE=0:0 S PSJTYPE=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE)) Q:'PSJTYPE  D
"RTN","PSJOCDI",177,0)
 .. F PSJDN=0:0 S PSJDN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE,PSJDN)) Q:'PSJDN  Q:$G(PSGORQF)  D
"RTN","PSJOCDI",178,0)
 ... S PSJNDV=$G(PSJOCLST(PSJSEV,PSJPSPEC,PSJTYPE,PSJDN)),PSJDD=$P(PSJNDV,U,6)
"RTN","PSJOCDI",179,0)
 ... I '$D(PSJINTVD($P(PSJNDV,U,3))) D
"RTN","PSJOCDI",180,0)
 .... S (PSJINTVD($P(PSJNDV,U,3)))=""
"RTN","PSJOCDI",181,0)
 .... D:'$D(PSJDGCK) INTERV^PSJGMRA("SIGNIFICANT DRUG INTERACTION",$P(PSJNDV,U,3))
"RTN","PSJOCDI",182,0)
 Q
"RTN","PSJOCDI",183,0)
HDR(PSJDNM) ;Display the intro text on drug interaction
"RTN","PSJOCDI",184,0)
 NEW PSJSTCK,PSJCNT SET PSJSTCK="",PSJCNT=0
"RTN","PSJOCDI",185,0)
 ;
"RTN","PSJOCDI",186,0)
 IF $G(PSJDGCK) FOR  SET PSJCNT=$O(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJCNT))  Q:PSJCNT=""!(PSJSTCK'="")  D
"RTN","PSJOCDI",187,0)
 .IF PSJDNM=$P(^TMP($J,"PSJPRE","IN","PROSPECTIVE",PSJCNT),U,4) SET PSJSTCK=$$PSTAT(PSJCNT)
"RTN","PSJOCDI",188,0)
 IF $G(PSJSTCK)'="" D  Q
"RTN","PSJOCDI",189,0)
 .W !,"This patient is receiving the following order(s) that have a "
"RTN","PSJOCDI",190,0)
 .W $S($G(PSJSEV)="C":"CRITICAL",$G(PSJSEV)="S":"SIGNIFICANT",1:"")_" Drug"
"RTN","PSJOCDI",191,0)
 .W !,"Interaction with "_$G(PSJDNM)_$G(PSJSTCK)_":",!
"RTN","PSJOCDI",192,0)
 IF '$G(PSJDGCK)  D  Q
"RTN","PSJOCDI",193,0)
 .W !,"This patient is receiving the following order(s) that have a "
"RTN","PSJOCDI",194,0)
 .W $S($G(PSJSEV)="C":"CRITICAL",$G(PSJSEV)="S":"SIGNIFICANT",1:"")_" Drug"
"RTN","PSJOCDI",195,0)
 .W !,"Interaction with "_$G(PSJDNM)_":",!
"RTN","PSJOCDI",196,0)
 Q
"RTN","PSJOCDI",197,0)
PSTAT(PSJPONCK) ;**Display order status - CCR 5980
"RTN","PSJOCDI",198,0)
 NEW PSJONCK,PSJCNT,PSJIND,PSJCKOS,PSJCKST
"RTN","PSJOCDI",199,0)
 SET PSJCKOS="",PSJCKST="",PSJONCK=0,PSJCNT=0,PSJIND=""
"RTN","PSJOCDI",200,0)
 ;
"RTN","PSJOCDI",201,0)
 Q:'$G(PSJDGCK) PSJCKST
"RTN","PSJOCDI",202,0)
 ;
"RTN","PSJOCDI",203,0)
 IF $P(PSJPONCK,";",2)="" S PSJCKST=" (Prospective)" Q PSJCKST
"RTN","PSJOCDI",204,0)
 IF $P(PSJPONCK,";",1)="P" S PSJCKST=" (OP Pending)" Q PSJCKST
"RTN","PSJOCDI",205,0)
 IF $P(PSJPONCK,";",1)="O" D  SET PSJCKST=" (Local Rx #"_$P(^PSRX($P(PSJPONCK,";",2),0),U,1)_" ("_PSJCKOS_"))" Q PSJCKST
"RTN","PSJOCDI",206,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=0 SET PSJCKOS="Active" Q
"RTN","PSJOCDI",207,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=1 SET PSJCKOS="Non-Verified" Q
"RTN","PSJOCDI",208,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=2 SET PSJCKOS="Refill" Q
"RTN","PSJOCDI",209,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=3 SET PSJCKOS="Hold" Q
"RTN","PSJOCDI",210,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=4 SET PSJCKOS="Drug Interactions" Q
"RTN","PSJOCDI",211,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=5 SET PSJCKOS="Suspended" Q
"RTN","PSJOCDI",212,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=10 SET PSJCKOS="Done" Q
"RTN","PSJOCDI",213,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=11 SET PSJCKOS="Expired" Q
"RTN","PSJOCDI",214,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=12 SET PSJCKOS="Discontinued" Q
"RTN","PSJOCDI",215,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=13 SET PSJCKOS="Deleted" Q
"RTN","PSJOCDI",216,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=14 SET PSJCKOS="Discontinued by provider" Q
"RTN","PSJOCDI",217,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=15 SET PSJCKOS="Discontinued (Edit)" Q
"RTN","PSJOCDI",218,0)
 .IF $P(^PSRX($P(PSJPONCK,";",2),"STA"),U,1)=16 SET PSJCKOS="Provider Hold" Q
"RTN","PSJOCDI",219,0)
 IF $P(PSJPONCK,";",1)="N" SET PSJCKST=" (Non-VA)" Q PSJCKST
"RTN","PSJOCDI",220,0)
 IF PSJCKST=""  SET PSJCNT=$L($P(PSJPONCK,";",2)),PSJIND=$E($P(PSJPONCK,";",2),PSJCNT),PSJONCK=+$P(PSJPONCK,";",2)
"RTN","PSJOCDI",221,0)
 IF $G(PSJIND)="P" D  Q PSJCKST
"RTN","PSJOCDI",222,0)
 .IF $P(^PS(53.1,PSJONCK,0),U,9)="A" SET PSJCKST=" (IP Active)" Q
"RTN","PSJOCDI",223,0)
 .IF $P(^PS(53.1,PSJONCK,0),U,9)="D" SET PSJCKST=" (IP Discontinued)" Q
"RTN","PSJOCDI",224,0)
 .IF $P(^PS(53.1,PSJONCK,0),U,9)="I" SET PSJCKST=" (IP Incomplete)" Q
"RTN","PSJOCDI",225,0)
 .IF $P(^PS(53.1,PSJONCK,0),U,9)="N" SET PSJCKST=" (IP Non-Verified)" Q
"RTN","PSJOCDI",226,0)
 .IF $P(^PS(53.1,PSJONCK,0),U,9)="U" SET PSJCKST=" (IP Unreleased)" Q
"RTN","PSJOCDI",227,0)
 .IF $P(^PS(53.1,PSJONCK,0),U,9)="P" SET PSJCKST=" (IP Pending)" Q
"RTN","PSJOCDI",228,0)
 IF $G(PSJIND)="U" D  Q PSJCKST
"RTN","PSJOCDI",229,0)
 .IF $P(^PS(55,$G(DFN),5,PSJONCK,0),U,9)="A" SET PSJCKST=" (IP Active)" Q
"RTN","PSJOCDI",230,0)
 .IF $P(^PS(55,$G(DFN),5,PSJONCK,0),U,9)="D" SET PSJCKST=" (IP Discontinued)" Q
"RTN","PSJOCDI",231,0)
 .IF $P(^PS(55,$G(DFN),5,PSJONCK,0),U,9)="E" SET PSJCKST=" (IP Expired)" Q
"RTN","PSJOCDI",232,0)
 .IF $P(^PS(55,$G(DFN),5,PSJONCK,0),U,9)="H" SET PSJCKST=" (IP Hold)" Q
"RTN","PSJOCDI",233,0)
 .IF $P(^PS(55,$G(DFN),5,PSJONCK,0),U,9)="R" SET PSJCKST=" (IP Renewed)" Q
"RTN","PSJOCDI",234,0)
 .IF $P(^PS(55,$G(DFN),5,PSJONCK,0),U,9)="RE" SET PSJCKST=" (IP Reinstated)" Q
"RTN","PSJOCDI",235,0)
 .IF $P(^PS(55,$G(DFN),5,PSJONCK,0),U,9)="DE" SET PSJCKST=" (IP Discontinued (Edit))" Q
"RTN","PSJOCDI",236,0)
 .IF $P(^PS(55,$G(DFN),5,PSJONCK,0),U,9)="DR" SET PSJCKST=" (IP Discontinued (Renewal))" Q
"RTN","PSJOCDI",237,0)
 IF $G(PSJIND)="V" D  Q PSJCKST
"RTN","PSJOCDI",238,0)
 .IF $P(^PS(55,$G(DFN),"IV",PSJONCK,0),U,17)="A" SET PSJCKST=" (IP Active)" Q
"RTN","PSJOCDI",239,0)
 .IF $P(^PS(55,$G(DFN),"IV",PSJONCK,0),U,17)="H" SET PSJCKST=" (IP Hold)" Q
"RTN","PSJOCDI",240,0)
 .IF $P(^PS(55,$G(DFN),"IV",PSJONCK,0),U,17)="R" SET PSJCKST=" (IP Renewed)" Q
"RTN","PSJOCDI",241,0)
 .IF $P(^PS(55,$G(DFN),"IV",PSJONCK,0),U,17)="D" SET PSJCKST=" (IP Discontinued)" Q
"RTN","PSJOCDI",242,0)
 .IF $P(^PS(55,$G(DFN),"IV",PSJONCK,0),U,17)="E" SET PSJCKST=" (IP Expired)" Q
"RTN","PSJOCDI",243,0)
 .IF $P(^PS(55,$G(DFN),"IV",PSJONCK,0),U,17)="P" SET PSJCKST=" (IP Purge)" Q
"RTN","PSJOCDI",244,0)
 .IF $P(^PS(55,$G(DFN),"IV",PSJONCK,0),U,17)="O" SET PSJCKST=" (IP On call)" Q
"RTN","PSJOCDI",245,0)
 .IF $P(^PS(55,$G(DFN),"IV",PSJONCK,0),U,17)="N" SET PSJCKST=" (IP Non-Verified)" Q
"RTN","PSJOCDI",246,0)
 Q PSJCKST
"RTN","PSJOCDI",247,0)
 ;
"RTN","PSJOCDI",248,0)
DSPDRG(PSJPON,PSJDNM,PSJCLINF) ;Display order info or drug name from prospective. CCR 6454
"RTN","PSJOCDI",249,0)
 Q:$G(PSJPON)=""
"RTN","PSJOCDI",250,0)
 ;IF $G(PSJDGCK) NEW PSJSTCK SET PSJSTCK=$$PSTAT(PSJPON)
"RTN","PSJOCDI",251,0)
 ;IF $G(PSJDGCK),$G(PSJSTCK)'="" W !,?8,$G(PSJDNM)_$G(PSJSTCK),! Q
"RTN","PSJOCDI",252,0)
 I $P(PSJPON,";",3)="PROSPECTIVE" W !?8,$G(PSJDNM)_" (Prospective)",! Q
"RTN","PSJOCDI",253,0)
 I $D(PSJDSPON($P(PSJPON,";",2))) Q
"RTN","PSJOCDI",254,0)
 S PSJDSPON($P(PSJPON,";",2))=""
"RTN","PSJOCDI",255,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,0) W @IOF
"RTN","PSJOCDI",256,0)
 D DSPORD^PSJOC($P(PSJPON,";",2),"",PSJCLINF)
"RTN","PSJOCDI",257,0)
 Q
"RTN","PSJOCDI",258,0)
RDIVUID ;Loop thru the "IN" global to store the VUID for remote Rx
"RTN","PSJOCDI",259,0)
 NEW PSJPON,PSJVUID
"RTN","PSJOCDI",260,0)
 K PSJRDI
"RTN","PSJOCDI",261,0)
 S PSJPON=""
"RTN","PSJOCDI",262,0)
 F  S PSJPON=$O(^TMP($J,"PSJPRE","IN","PROFILE",PSJPON)) Q:PSJPON=""  I $E(PSJPON,1,1)="R" D
"RTN","PSJOCDI",263,0)
 . S PSJVUID=$P($G(^TMP($J,"PSJPRE","IN","PROFILE",PSJPON)),U,2)
"RTN","PSJOCDI",264,0)
 . S:+PSJVUID PSJRDI(PSJPON)=PSJVUID
"RTN","PSJOCDI",265,0)
 Q
"RTN","PSJOCDI",266,0)
DSPLCLIN(PSJ2) ;If the next drug on the list is diff the flag to display the clin effects.
"RTN","PSJOCDI",267,0)
 NEW PSJCLINC,PSJCLINN,PSJDNVC,PSJDNVN,PSJPC,PSJPN,PSJ2N,PSJSORTN
"RTN","PSJOCDI",268,0)
 I $G(PSJ2)="" Q 0
"RTN","PSJOCDI",269,0)
 S PSJDNVC=PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)
"RTN","PSJOCDI",270,0)
 F X=1:1:10 S PSJPC(X)=$P(PSJDNVC,U,X)
"RTN","PSJOCDI",271,0)
 S PSJ2N=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2))
"RTN","PSJOCDI",272,0)
 I 'PSJ2N S PSJSORTN=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORTN 1
"RTN","PSJOCDI",273,0)
 S PSJ2N=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,0)) Q:'PSJ2N 1
"RTN","PSJOCDI",274,0)
 S PSJDNVN=PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2N)
"RTN","PSJOCDI",275,0)
 F X=1:1:10 S PSJPN(X)=$P(PSJDNVN,U,X)
"RTN","PSJOCDI",276,0)
 I $S(PSJPC(5)="":1,PSJPC(2)="":1,PSJPC(4)="":1,'+PSJPC(1):1,PSJPN(5)="":1,PSJPN(2)="":1,PSJPN(4)="":1,'+PSJPN(1):1,1:0) Q 0
"RTN","PSJOCDI",277,0)
 S PSJCLINC=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJPC(5),PSJPC(2),PSJPC(4),PSJPC(1),"CLIN"))
"RTN","PSJOCDI",278,0)
 S PSJCLINN=$G(^TMP($J,"PSJPRE","OUT","DRUGDRUG",PSJPN(5),PSJPN(2),PSJPN(4),PSJPN(1),"CLIN"))
"RTN","PSJOCDI",279,0)
 I (PSJCLINC'=PSJCLINN) Q 1
"RTN","PSJOCDI",280,0)
 Q 0
"RTN","PSJOCDI",281,0)
CRITICAL ;
"RTN","PSJOCDI",282,0)
 NEW PSJGROUP,PSJNEXT
"RTN","PSJOCDI",283,0)
 S PSJGROUP=0,PSJNEXT=0
"RTN","PSJOCDI",284,0)
 S PSJSEV="C"
"RTN","PSJOCDI",285,0)
 S PSJPSPEC="" F  S PSJPSPEC=$O(PSJOCLST(PSJSEV,PSJPSPEC)) Q:PSJPSPEC=""  D
"RTN","PSJOCDI",286,0)
 . S PSJPROFL="" F  S PSJPROFL=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL)) Q:PSJPROFL=""  D
"RTN","PSJOCDI",287,0)
 .. S PSJNEXT=0
"RTN","PSJOCDI",288,0)
 .. S PSJGROUP=PSJGROUP+1
"RTN","PSJOCDI",289,0)
 .. F PSJSORT=0:0 S PSJSORT=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT)) Q:'PSJSORT  D
"RTN","PSJOCDI",290,0)
 ... Q:PSJNEXT
"RTN","PSJOCDI",291,0)
 ... F PSJ2=0:0 S PSJ2=$O(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2)) Q:'PSJ2  D
"RTN","PSJOCDI",292,0)
 .... Q:PSJNEXT
"RTN","PSJOCDI",293,0)
 .... S PSJCRTCL(PSJSORT,PSJGROUP)=PSJPSPEC_U_PSJPROFL_U_$P(PSJOCLST(PSJSEV,PSJPSPEC,PSJPROFL,PSJSORT,PSJ2),"^",12)
"RTN","PSJOCDI",294,0)
 .... S PSJNEXT=1
"RTN","PSJOCDI",295,0)
 Q
"RTN","PSJOCDSD")
0^29^B40217839
"RTN","PSJOCDSD",1,0)
PSJOCDSD ; BIR/MV,RN - PROCESS DOSING ORDER CHECKS ;6 Jun 07  3:37 PM
"RTN","PSJOCDSD",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,252,281**;16 DEC 97;Build 113
"RTN","PSJOCDSD",3,0)
 ;
"RTN","PSJOCDSD",4,0)
DISPLAY ;Display dose checks
"RTN","PSJOCDSD",5,0)
 NEW PSJPON,PSJDSPFG,PSJCNT0,DR
"RTN","PSJOCDSD",6,0)
 D FULL^VALM1
"RTN","PSJOCDSD",7,0)
 Q:'$$DSPSERR^PSJOC("Maximum Single Dose Check could not be performed")
"RTN","PSJOCDSD",8,0)
 D EXCEPTN2
"RTN","PSJOCDSD",9,0)
 K PSJDSPFG
"RTN","PSJOCDSD",10,0)
 F PSJCNT0=0:0 S PSJCNT0=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0)) Q:'PSJCNT0  Q:$G(PSGORQF)  D
"RTN","PSJOCDSD",11,0)
 . S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON)) Q:PSJPON=""  Q:$G(PSGORQF)  D
"RTN","PSJOCDSD",12,0)
 .. Q:PSJPON=0
"RTN","PSJOCDSD",13,0)
 .. D ERROR
"RTN","PSJOCDSD",14,0)
 .. D EXCEPTN
"RTN","PSJOCDSD",15,0)
 .. D WARNING
"RTN","PSJOCDSD",16,0)
 K PSJDSPFG
"RTN","PSJOCDSD",17,0)
 ;store dosing messages
"RTN","PSJOCDSD",18,0)
 S (ZLERF,ZDSEQ,ZDLNN1)="",ZCNT=0
"RTN","PSJOCDSD",19,0)
 F  S ZDSEQ=$O(^TMP($J,"PSJPRE","OUT","DOSE","ERROR",ZDSEQ)) Q:ZDSEQ=""  D
"RTN","PSJOCDSD",20,0)
 .F  S ZCNT=$O(^TMP($J,"PSJPRE","OUT","DOSE","ERROR",ZDSEQ,ZCNT)) Q:'ZCNT  D
"RTN","PSJOCDSD",21,0)
 ..S ^TMP("PSJDAOC",$J,"DOSE","ERROR",ZCNT)=^TMP($J,"PSJPRE","OUT","DOSE","ERROR",ZDSEQ,ZCNT,"MSG")_". "_^TMP($J,"PSJPRE","OUT","DOSE","ERROR",ZDSEQ,ZCNT,"TEXT")
"RTN","PSJOCDSD",22,0)
 K ZLERF,ZDSEQ,ZDLNN1,ZCNT
"RTN","PSJOCDSD",23,0)
 ;
"RTN","PSJOCDSD",24,0)
 S (ZLERF,ZDSEQ,ZDLNN1)="",(ZDEF,ZCNT)=0
"RTN","PSJOCDSD",25,0)
 F  S ZDEF=$O(^TMP($J,"PSJPRE1","OUT",ZDEF)) Q:'ZDEF  F  S ZDSEQ=$O(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ)) Q:ZDSEQ=""  D
"RTN","PSJOCDSD",26,0)
 .I $O(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"EXCEPTIONS",0))  D
"RTN","PSJOCDSD",27,0)
 ..S ZCNT=ZCNT+1
"RTN","PSJOCDSD",28,0)
 ..S ^TMP("PSJDAOC",$J,"DOSE","EXEC",ZCNT)=^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"EXCEPTIONS",1)_". "_$G(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"EXCEPTIONS",2))
"RTN","PSJOCDSD",29,0)
 K ZLERF,ZDSEQ,ZDLNN1,ZCNT,ZDEF
"RTN","PSJOCDSD",30,0)
 ;
"RTN","PSJOCDSD",31,0)
 S (ZLERF,ZDSEQ,ZDLNN1)="",(ZDEF,ZCNT,ZTOT)=0
"RTN","PSJOCDSD",32,0)
 F  S ZDEF=$O(^TMP($J,"PSJPRE1","OUT",ZDEF)) Q:'ZDEF  F  S ZDSEQ=$O(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ)) Q:ZDSEQ=""  D
"RTN","PSJOCDSD",33,0)
 .F  S ZLERF=$O(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"MESSAGE",ZLERF)) Q:ZLERF=""  F  S ZCNT=$O(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"MESSAGE",ZLERF,ZCNT)) Q:'ZCNT  D
"RTN","PSJOCDSD",34,0)
 ..I $D(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"MESSAGE",ZLERF,ZCNT))>9 D
"RTN","PSJOCDSD",35,0)
 ...N TMP
"RTN","PSJOCDSD",36,0)
 ...S TMP=""
"RTN","PSJOCDSD",37,0)
 ...F  S TMP=$O(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"MESSAGE",ZLERF,ZCNT,TMP)) Q:(TMP="")  D
"RTN","PSJOCDSD",38,0)
 ....S ZTOT=ZTOT+1
"RTN","PSJOCDSD",39,0)
 ....S ^TMP("PSJDAOC",$J,"DOSE","MSG",ZTOT)=^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"MESSAGE",ZLERF,ZCNT,TMP)
"RTN","PSJOCDSD",40,0)
 ..E  D
"RTN","PSJOCDSD",41,0)
 ...I $D(^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"MESSAGE",ZLERF,ZCNT)) D
"RTN","PSJOCDSD",42,0)
 ....S ZTOT=ZTOT+1
"RTN","PSJOCDSD",43,0)
 ....S ^TMP("PSJDAOC",$J,"DOSE","MSG",ZTOT)=^TMP($J,"PSJPRE1","OUT",ZDEF,ZDSEQ,"MESSAGE",ZLERF,ZCNT)
"RTN","PSJOCDSD",44,0)
 K ZLERF,ZDSEQ,ZDLNN1,ZCNT,ZDEF,ZTOT,TMP
"RTN","PSJOCDSD",45,0)
 Q
"RTN","PSJOCDSD",46,0)
DOSEOFF(PSJMSG) ;
"RTN","PSJOCDSD",47,0)
 ;Display message if dosing had turned off (once per patient session)
"RTN","PSJOCDSD",48,0)
 Q:$D(PSJEXCPT("DOSE",0))
"RTN","PSJOCDSD",49,0)
 S PSJEXCPT("DOSE",0)=""
"RTN","PSJOCDSD",50,0)
 W !!,$G(PSJMSG),!
"RTN","PSJOCDSD",51,0)
 D PAUSE^PSJLMUT1
"RTN","PSJOCDSD",52,0)
 Q
"RTN","PSJOCDSD",53,0)
WARNING ;Display warning messages
"RTN","PSJOCDSD",54,0)
 NEW PSJSGLE,PSJRNGE,PSJMSG,PSJDD,PSJTYPE,PSJIOFF
"RTN","PSJOCDSD",55,0)
 ;W @IOF
"RTN","PSJOCDSD",56,0)
 S PSJMSG=""
"RTN","PSJOCDSD",57,0)
 S (PSJSGLE,PSJRNGE)=0
"RTN","PSJOCDSD",58,0)
 I '$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)),'$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",0)) W !
"RTN","PSJOCDSD",59,0)
 S PSJTYPE="" F  S PSJTYPE=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE)) Q:PSJTYPE=""  D
"RTN","PSJOCDSD",60,0)
 . W:'$G(PSJIOFF) @IOF S PSJIOFF=1 W !
"RTN","PSJOCDSD",61,0)
 . F PSJDD=0:0 S PSJDD=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD)) Q:'PSJDD  D
"RTN","PSJOCDSD",62,0)
 .. Q:$G(PSGORQF)
"RTN","PSJOCDSD",63,0)
 .. S PSJMSG=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"MESSAGE",PSJTYPE,PSJDD))
"RTN","PSJOCDSD",64,0)
 .. I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",65,0)
 .. D WRITE^PSJMISC(PSJMSG,3)
"RTN","PSJOCDSD",66,0)
 .. S:PSJTYPE["1_SINGLE" PSJSGLE=1_U_PSJDD
"RTN","PSJOCDSD",67,0)
 .. S:PSJTYPE["2_RANGE" PSJRNGE=1_U_PSJDD
"RTN","PSJOCDSD",68,0)
 .. S:PSJTYPE["3_GENERAL" PSJDSPFG=1
"RTN","PSJOCDSD",69,0)
 Q:$G(PSGORQF)
"RTN","PSJOCDSD",70,0)
 D INTERV
"RTN","PSJOCDSD",71,0)
 Q
"RTN","PSJOCDSD",72,0)
INTERV ;Process intervention for dosing check
"RTN","PSJOCDSD",73,0)
 NEW PSJDD
"RTN","PSJOCDSD",74,0)
 S PSJDD=$S(+PSJSGLE:$P(PSJSGLE,U,2),1:$P(PSJRNGE,U,2))
"RTN","PSJOCDSD",75,0)
 I 'PSJDD,'$D(PSJOCFG) Q
"RTN","PSJOCDSD",76,0)
 K PSJDSPFG
"RTN","PSJOCDSD",77,0)
 W !
"RTN","PSJOCDSD",78,0)
 I +PSJSGLE,+PSJRNGE D RINTERV^PSJGMRA("MAX SINGLE DOSE & DAILY DOSE RANGE") Q
"RTN","PSJOCDSD",79,0)
 I +PSJRNGE D RINTERV^PSJGMRA("DAILY DOSE RANGE") Q
"RTN","PSJOCDSD",80,0)
 I +PSJSGLE D RINTERV^PSJGMRA("MAX SINGLE DOSE") Q
"RTN","PSJOCDSD",81,0)
 Q
"RTN","PSJOCDSD",82,0)
ERROR ; Process errors
"RTN","PSJOCDSD",83,0)
 NEW PSJCNT,PSJNV,PSJLINEF
"RTN","PSJOCDSD",84,0)
 ;PSJDSPFG - Display pause if there were errors
"RTN","PSJOCDSD",85,0)
 ;Check for system error one more time.
"RTN","PSJOCDSD",86,0)
 S PSJDSPFG=0
"RTN","PSJOCDSD",87,0)
 ;I $O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",0)) W !!
"RTN","PSJOCDSD",88,0)
 F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCDSD",89,0)
 . I '$G(PSJLINEF) W !! S PSJLINEF=1
"RTN","PSJOCDSD",90,0)
 . W !
"RTN","PSJOCDSD",91,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"MSG"))
"RTN","PSJOCDSD",92,0)
 . I PSJNV]"" D WRITE^PSJMISC(PSJNV,1) S PSJDSPFG=1
"RTN","PSJOCDSD",93,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"ERROR",PSJCNT,"TEXT"))
"RTN","PSJOCDSD",94,0)
 . I PSJNV]"" D WRITE^PSJMISC(PSJNV,1) S PSJDSPFG=1
"RTN","PSJOCDSD",95,0)
 D:$G(PSJDSPFG) PAUSE^PSJLMUT1
"RTN","PSJOCDSD",96,0)
 Q
"RTN","PSJOCDSD",97,0)
EXCEPTN ; Process exceptions
"RTN","PSJOCDSD",98,0)
 NEW PSJCNT,PSJNV,PSJSPACE,PSJQFLG1,PSJLINEF
"RTN","PSJOCDSD",99,0)
 ;PSJDSPFG - Display pause if there were errors
"RTN","PSJOCDSD",100,0)
 ;Check for system error one more time.
"RTN","PSJOCDSD",101,0)
 ;PSJOCFG - flag when order is Renew, Copy or New OE
"RTN","PSJOCDSD",102,0)
 S PSJDSPFG=0,PSJSPACE=0
"RTN","PSJOCDSD",103,0)
 ;I $O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",0)) W !!
"RTN","PSJOCDSD",104,0)
 F PSJCNT=0:0 S PSJCNT=$O(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT)) Q:'PSJCNT  D
"RTN","PSJOCDSD",105,0)
 . I '$G(PSJLINEF) W !! S PSJLINEF=1
"RTN","PSJOCDSD",106,0)
 . S PSJQFLG1=0
"RTN","PSJOCDSD",107,0)
 . ;I $D(PSJOCFG),$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))["Dosing Checks could not be performed",($G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT+1))["Drug not matched to NDF") Q
"RTN","PSJOCDSD",108,0)
 . I $D(PSJOCFG),($G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT+1))["Drug not matched to NDF") Q
"RTN","PSJOCDSD",109,0)
 . I $D(PSJOCFG),$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))["Drug not matched to NDF" Q
"RTN","PSJOCDSD",110,0)
 . I $D(PSJOCFG),$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))["Order Checks could not be done" Q
"RTN","PSJOCDSD",111,0)
 . I $D(PSJOCFG),$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))["Maximum Single Dose Check could not be done" Q
"RTN","PSJOCDSD",112,0)
 . S PSJDSPFG=1
"RTN","PSJOCDSD",113,0)
 . S PSJNV=$G(^TMP($J,"PSJPRE1","OUT",PSJCNT0,PSJPON,"EXCEPTIONS",PSJCNT))
"RTN","PSJOCDSD",114,0)
 . I PSJNV]"" D
"RTN","PSJOCDSD",115,0)
 .. I ($Y+6)>IOSL D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",116,0)
 .. ;If the output has 13 leading spaces, strip it off so the display is indenting correctly
"RTN","PSJOCDSD",117,0)
 .. I $E(PSJNV,1,13)="             " S PSJSPACE=13,PSJNV=$P(PSJNV,"             ",2)
"RTN","PSJOCDSD",118,0)
 .. D WRITE^PSJMISC(PSJNV,PSJSPACE+3)
"RTN","PSJOCDSD",119,0)
 D:$G(PSJDSPFG) PAUSE^PSJLMUT1
"RTN","PSJOCDSD",120,0)
 Q
"RTN","PSJOCDSD",121,0)
EXCEPTN2 ; Process exceptions on prospective drug
"RTN","PSJOCDSD",122,0)
 NEW PSJPON,PSJN,PSJNV
"RTN","PSJOCDSD",123,0)
 K PSJDSPFG
"RTN","PSJOCDSD",124,0)
 S PSJPON="" F  S PSJPON=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON)) Q:PSJPON=""  D
"RTN","PSJOCDSD",125,0)
 . F PSJN=0:0 S PSJN=$O(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN)) Q:'PSJN  D
"RTN","PSJOCDSD",126,0)
 .. S PSJNV=$G(^TMP($J,"PSJPRE","OUT","EXCEPTIONS",PSJPON,PSJN))
"RTN","PSJOCDSD",127,0)
 .. I $P(PSJPON,";",3)="PROFILE" Q
"RTN","PSJOCDSD",128,0)
 .. I '$$ERRCHK^PSJOC("PROSPECTIVE",$P(PSJNV,U,3)_$P(PSJNV,U,10)) Q
"RTN","PSJOCDSD",129,0)
 .. Q:'$D(PSJOCFG)
"RTN","PSJOCDSD",130,0)
 .. W !
"RTN","PSJOCDSD",131,0)
 .. D DSPDRGER^PSJOC(1)
"RTN","PSJOCDSD",132,0)
 I $G(PSJDSPFG) D PAUSE^PSJLMUT1 W @IOF
"RTN","PSJOCDSD",133,0)
 Q
"RTN","PSJOCDT")
0^7^B60637562
"RTN","PSJOCDT",1,0)
PSJOCDT ;BIR/MV - PROCESS DUPLICATE THERAPY ORDER CHECKS ;6 Jun 07 / 3:37 PM [9/8/14 1:10pm]
"RTN","PSJOCDT",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**181,260,288,257,281**;16 DEC 97;Build 113
"RTN","PSJOCDT",3,0)
 ;
"RTN","PSJOCDT",4,0)
 ; Reference to EN^PSODRDU2 is supported by DBIA# 2189.
"RTN","PSJOCDT",5,0)
 ;
"RTN","PSJOCDT",6,0)
DT ;
"RTN","PSJOCDT",7,0)
 NEW PSJN1,PSJCLASS,PSJDNCNT,PSJNDV,PSJPROSP,PSJOCDT
"RTN","PSJOCDT",8,0)
 S PSJCLASS=""
"RTN","PSJOCDT",9,0)
 F PSJN1=0:0 S PSJN1=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1)) Q:'PSJN1  D
"RTN","PSJOCDT",10,0)
 .D SETCLASS
"RTN","PSJOCDT",11,0)
 .F PSJDNCNT=0:0 S PSJDNCNT=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",PSJDNCNT)) Q:'PSJDNCNT  D
"RTN","PSJOCDT",12,0)
 ..S PSJNDV=$G(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",PSJDNCNT))
"RTN","PSJOCDT",13,0)
 ..D SETOC
"RTN","PSJOCDT",14,0)
 I '$D(PSJPROSP) Q
"RTN","PSJOCDT",15,0)
 D DSPOC
"RTN","PSJOCDT",16,0)
 Q
"RTN","PSJOCDT",17,0)
DTDGCK ;This version of DT is only executed when the user selects hidden action CK (Drug Check)
"RTN","PSJOCDT",18,0)
 NEW PSJN1,PSJCLASS,PSJDNCNT,PSJNDV,PSJPROSP,PSJOCDT,PSJXX
"RTN","PSJOCDT",19,0)
 S PSJCLASS=""
"RTN","PSJOCDT",20,0)
 F PSJXX=1:1:2 D
"RTN","PSJOCDT",21,0)
 .F PSJN1=0:0 S PSJN1=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1)) Q:'PSJN1  D
"RTN","PSJOCDT",22,0)
 ..I PSJXX=1 I $P(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",1),";",3)'="PROSPECTIVE" Q
"RTN","PSJOCDT",23,0)
 ..I PSJXX=2 I $P(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",1),";",3)'="PROFILE" Q
"RTN","PSJOCDT",24,0)
 ..D SETCLASS
"RTN","PSJOCDT",25,0)
 ..F PSJDNCNT=0:0 S PSJDNCNT=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",PSJDNCNT)) Q:'PSJDNCNT  D
"RTN","PSJOCDT",26,0)
 ...S PSJNDV=$G(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,"DRUGS",PSJDNCNT))
"RTN","PSJOCDT",27,0)
 ...D SETOC
"RTN","PSJOCDT",28,0)
 ..D DSPOC K PSJOCDT,PSJPROSP S PSJCLASS=""
"RTN","PSJOCDT",29,0)
 Q
"RTN","PSJOCDT",30,0)
DSPOC ;
"RTN","PSJOCDT",31,0)
 ;PSJDSPON(ON) - Is set after the order is displayed so the same order is not displayed again
"RTN","PSJOCDT",32,0)
 NEW PSJTYPE,PSJDNM,PSPON,PSJPONX,PSJX,PSJDSPON,PSJCLINF
"RTN","PSJOCDT",33,0)
 I '$G(PSJDUPTF) D PAUSE^PSJLMUT1 W @IOF ;1st time through for dup therapy
"RTN","PSJOCDT",34,0)
 ;
"RTN","PSJOCDT",35,0)
 D HDR
"RTN","PSJOCDT",36,0)
 F PSJTYPE=0:0 S PSJTYPE=$O(PSJOCDT(PSJTYPE)) Q:'PSJTYPE  D
"RTN","PSJOCDT",37,0)
 . S PSJDNM="" F  S PSJDNM=$O(PSJOCDT(PSJTYPE,PSJDNM)) Q:PSJDNM=""  D
"RTN","PSJOCDT",38,0)
 .. S PSJPON="" F  S PSJPON=$O(PSJOCDT(PSJTYPE,PSJDNM,PSJPON)) Q:PSJPON=""  D
"RTN","PSJOCDT",39,0)
 ... K PSJCLINF S PSJCLINF="" I $P(PSJPON,";",2)'="",PSJOCDT(PSJTYPE,PSJDNM,PSJPON)'=""  S PSJCLINF=PSJOCDT(PSJTYPE,PSJDNM,PSJPON),PSJCLINF(2)=PSJPON,PSJCLINF(3)=PSJDNM
"RTN","PSJOCDT",40,0)
 ... I ($Y+6)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",41,0)
 ... S PSJPONX=$P(PSJPON,";",2),PSJDUPTF=1
"RTN","PSJOCDT",42,0)
 ... I PSJTYPE=10,+PSJPONX D
"RTN","PSJOCDT",43,0)
 .... I '$D(PSJDSPON(PSJPONX)) D DSPORD^PSJOC(PSJPONX,,.PSJCLINF)
"RTN","PSJOCDT",44,0)
 .... S PSJDSPON(PSJPONX)=""
"RTN","PSJOCDT",45,0)
 ... I ($Y+8)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",46,0)
 ... I PSJTYPE>10 S PSJDUPTF=1 D
"RTN","PSJOCDT",47,0)
 .... I PSJCLINF D CLNDISP^PSJCLNOC(.PSJCLINF) Q
"RTN","PSJOCDT",48,0)
 .... D EN^PSODRDU2(DFN,PSJPON,"PSJPRE")
"RTN","PSJOCDT",49,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",50,0)
 ;Break the display text this way so the info on classes are indented correctly. CCR 6466
"RTN","PSJOCDT",51,0)
 S PSJCLASS=" Involved in Therapeutic Duplication(s): "_PSJCLASS
"RTN","PSJOCDT",52,0)
 S PSJX=$L(PSJCLASS)\65 I ($Y+PSJX+4)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",53,0)
 W !,"Class(es)"
"RTN","PSJOCDT",54,0)
 D MYWRITE^PSJMISC(PSJCLASS,3,67)
"RTN","PSJOCDT",55,0)
 I ($Y+8)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",56,0)
 W !
"RTN","PSJOCDT",57,0)
 ;D LINE^PSJMISC($S($G(PSJOLDN):PSJLINE,1:"="),81)
"RTN","PSJOCDT",58,0)
 D LINE^PSJMISC("=",81)
"RTN","PSJOCDT",59,0)
 I '$D(PSJOCDT(10)),$D(PSJOCDT),'$D(PSJDGCK)  K PSJPAUSE D PAUSE^PSJLMUT1 W @IOF Q
"RTN","PSJOCDT",60,0)
 ;I ($Y+8)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",61,0)
 I $D(PSJDGCK),$D(^TMP($J,"PSJPRE","OUT","THERAPY")) D PAUSE^PSJMISC(1,) W @IOF Q
"RTN","PSJOCDT",62,0)
 I $D(PSJDGCK) Q
"RTN","PSJOCDT",63,0)
 D CONT
"RTN","PSJOCDT",64,0)
 Q:$G(PSGORQF)
"RTN","PSJOCDT",65,0)
 S PSJY=$$SORTLST()
"RTN","PSJOCDT",66,0)
 K PSJPAUSE
"RTN","PSJOCDT",67,0)
 I PSJY=1 D  Q
"RTN","PSJOCDT",68,0)
 . W !!
"RTN","PSJOCDT",69,0)
 . D:'$D(PSJDGCK) PROCLST(PSJY)
"RTN","PSJOCDT",70,0)
 I (PSJY>1),+$$DCPROMPT() D
"RTN","PSJOCDT",71,0)
 . W !
"RTN","PSJOCDT",72,0)
 . S PSJY=$$LST() W !
"RTN","PSJOCDT",73,0)
 . D:'$D(PSJDGCK) PROCLST(PSJY)
"RTN","PSJOCDT",74,0)
 Q
"RTN","PSJOCDT",75,0)
HDR ;
"RTN","PSJOCDT",76,0)
 NEW PSJHDR,PSJDNM,PSJSTAT SET PSJSTAT=""
"RTN","PSJOCDT",77,0)
 ;
"RTN","PSJOCDT",78,0)
 I $D(^TMP($J,"PSJPRE","OUT","DRUGDRUG")) W @IOF
"RTN","PSJOCDT",79,0)
 D LINE^PSJMISC("=",81)
"RTN","PSJOCDT",80,0)
 S PSJHDR="This patient is already receiving the following INPATIENT and/or OUTPATIENT order(s) for a drug in the same therapeutic class(es)"
"RTN","PSJOCDT",81,0)
 S:$D(PSJDGCK) PSJHDR="This patient is already receiving the following INPATIENT and/or OUTPATIENT order(s) for drugs in the same therapeutic class(es)"
"RTN","PSJOCDT",82,0)
 S PSJDNM=$O(PSJPROSP("UD",""))
"RTN","PSJOCDT",83,0)
 IF $G(PSJDGCK)'="",PSJDNM]"" S PSJHDR=PSJHDR_" as "_PSJDNM_" (Prospective)"_":" D WRITE^PSJMISC(PSJHDR,1,77) Q
"RTN","PSJOCDT",84,0)
 IF $G(PSJDGCK)="",PSJDNM]"" S PSJHDR=PSJHDR_" as "_PSJDNM_":" D WRITE^PSJMISC(PSJHDR,1,77) Q
"RTN","PSJOCDT",85,0)
 D WRITE^PSJMISC(PSJHDR_":",1,77)
"RTN","PSJOCDT",86,0)
HDR2 ;
"RTN","PSJOCDT",87,0)
 W !,"Drug(s) Ordered:"
"RTN","PSJOCDT",88,0)
 S PSJDNM="" F  S PSJDNM=$O(PSJPROSP("IV",PSJDNM)) Q:PSJDNM=""  D
"RTN","PSJOCDT",89,0)
 . W !,?3,PSJDNM
"RTN","PSJOCDT",90,0)
 . I ($Y+8)>IOSL D PAUSE^PSJMISC() W @IOF
"RTN","PSJOCDT",91,0)
 W !
"RTN","PSJOCDT",92,0)
 Q
"RTN","PSJOCDT",93,0)
SETCLASS ;Store all classes to display at the end.
"RTN","PSJOCDT",94,0)
 NEW PSJN2,PSJCLS
"RTN","PSJOCDT",95,0)
 F PSJN2=0:0 S PSJN2=$O(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,PSJN2)) Q:'PSJN2  D
"RTN","PSJOCDT",96,0)
 . S PSJCLS=$G(^TMP($J,"PSJPRE","OUT","THERAPY",PSJN1,PSJN2,"CLASS"))
"RTN","PSJOCDT",97,0)
 . S PSJCLASS=PSJCLASS_$S(PSJCLASS="":"",1:", ")_PSJCLS
"RTN","PSJOCDT",98,0)
 Q
"RTN","PSJOCDT",99,0)
SETOC ;Set PSJOCDT array to sort by Package(Inpt, Outpt: Active, Remote, Pending, Non-VA
"RTN","PSJOCDT",100,0)
 ;PSJPROSP(UD/IV,drugname)="" - This is used to display the header
"RTN","PSJOCDT",101,0)
 ;PSJOCDT(package,drugname,Pharm ord#)=""
"RTN","PSJOCDT",102,0)
 NEW PSJPON,PSJPKG,PSJTYPE,PSJDNM,PSJPONX,PSJCLINF,PSJDXOPT
"RTN","PSJOCDT",103,0)
 S PSJPON=$P(PSJNDV,U) Q:PSJPON=""
"RTN","PSJOCDT",104,0)
 S PSJCLINF="",PSJDXOPT=$S($G(PSJDGCK):"PROSPECTIVE",1:"PROFILE")
"RTN","PSJOCDT",105,0)
 I $P(PSJPON,";",3)'="PROSPECTIVE" D
"RTN","PSJOCDT",106,0)
 .I $P(PSJPON,";")="R" S PSJDXOPT="PROFILE" ;ccr7030
"RTN","PSJOCDT",107,0)
 .S:$D(^TMP($J,"PSJPRE","IN",PSJDXOPT,PSJPON)) PSJCLINF=$P(^TMP($J,"PSJPRE","IN",PSJDXOPT,PSJPON),"^",7)
"RTN","PSJOCDT",108,0)
 S PSJPONX=$P(PSJPON,";",2)
"RTN","PSJOCDT",109,0)
 S PSJTYPE=$P(PSJPON,";") Q:PSJTYPE=""
"RTN","PSJOCDT",110,0)
 S PSJDNM=$P(PSJNDV,U,3) Q:PSJDNM=""
"RTN","PSJOCDT",111,0)
 S PSJPKG=$S(PSJTYPE["C":10,PSJTYPE="I":10,PSJTYPE="O":20,PSJTYPE="R":30,PSJTYPE="P":40,PSJTYPE="N":50,1:"")
"RTN","PSJOCDT",112,0)
 ; Set prospective drug name array to display in the header.
"RTN","PSJOCDT",113,0)
 I PSJPKG=10,($P(PSJPON,";",3)="PROSPECTIVE") D  Q:'$G(PSJDGCK)
"RTN","PSJOCDT",114,0)
 .I PSJPONX["V" S PSJPROSP("IV",PSJDNM)="" Q
"RTN","PSJOCDT",115,0)
 .I PSJPONX["P",+$G(PSJLIFNI) S PSJPROSP("IV",PSJDNM)="" Q
"RTN","PSJOCDT",116,0)
 .I PSJPONX["P",($P($G(^PS(53.1,+PSJPONX,8)),U)]"") S PSJPROSP("IV",PSJDNM)="" Q
"RTN","PSJOCDT",117,0)
 .S PSJPROSP("UD",PSJDNM)=""
"RTN","PSJOCDT",118,0)
 S PSJOCDT(PSJPKG,PSJDNM,PSJPON)=PSJCLINF
"RTN","PSJOCDT",119,0)
 Q
"RTN","PSJOCDT",120,0)
CONT ;Display the continue prompt.
"RTN","PSJOCDT",121,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJOCDT",122,0)
 W !
"RTN","PSJOCDT",123,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")=$S($D(PSJDGCK):"Do you wish to continue",1:"Do you wish to continue with the current order")
"RTN","PSJOCDT",124,0)
 S DIR("?",1)="Enter 'NO' if you wish to not continue with the order,",DIR("?")="or 'YES' to continue with the current order."
"RTN","PSJOCDT",125,0)
 D ^DIR
"RTN","PSJOCDT",126,0)
 I 'Y!($G(PSJDGCK)) S PSGORQF=1 S VALMBCK="R"
"RTN","PSJOCDT",127,0)
 Q
"RTN","PSJOCDT",128,0)
DCPROMPT() ;Prompt if user wants to DC order(s)
"RTN","PSJOCDT",129,0)
 NEW DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,X
"RTN","PSJOCDT",130,0)
 W !
"RTN","PSJOCDT",131,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Do you wish to DISCONTINUE any of the listed INPATIENT orders"
"RTN","PSJOCDT",132,0)
 S DIR("?",1)="Enter 'NO' if you don't wish to discontinue any of the order(s),",DIR("?")="or 'YES' to discontinue selected order(s)."
"RTN","PSJOCDT",133,0)
 D ^DIR
"RTN","PSJOCDT",134,0)
 Q Y
"RTN","PSJOCDT",135,0)
SORTLST() ;Sort orders into a numeric list
"RTN","PSJOCDT",136,0)
 NEW DIR,DIRUT,DTOUT,DUOUT,PSJN,PSJPON1,PSJMONV,PSJS,PSJSEV1,PSJX,X,Y,PSJDNM,PSJPONX,PSJDSPON,PSOCLINF
"RTN","PSJOCDT",137,0)
 ;Sort orders into a numeric list
"RTN","PSJOCDT",138,0)
 Q:'$D(PSJOCDT(10)) 0
"RTN","PSJOCDT",139,0)
 S PSJN=0,PSJDNM=""
"RTN","PSJOCDT",140,0)
 F  S PSJDNM=$O(PSJOCDT(10,PSJDNM)) Q:PSJDNM=""  S PSJS="" F  S PSJS=$O(PSJOCDT(10,PSJDNM,PSJS)) Q:PSJS=""  D
"RTN","PSJOCDT",141,0)
 . S PSJPONX=$P(PSJS,";",2)
"RTN","PSJOCDT",142,0)
 . S PSJCLINF="",PSJCLINF=PSJOCDT(10,PSJDNM,PSJS)
"RTN","PSJOCDT",143,0)
 . ;Business Rule(s): don't show orders that have a status of DISCONTINUED in list
"RTN","PSJOCDT",144,0)
 . Q:$D(PSJDSPON(PSJPONX))
"RTN","PSJOCDT",145,0)
 . S PSJDSPON(PSJPONX)=""
"RTN","PSJOCDT",146,0)
 . S:'$$CKDC^PSJOCDT PSJN=PSJN+1,PSJOCDTL(PSJN)=PSJPONX
"RTN","PSJOCDT",147,0)
 Q PSJN
"RTN","PSJOCDT",148,0)
LST() ;
"RTN","PSJOCDT",149,0)
 ;Only present the list if there are more than 1 orders the list
"RTN","PSJOCDT",150,0)
 F PSJX=0:0 S PSJX=$O(PSJOCDTL(PSJX)) Q:'PSJX  D
"RTN","PSJOCDT",151,0)
 . I ($Y+6)>IOSL D PAUSE^PSJMISC(1,) W @IOF
"RTN","PSJOCDT",152,0)
 . D DSPORD^PSJOC(PSJOCDTL(PSJX),PSJX_".  ")
"RTN","PSJOCDT",153,0)
 W !
"RTN","PSJOCDT",154,0)
 K DIR S DIR(0)="LO^1:"_$O(PSJOCDTL(""),-1),DIR("A")="Enter a list or range of numbers to discontinue" D ^DIR K DIR
"RTN","PSJOCDT",155,0)
 Q Y
"RTN","PSJOCDT",156,0)
PROCLST(PSJY) ;DC the orders selected by user
"RTN","PSJOCDT",157,0)
 NEW PSJX,PSJX1,PSJON,PSJCLINF
"RTN","PSJOCDT",158,0)
 F PSJX1=1:1:$L(PSJY) S PSJX=$P(PSJY,",",PSJX1) Q:PSJX=""  D
"RTN","PSJOCDT",159,0)
 . I ($Y+8)>IOSL D PAUSE^PSJMISC() W @IOF
"RTN","PSJOCDT",160,0)
 . I '$D(PSJOCDTL(PSJX)) Q
"RTN","PSJOCDT",161,0)
 . S PSJON=PSJOCDTL(PSJX),PSJCLINF=0
"RTN","PSJOCDT",162,0)
 . I $D(PSJOCDTL(PSJX,"CLN")) S PSJCLINF=$P(PSJOCDTL(PSJX,"CLN"),"^"),PSJCLINF(2)=$P(PSJOCDTL(PSJX,"CLN"),"^",2),PSJCLINF(3)=$P(PSJOCDTL(PSJX,"CLN"),"^",3)
"RTN","PSJOCDT",163,0)
 . D DC^PSJOCDC(PSGP,PSJON,.PSJCLINF)
"RTN","PSJOCDT",164,0)
 . W !
"RTN","PSJOCDT",165,0)
 Q
"RTN","PSJOCDT",166,0)
CKDC() ; rule: don't show orders that have a status of DISCONTINUED in list
"RTN","PSJOCDT",167,0)
 N PSJCKPON,PSJCKFLD
"RTN","PSJOCDT",168,0)
 S (PSJCKFLD,PSJCKPON)="",PSJCKPON=$S(PSJPONX["U":55.06,PSJPONX["I"!(PSJPONX["V"):55.01,1:53.1)
"RTN","PSJOCDT",169,0)
 S PSJCKFLD=$S(PSJPONX["V"!(PSJPONX="I"):"100",1:"28")  ;Unit dose and pending/non-verified file statuses are in field 28 in each file
"RTN","PSJOCDT",170,0)
 D GETS^DIQ(PSJCKPON,+PSJPONX_","_DFN,PSJCKFLD,"I","DCTMP")
"RTN","PSJOCDT",171,0)
 I '$D(DCTMP(PSJCKPON,+PSJPONX_","_DFN_",",PSJCKFLD,"I")) K DCTMP Q 0
"RTN","PSJOCDT",172,0)
 I DCTMP(PSJCKPON,+PSJPONX_","_DFN_",",PSJCKFLD,"I")="D" K DCTMP Q 1
"RTN","PSJOCDT",173,0)
 K DCTMP Q 0
"RTN","PSJOCOR")
0^36^B3958232
"RTN","PSJOCOR",1,0)
PSJOCOR ;BIR/MV - DISPLAY CPRS ORDER CHECKS ;6 Jun 07 / 3:37 PM
"RTN","PSJOCOR",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**181,252,281**;16 DEC 97;Build 113
"RTN","PSJOCOR",3,0)
 ;
"RTN","PSJOCOR",4,0)
 ; Reference to ^PSDRUG( is supported by DBIA# 2192.
"RTN","PSJOCOR",5,0)
 ; Reference to ^OROCAPI is supported by DBIA# 5367.
"RTN","PSJOCOR",6,0)
 ; Reference to ^ORX8 is supported by DBIA #5469.
"RTN","PSJOCOR",7,0)
 ;
"RTN","PSJOCOR",8,0)
CPRS(PSPDRG) ;Perform Aminoglycoside checks for IV drugs
"RTN","PSJOCOR",9,0)
 ;PSPDRG - Drug array in format of PDRG(n)=IEN (#50) ^ Drug name
"RTN","PSJOCOR",10,0)
 ;Only need to display Aminoglycoside once for an order.  If PSJQUIT is set that means it already displayed
"RTN","PSJOCOR",11,0)
 NEW PSJDD,PSJQUIT,PSJPAUSE,PSJCNT,VAIN
"RTN","PSJOCOR",12,0)
 S PSJPAUSE=0
"RTN","PSJOCOR",13,0)
 W !!
"RTN","PSJOCOR",14,0)
 F PSJCNT=0:0 S PSJCNT=$O(PSPDRG(PSJCNT)) Q:'PSJCNT  Q:$G(PSJQUIT)  S PSJDD=+PSPDRG(PSJCNT) D
"RTN","PSJOCOR",15,0)
 .  D DOC(DFN,$$OROI(+PSJDD))
"RTN","PSJOCOR",16,0)
 .  D GOC(DFN,($P(PSPDRG(PSJCNT),U,2)))
"RTN","PSJOCOR",17,0)
 .  D AOC(DFN,$$VAPROD(+PSJDD))
"RTN","PSJOCOR",18,0)
 I ($Y+4)>IOSL,PSJPAUSE W ! D PAUSE^PSJMISC() W @IOF
"RTN","PSJOCOR",19,0)
 Q
"RTN","PSJOCOR",20,0)
 ;
"RTN","PSJOCOR",21,0)
OROI(PSJDD) ;Get CPRS OI
"RTN","PSJOCOR",22,0)
 ;PSJDD - Drug IEN(#50)
"RTN","PSJOCOR",23,0)
 NEW PSJOI
"RTN","PSJOCOR",24,0)
 Q:'+$G(PSJDD) ""
"RTN","PSJOCOR",25,0)
 S PSJOI=+$P($G(^PSDRUG(+PSJDD,2)),U)
"RTN","PSJOCOR",26,0)
 Q:'PSJOI ""
"RTN","PSJOCOR",27,0)
 Q $$OITM^ORX8(PSJOI,"99PSP")
"RTN","PSJOCOR",28,0)
 ;
"RTN","PSJOCOR",29,0)
DOC(DFN,PSJOROI) ;DANGEREOUS MEDS FOR PAT > 64 ORDER CHECK
"RTN","PSJOCOR",30,0)
 ;DFN - Patient IEN
"RTN","PSJOCOR",31,0)
 ;PSJOROI - CPRS orderable item IEN
"RTN","PSJOCOR",32,0)
 NEW X
"RTN","PSJOCOR",33,0)
 Q:'+$G(DFN)
"RTN","PSJOCOR",34,0)
 Q:'+$G(PSJOROI)
"RTN","PSJOCOR",35,0)
 S X=$P($$DOC^OROCAPI(DFN,+PSJOROI),U,4)
"RTN","PSJOCOR",36,0)
 I X]"" S PSJPAUSE=1 W "***Dangerous Meds for Patient >64***",!! D WRITE^PSJMISC(X) W !
"RTN","PSJOCOR",37,0)
 Q
"RTN","PSJOCOR",38,0)
 ;
"RTN","PSJOCOR",39,0)
GOC(DFN,PSJDNM) ;GLUCOPHAGE LAB RESULTS ORDER CHECK
"RTN","PSJOCOR",40,0)
 ;PSJDNM - Drug name from file 50
"RTN","PSJOCOR",41,0)
 NEW X
"RTN","PSJOCOR",42,0)
 Q:'+$G(DFN)
"RTN","PSJOCOR",43,0)
 Q:$G(PSJDNM)=""
"RTN","PSJOCOR",44,0)
 S X=$P($$GOC^OROCAPI(DFN,PSJDNM),U,4)
"RTN","PSJOCOR",45,0)
 I X]"" S PSJPAUSE=1,PSJQUIT=1 W "***Metformin Lab Results***",!! D WRITE^PSJMISC(X) W !
"RTN","PSJOCOR",46,0)
 Q
"RTN","PSJOCOR",47,0)
 ;
"RTN","PSJOCOR",48,0)
AOC(DFN,PSJPROD) ;AMINOGLYCOSIDE ORDERED ORDER CHECK
"RTN","PSJOCOR",49,0)
 ;PSJPROD - VA Product File (#50.68) IEN.
"RTN","PSJOCOR",50,0)
 ;PSJQUIT is set so Aminoglycoside is only warn once per session.
"RTN","PSJOCOR",51,0)
 NEW X
"RTN","PSJOCOR",52,0)
 Q:'+$G(DFN)
"RTN","PSJOCOR",53,0)
 Q:'+$G(PSJPROD)
"RTN","PSJOCOR",54,0)
 S X=$P($$AOC^OROCAPI(DFN,+PSJPROD),U,4)
"RTN","PSJOCOR",55,0)
 I X]"" S PSJPAUSE=1,PSJQUIT=1 W "***Aminoglycoside Ordered****",!! D WRITE^PSJMISC(X) W !
"RTN","PSJOCOR",56,0)
 Q
"RTN","PSJOCOR",57,0)
 ;
"RTN","PSJOCOR",58,0)
VAPROD(PSJDD) ;Return VA PRODUCT IEN (50.68)
"RTN","PSJOCOR",59,0)
 ;PSJDD - Dispense drug IEN (50)
"RTN","PSJOCOR",60,0)
 Q $P($G(^PSDRUG(+PSJDD,"ND")),U,3)
"RTN","PSJOCOR",61,0)
 ; 
"RTN","PSJOE")
0^21^B103230773
"RTN","PSJOE",1,0)
PSJOE ;BIR/MLM - INPATIENT ORDER ENTRY ;23 Jun 98  1:46 PM
"RTN","PSJOE",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**7,26,29,33,42,50,56,72,58,85,95,80,110,111,133,140,151,149,181,252,281**;16 DEC 97;Build 113
"RTN","PSJOE",3,0)
 ;
"RTN","PSJOE",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOE",5,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSJOE",6,0)
 ; Reference to FULL^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",7,0)
 ; Reference to PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",8,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSJOE",9,0)
 ; Reference to ^DPT( is supported by DBIA #10035.
"RTN","PSJOE",10,0)
 ; Reference to ^ORCFLAG is supported by DBIA #3620.
"RTN","PSJOE",11,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJOE",12,0)
 ; Reference to ^TMP("PSODAOC" is supported by DBIA #6071.
"RTN","PSJOE",13,0)
 ;
"RTN","PSJOE",14,0)
EN ; Start Inpatient LM OE
"RTN","PSJOE",15,0)
 N PSJLK,PSJNEWOE,PSJLMCON,PSJPROT,XQORS,VALMEVL D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",16,0)
 I $D(XQUIT) K XQUIT G DONE
"RTN","PSJOE",17,0)
 K PSGVBY,PSJPR S (PSJOL,PSJACOK,PSGOP,PSGNEF,PSGOEAV,PSGPXN)="" L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE^PSJOE
"RTN","PSJOE",18,0)
 F  S (PSJLMCON,PSGPTMP)=0 D ^PSJP,HK Q:PSGP'>0  S PSJPROT=3,DFN=PSGP D ^PSJAC D  I PSJLK D UL^PSSLOCK(PSGP)
"RTN","PSJOE",19,0)
 .K ^TMP("PSJ",$J)
"RTN","PSJOE",20,0)
 .S PSJLK=$$L^PSSLOCK(PSGP,1) I 'PSJLK W !,$C(7),$P(PSJLK,U,2) Q
"RTN","PSJOE",21,0)
 .K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",22,0)
 .N NXTPT S NXTPT=0 F  Q:$G(NXTPT)  D
"RTN","PSJOE",23,0)
 ..K PSGRDTX
"RTN","PSJOE",24,0)
 ..I $G(PSJLMCON)!$G(PSJNEWOE) D
"RTN","PSJOE",25,0)
 ...S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSJOE",26,0)
 ...S PSJLMPRO=1,PSJLMCON=1,PSJNEWOE=0 D EN^VALM("PSJ LM OE")
"RTN","PSJOE",27,0)
 ..I $G(PSJNEWOE)!($G(VALMBCK)="Q") S PSJNEWOE=0 Q
"RTN","PSJOE",28,0)
 ..I $G(PSJLMCON)&$G(PSJLMPRO)&'$D(^TMP("PSJ",$J)) D  Q
"RTN","PSJOE",29,0)
 ...S PSJLMCON=0,PSJLMPRO=0 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",30,0)
 ...I $G(PSJNEWOE) S NXTPT=0 Q
"RTN","PSJOE",31,0)
 ...S NXTPT=1
"RTN","PSJOE",32,0)
 ..S NXTPT=1,PSJNEWOE=0
"RTN","PSJOE",33,0)
 .S PSJOL="S"
"RTN","PSJOE",34,0)
 .I $G(PSGPXN) I $P(PSJSYSW0,U,29)]""!($G(PSJCOM)) S PSGPXPT=PSGP D  K PSGPXPT S PSGPXN=0
"RTN","PSJOE",35,0)
 ..N DFN,PSGP,PSJPXDP
"RTN","PSJOE",36,0)
 ..I $P(PSJSYSW0,U,29)="" S PSJPDXP=1 D
"RTN","PSJOE",37,0)
 ...;N IO,ION,IOS D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",38,0)
 ...D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",39,0)
 ..S (PSGP,DFN)=PSGPXPT D ^PSGPER S:$G(PSJPDXP) $P(PSJSYSW0,U,29)="" K PSJPDXP
"RTN","PSJOE",40,0)
 .D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",41,0)
 K PSJLMPRO,^TMP("PSJPRO",$J),^TMP("PSJ",$J),^TMP("PSJON",$J)
"RTN","PSJOE",42,0)
DONE ;
"RTN","PSJOE",43,0)
 ; -- RTC 198753 - correct typo - r PSJALGSV w PSJAGYSV
"RTN","PSJOE",44,0)
 K PSJAGYSV,PSJEXCPT,PSJOCER,^TMP($J,"PSJPRE"),^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",45,0)
 K AC,ACTION,D1,D2,MI,N,ON,P3,PNOW,PSIVAT,PSIVLN,PSIVSTR L -^PS(53.45,PSJSYSP)
"RTN","PSJOE",46,0)
 K DA,DRG,NE,PSGCF,PSGCANFL,PSGNEDFD,PSGNEF,PSGNEFD,PSGNEPR,PSGNESD,PSJACOK,PSJOE,PSJOECNT,PSJOEPF,PSJORD,PSGOEA,PSGOEAV,PSGOL,PSGOS,PSGON,PSGOP,PSGORD,PSGS0XT,PSGS0Y,RCT,ST,WD,XREF,Z,PSJIVORF,PSJIVPCL
"RTN","PSJOE",47,0)
 K PSGOEORF,PSIVREA,PSJOPC,PSJORL,PSJORPCL,PSJORTOI,RF,WSCHADM,PSJLM,PSJCT
"RTN","PSJOE",48,0)
 K DIU,DRGI,FLAG,FQC,ND2,PRI,PSGOE,PSGPRI,PSGSDN,PSGOEDMR,PSGOEPR,PSGPTS,PSGTOL,PSGTOO,PSGUOW,PSJIVOF,PSJOCNT,PSJON,PSJORQF,PSJORTOU,PSJORVP
"RTN","PSJOE",49,0)
 K PSIVENO
"RTN","PSJOE",50,0)
 G:$G(PSGPXN) ^PSGPER1 D ENIVKV^PSGSETU
"RTN","PSJOE",51,0)
 Q
"RTN","PSJOE",52,0)
HK ; Housekeeping (a nice COBOL term)
"RTN","PSJOE",53,0)
 I PSGOP,PSGOP'=PSGP D
"RTN","PSJOE",54,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSJOE",55,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,"^",2)]"" ENQL^PSGLW
"RTN","PSJOE",56,0)
 Q:PSGP<0
"RTN","PSJOE",57,0)
 S (DFN,PSGOP)=PSGP,X=""
"RTN","PSJOE",58,0)
 Q
"RTN","PSJOE",59,0)
SELECT ; Select order from list
"RTN","PSJOE",60,0)
 ;Variable PSJOCDSC is used in Complex order dosing checks
"RTN","PSJOE",61,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX,PSJOCDSC,PSJAGYSV K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),PSJSTARI,^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",62,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON
"RTN","PSJOE",63,0)
 I "^"[X S VALMQUIT=1 Q
"RTN","PSJOE",64,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL!($G(Y)<0)  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",65,0)
 .K PSJOCDSC
"RTN","PSJOE",66,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA Q:PSJORD=""!($G(Y)<0)  Q:PSJORD=+PSJORD  D
"RTN","PSJOE",67,0)
 ..Q:('$$LS^PSSLOCK(PSGP,PSJORD))
"RTN","PSJOE",68,0)
 ..Q:PSJORD=+PSJORD
"RTN","PSJOE",69,0)
 ..S PSGORD=""
"RTN","PSJOE",70,0)
 ..D DISACTIO(PSGP,PSJORD,"") S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",71,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",72,0)
 S VALMBCK="Q"
"RTN","PSJOE",73,0)
 K PSJLM,PSJOCDSC
"RTN","PSJOE",74,0)
 Q
"RTN","PSJOE",75,0)
DISACTIO(DFN,PSJORD,PSJPNV)       ; Display UD order and allow actions.
"RTN","PSJOE",76,0)
 ; PSJORD - Order #_location Code (P:53.1,V:55.01,U:55.06)
"RTN","PSJOE",77,0)
 ; PSJPNV - Invoked from Pending/NV option; (gets different hidden menu)
"RTN","PSJOE",78,0)
 ; PSJDSVFY - Flag if non-vf order was edited
"RTN","PSJOE",79,0)
 ; PSJENHOC=1 if DI,DT were display. This will be used by dosing OC to check if error messages should display or not
"RTN","PSJOE",80,0)
 ; PSJAGYSV=1 If UD was edited
"RTN","PSJOE",81,0)
 ;N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55,PSJDSVFY,PSJENHOC,PSJAGYSV
"RTN","PSJOE",82,0)
 N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55,PSJDSVFY,PSJENHOC,PSIVENO
"RTN","PSJOE",83,0)
 D OLDCOM^PSJOE0(DFN,PSJORD)
"RTN","PSJOE",84,0)
 S PSGP=DFN D ENIV^PSJAC I PSJORD["V" D EN^PSJLIORD(DFN,PSJORD) Q
"RTN","PSJOE",85,0)
 D GETUD^PSJLMGUD(DFN,PSJORD)
"RTN","PSJOE",86,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",87,0)
 S:$G(PSJTUD) PSGPD=$G(PSJCOI),PSGPDN=$$OINAME^PSJLMUTL(+PSGPD)
"RTN","PSJOE",88,0)
 K PSGOENG I '$D(PSGPRF) D  Q:$G(PSGOENG)
"RTN","PSJOE",89,0)
 . I PSJORD["U" L +^PS(55,PSGP,5,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",90,0)
 . I PSJORD["P" L +^PS(53.1,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",91,0)
 . I $G(PSGOENG) W !,"This order is being edited by another terminal.",! S PSGOENG=1 K DIR S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSJOE",92,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD)
"RTN","PSJOE",93,0)
 I PSJORD["P" S PSJXX1=$G(^PS(53.1,+PSJORD,0)) I PSGP'=$P(PSJXX1,U,15)!(DFN'=$P(PSJXX1,U,15)) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",94,0)
 I PSJORD["P" D  S PSJXX1=$P($G(^PS(53.1,+PSJORD,0)),U,9) I $S($G(PSJIVFLG):1,$G(Y)<0:1,"PADE"[PSJXX1:1,1:0) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",95,0)
 .I $P(PSJXX1,U,9)="N",($P(PSJXX1,U,4)'="U") D  Q
"RTN","PSJOE",96,0)
 .. S P("PON")=PSJORD,PSIVFLG=1
"RTN","PSJOE",97,0)
 .. N ON S ON=PSJORD D VF^PSIVORC2
"RTN","PSJOE",98,0)
 .I $P(PSJXX1,U,9)="P" D  Q
"RTN","PSJOE",99,0)
 ..S:$G(PSJTUD) $P(PSJXX1,U,4)="U"
"RTN","PSJOE",100,0)
 ..I $P(PSJXX1,U,4)="U" D  Q:$G(PSJIVFLG)
"RTN","PSJOE",101,0)
 ... N VAIP S CLINIC=$G(^PS(53.1,+PSJORD,"DSS")),APPT=$P(CLINIC,"^",2),CLINIC=$P(CLINIC,"^") I $$PATCH^XPDUTL("SD*5.3*285"),$$SDIMO^SDAMA203(CLINIC,DFN)>-1 Q
"RTN","PSJOE",102,0)
 ... Q:'PSJPDD  W !!,"Cannot process an Out-patient Unit Dose order for ",$P($G(^DPT(+PSGP,0)),U) D PAUSE^VALM1 S PSJIVFLG=1
"RTN","PSJOE",103,0)
 ..NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJOE",104,0)
 ..D REQDT^PSJLIVMD(PSJORD)
"RTN","PSJOE",105,0)
 ..I $P(PSJXX1,U,4)="U",($G(PSGSCH)="") W !!,"Invalid schedule, can't finish this order" D PAUSE^VALM1 Q
"RTN","PSJOE",106,0)
 ..I $P(PSJXX1,U,4)="U" N PSJLM,PSJOCFG S PSJLM=1,PSGORD=PSJORD,PSJOCFG="FN UD" D START^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD) S:$G(PSJTUD) PSJOCFG="FN UD" D @$S($G(PSJTUD):"FINISH^PSGOEF",1:"EN^VALM(""PSJ LM PENDING EDIT"")") K PSJOCFG Q
"RTN","PSJOE",107,0)
 ..I $P(PSJXX1,U,4)'="U",PSGP=$P(PSJXX1,U,15),DFN=$P(PSJXX1,U,15) S PSJLYN=PSJORD,PSJOCFG="FN IV" D EN^PSJLIFN S PSJIVFLG=1 K PSJLYN,PSJMAI,PSJOCFG
"RTN","PSJOE",108,0)
 I $G(PSIVFLG) K PSIVFLG Q
"RTN","PSJOE",109,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD),PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSJORD),ENSFE^PSGOEE0(PSGP,PSJORD),EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE",110,0)
 I PSJORD["P" L -^PS(53.1,+PSJORD)
"RTN","PSJOE",111,0)
 I PSJORD["U" L -^PS(55,PSGP,5,+PSJORD)
"RTN","PSJOE",112,0)
 ;Send SN to CPRS if auto-verify OFF and Order Set Entry and no 21st piece
"RTN","PSJOE",113,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",114,0)
 I $D(PSGOES),'PSGOEAV,$D(PSGORD),PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSJOE",115,0)
 I $G(PSGOEAV),($G(PSGOES)=1) D SETOC ;Store allergy for order set /w auto vf 
"RTN","PSJOE",116,0)
 I '$G(PSGOEAV),($G(PSJORD)["P"),$S($G(PSJAGYSV):1,($G(PSJOCFG)="NEW UD"):1,1:0) D SETOC
"RTN","PSJOE",117,0)
 D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",118,0)
 Q
"RTN","PSJOE",119,0)
SETOC ;
"RTN","PSJOE",120,0)
 ;RTC 178789 
"RTN","PSJOE",121,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSJORD
"RTN","PSJOE",122,0)
 D SETOC^PSJNEWOC(PSJORD)
"RTN","PSJOE",123,0)
 K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J),PSJAGYSV,PSJOCFG
"RTN","PSJOE",124,0)
 Q
"RTN","PSJOE",125,0)
EDIT(PSGP,PSGORD,PROMPT) ;
"RTN","PSJOE",126,0)
 I "DE"[$$GTSTATUS(PSGP,PSGORD) W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",127,0)
 I PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",128,0)
 N PSJEDITO S PSJEDITO=1
"RTN","PSJOE",129,0)
 S PSJAGYSV=1 ;Flag to store allergy data in 100.05.
"RTN","PSJOE",130,0)
 S PSGNEDFD="" D HOLDHDR,@$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") I 'Y D ABORT^PSGOEE Q
"RTN","PSJOE",131,0)
 I PSGORD["P" D ENF^PSGOEE Q
"RTN","PSJOE",132,0)
 D ACT^PSGOEE
"RTN","PSJOE",133,0)
 Q
"RTN","PSJOE",134,0)
RENEW(PSGP,PSGORD) ;
"RTN","PSJOE",135,0)
 ;PSJOCFG - If defined, it's for new order, renew or copy. ^PSJOCDSD using this flag to not display drug error.
"RTN","PSJOE",136,0)
 NEW PSJOCFG
"RTN","PSJOE",137,0)
 S PSJOCFG="RENEW UD"
"RTN","PSJOE",138,0)
 D HOLDHDR
"RTN","PSJOE",139,0)
 I 'PSJSYSU,$P($G(^PS(55,PSGP,5,+PSGORD,4)),U,15),$P($G(^(4)),U,16) W !!,"This order is already marked for renewal!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJOE",140,0)
 I 'PSGRRF D ^PSGOER K PSJOCFG Q
"RTN","PSJOE",141,0)
 D ^PSGOERI
"RTN","PSJOE",142,0)
 K PSJOCFG
"RTN","PSJOE",143,0)
 Q
"RTN","PSJOE",144,0)
GTSTATUS(DFN,ON)   ;
"RTN","PSJOE",145,0)
 I ON["P" Q $P($G(^PS(53.1,+ON,0)),U,9)
"RTN","PSJOE",146,0)
 I ON["U" Q $P($G(^PS(55,DFN,5,+ON,0)),U,9)
"RTN","PSJOE",147,0)
 Q $P($G(^PS(55,DFN,"IV",+ON,0)),U,17)
"RTN","PSJOE",148,0)
DC(DFN,PSJORD) ; DC IV, UD, or pending orders.
"RTN","PSJOE",149,0)
 D HOLDHDR
"RTN","PSJOE",150,0)
 S X=$$GTSTATUS(DFN,PSJORD) I X="D"!(X="DE")!(X="R") W !,$S(X="R":"This order has a pending renewal and cannot be DISCONTINUED.",1:"This order has already been DISCONTINUED.") D PAUSE^VALM1 Q
"RTN","PSJOE",151,0)
 D ENO^PSGOEC(DFN,PSJORD) ;,GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S VALMBCK="Q"
"RTN","PSJOE",152,0)
 S VALMBCK="Q"
"RTN","PSJOE",153,0)
 Q
"RTN","PSJOE",154,0)
HOLD(DFN,PSJORD) ; Change order's status from ACTIVE<->HOLD
"RTN","PSJOE",155,0)
 D HOLDHDR
"RTN","PSJOE",156,0)
 I PSJORD["V" D H^PSIVOPT(DFN,PSJORD,P(17),P(3))
"RTN","PSJOE",157,0)
 I PSJORD'["V" D H^PSGOE1(DFN,PSJORD)
"RTN","PSJOE",158,0)
 D GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S PSGACT=$$ENACTION^PSGOE1(DFN,PSJORD),VALMBCK="R"
"RTN","PSJOE",159,0)
 Q
"RTN","PSJOE",160,0)
COPY(PSGP,PSGORD)  ; Copy an order (does not discontinue original order)
"RTN","PSJOE",161,0)
 NEW PSJOCFG
"RTN","PSJOE",162,0)
 I $D(PSGCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",163,0)
 I PSGORD["P" W !!,"You cannot copy this "_$S($G(PSGSTAT)]"":PSGSTAT,1:"PENDING IV")_" order." D PAUSE^VALM1 Q
"RTN","PSJOE",164,0)
 I PSGORD["V" D  Q
"RTN","PSJOE",165,0)
 .I $G(PSIVCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",166,0)
 .S PSJOCFG="COPY IV"
"RTN","PSJOE",167,0)
 .D COPY^PSIVOD(PSGP,PSGORD) K PSJOCFG Q
"RTN","PSJOE",168,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")
"RTN","PSJOE",169,0)
 D ^PSJHVARS
"RTN","PSJOE",170,0)
 I $P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSJOE",171,0)
 S PSJOCFG="COPY UD"
"RTN","PSJOE",172,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU
"RTN","PSJOE",173,0)
 S PSGCOPY=1
"RTN","PSJOE",174,0)
 D FULL^VALM1,^PSGOD
"RTN","PSJOE",175,0)
 S VALMBCK="R"
"RTN","PSJOE",176,0)
 K PSGCOPY,PSJOCFG
"RTN","PSJOE",177,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSGORD) ; resets PSGACT after copy
"RTN","PSJOE",178,0)
 I $G(PSGPXN) N PSGTMPXN S PSGTMPXN=PSGPXN
"RTN","PSJOE",179,0)
 D RESTORE^PSJHVARS I $G(PSGTMPXN) S PSGPXN=PSGTMPXN
"RTN","PSJOE",180,0)
 Q
"RTN","PSJOE",181,0)
UPDATE ; Refresh array, actions, & display.
"RTN","PSJOE",182,0)
 D GETUD^PSJLMGUD(DFN,ON),INIT^PSJLMUDE(DFN,ON) S VALMBCK="R"
"RTN","PSJOE",183,0)
 Q
"RTN","PSJOE",184,0)
FINISH ;
"RTN","PSJOE",185,0)
 D FINISH^PSGOEF,PAUSE^VALM1
"RTN","PSJOE",186,0)
 Q
"RTN","PSJOE",187,0)
LOG(DFN,PSGORD)        ;
"RTN","PSJOE",188,0)
 D FULL^VALM1,ENLM^PSGOEL(DFN,PSGORD),PAUSE^VALM1 S VALMBCK="R"
"RTN","PSJOE",189,0)
 Q
"RTN","PSJOE",190,0)
NEWSEL ;
"RTN","PSJOE",191,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX,PSJOCDSC,PSJAGYSV K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J)
"RTN","PSJOE",192,0)
 S X=$P(XQORNOD(0),"=",2)
"RTN","PSJOE",193,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0)
"RTN","PSJOE",194,0)
 D ENCHK^PSGON I '$O(PSGODDD(0)) S VALMQUIT=1 Q
"RTN","PSJOE",195,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",196,0)
 .K PSJOCDSC
"RTN","PSJOE",197,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA
"RTN","PSJOE",198,0)
 .Q:PSJORD=+PSJORD 
"RTN","PSJOE",199,0)
 .Q:PSJORD=""!($G(Y)<0)  Q:('$$LS^PSSLOCK(PSGP,PSJORD))  D
"RTN","PSJOE",200,0)
 ..S PSGORD=""
"RTN","PSJOE",201,0)
 ..S ON=PSJORD
"RTN","PSJOE",202,0)
 ..D DISACTIO(PSGP,PSJORD,$G(PSJPNV)) S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",203,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",204,0)
 ..I $G(PSJNOL) K PSJNOL I $D(ON),ON'=PSJORD D UNL^PSSLOCK(PSGP,ON)
"RTN","PSJOE",205,0)
 ..Q:$G(Y)<0
"RTN","PSJOE",206,0)
 I '$G(PSGOEAV),($G(PSJORD)["P"),$G(PSJAGYSV) D
"RTN","PSJOE",207,0)
 .;RTC 178789 
"RTN","PSJOE",208,0)
 .S ^TMP("PSODAOC",$J,"IP IEN")=PSJORD
"RTN","PSJOE",209,0)
 .D SETOC^PSJNEWOC(PSJORD)
"RTN","PSJOE",210,0)
 .K ^TMP("PSODAOC",$J),^TMP("PSJDAOC",$J),PSJAGYSV
"RTN","PSJOE",211,0)
 S VALMBCK="Q"
"RTN","PSJOE",212,0)
 K PSJLM,PSJOCDSC
"RTN","PSJOE",213,0)
 Q
"RTN","PSJOE",214,0)
HOLDHDR ; Freeze header text while processing order actions
"RTN","PSJOE",215,0)
 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSJOE",216,0)
 Q
"RTN","PSJOE",217,0)
LOCKERR ;
"RTN","PSJOE",218,0)
 W !!,$C(7),"You are entering or editing an Inpatient Medication order in another session.",!,"Only one order entry/edit session is allowed for a user at a time.",!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJOE",219,0)
 Q
"RTN","PSJOE",220,0)
FLAG(DFN,PSJORD) ;Flag order through CPRS entry point.
"RTN","PSJOE",221,0)
 N ORIFN,NODE0
"RTN","PSJOE",222,0)
 S NODE0=$S(PSJORD["V":$G(^PS(55,DFN,"IV",+PSJORD,0)),PSJORD["U":$G(^PS(55,DFN,5,+PSJORD,0)),1:^PS(53.1,+PSJORD,0))
"RTN","PSJOE",223,0)
 S ORIFN=$P(NODE0,"^",21)
"RTN","PSJOE",224,0)
 D EN1^ORCFLAG(ORIFN)
"RTN","PSJOE",225,0)
 D PAUSE^VALM1
"RTN","PSJOE",226,0)
 Q
"RTN","PSJOE",227,0)
COMPLEX(DFN,ON) ;
"RTN","PSJOE",228,0)
 N NDP2,COM
"RTN","PSJOE",229,0)
 S NDP2=$S(ON["P":$G(^PS(53.1,+ON,.2)),ON["U":$G(^PS(55,DFN,5,+ON,.2)),ON["V":$G(^PS(55,DFN,"IV",+ON,.2)),1:"")
"RTN","PSJOE",230,0)
 S COM=$P(NDP2,"^",8) I COM Q 1
"RTN","PSJOE",231,0)
 Q 0
"RTN","PSJOE1")
0^40^B30534447
"RTN","PSJOE1",1,0)
PSJOE1 ;BIR/CML3-UD OE FOR COMBINED OE ;29 JAN 99 / 9:44 AM
"RTN","PSJOE1",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**2,7,25,30,47,56,64,179,181,252,281**;16 DEC 97;Build 113
"RTN","PSJOE1",3,0)
 ;
"RTN","PSJOE1",4,0)
 ; Reference to ^DICN is supported by DBIA# 10009
"RTN","PSJOE1",5,0)
 ; Reference to ^VALM is supported by DBIA# 10118
"RTN","PSJOE1",6,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSJOE1",7,0)
 ;
"RTN","PSJOE1",8,0)
 S PC=0 G AD
"RTN","PSJOE1",9,0)
 ;
"RTN","PSJOE1",10,0)
EN ;
"RTN","PSJOE1",11,0)
 S PC=0
"RTN","PSJOE1",12,0)
 ;
"RTN","PSJOE1",13,0)
AD ; Ask Drug
"RTN","PSJOE1",14,0)
 ;PSJOCFG - If defined, it's for new order, renew or copy. ^PSJOCDSD using this flag to not display drug error.
"RTN","PSJOE1",15,0)
 K PSJOCFG
"RTN","PSJOE1",16,0)
 N PSJNORD,PSGORQF,PSGSDX,PSGFDX,PSGNEFDO,PSGEDTOI,PSJOCFG S PSJOCFG="NEW UD" S PSJNORD=1 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC,@IOSTBM,IORC
"RTN","PSJOE1",17,0)
 K PSGORQF
"RTN","PSJOE1",18,0)
 D ^PSGOE7
"RTN","PSJOE1",19,0)
 I $G(PSGORQF) S PSJORQF=1 G DONE
"RTN","PSJOE1",20,0)
 S PC=1,PSJORQF=0 I X?1"S."1.E D ^PSGOES G AD
"RTN","PSJOE1",21,0)
 D ^PSGOE4:'$P(PSJSYSP0,"^",12),^PSGOE3:$P(PSJSYSP0,"^",12)
"RTN","PSJOE1",22,0)
 G:$G(PSGOROE1)=1 AD
"RTN","PSJOE1",23,0)
 K PSGEFN,PSGOEEF,PSGOEE,PSGOEOS S PSGEFN="1:13" F X=1:1:13 S PSGEFN(X)=""
"RTN","PSJOE1",24,0)
 S PSGPDN=$$OINAME^PSJLMUTL(PSGPDRG),PSGPD=PSGPDRG,PSGOINST="",PSGSDN=$$ENDD^PSGMI(PSGNESD)_U_$$ENDTC^PSGMI(PSGNESD),PSGFDN=$$ENDD^PSGMI(PSGNEFD)_U_$$ENDTC^PSGMI(PSGNEFD)
"RTN","PSJOE1",25,0)
 S PSGAT=PSGS0Y,PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT),PSGLI=PSGDT,PSGEBN=$$ENNPN^PSGMI(DUZ),PSGSTAT=$S(PSGOEAV:"ACTIVE",1:"NON-VERIFIED")
"RTN","PSJOE1",26,0)
 D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSJOE1",27,0)
 S PSGSD=PSGNESD,PSGFD=PSGNEFD
"RTN","PSJOE1",28,0)
 K PSJACEPT S VALMBCK="Q" D:$D(Y) EN^VALM("PSJU LM ACCEPT")
"RTN","PSJOE1",29,0)
 I $G(PSJACEPT)=1 D
"RTN","PSJOE1",30,0)
 . D OC
"RTN","PSJOE1",31,0)
 . ;D:'$G(PSGORQF) IN^PSJOCDS($G(PSGORD),"UD",+$G(PSGDRG))
"RTN","PSJOE1",32,0)
 ;If intervention is not log then quit
"RTN","PSJOE1",33,0)
 I $G(PSGORQF)=1 S PSJACEPT=0
"RTN","PSJOE1",34,0)
 S PSJNOO=-1 I $G(PSJACEPT)=1 S PSJNOO=$$ENNOO^PSJUTL5("N")
"RTN","PSJOE1",35,0)
 I $G(PSJNOO)<0 K PSJACEPT W !,"No order created." G AD
"RTN","PSJOE1",36,0)
 K PSGOEE D ^PSGOETO S PSJORD=PSGORD
"RTN","PSJOE1",37,0)
 S ^TMP("PSODAOC",$J,"IP IEN")=PSGORD
"RTN","PSJOE1",38,0)
 ;RTC 178746 - Don't store allergy here.
"RTN","PSJOE1",39,0)
 ;D SETOC^PSJNEWOC(PSGORD)
"RTN","PSJOE1",40,0)
 I PSGOEAV D  G AD
"RTN","PSJOE1",41,0)
 . D SETOC^PSJNEWOC(PSGORD) ;RTC 17874
"RTN","PSJOE1",42,0)
 .I '$D(PSGOEE),+PSJSYSU=3 D EN^PSGPEN(PSGORD)
"RTN","PSJOE1",43,0)
 S PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSGORD),ENSFE^PSGOEE0(PSGP,PSGORD),^PSGOE1,EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE1",44,0)
 ;RTC 178746 - store allergy if not verify the newly created order.
"RTN","PSJOE1",45,0)
 I ($G(PSGORD)["P"),($P($G(^PS(53.1,+PSGORD,0)),U,9)="N"),($G(PSJOCFG)="NEW UD") D SETOC^PSJNEWOC(PSGORD)
"RTN","PSJOE1",46,0)
 G AD
"RTN","PSJOE1",47,0)
 Q
"RTN","PSJOE1",48,0)
OC ;
"RTN","PSJOE1",49,0)
 NEW PSJDD,PSJALLGY,PSJALGY1
"RTN","PSJOE1",50,0)
 K PSGORQF
"RTN","PSJOE1",51,0)
 D FULL^VALM1
"RTN","PSJOE1",52,0)
 S PSJDD=+$$DD53P45^PSJMISC() I 'PSJDD S PSGORQF=1 Q
"RTN","PSJOE1",53,0)
 I +$G(PSGEDTOI) D
"RTN","PSJOE1",54,0)
 . S PSJALGY1=1
"RTN","PSJOE1",55,0)
 . D ENDDC^PSGSICHK($G(PSGP),PSJDD)
"RTN","PSJOE1",56,0)
 D:'$G(PSGORQF) IN^PSJOCDS($G(PSGORD),"UD",PSJDD)
"RTN","PSJOE1",57,0)
 Q
"RTN","PSJOE1",58,0)
EDIT(PROMPT) ;
"RTN","PSJOE1",59,0)
 ; Edit fields in a UD order.
"RTN","PSJOE1",60,0)
 ; PROMPT=0 - Select fields to edit by number.
"RTN","PSJOE1",61,0)
 ; PROMPT=1 - Prompt to select fields for editing.
"RTN","PSJOE1",62,0)
 ;
"RTN","PSJOE1",63,0)
 ;* D @$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") Q:'Y  S PSGOEEG=3 D EDIT^PSGOEE ;$S(PSGOEEWF[53.1:3,1:5) D:Y EDIT^PSGOEE
"RTN","PSJOE1",64,0)
 D @$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") Q:'Y  S:$G(PSJNEWOE) PSGOEEWF="^PS(53.1," S PSGOEEG=$S('$D(PSGOEEWF):3,PSGOEEWF[53.1:3,1:5) D EDIT^PSGOEE
"RTN","PSJOE1",65,0)
 I $G(PSJNEWOE) S PSGOEENO=0,DR="",VALMBCK="R"
"RTN","PSJOE1",66,0)
 I '$G(PSJNEWOE) D ENNOU^PSGOEE0 I 'PSGOEENO,DR="" S VALMBCK="R" Q
"RTN","PSJOE1",67,0)
 I 'PSGOEENO,$D(PSGOES) D ENNOU^PSGOEE0  ; only update on order sets
"RTN","PSJOE1",68,0)
 ;*179 No longer call CKDT^PSGOEE from here.
"RTN","PSJOE1",69,0)
 ;I 'PSGOEENO,$G(PSGPDNX)=1 D CKDT^PSGOEE
"RTN","PSJOE1",70,0)
 I $G(PSGOEER)["101^PSGOE8" S PSGEDTOI=1
"RTN","PSJOE1",71,0)
 K VALMSG I PSGOEENO D
"RTN","PSJOE1",72,0)
 .S VALMSG="This change will cause a new order to be created." D GTSTATUS^PSGOEE,CHKDD^PSGOEE
"RTN","PSJOE1",73,0)
 .S PSGEBN=$$ENNPN^PSGMI(DUZ),PSGLIN=$$ENDD^PSGMI(PSGDT)_U_$$ENDTC^PSGMI(PSGDT),PSGLI=PSGDT
"RTN","PSJOE1",74,0)
 D CHK^PSGOEV("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGSD_"^^"_PSGFD)
"RTN","PSJOE1",75,0)
 D INIT^PSJLMUDE(PSGP,$G(PSGORD))
"RTN","PSJOE1",76,0)
 Q
"RTN","PSJOE1",77,0)
DONE ;
"RTN","PSJOE1",78,0)
 K %,DA,DIC,DIE,DR,DRG,DRGN,DRGO,ND,OC,ORIFN,ORIT,ORPK,ORSTOP,ORSTRT,ORSTS,ORTX,PC,PSGDO,PSGMR,PSGMRN,PSGNEDFD,PSGNEFD,PSGNESD,PSGOES,PSGOROE1,PSGORD,PSGS0XT,PSGS0Y,PSGSCH,PSGSI,PSGX,Y,Z Q
"RTN","PSJOE1",79,0)
 K PSGEDTOI,PSJOCFG
"RTN","PSJOE1",80,0)
 ;
"RTN","PSJOE1",81,0)
GDO ;
"RTN","PSJOE1",82,0)
 W !!,"Drug is not found in Formulary List." F  S %=1 W !,"Would you like to try to search the list again" D YN^DICN Q:%  D TAM
"RTN","PSJOE1",83,0)
 Q:%<2
"RTN","PSJOE1",84,0)
FTD ;
"RTN","PSJOE1",85,0)
 R !!,"Enter FREE TEXT DRUG: ",PSGDRGN:DTIME E  W $C(7) S PSGDRGN="^" Q
"RTN","PSJOE1",86,0)
 Q:"^"[PSGDRGN  S X=$S(PSGDRGN'?.ANP:"Control character(s)",PSGDRGN["^":"Up-arrow ('^') in text",$L(PSGDRGN)>39:"Response longer than 39 characters",1:"") I X]"" W $C(7),"  ??",!?2,"(",X," not allowed.)" G FTD
"RTN","PSJOE1",87,0)
 Q:PSGDRGN'?1."?"
"RTN","PSJOE1",88,0)
 W !!?2,"ENTER DRUG ORDERED (1-39 CHARACTERS).",!?2,"Since the drug cannot be found in the DRUG file, enter the drug name here",!,"exactly as ordered.  Press the RETURN key (or enter an '^') to skip over this",!,"drug, or to again search the"
"RTN","PSJOE1",89,0)
 W " DRUG file for this one." G FTD
"RTN","PSJOE1",90,0)
 ;
"RTN","PSJOE1",91,0)
TAM ; Try Again Message
"RTN","PSJOE1",92,0)
 W !!,"  Enter a 'Y' to try again to find the drug ordered from the Formulary.  (The",!,"order cannot become active until a Formulary drug has been entered.)  Enter 'N'",!,"to enter the drug ordered as free text for later reference."
"RTN","PSJOE1",93,0)
 W "  Enter '^' to exit.",! Q
"RTN","PSJOEA2")
0^44^B32521096
"RTN","PSJOEA2",1,0)
PSJOEA2 ;BIR/MLM-INPATIENT ORDER ENTRY ; 5/11/09 7:50am
"RTN","PSJOEA2",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**127,133,200,267,268,257,281**;16 DEC 97;Build 113
"RTN","PSJOEA2",3,0)
 ;
"RTN","PSJOEA2",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOEA2",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789.
"RTN","PSJOEA2",6,0)
 ; Reference to ^TMP("PSODAOC",$J supported by DBIA 6071
"RTN","PSJOEA2",7,0)
 ;
"RTN","PSJOEA2",8,0)
CHK ;Check to be sure all the orders in the complex order series are completed, continued.
"RTN","PSJOEA2",9,0)
 I 'PSJCOMV,'$G(COMQUIT) N PSJO S PSJO=0 F  S PSJO=$O(^TMP("PSJCOM",$J,PSJO)) Q:'PSJO  S PSGORD=+PSJO_"P",PSGND=$G(^PS(53.1,+PSJO,0)) D
"RTN","PSJOEA2",10,0)
 .S PSGP=$P(PSGND,"^",15)
"RTN","PSJOEA2",11,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="A",($P(PSGND,U,24)'="R") D ^PSGOT D  Q
"RTN","PSJOEA2",12,0)
 ..M ^PS(55,PSGP,5,+PSGORD,4)=^PS(53.1,PSJO,4)
"RTN","PSJOEA2",13,0)
 ..N PSGND2P5 S PSGND2P5=$G(^PS(53.1,+PSJO,2.5)),DUR=$P(PSGND2P5,"^",2) I $G(DUR)]"" N DA,DR,DIE S DIE="^PS(55,"_PSGP_",5,",DA(1)=PSGP,DA=+PSGORD,DR="126////"_$G(DUR) D ^DIE
"RTN","PSJOEA2",14,0)
 ..D KILL531^PSJIMO1(PSGP,"",+PSJO)
"RTN","PSJOEA2",15,0)
 ..D ACTLOG^PSJOEA(PSJO,PSGP,PSGORD)
"RTN","PSJOEA2",16,0)
 ..S VND4=$G(^PS(55,PSGP,5,+PSGORD,4))
"RTN","PSJOEA2",17,0)
 ..I PSJSYSL>1 S $P(^PS(55,PSGP,5,+PSGORD,7),U)=PSGDT S:$P(^(7),U,2)="" $P(^(7),U,2)="N"_$S($P(^PS(55,PSGP,5,+PSGORD,0),"^",24)="E":"E",1:"") S PSGTOL=2,PSGUOW=DUZ,PSGTOO=1,DA=+PSGORD D ENL^PSGVDS
"RTN","PSJOEA2",18,0)
 ..S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)="" S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT
"RTN","PSJOEA2",19,0)
 ..; Set PV and NV flag according to PSJSYSU  (PSJ*5*200)
"RTN","PSJOEA2",20,0)
 ..S $P(VND4,"^",+PSJSYSU=1+9)=1 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9) S ^PS(55,PSGP,5,+PSGORD,4)=VND4
"RTN","PSJOEA2",21,0)
 ..I '$P(VND4,U,10) S ^PS(55,"ANV",PSGP,+PSGORD)=""
"RTN","PSJOEA2",22,0)
 ..I $P(VND4,U,9) K ^PS(55,"APV",PSGP,+PSGORD)
"RTN","PSJOEA2",23,0)
 ..I $P(VND4,U,10) K ^PS(55,"ANV",PSGP,+PSGORD)
"RTN","PSJOEA2",24,0)
 ..S:+PSJSYSU=3 ^PS(55,"AUE",PSGP,+PSGORD)=""
"RTN","PSJOEA2",25,0)
 ..S PSJCOM=$P($G(^PS(55,PSGP,5,+PSGORD,.2)),"^",8) I PSJCOM]"" K ^PS(53.1,"ACX",PSJCOM,PSJO) ;S $P(^PS(55,PSGP,5,+PSGORD,4),"^",9)=1
"RTN","PSJOEA2",26,0)
 ..D EN1^PSJHL2(PSGP,$S(+PSJSYSU=3:"SC",+PSJSYSU=1:"SC",1:"XX"),+PSGORD_"U")     ; allow status change to be sent for pharmacists & nurses
"RTN","PSJOEA2",27,0)
 ..D:+PSJSYSU=1 EN1^PSJHL2(PSGP,"ZV",+PSGORD_"U") L -^PS(55,PSGP,5,+PSGORD)
"RTN","PSJOEA2",28,0)
 ..I $G(PSJCOM) S ^TMP("PSODAOC",$J,"IP IEN")=PSJO_"P",^TMP("PSODAOC",$J,"IP NEW IEN")=PSGORD D SETOC^PSJNEWOC(PSGORD)
"RTN","PSJOEA2",29,0)
 ..; ** This is where the Automated Dispensing hook is called. Do NOT DELETE or change location **
"RTN","PSJOEA2",30,0)
 ..D NEWJ^PSJADM
"RTN","PSJOEA2",31,0)
 ..; ** END to Interface Hook **
"RTN","PSJOEA2",32,0)
 ..S PSJPREX=1 D CMPLX2^PSJCOM1(PSGP,PSJORD,PSGORD) K PSJPREX
"RTN","PSJOEA2",33,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="A" D GT531^PSIVORFA(PSGP,PSJO_"P") D  Q
"RTN","PSJOEA2",34,0)
 ..S ON55="" I $P(PSGND,"^",24)="R" S ON55=$P(PSGND,"^",25) D
"RTN","PSJOEA2",35,0)
 ...N PND0,PSGORDR S PND0=^PS(53.1,+PSJO,0),PSGORDR=$P(PND0,U,25)
"RTN","PSJOEA2",36,0)
 ...Q:'$$LS^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJOEA2",37,0)
 ...D KILL531^PSJIMO1(PSGP,"",+PSJO)
"RTN","PSJOEA2",38,0)
 ...N OEORD,OOEORD,FILE55,FILE55N0,PNDP2 S PNDP2=^PS(53.1,+PSJO,.2),FILE55="^PS(55,"_DFN_",""IV"",",FILE55N0=FILE55_+PSGORDR_",0)"
"RTN","PSJOEA2",39,0)
 ...S OEORD=$P(PND0,U,21) I PSGORDR S OOEORD=$P(@FILE55N0,"^",21) I OEORD'=OOEORD D EXPOE^PSGOER(DFN,+PSJO_"P",+$$LASTREN^PSJLMPRI(DFN,+PSJO_"P"))
"RTN","PSJOEA2",40,0)
 ...S PSGORDP=PSJO,DIE="^PS(53.1,",DA=+PSJO,DR="28////A;104////@" W "." D ^DIE
"RTN","PSJOEA2",41,0)
 ...Q:'$G(OEORD)  K DA,DR,DIE S DA(1)=DFN,DA=+PSGORDR,DIE=FILE55,DR=110_"////"_+OEORD
"RTN","PSJOEA2",42,0)
 ...S:$P(PNDP2,U,8) DR=DR_";150////"_$P(PNDP2,U,8) D ^DIE S DIE=FILE55_+PSGORDR_",0)",$P(@DIE,U,21)=OEORD
"RTN","PSJOEA2",43,0)
 ...D EN1^PSJHL2(DFN,"SC",PSGORDR),UNL^PSSLOCK(PSGP,PSGORDR)
"RTN","PSJOEA2",44,0)
 ..I 'ON55 D SETNEW^PSIVORFB
"RTN","PSJOEA2",45,0)
 ..I $G(PSJCOM),ON55["V" S ^TMP("PSODAOC",$J,"IP IEN")=PSJO_"P",^TMP("PSODAOC",$J,"IP NEW IEN")=ON55 D SETOC^PSJNEWOC(ON55)
"RTN","PSJOEA2",46,0)
 ..S (P("NEWON"),ON)=ON55,PSGP=$P(PSGND,U,15)
"RTN","PSJOEA2",47,0)
 ..S VND4=$G(^TMP("PSJCOM",$J,+PSJO,4)) D
"RTN","PSJOEA2",48,0)
 ...N PSJRN,PSJRNDT,PSJRPH,PSJRPHD,PSJPVFL,PSJNVFL,DR,DIE,DA
"RTN","PSJOEA2",49,0)
 ...S (PSJPVFL,PSJNVFL)=""
"RTN","PSJOEA2",50,0)
 ...S PSJRN=$P(VND4,U,1),PSJRNDT=$P(VND4,U,2),PSJRPH=$P(VND4,U,3),PSJRPHD=$P(VND4,U,4),PSJPVFL=$P(VND4,U,16) S:PSJRN]"" PSJNVFL=1
"RTN","PSJOEA2",51,0)
 ...S DR="16////"_PSJRN_";17////"_PSJRNDT_";140////"_PSJRPH_";141////"_PSJRPHD_";142////"_PSJPVFL_";143////"_PSJNVFL
"RTN","PSJOEA2",52,0)
 ...S DA(1)=PSGP,DA=+ON55,DIE="^PS(55,"_PSGP_",""IV""," D ^DIE
"RTN","PSJOEA2",53,0)
 ..D:P("RES")="R" RUPDATE^PSIVOREN(PSGP,ON,P(2))
"RTN","PSJOEA2",54,0)
 ..I +PSJSYSU=3 K OD D ^PSIVORE1 ;LABEL STUFF
"RTN","PSJOEA2",55,0)
 ..I $G(P("PACT"))]"",+$P(P("PACT"),U,2),+$P(P("PACT"),U,3) D  Q
"RTN","PSJOEA2",56,0)
 ...NEW DIC,DA,X,Y,XX D NAME^PSJBCMA1($P(P("PACT"),U,2),.XX)
"RTN","PSJOEA2",57,0)
 ...S DIC(0)="L",DA(1)=DFN,DA(2)=+ON55,X=1
"RTN","PSJOEA2",58,0)
 ...S DIC="^PS(55,"_DA(1)_",""IV"","_DA(2)_",""A"","
"RTN","PSJOEA2",59,0)
 ...S DIC("DR")=".02////F;.03////"_XX_";.04////"_$P($G(^PS(53.3,+$P(P("PACT"),U,3),0)),U)_";.05////"_$P(P("PACT"),U)_";.06////"_$P(P("PACT"),U,2)
"RTN","PSJOEA2",60,0)
 ...K DO D FILE^DICN K DO
"RTN","PSJOEA2",61,0)
 ...N DIK,DA,PSIVACT S DIK="^PS(55,"_DFN_",""IV"",",DA=+ON,PSIVACT="" S:$G(DFN) DA(1)=DFN D IX^DIK K DIK,DA
"RTN","PSJOEA2",62,0)
 ...S PSJCOM=$P($G(^PS(55,DFN,"IV",+ON,.2)),"^",8) I PSJCOM]"" K ^PS(53.1,"ACX",PSJCOM,PSJO)
"RTN","PSJOEA2",63,0)
 ...D EN1^PSJHL2(DFN,"SC",ON)
"RTN","PSJOEA2",64,0)
 ...D:+PSJSYSU=1 EN1^PSJHL2(DFN,"ZV",ON) L -^PS(55,DFN,"IV",+ON) I $G(ON55) L -^PS(55,DFN,"IV",+ON55)
"RTN","PSJOEA2",65,0)
 ..L -^PS(55,DFN,"IV",+ON) I $G(ON55) L -^PS(55,DFN,"IV",+ON55)
"RTN","PSJOEA2",66,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",9)="A",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)="U" S PSGP=$P(PSGND,U,15) D UD^PSJOEA
"RTN","PSJOEA2",67,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",9)="A",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)="U" S PSGP=$P(PSGND,U,15) D UD^PSJOEA
"RTN","PSJOEA2",68,0)
 .I $P(PSGND,U,4)'="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)'="U",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",17)="A" S DFN=$S($G(PSGP)]"":PSGP,1:$P(PSGND,U,15)) D IV^PSJOEA
"RTN","PSJOEA2",69,0)
 .I $P(PSGND,U,4)="U",$P(PSGND,U,9)="DE",$D(^TMP("PSJCOM2",$J,PSJO,0)),$P(^TMP("PSJCOM2",$J,PSJO,0),"^",4)'="U",$P(^TMP("PSJCOM2",$J,PSJO,0),"^",17)="A" S DFN=$S($G(PSGP)]"":PSGP,1:$P(PSGND,U,15)) D IV^PSJOEA
"RTN","PSJOEA2",70,0)
 K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J),PSJOWALL
"RTN","PSJOEA2",71,0)
 Q
"RTN","PSJRXI")
0^8^B24100017
"RTN","PSJRXI",1,0)
PSJRXI ; IHS/DSD,JCM,RLW - LOGS PHARMACY INTERVENTIONS ;15 May 98  9:28 AM
"RTN","PSJRXI",2,0)
 ;;5.0;INPATIENT MEDICATIONS;**3,181,254,267,275,281**;16 DEC 97;Build 113
"RTN","PSJRXI",3,0)
 ;
"RTN","PSJRXI",4,0)
 ;Reference to ^APSPQA(32.4 is supported by DBIA #2179
"RTN","PSJRXI",5,0)
 ;Reference to ^PSDRUG( supported by DBIA #2192
"RTN","PSJRXI",6,0)
 ;Reference to ^DD("DILOCKTM" supported by DBIA #999
"RTN","PSJRXI",7,0)
 ;
"RTN","PSJRXI",8,0)
 ; This routine is used to create entries in the APSP INTERVENTION file.
"RTN","PSJRXI",9,0)
 ;---------------------------------------------------------------
"RTN","PSJRXI",10,0)
START ;   
"RTN","PSJRXI",11,0)
 N SAVEX,SAVEY S SAVEX=X,SAVEY=Y
"RTN","PSJRXI",12,0)
 D INIT
"RTN","PSJRXI",13,0)
 D DIC G:PSJRXI("QFLG") END
"RTN","PSJRXI",14,0)
 D EDIT
"RTN","PSJRXI",15,0)
 S:'$D(PSJNEW("PROVIDER")) PSJNEW("PROVIDER")=$P(^APSPQA(32.4,PSJRXI("DA"),0),"^",3)
"RTN","PSJRXI",16,0)
END D EOJ
"RTN","PSJRXI",17,0)
 Q
"RTN","PSJRXI",18,0)
 ;---------------------------------------------------------------
"RTN","PSJRXI",19,0)
INIT ;
"RTN","PSJRXI",20,0)
 W !!,"Now creating Pharmacy Intervention",!
"RTN","PSJRXI",21,0)
 I $G(PSJDD) W "For ",$P($G(^PSDRUG(PSJDD,0)),"^"),!
"RTN","PSJRXI",22,0)
 K PSJRXI
"RTN","PSJRXI",23,0)
 S PSJRXI("QFLG")=0
"RTN","PSJRXI",24,0)
 Q
"RTN","PSJRXI",25,0)
 ;
"RTN","PSJRXI",26,0)
DIC ;
"RTN","PSJRXI",27,0)
 N DIC,DR,DA,X,DD,DO,Y,PSJY,PSJRXIEN
"RTN","PSJRXI",28,0)
 I $G(PSJRXREQ)="" S PSJRXREQ="ALLERGY"
"RTN","PSJRXI",29,0)
 D FIND^DIC(9009032.3,"","@;.01","",PSJRXREQ,1,"B","","","PSJRXIEN")
"RTN","PSJRXI",30,0)
 S PSJRXIEN=$G(PSJRXIEN("DILIST",2,1))
"RTN","PSJRXI",31,0)
 I 'PSJRXIEN S PSJY=-1 G DICX
"RTN","PSJRXI",32,0)
 S DIC="^APSPQA(32.4,",DLAYGO=9009032.4,DIC(0)="L",X=DT
"RTN","PSJRXI",33,0)
 S DIC("DR")=".02////"_PSGP_";.04////"_DUZ_";.05////"_PSJDD_";.06///PHARMACY"
"RTN","PSJRXI",34,0)
 S DIC("DR")=DIC("DR")_";.07////"_$G(PSJRXIEN)_";.14////1"_";.16////"_$S($G(PSJSITE)]"":PSJSITE,1:"")
"RTN","PSJRXI",35,0)
 D FILE^DICN K DIC,DR,DA
"RTN","PSJRXI",36,0)
 S PSJY=Y
"RTN","PSJRXI",37,0)
 I Y>0 S PSJRXI("DA")=+Y
"RTN","PSJRXI",38,0)
 E  S PSJRXI("QFLG")=1 G DICX
"RTN","PSJRXI",39,0)
 D DIE
"RTN","PSJRXI",40,0)
DICX ;
"RTN","PSJRXI",41,0)
 I $G(PSJY)=-1 D
"RTN","PSJRXI",42,0)
 . W !!,"Unable to log an intervention for ",$G(PSJRXREQ)
"RTN","PSJRXI",43,0)
 . D PAUSE^PSJLMUT1
"RTN","PSJRXI",44,0)
 K X,Y
"RTN","PSJRXI",45,0)
 Q
"RTN","PSJRXI",46,0)
DIE ;
"RTN","PSJRXI",47,0)
 K DIE,DIC,DR,DA N PSJRECOM,PSJOVRS,PSJINTOI,PSJTMPDT
"RTN","PSJRXI",48,0)
 S DIE="^APSPQA(32.4,",DA=PSJRXI("DA"),DR=$S($G(PSJRXI("EDIT"))]"":".03:1600",$G(PSJAADPT):".03;",1:".03;.08")
"RTN","PSJRXI",49,0)
 L +^APSPQA(32.4,PSJRXI("DA")):$S($G(^DD("DILOCKTM")):+$G(^DD("DILOCKTM")),1:3) E  W !,"Sorry, someone else is editing this intervention!" Q
"RTN","PSJRXI",50,0)
 D ^DIE K DIE,DIC,DR,X,Y,DA
"RTN","PSJRXI",51,0)
 I $G(PSJAADPT) N PSJQREC S PSJQREC=0 F  Q:$G(PSJQREC)  D
"RTN","PSJRXI",52,0)
 .K DIC S PSJQREC="" S DIC="9009032.5",DIC(0)="EZ",X="UNABLE TO ASSESS" D ^DIC S:$G(Y)>0 PSJQREC=+Y I '($G(Y)>0) S DIC="9009032.5",DIC(0)="EZ",X="OTHER" D ^DIC S:$G(Y)>0 PSJQREC=+Y
"RTN","PSJRXI",53,0)
 .N DIR S DIR(0)="S^1:UNABLE TO ASSESS;2:OTHER",DIR("A")="RECOMMENDATION",DIR("?",1)="  Enter a recommendation for NO ALLERGY ASSESSMENT.",DIR("?")="    Enter 'OTHER' to add free text."
"RTN","PSJRXI",54,0)
 .D ^DIR S PSJQREC=$S(PSJQREC>0:+PSJQREC,1:0) I PSJQREC D
"RTN","PSJRXI",55,0)
 ..S DIE="^APSPQA(32.4,",DA=PSJRXI("DA"),DR=".08////"_PSJQREC D ^DIE
"RTN","PSJRXI",56,0)
 .I $G(Y)="^" S PSJQREC=-1
"RTN","PSJRXI",57,0)
 .K DIE,DIC,DR,X,Y,DA
"RTN","PSJRXI",58,0)
 I $G(PSJDD) S PSJINTOI=+$G(^PSDRUG(+PSJDD,2))
"RTN","PSJRXI",59,0)
 S PSJTMPDT=+$G(^TMP("PSJINTER",$J,+$G(PSJRXI("DA"))-1))
"RTN","PSJRXI",60,0)
 I $G(PSGDT) I $G(PSJRXREQ)="ALLERGY"!($G(PSJRXREQ)["CRITICAL DRUG") S ^TMP("PSJINTER",$J,PSJRXI("DA"))=$S($G(PSJTMPDT):PSJTMPDT,1:$G(PSGDT))_"^"_$S($G(PSJINTOI):PSJINTOI,1:"")_"^"_$$DATE2^PSJUTL2($$DATE^PSJUTL2())
"RTN","PSJRXI",61,0)
 S PSJRECOM=$P($G(^APSPQA(32.4,PSJRXI("DA"),0)),"^",8) D
"RTN","PSJRXI",62,0)
 .S PSJOVRS="",X=PSJRECOM,Y="",DIC="^APSPQA(32.5,",DIC(0)="BSX" D ^DIC I $P(Y,"^",2)]"" S PSJOVRS=$P(Y,"^",2)
"RTN","PSJRXI",63,0)
 .I PSJRECOM=9 D
"RTN","PSJRXI",64,0)
 ..S DIE="^APSPQA(32.4,",DA=PSJRXI("DA"),DR="1200;" D ^DIE K DIE,DIC,DR,X,Y,DA
"RTN","PSJRXI",65,0)
 L -^APSPQA(32.4,PSJRXI("DA"))
"RTN","PSJRXI",66,0)
 W $C(7),!!,"See 'Pharmacy Intervention Menu' if you want to delete this",!,"intervention or for more options.",! D PAUSE^PSJLMUT1
"RTN","PSJRXI",67,0)
 Q
"RTN","PSJRXI",68,0)
EDIT ;
"RTN","PSJRXI",69,0)
 K DIR W ! S DIR(0)="Y",DIR("A")="Would you like to edit this intervention",DIR("B")="N" D ^DIR K DIR I $D(DIRUT)!'Y G EDITX
"RTN","PSJRXI",70,0)
 S PSJRXI("EDIT")=1 D DIE
"RTN","PSJRXI",71,0)
 G EDIT
"RTN","PSJRXI",72,0)
EDITX K X,Y
"RTN","PSJRXI",73,0)
 Q
"RTN","PSJRXI",74,0)
 ;
"RTN","PSJRXI",75,0)
EOJ ;
"RTN","PSJRXI",76,0)
 I $G(PSJDAL) S PSJDAL("DA")=$G(PSJRXI("DA"))
"RTN","PSJRXI",77,0)
 K PSJRXI S X=SAVEX,Y=SAVEY
"RTN","PSJRXI",78,0)
 Q
"RTN","PSJRXI",79,0)
 ;
"RTN","PSJRXI",80,0)
EN1(PSJORDER) ; Entry Point if have internal rx #
"RTN","PSJRXI",81,0)
 I PSJX']"" W !,$C(7),"No prescription data" Q
"RTN","PSJRXI",82,0)
 S PSJORDER=$S((PSJORDER["N")!(PSJORDER["P"):"^PS(53.1,"_+PSJORDER,PSJORDER["V":"^PS(55,"_DFN_",""IV"","_+PSJORDER,1:"^PS(55,"_DFN_",5,"_+PSJORDER)_","
"RTN","PSJRXI",83,0)
 N PSJDFN,PSJNEW,PSJDRUG,PSJY
"RTN","PSJRXI",84,0)
 I $G(^PS(53.1,PSJX,0))']"" W !,$C(7),"No prescription data" G EN1X
"RTN","PSJRXI",85,0)
 S PSJRXI("IRXN")=PSJORDER
"RTN","PSJRXI",86,0)
 K PSJY S PSJY=@(PSJORDER_",0)")
"RTN","PSJRXI",87,0)
 S PSJDFN=$P(PSJY,"^",15),PSJNEW("PROVIDER")=$P(PSJY,"^",2)
"RTN","PSJRXI",88,0)
 S PSJDRUG=0,PSJDRUG=$O(^PS(53.1,PSJRXI("IRXN"),1,PSJDRUG)) Q:'PSJDRUG  S PSJDRUG("IEN")=$G(@(PSJORDER_","_PSJDRUG),"^")
"RTN","PSJRXI",89,0)
 D START
"RTN","PSJRXI",90,0)
EN1X Q
"RTN","PSJRXI",91,0)
 ;
"RTN","PSJRXI",92,0)
EN3(PSJIVDST,CDRG2) ; Entry Point for Clinical Reminders
"RTN","PSJRXI",93,0)
 ;PSJIVDST = intervention text
"RTN","PSJRXI",94,0)
 N PSJIVDSN S PSJIVDSN=0
"RTN","PSJRXI",95,0)
 ;D LOOK I 'PSJIVDSN Q 1
"RTN","PSJRXI",96,0)
 S PSJRXREQ=PSJIVDST
"RTN","PSJRXI",97,0)
 S PSJDD=CDRG2
"RTN","PSJRXI",98,0)
 D START K PSJIVDSN,CDRG2
"RTN","PSJRXI",99,0)
EN3X Q 0
"RTN","PSJRXI",100,0)
 ;
"RTN","PSJRXI",101,0)
LOOK ;Find Internal Number of 32.3 file
"RTN","PSJRXI",102,0)
 S PSJRXIEN=$$FIND1^DIC(9009032.3,"","X",PSJIVDST,"B")
"RTN","PSJRXI",103,0)
 Q
"VER")
8.0^22.0
**INSTALL NAME**
PSO*7.0*411
"BLD",9237,0)
PSO*7.0*411^OUTPATIENT PHARMACY^0^3160204^y
"BLD",9237,4,0)
^9.64PA^^
"BLD",9237,6)
1^
"BLD",9237,6.3)
95
"BLD",9237,"ABPKG")
n
"BLD",9237,"INID")
^n
"BLD",9237,"INIT")
ADDCR^PSOCROC
"BLD",9237,"KRN",0)
^9.67PA^779.2^20
"BLD",9237,"KRN",.4,0)
.4
"BLD",9237,"KRN",.401,0)
.401
"BLD",9237,"KRN",.402,0)
.402
"BLD",9237,"KRN",.403,0)
.403
"BLD",9237,"KRN",.5,0)
.5
"BLD",9237,"KRN",.84,0)
.84
"BLD",9237,"KRN",3.6,0)
3.6
"BLD",9237,"KRN",3.8,0)
3.8
"BLD",9237,"KRN",9.2,0)
9.2
"BLD",9237,"KRN",9.8,0)
9.8
"BLD",9237,"KRN",9.8,"NM",0)
^9.68A^29^26
"BLD",9237,"KRN",9.8,"NM",1,0)
PSODEM^^0^B16428757
"BLD",9237,"KRN",9.8,"NM",2,0)
PSODRG^^0^B93593274
"BLD",9237,"KRN",9.8,"NM",3,0)
PSOCROC^^0^B8829845
"BLD",9237,"KRN",9.8,"NM",4,0)
PSOUTL^^0^B147729082
"BLD",9237,"KRN",9.8,"NM",5,0)
PSODDPR5^^0^B163007377
"BLD",9237,"KRN",9.8,"NM",8,0)
PSODGAL1^^0^B113259514
"BLD",9237,"KRN",9.8,"NM",9,0)
PSODGAL3^^0^B172651497
"BLD",9237,"KRN",9.8,"NM",10,0)
PSODGAL2^^0^B104733405
"BLD",9237,"KRN",9.8,"NM",11,0)
PSODDPRE^^0^B139774341
"BLD",9237,"KRN",9.8,"NM",12,0)
PSONEW^^0^B33443923
"BLD",9237,"KRN",9.8,"NM",13,0)
PSONEWOA^^0^B40166209
"BLD",9237,"KRN",9.8,"NM",14,0)
PSONEWOC^^0^B28895423
"BLD",9237,"KRN",9.8,"NM",15,0)
PSOORUT2^^0^B97954565
"BLD",9237,"KRN",9.8,"NM",17,0)
PSODDPR2^^0^B133640558
"BLD",9237,"KRN",9.8,"NM",18,0)
PSODDPR7^^0^B148972341
"BLD",9237,"KRN",9.8,"NM",19,0)
PSORENW^^0^B47375085
"BLD",9237,"KRN",9.8,"NM",20,0)
PSORENW4^^0^B66539714
"BLD",9237,"KRN",9.8,"NM",21,0)
PSOOCKV1^^0^B14894586
"BLD",9237,"KRN",9.8,"NM",22,0)
PSOVER1^^0^B126108249
"BLD",9237,"KRN",9.8,"NM",23,0)
PSOORNEW^^0^B94643833
"BLD",9237,"KRN",9.8,"NM",24,0)
PSOORNE4^^0^B101859322
"BLD",9237,"KRN",9.8,"NM",25,0)
PSOCAN2^^0^B85734991
"BLD",9237,"KRN",9.8,"NM",26,0)
PSORENW0^^0^B84910963
"BLD",9237,"KRN",9.8,"NM",27,0)
PSOOREDT^^0^B82334396
"BLD",9237,"KRN",9.8,"NM",28,0)
PSOORCPY^^0^B34153930
"BLD",9237,"KRN",9.8,"NM",29,0)
PSOQRART^^0^B6101502
"BLD",9237,"KRN",9.8,"NM","B","PSOCAN2",25)

"BLD",9237,"KRN",9.8,"NM","B","PSOCROC",3)

"BLD",9237,"KRN",9.8,"NM","B","PSODDPR2",17)

"BLD",9237,"KRN",9.8,"NM","B","PSODDPR5",5)

"BLD",9237,"KRN",9.8,"NM","B","PSODDPR7",18)

"BLD",9237,"KRN",9.8,"NM","B","PSODDPRE",11)

"BLD",9237,"KRN",9.8,"NM","B","PSODEM",1)

"BLD",9237,"KRN",9.8,"NM","B","PSODGAL1",8)

"BLD",9237,"KRN",9.8,"NM","B","PSODGAL2",10)

"BLD",9237,"KRN",9.8,"NM","B","PSODGAL3",9)

"BLD",9237,"KRN",9.8,"NM","B","PSODRG",2)

"BLD",9237,"KRN",9.8,"NM","B","PSONEW",12)

"BLD",9237,"KRN",9.8,"NM","B","PSONEWOA",13)

"BLD",9237,"KRN",9.8,"NM","B","PSONEWOC",14)

"BLD",9237,"KRN",9.8,"NM","B","PSOOCKV1",21)

"BLD",9237,"KRN",9.8,"NM","B","PSOORCPY",28)

"BLD",9237,"KRN",9.8,"NM","B","PSOOREDT",27)

"BLD",9237,"KRN",9.8,"NM","B","PSOORNE4",24)

"BLD",9237,"KRN",9.8,"NM","B","PSOORNEW",23)

"BLD",9237,"KRN",9.8,"NM","B","PSOORUT2",15)

"BLD",9237,"KRN",9.8,"NM","B","PSOQRART",29)

"BLD",9237,"KRN",9.8,"NM","B","PSORENW",19)

"BLD",9237,"KRN",9.8,"NM","B","PSORENW0",26)

"BLD",9237,"KRN",9.8,"NM","B","PSORENW4",20)

"BLD",9237,"KRN",9.8,"NM","B","PSOUTL",4)

"BLD",9237,"KRN",9.8,"NM","B","PSOVER1",22)

"BLD",9237,"KRN",19,0)
19
"BLD",9237,"KRN",19.1,0)
19.1
"BLD",9237,"KRN",101,0)
101
"BLD",9237,"KRN",409.61,0)
409.61
"BLD",9237,"KRN",771,0)
771
"BLD",9237,"KRN",779.2,0)
779.2
"BLD",9237,"KRN",870,0)
870
"BLD",9237,"KRN",8989.51,0)
8989.51
"BLD",9237,"KRN",8989.52,0)
8989.52
"BLD",9237,"KRN",8994,0)
8994
"BLD",9237,"KRN","B",.4,.4)

"BLD",9237,"KRN","B",.401,.401)

"BLD",9237,"KRN","B",.402,.402)

"BLD",9237,"KRN","B",.403,.403)

"BLD",9237,"KRN","B",.5,.5)

"BLD",9237,"KRN","B",.84,.84)

"BLD",9237,"KRN","B",3.6,3.6)

"BLD",9237,"KRN","B",3.8,3.8)

"BLD",9237,"KRN","B",9.2,9.2)

"BLD",9237,"KRN","B",9.8,9.8)

"BLD",9237,"KRN","B",19,19)

"BLD",9237,"KRN","B",19.1,19.1)

"BLD",9237,"KRN","B",101,101)

"BLD",9237,"KRN","B",409.61,409.61)

"BLD",9237,"KRN","B",771,771)

"BLD",9237,"KRN","B",779.2,779.2)

"BLD",9237,"KRN","B",870,870)

"BLD",9237,"KRN","B",8989.51,8989.51)

"BLD",9237,"KRN","B",8989.52,8989.52)

"BLD",9237,"KRN","B",8994,8994)

"BLD",9237,"QUES",0)
^9.62^^
"BLD",9237,"REQB",0)
^9.611^10^6
"BLD",9237,"REQB",4,0)
PSO*7.0*436^2
"BLD",9237,"REQB",5,0)
PSO*7.0*438^2
"BLD",9237,"REQB",7,0)
PSO*7.0*429^2
"BLD",9237,"REQB",8,0)
PSS*1.0*175^2
"BLD",9237,"REQB",9,0)
PSO*7.0*294^2
"BLD",9237,"REQB",10,0)
PSO*7.0*427^2
"BLD",9237,"REQB","B","PSO*7.0*294",9)

"BLD",9237,"REQB","B","PSO*7.0*427",10)

"BLD",9237,"REQB","B","PSO*7.0*429",7)

"BLD",9237,"REQB","B","PSO*7.0*436",4)

"BLD",9237,"REQB","B","PSO*7.0*438",5)

"BLD",9237,"REQB","B","PSS*1.0*175",8)

"INIT")
ADDCR^PSOCROC
"MBREQ")
1
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
411^3160204^10000000070
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
26
"RTN","PSOCAN2")
0^25^B85734991
"RTN","PSOCAN2",1,0)
PSOCAN2 ;BHAM ISC/JMB - rx cancel with speed ability drug check ; 2/16/12 3:40pm
"RTN","PSOCAN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,18,62,46,88,164,235,148,259,281,287,251,375,379,396,390,372,416,411**;DEC 1997;Build 95
"RTN","PSOCAN2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCAN2",4,0)
REINS N DODR,ORN,PSOREINO S PSOREINO=1
"RTN","PSOCAN2",5,0)
 I $G(PSODFN)'=$G(PSOODOSP) K PSORX("DOSING OFF"),PSOREINF S PSOODOSP=PSODFN
"RTN","PSOCAN2",6,0)
 I $P(^PSRX(DA,2),"^",6)<DT D  Q
"RTN","PSOCAN2",7,0)
 .S Y=$P(^PSRX(DA,2),"^",6) X ^DD("DD")
"RTN","PSOCAN2",8,0)
 .W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" Drug: "_$S($D(^PSDRUG($P(^PSRX(DA,0),"^",6),0)):$P(^(0),"^"),1:""),!,"Expired "_Y_" and cannot be Reinstated!",!
"RTN","PSOCAN2",9,0)
 .D PAUSE^VALM1
"RTN","PSOCAN2",10,0)
 I $D(^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA)) S PSCAN($P(^PSRX(DA,0),"^"))=DA_"^R",DODR=1 D AUTOD G ACT
"RTN","PSOCAN2",11,0)
 I $P(PSOPAR,"^",2),'$D(^XUSEC("PSORPH",DUZ)) N PSOVODA S PSOVODA=DA D DRGDRG Q:$G(PSOQUIT)&($G(PSOREINS))  S DA=PSOVODA Q:PSORX("DFLG")  D VERIFY D  D AREC^PSOCAN1 Q
"RTN","PSOCAN2",12,0)
 .S RX1=$P(^PSRX(DA,0),"^") S:'$D(PSCAN(RX1)) PSCAN(RX1)=DA_"^R" K RX1
"RTN","PSOCAN2",13,0)
ACT W ! F I=1:1:80 W "="
"RTN","PSOCAN2",14,0)
 D ^PSOBUILD S DRG=+$P(^PSRX(DA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:""),HOLDRX=RX
"RTN","PSOCAN2",15,0)
 W !!,RX_"  "_DRG I $G(POERR) S HPOERR=POERR
"RTN","PSOCAN2",16,0)
 D DRGDRG Q:$G(PSOQUIT)&($G(PSOREINS))
"RTN","PSOCAN2",17,0)
 S:$G(HPOERR) POERR=HPOERR S:$G(PSORX("DFLG"))'=1 PSORX("DFLG")=0
"RTN","PSOCAN2",18,0)
 S RX=HOLDRX K HOLDRX,HPOERR Q:$P(^PSRX(+PSCAN(RX),"STA"),"^")'=12!($G(PSORX("DFLG")))
"RTN","PSOCAN2",19,0)
 S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2) D CAN^PSOCAN W !
"RTN","PSOCAN2",20,0)
 N RXIEN S RXIEN=DA
"RTN","PSOCAN2",21,0)
 ;Takes action on reinstated Rx's
"RTN","PSOCAN2",22,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN2",23,0)
 S (LPRT,LREF,XRELDT,XFDT)="" F LL=0:0 S LL=$O(^PSRX(DA,"L",LL)) Q:'LL  S LPRT=$P($G(^PSRX(DA,"L",LL,0)),"."),LREF=$P($G(^(0)),"^",2)
"RTN","PSOCAN2",24,0)
 I 'RFCNT S FDT=$S($P($G(^PSRX(DA,2)),"^",2)'="":$P($G(^PSRX(DA,2)),"^",2),1:$P($G(^PSRX(DA,2)),"^")) S RELDT=$P(^(2),"^",13),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",25,0)
 I RFCNT S FDT=$P($G(^PSRX(DA,1,RFCNT,0)),"^"),RELDT=$P(^(0),"^",18),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",26,0)
 S Y=FDT D DD^%DT S XFDT=Y I RELDT'="" S Y=RELDT D DD^%DT S XRELDT=Y
"RTN","PSOCAN2",27,0)
 I LPRT'="" S Y=LPRT D DD^%DT S XLPDT=Y
"RTN","PSOCAN2",28,0)
 ;If Rx was released, do nothing
"RTN","PSOCAN2",29,0)
 I RELDT'="" W !,RX_" Reinstated -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:""),?56,"Released: "_$G(XRELDT) H 3 Q
"RTN","PSOCAN2",30,0)
 ;If Rx not released, check fill/refill date for action
"RTN","PSOCAN2",31,0)
 I $G(PSXSYS) D REINS^PSOCMOPA I $G(XFLAG) K XFLAG Q
"RTN","PSOCAN2",32,0)
 W !,"Prescription #"_RX_" REINSTATED!"
"RTN","PSOCAN2",33,0)
 ;
"RTN","PSOCAN2",34,0)
 N PSOTRIC S PSOTRIC="",PSOTRIC=$$TRIC^PSOREJP1(RXIEN,RFCNT,PSOTRIC)
"RTN","PSOCAN2",35,0)
 D SUBMIT^PSOREJU3(RXIEN,RFCNT,PSOTRIC)
"RTN","PSOCAN2",36,0)
 ;
"RTN","PSOCAN2",37,0)
 W !?3,"Prescription #",RX_": "
"RTN","PSOCAN2",38,0)
 W !?6,$S('RFCNT:"  Filled",1:"  Refilled # "_LREF)_": "_XFDT,"  Printed: "_$S(LREF=RFCNT:XLPDT,1:""),"  Released: "_$G(XRELDT),!
"RTN","PSOCAN2",39,0)
 I FDT<DT D
"RTN","PSOCAN2",40,0)
 .Q:$$FIND^PSOREJUT(RXIEN)  ;No label for Rx's with unresolved claims rejects
"RTN","PSOCAN2",41,0)
 .Q:PSOTRIC&($$STATUS^PSOBPSUT(RXIEN,RFCNT)["IN PROGRESS")  ;No labels for TRICARE/CHAMPVA in progress Rx *396
"RTN","PSOCAN2",42,0)
 .I PSOTRIC,$P($G(^PSRX(RXIEN,"STA")),"^")=12 Q  ;No label for TRICARE/CHAMPVA if discontinued via Reject Notification screen *396
"RTN","PSOCAN2",43,0)
 .S DIR("A")="     ** Do you want to print the label now",DIR("B")="N",DIR(0)="Y",DIR("?")="Enter 'Y' to print the label now.  If 'N' is entered, the label may be reprinted through reprint at a later date."
"RTN","PSOCAN2",44,0)
 .D ^DIR K DIR Q:$G(DIRUT)!('Y)  S PPL=RXIEN D Q^PSORXL Q
"RTN","PSOCAN2",45,0)
 I FDT=DT D
"RTN","PSOCAN2",46,0)
 . Q:$$FIND^PSOREJUT(RXIEN)  ;No label for Rx's with unresolved claims rejects
"RTN","PSOCAN2",47,0)
 . Q:PSOTRIC&($$STATUS^PSOBPSUT(RXIEN,RFCNT)["IN PROGRESS")  ;No labels for TRICARE/CHAMPVA in progress Rx *396
"RTN","PSOCAN2",48,0)
 . I PSOTRIC,$P($G(^PSRX(RXIEN,"STA")),"^")=12 Q  ;No label for TRICARE/CHAMPVA if discontinued via Reject Notification screen *396
"RTN","PSOCAN2",49,0)
 . W !?5,"Either print the label using the reprint option "
"RTN","PSOCAN2",50,0)
 . W !?7,"or check later to see if the label has been printed." D WAIT^PSODRG Q
"RTN","PSOCAN2",51,0)
 I FDT>DT&('$G(DODR)) W !?5,"Placing Rx on suspense.  Please wait..." D SUS
"RTN","PSOCAN2",52,0)
 K DODR
"RTN","PSOCAN2",53,0)
 Q
"RTN","PSOCAN2",54,0)
SUS ;Adds rec to suspense
"RTN","PSOCAN2",55,0)
 S ACT=1,RXN=DA,RX0=^PSRX(DA,0),RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK S DA=RXN
"RTN","PSOCAN2",56,0)
 S RXP=$S($D(RXP):RXP,1:0),DIC="^PS(52.5,",DIC(0)="L",X=RXN,DIC("DR")=".02///"_FDT_";.03///"_$P(RX0,"^",2)_";.04///M;.05///"_RXP_";.06////"_$G(PSOSITE)_";2///0" K DD,DO D FILE^DICN
"RTN","PSOCAN2",57,0)
 I +$G(Y),$G(RFCNT)'="" S $P(^PS(52.5,+Y,0),"^",13)=$G(RFCNT)
"RTN","PSOCAN2",58,0)
 S DA=RXN,$P(^PSRX(DA,"STA"),"^")=5,LFD=$E($P(^PSRX(DA,3),"^"),4,5)_"-"_$E($P(^(3),"^"),6,7)_"-"_$E($P(^(3),"^"),2,3)
"RTN","PSOCAN2",59,0)
 S ACOM="RX Placed on Suspense until "_LFD D AREC^PSOCAN1 S ST="SC",PHST="ZS" D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST
"RTN","PSOCAN2",60,0)
 Q
"RTN","PSOCAN2",61,0)
DRGDRG ;Checks for drug/drug interaction, duplicate drug and class
"RTN","PSOCAN2",62,0)
 Q:$P(^PSRX(DA,2),"^",6)<DT
"RTN","PSOCAN2",63,0)
 S (PSORX("DFLG"),PSORXED("DFLG"))=0
"RTN","PSOCAN2",64,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSOCAN2",65,0)
 S STAT=$P(STA,"^",$P(^PSRX(DA,"STA"),"^")+1)
"RTN","PSOCAN2",66,0)
 S X=$P(^PSRX(DA,0),"^",6),DIC="^PSDRUG(",DIC(0)="MZO" D ^DIC K DIC Q:$D(DTOUT)!(Y<0)
"RTN","PSOCAN2",67,0)
 K HOLD S NAME=$P(Y(0),"^") I +$G(PSOSD(STAT,NAME))=+PSCAN(RX) S HOLD(STAT,NAME)=$G(PSOSD(STAT,NAME)) K PSOSD(STAT,NAME)
"RTN","PSOCAN2",68,0)
 S:$G(PSONEW("OLD VAL"))=+Y PSODRG("QFLG")=1
"RTN","PSOCAN2",69,0)
 K PSOY,PSOTECCK S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSOCAN2",70,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S PSOTECCK=1 N ZRXN
"RTN","PSOCAN2",71,0)
 S (ZRXN,PSORENW("OIRXN"))=DA D SET^PSODRG,POST^PSODRG Q:$G(PSOREINS)&$G(PSOQUIT)
"RTN","PSOCAN2",72,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("C")
"RTN","PSOCAN2",73,0)
 S REA=$P(PSCAN($P(^PSRX(PSORENW("OIRXN"),0),"^")),"^",2)
"RTN","PSOCAN2",74,0)
 W ! S:$G(HOLD(STAT,NAME))]"" PSOSD(STAT,NAME)=$G(HOLD(STAT,NAME)) K HOLD,STA,STAT,PSORENW("OIRXN")
"RTN","PSOCAN2",75,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOCAN2",76,0)
 ;I +$G(^TMP("PSODAOC",$J,1,0)) D
"RTN","PSOCAN2",77,0)
 I $D(^TMP("PSODAOC",$J)) D
"RTN","PSOCAN2",78,0)
 .N RXN,PSODAOC S RXN=ZRXN,PSODAOC="Rx Reinstate Order Acceptance_OP"
"RTN","PSOCAN2",79,0)
 .D DAOC^PSONEW
"RTN","PSOCAN2",80,0)
 .K ^TMP("PSODAOC",$J),RET
"RTN","PSOCAN2",81,0)
 Q
"RTN","PSOCAN2",82,0)
VERIFY ;Put in non-verify file
"RTN","PSOCAN2",83,0)
 S PSRXDA=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXDA,DIC(0)="ML",DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN2",84,0)
 K DD,DO D FILE^DICN K DIC,DLAYGO,DINUM
"RTN","PSOCAN2",85,0)
 S DA=PSRXDA S $P(^PSRX(DA,"STA"),"^")=1
"RTN","PSOCAN2",86,0)
 S ST="SC",PHST="IP",VCOM="Put in non-verified status" D EN^PSOHLSN1(DA,ST,PHST,VCOM) K ST,PHST,VCOM
"RTN","PSOCAN2",87,0)
 Q
"RTN","PSOCAN2",88,0)
HLD N PSDTEST,PDA,CMOP,SUSD I $P(^PSRX(DA,"STA"),"^")=3 D
"RTN","PSOCAN2",89,0)
 .S ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while on hold during Rx cancel. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")=""
"RTN","PSOCAN2",90,0)
 .I $P(^PSRX(DA,0),"^",13),'$O(^PSRX(DA,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(DA,0),"^",13),1,7) D ^DIE K DIE,DR Q
"RTN","PSOCAN2",91,0)
 .S (IFN,SUSD)=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S SUSD=IFN,RFDT=$P(^PSRX(DA,1,IFN,0),"^")
"RTN","PSOCAN2",92,0)
 .Q:'$G(SUSD)  I '$P(^PSRX(DA,1,SUSD,0),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(DA,1,SUSD),^PSRX("AD",RFDT,DA,SUSD),^PSRX(DA,1,"B",RFDT,SUSD),IFN,SUSD,RFDT
"RTN","PSOCAN2",93,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(DA,"L",PDA)) Q:'PDA  I $P($G(^PSRX(DA,"L",PDA,0)),"^",2)=SUSD S PSDTEST=1
"RTN","PSOCAN2",94,0)
 ..K CMOP D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOCAN2",95,0)
 ..S PSDTEST=1
"RTN","PSOCAN2",96,0)
 Q
"RTN","PSOCAN2",97,0)
REF S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I $P($G(^PSRX(DA,1,IFN,0)),"^")=SUSD,'$P(^(0),"^",18) D
"RTN","PSOCAN2",98,0)
 .D DELREF I $G(PSORFDEL) K PSORFDEL Q
"RTN","PSOCAN2",99,0)
 .;PSO*7*259;CHECK IF REFILL RELEASED OR LABEL PRINTED
"RTN","PSOCAN2",100,0)
 .I $P($G(^PSRX(DA,1,IFN,0)),"^",18)]"" Q  ;REFILL RELEASED
"RTN","PSOCAN2",101,0)
 .N PSONODEL,PSOLBL S PSONODEL=0
"RTN","PSOCAN2",102,0)
 .I $P(^PSRX(DA,"STA"),"^")=5 D REF^PSOCAN4 Q:PSONODEL
"RTN","PSOCAN2",103,0)
 .S PSOLBL="" F  S PSOLBL=$O(^PSRX(DA,"L",PSOLBL),-1) Q:'PSOLBL  Q:PSONODEL  Q:$P(^PSRX(DA,"L",PSOLBL,0),"^",2)<IFN  I $P(^PSRX(DA,"L",PSOLBL,0),"^",2)=IFN S PSONODEL=1
"RTN","PSOCAN2",104,0)
 .Q:PSONODEL
"RTN","PSOCAN2",105,0)
 .K PSORFDEL K ^PSRX(DA,1,IFN),^PSRX("AD",SUSD,DA,IFN),^PSRX(DA,1,"B",SUSD,IFN)
"RTN","PSOCAN2",106,0)
 .S $P(^PSRX(DA,1,0),"^",4)=$P(^PSRX(DA,1,0),"^",4)-1,DA(1)=DA
"RTN","PSOCAN2",107,0)
 .S NODE=0 D SPR^PSOUTL K DA(1),RF,NODE
"RTN","PSOCAN2",108,0)
 S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I '$O(^PSRX(DA,1,IFN)) S $P(^PSRX(DA,3),"^")=+$P(^PSRX(DA,1,IFN,0),"^"),$P(^(3),"^",2)=SUSD
"RTN","PSOCAN2",109,0)
 I '$O(^PSRX(DA,1,0)) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,2),"^",2),$P(^PSRX(DA,3),"^",2)=SUSD
"RTN","PSOCAN2",110,0)
 K IFN,SUSD
"RTN","PSOCAN2",111,0)
 Q
"RTN","PSOCAN2",112,0)
KILL K %,ACNT,ACOM,ACT,ALL,BCNUM,CMOP,CNT,DA,DAYS360,DEAD,DRG,DIRUT,DR,DRUG,DTOUT,DUOUT,FDT,HOLD,I,II,IN,IT,JJ,LC,LFD,LINE,LL,LPRT,LREF,LSI,NAME,NDF,NOEXP,NSF,OUT,RXSP,EN,WARN K:'$G(POERR) INCOM
"RTN","PSOCAN2",113,0)
 K PSODRUG,PCNT,POP,PPL,PS,PSFROM,PSINV,PLINE,PSI,PSINV,PSOCAN,PSOCMOP,PSODFN,PSODRG,PSOOPT,PSOSD,PSPOP,PSRXDA,PSS,PSVC,PSONOOR
"RTN","PSOCAN2",114,0)
 K REA,RELDT,RF,RFDATE,RFCNT,RFL,RFL1,RFLL,RP,RX,RX0,RXCNT,RXDA,RXN,RXNUM,RXP,RXREC,RXREF,RXS,SDATE,SPCANC,SS,STAT,SUB,X,XFDT,XLPDT,XRELDT,Y D KVA^VADPT Q
"RTN","PSOCAN2",115,0)
DELREF ;
"RTN","PSOCAN2",116,0)
 N RDL,PSCNODE
"RTN","PSOCAN2",117,0)
 S PSORFDEL=0
"RTN","PSOCAN2",118,0)
 F RDL=0:0 S RDL=$O(^PSRX(DA,4,RDL)) Q:'RDL  I $G(IFN)=$P($G(^PSRX(DA,4,RDL,0)),"^",3) S PSCNODE=$G(^(0))
"RTN","PSOCAN2",119,0)
 I $G(PSCNODE)="" Q
"RTN","PSOCAN2",120,0)
 I +$P(PSCNODE,"^",4)<3 S PSORFDEL=1
"RTN","PSOCAN2",121,0)
 Q
"RTN","PSOCAN2",122,0)
AUTOD ;reinstates Rxs dc'd by date of death
"RTN","PSOCAN2",123,0)
 I $G(^PSRX(DA,"DDSTA"))']"" K ^PSRX("APSOD",+$P(^PSRX(DA,0),"^",2),DA),DODR Q
"RTN","PSOCAN2",124,0)
 S DODS=$P(^PSRX(DA,"DDSTA"),"^"),DODD=$P(^("DDSTA"),"^",2,245)
"RTN","PSOCAN2",125,0)
 S FILE=$P(DODS,";"),STA=$P(DODS,";",2)
"RTN","PSOCAN2",126,0)
 I FILE=52.4 D  Q
"RTN","PSOCAN2",127,0)
 .S RXN=DA,^PS(52.4,DA,0)=DODD,DIK="^PS(52.4," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",128,0)
 .S ST="SC",PHST="IP",ACOM="Date of Death Deleted. Returned to Non-Verified status."
"RTN","PSOCAN2",129,0)
 .K ^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",130,0)
 .S DA=RXN D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,RXN
"RTN","PSOCAN2",131,0)
 I FILE=52.5 D  Q
"RTN","PSOCAN2",132,0)
 .;Adds rec to suspense
"RTN","PSOCAN2",133,0)
 .S RXN=DA,RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK
"RTN","PSOCAN2",134,0)
 .S DIC="^PS(52.5,",DIC(0)="L",X=RXN K DD,DO D FILE^DICN S DA=+Y
"RTN","PSOCAN2",135,0)
 .S ^PS(52.5,DA,0)=DODD,^PS(52.5,DA,"P")=0,LFD=$E($P(^PS(52.5,DA,0),"^",2),4,5)_"-"_$E($P(^(0),"^",2),6,7)_"-"_$E($P(^(0),"^",2),2,3)
"RTN","PSOCAN2",136,0)
 .S DIK="^PS(52.5," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",137,0)
 .S ACOM="Date of Death Deleted. RX Placed on Suspense until "_LFD
"RTN","PSOCAN2",138,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",139,0)
 .I STA=5 S ST="SC",PHST="ZS" D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,LFD
"RTN","PSOCAN2",140,0)
 I FILE=52 S ^PSRX(DA,"STA")=STA I STA=3!(STA=16) D  Q
"RTN","PSOCAN2",141,0)
 .S ^PSRX(DA,"H")=DODD,^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)=""
"RTN","PSOCAN2",142,0)
 .S ACOM="Date of Death Deleted. Medication Returned to"_$S(STA=16:" Provider",1:"")_" Hold Status "_$E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3)_"."
"RTN","PSOCAN2",143,0)
 .D LOG,EN^PSOHLSN1(DA,"OH","",ACOM) K ACOM
"RTN","PSOCAN2",144,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",145,0)
 S ACOM="Date of Death Deleted. Prescription Reinstated." D EN^PSOHLSN1(DA,"SC","CM",ACOM),LOG K ACOM
"RTN","PSOCAN2",146,0)
 K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",147,0)
 Q
"RTN","PSOCAN2",148,0)
LOG K ACNT F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",149,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=$G(RFCNT)+1 S:RF>5 RFCNT=$G(RFCNT)+1
"RTN","PSOCAN2",150,0)
 S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",151,0)
 D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(DA,"A",ACNT,0)=%_"^R^"_DUZ_"^"_RFCNT_"^"_ACOM
"RTN","PSOCAN2",152,0)
 K ^PSRX("APSOD",PSODFN,DA),ACNT,RFCNT,RF,%
"RTN","PSOCAN2",153,0)
 I $P(^PSRX(DA,3),"^",10) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,3),"^",10) ;*396
"RTN","PSOCAN2",154,0)
 S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8)
"RTN","PSOCAN2",155,0)
 S $P(^PSRX(DA,3),"^",5)="",$P(^(3),"^",8)=""
"RTN","PSOCAN2",156,0)
 Q
"RTN","PSOCAN2",157,0)
NVER ;Called from PSOCAN3, needs DA defined
"RTN","PSOCAN2",158,0)
 N PSONVC,PSONVCP,PSONVCC
"RTN","PSOCAN2",159,0)
 S PSONVC="SC",PSONVCP="IP",PSONVCC="Put in non-verified status" D EN^PSOHLSN1(DA,PSONVC,PSONVCP,PSONVCC)
"RTN","PSOCAN2",160,0)
 Q
"RTN","PSOCAN2",161,0)
RMB(IDX) ;remove Rx if found in array BBRX() (Bingo Board)
"RTN","PSOCAN2",162,0)
 N ST4,ST5,ST6,K
"RTN","PSOCAN2",163,0)
 S ST4=BBRX(IDX) Q:ST4'[(DA_",")
"RTN","PSOCAN2",164,0)
 S ST6=""
"RTN","PSOCAN2",165,0)
 F K=1:1 S ST5=$P(ST4,",",K) Q:'ST5  D
"RTN","PSOCAN2",166,0)
 . S:ST5'=DA ST6=ST6_$S('ST6:"",1:",")_ST5
"RTN","PSOCAN2",167,0)
 . S:ST6]"" BBRX(IDX)=ST6_"," K:ST6="" BBRX(IDX)
"RTN","PSOCAN2",168,0)
 I '$D(BBRX) K BINGCRT
"RTN","PSOCAN2",169,0)
 Q
"RTN","PSOCAN2",170,0)
 ;
"RTN","PSOCROC")
0^3^B8829845
"RTN","PSOCROC",1,0)
PSOCROC ;HP/MJE - CLINICAL REMINDER ORDER CHECK FOR OP ORDER CHECKS ;09/22/11 5:00pm
"RTN","PSOCROC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**411**;DEC 1997;Build 95
"RTN","PSOCROC",3,0)
 ;
"RTN","PSOCROC",4,0)
 ;Reference to ORDERCHK^PXRMORCH supported by DBIA 5531
"RTN","PSOCROC",5,0)
 ;Reference to SIG^XUSESIG supported by DBIA 10050
"RTN","PSOCROC",6,0)
 ;
"RTN","PSOCROC",7,0)
CK ;CHECK FOR CROCS AGAINST PROSPECTIVE DRUG
"RTN","PSOCROC",8,0)
 S $P(CROCLN,"=",60)="=",$P(CROCLN2,"-",60)="-"
"RTN","PSOCROC",9,0)
 I CROCPFLG&(($Y+4)>IOSL) D WAIT^PSODRG W ! K CROCPFLG
"RTN","PSOCROC",10,0)
 D ORDERCHK^PXRMORCH(DFN,-1,0,$G(PSODRUG("IEN")),0)
"RTN","PSOCROC",11,0)
 I '$D(^TMP($J,$G(PSODRUG("IEN")))) W !,"Now processing Clinical Reminder Order Checks. Please wait ..."
"RTN","PSOCROC",12,0)
 N PSOFIRST
"RTN","PSOCROC",13,0)
 I $D(^TMP($J,$G(PSODRUG("IEN")))) D
"RTN","PSOCROC",14,0)
 . W !,"Now processing Clinical Reminder Order Checks. Please wait ..."
"RTN","PSOCROC",15,0)
 S (CROCSTA,CROCDNM,CROCNUM,CROCSTR,CROCHFLG)=""
"RTN","PSOCROC",16,0)
 I $D(^TMP($J,$G(PSODRUG("IEN")))) D
"RTN","PSOCROC",17,0)
 .S CROCHFLG=2
"RTN","PSOCROC",18,0)
 .F  S CROCSTA=$O(^TMP($J,PSODRUG("IEN"),CROCSTA)) Q:CROCSTA=""!$G(PSORX("DFLG"))  D
"RTN","PSOCROC",19,0)
 ..I CROCSTA=1 S CROCHFLG=1
"RTN","PSOCROC",20,0)
 ..F  S CROCDNM=$O(^TMP($J,PSODRUG("IEN"),CROCSTA,CROCDNM)) Q:CROCDNM=""!$G(PSORX("DFLG"))  D
"RTN","PSOCROC",21,0)
 ...I '$G(PSOFIRST) W !!,CROCLN S PSOFIRST=1
"RTN","PSOCROC",22,0)
 ...S CROCSTA2=$S(CROCSTA=1:"HIGH",CROCSTA=2:"MEDIUM",CROCSTA=3:"LOW",1:"UNKNOWN")
"RTN","PSOCROC",23,0)
 ...W !,"*** Clinical Reminder Order Check | Severity: "_CROCSTA2_" ***",!
"RTN","PSOCROC",24,0)
 ...W !,CROCDNM,!
"RTN","PSOCROC",25,0)
 ...F  S CROCNUM=$O(^TMP($J,PSODRUG("IEN"),CROCSTA,CROCDNM,CROCNUM)) Q:CROCNUM=""!$G(PSORX("DFLG"))  D
"RTN","PSOCROC",26,0)
 ....I ($Y+7)>IOSL,$E(IOST)="C" D
"RTN","PSOCROC",27,0)
 .....W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSOCROC",28,0)
 ....W !,^TMP($J,PSODRUG("IEN"),CROCSTA,CROCDNM,CROCNUM)
"RTN","PSOCROC",29,0)
 ...W !!,CROCLN2 I ($Y+5)>IOSL W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSOCROC",30,0)
 I $G(PSODGCK) G KILL
"RTN","PSOCROC",31,0)
 I CROCHFLG=1 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="Y" D ^DIR
"RTN","PSOCROC",32,0)
 I CROCHFLG=1,Y["^"!(Y=0)!($D(DIRUT)) S (PSORX("DFLG"))=1 G KILL
"RTN","PSOCROC",33,0)
 I CROCHFLG=1 D SIG^XUSESIG I X1="" W !!,"Signature Code not valid" S (PSORX("DFLG"))=1 H 2 G KILL
"RTN","PSOCROC",34,0)
 I CROCHFLG=1 I X1'="" D EN3^PSORXI("CLINICAL REMINDER")
"RTN","PSOCROC",35,0)
 I CROCHFLG=2 W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")="N" D ^DIR
"RTN","PSOCROC",36,0)
 I CROCHFLG=2,Y=1 D EN3^PSORXI("CLINICAL REMINDER")
"RTN","PSOCROC",37,0)
KILL K CROCSTA,CROCSTA2,CROCDNM,CROCNUM,CROCSTR,CROCHFLG,CROCLN,CROCLN2,X1,Y,DIRUT
"RTN","PSOCROC",38,0)
 Q
"RTN","PSOCROC",39,0)
 ;
"RTN","PSOCROC",40,0)
ADDCR ;Add CLINICAL REMINDER (one time use as post install)
"RTN","PSOCROC",41,0)
 I '$$FIND1^DIC(9009032.3,"","X","CLINICAL REMINDER","B") D
"RTN","PSOCROC",42,0)
 .N PSSMRMPD K PSSMRMER S PSSMRMPD(1,9009032.3,"+1,",.01)="CLINICAL REMINDER" D UPDATE^DIE("","PSSMRMPD(1)",,"PSSMRMER(1)")
"RTN","PSOCROC",43,0)
 K PSSMRMPD,PSSMRMER
"RTN","PSOCROC",44,0)
 Q
"RTN","PSODDPR2")
0^17^B133640558
"RTN","PSODDPR2",1,0)
PSODDPR2 ;BIR/SAB - display enhanced order checks ;11 May 2010  9:06 AM
"RTN","PSODDPR2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,390,372,416,411**;DEC 1997;Build 95
"RTN","PSODDPR2",3,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR2",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR2",5,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPR2",6,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789 
"RTN","PSODDPR2",7,0)
 K ^UTILITY($J),PSODRUG("BAD"),THER,THERO,^TMP($J,"PSODCOR"),PSOINTV,PSOVAG,PSODD,PSI,PSORDIT,DRGNM,PDODCNT
"RTN","PSODDPR2",8,0)
 I $O(^TMP($J,LIST,"OUT","EXCEPTIONS",""))]"" D EXC^PSODDPR5 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",9,0)
 N COUNT,DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV,PSOLINES,OLDDRG,PSOOLDD,PSOTSUB,PSODSEQ,ZST,ZHDR,ZSUB,ZZDGDGC,PSOCLNS
"RTN","PSODDPR2",10,0)
 N PSOSEVER,PSODDSEQ,ZMED,COUNT2
"RTN","PSODDPR2",11,0)
 S (ON,DRG,SV,LSI,DGI,SER,SERS,PSOOLDD,PSOSEVER)="",(ZZDGDGC,CT,COUNT)=0,$P(PSONULN,"-",79)="-",$P(PSONULN1,"=",79)="=",ZHDR=1
"RTN","PSODDPR2",12,0)
 D NSRT^PSODDPR5 K ^TMP("PSODGI",$J),^TMP("PSOSER",$J),^TMP("PSOSERS",$J),^TMP("PSODGS",$J),^TMP("PSOTDD",$J,1)
"RTN","PSODDPR2",13,0)
 S (ON,DRG,SV,DGI,SER,SERS,ZVA)="",(ZST,ZORS,CT,COUNT)=0 N ZZOC S ZZOC=0,PSODDSEQ=0 ; PSO*7*411 
"RTN","PSODDPR2",14,0)
 F  S SV=$O(ZZDGDG(SV)) Q:SV=""!$G(PSODLQT)  F  S ZST=$O(ZZDGDG(SV,ZST)) Q:'ZST!$G(PSODLQT)  F  S ZORS=$O(ZZDGDG(SV,ZST,ZORS)) Q:'ZORS!$G(PSODLQT)  D
"RTN","PSODDPR2",15,0)
 .F  S ZVA=$O(ZZDGDG(SV,ZST,ZORS,ZVA)) Q:ZVA=""!$G(PSODLQT)  F  S DRG=$O(ZZDGDG(SV,ZST,ZORS,ZVA,DRG)) Q:DRG=""!$G(PSODLQT)  S COUNT=COUNT+1 D DUP^PSODDPR8,BLD2^PSODGDGP
"RTN","PSODDPR2",16,0)
 K HZVA,ZVA,ZORS,ZZDGDG,PSOCLNS,COUNT,ON,DRG,SV,DGI,PSORX("INTERVENE"),DIR,CDDT ;D HD() G EXIT:$G(PSODLQT) ;PSO*7*411
"RTN","PSODDPR2",17,0)
 Q:$D(PSSDIUTL)
"RTN","PSODDPR2",18,0)
 I +$G(PSOINTV) D INT G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",19,0)
 I $G(PSORX("DFLG")) W:$G(COPY) !,$C(7),"RX DELETED",! S PSORX("DFLG")=1,POERR("DFLG")=1,VALMBCK="R" G EXIT  Q
"RTN","PSODDPR2",20,0)
 I '$D(^XUSEC("PSORPH",DUZ)) K PSORX("INTERVENE")
"RTN","PSODDPR2",21,0)
 ;
"RTN","PSODDPR2",22,0)
 I $G(PSORX("INTERVENE"))]"" D
"RTN","PSODDPR2",23,0)
 .K PSODAL("DA") D FULL^VALM1,^PSORXI S:'$G(POERR) VALMBCK="R" W !
"RTN","PSODDPR2",24,0)
 ;
"RTN","PSODDPR2",25,0)
 I $G(PSORX("DFLG")) G EXIT
"RTN","PSODDPR2",26,0)
 I $O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",""))]"" D  G EXIT:PSODLQT  I ($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",27,0)
 .S NODDERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",28,0)
 .I ($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q
"RTN","PSODDPR2",29,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Interaction Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",30,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON)) Q:ON=""  F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT)) Q:'CT  D
"RTN","PSODDPR2",31,0)
 ..Q:$G(NODDERR)&($P(ON,";")'="Z")
"RTN","PSODDPR2",32,0)
 ..W ?5,$S($P(ON,";")="N":"",$P(ON,";")="R":"Remote Rx for ",$P(ON,";")="O":"Local Rx for ",1:"Prospective Rx for ")
"RTN","PSODDPR2",33,0)
 ..W " "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","DRUGDRUG","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",34,0)
 ..D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",35,0)
 ;therapy
"RTN","PSODDPR2",36,0)
THER I '$O(^TMP($J,LIST,"OUT","THERAPY",0)) G EXIT
"RTN","PSODDPR2",37,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$P(PSOPAR,"^",2),$G(PSOTECCK) G EXIT
"RTN","PSODDPR2",38,0)
 D NSRT1^PSODDPR5 K ZPSODCTH ;PSO*7*411
"RTN","PSODDPR2",39,0)
 N ON,DDTH,CLASS,QTHER,ZDRG,ZTHER K DUPT,THER,THERO,SUB,ZOT,ZCLASS,CDDT,ZPSODCTH I '$P(PSOPAR,"^",10) D NOCAN^PSODDPR7 G ERR ;PSO*7*411
"RTN","PSODDPR2",40,0)
 ;W @IOF,"Z"_PSONULN1,! S (SUB,CT,LST,PSOZZ)=0 S (CDDT,THER)=1,THERO=0,QTHER=1 K RXDT ;PSO*7*411
"RTN","PSODDPR2",41,0)
 W @IOF S (SUB,CT,LST,PSOZZ)=0 S (CDDT,THER)=1,THERO=0,QTHER=1 K RXDT ;PSO*7*411
"RTN","PSODDPR2",42,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT!$G(PSODLQT)  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB!$G(PSODLQT)  S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^") D
"RTN","PSODDPR2",43,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR2",44,0)
 .S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",45,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR2",46,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR2",47,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR2",48,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",49,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR2",50,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR2",51,0)
 .S ZOT=$S($P(ON,";")["C":1,$P(ON,";")="O":2,$P(ON,";")="R":3,$P(ON,";")="P":4,1:5)
"RTN","PSODDPR2",52,0)
 .I $P(ON,";")="P" D  ;PSO*7*411
"RTN","PSODDPR2",53,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q
"RTN","PSODDPR2",54,0)
 ..I '$P(^PS(52.41,$P(ON,";",2),0),"^",9) S ZDRG=$P(^PS(50.7,$P(^PS(52.41,$P(ON,";",2),0),"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR2",55,0)
 ..E  S ZDRG=$P(^PSDRUG($P(^PS(52.41,$P(ON,";",2),0),"^",9),0),"^")
"RTN","PSODDPR2",56,0)
 ..S ZPSODCTH(ON)=$P(ON,";",2)_";PS(52.41"
"RTN","PSODDPR2",57,0)
 .I $P(ON,";")="O" D
"RTN","PSODDPR2",58,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",59,0)
 ..S ZDRG=$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR2",60,0)
 .I $P(ON,";")="N" D
"RTN","PSODDPR2",61,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",62,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0)
"RTN","PSODDPR2",63,0)
 ..S ZPSODCTH(ON)="N;"_$P(ON,";",2)
"RTN","PSODDPR2",64,0)
 ..I '$P(DUPRX0,"^",2) S ZDRG=$P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^") Q
"RTN","PSODDPR2",65,0)
 ..S ZDRG=$P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR2",66,0)
 .I $P(ON,";")="R" D
"RTN","PSODDPR2",67,0)
 ..Q:'$D(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)))
"RTN","PSODDPR2",68,0)
 ..I $G(ZPSODCTH($P(ON,";",2))) Q  ;PSO*7*411
"RTN","PSODDPR2",69,0)
 ..S RXREC=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2)),ZDRG=$P(RXREC,"^",3)
"RTN","PSODDPR2",70,0)
 ..S ZPSODCTH(ON)="R;"_$P(RXREC,"^",5)_";"_$P(RXREC,"^")_"^"_$P(RXREC,"^",3)_"^"_$P(RXREC,"^",2)
"RTN","PSODDPR2",71,0)
 .I $E($P(ON,";"))["C" D  ;PSO*7*411; PIECE 1 of ON can be C1 for IV file 55, C2 for UD file 55, C3 for IV file 53.1 or C4 for UD file 53.1
"RTN","PSODDPR2",72,0)
 ..S ZPSODCTH(ON)=1,RXREC=^TMP($J,LIST,"IN","PROFILE",ON),ZMED=$P(RXREC,U,3),ZDRG=$P(RXREC,U,4) Q:$D(ZTHER(ZOT_"^"_ZDRG_"^"_ON))  ; clinic order
"RTN","PSODDPR2",73,0)
 ..S ZPSODCTH(ON)=$S($P(ON,";")[1!$P(ON,";")[4:"V",1:"U")_";"_$P(ON,";",2)
"RTN","PSODDPR2",74,0)
 .S:$D(ZDRG) ZTHER(ZOT_"^"_ZDRG_"^"_ON,SUB)=ON K ZDRG
"RTN","PSODDPR2",75,0)
THER2 ;
"RTN","PSODDPR2",76,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",77,0)
 I $O(ZTHER(""))]"" D
"RTN","PSODDPR2",78,0)
 .S (PSODUPF,PSODUPC,PSODUPC1,PSOTSUB)="" F  S PSODUPF=$O(ZTHER(PSODUPF)) Q:PSODUPF=""  F  S PSOTSUB=$O(ZTHER(PSODUPF,PSOTSUB)) Q:PSOTSUB=""  S PSODUPC1=PSODUPC1+1
"RTN","PSODDPR2",79,0)
 .;get line counts for each duplicate therapy by setting PSODUPF=1 and calling DUPCL to execute therapy code without actually displaying info. ; no breaks in the middle of displaying individual dup therapies.
"RTN","PSODDPR2",80,0)
 .S PSODUPF=1,PSODUPC=0,PSODUPC("CLASS")="" D DUPCL S PSODUPF=0
"RTN","PSODDPR2",81,0)
 .;set PSODUPF=0 then call DUPCL to actually print the duplicate therapies.
"RTN","PSODDPR2",82,0)
 .D DUPCL K DDTH,PSODUPC,PSODUPF,PSODUPC1,PSODUPC2
"RTN","PSODDPR2",83,0)
 G EXIT:$G(PSODLQT)
"RTN","PSODDPR2",84,0)
 K PSODCTH,RXDT,PSOZZ
"RTN","PSODDPR2",85,0)
 I $P(PSOPAR,"^",10),$O(^TMP($J,"PSODCOR",0)),'$G(PSODGCK) D  G EXIT:$G(PSODLQT) W !,PSONULN1,!  ;ME2-160687
"RTN","PSODDPR2",86,0)
 .D DCOR^PSODDPR3 K ^TMP($J,"PSODCOR")
"RTN","PSODDPR2",87,0)
 .D HD()
"RTN","PSODDPR2",88,0)
 E  D HD() I $D(^XUSEC("PSORPH",DUZ)) S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",89,0)
 ;I $P(PSOPAR,"^",10),$O(^TMP($J,"PSODCOR",0)),'$G(PSODGCK) D DCOR^PSODDPR3 K ^TMP($J,"PSODCOR") D HD() G EXIT:$G(PSODLQT) W !,PSONULN1,!
"RTN","PSODDPR2",90,0)
 ;E  I $D(^XUSEC("PSORPH",DUZ)) S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",91,0)
ERR I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" D  S NODTERR=1 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR
"RTN","PSODDPR2",92,0)
 .D HD() Q:$G(PSODLQT)  W !,"Drug Therapy Error(s):",! S CT=0,ON=""
"RTN","PSODDPR2",93,0)
 .F  S ON=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON)) Q:ON=""!$G(PSODLQT)  F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT)) Q:'CT!$G(PSODLQT)  D
"RTN","PSODDPR2",94,0)
 ..Q:$G(NODTERR)&($P(ON,";")'="Z")!$G(PSODLQT)
"RTN","PSODDPR2",95,0)
 ..D HD() Q:$G(PSODLQT)  W ?5,$S($P(ON,";")="P":"Pending Order: ",$P(ON,";")="N":"Non-VA Med Order: ",$P(ON,";")="R":"Remote Rx: ",$P(ON,";")="O":"Rx: ",1:"Prospective Rx: ")
"RTN","PSODDPR2",96,0)
 ..D HD() Q:$G(PSODLQT)  W " "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"MSG"),!,"   "_^TMP($J,LIST,"OUT","THERAPY","ERROR",ON,CT,"TEXT"),!
"RTN","PSODDPR2",97,0)
 K ZON,ZPSOCTH,ZDDT
"RTN","PSODDPR2",98,0)
 I $O(^TMP($J,LIST,"OUT","THERAPY","ERROR",""))]"" S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT Q:$G(PSODLQT)
"RTN","PSODDPR2",99,0)
 D HD()
"RTN","PSODDPR2",100,0)
EXIT ;
"RTN","PSODDPR2",101,0)
 D ^PSOBUILD
"RTN","PSODDPR2",102,0)
 K DSPL,CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG,ZCT,ZZCT,ZZZCT,CDDT ;PSO*7*411
"RTN","PSODDPR2",103,0)
 K IT,LST,THER,THERO,^UTILITY($J),DGI,SER,SEV,SERS,BSIG,I,NODDERR,NODTERR,PDRG,DRGI,STATUS,^UTILITY($J,"W"),X,ZX,DIWL,DIWR,DIWF,THER,THERO,PSOINTV,ZTHER,PSOVORD,PSODCTH,ZZDGDG,ZZDGDG2
"RTN","PSODDPR2",104,0)
 Q
"RTN","PSODDPR2",105,0)
 ;
"RTN","PSODDPR2",106,0)
RX D HD() Q:$G(PSODLQT)  W ! S RXREC=$P(ON,";",2)
"RTN","PSODDPR2",107,0)
 S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),STATUS=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPR2",108,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODDPR2",109,0)
 S J=RXREC D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",110,0)
 I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODDPR2",111,0)
 I STATUS>10,STATUS'=16 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR W @IOF S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC Q
"RTN","PSODDPR2",112,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",113,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODDPR2",114,0)
 I STATUS=16 W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! K DUP,RXRECLOC S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",115,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODDPR2",116,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODDPR2",117,0)
 .W !!,"Another person is editing Rx #"_$P($G(^PSRX(RXREC,0)),"^"),!
"RTN","PSODDPR2",118,0)
 K PSOMSG S DIR("A")=$S(STATUS=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(RXREC,0),"^"),DIR(0)="Y",DIR("?")="Enter Y to "_$S(STATUS=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODDPR2",119,0)
 D ^DIR K DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR2",120,0)
 S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S(STATUS=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODDPR2",121,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODDPR2",122,0)
 I 'Y W $C(7)," -Prescription was not "_$S(STATUS=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODDPR2",123,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S(STATUS=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP
"RTN","PSODDPR2",124,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODDPR2",125,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S(STATUS=12:"R",1:"C")
"RTN","PSODDPR2",126,0)
 W !!,"THERAPEUTIC DUPLICATIONS will be discontinued after the acceptance of the new order.",!!
"RTN","PSODDPR2",127,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_ST_"^"_DRG,PSONOOR="D"
"RTN","PSODDPR2",128,0)
 K RXRECLOC,DUP,CLS,PSONOOR,STATUS,ACT,PSONV,REA,SPCANC
"RTN","PSODDPR2",129,0)
 Q
"RTN","PSODDPR2",130,0)
 ;
"RTN","PSODDPR2",131,0)
DUPCL ;
"RTN","PSODDPR2",132,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR2",133,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 W:'$G(PSODUPF) @IOF,PSONULN1,!
"RTN","PSODDPR2",134,0)
 I '$G(PSODUPF) W "*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with"
"RTN","PSODDPR2",135,0)
 S:$G(PSODUPF) PSODUPC=PSODUPC+1 N PSODUPCT,PSODUPC2,PSODUPCL
"RTN","PSODDPR2",136,0)
 S (PSODUPC2,PSODUPCT)=0 S:'$G(PSODUPF) PSODUPCT=2
"RTN","PSODDPR2",137,0)
 ;displays order and therapy
"RTN","PSODDPR2",138,0)
 K DDTH S (PSODUPCL,ZSUB,ZCT,PSODSEQ)=""
"RTN","PSODDPR2",139,0)
 F  S ZCT=$O(ZTHER(ZCT)) Q:ZCT=""!($G(PSODLQT))  F  S PSODSEQ=$O(ZTHER(ZCT,PSODSEQ)) Q:PSODSEQ=""!($G(PSODLQT))  S ON=ZTHER(ZCT,PSODSEQ) D
"RTN","PSODDPR2",140,0)
 .S PDODCNT=0,PSODUPC2=PSODUPC2+1 I $G(PSODUPF) S PSODUPC(ZCT)=0
"RTN","PSODDPR2",141,0)
 .I PSODUPC2=PSODUPC2+1
"RTN","PSODDPR2",142,0)
 .I '$G(PSODUPF) D
"RTN","PSODDPR2",143,0)
 ..I PSODUPC2=PSODUPC1,(PSODUPCT+PSODUPC(ZCT)+PSODUPC("CLASS"))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",144,0)
 ..I (PSODUPCT+PSODUPC(ZCT))>22 D HD(15) Q:$G(PSODLQT)  S PSODUPCT=0
"RTN","PSODDPR2",145,0)
 ..S PSODUPCT=PSODUPCT+PSODUPC(ZCT)
"RTN","PSODDPR2",146,0)
 .I $P(ON,";")="O" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! S THER=1 D DDRX^PSODDPR8 D
"RTN","PSODDPR2",147,0)
 ..Q:STATUS>5&(STATUS'=16)
"RTN","PSODDPR2",148,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""
"RTN","PSODDPR2",149,0)
 ..Q:$G(RXDT("O",RXREC))
"RTN","PSODDPR2",150,0)
 ..S RX0=^PSRX(RXREC,0),J=RXREC,RX2=^PSRX(RXREC,2) D STAT^PSOFUNC K RX0,RX2
"RTN","PSODDPR2",151,0)
 ..S PSOZZ=PSOZZ+1,^TMP($J,"PSODCOR",PSOZZ)="52"_"^"_RXREC_"^"_ST_"^"_DRGNM,RXDT("O",RXREC)=1
"RTN","PSODDPR2",152,0)
 .I $P(ON,";")="N" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D ^PSODDPR3
"RTN","PSODDPR2",153,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR2",154,0)
 ..; PSO*7*411
"RTN","PSODDPR2",155,0)
 ..D HD(8) Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! S RXREC=$P(ON,";",2),THER=1 D PEND^PSODDPR8
"RTN","PSODDPR2",156,0)
 ..Q:$G(^TMP("PSORXDC",$J,RXREC,0))]""
"RTN","PSODDPR2",157,0)
 ..Q:$G(RXDT("P",RXREC))
"RTN","PSODDPR2",158,0)
 ..S PSOZZ=PSOZZ+1,DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR2",159,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)="P"_"^"_RXREC_"^^"_$S($P(DUPRX0,"^",9):$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"),1:$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"))
"RTN","PSODDPR2",160,0)
 ..S ^TMP($J,"PSODCOR",PSOZZ)=^TMP($J,"PSODCOR",PSOZZ)_"^"_$S('$P(DUPRX0,"^",9):$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(DUPRX0,"^",8),0),"^",2),0),"^"),1:$P(^PSDRUG($P(DUPRX0,"^",9),0),"^"))
"RTN","PSODDPR2",161,0)
 ..S RXDT("P",RXREC)=1
"RTN","PSODDPR2",162,0)
 .I $P(ON,";")="R" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D RDI^PSODDPR3 D HD() Q:$G(PSODLQT)
"RTN","PSODDPR2",163,0)
 .I $E($P(ON,";"))="C" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) ! D DUP^PSODDPR7  ; clinic order
"RTN","PSODDPR2",164,0)
 .I $O(ZTHER(ZCT,PSODSEQ))'="" D HD() Q:$G(PSODLQT)  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,PSONULN
"RTN","PSODDPR2",165,0)
 D CLASSES^PSODDPR3
"RTN","PSODDPR2",166,0)
 ;format therapy classes pso*7*411
"RTN","PSODDPR2",167,0)
 N X S (ZCT,ZZCT,ZZZCT)=0
"RTN","PSODDPR2",168,0)
 F  S ZZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT)) Q:'ZZCT  S ZCT=0 F  S ZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT)) Q:'ZCT  D
"RTN","PSODDPR2",169,0)
 .;S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")  ; ME2 - 1602256
"RTN","PSODDPR2",170,0)
 .S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")_$S($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT))!($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT))):", ",1:"")
"RTN","PSODDPR2",171,0)
 Q:$G(PSODLQT)!($D(^XUSEC("PSORPH",DUZ)))
"RTN","PSODDPR2",172,0)
 I '$G(PSODUPF),'$D(^XUSEC("PSORPH",DUZ)) D
"RTN","PSODDPR2",173,0)
 .S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR W @IOF
"RTN","PSODDPR2",174,0)
 .I '$G(PSODUPF),Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",175,0)
 .I '$G(PSODUPF),($Y+5)>IOSL W @IOF
"RTN","PSODDPR2",176,0)
 Q
"RTN","PSODDPR2",177,0)
INT ;
"RTN","PSODDPR2",178,0)
 Q:$D(PSSDIUTL)
"RTN","PSODDPR2",179,0)
 D INT^PSODDPR5
"RTN","PSODDPR2",180,0)
 Q
"RTN","PSODDPR2",181,0)
HD(PSOLINES,OVRRID) ;
"RTN","PSODDPR2",182,0)
 S:'$G(PSODLQT) PSODLQT=0  S:'$G(OVRRID) OVRRID=0 S:'$G(PSOLINES) PSOLINES=5
"RTN","PSODDPR2",183,0)
 I '$G(OVRRID),$G(PSODLQT)!(($Y+PSOLINES)'>IOSL) Q
"RTN","PSODDPR2",184,0)
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
"RTN","PSODDPR2",185,0)
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSODDPR2",186,0)
 K PSOLINES,OVRRID
"RTN","PSODDPR2",187,0)
 I Y'=1!($D(DTOUT))!($D(DUOUT)) S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR2",188,0)
 W:'$G(PSODUPF) @IOF
"RTN","PSODDPR2",189,0)
 Q
"RTN","PSODDPR2",190,0)
 ;
"RTN","PSODDPR2",191,0)
DGSORT ;
"RTN","PSODDPR2",192,0)
 ;this sort is used in monograph and clinic effects display so that they are displayed once per VA generic drug
"RTN","PSODDPR2",193,0)
 S (SEV,TYP,PSOVAG,PSONAM)="" F  S SEV=$O(ZZDGDG3(SEV)) Q:SEV=""  F  S PSOVAG=$O(ZZDGDG3(SEV,PSOVAG)) Q:PSOVAG=""  D
"RTN","PSODDPR2",194,0)
 .S COUNT2=0 F  S PSONAM=$O(ZZDGDG3(SEV,PSOVAG,PSONAM)) Q:PSONAM=""  S COUNT2=COUNT2+1,ZZDGDG2(SEV,PSOVAG)=COUNT2
"RTN","PSODDPR2",195,0)
 K COUNT2,PSONAM
"RTN","PSODDPR2",196,0)
 Q
"RTN","PSODDPR5")
0^5^B163007377
"RTN","PSODDPR5",1,0)
PSODDPR5 ;BIR/SAB - displays OP/rdi/pending/nva orders ;09/12/06 11:33am
"RTN","PSODDPR5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,379,390,372,416,438,411**;DEC 1997;Build 95
"RTN","PSODDPR5",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 4846
"RTN","PSODDPR5",4,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR5",5,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR5",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228 
"RTN","PSODDPR5",7,0)
 ;
"RTN","PSODDPR5",8,0)
EXC ;displays order check exceptions
"RTN","PSODDPR5",9,0)
 N Q,CT,ONT,OT,ON,TD,ERRTY,OP,OPP,ZEXC,ZREA,X,DIWL,DIWR,DIWF,PSOWROTE,ZX
"RTN","PSODDPR5",10,0)
 I ($Y+5)'>IOSL D HD^PSODDPR2() Q:$G(PSODLQT)  ;W @IOF
"RTN","PSODDPR5",11,0)
 S (CT,Q)=0,ONT=""
"RTN","PSODDPR5",12,0)
 F  S ONT=$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT)) Q:ONT=""  F  S CT=$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT)) Q:'CT  D
"RTN","PSODDPR5",13,0)
 .S ZEXC=^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),ZREA=$P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",10)
"RTN","PSODDPR5",14,0)
 .S OT=$P(ONT,";"),ON=$P(ONT,";",2),OP=$P(ONT,";",3),OPP=OT_";"_ON_";"_OP
"RTN","PSODDPR5",15,0)
 .I '$D(PSODGCK),'$D(PSSDGCK),OT="Z",ZREA="Drug not matched to NDF"!($P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",7)["manual check") S PSODRUG("BAD",PSODRUG("IEN"))=1
"RTN","PSODDPR5",16,0)
 .Q:$G(^TMP($J,"PSEXC","OUT",OPP))
"RTN","PSODDPR5",17,0)
 .S Q=Q+1,ERRTY=$S(OT="R":"RDI",OT="N":"Non-VA",OT="P":"Pending",OT="O":"Rx",1:"")
"RTN","PSODDPR5",18,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPR5",19,0)
 .W ! S X=$P(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT),"^",7) D ^DIWP
"RTN","PSODDPR5",20,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0) S PSOWROTE=1
"RTN","PSODDPR5",21,0)
 .I $D(PSODGCK)!$D(PSSDGCK) K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." W ! D ^DIR K DIR W @IOF
"RTN","PSODDPR5",22,0)
 .S:OT'="Z" ^TMP($J,"PSEXC","OUT",OPP)=1,PSOWROTE=1
"RTN","PSODDPR5",23,0)
 .Q:ZREA=""
"RTN","PSODDPR5",24,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPR5",25,0)
 .S X="   Reason(s): "_ZREA D ^DIWP
"RTN","PSODDPR5",26,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0) S PSOWROTE=1
"RTN","PSODDPR5",27,0)
 .K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF
"RTN","PSODDPR5",28,0)
 .D:$O(^TMP($J,LIST,"OUT","EXCEPTIONS",ONT,CT)) HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR5",29,0)
 W !! I $G(PSOWROTE) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 W ! K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSODDPR5",30,0)
 Q
"RTN","PSODDPR5",31,0)
NOCAN ;shows duplicate therapeutic when cancel duplicate class parameter is et to 'no'
"RTN","PSODDPR5",32,0)
 K ^UTILITY($J,"W"),DDTH,DOCPL S DIWL=1,DIWR=78,DIWF="",(CT,SUB)=0 K TCT,TCTP,TCTL,TCTI,ZZQ,ZHDR
"RTN","PSODDPR5",33,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D
"RTN","PSODDPR5",34,0)
 .S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^"),PDRG=$P(^(SUB),"^",3),RXREC=$P(ON,";",2)
"RTN","PSODDPR5",35,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR5",36,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR5",37,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR5",38,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR5",39,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",40,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",41,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR5",42,0)
 .I '$G(ZHDR) D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  W !,PSONULN,!,"*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with",! S ZHDR=1
"RTN","PSODDPR5",43,0)
 Q:'$G(ZHDR)  Q:$G(PSODLQT)
"RTN","PSODDPR5",44,0)
 N ST,STA,STAT,ORT K DOCPL
"RTN","PSODDPR5",45,0)
 S (SUB,CT)=0 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D DUPCL K DDTH
"RTN","PSODDPR5",46,0)
 D DUPCP
"RTN","PSODDPR5",47,0)
 Q
"RTN","PSODDPR5",48,0)
DUPCL ;
"RTN","PSODDPR5",49,0)
 S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^"),PDRG=$P(^(SUB),"^",3),RXREC=$P(ON,";",2)
"RTN","PSODDPR5",50,0)
 I $P(ON,";")="Z" Q
"RTN","PSODDPR5",51,0)
 I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR5",52,0)
 I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR5",53,0)
 I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",54,0)
 I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR5",55,0)
 I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR5",56,0)
 S ORT=$S($P(ON,";")="N":4,$P(ON,";")="P":3,$P(ON,";")="R":2,1:1)
"RTN","PSODDPR5",57,0)
 S DOCPL(ORT,ON)=""
"RTN","PSODDPR5",58,0)
 Q
"RTN","PSODDPR5",59,0)
DUPCP D HD^PSODDPR2():(($Y+5)'>IOSL) S ORT=0,ON=""  F  S ORT=$O(DOCPL(ORT)) Q:'ORT!$G(PSODLQT)  F  S ON=$O(DOCPL(ORT,ON)) Q:ON=""!$G(PSODLQT)  D
"RTN","PSODDPR5",60,0)
 .I $P(ON,";")="O" D
"RTN","PSODDPR5",61,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  S ST=$P(^PSRX($P(ON,";",2),"STA"),"^")+1
"RTN","PSODDPR5",62,0)
 ..S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED BY PROVIDER^DISCONTINUE EDIT^PROVIDER HOLD"
"RTN","PSODDPR5",63,0)
 ..S STAT=$P(STA,"^",ST) W !?2,"Local Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" ("_STAT_") for "_$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR5",64,0)
 .I $P(ON,";")="P" D
"RTN","PSODDPR5",65,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",66,0)
 ..N DNM,DUPRX0 S RXREC=$P(ON,";",2),DNM=$P(^PS(52.41,RXREC,0),"^",9)
"RTN","PSODDPR5",67,0)
 ..S DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR5",68,0)
 ..W !?2,"Pending Order for "
"RTN","PSODDPR5",69,0)
 ..I '$P(DUPRX0,"^",9) W $P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR5",70,0)
 ..E  W $P(^PSDRUG($P(DUPRX0,"^",9),0),"^")
"RTN","PSODDPR5",71,0)
 .I $P(ON,";")="R" N RXDAT D
"RTN","PSODDPR5",72,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",73,0)
 ..N RDIRX S RXDAT=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2))
"RTN","PSODDPR5",74,0)
 ..S RDIRX=$P(RXDAT,"^",5) D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  W !?2,"Remote Rx #"_RDIRX_" ("_$P(RXDAT,"^",4)_") for "_$P(RXDAT,"^",3)
"RTN","PSODDPR5",75,0)
 .I $P(ON,";")="N" D
"RTN","PSODDPR5",76,0)
 ..Q:'$D(^PS(55,PSODFN,"NVA",$P(ON,";",2),0))
"RTN","PSODDPR5",77,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0) N NVAQ
"RTN","PSODDPR5",78,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",79,0)
 ..W !?2,"Non-VA Med for "
"RTN","PSODDPR5",80,0)
 ..I '$P(DUPRX0,"^",2) W $P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR5",81,0)
 ..E  W $P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR5",82,0)
 .S DDTH(ON)=1
"RTN","PSODDPR5",83,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR5",84,0)
 D CLASSES^PSODDPR3
"RTN","PSODDPR5",85,0)
 D HD^PSODDPR2(0,1) Q:$G(PSODLQT)
"RTN","PSODDPR5",86,0)
 Q
"RTN","PSODDPR5",87,0)
REMOTE ;backdoor RDI
"RTN","PSODDPR5",88,0)
 Q:$G(PSODLQT)
"RTN","PSODDPR5",89,0)
 N INDD,DO,P3,RDIDNAM,RDIVUID,RDITMP,PSORDI,SEQN,ZI
"RTN","PSODDPR5",90,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,LIST,"OUT","REMOTE",PSORDI)) Q:'PSORDI!$G(PSODLQT)  S RDITMP=^(PSORDI) D  K PSOSEQN
"RTN","PSODDPR5",91,0)
 .I $P(RDITMP,"^",2)="" Q
"RTN","PSODDPR5",92,0)
 .S RDIVUID=$P(RDITMP,"^",2),RDIDNAM=$P(RDITMP,"^",3)
"RTN","PSODDPR5",93,0)
 .I $O(PDRG(0)) F ZI=0:0 S ZI=$O(PDRG(ZI)) Q:'ZI  I $P(^PSDRUG($P(PDRG(ZI),"^"),0),"^")=RDIDNAM S INDD=+$G(INDD)+1,^TMP($J,"DD",INDD,0)=$P(PDRG(ZI),"^")_"^"_RDIDNAM_"^^"_PSORDI_"Z;O"
"RTN","PSODDPR5",94,0)
 .S DO=$G(DO)+1 D GETIREF^XTID(50.68,.01,RDIVUID,"PSOSEQN",1) I 'PSOSEQN S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=0_"^"_RDIVUID_"^0^"_RDIDNAM_"^^" Q
"RTN","PSODDPR5",95,0)
 .S SEQN="" S SEQN=$O(PSOSEQN(50.68,.01,SEQN)) Q:SEQN=""
"RTN","PSODDPR5",96,0)
 .S P3=+SEQN,SEQN=$P($$PROD0^PSNAPIS(,P3),"^",7)
"RTN","PSODDPR5",97,0)
 .S ^TMP($J,LIST,"IN","PROFILE","R;"_PSORDI_";PROFILE;"_DO)=SEQN_"^"_RDIVUID_"^0^"_RDIDNAM_"^^"
"RTN","PSODDPR5",98,0)
 Q
"RTN","PSODDPR5",99,0)
NSRT ;sort of drug interactions ; called by psoddpr2
"RTN","PSODDPR5",100,0)
 ;Q:$G(PSODLQT)
"RTN","PSODDPR5",101,0)
 N SV,SEV,STOP,TYP,CNT,CHK,DRG,ON,CT,ZOT,PSOVAG,PSODD,COUNT,NSRT,NSRT2,II,ZZDGDG3 S COUNT=0,(SV,DRG,ON,CT,PSOVAG)=""
"RTN","PSODDPR5",102,0)
 F  S SV=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV)) Q:SV=""!$G(PSODLQT)  D  Q:$G(PSORX("DFLG"))
"RTN","PSODDPR5",103,0)
 .F  S DRG=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG)) Q:DRG=""!$G(PSODLQT)  F  S ON=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON)) Q:ON=""!$G(PSODLQT)  F  S CT=$O(^TMP($J,LIST,"OUT","DRUGDRUG",SV,DRG,ON,CT)) Q:'CT!$G(PSODLQT)  D
"RTN","PSODDPR5",104,0)
 ..I $P(ON,";")'="Z",$P(ON,";")="O",$P(^PSRX($P(ON,";",2),"STA"),"^")>5,$P(^PSRX($P(ON,";",2),"STA"),"^")'=16 Q
"RTN","PSODDPR5",105,0)
 ..I $P(ON,";")'="Z",$P(ON,";")="R" D RVAGEN Q
"RTN","PSODDPR5",106,0)
 ..I $P(ON,";")'="Z",$P(ON,";")="P",'$P($G(^PS(52.41,$P(ON,";",2),0)),"^",9) S PSORDIT=$P($G(^PS(52.41,$P(ON,";",2),0)),"^",8) D:$G(PSORDIT) DVAGEN ;Q  163815
"RTN","PSODDPR5",107,0)
 ..I $P(ON,";")'="Z",$P(ON,";")="N",'$P($G(^PS(55,PSODFN,"NVA",$P(ON,";",2),0)),"^",2) S PSORDIT=$P($G(^PS(55,PSODFN,"NVA",$P(ON,";",2),0)),"^") D:$G(PSORDIT) DVAGEN ;Q  ;*438
"RTN","PSODDPR5",108,0)
 ..S PSODD=$O(^PSDRUG("B",DRG,0)) D:PSODD'="" VAGEN^PSODDPR3(PSODD)
"RTN","PSODDPR5",109,0)
 ..S:PSOVAG="" PSOVAG=DRG
"RTN","PSODDPR5",110,0)
 ..S ZOT=$S($P(ON,";")["C":1,$P(ON,";")="O":2,$P(ON,";")="R":3,$P(ON,";")="P":4,1:5)
"RTN","PSODDPR5",111,0)
 ..S ZDGDG(SV,ZOT,PSOVAG,DRG)=ON_"^"_CT,ZZDGDG3(SV,PSOVAG,DRG)=""
"RTN","PSODDPR5",112,0)
 ..I ZOT=1 S PSOCLNS(SV,PSOVAG,DRG,ON)=CT
"RTN","PSODDPR5",113,0)
 ..I '$D(NSRT(SV,PSOVAG)) S NSRT(SV,PSOVAG)=ZOT
"RTN","PSODDPR5",114,0)
 ..E  S $P(NSRT(SV,PSOVAG),"^",1)=$P(NSRT(SV,PSOVAG),"^",1)_","_ZOT
"RTN","PSODDPR5",115,0)
 ;resort of zdgdg
"RTN","PSODDPR5",116,0)
 K ZZDGDG S (SEV,STOP,PSOVAG,TYP,ON)="",CNT=0
"RTN","PSODDPR5",117,0)
 F J=1:1:5 F  S SEV=$O(NSRT(SEV)) Q:SEV=""  F I=1:1:5 F  S PSOVAG=$O(NSRT(SEV,PSOVAG)) Q:PSOVAG=""  D
"RTN","PSODDPR5",118,0)
 .S TYP="",TYP=","_$P(NSRT(SEV,PSOVAG),"^",1)_","
"RTN","PSODDPR5",119,0)
 .Q:TYP'[(","_J_",")
"RTN","PSODDPR5",120,0)
 .S STOP=0 F CHK=1:1:5 I TYP[(","_CHK_",")&(CHK<J) S STOP=1
"RTN","PSODDPR5",121,0)
 .Q:STOP
"RTN","PSODDPR5",122,0)
 .S CNT=CNT+1 F II=J:1:5 S TYP=I I $D(ZDGDG(SEV,TYP)) D S2(SEV,TYP,PSOVAG,CNT)
"RTN","PSODDPR5",123,0)
 D DGSORT^PSODDPR2
"RTN","PSODDPR5",124,0)
 K NSRT,J,F,I,ZDGDG,COUNT,CNT
"RTN","PSODDPR5",125,0)
 Q
"RTN","PSODDPR5",126,0)
 ;print order sort
"RTN","PSODDPR5",127,0)
S2(SEV,TYP,PSOVAG,CNT) ;
"RTN","PSODDPR5",128,0)
 N PSONAM,COUNT2 S (PSONAM)="",COUNT2=0
"RTN","PSODDPR5",129,0)
 F  S PSONAM=$O(ZDGDG(SEV,TYP,PSOVAG,PSONAM)) Q:PSONAM=""  S COUNT2=COUNT2+1 D
"RTN","PSODDPR5",130,0)
 .S ZZDGDG(SEV,CNT,TYP,PSOVAG,PSONAM)=ZDGDG(SEV,TYP,PSOVAG,PSONAM)
"RTN","PSODDPR5",131,0)
 .S ZZDGCK(SEV,CNT,TYP,PSOVAG,PSONAM)=ZDGDG(SEV,TYP,PSOVAG,PSONAM)
"RTN","PSODDPR5",132,0)
 Q
"RTN","PSODDPR5",133,0)
 ;
"RTN","PSODDPR5",134,0)
NSRT1 ;sort out dc'd drug therapies local and remote rxs
"RTN","PSODDPR5",135,0)
 N RXN,SUB S (SUB,CT)=0 K PSODCTH
"RTN","PSODDPR5",136,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D
"RTN","PSODDPR5",137,0)
 .S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^")
"RTN","PSODDPR5",138,0)
 .I $P(ON,";")="O",$P($G(^PSRX($P(ON,";",2),3)),"^",5) D  Q
"RTN","PSODDPR5",139,0)
 ..S RXN=$P(ON,";",2),X1=$P($G(^PSRX($P(ON,";",2),3)),"^",5),X2=(+$P(^PSRX($P(ON,";",2),0),"^",8)+7)
"RTN","PSODDPR5",140,0)
 ..D C^%DTC I X<DT S PSODCTH(ON)=1 K X,Y,X1,X2
"RTN","PSODDPR5",141,0)
 .I $P(ON,";")="R",$P($G(^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2))),"^",4)["DISC" D
"RTN","PSODDPR5",142,0)
 ..S RXN=$P(ON,";",2) K X,Y,X1,X2
"RTN","PSODDPR5",143,0)
 ..S X=$P(^TMP($J,LIST,"OUT","REMOTE",RXN),"^",6) D ^%DT S X1=Y,X2=(+$P(^TMP($J,LIST,"OUT","REMOTE",RXN),"^",7)+7)
"RTN","PSODDPR5",144,0)
 ..D C^%DTC I X<DT S PSODCTH(ON)=1 K X,Y,X1,X2
"RTN","PSODDPR5",145,0)
 Q
"RTN","PSODDPR5",146,0)
 ;
"RTN","PSODDPR5",147,0)
RVAGEN ;va generic for remote drugs
"RTN","PSODDPR5",148,0)
 N PSOVUID,PSONDF,PSOVAG,DIC
"RTN","PSODDPR5",149,0)
 S PSOVUID=$P(^TMP($J,"PSOPEPS","OUT","REMOTE",$P(ON,";",2)),"^",2) Q:'$G(PSOVUID)
"RTN","PSODDPR5",150,0)
 K PSORDIID S PSOVAGEN="" D GETIREF^XTID("50.68",".01",PSOVUID,"PSORDIID")
"RTN","PSODDPR5",151,0)
 S PSONDF=$O(PSORDIID(50.68,.01,"")) K PSORDIID
"RTN","PSODDPR5",152,0)
 I +PSONDF D DATA^PSN50P68(+PSONDF,,"PSONDF") D
"RTN","PSODDPR5",153,0)
 .S PSOVAG=$P($G(^TMP($J,"PSONDF",+PSONDF,.05)),U,2),ZDGDG(SV,2,PSOVAG,DRG)=ON_"^"_CT,ZZDGDG3(SV,PSOVAG,DRG)=""
"RTN","PSODDPR5",154,0)
 .I '$D(NSRT(SV,PSOVAG)) S NSRT(SV,PSOVAG)=3
"RTN","PSODDPR5",155,0)
 .E  S $P(NSRT(SV,PSOVAG),"^",1)=$P(NSRT(SV,PSOVAG),"^",1)_",3"
"RTN","PSODDPR5",156,0)
 K ^TMP($J,"PSONDF")
"RTN","PSODDPR5",157,0)
 Q
"RTN","PSODDPR5",158,0)
 ;
"RTN","PSODDPR5",159,0)
DVAGEN ;va generic for non-va/pending meds
"RTN","PSODDPR5",160,0)
 S PSI=0 N PSID,PSODD,PSOVAG
"RTN","PSODDPR5",161,0)
 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["X":0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",162,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",163,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["U":0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",164,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["I":0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",165,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S('$L($P($G(^PSDRUG(PSI,2)),"^",3)):0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",166,0)
 I PSI="" S PSI=0 F  S PSI=$O(^PSDRUG("ASP",PSORDIT,PSI)) Q:'PSI!($G(PSID)'="")  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($L($P($G(^PSDRUG(PSI,2)),"^",3)):0,1:1) S PSID=$P($G(^PSDRUG(PSI,0)),"^")
"RTN","PSODDPR5",167,0)
 Q:$G(PSID)']""
"RTN","PSODDPR5",168,0)
 S PSODD=$O(^PSDRUG("B",PSID,0)) D VAGEN^PSODDPR3(PSODD)
"RTN","PSODDPR5",169,0)
 Q:$G(PSOVAG)']""
"RTN","PSODDPR5",170,0)
 S ZOT=$S($P(ON,";")="O":1,$P(ON,";")="R":2,$P(ON,";")="P":3,1:4),ZDGDG(SV,ZOT,PSOVAG,DRG)=ON_"^"_CT,ZZDGDG3(SV,PSOVAG,DRG)="",COUNT=COUNT+1
"RTN","PSODDPR5",171,0)
 K PSI,PSID,PSORDIT,PSODD,PSOVAG
"RTN","PSODDPR5",172,0)
 Q
"RTN","PSODDPR5",173,0)
 ;
"RTN","PSODDPR5",174,0)
INT ;
"RTN","PSODDPR5",175,0)
 I $G(PSOVORD),$P(PSOINTV,"^")=1 D  Q
"RTN","PSODDPR5",176,0)
 .K DIR,DTOUT,DIRUT,DIROUT,DUOUT N DA
"RTN","PSODDPR5",177,0)
 .W ! S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue? ",DIR("B")="Y" D ^DIR S:($D(DTOUT))!($D(DUOUT))!($G(DIRUT)) PSODLQT=1,PSORX("DFLG")=1 Q:$G(PSODLQT)
"RTN","PSODDPR5",178,0)
 .K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODDPR5",179,0)
 .I 'Y S PSODLQT=1,PSORX("DFLG")=1 Q
"RTN","PSODDPR5",180,0)
 .S DA=PSONV,RXREC=DA,RX=$G(^PSRX(RXREC,0)),PSORX("INTERVENE")=1
"RTN","PSODDPR5",181,0)
 .D:'$D(PSODGCK) CRI^PSODGDG1
"RTN","PSODDPR5",182,0)
 .I $G(OLDDA) S DA=OLDDA K OLDDA
"RTN","PSODDPR5",183,0)
 Q:$G(PSODLQT)!($G(PSORX("DFLG")))
"RTN","PSODDPR5",184,0)
 I '$D(PSODGCK),$P(PSOINTV,"^") S IT=$P(PSOINTV,"^"),ON=$P(PSOINTV,"^",2) D ^PSODGDGP K DIR S IT=$P(PSOINTV,"^")
"RTN","PSODDPR5",185,0)
 Q
"RTN","PSODDPR5",186,0)
 ;
"RTN","PSODDPR5",187,0)
DGCK ;CK - Drug check option at patient profile
"RTN","PSODDPR5",188,0)
 I '$D(PSOSD) D FULL^VALM1 D CKMSG G DGCKQ
"RTN","PSODDPR5",189,0)
 N PSODGCKX
"RTN","PSODDPR5",190,0)
 S (PSODGCK,PSONCROC)=1
"RTN","PSODDPR5",191,0)
 D FULL^VALM1
"RTN","PSODDPR5",192,0)
 D PSOCK^PSOUTL
"RTN","PSODDPR5",193,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." W ! D ^DIR K DIR W @IOF,!
"RTN","PSODDPR5",194,0)
 D SELECT
"RTN","PSODDPR5",195,0)
 I $G(PSONEW("DFLG"))=1!'$D(PSOSD) W ! G DGCKQ
"RTN","PSODDPR5",196,0)
 D SET^PSODRG
"RTN","PSODDPR5",197,0)
DGCKNP D POST^PSODRG
"RTN","PSODDPR5",198,0)
DGCKQ S VALMBCK="R"
"RTN","PSODDPR5",199,0)
 K PSODGCK,PSODGCKX,MON,PSONEW("DFLG"),PSORX("DFLG"),PSOIENID,PSOGCNPT,PSOGCNID,PSONDFID,DGCKDUPF,PSONCROC
"RTN","PSODDPR5",200,0)
 Q
"RTN","PSODDPR5",201,0)
 ;
"RTN","PSODDPR5",202,0)
GCN(PSOIENID) ;Return 0 for not matched, 1 for matched with no GCNSEQNO, 1^1 for matched with a GCNSEQNO
"RTN","PSODDPR5",203,0)
 N PSONDFID,PSOGCNPT,PSOGCNID
"RTN","PSODDPR5",204,0)
 S PSONDFID=$P($G(^PSDRUG(PSOIENID,"ND")),"^"),PSOGCNPT=$P($G(^PSDRUG(PSOIENID,"ND")),"^",3)
"RTN","PSODDPR5",205,0)
 I 'PSONDFID!('PSOGCNPT) Q 0
"RTN","PSODDPR5",206,0)
 S PSOGCNID=$$PROD0^PSNAPIS(PSONDFID,PSOGCNPT)
"RTN","PSODDPR5",207,0)
 I $P(PSOGCNID,"^",7) Q PSOIENID_";"_PSONDFID_";"_$P(PSOGCNID,"^",7)
"RTN","PSODDPR5",208,0)
 Q PSOIENID_";"_PSONDFID
"RTN","PSODDPR5",209,0)
 ;
"RTN","PSODDPR5",210,0)
PKGFLG(PKF1) ;Return 0 for not in range of acceptable package flags, 1 for within range
"RTN","PSODDPR5",211,0)
 I $S(PKF1["O":1,1:0) Q 1
"RTN","PSODDPR5",212,0)
 I $S(PKF1["X":1,1:0) Q 1
"RTN","PSODDPR5",213,0)
 Q 0
"RTN","PSODDPR5",214,0)
 ;
"RTN","PSODDPR5",215,0)
SELECT ;
"RTN","PSODDPR5",216,0)
 N PSODGCKD S PSODGCKD=0 K:'$G(PSORXED) CLOZPAT
"RTN","PSODDPR5",217,0)
 K IT,DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW"),PSODRUG("BAD") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODDPR5",218,0)
 I $G(PSODRUG("IEN"))]"",'$D(PSODGCK) S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODDPR5",219,0)
 W !,"DRUG: " R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSODDPR5",220,0)
 I PSODGCK,X="",PSOSD<2 D CKMSG S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODDPR5",221,0)
 S:X="" PSODGCKX=1
"RTN","PSODDPR5",222,0)
 I X="",$G(Y)]"" S:Y X=Y S:'X X=$G(PSODRUG("IEN")) S:X X="`"_X
"RTN","PSODDPR5",223,0)
 I X="",$D(PSOSD) S X=$O(PSOSD($O(PSOSD("")),"")),PSODGCKD=1
"RTN","PSODDPR5",224,0)
 I X="",'$D(PSOSD) D  Q
"RTN","PSODDPR5",225,0)
 .W !!,"Now Processing Enhanced Order Checks!  Please wait..." H 1
"RTN","PSODDPR5",226,0)
 .W !!,"No Order Check Warnings Found",! K DIR S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR
"RTN","PSODDPR5",227,0)
 I X?1."?" W !!,"Answer with DRUG NUMBER, or GENERIC NAME, or VA PRODUCT NAME, or",!,"NATIONAL DRUG CLASS, or SYNONYM" G SELECT
"RTN","PSODDPR5",228,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODDPR5",229,0)
 I X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODDPR5",230,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODDPR5",231,0)
 S DIC=50,DIC(0)="MZV",D="B^C^VAPN^VAC"
"RTN","PSODDPR5",232,0)
 I 'PSODGCKD S DIC=50,DIC(0)="EMQZVT",DIC("T")="",D="B^C^VAPN^VAC"
"RTN","PSODDPR5",233,0)
 I 'PSODGCKD S DIC("S")="I $S('$D(^PSDRUG(+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$$GCN^PSODDPR5(+Y),$$PKGFLG^PSODDPR5($P($G(^PSDRUG(+Y,2)),""^"",3)),$D(^PSDRUG(""ASP"",+$G(^(2)),+Y))"
"RTN","PSODDPR5",234,0)
 D MIX^DIC1 K DIC,PKF1,D
"RTN","PSODDPR5",235,0)
 I $$PSOSUPCK^PSOUTL(+Y) G SELECT
"RTN","PSODDPR5",236,0)
 S (DGCKSTA,DGCKDNM)=""
"RTN","PSODDPR5",237,0)
 I '$G(PSODGCKX),$D(PSOSD) F  S DGCKSTA=$O(PSOSD(DGCKSTA)) Q:DGCKSTA=""!$G(DGCKDUPF)  F  S DGCKDNM=$O(PSOSD(DGCKSTA,DGCKDNM)) Q:DGCKDNM=""!$G(DGCKDUPF)  D
"RTN","PSODDPR5",238,0)
 .I DGCKDNM=$G(Y(0,0)) D
"RTN","PSODDPR5",239,0)
 ..S DGCKDUPF=1 W !!,"Duplicate Drug in Patient profile, please select a different drug:",!
"RTN","PSODDPR5",240,0)
 ..K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR W @IOF
"RTN","PSODDPR5",241,0)
 I $D(DGCKDUPF) K DGCKDUPF,PSODGCKX G SELECT
"RTN","PSODDPR5",242,0)
 I '$D(PSOSD) D  Q
"RTN","PSODDPR5",243,0)
 .W !!,"Now Processing Enhanced Order Checks!  Please wait..." H 1
"RTN","PSODDPR5",244,0)
 .W !!,"No Order Check Warnings Found",! K DIR S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR
"RTN","PSODDPR5",245,0)
 I $D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODDPR5",246,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODDPR5",247,0)
 I Y<0 G SELECT
"RTN","PSODDPR5",248,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODDPR5",249,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSODDPR5",250,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE^PSODRG
"RTN","PSODDPR5",251,0)
SELECTX K X,Y,DTOUT,DUOUT,PSONEW("OLD VAL"),PSODGCKD,DGCKDNM,DGCKSTA
"RTN","PSODDPR5",252,0)
 Q
"RTN","PSODDPR5",253,0)
 ;
"RTN","PSODDPR5",254,0)
CKMSG ;
"RTN","PSODDPR5",255,0)
 W !!,"Not enough active profile drugs to perform drug check",! K DIR S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR
"RTN","PSODDPR5",256,0)
 Q
"RTN","PSODDPR7")
0^18^B148972341
"RTN","PSODDPR7",1,0)
PSODDPR7 ; BIR/OG ; Enhanced order checks - IMO Utilities ;12/6/11
"RTN","PSODDPR7",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**390,411**;DEC 1997;Build 95
"RTN","PSODDPR7",3,0)
 ;External reference to IN^PSJBLDOC supported by DBIA 5306
"RTN","PSODDPR7",4,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPR7",5,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPR7",6,0)
 ;
"RTN","PSODDPR7",7,0)
 ; Required to be present:
"RTN","PSODDPR7",8,0)
 ;   DFN: patient internal entry number
"RTN","PSODDPR7",9,0)
 ;   DRG - dispensed drug name
"RTN","PSODDPR7",10,0)
 ;   SV - Severity
"RTN","PSODDPR7",11,0)
 ;    ZVA - VA Generic Name
"RTN","PSODDPR7",12,0)
 ;   ON: Order identifier =  first ";" piece: I1 - IV order. I2 - UD order; second ";" piece: order id; example:  ON="C2;4;PROFILE;5"
"RTN","PSODDPR7",13,0)
 ;
"RTN","PSODDPR7",14,0)
 Q:$E($P(ON,";"))'["C"
"RTN","PSODDPR7",15,0)
 N DRGNAME,STATUS,STARTDT,STOPDT,SCHEDULE,ORDID,DOSAGE,FILENODE,ADD,SOL,ADDNAM,SOLNAM,BOTTLE,STRENGTH,AFLG,ADDS,SOLUTION,VOLUME,IVDATA,SORT,INFUSE,SFLG,PSOCON,PSOCLINI,SORT2,PSOCLIN
"RTN","PSODDPR7",16,0)
 N PSOCDRG,DRGDRG,STARTDTF,STOPDTF,ORDDATE,DNM,DUPRX0,PDRG,RXREC,RDIRX
"RTN","PSODDPR7",17,0)
 S SORT="PSOPEPS CLINIC"
"RTN","PSODDPR7",18,0)
 S (PSOCDRG,PSOCON,STATUS)=""
"RTN","PSODDPR7",19,0)
 Q:'$D(PSOCLNS(SV,ZVA))
"RTN","PSODDPR7",20,0)
 ;sort by status within drug name
"RTN","PSODDPR7",21,0)
 F  S PSOCDRG=$O(PSOCLNS(SV,ZVA,PSOCDRG)) Q:PSOCDRG=""  I DRG=PSOCDRG F  S PSOCON=$O(PSOCLNS(SV,ZVA,PSOCDRG,PSOCON)) Q:PSOCON=""  D
"RTN","PSODDPR7",22,0)
 .S (ORDID,PSOCLINI,FILENODE)="",DRGDRG=1,ORDID=$P(PSOCON,";",2),PSOCLINI=$P(^TMP($J,"PSOPEPS","IN","PROFILE",PSOCON),"^",7),FILENODE=$P(PSOCLINI,";")
"RTN","PSODDPR7",23,0)
 .I FILENODE=1 D PSS436^PSS55(PSODFN,ORDID,SORT) S:$D(^TMP($J,SORT,ORDID,100)) STATUS=$P(^TMP($J,SORT,ORDID,100),"^",2)
"RTN","PSODDPR7",24,0)
 .I FILENODE=2 D PSS431^PSS55(PSODFN,ORDID,"","",SORT) S:$D(^TMP($J,SORT,ORDID,28)) STATUS=$P(^TMP($J,SORT,ORDID,28),"^",2)
"RTN","PSODDPR7",25,0)
 .I FILENODE=3!(FILENODE=4)!(FILENODE=5) D PSJ^PSJ53P1(ORDID,SORT) S:$D(^TMP($J,SORT,ORDID,28)) STATUS=$P(^TMP($J,SORT,ORDID,28),"^",2)
"RTN","PSODDPR7",26,0)
 .I STATUS="" S STATUS="Z"
"RTN","PSODDPR7",27,0)
 .S PSOCLIN(SV,ZVA,$S(STATUS["ACTIVE":1,STATUS["NON-VERIFIED":2,STATUS["DISCONTINUED":3,STATUS["EXPIRE":4,1:5),PSOCON)=PSOCDRG
"RTN","PSODDPR7",28,0)
 Q:'$D(PSOCLIN(SV,ZVA))
"RTN","PSODDPR7",29,0)
 S (SORT2,ORDID,PSOCLINI,FILENODE,PSOCON)=""
"RTN","PSODDPR7",30,0)
 K ^TMP($J,SORT)
"RTN","PSODDPR7",31,0)
 F  S SORT2=$O(PSOCLIN(SV,ZVA,SORT2)) Q:SORT2=""  F  S PSOCON=$O(PSOCLIN(SV,ZVA,SORT2,PSOCON)) Q:PSOCON=""  D CLINIC
"RTN","PSODDPR7",32,0)
 Q
"RTN","PSODDPR7",33,0)
DUP ;
"RTN","PSODDPR7",34,0)
 ;Required:  ZCT =  Order identifier =  first ";" piece: I1 - IV order. I2 - UD order; second ";" piece: order id; example:  ON="C2;4;PROFILE;5"
"RTN","PSODDPR7",35,0)
 Q:ZCT=""
"RTN","PSODDPR7",36,0)
 N DRGNAME,STATUS,STARTDT,STOPDT,SCHEDULE,ORDID,DOSAGE,FILENODE,ADD,SOL,ADDNAM,SOLNAM,BOTTLE,STRENGTH,AFLG,ADDS,SOLUTION,VOLUME,IVDATA,SORT,INFUSE,SFLG,PSOCON
"RTN","PSODDPR7",37,0)
 N PSOCLINI,SORT2,PSOCLIN,DRGDRG,STARTDTF,STOPDTF,ORDDATE,DURATION
"RTN","PSODDPR7",38,0)
 S SORT="PSOPEPS CLINIC",DRGDRG=0
"RTN","PSODDPR7",39,0)
 S PSOCON=$P(ZCT,"^",3),DRGNAME=$P(ZCT,"^",2) D CLINIC
"RTN","PSODDPR7",40,0)
 Q
"RTN","PSODDPR7",41,0)
 ;
"RTN","PSODDPR7",42,0)
CLINIC ;
"RTN","PSODDPR7",43,0)
 K ^TMP($J,SORT)
"RTN","PSODDPR7",44,0)
 S (ORDID,PSOCLINI,FILENODE)="",ORDID=$P(PSOCON,";",2),PSOCLINI=$P(^TMP($J,"PSOPEPS","IN","PROFILE",PSOCON),"^",7)
"RTN","PSODDPR7",45,0)
 Q:'PSOCLINI
"RTN","PSODDPR7",46,0)
 S FILENODE=$P(PSOCLINI,";") I DRGDRG S DRGNAME=PSOCLIN(SV,ZVA,SORT2,PSOCON) I DRGNAME'="" S DRGDRG=0
"RTN","PSODDPR7",47,0)
 S (STATUS,SCHEDULE,DOSAGE,STARTDT,STOPDT,INFUSE,STARTDTF,STOPDTF,ORDDATE)=""
"RTN","PSODDPR7",48,0)
 D GETDATA
"RTN","PSODDPR7",49,0)
 K ^TMP($J,SORT)
"RTN","PSODDPR7",50,0)
 W !
"RTN","PSODDPR7",51,0)
 Q
"RTN","PSODDPR7",52,0)
GETDATA ;
"RTN","PSODDPR7",53,0)
 I FILENODE=1 D PSS436^PSS55(PSODFN,ORDID,SORT) D  Q  ;IV for file 55
"RTN","PSODDPR7",54,0)
 .I DRGDRG S DRGNAME=$P(^TMP($J,"PSOPEPS","IN","PROFILE",PSOCON),"^",4)
"RTN","PSODDPR7",55,0)
 .I $D(^TMP($J,SORT,ORDID,100)) S STATUS=$P(^TMP($J,SORT,ORDID,100),"^",2)
"RTN","PSODDPR7",56,0)
 .I $D(^TMP($J,SORT,ORDID,.09)) S SCHEDULE=^TMP($J,SORT,ORDID,.09)
"RTN","PSODDPR7",57,0)
 .I $D(^TMP($J,SORT,ORDID,109)) S DOSAGE=^TMP($J,SORT,6,109)
"RTN","PSODDPR7",58,0)
 .I $D(^TMP($J,SORT,ORDID,.02)) S STARTDT=$P(^TMP($J,SORT,ORDID,.02),"^",2)
"RTN","PSODDPR7",59,0)
 .I STARTDT="" S:$D(^TMP($J,SORT,ORDID,115)) STARTDT=$D(^TMP($J,SORT,ORDID,115)) S:STARTDT'="" STARTDTF=1
"RTN","PSODDPR7",60,0)
 .I $D(^TMP($J,SORT,ORDID,.03)) S STOPDT=$P(^TMP($J,SORT,ORDID,.03),"^",2)
"RTN","PSODDPR7",61,0)
 .S:$D(^TMP($J,SORT,ORDID,27)) ORDDATE=^TMP($J,SORT,ORDID,27)
"RTN","PSODDPR7",62,0)
 .I STOPDT="" S:$D(^TMP($J,SORT,ORDID,117)) STARTDT=$D(^TMP($J,SORT,ORDID,117)) S:STOPDT'="" STOPDTF=1
"RTN","PSODDPR7",63,0)
 .I $D(^TMP($J,SORT,ORDID,.08)) S INFUSE=^TMP($J,SORT,ORDID,.08)
"RTN","PSODDPR7",64,0)
 .D WRITE
"RTN","PSODDPR7",65,0)
 ;
"RTN","PSODDPR7",66,0)
 I FILENODE=2 D PSS431^PSS55(PSODFN,ORDID,"","",SORT) D  Q  ;Unit dose for file 55
"RTN","PSODDPR7",67,0)
 .I DRGDRG S DRGNAME=$P(^TMP($J,"PSOPEPS","IN","PROFILE",PSOCON),"^",4)
"RTN","PSODDPR7",68,0)
 .I $D(^TMP($J,SORT,ORDID,28)) S STATUS=$P(^TMP($J,SORT,ORDID,28),"^",2)
"RTN","PSODDPR7",69,0)
 .I $D(^TMP($J,SORT,ORDID,26)) S SCHEDULE=^TMP($J,SORT,ORDID,26)
"RTN","PSODDPR7",70,0)
 .I $D(^TMP($J,SORT,ORDID,109)) S DOSAGE=^TMP($J,SORT,ORDID,109)
"RTN","PSODDPR7",71,0)
 .I $D(^TMP($J,SORT,ORDID,10)) S STARTDT=$P(^TMP($J,SORT,ORDID,10),"^",2)
"RTN","PSODDPR7",72,0)
 .I $D(^TMP($J,SORT,ORDID,34)) S STOPDT=$P(^TMP($J,SORT,ORDID,34),"^",2)
"RTN","PSODDPR7",73,0)
 .I $D(^TMP($J,SORT,ORDID,.08)) S INFUSE=^TMP($J,SORT,ORDID,.08)
"RTN","PSODDPR7",74,0)
 .D WRITE
"RTN","PSODDPR7",75,0)
 ;
"RTN","PSODDPR7",76,0)
 I FILENODE=3!(FILENODE=4)!(FILENODE=5) D  Q  ;unit dose for file 53.1
"RTN","PSODDPR7",77,0)
 .D PSJ^PSJ53P1(ORDID,SORT)
"RTN","PSODDPR7",78,0)
 .I DRGDRG,$D(^TMP($J,SORT,ORDID,108)) S DRGNAME=$P(^TMP($J,SORT,ORDID,108),"^",2)
"RTN","PSODDPR7",79,0)
 .I $D(^TMP($J,SORT,ORDID,28)) S STATUS=$P(^TMP($J,SORT,ORDID,28),"^",2)
"RTN","PSODDPR7",80,0)
 .I $D(^TMP($J,SORT,ORDID,26)) S SCHEDULE=$P(^TMP($J,SORT,ORDID,26),"^",2)
"RTN","PSODDPR7",81,0)
 .I $D(^TMP($J,SORT,ORDID,27)) S ORDDATE=^TMP($J,SORT,ORDID,27) S Y=ORDDATE D DD^%DT S ORDDATE=Y K Y
"RTN","PSODDPR7",82,0)
 .I $D(^TMP($J,SORT,ORDID,109)) S DOSAGE=^TMP($J,SORT,ORDID,109)
"RTN","PSODDPR7",83,0)
 .I $D(^TMP($J,SORT,ORDID,10)) S STARTDT=$P(^TMP($J,SORT,ORDID,10),"^",2)
"RTN","PSODDPR7",84,0)
 .I STARTDT="",$D(^TMP($J,SORT,ORDID,115)) S STARTDT=$P(^TMP($J,SORT,ORDID,115),"^",2) S:STARTDT'="" STARTDTF=1
"RTN","PSODDPR7",85,0)
 .I $D(^TMP($J,SORT,ORDID,25)) S STOPDT=$P(^TMP($J,SORT,ORDID,25),"^",2)
"RTN","PSODDPR7",86,0)
 .I $D(^TMP($J,SORT,ORDID,117))&(STOPDT="") S STOPDT=$P(^TMP($J,SORT,ORDID,117),"^",2)  S:STOPDT'="" STOPDTF=1
"RTN","PSODDPR7",87,0)
 .I $D(^TMP($J,SORT,ORDID,116)) S DURATION=^TMP($J,SORT,ORDID,116)
"RTN","PSODDPR7",88,0)
 .D WRITE
"RTN","PSODDPR7",89,0)
 Q
"RTN","PSODDPR7",90,0)
 ;
"RTN","PSODDPR7",91,0)
WRITE ;
"RTN","PSODDPR7",92,0)
 D HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR7",93,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Clinic Order: ",23)_DRGNAME_" ("_STATUS_")"
"RTN","PSODDPR7",94,0)
 I $D(^TMP($J,SORT,ORDID,"ADD")) D:FILENODE=1 IV55 D:FILENODE=3 IV531
"RTN","PSODDPR7",95,0)
 I SCHEDULE'="" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Schedule: ",23),SCHEDULE
"RTN","PSODDPR7",96,0)
 I DOSAGE'="" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Dosage: ",23),DOSAGE
"RTN","PSODDPR7",97,0)
 I STARTDT=""&(ORDDATE'="")  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Order Date: ",23),ORDDATE
"RTN","PSODDPR7",98,0)
 I STARTDT'="" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J($S($G(STARTDTF):"Requested Start Date: ",1:"Start Date: "),23),STARTDT
"RTN","PSODDPR7",99,0)
 E  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Start Date: ",23),"********"
"RTN","PSODDPR7",100,0)
 I STOPDT'="" S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J($S($G(STOPDTF):"Requested Stop Date: ",1:"Stop Date: "),23),STOPDT
"RTN","PSODDPR7",101,0)
 E  S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J("Stop Date: ",23),"********"
"RTN","PSODDPR7",102,0)
WRITE2 ;
"RTN","PSODDPR7",103,0)
 I '$G(PSODUPF) D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSODDPR7",104,0)
 Q 
"RTN","PSODDPR7",105,0)
 ; 
"RTN","PSODDPR7",106,0)
IMO(DFN) ;Inpatient Meds ordered in outpatient pharmacy (IMO) - determine IMO drugs to be added to the profile drugs submitted to FDB.
"RTN","PSODDPR7",107,0)
 ;         In: DFN - Patient IED
"RTN","PSODDPR7",108,0)
 ; Output: ^TMP( file of inpatient meds drugs; example of each type of order:
"RTN","PSODDPR7",109,0)
 ;                 ^TMP(540771229,"PSOPEPS","IN","PROFILE","C2;6;PROFILE;6")="16579^4010153^65^SIMVASTATIN 40MG TAB^10711^I"
"RTN","PSODDPR7",110,0)
 ;                 ^TMP(540771229,"PSOPEPS","IN","PROFILE","C4;1597;PROFILE;7")="11664^4006819^1848^CIMETIDINE 300MG/5ML SOL (OZ)^10746^I"
"RTN","PSODDPR7",111,0)
 ;
"RTN","PSODDPR7",112,0)
 ;              The first piece of the 5th subscript denotes the type of order (ex: C2 and C4 in the example above).  
"RTN","PSODDPR7",113,0)
 ;               When adding clinic orders, this piece is always "C" concatenated with an number 1-4 where 1 means UD file 55, 2 means IV file 55, 3 means UD file 53.1 or 4 means IV for file 53.1. 
"RTN","PSODDPR7",114,0)
 ;               For clinic orders, the 2nd piece of the 5th subscript is the subfile IEN.
"RTN","PSODDPR7",115,0)
 ;
"RTN","PSODDPR7",116,0)
 D IN^PSJBLDOC(DFN,LIST,.PDRG,"O;")
"RTN","PSODDPR7",117,0)
 Q
"RTN","PSODDPR7",118,0)
 ;
"RTN","PSODDPR7",119,0)
IV55 ;
"RTN","PSODDPR7",120,0)
 I '$G(PSODUPF) D HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR7",121,0)
 S (ADD,SOL,AFLG)=0
"RTN","PSODDPR7",122,0)
 ;W:'$G(AFLG) !,$J("Other Additives: ",23)
"RTN","PSODDPR7",123,0)
 F  S ADD=$O(^TMP($J,SORT,ORDID,"ADD",ADD)) Q:ADD=""  D
"RTN","PSODDPR7",124,0)
 .I $D(^TMP($J,SORT,ORDID,"ADD",ADD,.01)) S ADDNAM=$P(^TMP($J,SORT,ORDID,"ADD",ADD,.01),"^",2)
"RTN","PSODDPR7",125,0)
 .Q:DRGNAME[(ADDNAM_" "_^TMP($J,SORT,ORDID,"ADD",ADD,.02))
"RTN","PSODDPR7",126,0)
 .S (BOTTLE,STRENGTH)=""
"RTN","PSODDPR7",127,0)
 .I $D(^TMP($J,SORT,ORDID,"ADD",ADD,.03)) S BOTTLE=^TMP($J,SORT,ORDID,"ADD",ADD,.03)
"RTN","PSODDPR7",128,0)
 .I $D(^TMP($J,SORT,ORDID,"ADD",ADD,.02)) S STRENGTH=^TMP($J,SORT,ORDID,"ADD",ADD,.02)
"RTN","PSODDPR7",129,0)
 .I '$G(AFLG) S ADDS=ADDNAM_" "_STRENGTH S:BOTTLE'="" ADDS=ADDS_" ("_BOTTLE_")"
"RTN","PSODDPR7",130,0)
 .I $G(AFLG) S ADDS=ADDS_", "_ADDNAM_" "_STRENGTH S:BOTTLE'="" ADDS=ADDS_" ("_BOTTLE_")"
"RTN","PSODDPR7",131,0)
 .S:'$G(AFLG) AFLG=1
"RTN","PSODDPR7",132,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1
"RTN","PSODDPR7",133,0)
 I '$G(PSODUPF) D HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR7",134,0)
 I $G(AFLG),'$G(PSODUPF) W !,$J("Other Additives: ",23) D MYWRITE(ADDS,23,78)
"RTN","PSODDPR7",135,0)
 F  S SOL=$O(^TMP($J,SORT,ORDID,"SOL",SOL)) Q:SOL=""  D
"RTN","PSODDPR7",136,0)
 .S (SOLUTION,VOLUME)=""
"RTN","PSODDPR7",137,0)
 .I $D(^TMP($J,SORT,ORDID,"SOL",SOL,.01)) S SOLUTION=$P(^TMP($J,SORT,ORDID,"SOL",SOL,.01),"^",2)
"RTN","PSODDPR7",138,0)
 .I $D(^TMP($J,SORT,ORDID,"SOL",SOL,1)) S VOLUME=^TMP($J,SORT,ORDID,"SOL",SOL,1)
"RTN","PSODDPR7",139,0)
 .I '$G(PSODUPF) D HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR7",140,0)
 .W:'$G(SFLG)&'$G(PSODUPF) !,$J("Solution(s): ",23)_SOLUTION_" "_VOLUME_" "_INFUSE
"RTN","PSODDPR7",141,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1
"RTN","PSODDPR7",142,0)
 .I $G(SFLG),'$G(PSODUPF) W !?23,SOLUTION_" "_VOLUME_" "_INFUSE
"RTN","PSODDPR7",143,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1
"RTN","PSODDPR7",144,0)
 .S SFLG=1
"RTN","PSODDPR7",145,0)
 Q
"RTN","PSODDPR7",146,0)
 ;
"RTN","PSODDPR7",147,0)
IV531 ;
"RTN","PSODDPR7",148,0)
 I '$G(PSODUPF) D HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR7",149,0)
 S (ADD,SOL,AFLG,SFLG)=0
"RTN","PSODDPR7",150,0)
 F  S ADD=$O(^TMP($J,SORT,ORDID,"ADD",ADD)) Q:ADD=""  D
"RTN","PSODDPR7",151,0)
 .S (BOTTLE,STRENGTH,IVDATA)="",IVDATA=^TMP($J,SORT,ORDID,"ADD",ADD)
"RTN","PSODDPR7",152,0)
 .S BOTTLE=$P(IVDATA,"^",3),STRENGTH=$P(IVDATA,"^",2),ADDNAM=$P(IVDATA,"^")
"RTN","PSODDPR7",153,0)
 .I $D(^TMP($J,SORT,ORDID,"ADD",ADD+1)) Q:DRGNAME[(ADDNAM_" "_STRENGTH)
"RTN","PSODDPR7",154,0)
 .I '$G(AFLG) S ADDS=ADDNAM_" "_STRENGTH S:BOTTLE'="" ADDS=ADDS_" ("_BOTTLE_")"
"RTN","PSODDPR7",155,0)
 .I $G(AFLG) S ADDS=ADDS_", "_ADDNAM_" "_STRENGTH S:BOTTLE'="" ADDS=ADDS_" ("_BOTTLE_")"
"RTN","PSODDPR7",156,0)
 .S:'$G(AFLG) AFLG=1
"RTN","PSODDPR7",157,0)
 S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1
"RTN","PSODDPR7",158,0)
 I '$G(PSODUPF) D HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR7",159,0)
 I $G(AFLG),'$G(PSODUPF)  W !,$J("Other Additives: ",23) D MYWRITE(ADDS,23,78)
"RTN","PSODDPR7",160,0)
 F  S SOL=$O(^TMP($J,SORT,ORDID,"SOL",SOL)) Q:SOL=""  D
"RTN","PSODDPR7",161,0)
 .S (SOLUTION,VOLUME)=""
"RTN","PSODDPR7",162,0)
 .S (SOLUTION,VOLUME,IVDATA)="",IVDATA=^TMP($J,SORT,ORDID,"SOL",SOL)
"RTN","PSODDPR7",163,0)
 .S VOLUME=$P(IVDATA,"^",2),SOLUTION=$P(IVDATA,"^")
"RTN","PSODDPR7",164,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1
"RTN","PSODDPR7",165,0)
 .W:'$G(SFLG)&'$G(PSODUPF) !,$J("Solution(s): ",23)_SOLUTION_" "_VOLUME_" "_INFUSE
"RTN","PSODDPR7",166,0)
 .I $G(SFLG),'$G(PSODUPF)  W !?23,SOLUTION_" "_VOLUME_" "_INFUSE
"RTN","PSODDPR7",167,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1
"RTN","PSODDPR7",168,0)
 .S SFLG=1
"RTN","PSODDPR7",169,0)
 I '$G(PSODUPF) D HD^PSODDPR2() Q:$G(PSODLQT)
"RTN","PSODDPR7",170,0)
 Q
"RTN","PSODDPR7",171,0)
 ;
"RTN","PSODDPR7",172,0)
MYWRITE(X,DIWL,DIWR) ;Continue writing on the same line
"RTN","PSODDPR7",173,0)
 NEW DN,PSOCNT
"RTN","PSODDPR7",174,0)
 I '$G(DIWL) S DIWL=1
"RTN","PSODDPR7",175,0)
 I '$G(DIWR) S DIWR=75
"RTN","PSODDPR7",176,0)
 K ^UTILITY($J,"W") D ^DIWP
"RTN","PSODDPR7",177,0)
 F PSOCNT=0:0 S PSOCNT=$O(^UTILITY($J,"W",DIWL,PSOCNT)) Q:'PSOCNT  W:PSOCNT'=1 ! W ?DIWL,^UTILITY($J,"W",DIWL,PSOCNT,0)
"RTN","PSODDPR7",178,0)
 Q
"RTN","PSODDPR7",179,0)
NOCAN ;shows duplicate therapeutic when cancel duplicate class parameter is set to 'no'
"RTN","PSODDPR7",180,0)
 K ^UTILITY($J,"W"),DDTH,DOCPL,DIWF S DIWL=1,DIWR=78,DIWF=""
"RTN","PSODDPR7",181,0)
 N DUPCPF,PSODUPT,ZZOCTD,CLINTYP,CT,SUB,ZZOC S ZZOCTD=0
"RTN","PSODDPR7",182,0)
 S (CT,SUB,ZZOC)=0 K TCT,TCTP,TCTL,TCTI,ZZQ,ZHDR ;PSO*7*411
"RTN","PSODDPR7",183,0)
 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D
"RTN","PSODDPR7",184,0)
 .S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^"),PDRG=$P(^(SUB),"^",3),RXREC=$P(ON,";",2)
"RTN","PSODDPR7",185,0)
 .I $G(PSODCTH(ON)) Q
"RTN","PSODDPR7",186,0)
 .I $P(ON,";")="Z" Q
"RTN","PSODDPR7",187,0)
 .I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR7",188,0)
 .I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR7",189,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR7",190,0)
 .I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR7",191,0)
 .I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR7",192,0)
 .I '$G(ZHDR) D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  W !,PSONULN,!,"*** THERAPEUTIC DUPLICATION(S) *** "_PSODRUG("NAME")_" with",! S ZHDR=1
"RTN","PSODDPR7",193,0)
 Q:'$G(ZHDR)  Q:$G(PSODLQT)
"RTN","PSODDPR7",194,0)
 N ST,STA,STAT,ORT,CT K DOCPL
"RTN","PSODDPR7",195,0)
 S (SUB,CT)=0 F  S CT=$O(^TMP($J,LIST,"OUT","THERAPY",CT)) Q:'CT  F  S SUB=$O(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB)) Q:'SUB  D DUPCL K DDTH
"RTN","PSODDPR7",196,0)
 D DUPCP
"RTN","PSODDPR7",197,0)
 S:$D(ZPSODCTH) ^TMP("PSODAOC",$J,"DT","T","A",50,PSODRUG("IEN"),0)=""
"RTN","PSODDPR7",198,0)
 Q
"RTN","PSODDPR7",199,0)
DUPCL ;
"RTN","PSODDPR7",200,0)
 S ON=$P(^TMP($J,LIST,"OUT","THERAPY",CT,"DRUGS",SUB),"^"),PDRG=$P(^(SUB),"^",3),RXREC=$P(ON,";",2)
"RTN","PSODDPR7",201,0)
 I $P(ON,";")="Z" Q
"RTN","PSODDPR7",202,0)
 I $P(ON,";")="N",$G(^TMP($J,"PSONVADD",RXREC,0)) Q
"RTN","PSODDPR7",203,0)
 I $P(ON,";")="R",$G(^TMP($J,"PSORMDD",RXREC,0)) Q
"RTN","PSODDPR7",204,0)
 I $P(ON,";")="O",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR7",205,0)
 I $P(ON,";")="P",$G(^TMP("PSORXDC",$J,RXREC,0)) Q
"RTN","PSODDPR7",206,0)
 I $P(ON,";")="O",$G(^TMP("PSORXDD",$J,RXREC,0)) Q
"RTN","PSODDPR7",207,0)
 S ORT=$S($P(ON,";")="N":4,$P(ON,";")="P":3,$P(ON,";")="R":2,1:1)
"RTN","PSODDPR7",208,0)
 S DOCPL(ORT,ON)=""
"RTN","PSODDPR7",209,0)
 Q
"RTN","PSODDPR7",210,0)
 ;
"RTN","PSODDPR7",211,0)
DUPCP D HD^PSODDPR2():(($Y+5)'>IOSL) S ORT=0,ON=""  F  S ORT=$O(DOCPL(ORT)) Q:'ORT!$G(PSODLQT)  F  S ON=$O(DOCPL(ORT,ON)) Q:ON=""!$G(PSODLQT)  D
"RTN","PSODDPR7",212,0)
 .S PSODUPT=""
"RTN","PSODDPR7",213,0)
 .I $P(ON,";")="O" S PSODUPT="O" D
"RTN","PSODDPR7",214,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  S ST=$P(^PSRX($P(ON,";",2),"STA"),"^")+1
"RTN","PSODDPR7",215,0)
 ..S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^^EXPIRED^DISCONTINUED^^DISCONTINUED BY PROVIDER^DISCONTINUE EDIT^PROVIDER HOLD"
"RTN","PSODDPR7",216,0)
 ..S STAT=$P(STA,"^",ST) W !?2,"Local Rx #"_$P(^PSRX($P(ON,";",2),0),"^")_" ("_STAT_") for "_$P(^PSDRUG($P(^PSRX($P(ON,";",2),0),"^",6),0),"^")
"RTN","PSODDPR7",217,0)
 .I $P(ON,";")="P" S PSODUPT="P" D
"RTN","PSODDPR7",218,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR7",219,0)
 ..S RXREC=$P(ON,";",2),DNM=$P(^PS(52.41,RXREC,0),"^",9)
"RTN","PSODDPR7",220,0)
 ..S DUPRX0=^PS(52.41,RXREC,0)
"RTN","PSODDPR7",221,0)
 ..W !?2,"Pending Order for "
"RTN","PSODDPR7",222,0)
 ..I '$P(DUPRX0,"^",9) W $P(^PS(50.7,$P(DUPRX0,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR7",223,0)
 ..E  W $P(^PSDRUG($P(DUPRX0,"^",9),0),"^")
"RTN","PSODDPR7",224,0)
 .I $P(ON,";")="R" S PSODUPT="R" N RXDAT D
"RTN","PSODDPR7",225,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR7",226,0)
 ..S RXDAT=^TMP($J,LIST,"OUT","REMOTE",$P(ON,";",2))
"RTN","PSODDPR7",227,0)
 ..S RDIRX=$P(RXDAT,"^",5) D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)  W !?2,"Remote Rx #"_RDIRX_" ("_$P(RXDAT,"^",4)_") for "_$P(RXDAT,"^",3)
"RTN","PSODDPR7",228,0)
 .I $P(ON,";")="N" S PSODUPT="N" D
"RTN","PSODDPR7",229,0)
 ..Q:'$D(^PS(55,PSODFN,"NVA",$P(ON,";",2),0))
"RTN","PSODDPR7",230,0)
 ..S DUPRX0=^PS(55,PSODFN,"NVA",$P(ON,";",2),0) N NVAQ
"RTN","PSODDPR7",231,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR7",232,0)
 ..W !?2,"Non-VA Med for "
"RTN","PSODDPR7",233,0)
 ..I '$P(DUPRX0,"^",2) W $P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPR7",234,0)
 ..E  W $P(^PSDRUG($P(DUPRX0,"^",2),0),"^")
"RTN","PSODDPR7",235,0)
 .I $P(ON,";")["C" S PSODUPT="C" D
"RTN","PSODDPR7",236,0)
 ..;CLINIC ORDERS ;1=55V,2=55U,3=531I,4=531U,5=531I
"RTN","PSODDPR7",237,0)
 ..N DRGNAME S DRGNAME=$P($G(^TMP($J,LIST,"IN","PROFILE",ON)),"^",4)
"RTN","PSODDPR7",238,0)
 ..S (PSOCON,ORDID,ZCT,CLINTYP)=ON,DRGDRG=0,DUPCPF=1,SORT="PSOPEPS CLINIC" D CLINIC
"RTN","PSODDPR7",239,0)
 ..S CLINTYP=$P(^TMP($J,"PSOPEPS","IN","PROFILE",ON),"^",7)
"RTN","PSODDPR7",240,0)
 ..S ZZOCTD=ZZOCTD+1,ZPSODCTH(ON)=$S($P(CLINTYP,";")[1:"V",$P(CLINTYP,";")[3!($P(CLINTYP,";")[4)!(($P(CLINTYP,";")[5)):$E($P(ON,";",1),2)_";PS(53.1",1:"U")_";"_$P(ON,";",2)
"RTN","PSODDPR7",241,0)
 ..S ^TMP("PSODAOC",$J,"DT","T","A",70,ZZOCTD,0)=ZPSODCTH(ON)
"RTN","PSODDPR7",242,0)
 ..;S ^TMP("PSODAOC",$J,"DT","T","A",70,"ADDITIVE",ZPSODCTH(ON),
"RTN","PSODDPR7",243,0)
 .S DDTH(ON)=1
"RTN","PSODDPR7",244,0)
 .I PSODUPT="R" S ZZOCTD=ZZOCTD+1,ZPSODCTH(ON)="R;"_$P(ON,";",2) S ^TMP("PSODAOC",$J,"DT","T","A",70,ZZOCTD,0)=ZPSODCTH(ON)
"RTN","PSODDPR7",245,0)
 .I PSODUPT="N" S ZZOCTD=ZZOCTD+1,ZPSODCTH(ON)="N;"_$P(ON,";",2) S ^TMP("PSODAOC",$J,"DT","T","A",70,ZZOCTD,0)=ZPSODCTH(ON)
"RTN","PSODDPR7",246,0)
 .I PSODUPT="P" S ZZOCTD=ZZOCTD+1,ZPSODCTH(ON)=$P(ON,";",2)_";PS(52.41" S ^TMP("PSODAOC",$J,"DT","T","A",60,ZZOCTD,0)=ZPSODCTH(ON)
"RTN","PSODDPR7",247,0)
 .I PSODUPT="O" S ZZOCTD=ZZOCTD+1,ZPSODCTH(ON)=$P(ON,";",2)_";PSRX(" S ^TMP("PSODAOC",$J,"DT","T","A",60,ZZOCTD,0)=ZPSODCTH(ON)
"RTN","PSODDPR7",248,0)
 .S:$D(ZPSODCTH) ^TMP("PSODAOC",$J,"DT","T","A",50,PSODRUG("IEN"),0)=""
"RTN","PSODDPR7",249,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPR7",250,0)
 D CLASSES^PSODDPR3
"RTN","PSODDPR7",251,0)
 N X,ZZCT S (ZCT,ZZCT)=0
"RTN","PSODDPR7",252,0)
 F  S ZZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT)) Q:'ZZCT  S ZCT=0 F  S ZCT=$O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT)) Q:'ZCT  D
"RTN","PSODDPR7",253,0)
 .S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")
"RTN","PSODDPR7",254,0)
 .S X=^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT,"CLASS")_$S($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT))!($O(^TMP($J,LIST,"OUT","THERAPY",ZZCT,ZCT))):", ",1:"")
"RTN","PSODDPR7",255,0)
 .I $G(X)]"" S ^TMP("PSODAOC",$J,"DT","T","A","CL",ZZCT,0)=X
"RTN","PSODDPR7",256,0)
 D HD^PSODDPR2(0,1) Q:$G(PSODLQT)
"RTN","PSODDPR7",257,0)
 Q
"RTN","PSODDPRE")
0^11^B139774341
"RTN","PSODDPRE",1,0)
PSODDPRE ; BIR/SAB - Enhanced OP order checks ;09/20/06 3:38pm
"RTN","PSODDPRE",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,375,387,379,390,372,416,411**;DEC 1997;Build 95
"RTN","PSODDPRE",3,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSODDPRE",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODDPRE",5,0)
 ;External reference to ^PSSDSAPM supported by DBIA 5570
"RTN","PSODDPRE",6,0)
 ;External reference to ^PSSHRQ2 supported by DBIA 5369
"RTN","PSODDPRE",7,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODDPRE",8,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODDPRE",9,0)
 ;External reference to ^PSDRUG( supported by DBIA 4846
"RTN","PSODDPRE",10,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSODDPRE",11,0)
 ;External reference to $$SUP^PSSDSAPI supported by DBIA 5425
"RTN","PSODDPRE",12,0)
 ;External reference to ^PSSDIUTL supported by DBIA 5737
"RTN","PSODDPRE",13,0)
 ;
"RTN","PSODDPRE",14,0)
 W @IOF
"RTN","PSODDPRE",15,0)
 K IT,^TMP("PSORXDC",$J),^TMP("PSORXDD",$J),CLS,^TMP($J,"PSONVADD"),^TMP($J,"PSONRVADD"),^TMP($J,"PSORDI"),^TMP($J,"PSORMDD")
"RTN","PSODDPRE",16,0)
 N PSONULN,PSODLQT,ZZPSODRG S LIST="PSOPEPS",$P(PSONULN,"-",79)="-",(STA,DNM)=""
"RTN","PSODDPRE",17,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",18,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""!$G(PSORX("DFLG"))  I $P(PSOSD(STA,DNM),"^")'=$G(PSORENW("OIRXN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",19,0)
 .I STA="PENDING" D ^PSODDPR1 Q
"RTN","PSODDPRE",20,0)
 .I STA="ZNONVA" D NVA^PSODDPR1 Q
"RTN","PSODDPRE",21,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",22,0)
 ..I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16) D DUP I $G(PSOTECCK) S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",23,0)
 ..I '$P(PSOPAR,"^",2),$P(PSOPAR,"^",16),$G(PSOTECCK) D DUP Q
"RTN","PSODDPRE",24,0)
 ..I $P(PSOPAR,"^",2),$G(PSOTECCK) D  Q
"RTN","PSODDPRE",25,0)
 ...S DA=+PSOSD(STA,DNM),PSOCLC=DUZ
"RTN","PSODDPRE",26,0)
 ...S MSG="Discontinued During Reinstating Prescription Entry",ACT="Discontinued during Rx Reinstate."
"RTN","PSODDPRE",27,0)
 ...S ^TMP("PSORXDC",$J,DA,0)="52^"_DA_"^"_MSG_"^C^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D",^TMP("PSORXDD",$J)=DNM
"RTN","PSODDPRE",28,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q
"RTN","PSODDPRE",29,0)
 ..I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16) D DUP S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",30,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP
"RTN","PSODDPRE",31,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"PSODRDI")
"RTN","PSODDPRE",32,0)
 Q:$G(PSORX("DFLG"))
"RTN","PSODDPRE",33,0)
 M ZZPSODRG=PSODRUG
"RTN","PSODDPRE",34,0)
 S LIST="PSOPEPS" D REMOTE^PSOCPPRE
"RTN","PSODDPRE",35,0)
 M PSODRUG=ZZPSODRG
"RTN","PSODDPRE",36,0)
 Q
"RTN","PSODDPRE",37,0)
OBX  ;process enhanced order checks
"RTN","PSODDPRE",38,0)
 Q:$G(PSOQUIT)!($G(PSORX("DFLG")))
"RTN","PSODDPRE",39,0)
 K ZDGDG,ZTHER,IT
"RTN","PSODDPRE",40,0)
 S LIST="PSOPEPS" K PSODLQT,DTOUT,DUOUT,DIRUT,PSODOSD
"RTN","PSODDPRE",41,0)
 I $P(^TMP($J,LIST,"OUT",0),"^")=-1 G EXIT
"RTN","PSODDPRE",42,0)
 W !,"Now Processing Enhanced Order Checks!  Please wait...",! H 2
"RTN","PSODDPRE",43,0)
 D FDB S PDRG=PSODRUG("IEN"),DO=0 D IN^PSSHRQ2(LIST)    ;call 2 fdb
"RTN","PSODDPRE",44,0)
 ;
"RTN","PSODDPRE",45,0)
 K DIR
"RTN","PSODDPRE",46,0)
 I $P(^TMP($J,LIST,"OUT",0),"^")=-1 D DATACK G EXIT
"RTN","PSODDPRE",47,0)
 I '$D(PSODGCK) D ^PSODDPR2 ;if order checks returned
"RTN","PSODDPRE",48,0)
 I $D(PSODGCK) D PROC^PSSDIUTL Q  ;if running DX option
"RTN","PSODDPRE",49,0)
 I '$G(PSOCOPY)&('$G(PSORENW)),$G(PSOQUIT) D
"RTN","PSODDPRE",50,0)
 .I $G(PSOREINS) Q:$G(PSODLQT)  S PSORX("DFLG")=1
"RTN","PSODDPRE",51,0)
 ;
"RTN","PSODDPRE",52,0)
EXIT ;
"RTN","PSODDPRE",53,0)
 D ^PSOBUILD
"RTN","PSODDPRE",54,0)
 K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSODDPRE",55,0)
 K DO,PDRG,IT,PSODLQT,PSOTSTMD
"RTN","PSODDPRE",56,0)
 K ^TMP($J,LIST,"IN","PING"),^TMP($J,LIST,"OUT","EXCEPTIONS"),^TMP($J,"PSOPEPS"),^TMP($J,"PSORDI")
"RTN","PSODDPRE",57,0)
 Q
"RTN","PSODDPRE",58,0)
DUP S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"Duplicate Drug in Local Rx:",!
"RTN","PSODDPRE",59,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Drug"
"RTN","PSODDPRE",60,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODDPRE",61,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODDPRE",62,0)
 S DA=RXREC
"RTN","PSODDPRE",63,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",64,0)
 W !,$J("Rx: ",24)_$P(^PSRX(+PSOSD(STA,DNM),0),"^")
"RTN","PSODDPRE",65,0)
 W !,$J("Drug: ",24)_$P(DNM,"^")
"RTN","PSODDPRE",66,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODDPRE",67,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSODDPRE",68,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSODDPRE",69,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSODDPRE",70,0)
 K BSIG,PSREV
"RTN","PSODDPRE",71,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",72,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?42,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSODDPRE",73,0)
 S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSODDPRE",74,0)
 W !,$J("Provider: ",24)_PHYS,?42,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSODDPRE",75,0)
 W !,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2
"RTN","PSODDPRE",76,0)
 S LSTFL=+^PSRX(RXREC,3) W ?42,$J("Last filled: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3)
"RTN","PSODDPRE",77,0)
 D PRSTAT(RXREC)
"RTN","PSODDPRE",78,0)
 W !?42,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSODDPRE",79,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODDPRE",80,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 D  Q  ;PSO*7*411 to comment
"RTN","PSODDPRE",81,0)
 .K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue"
"RTN","PSODDPRE",82,0)
 .D ^DIR S:($D(DTOUT))!($D(DUOUT)) (PSODLQT,PSORX("DFLG"))=1 K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC W @IOF
"RTN","PSODDPRE",83,0)
 .S ^TMP("PSORXDD",$J,RXREC,0)=1
"RTN","PSODDPRE",84,0)
 ;
"RTN","PSODDPRE",85,0)
 I '$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)) D  Q
"RTN","PSODDPRE",86,0)
 .S PSORX("DFLG")=1 K RXRECLOC,DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue"
"RTN","PSODDPRE",87,0)
 .D ^DIR K DIR
"RTN","PSODDPRE",88,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) D  Q
"RTN","PSODDPRE",89,0)
 .W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",!
"RTN","PSODDPRE",90,0)
 .K DUP,DIR,RXRECLOC S PSORX("DFLG")=1 S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODDPRE",91,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODDPRE",92,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODDPRE",93,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECLOC,0)),"^"),!
"RTN","PSODDPRE",94,0)
 I $D(PSODGCK) K RXRECLOC,DUP,CLS,PSONOOR Q
"RTN","PSODDPRE",95,0)
 K PSOMSG S DIR("A")=$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" "_$P(DNM,"^")_" Y/N",DIR(0)="Y"
"RTN","PSODDPRE",96,0)
 S DIR("?")="Enter Y to "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODDPRE",97,0)
 D ^DIR K DIR S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODDPRE",98,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODDPRE",99,0)
 I 'Y W !,$C(7)," -Prescription was not "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODDPRE",100,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP D ULRX K RXRECLOC
"RTN","PSODDPRE",101,0)
 .K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODDPRE",102,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSODDPRE",103,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C")
"RTN","PSODDPRE",104,0)
 W !! K ^UTILITY($J,"W") S DIWL=1,DIWR=75,DIWF=""
"RTN","PSODDPRE",105,0)
 S X="Rx #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" "_DNM_" will be discontinued after"_$S('$G(PSOTECCK):" the acceptance of the new order.",1:" reinstating the order.") D ^DIWP
"RTN","PSODDPRE",106,0)
 N ZX F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W !,^UTILITY($J,"W",1,ZX,0)
"RTN","PSODDPRE",107,0)
 K ^UTILITY($J,"W"),X,DIWL,DIWR,DIWF W !
"RTN","PSODDPRE",108,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D",^TMP("PSORXDD",$J)=DNM H 2
"RTN","PSODDPRE",109,0)
 K RXRECLOC,DUP,CLS,PSONOOR
"RTN","PSODDPRE",110,0)
 Q
"RTN","PSODDPRE",111,0)
FDB ;build drug check input
"RTN","PSODDPRE",112,0)
 N ID,ORTYP,PSOI,ORN S DFN=PSODFN,CT=0
"RTN","PSODDPRE",113,0)
 S ID=+$$GETVUID^XTID(50.68,,+$P(PSODRUG("NDF"),"A",2)_",")
"RTN","PSODDPRE",114,0)
 S P1=$P(PSODRUG("NDF"),"A"),P2=$P(PSODRUG("NDF"),"A",2),X=$$PROD0^PSNAPIS(P1,P2),SEQN=+$P(X,"^",7)
"RTN","PSODDPRE",115,0)
 I 'SEQN K ^TMP($J,LIST,"OUT","EXCEPTIONS")
"RTN","PSODDPRE",116,0)
 S ^TMP($J,LIST,"IN","PROSPECTIVE","Z;1;PROSPECTIVE;1")=SEQN_"^"_ID_"^"_PSODRUG("IEN")_"^"_$P(^PSDRUG(PSODRUG("IEN"),0),"^")
"RTN","PSODDPRE",117,0)
 I $G(PSODGCKX) K ^TMP($J,LIST,"IN","PROSPECTIVE","Z;1;PROSPECTIVE;1")
"RTN","PSODDPRE",118,0)
 S ^TMP($J,LIST,"IN","IEN")=PSODFN,^TMP($J,LIST,"IN","DRUGDRUG")="",^TMP($J,LIST,"IN","THERAPY")=""
"RTN","PSODDPRE",119,0)
 K ID,P1,P2 N ODRG,TU S (STA,DNM)="" I '$G(PSOCOPY),'$G(SEQN),'$G(PSODGCK) K SEQN Q
"RTN","PSODDPRE",120,0)
 ;build profile drug order checks
"RTN","PSODDPRE",121,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""   D
"RTN","PSODDPRE",122,0)
 .Q:$P(PSOSD(STA,DNM),"^")=$G(PSORENW("OIRXN"))&('$G(PSOCOPY))
"RTN","PSODDPRE",123,0)
 .S CT=CT+1
"RTN","PSODDPRE",124,0)
 .I STA="PENDING" N DDRG D
"RTN","PSODDPRE",125,0)
 ..Q:$G(^TMP("PSORXDC",$J,$P(PSOSD(STA,DNM),"^",10),0))]""
"RTN","PSODDPRE",126,0)
 ..Q:$G(PSODRUG("IEN"))=$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",9)
"RTN","PSODDPRE",127,0)
 ..Q:$P(^PS(52.41,$P(PSOSD(STA,DNM),"^",10),0),"^",3)="RF"
"RTN","PSODDPRE",128,0)
 ..Q:$G(^TMP("PSORXPO",$J,$P(PSOSD(STA,DNM),"^",10),0))
"RTN","PSODDPRE",129,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ORN=$P(^PS(52.41,RXREC,0),"^"),ODRG=$P(^(0),"^",9),ORTYP="P"
"RTN","PSODDPRE",130,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPRE",131,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q 
"RTN","PSODDPRE",132,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") D ID
"RTN","PSODDPRE",133,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(52.41,RXREC,0),"^",8) D
"RTN","PSODDPRE",134,0)
 ...S PDNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPRE",135,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"O") I '$P(DDRG,";") D OIX Q
"RTN","PSODDPRE",136,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",137,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPRE",138,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",139,0)
 ...D ID1
"RTN","PSODDPRE",140,0)
 .I STA="ZNONVA" D  Q
"RTN","PSODDPRE",141,0)
 ..Q:$G(^TMP($J,"PSONVADD",$P(PSOSD(STA,DNM),"^",10),0))]""
"RTN","PSODDPRE",142,0)
 ..S RXREC=$P(PSOSD(STA,DNM),"^",10),ODRG=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^",2),ORN=$P(^(0),"^",8),ORTYP="N"
"RTN","PSODDPRE",143,0)
 ..I ODRG D  K ODRG Q
"RTN","PSODDPRE",144,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",145,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") S:CT=1&($G(PSODGCK))&('$G(PSODGCKX)) CT=2 D ID  ;CT=2 prevents overwrite of CK action drug prompt reply
"RTN","PSODDPRE",146,0)
 ..E  N PSOI,DDRG,ODRG,SEQN,DDRG S PSOI=$P(^PS(55,PSODFN,"NVA",RXREC,0),"^") D
"RTN","PSODDPRE",147,0)
 ...S PDNM=$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSODDPRE",148,0)
 ...S DDRG=$$DRG^PSSDSAPM(PSOI,"X") I '$P(DDRG,";") D:'$$NVATST(PSOI) OIX Q
"RTN","PSODDPRE",149,0)
 ...I $P($G(^PSDRUG($P(DDRG,";"),0)),"^",3)["S"!($E($P($G(^PSDRUG($P(DDRG,";"),0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",150,0)
 ...S ODRG=$P(DDRG,";"),SEQN=+$P(DDRG,";",3) K PSOI
"RTN","PSODDPRE",151,0)
 ...N ID S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",152,0)
 ...I CT=1,$G(PSODGCK),'$G(PSODGCKX) S CT=2  ;prevents overwrite of CK action drug prompt reply
"RTN","PSODDPRE",153,0)
 ...D ID1
"RTN","PSODDPRE",154,0)
 .I $P($G(^PSRX(+PSOSD(STA,DNM),0)),"^",6) D
"RTN","PSODDPRE",155,0)
 ..Q:$G(^TMP("PSORXDC",$J,$P(PSOSD(STA,DNM),"^"),0))]""
"RTN","PSODDPRE",156,0)
 ..Q:$G(^TMP("PSORXBO",$J,$P(PSOSD(STA,DNM),"^"),0))
"RTN","PSODDPRE",157,0)
 ..Q:$G(^TMP("PSORXDD",$J,$P(PSOSD(STA,DNM),"^"),0))
"RTN","PSODDPRE",158,0)
 ..;I $P(PSOSD(STA,DNM),"^",2)>5,$P(PSOSD(STA,DNM),"^",2)'=16 Q
"RTN","PSODDPRE",159,0)
 ..S RXREC=+PSOSD(STA,DNM),ODRG=$P(^PSRX(RXREC,0),"^",6),ORN=$P($G(^("OR1")),"^",2),ORTYP="O"
"RTN","PSODDPRE",160,0)
 ..I ODRG D
"RTN","PSODDPRE",161,0)
 ...I $P($G(^PSDRUG(ODRG,0)),"^",3)["S"!($E($P($G(^PSDRUG(ODRG,0)),"^",2),1,2)="XA") Q
"RTN","PSODDPRE",162,0)
 ...I STA="DISCONTINUED" Q:$$DUPTHER(RXREC)
"RTN","PSODDPRE",163,0)
 ...S PDNM=$P(^PSDRUG(ODRG,0),"^") D ID
"RTN","PSODDPRE",164,0)
 D IMO^PSODDPR7(PSODFN)
"RTN","PSODDPRE",165,0)
 K RXREC,ID,STA,DNM,PSOI,ORN,ODRG,ORTYP,CT,PDNM,TU,DDRG
"RTN","PSODDPRE",166,0)
 Q
"RTN","PSODDPRE",167,0)
 ;
"RTN","PSODDPRE",168,0)
ID N ID,P1,P2,PSODGCKP S ID=+$$GETVUID^XTID(50.68,,+$P($G(^PSDRUG(ODRG,"ND")),"^",3)_",")
"RTN","PSODDPRE",169,0)
 S P1=$P($G(^PSDRUG(ODRG,"ND")),"^"),P2=$P($G(^("ND")),"^",3),X=$$PROD0^PSNAPIS(P1,P2),SEQN=$P(X,"^",7)
"RTN","PSODDPRE",170,0)
ID1 S PSODGCKP=$S($G(PSODGCK):"PROSPECTIVE",1:"PROFILE")
"RTN","PSODDPRE",171,0)
 S ^TMP($J,LIST,"IN",PSODGCKP,$S($D(PSODGCK):"Z",1:ORTYP)_";"_RXREC_";"_PSODGCKP_";"_CT)=SEQN_"^"_ID_"^"_ODRG_"^"_PDNM_"^"_ORN_"^O" K ID
"RTN","PSODDPRE",172,0)
 Q
"RTN","PSODDPRE",173,0)
DUPTHER(RXREC) ;screen out discontinued/duplicate therapy Rx's greater than business rule calculation (cancel date + days supply +7 days)
"RTN","PSODDPRE",174,0)
 ;Note: If the dup allowance is 1 you have to have at least 3 eligible drug orders (or 2 matches) to produce the dupl. therapy warning
"RTN","PSODDPRE",175,0)
 ;Business rule for expired orders is (expiration date+120 days) which is the length of time expired order currently stay on med profile.  No changes for this.
"RTN","PSODDPRE",176,0)
 N X,Y,X1,X2 S X1=$P($G(^PSRX(RXREC,3)),"^",5),X2=(+$P(^PSRX(RXREC,0),"^",8)+7) D C^%DTC I DT>X Q 1
"RTN","PSODDPRE",177,0)
 Q 0
"RTN","PSODDPRE",178,0)
OIX S ^TMP($J,LIST,"IN","EXCEPTIONS","OI",PDNM)=1_"^"_ORTYP_";"_RXREC_";PROFILE;"_CT
"RTN","PSODDPRE",179,0)
 Q
"RTN","PSODDPRE",180,0)
ULRX ;
"RTN","PSODDPRE",181,0)
 I '$G(RXRECLOC) Q
"RTN","PSODDPRE",182,0)
 D PSOUL^PSSLOCK(RXRECLOC)
"RTN","PSODDPRE",183,0)
 Q
"RTN","PSODDPRE",184,0)
 ;
"RTN","PSODDPRE",185,0)
PRSTAT(DA) ;Displays the prescription's status
"RTN","PSODDPRE",186,0)
 N PSOTRANS,PSOREL,PSOCMOP,RXPSTA,PSOX,RFLZRO,PSOLRD,PSORTS,CMOP
"RTN","PSODDPRE",187,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)  ;PSO*7*411 to comment
"RTN","PSODDPRE",188,0)
 S RXPSTA="Processing Status: ",PSOLRD=$P($G(^PSRX(RXREC,2)),"^",13)
"RTN","PSODDPRE",189,0)
 ;
"RTN","PSODDPRE",190,0)
 D ^PSOCMOPA I $G(PSOCMOP)]"" D  K CMOP,PSOTRANS,PSOREL
"RTN","PSODDPRE",191,0)
 .S PSOTRANS=$E($P(PSOCMOP,"^",2),4,5)_"/"_$E($P(PSOCMOP,"^",2),6,7)_"/"_$E($P(PSOCMOP,"^",2),2,3)
"RTN","PSODDPRE",192,0)
 .S PSOREL=$S(CMOP("L")=0:$P($G(^PSRX(DA,2)),"^",13),1:$P(^PSRX(DA,1,CMOP("L"),0),"^",18))
"RTN","PSODDPRE",193,0)
 .S PSOREL=$E(PSOREL,4,5)_"/"_$E(PSOREL,6,7)_"/"_$E(PSOREL,2,3)_"@"_$E($P(PSOREL,".",2),1,4)
"RTN","PSODDPRE",194,0)
 .I '$D(IOINORM)!('$D(IOINHI)) S X="IORVOFF;IORVON;IOINHI;IOINORM" D ENDR^%ZISS
"RTN","PSODDPRE",195,0)
 .I $P($G(^PSRX(RXREC,"STA")),"^")=0 W:$$TRANCMOP^PSOUTL(RXREC) ?5,IORVON_IOINHI
"RTN","PSODDPRE",196,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J(RXPSTA,24)_$S($P(PSOCMOP,"^")=0!($P(PSOCMOP,"^")=2):"Transmitted to CMOP on "_PSOTRANS,$P(PSOCMOP,"^")=1:"Released by CMOP on "_PSOREL,1:"Not Dispensed"),IOINORM_IORVOFF
"RTN","PSODDPRE",197,0)
 D HD^PSODDPR2():(($Y+5)>IOSL) Q:$G(PSODLQT)
"RTN","PSODDPRE",198,0)
 I $G(PSOCMOP)']"" D
"RTN","PSODDPRE",199,0)
 .F PSOX=0:0 S PSOX=$O(^PSRX(RXREC,1,PSOX)) Q:'PSOX  D
"RTN","PSODDPRE",200,0)
 ..S RFLZRO=$G(^PSRX(RXREC,1,PSOX,0))
"RTN","PSODDPRE",201,0)
 ..S:$P(RFLZRO,"^",18)'="" PSOLRD=$P(RFLZRO,"^",18) I $P(RFLZRO,"^",16) S PSOLRD=PSOLRD_"^R",PSORTS=$P(RFLZRO,"^",16)
"RTN","PSODDPRE",202,0)
 .I '$O(^PSRX(RXREC,1,0)),$P(^PSRX(RXREC,2),"^",15) S PSOLRD=PSOLRD_"^R",PSORTS=$P(^PSRX(RXREC,2),"^",15)
"RTN","PSODDPRE",203,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) !,$J(RXPSTA,24)
"RTN","PSODDPRE",204,0)
 .I +$G(PSORTS) S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) "Returned to stock on "_$$FMTE^XLFDT(PSORTS,2) Q
"RTN","PSODDPRE",205,0)
 .S:$G(PSODUPF) PSODUPC(ZCT)=PSODUPC(ZCT)+1 W:'$G(PSODUPF) $S(PSOLRD="":"Not released locally",1:"Released locally on "_$$FMTE^XLFDT($P(PSOLRD,"^"),2)_" "_$P(PSOLRD,"^",2))_$S($P(^PSRX(RXREC,0),"^",11)="W":" (Window)",1:" (Mail)")
"RTN","PSODDPRE",206,0)
 Q
"RTN","PSODDPRE",207,0)
 ;
"RTN","PSODDPRE",208,0)
DATACK ;check FDB returned data to determine whether to continue processing.
"RTN","PSODDPRE",209,0)
 S DIR(0)="E",DIR("A",1)="No Enhanced Order Checks can be performed."
"RTN","PSODDPRE",210,0)
 S DIR("A",2)="   Reason(s): "_$P($G(^TMP($J,LIST,"OUT",0)),"^",2)
"RTN","PSODDPRE",211,0)
 S DIR("A")="Press Return to continue...",DIR("?")="Press Return to continue"
"RTN","PSODDPRE",212,0)
 W ! D ^DIR K DIRUT,DUOUT,DIR,X,Y  W @IOF ;I $P(^TMP($J,LIST,"OUT",0),"^")=1
"RTN","PSODDPRE",213,0)
 Q
"RTN","PSODDPRE",214,0)
 ;
"RTN","PSODDPRE",215,0)
NVATST(PSONVTOI) ; Look for any active Non-VA Dispense Drugs not marked as a supply item
"RTN","PSODDPRE",216,0)
 N PSONVT1,PSONVTFL,PSONVTIN
"RTN","PSODDPRE",217,0)
 S PSONVTFL=1
"RTN","PSODDPRE",218,0)
 F PSONVT1=0:0 S PSONVT1=$O(^PSDRUG("ASP",PSONVTOI,PSONVT1)) Q:'PSONVT1!('PSONVTFL)  D
"RTN","PSODDPRE",219,0)
 .I $P($G(^PSDRUG(PSONVT1,2)),"^",3)'["X" Q
"RTN","PSODDPRE",220,0)
 .S PSONVTIN=$P($G(^PSDRUG(PSONVT1,"I")),"^") I PSONVTIN,PSONVTIN<DT Q
"RTN","PSODDPRE",221,0)
 .S PSONVTFL=$$SUP^PSSDSAPI(PSONVT1)
"RTN","PSODDPRE",222,0)
 Q PSONVTFL
"RTN","PSODEM")
0^1^B16428757
"RTN","PSODEM",1,0)
PSODEM ;BHAM ISC/SAB - PATIENT DEMOGRAPHICS ; 02/17/93 12:29
"RTN","PSODEM",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,19,233,258,326,390,411**;DEC 1997;Build 95
"RTN","PSODEM",3,0)
 ;External reference to ^GMRADPT supported by DBIA 10099
"RTN","PSODEM",4,0)
 ;External reference to ^DIC(31 supported by DBIA 658
"RTN","PSODEM",5,0)
 ;
"RTN","PSODEM",6,0)
GET S DFN=DA D 6^VADPT,PID^VADPT U IO W @IOF,!,VADM(1)
"RTN","PSODEM",7,0)
 I +VAPA(9) W !?5,"(TEMP ADDRESS from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")"
"RTN","PSODEM",8,0)
 W !,VAPA(1),?40,"DOB:   ",$S(+VADM(3):$P(VADM(3),"^",2),1:"UNKNOWN") W:VAPA(2)]"" !,VAPA(2) W:VAPA(3)]"" !,VAPA(3)
"RTN","PSODEM",9,0)
 W !,VAPA(4),?40,"PHONE: "_VAPA(8),!,$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),?40,"ELIG:  "_$P(VAEL(1),"^",2) W:+VAEL(3) !?40,"SC%:   "_$P(VAEL(3),"^",2)
"RTN","PSODEM",10,0)
 I $D(^PS(55,DFN,0)) W:$P(^(0),"^",2) !,"CANNOT USE SAFETY CAPS." I +$P(^(0),"^",4) W ?40,"DIALYSIS PATIENT."
"RTN","PSODEM",11,0)
 I $G(^PS(55,DFN,1))]"" S X=^(1) W !!?5,"Pharmacy Narrative: " F I=1:1 Q:$P(X," ",I,99)=""  W:$X+$L($P(X," ",I))+$L(" ")>IOM ! W $P(X," ",I)," "
"RTN","PSODEM",12,0)
RE S (WT,HT)="",X="GMRVUTL" X ^%ZOSF("TEST") I $T D
"RTN","PSODEM",13,0)
 .F GMRVSTR="WT","HT" S VM=GMRVSTR D EN6^GMRVUTL S @VM=X,$P(@VM,"^")=$E($P(@VM,"^"),4,5)_"/"_$E($P(@VM,"^"),6,7)_"/"_($E($P(@VM,"^"),1,3)+1700)
"RTN","PSODEM",14,0)
 .S X=$P(WT,"^",8),Y=$J(X/2.2,0,2),$P(WT,"^",9)=Y,X=$P(HT,"^",8),Y=$J(2.54*X,0,2),$P(HT,"^",9)=Y
"RTN","PSODEM",15,0)
 Q:$G(POERR)
"RTN","PSODEM",16,0)
 W !!,"WEIGHT(Kg): " W:+$P(WT,"^",8) $P(WT,"^",9)_" ("_$P(WT,"^")_")" W ?41,"HEIGHT(cm): " W:$P(HT,"^",8) $P(HT,"^",9)_" ("_$P(HT,"^")_")" K VM,WT,HT
"RTN","PSODEM",17,0)
CRCL S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2))
"RTN","PSODEM",18,0)
 S RSLT=$$CRCL^PSOORUT2(DFN)
"RTN","PSODEM",19,0)
 ; RSLT -- DATE^CRCL^Serum Creatinine -- Ex.  11/25/11^68.7^1.1
"RTN","PSODEM",20,0)
 I $P(RSLT,"^",2)["Not Found" S ZDSPL="CrCL: "_$P(RSLT,"^",2)
"RTN","PSODEM",21,0)
 E  S ZDSPL="CrCL: "_$P($G(RSLT),"^",2)_"(est.) "_"(CREAT:"_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSODEM",22,0)
 W !,ZDSPL,?40," BSA (m2): ",PSOBSA K PSOBSA,ZDSPL,RSLT
"RTN","PSODEM",23,0)
 S PSLC=0 G MA:$P($G(^DPT(DFN,.17)),"^",2)'="I"
"RTN","PSODEM",24,0)
 I '$D(VAEL(1)) D ELIG^VADPT W !!,"ELIGIBILITY: ",$P(VAEL(1),"^",2) W:+VAEL(3) ?$X+5,"SC%: "_$P(VAEL(3),"^",2) S PSLC=PSLC+2
"RTN","PSODEM",25,0)
MA K SC W !,"DISABILITIES: " S PSLC=PSLC+2
"RTN","PSODEM",26,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSODEM",27,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSODEM",28,0)
 .X:($X+$L(PSDIS)+7)>(IOM-8) "W !?14 S PSLC=PSLC+1" W PSDIS,"-",PSCNT,"% (",$S($P(I1,"^",3):"SC",1:"NSC"),"), "
"RTN","PSODEM",29,0)
 .I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?13
"RTN","PSODEM",30,0)
 X "N X S X=""GMRADPT"" X ^%ZOSF(""TEST"") Q" I $T D:'$D(PSOPTPST) GMRA
"RTN","PSODEM",31,0)
Q K SC,I1,VAROOT,Y,AL,I,X,Y,PSCNT,PSLC,PSDIS D:$G(PSTYPE)']"" KVA^VADPT Q
"RTN","PSODEM",32,0)
GMRA K ^TMP($J,"AL") S GMRA="0^0^111" D ^GMRADPT I GMRAL D
"RTN","PSODEM",33,0)
 .F DR=0:0 S DR=$O(GMRAL(DR)) Q:'DR  S ^TMP($J,"AL",$S('$P(GMRAL(DR),"^",5):1,1:2),$P(GMRAL(DR),"^",7),$P(GMRAL(DR),"^",2))=""
"RTN","PSODEM",34,0)
 .W !!,"ALLERGIES: " S (DR,TY)="" F I=0:0 S TY=$O(^TMP($J,"AL",1,TY)) Q:TY=""  F D=0:0 S DR=$O(^TMP($J,"AL",1,TY,DR)) Q:DR=""  W:$X+$L(DR)+$L(", ")>IOM !?11 W DR_", " D
"RTN","PSODEM",35,0)
 ..I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?18
"RTN","PSODEM",36,0)
 .W !!,"ADVERSE REACTIONS: " S (DR,TY)="" F I=0:0 S TY=$O(^TMP($J,"AL",2,TY)) Q:TY=""  F D=0:0 S DR=$O(^TMP($J,"AL",2,TY,DR)) Q:DR=""  W:$X+$L(DR)+$L(", ")>IOM !?19 W DR_", " D
"RTN","PSODEM",37,0)
 ..I $E(IOST)="C",$Y+4>IOSL,$D(PSTYPE) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT W @IOF,?18
"RTN","PSODEM",38,0)
 I $G(GMRAL)']"" F AD="ALLERGIES:","ADVERSE REACTIONS:" W !!,AD I $G(PSOFROM)="" F ADL=1:1:IOM-($L(AD)+5) W "_"
"RTN","PSODEM",39,0)
 I GMRAL=0 W !!,"ALLERGIES: NKA",!!,"ADVERSE REACTIONS:"
"RTN","PSODEM",40,0)
 W ! K TY,D,I,GMRA,GMRAL,DR,AD,ADL,^TMP($J,"AL") Q
"RTN","PSODGAL1")
0^8^B113259514
"RTN","PSODGAL1",1,0)
PSODGAL1 ;BIR/LC,SAB - enhanced DRUG ALLERGY REACTION CHECKING ;12/09/07  02:22
"RTN","PSODGAL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**251,401,390,424,429,411**;DEC 1997;Build 95
"RTN","PSODGAL1",3,0)
 ;External reference to $$ORCHK2^GMRAOR supported by DBIA 2378
"RTN","PSODGAL1",4,0)
 ;External reference to ^PS(50.605 supported by DBIA 696
"RTN","PSODGAL1",5,0)
 ;External reference to ^TMP("GMRAOC" supported by DBIA 4848
"RTN","PSODGAL1",6,0)
 ;External reference to ^XUSEC("PSORPH" supported by DBIA 10076
"RTN","PSODGAL1",7,0)
 ;External reference to GETOC4^OROCAPI1 supported by DBIA 5729
"RTN","PSODGAL1",8,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSODGAL1",9,0)
 ;External reference to ^PS(53.1 supported by DBIA 5793
"RTN","PSODGAL1",10,0)
 ;External reference to ^PSJRXI supported by DBIA 6076
"RTN","PSODGAL1",11,0)
 ;External reference to SIG^XUSESIG supported by DBIA 10050
"RTN","PSODGAL1",12,0)
 ;External reference to $$FINDC^PSJDGAL2 supportedby DBIA 6140
"RTN","PSODGAL1",13,0)
 ;
"RTN","PSODGAL1",14,0)
EN ; Called from both inpatient and outpatient pharmacy
"RTN","PSODGAL1",15,0)
 N PSOACK,DFN,PSODAL,RXN,LPTR,PSOSEVT,PSOSEVT1,NDF,PSOSYMS,PSOINGRE,PSOSORT,PSOGIEN,PSODGCL,PSODGCL1,I,II,PSOADA,PSOADAT,PSOASEV,PSOASITE,PSODRCL1,PSODRCL
"RTN","PSODGAL1",16,0)
 N PSOINGR,PSOGMRA,PSOGMRA2,PSOIADAT,PSOLCLAS,PSOLOC,PSOOINGR,PSOSEV,PSOSNAM,PTR,TYP,ZPOP,ZPOP2,ZSITE,ZZSITE,PSOCAGNT,PSORXORD
"RTN","PSODGAL1",17,0)
 K ^TMP($J,"PSODRCLS"),DSPLQ,PSOMDC,^TMP("GMRAOC",$J),ZGMRA,GMRAING,GMRADRCL,GMRAREAC,PSOALGYF,PSOASORT,GMRARSLT
"RTN","PSODGAL1",18,0)
 S DFN=PSODFN
"RTN","PSODGAL1",19,0)
 S (NDF,TYP,PTR,PSOALGYF)=""
"RTN","PSODGAL1",20,0)
 I $D(PSODRUG("NDF")),PSODRUG("NDF")'=0 S NDF=$P(PSODRUG("NDF"),"A"),TYP=$P(PSODRUG("NDF"),"A",2),PTR=$S(NDF=0:"",1:NDF)_"."_TYP
"RTN","PSODGAL1",21,0)
 S $P(PTR,".",3)=PSODRUG("IEN")
"RTN","PSODGAL1",22,0)
 ;
"RTN","PSODGAL1",23,0)
CHK ;matched to ndf
"RTN","PSODGAL1",24,0)
 S:'$G(PSJALGCT) PSJALGCT=1  ;counter for inpatient; OP will always be 1
"RTN","PSODGAL1",25,0)
 K ZMED,ZMEDLCL S PSOACK=$$ORCHK2^GMRAOR(DFN,"DR",PTR,"","GMRARSLT") D:+$G(PSOACK)>0
"RTN","PSODGAL1",26,0)
 .D DSPLY Q:$G(PSORX("DFLG"))!($G(PSGORQF))
"RTN","PSODGAL1",27,0)
 .Q:$D(^XUSEC("PSORPH",DUZ))!($G(PSODGCK))
"RTN","PSODGAL1",28,0)
 .I +$G(PSOACK)=1 D
"RTN","PSODGAL1",29,0)
 ..N ZMSG,ZLOCAL,ZINGREDS,ZI,ZINGRED
"RTN","PSODGAL1",30,0)
 ..S ^TMP("PSODAI",$J,0)=1,(PSOSEV,PSOLOC,PSODRG)=""
"RTN","PSODGAL1",31,0)
 ..S ZMSG="" F  S ZMSG=$O(GMRARSLT(ZMSG)) Q:'ZMSG  D 
"RTN","PSODGAL1",32,0)
 ...S PSOGIEN=$$GMSGPTR(ZMSG)
"RTN","PSODGAL1",33,0)
 ...Q:PSOGIEN=""
"RTN","PSODGAL1",34,0)
 ...S ZLOCAL=$S($P(GMRARSLT(ZMSG,PSOGIEN),U,2)="L":" (local)",1:" (remote)")
"RTN","PSODGAL1",35,0)
 ...S ZINGREDS=$G(GMRARSLT(ZMSG,"MESSAGE","OFFENDERS","ING"))
"RTN","PSODGAL1",36,0)
 ...Q:ZINGREDS=""
"RTN","PSODGAL1",37,0)
 ...S:$E(ZINGREDS,1)="~" ZINGREDS=$E(ZINGREDS,2,9999)
"RTN","PSODGAL1",38,0)
 ...F ZI=1:1:$L(ZINGREDS,"~") S ZINGRED=$P(ZINGREDS,"~",ZI) Q:ZINGRED=""  D
"RTN","PSODGAL1",39,0)
 ....S ^TMP("PSODAI",$J,ZI,0)=ZINGRED_ZLOCAL
"RTN","PSODGAL1",40,0)
 ....Q
"RTN","PSODGAL1",41,0)
 Q:$G(PSORX("DFLG"))!($G(PSGORQF))
"RTN","PSODGAL1",42,0)
 S NDF=$P(PSODRUG("NDF"),"A")
"RTN","PSODGAL1",43,0)
 I +$G(PSOACK)>0!$G(^TMP($J,"PSODRCLS",0)) D
"RTN","PSODGAL1",44,0)
 .I '$D(^XUSEC("PSORPH",DUZ)),'$D(PSOMDC) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR,DUOUT,DIRUT Q
"RTN","PSODGAL1",45,0)
 .I $D(PSJDGCK)!$D(PSODGCK) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR K DIR,DUOUT,DIRUT W @IOF Q
"RTN","PSODGAL1",46,0)
 .S DIR("?",1)="Answer 'YES' if you DO want to enter a intervention for this medication,",DIR("?")="       'NO' if you DON'T want to enter a intervention for this medication,"
"RTN","PSODGAL1",47,0)
 .S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")="YES" D ^DIR I '$G(PSJAOC) W !
"RTN","PSODGAL1",48,0)
 .I ($D(DTOUT))!($D(DUOUT)) S:'$G(PSJAOC) (PSODLQT,PSORX("DFLG"))=1 S:$G(PSJAOC) PSGORQF=1 Q
"RTN","PSODGAL1",49,0)
 .I 'Y D:$G(PSOSEVT1("S"))=1  Q
"RTN","PSODGAL1",50,0)
 ..S:$G(PSJAOC) PSGORQF=1
"RTN","PSODGAL1",51,0)
 ..S:'$G(PSJAOC) (PSORX("DFLG"),PSOQUIT)=1
"RTN","PSODGAL1",52,0)
 ..W !!,"With a SEVERE reaction, an intervention is required!",! S VALMBCK="R"
"RTN","PSODGAL1",53,0)
 ..I $G(PSGCOPY)=1!($G(PSIVCOPY)=1) W !,"Order not copied!",! S PSJCOFLG=1  ;set flag if COPY  to not repeat this message in PSGOD
"RTN","PSODGAL1",54,0)
 ..I $G(PSJREN)=1 W !,"No changes made to this order!",! S PSJRNFLG=1       ;set flag if RENEW to not repeat this message in PSGOEE
"RTN","PSODGAL1",55,0)
 ..I '$G(PSOSPRNW) K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSODGAL1",56,0)
 ..S:$G(PSOSPRNW) PSORENW("DFLG")=1,PSORX("DFLG")=0,PSOQUIT=1
"RTN","PSODGAL1",57,0)
 ..I $D(DTOUT)!($D(DUOUT)) D  K DIR,DUOUT,DIRUT W !
"RTN","PSODGAL1",58,0)
 ...I $G(PSJAOC) S PSGORQF=1 Q  ;inpatient
"RTN","PSODGAL1",59,0)
 ...S (PSODLQT,PSOQUIT,PSORX("DFLG"))=1
"RTN","PSODGAL1",60,0)
 .D CRI:$G(PSOSEVT1("S"))=1
"RTN","PSODGAL1",61,0)
 .Q:$G(PSORX("DFLG"))!($G(PSGORQF))
"RTN","PSODGAL1",62,0)
 .I $G(PSJAOC) S PSJDAL=1 D ^PSJRXI I $G(PSJDAL("DA")) S $P(^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,"INTERVENTION"),"^")=PSJDAL("DA") K PSJDAL("DA")
"RTN","PSODGAL1",63,0)
 .I '$G(PSJAOC) S PSODAL=1 D ^PSORXI I $G(PSODAL("DA")) S $P(^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,"INTERVENTION"),"^")=PSODAL("DA") K PSODAL("DA")
"RTN","PSODGAL1",64,0)
 .K PSJRXI("DA"),PSODAL("DA")
"RTN","PSODGAL1",65,0)
EX K DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y,DSPLQ,PSOMDC,AGNL,SEV,SEV,ZGMRA,LPTR,ALTOT
"RTN","PSODGAL1",66,0)
 K PSOACK,GMRAING,GMRADRCL,GMRAREAC,GMRARSLT,I,APTR,GMRA,LP,^TMP($J,"PSODRCLS"),^TMP("GMRAOC",$J),ZCLA,ZCNT,ZINSTL,ZSAT
"RTN","PSODGAL1",67,0)
 I $D(PSJDGCK)!$D(PSODGCK)!$G(PSORX("DFLG"))!$G(PSGORQF) K ^TMP("PSODAOC",$J)
"RTN","PSODGAL1",68,0)
 I '$G(PSJAOC) K PSGORQF
"RTN","PSODGAL1",69,0)
 Q
"RTN","PSODGAL1",70,0)
 ;
"RTN","PSODGAL1",71,0)
DSPLY ;
"RTN","PSODGAL1",72,0)
 K PSOSYMS,PSOCAGNT
"RTN","PSODGAL1",73,0)
 D SORTN^PSODGAL3,FULL^VALM1
"RTN","PSODGAL1",74,0)
 K AGNL,SEV,SEVN,PSOHIS N INGLOC,ZINGLOC,ZMEDL,DACNT,DACNT2,ZSTA,ZDATE
"RTN","PSODGAL1",75,0)
 N ZZING,ZZLOC,ZZALL,PSOACNT,PSOLOCAL,PSOPTR,PSOSITT,PSOCA,ZLOC,PSOATYPE S (ALTOT,DACNT,DACNT2,ZLOC,ZCLA,PSOACNT,PSOATYPE)=0,ZMEDL=""
"RTN","PSODGAL1",76,0)
 S (ZZLOC,PSOCA,ZZALL,ZZING,PSOSEV,PSOINGR,PSOASITE,PSOIADAT,PSOGIEN,PSOADA)=""
"RTN","PSODGAL1",77,0)
 F  S PSOSEV=$O(PSOCAGNT(PSOSEV)) Q:PSOSEV=""  F  S PSOCA=$O(PSOCAGNT(PSOSEV,PSOCA)) Q:PSOCA=""  F  S PSOATYPE=$O(PSOCAGNT(PSOSEV,PSOCA,PSOATYPE)) Q:PSOATYPE=""  S ALTOT=ALTOT+1
"RTN","PSODGAL1",78,0)
 F  S PSOSEV=$O(PSOCAGNT(PSOSEV)) Q:PSOSEV=""!($G(PSORX("DFLG")))!($G(PSGORQF))  F  S PSOCA=$O(PSOCAGNT(PSOSEV,PSOCA)) Q:PSOCA=""!($G(PSORX("DFLG")))!($G(PSGORQF))  D
"RTN","PSODGAL1",79,0)
 .F  S PSOATYPE=$O(PSOCAGNT(PSOSEV,PSOCA,PSOATYPE)) Q:PSOATYPE=""!($G(PSORX("DFLG")))!($G(PSGORQF))  D
"RTN","PSODGAL1",80,0)
 ..S PSOGMRA2=""
"RTN","PSODGAL1",81,0)
 ..S PSOGMRA2=PSOCAGNT(PSOSEV,PSOCA,PSOATYPE)
"RTN","PSODGAL1",82,0)
 ..S (PSOPTR,ZZALL,PSODRCL)=""
"RTN","PSODGAL1",83,0)
 ..S PSOPTR=$P($P(PSOGMRA2,"^",1),"|")
"RTN","PSODGAL1",84,0)
 ..S PSOSITT=$P($P(PSOGMRA2,"^",1),"|",4)
"RTN","PSODGAL1",85,0)
 ..S ZZALL=$$GMSGPTR(PSOPTR)
"RTN","PSODGAL1",86,0)
 ..Q:ZZALL=""
"RTN","PSODGAL1",87,0)
 ..D DSPLY1
"RTN","PSODGAL1",88,0)
 K ^TMP("GMRAOC",$J)
"RTN","PSODGAL1",89,0)
 Q
"RTN","PSODGAL1",90,0)
DSPLY1 ;
"RTN","PSODGAL1",91,0)
 ;                        1          2       3             4                          5         6          7               8                        9          10 
"RTN","PSODGAL1",92,0)
 N ZINDATE,ZSIGN,PSOINSTL,PSOSTA,PSOHIS,PSOSTYP,PSOMEDL,PSOLOCAL,PSODATA,PSOWCA,PSOCAR,PSOSTYPI,PSOLOCI,PSOMEDLI,PSOHISI,PSOSEVI,DRCLIEN,DRCLIENE,PSODCLAS,ZALL,ZMSG
"RTN","PSODGAL1",93,0)
 S PSOHISI=$P(GMRARSLT(PSOPTR,ZZALL),U,8)
"RTN","PSODGAL1",94,0)
 S PSOHIS=$S(PSOHISI="o":"OBSERVED",1:"HISTORICAL")
"RTN","PSODGAL1",95,0)
 S PSOASEV=$$GETSEV^PSODGAL3(PSOSITT,PSOPTR,.GMRARSLT)
"RTN","PSODGAL1",96,0)
 S PSOSEVT=PSOSEV
"RTN","PSODGAL1",97,0)
 S DACNT=DACNT+1
"RTN","PSODGAL1",98,0)
 S DACNT2=DACNT2+1
"RTN","PSODGAL1",99,0)
 S:PSOSEV=1 PSOSEVT1("S")=1
"RTN","PSODGAL1",100,0)
 W $C(7),!!,"A Drug-Allergy Reaction exists for this medication and/or class!",!
"RTN","PSODGAL1",101,0)
 W !,$S($G(PSODGCKF)!($G(PSJDGFLG)):"        Profile Drug: ",1:"    Prospective Drug: ")
"RTN","PSODGAL1",102,0)
 ;
"RTN","PSODGAL1",103,0)
 S PSORXORD=""
"RTN","PSODGAL1",104,0)
 N PSJCPROS,PSJNCOM,PROSPECT S (PSJCPROS,PSJNCOM,PROPSECT)=""
"RTN","PSODGAL1",105,0)
 I $G(PSJAOC) D
"RTN","PSODGAL1",106,0)
 .S PSORXORD=$S($G(PSJORD):PSJORD,$G(ON55):ON55,$G(ON):ON,$G(PSJNORD):PSJNORD,1:"")
"RTN","PSODGAL1",107,0)
 .I '$G(PSORXORD) S PSORXORD=$G(PSGORD)
"RTN","PSODGAL1",108,0)
 .;for complex UD orders display format:  orderable item doseform (units) ex: MORPHINE TAB,SA (100MG)
"RTN","PSODGAL1",109,0)
 .I $G(PSJCOM) S PSJNCOM=$$FINDC^PSJDGAL2($G(PSORXORD)),PSJCPROS=$P(PSJNCOM,"^",2)
"RTN","PSODGAL1",110,0)
 .I '$G(PSJDGCK)&('$G(PSODGCK)) W $S($G(PSORXORD)["V":PSODRUG("OIN"),$G(PSORXORD)["P"&($D(^PS(53.1,+$G(PSORXORD),"AD"))):PSODRUG("OIN"),$G(PSJCOM):PSJCPROS,1:PSODRUG("NAME"))
"RTN","PSODGAL1",111,0)
 .I $G(PSJDGCK)!($G(PSODGCK)) W PSODRUG("NAME")
"RTN","PSODGAL1",112,0)
 E  W PSODRUG("NAME")
"RTN","PSODGAL1",113,0)
 ;
"RTN","PSODGAL1",114,0)
 W !,"     Causative Agent: "
"RTN","PSODGAL1",115,0)
 S (PSOWCA,PSOCAR)="",PSOALGYF=1
"RTN","PSODGAL1",116,0)
 I PSOCA["/" D  S PSOCAR=$E(PSOCAR,3,$L(PSOCAR))
"RTN","PSODGAL1",117,0)
 . F I=1:1 S PSOWCA=$P(PSOCA,"/",I) Q:PSOWCA=""  S PSOCAR=PSOCAR_"/ "_PSOWCA
"RTN","PSODGAL1",118,0)
 I PSOCAR="" S PSOCAR=PSOCA
"RTN","PSODGAL1",119,0)
 ;
"RTN","PSODGAL1",120,0)
 K ^UTILITY($J,"W"),X S DIWL=1,DIWR=55,(X,DIWF)=""
"RTN","PSODGAL1",121,0)
 N CAUSAGNT S (X,PSODCLAS,CAUSAGNT,ZSITE)="",CAUSAGNT=PSOCAGNT(PSOSEV,PSOCA,PSOATYPE)
"RTN","PSODGAL1",122,0)
 ;
"RTN","PSODGAL1",123,0)
SITE ;
"RTN","PSODGAL1",124,0)
 S X=""
"RTN","PSODGAL1",125,0)
 F II=1:1 S ZSITE=$P(CAUSAGNT,"^",II)  Q:ZSITE=""  D
"RTN","PSODGAL1",126,0)
 .S (ZDATE,PSOSNAM,ZZSITE,PSOLOCAL)=""
"RTN","PSODGAL1",127,0)
 .S ZZSITE=$P(ZSITE,"|",4),ZDATE=$P(ZSITE,"|",2),PSOLOCAL=$P(ZSITE,"|",3),ZMSG=$P(ZSITE,"|")
"RTN","PSODGAL1",128,0)
 .S PSOSNAM=$P(GMRARSLT(ZMSG,"MESSAGE",1,ZZSITE),U)
"RTN","PSODGAL1",129,0)
 .;;S PSOSNAM=$$GET1^DIQ(4,ZZSITE,.01)
"RTN","PSODGAL1",130,0)
 .S X=X_", "_PSOSNAM_" - "_$P(ZDATE,"@")
"RTN","PSODGAL1",131,0)
 S X=$S(X'="":PSOCAR_" ("_$E(X,3,9999)_")",1:PSOCAR)
"RTN","PSODGAL1",132,0)
 D ^DIWP,UTIL
"RTN","PSODGAL1",133,0)
 ;
"RTN","PSODGAL1",134,0)
 W " Historical/Observed: "_$P(PSOHIS,";")
"RTN","PSODGAL1",135,0)
 W !,"            Severity: "_$S(PSOASEV="":"Not Entered",1:PSOASEV)
"RTN","PSODGAL1",136,0)
 S (PSOOINGR,ZPOP)="" N Z,ZI,ZX,ZOV,PSOWINGR,PSOWIN,REMSITE,REMTMP
"RTN","PSODGAL1",137,0)
 S DIWL=1,DIWR=55,(X,DIWF)=""
"RTN","PSODGAL1",138,0)
 F  S PSOINGR=$O(PSOCAGNT(PSOSEV,PSOCA,PSOATYPE,PSOINGR)) Q:PSOINGR=""!(PSOINGR="ZZZSYMPTOMS")  D
"RTN","PSODGAL1",139,0)
 .I '$G(ZPOP) S ZPOP=1 W !?7,"  Ingredients: "
"RTN","PSODGAL1",140,0)
 .S X=X_", "_PSOINGR
"RTN","PSODGAL1",141,0)
 D ^DIWP,UTIL
"RTN","PSODGAL1",142,0)
 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF,I,ZX,X,^TMP("PSN",$J),PSNDA,PSNID
"RTN","PSODGAL1",143,0)
 I $P(GMRARSLT(PSOPTR,"MESSAGE",2),U)]"" D SYM1 S ZSIGN=1
"RTN","PSODGAL1",144,0)
 I '$G(ZSIGN) W ?3,"   Signs/Symptoms: None Entered",!
"RTN","PSODGAL1",145,0)
 S PSOLOCAL="",PSOLOCAL=$P($P(ZZALL,"^",3),"|",2)
"RTN","PSODGAL1",146,0)
 ;
"RTN","PSODGAL1",147,0)
DRCL ;PSODRCL1(99,"AMPICILLIN/SULBACTAM","PENICILLINS,AMINO DERIVATIVES")=1
"RTN","PSODGAL1",148,0)
 I $D(PSODRCL1(PSOSEV,PSOCA,PSOATYPE)) D
"RTN","PSODGAL1",149,0)
 .W ?8,"  Drug Class: "
"RTN","PSODGAL1",150,0)
 .N III,XX,X K ^UTILITY($J,"W") S DIWL=1,DIWR=55,(X,XX,DIWF)=""
"RTN","PSODGAL1",151,0)
 .F  S XX=$O(PSODRCL1(PSOSEV,PSOCA,PSOATYPE,XX)) Q:XX=""  D
"RTN","PSODGAL1",152,0)
 ..S DRCLIEN=PSODRCL1(PSOSEV,PSOCA,PSOATYPE,XX),DRCLIENE=$$GET1^DIQ(50.605,DRCLIEN,.01,"E")
"RTN","PSODGAL1",153,0)
 ..S X=X_", "_$S(DRCLIENE'="":DRCLIENE_" ",1:"")_XX
"RTN","PSODGAL1",154,0)
 .S X=$E(X,3,999) D ^DIWP
"RTN","PSODGAL1",155,0)
 .D UTIL
"RTN","PSODGAL1",156,0)
 D OVRD   ;Override Reason
"RTN","PSODGAL1",157,0)
 S PSOACNT=PSOACNT+1
"RTN","PSODGAL1",158,0)
 I ALTOT>PSOACNT K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSODGAL1",159,0)
 I $D(DTOUT)!($D(DUOUT)) S:$G(PSJAOC) PSGORQF=1 S:'$G(PSJAOC) (PSODLQT,PSORX("DFLG"))=1 K DIR,DUOUT,DIRUT W @IOF
"RTN","PSODGAL1",160,0)
 Q
"RTN","PSODGAL1",161,0)
 ;
"RTN","PSODGAL1",162,0)
OVRD ;  Override Reason
"RTN","PSODGAL1",163,0)
 N Z,ZI,ZX,ZOV,ZORN,X,PSOPRET,PSOOVRDR K ^UTILITY($J,"W") S DIWL=1,DIWR=50,(ZOV,ZORN,DIWF)=""
"RTN","PSODGAL1",164,0)
 I '+$G(PSJORD) D  G OVRDX
"RTN","PSODGAL1",165,0)
 .I $G(PSOFOERR) D  Q
"RTN","PSODGAL1",166,0)
 ..S PSOOVRDR=+$P($G(^PS(52.41,ORD,0)),"^") S:PSOOVRDR ZORN=PSOOVRDR
"RTN","PSODGAL1",167,0)
 .I $G(PSOREINS) D  Q
"RTN","PSODGAL1",168,0)
 ..I $G(ZRXN) S ZORN=$P(^PSRX(ZRXN,"OR1"),"^",2)
"RTN","PSODGAL1",169,0)
 .I $G(PSOVER1),$G(PSONV) S PSOOVRDR=+$P($G(^PSRX(PSONV,"OR1")),"^",2) S:PSOOVRDR ZORN=PSOOVRDR
"RTN","PSODGAL1",170,0)
 ;
"RTN","PSODGAL1",171,0)
 I '$G(PSJINFIN) G OVRDX
"RTN","PSODGAL1",172,0)
 I PSJORD["P" S ZORN=+$P($G(^PS(53.1,+PSJORD,0)),U,21) G OVRDX
"RTN","PSODGAL1",173,0)
 I PSJORD["U" S ZORN=+$P($G(^PS(55,DFN,5,+PSJORD,0)),U,21) G OVRDX
"RTN","PSODGAL1",174,0)
 I PSJORD["V" S ZORN=+$P($G(^PS(55,DFN,"IV",+PSJORD,0)),U,21)
"RTN","PSODGAL1",175,0)
OVRDX ;
"RTN","PSODGAL1",176,0)
 G:'$G(ZORN) NF
"RTN","PSODGAL1",177,0)
 D GETOC4^OROCAPI1(ZORN,.PSOPRET)
"RTN","PSODGAL1",178,0)
 F ZI=0:0 S ZI=$O(PSOPRET(ZORN,"DATA",ZI)) Q:'ZI  I $P($P(PSOPRET(ZORN,"DATA",ZI,1),"^"),";",2)=3,$G(PSOPRET(ZORN,"DATA",ZI,"OR",1,0))]"" S ZOV=$G(PSOPRET(ZORN,"DATA",ZI,"OR",1,0))
"RTN","PSODGAL1",179,0)
 S ^TMP("PSODAOC",$J,"ALLERGY","PROVR")=ZOV
"RTN","PSODGAL1",180,0)
NF ;
"RTN","PSODGAL1",181,0)
 I '$G(PSODGCK)&('$G(PSJDGCK)) D
"RTN","PSODGAL1",182,0)
 .W !?3,"Provider Override Reason: " S X=$S($G(ZOV)]"":ZOV,1:"N/A - Order Check Not Evaluated by Provider") D ^DIWP
"RTN","PSODGAL1",183,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?29,^UTILITY($J,"W",1,ZX,0),!
"RTN","PSODGAL1",184,0)
 .K ^UTILITY($J,"W"),DIWL,DIWR,DIWF,ZORN,RET
"RTN","PSODGAL1",185,0)
 ; pso*7*401
"RTN","PSODGAL1",186,0)
 I $D(PSOMDC) D
"RTN","PSODGAL1",187,0)
 .W !,"Warning: The following drug class does not exist in the VA DRUG CLASS"
"RTN","PSODGAL1",188,0)
 .W !,"file (#50.605). Please do a manual Drug-Allergy order check and notify"
"RTN","PSODGAL1",189,0)
 .W !,"the pharmacy ADPAC for follow up.",!
"RTN","PSODGAL1",190,0)
 .S PSOMDC="" F  S PSOMDC=$O(PSOMDC(PSOMDC)) Q:PSOMDC=""  W !,"VA Drug Class: "_PSOMDC,!
"RTN","PSODGAL1",191,0)
 .W ! S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue"
"RTN","PSODGAL1",192,0)
 .D ^DIR K DIR W !
"RTN","PSODGAL1",193,0)
 Q
"RTN","PSODGAL1",194,0)
SYM1 ;format signs/symptoms
"RTN","PSODGAL1",195,0)
 N PSOSYMX,QX,ZSYM
"RTN","PSODGAL1",196,0)
 K ^UTILITY($J,"W"),X S DIWL=1,DIWR=55,DIWF=""
"RTN","PSODGAL1",197,0)
 S (ZSYM,PSOSYMX)="",QX=0
"RTN","PSODGAL1",198,0)
 F  S ZSYM=$O(PSOSYMS(PSOSEV,PSOCA,PSOATYPE,"ZZZSYMPTOMS",ZSYM)) Q:ZSYM=""  S QX=QX+1,PSOSYMX=PSOSYMX_", "_$P(ZSYM,";",1)
"RTN","PSODGAL1",199,0)
 S PSOSYMX=$E(PSOSYMX,3,999),X=PSOSYMX D ^DIWP
"RTN","PSODGAL1",200,0)
 W ?4,"  Signs/Symptoms: "
"RTN","PSODGAL1",201,0)
 N ZNODE F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  D
"RTN","PSODGAL1",202,0)
 .S ZNODE="",ZNODE=^UTILITY($J,"W",1,ZX,0)
"RTN","PSODGAL1",203,0)
 .I $E(ZNODE,1,2)=", " S ZNODE=$E(ZNODE,3,999)
"RTN","PSODGAL1",204,0)
 .W ?22,ZNODE,!
"RTN","PSODGAL1",205,0)
 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF,I,ZX
"RTN","PSODGAL1",206,0)
 Q
"RTN","PSODGAL1",207,0)
 ;
"RTN","PSODGAL1",208,0)
CRI ;input electronic sig
"RTN","PSODGAL1",209,0)
 N X1 D SIG^XUSESIG I X1="" D  Q
"RTN","PSODGAL1",210,0)
 .K PSORX("INTERVENE"),DIR
"RTN","PSODGAL1",211,0)
 .I $G(PSJAOC) S PSGORQF=1
"RTN","PSODGAL1",212,0)
 .E  S PSORX("DFLG")=1,VALMBCK="R"
"RTN","PSODGAL1",213,0)
 .S:$D(PSORENW) PSORENW("DFLG")=1
"RTN","PSODGAL1",214,0)
 .W !!,"With a SEVERE reaction, an Electronic Signature is required!",!
"RTN","PSODGAL1",215,0)
 .I $G(PSGCOPY)=1!($G(PSIVCOPY)=1) W !,"Order not copied!",!
"RTN","PSODGAL1",216,0)
 .I $G(PSJREN)=1 W !,"No changes made to this order!",!
"RTN","PSODGAL1",217,0)
 .S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR W !
"RTN","PSODGAL1",218,0)
 S PSORX("INTERVENE")=1
"RTN","PSODGAL1",219,0)
 Q
"RTN","PSODGAL1",220,0)
DIR ;
"RTN","PSODGAL1",221,0)
 S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue"
"RTN","PSODGAL1",222,0)
 D ^DIR K DIR W !
"RTN","PSODGAL1",223,0)
 Q
"RTN","PSODGAL1",224,0)
 ;
"RTN","PSODGAL1",225,0)
UTIL ;
"RTN","PSODGAL1",226,0)
 N ZNODE F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  D
"RTN","PSODGAL1",227,0)
 .S ZNODE="",ZNODE=^UTILITY($J,"W",1,ZX,0)
"RTN","PSODGAL1",228,0)
 .I $E(ZNODE,1,2)=", " S ZNODE=$E(ZNODE,3,999)
"RTN","PSODGAL1",229,0)
 .W ?22,ZNODE,!
"RTN","PSODGAL1",230,0)
 K ^UTILITY($J,"W"),DIWL,DIWR,DIWF,I,ZX
"RTN","PSODGAL1",231,0)
 Q
"RTN","PSODGAL1",232,0)
 ;
"RTN","PSODGAL1",233,0)
GMSGPTR(MSG,NODE) ; retrieve second level pointer from new allergy array
"RTN","PSODGAL1",234,0)
 N RESULT
"RTN","PSODGAL1",235,0)
 S RESULT=$O(GMRARSLT(MSG,$G(NODE)))
"RTN","PSODGAL1",236,0)
 Q:+RESULT>0 RESULT
"RTN","PSODGAL1",237,0)
 S:RESULT="MESSAGE" RESULT=$O(GMRARSLT(MSG,RESULT))
"RTN","PSODGAL1",238,0)
 Q:$E(RESULT,1)="R" RESULT
"RTN","PSODGAL1",239,0)
 S RESULT=""
"RTN","PSODGAL1",240,0)
 Q RESULT
"RTN","PSODGAL1",241,0)
 ;
"RTN","PSODGAL2")
0^10^B104733405
"RTN","PSODGAL2",1,0)
PSODGAL2 ; BIR/SAB - displays stored DRUG ALLERGY w/sign/symptoms ;10/27/11  02:22
"RTN","PSODGAL2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**390,411**;DEC 1997;Build 95
"RTN","PSODGAL2",3,0)
 ;Reference to ^PS(50.605, supported by DBIA 696
"RTN","PSODGAL2",4,0)
 ;Reference to GETOC4^OROCAPI1 supported by DBIA 5729
"RTN","PSODGAL2",5,0)
 ;Reference to ^ORD(100.05 supported by DBIA 5731
"RTN","PSODGAL2",6,0)
 ;Reference to ^GMRD(120.83 supported by DBIA 5767
"RTN","PSODGAL2",7,0)
 ;Reference to ^PS(50.416 supported by DBIA 4998
"RTN","PSODGAL2",8,0)
 ;
"RTN","PSODGAL2",9,0)
 ; This routine is called when the hidden option 'DA' is typed from the OP Medication screen
"RTN","PSODGAL2",10,0)
 D FULL^VALM1
"RTN","PSODGAL2",11,0)
 N ZORN,X,RET,DA,CNT,ZCNT,ZCNTT,XXI,ZZQ,DA,ZI,ZII,IT,SEVT,SEVN,ZFND,ORCT,ZWARN,DAT,CA,CAG,CLSTAT,PSOASORT,PROSPECT
"RTN","PSODGAL2",12,0)
 N ZDA,ZDATB,ZST,ZQS,ZALL,ZRX,ZERO,PRTFLG,FLAG2,PSOASEV,PSOREA,PSOTYPE,PSORSITE,PSORDATA,ZIIEN,PSOPROV,PSOCAGNT
"RTN","PSODGAL2",13,0)
 N PSOQUIT,DIWF,DIWL,DIWR,II,IEN
"RTN","PSODGAL2",14,0)
 S (CNT,FLAG2,ZCNT,ZCNTT,ZFND,PSOQUIT,IEN)=0
"RTN","PSODGAL2",15,0)
 I $G(PSODGCK) S ZRX=PSODGCRX
"RTN","PSODGAL2",16,0)
 I '$G(PSODGCK) S ZRX=$P(PSOLST(ORN),"^",2)
"RTN","PSODGAL2",17,0)
 S ZORN=$P(^PSRX(ZRX,"OR1"),"^",2)
"RTN","PSODGAL2",18,0)
 I 'ZORN W !,"NO Drug Allergy Order Checks found for Rx#: "_$P(^PSRX(ZRX,0),"^") G EXT
"RTN","PSODGAL2",19,0)
 K ^TMP("PSODAOCD",$J),^TMP("PSOAL",$J) D GETOC4^OROCAPI1(ZORN,.RET)
"RTN","PSODGAL2",20,0)
 I $O(RET(ZORN,"DATA",""))="" S FLAG2=1
"RTN","PSODGAL2",21,0)
 ;
"RTN","PSODGAL2",22,0)
 ;
"RTN","PSODGAL2",23,0)
SORT ;build sort by severity, reactant/causitive agent
"RTN","PSODGAL2",24,0)
 N ZIIEN,ZSIEN,ZSIGNS,SIGN,PSOASEV2,PSOZERO,SIGNS,PSOPTLOC,PSOINST,PSOREA2,PSOREAS,PSOREAB,PSODRGCL,PSODRCL2
"RTN","PSODGAL2",25,0)
 N DRUGIEN,PSODCLAS,PSJREAB,PSJREAS
"RTN","PSODGAL2",26,0)
 F ZI=0:0 S ZI=$O(RET(ZORN,"DATA",ZI)) Q:'ZI  D:+$P(RET(ZORN,"DATA",ZI,1),";",2)=3
"RTN","PSODGAL2",27,0)
 .I $G(RET(ZORN,"DATA",ZI,"OR",1,0))]"" S ^TMP("PSODAOCD",$J,"AOR",$G(RET(ZORN,"DATA",ZI,"OR",1,0)))=""
"RTN","PSODGAL2",28,0)
 .S ZIIEN=0 F  S ZIIEN=$O(^ORD(100.05,ZI,4,ZIIEN)) Q:ZIIEN=""  I $D(^ORD(100.05,ZI,4,ZIIEN,0)) D
"RTN","PSODGAL2",29,0)
 ..Q:$P(^ORD(100.05,ZI,0),"^",3)["CPRS"
"RTN","PSODGAL2",30,0)
 ..S (PSOZERO,PSOREA,PSOTYPE,PSORSITE,PSOASEV,PSOASEV2,PROSPECT,DRUGIEN,PSJREAB,PSJREAS)=""
"RTN","PSODGAL2",31,0)
 ..S PSOZERO=$G(^ORD(100.05,ZI,4,ZIIEN,0))
"RTN","PSODGAL2",32,0)
 ..S PSOREAB=$P(PSOZERO,"^"),PSOREA2=$P($P(PSOZERO,"^",2),";",2)_$P($P(PSOZERO,"^",2),";"),PSOASEV=$P(PSOZERO,"^",7),PSOTYPE=$P(PSOZERO,"^",3)
"RTN","PSODGAL2",33,0)
 ..S PSORSITE=$P(PSOZERO,"^",4),PSOASEV2=$S(PSOASEV=3:"A",PSOASEV="2":"B",PSOASEV=1:"C",1:"D")
"RTN","PSODGAL2",34,0)
 ..I PSOREAB["/" D  S PSOREA=$E(PSOREA,3,$L(PSOREA))
"RTN","PSODGAL2",35,0)
 ...F I=1:1 S PSOREAS=$P(PSOREAB,"/",I) Q:PSOREAS=""  S PSOREA=PSOREA_"/ "_PSOREAS
"RTN","PSODGAL2",36,0)
 ..I PSOREAB'["/" S PSOREA=PSOREAB
"RTN","PSODGAL2",37,0)
 ..;
"RTN","PSODGAL2",38,0)
 ..;PROSPECTIVE DRUG/DISPENSED DRUG
"RTN","PSODGAL2",39,0)
 ..I $D(^ORD(100.05,ZI,5,1,0)) S DRUGIEN=^ORD(100.05,ZI,5,1,0)
"RTN","PSODGAL2",40,0)
 ..I DRUGIEN'="" S PROSPECT=$$GET1^DIQ(50,DRUGIEN,.01,"E") ;GENERIC NAME
"RTN","PSODGAL2",41,0)
 ..Q:PROSPECT=""
"RTN","PSODGAL2",42,0)
 ..;
"RTN","PSODGAL2",43,0)
 ..;DRUG CLASS
"RTN","PSODGAL2",44,0)
 ..S (PSOCAGNT,PSODRGCL,PSODCLAS,PSODRCL2)=""
"RTN","PSODGAL2",45,0)
 ..F ZZQ=0:0 S ZZQ=$O(^ORD(100.05,ZI,4,ZIIEN,1,ZZQ)) Q:'ZZQ!(ZZQ'?1N.N)  D
"RTN","PSODGAL2",46,0)
 ...S PSODRCL2=^ORD(100.05,ZI,4,ZIIEN,1,ZZQ,0),PSODCLAS=1
"RTN","PSODGAL2",47,0)
 ...S PSODRGCL=PSODRGCL_"|"_$$GET1^DIQ(50.605,PSODRCL2,1)
"RTN","PSODGAL2",48,0)
 ..I PSODRGCL'?1A.AP  S PSODRGCL=$E(PSODRGCL,2,999)
"RTN","PSODGAL2",49,0)
 ..S:PSODRGCL=""!(PSODRGCL="|") PSODRGCL="aaaa"
"RTN","PSODGAL2",50,0)
 ..S PSOCAGNT=$S(PSODRGCL'="aaaa":PSODRGCL,1:$P(PSOREA,"|",1))
"RTN","PSODGAL2",51,0)
 ..;
"RTN","PSODGAL2",52,0)
 ..;SITES
"RTN","PSODGAL2",53,0)
 ..I PSOTYPE="L" D  ;local site
"RTN","PSODGAL2",54,0)
 ...S PSOPTLOC=$P(^PSRX(ZRX,2),"^",9),PSORSITE=$$GET1^DIQ(59,PSOPTLOC,100,"I")
"RTN","PSODGAL2",55,0)
 ..S PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,0)=ZIIEN_"^"_ZI_"^"_PSOCAGNT
"RTN","PSODGAL2",56,0)
 ..I '$D(PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,1)) S PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,1)=PSOTYPE_"|"_PSORSITE_"|"_$P(PSOZERO,"^",5),ZCNTT=1
"RTN","PSODGAL2",57,0)
 ..I $D(PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,1)) D
"RTN","PSODGAL2",58,0)
 ...S:PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,1)'[(PSOTYPE_"|"_PSORSITE_"|"_$P(PSOZERO,"^",5)) PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,1)=PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,1)_"^"_PSOTYPE_"|"_PSORSITE_"|"_$P(PSOZERO,"^",5)
"RTN","PSODGAL2",59,0)
 ..;
"RTN","PSODGAL2",60,0)
 ..;SIGNS AND SYMPTOMS
"RTN","PSODGAL2",61,0)
 ..S ZSIEN="" F  S ZSIEN=$O(^ORD(100.05,ZI,4,ZIIEN,3,ZSIEN)) Q:ZSIEN=""  I $D(^ORD(100.05,ZI,4,ZIIEN,3,ZSIEN,0)) D
"RTN","PSODGAL2",62,0)
 ...S ZSIGNS=^ORD(100.05,ZI,4,ZIIEN,3,ZSIEN,0)
"RTN","PSODGAL2",63,0)
 ...I '$D(PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,2)) S PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,2)=ZSIGNS Q
"RTN","PSODGAL2",64,0)
 ...S:PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,2)'[("|"_ZSIGNS_"|") PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,2)=PSOASORT(PROSPECT,PSOASEV2,PSOREA,PSOREA2,2)_"|"_ZSIGNS
"RTN","PSODGAL2",65,0)
 ;
"RTN","PSODGAL2",66,0)
 I 'ZCNTT S FLAG2=1
"RTN","PSODGAL2",67,0)
 I '$G(PSODGCK)&(FLAG2) W !,"NO Drug Allergy Order Checks found for Rx#: "_$P(^PSRX(ZRX,0),"^") G EXT
"RTN","PSODGAL2",68,0)
 Q:FLAG2&($G(PSODGCK))
"RTN","PSODGAL2",69,0)
LOOP ;
"RTN","PSODGAL2",70,0)
 ;**** Begin looping through sort
"RTN","PSODGAL2",71,0)
 S (PROSPECT,PSOASEV,PSOREA,PSOREA2,PSOTYPE,PSORSITE,PSORDATA,ZIIEN)=""
"RTN","PSODGAL2",72,0)
 F  S PROSPECT=$O(PSOASORT(PROSPECT)) Q:PROSPECT=""  F  S PSOASEV=$O(PSOASORT(PROSPECT,PSOASEV)) Q:PSOASEV=""  D  Q:$G(VALMBCK)="R"
"RTN","PSODGAL2",73,0)
 .F  S PSOREA=$O(PSOASORT(PROSPECT,PSOASEV,PSOREA)) Q:PSOREA=""  F  S PSOREA2=$O(PSOASORT(PROSPECT,PSOASEV,PSOREA,PSOREA2)) Q:PSOREA2=""  D  Q:$G(VALMBCK)="R"
"RTN","PSODGAL2",74,0)
 ..;F  S ZIIEN=$O(PSOASORT(PROSPECT,PSOASEV,PSOREA,PSOREA2,ZIIEN)) Q:ZIIEN=""  D  Q:$G(VALMBCK)="R"
"RTN","PSODGAL2",75,0)
 ..S PSORDATA=PSOASORT(PROSPECT,PSOASEV,PSOREA,PSOREA2,0),(ZIIEN,XXI)=$P(PSORDATA,"^",1),ZI=$P(PSORDATA,"^",2)
"RTN","PSODGAL2",76,0)
 ..S PSORSITE=PSOASORT(PROSPECT,PSOASEV,PSOREA,PSOREA2,1)
"RTN","PSODGAL2",77,0)
 ..D ADOC Q:$G(VALMBCK)="R"
"RTN","PSODGAL2",78,0)
 ;
"RTN","PSODGAL2",79,0)
PRT ; print allergy information to screen
"RTN","PSODGAL2",80,0)
 D FULL^VALM1 W @IOF
"RTN","PSODGAL2",81,0)
 N ZZ,PRTFLG S PRTFLG=0
"RTN","PSODGAL2",82,0)
 W $C(7),!,"A Drug-Allergy Reaction exists for this medication and/or class!",!
"RTN","PSODGAL2",83,0)
 S ZZ="" F  S ZZ=$O(^TMP("PSOAL",$J,ZZ)) Q:ZZ=""  D  G EXIT:PSOQUIT
"RTN","PSODGAL2",84,0)
 .I PRTFLG,$G(^TMP("PSOAL",$J,ZZ,0))["Prospective Drug:" D EXT W !
"RTN","PSODGAL2",85,0)
 .W !,^TMP("PSOAL",$J,ZZ,0) S PRTFLG=1 I ($Y+2)>IOSL D FF
"RTN","PSODGAL2",86,0)
 ;
"RTN","PSODGAL2",87,0)
 K DIR,DUOUT,DIRUT,PSOASORT
"RTN","PSODGAL2",88,0)
 G EXIT:PSOQUIT
"RTN","PSODGAL2",89,0)
 I $G(PRTFLG) W ! D FF
"RTN","PSODGAL2",90,0)
 G EXIT
"RTN","PSODGAL2",91,0)
 Q
"RTN","PSODGAL2",92,0)
 ;
"RTN","PSODGAL2",93,0)
ADOC ;
"RTN","PSODGAL2",94,0)
 N ING,SS,DC,OH,CAG,CAUS,SEVT,SEVN,ZALL,Z,ZX,ZALL,FIRST,DRUG,DRUGS,ZCX,PSOWCA,CAUS2,ZLOC,PSOCAR,FLAG,I,ZDATE
"RTN","PSODGAL2",95,0)
 N SITE,SITET,SITED,I,ZDATA,PSOCSITE
"RTN","PSODGAL2",96,0)
 I XXI'="" D:$P($G(^ORD(100.05,ZI,4,XXI,0)),"^")]""
"RTN","PSODGAL2",97,0)
 .S (SEVT,SEVN,CAUS,CAUS2,PSOWCA,PSOCAR,OH,DRUG,DRUGS,X,ING,SS,DC,ZALL,ZLOC,ZDATE)=""
"RTN","PSODGAL2",98,0)
 .S ZALL=$G(^ORD(100.05,ZI,4,XXI,0)),ZLOC=$P(ZALL,"^",3)
"RTN","PSODGAL2",99,0)
 .S CAUS=$P(ZALL,"^",1),CAUS2=$P($P(ZALL,"^",2),";")
"RTN","PSODGAL2",100,0)
 .S SEVT=$P(ZALL,"^",7),SEVN=$S(SEVT=1:"MILD",SEVT=2:"MODERATE",SEVT=3:"SEVERE",1:"Not Entered")
"RTN","PSODGAL2",101,0)
 .S ^TMP("PSODAOCD",$J,"CA",CAUS)=""
"RTN","PSODGAL2",102,0)
 .;
"RTN","PSODGAL2",103,0)
 .;SITES
"RTN","PSODGAL2",104,0)
 .S CAUS=$P(PSOREA," ~"),PSOCSITE=""
"RTN","PSODGAL2",105,0)
 .I PSORSITE'["^" D
"RTN","PSODGAL2",106,0)
 ..S ZDATE=$P(PSORSITE,"|",3),ZDATE=$S(ZDATE'="":$E(ZDATE,4,5)_"/"_$E(ZDATE,6,7)_"/"_$E(ZDATE,2,3),1:"")
"RTN","PSODGAL2",107,0)
 ..S PSOCSITE=$$GET1^DIQ(4,$P(PSORSITE,"|",2),.01,"E")
"RTN","PSODGAL2",108,0)
 ..I PSOCSITE="" S PSOCSITE=$S(PSOCSITE'="":PSOCSITE,ZLOC="L":"LOCAL",ZLOC="R":"REMOTE",1:"Not Given")
"RTN","PSODGAL2",109,0)
 ..S PSOCAR=CAUS_" ("_PSOCSITE_" - "_ZDATE_")"
"RTN","PSODGAL2",110,0)
 .I PSORSITE["^" D  S:PSOCAR'="" PSOCAR=CAUS_" ("_$E(PSOCAR,3,999)_")"
"RTN","PSODGAL2",111,0)
 ..F I=1:1 S ZDATA=$P(PSORSITE,"^",I) Q:ZDATA=""  S PSOCSITE="" D
"RTN","PSODGAL2",112,0)
 ...S ZDATE=$P(ZDATA,"|",3),ZDATE=$S(ZDATE'="":$E(ZDATE,4,5)_"/"_$E(ZDATE,6,7)_"/"_$E(ZDATE,2,3),1:"")
"RTN","PSODGAL2",113,0)
 ...S PSOCSITE=$$GET1^DIQ(4,$P(ZDATA,"|",2),.01,"E")
"RTN","PSODGAL2",114,0)
 ...I PSOCSITE="" S PSOCSITE=$S(PSOCSITE'="":PSOCSITE,ZLOC="L":"LOCAL",ZLOC="R":"REMOTE",1:"Not Given")
"RTN","PSODGAL2",115,0)
 ...S PSOCAR=PSOCAR_", "_PSOCSITE_" - "_ZDATE
"RTN","PSODGAL2",116,0)
 .;
"RTN","PSODGAL2",117,0)
 .;
"RTN","PSODGAL2",118,0)
 .I PSOCAR="" S PSOCAR=CAUS
"RTN","PSODGAL2",119,0)
 .;OP will only have one drug
"RTN","PSODGAL2",120,0)
 .;I $D(^ORD(100.05,ZI,5,1,0)) S DRUGS=^ORD(100.05,ZI,5,1,0) I DRUGS'="" S DRUG=$$GET1^DIQ(50,DRUGS,.01,"E")
"RTN","PSODGAL2",121,0)
 .;D GETS^DIQ(100.05,ZI,"50*","E","DRUGS") S:$D(DRUGS(100.06,"1,"_ZI_",",.01,"E")) DRUG=DRUGS(100.06,"1,"_ZI_",",.01,"E")
"RTN","PSODGAL2",122,0)
 .S OH=$$UPPER($P(ZALL,"^",6)),^TMP("PSODAOCD",$J,"OH")=OH
"RTN","PSODGAL2",123,0)
 .S IEN=$G(IEN)+1,^TMP("PSOAL",$J,IEN,0)="   Prospective Drug: "_PROSPECT,PRTFLG=1
"RTN","PSODGAL2",124,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=58,DIWF=""
"RTN","PSODGAL2",125,0)
 .S X=PSOCAR
"RTN","PSODGAL2",126,0)
 .D ^DIWP S FIRST=1
"RTN","PSODGAL2",127,0)
 .F ZCX=0:0 S ZCX=$O(^UTILITY($J,"W",1,ZCX)) Q:'ZCX  S:$D(^UTILITY($J,"W",1,ZCX,0)) IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S(FIRST:"    Causative Agent: "_^UTILITY($J,"W",1,ZCX,0),1:"                     "_^UTILITY($J,"W",1,ZCX,0)) S FIRST=0
"RTN","PSODGAL2",128,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Historical/Observed: "_$S(OH="H":"HISTORICAL",OH="O":"OBSERVED",1:"Not Entered")
"RTN","PSODGAL2",129,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="           Severity: "_$G(SEVN)
"RTN","PSODGAL2",130,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=58,DIWF=""
"RTN","PSODGAL2",131,0)
 .;
"RTN","PSODGAL2",132,0)
 .; DRUG INGREDIENT
"RTN","PSODGAL2",133,0)
 .S FLAG=0
"RTN","PSODGAL2",134,0)
 .K ^TMP("PSODAOCD",$J,"DI")
"RTN","PSODGAL2",135,0)
 .F ZZQ=0:0 S ZZQ=$O(^ORD(100.05,ZI,4,XXI,2,ZZQ)) Q:'ZZQ  S ^TMP("PSODAOCD",$J,"DI",$P(^PS(50.416,$P(^ORD(100.05,ZI,4,XXI,2,ZZQ,0),"^"),0),"^"))="",FLAG=1
"RTN","PSODGAL2",136,0)
 .S X=""
"RTN","PSODGAL2",137,0)
 .F  S ING=$O(^TMP("PSODAOCD",$J,"DI",ING)) Q:ING=""  S X=X_", "_ING
"RTN","PSODGAL2",138,0)
 .S X=$E(X,3,999)
"RTN","PSODGAL2",139,0)
 .I X'="" D
"RTN","PSODGAL2",140,0)
 ..D ^DIWP
"RTN","PSODGAL2",141,0)
 ..S FIRST=1
"RTN","PSODGAL2",142,0)
 ..F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S:$D(^UTILITY($J,"W",1,ZX,0)) IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S(FIRST:"        Ingredients: "_^UTILITY($J,"W",1,ZX,0),1:"                      "_^UTILITY($J,"W",1,ZX,0)) S FIRST=0
"RTN","PSODGAL2",143,0)
 .;
"RTN","PSODGAL2",144,0)
 .; SIGNS/SYMPTOMS
"RTN","PSODGAL2",145,0)
 .K ^UTILITY($J,"W"),^TMP("PSODAOCD",$J,"SS") S DIWL=1,DIWR=58,DIWF="",ING=""
"RTN","PSODGAL2",146,0)
 .S (X,SIGNS,SIGN)="",SIGNS=$G(PSOASORT(PROSPECT,PSOASEV,PSOREA,PSOREA2,2))
"RTN","PSODGAL2",147,0)
 .I SIGNS'="" F ZZQ=1:1 S SIGN=$P(SIGNS,"|",ZZQ) Q:SIGN=""  D
"RTN","PSODGAL2",148,0)
 ..I $G(^GMRD(120.83,SIGN,0))]"" S ^TMP("PSODAOCD",$J,"SS",$P(^GMRD(120.83,SIGN,0),"^"))=""
"RTN","PSODGAL2",149,0)
 .S X="",FIRST=1
"RTN","PSODGAL2",150,0)
 .I $O(^TMP("PSODAOCD",$J,"SS",""))]"" S SS="" D
"RTN","PSODGAL2",151,0)
 ..F  S SS=$O(^TMP("PSODAOCD",$J,"SS",SS)) Q:SS=""  S X=X_", "_SS
"RTN","PSODGAL2",152,0)
 .S X=$E(X,3,999) S:X="" X="None Entered" D ^DIWP
"RTN","PSODGAL2",153,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S(FIRST:"     Signs/Symptoms: "_^UTILITY($J,"W",1,ZX,0),1:"                     "_^UTILITY($J,"W",1,ZX,0)) S FIRST=0
"RTN","PSODGAL2",154,0)
 .K ^UTILITY($J,"W")
"RTN","PSODGAL2",155,0)
 .;
"RTN","PSODGAL2",156,0)
 .; DRUG CLASS
"RTN","PSODGAL2",157,0)
 .S DIWL=1,DIWR=58,DIWF="" K ^TMP("PSODAOCD",$J,"DC")
"RTN","PSODGAL2",158,0)
 .F ZZQ=0:0 S ZZQ=$O(^ORD(100.05,ZI,4,XXI,1,ZZQ)) Q:'ZZQ  S ^TMP("PSODAOCD",$J,"DC",$P(^ORD(100.05,ZI,4,XXI,1,ZZQ,0),"^"))=$P(^PS(50.605,$P(^ORD(100.05,ZI,4,XXI,1,ZZQ,0),"^"),0),"^")_" "_$P(^(0),"^",2)
"RTN","PSODGAL2",159,0)
 .S X="",FIRST=1
"RTN","PSODGAL2",160,0)
 .F DC=0:0 S DC=$O(^TMP("PSODAOCD",$J,"DC",DC)) Q:'DC  S X=X_", "_^TMP("PSODAOCD",$J,"DC",DC)  D
"RTN","PSODGAL2",161,0)
 ..I $L(X)>234 S X=$E(X,3,999) D ^DIWP S X=""
"RTN","PSODGAL2",162,0)
 .I X'="" S X=$E(X,3,999)
"RTN","PSODGAL2",163,0)
 .I X'="" D
"RTN","PSODGAL2",164,0)
 ..D ^DIWP
"RTN","PSODGAL2",165,0)
 ..F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S(FIRST:"         Drug Class: "_^UTILITY($J,"W",1,ZX,0),1:"                     "_^UTILITY($J,"W",1,ZX,0)) S FIRST=0
"RTN","PSODGAL2",166,0)
 ..K ^UTILITY($J,"W") N Z,ZX
"RTN","PSODGAL2",167,0)
 ;
"RTN","PSODGAL2",168,0)
 D INV  ; intervention
"RTN","PSODGAL2",169,0)
 Q
"RTN","PSODGAL2",170,0)
 ;
"RTN","PSODGAL2",171,0)
UPPER(PSOUCS) ;
"RTN","PSODGAL2",172,0)
 Q $TR(PSOUCS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSODGAL2",173,0)
 ;
"RTN","PSODGAL2",174,0)
LOWER(PSOLCS) ;
"RTN","PSODGAL2",175,0)
 Q $TR(PSOLCS,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","PSODGAL2",176,0)
 ;
"RTN","PSODGAL2",177,0)
EXT ;
"RTN","PSODGAL2",178,0)
 K DIR,DUOUT,DIRUT,ZFND
"RTN","PSODGAL2",179,0)
 D FF
"RTN","PSODGAL2",180,0)
 I $D(DIRUT) G EXIT
"RTN","PSODGAL2",181,0)
 Q
"RTN","PSODGAL2",182,0)
EXIT ;
"RTN","PSODGAL2",183,0)
 S VALMBCK="R" K DIR,DUOUT,DIRUT,ZFND,^TMP("PSODAOCD",$J),^TMP("PSOAL",$J),ZPGK
"RTN","PSODGAL2",184,0)
 Q
"RTN","PSODGAL2",185,0)
 ;
"RTN","PSODGAL2",186,0)
INV ;display intervention
"RTN","PSODGAL2",187,0)
 ;changed to add Provider & Pharmacist and put in correct sequence [ST - 6.17.2014]
"RTN","PSODGAL2",188,0)
 S IEN=$G(IEN)+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSODGAL2",189,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=55,DIWF=""
"RTN","PSODGAL2",190,0)
 S PSOPROV="",PSOPROV="N/A - Order Check Not Evaluated by Provider"
"RTN","PSODGAL2",191,0)
 I $O(^TMP("PSODAOCD",$J,"AOR",""))]"" S PSOPROV=$O(^TMP("PSODAOCD",$J,"AOR",""))
"RTN","PSODGAL2",192,0)
 S X=PSOPROV,FIRST=1 D ^DIWP
"RTN","PSODGAL2",193,0)
 F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$S(FIRST:"Provider Override Reason: "_^UTILITY($J,"W",1,ZX,0),1:"                          "_^UTILITY($J,"W",1,ZX,0)) S FIRST=0
"RTN","PSODGAL2",194,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSODGAL2",195,0)
 ;
"RTN","PSODGAL2",196,0)
 I $P($G(^ORD(100.05,ZI,8)),"^")="" D  Q
"RTN","PSODGAL2",197,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Pharmacist Intervention Not Entered"
"RTN","PSODGAL2",198,0)
 K DIC,DR,DIQ,DA,INTY S DIC=9009032.4,DA=$P($G(^ORD(100.05,ZI,8)),"^"),DR=".01;.03;.04;.08",DIQ="INTY" D EN^DIQ1
"RTN","PSODGAL2",199,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Intervention Date: "_INTY(9009032.4,DA,.01)
"RTN","PSODGAL2",200,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="         Provider: "_$S($G(INTY(9009032.4,DA,.03))]"":INTY(9009032.4,DA,.03),1:"Not Entered")
"RTN","PSODGAL2",201,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="       Pharmacist: "_$S($G(INTY(9009032.4,DA,.04))]"":INTY(9009032.4,DA,.04),1:"Not Entered")
"RTN","PSODGAL2",202,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="   Recommendation: "_INTY(9009032.4,DA,.08)
"RTN","PSODGAL2",203,0)
 K DIC,DR,DIQ,DA,INTY
"RTN","PSODGAL2",204,0)
 Q
"RTN","PSODGAL2",205,0)
 ;
"RTN","PSODGAL2",206,0)
FF ;
"RTN","PSODGAL2",207,0)
 W !
"RTN","PSODGAL2",208,0)
 S DIR(0)="E",DIR("A")="Press Return to Continue",DIR("?")="Press Return to Redisplay Rx."
"RTN","PSODGAL2",209,0)
 D ^DIR S:$D(DUOUT)!($D(DTOUT)) PSOQUIT=1
"RTN","PSODGAL2",210,0)
 K DIR,DUOUT,DIRUT,DTOUT,L
"RTN","PSODGAL2",211,0)
 W @IOF
"RTN","PSODGAL2",212,0)
 Q
"RTN","PSODGAL3")
0^9^B172651497
"RTN","PSODGAL3",1,0)
PSODGAL3 ; BIR/LC,SAB,CMF - enhanced DRUG ALLERGY REACTION CHECKING continued ;12/09/07  02:22
"RTN","PSODGAL3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**411**;DEC 1997;Build 95
"RTN","PSODGAL3",3,0)
 ;External reference to ^XTMP("ORRDI" supported by DBIA 4659
"RTN","PSODGAL3",4,0)
 ;
"RTN","PSODGAL3",5,0)
SORTN ;
"RTN","PSODGAL3",6,0)
 N STYP,INGLOC,ZALL,ZLOC,ZCDATE,PSOSYM,PSOCDATE,PSOCA2,INGREDS,PSOREACT,PSOSDATA,SEVT,PSOAFLG,INGRED,PSOACNT,PSOAFEND
"RTN","PSODGAL3",7,0)
 N INGREDS,INGREDZ,ZXX,PSOSSITE,PSOSARRY,SETTMP,PSOLOC,ZCNT,ZING,ZMSG,PSOATYPE,PSODGCLS,PSODGCL,PSODGCL1 K ZGMRA
"RTN","PSODGAL3",8,0)
 S ZCNT=0
"RTN","PSODGAL3",9,0)
 ;
"RTN","PSODGAL3",10,0)
 I $G(PSOTSTMD) D TSTREM
"RTN","PSODGAL3",11,0)
 ;  
"RTN","PSODGAL3",12,0)
 K PSOSORT,PSOSEV,PSOSEVP,PSOSTYP,PSOCAGNT,PSOCA
"RTN","PSODGAL3",13,0)
 S (ZALL,ZING,ZMSG,PSOSYMS)=""
"RTN","PSODGAL3",14,0)
 ;DRUG INGREDIENTS
"RTN","PSODGAL3",15,0)
 F  S ZMSG=$O(GMRARSLT(ZMSG)) Q:ZMSG=""  D 
"RTN","PSODGAL3",16,0)
 .S ZALL=$$GMSGPTR^PSODGAL1(ZMSG)
"RTN","PSODGAL3",17,0)
 .Q:ZALL=""
"RTN","PSODGAL3",18,0)
 .S PSODRCL=0
"RTN","PSODGAL3",19,0)
 .S PSOATYPE=2
"RTN","PSODGAL3",20,0)
 .S:$D(GMRARSLT(ZMSG,"MESSAGE","OFFENDERS","CLS")) PSODRCL=1,PSOATYPE=1
"RTN","PSODGAL3",21,0)
 .D SORTM
"RTN","PSODGAL3",22,0)
 .Q
"RTN","PSODGAL3",23,0)
 D TMP
"RTN","PSODGAL3",24,0)
 Q
"RTN","PSODGAL3",25,0)
 ;
"RTN","PSODGAL3",26,0)
SORTM ;
"RTN","PSODGAL3",27,0)
 N SITEARY,PSOONEA,ZSITES,ZSITE,ZYALL
"RTN","PSODGAL3",28,0)
 S (PSOSEV,PSOSEVT,PSOSTYP,PSOLOC,PSOSYM,INGREDS,PSOREACT,INGLOC,PSOSDATA,PSOSSITE,PSOSITT)=""
"RTN","PSODGAL3",29,0)
 S PSOSSITE=$P(GMRARSLT(ZMSG,ZALL),U)
"RTN","PSODGAL3",30,0)
 S PSOLOC=PSOSSITE_"|"_$P(GMRARSLT(ZMSG,ZALL),U)
"RTN","PSODGAL3",31,0)
 S PSOSEV=$$GETSEV(PSOSSITE,ZMSG,.GMRARSLT)
"RTN","PSODGAL3",32,0)
 S PSOSEVT=$S(PSOSEV="SEVERE":1,PSOSEV="MODERATE":2,PSOSEV="MILD":3,1:99)
"RTN","PSODGAL3",33,0)
 S PSOSEVP=PSOSEV
"RTN","PSODGAL3",34,0)
 S PSOSTYP=PSOSEVT
"RTN","PSODGAL3",35,0)
 S:PSOSEVT=1 PSOSEVT1("S")=1
"RTN","PSODGAL3",36,0)
 S ZSITES=GMRARSLT(ZMSG,"MESSAGE",1)
"RTN","PSODGAL3",37,0)
 S PSOSDATA=""
"RTN","PSODGAL3",38,0)
 S ZYALL=""
"RTN","PSODGAL3",39,0)
 F ZSITE=1:1:ZSITES D 
"RTN","PSODGAL3",40,0)
 .S ZYALL=$$GMSGPTR^PSODGAL1(ZMSG,ZYALL)
"RTN","PSODGAL3",41,0)
 .S INGLOC=$S($P(GMRARSLT(ZMSG,ZYALL),U,2)="L":"L",1:"R")
"RTN","PSODGAL3",42,0)
 .S PSOCDATE=$P($P(GMRARSLT(ZMSG,ZYALL),U,3),".")
"RTN","PSODGAL3",43,0)
 .S PSOCDATE=$E(PSOCDATE,4,5)_"/"_$E(PSOCDATE,6,7)_"/"_$E(PSOCDATE,2,3)
"RTN","PSODGAL3",44,0)
 .S PSOSYM=$P(GMRARSLT(ZMSG,ZYALL),U,5)
"RTN","PSODGAL3",45,0)
 .S PSOREACT=$P(GMRARSLT(ZMSG,"MESSAGE",2),U,2)
"RTN","PSODGAL3",46,0)
 .S PSOSITT=$P(GMRARSLT(ZMSG,ZYALL),U)
"RTN","PSODGAL3",47,0)
 .S PSOSDATA=PSOSDATA_$S(ZSITE=1:"",1:U)_ZMSG_"|"_PSOCDATE_"|"_INGLOC_"|"_PSOSITT
"RTN","PSODGAL3",48,0)
 .S SITEARY=""
"RTN","PSODGAL3",49,0)
 .S SITEARY=INGLOC_"|"_$E(PSOSSITE,1,16)_"|"_PSOSITT_"|"_$S($D(^DIC(4,PSOSITT)):PSOSITT,1:"")
"RTN","PSODGAL3",50,0)
 .S PSOSARRY(PSOSTYP,SITEARY,PSOATYPE,PSOREACT,ZMSG)=$S(PSOATYPE=1:PSOREACT,1:"") ;; bp/cmf needed for TMP call when filing data in MOCHA 2.1 Sprint 8 or later
"RTN","PSODGAL3",51,0)
 .;
"RTN","PSODGAL3",52,0)
 .F INGREDZ="CLS","ING" D 
"RTN","PSODGAL3",53,0)
 ..S (INGRED,INGREDS)="",INGREDS=$G(GMRARSLT(ZMSG,"MESSAGE","OFFENDERS",INGREDZ))
"RTN","PSODGAL3",54,0)
 ..N III F III=1:1 S INGRED=$P(INGREDS,"~",III) Q:INGRED=""  D
"RTN","PSODGAL3",55,0)
 ...I '$D(PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)) S PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)=PSOSDATA D SYM
"RTN","PSODGAL3",56,0)
 ...E  S (OLDDATA,PSOCA)="",OLDDATA=PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE) S:OLDDATA'[PSOSDATA PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)=PSOSDATA D SYM
"RTN","PSODGAL3",57,0)
 ...;E  S (OLDDATA,PSOCA)="",OLDDATA=PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE) S:OLDDATA'[PSOSDATA PSOCA=PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)_"^"_PSOSDATA,PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE)=PSOCA D SYM
"RTN","PSODGAL3",58,0)
 ...S PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE,INGRED)="" D SYM
"RTN","PSODGAL3",59,0)
 ...Q:INGREDZ="ING"
"RTN","PSODGAL3",60,0)
 ...I $G(PSODRCL) S PSODRCL1(PSOSTYP,PSOREACT,PSOATYPE,INGRED)="" K PSOCAGNT(PSOSTYP,PSOREACT,PSOATYPE,INGRED)
"RTN","PSODGAL3",61,0)
 Q
"RTN","PSODGAL3",62,0)
 ;
"RTN","PSODGAL3",63,0)
SYM ;  
"RTN","PSODGAL3",64,0)
 I PSOSYM'["~"&(PSOSYM'="")&(PSOSYM'="|") D  Q
"RTN","PSODGAL3",65,0)
 .S PSOSYM("Name")=$$GETSYMNM(ZYALL,PSOSYM,1)
"RTN","PSODGAL3",66,0)
 .Q:PSOSYM("Name")=""
"RTN","PSODGAL3",67,0)
 .S PSOSYMS(PSOSTYP,PSOREACT,PSOATYPE,"ZZZSYMPTOMS",PSOSYM("Name"))=PSOSYM
"RTN","PSODGAL3",68,0)
 .S PSOSARRY(PSOSTYP,SITEARY,PSOATYPE,PSOREACT,ZMSG,"ZZZSYMPTOMS",PSOSYM("Name"))=PSOSYM
"RTN","PSODGAL3",69,0)
 Q:PSOSYM="|"
"RTN","PSODGAL3",70,0)
 N PSOQX,PSOY
"RTN","PSODGAL3",71,0)
 I $E(PSOSYM,1)="~" S PSOSYM=$E(PSOSYM,2,9999)
"RTN","PSODGAL3",72,0)
 F PSOQX=1:1:$L(PSOSYM,"~") D 
"RTN","PSODGAL3",73,0)
 .S PSOY=$P(PSOSYM,"~",PSOQX)
"RTN","PSODGAL3",74,0)
 .Q:PSOY=""
"RTN","PSODGAL3",75,0)
 .S PSOSYM("Name")=$$GETSYMNM(ZYALL,PSOY,PSOQX)
"RTN","PSODGAL3",76,0)
 .Q:PSOSYM("Name")=""
"RTN","PSODGAL3",77,0)
 .S PSOSYMS(PSOSTYP,PSOREACT,PSOATYPE,"ZZZSYMPTOMS",PSOSYM("Name"))=PSOY
"RTN","PSODGAL3",78,0)
 .S PSOSARRY(PSOSTYP,SITEARY,PSOATYPE,PSOREACT,ZMSG,"ZZZSYMPTOMS",PSOSYM("Name"))=PSOY
"RTN","PSODGAL3",79,0)
 Q
"RTN","PSODGAL3",80,0)
 ;
"RTN","PSODGAL3",81,0)
TMP ;
"RTN","PSODGAL3",82,0)
 ;PSOPAIEN - IEN TO PATIENT ALLERGY FILE 120.8
"RTN","PSODGAL3",83,0)
 N PSOSEVER,OLDDATA,PSOLCLAC,PSOPAIEN,TYPE,SITENM,PSOLCLAS,PSOLOCAL,PSOREACT,ZCNT2,DACNT,LOCREM,PSOATYP
"RTN","PSODGAL3",84,0)
 N PSOINSTL,PSOSTA,PSOHIS,PSOHISI,PSOASEV,PSOSEVI,PSOSEVT,PSOSTYP,PSOSTYPI,PSOMEDL,PSODGCL,PSOLOCI,SITE
"RTN","PSODGAL3",85,0)
 N PSOREACT,ZMSG
"RTN","PSODGAL3",86,0)
 S (TYPE,SITENM,PSOPAIEN,ZALL,PSOSYM,PSOLCLAC,PSOATYP,PSOSEVER,PSOATYPE,PSOREACT)="",(ZCNT2,DACNT)=0
"RTN","PSODGAL3",87,0)
 F  S PSOSEVER=$O(PSOSARRY(PSOSEVER)) Q:PSOSEVER=""  S TYPE="" F  S TYPE=$O(PSOSARRY(PSOSEVER,TYPE)) Q:TYPE=""  D 
"RTN","PSODGAL3",88,0)
 .S PSOATYPE=""
"RTN","PSODGAL3",89,0)
 .F  S PSOATYPE=$O(PSOSARRY(PSOSEVER,TYPE,PSOATYPE)) Q:PSOATYPE=""  S PSOREACT="" F  S PSOREACT=$O(PSOSARRY(PSOSEVER,TYPE,PSOATYPE,PSOREACT)) Q:PSOREACT=""  D 
"RTN","PSODGAL3",90,0)
 ..S ZMSG=""
"RTN","PSODGAL3",91,0)
 ..S ZMSG=$O(PSOSARRY(PSOSEVER,TYPE,PSOATYPE,PSOREACT,ZMSG))
"RTN","PSODGAL3",92,0)
 ..Q:ZMSG=""
"RTN","PSODGAL3",93,0)
 ..S PSOPAIEN=$$GMSGPTR^PSODGAL1(ZMSG) Q:PSOPAIEN=""  D 
"RTN","PSODGAL3",94,0)
 ...S (PSODRCL,ZALL,SITE,SITENM,LOCREM)=""
"RTN","PSODGAL3",95,0)
 ...S SITE=$P(TYPE,"|",3),LOCREM=$P(TYPE,"|"),SITENM=$P(TYPE,"|",2)
"RTN","PSODGAL3",96,0)
 ...S ZALL=GMRARSLT(ZMSG,PSOPAIEN)
"RTN","PSODGAL3",97,0)
 ...I PSOATYPE=2 S PSOATYP=2
"RTN","PSODGAL3",98,0)
 ...I PSOATYPE=1 S PSOATYP=1,PSODRCL=1
"RTN","PSODGAL3",99,0)
 ...Q:ZALL=""
"RTN","PSODGAL3",100,0)
 ...D TMPSET
"RTN","PSODGAL3",101,0)
 Q
"RTN","PSODGAL3",102,0)
 ;
"RTN","PSODGAL3",103,0)
TMPSET ;
"RTN","PSODGAL3",104,0)
 S DACNT=DACNT+1 N II,III,PTR,DATEI K SETTMP
"RTN","PSODGAL3",105,0)
 S PSOHISI=$P(ZALL,U,8)
"RTN","PSODGAL3",106,0)
 S PSOSEVI=$$GETSEVI(ZALL)
"RTN","PSODGAL3",107,0)
 S PSODGCL="",PSOLOCAL=$P(ZALL,"^",3),PSOLOCI=$P($P(ZALL,"^",3),"|",2)
"RTN","PSODGAL3",108,0)
 S DATEI=$P(ZALL,U,3)
"RTN","PSODGAL3",109,0)
 S PTR=$P(ZALL,U,7)
"RTN","PSODGAL3",110,0)
 ;ZERO NODE OF DRUG ALLERGY MULTIPLE
"RTN","PSODGAL3",111,0)
 S SETTMP(DACNT,0)=$E(PSOREACT,1,64)_U_PTR_U_LOCREM_U_SITE
"RTN","PSODGAL3",112,0)
 S SETTMP(DACNT,0)=SETTMP(DACNT,0)_U_DATEI_U_$$UPPER(PSOHISI)_U_PSOSEVI
"RTN","PSODGAL3",113,0)
 S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,4,DACNT,0)=SETTMP(DACNT,0)
"RTN","PSODGAL3",114,0)
 ;DRUG CLASS
"RTN","PSODGAL3",115,0)
 I PSOATYP'=1 D 
"RTN","PSODGAL3",116,0)
 .S PSODGCL=$G(GMRARSLT(ZMSG,PSOPAIEN,"CLS"))
"RTN","PSODGAL3",117,0)
 .I $E(PSODGCL,1)="~" S PSODGCL=$E(PSODGCL,2,999)
"RTN","PSODGAL3",118,0)
 I PSOATYP=1 D 
"RTN","PSODGAL3",119,0)
 .S PSODGCLS=$G(GMRARSLT(ZMSG,PSOPAIEN,"CLS"))
"RTN","PSODGAL3",120,0)
 .I $E(PSODGCLS,1)="~" S PSODGCLS=$E(PSODGCLS,2,999)
"RTN","PSODGAL3",121,0)
 .S PSODGCL=""
"RTN","PSODGAL3",122,0)
 .N II
"RTN","PSODGAL3",123,0)
 .F II=1:1 S PSODGCL=$P(PSODGCLS,"~",II) Q:PSODGCL=""  D 
"RTN","PSODGAL3",124,0)
 ..S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,4,DACNT,1,II,0)=PSODGCL
"RTN","PSODGAL3",125,0)
 ..Q
"RTN","PSODGAL3",126,0)
 ;DRUG INGREDIENT
"RTN","PSODGAL3",127,0)
 D:$D(GMRARSLT(ZMSG,PSOPAIEN,"ING")) 
"RTN","PSODGAL3",128,0)
 .S INGREDS=GMRARSLT(ZMSG,PSOPAIEN,"ING")
"RTN","PSODGAL3",129,0)
 .I $E(INGREDS,1)="~" S INGREDS=$E(INGREDS,2,999)
"RTN","PSODGAL3",130,0)
 .N II
"RTN","PSODGAL3",131,0)
 .F II=1:1 S INGRED=$P(INGREDS,"~",II) Q:INGRED=""  D 
"RTN","PSODGAL3",132,0)
 ..S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,4,DACNT,2,II,0)=INGRED
"RTN","PSODGAL3",133,0)
 ..Q
"RTN","PSODGAL3",134,0)
 ;SIGN/SYMPTOM
"RTN","PSODGAL3",135,0)
 N PSOSYMN,SYMCNT S SYMCNT=0,PSOSYMN=""
"RTN","PSODGAL3",136,0)
 F  S PSOSYMN=$O(PSOSARRY(PSOSEVER,TYPE,PSOATYPE,PSOREACT,ZMSG,"ZZZSYMPTOMS",PSOSYMN)) Q:PSOSYMN=""  D 
"RTN","PSODGAL3",137,0)
 .S SYMCNT=SYMCNT+1
"RTN","PSODGAL3",138,0)
 .S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,4,DACNT,3,SYMCNT,0)=PSOSARRY(PSOSEVER,TYPE,PSOATYPE,PSOREACT,ZMSG,"ZZZSYMPTOMS",PSOSYMN)
"RTN","PSODGAL3",139,0)
 ;DISPENSE DRUG
"RTN","PSODGAL3",140,0)
 S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,"ALLERGY DD",5,1,0)=$S(PSOATYP=1!(PSOATYP=2):$G(PSODRUG("IEN")),PSOATYP=3:$P(ZALL,"^",2),1:"")
"RTN","PSODGAL3",141,0)
 S ^TMP("PSODAOC",$J,"ALLERGY",PSJALGCT,"ALLERGY PKG")=$S($G(PSJAOC):"IP",1:"OP")
"RTN","PSODGAL3",142,0)
 S ^TMP("PSODAOC",$J,"ALLERGY","PROVR")=""
"RTN","PSODGAL3",143,0)
END ;
"RTN","PSODGAL3",144,0)
 Q
"RTN","PSODGAL3",145,0)
 ;
"RTN","PSODGAL3",146,0)
GETSEV(PSOSSITE,ZMSG,GMRARSLT) ; return external highest severity for possible local multiple
"RTN","PSODGAL3",147,0)
 N RESULT,ARRAY,I,SEV
"RTN","PSODGAL3",148,0)
 S RESULT=""
"RTN","PSODGAL3",149,0)
 Q:'$D(GMRARSLT) RESULT
"RTN","PSODGAL3",150,0)
 Q:'$D(PSOSSITE) RESULT
"RTN","PSODGAL3",151,0)
 Q:'$D(GMRARSLT(ZMSG)) RESULT
"RTN","PSODGAL3",152,0)
 S I=0
"RTN","PSODGAL3",153,0)
 F  S I=$O(GMRARSLT(ZMSG,"MESSAGE",1,PSOSSITE,1,I)) Q:'I  D 
"RTN","PSODGAL3",154,0)
 .S SEV=$P($G(GMRARSLT(ZMSG,"MESSAGE",1,PSOSSITE,1,I)),U,2)
"RTN","PSODGAL3",155,0)
 .S ARRAY($S(SEV="SEVERE":1,SEV="MODERATE":2,SEV="MILD":3,1:99))=SEV
"RTN","PSODGAL3",156,0)
 .Q
"RTN","PSODGAL3",157,0)
 I $D(ARRAY) S I=$O(ARRAY("")),RESULT=ARRAY(I)
"RTN","PSODGAL3",158,0)
 Q RESULT
"RTN","PSODGAL3",159,0)
 ;;
"RTN","PSODGAL3",160,0)
GETSEVI(ZALL) ; return internal highest severity for possible local multiple
"RTN","PSODGAL3",161,0)
 N RESULT,ARRAY,I,J,K,SEV
"RTN","PSODGAL3",162,0)
 S RESULT=""
"RTN","PSODGAL3",163,0)
 S SEV=$P($G(ZALL),U,4)
"RTN","PSODGAL3",164,0)
 I $E(SEV,1)="~" S SEV=$E(SEV,2,999)
"RTN","PSODGAL3",165,0)
 Q:SEV="" RESULT
"RTN","PSODGAL3",166,0)
 F I=1:1 S J=$P(SEV,"~",I) Q:J=""  D 
"RTN","PSODGAL3",167,0)
 .S K=$P(J,"|",2)
"RTN","PSODGAL3",168,0)
 .S:K'="" ARRAY(K)=J
"RTN","PSODGAL3",169,0)
 .Q
"RTN","PSODGAL3",170,0)
 I $D(ARRAY) S I=$O(ARRAY(""),-1),RESULT=I
"RTN","PSODGAL3",171,0)
 Q RESULT
"RTN","PSODGAL3",172,0)
 ;;
"RTN","PSODGAL3",173,0)
GETSYMNM(ZYALL,SYMIEN,SYMINC) ; getSymptomName(allergyResultIEN,symptomIEN,symptomIncrement)
"RTN","PSODGAL3",174,0)
 N RESULT
"RTN","PSODGAL3",175,0)
 S RESULT=""
"RTN","PSODGAL3",176,0)
 Q:$G(ZYALL)="" RESULT
"RTN","PSODGAL3",177,0)
 Q:$G(SYMIEN)="" RESULT
"RTN","PSODGAL3",178,0)
 Q:$G(SYMINC)="" RESULT
"RTN","PSODGAL3",179,0)
 Q:+SYMIEN'=30 $$GET1^DIQ(120.83,SYMIEN,.01)
"RTN","PSODGAL3",180,0)
 I +ZYALL=0 D  Q RESULT
"RTN","PSODGAL3",181,0)
 .;look at ^xtmp("orrdi","art" here for remote data 'OTHER REACTION' text
"RTN","PSODGAL3",182,0)
 .N ORRDIEN
"RTN","PSODGAL3",183,0)
 .S ORRDIEN=$P(ZYALL,"R",2)
"RTN","PSODGAL3",184,0)
 .Q:ORRDIEN=""
"RTN","PSODGAL3",185,0)
 .S:+$G(DFN) RESULT=$P($G(^XTMP("ORRDI","ART",DFN,ORRDIEN,"SIGNS/SYMPTOMS",SYMINC)),U,2)
"RTN","PSODGAL3",186,0)
 .Q
"RTN","PSODGAL3",187,0)
 I +ZYALL>0 D  Q RESULT
"RTN","PSODGAL3",188,0)
 .;call GMRADPT here, look at GMRAL for local data 'OTHER REACTION' text
"RTN","PSODGAL3",189,0)
 .N GMRAL
"RTN","PSODGAL3",190,0)
 .D ^GMRADPT
"RTN","PSODGAL3",191,0)
 .S RESULT=$P($G(GMRAL(ZYALL,"S",SYMINC)),";")
"RTN","PSODGAL3",192,0)
 .K GMRAL
"RTN","PSODGAL3",193,0)
 Q RESULT
"RTN","PSODGAL3",194,0)
 ;
"RTN","PSODGAL3",195,0)
UPPER(PSOUCS) ;
"RTN","PSODGAL3",196,0)
 Q $TR(PSOUCS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSODGAL3",197,0)
 ;
"RTN","PSODGAL3",198,0)
TSTREM ;For remote developer testing
"RTN","PSODGAL3",199,0)
 ;1. complex mix of local/remote results: set a break at SORTN^PSODGAL3, results will not match the order but will be the complex dummy for all, at the break set S PSOTSTMD=1, type G for Go.
"RTN","PSODGAL3",200,0)
 ;2. Multiple Ingredient allergy:  set a break at SORTN^PSODGAL3, order PROPOFOL, and at the break set S PSOTSTMD=3, type G for Go.
"RTN","PSODGAL3",201,0)
 ;3. Drug class allergy:  set up allergy by drug class ANTILIPEMIC AGENTS and order LIPITOR and at the break set S PSOTSTMD=2, type G for Go.
"RTN","PSODGAL3",202,0)
 ;
"RTN","PSODGAL3",203,0)
 Q:'$G(PSOTSTMD)
"RTN","PSODGAL3",204,0)
 I PSOTSTMD=1 G BIGARRAY
"RTN","PSODGAL3",205,0)
 I PSOTSTMD=2 G DRGCLASS
"RTN","PSODGAL3",206,0)
 I PSOTSTMD=3 G MULTI
"RTN","PSODGAL3",207,0)
 ;
"RTN","PSODGAL3",208,0)
SINGLE ;Test Remote with a single ingredient
"RTN","PSODGAL3",209,0)
 ;ICR:           IEN     NAME          1       2            3                            4          5                 6                7                         8       9     10   11               
"RTN","PSODGAL3",210,0)
 ;PIECE:          1        2           3       4            5                            6          7                 8                9                        10      11     12   13        
"RTN","PSODGAL3",211,0)
 S GMRAING("R1")="GUAIFENESIN|744^MARTINSBURG VAMC|613^REMOTE|R^Jun 20, 2013@15:52|3130620.1552^SEVERE|3^DROWSINESS|66~HIVES|1~ANXIETY|39^GUAIFENESIN^GUAIFENESIN|1671;PSNDF(50.6,^HISTORICAL|h^VISTA|V"
"RTN","PSODGAL3",212,0)
 S GMRAING("R2")="GUAIFENESIN|744^HEARTLAND WEST VAMC|589^REMOTE|R^Aug 28, 2012@11:52|3120828.1552^SEVERE|3^DROWSINESS|66~HIVES|1^GUAIFENESIN^GUAIFENESIN|1671;PSNDF(50.6,^HISTORICAL|h^VISTA|V"
"RTN","PSODGAL3",213,0)
 S GMRAING("R3")="GUAIFENESIN|744^NEW ORLEANS, LA.|629^REMOTE|R^Oct 25, 2013@09:54|3131025.0954^MODERATE|2^DROWSINESS|66~HIVES|1^GUAIFENESIN^GUAIFENESIN|1671;PSNDF(50.6,^HISTORICAL|h^VISTA|V"
"RTN","PSODGAL3",214,0)
 S GMRAING("R4")="GUAIFENESIN|744^NEW YORK, NY|630^REMOTE|R^Apr 9, 2013@15:43|3130409.1143^MILD|1^DROWSINESS|66~HIVES|1^GUAIFENESIN^GUAIFENESIN|1671;PSNDF(50.6,^HISTORICAL|h^VISTA|V"
"RTN","PSODGAL3",215,0)
 Q
"RTN","PSODGAL3",216,0)
 ;
"RTN","PSODGAL3",217,0)
MULTI ;Test Remote with multiple ingredients
"RTN","PSODGAL3",218,0)
 S GMRAING("R7")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^HEARTLAND WEST VAMC|589^REMOTE|R^Oct 25, 2013@09:52|3131025.0952^SEVERVE|3^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",219,0)
 S GMRAING("R8")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^MARTINSBURG VAMC|613^REMOTE|R^SEP 30, 2013@01:52|3130930.1352^SEVERVE|3^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",220,0)
 S GMRAING("R10")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^NEW ORLEANS, LA.|629^REMOTE|R^Aug 15, 2013@11:52|3130515.1152^MODERATE|2^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",221,0)
 S GMRAING("R11")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^NEW YORK, NY|630^REMOTE|R^Aug 15, 2013@11:52|3130515.1152^MILD|1^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",222,0)
 S GMRAING("R12")="SODIUM METABISULFITE|69~PROPOFOL|2114~EGG|2361~SOYBEAN|3156~PEANUT|4048^MARTINSBURG VAMC|613^REMOTE|R^DEC 15, 2013@12:52|3131215.1252^MILD|1^ANXIETY|39^PROPOFOL^PROPOFOL|2145;PSNDF(50.6,OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",223,0)
 Q
"RTN","PSODGAL3",224,0)
 ;
"RTN","PSODGAL3",225,0)
DRGCLASS ;Test Remote Interaction by drug class
"RTN","PSODGAL3",226,0)
 K GMRAING,GMRADRCL,GMRAREAC
"RTN","PSODGAL3",227,0)
 S GMRADRCL("R1")="ANTILIPEMIC AGENTS|58^HEARTLAND WEST VAMC|589^REMOTE|R^Jan 28, 2014@10:56|3140128.1056^SEVERE|3^DIARRHEA|9~DROWSINESS|66~DRY NOSE|69^ANTILIPEMIC AGENTS^ANTILIPEMIC AGENTS|58;PS(50.605,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",228,0)
 S GMRADRCL("R2")="ANTILIPEMIC AGENTS|58^MARTINSBURG VAMC|613^REMOTE|R^Jan 15, 2014@09:56|3140115.0956^SEVERE|3^DIARRHEA|9~DROWSINESS|66~DRY NOSE|69^ANTILIPEMIC AGENTS^ANTILIPEMIC AGENTS|58;PS(50.605,^OBSERVED|o^VISTA|V"
"RTN","PSODGAL3",229,0)
 Q
"RTN","PSODGAL3",230,0)
 ;
"RTN","PSODGAL3",231,0)
BIGARRAY ;dummy big array with complex local/remote combinations.  Will not match drugs passed in
"RTN","PSODGAL3",232,0)
 K GMRARSLT
"RTN","PSODGAL3",233,0)
 S GMRARSLT=7
"RTN","PSODGAL3",234,0)
 S GMRARSLT(1,106534)="10881^L^3150528.1606^^^AMPICILLIN^79;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",235,0)
 S GMRARSLT(1,106534,"CLS")=249
"RTN","PSODGAL3",236,0)
 S GMRARSLT(1,"MESSAGE",1)=1
"RTN","PSODGAL3",237,0)
 S GMRARSLT(1,"MESSAGE",1,10881)="CLE13 TEST LAB^LOCAL^MAY 28, 2015@16:06^HISTORICAL"
"RTN","PSODGAL3",238,0)
 S GMRARSLT(1,"MESSAGE",2)="^AMPICILLIN^AMPICILLIN"
"RTN","PSODGAL3",239,0)
 S GMRARSLT(1,"MESSAGE","OFFENDERS","CLS")="AM111 PENICILLINS,AMINO DERIVATIVES"
"RTN","PSODGAL3",240,0)
 S GMRARSLT(2,106535)="10881^L^3150528.1607^^^MEROPENEM^3391;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",241,0)
 S GMRARSLT(2,106535,"CLS")=335
"RTN","PSODGAL3",242,0)
 S GMRARSLT(2,"MESSAGE",1)=2
"RTN","PSODGAL3",243,0)
 S GMRARSLT(2,"MESSAGE",1,10881)="CLE13 TEST LAB^LOCAL^MAY 28, 2015@16:07^HISTORICAL"
"RTN","PSODGAL3",244,0)
 S GMRARSLT(2,"MESSAGE",1,10882)="CHEYENNE HDR SQA^REMOTE^MAY 28, 2015@16:02^HISTORICAL"
"RTN","PSODGAL3",245,0)
 S GMRARSLT(2,"MESSAGE",2)="^MEROPENEM^MEROPENEM"
"RTN","PSODGAL3",246,0)
 S GMRARSLT(2,"MESSAGE","OFFENDERS","CLS")="AM119 BETA-LACTAMS ANTIMICROBIALS,OTHER"
"RTN","PSODGAL3",247,0)
 S GMRARSLT(2,"R9")="10882^R^3150528.1602^^^MEROPENEM^3391;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",248,0)
 S GMRARSLT(2,"R9","CLS")=335
"RTN","PSODGAL3",249,0)
 S GMRARSLT(3,"MESSAGE",1)=1
"RTN","PSODGAL3",250,0)
 S GMRARSLT(3,"MESSAGE",1,10882)="CHEYENNE HDR SQA^REMOTE^MAY 28, 2015@16:03^OBSERVED"
"RTN","PSODGAL3",251,0)
 S GMRARSLT(3,"MESSAGE",2)="RASH^CEPHALEXIN^CEPHALEXIN"
"RTN","PSODGAL3",252,0)
 S GMRARSLT(3,"MESSAGE","OFFENDERS","CLS")="AM115 CEPHALOSPORIN 1ST GENERATION"
"RTN","PSODGAL3",253,0)
 S GMRARSLT(3,"R11")="10882^R^3150528.1603^^133^CEPHALEXIN^1290;PSNDF(50.6,^o^V"
"RTN","PSODGAL3",254,0)
 S GMRARSLT(3,"R11","CLS")=12
"RTN","PSODGAL3",255,0)
 S GMRARSLT(4,"MESSAGE",1)=1
"RTN","PSODGAL3",256,0)
 S GMRARSLT(4,"MESSAGE",1,613)="MARTINSBURG VAMC^REMOTE^MAY 28, 2015@15:46^OBSERVED"
"RTN","PSODGAL3",257,0)
 S GMRARSLT(4,"MESSAGE",2)="ANAPHYLAXIS and DYSPNEA^CEFAZOLIN^CEFAZOLIN"
"RTN","PSODGAL3",258,0)
 S GMRARSLT(4,"MESSAGE","OFFENDERS","CLS")="AM115 CEPHALOSPORIN 1ST GENERATION"
"RTN","PSODGAL3",259,0)
 S GMRARSLT(4,"MESSAGE","OFFENDERS","ING")="CEFAZOLIN"
"RTN","PSODGAL3",260,0)
 S GMRARSLT(4,"R13")="613^R^3150528.1546^^5~70^CEFAZOLIN^30;PSNDF(50.6,^o^V"
"RTN","PSODGAL3",261,0)
 S GMRARSLT(4,"R13","CLS")=12
"RTN","PSODGAL3",262,0)
 S GMRARSLT(4,"R13","ING")=2278
"RTN","PSODGAL3",263,0)
 S GMRARSLT(5,"MESSAGE",1)=1
"RTN","PSODGAL3",264,0)
 S GMRARSLT(5,"MESSAGE",1,10882)="CHEYENNE HDR SQA^REMOTE^MAY 28, 2015@16:01^HISTORICAL"
"RTN","PSODGAL3",265,0)
 S GMRARSLT(5,"MESSAGE",2)="ITCHING OF EYE and WHEEZING^PENICILLIN^PENICILLIN"
"RTN","PSODGAL3",266,0)
 S GMRARSLT(5,"MESSAGE","OFFENDERS","CLS")="AM110 PENICILLIN-G RELATED PENICILLINS"
"RTN","PSODGAL3",267,0)
 S GMRARSLT(5,"R2")="10882^R^3150528.1601^^20~311^PENICILLIN^16;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",268,0)
 S GMRARSLT(5,"R2","CLS")=248
"RTN","PSODGAL3",269,0)
 S GMRARSLT(6,"MESSAGE",1)=1
"RTN","PSODGAL3",270,0)
 S GMRARSLT(6,"MESSAGE",1,613)="MARTINSBURG VAMC^REMOTE^MAY 28, 2015@15:50^OBSERVED"
"RTN","PSODGAL3",271,0)
 S GMRARSLT(6,"MESSAGE",2)="ANAPHYLAXIS^PENICILLIN^PENICILLIN"
"RTN","PSODGAL3",272,0)
 S GMRARSLT(6,"MESSAGE","OFFENDERS","CLS")="AM110 PENICILLIN-G RELATED PENICILLINS"
"RTN","PSODGAL3",273,0)
 S GMRARSLT(6,"R4")="613^R^3150528.155^^5~30^PENICILLIN^16;PSNDF(50.6,^o^V"
"RTN","PSODGAL3",274,0)
 S GMRARSLT(6,"R4","CLS")=248
"RTN","PSODGAL3",275,0)
 S ^XTMP("ORRDI","ART",DFN,4,"SIGNS/SYMPTOMS",2)="^Giggles^"
"RTN","PSODGAL3",276,0)
 S GMRARSLT(7,"MESSAGE",1)=1
"RTN","PSODGAL3",277,0)
 S GMRARSLT(7,"MESSAGE",1,613)="MARTINSBURG VAMC^REMOTE^MAY 28, 2015@15:50^HISTORICAL"
"RTN","PSODGAL3",278,0)
 S GMRARSLT(7,"MESSAGE",2)="^CEFEPIME^CEFEPIME"
"RTN","PSODGAL3",279,0)
 S GMRARSLT(7,"MESSAGE","OFFENDERS","CLS")="AM118 CEPHALOSPORIN 4TH GENERATION"
"RTN","PSODGAL3",280,0)
 S GMRARSLT(7,"R5")="613^R^3150528.155^^^CEFEPIME^3392;PSNDF(50.6,^h^V"
"RTN","PSODGAL3",281,0)
 S GMRARSLT(7,"R5","CLS")=524
"RTN","PSODGAL3",282,0)
 Q
"RTN","PSODGAL3",283,0)
 ;
"RTN","PSODRG")
0^2^B93593274
"RTN","PSODRG",1,0)
PSODRG ;IHS/DSD/JCM - ORDER ENTRY DRUG SELECTION ;2/16/12 12:50pm
"RTN","PSODRG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,23,36,53,54,46,112,139,207,148,243,268,324,251,375,387,398,390,427,411**;DEC 1997;Build 95
"RTN","PSODRG",3,0)
 ;Reference to ^PSDRUG( supported by DBIA 221
"RTN","PSODRG",4,0)
 ;Reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSODRG",5,0)
 ;Reference to $$PROMPT^PSSDIN supported by DBIA 3166
"RTN","PSODRG",6,0)
 ;Reference to EN^PSSDIN supported by DBIA 3166
"RTN","PSODRG",7,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSODRG",8,0)
 ;Reference to ^OROCAPI controlled subscription supported by DBIA 5367
"RTN","PSODRG",9,0)
 ;Reference to $$OITM^ORX8 supported by DBIA 5469
"RTN","PSODRG",10,0)
 ;Reference to ^VADPT supported by DBIA 10061
"RTN","PSODRG",11,0)
 ;Reference to IN^PSSHRQ2 supported by DBIA 5369
"RTN","PSODRG",12,0)
 ;Reference to ^XTMP("ORRDI" supported by DBIA 5440
"RTN","PSODRG",13,0)
 ;----------------------------------------------------------
"RTN","PSODRG",14,0)
START ;
"RTN","PSODRG",15,0)
 S (PSONEW("DFLG"),PSONEW("FIELD"),PSODRG("QFLG"))=0 K PSORX("DFLG")
"RTN","PSODRG",16,0)
 D @($S(+$G(PSOEDIT)=1&('$D(DA)):"SELECT^PSODRGN",1:"SELECT"))
"RTN","PSODRG",17,0)
 G:$G(PSORXED("DFLG")) END ; Select Drug
"RTN","PSODRG",18,0)
 I $G(PSORX("EDIT")),$G(PSOY),$G(PSODRUG("IEN"))=+PSOY D  G:$G(PSORXED("DFLG")) END
"RTN","PSODRG",19,0)
 . N NDC D NDC(+$G(PSORXED("IRXN")),0,+PSOY,.NDC) I $G(NDC)="^" S PSORXED("DFLG")=1 Q
"RTN","PSODRG",20,0)
 . I $G(NDC)'="" S (PSODRUG("NDC"),PSORXED("FLD",27))=NDC
"RTN","PSODRG",21,0)
 ;
"RTN","PSODRG",22,0)
 I $G(PSORX("EDIT"))]"",'PSONEW("FIELD") D TRADE
"RTN","PSODRG",23,0)
 G:$G(PSONEW("DFLG"))!($G(PSODRG("QFLG")))!($G(PSORXED("DFLG"))) END
"RTN","PSODRG",24,0)
 D SET ; Set various drug information
"RTN","PSODRG",25,0)
 D NFI ; Display dispense drug/orderable item text
"RTN","PSODRG",26,0)
 D:'$G(PSOEDIT) POST I $G(PSORX("DFLG")) S PSONEW("DFLG")=1 K:'$G(PSORX("EDIT")) PSORX("DFLG") ; Do any post selection action
"RTN","PSODRG",27,0)
END ;D EOJ
"RTN","PSODRG",28,0)
 Q
"RTN","PSODRG",29,0)
 ;------------------------------------------------------------
"RTN","PSODRG",30,0)
 ;
"RTN","PSODRG",31,0)
SELECT ;
"RTN","PSODRG",32,0)
 K:'$G(PSORXED) CLOZPAT
"RTN","PSODRG",33,0)
 K IT,DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW"),PSODRUG("BAD") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODRG",34,0)
 I $G(PSODRUG("IEN"))]"" S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODRG",35,0)
 W !,"DRUG: "_$S($G(Y)]"":Y_"// ",1:"") R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSODRG",36,0)
 I X="",$G(Y)]"" S:Y X=Y S:'X X=$G(PSODRUG("IEN")) S:X X="`"_X
"RTN","PSODRG",37,0)
 G:X="" SELECT
"RTN","PSODRG",38,0)
 I X?1."?" W !!,"Answer with DRUG NUMBER, or GENERIC NAME, or VA PRODUCT NAME, or",!,"NATIONAL DRUG CLASS, or SYNONYM" G SELECT
"RTN","PSODRG",39,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODRG",40,0)
 I X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",41,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODRG",42,0)
 S DIC=50,DIC(0)="EMQZVT",DIC("T")="",D="B^C^VAPN^VAC"
"RTN","PSODRG",43,0)
 S DIC("S")="I $S('$D(^PSDRUG(+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$S($P($G(^PSDRUG(+Y,2)),""^"",3)'[""O"":0,1:1),$D(^PSDRUG(""ASP"",+$G(^(2)),+Y))"
"RTN","PSODRG",44,0)
 D MIX^DIC1 K DIC,D
"RTN","PSODRG",45,0)
 I $D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",46,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODRG",47,0)
 I Y<0 G SELECT
"RTN","PSODRG",48,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODRG",49,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSODRG",50,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE
"RTN","PSODRG",51,0)
SELECTX K X,Y,DTOUT,DUOUT,PSONEW("OLD VAL")
"RTN","PSODRG",52,0)
 Q
"RTN","PSODRG",53,0)
 ;
"RTN","PSODRG",54,0)
NDC(RX,RFL,DRG,NDC) ; Editing NDC for Released Rx's or for Unresolved ECME Rejects
"RTN","PSODRG",55,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",56,0)
 ; Check if we should edit the NDC
"RTN","PSODRG",57,0)
 ; Needs to be released or have unresolved billable rejects (PSO*7*427)
"RTN","PSODRG",58,0)
 ;
"RTN","PSODRG",59,0)
 N PSOCONT S PSOCONT=0                         ; continue flag
"RTN","PSODRG",60,0)
 D  Q:'PSOCONT                                 ; get out if NDC edit not allowed
"RTN","PSODRG",61,0)
 . I $$RXRLDT^PSOBPSUT(RX,RFL) S PSOCONT=1 Q   ; Released - continue and allow edit
"RTN","PSODRG",62,0)
 . I $$FIND^PSOREJUT(RX,RFL),$$STATUS^PSOBPSUT(RX,RFL)'="" S PSOCONT=1 Q    ; unreleased w/unresolved billable rejections
"RTN","PSODRG",63,0)
 . Q
"RTN","PSODRG",64,0)
 ;
"RTN","PSODRG",65,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",66,0)
 D NDCEDT^PSONDCUT(RX,.RFL,$G(DRG),$G(PSOSITE),.NDC)
"RTN","PSODRG",67,0)
 Q
"RTN","PSODRG",68,0)
 ;
"RTN","PSODRG",69,0)
TRADE ;
"RTN","PSODRG",70,0)
 K DIR,DIC,DA,X,Y
"RTN","PSODRG",71,0)
 S DIR(0)="52,6.5" S:$G(PSOTRN)]"" DIR("B")=$G(PSOTRN) D ^DIR K DIR,DIC
"RTN","PSODRG",72,0)
 I X="@" S Y=X K DIRUT
"RTN","PSODRG",73,0)
 I $D(DIRUT) S:$D(DUOUT)!$D(DTOUT)&('$D(PSORX("EDIT"))) PSONEW("DFLG")=1 G TRADEX
"RTN","PSODRG",74,0)
 S PSODRUG("TRADE NAME")=Y
"RTN","PSODRG",75,0)
TRADEX I $G(PSORXED("DFLG")),$D(DIRUT) S PSORXED("DFLG")=1
"RTN","PSODRG",76,0)
 K DIRUT,DTOUT,DUOUT,X,Y,DA,DR,DIE
"RTN","PSODRG",77,0)
 Q
"RTN","PSODRG",78,0)
SET ;
"RTN","PSODRG",79,0)
 N STAT S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2)
"RTN","PSODRG",80,0)
 S PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSODRG",81,0)
 S:+$G(^PSDRUG(+PSOY,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSODRG",82,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODRG",83,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3)
"RTN","PSODRG",84,0)
 S PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSODRG",85,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5)
"RTN","PSODRG",86,0)
 I $G(PSODRUG("NDC"))="" S PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE))
"RTN","PSODRG",87,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSODRG",88,0)
 S PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSODRG",89,0)
 G:$G(^PSDRUG(+PSOY,660))']"" SETX
"RTN","PSODRG",90,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660))
"RTN","PSODRG",91,0)
 S PSODRUG("COST")=$P($G(PSOX1),"^",6)
"RTN","PSODRG",92,0)
 S PSODRUG("UNIT")=$P($G(PSOX1),"^",8)
"RTN","PSODRG",93,0)
 S PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSODRG",94,0)
SETX K PSOX1,PSOY
"RTN","PSODRG",95,0)
 Q
"RTN","PSODRG",96,0)
NFI ;display restriction/guidelines
"RTN","PSODRG",97,0)
 D EN^PSSDIN(PSODRUG("OI"),PSODRUG("IEN")) S NFI=$$PROMPT^PSSDIN
"RTN","PSODRG",98,0)
 I NFI]"","ODY"[NFI D TD^PSONFI
"RTN","PSODRG",99,0)
 K NFI Q
"RTN","PSODRG",100,0)
POST ;order checks
"RTN","PSODRG",101,0)
 N LIST S LIST="PSOPEPS"
"RTN","PSODRG",102,0)
 K PSODOSD,^TMP("PSORXDC",$J),^TMP($J,LIST),^TMP("PSODAOC",$J)
"RTN","PSODRG",103,0)
 K ZDGDG,ZTHER,IT,PSODLQT,PSODOSD
"RTN","PSODRG",104,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) S ^TMP("PSODAOC",$J,"NORDI",1,0)="Remote data not available - Only local order checks processed."
"RTN","PSODRG",105,0)
 S ^TMP($J,LIST,"IN","PING")="" D IN^PSSHRQ2(LIST)
"RTN","PSODRG",106,0)
 K DIR I $P(^TMP($J,LIST,"OUT",0),"^")=-1 D
"RTN","PSODRG",107,0)
 .D DATACK^PSODDPRE
"RTN","PSODRG",108,0)
 .S ^TMP("PSODAOC",$J,"NOSYS",1,0)="No Enhanced Order Checks can be performed. Reason(s): "_$P($G(^TMP($J,LIST,"OUT",0)),"^",2)
"RTN","PSODRG",109,0)
 K ^TMP($J,LIST,"IN"),^TMP($J,LIST,"OUT","EXCEPTIONS")
"RTN","PSODRG",110,0)
 G:$G(PSORX("DFLG"))!($G(PSORXED("DFLG"))) POSTX
"RTN","PSODRG",111,0)
 K PSORX("INTERVENE"),PSOQUIT N STAT,SIG,PTR,NDF,VAP S PSORX("DFLG")=0
"RTN","PSODRG",112,0)
 W !! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",113,0)
 D ^PSOBUILD
"RTN","PSODRG",114,0)
 D:'$D(PSODGCK) @$S($G(COPY):"^PSOCPPRE",1:"^PSODDPRE") ; Duplicate drug check
"RTN","PSODRG",115,0)
 G:$G(PSORX("DFLG")) POSTX
"RTN","PSODRG",116,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",117,0)
 I $P($G(^PSDRUG(PSODRUG("IEN"),"CLOZ1")),"^")="PSOCLO1" W !,"Now doing Clozapine Order checks.  Please wait...",! D CLOZ
"RTN","PSODRG",118,0)
 G:PSORX("DFLG") POSTX
"RTN","PSODRG",119,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",120,0)
 W !,"Now doing allergy checks.  Please wait...",! H 1
"RTN","PSODRG",121,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D:PSONOAL'="" NOALRGY K PSONOAL
"RTN","PSODRG",122,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",123,0)
 I '$G(PSODGCKX) D ^PSODGAL1 K PSORX("INTERVENE")
"RTN","PSODRG",124,0)
 G:PSORX("DFLG")!$G(PSOQUIT) POSTX
"RTN","PSODRG",125,0)
 ;This is the allergy check for profile drugs CK action
"RTN","PSODRG",126,0)
 I $D(PSODGCK),$D(PSOSD) D PRFLP^PSOUTL
"RTN","PSODRG",127,0)
 G:$G(PSORX("DFLG")) POSTX ;pso*7*412
"RTN","PSODRG",128,0)
 G:$G(PSOSPRNW)&($G(PSORENW("DFLG"))) POSTX ;speed renew
"RTN","PSODRG",129,0)
 ;aminoglycoside
"RTN","PSODRG",130,0)
 N AOC,CROCPFLG S CROCPFLG=0
"RTN","PSODRG",131,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",132,0)
 S AOC=$$AOC^OROCAPI(PSODFN,$P(PSODRUG("NDF"),"A",2)) I $P(AOC,"^",4)]"" D
"RTN","PSODRG",133,0)
 .S CROCPFLG=1
"RTN","PSODRG",134,0)
 .W !!,"***Aminoglycoside Ordered***",!!
"RTN","PSODRG",135,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(AOC,"^",4) D ^DIWP
"RTN","PSODRG",136,0)
 .W ! F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",137,0)
 .K ^UTILITY($J,"W")
"RTN","PSODRG",138,0)
 .S ^TMP("PSODAOC",$J,"CPRS",$P(AOC,"^",2),0)=PSODRUG("IEN")_"^"_$P(AOC,"^",4)
"RTN","PSODRG",139,0)
 .W !
"RTN","PSODRG",140,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",141,0)
 ;dangerous meds for pat >64
"RTN","PSODRG",142,0)
 I $G(PSODRUG("OI")) D
"RTN","PSODRG",143,0)
 .N OI,OIR S OI=$$OITM^ORX8(PSODRUG("OI"),"99PSP") Q:'OI
"RTN","PSODRG",144,0)
 .S OIR=$$DOC^OROCAPI(PSODFN,OI) I $P(OIR,"^",4)]"" D
"RTN","PSODRG",145,0)
 ..S CROCPFLG=1
"RTN","PSODRG",146,0)
 ..D HD^PSODDPR2():(($Y+5)'>IOSL) W !!,"***Dangerous Meds for Patient >64***",!! S DFN=PSODFN D DEM^VADPT
"RTN","PSODRG",147,0)
 ..K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(OIR,"^",4) D ^DIWP
"RTN","PSODRG",148,0)
 ..F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",149,0)
 ..K ^UTILITY($J,"W")
"RTN","PSODRG",150,0)
 ..S ^TMP("PSODAOC",$J,"CPRS",$P(OIR,"^",2),0)=PSODRUG("IEN")_"^"_$P(OIR,"^",4)
"RTN","PSODRG",151,0)
 ..W !
"RTN","PSODRG",152,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",153,0)
 ;metformin lab results
"RTN","PSODRG",154,0)
 N GOC S GOC=$$GOC^OROCAPI(PSODFN,PSODRUG("NAME")) I $P(GOC,"^",4)]"" D
"RTN","PSODRG",155,0)
 .S CROCPFLG=1
"RTN","PSODRG",156,0)
 .W !!,"***Metformin Lab Results***",!!
"RTN","PSODRG",157,0)
 .K ^UTILITY($J,"W") S DIWL=1,DIWR=78,DIWF="" S X=$P(GOC,"^",4) D ^DIWP
"RTN","PSODRG",158,0)
 .F ZX=0:0 S ZX=$O(^UTILITY($J,"W",1,ZX)) Q:'ZX  W ?2,^UTILITY($J,"W",1,ZX,0),! D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",159,0)
 .K ^UTILITY($J,"W")
"RTN","PSODRG",160,0)
 .S ^TMP("PSODAOC",$J,"CPRS",$P(GOC,"^",2),0)=PSODRUG("IEN")_"^"_$P(GOC,"^",4)
"RTN","PSODRG",161,0)
 .W !
"RTN","PSODRG",162,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",163,0)
 ;clinical reminder oc
"RTN","PSODRG",164,0)
 D:'$G(PSONCROC) CK^PSOCROC K CROCPFLG I $G(PSORX("DFLG")) Q
"RTN","PSODRG",165,0)
 K DIWF,DIWL,DIWR,ZX,DFN,CROCPFLG
"RTN","PSODRG",166,0)
 I $G(PSODRUG("DEA"))["S"!($E($G(PSODRUG("VA CLASS")),1,2)="XA") D  G POSTX ;stops if drug is supply
"RTN","PSODRG",167,0)
 .W !,"Now Processing Enhanced Order Checks!  Please wait...",! H 1
"RTN","PSODRG",168,0)
 ;enhanced OC
"RTN","PSODRG",169,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",170,0)
 W ! D @$S($G(COPY):"OBX^PSOCPPRE",1:"OBX^PSODDPRE") ; Set PSORX("DFLG")=1 if process to stop new enhanced order checks
"RTN","PSODRG",171,0)
POSTX ;
"RTN","PSODRG",172,0)
 K IT,^TMP($J,"DI"),PSORX("INTERVENE"),DA,^TMP($J,"PSODRDI"),ZDGDG,ZTHER,^TMP($J,"DI"_PSODFN),PSZZQUIT
"RTN","PSODRG",173,0)
 I '$G(PSORXED),'$G(PSOREINS) K PSOQUIT
"RTN","PSODRG",174,0)
 Q
"RTN","PSODRG",175,0)
 ;
"RTN","PSODRG",176,0)
EOJ ;
"RTN","PSODRG",177,0)
 K PSODRG
"RTN","PSODRG",178,0)
 Q
"RTN","PSODRG",179,0)
WAIT ;
"RTN","PSODRG",180,0)
 K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue..." W !
"RTN","PSODRG",181,0)
 D ^DIR K DIRUT,DUOUT,DIR,X,Y
"RTN","PSODRG",182,0)
 Q
"RTN","PSODRG",183,0)
 ;
"RTN","PSODRG",184,0)
CLOZ ;
"RTN","PSODRG",185,0)
 S ANQRTN=$P(^PSDRUG(PSODRUG("IEN"),"CLOZ1"),"^"),ANQX=0
"RTN","PSODRG",186,0)
 S P(5)=PSODRUG("IEN"),DFN=PSODFN,X=ANQRTN
"RTN","PSODRG",187,0)
 X ^%ZOSF("TEST") I  D @("^"_ANQRTN) S:$G(ANQX) PSORX("DFLG")=1
"RTN","PSODRG",188,0)
 K P(5),ANQRTN,ANQX,X,DFN
"RTN","PSODRG",189,0)
 Q
"RTN","PSODRG",190,0)
 ;
"RTN","PSODRG",191,0)
EN(DRG) ;returns lab test identified for clozapine order checking
"RTN","PSODRG",192,0)
 K LAB I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")'="PSOCLO1" S LAB("NOT")=0 Q
"RTN","PSODRG",193,0)
 I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSODRG",194,0)
 .S (CNT,I)=0 F  S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  S CNT=$G(CNT)+1
"RTN","PSODRG",195,0)
 .I CNT'=2 S LAB("BAD TEST")=0 K CNT Q
"RTN","PSODRG",196,0)
 .K CNT F I=0:0 S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  D
"RTN","PSODRG",197,0)
 ..S LABT=$S($P(^PSDRUG(DRG,"CLOZ2",I,0),"^",4)=1:"WBC",1:"ANC"),LAB(LABT)=$P(^PSDRUG(DRG,"CLOZ2",I,0),"^")_"^"_$P(^(0),"^",3)_"^"_$P(^(0),"^",4)
"RTN","PSODRG",198,0)
 K LABT,I
"RTN","PSODRG",199,0)
 Q
"RTN","PSODRG",200,0)
NOALRGY ;
"RTN","PSODRG",201,0)
 D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSODRG",202,0)
 N DIR S DIR(0)="SA^1:YES;0:NO"
"RTN","PSODRG",203,0)
 I $D(^TMP($J,"PSOINTERVENE",+PSODFN)) D  Q
"RTN","PSODRG",204,0)
 .S DIR("A")="No Allergy Assessment - Do you want to duplicate Intervention?: ",DIR("B")="Yes"
"RTN","PSODRG",205,0)
 .D ^DIR
"RTN","PSODRG",206,0)
 .I 'Y D  Q
"RTN","PSODRG",207,0)
 ..I Y=0 D ^PSORXI Q
"RTN","PSODRG",208,0)
 ..S PSORX("DFLG")=1
"RTN","PSODRG",209,0)
 .D DUPINV^PSORXI
"RTN","PSODRG",210,0)
 W $C(7),!,"There is no allergy assessment on file for this patient."
"RTN","PSODRG",211,0)
 W !,"You will be prompted to intervene if you continue with this prescription"
"RTN","PSODRG",212,0)
 I $D(PSODGCK) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue..." D ^DIR K DIR
"RTN","PSODRG",213,0)
 Q:$D(PSODGCK)
"RTN","PSODRG",214,0)
 N DUOUT,DTOUT,RXIEN,RXSTA               ;*398
"RTN","PSODRG",215,0)
 S DIR("A")="Do you want to Continue?: ",DIR("B")="N" D ^DIR
"RTN","PSODRG",216,0)
 I 'Y!($D(DUOUT))!($D(DTOUT)) D  Q       ;*398 - Exit/Timeout
"RTN","PSODRG",217,0)
 .I $D(PSONV) S PSZZQUIT=1 Q
"RTN","PSODRG",218,0)
 .S PSORX("DFLG")=1
"RTN","PSODRG",219,0)
 .I '$O(PSCAN(0)) Q                      ;*398 - Array has Rx IEN
"RTN","PSODRG",220,0)
 .I $G(REA)'="R" Q                       ;*398 - Reinstate only
"RTN","PSODRG",221,0)
 .S RXIEN=+$G(PSCAN(RX)) I 'RXIEN Q      ;*398 - Get Rx IEN
"RTN","PSODRG",222,0)
 .S RXSTA=$$GET1^DIQ(52,RXIEN,100,"I")   ;*398 - Get status
"RTN","PSODRG",223,0)
 .I RXSTA=12 Q                           ;*398 - Correct status
"RTN","PSODRG",224,0)
 .S DIE="^PSRX(",DA=RXIEN,DR="100///12"  ;*398 - Discontinued
"RTN","PSODRG",225,0)
 .D ^DIE                                 ;*398 - Update Rx file
"RTN","PSODRG",226,0)
 I $D(PSONV) S PSORX("INTERVENE")=0 D EN1^PSORXI(PSONV) Q
"RTN","PSODRG",227,0)
 D ^PSORXI
"RTN","PSODRG",228,0)
 Q
"RTN","PSONEW")
0^12^B33443923
"RTN","PSONEW",1,0)
PSONEW ;BIR/SAB - new rx order main driver ;07/26/96
"RTN","PSONEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,46,94,130,268,225,251,379,390,417,313,411**;DEC 1997;Build 95
"RTN","PSONEW",3,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSONEW",4,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSONEW",5,0)
 ;External reference to ^VA(200 supported by DBIA 224
"RTN","PSONEW",6,0)
 ;External reference to ^XUSEC( supported by DBIA 10076
"RTN","PSONEW",7,0)
 ;External reference to ^ORX1 supported by DBIA 2186
"RTN","PSONEW",8,0)
 ;External reference to ^ORX2 supported by DBIA 867
"RTN","PSONEW",9,0)
 ;External reference to ^TIUEDIT supported by DBIA 2410
"RTN","PSONEW",10,0)
 ;External reference to ^DD("DILOCKTM" supported by DBIA 999
"RTN","PSONEW",11,0)
 ;---------------------------------------------------------------
"RTN","PSONEW",12,0)
OERR ;backdoor new rx for v7
"RTN","PSONEW",13,0)
 K PSOREEDT,COPY,SPEED,PSOEDIT,DUR,DRET,PSOTITRX,PSOMTFLG N PSOCKCON,PSODAOC
"RTN","PSONEW",14,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSONEW",15,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSONEW",16,0)
AGAIN N VALMCNT K PSODRUG,PSOCOU,PSOCOUU,PSONOOR,PSORX("FN"),PSORX("DFLG"),PSOQUIT,POERR S PSORX("DFLG")=0
"RTN","PSONEW",17,0)
 W ! D HLDHDR^PSOLMUTL S (PSONEW("QFLG"),PSONEW("DFLG"),PSOQUIT)=0,PSOFROM="NEW",PSONOEDT=1
"RTN","PSONEW",18,0)
 K ORD D FULL^VALM1,^PSONEW1 ; Continue order entry
"RTN","PSONEW",19,0)
 I PSONEW("QFLG") G END
"RTN","PSONEW",20,0)
 I PSONEW("DFLG") W !,$C(7),"RX DELETED",! S:$G(POERR) POERR("DFLG")=1,VALMBCK="Q" G END
"RTN","PSONEW",21,0)
 D:$P($G(PSOPAR),"^",7)=1 AUTO^PSONRXN I $P($G(PSOPAR),"^",7)'=1 S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSONEW",22,0)
 I PSONEW("DFLG")!PSONEW("QFLG") D DEL S:$G(POERR) POERR("DFLG")=1,VALMBCK="R" G END
"RTN","PSONEW",23,0)
 D NOOR I PSONEW("DFLG") D DEL G END
"RTN","PSONEW",24,0)
 D ^PSONEW2 I PSONEW("DFLG") D DEL S:$G(POERR) POERR("DFLG")=1,VALMBCK="R" G END ; Asks if correct
"RTN","PSONEW",25,0)
 G:$G(PSORX("FN")) END
"RTN","PSONEW",26,0)
 D EN^PSON52(.PSONEW) ; Files entry in File 52
"RTN","PSONEW",27,0)
 D NPSOSD^PSOUTIL(.PSONEW) ; Adds newly added rx to PSOSD array
"RTN","PSONEW",28,0)
 S VALMBCK="R"
"RTN","PSONEW",29,0)
 ;
"RTN","PSONEW",30,0)
 ; - Possible Titration prescription
"RTN","PSONEW",31,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSONEW",32,0)
 ;
"RTN","PSONEW",33,0)
END D EOJ ; Clean up          
"RTN","PSONEW",34,0)
 I '$G(PSORX("FN")) W ! K DIR,DIRUT,DUOUT,DTOUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Another New Order for "_PSORX("NAME") D ^DIR K DIR,DIRUT,DUOUT,DTOUT I Y K PSONEW,PSDRUG,ORD G AGAIN
"RTN","PSONEW",35,0)
 D ^PSOBUILD,BLD^PSOORUT1 S X=PSODFN_";DPT(" D ULK^ORX2 D UL^PSSLOCK(PSODFN)
"RTN","PSONEW",36,0)
 D RV^PSOORFL
"RTN","PSONEW",37,0)
 S VALMBCK="R" K PSORX("FN") Q
"RTN","PSONEW",38,0)
 ;----------------------------------------------------------------
"RTN","PSONEW",39,0)
DEL ;
"RTN","PSONEW",40,0)
 W !,$C(7),"RX DELETED",!
"RTN","PSONEW",41,0)
 I $P($G(PSOPAR),"^",7)=1 D
"RTN","PSONEW",42,0)
 . S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#",""))
"RTN","PSONEW",43,0)
 . S PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSONEW",44,0)
 . L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSONEW",45,0)
 . S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSONEW",46,0)
 . D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y
"RTN","PSONEW",47,0)
 . L -^PS(59,+PSOSITE,PSOY)
"RTN","PSONEW",48,0)
 . K PSOX,PSOY Q
"RTN","PSONEW",49,0)
EOJ ;
"RTN","PSONEW",50,0)
 I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #")) ; +Lock set in PSONRXN
"RTN","PSONEW",51,0)
 K PSONOEDT,PSONEW,PSODRUG,ANQDATA,LSI,C,MAX,MIN,NDF,REF,SIG,SER,PSOFLAG,PSOHI,PSOLO,PSONOOR,PSOCOUU,PSOCOU,PSORX("EDIT"),ZNEW
"RTN","PSONEW",52,0)
 D CLEAN^PSOVER1
"RTN","PSONEW",53,0)
 K ^TMP("PSORXDC",$J),RORD,ACOM,ACNT,CRIT,DEF,F1,GG,I1,IEN,INDT,LAST,MSG,NIEN,STA,DUR,DRET,PSOPRC
"RTN","PSONEW",54,0)
 S (ZRXN,RXN)=$O(^TMP("PSORXN",$J,0)) I RXN D
"RTN","PSONEW",55,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSONEW",56,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS","")
"RTN","PSONEW",57,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSONEW",58,0)
 .I $D(^TMP("PSODAOC",$J)) D
"RTN","PSONEW",59,0)
 ..S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"NEW Order Acceptance_OP",ZNEW=1
"RTN","PSONEW",60,0)
 .D DAOC
"RTN","PSONEW",61,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J),RET,PSODAOC,ZNEW
"RTN","PSONEW",62,0)
 I $G(PSONOTE) D FULL^VALM1,MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSONEW",63,0)
 K PSONOTE,PSOCKCON,ZZCOPY
"RTN","PSONEW",64,0)
 ;W !! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT,DUOUT
"RTN","PSONEW",65,0)
 Q
"RTN","PSONEW",66,0)
NOOR ;asks nature of order
"RTN","PSONEW",67,0)
 N PSONOODF
"RTN","PSONEW",68,0)
 S PSONOODF=0
"RTN","PSONEW",69,0)
 I $G(OR0) D  G NOORX ;front door
"RTN","PSONEW",70,0)
 .S PSOI=$S($G(PSOSIGFL):1,$G(PSODRUG("OI"))'=$P(OR0,"^",8):1,1:0) I 'PSOI S PSONOOR="" D:$D(^XUSEC("PSORPH",DUZ)) COUN Q  ;NoO $P(OR0,"^",7)
"RTN","PSONEW",71,0)
 .S PSONOODF=1
"RTN","PSONEW",72,0)
 .D DIR I $D(DIRUT) S PSONEW("DFLG")=1 Q
"RTN","PSONEW",73,0)
 .S PSONOOR=Y D:$D(^XUSEC("PSORPH",DUZ)) COUN K DIR,DTOUT,DTOUT,DIRUT
"RTN","PSONEW",74,0)
 ;backdoor order
"RTN","PSONEW",75,0)
 D DIR I $D(DIRUT) S PSONEW("DFLG")=1,VALMBCK="Q" Q
"RTN","PSONEW",76,0)
 S PSONOOR=Y K DIK,DA,DIE,DR,PSOI,DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",77,0)
 G:'$D(^XUSEC("PSORPH",DUZ)) NOORX
"RTN","PSONEW",78,0)
COUN ;patient counseling
"RTN","PSONEW",79,0)
 G:$G(PSORX("EDIT"))&('$G(PSOSIGFL)) NOORX K DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",80,0)
 S DIR("B")="NO",DIR(0)="52,41" D ^DIR S PSOCOU=$S(Y:Y,1:0)
"RTN","PSONEW",81,0)
 I $D(DIRUT)!('PSOCOU) S PSOCOUU=0 D:'$G(SPEED) PRONTE Q
"RTN","PSONEW",82,0)
 K:'$G(PSOCOU) PSOCOUU K DIR,DUOUT,DTOUT,DIRUT I Y S DIR(0)="52,42",DIR("B")="NO" D ^DIR S PSOCOUU=$S(Y:Y,1:0)
"RTN","PSONEW",83,0)
PRONTE K PSONOTE,DIR,DIRUT,DUOUT
"RTN","PSONEW",84,0)
 I $T(MAIN^TIUEDIT)]"",'$G(SPEED) D  K DIR,DIRUT,DUOUT
"RTN","PSONEW",85,0)
 .S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to enter a Progress Note",DIR("A",1)="" D ^DIR K DIR
"RTN","PSONEW",86,0)
 .S PSONOTE=+Y Q  ;I 'Y!($D(DIRUT)) Q
"RTN","PSONEW",87,0)
NOORX K X,Y,DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",88,0)
 Q
"RTN","PSONEW",89,0)
DIR ;ask nature of order
"RTN","PSONEW",90,0)
 K DIR,DTOUT,DTOUT,DIRUT I $T(NA^ORX1)]""  D  Q
"RTN","PSONEW",91,0)
 .S PSONOOR=$$NA^ORX1($S($G(PSONOODF)!($G(PSONOBCK)):"S",1:"W"),0,"B","Nature of Order",0,"WPSDIVR"_$S(+$G(^VA(200,DUZ,"PS")):"E",1:""))
"RTN","PSONEW",92,0)
 .I +PSONOOR S (Y,PSONOOR)=$P(PSONOOR,"^",3) Q
"RTN","PSONEW",93,0)
 .S DIRUT=1 K PSONOOR
"RTN","PSONEW",94,0)
 I $D(PSONOOR) S DF=PSONOOR,PSONODF=$S(DF="E":"PROVIDER ENTERED",DF="V":"VERBAL",DF="P":"TELEPHONE",DF="D":"DUPLICATE",DF="S":"SERVICE CORRECTED",DF="I":"POLICY",DF="R":"SERVICE REJECTED",1:"WRITTEN")
"RTN","PSONEW",95,0)
 K DIR,DTOUT,DTOUT,DIRUT S DIR("A")="Nature of Order: ",DIR("B")=$S($D(PSONOOR):PSONODF,1:"WRITTEN")
"RTN","PSONEW",96,0)
 S DIR(0)="SA^W:WRITTEN;V:VERBAL;P:TELEPHONE;S:SERVICE CORRECTED;D:DUPLICATE;I:POLICY;R:SERVICE REJECTED"_$S(+$G(^VA(200,DUZ,"PS")):";E:PROVIDER ENTERED",1:"")
"RTN","PSONEW",97,0)
 D ^DIR K DF,PSONODF Q:$D(DIRUT)  S PSONOOR=Y
"RTN","PSONEW",98,0)
DIRX Q
"RTN","PSONEW",99,0)
 ;
"RTN","PSONEW",100,0)
NOORE(PSONEW) ;entry point for renew
"RTN","PSONEW",101,0)
 D NOOR I $D(DIRUT) S PSONEW("DFLG")=1 Q
"RTN","PSONEW",102,0)
 S PSONEW("NOO")=PSONOOR
"RTN","PSONEW",103,0)
 Q
"RTN","PSONEW",104,0)
DAOC ;adds all backdoor order checks to file 100.05.
"RTN","PSONEW",105,0)
 D ^PSONEWOC K ^TMP("PSODAOC",$J),PSRDI
"RTN","PSONEW",106,0)
 Q
"RTN","PSONEWOA")
0^13^B40166209
"RTN","PSONEWOA",1,0)
PSONEWOA ;BIR/SAB-STORES ALLERGY ORDER CHECKS IN FILE #100.05 ;11/08/2012
"RTN","PSONEWOA",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**411**;DEC 1997;Build 95
"RTN","PSONEWOA",3,0)
 ;External Reference to ^PS(53.1 supported by DBIA 5793 
"RTN","PSONEWOA",4,0)
 ;External Reference to ^DD("DD" supported by DBIA #999
"RTN","PSONEWOA",5,0)
 ;External Reference to SAVEOC^OROCAPI1 supported by DBIA 5729
"RTN","PSONEWOA",6,0)
 ;
"RTN","PSONEWOA",7,0)
DAOC ;stores drug allergies w/sign/symptoms
"RTN","PSONEWOA",8,0)
 N DACNT,DIC,DIE,DR,DA,DD,DO,PSORDIEN,PACKAGE,RXORDER,PSJOCFG,PSOJORD,PSOGORD,PSJDATA,ORN,RET,OORDIEN,ORL,ZERO,PSOALGCT
"RTN","PSONEWOA",9,0)
 ;SET THE 1, 2 AND 3 NODES OF 100.05
"RTN","PSONEWOA",10,0)
 S PSOALGCT=0 F  S PSOALGCT=$O(^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT)) Q:'PSOALGCT  D DAOC2
"RTN","PSONEWOA",11,0)
 K DR,DA,DIE,DIC,RET
"RTN","PSONEWOA",12,0)
 Q
"RTN","PSONEWOA",13,0)
DAOC2 ;
"RTN","PSONEWOA",14,0)
 K RET,ORL,DR,DA,DIE,DIC
"RTN","PSONEWOA",15,0)
 D LBL
"RTN","PSONEWOA",16,0)
 S OCCDT=$$NOW^XLFDT
"RTN","PSONEWOA",17,0)
 I PACKAGE="OP" S (OORDIEN,PSORDIEN,ORN)=$P(^PSRX(RXN,"OR1"),"^",2)
"RTN","PSONEWOA",18,0)
 I PACKAGE="IP" S ORN=PSORDIEN
"RTN","PSONEWOA",19,0)
 I '$G(ORN) D:PACKAGE="OP"  Q
"RTN","PSONEWOA",20,0)
 .N ZZIR,ZZFDA
"RTN","PSONEWOA",21,0)
 .S ZZIR=0 F ZZFDA=0:0 S ZZFDA=$O(^PSRX(RXN,"A",ZZFDA)) Q:'ZZFDA  S ZZIR=ZZFDA
"RTN","PSONEWOA",22,0)
 .S ZZIR=ZZIR+1,^PSRX(RXN,"A",0)="^52.3DA^"_ZZIR_"^"_ZZIR
"RTN","PSONEWOA",23,0)
 .D NOW^%DTC S ^PSRX(RXN,"A",ZZIR,0)=%_"^S^"_DUZ_"^0^"_"CPRS Order Number is not defined.  Cannot store order check information in the activity log."
"RTN","PSONEWOA",24,0)
 I $G(PSJAOC1) D
"RTN","PSONEWOA",25,0)
 .S:'$D(PSJDAOC) PSJDAOC="IP "_$S($G(PSJOCFG)]"":PSJOCFG,1:"DRUG ALLERGY")
"RTN","PSONEWOA",26,0)
 .S ORL(1,1)=+ORN_"^"_PSJDAOC_""_"^"_DUZ_"^"_OCCDT_"^3^"
"RTN","PSONEWOA",27,0)
 I '$G(PSJAOC1) S ORL(1,1)=PSORDIEN_"^"_PSODAOC_"^"_DUZ_"^"_OCCDT_"^3^"
"RTN","PSONEWOA",28,0)
 S ORL(1,3)=^TMP("PSODAOC",$J,"ALLERGY","PROVR")
"RTN","PSONEWOA",29,0)
 S ORL(1,2,1)="A Drug-Allergy Reaction exists for this medication and/or class."
"RTN","PSONEWOA",30,0)
 D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSONEWOA",31,0)
 Q:'$D(RET)
"RTN","PSONEWOA",32,0)
 S (PSORDIEN,DA)=$O(RET(1,0))
"RTN","PSONEWOA",33,0)
 I $G(DA) S DIE="^ORD(100.05,",DR="84///V" D ^DIE K DA,DIE
"RTN","PSONEWOA",34,0)
 D DISP
"RTN","PSONEWOA",35,0)
 ;SET 4 AND 5 NODES OF 100.05
"RTN","PSONEWOA",36,0)
 S DACNT=0 F  S DACNT=$O(^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,4,DACNT)) Q:'DACNT  D DAOC1 K DA,DR,DIE,DIC
"RTN","PSONEWOA",37,0)
 I RXORDER["P"!(RXORDER["N")!(RXORDER["O") D GRP1
"RTN","PSONEWOA",38,0)
 I RXORDER["V"!(RXORDER["U") D GRP2
"RTN","PSONEWOA",39,0)
 K DA,RET,DR
"RTN","PSONEWOA",40,0)
 Q
"RTN","PSONEWOA",41,0)
 ;
"RTN","PSONEWOA",42,0)
DAOC1 ;
"RTN","PSONEWOA",43,0)
 N OCCDT,Z,RET,NODE,PSOREACT,PSOORDT,PSOLRTP,PSOHO,PSOSEV,PSOREML,PSOCAUSA,Y K DA,DIC,DIE,DR
"RTN","PSONEWOA",44,0)
 S ZERO=$G(^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,4,DACNT,0))
"RTN","PSONEWOA",45,0)
 S:$P(ZERO,"^",3)="L" $P(ZERO,"^",4)=""  ;If location is local don't store location #
"RTN","PSONEWOA",46,0)
 Q:ZERO=""
"RTN","PSONEWOA",47,0)
 S DA(1)=PSORDIEN Q:'DA(1)
"RTN","PSONEWOA",48,0)
 S DA=$O(^ORD(100.05,DA(1),4,9999),-1)+1
"RTN","PSONEWOA",49,0)
 S X=$P(ZERO,"^"),DIC="^ORD(100.05,"_DA(1)_",4,",DIC(0)="Z" D FILE^DICN
"RTN","PSONEWOA",50,0)
 K DA,DIE,DR,DIC
"RTN","PSONEWOA",51,0)
 S DIE="^ORD(100.05,"_PSORDIEN_",4,",DA=DACNT,DA(1)=4,DA(2)=PSORDIEN
"RTN","PSONEWOA",52,0)
 S PSOREACT=$P($P(ZERO,"^"),"|"),Y=$P(ZERO,"^",5) X ^DD("DD") S:Y'=-1 PSORDT=Y
"RTN","PSONEWOA",53,0)
 S PSOLRTP=$P(ZERO,"^",3),PSOHO=$P(ZERO,"^",6),PSOSEV=$P(ZERO,"^",7)
"RTN","PSONEWOA",54,0)
 S DR=".01///"_PSOREACT_";8///"_PSORDT_";6///"_PSOLRTP_";9///"_PSOHO_";10///"_PSOSEV
"RTN","PSONEWOA",55,0)
 ; DR=".01///PENICILLIN;8///OCT 27,2014@13:22;6///L;9///H;10///;7///ALBANY"
"RTN","PSONEWOA",56,0)
 S:$P(ZERO,"^",4)'="" PSOREML=$$GET1^DIQ(4,$P(ZERO,"^",4),.01),DR=DR_";7///"_PSOREML
"RTN","PSONEWOA",57,0)
 D ^DIE
"RTN","PSONEWOA",58,0)
 K DR
"RTN","PSONEWOA",59,0)
 S FDA(100.517,DA_","_DA(2)_",",2)=$P(ZERO,"^",2)  ;variable pointer for causative agent
"RTN","PSONEWOA",60,0)
 D UPDATE^DIE("","FDA")
"RTN","PSONEWOA",61,0)
 F NODE=1:1:3 D SET
"RTN","PSONEWOA",62,0)
 ; This sets up for GRP1 Filing below
"RTN","PSONEWOA",63,0)
 I $G(PSOARENW)=1!($G(ZNEW)=1)!($G(PSOREINS)=1)!($G(PSOREINO))!($G(PSONV)) S RXORDER=ZRXN_"O"  ;Results in RX IEN_OP
"RTN","PSONEWOA",64,0)
 I $G(PSOORNEW)=1!($G(ZFRENEW)=1) S RXORDER=$G(RXN)_"O"
"RTN","PSONEWOA",65,0)
 Q
"RTN","PSONEWOA",66,0)
 ;
"RTN","PSONEWOA",67,0)
SET ;
"RTN","PSONEWOA",68,0)
 N PSOCNT,DA,DIE,DR,DIC,DINUM,X,XX,LAYGO
"RTN","PSONEWOA",69,0)
 S DA(2)=PSORDIEN,DA(1)=DACNT,LAYGO=100.517,PSOCNT=0
"RTN","PSONEWOA",70,0)
 S DIC="^ORD(100.05,"_PSORDIEN_",4,"_DACNT_","_NODE_",",DIC(0)="LZ"
"RTN","PSONEWOA",71,0)
 F  S PSOCNT=$O(^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,4,DACNT,NODE,PSOCNT)) Q:PSOCNT=""  I PSOCNT'="" S X="",X=^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,4,DACNT,NODE,PSOCNT,0) D
"RTN","PSONEWOA",72,0)
 .Q:X=""
"RTN","PSONEWOA",73,0)
 .S (DA,DINUM)=$O(^ORD(100.05,PSORDIEN,4,DACNT,NODE,9999),-1)+1
"RTN","PSONEWOA",74,0)
 .;GET THE EXTERNAL VALUE TO SEND THROUGH FILEMAN
"RTN","PSONEWOA",75,0)
 .I NODE=1 S XX=$$GET1^DIQ(50.605,X,.01)  ;DRUG CLASS
"RTN","PSONEWOA",76,0)
 .I NODE=2 S XX=$$GET1^DIQ(50.416,X,.01)  ;INGREDIENT
"RTN","PSONEWOA",77,0)
 .I NODE=3 S XX=$$GET1^DIQ(120.83,X,.01)  ;SIGN/SYMPTON
"RTN","PSONEWOA",78,0)
 .S DR=".01///"_XX
"RTN","PSONEWOA",79,0)
 .D FILE^DICN K DD,DO
"RTN","PSONEWOA",80,0)
 Q
"RTN","PSONEWOA",81,0)
 ;
"RTN","PSONEWOA",82,0)
DISP ;
"RTN","PSONEWOA",83,0)
 I '$G(PSORDIEN) S PSORDIEN=OORDIEN
"RTN","PSONEWOA",84,0)
 Q:'$G(PSORDIEN)
"RTN","PSONEWOA",85,0)
 N DIC,DA,DR,PSOCNT,PSOINT  ; DISPENSE DRUGS
"RTN","PSONEWOA",86,0)
 S PSOCNT=0 F  S PSOCNT=$O(^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,"ALLERGY DD",5,PSOCNT)) Q:PSOCNT=""  S X=^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,"ALLERGY DD",5,PSOCNT,0) D
"RTN","PSONEWOA",87,0)
 .Q:X=""
"RTN","PSONEWOA",88,0)
 .S DA(1)=PSORDIEN,DIC="^ORD(100.05,"_DA(1)_",5,",DIC(0)="Z"
"RTN","PSONEWOA",89,0)
 .D FILE^DICN
"RTN","PSONEWOA",90,0)
 ;
"RTN","PSONEWOA",91,0)
 I $D(^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,"INTERVENTION")) D  Q
"RTN","PSONEWOA",92,0)
 .K DA,DIC,DIE,DR
"RTN","PSONEWOA",93,0)
 .S (DIC,DIE)="^ORD(100.05,",DIC(0)="F",DA=PSORDIEN
"RTN","PSONEWOA",94,0)
 .S X=^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,"INTERVENTION")
"RTN","PSONEWOA",95,0)
 .Q:X=""
"RTN","PSONEWOA",96,0)
 .S DR="81///"_X
"RTN","PSONEWOA",97,0)
 .D ^DIE
"RTN","PSONEWOA",98,0)
 ;^TMP("PSODAOC",539222232,1,"INTERVENTION")=6067
"RTN","PSONEWOA",99,0)
 Q
"RTN","PSONEWOA",100,0)
 ;
"RTN","PSONEWOA",101,0)
LBL ;
"RTN","PSONEWOA",102,0)
 S PACKAGE=$G(^TMP("PSODAOC",$J,"ALLERGY",PSOALGCT,"ALLERGY PKG"))
"RTN","PSONEWOA",103,0)
 I PACKAGE="IP" S PACKAGE=$G(^TMP("PSODAOC",$J,"ALLERGY","ALLERGY PKG"))
"RTN","PSONEWOA",104,0)
 S RXORDER=$P(PACKAGE,"^",3),PSJOCFG=$P(PACKAGE,"^",2),PSORDIEN=$P(PACKAGE,"^",4),PACKAGE=$P(PACKAGE,"^")
"RTN","PSONEWOA",105,0)
 I PACKAGE="OP" N PSOVRSTA S PSOVRSTA=0 D
"RTN","PSONEWOA",106,0)
 .S:$D(ZRXN) RXN=ZRXN
"RTN","PSONEWOA",107,0)
 .S PSODAOC="OP " D
"RTN","PSONEWOA",108,0)
 ..I $P(PSOPAR,"^",2) S:$G(RXN) PSOVRSTA=$P($G(^PSRX(RXN,"STA")),"^") D
"RTN","PSONEWOA",109,0)
 ...I $D(^XUSEC("PSORPH",DUZ)) S PSODAOC=PSODAOC_"RPh Verified " Q
"RTN","PSONEWOA",110,0)
 ...S PSODAOC=PSODAOC_"Tech Non-Verified "
"RTN","PSONEWOA",111,0)
 ..S PSODAOC=PSODAOC_$S($G(PSOFOERR):"FINISH",$G(ZZEDIT):"EDIT",$G(ZZCOPY):"COPY",$G(PSOREINS)!($G(PSOREINO)):"REINSTATE",$G(PSOARENW)=1:"RENEW",$G(PSONV):"VERIFY",1:"NEW")
"RTN","PSONEWOA",112,0)
 I PACKAGE="IP" D
"RTN","PSONEWOA",113,0)
 .S:$D(ZRXN) RXN=ZRXN
"RTN","PSONEWOA",114,0)
 .S PSORDIEN=$S(RXORDER["P"!(RXORDER["N"):+$$GET1^DIQ(53.1,+RXORDER,49),RXORDER["U":$$GET1^DIQ(55.06,+RXORDER_","_DFN_",",66),RXORDER["V":$$GET1^DIQ(55.01,+RXORDER_","_DFN_",",110),1:-1)
"RTN","PSONEWOA",115,0)
 .I PSORDIEN="",$D(^PS(53.1,RXORDER,0)) S PSORDIEN=+$$GET1^DIQ(53.1,+RXORDER,49)
"RTN","PSONEWOA",116,0)
 .; -- RTC 220104 - Replace: "IP DRUG  With: "DRUG
"RTN","PSONEWOA",117,0)
 .S:'$D(PSJDAOC) PSJDAOC="IP "_$S($G(PSJOCFG)]"":PSJOCFG,1:"DRUG ALLERGY")
"RTN","PSONEWOA",118,0)
 Q
"RTN","PSONEWOA",119,0)
 ;
"RTN","PSONEWOA",120,0)
GRP1 ;
"RTN","PSONEWOA",121,0)
 ; #60 - GROUP ONE PHARMACY ORDERS^100.07VA^^6;0
"RTN","PSONEWOA",122,0)
 ; OP PENDING ORDERS - IEN;PS(52.41,
"RTN","PSONEWOA",123,0)
 ; IP RX - IEN;PS(53.1,
"RTN","PSONEWOA",124,0)
 ; OP RX - IEN;PSRX(
"RTN","PSONEWOA",125,0)
 ;
"RTN","PSONEWOA",126,0)
 N ZORT,X,ZX
"RTN","PSONEWOA",127,0)
 S ZX=0,DA(1)=PSORDIEN Q:'DA(1)
"RTN","PSONEWOA",128,0)
 I $G(RXORDER)["N"!($G(RXORDER)["P") S ZORT=+RXORDER_";PS(53.1,"
"RTN","PSONEWOA",129,0)
 I $G(RXORDER)["O" S ZORT=+RXORDER_";PSRX("
"RTN","PSONEWOA",130,0)
 ;S ZORT=+RXORDER_";PS(53.1,"
"RTN","PSONEWOA",131,0)
 S X=ZORT,DIC="^ORD(100.05,"_DA(1)_",6,",DIC(0)="Z"
"RTN","PSONEWOA",132,0)
 D FILE^DICN
"RTN","PSONEWOA",133,0)
 K DIC
"RTN","PSONEWOA",134,0)
 S ODA(1)=DA(1)
"RTN","PSONEWOA",135,0)
 Q
"RTN","PSONEWOA",136,0)
 ;
"RTN","PSONEWOA",137,0)
GRP2 ;
"RTN","PSONEWOA",138,0)
 ;GROUP TWO PHARMACY ORDER FIELD (#70)
"RTN","PSONEWOA",139,0)
 ;Data is formatted as follows:
"RTN","PSONEWOA",140,0)
 ;"N;ien" => Non-VA Medications  ^PS(55,DFN,"NVA",ien)
"RTN","PSONEWOA",141,0)
 ;"R;rx#" => Remote Outpatient   ^PSRX(ien  Prescription Number
"RTN","PSONEWOA",142,0)
 ;
"RTN","PSONEWOA",143,0)
 N PSORIEN,PSORSITI,PSORSITE,ZORT,X,ZX
"RTN","PSONEWOA",144,0)
 S DA(1)=PSORDIEN Q:'DA(1)
"RTN","PSONEWOA",145,0)
 S ZORT=$S(RXORDER["U":"U;"_+RXORDER,RXORDER["V":"V;"_+RXORDER,1:"")
"RTN","PSONEWOA",146,0)
 I $P(ZORT,";")="R" D
"RTN","PSONEWOA",147,0)
 .S PSORIEN=$P($P(ZORT,"^",1),";",2),PSORSITE=$P(ZORT,"^",2),PSORDRG=$P(ZORT,"^",5)
"RTN","PSONEWOA",148,0)
 .S:PSORSITE'="" PSORSITI=$O(^DIC(4,"B",PSORSITE,PSORSITI))
"RTN","PSONEWOA",149,0)
 .S ZORT="R;"_PSORIEN_"^"_PSORSITI
"RTN","PSONEWOA",150,0)
 K DIC
"RTN","PSONEWOA",151,0)
 S X=ZORT,DIC="^ORD(100.05,"_DA(1)_",7,",DIC(0)="Z"
"RTN","PSONEWOA",152,0)
 D FILE^DICN
"RTN","PSONEWOA",153,0)
 K DIC
"RTN","PSONEWOA",154,0)
 Q
"RTN","PSONEWOC")
0^14^B28895423
"RTN","PSONEWOC",1,0)
PSONEWOC ;BIR/SAB-STORES BACKDOOR ORDER CHECKS IN FILE #100.05 ;11/08/2012
"RTN","PSONEWOC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**411**;DEC 1997;Build 95
"RTN","PSONEWOC",3,0)
 ;External reference to SAVEOC^OROCAPI1 supported by DBIA 5729
"RTN","PSONEWOC",4,0)
 ;External reference to ^ORD(100.05, supported by DBIA 5731
"RTN","PSONEWOC",5,0)
 ; 
"RTN","PSONEWOC",6,0)
ACT ;store order checks
"RTN","PSONEWOC",7,0)
 N PSOZH,PSOKIND,DA,DR,DIC,DIE S RXN=$O(^TMP("PSORXN",$J,0))
"RTN","PSONEWOC",8,0)
 I $G(PSONV) S ZRXN=PSONV
"RTN","PSONEWOC",9,0)
 ;I $G(^TMP("PSODAOC",$J,"NORDI",1,0))]"" D NORDI^PSONEWO1
"RTN","PSONEWOC",10,0)
 ;I $D(^TMP("PSODAOC",$J,"DD")) S PSOKIND="DD",PSOZH="Duplicate Drug" D SET ;dup drug
"RTN","PSONEWOC",11,0)
 I $D(^TMP("PSODAOC",$J,"ALLERGY")) S PSOZH="Order Allergy" D DAOC^PSONEWOA ;drug allergies
"RTN","PSONEWOC",12,0)
 ;I $G(^TMP("PSODAOC",$J,"CLOZ",0))]"" S PSOZH="Clozapine" D CLOZ^PSONEWO1
"RTN","PSONEWOC",13,0)
 ;I $D(^TMP("PSODAOC",$J,"DI",0))]"" S PSOKIND="DI",PSOZH="Drug Interaction" D SET ;drug interaction
"RTN","PSONEWOC",14,0)
 ;I $D(^TMP("PSODAOC",$J,"CROC")) D CROCLOG^PSOCROC
"RTN","PSONEWOC",15,0)
 ;I $D(^TMP("PSODAOC",$J,"DT")) S PSOKIND="DT",PSOZH="Duplicate Therapy" D SET ;dup drug therapy
"RTN","PSONEWOC",16,0)
 ;I $O(^TMP("PSODAOC",$J,"CPRS",0)) S PSOZH="Order Check" D CPRS^PSONEWO1 ;cprs order checks
"RTN","PSONEWOC",17,0)
 ;I $G(^TMP("PSODAOC",$J,"NOSYS",1,0))]"" D NOSYS^PSONEWO1 ;fdb down
"RTN","PSONEWOC",18,0)
 ;I $O(^TMP("PSODAOC",$J,"EXEC",0)) D EXEC^PSONEWO1 ;order chk execeptions
"RTN","PSONEWOC",19,0)
 ;I $O(^TMP("PSODAOC",$J,"DRG","ERROR",0))!($O(^TMP("PSODAOC",$J,"THP","ERROR",0))) D ERROR^PSONEWO1 ;order chk errors
"RTN","PSONEWOC",20,0)
 ;I $D(^TMP("PSODAOC",$J,"DOSE","ERROR")) D DERROR^PSONEWO1 ;dosing order chk errors
"RTN","PSONEWOC",21,0)
 ;I $O(^TMP("PSODAOC",$J,"DOSE","EXEC",0)) D DEXEC^PSONEWO1 ;dosing order chk exceptions
"RTN","PSONEWOC",22,0)
 ;I $O(^TMP("PSODAOC",$J,"DOSE","MSG",0)) D DMSG^PSONEWO1 ;dosing order chk messages
"RTN","PSONEWOC",23,0)
 ;I $G(^TMP("PSODAOC",$J,"DOSE NOSYS",1,0))]"" D NODSYS^PSONEWO1 ;dosing fdb down
"RTN","PSONEWOC",24,0)
 K CT,IT,PSODAOC,I,PI,XZX,ZZCOPY,PSOZH
"RTN","PSONEWOC",25,0)
 Q
"RTN","PSONEWOC",26,0)
 ;
"RTN","PSONEWOC",27,0)
SET ;DEFINED 100.05
"RTN","PSONEWOC",28,0)
 N DA,DIC,DIE,OCCDT,ORN,ORL,RET,SEV,ZOC,ZZX,ZTOT,ZDRG,ZORT,ZCHK,ZCLZ,ZX,PSODAOCN,PSOSTYP,CLASS,CLASSIEN,STATUS,ODA,ZVA,PSORDRG,SEVERITY
"RTN","PSONEWOC",29,0)
 S RXN=ZRXN
"RTN","PSONEWOC",30,0)
 S PSODAOC=$$LBL(RXN)
"RTN","PSONEWOC",31,0)
 S OCCDT=$$NOW^XLFDT,ORN=$P(^PSRX(RXN,"OR1"),"^",2),ZCLZ=""
"RTN","PSONEWOC",32,0)
 ;
"RTN","PSONEWOC",33,0)
 S (ZCLZ,SEV,ZVA)="",ZX=0
"RTN","PSONEWOC",34,0)
 F  S SEV=$O(^TMP("PSODAOC",$J,PSOKIND,SEV)) Q:SEV=""!(SEV="Z")  F  S ZVA=$O(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA)) Q:ZVA=""  D
"RTN","PSONEWOC",35,0)
 .S (PSOSTYP,SEVERITY,IT,ODA)=""
"RTN","PSONEWOC",36,0)
 .K DA,DIC,DIE
"RTN","PSONEWOC",37,0)
 .I PSOKIND="DD" D  S SEVERITY=16
"RTN","PSONEWOC",38,0)
 ..S PI=0,PSOSTYP=50 F  S PSOSTYP=$O(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,PSOSTYP)) Q:PSOSTYP=""  F  S PI=$O(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,PSOSTYP,"CLASS",PI)) Q:'PI  D
"RTN","PSONEWOC",39,0)
 ...S (CLASSIEN,CLASS)="",CLASS=^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,PSOSTYP,"CLASS",PI,0) ;,CLASSIEN=$O(^PS(50.605,"B",CLASS,CLASSIEN))  
"RTN","PSONEWOC",40,0)
 ...S:CLASS'="" ZCLZ=ZCLZ_", "_CLASS
"RTN","PSONEWOC",41,0)
 ..S ZCLZ=$E(ZCLZ,3,999)
"RTN","PSONEWOC",42,0)
 .I PSOKIND="DI" D
"RTN","PSONEWOC",43,0)
 ..S IT=$G(^TMP("PSODAOC",$J,"DI","Z","INT")),SEVERITY=$S(SEV="C":18,1:31)
"RTN","PSONEWOC",44,0)
 .K DA,RET,ORL
"RTN","PSONEWOC",45,0)
 .I PSOKIND="DT" S SEVERITY=17
"RTN","PSONEWOC",46,0)
 .S ORL(1,1)=ORN_"^"_$S($D(PSJDAOC):PSJDAOC,1:PSODAOC)_"^"_DUZ_"^"_OCCDT_"^"_SEVERITY
"RTN","PSONEWOC",47,0)
 .S ORL(1,2,1)=PSOZH_" exists for this medication." S:PSOKIND="DD" ORL(1,2,1)=ORL(1,2,1)_$S(ZCLZ'="":"["_ZCLZ_"]",1:"") K ZCLZ
"RTN","PSONEWOC",48,0)
 .D SAVEOC^OROCAPI1(.ORL,.RET)
"RTN","PSONEWOC",49,0)
 .S DA=$O(RET(1,0)) Q:'DA
"RTN","PSONEWOC",50,0)
 .S:ODA'=DA ODA=DA
"RTN","PSONEWOC",51,0)
 .;S STATUS="",STATUS=$$GET1^DIQ(52,RXN,100,"I")
"RTN","PSONEWOC",52,0)
 .S DR="1///6"
"RTN","PSONEWOC",53,0)
 .S:$G(IT) DR=DR_";81///"_IT
"RTN","PSONEWOC",54,0)
 .S DIE="^ORD(100.05,",DR=DR_$S(PSOKIND="DI":";83///"_SEV_";84///C",PSOKIND="DD":";84///V",1:";84///C")
"RTN","PSONEWOC",55,0)
 .I $E(DR,1)=";" S DR=$E(DR,2,999)
"RTN","PSONEWOC",56,0)
 .D ^DIE
"RTN","PSONEWOC",57,0)
 .D SET2
"RTN","PSONEWOC",58,0)
 K DR
"RTN","PSONEWOC",59,0)
 Q
"RTN","PSONEWOC",60,0)
 ;
"RTN","PSONEWOC",61,0)
SET2 ;
"RTN","PSONEWOC",62,0)
 ; #50 - DISPENSE DRUGS^100.06PA^^5;0
"RTN","PSONEWOC",63,0)
 I $D(^TMP("PSODAOC",$J,PSOKIND,ZVA,50)) S X="",X=$O(^TMP("PSODAOC",$J,PSOKIND,ZVA,50,X)) D
"RTN","PSONEWOC",64,0)
 .K DIC,DIE
"RTN","PSONEWOC",65,0)
 .S DA(1)=DA,DIC="^ORD(100.05,"_DA(1)_",5,",DIC(0)="Z"
"RTN","PSONEWOC",66,0)
 .D FILE^DICN K X
"RTN","PSONEWOC",67,0)
 ;
"RTN","PSONEWOC",68,0)
GRP1 ;
"RTN","PSONEWOC",69,0)
 ; #60 - GROUP ONE PHARMACY ORDERS^100.07VA^^6;0
"RTN","PSONEWOC",70,0)
 ; OP PENDING ORDERS - IEN;PS(52.41,
"RTN","PSONEWOC",71,0)
 ; IP RX - IEN;PS(53.1,
"RTN","PSONEWOC",72,0)
 ; OP RX - IEN;PSRX(
"RTN","PSONEWOC",73,0)
 S ZX=0
"RTN","PSONEWOC",74,0)
 F  S ZX=$O(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,60,ZX)) Q:'ZX!(ZX="CL")  D
"RTN","PSONEWOC",75,0)
 .S ZORT="",ZORT=^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,60,ZX,0)
"RTN","PSONEWOC",76,0)
 .S DA(1)=DA,X=ZORT,DIC="^ORD(100.05,"_DA(1)_",6,",DIC(0)="Z"
"RTN","PSONEWOC",77,0)
 .D FILE^DICN
"RTN","PSONEWOC",78,0)
 .K DIC
"RTN","PSONEWOC",79,0)
 .S ODA(1)=DA(1)
"RTN","PSONEWOC",80,0)
 .;I $D(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,60,"CL")) S PSODAOCN=60 D CLINEFF S DA=ODA,DA(1)=ODA(1)
"RTN","PSONEWOC",81,0)
 ;
"RTN","PSONEWOC",82,0)
GRP2 ;
"RTN","PSONEWOC",83,0)
 ;GROUP TWO PHARMACY ORDER FIELD (#70)
"RTN","PSONEWOC",84,0)
 ;Data is formatted as follows:
"RTN","PSONEWOC",85,0)
 ;"N;ien" => Non-VA Medications  ^PS(55,DFN,"NVA",ien)
"RTN","PSONEWOC",86,0)
 ;"R;rx#" => Remote Outpatient   ^PSRX(ien  Prescription Number
"RTN","PSONEWOC",87,0)
 S ZX=0 F  S ZX=$O(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,70,ZX)) Q:'ZX!(ZX="CL")  D
"RTN","PSONEWOC",88,0)
 .S ZORT="",ZORT=^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,70,ZX,0)
"RTN","PSONEWOC",89,0)
 .N PSORIEN,PSORSITI,PSORSITE
"RTN","PSONEWOC",90,0)
 .I $P(ZORT,";")="R" D
"RTN","PSONEWOC",91,0)
 ..S PSORIEN=$P($P(ZORT,"^",1),";",2),PSORSITE=$P(ZORT,"^",2),PSORDRG=$P(ZORT,"^",5)
"RTN","PSONEWOC",92,0)
 ..S:PSORSITE'="" PSORSITI=$O(^DIC(4,"B",PSORSITE,PSORSITI))
"RTN","PSONEWOC",93,0)
 ..S ZORT="R;"_PSORIEN_"^"_PSORSITI
"RTN","PSONEWOC",94,0)
 .K DIC
"RTN","PSONEWOC",95,0)
 .S DA(1)=DA,X=ZORT,DIC="^ORD(100.05,"_DA(1)_",7,",DIC(0)="Z"
"RTN","PSONEWOC",96,0)
 .D FILE^DICN
"RTN","PSONEWOC",97,0)
 .K DIC
"RTN","PSONEWOC",98,0)
 .;I $D(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,70,"CL")) S PSODAOCN=70 D CLINEFF S DA=ODA,DA(1)=ODA(1)
"RTN","PSONEWOC",99,0)
 ;Q
"RTN","PSONEWOC",100,0)
 ;
"RTN","PSONEWOC",101,0)
CLINEFF ;clinical effects
"RTN","PSONEWOC",102,0)
 N PSOFILE,PSOIENS,PSOCLEFF,DIWL,DIWR,DIWF,DINUM,DR,OLDX,OLD
"RTN","PSONEWOC",103,0)
 Q:'$D(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,"CL"))
"RTN","PSONEWOC",104,0)
 K DIC,^UTILITY($J,"W")
"RTN","PSONEWOC",105,0)
 S DIWL=1,DIWR=78,DIWF="",(DINUM,PSOCLEFF,OLDX)=""
"RTN","PSONEWOC",106,0)
 I SEV="S" S X="*** Refer to MONOGRAPH for SIGNIFICANT INTERACTION CLINICAL EFFECTS" D ^DIWP G CLINEFF1
"RTN","PSONEWOC",107,0)
 F  S PSOCLEFF=$O(^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,"CL",PSOCLEFF)) Q:PSOCLEFF=""  D  S OLDX=X
"RTN","PSONEWOC",108,0)
 .S X="",X=^TMP("PSODAOC",$J,PSOKIND,SEV,ZVA,"CL",PSOCLEFF,0) I X'=OLDX D ^DIWP
"RTN","PSONEWOC",109,0)
CLINEFF1 ;
"RTN","PSONEWOC",110,0)
 S X="",DIC="^ORD(100.05,"_DA(1)_",10,",DIC(0)="Z"
"RTN","PSONEWOC",111,0)
 S (DA,DINUM)=$O(^ORD(100.05,DA(1),10,9999),-1)+1
"RTN","PSONEWOC",112,0)
 D FILE^DICN
"RTN","PSONEWOC",113,0)
 K DIC,DIE,DR
"RTN","PSONEWOC",114,0)
 S PSOFILE=100.05,PSOCLEFF="",PSOCLEFF=$NA(^UTILITY($J,"W",1))
"RTN","PSONEWOC",115,0)
 D WP^DIE(PSOFILE,DA(1),100,"A",PSOCLEFF,"PSOER")
"RTN","PSONEWOC",116,0)
 K ^UTILITY($J,"W")
"RTN","PSONEWOC",117,0)
 ;
"RTN","PSONEWOC",118,0)
 ;for some strange reason if you put the following code before CLINEFF the clinical effects aren't stored.
"RTN","PSONEWOC",119,0)
 K DIC,DIE,DIR,DA
"RTN","PSONEWOC",120,0)
 S DA=ODA
"RTN","PSONEWOC",121,0)
 I $P(ZORT,";")="R" D
"RTN","PSONEWOC",122,0)
 .S DIE="^ORD(100.05,"_DA_",7,",DA(2)=DA,DA(1)=7,DR="2///"_PSORSITI
"RTN","PSONEWOC",123,0)
 .S DA=99999,DA=$O(^ORD(100.05,DA(2),7,DA),-1)
"RTN","PSONEWOC",124,0)
 .D ^DIE
"RTN","PSONEWOC",125,0)
 Q
"RTN","PSONEWOC",126,0)
 ;
"RTN","PSONEWOC",127,0)
LBL(RXN) ;
"RTN","PSONEWOC",128,0)
 ;Q "OP "_$S($G(ZZVER):"Verification ",$G(ZFRENEW):"CPRS RENEWAL ",$G(ZZEDIT):"EDIT ",$G(ZZCOPY):"COPY ",$G(PSOREINS):"REINSTATE ",$P(^PSRX(RXN,"STA"),"^")=1:"NON-VERIFIED ",$G(PSOARENW)=1:"RENEWAL ",1:"NEW ")_$G(PSOZH)
"RTN","PSONEWOC",129,0)
LBL2 ;
"RTN","PSONEWOC",130,0)
 N TEXT
"RTN","PSONEWOC",131,0)
 S TEXT="",TEXT="OP "_$S('$D(^XUSEC("PSORPH",DUZ))&($P(^PSRX(RXN,"STA"),"^")):"Non-Verified ",$D(^XUSEC("PSORPH",DUZ))&($G(ZZVER)):"RPh Verification ",1:"")
"RTN","PSONEWOC",132,0)
 S TEXT=TEXT_$S($G(ZFRENEW):"CPRS RENEWAL ",$G(ZZEDIT):"EDIT ",$G(ZZCOPY):"COPY ",$G(PSOREINS):"REINSTATE ",$G(PSOARENW)=1:"RENEWAL ",1:"NEW ")
"RTN","PSONEWOC",133,0)
 Q TEXT
"RTN","PSOOCKV1")
0^21^B14894586
"RTN","PSOOCKV1",1,0)
PSOOCKV1 ; BIR/SAB - displays stored order checks ;01/22/13  02:22
"RTN","PSOOCKV1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**411**;DEC 1997;Build 95
"RTN","PSOOCKV1",3,0)
 ;External reference to ^PSS55 supported by DBIA 4826
"RTN","PSOOCKV1",4,0)
 ;
"RTN","PSOOCKV1",5,0)
UD ;
"RTN","PSOOCKV1",6,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOOCKV1",7,0)
 N OLDIEN,UDDOSE,UDSTRT,UDSTOP,UDSEQ,UDDRG,UDSCHED S OLDIEN=IEN
"RTN","PSOOCKV1",8,0)
 D PSS431^PSS55(DFN,+ZIEN,"","","PSS55U")
"RTN","PSOOCKV1",9,0)
 D PSS433^PSS55(DFN,"PSS55U2")
"RTN","PSOOCKV1",10,0)
 S IEN=OLDIEN
"RTN","PSOOCKV1",11,0)
 S UDSEQ=0 F  S UDSEQ=$O(^TMP($J,"PSS55U",+ZIEN,"DDRUG",UDSEQ)) Q:UDSEQ=""  I $D(^TMP($J,"PSS55U",+ZIEN,"DDRUG",UDSEQ,.01)) D
"RTN","PSOOCKV1",12,0)
 .S (UDDRG,UDSCHED,UDDOSE,UDSTRT,UDSTOP)=""
"RTN","PSOOCKV1",13,0)
 .S UDDRG=^TMP($J,"PSS55U",+ZIEN,"DDRUG",UDSEQ,.01)
"RTN","PSOOCKV1",14,0)
 .S:$D(^TMP($J,"PSS55U",+ZIEN,26)) UDSCHED=^TMP($J,"PSS55U",+ZIEN,26)
"RTN","PSOOCKV1",15,0)
 .S:$D(^TMP($J,"PSS55U",+ZIEN,109)) UDDOSE=^TMP($J,"PSS55U",+ZIEN,109)
"RTN","PSOOCKV1",16,0)
 .S:$D(^TMP($J,"PSS55U",+ZIEN,10)) UDSTRT=^TMP($J,"PSS55U",+ZIEN,10)
"RTN","PSOOCKV1",17,0)
 .S:$D(^TMP($J,"PSS55U2",+ZIEN,34)) UDSTOP=^TMP($J,"PSS55U2",+ZIEN,34)
"RTN","PSOOCKV1",18,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Clinic Order: "_$P(UDDRG,"^",2)  ;$$GET1^DIQ(55.07,"1,"_ZIEN_","_DFN_",",.01)
"RTN","PSOOCKV1",19,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="    Schedule: "_UDSCHED
"RTN","PSOOCKV1",20,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="      Dosage: "_UDDOSE
"RTN","PSOOCKV1",21,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="  Start Date: "_$S($P(UDSTRT,"^",2)'="":$P(UDSTRT,"^",2),1:"********")
"RTN","PSOOCKV1",22,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="   Stop Date: "_$S($P(UDSTOP,"^",2)'="":$P(UDSTOP,"^",2),1:"********")
"RTN","PSOOCKV1",23,0)
 K ^TMP($J,"PSS55U"),^TMP($J,"PSS55U2")
"RTN","PSOOCKV1",24,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOOCKV1",25,0)
 Q
"RTN","PSOOCKV1",26,0)
 ;
"RTN","PSOOCKV1",27,0)
IV ;
"RTN","PSOOCKV1",28,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOOCKV1",29,0)
 N OLDIEN,IVSTRT,IVSTOP,ADDNAM,ADDSTR,ADDSEQ,ADDBOT,SOLSEQ,IVSCHED,DA,DIE,DR,DIC,DIQ,ADDIA,INFUSE,INFUSE2,SOLSTR,SOLNAM
"RTN","PSOOCKV1",30,0)
 K ^UTILITY("DIQ1",$J)
"RTN","PSOOCKV1",31,0)
 S OLDIEN=IEN
"RTN","PSOOCKV1",32,0)
 D PSS436^PSS55(DFN,+ZIEN,"PSS55ICL")
"RTN","PSOOCKV1",33,0)
 Q:'$P($G(^TMP($J,"PSS55ICL",0)),"^")
"RTN","PSOOCKV1",34,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOOCKV1",35,0)
 S IEN=OLDIEN,IVSCHED=""
"RTN","PSOOCKV1",36,0)
 S X="Clinic Order: ",ADDSEQ=0,(IVSTRT,IVSTOP,IVSCHED)=""
"RTN","PSOOCKV1",37,0)
 S:$D(^TMP($J,"PSS55ICL",+ZIEN,.02)) IVSTRT=^TMP($J,"PSS55ICL",+ZIEN,.02),IVSTRT=$P(IVSTRT,"^",2)
"RTN","PSOOCKV1",38,0)
 S:$D(^TMP($J,"PSS55ICL",+ZIEN,.03)) IVSTOP=^TMP($J,"PSS55ICL",+ZIEN,.03),IVSTOP=$P(IVSTOP,"^",2)
"RTN","PSOOCKV1",39,0)
 S:$D(^TMP($J,"PSS55ICL",+ZIEN,.09)) IVSCHED=^TMP($J,"PSS55ICL",+ZIEN,.09)
"RTN","PSOOCKV1",40,0)
 F  S ADDSEQ=$O(^TMP($J,"PSS55ICL",+ZIEN,"ADD",ADDSEQ)) Q:ADDSEQ=""  D
"RTN","PSOOCKV1",41,0)
 .S (ADDNAM,ADDSTR,ADDBOT,INFUSE)=""
"RTN","PSOOCKV1",42,0)
 .S:$D(^TMP($J,"PSS55ICL",+ZIEN,"ADD",ADDSEQ,.01)) ADDNAM=$P(^TMP($J,"PSS55ICL",+ZIEN,"ADD",ADDSEQ,.01),"^",2)
"RTN","PSOOCKV1",43,0)
 .S:$D(^TMP($J,"PSS55ICL",+ZIEN,"ADD",ADDSEQ,.02)) ADDSTR=^TMP($J,"PSS55ICL",+ZIEN,"ADD",ADDSEQ,.02)
"RTN","PSOOCKV1",44,0)
 .S:$D(^TMP($J,"PSS55ICL",+ZIEN,"ADD",ADDSEQ,.03)) ADDBOT=^TMP($J,"PSS55ICL",+ZIEN,"ADD",ADDSEQ,.03)
"RTN","PSOOCKV1",45,0)
 .Q:ADDNAM=""
"RTN","PSOOCKV1",46,0)
 .S ADDIA=""
"RTN","PSOOCKV1",47,0)
 .I $D(ADD(+ZIEN)) S ADDIA=ADD(+ZIEN)
"RTN","PSOOCKV1",48,0)
 .S X=X_$S(ADDIA[ADDNAM:"*",1:" ")_ADDNAM_" "_ADDSTR S:ADDBOT'="" X=X_" ("_ADDBOT_")"
"RTN","PSOOCKV1",49,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=X,X="              "
"RTN","PSOOCKV1",50,0)
 S X="               in ",SOLSEQ=0
"RTN","PSOOCKV1",51,0)
 F  S SOLSEQ=$O(^TMP($J,"PSS55ICL",+ZIEN,"SOL",SOLSEQ)) Q:SOLSEQ=""  D
"RTN","PSOOCKV1",52,0)
 .S (SOLNAM,SOLSTR,INFUSE,INFUSE2)=""
"RTN","PSOOCKV1",53,0)
 .I $D(^TMP($J,"PSS55ICL",+ZIEN,"SOL",SOLSEQ,.01)) S SOLNAM=$P(^TMP($J,"PSS55ICL",+ZIEN,"SOL",SOLSEQ,.01),"^",2)
"RTN","PSOOCKV1",54,0)
 .I $D(^TMP($J,"PSS55ICL",+ZIEN,"SOL",SOLSEQ,1)) S SOLSTR=^TMP($J,"PSS55ICL",+ZIEN,"SOL",SOLSEQ,1)
"RTN","PSOOCKV1",55,0)
 .I $D(^TMP($J,"PSS55ICL",+ZIEN,.08)) S INFUSE=^TMP($J,"PSS55ICL",+ZIEN,.08),INFUSE=$P(INFUSE,"@")
"RTN","PSOOCKV1",56,0)
 .Q:SOLNAM=""
"RTN","PSOOCKV1",57,0)
 .S X=X_SOLNAM_" "_$P(SOLSTR,"^",2)_" @ "_INFUSE,IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=X,X="                  "
"RTN","PSOOCKV1",58,0)
 S X="    Schedule: "_IVSCHED
"RTN","PSOOCKV1",59,0)
 S X="  Start Date: "_IVSTRT,IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=X
"RTN","PSOOCKV1",60,0)
 S X="   Stop Date: "_IVSTOP,IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=X
"RTN","PSOOCKV1",61,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" "
"RTN","PSOOCKV1",62,0)
 K ^TMP($J,"PSS55ICL"),X
"RTN","PSOOCKV1",63,0)
 Q
"RTN","PSOORCPY")
0^28^B34153930
"RTN","PSOORCPY",1,0)
PSOORCPY ;BIR/SAB-copy orders from backdoor ;10/17/96
"RTN","PSOORCPY",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,21,27,32,46,100,117,148,313,411**;DEC 1997;Build 95
"RTN","PSOORCPY",3,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSOORCPY",4,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSOORCPY",5,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOORCPY",6,0)
 ;External reference to L^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",7,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",8,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",9,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOORCPY",10,0)
 ;I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOORCPY",11,0)
 ;
"RTN","PSOORCPY",12,0)
 ; Cleaning up Titration/Maintenance variables (they shouldn't be defined - just to be safe)
"RTN","PSOORCPY",13,0)
 K PSOMTFLG,PSOTITRX
"RTN","PSOORCPY",14,0)
COPY ; Rx Copy Functionality 
"RTN","PSOORCPY",15,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSOORCPY",16,0)
 I '$G(PSOMTFLG),$$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" S VALMSG="Cannot Copy a 'Titration Rx'.",VALMBCK="" W $C(7) Q
"RTN","PSOORCPY",17,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOORCPY",18,0)
 I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item !",VALMBCK="" K PSOCOPY D ^PSOBUILD Q
"RTN","PSOORCPY",19,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOORCPY",20,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSOORCPY",21,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG G EX
"RTN","PSOORCPY",22,0)
 N VALMCNT K PSOEDIT S (PSOCOPY,COPY,PSORXED,ZZCOPY)=1 D FULL^VALM1
"RTN","PSOORCPY",23,0)
 S PSORXED("DFLG")=0,(RXN,DA,PSORXED("IRXN"))=$P(PSOLST(ORN),"^",2),PSORXED("RX0")=^PSRX(PSORXED("IRXN"),0),PSORXED("RX2")=$G(^(2)),PSORXED("RX3")=$G(^(3)),PSOI=$P($G(^("OR1")),"^"),PSOSIG=$P($G(^("SIG")),"^"),STAT=+^("STA")
"RTN","PSOORCPY",24,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORCPY",25,0)
 S:$G(^PSRX(PSORXED("IRXN"),"INSS"))]"" PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORCPY",26,0)
 S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORCPY",27,0)
 I '$O(PSORXED("SIG",0)),$G(PSORXED("INS"))]"" S PSORXED("SIG",1)=PSORXED("INS")
"RTN","PSOORCPY",28,0)
 I $G(^PSRX(PSORXED("IRXN"),"TN"))]"" S PSODRUG("TRADE NAME")=^PSRX(PSORXED("IRXN"),"TN")
"RTN","PSOORCPY",29,0)
 ;
"RTN","PSOORCPY",30,0)
 ; - This call copies the dosage into the new order and also split the Maintenance dose (if the case)
"RTN","PSOORCPY",31,0)
 D BLDDOSE(.PSORXED,$G(PSOMTFLG))
"RTN","PSOORCPY",32,0)
 ;
"RTN","PSOORCPY",33,0)
 I $G(^PSDRUG($P(PSORXED("RX0"),"^",6),"I"))]"",^("I")<DT S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"This drug has been inactivated!" S VALMBCK="R" G OUT
"RTN","PSOORCPY",34,0)
 I $P(^PSDRUG($P(PSORXED("RX0"),"^",6),2),"^",3)'["O" S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Drug no longer used by Outpatient!",VALMBCK="R" G OUT
"RTN","PSOORCPY",35,0)
 ;Check for invalid Dosage
"RTN","PSOORCPY",36,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=PSORXED("IRXN") D CDOSE^PSORENW0
"RTN","PSOORCPY",37,0)
 I PSOOLPF D  S VALMBCK="R" G OUT
"RTN","PSOORCPY",38,0)
 .S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Invalid Dosage of "_$G(PSOOLPD)
"RTN","PSOORCPY",39,0)
 I PSONOSIG D  S VALMBCK="R" G OUT
"RTN","PSOORCPY",40,0)
 .S VALMSG=$S('$G(PSOMTFLG):"Cannot COPY. ",1:"")_"Missing Sig"
"RTN","PSOORCPY",41,0)
 I '$P($G(^PSDRUG($P(PSORXED("RX0"),"^",6),2)),"^") S VALMBCK="R" G OUT
"RTN","PSOORCPY",42,0)
 S DREN=$P(PSORXED("RX0"),"^",6),PSODAYS=$P(PSORXED("RX0"),"^",8)
"RTN","PSOORCPY",43,0)
 S PSORXST=+$P($G(^PS(53,$P(PSORXED("RX0"),"^",3),0)),"^",7)
"RTN","PSOORCPY",44,0)
 S POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORCPY",45,0)
 I $G(PSORX("DFLG")) S VALMBCK="R"
"RTN","PSOORCPY",46,0)
 ;
"RTN","PSOORCPY",47,0)
 I $G(PSOMTFLG) D  I $G(PSORXED("DFLG")) S VALMBCK="R" G OUT
"RTN","PSOORCPY",48,0)
 . S PSORXED("DAYS SUPPLY")=PSODAYS,PSORXED("QTY")=+$$GET1^DIQ(52,PSORXED("IRXN"),7)
"RTN","PSOORCPY",49,0)
 . W !!,"New Maintenance Rx (Review Quantity):",!,"Drug: ",$$GET1^DIQ(52,PSORXED("IRXN"),6)
"RTN","PSOORCPY",50,0)
 . D EN^PSOFSIG(.PSORXED,1) W !,"Days Supply: ",PSODAYS
"RTN","PSOORCPY",51,0)
 . N PSOQTY S PSORXED("FLD")=5 D QTY^PSODIR1(.PSORXED) W !
"RTN","PSOORCPY",52,0)
 ;
"RTN","PSOORCPY",53,0)
 D EN^PSOORED1(.PSORXED) I $G(PSORX("FN")) S VALMBCK="Q",PSOFROM="NEW" D DCORD^PSONEW2
"RTN","PSOORCPY",54,0)
 E  S VALMBCK="R"
"RTN","PSOORCPY",55,0)
OUT ;
"RTN","PSOORCPY",56,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOORCPY",57,0)
 K PSOCOPY D ^PSOBUILD,ACT^PSOORNE2
"RTN","PSOORCPY",58,0)
EX S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSOORCPY",59,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOORCPY",60,0)
 K PSOMSG,PSONEW,PSOSIG,STA,DREN,PSODAYS,PSORXST,PSOCOPY,PSORXED,FST,FLD,IEN,FLN,INCOM,PSOI,COPY,SIG,SIGOK
"RTN","PSOORCPY",61,0)
 K PSODRUG,^TMP("PSOPO",$J),PSOMTFLG
"RTN","PSOORCPY",62,0)
 D CLEAN^PSOVER1,EOJ^PSONEW K ZZCOPY
"RTN","PSOORCPY",63,0)
 Q
"RTN","PSOORCPY",64,0)
LOCK ;
"RTN","PSOORCPY",65,0)
 I $P($G(PSOPLCK),"^")'=0 Q
"RTN","PSOORCPY",66,0)
 W !!,$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2),1:"Another person")_" is working on this patient."
"RTN","PSOORCPY",67,0)
 K DIR S DIR(0)="E",DIR("A")="     Press Return to Continue" D ^DIR K DIR
"RTN","PSOORCPY",68,0)
 Q
"RTN","PSOORCPY",69,0)
 ;
"RTN","PSOORCPY",70,0)
BLDDOSE(PSORXED,MAINTRXF) ; Copies the Dose from Original Rx into Copied/Maintenance Dose Rx
"RTN","PSOORCPY",71,0)
 N DOSEIEN,DOSE
"RTN","PSOORCPY",72,0)
 ; - Copying from the last THEN conjunction (Maintenance Dose Rx)
"RTN","PSOORCPY",73,0)
 ; - For Titration/Maintenance, DOSEIEN = the IEN in the prescription of the last THEN conjunction.
"RTN","PSOORCPY",74,0)
 ; - This value is used as a "seed" for the FOR loop starting point.
"RTN","PSOORCPY",75,0)
 I $G(MAINTRXF) D  Q
"RTN","PSOORCPY",76,0)
 . D LASTTHEN
"RTN","PSOORCPY",77,0)
 . S PSORXED("ENT")=0
"RTN","PSOORCPY",78,0)
 . F  S DOSEIEN=$O(^PSRX(PSORXED("IRXN"),6,DOSEIEN))  Q:'DOSEIEN  D
"RTN","PSOORCPY",79,0)
 . . S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0) D
"RTN","PSOORCPY",80,0)
 . . Q:$P(DOSE,"^")']""!($P(DOSE,"^",8)']"")
"RTN","PSOORCPY",81,0)
 . . S PSORXED("ENT")=PSORXED("ENT")+1
"RTN","PSOORCPY",82,0)
 . . D SETDOSE(.PSORXED,DOSEIEN,PSORXED("ENT"))
"RTN","PSOORCPY",83,0)
 . . D EN^PSOFSIG(.PSORXED)
"RTN","PSOORCPY",84,0)
 ;
"RTN","PSOORCPY",85,0)
 ; - Copying dose for Regular Rx Copy
"RTN","PSOORCPY",86,0)
 S PSORXED("ENT")=0
"RTN","PSOORCPY",87,0)
 F DOSEIEN=0:0 S DOSEIEN=$O(^PSRX(PSORXED("IRXN"),6,DOSEIEN)) Q:'DOSEIEN  D
"RTN","PSOORCPY",88,0)
 . S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0) D
"RTN","PSOORCPY",89,0)
 . Q:$P(DOSE,"^")']""!($P(DOSE,"^",8)']"")
"RTN","PSOORCPY",90,0)
 . S PSORXED("ENT")=PSORXED("ENT")+1
"RTN","PSOORCPY",91,0)
 . D SETDOSE(.PSORXED,DOSEIEN,PSORXED("ENT"))
"RTN","PSOORCPY",92,0)
 Q
"RTN","PSOORCPY",93,0)
 ;
"RTN","PSOORCPY",94,0)
SETDOSE(PSORXED,DOSEIEN,DOSESEQ) ; Sets the Dose in the PSORXED array
"RTN","PSOORCPY",95,0)
 N DOSE
"RTN","PSOORCPY",96,0)
 S DOSE=^PSRX(PSORXED("IRXN"),6,DOSEIEN,0)
"RTN","PSOORCPY",97,0)
 S PSORXED("DOSE",DOSESEQ)=$P(DOSE,"^")
"RTN","PSOORCPY",98,0)
 S PSORXED("UNITS",DOSESEQ)=$P(DOSE,"^",3)
"RTN","PSOORCPY",99,0)
 S PSORXED("DOSE ORDERED",DOSESEQ)=$P(DOSE,"^",2)
"RTN","PSOORCPY",100,0)
 S PSORXED("ROUTE",DOSESEQ)=$P(DOSE,"^",7)
"RTN","PSOORCPY",101,0)
 S PSORXED("SCHEDULE",DOSESEQ)=$P(DOSE,"^",8)
"RTN","PSOORCPY",102,0)
 S PSORXED("DURATION",DOSESEQ)=$P(DOSE,"^",5)
"RTN","PSOORCPY",103,0)
 S PSORXED("CONJUNCTION",DOSESEQ)=$P(DOSE,"^",6)
"RTN","PSOORCPY",104,0)
 S PSORXED("VERB",DOSESEQ)=$P(DOSE,"^",9)
"RTN","PSOORCPY",105,0)
 I $G(^PSRX(PSORXED("IRXN"),6,DOSEIEN,1))]"" D
"RTN","PSOORCPY",106,0)
 . S PSORXED("ODOSE",DOSESEQ)=^PSRX(PSORXED("IRXN"),6,DOSEIEN,1)
"RTN","PSOORCPY",107,0)
 I $G(PSORXED("DURATION",DOSESEQ))]"" D  K DR,DUR1
"RTN","PSOORCPY",108,0)
 . S DUR1=PSORXED("DURATION",DOSESEQ)
"RTN","PSOORCPY",109,0)
 . S PSORXED("DURATION",DOSESEQ)=$S($E(DUR1,1)'?.N:$E(DUR1,2,99)_$E(DUR1,1),1:DUR1)
"RTN","PSOORCPY",110,0)
 S PSORXED("NOUN",DOSESEQ)=$P(DOSE,"^",4)
"RTN","PSOORCPY",111,0)
 Q
"RTN","PSOORCPY",112,0)
 ;
"RTN","PSOORCPY",113,0)
LASTTHEN ; Determine the IEN of the last THEN conjunction on this prescription and set DOSEIEN to its value.
"RTN","PSOORCPY",114,0)
 N LASTTHEN,LAST
"RTN","PSOORCPY",115,0)
 S LASTTHEN="" F  S LASTTHEN=$O(^PSRX(PSORXED("IRXN"),6,LASTTHEN),-1) Q:LASTTHEN=""!($G(DOSEIEN)'="")  D
"RTN","PSOORCPY",116,0)
 . S DOSEIEN=""
"RTN","PSOORCPY",117,0)
 . S LAST=^PSRX(PSORXED("IRXN"),6,LASTTHEN,0)
"RTN","PSOORCPY",118,0)
 . I $P(LAST,"^",6)="T" S DOSEIEN=LASTTHEN Q
"RTN","PSOORCPY",119,0)
 Q
"RTN","PSOOREDT")
0^27^B82334396
"RTN","PSOOREDT",1,0)
PSOOREDT ;BIR/SAB - Edit orders from backdoor ;5/8/08 3:27pm
"RTN","PSOOREDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,20,27,37,57,46,78,102,104,119,143,148,260,281,304,289,298,379,377,391,313,427,411**;DEC 1997;Build 95
"RTN","PSOOREDT",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOOREDT",4,0)
 ;External reference to L^PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",5,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",6,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",7,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOOREDT",8,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSOOREDT",9,0)
SEL K PSOISLKD,PSOLOKED S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY D SVAL K PSOPLCK S VALMBCK="" Q
"RTN","PSOOREDT",10,0)
 K PSOPLCK D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D UL^PSSLOCK(+$G(PSODFN)) D SVALO K PSOMSG S VALMBCK="" Q
"RTN","PSOOREDT",11,0)
 K PSOMSG S PSOLOKED=1
"RTN","PSOOREDT",12,0)
 S REF=0 S:$$LSTRFL^PSOBPSU1($P(PSOLST(ORN),"^",2)) REF=1  ;*377
"RTN","PSOOREDT",13,0)
 K PSORX("DFLG"),DIR,DUOUT,DIRUT S DIR("A")="Select fields by number"
"RTN","PSOOREDT",14,0)
 S DIR(0)="LO^1:"_$S($$STATUS^PSOBPSUT($P(PSOLST(ORN),"^",2))'="":21,$G(REF):20,1:19)
"RTN","PSOOREDT",15,0)
 D ^DIR I $D(DIRUT) K DIR,DIRUT,DTOUT S VALMBCK="" D UL K PSOLOKED Q
"RTN","PSOOREDT",16,0)
EDTSEL N VALMCNT K PSOISLKD,PSORX("DFLG"),PSOOIFLG,PSOMRFLG,DIR,DIRUT,DTOUT,DTOUT,ZONE S PSOQUIT=0,(PSOEDIT,PSORXED)=1 I +Y S FST=Y D HLDHDR^PSOLMUTL D  G EX ;PSO LM SELECT MENU protocol
"RTN","PSOOREDT",17,0)
 .I '$G(PSOLOKED) S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY D SVAL K PSOPLCK S VALMBCK="",(PSOISLKD,PSODE)=1 Q
"RTN","PSOOREDT",18,0)
 .I '$G(PSOLOKED) K PSOPLCK D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D UL^PSSLOCK(+$G(PSODFN)) D SVALO K PSOMSG S VALMBCK="",(PSOISLKD,PSODE)=1 Q
"RTN","PSOOREDT",19,0)
 .K PSOMSG,PSOPLCK S (NEWEDT,PSOLOKED)=1 D EDT
"RTN","PSOOREDT",20,0)
 E  S VALMBCK="",PSODE=1
"RTN","PSOOREDT",21,0)
EX I $G(PSOISLKD)!($G(PSOQUIT)) D UL K PSOISLKD G EX2
"RTN","PSOOREDT",22,0)
 I '$G(PSOSIGFL),'$G(PSORXED("DFLG")) D UPDATE^PSOORED6 D LOG^PSORXED,POST^PSORXED G EX1
"RTN","PSOOREDT",23,0)
 I $G(PSOSIGFL)=1 D  Q:$G(PSORX("FN"))
"RTN","PSOOREDT",24,0)
 .N PSOTMP
"RTN","PSOOREDT",25,0)
 .S PSOTMP=$G(PSOFROM),PSOFROM="NEW"
"RTN","PSOOREDT",26,0)
 .S VALMSG="This change will create a new prescription!",NCPDPFLG=1
"RTN","PSOOREDT",27,0)
 .D EN^PSOORED1(.PSORXED)
"RTN","PSOOREDT",28,0)
 .I $G(PSORX("FN")) D  Q
"RTN","PSOOREDT",29,0)
 ..D ^PSOBUILD
"RTN","PSOOREDT",30,0)
 ..K QUIT,PSORX("DFLG"),FST,FLD,IEN,FLN,INCOM,PSOI,PSODRUG,PSOEDIT
"RTN","PSOOREDT",31,0)
 ..K PSORENW,PSOSIGFL,PSOOIFLG,PSOMRFLG,PSODIR,CHK,PSORX("SIG"),PSODE
"RTN","PSOOREDT",32,0)
 ..K PSOTRN,PSORX("EDIT"),PSORXED("FLD"),NEWEDT
"RTN","PSOOREDT",33,0)
 ..S ZZEDIT=1 D EOJ^PSONEW K ZZEDIT
"RTN","PSOOREDT",34,0)
 ..D UL K PSOLOKED S VALMBCK="Q"
"RTN","PSOOREDT",35,0)
 .S PSOFROM=PSOTMP I PSOFROM="" K PSOFROM
"RTN","PSOOREDT",36,0)
 ;
"RTN","PSOOREDT",37,0)
EX1 I '$G(PSODE)!('$G(ZONE)) I $G(PSORENW("OIRXN")) D EN^PSOHLSN1(PSORENW("OIRXN"),"XX","","Order edited")
"RTN","PSOOREDT",38,0)
QUIT D UL K PSOLOKED D ^PSOBUILD,ACT^PSOORNE2 D:+^PSRX($P(PSOLST(ORN),"^",2),"STA")=5 EN^PSOCMOPC($P(PSOLST(ORN),"^",2))
"RTN","PSOOREDT",39,0)
 K:'$O(^PSRX($P(PSOLST(ORN),"^",2),1,0)) REF
"RTN","PSOOREDT",40,0)
EX2 S VALMBCK=$S($G(PSOQUIT):"R",$G(PSORX("FN")):"Q",$G(ZONE):"Q",1:"R")
"RTN","PSOOREDT",41,0)
 K PSORXED,FST,FLD,IEN,FLN,INCOM,PSOI,PSODRUG,PSOEDIT,PSORENW,PSOSIGFL,PSODIR,CHK,PSORX("SIG"),PSODE,PSOTRN,PSORX("DFLG"),RFED,ZONE,PSORX("EDIT"),PSOOIFLG,PSOMRFLG,SIG,QUIT,PSOQUIT
"RTN","PSOOREDT",42,0)
 K NEWEDT I $G(VALMBCK)="R" W ! D CLEAN^PSOVER1 H 2
"RTN","PSOOREDT",43,0)
 Q
"RTN","PSOOREDT",44,0)
 ;
"RTN","PSOOREDT",45,0)
EDT ; Rx Edit (Backdoor)
"RTN","PSOOREDT",46,0)
 K NCPDPFLG,PSOPKI,DEA
"RTN","PSOOREDT",47,0)
 S I=0 F  S I=$O(^PSRX($P(PSOLST(ORN),"^",2),1,I)) Q:'I  S PSORXED("RX1")=^PSRX($P(PSOLST(ORN),"^",2),1,I,0)
"RTN","PSOOREDT",48,0)
 ;*298 Track PI and Oth Lang PI
"RTN","PSOOREDT",49,0)
 S (RX0,PSORXED("RX0"))=^PSRX($P(PSOLST(ORN),"^",2),0),PSORXED("RX2")=$G(^(2)),PSORXED("RX3")=$G(^(3)),PSOSIG=$P(^("SIG"),"^"),PSOPINS=$G(^("INS")),PSOOINS=$G(^("INSS"))
"RTN","PSOOREDT",50,0)
 I '$D(PSODRUG) NEW PSOY S PSOY=$P(RX0,U,6),PSOY(0)=^PSDRUG(PSOY,0) D SET^PSODRG ; *298 moved this line from EDT+2  RX0 was not defined yet
"RTN","PSOOREDT",51,0)
 F FLD=1:1:$L(FST,",") Q:$P(FST,",",FLD)']""!($G(PSORXED("DFLG")))!($G(PSORX("DFLG")))  S FLN=+$P(FST,",",FLD) D
"RTN","PSOOREDT",52,0)
 .S PSORXED("DFLG")=0,(DA,PSORXED("IRXN"),PSORENW("OIRXN"))=$P(PSOLST(ORN),"^",2),RX0=^PSRX(PSORXED("IRXN"),0),PSOPKI=$P($G(^PSRX(PSORXED("IRXN"),"PKI")),"^") S:$G(PSOSIG)="" PSOSIG=$P(^("SIG"),"^")
"RTN","PSOOREDT",53,0)
 .;*298 Track PI and Oth Lang PI
"RTN","PSOOREDT",54,0)
 .S:$G(PSOPINS)="" PSOPINS=$G(^PSRX(DA,"INS")) S:$G(PSOOINS)="" PSOOINS=$G(^PSRX(DA,"INSS"))
"RTN","PSOOREDT",55,0)
 .I '$G(PSOSIGFL) D
"RTN","PSOOREDT",56,0)
 ..S PSOI=+^PSRX(DA,"OR1"),PSODAYS=$P(RX0,"^",8),PSORXST=+$P($G(^PS(53,$P(RX0,"^",3),0)),"^",7)
"RTN","PSOOREDT",57,0)
 ..I 'PSOI S PSOI=+^PSDRUG($P(RX0,"^",6),2),$P(^PSRX(DA,"OR1"),"^")=PSOI
"RTN","PSOOREDT",58,0)
 ..S:'$G(PSODRUG("IEN")) PSODRUG("IEN")=$P(RX0,"^",6),PSODRUG("NAME")=$P(^PSDRUG($P(RX0,"^",6),0),"^")
"RTN","PSOOREDT",59,0)
 ..S PSODRUG("OI")=PSOI
"RTN","PSOOREDT",60,0)
 .S PSORX("PROVIDER")=$P(RX0,"^",4),PSORX("PROVIDER NAME")=$P(^VA(200,$P(RX0,"^",4),0),"^"),PSOTRN=$G(^PSRX(DA,"TN"))
"RTN","PSOOREDT",61,0)
 .D:'$G(CHK) POP^PSOSIGNO(DA),CHK Q:$G(PSORXED("DFLG"))
"RTN","PSOOREDT",62,0)
 .S FDR="39.2^"_$S($P(PSOPAR,"^",3):"6",1:"")_";6.5^113^114^3^1^22R^24^8^7^9^4^11;"_$S($P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)):"35;",1:"")_"^10.6^5^20^23^12^PSOCOU^RF^81"
"RTN","PSOOREDT",63,0)
 .; Titration/Maintenance Rx check
"RTN","PSOOREDT",64,0)
 .I $$REQFLDS(FST),$$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  S PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",65,0)
 .. S VALMSG="Cannot edit Drug/Dose fields (Titration Rx).",VALMBCK="R" W $C(7)
"RTN","PSOOREDT",66,0)
 .D:'$G(CHK) POP^PSOSIGNO(DA),CHK Q:$G(PSORXED("DFLG"))
"RTN","PSOOREDT",67,0)
 .S FDR="39.2^"_$S($P(PSOPAR,"^",3):"6",1:"")_";6.5^113^114^3^1^22R^24^8^7^9^4^11;"_$S($P(RX0,"^",11)="W"&($P(PSOPAR,"^",12)):"35;",1:"")_"^10.6^5^20^23^12^PSOCOU^RF^81"
"RTN","PSOOREDT",68,0)
 .I $G(ST)=11!($G(ST)=12)!($G(ST)=14)!($G(ST)=15) D NDCDAWDE^PSOORED7(ST,FLN,$G(RXN)) Q
"RTN","PSOOREDT",69,0)
 .S REF=0 S:$$LSTRFL^PSOBPSU1($P(PSOLST(ORN),"^",2)) REF=1  ;*377
"RTN","PSOOREDT",70,0)
 .I FLN=20,'$G(REF) S VALMSG="There is no Refill Data to be edited." Q
"RTN","PSOOREDT",71,0)
 .S DR=$P(FDR,"^",FLN) I DR="RF" D REF^PSOORED2 Q
"RTN","PSOOREDT",72,0)
 .I DR="PSOCOU" D PSOCOU^PSOORED6 Q
"RTN","PSOOREDT",73,0)
 .; Allow edit of the NDC when the EDIT DRUG setting is off
"RTN","PSOOREDT",74,0)
 .; Other checks regarding if the NDC may be edited are found in NDC^PSODRG - PSO*7*427
"RTN","PSOOREDT",75,0)
 .I FLN=2,'$P(PSOPAR,"^",3) D  Q
"RTN","PSOOREDT",76,0)
 ..N NDC D NDC^PSODRG(RXN,0,,.NDC) I $G(NDC)="^"!($G(NDC)="") Q
"RTN","PSOOREDT",77,0)
 ..S (PSODRUG("NDC"),PSORXED("FLD",27))=NDC
"RTN","PSOOREDT",78,0)
 .I FLN'>2,'$P(PSOPAR,"^",3) S VALMSG="Check site parameters, Drug data is not editable." Q
"RTN","PSOOREDT",79,0)
 .I FLN=3 D EDTDOSE^PSOORED2,FULL^VALM1,POST^PSODRG S:$G(PSORX("DFLG")) PSOISLKD=1,PSORX("FN")=1 Q
"RTN","PSOOREDT",80,0)
 .I FLN=4 D INS^PSOORED1 Q
"RTN","PSOOREDT",81,0)
 .I FLN=1 D PSOI^PSOORED6 N PSOX S PSORXED=1,PSOX("IRXN")=$S($D(DA):DA,$D(PSORXED("IRXN")):PSORXED("IRXN"),$D(PSORENW("OIRXN")):PSORENW("OIRXN")) D:'$G(PSORXED("DFLG")) EN^PSODIAG Q
"RTN","PSOOREDT",82,0)
 .I FLN=2 D DRG^PSOORED6 N PSOX S PSORXED=1,PSOX("IRXN")=PSORXED("IRXN") D:'$G(PSORXED("DFLG")) EN^PSODIAG S:$O(^PSRX(PSORXED("IRXN"),1,0)) REF=1 Q
"RTN","PSOOREDT",83,0)
 .I FLN=12,PSOPKI W !!,"Digitally Signed Order - Provider can't be changed" D PAUSE Q
"RTN","PSOOREDT",84,0)
 .I FLN=12 D PROV Q
"RTN","PSOOREDT",85,0)
 .I FLN=6 D ISDT^PSOORED2 Q
"RTN","PSOOREDT",86,0)
 .I FLN=7 D FLDT^PSOORED2 Q
"RTN","PSOOREDT",87,0)
 .I FLN=21,$$STATUS^PSOBPSUT(RXN,0)="" S VALMSG="Invalid selection!" Q
"RTN","PSOOREDT",88,0)
 .I FLN=21 D  Q
"RTN","PSOOREDT",89,0)
 ..N DAW D EDTDAW^PSODAWUT(RXN,0,.DAW) I $G(DAW)="^" Q
"RTN","PSOOREDT",90,0)
 ..S (PSODRUG("DAW"),PSORXED("FLD",81))=DAW
"RTN","PSOOREDT",91,0)
 .I FLN=9!(FLN=10)!(FLN=11) D NOCHG^PSOORED7 Q
"RTN","PSOOREDT",92,0)
 .S DR=+DR
"RTN","PSOOREDT",93,0)
 .K DIR,DIRUT,DIROUT ;S DIE=52 D ^DIE I $D(Y) S PSORXED("DFLG")=1
"RTN","PSOOREDT",94,0)
 .K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED" D EN^DIQ1 K DIC,DIQ
"RTN","PSOOREDT",95,0)
 .S DIR("B")=$S($G(PSORXED("FLD",DR))]"":PSORXED("FLD",DR),1:PSORXED(52,DA,DR)),DIR(0)="52,"_DR D ^DIR
"RTN","PSOOREDT",96,0)
 .I DR=24!(DR=12) S PSORXED("FLD",DR)=X
"RTN","PSOOREDT",97,0)
 .I $D(DIRUT) K DIR,DIRUT,DUOUT,DTOUT,PSORXED(52,DA,DR),PSORXED("FLD",DR) Q
"RTN","PSOOREDT",98,0)
 .I DR'=5,X="@" W !,"Data Required!",! K DIC,DIQ,DR,DA,DIR,DIRUT,PSORXED(52,DA,DR),X,Y Q
"RTN","PSOOREDT",99,0)
 .I DR=5,X'="@" S Y=+Y
"RTN","PSOOREDT",100,0)
 .I DR=3!(DR=20)!(DR=23) S Y=+Y
"RTN","PSOOREDT",101,0)
 .S PSORXED("FLD",DR)=$S(X="@":X,1:Y) K DIR,DIRUT,DIROUT,X,Y,PSORXED(52,DA,DR)
"RTN","PSOOREDT",102,0)
 .I DR=11,PSORXED("FLD",DR)="W",$P(PSOPAR,"^",12) D
"RTN","PSOOREDT",103,0)
 ..D FIELD^DID(52,DR,"","LABEL","ZZ") S PSORXED(ZZ("LABEL"))=PSORXED("FLD",DR) K ZZ
"RTN","PSOOREDT",104,0)
 ..S DR=35,DIQ="PSORXED" D EN^DIQ1 K DIC,DIQ,DIRUT,DUOUT,DTOUT
"RTN","PSOOREDT",105,0)
 ..S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR)
"RTN","PSOOREDT",106,0)
 ..S DIR(0)="52,"_(DR) D ^DIR I $D(DIRUT),X'="@" K DIR,DIRUT Q
"RTN","PSOOREDT",107,0)
 ..S PSORXED("FLD",DR)=X K DIR,DIRUT,DIROUT,X,Y,PSORXED(52,DA,DR)
"RTN","PSOOREDT",108,0)
 .I $G(PSORXED("FLD",DR))]"" D FIELD^DID(52,DR,"","LABEL","ZZ") S PSORXED(ZZ("LABEL"))=PSORXED("FLD",DR) K ZZ
"RTN","PSOOREDT",109,0)
 Q:$G(PSOSIGFL)
"RTN","PSOOREDT",110,0)
 S (RX1,I,RFD,RFDT)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),1,I)) Q:'I  S RFD=I,RFDT=$P(^PSRX(PSORXED("IRXN"),1,I,0),"^"),RX1(I)=$G(RX1(I))+1
"RTN","PSOOREDT",111,0)
 Q
"RTN","PSOOREDT",112,0)
CHK S CHK=1 I $G(^PSDRUG($P(PSORXED("RX0"),"^",6),"I"))]"",^("I")<DT S VALMSG="This drug has been inactivated. ",PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",113,0)
 K PSPOP I $G(PSODIV),$P(PSORXED("RX2"),"^",9)'=PSOSITE S PSPRXN=PSORXED("IRXN") D  Q:PSORXED("DFLG")
"RTN","PSOOREDT",114,0)
 .I '$P(PSOSYS,"^",2) S VALMSG="RX# "_$P(^PSRX(PSPRXN,0),"^")_" is not a valid choice. (Different Division)" S PSORXED("DFLG")=1 Q
"RTN","PSOOREDT",115,0)
 .I $P(PSOSYS,"^",3) K DIR,DUOUT,DTOUT D  K DIR,DUOUT,DTOUT Q
"RTN","PSOOREDT",116,0)
 ..W $C(7) S DIR("A",1)="",DIR("A",2)="RX# "_$P(^PSRX(PSPRXN,0),"^")_" is from another division.",DIR("A")="Continue: (Y/N)",DIR(0)="Y",DIR("?",1)="'Y' FOR YES",DIR("?")="'N' FOR NO"
"RTN","PSOOREDT",117,0)
 ..S DIR("B")="N" D ^DIR I 'Y!($D(DIRUT)) S PSORXED("DFLG")=1 W !
"RTN","PSOOREDT",118,0)
 ;
"RTN","PSOOREDT",119,0)
 I $P(^PSRX(PSORXED("IRXN"),"STA"),"^")=16 D  Q
"RTN","PSOOREDT",120,0)
 . S PSORXED("DFLG")=1 S VALMSG="Prescriptions on Provider Hold cannot be edited."
"RTN","PSOOREDT",121,0)
 ;
"RTN","PSOOREDT",122,0)
CHKX K PSPOP,DIR,DTOUT,DUOUT,Y,X Q
"RTN","PSOOREDT",123,0)
 Q
"RTN","PSOOREDT",124,0)
PROV ;select provider
"RTN","PSOOREDT",125,0)
 S PSORXED("PROVIDER")=$P(RX0,"^",4),PSORXED("PROVIDER NAME")=$P(^VA(200,$P(RX0,"^",4),0),"^")
"RTN","PSOOREDT",126,0)
 D PROV^PSODIR(.PSORXED) I PSORXED("PROVIDER")'=$P(RX0,"^",4) D
"RTN","PSOOREDT",127,0)
 .K DIR,DIRUT W ! S DIR(0)="Y",DIR("A",1)="You have changed the name of the provider entered for this Rx."
"RTN","PSOOREDT",128,0)
 .S DIR("A",2)="This edit will cause the provider's name to be update for all fills.",DIR("A")="Do you want to continue" D ^DIR
"RTN","PSOOREDT",129,0)
 .I 'Y!$D(DIRUT) K PSORX("PROVIDER"),PSORX("PROVIDER NAME"),PSORX("COSIGNING PROVIDER") Q
"RTN","PSOOREDT",130,0)
 .S PSORXED("FLD",4)=PSORXED("PROVIDER") K DIR,DIRUT,DUOUT
"RTN","PSOOREDT",131,0)
 .S PSORXED("FLD",109)=$G(PSORXED("COSIGNING PROVIDER"))
"RTN","PSOOREDT",132,0)
 Q
"RTN","PSOOREDT",133,0)
UDPROV ;update provider
"RTN","PSOOREDT",134,0)
 S $P(^PSRX(PSORXED("IRXN"),0),"^",4)=PSORXED("PROVIDER"),$P(^(3),"^",3)=$G(PSORX("COSIGNING PROVIDER"))
"RTN","PSOOREDT",135,0)
 F XTY="1","P" F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),XTY,I)) Q:'I  S $P(^PSRX(PSORXED("IRXN"),XTY,I,0),"^",17)=PSORXED("PROVIDER") S:XTY RFED=I
"RTN","PSOOREDT",136,0)
 K XTY,I
"RTN","PSOOREDT",137,0)
 Q
"RTN","PSOOREDT",138,0)
SIG ;edit medication instructions (SIG)
"RTN","PSOOREDT",139,0)
 S PSOFDR=+$P(^PSRX(PSORXED("IRXN"),"SIG"),"^",2) I PSOFDR D
"RTN","PSOOREDT",140,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORXED("IRXN"),"SIG1",I,0)
"RTN","PSOOREDT",141,0)
 E  S PSORX("SIG")=$P(^PSRX(PSORXED("IRXN"),"SIG"),"^")
"RTN","PSOOREDT",142,0)
 D SIG^PSODIR1(.PSORX) D:$G(PSORX("SIG"))]"" EN1^PSOSIGNO(PSORXED("IRXN"),PSORX("SIG"))
"RTN","PSOOREDT",143,0)
 I '$G(PSOSIGFL),$G(PSORX("SIG"))]"" S ^PSRX(PSORXED("IRXN"),"SIG")=PSORX("SIG") K ^PSRX(PSORXED("IRXN"),"SIG1") Q
"RTN","PSOOREDT",144,0)
 S PSOMRFLG=1
"RTN","PSOOREDT",145,0)
 Q
"RTN","PSOOREDT",146,0)
UL ;
"RTN","PSOOREDT",147,0)
 I '$G(PSOLOKED) Q
"RTN","PSOOREDT",148,0)
 D UL^PSSLOCK(PSODFN)
"RTN","PSOOREDT",149,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOOREDT",150,0)
 Q
"RTN","PSOOREDT",151,0)
SVAL ;Set message for patient lock
"RTN","PSOOREDT",152,0)
 S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.")
"RTN","PSOOREDT",153,0)
 Q
"RTN","PSOOREDT",154,0)
SVALO ;Set message for order lock
"RTN","PSOOREDT",155,0)
 S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.")
"RTN","PSOOREDT",156,0)
 Q
"RTN","PSOOREDT",157,0)
 ;
"RTN","PSOOREDT",158,0)
PAUSE     ;
"RTN","PSOOREDT",159,0)
 N DIR,X,Y
"RTN","PSOOREDT",160,0)
 W ! S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR
"RTN","PSOOREDT",161,0)
 Q
"RTN","PSOOREDT",162,0)
REQFLDS(FIELDS) ; Checks if fields 1,2 or 3 are being edited
"RTN","PSOOREDT",163,0)
 N REQFLDS,I
"RTN","PSOOREDT",164,0)
 S REQFLDS=0
"RTN","PSOOREDT",165,0)
 F I=1:1:$L(FIELDS) I ",1,2,3,"[(","_+$P(FIELDS,",",I)_",") S REQFLDS=1 Q
"RTN","PSOOREDT",166,0)
 Q REQFLDS
"RTN","PSOORNE4")
0^24^B101859322
"RTN","PSOORNE4",1,0)
PSOORNE4 ;BIR/SAB-display renew RXs from backdoor ;07/29/96
"RTN","PSOORNE4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,36,46,75,96,103,99,117,131,225,386,390,391,313,411**;DEC 1997;Build 95
"RTN","PSOORNE4",3,0)
 ;^SC DBIA-10040;^PS(50.7-2223;^PS(50.606-2174;^PS(50.607-2221;^PS(51.2-2226;^PSDRUG-221;^PS(55-2228
"RTN","PSOORNE4",4,0)
 ;External reference to EN1^ORCFLAG supported by DBIA 3620
"RTN","PSOORNE4",5,0)
 ;External reference to ^DD("DD" supported by DBIA 999
"RTN","PSOORNE4",6,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORNE4",7,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORNE4",8,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORNE4",9,0)
 ;
"RTN","PSOORNE4",10,0)
EN(PSONEW) N FLD,LST,VALMCNT
"RTN","PSOORNE4",11,0)
EN1 K PSOQUIT D:$G(PSONEW("ENT"))'>0  I $G(PSORENW("POE"))=1 S PSOREEDT=1 D SV
"RTN","PSOORNE4",12,0)
 .S PSOREEDT=1 D SV
"RTN","PSOORNE4",13,0)
 .K PSONEW("DOSE"),PSONEW("UNITS"),PSONEW("DOSE ORDERED"),PSONEW("ROUTE")
"RTN","PSOORNE4",14,0)
 .K PSONEW("SCHEDULE"),PSONEW("DURATION"),PSONEW("CONJUNCTION"),PSONEW("NOUN"),PSONEW("VERB"),PSOPRC,PSONEW("ODOSE")
"RTN","PSOORNE4",15,0)
RDD D DSPL,^PSOLMRN D:$G(PKI1)=2 DCP^PSOPKIV1 I $G(PSORX("FN")) S VALMBCK="Q" K PSOREEDT Q
"RTN","PSOORNE4",16,0)
 G:'$G(PSOQUIT) RDD
"RTN","PSOORNE4",17,0)
 Q
"RTN","PSOORNE4",18,0)
EDT D KV^PSOVER1 S DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:"_$S($G(PSOREEDT):10,1:8)
"RTN","PSOORNE4",19,0)
 D ^DIR I $D(DTOUT)!($D(DUOUT)) D KV^PSOVER1 S VALMBCK="" Q
"RTN","PSOORNE4",20,0)
EDTSEL S PSOLM=1,(PSONEW("DFLG"),PSONEW("FIELD"),PSONEW3)=0
"RTN","PSOORNE4",21,0)
 I +Y S LST=Y D HLDHDR^PSOLMUTL S PSOEDT=1 D  Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE4",22,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""  D @(+$P(LST,",",FLD)) Q:$G(PSODIR("DFLG"))!($G(PSODIR("QFLG")))
"RTN","PSOORNE4",23,0)
 E  S VALMBCK="" D FULL^VALM1
"RTN","PSOORNE4",24,0)
 Q
"RTN","PSOORNE4",25,0)
ACP ; Renewal Accept
"RTN","PSOORNE4",26,0)
 N DIR,Y,DIRUT,DUOUT,DTOUT,DIR S Y=0
"RTN","PSOORNE4",27,0)
 I $$TITRX^PSOUTL(+$G(PSONEW("OIRXN")))="t" D  K DIR,PSOMSG W ! S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR Q
"RTN","PSOORNE4",28,0)
 . D FULL^VALM1
"RTN","PSOORNE4",29,0)
 . W !!,"Rx "_$P($G(^PSRX(+$G(PSONEW("OIRXN")),0)),"^")_" is marked as 'Titration' and cannot be renewed.",$C(7)
"RTN","PSOORNE4",30,0)
 . S VALMBCK="R"
"RTN","PSOORNE4",31,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNE4",32,0)
 . D FULL^VALM1
"RTN","PSOORNE4",33,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNE4",34,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNE4",35,0)
 . . S DIR("A",2)=""
"RTN","PSOORNE4",36,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNE4",37,0)
 . . S VALMBCK="R"
"RTN","PSOORNE4",38,0)
 . D FULL^VALM1
"RTN","PSOORNE4",39,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNE4",40,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNE4",41,0)
 . S DIR("A",3)=""
"RTN","PSOORNE4",42,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNE4",43,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNE4",44,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNE4",45,0)
 ;
"RTN","PSOORNE4",46,0)
 D INST2^PSORENW S PSOFROM1=1 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER
"RTN","PSOORNE4",47,0)
 K PSOFROM1
"RTN","PSOORNE4",48,0)
PKI I $G(PSONEW("QFLG")) S POERR("DFLG")=1,VALMBCK="R" K PSONEW2 Q
"RTN","PSOORNE4",49,0)
 I PSONEW("ENT")>0,$G(NEWDOSE) K NEWDOSE G EN1 Q
"RTN","PSOORNE4",50,0)
 S PSORX("FN")=1 D EN^PSORN52(.PSONEW) D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNE4",51,0)
 S ZFRENEW=1
"RTN","PSOORNE4",52,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNE4",53,0)
 I $D(^TMP("PSODAOC",$J)),'$G(PSORNALL) D
"RTN","PSOORNE4",54,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNE4",55,0)
 .S RXN=PSORENW("IRXN") D DAOC^PSONEW
"RTN","PSOORNE4",56,0)
 I $G(PSORNALL),$D(^TMP("PSODAOC",$J)) S PSORNEDT=$O(^TMP("PSORXN",$J,0))
"RTN","PSOORNE4",57,0)
 K ZFRENEW
"RTN","PSOORNE4",58,0)
 D RNPSOSD^PSOUTIL,ACP1^PSOORNE6,^PSOBUILD S VALMBCK="Q"
"RTN","PSOORNE4",59,0)
 Q
"RTN","PSOORNE4",60,0)
VER1(PSONEW) ;
"RTN","PSOORNE4",61,0)
VER S (PSONEW("DFLG"),PSONEW("QFLG"))=0 I PSONEW("ENT")=0 D  K PSOORRNW,PSOFROM1 I PSONEW("DFLG")=1 S (PSONEW("QFLG"),POERR("DFLG"))=1 Q
"RTN","PSOORNE4",62,0)
 .S (PSOREEDT,PSOORRNW)=1 W !!,"Dosing Instruction Missing!!",!
"RTN","PSOORNE4",63,0)
 .S PSONEW("IRXN")=PSONEW("OIRXN") K VALMSG D FULL^VALM1 W !,"Drug: "_PSODRUG("NAME") D
"RTN","PSOORNE4",64,0)
 ..I $O(SIG(0)) D  Q
"RTN","PSOORNE4",65,0)
 ...N I F I=1:1 Q:$G(SIG(I))']""  W !,SIG(I)
"RTN","PSOORNE4",66,0)
 ..I $P($G(^PSRX(PSONEW("OIRXN"),"SIG")),"^")]"" S X=$P(^PSRX(PSONEW("OIRXN"),"SIG"),"^") D SIGONE^PSOHELP W !,$E($G(INS1),2,250)
"RTN","PSOORNE4",67,0)
 .K DIRUT W ! D DOSE^PSODIR(.PSONEW) Q:$G(PSONEW("DFLG"))  D EN^PSOFSIG(.PSONEW)
"RTN","PSOORNE4",68,0)
 .I PSONEW("ENT")>0,$O(SIG(0)) S (SIGOK,NEWDOSE)=1
"RTN","PSOORNE4",69,0)
 .I '$G(SPEED),PSONEW("DFLG")=1 S VALMSG="Renewal Request Cancelled!" W:$G(SPEED) !,"Renewal Request Cancelled!" Q:$G(PSONEW("DFLG"))
"RTN","PSOORNE4",70,0)
 .I +$G(PSONEW("ENT"))'>0 K DIRUT Q
"RTN","PSOORNE4",71,0)
 .D INS^PSODIR(.PSONEW),EN^PSOFSIG(.PSONEW),SINS^PSODIR(.PSONEW):$G(^PS(55,PSODFN,"LAN"))
"RTN","PSOORNE4",72,0)
 .S:'$G(SPEED)&(PSONEW("DFLG")=1) VALMSG="Renewal Request Cancelled!" W:$G(SPEED)&(PSONEW("DFLG")=1) !,"Renewal Request Cancelled!"
"RTN","PSOORNE4",73,0)
 .I $G(SPEED),'$G(PSONEW("DFLG")) D KV^PSOVER1 S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR,KV^PSOVER1 K X,Y
"RTN","PSOORNE4",74,0)
 I +$G(PSONEW("ENT"))'>0 G VER
"RTN","PSOORNE4",75,0)
 D STOP^PSORENW1 I +$G(PSEXDT) D  S PSORENW("QFLG")=1
"RTN","PSOORNE4",76,0)
 .S Y=PSORENW("FILL DATE") X ^DD("DD") S VALMSG=Y_" fill date is past expiration date "
"RTN","PSOORNE4",77,0)
 .S Y=$P(PSEXDT,"^",2) X ^DD("DD") S VALMSG=VALMSG_Y_"."
"RTN","PSOORNE4",78,0)
 Q
"RTN","PSOORNE4",79,0)
DSPL G:$G(PSONEW("ENT"))>0 DSP
"RTN","PSOORNE4",80,0)
 S PSONEW("ENT")=0 N I F I=0:0 S I=$O(^PSRX(PSONEW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSONEW("OIRXN"),6,I,0) D
"RTN","PSOORNE4",81,0)
 .S PSONEW("ENT")=PSONEW("ENT")+1,PSONEW("DOSE",PSONEW("ENT"))=$P(DOSE,"^")
"RTN","PSOORNE4",82,0)
 .S PSONEW("UNITS",PSONEW("ENT"))=$P(DOSE,"^",3),PSONEW("DOSE ORDERED",PSONEW("ENT"))=$P(DOSE,"^",2),PSONEW("ROUTE",PSONEW("ENT"))=$P(DOSE,"^",7)
"RTN","PSOORNE4",83,0)
 .S PSONEW("SCHEDULE",PSONEW("ENT"))=$P(DOSE,"^",8),PSONEW("DURATION",PSONEW("ENT"))=$P(DOSE,"^",5),PSONEW("CONJUNCTION",PSONEW("ENT"))=$P(DOSE,"^",6)
"RTN","PSOORNE4",84,0)
 .S PSONEW("NOUN",PSONEW("ENT"))=$P(DOSE,"^",4),PSONEW("VERB",PSONEW("ENT"))=$P(DOSE,"^",9)
"RTN","PSOORNE4",85,0)
 .I $G(^PSRX(PSONEW("OIRXN"),6,I,1))]"" S PSONEW("ODOSE",PSONEW("ENT"))=^PSRX(PSONEW("OIRXN"),6,I,1)
"RTN","PSOORNE4",86,0)
 .K DOSE
"RTN","PSOORNE4",87,0)
DSP D ^PSOORUT2 K ^TMP("PSOPO",$J) S IEN=0
"RTN","PSOORNE4",88,0)
 D:$G(PSONEW("PENDING ORDER")) LMDISP^PSOORFI5(+PSONEW("PENDING ORDER"))
"RTN","PSOORNE4",89,0)
 I $G(PKI1)!($G(PKI)=1) D L1^PSOPKIV1 K:$G(PKI)=1 PKI
"RTN","PSOORNE4",90,0)
 D DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNE4",91,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 Rx#: "_PSONEW("NRX #")
"RTN","PSOORNE4",92,0)
 I +$G(PSODRUG("OI")) D
"RTN","PSOORNE4",93,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Orderable Item: "_$P(^PS(50.7,+$G(PSODRUG("OI")),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNE4",94,0)
 .S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE4",95,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     "_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNE4",96,0)
 S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNE4",97,0)
 S:$G(PSONEW("TN"))]"" IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          Trade Name: "_$G(PSONEW("TN"))
"RTN","PSOORNE4",98,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Patient Status: "_$P(PSONEW("PTST NODE"),"^"),PSONEW("PATIENT STATUS")=$P(PSONEW("PTST NODE"),"^")
"RTN","PSOORNE4",99,0)
 S (PSOID,Y)=PSONEW("ISSUE DATE") X ^DD("DD") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (1)     Issue Date: "_Y
"RTN","PSOORNE4",100,0)
 S Y=PSONEW("FILL DATE") X ^DD("DD") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (2)      Fill Date: "_Y
"RTN","PSOORNE4",101,0)
 I PSONEW("ENT")=0 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(PSOREEDT):"  (9)",1:"     ")_"         Dosage:" G PAT
"RTN","PSOORNE4",102,0)
 N I F I=1:1:PSONEW("ENT") D
"RTN","PSOORNE4",103,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORNE4",104,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(PSOREEDT)&(I'>1):"  (9)",1:"     ")_"         Dosage: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)
"RTN","PSOORNE4",105,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_$S($G(PSONEW("UNITS",I))]"":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOORNE4",106,0)
 .I $P($G(^PS(55,PSODFN,"LAN")),"^"),'$G(PSONEW("DOSE ORDERED",I)) D
"RTN","PSOORNE4",107,0)
 ..S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORNE4",108,0)
 .I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" D
"RTN","PSOORNE4",109,0)
 ..S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORNE4",110,0)
 ..S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dispense Units: "_$S($E($G(PSONEW("DOSE ORDERED",I)),1)=".":"0",1:"")_$G(PSONEW("DOSE ORDERED",I))
"RTN","PSOORNE4",111,0)
 ..S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Noun: "_$G(PSONEW("NOUN",I))
"RTN","PSOORNE4",112,0)
 .I $G(PSONEW("ROUTE",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Route: "_$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOORNE4",113,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOORNE4",114,0)
 .I $G(PSONEW("DURATION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="           *Duration: "_$G(PSONEW("DURATION",I))
"RTN","PSOORNE4",115,0)
 .I $G(PSONEW("CONJUNCTION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="         Conjunction: "_$S($G(PSONEW("CONJUNCTION",I))="A":"AND",$G(PSONEW("CONJUNCTION",I))="T":"THEN",$G(PSONEW("CONJUNCTION",I))="X":"EXCEPT",1:"")
"RTN","PSOORNE4",116,0)
PAT S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=$S($G(PSOREEDT):" (10)",1:"     ")_"Pat Instruction:" D INS2^PSOBKDED
"RTN","PSOORNE4",117,0)
 S RXN=PSONEW("OIRXN") D INST1^PSORENW
"RTN","PSOORNE4",118,0)
 ;I $O(PRC(0)) D PC1^PSOORNE5
"RTN","PSOORNE4",119,0)
 K RXN N I,SG S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 SIG:"
"RTN","PSOORNE4",120,0)
 I $G(SIGOK),$O(SIG(0)) D  K SG,MIG
"RTN","PSOORNE4",121,0)
 .F I=0:0 S I=$O(SIG(I)) Q:'I  F SG=1:1:$L(SIG(I)) D
"RTN","PSOORNE4",122,0)
 ..S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG(I)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" "
"RTN","PSOORNE4",123,0)
 ..S:$P(SIG(I)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG(I)," ",SG)
"RTN","PSOORNE4",124,0)
 E  D
"RTN","PSOORNE4",125,0)
 .S X=$S($G(PSONEW("SIG"))]"":PSONEW("SIG"),1:$P($G(^PSRX(PSONEW("OIRXN"),"SIG")),"^")) D SIGONE^PSOHELP S SIG=$E($G(INS1),2,250)
"RTN","PSOORNE4",126,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNE4",127,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="         Days Supply: "_PSONEW("DAYS SUPPLY")_$S($L(PSONEW("DAYS SUPPLY"))=1:" ",1:"")
"RTN","PSOORNE4",128,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                 QTY"_$S($G(PSODRUG("UNIT"))]"":" ("_PSODRUG("UNIT")_")",1:" (  )")_": "_PSONEW("QTY")
"RTN","PSOORNE4",129,0)
 I $D(^PSDRUG("AQ",PSODRUG("IEN"))),$P($G(^PSDRUG(PSODRUG("IEN"),5)),"^")]"" D
"RTN","PSOORNE4",130,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNE4",131,0)
 .S ^TMP("PSOPO",$J,IEN,0)="            QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^")
"RTN","PSOORNE4",132,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (3)   # of Refills: "_PSONEW("# OF REFILLS")_$S($L(PSONEW("# OF REFILLS"))=1:" ",1:"")
"RTN","PSOORNE4",133,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (4)        Routing: "_$S($G(PSORENW("MAIL/WINDOW"))["W":"WINDOW",1:"MAIL")
"RTN","PSOORNE4",134,0)
 S:$G(PSONEW("METHOD OF PICK-UP"))]""&($P(PSOPAR,"^",12)) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="    Method of Pickup: "_PSONEW("METHOD OF PICK-UP")
"RTN","PSOORNE4",135,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5)         Clinic: "_$S($G(PSONEW("CLINIC")):$P(^SC(PSONEW("CLINIC"),0),"^"),1:"")
"RTN","PSOORNE4",136,0)
 S $P(RN," ",31)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)       Provider: "_PSONEW("PROVIDER NAME")_$E(RN,$L(PSONEW("PROVIDER NAME"))+1,31) K RN
"RTN","PSOORNE4",137,0)
 I $G(PSODRUG("DEA")),+PSODRUG("DEA")>1,+PSODRUG("DEA")<6 D PRV^PSOORFI5($G(PSORENW("PROVIDER")),$G(PSODRUG("IEN")))
"RTN","PSOORNE4",138,0)
 I $G(PSONEW("COSIGNING PROVIDER"))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNE4",139,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (7)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNE4",140,0)
RMK S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (8)        Remarks: "_$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),1:"")
"RTN","PSOORNE4",141,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,DUZ,0),"^")_$E(RN,$L($P(^VA(200,DUZ,0),"^"))+1,35)
"RTN","PSOORNE4",142,0)
 I $G(PSOFDR) S ^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,$P(OR0,"^",4),0),"^")_$E(RN,$L($P(^VA(200,$P(OR0,"^",4),0),"^"))+1,35)
"RTN","PSOORNE4",143,0)
 D NOW^%DTC S PSONEW("LOGIN DATE")=$S($P($G(OR0),"^",6):$P($G(OR0),"^",6),1:%) K %,X S Y=PSONEW("LOGIN DATE") X ^DD("DD")
"RTN","PSOORNE4",144,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$P(Y,"@")_" "_$P(Y,"@",2) K RN
"RTN","PSOORNE4",145,0)
 S (VALMCNT,PSOPF)=IEN
"RTN","PSOORNE4",146,0)
 I $G(PSOFDR) D:$P(OR0,"^",24)
"RTN","PSOORNE4",147,0)
 .K PSOCSP S PSOCSP("NAME")=$G(PSODRUG("NAME")) M PSOCSP("DOSE")=PSONEW("DOSE"),PSOCSP("DOSE ORDERED")=PSONEW("DOSE ORDERED")
"RTN","PSOORNE4",148,0)
 .S PSOCSP("# OF REFILLS")=PSONEW("# OF REFILLS") ;track original data for dig. orders
"RTN","PSOORNE4",149,0)
 .S PSOCSP("ISSUE DATE")=$E($P(OR0,"^",6),1,7),PSOCSP("QTY")=PSONEW("QTY"),PSOCSP("DAYS SUPPLY")=PSONEW("DAYS SUPPLY")
"RTN","PSOORNE4",150,0)
 Q
"RTN","PSOORNE4",151,0)
1 D 1^PSOBKDED Q
"RTN","PSOORNE4",152,0)
2 D 2^PSOBKDED Q
"RTN","PSOORNE4",153,0)
3 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNE4",154,0)
  . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNE4",155,0)
  D 9^PSOBKDED Q
"RTN","PSOORNE4",156,0)
4 D 12^PSOBKDED Q
"RTN","PSOORNE4",157,0)
5 D 5^PSOBKDED Q
"RTN","PSOORNE4",158,0)
6 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNE4",159,0)
  . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNE4",160,0)
  D 4^PSOBKDED Q
"RTN","PSOORNE4",161,0)
7 D 11^PSOBKDED Q
"RTN","PSOORNE4",162,0)
8 D 13^PSOBKDED Q
"RTN","PSOORNE4",163,0)
9 W !!,"Drug: "_PSODRUG("NAME") S PSOORRNW=1 D DOSE1^PSOORED5(.PSONEW)
"RTN","PSOORNE4",164,0)
 I $G(PSONEW("DFLG")) S PSODIR("DFLG")=1,VALMBCK="Q" Q
"RTN","PSOORNE4",165,0)
 D SV Q
"RTN","PSOORNE4",166,0)
10 D INS^PSODIR(.PSONEW),SINS^PSODIR(.PSONEW) D SV Q
"RTN","PSOORNE4",167,0)
SV D SV^PSOORNE5 Q
"RTN","PSOORNE4",168,0)
 ;
"RTN","PSOORNE4",169,0)
PZ ;
"RTN","PSOORNE4",170,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNE4",171,0)
 Q
"RTN","PSOORNEW")
0^23^B94643833
"RTN","PSOORNEW",1,0)
PSOORNEW ;BIR/SAB - display orders from oerr ;6/19/06 3:53pm
"RTN","PSOORNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,55,46,71,90,94,106,131,133,143,237,222,258,206,225,251,386,390,391,372,416,431,313,408,436,411**;DEC 1997;Build 95
"RTN","PSOORNEW",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORNEW",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNEW",5,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORNEW",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORNEW",7,0)
 ;External reference to EN1^ORCFLAG supported by DBIA 3620
"RTN","PSOORNEW",8,0)
 ;External reference to ^DD("DD" supported by DBIA 999
"RTN","PSOORNEW",9,0)
 ;
"RTN","PSOORNEW",10,0)
 ;PSO*237 quit Finish if Today > Issue date + 365
"RTN","PSOORNEW",11,0)
 ;
"RTN","PSOORNEW",12,0)
DSPL I $G(PSODSPL) S VALMBCK="Q" K PSODSPL,PSOANSQD Q
"RTN","PSOORNEW",13,0)
 Q:'$D(PSOLMC)  K ^TMP("PSOPO",$J) S PSOLMC=PSOLMC+1
"RTN","PSOORNEW",14,0)
 I $D(CLOZPAT) S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),1:7) G OI
"RTN","PSOORNEW",15,0)
 S PSONEW("DAYS SUPPLY")=$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3))&('$G(PSONEW("DAYS SUPPLY"))):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORNEW",16,0)
OI I '$G(PSODRUG("OI")) D
"RTN","PSOORNEW",17,0)
 .N OI,OID S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORNEW",18,0)
 .I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR
"RTN","PSOORNEW",19,0)
 I '$D(CLOZPAT) I $G(PSODRUG("DEA"))["A",$G(PSODRUG("DEA"))'["B"!($G(PSODRUG("DEA"))["F") S PSONEW("# OF REFILLS")=0
"RTN","PSOORNEW",20,0)
 I $D(CLOZPAT) S PSONEW("# OF REFILLS")=$S($D(PSONEW("# OF REFILLS")):PSONEW("# OF REFILLS"),$G(CLOZPAT)=2&($P(OR0,"^",11)>2):3,$G(CLOZPAT)&($P(OR0,"^",11)>1):1,1:0)
"RTN","PSOORNEW",21,0)
 S IEN=0 D OBX^PSOORFI1,DIN^PSONFI(PSODRUG("OI"),$S($G(PSODRUG("IEN")):PSODRUG("IEN"),1:""))
"RTN","PSOORNEW",22,0)
 D LMDISP^PSOORFI5(+$G(ORD)) ; Display Flag/Unflag Information
"RTN","PSOORNEW",23,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORNEW",24,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",25,0)
 K LST I $G(PSODRUG("NAME"))]"" D  G PT
"RTN","PSOORNEW",26,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORNEW",27,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORNEW",28,0)
 .I $P($G(^PSDRUG(PSODRUG("IEN"),0)),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG
"RTN","PSOORNEW",29,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORNEW",30,0)
PT D DOSE2^PSOORFI4
"RTN","PSOORNEW",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D:$O(PSONEW("SIG",0)) INST^PSOORFI4
"RTN","PSOORNEW",32,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST^PSOORFI1
"RTN","PSOORNEW",33,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST^PSOORFI1
"RTN","PSOORNEW",34,0)
 K PSOELSE S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:"
"RTN","PSOORNEW",35,0)
 F I=0:0 S I=$O(SIG(I)) Q:'I  S SIG=SIG(I) D
"RTN","PSOORNEW",36,0)
 .F SG=1:1:$L(SIG) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(SIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S:$P(SIG," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(SIG," ",SG)
"RTN","PSOORNEW",37,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORNEW",38,0)
 K PSOELSE I $G(PSONEW("ISSUE DATE"))']"" S PSOELSE=1 S IEN=IEN+1,(PSOID,Y)=$E($P(OR0,"^",6),1,7) X ^DD("DD") S PSONEW("ISSUE DATE")=Y,^TMP("PSOPO",$J,IEN,0)=" (4)     Issue Date: "_Y
"RTN","PSOORNEW",39,0)
 I '$G(PSOELSE) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORNEW",40,0)
 K PSOELSE I $G(PSORX("FILL DATE"))']"" S PSOELSE=1 D
"RTN","PSOORNEW",41,0)
 .S (Y,PSORX("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSONEW("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                  (5) Fill Date: "_Y
"RTN","PSOORNEW",42,0)
 I '$G(PSOELSE) S Y=PSORX("FILL DATE") X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"       (7) Fill Date: "_PSORX("FILL DATE")
"RTN","PSOORNEW",43,0)
 I $P(OR0,"^",18) S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORNEW",44,0)
 I $D(CLOZPAT) D ELIG^PSOORFI2 S:'$D(PSONEW("QTY")) PSONEW("QTY")=0
"RTN","PSOORNEW",45,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_PSONEW("DAYS SUPPLY")
"RTN","PSOORNEW",46,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"               (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+PSODRUG("IEN"),660)),"^",8)_")",1:" (  )")
"RTN","PSOORNEW",47,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_": "_$S($G(PSONEW("QTY"))]"":PSONEW("QTY"),1:$P(OR0,"^",10))
"RTN","PSOORNEW",48,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORNEW",49,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORNEW",50,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORNEW",51,0)
 S IEN=IEN+1
"RTN","PSOORNEW",52,0)
 I $P(OR0,"^",24) S ^TMP("PSOPO",$J,IEN,0)="   Provider ordered: days supply "_+$P(OR0,"^",22)_", quantity "_+$P(OR0,"^",10)_" & refills "_+$P(OR0,"^",11)
"RTN","PSOORNEW",53,0)
 E  S ^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORNEW",54,0)
 D:$D(CLOZPAT) PQTY^PSOORFI4
"RTN","PSOORNEW",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_$S($G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),1:$P(OR0,"^",11))_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORNEW",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORNEW",57,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORNEW",58,0)
 D:$P(OR0,"^",24)!((+$G(PSODRUG("DEA"))>1)&(+$G(PSODRUG("DEA"))<6)) PRV^PSOORFI5($G(PSONEW("PROVIDER")),$G(PSODRUG("IEN")),$P(OR0,"^"))
"RTN","PSOORNEW",59,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) D
"RTN","PSOORNEW",60,0)
 .S IEN=IEN+1,PSONEW("COSIGNING PROVIDER")=$S($G(PSONEW("COSIGNING PROVIDER")):PSONEW("COSIGNING PROVIDER"),1:$P(^("PS"),"^",8))
"RTN","PSOORNEW",61,0)
 .S ^TMP("PSOPO",$J,IEN,0)="       Cos-Provider: "_$P(^VA(200,PSONEW("COSIGNING PROVIDER"),0),"^")
"RTN","PSOORNEW",62,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: "_$S($G(PSONEW("COPIES")):PSONEW("COPIES"),1:1)
"RTN","PSOORNEW",63,0)
 S PSONEW("REMARKS")=$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),$P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORNEW",64,0)
 K PSONEW("ADMINCLINIC") S:$P(OR0,"^",17)="C" PSONEW("ADMINCLINIC")=1
"RTN","PSOORNEW",65,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks:"
"RTN","PSOORNEW",66,0)
 I $G(PSONEW("REMARKS"))]"" D
"RTN","PSOORNEW",67,0)
 .F SG=1:1:$L(PSONEW("REMARKS")) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("REMARKS")," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",68,0)
 ..S:$P(PSONEW("REMARKS")," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("REMARKS")," ",SG)
"RTN","PSOORNEW",69,0)
 I $G(PSOSIGFL)!(PSODRUG("OI")'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSORX("CLERK CODE")=$P(^VA(200,DUZ,0),"^"),VALMSG="This change will create a new prescription!"
"RTN","PSOORNEW",70,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_$P(^VA(200,PSONEW("CLERK CODE"),0),"^")_$E(RN,$L($P(^VA(200,PSONEW("CLERK CODE"),0),"^"))+1,35)
"RTN","PSOORNEW",71,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORNEW",72,0)
 I PSOLMC<2 D ^PSOLMPO1 S VALMBCK="Q",PSOLMC=0
"RTN","PSOORNEW",73,0)
 S:PSOLMC>1 VALMBCK="R"
"RTN","PSOORNEW",74,0)
 Q
"RTN","PSOORNEW",75,0)
ORCHK D PROVCOM^PSOORFI4,ORCHK^PSOORFI4
"RTN","PSOORNEW",76,0)
 Q
"RTN","PSOORNEW",77,0)
EDT D KV S DIR("A",1)="* Indicates which fields will create an new Order",DIR("A")="Select Field to Edit by number",DIR(0)="LO^1:15" D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOORNEW",78,0)
EDTSEL N LST,FLD,OUT D KV S OUT=0
"RTN","PSOORNEW",79,0)
 I +Y S LST=Y D FULL^VALM1 N PSODOSE M PSODOSE=PSONEW D  G DSPL
"RTN","PSOORNEW",80,0)
 .F FLD=1:1:$L(LST,",") Q:$P(LST,",",FLD)']""!(OUT)  D @(+$P(LST,",",FLD)) D:$P(LST,",",FLD)=8 REF D KV
"RTN","PSOORNEW",81,0)
 E  S VALMBCK="" Q
"RTN","PSOORNEW",82,0)
 Q
"RTN","PSOORNEW",83,0)
ACP ;
"RTN","PSOORNEW",84,0)
 N PSOORNEW,DIR,Y S Y=0,PSOORNEW=1
"RTN","PSOORNEW",85,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 D  Q:$D(DIRUT)!'Y  D EN1^ORCFLAG(+$P($G(^PS(52.41,ORD,0)),"^")) H 1
"RTN","PSOORNEW",86,0)
 . D FULL^VALM1
"RTN","PSOORNEW",87,0)
 . I '$D(^XUSEC("PSORPH",DUZ)) D  S Y=0 Q
"RTN","PSOORNEW",88,0)
 . . S DIR("A",1)="Order must be unflagged by a pharmacist before it can be finished."
"RTN","PSOORNEW",89,0)
 . . S DIR("A",2)=""
"RTN","PSOORNEW",90,0)
 . . S DIR(0)="E",DIR("A")="Enter RETURN to continue" W !,$C(7) D ^DIR
"RTN","PSOORNEW",91,0)
 . . S VALMBCK="R"
"RTN","PSOORNEW",92,0)
 . D KV
"RTN","PSOORNEW",93,0)
 . S DIR("A",1)="This Order is flagged. In order to finish it"
"RTN","PSOORNEW",94,0)
 . S DIR("A",2)="you must unflag it first."
"RTN","PSOORNEW",95,0)
 . S DIR("A",3)=""
"RTN","PSOORNEW",96,0)
 . S DIR(0)="Y",DIR("A")="Unflag Order",DIR("B")="NO"
"RTN","PSOORNEW",97,0)
 . W ! D ^DIR I $D(DIRUT)!'Y S VALMBCK="Q"
"RTN","PSOORNEW",98,0)
 I $G(ORD),+$P($G(^PS(52.41,+ORD,0)),"^",23)=1 Q
"RTN","PSOORNEW",99,0)
 ;
"RTN","PSOORNEW",100,0)
 I $D(CLOZPAT),+$G(PSONEW("QTY"))=0 S VALMSG="Unable to calculate the quantity, enter a quantity" G DSPL
"RTN","PSOORNEW",101,0)
 S (PSODIR("DFLG"),PSORX("DFLG"),PSODIR("QFLD"))=0,ACP=1 D ORCHK
"RTN","PSOORNEW",102,0)
 G:$G(PSONEW("QFLG")) DSPL
"RTN","PSOORNEW",103,0)
 I $G(PSODIR("DFLG"))!$G(PSORX("DFLG")) Q
"RTN","PSOORNEW",104,0)
 I $G(PSONEW("FLD"))!($G(PSODRUG("NAME"))']"")!('$O(SIG(0))) G DSPL
"RTN","PSOORNEW",105,0)
 I $G(PSODRUG("NAME"))]"",'$G(ORCHK)!($G(ORDRG)'=PSODRUG("NAME")) D  I $G(PSORX("DFLG")) D CLEAN^PSOVER1 G DSPL
"RTN","PSOORNEW",106,0)
 . D POST^PSODRG S:'$G(PSORX("DFLG")) ORCHK=1,ORDRG=PSODRUG("NAME")
"RTN","PSOORNEW",107,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("N") I $G(PSORX("DFLG")) G DSPL
"RTN","PSOORNEW",108,0)
 I '$D(PSONEW("RX #")) S PSOFROM="NEW",RTN=$S($P($G(PSOPAR),"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN") D @RTN Q:PSONEW("QFLG")  I '$P($G(PSOPAR),"^",7) S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSOORNEW",109,0)
 D RXNCHK^PSOORNE1 I $G(PSONEW("QFLG")) S PSONEW("DFLG")=1 Q
"RTN","PSOORNEW",110,0)
 I DT>$$FMADD^XLFDT($P(OR0,"^",6),365) D EXPR^PSONEW2 G DSPL
"RTN","PSOORNEW",111,0)
 D STOP^PSONEW2,DISPLAY^PSONEW2,^PSONEWF
"RTN","PSOORNEW",112,0)
 I $G(PSOCPZ("DFLG")) W !!,"No action taken!",! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to continue" D ^DIR,KV K PSOCPZ("DFLG"),DRET,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",113,0)
 ;
"RTN","PSOORNEW",114,0)
 K PSOCPZ("DFLG") D KV S DIR(0)="Y",DIR("A")="Are you sure you want to Accept this Order",DIR("B")="NO" D ^DIR I $D(DIRUT) D KV K DRET,PSOANSQ,PSOANSQD S VALMBCK="Q" Q
"RTN","PSOORNEW",115,0)
 D KV I 'Y K PSOANSQ G DSPL
"RTN","PSOORNEW",116,0)
 I $G(PSONEW("MAIL/WINDOW"))["W" D:$P($G(PSOPAR),"^",12)  S BINGCRT="Y",BINGRTE="W",PSORX("MAIL/WINDOW")="WINDOW" K RTN
"RTN","PSOORNEW",117,0)
 .W ! K DIR,DIRUT S DIR(0)="52,35O"
"RTN","PSOORNEW",118,0)
 .S:$G(PSORX("METHOD OF PICK-UP"))]"" DIR("B")=PSORX("METHOD OF PICK-UP") D ^DIR I $D(DIRUT) K DIR,DIRUT Q
"RTN","PSOORNEW",119,0)
 .S (PSONEW("METHOD OF PICK-UP"),PSORX("METHOD OF PICK-UP"))=Y K X,Y
"RTN","PSOORNEW",120,0)
 S PSONEW("POE")=1 D EN^PSON52(.PSONEW) G:$G(PSONEW("DFLG")) ABORT D DCORD^PSONEW2 D:$G(PKI)=89802020 ALERT^PSOPKIV1
"RTN","PSOORNEW",121,0)
 ; - Possible Titration Rx?
"RTN","PSOORNEW",122,0)
 I $G(PSONEW("IRXN")) D MARK^PSOOTMRX(PSONEW("IRXN"),0)
"RTN","PSOORNEW",123,0)
 ;saves drug allergy order chks pso*7*390
"RTN","PSOORNEW",124,0)
 I $D(^TMP("PSODAOC",$J)) D
"RTN","PSOORNEW",125,0)
 .I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSOORNEW",126,0)
 .S RXN=PSONEW("IRXN"),PSODAOC="Finished CPRS Rx "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"Order Acceptance_OP"
"RTN","PSOORNEW",127,0)
 .D DAOC^PSONEW
"RTN","PSOORNEW",128,0)
 D NPSOSD^PSOUTIL(.PSONEW),FULL^VALM1 K PSORX("MAIL/WINDOW")
"RTN","PSOORNEW",129,0)
 D EOJ^PSONEW
"RTN","PSOORNEW",130,0)
ABORT S VALMBCK="Q",DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR,CLEAN^PSOVER1,KV
"RTN","PSOORNEW",131,0)
 Q
"RTN","PSOORNEW",132,0)
KV K DIRUT,DUOUT,DTOUT,DIR,PSOEDDOS
"RTN","PSOORNEW",133,0)
 Q
"RTN","PSOORNEW",134,0)
REF D REF^PSOORFI4
"RTN","PSOORNEW",135,0)
 Q
"RTN","PSOORNEW",136,0)
1 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",137,0)
 . W !!,"Digitally Signed Order - Orderable Item cannot be changed",! D PZ
"RTN","PSOORNEW",138,0)
 N PSOBDR,PSOBDRG S PSOBDRG=1 D 1^PSOORNW2 Q  ;oi
"RTN","PSOORNEW",139,0)
 ;
"RTN","PSOORNEW",140,0)
4 D INS^PSOORNW2 Q
"RTN","PSOORNEW",141,0)
 ;
"RTN","PSOORNEW",142,0)
3 I $G(LST)["3,",$P(OR0,"^",24) D  Q 
"RTN","PSOORNEW",143,0)
 . W !!,"Digitally Signed Order - Dose cannot be changed",! D PZ
"RTN","PSOORNEW",144,0)
 N PSOEDDOS S PSOEDDOS=1 D DOSE^PSOORED4(.PSONEW) Q
"RTN","PSOORNEW",145,0)
 ;
"RTN","PSOORNEW",146,0)
6 D 4^PSOORNW2 Q  ;idt
"RTN","PSOORNEW",147,0)
 ;
"RTN","PSOORNEW",148,0)
7 D 5^PSOORNW2 Q  ;fdt
"RTN","PSOORNEW",149,0)
 ;
"RTN","PSOORNEW",150,0)
5 D 3^PSOORNW2 Q  ;pstat
"RTN","PSOORNEW",151,0)
 ;
"RTN","PSOORNEW",152,0)
13 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",153,0)
 . W !!,"Digitally Signed Order - Provider cannot be changed",! D PZ
"RTN","PSOORNEW",154,0)
 D 12^PSOORNW2 Q  ;doc
"RTN","PSOORNEW",155,0)
 ;
"RTN","PSOORNEW",156,0)
12 D 11^PSOORNW2 Q  ;cli
"RTN","PSOORNEW",157,0)
 ;
"RTN","PSOORNEW",158,0)
2 N PSOCSIG I '$G(PSOBDRG) N PSOBDR,PSOBDRG S PSOBDRG=1,PSOQFLG=0
"RTN","PSOORNEW",159,0)
 N CPRN S CPRN=+$P($G(OR0),"^",24) D 2^PSOORNW1 Q:$G(PSOQFLG)  D EN^PSODIAG  ;drg/ICD
"RTN","PSOORNEW",160,0)
 I $G(PSOCSIG) K PSOCSIG G 3
"RTN","PSOORNEW",161,0)
 Q
"RTN","PSOORNEW",162,0)
 ;
"RTN","PSOORNEW",163,0)
9 D 8^PSOORNW2 Q  ;qty
"RTN","PSOORNEW",164,0)
 ;
"RTN","PSOORNEW",165,0)
8 N CPRN S CPRN=+$P($G(OR0),"^",24) D 7^PSOORNW2 Q  ;ds
"RTN","PSOORNEW",166,0)
 ;
"RTN","PSOORNEW",167,0)
10 I $P($G(OR0),"^",24) D  Q
"RTN","PSOORNEW",168,0)
 . W !!,"Digitally Signed Order - Refills cannot be changed",! D PZ
"RTN","PSOORNEW",169,0)
 D 9^PSOORNW2 Q  ;#rfs
"RTN","PSOORNEW",170,0)
 ;
"RTN","PSOORNEW",171,0)
14 D 13^PSOORNW2 Q  ;cop
"RTN","PSOORNEW",172,0)
 ;
"RTN","PSOORNEW",173,0)
11 D 10^PSOORNW2 Q  ;m/w
"RTN","PSOORNEW",174,0)
 ;
"RTN","PSOORNEW",175,0)
15 D 14^PSOORNW2 Q  ;rem
"RTN","PSOORNEW",176,0)
 ;
"RTN","PSOORNEW",177,0)
DRGMSG ;
"RTN","PSOORNEW",178,0)
 F SG=1:1:$L($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " D
"RTN","PSOORNEW",179,0)
 .S:$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P($P(^PSDRUG(PSODRUG("IEN"),0),"^",10)," ",SG)
"RTN","PSOORNEW",180,0)
 K SG
"RTN","PSOORNEW",181,0)
 Q
"RTN","PSOORNEW",182,0)
 ;
"RTN","PSOORNEW",183,0)
PZ ;
"RTN","PSOORNEW",184,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR W !
"RTN","PSOORNEW",185,0)
 Q
"RTN","PSOORUT2")
0^15^B97954565
"RTN","PSOORUT2",1,0)
PSOORUT2 ;ISC BHAM/SAB - build listman screen ; 3/20/07 9:47am
"RTN","PSOORUT2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,146,132,182,233,243,261,268,264,305,390,411**;DEC 1997;Build 95
"RTN","PSOORUT2",3,0)
 ;External reference to $$PRIAPT^SDPHARM1 supported by DBIA 4196
"RTN","PSOORUT2",4,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORUT2",5,0)
 ;External reference to ^DIC(31 supported by DBIA 658
"RTN","PSOORUT2",6,0)
 ;External reference to ^ORRDI1 supported by DBIA 4659
"RTN","PSOORUT2",7,0)
 ;External reference to ^DPT(DFN,.372 supported by DBIA 1476
"RTN","PSOORUT2",8,0)
 ;External reference to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOORUT2",9,0)
 ;External reference to ^GMRADPT supported by DBIA 10099
"RTN","PSOORUT2",10,0)
 ;External reference to $$TERMLKUP^ORB31 supported by DBIA 5140
"RTN","PSOORUT2",11,0)
 ;External reference to $$BSA^PSSDSAPI supported by DBIA 5425
"RTN","PSOORUT2",12,0)
 ;External reference to ^ORQQVI supported by DBIA 5770
"RTN","PSOORUT2",13,0)
 ;External reference to ^ORQPTQ4 supported by DBIA 5785
"RTN","PSOORUT2",14,0)
 ;External reference to ^ORQQLR1 supported by DBIA 5787
"RTN","PSOORUT2",15,0)
 ;External reference to ^VADPT supported by DBIA 10061
"RTN","PSOORUT2",16,0)
 ;
"RTN","PSOORUT2",17,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) S DFN=PSODFN D ^VADPT,ADD^VADPT
"RTN","PSOORUT2",18,0)
 N I1,PSCNT,PSDIS,PSON,PSOTEL,PSOTMP
"RTN","PSOORUT2",19,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSOORUT2",20,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2),^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSOORUT2",21,0)
 D NVA
"RTN","PSOORUT2",22,0)
 S POERR=1 D RE^PSODEM K POERR
"RTN","PSOORUT2",23,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSOORUT2",24,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSOORUT2",25,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSOORUT2",26,0)
 S $P(^TMP("PSOHDR",$J,9,0)," ",62)="ISSUE  LAST REF DAY"
"RTN","PSOORUT2",27,0)
 S ^TMP("PSOHDR",$J,10,0)=" #  RX #         DRUG                                 QTY ST  DATE  "_$S($G(PSORFG):"RELD",1:"FILL")_" REM SUP"
"RTN","PSOORUT2",28,0)
 S PSOBSA=$$BSA^PSSDSAPI(DFN),PSOBSA=$P(PSOBSA,"^",3),PSOBSA=$S(PSOBSA'>0:"_______",1:$J(PSOBSA,4,2)) S ^TMP("PSOHDR",$J,12,0)=PSOBSA
"RTN","PSOORUT2",29,0)
 S RSLT=$$CRCL(DFN)
"RTN","PSOORUT2",30,0)
 ; RSLT -- DATE^CRCL^Serum Creatinine -- Ex.  11/25/11^68.7^1.1
"RTN","PSOORUT2",31,0)
 I $P(RSLT,"^",2)["Not Found" S ZDSPL=" CrCL: "_$P(RSLT,"^",2)
"RTN","PSOORUT2",32,0)
 E  S ZDSPL=" CrCL: "_$P($G(RSLT),"^",2)_"(est.) "_"(CREAT:"_$P($G(RSLT),"^",3)_"mg/dL "_$P($G(RSLT),"^")_")"
"RTN","PSOORUT2",33,0)
 S ^TMP("PSOHDR",$J,13,0)=ZDSPL
"RTN","PSOORUT2",34,0)
 D ELIG^VADPT S IEN=1,^TMP("PSOPI",$J,IEN,0)="Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:""),IEN=IEN+1
"RTN","PSOORUT2",35,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  S $P(^TMP("PSOPI",$J,IEN,0)," ",14)=$P(VAEL(1,N),"^",2),IEN=IEN+1
"RTN","PSOORUT2",36,0)
 S ^TMP("PSOPI",$J,IEN,0)="",^TMP("PSOPI",$J,IEN,0)="RX PATIENT STATUS: "_$$GET1^DIQ(55,PSODFN,3),IEN=IEN+1
"RTN","PSOORUT2",37,0)
 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Disabilities: "
"RTN","PSOORUT2",38,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOORUT2",39,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOORUT2",40,0)
 .S:$L(^TMP("PSOPI",$J,IEN,0)_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 IEN=IEN+1,$P(^TMP("PSOPI",$J,IEN,0)," ",14)=" "
"RTN","PSOORUT2",41,0)
 .S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOORUT2",42,0)
 S IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1
"RTN","PSOORUT2",43,0)
 I +VAPA(9) S ^TMP("PSOPI",$J,IEN,0)="      (Temp Address from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")",IEN=IEN+1
"RTN","PSOORUT2",44,0)
 S ^TMP("PSOPI",$J,IEN,0)=VAPA(1) S:VAPA(2)]"" IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(2) S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(3)
"RTN","PSOORUT2",45,0)
 S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(VAPA(3)))_"HOME PHONE: "_VAPA(8)
"RTN","PSOORUT2",46,0)
 S PSOTEL=$G(^DPT(DFN,.13))
"RTN","PSOORUT2",47,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(4),^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(VAPA(4)))_"CELL PHONE: "_$P(PSOTEL,"^",4)
"RTN","PSOORUT2",48,0)
 S PSOTMP=$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6)),IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSOTMP
"RTN","PSOORUT2",49,0)
 S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_$J("",50-$L(PSOTMP))_"WORK PHONE: "_$P(PSOTEL,"^",2)
"RTN","PSOORUT2",50,0)
 S MAILD=+$P($G(^PS(55,DFN,0)),"^",3) D  K MAILD
"RTN","PSOORUT2",51,0)
 .S PSOTMP="Prescription Mail Delivery: "_$S(MAILD=1:"Certified Mail",MAILD=2:"DO NOT MAIL",MAILD=3:"Local - Regular Mail",MAILD=4:"Local - Certified Mail",1:"Regular Mail") S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSOTMP
"RTN","PSOORUT2",52,0)
 .I MAILD<2!(MAILD>4) Q  ;ONLY FOR MAIL DELIVERIES 2,3,4
"RTN","PSOORUT2",53,0)
 .N PSOMDEXP,Y
"RTN","PSOORUT2",54,0)
 .S Y=$P($G(^PS(55,DFN,0)),"^",5)
"RTN","PSOORUT2",55,0)
 .I Y,Y'>DT D
"RTN","PSOORUT2",56,0)
 ..D DD^%DT S PSOMDEXP=Y
"RTN","PSOORUT2",57,0)
 ..S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_" Expire Date: "_PSOMDEXP
"RTN","PSOORUT2",58,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=$S($P($G(^PS(55,DFN,0)),"^",2):"Cannot use safety caps.",1:"") S $P(^TMP("PSOPI",$J,IEN,0)," ",40)=$S($P($G(^PS(55,DFN,0)),"^",4):"Dialysis Patient.",1:"")
"RTN","PSOORUT2",59,0)
 I $G(^PS(55,DFN,1))]"" S PSON=^(1),IEN=IEN+1 D
"RTN","PSOORUT2",60,0)
 .S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="     Outpatient Narrative: "
"RTN","PSOORUT2",61,0)
 .F I=1:1 Q:$P(PSON," ",I,99)=""  S:$L(^TMP("PSOPI",$J,IEN,0)_$P(PSON," ",I)_" ")>80 IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_$P(PSON," ",I)_" "
"RTN","PSOORUT2",62,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",63,0)
 I $D(^PS(52.91,DFN,0)) I '$P(^(0),"^",3)!($P(^(0),"^",3)>DT) D
"RTN","PSOORUT2",64,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Primary Care Appointment: "_$$PRIAPT^SDPHARM1(DFN)
"RTN","PSOORUT2",65,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",66,0)
 I 'GMRAL D
"RTN","PSOORUT2",67,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:"")
"RTN","PSOORUT2",68,0)
 .I GMRAL'=0 S PSONOAL="" D ALLERGY I PSONOAL'="" S ^TMP("PSOPI",$J,IEN,0)="Allergies: "_PSONOAL K PSONOAL
"RTN","PSOORUT2",69,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",70,0)
 .D REMOTE
"RTN","PSOORUT2",71,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOORUT2",72,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOORUT2",73,0)
 K ^UTILITY("VASD",$J),VASD S DFN=PSODFN,VASD("F")=DT,VASD("T")=9999999,VASD("W")="123456789" D SDA^VADPT K VASD I $D(^UTILITY("VASD",$J)) D
"RTN","PSOORUT2",74,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Pending Clinic Appointments:"
"RTN","PSOORUT2",75,0)
 .F PSOAPP=0:0 S PSOAPP=$O(^UTILITY("VASD",$J,PSOAPP)) Q:'PSOAPP  S PSOAPPE=$G(^UTILITY("VASD",$J,PSOAPP,"E")),PSOAPPI=$G(^("I")) D
"RTN","PSOORUT2",76,0)
 ..K X S X2=DT,X1=$P($P($G(PSOAPPI),"^"),".") I $G(X1) D ^%DTC
"RTN","PSOORUT2",77,0)
 ..S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="    "_$P(PSOAPPE,"^")_"  "_$P(PSOAPPE,"^",2)_$S($P(PSOAPPI,"^",3)["C":"   *** Canceled ***",1:" ("_$G(X)_" days)")
"RTN","PSOORUT2",78,0)
 K ^UTILITY("VASD",$J),X,PSOAPPI,PSOAPPE,PSOAPP,N,PSOBSA,ZDSPL
"RTN","PSOORUT2",79,0)
 S PSOPI=IEN K IEN
"RTN","PSOORUT2",80,0)
 Q
"RTN","PSOORUT2",81,0)
NVA ;
"RTN","PSOORUT2",82,0)
 Q:'$O(^PS(55,PSODFN,"NVA",0))
"RTN","PSOORUT2",83,0)
 K LSTDT F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",I)) Q:'I  D
"RTN","PSOORUT2",84,0)
 .Q:$P(^PS(55,PSODFN,"NVA",I,0),"^",7)  Q:'$P(^PS(55,PSODFN,"NVA",I,0),"^")
"RTN","PSOORUT2",85,0)
 .I $P(^PS(55,PSODFN,"NVA",I,0),"^",10)>+$G(LSTDT) S LSTDT=$P(^(0),"^",10)
"RTN","PSOORUT2",86,0)
 I $G(LSTDT)]"" D
"RTN","PSOORUT2",87,0)
 .S LSTDT="Non-VA Meds on File - Last entry on "_$E(LSTDT,4,5)_"/"_$E(LSTDT,6,7)_"/"_$E(LSTDT,2,3)
"RTN","PSOORUT2",88,0)
 .I $G(^TMP("PSOHDR",$J,5,0))="MALE" S $P(^TMP("PSOHDR",$J,5,0)," ",22)=LSTDT K LSTDT Q
"RTN","PSOORUT2",89,0)
 .S $P(^TMP("PSOHDR",$J,5,0)," ",20)=LSTDT K LSTDT
"RTN","PSOORUT2",90,0)
 K I
"RTN","PSOORUT2",91,0)
 Q
"RTN","PSOORUT2",92,0)
REMOTE ;
"RTN","PSOORUT2",93,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOORUT2",94,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOORUT2",95,0)
 N PSORALG,REAC,S1,A,FILE,LEN,I
"RTN","PSOORUT2",96,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",97,0)
 S PSORALG=1,PSORALG(1)="No remote data available"
"RTN","PSOORUT2",98,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSOORUT2",99,0)
 I $T(GET^ORRDI1)]"" S PSOSIEN=$G(IEN) D GET^ORRDI1(DFN,"ART") S IEN=PSOSIEN K PSOSIEN D
"RTN","PSOORUT2",100,0)
 .I $P($G(^XTMP("ORRDI","ART",DFN,0)),"^",3)=0 S PSORALG(1)="No remote allergies"
"RTN","PSOORUT2",101,0)
 .S S1=0,LEN=65,PSORALG=1,PSORALG(1)="" F  S S1=$O(^XTMP("ORRDI","ART",DFN,S1)) Q:'S1  D
"RTN","PSOORUT2",102,0)
 ..S A=$G(^XTMP("ORRDI","ART",DFN,S1,"GMRALLERGY",0))
"RTN","PSOORUT2",103,0)
 ..S REAC=$P(A,"^",2) Q:REAC=""
"RTN","PSOORUT2",104,0)
 ..S FILE=$P($P(A,"^",3),"99VA",2)
"RTN","PSOORUT2",105,0)
 ..I FILE'=50.6,FILE'=120.82,FILE'=50.605,FILE'=50.416 Q
"RTN","PSOORUT2",106,0)
 ..S ^TMP($J,"PSOART",REAC)=""
"RTN","PSOORUT2",107,0)
 .S REAC="" F  S REAC=$O(^TMP($J,"PSOART",REAC)) Q:REAC=""  D
"RTN","PSOORUT2",108,0)
 ..I $L(PSORALG(PSORALG))+$L(REAC)<LEN S PSORALG(PSORALG)=PSORALG(PSORALG)_REAC_", " Q
"RTN","PSOORUT2",109,0)
 ..S PSORALG=PSORALG+1,PSORALG(PSORALG)="              "_REAC_", ",LEN=76
"RTN","PSOORUT2",110,0)
 .I PSORALG(PSORALG)]"",$E(PSORALG(PSORALG),$L(PSORALG(PSORALG)))="," S PSORALG(PSORALG)=$E(PSORALG(PSORALG),1,$L(PSORALG(PSORALG))-1)
"RTN","PSOORUT2",111,0)
REMOTE2 ;
"RTN","PSOORUT2",112,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="      Remote: "_$G(PSORALG(1)) D
"RTN","PSOORUT2",113,0)
 .F I=2:1:PSORALG S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSORALG(I)
"RTN","PSOORUT2",114,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",115,0)
 Q
"RTN","PSOORUT2",116,0)
  ;
"RTN","PSOORUT2",117,0)
ALLERGY ;ALLERGIES & REACTIONS
"RTN","PSOORUT2",118,0)
 N GMRA,GMRAL,PSORY,ALCNT,EEE,PSOLG,PSOLGA,TEXT,CCC,CCC2,LENGTH
"RTN","PSOORUT2",119,0)
 K ^TMP($J,"PSOALWA")
"RTN","PSOORUT2",120,0)
 I '$D(DFN) S DFN=PSODFN
"RTN","PSOORUT2",121,0)
 S GMRA="0^0^111" D ^GMRADPT
"RTN","PSOORUT2",122,0)
 I $G(GMRAL) S PSORY=0 F  S PSORY=$O(GMRAL(PSORY)) Q:'PSORY  S ^TMP($J,"PSOALWA",$S($P(GMRAL(PSORY),"^",4):1,1:2),$S('$P(GMRAL(PSORY),"^",5):1,1:2),$P(GMRAL(PSORY),"^",7),$P(GMRAL(PSORY),"^",2))=""
"RTN","PSOORUT2",123,0)
 S ^TMP($J,"PSOAPT",1)=$G(PNM)_"  "_$G(SSNP),^(2)="Verified Allergies"
"RTN","PSOORUT2",124,0)
 S ALCNT=0,EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)=PSOLGA
"RTN","PSOORUT2",125,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)="NKA"
"RTN","PSOORUT2",126,0)
 S ALCNT=0,^TMP($J,"PSOAPT",3)="Non-Verified Allergies"
"RTN","PSOORUT2",127,0)
 S EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=EEE+1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)=PSOLGA
"RTN","PSOORUT2",128,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)="NKA"
"RTN","PSOORUT2",129,0)
 S ALCNT=0,^TMP($J,"PSOAPT",4)="Verified Adverse Reactions"
"RTN","PSOORUT2",130,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",4,ALCNT)=PSOLGA
"RTN","PSOORUT2",131,0)
 S ALCNT=0,^TMP($J,"PSOAPT",5)="Non-Verified Adverse Reactions"
"RTN","PSOORUT2",132,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",5,ALCNT)=PSOLGA
"RTN","PSOORUT2",133,0)
 S TEXT=^TMP($J,"PSOAPT",1) D CHKNO(TEXT)
"RTN","PSOORUT2",134,0)
 F CCC=3,4,5 I '$O(^TMP($J,"PSOAPT",CCC,0)) K ^TMP($J,"PSOAPT",CCC)
"RTN","PSOORUT2",135,0)
 D PSONOAL
"RTN","PSOORUT2",136,0)
 I CCC="NKA" S ^TMP($J,"PSOAPT",2,1)="No Known Allergies" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",137,0)
 N OUT S CCC=1,OUT=0
"RTN","PSOORUT2",138,0)
 F  S CCC=$O(^TMP($J,"PSOAPT",CCC)) Q:CCC=""  D  Q:OUT
"RTN","PSOORUT2",139,0)
 .S TEXT=$G(^TMP($J,"PSOAPT",CCC))
"RTN","PSOORUT2",140,0)
 .I TEXT="No Allergy Assessment" S PSONOAL=TEXT Q
"RTN","PSOORUT2",141,0)
 .S (TEXT,CCC2)="",LENGTH=0
"RTN","PSOORUT2",142,0)
 .F  S CCC2=$O(^TMP($J,"PSOAPT",CCC,CCC2)) Q:CCC2=""  S TEXT=^(CCC2) D CHKNO(TEXT)
"RTN","PSOORUT2",143,0)
 K ^TMP($J,"PSOALWA"),^TMP($J,"PSOAPT")
"RTN","PSOORUT2",144,0)
 Q
"RTN","PSOORUT2",145,0)
CHKNO(T) ;
"RTN","PSOORUT2",146,0)
 I T="No Allergy Assessment" S PSONOAL=T
"RTN","PSOORUT2",147,0)
 Q
"RTN","PSOORUT2",148,0)
PSONOAL ;
"RTN","PSOORUT2",149,0)
 N FLG3,FLG4,FLG5
"RTN","PSOORUT2",150,0)
 S CCC=$G(^TMP($J,"PSOAPT",2,1))
"RTN","PSOORUT2",151,0)
 S FLG3=$G(^TMP($J,"PSOAPT",3,1))
"RTN","PSOORUT2",152,0)
 S FLG4=$G(^TMP($J,"PSOAPT",4,1))
"RTN","PSOORUT2",153,0)
 S FLG5=$G(^TMP($J,"PSOAPT",5,1))
"RTN","PSOORUT2",154,0)
 I CCC="",FLG3="",FLG4="",FLG5="" S ^TMP($J,"PSOAPT",2,1)="No Allergy Assessment" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",155,0)
 Q
"RTN","PSOORUT2",156,0)
CRCL(DFN) ;
"RTN","PSOORUT2",157,0)
 N HTGT60,ABW,IBW,BWRATIO,BWDIFF,LOWBW,ADJBW,X1,X2,RSLT,PSCR,PSRW,ABW,ZHT,PSRH,PSCXTL,PSCXTLS,SCR,SCRD,OCXT,OCXTS,SCRV,ZAGE,SEX
"RTN","PSOORUT2",158,0)
 S RSLT="0^<Not Found>"
"RTN","PSOORUT2",159,0)
 S PSCR="^^^^^^0"
"RTN","PSOORUT2",160,0)
 D VITAL^ORQQVI("WEIGHT","WT",DFN,.PSRW,0,"",$$NOW^XLFDT)
"RTN","PSOORUT2",161,0)
 Q:'$D(PSRW) RSLT
"RTN","PSOORUT2",162,0)
 S ABW=$P(PSRW(1),U,3) Q:+$G(ABW)<1 RSLT
"RTN","PSOORUT2",163,0)
 S ABW=ABW/2.2  ;ABW (actual body weight) in kg
"RTN","PSOORUT2",164,0)
 D VITAL^ORQQVI("HEIGHT","HT",DFN,.PSRH,0,"",$$NOW^XLFDT)
"RTN","PSOORUT2",165,0)
 Q:'$D(PSRH) RSLT
"RTN","PSOORUT2",166,0)
 S ZHT=$P(PSRH(1),U,3) Q:+$G(ZHT)<1 RSLT
"RTN","PSOORUT2",167,0)
 S ZAGE=$$AGE^ORQPTQ4(DFN) Q:'ZAGE RSLT
"RTN","PSOORUT2",168,0)
 S SEX=$P($$SEX^ORQPTQ4(DFN),U,1) Q:'$L(SEX) RSLT
"RTN","PSOORUT2",169,0)
 S PSCXTL="" Q:'$$TERMLKUP^ORB31(.PSCXTL,"SERUM CREATININE") RSLT
"RTN","PSOORUT2",170,0)
 S PSCXTLS="" Q:'$$TERMLKUP^ORB31(.PSCXTLS,"SERUM SPECIMEN") RSLT
"RTN","PSOORUT2",171,0)
 S SCR="",OCXT=0 F  S OCXT=$O(PSCXTL(OCXT)) Q:'OCXT  D
"RTN","PSOORUT2",172,0)
 .S OCXTS=0 F  S OCXTS=$O(PSCXTLS(OCXTS)) Q:'OCXTS  D
"RTN","PSOORUT2",173,0)
 ..S SCR=$$LOCL^ORQQLR1(DFN,$P(PSCXTL(OCXT),U),$P(PSCXTLS(OCXTS),U))
"RTN","PSOORUT2",174,0)
 ..I $P(SCR,U,7)>$P(PSCR,U,7) S PSCR=SCR
"RTN","PSOORUT2",175,0)
 S SCR=PSCR,SCRV=$P(SCR,U,3) Q:+$G(SCRV)<.01 RSLT
"RTN","PSOORUT2",176,0)
 S SCRD=$P(SCR,U,7) Q:'$L(SCRD) RSLT
"RTN","PSOORUT2",177,0)
 ;
"RTN","PSOORUT2",178,0)
 S HTGT60=$S(ZHT>60:(ZHT-60)*2.3,1:0)  ;if ht > 60 inches
"RTN","PSOORUT2",179,0)
 I HTGT60>0 D
"RTN","PSOORUT2",180,0)
 .S IBW=$S(SEX="M":50+HTGT60,1:45.5+HTGT60)  ;Ideal Body Weight
"RTN","PSOORUT2",181,0)
 .S BWRATIO=(ABW/IBW)  ;body weight ratio
"RTN","PSOORUT2",182,0)
 .S BWDIFF=$S(ABW>IBW:ABW-IBW,1:0)
"RTN","PSOORUT2",183,0)
 .S LOWBW=$S(IBW<ABW:IBW,1:ABW)
"RTN","PSOORUT2",184,0)
 .I BWRATIO>1.3,(BWDIFF>0) S ADJBW=((0.3*BWDIFF)+IBW)
"RTN","PSOORUT2",185,0)
 .E  S ADJBW=LOWBW
"RTN","PSOORUT2",186,0)
 I +$G(ADJBW)<1 D
"RTN","PSOORUT2",187,0)
 .S ADJBW=ABW
"RTN","PSOORUT2",188,0)
 S CRCL=(((140-ZAGE)*ADJBW)/(SCRV*72))
"RTN","PSOORUT2",189,0)
 ;
"RTN","PSOORUT2",190,0)
 S:SEX="M" RSLT=SCRD_U_$J(CRCL,1,1)
"RTN","PSOORUT2",191,0)
 S:SEX="F" RSLT=SCRD_U_$J((CRCL*.85),1,1)
"RTN","PSOORUT2",192,0)
 S X1=$P(RSLT,"^"),X2=$$FMTE^XLFDT(X1,"2M"),$P(RSLT,"^")=$P(X2,"@") K X1,X2
"RTN","PSOORUT2",193,0)
 S $P(RSLT,"^",3)=$P($G(SCR),"^",3)
"RTN","PSOORUT2",194,0)
 K HTGT60,ABW,IBW,BWRATIO,BWDIFF,LOWBW,ADJBW,X1,X2,PSCR,PSRW,ABW,ZHT,PSRH,ZAGE,PSCXTL,PSCXTLS,SCR,OCXT,OCXTS,SCRV,CRCL
"RTN","PSOORUT2",195,0)
 Q RSLT
"RTN","PSOQRART")
0^29^B6101502
"RTN","PSOQRART",1,0)
PSOQRART ;HINES/RMS- TIU OBJECT FOR REMOTE ALLERGIES VIA RDI ; 30 Nov 2007  7:56 AM
"RTN","PSOQRART",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**294,411**;DEC 1997;Build 95
"RTN","PSOQRART",3,0)
 ;
"RTN","PSOQRART",4,0)
 ;Reference to CKP^GMTSUP supported by DBIA 4231
"RTN","PSOQRART",5,0)
 ;References to ^ORRDI1 supported by DBIA 4659
"RTN","PSOQRART",6,0)
 ;References to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOQRART",7,0)
ENHS ;ENTRY POINT FOR HEALTH SUMMARY OF REMOTE ALLERGY/ADR DATA
"RTN","PSOQRART",8,0)
 N PSOQHDR,PSOQRET,PSOQART,PSOQRART,PSOQFAC,PSOQREAC,PSOQRDI,PSOQDOWN
"RTN","PSOQRART",9,0)
 Q:'$G(DFN)
"RTN","PSOQRART",10,0)
 S PSOQHDR=$$HAVEHDR^ORRDI1 I '+$G(PSOQHDR) D  Q
"RTN","PSOQRART",11,0)
 . D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",12,0)
 . W !,"Remote Data from HDR not available"
"RTN","PSOQRART",13,0)
 . D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",14,0)
 D  Q:$G(PSOQDOWN)
"RTN","PSOQRART",15,0)
 . I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) H $$GET^XPAR("ALL","ORRDI PING FREQ")/2
"RTN","PSOQRART",16,0)
 . I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) S PSOQDOWN=1 D
"RTN","PSOQRART",17,0)
 .. D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",18,0)
 .. W !,"WARNING: Connection to Remote Data Currently Down",!
"RTN","PSOQRART",19,0)
 .. D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",20,0)
 D  ;RDI/HDR CALL ENCAPSULATION
"RTN","PSOQRART",21,0)
 . D SAVDEV^%ZISUTL("PSOQHFS")
"RTN","PSOQRART",22,0)
 . S PSOQRET=$$GET^ORRDI1(DFN,"ART")
"RTN","PSOQRART",23,0)
 . D USE^%ZISUTL("PSOQHFS")
"RTN","PSOQRART",24,0)
 . D RMDEV^%ZISUTL("PSOQHFS")
"RTN","PSOQRART",25,0)
 I PSOQRET=-1 D  Q
"RTN","PSOQRART",26,0)
 . D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",27,0)
 . W !,"Connection to Remote Data Not Available"
"RTN","PSOQRART",28,0)
 . D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",29,0)
 I '$D(^XTMP("ORRDI","ART",DFN))!('+PSOQRET) D  Q
"RTN","PSOQRART",30,0)
 . D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",31,0)
 . W !,"No Remote Allergy/ADR Data available for this patient"
"RTN","PSOQRART",32,0)
 . D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",33,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",34,0)
 W !,"FACILITY",?40,"ALLERGY/ADR",!,"--------",?40,"-----------"
"RTN","PSOQRART",35,0)
 D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",36,0)
 F PSOQART=1:1:PSOQRET D
"RTN","PSOQRART",37,0)
 . S PSOQFAC=$G(^XTMP("ORRDI","ART",DFN,PSOQART,"FACILITY",0))
"RTN","PSOQRART",38,0)
 . S PSOQREAC=$G(^XTMP("ORRDI","ART",DFN,PSOQART,"GMRALLERGY",0))
"RTN","PSOQRART",39,0)
 . Q:$$YESCHK
"RTN","PSOQRART",40,0)
 . Q:PSOQFAC']""!(PSOQREAC']"")
"RTN","PSOQRART",41,0)
 . S PSOQREAC=$P(PSOQREAC,U,2)
"RTN","PSOQRART",42,0)
 . S PSOQRART(PSOQFAC,PSOQREAC)=""
"RTN","PSOQRART",43,0)
 S PSOQFAC="" F  S PSOQFAC=$O(PSOQRART(PSOQFAC)) Q:PSOQFAC']""  D  ;
"RTN","PSOQRART",44,0)
 . S PSOQREAC="" F  S PSOQREAC=$O(PSOQRART(PSOQFAC,PSOQREAC)) Q:PSOQREAC']""  D  ;
"RTN","PSOQRART",45,0)
 .. D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",46,0)
 .. W !,PSOQFAC,?40,PSOQREAC
"RTN","PSOQRART",47,0)
 .. D CKP^GMTSUP Q:$D(GMTSQIT)
"RTN","PSOQRART",48,0)
 Q
"RTN","PSOQRART",49,0)
YESCHK() ;DO NOT INCLUDE IF A 'YES' ASSESSMENT
"RTN","PSOQRART",50,0)
 I $P(PSOQREAC,U,2)'="YES" Q 0
"RTN","PSOQRART",51,0)
 I $P(PSOQREAC,U,2)="YES" I $P(PSOQREAC,U,3)["99VA8" Q 1
"RTN","PSOQRART",52,0)
 Q 1 ;STOP IF THERE IS ANY PROBLEMATIC DATA 
"RTN","PSOQRART",53,0)
 ;----------------------------------------------------------
"RTN","PSORENW")
0^19^B47375085
"RTN","PSORENW",1,0)
PSORENW ; BIR/SAB - renew main driver ;4/25/07 8:42am
"RTN","PSORENW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,30,46,71,96,100,130,148,206,388,390,417,313,411**;DEC 1997;Build 95
"RTN","PSORENW",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSORENW",4,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",5,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",6,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",7,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",8,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW",9,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW",10,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW",11,0)
 ;External reference to MAIN^TIUEDIT supported by DBIA 2410
"RTN","PSORENW",12,0)
 ;
"RTN","PSORENW",13,0)
ASK ;
"RTN","PSORENW",14,0)
 K PSORENW("FILL DATE"),ZZCOPY D FILLDT^PSODIR2(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",15,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",16,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW",17,0)
 D MW^PSOCMOPA(.PSORENW)
"RTN","PSORENW",18,0)
 I PSORENW("DFLG") S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",19,0)
 S PSORNW("MAIL/WINDOW")=PSORENW("MAIL/WINDOW") S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="M":"MAIL",1:"WINDOW")
"RTN","PSORENW",20,0)
 D NOORE^PSONEW(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",21,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0
"RTN","PSORENW",22,0)
ASKX Q
"RTN","PSORENW",23,0)
 ;
"RTN","PSORENW",24,0)
EOJ ;
"RTN","PSORENW",25,0)
 K VERB,RTE,DRET,PSOMSG,PSORNW,PSOLIST,PSORENW,PSORX("BAR CODE"),PSORX("FILL DATE"),PSODIR,PSOID,PSONOOR,PSOCOU,PSOCOUU,PSOID,PSOFDMX,PSODRUG,COPY,PSOBCKDR
"RTN","PSORENW",26,0)
 N ZRXN
"RTN","PSORENW",27,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN S ZRXN=RXN D
"RTN","PSORENW",28,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW",29,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW",30,0)
 .;saves drug allergy order chks pso*7*411
"RTN","PSORENW",31,0)
 .I $D(^TMP("PSODAOC",$J)) D  Q:$G(PSORX("DFLG"))
"RTN","PSORENW",32,0)
 ..I $G(PSORX("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW",33,0)
 ..S RXN=ZRXN
"RTN","PSORENW",34,0)
 .S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW",35,0)
 I $G(PSORNEDT),'$O(^TMP("PSORXN",$J,0)),$D(^TMP("PSODAOC",$J)) S ZRXN=PSORNEDT,PSOARENW=1 D DAOC^PSONEW K PSOARENW,PSORNEDT
"RTN","PSORENW",36,0)
 K ZZCOPY,ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW",37,0)
 I $G(PSONOTE) D MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSORENW",38,0)
 K PSONOTE
"RTN","PSORENW",39,0)
 Q
"RTN","PSORENW",40,0)
OERR ;entry for renew backdoor
"RTN","PSORENW",41,0)
 N PSORNEDT
"RTN","PSORENW",42,0)
 I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  Q
"RTN","PSORENW",43,0)
 . S VALMSG="Cannot Renew a 'Titration Rx'.",VALMBCK="R" W $C(7)
"RTN","PSORENW",44,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSORENW",45,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW",46,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW",47,0)
 K PSOID,PSOFDMX,PSORX("FILL DATE"),PSORENW("FILL DATE"),PSORX("QS"),PSORENW("QS"),PSOBARCD,COPY
"RTN","PSORENW",48,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULPAT Q
"RTN","PSORENW",49,0)
 S PSOBCKDR=1,PSOFROM="NEW",PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0
"RTN","PSORENW",50,0)
 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSORENW",51,0)
 D FULL^VALM1,ASK D:PSORENW("QFLG") KLIB^PSORENW1 D:PSORENW("QFLG") ULPAT D:PSORENW("QFLG") PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) G:PSORENW("QFLG") EOJ D ^PSORENW0
"RTN","PSORENW",52,0)
 D ULPAT,EOJ,KLIB^PSORENW1 K PSOOPT,PSONEW,PSORX("DFLG"),X,Y
"RTN","PSORENW",53,0)
 Q
"RTN","PSORENW",54,0)
ULPAT K PSOMSG D UL^PSSLOCK(PSODFN) S X=PSODFN_";DPT(" D ULK^ORX2 K X
"RTN","PSORENW",55,0)
 Q
"RTN","PSORENW",56,0)
RENEW(PLACER,PSOCPDRG) ;passes flag to CPRS for front door renews
"RTN","PSORENW",57,0)
 ;-1=couldn't find order, 0=unable to renew, 1=renewable
"RTN","PSORENW",58,0)
 ;Placer=Pharmacy number
"RTN","PSORENW",59,0)
 N PSOSURX,PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSONEWOI,PSOOLDOI,PSOIFLAG,PSOINA,RX0,X1,X2
"RTN","PSORENW",60,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",61,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",62,0)
 S RX0=^PSRX(RXN,0),PSODRG=+$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0)
"RTN","PSORENW",63,0)
 S PSOIFLAG=0,PSOOLDOI=+$P($G(^PSRX(RXN,"OR1")),"^"),PSONEWOI=+$P($G(^PSDRUG(+$G(PSODRG),2)),"^") I PSONEWOI,PSONEWOI'=PSOOLDOI S PSOIFLAG=1
"RTN","PSORENW",64,0)
 S PSOINA=$P($G(^PS(50.7,PSONEWOI,0)),"^",4)
"RTN","PSORENW",65,0)
 I PSOINA,DT>PSOINA Q "0^This Orderable Item has been Inactivated."
"RTN","PSORENW",66,0)
 I ST=5 S PSOSURX=$O(^PS(52.5,"B",RXN,0)) I PSOSURX,$P($G(^PS(52.5,PSOSURX,0)),"^",7)="L" Q "0^Rx loading into a CMOP Transmission."
"RTN","PSORENW",67,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,2)),"^",6)<X Q "0^Prescription Expired more than 120 Days."
"RTN","PSORENW",68,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,3)),"^",5),$P($G(^(3)),"^",5)<X,$P(^("STA"),"^")=12 Q "0^Prescription Discontinued more than 120 Days."
"RTN","PSORENW",69,0)
 I $G(PSOCPDRG),$G(PSOCPDRG)'=$G(PSODRG) Q "0^Drug Mismatch, Non-Renewable."
"RTN","PSORENW",70,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=RXN D CDOSE^PSORENW0 I PSOOLPF Q "0^Non-Renewable, invalid Dosage of "_$G(PSOOLPD)
"RTN","PSORENW",71,0)
 I PSONOSIG Q "0^Non-Renewable, missing Sig."
"RTN","PSORENW",72,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Drug is No longer used by Outpatient Pharmacy."
"RTN","PSORENW",73,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^This Drug has been Inactivated."
"RTN","PSORENW",74,0)
 I ($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2)!($P(PSODRUG0,"^",3)["W") Q "0^Non-Renewable "_$S($P(PSODRUG0,"^",3)["A":"Drug Narcotic.",1:"Drug.")
"RTN","PSORENW",75,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) Q "0^Non-Renewable Prescription."
"RTN","PSORENW",76,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 Q "0^Max number of renewals (26) has been reached."
"RTN","PSORENW",77,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12,ST'=14 Q "0^Prescription is in a Non-Renewable Status."
"RTN","PSORENW",78,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",4) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",79,0)
 I $O(^PS(52.41,"AQ",RXN,0)) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",80,0)
 N TITMSG
"RTN","PSORENW",81,0)
 I $$TITRX^PSOUTL(RXN)="t" D  Q TITMSG
"RTN","PSORENW",82,0)
 . S TITMSG="0^Prescription was marked as 'Titration to Maintenance Dose' by Pharmacy and cannot be renewed."
"RTN","PSORENW",83,0)
 . S TITMSG=TITMSG_" To repeat the titration, enter a new prescription or copy the prior titration order."
"RTN","PSORENW",84,0)
 . S TITMSG=TITMSG_" To continue the maintenance dose, refill this prescription if refills are available"
"RTN","PSORENW",85,0)
 . S TITMSG=TITMSG_" or enter a new prescription for the maintenance dose."
"RTN","PSORENW",86,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,TITMSG
"RTN","PSORENW",87,0)
 Q 1_$S($G(PSOIFLAG):"^"_$G(PSONEWOI),1:"")
"RTN","PSORENW",88,0)
 ;
"RTN","PSORENW",89,0)
INST1 ;Set Pharmacy Instructions array
"RTN","PSORENW",90,0)
 N PSOTZ
"RTN","PSORENW",91,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=$G(^PSRX(RXN,"PI",0)),PSOTZ=0 D
"RTN","PSORENW",92,0)
 .F  S PSOTZ=$O(^PSRX(RXN,"PI",PSOTZ)) Q:PSOTZ=""  S PHI(PSOTZ)=$G(^PSRX(RXN,"PI",PSOTZ,0))
"RTN","PSORENW",93,0)
 Q
"RTN","PSORENW",94,0)
INST2 ;Set Instructions and Comments
"RTN","PSORENW",95,0)
 I '$G(PSORENW("OIRXN")) Q
"RTN","PSORENW",96,0)
 I $G(PSOFDR) Q
"RTN","PSORENW",97,0)
 N PSOPHL,PSOPRL
"RTN","PSORENW",98,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) K PHI S PHI=$G(^PSRX(PSORENW("OIRXN"),"PI",0)),PSOPHL="" D
"RTN","PSORENW",99,0)
 .F  S PSOPHL=$O(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL)) Q:PSOPHL=""  S PHI(PSOPHL)=$G(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL,0))
"RTN","PSORENW",100,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) K PRC S PRC=$G(^PSRX(PSORENW("OIRXN"),"PRC",0)),PSOPRL="" D
"RTN","PSORENW",101,0)
 .F  S PSOPRL=$O(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL)) Q:PSOPRL=""  S PRC(PSOPRL)=$G(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL,0))
"RTN","PSORENW",102,0)
 Q
"RTN","PSORENW0")
0^26^B84910963
"RTN","PSORENW0",1,0)
PSORENW0 ;IHS/DSD/JCM-renew main driver continuation ;2/8/06 8:40am
"RTN","PSORENW0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,59,64,46,71,96,100,130,237,206,251,375,379,372,411**;DEC 1997;Build 95
"RTN","PSORENW0",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW0",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW0",5,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW0",6,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW0",7,0)
 ;
"RTN","PSORENW0",8,0)
 ;PSO*237 was not adding to Clozapine Override file, fix
"RTN","PSORENW0",9,0)
PROCESS ;
"RTN","PSORENW0",10,0)
 D ^PSORENW1
"RTN","PSORENW0",11,0)
 D INST2^PSORENW
"RTN","PSORENW0",12,0)
 I $D(PSORX("BAR CODE")),PSODFN'=PSORENW("PSODFN") D NEWPT
"RTN","PSORENW0",13,0)
 S PSORENW("DFLG")=0,PSORENW("FILL DATE")=PSORNW("FILL DATE")
"RTN","PSORENW0",14,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW0",15,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW0",16,0)
 D CHECK G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",17,0)
 D FILDATE
"RTN","PSORENW0",18,0)
 D DRUG G:PSORENW("DFLG")!PSORX("DFLG") PROCESSX
"RTN","PSORENW0",19,0)
 D RXN G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",20,0)
 D STOP^PSORENW1,OERR^PSORENW1:$G(PSOFDR)
"RTN","PSORENW0",21,0)
DSPL K PSOEDT,PSOLM D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW0",22,0)
 S PSORENW("QFLG")=0 D:'$G(PSOFDR) EDIT
"RTN","PSORENW0",23,0)
 G:PSORENW("DFLG")!$G(PSORX("FN")) PROCESSX
"RTN","PSORENW0",24,0)
 G:'$G(PSORX("FN"))&('$G(PSORENW("QFLG"))) DSPL
"RTN","PSORENW0",25,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) I PSORENW("DFLG")=1 G PROCESSX
"RTN","PSORENW0",26,0)
 I $G(NEWDOSE),PSORENW("ENT")>0 K NEWDOSE G DSPL
"RTN","PSORENW0",27,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW0",28,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW0",29,0)
 D CAN,DCORD^PSONEW2
"RTN","PSORENW0",30,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W"
"RTN","PSORENW0",31,0)
 ;PSO*237 add to Clozapine Override file
"RTN","PSORENW0",32,0)
ANQ I $G(ANQDATA)]"" D NOW^%DTC G:$D(^PS(52.52,"B",%)) ANQ D
"RTN","PSORENW0",33,0)
 . K DD,DO S DIC="^PS(52.52,",DIC(0)="L",DLAYGO=52.52,X=%
"RTN","PSORENW0",34,0)
 . D FILE^DICN K DIC,DLAYGO,DD,DO,DA,DR
"RTN","PSORENW0",35,0)
 . N PS52 S (PS52,DA)=+Y,DIE="^PS(52.52,",DR="1////"_PSORENW("IRXN")
"RTN","PSORENW0",36,0)
 . D ^DIE K DIE,DA,DR
"RTN","PSORENW0",37,0)
 . S $P(^PS(52.52,PS52,0),"^",3,6)=ANQDATA
"RTN","PSORENW0",38,0)
 . K ANQDATA,X,Y,%,ANQREM
"RTN","PSORENW0",39,0)
 ;
"RTN","PSORENW0",40,0)
PROCESSX N PSORWRIT I PSORENW("DFLG")!$G(PSORX("DFLG")) S PSOBBCLK=1 W:'$G(POERR) !,$C(7),"RENEWED RX DELETED",! S PSOWRIT=1,PSORERR=1 D
"RTN","PSORENW0",41,0)
 .D:$P($G(PSOLST(+$G(ORN))),"^",2) PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) S POERR("DFLG")=1 D CLEAN^PSOVER1 D
"RTN","PSORENW0",42,0)
 ..W !! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR,DTOUT,DUOUT S VALMBCK="Q"
"RTN","PSORENW0",43,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW0",44,0)
 K PRC,PHI,PSOQUIT,BBRN,BBRN1,PSORENW,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC"),PSORX("FN")
"RTN","PSORENW0",45,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW0",46,0)
 D CLEAN^PSOVER1
"RTN","PSORENW0",47,0)
 Q
"RTN","PSORENW0",48,0)
 ;
"RTN","PSORENW0",49,0)
CHECK ;
"RTN","PSORENW0",50,0)
 I '$D(PSORX("BAR CODE")),PSORENW("PSODFN")'=PSODFN D  G CHECKX
"RTN","PSORENW0",51,0)
 .W !!,?5,$C(7),"Can't renew Rx # "_$P(PSORENW("RX0"),"^")_", it is not for this patient." S PSORENW("DFLG")=1
"RTN","PSORENW0",52,0)
 .S:$G(POERR) VALMSG="Can't renew Rx # "_$P(PSORENW("RX0"),"^")_", not for this patient.",VALMBCK="R"
"RTN","PSORENW0",53,0)
 ;Invalid dosage check
"RTN","PSORENW0",54,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=PSORENW("OIRXN") D CDOSE
"RTN","PSORENW0",55,0)
 I PSOOLPF!(PSONOSIG) D  G CHECKX
"RTN","PSORENW0",56,0)
 .S PSORENW("DFLG")=1
"RTN","PSORENW0",57,0)
 .W !!,$C(7),"Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_$S(PSOOLPF:", invalid dosage of "_$G(PSOOLPD),1:", Missing Sig")
"RTN","PSORENW0",58,0)
 .S:$G(POERR) VALMSG="Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_$S(PSOOLPF:", invalid Dosage of "_$G(PSOOLPD),1:", Missing Sig") S VALMBCK="R"
"RTN","PSORENW0",59,0)
 .I '$G(PSORNSPD) W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSORENW0",60,0)
 .I $G(PSORNSPD) W !
"RTN","PSORENW0",61,0)
 ;
"RTN","PSORENW0",62,0)
 N PSOS S (PSOS,PSOX,PSOY)="" K ACOM,DIR,DIRUT,DIRUT,DUOUT N DRG
"RTN","PSORENW0",63,0)
 I $G(PSOSD) F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""!(PSORENW("DFLG"))  I PSORENW("OIRXN")=+PSOSD(PSOS,PSOX) S PSOY=PSOSD(PSOS,PSOX) I $TR($P(PSOY,"^",3),"B")]"" D  K ACOM,DIR,DIRUT,DIRUT,DUOUT
"RTN","PSORENW0",64,0)
 . S PSORENW("DFLG")=1
"RTN","PSORENW0",65,0)
 . W !,$C(7),"Cannot renew Rx # ",$P(PSORENW("RX0"),"^")
"RTN","PSORENW0",66,0)
 . S PSOREA=$P(PSOY,"^",3),PSOSTAT=+PSORENW("STA")
"RTN","PSORENW0",67,0)
 . D STATUS^PSOUTIL(PSOREA,PSOSTAT) K PSOREA,PSOSTAT
"RTN","PSORENW0",68,0)
 .I $G(ACOM)]"" D
"RTN","PSORENW0",69,0)
 ..S DRG=$P(^PSDRUG($P(^PSRX(PSORENW("OIRXN"),0),"^",6),0),"^")
"RTN","PSORENW0",70,0)
 ..W ! S DIR(0)="Y",DIR("A",1)="Do you want to Discontinue this Pending Order",DIR("A")="for "_DRG,DIR("B")="No"
"RTN","PSORENW0",71,0)
 ..D ^DIR I 'Y!($D(DIRUT)) Q
"RTN","PSORENW0",72,0)
 ..D NOOR^PSOCAN4 Q:$D(DIRUT)  D DE^PSOORFI2
"RTN","PSORENW0",73,0)
 .Q
"RTN","PSORENW0",74,0)
 I PSOY="",'$G(PSOORRNW) D
"RTN","PSORENW0",75,0)
 .W !,$C(7),"Cannot renew Rx # ",$P(PSORENW("RX0"),"^")," later Rx exists." S PSORENW("DFLG")=1
"RTN","PSORENW0",76,0)
 .S:$G(POERR) VALMSG="Cannot renew Rx # "_$P(PSORENW("RX0"),"^")_" later Rx exists.",VALMBCK="R"
"RTN","PSORENW0",77,0)
 K PSOX,PSOY G:PSORENW("DFLG") CHECKX
"RTN","PSORENW0",78,0)
 ;
"RTN","PSORENW0",79,0)
 I $A($E(PSORENW("ORX #"),$L(PSORENW("ORX #"))))'<90 D  Q
"RTN","PSORENW0",80,0)
 . W !,$C(7),"Cannot renew Rx # "_PSORENW("ORX #")_", Max number of renewals reached."
"RTN","PSORENW0",81,0)
 .S:$G(POERR)!('$G(SPEED)) (ACOM,VALMSG)="Cannot renew Rx # "_PSORENW("ORX #")_", Max number reached.",VALMBCK="R"
"RTN","PSORENW0",82,0)
 . S PSORENW("DFLG")=1
"RTN","PSORENW0",83,0)
 .I $G(OR0)]"" D
"RTN","PSORENW0",84,0)
 ..S DRG=$P(^PSDRUG($P(^PSRX(PSORENW("OIRXN"),0),"^",6),0),"^")
"RTN","PSORENW0",85,0)
 ..W ! S DIR(0)="Y",DIR("A",1)="Do you want to Discontinue this Pending Order",DIR("A")="for "_DRG,DIR("B")="No"
"RTN","PSORENW0",86,0)
 ..D ^DIR I 'Y!($D(DIRUT)) Q
"RTN","PSORENW0",87,0)
 ..D NOOR^PSOCAN4 Q:$D(DIRUT)  D DE^PSOORFI2
"RTN","PSORENW0",88,0)
 .K ACOM Q
"RTN","PSORENW0",89,0)
 D CHKDIV G:PSORENW("DFLG") CHECKX
"RTN","PSORENW0",90,0)
 ;
"RTN","PSORENW0",91,0)
 D CHKPRV^PSOUTIL
"RTN","PSORENW0",92,0)
CHECKX Q
"RTN","PSORENW0",93,0)
 ;
"RTN","PSORENW0",94,0)
CHKDIV ;
"RTN","PSORENW0",95,0)
 G:$P(PSORENW("RX2"),"^",9)=+PSOSITE CHKDIVX
"RTN","PSORENW0",96,0)
 W !?5,$C(7),"RX # ",$P(PSORENW("RX0"),"^")," is for (",$P(^PS(59,$P(PSORENW("RX2"),"^",9),0),"^"),") division."
"RTN","PSORENW0",97,0)
 I '$P($G(PSOSYS),"^",2) S PSORENW("DFLG")=1 G CHKDIVX
"RTN","PSORENW0",98,0)
 D:$P($G(PSOSYS),"^",3) DIR
"RTN","PSORENW0",99,0)
CHKDIVX Q
"RTN","PSORENW0",100,0)
 ;
"RTN","PSORENW0",101,0)
DRUG ;
"RTN","PSORENW0",102,0)
 K PSOY
"RTN","PSORENW0",103,0)
 S PSOY=PSORENW("DRUG IEN"),PSOY(0)=^PSDRUG(PSOY,0),PSORENWD=1
"RTN","PSORENW0",104,0)
 I '$P($G(^PSDRUG(PSOY,2)),"^") D  Q:$G(PSORX("DFLG"))
"RTN","PSORENW0",105,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW0",106,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW0",107,0)
 D SET^PSODRG
"RTN","PSORENW0",108,0)
 D POST^PSODRG D:'PSORX("DFLG") DOSCK^PSODOSUT("R") S:$G(PSORX("DFLG")) PSORENW("DFLG")=1 ;remove order checks for v7. do allergy checks only
"RTN","PSORENW0",109,0)
 S PSONOOR=PSORENW("NOO")
"RTN","PSORENW0",110,0)
 K PSORX("INTERVENE")
"RTN","PSORENW0",111,0)
 S:$D(PSONEW("STATUS")) PSORENW("STATUS")=PSONEW("STATUS")
"RTN","PSORENW0",112,0)
 K PSOY,PSONEW("STATUS"),PSORENWD
"RTN","PSORENW0",113,0)
 Q
"RTN","PSORENW0",114,0)
 ;
"RTN","PSORENW0",115,0)
RXN ;
"RTN","PSORENW0",116,0)
 K PSOX
"RTN","PSORENW0",117,0)
 S PSOX=$E(PSORENW("ORX #"),$L(PSORENW("ORX #")))
"RTN","PSORENW0",118,0)
 S PSORENW("NRX #")=$S(PSOX?1N:PSORENW("ORX #")_"A",1:$E(PSORENW("ORX #"),1,$L(PSORENW("ORX #"))-1)_$C($A(PSOX)+1))
"RTN","PSORENW0",119,0)
RETRY I $O(^PSRX("B",PSORENW("NRX #"),0)) D  G:'$G(PSORENW("DFLG")) RETRY
"RTN","PSORENW0",120,0)
 .W:$A($E(PSORENW("NRX #"),$L(PSORENW("ORX #"))))'=90 !,"Rx # "_PSORENW("NRX #")_" is already on file."
"RTN","PSORENW0",121,0)
 .S:$G(PSOFDR) VALMSG="Rx # "_PSORENW("NRX #")_" is already on file."
"RTN","PSORENW0",122,0)
 .I $A($E(PSORENW("NRX #"),$L(PSORENW("ORX #"))))=90 D
"RTN","PSORENW0",123,0)
 ..W !,"Rx # "_PSORENW("NRX #")_" is already on file. Cannot renew Rx #"_PSORENW("ORX #")_".",!,"A new Rx must be entered.",!
"RTN","PSORENW0",124,0)
 ..S:$G(PSOFDR) VALMSG="Rx # "_PSORENW("NRX #")_" is already on file. Cannot renew Rx #"_PSORENW("ORX #")_". A new Rx must be entered."
"RTN","PSORENW0",125,0)
 ..K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSORENW0",126,0)
 ..S:$G(POERR)!($G(PSOFDR)) VALMSG="Cannot renew Rx # "_PSORENW("ORX #")_", Max number reached.",VALMBCK="R" S PSORENW("DFLG")=1
"RTN","PSORENW0",127,0)
 .S PSOX=$E(PSORENW("NRX #"),$L(PSORENW("NRX #")))
"RTN","PSORENW0",128,0)
 .S PSORENW("NRX #")=$S(PSOX?1N:PSORENW("NRX #")_"A",1:$E(PSORENW("NRX #"),1,$L(PSORENW("NRX #"))-1)_$C($A(PSOX)+1))
"RTN","PSORENW0",129,0)
RXNX K PSOX
"RTN","PSORENW0",130,0)
 Q
"RTN","PSORENW0",131,0)
 ;
"RTN","PSORENW0",132,0)
FILDATE ;
"RTN","PSORENW0",133,0)
 S PSORENW("IRXN")=PSORENW("OIRXN")
"RTN","PSORENW0",134,0)
 D NEXT^PSOUTIL(.PSORENW)
"RTN","PSORENW0",135,0)
 I PSORENW("FILL DATE")<$P(PSORENW("RX3"),"^",2) D
"RTN","PSORENW0",136,0)
 .D RENFDT^PSOUTIL(.PSORENW)
"RTN","PSORENW0",137,0)
 .I PSORENW("FILL DATE")<DT,PSORENW("FILL DATE")<PSORNW("FILL DATE") S (Y,PSORENW("FILL DATE"))=DT X ^DD("DD") S PSORX("FILL DATE")=Y K Y
"RTN","PSORENW0",138,0)
 K PSORENW("IRXN")
"RTN","PSORENW0",139,0)
 Q
"RTN","PSORENW0",140,0)
 ;
"RTN","PSORENW0",141,0)
EDIT ;
"RTN","PSORENW0",142,0)
 K DIR,X,Y
"RTN","PSORENW0",143,0)
 S DIR(0)="Y",DIR("B")=$S($G(DUZ("AG"))'="I":"Y",$G(PSEXDT):"Y",1:"N")
"RTN","PSORENW0",144,0)
 S DIR("A")="Edit renewed Rx ",DIR("?")="Answer YES to edit the renewed Rx, NO not to."
"RTN","PSORENW0",145,0)
 D ^DIR K DIR S:$D(DIRUT) PSORENW("DFLG")=1
"RTN","PSORENW0",146,0)
 G:PSORENW("DFLG") EDITX
"RTN","PSORENW0",147,0)
 K PSOQUIT,PSORX("FN") I Y S PSORNALL=1 D INIT^PSORENW3,EN^PSOORNE4(.PSORENW) K PSORNALL S:$G(PSOQUIT) PSORENW("DFLG")=1 I '$G(PSORX("FN")) D FULL^VALM1 Q
"RTN","PSORENW0",148,0)
 Q:$G(PSORX("FN"))
"RTN","PSORENW0",149,0)
EDITX S PSOEDT=1,VALMBCK="Q" K X,Y,DIRUT,DTOUT,DUOUT S PSORENW("QFLG")=1
"RTN","PSORENW0",150,0)
 Q
"RTN","PSORENW0",151,0)
 ;
"RTN","PSORENW0",152,0)
DELETE ;
"RTN","PSORENW0",153,0)
 K DA,DIK
"RTN","PSORENW0",154,0)
 S DA=$O(^PS(52.5,"B",PSORENW("OIRXN"),0)),DIK="^PS(52.5,"
"RTN","PSORENW0",155,0)
 D ^DIK K DIK,DIC
"RTN","PSORENW0",156,0)
 Q
"RTN","PSORENW0",157,0)
 ;
"RTN","PSORENW0",158,0)
CAN ;
"RTN","PSORENW0",159,0)
 K REA,DA,MSG
"RTN","PSORENW0",160,0)
 S REA="C",DA=PSORENW("OIRXN")
"RTN","PSORENW0",161,0)
 S MSG="Renewed"_$S($G(PSOFDR):" from CPRS",1:"")
"RTN","PSORENW0",162,0)
 S PSCAN(PSORENW("ORX #"))=DA_"^C"
"RTN","PSORENW0",163,0)
 D CAN^PSOCAN
"RTN","PSORENW0",164,0)
 K REA,DA,MSG,PSCAN
"RTN","PSORENW0",165,0)
 Q
"RTN","PSORENW0",166,0)
 ;
"RTN","PSORENW0",167,0)
DIR ;
"RTN","PSORENW0",168,0)
 S DIR(0)="Y",DIR("A")="CONTINUE ",DIR("B")="N"
"RTN","PSORENW0",169,0)
 S DIR("?")="Answer YES to Continue, NO to bypass"
"RTN","PSORENW0",170,0)
 D ^DIR K DIR
"RTN","PSORENW0",171,0)
 S:$D(DIRUT)!('Y) PSORENW("DFLG")=1
"RTN","PSORENW0",172,0)
DIRX K DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSORENW0",173,0)
 Q
"RTN","PSORENW0",174,0)
NEWPT ;
"RTN","PSORENW0",175,0)
 S PSOQFLG=0 N PSODFN
"RTN","PSORENW0",176,0)
 S PSODFN=PSORENW("PSODFN")
"RTN","PSORENW0",177,0)
 D ^PSOPTPST I PSOQFLG S PSORENW("DFLG")=1,PSOQFLG=0 G NEWPTX
"RTN","PSORENW0",178,0)
 D PROFILE^PSOREF1
"RTN","PSORENW0",179,0)
NEWPTX Q
"RTN","PSORENW0",180,0)
 ;
"RTN","PSORENW0",181,0)
EN(PSORENW)        ; Entry Point for Batch Barcode Option
"RTN","PSORENW0",182,0)
 S PSORENRX=$G(PSOBBC("OIRXN"))
"RTN","PSORENW0",183,0)
 I $G(PSORENRX) D PSOL^PSSLOCK(PSORENRX) I '$G(PSOMSG) D  K DIR,PSOMSG W ! S DIR("A")="Press Return to continue",DIR(0)="E",DIR("?")="Press Return to continue" D ^DIR K DIR W ! Q
"RTN","PSORENW0",184,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P(PSOMSG,"^",2) Q
"RTN","PSORENW0",185,0)
 .W $C(7),!!,"Another person is editing Rx "_$P($G(^PSRX(PSORENRX,0)),"^")
"RTN","PSORENW0",186,0)
 K PSOMSG,PSOBBCLK S PSOBARCD=1 D PROCESS K PSOBARCD
"RTN","PSORENW0",187,0)
 D KLIB^PSORENW1
"RTN","PSORENW0",188,0)
 I $G(PSORENRX),$G(PSOBBCLK) D PSOUL^PSSLOCK(PSORENRX)
"RTN","PSORENW0",189,0)
 K PSORENRX,PSOBBCLK
"RTN","PSORENW0",190,0)
 Q
"RTN","PSORENW0",191,0)
CDOSE ;Validate Dosage field on Renewal, Copy, Edit
"RTN","PSORENW0",192,0)
 ;PSOOCPRX must be set to internal Rx number
"RTN","PSORENW0",193,0)
 Q:'$G(PSOOCPRX)
"RTN","PSORENW0",194,0)
 N PSOOLP,PSOOKZ
"RTN","PSORENW0",195,0)
 S PSOOLP="",(PSOOLPF,PSONOSIG)=0 F  S PSOOLP=$O(^PSRX(PSOOCPRX,6,PSOOLP)) Q:PSOOLP=""!(PSOOLPF)  I $P($G(^PSRX(PSOOCPRX,6,PSOOLP,0)),"^")["0.." S PSOOLPD=$P($G(^(0)),"^"),PSOOLPF=1
"RTN","PSORENW0",196,0)
 Q:PSOOLPF
"RTN","PSORENW0",197,0)
 S PSOOKZ=0
"RTN","PSORENW0",198,0)
 I $P($G(^PSRX(PSOOCPRX,"SIG")),"^",2) S PSOOLP="" F  S PSOOLP=$O(^PSRX(PSOOCPRX,"SIG1",PSOOLP)) Q:PSOOLP=""!(PSOOKZ)  I $G(^PSRX(PSOOCPRX,"SIG1",PSOOLP,0))'="" S PSOOKZ=1
"RTN","PSORENW0",199,0)
 I '$P($G(^PSRX(PSOOCPRX,"SIG")),"^",2),$P($G(^("SIG")),"^")'="" S PSOOKZ=1
"RTN","PSORENW0",200,0)
 I 'PSOOKZ S PSONOSIG=1
"RTN","PSORENW0",201,0)
 Q
"RTN","PSORENW0",202,0)
 ;
"RTN","PSORENW4")
0^20^B66539714
"RTN","PSORENW4",1,0)
PSORENW4 ; BIR/SAB - rx speed renew ; 11/13/08 8:50am
"RTN","PSORENW4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,37,64,46,75,71,100,130,117,152,148,264,225,301,390,313,411**;DEC 1997;Build 95
"RTN","PSORENW4",3,0)
 ;External reference to ^PSDRUG( supported by DBIA 4846
"RTN","PSORENW4",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW4",5,0)
 ;External reference to $$L^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",6,0)
 ;External reference to UL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",7,0)
 ;External reference to PSOL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",8,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW4",9,0)
 ;External reference to LK^ORX2 supported by DBIA 867
"RTN","PSORENW4",10,0)
 ;External reference to ULK^ORX2 supported by DBIA 867
"RTN","PSORENW4",11,0)
SEL K PSODRUG ;PSO*7*301
"RTN","PSORENW4",12,0)
 N PSOSPRNW,PSOIBOLD S PSOSPRNW=1
"RTN","PSORENW4",13,0)
 I $P(PSOPAR,"^",4)=0 S VALMSG="Renewing is NOT Allowed. Check Site Parameters!",VALMBCK="" Q
"RTN","PSORENW4",14,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!",VALMBCK="" Q
"RTN","PSORENW4",15,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW4",16,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW4",17,0)
 K PRC,PHI,PSORX("EDIT"),PSOFDR,DIR,DUOUT,DIRUT,PSORNSPD S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" G SELQ
"RTN","PSORENW4",18,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +Y S (SPEED,PSOOELSE,PSORNSPD)=1 D FULL^VALM1 S LST=Y D
"RTN","PSORENW4",19,0)
 .S (PSODIR("DFLG"),PSODIR("FIELD"))=0,PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0 D INIT Q:PSORENW("DFLG")
"RTN","PSORENW4",20,0)
 .F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D:+PSOLST(ORN)=52 PROCESS S (PSOQUIT,PSORENW("DFLG"),POERR,POERR("DFLG"),PSORX("DFLG"))=0
"RTN","PSORENW4",21,0)
 I '$G(PSOOELSE) S VALMBCK="" G SELQ
"RTN","PSORENW4",22,0)
 S VALMBCK="R"
"RTN","PSORENW4",23,0)
 D ^PSOBUILD,BLD^PSOORUT1 K DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SPEED,PSORENW,PSOOELSE,PSOOPT,PSORX("FILL DATE"),PSORX("ISSUE DATE"),PSOID,PSOMSG,PSORX("DFLG"),PSOQTY
"RTN","PSORENW4",24,0)
SELQ K PSORNSPD,RTE,DRET,PRC,PHI,PSOSPRNW,X S X=PSODFN_";DPT(" D ULK^ORX2,UL^PSSLOCK(PSODFN),CLEAN^PSOVER1
"RTN","PSORENW4",25,0)
 Q
"RTN","PSORENW4",26,0)
 ;
"RTN","PSORENW4",27,0)
PROCESS ; Process one order at a time
"RTN","PSORENW4",28,0)
 ;W !!,"Now Renewing Rx # "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_"   Drug: "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),6),!
"RTN","PSORENW4",29,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2)) D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",30,0)
 . W $C(7),!,"Rx "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" has OPEN/UNRESOLVED 3rd Party Payer Rejects!"
"RTN","PSORENW4",31,0)
 I $$TITRX^PSOUTL($P(PSOLST(ORN),"^",2))="t" D  K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",32,0)
 . W $C(7),!,"Rx# "_$$GET1^DIQ(52,$P(PSOLST(ORN),"^",2),.01)_" is marked as 'Titration Rx' and cannot be renewed."
"RTN","PSORENW4",33,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) W $C(7),!!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")),! K DIR,PSOMSG D PAUSE^VALM1 Q
"RTN","PSORENW4",34,0)
 K RET,DRET,PRC,PHI S PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOFROM="NEW"
"RTN","PSORENW4",35,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN")),SIGOK=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^",2)
"RTN","PSORENW4",36,0)
 I SIGOK F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW4",37,0)
 S PSOIBOLD=$G(PSORENW("OIRXN")) D SETIB^PSORENW1
"RTN","PSORENW4",38,0)
 I '$G(PSORENW("PROVIDER")) D
"RTN","PSORENW4",39,0)
 .S PSORENW("PROVIDER")=$P(PSORENW("RX0"),"^",4)
"RTN","PSORENW4",40,0)
 .S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW4",41,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW4",42,0)
 I '$G(PSORENW("CLINIC")) S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5)
"RTN","PSORENW4",43,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",44,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")
"RTN","PSORENW4",45,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW4",46,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW4",47,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6)
"RTN","PSORENW4",48,0)
 S PSORENW("QTY")=$P(PSORENW("RX0"),"^",7)
"RTN","PSORENW4",49,0)
 ;S PSORENW("DAYS SUPPLY")=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW4",50,0)
 ;S PSORENW("# OF REFILLS")=$P(PSORENW("RX0"),"^",9)
"RTN","PSORENW4",51,0)
 S PSORENW("INS")=$S($G(PSORENW("ENT"))]"":PSORENW("ENT"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW4",52,0)
 S:$G(PSORENW("ENT"))']"" PSORENW("ENT")=0
"RTN","PSORENW4",53,0)
 N I F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW4",54,0)
 .S PSORENW("ENT")=PSORENW("ENT")+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW4",55,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW4",56,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW4",57,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW4",58,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW4",59,0)
 .K DOSE
"RTN","PSORENW4",60,0)
 I $P($G(^PSDRUG(PSORENW("DRUG IEN"),"CLOZ1")),"^")="PSOCLO1" N PSON S PSON=0 D  I PSON K PSON D POZ,KLIB^PSORENW1 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSORENW4",61,0)
 . I '$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",2)),'$L($P(^VA(200,PSORENW("PROVIDER"),"PS"),"^",3)) D  Q
"RTN","PSORENW4",62,0)
 . . S PSON=1 W $C(7),!!,"Only providers with DEA# or a VA# can write prescriptions for clozapine.",!
"RTN","PSORENW4",63,0)
 . I '$D(^XUSEC("YSCL AUTHORIZED",PSORENW("PROVIDER"))) D 
"RTN","PSORENW4",64,0)
 . . S PSON=1 W $C(7),!!,"Provider must hold YSCL AUTHORIZED key to write prescriptions for clozapine.",!
"RTN","PSORENW4",65,0)
 I $G(PSORNW("MAIL/WINDOW"))]"" S PSORENW("MAIL/WINDOW")=PSORNW("MAIL/WINDOW")
"RTN","PSORENW4",66,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) D  K T
"RTN","PSORENW4",67,0)
 .S PHI=^PSRX(PSORENW("OIRXN"),"PI",0),T=0
"RTN","PSORENW4",68,0)
 .F  S T=$O(^PSRX(PSORENW("OIRXN"),"PI",T)) Q:'T  S PHI(T)=^PSRX(PSORENW("OIRXN"),"PI",T,0)
"RTN","PSORENW4",69,0)
 ;I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) D  K T
"RTN","PSORENW4",70,0)
 ;.S PRC=^PSRX(PSORENW("OIRXN"),"PRC",0),T=0
"RTN","PSORENW4",71,0)
 ;.F  S T=$O(^PSRX(PSORENW("OIRXN"),"PRC",T)) Q:'T  S PRC(T)=^PSRX(PSORENW("OIRXN"),"PRC",T,0)
"RTN","PSORENW4",72,0)
 W !!,"Now Renewing Rx # "_PSORENW("ORX #")_"   Drug: "_$P($G(^PSDRUG(+$G(PSORENW("DRUG IEN")),0)),"^"),!
"RTN","PSORENW4",73,0)
 I '$P($G(^PSDRUG($P(PSORENW("RX0"),"^",6),2)),"^") D  G:$G(PSORENW("DFLG")) PROCESSX
"RTN","PSORENW4",74,0)
 .I $P($G(^PSRX(PSORENW("OIRXN"),"OR1")),"^") S PSODRUG("OI")=$P(^PSRX(PSORENW("OIRXN"),"OR1"),"^"),PSODRUG("OIN")=$P(^PS(50.7,+^("OR1"),0),"^") Q
"RTN","PSORENW4",75,0)
 .W !!,"Cannot Renew!!  No Pharmacy Orderable Item!" S VALMSG="Cannot Renew!!  No Pharmacy Orderable Item!",PSORX("DFLG")=1
"RTN","PSORENW4",76,0)
 D POZ
"RTN","PSORENW4",77,0)
 D CHECK^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",78,0)
 D FILDATE^PSORENW0
"RTN","PSORENW4",79,0)
 D DRUG^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",80,0)
 D RXN^PSORENW0 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",81,0)
 D STOP^PSORENW1
"RTN","PSORENW4",82,0)
DSPL K PSOEDT,PSOLM,BBFLG,BBRX,BINGCRT,BINGRTE S PSDY=PSORENW("DAYS SUPPLY"),PSRF=PSORENW("# OF REFILLS")
"RTN","PSORENW4",83,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSORENW4",84,0)
 I $G(PSODIR("CS")) D
"RTN","PSORENW4",85,0)
 .S PSORENW("# OF REFILLS")=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0)
"RTN","PSORENW4",86,0)
 .I PSORENW("# OF REFILLS")>PSRF S PSORENW("# OF REFILLS")=PSRF
"RTN","PSORENW4",87,0)
 D DSPLY^PSORENW3 G:PSORENW("DFLG") PROCESSX
"RTN","PSORENW4",88,0)
 D:$D(^XUSEC("PSORPH",DUZ))!('$P(PSOPAR,"^",2)) VER1^PSOORNE4(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",89,0)
 I $G(PSOQTY) D QTY^PSODIR1(.PSORENW) G:PSORENW("DFLG")=1 PROCESSX
"RTN","PSORENW4",90,0)
 D EN^PSORN52(.PSORENW)
"RTN","PSORENW4",91,0)
 D RNPSOSD^PSOUTIL
"RTN","PSORENW4",92,0)
 D CAN^PSORENW0,DCORD^PSONEW2
"RTN","PSORENW4",93,0)
 S PSORENW("# OF REFILLS")=PSRF K PSDY,PSRF,PSODIR("CS"),DEA,PSORENW("ENT")
"RTN","PSORENW4",94,0)
 S BBRN="",BBRN1=$O(^PSRX("B",PSORENW("NRX #"),BBRN)) I $P($G(^PSRX(BBRN1,0)),"^",11)["W" S BINGCRT="Y",BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_BBRN1_","
"RTN","PSORENW4",95,0)
PROCESSX I PSORENW("DFLG") D
"RTN","PSORENW4",96,0)
 .K PHI,PRC,PSODRUG,SIG,PSORXED,SIGOK
"RTN","PSORENW4",97,0)
 .K PSORENW("DOSE"),PSORENW("DURATION"),PSORENW("DRUG IEN"),PSORENW("ENT"),PSORENW("INS"),PSORENW("NOUN"),PSORENW("ROUTE"),PSORENW("SCHEDULE"),PSORENW("SIG"),PSORENW("VERB"),PSORENW("UNITS")
"RTN","PSORENW4",98,0)
 .I '$G(POERR) W !,$C(7),"Rx NOT RENEWED. RENEWED RX DELETED",! S POERR("DFLG")=1 D CLEAN^PSOVER1,POZ
"RTN","PSORENW4",99,0)
 K PSORDLOK I PSORENW("DFLG") S PSORDLOK=1
"RTN","PSORENW4",100,0)
 D:$G(PSORENW("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSORENW)
"RTN","PSORENW4",101,0)
 K BBRN,BBRN1,PSODRUG,PSORX("PROVIDER NAME"),PSORX("CLINIC")
"RTN","PSORENW4",102,0)
 K PSOEDT,PSOLM S:$G(PSORENW("FROM"))="" (PSORENW("DFLG"),PSORENW("QFLG"))=0
"RTN","PSORENW4",103,0)
 I $G(PSORDLOK) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORENW4",104,0)
 D KLIB^PSORENW1
"RTN","PSORENW4",105,0)
 K PSORDLOK
"RTN","PSORENW4",106,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN N ZRXN S ZRXN=RXN D
"RTN","PSORENW4",107,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW4",108,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW4",109,0)
 .;saves drug allergy order chks pso*7*390
"RTN","PSORENW4",110,0)
 .I $D(^TMP("PSODAOC",$J,"ALLERGY")) D 
"RTN","PSORENW4",111,0)
 ..I $G(PSORX("DFLG"))!$G(PSORENW("DFLG")) K ^TMP("PSODAOC",$J) Q
"RTN","PSORENW4",112,0)
 ..S RXN=ZRXN,PSODAOC="Rx Backdoor "_$S($P(^PSRX(RXN,"STA"),"^")=4:"NON-VERIFIED ",1:"")_"SPEED RENEW Order Acceptance_OP"
"RTN","PSORENW4",113,0)
 ..S PSOARENW=1 D DAOC^PSONEW K PSOARENW
"RTN","PSORENW4",114,0)
 K ZRXN,RXN,RXN1,^TMP("PSORXN",$J),^TMP("PSODAOC",$J)
"RTN","PSORENW4",115,0)
 Q
"RTN","PSORENW4",116,0)
INIT ;
"RTN","PSORENW4",117,0)
 D ASK Q:PSORENW("DFLG")
"RTN","PSORENW4",118,0)
 D NOORE^PSONEW(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",119,0)
 Q
"RTN","PSORENW4",120,0)
ASK ;upfront questions
"RTN","PSORENW4",121,0)
 W !! D ISSDT^PSODIR2(.PSORENW) Q:PSORENW("DFLG")  S PSORENW("ISSUE DATE")=PSOID
"RTN","PSORENW4",122,0)
 D FILLDT^PSODIR2(.PSORENW) K PSONEW("DAYS SUPPLY"),PSONEW("# OF REFILLS") Q:PSORENW("DFLG")
"RTN","PSORENW4",123,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW4",124,0)
 D MW^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",125,0)
 D PTSTAT^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",126,0)
 D DAYS^PSODIR1(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",127,0)
 S PSODRUG("DEA")=0 D REFILL^PSODIR1(.PSORENW) K PSODRUG("DEA") Q:PSORENW("DFLG")
"RTN","PSORENW4",128,0)
 K DIR,DIRUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to edit Renewed Rx(s) QTY " D ^DIR I $D(DIRUT) S PSORENW("DFLG")=1 K DIR,DIRUT Q
"RTN","PSORENW4",129,0)
 S PSOQTY=Y K DIR,DIRUT,Y
"RTN","PSORENW4",130,0)
 D CLINIC^PSODIR2(.PSORENW) Q:PSORENW("DFLG")
"RTN","PSORENW4",131,0)
 D PROV^PSODIR(.PSORENW) S:PSORENW("DFLG") PSORENW("DFLG")=0
"RTN","PSORENW4",132,0)
 Q
"RTN","PSORENW4",133,0)
 ;
"RTN","PSORENW4",134,0)
POZ ;
"RTN","PSORENW4",135,0)
 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DTOUT
"RTN","PSORENW4",136,0)
 Q
"RTN","PSOUTL")
0^4^B147729082
"RTN","PSOUTL",1,0)
PSOUTL ;BHAM ISC/SAB - PSO utility routine ;4/28/09 4:14pm
"RTN","PSOUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,21,126,174,218,259,324,390,313,411**;DEC 1997;Build 95
"RTN","PSOUTL",3,0)
 ;External reference to $$SERV^IBARX1 supported by DBIA 2245
"RTN","PSOUTL",4,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOUTL",5,0)
 ;External reference to ^PSSDIUTL supported by DBIA 5737
"RTN","PSOUTL",6,0)
 ;External reference to ^DD("DD" supported by DBIA 999
"RTN","PSOUTL",7,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOUTL",8,0)
 ;
"RTN","PSOUTL",9,0)
 ;*218 prevent refill from being deleted if pending processing via
"RTN","PSOUTL",10,0)
 ; external dispense machines
"RTN","PSOUTL",11,0)
 ;*259 reverse *218 restrictions & Add del only last refill logic.
"RTN","PSOUTL",12,0)
 ;
"RTN","PSOUTL",13,0)
SUSPCAN ;dcl rx from suspense used in new, renew AND verification of Rxs
"RTN","PSOUTL",14,0)
 S PSLAST=0 F PSI=0:0 S PSI=$O(^PSRX(PSRX,1,PSI)) Q:'PSI  S PSLAST=PSI
"RTN","PSOUTL",15,0)
 I PSLAST S PSI=^PSRX(PSRX,1,PSLAST,0) K ^PSRX(PSRX,1,PSLAST),^PSRX(PSRX,1,"B",+PSI,PSLAST) S ^(0)=$P(^PSRX(PSRX,1,0),"^",1,3)_"^"_($P(^(0),"^",4)-1) K PSLAST,PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",16,0)
 S $P(^PSRX(PSRX,3),"^",7)="DISCONTINUED FROM SUSPENSE BEFORE FILLING" K PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",17,0)
 ;
"RTN","PSOUTL",18,0)
ACTLOG ;
"RTN","PSOUTL",19,0)
 N PSS
"RTN","PSOUTL",20,0)
 F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) I 'PSI!'$O(^(PSI)) S ^PSRX(PSRX,"A",+PSI+1,0)=DT_"^"_PSREA_"^"_PSOCLC_"^"_PSRXREF_"^"_PSMSG,^PSRX(PSRX,"A",0)="^52.3DA^"_(+PSI+1)_"^"_(+PSI+1) Q
"RTN","PSOUTL",21,0)
ACTOUT I PSREA="C" S PSI=$S($D(^PSRX(PSRX,2)):+$P(^(2),"^",6),1:0) K:$D(^PS(55,PSDFN,"P","A",PSI,PSRX)) ^(PSRX) S ^PS(55,PSDFN,"P","A",DT,PSRX)="" Q
"RTN","PSOUTL",22,0)
 I PSREA="R" F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) Q:'PSI  I $D(^(PSI,0)),$P(^(0),"^",2)="C" S PSS=+^(0)
"RTN","PSOUTL",23,0)
 I $D(PSS),PSS K:$D(^PS(55,PSDFN,"P","A",PSS,PSRX)) ^(PSRX)
"RTN","PSOUTL",24,0)
 I PSREA="R",$D(^PSRX(PSRX,2))#2 S ^PS(55,PSDFN,"P","A",+$P(^PSRX(PSRX,2),"^",6),PSRX)=""
"RTN","PSOUTL",25,0)
 Q
"RTN","PSOUTL",26,0)
 ;
"RTN","PSOUTL",27,0)
QUES ;INSTRUCTIONS FOR RENEW AND REFILL
"RTN","PSOUTL",28,0)
 W !?5,"Enter the item #(s) or RX #(s) you wish to ",$S(PSFROM="N":"renew ",PSFROM="R":"REFILL "),"separated by commas."
"RTN","PSOUTL",29,0)
 W !?5,"For example: 1,2,5 or 123456,33254A,232323B."
"RTN","PSOUTL",30,0)
 W !?5,"Do not enter the same number twice, duplicates are not allowed."
"RTN","PSOUTL",31,0)
 Q
"RTN","PSOUTL",32,0)
ENDVCHK N ANS,PSPOP S PSPOP=0 Q:'PSODIV  Q:'$P(^PSRX(PSRX,2),"^",9)!($P(^(2),"^",9)=PSOSITE)
"RTN","PSOUTL",33,0)
CHK1 I '$P(PSOSYS,"^",2) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is not a valid choice. (Different Division)" S PSPOP=1 Q
"RTN","PSOUTL",34,0)
 I $P(PSOSYS,"^",3) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is from another division. Continue? (Y/N) " R ANS:DTIME I ANS="^"!(ANS="") S PSPOP=1 Q
"RTN","PSOUTL",35,0)
 I (ANS']"")!("YNyn"'[$E(ANS)) W !?10,$C(7),"Answer 'YES' or 'NO'." G CHK1
"RTN","PSOUTL",36,0)
 S:$E(ANS)["Nn" PSPOP=1 Q
"RTN","PSOUTL",37,0)
 ;PSO*7*259; SET VAR PSOSFN TO CHECK FOR SUSPENDED REFILL
"RTN","PSOUTL",38,0)
K52 K PSOSFN S SFN=+$O(^PS(52.5,"B",DA(1),0)),PSOSFN=SFN Q:SFN=0
"RTN","PSOUTL",39,0)
 I $P($G(^PS(52.5,SFN,0)),"^",5)=$P($G(^PSRX(+^PS(52.5,SFN,0),"P",0)),"^",3),$P($G(^PSRX($P(^PS(52.5,SFN,0),"^"),"P",0)),"^",4)=0 N PSOXX S PSOXX=1 G KILL
"RTN","PSOUTL",40,0)
 G:X'=""&($G(Y)=1) KILL I $G(Y)'=1,SFN I $D(^PS(52.5,SFN,0)),'$P(^(0),"^",5),'$P($G(^("P")),"^") D
"RTN","PSOUTL",41,0)
 .S SDT=+$P(^PS(52.5,SFN,0),"^",2) K ^PS(52.5,"C",SDT,SFN)
"RTN","PSOUTL",42,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" K ^PS(52.5,"AQ",SDT,+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",43,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" K ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),SDT,SFN)
"RTN","PSOUTL",44,0)
 .K SFN,SDT
"RTN","PSOUTL",45,0)
 Q
"RTN","PSOUTL",46,0)
S52 S (RIFN,PSOSX)=0 F  S RIFN=$O(^PSRX(DA(1),1,RIFN)) Q:'RIFN  S RFID=$P(^PSRX(DA(1),1,RIFN,0),"^"),PSOSX=PSOSX+1
"RTN","PSOUTL",47,0)
 S SFN=+$O(^PS(52.5,"B",DA(1),0)) I SFN,'$G(^PS(52.5,SFN,"P")),$P($G(^PSRX($P($G(^PS(52.5,SFN,0)),"^"),"STA")),"^")=5 D
"RTN","PSOUTL",48,0)
 .I '$D(^PS(52.5,SFN,0))!($P($G(^(0)),"^",5)) Q
"RTN","PSOUTL",49,0)
 .S $P(^PS(52.5,SFN,0),"^",2)=RFID,^PS(52.5,"C",RFID,SFN)=""
"RTN","PSOUTL",50,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" S ^PS(52.5,"AQ",RFID,+$P(^PS(52.5,SFN,0),"^",3),SFN)="" D SCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",51,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" S ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),RFID,SFN)=""
"RTN","PSOUTL",52,0)
 K SFN,RIFN,RFID,PSOSX,PSOSXDT Q
"RTN","PSOUTL",53,0)
KILL N DFN
"RTN","PSOUTL",54,0)
 I SFN D
"RTN","PSOUTL",55,0)
 .S $P(^PSRX(DA(1),"STA"),"^")=0 Q:'$D(^PS(52.5,SFN,0))  S DFN=+$P(^PS(52.5,SFN,0),"^",3),PAT=$P(^DPT(DFN,0),"^")
"RTN","PSOUTL",56,0)
 .;I $P(^PS(52.5,SFN,0),"^",5) Q
"RTN","PSOUTL",57,0)
 .K ^PS(52.5,"B",+$P(^PS(52.5,SFN,0),"^"),SFN),^PS(52.5,"C",+$P(^PS(52.5,SFN,0),"^",2),SFN),^PS(52.5,"D",PAT,SFN),^PS(52.5,"AF",DFN,SFN)
"RTN","PSOUTL",58,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" D
"RTN","PSOUTL",59,0)
 ..I $G(^PS(52.5,SFN,"P")) K ^PS(52.5,"AS",+$P(^(0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN) Q
"RTN","PSOUTL",60,0)
 ..K ^PS(52.5,"AC",DFN,+$P(^PS(52.5,SFN,0),"^",2),SFN)
"RTN","PSOUTL",61,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)'="" D
"RTN","PSOUTL",62,0)
 ..;Kill CMOP xrefs
"RTN","PSOUTL",63,0)
 ..N PSOC7 S PSOC7=$P($G(^PS(52.5,SFN,0)),"^",7)
"RTN","PSOUTL",64,0)
 ..I PSOC7="Q"!(PSOC7="P") K ^PS(52.5,"AG",+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",65,0)
 ..I PSOC7="X"!(PSOC7="P")!(PSOC7="L") K ^PS(52.5,$S(PSOC7="X":"AX",PSOC7="P":"AP",1:"AL"),$P(^PS(52.5,SFN,0),"^",2),$P(^(0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",66,0)
 ..K ^PS(52.5,"APR",+$P(^PS(52.5,SFN,0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN)
"RTN","PSOUTL",67,0)
 .K ^PS(52.5,SFN,0),^PS(52.5,SFN,"P"),DFN,SFN,PAT
"RTN","PSOUTL",68,0)
 S CNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA(1),"A",SUB)) Q:'SUB  S CNT=SUB
"RTN","PSOUTL",69,0)
 S:DA>5 DA=DA+1 D NOW^%DTC S CNT=CNT+1
"RTN","PSOUTL",70,0)
 S ^PSRX(DA(1),"A",0)="^52.3DA^"_CNT_"^"_CNT,^PSRX(DA(1),"A",CNT,0)=%_"^D^"_DUZ_"^"_DA_"^"
"RTN","PSOUTL",71,0)
 I '$D(PSOXX) S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_"Refill "
"RTN","PSOUTL",72,0)
 ;if PSOXX not exist, = refill. otherwise, it is a partial.
"RTN","PSOUTL",73,0)
 S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_$S($G(RESK):"returned to stock.",$G(PSOPSDAL):"deleted during Controlled Subs release.",$G(PSOXX)=1:"Partial deleted from suspense file.",1:"deleted during Rx edit.") K CNT,SUB
"RTN","PSOUTL",74,0)
 Q
"RTN","PSOUTL",75,0)
CID ;calculates six months limit on issue dates
"RTN","PSOUTL",76,0)
 S PSID=X,X="T-6M",%DT="X" D ^%DT S %DT(0)=Y,X=PSID,%DT="EX" D ^%DT K PSID
"RTN","PSOUTL",77,0)
 Q
"RTN","PSOUTL",78,0)
CIDH S X="T-6M",%DT="X" D ^%DT X ^DD("DD") D EN^DDIOL("Issue Date must be greater or equal to "_Y,"","!")
"RTN","PSOUTL",79,0)
 Q
"RTN","PSOUTL",80,0)
SPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",81,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",82,0)
SREF I $G(NODE) S NODE=NODE-1 G:'$D(^PSRX(DA(1),1,NODE,0)) SREF
"RTN","PSOUTL",83,0)
 I NODE=0 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",84,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) Q
"RTN","PSOUTL",85,0)
 K NODE,RF
"RTN","PSOUTL",86,0)
 Q
"RTN","PSOUTL",87,0)
KPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",88,0)
 I NODE=DA&(X'="") S NODE=NODE-1 S:NODE=1 NODE=0 G:'NODE ORIG G:NODE>1 KREF
"RTN","PSOUTL",89,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",90,0)
KREF S NODE=NODE-1 G:'NODE EX
"RTN","PSOUTL",91,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",92,0)
 G:NODE=DA&(X'="") KREF G:'$D(^PSRX(DA(1),1,NODE,0)) KREF
"RTN","PSOUTL",93,0)
ORIG I 'NODE S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",94,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) G EX
"RTN","PSOUTL",95,0)
EX K NODE,RF
"RTN","PSOUTL",96,0)
 Q
"RTN","PSOUTL",97,0)
IBSS N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOUTL",98,0)
 S PSOHLP(1)="Entry in this field must match the SERVICE field for pharmacy action"
"RTN","PSOUTL",99,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOUTL",100,0)
 S PSOHLP(2)="types in the IB ACTION TYPE file AND be a valid entry in your"
"RTN","PSOUTL",101,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOUTL",102,0)
 S PSOHLP(3)="SERVICE/SECTION file to generate copay charges!"
"RTN","PSOUTL",103,0)
 S PSOHLP(4,"F")="!!"
"RTN","PSOUTL",104,0)
 D EN^DDIOL(.PSOHLP) K PSOHLP
"RTN","PSOUTL",105,0)
 Q
"RTN","PSOUTL",106,0)
IBSSR N PSOIBFL,PSOIBLP,PSOIBST S PSOIBFL=0
"RTN","PSOUTL",107,0)
 F PSOIBLP=0:0 S PSOIBLP=$O(^DIC(49,PSOIBLP)) Q:'PSOIBLP!(PSOIBFL)  S Y=PSOIBLP,PSOIBST=$$SERV^IBARX1(+Y) I $G(PSOIBST) S DIE="^PS(59,",DA=PSOSITE,DR="1003////"_PSOIBLP D ^DIE K DIE D  S PSOIBFL=1
"RTN","PSOUTL",108,0)
 .W $C(7),!!,"There was an invalid entry in your IB SERVICE/SECTION field in your Outpatient",!,"Site Parameter file, but we have fixed the problem for you, and you",!,"may continue!" Q
"RTN","PSOUTL",109,0)
 Q
"RTN","PSOUTL",110,0)
WARN ;
"RTN","PSOUTL",111,0)
 I $G(PSOUNHLD) D  Q
"RTN","PSOUTL",112,0)
 .D EN^DDIOL("You cannot delete a refill while removing from Hold! Use the Edit Action.","","$C(7),!!"),EN^DDIOL(" ","","!!")
"RTN","PSOUTL",113,0)
 I $G(CMOP(DA))]""&(+$G(CMOP(DA))<3) D  K CMOP Q
"RTN","PSOUTL",114,0)
 .D EN^DDIOL("You cannot delete a refill that"_$S(+$G(CMOP(DA))=1:" has been released by",1:" is being transmitted to")_" the CMOP","","!!")
"RTN","PSOUTL",115,0)
 .D EN^DDIOL(" ","","!!")
"RTN","PSOUTL",116,0)
 K CMOP
"RTN","PSOUTL",117,0)
 ;
"RTN","PSOUTL",118,0)
 N PSOL,PSR
"RTN","PSOUTL",119,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),1,PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTL",120,0)
 I DA=PSOL,$P(^PSRX(DA(1),1,DA,0),"^",18) D  Q
"RTN","PSOUTL",121,0)
 .D EN^DDIOL("Refill Released! Use the 'Return to Stock' option!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTL",122,0)
 ;
"RTN","PSOUTL",123,0)
 ;Only allow deletion if last refill      *259
"RTN","PSOUTL",124,0)
 I $O(^PSRX(DA(1),1,DA)) D  Q
"RTN","PSOUTL",125,0)
 .D EN^DDIOL("Only the last refill can be deleted.  Later refills must be deleted first.","","$C(7),!!")
"RTN","PSOUTL",126,0)
 .D EN^DDIOL("","","!!")
"RTN","PSOUTL",127,0)
 ;
"RTN","PSOUTL",128,0)
 ;Warn of In Process, Only delete if answered Yes         ;*259
"RTN","PSOUTL",129,0)
 I $$REFIP^PSOUTLA1(DA(1),DA,"R") D  I 'Y Q               ;reset $T
"RTN","PSOUTL",130,0)
 . D EN^DDIOL("** Refill has previously been sent to the External Dispense Machine","","!!,?2")
"RTN","PSOUTL",131,0)
 . D EN^DDIOL("** for filling and is still Pending Processing","","$C(7),!,?2")
"RTN","PSOUTL",132,0)
 . D EN^DDIOL("","","!")
"RTN","PSOUTL",133,0)
 . K DIR
"RTN","PSOUTL",134,0)
 . S DIR("A")="Do you want to continue? "
"RTN","PSOUTL",135,0)
 . S DIR("B")="Y"
"RTN","PSOUTL",136,0)
 . S DIR(0)="YA^^"
"RTN","PSOUTL",137,0)
 . S DIR("?")="Enter Y for Yes or N for No."
"RTN","PSOUTL",138,0)
 . D ^DIR
"RTN","PSOUTL",139,0)
 . K DIR
"RTN","PSOUTL",140,0)
 Q
"RTN","PSOUTL",141,0)
 ;
"RTN","PSOUTL",142,0)
WARN1 ;move to PSOUTLA1
"RTN","PSOUTL",143,0)
 D WARN1^PSOUTLA1
"RTN","PSOUTL",144,0)
 Q
"RTN","PSOUTL",145,0)
 ;
"RTN","PSOUTL",146,0)
CAN(PSOXRX) ;Clean up Rx when discontinued
"RTN","PSOUTL",147,0)
 N SUSD,IFN,RF,NODE,DA
"RTN","PSOUTL",148,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",149,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA S DIK="^PS(52.5,",SUSD=$P($G(^PS(52.5,DA,0)),"^",2) D ^DIK K DIK I $O(^PSRX(PSOXRX,1,0)) S DA=PSOXRX D REF^PSOCAN2
"RTN","PSOUTL",150,0)
 I $D(^PS(52.4,PSOXRX,0)) S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",151,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",152,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",153,0)
 Q
"RTN","PSOUTL",154,0)
ECAN(PSOXRX) ;Clean up Rx when expired
"RTN","PSOUTL",155,0)
 N DA
"RTN","PSOUTL",156,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",157,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA K DIK S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOUTL",158,0)
 I $D(^PS(52.4,PSOXRX,0)) K DIK S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",159,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",160,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE K DA,DR
"RTN","PSOUTL",161,0)
 Q
"RTN","PSOUTL",162,0)
CMOP ;CMOP("L")=LAST FILL... if it is orig Rx =0
"RTN","PSOUTL",163,0)
 ;CMOP(FILL #)=CMOP status from 52[TRAN=0,DISP=1,RETRAN=2,NOT DISP=3
"RTN","PSOUTL",164,0)
 ;If suspended CMOP("S")=CMOP suspense status Q,L,X,P,R
"RTN","PSOUTL",165,0)
 ;All returned variables can be killed by K CMOP
"RTN","PSOUTL",166,0)
 ;
"RTN","PSOUTL",167,0)
 S CRX=DA
"RTN","PSOUTL",168,0)
CMOP1 N X
"RTN","PSOUTL",169,0)
 S (CMOP("L"),X)=0  F  S X=$O(^PSRX(CRX,1,X)) Q:'X  S CMOP("L")=X
"RTN","PSOUTL",170,0)
 I $O(^PSRX(CRX,4,0)) F X=0:0 S X=$O(^PSRX(CRX,4,X)) Q:'X  D
"RTN","PSOUTL",171,0)
 .S CMOP($P($G(^PSRX(CRX,4,X,0)),"^",3))=$P($G(^(0)),"^",4)
"RTN","PSOUTL",172,0)
 S X=$O(^PS(52.5,"B",CRX,0)) I X]"" S CMOP("S")=$P($G(^PS(52.5,X,0)),"^",7)
"RTN","PSOUTL",173,0)
 K CRX,X
"RTN","PSOUTL",174,0)
 Q
"RTN","PSOUTL",175,0)
 ;
"RTN","PSOUTL",176,0)
CHKCMOP(RX,REA) ;Check if an RX is Transmitted/Retransmitted to CMOP and send alert mail
"RTN","PSOUTL",177,0)
 ;
"RTN","PSOUTL",178,0)
 ; Input:  RX - ien to file #52
"RTN","PSOUTL",179,0)
 ;        REA - reason DC's "A" = admission, "D" = death
"RTN","PSOUTL",180,0)
 ; Output: none
"RTN","PSOUTL",181,0)
 ;
"RTN","PSOUTL",182,0)
 N CMOP,PSOCMOP
"RTN","PSOUTL",183,0)
 S REA=$G(REA)
"RTN","PSOUTL",184,0)
 I $$TRANCMOP(RX),$G(PSOCMOP)]"" D MAILCMOP(RX,PSOCMOP,REA)
"RTN","PSOUTL",185,0)
 Q
"RTN","PSOUTL",186,0)
 ;
"RTN","PSOUTL",187,0)
TRANCMOP(RX) ;check if a fill is Transmitted or Retransmitted
"RTN","PSOUTL",188,0)
 ;
"RTN","PSOUTL",189,0)
 ; Input:          = RX number
"RTN","PSOUTL",190,0)
 ; Function output:= RX number if CMOP status is Trans or Retrans
"RTN","PSOUTL",191,0)
 ;                 = 0 if neither
"RTN","PSOUTL",192,0)
 ; Global parm out:= PSOCMOP = string from call to ^PSOCMOPA
"RTN","PSOUTL",193,0)
 ;
"RTN","PSOUTL",194,0)
 N DA,PSOTRANS
"RTN","PSOUTL",195,0)
 S DA=RX D ^PSOCMOPA
"RTN","PSOUTL",196,0)
 S PSOTRANS=$P($G(PSOCMOP),"^")
"RTN","PSOUTL",197,0)
 Q:PSOTRANS=0!(PSOTRANS=2) RX
"RTN","PSOUTL",198,0)
 Q 0
"RTN","PSOUTL",199,0)
 ;
"RTN","PSOUTL",200,0)
MAILCMOP(RX,STR,REA) ;Send mail message to mail group PSX EXTERNAL DISPENSE ALERTS
"RTN","PSOUTL",201,0)
 ;
"RTN","PSOUTL",202,0)
 ; Input:  RX  = ien of PSRX
"RTN","PSOUTL",203,0)
 ;         STR = CMOP STATUS # ^ TRANSMIT DATE (FM) ^ LAST FILL #
"RTN","PSOUTL",204,0)
 ;         REA = reason DC'd  "A" = admission, "D" = death
"RTN","PSOUTL",205,0)
 ; Output: none
"RTN","PSOUTL",206,0)
 ;
"RTN","PSOUTL",207,0)
 N CMDT,CMST,DFN,VADM,PSOTEXT,PSOIEN,PSOKEYN,XMY,XMDUZ,XMSUB,XMTEXT
"RTN","PSOUTL",208,0)
 N DIV,SSN,RXO,FILL,DRUG,DIVN,MAILGRP,NAME,PRV,RXSTS
"RTN","PSOUTL",209,0)
 S RXO=$$GET1^DIQ(52,RX,.01)
"RTN","PSOUTL",210,0)
 S CMDT=$P(STR,U,2)
"RTN","PSOUTL",211,0)
 S CMDT=$E(CMDT,4,5)_"/"_$E(CMDT,6,7)_"/"_$E(CMDT,2,3)
"RTN","PSOUTL",212,0)
 S FILL=$P(STR,U,3)
"RTN","PSOUTL",213,0)
 S CMST=$P(STR,U),CMST=$S(CMST=2:"RETRANSMITTED",1:"TRANSMITTED")
"RTN","PSOUTL",214,0)
 S DIV=$P(^PSRX(RX,2),"^",9),DIVN=$P($G(^PS(59,DIV,0)),"^")
"RTN","PSOUTL",215,0)
 S MAILGRP="PSX EXTERNAL DISPENSE ALERTS"
"RTN","PSOUTL",216,0)
 S XMY("G."_MAILGRP)=""
"RTN","PSOUTL",217,0)
 ;if no members & no member groups & no remote members, then send to
"RTN","PSOUTL",218,0)
 ; the default: PSXCMOPMGR key holders
"RTN","PSOUTL",219,0)
 S PSOIEN=$O(^XMB(3.8,"B",MAILGRP,0))
"RTN","PSOUTL",220,0)
 I '$O(^XMB(3.8,PSOIEN,1,0))&'$O(^XMB(3.8,PSOIEN,5,0))&'$O(^XMB(3.8,PSOIEN,6,0)) D
"RTN","PSOUTL",221,0)
 . S PSOKEYN=0
"RTN","PSOUTL",222,0)
 . F  S PSOKEYN=$O(^XUSEC("PSXCMOPMGR",PSOKEYN)) Q:'PSOKEYN  D
"RTN","PSOUTL",223,0)
 . . S XMY(PSOKEYN)=""
"RTN","PSOUTL",224,0)
 S DFN=$$GET1^DIQ(52,RX,2,"I") D DEM^VADPT
"RTN","PSOUTL",225,0)
 S NAME=VADM(1)
"RTN","PSOUTL",226,0)
 S SSN=$P($P(VADM(2),"^",2),"-",3)
"RTN","PSOUTL",227,0)
 S RXSTS=$$GET1^DIQ(52,RX,100)
"RTN","PSOUTL",228,0)
 S DRUG=$$GET1^DIQ(52,RX,6)
"RTN","PSOUTL",229,0)
 S PRV=$$GET1^DIQ(52,RX,4)
"RTN","PSOUTL",230,0)
 S XMDUZ=.5
"RTN","PSOUTL",231,0)
 S XMSUB=DIVN_" - DC Alert on CMOP Rx "_RXO_" "_CMST
"RTN","PSOUTL",232,0)
 S PSOTEXT(1)="             Rx #: "_RXO_"   Fill: "_FILL
"RTN","PSOUTL",233,0)
 S PSOTEXT(2)="          Patient: "_NAME_" ("_SSN_")"
"RTN","PSOUTL",234,0)
 S PSOTEXT(3)="             Drug: "_DRUG
"RTN","PSOUTL",235,0)
 S PSOTEXT(4)="        Rx Status: "_RXSTS
"RTN","PSOUTL",236,0)
 S:REA="A" PSOTEXT(4)=PSOTEXT(4)_" (due to Admission)"
"RTN","PSOUTL",237,0)
 S:REA="D" PSOTEXT(4)=PSOTEXT(4)_" (due to Date of Death)"
"RTN","PSOUTL",238,0)
 S PSOTEXT(5)="Processing Status: "_CMST_" to CMOP on "_CMDT
"RTN","PSOUTL",239,0)
 S PSOTEXT(6)="         Provider: "_PRV
"RTN","PSOUTL",240,0)
 S PSOTEXT(7)=""
"RTN","PSOUTL",241,0)
 S PSOTEXT(8)="********    Please contact CMOP or take appropriate action    ********"
"RTN","PSOUTL",242,0)
 S XMTEXT="PSOTEXT(" D ^XMD
"RTN","PSOUTL",243,0)
 D KVA^VADPT
"RTN","PSOUTL",244,0)
 Q
"RTN","PSOUTL",245,0)
 ;
"RTN","PSOUTL",246,0)
PSOCK ;
"RTN","PSOUTL",247,0)
 W !!!,"*The following list of order checks is a comprehensive report of all"
"RTN","PSOUTL",248,0)
 W !,"Outpatient, Non-VA, and Clinic medication orders on this patient's profile."
"RTN","PSOUTL",249,0)
 W !,"It may include orders that are local, remote, active, pending, recently"
"RTN","PSOUTL",250,0)
 W !,"discontinued, or expired. Please note that the sort order and format"
"RTN","PSOUTL",251,0)
 W !,"displayed in this report differs from the display of MOCHA 1.0 order"
"RTN","PSOUTL",252,0)
 W !,"checks which occurs during order processing.*",!
"RTN","PSOUTL",253,0)
 Q
"RTN","PSOUTL",254,0)
 ;
"RTN","PSOUTL",255,0)
PSSDGCK ;
"RTN","PSOUTL",256,0)
 D ^PSSDIUTL
"RTN","PSOUTL",257,0)
 Q
"RTN","PSOUTL",258,0)
 ;
"RTN","PSOUTL",259,0)
PSOSUPCK(CHK) ;
"RTN","PSOUTL",260,0)
 I $G(PSODGCKX) Q 0
"RTN","PSOUTL",261,0)
 I '($P($G(^PSDRUG(CHK,0)),"^",3)["S"!($E($P($G(^PSDRUG(CHK,0)),"^",2),1,2)="XA")) K CHK Q 0
"RTN","PSOUTL",262,0)
 W !!,"You have selected a supply item, please select another drug"
"RTN","PSOUTL",263,0)
 W !,"or leave blank and hit enter for Profile Order Checks." W !
"RTN","PSOUTL",264,0)
 K CHK
"RTN","PSOUTL",265,0)
 Q 1
"RTN","PSOUTL",266,0)
 ;
"RTN","PSOUTL",267,0)
PRFLP ;
"RTN","PSOUTL",268,0)
 N PSODRUG,PSODGCRX,PSOALLGY,PSODRIEN,PSODATA S (DGCKSTA,DGCKDNM)="" S PSODGCKF=1
"RTN","PSOUTL",269,0)
 I $D(PSOSD) D
"RTN","PSOUTL",270,0)
 .F  S DGCKSTA=$O(PSOSD(DGCKSTA)) Q:DGCKSTA=""  F  S DGCKDNM=$O(PSOSD(DGCKSTA,DGCKDNM)) Q:DGCKDNM=""  D
"RTN","PSOUTL",271,0)
 ..S DIC=50,DIC(0)="MQZV",X=DGCKDNM D ^DIC K DIC
"RTN","PSOUTL",272,0)
 ..S DIC=50,DIC(0)="MQZV",X=+Y D ^DIC K DIC Q:Y=-1
"RTN","PSOUTL",273,0)
 ..S PSODRUG("IEN")=$P(Y,"^"),PSODRUG("VA CLASS")=$P(Y(0),"^",2),PSODRUG("NAME")=$P(Y(0),"^")
"RTN","PSOUTL",274,0)
 ..I '$D(PSOALLGY(DGCKDNM,PSODRUG("IEN"))) S PSOALLGY(DGCKDNM,PSODRUG("IEN"))=PSODRUG("VA CLASS")_"^"_PSODRUG("NAME")_"^"_$P(PSOSD(DGCKSTA,DGCKDNM),"^")
"RTN","PSOUTL",275,0)
 .S (DGCKDNM,PSODRIEN)=""
"RTN","PSOUTL",276,0)
 .F  S DGCKDNM=$O(PSOALLGY(DGCKDNM)) Q:DGCKDNM=""  F  S PSODRIEN=$O(PSOALLGY(DGCKDNM,PSODRIEN)) Q:PSODRIEN=""  D
"RTN","PSOUTL",277,0)
 ..S PSODRUG("IEN")=PSODRIEN,PSODATA="",PSODATA=PSOALLGY(DGCKDNM,PSODRIEN)
"RTN","PSOUTL",278,0)
 ..S PSODRUG("VA CLASS")=$P(PSODATA,"^"),PSODRUG("NAME")=$P(PSODATA,"^",2)
"RTN","PSOUTL",279,0)
 ..S:+$G(^PSDRUG(PSODRUG("IEN"),2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSOUTL",280,0)
 ..S PSODRUG("NDF")=$S($G(^PSDRUG(PSODRUG("IEN"),"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOUTL",281,0)
 ..S PSODFN=DFN S PSODGCRX=$P(PSODATA,"^",3)
"RTN","PSOUTL",282,0)
 ..D ^PSODGAL1
"RTN","PSOUTL",283,0)
 ..K X,Y,DTOUT,DUOUT
"RTN","PSOUTL",284,0)
 K DGCKSTA,DGCKDNM,PSODGCKF,X,Y,DTOUT,DUOUT
"RTN","PSOUTL",285,0)
 Q
"RTN","PSOUTL",286,0)
 ;
"RTN","PSOUTL",287,0)
TITRX(RX) ; Returns the titration/maintenance flags
"RTN","PSOUTL",288,0)
 ;
"RTN","PSOUTL",289,0)
 I '$G(RX) Q ""
"RTN","PSOUTL",290,0)
 I '$D(^PSRX(RX,0)) Q ""
"RTN","PSOUTL",291,0)
 I $$GET1^DIQ(52,RX,45.1,"I") Q "m"
"RTN","PSOUTL",292,0)
 I $$GET1^DIQ(52,RX,45.2,"I")!$$GET1^DIQ(52,RX,45.3,"I") Q "t"
"RTN","PSOUTL",293,0)
 Q ""
"RTN","PSOUTL",294,0)
 ;
"RTN","PSOUTL",295,0)
LTHEN(RX) ; Looks for a THEN anywhere in the Complex Order.
"RTN","PSOUTL",296,0)
 ; Returns: 1 if found and 0 if not found.  Complex Order must contain at least one THEN conjunction
"RTN","PSOUTL",297,0)
 ; in order to mark it as a Titration Rx.
"RTN","PSOUTL",298,0)
 N PSOCOUNT,PSOTHEN,FNDTHEN
"RTN","PSOUTL",299,0)
 S (PSOCOUNT,PSOTHEN,FNDTHEN)=""
"RTN","PSOUTL",300,0)
 F  S PSOCOUNT=$O(^PSRX(RX,6,PSOCOUNT)) Q:PSOCOUNT=""!(FNDTHEN'="")  D
"RTN","PSOUTL",301,0)
 . S PSOTHEN=$P($G(^PSRX(RX,6,PSOCOUNT,0)),"^",6)
"RTN","PSOUTL",302,0)
 . I PSOTHEN="T" S FNDTHEN=1 Q
"RTN","PSOUTL",303,0)
 I $G(FNDTHEN)="" Q 0
"RTN","PSOUTL",304,0)
 Q 1
"RTN","PSOVER1")
0^22^B126108249
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207,148,243,268,281,324,358,251,375,387,379,390,372,416,411**;DEC 1997;Build 95
"RTN","PSOVER1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to DOSE^PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSOVER1",10,0)
 ;External reference to $$GETNDC^PSSNDCUT supported by DBIA 4707
"RTN","PSOVER1",11,0)
 ;External reference to ^DPT( supported by DBIA 3097
"RTN","PSOVER1",12,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOVER1",13,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOVER1",14,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOVER1",15,0)
REDO ;
"RTN","PSOVER1",16,0)
 I '$G(PSOCLK) Q:$G(PSVERFLG)
"RTN","PSOVER1",17,0)
 S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",18,0)
 S PSOVQUIT=0,PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",19,0)
 S PSOY(0)=^PSDRUG(PSODRUG("IEN"),0),PSOY=PSODRUG("IEN")_"^"_$P(PSOY(0),"^")
"RTN","PSOVER1",20,0)
 D SET^PSODRG
"RTN","PSOVER1",21,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",22,0)
 ;
"RTN","PSOVER1",23,0)
EDIT ;
"RTN","PSOVER1",24,0)
 N PSDNEW,PSDOLD
"RTN","PSOVER1",25,0)
 S (PSDNEW,PSDOLD)="",PSDOLD=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV
"RTN","PSOVER1",26,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",27,0)
 I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",28,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to proceed with verification and order checks."
"RTN","PSOVER1",29,0)
 D ^DIR K DIR W ! I $G(DIRUT)!($G(DTOUT)) S PSOVBCK=1 G OUT
"RTN","PSOVER1",30,0)
 ;PSOPOCK=1 called from Process Order Check option; PSOCLK=1 means initiated from Rx verify by clerk.
"RTN","PSOVER1",31,0)
 I Y="Y",($G(PSOCLK)!($G(PSOPOCK))) D FULLEDT S VALMBCK="R" G KILL:$$CHECK(PSONV) G EDIT
"RTN","PSOVER1",32,0)
 I Y="Y",$G(PSOACT)]"" S VALMBCK="R",PSVERFLG=1 G OUT  ;this pops the user back to the med profile screen when verify is called from Patient Prescription Processing
"RTN","PSOVER1",33,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",34,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",35,0)
 G ORDCHK:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",36,0)
 ;
"RTN","PSOVER1",37,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",38,0)
 K PSD(PSDOLD) S PSDNEW="",PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",39,0)
 ;
"RTN","PSOVER1",40,0)
 S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) D ^PSORXPR G OUT:$G(DIRUT)
"RTN","PSOVER1",41,0)
 G OUT:$D(DIRUT)!($D(DTOUT))
"RTN","PSOVER1",42,0)
 I '$G(PSOCLK) S DA=$S($D(PSORXED("IRXN")):PSORXED("IRXN"),1:PSONV) W !,"CHANGE",! D ^PSORXPR G OUT:$D(DIRUT)!($D(DTOUT)) G EDIT
"RTN","PSOVER1",43,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",44,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",45,0)
 W !!,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"")
"RTN","PSOVER1",46,0)
 D HD^PSODDPR2() D ^PSODSPL D SHOW2^PSOVER G EDIT Q
"RTN","PSOVER1",47,0)
 ;
"RTN","PSOVER1",48,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",49,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(52.4,DA,0),"^",7)=X K X1,X2 Q
"RTN","PSOVER1",50,0)
 ;
"RTN","PSOVER1",51,0)
ORDCHK ;
"RTN","PSOVER1",52,0)
 S PSOVER1=1
"RTN","PSOVER1",53,0)
 S RX0=^PSRX(PSONV,0)
"RTN","PSOVER1",54,0)
 D ORDCK
"RTN","PSOVER1",55,0)
 I $G(PSOQUIT) S:$G(PSOCLK) PSOQUIT=0 S:'$G(PSOCLK) PSORX("DFLG")=1  ;if verify by clerk continue on with the next Rx; if not exit
"RTN","PSOVER1",56,0)
 I $G(PSOVQUIT)!$G(PSORX("DFLG")) G OUT
"RTN","PSOVER1",57,0)
 ;------
"RTN","PSOVER1",58,0)
VERIFY ;
"RTN","PSOVER1",59,0)
 D FULL^VALM1 G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",60,0)
 W !,$P(^DPT(DFN,0),"^"),?40,"ID#:"_VA("PID") W:$D(INT)!$D(PSONV) "  RX#: "_$S($D(INT):$P(INT,"^"),$D(^PSRX(PSONV)):$P(^PSRX(PSONV,0),"^"),1:"") W:$D(PSODRUG("NAME")) !,PSODRUG("NAME"),!
"RTN","PSOVER1",61,0)
 I $G(PSONAM)="" S PSONAM=$P(^DPT(PSDFN,0),"^")
"RTN","PSOVER1",62,0)
 S DIR("A")="VERIFY FOR "_PSONAM_"? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",63,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",64,0)
 D ^DIR K DIR
"RTN","PSOVER1",65,0)
 I Y="N"!("Q^"[$E(Y)) D  G OUT
"RTN","PSOVER1",66,0)
 .S (PSVERFLG,PSOVBCK)=1,PSORX("DFLG")=1
"RTN","PSOVER1",67,0)
 .S:$D(PSOOVNOD) ^PS(52.4,PSONV,0)=PSOOVNOD S:$G(PSOOVSTA) $P(^PSRX(PSONV,"STA"),"^")=PSOOVSTA
"RTN","PSOVER1",68,0)
 .S:PSOOVSTA=4 ^PS(52.4,"ADI",PSONV,1)=""
"RTN","PSOVER1",69,0)
 G DELETE:Y="D"
"RTN","PSOVER1",70,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",71,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",72,0)
 K ^PSRX(PSONV,"DRI"),SPFL1
"RTN","PSOVER1",73,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",74,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",75,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",76,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",77,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",78,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",79,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",80,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",81,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",82,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",83,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",84,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",85,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",86,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",87,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",88,0)
 I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) D  G KILL
"RTN","PSOVER1",89,0)
 .S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^PSRX(DA,2),"^",2),RXF=0
"RTN","PSOVER1",90,0)
 .D UPSUS S PSTRIVER=1 D SUS^PSORXL
"RTN","PSOVER1",91,0)
 .K PSORX("FILL DATE"),PSTRIVER
"RTN","PSOVER1",92,0)
 .I $D(^TMP("PSODAOC",$J)) D ^PSONEWOC K ^TMP("PSODAOC",$J)
"RTN","PSOVER1",93,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,DRG=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^")
"RTN","PSOVER1",94,0)
 S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",95,0)
 I $D(^TMP("PSODAOC",$J)) D ^PSONEWOC K ^TMP("PSODAOC",$J)
"RTN","PSOVER1",96,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",97,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","") ;S VALMBCK=""
"RTN","PSOVER1",98,0)
 ;
"RTN","PSOVER1",99,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSOVER1",100,0)
 N ACTION
"RTN","PSOVER1",101,0)
 I $$SUBMIT^PSOBPSUT(PSONV) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSOVER1",102,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSONV,,,$S($O(^PSRX(PSONV,1,0)):"RF",1:"OF"))
"RTN","PSOVER1",103,0)
 . ; Quit if there is an unresolved Tricare non-billable reject code, PSO*7*358
"RTN","PSOVER1",104,0)
 . I $$PSOET^PSOREJP3(PSONV) S ACTION="Q" Q
"RTN","PSOVER1",105,0)
 . I $$FIND^PSOREJUT(PSONV) D
"RTN","PSOVER1",106,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSONV,0,"79,88","OF","IOQ","Q")
"RTN","PSOVER1",107,0)
 ;
"RTN","PSOVER1",108,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",109,0)
OUT ;
"RTN","PSOVER1",110,0)
 K PSOVER1
"RTN","PSOVER1",111,0)
 I '$G(PSOCLK) S:$G(DIRUT)!($G(DTOUT)) PSORX("DFLG")=1 K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN S VALMBCK="Q" Q
"RTN","PSOVER1",112,0)
 I $G(PSOCLK) S PSORX("DFLG")=0 K UPFLAGX D CLEAN Q
"RTN","PSOVER1",113,0)
DELETE K UPFLAGX,PSOVER1 D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",114,0)
QUIT S PSOQUIT="" D CLEAN K PSOVER1 Q
"RTN","PSOVER1",115,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",116,0)
 Q
"RTN","PSOVER1",117,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",118,0)
 I $G(PSODOSEX) K PSODOSEX Q
"RTN","PSOVER1",119,0)
 N PSOWRITE
"RTN","PSOVER1",120,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",121,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",122,0)
 .I $P(^TMP("PSORXDC",$J,RORD,0),"^")="P" D  Q
"RTN","PSOVER1",123,0)
 ..S PSOR=^PS(52.41,RORD,0)
"RTN","PSOVER1",124,0)
 ..S DNM=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSOVER1",125,0)
 ..W $C(7),!," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Pending Order "_DNM_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",126,0)
 .W !," Duplicate "_$S($P(^TMP("PSORXDC",$J,RORD,0),"^",10):"Therapy",1:"Drug")_" Rx #"_$P(^PSRX(RORD,0),"^")_" "_$P(^TMP("PSORXDC",$J,RORD,0),"^",7)_" NOT Discontinued." S PSOWRITE=1
"RTN","PSOVER1",127,0)
 I $G(PSOWRITE)&('$G(PSOWRIT)) W ! K DIR S DIR(0)="E",DIR("?")="Press Return to continue",DIR("A")="Press Return to Continue" D ^DIR S:($D(DTOUT))!($D(DUOUT)) PSODLQT=1,PSORX("DFLG")=1 K DIR,X,Y I ($Y+5)>IOSL W @IOF
"RTN","PSOVER1",128,0)
 K ^TMP("PSORXDC",$J),RORD,PRNXZ,ORNZZ,PSOR
"RTN","PSOVER1",129,0)
 Q
"RTN","PSOVER1",130,0)
KV1 ;
"RTN","PSOVER1",131,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",132,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",133,0)
 Q
"RTN","PSOVER1",134,0)
NVA ;
"RTN","PSOVER1",135,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",136,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",137,0)
 S (Y,FLG)=""
"RTN","PSOVER1",138,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",139,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",140,0)
 Q
"RTN","PSOVER1",141,0)
REMOTE ; 
"RTN","PSOVER1",142,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",143,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",144,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",145,0)
 .D HD^PSODDPR2():(($Y+5)'>IOSL)
"RTN","PSOVER1",146,0)
 .I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSOVER1",147,0)
 ..I $T(REMOTE^PSORX1)]"" Q
"RTN","PSOVER1",148,0)
 ..W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",149,0)
 .W !!,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",150,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",151,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !!,"Remote data not available - Only local order checks processed.",! D HD^PSODDPR2():(($Y+5)>IOSL) ;D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",152,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",153,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",154,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",155,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",156,0)
 Q
"RTN","PSOVER1",157,0)
NOALRGY ;
"RTN","PSOVER1",158,0)
 N PSODFN,PSODRUG
"RTN","PSOVER1",159,0)
 S PSODFN=$P(^PSRX(PSONV,0),"^",2),PSODRUG("IEN")=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",160,0)
 D NOALRGY^PSODRG
"RTN","PSOVER1",161,0)
 Q
"RTN","PSOVER1",162,0)
 ;
"RTN","PSOVER1",163,0)
ORDCK ;
"RTN","PSOVER1",164,0)
 N ORN,ORNZZ,PSOLST,Y,PSOODFN S ORN=PSONV,PSOLST(PSONV)=PSONV_"^"_PSONV,PSOVORD=1
"RTN","PSOVER1",165,0)
 N DRG,ON,CT,DRGI,PDRG,SEV,STX,INT,CLI,PSONULN,PSONULN1,LST,LSI,DGI,SER,SERS,DUPT,SV
"RTN","PSOVER1",166,0)
 S ORNZZ=ORN,PRNXZ(ORN)=PSOLST(ORN),PSORENW("OIRXN")=PSONV,PSOODFN=DFN
"RTN","PSOVER1",167,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",168,0)
 D SHOW^PSOVER D HD^PSODDPR2():(($Y+5)>IOSL)
"RTN","PSOVER1",169,0)
 S (PSODRUG("IEN"),PSDRUG("IEN"))=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",170,0)
 N PSOVINF S PSOVINF=^PSDRUG(PSDRUG("IEN"),0),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",171,0)
 S PSODRUG("VA CLASS")=$P(PSOVINF,"^",2),(DRG,PSODRUG("NAME"))=$P(^PSDRUG(PSDRUG("IEN"),0),"^")
"RTN","PSOVER1",172,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(PSDRUG("IEN"),"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOVER1",173,0)
 S PSODRUG("MAXDOSE")=$P(PSOVINF,"^",4),PSODRUG("DEA")=$P(PSOVINF,"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(PSDRUG("IEN"),"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOVER1",174,0)
 S PSODRUG("SIG")=$P(PSOVINF,"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(PSDRUG("IEN"),$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(PSDRUG("IEN"),660.1))
"RTN","PSOVER1",175,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,PSONV,81)
"RTN","PSOVER1",176,0)
 K PSOVINF
"RTN","PSOVER1",177,0)
 D POST^PSODRG S DFN=PSOODFN
"RTN","PSOVER1",178,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",179,0)
 I $G(PSVERFLG),$G(PSOCLK) S PSVERFLG=0
"RTN","PSOVER1",180,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",181,0)
 Q:PSORX("DFLG")!($G(PSOQUIT))
"RTN","PSOVER1",182,0)
 D:'$G(PSORX("DFLG")) DOSCK^PSODOSUT("V")
"RTN","PSOVER1",183,0)
 I $$GET1^DIQ(52,PSONV,100,"I")=13 S PSORX("DFLG")=1 Q
"RTN","PSOVER1",184,0)
 I $G(PSOCLK),$G(PSORX("DFLG")) S PSOVQUIT=1 K PSORX("DFLG"),DIRUT,DTOUT Q
"RTN","PSOVER1",185,0)
 Q:PSORX("DFLG")
"RTN","PSOVER1",186,0)
 S PSOLST(ORNZZ)=PRNXZ(ORNZZ),ORN=ORNZZ K PSORENW("OIRXN")
"RTN","PSOVER1",187,0)
 Q
"RTN","PSOVER1",188,0)
 ;
"RTN","PSOVER1",189,0)
FULLEDT  ;
"RTN","PSOVER1",190,0)
 D FULL^VALM1
"RTN","PSOVER1",191,0)
 N RX,FILL,OPSOLST,OPSLST,OLDDA,PSODRUG,REJ
"RTN","PSOVER1",192,0)
 S (RX,PSORXED("IRXN"))=PSONV
"RTN","PSOVER1",193,0)
 M OPSOLST=PSOLST,OPSLST=PSLST,ODA=DA
"RTN","PSOVER1",194,0)
 N PSOSITE,ORN,PSOPAR,PSOLIST,PSOSD
"RTN","PSOVER1",195,0)
 S PSOSITE=$$RXSITE^PSOBPSUT(RX,""),ORN=RX
"RTN","PSOVER1",196,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PSOLIST(1)=ORN_","
"RTN","PSOVER1",197,0)
 D EPH^PSORXEDT
"RTN","PSOVER1",198,0)
 M PSOLST=OPSOLST,PSLST=OPSLST S VALMBCK="R" S:$D(OLDDA) DA=OLDDA
"RTN","PSOVER1",199,0)
 Q
"RTN","PSOVER1",200,0)
 ;
"RTN","PSOVER1",201,0)
DRIDOSE(DA,RX0) ;where DA is RXIEN and RX0 is zero node of file 52 for the RXIEN
"RTN","PSOVER1",202,0)
 N T,RXN,RXX,SCRIPT,SEV,X,SER,PSOSERV,PSOSCPT,PSODOSF,RX
"RTN","PSOVER1",203,0)
 S RX=RX0
"RTN","PSOVER1",204,0)
 S RXN=$P(RX0,"^")
"RTN","PSOVER1",205,0)
 I $D(^PS(52.4,RX,0))!($D(^PSRX(RX,"DRI"))) D
"RTN","PSOVER1",206,0)
 . Q:'$P($G(^PS(52.4,RX,0)),"^",8)&('$D(^PSRX(RX,"DRI")))
"RTN","PSOVER1",207,0)
 .W !!,"*** During order, there were DRUG-DRUG INTERACTION for the following RX(s):"
"RTN","PSOVER1",208,0)
 I $P($G(^PS(52.4,RX,0)),"^",8) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",209,0)
 . S SER=$P(^PS(56,SEV(X),0),"^",4) S:$G(SER)=1 PSOSERV=1
"RTN","PSOVER1",210,0)
 . S PSOSCPT(RXX(X))="     "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION    "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",211,0)
 I $D(^PSRX(RX,"DRI")) S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOVER1",212,0)
 .S SER=$P(^PS(56,SEV(X),0),"^",4)
"RTN","PSOVER1",213,0)
 .S PSOSCPT(RXX(X))="     "_$P($G(^PSRX(RXX(X),0)),"^")_"  "_$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")_" INTERACTION  "_$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOVER1",214,0)
 S SCRIPT="" F  S SCRIPT=$O(PSOSCPT(SCRIPT)) Q:SCRIPT=""  W !,PSOSCPT(SCRIPT)
"RTN","PSOVER1",215,0)
 I $$DS^PSSDSAPI,$D(^PS(52.4,RX,1)) S T=$P(^PS(52.4,RX,1),"^") D  W:PSODOSF'="" !,"*** Dose Warning: ",PSODOSF
"RTN","PSOVER1",216,0)
 . S PSODOSF="",PSODOSF=$S(T=4:"DOSAGE EXCEEDS MAX SINGLE DOSE",T=3:"MAX SINGLE DOSE & DAILY DOSE RANGE",T=2:"MAX SINGLE DOSE",T=1:"DAILY DOSE RANGE",1:"")
"RTN","PSOVER1",217,0)
 W !
"RTN","PSOVER1",218,0)
 Q
"RTN","PSOVER1",219,0)
CHECK(PSONV) ;
"RTN","PSOVER1",220,0)
 N PSOSTAT S PSOSTAT=$$GET1^DIQ(52,PSONV,100,"I")
"RTN","PSOVER1",221,0)
 I ",11,12,13,14,15,"[(","_PSOSTAT_",") Q 1
"RTN","PSOVER1",222,0)
 Q 0
"VER")
8.0^22.0
**END**
**END**

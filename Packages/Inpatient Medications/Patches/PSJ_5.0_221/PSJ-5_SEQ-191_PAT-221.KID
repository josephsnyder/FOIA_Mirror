Released PSJ*5*221 SEQ #191
Extracted from mail message
**KIDS**:PSJ*5.0*221^

**INSTALL NAME**
PSJ*5.0*221
"BLD",8065,0)
PSJ*5.0*221^INPATIENT MEDICATIONS^0^3090427^y
"BLD",8065,1,0)
^^8^8^3090423^^
"BLD",8065,1,1,0)
This is part 2 of the Frequency correction. This patch will re-enable 
"BLD",8065,1,2,0)
PSJU LM SPEED FINISH and PSJU LM SPEED VERIFY.
"BLD",8065,1,3,0)
and correct the following tickets.
"BLD",8065,1,4,0)
 PSPO# 1221 HD297810 - 1 Orders did not show in BCMA.
"BLD",8065,1,5,0)
 d - HD289777 - 4    Q14 coming up to be given every 2 days for one order
"BLD",8065,1,6,0)
 d - HD289086 - 6 BCMA -Order Problem  Schedule Frequency Issue
"BLD",8065,1,7,0)
 PSPO# 1274 HD302185 - 1 Possible patient safety issue with med order
"BLD",8065,1,8,0)
 PSPO# 1278 HD302727 - 1 Bar Code Med Admin issue - Admin Times
"BLD",8065,4,0)
^9.64PA^^
"BLD",8065,6.3)
11
"BLD",8065,"ABPKG")
n
"BLD",8065,"INID")
^n
"BLD",8065,"INIT")
QUE^PSJSFRQ
"BLD",8065,"KRN",0)
^9.67PA^779.2^20
"BLD",8065,"KRN",.4,0)
.4
"BLD",8065,"KRN",.401,0)
.401
"BLD",8065,"KRN",.402,0)
.402
"BLD",8065,"KRN",.403,0)
.403
"BLD",8065,"KRN",.5,0)
.5
"BLD",8065,"KRN",.84,0)
.84
"BLD",8065,"KRN",3.6,0)
3.6
"BLD",8065,"KRN",3.8,0)
3.8
"BLD",8065,"KRN",9.2,0)
9.2
"BLD",8065,"KRN",9.8,0)
9.8
"BLD",8065,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",8065,"KRN",9.8,"NM",1,0)
PSGOESF^^0^B27646476
"BLD",8065,"KRN",9.8,"NM",2,0)
PSJSFRQ^^0^B60315510
"BLD",8065,"KRN",9.8,"NM","B","PSGOESF",1)

"BLD",8065,"KRN",9.8,"NM","B","PSJSFRQ",2)

"BLD",8065,"KRN",19,0)
19
"BLD",8065,"KRN",19.1,0)
19.1
"BLD",8065,"KRN",101,0)
101
"BLD",8065,"KRN",101,"NM",0)
^9.68A^2^2
"BLD",8065,"KRN",101,"NM",1,0)
PSJU LM SPEED FINISH^^0
"BLD",8065,"KRN",101,"NM",2,0)
PSJU LM SPEED VERIFY^^0
"BLD",8065,"KRN",101,"NM","B","PSJU LM SPEED FINISH",1)

"BLD",8065,"KRN",101,"NM","B","PSJU LM SPEED VERIFY",2)

"BLD",8065,"KRN",409.61,0)
409.61
"BLD",8065,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",8065,"KRN",771,0)
771
"BLD",8065,"KRN",779.2,0)
779.2
"BLD",8065,"KRN",870,0)
870
"BLD",8065,"KRN",8989.51,0)
8989.51
"BLD",8065,"KRN",8989.52,0)
8989.52
"BLD",8065,"KRN",8994,0)
8994
"BLD",8065,"KRN","B",.4,.4)

"BLD",8065,"KRN","B",.401,.401)

"BLD",8065,"KRN","B",.402,.402)

"BLD",8065,"KRN","B",.403,.403)

"BLD",8065,"KRN","B",.5,.5)

"BLD",8065,"KRN","B",.84,.84)

"BLD",8065,"KRN","B",3.6,3.6)

"BLD",8065,"KRN","B",3.8,3.8)

"BLD",8065,"KRN","B",9.2,9.2)

"BLD",8065,"KRN","B",9.8,9.8)

"BLD",8065,"KRN","B",19,19)

"BLD",8065,"KRN","B",19.1,19.1)

"BLD",8065,"KRN","B",101,101)

"BLD",8065,"KRN","B",409.61,409.61)

"BLD",8065,"KRN","B",771,771)

"BLD",8065,"KRN","B",779.2,779.2)

"BLD",8065,"KRN","B",870,870)

"BLD",8065,"KRN","B",8989.51,8989.51)

"BLD",8065,"KRN","B",8989.52,8989.52)

"BLD",8065,"KRN","B",8994,8994)

"BLD",8065,"QUES",0)
^9.62^^
"BLD",8065,"REQB",0)
^9.611^1^1
"BLD",8065,"REQB",1,0)
PSJ*5.0*133^2
"BLD",8065,"REQB","B","PSJ*5.0*133",1)

"INIT")
QUE^PSJSFRQ
"KRN",101,4962,-1)
0^1
"KRN",101,4962,0)
PSJU LM SPEED FINISH^Speed Finish^^A^^^^^^^^INPATIENT MEDICATIONS
"KRN",101,4962,1,0)
^101.06^2^2^3090326^^^^
"KRN",101,4962,1,1,0)
This protocol will allow a user to finish multiple orders for a patient
"KRN",101,4962,1,2,0)
which are in a pending renewal status without all the usual prompts.
"KRN",101,4962,15)
D RESTORE^PSJHVARS S VALMBCK="Q"
"KRN",101,4962,20)
D ^PSJHVARS D EN^PSGOESF
"KRN",101,4962,99)
61474,45286
"KRN",101,4991,-1)
0^2
"KRN",101,4991,0)
PSJU LM SPEED VERIFY^Speed Verify^^A^^^^^^^^INPATIENT MEDICATIONS
"KRN",101,4991,1,0)
^101.06^2^2^3090326^^^^
"KRN",101,4991,1,1,0)
This protocol will allow a user to verify multiple orders for a patient.
"KRN",101,4991,1,2,0)
It will only speed verify orders that were created because of a renew.
"KRN",101,4991,2,0)
^101.02A^^0
"KRN",101,4991,4)
^^^
"KRN",101,4991,10,0)
^101.01PA^1^1
"KRN",101,4991,15)
D RESTORE^PSJHVARS S VALMBCK="Q"
"KRN",101,4991,20)
D ^PSJHVARS D EN^PSGOEVS
"KRN",101,4991,99)
61474,45286
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",203,-1)
1^1
"PKG",203,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",203,20,0)
^9.402P^^
"PKG",203,22,0)
^9.49I^1^1
"PKG",203,22,1,0)
5.0^2971215^2980417^1271
"PKG",203,22,1,"PAH",1,0)
221^3090427^33288
"PKG",203,22,1,"PAH",1,1,0)
^^8^8^3090427
"PKG",203,22,1,"PAH",1,1,1,0)
This is part 2 of the Frequency correction. This patch will re-enable 
"PKG",203,22,1,"PAH",1,1,2,0)
PSJU LM SPEED FINISH and PSJU LM SPEED VERIFY.
"PKG",203,22,1,"PAH",1,1,3,0)
and correct the following tickets.
"PKG",203,22,1,"PAH",1,1,4,0)
 PSPO# 1221 HD297810 - 1 Orders did not show in BCMA.
"PKG",203,22,1,"PAH",1,1,5,0)
 d - HD289777 - 4    Q14 coming up to be given every 2 days for one order
"PKG",203,22,1,"PAH",1,1,6,0)
 d - HD289086 - 6 BCMA -Order Problem  Schedule Frequency Issue
"PKG",203,22,1,"PAH",1,1,7,0)
 PSPO# 1274 HD302185 - 1 Possible patient safety issue with med order
"PKG",203,22,1,"PAH",1,1,8,0)
 PSPO# 1278 HD302727 - 1 Bar Code Med Admin issue - Admin Times
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSGOESF")
0^1^B27646476^B25954410
"RTN","PSGOESF",1,0)
PSGOESF ;BIR/MLM-SPEED FINISH ORDERS ENTERED THROUGH OE/RR ; 4/27/09 2:39pm
"RTN","PSGOESF",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**7,11,29,35,127,133,221**;16 DEC 97;Build 11
"RTN","PSGOESF",3,0)
 ;
"RTN","PSGOESF",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSGOESF",5,0)
 ; Reference to ^TMP is supported by DBIA 2190
"RTN","PSGOESF",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSGOESF",7,0)
 ;
"RTN","PSGOESF",8,0)
EN ;
"RTN","PSGOESF",9,0)
 I '$$HIDDEN^PSJLMUTL("SPEED") S VALMBCK="R" Q
"RTN","PSGOESF",10,0)
 ;PSJ*5*221 Account for pending orders being below pending renewals
"RTN","PSGOESF",11,0)
 N CODE,ST,DRG,ON,PSGONF,PSGONF2,PSGSFD,PENDCT
"RTN","PSGOESF",12,0)
 D FULL^VALM1 S PSGLMT=PSJOCNT,(PSGONF,PSGONF2,PENDCT)=0
"RTN","PSGOESF",13,0)
 S CODE="" F  S CODE=$O(^TMP("PSJ",$J,CODE)) Q:CODE=""  D
"RTN","PSGOESF",14,0)
 .S ST="" F  S ST=$O(^TMP("PSJ",$J,CODE,ST)) Q:ST=""  D
"RTN","PSGOESF",15,0)
 ..S DRG="" F  S DRG=$O(^TMP("PSJ",$J,CODE,ST,DRG)) Q:DRG=""  D
"RTN","PSGOESF",16,0)
 ...S ON="" F  S ON=$O(^TMP("PSJ",$J,CODE,ST,DRG,ON)) Q:ON=""  S PSGONF=PSGONF+1 D
"RTN","PSGOESF",17,0)
 ....I CODE="CC" S:$G(PSGONF2)=0 PSGONF2=PSGONF S PSGRLAST=PSGONF ;gets first renewal #
"RTN","PSGOESF",18,0)
 ....;PSJ*5*221 count pending orders to offset SF selection
"RTN","PSGOESF",19,0)
 ....I CODE="CB" S PENDCT=PENDCT+1
"RTN","PSGOESF",20,0)
 I PENDCT,$G(PSGRLAST) S PSGRLAST=PSGRLAST-PENDCT,PSGONF2=PSGONF2-PENDCT
"RTN","PSGOESF",21,0)
 I PSGONF2'>0 W !,"There are no orders which can be Speed Finished at this time.",!,"Only PENDING RENEWALS can be Speed Finished." D PAUSE^VALM1 Q
"RTN","PSGOESF",22,0)
 S PSGONF=PSGONF2_"^"_PSGRLAST
"RTN","PSGOESF",23,0)
 N DIR,L1,L2 S L1=+PSGONF,L2=$P(PSGONF,U,2),DIR(0)="LAO^"_L1_":"_L2,DIR("A")="FINISH which orders ("_L1_"-"_L2_"): ",DIR("?",1)="Select order"_$E("s",L1'=L2)_"to finish: ",DIR("??")="^D HELP^PSGOESF"
"RTN","PSGOESF",24,0)
 D ^DIR K DIR I $D(DIRUT) K X G DONE
"RTN","PSGOESF",25,0)
 I X?1N1"-" Q:$P(PSGONF,U,2)<X  S Y="" F L1=+X:1 S Y=Y_L1_"," Q:L1=$P(PSGONF,U,2)
"RTN","PSGOESF",26,0)
 I 'Y W $C(7),!!,"??" G EN
"RTN","PSGOESF",27,0)
ENCHK ;
"RTN","PSGOESF",28,0)
 S PSJSPEED=1
"RTN","PSGOESF",29,0)
 K PSGODDD S PSGODDD=1,PSGODDD(1)="" F Q=1:1:$L(Y,",") S X1=$P(Y,",",Q) D SET^PSGON Q:'$D(X)
"RTN","PSGOESF",30,0)
 S PSGOSD=0 F PSGOERS=1:1:PSGODDD F PSGOERS1=1:1 S PSGOERS2=$P(PSGODDD(PSGOERS),",",PSGOERS1) Q:'PSGOERS2  S Y=+^TMP("PSJON",$J,PSGOERS2),F=$G(^PS(53.1,Y,0)),D=$G(^(.2)) D HMSG^PSGOERS I F G EN
"RTN","PSGOESF",31,0)
 I $P(PSJSYSP0,"^",3) D  I '$D(PSGFOK) S X="" G DONE
"RTN","PSGOESF",32,0)
 .S PSGORD=^TMP("PSJON",$J,+PSGODDD(1)),PSGOFD=$P($G(^PS(53.1,+PSGORD,2)),U,4),DA=+PSGORD,DA(1)=PSGP,PSGSFD=$P($G(^PS(53.1,+PSGORD,0)),U,16)
"RTN","PSGOESF",33,0)
 .S PSGORD=$P(^PS(53.1,+PSGORD,0),U,25)
"RTN","PSGOESF",34,0)
 .S PSGWLL=$S($P(PSJSYSW0,"^",4):+$G(^PS(55,PSGP,5.1)),1:0),PSGOEE="R" W ! D DATE^PSGOER0(PSGP,PSGORD,PSGSFD)
"RTN","PSGOESF",35,0)
 .I '$D(PSGFOK(1)) W $C(7),!,"...order",$E("s",$L(PSGODDD(1),",")>2)," NOT finished..." K PSGFOK Q
"RTN","PSGOESF",36,0)
 .I 'PSGNEDFD,$P(PSJSYSW0,"^",4) D ENWALL^PSGNE3(PSGSD,PSGFD,PSGP)
"RTN","PSGOESF",37,0)
 W ! F PSGOERS=1:1:PSGODDD F PSGOERS1=1:1 S PSGOERS2=$P(PSGODDD(PSGOERS),",",PSGOERS1) Q:'PSGOERS2  S PSGORD=^TMP("PSJON",$J,PSGOERS2),PSGOEFF=0 D
"RTN","PSGOESF",38,0)
 .I '$$LS^PSSLOCK(PSGP,PSGORD) W !,"  ",PSGOERS2,". ",$P($$DRUGNAME^PSJLMUTL(PSGP,PSGORD),"^")," ",$P($G(^PS(53.1,+PSGORD,.2)),"^",2),!,"...No action taken on this order...",! H 1 Q
"RTN","PSGOESF",39,0)
 .;K PSGORQF D ENDDC^PSGSICHK(PSGP,+$G(^PS(53.1,+PSGORD,1,1,0)))
"RTN","PSGOESF",40,0)
 .;I '$D(PSGORQF) K PSGORQF,^TMP($J,"DI") D
"RTN","PSGOESF",41,0)
 .;. F PSGDDI=1:0 S PSGDDI=$O(^PS(53.1,+PSGORD,1,PSGDDI)) Q:'PSGDDI  S PSJDD=+$G(^PS(53.1,+PSGORD,1,PSGDDI,0)) D IVSOL^PSGSICHK
"RTN","PSGOESF",42,0)
 .D OC531
"RTN","PSGOESF",43,0)
 .I 'PSGOEFF&($D(PSGORQF)) W !!,"  ",PSGOERS2,". ",$P($$DRUGNAME^PSJLMUTL(PSGP,PSGORD),"^")," ",$P($G(^PS(53.1,+PSGORD,.2)),"^",2),!,"...No action taken on this order...",! H 1 Q
"RTN","PSGOESF",44,0)
 .S X=$G(^PS(53.1,+PSGORD,.2)),PSGPDRGN=$$ENPDN^PSGMI(+X),PSGDO=$P(X,U,2),X=$G(^PS(53.1,+PSGORD,0)),PSGMRN=$$ENMRN^PSGMI($P(X,U,3)),PSGST=$P(X,U,7)
"RTN","PSGOESF",45,0)
 .S PSGSCH=$P($G(^PS(53.1,+PSGORD,2)),U),PSGSI=$G(^(6))
"RTN","PSGOESF",46,0)
 .S $P(^PS(53.1,+PSGORD,2),U,2)=PSGSD,$P(^(2),U,4)=PSGFD,X=+$P($G(^PS(53.1,+PSGORD,0)),U,25)
"RTN","PSGOESF",47,0)
 .I $P($G(^PS(55,PSGP,5,+X,2)),U,4)>PSGSD S $P(^(2),U,3)=$P(^(2),U,4) K DA,DIE,DR S DA(1)=PSGP,DA=X,DR="34////"_PSGSD,DIE="^PS(55,"_DA(1)_",5," D ^DIE
"RTN","PSGOESF",48,0)
 .W !,"  ",PSGOERS2,". ",$P($$DRUGNAME^PSJLMUTL(PSGP,PSGORD),"^")," "
"RTN","PSGOESF",49,0)
 .W $P($G(^PS(53.1,+PSGORD,.2)),"^",2)
"RTN","PSGOESF",50,0)
 .D UPDATE
"RTN","PSGOESF",51,0)
 .D EN^PSGOEV(PSGORD)
"RTN","PSGOESF",52,0)
 .D UNL^PSSLOCK(PSGP,PSGORD)
"RTN","PSGOESF",53,0)
 ;
"RTN","PSGOESF",54,0)
DONE ; Kill and exit.
"RTN","PSGOESF",55,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","PSGOESF",56,0)
 I $G(PSGPXN) D ^PSGPER1
"RTN","PSGOESF",57,0)
 K PSJSPEED,PSGODDD,PSGOERS,PSGORD,PSGOERS2,PSGPDRGN,PSGDO,PSGSCH,PSGSI,NF,Y,PSGRLAST
"RTN","PSGOESF",58,0)
 Q
"RTN","PSGOESF",59,0)
HELP    ; Display help text for select order to be finished prompt."
"RTN","PSGOESF",60,0)
 W !!,"  Select the orders to be speed finished. Only orders listed under the PENDING",!,"RENEWALS heading are selectable. The start and stop date/times specified will"
"RTN","PSGOESF",61,0)
  W !,"be used for all orders selected to be finished using this function.",!
"RTN","PSGOESF",62,0)
 Q
"RTN","PSGOESF",63,0)
UPDATE        ;
"RTN","PSGOESF",64,0)
 N LOOP K ^PS(53.45,PSJSYSP,2)
"RTN","PSGOESF",65,0)
 F LOOP=0:0 S LOOP=$O(^PS(53.1,+PSGORD,1,LOOP)) Q:'LOOP  D
"RTN","PSGOESF",66,0)
 .S ^PS(53.45,PSJSYSP,2,LOOP,0)=^PS(53.1,+PSGORD,1,LOOP,0)
"RTN","PSGOESF",67,0)
 .S PSJJDRUG=$P(^PS(53.1,+PSGORD,1,LOOP,0),"^")
"RTN","PSGOESF",68,0)
 .S ^PS(53.45,PSJSYSP,2,"B",PSJJDRUG,LOOP)=""
"RTN","PSGOESF",69,0)
 .S ^PS(53.45,PSJSYSP,2,0)="^53.4502P"_"^"_LOOP_"^"_LOOP K PSJJDRUG
"RTN","PSGOESF",70,0)
 Q
"RTN","PSGOESF",71,0)
OC531 ;* Order checks for Speed finish and regular finish
"RTN","PSGOESF",72,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJPDRG
"RTN","PSGOESF",73,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)=""
"RTN","PSGOESF",74,0)
 K PSGORQF D ENDDC^PSGSICHK(PSGP,+$G(^PS(53.1,+PSGORD,1,1,0)))
"RTN","PSGOESF",75,0)
 I '$D(PSGORQF) K PSGORQF,^TMP($J,"DI") D
"RTN","PSGOESF",76,0)
 . F PSGDDI=1:0 S PSGDDI=$O(^PS(53.1,+PSGORD,1,PSGDDI)) Q:'PSGDDI  S PSJDD=+$G(^PS(53.1,+PSGORD,1,PSGDDI,0)) K PSJPDRG D IVSOL^PSGSICHK
"RTN","PSGOESF",77,0)
 Q
"RTN","PSJSFRQ")
0^2^B60315510^n/a
"RTN","PSJSFRQ",1,0)
PSJSFRQ ; SMT - SEARCH FOR ERRONEOUS FREQS ; 4/23/09 3:28pm
"RTN","PSJSFRQ",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**221**; FEB 09;Build 11
"RTN","PSJSFRQ",3,0)
 ; Enter EN^PSJSFRQ for Programmer
"RTN","PSJSFRQ",4,0)
 ; QUE^PSJSFRQ to QUEUE for the past 6 months
"RTN","PSJSFRQ",5,0)
 ; Mail sends to DUZ and anyone holding "PSJ RPHARM" key
"RTN","PSJSFRQ",6,0)
 Q  ; No entry from ^PSJSFRQ
"RTN","PSJSFRQ",7,0)
 ;
"RTN","PSJSFRQ",8,0)
QUE ;
"RTN","PSJSFRQ",9,0)
 N NAMSP,PATCH,JOBN,DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,QUIT,Y,ZTQUEUED,ZTREQ,ZTSAVE,PSJQUE,PSRUN
"RTN","PSJSFRQ",10,0)
 S NAMSP=$$NAMSP
"RTN","PSJSFRQ",11,0)
 S JOBN="Frequency Report"
"RTN","PSJSFRQ",12,0)
 S PATCH="PSJ*5*221"
"RTN","PSJSFRQ",13,0)
 S PSRUN="U" ;This is the type of run UD or IV for the report.
"RTN","PSJSFRQ",14,0)
 ;
"RTN","PSJSFRQ",15,0)
 L +^XTMP(NAMSP):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I '$T D  Q
"RTN","PSJSFRQ",16,0)
 . D BMES^XPDUTL(JOBN_" job is already running.  Halting...")
"RTN","PSJSFRQ",17,0)
 . D MES^XPDUTL("")
"RTN","PSJSFRQ",18,0)
 . D QUIT
"RTN","PSJSFRQ",19,0)
 ;
"RTN","PSJSFRQ",20,0)
 I '$D(^XTMP(NAMSP)) D INITXTMP(NAMSP,JOBN_", "_PATCH,90)        ;90 day life
"RTN","PSJSFRQ",21,0)
 S QUIT=0
"RTN","PSJSFRQ",22,0)
 ;
"RTN","PSJSFRQ",23,0)
 I $G(^XTMP(NAMSP,0,"LAST"))["COMPLETED" D  Q
"RTN","PSJSFRQ",24,0)
 . W !!,*7,"This job has been run before to completion on "
"RTN","PSJSFRQ",25,0)
 . W $$FMTE^XLFDT($P($G(^XTMP(NAMSP,0,"LAST")),"^",2)),!!
"RTN","PSJSFRQ",26,0)
 . W "If you want to run it again, the global subscript ^XTMP('"_NAMSP_"') must be",!
"RTN","PSJSFRQ",27,0)
 . W "deleted prior to doing so.",!!
"RTN","PSJSFRQ",28,0)
 . D QUIT
"RTN","PSJSFRQ",29,0)
 ;
"RTN","PSJSFRQ",30,0)
 ;ques 2, if running from mumps prompt
"RTN","PSJSFRQ",31,0)
 I '$D(XPDQUES("POS2")) D  I 'ZTDTH D QUIT Q
"RTN","PSJSFRQ",32,0)
 . K DIR
"RTN","PSJSFRQ",33,0)
 . S DIR("A",1)=" Enter when to Queue the "_JOBN_" job to run"
"RTN","PSJSFRQ",34,0)
 . S DIR("A")=" in date@time format"
"RTN","PSJSFRQ",35,0)
 . S DIR("B")="NOW"
"RTN","PSJSFRQ",36,0)
 . S DIR(0)="D^::%DT"
"RTN","PSJSFRQ",37,0)
 . S DIR("?")=" Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 021506@3:30p"
"RTN","PSJSFRQ",38,0)
 . D ^DIR I $D(DUOUT) W !,"Halting..." S ZTDTH="" Q
"RTN","PSJSFRQ",39,0)
 . S:$D(DTOUT) Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSJSFRQ",40,0)
 ;
"RTN","PSJSFRQ",41,0)
 ;ques 2, if running from kids install
"RTN","PSJSFRQ",42,0)
 I $D(XPDQUES("POS2")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS2"))
"RTN","PSJSFRQ",43,0)
 ;
"RTN","PSJSFRQ",44,0)
 D BMES^XPDUTL("=============================================================")
"RTN","PSJSFRQ",45,0)
 D MES^XPDUTL("Queuing background job for "_JOBN_"...")
"RTN","PSJSFRQ",46,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSJSFRQ",47,0)
 D MES^XPDUTL("==============================================================")
"RTN","PSJSFRQ",48,0)
 I ZTDTH="" D BMES^XPDUTL(JOBN_" NOT QUEUED") D QUIT Q
"RTN","PSJSFRQ",49,0)
 ;
"RTN","PSJSFRQ",50,0)
 S:$D(^XTMP(NAMSP,0,"LAST")) ^XTMP(NAMSP,0,"ZAUDIT",$H)="RE-STARTED ON"_"^"_$$NOW^XLFDT_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","PSJSFRQ",51,0)
 ;
"RTN","PSJSFRQ",52,0)
 I $P($G(^XTMP(NAMSP,0,"LAST")),"^")="STOP" D
"RTN","PSJSFRQ",53,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="RUN^"_$$NOW^XLFDT
"RTN","PSJSFRQ",54,0)
 E  D
"RTN","PSJSFRQ",55,0)
 . S ^XTMP(NAMSP,0,"LAST")="RUN^"_$$NOW^XLFDT_"^^^"
"RTN","PSJSFRQ",56,0)
 ;
"RTN","PSJSFRQ",57,0)
 S ZTRTN="EN^"_NAMSP,ZTIO="",PSJQUE=1
"RTN","PSJSFRQ",58,0)
 S ZTDESC="Background job for "_JOBN_" on prescriptions updated via "_PATCH
"RTN","PSJSFRQ",59,0)
 S ZTSAVE("JOBN")="",ZTSAVE("PSJQUE")="",ZTSAVE("PSRUN")=""
"RTN","PSJSFRQ",60,0)
 L -^XTMP(NAMSP)
"RTN","PSJSFRQ",61,0)
 D ^%ZTLOAD
"RTN","PSJSFRQ",62,0)
 D:$D(ZTSK)
"RTN","PSJSFRQ",63,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","PSJSFRQ",64,0)
 . D BMES^XPDUTL("")
"RTN","PSJSFRQ",65,0)
 D BMES^XPDUTL("")
"RTN","PSJSFRQ",66,0)
 K XPDQUES
"RTN","PSJSFRQ",67,0)
 Q
"RTN","PSJSFRQ",68,0)
 ;
"RTN","PSJSFRQ",69,0)
EN ;
"RTN","PSJSFRQ",70,0)
 N MSG,MCNT,START,STOP,I,DFN,IEN,ORD,SCH,OINFO,CNT,I,SUBJ,STARTH,STOPH,VADM,INF,Y,X,% K ERORD
"RTN","PSJSFRQ",71,0)
 I '$G(PSJQUE) W !,"This report will generate a mailman of problem Orders with incorrect frequency"
"RTN","PSJSFRQ",72,0)
 I '$G(PSJQUE),'$G(PSRUN) S PSRUN="" F  D  Q:(PSRUN="U")!(PSRUN="I")!(PSRUN="UI")!(PSRUN="")!(PSRUN["^")
"RTN","PSJSFRQ",73,0)
 . W !,"Please Select, type of order to run this report on",!,"U - Unit Dose",!,"I - IV",!,"UI - Both",!,"Selection:"
"RTN","PSJSFRQ",74,0)
 . R PSRUN:$S($G(DTIME):DTIME,1:9999) E  S PSRUN="^" Q
"RTN","PSJSFRQ",75,0)
 . I (PSRUN'="U")&(PSRUN'="I")&(PSRUN'="UI")&(PSRUN'["^")&(PSRUN'="") W "  <??>",$C(7)
"RTN","PSJSFRQ",76,0)
 Q:(PSRUN["^")!(PSRUN="")
"RTN","PSJSFRQ",77,0)
 D RANGE Q:START=-1
"RTN","PSJSFRQ",78,0)
 ;UD Orders
"RTN","PSJSFRQ",79,0)
 I PSRUN["U" D
"RTN","PSJSFRQ",80,0)
 . S I=START F  S I=$O(^PS(55,"AUDS",I)) Q:'I!(I>STOP)  D
"RTN","PSJSFRQ",81,0)
 . . S DFN=0 F  S DFN=$O(^PS(55,"AUDS",I,DFN)) Q:'DFN  D
"RTN","PSJSFRQ",82,0)
 . . . S IEN=0 F  S IEN=$O(^PS(55,"AUDS",I,DFN,IEN)) Q:'IEN  D 
"RTN","PSJSFRQ",83,0)
 . . . . S ORD=DFN_";"_IEN_"U"
"RTN","PSJSFRQ",84,0)
 . . . . K OINFO,SCH S OINFO=$$INFO(ORD) S SCH=$$GETSCH($P(OINFO,"^")) Q:SCH=0
"RTN","PSJSFRQ",85,0)
 . . . . I $$CHKSDT(ORD) S ERORD(ORD)=""
"RTN","PSJSFRQ",86,0)
 . . . . I ("AH"[$P(OINFO,"^",4)),+$P(OINFO,"^",3)'=+$P(SCH,"^",3) Q:'$P(OINFO,"^",3)!($P(OINFO,"^",6)'="C")  S ERORD(ORD)=""
"RTN","PSJSFRQ",87,0)
 ;IV orders
"RTN","PSJSFRQ",88,0)
 I PSRUN["I" D
"RTN","PSJSFRQ",89,0)
 . S I=START F  S I=$O(^PS(55,"AIVS",I)) Q:'I!(I>STOP)  D
"RTN","PSJSFRQ",90,0)
 . . S DFN=0 F  S DFN=$O(^PS(55,"AIVS",I,DFN)) Q:'DFN  D
"RTN","PSJSFRQ",91,0)
 . . . S IEN=0 F  S IEN=$O(^PS(55,"AIVS",I,DFN,IEN)) Q:'IEN  D
"RTN","PSJSFRQ",92,0)
 . . . . S ORD=DFN_";"_IEN_"I"
"RTN","PSJSFRQ",93,0)
 . . . . K OINFO,SCH S OINFO=$$INFO(ORD) S SCH=$$GETSCH($P(OINFO,"^")) Q:SCH=0
"RTN","PSJSFRQ",94,0)
 . . . . I ("AH"[$P(OINFO,"^",4)),+$P(OINFO,"^",3)'=+$P(SCH,"^",3) Q:'$P(OINFO,"^",3)!($P(OINFO,"^",6)'="P")  S ERORD(ORD)=""
"RTN","PSJSFRQ",95,0)
 ;Pending Orders
"RTN","PSJSFRQ",96,0)
 ;TBD
"RTN","PSJSFRQ",97,0)
 ;
"RTN","PSJSFRQ",98,0)
 ;CREATE Message to send based on ERORD
"RTN","PSJSFRQ",99,0)
 S CNT=1
"RTN","PSJSFRQ",100,0)
 S Y=START D DD^%DT S STARTH=Y
"RTN","PSJSFRQ",101,0)
 S Y=STOP D DD^%DT S STOPH=Y
"RTN","PSJSFRQ",102,0)
 S SUBJ="FREQUENCY MISMATCH :"_RUNTM
"RTN","PSJSFRQ",103,0)
 S MSG(CNT)="This is a list of orders with mismatching frequencies and possible",CNT=CNT+1
"RTN","PSJSFRQ",104,0)
 S MSG(CNT)="start date problems. This excludes orders with no frequency and invalid",CNT=CNT+1
"RTN","PSJSFRQ",105,0)
 S MSG(CNT)="schedules, the orders on this list need to be reviewed!",CNT=CNT+1
"RTN","PSJSFRQ",106,0)
 S MSG(CNT)="This report range is from:"_STARTH_" to "_STOPH,CNT=CNT+1
"RTN","PSJSFRQ",107,0)
 I '$D(ERORD) S MSG(CNT)="There are no problems.",CNT=CNT+1
"RTN","PSJSFRQ",108,0)
 S I=0 F  S I=$O(ERORD(I)) Q:'I  D
"RTN","PSJSFRQ",109,0)
 . S INF=$$INFO(I),DFN=$P(I,";") K VA,VADM D
"RTN","PSJSFRQ",110,0)
 . . N I D ^VADPT
"RTN","PSJSFRQ",111,0)
 . S MSG(CNT)="",CNT=CNT+1
"RTN","PSJSFRQ",112,0)
 . S MSG(CNT)="PATIENT:"_VADM(1)_"  SSN:"_VA("BID"),CNT=CNT+1 I I'["I" S MSG(CNT-1)=MSG(CNT-1)_"  DRUG:"_$P(^PSDRUG($P(INF,"^",5),0),"^")
"RTN","PSJSFRQ",113,0)
 . S MSG(CNT)="DFN:"_$P(I,";")_"   ORDER#:"_+$P(I,";",2)_"   SCHED:"_$P(INF,"^")_"   STATUS:"_$P(INF,"^",4),CNT=CNT+1
"RTN","PSJSFRQ",114,0)
 . S MSG(CNT)="  TYPE:"_$S(I["I":"IV",I["U":"UNIT DOSE",1:"PENDING")_"   FREQ:"_$P(INF,"^",3),CNT=CNT+1
"RTN","PSJSFRQ",115,0)
 ;
"RTN","PSJSFRQ",116,0)
 ;Send message
"RTN","PSJSFRQ",117,0)
 D MAIL(.MSG,SUBJ)
"RTN","PSJSFRQ",118,0)
 Q
"RTN","PSJSFRQ",119,0)
RANGE ;
"RTN","PSJSFRQ",120,0)
 N NOW,%DT,Y,X,X1,X2,% K START,STOP,RUNTM
"RTN","PSJSFRQ",121,0)
 D NOW^%DTC S NOW=% S Y=$P(%,".") D DD^%DT S RUNTM=Y
"RTN","PSJSFRQ",122,0)
 ;If this is qued, don't ask, just set to 6 months.
"RTN","PSJSFRQ",123,0)
 I $G(PSJQUE) S STOP=NOW,X1=NOW,X2=-183 D C^%DTC S START=X Q
"RTN","PSJSFRQ",124,0)
 S %DT="AEPT",%DT("A")="Start Date:",%DT(0)="-NOW" D ^%DT
"RTN","PSJSFRQ",125,0)
 S START=Y I Y=-1 Q
"RTN","PSJSFRQ",126,0)
 S %DT="AEPT",%DT("A")="Stop Date:",%DT(0)=START D ^%DT
"RTN","PSJSFRQ",127,0)
 S STOP=Y I Y=-1 Q
"RTN","PSJSFRQ",128,0)
 Q
"RTN","PSJSFRQ",129,0)
 ;
"RTN","PSJSFRQ",130,0)
GETSCH(SCHED) ;
"RTN","PSJSFRQ",131,0)
 ; 
"RTN","PSJSFRQ",132,0)
 ; Returns "SCHED^AT^FREQ^PKG"
"RTN","PSJSFRQ",133,0)
 ;
"RTN","PSJSFRQ",134,0)
 N I,FRQ,PKG,AT K FREQ
"RTN","PSJSFRQ",135,0)
 Q:SCHED']"" 0
"RTN","PSJSFRQ",136,0)
 I '$O(^PS(51.1,"APPSJ",SCHED,0)) Q 0
"RTN","PSJSFRQ",137,0)
 S I=0 F  S I=$O(^PS(51.1,"APPSJ",SCHED,I)) Q:'I  D
"RTN","PSJSFRQ",138,0)
 . ;Get Data
"RTN","PSJSFRQ",139,0)
 . S FRQ=$P(^PS(51.1,I,0),"^",3),PKG=$P(^(0),"^",4),AT=$P(^(0),"^",2)
"RTN","PSJSFRQ",140,0)
 ;
"RTN","PSJSFRQ",141,0)
 Q $G(SCHED)_"^"_$G(AT)_"^"_$G(FRQ)_"^"_$G(PKG)
"RTN","PSJSFRQ",142,0)
 ;
"RTN","PSJSFRQ",143,0)
INFO(ORD) ;
"RTN","PSJSFRQ",144,0)
 ;
"RTN","PSJSFRQ",145,0)
 ; IEN=DFN;IEN(TYPE) 
"RTN","PSJSFRQ",146,0)
 ; ex 2222;102U or 2222;32I or ;23P
"RTN","PSJSFRQ",147,0)
 ;
"RTN","PSJSFRQ",148,0)
 ; Return "SCHED^AT^FRQ^STATUS^DRUG^SCHTP" (SCHTP is Schedule Type for UD and TYPE for IV
"RTN","PSJSFRQ",149,0)
 ;
"RTN","PSJSFRQ",150,0)
 N F,SCHED,AT,FRQ,DFN,STAT,DRUG,X,SCHTP,DSPDG,ND0 K DTA55
"RTN","PSJSFRQ",151,0)
 S DFN=$P(ORD,";")
"RTN","PSJSFRQ",152,0)
 I ORD["P" S F="^PS(53.1,"_+$P(ORD,";",2)_","
"RTN","PSJSFRQ",153,0)
 E  S F="^PS(55,"_DFN_","_$S(ORD["U":"5",1:"""IV""")_","_+$P(ORD,";",2)_","
"RTN","PSJSFRQ",154,0)
 ;Unit Dose
"RTN","PSJSFRQ",155,0)
 I (ORD["U")!(ORD["P") D
"RTN","PSJSFRQ",156,0)
 . S ND0=F_"0)"
"RTN","PSJSFRQ",157,0)
 . S DSPDG=F_"1," S X=DSPDG_"0)" S X=$O(@X),DSPDG=$G(@(DSPDG_$S(+X:X,1:1)_",0)"))
"RTN","PSJSFRQ",158,0)
 . S F=F_"2)"
"RTN","PSJSFRQ",159,0)
 . S SCHED=$P(@F,"^"),AT=$P(@F,"^",5),FRQ=$P(@F,"^",6),STAT=$P(@ND0,"^",9),DRUG=$P(DSPDG,"^"),SCHTP=$P(@ND0,"^",7)
"RTN","PSJSFRQ",160,0)
 ;IV
"RTN","PSJSFRQ",161,0)
 I ORD["I" D
"RTN","PSJSFRQ",162,0)
 . S DRUG=""
"RTN","PSJSFRQ",163,0)
 . S F=F_"0)"
"RTN","PSJSFRQ",164,0)
 . S SCHED=$P(@F,"^",9),AT=$P(@F,"^",11),FRQ=$P(@F,"^",15),STAT=$P(@F,"^",17),SCHTP=$P(@F,"^",4)
"RTN","PSJSFRQ",165,0)
 ;
"RTN","PSJSFRQ",166,0)
 Q $G(SCHED)_"^"_$G(AT)_"^"_$G(FRQ)_"^"_$G(STAT)_"^"_$G(DRUG)_"^"_$G(SCHTP)
"RTN","PSJSFRQ",167,0)
 ;
"RTN","PSJSFRQ",168,0)
CHKSDT(ORD) ;
"RTN","PSJSFRQ",169,0)
 ;
"RTN","PSJSFRQ",170,0)
 ; If this function returns 1 there is a start date problem.
"RTN","PSJSFRQ",171,0)
 ;
"RTN","PSJSFRQ",172,0)
 N DFN,ERR,ND2,ND0,I,LIDT,STDT,F,ND
"RTN","PSJSFRQ",173,0)
 Q:ORD["I" 0
"RTN","PSJSFRQ",174,0)
 S DFN=$P(ORD,";")
"RTN","PSJSFRQ",175,0)
 I ORD["P" S F="^PS(53.1,"_+$P(ORD,";",2)_","
"RTN","PSJSFRQ",176,0)
 E  S F="^PS(55,"_DFN_","_$S(ORD["U":"5",1:"""IV""")_","_+$P(ORD,";",2)_","
"RTN","PSJSFRQ",177,0)
 S ND2=F_"2)",ND2=@ND2,ND0=F_"0)",ND0=@ND0,ERR=0
"RTN","PSJSFRQ",178,0)
 I ORD["U" D
"RTN","PSJSFRQ",179,0)
 . S STDT=$P(ND2,"^",2),LIDT=$P(ND0,"^",14),I=""
"RTN","PSJSFRQ",180,0)
 . F  S I=$O(^PS(55,DFN,5,+$P(ORD,";",2),9,I),-1) Q:'I  S ND=^(I,0) I $P(ND,"^",3)["Start Date" D  Q
"RTN","PSJSFRQ",181,0)
 . . Q:STDT=LIDT
"RTN","PSJSFRQ",182,0)
 . . I STDT'=$P(ND,"^",5) S ERR=1
"RTN","PSJSFRQ",183,0)
 Q ERR
"RTN","PSJSFRQ",184,0)
 ;
"RTN","PSJSFRQ",185,0)
MAIL(MSG,SBJ) ; Send out some mail!
"RTN","PSJSFRQ",186,0)
 N DIFROM,XMDUZ,XMSUB,XMTEXT,XMY,I
"RTN","PSJSFRQ",187,0)
 S XMDUZ="INPT PHARMACY",XMSUB=SBJ,XMTEXT="MSG("
"RTN","PSJSFRQ",188,0)
 S XMY(DUZ)="",I=0 F  S I=$O(^XUSEC("PSJ RPHARM",I)) Q:'I  S XMY(I)=""
"RTN","PSJSFRQ",189,0)
 D ^XMD
"RTN","PSJSFRQ",190,0)
 Q ""
"RTN","PSJSFRQ",191,0)
 ;
"RTN","PSJSFRQ",192,0)
NAMSP() ;
"RTN","PSJSFRQ",193,0)
 Q $T(+0)
"RTN","PSJSFRQ",194,0)
 ;
"RTN","PSJSFRQ",195,0)
STOP ;stop job command
"RTN","PSJSFRQ",196,0)
 I $$ST S ^XTMP($$NAMSP,0,"STOP")="" D
"RTN","PSJSFRQ",197,0)
 . W !,"TALLY MISSING EXPIRATION DATES Job - set to STOP Soon"
"RTN","PSJSFRQ",198,0)
 . W !!,"Check Status to be sure it has stopped and is not running..."
"RTN","PSJSFRQ",199,0)
 . W !,"     (D STATUS^PSOTEXP1)"
"RTN","PSJSFRQ",200,0)
 Q
"RTN","PSJSFRQ",201,0)
 ;
"RTN","PSJSFRQ",202,0)
ST() ;status
"RTN","PSJSFRQ",203,0)
 L +^XTMP($$NAMSP):3 I $T D  Q 0
"RTN","PSJSFRQ",204,0)
 . L -^XTMP($$NAMSP)
"RTN","PSJSFRQ",205,0)
 . W !,"*** NOT CURRENTLY RUNNING! ***",!
"RTN","PSJSFRQ",206,0)
 Q 1
"RTN","PSJSFRQ",207,0)
 ;
"RTN","PSJSFRQ",208,0)
INITXTMP(NAMSP,TITLE,LIFE) ;create ^Xtmp according to SAC std
"RTN","PSJSFRQ",209,0)
 N BEGDT,PURGDT
"RTN","PSJSFRQ",210,0)
 S BEGDT=$$NOW^XLFDT()
"RTN","PSJSFRQ",211,0)
 S PURGDT=$$FMADD^XLFDT(BEGDT,LIFE)
"RTN","PSJSFRQ",212,0)
 S ^XTMP(NAMSP,0)=PURGDT_"^"_BEGDT_"^"_TITLE
"RTN","PSJSFRQ",213,0)
 Q
"RTN","PSJSFRQ",214,0)
 ;
"RTN","PSJSFRQ",215,0)
QUIT ;
"RTN","PSJSFRQ",216,0)
 L -^XTMP(NAMSP)
"RTN","PSJSFRQ",217,0)
 Q
"RTN","PSJSFRQ",218,0)
 ;
"VER")
8.0^22.0
"BLD",8065,6)
^191
**END**
**END**

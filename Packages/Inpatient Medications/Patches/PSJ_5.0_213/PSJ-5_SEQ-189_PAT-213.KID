Released PSJ*5*213 SEQ #189
Extracted from mail message
**KIDS**:PSJ*5.0*213^

**INSTALL NAME**
PSJ*5.0*213
"BLD",6350,0)
PSJ*5.0*213^INPATIENT MEDICATIONS^0^3081211^y
"BLD",6350,1,0)
^^108^108^3081211^
"BLD",6350,1,1,0)
Description:
"BLD",6350,1,2,0)
===========
"BLD",6350,1,3,0)
 
"BLD",6350,1,4,0)
This patch contains four Inpatient Medications V. 5.0 fixes that sites
"BLD",6350,1,5,0)
logged during the compliance date period for the CPRS (Computerized 
"BLD",6350,1,6,0)
Patient Record System) GUI v27 release.
"BLD",6350,1,7,0)
 
"BLD",6350,1,8,0)
 
"BLD",6350,1,9,0)
1. The first issue, Remedy Ticket HD280022, pertains to Day of Week
"BLD",6350,1,10,0)
schedules entered for IV Piggyback orders via the CPRS IV Fluids Dialog.
"BLD",6350,1,11,0)
If the user creates a schedule using the schedule builder, and uses the
"BLD",6350,1,12,0)
new format of Day of Week@Schedule (example: MO-WE-FR@BID), and if the
"BLD",6350,1,13,0)
root schedule (MO-WE-FR) exists in the ADMINISTRATION SCHEDULE File 
"BLD",6350,1,14,0)
(#51.1), when the order is viewed in backdoor pharmacy, the
"BLD",6350,1,15,0)
administration time(s) for the order will be null.
"BLD",6350,1,16,0)
 
"BLD",6350,1,17,0)
Problem:
"BLD",6350,1,18,0)
--------
"BLD",6350,1,19,0)
Admin times are null if a Day of Week schedule created via the schedule
"BLD",6350,1,20,0)
builder in CPRS exists in the ADMINISTRATION SCHEDULE File (#51.1).
"BLD",6350,1,21,0)
 
"BLD",6350,1,22,0)
Resolution:
"BLD",6350,1,23,0)
-----------
"BLD",6350,1,24,0)
In PSGS0, do not QUIT before the admin times are set if the schedule
"BLD",6350,1,25,0)
is a Day of Week schedule, even if it exists in the schedule file.
"BLD",6350,1,26,0)
 
"BLD",6350,1,27,0)
 
"BLD",6350,1,28,0)
2. The second issue, Remedy Ticket HD246438 and its duplicates, is also 
"BLD",6350,1,29,0)
logged as Patient Safety Issue PSI-08-068,PSPO #782.  This is an issue
"BLD",6350,1,30,0)
with an invalid frequency for IV Piggyback orders.  This issue has existed
"BLD",6350,1,31,0)
prior to the release of CPRS GUI v27, but the sites are reporting an
"BLD",6350,1,32,0)
increase in the occurrence of the problem after the install of CPRS GUI 
"BLD",6350,1,33,0)
v27. For unknown reasons, the frequency of some IV Piggyback orders is 
"BLD",6350,1,34,0)
null when it should contain a value.
"BLD",6350,1,35,0)
 
"BLD",6350,1,36,0)
No site or developer has been able to 
"BLD",6350,1,37,0)
reproduce this issue at-will, and there does not appear to be any
"BLD",6350,1,38,0)
pattern to the processes or procedures that precede the occurrence of this
"BLD",6350,1,39,0)
problem. With this patch, if the frequency for an IV Piggyback order is
"BLD",6350,1,40,0)
null, and it should contain a value, the code will attempt to directly
"BLD",6350,1,41,0)
set an appropriate frequency into the PHARMACY PATIENT File (#55) upon
"BLD",6350,1,42,0)
verification of the order, and upon the order becoming active.
"BLD",6350,1,43,0)
 
"BLD",6350,1,44,0)
Problem:
"BLD",6350,1,45,0)
--------
"BLD",6350,1,46,0)
The frequency is being set to null very sporadically for IV Piggyback
"BLD",6350,1,47,0)
orders.  No root cause is known.
"BLD",6350,1,48,0)
 
"BLD",6350,1,49,0)
Resolution:
"BLD",6350,1,50,0)
-----------
"BLD",6350,1,51,0)
During the verification process, if the IV is intermittent, and the
"BLD",6350,1,52,0)
frequency is null, attempt to re-set the frequency based on the name
"BLD",6350,1,53,0)
of the schedule as well as other variables that should
"BLD",6350,1,54,0)
contain the value of the frequency.  These changes are in routine 
"BLD",6350,1,55,0)
PSIVORFB.
"BLD",6350,1,56,0)
 
"BLD",6350,1,57,0)
3. The third issue, Remedy Ticket HD274682 and its duplicates, is an
"BLD",6350,1,58,0)
undefined variable error in the new Meds Tab sort for CPRS.  The root
"BLD",6350,1,59,0)
cause of the problem is that a pointer to the PHARMACY ORDERABLE ITEM File
"BLD",6350,1,60,0)
(#50.7) is missing in either the NON-VERIFIED ORDERS File (#53.1) or the
"BLD",6350,1,61,0)
PHARMACY PATIENT File (#55).  Because the pointer does not exist, when
"BLD",6350,1,62,0)
a temporary global is being built to display the orders for the patient, 
"BLD",6350,1,63,0)
an undefined variable error occurs.
"BLD",6350,1,64,0)
 
"BLD",6350,1,65,0)
 
"BLD",6350,1,66,0)
Problem:
"BLD",6350,1,67,0)
--------
"BLD",6350,1,68,0)
Very old orders exist in the system that do not contain a pointer to
"BLD",6350,1,69,0)
the orderable item.  When the new Meds Tab sort routines attempt to
"BLD",6350,1,70,0)
use the pointer value as a subscript in a ^TMP global setting, and the
"BLD",6350,1,71,0)
pointer's value is null, a null subscript error occurs.  This causes
"BLD",6350,1,72,0)
a hard error in CPRS and shuts CPRS down.
"BLD",6350,1,73,0)
 
"BLD",6350,1,74,0)
Resolution:
"BLD",6350,1,75,0)
-----------
"BLD",6350,1,76,0)
If the pointer to the orderable item does not exist, the routines will
"BLD",6350,1,77,0)
use the phrase "Orderable Item Not Found" as the subscript value in place
"BLD",6350,1,78,0)
of what should be the name of the orderable item.  This allows the Meds
"BLD",6350,1,79,0)
Tab sort routines to process without error, and the patient's medications
"BLD",6350,1,80,0)
appear without problems on the CPRS Meds tab.  The updated routines are
"BLD",6350,1,81,0)
PSJORRO, PSJORRN, and PSJORRN1.
"BLD",6350,1,82,0)
 
"BLD",6350,1,83,0)
4. The fourth issue addressed by this patch is Remedy Ticket HD280040, 
"BLD",6350,1,84,0)
which deals with an inconsistency between CPRS and backdoor pharmacy
"BLD",6350,1,85,0)
with respect to continuous IV orders. 
"BLD",6350,1,86,0)
 
"BLD",6350,1,87,0)
If the IV order originates from CPRS, a
"BLD",6350,1,88,0)
fractional infusion rate of < 1 ml/hr (0.9 ml/hr for example), backdoor
"BLD",6350,1,89,0)
pharmacy allows the infusion rate, and the order can be finished and
"BLD",6350,1,90,0)
verified without issue.  However, if the order originates from backdoor
"BLD",6350,1,91,0)
pharmacy, a fractional infusion rate < 1 ml/hr is not accepted, and the
"BLD",6350,1,92,0)
user is presented a message "Invalid Infusion Rate", and they cannot
"BLD",6350,1,93,0)
finish and verify the order.  This patch will make backdoor pharmacy
"BLD",6350,1,94,0)
behave consistently with CPRS.
"BLD",6350,1,95,0)
 
"BLD",6350,1,96,0)
Problem:
"BLD",6350,1,97,0)
--------
"BLD",6350,1,98,0)
If an order is entered via backdoor pharmacy for a continuous IV, and the
"BLD",6350,1,99,0)
order is created with a fractional infusion rate of < 1 ml/hr, the system
"BLD",6350,1,100,0)
presents the user with the error message, "Your infusion rate is in an
"BLD",6350,1,101,0)
invalid format", and the order cannot be completed.
"BLD",6350,1,102,0)
 
"BLD",6350,1,103,0)
Resolution:
"BLD",6350,1,104,0)
-----------
"BLD",6350,1,105,0)
If the order has a fractional infusion rate < 1 ml/hr, the order must
"BLD",6350,1,106,0)
contain a leading zero, and the system will view the infusion rate as
"BLD",6350,1,107,0)
valid.  (example - infusion rate must be 0.9 ml/hr to be valid)
"BLD",6350,1,108,0)
The coding will affect routines PSIVSP, PSIVCHK, and PSIVORE.
"BLD",6350,4,0)
^9.64PA^^
"BLD",6350,6.3)
8
"BLD",6350,"KRN",0)
^9.67PA^779.2^20
"BLD",6350,"KRN",.4,0)
.4
"BLD",6350,"KRN",.401,0)
.401
"BLD",6350,"KRN",.402,0)
.402
"BLD",6350,"KRN",.403,0)
.403
"BLD",6350,"KRN",.5,0)
.5
"BLD",6350,"KRN",.84,0)
.84
"BLD",6350,"KRN",3.6,0)
3.6
"BLD",6350,"KRN",3.8,0)
3.8
"BLD",6350,"KRN",9.2,0)
9.2
"BLD",6350,"KRN",9.8,0)
9.8
"BLD",6350,"KRN",9.8,"NM",0)
^9.68A^9^8
"BLD",6350,"KRN",9.8,"NM",1,0)
PSGS0^^0^B50790637
"BLD",6350,"KRN",9.8,"NM",2,0)
PSIVORFB^^0^B55183274
"BLD",6350,"KRN",9.8,"NM",3,0)
PSIVSP^^0^B38850432
"BLD",6350,"KRN",9.8,"NM",5,0)
PSJORRN^^0^B61459384
"BLD",6350,"KRN",9.8,"NM",6,0)
PSJORRN1^^0^B55578785
"BLD",6350,"KRN",9.8,"NM",7,0)
PSJORRO^^0^B62410106
"BLD",6350,"KRN",9.8,"NM",8,0)
PSIVORE^^0^B41910420
"BLD",6350,"KRN",9.8,"NM",9,0)
PSIVCHK^^0^B15710201
"BLD",6350,"KRN",9.8,"NM","B","PSGS0",1)

"BLD",6350,"KRN",9.8,"NM","B","PSIVCHK",9)

"BLD",6350,"KRN",9.8,"NM","B","PSIVORE",8)

"BLD",6350,"KRN",9.8,"NM","B","PSIVORFB",2)

"BLD",6350,"KRN",9.8,"NM","B","PSIVSP",3)

"BLD",6350,"KRN",9.8,"NM","B","PSJORRN",5)

"BLD",6350,"KRN",9.8,"NM","B","PSJORRN1",6)

"BLD",6350,"KRN",9.8,"NM","B","PSJORRO",7)

"BLD",6350,"KRN",19,0)
19
"BLD",6350,"KRN",19.1,0)
19.1
"BLD",6350,"KRN",101,0)
101
"BLD",6350,"KRN",409.61,0)
409.61
"BLD",6350,"KRN",771,0)
771
"BLD",6350,"KRN",779.2,0)
779.2
"BLD",6350,"KRN",870,0)
870
"BLD",6350,"KRN",8989.51,0)
8989.51
"BLD",6350,"KRN",8989.52,0)
8989.52
"BLD",6350,"KRN",8994,0)
8994
"BLD",6350,"KRN","B",.4,.4)

"BLD",6350,"KRN","B",.401,.401)

"BLD",6350,"KRN","B",.402,.402)

"BLD",6350,"KRN","B",.403,.403)

"BLD",6350,"KRN","B",.5,.5)

"BLD",6350,"KRN","B",.84,.84)

"BLD",6350,"KRN","B",3.6,3.6)

"BLD",6350,"KRN","B",3.8,3.8)

"BLD",6350,"KRN","B",9.2,9.2)

"BLD",6350,"KRN","B",9.8,9.8)

"BLD",6350,"KRN","B",19,19)

"BLD",6350,"KRN","B",19.1,19.1)

"BLD",6350,"KRN","B",101,101)

"BLD",6350,"KRN","B",409.61,409.61)

"BLD",6350,"KRN","B",771,771)

"BLD",6350,"KRN","B",779.2,779.2)

"BLD",6350,"KRN","B",870,870)

"BLD",6350,"KRN","B",8989.51,8989.51)

"BLD",6350,"KRN","B",8989.52,8989.52)

"BLD",6350,"KRN","B",8994,8994)

"BLD",6350,"QUES",0)
^9.62^^
"BLD",6350,"REQB",0)
^9.611^2^2
"BLD",6350,"REQB",1,0)
PSJ*5.0*134^2
"BLD",6350,"REQB",2,0)
PSJ*5.0*203^2
"BLD",6350,"REQB","B","PSJ*5.0*134",1)

"BLD",6350,"REQB","B","PSJ*5.0*203",2)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
213^3081211^11883
"PKG",197,22,1,"PAH",1,1,0)
^^108^108^3081211
"PKG",197,22,1,"PAH",1,1,1,0)
Description:
"PKG",197,22,1,"PAH",1,1,2,0)
===========
"PKG",197,22,1,"PAH",1,1,3,0)
 
"PKG",197,22,1,"PAH",1,1,4,0)
This patch contains four Inpatient Medications V. 5.0 fixes that sites
"PKG",197,22,1,"PAH",1,1,5,0)
logged during the compliance date period for the CPRS (Computerized 
"PKG",197,22,1,"PAH",1,1,6,0)
Patient Record System) GUI v27 release.
"PKG",197,22,1,"PAH",1,1,7,0)
 
"PKG",197,22,1,"PAH",1,1,8,0)
 
"PKG",197,22,1,"PAH",1,1,9,0)
1. The first issue, Remedy Ticket HD280022, pertains to Day of Week
"PKG",197,22,1,"PAH",1,1,10,0)
schedules entered for IV Piggyback orders via the CPRS IV Fluids Dialog.
"PKG",197,22,1,"PAH",1,1,11,0)
If the user creates a schedule using the schedule builder, and uses the
"PKG",197,22,1,"PAH",1,1,12,0)
new format of Day of Week@Schedule (example: MO-WE-FR@BID), and if the
"PKG",197,22,1,"PAH",1,1,13,0)
root schedule (MO-WE-FR) exists in the ADMINISTRATION SCHEDULE File 
"PKG",197,22,1,"PAH",1,1,14,0)
(#51.1), when the order is viewed in backdoor pharmacy, the
"PKG",197,22,1,"PAH",1,1,15,0)
administration time(s) for the order will be null.
"PKG",197,22,1,"PAH",1,1,16,0)
 
"PKG",197,22,1,"PAH",1,1,17,0)
Problem:
"PKG",197,22,1,"PAH",1,1,18,0)
--------
"PKG",197,22,1,"PAH",1,1,19,0)
Admin times are null if a Day of Week schedule created via the schedule
"PKG",197,22,1,"PAH",1,1,20,0)
builder in CPRS exists in the ADMINISTRATION SCHEDULE File (#51.1).
"PKG",197,22,1,"PAH",1,1,21,0)
 
"PKG",197,22,1,"PAH",1,1,22,0)
Resolution:
"PKG",197,22,1,"PAH",1,1,23,0)
-----------
"PKG",197,22,1,"PAH",1,1,24,0)
In PSGS0, do not QUIT before the admin times are set if the schedule
"PKG",197,22,1,"PAH",1,1,25,0)
is a Day of Week schedule, even if it exists in the schedule file.
"PKG",197,22,1,"PAH",1,1,26,0)
 
"PKG",197,22,1,"PAH",1,1,27,0)
 
"PKG",197,22,1,"PAH",1,1,28,0)
2. The second issue, Remedy Ticket HD246438 and its duplicates, is also 
"PKG",197,22,1,"PAH",1,1,29,0)
logged as Patient Safety Issue PSI-08-068,PSPO #782.  This is an issue
"PKG",197,22,1,"PAH",1,1,30,0)
with an invalid frequency for IV Piggyback orders.  This issue has existed
"PKG",197,22,1,"PAH",1,1,31,0)
prior to the release of CPRS GUI v27, but the sites are reporting an
"PKG",197,22,1,"PAH",1,1,32,0)
increase in the occurrence of the problem after the install of CPRS GUI 
"PKG",197,22,1,"PAH",1,1,33,0)
v27. For unknown reasons, the frequency of some IV Piggyback orders is 
"PKG",197,22,1,"PAH",1,1,34,0)
null when it should contain a value.
"PKG",197,22,1,"PAH",1,1,35,0)
 
"PKG",197,22,1,"PAH",1,1,36,0)
No site or developer has been able to 
"PKG",197,22,1,"PAH",1,1,37,0)
reproduce this issue at-will, and there does not appear to be any
"PKG",197,22,1,"PAH",1,1,38,0)
pattern to the processes or procedures that precede the occurrence of this
"PKG",197,22,1,"PAH",1,1,39,0)
problem. With this patch, if the frequency for an IV Piggyback order is
"PKG",197,22,1,"PAH",1,1,40,0)
null, and it should contain a value, the code will attempt to directly
"PKG",197,22,1,"PAH",1,1,41,0)
set an appropriate frequency into the PHARMACY PATIENT File (#55) upon
"PKG",197,22,1,"PAH",1,1,42,0)
verification of the order, and upon the order becoming active.
"PKG",197,22,1,"PAH",1,1,43,0)
 
"PKG",197,22,1,"PAH",1,1,44,0)
Problem:
"PKG",197,22,1,"PAH",1,1,45,0)
--------
"PKG",197,22,1,"PAH",1,1,46,0)
The frequency is being set to null very sporadically for IV Piggyback
"PKG",197,22,1,"PAH",1,1,47,0)
orders.  No root cause is known.
"PKG",197,22,1,"PAH",1,1,48,0)
 
"PKG",197,22,1,"PAH",1,1,49,0)
Resolution:
"PKG",197,22,1,"PAH",1,1,50,0)
-----------
"PKG",197,22,1,"PAH",1,1,51,0)
During the verification process, if the IV is intermittent, and the
"PKG",197,22,1,"PAH",1,1,52,0)
frequency is null, attempt to re-set the frequency based on the name
"PKG",197,22,1,"PAH",1,1,53,0)
of the schedule as well as other variables that should
"PKG",197,22,1,"PAH",1,1,54,0)
contain the value of the frequency.  These changes are in routine 
"PKG",197,22,1,"PAH",1,1,55,0)
PSIVORFB.
"PKG",197,22,1,"PAH",1,1,56,0)
 
"PKG",197,22,1,"PAH",1,1,57,0)
3. The third issue, Remedy Ticket HD274682 and its duplicates, is an
"PKG",197,22,1,"PAH",1,1,58,0)
undefined variable error in the new Meds Tab sort for CPRS.  The root
"PKG",197,22,1,"PAH",1,1,59,0)
cause of the problem is that a pointer to the PHARMACY ORDERABLE ITEM File
"PKG",197,22,1,"PAH",1,1,60,0)
(#50.7) is missing in either the NON-VERIFIED ORDERS File (#53.1) or the
"PKG",197,22,1,"PAH",1,1,61,0)
PHARMACY PATIENT File (#55).  Because the pointer does not exist, when
"PKG",197,22,1,"PAH",1,1,62,0)
a temporary global is being built to display the orders for the patient, 
"PKG",197,22,1,"PAH",1,1,63,0)
an undefined variable error occurs.
"PKG",197,22,1,"PAH",1,1,64,0)
 
"PKG",197,22,1,"PAH",1,1,65,0)
 
"PKG",197,22,1,"PAH",1,1,66,0)
Problem:
"PKG",197,22,1,"PAH",1,1,67,0)
--------
"PKG",197,22,1,"PAH",1,1,68,0)
Very old orders exist in the system that do not contain a pointer to
"PKG",197,22,1,"PAH",1,1,69,0)
the orderable item.  When the new Meds Tab sort routines attempt to
"PKG",197,22,1,"PAH",1,1,70,0)
use the pointer value as a subscript in a ^TMP global setting, and the
"PKG",197,22,1,"PAH",1,1,71,0)
pointer's value is null, a null subscript error occurs.  This causes
"PKG",197,22,1,"PAH",1,1,72,0)
a hard error in CPRS and shuts CPRS down.
"PKG",197,22,1,"PAH",1,1,73,0)
 
"PKG",197,22,1,"PAH",1,1,74,0)
Resolution:
"PKG",197,22,1,"PAH",1,1,75,0)
-----------
"PKG",197,22,1,"PAH",1,1,76,0)
If the pointer to the orderable item does not exist, the routines will
"PKG",197,22,1,"PAH",1,1,77,0)
use the phrase "Orderable Item Not Found" as the subscript value in place
"PKG",197,22,1,"PAH",1,1,78,0)
of what should be the name of the orderable item.  This allows the Meds
"PKG",197,22,1,"PAH",1,1,79,0)
Tab sort routines to process without error, and the patient's medications
"PKG",197,22,1,"PAH",1,1,80,0)
appear without problems on the CPRS Meds tab.  The updated routines are
"PKG",197,22,1,"PAH",1,1,81,0)
PSJORRO, PSJORRN, and PSJORRN1.
"PKG",197,22,1,"PAH",1,1,82,0)
 
"PKG",197,22,1,"PAH",1,1,83,0)
4. The fourth issue addressed by this patch is Remedy Ticket HD280040, 
"PKG",197,22,1,"PAH",1,1,84,0)
which deals with an inconsistency between CPRS and backdoor pharmacy
"PKG",197,22,1,"PAH",1,1,85,0)
with respect to continuous IV orders. 
"PKG",197,22,1,"PAH",1,1,86,0)
 
"PKG",197,22,1,"PAH",1,1,87,0)
If the IV order originates from CPRS, a
"PKG",197,22,1,"PAH",1,1,88,0)
fractional infusion rate of < 1 ml/hr (0.9 ml/hr for example), backdoor
"PKG",197,22,1,"PAH",1,1,89,0)
pharmacy allows the infusion rate, and the order can be finished and
"PKG",197,22,1,"PAH",1,1,90,0)
verified without issue.  However, if the order originates from backdoor
"PKG",197,22,1,"PAH",1,1,91,0)
pharmacy, a fractional infusion rate < 1 ml/hr is not accepted, and the
"PKG",197,22,1,"PAH",1,1,92,0)
user is presented a message "Invalid Infusion Rate", and they cannot
"PKG",197,22,1,"PAH",1,1,93,0)
finish and verify the order.  This patch will make backdoor pharmacy
"PKG",197,22,1,"PAH",1,1,94,0)
behave consistently with CPRS.
"PKG",197,22,1,"PAH",1,1,95,0)
 
"PKG",197,22,1,"PAH",1,1,96,0)
Problem:
"PKG",197,22,1,"PAH",1,1,97,0)
--------
"PKG",197,22,1,"PAH",1,1,98,0)
If an order is entered via backdoor pharmacy for a continuous IV, and the
"PKG",197,22,1,"PAH",1,1,99,0)
order is created with a fractional infusion rate of < 1 ml/hr, the system
"PKG",197,22,1,"PAH",1,1,100,0)
presents the user with the error message, "Your infusion rate is in an
"PKG",197,22,1,"PAH",1,1,101,0)
invalid format", and the order cannot be completed.
"PKG",197,22,1,"PAH",1,1,102,0)
 
"PKG",197,22,1,"PAH",1,1,103,0)
Resolution:
"PKG",197,22,1,"PAH",1,1,104,0)
-----------
"PKG",197,22,1,"PAH",1,1,105,0)
If the order has a fractional infusion rate < 1 ml/hr, the order must
"PKG",197,22,1,"PAH",1,1,106,0)
contain a leading zero, and the system will view the infusion rate as
"PKG",197,22,1,"PAH",1,1,107,0)
valid.  (example - infusion rate must be 0.9 ml/hr to be valid)
"PKG",197,22,1,"PAH",1,1,108,0)
The coding will affect routines PSIVSP, PSIVCHK, and PSIVORE.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","PSGS0")
0^1^B50790637^B51528600
"RTN","PSGS0",1,0)
PSGS0 ;BIR/CML3-SCHEDULE PROCESSOR ;29 Jan 99 / 8:04 AM
"RTN","PSGS0",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**12,25,26,50,63,74,83,116,110,111,133,138,174,134,213**;16 DEC 97;Build 8
"RTN","PSGS0",3,0)
 ;
"RTN","PSGS0",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA 2177
"RTN","PSGS0",5,0)
 ; Reference to ^PS(55   is supported by DBIA 2191
"RTN","PSGS0",6,0)
 ;
"RTN","PSGS0",7,0)
ENA ; entry point for train option
"RTN","PSGS0",8,0)
 D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGS0",9,0)
 F  S (PSGS0Y,PSGS0XT)="" R !!,"Select STANDARD SCHEDULE: ",X:DTIME W:'$T $C(7) S:'$T X="^" Q:"^"[X  D:X?1."?" ENQ^PSGSH I X'?1."?" D EN W:$D(X)[0 $C(7),"  ??" I $D(X)#2,'PSGS0Y,PSGS0XT W "  Every ",PSGS0XT," minutes"
"RTN","PSGS0",10,0)
 K DIC,DIE,PSGS0XT,PSGS0Y,Q,X,Y,PSGDT Q
"RTN","PSGS0",11,0)
 ;
"RTN","PSGS0",12,0)
EN3 ;
"RTN","PSGS0",13,0)
 S PSGST=$P($G(^PS(53.1,DA,0)),"^",7) G EN
"RTN","PSGS0",14,0)
 ;
"RTN","PSGS0",15,0)
EN5 ;
"RTN","PSGS0",16,0)
 S PSGST=$P($G(^PS(55,DA(1),5,DA,0)),"^",7)
"RTN","PSGS0",17,0)
 ;
"RTN","PSGS0",18,0)
EN ; validate
"RTN","PSGS0",19,0)
 K PSGS0Y
"RTN","PSGS0",20,0)
 I X[""""!($A(X)=45)!(X?.E1C.E)!($L(X)>70)!($L(X)<1) K X Q
"RTN","PSGS0",21,0)
 S X=$$TRIM^XLFSTR(X,"R"," ")
"RTN","PSGS0",22,0)
 I X?.E1L.E S X=$$ENLU^PSGMI(X) I '$D(PSGOES) D EN^DDIOL("  ("_X_")")
"RTN","PSGS0",23,0)
 ;
"RTN","PSGS0",24,0)
ENOS ; order set entry
"RTN","PSGS0",25,0)
 N X0,Y0,PSJXI,PSJDIC2,TMPAT
"RTN","PSGS0",26,0)
 I $G(X)="",$G(P(2)),$G(P(3)) S X=$G(P(9))
"RTN","PSGS0",27,0)
 I $G(X)="" Q
"RTN","PSGS0",28,0)
 S PSGXT=$G(PSGS0XT),(PSGS0XT,PSGS0Y,XT,Y,PSJNSS)=""
"RTN","PSGS0",29,0)
 S X0=X I X?2.4N1"-".E!(X?2.4N) D ENCHK S:$D(X) Y=X G Q
"RTN","PSGS0",30,0)
 ; * GUI 27 CHANGES * Check for admin times to be derived from 'base' schedule
"RTN","PSGS0",31,0)
 I X["@" S TMPAT=$P(X,"@",2) I TMPAT]"" D
"RTN","PSGS0",32,0)
 .I '$D(^PS(51.1,"AC","PSJ",TMPAT)) K TMPAT Q
"RTN","PSGS0",33,0)
 .I '$$DOW^PSIVUTL($P(X,"@")) K TMPAT Q
"RTN","PSGS0",34,0)
 .N LYN,ZZND,PSGS0XT,PSGS0Y,X S (PSGS0Y,PSGS0XT,X)=""
"RTN","PSGS0",35,0)
 .S X=TMPAT D DIC I $G(Y0)>0 S TMPAT=Y0
"RTN","PSGS0",36,0)
 I $G(TMPAT) S (PSGS0Y,$P(X,"@",2))=TMPAT,PSGS0XT="D"
"RTN","PSGS0",37,0)
 ; * GUI 27 CHANGES *
"RTN","PSGS0",38,0)
 I X["PRN",$$PRNOK(X),'$D(^PS(51.1,"AC","PSJ",X)) D  G Q
"RTN","PSGS0",39,0)
 .I X["@"!$$DOW^PSIVUTL($P(X," PRN")) N DOW D  I $G(DOW) S (Y0,Y,PSGS0Y)=$P($P(X,"@",2)," ")
"RTN","PSGS0",40,0)
 ..N TMP S TMP=X N X S X=$P(TMP," PRN") D DW I $G(X)]"" S DOW=1
"RTN","PSGS0",41,0)
 ..I $G(DOW),$G(PSGST)]"" I ",P,R,"'[(","_PSGST_",") S (XT,PSGS0XT)="D"
"RTN","PSGS0",42,0)
 D DIC I $G(XT)]""!$G(Y0)!($G(X)]""&$G(PSJXI)) D
"RTN","PSGS0",43,0)
 .S PSGS0XT=XT S:$G(Y0) (Y,PSGS0Y)=Y0 S:'PSGS0Y&((PSGS0XT)="D")&(X["@") PSGS0Y=$P(X,"@",2)
"RTN","PSGS0",44,0)
 .S PSGS0Y=$P(PSGS0Y," ")
"RTN","PSGS0",45,0)
 N TMPSCHX S TMPSCHX=X I $L(X,"@")<3 S TMPX=X D DW I $G(X)]"" K PSJNSS S (PSGS0XT,XT)="D" D  G Q
"RTN","PSGS0",46,0)
 .S Y=$S(($G(TMPSCHX)["@"):$P(TMPSCHX,"@",2),1:"")
"RTN","PSGS0",47,0)
 .I Y,(X'["@"),(TMPSCHX["@") S X=TMPSCHX
"RTN","PSGS0",48,0)
 S X=TMPSCHX
"RTN","PSGS0",49,0)
 I X'="" I $D(^PS(51.1,"AC","PSJ",X)) K PSJNSS G Q
"RTN","PSGS0",50,0)
 ;
"RTN","PSGS0",51,0)
NS I ($G(X)="^")!($G(X)="") K X S Y="" Q
"RTN","PSGS0",52,0)
 N NS S NS=0,PSJNSS=0
"RTN","PSGS0",53,0)
 I $G(Y)'>0 S X=X0,Y="",NS=1,PSJNSS=1
"RTN","PSGS0",54,0)
Q ;
"RTN","PSGS0",55,0)
 S PSGS0XT=$S(XT]"":XT,1:$G(PSGS0XT)),PSGS0Y=$S($G(Y):Y,$G(PSGS0Y):PSGS0Y,1:"") S:PSGS0XT<0 PSGS0XT=""
"RTN","PSGS0",56,0)
 I ('$G(PSGS0Y)&'$G(PSJDIC2)&$G(PSGAT))&'$G(PSJNEWOE)&$G(PSGS0XT) I PSGS0XT<1441 I ($L($G(PSGAT),"-")=PSGS0XT/1440)!($G(X)]""&($G(PSGSCH)=$G(X))) S PSGS0Y=$G(PSGAT)
"RTN","PSGS0",57,0)
Q2 K YY
"RTN","PSGS0",58,0)
 I '$G(PSJNSS),'$G(PSGS0Y),$G(YY) S PSGS0Y=YY
"RTN","PSGS0",59,0)
 I $G(X)]"",$$SCHREQ^PSJLIVFD(.P) D
"RTN","PSGS0",60,0)
 .I $$DOW^PSIVUTL(X)!$$PRNOK(X)!$D(^PS(51.1,"AC","PSJ",X)) S PSJNSS=0 Q
"RTN","PSGS0",61,0)
 .I $G(P(2))&$G(P(3)) D NSSCONT(X,PSGS0XT) S TMPX="" K X
"RTN","PSGS0",62,0)
 I ($G(PSJNSS)&($G(VALMBCK)'="Q"))!($G(PSJNSS)&$G(PSJLIFNI))!($G(PSJNSS)&$G(PSJTUD)) D
"RTN","PSGS0",63,0)
 .I $G(P(2))&$G(P(3)) Q
"RTN","PSGS0",64,0)
 .I ($G(X)]"") I ($G(PSGS0XT)'="D") D NSSCONT(X,PSGS0XT) S TMPX="" K X
"RTN","PSGS0",65,0)
Q3 I $G(X)]"" I $D(^PS(51.1,"AC","PSJ",X)) K PSJNSS
"RTN","PSGS0",66,0)
 K QX,SDW,SWD,X0,XT,Z Q
"RTN","PSGS0",67,0)
 ;
"RTN","PSGS0",68,0)
NSSCONT(SCH,FREQ) ;
"RTN","PSGS0",69,0)
 Q:SCH=""!($G(VALMBCK)]"")!$G(PSGMARSD)!$G(PSIVFN1)
"RTN","PSGS0",70,0)
 I $G(PSGOES),'$G(NSFF) Q
"RTN","PSGS0",71,0)
 N PSGS0XT,PSGSCH,DIR,X,Y S PSGSCH=SCH,PSGS0XT=FREQ,PSJNSS=1
"RTN","PSGS0",72,0)
 D NSSMSG I ($L(PSJNSS)>2),'$G(PSJXI) W !!,PSJNSS,! S PSJNSS=1
"RTN","PSGS0",73,0)
 S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSGS0",74,0)
 K NSFF Q
"RTN","PSGS0",75,0)
 ;
"RTN","PSGS0",76,0)
NSSMSG ;
"RTN","PSGS0",77,0)
 Q:$G(PSJXI)
"RTN","PSGS0",78,0)
 I '(",O,"[(","_$G(PSGST)_",")),$G(PSJNSS),$G(PSGSCH)]"" D
"RTN","PSGS0",79,0)
 .S PSJNSS=" WARNING - "_PSGSCH_" is an invalid schedule."
"RTN","PSGS0",80,0)
 S PSGSCH="",PSGS0XT=""
"RTN","PSGS0",81,0)
 Q
"RTN","PSGS0",82,0)
 ;
"RTN","PSGS0",83,0)
NSO(FQ) ;
"RTN","PSGS0",84,0)
 Q:'FQ!(FQ<0)!(",D,O,"[(","_$G(PSGST)_",")) ""
"RTN","PSGS0",85,0)
 K FRQOUT S FRQOUT=$S(FQ<60:(FQ_"minute"),(FQ<1440)&(FQ#60):(FQ_" minute"),(FQ<1440)!(FQ#1440):(FQ/60_" hour"),1:(FQ/1440_" day")) D
"RTN","PSGS0",86,0)
 . S:(+FRQOUT'=1) FRQOUT=FRQOUT_"s"
"RTN","PSGS0",87,0)
 Q FRQOUT
"RTN","PSGS0",88,0)
 ;
"RTN","PSGS0",89,0)
ENCHK ;
"RTN","PSGS0",90,0)
 I $S($L($P(X,"-"))>4:1,$L(X)>119:1,$L(X)<2:1,X'>0:1,1:X'?.ANP) K X Q
"RTN","PSGS0",91,0)
 S X(1)=$P(X,"-") I X(1)'?2N,X(1)'?4N K X Q
"RTN","PSGS0",92,0)
 S X(1)=$L(X(1)) I X'["-"&((X>$E(2400,1,X(1))!($E(X,3,4)>59))) K X Q
"RTN","PSGS0",93,0)
 F X(2)=2:1:$L(X,"-") S X(3)=$P(X,"-",X(2)) I $S($L(X(3))'=X(1):1,X(3)>$E(2400,1,X(1)):1,$E(X(3),3,4)>59:1,1:X(3)'>$P(X,"-",X(2)-1)) K X Q
"RTN","PSGS0",94,0)
 K:$D(X) X(1),X(2),X(3) Q
"RTN","PSGS0",95,0)
 ;
"RTN","PSGS0",96,0)
DIC ; Check for schedule's existence in ADMINISTRATION SCHEDULE file (#51.1)
"RTN","PSGS0",97,0)
 ; Input:    
"RTN","PSGS0",98,0)
 ;           X = Schedule Name
"RTN","PSGS0",99,0)
 ;     PSJSLUP = If $G(PSJSLUP), perform interactive fileman lookup (optional).
"RTN","PSGS0",100,0)
 ;     PSGSFLG = If $G(PSGSFLG), return schedule IEN in PSGSCIEN variable (optional)
"RTN","PSGS0",101,0)
 ;    PSJLIFNI = Flag indicating a U/D order is being finished as an IV (optional).
"RTN","PSGS0",102,0)
 ;      PSGOES = If PSGOES=1, IX^DIC is called silently. If PSGOES=2, IX^DIC is not called (optional).
"RTN","PSGS0",103,0)
 ;      PSJPWD = IEN of Inpatient Ward associated with the patient/order/schedule combination (optional).
"RTN","PSGS0",104,0)
 ; Output:
"RTN","PSGS0",105,0)
 ;           X = Schedule Name if valid Input Schedule X, undefined if invalid Input Schedule X.
"RTN","PSGS0",106,0)
 ;     PSGS0XT = Frequency of validated schedule.
"RTN","PSGS0",107,0)
 ;     PSGS0Y  = Default Admin Times of validated schedule.
"RTN","PSGS0",108,0)
 ;    PSGSCIEN = IEN of validated schedule, if PSGSLFG is passed in and is evaluated to TRUE.
"RTN","PSGS0",109,0)
 ;     
"RTN","PSGS0",110,0)
 ;
"RTN","PSGS0",111,0)
 K Y0,PSJXI N Y
"RTN","PSGS0",112,0)
 S Z=0 F PSJXI=0:1 S Z=$O(^PS(51.1,"AC","PSJ",X,Z)) Q:'Z
"RTN","PSGS0",113,0)
 I $G(X)]"",'$G(PSJSLUP) D
"RTN","PSGS0",114,0)
 .I $D(^PS(51.1,"AC","PSJ",X)) D  Q:$G(PSGS0Y)&($G(PSGS0XT)]"")
"RTN","PSGS0",115,0)
 ..I $$DOW^PSIVUTL(X) S PSGS0XT="D",PSJNSS=0 S:X["@" (Y0,PSGS0Y)=$P(X,"@",2) Q
"RTN","PSGS0",116,0)
 ..I $G(NSFF) S Y0=$S($G(PSGS0Y):PSGS0Y,$G(PSGAT)&'$G(PSJNEWOE):PSGAT,1:"") S:Y0 PSGS0Y=Y0
"RTN","PSGS0",117,0)
 .; Check for duplicate schedules - force selection
"RTN","PSGS0",118,0)
 .Q:PSJXI>1&('$G(PSGOES))&($G(PSGS0XT)]"")
"RTN","PSGS0",119,0)
 .I $D(^PS(51.1,"AC","PSJ",X)) N FREQ,ADMATCH S FREQ=$G(PSGS0XT) D
"RTN","PSGS0",120,0)
 ..N PSGS0XT,PSGS0Y,PSGST D ADMIN^PSJORPOE S:$G(PSGS0XT) XT=PSGS0XT S:$G(PSGS0Y) (Y0,Y)=PSGS0Y
"RTN","PSGS0",121,0)
 ..;Check flag PSGSFLG to determine whether to return the schedule IEN in PSGSCIEN.
"RTN","PSGS0",122,0)
 .S:$G(XT)]"" PSGS0XT=XT S:$G(Y) PSGS0Y=Y
"RTN","PSGS0",123,0)
 .I $$DOW^PSIVUTL(X) S:PSGS0XT="" (XT,PSGS0XT)="D" S:PSGS0Y="" (Y0,PSGS0Y)=$S($P(X,"@",2):$P(X,"@",2),1:"")
"RTN","PSGS0",124,0)
 I $G(PSJLIFNI)!($G(P(4))]""&($G(P(2))]"")) I '$D(^PS(51.1,"AC","PSJ",X))!($G(PSJXI)>1) S PSJSLUP=1
"RTN","PSGS0",125,0)
 I $G(NSFF),$G(PSJXI)>1 D
"RTN","PSGS0",126,0)
 .I $G(PSGS0XT)="",$G(NSFF),$G(PSGXT)]"" S PSGS0XT=PSGXT Q
"RTN","PSGS0",127,0)
 .I $G(PSGS0XT)=""!($G(PSGS0Y)="") S PSJSLUP=1
"RTN","PSGS0",128,0)
 I '$G(PSJSLUP) Q:$G(PSGS0XT)]""&($G(PSGS0Y)]"")  Q:($G(PSGS0XT)="D"&('$D(^PS(51.1,"AC","PSJ",X))))
"RTN","PSGS0",129,0)
 Q:$G(PSGOES)=2
"RTN","PSGS0",130,0)
 Q:$G(PSGS0XT)]""&(PSJXI=1)
"RTN","PSGS0",131,0)
 K PSJSLUP
"RTN","PSGS0",132,0)
 ;
"RTN","PSGS0",133,0)
 K DIC S DIC="^PS(51.1,",DIC(0)=$E("E",'$D(PSGOES))_"ISZ",DIC("W")="W ""  "","_$S('$D(PSJPWD):"$P(^(0),""^"",2)",'PSJPWD:"$P(^(0),""^"",2)",1:"$S($D(^PS(51.1,+Y,1,+PSJPWD,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"),D="APPSJ"
"RTN","PSGS0",134,0)
 I $D(PSGST) ;S DIC("S")="I $P(^(0),""^"",5)"_$E("'",PSGST'="O")_"=""O"""
"RTN","PSGS0",135,0)
 S PSJDIC2=1
"RTN","PSGS0",136,0)
 D IX^DIC K DIC S:$D(DIE)#2 DIC=DIE I Y'>0 D  Q
"RTN","PSGS0",137,0)
 .I '$$DOW^PSIVUTL(X),'$$PRNOK(X) S X="",PSJNSS=1,XT="",PSJXI=""
"RTN","PSGS0",138,0)
 S XT=$S("C"[$P(Y(0),"^",5):$P(Y(0),"^",3),1:$P(Y(0),"^",5))
"RTN","PSGS0",139,0)
 S X=+Y,Y="" I $D(PSJPWD),$D(^PS(51.1,+X,1,+PSJPWD,0)) S Y=$P(^(0),"^",2)
"RTN","PSGS0",140,0)
 ;Check flag PSGSFLG to determine whether to return the schedule IEN in PSGSCIEN.
"RTN","PSGS0",141,0)
 I $G(PSGSFLG) S PSGSCIEN=X
"RTN","PSGS0",142,0)
 S (X,X0)=Y(0,0) S:$G(Y)="" Y=$P(Y(0),"^",2)
"RTN","PSGS0",143,0)
 S (PSGS0Y,Y0)=$G(Y),Y0(0)=Y(0) I $P(Y(0),"^",3) S XT=$P(Y(0),"^",3)
"RTN","PSGS0",144,0)
 I $G(PSGS0XT)="",$$DOW^PSIVUTL(X) S (XT,PSGS0XT)="D"
"RTN","PSGS0",145,0)
 Q
"RTN","PSGS0",146,0)
 ;
"RTN","PSGS0",147,0)
DW ;
"RTN","PSGS0",148,0)
 N Y
"RTN","PSGS0",149,0)
 Q:($L(X,"@")>2)
"RTN","PSGS0",150,0)
 N AT I X["@" S AT=$P(X,"@",2)
"RTN","PSGS0",151,0)
 S SWD="SUNDAYS^MONDAYS^TUESDAYS^WEDNESDAYS^THURSDAYS^FRIDAYS^SATURDAYS",SDW=X,X=$P(X,"@",2) N XABB S XABB=""
"RTN","PSGS0",152,0)
 I X]"" D ENCHK Q:'$D(X)
"RTN","PSGS0",153,0)
 S X=$P(SDW,"@"),X(1)="-" I X?.E1P.E,X'["-"  ;F QX=1:1:$L(X) I $E(X,QX)?1P S X(1)=$E(X,QX) Q
"RTN","PSGS0",154,0)
 F Q=1:1:$L(X,X(1)) K:SWD="" X Q:SWD=""  S Z=$P(X,X(1),Q) D DWC Q:'$D(X)
"RTN","PSGS0",155,0)
 I $D(X) F II=1:1:$L(X,X(1)) S XABB=$G(XABB)_$E($P(X,X(1),II),1,2)_"-"
"RTN","PSGS0",156,0)
 K X(1) S:$D(X) X=SDW I $G(X)]"" I $TR(XABB,"-")]"" S X=$E($G(XABB),1,$L(XABB)-1)
"RTN","PSGS0",157,0)
 I $G(AT) S PSGS0Y=AT
"RTN","PSGS0",158,0)
 Q
"RTN","PSGS0",159,0)
DWC I $L(Z)<2 K X Q
"RTN","PSGS0",160,0)
 F QX=1:1:$L(SWD,"^") S Y=$P(SWD,"^",QX) I $P(Y,Z)="" S SWD=$P(SWD,Y,2) S:$L(SWD) SWD=$E(SWD,2,50) Q
"RTN","PSGS0",161,0)
 E  K X
"RTN","PSGS0",162,0)
 Q
"RTN","PSGS0",163,0)
 ;
"RTN","PSGS0",164,0)
PRNOK(PSCH) ;
"RTN","PSGS0",165,0)
 Q:PSCH'["PRN" 0
"RTN","PSGS0",166,0)
 I $TR(PSCH," ")="PRN" Q 1
"RTN","PSGS0",167,0)
 N BASE,I,OK S OK=0 S I=$P(PSCH," PRN") I I]"",$D(^PS(51.1,"AC","PSJ",I)) S OK=1
"RTN","PSGS0",168,0)
 I 'OK D
"RTN","PSGS0",169,0)
 .I PSCH["@" I $D(^PS(51.1,"AC","PSJ",$P(PSCH,"@")))!$$DOW^PSIVUTL($P(PSCH,"@")) S OK=1 Q
"RTN","PSGS0",170,0)
 .I $$DOW^PSIVUTL($P(PSCH," PRN")) S OK=1
"RTN","PSGS0",171,0)
 Q OK
"RTN","PSGS0",172,0)
ODD(PSF) ;determine if this is an odd schedule
"RTN","PSGS0",173,0)
 I PSF>1439,PSF#1440 Q 1
"RTN","PSGS0",174,0)
 I PSF,PSF<1440,1440#PSF Q 1
"RTN","PSGS0",175,0)
 Q 0
"RTN","PSIVCHK")
0^9^B15710201^B15887140
"RTN","PSIVCHK",1,0)
PSIVCHK ;BIR/PR,MLM-CHECK ORDER FOR INTEGRITY ;12 DEC 97 / 10:16 AM
"RTN","PSIVCHK",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**54,58,81,111,213**;16 DEC 97;Build 8
"RTN","PSIVCHK",3,0)
 ;
"RTN","PSIVCHK",4,0)
 ; Reference to ^PS(51.1 supported by DBIA# 2177.
"RTN","PSIVCHK",5,0)
 ; Reference to ^DIE supported by DBIA# 2053.
"RTN","PSIVCHK",6,0)
 ;
"RTN","PSIVCHK",7,0)
 ;Need DFN and ON
"RTN","PSIVCHK",8,0)
 W ! S ERR=0,P("TYP")=P(4) S:P("TYP")="C" P("TYP")=P(23) I P("TYP")="S" S P("TYP")=$S(+P(5):"P",1:"A")
"RTN","PSIVCHK",9,0)
 I '+P("MR") W !,"*** You have not specified a med route! ",! S ERR=1
"RTN","PSIVCHK",10,0)
 I P(11)]"" S X=P(11) D CHK^DIE(51.1,1,"",X,.PSJTIM) I PSJTIM="^" W !,"*** Your administration time(s) are in an invalid format !" S ERR=1
"RTN","PSIVCHK",11,0)
M I P(15)<0 S ERR=1 W !,"*** Time interval between doses is less than zero !"
"RTN","PSIVCHK",12,0)
 NEW X S X=0 S:P(9)]"" X=$O(^PS(51.1,"APPSJ",P(9),0))
"RTN","PSIVCHK",13,0)
 N XX F XX=2,3 I $P(P(XX),".",2)=""!($L(P(XX))>12) S ERR=1 W !,"*** ",$S(XX=2:"Start",1:"Stop")," date is in an invalid format or must contain time !"
"RTN","PSIVCHK",14,0)
 I P(2)>P(3) S ERR=1 W !,"*** Start date/time CANNOT be greater than the stop date/time"
"RTN","PSIVCHK",15,0)
 I $$SCHREQ^PSJLIVFD(.P),'X D
"RTN","PSIVCHK",16,0)
 .N PSJXSTMP S PSJXSTMP=P(9) I PSJXSTMP="" S ERR=1 Q
"RTN","PSIVCHK",17,0)
 .N X,Y,PSGS0XT,PSGS0Y,PSGOES S PSGOES=2,X=PSJXSTMP D ENOS^PSGS0 I $G(X)]""&($G(X)=$G(PSJXSTMP)) Q
"RTN","PSIVCHK",18,0)
 .W !," *** WARNING -- Missing or Invalid Schedule ...",! S ERR=1
"RTN","PSIVCHK",19,0)
INF I P(8)="","AH"[P("TYP") S ERR=1 W !,"*** You have no infusion rate defined !"
"RTN","PSIVCHK",20,0)
 I "AH"[P("TYP"),P(8)'?1N.N.1".".1N1" ml/hr",P(8)'?.E1"@"1N.N,P(8)'?1"0."1N1" ml/hr" S ERR=1 W !,"*** Your infusion rate is in an invalid format !"
"RTN","PSIVCHK",21,0)
 I P(8)="",P("TYP")="P" S:'ERR ERR=2 W !,"*** WARNING -- You have not specified an infusion rate. "
"RTN","PSIVCHK",22,0)
 I '$$CODES1^PSIVUTL(P("TYP"),55.01,.04)!(P("TYP")="") S ERR=1 W !,"*** Type of order is invalid !"
"RTN","PSIVCHK",23,0)
 I '$$CODES1^PSIVUTL(P(17),55.01,100)!(P(17)="") S ERR=1 W !,"*** Status of order is invalid !"
"RTN","PSIVCHK",24,0)
AH ;
"RTN","PSIVCHK",25,0)
 I "HA"[P("TYP"),(P(11)]""!(P(9)]"")) W !,$C(7),"Order type is an admixture, hyperal, or continuous syringe, and you have",!,"a schedule and/or administration times defined!"
"RTN","PSIVCHK",26,0)
 I  F Q=0:0 W !,"Ok to delete these fields" S %=1 D YN^DICN D NULSET Q:%
"RTN","PSIVCHK",27,0)
 K % I P(6)="" S ERR=1 W !,"*** You have not entered a physician!"
"RTN","PSIVCHK",28,0)
 I P(6)]"",'$D(^VA(200,+P(6),"PS")) S ERR=1 W !,"*** Physician entered does not exist or is not authorized to write",!,"medication orders"
"RTN","PSIVCHK",29,0)
 I P(6)]"",$D(^VA(200,+P(6),"PS")),(+$P(^("PS"),U,4)),($P(^("PS"),U,4)'>DT) S ERR=1 W !,"*** Physician entered is no longer active."
"RTN","PSIVCHK",30,0)
 D ^PSIVCHK1
"RTN","PSIVCHK",31,0)
 Q
"RTN","PSIVCHK",32,0)
 ;
"RTN","PSIVCHK",33,0)
NULSET ;Delete admin/schedule fields for hyperals and/or admixtures
"RTN","PSIVCHK",34,0)
 I '% W !!?2,"Enter 'YES' to delete the schedule and/or administration times fields from",!,"this order.  Enter 'NO' (or '^') to leave the fields intact.",! Q
"RTN","PSIVCHK",35,0)
 S:%=1 P(9)="",P(11)=""
"RTN","PSIVCHK",36,0)
 Q
"RTN","PSIVCHK",37,0)
CKO S P16=0,PSIVEXAM=1,PSIVCT=1 D PSIVCHK S PSIVNOL=1 W ! D ^PSIVORLB K PSIVEXAM Q:'ERR
"RTN","PSIVCHK",38,0)
 I ERR=2 F J=0:0 W !!,"Since there is a warning with this order.",!,"do you wish to re-edit this order" S %=1 D YN^DICN Q:%  W !!,"Answer 'YES' to re-edit this order."
"RTN","PSIVCHK",39,0)
 I ERR=2,%=1 S PSIVOK="57^58^59^26^39^63^64^62^10^25^1" D ^PSIVORV2,GSTRING^PSIVORE1,GTFLDS^PSIVORFE K DA,DIE,DR G CKO
"RTN","PSIVCHK",40,0)
 Q
"RTN","PSIVORE")
0^8^B41910420^B41482525
"RTN","PSIVORE",1,0)
PSIVORE ;BIR/PR,MLM-ORDER ENTRY ; 4/1/08 2:37pm
"RTN","PSIVORE",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**18,29,50,56,58,81,110,127,133,157,203,213**;16 DEC 97;Build 8
"RTN","PSIVORE",3,0)
 ;
"RTN","PSIVORE",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191
"RTN","PSIVORE",5,0)
 ; Reference to ^ORX2 is supported by DBIA #867
"RTN","PSIVORE",6,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVORE",7,0)
 ; Reference to ^DICN is supported by DBIA 10009.
"RTN","PSIVORE",8,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSIVORE",9,0)
 ; Reference to EN^VALM is supported by DBIA 10118.
"RTN","PSIVORE",10,0)
 ; Reference to ^VADPT is supported by DBIA 10061.
"RTN","PSIVORE",11,0)
 ;
"RTN","PSIVORE",12,0)
 N PSJNEW,PSJOUT,PSGPTMP,PPAGE,FLAG S PSJNEW=1
"RTN","PSIVORE",13,0)
 ;
"RTN","PSIVORE",14,0)
 D SITE Q:'$G(PSIVQ)  K PSIVQ S PSGOP=""
"RTN","PSIVORE",15,0)
 ;
"RTN","PSIVORE",16,0)
BEG ;Get patient and make sure he is living.
"RTN","PSIVORE",17,0)
 L +^PS(53.45,DUZ):1 E  D LOCKERR^PSJOE G Q
"RTN","PSIVORE",18,0)
 ;* F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  D ASK
"RTN","PSIVORE",19,0)
 ;* F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  S X=DFN_";DPT(" D LK^ORX2 Q:'Y  D ASK S X=DFN_";DPT(" D ULK^ORX2
"RTN","PSIVORE",20,0)
 NEW PSJLK
"RTN","PSIVORE",21,0)
 F  K WSCHADM S PSGPTMP=0,PPAGE=1 D ENGETP^PSIV Q:DFN<0  S PSJLK='$$L^PSSLOCK(DFN,1) Q:PSJLK  D ASK,UL^PSSLOCK(DFN)
"RTN","PSIVORE",22,0)
 I PSGOP,$P(PSJSYSL,"^",2)]"" D ENQL^PSGLW
"RTN","PSIVORE",23,0)
 G Q
"RTN","PSIVORE",24,0)
 ;
"RTN","PSIVORE",25,0)
ASK ;See if patient has been admitted.
"RTN","PSIVORE",26,0)
 I VADM(6) W !?5,"Patient has died." Q
"RTN","PSIVORE",27,0)
 I 'VAIN(4) K DIK S DIR(0)="Y",DIR("A")="Do you wish to continue",DIR("B")="NO",DIR("??")="^S HELP=""ADMYN"" D ^PSIVHLP1" W !,"This patient has not been admitted." D ^DIR K DIR Q:'Y
"RTN","PSIVORE",28,0)
 S:VAIN(4) WSCHADM=+VAIN(4)
"RTN","PSIVORE",29,0)
 ;
"RTN","PSIVORE",30,0)
SETN ;Set up patient 0 node if needed.
"RTN","PSIVORE",31,0)
 I '$D(^PS(55,DFN,0)) K DO,DA,DD,DIC,PSIVFN S:$D(^(5.1)) PSIVFN=^(5.1) K:$D(PSIVFN) ^(5.1) S (DINUM,X)=DFN,DIC(0)="L",DIC="^PS(55," D FILE^DICN S:$D(PSIVFN) ^PS(55,DFN,5.1)=PSIVFN D  K DIC,PSIVFN,DO,DA,DD,DINUM
"RTN","PSIVORE",32,0)
 .; Mark PSJ and PSO as converted
"RTN","PSIVORE",33,0)
 .S $P(^PS(55,DFN,5.1),"^",11)=2
"RTN","PSIVORE",34,0)
 S PSJNARC=1
"RTN","PSIVORE",35,0)
 S PSGP=DFN,PSJPWD=+VAIN(4),PSIVAC="P",PSIVBR="D ^PSIVOPT" D HK,ENCHS1^PSIV Q:'$D(DFN)
"RTN","PSIVORE",36,0)
 Q
"RTN","PSIVORE",37,0)
 ;
"RTN","PSIVORE",38,0)
NEW ;Ask to enter new order.
"RTN","PSIVORE",39,0)
 D:'$D(VADM(1)) DEM^VADPT
"RTN","PSIVORE",40,0)
 K P,PSIVCHG,PSIVTYPE,PSJOE,DIR S DIR(0)="Y",DIR("A")="New order for "_VADM(1),DIR("B")="YES",DIR("??")="^S HELP=""NEWORD"" D ^PSIVHLP" D ^DIR K DIR Q:'Y
"RTN","PSIVORE",41,0)
 NEW X S X=DFN_";DPT(" D LK^ORX2 Q:'Y  S PSJLSORX=1
"RTN","PSIVORE",42,0)
INMED K ON55,PSJOUT S (P(4),P("OT"),P("FRES"))="" D NEW55^PSIVORFB I '$D(ON55) D ULK G:'$D(PSJOE)&('$D(PSJOUT)) NEW G Q
"RTN","PSIVORE",43,0)
 S P("RES")="N",PSIVAC="PN",P("PON")=ON55,PSIVUP=+$$GTPCI^PSIVUTL D NEW^PSIVORE2 I $G(P(2))="" D DEL55^PSIVORE2 D ULK G:'$D(PSJOE) NEW Q
"RTN","PSIVORE",44,0)
 D OK L -^PS(55,DFN,"IV",+ON55) D ULK G:'$D(PSJOE) NEW
"RTN","PSIVORE",45,0)
 ;
"RTN","PSIVORE",46,0)
Q ; Kill and exit.
"RTN","PSIVORE",47,0)
 L:'$D(PSJOE) -^PS(53.45,DUZ) S PSJNKF=1 D Q^PSIV
"RTN","PSIVORE",48,0)
 K FIL,I1,ND,PC,PDM,PSGDT,PSGID,PSGLMT,PSGSI,PSJNARC,PSIVAC,PSIVCHG,PSIVUP,PSIVX,PSJOPC
"RTN","PSIVORE",49,0)
 Q
"RTN","PSIVORE",50,0)
 ;
"RTN","PSIVORE",51,0)
ULK ;
"RTN","PSIVORE",52,0)
 Q:'$G(PSJLSORX)  ;If NEW^PSIVORE did not lock, don't kill it here.
"RTN","PSIVORE",53,0)
 NEW X S X=DFN_";DPT(" D ULK^ORX2 K PSJLSORX
"RTN","PSIVORE",54,0)
 Q
"RTN","PSIVORE",55,0)
HK ;Queue job to print MAR labels generated for this patient.
"RTN","PSIVORE",56,0)
 I PSGOP,PSGOP'=DFN D
"RTN","PSIVORE",57,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSIVORE",58,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,U,2)]"" ENQL^PSGLW
"RTN","PSIVORE",59,0)
 S PSGOP=DFN
"RTN","PSIVORE",60,0)
 Q
"RTN","PSIVORE",61,0)
 ;
"RTN","PSIVORE",62,0)
SITE ;See if site parameters are ok.
"RTN","PSIVORE",63,0)
 K PSIVQ D ^PSIVXU Q:$D(XQUIT)
"RTN","PSIVORE",64,0)
 I '$D(PSIVSN)!('$D(PSIVSITE)) W $C(7),$C(7),!!,"You have no IV ROOM parameters ... PLEASE ... PLEASE ...",!,"Exit this package and reenter properly !!",!! Q
"RTN","PSIVORE",65,0)
 D ORPARM^PSIVOREN S PSIVQ=1
"RTN","PSIVORE",66,0)
 Q
"RTN","PSIVORE",67,0)
 ;
"RTN","PSIVORE",68,0)
OK ;Print example label, run order through checker, ask if it is ok.
"RTN","PSIVORE",69,0)
 S P16=0,PSIVEXAM=1,(PSIVNOL,PSIVCT)=1 D GTOT^PSIVUTL(P(4)) I $G(P("PD"))="" D GTPD^PSIVORE2
"RTN","PSIVORE",70,0)
 D ^PSIVCHK I $D(DUOUT) S X="^" G DOA
"RTN","PSIVORE",71,0)
 I ERR=1 S X="N" G BAD
"RTN","PSIVORE",72,0)
 W ! D ^PSIVORLB K PSIVEXAM S Y=P(2) W !,"Start date: " X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),?30," Stop date: " S Y=P(3) X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),!
"RTN","PSIVORE",73,0)
 ;PSJ*5*157 EFD for IVs
"RTN","PSIVORE",74,0)
 D EFDIV^PSJUTL($G(ZZND))
"RTN","PSIVORE",75,0)
 W:$G(PSIVCHG) !,"*** This change will cause a new order to be created. ***"
"RTN","PSIVORE",76,0)
 I '$G(PSIVCOPY) G:PSIVAC["R" OK1 S X="Is this O.K.: ^"_$S(ERR:"NO",1:"YES")_"^^NO"_$S(ERR'=1:",YES",1:"") D ENQ^PSIV
"RTN","PSIVORE",77,0)
 S PSJIVBD=1 ;var use to indicate order enter from back door
"RTN","PSIVORE",78,0)
BAD ;; I X["N" D GSTRING^PSIVORE1,^PSIVORV2,GTFLDS^PSIVORFE G OK
"RTN","PSIVORE",79,0)
 I ON55["V",($G(P(21))="") S P(17)="N"
"RTN","PSIVORE",80,0)
 I X["N" NEW PSGEBN,PSGLI S (P("INS"),PSGEBN,PSGLI)="",(PSJORD,ON)=ON55 D EN^VALM("PSJ LM IV AC/EDIT") S VALMBCK="Q" Q
"RTN","PSIVORE",81,0)
 I X["?" S HELP="OK" D ^PSIVHLP G OK
"RTN","PSIVORE",82,0)
DOA I X["^" D DEL55^PSIVORE2 Q
"RTN","PSIVORE",83,0)
 Q:$$NONVF("SN")
"RTN","PSIVORE",84,0)
OK1 S PSJORL=$$ENORL^PSJUTL($G(VAIN(4))),P(17)="A",ORSTS=6,ON=ON55,PSJORNP=+P(6)
"RTN","PSIVORE",85,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN
"RTN","PSIVORE",86,0)
 I PSJIVORF D NATURE^PSIVOREN I '$D(P("NAT")) D DEL55^PSIVORE2 Q
"RTN","PSIVORE",87,0)
 D SET55^PSIVORFB
"RTN","PSIVORE",88,0)
 I PSJIVORF,($G(P(22))=.5) D CLINIC^PSIVOREN
"RTN","PSIVORE",89,0)
 I PSJIVORF D SET^PSIVORFE S ORNATR=P("NAT"),ON=+ON55,OD=P(2) D EN1^PSJHL2(DFN,"SN",+ON55_"V","SEND ORDER NUMBER") ;,EN1^PSJHL2(DFN,"SC",+ON55_"V","NEW ORDER CREATED")
"RTN","PSIVORE",90,0)
 D VF1^PSJLIACT("V","ORDER ENTERED AS ACTIVE BY ",1)
"RTN","PSIVORE",91,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"N")
"RTN","PSIVORE",92,0)
 ;
"RTN","PSIVORE",93,0)
CAL ;Calculate doses.
"RTN","PSIVORE",94,0)
 ;S OD=P(2) D EN,^PSIVORE1,^PSIVOPT
"RTN","PSIVORE",95,0)
 S OD=P(2) D EN,^PSIVOPT
"RTN","PSIVORE",96,0)
 Q
"RTN","PSIVORE",97,0)
 ;
"RTN","PSIVORE",98,0)
EN ;Update schedule interval P(15) only on continuous orders.
"RTN","PSIVORE",99,0)
 ;This includes Hyp/Adm/Continuous Syringes/Chemos =>P(5)=0
"RTN","PSIVORE",100,0)
 Q:'$D(DFN)!('$D(ON55))  Q:$P(^PS(55,DFN,"IV",+ON55,0),U,4)="P"!($P(^(0),U,5))!($P(^(0),U,23)="P")
"RTN","PSIVORE",101,0)
 D SPSOL S XXX=$P(^PS(55,DFN,"IV",+ON55,0),U,8) G:'SPSOL ENQ I XXX?1N.N.1".".N1" ml/hr"!(XXX?1"0."1N1" ml/hr") S P(15)=$S('XXX:0,1:SPSOL\XXX*60+(SPSOL#XXX/XXX*60+.5)\1),$P(^PS(55,DFN,"IV",+ON55,0),U,15)=P(15) G ENQ
"RTN","PSIVORE",102,0)
 S P(15)=$S('$P(XXX,"@",2):0,1:1440/$P(XXX,"@",2)\1),$P(^PS(55,DFN,"IV",+ON55,0),U,15)=P(15)
"RTN","PSIVORE",103,0)
ENQ K SPSOL,XXX Q
"RTN","PSIVORE",104,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(^PS(55,DFN,"IV",+ON55,"SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(^(XXX,0),U,2)
"RTN","PSIVORE",105,0)
 K XXX Q
"RTN","PSIVORE",106,0)
ENIN ;Entry for Combined IV/UD order entry. Called by PSJOE0.
"RTN","PSIVORE",107,0)
 D HOLDHDR^PSJOE
"RTN","PSIVORE",108,0)
 W !
"RTN","PSIVORE",109,0)
 N PSJOUT S (DONE,FLAG)=0,PSIVAC="PN"
"RTN","PSIVORE",110,0)
ENIN1 ;
"RTN","PSIVORE",111,0)
 N DA,DIR,PSJOE,PSJPCAF,PSJSYSL,WSCHADM S:$G(VAIN(4)) WSCHADM=VAIN(4)
"RTN","PSIVORE",112,0)
 K P,PSIVCHG,PSJCOM
"RTN","PSIVORE",113,0)
 S PSJOE=1,DIR(0)="55.01,.04O",DIR("A")="Select IV TYPE" D ^DIR
"RTN","PSIVORE",114,0)
 I X]"",X'="^",$P("^PROFILE",X)="" S PSJOEPF=X Q
"RTN","PSIVORE",115,0)
 S:$D(DTOUT) X="^" I "^"[X S PSJORQF=PSJORQF+$S(X="^":2,$G(FLAG):0,1:1),X="." Q
"RTN","PSIVORE",116,0)
 S FLAG=1,PSIVTYPE=Y,(P(5),P(23))="" I "SC"[Y D @(Y_"^PSIVORC1") S $P(PSIVTYPE,U,2)=P(23)
"RTN","PSIVORE",117,0)
 D INMED G:'$D(PSJOUT) ENIN S:$D(PSJOUT) PSJORQF=2
"RTN","PSIVORE",118,0)
 Q
"RTN","PSIVORE",119,0)
NONVF(PSJOC)  ;If file at NonVF then quit with 1
"RTN","PSIVORE",120,0)
 NEW PSGOEAV S PSGOEAV=+$P(PSJSYSP0,U,9)
"RTN","PSIVORE",121,0)
 I +PSJSYSU=3,PSGOEAV Q 0
"RTN","PSIVORE",122,0)
 I +PSJSYSU=1,PSGOEAV Q 0
"RTN","PSIVORE",123,0)
 K DA D ENGNN^PSGOETO S ON=DA_"P",P(17)="N",P("REN")=0
"RTN","PSIVORE",124,0)
 D GTPD^PSIVORE2
"RTN","PSIVORE",125,0)
 D NATURE^PSIVOREN I '$D(P("NAT")) D:ON55["V" DEL55 Q 1
"RTN","PSIVORE",126,0)
 D:$G(VAIN(4))="" CLINIC^PSIVOREN
"RTN","PSIVORE",127,0)
 W !,"...transcribing this non-verified order...."
"RTN","PSIVORE",128,0)
 D PUT531^PSIVORFA
"RTN","PSIVORE",129,0)
 D:$G(PSJOC)]"" EN1^PSJHL2(DFN,PSJOC,ON,"SEND ORDER NUMBER")
"RTN","PSIVORE",130,0)
 D:ON55["V" DEL55
"RTN","PSIVORE",131,0)
 NEW PSJORD S (ON55,PSJORD)=ON
"RTN","PSIVORE",132,0)
 D VF^PSIVORC2
"RTN","PSIVORE",133,0)
 Q 1
"RTN","PSIVORE",134,0)
DEL55 ;
"RTN","PSIVORE",135,0)
 Q:ON55["P"
"RTN","PSIVORE",136,0)
 S X=$G(^PS(55,DFN,"IV",+ON55,0))
"RTN","PSIVORE",137,0)
 I $P(X,U,21)]"",($G(^PS(55,DFN,"IV",+ON55,2))]"") S $P(^(2),U,6)=ON,$P(^PS(53.1,+ON,0),U,25)=ON55 Q
"RTN","PSIVORE",138,0)
 NEW PSIVORFA S PSIVORFA=1
"RTN","PSIVORE",139,0)
 D DEL55^PSIVORE2
"RTN","PSIVORE",140,0)
 Q 
"RTN","PSIVORFB")
0^2^B55183274^B50190472
"RTN","PSIVORFB",1,0)
PSIVORFB ;BIR/MLM-FILE/RETRIEVE ORDERS IN ^PS(55 ;25 Sep 98 / 2:24 PM
"RTN","PSIVORFB",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**3,18,28,68,58,85,110,111,120,134,213**;16 DEC 97;Build 8
"RTN","PSIVORFB",3,0)
 ;
"RTN","PSIVORFB",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSIVORFB",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA #2178.
"RTN","PSIVORFB",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA #1231.
"RTN","PSIVORFB",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA #2173.
"RTN","PSIVORFB",8,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSIVORFB",9,0)
 ; Reference to ^PS(51.1 is supported by DBIA#  #2177.
"RTN","PSIVORFB",10,0)
 ; 
"RTN","PSIVORFB",11,0)
NEW55 ; Get new order number in 55.
"RTN","PSIVORFB",12,0)
 N DA,DD,DO,DIC,DLAYGO,X,Y,PSIVLIM,MINS,PSJDSTP1,PSJDSTP2,A,PSJCLIN,PSJDNM,PSJPROV,PSJWARD,PSJPAO,PSJALRT
"RTN","PSIVORFB",13,0)
 I $D(^PS(55,+DFN)),'$D(^PS(55,+DFN,0)) D ENSET0^PSGNE3(+DFN)
"RTN","PSIVORFB",14,0)
 I $G(PSJORD)["V"!($G(PSJORD)["P"),$G(P(2))]"" D LIMSTOP(.PSJDSTP1,.PSJDSTP2)
"RTN","PSIVORFB",15,0)
 I ($G(PSJORD)["P"!($G(PSJORD)["V"))&$G(PSIVLIM) I $$CMPLIM(PSJORD,PSJDSTP1,PSJDSTP2) D
"RTN","PSIVORFB",16,0)
 . D
"RTN","PSIVORFB",17,0)
 .. S PSJPROV=DUZ I PSJORD["P" S PSJPROV=$P($G(^PS(53.1,+PSJORD,0)),"^",2)
"RTN","PSIVORFB",18,0)
 .. I PSJORD["V" S PSJPROV=$P($G(^PS(55,DFN,"IV",+PSJORD,0)),"^",6)
"RTN","PSIVORFB",19,0)
 .. D NOW^%DTC S XQA(PSJPROV)="",XQAID="PSJ,"_DFN_";"_PSJPROV_";"_%,XQADATA=""
"RTN","PSIVORFB",20,0)
 .. D
"RTN","PSIVORFB",21,0)
 ... I PSJORD["P" S A=$G(^PS(53.1,+PSJORD,"DSS"))
"RTN","PSIVORFB",22,0)
 ... I PSJORD["V" S A=$G(^PS(55,PSGP,"IV",+PSJORD,"DSS"))
"RTN","PSIVORFB",23,0)
 ... S PSJCLIN=$P(A,"^") I PSJCLIN]"" S PSJCLIN=$P(^SC(PSJCLIN,0),"^")
"RTN","PSIVORFB",24,0)
 .. S A=$G(^DPT(DFN,0)),PSJWARD=$G(^(.1))
"RTN","PSIVORFB",25,0)
 .. S XQAMSG=$P(A,"^")_" ("_$E($P(A,"^"))_$E($P(A,"^",9),6,9)_"): ["_$S(PSJWARD]"":$E(PSJWARD,1,10),$G(PSJCLIN)]"":$E(PSJCLIN,1,10),1:"UNKNOWN")_"] "
"RTN","PSIVORFB",26,0)
 .. S A=$O(DRG("AD",0)) I A]"" S A=DRG("AD",A)
"RTN","PSIVORFB",27,0)
 .. I A="" S A=$O(DRG("SOL",0)) I A]"" S A=DRG("SOL",A)
"RTN","PSIVORFB",28,0)
 .. S PSJDNM=$P(^PS(50.7,+$P(A,"^",6),0),"^")
"RTN","PSIVORFB",29,0)
 .. S XQAMSG=XQAMSG_PSJDNM_" your DURATION not used for stop date/time"
"RTN","PSIVORFB",30,0)
 .. D SETUP^XQALERT
"RTN","PSIVORFB",31,0)
 .. S PSJALRT=$$FMTDUR^PSJLIVMD($S(PSJORD["P":$P($G(^PS(53.1,+PSJORD,2.5)),"^",4),PSJORD["IV":$P($G(^PS(55,DFN,"IV",+PSJORD,2.5)),"^",4),1:"UNK"))
"RTN","PSIVORFB",32,0)
 S DIC="^PS(55,",DIC(0)="LN",DLAYGO=55,(DINUM,X)=+DFN D ^DIC Q:Y<0
"RTN","PSIVORFB",33,0)
LOCK0 F  L +^PS(55,DFN,"IV",0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSIVORFB",34,0)
 S ND=$S($D(^PS(55,DFN,"IV",0)):^(0),1:"^55.01") F DA=$P(ND,"^",3)+1:1 W "." I '$D(^PS(55,DFN,"IV",DA)) S $P(ND,"^",3)=DA,$P(ND,"^",4)=$P(ND,"^",4)+1,^PS(55,DFN,"IV",0)=ND Q
"RTN","PSIVORFB",35,0)
 L +^PS(55,DFN,"IV",+DA):$S($G(DILOCKTM)>0:DILOCKTM,1:3) E  G LOCK0
"RTN","PSIVORFB",36,0)
 S ^PS(55,DFN,"IV",+DA,0)=+DA,^PS(55,DFN,"IV","B",+DA,+DA)=""
"RTN","PSIVORFB",37,0)
 L -^PS(55,DFN,"IV",0) S ON55=+DA_"V"
"RTN","PSIVORFB",38,0)
 I $G(PSJALRT)]"" S PSIVAL="IV LIMIT OVERRIDDEN ("_$G(PSJALRT)_"): ALERT SENT",PSIVALT="",PSIVREA="E" D
"RTN","PSIVORFB",39,0)
 .D LOG^PSIVORAL S P("LIMIT")="",P("OVRIDE")=1 K IVLIM,IVLIMIT
"RTN","PSIVORFB",40,0)
 .S $P(^PS(55,DFN,"IV",+ON55,2.5),"^",4)="" S:$G(PSJORD)["P" $P(^PS(53.1,+PSJORD,2.5),"^",4)=""
"RTN","PSIVORFB",41,0)
 .K PSIVAL,PSIVREA,PSIVALT
"RTN","PSIVORFB",42,0)
 Q
"RTN","PSIVORFB",43,0)
SET55 ; Move data from local variables to 55.
"RTN","PSIVORFB",44,0)
 I '$D(ON55) W !,"*** Can't create this order at this time ***" Q
"RTN","PSIVORFB",45,0)
 N DA,DIK,ND,PSIVACT,PSIVDUR
"RTN","PSIVORFB",46,0)
 S:'$D(P(21)) (P(21),P("21FLG"))="" S ND(0)=+ON55,P(22)=$S(VAIN(4):+VAIN(4),1:.5) F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSIVORFB",47,0)
 S ND(.3)=$G(P("INS")),ND(2.5)="" N X S X=$S($G(PSGORD):PSGORD,1:$G(ON)) I X D
"RTN","PSIVORFB",48,0)
 .N PKG S PKG=$E(X,$L(X)) S PKG=$S(PKG="V":"""IV""",PKG="U":5,PKG="P":"P",1:"") Q:PKG=""
"RTN","PSIVORFB",49,0)
 .S PSIVDUR=$$GETDUR^PSJLIVMD(DFN,+X,$E(X,$L(X)),1) Q:PSIVDUR=""
"RTN","PSIVORFB",50,0)
 .I $G(IVLIMIT) S ND(2.5)="^^^"_PSIVDUR K IVLIMIT Q
"RTN","PSIVORFB",51,0)
 S $P(ND(0),U,17)="A",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(P("NAT"))_U_U_U_$G(P("PRNTON"))
"RTN","PSIVORFB",52,0)
 F X=0,1,2.5,3,.2,.3 S ^PS(55,DFN,"IV",+ON55,X)=ND(X)
"RTN","PSIVORFB",53,0)
 ; PSJ*5*213 - if Piggyback and frequency is null, attempt to
"RTN","PSIVORFB",54,0)
 ; set frequency again based on schedule.
"RTN","PSIVORFB",55,0)
 I $P($G(ND(0)),U,4)="P",$P($G(ND(0)),U,15)="" S $P(^PS(55,DFN,"IV",+ON55,0),U,15)=$$GETFRQ($P($G(ND(0)),U,9)) K PSJFRQ,PSJSKED
"RTN","PSIVORFB",56,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,1,4)=P("LOG")_U_+P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSIVORFB",57,0)
 S X=^PS(55,DFN,0) I $P(X,"^",7)="" S $P(X,"^",7)=$P($P(P("LOG"),"^"),"."),$P(X,"^",8)="A",^(0)=X
"RTN","PSIVORFB",58,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,11)=+P("CLRK")
"RTN","PSIVORFB",59,0)
 S:+$G(P("CLIN")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=P("CLIN")
"RTN","PSIVORFB",60,0)
 S:+$G(P("APPT")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^",2)=P("APPT")
"RTN","PSIVORFB",61,0)
 S:+$G(P("NINIT")) ^PS(55,DFN,"IV",+ON55,4)=P("NINIT")_U_P("NINITDT")
"RTN","PSIVORFB",62,0)
 I '$G(PSIVCHG)!($G(PSJREN)&($G(PSIVCHG)=2)) I $G(P("PON")),P("PON")'=ON55 D
"RTN","PSIVORFB",63,0)
 . N X S X=$S(P("PON")["P":"^PS(53.1,+P(""PON""),12,0)",P("PON")["V"&$G(PSJREN):"^PS(55,DFN,""IV"",+P(""PON""),5,0)",1:"") Q:X=""
"RTN","PSIVORFB",64,0)
 . I $O(@X) S %X=X,%Y="^PS(55,"_DFN_",""IV"","_+ON55_",5," D %XY^%RCR
"RTN","PSIVORFB",65,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSIVORFB",66,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK
"RTN","PSIVORFB",67,0)
 I $G(PSJCOM),$G(PSJCOMSI),$G(PSJORD)["V" K PSJCOMSI N PSJCHILD,PSJOEORD S PSJOEORD=0 F  S PSJOEORD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD)) Q:'PSJOEORD  D
"RTN","PSIVORFB",68,0)
 . N PSJCHILD S PSJCHILD=0 F  S PSJCHILD=$O(^PS(55,"ACX",PSJCOM,PSJOEORD,PSJCHILD)) Q:'PSJCHILD  S PSJCHILD(+PSJCHILD)=PSJCOM
"RTN","PSIVORFB",69,0)
 . S PSJCHILD=0 F  S PSJCHILD=$O(PSJCHILD(PSJCHILD)) Q:'PSJCHILD  D
"RTN","PSIVORFB",70,0)
 .. Q:PSJCHILD=PSJORD  K DR,DA,DIE,ORD S DR="31////"_$P($G(P("OPI")),"^",1,2),DA(1)=DFN
"RTN","PSIVORFB",71,0)
 .. N ON,ON55 S (ON,ON55)=+PSJCHILD_"V" S:+$G(PSJPINIT)'>0 PSJPINIT=DUZ S PSIVALT=1,PSIVAL="COMPLEX ORDER" D ENTACT^PSIVAL D
"RTN","PSIVORFB",72,0)
 ... I $P($G(^PS(55,DFN,"IV",+ON55,3)),"^")'=$P(P("OPI"),"^") S P("FC")="OTHER PRINT INFO^"_$P($G(^(3)),"^")_U_$P(P("OPI"),"^") D GTFC^PSIVORAL
"RTN","PSIVORFB",73,0)
 ... I $D(^PS(55,DFN,"IV",+ON55,0)) S ^PS(55,DFN,"IV",+ON55,3)=P("OPI") D EN1^PSJHL2(DFN,"XX",ON55)
"RTN","PSIVORFB",74,0)
 Q
"RTN","PSIVORFB",75,0)
 ;
"RTN","PSIVORFB",76,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSIVORFB",77,0)
 K ^PS(55,DFN,"IV",+ON55,DRGT) S ^PS(55,DFN,"IV",+ON55,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSIVORFB",78,0)
 F X=0:0 S X=$O(DRG(DRGT,X)) Q:'X  D
"RTN","PSIVORFB",79,0)
 .S Y=^PS(55,DFN,"IV",+ON55,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSIVORFB",80,0)
 .S ^PS(55,DFN,"IV",+ON55,DRGT,0)=Y,Y=$P(DRG(DRGT,X),U)_U_$P(DRG(DRGT,X),U,3) S:DRGT="AD" $P(Y,U,3)=$P(DRG(DRGT,X),U,4) S ^PS(55,DFN,"IV",+ON55,DRGT,+DRG,0)=Y
"RTN","PSIVORFB",81,0)
 Q
"RTN","PSIVORFB",82,0)
GT55 ; Retrieve data from 55 into local array
"RTN","PSIVORFB",83,0)
 K DRG,DRGN,P S:'$D(ON55) ON55=ON S P("REN")="",Y=$G(^PS(55,DFN,"IV",+ON55,0)) F X=1:1:23 S P(X)=$P(Y,U,X)
"RTN","PSIVORFB",84,0)
 S P("21FLG")=P(21)
"RTN","PSIVORFB",85,0)
 S P("PON")=ON55,PSJORIFN=P(21),P(6)=P(6)_U_$P($G(^VA(200,+P(6),0)),U),(DRG,DRGN)="",P("REM")=$G(^PS(55,DFN,"IV",+ON55,1))
"RTN","PSIVORFB",86,0)
 S Y=$G(^PS(55,DFN,"IV",+ON55,2)),P("LOG")=$P(Y,U),P("IVRM")=$P(Y,U,2)_U_$P($G(^PS(59.5,+$P(Y,U,2),0)),U)
"RTN","PSIVORFB",87,0)
 S P("CLRK")=$P(Y,U,11)_U_$P($G(^VA(200,+$P(Y,U,11),0)),U),P("RES")=$P(Y,U,8),P("FRES")=$P(Y,U,9),P("SYRS")=$P(Y,U,4),P("OPI")=$G(^PS(55,DFN,"IV",+ON55,3))
"RTN","PSIVORFB",88,0)
 S P("INS")=$G(^PS(55,DFN,"IV",+ON55,.3))
"RTN","PSIVORFB",89,0)
 S P("CLIN")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^"),P("APPT")=$P($G(^PS(55,DFN,"IV",+ON55,"DSS")),"^",2)
"RTN","PSIVORFB",90,0)
 S P("DTYP")=$S(P(4)="":0,P(4)="P"!(P(23)="P")!(P(5)):1,P(4)="H":2,1:3)
"RTN","PSIVORFB",91,0)
 D:'$D(PSJLABEL) GTPC(ON55) S ND=$G(^PS(55,DFN,"IV",+ON55,.2)),P("PD")=$S($P(ND,U):$P(ND,U)_U_$$OIDF^PSJLMUT1(+ND)_U_$P($G(^PS(50.7,+ND,0)),U),1:""),P("DO")=$P(ND,U,2),P("PRY")=$P(ND,U,4),P("NAT")=$P(ND,U,5),(PSJCOM,P("PRNTON"))=$P(ND,U,8)
"RTN","PSIVORFB",92,0)
 I P("PRY")="D",'+P("IVRM") S P("IVRM")=+$G(PSIVSN)_U_$P($G(^PS(59.5,+$G(PSIVSN),0)),U)
"RTN","PSIVORFB",93,0)
 S P("MR")=$P(ND,U,3),ND=$G(^PS(51.2,+P("MR"),0)),P("MR")=P("MR")_U_$S($P(ND,U,3)]"":$P(ND,U,3),1:$P(ND,U)) D GTCUM
"RTN","PSIVORFB",94,0)
 D GTDRG,GTOT^PSIVUTL(P(4))
"RTN","PSIVORFB",95,0)
 N ND2P5 S ND2P5=$G(^PS(55,DFN,"IV",+ON55,2.5)) D
"RTN","PSIVORFB",96,0)
 .S P("DUR")=$P(ND2P5,"^",2)
"RTN","PSIVORFB",97,0)
 .S P("LIMIT")=$P(ND2P5,"^",4)
"RTN","PSIVORFB",98,0)
 .S P("IVCAT")=$P(ND2P5,"^",5)
"RTN","PSIVORFB",99,0)
K ; Kill and exit.
"RTN","PSIVORFB",100,0)
 K FIL,ND
"RTN","PSIVORFB",101,0)
 Q
"RTN","PSIVORFB",102,0)
GTDRG ; Get drug info and place in DRG(.
"RTN","PSIVORFB",103,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F Y=0:0 S Y=$O(^PS(55,DFN,"IV",+ON55,DRGT,Y)) Q:'Y  D
"RTN","PSIVORFB",104,0)
 .; naked ref below refers to line above
"RTN","PSIVORFB",105,0)
 .S DRG=$G(^(Y,0)),ND=$G(^PS(FIL,+DRG,0)),(DRGI,DRG(DRGT,0))=$G(DRG(DRGT,0))+1
"RTN","PSIVORFB",106,0)
 .S DRG(DRGT,+DRGI)=+DRG_U_$P(ND,U)_U_$P(DRG,U,2)_U_$P(DRG,U,3)_U_$P(ND,U,13)_U_$P(ND,U,11)
"RTN","PSIVORFB",107,0)
 Q
"RTN","PSIVORFB",108,0)
 ;
"RTN","PSIVORFB",109,0)
GTCUM ; Retrieve dispensing info.
"RTN","PSIVORFB",110,0)
 S ND=$G(^PS(55,DFN,"IV",+ON55,9)),P("LF")=$P(ND,U),P("LFA")=$P(ND,U,2),P("CUM")=$P(ND,U,3)
"RTN","PSIVORFB",111,0)
 Q
"RTN","PSIVORFB",112,0)
 ;
"RTN","PSIVORFB",113,0)
GTPC(ON) ; Retrieve Provider Comments and create "scratch" fields to edit
"RTN","PSIVORFB",114,0)
 Q
"RTN","PSIVORFB",115,0)
 ;
"RTN","PSIVORFB",116,0)
SETNEW ; Create new order and set
"RTN","PSIVORFB",117,0)
 D NEW55,SET55
"RTN","PSIVORFB",118,0)
 Q
"RTN","PSIVORFB",119,0)
 ;
"RTN","PSIVORFB",120,0)
CMPLIM(PSJORD,PSJDSTP1,PSJDSTP2) ; Compare stop date of order against IV Limit
"RTN","PSIVORFB",121,0)
 I $P($G(^PS(53.1,+PSJORD,0)),"^",25)]"" D CHKD Q:PSJPAO 0
"RTN","PSIVORFB",122,0)
 I $G(PSJDSTP1),$E(+PSJDSTP1,1,11)'=$E(+P(3),1,11),+PSJDSTP2'=+P(3) Q 1
"RTN","PSIVORFB",123,0)
 Q 0
"RTN","PSIVORFB",124,0)
 ;
"RTN","PSIVORFB",125,0)
LIMSTOP(PSJDSTP1,PSJDSTP2) ; Calculate default stop date using IV Limit
"RTN","PSIVORFB",126,0)
 ;      Output: PSJDSTP1 - Default stop using duration only
"RTN","PSIVORFB",127,0)
 ;              PSJDSTP2 - Default stop using duration and IV parameters for time
"RTN","PSIVORFB",128,0)
 S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",129,0)
 I 'PSIVLIM,PSIVLIM]"" S PSIVLIM=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD)
"RTN","PSIVORFB",130,0)
 I PSIVLIM]"" D
"RTN","PSIVORFB",131,0)
 . S MINS=$$GETMIN^PSIVCAL(PSIVLIM,DFN,PSJORD),PSJDSTP1=$$FMADD^XLFDT(P(2),,,MINS)
"RTN","PSIVORFB",132,0)
 . S X=$P(PSJDSTP1,"."),PSJDSTP2=X_$S($P(PSIVSITE,"^",14)="":.2359,1:"."_$P(PSIVSITE,"^",14))
"RTN","PSIVORFB",133,0)
 Q
"RTN","PSIVORFB",134,0)
 ;
"RTN","PSIVORFB",135,0)
GETFRQ(PSJSKED) ;GET FREQUENCY IF NULL
"RTN","PSIVORFB",136,0)
 I PSJSKED="" K PSJSKED Q ""
"RTN","PSIVORFB",137,0)
 S PSJFRQ=""
"RTN","PSIVORFB",138,0)
 I $D(^PS(51.1,"APPSJ",PSJSKED)) N X S X=""  F  S X=$O(^PS(51.1,"APPSJ",PSJSKED,X)) Q:X=""  D
"RTN","PSIVORFB",139,0)
 . Q:$G(PSJFRQ)'=""
"RTN","PSIVORFB",140,0)
 . I $P($G(^PS(51.1,X,0)),U,3)'="" S PSJFRQ=$P(^PS(51.1,X,0),U,3)
"RTN","PSIVORFB",141,0)
 Q PSJFRQ
"RTN","PSIVORFB",142,0)
 ;
"RTN","PSIVORFB",143,0)
CHKD ;Check for a previous active order and compare the duration
"RTN","PSIVORFB",144,0)
 N PSJPO,A,PSJDUR
"RTN","PSIVORFB",145,0)
 S PSJDUR=$$GETLIM^PSIVCAL(DFN,PSJORD)
"RTN","PSIVORFB",146,0)
 S PSJPAO=0,PSJPO=PSJORD
"RTN","PSIVORFB",147,0)
CHKDR S PSJPO=$P($G(^PS(53.1,+PSJPO,0)),"^",25) Q:PSJPO=""
"RTN","PSIVORFB",148,0)
 I PSJPO["P" G CHKDR
"RTN","PSIVORFB",149,0)
 I PSJPO["V" S PSIVLIM=$$GETLIM^PSIVCAL(DFN,PSJPO) I PSJDUR'=PSIVLIM S PSJPAO=1 Q
"RTN","PSIVORFB",150,0)
 G CHKDR
"RTN","PSIVSP")
0^3^B38850432^B37490534
"RTN","PSIVSP",1,0)
PSIVSP ;BIR/RGY,PR,CML3-DOSE PROCESSOR ;09 Feb 99 / 12:30 PM
"RTN","PSIVSP",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**30,37,41,50,56,74,83,111,133,138,134,213**;16 DEC 97;Build 8
"RTN","PSIVSP",3,0)
 ;
"RTN","PSIVSP",4,0)
 ; Reference to ^PS(51.1 is supported by DBIA #2177
"RTN","PSIVSP",5,0)
 ;
"RTN","PSIVSP",6,0)
EN ;
"RTN","PSIVSP",7,0)
 Q:'$D(X)
"RTN","PSIVSP",8,0)
 S ATZERO=0 I X["@",$P(X,"@",2)=0 S ATZERO=1,X=$P(X,"@")
"RTN","PSIVSP",9,0)
 D EN^PSGS0 S (P(9),PSIVSC1)=$S($G(X)]"":X,1:$G(P(9))),P(11)=$S($G(PSGS0Y):PSGS0Y,1:$G(P(11))),(XT,P(15))=$S(($G(PSGS0XT)!($G(PSGS0XT)="O")!($G(PSGS0XT)="D")):$G(PSGS0XT),1:$G(P(15)))
"RTN","PSIVSP",10,0)
 I $G(ATZERO) S P(7)=1
"RTN","PSIVSP",11,0)
 K ATZERO Q
"RTN","PSIVSP",12,0)
EN1 ;
"RTN","PSIVSP",13,0)
 S (PSIVAT,PSIVWAT,Y)="",XT=-1,X0=X,X=$S(X="ON CALL":X,X="ONCALL":X,X="ON-CALL":X,X="ONETIME":X,X="ONE-TIME":X,X="ONE TIME":X,X="1TIME":X,X="1 TIME":X,X="1-TIME":X,$L(X," ")<3:$P(X," "),1:$P(X," ",1,2))
"RTN","PSIVSP",14,0)
 S:$E(X)="^" X=$E(X,2,999) G:X="" Q S:X["@0" ATZERO=1 S X=$S(X["@0":$P(X,"@"),1:X),P(7)=$S($D(ATZERO):1,1:"") K ATZERO
"RTN","PSIVSP",15,0)
 I $S($D(^PS(51.1,"AC","PSJ",X)):1,1:$E($O(^(X)),1,$L(X))=X) D DIC I Y'<0 G SH
"RTN","PSIVSP",16,0)
NS0 S Y=""
"RTN","PSIVSP",17,0)
 I $E(X,1,2)="AD" S XT=-1 Q
"RTN","PSIVSP",18,0)
 I $E(X,1,3)="BID"!($E(X,1,3)="TID")!($E(X,1,3)="QID") S XT=1440\$F("BTQ",$E(X))
"RTN","PSIVSP",19,0)
 E  S:$E(X)="Q" X=$E(X,2,99) S:'X X=$E(X)["O"+1_X S I=+X,X=$P(X,I,2),XT=I*$S(X["'":1,(X["D"&(X'["AD"))!(X["AM")!(X["PM")!(X["HS"&(X'["THS")):1440,X["H"&(X'["TH"):60,X["AC"!(X["PC"):480,X["W":10080,X["M":40320,1:0),X=X0 D 
"RTN","PSIVSP",20,0)
 . I 'XT,X'="NOW",X'="STAT",X'="ONCE",X'="ONE-TIME",X'="ONE TIME",X'="ONETIME",X'="1-TIME",X'="1 TIME",X'="1TIME",Y="" S XT=-1
"RTN","PSIVSP",21,0)
SH ;
"RTN","PSIVSP",22,0)
 I +Y<1,$E(X0)'="^" W:$G(ON)'["P" "  ",$S(XT=0&($S("^NOW^STAT^ONCE^ONE-TIME^ONETIME^1TIME^1-TIME^"[(U_$P(X," ")_U):1,X["1 TIME":1,1:X["ONE TIME")):"(ONCE ONLY)",XT>0:"Nonstandard schedule",XT<0:"",1:"(??)") W:XT>0 " (",XT," MINUTES)"
"RTN","PSIVSP",23,0)
Q Q:X="ONE TIME"
"RTN","PSIVSP",24,0)
 N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X0," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 K X0 S:$G(P(7)) XT="" Q
"RTN","PSIVSP",25,0)
NEWQ ;N I S X0=$P(X," ")_$S($L(X0," ")-1:" ",1:"")_$P(X0," ",2,99) K:XT<0!($L(X0)>22) X S:$D(X) X=X0 S:P(7) X=X0 K X0 K:XT>0&('P(7)) X Q
"RTN","PSIVSP",26,0)
 Q
"RTN","PSIVSP",27,0)
 ;
"RTN","PSIVSP",28,0)
ENDL W "   Dose limit ....  " S PSIVMIN=P(15)*X,PSIVSD=+P(2)
"RTN","PSIVSP",29,0)
 I PSIVMIN<0 W !!," --- There is something wrong with this order !!",!,"     Call inpatient supervisor ....." S Y=-1 K PSIVMIN Q
"RTN","PSIVSP",30,0)
 I P(4)="P"!(P(5))!(P(23)="P"),PSIVMIN=0,"^NOW^STAT^ONCE^ONE-TIME^ONE TIME^ON CALL^ONETIME^1TIME^1 TIME^1-TIME^"'[(U_P(9)_U) D DLP G QDL
"RTN","PSIVSP",31,0)
 D ENT^PSIVWL
"RTN","PSIVSP",32,0)
QDL I $D(X) S X=Y X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2) S Y=X
"RTN","PSIVSP",33,0)
 Q
"RTN","PSIVSP",34,0)
DLP ;
"RTN","PSIVSP",35,0)
 S X=X+1,$P(PSIVSD,".",2)=$P(PSIVSD,".",2)_$E("0000",1,4-$L($P(PSIVSD,".",2))) D CHK S X2=0,Y=1 I X<2 S Y=+PSIVSD G QDLP
"RTN","PSIVSP",36,0)
 I $P(PSIVSD,".",2)>$P(P(11),"-",$L(P(11),"-")) S X2=1 G OV
"RTN","PSIVSP",37,0)
 G:$P(P(11),"-")>$P(PSIVSD,".",2) OV
"RTN","PSIVSP",38,0)
 F Y=1:1 S X1=$P(P(11),"-",Y) I X1=$P(PSIVSD,".",2)!($P(PSIVSD,".",2)<X1) Q
"RTN","PSIVSP",39,0)
OV I P(11)="" W $C(7)," ???",!?15,"*** You have not defined any administration times !!" K X Q
"RTN","PSIVSP",40,0)
 F Y=Y:1 S:$P(P(11),"-",Y)="" X2=X2+1,Y=0,X=X+1 S X=X-1 Q:X<1
"RTN","PSIVSP",41,0)
 S X=PSIVSD\1 I X2>0 S X1=PSIVSD D C^%DTC S X=$P(X,".") ; install with version 17.3 of fileman
"RTN","PSIVSP",42,0)
 S Y=+(X_"."_$P(P(11),"-",Y))
"RTN","PSIVSP",43,0)
QDLP K X1,X2 Q
"RTN","PSIVSP",44,0)
 ;
"RTN","PSIVSP",45,0)
ENI ;
"RTN","PSIVSP",46,0)
 K:$L(X)<1!($L(X)>30)!(X["""")!($A(X)=45) X I '$D(X)!'$D(P(4)) Q
"RTN","PSIVSP",47,0)
 I P(4)="P"!(P(5))!(P(23)="P") Q:'X  S X="INFUSE OVER "_X_" MINUTE"_$S(X>1:"S",1:"") W "   ",X Q
"RTN","PSIVSP",48,0)
 I $E(X)="." K X Q  ;Enforce leading zero.
"RTN","PSIVSP",49,0)
 I X'=+X!(X'=0_+X),X["@",($P(X,"@",2,999)'=+$P(X,"@",2,999)!(+$P(X,"@",2,999)<0)) K X Q
"RTN","PSIVSP",50,0)
 S SPSOL=$O(DRG("SOL",0)) I 'SPSOL K SPSOL,X W "  You must define at least one solution !!" Q
"RTN","PSIVSP",51,0)
 I X=+X!(X=0_+X),X'["@" S X=X_" ml/hr" W " ml/hr" D SPSOL S P(15)=$S('X:0,1:SPSOL\X*60+(SPSOL#X/X*60+.5)\1) K SPSOL Q
"RTN","PSIVSP",52,0)
 S SPSOL=$P(X,"@",2) S:$P(X,"@")=+X!($P(X,"@")=0_+X) $P(X,"@")=$P(X,"@")_" ml/hr" W "   ",+SPSOL," Label",$S(SPSOL'=1:"s",1:"")," per day",!?15,"at an infusion rate of: ",$P(X,"@") S P(15)=$S('SPSOL:0,1:1440/SPSOL\1) K SPSOL
"RTN","PSIVSP",53,0)
 I X["@",$P(X,"@",2)=0 S P(7)=1  ; Set ATZERO flag
"RTN","PSIVSP",54,0)
 Q
"RTN","PSIVSP",55,0)
SPSOL S SPSOL=0 F XXX=0:0 S XXX=$O(DRG("SOL",XXX)) Q:'XXX  S SPSOL=SPSOL+$P(DRG("SOL",XXX),U,3)
"RTN","PSIVSP",56,0)
 K XXX Q
"RTN","PSIVSP",57,0)
CHK F Y=1:1 Q:$L(P(11))>240!($P(P(11),"-",Y)="")  S $P(P(11),"-",Y)=$P(P(11),"-",Y)_$E("0000",1,4-$L($P(P(11),"-",Y)))
"RTN","PSIVSP",58,0)
 Q
"RTN","PSIVSP",59,0)
 ;
"RTN","PSIVSP",60,0)
DIC ; 51.1 look-up
"RTN","PSIVSP",61,0)
 N PSJSCH S PSJSCH=X I '$D(WSCHADM) N VAIP D IN5^VADPT S WSCHADM=VAIP(5),X=PSJSCH
"RTN","PSIVSP",62,0)
 K DIC S DIC="^PS(51.1,",DIC(0)=$E("E",'$D(NOECH))_"ISZ"
"RTN","PSIVSP",63,0)
 S DIC("W")="W ""  "","_$S('$D(WSCHADM):"$P(^(0),""^"",2)",'+WSCHADM:"$P(^(0),""^"",2)",1:"$S($D(^PS(51.1,+Y,1,+WSCHADM,0)):$P(^(0),""^"",2),1:$P(^PS(51.1,+Y,0),""^"",2))"),D="APPSJ" S:$D(PSIVSPQF) DIC(0)=DIC(0)_"O"
"RTN","PSIVSP",64,0)
 D IX^DIC K DIC
"RTN","PSIVSP",65,0)
 S:$D(DIE)#2 DIC=DIE Q:Y<0
"RTN","PSIVSP",66,0)
 S X=Y(0,0),ZZY=Y,(XT,Y)="" I $D(WSCHADM),$D(^PS(51.1,+ZZY,1,+WSCHADM,0)),$P(^(0),"^",2)]"" S (PSIVWAT,Y)=$P(^(0),"^",2)
"RTN","PSIVSP",67,0)
 K ZZY,WSCHADM S:Y="" (X,PSIVSC1)=$P(Y(0),U),(PSIVAT,Y)=$P(Y(0),"^",2) S XT=$P(Y(0),"^",3) Q
"RTN","PSIVSP",68,0)
 ;
"RTN","PSIVSP",69,0)
ORINF ;  OERR input transform for Infusion Rate
"RTN","PSIVSP",70,0)
 ;  X=data
"RTN","PSIVSP",71,0)
 N INFUSE
"RTN","PSIVSP",72,0)
 K:$L(X)<1!($L(X)>30)!(X["""")!($A(X)=45) X I '$D(X) Q
"RTN","PSIVSP",73,0)
 I X?.E1L.E S INFUSE=$$ENLU^PSGMI(X) Q:(INFUSE="TITRATE")!(INFUSE="BOLUS")!($P(INFUSE," ")="INFUSE")!($P(INFUSE," ")="Infuse")
"RTN","PSIVSP",74,0)
 Q:(X="TITRATE")!(X="BOLUS")!($P(X," ")="INFUSE")!($P(X," ")="Infuse")
"RTN","PSIVSP",75,0)
 I X["=" D  Q   ; NOIS LOU-0501-42191
"RTN","PSIVSP",76,0)
 .N X2,X1 S X1=$P(X,"="),X2=$P(X,"=",2)
"RTN","PSIVSP",77,0)
 .I X1["ML/HR",(+X1=$P(X1,"ML/HR"))!(+X1=$P(X1," ML/HR")) D
"RTN","PSIVSP",78,0)
 ..S X1=$TR(X1,"ML/HR","ml/hr")
"RTN","PSIVSP",79,0)
 .I X2["ML/HR",(+X2=$P(X2,"ML/HR"))!(+X2=$P(X2," ML/HR")) D
"RTN","PSIVSP",80,0)
 ..S X2=$TR(X2,"ML/HR","ml/hr")
"RTN","PSIVSP",81,0)
 .I X1[" ml/hr",(+X1=$P(X1," ml/hr")) D
"RTN","PSIVSP",82,0)
 ..S X1=$P(X1," ml/hr")_$P(X1," ml/hr",2,9999)
"RTN","PSIVSP",83,0)
 .I X2[" ml/hr",(+X2=$P(X2," ml/hr")) D
"RTN","PSIVSP",84,0)
 ..S X2=$P(X2," ml/hr")_$P(X2," ml/hr",2,9999)
"RTN","PSIVSP",85,0)
 .I X1["ml/hr",(+X1=$P(X1,"ml/hr")) D
"RTN","PSIVSP",86,0)
 ..S X1=$P(X1,"ml/hr")_$P(X1,"ml/hr",2,9999)
"RTN","PSIVSP",87,0)
 .I X2["ml/hr",(+X2=$P(X2,"ml/hr")) D
"RTN","PSIVSP",88,0)
 ..S X2=$P(X2,"ml/hr")_$P(X2,"ml/hr",2,9999)
"RTN","PSIVSP",89,0)
 .I X2'=+X2 D
"RTN","PSIVSP",90,0)
 ..I X2>0&(X2<1) Q
"RTN","PSIVSP",91,0)
 ..I ($P(X2,"@",2,999)'=+$P(X2,"@",2,999)!(+$P(X2,"@",2,999)<0)) K X Q
"RTN","PSIVSP",92,0)
 .I X1>0&(X1<1) I +X1="."_$P(X1,".",2) S X1=X1_" ml/hr"
"RTN","PSIVSP",93,0)
 .I X2>0&(X2<1) I +X2="."_$P(X2,".",2) S X2=X2_" ml/hr"
"RTN","PSIVSP",94,0)
 .I X1=+X1 S X1=X1_" ml/hr"
"RTN","PSIVSP",95,0)
 .I X2=+X2 S X2=X2_" ml/hr"
"RTN","PSIVSP",96,0)
 .S:$P(X2,"@")=+X2 $P(X2,"@")=$P(X2,"@")_" ml/hr"
"RTN","PSIVSP",97,0)
 .S X=X1_"="_X2
"RTN","PSIVSP",98,0)
 I X["ML/HR",(+X=$P(X,"ML/HR"))!(+X=$P(X," ML/HR")) S X=$TR(X,"ML/HR","ml/hr")
"RTN","PSIVSP",99,0)
 I X[" ml/hr",+X=$P(X," ml/hr") S X=$P(X," ml/hr")_$P(X," ml/hr",2,9999)
"RTN","PSIVSP",100,0)
 I X["ml/hr",+X=$P(X,"ml/hr") S X=$P(X,"ml/hr")_$P(X,"ml/hr",2,9999)
"RTN","PSIVSP",101,0)
 I X>0,X<1 D  Q
"RTN","PSIVSP",102,0)
 .I X["ML/HR",(+X=$P($P(X,"ML/HR"),".",2))!(+X=$P($P(X," ML/HR"),".",2)) S X=$TR(X,"ML/HR","ml/hr")
"RTN","PSIVSP",103,0)
 .I X[" ml/hr",(+X=$P($P(X," ml/hr"),".",2)) S X=$P(X," ml/hr")_$P(X," ml/hr",2,9999)
"RTN","PSIVSP",104,0)
 .I X["ml/hr",+X=$P(X,"ml/hr") S X=$P(X,"ml/hr")_$P(X,"ml/hr",2,9999)
"RTN","PSIVSP",105,0)
 .I +X=X S X=X_" ml/hr"
"RTN","PSIVSP",106,0)
 .I $P(X,0,2)=+X S X=X_" ml/hr"
"RTN","PSIVSP",107,0)
 .S X=0_+X_$P(X,+X,2)
"RTN","PSIVSP",108,0)
 I '(X>0&X<1) I X'=+X,($P(X,"@",2,999)'=+$P(X,"@",2,999)!(+$P(X,"@",2,999)<0)) K X Q
"RTN","PSIVSP",109,0)
 I X=+X S X=X_" ml/hr" Q
"RTN","PSIVSP",110,0)
 S:$P(X,"@")=+X $P(X,"@")=$P(X,"@")_" ml/hr"
"RTN","PSIVSP",111,0)
 Q
"RTN","PSJORRN")
0^5^B61459384^B60756345
"RTN","PSJORRN",1,0)
PSJORRN ;BIR/MV-RETURN INPATIENT ACTIVE MEDS (CONDENSED) NEW SORT ;28 Jan 99 / 12:56 PM
"RTN","PSJORRN",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**134,213**;16 DEC 97;Build 8
"RTN","PSJORRN",3,0)
 ;
"RTN","PSJORRN",4,0)
 ;Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJORRN",5,0)
 ;Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJORRN",6,0)
 ;Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJORRN",7,0)
 ;Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSJORRN",8,0)
 ;Reference to ^TMP("PS" is documented in DBIA #2383.
"RTN","PSJORRN",9,0)
 ;
"RTN","PSJORRN",10,0)
OCL(DFN,BDT,EDT,TFN) ; return condensed list of inpat meds
"RTN","PSJORRN",11,0)
 ; MVIEW=2   -  This is the new sort with GUI 27
"RTN","PSJORRN",12,0)
 ; Execute this section if MVIEW=2
"RTN","PSJORRN",13,0)
 N ADM,CNT,DN,DO,F,FON,INFUS,INST,MR,ND,ND0,ND2,ND6,ON,PON,PST,SCH,SIO,STAT,TYPE,UNITS,WBDT,X,Y,PSJCLIN,A,TFN2
"RTN","PSJORRN",14,0)
 S TFN2=0
"RTN","PSJORRN",15,0)
 ; PON=placer order number (oerr), FON=filler order number
"RTN","PSJORRN",16,0)
 S:BDT="" BDT=DT S WBDT=BDT_".000001"
"RTN","PSJORRN",17,0)
 S:EDT="" EDT=9999999
"RTN","PSJORRN",18,0)
 S:EDT'["." EDT=EDT_".999999"
"RTN","PSJORRN",19,0)
 S F="^PS(55,DFN,5," F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  D UDTMP
"RTN","PSJORRN",20,0)
 S F="^PS(53.1," F PST="P","N" S ON=0 F  S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  S X=$P($G(^PS(53.1,+ON,0)),U,4) D @$S(X="U":"UDTMP",1:"IVTMP")
"RTN","PSJORRN",21,0)
 S F="^PS(55,"_DFN_",""IV"",",WBDT=BDT-1 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  S ON=0 F  S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  D IVTMP
"RTN","PSJORRN",22,0)
 S X1="" F  S X1=$O(^TMP("PSJTMP",$J,X1)) Q:X1=""  S X2="" F  S X2=$O(^TMP("PSJTMP",$J,X1,X2)) Q:X2=""  D
"RTN","PSJORRN",23,0)
 .S X3="" F  S X3=$O(^TMP("PSJTMP",$J,X1,X2,X3)) Q:X3=""  S X4="" F  S X4=$O(^TMP("PSJTMP",$J,X1,X2,X3,X4)) Q:X4=""  D
"RTN","PSJORRN",24,0)
 ..S X5="" F  S X5=$O(^TMP("PSJTMP",$J,X1,X2,X3,X4,X5)) Q:X5=""  S TFN=$G(TFN)+1 D
"RTN","PSJORRN",25,0)
 ...; The merge below sends the proper ^TMP("PS",$J structure back to the calling
"RTN","PSJORRN",26,0)
 ...; routine PSJORRE
"RTN","PSJORRN",27,0)
 ...M ^TMP("PS",$J,TFN)=^TMP("PSJTMP",$J,X1,X2,X3,X4,X5) S ^TMP("PS",$J,"PC",0)=TFN
"RTN","PSJORRN",28,0)
 K ^TMP("PSJTMP",$J)
"RTN","PSJORRN",29,0)
 Q
"RTN","PSJORRN",30,0)
 ;
"RTN","PSJORRN",31,0)
UDTMP ;*** Set ^TMP for Unit dose orders.
"RTN","PSJORRN",32,0)
 N PROVIDER,ND8,RNWDT,EDTCMPLX,NDP2,PSJOINM,PSJOI,PSJDDNM,LOC,PRIO,NDDSS
"RTN","PSJORRN",33,0)
 S (MR,SCH,INST,PON,NDDSS)="",FON=+ON_$S(F["53.1":"P",1:"U")
"RTN","PSJORRN",34,0)
 D TYPE
"RTN","PSJORRN",35,0)
 S RNWDT=$$LASTREN^PSJLMPRI(DFN,FON) I RNWDT S RNWDT=+RNWDT
"RTN","PSJORRN",36,0)
 S NDP2=$G(@(F_ON_",.2)")) S EDTCMPLX=$P(NDP2,"^",8),PRIO=$P(NDP2,"^",4)
"RTN","PSJORRN",37,0)
 S ND2=$G(@(F_ON_",2)")) I 'EDTCMPLX I F'["53.1",($P(ND2,U,2)>EDT) Q
"RTN","PSJORRN",38,0)
 S ND0=$G(@(F_ON_",0)")) I 'EDTCMPLX I F["53.1",($P(ND0,U,16)>EDT) Q
"RTN","PSJORRN",39,0)
 S ND8=$G(@(F_ON_",8)")),NDP2=$P($G(@(F_ON_",.2)")),"^")
"RTN","PSJORRN",40,0)
 S STAT=$$CODES^PSIVUTL($P(ND0,U,9),$S(FON["P":53.1,1:55.06),28)
"RTN","PSJORRN",41,0)
 S ND6=$P($G(@(F_ON_",6)")),"^"),INST=$G(@(F_+ON_",.3)"))
"RTN","PSJORRN",42,0)
 S FON=+ON_$S(F["53.1":"P",1:"U"),DO=$P($G(@(F_ON_",.2)")),"^",2)
"RTN","PSJORRN",43,0)
 D DRGDISP^PSJLMUT1(DFN,FON,40,0,.DN,1)
"RTN","PSJORRN",44,0)
 S UNITS="" I '$O(@(F_+ON_",1,1)")) S UNITS=$P($G(@(F_+ON_",1,1,0)")),U,2) S:(FON["U")&(UNITS="") UNITS=1
"RTN","PSJORRN",45,0)
 S:+$P(ND0,U,3) MR=$$MR^PSJORRE1(+$P(ND0,U,3))
"RTN","PSJORRN",46,0)
 N NOTGIVEN S NOTGIVEN=$S(FON["U":$P($G(^PS(55,DFN,5,+ON,0)),"^",22),1:"")
"RTN","PSJORRN",47,0)
 ;******** GUI 27 new sort for Meds Tab
"RTN","PSJORRN",48,0)
 I F[53.1 S NDDSS=$G(@(F_ON_",""DSS"")")),LOC=$P(NDDSS,"^")
"RTN","PSJORRN",49,0)
 S:F'[53.1 LOC=$P(ND8,"^") S LOC=$S($P($G(NDDSS),"^",2):LOC,1:"~") I LOC S LOC=$P($G(^SC(LOC,0)),"^")
"RTN","PSJORRN",50,0)
 S PSJST=$P(ND0,"^",9)
"RTN","PSJORRN",51,0)
 S GP=$S((",A,R,H,RE,")[(","_PSJST_","):1,(",P,N,")[(","_PSJST_","):2,PSJST="E":3,(",D,DE,DR,")[(","_PSJST_","):4,1:0)
"RTN","PSJORRN",52,0)
 S PSJST2=$S(PSJST="A":1,PSJST="R":2,PSJST="H":3,PSJST="S":4,PSJST="P":5,PSJST="O":6,PSJST="N":7,PSJST="I":8,PSJST="P":9,GP=4&($G(PRIO)="D"):10,PSJST="E":11,PSJST="D":12,PSJST="DE":13,PSJST="RE":14,PSJST="R":15,1:0)
"RTN","PSJORRN",53,0)
 S PSJOI=$P(NDP2,"^"),PSJOINM=$P($G(^PS(50.7,+PSJOI,0)),"^")
"RTN","PSJORRN",54,0)
 ;*******
"RTN","PSJORRN",55,0)
 S TFN2=$G(TFN2)+1
"RTN","PSJORRN",56,0)
 S CNT=0,PSJOINM=$S(PSJOINM]"":PSJOINM,1:"UNKNOWN")
"RTN","PSJORRN",57,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,0)=FON_";I"_U_DN(1)_"^^"_$P(ND2,U,4)_"^^"_DO_U_UNITS_U_$P(ND0,U,21)_U_STAT_U_U_U_U_NOTGIVEN_U_($P(ND0,U,9)="P"&($P(ND0,U,24)="R"))_U_$P(ND2,U,2)_U_$G(RNWDT)
"RTN","PSJORRN",58,0)
 K ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"CLINIC",0) I PSJCLIN]"" S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"CLINIC",0)=PSJCLIN
"RTN","PSJORRN",59,0)
 S PROVIDER=$P($G(@(F_+ON_",0)")),"^",2)
"RTN","PSJORRN",60,0)
 I PROVIDER S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"P",0)=PROVIDER_"^"_$P($G(^VA(200,PROVIDER,0)),"^")
"RTN","PSJORRN",61,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"MDR",0)=MR]"" S:MR]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"MDR",1,0)=MR
"RTN","PSJORRN",62,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SCH",0)=$P(ND2,U)]"" S:$P(ND2,U)]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SCH",1,0)=$P(ND2,U)
"RTN","PSJORRN",63,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SIG",0)=INST]"" S:INST]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SIG",1,0)=INST
"RTN","PSJORRN",64,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"ADM",0)=$P(ND2,U,5)]"" S:$P(ND2,U,5)]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"ADM",1,0)=$P(ND2,U,5)
"RTN","PSJORRN",65,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SIO",0)=ND6]"" S:ND6]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SIO",1,0)=ND6
"RTN","PSJORRN",66,0)
 Q
"RTN","PSJORRN",67,0)
 ;
"RTN","PSJORRN",68,0)
IVTMP ;*** Set ^TMP for IV orders.
"RTN","PSJORRN",69,0)
 N PROVIDER,START,STOP,EDTCMPLX,NDP2,IVLIM,PRIO,LOC,NDDSS
"RTN","PSJORRN",70,0)
 S (PROVIDER,START,STOP,EDTCMPLX,NDP2,IVLIM,PRIO,LOC,NDDSS)=""
"RTN","PSJORRN",71,0)
 S NDP2=$G(@(F_ON_",.2)")) S EDTCMPLX=$P(NDP2,"^",8),PRIO=$P(NDP2,"^",4)
"RTN","PSJORRN",72,0)
 S ND0=$G(@(F_ON_",0)")) I 'EDTCMPLX I F'["53.1",($P(ND0,U,2)>EDT) Q
"RTN","PSJORRN",73,0)
 D TYPE
"RTN","PSJORRN",74,0)
 S FON=+ON_$S(F["53.1":"P",1:"V"),TFN2=TFN2+1,CNT=0
"RTN","PSJORRN",75,0)
 S RNWDT=$$LASTREN^PSJLMPRI(DFN,FON) I RNWDT S RNWDT=+RNWDT
"RTN","PSJORRN",76,0)
 ;******** GUI 27 new sort for Meds Tab
"RTN","PSJORRN",77,0)
 S NDDSS=$G(@(F_ON_",""DSS"")")),NDP2=$G(@(F_ON_",.2)"))
"RTN","PSJORRN",78,0)
 S PSJOI=$P(NDP2,"^")
"RTN","PSJORRN",79,0)
 I F[53.1 S PSJST=$P(ND0,"^",9)
"RTN","PSJORRN",80,0)
 I F'[53.1 S PSJST=$P(ND0,"^",17)
"RTN","PSJORRN",81,0)
 S GP=$S((",A,R,H,RE,")[(","_PSJST_","):1,(",P,N,")[(","_PSJST_","):2,PSJST="E":3,(",D,DE,DR,")[(","_PSJST_","):4,1:0)
"RTN","PSJORRN",82,0)
 S PSJST2=$S(PSJST="A":1,PSJST="R":2,PSJST="H":3,PSJST="S":4,PSJST="P":5,PSJST="O":6,PSJST="N":7,PSJST="I":8,PSJST="P":9,GP=4&($G(PRIO)="D"):10,PSJST="E":11,PSJST="D":12,PSJST="DE":13,PSJST="RE":14,PSJST="R":15,1:0)
"RTN","PSJORRN",83,0)
 S LOC=$P(NDDSS,"^") S LOC=$S($P(NDDSS,"^",2):LOC,1:"~") I LOC S LOC=$P($G(^SC(LOC,0)),"^")
"RTN","PSJORRN",84,0)
 I PSJOI'="" S PSJOINM=$P($G(^PS(50.7,+PSJOI,0)),"^")
"RTN","PSJORRN",85,0)
 I PSJOI="" S PSJOINM="Orderable Item Not Found"
"RTN","PSJORRN",86,0)
 ;********
"RTN","PSJORRN",87,0)
 S CNT=0,PSJOINM=$S(PSJOINM]"":PSJOINM,1:"UNKNOWN")
"RTN","PSJORRN",88,0)
 F X=0:0 S X=$O(@(F_ON_",""AD"","_X_")")) Q:'X  S ND=$G(@(F_ON_",""AD"","_X_",0)")),DN=$P($G(^PS(52.6,+ND,0)),U),Y=DN_U_$P(ND,U,2) S:$P(ND,U,3) Y=Y_U_$P(ND,U,3) S CNT=CNT+1,^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"A",CNT,0)=Y
"RTN","PSJORRN",89,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"A",0)=CNT,CNT=0
"RTN","PSJORRN",90,0)
 F X=0:0 S X=$O(@(F_ON_",""SOL"","_X_")")) Q:'X  S ND=$G(@(F_ON_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0)),CNT=CNT+1,^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"B",CNT,0)=$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4)
"RTN","PSJORRN",91,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"B",0)=CNT
"RTN","PSJORRN",92,0)
 S TYPE=$P(ND0,U,4),(MR,SCH,INST,INFUS)=""
"RTN","PSJORRN",93,0)
 I FON["P" S ND2=$G(^PS(53.1,+ON,2)),SCH=$P(ND2,U),START=$P(ND2,U,2),STOP=$P(ND2,U,4),MR=$P(ND0,U,3),INFUS=$P($G(^PS(53.1,+ON,8)),U,5),STAT=$$CODES^PSIVUTL($P(ND0,U,9),53.1,28),ADM=$P(ND2,U,5),SIO=$P($G(@(F_+ON_",6)")),"^")
"RTN","PSJORRN",94,0)
 I FON'["P" S START=$P(ND0,U,2),STOP=$P(ND0,U,3),SCH=$P(ND0,U,9),INFUS=$P(ND0,U,8),MR=$P($G(^PS(55,DFN,"IV",+ON,.2)),U,3),STAT=$$CODES^PSIVUTL($P(ND0,U,17),55.01,100),ADM=$P(ND0,U,11),SIO=$P($G(@(F_+ON_",3)")),"^")
"RTN","PSJORRN",95,0)
 S DN=$G(@(F_+ON_",.2)")),DO=$P(DN,U,2)
"RTN","PSJORRN",96,0)
 S DN=$S(+$P(DN,U):$$OIDF^PSJLMUT1($P(DN,U)),1:"")
"RTN","PSJORRN",97,0)
 S:MR MR=$$MR^PSJORRE1(+MR),INST=$G(@(F_+ON_",.3)"))
"RTN","PSJORRN",98,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,0)=FON_";I"_U_DN_U_INFUS_U_STOP_"^^"_DO_"^^"_$P(ND0,"^",21)_U_STAT_U_U_U_U_U_($P(ND0,U,9)="P"&($P(ND0,U,24)="R"))_U_START_U_$G(RNWDT)
"RTN","PSJORRN",99,0)
 K ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"CLINIC",0) I PSJCLIN]"" S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"CLINIC",0)=PSJCLIN
"RTN","PSJORRN",100,0)
 S PROVIDER=$P($G(@(F_+ON_",0)")),"^",6)
"RTN","PSJORRN",101,0)
 I PROVIDER S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"P",0)=PROVIDER_"^"_$P($G(^VA(200,PROVIDER,0)),"^")
"RTN","PSJORRN",102,0)
 S ND2P5=$G(@(F_+ON_",2.5)")) S IVLIM=$P(ND2P5,U,4) I $E(IVLIM)="a" S IVLIM="doses"_$P(IVLIM,"a",2)
"RTN","PSJORRN",103,0)
 I IVLIM="" S IVLIM=$P(ND2P5,U,2) S:(IVLIM'["d")&(IVLIM'["h") IVLIM=""
"RTN","PSJORRN",104,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"MDR",0)=MR]"" S:MR]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"MDR",1,0)=MR
"RTN","PSJORRN",105,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SIG",0)=INST]"" S:INST]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SIG",1,0)=INST
"RTN","PSJORRN",106,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SCH",0)=SCH]"" S:SCH]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SCH",1,0)=SCH
"RTN","PSJORRN",107,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"ADM",0)=ADM]"" S:ADM]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"ADM",1,0)=ADM
"RTN","PSJORRN",108,0)
 S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SIO",0)=SIO]"" S:SIO]"" ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"SIO",1,0)=SIO
"RTN","PSJORRN",109,0)
 I $G(IVLIM)]"" S ^TMP("PSJTMP",$J,GP,PSJST,LOC,PSJOINM,TFN2,"IVLIM",0)=IVLIM
"RTN","PSJORRN",110,0)
 Q
"RTN","PSJORRN",111,0)
STAT(Y,X) ;* Return the full status instead of just the code for U/D.
"RTN","PSJORRN",112,0)
 S X=$P($P(";"_$P(Y,U,3),";"_X_":",2),";")
"RTN","PSJORRN",113,0)
 Q X
"RTN","PSJORRN",114,0)
TYPE ;determine if this is an IMO order or not
"RTN","PSJORRN",115,0)
 S (A,PSJCLIN)="" I F["PS(53.1" S A=$G(^PS(53.1,ON,"DSS"))
"RTN","PSJORRN",116,0)
 I F["PS(55" S A=$S(F["IV":$G(^PS(55,DFN,"IV",ON,"DSS")),1:$G(^PS(55,DFN,5,ON,8)))
"RTN","PSJORRN",117,0)
 I $P(A,"^",2)'="" S PSJCLIN=+A
"RTN","PSJORRN",118,0)
 Q
"RTN","PSJORRN1")
0^6^B55578785^B54888629
"RTN","PSJORRN1",1,0)
PSJORRN1 ;BIR/JCH-RETURN INPATIENT MEDS (CONDENSED) SECOND 'NEW' SORT ;07 Feb 07 / 12:56 PM
"RTN","PSJORRN1",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**134,213**;16 DEC 97;Build 8
"RTN","PSJORRN1",3,0)
 ;
"RTN","PSJORRN1",4,0)
 ;Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJORRN1",5,0)
 ;Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJORRN1",6,0)
 ;Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJORRN1",7,0)
 ;Reference to ^TMP("PS" is documented in DBIA #2383.
"RTN","PSJORRN1",8,0)
 ;Reference to ^SC is documented in DBIA #10040.
"RTN","PSJORRN1",9,0)
 ;Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSJORRN1",10,0)
 ;
"RTN","PSJORRN1",11,0)
 ; return condensed list of inpat meds with Alpha Primary Sort
"RTN","PSJORRN1",12,0)
OCL(DFN,BDT,EDT,TFN) ; Execute this section if MVIEW=1
"RTN","PSJORRN1",13,0)
 N ADM,CNT,DN,DO,F,FON,INFUS,INST,MR,ND,ND0,ND2,ND6,ON,PON,PST,SCH,SIO,STAT,TYPE,UNITS,WBDT,X,Y,PSJCLIN,A,TFN2,PSJOTYP,PSJNOW,PSJ30DAY
"RTN","PSJORRN1",14,0)
 S TFN2=TFN,PSJNOW=$$DATE^PSJUTL2(),PSJ30DAY=$$FMADD^XLFDT(PSJNOW,-30) S $P(PSJ30DAY,".",2)="000001"
"RTN","PSJORRN1",15,0)
 ; PON=placer order number (oerr), FON=filler order number
"RTN","PSJORRN1",16,0)
 S:BDT="" BDT=DT S WBDT=BDT_".000001" S:WBDT<PSJ30DAY WBDT=PSJ30DAY
"RTN","PSJORRN1",17,0)
 S:EDT="" EDT=9999999
"RTN","PSJORRN1",18,0)
 S:EDT'["." EDT=EDT_".999999"
"RTN","PSJORRN1",19,0)
 S F="^PS(55,DFN,5," F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  S PSJOTYP="D" D UDTMP
"RTN","PSJORRN1",20,0)
 S F="^PS(53.1," F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  S X=$P($G(^PS(53.1,+ON,0)),U,4) S PSJOTYP=$S(PST="P":"P1",1:"P2") D @$S(X="U":"UDTMP",1:"IVTMP")
"RTN","PSJORRN1",21,0)
 S F="^PS(55,"_DFN_",""IV"",",WBDT=BDT-1 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  S PSJOTYP="V" D IVTMP
"RTN","PSJORRN1",22,0)
 S X1="" F  S X1=$O(^TMP("PSJTMP",$J,X1)) Q:X1=""  S X2="" F  S X2=$O(^TMP("PSJTMP",$J,X1,X2)) Q:X2=""  S X3="" F  S X3=$O(^TMP("PSJTMP",$J,X1,X2,X3)) Q:X3=""  D
"RTN","PSJORRN1",23,0)
 .S X4="" F  S X4=$O(^TMP("PSJTMP",$J,X1,X2,X3,X4)) Q:X4=""  D
"RTN","PSJORRN1",24,0)
 ..; The merge below sends the proper ^TMP("PS",$J structure back to the calling routine PSJORRE
"RTN","PSJORRN1",25,0)
 ..S TFN=$G(TFN)+1 M ^TMP("PS",$J,TFN)=^TMP("PSJTMP",$J,X1,X2,X3,X4) S ^TMP("PS",$J,"PC",0)=TFN
"RTN","PSJORRN1",26,0)
 K ^TMP("PSJTMP",$J)
"RTN","PSJORRN1",27,0)
 Q
"RTN","PSJORRN1",28,0)
 ;
"RTN","PSJORRN1",29,0)
UDTMP ;*** Set ^TMP for Unit dose orders.
"RTN","PSJORRN1",30,0)
 N PROVIDER,RNWDT,EDTCMPLX,NDP2,PSJSTP,PSJLOC,PSJST2,NDDSS
"RTN","PSJORRN1",31,0)
 S (MR,SCH,INST,PON,NDDSS)="",FON=+ON_$S(F["53.1":"P",1:"U")
"RTN","PSJORRN1",32,0)
 I $E($G(PSJOTYP))="P",'$G(WBDT) S WBDT=+ON
"RTN","PSJORRN1",33,0)
 D TYPE S PSJLOC=$S($G(PSJCLIN):$P($G(^SC(+PSJCLIN,0)),"^"),1:"zzz")
"RTN","PSJORRN1",34,0)
 S RNWDT=$$LASTREN^PSJLMPRI(DFN,FON) I RNWDT S RNWDT=+RNWDT
"RTN","PSJORRN1",35,0)
 S NDP2=$G(@(F_ON_",.2)")) S EDTCMPLX=$P(NDP2,"^",8)
"RTN","PSJORRN1",36,0)
 S ND2=$G(@(F_ON_",2)")) I 'EDTCMPLX I F'["53.1",($P(ND2,U,2)>EDT) Q
"RTN","PSJORRN1",37,0)
 S ND0=$G(@(F_ON_",0)")) I 'EDTCMPLX I F["53.1",($P(ND0,U,16)>EDT) Q
"RTN","PSJORRN1",38,0)
 S STAT=$$CODES^PSIVUTL($P(ND0,U,9),$S(FON["P":53.1,1:55.06),28)
"RTN","PSJORRN1",39,0)
 S ND6=$P($G(@(F_ON_",6)")),"^"),INST=$G(@(F_+ON_",.3)"))
"RTN","PSJORRN1",40,0)
 S ND8=$P($G(@(F_ON_",8)")),"^")
"RTN","PSJORRN1",41,0)
 S FON=+ON_$S(F["53.1":"P",1:"U"),DO=$P($G(@(F_ON_",.2)")),"^",2)
"RTN","PSJORRN1",42,0)
 D DRGDISP^PSJLMUT1(DFN,FON,40,0,.DN,1)
"RTN","PSJORRN1",43,0)
 S UNITS="" I '$O(@(F_+ON_",1,1)")) S UNITS=$P($G(@(F_+ON_",1,1,0)")),U,2) S:(FON["U")&(UNITS="") UNITS=1
"RTN","PSJORRN1",44,0)
 S:+$P(ND0,U,3) MR=$$MR^PSJORRE1(+$P(ND0,U,3))
"RTN","PSJORRN1",45,0)
 N NOTGIVEN S NOTGIVEN=$S(FON["U":$P($G(^PS(55,DFN,5,+ON,0)),"^",22),1:"")
"RTN","PSJORRN1",46,0)
 ;******** GUI 27 New sort format #2 for Meds Tab
"RTN","PSJORRN1",47,0)
 I F[53.1 S NDDSS=$G(@(F_ON_",""DSS"")")),LOC=$P(NDDSS,"^")
"RTN","PSJORRN1",48,0)
 S:F'[53.1 LOC=$P(ND8,"^") S LOC=$S(LOC]"":LOC,1:"~") I LOC S LOC=$P($G(^SC(LOC,0)),"^")
"RTN","PSJORRN1",49,0)
 S PSJST=$P(ND0,"^",9) S PSJST2=$S(PSJST="A":1,PSJST="E":2,1:"") Q:'PSJST2
"RTN","PSJORRN1",50,0)
 S PSJOI=$P(NDP2,"^"),PSJOINM=$P($G(^PS(50.7,+PSJOI,0)),"^")
"RTN","PSJORRN1",51,0)
 S PSJSTP=+$P(ND2,"^",4)
"RTN","PSJORRN1",52,0)
 ;********
"RTN","PSJORRN1",53,0)
 S TFN2=$G(TFN2)+1
"RTN","PSJORRN1",54,0)
 S DN(1)=$S($G(DN(1))="":"UNKNOWN",1:DN(1))
"RTN","PSJORRN1",55,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,0)=FON_";I"_U_DN(1)_"^^"_$P(ND2,U,4)_"^^"_DO_U_UNITS_U_$P(ND0,U,21)_U_STAT_U_U_U_U_NOTGIVEN_U_($P(ND0,U,9)="P"&($P(ND0,U,24)="R"))_U_$P(ND2,U,2)_U_$G(RNWDT)
"RTN","PSJORRN1",56,0)
 K ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"CLINIC",0) I PSJCLIN]"" S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"CLINIC",0)=PSJCLIN
"RTN","PSJORRN1",57,0)
 S PROVIDER=$P($G(@(F_+ON_",0)")),"^",2)
"RTN","PSJORRN1",58,0)
 I PROVIDER S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"P",0)=PROVIDER_"^"_$P($G(^VA(200,PROVIDER,0)),"^")
"RTN","PSJORRN1",59,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"MDR",0)=MR]"" S:MR]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"MDR",1,0)=MR
"RTN","PSJORRN1",60,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SCH",0)=$P(ND2,U)]"" S:$P(ND2,U)]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SCH",1,0)=$P(ND2,U)
"RTN","PSJORRN1",61,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SIG",0)=INST]"" S:INST]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SIG",1,0)=INST
"RTN","PSJORRN1",62,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"ADM",0)=$P(ND2,U,5)]"" S:$P(ND2,U,5)]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"ADM",1,0)=$P(ND2,U,5)
"RTN","PSJORRN1",63,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SIO",0)=ND6]"" S:ND6]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SIO",1,0)=ND6
"RTN","PSJORRN1",64,0)
 Q
"RTN","PSJORRN1",65,0)
 ;
"RTN","PSJORRN1",66,0)
IVTMP ;*** Set ^TMP for IV orders.
"RTN","PSJORRN1",67,0)
 N PROVIDER,START,STOP,EDTCMPLX,NDP2,IVLIM,PSJLOC,NDDSS
"RTN","PSJORRN1",68,0)
 S (PROVIDER,START,STOP,EDTCMPLX,NDP2,IVLIM,PSJLOC,NDDSS)=""
"RTN","PSJORRN1",69,0)
 I $E($G(PSJOTYP))="P",'$G(WBDT) S WBDT=+ON
"RTN","PSJORRN1",70,0)
 S NDP2=$G(@(F_ON_",.2)")) S EDTCMPLX=$P(NDP2,"^",8)
"RTN","PSJORRN1",71,0)
 S ND0=$G(@(F_ON_",0)")) I 'EDTCMPLX I F'["53.1",($P(ND0,U,2)>EDT) Q
"RTN","PSJORRN1",72,0)
 D TYPE S PSJLOC=$S($G(PSJCLIN):$P($G(^SC(+PSJCLIN,0)),"^"),1:"zzz")
"RTN","PSJORRN1",73,0)
 S FON=+ON_$S(F["53.1":"P",1:"V"),CNT=0
"RTN","PSJORRN1",74,0)
 S RNWDT=$$LASTREN^PSJLMPRI(DFN,FON) I RNWDT S RNWDT=+RNWDT
"RTN","PSJORRN1",75,0)
 ;******** GUI 27 old sort, new format for Meds Tab
"RTN","PSJORRN1",76,0)
 S NDDSS=$G(@(F_ON_",""DSS"")")),NDP2=$G(@(F_ON_",.2)"))
"RTN","PSJORRN1",77,0)
 S PSJOI=$P(NDP2,"^"),PSJST=""
"RTN","PSJORRN1",78,0)
 I F[53.1 S PSJST=$P(ND0,"^",9)
"RTN","PSJORRN1",79,0)
 I F'[53.1 S PSJST=$P(ND0,"^",17)
"RTN","PSJORRN1",80,0)
 S PSJST2=$S(PSJST="A":1,PSJST="E":2,1:"") Q:'PSJST2
"RTN","PSJORRN1",81,0)
 S LOC=$P(NDDSS,"^") S LOC=$S(LOC]"":LOC,1:"~")  I LOC S LOC=$P($G(^SC(LOC,0)),"^")
"RTN","PSJORRN1",82,0)
 I PSJOI'="" S PSJOINM=$P($G(^PS(50.7,+PSJOI,0)),"^")
"RTN","PSJORRN1",83,0)
 I PSJOI="" S PSJOINM="Orderable Item Not Found"
"RTN","PSJORRN1",84,0)
 S PSJSTP=$P(ND0,"^",3)
"RTN","PSJORRN1",85,0)
 ;********
"RTN","PSJORRN1",86,0)
 S TFN2=$G(TFN2)+1
"RTN","PSJORRN1",87,0)
 S DN(1)=$S($G(DN(1))="":"UNKNOWN",1:DN(1)),CNT=0
"RTN","PSJORRN1",88,0)
 F X=0:0 S X=$O(@(F_ON_",""AD"","_X_")")) Q:'X  S ND=$G(@(F_ON_",""AD"","_X_",0)")),DN=$P($G(^PS(52.6,+ND,0)),U),Y=DN_U_$P(ND,U,2) S:$P(ND,U,3) Y=Y_U_$P(ND,U,3) S CNT=CNT+1,DN(CNT)=Y S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"A",CNT,0)=Y
"RTN","PSJORRN1",89,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"A",0)=CNT,CNT=0
"RTN","PSJORRN1",90,0)
 F X=0:0 S X=$O(@(F_ON_",""SOL"","_X_")")) Q:'X  S ND=$G(@(F_ON_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0)),CNT=CNT+1,^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"B",CNT,0)=$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4)
"RTN","PSJORRN1",91,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"B",0)=CNT
"RTN","PSJORRN1",92,0)
 S TYPE=$P(ND0,U,4),(MR,SCH,INST,INFUS)=""
"RTN","PSJORRN1",93,0)
 I FON["P" S ND2=$G(^PS(53.1,+ON,2)),SCH=$P(ND2,U),START=$P(ND2,U,2),STOP=$P(ND2,U,4),MR=$P(ND0,U,3),INFUS=$P($G(^PS(53.1,+ON,8)),U,5),STAT=$$CODES^PSIVUTL($P(ND0,U,9),53.1,28),ADM=$P(ND2,U,5),SIO=$P($G(@(F_+ON_",6)")),"^")
"RTN","PSJORRN1",94,0)
 I FON'["P" S START=$P(ND0,U,2),STOP=$P(ND0,U,3),SCH=$P(ND0,U,9),INFUS=$P(ND0,U,8),MR=$P($G(^PS(55,DFN,"IV",+ON,.2)),U,3),STAT=$$CODES^PSIVUTL($P(ND0,U,17),55.01,100),ADM=$P(ND0,U,11),SIO=$P($G(@(F_+ON_",3)")),"^")
"RTN","PSJORRN1",95,0)
 S DN=$G(@(F_+ON_",.2)")),DO=$P(DN,U,2)
"RTN","PSJORRN1",96,0)
 S DN=$S(+$P(DN,U):$$OIDF^PSJLMUT1($P(DN,U)),1:"")
"RTN","PSJORRN1",97,0)
 S:MR MR=$$MR^PSJORRE1(+MR),INST=$G(@(F_+ON_",.3)"))
"RTN","PSJORRN1",98,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,0)=FON_";I"_U_DN_U_INFUS_U_STOP_"^^"_DO_"^^"_$P(ND0,"^",21)_U_STAT_U_U_U_U_U_($P(ND0,U,9)="P"&($P(ND0,U,24)="R"))_U_START_U_$G(RNWDT)
"RTN","PSJORRN1",99,0)
 K ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"CLINIC",0) I PSJCLIN]"" S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"CLINIC",0)=PSJCLIN
"RTN","PSJORRN1",100,0)
 S PROVIDER=$P($G(@(F_+ON_",0)")),"^",6)
"RTN","PSJORRN1",101,0)
 I PROVIDER S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"P",0)=PROVIDER_"^"_$P($G(^VA(200,PROVIDER,0)),"^")
"RTN","PSJORRN1",102,0)
 S ND2P5=$G(@(F_+ON_",2.5)")) S IVLIM=$P(ND2P5,U,4) I $E(IVLIM)="a" S IVLIM="doses"_$P(IVLIM,"a",2)
"RTN","PSJORRN1",103,0)
 I IVLIM="" S IVLIM=$P(ND2P5,U,2) S:(IVLIM'["d")&(IVLIM'["h") IVLIM=""
"RTN","PSJORRN1",104,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"MDR",0)=MR]"" S:MR]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"MDR",1,0)=MR
"RTN","PSJORRN1",105,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SIG",0)=INST]"" S:INST]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SIG",1,0)=INST
"RTN","PSJORRN1",106,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SCH",0)=SCH]"" S:SCH]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SCH",1,0)=SCH
"RTN","PSJORRN1",107,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"ADM",0)=ADM]"" S:ADM]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"ADM",1,0)=ADM
"RTN","PSJORRN1",108,0)
 S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SIO",0)=SIO]"" S:SIO]"" ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"SIO",1,0)=SIO
"RTN","PSJORRN1",109,0)
 I $G(IVLIM)]"" S ^TMP("PSJTMP",$J,DN(1),PSJST2,WBDT,TFN2,"IVLIM",0)=IVLIM
"RTN","PSJORRN1",110,0)
 Q
"RTN","PSJORRN1",111,0)
STAT(Y,X) ;* Return the full status instead of just the code for U/D.
"RTN","PSJORRN1",112,0)
 S X=$P($P(";"_$P(Y,U,3),";"_X_":",2),";")
"RTN","PSJORRN1",113,0)
 Q X
"RTN","PSJORRN1",114,0)
TYPE ;determine if this is an IMO order or not
"RTN","PSJORRN1",115,0)
 S (A,PSJCLIN)="" I F["PS(53.1" S A=$G(^PS(53.1,ON,"DSS"))
"RTN","PSJORRN1",116,0)
 I F["PS(55" S A=$S(F["IV":$G(^PS(55,DFN,"IV",ON,"DSS")),1:$G(^PS(55,DFN,5,ON,8)))
"RTN","PSJORRN1",117,0)
 I $P(A,"^",2)'="" S PSJCLIN=+A
"RTN","PSJORRN1",118,0)
 Q
"RTN","PSJORRO")
0^7^B62410106^B61708639
"RTN","PSJORRO",1,0)
PSJORRO ;BIR/MV-RETURN INPATIENT MEDS (CONDENSED) OLD SORT ;28 Jan 99 / 12:56 PM
"RTN","PSJORRO",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**134,213**;16 DEC 97;Build 8
"RTN","PSJORRO",3,0)
 ;
"RTN","PSJORRO",4,0)
 ;Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJORRO",5,0)
 ;Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJORRO",6,0)
 ;Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJORRO",7,0)
 ;Reference to ^TMP("PS" is documented in DBIA #2383.
"RTN","PSJORRO",8,0)
 ;Reference to ^SC is documented in DBIA #10040.
"RTN","PSJORRO",9,0)
 ;Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSJORRO",10,0)
 ;
"RTN","PSJORRO",11,0)
 ; return condensed list of inpat meds
"RTN","PSJORRO",12,0)
OCL(DFN,BDT,EDT,TFN) ; Execute this section if MVIEW=1
"RTN","PSJORRO",13,0)
 N ADM,CNT,DN,DO,F,FON,INFUS,INST,MR,ND,ND0,ND2,ND6,ON,PON,PST,SCH,SIO,STAT,TYPE,UNITS,WBDT,X,Y,PSJCLIN,A,TFN2,PSJOTYP
"RTN","PSJORRO",14,0)
 S TFN2=TFN
"RTN","PSJORRO",15,0)
 ; PON=placer order number (oerr), FON=filler order number
"RTN","PSJORRO",16,0)
 S:BDT="" BDT=DT S WBDT=BDT_".000001"
"RTN","PSJORRO",17,0)
 S:EDT="" EDT=9999999
"RTN","PSJORRO",18,0)
 S:EDT'["." EDT=EDT_".999999"
"RTN","PSJORRO",19,0)
 S F="^PS(55,DFN,5," F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  S PSJOTYP="D" D UDTMP
"RTN","PSJORRO",20,0)
 S F="^PS(53.1," F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  S X=$P($G(^PS(53.1,+ON,0)),U,4) S PSJOTYP=$S(PST="P":"P1",1:"P2") D @$S(X="U":"UDTMP",1:"IVTMP")
"RTN","PSJORRO",21,0)
 S F="^PS(55,"_DFN_",""IV"",",WBDT=BDT-1 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  S PSJOTYP="V" D IVTMP
"RTN","PSJORRO",22,0)
 S X1="" F  S X1=$O(^TMP("PSJTMP",$J,X1)) Q:X1=""  S X2="" F  S X2=$O(^TMP("PSJTMP",$J,X1,X2)) Q:X2=""  S X3="" F  S X3=$O(^TMP("PSJTMP",$J,X1,X2,X3)) Q:X3=""  D
"RTN","PSJORRO",23,0)
 .S X4="" F  S X4=$O(^TMP("PSJTMP",$J,X1,X2,X3,X4)) Q:X4=""  S X5="" F  S X5=$O(^TMP("PSJTMP",$J,X1,X2,X3,X4,X5)) Q:X5=""  D
"RTN","PSJORRO",24,0)
 ..; The merge below sends the proper ^TMP("PS",$J structure back to the calling routine PSJORRE
"RTN","PSJORRO",25,0)
 ..S TFN=$G(TFN)+1 M ^TMP("PS",$J,TFN)=^TMP("PSJTMP",$J,X1,X2,X3,X4,X5) S ^TMP("PS",$J,"PC",0)=TFN
"RTN","PSJORRO",26,0)
 K ^TMP("PSJTMP",$J)
"RTN","PSJORRO",27,0)
 Q
"RTN","PSJORRO",28,0)
 ;
"RTN","PSJORRO",29,0)
UDTMP ;*** Set ^TMP for Unit dose orders.
"RTN","PSJORRO",30,0)
 N PROVIDER,RNWDT,EDTCMPLX,NDP2,PSJSTP,PSJLOC,NDDSS
"RTN","PSJORRO",31,0)
 S (PROVIDER,RNWDT,EDTCMPLX,NDP2,PSJSTP,PSJLOC,NDDSS)=""
"RTN","PSJORRO",32,0)
 S (MR,SCH,INST,PON)="",FON=+ON_$S(F["53.1":"P",1:"U")
"RTN","PSJORRO",33,0)
 I $E($G(PSJOTYP))="P",'$G(WBDT) S WBDT=+ON
"RTN","PSJORRO",34,0)
 D TYPE S PSJLOC=$S($G(PSJCLIN):$P($G(^SC(+PSJCLIN,0)),"^"),1:"zzz")
"RTN","PSJORRO",35,0)
 S RNWDT=$$LASTREN^PSJLMPRI(DFN,FON) I RNWDT S RNWDT=+RNWDT
"RTN","PSJORRO",36,0)
 S NDP2=$G(@(F_ON_",.2)")) S EDTCMPLX=$P(NDP2,"^",8)
"RTN","PSJORRO",37,0)
 S ND2=$G(@(F_ON_",2)")) I 'EDTCMPLX I F'["53.1",($P(ND2,U,2)>EDT) Q
"RTN","PSJORRO",38,0)
 S ND0=$G(@(F_ON_",0)")) I 'EDTCMPLX I F["53.1",($P(ND0,U,16)>EDT) Q
"RTN","PSJORRO",39,0)
 S STAT=$$CODES^PSIVUTL($P(ND0,U,9),$S(FON["P":53.1,1:55.06),28)
"RTN","PSJORRO",40,0)
 S ND6=$P($G(@(F_ON_",6)")),"^"),INST=$G(@(F_+ON_",.3)"))
"RTN","PSJORRO",41,0)
 S ND8=$P($G(@(F_ON_",8)")),"^")
"RTN","PSJORRO",42,0)
 S FON=+ON_$S(F["53.1":"P",1:"U"),DO=$P($G(@(F_ON_",.2)")),"^",2)
"RTN","PSJORRO",43,0)
 D DRGDISP^PSJLMUT1(DFN,FON,40,0,.DN,1)
"RTN","PSJORRO",44,0)
 S UNITS="" I '$O(@(F_+ON_",1,1)")) S UNITS=$P($G(@(F_+ON_",1,1,0)")),U,2) S:(FON["U")&(UNITS="") UNITS=1
"RTN","PSJORRO",45,0)
 S:+$P(ND0,U,3) MR=$$MR^PSJORRE1(+$P(ND0,U,3))
"RTN","PSJORRO",46,0)
 N NOTGIVEN S NOTGIVEN=$S(FON["U":$P($G(^PS(55,DFN,5,+ON,0)),"^",22),1:"")
"RTN","PSJORRO",47,0)
 ;******** GUI 27 old sort, new format for Meds Tab
"RTN","PSJORRO",48,0)
 I F[53.1 S NDDSS=$G(@(F_ON_",""DSS"")")),LOC=$P(NDDSS,"^")
"RTN","PSJORRO",49,0)
 S:F'[53.1 LOC=$P(ND8,"^") S LOC=$S(LOC]"":LOC,1:"~") I LOC S LOC=$P($G(^SC(LOC,0)),"^")
"RTN","PSJORRO",50,0)
 S PSJST=$P(ND0,"^",9)
"RTN","PSJORRO",51,0)
 S GP=$S((",A,H,")[(","_PSJST_","):2,(",P,N,")[(","_PSJST_","):1,PSJST="E":3,(",DE,DR,D,RE,R,")[(","_PSJST_","):4,1:0)
"RTN","PSJORRO",52,0)
 S PSJST2=$S(PSJST="A":1,PSJST="R":2,PSJST="H":3,PSJST="S":4,PSJST="P":5,PSJST="O":6,PSJST="N":7,PSJST="I":8,PSJST="P":9,GP=4&($G(PRIO)="D"):10,PSJST="E":11,PSJST="D":12,PSJST="DE":13,PSJST="RE":14,PSJST="R":15,1:0)
"RTN","PSJORRO",53,0)
 S PSJOI=$P(NDP2,"^"),PSJOINM=$P($G(^PS(50.7,+PSJOI,0)),"^")
"RTN","PSJORRO",54,0)
 S PSJSTP=+$P(ND2,"^",4)
"RTN","PSJORRO",55,0)
 ;********
"RTN","PSJORRO",56,0)
 S TFN2=$G(TFN2)+1
"RTN","PSJORRO",57,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,0)=FON_";I"_U_DN(1)_"^^"_$P(ND2,U,4)_"^^"_DO_U_UNITS_U_$P(ND0,U,21)_U_STAT_U_U_U_U_NOTGIVEN_U_($P(ND0,U,9)="P"&($P(ND0,U,24)="R"))_U_$P(ND2,U,2)_U_$G(RNWDT)
"RTN","PSJORRO",58,0)
 K ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"CLINIC",0) I PSJCLIN]"" S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"CLINIC",0)=PSJCLIN
"RTN","PSJORRO",59,0)
 S PROVIDER=$P($G(@(F_+ON_",0)")),"^",2)
"RTN","PSJORRO",60,0)
 I PROVIDER S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"P",0)=PROVIDER_"^"_$P($G(^VA(200,PROVIDER,0)),"^")
"RTN","PSJORRO",61,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"MDR",0)=MR]"" S:MR]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"MDR",1,0)=MR
"RTN","PSJORRO",62,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SCH",0)=$P(ND2,U)]"" S:$P(ND2,U)]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SCH",1,0)=$P(ND2,U)
"RTN","PSJORRO",63,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SIG",0)=INST]"" S:INST]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SIG",1,0)=INST
"RTN","PSJORRO",64,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"ADM",0)=$P(ND2,U,5)]"" S:$P(ND2,U,5)]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"ADM",1,0)=$P(ND2,U,5)
"RTN","PSJORRO",65,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SIO",0)=ND6]"" S:ND6]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SIO",1,0)=ND6
"RTN","PSJORRO",66,0)
 Q
"RTN","PSJORRO",67,0)
 ;
"RTN","PSJORRO",68,0)
IVTMP ;*** Set ^TMP for IV orders.
"RTN","PSJORRO",69,0)
 N PROVIDER,START,STOP,EDTCMPLX,NDP2,IVLIM,PSJLOC
"RTN","PSJORRO",70,0)
 I $E($G(PSJOTYP))="P",'$G(WBDT) S WBDT=+ON
"RTN","PSJORRO",71,0)
 S NDP2=$G(@(F_ON_",.2)")) S EDTCMPLX=$P(NDP2,"^",8)
"RTN","PSJORRO",72,0)
 S ND0=$G(@(F_ON_",0)")) I 'EDTCMPLX I F'["53.1",($P(ND0,U,2)>EDT) Q
"RTN","PSJORRO",73,0)
 D TYPE S PSJLOC=$S($G(PSJCLIN):$P($G(^SC(+PSJCLIN,0)),"^"),1:"zzz")
"RTN","PSJORRO",74,0)
 S FON=+ON_$S(F["53.1":"P",1:"V"),CNT=0
"RTN","PSJORRO",75,0)
 S RNWDT=$$LASTREN^PSJLMPRI(DFN,FON) I RNWDT S RNWDT=+RNWDT
"RTN","PSJORRO",76,0)
 ;******** GUI 27 old sort, new format for Meds Tab
"RTN","PSJORRO",77,0)
 S NDDSS=$G(@(F_ON_",""DSS"")")),NDP2=$G(@(F_ON_",.2)"))
"RTN","PSJORRO",78,0)
 S PSJOI=$P(NDP2,"^")
"RTN","PSJORRO",79,0)
 I F[53.1 S PSJST=$P(ND0,"^",9)
"RTN","PSJORRO",80,0)
 I F'[53.1 S PSJST=$P(ND0,"^",17)
"RTN","PSJORRO",81,0)
 S GP=$S((",A,H,")[(","_PSJST_","):2,(",P,N,")[(","_PSJST_","):1,PSJST="E":3,(",DE,DR,D,RE,R,")[(","_PSJST_","):4,1:0)
"RTN","PSJORRO",82,0)
 S PSJST2=$S(PSJST="A":1,PSJST="R":2,PSJST="H":3,PSJST="S":4,PSJST="P":5,PSJST="O":6,PSJST="N":7,PSJST="I":8,PSJST="P":9,GP=4&($G(PRIO)="D"):10,PSJST="E":11,PSJST="D":12,PSJST="DE":13,PSJST="RE":14,PSJST="R":15,1:0)
"RTN","PSJORRO",83,0)
 S LOC=$P(NDDSS,"^") S LOC=$S(LOC]"":LOC,1:"~")  I LOC S LOC=$P($G(^SC(LOC,0)),"^")
"RTN","PSJORRO",84,0)
 I PSJOI="" S PSJOINM="Orderable Item Not Found"
"RTN","PSJORRO",85,0)
 I PSJOI'="" S PSJOINM=$P($G(^PS(50.7,+PSJOI,0)),"^")
"RTN","PSJORRO",86,0)
 S PSJSTP=$P(ND0,"^",3)
"RTN","PSJORRO",87,0)
 ;********
"RTN","PSJORRO",88,0)
 S TFN2=$G(TFN2)+1
"RTN","PSJORRO",89,0)
 F X=0:0 S X=$O(@(F_ON_",""AD"","_X_")")) Q:'X  S ND=$G(@(F_ON_",""AD"","_X_",0)")),DN=$P($G(^PS(52.6,+ND,0)),U),Y=DN_U_$P(ND,U,2) S:$P(ND,U,3) Y=Y_U_$P(ND,U,3) S CNT=CNT+1,^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"A",CNT,0)=Y
"RTN","PSJORRO",90,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"A",0)=CNT,CNT=0
"RTN","PSJORRO",91,0)
 F X=0:0 S X=$O(@(F_ON_",""SOL"","_X_")")) Q:'X  S ND=$G(@(F_ON_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0)),CNT=CNT+1,^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"B",CNT,0)=$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4)
"RTN","PSJORRO",92,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"B",0)=CNT
"RTN","PSJORRO",93,0)
 S TYPE=$P(ND0,U,4),(MR,SCH,INST,INFUS)=""
"RTN","PSJORRO",94,0)
 I FON["P" S ND2=$G(^PS(53.1,+ON,2)),SCH=$P(ND2,U),START=$P(ND2,U,2),STOP=$P(ND2,U,4),MR=$P(ND0,U,3),INFUS=$P($G(^PS(53.1,+ON,8)),U,5),STAT=$$CODES^PSIVUTL($P(ND0,U,9),53.1,28),ADM=$P(ND2,U,5),SIO=$P($G(@(F_+ON_",6)")),"^")
"RTN","PSJORRO",95,0)
 I FON'["P" S START=$P(ND0,U,2),STOP=$P(ND0,U,3),SCH=$P(ND0,U,9),INFUS=$P(ND0,U,8),MR=$P($G(^PS(55,DFN,"IV",+ON,.2)),U,3),STAT=$$CODES^PSIVUTL($P(ND0,U,17),55.01,100),ADM=$P(ND0,U,11),SIO=$P($G(@(F_+ON_",3)")),"^")
"RTN","PSJORRO",96,0)
 S DN=$G(@(F_+ON_",.2)")),DO=$P(DN,U,2)
"RTN","PSJORRO",97,0)
 S DN=$S(+$P(DN,U):$$OIDF^PSJLMUT1($P(DN,U)),1:"")
"RTN","PSJORRO",98,0)
 S:MR MR=$$MR^PSJORRE1(+MR),INST=$G(@(F_+ON_",.3)"))
"RTN","PSJORRO",99,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,0)=FON_";I"_U_DN_U_INFUS_U_STOP_"^^"_DO_"^^"_$P(ND0,"^",21)_U_STAT_U_U_U_U_U_($P(ND0,U,9)="P"&($P(ND0,U,24)="R"))_U_START_U_$G(RNWDT)
"RTN","PSJORRO",100,0)
 K ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"CLINIC",0) I PSJCLIN]"" S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"CLINIC",0)=PSJCLIN
"RTN","PSJORRO",101,0)
 S PROVIDER=$P($G(@(F_+ON_",0)")),"^",6)
"RTN","PSJORRO",102,0)
 I PROVIDER S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"P",0)=PROVIDER_"^"_$P($G(^VA(200,PROVIDER,0)),"^")
"RTN","PSJORRO",103,0)
 S ND2P5=$G(@(F_+ON_",2.5)")) S IVLIM=$P(ND2P5,U,4) I $E(IVLIM)="a" S IVLIM="doses"_$P(IVLIM,"a",2)
"RTN","PSJORRO",104,0)
 I IVLIM="" S IVLIM=$P(ND2P5,U,2) S:(IVLIM'["d")&(IVLIM'["h") IVLIM=""
"RTN","PSJORRO",105,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"MDR",0)=MR]"" S:MR]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"MDR",1,0)=MR
"RTN","PSJORRO",106,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SIG",0)=INST]"" S:INST]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SIG",1,0)=INST
"RTN","PSJORRO",107,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SCH",0)=SCH]"" S:SCH]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SCH",1,0)=SCH
"RTN","PSJORRO",108,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"ADM",0)=ADM]"" S:ADM]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"ADM",1,0)=ADM
"RTN","PSJORRO",109,0)
 S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SIO",0)=SIO]"" S:SIO]"" ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"SIO",1,0)=SIO
"RTN","PSJORRO",110,0)
 I $G(IVLIM)]"" S ^TMP("PSJTMP",$J,PSJLOC,GP,PSJST,WBDT,TFN2,"IVLIM",0)=IVLIM
"RTN","PSJORRO",111,0)
 Q
"RTN","PSJORRO",112,0)
STAT(Y,X) ;* Return the full status instead of just the code for U/D.
"RTN","PSJORRO",113,0)
 S X=$P($P(";"_$P(Y,U,3),";"_X_":",2),";")
"RTN","PSJORRO",114,0)
 Q X
"RTN","PSJORRO",115,0)
TYPE ;determine if this is an IMO order or not
"RTN","PSJORRO",116,0)
 S (A,PSJCLIN)="" I F["PS(53.1" S A=$G(^PS(53.1,ON,"DSS"))
"RTN","PSJORRO",117,0)
 I F["PS(55" S A=$S(F["IV":$G(^PS(55,DFN,"IV",ON,"DSS")),1:$G(^PS(55,DFN,5,ON,8)))
"RTN","PSJORRO",118,0)
 I $P(A,"^",2)'="" S PSJCLIN=+A
"RTN","PSJORRO",119,0)
 Q
"VER")
8.0^22.0
"BLD",6350,6)
^189
**END**
**END**

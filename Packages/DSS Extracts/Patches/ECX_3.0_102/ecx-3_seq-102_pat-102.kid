Released ECX*3*102 SEQ #102
Extracted from mail message
**KIDS**:ECX*3.0*102^

**INSTALL NAME**
ECX*3.0*102
"BLD",7001,0)
ECX*3.0*102^DSS EXTRACTS^0^3080812^y
"BLD",7001,1,0)
^^1^1^3061219^
"BLD",7001,1,1,0)
VBEC Extract
"BLD",7001,4,0)
^9.64PA^727.829^1
"BLD",7001,4,727.829,0)
727.829
"BLD",7001,4,727.829,2,0)
^9.641^727.829^1
"BLD",7001,4,727.829,2,727.829,0)
BLOOD BANK EXTRACT  (File-top level)
"BLD",7001,4,727.829,2,727.829,1,0)
^9.6411^27^3
"BLD",7001,4,727.829,2,727.829,1,3,0)
FACILITY
"BLD",7001,4,727.829,2,727.829,1,17,0)
FEEDER LOCATION
"BLD",7001,4,727.829,2,727.829,1,27,0)
PRODUCTION DIVISION CODE
"BLD",7001,4,727.829,222)
y^y^p^^^^n^^n
"BLD",7001,4,727.829,224)

"BLD",7001,4,"APDD",727.829,727.829)

"BLD",7001,4,"APDD",727.829,727.829,3)

"BLD",7001,4,"APDD",727.829,727.829,17)

"BLD",7001,4,"APDD",727.829,727.829,27)

"BLD",7001,4,"B",727.829,727.829)

"BLD",7001,6.3)
17
"BLD",7001,"KRN",0)
^9.67PA^8989.52^19
"BLD",7001,"KRN",.4,0)
.4
"BLD",7001,"KRN",.401,0)
.401
"BLD",7001,"KRN",.402,0)
.402
"BLD",7001,"KRN",.403,0)
.403
"BLD",7001,"KRN",.5,0)
.5
"BLD",7001,"KRN",.84,0)
.84
"BLD",7001,"KRN",3.6,0)
3.6
"BLD",7001,"KRN",3.8,0)
3.8
"BLD",7001,"KRN",9.2,0)
9.2
"BLD",7001,"KRN",9.8,0)
9.8
"BLD",7001,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",7001,"KRN",9.8,"NM",1,0)
ECXLBB^^0^B45677580
"BLD",7001,"KRN",9.8,"NM",2,0)
ECXPURG^^0^B19455124
"BLD",7001,"KRN",9.8,"NM",3,0)
ECXPURG1^^0^B37781979
"BLD",7001,"KRN",9.8,"NM",4,0)
ECXLBB1^^0^B23103895
"BLD",7001,"KRN",9.8,"NM","B","ECXLBB",1)

"BLD",7001,"KRN",9.8,"NM","B","ECXLBB1",4)

"BLD",7001,"KRN",9.8,"NM","B","ECXPURG",2)

"BLD",7001,"KRN",9.8,"NM","B","ECXPURG1",3)

"BLD",7001,"KRN",19,0)
19
"BLD",7001,"KRN",19,"NM",0)
^9.68A^^
"BLD",7001,"KRN",19.1,0)
19.1
"BLD",7001,"KRN",101,0)
101
"BLD",7001,"KRN",409.61,0)
409.61
"BLD",7001,"KRN",771,0)
771
"BLD",7001,"KRN",870,0)
870
"BLD",7001,"KRN",8989.51,0)
8989.51
"BLD",7001,"KRN",8989.52,0)
8989.52
"BLD",7001,"KRN",8994,0)
8994
"BLD",7001,"KRN","B",.4,.4)

"BLD",7001,"KRN","B",.401,.401)

"BLD",7001,"KRN","B",.402,.402)

"BLD",7001,"KRN","B",.403,.403)

"BLD",7001,"KRN","B",.5,.5)

"BLD",7001,"KRN","B",.84,.84)

"BLD",7001,"KRN","B",3.6,3.6)

"BLD",7001,"KRN","B",3.8,3.8)

"BLD",7001,"KRN","B",9.2,9.2)

"BLD",7001,"KRN","B",9.8,9.8)

"BLD",7001,"KRN","B",19,19)

"BLD",7001,"KRN","B",19.1,19.1)

"BLD",7001,"KRN","B",101,101)

"BLD",7001,"KRN","B",409.61,409.61)

"BLD",7001,"KRN","B",771,771)

"BLD",7001,"KRN","B",870,870)

"BLD",7001,"KRN","B",8989.51,8989.51)

"BLD",7001,"KRN","B",8989.52,8989.52)

"BLD",7001,"KRN","B",8994,8994)

"BLD",7001,"QUES",0)
^9.62^^
"BLD",7001,"REQB",0)
^9.611^1^1
"BLD",7001,"REQB",1,0)
ECX*3.0*105^2
"BLD",7001,"REQB","B","ECX*3.0*105",1)

"FIA",727.829)
BLOOD BANK EXTRACT
"FIA",727.829,0)
^ECX(727.829,
"FIA",727.829,0,0)
727.829
"FIA",727.829,0,1)
y^y^p^^^^n^^n
"FIA",727.829,0,10)

"FIA",727.829,0,11)

"FIA",727.829,0,"RLRO")

"FIA",727.829,0,"VR")
3.0^ECX
"FIA",727.829,727.829)
1
"FIA",727.829,727.829,3)

"FIA",727.829,727.829,17)

"FIA",727.829,727.829,27)

"MBREQ")
0
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^3010618^2980112^11714
"PKG",513,22,1,"PAH",1,0)
102^3080812^3507
"PKG",513,22,1,"PAH",1,1,0)
^^1^1^3080812
"PKG",513,22,1,"PAH",1,1,1,0)
VBEC Extract
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","ECXLBB")
0^1^B45677580^B46626691
"RTN","ECXLBB",1,0)
ECXLBB ;DALOI/KML - DSS BLOOD BANK EXTRACT ; 8/12/08 1:00pm
"RTN","ECXLBB",2,0)
 ;;3.0;DSS EXTRACTS;**78,84,90,92,104,105,102**;Dec 22, 1997;Build 17
"RTN","ECXLBB",3,0)
 ;Per VHA Directive 97-033 this routine should not be modified.  Medical Device # BK970021
"RTN","ECXLBB",4,0)
 ; access to the LAB DATA file (#63) is supported by 
"RTN","ECXLBB",5,0)
 ; controlled subscription to IA 525  (global root ^LR)  
"RTN","ECXLBB",6,0)
 ; access to the BLOOD PRODUCT (#66) is supported by IA 4510
"RTN","ECXLBB",7,0)
BEG ;entry point from option
"RTN","ECXLBB",8,0)
 D SETUP I ECFILE="" Q
"RTN","ECXLBB",9,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXLBB",10,0)
 Q
"RTN","ECXLBB",11,0)
START ; Entry point from tasked job
"RTN","ECXLBB",12,0)
 ; begin package specific extract
"RTN","ECXLBB",13,0)
 N ECTRSP,ECADMT,ECTODT,ECENCTR,ECPAT,ECLRDFN,ECXPHY,ECXPHYPC,ECPHYNPI
"RTN","ECXLBB",14,0)
 N ECD,ECXDFN,ECARRY,EC66,ECERR,ECTRFDT,ECTRFTM,ECX,ECINOUT,ECXINST
"RTN","ECXLBB",15,0)
 ;variables ECFILE,EC23,ECXYM,ECINST,ECSD,ECSD1,ECED passed in 
"RTN","ECXLBB",16,0)
 ; by taskmanager 
"RTN","ECXLBB",17,0)
 ; ECED defined in ^ECXTRAC - it represents the end date of the extract
"RTN","ECXLBB",18,0)
 ; sort process.  TRANSFUSION DATE should be within start and end dates
"RTN","ECXLBB",19,0)
 ; ECED and ECSD were assigned with input provided by the user interface
"RTN","ECXLBB",20,0)
 ; and ECSD1 = ECSD-.1
"RTN","ECXLBB",21,0)
 ; Read through the TRANSFUSION RECORD sub-file (63.017) of 
"RTN","ECXLBB",22,0)
 ; the LAB DATA file (#63)
"RTN","ECXLBB",23,0)
 ;the global nodes containing transfusion record entries are constructed
"RTN","ECXLBB",24,0)
 ; by calculating the TRANSFUSION DATE/TIME (.01)
"RTN","ECXLBB",25,0)
 ; into its reverse date/time representation and then DINUM'd when 
"RTN","ECXLBB",26,0)
 ;filing the record entry 
"RTN","ECXLBB",27,0)
 ; ECD equals the reverse date/time of ECED+.3 and will need to be
"RTN","ECXLBB",28,0)
 ; reset for each DFN.
"RTN","ECXLBB",29,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1 Q  ;quit if tasked and user sends stop request  (QFLG assigned in ECXTRAC)
"RTN","ECXLBB",30,0)
AUDRPT ; entry point for pre-extract audit report
"RTN","ECXLBB",31,0)
 S ECTODT=9999999-ECSD1,ECLRDFN=0
"RTN","ECXLBB",32,0)
 F  S ECLRDFN=$O(^LR(ECLRDFN)) Q:'ECLRDFN  S ECXDFN=$$GETDFN(ECLRDFN),ECERR=$$PAT(ECXDFN) S ECD=9999999-(ECED+.3) F  S ECD=$O(^LR(ECLRDFN,1.6,ECD)) Q:ECERR  Q:'ECD!(ECD>ECTODT)  S EC0=^LR(ECLRDFN,1.6,ECD,0) D
"RTN","ECXLBB",33,0)
 .; ECARRY(1)=TRANSFUSION DATE AND TIME, 
"RTN","ECXLBB",34,0)
 .; ECARRY(3)=COMPONENT, ECARRY(4)=COMPONENT ABBREVIATION
"RTN","ECXLBB",35,0)
 .; ECARRY(5)=UNITS POOLED, ECARRY(6)=TRANSFUSION REACTION, 
"RTN","ECXLBB",36,0)
 .; ECARRY(7)=VOLUME TRANSFUSED, ECARRY(8)=TRANSFUSION REACTION TYPE
"RTN","ECXLBB",37,0)
 .; ECARRY(9)=REQUESTING PROVIDER, ECARRY(10)=REQUEST. PROV. PERSON CLASS
"RTN","ECXLBB",38,0)
 .; ECARRY(11)=UNIT MODIFIED,ECARRY(12)=UNIT MODIFICATION
"RTN","ECXLBB",39,0)
 .; ECARRY(13)=PRODUCTION DIVISION CODE
"RTN","ECXLBB",40,0)
 . S ECARRY(1)=$P(EC0,"^"),EC66=$G(^LAB(66,$P(EC0,"^",2),0))
"RTN","ECXLBB",41,0)
 . S ECARRY(3)=$E($P(EC66,"^"),1,15),ECARRY(4)=$P(EC66,"^",2)
"RTN","ECXLBB",42,0)
 . S ECARRY(5)=$S(+$P(EC0,"^",7)=0:1,1:+$P(EC0,"^",7))
"RTN","ECXLBB",43,0)
 . S ECARRY(6)=$S($P(EC0,"^",8)=1:"Y",1:"N"),ECARRY(7)=$P(EC0,"^",10)
"RTN","ECXLBB",44,0)
 . S ECARRY(8)=$E($P($G(^LAB(65.4,+$P(EC0,"^",11),0)),"^"),1,10)
"RTN","ECXLBB",45,0)
 . S (ECARRY(9),ECARRY(10),ECARRY(13))="" D GETRPRV
"RTN","ECXLBB",46,0)
 . S ECARRY(11)=$$MODIFIED(),(ECXPHY,ECXPHYPC,ECPHYNPI)=""
"RTN","ECXLBB",47,0)
 . S ECARRY(12)=$S(ECARRY(11)="Y":$$UNITMODS(),1:"")
"RTN","ECXLBB",48,0)
 . D GETDATA
"RTN","ECXLBB",49,0)
 . K ECARRY
"RTN","ECXLBB",50,0)
 D AUDRPT^ECXLBB1
"RTN","ECXLBB",51,0)
 Q
"RTN","ECXLBB",52,0)
UNITMODS() ; Get modification criteria from fields #.06 and #3 from file #66
"RTN","ECXLBB",53,0)
 N MODARY,MO,EC66A,MODSTR,STR3
"RTN","ECXLBB",54,0)
 S MODARY("DIVIDED")="D",MODARY("POOLED")="P",MODARY("WASHED")="W"
"RTN","ECXLBB",55,0)
 S MODARY("FROZEN")="F",MODARY("LEUKOCYTE POOR")="L"
"RTN","ECXLBB",56,0)
 S MODARY("REJUVENATED")="R",MODARY("DEGLYCEROLIZED")="G"
"RTN","ECXLBB",57,0)
 S MODARY("IRRADIATED")="I",MODARY("SEPARATED")="S"
"RTN","ECXLBB",58,0)
 ;if modification criteria is null determine value from description
"RTN","ECXLBB",59,0)
 S MODSTR=$S($P(EC66,U,6)'="":$P(EC66,U,6),1:$$CHKMOD^ECXLBB1($P(EC66,"^")))
"RTN","ECXLBB",60,0)
 ;get modification criteria for entries at field #3 in file #66
"RTN","ECXLBB",61,0)
 S MOD=0 F  S MOD=$O(^LAB(66,$P(EC0,"^",2),3,MOD)) Q:'MOD  D
"RTN","ECXLBB",62,0)
 .S EC66A=$G(^LAB(66,MOD,0)) I EC66A="" Q
"RTN","ECXLBB",63,0)
 .S STR3=$S($P(EC66A,U,6)'="":$P(EC66A,U,6),1:$$CHKMOD^ECXLBB1($P(EC66A,"^")))
"RTN","ECXLBB",64,0)
 .I STR3'="",MODSTR'[STR3 S MODSTR=MODSTR_STR3
"RTN","ECXLBB",65,0)
 Q MODSTR
"RTN","ECXLBB",66,0)
MODIFIED() ; Was unit modified
"RTN","ECXLBB",67,0)
 ; Init variables
"RTN","ECXLBB",68,0)
 N XMATCH,UNIT,MOD,COMPID,MODNODE,MODTO
"RTN","ECXLBB",69,0)
 S (XMATCH,UNIT)=0,MOD=""
"RTN","ECXLBB",70,0)
 ; Check input
"RTN","ECXLBB",71,0)
 Q:'$G(ECLRDFN)!'$P(EC0,U,2) "N"
"RTN","ECXLBB",72,0)
 ;Find xmatch for blood component request
"RTN","ECXLBB",73,0)
 S XMATCH=$O(^LR(ECLRDFN,1.8,$P(EC0,U,2),1,XMATCH)) Q:'XMATCH "N"
"RTN","ECXLBB",74,0)
 ;Get blood inventory file (#65) pointer
"RTN","ECXLBB",75,0)
 S UNIT=$P($G(^LR(ECLRDFN,1.8,$P(EC0,"^",2),1,XMATCH,0)),U)
"RTN","ECXLBB",76,0)
 ;Look at disposition field (#4.1) in blood inventory file (#65)
"RTN","ECXLBB",77,0)
 S MOD=$P($G(^LRD(65,+XMATCH,4)),U),COMPID=$P(EC66,U,3)
"RTN","ECXLBB",78,0)
 ; Get 'the modified to' entry pointer to blood inventory file (#66)
"RTN","ECXLBB",79,0)
 I MOD="MO" S MODTO=0 F  S MODTO=$O(^LRD(65,+XMATCH,9,MODTO)) Q:'MODTO  D
"RTN","ECXLBB",80,0)
 .S MODNODE=$G(^LRD(65,+XMATCH,9,MODTO,0)) Q:$P(^(0),U,3)'>1
"RTN","ECXLBB",81,0)
 .Q:$P(MODNODE,U,2)'=COMPID
"RTN","ECXLBB",82,0)
 .; Set the modify to unit ien for file (#66)
"RTN","ECXLBB",83,0)
 Q $S(MOD="MO":"Y",1:"N")
"RTN","ECXLBB",84,0)
GETRPRV ; get requesting provider, requesting provider person class and 
"RTN","ECXLBB",85,0)
 ; production division code
"RTN","ECXLBB",86,0)
 ; input: ECD      =INVERTED DATE SUBSCRIPT
"RTN","ECXLBB",87,0)
 ;        ECARRY(1)=TRANSFUSION DATE AND TIME
"RTN","ECXLBB",88,0)
 ; note: Accessioned data in file #68 is stored up to 90 days.
"RTN","ECXLBB",89,0)
 N ECXBNOD,ACC,ACCDT,ACCNODE,PERCLS
"RTN","ECXLBB",90,0)
 I ECARRY(1)="" Q  ;there is no transfusion date
"RTN","ECXLBB",91,0)
 ;get BLOOD BANK record, field #1, in file #63 located on "BB" node
"RTN","ECXLBB",92,0)
 ;since there is a slight time lapse, $O will find the BB record
"RTN","ECXLBB",93,0)
 S ECXBNOD=$O(^LR(ECLRDFN,"BB",ECD)) I ECXBNOD="" Q
"RTN","ECXLBB",94,0)
 S ECXBNOD=^LR(ECLRDFN,"BB",ECXBNOD,0) I ECXBNOD="" Q
"RTN","ECXLBB",95,0)
 ;Compose accession number,originating from field #.06 subfile #63.01
"RTN","ECXLBB",96,0)
 ; ex. ACC=BB 0528 27
"RTN","ECXLBB",97,0)
 S ACC=$P(ECXBNOD,U,6),ACC=$TR($P(ACC," ",2,99)," ")
"RTN","ECXLBB",98,0)
 S ACCDT=$E(ECARRY(1),1,3)_$E(ACC,1,4),NUM=$E(ACC,5,99)
"RTN","ECXLBB",99,0)
 ;Get field #2 from file #68, field #1 from subfile #68.01 which is
"RTN","ECXLBB",100,0)
 ;subfile #68.02. Look at 29=blood bank ien, from 0th node, get fields
"RTN","ECXLBB",101,0)
 ;#6.5 PROVIDER and #26 DIV
"RTN","ECXLBB",102,0)
 I (ACCDT)=""!(NUM="") Q
"RTN","ECXLBB",103,0)
 ; identify bb accession area the patient was in to get the right DIV
"RTN","ECXLBB",104,0)
 S AREA=$$AREA
"RTN","ECXLBB",105,0)
 S ACCNODE=$G(^LRO(68,+AREA,1,ACCDT,1,NUM,0))
"RTN","ECXLBB",106,0)
 S ECARRY(9)=$P(ACCNODE,U,8) I ECARRY(9)'="" D
"RTN","ECXLBB",107,0)
 . S PERCLS=$$GET^XUA4A72(ECARRY(9),ACCDT)
"RTN","ECXLBB",108,0)
 . I +PERCLS>0 S ECARRY(10)=$P(PERCLS,U,7)
"RTN","ECXLBB",109,0)
 . S ECREQNPI=$$NPI^XUSNPI("Individual_ID",ECARRY(9),ACCDT)
"RTN","ECXLBB",110,0)
 . S:+ECREQNPI'>0 ECREQNPI="" S ECREQNPI=$P(ECREQNPI,U)
"RTN","ECXLBB",111,0)
 . S ECARRY(9)=2_ECARRY(9)
"RTN","ECXLBB",112,0)
 S DIV=$P($G(^LRO(68,+AREA,1,ACCDT,1,NUM,.4)),U)
"RTN","ECXLBB",113,0)
 I DIV'="" S ECARRY(13)=$$RADDIV^ECXDEPT(DIV)
"RTN","ECXLBB",114,0)
 Q
"RTN","ECXLBB",115,0)
AREA() ; resolve accession area's ien to use and validate
"RTN","ECXLBB",116,0)
 ;          Accession number
"RTN","ECXLBB",117,0)
 ;          Patient LRDFN
"RTN","ECXLBB",118,0)
 ; note: if there is only one accession area use '29'
"RTN","ECXLBB",119,0)
 N A,CNT,BBLIST,DFN,ACC,AREA,DATE,TDATE,ACCNODE
"RTN","ECXLBB",120,0)
 S (CNT,FLAG,A)=0,DFN=""
"RTN","ECXLBB",121,0)
 ; set the date from the "bb" node in file (#63)
"RTN","ECXLBB",122,0)
 S DATE=$P(ECXBNOD,U)
"RTN","ECXLBB",123,0)
 ; setup array for bb accession areas if more than one
"RTN","ECXLBB",124,0)
 F  S A=$O(^LRO(68,A)) Q:'A  I $P($G(^LRO(68,A,0)),"^",2)="BB" D
"RTN","ECXLBB",125,0)
 . S BBLIST(A)=""
"RTN","ECXLBB",126,0)
 . S CNT=CNT+1
"RTN","ECXLBB",127,0)
 I CNT'>1 Q 29
"RTN","ECXLBB",128,0)
 S AREA=0 F  S AREA=$O(BBLIST(AREA)) Q:'AREA  D  Q:FLAG
"RTN","ECXLBB",129,0)
 . ; get additional accession information for validation
"RTN","ECXLBB",130,0)
 . S ACCNODE=$G(^LRO(68,AREA,1,$P(DATE,"."),1,NUM,0))
"RTN","ECXLBB",131,0)
 . S ACC=$G(^LRO(68,AREA,1,$P(DATE,"."),1,NUM,.2))
"RTN","ECXLBB",132,0)
 . S DFN=$P($G(ACCNODE),U)
"RTN","ECXLBB",133,0)
 . S TDATE=$P($G(^LRO(68,AREA,1,$P(DATE,"."),1,NUM,3)),U)
"RTN","ECXLBB",134,0)
 . I (DFN=ECLRDFN)&(ACC=$P(ECXBNOD,U,6))&(DATE=TDATE) S FLAG=1
"RTN","ECXLBB",135,0)
 Q AREA
"RTN","ECXLBB",136,0)
GETDATA ; gather rest of extract data that will be recorded in an 
"RTN","ECXLBB",137,0)
 ; entry in file 727.829
"RTN","ECXLBB",138,0)
 S ECTRFDT=$$ECXDOB^ECXUTL(ECARRY(1)),ECTRFTM=$$ECXTIME^ECXUTL(ECARRY(1))
"RTN","ECXLBB",139,0)
 S ECX=$$INP^ECXUTL2(ECXDFN,ECARRY(1)),ECINOUT=$P(ECX,U),ECTRSP=$P(ECX,U,3),ECADMT=$P(ECX,U,4) ; [FLD #5]
"RTN","ECXLBB",140,0)
 ;
"RTN","ECXLBB",141,0)
 ;- Observation patient indicator (YES/NO)
"RTN","ECXLBB",142,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECINOUT,ECTRSP)
"RTN","ECXLBB",143,0)
 ;- If no encounter number don't file record
"RTN","ECXLBB",144,0)
 S ECENCTR=$$ENCNUM^ECXUTL4(ECINOUT,ECPAT("SSN"),ECADMT,ECARRY(1),ECTRSP,ECXOBS,ECHEAD,,) ; [FLD #6]
"RTN","ECXLBB",145,0)
 Q:ECENCTR=""
"RTN","ECXLBB",146,0)
 ;get emergency response indicator (FEMA)
"RTN","ECXLBB",147,0)
 S ECXERI=ECPAT("ERI")
"RTN","ECXLBB",148,0)
 ;
"RTN","ECXLBB",149,0)
 S ECXSTR=$G(EC23)_"^"_ECINST_"^"_ECXDFN_"^"_ECPAT("SSN")_"^"_ECPAT("NAME")_"^"_ECINOUT_"^"_ECENCTR_"^"_ECTRFDT_"^"_ECTRFTM_"^"_ECARRY(3)_"^"_ECARRY(4)_"^"_ECARRY(5)_"^"_ECARRY(7)_"^"_ECARRY(6)_"^"_ECARRY(8)_"^BB"_ECARRY(13)_"^^"
"RTN","ECXLBB",150,0)
 I $G(ECXLOGIC)>2005 S ECXSTR=ECXSTR_U_ECXPHY_U_ECXPHYPC
"RTN","ECXLBB",151,0)
 I $G(ECXLOGIC)>2006 D
"RTN","ECXLBB",152,0)
 .S ECXSTR=ECXSTR_U_ECXERI_U_ECARRY(11)_U_ECARRY(12)_U_ECARRY(9)_U_ECARRY(10)_U_ECARRY(13)_U
"RTN","ECXLBB",153,0)
 I '$D(ECXRPT) D FILE(ECXSTR) Q
"RTN","ECXLBB",154,0)
 S ^TMP("ECXLBB",$J,ECXDFN,ECD)=ECXSTR  ;temporary global array
"RTN","ECXLBB",155,0)
 ;   used in ECXPLBB (pre-extract audit report)
"RTN","ECXLBB",156,0)
 Q
"RTN","ECXLBB",157,0)
GETDFN(ECXLRDFN) ;
"RTN","ECXLBB",158,0)
 ; INPUT - LRDFN
"RTN","ECXLBB",159,0)
 ; OUTPUT - DFN
"RTN","ECXLBB",160,0)
 ; Obtains DFN (Patient ID) from LRDFN (Lab Patient ID).
"RTN","ECXLBB",161,0)
 ; If no valid DFN exists, 0 is returned.
"RTN","ECXLBB",162,0)
 S ECXLRDFN=+$G(ECXLRDFN)
"RTN","ECXLBB",163,0)
 I $P($G(^LR(ECXLRDFN,0)),"^",2)'=2 Q 0
"RTN","ECXLBB",164,0)
 Q +$P(^LR(ECXLRDFN,0),"^",3)
"RTN","ECXLBB",165,0)
 ; 
"RTN","ECXLBB",166,0)
PAT(ECXDFN) ;get/set patient data
"RTN","ECXLBB",167,0)
 ; INPUT - ECXDFN = patient ien (DFN)
"RTN","ECXLBB",168,0)
 ; OUTPUT - ECPAT array:
"RTN","ECXLBB",169,0)
 ;          ECPAT("SSN")
"RTN","ECXLBB",170,0)
 ;          ECPAT("NAME")
"RTN","ECXLBB",171,0)
 ; returns 0 or 1 in ECXERR - 0=successful
"RTN","ECXLBB",172,0)
 ;                            1=error condition
"RTN","ECXLBB",173,0)
 N X,OK,ECXERR
"RTN","ECXLBB",174,0)
 ;get data
"RTN","ECXLBB",175,0)
 S ECXERR=0
"RTN","ECXLBB",176,0)
 K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,"","1;3",.ECPAT)
"RTN","ECXLBB",177,0)
 I 'OK S ECXERR=1
"RTN","ECXLBB",178,0)
 Q ECXERR
"RTN","ECXLBB",179,0)
 ;
"RTN","ECXLBB",180,0)
FILE(ECODE) ;
"RTN","ECXLBB",181,0)
 ; Input - ECODE = extract record
"RTN","ECXLBB",182,0)
 ;
"RTN","ECXLBB",183,0)
 ; record the extract record at a global node in file 727.829
"RTN","ECXLBB",184,0)
 ; sequence #^year/month of extract^extract #^facility^patient dfn^SSN^
"RTN","ECXLBB",185,0)
 ; name^i/o pt indicator^encounter #^date of transfusion^time of 
"RTN","ECXLBB",186,0)
 ; transfusion^component^component abbrev^# of units^volume in mm^
"RTN","ECXLBB",187,0)
 ; reaction^reaction type^feeder location^DSS product dept^DSS IP #
"RTN","ECXLBB",188,0)
 ; ordering physician^ordering physician pc^emergency response indicator
"RTN","ECXLBB",189,0)
 ; (FEMA)^unit modified^unit modification^requesting provider^request. 
"RTN","ECXLBB",190,0)
 ; provider person class^ordering provider npi ECPHYNPI
"RTN","ECXLBB",191,0)
 ;ECODE1- requesting provider npi ECREQNPI
"RTN","ECXLBB",192,0)
 ;note:  DSS product dept and DSS IP # are dependent on the release of
"RTN","ECXLBB",193,0)
 ; ECX*3*61
"RTN","ECXLBB",194,0)
 N DA,DIK,EC7
"RTN","ECXLBB",195,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXLBB",196,0)
 S ECODE=EC7_"^"_ECODE
"RTN","ECXLBB",197,0)
 I ECXLOGIC>2007 D
"RTN","ECXLBB",198,0)
 .S ECODE=ECODE_ECPHYNPI_U
"RTN","ECXLBB",199,0)
 .S ECODE1=$G(ECREQNPI)
"RTN","ECXLBB",200,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=$G(ECODE1),ECRN=ECRN+1
"RTN","ECXLBB",201,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXLBB",202,0)
 Q
"RTN","ECXLBB",203,0)
 ;
"RTN","ECXLBB",204,0)
 ;
"RTN","ECXLBB",205,0)
SETUP ;Set required input for ECXTRAC.
"RTN","ECXLBB",206,0)
 S ECHEAD="LBB"
"RTN","ECXLBB",207,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXLBB",208,0)
 Q
"RTN","ECXLBB",209,0)
 ;
"RTN","ECXLBB",210,0)
LOCAL ; to extract nightly for local use not to be transmitted to TSI
"RTN","ECXLBB",211,0)
 ; should be queued with a 1D frequency
"RTN","ECXLBB",212,0)
 D SETUP,^ECXTLOCL,^ECXKILL Q
"RTN","ECXLBB",213,0)
 ;
"RTN","ECXLBB",214,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXLBB",215,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL
"RTN","ECXLBB",216,0)
 Q
"RTN","ECXLBB",217,0)
 ;
"RTN","ECXLBB",218,0)
 ;ECXLBB
"RTN","ECXLBB1")
0^4^B23103895^B22409654
"RTN","ECXLBB1",1,0)
ECXLBB1 ;ALB/JRC - DSS VBECS EXTRACT ; 7/24/08 12:01pm
"RTN","ECXLBB1",2,0)
 ;;3.0;DSS EXTRACTS;**105,102**;Dec 22, 1997;Build 17
"RTN","ECXLBB1",3,0)
 ;Per VHA Directive 97-033 this routine should not be modified.  Medical Device # BK970021
"RTN","ECXLBB1",4,0)
 ; access to the VBECS EXTRACT file (#6002.03) is supported by
"RTN","ECXLBB1",5,0)
 ; controlled subscription to IA #4953  (global root ^VBECS(6002.03)
"RTN","ECXLBB1",6,0)
BEG ;entry point from option
"RTN","ECXLBB1",7,0)
 D SETUP I ECFILE="" Q
"RTN","ECXLBB1",8,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXLBB1",9,0)
 Q
"RTN","ECXLBB1",10,0)
 ;
"RTN","ECXLBB1",11,0)
START ; Entry point from tasked job
"RTN","ECXLBB1",12,0)
 ; begin package specific extract
"RTN","ECXLBB1",13,0)
 N ECTRSP,ECADMT,ECTODT,ECENCTR,ECPAT,ECLRDFN,ECXPHY,ECXPHYPC
"RTN","ECXLBB1",14,0)
 N ECD,ECXDFN,ECARRY,EC66,ECERR,ECTRFDT,ECTRFTM,ECX,ECINOUT,ECXINST
"RTN","ECXLBB1",15,0)
 N ECPHYNPI,ECREQNPI
"RTN","ECXLBB1",16,0)
 ;variables ECFILE,EC23,ECXYM,ECINST,ECSD,ECSD1,ECED passed in 
"RTN","ECXLBB1",17,0)
 ; by taskmanager 
"RTN","ECXLBB1",18,0)
 ; ECED defined in ^ECXTRAC - end date of the extract
"RTN","ECXLBB1",19,0)
 ; TRANSFUSION DATE should be within start and end dates
"RTN","ECXLBB1",20,0)
 ; ECED and ECSD input provided by the user interface
"RTN","ECXLBB1",21,0)
 ; and ECSD1 = ECSD-.1
"RTN","ECXLBB1",22,0)
 ; Read through the VBECS DSS EXTRACT file (6002.03)
"RTN","ECXLBB1",23,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1 Q  ;quit if tasked and user sends stop request  (QFLG assigned in ECXTRAC)
"RTN","ECXLBB1",24,0)
 ;
"RTN","ECXLBB1",25,0)
AUDRPT ; entry point for pre-extract audit report
"RTN","ECXLBB1",26,0)
 S RECORD=0,ECD=ECSD-.1,ECTODT=ECED+.9
"RTN","ECXLBB1",27,0)
 F  S ECD=$O(^VBEC(6002.03,"C",ECD)) Q:'ECD!(ECD>ECTODT)  S RECORD=0 F  S RECORD=$O(^VBEC(6002.03,"C",ECD,RECORD)) Q:RECORD'>0  S EC0=^VBEC(6002.03,RECORD,0) D
"RTN","ECXLBB1",28,0)
 .; ECARRY(1)=TRANSFUSION DATE AND TIME, ECARRY(3)=COMPONENT 
"RTN","ECXLBB1",29,0)
 .; ECARRY(4)=COMPONENT ABBREVIATION, ECARRY(5)=UNITS POOLED
"RTN","ECXLBB1",30,0)
 .; ECARRY(6)=TRANSFUSION REACTION,ECARRY(7)=VOLUME TRANSFUSED
"RTN","ECXLBB1",31,0)
 .; ECARRY(8)=TRANSFUSION REACTION TYPE, ECARRY(9)=REQUESTING PROVIDER
"RTN","ECXLBB1",32,0)
 .; ECARRY(10)=REQUEST. PROV. PERSON CLASS, ECARRY(11)=UNIT MODIFIED
"RTN","ECXLBB1",33,0)
 .; ECARRY(12)=UNIT MODIFICATION, ECARRY(13)=PRODUCTION DIVISION CODE
"RTN","ECXLBB1",34,0)
 .;
"RTN","ECXLBB1",35,0)
 . S ECXDFN=$P(EC0,U,2),ECERR=$$PAT(ECXDFN) Q:ECERR
"RTN","ECXLBB1",36,0)
 . S ECARRY(1)=$P(EC0,U,10),ECARRY(3)=$P(EC0,U,7),ECARRY(4)=$P(EC0,U,8),ECARRY(5)=$S(+$P(EC0,U,9)=0:1,1:+$P(EC0,U,9)),ECARRY(6)=$S($P(EC0,U,15):"Y",1:"N"),ECARRY(7)=$P(EC0,"^",12),ECARRY(8)=$P(EC0,U,13)
"RTN","ECXLBB1",37,0)
 . S ECARRY(9)=$P(EC0,U,6),ECINST=$P(EC0,U,3),ECARRY(12)=$P(EC0,U,14),ECARRY(11)=$S(ECARRY(12)'="":"Y",1:"N"),ECARRY(13)=$P(EC0,U,4)
"RTN","ECXLBB1",38,0)
 . ;get requesting and ordering providers and their person class
"RTN","ECXLBB1",39,0)
 . S ECXPHY=$P(EC0,U,5),(ECXPHYPC,ECARRY(10),ECPHYNPI,ECREQNPI)=""
"RTN","ECXLBB1",40,0)
 . I ECXPHY]"" S ECXPHY=$O(^VA(200,"B",ECXPHY,0))
"RTN","ECXLBB1",41,0)
 . I ECXPHY>0 D
"RTN","ECXLBB1",42,0)
 .. N PERCLS S PERCLS=$$GET^XUA4A72(ECXPHY,ECD)
"RTN","ECXLBB1",43,0)
 .. I +PERCLS>0 S ECXPHYPC=$P(PERCLS,U,7)
"RTN","ECXLBB1",44,0)
 .. S ECPHYNPI=$$NPI^XUSNPI("Individual_ID",ECXPHY,ECD)
"RTN","ECXLBB1",45,0)
 .. S:+ECPHYNPI'>0 ECPHYNPI="" S ECPHYNPI=$P(ECPHYNPI,U)
"RTN","ECXLBB1",46,0)
 .. S ECXPHY=2_ECXPHY
"RTN","ECXLBB1",47,0)
 . I ECARRY(9)>0 D
"RTN","ECXLBB1",48,0)
 .. N PERCLS S PERCLS=$$GET^XUA4A72(ECARRY(9),ECD)
"RTN","ECXLBB1",49,0)
 .. I +PERCLS>0 S ECARRY(10)=$P(PERCLS,U,7)
"RTN","ECXLBB1",50,0)
 .. S ECREQNPI=$$NPI^XUSNPI("Individual_ID",ECARRY(9),ECD)
"RTN","ECXLBB1",51,0)
 .. S:+ECREQNPI'>0 ECREQNPI="" S ECREQNPI=$P(ECREQNPI,U)
"RTN","ECXLBB1",52,0)
 .. S ECARRY(9)=2_ECARRY(9)
"RTN","ECXLBB1",53,0)
 . D GETDATA
"RTN","ECXLBB1",54,0)
 . K ECARRY
"RTN","ECXLBB1",55,0)
 Q
"RTN","ECXLBB1",56,0)
 ;
"RTN","ECXLBB1",57,0)
GETDATA ; gather rest of extract data that will be recorded in an 
"RTN","ECXLBB1",58,0)
 ; entry in file 727.829
"RTN","ECXLBB1",59,0)
 S ECTRFDT=$$ECXDOB^ECXUTL(ECARRY(1)),ECTRFTM=$$ECXTIME^ECXUTL(ECARRY(1))
"RTN","ECXLBB1",60,0)
 S ECX=$$INP^ECXUTL2(ECXDFN,ECARRY(1)),ECINOUT=$P(ECX,U),ECTRSP=$P(ECX,U,3),ECADMT=$P(ECX,U,4)
"RTN","ECXLBB1",61,0)
 ;
"RTN","ECXLBB1",62,0)
 ;- Observation patient indicator (YES/NO)
"RTN","ECXLBB1",63,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECINOUT,ECTRSP)
"RTN","ECXLBB1",64,0)
 ;- If no encounter number don't file record
"RTN","ECXLBB1",65,0)
 S ECENCTR=$$ENCNUM^ECXUTL4(ECINOUT,ECPAT("SSN"),ECADMT,ECARRY(1),ECTRSP,ECXOBS,ECHEAD,,) ; [FLD #6]
"RTN","ECXLBB1",66,0)
 Q:ECENCTR=""
"RTN","ECXLBB1",67,0)
 ;get emergency response indicator (FEMA)
"RTN","ECXLBB1",68,0)
 S ECXERI=$G(ECPAT("ERI"))
"RTN","ECXLBB1",69,0)
 ;
"RTN","ECXLBB1",70,0)
 S ECXSTR=$G(EC23)_"^"_ECINST_"^"_ECXDFN_"^"_ECPAT("SSN")_"^"_ECPAT("NAME")_"^"_ECINOUT_"^"_ECENCTR_"^"_ECTRFDT_"^"_ECTRFTM_"^"_ECARRY(3)_"^"_ECARRY(4)_"^"_ECARRY(5)_"^"_ECARRY(7)_"^"_ECARRY(6)_"^"_ECARRY(8)_"^BB"_ECARRY(13)_"^^"
"RTN","ECXLBB1",71,0)
 I $G(ECXLOGIC)>2005 S ECXSTR=ECXSTR_U_ECXPHY_U_ECXPHYPC
"RTN","ECXLBB1",72,0)
 I $G(ECXLOGIC)>2006 D
"RTN","ECXLBB1",73,0)
 .S ECXSTR=ECXSTR_U_ECXERI_U_ECARRY(11)_U_ECARRY(12)_U_ECARRY(9)_U_ECARRY(10)_U_ECARRY(13)_U
"RTN","ECXLBB1",74,0)
 I '$D(ECXRPT) D FILE(ECXSTR) Q
"RTN","ECXLBB1",75,0)
 S ^TMP("ECXLBB",$J,ECXDFN,ECD)=ECXSTR  ;temporary global array
"RTN","ECXLBB1",76,0)
 ;   used in ECXPLBB (pre-extract audit report)
"RTN","ECXLBB1",77,0)
 Q
"RTN","ECXLBB1",78,0)
 ;
"RTN","ECXLBB1",79,0)
PAT(ECXDFN) ;get/set patient data
"RTN","ECXLBB1",80,0)
 ; INPUT - ECXDFN = patient ien (DFN)
"RTN","ECXLBB1",81,0)
 ; OUTPUT - ECPAT array:
"RTN","ECXLBB1",82,0)
 ;          ECPAT("SSN")
"RTN","ECXLBB1",83,0)
 ;          ECPAT("NAME")
"RTN","ECXLBB1",84,0)
 ; returns 0 or 1 in ECXERR - 0=successful
"RTN","ECXLBB1",85,0)
 ;                            1=error condition
"RTN","ECXLBB1",86,0)
 N X,OK,ECXERR
"RTN","ECXLBB1",87,0)
 ;get data
"RTN","ECXLBB1",88,0)
 S ECXERR=0
"RTN","ECXLBB1",89,0)
 K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,"","1;3",.ECPAT)
"RTN","ECXLBB1",90,0)
 I 'OK S ECXERR=1
"RTN","ECXLBB1",91,0)
 Q ECXERR
"RTN","ECXLBB1",92,0)
 ;
"RTN","ECXLBB1",93,0)
FILE(ECODE) ;
"RTN","ECXLBB1",94,0)
 ; Input - ECODE = extract record
"RTN","ECXLBB1",95,0)
 ;
"RTN","ECXLBB1",96,0)
 ; record the extract record at a global node in file 727.829
"RTN","ECXLBB1",97,0)
 ; sequence #^year/month of extract^extract #^facility^patient dfn^SSN^
"RTN","ECXLBB1",98,0)
 ; name^i/o pt indicator^encounter #^date of transfusion^time of 
"RTN","ECXLBB1",99,0)
 ; transfusion^component^component abbrev^# of units^volume in mm^
"RTN","ECXLBB1",100,0)
 ; reaction^reaction type^feeder location^DSS product dept^DSS IP #
"RTN","ECXLBB1",101,0)
 ; ordering physician^ordering physician pc^emergency response indicator
"RTN","ECXLBB1",102,0)
 ; (FEMA)^unit modified^unit modification^requesting provider^request. 
"RTN","ECXLBB1",103,0)
 ; provider person class^ordering provider npi ECPHYNPI
"RTN","ECXLBB1",104,0)
 ;ECODE1- requesting provider npi ECREQNPI
"RTN","ECXLBB1",105,0)
 ;note:  DSS product dept and DSS IP # are dependent on the release of
"RTN","ECXLBB1",106,0)
 ; ECX*3*61
"RTN","ECXLBB1",107,0)
 N DA,DIK,EC7
"RTN","ECXLBB1",108,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXLBB1",109,0)
 S ECODE=EC7_"^"_ECODE
"RTN","ECXLBB1",110,0)
 I ECXLOGIC>2007 D
"RTN","ECXLBB1",111,0)
 .S ECODE=ECODE_ECPHYNPI_U
"RTN","ECXLBB1",112,0)
 .S ECODE1=$G(ECREQNPI)
"RTN","ECXLBB1",113,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=$G(ECODE1),ECRN=ECRN+1
"RTN","ECXLBB1",114,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXLBB1",115,0)
 Q
"RTN","ECXLBB1",116,0)
 ;
"RTN","ECXLBB1",117,0)
SETUP ;Set required input for ECXTRAC.
"RTN","ECXLBB1",118,0)
 S ECHEAD="LBB"
"RTN","ECXLBB1",119,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXLBB1",120,0)
 Q
"RTN","ECXLBB1",121,0)
 ;
"RTN","ECXLBB1",122,0)
LOCAL ; to extract nightly for local use not to be transmitted to TSI
"RTN","ECXLBB1",123,0)
 ; should be queued with a 1D frequency
"RTN","ECXLBB1",124,0)
 D SETUP,^ECXTLOCL,^ECXKILL Q
"RTN","ECXLBB1",125,0)
 ;
"RTN","ECXLBB1",126,0)
CHKMOD(MD) ;check if modifier is contained in string
"RTN","ECXLBB1",127,0)
 N RES,MODX
"RTN","ECXLBB1",128,0)
 I MD="" Q ""
"RTN","ECXLBB1",129,0)
 S (RES,MODX)="" F  S MODX=$O(MODARY(MODX)) Q:MODX=""  D  I RES'="" Q
"RTN","ECXLBB1",130,0)
 .I MD[MODX S RES=MODARY(MODX)
"RTN","ECXLBB1",131,0)
 Q RES
"RTN","ECXLBB1",132,0)
 ;
"RTN","ECXLBB1",133,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXLBB1",134,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL
"RTN","ECXLBB1",135,0)
 Q
"RTN","ECXLBB1",136,0)
 ;
"RTN","ECXLBB1",137,0)
 ;ECXLBB
"RTN","ECXPURG")
0^2^B19455124^B15706994
"RTN","ECXPURG",1,0)
ECXPURG ;BIR/CML-Driver for Purge of DSS Data from Local Extract & Holding Files ; 4/17/07 2:35pm
"RTN","ECXPURG",2,0)
 ;;3.0;DSS EXTRACTS;**9,24,33,35,49,102**;Dec 22, 1997;Build 17
"RTN","ECXPURG",3,0)
EN ;entry point from option
"RTN","ECXPURG",4,0)
 W @IOF,!!,"This option will allow you to purge:"
"RTN","ECXPURG",5,0)
 W !,"1. individual or a range of DSS extracts, or"
"RTN","ECXPURG",6,0)
 W !,"2. data that resides in the ""holding files"" for the IVP and UDP extracts."
"RTN","ECXPURG",7,0)
 W !,"3. data that resides in the ""holding file"" for the VBECS extract"
"RTN","ECXPURG",8,0)
 W !!,"Care must be taken for several reasons:"
"RTN","ECXPURG",9,0)
 W !!,"-  You can purge ANY existing extract.  This includes transmitted and non-"
"RTN","ECXPURG",10,0)
 W !,"   transmitted extracts as well as extracts that did not run to completion"
"RTN","ECXPURG",11,0)
 W !,"   due to errors or system problems."
"RTN","ECXPURG",12,0)
 W !,"-  Choosing a range of extracts (or a broad date range for the ""holding"
"RTN","ECXPURG",13,0)
 W !,"   files"") could mean an excessively large number of records and be very"
"RTN","ECXPURG",14,0)
 W !,"   CPU intensive.  Please be sure to queue this purge for off-hours and"
"RTN","ECXPURG",15,0)
 W !,"   limit the number of extracts to be purged per a single queued session."
"RTN","ECXPURG",16,0)
 W !,"-  The IVP, UDP and VBECS ""holding"" files are intermediate files that"
"RTN","ECXPURG",17,0)
 W !,"   are populated ""realtime"" by inpatient pharmacy and VBECS activity. These"
"RTN","ECXPURG",18,0)
 W !,"   files are then used to generate the IVP, UDP and VBECS extracts and CANNOT be"
"RTN","ECXPURG",19,0)
 W !,"   recreated. Once they are purged for a date range, extracts can no longer be"
"RTN","ECXPURG",20,0)
 W !,"   generated for that time period."
"RTN","ECXPURG",21,0)
 ;
"RTN","ECXPURG",22,0)
 K DIR W !
"RTN","ECXPURG",23,0)
 S DIR(0)="SAM^E:Extract Files;I:IVP Holding File;U:UDP Holding File;V:VBECS Holding File"
"RTN","ECXPURG",24,0)
 S DIR("A")="Purge (E)xtract files, (I)VP data, (U)DP data or (V)BECS data? "
"RTN","ECXPURG",25,0)
 D ^DIR K DIR G:$D(DIRUT) QUIT S ECY=Y
"RTN","ECXPURG",26,0)
 I ECY="E" D ^ECXPURG1 I $D(ECLOC) S ZTSAVE("ECLOC(")="",ZTIO="",ZTRTN="PUR1^ECXPURG",ZTDESC="DSS - Purge of Extract Files" D QUE
"RTN","ECXPURG",27,0)
 I ECY="I" D DATES^ECXPURG1 I $D(ECBDT)&($D(ECEDT)) S (ZTSAVE("ECBDT"),ZTSAVE("ECEDT"))="",ZTIO="",ZTRTN="PUR2^ECXPURG",ZTDESC="DSS - Purge of IVP Holding File" D QUE
"RTN","ECXPURG",28,0)
 I ECY="U" D DATES^ECXPURG1 I $D(ECBDT)&($D(ECEDT)) S (ZTSAVE("ECBDT"),ZTSAVE("ECEDT"))="",ZTIO="",ZTRTN="PUR3^ECXPURG",ZTDESC="DSS - Purge of UDP Holding File" D QUE
"RTN","ECXPURG",29,0)
 I ECY="V" D DATES^ECXPURG1 I $D(ECBDT)&($D(ECEDT)) S (ZTSAVE("ECBDT"),ZTSAVE("ECEDT"))="",ZTIO="",ZTRTN="PUR4^ECXPURG",ZTDESC="DSS - Purge of VBECS Holding File" D QUE
"RTN","ECXPURG",30,0)
QUIT ;
"RTN","ECXPURG",31,0)
 K %X,%Y,EC,ECBDT,ECDATE,ECDT,ECEDT,ECEX,ECFR,ECLOC,ECRC,ECTO,ECTRN,ECTYP,ECY,HDT,HI,JJ,LN,LO,PG,QFLG,SS,X,Y,ZTSK
"RTN","ECXPURG",32,0)
 K ECXDIV
"RTN","ECXPURG",33,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECXPURG",34,0)
 Q
"RTN","ECXPURG",35,0)
QUE W $C(7),$C(7),!!?3,"<<This purge should be queued to run during non-peak hours.>>",!
"RTN","ECXPURG",36,0)
 D ^%ZTLOAD
"RTN","ECXPURG",37,0)
 I $D(ZTSK) W !,"Request queued as Task #",ZTSK,".",!
"RTN","ECXPURG",38,0)
 Q
"RTN","ECXPURG",39,0)
 ;
"RTN","ECXPURG",40,0)
PUR1 ; entry point for queued purge job of extract files
"RTN","ECXPURG",41,0)
 S ECDA=0 F  S ECDA=$O(ECLOC(ECDA)) Q:'ECDA  D
"RTN","ECXPURG",42,0)
 .S ECFILE=^ECX(727,ECDA,"FILE"),ECJ=0
"RTN","ECXPURG",43,0)
 .I ECFILE=727.827 D
"RTN","ECXPURG",44,0)
 ..S DA(1)=1
"RTN","ECXPURG",45,0)
 ..S DA=$O(^ECX(728,DA(1),"CBOC","B",ECDA,0))
"RTN","ECXPURG",46,0)
 ..S DIK="^ECX(728,"_DA(1)_","_"""CBOC"""_","
"RTN","ECXPURG",47,0)
 ..I DA'="" D ^DIK K DIK,DA
"RTN","ECXPURG",48,0)
 .F  S ECJ=$O(^ECX(ECFILE,"AC",ECDA,ECJ)) Q:'ECJ  D
"RTN","ECXPURG",49,0)
 ..S DIK="^ECX("_ECFILE_",",DA=ECJ D ^DIK K DIK,DA
"RTN","ECXPURG",50,0)
 .I ECFILE=727.816 S ECFILE=727.818,ECJ=0 D
"RTN","ECXPURG",51,0)
 ..F  S ECJ=$O(^ECX(ECFILE,"AC",ECDA,ECJ)) Q:'ECJ  D
"RTN","ECXPURG",52,0)
 ...S DIK="^ECX("_ECFILE_",",DA=ECJ D ^DIK K DIK,DA
"RTN","ECXPURG",53,0)
 .S ^ECX(727,ECDA,"PURG")=DT
"RTN","ECXPURG",54,0)
 D QUIT
"RTN","ECXPURG",55,0)
 Q
"RTN","ECXPURG",56,0)
 ;
"RTN","ECXPURG",57,0)
PUR2 ; entry point for queued purge job of IVP holding file (#728.113)
"RTN","ECXPURG",58,0)
 F ECDT=ECBDT-1:0 S ECDT=$O(^ECX(728.113,"A",ECDT)) Q:'ECDT  Q:ECDT>ECEDT  S ECPT=0 F  S ECPT=$O(^ECX(728.113,"A",ECDT,ECPT)) Q:'ECPT  D
"RTN","ECXPURG",59,0)
 .S ECOR=0 F  S ECOR=$O(^ECX(728.113,"A",ECDT,ECPT,ECOR)) Q:'ECOR  D
"RTN","ECXPURG",60,0)
 ..S ECREC=0 F  S ECREC=$O(^ECX(728.113,"A",ECDT,ECPT,ECOR,ECREC)) Q:'ECREC  D
"RTN","ECXPURG",61,0)
 ...S DIK="^ECX(728.113,",DA=ECREC D ^DIK K DIK,DA
"RTN","ECXPURG",62,0)
 D QUIT
"RTN","ECXPURG",63,0)
 Q
"RTN","ECXPURG",64,0)
 ;
"RTN","ECXPURG",65,0)
PUR3 ; entry point for queued purge job of UDP holding file (#728.904)
"RTN","ECXPURG",66,0)
 F ECDT=ECBDT-1:0 S ECDT=$O(^ECX(728.904,"A",ECDT)) Q:'ECDT  Q:ECDT>ECEDT  D
"RTN","ECXPURG",67,0)
 .S ECREC=0 F  S ECREC=$O(^ECX(728.904,"A",ECDT,ECREC)) Q:'ECREC  D
"RTN","ECXPURG",68,0)
 ..S DIK="^ECX(728.904,",DA=ECREC D ^DIK K DIK,DA
"RTN","ECXPURG",69,0)
 D QUIT
"RTN","ECXPURG",70,0)
 Q
"RTN","ECXPURG",71,0)
 ;
"RTN","ECXPURG",72,0)
PUR4 ; entry point for queued purge job of VBECS holding file (#6002.03)
"RTN","ECXPURG",73,0)
 N ECDT,ECREC,DIK,DA
"RTN","ECXPURG",74,0)
 S ECDT=ECBDT-1,ECEDT=ECEDT+.9
"RTN","ECXPURG",75,0)
 F  S ECDT=$O(^VBEC(6002.03,"C",ECDT)) Q:'ECDT!(ECDT>ECEDT)  D
"RTN","ECXPURG",76,0)
 .S ECREC=0 F  S ECREC=$O(^VBEC(6002.03,"C",ECDT,ECREC)) Q:'ECREC  D
"RTN","ECXPURG",77,0)
 ..S DIK="^VBEC(6002.03,",DA=ECREC D ^DIK K DIK,DA
"RTN","ECXPURG",78,0)
 Q
"RTN","ECXPURG1")
0^3^B37781979^B35510892
"RTN","ECXPURG1",1,0)
ECXPURG1 ;BIR/CML-Purge of DSS Extract Files (CONTINUED) ; 5/27/08 9:26am
"RTN","ECXPURG1",2,0)
 ;;3.0;DSS EXTRACTS;**2,9,8,24,49,102**;Dec 22, 1997;Build 17
"RTN","ECXPURG1",3,0)
GET ;compile list of purgable extracts
"RTN","ECXPURG1",4,0)
 K HI,LO,ECBDT,ECEDT,ECLOC,^TMP("ECXPURG",$J)
"RTN","ECXPURG1",5,0)
 S QFLG=1 W !!,"...one moment please"
"RTN","ECXPURG1",6,0)
 S ECEX=0 F  S ECEX=$O(^ECX(727,ECEX)) Q:'ECEX  I '$G(^ECX(727,ECEX,"PURG")),$D(^ECX(727,ECEX,0)) S EC=^(0) D
"RTN","ECXPURG1",7,0)
 .S ^TMP("ECXPURG",$J,$P(EC,U,3),ECEX)="",ECLOC(ECEX)=$P(EC,U,3)_U_$P(EC,U,4,5)
"RTN","ECXPURG1",8,0)
 I '$D(^TMP("ECXPURG",$J)) W !!,"There are no extracts that can be purged at this time." G DONE
"RTN","ECXPURG1",9,0)
ASK1 ;ask for print
"RTN","ECXPURG1",10,0)
 W !
"RTN","ECXPURG1",11,0)
 K DIR S DIR(0)="Y",DIR("A")="Do you want to print a list of extracts that can be purged",DIR("B")="NO"
"RTN","ECXPURG1",12,0)
 D ^DIR K DIR I $D(DIRUT) K ECLOC G DONE
"RTN","ECXPURG1",13,0)
 G:'Y ASK2
"RTN","ECXPURG1",14,0)
 W !!,"The right margin for this report is 80.",!!
"RTN","ECXPURG1",15,0)
 K ZTSAVE S ZTSAVE("^TMP(""ECXPURG"",$J,")=""
"RTN","ECXPURG1",16,0)
 D EN^XUTMDEVQ("PRT^ECXPURG1","DSS - Print Purgable Extracts",.ZTSAVE) I 'POP G ASK2
"RTN","ECXPURG1",17,0)
 W !,"NO DEVICE SELECTED OR REPORT PRINTED!!"
"RTN","ECXPURG1",18,0)
ASK2 ;ask for extract range
"RTN","ECXPURG1",19,0)
 ;
"RTN","ECXPURG1",20,0)
 ;** Check divisions for purging
"RTN","ECXPURG1",21,0)
 N ECCHK,ECTMP
"RTN","ECXPURG1",22,0)
 S ECCHK=$$DIV4^XUSER(.ECTMP,DUZ)
"RTN","ECXPURG1",23,0)
 I 'ECCHK DO
"RTN","ECXPURG1",24,0)
 .W !,"You do not have any divisions defined in your user set up and can not purge."
"RTN","ECXPURG1",25,0)
 .S DIR(0)="FAO^1:1",DIR("A")="Hit Return to continue." D ^DIR K DIR,X,Y
"RTN","ECXPURG1",26,0)
 .K ECLOC
"RTN","ECXPURG1",27,0)
 ;
"RTN","ECXPURG1",28,0)
 I 'ECCHK G DONE  ;** (essentially) QUIT out of middle
"RTN","ECXPURG1",29,0)
 ;
"RTN","ECXPURG1",30,0)
 W !,"You will not be able to select an extract that is not from your division.",!
"RTN","ECXPURG1",31,0)
 S LO=$O(ECLOC(0)),HI=$O(ECLOC(" "),-1)
"RTN","ECXPURG1",32,0)
 S DIR(0)="L^"_LO_":"_HI_"",DIR("A")="Select extracts to be purged"
"RTN","ECXPURG1",33,0)
 S DIR("?",1)="Choose the number(s) of the extract(s) you wish to purge,",DIR("?")="(e.g. 1-3,17,20 to choose 1 thru 3, 17, and 20)."
"RTN","ECXPURG1",34,0)
 W ! D ^DIR K DIR I $D(DIRUT) K ECLOC G DONE
"RTN","ECXPURG1",35,0)
 S JJ=0,Y=","_Y F  S JJ=$O(ECLOC(JJ)) Q:'JJ  S JZ=","_JJ_"," I Y'[JZ K ECLOC(JJ)
"RTN","ECXPURG1",36,0)
 D CBOCCHK(.ECLOC) I '$D(ECLOC) G GET
"RTN","ECXPURG1",37,0)
 D DIVCHK(.ECLOC,.ECTMP)
"RTN","ECXPURG1",38,0)
 I '$D(ECLOC) W !!,"You have not chosen a valid extract number.  Try again." G GET
"RTN","ECXPURG1",39,0)
ASK3 W !!,"I will purge the following extract(s):"
"RTN","ECXPURG1",40,0)
 S JJ=0 F  S JJ=$O(ECLOC(JJ)) Q:'JJ  D
"RTN","ECXPURG1",41,0)
 .W !?5,"#",JJ," - ",$P(ECLOC(JJ),U)
"RTN","ECXPURG1",42,0)
 .W ?47,$TR($$FMTE^XLFDT($P(ECLOC(JJ),U,2),"5DF")," ","0")," to ",$TR($$FMTE^XLFDT($P(ECLOC(JJ),U,3),"5DF")," ","0")
"RTN","ECXPURG1",43,0)
 W !! K DIR S DIR(0)="Y",DIR("A")="Is this OK",DIR("B")="NO"
"RTN","ECXPURG1",44,0)
 S DIR("?",1)="    Enter:"
"RTN","ECXPURG1",45,0)
 S DIR("?",2)="      ""YES"" if you agree with this list and would like to proceed,"
"RTN","ECXPURG1",46,0)
 S DIR("?",3)="       ""NO"" if you would like to make a different selection, or"
"RTN","ECXPURG1",47,0)
 S DIR("?")="        ""^"" to exit option."
"RTN","ECXPURG1",48,0)
 D ^DIR K DIR I $D(DIRUT) K ECLOC G DONE
"RTN","ECXPURG1",49,0)
 I 'Y G GET
"RTN","ECXPURG1",50,0)
 ; at this point, the local array ECLOC( is passed back to ^ECXPURG
"RTN","ECXPURG1",51,0)
 G DONE
"RTN","ECXPURG1",52,0)
QUIT ;
"RTN","ECXPURG1",53,0)
 I $E(IOST)="C"&('QFLG) S DIR(0)="E" D  D ^DIR K DIR
"RTN","ECXPURG1",54,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXPURG1",55,0)
 W:$E(IOST)'="C" @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECXPURG1",56,0)
DONE K ^TMP("ECXPURG",$J),ZTSK Q
"RTN","ECXPURG1",57,0)
PRT ;print list of extracts
"RTN","ECXPURG1",58,0)
 S (PG,QFLG)=0,$P(LN,"-",81)="" D NOW^%DTC S Y=$E(%,1,12) X ^DD("DD") S HDT=Y D HDR
"RTN","ECXPURG1",59,0)
 S ECTYP="" F  S ECTYP=$O(^TMP("ECXPURG",$J,ECTYP)) Q:ECTYP=""  Q:QFLG  D:$Y+4>IOSL HDR Q:QFLG  W !!,ECTYP D
"RTN","ECXPURG1",60,0)
 .S ECEX=0 F  S ECEX=$O(^TMP("ECXPURG",$J,ECTYP,ECEX)) Q:'ECEX  Q:QFLG  I $D(^ECX(727,ECEX,0)) S EC=^(0) D
"RTN","ECXPURG1",61,0)
 ..S ECDT=$$FMTE^XLFDT($P(EC,U,2),"D")
"RTN","ECXPURG1",62,0)
 ..S ECFR=$TR($$FMTE^XLFDT($P(EC,U,4),"5DF")," ","0")
"RTN","ECXPURG1",63,0)
 ..S ECTO=$TR($$FMTE^XLFDT($P(EC,U,5),"5DF")," ","0")
"RTN","ECXPURG1",64,0)
 ..S ECRC=$P(EC,U,6) S:ECRC="" ECRC="Incomplete"
"RTN","ECXPURG1",65,0)
 ..S ECTRN=$$FMTE^XLFDT($G(^ECX(727,ECEX,"TR")),"D")
"RTN","ECXPURG1",66,0)
 ..S ECXDIV=$P($G(^ECX(727,ECEX,"DIV")),U,1) I ECXDIV D
"RTN","ECXPURG1",67,0)
 ...K ECXDIC S DA=ECXDIV,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPURG1",68,0)
 ...D EN^DIQ1 S ECXDIV=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPURG1",69,0)
 ..D:$Y+3>IOSL HDR Q:QFLG
"RTN","ECXPURG1",70,0)
 ..W !?1,ECEX,?11,ECDT,?25,ECFR,"-",ECTO,?48,$J(ECRC,9),?60,ECTRN,?75,ECXDIV
"RTN","ECXPURG1",71,0)
 G QUIT
"RTN","ECXPURG1",72,0)
HDR ;HEADER
"RTN","ECXPURG1",73,0)
 I $E(IOST)="C" S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXPURG1",74,0)
 I $E(IOST)="C",PG>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","ECXPURG1",75,0)
 S PG=PG+1 W:$Y!($E(IOST)="C") @IOF W !,"PURGABLE EXTRACTS",?72,"Page: ",PG,!,"Printed on ",HDT,!
"RTN","ECXPURG1",76,0)
 W !,"FEEDER SYS",?12,"EXTRACT,",!,"EXTRACT #",?12,"DATE",?33,"FROM-TO",?48,"RECORD CNT",?60,"TRANSMIT DATE",?75,"DIV",!,LN
"RTN","ECXPURG1",77,0)
 Q
"RTN","ECXPURG1",78,0)
DATES ;ask for date range for purge of holding files
"RTN","ECXPURG1",79,0)
 K HI,LO,ECBDT,ECEDT
"RTN","ECXPURG1",80,0)
 I ECY="I" D
"RTN","ECXPURG1",81,0)
 .I '$O(^ECX(728.113,0)) W !!,"You have no data in the IVP holding file (file #728.113) to purge." Q
"RTN","ECXPURG1",82,0)
 .S LO=$O(^ECX(728.113,"A",0)),HI=$O(^ECX(728.113,"A"," "),-1)
"RTN","ECXPURG1",83,0)
 I ECY="U" D
"RTN","ECXPURG1",84,0)
 .I '$O(^ECX(728.904,0)) W !!,"You have no data in the UDP holding file (file #728.904) to purge." Q
"RTN","ECXPURG1",85,0)
 .S LO=$O(^ECX(728.904,"A",0)),HI=$O(^ECX(728.904,"A"," "),-1)
"RTN","ECXPURG1",86,0)
 I ECY="V" D
"RTN","ECXPURG1",87,0)
 .I '$O(^VBEC(6002.03,0)) W !!,"You have no data in the VBECS holding file (file #6002.03) to purge." Q
"RTN","ECXPURG1",88,0)
 .S LO=$O(^VBEC(6002.03,"C",0)),HI=$O(^VBEC(6002.03,"C"," "),-1)
"RTN","ECXPURG1",89,0)
 Q:$G(LO)=""
"RTN","ECXPURG1",90,0)
 W @IOF,!!,"This file currently holds ",$S(ECY="I":"IVP",ECY="U":"UDP",1:"VBECS")," data from <",$$FMTE^XLFDT(LO,"D"),"> to <",$$FMTE^XLFDT(HI,"D"),">."
"RTN","ECXPURG1",91,0)
 W ! K DIR S DIR(0)="DA^"_LO_":"_HI_":EPX",DIR("A")="Beginning date for purge: " D ^DIR K DIR I $D(DIRUT) K HI,LO Q
"RTN","ECXPURG1",92,0)
 S ECBDT=+Y
"RTN","ECXPURG1",93,0)
 K DIR S DIR(0)="DA^"_ECBDT_":"_HI_":EPX",DIR("A")="Ending date for purge: " D ^DIR K DIR I $D(DIRUT) K HI,LO,ECBDT Q
"RTN","ECXPURG1",94,0)
 S ECEDT=+Y
"RTN","ECXPURG1",95,0)
ASK4 ; ask to confirm date range
"RTN","ECXPURG1",96,0)
 W !!,"I will purge the ",$S(ECY="I":"IVP",ECY="U":"UDP",1:"VBECS")," holding file from <",$$FMTE^XLFDT(ECBDT,"D"),"> to <",$$FMTE^XLFDT(ECEDT,"D"),">."
"RTN","ECXPURG1",97,0)
 W $C(7),$C(7),!!?3,"** REMEMBER - Once this data is purged it CANNOT be recreated. **"
"RTN","ECXPURG1",98,0)
 W !! K DIR S DIR(0)="Y",DIR("A")="Is this OK",DIR("B")="NO"
"RTN","ECXPURG1",99,0)
 S DIR("?",1)="    Enter:"
"RTN","ECXPURG1",100,0)
 S DIR("?",2)="      ""YES"" if you agree with this date range and wish to proceed,"
"RTN","ECXPURG1",101,0)
 S DIR("?",3)="       ""NO"" if you would like to make a different selection, or"
"RTN","ECXPURG1",102,0)
 S DIR("?")="        ""^"" to exit option."
"RTN","ECXPURG1",103,0)
 D ^DIR K DIR I $D(DIRUT) K ECBDT,ECEDT Q 
"RTN","ECXPURG1",104,0)
 I 'Y G DATES
"RTN","ECXPURG1",105,0)
 ; at this point, ECBDT and ECEDT are passed back to ^ECXPURG
"RTN","ECXPURG1",106,0)
 Q
"RTN","ECXPURG1",107,0)
 ;
"RTN","ECXPURG1",108,0)
DIVCHK(ECLOC,ECTMP) ;**Remove extracts from ECLOC that are for user's div.
"RTN","ECXPURG1",109,0)
 N ECLPDA
"RTN","ECXPURG1",110,0)
 S ECLPDA=0
"RTN","ECXPURG1",111,0)
 F  S ECLPDA=$O(ECLOC(ECLPDA)) Q:(+ECLPDA=0)  DO
"RTN","ECXPURG1",112,0)
 .I '$D(ECTMP($P(^ECX(727,ECLPDA,"DIV"),U,1))) KILL ECLOC(ECLPDA)
"RTN","ECXPURG1",113,0)
 Q
"RTN","ECXPURG1",114,0)
CBOCCHK(ECLOC) ;**Check that CBOC report has been viewed prior to purging
"RTN","ECXPURG1",115,0)
 N LOOPDA,YYYMMDD
"RTN","ECXPURG1",116,0)
 S LOOPDA=0
"RTN","ECXPURG1",117,0)
 F  S LOOPDA=$O(ECLOC(LOOPDA)) Q:(+LOOPDA=0)  D
"RTN","ECXPURG1",118,0)
 .I ^ECX(727,LOOPDA,"HEAD")="CLI" D
"RTN","ECXPURG1",119,0)
 ..S DA(1)=1
"RTN","ECXPURG1",120,0)
 ..S YYYMMDD=$P(^ECX(727,LOOPDA,0),U,4)
"RTN","ECXPURG1",121,0)
 ..I YYYMMDD>3030930 I '$D(^ECX(728,DA(1),"CBOC","B",LOOPDA)) D
"RTN","ECXPURG1",122,0)
 ...K DIR S DIR(0)="Y",DIR("A")="The CBOC Activity Report has not been viewed.  Purge anyway",DIR("B")="NO"
"RTN","ECXPURG1",123,0)
 ...D ^DIR K DIR I 'Y K ECLOC(LOOPDA)
"RTN","ECXPURG1",124,0)
 Q
"VER")
8.0^22.0
"^DD",727.829,727.829,3,0)
FACILITY^F^^0;4^K:$L(X)>7!($L(X)<1) X
"^DD",727.829,727.829,3,.1)
Facility
"^DD",727.829,727.829,3,3)
Answer must be 1-7 characters in length.
"^DD",727.829,727.829,3,21,0)
^.001^1^1^3080227^^^^
"^DD",727.829,727.829,3,21,1,0)
Identifies the facility for this extract record.
"^DD",727.829,727.829,3,23,0)
^^7^7^3080227^
"^DD",727.829,727.829,3,23,1,0)
VistA Records: An indicator of the division where this event happened.
"^DD",727.829,727.829,3,23,2,0)
Using the NAME field (.01) pointer from the DSS EXTRACTS file (#728),
"^DD",727.829,727.829,3,23,3,0)
FACILITY is derived from the STATION NUMBER field (99) for that pointer
"^DD",727.829,727.829,3,23,4,0)
number in the INSTITUTION file (#4). 
"^DD",727.829,727.829,3,23,5,0)
 
"^DD",727.829,727.829,3,23,6,0)
VBECS Records: The value is coming from the ORDERING LOCATION field (#2)
"^DD",727.829,727.829,3,23,7,0)
of the VBECS DSS EXTRACT file (#6002.03).
"^DD",727.829,727.829,3,"DT")
3040513
"^DD",727.829,727.829,17,0)
FEEDER LOCATION^F^^0;18^K:$L(X)>9!($L(X)<1) X
"^DD",727.829,727.829,17,3)
Answer must be 1-9 characters in length
"^DD",727.829,727.829,17,21,0)
^.001^2^2^3080226^^
"^DD",727.829,727.829,17,21,1,0)
Feeder locations are station-specific locations that are specific to each
"^DD",727.829,727.829,17,21,2,0)
extract.  
"^DD",727.829,727.829,17,23,0)
^^2^2^3080226^
"^DD",727.829,727.829,17,23,1,0)
Feeder Location in Blood Bank extract is BB concatenated with Production 
"^DD",727.829,727.829,17,23,2,0)
Division Code.
"^DD",727.829,727.829,17,"DT")
3041202
"^DD",727.829,727.829,27,0)
PRODUCTION DIVISION CODE^F^^0;28^K:$L(X)>6!($L(X)<3) X
"^DD",727.829,727.829,27,3)
Answer must be 3-6 characters in length.
"^DD",727.829,727.829,27,21,0)
^.001^2^2^3080227^^^^
"^DD",727.829,727.829,27,21,1,0)
Data represents the medical center division the work was performed in. 
"^DD",727.829,727.829,27,21,2,0)
This field corresponds to an entry in the INSTITUTION file (#4).
"^DD",727.829,727.829,27,23,0)
^^6^6^3080227^
"^DD",727.829,727.829,27,23,1,0)
VistA Records: Data comes from the DIV field (#26) of subfile (#68.02). 
"^DD",727.829,727.829,27,23,2,0)
Subfile (#68.02) is the ACCESSION NUMBER field (#1) in subfile (#68.01). 
"^DD",727.829,727.829,27,23,3,0)
Subfile (#68.01) is the DATE field (#2) in the ACCESSION file (#68). 
"^DD",727.829,727.829,27,23,4,0)
 
"^DD",727.829,727.829,27,23,5,0)
VBECS Records: Data comes from the TRANSFUSION LOCATION field (#3) of the 
"^DD",727.829,727.829,27,23,6,0)
VBECS DSS EXTRACT file (#6002.03).
"^DD",727.829,727.829,27,"DT")
3060524
"BLD",7001,6)
^102
**END**
**END**

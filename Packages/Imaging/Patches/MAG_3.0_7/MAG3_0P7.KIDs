KIDS Distribution saved on Jul 12, 2002@14:22:39
VistA Imaging v3.0 patch 7
**KIDS**:MAG*3.0*7^

**INSTALL NAME**
MAG*3.0*7
"BLD",2853,0)
MAG*3.0*7^IMAGING^0^3020712^y
"BLD",2853,1,0)
^^40^40^3020712^
"BLD",2853,1,1,0)
This KIDS install will add the following support:
"BLD",2853,1,2,0)
Imaging import API with Clinical Procedures
"BLD",2853,1,3,0)
Background Processor Enhacements
"BLD",2853,1,4,0)
Support for MIL 6.1 drivers (Meteor II and Orion Capture)
"BLD",2853,1,5,0)
 
"BLD",2853,1,6,0)
Routine checksum:
"BLD",2853,1,7,0)
MAGBAPI   value = 7367416
"BLD",2853,1,8,0)
MAGGSCP   value = 6108869
"BLD",2853,1,9,0)
MAGGSERR  value = 3210527
"BLD",2853,1,10,0)
MAGGSFT   value = 3067100
"BLD",2853,1,11,0)
MAGGSIA   value = 5464426
"BLD",2853,1,12,0)
MAGGSIA1  value = 9791476
"BLD",2853,1,13,0)
MAGGSIM   value = 5360010
"BLD",2853,1,14,0)
MAGGSIU1  value = 3854213
"BLD",2853,1,15,0)
MAGGSIU2  value = 4516888
"BLD",2853,1,16,0)
MAGGSIU3  value = 7186347
"BLD",2853,1,17,0)
MAGGSIUI  value = 11682244
"BLD",2853,1,18,0)
MAGGSIV   value = 12079119
"BLD",2853,1,19,0)
MAGGSPP   value = 3242430
"BLD",2853,1,20,0)
MAGGSTI   value = 6260731
"BLD",2853,1,21,0)
MAGGSU1   value = 2676194
"BLD",2853,1,22,0)
MAGGTAU   value = 9601918
"BLD",2853,1,23,0)
MAGGTSY1  value = 6104608
"BLD",2853,1,24,0)
MAGGTU3   value = 7481270
"BLD",2853,1,25,0)
MAGGTUP   value = 7182048
"BLD",2853,1,26,0)
MAGIPOS7  value = 2508617
"BLD",2853,1,27,0)
MAGQBIM   value = 3963432
"BLD",2853,1,28,0)
MAGQBPG1  value = 11319930
"BLD",2853,1,29,0)
MAGQBPRG  value = 9369062
"BLD",2853,1,30,0)
MAGQBTM   value = 14438732
"BLD",2853,1,31,0)
MAGQBUT   value = 12416907
"BLD",2853,1,32,0)
MAGQBUT1  value = 13611765
"BLD",2853,1,33,0)
MAGQBUT2  value = 15727225
"BLD",2853,1,34,0)
MAGQBUT4  value = 2633801
"BLD",2853,1,35,0)
MAGQST    value = 714956
"BLD",2853,1,36,0)
 
"BLD",2853,1,37,0)
 
"BLD",2853,1,38,0)
 
"BLD",2853,1,39,0)
Please note that routine MAGIPOS7 is deleted after the KIDS application 
"BLD",2853,1,40,0)
is installed.
"BLD",2853,4,0)
^9.64PA^2006.82^9
"BLD",2853,4,2005,0)
2005
"BLD",2853,4,2005,2,0)
^9.641^2005^1
"BLD",2853,4,2005,2,2005,0)
IMAGE  (File-top level)
"BLD",2853,4,2005,2,2005,1,0)
^9.6411^110^5
"BLD",2853,4,2005,2,2005,1,.05,0)
ACQUISITION SITE
"BLD",2853,4,2005,2,2005,1,107,0)
ACQUISITION DEVICE
"BLD",2853,4,2005,2,2005,1,108,0)
TRACKING ID
"BLD",2853,4,2005,2,2005,1,109,0)
CREATE METHOD
"BLD",2853,4,2005,2,2005,1,110,0)
DOCUMENT DATE
"BLD",2853,4,2005,222)
y^y^p^^^^n
"BLD",2853,4,2005.02,0)
2005.02
"BLD",2853,4,2005.02,222)
y^y^f^^n^^y^o^n
"BLD",2853,4,2005.021,0)
2005.021
"BLD",2853,4,2005.021,222)
y^y^f^^n^^y^o^n
"BLD",2853,4,2006.034,0)
2006.034
"BLD",2853,4,2006.034,222)
y^y^f^^^^n
"BLD",2853,4,2006.04,0)
2006.04
"BLD",2853,4,2006.04,222)
y^y^f^^^^n
"BLD",2853,4,2006.041,0)
2006.041
"BLD",2853,4,2006.041,222)
y^y^f^^^^n
"BLD",2853,4,2006.18,0)
2006.18
"BLD",2853,4,2006.18,2,0)
^9.641^2006.18^1
"BLD",2853,4,2006.18,2,2006.18,0)
IMAGING USER PREFERENCE  (File-top level)
"BLD",2853,4,2006.18,2,2006.18,1,0)
^9.6411^8.5^1
"BLD",2853,4,2006.18,2,2006.18,1,8.5,0)
MAIN TOOLBAR
"BLD",2853,4,2006.18,222)
y^y^p^^^^n
"BLD",2853,4,2006.81,0)
2006.81
"BLD",2853,4,2006.81,2,0)
^9.641^2006.81^1
"BLD",2853,4,2006.81,2,2006.81,0)
IMAGING WINDOWS WORKSTATIONS  (File-top level)
"BLD",2853,4,2006.81,2,2006.81,1,0)
^9.6411^12.5^2
"BLD",2853,4,2006.81,2,2006.81,1,12.5,0)
IMPORT COUNT
"BLD",2853,4,2006.81,2,2006.81,1,13,0)
OS VERSION
"BLD",2853,4,2006.81,222)
y^y^p^^^^n
"BLD",2853,4,2006.82,0)
2006.82
"BLD",2853,4,2006.82,2,0)
^9.641^2006.82^1
"BLD",2853,4,2006.82,2,2006.82,0)
IMAGING WINDOWS SESSIONS  (File-top level)
"BLD",2853,4,2006.82,2,2006.82,1,0)
^9.6411^8^1
"BLD",2853,4,2006.82,2,2006.82,1,8,0)
TRACKING ID
"BLD",2853,4,2006.82,222)
y^y^p^^^^n
"BLD",2853,4,"APDD",2005,2005)

"BLD",2853,4,"APDD",2005,2005,.05)

"BLD",2853,4,"APDD",2005,2005,107)

"BLD",2853,4,"APDD",2005,2005,108)

"BLD",2853,4,"APDD",2005,2005,109)

"BLD",2853,4,"APDD",2005,2005,110)

"BLD",2853,4,"APDD",2006.18,2006.18)

"BLD",2853,4,"APDD",2006.18,2006.18,8.5)

"BLD",2853,4,"APDD",2006.81,2006.81)

"BLD",2853,4,"APDD",2006.81,2006.81,12.5)

"BLD",2853,4,"APDD",2006.81,2006.81,13)

"BLD",2853,4,"APDD",2006.82,2006.82)

"BLD",2853,4,"APDD",2006.82,2006.82,8)

"BLD",2853,4,"B",2005,2005)

"BLD",2853,4,"B",2005.02,2005.02)

"BLD",2853,4,"B",2005.021,2005.021)

"BLD",2853,4,"B",2006.034,2006.034)

"BLD",2853,4,"B",2006.04,2006.04)

"BLD",2853,4,"B",2006.041,2006.041)

"BLD",2853,4,"B",2006.18,2006.18)

"BLD",2853,4,"B",2006.81,2006.81)

"BLD",2853,4,"B",2006.82,2006.82)

"BLD",2853,"ABNS",0)
^9.66A^^
"BLD",2853,"ABPKG")
n^y^G.IMGDEV@DOMAIN.EXT
"BLD",2853,"INID")
^y
"BLD",2853,"INIT")
POST^MAGIPOS7
"BLD",2853,"KRN",0)
^9.67PA^8989.52^19
"BLD",2853,"KRN",.4,0)
.4
"BLD",2853,"KRN",.401,0)
.401
"BLD",2853,"KRN",.402,0)
.402
"BLD",2853,"KRN",.403,0)
.403
"BLD",2853,"KRN",.5,0)
.5
"BLD",2853,"KRN",.84,0)
.84
"BLD",2853,"KRN",3.6,0)
3.6
"BLD",2853,"KRN",3.8,0)
3.8
"BLD",2853,"KRN",9.2,0)
9.2
"BLD",2853,"KRN",9.8,0)
9.8
"BLD",2853,"KRN",9.8,"NM",0)
^9.68A^30^28
"BLD",2853,"KRN",9.8,"NM",1,0)
MAGBAPI^^0^B25788368
"BLD",2853,"KRN",9.8,"NM",2,0)
MAGGSCP^^0^B13719298
"BLD",2853,"KRN",9.8,"NM",3,0)
MAGGSERR^^0^B5857043
"BLD",2853,"KRN",9.8,"NM",4,0)
MAGGSFT^^0^B4383221
"BLD",2853,"KRN",9.8,"NM",5,0)
MAGGSIA^^0^B16063692
"BLD",2853,"KRN",9.8,"NM",6,0)
MAGGSIA1^^0^B26495770
"BLD",2853,"KRN",9.8,"NM",7,0)
MAGGSIM^^0^B14481813
"BLD",2853,"KRN",9.8,"NM",8,0)
MAGGSIU1^^0^B6965279
"BLD",2853,"KRN",9.8,"NM",9,0)
MAGGSIU2^^0^B7177780
"BLD",2853,"KRN",9.8,"NM",10,0)
MAGGSIU3^^0^B15853804
"BLD",2853,"KRN",9.8,"NM",11,0)
MAGGSIUI^^0^B41895043
"BLD",2853,"KRN",9.8,"NM",12,0)
MAGGSIV^^0^B33859529
"BLD",2853,"KRN",9.8,"NM",13,0)
MAGGSPP^^0^B5001322
"BLD",2853,"KRN",9.8,"NM",14,0)
MAGGSTI^^0^B17446345
"BLD",2853,"KRN",9.8,"NM",15,0)
MAGGSU1^^0^B4282833
"BLD",2853,"KRN",9.8,"NM",17,0)
MAGGTAU^^0^B42535074
"BLD",2853,"KRN",9.8,"NM",18,0)
MAGGTU3^^0^B26256718
"BLD",2853,"KRN",9.8,"NM",20,0)
MAGQBIM^^0^B7027516
"BLD",2853,"KRN",9.8,"NM",21,0)
MAGQBTM^^0^B94160146
"BLD",2853,"KRN",9.8,"NM",22,0)
MAGQBUT^^0^B48557005
"BLD",2853,"KRN",9.8,"NM",23,0)
MAGQBUT1^^0^B66561900
"BLD",2853,"KRN",9.8,"NM",24,0)
MAGQBUT2^^0^B78253804
"BLD",2853,"KRN",9.8,"NM",25,0)
MAGQBUT4^^0^B3836472
"BLD",2853,"KRN",9.8,"NM",26,0)
MAGGTUP^^0^B18612200
"BLD",2853,"KRN",9.8,"NM",27,0)
MAGQBPG1^^0^B61804702
"BLD",2853,"KRN",9.8,"NM",28,0)
MAGQBPRG^^0^B49321699
"BLD",2853,"KRN",9.8,"NM",29,0)
MAGQST^^0^B22503226
"BLD",2853,"KRN",9.8,"NM",30,0)
MAGGTSY1^^0^B14993203
"BLD",2853,"KRN",9.8,"NM","B","MAGBAPI",1)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSCP",2)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSERR",3)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSFT",4)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSIA",5)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSIA1",6)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSIM",7)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSIU1",8)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSIU2",9)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSIU3",10)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSIUI",11)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSIV",12)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSPP",13)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSTI",14)

"BLD",2853,"KRN",9.8,"NM","B","MAGGSU1",15)

"BLD",2853,"KRN",9.8,"NM","B","MAGGTAU",17)

"BLD",2853,"KRN",9.8,"NM","B","MAGGTSY1",30)

"BLD",2853,"KRN",9.8,"NM","B","MAGGTU3",18)

"BLD",2853,"KRN",9.8,"NM","B","MAGGTUP",26)

"BLD",2853,"KRN",9.8,"NM","B","MAGQBIM",20)

"BLD",2853,"KRN",9.8,"NM","B","MAGQBPG1",27)

"BLD",2853,"KRN",9.8,"NM","B","MAGQBPRG",28)

"BLD",2853,"KRN",9.8,"NM","B","MAGQBTM",21)

"BLD",2853,"KRN",9.8,"NM","B","MAGQBUT",22)

"BLD",2853,"KRN",9.8,"NM","B","MAGQBUT1",23)

"BLD",2853,"KRN",9.8,"NM","B","MAGQBUT2",24)

"BLD",2853,"KRN",9.8,"NM","B","MAGQBUT4",25)

"BLD",2853,"KRN",9.8,"NM","B","MAGQST",29)

"BLD",2853,"KRN",19,0)
19
"BLD",2853,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",2853,"KRN",19,"NM",1,0)
MAG WINDOWS^^0
"BLD",2853,"KRN",19,"NM","B","MAG WINDOWS",1)

"BLD",2853,"KRN",19.1,0)
19.1
"BLD",2853,"KRN",19.1,"NM",0)
^9.68A^1^1
"BLD",2853,"KRN",19.1,"NM",1,0)
MAGCAP CP^^0
"BLD",2853,"KRN",19.1,"NM","B","MAGCAP CP",1)

"BLD",2853,"KRN",101,0)
101
"BLD",2853,"KRN",409.61,0)
409.61
"BLD",2853,"KRN",771,0)
771
"BLD",2853,"KRN",870,0)
870
"BLD",2853,"KRN",8989.51,0)
8989.51
"BLD",2853,"KRN",8989.52,0)
8989.52
"BLD",2853,"KRN",8994,0)
8994
"BLD",2853,"KRN",8994,"NM",0)
^9.68A^10^10
"BLD",2853,"KRN",8994,"NM",1,0)
MAG4 ADD IMAGE^^0
"BLD",2853,"KRN",8994,"NM",2,0)
MAG4 CP CONSULT TO TIUDA^^0
"BLD",2853,"KRN",8994,"NM",3,0)
MAG4 CP GET REQUESTS^^0
"BLD",2853,"KRN",8994,"NM",4,0)
MAG4 CP GET VISITS^^0
"BLD",2853,"KRN",8994,"NM",5,0)
MAG4 CP UPDATE CONSULT^^0
"BLD",2853,"KRN",8994,"NM",6,0)
MAG4 DATA FROM IMPORT QUEUE^^0
"BLD",2853,"KRN",8994,"NM",7,0)
MAG4 GET SUPPORTED EXTENSIONS^^0
"BLD",2853,"KRN",8994,"NM",8,0)
MAG4 REMOTE IMPORT^^0
"BLD",2853,"KRN",8994,"NM",9,0)
MAG4 STATUS CALLBACK^^0
"BLD",2853,"KRN",8994,"NM",10,0)
MAG4 VALIDATE DATA^^0
"BLD",2853,"KRN",8994,"NM","B","MAG4 ADD IMAGE",1)

"BLD",2853,"KRN",8994,"NM","B","MAG4 CP CONSULT TO TIUDA",2)

"BLD",2853,"KRN",8994,"NM","B","MAG4 CP GET REQUESTS",3)

"BLD",2853,"KRN",8994,"NM","B","MAG4 CP GET VISITS",4)

"BLD",2853,"KRN",8994,"NM","B","MAG4 CP UPDATE CONSULT",5)

"BLD",2853,"KRN",8994,"NM","B","MAG4 DATA FROM IMPORT QUEUE",6)

"BLD",2853,"KRN",8994,"NM","B","MAG4 GET SUPPORTED EXTENSIONS",7)

"BLD",2853,"KRN",8994,"NM","B","MAG4 REMOTE IMPORT",8)

"BLD",2853,"KRN",8994,"NM","B","MAG4 STATUS CALLBACK",9)

"BLD",2853,"KRN",8994,"NM","B","MAG4 VALIDATE DATA",10)

"BLD",2853,"KRN","B",.4,.4)

"BLD",2853,"KRN","B",.401,.401)

"BLD",2853,"KRN","B",.402,.402)

"BLD",2853,"KRN","B",.403,.403)

"BLD",2853,"KRN","B",.5,.5)

"BLD",2853,"KRN","B",.84,.84)

"BLD",2853,"KRN","B",3.6,3.6)

"BLD",2853,"KRN","B",3.8,3.8)

"BLD",2853,"KRN","B",9.2,9.2)

"BLD",2853,"KRN","B",9.8,9.8)

"BLD",2853,"KRN","B",19,19)

"BLD",2853,"KRN","B",19.1,19.1)

"BLD",2853,"KRN","B",101,101)

"BLD",2853,"KRN","B",409.61,409.61)

"BLD",2853,"KRN","B",771,771)

"BLD",2853,"KRN","B",870,870)

"BLD",2853,"KRN","B",8989.51,8989.51)

"BLD",2853,"KRN","B",8989.52,8989.52)

"BLD",2853,"KRN","B",8994,8994)

"BLD",2853,"QUES",0)
^9.62^^
"BLD",2853,"REQB",0)
^9.611^1^1
"BLD",2853,"REQB",1,0)
MAG*3.0*1^2
"BLD",2853,"REQB","B","MAG*3.0*1",1)

"DATA",2005.02,1,0)
STILL IMAGE^1
"DATA",2005.02,1,1,0)
^2005.21^3^3
"DATA",2005.02,1,1,1,0)
DISPABST.MAGWABS
"DATA",2005.02,1,1,2,0)
DISPLAY.MAGSTI
"DATA",2005.02,1,1,3,0)
DISPABST.MAGWABS
"DATA",2005.02,1,4)
JPG
"DATA",2005.02,3,0)
XRAY^1
"DATA",2005.02,3,1,0)
^2005.21^5^2
"DATA",2005.02,3,1,4,0)
DISPLAY.MAGRXRY
"DATA",2005.02,3,1,5,0)
DISPABST.MAGWABS
"DATA",2005.02,9,0)
BWMED^1
"DATA",2005.02,9,1,0)
^2005.21^6^2
"DATA",2005.02,9,1,4,0)
DISPABST.MAGWABS
"DATA",2005.02,9,1,6,0)
DISPLAY.MAGOBW
"DATA",2005.02,10,0)
PACS RESIDENT^0
"DATA",2005.02,10,1,0)
^2005.21^3^2
"DATA",2005.02,10,1,1,0)
DISPLAY.MAGKDIS
"DATA",2005.02,10,1,3,0)
DISPABST.MAGKABS
"DATA",2005.02,11,0)
XRAY GROUP^0
"DATA",2005.02,11,1,0)
^2005.21^3^3
"DATA",2005.02,11,1,1,0)
DISPABST.MAGKDGP1
"DATA",2005.02,11,1,2,0)
DISPLAY.MAGKDGP
"DATA",2005.02,11,1,3,0)
DISPCINE.MAGCIN
"DATA",2005.02,12,0)
PACS GROUP^0
"DATA",2005.02,12,1,0)
^2005.21^3^2
"DATA",2005.02,12,1,1,0)
DISPLAY.MAGKDISP
"DATA",2005.02,12,1,3,0)
DISPABST.MAGKABS
"DATA",2005.02,13,0)
ECG^0
"DATA",2005.02,13,1,0)
^2005.21^5^2
"DATA",2005.02,13,1,4,0)
DISPABST.MAGOECGA
"DATA",2005.02,13,1,5,0)
DISPLAY.MAGOECGF
"DATA",2005.02,14,0)
CINE LOOP^1
"DATA",2005.02,14,1,0)
^2005.21^2^2
"DATA",2005.02,14,1,1,0)
DISPLAY.MAGCIN
"DATA",2005.02,14,1,2,0)
DISPABST.MAGKDGP1
"DATA",2005.02,15,0)
DOCUMENT^0
"DATA",2005.02,15,4)
TIF
"DATA",2005.02,16,0)
STILL IMAGE GROUP^0
"DATA",2005.02,16,1,0)
^2005.21^1^1
"DATA",2005.02,16,1,1,0)
DISPABST.MAGKDGP1
"DATA",2005.02,17,0)
COLORSCAN^0
"DATA",2005.02,17,1,0)
^2005.21^2^2
"DATA",2005.02,17,1,1,0)
DISPABST.MAGRDOS1
"DATA",2005.02,17,1,2,0)
DISPLAY.MAGRDOS1
"DATA",2005.02,18,0)
PATIENT PHOTO^0
"DATA",2005.02,19,0)
XRAY JPG
"DATA",2005.02,20,0)
JPG XRAY^0
"DATA",2005.02,21,0)
MOTION VIDEO
"DATA",2005.02,21,4)
AVI
"DATA",2005.02,65,0)
UNKNOWN
"DATA",2005.02,66,0)
DELETED IMAGE^0
"DATA",2005.02,67,0)
INVALID IMAGE NUMBER^0
"DATA",2005.02,100,0)
DICOM IMAGE
"DATA",2005.02,101,0)
HTML
"DATA",2005.02,101,4)
HTM
"DATA",2005.02,102,0)
WORD
"DATA",2005.02,102,4)
DOC
"DATA",2005.02,103,0)
TEXT
"DATA",2005.02,103,4)
ASC
"DATA",2005.02,104,0)
ADOBE
"DATA",2005.02,104,4)
PDF
"DATA",2005.02,105,0)
RICH TEXT
"DATA",2005.02,105,4)
RTF
"DATA",2005.02,106,0)
AUDIO
"DATA",2005.02,106,4)
WAV
"DATA",2005.021,1,0)
TGA^Targa Image TGA^1^^1^1
"DATA",2005.021,2,0)
TIF^Scanned Document TIF^1^^1^15
"DATA",2005.021,3,0)
PAC^Xray image PAC^1^^1^3
"DATA",2005.021,4,0)
BIG^Xray big file 2000K BIG^1^^1^3
"DATA",2005.021,5,0)
ABS^Abstract file ABS^1^^1^1
"DATA",2005.021,6,0)
BW^Black and White BW^1^^1^9
"DATA",2005.021,7,0)
756^Historical 756^1^^1^3
"DATA",2005.021,8,0)
BMP^Bitmap file BMP^1^^1^1
"DATA",2005.021,9,0)
MPG^Motion Video MPG^0^magavi.bmp^0^21
"DATA",2005.021,10,0)
ASC^Text file Image extension ASC^1^magtext.bmp^0^103
"DATA",2005.021,11,0)
AVI^Motion Video AVI^1^magavi.bmp^0^21
"DATA",2005.021,12,0)
DOC^Word Document DOC^0^magdoc.bmp^0^102
"DATA",2005.021,13,0)
HTM^Web Document HTM^1^maghtml.bmp^0^101
"DATA",2005.021,14,0)
JPG^Full Color JPG^1^^1^1
"DATA",2005.021,15,0)
PDF^Adobe PDF^0^magpdf.bmp^0^104
"DATA",2005.021,16,0)
RTF^Rich Text format RTF^0^magrtf.bmp^0^105
"DATA",2005.021,17,0)
WAV^Audio file WAV^0^magwav.bmp^0^106
"DATA",2005.021,18,0)
DCM^Dicom file DCM^1^^1^100
"DATA",2005.021,19,0)
TXT^Text file import TXT^1^magtext.bmp^0^103
"FIA",2005)
IMAGE
"FIA",2005,0)
^MAG(2005,
"FIA",2005,0,0)
2005I
"FIA",2005,0,1)
y^y^p^^^^n
"FIA",2005,0,10)

"FIA",2005,0,11)

"FIA",2005,0,"RLRO")

"FIA",2005,0,"VR")
3.0^MAG
"FIA",2005,2005)
1
"FIA",2005,2005,.05)

"FIA",2005,2005,107)

"FIA",2005,2005,108)

"FIA",2005,2005,109)

"FIA",2005,2005,110)

"FIA",2005.02)
OBJECT TYPE
"FIA",2005.02,0)
^MAG(2005.02,
"FIA",2005.02,0,0)
2005.02
"FIA",2005.02,0,1)
y^y^f^^n^^y^o^n
"FIA",2005.02,0,10)

"FIA",2005.02,0,11)

"FIA",2005.02,0,"RLRO")

"FIA",2005.02,0,"VR")
3.0^MAG
"FIA",2005.02,2005.02)
0
"FIA",2005.02,2005.21)
0
"FIA",2005.02,2005.24)
0
"FIA",2005.021)
IMAGE FILE TYPES
"FIA",2005.021,0)
^MAG(2005.021,
"FIA",2005.021,0,0)
2005.021
"FIA",2005.021,0,1)
y^y^f^^n^^y^o^n
"FIA",2005.021,0,10)

"FIA",2005.021,0,11)

"FIA",2005.021,0,"RLRO")

"FIA",2005.021,0,"VR")
3.0^MAG
"FIA",2005.021,2005.021)
0
"FIA",2006.034)
IMPORT QUEUE
"FIA",2006.034,0)
^MAG(2006.034,
"FIA",2006.034,0,0)
2006.034P
"FIA",2006.034,0,1)
y^y^f^^^^n
"FIA",2006.034,0,10)

"FIA",2006.034,0,11)

"FIA",2006.034,0,"RLRO")

"FIA",2006.034,0,"VR")
3.0^MAG
"FIA",2006.034,2006.034)
0
"FIA",2006.034,2006.341)
0
"FIA",2006.04)
ACQUISITION DEVICE
"FIA",2006.04,0)
^MAG(2006.04,
"FIA",2006.04,0,0)
2006.04
"FIA",2006.04,0,1)
y^y^f^^^^n
"FIA",2006.04,0,10)

"FIA",2006.04,0,11)

"FIA",2006.04,0,"RLRO")

"FIA",2006.04,0,"VR")
3.0^MAG
"FIA",2006.04,2006.04)
0
"FIA",2006.041)
ACQUISITION SESSION FILE
"FIA",2006.041,0)
^MAG(2006.041,
"FIA",2006.041,0,0)
2006.041
"FIA",2006.041,0,1)
y^y^f^^^^n
"FIA",2006.041,0,10)

"FIA",2006.041,0,11)

"FIA",2006.041,0,"RLRO")

"FIA",2006.041,0,"VR")
3.0^MAG
"FIA",2006.041,2006.041)
0
"FIA",2006.18)
IMAGING USER PREFERENCE
"FIA",2006.18,0)
^MAG(2006.18,
"FIA",2006.18,0,0)
2006.18
"FIA",2006.18,0,1)
y^y^p^^^^n
"FIA",2006.18,0,10)

"FIA",2006.18,0,11)

"FIA",2006.18,0,"RLRO")

"FIA",2006.18,0,"VR")
3.0^MAG
"FIA",2006.18,2006.18)
1
"FIA",2006.18,2006.18,8.5)

"FIA",2006.81)
IMAGING WINDOWS WORKSTATIONS
"FIA",2006.81,0)
^MAG(2006.81,
"FIA",2006.81,0,0)
2006.81
"FIA",2006.81,0,1)
y^y^p^^^^n
"FIA",2006.81,0,10)

"FIA",2006.81,0,11)

"FIA",2006.81,0,"RLRO")

"FIA",2006.81,0,"VR")
3.0^MAG
"FIA",2006.81,2006.81)
1
"FIA",2006.81,2006.81,12.5)

"FIA",2006.81,2006.81,13)

"FIA",2006.82)
IMAGING WINDOWS SESSIONS
"FIA",2006.82,0)
^MAG(2006.82,
"FIA",2006.82,0,0)
2006.82IO
"FIA",2006.82,0,1)
y^y^p^^^^n
"FIA",2006.82,0,10)

"FIA",2006.82,0,11)

"FIA",2006.82,0,"RLRO")

"FIA",2006.82,0,"VR")
3.0^MAG
"FIA",2006.82,2006.82)
1
"FIA",2006.82,2006.82,8)

"INIT")
POST^MAGIPOS7
"IX",2005,2005,"D",0)
2005^D^INSTUTION(AKA ACQUISITION SITE)^R^^F^IR^I^2005^^^^^LS
"IX",2005,2005,"D",1)
S ^MAG(2005,"D",X,DA)=""
"IX",2005,2005,"D",2)
K ^MAG(2005,"D",X,DA)
"IX",2005,2005,"D",2.5)
K ^MAG(2005,"D")
"IX",2005,2005,"D",11.1,0)
^.114IA^1^1
"IX",2005,2005,"D",11.1,1,0)
1^F^2005^.05^^1^F
"IX",2005,2005,"D",11.1,1,3)

"KRN",19,20686,-1)
0^1
"KRN",19,20686,0)
MAG WINDOWS^All MAG* RPC's ^^B^^^^^^^^
"KRN",19,20686,99.1)
58420,21644
"KRN",19,20686,"MAGJ CACHELOCATION",0)
^19.05P^12^12
"KRN",19,20686,"MAGJ CACHELOCATION",1,0)
567
"KRN",19,20686,"MAGJ CACHELOCATION",2,0)
MAGJ CACHELOCATION
"KRN",19,20686,"MAGJ CACHELOCATION",3,0)
MAGJ CACHELOCATION
"KRN",19,20686,"MAGJ CACHELOCATION",4,0)
MAGJ CACHELOCATION
"KRN",19,20686,"MAGJ CACHELOCATION",5,0)
567^S X=NULL
"KRN",19,20686,"MAGJ CACHELOCATION",5,1)
S X=NULL
"KRN",19,20686,"MAGJ CACHELOCATION",6,0)
567^S X=@
"KRN",19,20686,"MAGJ CACHELOCATION",6,1)
S X=@
"KRN",19,20686,"MAGJ CACHELOCATION",7,0)
567^S X=@
"KRN",19,20686,"MAGJ CACHELOCATION",7,1)
S X=@
"KRN",19,20686,"MAGJ CACHELOCATION",8,0)
567
"KRN",19,20686,"MAGJ CACHELOCATION",9,0)
625
"KRN",19,20686,"MAGJ CACHELOCATION",10,0)
626
"KRN",19,20686,"MAGJ CACHELOCATION",11,0)
626
"KRN",19,20686,"MAGJ CACHELOCATION",12,0)
626
"KRN",19,20686,"MAGJ PTRADEXAMS",0)
^19.05P^11^11
"KRN",19,20686,"MAGJ PTRADEXAMS",1,0)
423
"KRN",19,20686,"MAGJ PTRADEXAMS",2,0)
MAGJ PTRADEXAMS
"KRN",19,20686,"MAGJ PTRADEXAMS",3,0)
MAGJ PTRADEXAMS
"KRN",19,20686,"MAGJ PTRADEXAMS",4,0)
MAGJ PTRADEXAMS
"KRN",19,20686,"MAGJ PTRADEXAMS",5,0)
423^S X=NULL
"KRN",19,20686,"MAGJ PTRADEXAMS",5,1)
S X=NULL
"KRN",19,20686,"MAGJ PTRADEXAMS",6,0)
423^S X=@
"KRN",19,20686,"MAGJ PTRADEXAMS",6,1)
S X=@
"KRN",19,20686,"MAGJ PTRADEXAMS",7,0)
423^S X=@
"KRN",19,20686,"MAGJ PTRADEXAMS",7,1)
S X=@
"KRN",19,20686,"MAGJ PTRADEXAMS",8,0)
423
"KRN",19,20686,"MAGJ PTRADEXAMS",9,0)
625
"KRN",19,20686,"MAGJ PTRADEXAMS",10,0)
626
"KRN",19,20686,"MAGJ PTRADEXAMS",11,0)
626
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",0)
^19.05P^11^11
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",1,0)
422
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",2,0)
MAGJ RADACTIVEEXAMS
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",3,0)
MAGJ RADACTIVEEXAMS
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",4,0)
MAGJ RADACTIVEEXAMS
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",5,0)
422^S X=NULL
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",5,1)
S X=NULL
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",6,0)
422^S X=@
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",6,1)
S X=@
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",7,0)
422^S X=@
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",7,1)
S X=@
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",8,0)
422
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",9,0)
625
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",10,0)
626
"KRN",19,20686,"MAGJ RADACTIVEEXAMS",11,0)
626
"KRN",19,20686,"MAGJ RADCASEIMAGES",0)
^19.05P^11^11
"KRN",19,20686,"MAGJ RADCASEIMAGES",1,0)
427
"KRN",19,20686,"MAGJ RADCASEIMAGES",2,0)
MAGJ RADCASEIMAGES
"KRN",19,20686,"MAGJ RADCASEIMAGES",3,0)
MAGJ RADCASEIMAGES
"KRN",19,20686,"MAGJ RADCASEIMAGES",4,0)
MAGJ RADCASEIMAGES
"KRN",19,20686,"MAGJ RADCASEIMAGES",5,0)
427^S X=NULL
"KRN",19,20686,"MAGJ RADCASEIMAGES",5,1)
S X=NULL
"KRN",19,20686,"MAGJ RADCASEIMAGES",6,0)
427^S X=@
"KRN",19,20686,"MAGJ RADCASEIMAGES",6,1)
S X=@
"KRN",19,20686,"MAGJ RADCASEIMAGES",7,0)
427^S X=@
"KRN",19,20686,"MAGJ RADCASEIMAGES",7,1)
S X=@
"KRN",19,20686,"MAGJ RADCASEIMAGES",8,0)
427
"KRN",19,20686,"MAGJ RADCASEIMAGES",9,0)
625
"KRN",19,20686,"MAGJ RADCASEIMAGES",10,0)
626
"KRN",19,20686,"MAGJ RADCASEIMAGES",11,0)
626
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",0)
^19.05P^11^11
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",1,0)
455
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",2,0)
MAGJ RADSTATUSUPDATE
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",3,0)
MAGJ RADSTATUSUPDATE
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",4,0)
MAGJ RADSTATUSUPDATE
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",5,0)
455^S X=NULL
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",5,1)
S X=NULL
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",6,0)
455^S X=@
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",6,1)
S X=@
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",7,0)
455^S X=@
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",7,1)
S X=@
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",8,0)
455
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",9,0)
625
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",10,0)
626
"KRN",19,20686,"MAGJ RADSTATUSUPDATE",11,0)
626
"KRN",19,20686,"RPC",0)
^19.05P^181^181
"KRN",19,20686,"RPC",1,0)
MAG ABSJB
"KRN",19,20686,"RPC",2,0)
MAG CONSULT MSG CREATE
"KRN",19,20686,"RPC",4,0)
MAGGADDIMAGE
"KRN",19,20686,"RPC",5,0)
MAGGDESCCAT
"KRN",19,20686,"RPC",6,0)
MAGGDGRPD
"KRN",19,20686,"RPC",7,0)
MAGGHS
"KRN",19,20686,"RPC",8,0)
MAGGHSLIST
"KRN",19,20686,"RPC",9,0)
MAGGIMAGELIST
"KRN",19,20686,"RPC",10,0)
MAGGLAB FILE
"KRN",19,20686,"RPC",11,0)
MAGGLAB MICRO
"KRN",19,20686,"RPC",12,0)
MAGGLAB SECT
"KRN",19,20686,"RPC",13,0)
MAGGLAB STAIN
"KRN",19,20686,"RPC",14,0)
MAGGLAB START
"KRN",19,20686,"RPC",15,0)
MAGGLISTPROC
"KRN",19,20686,"RPC",22,0)
MAGGPATPROC
"KRN",19,20686,"RPC",25,0)
MAGGPROCIMAGE
"KRN",19,20686,"RPC",26,0)
MAGGRADIMAGE
"KRN",19,20686,"RPC",27,0)
MAGGRADLIST
"KRN",19,20686,"RPC",28,0)
MAGGRADPTR
"KRN",19,20686,"RPC",29,0)
MAGGRADREPORT
"KRN",19,20686,"RPC",30,0)
MAGGRPT
"KRN",19,20686,"RPC",31,0)
MAGGUPREFGET
"KRN",19,20686,"RPC",32,0)
MAGGUPREFSAVE
"KRN",19,20686,"RPC",40,0)
MAGGSUR GET
"KRN",19,20686,"RPC",41,0)
MAGGSUR FILE
"KRN",19,20686,"RPC",42,0)
MAGG DTTM
"KRN",19,20686,"RPC",43,0)
MAGGACTION LOG
"KRN",19,20686,"RPC",44,0)
MAGGUSER2
"KRN",19,20686,"RPC",45,0)
MAGG VERIFY ESIG
"KRN",19,20686,"RPC",46,0)
MAGG WRKS UPDATES
"KRN",19,20686,"RPC",47,0)
MAGG LOGOFF
"KRN",19,20686,"RPC",48,0)
MAGGUSERKEYS
"KRN",19,20686,"RPC",50,0)
MAGQ ABP
"KRN",19,20686,"RPC",51,0)
MAGQ ALL SERVER
"KRN",19,20686,"RPC",52,0)
MAGQ FS UPDATE
"KRN",19,20686,"RPC",54,0)
MAGQ GET
"KRN",19,20686,"RPC",55,0)
MAGQ QUD
"KRN",19,20686,"RPC",56,0)
MAGQ REQ
"KRN",19,20686,"RPC",62,0)
MAGG MED NEW
"KRN",19,20686,"RPC",63,0)
MAGG DEV SHOW NODE
"KRN",19,20686,"RPC",67,0)
MAGG IMAGE DELETE
"KRN",19,20686,"RPC",68,0)
MAGG IMAGE INFO
"KRN",19,20686,"RPC",69,0)
MAGG SYS WRKS DISPLAY
"KRN",19,20686,"RPC",70,0)
MAGG MED DICOMID
"KRN",19,20686,"RPC",72,0)
MAGG SYS WRKS SESSIONS
"KRN",19,20686,"RPC",73,0)
MAGG SYS SESSION DISPLAY
"KRN",19,20686,"RPC",74,0)
MAG3 LOGACTION
"KRN",19,20686,"RPC",75,0)
MAGG QUE IMAGE
"KRN",19,20686,"RPC",76,0)
MAGG QUE IMAGE GROUP
"KRN",19,20686,"RPC",77,0)
MAGG QUE PATIENT
"KRN",19,20686,"RPC",78,0)
MAGG QUE LIST
"KRN",19,20686,"RPC",79,0)
MAGG OFFLINE IMAGE ACCESSED
"KRN",19,20686,"RPC",80,0)
MAGQ FS CHNGE
"KRN",19,20686,"RPC",81,0)
MAGQ FTYPE
"KRN",19,20686,"RPC",87,0)
MAGQBP ALL SHARES
"KRN",19,20686,"RPC",88,0)
MAGQBP FREF
"KRN",19,20686,"RPC",89,0)
MAGQBP PARM
"KRN",19,20686,"RPC",90,0)
MAGQBP UPDATE
"KRN",19,20686,"RPC",92,0)
MAGG SYS GLOBAL NODE
"KRN",19,20686,"RPC",93,0)
MAGG CPRS RAD EXAM
"KRN",19,20686,"RPC",94,0)
MAGG GROUP IMAGES
"KRN",19,20686,"RPC",96,0)
MAGG PAT IMAGES
"KRN",19,20686,"RPC",97,0)
MAGQ ELOGR
"KRN",19,20686,"RPC",98,0)
MAGQ JBQUE
"KRN",19,20686,"RPC",99,0)
MAGG PAT EACH IMAGE
"KRN",19,20686,"RPC",101,0)
MAGQ CUPDTE
"KRN",19,20686,"RPC",102,0)
MAGQB QSL
"KRN",19,20686,"RPC",103,0)
MAGQB QUEDEL
"KRN",19,20686,"RPC",104,0)
MAGQ JH RPT
"KRN",19,20686,"RPC",105,0)
MAGG GET TIMEOUT
"KRN",19,20686,"RPC",106,0)
MAGQB PURNUL
"KRN",19,20686,"RPC",108,0)
DDR FILER
"KRN",19,20686,"RPC",109,0)
DDR FINDER
"KRN",19,20686,"RPC",110,0)
DDR GET DD HELP
"KRN",19,20686,"RPC",111,0)
DDR GETS ENTRY DATA
"KRN",19,20686,"RPC",112,0)
DDR LISTER
"KRN",19,20686,"RPC",113,0)
DDR VALIDATOR
"KRN",19,20686,"RPC",114,0)
DDR FIND1
"KRN",19,20686,"RPC",115,0)
MAGQ JBS
"KRN",19,20686,"RPC",117,0)
MAGQ JBSCN
"KRN",19,20686,"RPC",118,0)
MAGQ SHARES
"KRN",19,20686,"RPC",130,0)
MAGQ VCUD
"KRN",19,20686,"RPC",131,0)
MAGQ JPUD
"KRN",19,20686,"RPC",132,0)
MAG3 CPRS TIU NOTE
"KRN",19,20686,"RPC",133,0)
MAG3 LOOKUP ANY
"KRN",19,20686,"RPC",134,0)
MAG3 TIU DATA FROM DA
"KRN",19,20686,"RPC",135,0)
MAG3 TIU IMAGE
"KRN",19,20686,"RPC",136,0)
TIU DOCUMENTS BY CONTEXT
"KRN",19,20686,"RPC",137,0)
TIU SUMMARIES
"KRN",19,20686,"RPC",138,0)
TIU GET RECORD TEXT
"KRN",19,20686,"RPC",139,0)
TIU GET PN TITLES
"KRN",19,20686,"RPC",140,0)
TIU CREATE RECORD
"KRN",19,20686,"RPC",141,0)
TIU SIGN RECORD
"KRN",19,20686,"RPC",142,0)
MAGQ DIK
"KRN",19,20686,"RPC",143,0)
MAGQ ISN
"KRN",19,20686,"RPC",144,0)
MAGG PAT FIND
"KRN",19,20686,"RPC",145,0)
MAGG PAT BS5 CHECK
"KRN",19,20686,"RPC",146,0)
DG SENSITIVE RECORD ACCESS
"KRN",19,20686,"RPC",147,0)
DG SENSITIVE RECORD BULLETIN
"KRN",19,20686,"RPC",148,0)
DG CHK PAT/DIV MEANS TEST
"KRN",19,20686,"RPC",149,0)
MAGG PAT INFO
"KRN",19,20686,"RPC",150,0)
MAG EKG ONLINE
"KRN",19,20686,"RPC",151,0)
MAG GET NETLOC
"KRN",19,20686,"RPC",152,0)
MAGG PAT PHOTOS
"KRN",19,20686,"RPC",153,0)
MAGG LOG ERROR TEXT
"KRN",19,20686,"RPC",154,0)
MAGQ SYSTEM
"KRN",19,20686,"RPC",155,0)
MAGG DEV FIELD VALUES
"KRN",19,20686,"RPC",167,0)
MAG4 POST PROCESSING
"KRN",19,20686,"RPC",168,0)
MAG4 VERSION CHECK
"KRN",19,20686,"RPC",169,0)
MAGQ DFNIQ
"KRN",19,20686,"RPC",170,0)
MAG4 VALIDATE DATA
"KRN",19,20686,"RPC",171,0)
MAG4 REMOTE IMPORT
"KRN",19,20686,"RPC",172,0)
MAG4 DATA FROM IMPORT QUEUE
"KRN",19,20686,"RPC",173,0)
MAG4 ADD IMAGE
"KRN",19,20686,"RPC",174,0)
MAG4 STATUS CALLBACK
"KRN",19,20686,"RPC",175,0)
MAG4 CP CONSULT TO TIUDA
"KRN",19,20686,"RPC",176,0)
MAG4 CP GET REQUESTS
"KRN",19,20686,"RPC",177,0)
MAG4 CP GET VISITS
"KRN",19,20686,"RPC",178,0)
MAG4 GET SUPPORTED EXTENSIONS
"KRN",19,20686,"RPC",179,0)
MAG4 CP UPDATE CONSULT
"KRN",19,20686,"RPC",180,0)
TIU IDENTIFY CLINPROC CLASS
"KRN",19,20686,"RPC",181,0)
TIU IDENTIFY CONSULTS CLASS
"KRN",19,20686,"U")
ALL MAG* RPC'S 
"KRN",19.1,771,-1)
0^1
"KRN",19.1,771,0)
MAGCAP CP
"KRN",8994,1275,-1)
0^10
"KRN",8994,1275,0)
MAG4 VALIDATE DATA^VAL^MAGGSIV^2^R^^^^1
"KRN",8994,1275,1,0)
^8994.01^1^1^3010113^
"KRN",8994,1275,1,1,0)
Validates the Image Data Array
"KRN",8994,1275,2,0)
^8994.02A^2^2
"KRN",8994,1275,2,1,0)
MAGARRAY^2^^1^1
"KRN",8994,1275,2,1,1,0)
^^2^2^3010113^
"KRN",8994,1275,2,1,1,1,0)
Each item in the Array is an '^' delimited piece of information.
"KRN",8994,1275,2,1,1,2,0)
in the format Field^Value  OR  ActionCode^value
"KRN",8994,1275,2,2,0)
ALL^1^1^0^2
"KRN",8994,1275,2,2,1,0)
^^2^2^3010113^
"KRN",8994,1275,2,2,1,1,0)
All = 1 and All items in MAGARRAY will be validated.
"KRN",8994,1275,2,2,1,2,0)
All = 0 and Validation stops after first item in MAGARRAY fails.
"KRN",8994,1275,2,"B","ALL",2)

"KRN",8994,1275,2,"B","MAGARRAY",1)

"KRN",8994,1275,2,"PARAMSEQ",1,1)

"KRN",8994,1275,2,"PARAMSEQ",2,2)

"KRN",8994,1276,-1)
0^8
"KRN",8994,1276,0)
MAG4 REMOTE IMPORT^REMOTE^MAGGSIUI^2^R
"KRN",8994,1276,1,0)
^8994.01^1^1^3010816^^^^
"KRN",8994,1276,1,1,0)
Called from MS Windows Application.
"KRN",8994,1276,2,0)
^8994.02A^1^1
"KRN",8994,1276,2,1,0)
MAGDATA^2^^1^1
"KRN",8994,1276,2,1,1,0)
^8994.021^5^5^3010816^^
"KRN",8994,1276,2,1,1,1,0)
This is the array of data needed to Import the Image(s)
"KRN",8994,1276,2,1,1,2,0)
Format is sequential array of "Data Node^Data"
"KRN",8994,1276,2,1,1,3,0)
i.e.   MAGDATA(1)="PXPKG^8925"
"KRN",8994,1276,2,1,1,4,0)
       MAGDATA(2)="PXIEN^443"
"KRN",8994,1276,2,1,1,5,0)
       MAGDATA(3)="IMAGE^\\SERVER\SHARE\FILENAME.EXT^Description"
"KRN",8994,1276,2,"B","MAGDATA",1)

"KRN",8994,1276,2,"PARAMSEQ",1,1)

"KRN",8994,1276,3,0)
^8994.03^12^12^3010710^^
"KRN",8994,1276,3,1,0)
Return Parameter is an Array
"KRN",8994,1276,3,2,0)
Example  : Successful Queue
"KRN",8994,1276,3,3,0)
MAGRY(0)="111^Data has been Queued."
"KRN",8994,1276,3,4,0)
      Queue Number ^ message is returned in the (0) node.  
"KRN",8994,1276,3,5,0)
No other nodes are defined.
"KRN",8994,1276,3,6,0)
Example: unsuccessful Queue
"KRN",8994,1276,3,7,0)
MAGRY (0)="0^Required parameter is null"
"KRN",8994,1276,3,8,0)
MAGRY (1)="Tracking ID is Required. !"
"KRN",8994,1276,3,9,0)
MAGRY (2)="Status Handler is Required. !"
"KRN",8994,1276,3,10,0)
MAGRY (3)="Acquisition Site is Required. !"
"KRN",8994,1276,3,11,0)
       node (0) = 0 '^' Error message
"KRN",8994,1276,3,12,0)
       node(1..n)= all error messages incurred during validation
"KRN",8994,1277,-1)
0^6
"KRN",8994,1277,0)
MAG4 DATA FROM IMPORT QUEUE^GETARR^MAGGSIUI^2^R
"KRN",8994,1277,1,0)
^8994.01^2^2^3010123^
"KRN",8994,1277,1,1,0)
This call returns the Array of Data from the Import Queue, given a QUEUE Number
"KRN",8994,1277,1,2,0)
Called from Delphi and 'M'
"KRN",8994,1278,-1)
0^1
"KRN",8994,1278,0)
MAG4 ADD IMAGE^ADD^MAGGSIA^2^R
"KRN",8994,1278,1,0)
^8994.01^1^1^3010129^
"KRN",8994,1278,1,1,0)
Adds a new entry to the IMAGE File ^MAG(2005
"KRN",8994,1278,2,0)
^8994.02A^1^1
"KRN",8994,1278,2,1,0)
MAGARRAY^2^^1^1
"KRN",8994,1278,2,1,1,0)
^^4^4^3010129^
"KRN",8994,1278,2,1,1,1,0)
This is the image data list in the form
"KRN",8994,1278,2,1,1,2,0)
A(i)=field number^field value
"KRN",8994,1278,2,1,1,3,0)
   or
"KRN",8994,1278,2,1,1,4,0)
A(i)=action code^value
"KRN",8994,1278,2,"B","MAGARRAY",1)

"KRN",8994,1278,2,"PARAMSEQ",1,1)

"KRN",8994,1278,3,0)
^^2^2^3010129^
"KRN",8994,1278,3,1,0)
 Successful   MAGRY = IEN^FILE NAME (with full path)
"KRN",8994,1278,3,2,0)
 UNsuccessful MAGRY = 0^Error desc
"KRN",8994,1279,-1)
0^9
"KRN",8994,1279,0)
MAG4 STATUS CALLBACK^STATUSCB^MAGGSIUI^1^R^^^^.9
"KRN",8994,1279,1,0)
^8994.01^7^7^3010312^^
"KRN",8994,1279,1,1,0)
This RPC is called from the Imaging Delphi component when
"KRN",8994,1279,1,2,0)
an image/images have been imported via the Imaging Import API
"KRN",8994,1279,1,3,0)
being developed for use by Clinical Procedures.
"KRN",8994,1279,1,4,0)
This call is used in the test version of Import API, it will be 
"KRN",8994,1279,1,5,0)
replaced in the released version.  In the released version the 
"KRN",8994,1279,1,6,0)
Imaging BackGround Processor will be calling the Status Callback
"KRN",8994,1279,1,7,0)
routine of CP.
"KRN",8994,1279,2,0)
^8994.02A^1^1
"KRN",8994,1279,2,1,0)
STATARR^2^^1^1
"KRN",8994,1279,2,1,1,0)
^8994.021^9^9^3010312^^
"KRN",8994,1279,2,1,1,1,0)
This array has the following structure:
"KRN",8994,1279,2,1,1,2,0)
STATARR(0)="0^Error message"  or "1^Success"
"KRN",8994,1279,2,1,1,3,0)
STATARR(1)=TrackingID 
"KRN",8994,1279,2,1,1,4,0)
     TrackingID was sent as a parameter by CP in the IMPORT() call.
"KRN",8994,1279,2,1,1,5,0)
STATARR(2)=Queue Number
"KRN",8994,1279,2,1,1,6,0)
     The Queue Number was returned to CP from the IMPORT() call
"KRN",8994,1279,2,1,1,7,0)
STATARR(3..n) If status is '0^ERROR message" these remaining nodes
"KRN",8994,1279,2,1,1,8,0)
will contain further error information.  Intended for User Intervention
"KRN",8994,1279,2,1,1,9,0)
and debugging purposes.
"KRN",8994,1279,2,"B","STATARR",1)

"KRN",8994,1279,2,"PARAMSEQ",1,1)

"KRN",8994,1279,3,0)
^8994.03^4^4^3010312^^
"KRN",8994,1279,3,1,0)
Return is a string, it is of no value.  If this call generates an error,
"KRN",8994,1279,3,2,0)
it will be caught in the error trap.  The Queue Number can still be used
"KRN",8994,1279,3,3,0)
to check the status of the IMPORT, and will have the error information 
"KRN",8994,1279,3,4,0)
that was to be passed to the STATUS CALLBACK routine.
"KRN",8994,1280,-1)
0^2
"KRN",8994,1280,0)
MAG4 CP CONSULT TO TIUDA^TIUDA^MAGGSCP^2^R
"KRN",8994,1280,1,0)
^8994.01^5^5^3010816^
"KRN",8994,1280,1,1,0)
 Imaging Capture workstation calls this RPC to get a TIU IEN to
"KRN",8994,1280,1,2,0)
 attach images to.
"KRN",8994,1280,1,3,0)
 This call simply calls a CP API, which accepts
"KRN",8994,1280,1,4,0)
 DFN, Consult #, Visit String (optional), Complete|Do not Complete the |
"KRN",8994,1280,1,5,0)
 transaction.
"KRN",8994,1280,1,6,0)

"KRN",8994,1280,2,0)
^8994.02A^4^4
"KRN",8994,1280,2,1,0)
MAGDFN^1^30^1^1
"KRN",8994,1280,2,1,1,0)
^^1^1^3010816^
"KRN",8994,1280,2,1,1,1,0)
DFN of Patient
"KRN",8994,1280,2,2,0)
MAGCONS^1^30^1^2
"KRN",8994,1280,2,2,1,0)
^^2^2^3010816^
"KRN",8994,1280,2,2,1,1,0)
 This is the consult #.  The consult # is returned as a part of the
"KRN",8994,1280,2,2,1,2,0)
 Clinical Procedure Requests Query.
"KRN",8994,1280,2,3,0)
MAGVSTR^1^30^0^3
"KRN",8994,1280,2,3,1,0)
^^4^4^3010816^
"KRN",8994,1280,2,3,1,1,0)
 Visit String, needed to create a New Tiu Note.
"KRN",8994,1280,2,3,1,2,0)
 Visit String is returned as part of the Query to get Patient Visits.
"KRN",8994,1280,2,3,1,3,0)
 The Query to get a list of patient visits, is done directly before
"KRN",8994,1280,2,3,1,4,0)
 this call from the Capture Workstation.
"KRN",8994,1280,2,4,0)
MAGCMP^1^10^1^4
"KRN",8994,1280,2,4,1,0)
^^3^3^3010816^
"KRN",8994,1280,2,4,1,1,0)
 Flag:  tells to Complete (1) or Not Complete (0) the CP transaction.
"KRN",8994,1280,2,4,1,2,0)
  If Not Complete, then this transaction is available on the CP User station
"KRN",8994,1280,2,4,1,3,0)
 to attach images to.
"KRN",8994,1280,2,"B","MAGCMP",4)

"KRN",8994,1280,2,"B","MAGCONS",2)

"KRN",8994,1280,2,"B","MAGDFN",1)

"KRN",8994,1280,2,"B","MAGVSTR",3)

"KRN",8994,1280,2,"PARAMSEQ",1,1)

"KRN",8994,1280,2,"PARAMSEQ",2,2)

"KRN",8994,1280,2,"PARAMSEQ",3,3)

"KRN",8994,1280,2,"PARAMSEQ",4,4)

"KRN",8994,1280,3,0)
^^3^3^3010816^
"KRN",8994,1280,3,1,0)
 Returns the TIU IEN of the CP Note.
"KRN",8994,1280,3,2,0)
 or -1^error message.
"KRN",8994,1280,3,3,0)
 This RPC Call simply calls a CP API for imaging.
"KRN",8994,1281,-1)
0^3
"KRN",8994,1281,0)
MAG4 CP GET REQUESTS^LIST^MAGGSCP^2^R
"KRN",8994,1281,1,0)
^8994.01^1^1^3011010^^
"KRN",8994,1281,1,1,0)
Return a list of Clinical Procedure Requests for a Patient.
"KRN",8994,1281,2,0)
^8994.02A^2^2
"KRN",8994,1281,2,1,0)
MAGDFN^1^30^1^1
"KRN",8994,1281,2,1,1,0)
^^1^1^3010816^
"KRN",8994,1281,2,1,1,1,0)
DFN of Patient
"KRN",8994,1281,2,1,1,2,0)

"KRN",8994,1281,2,2,0)
PROC^1^10^0^2
"KRN",8994,1281,2,2,1,0)
^8994.021^2^2^3011010^^
"KRN",8994,1281,2,2,1,1,0)
 IEN from file 702.01 if just ome procedure desired, but
"KRN",8994,1281,2,2,1,2,0)
 it defaults to all.
"KRN",8994,1281,2,"B","MAGDFN",1)

"KRN",8994,1281,2,"B","PROC",2)

"KRN",8994,1281,2,"PARAMSEQ",1,1)

"KRN",8994,1281,2,"PARAMSEQ",2,2)

"KRN",8994,1281,3,0)
^8994.03^2^2^3011010^^
"KRN",8994,1281,3,1,0)
 Returns a list of Patient CP requests to be displayed in a
"KRN",8994,1281,3,2,0)
 List for User to select.
"KRN",8994,1282,-1)
0^4
"KRN",8994,1282,0)
MAG4 CP GET VISITS^VISITS^MAGGSCP^2^R
"KRN",8994,1282,1,0)
^^3^3^3010816^
"KRN",8994,1282,1,1,0)
 This RPC call simply call a CP Routine that lists visits for a patient.
"KRN",8994,1282,1,2,0)
 Imaging prompts the user with this list when a Visit String
"KRN",8994,1282,1,3,0)
 is needed by CP to create a Note.
"KRN",8994,1282,1,4,0)

"KRN",8994,1282,2,0)
^8994.02A^2^2
"KRN",8994,1282,2,1,0)
MAGDFN^1^30^1^1
"KRN",8994,1282,2,1,1,0)
^^1^1^3010816^
"KRN",8994,1282,2,1,1,1,0)
DFN of Patient
"KRN",8994,1282,2,2,0)
MAGCONS^1^30^0^2
"KRN",8994,1282,2,2,1,0)
^^1^1^3010816^
"KRN",8994,1282,2,2,1,1,0)
 Consult Number, returned in the Query to get patient CP Requests.
"KRN",8994,1282,2,"B","MAGCONS",2)

"KRN",8994,1282,2,"B","MAGDFN",1)

"KRN",8994,1282,2,"PARAMSEQ",1,1)

"KRN",8994,1282,2,"PARAMSEQ",2,2)

"KRN",8994,1282,3,0)
^^1^1^3010816^
"KRN",8994,1282,3,1,0)
Array of Visits for the patient.
"KRN",8994,1283,-1)
0^7
"KRN",8994,1283,0)
MAG4 GET SUPPORTED EXTENSIONS^LIST^MAGGSFT^2^R
"KRN",8994,1283,1,0)
^8994.01^1^1^3011010^^^
"KRN",8994,1283,1,1,0)
Returns a list of supported file extensions, used in Imaging.
"KRN",8994,1283,3,0)
^8994.03^1^1^3011010^^^
"KRN",8994,1283,3,1,0)
list of supported file extensions, used in Imaging.
"KRN",8994,1284,-1)
0^5
"KRN",8994,1284,0)
MAG4 CP UPDATE CONSULT^UPDCONS^MAGGSCP^1^R
"KRN",8994,1284,1,0)
^^3^3^3011010^
"KRN",8994,1284,1,1,0)
The Imaging capture station can mark a transaction as complete by making
"KRN",8994,1284,1,2,0)
  this call after a successful capture.  This call puts the procedure in
"KRN",8994,1284,1,3,0)
  a status of 'pr' (ready for interpretation.
"KRN",8994,1284,2,0)
^8994.02A^1^1
"KRN",8994,1284,2,1,0)
MAGCMP^1^10^1^3
"KRN",8994,1284,2,1,1,0)
^^2^2^3011010^
"KRN",8994,1284,2,1,1,1,0)
This is the Complete Flag that Clinical Procedures doesn't deal with.
"KRN",8994,1284,2,1,1,2,0)
  It is always '2' which indicates a 'Complete' transaction.
"KRN",8994,1284,2,1,1,3,0)
Request listing.  (CPLIST^GMRCCP)
"KRN",8994,1284,2,2,0)
MAGTIU^1^30^1^2
"KRN",8994,1284,2,2,1,0)
^^3^3^3010920^
"KRN",8994,1284,2,2,1,1,0)
The TIUDA of the Note associated with the Consult.  This TIUDA is produced by 
"KRN",8994,1284,2,2,1,2,0)
a call to ITIU^MDAPI
"KRN",8994,1284,2,2,1,3,0)

"KRN",8994,1284,2,3,0)
MAGCMP^1^10^1^3
"KRN",8994,1284,2,3,1,0)
^8994.021^2^2^3011010^^^
"KRN",8994,1284,2,3,1,1,0)
This is the Complete Flag that Clinical Procedures doesn't deal with.
"KRN",8994,1284,2,3,1,2,0)
It is always '2' which indicates a 'Complete' transaction.
"KRN",8994,1284,2,"B","MAGCMP",1)

"KRN",8994,1284,2,"B","MAGCMP",3)

"KRN",8994,1284,2,"B","MAGCONS",1)

"KRN",8994,1284,2,"B","MAGTIU",2)

"KRN",8994,1284,2,"PARAMSEQ",1,1)

"KRN",8994,1284,2,"PARAMSEQ",2,2)

"KRN",8994,1284,2,"PARAMSEQ",3,1)

"KRN",8994,1284,2,"PARAMSEQ",3,3)

"KRN",8994,1284,3,0)
^^1^1^3011010^
"KRN",8994,1284,3,1,0)
The result of the call to CPDOC^GMRCCP.  1 for success OR  0^error message
"MBREQ")
0
"ORD",3,19.1)
19.1;3;1;;KEY^XPDTA1;;;;;KEYDEL^XPDIA1
"ORD",3,19.1,0)
SECURITY KEY
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
7^3020712^133
"PKG",454,22,1,"PAH",1,1,0)
^^40^40^3020712
"PKG",454,22,1,"PAH",1,1,1,0)
This KIDS install will add the following support:
"PKG",454,22,1,"PAH",1,1,2,0)
Imaging import API with Clinical Procedures
"PKG",454,22,1,"PAH",1,1,3,0)
Background Processor Enhacements
"PKG",454,22,1,"PAH",1,1,4,0)
Support for MIL 6.1 drivers (Meteor II and Orion Capture)
"PKG",454,22,1,"PAH",1,1,5,0)
 
"PKG",454,22,1,"PAH",1,1,6,0)
Routine checksum:
"PKG",454,22,1,"PAH",1,1,7,0)
MAGBAPI   value = 7367416
"PKG",454,22,1,"PAH",1,1,8,0)
MAGGSCP   value = 6108869
"PKG",454,22,1,"PAH",1,1,9,0)
MAGGSERR  value = 3210527
"PKG",454,22,1,"PAH",1,1,10,0)
MAGGSFT   value = 3067100
"PKG",454,22,1,"PAH",1,1,11,0)
MAGGSIA   value = 5464426
"PKG",454,22,1,"PAH",1,1,12,0)
MAGGSIA1  value = 9791476
"PKG",454,22,1,"PAH",1,1,13,0)
MAGGSIM   value = 5360010
"PKG",454,22,1,"PAH",1,1,14,0)
MAGGSIU1  value = 3854213
"PKG",454,22,1,"PAH",1,1,15,0)
MAGGSIU2  value = 4516888
"PKG",454,22,1,"PAH",1,1,16,0)
MAGGSIU3  value = 7186347
"PKG",454,22,1,"PAH",1,1,17,0)
MAGGSIUI  value = 11682244
"PKG",454,22,1,"PAH",1,1,18,0)
MAGGSIV   value = 12079119
"PKG",454,22,1,"PAH",1,1,19,0)
MAGGSPP   value = 3242430
"PKG",454,22,1,"PAH",1,1,20,0)
MAGGSTI   value = 6260731
"PKG",454,22,1,"PAH",1,1,21,0)
MAGGSU1   value = 2676194
"PKG",454,22,1,"PAH",1,1,22,0)
MAGGTAU   value = 9601918
"PKG",454,22,1,"PAH",1,1,23,0)
MAGGTSY1  value = 6104608
"PKG",454,22,1,"PAH",1,1,24,0)
MAGGTU3   value = 7481270
"PKG",454,22,1,"PAH",1,1,25,0)
MAGGTUP   value = 7182048
"PKG",454,22,1,"PAH",1,1,26,0)
MAGIPOS7  value = 2508617
"PKG",454,22,1,"PAH",1,1,27,0)
MAGQBIM   value = 3963432
"PKG",454,22,1,"PAH",1,1,28,0)
MAGQBPG1  value = 11319930
"PKG",454,22,1,"PAH",1,1,29,0)
MAGQBPRG  value = 9369062
"PKG",454,22,1,"PAH",1,1,30,0)
MAGQBTM   value = 14438732
"PKG",454,22,1,"PAH",1,1,31,0)
MAGQBUT   value = 12416907
"PKG",454,22,1,"PAH",1,1,32,0)
MAGQBUT1  value = 13611765
"PKG",454,22,1,"PAH",1,1,33,0)
MAGQBUT2  value = 15727225
"PKG",454,22,1,"PAH",1,1,34,0)
MAGQBUT4  value = 2633801
"PKG",454,22,1,"PAH",1,1,35,0)
MAGQST    value = 714956
"PKG",454,22,1,"PAH",1,1,36,0)
 
"PKG",454,22,1,"PAH",1,1,37,0)
 
"PKG",454,22,1,"PAH",1,1,38,0)
 
"PKG",454,22,1,"PAH",1,1,39,0)
Please note that routine MAGIPOS7 is deleted after the KIDS application 
"PKG",454,22,1,"PAH",1,1,40,0)
is installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
29
"RTN","MAGBAPI")
0^1^B25788368
"RTN","MAGBAPI",1,0)
MAGBAPI ;WOIFO/PMK - Background Processor API to build queues [ 03/25/2001 11:20 ]
"RTN","MAGBAPI",2,0)
 ;;3.0;IMAGING;**1,7**;Jul 12, 2002
"RTN","MAGBAPI",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBAPI",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBAPI",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBAPI",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBAPI",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBAPI",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBAPI",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBAPI",10,0)
 ;; |                                                               |
"RTN","MAGBAPI",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBAPI",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBAPI",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBAPI",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBAPI",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBAPI",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBAPI",17,0)
 ;;
"RTN","MAGBAPI",18,0)
 ; The API returns the entry's queue pointer
"RTN","MAGBAPI",19,0)
 ;
"RTN","MAGBAPI",20,0)
ABSTRACT(INPUT) ; Entry point to create an image abstract
"RTN","MAGBAPI",21,0)
 ; input = image pointer
"RTN","MAGBAPI",22,0)
 Q $$QUEUE("ABSTRACT",INPUT)
"RTN","MAGBAPI",23,0)
 ;
"RTN","MAGBAPI",24,0)
GCC(INPUT) ; Entry point to create an Document Imaging Export Copy
"RTN","MAGBAPI",25,0)
 ; input = image pointer(^Second Piece Optional Location specified^3rd optional extension(s) specifier)
"RTN","MAGBAPI",26,0)
 Q $$QUEUE("GCC",$P(INPUT,U)_"^^"_$P(INPUT,U,4)_U_$P(INPUT,U,2,3))
"RTN","MAGBAPI",27,0)
 ;       
"RTN","MAGBAPI",28,0)
JUKEBOX(INPUT) ; Entry point to copy an image file and abstract to the Jukebox
"RTN","MAGBAPI",29,0)
 ; input = image pointer
"RTN","MAGBAPI",30,0)
 N NEXT
"RTN","MAGBAPI",31,0)
 S NEXT=$O(^MAGQUEUE(2006.03,"JX",$P(INPUT,"^"),$$NEXTQ("JUKEBOX")))
"RTN","MAGBAPI",32,0)
 Q:NEXT?1N.N NEXT
"RTN","MAGBAPI",33,0)
 S NEXT=$$QUEUE("JUKEBOX",INPUT)
"RTN","MAGBAPI",34,0)
 S ^MAGQUEUE(2006.03,"JX",$P(INPUT,"^"),NEXT)=""
"RTN","MAGBAPI",35,0)
 Q NEXT
"RTN","MAGBAPI",36,0)
 ;
"RTN","MAGBAPI",37,0)
DELETE(INPUT) ; Entry point to delete a file (literally from anywhere)
"RTN","MAGBAPI",38,0)
 ; input = full path of file to delete
"RTN","MAGBAPI",39,0)
 Q $$QUEUE("DELETE","^^"_+$P(INPUT,U,3)_U_$P(INPUT,U)) ;SETS 10TH PIECE
"RTN","MAGBAPI",40,0)
 ;
"RTN","MAGBAPI",41,0)
IMPORT(INPUT,CALLBACK,TRACKID) ; Entry point to import a file
"RTN","MAGBAPI",42,0)
 ; input = Image Parameter Array
"RTN","MAGBAPI",43,0)
 ; Callback = the process called with the results of the import activity
"RTN","MAGBAPI",44,0)
 N QUEIEN,INDX,FDA,DINUM,%,MS1,CT,REQUE
"RTN","MAGBAPI",45,0)
 S REQUE=$S($P($G(INPUT),U,3)'?1N.N:0,1:1)
"RTN","MAGBAPI",46,0)
 I REQUE=0 Q:($O(^MAG(2006.041,"C",TRACKID,""))?1N.N) "0^Duplicate Tracking ID"
"RTN","MAGBAPI",47,0)
 S QUEIEN=$$QUEUE("IMPORT","^^"_$P($G(INPUT),U,3)_U_$TR(CALLBACK,U,"|")_U_$P($G(INPUT),U,4))
"RTN","MAGBAPI",48,0)
 I REQUE=0 D
"RTN","MAGBAPI",49,0)
 . S $P(^MAGQUEUE(2006.03,QUEIEN,0),U,11)=QUEIEN
"RTN","MAGBAPI",50,0)
 . S (DINUM,X)=QUEIEN,DIC="^MAG(2006.034,",DLAYGO="2006.034",DIC(0)="L"
"RTN","MAGBAPI",51,0)
 . D FILE^DICN
"RTN","MAGBAPI",52,0)
 . K DIC
"RTN","MAGBAPI",53,0)
 . S CT=0
"RTN","MAGBAPI",54,0)
 . D CONV^MAGQBUT4(.INPUT,.CT)
"RTN","MAGBAPI",55,0)
 . W !,"QUEIEN ",QUEIEN
"RTN","MAGBAPI",56,0)
 . D MRGMULT^MAGQBUT4(.INPUT,"^MAG(2006.034,"_QUEIEN_",1,","2006.341A",CT)
"RTN","MAGBAPI",57,0)
 D NOW^%DTC
"RTN","MAGBAPI",58,0)
 K DIE,FDA
"RTN","MAGBAPI",59,0)
 S FDA(2006.041,"+1,",.01)=$S(REQUE=0:QUEIEN,1:$P($G(INPUT),U,4))
"RTN","MAGBAPI",60,0)
 S FDA(2006.041,"+1,",.02)=TRACKID
"RTN","MAGBAPI",61,0)
 S FDA(2006.041,"+1,",1)=$S(REQUE=0:"QUEUING",1:"REQUEUING")
"RTN","MAGBAPI",62,0)
 S FDA(2006.041,"+1,",2)=%
"RTN","MAGBAPI",63,0)
 D UPDATE^DIE("U","FDA","","MAGIMP")
"RTN","MAGBAPI",64,0)
 Q $S($D(DIERR):"0^"_MAGIMP("DIERR",1,"TEXT",1),1:QUEIEN)
"RTN","MAGBAPI",65,0)
 ;
"RTN","MAGBAPI",66,0)
JBTOHD(INPUT) ; Entry point to copy an image from the Jukebox to the Hard Disk
"RTN","MAGBAPI",67,0)
 ; input = image pointer ^ FULL or ABSTRACT or BIG
"RTN","MAGBAPI",68,0)
 N NEXT,IEN,JDTYPE
"RTN","MAGBAPI",69,0)
 S IEN=$P(INPUT,"^"),JDTYPE=$P(INPUT,"^",2)
"RTN","MAGBAPI",70,0)
 S NEXT=$O(^MAGQUEUE(2006.03,"JD",IEN,JDTYPE,$$NEXTQ("JBTOHD")))
"RTN","MAGBAPI",71,0)
 Q:NEXT?1N.N NEXT
"RTN","MAGBAPI",72,0)
 S NEXT=$$QUEUE("JBTOHD",INPUT)
"RTN","MAGBAPI",73,0)
 S ^MAGQUEUE(2006.03,"JD",$P(INPUT,"^"),$P(INPUT,"^",2),NEXT)=""
"RTN","MAGBAPI",74,0)
 Q NEXT
"RTN","MAGBAPI",75,0)
 ;
"RTN","MAGBAPI",76,0)
JBHDA(INPUT) ; Entry point to copy an image from the Jukebox to the Hard DisK
"RTN","MAGBAPI",77,0)
 ; input = image pointer ^ FULL or ABSTRACT or BIG
"RTN","MAGBAPI",78,0)
 N NEXT,IEN,JDTYPE,CNT,OK
"RTN","MAGBAPI",79,0)
 S CNT="",OK=0
"RTN","MAGBAPI",80,0)
 F  S CNT=$O(INPUT(CNT)) Q:CNT'?1N.N  D
"RTN","MAGBAPI",81,0)
 . S IEN=$P(INPUT(CNT),"^"),JDTYPE=$P(INPUT(CNT),"^",2)
"RTN","MAGBAPI",82,0)
 . S NEXT=$O(^MAGQUEUE(2006.03,"JD",IEN,JDTYPE,$$NEXTQ("JBTOHD")))
"RTN","MAGBAPI",83,0)
 . S $P(INPUT(CNT),"^",3)=$S(NEXT?1N.N:NEXT,1:$$QUEUE("JBTOHD",INPUT))
"RTN","MAGBAPI",84,0)
 . S OK=$S(OK'=0:OK,1:$P(INPUT(CNT),"^",3))
"RTN","MAGBAPI",85,0)
 Q OK
"RTN","MAGBAPI",86,0)
 ;
"RTN","MAGBAPI",87,0)
PREFET(INPUT) ;
"RTN","MAGBAPI",88,0)
 ; input = image pointer ^ FULL or ABSTRACT or BIG
"RTN","MAGBAPI",89,0)
 N NEXT,IEN,JDTYPE
"RTN","MAGBAPI",90,0)
 S IEN=$P(INPUT,"^"),JDTYPE=$P(INPUT,"^",2)
"RTN","MAGBAPI",91,0)
 S NEXT=$O(^MAGQUEUE(2006.03,"JD",IEN,JDTYPE,$$NEXTQ("PREFET")))
"RTN","MAGBAPI",92,0)
 Q:NEXT?1N.N NEXT
"RTN","MAGBAPI",93,0)
 S NEXT=$$QUEUE("PREFET",INPUT)
"RTN","MAGBAPI",94,0)
 S ^MAGQUEUE(2006.03,"JD",$P(INPUT,"^"),$P(INPUT,"^",2),NEXT)=""
"RTN","MAGBAPI",95,0)
 Q NEXT
"RTN","MAGBAPI",96,0)
 ;
"RTN","MAGBAPI",97,0)
EVAL(IMAGE) ; Entry point for before rules are evaluated
"RTN","MAGBAPI",98,0)
 Q $$QUEUE("EVAL",IMAGE)
"RTN","MAGBAPI",99,0)
 ;
"RTN","MAGBAPI",100,0)
FILECOPY(FILES,NETLOCN) ; Entry point to copy file(s) to a network location
"RTN","MAGBAPI",101,0)
 ; FILES = path to file(s) -- Note: wild card(s) may be used
"RTN","MAGBAPI",102,0)
 ; NETLOCN = name of network location (.01 file in ^MAG(2005.2))
"RTN","MAGBAPI",103,0)
 Q $$QUEUE("FILECOPY",FILES_"^"_NETLOCN)
"RTN","MAGBAPI",104,0)
 ;
"RTN","MAGBAPI",105,0)
NEXTQ(TYPE) ;
"RTN","MAGBAPI",106,0)
 N X
"RTN","MAGBAPI",107,0)
 S X=$O(^MAGQUEUE(2006.031,"B",TYPE,""))
"RTN","MAGBAPI",108,0)
 Q $S('X:X,1:$P(^MAGQUEUE(2006.031,X,0),"^",2))
"RTN","MAGBAPI",109,0)
 ;
"RTN","MAGBAPI",110,0)
QUEUE(Q,INPUT) ; Stuff the entry (header + INPUT) into the appropriate queue (Q)
"RTN","MAGBAPI",111,0)
 N %,%H,%I,QPTR,QTR,X,Y
"RTN","MAGBAPI",112,0)
 S U="^"
"RTN","MAGBAPI",113,0)
 ; increment the QPTR
"RTN","MAGBAPI",114,0)
 ;
"RTN","MAGBAPI",115,0)
 L +^MAGQUEUE(2006.03,0)
"RTN","MAGBAPI",116,0)
 S X=^MAGQUEUE(2006.03,0)
"RTN","MAGBAPI",117,0)
 S QPTR=$O(^MAGQUEUE(2006.03," "),-1)+1
"RTN","MAGBAPI",118,0)
 S $P(X,"^",3)=QPTR,$P(X,"^",4)=$P(X,"^",4)+1 ; #entries
"RTN","MAGBAPI",119,0)
 S ^MAGQUEUE(2006.03,0)=X
"RTN","MAGBAPI",120,0)
 ;
"RTN","MAGBAPI",121,0)
 ; add user, system id, date & time, and completion pieces to each entry
"RTN","MAGBAPI",122,0)
 D NOW^%DTC
"RTN","MAGBAPI",123,0)
 ; stuff the entry and "B" cross reference
"RTN","MAGBAPI",124,0)
 S ^MAGQUEUE(2006.03,QPTR,0)=Q_"^"_$G(DUZ)_"^"_^%ZOSF("VOL")_"^"_%_"^^^"_INPUT
"RTN","MAGBAPI",125,0)
 S ^MAGQUEUE(2006.03,"B",Q,QPTR)=""
"RTN","MAGBAPI",126,0)
 L -^MAGQUEUE(2006.03,0)
"RTN","MAGBAPI",127,0)
 D ADD(1,Q)
"RTN","MAGBAPI",128,0)
 Q QPTR ; return pointer to the entry in the queue
"RTN","MAGBAPI",129,0)
 ;
"RTN","MAGBAPI",130,0)
ADD(N,QUEUE) ; Ensure that the counter has a valid numeric value
"RTN","MAGBAPI",131,0)
 ; and increment it by N (N will be 0 if just validating...)
"RTN","MAGBAPI",132,0)
 ; QUEUE = Name of queue in 2006.03
"RTN","MAGBAPI",133,0)
 ;
"RTN","MAGBAPI",134,0)
 ; The counters in 2006.031 look like
"RTN","MAGBAPI",135,0)
 ;   ^MAGQUEUE(2006.031,D0,0) = Name ^ Next ^ Count
"RTN","MAGBAPI",136,0)
 ;     where Next is the IEN in 2006.03 of the next entry to be
"RTN","MAGBAPI",137,0)
 ;                processed by a 'background processor'
"RTN","MAGBAPI",138,0)
 ;       and Count is the number of entries for this queue
"RTN","MAGBAPI",139,0)
 ;
"RTN","MAGBAPI",140,0)
 N CNT,D0,I,X
"RTN","MAGBAPI",141,0)
 ;
"RTN","MAGBAPI",142,0)
 S D0=$O(^MAGQUEUE(2006.031,"B",QUEUE,""))
"RTN","MAGBAPI",143,0)
 D:'D0
"RTN","MAGBAPI",144,0)
 . L +^MAGQUEUE(2006.031)
"RTN","MAGBAPI",145,0)
 . S D0=$O(^MAGQUEUE(2006.031," "),-1)+1
"RTN","MAGBAPI",146,0)
 . S ^MAGQUEUE(2006.031,D0,0)=QUEUE_"^0"
"RTN","MAGBAPI",147,0)
 . S ^MAGQUEUE(2006.031,"B",QUEUE,D0)=""
"RTN","MAGBAPI",148,0)
 . S X="IMAGE BACKGROUND QUEUE POINTER^2006.031^"_D0_"^"_D0
"RTN","MAGBAPI",149,0)
 . S ^MAGQUEUE(2006.031,0)=X
"RTN","MAGBAPI",150,0)
 . L -^MAGQUEUE(2006.031)
"RTN","MAGBAPI",151,0)
 . Q
"RTN","MAGBAPI",152,0)
 L +^MAGQUEUE(2006.031,D0)
"RTN","MAGBAPI",153,0)
 S X=^MAGQUEUE(2006.031,D0,0),CNT=$P(X,"^",3)
"RTN","MAGBAPI",154,0)
 I CNT?1.N S CNT=CNT+N
"RTN","MAGBAPI",155,0)
 E  D
"RTN","MAGBAPI",156,0)
 . S I=$P(X,"^",2),CNT=0
"RTN","MAGBAPI",157,0)
 . F  S I=$O(^MAGQUEUE(2006.03,"B",QUEUE,I)) Q:I'?1N.N  S CNT=CNT+1
"RTN","MAGBAPI",158,0)
 . Q
"RTN","MAGBAPI",159,0)
 S $P(X,"^",3)=CNT,^MAGQUEUE(2006.031,D0,0)=X
"RTN","MAGBAPI",160,0)
 L -^MAGQUEUE(2006.031,D0)
"RTN","MAGBAPI",161,0)
 Q
"RTN","MAGGSCP")
0^2^B13719298
"RTN","MAGGSCP",1,0)
MAGGSCP ;WOIFO/GEK - Imaging RPC Broker call for CP. ; 01 Nov 2001 12:32 PM  
"RTN","MAGGSCP",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSCP",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSCP",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSCP",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSCP",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSCP",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSCP",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSCP",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSCP",10,0)
 ;; |                                                               |
"RTN","MAGGSCP",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSCP",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSCP",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSCP",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSCP",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSCP",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSCP",17,0)
 ;;
"RTN","MAGGSCP",18,0)
 ;;
"RTN","MAGGSCP",19,0)
 Q
"RTN","MAGGSCP",20,0)
LIST(MAGRY,MAGDFN,PROC) ; Get list of CP Requests
"RTN","MAGGSCP",21,0)
 ; PROC = IEN FROM FILE 702.01 IF JUST ONE PROCEURE DESIRED, DEFAULTS TO ALL
"RTN","MAGGSCP",22,0)
 ; 
"RTN","MAGGSCP",23,0)
 ; The compressed listing, 4 columns  
"RTN","MAGGSCP",24,0)
 ; Not restructuring the output yet
"RTN","MAGGSCP",25,0)
 ;    "Date^Spec^Desc^Img Count^procedure info"
"RTN","MAGGSCP",26,0)
 N MAGX,I,ACT,NODE,TMP
"RTN","MAGGSCP",27,0)
 K ^TMP($J,"MAGCP")
"RTN","MAGGSCP",28,0)
 K ^TMP($J,"MAGCP1")
"RTN","MAGGSCP",29,0)
 S PROC=$G(PROC)
"RTN","MAGGSCP",30,0)
 ;S MAGRY=$NA(^TMP($J,"MAGCP1"))
"RTN","MAGGSCP",31,0)
 D CPLIST^GMRCCP(MAGDFN,PROC,$NA(^TMP($J,"MAGCP")))
"RTN","MAGGSCP",32,0)
 I '$D(^TMP($J,"MAGCP")) S MAGRY(0)="0^There are no Clinical Procedure Requests for Patient : "_$$GET1^DIQ(2,MAGDFN,.01) Q
"RTN","MAGGSCP",33,0)
 S ACT=1
"RTN","MAGGSCP",34,0)
 S I="" F  S I=$O(^TMP($J,"MAGCP",I)) Q:I=""  S NODE=^(I) D
"RTN","MAGGSCP",35,0)
 . ; screening out x - cancelled and 'dc' - discontinued 
"RTN","MAGGSCP",36,0)
 . I ",x,dc,"[(","_$P(NODE,U,4)_",") Q 
"RTN","MAGGSCP",37,0)
 . S X=$$INF(NODE)
"RTN","MAGGSCP",38,0)
 . S ACT=ACT+1
"RTN","MAGGSCP",39,0)
 . S MAGRY(ACT)=X ;S @MAGRY@(ACT)=X
"RTN","MAGGSCP",40,0)
 S MAGRY(1)="Date~S1^CP DEF nam^urgency^status" ;^cons #^CP DEF ien
"RTN","MAGGSCP",41,0)
 S MAGRY(0)=ACT-1_"^"_ACT-1_" Clinical Procedure Requests."
"RTN","MAGGSCP",42,0)
 Q
"RTN","MAGGSCP",43,0)
INF(NODE) ;
"RTN","MAGGSCP",44,0)
 N RY
"RTN","MAGGSCP",45,0)
 ; FOR NOW JUST SEND THE SAME DATA (TESTING)
"RTN","MAGGSCP",46,0)
 S RY=$P(NODE,U,1,4)_"|"_$P(NODE,U,5,99)
"RTN","MAGGSCP",47,0)
 S $P(RY,U)=$$EXTDT^MAGGSU1($P(RY,U))
"RTN","MAGGSCP",48,0)
 Q RY
"RTN","MAGGSCP",49,0)
 ;S RY=$$EXTDT^MAGGSU1($P(NODE,U,3))_U_"TIU"_U_$P(NODE,U,2)_U
"RTN","MAGGSCP",50,0)
 ;S RY=RY_$$IMGCT($P(NODE,U))_U_$P($P(NODE,U,5),";",2)_U
"RTN","MAGGSCP",51,0)
 ;S RY=RY_"|TIU^"_$P(NODE,U)
"RTN","MAGGSCP",52,0)
 Q RY
"RTN","MAGGSCP",53,0)
TIUDA(MAGRY,MAGDFN,MAGCONS,MAGVSTR,MAGCMP) ;
"RTN","MAGGSCP",54,0)
 ;
"RTN","MAGGSCP",55,0)
 K MAGRY S MAGVSTR=$G(MAGVSTR),MAGCMP=$G(MAGCMP,0)
"RTN","MAGGSCP",56,0)
 ; No longer sending CP the Complete Flag 9/20/01 GEK
"RTN","MAGGSCP",57,0)
 ;D ITIU^MDAPI(.MAGRY,MAGDFN,MAGCONS,MAGVSTR,MAGCMP)
"RTN","MAGGSCP",58,0)
 ; CODE^DFN^MAGIEN^<computed time 'now'>^TEXT
"RTN","MAGGSCP",59,0)
 D ACTION^MAGGTAU("API^"_MAGDFN_"^^^ITIU-MDAPI Params: Cnslt#-"_MAGCONS_" vstr-"_MAGVSTR)
"RTN","MAGGSCP",60,0)
 D ITIU^MDAPI(.MAGRY,MAGDFN,MAGCONS,MAGVSTR)
"RTN","MAGGSCP",61,0)
 D ACTION^MAGGTAU("API^"_MAGDFN_"^^^ITIU-MDAPI Result: "_MAGRY(0))
"RTN","MAGGSCP",62,0)
 Q
"RTN","MAGGSCP",63,0)
VISITS(MAGRY,MAGDFN,MAGCONS) ;
"RTN","MAGGSCP",64,0)
 N I,MAGCT,MAGNODE,MAGI,MAGZ,MAGVISIT
"RTN","MAGGSCP",65,0)
 S DFN=MAGDFN
"RTN","MAGGSCP",66,0)
 S RESULTS="MAGVISIT"
"RTN","MAGGSCP",67,0)
 D GETVST^MDRPCOP
"RTN","MAGGSCP",68,0)
 I '$D(MAGVISIT(0)) S MAGRY(0)="0^ERROR: Listing visits." Q
"RTN","MAGGSCP",69,0)
 S I=0,MAGCT=1 F  S I=$O(MAGVISIT(I)) Q:'I  D
"RTN","MAGGSCP",70,0)
 . S MAGZ=MAGVISIT(I)
"RTN","MAGGSCP",71,0)
 . S $P(MAGNODE,"^")=$$EXTDT^MAGGSU1($P(MAGZ,"^",2)) ;Date
"RTN","MAGGSCP",72,0)
 . S $P(MAGNODE,"^",2,3)=$P(MAGZ,"^",3,4) ; Clinic, Status
"RTN","MAGGSCP",73,0)
 . S $P(MAGNODE,"|",2)=$P(MAGZ,"^",1) ; VSTRING;
"RTN","MAGGSCP",74,0)
 . S MAGCT=MAGCT+1,MAGRY(MAGCT)=MAGNODE
"RTN","MAGGSCP",75,0)
 I '$D(MAGRY) S MAGRY(0)="0^0 Visits for patient" Q
"RTN","MAGGSCP",76,0)
 S MAGRY(0)=$O(MAGRY(""),-1)-1_"^Visits for patient"
"RTN","MAGGSCP",77,0)
 S MAGRY(1)="Date~S1^Location^Status"
"RTN","MAGGSCP",78,0)
 Q
"RTN","MAGGSCP",79,0)
UPDCONS(MAGRY,MAGCONS,MAGTIU,MAGCMP) ;Update Consults;
"RTN","MAGGSCP",80,0)
 ; Update Consults with the Complete Flag. Consults will update
"RTN","MAGGSCP",81,0)
 ; it's status to 'pr' partial results.
"RTN","MAGGSCP",82,0)
 D ACTION^MAGGTAU("API^^^^CPDOC-GMRCCP Params: Cnslt#-"_MAGCONS_" tiuda-"_MAGTIU_" cmpfl-"_MAGCMP)
"RTN","MAGGSCP",83,0)
 S MAGRY=$$CPDOC^GMRCCP(MAGCONS,MAGTIU,MAGCMP) ; MAGCMP IS 2
"RTN","MAGGSCP",84,0)
 Q
"RTN","MAGGSERR")
0^3^B5857043
"RTN","MAGGSERR",1,0)
MAGGSERR ;WOIFO/GEK - IMAGING ERROR TRAP, AND ERROR LOG ; [ 12/27/2000 10:49 ]
"RTN","MAGGSERR",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSERR",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSERR",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSERR",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSERR",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSERR",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSERR",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSERR",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSERR",10,0)
 ;; |                                                               |
"RTN","MAGGSERR",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSERR",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSERR",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSERR",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSERR",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSERR",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSERR",17,0)
 ;;
"RTN","MAGGSERR",18,0)
 Q
"RTN","MAGGSERR",19,0)
 ;  Calling this error trap will enable logging Imaging errors and 
"RTN","MAGGSERR",20,0)
 ;  sending messages for certain errors etc. later
"RTN","MAGGSERR",21,0)
 ; set it using :
"RTN","MAGGSERR",22,0)
 ;    >N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGSERR"
"RTN","MAGGSERR",23,0)
 ;
"RTN","MAGGSERR",24,0)
 ; This assumes the Return variable or array is MAGRY or MAGRY()
"RTN","MAGGSERR",25,0)
 ;
"RTN","MAGGSERR",26,0)
ERRA ; ERROR TRAP FOR Array Return variables
"RTN","MAGGSERR",27,0)
 N ERR S ERR=$$EC^%ZOSV
"RTN","MAGGSERR",28,0)
 S MAGRY(0)="0^"_ERR
"RTN","MAGGSERR",29,0)
 D LOGERR(ERR)
"RTN","MAGGSERR",30,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGSERR",31,0)
 Q
"RTN","MAGGSERR",32,0)
 ;
"RTN","MAGGSERR",33,0)
AERRA ; ERROR TRAP FOR Global Return Variables
"RTN","MAGGSERR",34,0)
 N ERR S ERR=$$EC^%ZOSV
"RTN","MAGGSERR",35,0)
 S @MAGRY@(0)="0^ERROR "_ERR
"RTN","MAGGSERR",36,0)
 D LOGERR(ERR)
"RTN","MAGGSERR",37,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGSERR",38,0)
 Q
"RTN","MAGGSERR",39,0)
ERR ; ERROR TRAP FOR String Return variables
"RTN","MAGGSERR",40,0)
 N ERR S ERR=$$EC^%ZOSV
"RTN","MAGGSERR",41,0)
 S MAGRY="0^ERROR "_ERR
"RTN","MAGGSERR",42,0)
 D LOGERR(ERR)
"RTN","MAGGSERR",43,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGSERR",44,0)
 Q
"RTN","MAGGSERR",45,0)
LOGERR(ERROR,MAGSESS) ;
"RTN","MAGGSERR",46,0)
 N SESSIEN
"RTN","MAGGSERR",47,0)
 S SESSIEN=$S($G(MAGSESS):MAGSESS,$D(MAGJOB("SESSION")):MAGJOB("SESSION"),1:0)
"RTN","MAGGSERR",48,0)
 I 'SESSIEN Q
"RTN","MAGGSERR",49,0)
 N MAGGFDA,MAGXERR,MAGXIEN,MAGNODE
"RTN","MAGGSERR",50,0)
 S MAGNODE="+1,"_+SESSIEN_","
"RTN","MAGGSERR",51,0)
 ;S MAGNODE="+1,10,"
"RTN","MAGGSERR",52,0)
 S MAGGFDA(2006.823,MAGNODE,.01)=ERROR
"RTN","MAGGSERR",53,0)
 D UPDATE^DIE("","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGSERR",54,0)
 ; error flag for this session in workstation file
"RTN","MAGGSERR",55,0)
 I $G(MAGJOB("WRKSIEN")) D
"RTN","MAGGSERR",56,0)
 . S MAGNODE=+MAGJOB("WRKSIEN")_","
"RTN","MAGGSERR",57,0)
 . S MAGGFDA(2006.81,MAGNODE,11)=+MAGXIEN(1) ;
"RTN","MAGGSERR",58,0)
 . D UPDATE^DIE("","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGSERR",59,0)
 Q
"RTN","MAGGSFT")
0^4^B4383221
"RTN","MAGGSFT",1,0)
MAGGSFT ;WOIFO/GEK - Utilities   ; 01 Nov 2001 12:32 PM 
"RTN","MAGGSFT",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSFT",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSFT",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSFT",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSFT",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSFT",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSFT",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSFT",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSFT",10,0)
 ;; |                                                               |
"RTN","MAGGSFT",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSFT",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSFT",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSFT",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSFT",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSFT",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSFT",17,0)
 ;;
"RTN","MAGGSFT",18,0)
 Q
"RTN","MAGGSFT",19,0)
LIST(MAGRY) ;RPC to return a list of supported image file extensions
"RTN","MAGGSFT",20,0)
 N I,Y,MAGN0
"RTN","MAGGSFT",21,0)
 ;NAME [1F] ^ DESCRIPTION [2F] ^VIEWER [3S] ^ 
"RTN","MAGGSFT",22,0)
 ;       Bitmap for Abstract [4F] ^Abstract Created [5S] ^ Default Object Type [6P]
"RTN","MAGGSFT",23,0)
 ;
"RTN","MAGGSFT",24,0)
 ;  2nd "|" piece is system info = Ien of 2005.021 ^ NAME ^ Default Object Type [6P]
"RTN","MAGGSFT",25,0)
 S MAGRY(0)="0^Compiling list of supported extensions..."
"RTN","MAGGSFT",26,0)
 S MAGRY(1)="Ext^Description^Imaging Viewer^Abs Bitmap^Abs Created"
"RTN","MAGGSFT",27,0)
 S CT=1
"RTN","MAGGSFT",28,0)
 S I=0 F  S I=$O(^MAG(2005.021,I)) Q:'I  S MAGN0=^(I,0) D
"RTN","MAGGSFT",29,0)
 . S CT=CT+1
"RTN","MAGGSFT",30,0)
 . S MAGRY(CT)=$P(MAGN0,U,1,5)_"|"_I_U_$P(MAGN0,U)_U_$P(MAGN0,U,6)
"RTN","MAGGSFT",31,0)
 S MAGRY(0)="1^Okay"
"RTN","MAGGSFT",32,0)
 Q
"RTN","MAGGSFT",33,0)
EXTSUPP(MAGRY,MAGEXT) ;
"RTN","MAGGSIA")
0^5^B16063692
"RTN","MAGGSIA",1,0)
MAGGSIA ;WOIFO/GEK - Imaging RPC Broker calls. Add/Modify Image entry ; [ 12/27/2000 10:49 ]
"RTN","MAGGSIA",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSIA",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIA",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIA",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIA",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIA",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIA",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIA",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIA",10,0)
 ;; |                                                               |
"RTN","MAGGSIA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIA",17,0)
 ;;
"RTN","MAGGSIA",18,0)
 Q
"RTN","MAGGSIA",19,0)
 ;
"RTN","MAGGSIA",20,0)
 ;**** CALLING ROUTINE is responsible for RENAMING THE IMAGE FILE
"RTN","MAGGSIA",21,0)
 ;**** on DISK TO THE NEW FILE NAME RETURNED BY THIS CALL.
"RTN","MAGGSIA",22,0)
 ;
"RTN","MAGGSIA",23,0)
ADD(MAGRY,MAGARRAY) ; RPC Call to UPDATE^DIE to Add an Image File entry
"RTN","MAGGSIA",24,0)
 ;  Parameters : 
"RTN","MAGGSIA",25,0)
 ;    MAGARRAY -  array of field numbers and their entries
"RTN","MAGGSIA",26,0)
 ;             i.e. MAGARRAY(1)=".5^38"  field# .5   data is 38
"RTN","MAGGSIA",27,0)
 ;    If Long Description is included in array (field 11), we create a new
"RTN","MAGGSIA",28,0)
 ;      array to hold the text, and pass that to UPDATE^DIE
"RTN","MAGGSIA",29,0)
 ;    If this entry is an Image Group
"RTN","MAGGSIA",30,0)
 ;      i.e. MAGARRAY(n)="2005.04^344"
"RTN","MAGGSIA",31,0)
 ;      (the field 2005.04 is the OBJECT GROUP MULTIPLE)
"RTN","MAGGSIA",32,0)
 ;      ( 344 is the pointer to the Image File Entry that will be added
"RTN","MAGGSIA",33,0)
 ;      ( as a member of this new/existing Group)
"RTN","MAGGSIA",34,0)
 ;
"RTN","MAGGSIA",35,0)
 ;  Return Variable
"RTN","MAGGSIA",36,0)
 ;
"RTN","MAGGSIA",37,0)
 ;    MAGRY(0) - Array
"RTN","MAGGSIA",38,0)
 ;      Successful   MAGRY(0) = IEN^FILE NAME (with full path)
"RTN","MAGGSIA",39,0)
 ;      UNsuccessful MAGRY(0) = 0^Error desc
"RTN","MAGGSIA",40,0)
 ;                   MAGRY(0)(1..n) = Errors and warnings. 
"RTN","MAGGSIA",41,0)
 ;
"RTN","MAGGSIA",42,0)
 ;    CALLING ROUTINE is responsible for RENAMING THE IMAGE FILE on DISK
"RTN","MAGGSIA",43,0)
 ;      TO THE NEW FILE NAME RETURNED BY THIS CALL.
"RTN","MAGGSIA",44,0)
 ;      Changed to include hierarchial directory hash  - PMK 04/23/98
"RTN","MAGGSIA",45,0)
 ;----------------------------------------------------------------
"RTN","MAGGSIA",46,0)
 N MAGGFDA,MAGGDRV,MAGGRP,MAGCHLD,GRPCT,MAGGDA,MAGGFNM
"RTN","MAGGSIA",47,0)
 N MAGGWP,MAGERR
"RTN","MAGGSIA",48,0)
 N MAGREF,MAGDHASH,MAGTEMP
"RTN","MAGGSIA",49,0)
 N MAGACT
"RTN","MAGGSIA",50,0)
 N MAGGIEN,MAGGXE
"RTN","MAGGSIA",51,0)
 N I,J,X,Y,Z
"RTN","MAGGSIA",52,0)
 ;
"RTN","MAGGSIA",53,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGSERR"
"RTN","MAGGSIA",54,0)
 I ($D(MAGARRAY)<10) S MAGRY(0)="0^No input data, Operation CANCELED" Q
"RTN","MAGGSIA",55,0)
 ;
"RTN","MAGGSIA",56,0)
 K ^TMP("MAGGSIA",$J)
"RTN","MAGGSIA",57,0)
 M ^TMP("MAGGSIA",$J)=MAGARRAY
"RTN","MAGGSIA",58,0)
 ;
"RTN","MAGGSIA",59,0)
 S MAGRY(0)="0^Creating VistA Image Entry..."
"RTN","MAGGSIA",60,0)
 S MAGERR="",MAGGRP=0,GRPCT=1,WPCT=0
"RTN","MAGGSIA",61,0)
 ;
"RTN","MAGGSIA",62,0)
 ;  Validate the Data, and Action codes in the Input Array
"RTN","MAGGSIA",63,0)
 D VAL^MAGGSIV(.MAGRY,.MAGARRAY) I 'MAGRY(0) Q
"RTN","MAGGSIA",64,0)
 ;
"RTN","MAGGSIA",65,0)
 ;  Make the FileMan FDA array and the Imaging Action array.
"RTN","MAGGSIA",66,0)
 D MAKEFDA^MAGGSIU2(.MAGGFDA,.MAGARRAY,.MAGACT,.MAGCHLD,.MAGGRP,.MAGGWP)
"RTN","MAGGSIA",67,0)
 M ^TMP("MAGGSIA",$J,"FDA")=MAGGFDA
"RTN","MAGGSIA",68,0)
 I '$D(MAGGFDA(2005,"+1,")) S MAGRY(0)="0^No data to file.  Operation CANCELED." Q
"RTN","MAGGSIA",69,0)
 ;
"RTN","MAGGSIA",70,0)
 ;  Check on some possible problems: required fields, create default values etc.
"RTN","MAGGSIA",71,0)
 D PRE^MAGGSIA1(.MAGERR,.MAGGFDA,MAGGRP,.MAGGDRV,.MAGREF) I $L(MAGERR) S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",72,0)
 ;
"RTN","MAGGSIA",73,0)
 ;
"RTN","MAGGSIA",74,0)
 D UPDATE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGSIA",75,0)
 ;  ERROR: QUIT
"RTN","MAGGSIA",76,0)
 I '$G(MAGGIEN(1)) D  S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",77,0)
 . D CLEAN^DILF
"RTN","MAGGSIA",78,0)
 . S MAGERR="0^ERROR Creating new Image File Entry "
"RTN","MAGGSIA",79,0)
 . I $D(DIERR) D RTRNERR^MAGGSIU1(.MAGERR)
"RTN","MAGGSIA",80,0)
 ;
"RTN","MAGGSIA",81,0)
 S MAGGDA=MAGGIEN(1)
"RTN","MAGGSIA",82,0)
 ;
"RTN","MAGGSIA",83,0)
 D ACTION^MAGGTAU("CAP^"_MAGGFDA(2005,"+1,",5)_"^"_MAGGDA)
"RTN","MAGGSIA",84,0)
 ;
"RTN","MAGGSIA",85,0)
 ; IF a group, UpDate the GROUP PARENT in each Group Object and QUIT
"RTN","MAGGSIA",86,0)
 ;  The Return (MAGRY(0)) will be IEN with NO Filename. Groups don't get Filename
"RTN","MAGGSIA",87,0)
 I MAGGRP D UPDCHLD^MAGGSIM(.MAGCHLD,MAGGDA) S MAGRY(0)=MAGGDA_U Q
"RTN","MAGGSIA",88,0)
 ;
"RTN","MAGGSIA",89,0)
 ; ENTRY in Image File has been made, if any errors from here on
"RTN","MAGGSIA",90,0)
 ;  then we have to delete the image entry.
"RTN","MAGGSIA",91,0)
 ;
"RTN","MAGGSIA",92,0)
 ; Now generate the Image FileName. This is passed back to the calling app, 
"RTN","MAGGSIA",93,0)
 ;  and the calling app is responsible for renaming/copying the Image File to
"RTN","MAGGSIA",94,0)
 ;  this new name. 
"RTN","MAGGSIA",95,0)
 I $D(MAGGFDA(2005,"+1,",1)) S MAGGFNM=MAGGFDA(2005,"+1,",1)
"RTN","MAGGSIA",96,0)
 E  D  I $L(MAGERR) S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",97,0)
 . N MAGXFDA
"RTN","MAGGSIA",98,0)
 . S X=$$DA2NAME^MAGGSIU1(MAGGDA,$G(MAGACT("EXT"))) I 'X D  Q
"RTN","MAGGSIA",99,0)
 . . S MAGERR=X
"RTN","MAGGSIA",100,0)
 . . D KILLENT^MAGGSIU1(MAGGDA)
"RTN","MAGGSIA",101,0)
 . ;
"RTN","MAGGSIA",102,0)
 . S MAGGFNM=$P(X,U,2),Y=MAGGDA_","
"RTN","MAGGSIA",103,0)
 . S MAGXFDA(2005,Y,1)=MAGGFNM
"RTN","MAGGSIA",104,0)
 . D UPDATE^DIE("","MAGXFDA","","MAGGXE")
"RTN","MAGGSIA",105,0)
 . ;   in case of an error
"RTN","MAGGSIA",106,0)
 . I $D(DIERR) D  Q
"RTN","MAGGSIA",107,0)
 . . D RTRNERR^MAGGSIU1(.MAGERR,.MAGGXE)
"RTN","MAGGSIA",108,0)
 . . D KILLENT^MAGGSIU1(MAGGDA)
"RTN","MAGGSIA",109,0)
 ;
"RTN","MAGGSIA",110,0)
 ;
"RTN","MAGGSIA",111,0)
 ;
"RTN","MAGGSIA",112,0)
 ;  IF This image is a member of a Group, Update the Group Entry with new child.
"RTN","MAGGSIA",113,0)
 S X=$G(MAGGFDA(2005,"+1,",14)) I +X D  I $L(MAGERR) S MAGRY(0)=MAGERR Q
"RTN","MAGGSIA",114,0)
 . D UPDPAR^MAGGSIM(.MAGERR,X,.MAGACT,MAGGDA)        ;
"RTN","MAGGSIA",115,0)
 ;
"RTN","MAGGSIA",116,0)
 ;** ABS and JB image queues AREN'T SET WHEN ADDING AN IMAGE. 
"RTN","MAGGSIA",117,0)
 ;** RPC =-> 'MAG ABSJB' after abstract is/isn't created on the workstation
"RTN","MAGGSIA",118,0)
 ;
"RTN","MAGGSIA",119,0)
 ;  The Return is:  IEN ^ DRIVE:DIR ^ FILE.EXT [^ DRIVE:DIR ^ FILE.BIG]
"RTN","MAGGSIA",120,0)
 ;   i.e  487^C:\IMAGE\^DC000487.TIF
"RTN","MAGGSIA",121,0)
 ;  The calling routine is responsible for renaming/naming the file
"RTN","MAGGSIA",122,0)
 ;   to the returned DRIVE:\DIR\FILENAME.EXT
"RTN","MAGGSIA",123,0)
 ;
"RTN","MAGGSIA",124,0)
 ; Modified 4/23/98 to include hierarchial directory structure -- PMK
"RTN","MAGGSIA",125,0)
 S MAGDHASH=$$DIRHASH^MAGFILEB(MAGGFNM,MAGREF)
"RTN","MAGGSIA",126,0)
 ; For now, BIG files are in same directory as FullRes (or PACS) file
"RTN","MAGGSIA",127,0)
 S MAGRY(0)=MAGGDA_U_MAGGDRV_MAGDHASH_U_MAGGFNM
"RTN","MAGGSIA",128,0)
 ; If BIG file also, add it's Drive, Hash, Filename to end of Return string.
"RTN","MAGGSIA",129,0)
 I $G(MAGACT("BIG")) D
"RTN","MAGGSIA",130,0)
 . S X=$P(MAGGFNM,".",1)_".BIG"
"RTN","MAGGSIA",131,0)
 . S MAGRY(0)=MAGRY(0)_U_MAGGDRV_MAGDHASH_U_X
"RTN","MAGGSIA",132,0)
 ;
"RTN","MAGGSIA",133,0)
 D CLEAN^DILF
"RTN","MAGGSIA",134,0)
 Q
"RTN","MAGGSIA1")
0^6^B26495770
"RTN","MAGGSIA1",1,0)
MAGGSIA1 ;WOIFO/GEK - RPC Call to Add Image File entry ; [ 12/27/2000 10:49 ]
"RTN","MAGGSIA1",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSIA1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIA1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIA1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIA1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIA1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIA1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIA1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIA1",10,0)
 ;; |                                                               |
"RTN","MAGGSIA1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIA1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIA1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIA1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIA1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIA1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIA1",17,0)
 ;;
"RTN","MAGGSIA1",18,0)
 Q
"RTN","MAGGSIA1",19,0)
PRE(MAGERR,MAGGFDA,MAGGRP,MAGGDRV,MAGREF) ;
"RTN","MAGGSIA1",20,0)
 ;  Check on some possible problems: required fields etc.
"RTN","MAGGSIA1",21,0)
 ;  Object Type and (Patient, or Short Desc) Required.
"RTN","MAGGSIA1",22,0)
 I '$D(MAGGFDA(2005,"+1,",3)) D OBJTYPE
"RTN","MAGGSIA1",23,0)
 I '$D(MAGGFDA(2005,"+1,",3)) S MAGERR="0^Need an Object Type " Q
"RTN","MAGGSIA1",24,0)
 I '$D(MAGGFDA(2005,"+1,",5)),'$D(MAGGFDA(2005,"+1,",10)) D  Q
"RTN","MAGGSIA1",25,0)
 . S MAGERR="0^Need Patient or Short Desc.  Operation CANCELED "
"RTN","MAGGSIA1",26,0)
 ; IF no Procedure text we'll give it some so crossref will set.
"RTN","MAGGSIA1",27,0)
 D PATCHK(.MAGZ) I 'MAGZ S MAGERR=MAGZ Q
"RTN","MAGGSIA1",28,0)
 I '$D(MAGGFDA(2005,"+1,",6)) D PROCTEXT
"RTN","MAGGSIA1",29,0)
 ;
"RTN","MAGGSIA1",30,0)
 ; If no Procedure/Exam Date/Time we'll give it DocDT, or NOW
"RTN","MAGGSIA1",31,0)
 I '$D(MAGGFDA(2005,"+1,",15)) D
"RTN","MAGGSIA1",32,0)
 . I $D(MAGGFDA(2005,"+1,",110)) S MAGGFDA(2005,"+1,",15)=MAGGFDA(2005,"+1,",110) Q
"RTN","MAGGSIA1",33,0)
 . S MAGGFDA(2005,"+1,",15)=$E($$NOW^XLFDT,1,12)
"RTN","MAGGSIA1",34,0)
 ; DateTime image saved.
"RTN","MAGGSIA1",35,0)
 I '$D(MAGGFDA(2005,"+1,",7)) S MAGGFDA(2005,"+1,",7)=$E($$NOW^XLFDT,1,12)
"RTN","MAGGSIA1",36,0)
 ; Short Description
"RTN","MAGGSIA1",37,0)
 ;I '$D(MAGGFDA(2005,"+1,",10)) S MAGGFDA(2005,"+1,",10)=$$MAKENAME^MAGGSIU1(.MAGGFDA)
"RTN","MAGGSIA1",38,0)
 I '$D(MAGGFDA(2005,"+1,",10)) S MAGGFDA(2005,"+1,",10)=$G(MAGGFDA(2005,"+1,",6))
"RTN","MAGGSIA1",39,0)
 ; Name (.01)
"RTN","MAGGSIA1",40,0)
 I '$D(MAGGFDA(2005,"+1,",.01)) S MAGGFDA(2005,"+1,",.01)=$$MAKENAME^MAGGSIU1(.MAGGFDA)
"RTN","MAGGSIA1",41,0)
 ; Only get drive:dir if not a group
"RTN","MAGGSIA1",42,0)
 I '$D(MAGGFDA(2005,"+1,",8)) S MAGGFDA(2005,"+1,",8)=$G(DUZ)
"RTN","MAGGSIA1",43,0)
 I 'MAGGRP D  I $L(MAGERR) Q
"RTN","MAGGSIA1",44,0)
 . ; The value of the Action Code "WRITE^value" OVERRIDES any Write Location
"RTN","MAGGSIA1",45,0)
 . ; sent as field # 2 in the input array. (The only value we check for is "PACS" from peter's code)
"RTN","MAGGSIA1",46,0)
 . S X=$S($D(MAGACT("WRITE")):MAGACT("WRITE"),$D(MAGGFDA(2005,"+1,",2)):MAGGFDA(2005,"+1,",2),1:"")
"RTN","MAGGSIA1",47,0)
 . S Z=$$DRIVE^MAGGSIU1(X)                     ;Drv:Dir to Write
"RTN","MAGGSIA1",48,0)
 . I 'Z S MAGERR=Z Q
"RTN","MAGGSIA1",49,0)
 . S MAGGDRV=$P(Z,U,2)
"RTN","MAGGSIA1",50,0)
 . S MAGGFDA(2005,"+1,",2)=+Z               ;Disk & Vol magnetic
"RTN","MAGGSIA1",51,0)
 . ; if a big file is being made on workstation, put NetWork Location
"RTN","MAGGSIA1",52,0)
 . ; pointer in the BIG NETWORK LOCATION field.
"RTN","MAGGSIA1",53,0)
 . ; (BIG files default to same Network Location as FullRes (or PACS))
"RTN","MAGGSIA1",54,0)
 . I $G(MAGACT("BIG"))=1 S MAGGFDA(2005,"+1,",102)=+Z
"RTN","MAGGSIA1",55,0)
 . S MAGREF=+Z ; save network location ien for $$DIRHASH in ^MAGGSIA1
"RTN","MAGGSIA1",56,0)
 . I $G(MAGACT("ABS"))="STUFFONLY" S MAGGFDA(2005,"+1,",2.1)=+Z
"RTN","MAGGSIA1",57,0)
 ;
"RTN","MAGGSIA1",58,0)
 ; If a Name (.01) wasn't sent, we'll make one
"RTN","MAGGSIA1",59,0)
 ; We know that either Patient or Short Desc, and Object Type exist
"RTN","MAGGSIA1",60,0)
 I '$D(MAGGFDA(2005,"+1,",.01)) S MAGGFDA(2005,"+1,",.01)=$$MAKENAME^MAGGSIU1(.MAGGFDA)
"RTN","MAGGSIA1",61,0)
 ;
"RTN","MAGGSIA1",62,0)
 ; If an Acquisition Site is passed, save it in image file
"RTN","MAGGSIA1",63,0)
 I $D(MAGACT("ACQS")) D
"RTN","MAGGSIA1",64,0)
 . I $P(MAGACT("ACQS"),";")]"" S MAGGFDA(2005,"+1,",105)=$P(MAGACT("ACQS"),";")
"RTN","MAGGSIA1",65,0)
 ;{TODO: Have to modify here, for CONSOLIDATION 105 is NOW .05
"RTN","MAGGSIA1",66,0)
 ; HERE we are putting PRE Processing for the Import API action codes.
"RTN","MAGGSIA1",67,0)
 ; "ACQD,ACQS" If Acquisition device entry doesn't exist, create it.
"RTN","MAGGSIA1",68,0)
 I $D(MAGACT("ACQD")) D
"RTN","MAGGSIA1",69,0)
 . I $D(^MAG(2006.04,"B",MAGACT("ACQD"))) D  Q
"RTN","MAGGSIA1",70,0)
 . . ; IF Already exists, add it to the FDA
"RTN","MAGGSIA1",71,0)
 . . S MAGGFDA(2005,"+1,",107)=$O(^MAG(2006.04,"B",MAGACT("ACQD"),""))
"RTN","MAGGSIA1",72,0)
 . . ; What do we do with the Acquisition Site. IF Acq Dev already exists. ? 
"RTN","MAGGSIA1",73,0)
 . . ; ??
"RTN","MAGGSIA1",74,0)
 . ; IF it doesn't exist, create it, and add it's ien to the 
"RTN","MAGGSIA1",75,0)
 . N MAGDFDA,MAGDIEN,MAGDXE
"RTN","MAGGSIA1",76,0)
 . S MAGDFDA(2006.04,"+1,",.01)=MAGACT("ACQD")
"RTN","MAGGSIA1",77,0)
 . S MAGDFDA(2006.04,"+1,",1)=$P($G(MAGACT("ACQS")),";",1)
"RTN","MAGGSIA1",78,0)
 . S MAGDFDA(2006.04,"+1,",2)=$P($G(MAGACT("ACQS")),";",2)
"RTN","MAGGSIA1",79,0)
 . D UPDATE^DIE("","MAGDFDA","MAGDIEN","MAGDXE")
"RTN","MAGGSIA1",80,0)
 . S MAGGFDA(2005,"+1,",107)=MAGDIEN(1)
"RTN","MAGGSIA1",81,0)
 ;
"RTN","MAGGSIA1",82,0)
 ;  Check the last entry in Audit File to see if it is greater than 
"RTN","MAGGSIA1",83,0)
 ; last image in Image File.  IF yes, change Image File (0) node entry.
"RTN","MAGGSIA1",84,0)
 I ($O(^MAG(2005,"A"),-1)<$O(^MAG(2005.1,"A"),-1)) S $P(^MAG(2005,0),U,3)=$O(^MAG(2005.1,"A"),-1)
"RTN","MAGGSIA1",85,0)
 ;
"RTN","MAGGSIA1",86,0)
 Q
"RTN","MAGGSIA1",87,0)
PATCHK(MAGR) ; This uses the FDA Array and checks the Imaging Patient against the Procedure patient
"RTN","MAGGSIA1",88,0)
 N MAGDFN,PXDFN,PXDA,MAGY
"RTN","MAGGSIA1",89,0)
 S PX=$G(MAGGFDA(2005,"+1,",16))
"RTN","MAGGSIA1",90,0)
 S PXDA=$G(MAGGFDA(2005,"+1,",17))
"RTN","MAGGSIA1",91,0)
 I 'PX S MAGR=1 Q  ; This is a category, or an Image of a group (no parent pointer)
"RTN","MAGGSIA1",92,0)
 S MAGDFN=MAGGFDA(2005,"+1,",5)
"RTN","MAGGSIA1",93,0)
 I (PX=8925) D  Q
"RTN","MAGGSIA1",94,0)
 . I '$D(^TIU(8925,PXDA)) S MAGR="0^Invalid TIU Entry Number: "_PXDA Q
"RTN","MAGGSIA1",95,0)
 . D DATA^MAGGSTI(.MAGY,PXDA)
"RTN","MAGGSIA1",96,0)
 . I '(MAGDFN=$P(MAGY,U,4)) S MAGR="0^Procedure and Imaging patients don't match." Q
"RTN","MAGGSIA1",97,0)
 . S MAGR=1
"RTN","MAGGSIA1",98,0)
 Q
"RTN","MAGGSIA1",99,0)
OBJTYPE ; This call uses the EXT and computes an Object Type
"RTN","MAGGSIA1",100,0)
 N MTYPE
"RTN","MAGGSIA1",101,0)
 I '$L($G(MAGACT("EXT"))) Q
"RTN","MAGGSIA1",102,0)
 S MTYPE=$O(^MAG(2005.02,"AD",MAGACT("EXT"),""))
"RTN","MAGGSIA1",103,0)
 ;I 'MTYPE Q
"RTN","MAGGSIA1",104,0)
 ;TODO : Answer question, do we want to have a default Image type ?
"RTN","MAGGSIA1",105,0)
 I 'MTYPE S MTYPE=1
"RTN","MAGGSIA1",106,0)
 S MAGGFDA(2005,"+1,",3)=MTYPE
"RTN","MAGGSIA1",107,0)
 Q
"RTN","MAGGSIA1",108,0)
PROCTEXT ;This call uses flds 16 and 17 to compute fld #6 PROCEDURE TEXT [8F]
"RTN","MAGGSIA1",109,0)
 ; We are here because fld #6 PROCEDURE [8F] is null.
"RTN","MAGGSIA1",110,0)
 ; If a pointer to a package is in the data, (flds 16 and 17)
"RTN","MAGGSIA1",111,0)
 ;  get fld #6 from that , if not then treat it as an UNASSIGNED image 
"RTN","MAGGSIA1",112,0)
 ; i.e. Category UNASSIGNED.
"RTN","MAGGSIA1",113,0)
 N MAGYPX,PARENT,PARIEN,PXDESC
"RTN","MAGGSIA1",114,0)
 S PARENT=$G(MAGGFDA(2005,"+1,",16))
"RTN","MAGGSIA1",115,0)
 S PARIEN=$G(MAGGFDA(2005,"+1,",17))
"RTN","MAGGSIA1",116,0)
 ;
"RTN","MAGGSIA1",117,0)
 I (PARENT=8925),(PARIEN]"") D  Q
"RTN","MAGGSIA1",118,0)
 . D DATA^MAGGSTI(.MAGYPX,PARIEN)
"RTN","MAGGSIA1",119,0)
 . S MAGGFDA(2005,"+1,",6)=$P(MAGYPX,U,2)
"RTN","MAGGSIA1",120,0)
 ;TODO; create calls to get default procedure desc for all specialties
"RTN","MAGGSIA1",121,0)
 ; If a Parent pointer exists, and it isn't TIU, for now set "NO Description"
"RTN","MAGGSIA1",122,0)
 I PARENT]"" S MAGGFDA(2005,"+1,",6)="No Description" Q
"RTN","MAGGSIA1",123,0)
 ;
"RTN","MAGGSIA1",124,0)
 ; Do we have a pointer to a MAG DESCRIPTIVE CATEGORY
"RTN","MAGGSIA1",125,0)
 I ($G(MAGGFDA(2005,"+1,",100))]"") D  Q
"RTN","MAGGSIA1",126,0)
 . S MAGGFDA(2005,"+1,",6)=$P(^MAG(2005.81,MAGGFDA(2005,"+1,",100),0),U,1)
"RTN","MAGGSIA1",127,0)
 ; 
"RTN","MAGGSIA1",128,0)
 ; If a new child of a Group, use that Proc Desc
"RTN","MAGGSIA1",129,0)
 I $G(MAGGFDA(2005,"+1,",14))]"" D  Q
"RTN","MAGGSIA1",130,0)
 . S MAGGFDA(2005,"+1,",6)=$P(^MAG(2005,MAGGFDA(2005,"+1,",14),0),U,8)
"RTN","MAGGSIA1",131,0)
 ;
"RTN","MAGGSIA1",132,0)
 ; Parent="", and no Category pointer, then we Call it UNASSIGNED
"RTN","MAGGSIA1",133,0)
 S MAGGFDA(2005,"+1,",100)=$O(^MAG(2005.81,"B","UNASSIGNED",""))
"RTN","MAGGSIA1",134,0)
 S MAGGFDA(2005,"+1,",6)="UNASSIGNED"
"RTN","MAGGSIA1",135,0)
 Q
"RTN","MAGGSIM")
0^7^B14481813
"RTN","MAGGSIM",1,0)
MAGGSIM ;WOIFO/GEK - Call to Modify Image File entry ; [ 12/27/2000 10:49 ]
"RTN","MAGGSIM",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSIM",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIM",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIM",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIM",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIM",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIM",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIM",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIM",10,0)
 ;; |                                                               |
"RTN","MAGGSIM",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIM",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIM",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIM",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIM",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIM",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIM",17,0)
 ;;
"RTN","MAGGSIM",18,0)
 Q
"RTN","MAGGSIM",19,0)
 ;
"RTN","MAGGSIM",20,0)
MOD(MAGRY,MAGARRAY) ; RPC Call to UPDATE^DIE to Add an Image File entry
"RTN","MAGGSIM",21,0)
 ;  Parameters : 
"RTN","MAGGSIM",22,0)
 ;    MAGARRAY -  array of field numbers and their entries
"RTN","MAGGSIM",23,0)
 ;             i.e. MAGARRAY(1)=".5^38"  field# .5   data is 38
"RTN","MAGGSIM",24,0)
 ;    If Long Description is included in array (field 11), we create a new
"RTN","MAGGSIM",25,0)
 ;      array to hold the text, and pass that to UPDATE^DIE
"RTN","MAGGSIM",26,0)
 ;    If this entry is an Image Group
"RTN","MAGGSIM",27,0)
 ;      i.e. MAGARRAY(n)="2005.04^344"
"RTN","MAGGSIM",28,0)
 ;      (the field 2005.04 is the OBJECT GROUP MULTIPLE)
"RTN","MAGGSIM",29,0)
 ;      ( 344 is the pointer to the Image File Entry that will be added
"RTN","MAGGSIM",30,0)
 ;      ( as a member of this new/existing Group)
"RTN","MAGGSIM",31,0)
 ;
"RTN","MAGGSIM",32,0)
 ;  Return Variable
"RTN","MAGGSIM",33,0)
 ;       MAGRY is a string;
"RTN","MAGGSIM",34,0)
 ;               "1^success"
"RTN","MAGGSIM",35,0)
 ;               "0^Error message"
"RTN","MAGGSIM",36,0)
 ;
"RTN","MAGGSIM",37,0)
 N MAGGFDA,MAGGDRV,MAGGRP,MAGCHLD,GRPCT,MAGGDA,MAGGFNM
"RTN","MAGGSIM",38,0)
 N MAGGWP,WPCT,MAGGFLD,MAGGDAT,MAGERR
"RTN","MAGGSIM",39,0)
 N MAGREF,MAGDHASH,MAGTEMP
"RTN","MAGGSIM",40,0)
 N MAGVY,MAGACT
"RTN","MAGGSIM",41,0)
 N MAGTEMP,TEMPIEN
"RTN","MAGGSIM",42,0)
 N MAGGIEN,MAGGXE
"RTN","MAGGSIM",43,0)
 N I,J,X,Y,Z
"RTN","MAGGSIM",44,0)
 ;
"RTN","MAGGSIM",45,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGGSERR"
"RTN","MAGGSIM",46,0)
 ;
"RTN","MAGGSIM",47,0)
 I ($D(MAGARRAY)<10) S MAGRY="0^No input data, Operation CANCELED" Q
"RTN","MAGGSIM",48,0)
 ;
"RTN","MAGGSIM",49,0)
 S MAGRY="0^Creating VistA Image Entry..."
"RTN","MAGGSIM",50,0)
 S MAGERR="",MAGGRP=0,GRPCT=1,WPCT=0
"RTN","MAGGSIM",51,0)
 ;
"RTN","MAGGSIM",52,0)
 ;  Validate the Data, and Action codes in the Input Array
"RTN","MAGGSIM",53,0)
 D VAL^MAGGSIV(.MAGVY,.MAGARRAY) I 'MAGVY(0) S MAGRY=MAGVY(0) Q
"RTN","MAGGSIM",54,0)
 ;
"RTN","MAGGSIM",55,0)
 ;
"RTN","MAGGSIM",56,0)
 ;  Make the FileMan FDA array and the Imaging Action array.
"RTN","MAGGSIM",57,0)
 D MAKEFDA^MAGGSIU2(.MAGGFDA,.MAGARRAY,.MAGACT,.MAGCHLD,.MAGGRP,.MAGGWP)
"RTN","MAGGSIM",58,0)
 ;
"RTN","MAGGSIM",59,0)
 I '$D(MAGACT("IEN")) S MAGRY="0^You Need to send the IEN" Q
"RTN","MAGGSIM",60,0)
 ;
"RTN","MAGGSIM",61,0)
 I '$D(MAGGFDA(2005,"+1,")) S MAGRY="0^No data to file.  Operation CANCELED." Q
"RTN","MAGGSIM",62,0)
 ;
"RTN","MAGGSIM",63,0)
 S TEMPIEN=MAGACT("IEN")_","
"RTN","MAGGSIM",64,0)
 M MAGTEMP(2005,TEMPIEN)=MAGGFDA(2005,"+1,") K MAGGFDA
"RTN","MAGGSIM",65,0)
 M MAGGFDA=MAGTEMP K MAGTEMP
"RTN","MAGGSIM",66,0)
 ;
"RTN","MAGGSIM",67,0)
 D FILE^DIE("S","MAGGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGSIM",68,0)
 ; We shouldn't have errors, because the data was validated before the call
"RTN","MAGGSIM",69,0)
 ; But we'll still check for errors.
"RTN","MAGGSIM",70,0)
 I $D(DIERR) D  S MAGRY=MAGERR Q
"RTN","MAGGSIM",71,0)
 . D RTRNERR(.MAGERR)
"RTN","MAGGSIM",72,0)
 . D CLEAN^DILF
"RTN","MAGGSIM",73,0)
 ;
"RTN","MAGGSIM",74,0)
 ;S MAGRY="1^OK"
"RTN","MAGGSIM",75,0)
 D ACTION^MAGGTAU("MOD^"_$G(MAGACT("IEN")))
"RTN","MAGGSIM",76,0)
 ;
"RTN","MAGGSIM",77,0)
 ;Q
"RTN","MAGGSIM",78,0)
 ;  THE REST OF THIS IS FROM IMAGE ADD, DON'T KNOW YET WHAT
"RTN","MAGGSIM",79,0)
 ;  WE NEED TO CHECK or are going to allow from the GUI.
"RTN","MAGGSIM",80,0)
 ;
"RTN","MAGGSIM",81,0)
 ; IF THE IEN is a group, Modify GROUP PARENT in each Group Object and QUIT
"RTN","MAGGSIM",82,0)
 ;
"RTN","MAGGSIM",83,0)
 I MAGGRP D UPDCHLD(.MAGCHLD,MAGACT("IEN")) S MAGRY="1^OK" Q
"RTN","MAGGSIM",84,0)
 ; 
"RTN","MAGGSIM",85,0)
 I $G(MAGGFDA(2005,"+1,",14)) D  I $L(MAGERR) S MAGRY=MAGERR Q
"RTN","MAGGSIM",86,0)
 . D UPDPAR(.MAGERR,MAGGFDA(2005,"+1,",14),.MAGACT,MAGACT("IEN"))
"RTN","MAGGSIM",87,0)
 Q
"RTN","MAGGSIM",88,0)
UPDPAR(MAGERR,MAGRPDA,MAGACT,MAGGDA) ;
"RTN","MAGGSIM",89,0)
 ; We're here beceause this image is a member of a Group
"RTN","MAGGSIM",90,0)
 ;   so we will modify the Group Parent, adding this to it's group
"RTN","MAGGSIM",91,0)
 ; HERE we will also send the 'Series Number' and 'Image Number' if
"RTN","MAGGSIM",92,0)
 ; they exist;
"RTN","MAGGSIM",93,0)
 N MAGFDA
"RTN","MAGGSIM",94,0)
 S Y="+2,"_MAGRPDA_","
"RTN","MAGGSIM",95,0)
 S MAGFDA(2005.04,Y,.01)=MAGGDA
"RTN","MAGGSIM",96,0)
 ; DICOM SERIES AND IMAGE NUMBER CAN BE ANYTHING, WE CAN'T CHECK FOR +X
"RTN","MAGGSIM",97,0)
 I $L($G(MAGACT("DICOMSN"))) S MAGFDA(2005.04,Y,1)=MAGACT("DICOMSN")
"RTN","MAGGSIM",98,0)
 I $L($G(MAGACT("DICOMIN"))) S MAGFDA(2005.04,Y,2)=MAGACT("DICOMIN")
"RTN","MAGGSIM",99,0)
 D UPDATE^DIE("S","MAGFDA","MAGGIEN","MAGGXE")
"RTN","MAGGSIM",100,0)
 ;   in case of an error
"RTN","MAGGSIM",101,0)
 I $D(DIERR) D RTRNERR(.MAGERR)
"RTN","MAGGSIM",102,0)
 D CLEAN^DILF
"RTN","MAGGSIM",103,0)
 Q
"RTN","MAGGSIM",104,0)
 ;
"RTN","MAGGSIM",105,0)
UPDCHLD(MAGCHLD,MAGGDA) ;
"RTN","MAGGSIM",106,0)
 S Z=""
"RTN","MAGGSIM",107,0)
 F  S Z=$O(MAGCHLD(Z)) Q:Z=""  D
"RTN","MAGGSIM",108,0)
 . S $P(^MAG(2005,Z,0),U,10)=MAGGDA
"RTN","MAGGSIM",109,0)
 . ; TODO;  have to modify the parent global root, ( delete it if 
"RTN","MAGGSIM",110,0)
 . ; this image was assigned as a single to the wrong parent )
"RTN","MAGGSIM",111,0)
 Q
"RTN","MAGGSIM",112,0)
RTRNERR(ETXT) ; There was error from FILE^DIE quit with error text
"RTN","MAGGSIM",113,0)
 S ETXT="0^ERROR  "_MAGGXE("DIERR",1,"TEXT",1)
"RTN","MAGGSIM",114,0)
 Q
"RTN","MAGGSIU1")
0^8^B6965279
"RTN","MAGGSIU1",1,0)
MAGGSIU1 ;WOIFO/GEK - Utilities for Image Add/Modify ; [ 12/27/2000 10:49 ]
"RTN","MAGGSIU1",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSIU1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIU1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIU1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIU1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIU1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIU1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIU1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIU1",10,0)
 ;; |                                                               |
"RTN","MAGGSIU1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIU1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIU1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIU1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIU1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIU1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIU1",17,0)
 ;;
"RTN","MAGGSIU1",18,0)
 Q
"RTN","MAGGSIU1",19,0)
 ;
"RTN","MAGGSIU1",20,0)
DRIVE(X) ; Get the drive for writing an image
"RTN","MAGGSIU1",21,0)
 ; X Can be:
"RTN","MAGGSIU1",22,0)
 ;      "PACS"  - return the Write directory for PACS   from Site Params file
"RTN","MAGGSIU1",23,0)
 ;       IEN    - return the Write directory of the IEN from NETWORK LOCATION File
"RTN","MAGGSIU1",24,0)
 ;       ""     - return the Write Directory default    from Site Params File
"RTN","MAGGSIU1",25,0)
 ; X is converted into the correct NETWORK LOCATION IEN and returned.
"RTN","MAGGSIU1",26,0)
 N MAGREFNM,MAGDRIVE
"RTN","MAGGSIU1",27,0)
 ;
"RTN","MAGGSIU1",28,0)
 I X="PACS" S X=$G(^MAG(2006.1,"APXWRITE"))
"RTN","MAGGSIU1",29,0)
 I '$L(X) S X=$G(^MAG(2006.1,"ARITE"))
"RTN","MAGGSIU1",30,0)
 ; Quit if no write location
"RTN","MAGGSIU1",31,0)
 Q:X="" "0^NEED WRITE LOCATION in SITE Parameters file!!! Call IRM"
"RTN","MAGGSIU1",32,0)
 ;  Quit if the IEN Passed is invalid.
"RTN","MAGGSIU1",33,0)
 Q:'$D(^MAG(2005.2,X)) "0^INVALID IEN for Network Location: "_X
"RTN","MAGGSIU1",34,0)
 Q:'$P(^MAG(2005.2,X,0),"^",6) "0^The Server that you are writing to is off-line.  Call IRM"
"RTN","MAGGSIU1",35,0)
 ;
"RTN","MAGGSIU1",36,0)
 S MAGREFNM=$P(^MAG(2005.2,X,0),"^",1),MAGDRIVE=$P(^(0),U,2)
"RTN","MAGGSIU1",37,0)
 Q X_U_MAGDRIVE
"RTN","MAGGSIU1",38,0)
 ;
"RTN","MAGGSIU1",39,0)
DA2NAME(IEN,EXT) ; Return file name with extension (.TIF ) FOR NOW
"RTN","MAGGSIU1",40,0)
 ;
"RTN","MAGGSIU1",41,0)
 ; calling MAGGTU1 to keep file name generating in one place - saf 7/11/02
"RTN","MAGGSIU1",42,0)
 Q $$DA2NAME^MAGGTU1(IEN,EXT)
"RTN","MAGGSIU1",43,0)
 ;
"RTN","MAGGSIU1",44,0)
MAKENAME(MAGGFDA) ; get info from the MAGGFDA array
"RTN","MAGGSIU1",45,0)
 ;  For all Images the Name (.01) is first 18 characters of patient name 
"RTN","MAGGSIU1",46,0)
 ;    concatenated with SSN.
"RTN","MAGGSIU1",47,0)
 ;  If No patient name is sent, well make the name from the short desc.
"RTN","MAGGSIU1",48,0)
 ;  We were making name of : 
"RTN","MAGGSIU1",49,0)
 ;    $E(PATENT NAME,1,10)' '$E(DESC CATEG,1,9)' 'MM/DD/YY   (DOC DATE)
"RTN","MAGGSIU1",50,0)
 N ZDESC
"RTN","MAGGSIU1",51,0)
 S ZDESC=""
"RTN","MAGGSIU1",52,0)
 ; If we don't have a patient name ( later) we set .01 to Short Desc 
"RTN","MAGGSIU1",53,0)
 ; if it exists.
"RTN","MAGGSIU1",54,0)
 I $D(MAGGFDA(2005,"+1,",10)) S ZDESC=$E(MAGGFDA(2005,"+1,",10),1,30)
"RTN","MAGGSIU1",55,0)
 ;                   DFN
"RTN","MAGGSIU1",56,0)
 I $D(MAGGFDA(2005,"+1,",5)) D
"RTN","MAGGSIU1",57,0)
 . S X=MAGGFDA(2005,"+1,",5)
"RTN","MAGGSIU1",58,0)
 . ;                NAME                        SSN
"RTN","MAGGSIU1",59,0)
 . S ZDESC=$E($P(^DPT(X,0),U),1,18)_"   "_$P(^DPT(X,0),U,9)
"RTN","MAGGSIU1",60,0)
 ;
"RTN","MAGGSIU1",61,0)
 Q ZDESC
"RTN","MAGGSIU1",62,0)
KILLENT(MAGGDA) ; Delete the entry just created, because of Post processing Error
"RTN","MAGGSIU1",63,0)
 D CLEAN^DILF
"RTN","MAGGSIU1",64,0)
 S DA=MAGGDA,DIK="^MAG(2005," D ^DIK
"RTN","MAGGSIU1",65,0)
 K DA,DIC,DIK
"RTN","MAGGSIU1",66,0)
 Q
"RTN","MAGGSIU1",67,0)
RTRNERR(ETXT,MAGGXE) ; There was error from UPDATE^DIE quit with error text
"RTN","MAGGSIU1",68,0)
 S ETXT="0^ERROR  "_MAGGXE("DIERR",1,"TEXT",1)
"RTN","MAGGSIU1",69,0)
 Q
"RTN","MAGGSIU2")
0^9^B7177780
"RTN","MAGGSIU2",1,0)
MAGGSIU2 ;WOIFO/GEK - Utilities for Image Add/Modify ; [ 12/27/2000 10:49 ]
"RTN","MAGGSIU2",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSIU2",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIU2",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIU2",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIU2",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIU2",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIU2",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIU2",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIU2",10,0)
 ;; |                                                               |
"RTN","MAGGSIU2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIU2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIU2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIU2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIU2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIU2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIU2",17,0)
 ;;
"RTN","MAGGSIU2",18,0)
 Q
"RTN","MAGGSIU2",19,0)
MAKEFDA(MAGGFDA,MAGARRAY,MAGACT,MAGCHLD,MAGGRP,MAGGWP) ;
"RTN","MAGGSIU2",20,0)
 ;  Create the FileMan FDA Array
"RTN","MAGGSIU2",21,0)
 ;  Create Imaging Action Codes Array (for Pre and Post processing)
"RTN","MAGGSIU2",22,0)
 N MAGGFLD,MAGGDAT
"RTN","MAGGSIU2",23,0)
 S Z="" F  S Z=$O(MAGARRAY(Z)) Q:Z=""  D  I $L(MAGERR) Q
"RTN","MAGGSIU2",24,0)
 . S MAGGFLD=$P(MAGARRAY(Z),U,1),MAGGDAT=$P(MAGARRAY(Z),U,2,99)
"RTN","MAGGSIU2",25,0)
 . ;  If this entry is one of the action codes, store it in the action array.
"RTN","MAGGSIU2",26,0)
 . I $$ACTCODE^MAGGSIV(MAGGFLD) S MAGACT(MAGGFLD)=MAGGDAT Q
"RTN","MAGGSIU2",27,0)
 . ;
"RTN","MAGGSIU2",28,0)
 . ; If we are Creating a Group Entry, add any Images that are to be members of this group.
"RTN","MAGGSIU2",29,0)
 . I MAGGFLD=2005.04 D  Q
"RTN","MAGGSIU2",30,0)
 . . S MAGGRP=1
"RTN","MAGGSIU2",31,0)
 . . I '+MAGGDAT Q  ; making a group entry, with no group entries yet. This is OK.
"RTN","MAGGSIU2",32,0)
 . . S MAGCHLD(MAGGDAT)=""
"RTN","MAGGSIU2",33,0)
 . . S GRPCT=GRPCT+1
"RTN","MAGGSIU2",34,0)
 . . S MAGGFDA(2005.04,"+"_GRPCT_",+1,",.01)=MAGGDAT
"RTN","MAGGSIU2",35,0)
 . ;
"RTN","MAGGSIU2",36,0)
 . ; if we are getting a WP for Long Desc, set array to pass.
"RTN","MAGGSIU2",37,0)
 . I MAGGFLD=11 D  ; this is one line of the WP Long Desc field.
"RTN","MAGGSIU2",38,0)
 . . S WPCT=WPCT+1,MAGGWP(WPCT)=MAGGDAT
"RTN","MAGGSIU2",39,0)
 . . S MAGGFDA(2005,"+1,",11)="MAGGWP"
"RTN","MAGGSIU2",40,0)
 . ;  Set the Node for the UPDATE^DIC Call.
"RTN","MAGGSIU2",41,0)
 . S MAGGFDA(2005,"+1,",MAGGFLD)=MAGGDAT
"RTN","MAGGSIU2",42,0)
 Q
"RTN","MAGGSIU3")
0^10^B15853804
"RTN","MAGGSIU3",1,0)
MAGGSIU3 ;WOIFO/GEK - Utilities  ; 01 Nov 2001 12:32 PM 
"RTN","MAGGSIU3",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSIU3",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIU3",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIU3",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIU3",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIU3",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIU3",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIU3",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIU3",10,0)
 ;; |                                                               |
"RTN","MAGGSIU3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIU3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIU3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIU3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIU3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIU3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIU3",17,0)
 ;;
"RTN","MAGGSIU3",18,0)
 Q
"RTN","MAGGSIU3",19,0)
LOG(MAGRY,MAGIX,IMAGES,PAT,WRKS,TRKID) ;Utilities for Import API, logging data for tracking and debugging 
"RTN","MAGGSIU3",20,0)
 ; into Imaging Windows Session and Imaging Windows Workstation files.
"RTN","MAGGSIU3",21,0)
 N MAGIEN,MAG0,MAGSRV,MAGSTART,I,SESSIEN
"RTN","MAGGSIU3",22,0)
 I '$L($G(WRKS)) S WRKS="NULL WORKSTATION NAME"
"RTN","MAGGSIU3",23,0)
 S MAGIEN=0
"RTN","MAGGSIU3",24,0)
 S SESSIEN=0
"RTN","MAGGSIU3",25,0)
 S MAGIEN=$O(^MAG(2006.81,"B",WRKS,""))
"RTN","MAGGSIU3",26,0)
 I 'MAGIEN D NEWWRKS^MAGGTAU(WRKS,"",.MAGIEN) I MAGIEN<1 S MAGRY="0^Error Creating Workstation Entry." Q SESSIEN
"RTN","MAGGSIU3",27,0)
 ;
"RTN","MAGGSIU3",28,0)
 S MAG0=^MAG(2006.81,MAGIEN,0) ; '0' node for use later.
"RTN","MAGGSIU3",29,0)
 S MAGIEN=+MAGIEN_","
"RTN","MAGGSIU3",30,0)
 S MAGGFDA(2006.81,MAGIEN,.01)=WRKS ; Compter Name
"RTN","MAGGSIU3",31,0)
 S MAGGFDA(2006.81,MAGIEN,8)=0 ; Active or not.
"RTN","MAGGSIU3",32,0)
 S MAGGFDA(2006.81,MAGIEN,3)="@" ; delete logff time for this job.
"RTN","MAGGSIU3",33,0)
 S MAGGFDA(2006.81,MAGIEN,10)="@" ; delete session pointer
"RTN","MAGGSIU3",34,0)
 S MAGGFDA(2006.81,MAGIEN,11)="@" ; reset the session error count.
"RTN","MAGGSIU3",35,0)
 ;
"RTN","MAGGSIU3",36,0)
 S X=$P(MAG0,U,14)
"RTN","MAGGSIU3",37,0)
 S MAGGFDA(2006.81,MAGIEN,12.5)=X+1 ; total Import Sessions for workstation
"RTN","MAGGSIU3",38,0)
 ;
"RTN","MAGGSIU3",39,0)
 S X=$$NOW^XLFDT
"RTN","MAGGSIU3",40,0)
 S MAGSTART=$E(X,1,12)
"RTN","MAGGSIU3",41,0)
 I $G(DUZ) D 
"RTN","MAGGSIU3",42,0)
 . S MAGGFDA(2006.81,MAGIEN,1)=DUZ
"RTN","MAGGSIU3",43,0)
 . S MAGGFDA(2006.81,MAGIEN,2)=MAGSTART
"RTN","MAGGSIU3",44,0)
 ;
"RTN","MAGGSIU3",45,0)
 D UPDATE^DIE("S","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGSIU3",46,0)
 I $D(DIERR) D RTRNERR^MAGGTAU(.MAGRY) Q SESSIEN
"RTN","MAGGSIU3",47,0)
 ;
"RTN","MAGGSIU3",48,0)
 S MAGRY="1^"
"RTN","MAGGSIU3",49,0)
 ;
"RTN","MAGGSIU3",50,0)
 ; SESSION : Now here we have to create a new session entry;
"RTN","MAGGSIU3",51,0)
 ; //TODO, make a generic call to create a Session entry, this is 
"RTN","MAGGSIU3",52,0)
 ;   a duplicate of code in MAGGTAU
"RTN","MAGGSIU3",53,0)
 D GETS^DIQ(200,DUZ_",","29","I","Z","") ; service/section
"RTN","MAGGSIU3",54,0)
 S MAGSRV=$G(Z(200,DUZ_",",29,"I"))
"RTN","MAGGSIU3",55,0)
 ;
"RTN","MAGGSIU3",56,0)
 K MAGGFDA,MAGXERR,MAGXIEN
"RTN","MAGGSIU3",57,0)
 S MAGGFDA(2006.82,"+1,",.01)=$P(^VA(200,DUZ,0),U,1) ; User
"RTN","MAGGSIU3",58,0)
 S MAGGFDA(2006.82,"+1,",1)=DUZ ; USER
"RTN","MAGGSIU3",59,0)
 S MAGGFDA(2006.82,"+1,",2)=MAGSTART ; Session Start Time
"RTN","MAGGSIU3",60,0)
 S MAGGFDA(2006.82,"+1,",4)=+MAGIEN ; Workstation 
"RTN","MAGGSIU3",61,0)
 I $D(^DPT(+PAT,0)) S MAGGFDA(2006.82,"+1,",5)=+PAT ; Patient 
"RTN","MAGGSIU3",62,0)
 S MAGGFDA(2006.82,"+1,",7)=+MAGSRV ; User's Service/Section pointer
"RTN","MAGGSIU3",63,0)
 S MAGGFDA(2006.82,"+1,",13)=3 ; 1=normal 2= started by CPRS 3= Import API session.
"RTN","MAGGSIU3",64,0)
 S MAGGFDA(2006.82,"+1,",8)=$G(TRKID) ; Tracking ID
"RTN","MAGGSIU3",65,0)
 ;
"RTN","MAGGSIU3",66,0)
 D UPDATE^DIE("","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGSIU3",67,0)
 I $D(DIERR) D RTRNERR^MAGGTAU(.MAGRY) Q SESSIEN
"RTN","MAGGSIU3",68,0)
 S MAGRY="1^"
"RTN","MAGGSIU3",69,0)
 I '+MAGXIEN(1) S MAGRY="0^" Q SESSIEN
"RTN","MAGGSIU3",70,0)
 S SESSIEN=+MAGXIEN(1)
"RTN","MAGGSIU3",71,0)
 S MAGRY=SESSIEN_"^Session # "_SESSIEN_" Started."
"RTN","MAGGSIU3",72,0)
 S MAGGFDA(2006.81,+MAGIEN_",",10)=SESSIEN
"RTN","MAGGSIU3",73,0)
 D UPDATE^DIE("","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGSIU3",74,0)
 D ACTION^MAGGTAU("IMPORT^",0,SESSIEN)       ;
"RTN","MAGGSIU3",75,0)
 S I="" F  S I=$O(MAGIX(I)) Q:I=""  D ACTION^MAGGTAU("Data: "_I_": "_MAGIX(I),0,SESSIEN)
"RTN","MAGGSIU3",76,0)
 S I="" F  S I=$O(IMAGES(I)) Q:I=""  D ACTION^MAGGTAU("Image: "_I_": "_IMAGES(I),0,SESSIEN)
"RTN","MAGGSIU3",77,0)
 Q SESSIEN
"RTN","MAGGSIU3",78,0)
LOGRES(RES,LOGTM,MAGSESS) ;
"RTN","MAGGSIU3",79,0)
 N I
"RTN","MAGGSIU3",80,0)
 S LOGTM=+$G(LOGTM)
"RTN","MAGGSIU3",81,0)
 I '$G(MAGSESS) Q
"RTN","MAGGSIU3",82,0)
 D ACTION^MAGGTAU("RESULTS^",1,MAGSESS)       ;
"RTN","MAGGSIU3",83,0)
 S I="" F  S I=$O(RES(I)) Q:I=""  D ACTION^MAGGTAU("Result: "_I_": "_RES(I),LOGTM,MAGSESS)
"RTN","MAGGSIU3",84,0)
 Q
"RTN","MAGGSIUI")
0^11^B41895043
"RTN","MAGGSIUI",1,0)
MAGGSIUI ;WOIFO/GEK - Utilities for Image Import API
"RTN","MAGGSIUI",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSIUI",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIUI",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIUI",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIUI",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIUI",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIUI",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIUI",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIUI",10,0)
 ;; |                                                               |
"RTN","MAGGSIUI",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIUI",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIUI",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIUI",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIUI",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIUI",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIUI",17,0)
 ;;
"RTN","MAGGSIUI",18,0)
 Q
"RTN","MAGGSIUI",19,0)
REMOTE(MAGRY,MAGDATA) ; RPC Call : MAG4 REMOTE IMPORT
"RTN","MAGGSIUI",20,0)
 ; To Import Images into VistA from a Windows App, by sending an array.
"RTN","MAGGSIUI",21,0)
 I ($D(MAGDATA)<10) S MAGRY(0)="0^Missing Data Array !." Q
"RTN","MAGGSIUI",22,0)
 N I,J,ICT,DCT,MAGIX,IMAGES,ERR
"RTN","MAGGSIUI",23,0)
 S (ERR,ICT,DCT)=0
"RTN","MAGGSIUI",24,0)
 S I="" F  S I=$O(MAGDATA(I)) Q:I=""  S X=MAGDATA(I) D  Q:ERR
"RTN","MAGGSIUI",25,0)
 . S Z=$P(X,U)
"RTN","MAGGSIUI",26,0)
 . I (X="")!(Z="") S MAGRY(0)="0^INVALID Data in Input Array: Node "_I_"="""_X_"",ERR=1 Q
"RTN","MAGGSIUI",27,0)
 . I Z="IMAGE" S ICT=ICT+1,IMAGES(ICT)=$P(X,U,2,99) Q
"RTN","MAGGSIUI",28,0)
 . S DCT=DCT+1,MAGIX(Z)=$P(X,U,2,99)
"RTN","MAGGSIUI",29,0)
 I 'ERR D IMPORT(.MAGRY,.IMAGES,.MAGIX)
"RTN","MAGGSIUI",30,0)
 Q
"RTN","MAGGSIUI",31,0)
 ;
"RTN","MAGGSIUI",32,0)
IMPORT(MAGRY,IMAGES,MAGIX) ;
"RTN","MAGGSIUI",33,0)
 ; // IDFN,PXPKG,PXIEN,PXDT,TRKID,ACQD,ACQS,STSCB,ITYPE,
"RTN","MAGGSIUI",34,0)
 ;      CMTH,CDUZ,USERPASS,GDESC,DFLG,TRTYPE)    ;
"RTN","MAGGSIUI",35,0)
 ;
"RTN","MAGGSIUI",36,0)
 ;We'll convert the parameters into the Image Data Array,
"RTN","MAGGSIUI",37,0)
 ;   validate it, then set the Import Queue
"RTN","MAGGSIUI",38,0)
 ;
"RTN","MAGGSIUI",39,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGGSIUI"
"RTN","MAGGSIUI",40,0)
 K MAGRY S MAGRY(0)="0^Importing data..."
"RTN","MAGGSIUI",41,0)
 N APISESS
"RTN","MAGGSIUI",42,0)
 N PRM,CT,MAGA,MAGY,MAGTN,TNODE
"RTN","MAGGSIUI",43,0)
 N IDFN,PXPKG,PXIEN,PXDT,TRKID,ACQD,ACQS,ACQL,STSCB,ITYPE,CMTH,CDUZ
"RTN","MAGGSIUI",44,0)
 N USERNAME,PASSWORD,GDESC,DFLG,TRTYPE,DOCCTG,DOCDT
"RTN","MAGGSIUI",45,0)
 N MAGTM,QTIME
"RTN","MAGGSIUI",46,0)
 F PRM="IDFN","PXPKG","PXIEN","PXDT","TRKID","ACQD","ACQS","ACQL","STSCB","ITYPE","CMTH","CDUZ","USERNAME","PASSWORD","GDESC","DFLG","TRTYPE","DOCCTG","DOCDT" D
"RTN","MAGGSIUI",47,0)
 . S @PRM=$G(MAGIX(PRM))
"RTN","MAGGSIUI",48,0)
 ;
"RTN","MAGGSIUI",49,0)
 S MAGTM=$$NOW^XLFDT
"RTN","MAGGSIUI",50,0)
 I '$G(DUZ) S MAGRY(0)="0^DUZ is undefined." Q  ;D ERRTRK Q
"RTN","MAGGSIUI",51,0)
 ;
"RTN","MAGGSIUI",52,0)
 D DATATRK
"RTN","MAGGSIUI",53,0)
 I '$$REQPARAM() D ERRTRK Q
"RTN","MAGGSIUI",54,0)
 ;
"RTN","MAGGSIUI",55,0)
 ; Set the image data array
"RTN","MAGGSIUI",56,0)
 S CT=0
"RTN","MAGGSIUI",57,0)
 D SA(5,IDFN)    ;PATIENT
"RTN","MAGGSIUI",58,0)
 D SA(16,PXPKG)   ;PARENT DATA FILE
"RTN","MAGGSIUI",59,0)
 D SA(17,PXIEN) ;PARENT GLOBAL ROOT
"RTN","MAGGSIUI",60,0)
 D SA(15,PXDT)   ; PROCEDURE/EXAM DATE/TIME
"RTN","MAGGSIUI",61,0)
 D SA(108,TRKID) ; TRACKING ID (new)
"RTN","MAGGSIUI",62,0)
 D SA("ACQD",ACQD)  ; ACQUISTION DEVICE ( new )
"RTN","MAGGSIUI",63,0)
 ; Acquisition site is a 2 ';' piece param of INSTITUTION ';' HOSPITAL LOCATION  
"RTN","MAGGSIUI",64,0)
 ;//  ACQS had Location in it, doesn't now.
"RTN","MAGGSIUI",65,0)
 D SA(.05,ACQS) ; this used to be fld 105
"RTN","MAGGSIUI",66,0)
 D SA(101,ACQL)
"RTN","MAGGSIUI",67,0)
 D SA("ACQS",ACQS_";"_$G(ACQL)) ;Fields of ACQUISITION DEVICE file: #1 INSTITUTION ';' #2 HOSPITAL LOCATION
"RTN","MAGGSIUI",68,0)
 D SA("STATUSCB",STSCB)  ; STATUS CALLBACK  (was refered to as ExceptionHandler)
"RTN","MAGGSIUI",69,0)
 D SA(3,ITYPE)   ; OBJECT TYPE
"RTN","MAGGSIUI",70,0)
 D SA("CALLMTH",CMTH)     ; CALL METHOD
"RTN","MAGGSIUI",71,0)
 D SA(8,CDUZ)    ; IMAGE SAVE BY
"RTN","MAGGSIUI",72,0)
 ; // It was USERPASS = USERNAME_";"_(encrypted)PASSWORD
"RTN","MAGGSIUI",73,0)
 D SA("USERNAME",USERNAME)
"RTN","MAGGSIUI",74,0)
 D SA("PASSWORD",PASSWORD)
"RTN","MAGGSIUI",75,0)
 D SA(10,GDESC)  ; SHORT DESCRIPTION
"RTN","MAGGSIUI",76,0)
 D SA("DELFLAG",DFLG)    ; DELETE FLAG
"RTN","MAGGSIUI",77,0)
 D SA("TRNSTYP",TRTYPE)  ; TRANSACTION TYPE
"RTN","MAGGSIUI",78,0)
 D SA(100,DOCCTG) ;  document Main category
"RTN","MAGGSIUI",79,0)
 ;D SA("DOCCTG2",DOCCTG2) ;  document Sub category
"RTN","MAGGSIUI",80,0)
 ;D SA("DOCCTG3",DOCCTG3) ;  document Sub Sub category
"RTN","MAGGSIUI",81,0)
 D SA(110,DOCDT)     ;  document date
"RTN","MAGGSIUI",82,0)
 ;
"RTN","MAGGSIUI",83,0)
 D VAL^MAGGSIV(.MAGRY,.MAGA,1)
"RTN","MAGGSIUI",84,0)
 I 'MAGRY(0) D ERRTRK Q
"RTN","MAGGSIUI",85,0)
 D SI("IMAGES",.IMAGES)  ; ARRAY OF IMAGES TO IMPORT
"RTN","MAGGSIUI",86,0)
 I 'MAGRY(0) D ERRTRK Q
"RTN","MAGGSIUI",87,0)
 K MAGRY
"RTN","MAGGSIUI",88,0)
 ;
"RTN","MAGGSIUI",89,0)
 I TRTYPE="NOQUEUE" M MAGRY=MAGA S MAGRY(0)="1^" Q
"RTN","MAGGSIUI",90,0)
 ; Testing without BackGround Processor.
"RTN","MAGGSIUI",91,0)
 ;
"RTN","MAGGSIUI",92,0)
 ; This call is for BP
"RTN","MAGGSIUI",93,0)
 S QTIME=$$NOW^XLFDT
"RTN","MAGGSIUI",94,0)
 S MAGY=$$IMPORT^MAGBAPI(.MAGA,STSCB,TRKID)
"RTN","MAGGSIUI",95,0)
 ; RETURN THE QUEUE NUMBER
"RTN","MAGGSIUI",96,0)
 I 'MAGY S MAGRY(0)="0^Error Setting Queue: "_$P(MAGY,U,2),MAGY=TRKID
"RTN","MAGGSIUI",97,0)
 E  S MAGRY(0)=MAGY_"^Data has been Queued.",MAGY=+MAGY
"RTN","MAGGSIUI",98,0)
 ; for Testing, we'll track input array, and results array by Queue number.
"RTN","MAGGSIUI",99,0)
 I 'MAGRY(0) D ERRTRK Q
"RTN","MAGGSIUI",100,0)
 D LOGRES^MAGGSIU3(.MAGRY,0,APISESS)
"RTN","MAGGSIUI",101,0)
 ;
"RTN","MAGGSIUI",102,0)
 Q
"RTN","MAGGSIUI",103,0)
REQPARAM() ;Check that the required parameters have values.
"RTN","MAGGSIUI",104,0)
 N CT
"RTN","MAGGSIUI",105,0)
 S CT=0
"RTN","MAGGSIUI",106,0)
 S MAGRY(0)="1^Checking for Required parameter values..."
"RTN","MAGGSIUI",107,0)
 I IDFN="" S CT=CT+1,MAGRY(CT)="DFN is Required. !"
"RTN","MAGGSIUI",108,0)
 I '$D(IMAGES),'CMTH S CT=CT+1,MAGRY(CT)="List of Images is Required. !"
"RTN","MAGGSIUI",109,0)
 ;
"RTN","MAGGSIUI",110,0)
 I (PXPKG=""),(DOCCTG="") S CT=CT+1,MAGRY(CT)="Procedure or Document Category is Required. !"
"RTN","MAGGSIUI",111,0)
 I (PXPKG'=""),(DOCCTG'="") S CT=CT+1,MAGRY(CT)="Procedure OR Document Category. Not BOTH. !"
"RTN","MAGGSIUI",112,0)
 ;
"RTN","MAGGSIUI",113,0)
 I (PXPKG'=""),(PXIEN="") S CT=CT+1,MAGRY(CT)="Procedure IEN is Required. !"
"RTN","MAGGSIUI",114,0)
 I (PXPKG'=""),(PXDT="") S CT=CT+1,MAGRY(CT)="Procedure Date is Required. !"
"RTN","MAGGSIUI",115,0)
 ;
"RTN","MAGGSIUI",116,0)
 I TRKID="" S CT=CT+1,MAGRY(CT)="Tracking ID is Required. !"
"RTN","MAGGSIUI",117,0)
 I ACQD="" S CT=CT+1,MAGRY(CT)="Acquisition Device is Required. !"
"RTN","MAGGSIUI",118,0)
 ;   ACQS ( could ? ) default to users institution i.e. DUZ(2)
"RTN","MAGGSIUI",119,0)
 I ACQS="" S CT=CT+1,MAGRY(CT)="Acquisition Site is Required. !"
"RTN","MAGGSIUI",120,0)
 ;
"RTN","MAGGSIUI",121,0)
 I STSCB="" S CT=CT+1,MAGRY(CT)="Status Handler (TAG^ROUTINE) is Required. !"
"RTN","MAGGSIUI",122,0)
 ;
"RTN","MAGGSIUI",123,0)
 I (DOCCTG'=""),(DOCDT="") S CT=CT+1,MAGRY(CT)="Document Date is Required. !"
"RTN","MAGGSIUI",124,0)
 ;
"RTN","MAGGSIUI",125,0)
 I (CT>0) S MAGRY(0)="0^Required parameter is null" Q MAGRY(0)
"RTN","MAGGSIUI",126,0)
 ; More Checks here to stop Duplicate or incorrect Tracking ID's from being Queued
"RTN","MAGGSIUI",127,0)
 ;  //TODO: Need to check the Queue File, to see if this Tracking ID is already Queued.
"RTN","MAGGSIUI",128,0)
 I (TRKID'="") I $D(^MAG(2005,"ATRKID",TRKID)) S MAGRY(0)="0^Tracking ID Must be Unique !"
"RTN","MAGGSIUI",129,0)
 I (TRKID'="") I ($L(TRKID,";")<2) S MAGRY(0)="0^Tracking ID Must have "";"" Delimiter"
"RTN","MAGGSIUI",130,0)
 ;
"RTN","MAGGSIUI",131,0)
 Q MAGRY(0)
"RTN","MAGGSIUI",132,0)
 ;
"RTN","MAGGSIUI",133,0)
SA(FLD,VAL) ;Set the data array with Fld,Value
"RTN","MAGGSIUI",134,0)
 Q:VAL=""
"RTN","MAGGSIUI",135,0)
 S CT=CT+1,MAGA(CT)=FLD_U_VAL
"RTN","MAGGSIUI",136,0)
 Q
"RTN","MAGGSIUI",137,0)
SI(FLD,ARR) ;Set the images into the data array
"RTN","MAGGSIUI",138,0)
 ; Don't New 'CT' it is a global variable.
"RTN","MAGGSIUI",139,0)
 S MAGRY(0)="1^Valid Image file Extensions."
"RTN","MAGGSIUI",140,0)
 N I,MAGEXT,MAGFN
"RTN","MAGGSIUI",141,0)
 S I="" F  S I=$O(ARR(I)) Q:I=""  D  Q:'MAGRY(0)
"RTN","MAGGSIUI",142,0)
 . S CT=CT+1
"RTN","MAGGSIUI",143,0)
 . I '($L($P(ARR(I),U),".")=2) S MAGRY(0)="0^Invalid file name: "_ARR(I) Q
"RTN","MAGGSIUI",144,0)
 . S MAGFN=$P(ARR(I),"^")
"RTN","MAGGSIUI",145,0)
 . S MAGEXT=$$UP^XLFSTR($P(MAGFN,".",2))
"RTN","MAGGSIUI",146,0)
 . I '$D(^MAG(2005.021,"B",MAGEXT)) S MAGRY(0)="0^Unsupported File Type:'."_MAGEXT Q
"RTN","MAGGSIUI",147,0)
 . S MAGA(CT)="IMAGE"_U_ARR(I)
"RTN","MAGGSIUI",148,0)
 Q
"RTN","MAGGSIUI",149,0)
GETARR(ARR,QNUM) ;Get the Input Array from Queue Number
"RTN","MAGGSIUI",150,0)
 I '$G(QNUM) S ARR(0)="0^INVALID QUEUE Number: "_$G(QNUM) Q
"RTN","MAGGSIUI",151,0)
 ;
"RTN","MAGGSIUI",152,0)
 D IMPAR^MAGQBUT2(.ARR,QNUM)
"RTN","MAGGSIUI",153,0)
 Q
"RTN","MAGGSIUI",154,0)
STATUSCB(MAGRY,STAT,TAGRTN) ;The BP calls this RPC to send status back to the calling package.
"RTN","MAGGSIUI",155,0)
 ; //TODO; The Import Component (and OCX) will call this RPC 
"RTN","MAGGSIUI",156,0)
 ;
"RTN","MAGGSIUI",157,0)
 ; STAT(0)= "0^message" or "1^message"
"RTN","MAGGSIUI",158,0)
 ; STAT(1)=TRKID,
"RTN","MAGGSIUI",159,0)
 ;        (2)=QNUM
"RTN","MAGGSIUI",160,0)
 ;        (3..N)=warnings
"RTN","MAGGSIUI",161,0)
 ;
"RTN","MAGGSIUI",162,0)
 N APISESS,TRKID
"RTN","MAGGSIUI",163,0)
 D @(TAGRTN_"(.STAT)")
"RTN","MAGGSIUI",164,0)
 S MAGRY="1^Status Callback was called"
"RTN","MAGGSIUI",165,0)
 S TRKID=$G(STAT(1))
"RTN","MAGGSIUI",166,0)
 ; Log Results
"RTN","MAGGSIUI",167,0)
 I $L(TRKID) D
"RTN","MAGGSIUI",168,0)
 . S APISESS=$O(^MAG(2006.82,"E",TRKID,""))
"RTN","MAGGSIUI",169,0)
 . I APISESS D LOGRES^MAGGSIU3(.STAT,0,APISESS)
"RTN","MAGGSIUI",170,0)
 Q
"RTN","MAGGSIUI",171,0)
TESTCB(STATARR) ;TESTING.  This was used as the status callback for testing.
"RTN","MAGGSIUI",172,0)
 ;I +STATARR(2) S ^MAGTMP("MAGAPI",+STATARR(2),"StatHndl")="Test: Status Handler has been called."
"RTN","MAGGSIUI",173,0)
 Q
"RTN","MAGGSIUI",174,0)
ERRTRK ;Track bad data and Quit
"RTN","MAGGSIUI",175,0)
 N I
"RTN","MAGGSIUI",176,0)
 D LOGERR^MAGGSERR("---- New Error ----",APISESS)
"RTN","MAGGSIUI",177,0)
 S I="" F  S I=$O(MAGRY(I)) Q:I=""  D LOGERR^MAGGSERR(MAGRY(I),APISESS)
"RTN","MAGGSIUI",178,0)
 Q
"RTN","MAGGSIUI",179,0)
DATATRK ; Track the raw data being sent to the Import API.
"RTN","MAGGSIUI",180,0)
 ; This is called to log the data being imported.  
"RTN","MAGGSIUI",181,0)
 ; Later the Results (or error messages) will be logged
"RTN","MAGGSIUI",182,0)
 N XY
"RTN","MAGGSIUI",183,0)
 S APISESS=$$LOG^MAGGSIU3(.XY,.MAGIX,.IMAGES,IDFN,ACQD,TRKID)
"RTN","MAGGSIUI",184,0)
 Q
"RTN","MAGGSIUI",185,0)
ERR ; ERROR TRAP FOR Import API
"RTN","MAGGSIUI",186,0)
 N ERR S ERR=$$EC^%ZOSV
"RTN","MAGGSIUI",187,0)
 S MAGRY(0)="0^ETRAP: "_ERR
"RTN","MAGGSIUI",188,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGSIUI",189,0)
 I $G(APISESS) D ERRTRK
"RTN","MAGGSIUI",190,0)
 Q
"RTN","MAGGSIV")
0^12^B33859529
"RTN","MAGGSIV",1,0)
MAGGSIV ;WOIFO/GEK - Imaging RPC Broker calls. Validate Image data array ; [ 12/27/2000 10:49 ]
"RTN","MAGGSIV",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSIV",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIV",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSIV",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSIV",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSIV",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSIV",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSIV",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSIV",10,0)
 ;; |                                                               |
"RTN","MAGGSIV",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSIV",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSIV",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSIV",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSIV",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSIV",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSIV",17,0)
 ;;
"RTN","MAGGSIV",18,0)
 Q
"RTN","MAGGSIV",19,0)
 ;
"RTN","MAGGSIV",20,0)
 ; 
"RTN","MAGGSIV",21,0)
VAL(MAGRY,MAGARRAY,ALL) ; RPC Call to Validate the Image Data Array before a 
"RTN","MAGGSIV",22,0)
 ; new image/modified entry is attempted.  
"RTN","MAGGSIV",23,0)
 ; Called from MAGGSIA, MAGGSIUI and Capture GUI.
"RTN","MAGGSIV",24,0)
 ;
"RTN","MAGGSIV",25,0)
 ;  Parameters : 
"RTN","MAGGSIV",26,0)
 ;    MAGARRAY - array of 'Field numbers'/'Action codes'  and their Values 
"RTN","MAGGSIV",27,0)
 ;                     MAGARRAY(1)="5^38"  Field#:  5   Value: 38
"RTN","MAGGSIV",28,0)
 ;         an example of an action code is the Code for File Extension    
"RTN","MAGGSIV",29,0)
 ;                     MAGARRAY(2)="EXT^JPG"  Action: EXT Value: JPG
"RTN","MAGGSIV",30,0)
 ;                        
"RTN","MAGGSIV",31,0)
 ;    ALL - "1" = Validate ALL fields, returning an array of error messages.
"RTN","MAGGSIV",32,0)
 ;          "0" = Stop validating if an error occurs, return
"RTN","MAGGSIV",33,0)
 ;                           the error message in (0) node.
"RTN","MAGGSIV",34,0)
 ;  Return Variable
"RTN","MAGGSIV",35,0)
 ;    MAGRY() - Array
"RTN","MAGGSIV",36,0)
 ;      Successful   MAGRY(0) = 1^Image Data is Valid.
"RTN","MAGGSIV",37,0)
 ;      UNsuccessful MAGRY(0) = 0^Error desc
"RTN","MAGGSIV",38,0)
 ;                   IF ALL then MAGRY(1..N) =0^Error desc of all errors
"RTN","MAGGSIV",39,0)
 ;
"RTN","MAGGSIV",40,0)
 ;----------------------------------------------------------------
"RTN","MAGGSIV",41,0)
 N MAGGFLD,MAGGDAT,MAGFSPEC
"RTN","MAGGSIV",42,0)
 N Y,AITEM,CT,MAGERR,DFNFLAG
"RTN","MAGGSIV",43,0)
 ;N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGGSERR"
"RTN","MAGGSIV",44,0)
 ;
"RTN","MAGGSIV",45,0)
 S ALL=$G(ALL)
"RTN","MAGGSIV",46,0)
 S MAGRY(0)="0^Validating the Data Array..."
"RTN","MAGGSIV",47,0)
 S MAGERR="",DFNFLAG=0,CT=0
"RTN","MAGGSIV",48,0)
 ;
"RTN","MAGGSIV",49,0)
 ;  Do we have any data ? 
"RTN","MAGGSIV",50,0)
 I ($D(MAGARRAY)<10) S MAGRY(0)="0^No input data, Operation CANCELED" Q
"RTN","MAGGSIV",51,0)
 ;  Loop through Input Array 
"RTN","MAGGSIV",52,0)
 S AITEM="" F  S AITEM=$O(MAGARRAY(AITEM)) Q:AITEM=""  D  I $L(MAGERR) Q:'ALL  S CT=CT+1,MAGRY(CT)=MAGERR,MAGERR=""
"RTN","MAGGSIV",53,0)
 . S MAGERR=""
"RTN","MAGGSIV",54,0)
 . S MAGGFLD=$P(MAGARRAY(AITEM),U,1),MAGGDAT=$P(MAGARRAY(AITEM),U,2,99)
"RTN","MAGGSIV",55,0)
 . ;
"RTN","MAGGSIV",56,0)
 . I MAGGFLD="" S MAGERR="0^A Field Number/Action Code is required: "_" Item: "_MAGARRAY(AITEM) Q
"RTN","MAGGSIV",57,0)
 . I MAGGDAT="" S MAGERR="0^A Value is required."_" Item: "_MAGARRAY(AITEM) Q
"RTN","MAGGSIV",58,0)
 . I MAGGFLD=5 S DFNFLAG=1
"RTN","MAGGSIV",59,0)
 . ; Check for possible action codes that could be in the array.
"RTN","MAGGSIV",60,0)
 . I $$ACTCODE(MAGGFLD) D  Q
"RTN","MAGGSIV",61,0)
 . . S Y=$$VALCODE(MAGARRAY(AITEM)) S:'Y MAGERR=Y_" Item: "_MAGARRAY(AITEM)
"RTN","MAGGSIV",62,0)
 . ;
"RTN","MAGGSIV",63,0)
 . ; If we are adding Multiple Images to a Group, they must be Validated.
"RTN","MAGGSIV",64,0)
 . ;   we could have multiple "2005.04^IENs" in this array. Which means we are 
"RTN","MAGGSIV",65,0)
 . ;   adding existing Images to a New/Existing Group.
"RTN","MAGGSIV",66,0)
 . I MAGGFLD=2005.04 D  Q  ; 2005.04 isn't the field number, #4 is the field number
"RTN","MAGGSIV",67,0)
 . . I $G(MAGGDAT,0)=0 Q  ;Creating a new Group, with no group entries is the usual way
"RTN","MAGGSIV",68,0)
 . . ; to do it.  Then make successive calls to ADD, Adding each Image to the 
"RTN","MAGGSIV",69,0)
 . . ; Object Group multiple of the Group Parent (fld#14) as it is created.
"RTN","MAGGSIV",70,0)
 . . I '$D(^MAG(2005,MAGGDAT,0)) S MAGERR="0^Group Object "_MAGGDAT_" doesn't exist"_" Item: "_MAGARRAY(AITEM)
"RTN","MAGGSIV",71,0)
 . . ;  We can't allow adding an image if it already has a group parent.
"RTN","MAGGSIV",72,0)
 . . I $P(^MAG(2005,MAGGDAT,0),U,10) S MAGERR="0^The Image to be added to the Group, already has a Group Parent"_" Item: "_MAGARRAY(AITEM)
"RTN","MAGGSIV",73,0)
 . ;
"RTN","MAGGSIV",74,0)
 . ; if we are getting a WP line of text for Long Desc Field.  Can't validate it.
"RTN","MAGGSIV",75,0)
 . I MAGGFLD=11 Q  ; this is a line of the WP Long Desc field.
"RTN","MAGGSIV",76,0)
 . ;
"RTN","MAGGSIV",77,0)
 . ;if a BAD field number
"RTN","MAGGSIV",78,0)
 . I '$$VFIELD^DILFD(2005,MAGGFLD) S MAGERR="0^Field Number "_MAGGFLD_" doesn't exist"_" Item: "_MAGARRAY(AITEM) Q
"RTN","MAGGSIV",79,0)
 . ;
"RTN","MAGGSIV",80,0)
 . ; Get Field Specifiers
"RTN","MAGGSIV",81,0)
 . D FIELD^DID(2005,MAGGFLD,"","LABEL;SPECIFIER","MAGFSPEC")
"RTN","MAGGSIV",82,0)
 . ; 
"RTN","MAGGSIV",83,0)
 . I (MAGFSPEC("SPECIFIER")["D") D  Q:$L(MAGERR)
"RTN","MAGGSIV",84,0)
 . . S %DT="T",X=MAGGDAT D ^%DT
"RTN","MAGGSIV",85,0)
 . . I Y=-1 S MAGERR="0^Invalid Date: "_MAGGDAT_" Item: "_MAGARRAY(AITEM) Q
"RTN","MAGGSIV",86,0)
 . . S MAGGDAT=Y
"RTN","MAGGSIV",87,0)
 . . S MAGARRAY(AITEM)=MAGGFLD_"^"_MAGGDAT
"RTN","MAGGSIV",88,0)
 . ;  Usually for Pointer fields, we're getting the Internal value. So
"RTN","MAGGSIV",89,0)
 . ;  We'll test for that here, and if success, we quit.
"RTN","MAGGSIV",90,0)
 . ;  If not success, then maybe it's the external value being passed in,
"RTN","MAGGSIV",91,0)
 . ;  so we continue, letting it get validated again.
"RTN","MAGGSIV",92,0)
 . I (MAGFSPEC("SPECIFIER")["P"),'($$EXTERNAL^DILFD(2005,MAGGFLD,"",MAGGDAT)="") Q
"RTN","MAGGSIV",93,0)
 . ;
"RTN","MAGGSIV",94,0)
 . ; Validate all fields here.  
"RTN","MAGGSIV",95,0)
 . D VAL^DIE(2005,"",MAGGFLD,"",MAGGDAT,.MAGRET,"","MAGETXT") I MAGRET="^" D  Q
"RTN","MAGGSIV",96,0)
 . . S MAGERR="0^"_MAGETXT("DIERR",1,"TEXT",1)_" Item: "_MAGARRAY(AITEM)
"RTN","MAGGSIV",97,0)
 ;
"RTN","MAGGSIV",98,0)
 ; if there was an Error in data we'll quit now.
"RTN","MAGGSIV",99,0)
 ; If ALL is true, then MAGRY(1...N) will exist if there were errors.
"RTN","MAGGSIV",100,0)
 I $O(MAGRY(0)) S MAGRY(0)="0^Errors were found in data." Q
"RTN","MAGGSIV",101,0)
 ; If ALL is false, then MAGERR will exist if there was an error.
"RTN","MAGGSIV",102,0)
 I $L(MAGERR) S MAGRY(0)=MAGERR Q
"RTN","MAGGSIV",103,0)
 ;
"RTN","MAGGSIV",104,0)
 ;  If all data is valid we get here.
"RTN","MAGGSIV",105,0)
 ;  Last Test, see if a Patient was in array, 
"RTN","MAGGSIV",106,0)
 ;  (Patient is the only Required field check done in this routine).
"RTN","MAGGSIV",107,0)
 I 'DFNFLAG S MAGRY(0)="0^A Patient DFN is required. " Q
"RTN","MAGGSIV",108,0)
 S MAGRY(0)="1^Data is Valid."
"RTN","MAGGSIV",109,0)
 Q
"RTN","MAGGSIV",110,0)
ACTCODE(CODE) ;
"RTN","MAGGSIV",111,0)
 ;I '$T(FLD) Q 0
"RTN","MAGGSIV",112,0)
 I ",IEN,EXT,ABS,JB,WRITE,BIG,DICOMSN,DICOMIN,ACQD,ACQS,STATUSCB,CALLMTH,USERNAME,PASSWORD,DELFLAG,TRNSTYP,"[(","_CODE_",") Q 1
"RTN","MAGGSIV",113,0)
 Q 0
"RTN","MAGGSIV",114,0)
VALCODE(X) ; We validate the values for the possible action codes
"RTN","MAGGSIV",115,0)
 N MAGY,CODE,VALUE
"RTN","MAGGSIV",116,0)
 S CODE=$P(X,U),VALUE=$P(X,U,2,99)
"RTN","MAGGSIV",117,0)
 I VALUE="" Q "0^NO VALUE in Action Code string: """_X_""
"RTN","MAGGSIV",118,0)
 I ",ACQD,ACQS,CALLMTH,USERNAME,PASSWORD,"[(","_CODE_",") Q 1 ; NO VALIDATION FOR THESE CODES
"RTN","MAGGSIV",119,0)
 D @CODE
"RTN","MAGGSIV",120,0)
 Q MAGY
"RTN","MAGGSIV",121,0)
 ;  Each Tag is a valid Action code
"RTN","MAGGSIV",122,0)
IEN I $D(^MAG(2005,VALUE)) S MAGY=1
"RTN","MAGGSIV",123,0)
 E  S MAGY="0^INVALID IMAGE IEN."
"RTN","MAGGSIV",124,0)
 Q
"RTN","MAGGSIV",125,0)
EXT ; code will go here to validate the extension type.  i.e. we won't let types .exe .bat .com .zip ... etc.
"RTN","MAGGSIV",126,0)
 ;  Maybe a modification to Object Type file, to have allowable extensions in the file, and a 
"RTN","MAGGSIV",127,0)
 ;  cross reference on a new field EXTENSION.  The capture workstation wouldn't have to ask the 
"RTN","MAGGSIV",128,0)
 ; user for the file type of each file, and we wouldn't get WORD .DOC files that the user called Color Images
"RTN","MAGGSIV",129,0)
ABS ; Meaning: Have the BP create the abstract
"RTN","MAGGSIV",130,0)
JB ; Meaning: Have the BP copy the image to the JukeBox
"RTN","MAGGSIV",131,0)
BIG ; Meaning: There is a big file also, set the Image File field ? to indicate there is a BIG File.
"RTN","MAGGSIV",132,0)
 S MAGY=1
"RTN","MAGGSIV",133,0)
 Q
"RTN","MAGGSIV",134,0)
WRITE ; Meaning: This is the Internal Entry (or "PACS") of the WRITE Directory. Images will be written
"RTN","MAGGSIV",135,0)
 ; here instead of the default WRITE Directory.
"RTN","MAGGSIV",136,0)
 S MAGY=$$DRIVE^MAGGSIU1(VALUE)
"RTN","MAGGSIV",137,0)
 Q
"RTN","MAGGSIV",138,0)
DICOMSN ;Meaning: DICOM Series Number.  This will be entered in the Group Object multiple, field #1
"RTN","MAGGSIV",139,0)
 ;I +$P(X,U,2) S MAGY=1
"RTN","MAGGSIV",140,0)
 ;E  S MAGY="0^INVALID DICOM Series number: "_X
"RTN","MAGGSIV",141,0)
 S MAGY=1
"RTN","MAGGSIV",142,0)
 Q
"RTN","MAGGSIV",143,0)
DICOMIN ;Meaning: DICOM Image Number.  This will be entered in the Group Object multiple, field #2
"RTN","MAGGSIV",144,0)
 ;I +$P(X,U,2) S MAGY=1
"RTN","MAGGSIV",145,0)
 ;E  S MAGY="0^INVALID DICOM Series number: "_X
"RTN","MAGGSIV",146,0)
 S MAGY=1
"RTN","MAGGSIV",147,0)
 Q
"RTN","MAGGSIV",148,0)
DELFLAG ;Meaning: This flag tells the Delphi Import Component to Delete the Image files after successful processing
"RTN","MAGGSIV",149,0)
 S MAGY=1
"RTN","MAGGSIV",150,0)
 Q
"RTN","MAGGSIV",151,0)
TRNSTYP ;Meaning: This flag is for future use, for now it is ignored, defaults to "NEW"
"RTN","MAGGSIV",152,0)
 S MAGY=1
"RTN","MAGGSIV",153,0)
 Q
"RTN","MAGGSIV",154,0)
STATUSCB ; Meaning: This is the TAG^RTN that Imaging calls to report the 
"RTN","MAGGSIV",155,0)
 ; status of the Import.
"RTN","MAGGSIV",156,0)
 I '$L($T(@VALUE)) S MAGY="0^Invalid Status CallBack "_VALUE
"RTN","MAGGSIV",157,0)
 E  S MAGY=1
"RTN","MAGGSIV",158,0)
 Q
"RTN","MAGGSPP")
0^13^B5001322
"RTN","MAGGSPP",1,0)
MAGGSPP ;WOIFO/GEK - Utilities for Post Processing of a new Image Entry  ; 01 Nov 2001 1:30 PM
"RTN","MAGGSPP",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSPP",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSPP",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSPP",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSPP",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSPP",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSPP",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSPP",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSPP",10,0)
 ;; |                                                               |
"RTN","MAGGSPP",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSPP",12,0)
 ;; | a medical device.  As such, it may not be changed             |
"RTN","MAGGSPP",13,0)
 ;; | in any way.  Modifications to this software may result in an  |
"RTN","MAGGSPP",14,0)
 ;; | adulterated medical device under 21CFR820, the use of which   |
"RTN","MAGGSPP",15,0)
 ;; | is considered to be a violation of US Federal Statutes.       |
"RTN","MAGGSPP",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSPP",17,0)
 ;;
"RTN","MAGGSPP",18,0)
 Q
"RTN","MAGGSPP",19,0)
ACTION(MAGRY,MAGIEN) ; Post processing when Image is sucessfully created in Image
"RTN","MAGGSPP",20,0)
 ; file and copied to Network.
"RTN","MAGGSPP",21,0)
 ;       MAGRY : is the Return Array
"RTN","MAGGSPP",22,0)
 ;       MAGRY(0)  = 1^SUCCESS
"RTN","MAGGSPP",23,0)
 ;                OR 0^ERROR MESSAGE
"RTN","MAGGSPP",24,0)
 ;       MAGIEN : is the Internal Entry Number in the Image File.
"RTN","MAGGSPP",25,0)
 ;
"RTN","MAGGSPP",26,0)
 ;  This call is Post Processing depending on the Type of MAG DESCRIPTIVE CATEGORY
"RTN","MAGGSPP",27,0)
 ;
"RTN","MAGGSPP",28,0)
 ; Does the Image Point to a MagDescriptive Category.
"RTN","MAGGSPP",29,0)
 ;  
"RTN","MAGGSPP",30,0)
 S ^MAGTMP("ACT-PP",MAGIEN,0)=$$NOW^XLFDT
"RTN","MAGGSPP",31,0)
 I '+$G(^MAG(2005,MAGIEN,100)) S MAGRY(0)="1^No Post Processing required." Q
"RTN","MAGGSPP",32,0)
 N MAGCTG S MAGCTG=+^MAG(2005,MAGIEN,100)
"RTN","MAGGSPP",33,0)
 I '+$G(^MAG(2005.81,MAGCTG,1)) S MAGRY(0)="1^No Post Processing required." Q
"RTN","MAGGSPP",34,0)
 ; SO here we know an action is in play for this Image Category
"RTN","MAGGSPP",35,0)
 N MAGACT
"RTN","MAGGSPP",36,0)
 S MAGACT=$P(^MAG(2005.81,MAGCTG,1),U,3,4)
"RTN","MAGGSPP",37,0)
 ;        D @(TAGRTN_"(.STAT)")
"RTN","MAGGSPP",38,0)
 D @(MAGACT_"(.MAGRY,"_MAGIEN_")")
"RTN","MAGGSPP",39,0)
 ;;
"RTN","MAGGSPP",40,0)
 Q
"RTN","MAGGSPP",41,0)
HEC(MAGRY,MAGIEN) ;  QUEING OF HEC IMAGES
"RTN","MAGGSPP",42,0)
 S MAGRY(0)=$$GCC^MAGBAPI(MAGIEN)
"RTN","MAGGSPP",43,0)
 S ^MAGTMP("ACT-PP",MAGIEN,"HEC")=MAGRY(0)
"RTN","MAGGSPP",44,0)
 S MAGRY(1)=MAGIEN_" "_$$NOW^XLFDT
"RTN","MAGGSPP",45,0)
 Q
"RTN","MAGGSTI")
0^14^B17446345
"RTN","MAGGSTI",1,0)
MAGGSTI ;WOIFO/GEK - Imaging interface to TIU RPC Calls etc. ; 01 Nov 2001 12:32 PM 
"RTN","MAGGSTI",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSTI",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSTI",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSTI",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSTI",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSTI",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSTI",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSTI",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSTI",10,0)
 ;; |                                                               |
"RTN","MAGGSTI",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSTI",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSTI",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSTI",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSTI",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSTI",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSTI",17,0)
 ;;
"RTN","MAGGSTI",18,0)
 Q
"RTN","MAGGSTI",19,0)
LISTC(ATMP,PROC,MAGDFN,BDT,EDT,NUM,DETAILS) ;Get Short list of TIU notes 
"RTN","MAGGSTI",20,0)
 ; given a CLASS in PROC parameter
"RTN","MAGGSTI",21,0)
 ; The compressed listing, 4 columns  "Date^Spec^Desc^Img Count^procedure info"
"RTN","MAGGSTI",22,0)
 N MAGX,I,ACT,NODE,TMP
"RTN","MAGGSTI",23,0)
 D CONTEXT^TIUSRVLO(.MAGX,PROC,1,MAGDFN)
"RTN","MAGGSTI",24,0)
 I '$D(@MAGX) Q
"RTN","MAGGSTI",25,0)
 S ACT=+$O(@ATMP@(""),-1)
"RTN","MAGGSTI",26,0)
 S I="" F  S I=$O(@MAGX@(I)) Q:I=""  D
"RTN","MAGGSTI",27,0)
 . ;
"RTN","MAGGSTI",28,0)
 . S X=$S(DETAILS:$$DETINF(@MAGX@(I)),1:$$CMPINF(@MAGX@(I)))
"RTN","MAGGSTI",29,0)
 . S ACT=ACT+1
"RTN","MAGGSTI",30,0)
 . S @ATMP@(ACT)=X
"RTN","MAGGSTI",31,0)
 I DETAILS S @ATMP@(1)="Date^Title^Images^Author^Status^Visit" ;^|TIUDA^
"RTN","MAGGSTI",32,0)
 Q
"RTN","MAGGSTI",33,0)
CMPINF(NODE) ;
"RTN","MAGGSTI",34,0)
 N RY
"RTN","MAGGSTI",35,0)
 S RY=$$EXTDT^MAGGSU1($P(NODE,U,3))_U_"TIU"_U_$P(NODE,U,2)_U
"RTN","MAGGSTI",36,0)
 S RY=RY_$$IMGCT($P(NODE,U))_U_$P($P(NODE,U,5),";",2)_U
"RTN","MAGGSTI",37,0)
 S RY=RY_"|TIU^"_$P(NODE,U)
"RTN","MAGGSTI",38,0)
 Q RY
"RTN","MAGGSTI",39,0)
 ;
"RTN","MAGGSTI",40,0)
DETINF(NODE) ;
"RTN","MAGGSTI",41,0)
 ; The node info from TIUSRVLO is
"RTN","MAGGSTI",42,0)
 ;   TIUDA    Desc        date          patient              duz;author          status
"RTN","MAGGSTI",43,0)
 ;  x)=2452^General Note^2910528.1533^HOOD, ROBIN  (H2591)^10;MELANIE BUECHLER
"RTN","MAGGSTI",44,0)
 ;     service      status   visit info       ?      ? ?
"RTN","MAGGSTI",45,0)
 ;    ^CARDIOLOGY^completed^Visit: 05/28/91^        ^^0^
"RTN","MAGGSTI",46,0)
 N RY
"RTN","MAGGSTI",47,0)
 ;  DATE^DESC^IMGCT^AUTHOR^STATUS^VISIT^|"TIU^"TIUDA^
"RTN","MAGGSTI",48,0)
 S RY=$$EXTDT^MAGGSU1($P(NODE,U,3))_U_$P(NODE,U,2)_U_$$IMGCT($P(NODE,U))_U
"RTN","MAGGSTI",49,0)
 S RY=RY_$P($P(NODE,U,5),";",2)_U_$P(NODE,U,7)_U_$P(NODE,U,8)
"RTN","MAGGSTI",50,0)
 S RY=RY_U_"|TIU"_U_$P(NODE,U)_U
"RTN","MAGGSTI",51,0)
 Q RY
"RTN","MAGGSTI",52,0)
IMGCT(TIUDA) ;  Get count of images for this TIU Document
"RTN","MAGGSTI",53,0)
 ;  If more than one group (or image) is pointing to this Document
"RTN","MAGGSTI",54,0)
 ;    then return "Group count : total images"  i.e.   "3:134"
"RTN","MAGGSTI",55,0)
 ; 
"RTN","MAGGSTI",56,0)
 N MAGARR,MAGIEN,CT,GCT,ICT,I
"RTN","MAGGSTI",57,0)
 S I="",CT=0,GCT=0
"RTN","MAGGSTI",58,0)
 D GETILST^TIUSRVPL(.MAGARR,TIUDA)
"RTN","MAGGSTI",59,0)
 F  S I=$O(MAGARR(I)) Q:'I  D
"RTN","MAGGSTI",60,0)
 . S ICT=+$P($G(^MAG(2005,MAGARR(I),1,0)),U,4)
"RTN","MAGGSTI",61,0)
 . S ICT=$S(ICT:ICT,1:1) ;If no group images, set count =1 (single image)
"RTN","MAGGSTI",62,0)
 . S GCT=GCT+1
"RTN","MAGGSTI",63,0)
 . S CT=CT+ICT
"RTN","MAGGSTI",64,0)
 I (GCT>1) Q GCT_":"_CT
"RTN","MAGGSTI",65,0)
 Q CT
"RTN","MAGGSTI",66,0)
FILE(MAGRY,MAGDA,TIUDA) ; RPC Call to file TIU and Imaging Pointers
"RTN","MAGGSTI",67,0)
 ; TIU API to add image to TIU
"RTN","MAGGSTI",68,0)
 ; TODO; have to validate that the Imaging patient matches the TIU patient.
"RTN","MAGGSTI",69,0)
 D PUTIMAGE^TIUSRVPL(.MAGRY,TIUDA,MAGDA) ;
"RTN","MAGGSTI",70,0)
 I 'MAGRY Q
"RTN","MAGGSTI",71,0)
 ; Now SET the Parent fields in the Image File
"RTN","MAGGSTI",72,0)
 S $P(^MAG(2005,MAGDA,2),U,6,8)=8925_U_TIUDA_U_+MAGRY
"RTN","MAGGSTI",73,0)
 ; DONE.
"RTN","MAGGSTI",74,0)
 S MAGRY="1^Image pointer filed successfully"
"RTN","MAGGSTI",75,0)
 Q
"RTN","MAGGSTI",76,0)
DATA(MAGRY,TIUDA) ;RPC Call to get TIU data from the TIUDA
"RTN","MAGGSTI",77,0)
 ; Return =     TIUDA^Document Type ^Document Date^DFN
"RTN","MAGGSTI",78,0)
 ; returning DFN is new, We'll need IA for it ;TODO
"RTN","MAGGSTI",79,0)
 ;
"RTN","MAGGSTI",80,0)
 S MAGRY=TIUDA_U_$$GET1^DIQ(8925,TIUDA,".01","E")_U_$$GET1^DIQ(8925,TIUDA,"1201","I")_U_$$GET1^DIQ(8925,TIUDA,".02","I")
"RTN","MAGGSTI",81,0)
 ;
"RTN","MAGGSTI",82,0)
 Q
"RTN","MAGGSTI",83,0)
IMAGES(MAGRY,TIUDA) ;RPC Call to get all images for a given TIU DA
"RTN","MAGGSTI",84,0)
 ; We first get all Image IEN's breaking groups into seperate images
"RTN","MAGGSTI",85,0)
 ; Then get Image Info for each one.
"RTN","MAGGSTI",86,0)
 ; MAGRY    -     Return array of Image Data entries
"RTN","MAGGSTI",87,0)
 ; MAGRY(0)    is   1 ^ message  if successful
"RTN","MAGGSTI",88,0)
 ;                  0 ^ Error message if error;
"RTN","MAGGSTI",89,0)
 ; TIUDA  is IEN in ^TIU(8925
"RTN","MAGGSTI",90,0)
 ;
"RTN","MAGGSTI",91,0)
 ; Call TIU API to get list of Image IEN's
"RTN","MAGGSTI",92,0)
 N MAGARR,CT K ^TMP("MAGGX",$J)
"RTN","MAGGSTI",93,0)
 N MAGZZ
"RTN","MAGGSTI",94,0)
 D GETILST^TIUSRVPL(.MAGARR,TIUDA)
"RTN","MAGGSTI",95,0)
 S CT=0
"RTN","MAGGSTI",96,0)
 K ^TMP("MAGGX",$J)
"RTN","MAGGSTI",97,0)
 ; Now get all images for all groups and single images.
"RTN","MAGGSTI",98,0)
 S I="" F  S I=$O(MAGARR(I)) Q:'I  S DA=MAGARR(I) D
"RTN","MAGGSTI",99,0)
 . I $O(^MAG(2005,DA,1,0)) D  Q
"RTN","MAGGSTI",100,0)
 . . S J=0 F  S J=$O(^MAG(2005,DA,1,J)) Q:'J  S CT=CT+1,^TMP("MAGGX",$J,CT)=^(J,0)
"RTN","MAGGSTI",101,0)
 . S CT=CT+1
"RTN","MAGGSTI",102,0)
 . S ^TMP("MAGGX",$J,CT)=DA
"RTN","MAGGSTI",103,0)
 ; Now get image info for each image
"RTN","MAGGSTI",104,0)
 ;
"RTN","MAGGSTI",105,0)
 S CT=0,Z=""
"RTN","MAGGSTI",106,0)
 S MAGQUIET=1
"RTN","MAGGSTI",107,0)
 F  S Z=$O(^TMP("MAGGX",$J,Z)) Q:Z=""  D
"RTN","MAGGSTI",108,0)
 . S CT=CT+1,MAGXX=^TMP("MAGGX",$J,Z)
"RTN","MAGGSTI",109,0)
 . ;GEK 8/24/00 Stoping the Invalid Image IEN's and Deleted Images
"RTN","MAGGSTI",110,0)
 . I '$D(^MAG(2005,MAGXX)) D  Q
"RTN","MAGGSTI",111,0)
 . . D INVALID^MAGGTIG(MAGXX,.MSGX) S MAGRY(CT)=MSGX
"RTN","MAGGSTI",112,0)
 . D BOTH^MAGFILEB
"RTN","MAGGSTI",113,0)
 . S MAGRY(CT)="B2^"_MAGFILE
"RTN","MAGGSTI",114,0)
 K MAGQUIET
"RTN","MAGGSTI",115,0)
 S MAGRY(0)=CT_"^"_CT_" Images for the selected TIU NOTE"
"RTN","MAGGSTI",116,0)
 ; PUT THE Image IEN of the last image into the group ien field.
"RTN","MAGGSTI",117,0)
 Q:'CT
"RTN","MAGGSTI",118,0)
 S $P(MAGRY(0),U,3)=TIUDA
"RTN","MAGGSTI",119,0)
 D DATA(.MAGZZ,TIUDA)
"RTN","MAGGSTI",120,0)
 S $P(MAGRY(0),U,4)=$$GET1^DIQ(8925,TIUDA,".02","E")_"  "_$P(MAGZZ,U,2)_"  "_$$FMTE^XLFDT($P(MAGZZ,U,3),"8")
"RTN","MAGGSTI",121,0)
 ;
"RTN","MAGGSTI",122,0)
 S $P(MAGRY(0),U,5)=$S($P($G(MAGFILE),U):$P(MAGFILE,U),1:MAGXX)
"RTN","MAGGSTI",123,0)
 Q
"RTN","MAGGSTI",124,0)
 ;
"RTN","MAGGSU1")
0^15^B4282833
"RTN","MAGGSU1",1,0)
MAGGSU1 ;WOIFO/GEK - Utilities for Imaging  ; 01 Nov 2001 12:32 PM 
"RTN","MAGGSU1",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGSU1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSU1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGSU1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGSU1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGSU1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGSU1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGSU1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGSU1",10,0)
 ;; |                                                               |
"RTN","MAGGSU1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGSU1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGSU1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGSU1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGSU1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGSU1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGSU1",17,0)
 ;;
"RTN","MAGGSU1",18,0)
 Q
"RTN","MAGGSU1",19,0)
IMGDTTM(X,EXT,INT) ; We call here from anywhere in Imaging, to get 
"RTN","MAGGSU1",20,0)
 ; Internal and External dates/times.  That way all imaging windows will 
"RTN","MAGGSU1",21,0)
 ; have same date format.
"RTN","MAGGSU1",22,0)
 ;X IS THE INPUT.   Internal or External or Partial
"RTN","MAGGSU1",23,0)
 ;EXT is the external form of the date.  Passed by reference
"RTN","MAGGSU1",24,0)
 ;INT is the internal form of the date.  Passed by reference
"RTN","MAGGSU1",25,0)
 ;Return is 1^
"RTN","MAGGSU1",26,0)
 ;       or 0^error message (invalid format)
"RTN","MAGGSU1",27,0)
 ; EXTERNAL FORMAT RETURNED BY THIS CALL IS   
"RTN","MAGGSU1",28,0)
 ;       MM/DD/YYYY   i.e.   01/01/2000
"RTN","MAGGSU1",29,0)
 N MAGY,Y
"RTN","MAGGSU1",30,0)
 D DT^DILF("TE",X,.MAGY)
"RTN","MAGGSU1",31,0)
 I $G(MAGY,-1)=-1 Q ""
"RTN","MAGGSU1",32,0)
 ; Standard external returned by DT^DILF is  Jan 01, 2000
"RTN","MAGGSU1",33,0)
 ; If we wanted that as imaging format, we could stop here
"RTN","MAGGSU1",34,0)
 ; and Return MAGY(0) as External
"RTN","MAGGSU1",35,0)
 S INT=MAGY
"RTN","MAGGSU1",36,0)
 S EXT=$$FMTE^XLFDT(MAGY,"5Z")
"RTN","MAGGSU1",37,0)
 Q 1
"RTN","MAGGSU1",38,0)
IMGDT(X,EXT,INT) ;Return just the date, no time
"RTN","MAGGSU1",39,0)
 N Y
"RTN","MAGGSU1",40,0)
 S Y=$$IMGDTTM(X,.EXT,.INT)
"RTN","MAGGSU1",41,0)
 S EXT=$P(EXT,"@")
"RTN","MAGGSU1",42,0)
 Q Y
"RTN","MAGGSU1",43,0)
EXTDT(X) ;
"RTN","MAGGSU1",44,0)
 N Y,EXT
"RTN","MAGGSU1",45,0)
 S Y=$$IMGDTTM(X,.EXT) I 'Y Q Y
"RTN","MAGGSU1",46,0)
 Q $P(EXT,"@")
"RTN","MAGGSU1",47,0)
EXTDTTM(X) ;
"RTN","MAGGSU1",48,0)
 N Y,EXT
"RTN","MAGGSU1",49,0)
 S Y=$$IMGDTTM(X,.EXT) I 'Y Q Y
"RTN","MAGGSU1",50,0)
 Q EXT
"RTN","MAGGSU1",51,0)
INTDT(X) ;
"RTN","MAGGSU1",52,0)
 N Y,INT,EXT
"RTN","MAGGSU1",53,0)
 S Y=$$IMGDT(X,.EXT,.INT) I 'Y Q Y
"RTN","MAGGSU1",54,0)
 Q INT
"RTN","MAGGTAU")
0^17^B42535074
"RTN","MAGGTAU",1,0)
MAGGTAU ;WOIFO/GEK - RPC Calls to Update the Imaging Windows Workstation file ; [ 03/25/2001 11:20 ]
"RTN","MAGGTAU",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGTAU",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTAU",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTAU",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTAU",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTAU",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTAU",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTAU",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTAU",10,0)
 ;; |                                                               |
"RTN","MAGGTAU",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTAU",12,0)
 ;; | a medical device.  As such, it may not be changed             |
"RTN","MAGGTAU",13,0)
 ;; | in any way.  Modifications to this software may result in an  |
"RTN","MAGGTAU",14,0)
 ;; | adulterated medical device under 21CFR820, the use of which   |
"RTN","MAGGTAU",15,0)
 ;; | is considered to be a violation of US Federal Statutes.       |
"RTN","MAGGTAU",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTAU",17,0)
 ;;
"RTN","MAGGTAU",18,0)
 Q
"RTN","MAGGTAU",19,0)
UPD(MAGRY,DATA) ;RPC Call from workstation updating it's exe's Date/Time
"RTN","MAGGTAU",20,0)
 ; and other Workstation information into IMAGING WINDOWS WORKSTATION
"RTN","MAGGTAU",21,0)
 ; at logon of user.
"RTN","MAGGTAU",22,0)
 ; 
"RTN","MAGGTAU",23,0)
 ; DATA is '^' delimited piece
"RTN","MAGGTAU",24,0)
 ; 1 Workstation name            2 Date/Time of capture app.
"RTN","MAGGTAU",25,0)
 ; 3 Date/Time of Display App.
"RTN","MAGGTAU",26,0)
 ; 4 Location of worksation      5 Date/Time of MAGSETUP
"RTN","MAGGTAU",27,0)
 ; 6 Version of Display          7 Version of Capture 
"RTN","MAGGTAU",28,0)
 ; 8  1=Normal startup 2=Started by CPRS
"RTN","MAGGTAU",29,0)
 N X,Y,Z
"RTN","MAGGTAU",30,0)
 N MAGNAME,MAGCDT,MAGDDT,MAG0,MAGLOC,MAGIEN,MAGSETUP,MAGSTART,MAGSRV
"RTN","MAGGTAU",31,0)
 N MAGVERSD,MAGVERSC,MAGMODE,MAGOSVER
"RTN","MAGGTAU",32,0)
 K MAGGFDA,MAGXERR,MAGXIEN
"RTN","MAGGTAU",33,0)
 S MAGNAME=$P(DATA,U,1)
"RTN","MAGGTAU",34,0)
 S MAGCDT=$P(DATA,U,2)
"RTN","MAGGTAU",35,0)
 S MAGDDT=$P(DATA,U,3)
"RTN","MAGGTAU",36,0)
 S MAGLOC=$P(DATA,U,4)
"RTN","MAGGTAU",37,0)
 S MAGSETUP=$P(DATA,U,5)
"RTN","MAGGTAU",38,0)
 S MAGVERSD=$P(DATA,U,6)
"RTN","MAGGTAU",39,0)
 S MAGVERSC=$P(DATA,U,7)
"RTN","MAGGTAU",40,0)
 S MAGMODE=$P(DATA,U,8)
"RTN","MAGGTAU",41,0)
 S MAGOSVER=$P(DATA,U,9)
"RTN","MAGGTAU",42,0)
 S MAGIEN=0
"RTN","MAGGTAU",43,0)
 I $L(MAGNAME) S MAGIEN=$O(^MAG(2006.81,"B",MAGNAME,""))
"RTN","MAGGTAU",44,0)
 I 'MAGIEN D NEWWRKS(MAGNAME,MAGLOC,.MAGIEN)
"RTN","MAGGTAU",45,0)
 I MAGIEN<1 S MAGRY="0^Workstation Not on file" Q
"RTN","MAGGTAU",46,0)
 ;
"RTN","MAGGTAU",47,0)
 S %DT="T",X=MAGCDT D ^%DT S MAGCDT=Y
"RTN","MAGGTAU",48,0)
 S %DT="T",X=MAGDDT D ^%DT S MAGDDT=Y
"RTN","MAGGTAU",49,0)
 S %DT="T",X=MAGSETUP D ^%DT S MAGSETUP=Y
"RTN","MAGGTAU",50,0)
 S MAG0=^MAG(2006.81,MAGIEN,0) ; '0' node for use later.
"RTN","MAGGTAU",51,0)
 L +^MAG(2006.81,"LOCK",MAGIEN):0
"RTN","MAGGTAU",52,0)
 S MAGIEN=+MAGIEN_","
"RTN","MAGGTAU",53,0)
 S MAGGFDA(2006.81,MAGIEN,.01)=MAGNAME ; Compter Name
"RTN","MAGGTAU",54,0)
 I MAGCDT>-1 S MAGGFDA(2006.81,MAGIEN,4)=MAGCDT ;TELE19N.EXE dttm
"RTN","MAGGTAU",55,0)
 I MAGDDT>-1 S MAGGFDA(2006.81,MAGIEN,5)=MAGDDT ;IMGVWP10.EXE dttm 
"RTN","MAGGTAU",56,0)
 I MAGSETUP>-1 S MAGGFDA(2006.81,MAGIEN,7)=MAGSETUP ; MAGSETUP.EXE dttm
"RTN","MAGGTAU",57,0)
 S MAGGFDA(2006.81,MAGIEN,8)=1 ; Active or not.
"RTN","MAGGTAU",58,0)
 S MAGGFDA(2006.81,MAGIEN,6)=MAGLOC ; location free text from .INI
"RTN","MAGGTAU",59,0)
 S MAGGFDA(2006.81,MAGIEN,3)="@" ; delete logff time for this job.
"RTN","MAGGTAU",60,0)
 S MAGGFDA(2006.81,MAGIEN,10)="@" ; delete session pointer
"RTN","MAGGTAU",61,0)
 S MAGGFDA(2006.81,MAGIEN,11)="@" ; reset the session error count.
"RTN","MAGGTAU",62,0)
 S MAGGFDA(2006.81,MAGIEN,9)=MAGVERSD ; IMGVWP10.EXE Version Info
"RTN","MAGGTAU",63,0)
 S MAGGFDA(2006.81,MAGIEN,9.5)=MAGVERSC ; TELE19N.EXE Version Info
"RTN","MAGGTAU",64,0)
 S MAGGFDA(2006.81,MAGIEN,13)=MAGOSVER ; Operating System Version.
"RTN","MAGGTAU",65,0)
 ;
"RTN","MAGGTAU",66,0)
 S X=$P(MAG0,U,12)
"RTN","MAGGTAU",67,0)
 S MAGGFDA(2006.81,MAGIEN,12)=X+1 ; total session count for workstation
"RTN","MAGGTAU",68,0)
 ;
"RTN","MAGGTAU",69,0)
 S X=$$NOW^XLFDT
"RTN","MAGGTAU",70,0)
 S MAGSTART=$E(X,1,12)
"RTN","MAGGTAU",71,0)
 I $G(DUZ) D 
"RTN","MAGGTAU",72,0)
 . S MAGGFDA(2006.81,MAGIEN,1)=DUZ
"RTN","MAGGTAU",73,0)
 . S MAGGFDA(2006.81,MAGIEN,2)=MAGSTART
"RTN","MAGGTAU",74,0)
 ;
"RTN","MAGGTAU",75,0)
 D UPDATE^DIE("S","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGTAU",76,0)
 I $D(DIERR) D RTRNERR(.MAGRY) Q
"RTN","MAGGTAU",77,0)
 ; The " MAGJOB(" array is used by other Imaging routines that are
"RTN","MAGGTAU",78,0)
 ; called from the Delphi application.  Instead of variables we are
"RTN","MAGGTAU",79,0)
 ; going to use nodes of the local array MAGJ0B.  Mainly to give an
"RTN","MAGGTAU",80,0)
 ; object feel to the RPC calls and organize the shared global variables.
"RTN","MAGGTAU",81,0)
 ; This will help stop the use of different variable names for the same 
"RTN","MAGGTAU",82,0)
 ; variable.
"RTN","MAGGTAU",83,0)
 ;
"RTN","MAGGTAU",84,0)
 S MAGJOB("WRKSIEN")=+MAGIEN
"RTN","MAGGTAU",85,0)
 S MAGJOB("VERSION")=MAGVERSD
"RTN","MAGGTAU",86,0)
 S MAGRY="1^"
"RTN","MAGGTAU",87,0)
 ;
"RTN","MAGGTAU",88,0)
 ; SESSION : Now here we have to create a new session entry;
"RTN","MAGGTAU",89,0)
 ;
"RTN","MAGGTAU",90,0)
 D GETS^DIQ(200,DUZ_",","29","I","Z","") ; service/section
"RTN","MAGGTAU",91,0)
 S MAGSRV=$G(Z(200,DUZ_",",29,"I"))
"RTN","MAGGTAU",92,0)
 ;
"RTN","MAGGTAU",93,0)
 K MAGGFDA,MAGXERR,MAGXIEN
"RTN","MAGGTAU",94,0)
 S MAGGFDA(2006.82,"+1,",.01)=$P(^VA(200,DUZ,0),U,1) ; User
"RTN","MAGGTAU",95,0)
 S MAGGFDA(2006.82,"+1,",1)=DUZ ; USER
"RTN","MAGGTAU",96,0)
 S MAGGFDA(2006.82,"+1,",2)=MAGSTART ; Session Start Time
"RTN","MAGGTAU",97,0)
 S MAGGFDA(2006.82,"+1,",4)=+MAGIEN ; Workstation 
"RTN","MAGGTAU",98,0)
 S MAGGFDA(2006.82,"+1,",7)=+MAGSRV ; User's Service/Section pointer
"RTN","MAGGTAU",99,0)
 S MAGGFDA(2006.82,"+1,",13)=MAGMODE ; 1=normal 2= started by CPRS
"RTN","MAGGTAU",100,0)
 ;
"RTN","MAGGTAU",101,0)
 ;
"RTN","MAGGTAU",102,0)
 D UPDATE^DIE("","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGTAU",103,0)
 I $D(DIERR) D RTRNERR(.MAGRY) Q
"RTN","MAGGTAU",104,0)
 S MAGRY="1^"
"RTN","MAGGTAU",105,0)
 I '+MAGXIEN(1) S MAGRY="0^" Q
"RTN","MAGGTAU",106,0)
 S MAGJOB("SESSION")=+MAGXIEN(1)
"RTN","MAGGTAU",107,0)
 S MAGRY=MAGJOB("SESSION")_"^Session # "_MAGJOB("SESSION")_" Started."
"RTN","MAGGTAU",108,0)
 S MAGGFDA(2006.81,+MAGIEN_",",10)=+MAGXIEN(1)
"RTN","MAGGTAU",109,0)
 D UPDATE^DIE("","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGTAU",110,0)
 D ACTION("LOGON^")
"RTN","MAGGTAU",111,0)
 Q
"RTN","MAGGTAU",112,0)
LOGACT(MAGRY,ACTION) ;RPC Call to log actions for Imaging Session from 
"RTN","MAGGTAU",113,0)
 ; Delphi interface
"RTN","MAGGTAU",114,0)
 D ACTION(ACTION)
"RTN","MAGGTAU",115,0)
 S MAGRY="1^Action Logged"
"RTN","MAGGTAU",116,0)
 Q
"RTN","MAGGTAU",117,0)
ACTION(TXT,LOGTM,MAGSESS) ;Call to log actions for Imaging Session from other M routines
"RTN","MAGGTAU",118,0)
 ; ACTIONS LOGGED 
"RTN","MAGGTAU",119,0)
 ; LOGON - Session StartTime     LOGOFF - Session End Time
"RTN","MAGGTAU",120,0)
 ; IMG   - Image accessed        PAT    - Patient Accessed
"RTN","MAGGTAU",121,0)
 ; CAP   - Image Captured        MOD    - Image entry modified
"RTN","MAGGTAU",122,0)
 ; IMPORT - Import API has been called
"RTN","MAGGTAU",123,0)
 ; Data   - a node of data passed to Import API
"RTN","MAGGTAU",124,0)
 ; Result - a node of the Result Array from Import API Processing.
"RTN","MAGGTAU",125,0)
 ;
"RTN","MAGGTAU",126,0)
 ; TXT is "^" delimited string
"RTN","MAGGTAU",127,0)
 ; $P(1) is code ( see above )   $P(2) is DFN
"RTN","MAGGTAU",128,0)
 ; $P(3) is Image IEN
"RTN","MAGGTAU",129,0)
 ;
"RTN","MAGGTAU",130,0)
 ; LOGTM   - [1|0] Flag to indicate wheter or not to log the time of the Action.  Default = 0
"RTN","MAGGTAU",131,0)
 ; MAGSESS - Session IEN where the action should be logged.  Default to MAGJOB("SESSION")
"RTN","MAGGTAU",132,0)
 ;
"RTN","MAGGTAU",133,0)
 N NODE,SESSIEN,MAGGFDA,MAGXERR,MAGXIEN,MAGPROC
"RTN","MAGGTAU",134,0)
 S LOGTM=$G(LOGTM)
"RTN","MAGGTAU",135,0)
 S SESSIEN=$S($G(MAGSESS):MAGSESS,$D(MAGJOB("SESSION")):MAGJOB("SESSION"),1:0)
"RTN","MAGGTAU",136,0)
 I 'SESSIEN Q
"RTN","MAGGTAU",137,0)
 S NODE="+1,"_SESSIEN_","
"RTN","MAGGTAU",138,0)
 I $P(TXT,U,3) S MAGPROC=$P(^MAG(2005,$P(TXT,U,3),0),U,8)
"RTN","MAGGTAU",139,0)
 ;
"RTN","MAGGTAU",140,0)
 I $P(TXT,U)="PAT" D
"RTN","MAGGTAU",141,0)
 . S Z=+$G(^MAG(2006.82,SESSIEN,1))+1
"RTN","MAGGTAU",142,0)
 . S MAGGFDA(2006.82,SESSIEN_",",10)=Z
"RTN","MAGGTAU",143,0)
 I $P(TXT,U)="IMG" D
"RTN","MAGGTAU",144,0)
 . S Z=+$P($G(^MAG(2006.82,SESSIEN,1)),U,2)+1
"RTN","MAGGTAU",145,0)
 . S MAGGFDA(2006.82,SESSIEN_",",11)=Z
"RTN","MAGGTAU",146,0)
 I $P(TXT,U)="CAP" D
"RTN","MAGGTAU",147,0)
 . S Z=+$P($G(^MAG(2006.82,SESSIEN,1)),U,3)+1
"RTN","MAGGTAU",148,0)
 . S MAGGFDA(2006.82,SESSIEN_",",12)=Z
"RTN","MAGGTAU",149,0)
 I $P(TXT,U,2) D
"RTN","MAGGTAU",150,0)
 . S MAGGFDA(2006.82,SESSIEN_",",5)=$P(TXT,U,2)
"RTN","MAGGTAU",151,0)
 I LOGTM D
"RTN","MAGGTAU",152,0)
 . S X=$$NOW^XLFDT
"RTN","MAGGTAU",153,0)
 . S $P(TXT,U,4)=$G(MAGPROC)_U_$E(X,1,12)
"RTN","MAGGTAU",154,0)
 S MAGGFDA(2006.821,NODE,.01)=TXT
"RTN","MAGGTAU",155,0)
 D UPDATE^DIE("S","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGTAU",156,0)
 Q
"RTN","MAGGTAU",157,0)
TESTERR(SESSIEN) ;
"RTN","MAGGTAU",158,0)
 K MAGGFDA,MAGXERR,MAGXIEN
"RTN","MAGGTAU",159,0)
 I '$D(^MAG(2006.82,SESSIEN)) Q
"RTN","MAGGTAU",160,0)
 S X="+1,"_SESSIEN_","
"RTN","MAGGTAU",161,0)
 S MAGGFDA(2006.823,X,.01)="FAKE ERROR TEXT"
"RTN","MAGGTAU",162,0)
 D UPDATE^DIE("S","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGTAU",163,0)
 Q
"RTN","MAGGTAU",164,0)
NEWWRKS(MAGNAME,MAGLOC,MAGIEN) ;
"RTN","MAGGTAU",165,0)
 N Y
"RTN","MAGGTAU",166,0)
 K DD,DO,DIC S DIC="^MAG(2006.81,",DIC(0)="L"
"RTN","MAGGTAU",167,0)
 S X=MAGNAME
"RTN","MAGGTAU",168,0)
 Q:X=""  ;
"RTN","MAGGTAU",169,0)
 S DIC("DR")="6////"_MAGLOC
"RTN","MAGGTAU",170,0)
 D FILE^DICN
"RTN","MAGGTAU",171,0)
 S MAGIEN=+Y
"RTN","MAGGTAU",172,0)
 Q
"RTN","MAGGTAU",173,0)
LOGOFF(MAGRY) ;RPC Call when session is over.  
"RTN","MAGGTAU",174,0)
 ; This will update session file with logoff time, and mark the 
"RTN","MAGGTAU",175,0)
 ;  session entry as closed.
"RTN","MAGGTAU",176,0)
 ;
"RTN","MAGGTAU",177,0)
 K ^TMP("MAGGTAU","LOGOFF",$J)
"RTN","MAGGTAU",178,0)
 S MAGRY=1
"RTN","MAGGTAU",179,0)
 N MAGGFDA,MAGXERR,MAGXIEN,MAGIEN,MAGSESS,MAGEND,MAGCON
"RTN","MAGGTAU",180,0)
 ; THIS WILL BE USED TO KEEP TIME OF USER SESSIOIN.
"RTN","MAGGTAU",181,0)
 ; THE Imaging Workstation file now keeps time of login
"RTN","MAGGTAU",182,0)
 ; We need to enter the logoff time ($$now^xlfdt) here.
"RTN","MAGGTAU",183,0)
 S X=$$NOW^XLFDT
"RTN","MAGGTAU",184,0)
 S MAGEND=$E(X,1,12)
"RTN","MAGGTAU",185,0)
 Q:'+$G(MAGJOB("WRKSIEN"))
"RTN","MAGGTAU",186,0)
 L -^MAG(2006.81,"LOCK",MAGJOB("WRKSIEN"))
"RTN","MAGGTAU",187,0)
 S MAGIEN=+MAGJOB("WRKSIEN")_","
"RTN","MAGGTAU",188,0)
 S MAGGFDA(2006.81,MAGIEN,3)=MAGEND ; logoff dttm
"RTN","MAGGTAU",189,0)
 S MAGGFDA(2006.81,MAGIEN,8)=0 ; Set job number to 0
"RTN","MAGGTAU",190,0)
 D UPDATE^DIE("S","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGTAU",191,0)
 ;MAGJOB("WRKSIEN")
"RTN","MAGGTAU",192,0)
 Q:(+$G(MAGJOB("SESSION"))=0)
"RTN","MAGGTAU",193,0)
 S MAGSESS=+MAGJOB("SESSION")_","
"RTN","MAGGTAU",194,0)
 K MAGGFDA,MAGXERR,MAGXIEN
"RTN","MAGGTAU",195,0)
 S MAGGFDA(2006.82,MAGSESS,3)=MAGEND
"RTN","MAGGTAU",196,0)
 ; calculate the length of the session
"RTN","MAGGTAU",197,0)
 S MAGCON=""
"RTN","MAGGTAU",198,0)
 S MAGGFDA(2006.82,MAGSESS,14)=MAGCON
"RTN","MAGGTAU",199,0)
 D UPDATE^DIE("S","MAGGFDA","MAGXIEN","MAGXERR")
"RTN","MAGGTAU",200,0)
 D ACTION("LOGOFF^")
"RTN","MAGGTAU",201,0)
 ;
"RTN","MAGGTAU",202,0)
 Q
"RTN","MAGGTAU",203,0)
RTRNERR(ETXT) ; There was error from UPDATE^DIE quit with error text
"RTN","MAGGTAU",204,0)
 S ETXT="0^ERROR  "_MAGXERR("DIERR",1,"TEXT",1)
"RTN","MAGGTAU",205,0)
 Q
"RTN","MAGGTAU",206,0)
CHKVER(MAGRY,MAGVER) ;
"RTN","MAGGTAU",207,0)
 ; MAGVER is the version of the Delphi App.  We can decide here, if the 
"RTN","MAGGTAU",208,0)
 ;  Delphi App should continue , or we can force it to exit.
"RTN","MAGGTAU",209,0)
 ;  
"RTN","MAGGTAU",210,0)
 ;  For now we let it continue.
"RTN","MAGGTAU",211,0)
 S MAGRY(0)="1^Version not Checked, continue"
"RTN","MAGGTAU",212,0)
 Q
"RTN","MAGGTSY1")
0^30^B14993203
"RTN","MAGGTSY1",1,0)
MAGGTSY1 ;WOIFO/GEK - Imaging Session Utilities ; [ 06/20/2001 08:57 ]
"RTN","MAGGTSY1",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGTSY1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTSY1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTSY1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTSY1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTSY1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTSY1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTSY1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTSY1",10,0)
 ;; |                                                               |
"RTN","MAGGTSY1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTSY1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTSY1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTSY1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTSY1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTSY1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTSY1",17,0)
 ;;
"RTN","MAGGTSY1",18,0)
 Q
"RTN","MAGGTSY1",19,0)
SESSION(MAGRY,DATA) ;RPC Call for MAGSYS utility.
"RTN","MAGGTSY1",20,0)
 ; List of Sessions for a Workstation.
"RTN","MAGGTSY1",21,0)
 ; DATA is '^' delimited string
"RTN","MAGGTSY1",22,0)
 ; IEN Workstatin File ^  From Date ^ To Date
"RTN","MAGGTSY1",23,0)
 ;
"RTN","MAGGTSY1",24,0)
 N I,J,I1,CT,X,Y,Z,MAGX,MAGWIEN,MAGTIEN
"RTN","MAGGTSY1",25,0)
 N DTFR,DTTO
"RTN","MAGGTSY1",26,0)
 S ^TMP("MAGGTSY1","DATA")=DATA
"RTN","MAGGTSY1",27,0)
 S MAGWIEN=$P(DATA,U,1)
"RTN","MAGGTSY1",28,0)
 S MAGRY=$NA(^TMP($J,"MAGWSESS"))
"RTN","MAGGTSY1",29,0)
 K ^TMP($J,"MAGWSESS")
"RTN","MAGGTSY1",30,0)
 S CT=1
"RTN","MAGGTSY1",31,0)
 S DTFR=$P(DATA,U,2),DTTO=$P(DATA,U,3)
"RTN","MAGGTSY1",32,0)
 I DTFR>DTTO S X=DTFR,DTFR=DTTO,DTTO=X
"RTN","MAGGTSY1",33,0)
 I DTTO=0 S DTTO=9999999
"RTN","MAGGTSY1",34,0)
 S DTTO=DTTO_".9999"
"RTN","MAGGTSY1",35,0)
 S ACI="L"_DTTO
"RTN","MAGGTSY1",36,0)
 F  S ACI=$O(^MAG(2006.82,"ACWRK",MAGWIEN,ACI),-1) S I1=$E(ACI,2,99) Q:I1<DTFR  D
"RTN","MAGGTSY1",37,0)
 . S I="" F  S I=$O(^MAG(2006.82,"ACWRK",MAGWIEN,ACI,I),-1) Q:'I  D
"RTN","MAGGTSY1",38,0)
 . . ;S I=$O(^MAG(2006.82,"ACWRK",MAGWIEN,ACI,""))
"RTN","MAGGTSY1",39,0)
 . . D INFO(I,.Y) S CT=CT+1,@MAGRY@(CT)=Y
"RTN","MAGGTSY1",40,0)
 I CT=1 S @MAGRY@(0)="0^No Sessions in Date Range." Q
"RTN","MAGGTSY1",41,0)
 S @MAGRY@(0)=(CT-1)_"^"_$P(^MAG(2006.81,MAGWIEN,0),U,1)_"  Workstation sessions "
"RTN","MAGGTSY1",42,0)
 S @MAGRY@(1)="User^Service/Section^Last Logon^Logoff^Pat ct^Image ct^Cap ct^Actions^Error^TrkID"
"RTN","MAGGTSY1",43,0)
 ;S @MAGRY@(1)="User^Workstation^Service/Section^Last Logon^Logoff^Pat ct^Image ct^Cap ct^Actions^Error"
"RTN","MAGGTSY1",44,0)
 Q
"RTN","MAGGTSY1",45,0)
INFO(I,Y) ;
"RTN","MAGGTSY1",46,0)
 N N1,N0,MDUZ,Z
"RTN","MAGGTSY1",47,0)
 S N0=^MAG(2006.82,I,0) ; Imaging Windows Session file
"RTN","MAGGTSY1",48,0)
 ; THIS WON'T BE NEEDED,I '$P(M,U,8) D SERV(I)
"RTN","MAGGTSY1",49,0)
 S Y=$P(N0,U,1) ; User Name
"RTN","MAGGTSY1",50,0)
 ;S Y=Y_$P(^MAG(2006.81,$P(M,U,5),0),U,1) ; Workstation Name
"RTN","MAGGTSY1",51,0)
 S X=""
"RTN","MAGGTSY1",52,0)
 I $P(N0,U,8) D
"RTN","MAGGTSY1",53,0)
 . D GETS^DIQ(49,$P(N0,U,8)_",",".01","E","Z","")
"RTN","MAGGTSY1",54,0)
 . S X=Z(49,$P(N0,U,8)_",",".01","E")
"RTN","MAGGTSY1",55,0)
 S Y=Y_U_X
"RTN","MAGGTSY1",56,0)
 S Y=Y_U_$$OUTDT^MAGGTSY($P(N0,U,3)) ;Date of Last Logon, by a user.
"RTN","MAGGTSY1",57,0)
 S Y=Y_U_$$OUTDT^MAGGTSY($P(N0,U,4)) ;Date/Time of Last Logoff.
"RTN","MAGGTSY1",58,0)
 ;
"RTN","MAGGTSY1",59,0)
 S N1=$G(^MAG(2006.82,I,1))
"RTN","MAGGTSY1",60,0)
 ;
"RTN","MAGGTSY1",61,0)
 S Y=Y_U_$P(N1,U,1) ; patients viewed this session
"RTN","MAGGTSY1",62,0)
 S Y=Y_U_$P(N1,U,2) ; images viewed this session.
"RTN","MAGGTSY1",63,0)
 S Y=Y_U_$P(N1,U,3) ; Images captured this session
"RTN","MAGGTSY1",64,0)
 S Y=Y_U_$P($G(^MAG(2006.82,I,"ACT",0)),U,3) ; action count
"RTN","MAGGTSY1",65,0)
 S Y=Y_U_$P($G(^MAG(2006.82,I,"ERR",0)),U,3) ; error count
"RTN","MAGGTSY1",66,0)
 S Y=Y_U_$P(N0,U,9)
"RTN","MAGGTSY1",67,0)
 S Y=Y_U_I ; session ien
"RTN","MAGGTSY1",68,0)
 Q
"RTN","MAGGTSY1",69,0)
DISPLAY(MAGRY,MAGSIEN) ; RPC Call for MAGSYS utility. 
"RTN","MAGGTSY1",70,0)
 ; Returns a display of this sessions info.
"RTN","MAGGTSY1",71,0)
 ;
"RTN","MAGGTSY1",72,0)
 N CT,I,ECT,ACT
"RTN","MAGGTSY1",73,0)
 S MAGRY=$NA(^TMP($J,"MAGSDISP"))
"RTN","MAGGTSY1",74,0)
 K ^TMP($J,"MAGSDISP")
"RTN","MAGGTSY1",75,0)
 S CT=0,I=0,ACT=0
"RTN","MAGGTSY1",76,0)
 F  S I=$O(^MAG(2006.82,MAGSIEN,"ACT",I)) Q:'I  D
"RTN","MAGGTSY1",77,0)
 . S CT=CT+1,ACT=ACT+1
"RTN","MAGGTSY1",78,0)
 . S @MAGRY@(CT)=^MAG(2006.82,MAGSIEN,"ACT",I,0)
"RTN","MAGGTSY1",79,0)
 S I=0,ECT=0
"RTN","MAGGTSY1",80,0)
 I $D(^MAG(2006.82,MAGSIEN,"ERR")) D
"RTN","MAGGTSY1",81,0)
 . S CT=CT+1
"RTN","MAGGTSY1",82,0)
 . S @MAGRY@(CT)="[ERRORS]"
"RTN","MAGGTSY1",83,0)
 . F  S I=$O(^MAG(2006.82,MAGSIEN,"ERR",I)) Q:'I  D
"RTN","MAGGTSY1",84,0)
 . . S CT=CT+1,ECT=ECT+1
"RTN","MAGGTSY1",85,0)
 . . S @MAGRY@(CT)=^MAG(2006.82,MAGSIEN,"ERR",I,0)
"RTN","MAGGTSY1",86,0)
 S @MAGRY@(0)=(CT)_"^"_ACT_" Actions.  "_ECT_" Errors."
"RTN","MAGGTSY1",87,0)
 Q
"RTN","MAGGTSY1",88,0)
SERV(I) ;
"RTN","MAGGTSY1",89,0)
 ; FILE THE SERVICE/SECTION INTO THE SESSION FILE
"RTN","MAGGTSY1",90,0)
 N N,MAGGFDA,MDUZ
"RTN","MAGGTSY1",91,0)
 S N=^MAG(2006.82,I,0)
"RTN","MAGGTSY1",92,0)
 S MDUZ=$P(N,U,2)_","
"RTN","MAGGTSY1",93,0)
 D GETS^DIQ(200,MDUZ,"29","I","Z","") ; service/section
"RTN","MAGGTSY1",94,0)
 S MAGGFDA(2006.82,I_",",7)=Z(200,MDUZ,29,"I")
"RTN","MAGGTSY1",95,0)
 D UPDATE^DIE("","MAGGFDA","","")
"RTN","MAGGTSY1",96,0)
 Q
"RTN","MAGGTU3")
0^18^B26256718
"RTN","MAGGTU3",1,0)
MAGGTU3 ;WOIFO/GEK - Silent calls for Imaging ; [ 06/20/2001 08:57 ]
"RTN","MAGGTU3",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGTU3",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU3",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTU3",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTU3",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTU3",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTU3",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTU3",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTU3",10,0)
 ;; |                                                               |
"RTN","MAGGTU3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTU3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTU3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTU3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTU3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTU3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU3",17,0)
 ;;
"RTN","MAGGTU3",18,0)
 Q
"RTN","MAGGTU3",19,0)
IMAGEINF(MAGRY,IEN) ;RPC Call to return information for 1 image;
"RTN","MAGGTU3",20,0)
 N MAGFILE,Y,Z
"RTN","MAGGTU3",21,0)
 I '$D(^MAG(2005,IEN)) D  Q
"RTN","MAGGTU3",22,0)
 . I $D(^MAG(2005.1,IEN)) S MAGRY(0)="0^Image : """_$P($G(^MAG(2005.1,IEN,2)),U,4)_""" has been deleted." Q
"RTN","MAGGTU3",23,0)
 . S MAGRY(0)="0^INVALID Image number "_IEN
"RTN","MAGGTU3",24,0)
 S MAGXX=IEN D BOTH^MAGFILEB ; this'll give us the  MAGFILE variable
"RTN","MAGGTU3",25,0)
 S Z=$P(^MAG(2005,IEN,0),U,7)
"RTN","MAGGTU3",26,0)
 I '$D(^DPT(Z)) S Z="1^Invalid patient pointer"
"RTN","MAGGTU3",27,0)
 E  S Z=Z_U_$P(^DPT(Z,0),U)
"RTN","MAGGTU3",28,0)
 S MAGRY(0)="1^"_MAGFILE
"RTN","MAGGTU3",29,0)
 S MAGRY(1)=Z ; dfn^name
"RTN","MAGGTU3",30,0)
 Q
"RTN","MAGGTU3",31,0)
USERINF2(MAGRY,MAGWRKID) ; Return user info.
"RTN","MAGGTU3",32,0)
 ; MAGRY(1) = DUZ ^ FULL NAME  ^ INITIALS
"RTN","MAGGTU3",33,0)
 ; MAGRY(2) = Network UserName ^ PassWord.
"RTN","MAGGTU3",34,0)
 ; MAGRY(3) = MUSE Site number. ( default = 1) 
"RTN","MAGGTU3",35,0)
 ; MAGRY(4) = 1|0 ^ Version of CP installed on Server
"RTN","MAGGTU3",36,0)
 ;
"RTN","MAGGTU3",37,0)
 N I,J,K,Y
"RTN","MAGGTU3",38,0)
 ; SET THE PARTITION VARIABLE MAGSYS   i.e.'IGK_Garrett's Desk'
"RTN","MAGGTU3",39,0)
 S MAGSYS=$G(MAGWRKID,"")
"RTN","MAGGTU3",40,0)
 I +$G(DUZ)=0 S MAGRY(0)="0^DUZ Undefined, Null or Zero" Q
"RTN","MAGGTU3",41,0)
 S MAGRY(0)="1^"
"RTN","MAGGTU3",42,0)
 ;          DUZ     FULL NAME                INITIALS
"RTN","MAGGTU3",43,0)
 S MAGRY(1)=DUZ_U_$$GET1^DIQ(200,DUZ_",",.01)_U_$$GET1^DIQ(200,DUZ_",",1)
"RTN","MAGGTU3",44,0)
 ; NOW NET STUFF
"RTN","MAGGTU3",45,0)
 S I=$O(^MAG(2006.1,0)) I 'I Q
"RTN","MAGGTU3",46,0)
 ; Get info from IMAGING SITE PARAMETERS File
"RTN","MAGGTU3",47,0)
 ; get the Network UserName and PassWord.
"RTN","MAGGTU3",48,0)
 S MAGRY(2)=$P($G(^MAG(2006.1,I,"NET")),U,1,2)
"RTN","MAGGTU3",49,0)
 ; get the default MUSE Site number.
"RTN","MAGGTU3",50,0)
 S MAGRY(3)=+$P($G(^MAG(2006.1,I,"USERPREF")),U,2)
"RTN","MAGGTU3",51,0)
 ; default to 1 if nothing is entered in Site Parameters File 
"RTN","MAGGTU3",52,0)
 I MAGRY(3)=0 S MAGRY(3)=1
"RTN","MAGGTU3",53,0)
 ; is CP installed at this site, the Front End will hide options
"RTN","MAGGTU3",54,0)
 ;  related to CP if not installed.
"RTN","MAGGTU3",55,0)
 S X=$$VERSION^XPDUTL("CLINICAL PROCEDURES")
"RTN","MAGGTU3",56,0)
 S MAGRY(4)=+X_U_X
"RTN","MAGGTU3",57,0)
 Q
"RTN","MAGGTU3",58,0)
 ;
"RTN","MAGGTU3",59,0)
CATEGORY(MAGRY) ; RPC Call to return Mag Descriptive Categories in array
"RTN","MAGGTU3",60,0)
 ; for listing in a list box.
"RTN","MAGGTU3",61,0)
 N I,K,CT,Y
"RTN","MAGGTU3",62,0)
 S I=0,CT=0
"RTN","MAGGTU3",63,0)
 I '$D(^MAG(2005.81)) D  Q
"RTN","MAGGTU3",64,0)
 . S MAGRY(0)="0^ERROR Mag Descriptive Category File doesn't exist"
"RTN","MAGGTU3",65,0)
 F  S I=$O(^MAG(2005.81,"B",I)) Q:I=""  D
"RTN","MAGGTU3",66,0)
 . ;S K=$O(^MAG(2005.81,"B",I,"")),CT=CT+1,MAGRY(CT)=I_U_K
"RTN","MAGGTU3",67,0)
 . ;Next line adds ADMIN, CLIN 3rd piece of the data returned
"RTN","MAGGTU3",68,0)
 . S K=$O(^MAG(2005.81,"B",I,"")),CT=CT+1
"RTN","MAGGTU3",69,0)
 . S MAGRY(CT)=I_U_K_U_$P(^MAG(2005.81,K,0),U,2)
"RTN","MAGGTU3",70,0)
 S MAGRY(0)=CT_"^Categories on file"
"RTN","MAGGTU3",71,0)
 Q
"RTN","MAGGTU3",72,0)
USERKEYS(MAGK) ; RPC Call to return an array of IMAGING Security Keys 
"RTN","MAGGTU3",73,0)
 ; to use on the workstation to limit capture ability
"RTN","MAGGTU3",74,0)
 ; and to limit functionality on Display application.
"RTN","MAGGTU3",75,0)
 ;
"RTN","MAGGTU3",76,0)
 N Y
"RTN","MAGGTU3",77,0)
 N MAGKS ; list of keys to send to XUS KEY CHECK
"RTN","MAGGTU3",78,0)
 N MAGKG ; list returned from XUS KEY CHECK
"RTN","MAGGTU3",79,0)
 N I,J,MAGMED,MAGKEY
"RTN","MAGGTU3",80,0)
 K MAGK
"RTN","MAGGTU3",81,0)
 S MAGKEY=+$P($G(^MAG(2006.1,1,"KEYS")),U)
"RTN","MAGGTU3",82,0)
 I 'MAGKEY S MAGK(0)="CAPTURE KEYS OFF"
"RTN","MAGGTU3",83,0)
 E  S MAGK(0)="CAPTURE KEYS ON"
"RTN","MAGGTU3",84,0)
 N X S X="MAG",I=0
"RTN","MAGGTU3",85,0)
 F  S X=$O(^XUSEC(X)) Q:$E(X,1,3)'="MAG"  D
"RTN","MAGGTU3",86,0)
 . S I=I+1,MAGKS(I)=X
"RTN","MAGGTU3",87,0)
 D OWNSKEY^XUSRB(.MAGKG,.MAGKS)
"RTN","MAGGTU3",88,0)
 S I=0,J=0,MAGMED=0
"RTN","MAGGTU3",89,0)
 F  S I=$O(MAGKG(I)) Q:I=""  D
"RTN","MAGGTU3",90,0)
 . Q:MAGKG(I)=0
"RTN","MAGGTU3",91,0)
 . S J=J+1,MAGK(J)=MAGKS(I)
"RTN","MAGGTU3",92,0)
 . I MAGKS(I)["MAGCAP MED" S MAGMED=1
"RTN","MAGGTU3",93,0)
 I MAGMED S J=J+1,MAGK(J)="MAGCAP MED"
"RTN","MAGGTU3",94,0)
 Q
"RTN","MAGGTU3",95,0)
MEDSTR(XSTR) ; Return a string of TYPE OF PROCEDURE that
"RTN","MAGGTU3",96,0)
 ; this user has the keys to capture images to.
"RTN","MAGGTU3",97,0)
 N MAGK,X,Y,Z
"RTN","MAGGTU3",98,0)
 S XSTR=","
"RTN","MAGGTU3",99,0)
 D USERKEYS(.MAGK)
"RTN","MAGGTU3",100,0)
 I $D(MAGK("MCKEYCARD")) S XSTR=XSTR_"C,"
"RTN","MAGGTU3",101,0)
 I $D(MAGK("MCKEYGI")) S XSTR=XSTR_"G,"
"RTN","MAGGTU3",102,0)
 I $D(MAGK("MCKEYHEM")) S XSTR=XSTR_"H,"
"RTN","MAGGTU3",103,0)
 I $D(MAGK("MCKEYPULM")) S XSTR=XSTR_"P,"
"RTN","MAGGTU3",104,0)
 I $D(MAGK("MCKEYPFT")) S XSTR=XSTR_"PF,"
"RTN","MAGGTU3",105,0)
 I $D(MAGK("MAGCAP MED GEN")) S XSTR=XSTR_"Z,R,GEN,N,"
"RTN","MAGGTU3",106,0)
 Q
"RTN","MAGGTU3",107,0)
CLEANTMP ; Clean the ^TMP Global, delete our testing global nodeS
"RTN","MAGGTU3",108,0)
 N I S I="MAFZZZZZZZZZ"
"RTN","MAGGTU3",109,0)
 F  S I=$O(^TMP(I)) Q:$E(I,1,3)'="MAG"  W !,"Deleted ^TMP(",I,")" K ^TMP(I)
"RTN","MAGGTU3",110,0)
 Q
"RTN","MAGGTU3",111,0)
MAIL(MAGRY,MAGFILE,MAGIEN) ;RPC Call "MAGG OFFLINE IMAGE ACCESSED"
"RTN","MAGGTU3",112,0)
 ;   called when a user tries to access an image that in offline as
"RTN","MAGGTU3",113,0)
 ;   determined by Stuarts file
"RTN","MAGGTU3",114,0)
 ;       ^MAGQUEUE(2006.033,0) = OFFLINE IMAGES
"RTN","MAGGTU3",115,0)
 ;   User must edit the MAGQUEUE file by hand to say if images are 
"RTN","MAGGTU3",116,0)
 ;   OFFLINE.
"RTN","MAGGTU3",117,0)
 ;
"RTN","MAGGTU3",118,0)
 N FILEREF,PLATTER
"RTN","MAGGTU3",119,0)
 S MAGRY="0^Error : logging access to Off-Line Image"
"RTN","MAGGTU3",120,0)
 IF $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGGTERR"
"RTN","MAGGTU3",121,0)
 E  S X="ERR^MAGGTERR",@^%ZOSF("TRAP")
"RTN","MAGGTU3",122,0)
 S FILEREF=$$UP^XLFSTR($P(MAGFILE,"\",$L(MAGFILE,"\")))
"RTN","MAGGTU3",123,0)
 S PLATTER=$O(^MAGQUEUE(2006.033,"B",FILEREF,""))
"RTN","MAGGTU3",124,0)
 S PLATTER=$P(^MAGQUEUE(2006.033,PLATTER,0),U,2)
"RTN","MAGGTU3",125,0)
 I MAGFILE[".ABS" Q
"RTN","MAGGTU3",126,0)
 ;N XMDUZ,XMSUB,XMTEXT,XMY
"RTN","MAGGTU3",127,0)
 S XMDUZ=$S($D(DUZ):DUZ,1:.5)
"RTN","MAGGTU3",128,0)
 S XMSUB="Offline Image Request"
"RTN","MAGGTU3",129,0)
 S XMTEXT="A("
"RTN","MAGGTU3",130,0)
 S A(1)="Patient   : "_$P(^DPT($P($G(^MAG(2005,+MAGIEN,0)),U,7),0),U,1)
"RTN","MAGGTU3",131,0)
 S A(2)="FileName  : "_MAGFILE_"  "_MAGIEN
"RTN","MAGGTU3",132,0)
 S A(3)="Desc      : "_$P($G(^MAG(2005,MAGIEN,2)),U,4)
"RTN","MAGGTU3",133,0)
 S A(4)="Procedure : "_$P($G(^MAG(2005,MAGIEN,0)),U,8)
"RTN","MAGGTU3",134,0)
 S A(5)="Platter   : "_PLATTER
"RTN","MAGGTU3",135,0)
 S A(6)="User      : "_$$GET1^DIQ(200,DUZ_",",.01)_"("_$G(DUZ)_")"
"RTN","MAGGTU3",136,0)
 S XMY("G.OFFLINE IMAGE TRACKERS")="" D ^XMD
"RTN","MAGGTU3",137,0)
 S MAGRY="1^Message sent :  Offline Image Accessed"
"RTN","MAGGTU3",138,0)
 Q
"RTN","MAGGTU3",139,0)
LOGERROR(MAGRY,TEXT) ;RPC Call to stuff error information from 
"RTN","MAGGTU3",140,0)
 ;  Delphi app into the Session file.
"RTN","MAGGTU3",141,0)
 D LOGERR^MAGGTERR("---- New Error ----")
"RTN","MAGGTU3",142,0)
 S I="" F  S I=$O(TEXT(I)) Q:I=""  D LOGERR^MAGGTERR(TEXT(I))
"RTN","MAGGTU3",143,0)
 S MAGRY="1^Error text saved to Session file"
"RTN","MAGGTU3",144,0)
 Q
"RTN","MAGGTUP")
0^26^B18612200
"RTN","MAGGTUP",1,0)
MAGGTUP ;WOIFO/GEK - Imaging System User preferences ; [ 06/20/2001 08:57 ]
"RTN","MAGGTUP",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGGTUP",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTUP",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTUP",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTUP",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTUP",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTUP",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTUP",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTUP",10,0)
 ;; |                                                               |
"RTN","MAGGTUP",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTUP",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTUP",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTUP",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTUP",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTUP",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTUP",17,0)
 ;;
"RTN","MAGGTUP",18,0)
 Q
"RTN","MAGGTUP",19,0)
GET(MAGRY) ;RPC Call to Get user preferences.
"RTN","MAGGTUP",20,0)
 ;
"RTN","MAGGTUP",21,0)
 N Y,I,J,X,Z,CT
"RTN","MAGGTUP",22,0)
 IF $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGTERR"
"RTN","MAGGTUP",23,0)
 E  S X="ERRA^MAGGTERR",@^%ZOSF("TRAP")
"RTN","MAGGTUP",24,0)
 S CT=0
"RTN","MAGGTUP",25,0)
 S MAGRY(0)="0^Attempting to access user preference"
"RTN","MAGGTUP",26,0)
 S I=$O(^MAG(2006.18,"AC",DUZ,"")) I 'I S I=$$NEW(DUZ) Q:I=-1
"RTN","MAGGTUP",27,0)
 S MAGRY(0)="1^"
"RTN","MAGGTUP",28,0)
 S CT=CT+1,MAGRY(CT)="SYS^"_^MAG(2006.18,I,0)
"RTN","MAGGTUP",29,0)
 I $D(^MAG(2006.18,I,"MAIN")) D
"RTN","MAGGTUP",30,0)
 . ; Added a new field: MAIN TOOLBAR, Default should be '1'
"RTN","MAGGTUP",31,0)
 . I $P(^MAG(2006.18,I,"MAIN"),U,6)="" S $P(^MAG(2006.18,I,"MAIN"),U,6)="1"
"RTN","MAGGTUP",32,0)
 . S CT=CT+1,MAGRY(CT)="MAIN^"_^MAG(2006.18,I,"MAIN")
"RTN","MAGGTUP",33,0)
 I $D(^MAG(2006.18,I,"ABS")) D
"RTN","MAGGTUP",34,0)
 . ; Added a new field: ABS TOOLBAR, Default should be '1'
"RTN","MAGGTUP",35,0)
 . I $P(^MAG(2006.18,I,"ABS"),U,9)="" S $P(^MAG(2006.18,I,"ABS"),U,9)="1"
"RTN","MAGGTUP",36,0)
 . S CT=CT+1,MAGRY(CT)="ABS^"_^MAG(2006.18,I,"ABS")
"RTN","MAGGTUP",37,0)
 I $D(^MAG(2006.18,I,"NOTES")) D
"RTN","MAGGTUP",38,0)
 . S CT=CT+1,MAGRY(CT)="NOTES^"_^MAG(2006.18,I,"NOTES")
"RTN","MAGGTUP",39,0)
 I $D(^MAG(2006.18,I,"EKG")) D
"RTN","MAGGTUP",40,0)
 . S CT=CT+1,MAGRY(CT)="EKG^"_^MAG(2006.18,I,"EKG")
"RTN","MAGGTUP",41,0)
 I $D(^MAG(2006.18,I,"FULL")) D
"RTN","MAGGTUP",42,0)
 . S CT=CT+1,MAGRY(CT)="FULL^"_^MAG(2006.18,I,"FULL")
"RTN","MAGGTUP",43,0)
 I $D(^MAG(2006.18,I,"GROUP")) D
"RTN","MAGGTUP",44,0)
 . ; Added a new field: GROUP TOOLBAR, Default should be '1'
"RTN","MAGGTUP",45,0)
 . I $P(^MAG(2006.18,I,"GROUP"),U,9)="" S $P(^MAG(2006.18,I,"GROUP"),U,9)="1"
"RTN","MAGGTUP",46,0)
 . S CT=CT+1,MAGRY(CT)="GROUP^"_^MAG(2006.18,I,"GROUP")
"RTN","MAGGTUP",47,0)
 I $D(^MAG(2006.18,I,"DOC")) D
"RTN","MAGGTUP",48,0)
 . S CT=CT+1,MAGRY(CT)="DOC^"_^MAG(2006.18,I,"DOC")
"RTN","MAGGTUP",49,0)
 . I $P(MAGRY(CT),U,9)="" S $P(MAGRY(CT),U,9)=0
"RTN","MAGGTUP",50,0)
 I $D(^MAG(2006.18,I,"REPORT")) D
"RTN","MAGGTUP",51,0)
 . S CT=CT+1,MAGRY(CT)="REPORT^"_^MAG(2006.18,I,"REPORT")
"RTN","MAGGTUP",52,0)
 I $D(^MAG(2006.18,I,"IMAGEGRID")) D
"RTN","MAGGTUP",53,0)
 . S CT=CT+1,MAGRY(CT)="IMAGEGRID^"_^MAG(2006.18,I,"IMAGEGRID")
"RTN","MAGGTUP",54,0)
 I $D(^MAG(2006.18,I,"RADLISTWIN")) D
"RTN","MAGGTUP",55,0)
 . S CT=CT+1,MAGRY(CT)="RADLISTWIN^"_^MAG(2006.18,I,"RADLISTWIN")
"RTN","MAGGTUP",56,0)
 I $D(^MAG(2006.18,I,"DICOMWIN")) D
"RTN","MAGGTUP",57,0)
 . S CT=CT+1,MAGRY(CT)="DICOMWIN^"_^MAG(2006.18,I,"DICOMWIN")
"RTN","MAGGTUP",58,0)
 Q
"RTN","MAGGTUP",59,0)
SAVE(MAGRY,DATA) ;RPC Call to save User Preferences
"RTN","MAGGTUP",60,0)
 ;
"RTN","MAGGTUP",61,0)
 S MAGRY="0^Starting save preferences"
"RTN","MAGGTUP",62,0)
 N X,Y,Z,I,J
"RTN","MAGGTUP",63,0)
 IF $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGGTERR"
"RTN","MAGGTUP",64,0)
 E  S X="ERR^MAGGTERR",@^%ZOSF("TRAP")
"RTN","MAGGTUP",65,0)
 S Z=$O(^MAG(2006.18,"AC",DUZ,"")) I 'Z S Z=$$NEW(DUZ) Q:Z=-1
"RTN","MAGGTUP",66,0)
 K ^TMP("MAGGTUP")
"RTN","MAGGTUP",67,0)
 M ^TMP("MAGGTUP","DATA")=DATA
"RTN","MAGGTUP",68,0)
 S I="" F  S I=$O(DATA(I)) Q:I=""  D
"RTN","MAGGTUP",69,0)
 . S X=$G(^MAG(2006.18,Z,I))
"RTN","MAGGTUP",70,0)
 . S Y=DATA(I)
"RTN","MAGGTUP",71,0)
 . F J=1:1:$L(Y,"^") I $L($P(Y,"^",J)) S $P(X,"^",J)=$P(Y,"^",J)
"RTN","MAGGTUP",72,0)
 . S ^MAG(2006.18,Z,I)=X
"RTN","MAGGTUP",73,0)
 S MAGRY="1^User Preferences saved."
"RTN","MAGGTUP",74,0)
 Q
"RTN","MAGGTUP",75,0)
NEW(DUZ) ;
"RTN","MAGGTUP",76,0)
 K DD,DO
"RTN","MAGGTUP",77,0)
 S X=$E($$GET1^DIQ(200,DUZ_",",.01),1,15)_" (SETTING 1)"
"RTN","MAGGTUP",78,0)
 S DIC="^MAG(2006.18,",DIC(0)="L"
"RTN","MAGGTUP",79,0)
 S DIC("DR")="1////"_DUZ_";2////12;3////12;" D FILE^DICN
"RTN","MAGGTUP",80,0)
 I Y=-1 Q +Y
"RTN","MAGGTUP",81,0)
 D DEFAULT(+Y)
"RTN","MAGGTUP",82,0)
 Q +Y
"RTN","MAGGTUP",83,0)
DEFAULT(X) ;
"RTN","MAGGTUP",84,0)
 N Z S Z=+$G(^MAG(2006.1,1,"USERPREF")) I Z D DEFUSER(X,Z) Q
"RTN","MAGGTUP",85,0)
 S $P(^MAG(2006.18,X,0),U,5,99)="0^0^1^"
"RTN","MAGGTUP",86,0)
 S ^MAG(2006.18,X,"ABS")="2^1^173^486^326^105^60^1^1"
"RTN","MAGGTUP",87,0)
 S ^MAG(2006.18,X,"FULL")="2^310^282^714^487"
"RTN","MAGGTUP",88,0)
 S ^MAG(2006.18,X,"DICOMWIN")="2^320^292^724^487"
"RTN","MAGGTUP",89,0)
 S ^MAG(2006.18,X,"GROUP")="2^24^231^427^457^110^70^^1"
"RTN","MAGGTUP",90,0)
 S ^MAG(2006.18,X,"IMAGEGRID")="2^487^0^433^172^1"
"RTN","MAGGTUP",91,0)
 S ^MAG(2006.18,X,"RADLISTWIN")="2^487^10^433^172^0"
"RTN","MAGGTUP",92,0)
 S ^MAG(2006.18,X,"MAIN")="2^1^1^487^172^1"
"RTN","MAGGTUP",93,0)
 S ^MAG(2006.18,X,"DOC")="2^298^24^729^429^0^0^3"
"RTN","MAGGTUP",94,0)
 S ^MAG(2006.18,X,"REPORT")="2^2^333^722^437^Courier^^10"
"RTN","MAGGTUP",95,0)
 Q
"RTN","MAGGTUP",96,0)
DEFUSER(X,Z) ;
"RTN","MAGGTUP",97,0)
 N X0 S X0=$P(^MAG(2006.18,X,0),U,1,4)
"RTN","MAGGTUP",98,0)
 M ^MAG(2006.18,X)=^MAG(2006.18,Z)
"RTN","MAGGTUP",99,0)
 S $P(^MAG(2006.18,X,0),U,1,4)=X0
"RTN","MAGGTUP",100,0)
 Q
"RTN","MAGIPOS7")
0^^B3303290
"RTN","MAGIPOS7",1,0)
MAGIPOS7 ;Post init routine to queue site activity at install.
"RTN","MAGIPOS7",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGIPOS7",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIPOS7",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIPOS7",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIPOS7",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIPOS7",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIPOS7",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIPOS7",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIPOS7",10,0)
 ;; |                                                               |
"RTN","MAGIPOS7",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIPOS7",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIPOS7",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIPOS7",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIPOS7",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIPOS7",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIPOS7",17,0)
 ;;
"RTN","MAGIPOS7",18,0)
 Q
"RTN","MAGIPOS7",19,0)
POST ;
"RTN","MAGIPOS7",20,0)
 I $T(POST^MAGQST)="" Q
"RTN","MAGIPOS7",21,0)
 S DIK="^DD(2005,",DA=105,DA(1)=2005 D ^DIK
"RTN","MAGIPOS7",22,0)
 K DIK,DA
"RTN","MAGIPOS7",23,0)
 D POST^MAGQST
"RTN","MAGIPOS7",24,0)
 Q
"RTN","MAGQBIM")
0^20^B7027516
"RTN","MAGQBIM",1,0)
MAGQBIM ;WOIFO/RMP - Import functions  ;19 Nov 2001 1:23 PM
"RTN","MAGQBIM",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGQBIM",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBIM",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBIM",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBIM",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBIM",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBIM",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBIM",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBIM",10,0)
 ;; |                                                               |
"RTN","MAGQBIM",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBIM",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBIM",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBIM",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBIM",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBIM",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBIM",17,0)
 ;;
"RTN","MAGQBIM",18,0)
 ;
"RTN","MAGQBIM",19,0)
 Q
"RTN","MAGQBIM",20,0)
ENTRY(QP,QUE,QP2,ZN,RES) ;
"RTN","MAGQBIM",21,0)
 K OUT,ERR,IEN
"RTN","MAGQBIM",22,0)
 S IEN=$S($P(ZN,U,11)?1N.N:$P(ZN,U,11),1:QP)
"RTN","MAGQBIM",23,0)
 D FIND^DIC(2006.041,"","@;.02","PQ",IEN,1,"","","","OUT","ERR")
"RTN","MAGQBIM",24,0)
 I ($D(ERR)!($P($G(OUT("DILIST",0)),U)<1)) D  Q
"RTN","MAGQBIM",25,0)
 . D QSTAT^MAGQBTM(IEN,QUE_" Dequeue Failed on TrackId lookup.",QUE)
"RTN","MAGQBIM",26,0)
 . S RES="0"_U_QP2_U_" Dequeue Failed on TrackId lookup."
"RTN","MAGQBIM",27,0)
 . Q
"RTN","MAGQBIM",28,0)
 N VALUE
"RTN","MAGQBIM",29,0)
 S VALUE=$P(OUT("DILIST",1,0),U,2)
"RTN","MAGQBIM",30,0)
 S RES=QP_U_VALUE_U_$TR($P(ZN,U,10),"|",U)_U_IEN
"RTN","MAGQBIM",31,0)
 S $P(RES,U,8)=+$P(ZN,U,9)
"RTN","MAGQBIM",32,0)
 Q
"RTN","MAGQBIM",33,0)
STAT(QP,TIME,MESS) ;
"RTN","MAGQBIM",34,0)
 N TRACKID
"RTN","MAGQBIM",35,0)
 K OUT,ERR,FDA
"RTN","MAGQBIM",36,0)
 S FDA(2006.041,"+1,",.01)=QP
"RTN","MAGQBIM",37,0)
 D FIND^DIC(2006.041,"","@;.02","PQ",QP,1,"","","","OUT","ERR")
"RTN","MAGQBIM",38,0)
 Q:$D(ERR)
"RTN","MAGQBIM",39,0)
 Q:$P(OUT("DILIST",0),U)<1
"RTN","MAGQBIM",40,0)
 S TRACKID=$P(OUT("DILIST",1,0),U,2)
"RTN","MAGQBIM",41,0)
 S FDA(2006.041,"+1,",.02)=TRACKID
"RTN","MAGQBIM",42,0)
 S FDA(2006.041,"+1,",1)="BP QUEUE STATUS"
"RTN","MAGQBIM",43,0)
 S FDA(2006.041,"+1,",2)=TIME
"RTN","MAGQBIM",44,0)
 S FDA(2006.041,"+1,",3)=MESS
"RTN","MAGQBIM",45,0)
 D UPDATE^DIE("U","FDA","","MAGIMP")
"RTN","MAGQBIM",46,0)
 Q
"RTN","MAGQBIM",47,0)
TIDL(QP,QUE,RES) ;
"RTN","MAGQBIM",48,0)
 K OUT,ERR
"RTN","MAGQBIM",49,0)
 S RES=0
"RTN","MAGQBIM",50,0)
 D FIND^DIC(2006.041,"","@;.02","PQ",QP,1,"","","","OUT","ERR")
"RTN","MAGQBIM",51,0)
 I ($D(ERR)!($P($G(OUT("DILIST",0)),U)<1)) D  Q
"RTN","MAGQBIM",52,0)
 . D QSTAT^MAGQBTM(QP,QUE_"      Requeue Failed on TrackId lookup.",QUE)
"RTN","MAGQBIM",53,0)
 . Q
"RTN","MAGQBIM",54,0)
 S RES=$P($G(OUT("DILIST",1,0)),U,2)
"RTN","MAGQBIM",55,0)
 Q
"RTN","MAGQBPG1")
0^27^B61804702
"RTN","MAGQBPG1",1,0)
MAGQBPG1 ;WOIFO/RMP - REMOTE Task SERVER Program [ 11/08/2001 17:18 ]
"RTN","MAGQBPG1",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGQBPG1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPG1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBPG1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBPG1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBPG1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBPG1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBPG1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBPG1",10,0)
 ;; |                                                               |
"RTN","MAGQBPG1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBPG1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBPG1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBPG1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBPG1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBPG1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPG1",17,0)
 ;;
"RTN","MAGQBPG1",18,0)
ENTRY(RESULT,WSTAT,PROCESS) ;RETURNS A LIST OF ACTIVE PROCESSES FOR
"RTN","MAGQBPG1",19,0)
 ; THE FIRST ACTIVE BACKGROUND PROCESSOR
"RTN","MAGQBPG1",20,0)
 ; RPC[MAGQ JBS]
"RTN","MAGQBPG1",21,0)
 N X,SYSIEN,SYSNAME,ZNODE,NODE,INDX,CNT,PROC,%,QPTR,QCNT,SHARE
"RTN","MAGQBPG1",22,0)
 D NOW^%DTC
"RTN","MAGQBPG1",23,0)
 ; initialize error trap
"RTN","MAGQBPG1",24,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",25,0)
 ; Set some initialization variables
"RTN","MAGQBPG1",26,0)
 S (SYSIEN,CNT)=0,SYSNAME="",U="^"
"RTN","MAGQBPG1",27,0)
 ; Select sysname 
"RTN","MAGQBPG1",28,0)
 S SYSIEN=$O(^MAG(2006.8,"C",WSTAT,"")) ;TRUE WORKSTATION NAME
"RTN","MAGQBPG1",29,0)
 I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",$$UPPER^MAGQST(WSTAT),""))
"RTN","MAGQBPG1",30,0)
 I 'SYSIEN D  ;ATTEMPT TO FIND A MATCH FROM LOCAL NAME
"RTN","MAGQBPG1",31,0)
 . N TRY
"RTN","MAGQBPG1",32,0)
 . F TRY=1:1:$L(WSTAT,".") D  Q:SYSIEN?1N.N
"RTN","MAGQBPG1",33,0)
 . . S SYSIEN=$O(^MAG(2006.8,"C",$P(WSTAT,".",TRY),""))
"RTN","MAGQBPG1",34,0)
 . . I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",$$UPPER^MAGQST($P(WSTAT,".",TRY)),""))
"RTN","MAGQBPG1",35,0)
 Q:SYSIEN=""
"RTN","MAGQBPG1",36,0)
 S NODE=^MAG(2006.8,SYSIEN,0)
"RTN","MAGQBPG1",37,0)
 S SYSNAME=$P(NODE,U)
"RTN","MAGQBPG1",38,0)
 I SYSNAME="" D  Q
"RTN","MAGQBPG1",39,0)
 . S RESULT(0)="-1^No Background Processor parameters on system"
"RTN","MAGQBPG1",40,0)
 S RESULT(0)="0^BP List^PID: "_$$BASE^XLFUTL($J,10,16)_U_SYSNAME_U_WSTAT_U_$P(^MAG(2006.1,1,0),U,2)
"RTN","MAGQBPG1",41,0)
 S (X,CNT)=0
"RTN","MAGQBPG1",42,0)
 F  S X=$O(^MAG(2005.2,X)) Q:X'?1N.N  S ZNODE=^(X,0) D
"RTN","MAGQBPG1",43,0)
 . Q:'$P(ZNODE,U,6)  ;1=on-line
"RTN","MAGQBPG1",44,0)
 . Q:$E($P(ZNODE,U,2),1,2)'="\\"
"RTN","MAGQBPG1",45,0)
 . Q:(($P(ZNODE,U,7)'["WORM")&($P(ZNODE,U,7)'="RW"))
"RTN","MAGQBPG1",46,0)
 . S CNT=CNT+1,SHARE=$P(ZNODE,U,2)
"RTN","MAGQBPG1",47,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBPG1",48,0)
 . S RESULT(CNT)=X_U_SHARE_U_$P(ZNODE,U,8)
"RTN","MAGQBPG1",49,0)
 Q
"RTN","MAGQBPG1",50,0)
JBPTR(RESULT,FILE) ;[MAGQ JBPTR]
"RTN","MAGQBPG1",51,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",52,0)
 N IEN,SITEID
"RTN","MAGQBPG1",53,0)
 S SITEID=$$UPPER^MAGQST($P(^MAG(2006.1,1,0),U,2))
"RTN","MAGQBPG1",54,0)
 S IEN=$P(+$P(FILE,SITEID,2),".")
"RTN","MAGQBPG1",55,0)
 S RESULT=$$JBPTR^MAGQBPRG(IEN,$$FTYPE^MAGQBPRG($P(FILE,".",2)))
"RTN","MAGQBPG1",56,0)
 Q
"RTN","MAGQBPG1",57,0)
SHR(RESULT) ; RPC[MAGQ SHARES]
"RTN","MAGQBPG1",58,0)
 N TMP,INDX,DATA,CNT,SHARE,CWL,VALUE ;CWL=CURRENT WRITE LOCATION
"RTN","MAGQBPG1",59,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",60,0)
 S (CNT,INDX)=0,U="^"
"RTN","MAGQBPG1",61,0)
 S CWL=$G(^MAG(2006.1,"ARITE"))
"RTN","MAGQBPG1",62,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBPG1",63,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBPG1",64,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBPG1",65,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBPG1",66,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBPG1",67,0)
 . Q:$P(DATA,U,2)["."
"RTN","MAGQBPG1",68,0)
 . Q:$P(DATA,U,2)["IMAGE_SERVER"
"RTN","MAGQBPG1",69,0)
 . Q:$P(DATA,U,2)["VHABOSCLU11"
"RTN","MAGQBPG1",70,0)
 . Q:$P(DATA,U,2)["LOCAL"
"RTN","MAGQBPG1",71,0)
 . Q:$P(DATA,U,2)["VHAIWSIMM1"
"RTN","MAGQBPG1",72,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBPG1",73,0)
 . Q:$E(SHARE,1,2)'="\\"
"RTN","MAGQBPG1",74,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBPG1",75,0)
 . S SHARE=SHARE_U_$P(DATA,U,8)
"RTN","MAGQBPG1",76,0)
 . Q:$D(TMP(SHARE))
"RTN","MAGQBPG1",77,0)
 . S TMP(SHARE)=INDX
"RTN","MAGQBPG1",78,0)
 S INDX=""
"RTN","MAGQBPG1",79,0)
 F  S INDX=$O(TMP(INDX)) Q:INDX=""  D
"RTN","MAGQBPG1",80,0)
 . S RESULT(CNT)=TMP(INDX)_U_INDX,CNT=CNT+1
"RTN","MAGQBPG1",81,0)
 . S ^TMP("MAGQBP",$J,"SHRLST",CNT-1)=TMP(INDX)_U_INDX
"RTN","MAGQBPG1",82,0)
 K TMP
"RTN","MAGQBPG1",83,0)
 Q
"RTN","MAGQBPG1",84,0)
ERR ; Error Processing
"RTN","MAGQBPG1",85,0)
 N ERRXX
"RTN","MAGQBPG1",86,0)
 S ERRXX=$$EC^%ZOSV
"RTN","MAGQBPG1",87,0)
 D ^%ZTER
"RTN","MAGQBPG1",88,0)
 ;H
"RTN","MAGQBPG1",89,0)
 Q
"RTN","MAGQBPG1",90,0)
TRIM(X) ; remove both leading and trailing blanks
"RTN","MAGQBPG1",91,0)
 N I,J
"RTN","MAGQBPG1",92,0)
 F I=1:1:$L(X) Q:$E(X,I)'=" "
"RTN","MAGQBPG1",93,0)
 F J=$L(X):-1:I Q:$E(X,J)'=" "
"RTN","MAGQBPG1",94,0)
 Q $E(X,I,J)
"RTN","MAGQBPG1",95,0)
CNP2(RESULT,IEN,START,STOP,CRITERIA) ;[MAGQ JBSCN]
"RTN","MAGQBPG1",96,0)
 ;CRITERIA (0=IEN,1=DATE)
"RTN","MAGQBPG1",97,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",98,0)
 N FNAME,PIECE,ZNODE,NODE2,BNODE,BNAME,PTR,HASH,TEMP,ORDER,RDATE
"RTN","MAGQBPG1",99,0)
 S RESULT=""
"RTN","MAGQBPG1",100,0)
 I CRITERIA=1 D  I (START=-1)!(STOP=-1) S RESULT=-1 Q 
"RTN","MAGQBPG1",101,0)
 . S X=START D ^%DT S START=Y
"RTN","MAGQBPG1",102,0)
 . S X=STOP D ^%DT S STOP=Y
"RTN","MAGQBPG1",103,0)
 . Q
"RTN","MAGQBPG1",104,0)
 E  S:START="" START=$O(^MAG(2005,0)) S:STOP="" STOP=$O(^MAG(2005,"A"),-1)
"RTN","MAGQBPG1",105,0)
 S ORDER=$S(START>STOP:"R",1:"F")
"RTN","MAGQBPG1",106,0)
 I (IEN'?1N.N)!IEN=0 D  I IEN="" S RESULT=0 Q 
"RTN","MAGQBPG1",107,0)
 . S IEN=$S(CRITERIA=1:$$SDATE(START,ORDER),1:START)
"RTN","MAGQBPG1",108,0)
 . Q
"RTN","MAGQBPG1",109,0)
 S IEN=+IEN
"RTN","MAGQBPG1",110,0)
 S IEN=$S(ORDER="F":$O(^MAG(2005,IEN)),1:$O(^MAG(2005,IEN),-1))
"RTN","MAGQBPG1",111,0)
 I CRITERIA=0,$S(IEN'?1N.N:1,((ORDER="F")&(IEN>STOP)):1,((ORDER="R")&(IEN<STOP)):1,1:0) D  Q
"RTN","MAGQBPG1",112,0)
 . S RESULT=0
"RTN","MAGQBPG1",113,0)
 . Q
"RTN","MAGQBPG1",114,0)
 ;ACQUISITION DATE FOR DATE RANGE CRITERIA
"RTN","MAGQBPG1",115,0)
 I CRITERIA="1" D  Q:RESULT=0
"RTN","MAGQBPG1",116,0)
 . S RDATE=$P($P($G(^MAG(2005,IEN,2)),U),".")
"RTN","MAGQBPG1",117,0)
 . I $S(ORDER="F"&(RDATE>STOP):1,ORDER="R"&(RDATE<STOP):1,1:0) S RESULT=0
"RTN","MAGQBPG1",118,0)
 . Q
"RTN","MAGQBPG1",119,0)
 S ZNODE=$G(^MAG(2005,IEN,0))
"RTN","MAGQBPG1",120,0)
 S FNAME=$P(ZNODE,U,2)
"RTN","MAGQBPG1",121,0)
 S $P(RESULT,U)=IEN
"RTN","MAGQBPG1",122,0)
 S $P(RESULT,U,19)=$P($P($G(^MAG(2005,IEN,2)),U),".")
"RTN","MAGQBPG1",123,0)
 I $P(ZNODE,U,2)'="" D  ;NON-GROUP PARENT
"RTN","MAGQBPG1",124,0)
 . S BNODE=$G(^MAG(2005,IEN,"FBIG"))
"RTN","MAGQBPG1",125,0)
 . S:$P(ZNODE,U,5)?1N.N $P(RESULT,U,3)=$P(ZNODE,U,5)
"RTN","MAGQBPG1",126,0)
 . I $P(ZNODE,U,5)?1N.N S $P(RESULT,U,3)=$P(ZNODE,U,5)
"RTN","MAGQBPG1",127,0)
 . E  D  ;SET JBPTR TO THE CURRENT JB WRITE LOCATION
"RTN","MAGQBPG1",128,0)
 . . S TEMP=$P(^MAG(2006.1,1,1),U,6)
"RTN","MAGQBPG1",129,0)
 . . S $P(RESULT,U,3)=$P(^MAGQUEUE(2006.032,TEMP,0),U,3)
"RTN","MAGQBPG1",130,0)
 . . Q
"RTN","MAGQBPG1",131,0)
 . S:$P(BNODE,U,2)?1N.N $P(RESULT,U,4)=$P(BNODE,U,2)
"RTN","MAGQBPG1",132,0)
 . S:$P(ZNODE,U,3)?1N.N $P(RESULT,U,5)=$P(ZNODE,U,3)
"RTN","MAGQBPG1",133,0)
 . S:$P(ZNODE,U,4)?1N.N $P(RESULT,U,6)=$P(ZNODE,U,4)
"RTN","MAGQBPG1",134,0)
 . S:$P(BNODE,U)?1N.N $P(RESULT,U,7)=$P(BNODE,U)
"RTN","MAGQBPG1",135,0)
 . S $P(RESULT,U,8)=$P($G(^MAG(2006.1,1,0)),U,3) ;CWL
"RTN","MAGQBPG1",136,0)
 . S $P(RESULT,U,2)=FNAME  ;IEN
"RTN","MAGQBPG1",137,0)
 . Q
"RTN","MAGQBPG1",138,0)
 S $P(RESULT,U,12,17)=$$CHKIMG^MAGQBUT2(IEN)
"RTN","MAGQBPG1",139,0)
 Q
"RTN","MAGQBPG1",140,0)
JPUD(RESULT,JPTR,EXT,IEN) ; RPC[MAGQ JPUD]
"RTN","MAGQBPG1",141,0)
 N TYPE,PIECE,NODE
"RTN","MAGQBPG1",142,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP"),RESULT="0"
"RTN","MAGQBPG1",143,0)
 S TYPE=$$FTYPE^MAGQBPRG(EXT)
"RTN","MAGQBPG1",144,0)
 S PIECE=$S(TYPE="BIG":2,1:5)
"RTN","MAGQBPG1",145,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPG1",146,0)
 I PIECE=0 D ELOG^MAGQBPRG(FN,FP) Q
"RTN","MAGQBPG1",147,0)
 S:JPTR="0" JPTR=""
"RTN","MAGQBPG1",148,0)
 S $P(^MAG(2005,IEN,NODE),U,PIECE)=JPTR
"RTN","MAGQBPG1",149,0)
 S RESULT="1"
"RTN","MAGQBPG1",150,0)
 Q
"RTN","MAGQBPG1",151,0)
VCUD(RESULT,VCPTR,EXT,IEN) ; RPC[MAGQ VCUD]
"RTN","MAGQBPG1",152,0)
 N TYPE,PIECE,NODE
"RTN","MAGQBPG1",153,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP"),RESULT="0"
"RTN","MAGQBPG1",154,0)
 S TYPE=$$FTYPE^MAGQBPRG(EXT)
"RTN","MAGQBPG1",155,0)
 S PIECE=$S(TYPE="BIG":1,TYPE="ABS":4,1:3)
"RTN","MAGQBPG1",156,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPG1",157,0)
 I PIECE=0 D ELOG^MAGQBPRG(FN,FP) Q
"RTN","MAGQBPG1",158,0)
 S:VCPTR="0" VCPTR=""
"RTN","MAGQBPG1",159,0)
 S $P(^MAG(2005,IEN,NODE),U,PIECE)=VCPTR
"RTN","MAGQBPG1",160,0)
 S RESULT="1"
"RTN","MAGQBPG1",161,0)
 Q
"RTN","MAGQBPG1",162,0)
DFNIQ(RESULT,INPUT,SEND) ;
"RTN","MAGQBPG1",163,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",164,0)
 N LOC,CNT
"RTN","MAGQBPG1",165,0)
 S U="^"
"RTN","MAGQBPG1",166,0)
 S CNT=+$O(^TMP($J,"MAGQDFN",""),-1)
"RTN","MAGQBPG1",167,0)
 I CNT<2 D
"RTN","MAGQBPG1",168,0)
 . D NOW^%DTC S Y=% D DD^%DT
"RTN","MAGQBPG1",169,0)
 . S LOC=$$KSP^XUPARAM("WHERE")
"RTN","MAGQBPG1",170,0)
 . S ^TMP($J,"MAGQDFN",1)="            SITE: "_LOC
"RTN","MAGQBPG1",171,0)
 . S ^TMP($J,"MAGQDFN",2)="            DATE: "_Y_" "_$G(^XMB("TIMEZONE"))
"RTN","MAGQBPG1",172,0)
 . S CNT=2
"RTN","MAGQBPG1",173,0)
 . Q
"RTN","MAGQBPG1",174,0)
 I SEND="1" D
"RTN","MAGQBPG1",175,0)
 . S XMSUB=INPUT
"RTN","MAGQBPG1",176,0)
 . N XMY,XMTEXT
"RTN","MAGQBPG1",177,0)
 . S XMTEXT="^TMP($J,""MAGQDFN"","
"RTN","MAGQBPG1",178,0)
 . S XMY("G.MAG SERVER")=""
"RTN","MAGQBPG1",179,0)
 . S:$G(DUZ) XMY(DUZ)=""
"RTN","MAGQBPG1",180,0)
 . D ^XMD
"RTN","MAGQBPG1",181,0)
 . K ^TMP($J,"MAGQDFN")
"RTN","MAGQBPG1",182,0)
 . Q
"RTN","MAGQBPG1",183,0)
 E  S CNT=CNT+1,^TMP($J,"MAGQDFN",CNT)=INPUT
"RTN","MAGQBPG1",184,0)
 S RESULT="1"
"RTN","MAGQBPG1",185,0)
 Q
"RTN","MAGQBPG1",186,0)
SDATE(FDAY,ORDER) ;
"RTN","MAGQBPG1",187,0)
 N UP,LP,M,DONE,CNT,N,TDATE,UDATE,LDATE
"RTN","MAGQBPG1",188,0)
 S (CNT,DONE)=0
"RTN","MAGQBPG1",189,0)
 S UP=$O(^MAG(2005,"A"),-1)
"RTN","MAGQBPG1",190,0)
 S LP=$O(^MAG(2005,0))
"RTN","MAGQBPG1",191,0)
 S UDATE=$P($P($G(^MAG(2005,UP,2)),U,1),".")
"RTN","MAGQBPG1",192,0)
 S LDATE=$P($P($G(^MAG(2005,LP,2)),U,1),".")
"RTN","MAGQBPG1",193,0)
 Q:((ORDER="F")&(FDAY>UDATE)) ""
"RTN","MAGQBPG1",194,0)
 Q:((ORDER="R")&(FDAY<LDATE)) ""
"RTN","MAGQBPG1",195,0)
 I ORDER="F",((FDAY=LDATE)!(FDAY<LDATE)) Q LP
"RTN","MAGQBPG1",196,0)
 I ORDER="R",((FDAY=UDATE)!(FDAY>UDATE)) Q UP
"RTN","MAGQBPG1",197,0)
 F  S M=$O(^MAG(2005,((UP-LP)\2)+LP)) Q:M'?1N.N  D  Q:DONE
"RTN","MAGQBPG1",198,0)
 . S TDATE=$P($P($G(^MAG(2005,M,2)),U,1),".")
"RTN","MAGQBPG1",199,0)
 . I FDAY=TDATE S DONE="1" Q
"RTN","MAGQBPG1",200,0)
 . I FDAY>TDATE S LP=M
"RTN","MAGQBPG1",201,0)
 . E  S UP=M
"RTN","MAGQBPG1",202,0)
 . S CNT=CNT+1
"RTN","MAGQBPG1",203,0)
 . I ((UP-LP)<2) S DONE="1"
"RTN","MAGQBPG1",204,0)
 S N=M,DONE=0
"RTN","MAGQBPG1",205,0)
 I ORDER="R" D
"RTN","MAGQBPG1",206,0)
 . F  S N=$O(^MAG(2005,N)) Q:N'?1N.N  D  Q:DONE
"RTN","MAGQBPG1",207,0)
 . . I $P($P($G(^MAG(2005,N,2)),U,1),".")=FDAY S M=N
"RTN","MAGQBPG1",208,0)
 . . E  S DONE=1
"RTN","MAGQBPG1",209,0)
 I ORDER="F" D
"RTN","MAGQBPG1",210,0)
 . F  S N=$O(^MAG(2005,N),-1) Q:N'?1N.N  D  Q:DONE
"RTN","MAGQBPG1",211,0)
 . . I $P($P($G(^MAG(2005,N,2)),U,1),".")=FDAY S M=N
"RTN","MAGQBPG1",212,0)
 . . E  S DONE=1
"RTN","MAGQBPG1",213,0)
 Q M
"RTN","MAGQBPG1",214,0)
MOVE(RESULT,FNAM) ;[MAGQ MOVE]
"RTN","MAGQBPG1",215,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",216,0)
 N IEN,FTYPE,NMSPC,SITEID,EXT,ALT,J
"RTN","MAGQBPG1",217,0)
 S NMSPC=$TR($P(FNAM,"."),"0123456789","")
"RTN","MAGQBPG1",218,0)
 S SITEID=$$INIS^MAGQBPG2()
"RTN","MAGQBPG1",219,0)
 I SITEID'[(","_NMSPC_",") D  Q
"RTN","MAGQBPG1",220,0)
 . S RESULT="0^Invalid Imaging Namspace"
"RTN","MAGQBPG1",221,0)
 S IEN=$P(+$P(FNAM,NMSPC,2),".") ;NON-CONSOLIDATED VERS.
"RTN","MAGQBPG1",222,0)
 ;S IEN=$O(^MAG(2005,"F",$P(FNAM,"."),"")) ;CONSOLIDATED VERS.
"RTN","MAGQBPG1",223,0)
 I IEN'?1N.N!('$D(^MAG(2005,IEN,0))) D  Q
"RTN","MAGQBPG1",224,0)
 . S RESULT="0^No matching 2005 entry"
"RTN","MAGQBPG1",225,0)
 S EXT=$P(FNAM,".",2)
"RTN","MAGQBPG1",226,0)
 I $P($G(^MAG(2005,IEN,0)),U,2)[FNAM S RESULT=IEN_U_"FULL"
"RTN","MAGQBPG1",227,0)
 E  D
"RTN","MAGQBPG1",228,0)
 . S FTYPE=$$FTYPE^MAGQBPRG(EXT)
"RTN","MAGQBPG1",229,0)
 . I FTYPE="FULL" D  Q
"RTN","MAGQBPG1",230,0)
 . . D FTYPE^MAGQBUT(.ALT)
"RTN","MAGQBPG1",231,0)
 . . S J=""
"RTN","MAGQBPG1",232,0)
 . . F  S J=$O(ALT(J)) Q:J'?1N.N  S:ALT(J)[EXT FTYPE="ALT"
"RTN","MAGQBPG1",233,0)
 . . I FTYPE["ALT" S RESULT=IEN_U_FTYPE
"RTN","MAGQBPG1",234,0)
 . . E  S RESULT="0^Invalid File Extention"
"RTN","MAGQBPG1",235,0)
 . E  S RESULT=IEN_U_FTYPE
"RTN","MAGQBPG1",236,0)
 Q
"RTN","MAGQBPG1",237,0)
 ;
"RTN","MAGQBPRG")
0^28^B49321699
"RTN","MAGQBPRG",1,0)
MAGQBPRG ;WOIOFO/RMP Magnetic Server Purge processes [ 06/29/2001 18:28 ]
"RTN","MAGQBPRG",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGQBPRG",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPRG",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBPRG",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBPRG",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBPRG",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBPRG",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBPRG",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBPRG",10,0)
 ;; |                                                               |
"RTN","MAGQBPRG",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBPRG",12,0)
 ;; | a medical device.  As such, it may not be changed in any way  |
"RTN","MAGQBPRG",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBPRG",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBPRG",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBPRG",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPRG",17,0)
 ;;
"RTN","MAGQBPRG",18,0)
FILEREF(RESULT,FILEPATH,FNAM,EXT,NETLOC,RADHOLD) ; RPC[MAGQBP FREF]
"RTN","MAGQBPRG",19,0)
 ;VALIDATES THAT THE FILEPATH IS CONSISTENT WITH VISTA MAGFILE REFERENCE
"RTN","MAGQBPRG",20,0)
 ;SET THE SECOND PIECE TO "PACS" IF IT REPRESENTS DICOM
"RTN","MAGQBPRG",21,0)
 ;VALIDATES THAT A JUKEBOX POINTER EXISTS
"RTN","MAGQBPRG",22,0)
 ;RESULT VALUES
"RTN","MAGQBPRG",23,0)
 ;PIECE  1:-3 = FOREIGN FILE, DO NOT PURGE
"RTN","MAGQBPRG",24,0)
 ;         -2 = QUEUED FOR JUKEBOX COPY, DO NOT PURGE
"RTN","MAGQBPRG",25,0)
 ;         -1 = DO NOT PURGE
"RTN","MAGQBPRG",26,0)
 ;          0 = PURGE('MAG 2005 ENTRY)!('JUKEBOX PTRS & 'EXCEPTIONS)
"RTN","MAGQBPRG",27,0)
 ;          1 = PURGE GIVEN NORMAL DATE CRITERIA (NDC) + CONFIRMED ON JB
"RTN","MAGQBPRG",28,0)
 ;          2 = PURGE GIVEN NDC IF TGA PRESENT
"RTN","MAGQBPRG",29,0)
 ;          3 = PURGE IF FILE IS AT ALTERNATE NETWORK LOCATION SITE
"RTN","MAGQBPRG",30,0)
 ;              ELSE PURGE IF AGED & UPDATE FILE REFERENCES
"RTN","MAGQBPRG",31,0)
 ;        **4 = (**NA**)AGE PURGE IF ON JUKEBOX, UPDATE FILE REFERENCES
"RTN","MAGQBPRG",32,0)
 ;              ELSE UPDATE FILEREFENCES, QUEUE JUKEBOX COPY
"RTN","MAGQBPRG",33,0)
 ;          5 = PURGE IF AT ALTERNATE SITE,QUEUE JUKEBOX IF NOT ON JB
"RTN","MAGQBPRG",34,0)
 ;          6 = PURGE GIVEN NORMAL DATE CRITERIA
"RTN","MAGQBPRG",35,0)
 ;PIECE   2:0 = NONPACS
"RTN","MAGQBPRG",36,0)
 ;         :1 = PACS
"RTN","MAGQBPRG",37,0)
 ;PIECE    3: RECORD CATEGORY
"RTN","MAGQBPRG",38,0)
 ;         1 = 'NO 2005 ENTRY
"RTN","MAGQBPRG",39,0)
 ;         2 = RADIOLOGY HOLD
"RTN","MAGQBPRG",40,0)
 ;         3 = NO JUKEBOX/JUKEBOX PTRS
"RTN","MAGQBPRG",41,0)
 ;         4 = JUKEBOX - NO JUKEBOX PTRS (P/EXCEPT)ELSE QUEUE
"RTN","MAGQBPRG",42,0)
 ;         5 = JUKEBOX/JUKEBOX PTRS, NO CACHE PTRS,PURGE IF CONFIRMED
"RTN","MAGQBPRG",43,0)
 ;         6 = JUKEBOX/JUKEBOX PTRS, WRONG CACHE PTRS PURGE IF AT ALT
"RTN","MAGQBPRG",44,0)
 ;         7 = JUKEBOX/JUKEBOX PTRS, NO CACHE PTRS, FIX PTRS
"RTN","MAGQBPRG",45,0)
 ;         8 = JUKEBOX/JUKEBOX PTRS, CACHE PTRS, AGE (IF CONFIRMED)
"RTN","MAGQBPRG",46,0)
 ;         9 = RECORD NOT IN THE IMAGE FILE
"RTN","MAGQBPRG",47,0)
 ;        10 = FOREIGN IMAGE FILE
"RTN","MAGQBPRG",48,0)
 ;        11 = NOT AN IMAGE FILE
"RTN","MAGQBPRG",49,0)
 ;        12 = FILE LOCATION NOT VALID 
"RTN","MAGQBPRG",50,0)
 ;        13 = DELETE 2005 ENTRY (LAST LOCATION REFERENCED)
"RTN","MAGQBPRG",51,0)
 N FILEXT,IEN,SITEID,MAGXX,MAGFILE,MAGFILE1,MAGFILE2,PACS,RIEN,ZNODE
"RTN","MAGQBPRG",52,0)
 N FILETYPE,CPTR,JBPTR,CPOK,BNODE,ALTPATH,NMSPC
"RTN","MAGQBPRG",53,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPRG",54,0)
 S U="^",(MAGFILE2,RESULT)=""
"RTN","MAGQBPRG",55,0)
 S FNAM=$$UPPER^MAGQST(FNAM)
"RTN","MAGQBPRG",56,0)
 S ^TMP("MAGQ",$J,"PRG","LAST")=FILEPATH_U_FNAM_U_EXT_U_NETLOC_U_RADHOLD
"RTN","MAGQBPRG",57,0)
 I FNAM'?1.2A1.8N1"."1.3E  D  Q  ;LATER ADD EXT VERIFY USING 2005.02
"RTN","MAGQBPRG",58,0)
 . D ELOG(FNAM,FILEPATH) S RESULT="-3^^11" Q  ;'IMAGE FILE
"RTN","MAGQBPRG",59,0)
 S SITEID=$$INIS^MAGQBPG2()
"RTN","MAGQBPRG",60,0)
 S NMSPC=$TR($P(FNAM,"."),"0123456789","")
"RTN","MAGQBPRG",61,0)
 S FILEPATH=$$UPPER^MAGQST(FILEPATH)
"RTN","MAGQBPRG",62,0)
 I SITEID'[NMSPC D ELOG(FNAM,FILEPATH) S RESULT="-3^^10" Q  ;FOREIGN FILE
"RTN","MAGQBPRG",63,0)
 S IEN=$P(+$P(FNAM,NMSPC,2),".")
"RTN","MAGQBPRG",64,0)
 ;PURGE UNCONDITIONALLY IF NO 2005 ENTRY ????
"RTN","MAGQBPRG",65,0)
 I '$D(^MAG(2005,IEN,0)) D  Q
"RTN","MAGQBPRG",66,0)
 . D ELOG(FNAM,FILEPATH)
"RTN","MAGQBPRG",67,0)
 . S RESULT="0^^9^^^"_IEN
"RTN","MAGQBPRG",68,0)
 S ZNODE=^MAG(2005,IEN,0)
"RTN","MAGQBPRG",69,0)
 S FTYPE=$$FTYPE(EXT)
"RTN","MAGQBPRG",70,0)
 S BNODE=$S(FTYPE="BIG":$G(^MAG(2005,IEN,"FBIG")),1:"")
"RTN","MAGQBPRG",71,0)
 S JBPTR=$$JBPTR(IEN,FTYPE)
"RTN","MAGQBPRG",72,0)
 ; NEXT PROCESS MAGNETIC PTR~LESS
"RTN","MAGQBPRG",73,0)
 S CPTR=$$CHKCP($S(FTYPE="BIG":BNODE,1:ZNODE),FTYPE)
"RTN","MAGQBPRG",74,0)
 I 'CPTR D  Q
"RTN","MAGQBPRG",75,0)
 . D CPUPD(FTYPE,IEN,FILEPATH,FNAM)
"RTN","MAGQBPRG",76,0)
 . I 'JBPTR,$P($G(^MAG(2005.2,+$$CWP^MAGQBJB(),0)),U,6)="1" D
"RTN","MAGQBPRG",77,0)
 . . S XX=$$JUKEBOX^MAGBAPI(IEN)
"RTN","MAGQBPRG",78,0)
 . S RESULT="-1^^7^^"_JBPTR_U_IEN ;$S(JBPTR:JBPTR,1:XX)_U_IEN
"RTN","MAGQBPRG",79,0)
 S CPOK=$S('CPTR:0,1:$$CPOK(FTYPE,.ALTPATH,FILEPATH,IEN))
"RTN","MAGQBPRG",80,0)
 S ALTPATH=ALTPATH_FNAM
"RTN","MAGQBPRG",81,0)
 S RDHOLD=$S(RADHOLD:$$RDHOLD(IEN),1:0)
"RTN","MAGQBPRG",82,0)
 S PACS=$S($D(^MAG(2005,IEN,"PACS")):1,1:0)
"RTN","MAGQBPRG",83,0)
 ;
"RTN","MAGQBPRG",84,0)
 ;RULE PROCESSOR
"RTN","MAGQBPRG",85,0)
 I RDHOLD D  Q
"RTN","MAGQBPRG",86,0)
 . I CPOK S RESULT="-1^"_PACS_"^2^" Q
"RTN","MAGQBPRG",87,0)
 . ;PURGE IF@ALT SITE
"RTN","MAGQBPRG",88,0)
 . S RESULT="5^"_PACS_"^6^"_ALTPATH_U_$$JBPATH(FNAM,JBPTR)_U_IEN
"RTN","MAGQBPRG",89,0)
 I 'CPOK,JBPTR D  Q
"RTN","MAGQBPRG",90,0)
 . S RESULT="3^"_PACS_"^6^"_ALTPATH_U_$$JBPATH(FNAM,JBPTR)_U_IEN
"RTN","MAGQBPRG",91,0)
 I 'JBPTR D  Q  ;(???('CPOK,'JBPTR))
"RTN","MAGQBPRG",92,0)
 . D WXCPT(.RESULT,PACS,FTYPE)
"RTN","MAGQBPRG",93,0)
 . I $P(RESULT,U)="-2" S XX=$$JUKEBOX^MAGBAPI(IEN) Q
"RTN","MAGQBPRG",94,0)
 . S $P(RESULT,U,6)=IEN
"RTN","MAGQBPRG",95,0)
 . Q:$P(RESULT,U)'="6"
"RTN","MAGQBPRG",96,0)
 . S $P(RESULT,U,3)=$S($$LASTNP(FTYPE):"13",1:$P(RESULT,U,3))
"RTN","MAGQBPRG",97,0)
 ;ELSE CPOK & JBPTR - NO RAD HOLD
"RTN","MAGQBPRG",98,0)
 ;!!MUST ADD CONDITIONAL CONFIRM ON JBOX
"RTN","MAGQBPRG",99,0)
 S RESULT="1^"_PACS_"^8^^"_$$JBPATH(FNAM,JBPTR)_U_IEN
"RTN","MAGQBPRG",100,0)
 Q
"RTN","MAGQBPRG",101,0)
 ;
"RTN","MAGQBPRG",102,0)
LASTNP(TYPE) ;
"RTN","MAGQBPRG",103,0)
 I TYPE="BIG" Q $S($P(ZNODE,U,3,4)="^":1,1:0)
"RTN","MAGQBPRG",104,0)
 I TYPE="ABS" Q $S((($P(ZNODE,U,3)="")&($P(BNODE,U)="")):1,1:0)
"RTN","MAGQBPRG",105,0)
 Q $S((($P(ZNODE,U,4)="")&($P(BNODE,U)="")):1,1:0)
"RTN","MAGQBPRG",106,0)
JBPATH(FN,NL) ;
"RTN","MAGQBPRG",107,0)
 Q $P($G(^MAG(2005.2,NL,0)),U,2)_$$DIRHASH^MAGFILEB(FN,NL)_FN
"RTN","MAGQBPRG",108,0)
WXCPT(RESULT,XPACS,TYPE) ;Check for Worm Exceptions
"RTN","MAGQBPRG",109,0)
 ;                        when no Worm reference in 2005
"RTN","MAGQBPRG",110,0)
 ;NO JUKEBOX Q:1 ????
"RTN","MAGQBPRG",111,0)
 ;SITE PARAMETER EXCEPTIONS
"RTN","MAGQBPRG",112,0)
 ; ALL           "JBEX";1
"RTN","MAGQBPRG",113,0)
 ; ALL PACS      "JBEX";2
"RTN","MAGQBPRG",114,0)
 ; ALL PACS BIG  "JBEX";3
"RTN","MAGQBPRG",115,0)
 ; ALL PACS BIG IF TGA PRESENT ON MAGNETIC
"RTN","MAGQBPRG",116,0)
 ; ALL BIG NON PACS "JBEX";4
"RTN","MAGQBPRG",117,0)
 N PARNODE,RY
"RTN","MAGQBPRG",118,0)
 I '$D(^MAG(2006.1,1,"JBEX")) D  Q
"RTN","MAGQBPRG",119,0)
 . S $P(RESULT,U)="-2^"_XPACS_"^4"  ;NO WXCPT
"RTN","MAGQBPRG",120,0)
 S PARNODE=$G(^MAG(2006.1,1,"JBEX"))
"RTN","MAGQBPRG",121,0)
 I +$P(PARNODE,U)?1"1" S $P(RESULT,U)="6^"_XPACS_"^4" Q  ;ALL
"RTN","MAGQBPRG",122,0)
 I +$P(PARNODE,U)?1"2" S $P(RESULT,U)="6^"_XPACS_"^4" D  Q  ;ALL
"RTN","MAGQBPRG",123,0)
 . S ^XUSEC("MAG DELETE",DUZ)=""
"RTN","MAGQBPRG",124,0)
 . D DELETE^MAGGTID(.RY,IEN,0)
"RTN","MAGQBPRG",125,0)
 . S ^TMP("MAGQ",$J,IEN)=RY(0)
"RTN","MAGQBPRG",126,0)
 . K RY
"RTN","MAGQBPRG",127,0)
 I XPACS D  Q
"RTN","MAGQBPRG",128,0)
 . I $P(PARNODE,U,2) S $P(RESULT,U)="6^1^4" Q  ;ALL PACS
"RTN","MAGQBPRG",129,0)
 . I TYPE="BIG" D 
"RTN","MAGQBPRG",130,0)
 . . I +$P(PARNODE,U,3) S $P(RESULT,U)="6^1^4" Q  ;ALL BIG PACS
"RTN","MAGQBPRG",131,0)
 . . I +$P(PARNODE,U,6) S $P(RESULT,U)="2^1^4" Q  ;BIG PACS IF TGA 
"RTN","MAGQBPRG",132,0)
 . I $P(RESULT,U)="" D
"RTN","MAGQBPRG",133,0)
 . . I $P($G(^MAG(2005.2,+$$CWP^MAGQBJB(),0)),U,6)'="1" S RESULT="-1" Q
"RTN","MAGQBPRG",134,0)
 . . S RESULT="-2^1^4"
"RTN","MAGQBPRG",135,0)
 ;NON PACS
"RTN","MAGQBPRG",136,0)
 I ((TYPE="BIG")&(+$P(PARNODE,U,4))) S RESULT="6^0^4" Q
"RTN","MAGQBPRG",137,0)
 I $P($G(^MAG(2005.2,+$$CWP^MAGQBJB(),0)),U,6)'="1" S RESULT="-1^0^4" Q
"RTN","MAGQBPRG",138,0)
 S RESULT="-2^0^4"
"RTN","MAGQBPRG",139,0)
 Q
"RTN","MAGQBPRG",140,0)
 ;
"RTN","MAGQBPRG",141,0)
FTYPE(FEXT) ;
"RTN","MAGQBPRG",142,0)
 S FEXT=$$UPPER^MAGQST(FEXT)
"RTN","MAGQBPRG",143,0)
 I "^ABS^"[("^"_FEXT_"^") Q "ABS"
"RTN","MAGQBPRG",144,0)
 I "^BIG^"[("^"_FEXT_"^") Q "BIG"
"RTN","MAGQBPRG",145,0)
 Q "FULL"
"RTN","MAGQBPRG",146,0)
CHKCP(NODE,TYPE) ;
"RTN","MAGQBPRG",147,0)
 N PIECE,CP
"RTN","MAGQBPRG",148,0)
 S PIECE=$S(TYPE="ABS":4,TYPE="BIG":1,TYPE="FULL":3,1:0)
"RTN","MAGQBPRG",149,0)
 Q $P(NODE,U,PIECE)
"RTN","MAGQBPRG",150,0)
JBPTR(MAGIEN,TYPE) ;
"RTN","MAGQBPRG",151,0)
 N PTR
"RTN","MAGQBPRG",152,0)
 I TYPE="BIG" S PTR=+$P($G(^MAG(2005,MAGIEN,"FBIG")),"^",2)
"RTN","MAGQBPRG",153,0)
 E  S PTR=+$P($G(^MAG(2005,MAGIEN,0)),"^",5)
"RTN","MAGQBPRG",154,0)
 Q PTR
"RTN","MAGQBPRG",155,0)
RDHOLD(IEN) ;
"RTN","MAGQBPRG",156,0)
 N HOLD,RIEN
"RTN","MAGQBPRG",157,0)
 S RIEN=$G(^MAG(2005,IEN,2))
"RTN","MAGQBPRG",158,0)
 Q:$P(RIEN,"^",6)'=74 0
"RTN","MAGQBPRG",159,0)
 S HOLD=$G(^RARPT($P(RIEN,"^",7),"NOPURGE"))
"RTN","MAGQBPRG",160,0)
 Q $S($$UPPER^MAGQST(HOLD)="N":1,1:0)
"RTN","MAGQBPRG",161,0)
CPOK(TYPE,ALTPATH,FILEPATH,IEN) ;
"RTN","MAGQBPRG",162,0)
 N MAGXX,PIECE,NODE,LOC
"RTN","MAGQBPRG",163,0)
 S MAGXX=IEN
"RTN","MAGQBPRG",164,0)
 S PIECE=$S(TYPE="ABS":4,TYPE="BIG":1,TYPE="FULL":3,1:0)
"RTN","MAGQBPRG",165,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPRG",166,0)
 S LOC=$P($G(^MAG(2005,IEN,NODE)),U,PIECE)
"RTN","MAGQBPRG",167,0)
 Q:'LOC 0
"RTN","MAGQBPRG",168,0)
 S ALTPATH=$P($G(^MAG(2005.2,LOC,0)),U,2)_$$DIRHASH^MAGFILEB(FNAM,LOC)
"RTN","MAGQBPRG",169,0)
 Q $S(ALTPATH[FILEPATH:1,1:0)
"RTN","MAGQBPRG",170,0)
CPUPD(TYPE,IEN,FP,FN) ;
"RTN","MAGQBPRG",171,0)
 N PIECE,CP,NODE,LOC
"RTN","MAGQBPRG",172,0)
 S PIECE=$S(TYPE="ABS":4,TYPE="BIG":1,TYPE="FULL":3,1:0)
"RTN","MAGQBPRG",173,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPRG",174,0)
 S LOC=$$UNHASH(FN,FP)
"RTN","MAGQBPRG",175,0)
 I (PIECE=0)!(LOC=0) D ELOG(FN,FP) Q
"RTN","MAGQBPRG",176,0)
 S $P(^MAG(2005,IEN,NODE),U,PIECE)=LOC
"RTN","MAGQBPRG",177,0)
 Q
"RTN","MAGQBPRG",178,0)
CUPD(RESULT,FILEPATH,FILENAME,EXT,IEN) ; RPC[MAGQ CUPDTE]
"RTN","MAGQBPRG",179,0)
 N TYPE
"RTN","MAGQBPRG",180,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPRG",181,0)
 S TYPE=$$FTYPE(EXT)
"RTN","MAGQBPRG",182,0)
 D CPUPD(TYPE,IEN,FILEPATH,FILENAME)
"RTN","MAGQBPRG",183,0)
 Q
"RTN","MAGQBPRG",184,0)
UNHASH(FN,FP) ; RETURN NETWORK LOCATION NUMBER
"RTN","MAGQBPRG",185,0)
 N PATH,NAME,DELIM,SHARE,HASH
"RTN","MAGQBPRG",186,0)
 S NAME=$P(FN,".")
"RTN","MAGQBPRG",187,0)
 I $L(NAME)=8 S DELIM=$E(NAME,1,2)
"RTN","MAGQBPRG",188,0)
 E  S DELIM=$E(NAME,1,4)
"RTN","MAGQBPRG",189,0)
 I FP[("\"_DELIM_"\") S SHARE=$P(FP,"\"_DELIM_"\")_"\",HASH="Y"
"RTN","MAGQBPRG",190,0)
 E  S SHARE=FP,HASH=""
"RTN","MAGQBPRG",191,0)
 Q $$SHNAM(SHARE,HASH)
"RTN","MAGQBPRG",192,0)
ELOG(FN,FP) ;
"RTN","MAGQBPRG",193,0)
 N INDX
"RTN","MAGQBPRG",194,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPRG",195,0)
 S INDX=+$O(^TMP("MAGQ",$J,"PRG",FN,99999),-1)+1
"RTN","MAGQBPRG",196,0)
 S ^TMP("MAGQ",$J,"PRG",FN,INDX)=FN_"^"_FP
"RTN","MAGQBPRG",197,0)
 Q
"RTN","MAGQBPRG",198,0)
ELOGR(RESULT) ;[MAGQ ELOGR] - Error log report and purge
"RTN","MAGQBPRG",199,0)
 N FN,INDX,CNT
"RTN","MAGQBPRG",200,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPRG",201,0)
 S FN="",CNT=0
"RTN","MAGQBPRG",202,0)
 F  S FN=$O(^TMP("MAGQ",$J,"PRG",FN)) Q:FN=""  D
"RTN","MAGQBPRG",203,0)
 . S INDX=""
"RTN","MAGQBPRG",204,0)
 . F  S INDX=$O(^TMP("MAGQ",$J,"PRG",FN,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBPRG",205,0)
 . . S CNT=CNT+1,RESULT(CNT)=^TMP("MAGQ",$J,"PRG",FN,INDX)
"RTN","MAGQBPRG",206,0)
 S RESULT(0)=CNT
"RTN","MAGQBPRG",207,0)
 K ^TMP("MAGQ",$J,"PRG")
"RTN","MAGQBPRG",208,0)
 Q
"RTN","MAGQBPRG",209,0)
SHNAM(SHARE,HASH) ;
"RTN","MAGQBPRG",210,0)
 N NUM,ONLINE,ZNODE
"RTN","MAGQBPRG",211,0)
 S (NUM,ONLINE)=0
"RTN","MAGQBPRG",212,0)
 Q:((SHARE="")!(SHARE[":")) ""
"RTN","MAGQBPRG",213,0)
 F  S NUM=$O(^MAG(2005.2,"AC",SHARE,NUM)) Q:'NUM  D  Q:ONLINE
"RTN","MAGQBPRG",214,0)
 . S ZNODE=^MAG(2005.2,NUM,0)
"RTN","MAGQBPRG",215,0)
 . Q:'($P(ZNODE,"^",6)="1")
"RTN","MAGQBPRG",216,0)
 . Q:'($P(ZNODE,"^",8)=HASH)
"RTN","MAGQBPRG",217,0)
 . S ONLINE="1"
"RTN","MAGQBPRG",218,0)
 Q NUM
"RTN","MAGQBTM")
0^21^B94160146
"RTN","MAGQBTM",1,0)
MAGQBTM ;WOIFO/RMP - REMOTE Task SERVER Program [ 03/25/2001 11:20 ]
"RTN","MAGQBTM",2,0)
 ;;3.0;IMAGING;**1,7**;Jul 12, 2002
"RTN","MAGQBTM",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBTM",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBTM",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBTM",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBTM",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBTM",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBTM",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBTM",10,0)
 ;; |                                                               |
"RTN","MAGQBTM",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBTM",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBTM",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBTM",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBTM",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBTM",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBTM",17,0)
 ;;
"RTN","MAGQBTM",18,0)
 ;
"RTN","MAGQBTM",19,0)
ENTRY(RESULT,WSTAT,PROCESS) ;
"RTN","MAGQBTM",20,0)
 ; RPC[MAGQ ABP]
"RTN","MAGQBTM",21,0)
 N X,SYSIEN,SYSNAME,NODE,INDX,CNT,PROC,%,QPTR,QCNT,VERS,EXEDATE,WSOS
"RTN","MAGQBTM",22,0)
 D NOW^%DTC
"RTN","MAGQBTM",23,0)
 ; Initialize error trap
"RTN","MAGQBTM",24,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",25,0)
 S (SYSIEN,CNT)=0,SYSNAME=""
"RTN","MAGQBTM",26,0)
 S $P(RESULT(0),U,6)=$D(^XUSEC("MAG SYSTEM",DUZ))
"RTN","MAGQBTM",27,0)
 Q:'$P(RESULT(0),U,6)
"RTN","MAGQBTM",28,0)
 S VERS=$P(WSTAT,U,2),EXEDATE=$P(WSTAT,U,3),WSOS=$P(WSTAT,U,4)
"RTN","MAGQBTM",29,0)
 S WSTAT=$P(WSTAT,U)
"RTN","MAGQBTM",30,0)
 S SYSIEN=$O(^MAG(2006.8,"C",WSTAT,"")) ; True workstation name
"RTN","MAGQBTM",31,0)
 I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",$$UPPER^MAGQST(WSTAT),""))
"RTN","MAGQBTM",32,0)
 I 'SYSIEN D  ; Attempt to find a match from local name
"RTN","MAGQBTM",33,0)
 . N TRY
"RTN","MAGQBTM",34,0)
 . F TRY=1:1:$L(WSTAT,".") D  Q:SYSIEN?1.N
"RTN","MAGQBTM",35,0)
 . . S SYSIEN=$O(^MAG(2006.8,"C",$P(WSTAT,".",TRY),""))
"RTN","MAGQBTM",36,0)
 . . I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",$$UPPER^MAGQST($P(WSTAT,".",TRY)),""))
"RTN","MAGQBTM",37,0)
 . . Q
"RTN","MAGQBTM",38,0)
 . Q
"RTN","MAGQBTM",39,0)
 ;
"RTN","MAGQBTM",40,0)
 Q:SYSIEN=""
"RTN","MAGQBTM",41,0)
 S $P(^MAG(2006.8,SYSIEN,1),U,2)=VERS
"RTN","MAGQBTM",42,0)
 S $P(^MAG(2006.8,SYSIEN,1),U,3)=EXEDATE
"RTN","MAGQBTM",43,0)
 S $P(^MAG(2006.8,SYSIEN,1),U,4)=WSOS
"RTN","MAGQBTM",44,0)
 S ^TMP("MAGQN",$J,0)=SYSIEN_"^"_WSTAT
"RTN","MAGQBTM",45,0)
 S NODE=^MAG(2006.8,SYSIEN,0)
"RTN","MAGQBTM",46,0)
 S SYSNAME=$P(NODE,U)
"RTN","MAGQBTM",47,0)
 I SYSNAME="" D  Q
"RTN","MAGQBTM",48,0)
 . S $P(RESULT(0),U,1,2)="-1^No Background Processor parameters on system"
"RTN","MAGQBTM",49,0)
 I $P(NODE,U,12)'=1 D  Q
"RTN","MAGQBTM",50,0)
 . S $P(RESULT(0),U,1,2)="-1^Not assigned as a Background Processor"
"RTN","MAGQBTM",51,0)
 F PROC="ABSTRACT","JUKEBOX","JBTOHD","DELETE","PREFET","GCC","IMPORT" D
"RTN","MAGQBTM",52,0)
 . N FNUM,PIECE
"RTN","MAGQBTM",53,0)
 . S FNUM=$$FNUM(PROC)
"RTN","MAGQBTM",54,0)
 . S PIECE=$$GET1^DID(2006.8,FNUM,"","GLOBAL SUBSCRIPT LOCATION")
"RTN","MAGQBTM",55,0)
 . S PIECE=$P(PIECE,";",2)
"RTN","MAGQBTM",56,0)
 . I $P(NODE,U,PIECE)="1" D
"RTN","MAGQBTM",57,0)
 . . N QCNT,QPTR
"RTN","MAGQBTM",58,0)
 . . D ADD^MAGBAPI(0,PROC)
"RTN","MAGQBTM",59,0)
 . . S QPTR=$O(^MAGQUEUE(2006.031,"B",PROC,""))
"RTN","MAGQBTM",60,0)
 . . S QCNT=$P($G(^MAGQUEUE(2006.031,+QPTR,0)),U,3)
"RTN","MAGQBTM",61,0)
 . . S CNT=CNT+1
"RTN","MAGQBTM",62,0)
 . . S RESULT(CNT)=PROC_U_QCNT
"RTN","MAGQBTM",63,0)
 . . Q
"RTN","MAGQBTM",64,0)
 . Q
"RTN","MAGQBTM",65,0)
 S $P(RESULT(0),U,1,5)="0^BP List^PID: "_$$BASE^XLFUTL($J,10,16)_"^"_SYSNAME_U_WSTAT
"RTN","MAGQBTM",66,0)
 Q
"RTN","MAGQBTM",67,0)
 ;
"RTN","MAGQBTM",68,0)
FNUM(PROCESS) ;
"RTN","MAGQBTM",69,0)
 Q:PROC="ABSTRACT" 12
"RTN","MAGQBTM",70,0)
 Q:PROC="JUKEBOX" 13
"RTN","MAGQBTM",71,0)
 Q:PROC="JBTOHD" 14
"RTN","MAGQBTM",72,0)
 Q:PROC="PREFET" 15
"RTN","MAGQBTM",73,0)
 Q:PROC="IMPORT" 16
"RTN","MAGQBTM",74,0)
 Q:PROC="GCC" 17
"RTN","MAGQBTM",75,0)
 Q:PROC="DELETE" 20
"RTN","MAGQBTM",76,0)
 Q 0
"RTN","MAGQBTM",77,0)
 ;
"RTN","MAGQBTM",78,0)
GETQUE(RESULT,ACTION) ;
"RTN","MAGQBTM",79,0)
 ; RPC[MAGQ GET]
"RTN","MAGQBTM",80,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",81,0)
 D @(ACTION_"(.RESULT)")
"RTN","MAGQBTM",82,0)
 I +RESULT<0 D
"RTN","MAGQBTM",83,0)
 . D NOW^%DTC
"RTN","MAGQBTM",84,0)
 . D QSTAT($P(RESULT,U,2),$P(RESULT,U,3),ACTION)
"RTN","MAGQBTM",85,0)
 . D QPTER(ACTION,$P(RESULT,U,2))
"RTN","MAGQBTM",86,0)
 . Q
"RTN","MAGQBTM",87,0)
 Q
"RTN","MAGQBTM",88,0)
 ;
"RTN","MAGQBTM",89,0)
ABSTRACT(RESULT) ; Images that need to have abstracts
"RTN","MAGQBTM",90,0)
 D DEQUEUE("ABSTRACT",.RESULT)
"RTN","MAGQBTM",91,0)
 Q
"RTN","MAGQBTM",92,0)
 ;
"RTN","MAGQBTM",93,0)
JUKEBOX(RESULT) ; Images to be copied to the jukebox
"RTN","MAGQBTM",94,0)
 D DEQUEUE("JUKEBOX",.RESULT)
"RTN","MAGQBTM",95,0)
 Q
"RTN","MAGQBTM",96,0)
 ;
"RTN","MAGQBTM",97,0)
JBTOHD(RESULT) ;
"RTN","MAGQBTM",98,0)
 D DEQUEUE("JBTOHD",.RESULT)
"RTN","MAGQBTM",99,0)
 Q
"RTN","MAGQBTM",100,0)
 ;
"RTN","MAGQBTM",101,0)
GCC(RESULT) ;
"RTN","MAGQBTM",102,0)
 D DEQUEUE("GCC",.RESULT)
"RTN","MAGQBTM",103,0)
 Q
"RTN","MAGQBTM",104,0)
 ;
"RTN","MAGQBTM",105,0)
DELETE(RESULT) ;
"RTN","MAGQBTM",106,0)
 D DEQUEUE("DELETE",.RESULT)
"RTN","MAGQBTM",107,0)
 Q
"RTN","MAGQBTM",108,0)
 ;
"RTN","MAGQBTM",109,0)
PREFET(RESULT) ;
"RTN","MAGQBTM",110,0)
 D DEQUEUE("PREFET",.RESULT)
"RTN","MAGQBTM",111,0)
 Q
"RTN","MAGQBTM",112,0)
 ;
"RTN","MAGQBTM",113,0)
IMPORT(RESULT) ;
"RTN","MAGQBTM",114,0)
 D DEQUEUE("IMPORT",.RESULT)
"RTN","MAGQBTM",115,0)
 Q
"RTN","MAGQBTM",116,0)
 ;
"RTN","MAGQBTM",117,0)
DEQUEUE(QUE,RESULT) ;
"RTN","MAGQBTM",118,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",119,0)
 N QPTR,QPTR2,ROU,MAGIEN,ZNODE,MSG,IMQUE
"RTN","MAGQBTM",120,0)
 S QPTR2=$O(^MAGQUEUE(2006.031,"B",QUE,""))
"RTN","MAGQBTM",121,0)
 S QPTR=$S(QPTR2:$P(^MAGQUEUE(2006.031,QPTR2,0),U,2),1:"")
"RTN","MAGQBTM",122,0)
 S QPTR=$O(^MAGQUEUE(2006.03,"B",QUE,QPTR))
"RTN","MAGQBTM",123,0)
 I QPTR="" D  Q
"RTN","MAGQBTM",124,0)
 . S RESULT="0"_U_QPTR2_U_"No "_QUE_" "_QPTR2_" to process."
"RTN","MAGQBTM",125,0)
 . Q
"RTN","MAGQBTM",126,0)
 D QSTAT(QPTR,QUE_" in progress.",QUE)
"RTN","MAGQBTM",127,0)
 S ZNODE=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",128,0)
 I ZNODE="" S RESULT=-101_U_QPTR_U_"Queue Record does not exist" Q
"RTN","MAGQBTM",129,0)
 I QUE="IMPORT" D ENTRY^MAGQBIM(QPTR,QUE,QPTR2,ZNODE,.RESULT) Q
"RTN","MAGQBTM",130,0)
 S MAGIEN=$P(ZNODE,"^",7)
"RTN","MAGQBTM",131,0)
 I QUE'="DELETE",(('(+MAGIEN))!('$D(^MAG(2005,+MAGIEN,0)))!($P(ZNODE,U)'=QUE)) D  Q
"RTN","MAGQBTM",132,0)
 . I $D(^MAG(2005.1,+MAGIEN,0)) D
"RTN","MAGQBTM",133,0)
 . . S MSG="Image Record Deleted and in archive file."
"RTN","MAGQBTM",134,0)
 . . Q
"RTN","MAGQBTM",135,0)
 . E  S MSG="No valid image file number to process."
"RTN","MAGQBTM",136,0)
 . S RESULT=-101_U_QPTR_U_MSG
"RTN","MAGQBTM",137,0)
 . Q
"RTN","MAGQBTM",138,0)
 S ROU=$$RESET(QUE)
"RTN","MAGQBTM",139,0)
 I ROU="" S RESULT="-1"_U_QPTR_U_QUE_" Is an inactive process" Q
"RTN","MAGQBTM",140,0)
 D @("ENTRY^"_ROU_"(.RESULT,QPTR)")
"RTN","MAGQBTM",141,0)
 Q
"RTN","MAGQBTM",142,0)
 ;
"RTN","MAGQBTM",143,0)
QSTAT(QPTR,MESSAGE,ACTION) ; Set the completion status and date & time
"RTN","MAGQBTM",144,0)
 Q:QPTR=""
"RTN","MAGQBTM",145,0)
 Q:'$D(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",146,0)
 D NOW^%DTC
"RTN","MAGQBTM",147,0)
 I $P($G(^MAGQUEUE(2006.03,QPTR,0)),U,5)]"" D
"RTN","MAGQBTM",148,0)
 . K ^MAGQUEUE(2006.03,"C",$E($P(^MAGQUEUE(2006.03,QPTR,0),U),1,30),$E($P(^MAGQUEUE(2006.03,QPTR,0),U,5),1,30),QPTR)
"RTN","MAGQBTM",149,0)
 . Q
"RTN","MAGQBTM",150,0)
 S ^MAGQUEUE(2006.03,"C",$E($P(^MAGQUEUE(2006.03,QPTR,0),U),1,30),$E(MESSAGE,1,30),QPTR)=""
"RTN","MAGQBTM",151,0)
 S $P(^MAGQUEUE(2006.03,QPTR,0),U,5,6)=$P(MESSAGE,U)_U_%
"RTN","MAGQBTM",152,0)
 I ACTION["IMPORT" D STAT^MAGQBIM(QPTR,%,MESSAGE)
"RTN","MAGQBTM",153,0)
 Q
"RTN","MAGQBTM",154,0)
 ;
"RTN","MAGQBTM",155,0)
QPTER(QUEUE,QPTR) ;
"RTN","MAGQBTM",156,0)
 N QREC,PREV,PNODE
"RTN","MAGQBTM",157,0)
 S QREC=$O(^MAGQUEUE(2006.031,"B",QUEUE,""))
"RTN","MAGQBTM",158,0)
 S PREV=$S(QREC:$P(^MAGQUEUE(2006.031,QREC,0),U,2),1:"")
"RTN","MAGQBTM",159,0)
 I PREV'="" D  Q
"RTN","MAGQBTM",160,0)
 . I QPTR=$O(^MAGQUEUE(2006.03,"B",QUEUE,PREV)) D
"RTN","MAGQBTM",161,0)
 . . L +^MAGQUEUE(2006.031)
"RTN","MAGQBTM",162,0)
 . . D ADD^MAGBAPI(-1,QUEUE)
"RTN","MAGQBTM",163,0)
 . . S $P(^MAGQUEUE(2006.031,QREC,0),U,2)=QPTR
"RTN","MAGQBTM",164,0)
 . . L -^MAGQUEUE(2006.031)
"RTN","MAGQBTM",165,0)
 . . S PNODE=$G(^MAGQUEUE(2006.03,PREV,0))
"RTN","MAGQBTM",166,0)
 . . I +$P(PNODE,"^",5)>0 D DQUE^MAGQBUT(PREV)
"RTN","MAGQBTM",167,0)
 . . Q
"RTN","MAGQBTM",168,0)
 . Q
"RTN","MAGQBTM",169,0)
 D ADD^MAGBAPI(0,QUEUE)
"RTN","MAGQBTM",170,0)
 Q
"RTN","MAGQBTM",171,0)
 ;
"RTN","MAGQBTM",172,0)
RESET(QUEUE) ; Set Routine parameter
"RTN","MAGQBTM",173,0)
 Q:QUEUE="ABSTRACT" "MAGQBAB"
"RTN","MAGQBTM",174,0)
 Q:QUEUE="JUKEBOX" "MAGQBJB"
"RTN","MAGQBTM",175,0)
 Q:QUEUE="JBTOHD" "MAGQBJH"
"RTN","MAGQBTM",176,0)
 Q:QUEUE="DELETE" "MAGQBD"
"RTN","MAGQBTM",177,0)
 Q:QUEUE="PREFET" "MAGQBJH"
"RTN","MAGQBTM",178,0)
 Q:QUEUE="IMPORT" "MAGQBIM"
"RTN","MAGQBTM",179,0)
 Q:QUEUE="GCC" "MAGQBGCC"
"RTN","MAGQBTM",180,0)
 Q ""
"RTN","MAGQBTM",181,0)
 ;
"RTN","MAGQBTM",182,0)
RQCNT ;
"RTN","MAGQBTM",183,0)
 N QIEN,QPTR,QNAM
"RTN","MAGQBTM",184,0)
 L +^MAGQUEUE(2006.031)
"RTN","MAGQBTM",185,0)
 S QNAM=""
"RTN","MAGQBTM",186,0)
 F  S QNAM=$O(^MAGQUEUE(2006.031,"B",QNAM)) Q:QNAM=""  D
"RTN","MAGQBTM",187,0)
 . S QIEN=$O(^MAGQUEUE(2006.031,"B",QNAM,"")) Q:QIEN'?1.N
"RTN","MAGQBTM",188,0)
 . S QPTR=+$P(^MAGQUEUE(2006.031,QIEN,0),U,2)
"RTN","MAGQBTM",189,0)
 . S $P(^MAGQUEUE(2006.031,QIEN,0),U,3)=""
"RTN","MAGQBTM",190,0)
 . D ADD^MAGBAPI(0,QNAM)
"RTN","MAGQBTM",191,0)
 . S $P(^MAGQUEUE(2006.031,QIEN,0),U,2)=QPTR
"RTN","MAGQBTM",192,0)
 . Q
"RTN","MAGQBTM",193,0)
 L -^MAGQUEUE(2006.031)
"RTN","MAGQBTM",194,0)
 Q
"RTN","MAGQBTM",195,0)
 ;
"RTN","MAGQBTM",196,0)
QUPDTE(RESULT,QPTR,UPDATE) ;
"RTN","MAGQBTM",197,0)
 ; RPC[MAGQ QUD]
"RTN","MAGQBTM",198,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",199,0)
 N NODE,STAT,TYPE,VPTR,MPTR,IEN,IDFN
"RTN","MAGQBTM",200,0)
 S NODE=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",201,0)
 S RESULT="1^QUEUE UPDATE COMPLETE"
"RTN","MAGQBTM",202,0)
 S STAT=$P(UPDATE,U)
"RTN","MAGQBTM",203,0)
 S TYPE=$P(NODE,U)
"RTN","MAGQBTM",204,0)
 I TYPE="" D QRUPT(QPTR,.RESULT,NODE) Q
"RTN","MAGQBTM",205,0)
 D QSTAT(QPTR,$S(STAT<0:$P(UPDATE,U,2),1:STAT),TYPE)
"RTN","MAGQBTM",206,0)
 D QPTER(TYPE,QPTR)
"RTN","MAGQBTM",207,0)
 I STAT<0 Q
"RTN","MAGQBTM",208,0)
 I "^DELETE^"[("^"_TYPE_"^") D DQUE^MAGQBUT(QPTR) Q
"RTN","MAGQBTM",209,0)
 S VPTR=$P(UPDATE,U,3)
"RTN","MAGQBTM",210,0)
 I VPTR?1.N D
"RTN","MAGQBTM",211,0)
 . S MPTR=$P(NODE,U,7)
"RTN","MAGQBTM",212,0)
 . I "^ABSTRACT^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBTM",213,0)
 . . I $P(UPDATE,"^")["TIF" S $P(^MAG(2005,MPTR,0),U,3)=VPTR
"RTN","MAGQBTM",214,0)
 . . E  S $P(^MAG(2005,MPTR,0),U,4)=VPTR
"RTN","MAGQBTM",215,0)
 . . S X=$$JUKEBOX^MAGBAPI(MPTR)
"RTN","MAGQBTM",216,0)
 . . D DQUE^MAGQBUT(QPTR)
"RTN","MAGQBTM",217,0)
 . . Q
"RTN","MAGQBTM",218,0)
 . I ("^JBTOHD^"[("^"_TYPE_"^"))!("^PREFET^"[("^"_TYPE_"^")) D  Q
"RTN","MAGQBTM",219,0)
 . . I "^FULL^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,0),U,3)=VPTR
"RTN","MAGQBTM",220,0)
 . . I "^ABSTRACT^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,0),U,4)=VPTR
"RTN","MAGQBTM",221,0)
 . . I "^BIG^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,"FBIG"),U)=VPTR
"RTN","MAGQBTM",222,0)
 . . D DQUE^MAGQBUT(QPTR)
"RTN","MAGQBTM",223,0)
 . . Q
"RTN","MAGQBTM",224,0)
 . I "^JUKEBOX^"[("^"_TYPE_"^") D  Q 
"RTN","MAGQBTM",225,0)
 . . I $P(UPDATE,U,2)["BIG" S $P(^MAG(2005,MPTR,"FBIG"),U,2)=VPTR
"RTN","MAGQBTM",226,0)
 . . E  S $P(^MAG(2005,MPTR,0),U,5)=VPTR
"RTN","MAGQBTM",227,0)
 . . D DQUE^MAGQBUT(QPTR)  ;I STAT=3
"RTN","MAGQBTM",228,0)
 . . Q
"RTN","MAGQBTM",229,0)
 . I "^GCC^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBTM",230,0)
 . . D NOW^%DTC
"RTN","MAGQBTM",231,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",.01)=VPTR
"RTN","MAGQBTM",232,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",1)=%
"RTN","MAGQBTM",233,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",2)=$P($$TRIM^MAGQST($P(UPDATE,U,2))," ")
"RTN","MAGQBTM",234,0)
 . . D UPDATE^DIE("U","FDA","","MAGIMP")
"RTN","MAGQBTM",235,0)
 . . S IDFN=$P(^MAG(2005,MPTR,0),U,7)
"RTN","MAGQBTM",236,0)
 . . D ENTRY^MAGLOG("EXPORT->"_$P($G(^MAG(2005.2,VPTR,0)),U,2),$P(NODE,U,2),MPTR,"Document Imaging",IDFN,0)
"RTN","MAGQBTM",237,0)
 . . Q
"RTN","MAGQBTM",238,0)
 . Q
"RTN","MAGQBTM",239,0)
 Q
"RTN","MAGQBTM",240,0)
 ;
"RTN","MAGQBTM",241,0)
QRUPT(PTR,RESULT,NODE) ; Delete corrupt 2006.03 entry/update next queue ptr prn
"RTN","MAGQBTM",242,0)
 N %,TYPE,DONE,QIEN,MSG
"RTN","MAGQBTM",243,0)
 D NOW^%DTC
"RTN","MAGQBTM",244,0)
 I $D(^MAG(2005.1,PTR)) D
"RTN","MAGQBTM",245,0)
 . S MSG="Image Record Deleted and in archive file: "
"RTN","MAGQBTM",246,0)
 . Q
"RTN","MAGQBTM",247,0)
 E  S MSG="Queue record corrupted: "
"RTN","MAGQBTM",248,0)
 S RESULT="-1^"_PTR_"^"_MSG_NODE
"RTN","MAGQBTM",249,0)
 D QSTAT(PTR,"QUEUE RECORD CORRUPTED","DON'T KNOW")
"RTN","MAGQBTM",250,0)
 S ^TMP("MAGQ",$J,"QRUPT",PTR,%)=RESULT_U_NODE
"RTN","MAGQBTM",251,0)
 S (TYPE,DONE)=""
"RTN","MAGQBTM",252,0)
 F  S TYPE=$O(^MAGQUEUE(2006.031,"B",TYPE)) Q:TYPE=""  D  Q:DONE
"RTN","MAGQBTM",253,0)
 . I $D(^MAGQUEUE(2006.03,"B",TYPE,PTR)) D 
"RTN","MAGQBTM",254,0)
 . . S $P(^MAGQUEUE(2006.03,PTR,0),U)=TYPE,DONE=1
"RTN","MAGQBTM",255,0)
 . . Q
"RTN","MAGQBTM",256,0)
 . Q
"RTN","MAGQBTM",257,0)
 I 'DONE ;K ^MAGQUEUE(2006.03,PTR,0)
"RTN","MAGQBTM",258,0)
 Q
"RTN","MAGQBTM",259,0)
 ;
"RTN","MAGQBTM",260,0)
REQUE(RESULT,QPTR) ;
"RTN","MAGQBTM",261,0)
 ; RPC[MAGQ REQ]
"RTN","MAGQBTM",262,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",263,0)
 N PROC,NODE,INDX,PARAM,OPDUZ,STATUS,TRACKID
"RTN","MAGQBTM",264,0)
 S INDX=$$TRIM^MAGQST(QPTR),TRACKID=0
"RTN","MAGQBTM",265,0)
 S NODE=$G(^MAGQUEUE(2006.03,INDX,0))
"RTN","MAGQBTM",266,0)
 Q:NODE=""
"RTN","MAGQBTM",267,0)
 S PROC=$P(NODE,U),STATUS=$P(NODE,U,5)
"RTN","MAGQBTM",268,0)
 I PROC'="IMPORT" D
"RTN","MAGQBTM",269,0)
 . D RQP(PROC,NODE,.PARAM)
"RTN","MAGQBTM",270,0)
 . S @("RESULT=$$"_PROC_"^MAGBAPI(PARAM)")
"RTN","MAGQBTM",271,0)
 . Q
"RTN","MAGQBTM",272,0)
 E  D
"RTN","MAGQBTM",273,0)
 . S $P(PARAM,U,4)=$S($P(NODE,U,11)?1N.N:$P(NODE,U,11),1:QPTR)
"RTN","MAGQBTM",274,0)
 . D TIDL^MAGQBIM($S($P(NODE,U,11)?1N.N:$P(NODE,U,11),1:QPTR),PROC,.TRACKID)
"RTN","MAGQBTM",275,0)
 . Q:TRACKID=0
"RTN","MAGQBTM",276,0)
 . S @("RESULT=$$"_PROC_"^MAGBAPI(PARAM,$P(NODE,U,10),TRACKID)")
"RTN","MAGQBTM",277,0)
 I RESULT?1.N,STATUS'="" D
"RTN","MAGQBTM",278,0)
 . S $P(^MAGQUEUE(2006.03,RESULT,0),U,5)=STATUS
"RTN","MAGQBTM",279,0)
 . S ^MAGQUEUE(2006.03,"C",PROC,$E(STATUS,1,30),RESULT)=""
"RTN","MAGQBTM",280,0)
 . Q
"RTN","MAGQBTM",281,0)
 Q:((PROC="IMPORT")&(TRACKID=0))
"RTN","MAGQBTM",282,0)
 D DQUE^MAGQBUT(INDX)
"RTN","MAGQBTM",283,0)
 Q
"RTN","MAGQBTM",284,0)
 ;
"RTN","MAGQBTM",285,0)
RQP(P,N,PAR) ;
"RTN","MAGQBTM",286,0)
 N P1,P2,P3,P4
"RTN","MAGQBTM",287,0)
 I ("^JBTOHD^PREFET^")[P S P1=$P(N,U,7),P2=$P(N,U,8),P3=+$P(N,U,9)+1,PAR=P1_U_P2_U_P3 Q
"RTN","MAGQBTM",288,0)
 I P["DELETE" S P1=$P(N,U,10)_"^^",P2=+$P(N,U,9)+1,PAR=P1_P2 Q
"RTN","MAGQBTM",289,0)
 I P["GCC" D  Q
"RTN","MAGQBTM",290,0)
 . S P1=$P(N,U,7),P2=$P(N,U,10),P3=$P(N,U,11),P4=$P(N,U,9)+1,PAR=P1_U_P2_U_P3_U_P4 Q
"RTN","MAGQBTM",291,0)
 S P1=$P(N,U,7)_"^^",P2=+$P(N,U,9)+1,PAR=P1_P2 ;JUKEBOX + ABSTRACT
"RTN","MAGQBTM",292,0)
 Q
"RTN","MAGQBTM",293,0)
ERR ;
"RTN","MAGQBTM",294,0)
 N ERRXX
"RTN","MAGQBTM",295,0)
 S ERRXX=$$EC^%ZOSV
"RTN","MAGQBTM",296,0)
 D ^%ZTER
"RTN","MAGQBTM",297,0)
 D ^XUSCLEAN
"RTN","MAGQBTM",298,0)
 Q
"RTN","MAGQBTM",299,0)
 ;
"RTN","MAGQBUT")
0^22^B48557005
"RTN","MAGQBUT",1,0)
MAGQBUT ;WOIFO/RMP - Imaging Background Processor Utilities [ 03/25/2001 11:20 ]
"RTN","MAGQBUT",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGQBUT",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT",10,0)
 ;; |                                                               |
"RTN","MAGQBUT",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT",17,0)
 ;;
"RTN","MAGQBUT",18,0)
FTYPE(RESULT) ;
"RTN","MAGQBUT",19,0)
 ; RPC[MAGQ FTYPE]
"RTN","MAGQBUT",20,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT",21,0)
 N MAX,INDX
"RTN","MAGQBUT",22,0)
 S U="^",MAX=$P(^MAG(2006.1,1,2,0),U,4),INDX=0
"RTN","MAGQBUT",23,0)
 Q:+MAX<1
"RTN","MAGQBUT",24,0)
 F  S INDX=$O(^MAG(2006.1,1,2,INDX)) Q:INDX'?1N.N  D  Q:INDX=MAX
"RTN","MAGQBUT",25,0)
 . S RESULT(INDX-1)=$G(^MAG(2006.1,1,2,INDX,0))
"RTN","MAGQBUT",26,0)
 Q
"RTN","MAGQBUT",27,0)
CHGSERV(RESULT) ;
"RTN","MAGQBUT",28,0)
 ; RPC[MAGQ FS CHNGE]
"RTN","MAGQBUT",29,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT",30,0)
 N INDX,SPACE,DATA,IEN,SIZE,CWL,MIN,CNT,TNODE,TINT,NOW,TLTIME,TOD
"RTN","MAGQBUT",31,0)
 S U="^",(INDX,SPACE,SIZE,CNT)=0,IEN=""
"RTN","MAGQBUT",32,0)
 S MIN=$$SPARM
"RTN","MAGQBUT",33,0)
 S CWL=$G(^MAG(2006.1,"ARITE"))
"RTN","MAGQBUT",34,0)
 S DATA=$S(CWL?1N.N:$G(^MAG(2005.2,CWL,0)),1:0)
"RTN","MAGQBUT",35,0)
 I $P($G(^MAG(2006.1,1,1)),U,10),$$MAXSP(CWL,SPACE,SIZE,DATA,MIN) D  Q
"RTN","MAGQBUT",36,0)
 . S RESULT=1
"RTN","MAGQBUT",37,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT",38,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBUT",39,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBUT",40,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBUT",41,0)
 . I $P(DATA,U,8)'="Y",$$HFIND($P(DATA,"^",2),INDX) Q
"RTN","MAGQBUT",42,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBUT",43,0)
 . Q:$E($P(DATA,U,2),1,2)'="\\"
"RTN","MAGQBUT",44,0)
 . S CNT=CNT+1
"RTN","MAGQBUT",45,0)
 . I $$MAXSP(INDX,.SPACE,.SIZE,DATA,MIN) S IEN=INDX
"RTN","MAGQBUT",46,0)
 ; SET THE CURRENT WRITE LOCATION = IEN HERE
"RTN","MAGQBUT",47,0)
 I IEN D  ;NEED TO PARAMETER DRIVE THIS PROCESS !!!!!
"RTN","MAGQBUT",48,0)
 . S ^MAG(2006.1,"ARITE")=IEN,$P(^MAG(2006.1,1,0),U,3)=IEN
"RTN","MAGQBUT",49,0)
 . S ^MAG(2006.1,"APXWRITE")=IEN,$P(^MAG(2006.1,1,"PACS"),U,3)=IEN
"RTN","MAGQBUT",50,0)
 I SIZE>0,(((SPACE/SIZE)*100)>MIN) S RESULT=1
"RTN","MAGQBUT",51,0)
 E  D  Q  ;Trigger a message
"RTN","MAGQBUT",52,0)
 . N TN S RESULT=0,TN=^MAG(2006.1,1,3)
"RTN","MAGQBUT",53,0)
 . Q:$$FMADD^XLFDT($P(TN,"^",11),"",$P(TN,"^",7),"","")>$$NOW^XLFDT
"RTN","MAGQBUT",54,0)
 . D ICCL^MAGQBUT1(CNT,$P(TN,"^",7)_" hours.") Q
"RTN","MAGQBUT",55,0)
 S $P(RESULT,U,2,3)=$P(^MAG(2005.2,$G(^MAG(2006.1,"ARITE")),0),1,2)
"RTN","MAGQBUT",56,0)
 S TNODE=^MAG(2006.1,1,3)
"RTN","MAGQBUT",57,0)
 S TINT=$P(TNODE,"^",8) I "^W^D^"[("^"_TINT_"^") D  ;CONDITIONAL PURGE
"RTN","MAGQBUT",58,0)
 . S NOW=$$NOW^XLFDT,TOD=$P(TNODE,"^",9)
"RTN","MAGQBUT",59,0)
 . Q:NOW<$$FMADD^XLFDT($P(NOW,"."),"",TOD,"","")
"RTN","MAGQBUT",60,0)
 . S TLTIME=$P(TNODE,"^",10)
"RTN","MAGQBUT",61,0)
 . I NOW>$$FMADD^XLFDT(TLTIME,$S(TINT="D":1,TINT="W":7),"","","") D
"RTN","MAGQBUT",62,0)
 . . S $P(RESULT,"^",4)="PURGE"
"RTN","MAGQBUT",63,0)
 Q
"RTN","MAGQBUT",64,0)
MAXSP(IEN,FS,SZ,NODE,MIN) ;
"RTN","MAGQBUT",65,0)
 N SPACE,SIZE
"RTN","MAGQBUT",66,0)
 S SPACE=+$P(NODE,U,5),SIZE=+$P(NODE,U,3)
"RTN","MAGQBUT",67,0)
 I SIZE>0,(((SPACE/SIZE)*100)>MIN),SPACE>FS D  Q 1
"RTN","MAGQBUT",68,0)
 . S FS=SPACE,SZ=SIZE
"RTN","MAGQBUT",69,0)
 Q 0
"RTN","MAGQBUT",70,0)
HFIND(SHARE,IEN) ;HASHED SHARE AT THE SAME LOCATION
"RTN","MAGQBUT",71,0)
 N INDEX,NODE
"RTN","MAGQBUT",72,0)
 S INDEX=0,RESULT=""
"RTN","MAGQBUT",73,0)
 F  S INDEX=$O(^MAG(2005.2,"AC",SHARE,INDEX)) Q:INDEX'?1N.N  D
"RTN","MAGQBUT",74,0)
 . Q:INDEX=IEN
"RTN","MAGQBUT",75,0)
 . I $P(^MAG(2005.2,INDEX,0),"^",8)="Y" S RESULT=1
"RTN","MAGQBUT",76,0)
 Q RESULT
"RTN","MAGQBUT",77,0)
SPARM() ;Site Parameter for PERCENT server space to be held in reserve
"RTN","MAGQBUT",78,0)
 N VALUE
"RTN","MAGQBUT",79,0)
 S VALUE=$P($G(^MAG(2006.1,1,1)),U,8)
"RTN","MAGQBUT",80,0)
 Q $S(VALUE>0:VALUE,1:5)
"RTN","MAGQBUT",81,0)
BUTERR ;Background Processor Utility Error trap
"RTN","MAGQBUT",82,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGQBUT",83,0)
 Q
"RTN","MAGQBUT",84,0)
SLAD(RESULT) ;SITE LAST ACCESS DATE(DEFAULT TO 180)
"RTN","MAGQBUT",85,0)
 S RESULT=$S(+$P(^MAG(2006.1,1,1),"^",2):+$P(^MAG(2006.1,1,1),"^",2),1:180)
"RTN","MAGQBUT",86,0)
 Q
"RTN","MAGQBUT",87,0)
DQUE(QIEN) ;
"RTN","MAGQBUT",88,0)
 N ZNODE,TYPE,MAGIEN,QREC
"RTN","MAGQBUT",89,0)
 S U="^"
"RTN","MAGQBUT",90,0)
 S ZNODE=$G(^MAGQUEUE(2006.03,QIEN,0))
"RTN","MAGQBUT",91,0)
 S TYPE=$P(ZNODE,U)
"RTN","MAGQBUT",92,0)
 I TYPE="" D DBQ(QIEN) Q
"RTN","MAGQBUT",93,0)
 S QREC=$O(^MAGQUEUE(2006.031,"B",TYPE,""))
"RTN","MAGQBUT",94,0)
 I QREC,$P($G(^MAGQUEUE(2006.031,QREC,0)),U,2)=QIEN Q  ;'DELETE LPROC YET
"RTN","MAGQBUT",95,0)
 K ^MAGQUEUE(2006.03,"B",$P(ZNODE,U),QIEN)
"RTN","MAGQBUT",96,0)
 K ^MAGQUEUE(2006.03,QIEN,0)
"RTN","MAGQBUT",97,0)
 I $P(ZNODE,U,5)]"" D
"RTN","MAGQBUT",98,0)
 . K ^MAGQUEUE(2006.03,"C",TYPE,$E($P(ZNODE,U,5),1,30),QIEN)
"RTN","MAGQBUT",99,0)
 L +^MAGQUEUE(2006.03,0)
"RTN","MAGQBUT",100,0)
 S $P(^MAGQUEUE(2006.03,0),"^",4)=$P(^MAGQUEUE(2006.03,0),"^",4)-1
"RTN","MAGQBUT",101,0)
 L -^MAGQUEUE(2006.03,0)
"RTN","MAGQBUT",102,0)
 Q:TYPE="DELETE"
"RTN","MAGQBUT",103,0)
 S MAGIEN=$P(ZNODE,U,7)
"RTN","MAGQBUT",104,0)
 Q:MAGIEN'?1N.N
"RTN","MAGQBUT",105,0)
 I TYPE="JUKEBOX" D  Q
"RTN","MAGQBUT",106,0)
 . K ^MAGQUEUE(2006.03,"JX",MAGIEN,QIEN)
"RTN","MAGQBUT",107,0)
 I "^JBTOHD^PREFET^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBUT",108,0)
 . Q:'$P(ZNODE,U,8)
"RTN","MAGQBUT",109,0)
 . K ^MAGQUEUE(2006.03,"JD",MAGIEN,$P(ZNODE,U,8),QIEN)
"RTN","MAGQBUT",110,0)
 Q
"RTN","MAGQBUT",111,0)
DQUE1(RESULT,QIEN) ;[MAGQB QUEDEL]
"RTN","MAGQBUT",112,0)
 D DQUE(QIEN)
"RTN","MAGQBUT",113,0)
 Q
"RTN","MAGQBUT",114,0)
DBQ(QIEN) ;
"RTN","MAGQBUT",115,0)
 N INDX
"RTN","MAGQBUT",116,0)
 F INDX="DELETE","ABSTRACT","JUKEBOX","JBTOHD","PREFET","IMPORT" D
"RTN","MAGQBUT",117,0)
 . K ^MAGQUEUE(2006.03,"B",INDX,QIEN)
"RTN","MAGQBUT",118,0)
 K ^MAGQUEUE(2006.03,QIEN,0)
"RTN","MAGQBUT",119,0)
 Q
"RTN","MAGQBUT",120,0)
JBQUE(RESULT,QIEN) ; RPC[MAGQBP JBQUE]
"RTN","MAGQBUT",121,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT",122,0)
 S RESULT=$$JUKEBOX^MAGBAPI(QIEN)
"RTN","MAGQBUT",123,0)
 Q
"RTN","MAGQBUT",124,0)
POSTI ;
"RTN","MAGQBUT",125,0)
 D INI^MAGUSIT
"RTN","MAGQBUT",126,0)
 N DIC,X,DA,Y,NODE1,NODE3
"RTN","MAGQBUT",127,0)
 S DIC="^MAG(2006.1,1,2,",DIC(0)="XL",X="TXT",DLAYGO="2006.112"
"RTN","MAGQBUT",128,0)
 S DA(1)=1,DIC("P")="2006.112"
"RTN","MAGQBUT",129,0)
 D ^DIC
"RTN","MAGQBUT",130,0)
 ;File retention parameters defaults 45 - non abs /120 abs
"RTN","MAGQBUT",131,0)
 ;autowrite location update defaulted to ON
"RTN","MAGQBUT",132,0)
 S (DIE,DIC,DLAYGO)=2006.1,DA=1,DIC(0)="XL"
"RTN","MAGQBUT",133,0)
 S NODE1=$G(^MAG(2006.1,1,1)),NODE3=$G(^MAG(2006.1,1,3)),DR=""
"RTN","MAGQBUT",134,0)
 S KEYS=$G(^MAG(2006.1,1,"KEYS"))
"RTN","MAGQBUT",135,0)
 S DR=$S(($P(NODE1,"^",2)'?1N.N):"8///45",1:DR)
"RTN","MAGQBUT",136,0)
 I ($P(NODE1,"^",5)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"9///45"
"RTN","MAGQBUT",137,0)
 I ($P(NODE1,"^",10)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"20///1"
"RTN","MAGQBUT",138,0)
 I ($P(NODE3,"^",1)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"21///45"
"RTN","MAGQBUT",139,0)
 I ($P(NODE3,"^",2)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"22///45"
"RTN","MAGQBUT",140,0)
 I ($P(NODE3,"^",3)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"23///120"
"RTN","MAGQBUT",141,0)
 I ($P(NODE3,"^",4)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"24///120"
"RTN","MAGQBUT",142,0)
 I ($P(NODE3,"^",5)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"102///10"
"RTN","MAGQBUT",143,0)
 I ($P(NODE3,"^",6)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"103///15"
"RTN","MAGQBUT",144,0)
 I ($P(NODE3,"^",7)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"11.5///6"
"RTN","MAGQBUT",145,0)
 I ($P(NODE3,"^",8)="") S DR=DR_$S((DR["/"):";",1:"")_"11.6///O"
"RTN","MAGQBUT",146,0)
 I ($P(NODE3,"^",9)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"11.7///4"
"RTN","MAGQBUT",147,0)
 I ($P(NODE3,"^",10)'?1N.E) D
"RTN","MAGQBUT",148,0)
 . S DR=DR_$S((DR["/"):";",1:"")_"11.8///"_$$NOW^XLFDT
"RTN","MAGQBUT",149,0)
 I ($P(NODE3,"^",11)'?1N.E) D
"RTN","MAGQBUT",150,0)
 . S DR=DR_$S((DR["/"):";",1:"")_"11.9///"_$$NOW^XLFDT
"RTN","MAGQBUT",151,0)
 I ($P(KEYS,"^",2)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"121///60"
"RTN","MAGQBUT",152,0)
 I ($P(KEYS,"^",3)'?1N.N) S DR=DR_$S((DR["/"):";",1:"")_"122///90"
"RTN","MAGQBUT",153,0)
 D ^DIE
"RTN","MAGQBUT",154,0)
 ; Enable the Imaging Health Summary component
"RTN","MAGQBUT",155,0)
 I $D(^GMT(142.1,235)) D
"RTN","MAGQBUT",156,0)
 . S (DIE,DIC)=142.1,DA=235
"RTN","MAGQBUT",157,0)
 . S DR="5///@;8///@"
"RTN","MAGQBUT",158,0)
 . D ^DIE
"RTN","MAGQBUT",159,0)
 K DIE,DIC,DA,Y,X,DLAYGO
"RTN","MAGQBUT",160,0)
 ; ESTABLISH LOCAL MAIL GROUP
"RTN","MAGQBUT",161,0)
 D MMGRP^MAGQAI
"RTN","MAGQBUT",162,0)
 D SILENT^MAGDROUT
"RTN","MAGQBUT",163,0)
 Q
"RTN","MAGQBUT",164,0)
X1 ; CLEANUP OLD FAILED JUKEBOX AND JBTOHD QUEUE ENTRYS
"RTN","MAGQBUT",165,0)
 S DIR(0)="Y",DIR("B")="YES"
"RTN","MAGQBUT",166,0)
 S DIR("?")="This activity removes already processed queues which precede the current queue pointer.  These queues are not necessary for file recovery.The current BP software will recover files during purge or by the verify."
"RTN","MAGQBUT",167,0)
 S DIR("A")="Do you wish to remove old processed Background Processor Queues" D
"RTN","MAGQBUT",168,0)
 . D ^DIR Q:($D(DIRUT)!(Y'="1"))
"RTN","MAGQBUT",169,0)
 . F PC="JUKEBOX","JBTOHD","PREFET","IMPORT" D FOQUE(PC)
"RTN","MAGQBUT",170,0)
 ; REINDEX FIELD 4 (COMPLETION STATUS) IN FILE 2006.03 (QUEUE)
"RTN","MAGQBUT",171,0)
 K ^MAGQUEUE(2006.03,"C")
"RTN","MAGQBUT",172,0)
 S DIK="^MAGQUEUE(2006.03,",DIK(1)="4^C"
"RTN","MAGQBUT",173,0)
 D ENALL^DIK K DIK
"RTN","MAGQBUT",174,0)
 Q
"RTN","MAGQBUT",175,0)
FOQUE(PROC) ;PASS A BP PROCESS TO DELETE OLD FAILED QUEUES
"RTN","MAGQBUT",176,0)
 N XX,JXMAX,JHMAX,QIEN
"RTN","MAGQBUT",177,0)
 S QIEN=$O(^MAGQUEUE(2006.031,"B",PROC,""))
"RTN","MAGQBUT",178,0)
 I QIEN?1N.N D
"RTN","MAGQBUT",179,0)
 . S JXMAX=$P($G(^MAGQUEUE(2006.031,QIEN,0)),"^",2)
"RTN","MAGQBUT",180,0)
 . Q:JXMAX'?1N.N 
"RTN","MAGQBUT",181,0)
 . S JXMAX=$O(^MAGQUEUE(2006.03,"B",PROC,JXMAX),-1)
"RTN","MAGQBUT",182,0)
 . Q:JXMAX'?1N.N
"RTN","MAGQBUT",183,0)
 . S XX=0
"RTN","MAGQBUT",184,0)
 . F  S XX=$O(^MAGQUEUE(2006.03,"B",PROC,XX)) Q:XX>(JXMAX-1)  D
"RTN","MAGQBUT",185,0)
 . . I $P($G(^MAGQUEUE(2006.03,XX,0)),"^",5)'="" D DQUE(XX)
"RTN","MAGQBUT1")
0^23^B66561900
"RTN","MAGQBUT1",1,0)
MAGQBUT1 ;WOIFO/RP; Utilities for Background [ 03/25/2001 11:20 ]
"RTN","MAGQBUT1",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGQBUT1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT1",10,0)
 ;; |                                                               |
"RTN","MAGQBUT1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT1",17,0)
 ;;
"RTN","MAGQBUT1",18,0)
 Q
"RTN","MAGQBUT1",19,0)
BPPS(INPUT,WS,PROCESS) ;INPUT TRANSFORM FOR FILE 2006.8
"RTN","MAGQBUT1",20,0)
 N IEN,FND,WSNAME,WSNAME2,ZNODE,PIECE,MAGX,MAGY
"RTN","MAGQBUT1",21,0)
 S U="^"
"RTN","MAGQBUT1",22,0)
 Q:'(+$P($G(^MAG(2006.8,WS,0)),U,12)) 0  ;NOT A BACKGROUND PROCESSOR
"RTN","MAGQBUT1",23,0)
 Q:'INPUT 1
"RTN","MAGQBUT1",24,0)
 S WSNAME=$$UPPER^MAGQST($P($G(^MAG(2006.8,WS,1)),U))
"RTN","MAGQBUT1",25,0)
 Q:$L(WSNAME)<3 0 ;BP WS NOT PROPERLY INSTALLED
"RTN","MAGQBUT1",26,0)
 Q:$O(^MAG(2006.8,"C",WSNAME,""))'?1N.N 0
"RTN","MAGQBUT1",27,0)
 F MAGX=12,13,14,15,16,20,24,25 D  Q:MAGY=PROCESS
"RTN","MAGQBUT1",28,0)
 . S MAGY=$$GET1^DID(2006.8,MAGX,"","LABEL")
"RTN","MAGQBUT1",29,0)
 . D:MAGY=PROCESS
"RTN","MAGQBUT1",30,0)
 . . S PIECE=$$GET1^DID(2006.8,MAGX,"","GLOBAL SUBSCRIPT LOCATION")
"RTN","MAGQBUT1",31,0)
 Q:MAGY'=PROCESS 0
"RTN","MAGQBUT1",32,0)
 S PIECE=$P(PIECE,";",2)
"RTN","MAGQBUT1",33,0)
 S IEN=0,WSNAME2="",FND=0
"RTN","MAGQBUT1",34,0)
 F  S WSNAME2=$$UPPER^MAGQST($O(^MAG(2006.8,"C",WSNAME2))) Q:WSNAME2=""  D  Q:FND
"RTN","MAGQBUT1",35,0)
 . Q:WSNAME2=WSNAME
"RTN","MAGQBUT1",36,0)
 . ;Q:($E(WSNAME2,1,3)'=$E(WSNAME,1,3))
"RTN","MAGQBUT1",37,0)
 . S IEN=$O(^MAG(2006.8,"C",WSNAME2,"")) Q:IEN'?1N.N
"RTN","MAGQBUT1",38,0)
 . S ZNODE=$G(^MAG(2006.8,IEN,0))
"RTN","MAGQBUT1",39,0)
 . Q:$P(ZNODE,"^",12)'="1"
"RTN","MAGQBUT1",40,0)
 . S:($P(ZNODE,"^",PIECE)="1") FND="1"
"RTN","MAGQBUT1",41,0)
 Q $S(FND="1":0,1:1)
"RTN","MAGQBUT1",42,0)
BPCLR(X) ;
"RTN","MAGQBUT1",43,0)
 N PIECE
"RTN","MAGQBUT1",44,0)
 F PIECE=13,14,15,16,17,23 D
"RTN","MAGQBUT1",45,0)
 . S $P(^MAG(2006.8,X,0),"^",PIECE)="0"
"RTN","MAGQBUT1",46,0)
 Q
"RTN","MAGQBUT1",47,0)
BPQSL(RESULT,TYPE) ;
"RTN","MAGQBUT1",48,0)
 N STATUS,CNT,IEN,CP
"RTN","MAGQBUT1",49,0)
 S STATUS="",CNT=0
"RTN","MAGQBUT1",50,0)
 F  S STATUS=$O(^MAGQUEUE(2006.03,"C",TYPE,STATUS)) Q:STATUS=""  D
"RTN","MAGQBUT1",51,0)
 . Q:+STATUS>0
"RTN","MAGQBUT1",52,0)
 . S IEN=$O(^MAGQUEUE(2006.03,"C",TYPE,STATUS,""))
"RTN","MAGQBUT1",53,0)
 . S CP=$P(^MAGQUEUE(2006.031,$O(^MAGQUEUE(2006.031,"B",TYPE,"")),0),"^",2)
"RTN","MAGQBUT1",54,0)
 . Q:IEN>(CP)
"RTN","MAGQBUT1",55,0)
 . S CNT=CNT+1,RESULT(CNT)=STATUS
"RTN","MAGQBUT1",56,0)
 Q
"RTN","MAGQBUT1",57,0)
BPPNQ(RESULT) ;[MAGQB PURNUL]
"RTN","MAGQBUT1",58,0)
 N INDEX,ZNODE,PREFIX,STATUS
"RTN","MAGQBUT1",59,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT1",60,0)
 S INDEX=0,RESULT="1",PREFIX=$P($G(^MAG(2006.1,1,0)),"^",2)
"RTN","MAGQBUT1",61,0)
 F  S INDEX=$O(^MAGQUEUE(2006.03,INDEX)) Q:INDEX'?1N.N  D
"RTN","MAGQBUT1",62,0)
 . S ZNODE=^MAGQUEUE(2006.03,INDEX,0)
"RTN","MAGQBUT1",63,0)
 . I $P(ZNODE,"^")="" D DQUE^MAGQBUT(INDEX) Q
"RTN","MAGQBUT1",64,0)
 . S STATUS=$P(ZNODE,"^",5)
"RTN","MAGQBUT1",65,0)
 . I STATUS[(PREFIX_INDEX) D
"RTN","MAGQBUT1",66,0)
 . . F  S STATUS=$P(STATUS,(PREFIX_INDEX))_$P(STATUS,(PREFIX_INDEX),2,999) Q:STATUS'[(PREFIX_INDEX)
"RTN","MAGQBUT1",67,0)
 . . S $P(^MAGQUEUE(2006.03,INDEX,0),"^",5)=STATUS
"RTN","MAGQBUT1",68,0)
 . I STATUS[(INDEX_" ") D
"RTN","MAGQBUT1",69,0)
 . . F  S STATUS=$P(STATUS,(INDEX_" "))_$P(STATUS,(INDEX_" "),2,999) Q:STATUS'[(INDEX_" ")
"RTN","MAGQBUT1",70,0)
 . . S $P(^MAGQUEUE(2006.03,INDEX,0),"^",5)=STATUS
"RTN","MAGQBUT1",71,0)
 K ^MAGQUEUE(2006.03,"C")
"RTN","MAGQBUT1",72,0)
 S DIK="^MAGQUEUE(2006.03,",DIK(1)="4^C"
"RTN","MAGQBUT1",73,0)
 D ENALL^DIK K DIK
"RTN","MAGQBUT1",74,0)
 Q
"RTN","MAGQBUT1",75,0)
RSQUE(RESULT,IEN,QUEUE) ;[MAGQB RSQUE]
"RTN","MAGQBUT1",76,0)
 N PTR
"RTN","MAGQBUT1",77,0)
 S PTR=$O(^MAGQUEUE(2006.031,"B",QUEUE,""))
"RTN","MAGQBUT1",78,0)
 I $P(^MAGQUEUE(2006.031,PTR,0),"^")=QUEUE D
"RTN","MAGQBUT1",79,0)
 . S $P(^MAGQUEUE(2006.031,PTR,0),"^",2)=IEN
"RTN","MAGQBUT1",80,0)
 . D RQCNT^MAGQBTM
"RTN","MAGQBUT1",81,0)
 Q
"RTN","MAGQBUT1",82,0)
ICCL(SRVRCNT,NMESS) ;UPDATE IMAGING DISTRIBUTION
"RTN","MAGQBUT1",83,0)
 N Y,LOC,INDEX,CNT,IEN,ARRAY,SUB1,SUB2,NAME
"RTN","MAGQBUT1",84,0)
 D NOW^%DTC S Y=% D DD^%DT
"RTN","MAGQBUT1",85,0)
 S LOC=$$KSP^XUPARAM("WHERE")
"RTN","MAGQBUT1",86,0)
 S ^TMP($J,"MAGQ",1)="SITE: "_LOC
"RTN","MAGQBUT1",87,0)
 S ^TMP($J,"MAGQ",2)="DATE: "_Y_" "_$G(^XMB("TIMEZONE"))
"RTN","MAGQBUT1",88,0)
 S ^TMP($J,"MAGQ",4)="SENDER: Imaging Background Processor"
"RTN","MAGQBUT1",89,0)
 S ^TMP($J,"MAGQ",5)="The "_SRVRCNT_" Imaging cache servers will"
"RTN","MAGQBUT1",90,0)
 S ^TMP($J,"MAGQ",6)="require operator intervention to ensure continued"
"RTN","MAGQBUT1",91,0)
 S ^TMP($J,"MAGQ",7)="availability.  The following MAG SERVER members"
"RTN","MAGQBUT1",92,0)
 S ^TMP($J,"MAGQ",8)="are being notified:"
"RTN","MAGQBUT1",93,0)
 S (CNT,INDEX)=0,IEN=$$FIND1^DIC(3.8,"","MX","MAG SERVER","","","ERR")
"RTN","MAGQBUT1",94,0)
 Q:IEN'?1N.N
"RTN","MAGQBUT1",95,0)
 D GETS^DIQ(3.8,IEN_",","2*;11*;12*","","ARRAY")
"RTN","MAGQBUT1",96,0)
 S (SUB1,SUB2)=""
"RTN","MAGQBUT1",97,0)
 F  S SUB1=$O(ARRAY(SUB1)) Q:SUB1=""  D
"RTN","MAGQBUT1",98,0)
 . F  S SUB2=$O(ARRAY(SUB1,SUB2)) Q:SUB2=""  D
"RTN","MAGQBUT1",99,0)
 . . S NAME=$G(ARRAY(SUB1,SUB2,".01")) D:NAME'=""
"RTN","MAGQBUT1",100,0)
 . . . S CNT=CNT+1,^TMP($J,"MAGQ",8+CNT)=NAME
"RTN","MAGQBUT1",101,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",8+CNT)="The next notifications will occur in:"
"RTN","MAGQBUT1",102,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",8+CNT)=NMESS
"RTN","MAGQBUT1",103,0)
 D MAILIT
"RTN","MAGQBUT1",104,0)
 S $P(^MAG(2006.1,1,3),"^",11)=$$NOW^XLFDT
"RTN","MAGQBUT1",105,0)
 K ARRAY
"RTN","MAGQBUT1",106,0)
 Q
"RTN","MAGQBUT1",107,0)
MAILIT ;Send the report to the Clinicial Application Time
"RTN","MAGQBUT1",108,0)
 N XMSUB
"RTN","MAGQBUT1",109,0)
 S XMSUB="Image Cache Critically Low at "_LOC
"RTN","MAGQBUT1",110,0)
MAILSHR ;Shared Mail server code
"RTN","MAGQBUT1",111,0)
 ;If droping in...must manage XMSUB
"RTN","MAGQBUT1",112,0)
 N XMY,XMTEXT
"RTN","MAGQBUT1",113,0)
 S XMTEXT="^TMP($J,""MAGQ"","
"RTN","MAGQBUT1",114,0)
 S:$G(DUZ) XMY(DUZ)=""
"RTN","MAGQBUT1",115,0)
 S XMY("G.MAG SERVER")=""
"RTN","MAGQBUT1",116,0)
 S:$G(MAGDUZ) XMY(MAGDUZ)=""
"RTN","MAGQBUT1",117,0)
 D ^XMD
"RTN","MAGQBUT1",118,0)
 K ^TMP($J,"MAGQ")
"RTN","MAGQBUT1",119,0)
 Q
"RTN","MAGQBUT1",120,0)
ALLSERV(RESULT) ;
"RTN","MAGQBUT1",121,0)
 ; RPC[MAGQ ALL SERVER]
"RTN","MAGQBUT1",122,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT1",123,0)
 N INDX,DATA,CNT,SHARE,CWL,VALUE,TMP ;CWL=CURRENT WRITE LOCATION
"RTN","MAGQBUT1",124,0)
 S RESULT(0)="-1^The Current Write Location (CWL) could not be set."
"RTN","MAGQBUT1",125,0)
 S INDX=0,U="^",CNT=1
"RTN","MAGQBUT1",126,0)
 K ^TMP("MAGQAS")
"RTN","MAGQBUT1",127,0)
 S CWL=+$G(^MAG(2006.1,"ARITE"))
"RTN","MAGQBUT1",128,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT1",129,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBUT1",130,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBUT1",131,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBUT1",132,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBUT1",133,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBUT1",134,0)
 . Q:$E(SHARE,1,2)'="\\"
"RTN","MAGQBUT1",135,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBUT1",136,0)
 . Q:$D(TMP(SHARE))
"RTN","MAGQBUT1",137,0)
 . S TMP(SHARE)=""
"RTN","MAGQBUT1",138,0)
 . S VALUE=SHARE_U_INDX_U_+$P(DATA,U,5)_U_+$P(DATA,U,3)_U_$P(DATA,U)
"RTN","MAGQBUT1",139,0)
 . I INDX=CWL D  Q  ;ELSE CONTINUE 
"RTN","MAGQBUT1",140,0)
 . . S RESULT(0)=VALUE_U_$G(^TMP("MAGQ","WSUD"))
"RTN","MAGQBUT1",141,0)
 . . S ^TMP("MAGQAS",0)=VALUE ;1ST SHARE=CWL
"RTN","MAGQBUT1",142,0)
 . S RESULT(CNT)=VALUE,CNT=CNT+1
"RTN","MAGQBUT1",143,0)
 . S ^TMP("MAGQAS",CNT-1)=VALUE
"RTN","MAGQBUT1",144,0)
 Q
"RTN","MAGQBUT1",145,0)
ALLSHR(RESULT) ; RPC[MAGQBP ALL SHARES]
"RTN","MAGQBUT1",146,0)
 N TMP,INDX,DATA,CNT,SHARE,CWL,VALUE ;CWL=CURRENT WRITE LOCATION
"RTN","MAGQBUT1",147,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT1",148,0)
 S (CNT,INDX)=0,U="^"
"RTN","MAGQBUT1",149,0)
 S CWL=$G(^MAG(2006.1,"ARITE"))
"RTN","MAGQBUT1",150,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT1",151,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBUT1",152,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBUT1",153,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBUT1",154,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBUT1",155,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBUT1",156,0)
 . Q:$E(SHARE,1,2)'="\\"
"RTN","MAGQBUT1",157,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBUT1",158,0)
 . Q:$D(TMP(SHARE))
"RTN","MAGQBUT1",159,0)
 . S TMP(SHARE)=""
"RTN","MAGQBUT1",160,0)
 S INDX=""
"RTN","MAGQBUT1",161,0)
 F  S INDX=$O(TMP(INDX)) Q:INDX=""  D
"RTN","MAGQBUT1",162,0)
 . S RESULT(CNT)=INDX,CNT=CNT+1
"RTN","MAGQBUT1",163,0)
 K TMP
"RTN","MAGQBUT1",164,0)
 Q
"RTN","MAGQBUT1",165,0)
FSUPDT(RESULT,IEN,SPACE,SIZE) ;
"RTN","MAGQBUT1",166,0)
 ;File Server Update
"RTN","MAGQBUT1",167,0)
 ; RPC[MAGQ FS UPDATE]
"RTN","MAGQBUT1",168,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT1",169,0)
 N NODE,X,Y,INDEX,SHNAME
"RTN","MAGQBUT1",170,0)
 S X=$$NOW^XLFDT S Y=X D DD^%DT S ^TMP("MAGQ","WSUD")=Y
"RTN","MAGQBUT1",171,0)
 S ^TMP("MAGQ","WSUD",XWBTIP)=Y
"RTN","MAGQBUT1",172,0)
 I $G(^MAG(2005.2,IEN,0))="" S RESULT="-1^No Network Location Entry" Q
"RTN","MAGQBUT1",173,0)
 S NODE=^MAG(2005.2,IEN,0)
"RTN","MAGQBUT1",174,0)
 D FSW(IEN,NODE)
"RTN","MAGQBUT1",175,0)
 S INDEX=0,SHNAME=$P(NODE,"^",2)
"RTN","MAGQBUT1",176,0)
 ; NOW UPDATE THE SIZING FIELDS FOR SHARES OF SAME PHYS LOCATION
"RTN","MAGQBUT1",177,0)
 F  S INDEX=$O(^MAG(2005.2,"AC",SHNAME,INDEX)) Q:INDEX'?1N.N  D
"RTN","MAGQBUT1",178,0)
 . Q:INDEX=IEN
"RTN","MAGQBUT1",179,0)
 . S NODE=^MAG(2005.2,INDEX,0)
"RTN","MAGQBUT1",180,0)
 . D FSW(INDEX,NODE)
"RTN","MAGQBUT1",181,0)
 S RESULT="1^Update Complete"
"RTN","MAGQBUT1",182,0)
 D RQCNT^MAGQBTM  ;RECOUNT THE TO BE PROCESSED COUNTERS !!NEW
"RTN","MAGQBUT1",183,0)
 Q
"RTN","MAGQBUT1",184,0)
FSW(INDEX,NODE) ;
"RTN","MAGQBUT1",185,0)
 I (($P(NODE,"^",3)'=(+SIZE))!($P(NODE,"^",5)'=(+SPACE))) D
"RTN","MAGQBUT1",186,0)
 . S $P(NODE,"^",3)=+SIZE,$P(NODE,"^",5)=+SPACE,^MAG(2005.2,INDEX,0)=NODE
"RTN","MAGQBUT1",187,0)
 Q
"RTN","MAGQBUT1",188,0)
QUEUER(QUE,FROM,TO) ;
"RTN","MAGQBUT1",189,0)
 N TYPE,INC,CNT
"RTN","MAGQBUT1",190,0)
 I $$GET1^DIQ(200,+$G(DUZ),.01)="" D  Q
"RTN","MAGQBUT1",191,0)
 . W !,"You must have a valid User ID (DUZ) to use this function!"
"RTN","MAGQBUT1",192,0)
 I "^JBTOHD^PREFET^ABSTRACT^JUKEBOX^GCC^"'[QUE D  Q
"RTN","MAGQBUT1",193,0)
 . W !,"Only JBTOHD, PREFET, ABSTRACT, JUKEBOX & GCC queues are valid!"
"RTN","MAGQBUT1",194,0)
 . W !,"Input values: ""Queue type"",""From Image IEN"",""To Image IEN"""
"RTN","MAGQBUT1",195,0)
 S CNT=0
"RTN","MAGQBUT1",196,0)
 F INC=FROM:1:TO D
"RTN","MAGQBUT1",197,0)
 . I '$D(^MAG(2005,INC,0)) Q
"RTN","MAGQBUT1",198,0)
 . I $P($G(^MAG(2005,INC,0)),"^",2)="" Q  ;No full filename attribute
"RTN","MAGQBUT1",199,0)
 . I +$P($G(^MAG(2005,INC,1,0)),"^",4)>0 Q  ;GROUP PARENT
"RTN","MAGQBUT1",200,0)
 . I "^JBTOHD^PREFET^"[QUE F TYPE="ABSTRACT","FULL","BIG" D 
"RTN","MAGQBUT1",201,0)
 . . Q:(TYPE="BIG")&'$D(^MAG(2005,INC,"FBIG"))
"RTN","MAGQBUT1",202,0)
 . . D MAPI(QUE,INC_"^"_TYPE,.CNT)
"RTN","MAGQBUT1",203,0)
 . E  D MAPI(QUE,INC,.CNT)
"RTN","MAGQBUT1",204,0)
 Q
"RTN","MAGQBUT1",205,0)
MPAC(SW,FROM,TO) ;
"RTN","MAGQBUT1",206,0)
 N INDEX
"RTN","MAGQBUT1",207,0)
 I (SW'=1)&(SW'=0) W !,"The first parameter must equal 0 or 1" Q
"RTN","MAGQBUT1",208,0)
 I (FROM<0)!((TO<0)!(TO<FROM)) W !,"The second parameter must be greater than 0 and less than the third!" Q
"RTN","MAGQBUT1",209,0)
 S FROM=FROM-1
"RTN","MAGQBUT1",210,0)
 F  S INDEX=$O(^MAG(2005,INDEX)) Q:INDEX'?1N.N  Q:INDEX>TO  D
"RTN","MAGQBUT1",211,0)
 . I '$D(^MAG(2005,INDEX,0)) Q
"RTN","MAGQBUT1",212,0)
 . I $P($G(^MAG(2005,INDEX,0)),"^",2)="" Q  ;No full filename attribute
"RTN","MAGQBUT1",213,0)
 . I +$P($G(^MAG(2005,INDEX,1,0)),"^",4)>0 Q  ;GROUP PARENT
"RTN","MAGQBUT1",214,0)
 . I (SW=1)&('$D(^MAG(2005,INDEX,"PACS"))) S ^MAG(2005,INDEX,"PACS")="TEST PACS" Q
"RTN","MAGQBUT1",215,0)
 . I SW=0 K ^MAG(2005,INDEX,"PACS")
"RTN","MAGQBUT1",216,0)
 Q
"RTN","MAGQBUT1",217,0)
MAPI(TYP,PARAM,CNT) ;
"RTN","MAGQBUT1",218,0)
 S CNT=CNT+1
"RTN","MAGQBUT1",219,0)
 W !,CNT," TYPE: ",TYP,": ",PARAM_" QUEUE #: ",@("$$"_TYP_"^MAGBAPI(PARAM)")
"RTN","MAGQBUT1",220,0)
 Q
"RTN","MAGQBUT2")
0^24^B78253804
"RTN","MAGQBUT2",1,0)
MAGQBUT2 ;WOIFO/SRR/RMP -IMAGE SITE PARAMETERS COMPANION [ 03/25/2001 11:20 ]
"RTN","MAGQBUT2",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGQBUT2",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT2",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT2",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT2",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT2",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT2",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT2",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT2",10,0)
 ;; |                                                               |
"RTN","MAGQBUT2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT2",17,0)
 ;;
"RTN","MAGQBUT2",18,0)
VSTAV() ;
"RTN","MAGQBUT2",19,0)
 N VER,IEN,ARRAY,VALUE,LATEST
"RTN","MAGQBUT2",20,0)
 S VER=$$VERSION^XPDUTL("IMAGING")
"RTN","MAGQBUT2",21,0)
 S:$T(LAST^XPDUTL)]"" VER=VER_"^"_$$LAST^XPDUTL("IMAGING",VER)
"RTN","MAGQBUT2",22,0)
 Q VER
"RTN","MAGQBUT2",23,0)
BPV(BPWS) ;
"RTN","MAGQBUT2",24,0)
 N IEN,NODE,INDEX
"RTN","MAGQBUT2",25,0)
 S IEN=0
"RTN","MAGQBUT2",26,0)
 F  S IEN=$O(^MAG(2006.8,IEN)) Q:IEN'?1N.N  D
"RTN","MAGQBUT2",27,0)
 . Q:$P($G(^MAG(2006.8,IEN,0)),"^",12)'="1"
"RTN","MAGQBUT2",28,0)
 . S NODE=$G(^MAG(2006.8,IEN,1))
"RTN","MAGQBUT2",29,0)
 . I +$P(NODE,"^",2)>0 D
"RTN","MAGQBUT2",30,0)
 . . S INDEX=$P(NODE,"^",2)_U_$P(NODE,"^",4)
"RTN","MAGQBUT2",31,0)
 . . S BPWS(INDEX)=$G(BPWS(INDEX))+1
"RTN","MAGQBUT2",32,0)
 . . S $P(BPWS(INDEX),"^",2)=$P(NODE,"^",3)
"RTN","MAGQBUT2",33,0)
 Q $S($D(BPWS):1,1:0)
"RTN","MAGQBUT2",34,0)
IWSV(WSD,WSC) ;IMAGE WORKSTATION VERSIONS
"RTN","MAGQBUT2",35,0)
 N IEN,NODE
"RTN","MAGQBUT2",36,0)
 S IEN=0
"RTN","MAGQBUT2",37,0)
 F  S IEN=$O(^MAG(2006.81,IEN)) Q:IEN'?1N.N  D
"RTN","MAGQBUT2",38,0)
 . S NODE=^MAG(2006.81,IEN,0)
"RTN","MAGQBUT2",39,0)
 . S:+$P(NODE,"^",9)>0 WSD($P(NODE,"^",9))=$G(WSD($P(NODE,"^",9)))+1
"RTN","MAGQBUT2",40,0)
 . S:+$P(NODE,"^",13)>0 WSC($P(NODE,"^",13))=$G(WSC($P(NODE,"^",13)))+1
"RTN","MAGQBUT2",41,0)
 Q
"RTN","MAGQBUT2",42,0)
DICOMV(DCMG) ;Version of DICOM
"RTN","MAGQBUT2",43,0)
 N X,ARRAY,IEN,NAME
"RTN","MAGQBUT2",44,0)
 S X=""
"RTN","MAGQBUT2",45,0)
 F  S X=$O(^MAG(2006.83,"B",X)) Q:X=""  D
"RTN","MAGQBUT2",46,0)
 . S IEN=$O(^MAG(2006.83,"B",X,"")) Q:IEN'?1N.N
"RTN","MAGQBUT2",47,0)
 . S DCMG($P(^MAG(2006.83,IEN,0),U,3))=$G(DCMG($P(^MAG(2006.83,IEN,0),U,3)))+1
"RTN","MAGQBUT2",48,0)
 Q $S($D(DCMG):1,1:0)
"RTN","MAGQBUT2",49,0)
VISTARV() ;
"RTN","MAGQBUT2",50,0)
 Q $$VERSION^XPDUTL("MAGJ RADIOLOGY")
"RTN","MAGQBUT2",51,0)
MAGSYS(LIST) ;
"RTN","MAGQBUT2",52,0)
 N VAIEN,NODE,MGIEN,UNAME,TDATE
"RTN","MAGQBUT2",53,0)
 S MGIEN=$$FIND1^DIC(3.8,"","MX","MAG SERVER","","","ERR")
"RTN","MAGQBUT2",54,0)
 S VAIEN=0
"RTN","MAGQBUT2",55,0)
 F  S VAIEN=$O(^XUSEC("MAG SYSTEM",VAIEN)) Q:VAIEN'?1N.N  D
"RTN","MAGQBUT2",56,0)
 . S UNAME=$$GET1^DIQ(200,VAIEN,.01)
"RTN","MAGQBUT2",57,0)
 . Q:UNAME=""
"RTN","MAGQBUT2",58,0)
 . ;CHECK FOR TERMINATION DATE
"RTN","MAGQBUT2",59,0)
 . S TDATE=$$GET1^DIQ(200,VAIEN,9.2)
"RTN","MAGQBUT2",60,0)
 . Q:((TDATE'="")&(TDATE<$$NOW^XLFDT))
"RTN","MAGQBUT2",61,0)
 . ;the next line screens existing 'MAG SERVER' members
"RTN","MAGQBUT2",62,0)
 . I MGIEN?1N.N,$$FIND1^DIC(3.81,","_MGIEN_",","QA",VAIEN,"","","ERR") Q
"RTN","MAGQBUT2",63,0)
 . S LIST(VAIEN)=VAIEN_"^"_UNAME
"RTN","MAGQBUT2",64,0)
 Q
"RTN","MAGQBUT2",65,0)
IMPAR(RESULT,QIEN) ;
"RTN","MAGQBUT2",66,0)
 N INDX,CNT
"RTN","MAGQBUT2",67,0)
 S (INDX,CNT)=0
"RTN","MAGQBUT2",68,0)
 F  S INDX=$O(^MAG(2006.034,QIEN,1,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT2",69,0)
 . S CNT=CNT+1
"RTN","MAGQBUT2",70,0)
 . S RESULT(CNT)=$G(^MAG(2006.034,QIEN,1,INDX,0))
"RTN","MAGQBUT2",71,0)
 I CNT<1 S RESULT(0)="0^Corrupted Import Array"
"RTN","MAGQBUT2",72,0)
 E  S RESULT(0)="1"
"RTN","MAGQBUT2",73,0)
 Q
"RTN","MAGQBUT2",74,0)
SNS(PLACE) ;
"RTN","MAGQBUT2",75,0)
 N RESULT,INDEX
"RTN","MAGQBUT2",76,0)
 S INDEX=0
"RTN","MAGQBUT2",77,0)
 S RESULT=$P(^MAG(2006.1,PLACE,0),U,2)
"RTN","MAGQBUT2",78,0)
 F  S INDEX=$O(^MAG(2006.1,PLACE,4,INDEX)) Q:INDEX'?1N.N  D
"RTN","MAGQBUT2",79,0)
 . S RESULT=RESULT_U_$P($G(^MAG(2006.1,PLACE,4,INDEX,0)),U)
"RTN","MAGQBUT2",80,0)
 Q RESULT
"RTN","MAGQBUT2",81,0)
 ;
"RTN","MAGQBUT2",82,0)
QSTAT(TID) ; Tracking ID Lookup / Current Status Returned
"RTN","MAGQBUT2",83,0)
 N IEN,RESULT,FLD
"RTN","MAGQBUT2",84,0)
 S IEN=$O(^MAG(2006.041,"C",TID,"A"),-1)
"RTN","MAGQBUT2",85,0)
 I IEN?1N.N D  Q RESULT
"RTN","MAGQBUT2",86,0)
 . S RESULT=""
"RTN","MAGQBUT2",87,0)
 . F FLD=1,3,4 S RESULT=$S($L(RESULT)>0:RESULT_" ",1:RESULT)_$$GET1^DIQ(2006.041,IEN,FLD)
"RTN","MAGQBUT2",88,0)
 Q "Invalid Tracking ID or the Process has been purged from the Session file"
"RTN","MAGQBUT2",89,0)
 ;
"RTN","MAGQBUT2",90,0)
CHKIMG(IEN) ;
"RTN","MAGQBUT2",91,0)
 ;
"RTN","MAGQBUT2",92,0)
 ; Given an Image IEN, return:
"RTN","MAGQBUT2",93,0)
 ;   1: Case # or accession #
"RTN","MAGQBUT2",94,0)
 ;   2: Parent application~IEN
"RTN","MAGQBUT2",95,0)
 ;   3: Application DFN
"RTN","MAGQBUT2",96,0)
 ;   4: Image DFN
"RTN","MAGQBUT2",97,0)
 ;   5: Flag: true = all DFNs in images in same parent group are identical
"RTN","MAGQBUT2",98,0)
 ;   6: Image object Class
"RTN","MAGQBUT2",99,0)
 ;
"RTN","MAGQBUT2",100,0)
 ; PF: Parent Data file number
"RTN","MAGQBUT2",101,0)
 ; PT(): Parent file data dictionary
"RTN","MAGQBUT2",102,0)
 ; PD0: Parent (Global root) IEN (D0)
"RTN","MAGQBUT2",103,0)
 ; PD1:  Lab Parent Global Root (D1)
"RTN","MAGQBUT2",104,0)
 ; PD2:  Parent Data File Image Pointer
"RTN","MAGQBUT2",105,0)
 ; T():  Error types
"RTN","MAGQBUT2",106,0)
 ; IDFN: Image file entry DFN
"RTN","MAGQBUT2",107,0)
 ; PDFN: Parent file DFN
"RTN","MAGQBUT2",108,0)
 ; GRG:  virtual Parent File Image Multiple
"RTN","MAGQBUT2",109,0)
 ; IOR: Image Object Referenced (by parent)
"RTN","MAGQBUT2",110,0)
 N GF,GP,GR,GRD,GRG,GR0,IDFN,IENV,PD0,PD1,PD2,PF,PT,X0,X2,N0,N1,R,T,GPDFN,PACS,IOR,APR
"RTN","MAGQBUT2",111,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT2",112,0)
 S R="^^^^^"
"RTN","MAGQBUT2",113,0)
 S T(1)="No Image ptr in AP"
"RTN","MAGQBUT2",114,0)
 S T(2)="GP has no Images"
"RTN","MAGQBUT2",115,0)
 S T(3)="Conflicting AP & Image DFNs"
"RTN","MAGQBUT2",116,0)
 S T(4)="Invalid Image Ptr to AP"
"RTN","MAGQBUT2",117,0)
 S T(5)="Conflicting GP and GO DFN"
"RTN","MAGQBUT2",118,0)
 S T(6)="GP & GO AP Mismatch"
"RTN","MAGQBUT2",119,0)
 S T(7)="GP Missing GO ptr"
"RTN","MAGQBUT2",120,0)
 S T(8)="No AP Ptr"
"RTN","MAGQBUT2",121,0)
 S T(9)="No AP Entry ptr"
"RTN","MAGQBUT2",122,0)
 S T(10)="No AP Mult ptr"
"RTN","MAGQBUT2",123,0)
 S T(11)="GO DFN mismatches"
"RTN","MAGQBUT2",124,0)
 S T(12)="Null Image Ptr"
"RTN","MAGQBUT2",125,0)
 S T(13)="Invalid Image Ptr"
"RTN","MAGQBUT2",126,0)
 S T(14)="Invalid Image Ptr to AP"
"RTN","MAGQBUT2",127,0)
 S T(15)="Image Entry is structurally abnormal"
"RTN","MAGQBUT2",128,0)
 S T(16)="Missing Group Objects"
"RTN","MAGQBUT2",129,0)
 S T(21)="DFN Mismatches in AP Image Mult"
"RTN","MAGQBUT2",130,0)
 ;
"RTN","MAGQBUT2",131,0)
 I IEN="" S $P(R,"^",5)=T(12)_"~1" Q R
"RTN","MAGQBUT2",132,0)
 S X0=$G(^MAG(2005,IEN,0))
"RTN","MAGQBUT2",133,0)
 I X0="" S $P(R,"^",5)=T(13)_"~1" Q R
"RTN","MAGQBUT2",134,0)
 S IDFN=$P(X0,"^",7),$P(R,"^",4)=IDFN
"RTN","MAGQBUT2",135,0)
 S PT(3.9)="^XMB(3.9,PD0,|Mail message||2|^XMB(3.9,PD0,2005,|MAIL"
"RTN","MAGQBUT2",136,0)
 S PT(63)="^LR(PD0,GF,PD1,|Autopsy (microscopic)|AY|1|^LR(PD0,GF,PD1,2005,|AUM"
"RTN","MAGQBUT2",137,0)
 S PT(63.02)="^LR(PD0,GF,PD1,|Electron microscopy|EM|1|^LR(PD0,GF,PD1,2005,|EM"
"RTN","MAGQBUT2",138,0)
 S PT(63.08)="^LR(PD0,GF,PD1,|Surgical pathology|SP|1|^LR(PD0,GF,PD1,2005,|SP"
"RTN","MAGQBUT2",139,0)
 S PT(63.09)="^LR(PD0,GF,PD1,|Cytology|CY|1|^LR(PD0,GF,PD1,2005,|CY|"
"RTN","MAGQBUT2",140,0)
 S PT(63.2)="^LR(PD0,GF,PD1,|Autopsy (gross)|AU|1|^LR(PD0,GF,PD1,2005,|AUG"
"RTN","MAGQBUT2",141,0)
 S PT(70)="^RADPT(PDFN,|Radiology Patient||1|"
"RTN","MAGQBUT2",142,0)
 S PT(74)="^RARPT(PD0,|Radiology||2|^RARPT(PD0,2005,|RAD"
"RTN","MAGQBUT2",143,0)
 S PT(130)="^SRF(PD0,|Surgery||1|^SRF(PD0,2005,|SUR"
"RTN","MAGQBUT2",144,0)
 S PT(691)="^MCAR(691,PD0,|Echocardiogram||2|^MCAR(691,PD0,2005,|ECHO"
"RTN","MAGQBUT2",145,0)
 S PT(691.1)="^MCAR(691.1,PD0,|Cardiac catheterization||2|^MCAR(691.1,PD0,2005,|CATH"
"RTN","MAGQBUT2",146,0)
 S PT(691.5)="^MCAR(691.5,PD0,|Electrocardiography||2|^MCAR(691.5,PD0,2005,|ECG"
"RTN","MAGQBUT2",147,0)
 S PT(694)="^MCAR(694,PD0,|Hematology||2|^MCAR(694,PD0,2005,|HEM"
"RTN","MAGQBUT2",148,0)
 S PT(699)="^MCAR(699,PD0,|Endoscopy||2|^MCAR(699,PD0,2005,|ENDO"
"RTN","MAGQBUT2",149,0)
 S PT(699.5)="^MCAR(699.5,PD0,|Medicine||2|^MCAR(699.5,PD0,2005,|GEN"
"RTN","MAGQBUT2",150,0)
 S PT(8925)="^TIU(8925,PD0,|TIU||2|^TIU(8925.91,""ADI"",PD0,|TIU"
"RTN","MAGQBUT2",151,0)
 S IC=$$IC(IEN,.N0,.N2,.GPDFN),$P(R,U,6)=IC
"RTN","MAGQBUT2",152,0)
 I IC="ER" S $P(R,U,5)=T(15)_"~1" Q R
"RTN","MAGQBUT2",153,0)
 I IC["GP",'$O(^MAG(2005,IEN,1,0)) S $P(R,U,5)=T(2)_"~1" Q R
"RTN","MAGQBUT2",154,0)
 D PF(IEN,IC,N0,.PF,.PD0,.PD1,.PD2,.PACS,.IOR,.APR)
"RTN","MAGQBUT2",155,0)
 I "GP^GO"[IC D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",156,0)
 . S I=0
"RTN","MAGQBUT2",157,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  D
"RTN","MAGQBUT2",158,0)
 . . I '$D(^MAG(2005,$P($G(^MAG(2005,IOR,1,I,0)),U),0)) S $P(R,U,5)=T(16)_$S(IC="GO":"~2",1:"~1")
"RTN","MAGQBUT2",159,0)
 . . Q
"RTN","MAGQBUT2",160,0)
 I IC["GO" S $P(R,U,6)=$P(R,U,6)_"~"_IOR
"RTN","MAGQBUT2",161,0)
 I PD2'?1N.N,(('PACS)&(PD0?1N.N)) S $P(R,U,5)=T(10)_$S(IC["GO":"~2",1:"~1") Q R
"RTN","MAGQBUT2",162,0)
 I IC["GO" D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",163,0)
 . N I,J
"RTN","MAGQBUT2",164,0)
 . S (I,J)=0
"RTN","MAGQBUT2",165,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  S:IEN=$P($G(^MAG(2005,IOR,1,I,0)),U,1) J=1
"RTN","MAGQBUT2",166,0)
 . S:J=0 $P(R,U,5)=T(7)_"~2"
"RTN","MAGQBUT2",167,0)
 . Q
"RTN","MAGQBUT2",168,0)
 I IC["GO",IDFN'=GPDFN S $P(R,U,5)=T(5)_"~1",$P(R,U,3)=GPDFN Q R
"RTN","MAGQBUT2",169,0)
 I IC["GO" D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",170,0)
 . N I,J
"RTN","MAGQBUT2",171,0)
 . S I=0
"RTN","MAGQBUT2",172,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  D  Q:$P(R,U,5)'=""
"RTN","MAGQBUT2",173,0)
 . . S J=$P($G(^MAG(2005,IOR,1,I,0)),U)
"RTN","MAGQBUT2",174,0)
 . . I $P($G(^MAG(2005,J,0)),U,7)'=IDFN S $P(R,U,5)=T(11)_"~2",$P(R,U,3)=$P($G(^MAG(2005,J,0)),U,7)
"RTN","MAGQBUT2",175,0)
 . . Q
"RTN","MAGQBUT2",176,0)
 I IC["GO",PACS,(($P(N2,U,6,7)'="")&($P(N2,U,6,7)'="^")),$P(N2,U,6,7)'=$P($G(^MAG(2005,$P(N0,U,10),2)),U,6,7) D  Q R
"RTN","MAGQBUT2",177,0)
 . S $P(R,U,5)=T(6)_"~1",$P(R,U,3)=$P(^MAG(2005,IOR,0),U,7) Q
"RTN","MAGQBUT2",178,0)
 I (PF\1=63),PD1'?1N.N Q R
"RTN","MAGQBUT2",179,0)
 I PF?1N.N,$D(PT(+PF)),PD0?1N.N D
"RTN","MAGQBUT2",180,0)
 . S $P(R,"^",2)=$P(PT(PF),"|",6)_"~"_PD0
"RTN","MAGQBUT2",181,0)
 . S GR=$P(PT(PF),"|",1),GR0=GR_"0)"
"RTN","MAGQBUT2",182,0)
 . S GF=$P(PT(PF),"|",3),GP=$P(PT(PF),"|",4)
"RTN","MAGQBUT2",183,0)
 . S T=$P(PT(PF),"|",5),GRD=T_"G0,0)",GRG=T_"G0)"
"RTN","MAGQBUT2",184,0)
 E  Q R
"RTN","MAGQBUT2",185,0)
 S P0=$G(@GR0)
"RTN","MAGQBUT2",186,0)
 I P0="" S $P(R,"^",5)=T(4)_$S((('PACS)&(IC["GO")):"~2",1:"~1") Q R
"RTN","MAGQBUT2",187,0)
 S PDFN=$S(PF\1=63:$P(^LR(PD0,0),U,3),$P(P0,"^",GP)'="":$P(P0,"^",GP),1:PDFN)
"RTN","MAGQBUT2",188,0)
 I 'PDFN,$P($G(^VA(200,IDFN,0)),"^",1)=PDFN S PDFN=IDFN
"RTN","MAGQBUT2",189,0)
 S $P(R,"^",3)=PDFN
"RTN","MAGQBUT2",190,0)
 I PDFN'=IDFN S $P(R,U,5)=T(3)_$S((('PACS)&(IC["GO")):"~2",1:"~1") Q R
"RTN","MAGQBUT2",191,0)
 I PF=74 D
"RTN","MAGQBUT2",192,0)
 . S GR=$P(PT(70),"|",1),GR0=GR_"0)"
"RTN","MAGQBUT2",193,0)
 . S GF=$P(PT(70),"|",3),GP=$P(PT(70),"|",4)
"RTN","MAGQBUT2",194,0)
 . S P0=$G(@GR0),$P(R,"^",3)=$P(R,"^",3)_"~"_$P(P0,"^",GP)
"RTN","MAGQBUT2",195,0)
 S T=1,G0=0,IENV=0
"RTN","MAGQBUT2",196,0)
 F  S G0=$O(@GRG) Q:'G0  Q:$P(R,U,5)'=""  D  I 'T K PT Q
"RTN","MAGQBUT2",197,0)
 . I PF=8925 D  Q
"RTN","MAGQBUT2",198,0)
 . . I '$D(^MAG(2005,+G0,0)) S $P(R,U,5)=T(14)_$S((('PACS)&(IC["GO")):"~2",1:"~1")
"RTN","MAGQBUT2",199,0)
 . . S:G0=IOR IENV=1
"RTN","MAGQBUT2",200,0)
 . . I $P($G(^MAG(2005,+G0,0)),"^",7)'=IDFN S $P(R,U,5)=T(21)_"~2",$P(R,U,3)=$P($G(^MAG(2005,+G0,0)),"^",7)
"RTN","MAGQBUT2",201,0)
 . . Q
"RTN","MAGQBUT2",202,0)
 . I '$D(^MAG(2005,+$P($G(@GRD),"^",1),0)) S $P(R,U,5)=T(14)_$S((('PACS)&(IC["GO")):"~2",1:"~1")
"RTN","MAGQBUT2",203,0)
 . I $P($G(^MAG(2005,+$P($G(@GRD),"^",1),0)),"^",7)'=IDFN D  Q
"RTN","MAGQBUT2",204,0)
 . . S $P(R,U,5)=T(21)_"~2",$P(R,U,3)=$P($G(^MAG(2005,+$P($G(@GRD),"^",1),0)),"^",7) Q
"RTN","MAGQBUT2",205,0)
 . I (PF=63)!(PF=63.2) S:+$P(^LR(PD0,GF,PD1,2005.1,G0,0),U)=IOR IENV=1
"RTN","MAGQBUT2",206,0)
 . S:+$P($G(@GRD),"^",1)=IOR IENV=1
"RTN","MAGQBUT2",207,0)
 . Q
"RTN","MAGQBUT2",208,0)
 Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",209,0)
 I IENV=0 S $P(R,U,5)=T(1)_"~1"
"RTN","MAGQBUT2",210,0)
 I PF=74 S $P(R,"^",1)=$P(P0,"^",1)
"RTN","MAGQBUT2",211,0)
 K PT
"RTN","MAGQBUT2",212,0)
 Q R
"RTN","MAGQBUT2",213,0)
IC(IEN,N0,N2,GPDFN) ;
"RTN","MAGQBUT2",214,0)
 S N0=$G(^MAG(2005,IEN,0))
"RTN","MAGQBUT2",215,0)
 S N1=$G(^MAG(2005,IEN,1,0))
"RTN","MAGQBUT2",216,0)
 S N2=$G(^MAG(2005,IEN,2))
"RTN","MAGQBUT2",217,0)
 I ($P(N0,U,2)="")&($P(N0,U,10)="")&($P(N1,U,4)>0) Q "GP"
"RTN","MAGQBUT2",218,0)
 I (($P(N0,U,2)'="")&($P(N0,U,10)?1N.N)&(N1=""))!(($P(N0,U,2)'="")&($P(N0,U,10)="")&($P(N1,U,4)>0)) D  Q "GO"
"RTN","MAGQBUT2",219,0)
 . S GPDFN=$P($G(^MAG(2005,$P(N0,U,10),0)),U,7) Q
"RTN","MAGQBUT2",220,0)
 I ($P(N0,U,2)'="")&($P(N0,U,10)'?1N.N)&(N1="") Q "NG"
"RTN","MAGQBUT2",221,0)
 Q "ER"
"RTN","MAGQBUT2",222,0)
PF(IEN,IC,N0,PF,PD0,PD1,PD2,PACS,IOR,APR) ;
"RTN","MAGQBUT2",223,0)
 N N2
"RTN","MAGQBUT2",224,0)
 S PACS=$S($D(^MAG(2005,IEN,"PACS")):1,1:0)
"RTN","MAGQBUT2",225,0)
 S IOR=$S(IC="GO":$P($G(N0),U,10),1:IEN)
"RTN","MAGQBUT2",226,0)
 I ((IC="GP")!(IC="NG")!((PACS)&(IC="GO"))) S N2=$G(^MAG(2005,IEN,2))
"RTN","MAGQBUT2",227,0)
 I ((IC="GO")&('PACS)) S N2=$G(^MAG(2005,IOR,2))
"RTN","MAGQBUT2",228,0)
 S PF=$P(N2,"^",6),PD0=$P(N2,"^",7),PD1=$P(N2,"^",10),PD2=$P(N2,"^",8)
"RTN","MAGQBUT2",229,0)
 I PACS S APR=$S(PD0?1N.N:1,1:0)
"RTN","MAGQBUT2",230,0)
 E  S APR=$S(((PF'="")&(PD0?1N.N)):1,$P($G(^MAG(2005,IOR,100)),U)?1N.N:1,$P(^MAG(2005,IOR,0),U,6)="18":1,1:0)
"RTN","MAGQBUT2",231,0)
 Q
"RTN","MAGQBUT2",232,0)
 ;
"RTN","MAGQBUT4")
0^25^B3836472
"RTN","MAGQBUT4",1,0)
MAGQBUT4 ;WOIFO/RMP - BP Utilities  ;19 Nov 2001 1:23 PM
"RTN","MAGQBUT4",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGQBUT4",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT4",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT4",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT4",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT4",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT4",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT4",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT4",10,0)
 ;; |                                                               |
"RTN","MAGQBUT4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT4",17,0)
 ;;
"RTN","MAGQBUT4",18,0)
 ;
"RTN","MAGQBUT4",19,0)
 Q
"RTN","MAGQBUT4",20,0)
CONV(ARR,ICT) ;Convert any single node array to FM Style multiple
"RTN","MAGQBUT4",21,0)
 ;  The node subscripts of ARR are ignored, and not retained 
"RTN","MAGQBUT4",22,0)
 ; i.e.  ARR(34)=8
"RTN","MAGQBUT4",23,0)
 ;       ARR("BLUE")=9
"RTN","MAGQBUT4",24,0)
 ;       ARR("D")=10
"RTN","MAGQBUT4",25,0)
 ; converts to 
"RTN","MAGQBUT4",26,0)
 ;      ARR(1,0)=8
"RTN","MAGQBUT4",27,0)
 ;      ARR(2,0)=9
"RTN","MAGQBUT4",28,0)
 ;      ARR(3,0)=10
"RTN","MAGQBUT4",29,0)
 N I,ARO
"RTN","MAGQBUT4",30,0)
 S ICT=0,I=""
"RTN","MAGQBUT4",31,0)
 F  S I=$O(ARR(I)) Q:(I="")  D
"RTN","MAGQBUT4",32,0)
 . S ICT=ICT+1
"RTN","MAGQBUT4",33,0)
 . S ARO(ICT,0)=ARR(I)
"RTN","MAGQBUT4",34,0)
 K ARR
"RTN","MAGQBUT4",35,0)
 M ARR=ARO
"RTN","MAGQBUT4",36,0)
 Q
"RTN","MAGQBUT4",37,0)
MRGMULT(ARR,RT,RTDSC,CT) ;Merge the FM formated array into a FM File 
"RTN","MAGQBUT4",38,0)
 ;   multiple field.
"RTN","MAGQBUT4",39,0)
 ;   This isn't for general consumption.
"RTN","MAGQBUT4",40,0)
 ; RT = FILE ROOT, RECORD NUMBER, NODE 
"RTN","MAGQBUT4",41,0)
 ; i.e.  "^MAG(2006.034,44,1,"   -> 44 is the IEN of MAG(2006.34
"RTN","MAGQBUT4",42,0)
 ; RTDSC is the 2nd piece of the 0 node of the multiple field.
"RTN","MAGQBUT4",43,0)
 S RT=$E(RT,1,$L(RT)-1)_")"
"RTN","MAGQBUT4",44,0)
 S @RT@(0)=U_RTDSC_U_CT_U_CT ;  i.e.    ^2006.341A^13^13
"RTN","MAGQBUT4",45,0)
 M @RT=ARR
"RTN","MAGQBUT4",46,0)
 Q
"RTN","MAGQST")
0^29^B22503226
"RTN","MAGQST",1,0)
MAGQST ;WOIFO/DCB,RMP-SERVER TASKS [ 06/20/2001 08:57 ]
"RTN","MAGQST",2,0)
 ;;3.0;IMAGING;**7**;Jul 12, 2002
"RTN","MAGQST",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQST",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQST",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQST",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQST",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQST",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQST",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQST",10,0)
 ;; |                                                               |
"RTN","MAGQST",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQST",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQST",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQST",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQST",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQST",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQST",17,0)
 ;;
"RTN","MAGQST",18,0)
 Q
"RTN","MAGQST",19,0)
TASK ;Re-task the job
"RTN","MAGQST",20,0)
 N REC,DIC,DIE,DA,DR,TEMP,X,X1,X2,TEMP1,REC,DAYS,ZTRTN,ZTDTH,ZTDESC,ZTSAVE,ZTIO
"RTN","MAGQST",21,0)
 S REC=1
"RTN","MAGQST",22,0)
 S X1=$$NOW^XLFDT()
"RTN","MAGQST",23,0)
 S X=$S($E(X1,6,7)>14.9999:$$SCH^XLFDT("1M",X1),1:X1)
"RTN","MAGQST",24,0)
 S TEMP=$E(X,1,5)_15_".230000"
"RTN","MAGQST",25,0)
 S ZTRTN="ISU^MAGUSIT",ZTDESC="Site Imaging Utilization report"
"RTN","MAGQST",26,0)
 S ZTDTH=TEMP,ZTIO=""
"RTN","MAGQST",27,0)
 S:$D(MAGDUZ) ZTSAVE(MAGDUZ)=""
"RTN","MAGQST",28,0)
 D ^%ZTLOAD
"RTN","MAGQST",29,0)
 S DIE="^MAG(2006.1,",DA=REC,DR="10///^S X=ZTSK" D ^DIE
"RTN","MAGQST",30,0)
 Q
"RTN","MAGQST",31,0)
STTASK ;Start the Imaging task report
"RTN","MAGQST",32,0)
 N ZTSK,MCON,REC,TASK,DAYS S MCON="",MAGDUZ=DUZ
"RTN","MAGQST",33,0)
 Q:'$D(^MAG(2006.1,1))
"RTN","MAGQST",34,0)
 S REC=1,DAYS=1
"RTN","MAGQST",35,0)
 S TASK=$P($G(^MAG(2006.1,REC,1)),U,7)
"RTN","MAGQST",36,0)
 I TASK'="" D 
"RTN","MAGQST",37,0)
 . S ZTSK=TASK D STAT^%ZTLOAD
"RTN","MAGQST",38,0)
 . I ZTSK(0)=0 S TASK=""
"RTN","MAGQST",39,0)
 . E  W:$G(XQY0)["MAG" !,"Task is already running"
"RTN","MAGQST",40,0)
 Q:TASK'=""
"RTN","MAGQST",41,0)
 D RESTASK
"RTN","MAGQST",42,0)
 Q
"RTN","MAGQST",43,0)
RESTASK ;Restart the Imaging task report
"RTN","MAGQST",44,0)
 N FIND,START,DIC,DIE,DA,DR,TEMP,TEMP1,REC,ZTRTN,ZTDESC,ZTSAVE,ZTIO
"RTN","MAGQST",45,0)
 S ZTRTN="ISU^MAGUSIT",ZTDESC="Site Imaging Utilization report",ZTIO=""
"RTN","MAGQST",46,0)
 S:$D(MAGDUZ) ZTSAVE(MAGDUZ)=""
"RTN","MAGQST",47,0)
 S X1=$$NOW^XLFDT()
"RTN","MAGQST",48,0)
 S X=$S($E(X1,6,7)>14.9999:$$SCH^XLFDT("1M",X1),1:X1)
"RTN","MAGQST",49,0)
 S START=$E(X,1,5)_15_".230000"
"RTN","MAGQST",50,0)
 S ZTDTH=START
"RTN","MAGQST",51,0)
 D ^%ZTLOAD
"RTN","MAGQST",52,0)
 S REC=1
"RTN","MAGQST",53,0)
 S DIE="^MAG(2006.1,",DA=REC,DR="10///^S X=ZTSK" D ^DIE
"RTN","MAGQST",54,0)
 W:$G(XQY0)["MAG" !,"Task is started. To remove task execute option MAGREPSTOP"
"RTN","MAGQST",55,0)
 K MCDUZ
"RTN","MAGQST",56,0)
 Q
"RTN","MAGQST",57,0)
CHECK ;Check to see if the task is running
"RTN","MAGQST",58,0)
 N REC,TASK,ZTSK
"RTN","MAGQST",59,0)
 S REC=1
"RTN","MAGQST",60,0)
 S TASK=$P($G(^MAG(2006.1,REC,1)),U,7) Q:TASK=""
"RTN","MAGQST",61,0)
 S ZTSK=TASK,DAYS=30 D STAT^%ZTLOAD
"RTN","MAGQST",62,0)
 D:ZTSK(0)=0 RESTASK
"RTN","MAGQST",63,0)
 Q
"RTN","MAGQST",64,0)
REMTASK ;Remove the Imaging Task Report
"RTN","MAGQST",65,0)
 N FIND,DIE,DA,DR,REC,TASK,ZTSK
"RTN","MAGQST",66,0)
 S REC=1
"RTN","MAGQST",67,0)
 S TASK=$P($G(^MAG(2006.1,REC,1)),U,7)
"RTN","MAGQST",68,0)
 I TASK D  Q
"RTN","MAGQST",69,0)
 . S DIE="^MAG(2006.1,",DA=REC,DR="10///@" D ^DIE
"RTN","MAGQST",70,0)
 . S ZTSK=TASK D KILL^%ZTLOAD
"RTN","MAGQST",71,0)
 . Q:$G(XQY0)'["MAG"
"RTN","MAGQST",72,0)
 . I ZTSK(0)=1 W !,"Task is removed.  To restart execute option MAGREPSTART"
"RTN","MAGQST",73,0)
 . E  W !,"Could not stop task or task was no longer active."
"RTN","MAGQST",74,0)
 I $G(XQY0)["MAG" W !,"No task to stop."
"RTN","MAGQST",75,0)
 Q
"RTN","MAGQST",76,0)
POST ;
"RTN","MAGQST",77,0)
 D REMTASK,STTASK
"RTN","MAGQST",78,0)
 D INS^MAGQST(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGQST",79,0)
 D POSTI^MAGQBUT ;
"RTN","MAGQST",80,0)
 Q
"RTN","MAGQST",81,0)
ENHS ;Enable Health Summary Component
"RTN","MAGQST",82,0)
PRE ; REMOVE SITE 2006.19 ENTRIES SO THAT THEY CAN BE REPLACED
"RTN","MAGQST",83,0)
 ; THE "ID" NODE ON FIELD .2 MAKES CHANGING THEM DIFFICULT
"RTN","MAGQST",84,0)
 ;We require a DUZ(0)="@" for installer S DUZ(0)="@"
"RTN","MAGQST",85,0)
 N INDX S INDX=0
"RTN","MAGQST",86,0)
 F  S INDX=$O(^MAG(2006.19,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQST",87,0)
 . S DIE=2006.19,DA=INDX,DR=".01///@"
"RTN","MAGQST",88,0)
 . D ^DIE
"RTN","MAGQST",89,0)
 Q
"RTN","MAGQST",90,0)
NUMBER(VAL,SP) ;
"RTN","MAGQST",91,0)
 Q $J($FN(VAL,",",0),SP)
"RTN","MAGQST",92,0)
INS(XP,DZ,DATE,IDA) ;
"RTN","MAGQST",93,0)
 N ST,CT,DDATE
"RTN","MAGQST",94,0)
 D GETENV^%ZOSV
"RTN","MAGQST",95,0)
 K ^TMP($J,"MAGQ")
"RTN","MAGQST",96,0)
 S ^TMP($J,"MAGQ",1)="PACKAGE INSTALL"
"RTN","MAGQST",97,0)
 S ^TMP($J,"MAGQ",2)="SITE: "_$$KSP^XUPARAM("WHERE")
"RTN","MAGQST",98,0)
 S ^TMP($J,"MAGQ",3)="PACKAGE: "_XP
"RTN","MAGQST",99,0)
 S ^TMP($J,"MAGQ",4)="Version: "_$$VER^XPDUTL(XP)
"RTN","MAGQST",100,0)
 S ST=$$GET1^DIQ(9.7,IDA,11,"I")
"RTN","MAGQST",101,0)
 S ^TMP($J,"MAGQ",5)="Start time: "_$$FMTE^XLFDT(ST)
"RTN","MAGQST",102,0)
 S CT=$$GET1^DIQ(9.7,IDA,17,"I")
"RTN","MAGQST",103,0)
 S ^TMP($J,"MAGQ",6)="Completion time: "_$$FMTE^XLFDT(CT)
"RTN","MAGQST",104,0)
 S ^TMP($J,"MAGQ",7)="Run time: "_$$FMDIFF^XLFDT(CT,ST,3)
"RTN","MAGQST",105,0)
 S ^TMP($J,"MAGQ",8)="Environment: "_Y
"RTN","MAGQST",106,0)
 S ^TMP($J,"MAGQ",9)="DATE: "_DATE
"RTN","MAGQST",107,0)
 S ^TMP($J,"MAGQ",10)="Installed by: "_$$GET1^DIQ(9.7,IDA,9,"E")
"RTN","MAGQST",108,0)
 S ^TMP($J,"MAGQ",11)="Install Name: "_$$GET1^DIQ(9.7,IDA,.01,"E")
"RTN","MAGQST",109,0)
 S DDATE=$$GET1^DIQ(9.7,IDA,51,"I")
"RTN","MAGQST",110,0)
 S ^TMP($J,"MAGQ",11)="Distribution Date: "_$$FMTE^XLFDT(DDATE)
"RTN","MAGQST",111,0)
 S XMSUB="MAG "_XP_" INSTALLATION"
"RTN","MAGQST",112,0)
 D MAILSHR^MAGUSIT
"RTN","MAGQST",113,0)
 K ^TMP($J,"MAGQ")
"RTN","MAGQST",114,0)
 Q
"RTN","MAGQST",115,0)
 ;
"RTN","MAGQST",116,0)
TQ ; Test Queue functionality
"RTN","MAGQST",117,0)
 N CNT,RESULT
"RTN","MAGQST",118,0)
 S CNT=1,RESULT="" K ^TMP("MAGQ",$J)
"RTN","MAGQST",119,0)
 F  D GETQUE^MAGQBTM(.RESULT,"JBTOHD") S CNT=CNT+1 Q:CNT>200  D
"RTN","MAGQST",120,0)
 . S ^TMP("MAGQ",$J,CNT)=RESULT
"RTN","MAGQST",121,0)
 . Q
"RTN","MAGQST",122,0)
 Q
"RTN","MAGQST",123,0)
 ;
"RTN","MAGQST",124,0)
UPPER(X) ;
"RTN","MAGQST",125,0)
 Q $TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGQST",126,0)
 ;
"RTN","MAGQST",127,0)
TRIM(X) ; remove both leading and trailing blanks
"RTN","MAGQST",128,0)
 N I,J
"RTN","MAGQST",129,0)
 F I=1:1:$L(X) Q:$E(X,I)'=" "
"RTN","MAGQST",130,0)
 F J=$L(X):-1:I Q:$E(X,J)'=" "
"RTN","MAGQST",131,0)
 Q $S($E(X,I,J)=" ":"",1:$E(X,I,J))
"SEC","^DIC",2005.02,2005.02,0,"DD")
@
"SEC","^DIC",2005.02,2005.02,0,"DEL")
@
"SEC","^DIC",2005.02,2005.02,0,"LAYGO")
@
"SEC","^DIC",2005.02,2005.02,0,"RD")
@
"SEC","^DIC",2005.02,2005.02,0,"WR")
@
"SEC","^DIC",2005.021,2005.021,0,"AUDIT")
@
"SEC","^DIC",2005.021,2005.021,0,"DD")
@
"SEC","^DIC",2005.021,2005.021,0,"DEL")
@
"SEC","^DIC",2005.021,2005.021,0,"LAYGO")
@
"SEC","^DIC",2005.021,2005.021,0,"RD")
@
"SEC","^DIC",2005.021,2005.021,0,"WR")
@
"SEC","^DIC",2006.034,2006.034,0,"AUDIT")
@
"SEC","^DIC",2006.034,2006.034,0,"DD")
@
"SEC","^DIC",2006.034,2006.034,0,"DEL")
@
"SEC","^DIC",2006.034,2006.034,0,"LAYGO")
@
"SEC","^DIC",2006.034,2006.034,0,"RD")
@
"SEC","^DIC",2006.034,2006.034,0,"WR")
@
"SEC","^DIC",2006.04,2006.04,0,"AUDIT")
@
"SEC","^DIC",2006.04,2006.04,0,"DD")
@
"SEC","^DIC",2006.04,2006.04,0,"DEL")
@
"SEC","^DIC",2006.04,2006.04,0,"LAYGO")
@
"SEC","^DIC",2006.04,2006.04,0,"RD")
@
"SEC","^DIC",2006.04,2006.04,0,"WR")
@
"SEC","^DIC",2006.041,2006.041,0,"AUDIT")
@
"SEC","^DIC",2006.041,2006.041,0,"DD")
@
"SEC","^DIC",2006.041,2006.041,0,"DEL")
@
"SEC","^DIC",2006.041,2006.041,0,"LAYGO")
@
"SEC","^DIC",2006.041,2006.041,0,"RD")
@
"SEC","^DIC",2006.041,2006.041,0,"WR")
@
"VER")
8.0^22.0
"^DD",2005,2005,.05,0)
ACQUISITION SITE^RP4^DIC(4,^100;3^Q
"^DD",2005,2005,.05,.1)
Name of Site where Image was Created
"^DD",2005,2005,.05,3)
Enter the name of the site where the image was created.
"^DD",2005,2005,.05,21,0)
^^7^7^2981013^^^^
"^DD",2005,2005,.05,21,1,0)
The 'origin' location is the location where an image is created.
"^DD",2005,2005,.05,21,2,0)
For instance, a site like 'St. Louis' may process images for several
"^DD",2005,2005,.05,21,3,0)
other locations, such as Topeka, Wichita and Leavenworth.
"^DD",2005,2005,.05,21,4,0)
Any reference to a site identifier will return the name of the
"^DD",2005,2005,.05,21,5,0)
primary location. For the purpose of finding the 'origin' of images,
"^DD",2005,2005,.05,21,6,0)
the more specific sub-site is needed.
"^DD",2005,2005,.05,21,7,0)
This field contains the name of this 'sub-site'.
"^DD",2005,2005,.05,"DT")
2981013
"^DD",2005,2005,107,0)
ACQUISITION DEVICE^P2006.04^MAG(2006.04,^100;4^Q
"^DD",2005,2005,107,3)
Enter the device that performed the Image Acquisition.
"^DD",2005,2005,107,"DT")
3010114
"^DD",2005,2005,108,0)
TRACKING ID^F^^100;5^K:$L(X)>30!($L(X)<3) X
"^DD",2005,2005,108,1,0)
^.1
"^DD",2005,2005,108,1,1,0)
2005^ATRKID
"^DD",2005,2005,108,1,1,1)
S ^MAG(2005,"ATRKID",$E(X,1,30),DA)=""
"^DD",2005,2005,108,1,1,2)
K ^MAG(2005,"ATRKID",$E(X,1,30),DA)
"^DD",2005,2005,108,1,1,"%D",0)
^^3^3^3010312^
"^DD",2005,2005,108,1,1,"%D",1,0)
Cross reference of images imported using the Import API.  TrkID is 
"^DD",2005,2005,108,1,1,"%D",2,0)
a unique identifier of the package, or OTS Application that initiated
"^DD",2005,2005,108,1,1,"%D",3,0)
the Import using Imagings Import API. ( silent call)
"^DD",2005,2005,108,1,1,"DT")
3010312
"^DD",2005,2005,108,3)
Package ID that performed the Import ";" Internal package identifier
"^DD",2005,2005,108,21,0)
^^4^4^3010114^
"^DD",2005,2005,108,21,1,0)
This field tracks the packages that are using the Import API.
"^DD",2005,2005,108,21,2,0)
It is an ";" (semicolon) delimited free text field.  
"^DD",2005,2005,108,21,3,0)
First piece is the Package ID that performed the Import 
"^DD",2005,2005,108,21,4,0)
Second piece is the Internal package identifier
"^DD",2005,2005,108,"DT")
3010312
"^DD",2005,2005,109,0)
CREATE METHOD^F^^METHOD;1^K:$L(X)>245!($L(X)<3) X
"^DD",2005,2005,109,3)
This field holds the command that either has created the image(s), or will dynamically access the Image from the Display GUI.
"^DD",2005,2005,109,21,0)
^^5^5^3010130^
"^DD",2005,2005,109,21,1,0)
This field holds the command that either
"^DD",2005,2005,109,21,2,0)
   has created the image(s)
"^DD",2005,2005,109,21,3,0)
   or will dynamically access the Image when called from the Display GUI
"^DD",2005,2005,109,21,4,0)
an example is a DLL provided by a COTS product.
"^DD",2005,2005,109,21,5,0)
When the DLL is called, it generates the image.
"^DD",2005,2005,109,"DT")
3010130
"^DD",2005,2005,110,0)
DOCUMENT DATE^D^^100;6^S %DT="E" D ^%DT S X=Y K:Y<1 X
"^DD",2005,2005,110,3)
If this image is a scanned document, enter the date of the document.
"^DD",2005,2005,110,21,0)
^^1^1^3010628^
"^DD",2005,2005,110,21,1,0)
Document Images can have a seperate date, unlike clinical images that are attached to a procedure, and only procedure date is needed.
"^DD",2005,2005,110,"DT")
3010628
"^DD",2005.02,2005.02,0)
FIELD^^5^7
"^DD",2005.02,2005.02,0,"DDA")
N
"^DD",2005.02,2005.02,0,"DT")
2950508
"^DD",2005.02,2005.02,0,"IX","AC",2005.21,.01)

"^DD",2005.02,2005.02,0,"IX","AD",2005.02,5)

"^DD",2005.02,2005.02,0,"IX","B",2005.02,.01)

"^DD",2005.02,2005.02,0,"NM","OBJECT TYPE")

"^DD",2005.02,2005.02,0,"PT",2005,3)

"^DD",2005.02,2005.02,0,"PT",2005.02,3)

"^DD",2005.02,2005.02,0,"PT",2005.021,5)

"^DD",2005.02,2005.02,0,"PT",2005.1,3)

"^DD",2005.02,2005.02,0,"PT",2005.24,.01)

"^DD",2005.02,2005.02,0,"VRPK")
MAG
"^DD",2005.02,2005.02,.01,0)
NAME^RF^^0;1^K:X[""""!($A(X)=45) X I $D(X) K:$L(X)>30!(X?.N)!($L(X)<3)!'(X'?1P.E) X
"^DD",2005.02,2005.02,.01,1,0)
^.1
"^DD",2005.02,2005.02,.01,1,1,0)
2005.02^B
"^DD",2005.02,2005.02,.01,1,1,1)
S ^MAG(2005.02,"B",$E(X,1,30),DA)=""
"^DD",2005.02,2005.02,.01,1,1,2)
K ^MAG(2005.02,"B",$E(X,1,30),DA)
"^DD",2005.02,2005.02,.01,1,1,"DT")
2911113
"^DD",2005.02,2005.02,.01,3)
NAME MUST BE 3-30 CHARACTERS, NOT NUMERIC OR STARTING WITH PUNCTUATION
"^DD",2005.02,2005.02,.01,21,0)
^^4^4^2970721^^^
"^DD",2005.02,2005.02,.01,21,1,0)
Each kind of data supported by the Imaging System has an entry in
"^DD",2005.02,2005.02,.01,21,2,0)
the Object Type file.  The Object Type file manages the kinds of
"^DD",2005.02,2005.02,.01,21,3,0)
actions which that type of object can have and the routines that
"^DD",2005.02,2005.02,.01,21,4,0)
are executed for each action.
"^DD",2005.02,2005.02,.01,"DT")
2911113
"^DD",2005.02,2005.02,.02,0)
ABSTRACT REQUIRED^S^1:YES;0:NO;^0;2^Q
"^DD",2005.02,2005.02,.02,3)
DOES OBJECT TYPE REQUIRE AN ABSTRACT
"^DD",2005.02,2005.02,.02,21,0)
^^2^2^3001006^
"^DD",2005.02,2005.02,.02,21,1,0)
This field is reserved for future use and will indicates whether a
"^DD",2005.02,2005.02,.02,21,2,0)
separate abstract file is required for this type of object.
"^DD",2005.02,2005.02,.02,"DT")
3001006
"^DD",2005.02,2005.02,1,0)
ACTIONS^2005.21^^1;0
"^DD",2005.02,2005.02,1,21,0)
^.001^5^5^3020222^^^^
"^DD",2005.02,2005.02,1,21,1,0)
This field is reserved for future use will contain the kinds of actions
"^DD",2005.02,2005.02,1,21,2,0)
which apply to the object type. Generally, all objects can be displayed as
"^DD",2005.02,2005.02,1,21,3,0)
a full image/object and they have an abstract display method.  In
"^DD",2005.02,2005.02,1,21,4,0)
addition, groups of objects may have other actions such as cineloop
"^DD",2005.02,2005.02,1,21,5,0)
display or tiled display.
"^DD",2005.02,2005.02,1,"DT")
3001006
"^DD",2005.02,2005.02,2,0)
EDIT TEMPLATE^F^^2;1^K:$L(X)>20!($L(X)<1) X
"^DD",2005.02,2005.02,2,3)
Answer must be 1-20 characters in length.
"^DD",2005.02,2005.02,2,21,0)
^^2^2^3001006^
"^DD",2005.02,2005.02,2,21,1,0)
This field is reserved for future use for the name of the edit
"^DD",2005.02,2005.02,2,21,2,0)
template used to enter data pertaining to this type of object.
"^DD",2005.02,2005.02,2,"DT")
3001006
"^DD",2005.02,2005.02,3,0)
PARENT^P2005.02'^MAG(2005.02,^2;2^Q
"^DD",2005.02,2005.02,3,21,0)
^^2^2^2950331^^
"^DD",2005.02,2005.02,3,21,1,0)
This field is reserved for future use to allow object types
"^DD",2005.02,2005.02,3,21,2,0)
to inherit characteristics from a parent object type.
"^DD",2005.02,2005.02,3,"DT")
2910526
"^DD",2005.02,2005.02,4,0)
CHILD CLASS^2005.24P^^3;0
"^DD",2005.02,2005.02,4,21,0)
^.001^2^2^3001025^^^^
"^DD",2005.02,2005.02,4,21,1,0)
This field is reserved for future use to allow object types
"^DD",2005.02,2005.02,4,21,2,0)
to inherit characteristics from other object types.
"^DD",2005.02,2005.02,4,"DT")
3001006
"^DD",2005.02,2005.02,5,0)
DEFAULT EXTENSION^F^^4;1^K:$L(X)>3!($L(X)<3) X
"^DD",2005.02,2005.02,5,1,0)
^.1
"^DD",2005.02,2005.02,5,1,1,0)
2005.02^AD
"^DD",2005.02,2005.02,5,1,1,1)
S ^MAG(2005.02,"AD",$E(X,1,30),DA)=""
"^DD",2005.02,2005.02,5,1,1,2)
K ^MAG(2005.02,"AD",$E(X,1,30),DA)
"^DD",2005.02,2005.02,5,1,1,"%D",0)
^.101^2^2^3020419^^
"^DD",2005.02,2005.02,5,1,1,"%D",1,0)
This cross-reference is searched when the extension of a file is known 
"^DD",2005.02,2005.02,5,1,1,"%D",2,0)
but not it's Object Type.
"^DD",2005.02,2005.02,5,1,1,"DT")
3010131
"^DD",2005.02,2005.02,5,3)
Enter the file extension to associate with this object type.  i.e. JPG, TGA, TXT, PDF, DOC...
"^DD",2005.02,2005.02,5,21,0)
3^.001^3^3^3020419^
"^DD",2005.02,2005.02,5,21,1,0)
This is the default extension for this type of object.
"^DD",2005.02,2005.02,5,21,2,0)
When Object Type is not known, at time of capture, the extension is 
"^DD",2005.02,2005.02,5,21,3,0)
used to determine the type.
"^DD",2005.02,2005.02,5,"DT")
3010131
"^DD",2005.02,2005.21,0)
ACTIONS SUB-FIELD^^.01^2
"^DD",2005.02,2005.21,0,"DT")
2950508
"^DD",2005.02,2005.21,0,"IX","B",2005.21,.01)

"^DD",2005.02,2005.21,0,"NM","ACTIONS")

"^DD",2005.02,2005.21,0,"UP")
2005.02
"^DD",2005.02,2005.21,.001,0)
NUMBER^NJ2,0^^ ^K:+X'=X!(X>20)!(X<1)!(X?.E1"."1N.N) X
"^DD",2005.02,2005.21,.001,3)
Type a Number between 1 and 20, 0 Decimal Digits
"^DD",2005.02,2005.21,.001,21,0)
^^1^1^3001025^
"^DD",2005.02,2005.21,.001,21,1,0)
Internal Entry number of the ACTIONS Multiple field.
"^DD",2005.02,2005.21,.001,"DT")
2930909
"^DD",2005.02,2005.21,.01,0)
ACTIONS^MF^^0;1^K:X[""""!($A(X)=45) X I $D(X) K:$L(X)>60!($L(X)<1) X
"^DD",2005.02,2005.21,.01,1,0)
^.1
"^DD",2005.02,2005.21,.01,1,1,0)
2005.21^B
"^DD",2005.02,2005.21,.01,1,1,1)
S ^MAG(2005.02,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",2005.02,2005.21,.01,1,1,2)
K ^MAG(2005.02,DA(1),1,"B",$E(X,1,30),DA)
"^DD",2005.02,2005.21,.01,1,2,0)
2005.02^AC^MUMPS
"^DD",2005.02,2005.21,.01,1,2,1)
D SETACT^MAGUXRF
"^DD",2005.02,2005.21,.01,1,2,2)
D KILLACT^MAGUXRF
"^DD",2005.02,2005.21,.01,1,2,"%D",0)
^^1^1^2930909^^
"^DD",2005.02,2005.21,.01,1,2,"%D",1,0)
Sets Object AC xref for displaying abstracts and objects.
"^DD",2005.02,2005.21,.01,1,2,"DT")
2930909
"^DD",2005.02,2005.21,.01,3)
Answer must be 1-60 characters in length.
"^DD",2005.02,2005.21,.01,21,0)
^^5^5^3001025^
"^DD",2005.02,2005.21,.01,21,1,0)
This field is reserved for future use will contain the kinds of actions
"^DD",2005.02,2005.21,.01,21,2,0)
which apply to the object type. Generally, all objects can be displayed as
"^DD",2005.02,2005.21,.01,21,3,0)
a full image/object and they have an abstract display method.  In
"^DD",2005.02,2005.21,.01,21,4,0)
addition, groups of objects may have other actions such as cineloop
"^DD",2005.02,2005.21,.01,21,5,0)
display or tiled display.
"^DD",2005.02,2005.21,.01,"DT")
2950508
"^DD",2005.02,2005.24,0)
CHILD CLASS SUB-FIELD^^.01^1
"^DD",2005.02,2005.24,0,"IX","B",2005.24,.01)

"^DD",2005.02,2005.24,0,"NM","CHILD CLASS")

"^DD",2005.02,2005.24,0,"UP")
2005.02
"^DD",2005.02,2005.24,.01,0)
CHILD CLASS^MP2005.02'^MAG(2005.02,^0;1^Q
"^DD",2005.02,2005.24,.01,1,0)
^.1
"^DD",2005.02,2005.24,.01,1,1,0)
2005.24^B
"^DD",2005.02,2005.24,.01,1,1,1)
S ^MAG(2005.02,DA(1),3,"B",$E(X,1,30),DA)=""
"^DD",2005.02,2005.24,.01,1,1,2)
K ^MAG(2005.02,DA(1),3,"B",$E(X,1,30),DA)
"^DD",2005.02,2005.24,.01,21,0)
^^2^2^3001025^
"^DD",2005.02,2005.24,.01,21,1,0)
This field is reserved for future use to allow object types
"^DD",2005.02,2005.24,.01,21,2,0)
to inherit characteristics from other object types.
"^DD",2005.02,2005.24,.01,"DT")
2910526
"^DD",2005.021,2005.021,0)
FIELD^^5^6
"^DD",2005.021,2005.021,0,"DDA")
N
"^DD",2005.021,2005.021,0,"DT")
3011008
"^DD",2005.021,2005.021,0,"IX","B",2005.021,.01)

"^DD",2005.021,2005.021,0,"IX","C",2005.021,1)

"^DD",2005.021,2005.021,0,"NM","IMAGE FILE TYPES")

"^DD",2005.021,2005.021,0,"VRPK")
MAG
"^DD",2005.021,2005.021,.01,0)
NAME^RF^^0;1^K:$L(X)>3!($L(X)<1)!'(X'?1P.E) X
"^DD",2005.021,2005.021,.01,1,0)
^.1
"^DD",2005.021,2005.021,.01,1,1,0)
2005.021^B
"^DD",2005.021,2005.021,.01,1,1,1)
S ^MAG(2005.021,"B",$E(X,1,30),DA)=""
"^DD",2005.021,2005.021,.01,1,1,2)
K ^MAG(2005.021,"B",$E(X,1,30),DA)
"^DD",2005.021,2005.021,.01,3)
Image file 3 character extension
"^DD",2005.021,2005.021,.01,21,0)
^.001^1^1^3020419^^
"^DD",2005.021,2005.021,.01,21,1,0)
This field contains the image filename extension, i.e., tga.
"^DD",2005.021,2005.021,.01,"DT")
3011008
"^DD",2005.021,2005.021,1,0)
DESCRIPTION^RF^^0;2^K:$L(X)>30!($L(X)<1) X
"^DD",2005.021,2005.021,1,1,0)
^.1
"^DD",2005.021,2005.021,1,1,1,0)
2005.021^C
"^DD",2005.021,2005.021,1,1,1,1)
S ^MAG(2005.021,"C",$E(X,1,30),DA)=""
"^DD",2005.021,2005.021,1,1,1,2)
K ^MAG(2005.021,"C",$E(X,1,30),DA)
"^DD",2005.021,2005.021,1,1,1,"%D",0)
^^1^1^3011008^
"^DD",2005.021,2005.021,1,1,1,"%D",1,0)
The 3 character image file extension.
"^DD",2005.021,2005.021,1,1,1,"DT")
3011008
"^DD",2005.021,2005.021,1,3)
Answer must be 1-30 characters in length.
"^DD",2005.021,2005.021,1,21,0)
^^2^2^3020419^
"^DD",2005.021,2005.021,1,21,1,0)
This field contains the description of the filename extension.  For 
"^DD",2005.021,2005.021,1,21,2,0)
example a filename extension of 'doc' is for Microsoft Word document.
"^DD",2005.021,2005.021,1,"DT")
3011008
"^DD",2005.021,2005.021,2,0)
VIEWER^RS^1:YES;0:NO;^0;3^Q
"^DD",2005.021,2005.021,2,21,0)
^^1^1^3011008^
"^DD",2005.021,2005.021,2,21,1,0)
Flag, Imaging provides a viewer for files with this extension Y/N
"^DD",2005.021,2005.021,2,"DT")
3011008
"^DD",2005.021,2005.021,3,0)
Bitmap for Abstract^F^^0;4^K:$L(X)>30!($L(X)<3) X
"^DD",2005.021,2005.021,3,3)
Answer must be 3-30 characters in length.
"^DD",2005.021,2005.021,3,21,0)
^^1^1^3011008^
"^DD",2005.021,2005.021,3,21,1,0)
If Imaging does not create abstracts for this type, this Bitmap will be used for the Abstract.
"^DD",2005.021,2005.021,3,"DT")
3011008
"^DD",2005.021,2005.021,4,0)
Abstract Created^RS^1:YES;0:NO;^0;5^Q
"^DD",2005.021,2005.021,4,3)
Enter Yes if Imaging will create an abstract for this file type.
"^DD",2005.021,2005.021,4,21,0)
^.001^2^2^3020419^^^
"^DD",2005.021,2005.021,4,21,1,0)
The Capture workstation and Background Processor will create abstracts for 
"^DD",2005.021,2005.021,4,21,2,0)
image files with this extension only if this field is Yes
"^DD",2005.021,2005.021,4,"DT")
3011008
"^DD",2005.021,2005.021,5,0)
DEFAULT OBJECT TYPE^P2005.02'^MAG(2005.02,^0;6^Q
"^DD",2005.021,2005.021,5,3)
Enter the Default Object Type for this file Extension
"^DD",2005.021,2005.021,5,21,0)
^^1^1^3011008^
"^DD",2005.021,2005.021,5,21,1,0)
Certain Extensions have a default Object Type defined in this field.
"^DD",2005.021,2005.021,5,"DT")
3011008
"^DD",2006.034,2006.034,0)
FIELD^^1^2
"^DD",2006.034,2006.034,0,"DDA")
N
"^DD",2006.034,2006.034,0,"DT")
3010405
"^DD",2006.034,2006.034,0,"IX","B",2006.034,.01)

"^DD",2006.034,2006.034,0,"NM","IMPORT QUEUE")

"^DD",2006.034,2006.034,0,"VRPK")
MAG
"^DD",2006.034,2006.034,.01,0)
NAME^RP2006.03X^MAGQUEUE(2006.03,^0;1^S DINUM=X
"^DD",2006.034,2006.034,.01,1,0)
^.1
"^DD",2006.034,2006.034,.01,1,1,0)
2006.034^B
"^DD",2006.034,2006.034,.01,1,1,1)
S ^MAG(2006.034,"B",$E(X,1,30),DA)=""
"^DD",2006.034,2006.034,.01,1,1,2)
K ^MAG(2006.034,"B",$E(X,1,30),DA)
"^DD",2006.034,2006.034,.01,3)
NAME MUST BE 3-30 CHARACTERS, NOT NUMERIC OR STARTING WITH PUNCTUATION
"^DD",2006.034,2006.034,.01,21,0)
^^8^8^3020419^
"^DD",2006.034,2006.034,.01,21,1,0)
This field is synchronized (DINUMed) with the original "IMPORT" queue
"^DD",2006.034,2006.034,.01,21,2,0)
created in the Image Background QUEUE file (#2006.03). The two
"^DD",2006.034,2006.034,.01,21,3,0)
files (2006.034 and 2006.03) are kept in sync by a reference
"^DD",2006.034,2006.034,.01,21,4,0)
in 2006.03 field QUEUE DATA ITEM (#10).  This back reference is
"^DD",2006.034,2006.034,.01,21,5,0)
necessary in cases of requeues.  The requeue process involves deleting
"^DD",2006.034,2006.034,.01,21,6,0)
the originally created 2006.03 entry, preserving field #10 data,
"^DD",2006.034,2006.034,.01,21,7,0)
and creating a new 2006.03 Import entry.  Thus the DINUM connection
"^DD",2006.034,2006.034,.01,21,8,0)
between the files 2006.03 and 2006.034 is otherwise broken.
"^DD",2006.034,2006.034,.01,"DT")
3020419
"^DD",2006.034,2006.034,1,0)
IMAGE DATA^2006.341A^^1;0
"^DD",2006.034,2006.341,0)
IMAGE DATA SUB-FIELD^^.01^1
"^DD",2006.034,2006.341,0,"DT")
3010405
"^DD",2006.034,2006.341,0,"NM","IMAGE DATA")

"^DD",2006.034,2006.341,0,"UP")
2006.034
"^DD",2006.034,2006.341,.01,0)
IMAGE DATA^F^^0;1^K:$L(X)>250!($L(X)<3) X
"^DD",2006.034,2006.341,.01,1,0)
^.1^^0
"^DD",2006.034,2006.341,.01,3)
Answer must be 3-250 characters in length.
"^DD",2006.034,2006.341,.01,21,0)
^^2^2^3020419^
"^DD",2006.034,2006.341,.01,21,1,0)
These entries are the parameters necessary to Import an image
"^DD",2006.034,2006.341,.01,21,2,0)
into the Vista Imaging network.
"^DD",2006.034,2006.341,.01,"DT")
3020419
"^DD",2006.04,2006.04,0)
FIELD^^2^3
"^DD",2006.04,2006.04,0,"DDA")
N
"^DD",2006.04,2006.04,0,"DT")
3020419
"^DD",2006.04,2006.04,0,"IX","B",2006.04,.01)

"^DD",2006.04,2006.04,0,"NM","ACQUISITION DEVICE")

"^DD",2006.04,2006.04,0,"PT",2005,107)

"^DD",2006.04,2006.04,0,"VRPK")
MAG
"^DD",2006.04,2006.04,.01,0)
NAME^RF^^0;1^K:$L(X)>30!(X?.N)!($L(X)<3)!'(X'?1P.E) X
"^DD",2006.04,2006.04,.01,1,0)
^.1
"^DD",2006.04,2006.04,.01,1,1,0)
2006.04^B
"^DD",2006.04,2006.04,.01,1,1,1)
S ^MAG(2006.04,"B",$E(X,1,30),DA)=""
"^DD",2006.04,2006.04,.01,1,1,2)
K ^MAG(2006.04,"B",$E(X,1,30),DA)
"^DD",2006.04,2006.04,.01,3)
NAME MUST BE 3-30 CHARACTERS, NOT NUMERIC OR STARTING WITH PUNCTUATION
"^DD",2006.04,2006.04,.01,21,0)
^^2^2^3020419^
"^DD",2006.04,2006.04,.01,21,1,0)
This is the name of the IMPORT device that is used to interface newly 
"^DD",2006.04,2006.04,.01,21,2,0)
captured diagnostic Images and procedures to the clinical database.
"^DD",2006.04,2006.04,.01,"DT")
3020419
"^DD",2006.04,2006.04,1,0)
SITE^P4'^DIC(4,^0;2^Q
"^DD",2006.04,2006.04,1,3)

"^DD",2006.04,2006.04,1,21,0)
^^2^2^3020419^
"^DD",2006.04,2006.04,1,21,1,0)
This field references Institution file to designate the facility that 
"^DD",2006.04,2006.04,1,21,2,0)
hosts this acquisition device.
"^DD",2006.04,2006.04,1,"DT")
3020419
"^DD",2006.04,2006.04,2,0)
LOCATION^P44'^SC(^0;3^Q
"^DD",2006.04,2006.04,2,21,0)
^.001^2^2^3020419^^
"^DD",2006.04,2006.04,2,21,1,0)
This field references the physical hospital location of the device that
"^DD",2006.04,2006.04,2,21,2,0)
captured the images.
"^DD",2006.04,2006.04,2,"DT")
3020419
"^DD",2006.041,2006.041,0)
FIELD^^4^6
"^DD",2006.041,2006.041,0,"DDA")
N
"^DD",2006.041,2006.041,0,"DT")
3010405
"^DD",2006.041,2006.041,0,"IX","B",2006.041,.01)

"^DD",2006.041,2006.041,0,"IX","C",2006.041,.02)

"^DD",2006.041,2006.041,0,"NM","ACQUISITION SESSION FILE")

"^DD",2006.041,2006.041,0,"VRPK")
MAG
"^DD",2006.041,2006.041,.01,0)
QUEUE^RNJ9,0X^^0;1^K:(X<1)!(X>999999999) X
"^DD",2006.041,2006.041,.01,1,0)
^.1
"^DD",2006.041,2006.041,.01,1,1,0)
2006.041^B
"^DD",2006.041,2006.041,.01,1,1,1)
S ^MAG(2006.041,"B",$E(X,1,30),DA)=""
"^DD",2006.041,2006.041,.01,1,1,2)
K ^MAG(2006.041,"B",$E(X,1,30),DA)
"^DD",2006.041,2006.041,.01,3)
Type a Number between 1 and 999999999, 0 Decimal Digits
"^DD",2006.041,2006.041,.01,21,0)
^^2^2^3020419^
"^DD",2006.041,2006.041,.01,21,1,0)
This field is synchronized with the Import Queue file (#2006.034).
"^DD",2006.041,2006.041,.01,21,2,0)
This allows the tracking of the  "IMPORT" process.
"^DD",2006.041,2006.041,.01,"DT")
3020419
"^DD",2006.041,2006.041,.02,0)
TRACKING ID^RF^^0;2^K:$L(X)>60!($L(X)<1) X
"^DD",2006.041,2006.041,.02,1,0)
^.1
"^DD",2006.041,2006.041,.02,1,1,0)
2006.041^C
"^DD",2006.041,2006.041,.02,1,1,1)
S ^MAG(2006.041,"C",$E(X,1,30),DA)=""
"^DD",2006.041,2006.041,.02,1,1,2)
K ^MAG(2006.041,"C",$E(X,1,30),DA)
"^DD",2006.041,2006.041,.02,1,1,"DT")
3010703
"^DD",2006.041,2006.041,.02,3)
Answer must be 1-60 characters in length.
"^DD",2006.041,2006.041,.02,21,0)
^^1^1^3020419^
"^DD",2006.041,2006.041,.02,21,1,0)
This is the unique identifier generated by the Import queueing process.
"^DD",2006.041,2006.041,.02,"DT")
3020419
"^DD",2006.041,2006.041,1,0)
ACTIVITY^F^^0;3^K:$L(X)>60!($L(X)<3) X
"^DD",2006.041,2006.041,1,3)
Answer must be 3-60 characters in length.
"^DD",2006.041,2006.041,1,21,0)
^^2^2^3020419^
"^DD",2006.041,2006.041,1,21,1,0)
This is the sub process event that is being captured as part of the 
"^DD",2006.041,2006.041,1,21,2,0)
Import process.
"^DD",2006.041,2006.041,1,"DT")
3020419
"^DD",2006.041,2006.041,2,0)
TIME^D^^0;4^S %DT="EST" D ^%DT S X=Y K:Y<1 X
"^DD",2006.041,2006.041,2,21,0)
^^1^1^3020419^
"^DD",2006.041,2006.041,2,21,1,0)
This is the precise date and time that this subprocess event occurred.
"^DD",2006.041,2006.041,2,"DT")
3020419
"^DD",2006.041,2006.041,3,0)
QUEUE STATUS^F^^0;5^K:$L(X)>30!($L(X)<3) X
"^DD",2006.041,2006.041,3,3)
Answer must be 3-30 characters in length.
"^DD",2006.041,2006.041,3,21,0)
^^2^2^3020419^
"^DD",2006.041,2006.041,3,21,1,0)
This is the current status information in re this 
"^DD",2006.041,2006.041,3,21,2,0)
subprocess event.
"^DD",2006.041,2006.041,3,"DT")
3020419
"^DD",2006.041,2006.041,4,0)
IMPORT PROCESS REMARKS^F^^0;6^K:$L(X)>60!($L(X)<3) X
"^DD",2006.041,2006.041,4,3)
Answer must be 3-60 characters in length.
"^DD",2006.041,2006.041,4,21,0)
^^1^1^3020419^
"^DD",2006.041,2006.041,4,21,1,0)
This is additional information regarding this Import process.
"^DD",2006.041,2006.041,4,"DT")
3020419
"^DD",2006.18,2006.18,8.5,0)
MAIN TOOLBAR^S^0:FALSE;1:TRUE;^MAIN;6^Q
"^DD",2006.18,2006.18,8.5,3)

"^DD",2006.18,2006.18,8.5,21,0)
^.001^1^1^3020419^^^
"^DD",2006.18,2006.18,8.5,21,1,0)
This determines if the Main Toolbar is Visible or Not.
"^DD",2006.18,2006.18,8.5,"DT")
3020225
"^DD",2006.81,2006.81,12.5,0)
IMPORT COUNT^NJ9,0^^0;14^K:+X'=X!(X>999999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.81,2006.81,12.5,3)
 This is the total count of Import sessions.
"^DD",2006.81,2006.81,12.5,21,0)
^.001^2^2^3020519^^
"^DD",2006.81,2006.81,12.5,21,1,0)
This is a count of the number of times the Import API was called with This
"^DD",2006.81,2006.81,12.5,21,2,0)
Workstation as the Acquisition Device.
"^DD",2006.81,2006.81,12.5,"DT")
3020506
"^DD",2006.81,2006.81,13,0)
OS VERSION^F^^1;2^K:$L(X)>100!($L(X)<3) X
"^DD",2006.81,2006.81,13,3)
Answer must be 3-100 characters in length.
"^DD",2006.81,2006.81,13,21,0)
^.001^1^1^3020419^^
"^DD",2006.81,2006.81,13,21,1,0)
This is the Operation System installed on this workstation.
"^DD",2006.81,2006.81,13,"DT")
3020417
"^DD",2006.82,2006.82,8,0)
TRACKING ID^F^^0;9^K:$L(X)>40!($L(X)<3) X
"^DD",2006.82,2006.82,8,1,0)
^.1
"^DD",2006.82,2006.82,8,1,1,0)
2006.82^E
"^DD",2006.82,2006.82,8,1,1,1)
S ^MAG(2006.82,"E",$E(X,1,30),DA)=""
"^DD",2006.82,2006.82,8,1,1,2)
K ^MAG(2006.82,"E",$E(X,1,30),DA)
"^DD",2006.82,2006.82,8,1,1,"%D",0)
^^1^1^3020506^
"^DD",2006.82,2006.82,8,1,1,"%D",1,0)
Tracking ID associated with the Import.
"^DD",2006.82,2006.82,8,1,1,"DT")
3020506
"^DD",2006.82,2006.82,8,3)
Answer must be 3-40 characters in length.
"^DD",2006.82,2006.82,8,21,0)
^^2^2^3020506^
"^DD",2006.82,2006.82,8,21,1,0)
This is the tracking id sent by the Application doing the Import
"^DD",2006.82,2006.82,8,21,2,0)
It is a unique number, to be used for tracking purposes.
"^DD",2006.82,2006.82,8,"DT")
3020506
"^DIC",2005.02,2005.02,0)
OBJECT TYPE^2005.02
"^DIC",2005.02,2005.02,0,"GL")
^MAG(2005.02,
"^DIC",2005.02,2005.02,"%",0)
^1.005^1^1
"^DIC",2005.02,2005.02,"%",1,0)
MAG
"^DIC",2005.02,2005.02,"%","B","MAG",1)

"^DIC",2005.02,2005.02,"%D",0)
^^57^57^3001006^
"^DIC",2005.02,2005.02,"%D",1,0)
 
"^DIC",2005.02,2005.02,"%D",2,0)
 +---------------------------------------------------------------+
"^DIC",2005.02,2005.02,"%D",3,0)
 |                                                               |
"^DIC",2005.02,2005.02,"%D",4,0)
 | Property of the US Government.                                |
"^DIC",2005.02,2005.02,"%D",5,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2005.02,2005.02,"%D",6,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2005.02,2005.02,"%D",7,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2005.02,2005.02,"%D",8,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2005.02,2005.02,"%D",9,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2005.02,2005.02,"%D",10,0)
 |                                                               |
"^DIC",2005.02,2005.02,"%D",11,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2005.02,2005.02,"%D",12,0)
 | a Class II medical device.  As such, it may not be changed    |
"^DIC",2005.02,2005.02,"%D",13,0)
 | in any way.  Modifications to this software may result in an  |
"^DIC",2005.02,2005.02,"%D",14,0)
 | adulterated medical device under 21CFR820, the use of which   |
"^DIC",2005.02,2005.02,"%D",15,0)
 | is considered to be a violation of US Federal Statutes.       |
"^DIC",2005.02,2005.02,"%D",16,0)
 |                                                               |
"^DIC",2005.02,2005.02,"%D",17,0)
 +---------------------------------------------------------------+
"^DIC",2005.02,2005.02,"%D",18,0)
 
"^DIC",2005.02,2005.02,"%D",19,0)
This file contains an entry for every type of object handled by the VistA
"^DIC",2005.02,2005.02,"%D",20,0)
Imaging System. It is exported with data. All sites must have entries
"^DIC",2005.02,2005.02,"%D",21,0)
for the data types distributed in order to display objects sent via
"^DIC",2005.02,2005.02,"%D",22,0)
multimedia mail.
"^DIC",2005.02,2005.02,"%D",23,0)
 The Object Type file handles objects of various types.  These include: 
"^DIC",2005.02,2005.02,"%D",24,0)
  * still images 
"^DIC",2005.02,2005.02,"%D",25,0)
  * image groups
"^DIC",2005.02,2005.02,"%D",26,0)
  * graphics or waveforms
"^DIC",2005.02,2005.02,"%D",27,0)
  * scanned documents
"^DIC",2005.02,2005.02,"%D",28,0)
  * audio files  
"^DIC",2005.02,2005.02,"%D",29,0)
 
"^DIC",2005.02,2005.02,"%D",30,0)
 Other types are expected in the future (i.e., image overlays,
"^DIC",2005.02,2005.02,"%D",31,0)
motion video chips, and office automation files).  An object,
"^DIC",2005.02,2005.02,"%D",32,0)
such as an image series, may actually consist of multiple
"^DIC",2005.02,2005.02,"%D",33,0)
objects.  In this case, the object type is Group.  The Object
"^DIC",2005.02,2005.02,"%D",34,0)
Group multiple field is used to point to a set of objects in the
"^DIC",2005.02,2005.02,"%D",35,0)
Image file.  Each object type has associated methods (software
"^DIC",2005.02,2005.02,"%D",36,0)
routines) for performing certain actions.  For example, there are
"^DIC",2005.02,2005.02,"%D",37,0)
methods for displaying images and image abstracts.  The group
"^DIC",2005.02,2005.02,"%D",38,0)
type is used to combine multiple objects of the same or different
"^DIC",2005.02,2005.02,"%D",39,0)
types to create complex objects.
"^DIC",2005.02,2005.02,"%D",40,0)
 
"^DIC",2005.02,2005.02,"%D",41,0)
 There are different image types, for example: 
"^DIC",2005.02,2005.02,"%D",42,0)
  * black and white high-resolution x-rays
"^DIC",2005.02,2005.02,"%D",43,0)
  * black and white ultrasound images (lower resolution)
"^DIC",2005.02,2005.02,"%D",44,0)
  * pseudo-color nuclear medicine scans
"^DIC",2005.02,2005.02,"%D",45,0)
  * medium resolution true color bronchoscopy images
"^DIC",2005.02,2005.02,"%D",46,0)
  * pathology images
"^DIC",2005.02,2005.02,"%D",47,0)
 
"^DIC",2005.02,2005.02,"%D",48,0)
 Each type of object has a number of specific characteristics,
"^DIC",2005.02,2005.02,"%D",49,0)
including the methods  required to display them.  For example,
"^DIC",2005.02,2005.02,"%D",50,0)
each object type has a type name and an associated display method
"^DIC",2005.02,2005.02,"%D",51,0)
or window.
"^DIC",2005.02,2005.02,"%D",52,0)
 
"^DIC",2005.02,2005.02,"%D",53,0)
 All accesses to objects use the file finder routine ^MAGFILE or
"^DIC",2005.02,2005.02,"%D",54,0)
^MAGFILEA to find the network location needed.  Different entry
"^DIC",2005.02,2005.02,"%D",55,0)
points of this routine will find locations of full files,
"^DIC",2005.02,2005.02,"%D",56,0)
abstract files, and jukebox copies of files.  In addition, the
"^DIC",2005.02,2005.02,"%D",57,0)
network write location will be returned for image captures.
"^DIC",2005.02,"B","OBJECT TYPE",2005.02)

"^DIC",2005.021,2005.021,0)
IMAGE FILE TYPES^2005.021
"^DIC",2005.021,2005.021,0,"GL")
^MAG(2005.021,
"^DIC",2005.021,2005.021,"%",0)
^1.005^^0
"^DIC",2005.021,2005.021,"%D",0)
^^21^21^3020419^
"^DIC",2005.021,2005.021,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2005.021,2005.021,"%D",2,0)
 |                                                               |
"^DIC",2005.021,2005.021,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2005.021,2005.021,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2005.021,2005.021,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2005.021,2005.021,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2005.021,2005.021,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2005.021,2005.021,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2005.021,2005.021,"%D",9,0)
 |                                                               |
"^DIC",2005.021,2005.021,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2005.021,2005.021,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2005.021,2005.021,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2005.021,2005.021,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2005.021,2005.021,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2005.021,2005.021,"%D",15,0)
 |                                                               |
"^DIC",2005.021,2005.021,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2005.021,2005.021,"%D",17,0)
 
"^DIC",2005.021,2005.021,"%D",18,0)
This file contains all the image filename extensions supported by 
"^DIC",2005.021,2005.021,"%D",19,0)
Imaging and specific characteristics for the filename extensions. 
"^DIC",2005.021,2005.021,"%D",20,0)
This is a static file only updated by newer versions of the Imaging 
"^DIC",2005.021,2005.021,"%D",21,0)
application. 
"^DIC",2005.021,"B","IMAGE FILE TYPES",2005.021)

"^DIC",2006.034,2006.034,0)
IMPORT QUEUE^2006.034
"^DIC",2006.034,2006.034,0,"GL")
^MAG(2006.034,
"^DIC",2006.034,2006.034,"%",0)
^1.005^^0
"^DIC",2006.034,2006.034,"%D",0)
^^20^20^3020419^
"^DIC",2006.034,2006.034,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.034,2006.034,"%D",2,0)
 |                                                               |
"^DIC",2006.034,2006.034,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.034,2006.034,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.034,2006.034,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.034,2006.034,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.034,2006.034,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.034,2006.034,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.034,2006.034,"%D",9,0)
 |                                                               |
"^DIC",2006.034,2006.034,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.034,2006.034,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.034,2006.034,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.034,2006.034,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.034,2006.034,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.034,2006.034,"%D",15,0)
 |                                                               |
"^DIC",2006.034,2006.034,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.034,2006.034,"%D",17,0)
 
"^DIC",2006.034,2006.034,"%D",18,0)
This file is necessary to manage the rich data set that is passed during 
"^DIC",2006.034,2006.034,"%D",19,0)
the Import queue event.  It is kept in sync with the Image Background
"^DIC",2006.034,2006.034,"%D",20,0)
Queue file (#2006.03) through the 2006.03's field #10 QUEUE DATA ITEM.
"^DIC",2006.034,"B","IMPORT QUEUE",2006.034)

"^DIC",2006.04,2006.04,0)
ACQUISITION DEVICE^2006.04
"^DIC",2006.04,2006.04,0,"GL")
^MAG(2006.04,
"^DIC",2006.04,2006.04,"%",0)
^1.005^^0
"^DIC",2006.04,2006.04,"%D",0)
^^19^19^3020419^
"^DIC",2006.04,2006.04,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.04,2006.04,"%D",2,0)
 |                                                               |
"^DIC",2006.04,2006.04,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.04,2006.04,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.04,2006.04,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.04,2006.04,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.04,2006.04,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.04,2006.04,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.04,2006.04,"%D",9,0)
 |                                                               |
"^DIC",2006.04,2006.04,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.04,2006.04,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.04,2006.04,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.04,2006.04,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.04,2006.04,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.04,2006.04,"%D",15,0)
 |                                                               |
"^DIC",2006.04,2006.04,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.04,2006.04,"%D",17,0)
 
"^DIC",2006.04,2006.04,"%D",18,0)
This file is used to manage and track the various devices used to 
"^DIC",2006.04,2006.04,"%D",19,0)
"Import" images into the Vista Imaging network.
"^DIC",2006.04,"B","ACQUISITION DEVICE",2006.04)

"^DIC",2006.041,2006.041,0)
ACQUISITION SESSION FILE^2006.041
"^DIC",2006.041,2006.041,0,"GL")
^MAG(2006.041,
"^DIC",2006.041,2006.041,"%",0)
^1.005^^0
"^DIC",2006.041,2006.041,"%D",0)
^^19^19^3020419^
"^DIC",2006.041,2006.041,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.041,2006.041,"%D",2,0)
 |                                                               |
"^DIC",2006.041,2006.041,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.041,2006.041,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.041,2006.041,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.041,2006.041,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.041,2006.041,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.041,2006.041,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.041,2006.041,"%D",9,0)
 |                                                               |
"^DIC",2006.041,2006.041,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.041,2006.041,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.041,2006.041,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.041,2006.041,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.041,2006.041,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.041,2006.041,"%D",15,0)
 |                                                               |
"^DIC",2006.041,2006.041,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.041,2006.041,"%D",17,0)
This file is used to archive and document each of the subprocesses
"^DIC",2006.041,2006.041,"%D",18,0)
involved in managing Import queues.  It is a potential source of 
"^DIC",2006.041,2006.041,"%D",19,0)
information regarding the isolation of inefficient Import processes.
"^DIC",2006.041,"B","ACQUISITION SESSION FILE",2006.041)

**END**
**END**

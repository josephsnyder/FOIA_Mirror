KIDS Distribution saved on Feb 16, 2007@14:31:46
VistA Imaging V3.0 - Patch 46 02/16/2007 14:31PM
**KIDS**:MAG*3.0*46^

**INSTALL NAME**
MAG*3.0*46
"BLD",3463,0)
MAG*3.0*46^IMAGING^0^3070216^y
"BLD",3463,1,0)
^^72^72^3070216^
"BLD",3463,1,1,0)
Version 3.0 Patch 46 - TeleReader
"BLD",3463,1,2,0)
 
"BLD",3463,1,3,0)
 
"BLD",3463,1,4,0)
 
"BLD",3463,1,5,0)
 
"BLD",3463,1,6,0)
 
"BLD",3463,1,7,0)
 
"BLD",3463,1,8,0)
 
"BLD",3463,1,9,0)
 
"BLD",3463,1,10,0)
 
"BLD",3463,1,11,0)
This package contains a KIDS component
"BLD",3463,1,12,0)
for patch 46.
"BLD",3463,1,13,0)
 
"BLD",3463,1,14,0)
This package transports the remote procedure call named MAGGUSER2.
"BLD",3463,1,15,0)
 
"BLD",3463,1,16,0)
This package contains a KIDS component
"BLD",3463,1,17,0)
for patch 46.
"BLD",3463,1,18,0)
 
"BLD",3463,1,19,0)
This package transports the remote procedure call named MAGG GET TIMEOUT.
"BLD",3463,1,20,0)
 
"BLD",3463,1,21,0)
We are sending a modified entry in the Remote Procedure File
"BLD",3463,1,22,0)
MAGG PAT INFO has been modified to handle ICN.
"BLD",3463,1,23,0)
 
"BLD",3463,1,24,0)
 
"BLD",3463,1,25,0)
 
"BLD",3463,1,26,0)
TeleReader Unlock a Study.
"BLD",3463,1,27,0)
 
"BLD",3463,1,28,0)
 
"BLD",3463,1,29,0)
 
"BLD",3463,1,30,0)
Imaging User Preferences file (2006.18)
"BLD",3463,1,31,0)
 
"BLD",3463,1,32,0)
Imaging Site Parameters File (2006.1)1
"BLD",3463,1,33,0)
 
"BLD",3463,1,34,0)
P46
"BLD",3463,1,35,0)
 
"BLD",3463,1,36,0)
P46
"BLD",3463,1,37,0)
 
"BLD",3463,1,38,0)
P46
"BLD",3463,1,39,0)
 
"BLD",3463,1,40,0)
 
"BLD",3463,1,41,0)
Routines:
"BLD",3463,1,42,0)
MAGDHRC0    old value = 4285870, new value = 7139686
"BLD",3463,1,43,0)
MAGDHWC     old value = 12104444, new value = 46727596
"BLD",3463,1,44,0)
MAGDIR81    old value = 16164949, new value = 75253415
"BLD",3463,1,45,0)
MAGDIR9A    old value = 11384181, new value = 49652107
"BLD",3463,1,46,0)
MAGDIR9E    old value = 14829187, new value = 69820632
"BLD",3463,1,47,0)
MAGDTR01    old value = 10072315, new value = 41301476
"BLD",3463,1,48,0)
MAGDTR02    old value = 11542794, new value = 34387376
"BLD",3463,1,49,0)
MAGDTR03    old value = 17747636, new value = 74996162
"BLD",3463,1,50,0)
MAGDTR04    old value = 8324327, new value = 21144013
"BLD",3463,1,51,0)
MAGDTR05    old value = 12647049, new value = 47917279
"BLD",3463,1,52,0)
MAGDTR06    old value = 10053102, new value = 24321973
"BLD",3463,1,53,0)
MAGDTRDX    old value = 8254807, new value = 23866845
"BLD",3463,1,54,0)
MAGDTRLU    old value = 7439670, new value = 19829856
"BLD",3463,1,55,0)
MAGGNLKP    old value = 6081621, new value = 14406989
"BLD",3463,1,56,0)
MAGGNTI1    old value = 11025078, new value = 42165742
"BLD",3463,1,57,0)
MAGGNTI2    old value = 7904476, new value = 21364059
"BLD",3463,1,58,0)
MAGGNTI3    old value = 5195830, new value = 11337599
"BLD",3463,1,59,0)
MAGGTPT1    old value = 8609100, new value = 31690840
"BLD",3463,1,60,0)
MAGGTU3     old value = 12647741, new value = 60295465
"BLD",3463,1,61,0)
MAGGTU31    old value = 6267048, new value = 11386631
"BLD",3463,1,62,0)
MAGGTU4     old value = 9595917, new value = 38056639
"BLD",3463,1,63,0)
MAGGTU41    old value = 10672702, new value = 28753465
"BLD",3463,1,64,0)
MAGGTU6     old value = 11306571, new value = 47950774
"BLD",3463,1,65,0)
MAGGTU71    old value = 6245772, new value = 12430671
"BLD",3463,1,66,0)
MAGIPS46    old value = 9488645, new value = 28437566
"BLD",3463,1,67,0)
MAGQE3      old value = 15888752, new value = 75156361
"BLD",3463,1,68,0)
MAGQE5      old value = 13158187, new value = 54546885
"BLD",3463,1,69,0)
MAGQE6      old value = 5946318, new value = 11312577
"BLD",3463,1,70,0)
 
"BLD",3463,1,71,0)
Please note that routine MAGIPS46 is deleted after the KIDS Build is
"BLD",3463,1,72,0)
installed.
"BLD",3463,4,0)
^9.64PA^2006.5849^6
"BLD",3463,4,2006.1,0)
2006.1
"BLD",3463,4,2006.1,2,0)
^9.641^2006.1^1
"BLD",3463,4,2006.1,2,2006.1,0)
IMAGING SITE PARAMETERS  (File-top level)
"BLD",3463,4,2006.1,2,2006.1,1,0)
^9.6411^131^1
"BLD",3463,4,2006.1,2,2006.1,1,131,0)
TELEREADER TIMEOUT (MINUTES)
"BLD",3463,4,2006.1,222)
y^y^p^^^^n^^n
"BLD",3463,4,2006.1,224)

"BLD",3463,4,2006.18,0)
2006.18
"BLD",3463,4,2006.18,2,0)
^9.641^2006.18^1
"BLD",3463,4,2006.18,2,2006.18,0)
IMAGING USER PREFERENCE  (File-top level)
"BLD",3463,4,2006.18,2,2006.18,1,0)
^9.6411^303^16
"BLD",3463,4,2006.18,2,2006.18,1,200,0)
TELEREADER FORM STYLE
"BLD",3463,4,2006.18,2,2006.18,1,201,0)
TELEREADER LEFT
"BLD",3463,4,2006.18,2,2006.18,1,202,0)
TELEREADER TOP
"BLD",3463,4,2006.18,2,2006.18,1,203,0)
TELEREADER WIDTH
"BLD",3463,4,2006.18,2,2006.18,1,204,0)
TELEREADER HEIGHT
"BLD",3463,4,2006.18,2,2006.18,1,205,0)
TELEREADER SHOW OR NOT SHOW
"BLD",3463,4,2006.18,2,2006.18,1,206,0)
TELEREADER UNREAD COL WIDTHS
"BLD",3463,4,2006.18,2,2006.18,1,207,0)
TELEREADER AUTO-LAUNCH
"BLD",3463,4,2006.18,2,2006.18,1,208,0)
TELEREADER VIEW ALL STUDIES
"BLD",3463,4,2006.18,2,2006.18,1,209,0)
TELEREADER SHOW DIALOG
"BLD",3463,4,2006.18,2,2006.18,1,210,0)
TELEREADER SAVE SETTINGS
"BLD",3463,4,2006.18,2,2006.18,1,211,0)
TELEREADER READ COL WIDTHS
"BLD",3463,4,2006.18,2,2006.18,1,300,0)
RIVER AUTO CONNECT ENABLED
"BLD",3463,4,2006.18,2,2006.18,1,301,0)
RIVER CONNECT VISN ONLY
"BLD",3463,4,2006.18,2,2006.18,1,302,0)
RIVER HIDE EMPTY SITES
"BLD",3463,4,2006.18,2,2006.18,1,303,0)
RIVER HIDE DISCONNECTED SITES
"BLD",3463,4,2006.18,222)
y^y^p^^^^n^^n
"BLD",3463,4,2006.18,224)

"BLD",3463,4,2006.5841,0)
2006.5841
"BLD",3463,4,2006.5841,222)
y^y^f^^^^n
"BLD",3463,4,2006.5842,0)
2006.5842
"BLD",3463,4,2006.5842,222)
y^y^f^^^^n
"BLD",3463,4,2006.5843,0)
2006.5843
"BLD",3463,4,2006.5843,222)
y^y^f^^^^n
"BLD",3463,4,2006.5849,0)
2006.5849
"BLD",3463,4,2006.5849,222)
y^y^f^^^^n
"BLD",3463,4,"APDD",2006.1,2006.1)

"BLD",3463,4,"APDD",2006.1,2006.1)

"BLD",3463,4,"APDD",2006.1,2006.1,131)

"BLD",3463,4,"APDD",2006.18,2006.18)

"BLD",3463,4,"APDD",2006.18,2006.18,200)

"BLD",3463,4,"APDD",2006.18,2006.18,201)

"BLD",3463,4,"APDD",2006.18,2006.18,202)

"BLD",3463,4,"APDD",2006.18,2006.18,203)

"BLD",3463,4,"APDD",2006.18,2006.18,204)

"BLD",3463,4,"APDD",2006.18,2006.18,205)

"BLD",3463,4,"APDD",2006.18,2006.18,206)

"BLD",3463,4,"APDD",2006.18,2006.18,207)

"BLD",3463,4,"APDD",2006.18,2006.18,208)

"BLD",3463,4,"APDD",2006.18,2006.18,209)

"BLD",3463,4,"APDD",2006.18,2006.18,210)

"BLD",3463,4,"APDD",2006.18,2006.18,211)

"BLD",3463,4,"APDD",2006.18,2006.18,300)

"BLD",3463,4,"APDD",2006.18,2006.18,301)

"BLD",3463,4,"APDD",2006.18,2006.18,302)

"BLD",3463,4,"APDD",2006.18,2006.18,303)

"BLD",3463,4,"B",2006.1,2006.1)

"BLD",3463,4,"B",2006.18,2006.18)

"BLD",3463,4,"B",2006.5841,2006.5841)

"BLD",3463,4,"B",2006.5842,2006.5842)

"BLD",3463,4,"B",2006.5843,2006.5843)

"BLD",3463,4,"B",2006.5849,2006.5849)

"BLD",3463,"ABNS",0)
^9.66A^^
"BLD",3463,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@DOMAIN.EXT
"BLD",3463,"INID")
n^y^n
"BLD",3463,"INIT")
POST^MAGIPS46
"BLD",3463,"KRN",0)
^9.67PA^8994^19
"BLD",3463,"KRN",.4,0)
.4
"BLD",3463,"KRN",.4,"NM",0)
^9.68A^4^4
"BLD",3463,"KRN",.4,"NM",1,0)
MAGREADTIME^^0
"BLD",3463,"KRN",.4,"NM",2,0)
MAGREPAIR^^0
"BLD",3463,"KRN",.4,"NM",3,0)
MAGSTATUS^^0
"BLD",3463,"KRN",.4,"NM",4,0)
MAGUSER^^0
"BLD",3463,"KRN",.4,"NM","B","MAGREADTIME",1)

"BLD",3463,"KRN",.4,"NM","B","MAGREPAIR",2)

"BLD",3463,"KRN",.4,"NM","B","MAGSTATUS",3)

"BLD",3463,"KRN",.4,"NM","B","MAGUSER",4)

"BLD",3463,"KRN",.401,0)
.401
"BLD",3463,"KRN",.401,"NM",0)
^9.68A^3^3
"BLD",3463,"KRN",.401,"NM",1,0)
MAGREADER^^0
"BLD",3463,"KRN",.401,"NM",2,0)
MAGREPAIR^^0
"BLD",3463,"KRN",.401,"NM",3,0)
MAGSTATUS^^0
"BLD",3463,"KRN",.401,"NM","B","MAGREADER",1)

"BLD",3463,"KRN",.401,"NM","B","MAGREPAIR",2)

"BLD",3463,"KRN",.401,"NM","B","MAGSTATUS",3)

"BLD",3463,"KRN",.402,0)
.402
"BLD",3463,"KRN",.402,"NM",0)
^9.68A^^
"BLD",3463,"KRN",.403,0)
.403
"BLD",3463,"KRN",.5,0)
.5
"BLD",3463,"KRN",.84,0)
.84
"BLD",3463,"KRN",3.6,0)
3.6
"BLD",3463,"KRN",3.8,0)
3.8
"BLD",3463,"KRN",9.2,0)
9.2
"BLD",3463,"KRN",9.8,0)
9.8
"BLD",3463,"KRN",9.8,"NM",0)
^9.68A^27^27
"BLD",3463,"KRN",9.8,"NM",1,0)
MAGDHRC0^^0^B7139686
"BLD",3463,"KRN",9.8,"NM",2,0)
MAGDHWC^^0^B46727596
"BLD",3463,"KRN",9.8,"NM",3,0)
MAGDIR81^^0^B75253415
"BLD",3463,"KRN",9.8,"NM",4,0)
MAGDIR9A^^0^B49652107
"BLD",3463,"KRN",9.8,"NM",5,0)
MAGDIR9E^^0^B69820632
"BLD",3463,"KRN",9.8,"NM",6,0)
MAGDTR01^^0^B41301476
"BLD",3463,"KRN",9.8,"NM",7,0)
MAGDTR02^^0^B34387376
"BLD",3463,"KRN",9.8,"NM",8,0)
MAGDTR03^^0^B74996162
"BLD",3463,"KRN",9.8,"NM",9,0)
MAGDTR04^^0^B21144013
"BLD",3463,"KRN",9.8,"NM",10,0)
MAGDTR05^^0^B47917279
"BLD",3463,"KRN",9.8,"NM",11,0)
MAGDTR06^^0^B24321973
"BLD",3463,"KRN",9.8,"NM",12,0)
MAGDTRDX^^0^B23866845
"BLD",3463,"KRN",9.8,"NM",13,0)
MAGDTRLU^^0^B19829856
"BLD",3463,"KRN",9.8,"NM",14,0)
MAGGNLKP^^0^B14406989
"BLD",3463,"KRN",9.8,"NM",15,0)
MAGGNTI1^^0^B42165742
"BLD",3463,"KRN",9.8,"NM",16,0)
MAGGNTI2^^0^B21364059
"BLD",3463,"KRN",9.8,"NM",17,0)
MAGGNTI3^^0^B11337599
"BLD",3463,"KRN",9.8,"NM",18,0)
MAGGTPT1^^0^B31690840
"BLD",3463,"KRN",9.8,"NM",19,0)
MAGGTU3^^0^B60295465
"BLD",3463,"KRN",9.8,"NM",20,0)
MAGGTU31^^0^B11386631
"BLD",3463,"KRN",9.8,"NM",21,0)
MAGGTU4^^0^B38056639
"BLD",3463,"KRN",9.8,"NM",22,0)
MAGGTU41^^0^B28753465
"BLD",3463,"KRN",9.8,"NM",23,0)
MAGGTU6^^0^B47950774
"BLD",3463,"KRN",9.8,"NM",24,0)
MAGGTU71^^0^B12430671
"BLD",3463,"KRN",9.8,"NM",25,0)
MAGQE3^^0^B75156361
"BLD",3463,"KRN",9.8,"NM",26,0)
MAGQE5^^0^B54546885
"BLD",3463,"KRN",9.8,"NM",27,0)
MAGQE6^^0^B11312577
"BLD",3463,"KRN",9.8,"NM","B","MAGDHRC0",1)

"BLD",3463,"KRN",9.8,"NM","B","MAGDHWC",2)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR81",3)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR9A",4)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR9E",5)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTR01",6)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTR02",7)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTR03",8)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTR04",9)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTR05",10)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTR06",11)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTRDX",12)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTRLU",13)

"BLD",3463,"KRN",9.8,"NM","B","MAGGNLKP",14)

"BLD",3463,"KRN",9.8,"NM","B","MAGGNTI1",15)

"BLD",3463,"KRN",9.8,"NM","B","MAGGNTI2",16)

"BLD",3463,"KRN",9.8,"NM","B","MAGGNTI3",17)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTPT1",18)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTU3",19)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTU31",20)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTU4",21)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTU41",22)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTU6",23)

"BLD",3463,"KRN",9.8,"NM","B","MAGGTU71",24)

"BLD",3463,"KRN",9.8,"NM","B","MAGQE3",25)

"BLD",3463,"KRN",9.8,"NM","B","MAGQE5",26)

"BLD",3463,"KRN",9.8,"NM","B","MAGQE6",27)

"BLD",3463,"KRN",19,0)
19
"BLD",3463,"KRN",19,"NM",0)
^9.68A^8^8
"BLD",3463,"KRN",19,"NM",1,0)
MAG SYS MENU^^2
"BLD",3463,"KRN",19,"NM",2,0)
MAGT READER ACTIVITY REP^^0
"BLD",3463,"KRN",19,"NM",3,0)
MAGT READING TIME REPORT^^0
"BLD",3463,"KRN",19,"NM",4,0)
MAGT REPAIR TR PROBLEMS^^0
"BLD",3463,"KRN",19,"NM",5,0)
MAGT REPORT TR PROBLEMS^^0
"BLD",3463,"KRN",19,"NM",6,0)
MAGT SETUP REPORT^^0
"BLD",3463,"KRN",19,"NM",7,0)
MAGT STATUS REPORT^^0
"BLD",3463,"KRN",19,"NM",8,0)
MAGT TELEREADER MENU^^0
"BLD",3463,"KRN",19,"NM","B","MAG SYS MENU",1)

"BLD",3463,"KRN",19,"NM","B","MAGT READER ACTIVITY REP",2)

"BLD",3463,"KRN",19,"NM","B","MAGT READING TIME REPORT",3)

"BLD",3463,"KRN",19,"NM","B","MAGT REPAIR TR PROBLEMS",4)

"BLD",3463,"KRN",19,"NM","B","MAGT REPORT TR PROBLEMS",5)

"BLD",3463,"KRN",19,"NM","B","MAGT SETUP REPORT",6)

"BLD",3463,"KRN",19,"NM","B","MAGT STATUS REPORT",7)

"BLD",3463,"KRN",19,"NM","B","MAGT TELEREADER MENU",8)

"BLD",3463,"KRN",19.1,0)
19.1
"BLD",3463,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",3463,"KRN",101,0)
101
"BLD",3463,"KRN",101,"NM",0)
^9.68A^^
"BLD",3463,"KRN",409.61,0)
409.61
"BLD",3463,"KRN",771,0)
771
"BLD",3463,"KRN",771,"NM",0)
^9.68A^^
"BLD",3463,"KRN",870,0)
870
"BLD",3463,"KRN",870,"NM",0)
^9.68A^^
"BLD",3463,"KRN",8989.51,0)
8989.51
"BLD",3463,"KRN",8989.52,0)
8989.52
"BLD",3463,"KRN",8994,0)
8994
"BLD",3463,"KRN",8994,"NM",0)
^9.68A^8^8
"BLD",3463,"KRN",8994,"NM",1,0)
MAG DICOM CON GET TELE READER^^0
"BLD",3463,"KRN",8994,"NM",2,0)
MAG DICOM CON SET TELE READER^^0
"BLD",3463,"KRN",8994,"NM",3,0)
MAG DICOM CON UNREAD ACQ SITES^^0
"BLD",3463,"KRN",8994,"NM",4,0)
MAG DICOM CON UNREADLIST GET^^0
"BLD",3463,"KRN",8994,"NM",5,0)
MAG DICOM CON UNREADLIST LOCK^^0
"BLD",3463,"KRN",8994,"NM",6,0)
MAGG GET TIMEOUT^^0
"BLD",3463,"KRN",8994,"NM",7,0)
MAGG PAT INFO^^0
"BLD",3463,"KRN",8994,"NM",8,0)
MAGGUSER2^^0
"BLD",3463,"KRN",8994,"NM","B","MAG DICOM CON GET TELE READER",1)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM CON SET TELE READER",2)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM CON UNREAD ACQ SITES",3)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM CON UNREADLIST GET",4)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM CON UNREADLIST LOCK",5)

"BLD",3463,"KRN",8994,"NM","B","MAGG GET TIMEOUT",6)

"BLD",3463,"KRN",8994,"NM","B","MAGG PAT INFO",7)

"BLD",3463,"KRN",8994,"NM","B","MAGGUSER2",8)

"BLD",3463,"KRN","B",.4,.4)

"BLD",3463,"KRN","B",.401,.401)

"BLD",3463,"KRN","B",.402,.402)

"BLD",3463,"KRN","B",.403,.403)

"BLD",3463,"KRN","B",.5,.5)

"BLD",3463,"KRN","B",.84,.84)

"BLD",3463,"KRN","B",3.6,3.6)

"BLD",3463,"KRN","B",3.8,3.8)

"BLD",3463,"KRN","B",9.2,9.2)

"BLD",3463,"KRN","B",9.8,9.8)

"BLD",3463,"KRN","B",19,19)

"BLD",3463,"KRN","B",19.1,19.1)

"BLD",3463,"KRN","B",101,101)

"BLD",3463,"KRN","B",409.61,409.61)

"BLD",3463,"KRN","B",771,771)

"BLD",3463,"KRN","B",870,870)

"BLD",3463,"KRN","B",8989.51,8989.51)

"BLD",3463,"KRN","B",8989.52,8989.52)

"BLD",3463,"KRN","B",8994,8994)

"BLD",3463,"REQB",0)
^9.611^3^3
"BLD",3463,"REQB",1,0)
GMRC*3.0*51^2
"BLD",3463,"REQB",2,0)
MAG*3.0*50^2
"BLD",3463,"REQB",3,0)
TIU*1.0*223^2
"BLD",3463,"REQB","B","GMRC*3.0*51",1)

"BLD",3463,"REQB","B","MAG*3.0*50",2)

"BLD",3463,"REQB","B","TIU*1.0*223",3)

"FIA",2006.1)
IMAGING SITE PARAMETERS
"FIA",2006.1,0)
^MAG(2006.1,
"FIA",2006.1,0,0)
2006.1I
"FIA",2006.1,0,1)
y^y^p^^^^n^^n
"FIA",2006.1,0,10)

"FIA",2006.1,0,11)

"FIA",2006.1,0,"RLRO")

"FIA",2006.1,2006.1)
1
"FIA",2006.1,2006.1,131)

"FIA",2006.18)
IMAGING USER PREFERENCE
"FIA",2006.18,0)
^MAG(2006.18,
"FIA",2006.18,0,0)
2006.18
"FIA",2006.18,0,1)
y^y^p^^^^n^^n
"FIA",2006.18,0,10)

"FIA",2006.18,0,11)

"FIA",2006.18,0,"RLRO")

"FIA",2006.18,2006.18)
1
"FIA",2006.18,2006.18,200)

"FIA",2006.18,2006.18,201)

"FIA",2006.18,2006.18,202)

"FIA",2006.18,2006.18,203)

"FIA",2006.18,2006.18,204)

"FIA",2006.18,2006.18,205)

"FIA",2006.18,2006.18,206)

"FIA",2006.18,2006.18,207)

"FIA",2006.18,2006.18,208)

"FIA",2006.18,2006.18,209)

"FIA",2006.18,2006.18,210)

"FIA",2006.18,2006.18,211)

"FIA",2006.18,2006.18,300)

"FIA",2006.18,2006.18,301)

"FIA",2006.18,2006.18,302)

"FIA",2006.18,2006.18,303)

"FIA",2006.5841)
TELEREADER ACQUISITION SERVICE
"FIA",2006.5841,0)
^MAG(2006.5841,
"FIA",2006.5841,0,0)
2006.5841IP
"FIA",2006.5841,0,1)
y^y^f^^^^n
"FIA",2006.5841,0,10)

"FIA",2006.5841,0,11)

"FIA",2006.5841,0,"RLRO")

"FIA",2006.5841,2006.5841)
0
"FIA",2006.5842)
TELEREADER ACQUISITION SITE
"FIA",2006.5842,0)
^MAG(2006.5842,
"FIA",2006.5842,0,0)
2006.5842P
"FIA",2006.5842,0,1)
y^y^f^^^^n
"FIA",2006.5842,0,10)

"FIA",2006.5842,0,11)

"FIA",2006.5842,0,"RLRO")

"FIA",2006.5842,2006.5842)
0
"FIA",2006.5843)
TELEREADER READER
"FIA",2006.5843,0)
^MAG(2006.5843,
"FIA",2006.5843,0,0)
2006.5843P
"FIA",2006.5843,0,1)
y^y^f^^^^n
"FIA",2006.5843,0,10)

"FIA",2006.5843,0,11)

"FIA",2006.5843,0,"RLRO")

"FIA",2006.5843,2006.5843)
0
"FIA",2006.5843,2006.58431)
0
"FIA",2006.5843,2006.584311)
0
"FIA",2006.5843,2006.5843111)
0
"FIA",2006.5849)
TELEREADER READ/UNREAD LIST
"FIA",2006.5849,0)
^MAG(2006.5849,
"FIA",2006.5849,0,0)
2006.5849
"FIA",2006.5849,0,1)
y^y^f^^^^n
"FIA",2006.5849,0,10)

"FIA",2006.5849,0,11)

"FIA",2006.5849,0,"RLRO")

"FIA",2006.5849,2006.5849)
0
"INIT")
POST^MAGIPS46
"IX",2006.5841,2006.5841,"AC",0)
2006.5841^AC^Service/Procedure Index^MU^^R^IR^I^2006.5841^^^^^A
"IX",2006.5841,2006.5841,"AC",1)
I X2(1)'="" S ^MAG(2006.5841,"AC",$E(X2(1),1,30),+$E(X2(2),1,30),DA)=""
"IX",2006.5841,2006.5841,"AC",2)
K ^MAG(2006.5841,"AC",$E(X1(1),1,30),+$E(X1(2),1,30),DA)
"IX",2006.5841,2006.5841,"AC",11.1,0)
^.114IA^2^2
"IX",2006.5841,2006.5841,"AC",11.1,1,0)
1^F^2006.5841^.01^^^F
"IX",2006.5841,2006.5841,"AC",11.1,1,3)

"IX",2006.5841,2006.5841,"AC",11.1,2,0)
2^F^2006.5841^1^^^F
"IX",2006.5841,2006.5841,"AC",11.1,2,3)

"IX",2006.5849,2006.5849,"AC",0)
2006.5849^AC^Specialty/Index^R^^R^IR^I^2006.5849^^^^^S
"IX",2006.5849,2006.5849,"AC",1)
S ^MAG(2006.5849,"AC",$E(X(1),1,30),$E(X(2),1,30),$E(X(3),1,30),$E(X(4),1,30),DA)=""
"IX",2006.5849,2006.5849,"AC",2)
K ^MAG(2006.5849,"AC",$E(X(1),1,30),$E(X(2),1,30),$E(X(3),1,30),$E(X(4),1,30),DA)
"IX",2006.5849,2006.5849,"AC",2.5)
K ^MAG(2006.5849,"AC")
"IX",2006.5849,2006.5849,"AC",11.1,0)
^.114IA^4^4
"IX",2006.5849,2006.5849,"AC",11.1,1,0)
1^F^2006.5849^1^30^1^F
"IX",2006.5849,2006.5849,"AC",11.1,1,3)

"IX",2006.5849,2006.5849,"AC",11.1,2,0)
2^F^2006.5849^2^30^2^F
"IX",2006.5849,2006.5849,"AC",11.1,2,3)

"IX",2006.5849,2006.5849,"AC",11.1,3,0)
3^F^2006.5849^3^30^3^F
"IX",2006.5849,2006.5849,"AC",11.1,3,3)

"IX",2006.5849,2006.5849,"AC",11.1,4,0)
4^F^2006.5849^8^30^4^F
"IX",2006.5849,2006.5849,"AC",11.1,4,3)

"IX",2006.5849,2006.5849,"D",0)
2006.5849^D^Sort for Display^R^^R^IR^I^2006.5849^^^^^LS
"IX",2006.5849,2006.5849,"D",1)
S ^MAG(2006.5849,"D",$E(X(1),1,30),$E(X(2),1,30),$E(X(3),1,30),$E(X(4),1,30),DA)=""
"IX",2006.5849,2006.5849,"D",2)
K ^MAG(2006.5849,"D",$E(X(1),1,30),$E(X(2),1,30),$E(X(3),1,30),$E(X(4),1,30),DA)
"IX",2006.5849,2006.5849,"D",2.5)
K ^MAG(2006.5849,"D")
"IX",2006.5849,2006.5849,"D",11.1,0)
^.114IA^4^4
"IX",2006.5849,2006.5849,"D",11.1,1,0)
1^F^2006.5849^1^30^1^F
"IX",2006.5849,2006.5849,"D",11.1,1,3)

"IX",2006.5849,2006.5849,"D",11.1,2,0)
2^F^2006.5849^2^30^2^F
"IX",2006.5849,2006.5849,"D",11.1,2,3)

"IX",2006.5849,2006.5849,"D",11.1,3,0)
3^F^2006.5849^3^30^3^F
"IX",2006.5849,2006.5849,"D",11.1,3,3)

"IX",2006.5849,2006.5849,"D",11.1,4,0)
4^F^2006.5849^10^30^4^F
"IX",2006.5849,2006.5849,"D",11.1,4,3)

"IX",2006.5849,2006.5849,"E",0)
2006.5849^E^Allow sorting by Acquistion Site and Date^R^^R^IR^I^2006.5849^^^^^LS
"IX",2006.5849,2006.5849,"E",1)
S ^MAG(2006.5849,"E",$E(X(1),1,4),$E(X(2),1,7),DA)=""
"IX",2006.5849,2006.5849,"E",2)
K ^MAG(2006.5849,"E",$E(X(1),1,4),$E(X(2),1,7),DA)
"IX",2006.5849,2006.5849,"E",2.5)
K ^MAG(2006.5849,"E")
"IX",2006.5849,2006.5849,"E",11.1,0)
^.114IA^2^2
"IX",2006.5849,2006.5849,"E",11.1,1,0)
1^F^2006.5849^1^4^1^F
"IX",2006.5849,2006.5849,"E",11.1,1,3)

"IX",2006.5849,2006.5849,"E",11.1,2,0)
2^F^2006.5849^17^7^2^F
"IX",2006.5849,2006.5849,"E",11.1,2,2)
S X=$E($P(X,"."),1,30)
"IX",2006.5849,2006.5849,"E",11.1,2,3)

"KRN",.4,123457,-1)
0^1
"KRN",.4,123457,0)
MAGREADTIME^3060427.1549^@^2006.5849^^@^3060921
"KRN",.4,123457,"DXS",1,9)
X DXS(1,9.2) S X1=DIP(2) S Y=$E(X1_"000",9,10)-$E(X_"000",9,10)*60+$E(X1_"00000",11,12)-$E(X_"00000",11,12),X2=X,X=$P(X,".",1)'=$P(X1,".",1) D ^%DTC:X S X=X*1440+Y
"KRN",.4,123457,"DXS",1,9.2)
S DIP(1)=$S($D(^MAG(2006.5849,D0,0)):^(0),1:"") S X=$P(DIP(1),U,18),DIP(2)=$G(X) S X=$P(DIP(1),U,17)
"KRN",.4,123457,"F",2)
16~17~X DXS(1,9) W X K DIP;"READING TIME/MIN";Z;"MINUTES(READING STOP,READING START)"~
"KRN",.4,123457,"H")
READING TIME REPORT
"KRN",.4,123458,-1)
0^2
"KRN",.4,123458,0)
MAGREPAIR^3060922.1045^@^2006.5849^^@^3060922
"KRN",.4,123458,"DCL","2006.5849^18")
!
"KRN",.4,123458,"F",2)
.01~10~18~
"KRN",.4,123458,"H")
TELEREADER READ/UNREAD LIST STATISTICS
"KRN",.4,123459,-1)
0^3
"KRN",.4,123459,0)
MAGSTATUS^3060427.1547^@^2006.5849^^@^3060921
"KRN",.4,123459,"DCL","2006.5849^10")
!
"KRN",.4,123459,"DNP")
1
"KRN",.4,123459,"F",2)
10~
"KRN",.4,123459,"H")
TELEREADER READ/UNREAD LIST STATISTICS
"KRN",.4,123460,-1)
0^4
"KRN",.4,123460,0)
MAGUSER^3060427.1551^@^2006.5849^^@^3060921
"KRN",.4,123460,"DCL","2006.5849^9")
&
"KRN",.4,123460,"DNP")
1
"KRN",.4,123460,"F",2)
9~
"KRN",.4,123460,"H")
READ STUDIES
"KRN",.401,123461,-1)
0^1
"KRN",.401,123461,0)
MAGREADER^3060921.1057^@^2006.5849^^@^3060921
"KRN",.401,123461,2,0)
^.4014^3^3
"KRN",.401,123461,2,1,0)
2006.5849^11^FULL NAME OF READER^+^^^^^^4
"KRN",.401,123461,2,1,"ASK")
1
"KRN",.401,123461,2,1,"F")
AAA,AAA@z^AAA,AAAA
"KRN",.401,123461,2,1,"GET")
S DISX(1)=$P($G(^MAG(2006.5849,D0,0)),U,12)
"KRN",.401,123461,2,1,"QCON")
I (DISX(1)]]"AAA,AAA@z")&(DISX(1)']]"ZZZZ,ZZZ")
"KRN",.401,123461,2,1,"SER")
0.2456^0.2456
"KRN",.401,123461,2,1,"T")
ZZZZ,ZZZ^ZZZZ,ZZZ
"KRN",.401,123461,2,1,"TXT")
FULL NAME OF READER from AAA,AAAA to ZZZZ,ZZZ
"KRN",.401,123461,2,2,0)
2006.5849^10^STATUS^@^^^^^^3
"KRN",.401,123461,2,2,"ASK")
1
"KRN",.401,123461,2,2,"F")
Bz^C^C (Cancelled)
"KRN",.401,123461,2,2,"GET")
S DISX(2)=$P($G(^MAG(2006.5849,D0,0)),U,11)
"KRN",.401,123461,2,2,"QCON")
I (DISX(2)]]"Bz")&(DISX(2)']]"W")
"KRN",.401,123461,2,2,"SER")
0.0000^0.0000
"KRN",.401,123461,2,2,"T")
W^W^W (Waiting)
"KRN",.401,123461,2,2,"TXT")
STATUS from C (Cancelled) to W (Waiting)
"KRN",.401,123461,2,3,0)
2006.5849^^CONSULT REQUEST^@".01^^^D^^^1
"KRN",.401,123461,2,3,"ASK")
1
"KRN",.401,123461,2,3,"CM")
S Y(1)=$S($D(^MAG(2006.5849,D0,0)):^(0),1:"") S X=$P($G(^GMR(123,+$P(Y(1),U,1),0)),U) I D0>0 S DISX(3)=X
"KRN",.401,123461,2,3,"F")
2800100.999999^Jan 1,1980^Jan 1,1980
"KRN",.401,123461,2,3,"GET")
S Y(1)=$S($D(^MAG(2006.5849,D0,0)):^(0),1:"") S X=$P($G(^GMR(123,+$P(Y(1),U,1),0)),U) I D0>0 S DISX(3)=X
"KRN",.401,123461,2,3,"IX")
^MAG(2006.5849,"B",^MAG(2006.5849,^2
"KRN",.401,123461,2,3,"PTRIX")
^GMR(123,"B",
"KRN",.401,123461,2,3,"QCON")
I (DISX(3)]]2800100.999999)&(DISX(3)']]3060921.24)
"KRN",.401,123461,2,3,"SER")
0.0000^0.0000
"KRN",.401,123461,2,3,"T")
3060921.24^Sep 21,2006@2400^Sep 21,2006@24:00
"KRN",.401,123461,2,3,"TXT")
CONSULT REQUEST from Jan 1,1980 to Sep 21,2006@24:00
"KRN",.401,123461,2,"B",2006.5849,1)

"KRN",.401,123461,2,"B",2006.5849,2)

"KRN",.401,123461,2,"B",2006.5849,3)

"KRN",.401,123462,-1)
0^2
"KRN",.401,123462,0)
MAGREPAIR^3060922.1044^@^2006.5849^^@^3060922
"KRN",.401,123462,2,0)
^.4014^1^1
"KRN",.401,123462,2,1,0)
2006.5849^18^REPAIR DATE/TIME^+^^^^^^1
"KRN",.401,123462,2,1,"ASK")
1
"KRN",.401,123462,2,1,"F")
2900100.999999^Jan 1,1990^Jan 1,1990
"KRN",.401,123462,2,1,"GET")
S DISX(1)=$P($G(^MAG(2006.5849,D0,0)),U,19)
"KRN",.401,123462,2,1,"QCON")
I (DISX(1)]]2900100.999999)&(DISX(1)']]3060922.24)
"KRN",.401,123462,2,1,"T")
3060922.24^Sep 22,2006@2400^Sep 22,2006@24:00
"KRN",.401,123462,2,1,"TXT")
REPAIR DATE/TIME from Jan 1,1990 to Sep 22,2006@24:00
"KRN",.401,123462,2,"B",2006.5849,1)

"KRN",.401,123463,-1)
0^3
"KRN",.401,123463,0)
MAGSTATUS^3060921.1103^@^2006.5849^^@^3060921
"KRN",.401,123463,2,0)
^.4014^2^2
"KRN",.401,123463,2,1,0)
2006.5849^10^STATUS^+^^^^^^3
"KRN",.401,123463,2,1,"ASK")
1
"KRN",.401,123463,2,1,"F")
Kz^L^L (Locked)
"KRN",.401,123463,2,1,"GET")
S DISX(1)=$P($G(^MAG(2006.5849,D0,0)),U,11)
"KRN",.401,123463,2,1,"QCON")
I (DISX(1)]]"Kz")&(DISX(1)']]"U")
"KRN",.401,123463,2,1,"SER")
0.0526^0.0526
"KRN",.401,123463,2,1,"T")
U^U^U (Unread)
"KRN",.401,123463,2,1,"TXT")
STATUS from L (Locked) to U (Unread)
"KRN",.401,123463,2,2,0)
2006.5849^^CONSULT REQUEST^@".01^^^D^^^1
"KRN",.401,123463,2,2,"ASK")
1
"KRN",.401,123463,2,2,"CM")
S Y(1)=$S($D(^MAG(2006.5849,D0,0)):^(0),1:"") S X=$P($G(^GMR(123,+$P(Y(1),U,1),0)),U) I D0>0 S DISX(2)=X
"KRN",.401,123463,2,2,"F")
2800100.999999^Jan 1,1980^Jan 1,1980
"KRN",.401,123463,2,2,"GET")
S Y(1)=$S($D(^MAG(2006.5849,D0,0)):^(0),1:"") S X=$P($G(^GMR(123,+$P(Y(1),U,1),0)),U) I D0>0 S DISX(2)=X
"KRN",.401,123463,2,2,"IX")
^MAG(2006.5849,"B",^MAG(2006.5849,^2
"KRN",.401,123463,2,2,"PTRIX")
^GMR(123,"B",
"KRN",.401,123463,2,2,"QCON")
I (DISX(2)]]2800100.999999)&(DISX(2)']]3060921.24)
"KRN",.401,123463,2,2,"SER")
0.0000^0.0000
"KRN",.401,123463,2,2,"T")
3060921.24^Sep 21,2006@2400^Sep 21,2006@24:00
"KRN",.401,123463,2,2,"TXT")
CONSULT REQUEST from Jan 1,1980 to Sep 21,2006@24:00
"KRN",.401,123463,2,"B",2006.5849,1)

"KRN",.401,123463,2,"B",2006.5849,2)

"KRN",19,123464,-1)
2^1
"KRN",19,123464,0)
MAG SYS MENU^Imaging System Manager Menu^^M^133^MAG SYSTEM^^^^^^454
"KRN",19,123464,10,0)
^19.01IP^15^10
"KRN",19,123464,10,15,0)
22830^TR
"KRN",19,123464,10,15,"^")
MAGT TELEREADER MENU
"KRN",19,123464,"U")
IMAGING SYSTEM MANAGER MENU
"KRN",19,123465,-1)
0^2
"KRN",19,123465,0)
MAGT READER ACTIVITY REP^TeleReader Reader Activity Report ^^P^^^^^^^^IMAGING
"KRN",19,123465,60)
MAG(2006.5849,
"KRN",19,123465,62)
0
"KRN",19,123465,63)
[MAGUSER]
"KRN",19,123465,64)
[MAGREADER]
"KRN",19,123465,65)

"KRN",19,123465,66)

"KRN",19,123465,"U")
TELEREADER READER ACTIVITY REP
"KRN",19,123466,-1)
0^3
"KRN",19,123466,0)
MAGT READING TIME REPORT^TeleReader Reader Time Report^^P^^^^^^^^IMAGING
"KRN",19,123466,60)
MAG(2006.5849,
"KRN",19,123466,62)
0
"KRN",19,123466,63)
[MAGREADTIME]
"KRN",19,123466,64)
[MAGREADER]
"KRN",19,123466,65)

"KRN",19,123466,66)

"KRN",19,123466,"U")
TELEREADER READER TIME REPORT
"KRN",19,123467,-1)
0^4
"KRN",19,123467,0)
MAGT REPAIR TR PROBLEMS^Repair Telereader Read/Unread List Problems^^R^^^^^^^^IMAGING
"KRN",19,123467,25)
REPAIR^MAGDTRLU
"KRN",19,123467,"U")
REPAIR TELEREADER READ/UNREAD 
"KRN",19,123468,-1)
0^5
"KRN",19,123468,0)
MAGT REPORT TR PROBLEMS^Report Telereader Read/Unread List Problems^^R^^^^^^^^IMAGING
"KRN",19,123468,25)
REPORT^MAGDTRLU
"KRN",19,123468,"U")
REPORT TELEREADER READ/UNREAD 
"KRN",19,123469,-1)
0^6
"KRN",19,123469,0)
MAGT SETUP REPORT^TeleReader Setup Report^^R^^^^^^^^IMAGING
"KRN",19,123469,1,0)
^19.06^1^1^3060922^^^
"KRN",19,123469,1,1,0)
This option output the site TeleReader Application setup from the four main files needed for the TeleReader Setup
"KRN",19,123469,25)
ENTRY^MAGDTRDX
"KRN",19,123469,"U")
TELEREADER SETUP REPORT
"KRN",19,123470,-1)
0^7
"KRN",19,123470,0)
MAGT STATUS REPORT^TeleReader Status Report^^P^^^^^^^^IMAGING
"KRN",19,123470,60)
MAG(2006.5849,
"KRN",19,123470,62)
0
"KRN",19,123470,63)
[MAGSTATUS]
"KRN",19,123470,64)
[MAGSTATUS]
"KRN",19,123470,99.1)
60445,57331
"KRN",19,123470,"U")
TELEREADER STATUS REPORT
"KRN",19,123471,-1)
0^8
"KRN",19,123471,0)
MAGT TELEREADER MENU^Telereader Menu^^M^^^^^^^^IMAGING
"KRN",19,123471,10,0)
^19.01IP^7^7
"KRN",19,123471,10,1,0)
22831^ST^1
"KRN",19,123471,10,1,"^")
MAGT STATUS REPORT
"KRN",19,123471,10,2,0)
22833^RA^2
"KRN",19,123471,10,2,"^")
MAGT READER ACTIVITY REP
"KRN",19,123471,10,3,0)
22832^TI^3
"KRN",19,123471,10,3,"^")
MAGT READING TIME REPORT
"KRN",19,123471,10,4,0)
22834^BB^4
"KRN",19,123471,10,4,"^")
MAGT SETUP REPORT
"KRN",19,123471,10,5,0)
22835^RP^5
"KRN",19,123471,10,5,"^")
MAGT REPORT TR PROBLEMS
"KRN",19,123471,10,6,0)
22836^FP^6
"KRN",19,123471,10,6,"^")
MAGT REPAIR TR PROBLEMS
"KRN",19,123471,99)
60530,37802
"KRN",19,123471,99.1)
60439,41674
"KRN",19,123471,"U")
TELEREADER MENU
"KRN",8994,123472,-1)
0^1
"KRN",8994,123472,0)
MAG DICOM CON GET TELE READER^GETREAD^MAGDTR06^2^P^0
"KRN",8994,123472,1,0)
^^1^1^3061024^
"KRN",8994,123472,1,1,0)
Return the sites and diagnostic specialties for the tele reader.
"KRN",8994,123473,-1)
0^2
"KRN",8994,123473,0)
MAG DICOM CON SET TELE READER^SETREAD^MAGDTR06^1^P^0
"KRN",8994,123473,1,0)
^^2^2^3061024^
"KRN",8994,123473,1,1,0)
This allows the user to select/deselect an item from his/her site
"KRN",8994,123473,1,2,0)
and specialty list.
"KRN",8994,123473,2,0)
^8994.02A^2^2
"KRN",8994,123473,2,1,0)
SELECT^1^^1^2
"KRN",8994,123473,2,1,1,0)
^^1^1^3051011^
"KRN",8994,123473,2,1,1,1,0)
User selection preference - 1=select, 0=ignore
"KRN",8994,123473,2,2,0)
IENPARAM^1^^1^1
"KRN",8994,123473,2,2,1,0)
^^1^1^3051011^
"KRN",8994,123473,2,2,1,1,0)
Pointer to User Parameter file 2006.5843
"KRN",8994,123473,2,"B","IENPARAM",2)

"KRN",8994,123473,2,"B","SELECT",1)

"KRN",8994,123473,2,"PARAMSEQ",1,2)

"KRN",8994,123473,2,"PARAMSEQ",2,1)

"KRN",8994,123474,-1)
0^3
"KRN",8994,123474,0)
MAG DICOM CON UNREAD ACQ SITES^GETSITES^MAGDTR06^2^P^0
"KRN",8994,123474,1,0)
^^2^2^3051011^
"KRN",8994,123474,1,1,0)
This RPC returns the list of acquisition sites that
"KRN",8994,123474,1,2,0)
are defined for the reading site.
"KRN",8994,123474,3,0)
^^4^4^3051011^
"KRN",8994,123474,3,1,0)
Three fields
"KRN",8994,123474,3,2,0)
1) File 4 pointer to the acquisition site
"KRN",8994,123474,3,3,0)
2) Name of the acquisition site
"KRN",8994,123474,3,4,0)
3) Active Flag - 1=active, 0=inactive
"KRN",8994,123475,-1)
0^4
"KRN",8994,123475,0)
MAG DICOM CON UNREADLIST GET^LOOKUP^MAGDTR05^2^P^0
"KRN",8994,123475,2,0)
^8994.02A^7^7
"KRN",8994,123475,2,1,0)
ACQSITE^1^^1^1
"KRN",8994,123475,2,1,1,0)
^^1^1^3051005^
"KRN",8994,123475,2,1,1,1,0)
ACQUISITION SITE
"KRN",8994,123475,2,2,0)
SPECIALITY INDEX^1^^1^2
"KRN",8994,123475,2,2,1,0)
^^1^1^3051005^
"KRN",8994,123475,2,2,1,1,0)
INDEX TO SPECIALTY (FILE 2006.84)
"KRN",8994,123475,2,3,0)
PROCEDURE INDEX^1^^1^3
"KRN",8994,123475,2,3,1,0)
^^1^1^3051005^
"KRN",8994,123475,2,3,1,1,0)
INDEX TO PROCEDURE (FILE 2006.85)
"KRN",8994,123475,2,4,0)
TIMESTAMP^1^^1^4
"KRN",8994,123475,2,4,1,0)
^8994.021^1^1^3051220^^^^
"KRN",8994,123475,2,4,1,1,0)
DATE AND TIME OF LAST EVENT IN UNLIST LIST
"KRN",8994,123475,2,5,0)
DUZ^1^^0^5
"KRN",8994,123475,2,5,1,0)
^^1^1^3051214^
"KRN",8994,123475,2,5,1,1,0)
POINTER TO FILE 200 FOR THE READER
"KRN",8994,123475,2,6,0)
READER SITE^1^^0^6
"KRN",8994,123475,2,6,1,0)
^^1^1^3051214^
"KRN",8994,123475,2,6,1,1,0)
LOCATION OF THE READING SITE - POINTER TO FILE 4
"KRN",8994,123475,2,7,0)
LOCKTIME^1^^0^7
"KRN",8994,123475,2,7,1,0)
^8994.021^1^1^3051220^^
"KRN",8994,123475,2,7,1,1,0)
AMOUNT OF TIME A READ LOCK CAN BE HELD BEFORE TIMING OUT.
"KRN",8994,123475,2,"B","ACQSITE",1)

"KRN",8994,123475,2,"B","DUZ",5)

"KRN",8994,123475,2,"B","LOCKTIME",7)

"KRN",8994,123475,2,"B","PROCEDURE INDEX",3)

"KRN",8994,123475,2,"B","READER SITE",6)

"KRN",8994,123475,2,"B","SPECIALITY INDEX",2)

"KRN",8994,123475,2,"B","TIMESTAMP",4)

"KRN",8994,123475,2,"PARAMSEQ",1,1)

"KRN",8994,123475,2,"PARAMSEQ",2,2)

"KRN",8994,123475,2,"PARAMSEQ",3,3)

"KRN",8994,123475,2,"PARAMSEQ",4,4)

"KRN",8994,123475,2,"PARAMSEQ",5,5)

"KRN",8994,123475,2,"PARAMSEQ",6,6)

"KRN",8994,123475,2,"PARAMSEQ",7,7)

"KRN",8994,123476,-1)
0^5
"KRN",8994,123476,0)
MAG DICOM CON UNREADLIST LOCK^LOCK^MAGDTR04^1^P^0
"KRN",8994,123476,2,0)
^8994.02A^6^6
"KRN",8994,123476,2,1,0)
UNREAD LIST POINTER^1^^1^1
"KRN",8994,123476,2,1,1,0)
^^1^1^3051006^
"KRN",8994,123476,2,1,1,1,0)
POINTER TO THE ENTRY IN THE UNREAD LIST (FILE 2006.5849)
"KRN",8994,123476,2,2,0)
LOCK FLAG^1^^1^2
"KRN",8994,123476,2,2,1,0)
^^2^2^3051006^
"KRN",8994,123476,2,2,1,1,0)
LOCK FLAG = 1 TO CREATE THE LOCK
"KRN",8994,123476,2,2,1,2,0)
LOCK FLAG = 0 TO REMOVE THE LOCK
"KRN",8994,123476,2,3,0)
FULL NAME^1^^1^3
"KRN",8994,123476,2,3,1,0)
^^1^1^3051006^
"KRN",8994,123476,2,3,1,1,0)
FULL NAME OF READER (LAST,FIRST FORMAT)
"KRN",8994,123476,2,4,0)
NAME ABBREVIATION^1^^1^4
"KRN",8994,123476,2,4,1,0)
^^1^1^3051006^
"KRN",8994,123476,2,4,1,1,0)
INITIALS FOR THE READER
"KRN",8994,123476,2,5,0)
DUZ^1^^1^5
"KRN",8994,123476,2,5,1,0)
^^1^1^3051006^
"KRN",8994,123476,2,5,1,1,0)
POINTER TO FILE 200 FOR THE READER
"KRN",8994,123476,2,6,0)
READER SITE^1^^1^6
"KRN",8994,123476,2,6,1,0)
^8994.021^1^1^3051010^^
"KRN",8994,123476,2,6,1,1,0)
LOCATION OF THE READING SITE - POINTER TO FILE 4
"KRN",8994,123476,2,"B","DUZ",5)

"KRN",8994,123476,2,"B","FULL NAME",3)

"KRN",8994,123476,2,"B","LOCK FLAG",2)

"KRN",8994,123476,2,"B","NAME ABBREVIATION",4)

"KRN",8994,123476,2,"B","READER SITE",6)

"KRN",8994,123476,2,"B","UNREAD LIST POINTER",1)

"KRN",8994,123476,2,"PARAMSEQ",1,1)

"KRN",8994,123476,2,"PARAMSEQ",2,2)

"KRN",8994,123476,2,"PARAMSEQ",3,3)

"KRN",8994,123476,2,"PARAMSEQ",4,4)

"KRN",8994,123476,2,"PARAMSEQ",5,5)

"KRN",8994,123476,2,"PARAMSEQ",6,6)

"KRN",8994,123477,-1)
0^6
"KRN",8994,123477,0)
MAGG GET TIMEOUT^TIMEOUT^MAGGTU6^1^R
"KRN",8994,123477,1,0)
^8994.01^3^3^3000515^^^^
"KRN",8994,123477,1,1,0)
Called by imaging application to get the Site defined timeout for 
"KRN",8994,123477,1,2,0)
the Imaging applications. 
"KRN",8994,123477,1,3,0)
Accepted input is "DISPLAY" , "CAPTURE", "VISTARAD" or "TELEREADER".
"KRN",8994,123477,2,0)
^8994.02A^1^1
"KRN",8994,123477,2,1,0)
APP^1^255^1^1
"KRN",8994,123477,2,1,1,0)
^8994.021^1^1^3000515^^^^
"KRN",8994,123477,2,1,1,1,0)
Either "DISPLAY"  "CAPTURE" or "VISTARAD".
"KRN",8994,123477,2,"B","APP",1)

"KRN",8994,123477,2,"PARAMSEQ",1,1)

"KRN",8994,123477,3,0)
^8994.03^2^2^3000515^^^^
"KRN",8994,123477,3,1,0)
Returns the entry in the IMAGING SITE PARAMETERS File for the Timeout
"KRN",8994,123477,3,2,0)
of the application sent as parameter.
"KRN",8994,123478,-1)
0^7
"KRN",8994,123478,0)
MAGG PAT INFO^INFO^MAGGTPT1^1^R
"KRN",8994,123478,1,0)
^8994.01^2^2^3051005^^^^
"KRN",8994,123478,1,1,0)
Returns a string of '^' delimited pieces of patient information.
"KRN",8994,123478,1,2,0)

"KRN",8994,123478,2,0)
^8994.02A^1^1
"KRN",8994,123478,2,1,0)
DATA^1^90^1^1
"KRN",8994,123478,2,1,1,0)
^8994.021^5^5^3051005^^^^
"KRN",8994,123478,2,1,1,1,0)
  DATA:  MAGDFN ^ NOLOG ^ ISICN
"KRN",8994,123478,2,1,1,2,0)
     MAGDFN -- Patient DFN
"KRN",8994,123478,2,1,1,3,0)
     NOLOG  -- 0/1; if 1, then do NOT update the Session log
"KRN",8994,123478,2,1,1,4,0)
     ISICN  -- 0/1  if 1, then this is an ICN,
"KRN",8994,123478,2,1,1,5,0)
               if 0 (default) this is a DFN ; Patch 41
"KRN",8994,123478,2,"B","DATA",1)

"KRN",8994,123478,2,"PARAMSEQ",1,1)

"KRN",8994,123478,3,0)
^8994.03^9^9^3051005^^^^
"KRN",8994,123478,3,1,0)
The result String returns the following.
"KRN",8994,123478,3,2,0)
  1        2      3     4     5     6     7
"KRN",8994,123478,3,3,0)
 status ^   DFN ^ name ^ sex ^ DOB ^ SSN ^ S/C
"KRN",8994,123478,3,4,0)
  
"KRN",8994,123478,3,5,0)
 8        9                     10
"KRN",8994,123478,3,6,0)
TYPE ^ Veteran(y/n)  ^ Patient Image Count
"KRN",8994,123478,3,7,0)
    
"KRN",8994,123478,3,8,0)
   11            12              13
"KRN",8994,123478,3,9,0)
 ICN       SITE Number   ^ Production Account 1/0
"KRN",8994,123479,-1)
0^8
"KRN",8994,123479,0)
MAGGUSER2^USERINF2^MAGGTU3^2^R
"KRN",8994,123479,1,0)
^8994.01^1^1^3000517^^
"KRN",8994,123479,1,1,0)
Returns Array of info about user, and site settings.
"KRN",8994,123479,1,2,0)
the user's security keys for later applications.
"KRN",8994,123479,2,0)
^8994.02A^1^1
"KRN",8994,123479,2,1,0)
MAGGWRKID^1^240^0^1
"KRN",8994,123479,2,1,1,0)
^8994.021^1^1^3000517^^^
"KRN",8994,123479,2,1,1,1,0)
Workstation ID and Location from MAG.INI file section [SYS_SiteParam].
"KRN",8994,123479,2,"B","MAGGWRKID",1)

"KRN",8994,123479,2,"PARAMSEQ",1,1)

"KRN",8994,123479,3,0)
^8994.03^13^13^3061024^^
"KRN",8994,123479,3,1,0)
        ; MAGRY(1) = DUZ ^ FULL NAME  ^ INITIALS
"KRN",8994,123479,3,2,0)
        ; MAGRY(2) = Network UserName ^ PassWord.
"KRN",8994,123479,3,3,0)
        ; MAGRY(3) = MUSE Site number. ( default = 1)
"KRN",8994,123479,3,4,0)
        ; Node 4 is data from IMAGING SITE PARAMATERS File #2006.1 and INSTITUTION File #4
"KRN",8994,123479,3,5,0)
        ; MAGRY(4)= IEN  ^ SITE CODE ^ DUZ(2) ^ INSTITUTION NAME (.01) ^ $$CONSOLID ^ STATION NUMBER (99)
"KRN",8994,123479,3,6,0)
        ; MAGRY(5) = +<CP Version>|0 ^ Version of CP installed on Server
"KRN",8994,123479,3,7,0)
        ; MAGRY(6) = Warning message if we can't resolve which Site Parameter entry to use.
"KRN",8994,123479,3,8,0)
        ; MAGRY(7) = Warning message  <reserved for future>
"KRN",8994,123479,3,9,0)
        ; MAGRY(8) = 1|0  1 = Production account    0 = Test Account (or couldn't determine)
"KRN",8994,123479,3,10,0)
        ; MAGRY(9) = Vista Site Service PHYSICAL REFERENCE from Network Location File.
"KRN",8994,123479,3,11,0)
        ; MAGRY(10)=Domain Name
"MBREQ")
0
"ORD",5,.4)
.4;5;;;EDEOUT^DIFROMSO(.4,DA,"",XPDA);FPRE^DIFROMSI(.4,"",XPDA);EPRE^DIFROMSI(.4,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.4,DA,"",XPDA);DEL^DIFROMSK(.4,"",%)
"ORD",5,.4,0)
PRINT TEMPLATE
"ORD",6,.401)
.401;6;;;EDEOUT^DIFROMSO(.401,DA,"",XPDA);FPRE^DIFROMSI(.401,"",XPDA);EPRE^DIFROMSI(.401,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.401,DA,"",XPDA);DEL^DIFROMSK(.401,"",%)
"ORD",6,.401,0)
SORT TEMPLATE
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging Release History
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020328^3020328^.5
"PKG",454,22,1,"PAH",1,0)
46^3070216^.5
"PKG",454,22,1,"PAH",1,1,0)
^9.49011^34^34^3070216
"PKG",454,22,1,"PAH",1,1,1,0)
Routines for Patch 46, Test Build 28.
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
MAGDHRC0    value = 4285870
"PKG",454,22,1,"PAH",1,1,5,0)
MAGDHWC     value = 12104444
"PKG",454,22,1,"PAH",1,1,6,0)
MAGDIR81    value = 16164949
"PKG",454,22,1,"PAH",1,1,7,0)
MAGDIR9A    value = 11384181
"PKG",454,22,1,"PAH",1,1,8,0)
MAGDIR9E    value = 14829187
"PKG",454,22,1,"PAH",1,1,9,0)
MAGDTR01    value = 10072315
"PKG",454,22,1,"PAH",1,1,10,0)
MAGDTR02    value = 11542794
"PKG",454,22,1,"PAH",1,1,11,0)
MAGDTR03    value = 17747636
"PKG",454,22,1,"PAH",1,1,12,0)
MAGDTR04    value = 8324327
"PKG",454,22,1,"PAH",1,1,13,0)
MAGDTR05    value = 12647049
"PKG",454,22,1,"PAH",1,1,14,0)
MAGDTR06    value = 10053102
"PKG",454,22,1,"PAH",1,1,15,0)
MAGDTRDX    value = 8254807
"PKG",454,22,1,"PAH",1,1,16,0)
MAGDTRLU    value = 7439670
"PKG",454,22,1,"PAH",1,1,17,0)
MAGGNLKP    value = 6081621
"PKG",454,22,1,"PAH",1,1,18,0)
MAGGNTI1    value = 11025078
"PKG",454,22,1,"PAH",1,1,19,0)
MAGGNTI2    value = 7904476
"PKG",454,22,1,"PAH",1,1,20,0)
MAGGNTI3    value = 5195830
"PKG",454,22,1,"PAH",1,1,21,0)
MAGGTPT1    value = 8609100
"PKG",454,22,1,"PAH",1,1,22,0)
MAGGTU3     value = 12647741
"PKG",454,22,1,"PAH",1,1,23,0)
MAGGTU31    value = 6267048
"PKG",454,22,1,"PAH",1,1,24,0)
MAGGTU4     value = 9595917
"PKG",454,22,1,"PAH",1,1,25,0)
MAGGTU41    value = 10672702
"PKG",454,22,1,"PAH",1,1,26,0)
MAGGTU6     value = 11306571
"PKG",454,22,1,"PAH",1,1,27,0)
MAGGTU71    value = 6245772
"PKG",454,22,1,"PAH",1,1,28,0)
MAGIPS46    value = 9488645
"PKG",454,22,1,"PAH",1,1,29,0)
MAGQE3      value = 15888752
"PKG",454,22,1,"PAH",1,1,30,0)
MAGQE5      value = 13158187
"PKG",454,22,1,"PAH",1,1,31,0)
MAGQE6      value = 5946318
"PKG",454,22,1,"PAH",1,1,32,0)
 
"PKG",454,22,1,"PAH",1,1,33,0)
Please note that routine MAGIPS46 is deleted after the KIDS Build is
"PKG",454,22,1,"PAH",1,1,34,0)
installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
28
"RTN","MAGDHRC0")
0^1^B7139686
"RTN","MAGDHRC0",1,0)
MAGDHRC0 ;WOIFO/PMK - Read HL7 and generate DICOM ; 08/29/2006 15:16
"RTN","MAGDHRC0",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDHRC0",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHRC0",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHRC0",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHRC0",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHRC0",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHRC0",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHRC0",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHRC0",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHRC0",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHRC0",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHRC0",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHRC0",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHRC0",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHRC0",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHRC0",17,0)
 ;;
"RTN","MAGDHRC0",18,0)
 Q
"RTN","MAGDHRC0",19,0)
 ; Functions for accessing parsed HL7 data
"RTN","MAGDHRC0",20,0)
 ;
"RTN","MAGDHRC0",21,0)
GETDATA(FLD,REP,CMP,SUB) ; get an element from HL7PARSE
"RTN","MAGDHRC0",22,0)
 Q:'$D(FLD) $G(@HL7PARSE@(HL7SEGNO)) ; segment
"RTN","MAGDHRC0",23,0)
 Q:'$D(REP) $G(@HL7PARSE@(HL7SEGNO,FLD)) ; field
"RTN","MAGDHRC0",24,0)
 Q:'$D(CMP) $G(@HL7PARSE@(HL7SEGNO,FLD,REP)) ; repetition
"RTN","MAGDHRC0",25,0)
 Q:'$D(SUB) $G(@HL7PARSE@(HL7SEGNO,FLD,REP,CMP)) ; component
"RTN","MAGDHRC0",26,0)
 Q $G(@HL7PARSE@(HL7SEGNO,FLD,REP,CMP,SUB)) ; subcomponent
"RTN","MAGDHRC0",27,0)
 ;
"RTN","MAGDHRC0",28,0)
GETEXIST(FLD,REP,CMP,SUB) ; does the element (segment/field/rep/comp) exist
"RTN","MAGDHRC0",29,0)
 Q:'$D(FLD) $D(@HL7PARSE@(HL7SEGNO)) ; segment
"RTN","MAGDHRC0",30,0)
 Q:'$D(REP) $D(@HL7PARSE@(HL7SEGNO,FLD)) ; field
"RTN","MAGDHRC0",31,0)
 Q:'$D(CMP) $D(@HL7PARSE@(HL7SEGNO,FLD,REP)) ; repetition
"RTN","MAGDHRC0",32,0)
 Q:'$D(SUB) $D(@HL7PARSE@(HL7SEGNO,FLD,REP,CMP)) ; component
"RTN","MAGDHRC0",33,0)
 Q $D(@HL7PARSE@(HL7SEGNO,FLD,REP,CMP,SUB)) ; subcomponent
"RTN","MAGDHRC0",34,0)
 ;
"RTN","MAGDHRC0",35,0)
GETSEG(SEGMENT) ; check if the named segment exists
"RTN","MAGDHRC0",36,0)
 Q:SEGMENT'="" $O(@HL7PARSE@("B",SEGMENT,""))
"RTN","MAGDHRC0",37,0)
 Q 0
"RTN","MAGDHRC0",38,0)
 ;
"RTN","MAGDHRC0",39,0)
GETCOUNT() ; get value of highest index number in HL7PARSE
"RTN","MAGDHRC0",40,0)
 Q $O(@HL7PARSE@(" "),-1)
"RTN","MAGDHRC0",41,0)
 ;
"RTN","MAGDHRC0",42,0)
GETNAME(J) ; get a person's name - return in DICOM format
"RTN","MAGDHRC0",43,0)
 ; also used for provider's name - first piece is code - others shifted
"RTN","MAGDHRC0",44,0)
 N I,LAST,NAME,X
"RTN","MAGDHRC0",45,0)
 S NAME="",LAST=0 F I=1:1:6 D
"RTN","MAGDHRC0",46,0)
 . N X ; name component: last ^ first ^ mi ^ prefix ^ suffix
"RTN","MAGDHRC0",47,0)
 . S X=$$GETDATA^MAGDHRC0(J,1,I) I $L(X) S LAST=I
"RTN","MAGDHRC0",48,0)
 . S NAME=NAME_$S(I>1:"^",1:"")_$TR(X,"^\","") ; no ^ or \ chars in name
"RTN","MAGDHRC0",49,0)
 . Q
"RTN","MAGDHRC0",50,0)
 Q $P(NAME,"^",1,LAST)
"RTN","MAGDHRC0",51,0)
 ;
"RTN","MAGDHWC")
0^2^B46727596
"RTN","MAGDHWC",1,0)
MAGDHWC ;WOIFO/PMK - Capture Consult/Procedure Request data ; 24 Jan 2006  11:50 AM
"RTN","MAGDHWC",2,0)
 ;;3.0;IMAGING;**10,51,46**;16-February-2007;;Build 1023
"RTN","MAGDHWC",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHWC",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHWC",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHWC",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHWC",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHWC",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHWC",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHWC",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHWC",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHWC",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHWC",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHWC",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHWC",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHWC",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHWC",17,0)
 ;;
"RTN","MAGDHWC",18,0)
ENTRY ;
"RTN","MAGDHWC",19,0)
 ; determine the kind of message and branch appropriately
"RTN","MAGDHWC",20,0)
 N %,APTSCHED,CONSULT,DATETIME,DEL,DEL2,DEL3,DEL4,DEL5,DFN
"RTN","MAGDHWC",21,0)
 N DIVISION,FILLER1,FWDFROM,FMDATE,FMDATETM,GMRCIEN,HL,HL7,HL7ORC,HL7REC
"RTN","MAGDHWC",22,0)
 N I,IGNORE,ITYPCODE,ITYPNAME,IGNORE,MSGTYPE,OBXSEGNO,ORIGSERV,SERVICE,X,Y,Z
"RTN","MAGDHWC",23,0)
 I $D(GMRCMSG) M HL7=GMRCMSG
"RTN","MAGDHWC",24,0)
 E  I $D(XQORHSTK(0)) M HL7=XQORHSTK(0)
"RTN","MAGDHWC",25,0)
 E  Q  ; can't find HL7 data to handle this!
"RTN","MAGDHWC",26,0)
 S HL7REC=HL7(1)
"RTN","MAGDHWC",27,0)
 S DEL=$E(HL7REC,4),X=$P(HL7REC,DEL,2)
"RTN","MAGDHWC",28,0)
 F I=1:1:$L(X) S @("DEL"_(I+1))=$E(X,I)
"RTN","MAGDHWC",29,0)
 D NOW^%DTC S FMDATE=%\1,FMDATETM=%
"RTN","MAGDHWC",30,0)
 ;
"RTN","MAGDHWC",31,0)
 ; find PID segment and get the DFN
"RTN","MAGDHWC",32,0)
 S I=0 I '$$FINDSEG^MAGDHW0(.HL7,"PID",.I,.X) Q  ; no PID segment
"RTN","MAGDHWC",33,0)
 S DFN=$P(X,DEL,3)
"RTN","MAGDHWC",34,0)
 ;
"RTN","MAGDHWC",35,0)
 ; find ORC segment and get GMRCIEN
"RTN","MAGDHWC",36,0)
 S I=0 I '$$FINDSEG^MAGDHW0(.HL7,"ORC",.I,.HL7ORC) Q  ; no ORC segment
"RTN","MAGDHWC",37,0)
 S GMRCIEN=+$P(HL7ORC,DEL,3) ; GMRC request is in ^GMR(123,GMRCIEN,...)
"RTN","MAGDHWC",38,0)
 ;
"RTN","MAGDHWC",39,0)
 D ^MAGDTR01 ; update the Read/Unread list with the data from the HL7 message
"RTN","MAGDHWC",40,0)
 ;
"RTN","MAGDHWC",41,0)
 S IGNORE=1 ; decide if service is one that requires HL7->DICOM gateway
"RTN","MAGDHWC",42,0)
 ;
"RTN","MAGDHWC",43,0)
 ; find ORC segment and check for an "OK" order control value
"RTN","MAGDHWC",44,0)
 I $P(HL7ORC,DEL)="OK" D  Q  ; generate message by ^MAGDHWS
"RTN","MAGDHWC",45,0)
 . S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHWC",46,0)
 . D SERVICE ; send this transaction to the DICOM gateway?
"RTN","MAGDHWC",47,0)
 . I 'IGNORE D
"RTN","MAGDHWC",48,0)
 . . D INIT^MAGDHW0 ; initialize variables
"RTN","MAGDHWC",49,0)
 . . S DATETIME=""
"RTN","MAGDHWC",50,0)
 . . D MESSAGE^MAGDHWS("O") ; indicates new order
"RTN","MAGDHWC",51,0)
 . . Q
"RTN","MAGDHWC",52,0)
 . Q
"RTN","MAGDHWC",53,0)
 ;
"RTN","MAGDHWC",54,0)
 I " CA CR DR OC OD "[(" "_$P(HL7ORC,DEL)_" ") D  Q  ; Discontinued order
"RTN","MAGDHWC",55,0)
 . S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHWC",56,0)
 . D SERVICE ; send this transaction to the DICOM gateway?
"RTN","MAGDHWC",57,0)
 . I 'IGNORE D
"RTN","MAGDHWC",58,0)
 . . D INIT^MAGDHW0 ; initialize variables
"RTN","MAGDHWC",59,0)
 . . S DATETIME=""
"RTN","MAGDHWC",60,0)
 . . D MESSAGE^MAGDHWS("C") ; Cancelled/Discontinued order
"RTN","MAGDHWC",61,0)
 . . Q
"RTN","MAGDHWC",62,0)
 . Q
"RTN","MAGDHWC",63,0)
 ;
"RTN","MAGDHWC",64,0)
 ; check for a FORWARD in the ORC segment
"RTN","MAGDHWC",65,0)
 I $P($P(HL7ORC,DEL,16),DEL2,5)="FORWARD" D
"RTN","MAGDHWC",66,0)
 . ; get previous service from REQUEST PROCESSING ACTIVITY
"RTN","MAGDHWC",67,0)
 . S FWDFROM=$$FWDFROM^MAGDGMRC(GMRCIEN) ; FORWARDED FROM service
"RTN","MAGDHWC",68,0)
 . S Y=0 I FWDFROM S Y=$G(^MAG(2006.5831,FWDFROM,0))
"RTN","MAGDHWC",69,0)
 . I Y D  ; forwarded from location was one in the service group
"RTN","MAGDHWC",70,0)
 . . N DIVISION,Z
"RTN","MAGDHWC",71,0)
 . . ; original service request probably was sent to DICOM Gateway
"RTN","MAGDHWC",72,0)
 . . S ORIGSERV=DEL2_DEL2_DEL2_FWDFROM_DEL2
"RTN","MAGDHWC",73,0)
 . . S ORIGSERV=ORIGSERV_$S(FWDFROM:$$GET1^DIQ(123.5,FWDFROM,.01),1:"")
"RTN","MAGDHWC",74,0)
 . . S ORIGSERV=ORIGSERV_DEL2_"99CON"
"RTN","MAGDHWC",75,0)
 . . D DIVISION(Y)
"RTN","MAGDHWC",76,0)
 . . S Z=$P(Y,"^",2)
"RTN","MAGDHWC",77,0)
 . . S ITYPNAME=$P(^MAG(2005.84,Z,0),"^",1)
"RTN","MAGDHWC",78,0)
 . . S ITYPCODE=$P(^MAG(2005.84,Z,2),"^",1)
"RTN","MAGDHWC",79,0)
 . . S ORIGSERV=ORIGSERV_DEL_ITYPCODE_DEL2_ITYPNAME_DEL2_DIVISION
"RTN","MAGDHWC",80,0)
 . . S (ITYPCODE,ITYPNAME)="" ; may need them nulled in ZSV^MAGDHWA
"RTN","MAGDHWC",81,0)
 . . S IGNORE=0
"RTN","MAGDHWC",82,0)
 . . Q
"RTN","MAGDHWC",83,0)
 . Q
"RTN","MAGDHWC",84,0)
 ;
"RTN","MAGDHWC",85,0)
 ; find ZSV segment and requested service - check if appropriate
"RTN","MAGDHWC",86,0)
 S I=0 I '$$FINDSEG^MAGDHW0(.HL7,"ZSV",.I,.X) Q  ; no ZSV segment
"RTN","MAGDHWC",87,0)
 S SERVICE=$P($P(X,DEL),DEL2,4)
"RTN","MAGDHWC",88,0)
 D SERVICE ; send this transaction to the DICOM gateway?
"RTN","MAGDHWC",89,0)
 I IGNORE Q  ; just ignore HL7 message, don't send it to DICOM gateway
"RTN","MAGDHWC",90,0)
 ;
"RTN","MAGDHWC",91,0)
 S Z=$P(HL7ORC,DEL,1) ; Order Control
"RTN","MAGDHWC",92,0)
 S Y=$P(HL7ORC,DEL,5) ; Order Status
"RTN","MAGDHWC",93,0)
 I Z="SC" S MSGTYPE="RECEIVED" ; received
"RTN","MAGDHWC",94,0)
 E  I Z="RE" D  ; result
"RTN","MAGDHWC",95,0)
 . I Y="A" S MSGTYPE="PARTIAL RESULT" ; unsigned TIU note
"RTN","MAGDHWC",96,0)
 . E  I Y="CM" D  ; check for a new unsigned note
"RTN","MAGDHWC",97,0)
 . . I $$UNSIGNED^MAGDGMRC(GMRCIEN) D
"RTN","MAGDHWC",98,0)
 . . . S MSGTYPE="PARTIAL RESULT" ; unsigned TIU note
"RTN","MAGDHWC",99,0)
 . . . S FILLER1="GMRC-NEW UNSIGNED RESULT"
"RTN","MAGDHWC",100,0)
 . . . Q
"RTN","MAGDHWC",101,0)
 . . E  S MSGTYPE="COMPLETE RESULT"  ; signed TIU note
"RTN","MAGDHWC",102,0)
 . . Q
"RTN","MAGDHWC",103,0)
 . Q
"RTN","MAGDHWC",104,0)
 E  S MSGTYPE="UNKNOWN"
"RTN","MAGDHWC",105,0)
 D MSH^MAGDHWA,PID^MAGDHWA,ORC^MAGDHWA,OBR^MAGDHWA,ZSV^MAGDHWA
"RTN","MAGDHWC",106,0)
 I '$$OBX() D  ; get OBX segment from database
"RTN","MAGDHWC",107,0)
 . S I=$O(HL7(""),-1)+1 S I=$$OBX^MAGDHWS(I)
"RTN","MAGDHWC",108,0)
 . Q
"RTN","MAGDHWC",109,0)
 E  D  ; process existing OBX segment
"RTN","MAGDHWC",110,0)
 . D OBX1
"RTN","MAGDHWC",111,0)
 . Q
"RTN","MAGDHWC",112,0)
 D ALLERGY^MAGDHWA,POSTINGS^MAGDHWA
"RTN","MAGDHWC",113,0)
 D OUTPUT^MAGDHW0
"RTN","MAGDHWC",114,0)
 Q
"RTN","MAGDHWC",115,0)
 ;
"RTN","MAGDHWC",116,0)
SERVICE ; check if the service is in the DICOM Clinical Service dictionary
"RTN","MAGDHWC",117,0)
 N Y
"RTN","MAGDHWC",118,0)
 I SERVICE D  ; ignore SERVICE if it is null
"RTN","MAGDHWC",119,0)
 . S Y=$G(^MAG(2006.5831,SERVICE,0))
"RTN","MAGDHWC",120,0)
 . S DIVISION=DEL2
"RTN","MAGDHWC",121,0)
 . I Y D  ; new service is of interest to DICOM Gateway
"RTN","MAGDHWC",122,0)
 . . D DIVISION(Y)
"RTN","MAGDHWC",123,0)
 . . S Z=$P(Y,"^",2)
"RTN","MAGDHWC",124,0)
 . . S ITYPNAME=$P(^MAG(2005.84,Z,0),"^",1)
"RTN","MAGDHWC",125,0)
 . . S ITYPCODE=$P(^MAG(2005.84,Z,2),"^",1)
"RTN","MAGDHWC",126,0)
 . . S IGNORE=0
"RTN","MAGDHWC",127,0)
 . . D APPOINT
"RTN","MAGDHWC",128,0)
 . . Q
"RTN","MAGDHWC",129,0)
 . Q
"RTN","MAGDHWC",130,0)
 Q
"RTN","MAGDHWC",131,0)
 ;
"RTN","MAGDHWC",132,0)
DIVISION(Y) ;
"RTN","MAGDHWC",133,0)
 S DIVISION=$P(Y,"^",3)
"RTN","MAGDHWC",134,0)
 S DIVISION=DIVISION_DEL2_$S(DIVISION:$$GET1^DIQ(4,DIVISION,.01),1:"")
"RTN","MAGDHWC",135,0)
 Q
"RTN","MAGDHWC",136,0)
 ;
"RTN","MAGDHWC",137,0)
APPOINT ; quite often the appointment is entered before the order is entered
"RTN","MAGDHWC",138,0)
 ; if this is the case, see if we can find the corresponding appointment
"RTN","MAGDHWC",139,0)
 N CLINIC,HIT,I,LOCIEN,ORDERIEN,VASD,XE,XI
"RTN","MAGDHWC",140,0)
 ; look for appointments for today or later - don't need VASD parameters
"RTN","MAGDHWC",141,0)
 D SDA^VADPT ; get the list of the appointments
"RTN","MAGDHWC",142,0)
 ; first check the order record for the patient location
"RTN","MAGDHWC",143,0)
 ; it might be the clinic for the appointment
"RTN","MAGDHWC",144,0)
 S HIT=0 ; indicator for finding an appointment match
"RTN","MAGDHWC",145,0)
 S ORDERIEN=$$GET1^DIQ(123,GMRCIEN,.03,"I")
"RTN","MAGDHWC",146,0)
 S LOCIEN=$S(ORDERIEN:$$GET1^DIQ(100,ORDERIEN,6,"I"),1:"")
"RTN","MAGDHWC",147,0)
 I LOCIEN?1N.N1";SC(" D
"RTN","MAGDHWC",148,0)
 . S CLINIC=+LOCIEN
"RTN","MAGDHWC",149,0)
 . I $$ISCLINIC^MAGDGMRC(SERVICE,CLINIC) D
"RTN","MAGDHWC",150,0)
 . . S I=0 F  S I=$O(^UTILITY("VASD",$J,I)) Q:'I  Q:HIT  D
"RTN","MAGDHWC",151,0)
 . . . S XI=^UTILITY("VASD",$J,I,"I"),XE=^("E")
"RTN","MAGDHWC",152,0)
 . . . ; check if there is an appointment in this clinic
"RTN","MAGDHWC",153,0)
 . . . I CLINIC=$P(XI,"^",2) D APPOINT1 ; select first apt. in clinic
"RTN","MAGDHWC",154,0)
 . . . Q
"RTN","MAGDHWC",155,0)
 . . Q
"RTN","MAGDHWC",156,0)
 . Q
"RTN","MAGDHWC",157,0)
 I 'HIT D  ; no appointment for the pt. location, look for other clinics
"RTN","MAGDHWC",158,0)
 . S I=0 F  S I=$O(^UTILITY("VASD",$J,I)) Q:'I  Q:HIT  D
"RTN","MAGDHWC",159,0)
 . . S XI=^UTILITY("VASD",$J,I,"I"),XE=^("E")
"RTN","MAGDHWC",160,0)
 . . S CLINIC=$P(XI,"^",2)
"RTN","MAGDHWC",161,0)
 . . I $$ISCLINIC^MAGDGMRC(SERVICE,CLINIC) D APPOINT1
"RTN","MAGDHWC",162,0)
 . . Q
"RTN","MAGDHWC",163,0)
 . Q
"RTN","MAGDHWC",164,0)
 K ^UTILITY("VASD",$J)
"RTN","MAGDHWC",165,0)
 Q
"RTN","MAGDHWC",166,0)
 ;
"RTN","MAGDHWC",167,0)
APPOINT1 ; fill the appointment schedule array
"RTN","MAGDHWC",168,0)
 S APTSCHED("FM DATETIME")=$P(XI,"^")
"RTN","MAGDHWC",169,0)
 S APTSCHED("CLINIC IEN")=CLINIC
"RTN","MAGDHWC",170,0)
 S APTSCHED("DATETIME")=$P(XE,"^")
"RTN","MAGDHWC",171,0)
 S APTSCHED("CLINIC NAME")=$P(XE,"^",2)
"RTN","MAGDHWC",172,0)
 S HIT=1 ; to exit loop
"RTN","MAGDHWC",173,0)
 Q
"RTN","MAGDHWC",174,0)
 ;
"RTN","MAGDHWC",175,0)
OBX() ; find OBX segments to determine the highest value of OBXSEGNO
"RTN","MAGDHWC",176,0)
 N I,X
"RTN","MAGDHWC",177,0)
 S OBXSEGNO=0
"RTN","MAGDHWC",178,0)
 S I=0 F  D  Q:I=""  ; $o through HL7 message - quit when at end
"RTN","MAGDHWC",179,0)
 . I $$FINDSEG^MAGDHW0(.HL7,"OBX",.I,.X) S OBXSEGNO=$P(X,DEL,1)
"RTN","MAGDHWC",180,0)
 . Q
"RTN","MAGDHWC",181,0)
 Q OBXSEGNO
"RTN","MAGDHWC",182,0)
 ;
"RTN","MAGDHWC",183,0)
OBX1 ; if there are second level OBX data, add OBX segment prefix
"RTN","MAGDHWC",184,0)
 N I,J
"RTN","MAGDHWC",185,0)
 ; add additional OBX segments to convey the Reason for the Request
"RTN","MAGDHWC",186,0)
 ; more than one, so can't use "I $$FINDSEG^MAGDHW0(.HL7,"OBX",.I) D  "
"RTN","MAGDHWC",187,0)
 S I="" F  S I=$O(HL7(I)) Q:I=""  I $P(HL7(I),DEL)="OBX" D
"RTN","MAGDHWC",188,0)
 . I '$D(HL7(I,1)) Q  ; no additional OBX segments needed
"RTN","MAGDHWC",189,0)
 . S X=$P(HL7(I),DEL,1,5) ; copy pieces 1-5 to other segments
"RTN","MAGDHWC",190,0)
 . S J="" F  S J=$O(HL7(I,J)) Q:'J  S HL7(I,J)=X_DEL_HL7(I,J)
"RTN","MAGDHWC",191,0)
 . Q
"RTN","MAGDHWC",192,0)
 Q
"RTN","MAGDIR81")
0^3^B75253415
"RTN","MAGDIR81",1,0)
MAGDIR81 ;WOIFO/PMK - Read a DICOM image file ; 24 Jan 2006  13:30 PM
"RTN","MAGDIR81",2,0)
 ;;3.0;IMAGING;**11,30,51,50,46**;16-February-2007;;Build 1023
"RTN","MAGDIR81",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDIR81",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR81",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR81",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR81",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR81",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR81",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR81",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR81",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR81",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR81",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR81",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR81",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR81",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR81",17,0)
 ;;
"RTN","MAGDIR81",18,0)
 ;
"RTN","MAGDIR81",19,0)
 ; M2MB server
"RTN","MAGDIR81",20,0)
 ;
"RTN","MAGDIR81",21,0)
 ; This routine is invoked by the ^MAGDIR8 for the "STORE1/STORE2"
"RTN","MAGDIR81",22,0)
 ; REQUEST items when there is an image to be stored into the database.
"RTN","MAGDIR81",23,0)
 ; It adds it to the ^MAG global with appropriate pointers to the
"RTN","MAGDIR81",24,0)
 ; "parent data files".
"RTN","MAGDIR81",25,0)
 ;
"RTN","MAGDIR81",26,0)
ENTRY ; process one image
"RTN","MAGDIR81",27,0)
 N MEDATA ;--- medicine pkg patient & study data (set in ^MAGDIR8A)
"RTN","MAGDIR81",28,0)
 N FILEDATA ;- array of data to be passed between routines
"RTN","MAGDIR81",29,0)
 N FIRSTDCM ;- patient first name from the image header (ie, PNAMEDCM)
"RTN","MAGDIR81",30,0)
 N GMRCIEN ;-- internal entry number of consult/procedure request
"RTN","MAGDIR81",31,0)
 N LASTDCM ;-- patient last name from the image header (ie, PNAMEDCM)
"RTN","MAGDIR81",32,0)
 N MAGGP ;---- image's group pointer in ^MAG(2005)
"RTN","MAGDIR81",33,0)
 N MAGIEN ;--- pointer to the entry for the image in ^MAG(2005)
"RTN","MAGDIR81",34,0)
 N MIDCM ;---- patient middle initial from the image header (PNAMEDCM)
"RTN","MAGDIR81",35,0)
 N PNAMEVAH ;- patient name from VADM(1)
"RTN","MAGDIR81",36,0)
 N PROCDESC ;- procedure description (VA's name)
"RTN","MAGDIR81",37,0)
 N RADATA ;--- radiology pkg patient & study data (set in ^MAGDIR8A)
"RTN","MAGDIR81",38,0)
 N VADM ;----- array of demographic variables filled in by DEM^VADPT
"RTN","MAGDIR81",39,0)
 N I,MAG0,MAG1,MAG2,QUIT,X
"RTN","MAGDIR81",40,0)
 ;
"RTN","MAGDIR81",41,0)
 N ACNUMB,CASENUMB,EMAIL,FROMPATH,IMAGEUID,IMAGNAME,IMAGNUMB,IMGSVC
"RTN","MAGDIR81",42,0)
 N INSTLOC,INSTNAME,LASTIMG,LOCATION,MACHID,MFGR,MODALITY,MODEL,MODPARMS
"RTN","MAGDIR81",43,0)
 N MULTFRAM,PID,PNAMEDCM,ROUTRULE,SERINUMB,SERIEUID,SOPCLASS,STATUS
"RTN","MAGDIR81",44,0)
 N STUDYDAT,STUDYTIM,STUDYDAT,STUDYTIM,STUDYUID,SYSTITLE
"RTN","MAGDIR81",45,0)
 ;
"RTN","MAGDIR81",46,0)
 S STATUS=$P(ARGS,"|",1),LOCATION=$P(ARGS,"|",2)
"RTN","MAGDIR81",47,0)
 S MACHID=$P(ARGS,"|",3),IMGSVC=$P(ARGS,"|",4)
"RTN","MAGDIR81",48,0)
 S INSTNAME=$P(ARGS,"|",5),FROMPATH=$P(ARGS,"|",6)
"RTN","MAGDIR81",49,0)
 S PID=$P(ARGS,"|",7),PNAMEDCM=$P(ARGS,"|",8)
"RTN","MAGDIR81",50,0)
 S CASENUMB=$P(ARGS,"|",9),ACNUMB=$P(ARGS,"|",10)
"RTN","MAGDIR81",51,0)
 S STUDYDAT=$P(ARGS,"|",11),STUDYTIM=$P(ARGS,"|",12)
"RTN","MAGDIR81",52,0)
 S MODALITY=$P(ARGS,"|",14)
"RTN","MAGDIR81",53,0)
 S IMAGNAME=$P(ARGS,"|",15),MODPARMS=$P(ARGS,"|",16)
"RTN","MAGDIR81",54,0)
 S SERINUMB=$P(ARGS,"|",17),IMAGNUMB=$P(ARGS,"|",18)
"RTN","MAGDIR81",55,0)
 S INSTLOC=$P(ARGS,"|",19),MULTFRAM=$P(ARGS,"|",20)
"RTN","MAGDIR81",56,0)
 S SYSTITLE=$P(ARGS,"|",21),EMAIL=$P(ARGS,"|",22)
"RTN","MAGDIR81",57,0)
 S IREQUEST=IREQUEST+1,OPCODE=$P(REQUEST(IREQUEST),"|")
"RTN","MAGDIR81",58,0)
 I OPCODE'="STORE2" D  Q
"RTN","MAGDIR81",59,0)
 . D RESULT^MAGDIR8("STORE","-101 Expecting STORE2, got """_OPCODE_"""")
"RTN","MAGDIR81",60,0)
 . Q
"RTN","MAGDIR81",61,0)
 S ARGS=$P(REQUEST(IREQUEST),"|",2,999)
"RTN","MAGDIR81",62,0)
 S STUDYUID=$P(ARGS,"|",1),SERIEUID=$P(ARGS,"|",2)
"RTN","MAGDIR81",63,0)
 S IMAGEUID=$P(ARGS,"|",3),SOPCLASS=$P(ARGS,"|",4)
"RTN","MAGDIR81",64,0)
 S LASTIMG=$P(ARGS,"|",5),ROUTRULE=$P(ARGS,"|",6)
"RTN","MAGDIR81",65,0)
 S MFGR=$P(ARGS,"|",7),MODEL=$P(ARGS,"|",8)
"RTN","MAGDIR81",66,0)
 ;
"RTN","MAGDIR81",67,0)
 ; get a pointer to the image, if it is already on file
"RTN","MAGDIR81",68,0)
 S MAGIEN=$O(^MAG(2005,"P",IMAGEUID,0))
"RTN","MAGDIR81",69,0)
 ;
"RTN","MAGDIR81",70,0)
 ; the following line will have to be adjusted for DICOM SR
"RTN","MAGDIR81",71,0)
 S FILEDATA("TYPE")=$O(^MAG(2005.83,"B","IMAGE",""))
"RTN","MAGDIR81",72,0)
 ;
"RTN","MAGDIR81",73,0)
 I MULTFRAM,MAGIEN D  ; subsequent image of a multiframe object
"RTN","MAGDIR81",74,0)
 . D MULTFRAM ; require both MULTFRAM and MAGIEN to be non-zero
"RTN","MAGDIR81",75,0)
 . Q
"RTN","MAGDIR81",76,0)
 E  D  Q:ERRCODE  ; new image
"RTN","MAGDIR81",77,0)
 . S ERRCODE=$$NEWIMAGE()
"RTN","MAGDIR81",78,0)
 . I ERRCODE D  ; error - abort image processing
"RTN","MAGDIR81",79,0)
 . . D ERROR^MAGDIR8("STORE",ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR81",80,0)
 . . Q
"RTN","MAGDIR81",81,0)
 . Q
"RTN","MAGDIR81",82,0)
 ;
"RTN","MAGDIR81",83,0)
 ;create the image pointer
"RTN","MAGDIR81",84,0)
 I MODPARMS="<DICOM>" D  ; store DICOM image type in VistA
"RTN","MAGDIR81",85,0)
 . S FILEDATA("OBJECT TYPE")=100 ; DICOM image type
"RTN","MAGDIR81",86,0)
 . S FILEDATA("EXTENSION")="EXT^DCM" ; specify the DICOM file extension
"RTN","MAGDIR81",87,0)
 . Q
"RTN","MAGDIR81",88,0)
 E  D  ; convert DICOM image type to TGA and store it in VistA
"RTN","MAGDIR81",89,0)
 . S FILEDATA("OBJECT TYPE")=3 ; XRAY image type
"RTN","MAGDIR81",90,0)
 . S FILEDATA("EXTENSION")="EXT^TGA" ; specify the TGA file extension
"RTN","MAGDIR81",91,0)
 . Q
"RTN","MAGDIR81",92,0)
 S FILEDATA("ABSTRACT")="ABS^STUFFONLY" ; specify the abstract net loc
"RTN","MAGDIR81",93,0)
 ;
"RTN","MAGDIR81",94,0)
 S ERRCODE=$$IMAGE^MAGDIR9B ; create the ^MAG(2005) entry for the image
"RTN","MAGDIR81",95,0)
 I ERRCODE D  ; error - abort image processing
"RTN","MAGDIR81",96,0)
 . D ERROR^MAGDIR8("STORE",ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR81",97,0)
 . Q
"RTN","MAGDIR81",98,0)
 E  D  ; no error
"RTN","MAGDIR81",99,0)
 . S X="0|"_RETURN
"RTN","MAGDIR81",100,0)
 . ; save pname, pid, dob, age, and sex from DEM^VADPT for gateway
"RTN","MAGDIR81",101,0)
 . F I=1:1:5 S X=X_"|"_VADM(I)
"RTN","MAGDIR81",102,0)
 . S X=X_"|"_$$GETICN^MPIF001(DFN) ; save ICN value
"RTN","MAGDIR81",103,0)
 . D RESULT^MAGDIR8("STORE",X)
"RTN","MAGDIR81",104,0)
 . Q
"RTN","MAGDIR81",105,0)
 Q
"RTN","MAGDIR81",106,0)
 ;
"RTN","MAGDIR81",107,0)
NEWIMAGE() ; processing for a new image
"RTN","MAGDIR81",108,0)
 N ERRORMSG ;- error message causing processing to stop
"RTN","MAGDIR81",109,0)
 N PIDCHECK ;- return value of from $$PIDCHECK^MAGDIR8A()
"RTN","MAGDIR81",110,0)
 ;
"RTN","MAGDIR81",111,0)
 I MAGIEN D  I $L(ERRORMSG) Q ERRORMSG
"RTN","MAGDIR81",112,0)
 . K MSG
"RTN","MAGDIR81",113,0)
 . N Y
"RTN","MAGDIR81",114,0)
 . I IMAGEUID=$$GETUID(MACHID) D  ; same image as last one
"RTN","MAGDIR81",115,0)
 . . ; process the image again, after software crash
"RTN","MAGDIR81",116,0)
 . . ; If the software crashed processing the first image, it might
"RTN","MAGDIR81",117,0)
 . . ; delete the image without ever writing it to the file server.
"RTN","MAGDIR81",118,0)
 . . ; Now, the image processing software has a second chance.
"RTN","MAGDIR81",119,0)
 . . S Y=$P($G(^MAG(2005,MAGIEN,2)),"^") I Y D DD^%DT
"RTN","MAGDIR81",120,0)
 . . S MSG(1)="Reprocessing image """_FROMPATH_""""
"RTN","MAGDIR81",121,0)
 . . S MSG(2)="which is partially in the database (#"_MAGIEN_") for"
"RTN","MAGDIR81",122,0)
 . . S MSG(3)=""""_$P($G(^MAG(2005,MAGIEN,0)),"^")_""""
"RTN","MAGDIR81",123,0)
 . . S MSG(4)="Acquired on "_Y
"RTN","MAGDIR81",124,0)
 . . S MSG(5)="UID = "_IMAGEUID
"RTN","MAGDIR81",125,0)
 . . D ERROR^MAGDIR8("STORE","1 Image partially in the database",.MSG,$T(+0))
"RTN","MAGDIR81",126,0)
 . . S ERRORMSG="" ; this is not an error!
"RTN","MAGDIR81",127,0)
 . . Q
"RTN","MAGDIR81",128,0)
 . E  D  ; don't accept images with duplicate UIDs
"RTN","MAGDIR81",129,0)
 . . S Y=$P($G(^MAG(2005,MAGIEN,2)),"^") I Y D DD^%DT
"RTN","MAGDIR81",130,0)
 . . S MSG(1)="Image """_FROMPATH_""""
"RTN","MAGDIR81",131,0)
 . . S MSG(2)="is already in the database (#"_MAGIEN_") for"
"RTN","MAGDIR81",132,0)
 . . S MSG(3)=""""_$P($G(^MAG(2005,MAGIEN,0)),"^")_""""
"RTN","MAGDIR81",133,0)
 . . S MSG(4)="Acquired on "_Y
"RTN","MAGDIR81",134,0)
 . . S MSG(5)="UID = "_IMAGEUID
"RTN","MAGDIR81",135,0)
 . . S ERRORMSG="-1 Image already in database"
"RTN","MAGDIR81",136,0)
 . . Q
"RTN","MAGDIR81",137,0)
 . Q
"RTN","MAGDIR81",138,0)
 ;
"RTN","MAGDIR81",139,0)
 D SAVEUID(MACHID,IMAGEUID) ; record the UID of the image being processed
"RTN","MAGDIR81",140,0)
 ;
"RTN","MAGDIR81",141,0)
 ; lookup the study by ACNUMB/CASENUMB, get DFN, and double-check PID
"RTN","MAGDIR81",142,0)
 S ERRCODE=$$LOOKUP Q:ERRCODE ERRCODE
"RTN","MAGDIR81",143,0)
 ;
"RTN","MAGDIR81",144,0)
 S PIDCHECK=$$PIDCHECK^MAGDIR8A()
"RTN","MAGDIR81",145,0)
 I PIDCHECK D  Q "-2 Image Association Problem" ; didn't find the study
"RTN","MAGDIR81",146,0)
 . N CASETEXT,COLUMNS,MFGR,MODEL,MODIEN,OFFSET,ROWS
"RTN","MAGDIR81",147,0)
 . ; formulate error message
"RTN","MAGDIR81",148,0)
 . K MSG
"RTN","MAGDIR81",149,0)
 . S MSG(1)=PIDCHECK
"RTN","MAGDIR81",150,0)
 . S (ROWS,COLUMNS,OFFSET,MODIEN,MFGR,MODEL,CASETEXT)=""
"RTN","MAGDIR81",151,0)
 . D MOVE^MAGDLBAA
"RTN","MAGDIR81",152,0)
 . Q
"RTN","MAGDIR81",153,0)
 ; create the group pointer
"RTN","MAGDIR81",154,0)
 I IMGSVC="RAD" D  Q:ERRCODE ERRCODE
"RTN","MAGDIR81",155,0)
 . S ERRCODE=$$GROUP^MAGDIR9A
"RTN","MAGDIR81",156,0)
 . Q
"RTN","MAGDIR81",157,0)
 E  I IMGSVC="CON" D  Q:ERRCODE ERRCODE
"RTN","MAGDIR81",158,0)
 . S ERRCODE=$$GROUP^MAGDIR9E
"RTN","MAGDIR81",159,0)
 . Q
"RTN","MAGDIR81",160,0)
 E  D  Q 3  ; undefined imaging service - same as error #4 in LOOKUP
"RTN","MAGDIR81",161,0)
 . K MSG
"RTN","MAGDIR81",162,0)
 . S MSG(1)="Undefined Imaging Service: "_IMGSVC
"RTN","MAGDIR81",163,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR81",164,0)
 . Q
"RTN","MAGDIR81",165,0)
 Q 0
"RTN","MAGDIR81",166,0)
 ;
"RTN","MAGDIR81",167,0)
SAVEUID(MACHID,UID) ; record the UID of the image being processed
"RTN","MAGDIR81",168,0)
 N D0,X
"RTN","MAGDIR81",169,0)
 S D0=$O(^MAGD(2006.5715,"B",MACHID,"")) D:'D0
"RTN","MAGDIR81",170,0)
 . L +^MAGD(2006.5715):1E9 ; Background process MUST wait
"RTN","MAGDIR81",171,0)
 . S D0=$O(^MAGD(2006.5715," "),-1)+1
"RTN","MAGDIR81",172,0)
 . S X=$G(^MAGD(2006.5715,0))
"RTN","MAGDIR81",173,0)
 . S $P(X,"^",1,2)="CURRENT IMAGE^2006.5715"
"RTN","MAGDIR81",174,0)
 . S $P(X,"^",3)=D0
"RTN","MAGDIR81",175,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDIR81",176,0)
 . S ^MAGD(2006.5715,0)=X
"RTN","MAGDIR81",177,0)
 . S ^MAGD(2006.5715,D0,0)=MACHID
"RTN","MAGDIR81",178,0)
 . S ^MAGD(2006.5715,"B",MACHID,D0)=""
"RTN","MAGDIR81",179,0)
 . L -^MAGD(2006.5715)
"RTN","MAGDIR81",180,0)
 . Q
"RTN","MAGDIR81",181,0)
 S $P(^MAGD(2006.5715,D0,0),"^",2)=UID
"RTN","MAGDIR81",182,0)
 Q
"RTN","MAGDIR81",183,0)
 ;
"RTN","MAGDIR81",184,0)
GETUID(MACHID) ; lookup the UID of the last image processed
"RTN","MAGDIR81",185,0)
 N D0
"RTN","MAGDIR81",186,0)
 S D0=+$O(^MAGD(2006.5715,"B",MACHID,""))
"RTN","MAGDIR81",187,0)
 Q $P($G(^MAGD(2006.5715,D0,0)),"^",2)
"RTN","MAGDIR81",188,0)
 ;
"RTN","MAGDIR81",189,0)
MULTFRAM ; Handle additional images in a multiframe object
"RTN","MAGDIR81",190,0)
 ; Get the information from the first image for the additional ones
"RTN","MAGDIR81",191,0)
 ;
"RTN","MAGDIR81",192,0)
 N DIQUIET,INAME,MAG0,MAG40,MAG100,MAGPACS
"RTN","MAGDIR81",193,0)
 N SOPCLASP ; pointer to SOP Class file (#2006.532)
"RTN","MAGDIR81",194,0)
 S MAG0=^MAG(2005,MAGIEN,0),MAG1=$G(^(1)),MAG2=$G(^(2))
"RTN","MAGDIR81",195,0)
 S MAG40=$G(^MAG(2005,MAGIEN,40)),MAG100=$G(^(100))
"RTN","MAGDIR81",196,0)
 S MAGPACS=$G(^MAG(2005,MAGIEN,"PACS"))
"RTN","MAGDIR81",197,0)
 S INAME=$P(MAG0,"^",1) ; field .01
"RTN","MAGDIR81",198,0)
 S PNAMEVAH=$P(INAME,"  ",1),DCMPID=$P(INAME,"  ",2)
"RTN","MAGDIR81",199,0)
 S DFN=$P(MAG0,"^",7) ; field 5
"RTN","MAGDIR81",200,0)
 S MAGGP=$P(MAG0,"^",10) ; field 14
"RTN","MAGDIR81",201,0)
 S DATETIME=$P(MAG2,"^",5) ; field 15
"RTN","MAGDIR81",202,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR81",203,0)
 S FILEDATA("PARENT FILE")=$P(MAG2,"^",6) ; field 16
"RTN","MAGDIR81",204,0)
 S FILEDATA("PARENT IEN")=$P(MAG2,"^",7) ; field 17
"RTN","MAGDIR81",205,0)
 S FILEDATA("PARENT FILE PTR")=$P(MAG2,"^",8) ; field 18
"RTN","MAGDIR81",206,0)
 S FILEDATA("RAD REPORT")=$P(MAGPACS,"^",2) ; field 61
"RTN","MAGDIR81",207,0)
 S FILEDATA("RAD PROC PTR")=$P(MAGPACS,"^",3) ; field 62
"RTN","MAGDIR81",208,0)
 S FILEDATA("PACKAGE")=$P(MAG40,"^",1) ; field 40
"RTN","MAGDIR81",209,0)
 ; field 41 is not needed
"RTN","MAGDIR81",210,0)
 S FILEDATA("TYPE")=$P(MAG40,"^",3) ; field 42
"RTN","MAGDIR81",211,0)
 S FILEDATA("PROC/EVENT")=$P(MAG40,"^",4) ; field 43
"RTN","MAGDIR81",212,0)
 S FILEDATA("SPEC/SUBSPEC")=$P(MAG40,"^",5) ; field 44
"RTN","MAGDIR81",213,0)
 S FILEDATA("ACQUISITION DEVICE")=$P(MAG100,"^",4) ; field 107
"RTN","MAGDIR81",214,0)
 ; get the SOP Class pointer (file 2005, field 251)
"RTN","MAGDIR81",215,0)
 S SOPCLASP=$O(^MAG(2006.532,"B",SOPCLASS,""))
"RTN","MAGDIR81",216,0)
 S FILEDATA("SOP CLASS POINTER")=SOPCLASP
"RTN","MAGDIR81",217,0)
 S PROCDESC=$P(MAG2,"^",4) ; field 10
"RTN","MAGDIR81",218,0)
 ; S X="" F  S X=$O(FILEDATA(X)) Q:X=""  I FILEDATA(X)="" K FILEDATA(X)
"RTN","MAGDIR81",219,0)
 I PROCDESC?.E1" (#".N1")" S PROCDESC=$P(PROCDESC," (#")
"RTN","MAGDIR81",220,0)
 ; lookup patient in VistA database - needed to build VADM array
"RTN","MAGDIR81",221,0)
 S DIQUIET=1 D DEM^VADPT
"RTN","MAGDIR81",222,0)
 Q
"RTN","MAGDIR81",223,0)
 ;
"RTN","MAGDIR81",224,0)
LOOKUP() ; lookup the patient/study using cross-reference
"RTN","MAGDIR81",225,0)
 I IMGSVC="RAD" D
"RTN","MAGDIR81",226,0)
 . D RADLKUP^MAGDIR8A
"RTN","MAGDIR81",227,0)
 . Q
"RTN","MAGDIR81",228,0)
 E  I IMGSVC="CON" D
"RTN","MAGDIR81",229,0)
 . S ACNUMB=CASENUMB
"RTN","MAGDIR81",230,0)
 . D CONLKUP^MAGDIR8A
"RTN","MAGDIR81",231,0)
 . Q
"RTN","MAGDIR81",232,0)
 E  D  Q 4 ; undefined imaging service - same as error #3 in NEWIMAGE
"RTN","MAGDIR81",233,0)
 . K MSG
"RTN","MAGDIR81",234,0)
 . S MSG(1)="Undefined Imaging Service: "_IMGSVC
"RTN","MAGDIR81",235,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR81",236,0)
 . Q
"RTN","MAGDIR81",237,0)
 Q 0
"RTN","MAGDIR9A")
0^4^B49652107
"RTN","MAGDIR9A",1,0)
MAGDIR9A ;WOIFO/PMK - Read a DICOM image file ; 09 Feb 2006  7:38 AM
"RTN","MAGDIR9A",2,0)
 ;;3.0;IMAGING;**11,30,51,46**;16-February-2007;;Build 1023
"RTN","MAGDIR9A",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDIR9A",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9A",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR9A",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR9A",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR9A",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR9A",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR9A",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR9A",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR9A",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR9A",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR9A",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR9A",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR9A",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9A",17,0)
 ;;
"RTN","MAGDIR9A",18,0)
 ;
"RTN","MAGDIR9A",19,0)
 ; M2MB server
"RTN","MAGDIR9A",20,0)
 ;
"RTN","MAGDIR9A",21,0)
 ; This routine creates a ^mag(2005) group entry and links it to the
"RTN","MAGDIR9A",22,0)
 ; associated radiology report
"RTN","MAGDIR9A",23,0)
 ;
"RTN","MAGDIR9A",24,0)
 ;   XXXXXX      XX    XXXXXX
"RTN","MAGDIR9A",25,0)
 ;    XX  XX    XXXX    XX  XX
"RTN","MAGDIR9A",26,0)
 ;    XX  XX   XX  XX   XX  XX
"RTN","MAGDIR9A",27,0)
 ;    XXXXX    XX  XX   XX  XX
"RTN","MAGDIR9A",28,0)
 ;    XX XX    XXXXXX   XX  XX
"RTN","MAGDIR9A",29,0)
 ;    XX  XX   XX  XX   XX  XX
"RTN","MAGDIR9A",30,0)
 ;   XXX  XX   XX  XX  XXXXXX
"RTN","MAGDIR9A",31,0)
 ;
"RTN","MAGDIR9A",32,0)
GROUP() ; entry point from ^MAGDIR81
"RTN","MAGDIR9A",33,0)
 N ACQDEVP ;-- pointer to acquisition device file (#2006.04)
"RTN","MAGDIR9A",34,0)
 N DA ;------ fileman variable
"RTN","MAGDIR9A",35,0)
 N ERRCODE ;- error trap code
"RTN","MAGDIR9A",36,0)
 N GROUP ;--- array to pass group data to ^MAGGTIA
"RTN","MAGDIR9A",37,0)
 N GROUPDFN ; DFN value from image group entry for double checking
"RTN","MAGDIR9A",38,0)
 N P ;-------- scratch variable (pointer to ACQUISITION DEVICE file)
"RTN","MAGDIR9A",39,0)
 N RACNE ;--- external "3rd level" subscript in ^RADPT
"RTN","MAGDIR9A",40,0)
 N RACNI ;--- internal "3rd level" subscript in ^RADPT
"RTN","MAGDIR9A",41,0)
 N RADFN ;--- radiology package's DFN
"RTN","MAGDIR9A",42,0)
 N RADTE ;--- external "2nd level" subscript in ^RADPT
"RTN","MAGDIR9A",43,0)
 N RADTI ;--- internal "2nd level" subscript in ^RADPT
"RTN","MAGDIR9A",44,0)
 N RARPT ;--- 1st level node in ^RARPT for report (ie, the ien)
"RTN","MAGDIR9A",45,0)
 N RARPT3 ;-- 3rd level node for 2005 multiple under ^RARPT's report
"RTN","MAGDIR9A",46,0)
 N RARPTDFN ; DFN value from ^RARPT for double checking
"RTN","MAGDIR9A",47,0)
 N SOPCLASP ; pointer to SOP Class file (#2006.532)
"RTN","MAGDIR9A",48,0)
 N HIT,ISPECIDX,X,Y ; scratch variables
"RTN","MAGDIR9A",49,0)
 ;
"RTN","MAGDIR9A",50,0)
 S ERRCODE=""
"RTN","MAGDIR9A",51,0)
 ;
"RTN","MAGDIR9A",52,0)
 S (RADFN,DA(2))=DFN ; patient DFN variables
"RTN","MAGDIR9A",53,0)
 S RADTI=RADATA("RADPT2") ; case subscript
"RTN","MAGDIR9A",54,0)
 I RADTI="" D  Q ERRCODE
"RTN","MAGDIR9A",55,0)
 . K MSG
"RTN","MAGDIR9A",56,0)
 . S MSG(1)="No radiology case number specified for patient "_DFN
"RTN","MAGDIR9A",57,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",58,0)
 . S ERRCODE=-301
"RTN","MAGDIR9A",59,0)
 . Q
"RTN","MAGDIR9A",60,0)
 ;
"RTN","MAGDIR9A",61,0)
 S RADTE=$TR(RADATA("RADPT2"),"0123456789","9876543210")
"RTN","MAGDIR9A",62,0)
 S RACNI=RADATA("RADPT3")
"RTN","MAGDIR9A",63,0)
 S RACNE=$S(CASENUMB["-":$P(CASENUMB,"-",2),1:CASENUMB) ; short case #
"RTN","MAGDIR9A",64,0)
 ;
"RTN","MAGDIR9A",65,0)
 ; check for the existence of the entry in ^RADPT (redundant)
"RTN","MAGDIR9A",66,0)
 I '$D(^RADPT(RADFN,"DT",RADTI,0)) D  Q ERRCODE ; can't process further
"RTN","MAGDIR9A",67,0)
 . K MSG
"RTN","MAGDIR9A",68,0)
 . S MSG(1)="Radiology case "_RADTI_" is not in ^RADPT("_RADFN_")"
"RTN","MAGDIR9A",69,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",70,0)
 . S ERRCODE=-302
"RTN","MAGDIR9A",71,0)
 . Q
"RTN","MAGDIR9A",72,0)
 ;
"RTN","MAGDIR9A",73,0)
 ; check for the existence of the report pointer
"RTN","MAGDIR9A",74,0)
 S RARPT=$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),"^",17)
"RTN","MAGDIR9A",75,0)
 ; if the report does not yet exist, create it
"RTN","MAGDIR9A",76,0)
 D:RARPT=""
"RTN","MAGDIR9A",77,0)
 . N RACN
"RTN","MAGDIR9A",78,0)
 . S RACN=RACNE D CREATE^RARIC ; create the report
"RTN","MAGDIR9A",79,0)
 . Q
"RTN","MAGDIR9A",80,0)
 ;
"RTN","MAGDIR9A",81,0)
 ; If RARPT is no longer defined at this point, this means
"RTN","MAGDIR9A",82,0)
 ; that we're dealing with an old study, and the report has
"RTN","MAGDIR9A",83,0)
 ; been archived and purged.
"RTN","MAGDIR9A",84,0)
 ;
"RTN","MAGDIR9A",85,0)
 I '$G(RARPT) D  Q ERRCODE
"RTN","MAGDIR9A",86,0)
 . K MSG
"RTN","MAGDIR9A",87,0)
 . S MSG(1)="IMAGE GROUP CREATION ERROR:"
"RTN","MAGDIR9A",88,0)
 . S MSG(2)="Radiology Report has been archived and purged."
"RTN","MAGDIR9A",89,0)
 . S MSG(3)="Patient "_$G(RADFN)_", Date "_$G(RADTI)_", Case "_$G(RACNI)
"RTN","MAGDIR9A",90,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",91,0)
 . S ERRCODE=-303
"RTN","MAGDIR9A",92,0)
 . Q
"RTN","MAGDIR9A",93,0)
 ;
"RTN","MAGDIR9A",94,0)
 ; double check the DFN value from ^RARPT to make sure its right
"RTN","MAGDIR9A",95,0)
 S RARPTDFN=$P($G(^RARPT(RARPT,0)),"^",2)
"RTN","MAGDIR9A",96,0)
 I RARPTDFN'=DFN D  Q ERRCODE ; fatal error
"RTN","MAGDIR9A",97,0)
 . D RADMISS^MAGDIRVE($T(+0),DFN,RARPT,RARPTDFN)
"RTN","MAGDIR9A",98,0)
 . S ERRCODE=-304
"RTN","MAGDIR9A",99,0)
 . Q
"RTN","MAGDIR9A",100,0)
 ;
"RTN","MAGDIR9A",101,0)
 ; initialize FILEDATA for GROUP and IMAGE
"RTN","MAGDIR9A",102,0)
 ; get the acquisition device pointer (file 2005, field 107)
"RTN","MAGDIR9A",103,0)
 S ACQDEVP=$$ACQDEV^MAGDFCNV(MFGR,MODEL,INSTLOC)
"RTN","MAGDIR9A",104,0)
 S FILEDATA("ACQUISITION DEVICE")=ACQDEVP
"RTN","MAGDIR9A",105,0)
 ; get the SOP Class pointer (file 2005, field 251)
"RTN","MAGDIR9A",106,0)
 S SOPCLASP=$O(^MAG(2006.532,"B",SOPCLASS,""))
"RTN","MAGDIR9A",107,0)
 S FILEDATA("SOP CLASS POINTER")=SOPCLASP
"RTN","MAGDIR9A",108,0)
 ;
"RTN","MAGDIR9A",109,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR9A",110,0)
 S FILEDATA("PARENT FILE")=74
"RTN","MAGDIR9A",111,0)
 S FILEDATA("PARENT IEN")=RARPT
"RTN","MAGDIR9A",112,0)
 S FILEDATA("RAD REPORT")=RARPT
"RTN","MAGDIR9A",113,0)
 S FILEDATA("RAD PROC PTR")=RADATA("PROCIEN")
"RTN","MAGDIR9A",114,0)
 S FILEDATA("PACKAGE")="RAD"
"RTN","MAGDIR9A",115,0)
 S X=$S(MODALITY="NM":"NUCLEAR MEDICINE",1:"RADIOLOGY")
"RTN","MAGDIR9A",116,0)
 S ISPECIDX=$O(^MAG(2005.84,"B",X,""))
"RTN","MAGDIR9A",117,0)
 S X=$$FIELD43^MAGXMA(MODALITY,ISPECIDX,.Y)
"RTN","MAGDIR9A",118,0)
 S FILEDATA("PROC/EVENT")=$S(X=0:Y,1:"")
"RTN","MAGDIR9A",119,0)
 S FILEDATA("SPEC/SUBSPEC")=ISPECIDX
"RTN","MAGDIR9A",120,0)
 ;
"RTN","MAGDIR9A",121,0)
 ; find the corresponding image group node under the report
"RTN","MAGDIR9A",122,0)
 S (HIT,RARPT3)=0
"RTN","MAGDIR9A",123,0)
 F  S RARPT3=$O(^RARPT(RARPT,2005,RARPT3)) Q:'RARPT3  D  Q:HIT  Q:ERRCODE
"RTN","MAGDIR9A",124,0)
 . S MAGGP=+$G(^RARPT(RARPT,2005,RARPT3,0)) ; get imaging group pointer
"RTN","MAGDIR9A",125,0)
 . S GROUPDFN=$P($G(^MAG(2005,MAGGP,0)),"^",7) ; check image DFN value
"RTN","MAGDIR9A",126,0)
 . I GROUPDFN'=DFN D  ; fatal error
"RTN","MAGDIR9A",127,0)
 . . D MISMATCH^MAGDIRVE($T(+0),DFN,MAGGP)
"RTN","MAGDIR9A",128,0)
 . . S ERRCODE=-305
"RTN","MAGDIR9A",129,0)
 . . Q
"RTN","MAGDIR9A",130,0)
 . E  I $P($G(^MAG(2005,MAGGP,0)),"^",6)=11 D
"RTN","MAGDIR9A",131,0)
 . . ; check to see that this group is for the same SOP Class
"RTN","MAGDIR9A",132,0)
 . . S P=$P($G(^MAG(2005,MAGGP,"SOP")),"^",1)
"RTN","MAGDIR9A",133,0)
 . . S HIT=$$EQUIVGRP^MAGDFCNV(P,SOPCLASP) ; equivalent groups?
"RTN","MAGDIR9A",134,0)
 . . Q
"RTN","MAGDIR9A",135,0)
 . Q
"RTN","MAGDIR9A",136,0)
 ;
"RTN","MAGDIR9A",137,0)
 I ERRCODE Q ERRCODE ; fatal image DFN problem
"RTN","MAGDIR9A",138,0)
 ;
"RTN","MAGDIR9A",139,0)
 I 'HIT D  Q:ERRCODE ERRCODE ; the 2005 node does not yet exist
"RTN","MAGDIR9A",140,0)
 . ; create the radiology imaging group
"RTN","MAGDIR9A",141,0)
 . N PROCEDUR,RADRPT,RADPTR
"RTN","MAGDIR9A",142,0)
 . S PROCEDUR="RAD "_FILEDATA("MODALITY")
"RTN","MAGDIR9A",143,0)
 . S RADRPT=FILEDATA("RAD REPORT")
"RTN","MAGDIR9A",144,0)
 . S RADPTR=FILEDATA("RAD PROC PTR")
"RTN","MAGDIR9A",145,0)
 . D NEWGROUP(PROCEDUR,RADRPT,RADPTR) Q:ERRCODE
"RTN","MAGDIR9A",146,0)
 . ;
"RTN","MAGDIR9A",147,0)
 . ; store the cross-reference for the report
"RTN","MAGDIR9A",148,0)
 . D PTR^RARIC
"RTN","MAGDIR9A",149,0)
 . Q
"RTN","MAGDIR9A",150,0)
 ;
"RTN","MAGDIR9A",151,0)
 I 'MAGGP D  Q ERRCODE ; fatal error
"RTN","MAGDIR9A",152,0)
 . K MSG
"RTN","MAGDIR9A",153,0)
 . S MSG(1)="IMAGE GROUP LOOKUP ERROR:"
"RTN","MAGDIR9A",154,0)
 . S MSG(2)="Looking for 2005 cross reference in ^RARPT("_RARPT_")"
"RTN","MAGDIR9A",155,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",156,0)
 . S ERRCODE=-308
"RTN","MAGDIR9A",157,0)
 . Q
"RTN","MAGDIR9A",158,0)
 Q 0
"RTN","MAGDIR9A",159,0)
 ;
"RTN","MAGDIR9A",160,0)
NEWGROUP(PROCEDUR,RADRPT,RADPTR) ; create an imaging group (called by ^MAGDIR9E)
"RTN","MAGDIR9A",161,0)
 K GROUP
"RTN","MAGDIR9A",162,0)
 S GROUP(1)=".01^"_PNAMEVAH_"  "_DCMPID_"  "_PROCDESC
"RTN","MAGDIR9A",163,0)
 S GROUP(2)="3^11" ; Object Type -- XRAY Group
"RTN","MAGDIR9A",164,0)
 S GROUP(3)="5^"_DFN
"RTN","MAGDIR9A",165,0)
 S GROUP(4)="6^"_PROCEDUR
"RTN","MAGDIR9A",166,0)
 S GROUP(5)="2005.04^0"
"RTN","MAGDIR9A",167,0)
 S GROUP(6)="10^"_PROCDESC
"RTN","MAGDIR9A",168,0)
 S GROUP(7)="15^"_DATETIME
"RTN","MAGDIR9A",169,0)
 S GROUP(8)="16^"_FILEDATA("PARENT FILE")
"RTN","MAGDIR9A",170,0)
 S GROUP(9)="17^"_FILEDATA("PARENT IEN")
"RTN","MAGDIR9A",171,0)
 S GROUP(10)="60^"_STUDYUID
"RTN","MAGDIR9A",172,0)
 ;
"RTN","MAGDIR9A",173,0)
 ; the following two fields are only for radiology
"RTN","MAGDIR9A",174,0)
 I $D(RADRPT) S GROUP(11)="61^"_RADRPT
"RTN","MAGDIR9A",175,0)
 I $D(RADPTR) S GROUP(12)="62^"_RADPTR
"RTN","MAGDIR9A",176,0)
 ;
"RTN","MAGDIR9A",177,0)
 S GROUP(13)=".05^"_INSTLOC
"RTN","MAGDIR9A",178,0)
 S GROUP(14)="40^"_FILEDATA("PACKAGE")
"RTN","MAGDIR9A",179,0)
 S GROUP(15)="41^"_$O(^MAG(2005.82,"B","CLIN",""))
"RTN","MAGDIR9A",180,0)
 S GROUP(16)="42^"_FILEDATA("TYPE")
"RTN","MAGDIR9A",181,0)
 S GROUP(17)="43^"_FILEDATA("PROC/EVENT")
"RTN","MAGDIR9A",182,0)
 S GROUP(18)="44^"_FILEDATA("SPEC/SUBSPEC")
"RTN","MAGDIR9A",183,0)
 S GROUP(19)="107^"_FILEDATA("ACQUISITION DEVICE")
"RTN","MAGDIR9A",184,0)
 S GROUP(20)="251^"_FILEDATA("SOP CLASS POINTER")
"RTN","MAGDIR9A",185,0)
 D ADD^MAGGTIA(.RETURN,.GROUP)
"RTN","MAGDIR9A",186,0)
 S MAGGP=+RETURN
"RTN","MAGDIR9A",187,0)
 I 'MAGGP D  Q  ; fatal error
"RTN","MAGDIR9A",188,0)
 . K MSG
"RTN","MAGDIR9A",189,0)
 . S MSG(1)="IMAGE GROUP CREATION ERROR:"
"RTN","MAGDIR9A",190,0)
 . S MSG(2)=$P(RETURN,"^",2,999)
"RTN","MAGDIR9A",191,0)
 . D BADERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",192,0)
 . S ERRCODE=-306
"RTN","MAGDIR9A",193,0)
 . Q
"RTN","MAGDIR9A",194,0)
 ;
"RTN","MAGDIR9A",195,0)
 I MAGGP<LASTIMG D  Q  ; fatal last image pointer error
"RTN","MAGDIR9A",196,0)
 . D GROUPPTR^MAGDIRVE($T(+0),MAGGP,LASTIMG)
"RTN","MAGDIR9A",197,0)
 . S ERRCODE=-307
"RTN","MAGDIR9A",198,0)
 . Q
"RTN","MAGDIR9A",199,0)
 Q
"RTN","MAGDIR9A",200,0)
 ;
"RTN","MAGDIR9E")
0^5^B69820632
"RTN","MAGDIR9E",1,0)
MAGDIR9E ;WOIFO/PMK - Read a DICOM image file ; 15 Feb 2006  10:49 AM
"RTN","MAGDIR9E",2,0)
 ;;3.0;IMAGING;**11,51,46**;16-February-2007;;Build 1023
"RTN","MAGDIR9E",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDIR9E",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9E",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR9E",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR9E",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR9E",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR9E",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR9E",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR9E",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR9E",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR9E",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR9E",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR9E",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR9E",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9E",17,0)
 ;;
"RTN","MAGDIR9E",18,0)
 ;
"RTN","MAGDIR9E",19,0)
 ; M2MB server
"RTN","MAGDIR9E",20,0)
 ;
"RTN","MAGDIR9E",21,0)
 ; This routine creates the group entry in ^MAG(2005) and links it
"RTN","MAGDIR9E",22,0)
 ; to the consult/procedure request in GMRC.
"RTN","MAGDIR9E",23,0)
 ;
"RTN","MAGDIR9E",24,0)
 ;     XXXX                                         XXX       X
"RTN","MAGDIR9E",25,0)
 ;    XX  XX                                         XX      XX
"RTN","MAGDIR9E",26,0)
 ;   XX         XXXX    XX XXX  XXXXXXX  XX  XXX     XX     XXXXX
"RTN","MAGDIR9E",27,0)
 ;   XX        XX  XX   XXX XX  XX       XX  XX      XX      XX
"RTN","MAGDIR9E",28,0)
 ;   XX    X   XX  XX   XX  XX  XXXXXXX  XX  XX      XX      XX
"RTN","MAGDIR9E",29,0)
 ;    XX  XX   XX  XX   XX  XX       XX  XX  XX      XX      XX XX
"RTN","MAGDIR9E",30,0)
 ;     XXXX     XXXX    XX  XX  XXXXXXX   XXX XX    XXXX      XXX
"RTN","MAGDIR9E",31,0)
 ;
"RTN","MAGDIR9E",32,0)
 ;
"RTN","MAGDIR9E",33,0)
GROUP() ; entry point from ^MAGDIR8 for consult/procedure groups
"RTN","MAGDIR9E",34,0)
 N ACQDEVP ;-- pointer to acquisition device file (#2006.04)
"RTN","MAGDIR9E",35,0)
 N D0 ;------- fileman variable
"RTN","MAGDIR9E",36,0)
 N ERRCODE ;-- error trap code
"RTN","MAGDIR9E",37,0)
 N GROUP ;---- array to pass group data to ^MAGGTIA
"RTN","MAGDIR9E",38,0)
 N MAGGPP ;--- pointer to group in DICOM GMRC TEMP LIST ^MAG(20006.5839)
"RTN","MAGDIR9E",39,0)
 N P ;-------- scratch variable (pointer to ACQUISITION DEVICE file)
"RTN","MAGDIR9E",40,0)
 N RESULT ;--- scratch variable
"RTN","MAGDIR9E",41,0)
 N SERVICE ;-- service performing the consult/procedure - ^GMR(123.5)
"RTN","MAGDIR9E",42,0)
 N SOPCLASP ;- pointer to SOP Class file (#2006.532)
"RTN","MAGDIR9E",43,0)
 N TIUIEN ;--- TIU file 8925 IEN value
"RTN","MAGDIR9E",44,0)
 ;
"RTN","MAGDIR9E",45,0)
 S ERRCODE=""
"RTN","MAGDIR9E",46,0)
 ;
"RTN","MAGDIR9E",47,0)
 I STUDYDAT,STUDYTIM D  ; get study date/time from image header
"RTN","MAGDIR9E",48,0)
 . S DATETIME=(STUDYDAT_"."_STUDYTIM)-17000000 ; FileMan date.time fmt
"RTN","MAGDIR9E",49,0)
 . Q
"RTN","MAGDIR9E",50,0)
 E  D  ; use current date/time
"RTN","MAGDIR9E",51,0)
 . N %,%H,%I,X
"RTN","MAGDIR9E",52,0)
 . D NOW^%DTC S DATETIME=%
"RTN","MAGDIR9E",53,0)
 . Q
"RTN","MAGDIR9E",54,0)
 ;
"RTN","MAGDIR9E",55,0)
 ; initialize FILEDATA for GROUP and IMAGE
"RTN","MAGDIR9E",56,0)
 ; get the acquisition device pointer (file 2005, field 107)
"RTN","MAGDIR9E",57,0)
 S ACQDEVP=$$ACQDEV^MAGDFCNV(MFGR,MODEL,INSTLOC)
"RTN","MAGDIR9E",58,0)
 S FILEDATA("ACQUISITION DEVICE")=ACQDEVP
"RTN","MAGDIR9E",59,0)
 ; get the SOP Class pointer (file 2005, field 251)
"RTN","MAGDIR9E",60,0)
 S SOPCLASP=$O(^MAG(2006.532,"B",SOPCLASS,""))
"RTN","MAGDIR9E",61,0)
 S FILEDATA("SOP CLASS POINTER")=SOPCLASP
"RTN","MAGDIR9E",62,0)
 ;
"RTN","MAGDIR9E",63,0)
 S MAGGP="" ; initialize pointer to the image group
"RTN","MAGDIR9E",64,0)
 ;
"RTN","MAGDIR9E",65,0)
 ; check if there already is a TIU note attached to this request
"RTN","MAGDIR9E",66,0)
 ;
"RTN","MAGDIR9E",67,0)
 S TIUIEN=$$TIULAST^MAGDGMRC(GMRCIEN)
"RTN","MAGDIR9E",68,0)
 I TIUIEN D  Q:ERRCODE ERRCODE ; there is TIU note already
"RTN","MAGDIR9E",69,0)
 . ; double check TIU note DFN to make sure that it matches
"RTN","MAGDIR9E",70,0)
 . N HIT ; scratch variable used in finding corresponding image group
"RTN","MAGDIR9E",71,0)
 . N TIUDFN ; DFN value from ^TIU for double checking
"RTN","MAGDIR9E",72,0)
 . N TIUXDIEN ; TIU External Data File IEN
"RTN","MAGDIR9E",73,0)
 . S TIUDFN=$P($G(^TIU(8925,TIUIEN,0)),"^",2)
"RTN","MAGDIR9E",74,0)
 . I TIUDFN'=DFN D  Q  ; fatal error
"RTN","MAGDIR9E",75,0)
 . . D TIUMISS^MAGDIRVE($T(+0),DFN,TIUIEN,TIUDFN)
"RTN","MAGDIR9E",76,0)
 . . S ERRCODE=-501
"RTN","MAGDIR9E",77,0)
 . . Q
"RTN","MAGDIR9E",78,0)
 . ;
"RTN","MAGDIR9E",79,0)
 . S FILEDATA("PARENT FILE")=8925 ; TIU file
"RTN","MAGDIR9E",80,0)
 . S FILEDATA("PARENT IEN")=TIUIEN
"RTN","MAGDIR9E",81,0)
 . ;
"RTN","MAGDIR9E",82,0)
 . ; is there an entry in TIU External Data File for this note
"RTN","MAGDIR9E",83,0)
 . S (HIT,TIUXDIEN)=0
"RTN","MAGDIR9E",84,0)
 . F  S TIUXDIEN=$O(^TIU(8925.91,"B",TIUIEN,TIUXDIEN)) Q:'TIUXDIEN  D  Q:HIT  Q:ERRCODE
"RTN","MAGDIR9E",85,0)
 . . N MAG2 ;----- data value for getting parent file attributes
"RTN","MAGDIR9E",86,0)
 . . N GROUPDFN ;- DFN value from image group entry for double checking
"RTN","MAGDIR9E",87,0)
 . . ; there is a TIU External Data File
"RTN","MAGDIR9E",88,0)
 . . ; does the TIU External Data File entry point to an image group?
"RTN","MAGDIR9E",89,0)
 . . S MAGGP=$$GET1^DIQ(8925.91,TIUXDIEN,.02,"I") Q:'MAGGP
"RTN","MAGDIR9E",90,0)
 . . ; double check image group entry DFN
"RTN","MAGDIR9E",91,0)
 . . S GROUPDFN=$P($G(^MAG(2005,MAGGP,0)),"^",7)
"RTN","MAGDIR9E",92,0)
 . . I GROUPDFN'=DFN D  Q  ; fatal error
"RTN","MAGDIR9E",93,0)
 . . . D MISMATCH^MAGDIRVE($T(+0),DFN,MAGGP)
"RTN","MAGDIR9E",94,0)
 . . . S ERRCODE=-502
"RTN","MAGDIR9E",95,0)
 . . . Q
"RTN","MAGDIR9E",96,0)
 . . I $P($G(^MAG(2005,MAGGP,0)),"^",6)'=11 D  Q  ; 11=XRAY GROUP
"RTN","MAGDIR9E",97,0)
 . . . S MAGGP="" ; wrong object type - skip this image group
"RTN","MAGDIR9E",98,0)
 . . . Q
"RTN","MAGDIR9E",99,0)
 . . S P=$P($G(^MAG(2005,MAGGP,"SOP")),"^",1)
"RTN","MAGDIR9E",100,0)
 . . ; skip this image group if wrong SOP Class
"RTN","MAGDIR9E",101,0)
 . . I '$$EQUIVGRP^MAGDFCNV(P,SOPCLASP) S MAGGP="" Q
"RTN","MAGDIR9E",102,0)
 . . ; add the new image to this existing image group
"RTN","MAGDIR9E",103,0)
 . . S HIT=1,MAG2=$G(^MAG(2005,MAGGP,2))
"RTN","MAGDIR9E",104,0)
 . . S FILEDATA("PARENT FILE")=$P(MAG2,"^",6)
"RTN","MAGDIR9E",105,0)
 . . S FILEDATA("PARENT IEN")=$P(MAG2,"^",7)
"RTN","MAGDIR9E",106,0)
 . . S FILEDATA("PARENT FILE PTR")=$P(MAG2,"^",8)
"RTN","MAGDIR9E",107,0)
 . . I FILEDATA("PARENT IEN")'=TIUIEN D  ; fatal error
"RTN","MAGDIR9E",108,0)
 . . . D TIUMISS2^MAGDIRVE($T(+0),TIUIEN,FILEDATA("PARENT IEN"),TIUXDIEN,MAGGP)
"RTN","MAGDIR9E",109,0)
 . . . S ERRCODE=-503
"RTN","MAGDIR9E",110,0)
 . . . Q
"RTN","MAGDIR9E",111,0)
 . . Q
"RTN","MAGDIR9E",112,0)
 . Q
"RTN","MAGDIR9E",113,0)
 ;
"RTN","MAGDIR9E",114,0)
 ; need a temporary association for the consult/procedure request
"RTN","MAGDIR9E",115,0)
 ;
"RTN","MAGDIR9E",116,0)
 E  D  Q:ERRCODE ERRCODE ; check if there is a temporary association
"RTN","MAGDIR9E",117,0)
 . ;
"RTN","MAGDIR9E",118,0)
 . ; Note: this algorithm creates multiple groups for a study,
"RTN","MAGDIR9E",119,0)
 . ;       for instance a GI fluoroscopy + color images
"RTN","MAGDIR9E",120,0)
 . ;
"RTN","MAGDIR9E",121,0)
 . S MAGGPP=""
"RTN","MAGDIR9E",122,0)
 . F  S MAGGPP=$O(^MAG(2006.5839,"C",123,GMRCIEN,MAGGPP)) Q:'MAGGPP  D  Q:ERRCODE
"RTN","MAGDIR9E",123,0)
 . . N GROUPDFN ; DFN value from image group entry for double checking
"RTN","MAGDIR9E",124,0)
 . . S MAGGP=$P(^MAG(2006.5839,MAGGPP,0),"^",3)
"RTN","MAGDIR9E",125,0)
 . . ; double check image group entry DFN in existing 2005 group node
"RTN","MAGDIR9E",126,0)
 . . S GROUPDFN=$P($G(^MAG(2005,MAGGP,0)),"^",7)
"RTN","MAGDIR9E",127,0)
 . . I GROUPDFN'=DFN D  ; fatal error
"RTN","MAGDIR9E",128,0)
 . . . D MISMATCH^MAGDIRVE($T(+0),DFN,MAGGP)
"RTN","MAGDIR9E",129,0)
 . . . S MAGGP="" ; bad group
"RTN","MAGDIR9E",130,0)
 . . . S ERRCODE=-504
"RTN","MAGDIR9E",131,0)
 . . . Q
"RTN","MAGDIR9E",132,0)
 . . E  S P=$P($G(^MAG(2005,MAGGP,100)),"^",4) I P,P'=ACQDEVP D  ; wrong device
"RTN","MAGDIR9E",133,0)
 . . . S MAGGP="" ; wrong acquisition device - skip this image group
"RTN","MAGDIR9E",134,0)
 . . . Q
"RTN","MAGDIR9E",135,0)
 . . E  D  ; add the new image to this existing image group
"RTN","MAGDIR9E",136,0)
 . . . N MAG2 ; data value for getting parent file attributes
"RTN","MAGDIR9E",137,0)
 . . . S MAG2=$G(^MAG(2005,MAGGP,2))
"RTN","MAGDIR9E",138,0)
 . . . S FILEDATA("PARENT FILE")=$P(MAG2,"^",6)
"RTN","MAGDIR9E",139,0)
 . . . S FILEDATA("PARENT IEN")=$P(MAG2,"^",7)
"RTN","MAGDIR9E",140,0)
 . . . S FILEDATA("PARENT FILE PTR")=$P(MAG2,"^",8) ; should be null
"RTN","MAGDIR9E",141,0)
 . . . I FILEDATA("PARENT FILE")'=2006.5839 D  ; fatal error
"RTN","MAGDIR9E",142,0)
 . . . . D TMPMISS^MAGDIRVE($T(+0),FILEDATA("PARENT FILE"),MAGGP)
"RTN","MAGDIR9E",143,0)
 . . . . S ERRCODE=-505
"RTN","MAGDIR9E",144,0)
 . . . . Q
"RTN","MAGDIR9E",145,0)
 . . . Q
"RTN","MAGDIR9E",146,0)
 . . Q
"RTN","MAGDIR9E",147,0)
 . ;
"RTN","MAGDIR9E",148,0)
 . I 'MAGGP  D  ; no group exists yet create a temporary association
"RTN","MAGDIR9E",149,0)
 . . S FILEDATA("PARENT FILE")=2006.5839 ; GMRC file
"RTN","MAGDIR9E",150,0)
 . . S FILEDATA("PARENT IEN")=GMRCIEN
"RTN","MAGDIR9E",151,0)
 . . Q
"RTN","MAGDIR9E",152,0)
 . Q
"RTN","MAGDIR9E",153,0)
 ;
"RTN","MAGDIR9E",154,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR9E",155,0)
 S FILEDATA("PACKAGE")="CONS"
"RTN","MAGDIR9E",156,0)
 ;
"RTN","MAGDIR9E",157,0)
 ; add the study to the Consult Unread List, if necessary
"RTN","MAGDIR9E",158,0)
 D ADD^MAGDTR03(.RESULT,GMRCIEN,"I",1) ; add if "on image" is set
"RTN","MAGDIR9E",159,0)
 ;
"RTN","MAGDIR9E",160,0)
 ; lookup study in ^GMR(123) and get FILEDATA variables
"RTN","MAGDIR9E",161,0)
 S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDIR9E",162,0)
 I SERVICE D
"RTN","MAGDIR9E",163,0)
 . N ISPECIDX,IPROCIDX,UNREAD,X,Y
"RTN","MAGDIR9E",164,0)
 . S UNREAD=$O(^MAG(2006.5849,"B",GMRCIEN,""))
"RTN","MAGDIR9E",165,0)
 . I UNREAD D  ; get indices from Unread List
"RTN","MAGDIR9E",166,0)
 . . S X=^MAG(2006.5849,UNREAD,0)
"RTN","MAGDIR9E",167,0)
 . . S ISPECIDX=$P(X,"^",3),IPROCIDX=$P(X,"^",4)
"RTN","MAGDIR9E",168,0)
 . . S FILEDATA("SPEC/SUBSPEC")=ISPECIDX
"RTN","MAGDIR9E",169,0)
 . . I "A"[$P(^MAG(2005.85,IPROCIDX,0),"^",3) D
"RTN","MAGDIR9E",170,0)
 . . . S FILEDATA("PROC/EVENT")=IPROCIDX
"RTN","MAGDIR9E",171,0)
 . . . Q
"RTN","MAGDIR9E",172,0)
 . . E  D  ; inactive index to procedure
"RTN","MAGDIR9E",173,0)
 . . . S X=$$FIELD43^MAGXMA(MODALITY,ISPECIDX,.Y)
"RTN","MAGDIR9E",174,0)
 . . . S FILEDATA("PROC/EVENT")=$S(X=0:Y,1:"")
"RTN","MAGDIR9E",175,0)
 . . . Q
"RTN","MAGDIR9E",176,0)
 . . Q
"RTN","MAGDIR9E",177,0)
 . E  I $D(^MAG(2006.5831,SERVICE,0)) D
"RTN","MAGDIR9E",178,0)
 . . S ISPECIDX=$P(^MAG(2006.5831,SERVICE,0),"^",2)
"RTN","MAGDIR9E",179,0)
 . . S X=$$FIELD43^MAGXMA(MODALITY,ISPECIDX,.Y)
"RTN","MAGDIR9E",180,0)
 . . S FILEDATA("PROC/EVENT")=$S(X=0:Y,1:"")
"RTN","MAGDIR9E",181,0)
 . . S FILEDATA("SPEC/SUBSPEC")=ISPECIDX
"RTN","MAGDIR9E",182,0)
 . . Q
"RTN","MAGDIR9E",183,0)
 . E  D  ; service was removed from ^MAG(2006.5831)
"RTN","MAGDIR9E",184,0)
 . . S FILEDATA("PROC/EVENT")=""
"RTN","MAGDIR9E",185,0)
 . . S FILEDATA("SPEC/SUBSPEC")=""
"RTN","MAGDIR9E",186,0)
 . . Q
"RTN","MAGDIR9E",187,0)
 . Q
"RTN","MAGDIR9E",188,0)
 E  D
"RTN","MAGDIR9E",189,0)
 . S FILEDATA("PROC/EVENT")=""
"RTN","MAGDIR9E",190,0)
 . S FILEDATA("SPEC/SUBSPEC")=""
"RTN","MAGDIR9E",191,0)
 . Q
"RTN","MAGDIR9E",192,0)
 ;
"RTN","MAGDIR9E",193,0)
 ; if the 2005 group node does not yet exist, create it
"RTN","MAGDIR9E",194,0)
 ;
"RTN","MAGDIR9E",195,0)
 I 'MAGGP D  Q:ERRCODE ERRCODE ; create the imaging group
"RTN","MAGDIR9E",196,0)
 . D NEWGROUP^MAGDIR9A("CON/PROC") Q:ERRCODE
"RTN","MAGDIR9E",197,0)
 . ;
"RTN","MAGDIR9E",198,0)
 . I FILEDATA("PARENT FILE")=8925 D  Q:ERRCODE  ; fix for ^TIU
"RTN","MAGDIR9E",199,0)
 . . S ERRCODE=$$TIUXLINK^MAGDIR9E()
"RTN","MAGDIR9E",200,0)
 . . Q
"RTN","MAGDIR9E",201,0)
 . E  I FILEDATA("PARENT FILE")=2006.5839 D  ; fix for ^GMR
"RTN","MAGDIR9E",202,0)
 . . L +^MAG(2006.5839)
"RTN","MAGDIR9E",203,0)
 . . I '$D(^MAG(2006.5839,0)) D
"RTN","MAGDIR9E",204,0)
 . . . S ^MAG(2006.5839,0)="DICOM GMRC TEMP LIST^^0^0"
"RTN","MAGDIR9E",205,0)
 . . . Q
"RTN","MAGDIR9E",206,0)
 . . S D0=$P(^MAG(2006.5839,0),"^",3)+1
"RTN","MAGDIR9E",207,0)
 . . S $P(^MAG(2006.5839,0),"^",3)=D0,$P(^(0),"^",4)=$P(^(0),"^",4)+1
"RTN","MAGDIR9E",208,0)
 . . L -^MAG(2006.5839)
"RTN","MAGDIR9E",209,0)
 . . S ^MAG(2006.5839,D0,0)="123^"_GMRCIEN_"^"_MAGGP
"RTN","MAGDIR9E",210,0)
 . . S ^MAG(2006.5839,"C",123,GMRCIEN,D0)=""
"RTN","MAGDIR9E",211,0)
 . . Q
"RTN","MAGDIR9E",212,0)
 . Q
"RTN","MAGDIR9E",213,0)
 ;
"RTN","MAGDIR9E",214,0)
 ; check for intra-oral x-ray images & get tooth number(s)
"RTN","MAGDIR9E",215,0)
 I IMAGNAME'="" S FILEDATA("SHORT DESCRIPTION")=IMAGNAME
"RTN","MAGDIR9E",216,0)
 ;
"RTN","MAGDIR9E",217,0)
 Q 0
"RTN","MAGDIR9E",218,0)
 ;
"RTN","MAGDIR9E",219,0)
TIUXLINK() ; create the cross-linkages to TIU EXTERNAL DATA LINK file
"RTN","MAGDIR9E",220,0)
 N TIUXDIEN
"RTN","MAGDIR9E",221,0)
 D PUTIMAGE^TIUSRVPL(.TIUXDIEN,TIUIEN,MAGGP)
"RTN","MAGDIR9E",222,0)
 I TIUXDIEN D
"RTN","MAGDIR9E",223,0)
 . S FILEDATA("PARENT FILE PTR")=TIUXDIEN
"RTN","MAGDIR9E",224,0)
 . S $P(^MAG(2005,MAGGP,2),"^",8)=TIUXDIEN
"RTN","MAGDIR9E",225,0)
 . Q
"RTN","MAGDIR9E",226,0)
 E  D  Q ERRCODE ; fatal error
"RTN","MAGDIR9E",227,0)
 . K MSG
"RTN","MAGDIR9E",228,0)
 . S MSG(1)="ERROR ASSOCIATING WITH TIU EXTERNAL DATA LINK (file 8925.91):"
"RTN","MAGDIR9E",229,0)
 . S MSG(2)=$P(TIUXDIEN,"^",2,999)
"RTN","MAGDIR9E",230,0)
 . D BADERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9E",231,0)
 . S ERRCODE=-508
"RTN","MAGDIR9E",232,0)
 . Q
"RTN","MAGDIR9E",233,0)
 Q 0
"RTN","MAGDIR9E",234,0)
 ;
"RTN","MAGDTR01")
0^6^B41301476
"RTN","MAGDTR01",1,0)
MAGDTR01 ;WOIFO/PMK - Unread List for Consult/Procedure Request ; 20 Sep 2006  9:04 AM
"RTN","MAGDTR01",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDTR01",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTR01",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR01",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTR01",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTR01",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTR01",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTR01",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTR01",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTR01",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTR01",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTR01",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTR01",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTR01",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTR01",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR01",17,0)
 ;;
"RTN","MAGDTR01",18,0)
ENTRY ; entry point from ^MAGDHWC for a consult request
"RTN","MAGDTR01",19,0)
 N GMRCSTS ;-- GMRC request status
"RTN","MAGDTR01",20,0)
 N RESULT ;--- scratch variable
"RTN","MAGDTR01",21,0)
 ;
"RTN","MAGDTR01",22,0)
 ; check for an "OK" order control value in the ORC segment
"RTN","MAGDTR01",23,0)
 I $P(HL7ORC,DEL)="OK" D  Q  ; new order
"RTN","MAGDTR01",24,0)
 . D ADD^MAGDTR03(.RESULT,GMRCIEN,"O") ; add if "on order" is set
"RTN","MAGDTR01",25,0)
 . Q
"RTN","MAGDTR01",26,0)
 ;
"RTN","MAGDTR01",27,0)
 ; check for a discontinued order
"RTN","MAGDTR01",28,0)
 I " CA CR DC DR OC OD "[(" "_$P(HL7ORC,DEL)_" ") D  Q
"RTN","MAGDTR01",29,0)
 . D CANCEL^MAGDTR03 ; record the order as cancelled
"RTN","MAGDTR01",30,0)
 . Q
"RTN","MAGDTR01",31,0)
 ;
"RTN","MAGDTR01",32,0)
 ; check for a FORWARD in the ORC segment
"RTN","MAGDTR01",33,0)
 I $P($P(HL7ORC,DEL,16),DEL2,5)="FORWARD" D  Q
"RTN","MAGDTR01",34,0)
 . D FORWARD^MAGDTR02 ; handle forward for Unread List
"RTN","MAGDTR01",35,0)
 . Q
"RTN","MAGDTR01",36,0)
 ;
"RTN","MAGDTR01",37,0)
 ; drive it off the GMRC request status
"RTN","MAGDTR01",38,0)
 S GMRCSTS=$$GET1^DIQ(123,GMRCIEN,8)
"RTN","MAGDTR01",39,0)
 I (GMRCSTS="PENDING")!(GMRCSTS="ACTIVE") D  Q
"RTN","MAGDTR01",40,0)
 . D ADD^MAGDTR03(.RESULT,GMRCIEN,"O") ; add if "on order" is set
"RTN","MAGDTR01",41,0)
 . Q
"RTN","MAGDTR01",42,0)
 I GMRCSTS="COMPLETE" D  Q
"RTN","MAGDTR01",43,0)
 . D COMPLETE^MAGDTR03 ; tag study as completed
"RTN","MAGDTR01",44,0)
 . Q
"RTN","MAGDTR01",45,0)
 I (GMRCSTS="CANCELLED")!(GMRCSTS="DISCONTINUED") D  Q
"RTN","MAGDTR01",46,0)
 . D CANCEL^MAGDTR03 ; tag study as cancelled
"RTN","MAGDTR01",47,0)
 . Q
"RTN","MAGDTR01",48,0)
 Q
"RTN","MAGDTR01",49,0)
 ;
"RTN","MAGDTR01",50,0)
ORRIN ; entry point for processing IFC responses
"RTN","MAGDTR01",51,0)
 N MAGETLVL,$ET
"RTN","MAGDTR01",52,0)
 S $ET="D ORRINER1^"_$T(+0),MAGETLVL=$ST+1
"RTN","MAGDTR01",53,0)
 D ORRINPRC
"RTN","MAGDTR01",54,0)
 Q
"RTN","MAGDTR01",55,0)
 ;
"RTN","MAGDTR01",56,0)
ORRINER1 ; Log the error
"RTN","MAGDTR01",57,0)
 D ^%ZTER
"RTN","MAGDTR01",58,0)
 S $ET="D ORRINER2^"_$T(+0)
"RTN","MAGDTR01",59,0)
 I $ST>MAGETLVL Q:$Q "" Q
"RTN","MAGDTR01",60,0)
 S $EC=""
"RTN","MAGDTR01",61,0)
 Q
"RTN","MAGDTR01",62,0)
 ;
"RTN","MAGDTR01",63,0)
ORRINER2 ; Unwind
"RTN","MAGDTR01",64,0)
 I $ST>MAGETLVL Q:$Q "" Q
"RTN","MAGDTR01",65,0)
 S $EC=""
"RTN","MAGDTR01",66,0)
 Q
"RTN","MAGDTR01",67,0)
 ;
"RTN","MAGDTR01",68,0)
ORRINPRC ;
"RTN","MAGDTR01",69,0)
 ; this is "piggy-backed" onto the GMRC IFC ORM EVENT protocol
"RTN","MAGDTR01",70,0)
 ; see the RESPONSE PROCESSING ROUTINE for this protocol
"RTN","MAGDTR01",71,0)
 ; the HL7 event handler first invokes ORRIN^GMRCIMSG and then this
"RTN","MAGDTR01",72,0)
 ;
"RTN","MAGDTR01",73,0)
 N GMRCIEN ;-- IEN of consult
"RTN","MAGDTR01",74,0)
 N ORDCTRL ;-- order control code from ORC segment
"RTN","MAGDTR01",75,0)
 N UNREAD ;--- IEN of entry on ^MAG(2006.5849)
"RTN","MAGDTR01",76,0)
 N TIMESTMP ;- FileMan time stamp of unread item
"RTN","MAGDTR01",77,0)
 N LISTDATA ;- unread list info from ^MAG(2006.5849)
"RTN","MAGDTR01",78,0)
 N ACQSITE ;-- acquisition site
"RTN","MAGDTR01",79,0)
 N IPROCIDX ;- procedure index
"RTN","MAGDTR01",80,0)
 N ISPECIDX ;- specialty index
"RTN","MAGDTR01",81,0)
 ;
"RTN","MAGDTR01",82,0)
 D GETHL7A^MAGDTR01(.ORDCTRL,.GMRCIEN) Q:ORDCTRL'="OK"
"RTN","MAGDTR01",83,0)
 Q:'$$FINDLIST^MAGDTR01(GMRCIEN)  ; not in unread list
"RTN","MAGDTR01",84,0)
 S UNREAD=$$UNREAD^MAGDTR02(GMRCIEN) Q:'UNREAD   ; not there yet
"RTN","MAGDTR01",85,0)
 S TIMESTMP=$$TIMESTMP^MAGDTR02(UNREAD) ; update the timestamp
"RTN","MAGDTR01",86,0)
 S LISTDATA=^MAG(2006.5849,UNREAD,0)
"RTN","MAGDTR01",87,0)
 ; record time of IFC response
"RTN","MAGDTR01",88,0)
 S:$P(LISTDATA,"^",6)="" $P(^MAG(2006.5849,UNREAD,0),"^",6)=TIMESTMP
"RTN","MAGDTR01",89,0)
 ; now change status to "Unread", if it was a "Waiting" previously
"RTN","MAGDTR01",90,0)
 I $P(LISTDATA,"^",11)="W" D  ; switch status and update cross reference
"RTN","MAGDTR01",91,0)
 . S $P(^MAG(2006.5849,UNREAD,0),"^",11)="U"
"RTN","MAGDTR01",92,0)
 . S ACQSITE=$P(LISTDATA,"^",2),ISPECIDX=$P(LISTDATA,"^",3)
"RTN","MAGDTR01",93,0)
 . S IPROCIDX=$P(LISTDATA,"^",4)
"RTN","MAGDTR01",94,0)
 . K ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,"W",UNREAD)
"RTN","MAGDTR01",95,0)
 . S ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,"U",UNREAD)=""
"RTN","MAGDTR01",96,0)
 . Q
"RTN","MAGDTR01",97,0)
 Q
"RTN","MAGDTR01",98,0)
 ;
"RTN","MAGDTR01",99,0)
GETHL7A(STATUS,GMRCIEN) ; get data from HL7 message - called from above
"RTN","MAGDTR01",100,0)
 ; input:  none
"RTN","MAGDTR01",101,0)
 ; output:  PERSON     name of person ordering the consult
"RTN","MAGDTR01",102,0)
 ;          LOCATION   IEN of the location from which the consult is ordered
"RTN","MAGDTR01",103,0)
 ;
"RTN","MAGDTR01",104,0)
 N HL7PARSE ;- name of parsed HL7 array defined by GETHL7
"RTN","MAGDTR01",105,0)
 N HL7RAW ;--- name of raw HL7 array defined by GETHL7
"RTN","MAGDTR01",106,0)
 N HL7SEGNO ;- segment number index returned by $$GETSEG^MAGDHRC0
"RTN","MAGDTR01",107,0)
 ;
"RTN","MAGDTR01",108,0)
 D GETHL7
"RTN","MAGDTR01",109,0)
 S (STATUS,GMRCIEN)=""
"RTN","MAGDTR01",110,0)
 S HL7SEGNO=$$GETSEG^MAGDHRC0("ORC")
"RTN","MAGDTR01",111,0)
 I HL7SEGNO D
"RTN","MAGDTR01",112,0)
 . S STATUS=$$GETDATA^MAGDHRC0(1)
"RTN","MAGDTR01",113,0)
 . S GMRCIEN=$$GETDATA^MAGDHRC0(2,1,1)
"RTN","MAGDTR01",114,0)
 . Q
"RTN","MAGDTR01",115,0)
 K @HL7PARSE
"RTN","MAGDTR01",116,0)
 Q
"RTN","MAGDTR01",117,0)
 ;
"RTN","MAGDTR01",118,0)
GETHL7B(PERSON,LOCATION) ; get data from HL7 message - call from ^MAGDTR03
"RTN","MAGDTR01",119,0)
 ; input:  none
"RTN","MAGDTR01",120,0)
 ; output:  PERSON     name of person ordering the consult
"RTN","MAGDTR01",121,0)
 ;          LOCATION   IEN of the location from which the consult is ordered
"RTN","MAGDTR01",122,0)
 ;
"RTN","MAGDTR01",123,0)
 N HL7PARSE ;- name of parsed HL7 array defined by GETHL7
"RTN","MAGDTR01",124,0)
 N HL7RAW ;--- name of raw HL7 array defined by GETHL7
"RTN","MAGDTR01",125,0)
 N HL7SEGNO ;- segment number index returned by $$GETSEG^MAGDHRC0
"RTN","MAGDTR01",126,0)
 N IPERSON ;-- field number in ORC segment that contains responsible/entered-by person
"RTN","MAGDTR01",127,0)
 ;
"RTN","MAGDTR01",128,0)
 D GETHL7
"RTN","MAGDTR01",129,0)
 K PERSON S LOCATION=""
"RTN","MAGDTR01",130,0)
 S HL7SEGNO=$$GETSEG^MAGDHRC0("ORC")
"RTN","MAGDTR01",131,0)
 ; get "responsible person" from ORC-12 or "entered by" person from ORC-10
"RTN","MAGDTR01",132,0)
 S IPERSON=$S($$GETDATA^MAGDHRC0(12)="":10,1:12)
"RTN","MAGDTR01",133,0)
 S PERSON("FAMILY")=$$GETDATA^MAGDHRC0(IPERSON,1,1)
"RTN","MAGDTR01",134,0)
 S PERSON("GIVEN")=$$GETDATA^MAGDHRC0(IPERSON,1,2)
"RTN","MAGDTR01",135,0)
 S PERSON("MIDDLE")=$$GETDATA^MAGDHRC0(IPERSON,1,3)
"RTN","MAGDTR01",136,0)
 S PERSON("SUFFIX")=$$GETDATA^MAGDHRC0(IPERSON,1,4)
"RTN","MAGDTR01",137,0)
 S PERSON=PERSON("FAMILY")
"RTN","MAGDTR01",138,0)
 I PERSON("GIVEN")'="" S PERSON=PERSON_","_PERSON("GIVEN")
"RTN","MAGDTR01",139,0)
 I PERSON("MIDDLE")'="" S PERSON=PERSON_" "_PERSON("MIDDLE")
"RTN","MAGDTR01",140,0)
 I PERSON("SUFFIX")'="" S PERSON=PERSON_" "_PERSON("SUFFIX")
"RTN","MAGDTR01",141,0)
 ; location of the consult is in OBX-5.3(?)
"RTN","MAGDTR01",142,0)
 S HL7SEGNO=$$GETSEG^MAGDHRC0("OBX")
"RTN","MAGDTR01",143,0)
 S:HL7SEGNO LOCATION=$$IEN^XUAF4($$GETDATA^MAGDHRC0(5,1,3))
"RTN","MAGDTR01",144,0)
 K @HL7PARSE
"RTN","MAGDTR01",145,0)
 Q
"RTN","MAGDTR01",146,0)
 ;
"RTN","MAGDTR01",147,0)
GETHL7 ; get data from HL7 message
"RTN","MAGDTR01",148,0)
 ; called from above and also called from ^MAGDTR03
"RTN","MAGDTR01",149,0)
 ;
"RTN","MAGDTR01",150,0)
 ; returns: HL7PARSE (name of parsed HL7 array)
"RTN","MAGDTR01",151,0)
 ;          HL7RAW   (name of array of unparsed HL7 segments)
"RTN","MAGDTR01",152,0)
 ;
"RTN","MAGDTR01",153,0)
 N HLNODE ;--- a full HL7 segment returned by X HLNEXT
"RTN","MAGDTR01",154,0)
 N I ;-------- scratch array index
"RTN","MAGDTR01",155,0)
 N X ;-------- dummy status return from $$PARSE^MAG7UP
"RTN","MAGDTR01",156,0)
 ;
"RTN","MAGDTR01",157,0)
 S HL7PARSE=$NAME(^TMP("MAG",$J,"HL7","PARSED"))
"RTN","MAGDTR01",158,0)
 S HL7RAW="HL7RAW"
"RTN","MAGDTR01",159,0)
 K @HL7PARSE ; initialize the destination global
"RTN","MAGDTR01",160,0)
 ; copy HL7 message from ^TMP to HL7RAW global array
"RTN","MAGDTR01",161,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  S @HL7RAW@(I)=HLNODE
"RTN","MAGDTR01",162,0)
 S X=$$PARSE^MAG7UP(HL7RAW,HL7PARSE) ; build the parsed HL7 array
"RTN","MAGDTR01",163,0)
 Q
"RTN","MAGDTR01",164,0)
 ;
"RTN","MAGDTR01",165,0)
FINDLIST(GMRCIEN,ISPECIDX,IPROCIDX,ACQSITE,TRIGGER,TIUNOTE,ALTSERV) ;
"RTN","MAGDTR01",166,0)
 ; find the read/unread list for this consult
"RTN","MAGDTR01",167,0)
 N CONSPROC,PROC,TOSERV,X,XREF
"RTN","MAGDTR01",168,0)
 S (ISPECIDX,IPROCIDX,ACQSITE,TRIGGER,TIUNOTE)=""
"RTN","MAGDTR01",169,0)
 Q:'$G(GMRCIEN) 0
"RTN","MAGDTR01",170,0)
 S TOSERV=$G(ALTSERV) ; optional argument
"RTN","MAGDTR01",171,0)
 I TOSERV="" S TOSERV=+$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDTR01",172,0)
 S CONSPROC=$$GET1^DIQ(123,GMRCIEN,13,"I")
"RTN","MAGDTR01",173,0)
 S PROC=$S(CONSPROC="C":"",1:$$GET1^DIQ(123,GMRCIEN,4,"I"))
"RTN","MAGDTR01",174,0)
 S XREF=$O(^MAG(2006.5841,"AC",TOSERV,+PROC,""))
"RTN","MAGDTR01",175,0)
 I 'XREF Q 0 ; no read/unread list
"RTN","MAGDTR01",176,0)
 S X=$G(^MAG(2006.5841,XREF,0))
"RTN","MAGDTR01",177,0)
 S ISPECIDX=$P(X,"^",3),IPROCIDX=$P(X,"^",4),ACQSITE=$P(X,"^",5)
"RTN","MAGDTR01",178,0)
 S TRIGGER=$P(X,"^",6),TIUNOTE=$P(X,"^",7)
"RTN","MAGDTR01",179,0)
 Q XREF
"RTN","MAGDTR01",180,0)
 ;
"RTN","MAGDTR02")
0^7^B34387376
"RTN","MAGDTR02",1,0)
MAGDTR02 ;WOIFO/PMK - Unread List for Consult/Procedure Request ; 10 Oct 2006  11:01 AM
"RTN","MAGDTR02",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDTR02",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTR02",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR02",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTR02",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTR02",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTR02",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTR02",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTR02",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTR02",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTR02",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTR02",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTR02",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTR02",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTR02",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR02",17,0)
 ;;
"RTN","MAGDTR02",18,0)
FORWARD ; entry point from ^MAGDT01 for a FORWARD request
"RTN","MAGDTR02",19,0)
 N FWDFROM ;-- forwarded from service
"RTN","MAGDTR02",20,0)
 N ISPECIDX ;- index to specialties - read/unread list sort key
"RTN","MAGDTR02",21,0)
 N IPROCIDX ;- index to procedures - read/unread list sort key (may be null)
"RTN","MAGDTR02",22,0)
 N LISTDATA ;- read/unread list data
"RTN","MAGDTR02",23,0)
 N UNREAD ;--- pointer to an entry in the read/unread list
"RTN","MAGDTR02",24,0)
 N OUNREAD,NUNREAD ; old and new unread list dictionary pointers
"RTN","MAGDTR02",25,0)
 N OACQSITE,NACQSITE ; old and new unread list acquisition sites
"RTN","MAGDTR02",26,0)
 N OPROCIDX,NPROCIDX ; old and new unread list procedure indexes
"RTN","MAGDTR02",27,0)
 N OSPECIDX,NSPECIDX ; old and new unread list specialty indexes
"RTN","MAGDTR02",28,0)
 N NEWENTRY ; - pointer to new entry in unread list
"RTN","MAGDTR02",29,0)
 N I,X
"RTN","MAGDTR02",30,0)
 ;
"RTN","MAGDTR02",31,0)
 ; get previous service from REQUEST PROCESSING ACTIVITY
"RTN","MAGDTR02",32,0)
 S FWDFROM=$$FWDFROM^MAGDGMRC(GMRCIEN) ; FORWARDED FROM service
"RTN","MAGDTR02",33,0)
 S OUNREAD=$$FINDLIST^MAGDTR01(GMRCIEN,.OSPECIDX,.OPROCIDX,.OACQSITE,,,FWDFROM)
"RTN","MAGDTR02",34,0)
 S NUNREAD=$$FINDLIST^MAGDTR01(GMRCIEN,.NSPECIDX,.NPROCIDX,.NACQSITE)
"RTN","MAGDTR02",35,0)
 ;
"RTN","MAGDTR02",36,0)
 I 'OUNREAD,'NUNREAD Q  ; neither old nor new TO SERVICE have unread lists
"RTN","MAGDTR02",37,0)
 ;
"RTN","MAGDTR02",38,0)
 I 'OUNREAD,NUNREAD D  Q  ; only new TO SERVICE has an unread list
"RTN","MAGDTR02",39,0)
 . N D0,IMAGECNT,MAGIEN,TRIGGER
"RTN","MAGDTR02",40,0)
 . S IMAGECNT=0
"RTN","MAGDTR02",41,0)
 . ; count the number of images, if any
"RTN","MAGDTR02",42,0)
 . S D0="" F  S D0=$O(^MAG(2006.5839,"C",123,GMRCIEN,D0)) Q:'D0  D
"RTN","MAGDTR02",43,0)
 . . S MAGIEN=$P($G(^MAG(2006.5839,D0,0)),"^",3)
"RTN","MAGDTR02",44,0)
 . . I MAGIEN D  ; make sure you got a good group pointer
"RTN","MAGDTR02",45,0)
 . . . ; get #images from Object Group file (2005.04)
"RTN","MAGDTR02",46,0)
 . . . S IMAGECNT=IMAGECNT+$P($G(^MAG(2005,MAGIEN,1,0)),"^",4)
"RTN","MAGDTR02",47,0)
 . . . Q
"RTN","MAGDTR02",48,0)
 . . Q
"RTN","MAGDTR02",49,0)
 . S TRIGGER=$S(IMAGECNT:"I",1:"")_"OF"
"RTN","MAGDTR02",50,0)
 . ; create the new unread list entry
"RTN","MAGDTR02",51,0)
 . D ADD^MAGDTR03(.NEWENTRY,GMRCIEN,TRIGGER,IMAGECNT)
"RTN","MAGDTR02",52,0)
 . Q
"RTN","MAGDTR02",53,0)
 ;
"RTN","MAGDTR02",54,0)
 I OUNREAD,'NUNREAD D  Q  ; only old TO SERVICE has an unread list
"RTN","MAGDTR02",55,0)
 . S UNREAD=$$UNREAD^MAGDTR02(GMRCIEN)
"RTN","MAGDTR02",56,0)
 . S X=$$STATUPDT^MAGDTR02(UNREAD,"D") ; set status of old entry to DELETE
"RTN","MAGDTR02",57,0)
 . Q
"RTN","MAGDTR02",58,0)
 ;
"RTN","MAGDTR02",59,0)
 ; both the old TO SERVICE and the new TO SERVICE have unread lists
"RTN","MAGDTR02",60,0)
 ; 
"RTN","MAGDTR02",61,0)
 ; are the old and new unread lists the same?
"RTN","MAGDTR02",62,0)
 ;
"RTN","MAGDTR02",63,0)
 S UNREAD=$$UNREAD^MAGDTR02(GMRCIEN)
"RTN","MAGDTR02",64,0)
 I OACQSITE=NACQSITE,OSPECIDX=NSPECIDX,OPROCIDX=NPROCIDX D  Q
"RTN","MAGDTR02",65,0)
 . ; exactly the same unread lists for old and new TO SERVICES
"RTN","MAGDTR02",66,0)
 . I UNREAD S X=$$TIMESTMP^MAGDTR02(UNREAD) ; update the timestamp
"RTN","MAGDTR02",67,0)
 . Q
"RTN","MAGDTR02",68,0)
 ;
"RTN","MAGDTR02",69,0)
 ; different unread lists for old and new TO SERVICES
"RTN","MAGDTR02",70,0)
 ;
"RTN","MAGDTR02",71,0)
 ; is there an old unread list?
"RTN","MAGDTR02",72,0)
 S LISTDATA=$S(UNREAD:$G(^MAG(2006.5849,UNREAD,0)),1:"")
"RTN","MAGDTR02",73,0)
 I LISTDATA="" D  Q  ; no old unread list
"RTN","MAGDTR02",74,0)
 . D ADD^MAGDTR03(.NEWENTRY,GMRCIEN,"OF") ; create the new unread list entry
"RTN","MAGDTR02",75,0)
 . Q
"RTN","MAGDTR02",76,0)
 ;
"RTN","MAGDTR02",77,0)
 ; there is an old unread list entry
"RTN","MAGDTR02",78,0)
 ; create the new unread list and copy the data from the old unread list entry
"RTN","MAGDTR02",79,0)
 S X=$$STATUPDT^MAGDTR02(UNREAD,"D")
"RTN","MAGDTR02",80,0)
 D ADD^MAGDTR03(.NEWENTRY,GMRCIEN,"IOF") Q:'NEWENTRY  ; create the new unread list entry
"RTN","MAGDTR02",81,0)
 F I=7,8,10 D  ; copy acquisition start, next acquisition, and number of images
"RTN","MAGDTR02",82,0)
 . S $P(^MAG(2006.5849,NEWENTRY,0),"^",I)=$P(^MAG(2006.5849,UNREAD,0),"^",I)
"RTN","MAGDTR02",83,0)
 . Q
"RTN","MAGDTR02",84,0)
 Q
"RTN","MAGDTR02",85,0)
 ;
"RTN","MAGDTR02",86,0)
 ;
"RTN","MAGDTR02",87,0)
 ; common functions
"RTN","MAGDTR02",88,0)
 ;
"RTN","MAGDTR02",89,0)
UNREAD(GMRCIEN) ; look up unread list internal entry number
"RTN","MAGDTR02",90,0)
 N HIT,LISTDATA,UNREAD,STATUS
"RTN","MAGDTR02",91,0)
 Q:'$G(GMRCIEN) ""
"RTN","MAGDTR02",92,0)
 S UNREAD="",HIT=0
"RTN","MAGDTR02",93,0)
 F  S UNREAD=$O(^MAG(2006.5849,"B",GMRCIEN,UNREAD)) Q:'UNREAD  D  Q:HIT
"RTN","MAGDTR02",94,0)
 . S LISTDATA=$G(^MAG(2006.5849,UNREAD,0))
"RTN","MAGDTR02",95,0)
 . S STATUS=$P(LISTDATA,"^",11)
"RTN","MAGDTR02",96,0)
 . I STATUS'="D" S HIT=1 ; ignore deleted entries
"RTN","MAGDTR02",97,0)
 . Q
"RTN","MAGDTR02",98,0)
 Q UNREAD
"RTN","MAGDTR02",99,0)
 ;
"RTN","MAGDTR02",100,0)
STATUPDT(UNREAD,STATUS) ; update the status
"RTN","MAGDTR02",101,0)
 N ACQSITE,IPROCIDX,ISPECIDX,OSTATUS,LISTDATA,TIMESTMP
"RTN","MAGDTR02",102,0)
 S TIMESTMP=0
"RTN","MAGDTR02",103,0)
 I $G(UNREAD),$G(STATUS)'="",$D(^MAG(2006.5849,UNREAD,0)) D
"RTN","MAGDTR02",104,0)
 . S LISTDATA=$G(^MAG(2006.5849,UNREAD,0))
"RTN","MAGDTR02",105,0)
 . S ACQSITE=$P(LISTDATA,"^",2) Q:ACQSITE=""
"RTN","MAGDTR02",106,0)
 . S ISPECIDX=$P(LISTDATA,"^",3) Q:ISPECIDX=""
"RTN","MAGDTR02",107,0)
 . S IPROCIDX=$P(LISTDATA,"^",4) Q:IPROCIDX=""
"RTN","MAGDTR02",108,0)
 . S OSTATUS=$P(LISTDATA,"^",11) Q:OSTATUS=""
"RTN","MAGDTR02",109,0)
 . K ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,OSTATUS,UNREAD)
"RTN","MAGDTR02",110,0)
 . S $P(^MAG(2006.5849,UNREAD,0),"^",11)=STATUS
"RTN","MAGDTR02",111,0)
 . S ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,STATUS,UNREAD)=""
"RTN","MAGDTR02",112,0)
 . S TIMESTMP=$$TIMESTMP^MAGDTR02(UNREAD) ; update time stamp piece of last activity
"RTN","MAGDTR02",113,0)
 . Q
"RTN","MAGDTR02",114,0)
 Q TIMESTMP
"RTN","MAGDTR02",115,0)
 ; 
"RTN","MAGDTR02",116,0)
TIMESTMP(UNREAD) ; update the transaction's timestamp and cross-reference
"RTN","MAGDTR02",117,0)
 N ACQSITE ;-- acquisition site
"RTN","MAGDTR02",118,0)
 N NEWTIME ;-- time stamp of the current transaction
"RTN","MAGDTR02",119,0)
 N OLDTIME ;-- time stamp of the previous transaction
"RTN","MAGDTR02",120,0)
 N LISTDATA ;- read/unread list data
"RTN","MAGDTR02",121,0)
 N ISPECIDX ;- index to specialties - read/unread list sort key
"RTN","MAGDTR02",122,0)
 N IPROCIDX ;- index to procedures - read/unread list sort key (may be null)
"RTN","MAGDTR02",123,0)
 N %,%H,%I
"RTN","MAGDTR02",124,0)
 Q:'$G(UNREAD) ""
"RTN","MAGDTR02",125,0)
 D NOW^%DTC S NEWTIME=%
"RTN","MAGDTR02",126,0)
 L +^MAG(2006.5849,UNREAD):1E9
"RTN","MAGDTR02",127,0)
 S LISTDATA=^MAG(2006.5849,UNREAD,0)
"RTN","MAGDTR02",128,0)
 S ACQSITE=$P(LISTDATA,"^",2) I ACQSITE="" Q 0
"RTN","MAGDTR02",129,0)
 S ISPECIDX=$P(LISTDATA,"^",3) I ISPECIDX="" Q 0
"RTN","MAGDTR02",130,0)
 S IPROCIDX=$P(LISTDATA,"^",4) I IPROCIDX="" Q 0
"RTN","MAGDTR02",131,0)
 S OLDTIME=$P(LISTDATA,"^",9)
"RTN","MAGDTR02",132,0)
 I ACQSITE'="",ISPECIDX'="",IPROCIDX'="" D
"RTN","MAGDTR02",133,0)
 . K:OLDTIME ^MAG(2006.5849,"AC",ACQSITE,ISPECIDX,IPROCIDX,OLDTIME,UNREAD)
"RTN","MAGDTR02",134,0)
 . S ^MAG(2006.5849,"AC",ACQSITE,ISPECIDX,IPROCIDX,NEWTIME,UNREAD)=""
"RTN","MAGDTR02",135,0)
 . Q
"RTN","MAGDTR02",136,0)
 S $P(^MAG(2006.5849,UNREAD,0),"^",9)=NEWTIME
"RTN","MAGDTR02",137,0)
 L -^MAG(2006.5849,UNREAD)
"RTN","MAGDTR02",138,0)
 Q NEWTIME
"RTN","MAGDTR03")
0^8^B74996162
"RTN","MAGDTR03",1,0)
MAGDTR03 ;WOIFO/PMK - Read a DICOM image file ; 20 Nov 2006  2:46 PM
"RTN","MAGDTR03",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDTR03",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTR03",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR03",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTR03",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTR03",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTR03",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTR03",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTR03",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTR03",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTR03",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTR03",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTR03",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTR03",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTR03",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR03",17,0)
 ;;
"RTN","MAGDTR03",18,0)
 ;
"RTN","MAGDTR03",19,0)
ADD(OUT,GMRCIEN,EVENT,IMAGECNT) ; add an entry to the read/unread list
"RTN","MAGDTR03",20,0)
 N ACQSITE ;-- the site where the images were acquired
"RTN","MAGDTR03",21,0)
 N IFCIEN ;--- the IEN of the IFC consult at the reading site
"RTN","MAGDTR03",22,0)
 N IFCSITE ;-- 0 if not IFC
"RTN","MAGDTR03",23,0)
 N ISPECIDX ;- index to specialties - read/unread list sort key
"RTN","MAGDTR03",24,0)
 N IPROCIDX ;- index to procedures - read/unread list sort key (may be null)
"RTN","MAGDTR03",25,0)
 N STATUS ;--- status of unread list entry (Unread or Waiting)
"RTN","MAGDTR03",26,0)
 N TIMESTMP ;- FM date/time
"RTN","MAGDTR03",27,0)
 N TRIGGER ;-- create unread list trigger: Forward, Image, or Order
"RTN","MAGDTR03",28,0)
 N UNREAD ;-- pointer to entry in unread list
"RTN","MAGDTR03",29,0)
 N X
"RTN","MAGDTR03",30,0)
 ; should this consult be added to the Unread List?
"RTN","MAGDTR03",31,0)
 S OUT=0 ; return variable
"RTN","MAGDTR03",32,0)
 Q:$G(EVENT)=""  ; nope, an event F, I, or O must be specified
"RTN","MAGDTR03",33,0)
 Q:$$FINDLIST^MAGDTR01(GMRCIEN,.ISPECIDX,.IPROCIDX,.ACQSITE,.TRIGGER)<1
"RTN","MAGDTR03",34,0)
 S IMAGECNT=+$G(IMAGECNT) ; count of images
"RTN","MAGDTR03",35,0)
 ;
"RTN","MAGDTR03",36,0)
 S UNREAD=$$UNREAD^MAGDTR02(GMRCIEN)
"RTN","MAGDTR03",37,0)
 I UNREAD="",EVENT'[TRIGGER Q  ; nope, don't create it now
"RTN","MAGDTR03",38,0)
 ;
"RTN","MAGDTR03",39,0)
 ; get IFC information
"RTN","MAGDTR03",40,0)
 S IFCSITE=$$GET1^DIQ(123,GMRCIEN,.07,"I") ; Routing Facility
"RTN","MAGDTR03",41,0)
 S IFCIEN=$$GET1^DIQ(123,GMRCIEN,.06,"I") ; remote consult file entry
"RTN","MAGDTR03",42,0)
 ;
"RTN","MAGDTR03",43,0)
 I UNREAD="" D  ; add record to the unread list
"RTN","MAGDTR03",44,0)
 . N X
"RTN","MAGDTR03",45,0)
 . L +^MAG(2006.5849,0):1E9 ; serial generation
"RTN","MAGDTR03",46,0)
 . S UNREAD=$O(^MAG(2006.5849," "),-1)+1 ; get next IEN
"RTN","MAGDTR03",47,0)
 . L +^MAG(2006.5849,UNREAD):1E9
"RTN","MAGDTR03",48,0)
 . S X=$G(^MAG(2006.5849,0))
"RTN","MAGDTR03",49,0)
 . S X="TELEREADER READ/UNREAD LIST^2006.5849^"_UNREAD_"^"_($P(X,"^",4)+1)
"RTN","MAGDTR03",50,0)
 . S ^MAG(2006.5849,0)=X
"RTN","MAGDTR03",51,0)
 . S ^MAG(2006.5849,UNREAD,0)=GMRCIEN_"^"_ACQSITE_"^"_ISPECIDX_"^"_IPROCIDX
"RTN","MAGDTR03",52,0)
 . L -^MAG(2006.5849,0) ; end serial generation
"RTN","MAGDTR03",53,0)
 . S TIMESTMP=$$TIMESTMP^MAGDTR02(UNREAD)
"RTN","MAGDTR03",54,0)
 . S $P(^MAG(2006.5849,UNREAD,0),"^",7)=TIMESTMP ; acquisition start d/t
"RTN","MAGDTR03",55,0)
 . S ^MAG(2006.5849,"B",GMRCIEN,UNREAD)=""
"RTN","MAGDTR03",56,0)
 . ;
"RTN","MAGDTR03",57,0)
 . ; set status -- if unpaired IFC, status="Waiting", otherwise "Unread"
"RTN","MAGDTR03",58,0)
 . S STATUS=$S(IFCSITE&'IFCIEN:"W",1:"U")
"RTN","MAGDTR03",59,0)
 . S $P(^MAG(2006.5849,UNREAD,0),"^",11)=STATUS
"RTN","MAGDTR03",60,0)
 . S ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,STATUS,UNREAD)=""
"RTN","MAGDTR03",61,0)
 . L -^MAG(2006.5849,UNREAD)
"RTN","MAGDTR03",62,0)
 . Q
"RTN","MAGDTR03",63,0)
 E  D
"RTN","MAGDTR03",64,0)
 . S TIMESTMP=$$TIMESTMP^MAGDTR02(UNREAD) ; update d/t piece of last activity
"RTN","MAGDTR03",65,0)
 . Q
"RTN","MAGDTR03",66,0)
 ;
"RTN","MAGDTR03",67,0)
 I IFCSITE D  ; record the IFC remote site times, if they are not set
"RTN","MAGDTR03",68,0)
 . ; save time the entry is added to the unread list, if not set
"RTN","MAGDTR03",69,0)
 . I $P($G(^MAG(2006.5849,UNREAD,0)),"^",5)="" S $P(^(0),"^",5)=TIMESTMP
"RTN","MAGDTR03",70,0)
 . I IFCIEN D
"RTN","MAGDTR03",71,0)
 . . ; IFC remote consult already created - save same time, if not set
"RTN","MAGDTR03",72,0)
 . . I $P($G(^MAG(2006.5849,UNREAD,0)),"^",6)="" S $P(^(0),"^",6)=TIMESTMP
"RTN","MAGDTR03",73,0)
 . . Q
"RTN","MAGDTR03",74,0)
 . Q
"RTN","MAGDTR03",75,0)
 ;
"RTN","MAGDTR03",76,0)
 I IMAGECNT D
"RTN","MAGDTR03",77,0)
 . S $P(^MAG(2006.5849,UNREAD,0),"^",8)=TIMESTMP ; last acquisition d/t
"RTN","MAGDTR03",78,0)
 . S $P(^(0),"^",10)=$P(^MAG(2006.5849,UNREAD,0),"^",10)+IMAGECNT
"RTN","MAGDTR03",79,0)
 . Q
"RTN","MAGDTR03",80,0)
 ;
"RTN","MAGDTR03",81,0)
 S OUT=UNREAD
"RTN","MAGDTR03",82,0)
 Q
"RTN","MAGDTR03",83,0)
 ;
"RTN","MAGDTR03",84,0)
COMPLETE ; entry point from ^MAGDTR01 & ^MAGDTRLU for COMPLETED consults
"RTN","MAGDTR03",85,0)
 N LOCATION,MAGPTR,TIMESTMP,UNREAD
"RTN","MAGDTR03",86,0)
 S UNREAD=$$UNREAD^MAGDTR02(GMRCIEN)
"RTN","MAGDTR03",87,0)
 S TIMESTMP=$$STATUPDT^MAGDTR02(UNREAD,"R")
"RTN","MAGDTR03",88,0)
 I TIMESTMP D  ; changed status to Resulted
"RTN","MAGDTR03",89,0)
 . D FINISH ; record who updated the consult
"RTN","MAGDTR03",90,0)
 . ; check if there is an image
"RTN","MAGDTR03",91,0)
 . S MAGPTR=$O(^MAG(2006.5839,"C",123,GMRCIEN,0))
"RTN","MAGDTR03",92,0)
 . I MAGPTR,'$$TIULAST^MAGDGMRC(GMRCIEN) D
"RTN","MAGDTR03",93,0)
 . . ; there is an image but no TIU note
"RTN","MAGDTR03",94,0)
 . . D TIUNOTE ; create a TIU note for the image
"RTN","MAGDTR03",95,0)
 . . Q
"RTN","MAGDTR03",96,0)
 . Q
"RTN","MAGDTR03",97,0)
 Q
"RTN","MAGDTR03",98,0)
 ;
"RTN","MAGDTR03",99,0)
CANCEL ; entry point from ^MAGDTR01 & ^MAGDTRLU for CANCELLED consults
"RTN","MAGDTR03",100,0)
 N TIMESTMP,UNREAD
"RTN","MAGDTR03",101,0)
 S UNREAD=$$UNREAD^MAGDTR02(GMRCIEN)
"RTN","MAGDTR03",102,0)
 S TIMESTMP=$$STATUPDT^MAGDTR02(UNREAD,"C")
"RTN","MAGDTR03",103,0)
 I TIMESTMP D  ; changed status to Cancelled
"RTN","MAGDTR03",104,0)
 . ; remove any old data about the reading activities
"RTN","MAGDTR03",105,0)
 . S $P(^MAG(2006.5849,UNREAD,0),"^",12,16)="^^^^"
"RTN","MAGDTR03",106,0)
 . D FINISH ; record who cancelled the consult
"RTN","MAGDTR03",107,0)
 . Q
"RTN","MAGDTR03",108,0)
 Q
"RTN","MAGDTR03",109,0)
 ;
"RTN","MAGDTR03",110,0)
FINISH ; finalize resulted or cancelled consult
"RTN","MAGDTR03",111,0)
 N DUZACQ,FULLNAME,INITIALS,LOCKNAME,X
"RTN","MAGDTR03",112,0)
 ; record who resulted or cancelled the consult
"RTN","MAGDTR03",113,0)
 ;
"RTN","MAGDTR03",114,0)
 I $G(MODE)="REPAIR" G REPAIR ; set in ^MAGDTRLU
"RTN","MAGDTR03",115,0)
 ;
"RTN","MAGDTR03",116,0)
 ; process the transaction
"RTN","MAGDTR03",117,0)
 I $D(HLNEXT) D  ; IFC - data comes from HL7 message
"RTN","MAGDTR03",118,0)
 . D GETHL7B^MAGDTR01(.FULLNAME,.LOCATION)
"RTN","MAGDTR03",119,0)
 . ; if resulter is not the person who locked the study, update name
"RTN","MAGDTR03",120,0)
 . S LOCKNAME=$P(^MAG(2006.5849,UNREAD,0),"^",12)
"RTN","MAGDTR03",121,0)
 . I LOCKNAME'=FULLNAME,FULLNAME'="" D  ; not the same person, update
"RTN","MAGDTR03",122,0)
 . . ; look up resulter in file 200 - check for >1 people with same name
"RTN","MAGDTR03",123,0)
 . . S DUZACQ=$O(^VA(200,"B",FULLNAME,""))
"RTN","MAGDTR03",124,0)
 . . I DUZACQ,$O(^VA(200,"B",FULLNAME,DUZACQ)) S DUZACQ="" ; same name
"RTN","MAGDTR03",125,0)
 . . S INITIALS=$$GET1^DIQ(200,DUZACQ,1) ; initial
"RTN","MAGDTR03",126,0)
 . . ; DUZread (piece 4) is not known - set to null
"RTN","MAGDTR03",127,0)
 . . S X=FULLNAME_"^"_INITIALS_"^"_DUZACQ_"^^"_LOCATION
"RTN","MAGDTR03",128,0)
 . . S $P(^MAG(2006.5849,UNREAD,0),"^",12,16)=X ; reader identification
"RTN","MAGDTR03",129,0)
 . . Q
"RTN","MAGDTR03",130,0)
 . Q
"RTN","MAGDTR03",131,0)
 E  D  ; local consult - FULLNAME array is for IFCs only
"RTN","MAGDTR03",132,0)
 . ; record the id of the resulter - DUZ comes from RPC session
"RTN","MAGDTR03",133,0)
 . ; assumes that the results were entered directly, not via IFC/HL7
"RTN","MAGDTR03",134,0)
 . S FULLNAME=$$GET1^DIQ(200,DUZ,.01)
"RTN","MAGDTR03",135,0)
 . S INITIALS=$$GET1^DIQ(200,DUZ,1) ; initial
"RTN","MAGDTR03",136,0)
 . S X=FULLNAME_"^"_INITIALS_"^"_DUZ_"^"_DUZ_"^"_DUZ(2) ; DUZacq=DUZread
"RTN","MAGDTR03",137,0)
 . S $P(^MAG(2006.5849,UNREAD,0),"^",12,16)=X ; reader identification
"RTN","MAGDTR03",138,0)
 . Q
"RTN","MAGDTR03",139,0)
 ;
"RTN","MAGDTR03",140,0)
 D EXREF(UNREAD,TIMESTMP) ; set "E" cross-reference
"RTN","MAGDTR03",141,0)
 Q
"RTN","MAGDTR03",142,0)
 ;
"RTN","MAGDTR03",143,0)
EXREF(UNREAD,TIMESTMP) ; set cancellation or reading stop date/time and "E" cross-reference
"RTN","MAGDTR03",144,0)
 N ACQSITE ;-- acquisition site
"RTN","MAGDTR03",145,0)
 N LISTDATA ;- read/unread list data
"RTN","MAGDTR03",146,0)
 Q:UNREAD=""  Q:TIMESTMP=""
"RTN","MAGDTR03",147,0)
 S LISTDATA=^MAG(2006.5849,UNREAD,0)
"RTN","MAGDTR03",148,0)
 S ACQSITE=$P(LISTDATA,"^",2) Q:ACQSITE=""
"RTN","MAGDTR03",149,0)
 S $P(^MAG(2006.5849,UNREAD,0),"^",18)=TIMESTMP
"RTN","MAGDTR03",150,0)
 S ^MAG(2006.5849,"E",ACQSITE,TIMESTMP\1,UNREAD)=""
"RTN","MAGDTR03",151,0)
 Q
"RTN","MAGDTR03",152,0)
 ;
"RTN","MAGDTR03",153,0)
REPAIR ; code to repair a defective unread list entry
"RTN","MAGDTR03",154,0)
 N ACTIVITY,DUZACQ,FULLNAME,HIT,I,IFCSITE,INITIALS,LOCATION,SUBFILE,TIMESTMP
"RTN","MAGDTR03",155,0)
 S IFCSITE=$$GET1^DIQ(123,GMRCIEN,.07,"I") ; routing facility
"RTN","MAGDTR03",156,0)
 ;
"RTN","MAGDTR03",157,0)
 ; first find the consult request tracking "completion" activity in cprs 
"RTN","MAGDTR03",158,0)
 S HIT=0 F I=1:1 D  Q:HIT  Q:ACTIVITY=""
"RTN","MAGDTR03",159,0)
 . S SUBFILE=I_","_GMRCIEN ; format: <subfile ien>,<gmrc ien>
"RTN","MAGDTR03",160,0)
 . S ACTIVITY=$$GET1^DIQ(123.02,SUBFILE,1) ; activity - from ^GMR(123.1)
"RTN","MAGDTR03",161,0)
 . I ACTIVITY="COMPLETE/UPDATE" S HIT=1
"RTN","MAGDTR03",162,0)
 . E  I ACTIVITY="CANCELLED" S HIT=2
"RTN","MAGDTR03",163,0)
 . E  I ACTIVITY="DISCONTINUED" S HIT=3
"RTN","MAGDTR03",164,0)
 . Q
"RTN","MAGDTR03",165,0)
 I 'HIT S SUBFILE=(I-1)_","_GMRCIEN ; use the last entry
"RTN","MAGDTR03",166,0)
 ;
"RTN","MAGDTR03",167,0)
 ; now make the corrections
"RTN","MAGDTR03",168,0)
 S TIMESTMP=$$GET1^DIQ(123.02,SUBFILE,2,"I") ; date/time of actual activity
"RTN","MAGDTR03",169,0)
 S DUZACQ=$$GET1^DIQ(123.02,SUBFILE,3,"I") ; who's responsible for activity
"RTN","MAGDTR03",170,0)
 I DUZACQ D  ; action was perfomed locally
"RTN","MAGDTR03",171,0)
 . S FULLNAME=$$GET1^DIQ(200,DUZACQ,.01) ; name
"RTN","MAGDTR03",172,0)
 . S INITIALS=$$GET1^DIQ(200,DUZACQ,1) ; initials
"RTN","MAGDTR03",173,0)
 . S LOCATION=ACQSITE
"RTN","MAGDTR03",174,0)
 . S X=FULLNAME_"^"_INITIALS_"^"_DUZACQ_"^"_DUZACQ_"^"_ACQSITE ; DUZacq=DUZread
"RTN","MAGDTR03",175,0)
 . Q
"RTN","MAGDTR03",176,0)
 E  I IFCSITE D  ; remotely completed IFC
"RTN","MAGDTR03",177,0)
 . S FULLNAME=$$GET1^DIQ(123.02,SUBFILE,.22) ; remote responsible person
"RTN","MAGDTR03",178,0)
 . ; look up resulter in file 200 - check for >1 people with same name
"RTN","MAGDTR03",179,0)
 . S DUZACQ=$O(^VA(200,"B",FULLNAME,""))
"RTN","MAGDTR03",180,0)
 . I DUZACQ,$O(^VA(200,"B",FULLNAME,DUZACQ)) S DUZACQ="" ; same name
"RTN","MAGDTR03",181,0)
 . S INITIALS=$$GET1^DIQ(200,DUZACQ,1) ; initials
"RTN","MAGDTR03",182,0)
 . ; DUZread (piece 4) is not known - set to null
"RTN","MAGDTR03",183,0)
 . S X=FULLNAME_"^"_INITIALS_"^"_DUZACQ_"^^"_IFCSITE
"RTN","MAGDTR03",184,0)
 . Q
"RTN","MAGDTR03",185,0)
 E  S X="^^^^" ; problem with cprs consult
"RTN","MAGDTR03",186,0)
 S $P(^MAG(2006.5849,UNREAD,0),"^",12,16)=X ; reader identification
"RTN","MAGDTR03",187,0)
 N % D NOW^%DTC S $P(^MAG(2006.5849,UNREAD,0),"^",19)=% ; Record Repair TimeStamp in piece 19 Field #18
"RTN","MAGDTR03",188,0)
 D EXREF(UNREAD,TIMESTMP) ; set "E" cross-reference
"RTN","MAGDTR03",189,0)
 Q
"RTN","MAGDTR03",190,0)
 ;
"RTN","MAGDTR03",191,0)
TIUNOTE ; create a TIU result note, if one is not present
"RTN","MAGDTR03",192,0)
 N DUZ ; this is called by the HL7 - DUZ and DUZ(2) are not set
"RTN","MAGDTR03",193,0)
 N MAGDFN,MAGTEXT,MAGTITLE,UNREAD,XECUTE,ZZ
"RTN","MAGDTR03",194,0)
 Q:'$D(HLNEXT)  ; only create TIU result note for IFCs
"RTN","MAGDTR03",195,0)
 Q:'$$FINDLIST^MAGDTR01(GMRCIEN,,,,,.MAGTITLE)
"RTN","MAGDTR03",196,0)
 S UNREAD=$$UNREAD^MAGDTR02(GMRCIEN) Q:'UNREAD
"RTN","MAGDTR03",197,0)
 S MAGTEXT(1)="Please refer to Inter-facility Consult for results."
"RTN","MAGDTR03",198,0)
 S MAGTEXT(2)=""
"RTN","MAGDTR03",199,0)
 S MAGTEXT(3)="Automatically generated note - signature not required."
"RTN","MAGDTR03",200,0)
 S DUZ=$P(^MAG(2006.5849,UNREAD,0),"^",14) Q:'DUZ  ; get DUZacq
"RTN","MAGDTR03",201,0)
 S DUZ(0)="@",DUZ(2)=LOCATION ; get reading site ien
"RTN","MAGDTR03",202,0)
 S MAGDFN=$$GET1^DIQ(123,GMRCIEN,.02,"I")
"RTN","MAGDTR03",203,0)
 D NEW^MAGGNTI1(.ZZ,MAGDFN,MAGTITLE,1,"E",,DUZ,,,GMRCIEN,.MAGTEXT)
"RTN","MAGDTR03",204,0)
 Q
"RTN","MAGDTR03",205,0)
 ;
"RTN","MAGDTR04")
0^9^B21144013
"RTN","MAGDTR04",1,0)
MAGDTR04 ;WOIFO/PMK - Read a DICOM image file ; 13 Feb 2007  11:36 AM
"RTN","MAGDTR04",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDTR04",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTR04",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR04",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTR04",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTR04",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTR04",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTR04",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTR04",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTR04",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTR04",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTR04",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTR04",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTR04",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTR04",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR04",17,0)
 ;;
"RTN","MAGDTR04",18,0)
LOCK(RETURN,UNREAD,LOCKFLAG,FULLNAME,INITIALS,DUZACQ,DUZREAD,DUZREAD2) ; RPC = MAG DICOM CON UNREADLIST LOCK
"RTN","MAGDTR04",19,0)
 N ACQSITE,LISTDATA,IPROCIDX,ISPECIDX,STATUS,X
"RTN","MAGDTR04",20,0)
 S DUZACQ=DUZ ; DUZ at the acquisition site is the DUZ for the RPC
"RTN","MAGDTR04",21,0)
 S STATUS=""
"RTN","MAGDTR04",22,0)
 ;
"RTN","MAGDTR04",23,0)
 I '$G(UNREAD) D
"RTN","MAGDTR04",24,0)
 . S RETURN="-1|No UNREAD parameter set"
"RTN","MAGDTR04",25,0)
 . Q
"RTN","MAGDTR04",26,0)
 ;
"RTN","MAGDTR04",27,0)
 E  I '$D(^MAG(2006.5849,UNREAD,0)) D
"RTN","MAGDTR04",28,0)
 . S RETURN="-2|UNREAD parameter wrong -- ^MAG(2006.5849,"_UNREAD_",0) is undefined"
"RTN","MAGDTR04",29,0)
 . Q
"RTN","MAGDTR04",30,0)
 ;
"RTN","MAGDTR04",31,0)
 E  D  ; try to lock or unlock the study
"RTN","MAGDTR04",32,0)
 . S LISTDATA=^MAG(2006.5849,UNREAD,0)
"RTN","MAGDTR04",33,0)
 . S ACQSITE=$P(LISTDATA,"^",2),ISPECIDX=$P(LISTDATA,"^",3)
"RTN","MAGDTR04",34,0)
 . S IPROCIDX=$P(LISTDATA,"^",4),STATUS=$P(LISTDATA,"^",11)
"RTN","MAGDTR04",35,0)
 . I $G(LOCKFLAG) D  ; try to lock the study
"RTN","MAGDTR04",36,0)
 . . I STATUS="U" D
"RTN","MAGDTR04",37,0)
 . . . S (STATUS,$P(^MAG(2006.5849,UNREAD,0),"^",11))="L"
"RTN","MAGDTR04",38,0)
 . . . K ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,"U",UNREAD)
"RTN","MAGDTR04",39,0)
 . . . S ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,"L",UNREAD)=""
"RTN","MAGDTR04",40,0)
 . . . S X=FULLNAME_"^"_INITIALS_"^"_DUZACQ_"^"_DUZREAD_"^"_DUZREAD2
"RTN","MAGDTR04",41,0)
 . . . S $P(^MAG(2006.5849,UNREAD,0),"^",12,16)=X ; reader identification
"RTN","MAGDTR04",42,0)
 . . . S X=$$TIMESTMP^MAGDTR02(UNREAD) ; update time stamp piece of last activity
"RTN","MAGDTR04",43,0)
 . . . S $P(^MAG(2006.5849,UNREAD,0),"^",17,18)=X_"^" ; start reading timestamp
"RTN","MAGDTR04",44,0)
 . . . S RETURN="0|Successful Lock"
"RTN","MAGDTR04",45,0)
 . . . Q
"RTN","MAGDTR04",46,0)
 . . E  I STATUS="L" D
"RTN","MAGDTR04",47,0)
 . . . I $P(^MAG(2006.5849,UNREAD,0),"^",12)=FULLNAME D
"RTN","MAGDTR04",48,0)
 . . . . S RETURN="1|Already locked by same user"
"RTN","MAGDTR04",49,0)
 . . . . Q
"RTN","MAGDTR04",50,0)
 . . . E  D
"RTN","MAGDTR04",51,0)
 . . . . S RETURN="-3|Already locked by a different user"
"RTN","MAGDTR04",52,0)
 . . . . Q
"RTN","MAGDTR04",53,0)
 . . . Q
"RTN","MAGDTR04",54,0)
 . . E  I STATUS?1"R".E D
"RTN","MAGDTR04",55,0)
 . . . S RETURN="-4|Already resulted and can't be locked"
"RTN","MAGDTR04",56,0)
 . . . Q
"RTN","MAGDTR04",57,0)
 . . E  I STATUS?1"C".E D
"RTN","MAGDTR04",58,0)
 . . . S RETURN="-5|Already cancelled and can't be locked"
"RTN","MAGDTR04",59,0)
 . . . Q
"RTN","MAGDTR04",60,0)
 . . E  I STATUS?1"W".E D
"RTN","MAGDTR04",61,0)
 . . . S RETURN="-6|Waiting and can't be locked"
"RTN","MAGDTR04",62,0)
 . . . Q
"RTN","MAGDTR04",63,0)
 . . E  D
"RTN","MAGDTR04",64,0)
 . . . S RETURN="-7|Can't be locked because of Unknown Status"
"RTN","MAGDTR04",65,0)
 . . . Q
"RTN","MAGDTR04",66,0)
 . . Q
"RTN","MAGDTR04",67,0)
 . ;
"RTN","MAGDTR04",68,0)
 . E  D  ; try to unlock the study
"RTN","MAGDTR04",69,0)
 . . I STATUS="L" D
"RTN","MAGDTR04",70,0)
 . . . I $P(^MAG(2006.5849,UNREAD,0),"^",12)=FULLNAME D
"RTN","MAGDTR04",71,0)
 . . . . D UNLOCK(UNREAD,.STATUS)
"RTN","MAGDTR04",72,0)
 . . . . S RETURN="0|Successful Unlock"
"RTN","MAGDTR04",73,0)
 . . . . Q
"RTN","MAGDTR04",74,0)
 . . . E  D
"RTN","MAGDTR04",75,0)
 . . . . S RETURN="-8|Locked by different user, can't be unlocked"
"RTN","MAGDTR04",76,0)
 . . . . Q
"RTN","MAGDTR04",77,0)
 . . . Q
"RTN","MAGDTR04",78,0)
 . . E  I STATUS="U" D
"RTN","MAGDTR04",79,0)
 . . . S RETURN="2|Already unlocked"
"RTN","MAGDTR04",80,0)
 . . . Q
"RTN","MAGDTR04",81,0)
 . . E  I STATUS?1"R".E D
"RTN","MAGDTR04",82,0)
 . . . S RETURN="-9|Already resulted and can't be unlocked"
"RTN","MAGDTR04",83,0)
 . . . Q
"RTN","MAGDTR04",84,0)
 . . E  I STATUS?1"C".E D
"RTN","MAGDTR04",85,0)
 . . . S RETURN="-10|Already cancelled and can't be unlocked"
"RTN","MAGDTR04",86,0)
 . . . Q
"RTN","MAGDTR04",87,0)
 . . E  I STATUS?1"W".E D
"RTN","MAGDTR04",88,0)
 . . . S RETURN="-11|Waiting and can't be unlocked"
"RTN","MAGDTR04",89,0)
 . . . Q
"RTN","MAGDTR04",90,0)
 . . E  D
"RTN","MAGDTR04",91,0)
 . . . S RETURN="-12|Can't be unlocked because of Unknown Status"
"RTN","MAGDTR04",92,0)
 . . . Q
"RTN","MAGDTR04",93,0)
 . . Q
"RTN","MAGDTR04",94,0)
 . Q
"RTN","MAGDTR04",95,0)
 S RETURN=RETURN_"|"_STATUS
"RTN","MAGDTR04",96,0)
 Q
"RTN","MAGDTR04",97,0)
 ;
"RTN","MAGDTR04",98,0)
UNLOCK(UNREAD,STATUS) ; unlock the study - called by ^MAGDTR06
"RTN","MAGDTR04",99,0)
 N ACQSITE,LISTDATA,IPROCIDX,ISPECIDX,X
"RTN","MAGDTR04",100,0)
 S LISTDATA=^MAG(2006.5849,UNREAD,0)
"RTN","MAGDTR04",101,0)
 S ACQSITE=$P(LISTDATA,"^",2),ISPECIDX=$P(LISTDATA,"^",3)
"RTN","MAGDTR04",102,0)
 S IPROCIDX=$P(LISTDATA,"^",4)
"RTN","MAGDTR04",103,0)
 S (STATUS,$P(^MAG(2006.5849,UNREAD,0),"^",11))="U"
"RTN","MAGDTR04",104,0)
 K ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,"L",UNREAD)
"RTN","MAGDTR04",105,0)
 S ^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,"U",UNREAD)=""
"RTN","MAGDTR04",106,0)
 S X=$$TIMESTMP^MAGDTR02(UNREAD) ; update time stamp piece of last activity
"RTN","MAGDTR04",107,0)
 S $P(^MAG(2006.5849,UNREAD,0),"^",12,18)="^^^^^^"
"RTN","MAGDTR04",108,0)
 Q
"RTN","MAGDTR05")
0^10^B47917279
"RTN","MAGDTR05",1,0)
MAGDTR05 ;WOIFO/PMK - Read a DICOM image file ; 14 Nov 2006  6:24 AM
"RTN","MAGDTR05",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDTR05",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTR05",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR05",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTR05",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTR05",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTR05",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTR05",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTR05",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTR05",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTR05",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTR05",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTR05",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTR05",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTR05",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR05",17,0)
 ;;
"RTN","MAGDTR05",18,0)
LOOKUP(OUT,SITENUMB,ISPECIDX,IPROCS,STARTING,DUZREAD,DUZREAD2,LOCKTIME,STATLIST) ; RPC = MAG DICOM CON UNREADLIST GET
"RTN","MAGDTR05",19,0)
 ; entry point to lookup entries in file
"RTN","MAGDTR05",20,0)
 ; 
"RTN","MAGDTR05",21,0)
 ; OUT ------- Return array
"RTN","MAGDTR05",22,0)
 ; SITENUMB -- Acquisition Site Number
"RTN","MAGDTR05",23,0)
 ; ISPECIDX -- Index to Specialties (2005.84)
"RTN","MAGDTR05",24,0)
 ; IPROCS ---- Indexes to Procedures (2005.85) - this is a comma-delimited list
"RTN","MAGDTR05",25,0)
 ; STARTING -- Fileman date/time to begin sequential search
"RTN","MAGDTR05",26,0)
 ; DUZREAD --- User's DUZ at the Reading Site
"RTN","MAGDTR05",27,0)
 ; DUZREAD2 -- DIC(4) pointer to Reading Site
"RTN","MAGDTR05",28,0)
 ; LOCKTIME -- timeout value for LOCKTIME
"RTN","MAGDTR05",29,0)
 ; STATLIST -- status of entry (C, L, R, U, or W, in any combination)
"RTN","MAGDTR05",30,0)
 ; 
"RTN","MAGDTR05",31,0)
 N ACQSITE ;- site index in Unread List
"RTN","MAGDTR05",32,0)
 N ISTATUS ;-- counter to the status in STATLIST
"RTN","MAGDTR05",33,0)
 N IPROC ;---- counter to IPROCS
"RTN","MAGDTR05",34,0)
 N IPROCIDX ;- index to procedures (2005.85)
"RTN","MAGDTR05",35,0)
 N TIMESTMP ;- last activity date/time for the entry
"RTN","MAGDTR05",36,0)
 N SITENAME ;- name of acquisition site
"RTN","MAGDTR05",37,0)
 N STATUS1 ;-- one status out of the STATLIST
"RTN","MAGDTR05",38,0)
 N UNREAD ;--- pointer to entry in unread list
"RTN","MAGDTR05",39,0)
 ;
"RTN","MAGDTR05",40,0)
 S DUZREAD=$G(DUZREAD,0),DUZREAD2=$G(DUZREAD2,0),LOCKTIME=$G(LOCKTIME,0)
"RTN","MAGDTR05",41,0)
 S STATLIST=$$UP^MAGDFCNV($G(STATLIST))
"RTN","MAGDTR05",42,0)
 I STATLIST="" S STATLIST="CDLRUW" ; default to all STATUS values
"RTN","MAGDTR05",43,0)
 ;
"RTN","MAGDTR05",44,0)
 S ACQSITE=$$ACQSITE^MAGDTR06(SITENUMB)
"RTN","MAGDTR05",45,0)
 I ACQSITE<0  S OUT="-1, ACQUISITION SITE #"_SITENUMB_" IS NOT DEFINED IN FILE 4" Q
"RTN","MAGDTR05",46,0)
 S SITENAME=$P(ACQSITE,"^",2),ACQSITE=$P(ACQSITE,"^",1)
"RTN","MAGDTR05",47,0)
 ;
"RTN","MAGDTR05",48,0)
 I LOCKTIME,DUZREAD2 D UNLOCKER ; automatically unlock timed out studies
"RTN","MAGDTR05",49,0)
 ;
"RTN","MAGDTR05",50,0)
 K OUT
"RTN","MAGDTR05",51,0)
 I STARTING=0 D  ; loop through the STATUS index because it is faster
"RTN","MAGDTR05",52,0)
 . S STATLIST=$TR(STATLIST,"D") ; remove the DELETED status from STATLIST
"RTN","MAGDTR05",53,0)
 . F ISTATUS=1:1:$L(STATLIST) S STATUS1=$E(STATLIST,ISTATUS) D
"RTN","MAGDTR05",54,0)
 . . F IPROC=1:1:$L(IPROCS,",") S IPROCIDX=$P(IPROCS,",",IPROC) D
"RTN","MAGDTR05",55,0)
 . . . S UNREAD=""
"RTN","MAGDTR05",56,0)
 . . . F  S UNREAD=$O(^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,STATUS1,UNREAD)) Q:UNREAD=""  D
"RTN","MAGDTR05",57,0)
 . . . . D LOOKUP1(UNREAD)
"RTN","MAGDTR05",58,0)
 . . . . Q
"RTN","MAGDTR05",59,0)
 . . . Q
"RTN","MAGDTR05",60,0)
 . . Q
"RTN","MAGDTR05",61,0)
 . Q
"RTN","MAGDTR05",62,0)
 E  D  ; retrieve just the latest events
"RTN","MAGDTR05",63,0)
 . F IPROC=1:1:$L(IPROCS,",") S IPROCIDX=$P(IPROCS,",",IPROC) D
"RTN","MAGDTR05",64,0)
 . . S TIMESTMP=STARTING ; reinitialize the starting date & time for each index to procedures
"RTN","MAGDTR05",65,0)
 . . F  S TIMESTMP=$O(^MAG(2006.5849,"AC",ACQSITE,ISPECIDX,IPROCIDX,TIMESTMP)) Q:TIMESTMP=""  D
"RTN","MAGDTR05",66,0)
 . . . S UNREAD=""
"RTN","MAGDTR05",67,0)
 . . . F  S UNREAD=$O(^MAG(2006.5849,"AC",ACQSITE,ISPECIDX,IPROCIDX,TIMESTMP,UNREAD)) Q:UNREAD=""  D
"RTN","MAGDTR05",68,0)
 . . . . D LOOKUP1(UNREAD)
"RTN","MAGDTR05",69,0)
 . . . . Q
"RTN","MAGDTR05",70,0)
 . . . Q
"RTN","MAGDTR05",71,0)
 . . Q
"RTN","MAGDTR05",72,0)
 . Q
"RTN","MAGDTR05",73,0)
 Q
"RTN","MAGDTR05",74,0)
 ;
"RTN","MAGDTR05",75,0)
LOOKUP1(UNREAD) ; retrieve one entry from the unread list
"RTN","MAGDTR05",76,0)
 N GMRCIEN
"RTN","MAGDTR05",77,0)
 N DFN
"RTN","MAGDTR05",78,0)
 N VADM
"RTN","MAGDTR05",79,0)
 N ICN
"RTN","MAGDTR05",80,0)
 N IFCSITE,IFCIEN,IFCSITEA,IFCRTIME,IFCLTIME,IFCETIME
"RTN","MAGDTR05",81,0)
 N LISTDATA ;- read/unread list data
"RTN","MAGDTR05",82,0)
 N QUIT
"RTN","MAGDTR05",83,0)
 N READER
"RTN","MAGDTR05",84,0)
 N SHORTID
"RTN","MAGDTR05",85,0)
 N STATUS
"RTN","MAGDTR05",86,0)
 N VA,VADM,VAERR
"RTN","MAGDTR05",87,0)
 N VIPSTS ; VIP status
"RTN","MAGDTR05",88,0)
 N I,LAST,X,Z
"RTN","MAGDTR05",89,0)
 ;
"RTN","MAGDTR05",90,0)
 S LISTDATA=$G(^MAG(2006.5849,UNREAD,0))
"RTN","MAGDTR05",91,0)
 S STATUS=$P(LISTDATA,"^",11) ; status
"RTN","MAGDTR05",92,0)
 Q:STATLIST'[STATUS  ; skip the entry if it is not the right STATUS
"RTN","MAGDTR05",93,0)
 ;
"RTN","MAGDTR05",94,0)
 S GMRCIEN=$P(LISTDATA,"^",1)
"RTN","MAGDTR05",95,0)
 S IFCSITE=$$GET1^DIQ(123,GMRCIEN,.07,"I") ; Routing Facility
"RTN","MAGDTR05",96,0)
 ;
"RTN","MAGDTR05",97,0)
 ; check if this consult can it be displayed to the reader
"RTN","MAGDTR05",98,0)
 S QUIT=0
"RTN","MAGDTR05",99,0)
 I DUZREAD D  Q:QUIT
"RTN","MAGDTR05",100,0)
 . I IFCSITE D  Q:QUIT  ; IFC reading site
"RTN","MAGDTR05",101,0)
 . . I IFCSITE'=DUZREAD2 S QUIT=1
"RTN","MAGDTR05",102,0)
 . . Q
"RTN","MAGDTR05",103,0)
 . I STATUS="W" S QUIT=2 Q
"RTN","MAGDTR05",104,0)
 . I STATUS="L" D  Q:QUIT
"RTN","MAGDTR05",105,0)
 . . S READER=$P(LISTDATA,"^",15) ; reader
"RTN","MAGDTR05",106,0)
 . . I READER,READER'=DUZREAD S QUIT=3
"RTN","MAGDTR05",107,0)
 . . Q
"RTN","MAGDTR05",108,0)
 . Q
"RTN","MAGDTR05",109,0)
 ;
"RTN","MAGDTR05",110,0)
 ; acquisition site identification
"RTN","MAGDTR05",111,0)
 S Z=UNREAD_"|"_GMRCIEN_"|"_SITENUMB_"|"_SITENAME
"RTN","MAGDTR05",112,0)
 ; patient information
"RTN","MAGDTR05",113,0)
 S DFN=$$GET1^DIQ(123,GMRCIEN,.02,"I")
"RTN","MAGDTR05",114,0)
 D DEM^VADPT,PTSEC^DGSEC4(.VIPSTS,DFN)
"RTN","MAGDTR05",115,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MAGDTR05",116,0)
 S X=$P(VADM(2),"^",1),SHORTID=$E(VADM(1),1)_$E(X,$L(X)-3,$L(X))
"RTN","MAGDTR05",117,0)
 S Z=Z_"|"_VADM(1)_"|"_$P(VADM(2),"^",2)_"|"_ICN_"|"_SHORTID
"RTN","MAGDTR05",118,0)
 S Z=Z_"|"_VIPSTS(1) ; VIP status
"RTN","MAGDTR05",119,0)
 S Z=Z_"|"_$P(^MAG(2005.84,ISPECIDX,0),"^",1)_"|"_$P(^MAG(2005.84,ISPECIDX,2),"^",1)
"RTN","MAGDTR05",120,0)
 S Z=Z_"|"_$P(^MAG(2005.85,IPROCIDX,0),"^",1)_"|"_$P(^MAG(2005.85,IPROCIDX,2),"^",1)
"RTN","MAGDTR05",121,0)
 ; time stamps and image acquisition statistics
"RTN","MAGDTR05",122,0)
 S Z=Z_"|"_$P(LISTDATA,"^",7) ; time of first image
"RTN","MAGDTR05",123,0)
 S Z=Z_"|"_$P(LISTDATA,"^",8) ; time of last image
"RTN","MAGDTR05",124,0)
 S Z=Z_"|"_$P(LISTDATA,"^",9) ; time of last activity
"RTN","MAGDTR05",125,0)
 S Z=Z_"|"_(+$P(LISTDATA,"^",10)) ; #images
"RTN","MAGDTR05",126,0)
 S Z=Z_"|"_STATUS
"RTN","MAGDTR05",127,0)
 S Z=Z_"|"_$$GET1^DIQ(123,GMRCIEN,13,"I") ; consult/procedure flag
"RTN","MAGDTR05",128,0)
 S Z=Z_"|"_$P($$GET1^DIQ(123,GMRCIEN,5)," - ",2) ; GMRC urgency
"RTN","MAGDTR05",129,0)
 ;
"RTN","MAGDTR05",130,0)
 ; get inter-facility consult data
"RTN","MAGDTR05",131,0)
 S IFCSITE=$$GET1^DIQ(123,GMRCIEN,.07,"I") ; Routing Facility
"RTN","MAGDTR05",132,0)
 I IFCSITE D  ; inter-facility consult
"RTN","MAGDTR05",133,0)
 . S IFCIEN=$$GET1^DIQ(123,GMRCIEN,.06,"I") ; remote consult file entry
"RTN","MAGDTR05",134,0)
 . ; get IFC site abbreviation
"RTN","MAGDTR05",135,0)
 . S I=$O(^MAG(2006.19,"D",IFCSITE,""))
"RTN","MAGDTR05",136,0)
 . S IFCSITEA=$S(I:$P($G(^MAG(2006.19,I,0)),"^",4),1:"?")
"RTN","MAGDTR05",137,0)
 . S IFCLTIME=$P(LISTDATA,"^",5),IFCRTIME=$P(LISTDATA,"^",6)
"RTN","MAGDTR05",138,0)
 . I IFCLTIME,IFCRTIME S IFCETIME=$$FMDIFF^XLFDT(IFCRTIME,IFCLTIME,2)
"RTN","MAGDTR05",139,0)
 . E  S IFCETIME=""
"RTN","MAGDTR05",140,0)
 . Q
"RTN","MAGDTR05",141,0)
 E  D  ; local consult
"RTN","MAGDTR05",142,0)
 . S (IFCIEN,IFCSITEA,IFCRTIME,IFCLTIME,IFCETIME)=""
"RTN","MAGDTR05",143,0)
 . Q
"RTN","MAGDTR05",144,0)
 S Z=Z_"|"_IFCSITE_"|"_IFCSITEA_"|"_IFCIEN
"RTN","MAGDTR05",145,0)
 S Z=Z_"|"_IFCLTIME_"|"_IFCRTIME_"|"_IFCETIME
"RTN","MAGDTR05",146,0)
 F I=12:1:16 S Z=Z_"|"_$P(LISTDATA,"^",I) ; reader identification
"RTN","MAGDTR05",147,0)
 S Z=Z_"|"_$P(LISTDATA,"^",17) ; start of reading
"RTN","MAGDTR05",148,0)
 S Z=Z_"|"_$P(LISTDATA,"^",18) ; end of reading
"RTN","MAGDTR05",149,0)
 S LAST=$G(OUT(1),1) ; first element in the array is the counter
"RTN","MAGDTR05",150,0)
 S LAST=LAST+1,OUT(LAST)=Z,OUT(1)=LAST
"RTN","MAGDTR05",151,0)
 Q
"RTN","MAGDTR05",152,0)
 ;
"RTN","MAGDTR05",153,0)
UNLOCKER ; automatically unlock any timed out studies
"RTN","MAGDTR05",154,0)
 N GMRCIEN
"RTN","MAGDTR05",155,0)
 N IFCSITE
"RTN","MAGDTR05",156,0)
 N SECONDS ;-- date/time in seconds
"RTN","MAGDTR05",157,0)
 N STATUS
"RTN","MAGDTR05",158,0)
 N UNLOCKTM ;- earliest date/time for a lock (FM format)
"RTN","MAGDTR05",159,0)
 N UNREAD ;--- pointer to entry in unread list
"RTN","MAGDTR05",160,0)
 N %,%H,X
"RTN","MAGDTR05",161,0)
 ;
"RTN","MAGDTR05",162,0)
 ; calculate the earliest automatic unlock date/time
"RTN","MAGDTR05",163,0)
 S SECONDS=86400*$H+$P($H,",",2)-(60*LOCKTIME)
"RTN","MAGDTR05",164,0)
 S %H=(SECONDS\86400)_","_(SECONDS#86400)
"RTN","MAGDTR05",165,0)
 D YMD^%DTC S UNLOCKTM=X_% ; convert to FM format
"RTN","MAGDTR05",166,0)
 ;
"RTN","MAGDTR05",167,0)
 ; traverse the "lock list" and unlock those that have timed out
"RTN","MAGDTR05",168,0)
 F IPROC=1:1:$L(IPROCS,",") S IPROCIDX=$P(IPROCS,",",IPROC) D
"RTN","MAGDTR05",169,0)
 . S UNREAD=""
"RTN","MAGDTR05",170,0)
 . F  S UNREAD=$O(^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,"L",UNREAD)) Q:UNREAD=""  D
"RTN","MAGDTR05",171,0)
 . . S LISTDATA=$G(^MAG(2006.5849,UNREAD,0))
"RTN","MAGDTR05",172,0)
 . . ; check for a lock timeout
"RTN","MAGDTR05",173,0)
 . . I $P(LISTDATA,"^",17)<UNLOCKTM D  ; lock timeout
"RTN","MAGDTR05",174,0)
 . . . ; only unlock studies that are to be done at the reading site
"RTN","MAGDTR05",175,0)
 . . . I DUZREAD2=$P(LISTDATA,"^",16) D UNLOCK^MAGDTR04(UNREAD,.STATUS)
"RTN","MAGDTR05",176,0)
 . . . Q
"RTN","MAGDTR05",177,0)
 . . Q
"RTN","MAGDTR05",178,0)
 . Q
"RTN","MAGDTR05",179,0)
 Q
"RTN","MAGDTR06")
0^11^B24321973
"RTN","MAGDTR06",1,0)
MAGDTR06 ;WOIFO/PMK - Read a DICOM image file ; 15 Nov 2006  7:03 AM
"RTN","MAGDTR06",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDTR06",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTR06",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR06",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTR06",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTR06",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTR06",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTR06",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTR06",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTR06",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTR06",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTR06",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTR06",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTR06",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTR06",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR06",17,0)
 ;;
"RTN","MAGDTR06",18,0)
GETSITES(OUT) ; MAG DICOM CON UNREAD ACQ SITES
"RTN","MAGDTR06",19,0)
 N ACQSITE,ADMNSITE,I,J,LOCKTIME,PRIMARY,X
"RTN","MAGDTR06",20,0)
 S J=0
"RTN","MAGDTR06",21,0)
 S I=0 F  S I=$O(^MAG(2006.5842,I)) Q:'I  S X=^(I,0) D GETSITE1
"RTN","MAGDTR06",22,0)
 S OUT(1)=J
"RTN","MAGDTR06",23,0)
 Q
"RTN","MAGDTR06",24,0)
 ;
"RTN","MAGDTR06",25,0)
GETSITE1 ;
"RTN","MAGDTR06",26,0)
 S J=J+1
"RTN","MAGDTR06",27,0)
 S ACQSITE=$P(X,"^",1),PRIMARY=$P(X,"^",2)
"RTN","MAGDTR06",28,0)
 S ADMNSITE=$P(X,"^",3),LOCKTIME=$P(X,"^",4)
"RTN","MAGDTR06",29,0)
 S OUT(J+1)=$$GET1^DIQ(4,ACQSITE,99)_"|"_$$GET1^DIQ(4,ACQSITE,.01)_"|"_PRIMARY_"|"_ADMNSITE_"|"_LOCKTIME
"RTN","MAGDTR06",30,0)
 Q
"RTN","MAGDTR06",31,0)
 ;
"RTN","MAGDTR06",32,0)
GETREAD(OUT) ; MAG DICOM CON GET TELE READER
"RTN","MAGDTR06",33,0)
 N ACQSITE,I,IPROCIDX,ISPECIDX,LOCKTIME,PRIMARY,XACQSITE,X,XDUZ,XPROCIDX,XSPECIDX
"RTN","MAGDTR06",34,0)
 N ADMNPROC,ADMNSITE,ADMNSPEC,USERPREF
"RTN","MAGDTR06",35,0)
 ;
"RTN","MAGDTR06",36,0)
 S (I,XDUZ)=0
"RTN","MAGDTR06",37,0)
 F  S XDUZ=$O(^MAG(2006.5843,"B",DUZ,XDUZ)) Q:'XDUZ  S XACQSITE=0 D
"RTN","MAGDTR06",38,0)
 . F  S XACQSITE=$O(^MAG(2006.5843,XDUZ,1,XACQSITE)) Q:'XACQSITE  D
"RTN","MAGDTR06",39,0)
 . . S X=^MAG(2006.5843,XDUZ,1,XACQSITE,0)
"RTN","MAGDTR06",40,0)
 . . S ACQSITE=$P(X,"^",1),ADMNSITE=$P(X,"^",2)
"RTN","MAGDTR06",41,0)
 . . S PRIMARY=$P(^MAG(2006.5842,ACQSITE,0),"^",2),LOCKTIME=$P(^(0),"^",4)
"RTN","MAGDTR06",42,0)
 . . ; an inactive site in file 2006.5842 overrides the active for the user
"RTN","MAGDTR06",43,0)
 . . I ADMNSITE S ADMNSITE=$P(^MAG(2006.5842,ACQSITE,0),"^",3)  ; site is not active
"RTN","MAGDTR06",44,0)
 . . S XSPECIDX=0
"RTN","MAGDTR06",45,0)
 . . F  S XSPECIDX=$O(^MAG(2006.5843,XDUZ,1,XACQSITE,1,XSPECIDX)) Q:'XSPECIDX  D
"RTN","MAGDTR06",46,0)
 . . . S X=^MAG(2006.5843,XDUZ,1,XACQSITE,1,XSPECIDX,0)
"RTN","MAGDTR06",47,0)
 . . . S ISPECIDX=$P(X,"^",1),ADMNSPEC=$P(X,"^",2)
"RTN","MAGDTR06",48,0)
 . . . S XPROCIDX=0
"RTN","MAGDTR06",49,0)
 . . . F  S XPROCIDX=$O(^MAG(2006.5843,XDUZ,1,XACQSITE,1,XSPECIDX,1,XPROCIDX)) Q:'XPROCIDX  D
"RTN","MAGDTR06",50,0)
 . . . . S X=^MAG(2006.5843,XDUZ,1,XACQSITE,1,XSPECIDX,1,XPROCIDX,0)
"RTN","MAGDTR06",51,0)
 . . . . S IPROCIDX=$P(X,"^",1),ADMNPROC=$P(X,"^",2),USERPREF=$P(X,"^",3)
"RTN","MAGDTR06",52,0)
 . . . . S X=$$GET1^DIQ(4,ACQSITE,99)_"|"_$$GET1^DIQ(4,ACQSITE,.01)
"RTN","MAGDTR06",53,0)
 . . . . S X=X_"|"_PRIMARY_"|"_ADMNSITE_"|"_LOCKTIME
"RTN","MAGDTR06",54,0)
 . . . . S X=X_"|"_ISPECIDX_"|"_$$GET1^DIQ(2005.84,ISPECIDX,.01)_"|"_ADMNSPEC
"RTN","MAGDTR06",55,0)
 . . . . S X=X_"|"_IPROCIDX_"|"_$$GET1^DIQ(2005.85,IPROCIDX,.01)_"|"_ADMNPROC
"RTN","MAGDTR06",56,0)
 . . . . S X=X_"|"_USERPREF
"RTN","MAGDTR06",57,0)
 . . . . S I=I+1,OUT(I+1)=X
"RTN","MAGDTR06",58,0)
 . . . . Q
"RTN","MAGDTR06",59,0)
 . . . Q
"RTN","MAGDTR06",60,0)
 . . Q
"RTN","MAGDTR06",61,0)
 . Q
"RTN","MAGDTR06",62,0)
 S OUT(1)=I
"RTN","MAGDTR06",63,0)
 Q
"RTN","MAGDTR06",64,0)
 ;
"RTN","MAGDTR06",65,0)
SETREAD(OUT,SITENUMB,ISPECIDX,IPROCIDX,USERPREF) ;  MAG DICOM CON SET TELE READER
"RTN","MAGDTR06",66,0)
 N ACQSITE,IENDUZ,IENSITE,IENSPEC,IENPROC,X
"RTN","MAGDTR06",67,0)
 I '$G(SITENUMB) S OUT="-1, ACQUISITION SITE PARAMETER IS NOT DEFINED"
"RTN","MAGDTR06",68,0)
 E  I '$G(ISPECIDX) S OUT="-2, SPECIALTY PARAMETER IS NOT DEFINED"
"RTN","MAGDTR06",69,0)
 E  I '$G(IPROCIDX) S OUT="-3, PROCEDURE PARAMETER IS NOT DEFINED"
"RTN","MAGDTR06",70,0)
 E  I '$D(USERPREF) S OUT="-4, USER PREFERENCE SELCTION IS NOT DEFINED"
"RTN","MAGDTR06",71,0)
 E  I USERPREF'=0,USERPREF'=1 S OUT="-5, ILLEGAL VALUE FOR USER PREFERENCE: <<"_USERPREF_">>"
"RTN","MAGDTR06",72,0)
 E  D
"RTN","MAGDTR06",73,0)
 . S IENDUZ=$O(^MAG(2006.5843,"B",DUZ,0))
"RTN","MAGDTR06",74,0)
 . I 'IENDUZ S OUT="-6, USER (DUZ) #"_DUZ_" IS NOT DEFINED IN FILE 2006.5849" Q
"RTN","MAGDTR06",75,0)
 . ;
"RTN","MAGDTR06",76,0)
 . S ACQSITE=+$$ACQSITE(SITENUMB)
"RTN","MAGDTR06",77,0)
 . I ACQSITE<0 S OUT="-7, ACQUISITION SITE #"_SITENUMB_" IS NOT DEFINED IN FILE 4" Q
"RTN","MAGDTR06",78,0)
 . ;
"RTN","MAGDTR06",79,0)
 . S IENSITE=$O(^MAG(2006.5843,IENDUZ,1,"B",ACQSITE,0))
"RTN","MAGDTR06",80,0)
 . I 'IENSITE S OUT="-8, ACQUISITION SITE #"_ACQSITE_" IS NOT DEFINED IN FILE 2006.5849" Q
"RTN","MAGDTR06",81,0)
 . ;
"RTN","MAGDTR06",82,0)
 . S IENSPEC=$O(^MAG(2006.5843,IENDUZ,1,IENSITE,1,"B",ISPECIDX,0))
"RTN","MAGDTR06",83,0)
 . I 'IENSPEC S OUT="-9, SPECIALTY #"_ISPECIDX_" IS NOT DEFINED IN FILE 2006.5849" Q
"RTN","MAGDTR06",84,0)
 . ;
"RTN","MAGDTR06",85,0)
 . S IENPROC=$O(^MAG(2006.5843,IENDUZ,1,IENSITE,1,IENSPEC,1,"B",IPROCIDX,0))
"RTN","MAGDTR06",86,0)
 . I 'IENPROC S OUT="-10, PROCEDURE #"_IPROCIDX_" IS NOT DEFINED IN FILE 2006.5849" Q
"RTN","MAGDTR06",87,0)
 . ;
"RTN","MAGDTR06",88,0)
 . I $D(^MAG(2006.5843,IENDUZ,1,IENSITE,1,IENSPEC,1,IENPROC,0)) S X=^(0) D
"RTN","MAGDTR06",89,0)
 . . I $P(X,"^",3)=USERPREF S OUT="2, USER PREFERENCE ALREADY SET"
"RTN","MAGDTR06",90,0)
 . . E  D
"RTN","MAGDTR06",91,0)
 . . . S $P(^MAG(2006.5843,IENDUZ,1,IENSITE,1,IENSPEC,1,IENPROC,0),"^",3)=USERPREF
"RTN","MAGDTR06",92,0)
 . . . S OUT="1, USER PREFERENCE SET"
"RTN","MAGDTR06",93,0)
 . . . Q
"RTN","MAGDTR06",94,0)
 . . Q
"RTN","MAGDTR06",95,0)
 . E  S OUT="-10, PROCEDURE #"_IPROCIDX_" IS NOT DEFINED IN FILE 2006.5849"
"RTN","MAGDTR06",96,0)
 . Q
"RTN","MAGDTR06",97,0)
 Q
"RTN","MAGDTR06",98,0)
 ;
"RTN","MAGDTR06",99,0)
ACQSITE(SITENUMB) ; lookup an institution by the site number
"RTN","MAGDTR06",100,0)
 N D,DIC,U,X,Y
"RTN","MAGDTR06",101,0)
 S DIC="^DIC(4," ; INSTITUTION is file #4 
"RTN","MAGDTR06",102,0)
 S D="D" ; use the "D" cross-reference
"RTN","MAGDTR06",103,0)
 S DIC(0)="X" ; only find the exact matching entry
"RTN","MAGDTR06",104,0)
 S X=SITENUMB
"RTN","MAGDTR06",105,0)
 D IX^DIC
"RTN","MAGDTR06",106,0)
 Q Y
"RTN","MAGDTRDX")
0^12^B23866845
"RTN","MAGDTRDX",1,0)
MAGDTRDX ;WOIFO/PMK - Formatted dump of DICOM MWL & TeleReader dictionaries ; 10/05/2006 06:34
"RTN","MAGDTRDX",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDTRDX",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTRDX",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTRDX",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTRDX",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTRDX",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTRDX",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTRDX",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTRDX",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTRDX",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTRDX",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTRDX",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTRDX",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTRDX",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTRDX",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTRDX",17,0)
 ;;
"RTN","MAGDTRDX",18,0)
ENTRY ;
"RTN","MAGDTRDX",19,0)
 N ACQSITE,CLINNAME,CLINPTR,D0,D1,D2,D3,DIVISION,IPROCIDX,ISPECIDX
"RTN","MAGDTRDX",20,0)
 N LOCKTIME,MSG,POP,PRIMARY,PROC,ROUTE,STATUS,TIUNOTE,TOSERV
"RTN","MAGDTRDX",21,0)
 N TRIGGER,USERPREF,X,X1,X2,X3
"RTN","MAGDTRDX",22,0)
 D ^%ZIS Q:POP  ; Select device quit if none
"RTN","MAGDTRDX",23,0)
 S (MSG(1),MSG(3))=""
"RTN","MAGDTRDX",24,0)
 S MSG(2)="DICOM HEALTHCARE PROVIDER SERVICE (file 2006.5831)"
"RTN","MAGDTRDX",25,0)
 W !! D HEADING(.MSG)
"RTN","MAGDTRDX",26,0)
 S D0=0 F  S D0=$O(^MAG(2006.5831,D0)) Q:'D0  D
"RTN","MAGDTRDX",27,0)
 . S X=$G(^MAG(2006.5831,D0,0))
"RTN","MAGDTRDX",28,0)
 . S TOSERV=$P(X,"^",1),ISPECIDX=$P(X,"^",2),DIVISION=$P(X,"^",3)
"RTN","MAGDTRDX",29,0)
 . W !!,$$W("To Service:"),$$GET1^DIQ(123.5,TOSERV,.01)
"RTN","MAGDTRDX",30,0)
 . W !,$$W("Worklist:"),$$GET1^DIQ(2005.84,ISPECIDX,3)
"RTN","MAGDTRDX",31,0)
 . W " (",$$GET1^DIQ(2005.84,ISPECIDX,.01),")"
"RTN","MAGDTRDX",32,0)
 . W " acquired at ",$$GET1^DIQ(4,DIVISION,.01)
"RTN","MAGDTRDX",33,0)
 . S ROUTE=$$GET1^DIQ(123.5,TOSERV,132)
"RTN","MAGDTRDX",34,0)
 . I ROUTE'="" D
"RTN","MAGDTRDX",35,0)
 . . W !,$$W("Remote IFC:"),ROUTE
"RTN","MAGDTRDX",36,0)
 . . Q
"RTN","MAGDTRDX",37,0)
 . S CLINPTR=0
"RTN","MAGDTRDX",38,0)
 . S D1=0 F  S D1=$O(^MAG(2006.5831,D0,1,D1)) Q:'D1  D
"RTN","MAGDTRDX",39,0)
 . . I 'CLINPTR W !,$$W("Clinics:")
"RTN","MAGDTRDX",40,0)
 . . S CLINPTR=$G(^MAG(2006.5831,D0,1,D1,0))
"RTN","MAGDTRDX",41,0)
 . . S CLINNAME=$$GET1^DIQ(44,CLINPTR,.01)
"RTN","MAGDTRDX",42,0)
 . . I $X+$L(CLINNAME)>70 W !,$$W("")
"RTN","MAGDTRDX",43,0)
 . . W CLINNAME,"    "
"RTN","MAGDTRDX",44,0)
 . . Q
"RTN","MAGDTRDX",45,0)
 . Q
"RTN","MAGDTRDX",46,0)
 ;
"RTN","MAGDTRDX",47,0)
 S MSG(2)="TELEREADER ACQUISITION SERVICE (file 2006.5841)"
"RTN","MAGDTRDX",48,0)
 W !! D HEADING(.MSG)
"RTN","MAGDTRDX",49,0)
 S D0=0 F  S D0=$O(^MAG(2006.5841,D0)) Q:'D0  D
"RTN","MAGDTRDX",50,0)
 . S X=$G(^MAG(2006.5841,D0,0))
"RTN","MAGDTRDX",51,0)
 . S TOSERV=$P(X,"^",1),PROC=$P(X,"^",2),ISPECIDX=$P(X,"^",3)
"RTN","MAGDTRDX",52,0)
 . S IPROCIDX=$P(X,"^",4),DIVISION=$P(X,"^",5)
"RTN","MAGDTRDX",53,0)
 . S TRIGGER=$P(X,"^",6),TIUNOTE=$P(X,"^",7)
"RTN","MAGDTRDX",54,0)
 . W !!,$$W("To Service:"),$$GET1^DIQ(123.5,TOSERV,.01)
"RTN","MAGDTRDX",55,0)
 . I $D(^MAG(2006.5831,TOSERV,0)) W ?63,"*** DICOM MWL ***"
"RTN","MAGDTRDX",56,0)
 . I PROC W !,$$W("Procedure:"),$$GET1^DIQ(123.3,PROC,.01)
"RTN","MAGDTRDX",57,0)
 . S ROUTE=$$GET1^DIQ(123.5,TOSERV,132)
"RTN","MAGDTRDX",58,0)
 . I ROUTE'="" D
"RTN","MAGDTRDX",59,0)
 . . W !,$$W("Remote IFC:"),ROUTE
"RTN","MAGDTRDX",60,0)
 . . Q
"RTN","MAGDTRDX",61,0)
 . W !,$$W(" Unread List:"),$$GET1^DIQ(2005.84,ISPECIDX,.01)
"RTN","MAGDTRDX",62,0)
 . W " -- ",$$GET1^DIQ(2005.85,IPROCIDX,.01)
"RTN","MAGDTRDX",63,0)
 . W !,$$W("Trigger:")
"RTN","MAGDTRDX",64,0)
 . I TRIGGER="I" W "Create/update with every acquired image"
"RTN","MAGDTRDX",65,0)
 . E  I TRIGGER="O" W "Create when request is ordered"
"RTN","MAGDTRDX",66,0)
 . E  I TRIGGER="F" W "Create when consult is forwarded"
"RTN","MAGDTRDX",67,0)
 . E  W "Unknown trigger value: """,TRIGGER,""""
"RTN","MAGDTRDX",68,0)
 . I TIUNOTE W !,$$W("Note for IFC:"),$$GET1^DIQ(8925.1,TIUNOTE,.01)
"RTN","MAGDTRDX",69,0)
 . Q
"RTN","MAGDTRDX",70,0)
 ;
"RTN","MAGDTRDX",71,0)
 S MSG(2)="TELEREADER ACQUISITION SITE (file 2006.5842)"
"RTN","MAGDTRDX",72,0)
 W !! D HEADING(.MSG)
"RTN","MAGDTRDX",73,0)
 S D0=0 F  S D0=$O(^MAG(2006.5842,D0)) Q:'D0  D
"RTN","MAGDTRDX",74,0)
 . S X=$G(^MAG(2006.5842,D0,0))
"RTN","MAGDTRDX",75,0)
 . S ACQSITE=$P(X,"^",1),PRIMARY=$P(X,"^",2)
"RTN","MAGDTRDX",76,0)
 . S STATUS=$P(X,"^",3),LOCKTIME=$P(X,"^",4)
"RTN","MAGDTRDX",77,0)
 . W !!,$$W("Acquisition:"),$$GET1^DIQ(4,ACQSITE,.01)
"RTN","MAGDTRDX",78,0)
 . W ?50,$S(STATUS:"Active",1:"Inactive")
"RTN","MAGDTRDX",79,0)
 . W ?60,"Lock Time: ",LOCKTIME," min."
"RTN","MAGDTRDX",80,0)
 . W !,$$W("Primary Site:"),$$GET1^DIQ(4,PRIMARY,.01)
"RTN","MAGDTRDX",81,0)
 . Q
"RTN","MAGDTRDX",82,0)
 ;
"RTN","MAGDTRDX",83,0)
 S MSG(2)="TELEREADER READER (file 2006.5843)"
"RTN","MAGDTRDX",84,0)
 W !! D HEADING(.MSG)
"RTN","MAGDTRDX",85,0)
 S D0=0 F  S D0=$O(^MAG(2006.5843,D0)) Q:'D0  D
"RTN","MAGDTRDX",86,0)
 . S X=$G(^MAG(2006.5843,D0,0))
"RTN","MAGDTRDX",87,0)
 . W:D0>1 !!,$TR($J("",80)," ","-")
"RTN","MAGDTRDX",88,0)
 . W !!,$$W("TeleReader:"),$$GET1^DIQ(200,X,.01)
"RTN","MAGDTRDX",89,0)
 . S D1=0 F  S D1=$O(^MAG(2006.5843,D0,1,D1)) Q:'D1  D
"RTN","MAGDTRDX",90,0)
 . . S X1=$G(^MAG(2006.5843,D0,1,D1,0))
"RTN","MAGDTRDX",91,0)
 . . S ACQSITE=$P(X1,"^",1),STATUS=$P(X1,"^",2)
"RTN","MAGDTRDX",92,0)
 . . W !!,$$W("Acquisition:"),$$GET1^DIQ(4,ACQSITE,.01)
"RTN","MAGDTRDX",93,0)
 . . W ?50,$S(STATUS:"Active",1:"Inactive")
"RTN","MAGDTRDX",94,0)
 . . S D2=0 F  S D2=$O(^MAG(2006.5843,D0,1,D1,1,D2)) Q:'D2  D
"RTN","MAGDTRDX",95,0)
 . . . S X2=$G(^MAG(2006.5843,D0,1,D1,1,D2,0))
"RTN","MAGDTRDX",96,0)
 . . . S ISPECIDX=$P(X2,"^",1),STATUS=$P(X2,"^",2)
"RTN","MAGDTRDX",97,0)
 . . . W !,$$W(" Unread List:"),$$GET1^DIQ(2005.84,ISPECIDX,.01)
"RTN","MAGDTRDX",98,0)
 . . . W ?50,$S(STATUS:"Active",1:"Inactive")
"RTN","MAGDTRDX",99,0)
 . . . S D3=0 F  S D3=$O(^MAG(2006.5843,D0,1,D1,1,D2,1,D3)) Q:'D3  D
"RTN","MAGDTRDX",100,0)
 . . . . S X3=$G(^MAG(2006.5843,D0,1,D1,1,D2,1,D3,0))
"RTN","MAGDTRDX",101,0)
 . . . . S IPROCIDX=$P(X3,"^",1),STATUS=$P(X3,"^",2),USERPREF=$P(X3,"^",3)
"RTN","MAGDTRDX",102,0)
 . . . . W !,$$W(""),$$GET1^DIQ(2005.85,IPROCIDX,.01)
"RTN","MAGDTRDX",103,0)
 . . . . W ?50,$S(STATUS:"Active",1:"Inactive")
"RTN","MAGDTRDX",104,0)
 . . . . W ?65,"User: ",$S(USERPREF:"Active",1:"Inactive")
"RTN","MAGDTRDX",105,0)
 . . . . Q
"RTN","MAGDTRDX",106,0)
 . . . Q
"RTN","MAGDTRDX",107,0)
 . . Q
"RTN","MAGDTRDX",108,0)
 . Q
"RTN","MAGDTRDX",109,0)
 W !,$TR($J("",80)," ","*"),!
"RTN","MAGDTRDX",110,0)
 Q
"RTN","MAGDTRDX",111,0)
 ;
"RTN","MAGDTRDX",112,0)
W(PROMPT) ; output prompt
"RTN","MAGDTRDX",113,0)
 Q $J(PROMPT,13)_" "
"RTN","MAGDTRDX",114,0)
 ;
"RTN","MAGDTRDX",115,0)
HEADING(MSG) ;
"RTN","MAGDTRDX",116,0)
 N I
"RTN","MAGDTRDX",117,0)
 W !,$TR($J("",80)," ","*")
"RTN","MAGDTRDX",118,0)
 I $D(MSG)=1 W !,"*** ",MSG,?76," ***"
"RTN","MAGDTRDX",119,0)
 E  F I=1:1 Q:'$D(MSG(I))  W !,"*** ",MSG(I),?76," ***"
"RTN","MAGDTRDX",120,0)
 W !,$TR($J("",80)," ","*")
"RTN","MAGDTRDX",121,0)
 Q
"RTN","MAGDTRDX",122,0)
 ;
"RTN","MAGDTRLU")
0^13^B19829856
"RTN","MAGDTRLU",1,0)
MAGDTRLU ;WOIFO/OHH/PMK - Report discrepancies between files #2006.5849 & #123 and correct them ; 10/11/2006 08:53
"RTN","MAGDTRLU",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGDTRLU",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTRLU",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTRLU",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTRLU",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTRLU",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTRLU",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTRLU",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTRLU",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTRLU",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTRLU",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTRLU",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTRLU",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTRLU",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTRLU",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTRLU",17,0)
 ;;
"RTN","MAGDTRLU",18,0)
 ; This routine automatically checks the data in file telereader
"RTN","MAGDTRLU",19,0)
 ; read/unread list (file 2006.5849)and compares it with the
"RTN","MAGDTRLU",20,0)
 ; request/consultation (file #123). If a telereader study is locked
"RTN","MAGDTRLU",21,0)
 ; or unread and in the request/consult file it is completed or
"RTN","MAGDTRLU",22,0)
 ; cancelled, then it updates the status of the study in the telereader
"RTN","MAGDTRLU",23,0)
 ; read/unread list file, the "D" cross reference, and the reading
"RTN","MAGDTRLU",24,0)
 ; start field is updated.
"RTN","MAGDTRLU",25,0)
 Q
"RTN","MAGDTRLU",26,0)
 ;
"RTN","MAGDTRLU",27,0)
REPORT ; report problems with the Unread List
"RTN","MAGDTRLU",28,0)
 D PASS("REPORT")
"RTN","MAGDTRLU",29,0)
 Q
"RTN","MAGDTRLU",30,0)
 ;
"RTN","MAGDTRLU",31,0)
REPAIR ; repair problems with the Unread List
"RTN","MAGDTRLU",32,0)
 D PASS("REPAIR")
"RTN","MAGDTRLU",33,0)
 Q
"RTN","MAGDTRLU",34,0)
 ;
"RTN","MAGDTRLU",35,0)
PASS(MODE) ; report/repair problems for LOCKED and UNREAD studies
"RTN","MAGDTRLU",36,0)
 N MSG
"RTN","MAGDTRLU",37,0)
 S (MSG(1),MSG(3))=""
"RTN","MAGDTRLU",38,0)
 ;
"RTN","MAGDTRLU",39,0)
 ; PASS 1 - search for LOCKED cases that are completed/cancelled.
"RTN","MAGDTRLU",40,0)
 S MSG(2)="Check for completed studies that have LOCKED status"
"RTN","MAGDTRLU",41,0)
 I MODE="REPAIR" S MSG(2)=MSG(2)_" and correct them"
"RTN","MAGDTRLU",42,0)
 W !! D HEADING^MAGDTRDX(.MSG)
"RTN","MAGDTRLU",43,0)
 D SEARCH("LOCKED",MODE)
"RTN","MAGDTRLU",44,0)
 ;
"RTN","MAGDTRLU",45,0)
 ; PASS 2 - search for UNREAD cases that are completed/cancelled.
"RTN","MAGDTRLU",46,0)
 S MSG(2)="Now check for completed studies that have UNREAD status"
"RTN","MAGDTRLU",47,0)
 I MODE="REPAIR" S MSG(2)=MSG(2)_" and correct them"
"RTN","MAGDTRLU",48,0)
 W !! D HEADING^MAGDTRDX(.MSG)
"RTN","MAGDTRLU",49,0)
 D SEARCH("UNREAD",MODE)
"RTN","MAGDTRLU",50,0)
 Q
"RTN","MAGDTRLU",51,0)
 ;
"RTN","MAGDTRLU",52,0)
SEARCH(STATUS,MODE) ; go through studies for each site, specialty and procedure
"RTN","MAGDTRLU",53,0)
 N ACQSITE ; -- acquisition division number
"RTN","MAGDTRLU",54,0)
 N ISPECIDX ; - image index for specialty
"RTN","MAGDTRLU",55,0)
 N IPROCIDX ; - image index for procedure
"RTN","MAGDTRLU",56,0)
 N UNREAD ; --- IEN of file telereader read/undread file #2006.5849
"RTN","MAGDTRLU",57,0)
 N XREF ; ----- "D" cross reference: "L" for locked, "U" for unread
"RTN","MAGDTRLU",58,0)
 N I
"RTN","MAGDTRLU",59,0)
 ;
"RTN","MAGDTRLU",60,0)
 S XREF=$E(STATUS)
"RTN","MAGDTRLU",61,0)
 S ACQSITE=""
"RTN","MAGDTRLU",62,0)
 F  S ACQSITE=$O(^MAG(2006.5849,"D",ACQSITE)) Q:ACQSITE=""  D
"RTN","MAGDTRLU",63,0)
 . W !!,$$W("Acquisition Site:"),$$GET1^DIQ(4,ACQSITE,.01)
"RTN","MAGDTRLU",64,0)
 . S ISPECIDX=""
"RTN","MAGDTRLU",65,0)
 . F  S ISPECIDX=$O(^MAG(2006.5849,"D",ACQSITE,ISPECIDX)) Q:ISPECIDX=""  D
"RTN","MAGDTRLU",66,0)
 . . W !,$$W("Specialty:"),$$GET1^DIQ(2005.84,ISPECIDX,.01)
"RTN","MAGDTRLU",67,0)
 . . S IPROCIDX=""
"RTN","MAGDTRLU",68,0)
 . . F  S IPROCIDX=$O(^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX)) Q:IPROCIDX=""  D
"RTN","MAGDTRLU",69,0)
 . . . N COUNT ; -- array of counts of problems
"RTN","MAGDTRLU",70,0)
 . . . W !,$$W("Procedure:"),$$GET1^DIQ(2005.85,IPROCIDX,.01) D
"RTN","MAGDTRLU",71,0)
 . . . S UNREAD=""
"RTN","MAGDTRLU",72,0)
 . . . F  S UNREAD=$O(^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,XREF,UNREAD)) Q:UNREAD=""  D CHECK
"RTN","MAGDTRLU",73,0)
 . . . I '$D(COUNT) D  Q
"RTN","MAGDTRLU",74,0)
 . . . . W !,$$W(""),"No inconsistencies were found.",!
"RTN","MAGDTRLU",75,0)
 . . . . Q
"RTN","MAGDTRLU",76,0)
 . . . S I="" F  S I=$O(COUNT(I)) Q:I=""  D
"RTN","MAGDTRLU",77,0)
 . . . . W !,$$W($S(MODE="REPORT":"Problem:",1:"Repaired:"))
"RTN","MAGDTRLU",78,0)
 . . . . W "Number of consults that have ",I," status in CPRS: ",COUNT(I)
"RTN","MAGDTRLU",79,0)
 . . . . W !
"RTN","MAGDTRLU",80,0)
 . . . . Q
"RTN","MAGDTRLU",81,0)
 . . . Q
"RTN","MAGDTRLU",82,0)
 . . Q
"RTN","MAGDTRLU",83,0)
 . Q
"RTN","MAGDTRLU",84,0)
 Q
"RTN","MAGDTRLU",85,0)
 ;
"RTN","MAGDTRLU",86,0)
CHECK ;check Unread List entry against that in CPRS Consult Requst Tracking
"RTN","MAGDTRLU",87,0)
 N GMRCIEN ; -- IEN of file request/consultation (file #123)
"RTN","MAGDTRLU",88,0)
 N GMRCSTS ; -- status of consult request - from ^ORD(100.01)
"RTN","MAGDTRLU",89,0)
 ;
"RTN","MAGDTRLU",90,0)
 S GMRCIEN=$P(^MAG(2006.5849,UNREAD,0),"^",1)
"RTN","MAGDTRLU",91,0)
 S GMRCSTS=$$GET1^DIQ(123,GMRCIEN,8) ; cprs status
"RTN","MAGDTRLU",92,0)
 I "^COMPLETE^CANCELLED^DISCONTINUED^DISCONTINUED/EDIT^EXPIRED^"[("^"_GMRCSTS_"^") D
"RTN","MAGDTRLU",93,0)
 . S COUNT(GMRCSTS)=$G(COUNT(GMRCSTS))+1
"RTN","MAGDTRLU",94,0)
 . I MODE="REPORT" D
"RTN","MAGDTRLU",95,0)
 . . W !,$$W(""),"Consult # ",GMRCIEN," has the status of ",GMRCSTS," in CPRS"
"RTN","MAGDTRLU",96,0)
 . . Q
"RTN","MAGDTRLU",97,0)
 . E  I MODE="REPAIR" D  ; correct the entry
"RTN","MAGDTRLU",98,0)
 . . W !,$$W("Fix:"),"Consult # ",GMRCIEN," which has the status of ",GMRCSTS," in CPRS"
"RTN","MAGDTRLU",99,0)
 . . ; Note: The variable & value MODE="REPAIR" are used in ^MAGDTR03
"RTN","MAGDTRLU",100,0)
 . . I GMRCSTS="COMPLETE" D
"RTN","MAGDTRLU",101,0)
 . . . D COMPLETE^MAGDTR03
"RTN","MAGDTRLU",102,0)
 . . . Q
"RTN","MAGDTRLU",103,0)
 . . E  D CANCEL^MAGDTR03
"RTN","MAGDTRLU",104,0)
 . . Q
"RTN","MAGDTRLU",105,0)
 . Q
"RTN","MAGDTRLU",106,0)
 Q
"RTN","MAGDTRLU",107,0)
 ;
"RTN","MAGDTRLU",108,0)
W(PROMPT) ; output prompt
"RTN","MAGDTRLU",109,0)
 Q $J(PROMPT,16)_" "
"RTN","MAGGNLKP")
0^14^B14406989
"RTN","MAGGNLKP",1,0)
MAGGNLKP ;WOIFO/GEK - Lookup from delphi into any file ; [ 06/20/2001 08:56 ]
"RTN","MAGGNLKP",2,0)
 ;;3.0;IMAGING;**8,92,46**;16-February-2007;;Build 1023
"RTN","MAGGNLKP",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGNLKP",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGNLKP",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGNLKP",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGNLKP",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGNLKP",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGNLKP",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGNLKP",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGNLKP",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGNLKP",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGNLKP",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGNLKP",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGNLKP",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGNLKP",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGNLKP",17,0)
 ;;
"RTN","MAGGNLKP",18,0)
 Q
"RTN","MAGGNLKP",19,0)
 ;
"RTN","MAGGNLKP",20,0)
LKP(MAGRY,MAGIN,DATA) ;RPC [MAG3 LOOKUP ANY] 
"RTN","MAGGNLKP",21,0)
 ; Generic lookup using FIND^DIC
"RTN","MAGGNLKP",22,0)
 ; MAGRY is the Array to return.
"RTN","MAGGNLKP",23,0)
 ; MAGIN is parameter sent by calling app (Delphi)
"RTN","MAGGNLKP",24,0)
 ;    FILE NUM ^ NUM TO RETURN ^ TEXT TO MATCH ^ FIELDS ^ SCREEN ($P 5-99)
"RTN","MAGGNLKP",25,0)
 ;    
"RTN","MAGGNLKP",26,0)
 ; DATA : 
"RTN","MAGGNLKP",27,0)
 ;  LVIEW =Piece 1 
"RTN","MAGGNLKP",28,0)
 ;     +LVIEW = 1  :  
"RTN","MAGGNLKP",29,0)
 ;          result array is formatted for a magListView control
"RTN","MAGGNLKP",30,0)
 ;              i.e.  ^ delimiter for data and "|" delimiter for IEN
"RTN","MAGGNLKP",31,0)
 ;     +LVIEW = 0  : 
"RTN","MAGGNLKP",32,0)
 ;         old way,  "  " delim for data and '^' delim for IEN
"RTN","MAGGNLKP",33,0)
 ;  INDX = Piece 2
"RTN","MAGGNLKP",34,0)
 ;                       This is the index to search 
"RTN","MAGGNLKP",35,0)
 ;                       Defaults to "B"
"RTN","MAGGNLKP",36,0)
 ;    
"RTN","MAGGNLKP",37,0)
 ;
"RTN","MAGGNLKP",38,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGTERR"
"RTN","MAGGNLKP",39,0)
 ;
"RTN","MAGGNLKP",40,0)
 N Y,XI,Z,FI,MAGIEN,INFO,LVIEW,INDX
"RTN","MAGGNLKP",41,0)
 N FILE,IENS,FLDS,FLAGS,VAL,NUM,INDEX,SCR,IDENT,TROOT
"RTN","MAGGNLKP",42,0)
 S (FILE,IENS,FLDS,FLAGS,VAL,NUM,INDEX,SCR,IDENT,TROOT)=""
"RTN","MAGGNLKP",43,0)
 S MAGIN=$G(MAGIN)
"RTN","MAGGNLKP",44,0)
 S DATA=$G(DATA)
"RTN","MAGGNLKP",45,0)
 ;
"RTN","MAGGNLKP",46,0)
 S FILE=+$P(MAGIN,U,1)
"RTN","MAGGNLKP",47,0)
 S NUM=$S(+$P(MAGIN,U,2):+$P(MAGIN,U,2),1:200)
"RTN","MAGGNLKP",48,0)
 S VAL=$P(MAGIN,U,3)
"RTN","MAGGNLKP",49,0)
 S FLDS=$P(MAGIN,U,4)
"RTN","MAGGNLKP",50,0)
 S SCR=$P(MAGIN,U,5,99)
"RTN","MAGGNLKP",51,0)
 ;
"RTN","MAGGNLKP",52,0)
 S LVIEW=+$P(DATA,"^",1)
"RTN","MAGGNLKP",53,0)
 S INDX=$S($L($P(DATA,"^",2)):$P(DATA,"^",2),1:"B")
"RTN","MAGGNLKP",54,0)
 ;
"RTN","MAGGNLKP",55,0)
 I 'FILE S MAGRY(1)="0^ERROR - Invalid Parameter:  File Number ? " Q
"RTN","MAGGNLKP",56,0)
 I '$$VFILE^DILFD(FILE) S MAGRY(1)="0^ERROR - Invalid File # - "_FILE Q
"RTN","MAGGNLKP",57,0)
 ;          Number of entries to return, If 0 we'll stop at 200
"RTN","MAGGNLKP",58,0)
 ;
"RTN","MAGGNLKP",59,0)
 K ^TMP("DILIST",$J)
"RTN","MAGGNLKP",60,0)
 K ^TMP("DIERR",$J)
"RTN","MAGGNLKP",61,0)
 ;  VAL is the initial value to search for. i.e. the user input.
"RTN","MAGGNLKP",62,0)
 ;  Next line is to stop the FM Infinite Error Trap problem.
"RTN","MAGGNLKP",63,0)
 I $L(VAL)>30 S MAGRY(0)="0^Invalid Input: '"_$E(VAL,1,40)_"...' is too long. "_$L(VAL)_" characters." Q
"RTN","MAGGNLKP",64,0)
 D FIND^DIC(FILE,IENS,FLDS,FLAGS,VAL,NUM,INDEX,SCR,IDENT,TROOT)
"RTN","MAGGNLKP",65,0)
 ;
"RTN","MAGGNLKP",66,0)
 I '$D(^TMP("DILIST",$J,1)) S XI=1 D  Q
"RTN","MAGGNLKP",67,0)
 . I $D(^TMP("DIERR",$J)) D FINDERR(XI) Q
"RTN","MAGGNLKP",68,0)
 . S MAGRY(XI)="0^NO MATCH for lookup on """_$P(MAGIN,"^",3)_""""
"RTN","MAGGNLKP",69,0)
 ;  so we have some matches, (BUT we could still have an error)
"RTN","MAGGNLKP",70,0)
 ;  so first list all matches, then the ERROR
"RTN","MAGGNLKP",71,0)
 ;  Next lines were Q&D but old .EXE's expect return string with 
"RTN","MAGGNLKP",72,0)
 ;  this syntax, when all T11 code is gone, this can be rewritten
"RTN","MAGGNLKP",73,0)
 I LVIEW S XI="" F  S XI=$O(^TMP("DILIST",$J,1,XI)) Q:XI=""  S X=^(XI) D
"RTN","MAGGNLKP",74,0)
 . S MAGIEN=^TMP("DILIST",$J,2,XI)
"RTN","MAGGNLKP",75,0)
 . S Z=".01",FLD="NAME"
"RTN","MAGGNLKP",76,0)
 . F  S Z=$O(^TMP("DILIST",$J,"ID",XI,Z)) Q:Z=""  S X=X_"^"_^(Z),FLD=FLD_"^"_$$GET1^DID(FILE,Z,"","LABEL","MAGFLD")
"RTN","MAGGNLKP",77,0)
 . S MAGRY(.05)=FLD
"RTN","MAGGNLKP",78,0)
 . S MAGRY(XI)=X_"^|"_MAGIEN
"RTN","MAGGNLKP",79,0)
 . Q
"RTN","MAGGNLKP",80,0)
 I 'LVIEW  S XI="" F  S XI=$O(^TMP("DILIST",$J,1,XI)) Q:XI=""  S X=^(XI) D
"RTN","MAGGNLKP",81,0)
 . S MAGIEN=^TMP("DILIST",$J,2,XI)
"RTN","MAGGNLKP",82,0)
 . S Z=""
"RTN","MAGGNLKP",83,0)
 . F  S Z=$O(^TMP("DILIST",$J,"ID",XI,Z)) Q:Z=""  S X=X_"   "_^(Z)
"RTN","MAGGNLKP",84,0)
 . S MAGRY(XI)=X_"^"_MAGIEN
"RTN","MAGGNLKP",85,0)
 . Q
"RTN","MAGGNLKP",86,0)
 I $D(^TMP("DIERR",$J)) D FINDERR() Q
"RTN","MAGGNLKP",87,0)
 I $D(^TMP("DILIST",$J,0)) S INFO=^(0) D
"RTN","MAGGNLKP",88,0)
 . S MAGRY(0)=$P(INFO,"^")_U_"Found "_$P(INFO,"^")_" entr"_$S((+INFO=1):"y",1:"ies")_" matching """_$P(MAGIN,"^",3)_""""
"RTN","MAGGNLKP",89,0)
 . I $P(INFO,"^",3)>0 S MAGRY(0)=MAGRY(0)_" there are more"
"RTN","MAGGNLKP",90,0)
 . Q
"RTN","MAGGNLKP",91,0)
 Q
"RTN","MAGGNLKP",92,0)
FINDERR(XI) ;
"RTN","MAGGNLKP",93,0)
 ;
"RTN","MAGGNLKP",94,0)
 I '+$G(XI) S XI=$O(MAGRY(""),-1)+1
"RTN","MAGGNLKP",95,0)
 S MAGRY(XI)="ERROR^"_^TMP("DIERR",$J,1,"TEXT",1)
"RTN","MAGGNLKP",96,0)
 Q
"RTN","MAGGNTI1")
0^15^B42165742
"RTN","MAGGNTI1",1,0)
MAGGNTI1 ;WOIFO/GEK - Imaging interface to TIU RPC Calls etc. ; 20 Nov 2006  12:42 PM
"RTN","MAGGNTI1",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGGNTI1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGNTI1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGNTI1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGNTI1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGNTI1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGNTI1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGNTI1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGNTI1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGNTI1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGNTI1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGNTI1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGNTI1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGNTI1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGNTI1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGNTI1",17,0)
 ;;
"RTN","MAGGNTI1",18,0)
 Q
"RTN","MAGGNTI1",19,0)
NEW(MAGRY,MAGDFN,MAGTITLE,MAGADCL,MAGMODE,MAGES,MAGESBY,MAGLOC,MAGDATE,MAGCNSLT,MAGTEXT) ;RPC [MAG3 TIU NEW]
"RTN","MAGGNTI1",20,0)
 ;
"RTN","MAGGNTI1",21,0)
 ;  RPC call to create a New Note 
"RTN","MAGGNTI1",22,0)
 ;  and Optionally :  
"RTN","MAGGNTI1",23,0)
 ;     Electronically Sign,  
"RTN","MAGGNTI1",24,0)
 ;     Administratively Close 
"RTN","MAGGNTI1",25,0)
 ;     or Add Text to the Note.
"RTN","MAGGNTI1",26,0)
 ;       
"RTN","MAGGNTI1",27,0)
 ;  - - -  Required  - - - 
"RTN","MAGGNTI1",28,0)
 ;  MAGDFN   - Patient DFN
"RTN","MAGGNTI1",29,0)
 ;  MAGTITLE - IEN of TIU Document Title in file 8925.1
"RTN","MAGGNTI1",30,0)
 ;  - - -  Optional  - - - 
"RTN","MAGGNTI1",31,0)
 ;  Use DUZ for TIUAUTH 
"RTN","MAGGNTI1",32,0)
 ;  Use NOW for TIURDT
"RTN","MAGGNTI1",33,0)
 ;  MAGTEXT  - Array of Text to add to the New Note.
"RTN","MAGGNTI1",34,0)
 ;  MAGLOC   - IEN in Hospital Location File 44
"RTN","MAGGNTI1",35,0)
 ;  MAGES    - The encrypted Electronic Signature
"RTN","MAGGNTI1",36,0)
 ;  MAGESBY  - The DUZ of the Signer (Defaults to DUZ)
"RTN","MAGGNTI1",37,0)
 ;  MAGADCL  - 1 = Mark this Note as Administratively Closed
"RTN","MAGGNTI1",38,0)
 ;  MAGMODE  - Mode of Admin Closure: "S" = Scanned Document
"RTN","MAGGNTI1",39,0)
 ;             "M" = Manual closure, "E" = Electronically Filed
"RTN","MAGGNTI1",40,0)
 ;  MAGDATE  - Date of the Note. For New Notes.
"RTN","MAGGNTI1",41,0)
 ;  MAGCNSLT - DA of Consult to Link to.
"RTN","MAGGNTI1",42,0)
 ;
"RTN","MAGGNTI1",43,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^"_$T(+0)
"RTN","MAGGNTI1",44,0)
 S MAGDFN=$G(MAGDFN),MAGTITLE=$G(MAGTITLE),MAGLOC=$G(MAGLOC)
"RTN","MAGGNTI1",45,0)
 S MAGES=$G(MAGES),MAGADCL=$G(MAGADCL)
"RTN","MAGGNTI1",46,0)
 S MAGESBY=$S($G(MAGESBY):MAGESBY,1:DUZ)
"RTN","MAGGNTI1",47,0)
 S MAGMODE=$S($L($G(MAGMODE)):MAGMODE,1:"S")
"RTN","MAGGNTI1",48,0)
 S MAGDATE=$G(MAGDATE),MAGCNSLT=$G(MAGCNSLT)
"RTN","MAGGNTI1",49,0)
 N MAGTIUDA,I,NODE,MAGTY,ISVAL,MAGISC,MTXT,MUPD,MAGX,MAGVSTR,MAGTIUX
"RTN","MAGGNTI1",50,0)
 ;
"RTN","MAGGNTI1",51,0)
 ;  MAGMODE is only sent if Admin Closure is wanted.
"RTN","MAGGNTI1",52,0)
 I (MAGMODE="S") S MAGTEXT(.1)="   VistA Imaging - Scanned Document"
"RTN","MAGGNTI1",53,0)
 I (MAGMODE="M") S MAGTEXT(.1)="   VistA Imaging - Manual Closure"
"RTN","MAGGNTI1",54,0)
 I "MSE"'[MAGMODE S MAGRY="0^Invalid Mode of Closure: """_MAGMODE_"""" Q
"RTN","MAGGNTI1",55,0)
 ;
"RTN","MAGGNTI1",56,0)
 ; Here if we have no Text, we'll add at least a line.
"RTN","MAGGNTI1",57,0)
 I $O(MAGTEXT(""))="" S MAGTEXT(.1)="   VistA Imaging - - Scanned Document"
"RTN","MAGGNTI1",58,0)
 ;               Reformat Text - "TEXT",i,0)"   for TIU Call.
"RTN","MAGGNTI1",59,0)
 S I="",NODE=0
"RTN","MAGGNTI1",60,0)
 F  S I=$O(MAGTEXT(I)) Q:I=""  D
"RTN","MAGGNTI1",61,0)
 . S NODE=NODE+1 S MAGTIUX("TEXT",NODE,0)=MAGTEXT(I)
"RTN","MAGGNTI1",62,0)
 . Q
"RTN","MAGGNTI1",63,0)
 ;          validate the DFN
"RTN","MAGGNTI1",64,0)
 I '$D(^DPT(+MAGDFN,0)) S MAGRY="0^Invalid data: Patient DFN is invalid" Q
"RTN","MAGGNTI1",65,0)
 ;      validate the User
"RTN","MAGGNTI1",66,0)
 I '$D(^VA(200,MAGESBY,0)) S MAGRY="0^Invalid data: Author DUZ is invalid" Q
"RTN","MAGGNTI1",67,0)
 ;      validate the TIU TITLE
"RTN","MAGGNTI1",68,0)
 I '$D(^TIU(8925.1,MAGTITLE,0)) S MAGRY="0^Invalid data: Note TITLE is invalid" Q
"RTN","MAGGNTI1",69,0)
 ;      validate Esig first, if caller wants to also mark this Note as Signed
"RTN","MAGGNTI1",70,0)
 I +$G(MAGES) I '$$VALES^MAGGNTI2(MAGES) S MAGRY="0^Invalid data: E-sign is invalid" Q
"RTN","MAGGNTI1",71,0)
 ;      validate the Date   MAGDATE is changed to INternal if it is valid.
"RTN","MAGGNTI1",72,0)
 I +$L(MAGDATE) I '$$VALID^MAGGSIV1(8925,1301,.MAGDATE,.MAGX) S MAGRY="0^"_MAGX Q
"RTN","MAGGNTI1",73,0)
 I '$L(MAGDATE) S MAGDATE=$$NOW^XLFDT
"RTN","MAGGNTI1",74,0)
 ; LINK TO CONSULT
"RTN","MAGGNTI1",75,0)
 ; can user create Notes with This Title
"RTN","MAGGNTI1",76,0)
 I '$$CANENTR^TIULP(MAGTITLE) S MAGRY="0^You need privileges to enter notes of that Title" Q
"RTN","MAGGNTI1",77,0)
 ;
"RTN","MAGGNTI1",78,0)
 D ISCNSLT^TIUCNSLT(.MAGISC,MAGTITLE)
"RTN","MAGGNTI1",79,0)
 I MAGISC D  I 'MAGISC S MAGRY=MAGISC Q
"RTN","MAGGNTI1",80,0)
 . ;  See if a Consult DA was sent.
"RTN","MAGGNTI1",81,0)
 . IF 'MAGCNSLT S MAGISC="0^A Consult is needed to link to this note title"
"RTN","MAGGNTI1",82,0)
 . Q
"RTN","MAGGNTI1",83,0)
 I ('MAGISC)&(MAGCNSLT) S MAGRY="0^Cannot Link Consult with a Non Consult Title" Q
"RTN","MAGGNTI1",84,0)
 ;
"RTN","MAGGNTI1",85,0)
 ;               make a VSTR for TIU Call.
"RTN","MAGGNTI1",86,0)
 S MAGVSTR=MAGLOC_";"_MAGDATE_";E"
"RTN","MAGGNTI1",87,0)
 ;
"RTN","MAGGNTI1",88,0)
 ; Call to NEW^TIUPNAPI wasn't doing what we needed. Now call TIU CREATE RECORD
"RTN","MAGGNTI1",89,0)
 ; MAKE(SUCCESS,DFN,TITLE,VDT,VLOC,VSIT,TIUX,VSTR,SUPPRESS,NOASF)                
"RTN","MAGGNTI1",90,0)
 D MAKE^TIUSRVP(.MAGTIUDA,MAGDFN,MAGTITLE,"",MAGLOC,"",.MAGTIUX,MAGVSTR)
"RTN","MAGGNTI1",91,0)
 I 'MAGTIUDA!(MAGTIUDA=-1) S MAGRY="0^Error creating Note"_$G(MAGTIUDA) Q
"RTN","MAGGNTI1",92,0)
 S MAGRY=MAGTIUDA_"^Note was created."
"RTN","MAGGNTI1",93,0)
 S MAGTY=MAGRY
"RTN","MAGGNTI1",94,0)
 ;
"RTN","MAGGNTI1",95,0)
 ;       ;Put in the Date that was sent.
"RTN","MAGGNTI1",96,0)
 I '$$VALID^MAGGSIV1(8925,1301,.MAGDATE,.MAGRES) S MAGRY=MAGRY_"  "_MAGRES
"RTN","MAGGNTI1",97,0)
 E  S MTXT(1301)=MAGDATE
"RTN","MAGGNTI1",98,0)
 ;
"RTN","MAGGNTI1",99,0)
 ; Update and LINK TO CONSULT if needed.
"RTN","MAGGNTI1",100,0)
 I MAGISC S MTXT("1405")=MAGCNSLT_";GMR(123,"
"RTN","MAGGNTI1",101,0)
 I $D(MTXT) D  I 'MUPD S MAGRY=MUPD Q
"RTN","MAGGNTI1",102,0)
 . D UPDATE^TIUSRVP(.MUPD,MAGTIUDA,.MTXT)
"RTN","MAGGNTI1",103,0)
 . Q
"RTN","MAGGNTI1",104,0)
 ;
"RTN","MAGGNTI1",105,0)
 ; If Admin Close, then We quit.
"RTN","MAGGNTI1",106,0)
 I MAGADCL="1" D  Q
"RTN","MAGGNTI1",107,0)
 . D ADMNCLOS^MAGGNTI2(.MAGTY,MAGDFN,MAGTIUDA,MAGMODE)
"RTN","MAGGNTI1",108,0)
 . S MAGRY=$S('MAGTY:MAGTY,1:MAGRY_"  Administrative Closure.")
"RTN","MAGGNTI1",109,0)
 . Q
"RTN","MAGGNTI1",110,0)
 ;
"RTN","MAGGNTI1",111,0)
 ; if caller sent esignature to Sign this Note.
"RTN","MAGGNTI1",112,0)
 I $L(MAGES) D
"RTN","MAGGNTI1",113,0)
 . D SIGN^MAGGNTI3(.MAGTY,MAGDFN,MAGTIUDA,MAGES,MAGESBY)
"RTN","MAGGNTI1",114,0)
 . S MAGRY=$S('MAGTY:MAGTY,1:MAGRY_"  Signed.")
"RTN","MAGGNTI1",115,0)
 . Q
"RTN","MAGGNTI1",116,0)
 Q
"RTN","MAGGNTI1",117,0)
 ;
"RTN","MAGGNTI1",118,0)
 ;(MAGRY,MAGDFN,MAGTITLE,MAGADCL,MAGMODE,MAGES,MAGESBY,MAGLOC,MAGTEXT)
"RTN","MAGGNTI1",119,0)
NEWADD(MAGRY,MAGDFN,MAGTIUDA,MAGADCL,MAGMODE,MAGES,MAGESBY,MAGDATE,MAGTEXT) ; RPC [MAG3 TIU CREATE ADDENDUM]
"RTN","MAGGNTI1",120,0)
 ;  RPC call to create an Addendum to a Note
"RTN","MAGGNTI1",121,0)
 ;  and Optionally :  
"RTN","MAGGNTI1",122,0)
 ;           Electronically Sign,
"RTN","MAGGNTI1",123,0)
 ;           Administratively Close,
"RTN","MAGGNTI1",124,0)
 ;           or Add Text to the Addendum
"RTN","MAGGNTI1",125,0)
 ;       
"RTN","MAGGNTI1",126,0)
 ;  - - -  Required  - - - 
"RTN","MAGGNTI1",127,0)
 ;  MAGDFN   - Patient DFN
"RTN","MAGGNTI1",128,0)
 ;  MAGTIUDA - IEN of TIU NOTE in file 8925
"RTN","MAGGNTI1",129,0)
 ;  - - -  Optional  - - - 
"RTN","MAGGNTI1",130,0)
 ;  MAGTEXT  - Array of Text to add to the New Note.
"RTN","MAGGNTI1",131,0)
 ;  MAGES    - The encrypted Electronic Signature
"RTN","MAGGNTI1",132,0)
 ;  MAGESBY  - The DUZ of the Signer (Defaults to DUZ)
"RTN","MAGGNTI1",133,0)
 ;  MAGADCL  - 1 = Mark this Note as Administratively Closed
"RTN","MAGGNTI1",134,0)
 ;  MAGMODE  - Mode of Admin Closure: "S" = Scanned Document "M" = Manual closure  "E" = Electronically Filed
"RTN","MAGGNTI1",135,0)
 ;  MAGDATE  - Date of the Addendum.
"RTN","MAGGNTI1",136,0)
 ;
"RTN","MAGGNTI1",137,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^"_$T(+0)
"RTN","MAGGNTI1",138,0)
 S MAGDFN=$G(MAGDFN),MAGTIUDA=$G(MAGTIUDA),MAGES=$G(MAGES),MAGADCL=$G(MAGADCL)
"RTN","MAGGNTI1",139,0)
 S MAGESBY=$S($G(MAGESBY):MAGESBY,1:DUZ),MAGMODE=$S($L($G(MAGMODE)):MAGMODE,1:"S")
"RTN","MAGGNTI1",140,0)
 S MAGDATE=$G(MAGDATE)
"RTN","MAGGNTI1",141,0)
 ;
"RTN","MAGGNTI1",142,0)
 I '$$VALDATA^MAGGNTI2(.MAGRY,MAGDFN,MAGTIUDA) Q
"RTN","MAGGNTI1",143,0)
 N MAGXT,I,CT,NEWTIUDA,MAGY,MAGRES
"RTN","MAGGNTI1",144,0)
 S CT=1,I=""
"RTN","MAGGNTI1",145,0)
 S MAGXT("TEXT",1,0)="VistA Imaging  Scanned Document - Addendum."
"RTN","MAGGNTI1",146,0)
 I $D(MAGTEXT) F  S I=$O(MAGTEXT(I)) Q:I=""  D
"RTN","MAGGNTI1",147,0)
 . S CT=CT+1,MAGXT("TEXT",CT,0)=MAGTEXT(I)
"RTN","MAGGNTI1",148,0)
 . Q
"RTN","MAGGNTI1",149,0)
 ;
"RTN","MAGGNTI1",150,0)
 ; Calling TIU CREATE ADDENDUM RECORD
"RTN","MAGGNTI1",151,0)
 D MAKEADD^TIUSRVP(.MAGRY,MAGTIUDA,.MAGXT)
"RTN","MAGGNTI1",152,0)
 ; MAGRY could be 0^error message
"RTN","MAGGNTI1",153,0)
 ;                                -1^message
"RTN","MAGGNTI1",154,0)
 ;                                TIUDA
"RTN","MAGGNTI1",155,0)
 I $P(MAGRY,"^")<0 S $P(MAGRY,"^")=0 Q
"RTN","MAGGNTI1",156,0)
 S NEWTIUDA=+MAGRY
"RTN","MAGGNTI1",157,0)
 S MAGRY=MAGRY_"^Addendum was created."
"RTN","MAGGNTI1",158,0)
 ;       
"RTN","MAGGNTI1",159,0)
 ;Put in the Date that was sent.
"RTN","MAGGNTI1",160,0)
 I '$$VALID^MAGGSIV1(8925,1301,.MAGDATE,.MAGRES) S MAGRY=MAGRY_"  "_MAGRES
"RTN","MAGGNTI1",161,0)
 E  D
"RTN","MAGGNTI1",162,0)
 . K X
"RTN","MAGGNTI1",163,0)
 . S X(1301)=MAGDATE
"RTN","MAGGNTI1",164,0)
 . S X(1211)=$$GET1^DIQ(8925,1211,MAGTIUDA,"I")
"RTN","MAGGNTI1",165,0)
 . D UPDATE^TIUSRVP(.MAGY,NEWTIUDA,.X)
"RTN","MAGGNTI1",166,0)
 . I 'MAGY S MAGRY=MAGRY_" TIU Data was Not Correctly Filed."
"RTN","MAGGNTI1",167,0)
 . Q
"RTN","MAGGNTI1",168,0)
 ;
"RTN","MAGGNTI1",169,0)
 ; if caller sent esignature to Sign this Addendum.
"RTN","MAGGNTI1",170,0)
 I $L(MAGES) D  Q
"RTN","MAGGNTI1",171,0)
 . D SIGN^MAGGNTI3(.MAGTY,MAGDFN,NEWTIUDA,MAGES,MAGESBY)
"RTN","MAGGNTI1",172,0)
 . S MAGRY=$S('MAGTY:MAGTY,1:MAGRY_"  Signed.")
"RTN","MAGGNTI1",173,0)
 . Q
"RTN","MAGGNTI1",174,0)
 ;
"RTN","MAGGNTI1",175,0)
 ; if caller wants to Admin Close this Addendum.
"RTN","MAGGNTI1",176,0)
 I MAGADCL="1" D  Q
"RTN","MAGGNTI1",177,0)
 . D ADMNCLOS^MAGGNTI2(.MAGTY,MAGDFN,NEWTIUDA,MAGMODE)
"RTN","MAGGNTI1",178,0)
 . S MAGRY=$S('MAGTY:MAGTY,1:MAGRY_"  Administrative Closure.")
"RTN","MAGGNTI1",179,0)
 . Q
"RTN","MAGGNTI1",180,0)
 Q
"RTN","MAGGNTI1",181,0)
MOD(MAGRY,MAGDFN,MAGTIUDA,MAGADCL,MAGMODE,MAGES,MAGESBY,MAGTEXT) ; RPC [MAG3 TIU MODIFY NOTE]
"RTN","MAGGNTI1",182,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^"_$T(+0)
"RTN","MAGGNTI1",183,0)
 S MAGDFN=$G(MAGDFN),MAGTIUDA=$G(MAGTIUDA)
"RTN","MAGGNTI1",184,0)
 S MAGADCL=$G(MAGADCL)
"RTN","MAGGNTI1",185,0)
 S MAGMODE=$S($L($G(MAGMODE)):MAGMODE,1:"S")
"RTN","MAGGNTI1",186,0)
 S MAGES=$G(MAGES)
"RTN","MAGGNTI1",187,0)
 S MAGESBY=$S($G(MAGESBY):MAGESBY,1:DUZ)
"RTN","MAGGNTI1",188,0)
 D MOD^MAGGNTI3(.MAGRY,MAGDFN,MAGTIUDA,MAGADCL,MAGMODE,MAGES,MAGESBY)
"RTN","MAGGNTI1",189,0)
 Q
"RTN","MAGGNTI1",190,0)
ERR ; ERROR TRAP
"RTN","MAGGNTI1",191,0)
 N ERR S ERR=$$EC^%ZOSV
"RTN","MAGGNTI1",192,0)
 S MAGRY="0^ETRAP: "_ERR
"RTN","MAGGNTI1",193,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGNTI1",194,0)
 Q
"RTN","MAGGNTI1",195,0)
SIGN(MAGRY,MAGDFN,MAGTIUDA,MAGES,MAGESBY) ;RPC [MAG3 TIU SIGN RECORD]
"RTN","MAGGNTI1",196,0)
 ; RPC Call to 'Sign' a Note. 
"RTN","MAGGNTI1",197,0)
 D SIGN^MAGGNTI3(.MAGRY,$G(MAGDFN),$G(MAGTIUDA),$G(MAGES),$G(MAGESBY))
"RTN","MAGGNTI1",198,0)
 Q
"RTN","MAGGNTI2")
0^16^B21362509
"RTN","MAGGNTI2",1,0)
MAGGNTI2 ;WOIFO/GEK - Imaging interface to TIU RPC Calls etc. ; 20 Nov 2006  12:18 PM
"RTN","MAGGNTI2",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGGNTI2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGNTI2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGNTI2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGNTI2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGNTI2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGNTI2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGNTI2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGNTI2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGNTI2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGNTI2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGNTI2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGNTI2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGNTI2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGNTI2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGNTI2",17,0)
 ;;
"RTN","MAGGNTI2",18,0)
 Q
"RTN","MAGGNTI2",19,0)
LIST(MAGRY,CLASS,MYLIST) ; RPC [MAG3 TIU LONG LIST OF TITLES]
"RTN","MAGGNTI2",20,0)
 ; Get a list of Document Titles
"RTN","MAGGNTI2",21,0)
 ; CLASS         = ("," delimited string of one or More of) "NOTE,DS,CONS,CP,SUR,<CLASS IEN>"
"RTN","MAGGNTI2",22,0)
 ;                             CLASS IEN is any IEN of TIU 8925.1  that is a Class
"RTN","MAGGNTI2",23,0)
 ;                "|" delimited string of Class| text | Direction
"RTN","MAGGNTI2",24,0)
 ; MYLIST                = [1|""]   optional
"RTN","MAGGNTI2",25,0)
 ;                               If MYLIST=1 then return
"RTN","MAGGNTI2",26,0)
 ;                               TIU PERSONAL TITLE LIST       PERSLIST^TIUSRVD 
"RTN","MAGGNTI2",27,0)
 ;                                       
"RTN","MAGGNTI2",28,0)
 ; Note : sending CLASS IEN isn't tested.
"RTN","MAGGNTI2",29,0)
 ; 
"RTN","MAGGNTI2",30,0)
 K MAGRY
"RTN","MAGGNTI2",31,0)
 ; was a Global, now leave it an Array, only getting 44
"RTN","MAGGNTI2",32,0)
 N I,T,CL,CLN,CLNOTE,CLDS,CLCP,CLCONS,CLSUR,IL,J,TX,TXC,TX2,TX1,DFLT
"RTN","MAGGNTI2",33,0)
 N INTXT,UPDN,TARR
"RTN","MAGGNTI2",34,0)
 S MYLIST=$G(MYLIST)
"RTN","MAGGNTI2",35,0)
 S INTXT=$P(CLASS,"|",2)
"RTN","MAGGNTI2",36,0)
 S UPDN=$S(+$P(CLASS,"|",3):+$P(CLASS,"|",3),1:1)
"RTN","MAGGNTI2",37,0)
 S CLASS=$P(CLASS,"|",1)
"RTN","MAGGNTI2",38,0)
 I $L(CLASS)=0 S MAGRY(0)="0^Invalid Selection Class." Q
"RTN","MAGGNTI2",39,0)
 S CLNOTE=3 ; It is hard coded in TIU code.  Note Class
"RTN","MAGGNTI2",40,0)
 S CLDS=244 ; It is hard coded in TIU code.  Discharge Summary Class
"RTN","MAGGNTI2",41,0)
 D CPCLASS^TIUCP(.CLCP)
"RTN","MAGGNTI2",42,0)
 D CNSLCLAS^TIUSRVD(.CLCONS)
"RTN","MAGGNTI2",43,0)
 D SURGCLAS^TIUSRVD(.CLSUR)
"RTN","MAGGNTI2",44,0)
 S MAGRY(0)="0^Error: While accessing a list of Note Titles."
"RTN","MAGGNTI2",45,0)
 S MAGRY(1)="key word^TITLE^CLASS"
"RTN","MAGGNTI2",46,0)
 S I=""
"RTN","MAGGNTI2",47,0)
 F I=1:1:$L(CLASS,",") D
"RTN","MAGGNTI2",48,0)
 . S CL=$P(CLASS,",",I)
"RTN","MAGGNTI2",49,0)
 . S CLN=$S(+CL:+CL,CL="NOTE":3,CL="DS":CLDS,CL="CP":CLCP,CL="CONS":CLCONS,CL="SUR":CLSUR,1:-1)
"RTN","MAGGNTI2",50,0)
 . I MYLIST D  Q
"RTN","MAGGNTI2",51,0)
 . . D MYLIST(CLN,.TARR)
"RTN","MAGGNTI2",52,0)
 . . I $O(TARR(""))'="" S MAGRY(0)="1^Personal List"
"RTN","MAGGNTI2",53,0)
 . . S J="" F  S J=$O(TARR(J)) Q:J=""  D
"RTN","MAGGNTI2",54,0)
 . . . S TX1=$P(TARR(J),"^",1)
"RTN","MAGGNTI2",55,0)
 . . . ; output has 'd' or 'i' as first character, we need to get rid of it.
"RTN","MAGGNTI2",56,0)
 . . . I $E(TX1)="d" S DFLT=$E(TX1,2,999),MAGRY(0)=DFLT_"^Personal list"
"RTN","MAGGNTI2",57,0)
 . . . S TX1=$E(TX1,2,999)
"RTN","MAGGNTI2",58,0)
 . . . S TX=$P(TARR(J),"^",2),TX2=$P(TX,"<",2) S:$L(TX2) TX=$P(TX,"<",1) S:$L(TX2) TX2="<"_TX2
"RTN","MAGGNTI2",59,0)
 . . . S MAGRY($O(MAGRY(""),-1)+1)=TX_"^"_TX2_"^"_CL_"|"_TX1
"RTN","MAGGNTI2",60,0)
 . . . Q
"RTN","MAGGNTI2",61,0)
 . . Q
"RTN","MAGGNTI2",62,0)
 . ; here add line as a break between Personal List and Start of Total List
"RTN","MAGGNTI2",63,0)
 . K TARR
"RTN","MAGGNTI2",64,0)
 . D BLDLIST(CLN,.TARR,INTXT,UPDN)
"RTN","MAGGNTI2",65,0)
 . S J="" F  S J=$O(TARR(J)) Q:J=""  D
"RTN","MAGGNTI2",66,0)
 . . S TX=$P(TARR(J),"^",2),TX2=$P(TX,"<",2) S:$L(TX2) TX=$P(TX,"<",1) S:$L(TX2) TX2="<"_TX2
"RTN","MAGGNTI2",67,0)
 . . S TX1=$P(TARR(J),"^",1)
"RTN","MAGGNTI2",68,0)
 . . S MAGRY($O(MAGRY(""),-1)+1)=TX_"^"_TX2_"^"_CL_"|"_TX1
"RTN","MAGGNTI2",69,0)
 . . Q
"RTN","MAGGNTI2",70,0)
 . Q
"RTN","MAGGNTI2",71,0)
 I '$D(MAGRY(2)) K MAGRY(1) S MAGRY(0)="0^0 Items match input: "_INTXT
"RTN","MAGGNTI2",72,0)
 E  S MAGRY(0)="1^Success"_"^"_$G(DFLT)_"^"
"RTN","MAGGNTI2",73,0)
 Q
"RTN","MAGGNTI2",74,0)
 ;
"RTN","MAGGNTI2",75,0)
MYLIST(CLN,TARR) ;
"RTN","MAGGNTI2",76,0)
 ; if not short list, default is listed twice, (This is how CPRS displays it)
"RTN","MAGGNTI2",77,0)
 K TARR
"RTN","MAGGNTI2",78,0)
 D PERSLIST^TIUSRVD(.TARR,DUZ,CLN)
"RTN","MAGGNTI2",79,0)
 Q
"RTN","MAGGNTI2",80,0)
BLDLIST(CLN,TARR,STC,UPDN) ;
"RTN","MAGGNTI2",81,0)
 ;
"RTN","MAGGNTI2",82,0)
 S UPDN=$S(+$G(UPDN):+$G(UPDN),1:1)
"RTN","MAGGNTI2",83,0)
 K TARR
"RTN","MAGGNTI2",84,0)
 D LONGLIST^TIUSRVD(.TARR,CLN,STC,UPDN)
"RTN","MAGGNTI2",85,0)
 Q
"RTN","MAGGNTI2",86,0)
ADMNCLOS(MAGRY,MAGDFN,MAGTIUDA,MAGMODE) ; calls TIU API to set as Admin Closed.
"RTN","MAGGNTI2",87,0)
 ; RPC Call to Administratively Close a TIU Note.  
"RTN","MAGGNTI2",88,0)
 ; - - - Required - - - 
"RTN","MAGGNTI2",89,0)
 ; MAGDFN    - Patient DFN
"RTN","MAGGNTI2",90,0)
 ; MAGTIUDA  - Note IEN in File 8925
"RTN","MAGGNTI2",91,0)
 ; - - - Optional - - - 
"RTN","MAGGNTI2",92,0)
 ; MAGMODE   - "S" Scanned Document "M" - Manual closure  "E" - Electronically Filed.
"RTN","MAGGNTI2",93,0)
 ;
"RTN","MAGGNTI2",94,0)
 S MAGDFN=$G(MAGDFN),MAGTIUDA=$G(MAGTIUDA),MAGMODE=$G(MAGMODE,"S")
"RTN","MAGGNTI2",95,0)
 I '$$VALDATA(.MAGRY,MAGDFN,MAGTIUDA) Q
"RTN","MAGGNTI2",96,0)
 ; Calling TIU SET ADMINISTRATIVE CLOSURE
"RTN","MAGGNTI2",97,0)
 ; MAGMODE can be "S" for SCANNED DOCUMENT  <- HIMS may get this changed
"RTN","MAGGNTI2",98,0)
 ;                                            to Electronically Filed.
"RTN","MAGGNTI2",99,0)
 ;             or "M" for MANUAL CLOSURE or "E" for ELECTONICALL FILE  
"RTN","MAGGNTI2",100,0)
 D ADMNCLOS^TIUSRVPT(.MAGRY,MAGTIUDA,MAGMODE)
"RTN","MAGGNTI2",101,0)
 ;   on success MAGRY  = MAGTIUDA
"RTN","MAGGNTI2",102,0)
 ;   on error   MAGRY  = 0^<message>
"RTN","MAGGNTI2",103,0)
 I MAGRY S MAGRY=MAGRY_"^Success: Administrative Closure."
"RTN","MAGGNTI2",104,0)
 Q
"RTN","MAGGNTI2",105,0)
VALES(X) ; Validate the esig
"RTN","MAGGNTI2",106,0)
 N MAGY S MAGY=0
"RTN","MAGGNTI2",107,0)
 D HASH^ROUTINE
"RTN","MAGGNTI2",108,0)
 I X]"",(X=$P($G(^VA(200,+DUZ,20)),U,4)) S MAGY=1
"RTN","MAGGNTI2",109,0)
 Q MAGY
"RTN","MAGGNTI2",110,0)
VALDATA(RY,MAGDFN,MAGTIUDA) ; Validate the TIUDA and the DFN
"RTN","MAGGNTI2",111,0)
 S MAGTIUDA=$G(MAGTIUDA),MAGDFN=$G(MAGDFN)
"RTN","MAGGNTI2",112,0)
 I 'MAGDFN S RY="0^Invalid data: Patient DFN invalid: "_MAGDFN Q 0
"RTN","MAGGNTI2",113,0)
 I '$D(^DPT(+MAGDFN,0)) S RY="0^Invalid data: Patient DFN invalid: "_MAGDFN Q 0
"RTN","MAGGNTI2",114,0)
 I 'MAGTIUDA S RY="0^Invalid Note IEN: "_MAGTIUDA Q 0
"RTN","MAGGNTI2",115,0)
 I '$D(^TIU(8925,MAGTIUDA,0)) S RY="0^Invalid Note IEN: "_MAGTIUDA Q 0
"RTN","MAGGNTI2",116,0)
 I $P(^TIU(8925,MAGTIUDA,0),"^",2)'=MAGDFN S RY="0^Invalid Patient DFN: "_MAGDFN_" for Note: "_MAGTIUDA Q 0
"RTN","MAGGNTI2",117,0)
 S RY="1^Validated OK."
"RTN","MAGGNTI2",118,0)
 Q 1
"RTN","MAGGNTI3")
0^17^B11337599
"RTN","MAGGNTI3",1,0)
MAGGNTI3 ;WOIFO/GEK - Imaging interface to TIU RPC Calls etc. ; 04 Apr 2002  2:37 PM
"RTN","MAGGNTI3",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGGNTI3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGNTI3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGNTI3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGNTI3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGNTI3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGNTI3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGNTI3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGNTI3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGNTI3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGNTI3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGNTI3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGNTI3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGNTI3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGNTI3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGNTI3",17,0)
 ;;
"RTN","MAGGNTI3",18,0)
 Q
"RTN","MAGGNTI3",19,0)
MOD(MAGRY,MAGDFN,MAGTIUDA,MAGADCL,MAGMODE,MAGES,MAGESBY,MAGTEXT) ; RPC [MAG3 TIU MODIFY NOTE]
"RTN","MAGGNTI3",20,0)
 ;  RPC call to Modify an Existing Note by: 
"RTN","MAGGNTI3",21,0)
 ;           Electronically Signing or
"RTN","MAGGNTI3",22,0)
 ;           Administratively Closing the Note
"RTN","MAGGNTI3",23,0)
 ;
"RTN","MAGGNTI3",24,0)
 ;  - - -  Required  - - - 
"RTN","MAGGNTI3",25,0)
 ;  MAGDFN   - Patient DFN
"RTN","MAGGNTI3",26,0)
 ;  MAGTIUDA - IEN of TIU NOTE in file 8925
"RTN","MAGGNTI3",27,0)
 ;  - - -  Optional  - - - 
"RTN","MAGGNTI3",28,0)
 ;  MAGADCL  - 1 = Mark this Note as Administratively Closed
"RTN","MAGGNTI3",29,0)
 ;  MAGMODE  - Mode of Admin Closure: "S" = Scanned Document "M" = Manual closure
"RTN","MAGGNTI3",30,0)
 ;  MAGES    - The encrypted Electronic Signature
"RTN","MAGGNTI3",31,0)
 ;  MAGESBY  - The DUZ of the Signer (Defaults to DUZ)
"RTN","MAGGNTI3",32,0)
 ;  MAGTEXT  - Array of Text to add to the New Note. // NOT USED IN 3.0.59
"RTN","MAGGNTI3",33,0)
 ;
"RTN","MAGGNTI3",34,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^"_$T(+0)
"RTN","MAGGNTI3",35,0)
 S MAGDFN=$G(MAGDFN),MAGTIUDA=$G(MAGTIUDA)
"RTN","MAGGNTI3",36,0)
 S MAGES=$G(MAGES),MAGADCL=$G(MAGADCL)
"RTN","MAGGNTI3",37,0)
 S MAGESBY=$S($G(MAGESBY):MAGESBY,1:DUZ)
"RTN","MAGGNTI3",38,0)
 S MAGMODE=$S($L($G(MAGMODE)):MAGMODE,1:"S")
"RTN","MAGGNTI3",39,0)
 I '$$VALDATA^MAGGNTI2(.MAGRY,MAGDFN,MAGTIUDA) Q
"RTN","MAGGNTI3",40,0)
 N MAGXT,I,CT,MAGMRC,X
"RTN","MAGGNTI3",41,0)
 S CT=1,I=""
"RTN","MAGGNTI3",42,0)
 ; We don't allow Editing/Adding of Text to an existing document.
"RTN","MAGGNTI3",43,0)
 ; If Change Status to Admin Close. Then we Quit
"RTN","MAGGNTI3",44,0)
 S MAGRY="1^"
"RTN","MAGGNTI3",45,0)
 I MAGADCL="1" D  Q:'MAGRY
"RTN","MAGGNTI3",46,0)
 . D ADMNCLOS^MAGGNTI2(.MAGTY,MAGDFN,MAGTIUDA,MAGMODE)
"RTN","MAGGNTI3",47,0)
 . S MAGRY=$S('MAGTY:MAGTY,1:MAGRY_"Note is Administratively Closed.")
"RTN","MAGGNTI3",48,0)
 . S ^TMP($J,"MAGGNTI1","MOD AFTER ADMNCLOS ")=MAGRY
"RTN","MAGGNTI3",49,0)
 . Q:'MAGRY
"RTN","MAGGNTI3",50,0)
 . ; Note has been E-Filed  Complete the Consult if one is attached.
"RTN","MAGGNTI3",51,0)
 . D GET1405^TIUSRVR(.MAGMRC,MAGTIUDA)
"RTN","MAGGNTI3",52,0)
 . S ^TMP($J,"MAGGNTI1","MOD MAGMRC")=$G(MAGMRC)
"RTN","MAGGNTI3",53,0)
 . I (+MAGMRC>0)&(MAGMRC["GMR(123") D
"RTN","MAGGNTI3",54,0)
 . . ;Use GRMC Call to 'Close' the consult. For AdminClos the Consult Status
"RTN","MAGGNTI3",55,0)
 . . ;went from 'p' to 'pr'  this will change it to 'c' (complete).        
"RTN","MAGGNTI3",56,0)
 . . S X=$$SFILE^GMRCGUIB(+MAGMRC,10)
"RTN","MAGGNTI3",57,0)
 . . Q
"RTN","MAGGNTI3",58,0)
 . Q
"RTN","MAGGNTI3",59,0)
 ;
"RTN","MAGGNTI3",60,0)
 ; if caller sent esignature to Sign this Addendum.
"RTN","MAGGNTI3",61,0)
 I $L(MAGES) D  Q:'MAGRY
"RTN","MAGGNTI3",62,0)
 . D SIGN(.MAGTY,MAGDFN,MAGTIUDA,MAGES,MAGESBY)
"RTN","MAGGNTI3",63,0)
 . S MAGRY=$S('MAGTY:MAGTY,1:MAGRY_"Note is Signed.")
"RTN","MAGGNTI3",64,0)
 . Q
"RTN","MAGGNTI3",65,0)
 Q
"RTN","MAGGNTI3",66,0)
SIGN(MAGRY,MAGDFN,MAGTIUDA,MAGES,MAGESBY) ;RPC [MAG3 TIU SIGN RECORD]
"RTN","MAGGNTI3",67,0)
 ; RPC Call to 'Sign' a Note.  
"RTN","MAGGNTI3",68,0)
 ; - - - Required - - - 
"RTN","MAGGNTI3",69,0)
 ; MAGDFN    - DFN of Patient.
"RTN","MAGGNTI3",70,0)
 ; MAGTIUDA  - TIUDA - IEN of TIU Note file 8925
"RTN","MAGGNTI3",71,0)
 ; MAGES     - The encrypted Electronic Signature
"RTN","MAGGNTI3",72,0)
 ; MAGESBY   - The DUZ of the Signer (Defaults to DUZ)
"RTN","MAGGNTI3",73,0)
 ; 
"RTN","MAGGNTI3",74,0)
 N RY
"RTN","MAGGNTI3",75,0)
 S MAGDFN=$G(MAGDFN),MAGTIUDA=$G(MAGTIUDA),MAGES=$G(MAGES),MAGESBY=$G(MAGESBY,DUZ)
"RTN","MAGGNTI3",76,0)
 I '$$VALDATA^MAGGNTI2(.MAGRY,MAGDFN,MAGTIUDA) Q
"RTN","MAGGNTI3",77,0)
 ;
"RTN","MAGGNTI3",78,0)
 ; Calling TIU SIGN RECORD
"RTN","MAGGNTI3",79,0)
 D SIGN^TIUSRVP(.RY,MAGTIUDA,MAGES)
"RTN","MAGGNTI3",80,0)
 ;   on success   RY = 0
"RTN","MAGGNTI3",81,0)
 ;   on error RY = error code ^ < message >
"RTN","MAGGNTI3",82,0)
 I +RY S MAGRY="0^"_$TR(RY,"^","~")
"RTN","MAGGNTI3",83,0)
 E  S MAGRY="1^Success: Note has been Signed."
"RTN","MAGGNTI3",84,0)
 Q
"RTN","MAGGNTI3",85,0)
ERR ; ERROR TRAP
"RTN","MAGGNTI3",86,0)
 N ERR S ERR=$$EC^%ZOSV
"RTN","MAGGNTI3",87,0)
 S MAGRY="0^ETRAP: "_ERR
"RTN","MAGGNTI3",88,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGNTI3",89,0)
 Q
"RTN","MAGGTPT1")
0^18^B31690840
"RTN","MAGGTPT1",1,0)
MAGGTPT1 ;WOIFO/GEK - Delphi-Broker calls for patient lookup and information ; [ 06/20/2001 08:57 ]
"RTN","MAGGTPT1",2,0)
 ;;3.0;IMAGING;**16,8,92,46**;16-February-2007;;Build 1023
"RTN","MAGGTPT1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTPT1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTPT1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTPT1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTPT1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTPT1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTPT1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTPT1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTPT1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTPT1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTPT1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTPT1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTPT1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTPT1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTPT1",17,0)
 ;;
"RTN","MAGGTPT1",18,0)
 Q
"RTN","MAGGTPT1",19,0)
 ;
"RTN","MAGGTPT1",20,0)
FIND(MAGRY,ZY) ;RPC [MAGG PAT FIND]
"RTN","MAGGTPT1",21,0)
 ; Call to Do a lookup using FIND^DIC
"RTN","MAGGTPT1",22,0)
 ; MAGRY is the Array to return.
"RTN","MAGGTPT1",23,0)
 ; ZY is parameter sent by calling app (Delphi)
"RTN","MAGGTPT1",24,0)
 ;     NUM TO RETURN ^ TEXT TO MATCH ^  ^ ^ SCREEN ($P 5-99)
"RTN","MAGGTPT1",25,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGTERR"
"RTN","MAGGTPT1",26,0)
 ;
"RTN","MAGGTPT1",27,0)
 N X,Y,I,Z,MAGDFN,WARD
"RTN","MAGGTPT1",28,0)
 N FILE,IENS,FLDS,FLAGS,VAL,NUM,INDEX,SCR,IDENT,TROOT
"RTN","MAGGTPT1",29,0)
 S (FILE,IENS,FLDS,FLAGS,VAL,NUM,INDEX,SCR,IDENT,TROOT)=""
"RTN","MAGGTPT1",30,0)
 ;
"RTN","MAGGTPT1",31,0)
 S FILE=2 ; Patient File
"RTN","MAGGTPT1",32,0)
 ;          Number of entries to return, If 0 we'll stop at 100
"RTN","MAGGTPT1",33,0)
 S NUM=$S(+$P(ZY,U,1):+$P(ZY,U,1),1:100)
"RTN","MAGGTPT1",34,0)
 S VAL=$P(ZY,U,2) ; this is the starting value i.e. 'Smi'
"RTN","MAGGTPT1",35,0)
 S SCR=$P(ZY,U,5,99)
"RTN","MAGGTPT1",36,0)
 S FLDS=$P(ZY,U,3)
"RTN","MAGGTPT1",37,0)
 ; $P(ZU,U,4) isn't used.
"RTN","MAGGTPT1",38,0)
 ;  If specific fields aren't requested, 
"RTN","MAGGTPT1",39,0)
 ;     Get Identifiers, and ward as FLDS
"RTN","MAGGTPT1",40,0)
 ;I '$L(FLDS) S FLDS=FLDS_";.1;.03;.09;.301;391"
"RTN","MAGGTPT1",41,0)
 I '$L(FLDS) S FLDS=FLDS_";.1;.301;391"
"RTN","MAGGTPT1",42,0)
 ;  we'll add ACN to the index to search, for ward
"RTN","MAGGTPT1",43,0)
 ; for speed we'll decide which xref to use
"RTN","MAGGTPT1",44,0)
 S INDEX=$S(VAL?9N:"SSN^ACN",VAL?1U1.N:"BS5^ACN",1:"B^ACN")
"RTN","MAGGTPT1",45,0)
 ;
"RTN","MAGGTPT1",46,0)
 K ^TMP("DILIST",$J)
"RTN","MAGGTPT1",47,0)
 K ^TMP("DIERR",$J)
"RTN","MAGGTPT1",48,0)
 ;  VAL is the initial value to search for. i.e. the user input.
"RTN","MAGGTPT1",49,0)
 ;  Next line is to stop the FM Infinite Error Trap problem.
"RTN","MAGGTPT1",50,0)
 I $L(VAL)>30 S MAGRY(0)="0^Invalid: Input '"_$E(VAL,1,40)_"...' is too long. "_$L(VAL)_" characters." Q
"RTN","MAGGTPT1",51,0)
 D FIND^DIC(FILE,IENS,FLDS,FLAGS,VAL,NUM,INDEX,SCR,IDENT,TROOT)
"RTN","MAGGTPT1",52,0)
 ;
"RTN","MAGGTPT1",53,0)
 ;  if no Match or ERROR  we return 0 as 1st '^' piece.
"RTN","MAGGTPT1",54,0)
 ;
"RTN","MAGGTPT1",55,0)
 I '$D(^TMP("DILIST",$J,1)) S I=1 D  Q
"RTN","MAGGTPT1",56,0)
 . I $D(^TMP("DIERR",$J)) D FINDERR(I) Q
"RTN","MAGGTPT1",57,0)
 . S MAGRY(I)="NO MATCH for lookup on """_$P(ZY,"^",2)_""""
"RTN","MAGGTPT1",58,0)
 ;
"RTN","MAGGTPT1",59,0)
 ;  so we have some matches, (BUT we could still have an error)
"RTN","MAGGTPT1",60,0)
 ;  so first list all matches, then the Errors, if any.
"RTN","MAGGTPT1",61,0)
 S I="" F  S I=$O(^TMP("DILIST",$J,1,I)) Q:I=""  D
"RTN","MAGGTPT1",62,0)
 . S X=^TMP("DILIST",$J,1,I) ; Name
"RTN","MAGGTPT1",63,0)
 . S MAGDFN=^TMP("DILIST",$J,2,I) ; DFN
"RTN","MAGGTPT1",64,0)
 . ;
"RTN","MAGGTPT1",65,0)
 . S WARD=^TMP("DILIST",$J,"ID",I,.1)
"RTN","MAGGTPT1",66,0)
 . K ^TMP("DILIST",$J,"ID",I,.1)
"RTN","MAGGTPT1",67,0)
 . I $E(WARD,1,$L(VAL))=VAL S X=WARD_"   "_X
"RTN","MAGGTPT1",68,0)
 . ;
"RTN","MAGGTPT1",69,0)
 . S X=X_"   "_$$DOB^DPTLK1(MAGDFN)_"   "_$$SSN^DPTLK1(MAGDFN)
"RTN","MAGGTPT1",70,0)
 . S Z=0
"RTN","MAGGTPT1",71,0)
 . ; We are displaying other identifiers with each patient.
"RTN","MAGGTPT1",72,0)
 . F  S Z=$O(^TMP("DILIST",$J,"ID",I,Z)) Q:Z=""  S X=X_"   "_^(Z)
"RTN","MAGGTPT1",73,0)
 . S MAGRY(I)=X_"^"_+MAGDFN
"RTN","MAGGTPT1",74,0)
 ;
"RTN","MAGGTPT1",75,0)
 I $D(^TMP("DIERR",$J)) D FINDERR() Q
"RTN","MAGGTPT1",76,0)
 I '$D(^TMP("DILIST",$J,0)) Q
"RTN","MAGGTPT1",77,0)
 S X=^TMP("DILIST",$J,0)
"RTN","MAGGTPT1",78,0)
 S I=$O(MAGRY(""),-1)+1
"RTN","MAGGTPT1",79,0)
 S MAGRY(0)="Found "_$P(X,"^")_" entr"_$S((+X=1):"y",1:"ies")_" matching """_$P(ZY,"^",3)_""""
"RTN","MAGGTPT1",80,0)
 I $P(X,"^",3)>0 S MAGRY(0)=MAGRY(0)_" there are more"
"RTN","MAGGTPT1",81,0)
 Q
"RTN","MAGGTPT1",82,0)
FINDERR(XI) ;
"RTN","MAGGTPT1",83,0)
 I '+$G(XI) S XI=$O(MAGRY(""),-1)+1
"RTN","MAGGTPT1",84,0)
 S MAGRY(XI)="ERROR^"_^TMP("DIERR",$J,1,"TEXT",1)
"RTN","MAGGTPT1",85,0)
 Q
"RTN","MAGGTPT1",86,0)
INFO(MAGRY,DATA) ;RPC [MAGG PAT INFO]  Call to  Return patient info.
"RTN","MAGGTPT1",87,0)
 ; Input parameters 
"RTN","MAGGTPT1",88,0)
 ;    DATA:  MAGDFN ^ NOLOG ^ ISICN
"RTN","MAGGTPT1",89,0)
 ;       MAGDFN -- Patient DFN
"RTN","MAGGTPT1",90,0)
 ;       NOLOG  -- 0/1; if 1, then do NOT update the Session log
"RTN","MAGGTPT1",91,0)
 ;       ISICN  -- 0/1  if 1, then this is an ICN, if 0 (default) this is a DFN ; Patch 41
"RTN","MAGGTPT1",92,0)
 ;  MAGRY is a string, we return the following :
"RTN","MAGGTPT1",93,0)
 ; //$P     1        2      3     4     5     6     7     8        9                     10
"RTN","MAGGTPT1",94,0)
 ; //    status ^   DFN ^ name ^ sex ^ DOB ^ SSN ^ S/C ^ TYPE ^ Veteran(y/n)  ^ Patient Image Count
"RTN","MAGGTPT1",95,0)
 ; //$P    11            12              13
"RTN","MAGGTPT1",96,0)
 ;        ICN       SITE Number   ^ Production Account 1/0
"RTN","MAGGTPT1",97,0)
 ; VADM(1)=Patient's name
"RTN","MAGGTPT1",98,0)
 ; VADM(5)=Patient's sex (M^MALE)
"RTN","MAGGTPT1",99,0)
 ; VADM(3)=Patient's DOB (internal^external)
"RTN","MAGGTPT1",100,0)
 ; VADM(2)=Patient's SSN (internal^external)
"RTN","MAGGTPT1",101,0)
 ; VAEL(3)=Patient's Service Connected? (#.301) (1=yes)
"RTN","MAGGTPT1",102,0)
 ; VAEL(4)=Patient's Veteran Y/N (#1901) (1=yes)
"RTN","MAGGTPT1",103,0)
 ; VAEL(6)=Patient's Type (#391) (internal^external)
"RTN","MAGGTPT1",104,0)
 ;
"RTN","MAGGTPT1",105,0)
 N MAGDFN,DFN,X,NOLOG,VADM,VAEL,VAERR,ISICN
"RTN","MAGGTPT1",106,0)
 S MAGDFN=$P(DATA,U),NOLOG=+$P(DATA,U,2),ISICN=+$P(DATA,U,3)
"RTN","MAGGTPT1",107,0)
 I ISICN D GETDFN^VAFCTFU1(.DFN,MAGDFN)
"RTN","MAGGTPT1",108,0)
 E  S DFN=+MAGDFN
"RTN","MAGGTPT1",109,0)
 D DEM^VADPT,ELIG^VADPT
"RTN","MAGGTPT1",110,0)
 I VAERR S MAGRY="0^"_"Entry not found in Patient file." Q
"RTN","MAGGTPT1",111,0)
 S X=$TR($$FMTE^XLFDT($P(VADM(3),"^"),"2FD")," ",0)
"RTN","MAGGTPT1",112,0)
 ; //           status ^   DFN ^ name ^ sex ^ DOB ^ SSN    ^ S/C ^ TYPE ^ Veteran(y/n)  ^ Patient Image Count
"RTN","MAGGTPT1",113,0)
 S $P(MAGRY,"^",1,2)="1^"_DFN
"RTN","MAGGTPT1",114,0)
 ;          Fields:      NAME,           SEX,      DATE OF BIRTH,    SSN
"RTN","MAGGTPT1",115,0)
 S $P(MAGRY,"^",3,6)=$G(VADM(1))_"^"_$P(VADM(5),"^",2)_"^"_X_"^"_$P(VADM(2),"^")
"RTN","MAGGTPT1",116,0)
 ;          Fields:  Service Connected?,       Type,                   Veteran Y/N?     
"RTN","MAGGTPT1",117,0)
 S $P(MAGRY,"^",7,9)=$S(+VAEL(3):"YES",1:"")_"^"_$P(VAEL(6),"^",2)_"^"_$S(+VAEL(4):"YES",1:"")
"RTN","MAGGTPT1",118,0)
 ;          Fields:  Patient Image Count   
"RTN","MAGGTPT1",119,0)
 S $P(MAGRY,"^",10)=$$IMGCT(DFN)_"^"
"RTN","MAGGTPT1",120,0)
 ;  Additions. for Patch 41
"RTN","MAGGTPT1",121,0)
 ;          Fields :   Patient ICN
"RTN","MAGGTPT1",122,0)
 S $P(MAGRY,"^",11)=$$GETICN^MPIF001(DFN)
"RTN","MAGGTPT1",123,0)
 S X=$$SITE^VASITE
"RTN","MAGGTPT1",124,0)
 ;          Fields:   Site Number       Prod Acct
"RTN","MAGGTPT1",125,0)
 S $P(MAGRY,"^",12)=$P($G(X),"^",3)_"^"_"1" ; We'll default to Production Account = Yes.
"RTN","MAGGTPT1",126,0)
 ; NEED KERNEL PATCH XU*8.0*284 FOR PROD^XUPROD
"RTN","MAGGTPT1",127,0)
 ;          Fields :   the Actual value for Prod Acct
"RTN","MAGGTPT1",128,0)
 I $L($T(PROD^XUPROD)) S $P(MAGRY,"^",13)=+$$PROD^XUPROD
"RTN","MAGGTPT1",129,0)
 S $P(MAGRY,"^",14)="^"
"RTN","MAGGTPT1",130,0)
 ; AGE
"RTN","MAGGTPT1",131,0)
 S $P(MAGRY,"^",15)=VADM(4)_"^"
"RTN","MAGGTPT1",132,0)
 D KVAR^VADPT,KVA^VADPT
"RTN","MAGGTPT1",133,0)
 I NOLOG  ; Don't update session log
"RTN","MAGGTPT1",134,0)
 ;  We'll track DFN:ICN
"RTN","MAGGTPT1",135,0)
 E  D ACTION^MAGGTAU("PAT^"_DFN_$S(ISICN:"-"_MAGDFN,1:""))
"RTN","MAGGTPT1",136,0)
 Q
"RTN","MAGGTPT1",137,0)
IMGCT(DFN) ; RETURN TOTAL NUMBER OF IMAGES FOR A PATIENT;
"RTN","MAGGTPT1",138,0)
 ;
"RTN","MAGGTPT1",139,0)
 N I,CT,RDT,PRX,IEN
"RTN","MAGGTPT1",140,0)
 S CT=0
"RTN","MAGGTPT1",141,0)
 S RDT="" F  S RDT=$O(^MAG(2005,"APDTPX",DFN,RDT)) Q:RDT=""  D
"RTN","MAGGTPT1",142,0)
 . S PRX="" F  S PRX=$O(^MAG(2005,"APDTPX",DFN,RDT,PRX)) Q:PRX=""  D
"RTN","MAGGTPT1",143,0)
 . . S IEN="" F  S IEN=$O(^MAG(2005,"APDTPX",DFN,RDT,PRX,IEN)) Q:IEN=""  S CT=CT+1
"RTN","MAGGTPT1",144,0)
 Q CT
"RTN","MAGGTPT1",145,0)
BS5CHK(MAGRY,MAGDFN) ;RPC [MAGG PAT BS5 CHECK]
"RTN","MAGGTPT1",146,0)
 ; Call to check the BS5 cross ref 
"RTN","MAGGTPT1",147,0)
 ; and see if any similar patients exist.
"RTN","MAGGTPT1",148,0)
 ; If yes, all matching patients will be listed and shown to the user.
"RTN","MAGGTPT1",149,0)
 ;
"RTN","MAGGTPT1",150,0)
 N MAGX,MAGDPT,XDFN,XSSN,CT,LNTH
"RTN","MAGGTPT1",151,0)
 S LNTH=0
"RTN","MAGGTPT1",152,0)
 S MAGRY(1)="-1^Error checking cross reference"
"RTN","MAGGTPT1",153,0)
 D GUIBS5A^DPTLK6(.MAGRY,MAGDFN)
"RTN","MAGGTPT1",154,0)
 I MAGRY(1)=0 Q
"RTN","MAGGTPT1",155,0)
 S CT=$O(MAGRY(""),-1)+1
"RTN","MAGGTPT1",156,0)
 S MAGRY(CT)=MAGRY(CT-1),MAGRY(CT-1)="0^ "
"RTN","MAGGTPT1",157,0)
 S I="" F  S I=$O(MAGRY(I)) Q:'I  D
"RTN","MAGGTPT1",158,0)
 . I $P(MAGRY(I),U)=0 Q
"RTN","MAGGTPT1",159,0)
 . I $L($P(MAGRY(I),U,3))>LNTH S LNTH=$L($P(MAGRY(I),U,3))
"RTN","MAGGTPT1",160,0)
 S LNTH=LNTH+1
"RTN","MAGGTPT1",161,0)
 S I=1 F  S I=$O(MAGRY(I)) Q:'I  D
"RTN","MAGGTPT1",162,0)
 . I $P(MAGRY(I),U)="0" S MAGRY(I)=$P(MAGRY(I),U,2) Q
"RTN","MAGGTPT1",163,0)
 . S XDFN=$P(MAGRY(I),U,2)
"RTN","MAGGTPT1",164,0)
 . I +XDFN=+MAGDFN S MAGX="   >>>>>> "
"RTN","MAGGTPT1",165,0)
 . E  S MAGX="          "
"RTN","MAGGTPT1",166,0)
 . S XSSN=$$SSN^DPTLK1(XDFN) I XSSN?9N S XSSN=$E(XSSN,1,3)_"-"_$E(XSSN,4,5)_"-"_$E(XSSN,6,9)
"RTN","MAGGTPT1",167,0)
 . S MAGDPT=$P(MAGRY(I),U,3),$E(MAGDPT,LNTH)=" "
"RTN","MAGGTPT1",168,0)
 . S MAGX=MAGX_MAGDPT_"   "_$$DOB^DPTLK1(XDFN)_"   "_XSSN
"RTN","MAGGTPT1",169,0)
 . S MAGRY(I)=MAGX
"RTN","MAGGTPT1",170,0)
 Q
"RTN","MAGGTU3")
0^19^B60295465
"RTN","MAGGTU3",1,0)
MAGGTU3 ;WOIFO/GEK - Silent calls for Imaging ; [ 06/20/2001 08:57 ]
"RTN","MAGGTU3",2,0)
 ;;3.0;IMAGING;**7,8,48,45,20,46**;16-February-2007;;Build 1023
"RTN","MAGGTU3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTU3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTU3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTU3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTU3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTU3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTU3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTU3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTU3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTU3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTU3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTU3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTU3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU3",17,0)
 ;;
"RTN","MAGGTU3",18,0)
 Q
"RTN","MAGGTU3",19,0)
IMAGEINF(MAGRY,IEN,NOCHK) ;RPC [MAGG IMAGE INFO] Call to return information for 1 image;
"RTN","MAGGTU3",20,0)
 ; IEN   =       Image IEN ^MAG(2005,IEN
"RTN","MAGGTU3",21,0)
 ; NOCHK =   If Flag = 1, then do not run QA check on this image.
"RTN","MAGGTU3",22,0)
 ; 
"RTN","MAGGTU3",23,0)
 N MAGFILE,Y,Z,MAGNOCHK
"RTN","MAGGTU3",24,0)
 I '$D(^MAG(2005,IEN)) D  Q
"RTN","MAGGTU3",25,0)
 . I $D(^MAG(2005.1,IEN)) S MAGRY(0)="0^Image : """_$P($G(^MAG(2005.1,IEN,2)),U,4)_""" has been deleted." Q
"RTN","MAGGTU3",26,0)
 . S MAGRY(0)="0^INVALID Image number "_IEN
"RTN","MAGGTU3",27,0)
 . Q
"RTN","MAGGTU3",28,0)
 ; MAGGTII queries the variable MAGNOCHK to run QA check or not.
"RTN","MAGGTU3",29,0)
 S MAGNOCHK=+$G(NOCHK)
"RTN","MAGGTU3",30,0)
 S MAGXX=IEN D INFO^MAGGTII ; this'll give us the  MAGFILE variable
"RTN","MAGGTU3",31,0)
 S Z=$P(^MAG(2005,IEN,0),U,7)
"RTN","MAGGTU3",32,0)
 I '$D(^DPT(Z)) S Z="1^Invalid patient pointer"
"RTN","MAGGTU3",33,0)
 E  S Z=Z_U_$P(^DPT(Z,0),U)
"RTN","MAGGTU3",34,0)
 S MAGRY(0)="1^"_MAGFILE
"RTN","MAGGTU3",35,0)
 S MAGRY(1)=Z ; dfn^name
"RTN","MAGGTU3",36,0)
 Q
"RTN","MAGGTU3",37,0)
USERINF2(MAGRY,MAGWRKID) ;RPC [MAGGUSER2] Return user info.
"RTN","MAGGTU3",38,0)
 ; MAGRY(1) = DUZ ^ FULL NAME  ^ INITIALS
"RTN","MAGGTU3",39,0)
 ; MAGRY(2) = Network UserName ^ PassWord.
"RTN","MAGGTU3",40,0)
 ; MAGRY(3) = MUSE Site number. ( default = 1)
"RTN","MAGGTU3",41,0)
 ; Node 4 is data from IMAGING SITE PARAMATERS File #2006.1 and INSTITUTION File #4
"RTN","MAGGTU3",42,0)
 ; MAGRY(4)= PLACE IEN  ^ SITE CODE ^ DUZ(2) ^ INSTITUTION NAME (.01) ^ $$CONSOLID ^ User's local STATION NUMBER (99)
"RTN","MAGGTU3",43,0)
 ; MAGRY(5) = +<CP Version>|0 ^ Version of CP installed on Server
"RTN","MAGGTU3",44,0)
 ; MAGRY(6) = Warning message if we can't resolve which Site Parameter entry to use.
"RTN","MAGGTU3",45,0)
 ; MAGRY(7) = Warning message  <reserved for future>
"RTN","MAGGTU3",46,0)
 ; MAGRY(8) = 1|0  1 = Production account    0 = Test Account (or couldn't determine) ;Patch 41
"RTN","MAGGTU3",47,0)
 ; MAGRY(9) = Vista Site Service PHYSICAL REFERENCE from Network Location File.
"RTN","MAGGTU3",48,0)
 ; MAGRY(10)=Domain Name
"RTN","MAGGTU3",49,0)
 ; MAGRY(11)=Primary Division IEN
"RTN","MAGGTU3",50,0)
 ; MAGRY(12)=Primary Division STATION NUMBER
"RTN","MAGGTU3",51,0)
 ;  
"RTN","MAGGTU3",52,0)
 N J,K,Y,MAGPLC,MAGWARN,MAGWARN1,VSRV,PHYREF ; DBI - SEB 9/20/2002
"RTN","MAGGTU3",53,0)
 S MAGPLC=0
"RTN","MAGGTU3",54,0)
 I $D(DUZ(2)) S MAGPLC=+$$PLACE^MAGBAPI(DUZ(2)) ; DBI - SEB 9/20/2002
"RTN","MAGGTU3",55,0)
 ;
"RTN","MAGGTU3",56,0)
 ; SET THE PARTITION VARIABLE MAGSYS   i.e.'IGK_Garrett's Desk'
"RTN","MAGGTU3",57,0)
 S MAGSYS=$G(MAGWRKID,"")
"RTN","MAGGTU3",58,0)
 I +$G(DUZ)=0 S MAGRY(0)="0^DUZ Undefined, Null or Zero" Q
"RTN","MAGGTU3",59,0)
 I 'MAGPLC D
"RTN","MAGGTU3",60,0)
 . S MAGWARN="Can't resolve Site Param, DUZ(2): "_$S($D(DUZ(2)):DUZ(2),1:"NULL")_" DUZ: "_DUZ
"RTN","MAGGTU3",61,0)
 . S MAGPLC=$$DUZ2PLC^MAGBAPIP(.MAGWARN1) ; DBI - SEB 9/20/2002
"RTN","MAGGTU3",62,0)
 . Q
"RTN","MAGGTU3",63,0)
 S MAGRY(0)="1^"
"RTN","MAGGTU3",64,0)
 ;          DUZ     FULL NAME                INITIALS
"RTN","MAGGTU3",65,0)
 S MAGRY(1)=DUZ_U_$$GET1^DIQ(200,DUZ_",",.01)_U_$$GET1^DIQ(200,DUZ_",",1)
"RTN","MAGGTU3",66,0)
 ; NOW NET STUFF
"RTN","MAGGTU3",67,0)
 I 'MAGPLC Q 
"RTN","MAGGTU3",68,0)
 ; Get info from IMAGING SITE PARAMETERS File
"RTN","MAGGTU3",69,0)
 ; get the Network UserName and PassWord.
"RTN","MAGGTU3",70,0)
 S MAGRY(2)=$P($G(^MAG(2006.1,MAGPLC,"NET")),U,1,2)
"RTN","MAGGTU3",71,0)
 ; get the default MUSE Site number.
"RTN","MAGGTU3",72,0)
 S MAGRY(3)=+$P($G(^MAG(2006.1,MAGPLC,"USERPREF")),U,2)
"RTN","MAGGTU3",73,0)
 ; default to 1 if nothing is entered in Site Parameters File
"RTN","MAGGTU3",74,0)
 I MAGRY(3)=0 S MAGRY(3)=1
"RTN","MAGGTU3",75,0)
 ; This SITEIEN^SITECODE^USER INSTITUTION IEN^INSTITUTION NAME^CONSOLIDATED^User's local STATION NUMBER
"RTN","MAGGTU3",76,0)
 ;  is  used by Display to determine location of Workstation
"RTN","MAGGTU3",77,0)
 ;  and used by Capture to determine the Write Location.
"RTN","MAGGTU3",78,0)
 S MAGRY(4)=MAGPLC_U_$$GET1^DIQ(2006.1,MAGPLC,.09)_U_$G(DUZ(2))_U_$$GET1^DIQ(2006.1,MAGPLC,.01,"E")
"RTN","MAGGTU3",79,0)
 S MAGJOB("PLC")=MAGPLC
"RTN","MAGGTU3",80,0)
 S MAGJOB("PLCODE")=$$GET1^DIQ(2006.1,MAGPLC,.09)
"RTN","MAGGTU3",81,0)
 S MAGRY(4)=MAGRY(4)_U_$$CONSOLID^MAGBAPI_U_$$GET1^DIQ(4,DUZ(2),99,"E")
"RTN","MAGGTU3",82,0)
 ; is CP installed at this site, the Front End will hide options
"RTN","MAGGTU3",83,0)
 ;  related to CP if not installed.
"RTN","MAGGTU3",84,0)
 S X=$$VERSION^XPDUTL("CLINICAL PROCEDURES")
"RTN","MAGGTU3",85,0)
 S MAGRY(5)=+X_U_X
"RTN","MAGGTU3",86,0)
 S MAGRY(6)=$G(MAGWARN)
"RTN","MAGGTU3",87,0)
 S MAGRY(7)=$G(MAGWARN1)
"RTN","MAGGTU3",88,0)
 S MAGRY(8)=$S($L($T(PROD^XUPROD)):+$$PROD^XUPROD,1:0)
"RTN","MAGGTU3",89,0)
 S VSRV=$P($G(^MAG(2006.1,MAGPLC,"NET")),"^",5)
"RTN","MAGGTU3",90,0)
 I VSRV I +$P($G(^MAG(2005.2,VSRV,0)),"^",6) S PHYREF=$P($G(^MAG(2005.2,VSRV,0)),"^",2)
"RTN","MAGGTU3",91,0)
 S MAGRY(9)=$G(PHYREF)
"RTN","MAGGTU3",92,0)
 S MAGRY(10)=$$KSP^XUPARAM("WHERE")
"RTN","MAGGTU3",93,0)
 S MAGRY(11)=$P($$SITE^VASITE(),"^")
"RTN","MAGGTU3",94,0)
 S MAGRY(12)=$P($$SITE^VASITE(),"^",3)
"RTN","MAGGTU3",95,0)
 Q
"RTN","MAGGTU3",96,0)
 ;
"RTN","MAGGTU3",97,0)
CATEGORY(MAGRY) ; RPC [MAGGDESCCAT] Call to return Mag Descriptive Categories in array
"RTN","MAGGTU3",98,0)
 ; for listing in a list box.
"RTN","MAGGTU3",99,0)
 N I,K,CT,Y
"RTN","MAGGTU3",100,0)
 S I=0,CT=0
"RTN","MAGGTU3",101,0)
 I '$D(^MAG(2005.81)) D  Q
"RTN","MAGGTU3",102,0)
 . S MAGRY(0)="0^ERROR Mag Descriptive Category File doesn't exist"
"RTN","MAGGTU3",103,0)
 F  S I=$O(^MAG(2005.81,"B",I)) Q:I=""  D
"RTN","MAGGTU3",104,0)
 . ;Next line adds ADMIN, CLIN 3rd piece of the data returned
"RTN","MAGGTU3",105,0)
 . S K=$O(^MAG(2005.81,"B",I,"")),CT=CT+1
"RTN","MAGGTU3",106,0)
 . S MAGRY(CT)=I_U_K_U_$P(^MAG(2005.81,K,0),U,2)
"RTN","MAGGTU3",107,0)
 S MAGRY(0)=CT_"^Categories on file"
"RTN","MAGGTU3",108,0)
 Q
"RTN","MAGGTU3",109,0)
USERKEYS(MAGKEY) ; RPC [MAGGUSERKEYS]
"RTN","MAGGTU3",110,0)
 ; Call to return an array of IMAGING Security Keys
"RTN","MAGGTU3",111,0)
 D USERKEYS^MAGGTU31(.MAGKEY)
"RTN","MAGGTU3",112,0)
 Q
"RTN","MAGGTU3",113,0)
MAIL(MAGRY,MAGFILE,MAGIEN) ;RPC [MAGG OFFLINE IMAGE ACCESSED]
"RTN","MAGGTU3",114,0)
 ;   Called to log an Offline Image accessed.
"RTN","MAGGTU3",115,0)
 ;   ^MAGQUEUE(2006.033,0) = OFFLINE IMAGES
"RTN","MAGGTU3",116,0)
 ;   User must edit 2006.033 by hand to mark images as OFFLINE.
"RTN","MAGGTU3",117,0)
 ;
"RTN","MAGGTU3",118,0)
 N FILEREF,PLATTER,A
"RTN","MAGGTU3",119,0)
 S MAGRY="0^Error : logging access to Off-Line Image"
"RTN","MAGGTU3",120,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGGTERR"
"RTN","MAGGTU3",121,0)
 S FILEREF=$$UP^XLFSTR($P(MAGFILE,"\",$L(MAGFILE,"\")))
"RTN","MAGGTU3",122,0)
 S PLATTER=$O(^MAGQUEUE(2006.033,"B",FILEREF,""))
"RTN","MAGGTU3",123,0)
 S PLATTER=$P(^MAGQUEUE(2006.033,PLATTER,0),U,2)
"RTN","MAGGTU3",124,0)
 I MAGFILE[".ABS" Q
"RTN","MAGGTU3",125,0)
 N XMDUZ,XMSUB,XMTEXT,XMY
"RTN","MAGGTU3",126,0)
 S XMDUZ=$S($D(DUZ):DUZ,1:.5)
"RTN","MAGGTU3",127,0)
 S XMSUB="Offline Image Request"
"RTN","MAGGTU3",128,0)
 S XMTEXT="A("
"RTN","MAGGTU3",129,0)
 S A(1)="Patient   : "_$P(^DPT($P($G(^MAG(2005,+MAGIEN,0)),U,7),0),U,1)
"RTN","MAGGTU3",130,0)
 S A(2)="FileName  : "_MAGFILE_"  "_MAGIEN
"RTN","MAGGTU3",131,0)
 S A(3)="Desc      : "_$P($G(^MAG(2005,MAGIEN,2)),U,4)
"RTN","MAGGTU3",132,0)
 S A(4)="Procedure : "_$P($G(^MAG(2005,MAGIEN,0)),U,8)
"RTN","MAGGTU3",133,0)
 S A(5)="Platter   : "_PLATTER
"RTN","MAGGTU3",134,0)
 S A(6)="User      : "_$$GET1^DIQ(200,DUZ_",",.01)_"("_$G(DUZ)_")"
"RTN","MAGGTU3",135,0)
 S XMY("G.OFFLINE IMAGE TRACKERS")="" D ^XMD
"RTN","MAGGTU3",136,0)
 S MAGRY="1^Message sent :  Offline Image Accessed"
"RTN","MAGGTU3",137,0)
 Q
"RTN","MAGGTU3",138,0)
LOGERROR(MAGRY,TEXT) ;RPC [MAGG LOG ERROR TEXT]
"RTN","MAGGTU3",139,0)
 ; Call to stuff error information from Delphi app into the Session file.
"RTN","MAGGTU3",140,0)
 Q:($P($G(MAGJOB("VERSION")),".",1,2))<"3.0"
"RTN","MAGGTU3",141,0)
 D LOGERR^MAGGTERR("---- New Error ----")
"RTN","MAGGTU3",142,0)
 S I="" F  S I=$O(TEXT(I)) Q:I=""  D LOGERR^MAGGTERR(TEXT(I))
"RTN","MAGGTU3",143,0)
 S MAGRY="1^Error text saved to Session file"
"RTN","MAGGTU3",144,0)
 Q
"RTN","MAGGTU3",145,0)
RSLVABS(MAGIEN,FILENAME) ;Resolve Abstract into the Default Bitmap 
"RTN","MAGGTU3",146,0)
 ; Return the default bitmap, If the image file extension resolves into a default bitmap
"RTN","MAGGTU3",147,0)
 ; MAGIEN        : Image internal entry number
"RTN","MAGGTU3",148,0)
 ; FILENAME      : ""  or Relative Path and Default Bitmap. ie ('.\BMP\magavi.bmp')
"RTN","MAGGTU3",149,0)
 N FTIEN,EXT ; 
"RTN","MAGGTU3",150,0)
 S FILENAME=""
"RTN","MAGGTU3",151,0)
 I '$D(^MAG(2005.021)) Q  ; IMAGE FILE TYPES doesn't exist on this system.
"RTN","MAGGTU3",152,0)
 S EXT=$P($P(^MAG(2005,MAGIEN,0),"^",2),".",2) ; image file extension   JPG, TGA, etc.
"RTN","MAGGTU3",153,0)
 Q:EXT=""  ;
"RTN","MAGGTU3",154,0)
 S FTIEN=$O(^MAG(2005.021,"B",EXT,""))
"RTN","MAGGTU3",155,0)
 Q:'FTIEN  ; No extension in IMAGE FILE TYPES file.
"RTN","MAGGTU3",156,0)
 ; stop dependency on "c:\program files"
"RTN","MAGGTU3",157,0)
 I '+$P(^MAG(2005.021,FTIEN,0),"^",5) S FILENAME=".\BMP\"_$P(^MAG(2005.021,FTIEN,0),"^",4)
"RTN","MAGGTU3",158,0)
 Q
"RTN","MAGGTU3",159,0)
GETINFO(MAGRY,IEN) ; RPC [MAG4 GET IMAGE INFO]
"RTN","MAGGTU3",160,0)
 ; Call (3.0p8) to get information on 1 image
"RTN","MAGGTU3",161,0)
 N Y,J,JI,I,CT,IENC,FLAGS,SNGRP,Z,M40,T,QACHK
"RTN","MAGGTU3",162,0)
 S I=0,CT=0
"RTN","MAGGTU3",163,0)
 S MAGRY(CT)="Image ID#:      "_IEN
"RTN","MAGGTU3",164,0)
 I $D(^MAG(2005.1,IEN)) D  Q
"RTN","MAGGTU3",165,0)
 . S CT=CT+1,MAGRY(CT)="    STATUS:  "_"HAS BEEN DELETED. !!"
"RTN","MAGGTU3",166,0)
 . S CT=CT+1,MAGRY(CT)="Deleted By: "_$$GET1^DIQ(2005.1,IEN,30,"E")
"RTN","MAGGTU3",167,0)
 . S CT=CT+1,MAGRY(CT)="    Reason: "_$$GET1^DIQ(2005.1,IEN,30.2,"E")
"RTN","MAGGTU3",168,0)
 . S CT=CT+1,MAGRY(CT)="      Date: "_$$GET1^DIQ(2005.1,IEN,30.1,"E")
"RTN","MAGGTU3",169,0)
 . Q
"RTN","MAGGTU3",170,0)
 S M40=$G(^MAG(2005,IEN,40)),T=$P(M40,"^",3)
"RTN","MAGGTU3",171,0)
 S Z=$P($G(^MAG(2005,IEN,0)),"^",10) I Z D
"RTN","MAGGTU3",172,0)
 . S CT=CT+1,MAGRY(CT)=" is in Group#: "_Z_"  ("_+$P(^MAG(2005,Z,1,0),"^",4)_" images)"
"RTN","MAGGTU3",173,0)
 . D CHK^MAGGSQI(.QACHK,Z) Q:QACHK(0) 
"RTN","MAGGTU3",174,0)
 . S CT=CT+1,MAGRY(CT)=" QA Warning - Group#: "_Z_" "_$P(QACHK(0),"^",2)
"RTN","MAGGTU3",175,0)
 . Q
"RTN","MAGGTU3",176,0)
 S SNGRP="FLDS"
"RTN","MAGGTU3",177,0)
 I (+$O(^MAG(2005,IEN,1,0)))!($P(^MAG(2005,IEN,0),"^",6)=11)!($P(^MAG(2005,IEN,0),"^",6)=16) D
"RTN","MAGGTU3",178,0)
 . S CT=CT+1,MAGRY(CT)=$P(^MAG(2005,IEN,0),"^",8)_" Group of "_+$P($G(^MAG(2005,IEN,1,0)),U,4)
"RTN","MAGGTU3",179,0)
 . S SNGRP="FLDG"
"RTN","MAGGTU3",180,0)
 . Q
"RTN","MAGGTU3",181,0)
 K QACHK
"RTN","MAGGTU3",182,0)
 D CHK^MAGGSQI(.QACHK,IEN) I 'QACHK(0) D
"RTN","MAGGTU3",183,0)
 . S CT=CT+1,MAGRY(CT)=" QA Warning - Image#: "_IEN_" "_$P(QACHK(0),"^",2)
"RTN","MAGGTU3",184,0)
 N MAGOUT,MAGERR,MAGVAL
"RTN","MAGGTU3",185,0)
 S IENC=IEN_","
"RTN","MAGGTU3",186,0)
 S FLAGS="EN"
"RTN","MAGGTU3",187,0)
 S I=-1
"RTN","MAGGTU3",188,0)
 F  S I=I+1,Z=$T(@SNGRP+I) Q:$P(Z,";",3)="end"  D
"RTN","MAGGTU3",189,0)
 . S J=$P(Z,";",4),JI=J_";"
"RTN","MAGGTU3",190,0)
 . K MAGOUT
"RTN","MAGGTU3",191,0)
 . S CT=CT+1,MAGRY(CT)=$P(Z,";",3)
"RTN","MAGGTU3",192,0)
 . I J=41 D  Q  ; Need to compute the Class.  Class field in Image File is wrong.
"RTN","MAGGTU3",193,0)
 . . S MAGVAL=$S('T:"",'$D(^MAG(2005.83,T,0)):"",1:$P(^MAG(2005.82,$P(^MAG(2005.83,T,0),"^",2),0),"^",1))
"RTN","MAGGTU3",194,0)
 . . S MAGRY(CT)=MAGRY(CT)_" "_MAGVAL
"RTN","MAGGTU3",195,0)
 . . Q
"RTN","MAGGTU3",196,0)
 . D GETS^DIQ(2005,IEN,JI,FLAGS,"MAGOUT","MAGERR")
"RTN","MAGGTU3",197,0)
 . ; Get Extension from FileRef
"RTN","MAGGTU3",198,0)
 . I J=1 S MAGVAL=$P($G(MAGOUT(2005,IENC,J,"E")),".",2)
"RTN","MAGGTU3",199,0)
 . E  S MAGVAL=$G(MAGOUT(2005,IENC,J,"E"))
"RTN","MAGGTU3",200,0)
 . S MAGRY(CT)=MAGRY(CT)_" "_MAGVAL
"RTN","MAGGTU3",201,0)
 ; Compare Parent Association Date with Date/Time Note Signed.
"RTN","MAGGTU3",202,0)
 I $P(^MAG(2005,IEN,0),"^",10) S IEN=$P(^MAG(2005,IEN,0),"^",10)
"RTN","MAGGTU3",203,0)
 I $P(^MAG(2005,IEN,2),"^",6)=8925 S CT=CT+1,MAGRY(CT)=$$ATTSTAT^MAGGTU31(IEN)
"RTN","MAGGTU3",204,0)
 Q
"RTN","MAGGTU3",205,0)
 ;
"RTN","MAGGTU3",206,0)
FLDS ;;Format:       ;3;;
"RTN","MAGGTU3",207,0)
 ;;Extension:    ;1;;
"RTN","MAGGTU3",208,0)
FLDG ;;Patient:      ;5;;
"RTN","MAGGTU3",209,0)
 ;;Desc:         ;10;;
"RTN","MAGGTU3",210,0)
 ;;Procedure:    ;6;;
"RTN","MAGGTU3",211,0)
 ;;     Date:    ;15;;
"RTN","MAGGTU3",212,0)
 ;;Class:        ;41;;
"RTN","MAGGTU3",213,0)
 ;;Package:      ;40;;
"RTN","MAGGTU3",214,0)
 ;;Type:         ;42;;
"RTN","MAGGTU3",215,0)
 ;;Proc/Event:   ;43;;
"RTN","MAGGTU3",216,0)
 ;;Spec/SubSpec: ;44;;
"RTN","MAGGTU3",217,0)
 ;;Origin:       ;45;;
"RTN","MAGGTU3",218,0)
 ;;Captured on:  ;7;;
"RTN","MAGGTU3",219,0)
 ;;         by:  ;8;;
"RTN","MAGGTU3",220,0)
 ;;end;;
"RTN","MAGGTU31")
0^20^B11386631
"RTN","MAGGTU31",1,0)
MAGGTU31 ;WOIFO/GEK - Silent calls for Imaging ; [ 06/20/2001 08:57 ]
"RTN","MAGGTU31",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGGTU31",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTU31",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU31",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTU31",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTU31",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTU31",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTU31",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTU31",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTU31",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTU31",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTU31",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTU31",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTU31",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTU31",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU31",17,0)
 ;;
"RTN","MAGGTU31",18,0)
 Q
"RTN","MAGGTU31",19,0)
ATTSTAT(IEN) ; Return a sentence saying if the Image was attached
"RTN","MAGGTU31",20,0)
 ; to the TIU NOte before or after the Note was signed.
"RTN","MAGGTU31",21,0)
 ; was signed.
"RTN","MAGGTU31",22,0)
 N SIGNDT,NOTE,MARR,AMMEND,N2,MAGDT,NC,CLOSDT,X
"RTN","MAGGTU31",23,0)
 S N2=$G(^MAG(2005,IEN,2))
"RTN","MAGGTU31",24,0)
 I $P(N2,"^",6)'=8925 Q ""
"RTN","MAGGTU31",25,0)
 S MAGDT=$S($P(N2,"^",11):$P(N2,"^",11),1:$P(N2,"^",1))
"RTN","MAGGTU31",26,0)
 S NOTE=$P(N2,"^",7)
"RTN","MAGGTU31",27,0)
 S NC=NOTE_","
"RTN","MAGGTU31",28,0)
 D GETS^DIQ(8925,NOTE,".01;.06;1501;1606","I","MARR")
"RTN","MAGGTU31",29,0)
 I $D(DIERR) Q "Error: Note-"_NOTE_" : "_$G(^TMP("DIERR",$J,1,"TEXT",1))
"RTN","MAGGTU31",30,0)
 I (MARR(8925,NC,".01","I")=81)!(MARR(8925,NC,".06","I")>0) Q "Image is attached to an Addendum"
"RTN","MAGGTU31",31,0)
 S SIGNDT=MARR(8925,NC,"1501","I")
"RTN","MAGGTU31",32,0)
 S CLOSDT=MARR(8925,NC,"1606","I")
"RTN","MAGGTU31",33,0)
 I CLOSDT]"" D  Q X
"RTN","MAGGTU31",34,0)
 . I $P(CLOSDT,".",2)="" S MAGDT=$P(MAGDT,".",1) I MAGDT=CLOSDT S X="Image was attached Same Day as Note was Electronically Filed." Q
"RTN","MAGGTU31",35,0)
 . I MAGDT>CLOSDT S X="Image was attached After Note was Electronically Filed." Q
"RTN","MAGGTU31",36,0)
 . S X="Image was attached Before Note was Electronically Filed." Q
"RTN","MAGGTU31",37,0)
 . Q
"RTN","MAGGTU31",38,0)
 I SIGNDT="" Q "Image is attached to an UnSigned Note."
"RTN","MAGGTU31",39,0)
 I $P(SIGNDT,".",2)="" S MAGDT=$P(MAGDT,".",1) I MAGDT=SIGNDT Q "Image was attached Same Day as Note was Signed."
"RTN","MAGGTU31",40,0)
 I MAGDT>SIGNDT Q "Image was attached After the Note was Signed."
"RTN","MAGGTU31",41,0)
 Q "Image was attached Before the Note was Signed."
"RTN","MAGGTU31",42,0)
USERKEYS(MAGK) ; RPC [MAGGUSERKEYS]  (called from MAGGTU3)
"RTN","MAGGTU31",43,0)
 N Y
"RTN","MAGGTU31",44,0)
 N MAGKS ; list of keys to send to XUS KEY CHECK
"RTN","MAGGTU31",45,0)
 N MAGKG ; list returned from XUS KEY CHECK
"RTN","MAGGTU31",46,0)
 N I,J,MAGMED,MAGKEY,MAGPLC
"RTN","MAGGTU31",47,0)
 K MAGK
"RTN","MAGGTU31",48,0)
 S MAGPLC=+$$PLACE^MAGBAPI(DUZ(2)) ; DBI - SEB 9/20/2002
"RTN","MAGGTU31",49,0)
 S MAGKEY=+$P($G(^MAG(2006.1,MAGPLC,"KEYS")),U)
"RTN","MAGGTU31",50,0)
 I 'MAGKEY S MAGK(0)="CAPTURE KEYS OFF"
"RTN","MAGGTU31",51,0)
 E  S MAGK(0)="CAPTURE KEYS ON"
"RTN","MAGGTU31",52,0)
 N X S X="MAG",I=0
"RTN","MAGGTU31",53,0)
 F  S X=$O(^XUSEC(X)) Q:$E(X,1,3)'="MAG"  D
"RTN","MAGGTU31",54,0)
 . S I=I+1,MAGKS(I)=X
"RTN","MAGGTU31",55,0)
 D OWNSKEY^XUSRB(.MAGKG,.MAGKS)
"RTN","MAGGTU31",56,0)
 S I=0,J=0,MAGMED=0
"RTN","MAGGTU31",57,0)
 F  S I=$O(MAGKG(I)) Q:I=""  D
"RTN","MAGGTU31",58,0)
 . Q:MAGKG(I)=0
"RTN","MAGGTU31",59,0)
 . S J=J+1,MAGK(J)=MAGKS(I)
"RTN","MAGGTU31",60,0)
 . I MAGKS(I)["MAGCAP MED" S MAGMED=1
"RTN","MAGGTU31",61,0)
 I MAGMED S J=J+1,MAGK(J)="MAGCAP MED"
"RTN","MAGGTU31",62,0)
 Q
"RTN","MAGGTU4")
0^21^B38056639
"RTN","MAGGTU4",1,0)
MAGGTU4 ;WOIFO/GEK - Testing callbacks for Delphi Doc Image Prototype ; 02/16/2007 13:37
"RTN","MAGGTU4",2,0)
 ;;3.0;IMAGING;**8,48,63,45,46**;16-February-2007;;Build 1023
"RTN","MAGGTU4",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTU4",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU4",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTU4",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTU4",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTU4",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTU4",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTU4",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTU4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTU4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTU4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTU4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTU4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTU4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU4",17,0)
 ;;
"RTN","MAGGTU4",18,0)
 Q
"RTN","MAGGTU4",19,0)
GETVER(SVRVER,SVRTVER,A) ;
"RTN","MAGGTU4",20,0)
 ; We Can't compute the Server's current version
"RTN","MAGGTU4",21,0)
 ; KIDS installs aren't all related to the Delphi Client.
"RTN","MAGGTU4",22,0)
 ; The Server Version SVRVER needs hardcoded to match the Delphi Client.
"RTN","MAGGTU4",23,0)
 ; and This Routine must be distributed whenever a new Client is
"RTN","MAGGTU4",24,0)
 S SVRVER="3.0.46"
"RTN","MAGGTU4",25,0)
 S SVRTVER=28 ; This is the T version that the server expects
"RTN","MAGGTU4",26,0)
 ; released Client will have the T version that the server expects
"RTN","MAGGTU4",27,0)
 S A("3.0.24")=5         ;Sept 2003
"RTN","MAGGTU4",28,0)
 S A("3.0.33")=11        ;June 2004
"RTN","MAGGTU4",29,0)
 S A("3.0.8")=49         ;Sept 2004
"RTN","MAGGTU4",30,0)
 S A("3.0.42")=1         ;n/a
"RTN","MAGGTU4",31,0)
 S A("3.0.48")=6         ;Mar  2005
"RTN","MAGGTU4",32,0)
 S A("3.0.63")=4         ;June 2005
"RTN","MAGGTU4",33,0)
 S A("3.0.45")=8         ;Sept 2005
"RTN","MAGGTU4",34,0)
 S A("3.0.59")=20        ;July 2006
"RTN","MAGGTU4",35,0)
 Q
"RTN","MAGGTU4",36,0)
 ;
"RTN","MAGGTU4",37,0)
CHKVER(MAGRY,CLVER) ;RPC [MAG4 VERSION CHECK]
"RTN","MAGGTU4",38,0)
 ; CLVER is the version of the Delphi Client.
"RTN","MAGGTU4",39,0)
 ; CLVER format = Major,Minor,Patch,T Version
"RTN","MAGGTU4",40,0)
 ; example : for Version 3.0 Patch 8 T 21 -->  CLVER=3.0.8.21
"RTN","MAGGTU4",41,0)
 ; Ver 2.5P9 (2.5.24.1) is first Delphi Ver that makes this call.
"RTN","MAGGTU4",42,0)
 ; CLVER may have Parameters attached to it in '|' pieces.
"RTN","MAGGTU4",43,0)
 ;           "CLVER|RIV"      this is a remote image view client
"RTN","MAGGTU4",44,0)
 ;           "CLVER|CAPTURE"  this is a Capture Client
"RTN","MAGGTU4",45,0)
 ;           "CLVER|DISPLAY"  this is a Display Client
"RTN","MAGGTU4",46,0)
 ; 3 possible return codes in 1st '^' piece of MAGRY(0).
"RTN","MAGGTU4",47,0)
 ; 0^message :   The Client will display the message and continue.
"RTN","MAGGTU4",48,0)
 ; 1^message :   The Client will continue without displaying any message.
"RTN","MAGGTU4",49,0)
 ; 2^message :   The Client will display the message and then Abort. (Terminate)
"RTN","MAGGTU4",50,0)
 ;    The message displayed is the 2nd '^' piece of (0) node
"RTN","MAGGTU4",51,0)
 ;    and all text of any other nodes. i.e. MAGRY(1..n)
"RTN","MAGGTU4",52,0)
 ;
"RTN","MAGGTU4",53,0)
 S CLVER=$G(CLVER)
"RTN","MAGGTU4",54,0)
 ; Bug in 42.  the Version comes in as 30.5.42.x  (42 wasn't released) 
"RTN","MAGGTU4",55,0)
 I $P(CLVER,".",1)="30" S CLVER="3.0."_$P(CLVER,".",3,99)
"RTN","MAGGTU4",56,0)
 ;
"RTN","MAGGTU4",57,0)
 N PLC,SV,ST,SVSTAT,CV,CP,CT,OKVER,WARN,I
"RTN","MAGGTU4",58,0)
 ; PLC = Entry in 2006.1
"RTN","MAGGTU4",59,0)
 ; SV = Server Version -> (3.0.8) from (3.0.8.43) Hard coded to Sync with Delphi Clients
"RTN","MAGGTU4",60,0)
 ; ST = Server T Version -> 43 from full version (3.0.8.43)
"RTN","MAGGTU4",61,0)
 ; CV = Client Version sent from Client 3.0.8 same format as SV
"RTN","MAGGTU4",62,0)
 ; CT = Client T Version sent from Client i.e. 43 same format as ST
"RTN","MAGGTU4",63,0)
 ; OKVER = Array of Supported Versions, and Released T Version OKVER(3.0.48)=6
"RTN","MAGGTU4",64,0)
 ; WARN = 1|0 Boolean value determines if client needs EKG Warning. 
"RTN","MAGGTU4",65,0)
 ; 
"RTN","MAGGTU4",66,0)
 S PLC=$$PLACE^MAGBAPI($G(DUZ(2)))
"RTN","MAGGTU4",67,0)
 ;      Quit if we don't have a valid DUZ(2) or valid PLACE: ^MAG(2006.1,PLC)
"RTN","MAGGTU4",68,0)
 I 'PLC D BADPLC^MAGGTU41(.MAGRY) Q
"RTN","MAGGTU4",69,0)
 ;
"RTN","MAGGTU4",70,0)
 ;      Set up local variables.
"RTN","MAGGTU4",71,0)
 D GETVER(.SV,.ST,.OKVER)
"RTN","MAGGTU4",72,0)
 F I=2:1:$L(CLVER,"|") I $P(CLVER,"|",I)]"" S MAGJOB($P(CLVER,"|",I))=1
"RTN","MAGGTU4",73,0)
 S CLVER=$P(CLVER,"|",1)
"RTN","MAGGTU4",74,0)
 S CV=$P(CLVER,".",1,3),CP=$P(CLVER,".",3),CT=$P(CLVER,".",4)
"RTN","MAGGTU4",75,0)
 I CT="" S $P(CLVER,".",4)=0,CT=0
"RTN","MAGGTU4",76,0)
 ;      set WARN to indicate if Warning is needed or not.
"RTN","MAGGTU4",77,0)
 ;
"RTN","MAGGTU4",78,0)
 D NEEDWARN(.WARN)
"RTN","MAGGTU4",79,0)
 ;      Quit if site has VERSION CHECKING=0 (OFF) in Imaging Site Params File.  
"RTN","MAGGTU4",80,0)
 I '$$VERCHKON(PLC) D  Q
"RTN","MAGGTU4",81,0)
 . S MAGRY(0)="1^Version Checking is OFF. Allowing All Versions"
"RTN","MAGGTU4",82,0)
 . ;      But, need to Display the warning, even if Version Checking is OFF
"RTN","MAGGTU4",83,0)
 . I WARN S MAGRY(0)="0^      =========== WARNING ===============" D WARNING
"RTN","MAGGTU4",84,0)
 . Q
"RTN","MAGGTU4",85,0)
 ;      If Remote Connection , allow it.
"RTN","MAGGTU4",86,0)
 I $D(MAGJOB("RIV")) S MAGRY(0)="1^Allowing Remote Image Connection" Q
"RTN","MAGGTU4",87,0)
 ;      Is this Server Version Alpha/Beta or Released.
"RTN","MAGGTU4",88,0)
 D VERSTAT(.SVSTAT,SV)
"RTN","MAGGTU4",89,0)
 I 'SVSTAT S MAGRY(0)="2^"_$P(SVSTAT,"^",2) Q  ; There is not record of a KIDS for this Server.
"RTN","MAGGTU4",90,0)
 ; 
"RTN","MAGGTU4",91,0)
 ;      If Client isn't one of the Supported Clients.
"RTN","MAGGTU4",92,0)
 I (CV'=SV),'$D(OKVER(CV)) D  Q
"RTN","MAGGTU4",93,0)
 . I +SVSTAT=2 D NOTOKB^MAGGTU41(.MAGRY) Q
"RTN","MAGGTU4",94,0)
 . D NOTOK^MAGGTU41(.MAGRY) Q
"RTN","MAGGTU4",95,0)
 . Q 
"RTN","MAGGTU4",96,0)
 ;
"RTN","MAGGTU4",97,0)
 ;      Client is Supported. Only Warn if we are Not In ALPHA/BETA Testing.
"RTN","MAGGTU4",98,0)
 I (CV'=SV) D  Q
"RTN","MAGGTU4",99,0)
 . I CT<$G(OKVER(CV)) D  Q
"RTN","MAGGTU4",100,0)
 . . I +SVSTAT=2 DO OKBADTB^MAGGTU41(.MAGRY) Q
"RTN","MAGGTU4",101,0)
 . . DO OKBADT^MAGGTU41(.MAGRY) Q
"RTN","MAGGTU4",102,0)
 . . Q
"RTN","MAGGTU4",103,0)
 . I +SVSTAT=2 D OKB^MAGGTU41(.MAGRY)
"RTN","MAGGTU4",104,0)
 . E  D OK^MAGGTU41(.MAGRY)
"RTN","MAGGTU4",105,0)
 . I WARN D WARNING
"RTN","MAGGTU4",106,0)
 . Q
"RTN","MAGGTU4",107,0)
 ; 
"RTN","MAGGTU4",108,0)
 ; At this point, Versions are the Same: If T versions are not, warn the Client.
"RTN","MAGGTU4",109,0)
 I CT,(CT'=ST) D  Q
"RTN","MAGGTU4",110,0)
 . I +SVSTAT=2 D TNOTOKB^MAGGTU41(.MAGRY) Q
"RTN","MAGGTU4",111,0)
 . D TNOTOK^MAGGTU41(.MAGRY) Q
"RTN","MAGGTU4",112,0)
 . Q
"RTN","MAGGTU4",113,0)
 ; Client and Server Versions are the same, to the T. (Ha, get it)
"RTN","MAGGTU4",114,0)
 S MAGRY(0)="1^Version Check OK. Server: "_SV_" Client: "_CV Q
"RTN","MAGGTU4",115,0)
 Q
"RTN","MAGGTU4",116,0)
 ;
"RTN","MAGGTU4",117,0)
VERCHKON(PLC) ; Is Version checking on for the site (Place)
"RTN","MAGGTU4",118,0)
 Q +$P(^MAG(2006.1,PLC,"KEYS"),"^",5)
"RTN","MAGGTU4",119,0)
 ;
"RTN","MAGGTU4",120,0)
NEEDWARN(WARN) ; This call determines if Client needs the warning.
"RTN","MAGGTU4",121,0)
 I $P($G(^MAG(2006.1,PLC,"USERPREF")),U,2)="" S WARN=0 Q  ; Not a MUSE Site.
"RTN","MAGGTU4",122,0)
 I $D(MAGJOB("CAPTURE")) S WARN=0 Q  ;Not needed for Capture Clients
"RTN","MAGGTU4",123,0)
 I CV="3.0.59"    S WARN=0 Q  ; Client 59 has 63.
"RTN","MAGGTU4",124,0)
 I CV="3.0.45"    S WARN=0 Q  ; Client 45 has 63.
"RTN","MAGGTU4",125,0)
 I CV="3.0.41"    S WARN=0 Q  ; It is fixed in 41
"RTN","MAGGTU4",126,0)
 I CV="3.0.63"    S WARN=0 Q  ; It is fixed in 63
"RTN","MAGGTU4",127,0)
 I $P(CV,".",1)=2 S WARN=0 Q  ;Older Clients don't have the EKG Problem.
"RTN","MAGGTU4",128,0)
 I '$D(OKVER(CV)) S WARN=0 Q  ; Patch 3.0.7, 3.0.2 don't have EKG problem.
"RTN","MAGGTU4",129,0)
 S WARN=1 ; This means to Show the EKG Warning.
"RTN","MAGGTU4",130,0)
 Q
"RTN","MAGGTU4",131,0)
 ;
"RTN","MAGGTU4",132,0)
WARNING ; This is hard coded for the EKG Warning.
"RTN","MAGGTU4",133,0)
 ; Put Warning at the End of any Return Message.
"RTN","MAGGTU4",134,0)
 S MAGRY(1000)=" "
"RTN","MAGGTU4",135,0)
 S MAGRY(1010)="!*************************************************!"
"RTN","MAGGTU4",136,0)
 S MAGRY(1015)=" "
"RTN","MAGGTU4",137,0)
 S MAGRY(1020)="  PATIENT SAFETY NOTIFICATION"
"RTN","MAGGTU4",138,0)
 S MAGRY(1025)=" "
"RTN","MAGGTU4",139,0)
 S MAGRY(1030)="      Under certain circumstances, the EKG window will not"
"RTN","MAGGTU4",140,0)
 S MAGRY(1040)="refresh properly when you select a new patient in CPRS; "
"RTN","MAGGTU4",141,0)
 S MAGRY(1050)="instead of showing the new patient, the EKG window will "
"RTN","MAGGTU4",142,0)
 S MAGRY(1060)="continue to show the previous patient.   "
"RTN","MAGGTU4",143,0)
 S MAGRY(1065)="   "
"RTN","MAGGTU4",144,0)
 S MAGRY(1070)="To prevent this problem:"
"RTN","MAGGTU4",145,0)
 S MAGRY(1075)=" "
"RTN","MAGGTU4",146,0)
 S MAGRY(1080)="     Verify that the 'Show MUSE EKGs' option under"
"RTN","MAGGTU4",147,0)
 S MAGRY(1085)="     Options > View Preferences is checked;"
"RTN","MAGGTU4",148,0)
 S MAGRY(1090)="     OR"
"RTN","MAGGTU4",149,0)
 S MAGRY(1100)="     Do not minimize the Imaging Display window while viewing EKGs."
"RTN","MAGGTU4",150,0)
 S MAGRY(1110)="   "
"RTN","MAGGTU4",151,0)
 S MAGRY(1115)="This problem will be corrected shortly by Imaging Patch 63."
"RTN","MAGGTU4",152,0)
 S MAGRY(1120)="!*************************************************!"
"RTN","MAGGTU4",153,0)
 Q
"RTN","MAGGTU4",154,0)
VERSTAT(MAGRY,MAGVER) ;RPC - [MAG4 VERSION STATUS]    
"RTN","MAGGTU4",155,0)
 ; Returns the status of an Imaging Version
"RTN","MAGGTU4",156,0)
 ; Input : 
"RTN","MAGGTU4",157,0)
 ;       MAGVER - Version number
"RTN","MAGGTU4",158,0)
 ;          in the format  MAG*3.0*59
"RTN","MAGGTU4",159,0)
 ;          or the format  3.0.59
"RTN","MAGGTU4",160,0)
 ; Return:
"RTN","MAGGTU4",161,0)
 ;       MAGRY =  0^There is No KIDs Install record
"RTN","MAGGTU4",162,0)
 ;                1^Unknown Release Status
"RTN","MAGGTU4",163,0)
 ;                2^Alpha/Beta Version
"RTN","MAGGTU4",164,0)
 ;                3^Released Version
"RTN","MAGGTU4",165,0)
 ; 
"RTN","MAGGTU4",166,0)
 N VERI,TVER,MAGERR
"RTN","MAGGTU4",167,0)
 I +MAGVER S MAGVER="MAG*"_$P(MAGVER,".",1,2)_"*"_$P(MAGVER,".",3)
"RTN","MAGGTU4",168,0)
 S VERI=$$FIND1^DIC(9.6,"","M",MAGVER,"","","MAGERR")
"RTN","MAGGTU4",169,0)
 I 'VERI S MAGRY="0^There is No KIDs Install record." Q
"RTN","MAGGTU4",170,0)
 S TVER=$$GET1^DIQ(9.6,VERI_",","ALPHA/BETA TESTING")
"RTN","MAGGTU4",171,0)
 I TVER="YES" S MAGRY="2^Alpha/Beta Version." Q
"RTN","MAGGTU4",172,0)
 I TVER="NO" S MAGRY="3^Released Version." Q
"RTN","MAGGTU4",173,0)
 S MAGRY="1^Unknown Release Status."
"RTN","MAGGTU4",174,0)
 Q
"RTN","MAGGTU4",175,0)
ABSJB(MAGRY,MAGIN) ;RPC [MAG ABSJB] SET ABSTRACT AND/OR JUKEBOX QUEUES
"RTN","MAGGTU4",176,0)
 D ABSJB^MAGGTU71(.MAGRY,.MAGIN)
"RTN","MAGGTU4",177,0)
 Q
"RTN","MAGGTU41")
0^22^B28753465
"RTN","MAGGTU41",1,0)
MAGGTU41 ;WOIFO/GEK - Version Control utilities  ; [ 06/20/2001 08:57 ]
"RTN","MAGGTU41",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGGTU41",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTU41",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU41",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTU41",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTU41",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTU41",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTU41",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTU41",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTU41",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTU41",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTU41",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTU41",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTU41",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTU41",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU41",17,0)
 ;;
"RTN","MAGGTU41",18,0)
 Q
"RTN","MAGGTU41",19,0)
NOTOKB(X) ; Client Not Supported. Server is Beta
"RTN","MAGGTU41",20,0)
 ; Client will not be supported when this version is Released.  Warn Client.
"RTN","MAGGTU41",21,0)
 S X(0)="0^     This site is a test site for Version: "_SV_"."
"RTN","MAGGTU41",22,0)
 S X(5)="     Client is running               Version: "_CV
"RTN","MAGGTU41",23,0)
 S X(7)="    "
"RTN","MAGGTU41",24,0)
 S X(10)="       When Version : "_SV_" is Released,  "
"RTN","MAGGTU41",25,0)
 S X(15)=" Client Version: "_CV_" will no longer be supported."
"RTN","MAGGTU41",26,0)
 S X(17)="  "
"RTN","MAGGTU41",27,0)
 S X(18)=" This Client Application will not work correctly."
"RTN","MAGGTU41",28,0)
 S X(19)=" "
"RTN","MAGGTU41",29,0)
 S X(20)=" Contact the Imaging System Manager to update this workstation."
"RTN","MAGGTU41",30,0)
 S X(30)="  "
"RTN","MAGGTU41",31,0)
 S X(40)="                          APPLICATION Will Continue"
"RTN","MAGGTU41",32,0)
 Q
"RTN","MAGGTU41",33,0)
NOTOK(X) ; Client Not Supported.
"RTN","MAGGTU41",34,0)
 S X(0)="2^   Server is running Imaging V. "_SV_"      "_$P(SVSTAT,"^",2)
"RTN","MAGGTU41",35,0)
 S X(1)="   "
"RTN","MAGGTU41",36,0)
 S X(5)=" Client is running Imaging V. "_CV
"RTN","MAGGTU41",37,0)
 S X(7)="  "
"RTN","MAGGTU41",38,0)
 S X(10)=" Version "_CV_" is no longer supported."
"RTN","MAGGTU41",39,0)
 S X(15)="  "
"RTN","MAGGTU41",40,0)
 S X(20)=" Contact the Imaging System Manager to update this workstation."
"RTN","MAGGTU41",41,0)
 S X(30)="   "
"RTN","MAGGTU41",42,0)
 S X(40)="                       APPLICATION WILL ABORT !"
"RTN","MAGGTU41",43,0)
 ;  Clients prior to 8, have a 'Cancel' button on Message Dialog (oversight)
"RTN","MAGGTU41",44,0)
 I $P(CV,".",1)=2 S X(50)="(clicking 'Cancel' will not stop the Abort.)"
"RTN","MAGGTU41",45,0)
 Q
"RTN","MAGGTU41",46,0)
OKBADTB(X) ; Client not Equal, but it is supported.
"RTN","MAGGTU41",47,0)
 ;  But it's T isn't the T of it's Released Patch
"RTN","MAGGTU41",48,0)
 S X(0)="0^   Server is running Imaging V. "_SV_"      "_$P(SVSTAT,"^",2)
"RTN","MAGGTU41",49,0)
 S X(3)="   "
"RTN","MAGGTU41",50,0)
 S X(5)="  Client is running Imaging V. "_CLVER
"RTN","MAGGTU41",51,0)
 S X(10)="  The Released Version of Patch "_CP_" is V. "_CV_"."_$G(OKVER(CV))
"RTN","MAGGTU41",52,0)
 S X(12)="  "
"RTN","MAGGTU41",53,0)
 S X(18)="  This Client Application will not work correctly.  You should"
"RTN","MAGGTU41",54,0)
 S X(20)="  update this workstation with the Released Version of Patch "_CP
"RTN","MAGGTU41",55,0)
 S X(21)=" "
"RTN","MAGGTU41",56,0)
 S X(22)="  Contact the Imaging System Manager to update this workstation."
"RTN","MAGGTU41",57,0)
 S X(27)="     "
"RTN","MAGGTU41",58,0)
 S X(30)="                          APPLICATION will Continue  "
"RTN","MAGGTU41",59,0)
 Q
"RTN","MAGGTU41",60,0)
OKBADT(X) ; Client not Equal, but it is supported.
"RTN","MAGGTU41",61,0)
 ;  But it's T isn't the T of it's Released Patch
"RTN","MAGGTU41",62,0)
 S X(0)="2^   Server is running Imaging V. "_SV_"      "_$P(SVSTAT,"^",2)
"RTN","MAGGTU41",63,0)
 S X(3)="   "
"RTN","MAGGTU41",64,0)
 S X(5)="   Client is running Imaging V. "_CLVER
"RTN","MAGGTU41",65,0)
 S X(10)="  The Released Version of Patch "_CP_" is V. "_CV_"."_$G(OKVER(CV))
"RTN","MAGGTU41",66,0)
 S X(15)=" "
"RTN","MAGGTU41",67,0)
 S X(18)="  Version "_CLVER_" is not supported."
"RTN","MAGGTU41",68,0)
 S X(19)="  "
"RTN","MAGGTU41",69,0)
 S X(20)="  You must update this workstation."
"RTN","MAGGTU41",70,0)
 S X(22)="  "
"RTN","MAGGTU41",71,0)
 S X(25)="  Contact the Imaging System Manager to update this workstation."
"RTN","MAGGTU41",72,0)
 S X(27)="     "
"RTN","MAGGTU41",73,0)
 S X(40)="                       APPLICATION WILL ABORT !"
"RTN","MAGGTU41",74,0)
 Q
"RTN","MAGGTU41",75,0)
OKB(X) ; Client is Not Equal to server.  Server Version / Beta
"RTN","MAGGTU41",76,0)
 ; Alpha/Beta Version so allow to continue. no message  
"RTN","MAGGTU41",77,0)
 S X(0)="1^   Alpha/Beta testing in progress for: "_SV
"RTN","MAGGTU41",78,0)
 Q
"RTN","MAGGTU41",79,0)
OK(X) ; Client is Not Equal to the server.   Warn
"RTN","MAGGTU41",80,0)
 S X(0)="0^   Server is running Imaging V. "_SV_"      "_$P(SVSTAT,"^",2)
"RTN","MAGGTU41",81,0)
 S X(5)="   Client is running   Imaging V. "_CV
"RTN","MAGGTU41",82,0)
 S X(7)="    "
"RTN","MAGGTU41",83,0)
 S X(10)="  The Client application should be updated "
"RTN","MAGGTU41",84,0)
 S X(15)=" "
"RTN","MAGGTU41",85,0)
 S X(20)="  Contact the Imaging System Manager to update this workstation."
"RTN","MAGGTU41",86,0)
 S X(30)="   "
"RTN","MAGGTU41",87,0)
 S X(40)="                       APPLICATION Will Continue"
"RTN","MAGGTU41",88,0)
 ;  Clients prior to 8, have a 'Cancel' button on Message Dialog (oversight)
"RTN","MAGGTU41",89,0)
 I $P(CV,".",1)=2 S X(50)="(clicking 'Cancel' will not stop the Client.)"
"RTN","MAGGTU41",90,0)
 Q
"RTN","MAGGTU41",91,0)
 ;
"RTN","MAGGTU41",92,0)
 ; Versions are the Same: If T versions are not, warn the Client.
"RTN","MAGGTU41",93,0)
 ; Released Client (of any version) will have the T version that the server expects, and 
"RTN","MAGGTU41",94,0)
 ; no warning will be displayed.
"RTN","MAGGTU41",95,0)
TNOTOKB(X) ; Client T is Not Equal to Server T, Beta Site.
"RTN","MAGGTU41",96,0)
 ;I CT,(CT'=ST) D  Q
"RTN","MAGGTU41",97,0)
 S X(0)="0^   Server is running Imaging V. "_SV_"."_ST_"      "_$P(SVSTAT,"^",2)
"RTN","MAGGTU41",98,0)
 S X(5)="   Client is running   Imaging V. "_CLVER
"RTN","MAGGTU41",99,0)
 S X(10)="     "
"RTN","MAGGTU41",100,0)
 S X(20)="  Test Versions of Patch "_SV_" other than T"_ST_" may not work correctly."
"RTN","MAGGTU41",101,0)
 S X(25)="     "
"RTN","MAGGTU41",102,0)
 S X(30)="                       APPLICATION will Continue  "
"RTN","MAGGTU41",103,0)
 Q
"RTN","MAGGTU41",104,0)
TNOTOK(X) ; Client T is Not Equal to Server T.
"RTN","MAGGTU41",105,0)
 ;I CT,(CT'=ST) D  Q
"RTN","MAGGTU41",106,0)
 S X(0)="0^   Server is running Imaging V. "_SV_"."_ST_"      "_$P(SVSTAT,"^",2)
"RTN","MAGGTU41",107,0)
 S X(5)="   Client is running Imaging V. "_CLVER
"RTN","MAGGTU41",108,0)
 S X(10)="     "
"RTN","MAGGTU41",109,0)
 S X(12)="  For Patch "_CP_" the released T version is:  "_ST
"RTN","MAGGTU41",110,0)
 S X(20)="  You must update this workstation with the Released Version."
"RTN","MAGGTU41",111,0)
 S X(22)="  "
"RTN","MAGGTU41",112,0)
 S X(25)="  Contact the Imaging System Manager to update this workstation."
"RTN","MAGGTU41",113,0)
 S X(27)="     "
"RTN","MAGGTU41",114,0)
 S X(30)="                       APPLICATION will Continue  "
"RTN","MAGGTU41",115,0)
 Q
"RTN","MAGGTU41",116,0)
BADPLC(X) ; The call to $$PLACE^MAGBAPI($G(DUZ(2))) Failed, return a message.
"RTN","MAGGTU41",117,0)
 ;
"RTN","MAGGTU41",118,0)
 I '$G(DUZ(2)) S X(0)="2^   Error: Undefined DUZ(2)"
"RTN","MAGGTU41",119,0)
 E  D
"RTN","MAGGTU41",120,0)
 . S X(0)="2^   Error: Division "_$P($G(^DIC(4,DUZ(2),0)),"^",1)_" ["_DUZ(2)_"]"
"RTN","MAGGTU41",121,0)
 . S X(2)="      is not an Imaging Site Parameter."
"RTN","MAGGTU41",122,0)
 . Q
"RTN","MAGGTU41",123,0)
 S X(5)="   Contact IRM.  Application will abort"
"RTN","MAGGTU41",124,0)
 Q
"RTN","MAGGTU6")
0^23^B47950774
"RTN","MAGGTU6",1,0)
MAGGTU6 ;WOIFO/GEK - Silent Utilities ; 25 Jan 2006  12:14 PM
"RTN","MAGGTU6",2,0)
 ;;3.0;IMAGING;**24,8,48,45,20,46**;16-February-2007;;Build 1023
"RTN","MAGGTU6",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTU6",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU6",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTU6",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTU6",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTU6",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTU6",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTU6",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTU6",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTU6",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTU6",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTU6",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTU6",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTU6",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU6",17,0)
 ;;
"RTN","MAGGTU6",18,0)
 Q
"RTN","MAGGTU6",19,0)
 ;
"RTN","MAGGTU6",20,0)
LOGACT(MAGRY,ZY) ;RPC [MAGGACTION LOG]
"RTN","MAGGTU6",21,0)
 ; Call to LogAction from Delphi Window 
"RTN","MAGGTU6",22,0)
 ;
"RTN","MAGGTU6",23,0)
 ; ZY is input variable it is '^' delimited string
"RTN","MAGGTU6",24,0)
 ; 'A|B|C|D|E' ^^ MAGIEN ^ 'Copy/Download' ^ DFN ^ '1';
"RTN","MAGGTU6",25,0)
 ;  DUZ is inserted as 2nd piece below.
"RTN","MAGGTU6",26,0)
 ; I.E. zy  = "C^^103660^Copy To Clipboard^1033^1"
"RTN","MAGGTU6",27,0)
 N Y
"RTN","MAGGTU6",28,0)
 S MAGRY="0^Logging access..."
"RTN","MAGGTU6",29,0)
 ;
"RTN","MAGGTU6",30,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGGTERR"
"RTN","MAGGTU6",31,0)
 ;                 C       DUZ      MAGIEN     ACTION       DFN       1
"RTN","MAGGTU6",32,0)
 D ENTRY^MAGLOG($P(ZY,U),+$G(DUZ),$P(ZY,U,3),$P(ZY,U,4),$P(ZY,U,5),$P(ZY,U,6))
"RTN","MAGGTU6",33,0)
 S MAGRY="1^Action was Logged."
"RTN","MAGGTU6",34,0)
 Q
"RTN","MAGGTU6",35,0)
LINKDT(MAGRY,MAGDA,DTTM) ; This is called when an Image is successfully 
"RTN","MAGGTU6",36,0)
 ; linked (Associated) with a Report/Procedure/Note etc.
"RTN","MAGGTU6",37,0)
 ;  MAGDA = Image IEN
"RTN","MAGGTU6",38,0)
 ;  DTTM = ""            No date sent, so use NOW 
"RTN","MAGGTU6",39,0)
 ;  DTTM = 1                     No Date Sent, but use Image capture Date.
"RTN","MAGGTU6",40,0)
 ;  DTTM = Valid FM Date/Time    , Use it.
"RTN","MAGGTU6",41,0)
 N MSG
"RTN","MAGGTU6",42,0)
 S DTTM=$G(DTTM)
"RTN","MAGGTU6",43,0)
 I 'DTTM S DTTM=$$NOW^XLFDT      ; Using NOW
"RTN","MAGGTU6",44,0)
 I '$D(^MAG(2005,MAGDA)) Q
"RTN","MAGGTU6",45,0)
 I DTTM=1 S DTTM=$P(^MAG(2005,MAGDA,2),"^",1) ; Using Date Image Captured.
"RTN","MAGGTU6",46,0)
 I '$$VALID^MAGGSIV1(2005,64,.DTTM,.MSG) S MAGRY="0^"_MSG Q
"RTN","MAGGTU6",47,0)
 S $P(^MAG(2005,MAGDA,2),"^",11)=DTTM
"RTN","MAGGTU6",48,0)
 S MAGRY="1^Okay"
"RTN","MAGGTU6",49,0)
 Q
"RTN","MAGGTU6",50,0)
TIMEOUT(MAGRY,APP) ;RPC [MAGG GET TIMEOUT]
"RTN","MAGGTU6",51,0)
 ; Call  Returns the timeout for the APP from IMAGING SITE PARAMETERS File
"RTN","MAGGTU6",52,0)
 ;  APP is either 'DISPLAY'  'CAPTURE' or   'VISTARAD'
"RTN","MAGGTU6",53,0)
 N I,MAGTIMES,MAGPLC
"RTN","MAGGTU6",54,0)
 S MAGRY=""
"RTN","MAGGTU6",55,0)
 S MAGPLC=$$PLACE^MAGBAPI(DUZ(2)) I 'MAGPLC Q  ; DBI - SEB 9/20/2002
"RTN","MAGGTU6",56,0)
 S MAGTIMES=$G(^MAG(2006.1,MAGPLC,"KEYS"))
"RTN","MAGGTU6",57,0)
 I APP="DISPLAY" S MAGRY=$P(MAGTIMES,U,2)
"RTN","MAGGTU6",58,0)
 I APP="CAPTURE" S MAGRY=$P(MAGTIMES,U,3)
"RTN","MAGGTU6",59,0)
 I APP="VISTARAD" S MAGRY=$P(MAGTIMES,U,4)
"RTN","MAGGTU6",60,0)
 I APP="TELEREADER" S MAGRY=$P(MAGTIMES,U,6)  ;  MJK - 2006.01.25 - TeleReader
"RTN","MAGGTU6",61,0)
 Q
"RTN","MAGGTU6",62,0)
EXIST(EKGPLACE) ;Does an ekg server exist in 2005.2
"RTN","MAGGTU6",63,0)
 I $$CONSOLID^MAGBAPI()=0 Q $O(^MAG(2005.2,"E","EKG","")) ; DBI - SEB 9/20/2002
"RTN","MAGGTU6",64,0)
 Q $O(^MAG(2005.2,"F",EKGPLACE,"EKG",""))
"RTN","MAGGTU6",65,0)
 ;
"RTN","MAGGTU6",66,0)
ONLINE(MAGR) ;RPC [MAG EKG ONLINE] EKG network location status    
"RTN","MAGGTU6",67,0)
 ;returns the status of the first EKG network location type
"RTN","MAGGTU6",68,0)
 ;O if offline or a network location doesn't exist
"RTN","MAGGTU6",69,0)
 ;1 if online
"RTN","MAGGTU6",70,0)
 ;
"RTN","MAGGTU6",71,0)
 N EKG1,EKGPLACE
"RTN","MAGGTU6",72,0)
 S EKGPLACE=$$PLACE^MAGBAPI(DUZ(2)) ; DBI - SEB 9/20/2002
"RTN","MAGGTU6",73,0)
 I EKGPLACE=0 S EKGPLACE=$$PLACE^MAGBAPI(DUZ(2)) ;Convert to extrinsic /gek 8/2003
"RTN","MAGGTU6",74,0)
 I $$EXIST(EKGPLACE) D
"RTN","MAGGTU6",75,0)
 . I $$CONSOLID^MAGBAPI() S EKG1=$O(^MAG(2005.2,"F",EKGPLACE,"EKG","")) ; DBI - SEB 9/20/2002
"RTN","MAGGTU6",76,0)
 . E  S EKG1=$O(^MAG(2005.2,"E","EKG",""))
"RTN","MAGGTU6",77,0)
 . S MAGR=$P(^MAG(2005.2,EKG1,0),U,6)
"RTN","MAGGTU6",78,0)
 E  S MAGR=0
"RTN","MAGGTU6",79,0)
 Q
"RTN","MAGGTU6",80,0)
SHARE(MAGRY,TYPE) ;RPC [MAG GET NETLOC]
"RTN","MAGGTU6",81,0)
 ; Get list of image shares
"RTN","MAGGTU6",82,0)
 ;TYPE = One of the STORAGE TYPE codes : MAG, EKG, WORM, URL or ALL
"RTN","MAGGTU6",83,0)
 N TMP,I,DATA0,DATA2,DATA3,DATA6,INFO,VALUE,STYP,PHYREF
"RTN","MAGGTU6",84,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERRA^MAGGTERR"
"RTN","MAGGTU6",85,0)
 S I=0
"RTN","MAGGTU6",86,0)
 I TYPE="" S TYPE="ALL"
"RTN","MAGGTU6",87,0)
 S MAGRY(0)="1^SUCCESS"
"RTN","MAGGTU6",88,0)
 F  S I=$O(^MAG(2005.2,I)) Q:'I  D
"RTN","MAGGTU6",89,0)
 . Q:$$LOCDRIVE(I)
"RTN","MAGGTU6",90,0)
 . S DATA0=$G(^MAG(2005.2,I,0))
"RTN","MAGGTU6",91,0)
 . S DATA2=$G(^MAG(2005.2,I,2))
"RTN","MAGGTU6",92,0)
 . S DATA3=$G(^MAG(2005.2,I,3))
"RTN","MAGGTU6",93,0)
 . S DATA6=$G(^MAG(2005.2,I,6))
"RTN","MAGGTU6",94,0)
 . ; 
"RTN","MAGGTU6",95,0)
 . S PHYREF=$P(DATA0,"^",2) ; PHYSICAL REFERENCE
"RTN","MAGGTU6",96,0)
 . S STYP=$P(DATA0,"^",7) ; STORAGE TYPE
"RTN","MAGGTU6",97,0)
 . ;
"RTN","MAGGTU6",98,0)
 . I TYPE'="ALL" Q:STYP'[TYPE
"RTN","MAGGTU6",99,0)
 . Q:$P(DATA0,"^",6)=0     ;SHARE IS OFFLINE (don't return offline shares)
"RTN","MAGGTU6",100,0)
 . I STYP'="URL" Q:(PHYREF[".")  ; pre 45, quit if '.' in phyref
"RTN","MAGGTU6",101,0)
 . I STYP'="URL" Q:($E(PHYREF,1,2)'="\\")  ; pre 45 quit if doesn't start with '\\'
"RTN","MAGGTU6",102,0)
 . ;
"RTN","MAGGTU6",103,0)
 . S INFO=$S($E(PHYREF,$L(PHYREF))="\":$E(PHYREF,1,$L(PHYREF)-1),1:PHYREF)
"RTN","MAGGTU6",104,0)
 . S $P(INFO,"^",2)=$P($G(DATA0),"^",7) ;Physical reference (path)
"RTN","MAGGTU6",105,0)
 . S $P(INFO,"^",3)=$P($G(DATA0),"^",6)  ;Operational Status 0=OFFLINE 1=ONLINE
"RTN","MAGGTU6",106,0)
 . S $P(INFO,"^",4)=$P($G(DATA2),"^",1) ;Username
"RTN","MAGGTU6",107,0)
 . S $P(INFO,"^",5)=$P($G(DATA2),"^",2) ;Password
"RTN","MAGGTU6",108,0)
 . S $P(INFO,"^",6)=$P($G(DATA6),"^",1)  ;MUSE Site #
"RTN","MAGGTU6",109,0)
 . I $P($G(DATA6),"^",2)'="" S $P(INFO,"^",7)=^MAG(2006.17,$P(DATA6,"^",2),0)  ;MUSE version #
"RTN","MAGGTU6",110,0)
 . S $P(INFO,"^",8)=$P($G(DATA3),"^",5)  ;Network location SITE
"RTN","MAGGTU6",111,0)
 . Q:$D(TMP(INFO))
"RTN","MAGGTU6",112,0)
 . S TMP(INFO)=I
"RTN","MAGGTU6",113,0)
 S INFO=""
"RTN","MAGGTU6",114,0)
 F  S INFO=$O(TMP(INFO)) Q:INFO=""  D
"RTN","MAGGTU6",115,0)
 . S MAGRY($O(MAGRY(""),-1)+1)=TMP(INFO)_"^"_INFO
"RTN","MAGGTU6",116,0)
 K TMP
"RTN","MAGGTU6",117,0)
 Q
"RTN","MAGGTU6",118,0)
LOCDRIVE(I) ; Returns 1 if this is a local drive, else 0
"RTN","MAGGTU6",119,0)
 ; Local Drive is determined by the DIR not being Type : URL and having a ":"
"RTN","MAGGTU6",120,0)
 I $P(^MAG(2005.2,I,0),"^",7)'="URL" I $P(^MAG(2005.2,I,0),"^",2)[":" Q 1
"RTN","MAGGTU6",121,0)
 Q 0
"RTN","MAGGTU6",122,0)
GETENV(MAGRY) ;RPC [MAG GET ENV]
"RTN","MAGGTU6",123,0)
 ; Get some environment variables (used by annotation control)
"RTN","MAGGTU6",124,0)
 S MAGRY=DUZ(2)_"^"_$$NOW^XLFDT
"RTN","MAGGTU6",125,0)
 Q
"RTN","MAGGTU6",126,0)
ANNCB(STATARR) ;Status Callback (called by the import API)
"RTN","MAGGTU6",127,0)
 ;
"RTN","MAGGTU6",128,0)
 N I,CDUZ,QINDEX,A,COUNT
"RTN","MAGGTU6",129,0)
 N XMDUZ,XMSUB,XMTEXT,XMY
"RTN","MAGGTU6",130,0)
 ;  0 = error, all others are success.
"RTN","MAGGTU6",131,0)
 I $P(STATARR(0),"^",1)'=0 D
"RTN","MAGGTU6",132,0)
 . ;   Import was successful
"RTN","MAGGTU6",133,0)
 E  D
"RTN","MAGGTU6",134,0)
 . ;   Import failed - send mail to MAG SERVER group and person who queued the import
"RTN","MAGGTU6",135,0)
 . S XMDUZ=DUZ
"RTN","MAGGTU6",136,0)
 . S XMSUB="Import Error Report"
"RTN","MAGGTU6",137,0)
 . ;    get text of message from status array
"RTN","MAGGTU6",138,0)
 . S XMTEXT="A("
"RTN","MAGGTU6",139,0)
 . ; XMD needs array to start with 1, not 0
"RTN","MAGGTU6",140,0)
 . S COUNT=1,I=""
"RTN","MAGGTU6",141,0)
 . F  S I=$O(STATARR(I)) Q:I=""  D
"RTN","MAGGTU6",142,0)
 . . S A(COUNT)=I_") "_STATARR(I)
"RTN","MAGGTU6",143,0)
 . . S COUNT=COUNT+1
"RTN","MAGGTU6",144,0)
 . . Q
"RTN","MAGGTU6",145,0)
 . S A(COUNT+1)=" "
"RTN","MAGGTU6",146,0)
 . S A(COUNT+2)=" "
"RTN","MAGGTU6",147,0)
 . S A(COUNT+3)="     The errors listed above were generated by"
"RTN","MAGGTU6",148,0)
 . S A(COUNT+4)="     the VistA Imaging Annotation Editor while"
"RTN","MAGGTU6",149,0)
 . S A(COUNT+5)="     trying to import your diagram.  Please"
"RTN","MAGGTU6",150,0)
 . S A(COUNT+6)="     report these errors to your VistA Imaging"
"RTN","MAGGTU6",151,0)
 . S A(COUNT+7)="     support personnel."
"RTN","MAGGTU6",152,0)
 . ;Get person who did the import
"RTN","MAGGTU6",153,0)
 . S QINDEX=STATARR(2)
"RTN","MAGGTU6",154,0)
 . S I=-1 F  S I=$O(^MAG(2006.034,QINDEX,1,I)) Q:I=""  D
"RTN","MAGGTU6",155,0)
 . . I $P($G(^MAG(2006.034,QINDEX,1,I,0)),"^",1)=8 S CDUZ=$P(^MAG(2006.034,QINDEX,1,I,0),"^",2)
"RTN","MAGGTU6",156,0)
 . ;Set recipients of message
"RTN","MAGGTU6",157,0)
 . S XMY("G.MAG SERVER")=""
"RTN","MAGGTU6",158,0)
 . I $G(CDUZ) S XMY(CDUZ)=""
"RTN","MAGGTU6",159,0)
 . D ^XMD
"RTN","MAGGTU6",160,0)
 . Q
"RTN","MAGGTU6",161,0)
 Q
"RTN","MAGGTU6",162,0)
GETCTP(MAGRY) ;RPC [MAG4 CT PRESETS GET]
"RTN","MAGGTU6",163,0)
 N MAGPLC
"RTN","MAGGTU6",164,0)
 S MAGPLC=$$PLACE^MAGBAPI(DUZ(2))
"RTN","MAGGTU6",165,0)
 I 'MAGPLC S MAGRY="0^Error resolving Users Division" Q
"RTN","MAGGTU6",166,0)
 S MAGRY=$G(^MAG(2006.1,MAGPLC,"CT"))
"RTN","MAGGTU6",167,0)
 I MAGRY="" S MAGRY="0^Site doesn't have CT Presets defined." Q
"RTN","MAGGTU6",168,0)
 S MAGRY="1^"_MAGRY
"RTN","MAGGTU6",169,0)
 Q
"RTN","MAGGTU6",170,0)
SAVECTP(MAGRY,VALUE) ;RPC [MAG4 CT PRESETS SAVE]
"RTN","MAGGTU6",171,0)
 N MAGPLC
"RTN","MAGGTU6",172,0)
 S MAGPLC=$$PLACE^MAGBAPI(DUZ(2))
"RTN","MAGGTU6",173,0)
 I 'MAGPLC S MAGRY="0^Error resolving Users Division" Q
"RTN","MAGGTU6",174,0)
 S ^MAG(2006.1,MAGPLC,"CT")=VALUE
"RTN","MAGGTU6",175,0)
 S MAGRY="1^CT Presets saved."
"RTN","MAGGTU6",176,0)
 Q
"RTN","MAGGTU6",177,0)
NETPLCS ; Create an array of Place, SiteCodes for all entries of
"RTN","MAGGTU6",178,0)
 ; Network Location entries.  
"RTN","MAGGTU6",179,0)
 N I,PLC,PLCODE,CONS
"RTN","MAGGTU6",180,0)
 S CONS=$$CONSOLID^MAGBAPI
"RTN","MAGGTU6",181,0)
 I 'CONS S PLC=$O(^MAG(2006.1,0)),PLCODE=$P(^MAG(2006.1,PLC,0),"^",9)
"RTN","MAGGTU6",182,0)
 ; 
"RTN","MAGGTU6",183,0)
 K MAGJOB("NETPLC")
"RTN","MAGGTU6",184,0)
 S I=0 F  S I=$O(^MAG(2005.2,I)) Q:'I  D
"RTN","MAGGTU6",185,0)
 . I 'CONS S MAGJOB("NETPLC",I)=PLC_"^"_PLCODE Q
"RTN","MAGGTU6",186,0)
 . ; Here, for consolidated sites we get the real Site IEN, and Site Code.
"RTN","MAGGTU6",187,0)
 . I CONS S PLC=$P($G(^MAG(2005.2,I,0)),"^",10),PLCODE=$S(PLC:$P($G(^MAG(2006.1,PLC,0)),"^",9),1:"n/a")
"RTN","MAGGTU6",188,0)
 . S MAGJOB("NETPLC",I)=PLC_"^"_PLCODE
"RTN","MAGGTU6",189,0)
 . Q
"RTN","MAGGTU6",190,0)
 Q
"RTN","MAGGTU71")
0^24^B12414487
"RTN","MAGGTU71",1,0)
MAGGTU71 ;WOIFO/GEK - Silent calls for Queing functions from GUI, cont ;  [ 06/20/2001 08:57 ]
"RTN","MAGGTU71",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGGTU71",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGGTU71",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU71",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGGTU71",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGGTU71",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGGTU71",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGGTU71",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGGTU71",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGGTU71",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGGTU71",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGGTU71",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGGTU71",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGGTU71",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGGTU71",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGGTU71",17,0)
 ;;
"RTN","MAGGTU71",18,0)
 Q
"RTN","MAGGTU71",19,0)
ABSJB(MAGRY,MAGIN) ;RPC [MAG ABSJB] SET ABSTRACT AND/OR JUKEBOX QUEUES
"RTN","MAGGTU71",20,0)
 ;
"RTN","MAGGTU71",21,0)
 ;       MAGIN
"RTN","MAGGTU71",22,0)
 ;   DESCRIPTION:  '^' delimited String:
"RTN","MAGGTU71",23,0)
 ;   Piece 1 = the IEN of the image that needs an abstract created.
"RTN","MAGGTU71",24,0)
 ;   Piece 2 = the IEN of the image that needs copied to the jukebox
"RTN","MAGGTU71",25,0)
 ;
"RTN","MAGGTU71",26,0)
 ;       MAGRY = "1^Successful"
"RTN","MAGGTU71",27,0)
 ;             = "0^error message"
"RTN","MAGGTU71",28,0)
 ;             
"RTN","MAGGTU71",29,0)
 N MAGIENAB,MAGIENJB,MAGERR,X,QMSG
"RTN","MAGGTU71",30,0)
 S MAGERR=0
"RTN","MAGGTU71",31,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^"_$T(+0)
"RTN","MAGGTU71",32,0)
 S MAGRY="0^ERROR: Setting Queue for Abstract or JukeBox copy"
"RTN","MAGGTU71",33,0)
 S MAGIENAB=+$P(MAGIN,"^",1),MAGIENJB=+$P(MAGIN,"^",2)
"RTN","MAGGTU71",34,0)
 I MAGIENAB Q:((+$P($G(^MAG(2005,MAGIENAB,0)),U,11))!(+$P($G(^MAG(2005,MAGIENAB,0)),U,12))) "0^Image integrity"
"RTN","MAGGTU71",35,0)
 I MAGIENJB Q:((+$P($G(^MAG(2005,MAGIENJB,0)),U,11))!(+$P($G(^MAG(2005,MAGIENJB,0)),U,12))) "0^Image integrity"
"RTN","MAGGTU71",36,0)
 S QMSG=$S(MAGIENAB:"Setting Abstract Queue",1:"")
"RTN","MAGGTU71",37,0)
 I MAGIENJB S QMSG=$S(QMSG="":"Setting JukeBox Queue",1:" and JukeBox Queue")
"RTN","MAGGTU71",38,0)
 L +(^MAGQUEUE(2006.03,0),^MAGQUEUE(2006.031)):10 E  D QERR Q
"RTN","MAGGTU71",39,0)
 I MAGIENAB S X=$$ABSTRACT^MAGBAPI(MAGIENAB,$$DA2PLC^MAGBAPIP(MAGIENAB,"F"))
"RTN","MAGGTU71",40,0)
 I MAGIENJB S X=$$JUKEBOX^MAGBAPI(MAGIENJB,$$DA2PLC^MAGBAPIP(MAGIENJB,"F"))
"RTN","MAGGTU71",41,0)
 L -(^MAGQUEUE(2006.03,0),^MAGQUEUE(2006.031))
"RTN","MAGGTU71",42,0)
 S MAGRY="1^SUCCESSFUL"
"RTN","MAGGTU71",43,0)
 Q
"RTN","MAGGTU71",44,0)
ERR ;
"RTN","MAGGTU71",45,0)
 L -(^MAGQUEUE(2006.03,0),^MAGQUEUE(2006.031))
"RTN","MAGGTU71",46,0)
 N ERR S ERR=$$EC^%ZOSV
"RTN","MAGGTU71",47,0)
 S MAGRY="0^Timed out trying to set JukeBox/Abstract Queue.  Not Fatal.  'Save' will continue..."
"RTN","MAGGTU71",48,0)
 D LOGERR^MAGGTERR(ERR)
"RTN","MAGGTU71",49,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGGTU71",50,0)
 Q
"RTN","MAGGTU71",51,0)
QERR ;
"RTN","MAGGTU71",52,0)
 N MAGTXT,EMSG
"RTN","MAGGTU71",53,0)
 S MAGTXT="Failed "_QMSG
"RTN","MAGGTU71",54,0)
 ;ENTRY(MAGIMT,MAGDUZ,MAGO,MAGPACK,MAGDFN,MAGCT,MAGAD)
"RTN","MAGGTU71",55,0)
 D ENTRY^MAGLOG("QFAIL",$G(DUZ),MAGIENJB,"","","",MAGTXT)
"RTN","MAGGTU71",56,0)
 D ACTION^MAGGTAU(MAGTXT,1)
"RTN","MAGGTU71",57,0)
 S EMSG="Timed out trying to Lock Queue File"
"RTN","MAGGTU71",58,0)
 D ACTION^MAGGTAU(EMSG,1)
"RTN","MAGGTU71",59,0)
 S MAGRY="1^"_MAGTXT_"  Message was sent to IRM.  Not Fatal.  'Save' will continue..."
"RTN","MAGGTU71",60,0)
 N XMSUB,XMY,XMTEXT,XMK,XMDUZ
"RTN","MAGGTU71",61,0)
 S XMTEXT="^TMP($J,""MAGQ"","
"RTN","MAGGTU71",62,0)
 S XMSUB=MAGTXT
"RTN","MAGGTU71",63,0)
 K ^TMP($J,"MAGQ")
"RTN","MAGGTU71",64,0)
 S ^TMP($J,"MAGQ",1)=MAGTXT
"RTN","MAGGTU71",65,0)
 S ^TMP($J,"MAGQ",2)=EMSG
"RTN","MAGGTU71",66,0)
 S ^TMP($J,"MAGQ",3)=" for Image IEN: "_MAGIENJB
"RTN","MAGGTU71",67,0)
 S ^TMP($J,"MAGQ",4)="You need to run the Verifier for this Image IEN"
"RTN","MAGGTU71",68,0)
 S XMY("G.IMAGING DEVELOPMENT@DOMAIN.EXT")=""
"RTN","MAGGTU71",69,0)
 D ^XMD
"RTN","MAGGTU71",70,0)
 S XMDUZ=DUZ D KLQ^XMA1B
"RTN","MAGGTU71",71,0)
 K ^TMP($J,"MAGQ")
"RTN","MAGGTU71",72,0)
 Q
"RTN","MAGIPS46")
0^^B28437566
"RTN","MAGIPS46",1,0)
MAGIPS46 ;Post init routine to queue site activity at install. ; 09 May 2006  12:43 PM
"RTN","MAGIPS46",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGIPS46",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIPS46",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIPS46",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIPS46",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIPS46",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIPS46",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIPS46",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIPS46",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIPS46",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIPS46",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIPS46",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIPS46",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIPS46",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIPS46",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIPS46",17,0)
 ;;
"RTN","MAGIPS46",18,0)
 Q
"RTN","MAGIPS46",19,0)
 ;
"RTN","MAGIPS46",20,0)
PRE ;
"RTN","MAGIPS46",21,0)
 D  ; save filters to guard against deletion during installation
"RTN","MAGIPS46",22,0)
 . N FMDTNOW ; -- current date/time in Fileman format
"RTN","MAGIPS46",23,0)
 . N FMDTPRG ; -- date & time to purge (1 day from now)
"RTN","MAGIPS46",24,0)
 . N XTMP0 ; ---- header node of temporary save location - for purge
"RTN","MAGIPS46",25,0)
 . ;
"RTN","MAGIPS46",26,0)
 . U IO(0) W !,"Saving image filters..."
"RTN","MAGIPS46",27,0)
 . L +^XTMP("MAGIPS46"):1E9 K ^XTMP("MAGIPS46")
"RTN","MAGIPS46",28,0)
 . S FMDTNOW=$$NOW^XLFDT
"RTN","MAGIPS46",29,0)
 . S FMDTPRG=$$FMADD^XLFDT(FMDTNOW,1,0,0,0)
"RTN","MAGIPS46",30,0)
 . S ^XTMP("MAGIPS46",0)=FMDTPRG_"^"_FMDTNOW_"^MAG*3.0*46 FILTER SAVE"
"RTN","MAGIPS46",31,0)
 . M ^XTMP("MAGIPS46",1)=^MAG(2006.57)
"RTN","MAGIPS46",32,0)
 . L -^XTMP("MAGIPS46")
"RTN","MAGIPS46",33,0)
 . U IO(0) W "saved.",!
"RTN","MAGIPS46",34,0)
 . Q
"RTN","MAGIPS46",35,0)
 Q
"RTN","MAGIPS46",36,0)
POST ;
"RTN","MAGIPS46",37,0)
 ;
"RTN","MAGIPS46",38,0)
 D  ; restore filters
"RTN","MAGIPS46",39,0)
 . U IO(0) W !,"Restoring filters..."
"RTN","MAGIPS46",40,0)
 . L +^MAG(2006.57):1E9
"RTN","MAGIPS46",41,0)
 . M ^MAG(2006.57)=^XTMP("MAGIPS46",1)
"RTN","MAGIPS46",42,0)
 . L -^MAG(2006.57)
"RTN","MAGIPS46",43,0)
 . U IO(0) W "restored."
"RTN","MAGIPS46",44,0)
 . Q
"RTN","MAGIPS46",45,0)
 ;
"RTN","MAGIPS46",46,0)
 D DEFAULTS
"RTN","MAGIPS46",47,0)
 D XREF
"RTN","MAGIPS46",48,0)
 ;
"RTN","MAGIPS46",49,0)
 D REMTASK^MAGQE4
"RTN","MAGIPS46",50,0)
 D STTASK^MAGQE4
"RTN","MAGIPS46",51,0)
 ;
"RTN","MAGIPS46",52,0)
 D ADDRPC("MAG DICOM CON UNREADLIST LOCK","MAG WINDOWS")
"RTN","MAGIPS46",53,0)
 D ADDRPC("MAG DICOM CON UNREADLIST GET","MAG WINDOWS")
"RTN","MAGIPS46",54,0)
 D ADDRPC("MAG DICOM CON UNREAD ACQ SITES","MAG WINDOWS")
"RTN","MAGIPS46",55,0)
 D ADDRPC("MAG DICOM CON GET TELE READER","MAG WINDOWS")
"RTN","MAGIPS46",56,0)
 D ADDRPC("MAG DICOM CON SET TELE READER","MAG WINDOWS")
"RTN","MAGIPS46",57,0)
 ;
"RTN","MAGIPS46",58,0)
 D ADDRPC("MAG DICOM CON UNREADLIST LOCK","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS46",59,0)
 D ADDRPC("MAG DICOM CON UNREADLIST GET","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS46",60,0)
 D ADDRPC("MAG DICOM CON UNREAD ACQ SITES","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS46",61,0)
 D ADDRPC("MAG DICOM CON GET TELE READER","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS46",62,0)
 D ADDRPC("MAG DICOM CON SET TELE READER","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS46",63,0)
 ;
"RTN","MAGIPS46",64,0)
 D ADDRPC("MAG DICOM CON UNREADLIST LOCK","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS46",65,0)
 D ADDRPC("MAG DICOM CON UNREADLIST GET","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS46",66,0)
 D ADDRPC("MAG DICOM CON UNREAD ACQ SITES","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS46",67,0)
 D ADDRPC("MAG DICOM CON GET TELE READER","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS46",68,0)
 D ADDRPC("MAG DICOM CON SET TELE READER","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS46",69,0)
 ;
"RTN","MAGIPS46",70,0)
 D  ;  Confirmation message
"RTN","MAGIPS46",71,0)
 . ;
"RTN","MAGIPS46",72,0)
 . NEW %,CT,CNT,D,D0,D1,D2,DDATE,DG,DIC,DICR,DIW,MAGMSG,ST,X,XMID,XMSUB,XMY,XMZ,Y
"RTN","MAGIPS46",73,0)
 . ;
"RTN","MAGIPS46",74,0)
 . D GETENV^%ZOSV
"RTN","MAGIPS46",75,0)
 . S CNT=0
"RTN","MAGIPS46",76,0)
 . S CNT=CNT+1,MAGMSG(CNT)="PACKAGE INSTALL"
"RTN","MAGIPS46",77,0)
 . S CNT=CNT+1,MAGMSG(CNT)="SITE: "_$$KSP^XUPARAM("WHERE")
"RTN","MAGIPS46",78,0)
 . S CNT=CNT+1,MAGMSG(CNT)="PACKAGE: "_XPDNM
"RTN","MAGIPS46",79,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Version: "_$$VER^XPDUTL(XPDNM)
"RTN","MAGIPS46",80,0)
 . S ST=$$GET1^DIQ(9.7,XPDA,11,"I")
"RTN","MAGIPS46",81,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Start time: "_$$FMTE^XLFDT(ST)
"RTN","MAGIPS46",82,0)
 . S CT=$$GET1^DIQ(9.7,XPDA,17,"I") S:+CT'=CT CT=$$NOW^XLFDT()
"RTN","MAGIPS46",83,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Completion time: "_$$FMTE^XLFDT(CT)
"RTN","MAGIPS46",84,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Run time: "_$$FMDIFF^XLFDT(CT,ST,3)
"RTN","MAGIPS46",85,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Environment: "_Y
"RTN","MAGIPS46",86,0)
 . S CNT=CNT+1,MAGMSG(CNT)="FILE COMMENT: "_$$GET1^DIQ(9.7,XPDA,6,"I")
"RTN","MAGIPS46",87,0)
 . S CNT=CNT+1,MAGMSG(CNT)="DATE: "_$$NOW^XLFDT()
"RTN","MAGIPS46",88,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Installed by: "_$$GET1^DIQ(9.7,XPDA,9,"E")
"RTN","MAGIPS46",89,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Install Name: "_$$GET1^DIQ(9.7,XPDA,.01,"E")
"RTN","MAGIPS46",90,0)
 . S DDATE=$$GET1^DIQ(9.7,XPDA,51,"I")
"RTN","MAGIPS46",91,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Distribution Date: "_$$FMTE^XLFDT(DDATE)
"RTN","MAGIPS46",92,0)
 . S:$G(CVT)'="" CNT=CNT+1,MAGMSG(CNT)="Conversion time: "_CVT
"RTN","MAGIPS46",93,0)
 . S XMSUB=XPDNM_" INSTALLATION"
"RTN","MAGIPS46",94,0)
 . S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGIPS46",95,0)
 . S XMY(XMID)=""
"RTN","MAGIPS46",96,0)
 . S XMY("G.MAG SERVER")=""
"RTN","MAGIPS46",97,0)
 . S:$G(MAGDUZ) XMY(MAGDUZ)=""
"RTN","MAGIPS46",98,0)
 . S XMSUB=$E(XMSUB,1,63)
"RTN","MAGIPS46",99,0)
 . D SENDMSG^XMXAPI(XMID,XMSUB,"MAGMSG",.XMY,,.XMZ,)
"RTN","MAGIPS46",100,0)
 . I $G(XMERR) M XMERR=^TMP("XMERR",$J) S $EC=",U13-Cannot send MailMan message,"
"RTN","MAGIPS46",101,0)
 . Q
"RTN","MAGIPS46",102,0)
 Q
"RTN","MAGIPS46",103,0)
ADDRPC(RPCNAME,OPTNAME) ;
"RTN","MAGIPS46",104,0)
 ;
"RTN","MAGIPS46",105,0)
 NEW DA,DIC,I,X,Y
"RTN","MAGIPS46",106,0)
 ;
"RTN","MAGIPS46",107,0)
 S DIC="^DIC(19,",DIC(0)="",X=OPTNAME D ^DIC
"RTN","MAGIPS46",108,0)
 I Y<0 D  Q
"RTN","MAGIPS46",109,0)
 . W !,"Cannot add """_RPCNAME_""" to """_OPTNAME_"""."
"RTN","MAGIPS46",110,0)
 . W !,"Cannot find """_OPTNAME_"""."
"RTN","MAGIPS46",111,0)
 . Q
"RTN","MAGIPS46",112,0)
 S DA(1)=+Y
"RTN","MAGIPS46",113,0)
 S DIC=DIC_DA(1)_",""RPC"","
"RTN","MAGIPS46",114,0)
 S DIC(0)="L" ; LAYGO should be allowed here
"RTN","MAGIPS46",115,0)
 S X=RPCNAME
"RTN","MAGIPS46",116,0)
 D ^DIC
"RTN","MAGIPS46",117,0)
 I Y<0 D  Q
"RTN","MAGIPS46",118,0)
 . W !,"Cannot add """_RPCNAME_""" to """_OPTNAME_"""."
"RTN","MAGIPS46",119,0)
 . W !,"Cannot find """_RPCNAME_"""."
"RTN","MAGIPS46",120,0)
 . Q
"RTN","MAGIPS46",121,0)
 Q
"RTN","MAGIPS46",122,0)
DEFAULTS ;  Set default for location of TeleReader Timeout.
"RTN","MAGIPS46",123,0)
 ;
"RTN","MAGIPS46",124,0)
 NEW %,%H,D,D0,DA,DI,DIC,DIE,DQ,DR,X
"RTN","MAGIPS46",125,0)
 ;
"RTN","MAGIPS46",126,0)
 S X=0
"RTN","MAGIPS46",127,0)
 F  S X=$O(^MAG(2006.1,X)) Q:'+X  S DA=X,DIE="^MAG(2006.1,",DR="131///180" D ^DIE
"RTN","MAGIPS46",128,0)
 Q
"RTN","MAGIPS46",129,0)
XREF ;  Kill then Reset ALL xrefs for ALL entries.
"RTN","MAGIPS46",130,0)
 ;
"RTN","MAGIPS46",131,0)
 NEW DA,DIC,DIK,X
"RTN","MAGIPS46",132,0)
 ;
"RTN","MAGIPS46",133,0)
 Q:'$O(^MAG(2006.5849,0))
"RTN","MAGIPS46",134,0)
 ;
"RTN","MAGIPS46",135,0)
 S DIK="^MAG(2006.5849," D IXALL2^DIK  ;  KILL
"RTN","MAGIPS46",136,0)
 S DIK="^MAG(2006.5849," D IXALL^DIK   ;  SET
"RTN","MAGIPS46",137,0)
 Q
"RTN","MAGQE3")
0^25^B75156361
"RTN","MAGQE3",1,0)
MAGQE3 ;WOIFO/RMP - Support for MAG Enterprise ; 05/06/2004  06:32
"RTN","MAGQE3",2,0)
 ;;3.0;IMAGING;**27,29,30,20,46**;16-February-2007;;Build 1023
"RTN","MAGQE3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQE3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQE3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQE3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQE3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQE3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQE3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQE3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQE3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQE3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQE3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQE3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQE3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE3",17,0)
 ;;
"RTN","MAGQE3",18,0)
 Q
"RTN","MAGQE3",19,0)
 ;
"RTN","MAGQE3",20,0)
COUNT(SDATE,EDATE,INST,AI,IQ,DUP,TIOP,TGPP,TIEDP,GRPPRNT,IMAGE,DELETED) ;
"RTN","MAGQE3",21,0)
 N CLIN,CONSENTS,CPTR,D0,DAT,DICOM,DOC,DOCGRP,DOCUMENT,ED0,I,IMPORT
"RTN","MAGQE3",22,0)
 N NAME,OTHER,PCE,PROC,SD0,TRK,ZNODE,CNODE
"RTN","MAGQE3",23,0)
 S SD0=$$SDATE^MAGQE1(SDATE,"F")
"RTN","MAGQE3",24,0)
 S ED0=$$SDATE^MAGQE1(EDATE,"R")
"RTN","MAGQE3",25,0)
 S D0="" F  S D0=$O(^MAG(2005.02,"B","DOCUMENT",D0)) Q:D0=""  D
"RTN","MAGQE3",26,0)
 . S:$G(^MAG(2005.02,D0,4))["TIF" DOC(D0)=""
"RTN","MAGQE3",27,0)
 . Q
"RTN","MAGQE3",28,0)
 S (CONSENTS,GRPPRNT,IMAGE,DELETED,DOCGRP,DOCUMENT,DUP,TIOP,TGPP,TIEDP)=0
"RTN","MAGQE3",29,0)
 S IQ="0^0^0"
"RTN","MAGQE3",30,0)
 S CPTR=$O(^MAG(2005.83,"B","CONSENT",""))
"RTN","MAGQE3",31,0)
 S D0=SD0 F  S D0=$O(^MAG(2005,D0)) Q:'D0  Q:D0'<ED0  D
"RTN","MAGQE3",32,0)
 . S CNODE=$G(^MAG(2005,D0,100))
"RTN","MAGQE3",33,0)
 . S PCE=$P(CNODE,"^",3) Q:((PCE'=INST)&(AI'[("^"_PCE_"^")))
"RTN","MAGQE3",34,0)
 . S ZNODE=$G(^MAG(2005,D0,0))
"RTN","MAGQE3",35,0)
 . I $P(ZNODE,"^",2)="" S TGPP=TGPP+1 ;TOTAL FILE WIDE by Place 
"RTN","MAGQE3",36,0)
 . E  S TIOP=TIOP+1
"RTN","MAGQE3",37,0)
 . S X=$P($G(^MAG(2005,D0,2)),"^",1)\1 Q:'X  Q:X<SDATE  Q:X>EDATE
"RTN","MAGQE3",38,0)
 . S:$P(ZNODE,U,12) DUP=DUP+1
"RTN","MAGQE3",39,0)
 . S:($P(ZNODE,U,11)="") $P(IQ,U,1)=$P(IQ,U,1)+1
"RTN","MAGQE3",40,0)
 . S:($P(ZNODE,U,11)="0") $P(IQ,U,2)=$P(IQ,U,2)+1
"RTN","MAGQE3",41,0)
 . S:($P(ZNODE,U,11)="1") $P(IQ,U,3)=$P(IQ,U,3)+1
"RTN","MAGQE3",42,0)
 . S PCE=$P(CNODE,"^",5),TRK="" I PCE'="" D
"RTN","MAGQE3",43,0)
 . . S TRK=$P($G(^MAG(2006.04,$P(CNODE,U,4),0)),U)
"RTN","MAGQE3",44,0)
 . . S TRK=$S(TRK'="":TRK,1:"?") Q
"RTN","MAGQE3",45,0)
 . I $P(ZNODE,"^",2)="" D  Q
"RTN","MAGQE3",46,0)
 . . S GRPPRNT=GRPPRNT+1
"RTN","MAGQE3",47,0)
 . . S PCE=$P(ZNODE,"^",8) S:PCE="" PCE="NIL"
"RTN","MAGQE3",48,0)
 . . S:$D(^MAG(2005,D0,"PACS")) DICOM(PCE,0)=$G(DICOM(PCE,0))+1
"RTN","MAGQE3",49,0)
 . . S PCE=$P(ZNODE,"^",6) I PCE,$D(DOC(PCE)) S DOCGRP=DOCGRP+1
"RTN","MAGQE3",50,0)
 . . S:TRK'="" IMPORT(TRK,0)=$G(IMPORT(TRK,0))+1
"RTN","MAGQE3",51,0)
 . . Q
"RTN","MAGQE3",52,0)
 . S:TRK'="" IMPORT(TRK)=$G(IMPORT(TRK))+1
"RTN","MAGQE3",53,0)
 . I CPTR,$P($G(^MAG(2005,D0,40)),"^",3)=CPTR S CONSENTS=CONSENTS+1
"RTN","MAGQE3",54,0)
 . E  S PCE=$$UPPER^MAGQE4($P($G(^MAG(2005,D0,2)),"^",4)) S:PCE["CONSENT" OTHER(PCE)=$G(OTHER(PCE))+1
"RTN","MAGQE3",55,0)
 . S IMAGE=IMAGE+1
"RTN","MAGQE3",56,0)
 . S PCE=$P(ZNODE,"^",6) I PCE,$D(DOC(PCE)) S DOCUMENT=DOCUMENT+1
"RTN","MAGQE3",57,0)
 . S PCE=$P(ZNODE,"^",7) S:PCE="" PCE="NIL"
"RTN","MAGQE3",58,0)
 . S ^TMP($J,"MAGQ","ACQPAT",PCE)=""
"RTN","MAGQE3",59,0)
 . S ^TMP($J,"MAGQ","ALLPAT",PCE)=""
"RTN","MAGQE3",60,0)
 . S PCE=$P(ZNODE,"^",8) S:PCE="" PCE="NIL"
"RTN","MAGQE3",61,0)
 . I $D(^MAG(2005,D0,"PACS")) S DICOM(PCE)=$G(DICOM(PCE))+1
"RTN","MAGQE3",62,0)
 . E  S CLIN(PCE)=$G(CLIN(PCE))+1
"RTN","MAGQE3",63,0)
 . Q
"RTN","MAGQE3",64,0)
 S NAME="" F  S NAME=$O(DICOM(NAME)) Q:NAME=""  D
"RTN","MAGQE3",65,0)
 . D:$E(NAME,1,4)="RAD "
"RTN","MAGQE3",66,0)
 . . Q:'$D(DICOM(NAME,0))
"RTN","MAGQE3",67,0)
 . . S I=$E(NAME,5,$L(NAME)) Q:I=""
"RTN","MAGQE3",68,0)
 . . Q:$D(DICOM(I,0))
"RTN","MAGQE3",69,0)
 . . S DICOM(I,0)=DICOM(NAME,0) K DICOM(NAME,0) Q
"RTN","MAGQE3",70,0)
 . S PROC=$O(^RAMIS(73.1,"B",NAME,"")) Q:'PROC
"RTN","MAGQE3",71,0)
 . S $P(DICOM(NAME),"^",2)=$P($G(^RAMIS(73.1,PROC,0)),"^",2) Q
"RTN","MAGQE3",72,0)
 S D0=SD0 F  S D0=$O(^MAG(2005.1,D0)) Q:'D0  Q:D0'<ED0  D
"RTN","MAGQE3",73,0)
 . S PCE=$P($G(^MAG(2005.1,D0,100)),"^",3) Q:((PCE'=INST)&(AI'[("^"_PCE_"^")))
"RTN","MAGQE3",74,0)
 . S TIEDP=TIEDP+1
"RTN","MAGQE3",75,0)
 . S X=$P($G(^MAG(2005.1,D0,2)),"^",1)\1 Q:'X  Q:X<SDATE  Q:X>EDATE
"RTN","MAGQE3",76,0)
 . S DELETED=DELETED+1 Q
"RTN","MAGQE3",77,0)
 S I="" F  S I=$O(DICOM(I)) Q:I=""  D
"RTN","MAGQE3",78,0)
 . S X=" DICOM CAPTURE: "_I_"^"_$G(DICOM(I))
"RTN","MAGQE3",79,0)
 . S:$G(DICOM(I,0)) $P(X,"^",4)=DICOM(I,0)
"RTN","MAGQE3",80,0)
 . D MSG^MAGQE2(X) Q
"RTN","MAGQE3",81,0)
 S I="" F  S I=$O(IMPORT(I)) Q:I=""  D
"RTN","MAGQE3",82,0)
 . S X=" IMPORT API: "_I_"^"_IMPORT(I)
"RTN","MAGQE3",83,0)
 . S:$G(IMPORT(I,0)) X=X_"^"_IMPORT(I,0)
"RTN","MAGQE3",84,0)
 . D MSG^MAGQE2(X) Q
"RTN","MAGQE3",85,0)
 D LLOAD^MAGQE5(.CLIN,"CLIN CAPTURE:")
"RTN","MAGQE3",86,0)
 D MSG^MAGQE2("CONSENT FORMS: "_CONSENTS)
"RTN","MAGQE3",87,0)
 D LLOAD^MAGQE5(.OTHER,"OTHER CONSENTS:")
"RTN","MAGQE3",88,0)
 D MSG^MAGQE2("Document Images (TIF): "_DOCUMENT)
"RTN","MAGQE3",89,0)
 D MSG^MAGQE2("Document Groups (TIF): "_DOCGRP)
"RTN","MAGQE3",90,0)
 Q
"RTN","MAGQE3",91,0)
 ;
"RTN","MAGQE3",92,0)
ACT(D0,DIS,CAP,VD,VI,RES) ;
"RTN","MAGQE3",93,0)
 N ACT,AN,AN2,D1,IMG
"RTN","MAGQE3",94,0)
 S D1=0 F  S D1=$O(^MAG(2006.82,D0,"ACT",D1)) Q:'D1  D
"RTN","MAGQE3",95,0)
 . S AN=^MAG(2006.82,D0,"ACT",D1,0)
"RTN","MAGQE3",96,0)
 . S ACT="^"_$P(AN,"^",1)_"^",AN2=+$P(AN,"^",2)
"RTN","MAGQE3",97,0)
 . Q:"^LOGON^LOGOFF^PAT^"[ACT
"RTN","MAGQE3",98,0)
 . I "^SC_BAD^SCR_OK^"[ACT D  Q
"RTN","MAGQE3",99,0)
 . . S AN=$P(AN,"^",10,14) Q:AN=""
"RTN","MAGQE3",100,0)
 . . S RES(ACT,AN)=$G(RES(ACT,AN))+1 Q
"RTN","MAGQE3",101,0)
 . I "^CAP^IMG^"[ACT D  Q
"RTN","MAGQE3",102,0)
 . . S IMG=+$P(AN,"^",3) Q:'IMG  Q:$P($G(^MAG(2005,IMG,0)),"^",2)=""
"RTN","MAGQE3",103,0)
 . . I ACT="^CAP^" S CAP=CAP+1 Q
"RTN","MAGQE3",104,0)
 . . S DIS=DIS+1,^TMP($J,"MAGQ","DISPAT",AN2)="",^TMP($J,"MAGQ","ALLPAT",AN2)=""
"RTN","MAGQE3",105,0)
 . . Q
"RTN","MAGQE3",106,0)
 . I "^VR-VW^"[ACT D VRAD(.VD,AN) S ^TMP($J,"MAGQ","DISPAT",AN2)="",^TMP($J,"MAGQ","ALLPAT",AN2)="" Q
"RTN","MAGQE3",107,0)
 . I "^VR-INT^"[ACT D VRAD(.VI,AN) S ^TMP($J,"MAGQ","DISPAT",AN2)="",^TMP($J,"MAGQ","ALLPAT",AN2)="" Q
"RTN","MAGQE3",108,0)
 . Q
"RTN","MAGQE3",109,0)
 Q
"RTN","MAGQE3",110,0)
 ;
"RTN","MAGQE3",111,0)
VRAD(ARR,AN) ;
"RTN","MAGQE3",112,0)
 ;ARR=STUDIES^IMAGES^PATIENTS^User Type(Rad/Non-Rad)^Remotes(Remote/Local)^Modalities
"RTN","MAGQE3",113,0)
 N P,X
"RTN","MAGQE3",114,0)
 S $P(ARR,"^",1)=$P($G(ARR),"^",1)+1 ; Studies
"RTN","MAGQE3",115,0)
 S $P(ARR,"^",2)=$P($G(ARR),"^",2)+$P(AN,"^",6) ; Images
"RTN","MAGQE3",116,0)
 S $P(ARR,"^",3)=$P($G(ARR),"^",3)+$P(AN,"^",7) ; Patients
"RTN","MAGQE3",117,0)
 S P=$P(ARR,"^",4)
"RTN","MAGQE3",118,0)
 I +$P(AN,"^",8)=1 S $P(P,"/",1)=$P(P,"/",1)+1
"RTN","MAGQE3",119,0)
 E  S $P(P,"/",2)=$P(P,"/",2)+1
"RTN","MAGQE3",120,0)
 S $P(ARR,"^",4)=P ; User Type
"RTN","MAGQE3",121,0)
 S P=$P(ARR,"^",5)
"RTN","MAGQE3",122,0)
 I +$P(AN,"^",9)=1 S $P(P,"/",1)=$P(P,"/",1)+1
"RTN","MAGQE3",123,0)
 E  S $P(P,"/",2)=$P(P,"/",2)+1
"RTN","MAGQE3",124,0)
 S $P(ARR,"^",5)=P ; Remotes
"RTN","MAGQE3",125,0)
 S P=$P(AN,"^",4) S:P="" P="unknown"
"RTN","MAGQE3",126,0)
 S ARR(P)=$G(ARR(P))+1
"RTN","MAGQE3",127,0)
 S (P,X)="" F  S P=$O(ARR(P)) Q:P=""  S X=X_"/"_P_"="_ARR(P)
"RTN","MAGQE3",128,0)
 S $P(ARR,"^",6)=X ; Modalities
"RTN","MAGQE3",129,0)
 Q
"RTN","MAGQE3",130,0)
 ;
"RTN","MAGQE3",131,0)
GPACHX() ; Get Package File Install History of Imaging
"RTN","MAGQE3",132,0)
 N I,LCNT,MSG,PKG,PKT,PV
"RTN","MAGQE3",133,0)
 S LCNT=0
"RTN","MAGQE3",134,0)
 F PKG="IMAGING","MAGJ RADIOLOGY" D
"RTN","MAGQE3",135,0)
 . N J,K,L,PKNAM,VERS
"RTN","MAGQE3",136,0)
 . S J=$$FIND1^DIC(9.4,",","MX",PKG) Q:'J
"RTN","MAGQE3",137,0)
 . I PKG="MAGJ RADIOLOGY" D  Q
"RTN","MAGQE3",138,0)
 . . N TAR
"RTN","MAGQE3",139,0)
 . . D LIST^DIC(9.49,","_J_",","@;.01;2;3","","","","","","","","TAR","MSG")
"RTN","MAGQE3",140,0)
 . . Q:$D(MSG("DIERR"))
"RTN","MAGQE3",141,0)
 . . S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQE3",142,0)
 . . . S LCNT=LCNT+1
"RTN","MAGQE3",143,0)
 . . . S PV(LCNT)=PKG_"^P"_$P(TAR("DILIST","ID",L,".01"),"^",1)
"RTN","MAGQE3",144,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$P(TAR("DILIST","ID",L,"2"),"^",1)
"RTN","MAGQE3",145,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$P(TAR("DILIST","ID",L,"3"),"^",1) Q
"RTN","MAGQE3",146,0)
 . . Q
"RTN","MAGQE3",147,0)
 . K PKT D LIST^DIC(9.49,","_J_",",.01,"","*","","","B","","","PKT","MSG")
"RTN","MAGQE3",148,0)
 . S VERS="" F  S VERS=$O(PKT("DILIST",2,VERS)) Q:VERS=""  S K=PKT("DILIST",2,VERS) D
"RTN","MAGQE3",149,0)
 . . K MSG
"RTN","MAGQE3",150,0)
 . . D LIST^DIC(9.4901,","_K_","_J_",","@;.01;.02;.03","","","","","","","","TAR","MSG")
"RTN","MAGQE3",151,0)
 . . Q:$D(MSG("DIERR"))
"RTN","MAGQE3",152,0)
 . . S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQE3",153,0)
 . . . S LCNT=LCNT+1
"RTN","MAGQE3",154,0)
 . . . S PV(LCNT)=PKG_"^"_VERS_"P"_$P(TAR("DILIST","ID",L,".01"),"^",1)
"RTN","MAGQE3",155,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$P(TAR("DILIST","ID",L,".02"),"^",1)
"RTN","MAGQE3",156,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$P(TAR("DILIST","ID",L,".03"),"^",1) Q
"RTN","MAGQE3",157,0)
 . . Q
"RTN","MAGQE3",158,0)
 . Q
"RTN","MAGQE3",159,0)
 S I="" F  S I=$O(PV(I)) Q:I=""  D
"RTN","MAGQE3",160,0)
 . D MSG^MAGQE2("IMAGING PACKAGE INSTALLATION HX: "_I_"^"_PV(I)) Q
"RTN","MAGQE3",161,0)
 Q
"RTN","MAGQE3",162,0)
 ;
"RTN","MAGQE3",163,0)
ADCNT(SDATE,EDATE,INST,AI) ;
"RTN","MAGQE3",164,0)
 ; SAC = Scanned, Administrative Closure SMC = Scanned, Manual Closure UMC = Unscanned, Manual Closure
"RTN","MAGQE3",165,0)
 N ARRY,D0,D1,DATE,DATES,DOC,HLOC,SAC,SCR,SMC,STAT,STATA,STATC,TITLE,TIUDA,UMC
"RTN","MAGQE3",166,0)
 S STATA="^",D0=0 F  S D0=$O(^TIU(8925.6,"B","AMENDED",D0)) Q:'D0  D
"RTN","MAGQE3",167,0)
 . S STATA=STATA_D0_"^" Q
"RTN","MAGQE3",168,0)
 S STATC="^",D0=0 F  S D0=$O(^TIU(8925.6,"B","COMPLETED",D0)) Q:'D0  D
"RTN","MAGQE3",169,0)
 . S STATC=STATC_D0_"^" Q
"RTN","MAGQE3",170,0)
 S DOC="ADVANCE DIRECTIVE"
"RTN","MAGQE3",171,0)
 S D0=0 F  S D0=$O(^TIU(8925.1,"B",DOC,D0)) Q:'D0  D
"RTN","MAGQE3",172,0)
 . Q:$P($G(^TIU(8925.1,D0,0)),"^",4)'="DC"
"RTN","MAGQE3",173,0)
 . S D1=0 F  S D1=$O(^TIU(8925.1,D0,10,"B",D1)) Q:'D1  D
"RTN","MAGQE3",174,0)
 . . S TITLE=$P($G(^TIU(8925.1,+D1,0)),"^",1) S:TITLE="" TITLE=" "
"RTN","MAGQE3",175,0)
 . . S ARRY(TITLE,D1)="" Q
"RTN","MAGQE3",176,0)
 . Q
"RTN","MAGQE3",177,0)
 S SCR="",(SAC,SMC,UMC)=0
"RTN","MAGQE3",178,0)
 S TITLE="" F  S TITLE=$O(ARRY(TITLE)) Q:TITLE=""  D
"RTN","MAGQE3",179,0)
 . S D1="" F  S D1=$O(ARRY(TITLE,D1)) Q:D1=""  D
"RTN","MAGQE3",180,0)
 . . S TIUDA=0 F  S TIUDA=$O(^TIU(8925,"B",D1,TIUDA)) Q:'TIUDA  D
"RTN","MAGQE3",181,0)
 . . . N MSG,TARGET
"RTN","MAGQE3",182,0)
 . . . S SCR="" ; INSTITUTION screen for consolidation sites only.
"RTN","MAGQE3",183,0)
 . . . D GETS^DIQ(8925,TIUDA,".05;1205;1501;1507;1603;1606;1613","IE","TARGET","MSG")
"RTN","MAGQE3",184,0)
 . . . Q:$D(MSG("DIERR"))
"RTN","MAGQE3",185,0)
 . . . I $$CONSOLID^MAGQE5() D  Q:SCR
"RTN","MAGQE3",186,0)
 . . . . S HLOC=TARGET(8925,TIUDA_",",1205,"I") ; INSTITUTION screen - dependent upon TIU*1*113
"RTN","MAGQE3",187,0)
 . . . . I HLOC="" S SCR=1
"RTN","MAGQE3",188,0)
 . . . . E  I (($P($G(^SC(HLOC,0)),"^",4)'=INST)&(AI'[("^"_$P($G(^SC(HLOC,0)),"^",4)_"^")))  S SCR=1
"RTN","MAGQE3",189,0)
 . . . . Q
"RTN","MAGQE3",190,0)
 . . . S STAT="^"_TARGET(8925,TIUDA_",",.05,"I")_"^"
"RTN","MAGQE3",191,0)
 . . . Q:STATA_STATC'[STAT
"RTN","MAGQE3",192,0)
 . . . I TARGET(8925,TIUDA_",",1613,"I")="S" D  Q
"RTN","MAGQE3",193,0)
 . . . . Q:TARGET(8925,TIUDA_",",1606,"I")<SDATE
"RTN","MAGQE3",194,0)
 . . . . Q:$P(TARGET(8925,TIUDA_",",1606,"I"),".")>EDATE
"RTN","MAGQE3",195,0)
 . . . . S SAC=SAC+1,SAC(TITLE)=$G(SAC(TITLE))+1 Q
"RTN","MAGQE3",196,0)
 . . . I STATC[STAT D  Q
"RTN","MAGQE3",197,0)
 . . . . S DATE=TARGET(8925,TIUDA_",",1507,"I")
"RTN","MAGQE3",198,0)
 . . . . S DATE=$S(DATE?1.N:DATE,1:+TARGET(8925,TIUDA_",",1501,"I"))
"RTN","MAGQE3",199,0)
 . . . . Q:DATE<SDATE
"RTN","MAGQE3",200,0)
 . . . . Q:$P(DATE,".")>EDATE
"RTN","MAGQE3",201,0)
 . . . . I $$SCAN(TIUDA) S SMC=SMC+1,SMC(TITLE)=$G(SMC(TITLE))+1 Q
"RTN","MAGQE3",202,0)
 . . . . S UMC=UMC+1,UMC(TITLE)=$G(UMC(TITLE))+1 Q
"RTN","MAGQE3",203,0)
 . . . I STATA[STAT D  Q
"RTN","MAGQE3",204,0)
 . . . . Q:TARGET(8925,TIUDA_",",1603,"I")<SDATE
"RTN","MAGQE3",205,0)
 . . . . Q:$P(TARGET(8925,TIUDA_",",1603,"I"),".")>EDATE
"RTN","MAGQE3",206,0)
 . . . . I $$SCAN(TIUDA) S SMC=SMC+1,SMC(TITLE)=$G(SMC(TITLE))+1 Q
"RTN","MAGQE3",207,0)
 . . . . S UMC=UMC+1,UMC(TITLE)=$G(UMC(TITLE))+1 Q
"RTN","MAGQE3",208,0)
 . . . Q
"RTN","MAGQE3",209,0)
 . . Q
"RTN","MAGQE3",210,0)
 . Q
"RTN","MAGQE3",211,0)
 D MSG^MAGQE2(DOC_" SCANNED ADMINISTRATIVE CLOSURE: "_SAC)
"RTN","MAGQE3",212,0)
 S TITLE="" F  S TITLE=$O(SAC(TITLE)) Q:TITLE=""  D
"RTN","MAGQE3",213,0)
 . D MSG^MAGQE2(DOC_" - SAC - "_TITLE_": "_SAC(TITLE)) Q
"RTN","MAGQE3",214,0)
 D MSG^MAGQE2(DOC_" UNSCANNED MANUAL CLOSURE: "_UMC)
"RTN","MAGQE3",215,0)
 S TITLE="" F  S TITLE=$O(UMC(TITLE)) Q:TITLE=""  D
"RTN","MAGQE3",216,0)
 . D MSG^MAGQE2(DOC_" - UMC - "_TITLE_": "_UMC(TITLE)) Q
"RTN","MAGQE3",217,0)
 D MSG^MAGQE2(DOC_" SCANNED MANUAL CLOSURE: "_SMC)
"RTN","MAGQE3",218,0)
 S TITLE="" F  S TITLE=$O(SMC(TITLE)) Q:TITLE=""  D
"RTN","MAGQE3",219,0)
 . D MSG^MAGQE2(DOC_" - SMC - "_TITLE_": "_SMC(TITLE)) Q
"RTN","MAGQE3",220,0)
 Q
"RTN","MAGQE3",221,0)
 ;
"RTN","MAGQE3",222,0)
SCAN(IEN) ;
"RTN","MAGQE3",223,0)
 N LINK
"RTN","MAGQE3",224,0)
 S LINK=$O(^TIU(8925.91,"B",IEN,"")) Q:'LINK 0
"RTN","MAGQE3",225,0)
 Q $S($P($G(^TIU(8925.1,LINK,0)),"^",2)?1.N:0,1:1)
"RTN","MAGQE3",226,0)
 ;
"RTN","MAGQE5")
0^26^B54546885
"RTN","MAGQE5",1,0)
MAGQE5 ;WOIFO/RMP - Support for MAG Enterprise ; 08/29/2006 09:48
"RTN","MAGQE5",2,0)
 ;;3.0;IMAGING;**27,29,8,30,20,46**;16-February-2007;;Build 1023
"RTN","MAGQE5",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQE5",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE5",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQE5",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQE5",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQE5",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQE5",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQE5",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQE5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQE5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQE5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQE5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQE5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQE5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE5",17,0)
 ;;
"RTN","MAGQE5",18,0)
ISU2 ;
"RTN","MAGQE5",19,0)
 ; Workstation Session and Patient counts
"RTN","MAGQE5",20,0)
 N CCNT,D0,DATE,ICNT,M1,M2,PCNT,RES,SCNAD,SCNMN,SCNT,TD,TD1,UNSCN,VD,VI,X1,X2,YR,AI,DUP,IQ,TIOP,TGPP,TIEDP
"RTN","MAGQE5",21,0)
 N GRPPRNT,IMAGE,DELETED
"RTN","MAGQE5",22,0)
 S (SCNT,PCNT,ICNT,CCNT,DUP,TIOP,TGPP,TIEDP,GRPPRNT,IMAGE,DELETED)=0
"RTN","MAGQE5",23,0)
 S (VD,VI)=""
"RTN","MAGQE5",24,0)
 I '$$CONSOLID() D
"RTN","MAGQE5",25,0)
 . S DATE="L"_START
"RTN","MAGQE5",26,0)
 . F  S DATE=$O(^MAG(2006.82,"AC",DATE)) Q:DATE=""  Q:$P(DATE,"L",2)\1>STOP  D
"RTN","MAGQE5",27,0)
 . . S D0=0 F  S D0=$O(^MAG(2006.82,"AC",DATE,D0)) Q:'D0  D
"RTN","MAGQE5",28,0)
 . . . Q:'$D(^MAG(2006.82,D0,1))
"RTN","MAGQE5",29,0)
 . . . S SCNT=SCNT+1
"RTN","MAGQE5",30,0)
 . . . S PCNT=PCNT+$P($G(^MAG(2006.82,D0,1)),"^",1)
"RTN","MAGQE5",31,0)
 . . . D ACT^MAGQE3(D0,.ICNT,.CCNT,.VD,.VI,.RES)
"RTN","MAGQE5",32,0)
 . . . Q
"RTN","MAGQE5",33,0)
 . . Q
"RTN","MAGQE5",34,0)
 . Q
"RTN","MAGQE5",35,0)
 E  D
"RTN","MAGQE5",36,0)
 . S DATE=START
"RTN","MAGQE5",37,0)
 . F  S DATE=$O(^MAG(2006.82,"APL",PLACE,DATE)) Q:DATE=""  Q:DATE\1>STOP  D
"RTN","MAGQE5",38,0)
 . . S D0=0 F  S D0=$O(^MAG(2006.82,"APL",PLACE,DATE,D0)) Q:D0'?1.N  D
"RTN","MAGQE5",39,0)
 . . . Q:'$D(^MAG(2006.82,D0,1))
"RTN","MAGQE5",40,0)
 . . . S SCNT=SCNT+1
"RTN","MAGQE5",41,0)
 . . . S PCNT=PCNT+$P($G(^MAG(2006.82,D0,1)),"^",1)
"RTN","MAGQE5",42,0)
 . . . D ACT^MAGQE3(D0,.ICNT,.CCNT,.VD,.VI,.RES)
"RTN","MAGQE5",43,0)
 . . . Q
"RTN","MAGQE5",44,0)
 . . Q
"RTN","MAGQE5",45,0)
 . Q
"RTN","MAGQE5",46,0)
 S X1=START,X2=STOP D ^%DTC S X=$TR(X,"-")+1_" day "
"RTN","MAGQE5",47,0)
 D MSG^MAGQE2(X_"Image Workstation Sessions: "_SCNT)
"RTN","MAGQE5",48,0)
 D MSG^MAGQE2(X_"Image Workstation Patients: "_PCNT)
"RTN","MAGQE5",49,0)
 D MSG^MAGQE2(X_"Image Workstation Images: "_ICNT)
"RTN","MAGQE5",50,0)
 D MSG^MAGQE2(X_"Image Workstation Captures: "_CCNT)
"RTN","MAGQE5",51,0)
 D MSG^MAGQE2(X_"VistaRad WS Display: "_VD)
"RTN","MAGQE5",52,0)
 D MSG^MAGQE2(X_"VistaRad WS Interpretations: "_VI)
"RTN","MAGQE5",53,0)
 K VD,VI
"RTN","MAGQE5",54,0)
 I $T(AVERAGE^MAGBRTLD)'="" D
"RTN","MAGQE5",55,0)
 . D MSG^MAGQE2(X_"average daily routed images: "_$$AVERAGE^MAGBRTLD())
"RTN","MAGQE5",56,0)
 . Q
"RTN","MAGQE5",57,0)
 D BPV^MAGQE1(PLACE)
"RTN","MAGQE5",58,0)
 D MSG^MAGQE2("Vista Image Version/Build: "_$$VSTAV^MAGQE1())
"RTN","MAGQE5",59,0)
 D DICOMV^MAGQE1()
"RTN","MAGQE5",60,0)
 D MSG^MAGQE2("Image file namespace(s): "_$$SNS^MAGQE1(PLACE))
"RTN","MAGQE5",61,0)
 S I="" F  S I=$O(RES(I)) Q:I=""  D
"RTN","MAGQE5",62,0)
 . S RES="" F  S RES=$O(RES(I,RES)) Q:RES=""  D
"RTN","MAGQE5",63,0)
 . . S X=$TR(I,"^")_"^"_RES S $P(X,"^",6)=RES(I,RES)
"RTN","MAGQE5",64,0)
 . . D MSG^MAGQE2(" RESOLUTION: "_X)
"RTN","MAGQE5",65,0)
 . . Q
"RTN","MAGQE5",66,0)
 . Q
"RTN","MAGQE5",67,0)
 K RES
"RTN","MAGQE5",68,0)
 ;
"RTN","MAGQE5",69,0)
 S AI=$$GETAI(PLACE)
"RTN","MAGQE5",70,0)
 D COUNT^MAGQE3(START,STOP,INST,AI,.IQ,.DUP,.TIOP,.TGPP,.TIEDP,.GRPPRNT,.IMAGE,.DELETED)
"RTN","MAGQE5",71,0)
 D MSG^MAGQE2("Total Image Objects for Place: "_TIOP)
"RTN","MAGQE5",72,0)
 D MSG^MAGQE2("Total Group Parents for Place: "_TGPP)
"RTN","MAGQE5",73,0)
 D MSG^MAGQE2("Total Image Entry Deletes for Place: "_TIEDP)
"RTN","MAGQE5",74,0)
 D MSG^MAGQE2("Image file group parents: "_GRPPRNT)
"RTN","MAGQE5",75,0)
 D MSG^MAGQE2("Image file objects: "_IMAGE)
"RTN","MAGQE5",76,0)
 D MSG^MAGQE2("Image file deletes: "_DELETED)
"RTN","MAGQE5",77,0)
 ;
"RTN","MAGQE5",78,0)
 S (I,D0)=0 F  S D0=$O(^TMP($J,"MAGQ","ACQPAT",D0)) Q:D0=""  S I=I+1
"RTN","MAGQE5",79,0)
 D MSG^MAGQE2("Unique Image patients captured: "_I)
"RTN","MAGQE5",80,0)
 K ^TMP($J,"MAGQ","ACQPAT")
"RTN","MAGQE5",81,0)
 S (I,D0)=0 F  S D0=$O(^TMP($J,"MAGQ","DISPAT",D0)) Q:D0=""  S I=I+1
"RTN","MAGQE5",82,0)
 D MSG^MAGQE2("Unique Image patients display: "_I)
"RTN","MAGQE5",83,0)
 K ^TMP($J,"MAGQ","DISPAT")
"RTN","MAGQE5",84,0)
 S (I,D0)=0 F  S D0=$O(^TMP($J,"MAGQ","ALLPAT",D0)) Q:D0=""  S I=I+1
"RTN","MAGQE5",85,0)
 D MSG^MAGQE2("Unique Image patients All: "_I)
"RTN","MAGQE5",86,0)
 K ^TMP($J,"MAGQ","ALLPAT")
"RTN","MAGQE5",87,0)
 D MSG^MAGQE2("Total Non-Verified Images for Place: "_$P(IQ,U,1))
"RTN","MAGQE5",88,0)
 D MSG^MAGQE2("Total Verified Images for Place: "_$P(IQ,U,2))
"RTN","MAGQE5",89,0)
 D MSG^MAGQE2("Total Integrity Issues for Place: "_$P(IQ,U,3))
"RTN","MAGQE5",90,0)
 D MSG^MAGQE2("Total Duplicate Images for Place: "_DUP)
"RTN","MAGQE5",91,0)
 D START^MAGQE6(START,STOP,INST,"TLR")
"RTN","MAGQE5",92,0)
 D ADCNT^MAGQE3(START,STOP,INST,AI)
"RTN","MAGQE5",93,0)
 D GPACHX^MAGQE3()
"RTN","MAGQE5",94,0)
 D GS1^MAGQE5() ;Get Share data
"RTN","MAGQE5",95,0)
 D AI1^MAGQE5() ;Get Associated Institutions
"RTN","MAGQE5",96,0)
 Q
"RTN","MAGQE5",97,0)
 ;
"RTN","MAGQE5",98,0)
AHOPT ;
"RTN","MAGQE5",99,0)
 N %DT,START,STOP
"RTN","MAGQE5",100,0)
 S STOP=$$FMADD^XLFDT($$NOW^XLFDT()\100_"01",-1)
"RTN","MAGQE5",101,0)
 S START=STOP\100_"01"
"RTN","MAGQE5",102,0)
 S Y=START D DD^%DT S %DT("B")=Y
"RTN","MAGQE5",103,0)
 S %DT="AEXP",%DT("A")="Enter starting Date: "
"RTN","MAGQE5",104,0)
 D ^%DT I ((X="")!(X="^")!($D(DTOUT))) K %DT(0),DTOUT Q
"RTN","MAGQE5",105,0)
 S START=Y
"RTN","MAGQE5",106,0)
 S Y=STOP D DD^%DT S %DT("B")=Y
"RTN","MAGQE5",107,0)
 S %DT="AEXP",%DT("A")="Enter ending Date: "
"RTN","MAGQE5",108,0)
 D ^%DT I ((X="")!(X="^")!($D(DTOUT))) K %DT(0),DTOUT Q
"RTN","MAGQE5",109,0)
 S STOP=Y
"RTN","MAGQE5",110,0)
 W !!,"Creating ad-hoc report over the period "
"RTN","MAGQE5",111,0)
 W $$DT(START)," until ",$$DT(STOP),".",!
"RTN","MAGQE5",112,0)
 D AHISU^MAGQE2(START,STOP)
"RTN","MAGQE5",113,0)
 Q
"RTN","MAGQE5",114,0)
 ;
"RTN","MAGQE5",115,0)
DT(X) ;
"RTN","MAGQE5",116,0)
 Q (X\1#100)_"-"_$P("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"," ",X\100#100)_"-"_(X\10000+1700)
"RTN","MAGQE5",117,0)
 ;
"RTN","MAGQE5",118,0)
LLOAD(AR,LBL) ;
"RTN","MAGQE5",119,0)
 N I
"RTN","MAGQE5",120,0)
 S I="" F  S I=$O(AR(I)) Q:I=""  D MSG^MAGQE2(" "_LBL_" "_I_"^"_AR(I))
"RTN","MAGQE5",121,0)
 Q
"RTN","MAGQE5",122,0)
 ;
"RTN","MAGQE5",123,0)
GETPLACE(PLACE) ; Validate place
"RTN","MAGQE5",124,0)
 S PLACE=$S($$CONSOLID():$G(PLACE),1:+$O(^MAG(2006.1," "),-1)) Q:'PLACE 0
"RTN","MAGQE5",125,0)
 S:$P($G(^MAG(2006.1,PLACE,0)),"^",1)="" PLACE=0
"RTN","MAGQE5",126,0)
 Q PLACE
"RTN","MAGQE5",127,0)
 ;
"RTN","MAGQE5",128,0)
CONSOLID() ;
"RTN","MAGQE5",129,0)
 ; Return value: 0 = site not consolidated,
"RTN","MAGQE5",130,0)
 ;               1 = site is consolidated
"RTN","MAGQE5",131,0)
 N FLDNFO
"RTN","MAGQE5",132,0)
 D FIELD^DID(2006.1,.01,"","SPECIFIER","FLDNFO")
"RTN","MAGQE5",133,0)
 I $G(FLDNFO("SPECIFIER"))["P" Q 1
"RTN","MAGQE5",134,0)
 Q 0
"RTN","MAGQE5",135,0)
 ;
"RTN","MAGQE5",136,0)
PLACE(INST) ;
"RTN","MAGQE5",137,0)
 Q:'$$CONSOLID() +$O(^MAG(2006.1," "),-1)
"RTN","MAGQE5",138,0)
 Q $$GETPLACE(+$O(^MAG(2006.1,"B",INST,"")))
"RTN","MAGQE5",139,0)
 ;
"RTN","MAGQE5",140,0)
QCNT(READY,PLACE) ;
"RTN","MAGQE5",141,0)
 N D0,FAILED,NEXT,TYPE
"RTN","MAGQE5",142,0)
 S (READY,FAILED)=0
"RTN","MAGQE5",143,0)
 I $$CONSOLID() D
"RTN","MAGQE5",144,0)
 . S TYPE="" F  S TYPE=$O(^MAGQUEUE(2006.031,"C",PLACE,TYPE)) Q:TYPE=""  D
"RTN","MAGQE5",145,0)
 . . S NEXT=+$O(^MAGQUEUE(2006.031,"C",PLACE,TYPE,""))
"RTN","MAGQE5",146,0)
 . . S NEXT=+$P($G(^MAGQUEUE(2006.031,NEXT,0)),"^",2)
"RTN","MAGQE5",147,0)
 . . S D0=0 F  S D0=$O(^MAGQUEUE(2006.03,"C",PLACE,TYPE,D0)) Q:'D0  D
"RTN","MAGQE5",148,0)
 . . . I D0<NEXT S FAILED=FAILED+1
"RTN","MAGQE5",149,0)
 . . . E  S READY=READY+1
"RTN","MAGQE5",150,0)
 . . . Q
"RTN","MAGQE5",151,0)
 . . Q
"RTN","MAGQE5",152,0)
 E  D
"RTN","MAGQE5",153,0)
 . S TYPE="" F  S TYPE=$O(^MAGQUEUE(2006.031,"B",TYPE)) Q:TYPE=""  D
"RTN","MAGQE5",154,0)
 . . S NEXT=+$O(^MAGQUEUE(2006.031,"B",TYPE,""))
"RTN","MAGQE5",155,0)
 . . S NEXT=+$P($G(^MAGQUEUE(2006.031,NEXT,0)),"^",2)
"RTN","MAGQE5",156,0)
 . . S D0=0 F  S D0=$O(^MAGQUEUE(2006.03,"B",TYPE,D0)) Q:'D0  D
"RTN","MAGQE5",157,0)
 . . . I D0<NEXT S FAILED=FAILED+1
"RTN","MAGQE5",158,0)
 . . . E  S READY=READY+1
"RTN","MAGQE5",159,0)
 . . . Q
"RTN","MAGQE5",160,0)
 . . Q
"RTN","MAGQE5",161,0)
 . Q
"RTN","MAGQE5",162,0)
 Q READY+FAILED
"RTN","MAGQE5",163,0)
 ;
"RTN","MAGQE5",164,0)
WSP(PLACE) ; Imaging workstations per place
"RTN","MAGQE5",165,0)
 N COUNT,D0,RD
"RTN","MAGQE5",166,0)
 S RD=$$FMADD^XLFDT($$NOW^XLFDT,-180,"","","")
"RTN","MAGQE5",167,0)
 S (D0,COUNT)=0 F  S D0=$O(^MAG(2006.81,"C",PLACE,D0)) Q:'D0  D
"RTN","MAGQE5",168,0)
 . S:$P(^MAG(2006.81,D0,0),"^",3)'<RD COUNT=COUNT+1
"RTN","MAGQE5",169,0)
 . Q
"RTN","MAGQE5",170,0)
 Q COUNT
"RTN","MAGQE5",171,0)
 ;
"RTN","MAGQE5",172,0)
MAGDUZ2() Q $G(DUZ(2),$$KSP^XUPARAM("INST"))
"RTN","MAGQE5",173,0)
 ;
"RTN","MAGQE5",174,0)
GS1() ; Get local Network location share data
"RTN","MAGQE5",175,0)
 N I,L,M,MSG,RESULT,TAR
"RTN","MAGQE5",176,0)
 S RESULT(0)="NETWORK LOCATION^PHYSICAL REFERENCE^TOTAL SPACE^SPACE USED^FREE SPACE^OPERATIONAL STATUS^STORAGE TYPE^HASH"
"RTN","MAGQE5",177,0)
 D LIST^DIC(2005.2,"","@;.01;1;2;3;4;5;6;7","","","","","","I $P(^(0),U,10)=PLACE","","TAR","MSG")
"RTN","MAGQE5",178,0)
 Q:$D(MSG("DIERR"))
"RTN","MAGQE5",179,0)
 S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQE5",180,0)
 . S RESULT(L)=$P(TAR("DILIST","ID",L,.01),U,1)
"RTN","MAGQE5",181,0)
 . F M=1,2,3,4,5,6,7 S RESULT(L)=RESULT(L)_U_$P(TAR("DILIST","ID",L,M),U,1)
"RTN","MAGQE5",182,0)
 . Q
"RTN","MAGQE5",183,0)
 S I="" F  S I=$O(RESULT(I)) Q:I=""  D
"RTN","MAGQE5",184,0)
 . D MSG^MAGQE2("LOCAL NETWORK LOCATIONS: "_I_"^"_RESULT(I))
"RTN","MAGQE5",185,0)
 . Q
"RTN","MAGQE5",186,0)
 K TAR,MSG,RESULT
"RTN","MAGQE5",187,0)
 Q
"RTN","MAGQE5",188,0)
AI1() ; get Associated Institutions list per place
"RTN","MAGQE5",189,0)
 N I,L,M,MSG,RESULT,TAR
"RTN","MAGQE5",190,0)
 S RESULT(0)="Associated Institutions"
"RTN","MAGQE5",191,0)
 D LIST^DIC(2006.12,","_PLACE_",","@;.01","","","","","","","","TAR","MSG")
"RTN","MAGQE5",192,0)
 Q:$D(MSG("DIERR"))
"RTN","MAGQE5",193,0)
 S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQE5",194,0)
 . S RESULT(L)=$P(TAR("DILIST","ID",L,.01),U,1)
"RTN","MAGQE5",195,0)
 . Q
"RTN","MAGQE5",196,0)
 S I="" F  S I=$O(RESULT(I)) Q:I=""  D
"RTN","MAGQE5",197,0)
 . D MSG^MAGQE2("ASSOCIATED INSTITUTIONS: "_I_"^"_RESULT(I))
"RTN","MAGQE5",198,0)
 . Q
"RTN","MAGQE5",199,0)
 K TAR,MSG,RESULT
"RTN","MAGQE5",200,0)
 Q
"RTN","MAGQE5",201,0)
GETAI(PLACE,PARAM) ;
"RTN","MAGQE5",202,0)
 N I,J
"RTN","MAGQE5",203,0)
 S PARAM=$S('$D(PARAM):U,PARAM="":U,1:PARAM)
"RTN","MAGQE5",204,0)
 S I="",J=PARAM
"RTN","MAGQE5",205,0)
 F  S I=$O(^MAG(2006.1,PLACE,"INSTS","B",I)) Q:I=""  S J=J_I_PARAM
"RTN","MAGQE5",206,0)
 Q J
"RTN","MAGQE5",207,0)
 ;
"RTN","MAGQE6")
0^27^B11312577
"RTN","MAGQE6",1,0)
MAGQE6 ;WOIFO/OHH - Counts for Remote Image Views ; 08/29/2006 09:48
"RTN","MAGQE6",2,0)
 ;;3.0;IMAGING;**46**;16-February-2007;;Build 1023
"RTN","MAGQE6",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQE6",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE6",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQE6",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQE6",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQE6",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQE6",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQE6",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQE6",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQE6",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQE6",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQE6",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQE6",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQE6",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE6",17,0)
 ;;
"RTN","MAGQE6",18,0)
 Q
"RTN","MAGQE6",19,0)
 ; This routine collects information related to telereader read/unread
"RTN","MAGQE6",20,0)
 ; list activities and passes it to MAG-Enterprise, so that it will
"RTN","MAGQE6",21,0)
 ; appear in the monthly reports.
"RTN","MAGQE6",22,0)
 ;
"RTN","MAGQE6",23,0)
START(SDATE,EDATE,INST,NMS) ;
"RTN","MAGQE6",24,0)
 N AA,AI,COUNT,DIVISION,I,IMAGES,M0,OM,WHERE
"RTN","MAGQE6",25,0)
 ;
"RTN","MAGQE6",26,0)
 F AA=0,1 F I=1:1:6 S COUNT(AA,I)=0
"RTN","MAGQE6",27,0)
 S DIVISION=INST_$$GETAI^MAGQE5($$PLACE^MAGBAPI(INST),"^")
"RTN","MAGQE6",28,0)
 F I=1:1 S AI=$P(DIVISION,"^",I) Q:'AI  D:$D(^MAG(2006.5849,"E",AI))
"RTN","MAGQE6",29,0)
 . S AA=$O(^MAG(2006.5849,"E",AI,SDATE),-1)
"RTN","MAGQE6",30,0)
 . F  S AA=$O(^MAG(2006.5849,"E",AI,AA)) Q:'AA  Q:AA>EDATE  D
"RTN","MAGQE6",31,0)
 . . S OM="" F  S OM=$O(^MAG(2006.5849,"E",AI,AA,OM)) Q:'OM  D
"RTN","MAGQE6",32,0)
 . . . S M0=^MAG(2006.5849,OM,0) Q:$P(M0,"^",11)'="R"
"RTN","MAGQE6",33,0)
 . . . S WHERE=$P(M0,"^",16)=$P(M0,"^",2)
"RTN","MAGQE6",34,0)
 . . . S COUNT(WHERE,1)=COUNT(WHERE,1)+1
"RTN","MAGQE6",35,0)
 . . . S COUNT(WHERE,2)=COUNT(WHERE,2)+$P(M0,"^",10)
"RTN","MAGQE6",36,0)
 . . . I $P(M0,"^",18)>0,$P(M0,"^",17)>0 S COUNT(WHERE,3)=COUNT(WHERE,3)+$$FMDIFF^XLFDT($P(M0,"^",18),$P(M0,"^",17),2)
"RTN","MAGQE6",37,0)
 . . . I $P(M0,"^",18)>0,$P(M0,"^",17)>0 S COUNT(WHERE,4)=COUNT(WHERE,4)+1
"RTN","MAGQE6",38,0)
 . . . S:$P(M0,"^",17)="" COUNT(WHERE,6)=COUNT(WHERE,6)+1
"RTN","MAGQE6",39,0)
 . . . I $P(M0,"^",9)>0,$P(M0,"^",7)>0 S COUNT(WHERE,5)=COUNT(WHERE,5)+$$FMDIFF^XLFDT($P(M0,"^",9),$P(M0,"^",7),2)
"RTN","MAGQE6",40,0)
 . . . Q
"RTN","MAGQE6",41,0)
 . . Q
"RTN","MAGQE6",42,0)
 . Q
"RTN","MAGQE6",43,0)
 ;
"RTN","MAGQE6",44,0)
 ; Output collected data:
"RTN","MAGQE6",45,0)
 D:COUNT(1,1)+COUNT(0,1)
"RTN","MAGQE6",46,0)
 . I NMS'="",$E(NMS,$L(NMS))'=" " S NMS=NMS_" "
"RTN","MAGQE6",47,0)
 . D MSG^MAGQE2(NMS_"SPECIALITY: 57")
"RTN","MAGQE6",48,0)
 . D MSG^MAGQE2(NMS_"PROCEDURE: 88")
"RTN","MAGQE6",49,0)
 . D MSG^MAGQE2(NMS_"LOCAL STUDIES: "_COUNT(1,1))
"RTN","MAGQE6",50,0)
 . D MSG^MAGQE2(NMS_"REMOTE STUDIES: "_COUNT(0,1))
"RTN","MAGQE6",51,0)
 . D MSG^MAGQE2(NMS_"LOCAL IMAGES: "_COUNT(1,2))
"RTN","MAGQE6",52,0)
 . D MSG^MAGQE2(NMS_"REMOTE IMAGES: "_COUNT(0,2))
"RTN","MAGQE6",53,0)
 . D MSG^MAGQE2(NMS_"LOCAL READING TIME: "_COUNT(1,3))
"RTN","MAGQE6",54,0)
 . D MSG^MAGQE2(NMS_"REMOTE READING TIME: "_COUNT(0,3))
"RTN","MAGQE6",55,0)
 . D MSG^MAGQE2(NMS_"RESULTED LOCALLY BY TELEREADER: "_COUNT(1,4))
"RTN","MAGQE6",56,0)
 . D MSG^MAGQE2(NMS_"RESULTED LOCALLY BY CPRS: "_COUNT(1,6))
"RTN","MAGQE6",57,0)
 . D MSG^MAGQE2(NMS_"RESULTED REMOTELY BY TELEREADER: "_COUNT(0,4))
"RTN","MAGQE6",58,0)
 . D MSG^MAGQE2(NMS_"RESULTED REMOTELY BY CPRS: "_COUNT(0,6))
"RTN","MAGQE6",59,0)
 . D MSG^MAGQE2(NMS_"LOCAL ACQUISITION TIME:  "_COUNT(1,5))
"RTN","MAGQE6",60,0)
 . D MSG^MAGQE2(NMS_"REMOTE ACQUISITION TIME:  "_COUNT(0,5))
"RTN","MAGQE6",61,0)
 . Q
"RTN","MAGQE6",62,0)
 Q 
"RTN","MAGQE6",63,0)
 ;
"SEC","^DIC",2006.5841,2006.5841,0,"AUDIT")
@
"SEC","^DIC",2006.5841,2006.5841,0,"DD")
@
"SEC","^DIC",2006.5841,2006.5841,0,"DEL")
@
"SEC","^DIC",2006.5841,2006.5841,0,"LAYGO")
@
"SEC","^DIC",2006.5841,2006.5841,0,"RD")
@
"SEC","^DIC",2006.5841,2006.5841,0,"WR")
@
"SEC","^DIC",2006.5842,2006.5842,0,"AUDIT")
@
"SEC","^DIC",2006.5842,2006.5842,0,"DD")
@
"SEC","^DIC",2006.5842,2006.5842,0,"DEL")
@
"SEC","^DIC",2006.5842,2006.5842,0,"LAYGO")
@
"SEC","^DIC",2006.5842,2006.5842,0,"RD")
@
"SEC","^DIC",2006.5842,2006.5842,0,"WR")
@
"SEC","^DIC",2006.5843,2006.5843,0,"AUDIT")
@
"SEC","^DIC",2006.5843,2006.5843,0,"DD")
@
"SEC","^DIC",2006.5843,2006.5843,0,"DEL")
@
"SEC","^DIC",2006.5843,2006.5843,0,"LAYGO")
@
"SEC","^DIC",2006.5843,2006.5843,0,"RD")
@
"SEC","^DIC",2006.5843,2006.5843,0,"WR")
@
"SEC","^DIC",2006.5849,2006.5849,0,"AUDIT")
@
"SEC","^DIC",2006.5849,2006.5849,0,"DD")
@
"SEC","^DIC",2006.5849,2006.5849,0,"DEL")
@
"SEC","^DIC",2006.5849,2006.5849,0,"LAYGO")
@
"SEC","^DIC",2006.5849,2006.5849,0,"RD")
@
"SEC","^DIC",2006.5849,2006.5849,0,"WR")
@
"VER")
8.0^22.0
"^DD",2006.1,2006.1,131,0)
TELEREADER TIMEOUT (MINUTES)^NJ6,0^^KEYS;6^K:+X'=X!(X>999999)!(X<1)!(X?.E1"."1N.N) X
"^DD",2006.1,2006.1,131,3)
Type a Number between 1 and 999999, 0 Decimal Digits
"^DD",2006.1,2006.1,131,21,0)
^.001^2^2^3060509^^
"^DD",2006.1,2006.1,131,21,1,0)
The number of minutes that the TeleReader application will remain active 
"^DD",2006.1,2006.1,131,21,2,0)
before closing due to inactivity.
"^DD",2006.1,2006.1,131,"DT")
3060330
"^DD",2006.18,2006.18,200,0)
TELEREADER FORM STYLE^S^1:on;0:off;^TELEREADER_1;1^Q
"^DD",2006.18,2006.18,200,21,0)
^^2^2^3060509^
"^DD",2006.18,2006.18,200,21,1,0)
This is a set of codes to define the window style for TeleReader (this 
"^DD",2006.18,2006.18,200,21,2,0)
field is not currently being used).
"^DD",2006.18,2006.18,200,"DT")
3060509
"^DD",2006.18,2006.18,201,0)
TELEREADER LEFT^NJ4,0^^TELEREADER_1;2^K:+X'=X!(X>4000)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.18,2006.18,201,3)
Type a Number between 0 and 4000, 0 Decimal Digits
"^DD",2006.18,2006.18,201,21,0)
^^1^1^3060509^
"^DD",2006.18,2006.18,201,21,1,0)
This defines the left side of the TeleReader window settings.
"^DD",2006.18,2006.18,201,"DT")
3060509
"^DD",2006.18,2006.18,202,0)
TELEREADER TOP^NJ4,0^^TELEREADER_1;3^K:+X'=X!(X>4000)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.18,2006.18,202,3)
Type a Number between 0 and 4000, 0 Decimal Digits
"^DD",2006.18,2006.18,202,21,0)
^^1^1^3060509^
"^DD",2006.18,2006.18,202,21,1,0)
This defines the top side of the TeleReader window settings.
"^DD",2006.18,2006.18,202,"DT")
3060509
"^DD",2006.18,2006.18,203,0)
TELEREADER WIDTH^NJ4,0^^TELEREADER_1;4^K:+X'=X!(X>4000)!(X<10)!(X?.E1"."1N.N) X
"^DD",2006.18,2006.18,203,3)
Type a Number between 10 and 4000, 0 Decimal Digits
"^DD",2006.18,2006.18,203,21,0)
^^1^1^3060509^
"^DD",2006.18,2006.18,203,21,1,0)
This defines the TeleReader window width settings.
"^DD",2006.18,2006.18,203,"DT")
3060509
"^DD",2006.18,2006.18,204,0)
TELEREADER HEIGHT^NJ4,0^^TELEREADER_1;5^K:+X'=X!(X>4000)!(X<10)!(X?.E1"."1N.N) X
"^DD",2006.18,2006.18,204,3)
Type a Number between 10 and 4000, 0 Decimal Digits
"^DD",2006.18,2006.18,204,21,0)
^^1^1^3060509^
"^DD",2006.18,2006.18,204,21,1,0)
This defines the TeleReader window height settings.
"^DD",2006.18,2006.18,204,"DT")
3060509
"^DD",2006.18,2006.18,205,0)
TELEREADER SHOW OR NOT SHOW^S^1:SHOW;0:NOT SHOW;^TELEREADER_1;6^Q
"^DD",2006.18,2006.18,205,21,0)
^^2^2^3060509^
"^DD",2006.18,2006.18,205,21,1,0)
Determines if the user wants to have the TeleReader visible or not (this 
"^DD",2006.18,2006.18,205,21,2,0)
field is not currently being used).
"^DD",2006.18,2006.18,205,"DT")
3060509
"^DD",2006.18,2006.18,206,0)
TELEREADER UNREAD COL WIDTHS^F^^TELEREADER_1;7^K:$L(X)>60!($L(X)<3) X
"^DD",2006.18,2006.18,206,3)
Answer must be 3-60 characters in length.
"^DD",2006.18,2006.18,206,21,0)
^.001^1^1^3060503^^
"^DD",2006.18,2006.18,206,21,1,0)
This determines the width of the columns in the TeleReader Unread Window.
"^DD",2006.18,2006.18,206,"DT")
3060330
"^DD",2006.18,2006.18,207,0)
TELEREADER AUTO-LAUNCH^S^1:YES;0:NO;^TELEREADER_1;8^Q
"^DD",2006.18,2006.18,207,21,0)
^^2^2^3060127^
"^DD",2006.18,2006.18,207,21,1,0)
Determines if TeleReader should automatically launch CPRS and Display 
"^DD",2006.18,2006.18,207,21,2,0)
when the user selects a study (if they are not already launched).
"^DD",2006.18,2006.18,207,"DT")
3060127
"^DD",2006.18,2006.18,208,0)
TELEREADER VIEW ALL STUDIES^S^1:YES;0:NO;^TELEREADER_1;9^Q
"^DD",2006.18,2006.18,208,21,0)
^^2^2^3060127^
"^DD",2006.18,2006.18,208,21,1,0)
Determines if TeleReader should view all studies or only studies 
"^DD",2006.18,2006.18,208,21,2,0)
available to the user for resulting.
"^DD",2006.18,2006.18,208,"DT")
3060127
"^DD",2006.18,2006.18,209,0)
TELEREADER SHOW DIALOG^S^1:YES;0:NO;^TELEREADER_1;10^Q
"^DD",2006.18,2006.18,209,21,0)
^^1^1^3060127^
"^DD",2006.18,2006.18,209,21,1,0)
Determines if TeleReader should show the Specialties dialog at startup.
"^DD",2006.18,2006.18,209,"DT")
3060127
"^DD",2006.18,2006.18,210,0)
TELEREADER SAVE SETTINGS^S^1:YES;0:NO;^TELEREADER_1;11^Q
"^DD",2006.18,2006.18,210,21,0)
^^2^2^3060509^
"^DD",2006.18,2006.18,210,21,1,0)
Determines if the user wants to save their user preferences when the user 
"^DD",2006.18,2006.18,210,21,2,0)
logs off.
"^DD",2006.18,2006.18,210,"DT")
3060509
"^DD",2006.18,2006.18,211,0)
TELEREADER READ COL WIDTHS^F^^TELEREADER_1;12^K:$L(X)>60!($L(X)<3) X
"^DD",2006.18,2006.18,211,3)
Answer must be 3-60 characters in length.
"^DD",2006.18,2006.18,211,21,0)
^^1^1^3060503^
"^DD",2006.18,2006.18,211,21,1,0)
This determines the width of the columns in the TeleReader Read Window.
"^DD",2006.18,2006.18,211,"DT")
3060330
"^DD",2006.18,2006.18,300,0)
RIVER AUTO CONNECT ENABLED^S^1:ENABLED;0:DISABLED;^RIVER;1^Q
"^DD",2006.18,2006.18,300,21,0)
^^2^2^3060403^
"^DD",2006.18,2006.18,300,21,1,0)
Determines if the display client should automatically connect to remote 
"^DD",2006.18,2006.18,300,21,2,0)
sites for the selected patient.
"^DD",2006.18,2006.18,300,"DT")
3060403
"^DD",2006.18,2006.18,301,0)
RIVER CONNECT VISN ONLY^S^1:YES;0:NO;^RIVER;2^Q
"^DD",2006.18,2006.18,301,21,0)
^^2^2^3060403^
"^DD",2006.18,2006.18,301,21,1,0)
Determines if the display client should automatically connect to remote 
"^DD",2006.18,2006.18,301,21,2,0)
sites only in the users VISN.
"^DD",2006.18,2006.18,301,"DT")
3060403
"^DD",2006.18,2006.18,302,0)
RIVER HIDE EMPTY SITES^S^1:YES;0:NO;^RIVER;3^Q
"^DD",2006.18,2006.18,302,21,0)
^^2^2^3060509^
"^DD",2006.18,2006.18,302,21,1,0)
Determines if the display client should hide sites with 0 (zero) images on
"^DD",2006.18,2006.18,302,21,2,0)
the RIV (Remote Image View) toolbar.
"^DD",2006.18,2006.18,302,"DT")
3060509
"^DD",2006.18,2006.18,303,0)
RIVER HIDE DISCONNECTED SITES^S^1:YES;0:NO;^RIVER;4^Q
"^DD",2006.18,2006.18,303,3)

"^DD",2006.18,2006.18,303,21,0)
^^2^2^3060509^
"^DD",2006.18,2006.18,303,21,1,0)
Determines if the display client should hide disconnected sites on the 
"^DD",2006.18,2006.18,303,21,2,0)
RIV (Remote Image View) toolbar.
"^DD",2006.18,2006.18,303,"DT")
3060509
"^DD",2006.5841,2006.5841,0)
FIELD^^6^7
"^DD",2006.5841,2006.5841,0,"DDA")
N
"^DD",2006.5841,2006.5841,0,"DT")
3060202
"^DD",2006.5841,2006.5841,0,"ID",1)
S %I=Y,Y=$S('$D(^(0)):"",$D(^GMR(123.3,+$P(^(0),U,2),0))#2:$P(^(0),U,1),1:""),C=$P(^DD(123.3,.01,0),U,2) D Y^DIQ:Y]"" W "   ",Y,@("$E("_DIC_"%I,0),0)") S Y=%I K %I
"^DD",2006.5841,2006.5841,0,"IX","B",2006.5841,.01)

"^DD",2006.5841,2006.5841,0,"NM","TELEREADER ACQUISITION SERVICE")

"^DD",2006.5841,2006.5841,.01,0)
NAME^RP123.5'^GMR(123.5,^0;1^Q
"^DD",2006.5841,2006.5841,.01,1,0)
^.1
"^DD",2006.5841,2006.5841,.01,1,1,0)
2006.5841^B
"^DD",2006.5841,2006.5841,.01,1,1,1)
S ^MAG(2006.5841,"B",$E(X,1,30),DA)=""
"^DD",2006.5841,2006.5841,.01,1,1,2)
K ^MAG(2006.5841,"B",$E(X,1,30),DA)
"^DD",2006.5841,2006.5841,.01,3)

"^DD",2006.5841,2006.5841,.01,21,0)
^^1^1^3060509^
"^DD",2006.5841,2006.5841,.01,21,1,0)
The Consult Request Tracking "To Service" at the Acquisition Site.
"^DD",2006.5841,2006.5841,.01,"DT")
3060509
"^DD",2006.5841,2006.5841,1,0)
PROCEDURE^P123.3'^GMR(123.3,^0;2^Q
"^DD",2006.5841,2006.5841,1,21,0)
^^1^1^3060509^
"^DD",2006.5841,2006.5841,1,21,1,0)
The Consult Request Tracking "Procedure" that is to be performed.
"^DD",2006.5841,2006.5841,1,"DT")
3060509
"^DD",2006.5841,2006.5841,2,0)
SPECIALTY INDEX^RP2005.84'^MAG(2005.84,^0;3^Q
"^DD",2006.5841,2006.5841,2,21,0)
^^1^1^3060509^
"^DD",2006.5841,2006.5841,2,21,1,0)
The Specialty/Subspecialty for the Unread List.
"^DD",2006.5841,2006.5841,2,"DT")
3060509
"^DD",2006.5841,2006.5841,3,0)
PROCEDURE INDEX^RP2005.85'^MAG(2005.85,^0;4^Q
"^DD",2006.5841,2006.5841,3,21,0)
^^1^1^3060509^
"^DD",2006.5841,2006.5841,3,21,1,0)
The Procedure/Event for the Unread List.
"^DD",2006.5841,2006.5841,3,"DT")
3060509
"^DD",2006.5841,2006.5841,4,0)
ACQUISITION SITE^RP4'^DIC(4,^0;5^Q
"^DD",2006.5841,2006.5841,4,21,0)
^^1^1^3060509^
"^DD",2006.5841,2006.5841,4,21,1,0)
The Acquisition Site where the images will be captured.
"^DD",2006.5841,2006.5841,4,"DT")
3060509
"^DD",2006.5841,2006.5841,5,0)
UNREAD LIST CREATION TRIGGER^RS^I:CREATE/UPDATE WITH EVERY ACQUIRED IMAGE;O:CREATE WHEN REQUEST IS ORDERED;F:CREATE WHEN CONSULT IS FORWARDED TO IFC;^0;6^Q
"^DD",2006.5841,2006.5841,5,3)

"^DD",2006.5841,2006.5841,5,21,0)
^^1^1^3060509^
"^DD",2006.5841,2006.5841,5,21,1,0)
The trigger event which will put the study on the Unread List.
"^DD",2006.5841,2006.5841,5,"DT")
3060509
"^DD",2006.5841,2006.5841,6,0)
TIU NOTE FILE^RP8925.1'^TIU(8925.1,^0;7^Q
"^DD",2006.5841,2006.5841,6,3)

"^DD",2006.5841,2006.5841,6,21,0)
^^1^1^3060509^
"^DD",2006.5841,2006.5841,6,21,1,0)
The TIU Note Title to be used when the IFC has been completed.
"^DD",2006.5841,2006.5841,6,"DT")
3060509
"^DD",2006.5842,2006.5842,0)
FIELD^^3^4
"^DD",2006.5842,2006.5842,0,"DDA")
N
"^DD",2006.5842,2006.5842,0,"DT")
3060207
"^DD",2006.5842,2006.5842,0,"IX","B",2006.5842,.01)

"^DD",2006.5842,2006.5842,0,"NM","TELEREADER ACQUISITION SITE")

"^DD",2006.5842,2006.5842,0,"PT",2006.58431,.01)

"^DD",2006.5842,2006.5842,.01,0)
NAME^RP4'X^DIC(4,^0;1^S DINUM=X Q
"^DD",2006.5842,2006.5842,.01,1,0)
^.1
"^DD",2006.5842,2006.5842,.01,1,1,0)
2006.5842^B
"^DD",2006.5842,2006.5842,.01,1,1,1)
S ^MAG(2006.5842,"B",$E(X,1,30),DA)=""
"^DD",2006.5842,2006.5842,.01,1,1,2)
K ^MAG(2006.5842,"B",$E(X,1,30),DA)
"^DD",2006.5842,2006.5842,.01,3)

"^DD",2006.5842,2006.5842,.01,21,0)
^^1^1^3060509^
"^DD",2006.5842,2006.5842,.01,21,1,0)
The Site (Institution) where the images will be acquired.
"^DD",2006.5842,2006.5842,.01,"DT")
3060509
"^DD",2006.5842,2006.5842,1,0)
PRIMARY SITE^P4'^DIC(4,^0;2^Q
"^DD",2006.5842,2006.5842,1,3)

"^DD",2006.5842,2006.5842,1,21,0)
^^1^1^3060509^
"^DD",2006.5842,2006.5842,1,21,1,0)
The Site where the VistA HIS for the Acquisition Site is located.
"^DD",2006.5842,2006.5842,1,"DT")
3060509
"^DD",2006.5842,2006.5842,2,0)
STATUS^S^1:ACTIVE;0:INACTIVE;^0;3^Q
"^DD",2006.5842,2006.5842,2,3)

"^DD",2006.5842,2006.5842,2,21,0)
^^2^2^3060509^
"^DD",2006.5842,2006.5842,2,21,1,0)
Determines if the acquisition site is active or inactive.  (To determine 
"^DD",2006.5842,2006.5842,2,21,2,0)
if this site should be read from).
"^DD",2006.5842,2006.5842,2,"DT")
3060509
"^DD",2006.5842,2006.5842,3,0)
LOCK TIMEOUT IN MINUTES^NJ5,0^^0;4^K:+X'=X!(X>99999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.5842,2006.5842,3,3)
Type a Number between 0 and 99999, 0 Decimal Digits
"^DD",2006.5842,2006.5842,3,21,0)
^^3^3^3060330^
"^DD",2006.5842,2006.5842,3,21,1,0)
The number of minutes a study can be locked by a user.  After this period
"^DD",2006.5842,2006.5842,3,21,2,0)
of time, a study that is still locked is automatically unlocked.  The
"^DD",2006.5842,2006.5842,3,21,3,0)
default time is 180 minutes.
"^DD",2006.5842,2006.5842,3,"DT")
3060228
"^DD",2006.5843,2006.5843,0)
FIELD^^1^2
"^DD",2006.5843,2006.5843,0,"DDA")
N
"^DD",2006.5843,2006.5843,0,"DT")
3060228
"^DD",2006.5843,2006.5843,0,"IX","B",2006.5843,.01)

"^DD",2006.5843,2006.5843,0,"NM","TELEREADER READER")

"^DD",2006.5843,2006.5843,.01,0)
READER^RP200'^VA(200,^0;1^Q
"^DD",2006.5843,2006.5843,.01,1,0)
^.1
"^DD",2006.5843,2006.5843,.01,1,1,0)
2006.5843^B
"^DD",2006.5843,2006.5843,.01,1,1,1)
S ^MAG(2006.5843,"B",$E(X,1,30),DA)=""
"^DD",2006.5843,2006.5843,.01,1,1,2)
K ^MAG(2006.5843,"B",$E(X,1,30),DA)
"^DD",2006.5843,2006.5843,.01,3)

"^DD",2006.5843,2006.5843,.01,21,0)
^^1^1^3060509^
"^DD",2006.5843,2006.5843,.01,21,1,0)
The name of the person that will be reading the exam.
"^DD",2006.5843,2006.5843,.01,"DT")
3060509
"^DD",2006.5843,2006.5843,1,0)
ACQUISITION SITE^2006.58431PA^^1;0
"^DD",2006.5843,2006.5843,1,21,0)
^^1^1^3060509^
"^DD",2006.5843,2006.5843,1,21,1,0)
The Site (Institution) where the images are acquired.
"^DD",2006.5843,2006.58431,0)
ACQUISITION SITE SUB-FIELD^^1^3
"^DD",2006.5843,2006.58431,0,"DT")
3060228
"^DD",2006.5843,2006.58431,0,"IX","B",2006.58431,.01)

"^DD",2006.5843,2006.58431,0,"NM","ACQUISITION SITE")

"^DD",2006.5843,2006.58431,0,"UP")
2006.5843
"^DD",2006.5843,2006.58431,.01,0)
ACQUISITION SITE^MP2006.5842'^MAG(2006.5842,^0;1^Q
"^DD",2006.5843,2006.58431,.01,1,0)
^.1
"^DD",2006.5843,2006.58431,.01,1,1,0)
2006.58431^B
"^DD",2006.5843,2006.58431,.01,1,1,1)
S ^MAG(2006.5843,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",2006.5843,2006.58431,.01,1,1,2)
K ^MAG(2006.5843,DA(1),1,"B",$E(X,1,30),DA)
"^DD",2006.5843,2006.58431,.01,21,0)
^^1^1^3060509^
"^DD",2006.5843,2006.58431,.01,21,1,0)
The Site (Institution) where the images are acquired.
"^DD",2006.5843,2006.58431,.01,"DT")
3060509
"^DD",2006.5843,2006.58431,.5,0)
STATUS^S^1:ACTIVE;0:INACTIVE;^0;2^Q
"^DD",2006.5843,2006.58431,.5,21,0)
^.001^2^2^3060330^^
"^DD",2006.5843,2006.58431,.5,21,1,0)
The Status indicates whether or not the Reader Signed on to the 
"^DD",2006.5843,2006.58431,.5,21,2,0)
TeleReader application can read a study from the Acquisition Site.
"^DD",2006.5843,2006.58431,.5,"DT")
3060228
"^DD",2006.5843,2006.58431,1,0)
SPECIALTY INDEX^2006.584311PA^^1;0
"^DD",2006.5843,2006.58431,1,21,0)
^^1^1^3060503^
"^DD",2006.5843,2006.58431,1,21,1,0)
The SPECIALTY/SUBSPECIALTY of the image.
"^DD",2006.5843,2006.584311,0)
SPECIALTY INDEX SUB-FIELD^^1^3
"^DD",2006.5843,2006.584311,0,"DT")
3060228
"^DD",2006.5843,2006.584311,0,"IX","B",2006.584311,.01)

"^DD",2006.5843,2006.584311,0,"NM","SPECIALTY INDEX")

"^DD",2006.5843,2006.584311,0,"UP")
2006.58431
"^DD",2006.5843,2006.584311,.01,0)
SPECIALTY INDEX^MP2005.84'^MAG(2005.84,^0;1^Q
"^DD",2006.5843,2006.584311,.01,1,0)
^.1
"^DD",2006.5843,2006.584311,.01,1,1,0)
2006.584311^B
"^DD",2006.5843,2006.584311,.01,1,1,1)
S ^MAG(2006.5843,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",2006.5843,2006.584311,.01,1,1,2)
K ^MAG(2006.5843,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)
"^DD",2006.5843,2006.584311,.01,21,0)
^^1^1^3060503^
"^DD",2006.5843,2006.584311,.01,21,1,0)
The SPECIALTY/SUBSPECIALTY of the image.
"^DD",2006.5843,2006.584311,.01,"DT")
3051209
"^DD",2006.5843,2006.584311,.5,0)
STATUS^S^1:ACTIVE;0:INACTIVE;^0;2^Q
"^DD",2006.5843,2006.584311,.5,21,0)
^^3^3^3060228^
"^DD",2006.5843,2006.584311,.5,21,1,0)
The Status indicates whether or not the Reader Signed on to the
"^DD",2006.5843,2006.584311,.5,21,2,0)
TeleReader application can read a study from the Acquisition Site for 
"^DD",2006.5843,2006.584311,.5,21,3,0)
this specific Specialty.
"^DD",2006.5843,2006.584311,.5,"DT")
3060228
"^DD",2006.5843,2006.584311,1,0)
PROCEDURE INDEX^2006.5843111PA^^1;0
"^DD",2006.5843,2006.584311,1,21,0)
^^1^1^3060503^
"^DD",2006.5843,2006.584311,1,21,1,0)
The PROCEDURE/EVENT of the image.
"^DD",2006.5843,2006.5843111,0)
PROCEDURE INDEX SUB-FIELD^^1^3
"^DD",2006.5843,2006.5843111,0,"DT")
3060228
"^DD",2006.5843,2006.5843111,0,"IX","B",2006.5843111,.01)

"^DD",2006.5843,2006.5843111,0,"NM","PROCEDURE INDEX")

"^DD",2006.5843,2006.5843111,0,"UP")
2006.584311
"^DD",2006.5843,2006.5843111,.01,0)
PROCEDURE INDEX^MP2005.85'^MAG(2005.85,^0;1^Q
"^DD",2006.5843,2006.5843111,.01,1,0)
^.1
"^DD",2006.5843,2006.5843111,.01,1,1,0)
2006.5843111^B
"^DD",2006.5843,2006.5843111,.01,1,1,1)
S ^MAG(2006.5843,DA(3),1,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",2006.5843,2006.5843111,.01,1,1,2)
K ^MAG(2006.5843,DA(3),1,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)
"^DD",2006.5843,2006.5843111,.01,21,0)
^^1^1^3060503^
"^DD",2006.5843,2006.5843111,.01,21,1,0)
The PROCEDURE/EVENT of the image.
"^DD",2006.5843,2006.5843111,.01,"DT")
3051209
"^DD",2006.5843,2006.5843111,.5,0)
STATUS^S^1:ACTIVE;0:INACTIVE;^0;2^Q
"^DD",2006.5843,2006.5843111,.5,21,0)
^^3^3^3060228^
"^DD",2006.5843,2006.5843111,.5,21,1,0)
The Status indicates whether or not the Reader Signed on to the
"^DD",2006.5843,2006.5843111,.5,21,2,0)
TeleReader application and read a study from the Acquisition Site, for the
"^DD",2006.5843,2006.5843111,.5,21,3,0)
Specialty, for this specific Procedure.
"^DD",2006.5843,2006.5843111,.5,"DT")
3060228
"^DD",2006.5843,2006.5843111,1,0)
USER PREFERENCE^S^1:ACTIVE;0:INACTIVE;^0;3^Q
"^DD",2006.5843,2006.5843111,1,3)

"^DD",2006.5843,2006.5843111,1,21,0)
^^2^2^3060509^
"^DD",2006.5843,2006.5843111,1,21,1,0)
Determines whether or not the User will be able to read an image with this
"^DD",2006.5843,2006.5843111,1,21,2,0)
Procedure for the Specialty for the Acquisitions site.
"^DD",2006.5843,2006.5843111,1,"DT")
3060509
"^DD",2006.5849,2006.5849,0)
FIELD^^18^19
"^DD",2006.5849,2006.5849,0,"DDA")
N
"^DD",2006.5849,2006.5849,0,"DT")
3060921
"^DD",2006.5849,2006.5849,0,"IX","B",2006.5849,.01)

"^DD",2006.5849,2006.5849,0,"IX","C",2006.5849,1)

"^DD",2006.5849,2006.5849,0,"NM","TELEREADER READ/UNREAD LIST")

"^DD",2006.5849,2006.5849,.01,0)
CONSULT REQUEST^RP123'^GMR(123,^0;1^Q
"^DD",2006.5849,2006.5849,.01,1,0)
^.1
"^DD",2006.5849,2006.5849,.01,1,1,0)
2006.5849^B
"^DD",2006.5849,2006.5849,.01,1,1,1)
S ^MAG(2006.5849,"B",$E(X,1,30),DA)=""
"^DD",2006.5849,2006.5849,.01,1,1,2)
K ^MAG(2006.5849,"B",$E(X,1,30),DA)
"^DD",2006.5849,2006.5849,.01,3)

"^DD",2006.5849,2006.5849,.01,21,0)
^^1^1^3060509^
"^DD",2006.5849,2006.5849,.01,21,1,0)
The date and time the consult was requested.
"^DD",2006.5849,2006.5849,.01,"DT")
3060509
"^DD",2006.5849,2006.5849,1,0)
ACQUISITION DIVISION NUMBER^P4'^DIC(4,^0;2^Q
"^DD",2006.5849,2006.5849,1,1,0)
^.1
"^DD",2006.5849,2006.5849,1,1,1,0)
2006.5849^C
"^DD",2006.5849,2006.5849,1,1,1,1)
S ^MAG(2006.5849,"C",$E(X,1,30),DA)=""
"^DD",2006.5849,2006.5849,1,1,1,2)
K ^MAG(2006.5849,"C",$E(X,1,30),DA)
"^DD",2006.5849,2006.5849,1,1,1,"DT")
3060421
"^DD",2006.5849,2006.5849,1,21,0)
^^1^1^3060509^
"^DD",2006.5849,2006.5849,1,21,1,0)
The site where the images are acquired.
"^DD",2006.5849,2006.5849,1,"DT")
3060509
"^DD",2006.5849,2006.5849,2,0)
IMAGE INDEX FOR SPECIALTY^P2005.84'^MAG(2005.84,^0;3^Q
"^DD",2006.5849,2006.5849,2,21,0)
^^1^1^3060509^
"^DD",2006.5849,2006.5849,2,21,1,0)
The specific specialty as requested by the acquisition site.
"^DD",2006.5849,2006.5849,2,"DT")
3060509
"^DD",2006.5849,2006.5849,3,0)
IMAGE INDEX FOR PROCEDURE^P2005.85'^MAG(2005.85,^0;4^Q
"^DD",2006.5849,2006.5849,3,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,3,21,1,0)
The procedure performed by the acquisition site.
"^DD",2006.5849,2006.5849,3,"DT")
3060117
"^DD",2006.5849,2006.5849,4,0)
CONSULT ORDERED/FORWARDED^D^^0;5^S %DT="EST" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5849,2006.5849,4,21,0)
^^2^2^3060503^
"^DD",2006.5849,2006.5849,4,21,1,0)
The Date/Time that the consult was ordered or forwarded to the remote
"^DD",2006.5849,2006.5849,4,21,2,0)
site.
"^DD",2006.5849,2006.5849,4,"DT")
3051212
"^DD",2006.5849,2006.5849,5,0)
REMOTE SITE RESPONSE^D^^0;6^S %DT="EST" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5849,2006.5849,5,3)

"^DD",2006.5849,2006.5849,5,21,0)
^^2^2^3060503^
"^DD",2006.5849,2006.5849,5,21,1,0)
The Date/Time that the remote site responds to the IFC request by creating
"^DD",2006.5849,2006.5849,5,21,2,0)
a remote consult.
"^DD",2006.5849,2006.5849,5,"DT")
3051212
"^DD",2006.5849,2006.5849,6,0)
ACQUISITION START^D^^0;7^S %DT="EST" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5849,2006.5849,6,3)

"^DD",2006.5849,2006.5849,6,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,6,21,1,0)
The start date and time of the acquisition of images.
"^DD",2006.5849,2006.5849,6,"DT")
3051212
"^DD",2006.5849,2006.5849,7,0)
NEXT ACQUISITION^D^^0;8^S %DT="EST" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5849,2006.5849,7,3)

"^DD",2006.5849,2006.5849,7,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,7,21,1,0)
The date and time of the acquisition of additional images.
"^DD",2006.5849,2006.5849,7,"DT")
3051212
"^DD",2006.5849,2006.5849,8,0)
LAST ACTIVITY^D^^0;9^S %DT="EST" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5849,2006.5849,8,3)

"^DD",2006.5849,2006.5849,8,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,8,21,1,0)
The date and time of the last activity.
"^DD",2006.5849,2006.5849,8,"DT")
3051212
"^DD",2006.5849,2006.5849,9,0)
NUMBER OF IMAGES^NJ5,0^^0;10^K:+X'=X!(X>99999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.5849,2006.5849,9,3)
Type a Number between 0 and 99999, 0 Decimal Digits
"^DD",2006.5849,2006.5849,9,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,9,21,1,0)
The number of images acquired.
"^DD",2006.5849,2006.5849,9,"DT")
3051212
"^DD",2006.5849,2006.5849,10,0)
STATUS^S^C:Cancelled;W:Waiting;R:Read;L:Locked;U:Unread;D:Deleted;^0;11^Q
"^DD",2006.5849,2006.5849,10,1,0)
^.1^^0
"^DD",2006.5849,2006.5849,10,21,0)
^^1^1^3060509^
"^DD",2006.5849,2006.5849,10,21,1,0)
The status of the exam; read, unread, etc., in the TeleReader program.
"^DD",2006.5849,2006.5849,10,"DT")
3060509
"^DD",2006.5849,2006.5849,11,0)
FULL NAME OF READER^F^^0;12^K:$L(X)>35!($L(X)<1) X
"^DD",2006.5849,2006.5849,11,3)
Answer must be 1-35 characters in length.
"^DD",2006.5849,2006.5849,11,21,0)
^^1^1^3060509^
"^DD",2006.5849,2006.5849,11,21,1,0)
The name of the person who will be reading the exam.
"^DD",2006.5849,2006.5849,11,"DT")
3060509
"^DD",2006.5849,2006.5849,12,0)
READER'S INITIALS^F^^0;13^K:$L(X)>5!($L(X)<1) X
"^DD",2006.5849,2006.5849,12,3)
Answer must be 1-5 characters in length.
"^DD",2006.5849,2006.5849,12,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,12,21,1,0)
The initials of the person responsible for reading the exam.
"^DD",2006.5849,2006.5849,12,"DT")
3051212
"^DD",2006.5849,2006.5849,13,0)
READER DUZ AT ACQUISITION SITE^P200'^VA(200,^0;14^Q
"^DD",2006.5849,2006.5849,13,3)

"^DD",2006.5849,2006.5849,13,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,13,21,1,0)
The Reader's DUZ at the Acquisition Site.
"^DD",2006.5849,2006.5849,13,"DT")
3060203
"^DD",2006.5849,2006.5849,14,0)
READER DUZ AT READING SITE^NJ10,0^^0;15^K:+X'=X!(X>9999999999)!(X<1)!(X?.E1"."1N.N) X
"^DD",2006.5849,2006.5849,14,3)
Type a Number between 1 and 9999999999, 0 Decimal Digits
"^DD",2006.5849,2006.5849,14,21,0)
^^1^1^3060509^
"^DD",2006.5849,2006.5849,14,21,1,0)
The DUZ of the person reading the exam at the Reader's Site.
"^DD",2006.5849,2006.5849,14,"DT")
3060509
"^DD",2006.5849,2006.5849,15,0)
READER SITE^P4'^DIC(4,^0;16^Q
"^DD",2006.5849,2006.5849,15,3)

"^DD",2006.5849,2006.5849,15,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,15,21,1,0)
The division where the reader is located.
"^DD",2006.5849,2006.5849,15,"DT")
3060203
"^DD",2006.5849,2006.5849,16,0)
READING START^D^^0;17^S %DT="EST" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5849,2006.5849,16,3)

"^DD",2006.5849,2006.5849,16,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,16,21,1,0)
The date and time when the exam is selected to be read.
"^DD",2006.5849,2006.5849,16,"DT")
3060203
"^DD",2006.5849,2006.5849,17,0)
READING STOP^D^^0;18^S %DT="EST" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5849,2006.5849,17,1,0)
^.1^^0
"^DD",2006.5849,2006.5849,17,21,0)
^^1^1^3060503^
"^DD",2006.5849,2006.5849,17,21,1,0)
The date and time when the reader completes the reading of the exam.
"^DD",2006.5849,2006.5849,17,"DT")
3060421
"^DD",2006.5849,2006.5849,18,0)
REPAIR DATE/TIME^D^^0;19^S %DT="ET" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5849,2006.5849,18,3)
DATE AND TIME OF REPAIRING ENTRY
"^DD",2006.5849,2006.5849,18,"DT")
3060921
"^DIC",2006.5841,2006.5841,0)
TELEREADER ACQUISITION SERVICE^2006.5841
"^DIC",2006.5841,2006.5841,0,"GL")
^MAG(2006.5841,
"^DIC",2006.5841,2006.5841,"%",0)
^1.005^^0
"^DIC",2006.5841,2006.5841,"%D",0)
^1.001^2^2^3060710^^^^
"^DIC",2006.5841,2006.5841,"%D",1,0)
This dictionary contains the information that defines the TeleReader worklist.  This
"^DIC",2006.5841,2006.5841,"%D",2,0)
dictionary is located at the Acquisition Site.
"^DIC",2006.5841,"B","TELEREADER ACQUISITION SERVICE",2006.5841)

"^DIC",2006.5842,2006.5842,0)
TELEREADER ACQUISITION SITE^2006.5842
"^DIC",2006.5842,2006.5842,0,"GL")
^MAG(2006.5842,
"^DIC",2006.5842,2006.5842,"%",0)
^1.005^^0
"^DIC",2006.5842,2006.5842,"%D",0)
^^4^4^3051129^
"^DIC",2006.5842,2006.5842,"%D",1,0)
This dictionary indicates the status of the Acquisition Site from the
"^DIC",2006.5842,2006.5842,"%D",2,0)
perspective of the reading site.  It is used to indicate service
"^DIC",2006.5842,2006.5842,"%D",3,0)
outages.  For example,  if the network is down between the two sites, 
"^DIC",2006.5842,2006.5842,"%D",4,0)
the status would be set to 'Inactive'.
"^DIC",2006.5842,"B","TELEREADER ACQUISITION SITE",2006.5842)

"^DIC",2006.5843,2006.5843,0)
TELEREADER READER^2006.5843
"^DIC",2006.5843,2006.5843,0,"GL")
^MAG(2006.5843,
"^DIC",2006.5843,2006.5843,"%",0)
^1.005^^0
"^DIC",2006.5843,2006.5843,"%D",0)
^^2^2^3051212^
"^DIC",2006.5843,2006.5843,"%D",1,0)
This dictionary maintains the Specialty and Acquisition Site
"^DIC",2006.5843,2006.5843,"%D",2,0)
for each reader.  It is maintained at the reading site.
"^DIC",2006.5843,"B","TELEREADER READER",2006.5843)

"^DIC",2006.5849,2006.5849,0)
TELEREADER READ/UNREAD LIST^2006.5849
"^DIC",2006.5849,2006.5849,0,"GL")
^MAG(2006.5849,
"^DIC",2006.5849,2006.5849,"%",0)
^1.005^^0
"^DIC",2006.5849,2006.5849,"%D",0)
^^3^3^3051212^
"^DIC",2006.5849,2006.5849,"%D",1,0)
This is the Unread/Read list and is stored on the Acquisition Site's Vista system.  
"^DIC",2006.5849,2006.5849,"%D",2,0)
The file is indexed by pointers to file IMAGE INDEX FOR SPECIALTY/SUBSPECIALTY file (#2005.84)
"^DIC",2006.5849,2006.5849,"%D",3,0)
 and IMAGE INDEX FOR PROCEDURE/EVENT file (#2005.85).
"^DIC",2006.5849,"B","TELEREADER READ/UNREAD LIST",2006.5849)

**END**
**END**


****
****

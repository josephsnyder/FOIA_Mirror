KIDS Distribution saved on Aug 26, 2005@09:50:41
VistA Imaging V3.0 - Patch 51 - 08/26/2005 09:50AM
**KIDS**:MAG*3.0*51^

**INSTALL NAME**
MAG*3.0*51
"BLD",3463,0)
MAG*3.0*51^IMAGING^0^3050826^y
"BLD",3463,1,0)
^^158^158^3050826^
"BLD",3463,1,1,0)
Version 3.0 Patch 51 - DICOM Maintenance III
"BLD",3463,1,2,0)
 
"BLD",3463,1,3,0)
 
"BLD",3463,1,4,0)
This package contains one new menu option
"BLD",3463,1,5,0)
(MAG DICOM CORRECT VALIDATE),
"BLD",3463,1,6,0)
which is called from MAGD DICOM MENU.
"BLD",3463,1,7,0)
 
"BLD",3463,1,8,0)
Definition for Option "MAG DICOM QUERY RETRIEVE".
"BLD",3463,1,9,0)
 
"BLD",3463,1,10,0)
This KIDS file is to remove the menu option MAGD DICOM ROUTINE UPLOAD
"BLD",3463,1,11,0)
from the menu.
"BLD",3463,1,12,0)
 
"BLD",3463,1,13,0)
RPC definition for "MAG CFIND QUERY".
"BLD",3463,1,14,0)
 
"BLD",3463,1,15,0)
RPC definition for "MAG DICOM CHECK MACHINE ID".
"BLD",3463,1,16,0)
 
"BLD",3463,1,17,0)
This package contains a KIDS component
"BLD",3463,1,18,0)
for patch 51.
"BLD",3463,1,19,0)
 
"BLD",3463,1,20,0)
This package transports the remote procedure call named MAG DICOM CORRECT 
"BLD",3463,1,21,0)
VALIDATE.
"BLD",3463,1,22,0)
 
"BLD",3463,1,23,0)
RPC definition for "MAG DICOM UPDATE MACHINE ID".
"BLD",3463,1,24,0)
 
"BLD",3463,1,25,0)
RPC definition for "MAG STUDY UID QUERY".
"BLD",3463,1,26,0)
 
"BLD",3463,1,27,0)
This package contains the RPC: MAG VISTA CHECKSUMS.
"BLD",3463,1,28,0)
 
"BLD",3463,1,29,0)
This RPC will queue up a TaskMan task that calculates the current
"BLD",3463,1,30,0)
checksums of all imaging routines, and that e-mails the result to
"BLD",3463,1,31,0)
Silver Spring.
"BLD",3463,1,32,0)
 
"BLD",3463,1,33,0)
This package is to add 1 field to file # 2005.1 (field 251: DICOM SOP 
"BLD",3463,1,34,0)
CLASS).
"BLD",3463,1,35,0)
This field is exactly the same as the corresponding field in file #2005.
"BLD",3463,1,36,0)
 
"BLD",3463,1,37,0)
This package changes the name of field #26 in file 2005.2.
"BLD",3463,1,38,0)
The name of this field still contains [FUTURE USE],
"BLD",3463,1,39,0)
which should have been removed in an earlier patch.
"BLD",3463,1,40,0)
 
"BLD",3463,1,41,0)
 
"BLD",3463,1,42,0)
 
"BLD",3463,1,43,0)
This KIDS file packages a new field that is added to the Image File.
"BLD",3463,1,44,0)
 
"BLD",3463,1,45,0)
This new field identifies the DICOM SOP Class that was used to
"BLD",3463,1,46,0)
acquire the image.
"BLD",3463,1,47,0)
 
"BLD",3463,1,48,0)
This file contains one field of one file:
"BLD",3463,1,49,0)
  file# 2006.035: Routing Queue
"BLD",3463,1,50,0)
  field#:      1: Destination
"BLD",3463,1,51,0)
 
"BLD",3463,1,52,0)
The purpose of this KIDS is to add one more possibility to the
"BLD",3463,1,53,0)
list of files that this variable pointer may point to.
"BLD",3463,1,54,0)
The new file is 2006.587: DICOM Transmit Destination.
"BLD",3463,1,55,0)
 
"BLD",3463,1,56,0)
KIDS file for file 2006.51
"BLD",3463,1,57,0)
 
"BLD",3463,1,58,0)
This package contains a distribution of the DICOM SOP CLASS table.
"BLD",3463,1,59,0)
A distribution of this table consists of a data dictionary,
"BLD",3463,1,60,0)
and a populated table.
"BLD",3463,1,61,0)
 
"BLD",3463,1,62,0)
The DICOM SOP CLASS table is not supposed to be modified at the site.
"BLD",3463,1,63,0)
When changes are to be made, new content for the table will be
"BLD",3463,1,64,0)
distributed.
"BLD",3463,1,65,0)
 
"BLD",3463,1,66,0)
This package contains two new fields for the DICOM Gateway parameters:
"BLD",3463,1,67,0)
  ET ADDRESS: the e-mail address of the mailgroup
"BLD",3463,1,68,0)
  MAG VISTA CHECKSUMS: a flag that indicates whether checksum reports are 
"BLD",3463,1,69,0)
to be sent.
"BLD",3463,1,70,0)
 
"BLD",3463,1,71,0)
KIDS file for file 2006.5641
"BLD",3463,1,72,0)
 
"BLD",3463,1,73,0)
This package contains one Data Dictionary: file # 2006.57.
"BLD",3463,1,74,0)
This distribution corrects the specification of the file-root.
"BLD",3463,1,75,0)
Earlier versions had the root in ^MAGDICOM("HL7", this version
"BLD",3463,1,76,0)
corrects the root to be ^MAGDICOM(2006.57, .
"BLD",3463,1,77,0)
 
"BLD",3463,1,78,0)
This package contains file # 2006.5715, the table that contains
"BLD",3463,1,79,0)
the UIDs of the images currently being processed by the various
"BLD",3463,1,80,0)
DICOM Image Gateways.
"BLD",3463,1,81,0)
 
"BLD",3463,1,82,0)
KIDS file for file 2006.5732
"BLD",3463,1,83,0)
 
"BLD",3463,1,84,0)
This KIDS distributes the updated version of the data dictonary
"BLD",3463,1,85,0)
for file 2006.574 (DICOM IMAGE OUTPUT).
"BLD",3463,1,86,0)
In patch 51, the definition is updated to reflect the removal
"BLD",3463,1,87,0)
of 6 fields and the addition of 2 new fields.
"BLD",3463,1,88,0)
 
"BLD",3463,1,89,0)
KIDS file for file 2006.575
"BLD",3463,1,90,0)
 
"BLD",3463,1,91,0)
KIDS file for file 2006.5762
"BLD",3463,1,92,0)
 
"BLD",3463,1,93,0)
This KIDS file contains one field from one file:
"BLD",3463,1,94,0)
   file#:  2006.582: Modality Dictionary
"BLD",3463,1,95,0)
   field#         9: Active
"BLD",3463,1,96,0)
 
"BLD",3463,1,97,0)
The purpose of this modification is to add one new field.
"BLD",3463,1,98,0)
This new field is a code that indicates whether or not
"BLD",3463,1,99,0)
an entry in the modality dictionary is considered to be
"BLD",3463,1,100,0)
currently "active".
"BLD",3463,1,101,0)
 
"BLD",3463,1,102,0)
This package contains a KIDS component
"BLD",3463,1,103,0)
for patch 51.
"BLD",3463,1,104,0)
 
"BLD",3463,1,105,0)
This package transports the FileMan data dictionary named 2006.587.
"BLD",3463,1,106,0)
 
"BLD",3463,1,107,0)
Routines:
"BLD",3463,1,108,0)
MAG7UP      value = 11177267
"BLD",3463,1,109,0)
MAGBRTE3    value = 5833319
"BLD",3463,1,110,0)
MAGBRTE4    value = 15295929
"BLD",3463,1,111,0)
MAGBRTE5    value = 10025015
"BLD",3463,1,112,0)
MAGBRTK     value = 7162000
"BLD",3463,1,113,0)
MAGBRTLD    value = 7191644
"BLD",3463,1,114,0)
MAGBRTUT    value = 6881357
"BLD",3463,1,115,0)
MAGDCCSS    value = 7813577
"BLD",3463,1,116,0)
MAGDFB      value = 2735520
"BLD",3463,1,117,0)
MAGDFCNV    value = 4468938
"BLD",3463,1,118,0)
MAGDGL      value = 8800264
"BLD",3463,1,119,0)
MAGDGMRC    value = 8586191
"BLD",3463,1,120,0)
MAGDHWA     value = 13363551
"BLD",3463,1,121,0)
MAGDHWC     value = 11574745
"BLD",3463,1,122,0)
MAGDHWS     value = 8385051
"BLD",3463,1,123,0)
MAGDIR8     value = 4801612
"BLD",3463,1,124,0)
MAGDIR81    value = 15887244
"BLD",3463,1,125,0)
MAGDIR82    value = 13699038
"BLD",3463,1,126,0)
MAGDIR83    value = 8183019
"BLD",3463,1,127,0)
MAGDIR8A    value = 10596882
"BLD",3463,1,128,0)
MAGDIR9A    value = 11238086
"BLD",3463,1,129,0)
MAGDIR9B    value = 6917351
"BLD",3463,1,130,0)
MAGDIR9E    value = 13785673
"BLD",3463,1,131,0)
MAGDLB12    value = 8056663
"BLD",3463,1,132,0)
MAGDLB6     value = 3475437
"BLD",3463,1,133,0)
MAGDLBAA    value = 6585681
"BLD",3463,1,134,0)
MAGDLBV     value = 6999551
"BLD",3463,1,135,0)
MAGDMEDK    value = 3272291
"BLD",3463,1,136,0)
MAGDMEDL    value = 6755625
"BLD",3463,1,137,0)
MAGDQR00    value = 2425880
"BLD",3463,1,138,0)
MAGDQR01    value = 8020820
"BLD",3463,1,139,0)
MAGDQR02    value = 15665200
"BLD",3463,1,140,0)
MAGDQR03    value = 9918762
"BLD",3463,1,141,0)
MAGDQR04    value = 12503040
"BLD",3463,1,142,0)
MAGDRA2     value = 7860816
"BLD",3463,1,143,0)
MAGDRCU2    value = 9684614
"BLD",3463,1,144,0)
MAGDRPC1    value = 11783859
"BLD",3463,1,145,0)
MAGDRPC2    value = 13189349
"BLD",3463,1,146,0)
MAGDRPC3    value = 11696591
"BLD",3463,1,147,0)
MAGDRPC4    value = 16384505
"BLD",3463,1,148,0)
MAGDRPC5    value = 14689488
"BLD",3463,1,149,0)
MAGDRPC6    value = 11177465
"BLD",3463,1,150,0)
MAGDRPC7    value = 8740525
"BLD",3463,1,151,0)
MAGDRPC8    value = 10596480
"BLD",3463,1,152,0)
MAGIPS51    value = 9657731
"BLD",3463,1,153,0)
MAGJEX2     value = 14452837
"BLD",3463,1,154,0)
MAGUXRF     value = 4648912
"BLD",3463,1,155,0)
MAGVCHK     value = 7581330
"BLD",3463,1,156,0)
 
"BLD",3463,1,157,0)
Please note that routine MAGIPS51 is deleted after the KIDS Build is
"BLD",3463,1,158,0)
installed.
"BLD",3463,4,0)
^9.64PA^2006.587^16
"BLD",3463,4,2005,0)
2005
"BLD",3463,4,2005,2,0)
^9.641^2005^1
"BLD",3463,4,2005,2,2005,0)
IMAGE  (File-top level)
"BLD",3463,4,2005,2,2005,1,0)
^9.6411^251^1
"BLD",3463,4,2005,2,2005,1,251,0)
DICOM SOP CLASS
"BLD",3463,4,2005,222)
y^y^p^^^^n
"BLD",3463,4,2005.1,0)
2005.1
"BLD",3463,4,2005.1,2,0)
^9.641^2005.1^1
"BLD",3463,4,2005.1,2,2005.1,0)
IMAGE AUDIT  (File-top level)
"BLD",3463,4,2005.1,2,2005.1,1,0)
^9.6411^251^1
"BLD",3463,4,2005.1,2,2005.1,1,251,0)
DICOM SOP CLASS
"BLD",3463,4,2005.1,222)
y^y^p^^^^n^^n
"BLD",3463,4,2005.1,224)

"BLD",3463,4,2005.2,0)
2005.2
"BLD",3463,4,2005.2,2,0)
^9.641^2005.2^1
"BLD",3463,4,2005.2,2,2005.2,0)
NETWORK LOCATION  (File-top level)
"BLD",3463,4,2005.2,2,2005.2,1,0)
^9.6411^14^2
"BLD",3463,4,2005.2,2,2005.2,1,14,0)
COMPRESSION
"BLD",3463,4,2005.2,2,2005.2,1,26,0)
ROUTER
"BLD",3463,4,2005.2,222)
y^y^p^^^^n
"BLD",3463,4,2006.035,0)
2006.035
"BLD",3463,4,2006.035,2,0)
^9.641^2006.035^1
"BLD",3463,4,2006.035,2,2006.035,0)
SEND QUEUE  (File-top level)
"BLD",3463,4,2006.035,2,2006.035,1,0)
^9.6411^4^6
"BLD",3463,4,2006.035,2,2006.035,1,.01,0)
IMAGE
"BLD",3463,4,2006.035,2,2006.035,1,1,0)
DESTINATION
"BLD",3463,4,2006.035,2,2006.035,1,2,0)
TYPE
"BLD",3463,4,2006.035,2,2006.035,1,3,0)
STATUS
"BLD",3463,4,2006.035,2,2006.035,1,4,0)
PRIORITY
"BLD",3463,4,2006.035,2,2006.035,1,8,0)
ORIGIN
"BLD",3463,4,2006.035,222)
y^y^p^^^^n
"BLD",3463,4,2006.51,0)
2006.51
"BLD",3463,4,2006.51,222)
y^y^f^^^^n
"BLD",3463,4,2006.532,0)
2006.532
"BLD",3463,4,2006.532,222)
y^y^f^^n^^y^o^n
"BLD",3463,4,2006.563,0)
2006.563
"BLD",3463,4,2006.563,2,0)
^9.641^2006.563^1
"BLD",3463,4,2006.563,2,2006.563,0)
DICOM GATEWAY PARAMETER  (File-top level)
"BLD",3463,4,2006.563,2,2006.563,1,0)
^9.6411^85^2
"BLD",3463,4,2006.563,2,2006.563,1,84,0)
ET ADDRESS
"BLD",3463,4,2006.563,2,2006.563,1,85,0)
MAG VISTA CHECKSUMS
"BLD",3463,4,2006.563,222)
y^y^p^^^^n^^n
"BLD",3463,4,2006.563,224)

"BLD",3463,4,2006.5641,0)
2006.5641
"BLD",3463,4,2006.5641,222)
y^y^f^^^^n
"BLD",3463,4,2006.57,0)
2006.57
"BLD",3463,4,2006.57,222)
y^y^f^^^^n
"BLD",3463,4,2006.5715,0)
2006.5715
"BLD",3463,4,2006.5715,222)
y^y^f^^^^n
"BLD",3463,4,2006.5732,0)
2006.5732
"BLD",3463,4,2006.5732,222)
y^y^f^^^^n
"BLD",3463,4,2006.574,0)
2006.574
"BLD",3463,4,2006.574,222)
y^y^f^^^^n
"BLD",3463,4,2006.575,0)
2006.575
"BLD",3463,4,2006.575,222)
y^y^f^^^^n
"BLD",3463,4,2006.5762,0)
2006.5762
"BLD",3463,4,2006.5762,222)
y^y^f^^^^n
"BLD",3463,4,2006.582,0)
2006.582
"BLD",3463,4,2006.582,2,0)
^9.641^2006.582^1
"BLD",3463,4,2006.582,2,2006.582,0)
MODALITY TYPE DICTIONARY  (File-top level)
"BLD",3463,4,2006.582,2,2006.582,1,0)
^9.6411^9^1
"BLD",3463,4,2006.582,2,2006.582,1,9,0)
ACTIVE
"BLD",3463,4,2006.582,222)
y^y^p^^^^n
"BLD",3463,4,2006.587,0)
2006.587
"BLD",3463,4,2006.587,222)
y^y^f^^^^n
"BLD",3463,4,"APDD",2006.582,2006.582)

"BLD",3463,4,"APDD",2005,2005)

"BLD",3463,4,"APDD",2005,2005,251)

"BLD",3463,4,"APDD",2005.1,2005.1)

"BLD",3463,4,"APDD",2005.1,2005.1,251)

"BLD",3463,4,"APDD",2005.2,2005.2)

"BLD",3463,4,"APDD",2005.2,2005.2,14)

"BLD",3463,4,"APDD",2005.2,2005.2,26)

"BLD",3463,4,"APDD",2006.035,2006.035)

"BLD",3463,4,"APDD",2006.035,2006.035,.01)

"BLD",3463,4,"APDD",2006.035,2006.035,1)

"BLD",3463,4,"APDD",2006.035,2006.035,2)

"BLD",3463,4,"APDD",2006.035,2006.035,3)

"BLD",3463,4,"APDD",2006.035,2006.035,4)

"BLD",3463,4,"APDD",2006.035,2006.035,8)

"BLD",3463,4,"APDD",2006.563,2006.563)

"BLD",3463,4,"APDD",2006.563,2006.563,84)

"BLD",3463,4,"APDD",2006.563,2006.563,85)

"BLD",3463,4,"APDD",2006.582,2006.582)

"BLD",3463,4,"APDD",2006.582,2006.582,9)

"BLD",3463,4,"B",2005,2005)

"BLD",3463,4,"B",2005.1,2005.1)

"BLD",3463,4,"B",2005.2,2005.2)

"BLD",3463,4,"B",2006.035,2006.035)

"BLD",3463,4,"B",2006.51,2006.51)

"BLD",3463,4,"B",2006.532,2006.532)

"BLD",3463,4,"B",2006.563,2006.563)

"BLD",3463,4,"B",2006.5641,2006.5641)

"BLD",3463,4,"B",2006.57,2006.57)

"BLD",3463,4,"B",2006.5715,2006.5715)

"BLD",3463,4,"B",2006.5732,2006.5732)

"BLD",3463,4,"B",2006.574,2006.574)

"BLD",3463,4,"B",2006.575,2006.575)

"BLD",3463,4,"B",2006.5762,2006.5762)

"BLD",3463,4,"B",2006.582,2006.582)

"BLD",3463,4,"B",2006.587,2006.587)

"BLD",3463,"ABNS",0)
^9.66A^^
"BLD",3463,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@DOMAIN.EXT
"BLD",3463,"INI")
PRE^MAGIPS51
"BLD",3463,"INID")
n^y^n
"BLD",3463,"INIT")
POST^MAGIPS51
"BLD",3463,"KRN",0)
^9.67PA^8994^19
"BLD",3463,"KRN",.4,0)
.4
"BLD",3463,"KRN",.401,0)
.401
"BLD",3463,"KRN",.402,0)
.402
"BLD",3463,"KRN",.403,0)
.403
"BLD",3463,"KRN",.5,0)
.5
"BLD",3463,"KRN",.84,0)
.84
"BLD",3463,"KRN",3.6,0)
3.6
"BLD",3463,"KRN",3.8,0)
3.8
"BLD",3463,"KRN",9.2,0)
9.2
"BLD",3463,"KRN",9.8,0)
9.8
"BLD",3463,"KRN",9.8,"NM",0)
^9.68A^47^47
"BLD",3463,"KRN",9.8,"NM",1,0)
MAG7UP^^0^B34875703
"BLD",3463,"KRN",9.8,"NM",2,0)
MAGBRTE3^^0^B17206043
"BLD",3463,"KRN",9.8,"NM",3,0)
MAGBRTE4^^0^B79623233
"BLD",3463,"KRN",9.8,"NM",4,0)
MAGBRTE5^^0^B36381049
"BLD",3463,"KRN",9.8,"NM",5,0)
MAGBRTK^^0^B19598690
"BLD",3463,"KRN",9.8,"NM",6,0)
MAGBRTLD^^0^B16140125
"BLD",3463,"KRN",9.8,"NM",7,0)
MAGBRTUT^^0^B19709178
"BLD",3463,"KRN",9.8,"NM",8,0)
MAGDCCSS^^0^B23075441
"BLD",3463,"KRN",9.8,"NM",9,0)
MAGDFB^^0^B3801843
"BLD",3463,"KRN",9.8,"NM",10,0)
MAGDFCNV^^0^B8587373
"BLD",3463,"KRN",9.8,"NM",11,0)
MAGDGL^^0^B30841791
"BLD",3463,"KRN",9.8,"NM",12,0)
MAGDGMRC^^0^B32065539
"BLD",3463,"KRN",9.8,"NM",13,0)
MAGDHWA^^0^B58804489
"BLD",3463,"KRN",9.8,"NM",14,0)
MAGDHWC^^0^B43939437
"BLD",3463,"KRN",9.8,"NM",15,0)
MAGDHWS^^0^B24229864
"BLD",3463,"KRN",9.8,"NM",16,0)
MAGDIR8^^0^B11043357
"BLD",3463,"KRN",9.8,"NM",17,0)
MAGDIR81^^0^B73980751
"BLD",3463,"KRN",9.8,"NM",18,0)
MAGDIR82^^0^B61661475
"BLD",3463,"KRN",9.8,"NM",19,0)
MAGDIR83^^0^B24672823
"BLD",3463,"KRN",9.8,"NM",20,0)
MAGDIR8A^^0^B36949369
"BLD",3463,"KRN",9.8,"NM",21,0)
MAGDIR9A^^0^B49392347
"BLD",3463,"KRN",9.8,"NM",22,0)
MAGDIR9B^^0^B17435777
"BLD",3463,"KRN",9.8,"NM",23,0)
MAGDIR9E^^0^B60855818
"BLD",3463,"KRN",9.8,"NM",24,0)
MAGDLB12^^0^B22785592
"BLD",3463,"KRN",9.8,"NM",25,0)
MAGDLB6^^0^B5741563
"BLD",3463,"KRN",9.8,"NM",26,0)
MAGDLBAA^^0^B12734072
"BLD",3463,"KRN",9.8,"NM",27,0)
MAGDLBV^^0^B16977570
"BLD",3463,"KRN",9.8,"NM",28,0)
MAGDMEDK^^0^B5415662
"BLD",3463,"KRN",9.8,"NM",29,0)
MAGDMEDL^^0^B19875835
"BLD",3463,"KRN",9.8,"NM",30,0)
MAGDQR00^^0^B3096939
"BLD",3463,"KRN",9.8,"NM",31,0)
MAGDQR01^^0^B25742875
"BLD",3463,"KRN",9.8,"NM",32,0)
MAGDQR02^^0^B75305659
"BLD",3463,"KRN",9.8,"NM",33,0)
MAGDQR03^^0^B63890253
"BLD",3463,"KRN",9.8,"NM",34,0)
MAGDQR04^^0^B52493648
"BLD",3463,"KRN",9.8,"NM",35,0)
MAGDRA2^^0^B25261561
"BLD",3463,"KRN",9.8,"NM",36,0)
MAGDRCU2^^0^B38123577
"BLD",3463,"KRN",9.8,"NM",37,0)
MAGDRPC1^^0^B59232604
"BLD",3463,"KRN",9.8,"NM",38,0)
MAGDRPC2^^0^B65141543
"BLD",3463,"KRN",9.8,"NM",39,0)
MAGDRPC3^^0^B44058911
"BLD",3463,"KRN",9.8,"NM",40,0)
MAGDRPC4^^0^B72718318
"BLD",3463,"KRN",9.8,"NM",41,0)
MAGDRPC5^^0^B79459148
"BLD",3463,"KRN",9.8,"NM",42,0)
MAGDRPC6^^0^B36593110
"BLD",3463,"KRN",9.8,"NM",43,0)
MAGDRPC7^^0^B33129765
"BLD",3463,"KRN",9.8,"NM",44,0)
MAGDRPC8^^0^B49397368
"BLD",3463,"KRN",9.8,"NM",45,0)
MAGJEX2^^0^B48782421
"BLD",3463,"KRN",9.8,"NM",46,0)
MAGUXRF^^0^B17102779
"BLD",3463,"KRN",9.8,"NM",47,0)
MAGVCHK^^0^B21002170
"BLD",3463,"KRN",9.8,"NM","B","MAG7UP",1)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTE3",2)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTE4",3)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTE5",4)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTK",5)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTLD",6)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTUT",7)

"BLD",3463,"KRN",9.8,"NM","B","MAGDCCSS",8)

"BLD",3463,"KRN",9.8,"NM","B","MAGDFB",9)

"BLD",3463,"KRN",9.8,"NM","B","MAGDFCNV",10)

"BLD",3463,"KRN",9.8,"NM","B","MAGDGL",11)

"BLD",3463,"KRN",9.8,"NM","B","MAGDGMRC",12)

"BLD",3463,"KRN",9.8,"NM","B","MAGDHWA",13)

"BLD",3463,"KRN",9.8,"NM","B","MAGDHWC",14)

"BLD",3463,"KRN",9.8,"NM","B","MAGDHWS",15)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR8",16)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR81",17)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR82",18)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR83",19)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR8A",20)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR9A",21)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR9B",22)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR9E",23)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLB12",24)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLB6",25)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLBAA",26)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLBV",27)

"BLD",3463,"KRN",9.8,"NM","B","MAGDMEDK",28)

"BLD",3463,"KRN",9.8,"NM","B","MAGDMEDL",29)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR00",30)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR01",31)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR02",32)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR03",33)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR04",34)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRA2",35)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRCU2",36)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC1",37)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC2",38)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC3",39)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC4",40)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC5",41)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC6",42)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC7",43)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC8",44)

"BLD",3463,"KRN",9.8,"NM","B","MAGJEX2",45)

"BLD",3463,"KRN",9.8,"NM","B","MAGUXRF",46)

"BLD",3463,"KRN",9.8,"NM","B","MAGVCHK",47)

"BLD",3463,"KRN",19,0)
19
"BLD",3463,"KRN",19,"NM",0)
^9.68A^4^4
"BLD",3463,"KRN",19,"NM",1,0)
MAG DICOM CORRECT VALIDATE^^0
"BLD",3463,"KRN",19,"NM",2,0)
MAG DICOM QUERY RETRIEVE^^0
"BLD",3463,"KRN",19,"NM",3,0)
MAGD DICOM MENU^^2
"BLD",3463,"KRN",19,"NM",4,0)
MAGD DICOM ROUTINE UPLOAD^^1
"BLD",3463,"KRN",19,"NM","B","MAG DICOM CORRECT VALIDATE",1)

"BLD",3463,"KRN",19,"NM","B","MAG DICOM QUERY RETRIEVE",2)

"BLD",3463,"KRN",19,"NM","B","MAGD DICOM MENU",3)

"BLD",3463,"KRN",19,"NM","B","MAGD DICOM ROUTINE UPLOAD",4)

"BLD",3463,"KRN",19.1,0)
19.1
"BLD",3463,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",3463,"KRN",101,0)
101
"BLD",3463,"KRN",101,"NM",0)
^9.68A^^
"BLD",3463,"KRN",409.61,0)
409.61
"BLD",3463,"KRN",771,0)
771
"BLD",3463,"KRN",870,0)
870
"BLD",3463,"KRN",8989.51,0)
8989.51
"BLD",3463,"KRN",8989.52,0)
8989.52
"BLD",3463,"KRN",8994,0)
8994
"BLD",3463,"KRN",8994,"NM",0)
^9.68A^6^6
"BLD",3463,"KRN",8994,"NM",1,0)
MAG CFIND QUERY^^0
"BLD",3463,"KRN",8994,"NM",2,0)
MAG DICOM CHECK MACHINE ID^^0
"BLD",3463,"KRN",8994,"NM",3,0)
MAG DICOM CORRECT VALIDATE^^0
"BLD",3463,"KRN",8994,"NM",4,0)
MAG DICOM UPDATE MACHINE ID^^0
"BLD",3463,"KRN",8994,"NM",5,0)
MAG STUDY UID QUERY^^0
"BLD",3463,"KRN",8994,"NM",6,0)
MAG VISTA CHECKSUMS^^0
"BLD",3463,"KRN",8994,"NM","B","MAG CFIND QUERY",1)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM CHECK MACHINE ID",2)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM CORRECT VALIDATE",3)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM UPDATE MACHINE ID",4)

"BLD",3463,"KRN",8994,"NM","B","MAG STUDY UID QUERY",5)

"BLD",3463,"KRN",8994,"NM","B","MAG VISTA CHECKSUMS",6)

"BLD",3463,"KRN","B",.4,.4)

"BLD",3463,"KRN","B",.401,.401)

"BLD",3463,"KRN","B",.402,.402)

"BLD",3463,"KRN","B",.403,.403)

"BLD",3463,"KRN","B",.5,.5)

"BLD",3463,"KRN","B",.84,.84)

"BLD",3463,"KRN","B",3.6,3.6)

"BLD",3463,"KRN","B",3.8,3.8)

"BLD",3463,"KRN","B",9.2,9.2)

"BLD",3463,"KRN","B",9.8,9.8)

"BLD",3463,"KRN","B",19,19)

"BLD",3463,"KRN","B",19.1,19.1)

"BLD",3463,"KRN","B",101,101)

"BLD",3463,"KRN","B",409.61,409.61)

"BLD",3463,"KRN","B",771,771)

"BLD",3463,"KRN","B",870,870)

"BLD",3463,"KRN","B",8989.51,8989.51)

"BLD",3463,"KRN","B",8989.52,8989.52)

"BLD",3463,"KRN","B",8994,8994)

"BLD",3463,"REQB",0)
^9.611^4^4
"BLD",3463,"REQB",1,0)
MAG*3.0*10^2
"BLD",3463,"REQB",2,0)
MAG*3.0*11^2
"BLD",3463,"REQB",3,0)
MAG*3.0*30^2
"BLD",3463,"REQB",4,0)
MAG*3.0*8^2
"BLD",3463,"REQB","B","MAG*3.0*10",1)

"BLD",3463,"REQB","B","MAG*3.0*11",2)

"BLD",3463,"REQB","B","MAG*3.0*30",3)

"BLD",3463,"REQB","B","MAG*3.0*8",4)

"DATA",2006.532,1,0)
1.2.840.10008.5.1.4.1.1.1^Computed Radiography Image Storage^^A
"DATA",2006.532,2,0)
1.2.840.10008.5.1.4.1.1.1.1^Digital X-Ray Image Storage - For Presentation^1^A
"DATA",2006.532,3,0)
1.2.840.10008.5.1.4.1.1.1.1.1^Digital X-Ray Image Storage - For Processing^^A
"DATA",2006.532,4,0)
1.2.840.10008.5.1.4.1.1.1.2^Digital Mammography X-Ray Image Storage - For Presentation^^A
"DATA",2006.532,5,0)
1.2.840.10008.5.1.4.1.1.1.2.1^Digital Mammography X-Ray Image Storage - For Processing^^A
"DATA",2006.532,6,0)
1.2.840.10008.5.1.4.1.1.1.3^Digital Intra-oral X-Ray Image Storage - For Presentation^^A
"DATA",2006.532,7,0)
1.2.840.10008.5.1.4.1.1.1.3.1^Digital Intra-oral X-Ray Image Storage - For Processing^^A
"DATA",2006.532,8,0)
1.2.840.10008.5.1.4.1.1.2^CT Image Storage^^A
"DATA",2006.532,9,0)
1.2.840.10008.5.1.4.1.1.3^Ultrasound Multi-frame Image Storage (Retired)^^A
"DATA",2006.532,10,0)
1.2.840.10008.5.1.4.1.1.3.1^Ultrasound Multi-frame Image Storage^^A
"DATA",2006.532,11,0)
1.2.840.10008.5.1.4.1.1.4^MR Image Storage^^A
"DATA",2006.532,12,0)
1.2.840.10008.5.1.4.1.1.5^Nuclear Medicine Image Storage (Retired)^^A
"DATA",2006.532,13,0)
1.2.840.10008.5.1.4.1.1.6^Ultrasound Image Storage (Retired)^^A
"DATA",2006.532,14,0)
1.2.840.10008.5.1.4.1.1.6.1^Ultrasound Image Storage^^A
"DATA",2006.532,15,0)
1.2.840.10008.5.1.4.1.1.7^Secondary Capture Image Storage^^A
"DATA",2006.532,16,0)
1.2.840.10008.5.1.4.1.1.7.1^Multi-frame Single Bit Secondary Capture Image Storage^15^A
"DATA",2006.532,17,0)
1.2.840.10008.5.1.4.1.1.7.2^Multi-frame Grayscale Byte Secondary Capture Image Storage^15^A
"DATA",2006.532,18,0)
1.2.840.10008.5.1.4.1.1.7.3^Multi-frame Grayscale Word Secondary Capture Image Storage^15^A
"DATA",2006.532,19,0)
1.2.840.10008.5.1.4.1.1.7.4^Multi-frame True Color Secondary Capture Image Storage^15^A
"DATA",2006.532,20,0)
1.2.840.10008.5.1.4.1.1.8^Standalone Overlay Storage^^A
"DATA",2006.532,21,0)
1.2.840.10008.5.1.4.1.1.9^Standalone Curve Storage^^A
"DATA",2006.532,22,0)
1.2.840.10008.5.1.4.1.1.9.1.1^12-lead ECG Waveform Storage^^A
"DATA",2006.532,23,0)
1.2.840.10008.5.1.4.1.1.9.1.2^General ECG Waveform Storage^^A
"DATA",2006.532,24,0)
1.2.840.10008.5.1.4.1.1.9.1.3^Ambulatory ECG Waveform Storage^^A
"DATA",2006.532,25,0)
1.2.840.10008.5.1.4.1.1.9.2.1^Hemodynamic Waveform Storage^^A
"DATA",2006.532,26,0)
1.2.840.10008.5.1.4.1.1.9.3.1^Cardiac Electrophysiology Waveform Storage^^A
"DATA",2006.532,27,0)
1.2.840.10008.5.1.4.1.1.9.4.1^Basic Voice Audio Waveform Storage^^A
"DATA",2006.532,28,0)
1.2.840.10008.5.1.4.1.1.10^Standalone Modality LUT Storage^^A
"DATA",2006.532,29,0)
1.2.840.10008.5.1.4.1.1.11^Standalone VOI LUT Storage^^A
"DATA",2006.532,30,0)
1.2.840.10008.5.1.4.1.1.11.1^Grayscale Softcopy Presentation State Storage SOP Class^^A
"DATA",2006.532,31,0)
1.2.840.10008.5.1.4.1.1.12.1^X-Ray Angiographic Image Storage^^A
"DATA",2006.532,32,0)
1.2.840.10008.5.1.4.1.1.12.2^X-Ray Radiofluoroscopic Image Storage^^A
"DATA",2006.532,33,0)
1.2.840.10008.5.1.4.1.1.12.3^X-Ray Angiographic Bi-Plane Image Storage (Retired)^^A
"DATA",2006.532,34,0)
1.2.840.10008.5.1.4.1.1.20^Nuclear Medicine Image Storage^^A
"DATA",2006.532,35,0)
1.2.840.10008.5.1.4.1.1.66^Raw Data Storage^^A
"DATA",2006.532,36,0)
1.2.840.10008.5.1.4.1.1.66.1^Spatial Registration Storage^^A
"DATA",2006.532,37,0)
1.2.840.10008.5.1.4.1.1.66.2^Spatial Fiducials Storage^^A
"DATA",2006.532,38,0)
1.2.840.10008.5.1.4.1.1.77.1^VL Image Storage (Retired)^^A
"DATA",2006.532,39,0)
1.2.840.10008.5.1.4.1.1.77.2^VL Multi-frame Image Storage (Retired)^^A
"DATA",2006.532,40,0)
1.2.840.10008.5.1.4.1.1.77.1.1^VL Endoscopic Image Storage^^A
"DATA",2006.532,41,0)
1.2.840.10008.5.1.4.1.1.77.1.1.1^Video Endoscopic Image Storage^^A
"DATA",2006.532,42,0)
1.2.840.10008.5.1.4.1.1.77.1.2^VL Microscopic Image Storage^^A
"DATA",2006.532,43,0)
1.2.840.10008.5.1.4.1.1.77.1.2.1^Video Microscopic Image Storage^^A
"DATA",2006.532,44,0)
1.2.840.10008.5.1.4.1.1.77.1.3^VL Slide-Coordinates Microscopic Image Storage^^A
"DATA",2006.532,45,0)
1.2.840.10008.5.1.4.1.1.77.1.4^VL Photographic Image Storage^^A
"DATA",2006.532,46,0)
1.2.840.10008.5.1.4.1.1.77.1.4.1^Video Photographic Image Storage^^A
"DATA",2006.532,47,0)
1.2.840.10008.5.1.4.1.1.77.1.5.1^Ophthalmic Photography 8 Bit Image Storage^^A
"DATA",2006.532,48,0)
1.2.840.10008.5.1.4.1.1.77.1.5.2^Ophthalmic Photography 16 Bit Image Storage^47^A
"DATA",2006.532,49,0)
1.2.840.10008.5.1.4.1.1.77.1.5.3^Stereometric Relationship Storage^^A
"DATA",2006.532,50,0)
1.2.840.10008.5.1.4.1.1.88.40^Procedure Log Storage^^A
"DATA",2006.532,51,0)
1.2.840.10008.5.1.4.1.1.128^Positron Emission Tomography Image Storage^^A
"DATA",2006.532,52,0)
1.2.840.10008.5.1.4.1.1.129^Standalone PET Curve Storage^^A
"DATA",2006.532,53,0)
1.2.840.10008.5.1.4.1.1.481.1^RT Image Storage^^A
"DATA",2006.532,54,0)
1.2.840.10008.5.1.4.1.1.481.2^RT Dose Storage^^A
"DATA",2006.532,55,0)
1.2.840.10008.5.1.4.1.1.481.3^RT Structure Set Storage^^A
"DATA",2006.532,56,0)
1.2.840.10008.5.1.4.1.1.481.4^RT Beams Treatment Record Storage^^A
"DATA",2006.532,57,0)
1.2.840.10008.5.1.4.1.1.481.5^RT Plan Storage^^A
"DATA",2006.532,58,0)
1.2.840.10008.5.1.4.1.1.481.6^RT Brachy Treatment Record Storage^^A
"DATA",2006.532,59,0)
1.2.840.10008.5.1.4.1.1.481.7^RT Treatment Summary Record Storage^^A
"FIA",2005)
IMAGE
"FIA",2005,0)
^MAG(2005,
"FIA",2005,0,0)
2005I
"FIA",2005,0,1)
y^y^p^^^^n
"FIA",2005,0,10)

"FIA",2005,0,11)

"FIA",2005,0,"RLRO")

"FIA",2005,2005)
1
"FIA",2005,2005,251)

"FIA",2005.1)
IMAGE AUDIT
"FIA",2005.1,0)
^MAG(2005.1,
"FIA",2005.1,0,0)
2005.1I
"FIA",2005.1,0,1)
y^y^p^^^^n^^n
"FIA",2005.1,0,10)

"FIA",2005.1,0,11)

"FIA",2005.1,0,"RLRO")

"FIA",2005.1,2005.1)
1
"FIA",2005.1,2005.1,251)

"FIA",2005.2)
NETWORK LOCATION
"FIA",2005.2,0)
^MAG(2005.2,
"FIA",2005.2,0,0)
2005.2I
"FIA",2005.2,0,1)
y^y^p^^^^n
"FIA",2005.2,0,10)

"FIA",2005.2,0,11)

"FIA",2005.2,0,"RLRO")

"FIA",2005.2,2005.2)
1
"FIA",2005.2,2005.2,14)

"FIA",2005.2,2005.2,26)

"FIA",2006.035)
SEND QUEUE
"FIA",2006.035,0)
^MAGQUEUE(2006.035,
"FIA",2006.035,0,0)
2006.035
"FIA",2006.035,0,1)
y^y^p^^^^n
"FIA",2006.035,0,10)

"FIA",2006.035,0,11)

"FIA",2006.035,0,"RLRO")

"FIA",2006.035,2006.035)
1
"FIA",2006.035,2006.035,.01)

"FIA",2006.035,2006.035,1)

"FIA",2006.035,2006.035,2)

"FIA",2006.035,2006.035,3)

"FIA",2006.035,2006.035,4)

"FIA",2006.035,2006.035,8)

"FIA",2006.51)
DICOM DATA ELEMENT DICTIONARY
"FIA",2006.51,0)
^MAGDICOM(2006.51,
"FIA",2006.51,0,0)
2006.51
"FIA",2006.51,0,1)
y^y^f^^^^n
"FIA",2006.51,0,10)

"FIA",2006.51,0,11)

"FIA",2006.51,0,"RLRO")

"FIA",2006.51,2006.51)
0
"FIA",2006.51,2006.514)
0
"FIA",2006.532)
DICOM SOP CLASS
"FIA",2006.532,0)
^MAG(2006.532,
"FIA",2006.532,0,0)
2006.532
"FIA",2006.532,0,1)
y^y^f^^n^^y^o^n
"FIA",2006.532,0,10)

"FIA",2006.532,0,11)

"FIA",2006.532,0,"RLRO")

"FIA",2006.532,2006.532)
0
"FIA",2006.563)
DICOM GATEWAY PARAMETER
"FIA",2006.563,0)
^MAGDICOM(2006.563,
"FIA",2006.563,0,0)
2006.563
"FIA",2006.563,0,1)
y^y^p^^^^n^^n
"FIA",2006.563,0,10)

"FIA",2006.563,0,11)

"FIA",2006.563,0,"RLRO")

"FIA",2006.563,2006.563)
1
"FIA",2006.563,2006.563,84)

"FIA",2006.563,2006.563,85)

"FIA",2006.5641)
DICOM GATEWAY MACHINE ID
"FIA",2006.5641,0)
^MAGDICOM(2006.5641,
"FIA",2006.5641,0,0)
2006.5641
"FIA",2006.5641,0,1)
y^y^f^^^^n
"FIA",2006.5641,0,10)

"FIA",2006.5641,0,11)

"FIA",2006.5641,0,"RLRO")

"FIA",2006.5641,2006.5641)
0
"FIA",2006.57)
DICOM HL7 SEGMENT
"FIA",2006.57,0)
^MAGDICOM(2006.57,
"FIA",2006.57,0,0)
2006.57
"FIA",2006.57,0,1)
y^y^f^^^^n
"FIA",2006.57,0,10)

"FIA",2006.57,0,11)

"FIA",2006.57,0,"RLRO")

"FIA",2006.57,2006.57)
0
"FIA",2006.57,2006.5701)
0
"FIA",2006.5715)
CURRENT IMAGE
"FIA",2006.5715,0)
^MAGD(2006.5715,
"FIA",2006.5715,0,0)
2006.5715
"FIA",2006.5715,0,1)
y^y^f^^^^n
"FIA",2006.5715,0,10)

"FIA",2006.5715,0,11)

"FIA",2006.5715,0,"RLRO")

"FIA",2006.5715,2006.5715)
0
"FIA",2006.5732)
DICOM QUERY RETRIEVE RESULT
"FIA",2006.5732,0)
^MAGDQR(2006.5732,
"FIA",2006.5732,0,0)
2006.5732
"FIA",2006.5732,0,1)
y^y^f^^^^n
"FIA",2006.5732,0,10)

"FIA",2006.5732,0,11)

"FIA",2006.5732,0,"RLRO")

"FIA",2006.5732,2006.5732)
0
"FIA",2006.5732,2006.57321)
0
"FIA",2006.574)
DICOM IMAGE OUTPUT
"FIA",2006.574,0)
^MAGDOUTP(2006.574,
"FIA",2006.574,0,0)
2006.574
"FIA",2006.574,0,1)
y^y^f^^^^n
"FIA",2006.574,0,10)

"FIA",2006.574,0,11)

"FIA",2006.574,0,"RLRO")

"FIA",2006.574,2006.574)
0
"FIA",2006.574,2006.5744)
0
"FIA",2006.575)
DICOM FAILED IMAGES
"FIA",2006.575,0)
^MAGD(2006.575,
"FIA",2006.575,0,0)
2006.575
"FIA",2006.575,0,1)
y^y^f^^^^n
"FIA",2006.575,0,10)

"FIA",2006.575,0,11)

"FIA",2006.575,0,"RLRO")

"FIA",2006.575,2006.575)
0
"FIA",2006.575,2006.57526)
0
"FIA",2006.5762)
DICOM INSTRUMENT STATISTICS
"FIA",2006.5762,0)
^MAGDAUDT(2006.5762,
"FIA",2006.5762,0,0)
2006.5762
"FIA",2006.5762,0,1)
y^y^f^^^^n
"FIA",2006.5762,0,10)

"FIA",2006.5762,0,11)

"FIA",2006.5762,0,"RLRO")

"FIA",2006.5762,2006.5762)
0
"FIA",2006.5762,2006.57621)
0
"FIA",2006.5762,2006.576211)
0
"FIA",2006.582)
MODALITY TYPE DICTIONARY
"FIA",2006.582,0)
^MAGDICOM(2006.582,
"FIA",2006.582,0,0)
2006.582
"FIA",2006.582,0,1)
y^y^p^^^^n
"FIA",2006.582,0,10)

"FIA",2006.582,0,11)

"FIA",2006.582,0,"RLRO")

"FIA",2006.582,2006.582)
1
"FIA",2006.582,2006.582,9)

"FIA",2006.587)
DICOM TRANSMIT DESTINATION
"FIA",2006.587,0)
^MAG(2006.587,
"FIA",2006.587,0,0)
2006.587
"FIA",2006.587,0,1)
y^y^f^^^^n
"FIA",2006.587,0,10)

"FIA",2006.587,0,11)

"FIA",2006.587,0,"RLRO")

"FIA",2006.587,2006.587)
0
"INI")
PRE^MAGIPS51
"INIT")
POST^MAGIPS51
"IX",2006.035,2006.035,"DEST",0)
2006.035^DEST^Destination, status, and file type^R^^R^IR^I^2006.035^^^^^LS
"IX",2006.035,2006.035,"DEST",.1,0)
^^2^2^3020312^
"IX",2006.035,2006.035,"DEST",.1,1,0)
This cross reference keeps track of which images are
"IX",2006.035,2006.035,"DEST",.1,2,0)
slated to go where.
"IX",2006.035,2006.035,"DEST",1)
S ^MAGQUEUE(2006.035,"DEST",X(1),X(2),X(3),X(4),DA)=""
"IX",2006.035,2006.035,"DEST",2)
K ^MAGQUEUE(2006.035,"DEST",X(1),X(2),X(3),X(4),DA)
"IX",2006.035,2006.035,"DEST",2.5)
K ^MAGQUEUE(2006.035,"DEST")
"IX",2006.035,2006.035,"DEST",11.1,0)
^.114IA^4^4
"IX",2006.035,2006.035,"DEST",11.1,1,0)
1^F^2006.035^1^^1^F
"IX",2006.035,2006.035,"DEST",11.1,1,3)

"IX",2006.035,2006.035,"DEST",11.1,2,0)
2^F^2006.035^3^^2^F
"IX",2006.035,2006.035,"DEST",11.1,2,3)

"IX",2006.035,2006.035,"DEST",11.1,3,0)
3^F^2006.035^.01^^3^F
"IX",2006.035,2006.035,"DEST",11.1,3,3)

"IX",2006.035,2006.035,"DEST",11.1,4,0)
4^F^2006.035^2^^4^F
"IX",2006.035,2006.035,"DEST",11.1,4,3)

"IX",2006.035,2006.035,"STS",0)
2006.035^STS^Status, priority and destination^R^^R^IR^I^2006.035^^^^^LS
"IX",2006.035,2006.035,"STS",.1,0)
^^2^2^3020312^
"IX",2006.035,2006.035,"STS",.1,1,0)
This cross reference keeps track of which files are to be sent where and
"IX",2006.035,2006.035,"STS",.1,2,0)
in which order.
"IX",2006.035,2006.035,"STS",1)
S ^MAGQUEUE(2006.035,"STS",X(1),X(2),X(3),X(4),DA)=""
"IX",2006.035,2006.035,"STS",2)
K ^MAGQUEUE(2006.035,"STS",X(1),X(2),X(3),X(4),DA)
"IX",2006.035,2006.035,"STS",2.5)
K ^MAGQUEUE(2006.035,"STS")
"IX",2006.035,2006.035,"STS",11.1,0)
^.114IA^4^4
"IX",2006.035,2006.035,"STS",11.1,1,0)
1^F^2006.035^8^^1^F
"IX",2006.035,2006.035,"STS",11.1,2,0)
2^F^2006.035^3^^2^F
"IX",2006.035,2006.035,"STS",11.1,3,0)
3^F^2006.035^4^^3^F
"IX",2006.035,2006.035,"STS",11.1,4,0)
4^F^2006.035^1^^4^F
"IX",2006.532,2006.532,"B",0)
2006.532^B^Non-truncated B cross-reference^R^^F^IR^I^2006.532^^^^^LS
"IX",2006.532,2006.532,"B",.1,0)
^^3^3^3050111^
"IX",2006.532,2006.532,"B",.1,1,0)
The standard cross-reference truncates the value to 30 characters.
"IX",2006.532,2006.532,"B",.1,2,0)
This version of the cross-reference uses all (up to 64) characters of the
"IX",2006.532,2006.532,"B",.1,3,0)
value.
"IX",2006.532,2006.532,"B",1)
S ^MAG(2006.532,"B",X,DA)=""
"IX",2006.532,2006.532,"B",2)
K ^MAG(2006.532,"B",X,DA)
"IX",2006.532,2006.532,"B",2.5)
K ^MAG(2006.532,"B")
"IX",2006.532,2006.532,"B",11.1,0)
^.114IA^1^1
"IX",2006.532,2006.532,"B",11.1,1,0)
1^F^2006.532^.01^^1^F
"IX",2006.532,2006.532,"B",11.1,1,3)

"IX",2006.532,2006.532,"C",0)
2006.532^C^Cross Reference by SOP Class Name^R^^F^IR^I^2006.532^^^^^LS
"IX",2006.532,2006.532,"C",.1,0)
^^2^2^3050114^
"IX",2006.532,2006.532,"C",.1,1,0)
 
"IX",2006.532,2006.532,"C",.1,2,0)
Trace SOP Class by name.
"IX",2006.532,2006.532,"C",1)
S ^MAG(2006.532,"C",X,DA)=""
"IX",2006.532,2006.532,"C",2)
K ^MAG(2006.532,"C",X,DA)
"IX",2006.532,2006.532,"C",2.5)
K ^MAG(2006.532,"C")
"IX",2006.532,2006.532,"C",11.1,0)
^.114IA^1^1
"IX",2006.532,2006.532,"C",11.1,1,0)
1^F^2006.532^2^^1^F
"IX",2006.532,2006.532,"C",11.1,1,3)

"IX",2006.574,2006.574,"STS",0)
2006.574^STS^Origin and Status^R^^R^IR^W^2006.5744^^^^^LS
"IX",2006.574,2006.574,"STS",.1,0)
^^5^5^3041029^
"IX",2006.574,2006.574,"STS",.1,1,0)
 
"IX",2006.574,2006.574,"STS",.1,2,0)
 
"IX",2006.574,2006.574,"STS",.1,3,0)
This cross-reference keeps track of ORIGIN and STATUS.
"IX",2006.574,2006.574,"STS",.1,4,0)
The main purpose of this cross-reference is to make sure
"IX",2006.574,2006.574,"STS",.1,5,0)
that files are issued to only one transmission process.
"IX",2006.574,2006.574,"STS",1)
S ^MAGDOUTP(2006.574,"STS",X(1),X(2),DA(1),DA)=""
"IX",2006.574,2006.574,"STS",2)
K ^MAGDOUTP(2006.574,"STS",X(1),X(2),DA(1),DA)
"IX",2006.574,2006.574,"STS",2.5)
K ^MAGDOUTP(2006.574,"STS")
"IX",2006.574,2006.574,"STS",11.1,0)
^.114IA^3^2
"IX",2006.574,2006.574,"STS",11.1,2,0)
2^F^2006.5744^2^^2^F
"IX",2006.574,2006.574,"STS",11.1,2,3)

"IX",2006.574,2006.574,"STS",11.1,3,0)
1^C^^^^1^^Origin
"IX",2006.574,2006.574,"STS",11.1,3,1.5)
S X=$P(^MAGDOUTP(2006.574,DA(1),0),"^",4)
"IX",2006.575,2006.575,"AD",0)
2006.575^AD^Date Entered^MU^^F^IR^I^2006.575^^^^^S
"IX",2006.575,2006.575,"AD",.1,0)
^^6^6^3041216^
"IX",2006.575,2006.575,"AD",.1,1,0)
This cross-reference keeps track of when the various entries were
"IX",2006.575,2006.575,"AD",.1,2,0)
created.
"IX",2006.575,2006.575,"AD",.1,3,0)
 
"IX",2006.575,2006.575,"AD",.1,4,0)
This cross-reference is only created for entries that are not yet "fixed".
"IX",2006.575,2006.575,"AD",.1,5,0)
This cross-reference is only created for entries that result from
"IX",2006.575,2006.575,"AD",.1,6,0)
Consults.
"IX",2006.575,2006.575,"AD",1)
S ^MAGD(2006.575,"AD",X(1),DA)=""
"IX",2006.575,2006.575,"AD",1.4)
I 'X(2),X(3)="CON"
"IX",2006.575,2006.575,"AD",2)
K ^MAGD(2006.575,"AD",X(1),DA)
"IX",2006.575,2006.575,"AD",2.5)
K ^MAGD(2006.575,"AD")
"IX",2006.575,2006.575,"AD",11.1,0)
^.114IA^3^3
"IX",2006.575,2006.575,"AD",11.1,1,0)
1^F^2006.575^7^^1^F
"IX",2006.575,2006.575,"AD",11.1,1,3)

"IX",2006.575,2006.575,"AD",11.1,2,0)
2^F^2006.575^16^^^F
"IX",2006.575,2006.575,"AD",11.1,2,3)

"IX",2006.575,2006.575,"AD",11.1,3,0)
3^F^2006.575^32^^^F
"IX",2006.575,2006.575,"AD",11.1,3,3)

"IX",2006.575,2006.575,"AFX",0)
2006.575^AFX^Location and Machine ID^MU^^F^IR^I^2006.575^^^^^S
"IX",2006.575,2006.575,"AFX",.1,0)
^^3^3^3041216^
"IX",2006.575,2006.575,"AFX",.1,1,0)
This cross-reference keeps track of
"IX",2006.575,2006.575,"AFX",.1,2,0)
which computers (Machine ID) belong to
"IX",2006.575,2006.575,"AFX",.1,3,0)
which location.
"IX",2006.575,2006.575,"AFX",1)
S ^MAGD(2006.575,"AFX",X(1),X(2),DA)=""
"IX",2006.575,2006.575,"AFX",1.4)
I $D(^MAGD(2006.575,"F",X(1),X(3),DA))
"IX",2006.575,2006.575,"AFX",2)
K ^MAGD(2006.575,"AFX",X(1),X(2),DA)
"IX",2006.575,2006.575,"AFX",2.5)
K ^MAGD(2006.575,"AFX")
"IX",2006.575,2006.575,"AFX",11.1,0)
^.114IA^3^3
"IX",2006.575,2006.575,"AFX",11.1,1,0)
1^F^2006.575^36^^1^F
"IX",2006.575,2006.575,"AFX",11.1,1,3)

"IX",2006.575,2006.575,"AFX",11.1,2,0)
2^F^2006.575^28^^2^F
"IX",2006.575,2006.575,"AFX",11.1,2,3)

"IX",2006.575,2006.575,"AFX",11.1,3,0)
3^F^2006.575^9^^^F
"IX",2006.575,2006.575,"AFX",11.1,3,3)

"IX",2006.575,2006.575,"D",0)
2006.575^D^Patient ID^MU^^F^IR^I^2006.575^^^^^LS
"IX",2006.575,2006.575,"D",.1,0)
^^6^6^3041216^
"IX",2006.575,2006.575,"D",.1,1,0)
This cross-reference keeps track of which Patient ID belongs to which
"IX",2006.575,2006.575,"D",.1,2,0)
study.
"IX",2006.575,2006.575,"D",.1,3,0)
 
"IX",2006.575,2006.575,"D",.1,4,0)
This cross-reference is only created for entries that are not yet "fixed".
"IX",2006.575,2006.575,"D",.1,5,0)
This cross-reference is only created for entries that result from
"IX",2006.575,2006.575,"D",.1,6,0)
Consults.
"IX",2006.575,2006.575,"D",1)
S ^MAGD(2006.575,"D",X(1),DA)=""
"IX",2006.575,2006.575,"D",1.4)
I 'X(3),X(2)="CON"
"IX",2006.575,2006.575,"D",2)
K ^MAGD(2006.575,"D",X(1),DA)
"IX",2006.575,2006.575,"D",2.5)
K ^MAGD(2006.575,"D")
"IX",2006.575,2006.575,"D",11.1,0)
^.114IA^3^3
"IX",2006.575,2006.575,"D",11.1,1,0)
1^F^2006.575^2^^1^F
"IX",2006.575,2006.575,"D",11.1,1,3)

"IX",2006.575,2006.575,"D",11.1,2,0)
2^F^2006.575^32^^^F
"IX",2006.575,2006.575,"D",11.1,2,3)

"IX",2006.575,2006.575,"D",11.1,3,0)
3^F^2006.575^16^^^F
"IX",2006.575,2006.575,"D",11.1,3,3)

"IX",2006.587,2006.587,"C",0)
2006.587^C^Services per Gateway^R^^R^IR^I^2006.587^^^^^LS
"IX",2006.587,2006.587,"C",.1,0)
^^6^6^3030514^
"IX",2006.587,2006.587,"C",.1,1,0)
This cross-reference keeps track of which services are accessed
"IX",2006.587,2006.587,"C",.1,2,0)
from which DICOM Gateway:
"IX",2006.587,2006.587,"C",.1,3,0)
  Service Name
"IX",2006.587,2006.587,"C",.1,4,0)
    Gateway Location
"IX",2006.587,2006.587,"C",.1,5,0)
      Gateway System Title
"IX",2006.587,2006.587,"C",.1,6,0)
e
"IX",2006.587,2006.587,"C",1)
S ^MAG(2006.587,"C",X(1),X(2),X(3),DA)=""
"IX",2006.587,2006.587,"C",2)
K ^MAG(2006.587,"C",X(1),X(2),X(3),DA)
"IX",2006.587,2006.587,"C",2.5)
K ^MAG(2006.587,"C")
"IX",2006.587,2006.587,"C",11.1,0)
^.114IA^3^3
"IX",2006.587,2006.587,"C",11.1,1,0)
1^F^2006.587^.01^^1^F
"IX",2006.587,2006.587,"C",11.1,1,3)

"IX",2006.587,2006.587,"C",11.1,2,0)
2^F^2006.587^5^^2^F
"IX",2006.587,2006.587,"C",11.1,2,3)

"IX",2006.587,2006.587,"C",11.1,3,0)
3^F^2006.587^7^^3^F
"IX",2006.587,2006.587,"C",11.1,3,3)

"IX",2006.587,2006.587,"D",0)
2006.587^D^Gateway per location^R^^R^IR^I^2006.587^^^^^LS
"IX",2006.587,2006.587,"D",.1,0)
^^4^4^3030514^
"IX",2006.587,2006.587,"D",.1,1,0)
This cross reference keeps track of which DICOM Gateway is located
"IX",2006.587,2006.587,"D",.1,2,0)
at which location:
"IX",2006.587,2006.587,"D",.1,3,0)
    Gateway System Title
"IX",2006.587,2006.587,"D",.1,4,0)
      Gateway Location
"IX",2006.587,2006.587,"D",1)
S ^MAG(2006.587,"D",X(1),X(2),DA)=""
"IX",2006.587,2006.587,"D",2)
K ^MAG(2006.587,"D",X(1),X(2),DA)
"IX",2006.587,2006.587,"D",2.5)
K ^MAG(2006.587,"D")
"IX",2006.587,2006.587,"D",11.1,0)
^.114IA^2^2
"IX",2006.587,2006.587,"D",11.1,1,0)
1^F^2006.587^5^^1^F
"IX",2006.587,2006.587,"D",11.1,1,3)

"IX",2006.587,2006.587,"D",11.1,2,0)
2^F^2006.587^7^^2^F
"IX",2006.587,2006.587,"D",11.1,2,3)

"KRN",19,123457,-1)
0^1
"KRN",19,123457,0)
MAG DICOM CORRECT VALIDATE^Validate DICOM Correct Information^^R^^^^^^^^
"KRN",19,123457,1,0)
^^3^3^3041203^
"KRN",19,123457,1,1,0)
This menu option invokes the program that validates
"KRN",19,123457,1,2,0)
(and, if necessary, corrects) the table that describes
"KRN",19,123457,1,3,0)
all images that are waiting for corrections to be applied.
"KRN",19,123457,25)
MENU^MAGDLBV
"KRN",19,123457,"U")
VALIDATE DICOM CORRECT INFORMA
"KRN",19,123458,-1)
0^2
"KRN",19,123458,0)
MAG DICOM QUERY RETRIEVE^DICOM Query/Retrieve^^B^^^^^^^^
"KRN",19,123458,1,0)
^^3^3^3041214^
"KRN",19,123458,1,1,0)
This menu option exists for the RPC Broker to establish
"KRN",19,123458,1,2,0)
an environment that grants a user access to the RPC subroutines
"KRN",19,123458,1,3,0)
that support DICOM Query/Retrieve.
"KRN",19,123458,"RPC",0)
^19.05P^2^2
"KRN",19,123458,"RPC",1,0)
MAG CFIND QUERY
"KRN",19,123458,"RPC",2,0)
MAG STUDY UID QUERY
"KRN",19,123458,"U")
DICOM QUERY/RETRIEVE
"KRN",19,123459,-1)
2^3
"KRN",19,123459,0)
MAGD DICOM MENU^Dicom Menu Options^^M^412^^^^^^^
"KRN",19,123459,10,0)
^19.01IP^6^6
"KRN",19,123459,10,6,0)
11227
"KRN",19,123459,10,6,"^")
MAG DICOM CORRECT VALIDATE
"KRN",19,123459,"U")
DICOM MENU OPTIONS
"KRN",19,123460,-1)
1^4
"KRN",19,123460,0)
MAGD DICOM ROUTINE UPLOAD
"KRN",8994,123461,-1)
0^1
"KRN",8994,123461,0)
MAG CFIND QUERY^FIND^MAGDQR01^2^R^0^^0^3
"KRN",8994,123461,1,0)
^8994.01^24^24^3021002^^
"KRN",8994,123461,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123461,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123461,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123461,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123461,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123461,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123461,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123461,1,8,0)
 |                                                               |
"KRN",8994,123461,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123461,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123461,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123461,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123461,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123461,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123461,1,15,0)
 
"KRN",8994,123461,1,16,0)
This RPC performs a DICOM C-FIND request.
"KRN",8994,123461,1,17,0)
 
"KRN",8994,123461,1,18,0)
A request is executed through a TaskMan process,
"KRN",8994,123461,1,19,0)
which stores the results in temporary storage (^MAGDQR(2006.5732)).
"KRN",8994,123461,1,20,0)
 
"KRN",8994,123461,1,21,0)
Subsequent calls to this same RPC will retrieve the
"KRN",8994,123461,1,22,0)
results from the result-set to the client.
"KRN",8994,123461,1,23,0)
 
"KRN",8994,123461,1,24,0)
A final call to this RPC will clean up the temporary storage.
"KRN",8994,123461,2,0)
^8994.02A^4^4
"KRN",8994,123461,2,1,0)
TAGS^2^32000^1^1
"KRN",8994,123461,2,1,1,0)
^^9^9^3041201^
"KRN",8994,123461,2,1,1,1,0)
This parameter is an array. Each element in this array
"KRN",8994,123461,2,1,1,2,0)
has a value that looks like:
"KRN",8994,123461,2,1,1,3,0)
 tag | VR | flag | value
"KRN",8994,123461,2,1,1,4,0)
 
"KRN",8994,123461,2,1,1,5,0)
Each 'tag' is a DICOM tag (two groups of 4 hexadecimal
"KRN",8994,123461,2,1,1,6,0)
digits, separated by a comma).
"KRN",8994,123461,2,1,1,7,0)
 
"KRN",8994,123461,2,1,1,8,0)
When the value is non-empty, it will be used as a search
"KRN",8994,123461,2,1,1,9,0)
criterion in the actual C-Find processing.
"KRN",8994,123461,2,2,0)
RESULT^1^20^1^2
"KRN",8994,123461,2,2,1,0)
^^6^6^3041201^
"KRN",8994,123461,2,2,1,1,0)
The value of this parameter is an integer number that
"KRN",8994,123461,2,2,1,2,0)
identifies a Result-Set.
"KRN",8994,123461,2,2,1,3,0)
 
"KRN",8994,123461,2,2,1,4,0)
The value of this parameter is either 0 (when a new
"KRN",8994,123461,2,2,1,5,0)
result-set is to be created) or equal to the internal
"KRN",8994,123461,2,2,1,6,0)
entry number of an existing result-set.
"KRN",8994,123461,2,3,0)
OFFSET^1^20^1^3
"KRN",8994,123461,2,3,1,0)
^^14^14^3041201^
"KRN",8994,123461,2,3,1,1,0)
The value of this parameter is an integer number.
"KRN",8994,123461,2,3,1,2,0)
When the value of this number is equal to 0,
"KRN",8994,123461,2,3,1,3,0)
the RPC will either create a new result-set,
"KRN",8994,123461,2,3,1,4,0)
(when the value of RESULT is also equal to 0),
"KRN",8994,123461,2,3,1,5,0)
or else check whether TaskMan has finished building
"KRN",8994,123461,2,3,1,6,0)
the result-set, and if so, return the first batch of
"KRN",8994,123461,2,3,1,7,0)
results.
"KRN",8994,123461,2,3,1,8,0)
 
"KRN",8994,123461,2,3,1,9,0)
When the value of this number is greater than 0,
"KRN",8994,123461,2,3,1,10,0)
the RPC will return the next batch of results, starting
"KRN",8994,123461,2,3,1,11,0)
from the one indicated by the value of this parameter.
"KRN",8994,123461,2,3,1,12,0)
 
"KRN",8994,123461,2,3,1,13,0)
When the value of this number is less than 0,
"KRN",8994,123461,2,3,1,14,0)
the RPC will clean up the result-set.
"KRN",8994,123461,2,4,0)
MAX^1^10^1^4
"KRN",8994,123461,2,4,1,0)
^8994.021^3^3^3041201^^
"KRN",8994,123461,2,4,1,1,0)
The value of this parameter is an integer number.
"KRN",8994,123461,2,4,1,2,0)
This value indicates the number of results to be returned
"KRN",8994,123461,2,4,1,3,0)
in each call to this RPC.
"KRN",8994,123461,2,"B","MAX",4)

"KRN",8994,123461,2,"B","OFFSET",3)

"KRN",8994,123461,2,"B","RESULT",2)

"KRN",8994,123461,2,"B","TAGS",1)

"KRN",8994,123461,2,"PARAMSEQ",1,1)

"KRN",8994,123461,2,"PARAMSEQ",2,2)

"KRN",8994,123461,2,"PARAMSEQ",3,3)

"KRN",8994,123461,2,"PARAMSEQ",4,4)

"KRN",8994,123461,3,0)
^^11^11^3041201^
"KRN",8994,123461,3,1,0)
The return parameter of this RPC is an array.
"KRN",8994,123461,3,2,0)
 
"KRN",8994,123461,3,3,0)
The first element of this array indicates whether
"KRN",8994,123461,3,4,0)
or not the RPC completed successfully: a positive number
"KRN",8994,123461,3,5,0)
indicates success, a negative number indicates a failure.
"KRN",8994,123461,3,6,0)
A zero value indicates success, but with no further
"KRN",8994,123461,3,7,0)
data to be returned.
"KRN",8994,123461,3,8,0)
 
"KRN",8994,123461,3,9,0)
The rest of the elements in the array contain either
"KRN",8994,123461,3,10,0)
valid data elements (successful completion) or
"KRN",8994,123461,3,11,0)
error messages (failure).
"KRN",8994,123462,-1)
0^2
"KRN",8994,123462,0)
MAG DICOM CHECK MACHINE ID^CHECKID^MAGDRPC1^1^R^0^^0^3
"KRN",8994,123462,1,0)
^8994.01^20^20^3021002^^
"KRN",8994,123462,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123462,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123462,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123462,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123462,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123462,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123462,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123462,1,8,0)
 |                                                               |
"KRN",8994,123462,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123462,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123462,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123462,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123462,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123462,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123462,1,15,0)
 
"KRN",8994,123462,1,16,0)
Each DICOM Gateway has a "Machine ID", which is a single
"KRN",8994,123462,1,17,0)
upper case letter code that uniquely identifies that Gateway.
"KRN",8994,123462,1,18,0)
 
"KRN",8994,123462,1,19,0)
This RPC can be called to check whether a specific
"KRN",8994,123462,1,20,0)
computer can use a specific ID letter and still be uniquely identified.
"KRN",8994,123462,2,0)
^8994.02A^2^2
"KRN",8994,123462,2,1,0)
IDCODE^1^1^1^1
"KRN",8994,123462,2,1,1,0)
^^2^2^3041213^
"KRN",8994,123462,2,1,1,1,0)
The value of this parameter is a single upper case letter code.
"KRN",8994,123462,2,1,1,2,0)
This code is intended to uniquely identify a DICOM Gateway computer.
"KRN",8994,123462,2,2,0)
HOSTNAME^1^31^1^2
"KRN",8994,123462,2,2,1,0)
^^3^3^3041213^
"KRN",8994,123462,2,2,1,1,0)
The value of this parameter is a string. This string is used
"KRN",8994,123462,2,2,1,2,0)
at the host operating system level to uniquely identify a computer
"KRN",8994,123462,2,2,1,3,0)
that is being used as a DICOM Gateway.
"KRN",8994,123462,2,"B","HOSTNAME",2)

"KRN",8994,123462,2,"B","IDCODE",1)

"KRN",8994,123462,2,"PARAMSEQ",1,1)

"KRN",8994,123462,2,"PARAMSEQ",2,2)

"KRN",8994,123462,3,0)
^^9^9^3041213^
"KRN",8994,123462,3,1,0)
The value of the return parameter is a string. When the string
"KRN",8994,123462,3,2,0)
has a negative value, the return value indicates an error.
"KRN",8994,123462,3,3,0)
 
"KRN",8994,123462,3,4,0)
A return value of "1" indicates that the ID letter can be used
"KRN",8994,123462,3,5,0)
uniquely for the specified hostname.
"KRN",8994,123462,3,6,0)
 
"KRN",8994,123462,3,7,0)
A return value >1 indicates that the ID letter is already being
"KRN",8994,123462,3,8,0)
used. The non-numeric part of the return value identifies the
"KRN",8994,123462,3,9,0)
computer(s) that is/are already using the specified ID letter.
"KRN",8994,123463,-1)
0^3
"KRN",8994,123463,0)
MAG DICOM CORRECT VALIDATE^VALIDATE^MAGDLBV^1^R^0^^0^3
"KRN",8994,123463,1,0)
^8994.01^20^20^3050524^
"KRN",8994,123463,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123463,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123463,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123463,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123463,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123463,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123463,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123463,1,8,0)
 |                                                               |
"KRN",8994,123463,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123463,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123463,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123463,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123463,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123463,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123463,1,15,0)
 
"KRN",8994,123463,1,16,0)
This Remote Procedure validates the structure of the table
"KRN",8994,123463,1,17,0)
that contains information about images that are "to be corrected".
"KRN",8994,123463,1,18,0)
 
"KRN",8994,123463,1,19,0)
Any inconsistencies are corrected, any pointers to obsolete
"KRN",8994,123463,1,20,0)
information are removed, all cross-references are rebuilt.
"KRN",8994,123463,2,0)
^8994.02A^1^1
"KRN",8994,123463,2,1,0)
MENU^1^5^0^1
"KRN",8994,123463,2,1,1,0)
^^8^8^3050524^
"KRN",8994,123463,2,1,1,1,0)
The value of this parameter is a numeric value. This value indicates
"KRN",8994,123463,2,1,1,2,0)
whether or not the procedure is called from the VistA menu.
"KRN",8994,123463,2,1,1,3,0)
When called from the menu (the value of this parameter is TRUE),
"KRN",8994,123463,2,1,1,4,0)
status information is displayed interactively as the procedure
"KRN",8994,123463,2,1,1,5,0)
is active.
"KRN",8994,123463,2,1,1,6,0)
When called as a Remote Procedure (the value of this parameter
"KRN",8994,123463,2,1,1,7,0)
is FALSE), only a status code is returned to the client and no
"KRN",8994,123463,2,1,1,8,0)
interactive output is generated.
"KRN",8994,123463,2,"B","MENU",1)

"KRN",8994,123463,2,"PARAMSEQ",1,1)

"KRN",8994,123463,3,0)
^^3^3^3050524^
"KRN",8994,123463,3,1,0)
The value of this parameter is an integer number. This value
"KRN",8994,123463,3,2,0)
indicates the number of valid entries in the "to be corrected"
"KRN",8994,123463,3,3,0)
table.
"KRN",8994,123464,-1)
0^4
"KRN",8994,123464,0)
MAG DICOM UPDATE MACHINE ID^UPDTID^MAGDRPC1^1^R^0^^0^3
"KRN",8994,123464,1,0)
^8994.01^18^18^3021002^^
"KRN",8994,123464,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123464,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123464,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123464,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123464,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123464,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123464,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123464,1,8,0)
 |                                                               |
"KRN",8994,123464,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123464,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123464,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123464,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123464,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123464,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123464,1,15,0)
 
"KRN",8994,123464,1,16,0)
This RPC can be used to register the "Machine ID" of a DICOM
"KRN",8994,123464,1,17,0)
Gateway. A "Machine ID" is a code (single upper case letter)
"KRN",8994,123464,1,18,0)
that uniquely identifies a DICOM Gateway.
"KRN",8994,123464,2,0)
^8994.02A^2^2
"KRN",8994,123464,2,1,0)
IDCODE^1^1^1^1
"KRN",8994,123464,2,1,1,0)
^^2^2^3041213^
"KRN",8994,123464,2,1,1,1,0)
The value of this parameter is a single upper case letter code.
"KRN",8994,123464,2,1,1,2,0)
This code is intended to uniquely identify a DICOM Gateway computer.
"KRN",8994,123464,2,2,0)
HOSTNAME^1^31^1^2
"KRN",8994,123464,2,2,1,0)
^^3^3^3041213^
"KRN",8994,123464,2,2,1,1,0)
The value of this parameter is a string. This string is used
"KRN",8994,123464,2,2,1,2,0)
at the host operating system level to uniquely identify a computer
"KRN",8994,123464,2,2,1,3,0)
that is being used as a DICOM Gateway.
"KRN",8994,123464,2,"B","HOSTNAME",2)

"KRN",8994,123464,2,"B","IDCODE",1)

"KRN",8994,123464,2,"PARAMSEQ",1,1)

"KRN",8994,123464,2,"PARAMSEQ",2,2)

"KRN",8994,123464,3,0)
^^9^9^3041213^
"KRN",8994,123464,3,1,0)
The value of the return parameter is a string. When the string
"KRN",8994,123464,3,2,0)
has a negative value, the return value indicates an error.
"KRN",8994,123464,3,3,0)
 
"KRN",8994,123464,3,4,0)
A return value of "1" indicates that the ID letter can be used
"KRN",8994,123464,3,5,0)
uniquely for the specified hostname.
"KRN",8994,123464,3,6,0)
 
"KRN",8994,123464,3,7,0)
A return value >1 indicates that the ID letter is already being
"KRN",8994,123464,3,8,0)
used. The non-numeric part of the return value identifies the
"KRN",8994,123464,3,9,0)
computer(s) that is/are already using the specified ID letter.
"KRN",8994,123465,-1)
0^5
"KRN",8994,123465,0)
MAG STUDY UID QUERY^STUDY^MAGDQR04^2^R^0^^0^3
"KRN",8994,123465,1,0)
^8994.01^17^17^3021002^^
"KRN",8994,123465,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123465,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123465,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123465,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123465,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123465,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123465,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123465,1,8,0)
 |                                                               |
"KRN",8994,123465,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123465,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123465,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123465,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123465,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123465,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123465,1,15,0)
 
"KRN",8994,123465,1,16,0)
This RPC returns information about the images that were
"KRN",8994,123465,1,17,0)
acquired for a specific study.
"KRN",8994,123465,2,0)
^8994.02A^1^1
"KRN",8994,123465,2,1,0)
UID^1^64^1^1
"KRN",8994,123465,2,1,1,0)
^^6^6^3041202^
"KRN",8994,123465,2,1,1,1,0)
The value of this parameter is a string.
"KRN",8994,123465,2,1,1,2,0)
This string is a DICOM UID (unique identifier) that specifies
"KRN",8994,123465,2,1,1,3,0)
the study for which the image information is to be retrieved.
"KRN",8994,123465,2,1,1,4,0)
 
"KRN",8994,123465,2,1,1,5,0)
A DICOM UID is a string consisting of only digits and periods,
"KRN",8994,123465,2,1,1,6,0)
and may be up to 64 characters long.
"KRN",8994,123465,2,"B","UID",1)

"KRN",8994,123465,2,"PARAMSEQ",1,1)

"KRN",8994,123465,3,0)
^^9^9^3041202^
"KRN",8994,123465,3,1,0)
The return parameter of this RPC is an array.
"KRN",8994,123465,3,2,0)
The first element indicates success or failure:
"KRN",8994,123465,3,3,0)
a negative value indicates an error status,
"KRN",8994,123465,3,4,0)
a non-negative value indicates the number of images
"KRN",8994,123465,3,5,0)
found for the specified Study UID.
"KRN",8994,123465,3,6,0)
 
"KRN",8994,123465,3,7,0)
The other elements of the output array all have the
"KRN",8994,123465,3,8,0)
following format:
"KRN",8994,123465,3,9,0)
  image# ^ filename ^ username ^ password (encrypted)
"KRN",8994,123466,-1)
0^6
"KRN",8994,123466,0)
MAG VISTA CHECKSUMS^GATEWAY^MAGVCHK^1^R^0^^0^3
"KRN",8994,123466,1,0)
^8994.01^18^18^3050224^
"KRN",8994,123466,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123466,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123466,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123466,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123466,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123466,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123466,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123466,1,8,0)
 |                                                               |
"KRN",8994,123466,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123466,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123466,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123466,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123466,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123466,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123466,1,15,0)
 
"KRN",8994,123466,1,16,0)
This RPC queues up a TaskMan task that calculates the checksums
"KRN",8994,123466,1,17,0)
of all Imaging routines and that e-mails the result to the
"KRN",8994,123466,1,18,0)
central database in Silver Spring.
"KRN",8994,123466,2,0)
^8994.02A^1^1
"KRN",8994,123466,2,1,0)
MAGDBB^1^100^1^1
"KRN",8994,123466,2,1,1,0)
^^3^3^3050224^
"KRN",8994,123466,2,1,1,1,0)
The value of this paramater is a string. This string is the
"KRN",8994,123466,2,1,1,2,0)
e-mail address for the mailgroup in MailMan to which the
"KRN",8994,123466,2,1,1,3,0)
message with the checksums is to be sent.
"KRN",8994,123466,2,"B","MAGDBB",1)

"KRN",8994,123466,2,"PARAMSEQ",1,1)

"KRN",8994,123466,3,0)
^^5^5^3050224^
"KRN",8994,123466,3,1,0)
The value of this parameter is an integer number.
"KRN",8994,123466,3,2,0)
When the value is 0, the remote procedure was not able to queue
"KRN",8994,123466,3,3,0)
up a TaskMan task.
"KRN",8994,123466,3,4,0)
When the value is greater than 0, the value corresponds to
"KRN",8994,123466,3,5,0)
the internal entry number of the task that was created.
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging Release History
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020328^3020328^.5
"PKG",454,22,1,"PAH",1,0)
51^3050826^.5
"PKG",454,22,1,"PAH",1,1,0)
^9.49011^54^54^3050826
"PKG",454,22,1,"PAH",1,1,1,0)
Routines for Patch 51, Test Build 22.
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
MAG7UP      value = 11177267
"PKG",454,22,1,"PAH",1,1,5,0)
MAGBRTE3    value = 5833319
"PKG",454,22,1,"PAH",1,1,6,0)
MAGBRTE4    value = 15295929
"PKG",454,22,1,"PAH",1,1,7,0)
MAGBRTE5    value = 10025015
"PKG",454,22,1,"PAH",1,1,8,0)
MAGBRTK     value = 7162000
"PKG",454,22,1,"PAH",1,1,9,0)
MAGBRTLD    value = 7191644
"PKG",454,22,1,"PAH",1,1,10,0)
MAGBRTUT    value = 6881357
"PKG",454,22,1,"PAH",1,1,11,0)
MAGDCCSS    value = 7813577
"PKG",454,22,1,"PAH",1,1,12,0)
MAGDFB      value = 2735520
"PKG",454,22,1,"PAH",1,1,13,0)
MAGDFCNV    value = 4468938
"PKG",454,22,1,"PAH",1,1,14,0)
MAGDGL      value = 8800264
"PKG",454,22,1,"PAH",1,1,15,0)
MAGDGMRC    value = 8586191
"PKG",454,22,1,"PAH",1,1,16,0)
MAGDHWA     value = 13363551
"PKG",454,22,1,"PAH",1,1,17,0)
MAGDHWC     value = 11574745
"PKG",454,22,1,"PAH",1,1,18,0)
MAGDHWS     value = 8385051
"PKG",454,22,1,"PAH",1,1,19,0)
MAGDIR8     value = 4801612
"PKG",454,22,1,"PAH",1,1,20,0)
MAGDIR81    value = 15887244
"PKG",454,22,1,"PAH",1,1,21,0)
MAGDIR82    value = 13699038
"PKG",454,22,1,"PAH",1,1,22,0)
MAGDIR83    value = 8183019
"PKG",454,22,1,"PAH",1,1,23,0)
MAGDIR8A    value = 10596882
"PKG",454,22,1,"PAH",1,1,24,0)
MAGDIR9A    value = 11238086
"PKG",454,22,1,"PAH",1,1,25,0)
MAGDIR9B    value = 6917351
"PKG",454,22,1,"PAH",1,1,26,0)
MAGDIR9E    value = 13785673
"PKG",454,22,1,"PAH",1,1,27,0)
MAGDLB12    value = 8056663
"PKG",454,22,1,"PAH",1,1,28,0)
MAGDLB6     value = 3475437
"PKG",454,22,1,"PAH",1,1,29,0)
MAGDLBAA    value = 6585681
"PKG",454,22,1,"PAH",1,1,30,0)
MAGDLBV     value = 6999551
"PKG",454,22,1,"PAH",1,1,31,0)
MAGDMEDK    value = 3272291
"PKG",454,22,1,"PAH",1,1,32,0)
MAGDMEDL    value = 6755625
"PKG",454,22,1,"PAH",1,1,33,0)
MAGDQR00    value = 2425880
"PKG",454,22,1,"PAH",1,1,34,0)
MAGDQR01    value = 8020820
"PKG",454,22,1,"PAH",1,1,35,0)
MAGDQR02    value = 15665200
"PKG",454,22,1,"PAH",1,1,36,0)
MAGDQR03    value = 9918762
"PKG",454,22,1,"PAH",1,1,37,0)
MAGDQR04    value = 12503040
"PKG",454,22,1,"PAH",1,1,38,0)
MAGDRA2     value = 7860816
"PKG",454,22,1,"PAH",1,1,39,0)
MAGDRCU2    value = 9684614
"PKG",454,22,1,"PAH",1,1,40,0)
MAGDRPC1    value = 11783859
"PKG",454,22,1,"PAH",1,1,41,0)
MAGDRPC2    value = 13189349
"PKG",454,22,1,"PAH",1,1,42,0)
MAGDRPC3    value = 11696591
"PKG",454,22,1,"PAH",1,1,43,0)
MAGDRPC4    value = 16384505
"PKG",454,22,1,"PAH",1,1,44,0)
MAGDRPC5    value = 14689488
"PKG",454,22,1,"PAH",1,1,45,0)
MAGDRPC6    value = 11177465
"PKG",454,22,1,"PAH",1,1,46,0)
MAGDRPC7    value = 8740525
"PKG",454,22,1,"PAH",1,1,47,0)
MAGDRPC8    value = 10596480
"PKG",454,22,1,"PAH",1,1,48,0)
MAGIPS51    value = 9657731
"PKG",454,22,1,"PAH",1,1,49,0)
MAGJEX2     value = 14452837
"PKG",454,22,1,"PAH",1,1,50,0)
MAGUXRF     value = 4648912
"PKG",454,22,1,"PAH",1,1,51,0)
MAGVCHK     value = 7581330
"PKG",454,22,1,"PAH",1,1,52,0)
 
"PKG",454,22,1,"PAH",1,1,53,0)
Please note that routine MAGIPS51 is deleted after the KIDS Build is
"PKG",454,22,1,"PAH",1,1,54,0)
installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
48
"RTN","MAG7UP")
0^1^B34875703
"RTN","MAG7UP",1,0)
MAG7UP ;WOIFO/MLH - Imaging - HL7 - utilities - break out message into a parse tree ; 06/03/2005  12:05
"RTN","MAG7UP",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAG7UP",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7UP",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAG7UP",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAG7UP",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAG7UP",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAG7UP",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAG7UP",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAG7UP",10,0)
 ;; |                                                               |
"RTN","MAG7UP",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAG7UP",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAG7UP",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAG7UP",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAG7UP",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAG7UP",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7UP",17,0)
 ;;
"RTN","MAG7UP",18,0)
 Q
"RTN","MAG7UP",19,0)
 ;
"RTN","MAG7UP",20,0)
PARSE(XMSG,XTREE) ; break the HL7 message lines into a parse tree
"RTN","MAG7UP",21,0)
 ;
"RTN","MAG7UP",22,0)
 ; INPUT:  The single-dimensional array of message lines
"RTN","MAG7UP",23,0)
 ;
"RTN","MAG7UP",24,0)
 ; OUTPUT:  The parse tree, in the structure
"RTN","MAG7UP",25,0)
 ;   @XTREE@(NSEG,0)                    segment name
"RTN","MAG7UP",26,0)
 ;   @XTREE@(NSEG,NFLD,NREP,NCMP,NSCM)  element data
"RTN","MAG7UP",27,0)
 ;   @XTREE@("B",SEGID,NSEG)          null
"RTN","MAG7UP",28,0)
 ;
"RTN","MAG7UP",29,0)
 N I,J,K,L,M,X,Z ; --------------------- scratch vars
"RTN","MAG7UP",30,0)
 N IMSG ; ------------------------------ message array index
"RTN","MAG7UP",31,0)
 N ISUBSEG ; --------------------------- index of continuation data for long segs
"RTN","MAG7UP",32,0)
 N ISUCC ; ----------------------------- successor element index
"RTN","MAG7UP",33,0)
 N FERR ; ------------------------------ error flag
"RTN","MAG7UP",34,0)
 N SEG ; ------------------------------- segment data
"RTN","MAG7UP",35,0)
 N SEGTAG ; ---------------------------- segment ID ("0th" piece)
"RTN","MAG7UP",36,0)
 N UFS,UCS,URS,UEC,USS ;---------------- HL7 delimiters (universal)
"RTN","MAG7UP",37,0)
 N ENC ;-------------------------------- HL7 encoding characters
"RTN","MAG7UP",38,0)
 N UFSESC,UCSESC,URSESC,UECESC,USSESC ;- HL7 escape sequences for delimiters (universal)
"RTN","MAG7UP",39,0)
 N PATTERN ; --------------------------- pattern match for spanned record
"RTN","MAG7UP",40,0)
 N NSEG ; ------------------------------ segment number in the parse tree
"RTN","MAG7UP",41,0)
 N NSEGINPT ; -------------------------- segment number of input HL7 data
"RTN","MAG7UP",42,0)
 N NFLD ; ------------------------------ field number in the segment
"RTN","MAG7UP",43,0)
 N FLD ; ------------------------------- field data
"RTN","MAG7UP",44,0)
 ;
"RTN","MAG7UP",45,0)
 S FERR=0 ; assume no error
"RTN","MAG7UP",46,0)
 S IMSG=""
"RTN","MAG7UP",47,0)
 ;
"RTN","MAG7UP",48,0)
 ; process MSH segment
"RTN","MAG7UP",49,0)
 ; If there's a message problem, return it in an NTE segment.
"RTN","MAG7UP",50,0)
 ;
"RTN","MAG7UP",51,0)
 S IMSG=$O(@XMSG@(IMSG)) ; array sent?
"RTN","MAG7UP",52,0)
 I IMSG="" D  Q FERR ; no
"RTN","MAG7UP",53,0)
 . S FERR=-1
"RTN","MAG7UP",54,0)
 . ; have to use default field separator
"RTN","MAG7UP",55,0)
 . S @XMSG@(0)="NTE|1||"_FERR_";no input array found"
"RTN","MAG7UP",56,0)
 . Q
"RTN","MAG7UP",57,0)
 S SEG=$G(@XMSG@(IMSG)) Q:$E(SEG,1,3)'="MSH" -2 ; an HL7 message?
"RTN","MAG7UP",58,0)
 I $E(SEG,1,3)'="MSH" D  Q FERR ; no
"RTN","MAG7UP",59,0)
 . S FERR=-2
"RTN","MAG7UP",60,0)
 . S ISUCC=$O(@XMSG@(IMSG)) S:'ISUCC ISUCC=IMSG+1
"RTN","MAG7UP",61,0)
 . ; have to use default field separator
"RTN","MAG7UP",62,0)
 . S @XMSG@(IMSG+ISUCC/2)="NTE|1||"_FERR_";invalid HL7 message (1st 3 chars must be MSH)"
"RTN","MAG7UP",63,0)
 . Q
"RTN","MAG7UP",64,0)
 ;
"RTN","MAG7UP",65,0)
 ; set up delimiters and escape sequences
"RTN","MAG7UP",66,0)
 S UFS=$E(SEG,4),@XTREE@(1,1,1,1,1)=UFS
"RTN","MAG7UP",67,0)
 S ENC=$P(SEG,UFS,2),@XTREE@(1,2,1,1,1)=ENC
"RTN","MAG7UP",68,0)
 S UCS=$E(ENC),URS=$E(ENC,2),UEC=$E(ENC,3),USS=$E(ENC,4)
"RTN","MAG7UP",69,0)
 S UFSESC=UEC_"F"_UEC,UCSESC=UEC_"S"_UEC,URSESC=UEC_"S"_UEC,UECESC=UEC_"E"_UEC,USSESC=UEC_"T"_UEC
"RTN","MAG7UP",70,0)
 S PATTERN="1A2AN1"""_UFS_""""
"RTN","MAG7UP",71,0)
 S @XTREE@(1,0)="MSH",@XTREE@("B","MSH",1)=""
"RTN","MAG7UP",72,0)
 F NFLD=3:1:$L(SEG,UFS) S FLD=$P(SEG,UFS,NFLD) D
"RTN","MAG7UP",73,0)
 . I FLD]"" D PROCFLD(XTREE,1,NFLD,FLD)
"RTN","MAG7UP",74,0)
 . Q
"RTN","MAG7UP",75,0)
 ; process the remaining segments
"RTN","MAG7UP",76,0)
 S SEG="" ; SEG will be a concatenated series of spanned records
"RTN","MAG7UP",77,0)
 S NSEG=2 ; next segment in the parse tree will be #2
"RTN","MAG7UP",78,0)
 F NSEGINPT=2:1 S IMSG=$O(@XMSG@(IMSG)) Q:IMSG=""  D  Q:FERR
"RTN","MAG7UP",79,0)
 . S SEG=$G(@XMSG@(IMSG)) Q:SEG=""
"RTN","MAG7UP",80,0)
 . S ISUBSEG="" ; prepare to handle very long HL7 segments (up to 32K)
"RTN","MAG7UP",81,0)
 . F  S ISUBSEG=$O(@XMSG@(IMSG,ISUBSEG)) Q:ISUBSEG=""  D
"RTN","MAG7UP",82,0)
 . . S SEG=SEG_$G(@XMSG@(IMSG,ISUBSEG))
"RTN","MAG7UP",83,0)
 . . Q
"RTN","MAG7UP",84,0)
 . S SEGTAG=$P(SEG,UFS) I SEGTAG'?1U2.3UN S FERR=-3 Q
"RTN","MAG7UP",85,0)
 . S @XTREE@(NSEG,0)=SEGTAG,@XTREE@("B",SEGTAG,NSEG)=""
"RTN","MAG7UP",86,0)
 . F NFLD=2:1:$L(SEG,UFS) D
"RTN","MAG7UP",87,0)
 . . S FLD=$P(SEG,UFS,NFLD)
"RTN","MAG7UP",88,0)
 . . I FLD]"" D PROCFLD(XTREE,NSEG,NFLD-1,FLD)
"RTN","MAG7UP",89,0)
 . . Q
"RTN","MAG7UP",90,0)
 . S SEG="" ; reinitialize SEG for the next possible concatenation
"RTN","MAG7UP",91,0)
 . S NSEG=NSEG+1 ; increment counter for next segment in the parse tree
"RTN","MAG7UP",92,0)
 . Q
"RTN","MAG7UP",93,0)
 Q FERR
"RTN","MAG7UP",94,0)
 ;
"RTN","MAG7UP",95,0)
PROCFLD(XTREE,XNSEG,XNFLD,XFLD) ; process a field
"RTN","MAG7UP",96,0)
 ;
"RTN","MAG7UP",97,0)
 ; input:  XTREE   name of MUMPS array for parse tree ($NA format)
"RTN","MAG7UP",98,0)
 ;         XNSEG   segment number for parse tree
"RTN","MAG7UP",99,0)
 ;         XNFLD   field number for parse tree
"RTN","MAG7UP",100,0)
 ;         XFLD    field data
"RTN","MAG7UP",101,0)
 ;
"RTN","MAG7UP",102,0)
 N SG ; ------ segment name
"RTN","MAG7UP",103,0)
 N NREP ; ---- repetition (occurrence) number
"RTN","MAG7UP",104,0)
 N REP ; ----- repetition data
"RTN","MAG7UP",105,0)
 N NCMP ; ---- component number
"RTN","MAG7UP",106,0)
 N CMP ; ----- component data
"RTN","MAG7UP",107,0)
 N NSCM ; ---- subcomponent number
"RTN","MAG7UP",108,0)
 N SCM ; ----- subcomponent data
"RTN","MAG7UP",109,0)
 ;
"RTN","MAG7UP",110,0)
 S SG=@XTREE@(XNSEG,0)
"RTN","MAG7UP",111,0)
 ; Per DICOM meeting 2004-02-24, reaffirmed that data may need to be
"RTN","MAG7UP",112,0)
 ; retrieved above the subcomponent level, and that those data will
"RTN","MAG7UP",113,0)
 ; need to be de-escaped because the receiving application won't have
"RTN","MAG7UP",114,0)
 ; access to the delimiters from the original message.
"RTN","MAG7UP",115,0)
 S @XTREE@(XNSEG,XNFLD)=$$DEESC(XFLD)
"RTN","MAG7UP",116,0)
 ;
"RTN","MAG7UP",117,0)
 ; Break out to the lowest delimiter level too.  This is not strictly an
"RTN","MAG7UP",118,0)
 ; HL7 parse because it does not take actual HL7 (or realm constraining)
"RTN","MAG7UP",119,0)
 ; data types into account.
"RTN","MAG7UP",120,0)
 ;
"RTN","MAG7UP",121,0)
 F NREP=1:1:$L(XFLD,URS) S REP=$P(XFLD,URS,NREP) I REP]"" D
"RTN","MAG7UP",122,0)
 . F NCMP=1:1:$L(REP,UCS) S CMP=$P(REP,UCS,NCMP) I CMP]"" D
"RTN","MAG7UP",123,0)
 . . ; Per DICOM meeting 2004-02-24, reaffirmed that data may need to be
"RTN","MAG7UP",124,0)
 . . ; retrieved above the subcomponent level, and that those data will
"RTN","MAG7UP",125,0)
 . . ; need to be de-escaped because the receiving application won't have
"RTN","MAG7UP",126,0)
 . . ; access to the delimiters from the original message.
"RTN","MAG7UP",127,0)
 . . S @XTREE@(XNSEG,XNFLD,NREP,NCMP)=$$DEESC(CMP)
"RTN","MAG7UP",128,0)
 . . F NSCM=1:1:$L(CMP,USS) S SCM=$P(CMP,USS,NSCM) I SCM]"" D
"RTN","MAG7UP",129,0)
 . . . S @XTREE@(XNSEG,XNFLD,NREP,NCMP,NSCM)=$$DEESC(SCM)
"RTN","MAG7UP",130,0)
 . . . Q
"RTN","MAG7UP",131,0)
 . . Q
"RTN","MAG7UP",132,0)
 . Q
"RTN","MAG7UP",133,0)
 Q
"RTN","MAG7UP",134,0)
 ;
"RTN","MAG7UP",135,0)
DEESC(XSCM) ; replace escape sequences with delimiter characters
"RTN","MAG7UP",136,0)
 ;
"RTN","MAG7UP",137,0)
 ; input:  XSCM   element data before replacement
"RTN","MAG7UP",138,0)
 ;
"RTN","MAG7UP",139,0)
 ; expects:  UFSESC, UCSESC, URSESC, UECESC, USSESC
"RTN","MAG7UP",140,0)
 ;                delimiter escape sequences
"RTN","MAG7UP",141,0)
 ;
"RTN","MAG7UP",142,0)
 ; function return:  element data after replacement
"RTN","MAG7UP",143,0)
 ;
"RTN","MAG7UP",144,0)
 N HIT ; need another pass after each hit
"RTN","MAG7UP",145,0)
 F  D  Q:'$D(HIT)
"RTN","MAG7UP",146,0)
 . K HIT
"RTN","MAG7UP",147,0)
 . I XSCM[UFSESC S XSCM=$P(XSCM,UFSESC)_UFS_$P(XSCM,UFSESC,2,99999),HIT=1
"RTN","MAG7UP",148,0)
 . I XSCM[UCSESC S XSCM=$P(XSCM,UCSESC)_UCS_$P(XSCM,UCSESC,2,99999),HIT=1
"RTN","MAG7UP",149,0)
 . I XSCM[URSESC S XSCM=$P(XSCM,URSESC)_URS_$P(XSCM,URSESC,2,99999),HIT=1
"RTN","MAG7UP",150,0)
 . I XSCM[UECESC S XSCM=$P(XSCM,UECESC)_UEC_$P(XSCM,UECESC,2,99999),HIT=1
"RTN","MAG7UP",151,0)
 . I XSCM[USSESC S XSCM=$P(XSCM,USSESC)_USS_$P(XSCM,USSESC,2,99999),HIT=1
"RTN","MAG7UP",152,0)
 . Q
"RTN","MAG7UP",153,0)
 Q $E(XSCM,1,510)
"RTN","MAG7UP",154,0)
 ;
"RTN","MAGBRTE3")
0^2^B17206043
"RTN","MAGBRTE3",1,0)
MAGBRTE3 ;WOIFO/EdM - Find value of variable ; 08/26/2005  07:46
"RTN","MAGBRTE3",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGBRTE3",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE3",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTE3",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTE3",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTE3",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTE3",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTE3",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTE3",10,0)
 ;; |                                                               |
"RTN","MAGBRTE3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTE3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTE3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTE3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTE3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTE3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE3",17,0)
 ;;
"RTN","MAGBRTE3",18,0)
 Q
"RTN","MAGBRTE3",19,0)
 ;
"RTN","MAGBRTE3",20,0)
 ; The subroutines in this routine calculate the values for
"RTN","MAGBRTE3",21,0)
 ; certain variables that may be needed for the "routing rule processor"
"RTN","MAGBRTE3",22,0)
 ;
"RTN","MAGBRTE3",23,0)
 ; Entry DICOM is the generic value finder that looks for values
"RTN","MAGBRTE3",24,0)
 ; in the data structure that describes an image file.
"RTN","MAGBRTE3",25,0)
 ; The other entries deal with other (computed) values.
"RTN","MAGBRTE3",26,0)
 ;
"RTN","MAGBRTE3",27,0)
 ; The value is always returned in output parameter VAL.
"RTN","MAGBRTE3",28,0)
 ; Note that this variable needs to be an output parameter,
"RTN","MAGBRTE3",29,0)
 ; because in some cases an "undefined value" needs to be returned,
"RTN","MAGBRTE3",30,0)
 ; and in some cases, multiple values may need to be returned.
"RTN","MAGBRTE3",31,0)
 ;
"RTN","MAGBRTE3",32,0)
DICOM(NAME,TYPE,VAL) N C,I,N,X
"RTN","MAGBRTE3",33,0)
 ;
"RTN","MAGBRTE3",34,0)
 ; Arbitrary decision: the routine stops when the first occurrence
"RTN","MAGBRTE3",35,0)
 ; of a value is found.
"RTN","MAGBRTE3",36,0)
 ; Should we continue until we find all codes that have values?
"RTN","MAGBRTE3",37,0)
 ;
"RTN","MAGBRTE3",38,0)
 S C="" F  S C=$O(KEYWORD("CONDITION",NAME,C)) Q:C=""  D  Q:$D(VAL)
"RTN","MAGBRTE3",39,0)
 . Q:'$D(^TMP("MAG",$J,"DICOM",TYPE,C))
"RTN","MAGBRTE3",40,0)
 . S (I,N)=0 F  S N=$O(^TMP("MAG",$J,"DICOM",TYPE,C,N)) Q:N=""  D
"RTN","MAGBRTE3",41,0)
 . . S X=$G(^TMP("MAG",$J,"DICOM",TYPE,C,N,1),"<unknown>") Q:X="<unknown>"
"RTN","MAGBRTE3",42,0)
 . . S I=I+1,N(I)=X
"RTN","MAGBRTE3",43,0)
 . . Q
"RTN","MAGBRTE3",44,0)
 . Q:'I
"RTN","MAGBRTE3",45,0)
 . I I=1 S VAL=N(1) Q
"RTN","MAGBRTE3",46,0)
 . F N=1:1:I S VAL(N)=N(N)
"RTN","MAGBRTE3",47,0)
 . Q
"RTN","MAGBRTE3",48,0)
 Q
"RTN","MAGBRTE3",49,0)
 ;
"RTN","MAGBRTE3",50,0)
NOW(VAL) N %,DISYS,X
"RTN","MAGBRTE3",51,0)
 D DT^DICRW
"RTN","MAGBRTE3",52,0)
 S VAL=$P("THU FRI SAT SUN MON TUE WED"," ",$H#7+1)_" "_%
"RTN","MAGBRTE3",53,0)
 Q
"RTN","MAGBRTE3",54,0)
 ;
"RTN","MAGBRTE3",55,0)
SOURCE(IMAGE,VAL) N X
"RTN","MAGBRTE3",56,0)
 S X=$P($G(^MAG(2005,IMAGE,100)),"^",3)
"RTN","MAGBRTE3",57,0)
 S:'X X=$G(DUZ(2))
"RTN","MAGBRTE3",58,0)
 S:'X X=$$KSP^XUPARAM("INST")
"RTN","MAGBRTE3",59,0)
 S VAL=$$GET1^DIQ(4,+X,.01)
"RTN","MAGBRTE3",60,0)
 Q
"RTN","MAGBRTE3",61,0)
 ;
"RTN","MAGBRTE3",62,0)
MAG(IMAGE,TYPE,NODE,PIECE,VAL) N D0,D1,PARENT,X
"RTN","MAGBRTE3",63,0)
 ; First look in the image itself,
"RTN","MAGBRTE3",64,0)
 ; then in its parent (if any)
"RTN","MAGBRTE3",65,0)
 ; then in any siblings.
"RTN","MAGBRTE3",66,0)
 ; Return the first value found.
"RTN","MAGBRTE3",67,0)
 ;
"RTN","MAGBRTE3",68,0)
 K VAL
"RTN","MAGBRTE3",69,0)
 S X=$P($G(^MAG(2005,IMAGE,NODE)),"^",PIECE) I X'="" S VAL=X D:$D(VAL) MAGX Q
"RTN","MAGBRTE3",70,0)
 ;
"RTN","MAGBRTE3",71,0)
 S PARENT=$P($G(^MAG(2005,IMAGE,0)),"^",10) Q:PARENT=""
"RTN","MAGBRTE3",72,0)
 S X=$P($G(^MAG(2005,PARENT,NODE)),"^",PIECE) I X'="" S VAL=X D:$D(VAL) MAGX Q
"RTN","MAGBRTE3",73,0)
 ;
"RTN","MAGBRTE3",74,0)
 S D1=0 F  S D1=$O(^MAG(2005,IMAGE,1,D1)) Q:'D1  D  Q:$D(VAL)
"RTN","MAGBRTE3",75,0)
 . S D0=$G(^MAG(2005,IMAGE,1,D1,1)) Q:'D0
"RTN","MAGBRTE3",76,0)
 . S X=$P($G(^MAG(2005,D0,NODE)),"^",PIECE) I X'="" S VAL=X Q
"RTN","MAGBRTE3",77,0)
 . Q
"RTN","MAGBRTE3",78,0)
 D:$D(VAL) MAGX
"RTN","MAGBRTE3",79,0)
 Q
"RTN","MAGBRTE3",80,0)
 ;
"RTN","MAGBRTE3",81,0)
MAGX I TYPE=0 Q
"RTN","MAGBRTE3",82,0)
 I (TYPE=2005.02)!(TYPE=2005.03)!(TYPE=2005.81)!(TYPE=2005.2) D  Q
"RTN","MAGBRTE3",83,0)
 . S X=$P($G(^MAG(TYPE,+VAL,0)),"^",1) K VAL S:X'="" VAL=X
"RTN","MAGBRTE3",84,0)
 . Q
"RTN","MAGBRTE3",85,0)
 I TYPE=2 D  Q
"RTN","MAGBRTE3",86,0)
 . S X=$P($G(^DPT(+VAL,0)),"^",1) K VAL S:X'="" VAL=X ; IA 10035
"RTN","MAGBRTE3",87,0)
 . Q
"RTN","MAGBRTE3",88,0)
 I TYPE=200 D  Q
"RTN","MAGBRTE3",89,0)
 . S X=$$GET1^DIQ(200,+VAL,.01) K VAL S:X'="" VAL=X ; IA 10060
"RTN","MAGBRTE3",90,0)
 . Q
"RTN","MAGBRTE3",91,0)
 I TYPE=44 D  Q
"RTN","MAGBRTE3",92,0)
 . S X=$P($G(^SC(+VAL,0)),"^",1) K VAL S:X'="" VAL=X ; IA 10040
"RTN","MAGBRTE3",93,0)
 . Q
"RTN","MAGBRTE3",94,0)
 I TYPE=71 D  Q
"RTN","MAGBRTE3",95,0)
 . S X=$P($G(^RAMIS(71,+VAL,0)),"^",1) K VAL S:X'="" VAL=X ; IA 1174
"RTN","MAGBRTE3",96,0)
 . Q
"RTN","MAGBRTE3",97,0)
 I TYPE=74 D  Q
"RTN","MAGBRTE3",98,0)
 . S X=$P($G(^RARPT(+VAL,0)),"^",1) K VAL S:X'="" VAL=X ; IA 1171
"RTN","MAGBRTE3",99,0)
 . Q
"RTN","MAGBRTE3",100,0)
 Q
"RTN","MAGBRTE3",101,0)
 ;
"RTN","MAGBRTE3",102,0)
DATE(IMAGE,TYPE,NODE,PIECE,WHEN,VAL) N D0,D1,FIRST,LAST,PARENT,X
"RTN","MAGBRTE3",103,0)
 ; First look in the image itself,
"RTN","MAGBRTE3",104,0)
 ; then in its parent (if any)
"RTN","MAGBRTE3",105,0)
 ; then in any siblings.
"RTN","MAGBRTE3",106,0)
 ; Return the first value found.
"RTN","MAGBRTE3",107,0)
 ;
"RTN","MAGBRTE3",108,0)
 K VAL
"RTN","MAGBRTE3",109,0)
 I WHEN=0 D MAG(IMAGE,TYPE,NODE,PIECE,.VAL) Q
"RTN","MAGBRTE3",110,0)
 ;
"RTN","MAGBRTE3",111,0)
 S X=$P($G(^MAG(2005,IMAGE,NODE)),"^",PIECE) I X'="" S X(X)=""
"RTN","MAGBRTE3",112,0)
 ;
"RTN","MAGBRTE3",113,0)
 S PARENT=$P($G(^MAG(2005,IMAGE,0)),"^",10) Q:PARENT=""
"RTN","MAGBRTE3",114,0)
 S X=$P($G(^MAG(2005,PARENT,NODE)),"^",PIECE) I X'="" S X(X)=""
"RTN","MAGBRTE3",115,0)
 ;
"RTN","MAGBRTE3",116,0)
 S D1=0 F  S D1=$O(^MAG(2005,IMAGE,1,D1)) Q:'D1  D
"RTN","MAGBRTE3",117,0)
 . S D0=$G(^MAG(2005,IMAGE,1,D1,1)) Q:'D0
"RTN","MAGBRTE3",118,0)
 . S X=$P($G(^MAG(2005,D0,NODE)),"^",PIECE) I X'="" S X(X)=""
"RTN","MAGBRTE3",119,0)
 . Q
"RTN","MAGBRTE3",120,0)
 ;
"RTN","MAGBRTE3",121,0)
 I WHEN=1 S VAL=$O(X(""),+1)
"RTN","MAGBRTE3",122,0)
 I WHEN=2 S VAL=$O(X(""),-1)
"RTN","MAGBRTE3",123,0)
 K:VAL="" VAL
"RTN","MAGBRTE3",124,0)
 Q
"RTN","MAGBRTE3",125,0)
 ;
"RTN","MAGBRTE3",126,0)
URGENCY(IMAGE,VAL) N P
"RTN","MAGBRTE3",127,0)
 S P=$$PRI^MAGBRTE4("NORMAL",IMAGE)
"RTN","MAGBRTE3",128,0)
 S VAL=$S(P=500:"ROUTINE",P=510:"URGENT",P=520:"STAT",1:P)
"RTN","MAGBRTE3",129,0)
 Q
"RTN","MAGBRTE3",130,0)
 ;
"RTN","MAGBRTE4")
0^3^B79623233
"RTN","MAGBRTE4",1,0)
MAGBRTE4 ;WOIFO/EdM - Process Routing Rule Evaluation Queue ; 08/26/2005  07:46
"RTN","MAGBRTE4",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGBRTE4",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE4",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTE4",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTE4",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTE4",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTE4",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTE4",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTE4",10,0)
 ;; |                                                               |
"RTN","MAGBRTE4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTE4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTE4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTE4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTE4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTE4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE4",17,0)
 ;;
"RTN","MAGBRTE4",18,0)
 Q
"RTN","MAGBRTE4",19,0)
 ;
"RTN","MAGBRTE4",20,0)
EVAL ;
"RTN","MAGBRTE4",21,0)
 N ACTIVE ;- Switch that controls start/stop queue processor
"RTN","MAGBRTE4",22,0)
 N ANY ;---- Flag: processed any rule
"RTN","MAGBRTE4",23,0)
 N CONS ;--- Switch that indicates whether or not site has "consolidated" code
"RTN","MAGBRTE4",24,0)
 N XMSG ;--- Message counter
"RTN","MAGBRTE4",25,0)
 ;
"RTN","MAGBRTE4",26,0)
 K ^XTMP("MAGEVAL",ZTSK)
"RTN","MAGBRTE4",27,0)
 D LOG("Started at "_$H)
"RTN","MAGBRTE4",28,0)
 S XMSG=1,CONS=$$CONSOLID^MAGBAPI()
"RTN","MAGBRTE4",29,0)
 S PLACE=$S(CONS:$O(^MAG(2006.1,"B",LOCATION,"")),1:1)
"RTN","MAGBRTE4",30,0)
 L +^MAGDICOM(2006.563,1,"EVAL",LOCATION):0 E  D  Q
"RTN","MAGBRTE4",31,0)
 . D LOG("A rule evaluator is already running for "_$$GET1^DIQ(4,LOCATION,.01))
"RTN","MAGBRTE4",32,0)
 . Q
"RTN","MAGBRTE4",33,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=1
"RTN","MAGBRTE4",34,0)
 ;
"RTN","MAGBRTE4",35,0)
 S I="" F  S I=$O(RULES(I)) Q:I=""  D
"RTN","MAGBRTE4",36,0)
 . N D0,D1,D2,L,Q1
"RTN","MAGBRTE4",37,0)
 . S X=RULES(I),D0=$P(X,"^",1),Q1=$P(X,"^",2),L=$L(X,"^")
"RTN","MAGBRTE4",38,0)
 . I L=3 S RULE(D0,Q1)=$P(X,"^",3) Q
"RTN","MAGBRTE4",39,0)
 . I Q1="ACTION" S RULE(D0,Q1,$P(X,"^",3))=$P(X,"^",4,L) Q
"RTN","MAGBRTE4",40,0)
 . I Q1'="CONDITION" D LOG("Rule "_D0_" has a qualifier """_Q1_""".") Q
"RTN","MAGBRTE4",41,0)
 . I L=5 S RULE(D0,Q1,$P(X,"^",3),$P(X,"^",4))=$P(X,"^",5) Q
"RTN","MAGBRTE4",42,0)
 . S RULE(D0,Q1,$P(X,"^",3),$P(X,"^",4),$P(X,"^",6),$P(X,"^",5))=$P(X,"^",7)
"RTN","MAGBRTE4",43,0)
 . Q
"RTN","MAGBRTE4",44,0)
 K RULES
"RTN","MAGBRTE4",45,0)
 ;
"RTN","MAGBRTE4",46,0)
 S ACTIVE=1 F  D  Q:'ACTIVE
"RTN","MAGBRTE4",47,0)
 . S ANY=0
"RTN","MAGBRTE4",48,0)
 . S ACTIVE=+$G(^MAGDICOM(2006.563,1,"EVAL")) I 'ACTIVE D  Q
"RTN","MAGBRTE4",49,0)
 . . D LOG("Stopped at "_$H)
"RTN","MAGBRTE4",50,0)
 . . Q
"RTN","MAGBRTE4",51,0)
 . D
"RTN","MAGBRTE4",52,0)
 . . N IMAGE,QPTR,QPTR2,STATUS,X
"RTN","MAGBRTE4",53,0)
 . . D:'CONS ADD^MAGBAPI(0,"EVAL")
"RTN","MAGBRTE4",54,0)
 . . D:CONS ADD^MAGBAPI(0,"EVAL",PLACE)
"RTN","MAGBRTE4",55,0)
 . . S QPTR2=$O(^MAGQUEUE(2006.031,"B","EVAL",""))
"RTN","MAGBRTE4",56,0)
 . . S QPTR=$S(QPTR2:$P(^MAGQUEUE(2006.031,QPTR2,0),"^",2),1:"")
"RTN","MAGBRTE4",57,0)
 . . ; Get next queue pointer value
"RTN","MAGBRTE4",58,0)
 . . S:'CONS QPTR=$O(^MAGQUEUE(2006.03,"B","EVAL",QPTR))
"RTN","MAGBRTE4",59,0)
 . . S:CONS QPTR=$O(^MAGQUEUE(2006.03,"C",PLACE,"EVAL",QPTR))
"RTN","MAGBRTE4",60,0)
 . . I QPTR="" Q  ; Nothing to do
"RTN","MAGBRTE4",61,0)
 . . ;
"RTN","MAGBRTE4",62,0)
 . . S X=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGBRTE4",63,0)
 . . ; After an error, sometimes the entry is purged,
"RTN","MAGBRTE4",64,0)
 . . ; but the cross reference is still present.
"RTN","MAGBRTE4",65,0)
 . . ; In such a case, remove the cross reference.
"RTN","MAGBRTE4",66,0)
 . . I X="" D  Q
"RTN","MAGBRTE4",67,0)
 . . . K:'CONS ^MAGQUEUE(2006.03,"B","EVAL",QPTR)
"RTN","MAGBRTE4",68,0)
 . . . K:CONS ^MAGQUEUE(2006.03,"C",PLACE,"EVAL",QPTR)
"RTN","MAGBRTE4",69,0)
 . . . Q
"RTN","MAGBRTE4",70,0)
 . . ;
"RTN","MAGBRTE4",71,0)
 . . S IMAGE=$P(X,"^",7),ANY=1
"RTN","MAGBRTE4",72,0)
 . . I IMAGE,$D(^MAG(2005,IMAGE,0)) D
"RTN","MAGBRTE4",73,0)
 . . . S STATUS=$$RULES() Q:STATUS'<0
"RTN","MAGBRTE4",74,0)
 . . . I STATUS["NO NETWORK LOCATION" D  Q
"RTN","MAGBRTE4",75,0)
 . . . . D LOG("Image "_IMAGE_" has no files associated with it")
"RTN","MAGBRTE4",76,0)
 . . . . Q
"RTN","MAGBRTE4",77,0)
 . . . D LOG("*** EVAL queue error: "_STATUS_" ***")
"RTN","MAGBRTE4",78,0)
 . . . Q
"RTN","MAGBRTE4",79,0)
 . . K ^MAGQUEUE(2006.03,QPTR)
"RTN","MAGBRTE4",80,0)
 . . K:'CONS ^MAGQUEUE(2006.03,"B","EVAL",QPTR)
"RTN","MAGBRTE4",81,0)
 . . K:CONS ^MAGQUEUE(2006.03,"C",PLACE,"EVAL",QPTR)
"RTN","MAGBRTE4",82,0)
 . . S $P(^MAGQUEUE(2006.03,0),"^",4)=$P(^MAGQUEUE(2006.03,0),"^",4)-1
"RTN","MAGBRTE4",83,0)
 . . Q
"RTN","MAGBRTE4",84,0)
 . H:'ANY 1
"RTN","MAGBRTE4",85,0)
 . D:'$D(^XTMP("MAGEVAL",ZTSK)) XTINIT^MAGDRPC5,LOG("^XTMP was cleaned up.")
"RTN","MAGBRTE4",86,0)
 . Q
"RTN","MAGBRTE4",87,0)
 L -^MAGDICOM(2006.563,1,"EVAL",LOCATION)
"RTN","MAGBRTE4",88,0)
 Q
"RTN","MAGBRTE4",89,0)
 ;
"RTN","MAGBRTE4",90,0)
LOG(X) N D,H,I,M,T
"RTN","MAGBRTE4",91,0)
 S I=$O(^XTMP("MAGEVAL",ZTSK," "),-1)+1
"RTN","MAGBRTE4",92,0)
 S XMSG=$G(XMSG)+1 S:I>XMSG XMSG=I
"RTN","MAGBRTE4",93,0)
 S D=$P("Thu Fri Sat Sun Mon Tue Wed"," ",$H#7+1)
"RTN","MAGBRTE4",94,0)
 S T=$P($H,",",2),H=T\3600,M=T\60#60 S:H<10 H=0_H S:M<10 M=0_M
"RTN","MAGBRTE4",95,0)
 S ^XTMP("MAGEVAL",ZTSK,XMSG)=D_" "_H_":"_M_" "_X
"RTN","MAGBRTE4",96,0)
 Q
"RTN","MAGBRTE4",97,0)
 ;
"RTN","MAGBRTE4",98,0)
RULES() ; To be called from above
"RTN","MAGBRTE4",99,0)
 ; IMAGE ;---- IEN for image (2005)
"RTN","MAGBRTE4",100,0)
 ; LOCATION ;- Location from which queue entry originates
"RTN","MAGBRTE4",101,0)
 N ACTION ;--- Action to be taken (SEND)
"RTN","MAGBRTE4",102,0)
 N C ;-------- Loop-variable for looping through parameters and conditions
"RTN","MAGBRTE4",103,0)
 N D ;-------- Data type
"RTN","MAGBRTE4",104,0)
 N DS ;------- Data type enclosed in space-characters
"RTN","MAGBRTE4",105,0)
 N F ;-------- ...
"RTN","MAGBRTE4",106,0)
 N METMSG ;--- Message to be issued when rule is evaluated
"RTN","MAGBRTE4",107,0)
 N O ;-------- Operator
"RTN","MAGBRTE4",108,0)
 N OK ;------- Flag: indicates whether or not rule is met
"RTN","MAGBRTE4",109,0)
 N RDT ;------ Current date (don't use DT, process might run over midnight)
"RTN","MAGBRTE4",110,0)
 N V ;-------- Value for property as specified in rule
"RTN","MAGBRTE4",111,0)
 N VAL ;------ Actual value of property
"RTN","MAGBRTE4",112,0)
 N VRS ;------ String of Queue Entry numbers when rule(s) are met
"RTN","MAGBRTE4",113,0)
 N X ;-------- Scratch variable
"RTN","MAGBRTE4",114,0)
 ;
"RTN","MAGBRTE4",115,0)
 S VRS=""
"RTN","MAGBRTE4",116,0)
 ;
"RTN","MAGBRTE4",117,0)
 D KEYWORD^MAGBRTK
"RTN","MAGBRTE4",118,0)
 ;
"RTN","MAGBRTE4",119,0)
 D FILEFIND^MAGDFB(IMAGE,"FULL",0,0,.MAGFILE1)
"RTN","MAGBRTE4",120,0)
 Q:MAGFILE1<0 MAGFILE1
"RTN","MAGBRTE4",121,0)
 ;
"RTN","MAGBRTE4",122,0)
 S RULE=0 F  S RULE=$O(RULE(RULE)) Q:'RULE  D
"RTN","MAGBRTE4",123,0)
 . S METMSG=$G(RULE(RULE,"ACTION"))
"RTN","MAGBRTE4",124,0)
 . S X=" (",C=0 F  S C=$O(RULE(RULE,"ACTION",C)) Q:'C  D
"RTN","MAGBRTE4",125,0)
 . . S METMSG=METMSG_X_$G(RULE(RULE,"ACTION",C)),X=", "
"RTN","MAGBRTE4",126,0)
 . . Q
"RTN","MAGBRTE4",127,0)
 . S:X'=" (" METMSG=METMSG_")"
"RTN","MAGBRTE4",128,0)
 . S:METMSG="" METMSG="Rule #"_RULE
"RTN","MAGBRTE4",129,0)
 . S OK=1,C=0 F  S C=$O(RULE(RULE,"CONDITION",C)) Q:'C  D  Q:'OK
"RTN","MAGBRTE4",130,0)
 . . S F=$G(RULE(RULE,"CONDITION",C,"KW")) Q:F=""
"RTN","MAGBRTE4",131,0)
 . . S X=$G(KEYWORD("CONDITION",F),"^DICOM^MAGBRTE3(F,""OUT"",.VAL)")
"RTN","MAGBRTE4",132,0)
 . . K VAL D @$P(X,"^",2,9)
"RTN","MAGBRTE4",133,0)
 . . ; If the field is not defined, the test passes...
"RTN","MAGBRTE4",134,0)
 . . Q:$D(VAL)'=1  ; We won't deal with multiple values just yet...
"RTN","MAGBRTE4",135,0)
 . . ;
"RTN","MAGBRTE4",136,0)
 . . S V=$G(RULE(RULE,"CONDITION",C,"VA"))
"RTN","MAGBRTE4",137,0)
 . . S D=$G(RULE(RULE,"CONDITION",C,"DT"))
"RTN","MAGBRTE4",138,0)
 . . S O=$G(RULE(RULE,"CONDITION",C,"OP"))
"RTN","MAGBRTE4",139,0)
 . . S:D="" D="S"
"RTN","MAGBRTE4",140,0)
 . . S DS=" "_D_" "
"RTN","MAGBRTE4",141,0)
 . . D:" S CS DS IS LO LT OB OW PN SH ST "[DS
"RTN","MAGBRTE4",142,0)
 . . . N WILD ;-- Wildcard to be matched
"RTN","MAGBRTE4",143,0)
 . . . S WILD=$$WLDMATCH(VAL,V)
"RTN","MAGBRTE4",144,0)
 . . . I O="=",'WILD S OK=0 Q
"RTN","MAGBRTE4",145,0)
 . . . I O="!=",WILD S OK=0 Q
"RTN","MAGBRTE4",146,0)
 . . . Q
"RTN","MAGBRTE4",147,0)
 . . D:" DT DA TM "[DS
"RTN","MAGBRTE4",148,0)
 . . . Q:O'="="  ; Only "within range" comparisons allowed currently
"RTN","MAGBRTE4",149,0)
 . . . ;
"RTN","MAGBRTE4",150,0)
 . . . N A ;--- Flag: indicates whether at least one time-frame matches
"RTN","MAGBRTE4",151,0)
 . . . N B ;--- Begin date/time
"RTN","MAGBRTE4",152,0)
 . . . N E ;--- End date/time
"RTN","MAGBRTE4",153,0)
 . . . N %H ;-- FileMan API parameter value -- date
"RTN","MAGBRTE4",154,0)
 . . . N I ;--- Loopcounter
"RTN","MAGBRTE4",155,0)
 . . . N M ;--- Date/time mask
"RTN","MAGBRTE4",156,0)
 . . . N N ;--- Loopcounter (time-frames)
"RTN","MAGBRTE4",157,0)
 . . . N %T ;-- FileMan internal variable
"RTN","MAGBRTE4",158,0)
 . . . N VV ;-- Actual value
"RTN","MAGBRTE4",159,0)
 . . . N WD ;-- Weekday
"RTN","MAGBRTE4",160,0)
 . . . N X1 ;-- FileMan API parameter value -- date
"RTN","MAGBRTE4",161,0)
 . . . N X2 ;-- FileMan API parameter value -- date
"RTN","MAGBRTE4",162,0)
 . . . ;
"RTN","MAGBRTE4",163,0)
 . . . ; convert the literal date/time field into the format for comparison
"RTN","MAGBRTE4",164,0)
 . . . S VV=VAL
"RTN","MAGBRTE4",165,0)
 . . . ;
"RTN","MAGBRTE4",166,0)
 . . . S (A,N)=0 F  S N=$O(RULE(RULE,"CONDITION",C,"VA",N)) Q:'N  D
"RTN","MAGBRTE4",167,0)
 . . . . N T,VB,VC,VE
"RTN","MAGBRTE4",168,0)
 . . . . S M=$G(RULE(RULE,"CONDITION",C,"VA",N,"M"))
"RTN","MAGBRTE4",169,0)
 . . . . S B=$G(RULE(RULE,"CONDITION",C,"VA",N,"B"))
"RTN","MAGBRTE4",170,0)
 . . . . S E=$G(RULE(RULE,"CONDITION",C,"VA",N,"E"))
"RTN","MAGBRTE4",171,0)
 . . . . S T=1
"RTN","MAGBRTE4",172,0)
 . . . . I $E(M,1,3)="HOL" S:$$GET1^DIQ(40.5,+$E(VV,5,11),.01)="" T=0 ; IA 10038
"RTN","MAGBRTE4",173,0)
 . . . . I $E(M,1,3)="DDD",$E(B,1,3)'=$E(VAL,1,3) S T=0
"RTN","MAGBRTE4",174,0)
 . . . . S (VB,VC,VE)=""
"RTN","MAGBRTE4",175,0)
 . . . . F I=4:1:$L(M) S:$E(M,I)?1U VC=VC_$E(VV,I),VB=VB_$E(B,I),VE=VE_$E(E,I)
"RTN","MAGBRTE4",176,0)
 . . . . S:VB>VC T=0
"RTN","MAGBRTE4",177,0)
 . . . . S:VE<VC T=0
"RTN","MAGBRTE4",178,0)
 . . . . S:T A=1
"RTN","MAGBRTE4",179,0)
 . . . . Q
"RTN","MAGBRTE4",180,0)
 . . . S:'A OK=0
"RTN","MAGBRTE4",181,0)
 . . . Q
"RTN","MAGBRTE4",182,0)
 . . Q
"RTN","MAGBRTE4",183,0)
 . S METMSG(OK,METMSG)=""
"RTN","MAGBRTE4",184,0)
 . D NOW^%DTC S RDT=%\1
"RTN","MAGBRTE4",185,0)
 . Q:'OK
"RTN","MAGBRTE4",186,0)
 . S ACTION=$G(RULE(RULE,"ACTION"))
"RTN","MAGBRTE4",187,0)
 . Q:ACTION=""
"RTN","MAGBRTE4",188,0)
 . I ACTION="SEND" D  Q
"RTN","MAGBRTE4",189,0)
 . . N %,D,PRI,X
"RTN","MAGBRTE4",190,0)
 . . S X=$G(RULE(RULE,"ACTION",1))
"RTN","MAGBRTE4",191,0)
 . . I X="" S METMSG(0,"No location for rule "_RULE)="" Q
"RTN","MAGBRTE4",192,0)
 . . D VALDEST^MAGDRPC1(.D,X)
"RTN","MAGBRTE4",193,0)
 . . I D<0 S METMSG(0,"Cannot find location """_X_""".")="" Q
"RTN","MAGBRTE4",194,0)
 . . S PRI=$$PRI($G(RULE(RULE,"PRIORITY")),IMAGE)
"RTN","MAGBRTE4",195,0)
 . . S VRS=VRS_$$SEND^MAGBRTE5(IMAGE,D,PRI,1,LOCATION)
"RTN","MAGBRTE4",196,0)
 . . Q
"RTN","MAGBRTE4",197,0)
 . I ACTION="DICOM" D  Q
"RTN","MAGBRTE4",198,0)
 . . N %,D,PRI,X
"RTN","MAGBRTE4",199,0)
 . . S X=$G(RULE(RULE,"ACTION",1))
"RTN","MAGBRTE4",200,0)
 . . I X="" S METMSG(0,"No location for rule "_RULE)="" Q
"RTN","MAGBRTE4",201,0)
 . . S D=$O(^MAG(2006.587,"B",X,""))
"RTN","MAGBRTE4",202,0)
 . . I D="" S METMSG(0,"Cannot find location """_X_""".")="" Q
"RTN","MAGBRTE4",203,0)
 . . S PRI=$$PRI($G(RULE(RULE,"PRIORITY")),IMAGE)
"RTN","MAGBRTE4",204,0)
 . . S VRS=VRS_$$SEND^MAGBRTE5(IMAGE,D,PRI,2,LOCATION)
"RTN","MAGBRTE4",205,0)
 . . Q
"RTN","MAGBRTE4",206,0)
 . I ACTION="BALANCE" D BALANCE^MAGBRTE5(IMAGE,.RULE) Q
"RTN","MAGBRTE4",207,0)
 . ;
"RTN","MAGBRTE4",208,0)
 . ; Other actions to be inserted here...
"RTN","MAGBRTE4",209,0)
 . ;
"RTN","MAGBRTE4",210,0)
 . Q
"RTN","MAGBRTE4",211,0)
 ;
"RTN","MAGBRTE4",212,0)
 ; Note: we may have:
"RTN","MAGBRTE4",213,0)
 ;    Rule 1: If CR, send to XXX
"RTN","MAGBRTE4",214,0)
 ;    Rule 2: If CT, send to XXX
"RTN","MAGBRTE4",215,0)
 ; For a CR, this would cause an entry of
"RTN","MAGBRTE4",216,0)
 ;    METMSG(0,"SEND(XXX)") for rule 2
"RTN","MAGBRTE4",217,0)
 ; and an entry of
"RTN","MAGBRTE4",218,0)
 ;    METMSG(1,"SEND(XXX)") for rule 1
"RTN","MAGBRTE4",219,0)
 ; and for a CT it would be the other way around.
"RTN","MAGBRTE4",220,0)
 ; So, first remove all "failed" entries that were successful
"RTN","MAGBRTE4",221,0)
 ; for a different rule.
"RTN","MAGBRTE4",222,0)
 ;
"RTN","MAGBRTE4",223,0)
 S X="" F  S X=$O(METMSG(1,X)) Q:X=""  D
"RTN","MAGBRTE4",224,0)
 . D LOG("Image "_IMAGE_": "_X)
"RTN","MAGBRTE4",225,0)
 . K METMSG(0,X)
"RTN","MAGBRTE4",226,0)
 . Q
"RTN","MAGBRTE4",227,0)
 S X="" F  S X=$O(METMSG(0,X)) Q:X=""  D
"RTN","MAGBRTE4",228,0)
 . D LOG("Image "_IMAGE_": Do not "_X)
"RTN","MAGBRTE4",229,0)
 . Q
"RTN","MAGBRTE4",230,0)
 Q VRS
"RTN","MAGBRTE4",231,0)
 ;
"RTN","MAGBRTE4",232,0)
 ;
"RTN","MAGBRTE4",233,0)
PRI(PRI,IMAGE) N C,D0,D1,D2,O,P,R,X
"RTN","MAGBRTE4",234,0)
 S PRI=$S(PRI="HIGH":750,PRI="NORMAL":500,PRI="LOW":250,1:500)
"RTN","MAGBRTE4",235,0)
 S X=$G(^MAG(2005,IMAGE,2))
"RTN","MAGBRTE4",236,0)
 S P=$P(X,"^",6) Q:P'=74 PRI
"RTN","MAGBRTE4",237,0)
 S R=$P(X,"^",7) Q:'R PRI
"RTN","MAGBRTE4",238,0)
 S C=$P($G(^RARPT(R,0)),"^",1) Q:C="" PRI  ; IA 1171
"RTN","MAGBRTE4",239,0)
 S D0=$O(^RADPT("ADC",C,"")) Q:'D0 PRI  ; IA 1172
"RTN","MAGBRTE4",240,0)
 S D1=$O(^RADPT("ADC",C,D0,"")) Q:'D1 PRI  ; IA 1172
"RTN","MAGBRTE4",241,0)
 S D2=$O(^RADPT("ADC",C,D0,D1,"")) Q:'D2 PRI  ; IA 1172
"RTN","MAGBRTE4",242,0)
 S O=$P($G(^RADPT(D0,"DT",D1,"P",D2,0)),"^",11) Q:'O PRI  ; IA 1172
"RTN","MAGBRTE4",243,0)
 S X=$P($G(^RAO(75.1,O,0)),"^",6) ; IA 3074
"RTN","MAGBRTE4",244,0)
 Q PRI+$S(X=1:20,X=2:10,1:0)
"RTN","MAGBRTE4",245,0)
 ;
"RTN","MAGBRTE4",246,0)
WLDMATCH(VAL,WILD) ;
"RTN","MAGBRTE4",247,0)
 ;
"RTN","MAGBRTE4",248,0)
 ; Returns true if VAL=WILD (Val=Actual value, Wild=Wildcard)
"RTN","MAGBRTE4",249,0)
 ;
"RTN","MAGBRTE4",250,0)
 ; Wild characters are:
"RTN","MAGBRTE4",251,0)
 ;   ?   matches any single character
"RTN","MAGBRTE4",252,0)
 ;   *   matches any string of characters
"RTN","MAGBRTE4",253,0)
 ;
"RTN","MAGBRTE4",254,0)
 N I,M
"RTN","MAGBRTE4",255,0)
 F  Q:VAL=""  Q:WILD=""  D
"RTN","MAGBRTE4",256,0)
 . I $E(VAL,1)=$E(WILD,1) S VAL=$E(VAL,2,$L(VAL)),WILD=$E(WILD,2,$L(WILD)) Q
"RTN","MAGBRTE4",257,0)
 . I $E(WILD,1)="?" S VAL=$E(VAL,2,$L(VAL)),WILD=$E(WILD,2,$L(WILD)) Q
"RTN","MAGBRTE4",258,0)
 . I $E(WILD,1)="*" D  Q:M
"RTN","MAGBRTE4",259,0)
 . . I WILD="*" S (VAL,WILD)="",M=1 Q
"RTN","MAGBRTE4",260,0)
 . . S WILD=$E(WILD,2,$L(WILD)),M=0
"RTN","MAGBRTE4",261,0)
 . . F I=1:1:$L(VAL) I $$WLDMATCH($E(VAL,I,$L(VAL)),WILD) S M=1,VAL=$E(VAL,I,$L(VAL)) Q
"RTN","MAGBRTE4",262,0)
 . . Q
"RTN","MAGBRTE4",263,0)
 . S VAL="!",WILD=""
"RTN","MAGBRTE4",264,0)
 . Q
"RTN","MAGBRTE4",265,0)
 Q:VAL'="" 0 Q:WILD'="" 0 Q 1
"RTN","MAGBRTE4",266,0)
 ;
"RTN","MAGBRTE5")
0^4^B36381049
"RTN","MAGBRTE5",1,0)
MAGBRTE5 ;WOIFO/PMK - Background Routing - Load Balance ; 08/26/2005  07:46
"RTN","MAGBRTE5",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGBRTE5",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE5",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTE5",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTE5",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTE5",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTE5",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTE5",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTE5",10,0)
 ;; |                                                               |
"RTN","MAGBRTE5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTE5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTE5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTE5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTE5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTE5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE5",17,0)
 ;;
"RTN","MAGBRTE5",18,0)
 Q
"RTN","MAGBRTE5",19,0)
 ;
"RTN","MAGBRTE5",20,0)
BALANCE(IMAGE,RULE) N %,D,DEST,PARENT,PRI,X
"RTN","MAGBRTE5",21,0)
 S PARENT=$P(^MAG(2005,IMAGE,0),"^",10) ; ~~~
"RTN","MAGBRTE5",22,0)
 D:'$D(^MAGRT(2006.5906,RULE,1,PARENT))
"RTN","MAGBRTE5",23,0)
 . N CP,M1,M2,MAX,B,E,L,RD,T
"RTN","MAGBRTE5",24,0)
 . ;
"RTN","MAGBRTE5",25,0)
 . L +^MAGRT(2006.5906,0):1E9 ; Background task must wait for lock
"RTN","MAGBRTE5",26,0)
 . ;
"RTN","MAGBRTE5",27,0)
 . ; Clean up old info
"RTN","MAGBRTE5",28,0)
 . ; Allow for a study to cross one day boundary,
"RTN","MAGBRTE5",29,0)
 . ; and remove everything that is older than a day.
"RTN","MAGBRTE5",30,0)
 . ;
"RTN","MAGBRTE5",31,0)
 . S RD=RDT-1 F  S RD=$O(^MAGRT(2006.5906,"D",RD),-1) Q:'RD  D
"RTN","MAGBRTE5",32,0)
 . . N DE,RU,PA
"RTN","MAGBRTE5",33,0)
 . . S DE="" F  S DE=$O(^MAGRT(2006.5906,"D",RD,DE)) Q:DE=""  D
"RTN","MAGBRTE5",34,0)
 . . . S RU="" F  S RU=$O(^MAGRT(2006.5906,"D",RD,DE,RU)) Q:RU=""  D
"RTN","MAGBRTE5",35,0)
 . . . . S PA="" F  S PA=$O(^MAGRT(2006.5906,"D",RD,DE,RU,PA)) Q:PA=""  D
"RTN","MAGBRTE5",36,0)
 . . . . . K ^MAGRT(2006.5906,"D",RD,DE,RU,PA)
"RTN","MAGBRTE5",37,0)
 . . . . . K ^MAGRT(2006.5906,RU,1,PA)
"RTN","MAGBRTE5",38,0)
 . . . . . S X=^MAGRT(2006.5906,RU,1,0)
"RTN","MAGBRTE5",39,0)
 . . . . . S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGBRTE5",40,0)
 . . . . . S ^MAGRT(2006.5906,RU,1,0)=X
"RTN","MAGBRTE5",41,0)
 . . . . . Q
"RTN","MAGBRTE5",42,0)
 . . . . Q
"RTN","MAGBRTE5",43,0)
 . . . Q
"RTN","MAGBRTE5",44,0)
 . . Q
"RTN","MAGBRTE5",45,0)
 . ;
"RTN","MAGBRTE5",46,0)
 . D:'$D(^MAGRT(2006.5906,RULE))
"RTN","MAGBRTE5",47,0)
 . . S X=$G(^MAGRT(2006.5906,0))
"RTN","MAGBRTE5",48,0)
 . . S $P(X,"^",1,2)="ROUTE LOAD BALANCE^2006.5906"
"RTN","MAGBRTE5",49,0)
 . . S:RULE>$P(X,"^",3) $P(X,"^",3)=RULE
"RTN","MAGBRTE5",50,0)
 . . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGBRTE5",51,0)
 . . S:RULE>$P(X,"^",3) $P(X,"^",3)=RULE
"RTN","MAGBRTE5",52,0)
 . . S ^MAGRT(2006.5906,0)=X
"RTN","MAGBRTE5",53,0)
 . . S ^MAGRT(2006.5906,RULE,0)=RULE
"RTN","MAGBRTE5",54,0)
 . . Q
"RTN","MAGBRTE5",55,0)
 . ;
"RTN","MAGBRTE5",56,0)
 . M CP=^MAGRT(2006.5906,"D",RDT)
"RTN","MAGBRTE5",57,0)
 . S (B,DEST,L,M1,M2,MAX)=0
"RTN","MAGBRTE5",58,0)
 . F  S DEST=$O(RULE(RULE,"ACTION",DEST)) Q:'DEST  D
"RTN","MAGBRTE5",59,0)
 . . N I,T
"RTN","MAGBRTE5",60,0)
 . . S B=B+1,B(B)=DEST
"RTN","MAGBRTE5",61,0)
 . . S X=RULE(RULE,"ACTION",DEST)
"RTN","MAGBRTE5",62,0)
 . . S M(B)=$P(X,"^",2),MAX=MAX+M(B)
"RTN","MAGBRTE5",63,0)
 . . ; Don't exceed maximum number of studies per day days
"RTN","MAGBRTE5",64,0)
 . . S T=0,I="" F  S I=$O(CP(DEST,I)) Q:I=""  S T=T+1
"RTN","MAGBRTE5",65,0)
 . . I $P(X,"^",3),T'<$P(X,"^",3) S M2=M2+M(B),M(B)=-1,M1=M1+1
"RTN","MAGBRTE5",66,0)
 . . Q
"RTN","MAGBRTE5",67,0)
 . ; If one destination has reached its cap, redistribute...
"RTN","MAGBRTE5",68,0)
 . D:M1
"RTN","MAGBRTE5",69,0)
 . . N I,L,R
"RTN","MAGBRTE5",70,0)
 . . S R=M2#M1,L=0
"RTN","MAGBRTE5",71,0)
 . . F I=1:1:B S:M(I)>0 M(I)=M2\M1+M(I),L=I
"RTN","MAGBRTE5",72,0)
 . . S M(L)=M(L)+R
"RTN","MAGBRTE5",73,0)
 . . Q
"RTN","MAGBRTE5",74,0)
 . ;
"RTN","MAGBRTE5",75,0)
 . S X=$G(^MAGRT(2006.5906,RULE,2))
"RTN","MAGBRTE5",76,0)
 . ; X = LAST ^ TOTAL ^ COUNT(DEST) ^ COUNT(DEST) ^ ...
"RTN","MAGBRTE5",77,0)
 . F L=1:1:B S E(L)=+$P(X,"^",L+2)
"RTN","MAGBRTE5",78,0)
 . S L=$P(X,"^",1) F  S L=L+1 S:L>B L=1 Q:E(L)<M(L)
"RTN","MAGBRTE5",79,0)
 . S T=$P(X,"^",2)+1,E(L)=E(L)+1,DEST=B(L)
"RTN","MAGBRTE5",80,0)
 . I T'<MAX S T=0 F L=1:1:B S E(L)=0
"RTN","MAGBRTE5",81,0)
 . S X=L_"^"_T F L=1:1:B S X=X_"^"_E(L)
"RTN","MAGBRTE5",82,0)
 . S ^MAGRT(2006.5906,RULE,2)=X
"RTN","MAGBRTE5",83,0)
 . ;
"RTN","MAGBRTE5",84,0)
 . ; Note: on consolidated sites 'origins' and 'destinations'
"RTN","MAGBRTE5",85,0)
 . ; matter even more than on non-consolidated ones.
"RTN","MAGBRTE5",86,0)
 . ; In the case of load-balancing, however, the 'destinations'
"RTN","MAGBRTE5",87,0)
 . ; part is taken care of by the balancing parameters, and the
"RTN","MAGBRTE5",88,0)
 . ; origin is moot, because each study has one (and only one)
"RTN","MAGBRTE5",89,0)
 . ; origin.
"RTN","MAGBRTE5",90,0)
 . ;
"RTN","MAGBRTE5",91,0)
 . D:'$D(^MAGRT(2006.5906,RULE,1,PARENT))
"RTN","MAGBRTE5",92,0)
 . . S X=$G(^MAGRT(2006.5906,RULE,1,0))
"RTN","MAGBRTE5",93,0)
 . . S $P(X,"^",1,2)="^2006.59061"
"RTN","MAGBRTE5",94,0)
 . . S:PARENT>$P(X,"^",3) $P(X,"^",3)=PARENT
"RTN","MAGBRTE5",95,0)
 . . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGBRTE5",96,0)
 . . S ^MAGRT(2006.5906,RULE,1,0)=X
"RTN","MAGBRTE5",97,0)
 . . S ^MAGRT(2006.5906,RULE,1,PARENT,0)=PARENT_"^"_RDT_"^"_DEST
"RTN","MAGBRTE5",98,0)
 . . Q
"RTN","MAGBRTE5",99,0)
 . L -^MAGRT(2006.5906,0)
"RTN","MAGBRTE5",100,0)
 . Q
"RTN","MAGBRTE5",101,0)
 S DEST=$P(^MAGRT(2006.5906,RULE,1,PARENT,0),"^",3)
"RTN","MAGBRTE5",102,0)
 S X=$G(RULE(RULE,"ACTION",DEST))
"RTN","MAGBRTE5",103,0)
 I X="" S METMSG(0,"No location for rule "_RULE_", alternative "_DEST)="" Q
"RTN","MAGBRTE5",104,0)
 S X=$P(X,"^",1) Q:X="<LOCAL>"
"RTN","MAGBRTE5",105,0)
 S DEST=0
"RTN","MAGBRTE5",106,0)
 S D=0 F  S D=$O(RULE(RULE,"ACTION",D)) Q:'D  D  Q:DEST
"RTN","MAGBRTE5",107,0)
 . Q:$P($G(RULE(RULE,"ACTION",D)),"^",1)'=X
"RTN","MAGBRTE5",108,0)
 . S DEST=D
"RTN","MAGBRTE5",109,0)
 . Q
"RTN","MAGBRTE5",110,0)
 I 'DEST S METMSG(0,"Cannot find location """_X_""".")="" Q
"RTN","MAGBRTE5",111,0)
 S ^MAGRT(2006.5906,"D",RDT,DEST,RULE,PARENT)=""
"RTN","MAGBRTE5",112,0)
 ;
"RTN","MAGBRTE5",113,0)
 ; Current version assumes that BALANCE means DOS-Copy, not DICOM...
"RTN","MAGBRTE5",114,0)
 D VALDEST^MAGDRPC1(.DEST,X)
"RTN","MAGBRTE5",115,0)
 D LOG^MAGBRTE4("Load-Balance Destination is "_X)
"RTN","MAGBRTE5",116,0)
 S PRI=$$PRI^MAGBRTE4($G(RULE(RULE,"PRIORITY")),IMAGE)
"RTN","MAGBRTE5",117,0)
 S VRS=VRS_$$SEND(IMAGE,DEST,PRI,1,LOCATION)
"RTN","MAGBRTE5",118,0)
 Q
"RTN","MAGBRTE5",119,0)
 ;
"RTN","MAGBRTE5",120,0)
VARNAME(F) ;
"RTN","MAGBRTE5",121,0)
 S F=$TR(F," !""#$%&'()*+,-./:;<=>?@[\]^_`{|}~","_________________________________")
"RTN","MAGBRTE5",122,0)
 F  Q:F'["__"  S F=$P(F,"__",1)_"_"_$P(F,"__",2,$L(F)+2)
"RTN","MAGBRTE5",123,0)
 F  Q:$E(F,1)'="_"  S F=$E(F,2,$L(F))
"RTN","MAGBRTE5",124,0)
 F  Q:$E(F,$L(F))'="_"  S F=$E(F,1,$L(F)-1)
"RTN","MAGBRTE5",125,0)
 S F=$TR(F,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGBRTE5",126,0)
 Q F
"RTN","MAGBRTE5",127,0)
 ;
"RTN","MAGBRTE5",128,0)
SEND(IMAGE,DEST,PRI,MECH,LOCATION) N D1,D2,IM,IMG,O,OUT,PRE,RADFN,RADTI,RACNI,RARPT,VRS,X
"RTN","MAGBRTE5",129,0)
 S VRS=$$SEND^MAGBRTUT(IMAGE,DEST,PRI,MECH,LOCATION)
"RTN","MAGBRTE5",130,0)
 Q:$G(RULE(RULE,"PRIORSTUDY"))'="YES" VRS
"RTN","MAGBRTE5",131,0)
 Q:'$G(IMAGE) VRS
"RTN","MAGBRTE5",132,0)
 S X=$G(^MAG(2005,IMAGE,2))
"RTN","MAGBRTE5",133,0)
 I $P(X,"^",6)'=74 Q VRS
"RTN","MAGBRTE5",134,0)
 S RARPT=$P(X,"^",7) I 'RARPT Q VRS
"RTN","MAGBRTE5",135,0)
 S X=$G(^RARPT(RARPT,0)) ; IA # 1171
"RTN","MAGBRTE5",136,0)
 S RADFN=$P(X,"^",2),RADTI=9999999.9999-$P(X,"^",3),RACNI=$P(X,"^",4)
"RTN","MAGBRTE5",137,0)
 S:RACNI RACNI=$O(^RADPT(+RADFN,"DT",+RADTI,"P","B",RACNI,"")) ; IA # 1172
"RTN","MAGBRTE5",138,0)
 S PRE="A^"_RADFN_"^"_RADTI_"^"_RACNI_"^"_RARPT
"RTN","MAGBRTE5",139,0)
 D PRIOR1^MAGJEX2(.OUT,PRE)
"RTN","MAGBRTE5",140,0)
 S O=0 F  S O=$O(OUT(O))  Q:O=""  D
"RTN","MAGBRTE5",141,0)
 . S X=$G(OUT(O)) Q:'$P(X,"^",2)
"RTN","MAGBRTE5",142,0)
 . S X=$P(X,"|",2) Q:'X
"RTN","MAGBRTE5",143,0)
 . S RARPT=$P(X,"^",4) Q:'RARPT
"RTN","MAGBRTE5",144,0)
 . S D1=0 F  S D1=$O(^RARPT(RARPT,2005,D1)) Q:'D1  D  ; IA # 1171
"RTN","MAGBRTE5",145,0)
 . . S IM=+$G(^RARPT(RARPT,2005,D1,0)) Q:'IM  ; IA # 1171
"RTN","MAGBRTE5",146,0)
 . . S D2=0 F  S D2=$O(^MAG(2005,IM,1,D2)) Q:'D2  D
"RTN","MAGBRTE5",147,0)
 . . . S IMG=+$G(^MAG(2005,IM,1,D2,0)) Q:'IMG
"RTN","MAGBRTE5",148,0)
 . . . S VRS=VRS_$$SEND^MAGBRTUT(IMG,DEST,PRI,MECH,LOCATION)
"RTN","MAGBRTE5",149,0)
 . . . S METMSG(1,"SEND also image #"_IMG_" from prior study")=""
"RTN","MAGBRTE5",150,0)
 . . . Q
"RTN","MAGBRTE5",151,0)
 . . Q
"RTN","MAGBRTE5",152,0)
 . Q
"RTN","MAGBRTE5",153,0)
 Q VRS
"RTN","MAGBRTE5",154,0)
 ;
"RTN","MAGBRTK")
0^5^B19598690
"RTN","MAGBRTK",1,0)
MAGBRTK ;WOIFO/EdM - Routing - Keywords ; 08/26/2005  08:04
"RTN","MAGBRTK",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGBRTK",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTK",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTK",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTK",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTK",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTK",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTK",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTK",10,0)
 ;; |                                                               |
"RTN","MAGBRTK",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTK",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTK",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTK",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTK",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTK",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTK",17,0)
 ;;
"RTN","MAGBRTK",18,0)
 Q
"RTN","MAGBRTK",19,0)
 ;
"RTN","MAGBRTK",20,0)
 ; This routine is needed on the DICOM Gateway while importing
"RTN","MAGBRTK",21,0)
 ; new rules, and on the VistA system while evaluating the rules.
"RTN","MAGBRTK",22,0)
 ;
"RTN","MAGBRTK",23,0)
KEYWORD ; build the KEYWORD array
"RTN","MAGBRTK",24,0)
 N C,CD,D,KW,M,V,X
"RTN","MAGBRTK",25,0)
 S CD="CONDITION" K KEYWORD
"RTN","MAGBRTK",26,0)
 ; Actions
"RTN","MAGBRTK",27,0)
 F X="SEND","BALANCE","DICOM" S KEYWORD("ACTION",X)="-"
"RTN","MAGBRTK",28,0)
 F X="DESTINATION","HOLIDAY" S KEYWORD("ACTION",X)="I"
"RTN","MAGBRTK",29,0)
 ;
"RTN","MAGBRTK",30,0)
 F X="HIGH","NORMAL","LOW" S KEYWORD("PRIORITY",X)="-"
"RTN","MAGBRTK",31,0)
 F X="YES","NO" S KEYWORD("PRIORSTUDY",X)="-"
"RTN","MAGBRTK",32,0)
 ;
"RTN","MAGBRTK",33,0)
 ; Fields in ^MAG(2005,
"RTN","MAGBRTK",34,0)
 S M="LO^MAG^MAGBRTE3(IMAGE,"
"RTN","MAGBRTK",35,0)
 S KEYWORD(CD,"ABSTRACT_REF")=M_"0,0,4,.VAL)"
"RTN","MAGBRTK",36,0)
 S KEYWORD(CD,"ACQUISITION_DEVICE")=M_"2006.04,100,4,.VAL)"
"RTN","MAGBRTK",37,0)
 S KEYWORD(CD,"BIG_JUKEBOX_PATH")=M_"2005.2,""FBIG"",2,.VAL)"
"RTN","MAGBRTK",38,0)
 S KEYWORD(CD,"BIG_MAGNETIC_PATH")=M_"2005.2,""FBIG"",1,.VAL)"
"RTN","MAGBRTK",39,0)
 S KEYWORD(CD,"CLASS")=M_"2005.82,40,2,.VAL)"
"RTN","MAGBRTK",40,0)
 S KEYWORD(CD,"CLINIC")=M_"44,100,2,.VAL)"
"RTN","MAGBRTK",41,0)
 S KEYWORD(CD,"CREATE METHOD")=M_"0,""METHOD"",1,.VAL)"
"RTN","MAGBRTK",42,0)
 S KEYWORD(CD,"DESCRIPTIVE_CATEGORY")=M_"2005.81,100,1,.VAL)"
"RTN","MAGBRTK",43,0)
 S KEYWORD(CD,"EXPORT_REQUEST_STATUS")=M_"0,2,9,.VAL)"
"RTN","MAGBRTK",44,0)
 S KEYWORD(CD,"FILE_REF")=M_"0,0,2,.VAL)"
"RTN","MAGBRTK",45,0)
 S KEYWORD(CD,"IQ")=M_"0,0,11,.VAL)"
"RTN","MAGBRTK",46,0)
 S KEYWORD(CD,"MAGNETIC_REF")=M_"0,0,3,.VAL)"
"RTN","MAGBRTK",47,0)
 S KEYWORD(CD,"MICROSCOPIC_OBJECTIVE")=M_"0,""PATH"",5,.VAL)"
"RTN","MAGBRTK",48,0)
 S KEYWORD(CD,"MODALITY")=M_"0,0,8,.VAL)"
"RTN","MAGBRTK",49,0)
 S KEYWORD(CD,"OBJECT NAME")=M_"0,0,1,.VAL)"
"RTN","MAGBRTK",50,0)
 S KEYWORD(CD,"OBJECT_TYPE")=M_"2005.02,0,6,.VAL)"
"RTN","MAGBRTK",51,0)
 S KEYWORD(CD,"PACKAGE")=M_"0,40,1,.VAL)"
"RTN","MAGBRTK",52,0)
 S KEYWORD(CD,"PACS_PROCEDURE")=M_"71,""PACS"",3,.VAL)"
"RTN","MAGBRTK",53,0)
 S KEYWORD(CD,"PACS_UID")=M_"0,""PACS"",1,.VAL)"
"RTN","MAGBRTK",54,0)
 S KEYWORD(CD,"PARENT_DATA")=M_"2005.03,2,6,.VAL)"
"RTN","MAGBRTK",55,0)
 S KEYWORD(CD,"PARENT_DATA_FILE_IMAGE_POINTER")=M_"0,2,8,.VAL)"
"RTN","MAGBRTK",56,0)
 S KEYWORD(CD,"PARENT_GLOBAL_ROOT_D0")=M_"0,2,7,.VAL)"
"RTN","MAGBRTK",57,0)
 S KEYWORD(CD,"PARENT_GLOBAL_ROOT_D1")=M_"0,2,10,.VAL)"
"RTN","MAGBRTK",58,0)
 S KEYWORD(CD,"PATH_ACCESSION_NUMBER")=M_"0,""PATH"",1,.VAL)"
"RTN","MAGBRTK",59,0)
 S KEYWORD(CD,"PATIENT")=M_"2,0,7,.VAL)"
"RTN","MAGBRTK",60,0)
 S KEYWORD(CD,"PROCEDURE")=M_"0,0,8,.VAL)"
"RTN","MAGBRTK",61,0)
 S KEYWORD(CD,"PROCEDURE_OR_EVENT")=M_"2005.85,40,4,.VAL)"
"RTN","MAGBRTK",62,0)
 S KEYWORD(CD,"RADIOLOGY_REPORT")=M_"74,""PACS"",2,.VAL)"
"RTN","MAGBRTK",63,0)
 S KEYWORD(CD,"SAVED_BY")=M_"200,2,2,.VAL)"
"RTN","MAGBRTK",64,0)
 S KEYWORD(CD,"SHORT_DESCRIPTION")=M_"0,2,4,.VAL)"
"RTN","MAGBRTK",65,0)
 S KEYWORD(CD,"SPECIALTY")=M_"2005.84,40,5,.VAL)"
"RTN","MAGBRTK",66,0)
 S KEYWORD(CD,"SPECIMEN")=M_"0,""PATH"",3,.VAL)"
"RTN","MAGBRTK",67,0)
 S KEYWORD(CD,"SPECIMEN_DESCRIPTION")=M_"0,""PATH"",2,.VAL)"
"RTN","MAGBRTK",68,0)
 S KEYWORD(CD,"STAIN")=M_"0,""PATH"",4,.VAL)"
"RTN","MAGBRTK",69,0)
 S KEYWORD(CD,"SUMMARY")=M_"0,2,3,.VAL)"
"RTN","MAGBRTK",70,0)
 S KEYWORD(CD,"SUMMARY_OBJECT")=M_"0,2,3,.VAL)"
"RTN","MAGBRTK",71,0)
 S KEYWORD(CD,"TRACKING_ID")=M_"0,100,5,.VAL)"
"RTN","MAGBRTK",72,0)
 S KEYWORD(CD,"TYPE")=M_"2005.83,40,3,.VAL)"
"RTN","MAGBRTK",73,0)
 S KEYWORD(CD,"WORM_REF")=M_"0,0,5,.VAL)"
"RTN","MAGBRTK",74,0)
 ;
"RTN","MAGBRTK",75,0)
 ; Date and time fields
"RTN","MAGBRTK",76,0)
 S M="DT^MAG^MAGBRTE3(IMAGE,"
"RTN","MAGBRTK",77,0)
 S KEYWORD(CD,"EXAM_TIME")=M_"0,2,5,.VAL)"
"RTN","MAGBRTK",78,0)
 S KEYWORD(CD,"IMAGE_SAVED")=M_"0,2,1,.VAL)"
"RTN","MAGBRTK",79,0)
 S KEYWORD(CD,"LAST_ACCESS")=M_"0,0,9,.VAL)"
"RTN","MAGBRTK",80,0)
 S KEYWORD(CD,"PROCEDURE_TIME")=M_"0,2,5,.VAL)"
"RTN","MAGBRTK",81,0)
 ;
"RTN","MAGBRTK",82,0)
 S M="DT^DATE^MAGBRTE3(IMAGE,"
"RTN","MAGBRTK",83,0)
 S KEYWORD(CD,"EXAM_TIME_FIRST")=M_"0,2,5,1,.VAL)"
"RTN","MAGBRTK",84,0)
 S KEYWORD(CD,"EXAM_TIME_LAST")=M_"0,2,5,2,.VAL)"
"RTN","MAGBRTK",85,0)
 S KEYWORD(CD,"IMAGE_SAVED_FIRST")=M_"0,2,1,1,.VAL)"
"RTN","MAGBRTK",86,0)
 S KEYWORD(CD,"IMAGE_SAVED_LAST")=M_"0,2,1,2,.VAL)"
"RTN","MAGBRTK",87,0)
 S KEYWORD(CD,"LAST_ACCESS_FIRST")=M_"0,0,9,1,.VAL)"
"RTN","MAGBRTK",88,0)
 S KEYWORD(CD,"LAST_ACCESS_LAST")=M_"0,0,9,2,.VAL)"
"RTN","MAGBRTK",89,0)
 S KEYWORD(CD,"PROCEDURE_TIME_FIRST")=M_"0,2,5,1,.VAL)"
"RTN","MAGBRTK",90,0)
 S KEYWORD(CD,"PROCEDURE_TIME_LAST")=M_"0,2,5,2,.VAL)"
"RTN","MAGBRTK",91,0)
 S KEYWORD(CD,"STUDY_TIME")=M_"0,2,5,1,.VAL)"
"RTN","MAGBRTK",92,0)
 ;
"RTN","MAGBRTK",93,0)
 ; Built-in Fields
"RTN","MAGBRTK",94,0)
 S KEYWORD(CD,"NOW")="DT^NOW^MAGBRTE3(.VAL)"
"RTN","MAGBRTK",95,0)
 S KEYWORD(CD,"SOURCE")="SH^SOURCE^MAGBRTE3(IMAGE,.VAL)"
"RTN","MAGBRTK",96,0)
 S KEYWORD(CD,"URGENCY")="SH^URGENCY^MAGBRTE3(IMAGE,.VAL)"
"RTN","MAGBRTK",97,0)
 Q
"RTN","MAGBRTK",98,0)
 ;
"RTN","MAGBRTLD")
0^6^B16149221
"RTN","MAGBRTLD",1,0)
MAGBRTLD ;WOIFO/EdM - List of destinations ; 03/09/2005  13:56
"RTN","MAGBRTLD",2,0)
 ;;3.0;IMAGING;**9,11,30,51**;26-August-2005
"RTN","MAGBRTLD",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTLD",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTLD",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTLD",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTLD",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTLD",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTLD",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTLD",10,0)
 ;; |                                                               |
"RTN","MAGBRTLD",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTLD",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTLD",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTLD",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTLD",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTLD",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTLD",17,0)
 ;;
"RTN","MAGBRTLD",18,0)
 Q
"RTN","MAGBRTLD",19,0)
 ;
"RTN","MAGBRTLD",20,0)
LISTALL(TO,LIST) N DEST,N,X
"RTN","MAGBRTLD",21,0)
 S TO=$$UPNOPU(TO),N=0 K LIST
"RTN","MAGBRTLD",22,0)
 ;
"RTN","MAGBRTLD",23,0)
 S DEST="" F  S DEST=$O(^MAG(2005,"ROUTE",DEST)) Q:DEST=""  D
"RTN","MAGBRTLD",24,0)
 . S:DEST["MAG(2005.2," DEST(+DEST)=""
"RTN","MAGBRTLD",25,0)
 . Q
"RTN","MAGBRTLD",26,0)
 ;
"RTN","MAGBRTLD",27,0)
 S DEST="" F  S DEST=$O(DEST(DEST)) Q:DEST=""  D
"RTN","MAGBRTLD",28,0)
 . N PW
"RTN","MAGBRTLD",29,0)
 . S PW=$P($G(^MAG(2005.2,DEST,2)),"^",1,2)
"RTN","MAGBRTLD",30,0)
 . S $P(PW,"^",2)=$$DECRYP^MAGDRPC2($P(PW,"^",2))
"RTN","MAGBRTLD",31,0)
 . S X=$G(^MAG(2005.2,DEST,0))
"RTN","MAGBRTLD",32,0)
 . Q:$$UPNOPU($P(X,"^",1))'[TO
"RTN","MAGBRTLD",33,0)
 . S N=N+1,LIST(N)=$P(X,"^",2)_"^"_$P($G(^MAG(2005.2,DEST,4)),"^",2)_"^"_$P(X,"^",8)_"^"_PW_"^"_$P($G(^MAG(2005.2,DEST,3)),"^",5)_"^"_DEST
"RTN","MAGBRTLD",34,0)
 . Q
"RTN","MAGBRTLD",35,0)
 S LIST=N
"RTN","MAGBRTLD",36,0)
 Q
"RTN","MAGBRTLD",37,0)
 ;
"RTN","MAGBRTLD",38,0)
LIST(TO,LIST) N DEST,N,ORI,PRI,X
"RTN","MAGBRTLD",39,0)
 S TO=$$UPNOPU(TO),N=0 K LIST
"RTN","MAGBRTLD",40,0)
 ;
"RTN","MAGBRTLD",41,0)
 S ORI="" F  S ORI=$O(^MAGQUEUE(2006.035,"STS",ORI)) Q:ORI=""  D
"RTN","MAGBRTLD",42,0)
 . S PRI="" F  S PRI=$O(^MAGQUEUE(2006.035,"STS",ORI,"SENT",PRI)) Q:PRI=""  D
"RTN","MAGBRTLD",43,0)
 . . S DEST="" F  S DEST=$O(^MAGQUEUE(2006.035,"STS",ORI,"SENT",PRI,DEST)) Q:DEST=""  D
"RTN","MAGBRTLD",44,0)
 . . . S:DEST["MAG(2005.2," DEST(+DEST)=""
"RTN","MAGBRTLD",45,0)
 . . . Q
"RTN","MAGBRTLD",46,0)
 . . Q
"RTN","MAGBRTLD",47,0)
 . Q
"RTN","MAGBRTLD",48,0)
 ;
"RTN","MAGBRTLD",49,0)
 S DEST="" F  S DEST=$O(DEST(DEST)) Q:DEST=""  D
"RTN","MAGBRTLD",50,0)
 . N PW
"RTN","MAGBRTLD",51,0)
 . S PW=$P($G(^MAG(2005.2,DEST,2)),"^",1,2)
"RTN","MAGBRTLD",52,0)
 . S $P(PW,"^",2)=$$DECRYP^ROUTINE($P(PW,"^",2))
"RTN","MAGBRTLD",53,0)
 . S X=$G(^MAG(2005.2,DEST,0))
"RTN","MAGBRTLD",54,0)
 . Q:$$UPNOPU($P(X,"^",1))'[TO
"RTN","MAGBRTLD",55,0)
 . S N=N+1,LIST(N)=$P(X,"^",2)_"^"_$P($G(^MAG(2005.2,DEST,4)),"^",2)_"^"_$P(X,"^",8)_"^"_PW_"^"_$P($G(^MAG(2005.2,DEST,3)),"^",5)_"^"_DEST
"RTN","MAGBRTLD",56,0)
 . Q
"RTN","MAGBRTLD",57,0)
 S LIST=N
"RTN","MAGBRTLD",58,0)
 Q
"RTN","MAGBRTLD",59,0)
 ;
"RTN","MAGBRTLD",60,0)
AVERAGE() N A,D0,D1,N,P,X
"RTN","MAGBRTLD",61,0)
 S (A,N)=0
"RTN","MAGBRTLD",62,0)
 S D0=0 F  S D0=$O(^MAGQUEUE(2006.036,D0)) Q:'D0  D
"RTN","MAGBRTLD",63,0)
 . S N=N+1
"RTN","MAGBRTLD",64,0)
 . S D1=0 F  S D1=$O(^MAGQUEUE(2006.036,D0,1,D1)) Q:'D1  D
"RTN","MAGBRTLD",65,0)
 . . S X=$G(^MAGQUEUE(2006.036,D0,1,D1,0)) Q:$P(X,"^",6)'["Duration"
"RTN","MAGBRTLD",66,0)
 . . F P=1:1:4 S A=A+$P(X,"^",P)
"RTN","MAGBRTLD",67,0)
 . . Q
"RTN","MAGBRTLD",68,0)
 . Q
"RTN","MAGBRTLD",69,0)
 Q A/$S(N:N,1:1)
"RTN","MAGBRTLD",70,0)
 ;
"RTN","MAGBRTLD",71,0)
UPNOPU(X) Q $TR(X,"abcdefghijklmnopqrstuvwxyz !""#$%&'()*+,-./:;<=>?@[\]^_`{|}~","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGBRTLD",72,0)
 ;
"RTN","MAGBRTLD",73,0)
PURGSTAT N COUNT,DATE,FIRST,IMAGE,LAST,LOC
"RTN","MAGBRTLD",74,0)
 W !!,"Overview of images to be purged.",!
"RTN","MAGBRTLD",75,0)
 S LOC="" F  S LOC=$O(^MAG(2005,"ROUTE",LOC)) Q:LOC=""  D
"RTN","MAGBRTLD",76,0)
 . Q:LOC'["MAG(2005.2,"
"RTN","MAGBRTLD",77,0)
 . S FIRST=$O(^MAG(2005,"ROUTE",LOC,""))\1
"RTN","MAGBRTLD",78,0)
 . S LAST=$O(^MAG(2005,"ROUTE",LOC,""),-1)\1
"RTN","MAGBRTLD",79,0)
 . S COUNT=0
"RTN","MAGBRTLD",80,0)
 . S DATE="" F  S DATE=$O(^MAG(2005,"ROUTE",LOC,DATE)) Q:DATE=""  D
"RTN","MAGBRTLD",81,0)
 . . S IMAGE="" F  S IMAGE=$O(^MAG(2005,"ROUTE",LOC,DATE,IMAGE)) Q:IMAGE=""  S COUNT=COUNT+1
"RTN","MAGBRTLD",82,0)
 . . Q
"RTN","MAGBRTLD",83,0)
 . W !,COUNT," image" W:COUNT'=1 "s"
"RTN","MAGBRTLD",84,0)
 . W " to be purged on ",$P(^MAG(2005.2,+LOC,0),"^",2)
"RTN","MAGBRTLD",85,0)
 . W !?5,"(transmitted "
"RTN","MAGBRTLD",86,0)
 . I FIRST=LAST W " on ",$$FMD(FIRST)
"RTN","MAGBRTLD",87,0)
 . E  W " between ",$$FMD(FIRST)," and ",$$FMD(LAST)
"RTN","MAGBRTLD",88,0)
 . W ")"
"RTN","MAGBRTLD",89,0)
 . Q
"RTN","MAGBRTLD",90,0)
 Q
"RTN","MAGBRTLD",91,0)
 ;
"RTN","MAGBRTLD",92,0)
FMD(X) Q (X#100)_" "_$P("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"," ",X\100#100)_" "_(X\10000+1700)
"RTN","MAGBRTLD",93,0)
 ;
"RTN","MAGBRTUT")
0^7^B19709178
"RTN","MAGBRTUT",1,0)
MAGBRTUT ;WOIFO/EdM - Routing Utilities ; 10/29/2004  11:36
"RTN","MAGBRTUT",2,0)
 ;;3.0;IMAGING;**9,11,30,51**;26-August-2005
"RTN","MAGBRTUT",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTUT",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTUT",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTUT",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTUT",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTUT",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTUT",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTUT",10,0)
 ;; |                                                               |
"RTN","MAGBRTUT",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTUT",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTUT",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTUT",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTUT",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTUT",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTUT",17,0)
 ;;
"RTN","MAGBRTUT",18,0)
 Q
"RTN","MAGBRTUT",19,0)
 ;
"RTN","MAGBRTUT",20,0)
SEND(IMAGE,LOC,PRI,MECH,FROM,ID) ; Enter image into Routing Queue
"RTN","MAGBRTUT",21,0)
 ; IMAGE ;---- Internal Entry Number in Image FIle
"RTN","MAGBRTUT",22,0)
 ; LOC ;------ Internal Entry Number in either Network Location file
"RTN","MAGBRTUT",23,0)
 ;             or SCU_List file
"RTN","MAGBRTUT",24,0)
 ; PRI ;------ Priority
"RTN","MAGBRTUT",25,0)
 ; MECHanism = 1: Send using MS-DOS-Copy
"RTN","MAGBRTUT",26,0)
 ;           = 2: Send using DICOM_Send
"RTN","MAGBRTUT",27,0)
 ; FROM ;----- Location from which request originates
"RTN","MAGBRTUT",28,0)
 ; ID ;------- Transaction ID
"RTN","MAGBRTUT",29,0)
 N D0 ;------- Internal Entry number
"RTN","MAGBRTUT",30,0)
 N FLAG ;----- List of file-types to transmit
"RTN","MAGBRTUT",31,0)
 N I ;-------- Scratch and loop counter
"RTN","MAGBRTUT",32,0)
 N ORIGIN ;--- Location from which image is being sent (IEN in Institution file)
"RTN","MAGBRTUT",33,0)
 N QQ ;------- List of queue-entries created
"RTN","MAGBRTUT",34,0)
 ;
"RTN","MAGBRTUT",35,0)
 S QQ="",MECH=$G(MECH) S:'MECH MECH=1
"RTN","MAGBRTUT",36,0)
 I '$D(^MAG(2005,+$G(IMAGE))) Q:$Q QQ Q
"RTN","MAGBRTUT",37,0)
 I MECH=1,'$D(^MAG(2005.2,+$G(LOC))) Q:$Q QQ Q
"RTN","MAGBRTUT",38,0)
 I MECH=2,'$D(^MAG(2006.587,+$G(LOC))) Q:$Q QQ Q
"RTN","MAGBRTUT",39,0)
 I MECH'=1,MECH'=2 Q:$Q QQ Q
"RTN","MAGBRTUT",40,0)
 S:MECH=1 LOC=(+LOC)_";MAG(2005.2,"
"RTN","MAGBRTUT",41,0)
 S:MECH=2 LOC=(+LOC)_";MAG(2006.587,"
"RTN","MAGBRTUT",42,0)
 ;
"RTN","MAGBRTUT",43,0)
 S ORIGIN=$G(FROM) D:'ORIGIN
"RTN","MAGBRTUT",44,0)
 . S ORIGIN=$P($G(^MAG(2005,IMAGE,100)),"^",3)
"RTN","MAGBRTUT",45,0)
 . S:'ORIGIN ORIGIN=$G(DUZ(2))
"RTN","MAGBRTUT",46,0)
 . S:'ORIGIN ORIGIN=$$KSP^XUPARAM("INST")
"RTN","MAGBRTUT",47,0)
 . Q
"RTN","MAGBRTUT",48,0)
 ;
"RTN","MAGBRTUT",49,0)
 S PRI=$G(PRI,500),ID=$G(ID)
"RTN","MAGBRTUT",50,0)
 S FLAG=$G(^MAG(2005.2,+LOC,1)) S:MECH=2 FLAG="^^^^5"
"RTN","MAGBRTUT",51,0)
 ;
"RTN","MAGBRTUT",52,0)
 I MECH=2 D  Q:$Q QQ Q
"RTN","MAGBRTUT",53,0)
 . ; Stopgap until "native DICOM" storage is supported
"RTN","MAGBRTUT",54,0)
 . N APPNAM
"RTN","MAGBRTUT",55,0)
 . S APPNAM=$P($G(^MAG(2006.587,+LOC,0)),"^",1)
"RTN","MAGBRTUT",56,0)
 . D QUEUE^MAGDRPC3(.QQ,IMAGE,APPNAM,ORIGIN,"","6: Copy to HIPAA Compliant Storage")
"RTN","MAGBRTUT",57,0)
 . Q
"RTN","MAGBRTUT",58,0)
 ;
"RTN","MAGBRTUT",59,0)
 F I=1:1:5 D:$P(FLAG,"^",I)
"RTN","MAGBRTUT",60,0)
 . N D0,T,X
"RTN","MAGBRTUT",61,0)
 . S T=$P("ABSTRACT FULL BIG TEXT DICOM"," ",I)
"RTN","MAGBRTUT",62,0)
 . ;
"RTN","MAGBRTUT",63,0)
 . S D0=$O(^MAGQUEUE(2006.035,"DEST",LOC,"WAITING",IMAGE,T,"")) I D0 D  Q
"RTN","MAGBRTUT",64,0)
 . . N O,P,T,X0,X1
"RTN","MAGBRTUT",65,0)
 . . S X0=$G(^MAGQUEUE(2006.035,D0,0)),O=$P(X0,"^",5),T=$P(X0,"^",6)
"RTN","MAGBRTUT",66,0)
 . . S X1=$G(^MAGQUEUE(2006.035,D0,1)),P=$P(X1,"^",2)
"RTN","MAGBRTUT",67,0)
 . . ; Don't send multiple copies, but do increase priority if needed
"RTN","MAGBRTUT",68,0)
 . . Q:PRI'>P
"RTN","MAGBRTUT",69,0)
 . . S $P(X0,"^",5)=ORIGIN,^MAGQUEUE(2006.035,D0,0)=X0
"RTN","MAGBRTUT",70,0)
 . . I T'=ID,ID'="" D
"RTN","MAGBRTUT",71,0)
 . . . S $P(X0,"^",6)=ID
"RTN","MAGBRTUT",72,0)
 . . . S ^MAGQUEUE(2006.035,D0,0)=X0
"RTN","MAGBRTUT",73,0)
 . . . K:O'="" ^MAGQUEUE(2006.035,"ID",T,D0)
"RTN","MAGBRTUT",74,0)
 . . . S ^MAGQUEUE(2006.035,"ID",ID,D0)=""
"RTN","MAGBRTUT",75,0)
 . . . Q
"RTN","MAGBRTUT",76,0)
 . . S $P(X1,"^",2)=PRI,^MAGQUEUE(2006.035,D0,1)=X1
"RTN","MAGBRTUT",77,0)
 . . K:O ^MAGQUEUE(2006.035,"STS",O,"WAITING",P,LOC,D0)
"RTN","MAGBRTUT",78,0)
 . . S ^MAGQUEUE(2006.035,"STS",ORIGIN,"WAITING",PRI,LOC,D0)=""
"RTN","MAGBRTUT",79,0)
 . . Q
"RTN","MAGBRTUT",80,0)
 . ;
"RTN","MAGBRTUT",81,0)
 . L +^MAGQUEUE(2006.035,0)
"RTN","MAGBRTUT",82,0)
 . S D0=$O(^MAGQUEUE(2006.035," "),-1)+1
"RTN","MAGBRTUT",83,0)
 . S X=$G(^MAGQUEUE(2006.035,0))
"RTN","MAGBRTUT",84,0)
 . S $P(X,"^",1,2)="IMAGE ROUTING QUEUE^2006.035"
"RTN","MAGBRTUT",85,0)
 . S $P(X,"^",3)=D0
"RTN","MAGBRTUT",86,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGBRTUT",87,0)
 . S ^MAGQUEUE(2006.035,0)=X
"RTN","MAGBRTUT",88,0)
 . S X=IMAGE_"^"_LOC_"^"_T_"^"_MECH_"^"_ORIGIN_"^"_ID
"RTN","MAGBRTUT",89,0)
 . S:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)=""
"RTN","MAGBRTUT",90,0)
 . S ^MAGQUEUE(2006.035,D0,0)=X
"RTN","MAGBRTUT",91,0)
 . D NOW^%DTC
"RTN","MAGBRTUT",92,0)
 . S ^MAGQUEUE(2006.035,D0,1)="WAITING^"_PRI_"^"_%
"RTN","MAGBRTUT",93,0)
 . S ^MAGQUEUE(2006.035,"STS",ORIGIN,"WAITING",PRI,LOC,D0)=""
"RTN","MAGBRTUT",94,0)
 . S ^MAGQUEUE(2006.035,"DEST",LOC,"WAITING",IMAGE,T,D0)=""
"RTN","MAGBRTUT",95,0)
 . L -^MAGQUEUE(2006.035,0)
"RTN","MAGBRTUT",96,0)
 . S QQ=QQ_D0_"^"
"RTN","MAGBRTUT",97,0)
 . Q
"RTN","MAGBRTUT",98,0)
 Q:$Q QQ Q
"RTN","MAGBRTUT",99,0)
 ;
"RTN","MAGBRTUT",100,0)
DCMLIST(OUT,LOCATION) N D0,LO,LST,N,NM,X
"RTN","MAGBRTUT",101,0)
 S LOCATION=+$G(LOCATION)
"RTN","MAGBRTUT",102,0)
 S D0=0 F  S D0=$O(^MAG(2006.587,D0)) Q:'D0  D
"RTN","MAGBRTUT",103,0)
 . S X=$G(^MAG(2006.587,D0,0))
"RTN","MAGBRTUT",104,0)
 . S NM=$P(X,"^",1),LO=$P(X,"^",7) Q:NM=""
"RTN","MAGBRTUT",105,0)
 . I LOCATION,LO,LO'=LOCATION Q
"RTN","MAGBRTUT",106,0)
 . S LST(NM,LO)=D0
"RTN","MAGBRTUT",107,0)
 . Q
"RTN","MAGBRTUT",108,0)
 S N=1,NM="" F  S NM=$O(LST(NM)) Q:NM=""  D
"RTN","MAGBRTUT",109,0)
 . S LO="",X=0 F  S LO=$O(LST(NM,LO)) Q:LO=""  S X=X+1,D0=LST(NM,LO)
"RTN","MAGBRTUT",110,0)
 . I X=1 S N=N+1,OUT(N)=NM_"^"_D0 Q
"RTN","MAGBRTUT",111,0)
 . S LO="" F  S LO=$O(LST(NM,LO)) Q:LO=""  S N=N+1,OUT(N)=NM_" ("_LO_")^"_LST(NM,LO)
"RTN","MAGBRTUT",112,0)
 . Q
"RTN","MAGBRTUT",113,0)
 S OUT(1)=N-1
"RTN","MAGBRTUT",114,0)
 Q
"RTN","MAGBRTUT",115,0)
 ;
"RTN","MAGDCCSS")
0^8^B23075441
"RTN","MAGDCCSS",1,0)
MAGDCCSS ;WOIFO/MLH - DICOM Correct - Clinical Specialties - Sort/print for 2006.575 ; 06/06/2005  09:13
"RTN","MAGDCCSS",2,0)
 ;;3.0;IMAGING;**10,11,51**;26-August-2005
"RTN","MAGDCCSS",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCSS",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDCCSS",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDCCSS",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDCCSS",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDCCSS",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDCCSS",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDCCSS",10,0)
 ;; |                                                               |
"RTN","MAGDCCSS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDCCSS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDCCSS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDCCSS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDCCSS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDCCSS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCSS",17,0)
 ;;
"RTN","MAGDCCSS",18,0)
 Q
"RTN","MAGDCCSS",19,0)
 ;
"RTN","MAGDCCSS",20,0)
SRT ;Sort the file first by the patient name but only the unique entries.
"RTN","MAGDCCSS",21,0)
 ;The "F" cross reference uses the gateway site and study uid number.
"RTN","MAGDCCSS",22,0)
 N MAGSUID,MAGIEN,MAGPT ;
"RTN","MAGDCCSS",23,0)
 N GWLOC ; -- gateway site
"RTN","MAGDCCSS",24,0)
 N KFIXALL ; -- does user hold the MAGDFIX ALL security key?
"RTN","MAGDCCSS",25,0)
 N MAGTYPE ; -- type of image (rad, med, clinspec)
"RTN","MAGDCCSS",26,0)
 ;
"RTN","MAGDCCSS",27,0)
 S KFIXALL=$$SECKEY^MAGDLB12
"RTN","MAGDCCSS",28,0)
 Q:'$D(^MAGD(2006.575,"F"))    ;nothing to sort
"RTN","MAGDCCSS",29,0)
 K ^MAGD(2006.575,"D")
"RTN","MAGDCCSS",30,0)
 S GWLOC=""
"RTN","MAGDCCSS",31,0)
 F  S GWLOC=$O(^MAGD(2006.575,"F",GWLOC)) Q:GWLOC=""  D
"RTN","MAGDCCSS",32,0)
 . ; if this isn't the user's site, bail unless user holds the
"RTN","MAGDCCSS",33,0)
 . ; MAGDFIX ALL security key
"RTN","MAGDCCSS",34,0)
 . I GWLOC'=DUZ(2),'KFIXALL Q
"RTN","MAGDCCSS",35,0)
 . S MAGSUID=""
"RTN","MAGDCCSS",36,0)
 . F  S MAGSUID=$O(^MAGD(2006.575,"F",GWLOC,MAGSUID)) Q:MAGSUID=""  D
"RTN","MAGDCCSS",37,0)
 . . S MAGIEN=0
"RTN","MAGDCCSS",38,0)
 . . F  S MAGIEN=$O(^MAGD(2006.575,"F",GWLOC,MAGSUID,MAGIEN)) Q:'MAGIEN  D
"RTN","MAGDCCSS",39,0)
 . . . ; if no failed image rec, then there's a xref problem -> bail
"RTN","MAGDCCSS",40,0)
 . . . I '$D(^MAGD(2006.575,MAGIEN,0)) D  Q
"RTN","MAGDCCSS",41,0)
 . . . . K ^MAGD(2006.575,"F",GWLOC,MAGSUID,MAGIEN)   ;clean up x-ref
"RTN","MAGDCCSS",42,0)
 . . . . Q
"RTN","MAGDCCSS",43,0)
 . . . ; if entry has already been corrected, do not include in sort
"RTN","MAGDCCSS",44,0)
 . . . I $D(^MAGD(2006.575,MAGIEN,"FIXD")),$P(^("FIXD"),"^") Q
"RTN","MAGDCCSS",45,0)
 . . . ;Only Clinical Specialties images!
"RTN","MAGDCCSS",46,0)
 . . . S MAGTYPE=$P($G(^MAGD(2006.575,MAGIEN,"TYPE")),"^")
"RTN","MAGDCCSS",47,0)
 . . . I MAGTYPE'="CON" Q
"RTN","MAGDCCSS",48,0)
 . . . S MAGPT=$P(^MAGD(2006.575,MAGIEN,0),"^",4)
"RTN","MAGDCCSS",49,0)
 . . . S ^MAGD(2006.575,"D",MAGPT,MAGIEN)=""
"RTN","MAGDCCSS",50,0)
 . . . Q
"RTN","MAGDCCSS",51,0)
 . . Q
"RTN","MAGDCCSS",52,0)
 . Q
"RTN","MAGDCCSS",53,0)
 Q
"RTN","MAGDCCSS",54,0)
 ;
"RTN","MAGDCCSS",55,0)
SRTDT ;Provide sorting by date entry but only if NOT fixed and by unique suid
"RTN","MAGDCCSS",56,0)
 N MAGSUID,MAGIEN,MAGDT
"RTN","MAGDCCSS",57,0)
 N GWLOC ; -- gateway site
"RTN","MAGDCCSS",58,0)
 N KFIXALL ; -- does user hold the MAGDFIX ALL security key?
"RTN","MAGDCCSS",59,0)
 N MAGTYPE ; -- type of image (rad, med, clinspec)
"RTN","MAGDCCSS",60,0)
 ;
"RTN","MAGDCCSS",61,0)
 S KFIXALL=$$SECKEY^MAGDLB12
"RTN","MAGDCCSS",62,0)
 Q:'$D(^MAGD(2006.575,"F"))
"RTN","MAGDCCSS",63,0)
 K ^MAGD(2006.575,"AD")
"RTN","MAGDCCSS",64,0)
 S GWLOC=""
"RTN","MAGDCCSS",65,0)
 F  S GWLOC=$O(^MAGD(2006.575,"F",GWLOC)) Q:GWLOC=""  D
"RTN","MAGDCCSS",66,0)
 . ; if this isn't the user's site, bail unless user holds the
"RTN","MAGDCCSS",67,0)
 . ; MAGDFIX ALL security key
"RTN","MAGDCCSS",68,0)
 . I GWLOC'=DUZ(2),'KFIXALL Q
"RTN","MAGDCCSS",69,0)
 . S MAGSUID=""
"RTN","MAGDCCSS",70,0)
 . F  S MAGSUID=$O(^MAGD(2006.575,"F",GWLOC,MAGSUID)) Q:MAGSUID=""  D
"RTN","MAGDCCSS",71,0)
 . . S MAGIEN=0
"RTN","MAGDCCSS",72,0)
 . . F  S MAGIEN=$O(^MAGD(2006.575,"F",GWLOC,MAGSUID,MAGIEN)) Q:'MAGIEN  D
"RTN","MAGDCCSS",73,0)
 . . . ; if no failed image rec, then there's a xref problem -> bail
"RTN","MAGDCCSS",74,0)
 . . . I '$D(^MAGD(2006.575,MAGIEN,0)) D  Q
"RTN","MAGDCCSS",75,0)
 . . . . K ^MAGD(2006.575,"F",GWLOC,MAGSUID,MAGIEN)
"RTN","MAGDCCSS",76,0)
 . . . . Q
"RTN","MAGDCCSS",77,0)
 . . . ; if entry has already been corrected, do not include in sort
"RTN","MAGDCCSS",78,0)
 . . . I $D(^MAGD(2006.575,MAGIEN,"FIXD")),$P(^("FIXD"),"^") Q
"RTN","MAGDCCSS",79,0)
 . . . ;Only Clinical Specialties images!
"RTN","MAGDCCSS",80,0)
 . . . S MAGTYPE=$P($G(^MAGD(2006.575,MAGIEN,"TYPE")),"^")
"RTN","MAGDCCSS",81,0)
 . . . I MAGTYPE'="CON" Q
"RTN","MAGDCCSS",82,0)
 . . . Q:'$D(^MAGD(2006.575,MAGIEN,1))
"RTN","MAGDCCSS",83,0)
 . . . S MAGDT=$P(^MAGD(2006.575,MAGIEN,1),"^",3)
"RTN","MAGDCCSS",84,0)
 . . . S ^MAGD(2006.575,"AD",MAGDT,MAGIEN)=""
"RTN","MAGDCCSS",85,0)
 . . . Q
"RTN","MAGDCCSS",86,0)
 . . Q
"RTN","MAGDCCSS",87,0)
 . Q
"RTN","MAGDCCSS",88,0)
 Q
"RTN","MAGDCCSS",89,0)
 ;
"RTN","MAGDCCSS",90,0)
PRTDT(SORT,START,STOP) ;
"RTN","MAGDCCSS",91,0)
 ;Print entries using the "AD" cross reference (date order)
"RTN","MAGDCCSS",92,0)
 ; OR the "F" cross reference (unique study uid)
"RTN","MAGDCCSS",93,0)
 I '$D(DUZ) W !,"DUZ variable not defined." Q
"RTN","MAGDCCSS",94,0)
 I "DF"'[SORT Q  ;only the date or unique suid
"RTN","MAGDCCSS",95,0)
 N DIC,BY,FLDS,L,FR,TO
"RTN","MAGDCCSS",96,0)
 S L(0)=2
"RTN","MAGDCCSS",97,0)
 I SORT="D" S SORT="AD" D
"RTN","MAGDCCSS",98,0)
 . I $L($G(START))>1,$L($G(STOP))>1 S FR(0,1)=START,TO(0,1)=STOP
"RTN","MAGDCCSS",99,0)
 . Q
"RTN","MAGDCCSS",100,0)
 S DIC="^MAGD(2006.575,",BY(0)="^MAGD(2006.575,"""_SORT_""","
"RTN","MAGDCCSS",101,0)
 S FLDS="[MAG FAILED IMAGES]",L=0
"RTN","MAGDCCSS",102,0)
 D EN1^DIP
"RTN","MAGDCCSS",103,0)
 Q
"RTN","MAGDCCSS",104,0)
 ;
"RTN","MAGDCCSS",105,0)
ADATE() ;date
"RTN","MAGDCCSS",106,0)
 N DIR,X,Y
"RTN","MAGDCCSS",107,0)
 S DIR(0)="D^",DIR("A")=$G(MESSAGE) D ^DIR
"RTN","MAGDCCSS",108,0)
 Q Y
"RTN","MAGDCCSS",109,0)
 ;
"RTN","MAGDCCSS",110,0)
ASKDT ;Ask date range
"RTN","MAGDCCSS",111,0)
 N MESSAGE
"RTN","MAGDCCSS",112,0)
 S MESSAGE="Enter start date" S STR=$$ADATE
"RTN","MAGDCCSS",113,0)
 Q:'STR
"RTN","MAGDCCSS",114,0)
 I STR'?7N W "Wrong date format." Q
"RTN","MAGDCCSS",115,0)
 S MESSAGE="Enter stop date" S STP=$$ADATE
"RTN","MAGDCCSS",116,0)
 I STP'?7N W "Wrong date format." Q
"RTN","MAGDCCSS",117,0)
 Q
"RTN","MAGDCCSS",118,0)
 ;
"RTN","MAGDCCSS",119,0)
PRNT ;
"RTN","MAGDCCSS",120,0)
 N DIR,X,Y,BY
"RTN","MAGDCCSS",121,0)
 S DIR(0)="S^D:Date;F:Unique Entries"
"RTN","MAGDCCSS",122,0)
 D ^DIR
"RTN","MAGDCCSS",123,0)
 Q:"DF"'[Y
"RTN","MAGDCCSS",124,0)
 I Y="D" D  Q:'$D(STR)!'$D(STP)
"RTN","MAGDCCSS",125,0)
 . D ASKDT Q:'$D(STR)!'$D(STP)
"RTN","MAGDCCSS",126,0)
 . W !,"Please hold sorting by Date. " D SRTDT
"RTN","MAGDCCSS",127,0)
 . Q
"RTN","MAGDCCSS",128,0)
 S BY=Y K DIR,X,Y,DTOUT,DIRUT,DTOUT
"RTN","MAGDCCSS",129,0)
 D PRTDT(BY,$G(STR),$G(STP))
"RTN","MAGDCCSS",130,0)
 K BY,STR,STP
"RTN","MAGDCCSS",131,0)
 Q
"RTN","MAGDCCSS",132,0)
 ;
"RTN","MAGDFB")
0^9^B3801843
"RTN","MAGDFB",1,0)
MAGDFB ;WOIFO/EdM - Call MAGFILEB ; 04/29/2005  08:55
"RTN","MAGDFB",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDFB",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDFB",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDFB",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDFB",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDFB",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDFB",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDFB",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDFB",10,0)
 ;; |                                                               |
"RTN","MAGDFB",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDFB",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDFB",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDFB",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDFB",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDFB",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDFB",17,0)
 ;;
"RTN","MAGDFB",18,0)
 Q
"RTN","MAGDFB",19,0)
 ;
"RTN","MAGDFB",20,0)
 ; The purpose of this subroutine is to call FINDFILE in MAGFILEB
"RTN","MAGDFB",21,0)
 ; in such a way that all parameters are passed in or out,
"RTN","MAGDFB",22,0)
 ; and such that all internal variables of MAGFILEB are NEWed
"RTN","MAGDFB",23,0)
 ;
"RTN","MAGDFB",24,0)
FILEFIND(MAGXX,FILETYPE,MAGJBCP,VERBOSE,MAGFILE1,MAGFILE2,MAGFILE) ;
"RTN","MAGDFB",25,0)
 ; Input:
"RTN","MAGDFB",26,0)
 ;  MAGXX     -- IEN into file 2005, ^MAG(2005,IEN,0)
"RTN","MAGDFB",27,0)
 ;  FILETYPE  -- "FULL", "ABSTRACT" or "BIG"
"RTN","MAGDFB",28,0)
 ;  MAGJBCP   -- Flag: do or don't copy from JukeBox to HardDisk
"RTN","MAGDFB",29,0)
 ;  VERBOSE   -- Flag: do or don't display interactive error messages
"RTN","MAGDFB",30,0)
 ; Output:
"RTN","MAGDFB",31,0)
 ;  MAGFILE1  -- filename
"RTN","MAGDFB",32,0)
 ;  MAGFILE2  -- path + filename
"RTN","MAGDFB",33,0)
 ;  MAGFILE   -- path + filename + $C(0)
"RTN","MAGDFB",34,0)
 ;  MAGPLACE  -- pointer to ^MAG(2006.1) for "place" where image is stored
"RTN","MAGDFB",35,0)
 ;  MAGINST   -- pointer to ^DIC(4) that corresponds to MAGPLACE
"RTN","MAGDFB",36,0)
 ;
"RTN","MAGDFB",37,0)
 N MAGJBOL,MAGOFFLN,MAGPREF,MAGTYPE
"RTN","MAGDFB",38,0)
 D FINDFILE^MAGFILEB
"RTN","MAGDFB",39,0)
 S MAGFILE2=$G(MAGPREF)_MAGFILE1,MAGFILE=MAGFILE2_$C(0)
"RTN","MAGDFB",40,0)
 Q
"RTN","MAGDFB",41,0)
 ;
"RTN","MAGDFCNV")
0^10^B8587373
"RTN","MAGDFCNV",1,0)
MAGDFCNV ;WOIFO/PMK - Read HL7 and generate DICOM ; 06/06/2005  09:14
"RTN","MAGDFCNV",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDFCNV",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDFCNV",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDFCNV",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDFCNV",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDFCNV",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDFCNV",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDFCNV",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDFCNV",10,0)
 ;; |                                                               |
"RTN","MAGDFCNV",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDFCNV",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDFCNV",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDFCNV",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDFCNV",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDFCNV",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDFCNV",17,0)
 ;;
"RTN","MAGDFCNV",18,0)
 ;
"RTN","MAGDFCNV",19,0)
 ; This routine needs to be on both the Gateway and on the VistA HIS.
"RTN","MAGDFCNV",20,0)
 ;
"RTN","MAGDFCNV",21,0)
 ; The M-to-M Broker Gateway can't use $$CONSOLID^MAGBAPI since is
"RTN","MAGDFCNV",22,0)
 ; doesn't have DDP.
"RTN","MAGDFCNV",23,0)
 ;
"RTN","MAGDFCNV",24,0)
 ; Note: The ^MAGOSFIL routine can never be on the VistA HIS.
"RTN","MAGDFCNV",25,0)
 ;
"RTN","MAGDFCNV",26,0)
CONSOLID() ; check if this is a consolidated site or not
"RTN","MAGDFCNV",27,0)
 ; return 0 = non-consolidated (normal) site
"RTN","MAGDFCNV",28,0)
 ; return 1 = consolidated site
"RTN","MAGDFCNV",29,0)
 ;
"RTN","MAGDFCNV",30,0)
 ; code for the main VistA HIS
"RTN","MAGDFCNV",31,0)
 Q $GET(^MAG(2006.1,"CONSOLIDATED"))="YES"
"RTN","MAGDFCNV",32,0)
 ;
"RTN","MAGDFCNV",33,0)
ACQDEV(MFGR,MODEL,SITE) ; get pointer to the Acquisition Device file
"RTN","MAGDFCNV",34,0)
 N ACQDEV ;--- name of acquisition device
"RTN","MAGDFCNV",35,0)
 N ACQDEVP ;-- pointer to acquisition device file (#2006.04)
"RTN","MAGDFCNV",36,0)
 ;
"RTN","MAGDFCNV",37,0)
 S ACQDEV=$$UP^MAGDFCNV(MFGR_" ("_MODEL_")")
"RTN","MAGDFCNV",38,0)
 S ACQDEVP=$O(^MAG(2006.04,"B",ACQDEV,""))
"RTN","MAGDFCNV",39,0)
 I 'ACQDEVP D  ; create the entry
"RTN","MAGDFCNV",40,0)
 . L +^MAG(2006.04,0):1E9 ; serialize name generation code
"RTN","MAGDFCNV",41,0)
 . I '$D(^MAG(2006.04,0)) S ^(0)="ACQUISITION DEVICE^2006.04^^"
"RTN","MAGDFCNV",42,0)
 . S ACQDEVP=$P(^MAG(2006.04,0),"^",3)+1
"RTN","MAGDFCNV",43,0)
 . S ^MAG(2006.04,ACQDEVP,0)=ACQDEV_"^"_SITE_"^" ; 3rd piece is null
"RTN","MAGDFCNV",44,0)
 . S ^MAG(2006.04,"B",ACQDEV,ACQDEVP)=""
"RTN","MAGDFCNV",45,0)
 . S $P(^MAG(2006.04,0),"^",3)=ACQDEVP
"RTN","MAGDFCNV",46,0)
 . S $P(^MAG(2006.04,0),"^",4)=ACQDEVP
"RTN","MAGDFCNV",47,0)
 . L -^MAG(2006.04,0) ; clear the serial name generation code
"RTN","MAGDFCNV",48,0)
 Q ACQDEVP
"RTN","MAGDFCNV",49,0)
 ;
"RTN","MAGDFCNV",50,0)
EQUIVGRP(P1,P2) ; see if two SOP Class pointers are in equivalent groups
"RTN","MAGDFCNV",51,0)
 N G1,G2
"RTN","MAGDFCNV",52,0)
 Q:'$G(P1) 0
"RTN","MAGDFCNV",53,0)
 Q:'$G(P2) 0
"RTN","MAGDFCNV",54,0)
 S G1=$P($G(^MAG(2006.532,P1,0)),"^",3) S:G1="" G1=P1
"RTN","MAGDFCNV",55,0)
 S G2=$P($G(^MAG(2006.532,P2,0)),"^",3) S:G2="" G2=P2
"RTN","MAGDFCNV",56,0)
 Q G1=G2
"RTN","MAGDFCNV",57,0)
 ;
"RTN","MAGDFCNV",58,0)
UP(X) ; special UPPER CASE function -- removes redundant blanks as well
"RTN","MAGDFCNV",59,0)
 F  Q:X'["  "  S $E(X,$F(X,"  ")-1)=""  ; remove redundant blank
"RTN","MAGDFCNV",60,0)
 I $E(X)=" " S $E(X)=""  ; remove leading blank
"RTN","MAGDFCNV",61,0)
 I $E(X,$L(X))=" " S $E(X,$L(X))=""  ; remove trailing blank
"RTN","MAGDFCNV",62,0)
 Q $TR(X,"abcdefghijklmnopqrstuvwxyz^|","ABCDEFGHIJKLMNOPQRSTUVWXYZ~~")
"RTN","MAGDGL")
0^11^B30841791
"RTN","MAGDGL",1,0)
MAGDGL ;WOIFO/EdM - Global Lister ; 05/27/2005  09:23
"RTN","MAGDGL",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDGL",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDGL",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDGL",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDGL",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDGL",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDGL",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDGL",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDGL",10,0)
 ;; |                                                               |
"RTN","MAGDGL",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDGL",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDGL",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDGL",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDGL",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDGL",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDGL",17,0)
 ;;
"RTN","MAGDGL",18,0)
 ; Call Global Variable Lister
"RTN","MAGDGL",19,0)
 N DTIME,I,MAX,N,WILD,OUT,T,X
"RTN","MAGDGL",20,0)
 S DTIME=$G(DTIME,300),MAX=20
"RTN","MAGDGL",21,0)
 F  D  Q:WILD=""
"RTN","MAGDGL",22,0)
 . W !,"Global Variable name: ^" R WILD:DTIME E  S WILD=""
"RTN","MAGDGL",23,0)
 . S:WILD="^" WILD=""
"RTN","MAGDGL",24,0)
 . Q:WILD=""
"RTN","MAGDGL",25,0)
 . S:$E(WILD,1)'="^" WILD="^"_WILD
"RTN","MAGDGL",26,0)
 . S (N,START)=0 F  D  Q:N<MAX  Q:X["^"
"RTN","MAGDGL",27,0)
 . . K OUT
"RTN","MAGDGL",28,0)
 . . D LIST(.OUT,WILD,MAX,START)
"RTN","MAGDGL",29,0)
 . . I OUT(1)<0 D  Q
"RTN","MAGDGL",30,0)
 . . . W !,"Error in processing:",!,OUT(1),!
"RTN","MAGDGL",31,0)
 . . . W !,"Enter a ""wildcard"" that indicates what part of which"
"RTN","MAGDGL",32,0)
 . . . W !,"global variable is to be displayed."
"RTN","MAGDGL",33,0)
 . . . W !,"The following examples show the options:"
"RTN","MAGDGL",34,0)
 . . . W !,"  ^MAG(2005,0)              - one single node"
"RTN","MAGDGL",35,0)
 . . . W !,"  ^MAG(2005,,100)           - 2nd subscript may have any value"
"RTN","MAGDGL",36,0)
 . . . W !,"  ^MAG(2005,50:200,100)     - 2nd subscript must be between 50 and 200"
"RTN","MAGDGL",37,0)
 . . . W !,"  ^MAG(2005,""B"",::%S[""JOHN"" - third subscript must contain specific text"
"RTN","MAGDGL",38,0)
 . . . W !,"  ^MAG(2005,,0:0:%D[""JOHN""  - data must contain specific text"
"RTN","MAGDGL",39,0)
 . . . S X="^"
"RTN","MAGDGL",40,0)
 . . . Q
"RTN","MAGDGL",41,0)
 . . S I=1,N=0 F  S I=$O(OUT(I)) Q:I=""  D
"RTN","MAGDGL",42,0)
 . . . S N=N+2
"RTN","MAGDGL",43,0)
 . . . W !,OUT(I) S T=$O(OUT(I)) Q:T=""
"RTN","MAGDGL",44,0)
 . . . W " = ",OUT(T) S I=T
"RTN","MAGDGL",45,0)
 . . . F  D  Q:T=""
"RTN","MAGDGL",46,0)
 . . . . S T=$O(OUT(T)) Q:T=""  I OUT(T)'="" S T="" Q
"RTN","MAGDGL",47,0)
 . . . . S T=$O(OUT(T)) Q:T=""  W OUT(T) S I=T
"RTN","MAGDGL",48,0)
 . . . . Q
"RTN","MAGDGL",49,0)
 . . . Q
"RTN","MAGDGL",50,0)
 . . I N<MAX S X="^" Q
"RTN","MAGDGL",51,0)
 . . W !!,"More? YES// " R X:DTIME E  S X="^"
"RTN","MAGDGL",52,0)
 . . I X="" S X="YES" W X
"RTN","MAGDGL",53,0)
 . . I "Yy"'[$E(X_"^",1) S X="^" Q
"RTN","MAGDGL",54,0)
 . . S START=OUT(1)
"RTN","MAGDGL",55,0)
 . . Q
"RTN","MAGDGL",56,0)
 . Q
"RTN","MAGDGL",57,0)
 Q
"RTN","MAGDGL",58,0)
 ;
"RTN","MAGDGL",59,0)
LIST(OUT,WILD,MAX,START) ; RPC = MAG DICOM LIST GLOBAL VARIABLE
"RTN","MAGDGL",60,0)
 N %D,E,I,L,M,N,NODE,OK,Q,REF,X
"RTN","MAGDGL",61,0)
 I $D(RPC0) D  Q:'OK
"RTN","MAGDGL",62,0)
 . N KEY,LIST,RET
"RTN","MAGDGL",63,0)
 . S KEY="MAG SYSTEM",LIST(1)=KEY D OWNSKEY^XUSRB(.RET,.LIST,DUZ)
"RTN","MAGDGL",64,0)
 . S OK=$G(RET(1))
"RTN","MAGDGL",65,0)
 . S:'OK OUT(1)="-13,Calling user does not have security key "_KEY
"RTN","MAGDGL",66,0)
 . Q
"RTN","MAGDGL",67,0)
 I $E($G(WILD),1)'="^" S OUT(1)="-1,Invalid wild-card: "_WILD Q
"RTN","MAGDGL",68,0)
 S NODE=0,START=$G(START)\1 S:START<1 START=0
"RTN","MAGDGL",69,0)
 S (N,M)=1,Q=0,REF(1,1,1)="" F I=1:1:$L(WILD) D
"RTN","MAGDGL",70,0)
 . S E=$E(WILD,I)
"RTN","MAGDGL",71,0)
 . I Q S REF(1,N,M)=REF(1,N,M)_E S:E="""" Q=0 Q
"RTN","MAGDGL",72,0)
 . I E="""" S Q=1,REF(1,N,M)=REF(1,N,M)_E Q
"RTN","MAGDGL",73,0)
 . I "()"[E S N=N+1,REF(1,N)=E,N=N+1,M=1,REF(1,N,1)="" Q
"RTN","MAGDGL",74,0)
 . I E="," D  Q
"RTN","MAGDGL",75,0)
 . . I N=1 S M=M+1,REF(1,1,M)=E,M=M+1,REF(1,1,M)="" Q
"RTN","MAGDGL",76,0)
 . . S N=N+1,REF(1,N)=E,N=N+1,M=1,REF(1,N,1)=""
"RTN","MAGDGL",77,0)
 . . Q
"RTN","MAGDGL",78,0)
 . I N=1,"[|]"[E S M=M+1,REF(1,N,M)=E,M=M+1,REF(1,N,M)="" Q
"RTN","MAGDGL",79,0)
 . I " :"[E S M=M+1,REF(1,N,M)=E,M=M+1,REF(1,N,M)="" Q
"RTN","MAGDGL",80,0)
 . S REF(1,N,M)=REF(1,N,M)_E
"RTN","MAGDGL",81,0)
 . Q
"RTN","MAGDGL",82,0)
 K:REF(1,N,M)="" REF(1,N,M)
"RTN","MAGDGL",83,0)
 S REF="",I="" F  S I=$O(REF(1,1,I)) Q:I=""  S REF=REF_REF(1,1,I)
"RTN","MAGDGL",84,0)
 S X="-2,Invalid Global Variable Name "_REF D
"RTN","MAGDGL",85,0)
 . N $ET
"RTN","MAGDGL",86,0)
 . S $ET="S X=X_$EC,$EC="""" Q"
"RTN","MAGDGL",87,0)
 . S X=$D(@REF)
"RTN","MAGDGL",88,0)
 . Q
"RTN","MAGDGL",89,0)
 I X<0 S OUT(1)=X Q
"RTN","MAGDGL",90,0)
 S N=0 D TRAVERSE(3,REF_"(")
"RTN","MAGDGL",91,0)
 S OUT(1)=NODE
"RTN","MAGDGL",92,0)
 Q
"RTN","MAGDGL",93,0)
 ;
"RTN","MAGDGL",94,0)
TRAVERSE(LEV,ROOT) N FROM,IF,NAME,%S,SEP,TO
"RTN","MAGDGL",95,0)
 S NAME=ROOT_"%S)",(FROM,TO,IF)=""
"RTN","MAGDGL",96,0)
 I $O(REF(1,LEV,1))="",$G(REF(1,LEV,1))="" D  Q
"RTN","MAGDGL",97,0)
 . S %S="" F  S %S=$O(@NAME) Q:%S=""  D SHOW Q:N'<MAX
"RTN","MAGDGL",98,0)
 . Q
"RTN","MAGDGL",99,0)
 I $O(REF(1,LEV,1))="" D  Q
"RTN","MAGDGL",100,0)
 . S %S=REF(1,LEV,1)
"RTN","MAGDGL",101,0)
 . D:%S'=""
"RTN","MAGDGL",102,0)
 . . N $ET
"RTN","MAGDGL",103,0)
 . . S $ET="S OK=""-6,Error in subscript-value ""_%S_"": ""_$EC,$EC="""" Q"
"RTN","MAGDGL",104,0)
 . . X "S %S="_%S
"RTN","MAGDGL",105,0)
 . . Q
"RTN","MAGDGL",106,0)
 . D SHOW
"RTN","MAGDGL",107,0)
 . Q
"RTN","MAGDGL",108,0)
 F SEP=2:2 D  Q:'SEP
"RTN","MAGDGL",109,0)
 . I '$O(REF(1,LEV,SEP-2)) S SEP=0 Q
"RTN","MAGDGL",110,0)
 . S (FROM,TO,IF)=""
"RTN","MAGDGL",111,0)
 . I $G(REF(1,LEV,SEP)," ")=" " S %S=REF(1,LEV,SEP-1) D SHOW Q
"RTN","MAGDGL",112,0)
 . S FROM=$G(REF(1,LEV,SEP-1)),TO=$G(REF(1,LEV,SEP+1)),SEP=SEP+2
"RTN","MAGDGL",113,0)
 . S IF="" I $G(REF(1,LEV,SEP))=":" S IF=$G(REF(1,LEV,SEP+1)),SEP=SEP+2
"RTN","MAGDGL",114,0)
 . D:FROM'=""
"RTN","MAGDGL",115,0)
 . . N $ET
"RTN","MAGDGL",116,0)
 . . S $ET="S OK=""-4,Error in from-value ""_FROM_"": ""_$EC,$EC="""" Q"
"RTN","MAGDGL",117,0)
 . . X "S FROM="_FROM
"RTN","MAGDGL",118,0)
 . . Q
"RTN","MAGDGL",119,0)
 . D:TO'=""
"RTN","MAGDGL",120,0)
 . . N $ET
"RTN","MAGDGL",121,0)
 . . S $ET="S OK=""-5,Error in to-value ""_TO_"": ""_$EC,$EC="""" Q"
"RTN","MAGDGL",122,0)
 . . X "S TO="_TO
"RTN","MAGDGL",123,0)
 . . Q
"RTN","MAGDGL",124,0)
 . S %S=FROM F  D SHOW S %S=$O(@NAME) Q:%S=""  I TO'="" Q:%S]]TO
"RTN","MAGDGL",125,0)
 . Q
"RTN","MAGDGL",126,0)
 Q
"RTN","MAGDGL",127,0)
 ;
"RTN","MAGDGL",128,0)
Q(X) I +X=X Q X
"RTN","MAGDGL",129,0)
 N E,I,R
"RTN","MAGDGL",130,0)
 S R="" F I=1:1:$L(X) S E=$E(X,I),R=R_E S:E="""" R=R_E
"RTN","MAGDGL",131,0)
 Q """"_R_""""
"RTN","MAGDGL",132,0)
 ;
"RTN","MAGDGL",133,0)
SHOW N A,C,I,NM,OK,X
"RTN","MAGDGL",134,0)
 Q:%S=""
"RTN","MAGDGL",135,0)
 S OK='$L(IF)
"RTN","MAGDGL",136,0)
 I IF["%S",IF'["%D" D  Q:'OK
"RTN","MAGDGL",137,0)
 . N $ET
"RTN","MAGDGL",138,0)
 . S $ET="S OK=""-3,Error in ""_IF_"": ""_$EC,$EC="""" Q"
"RTN","MAGDGL",139,0)
 . X "I "_IF_" S OK=1"
"RTN","MAGDGL",140,0)
 . Q
"RTN","MAGDGL",141,0)
 D:$D(@NAME)#2
"RTN","MAGDGL",142,0)
 . S %D=@NAME I IF'="" D  Q:'OK
"RTN","MAGDGL",143,0)
 . . N $ET
"RTN","MAGDGL",144,0)
 . . S $ET="S OK=""-3,Error in ""_IF_"": ""_$EC,$EC="""" Q"
"RTN","MAGDGL",145,0)
 . . X "I "_IF_" S OK=1"
"RTN","MAGDGL",146,0)
 . . Q
"RTN","MAGDGL",147,0)
 . I OK<0 W !,OK Q
"RTN","MAGDGL",148,0)
 . S NODE=NODE+1 I START>0 S START=START-1 Q
"RTN","MAGDGL",149,0)
 . S NM=$NA(@NAME)
"RTN","MAGDGL",150,0)
 . S X="""",C=0 F I=1:1:$L(%D) D
"RTN","MAGDGL",151,0)
 . . S A=$A(%D,I)
"RTN","MAGDGL",152,0)
 . . I A>31,A<127,'C S X=X_$C(A) S:A=34 X=X_$C(A) Q
"RTN","MAGDGL",153,0)
 . . I A>31,A<127 S C=0,X=X_")_"""_$C(A) S:A=34 X=X_$C(A) Q
"RTN","MAGDGL",154,0)
 . . I X="""" S X="$C("_A,C=1 Q
"RTN","MAGDGL",155,0)
 . . I C S X=X_","_A Q
"RTN","MAGDGL",156,0)
 . . S X=X_"""_$C("_A,C=1
"RTN","MAGDGL",157,0)
 . . Q
"RTN","MAGDGL",158,0)
 . S X=X_$S(C:")",1:"""")
"RTN","MAGDGL",159,0)
 . F  D  Q:X=""
"RTN","MAGDGL",160,0)
 . . S N=N+1,OUT(N+1)=NM,NM=""
"RTN","MAGDGL",161,0)
 . . S N=N+1,OUT(N+1)=$E(X,1,250),X=$E(X,251,$L(X))
"RTN","MAGDGL",162,0)
 . . Q
"RTN","MAGDGL",163,0)
 . Q
"RTN","MAGDGL",164,0)
 Q:N'<MAX
"RTN","MAGDGL",165,0)
 Q:$G(REF(1,LEV+1))=")"
"RTN","MAGDGL",166,0)
 D:OK TRAVERSE(LEV+2,ROOT_$$Q(%S)_",")
"RTN","MAGDGL",167,0)
 Q
"RTN","MAGDGL",168,0)
 ;
"RTN","MAGDGMRC")
0^12^B32065539
"RTN","MAGDGMRC",1,0)
MAGDGMRC ;WOIFO/PMK - Read a DICOM image file ; 06/06/2005  09:15
"RTN","MAGDGMRC",2,0)
 ;;3.0;IMAGING;**10,51**;26-August-2005
"RTN","MAGDGMRC",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDGMRC",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDGMRC",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDGMRC",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDGMRC",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDGMRC",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDGMRC",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDGMRC",10,0)
 ;; |                                                               |
"RTN","MAGDGMRC",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDGMRC",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDGMRC",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDGMRC",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDGMRC",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDGMRC",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDGMRC",17,0)
 ;;
"RTN","MAGDGMRC",18,0)
 ;
"RTN","MAGDGMRC",19,0)
 ; This is the set of GMRC APIs that are use by the VistA Imaging
"RTN","MAGDGMRC",20,0)
 ; DICOM Gateway
"RTN","MAGDGMRC",21,0)
 ;
"RTN","MAGDGMRC",22,0)
ANYREQ(DFN) ; check if any GMRC requests are present for the patient
"RTN","MAGDGMRC",23,0)
 N ADFN ; ---- array of DFNs to look up
"RTN","MAGDGMRC",24,0)
 N WRK ; ----- work array for our results
"RTN","MAGDGMRC",25,0)
 N IX ; ------ results lookup index
"RTN","MAGDGMRC",26,0)
 N FHIT ; ---- flag - any results for the pt?
"RTN","MAGDGMRC",27,0)
 ;
"RTN","MAGDGMRC",28,0)
 ; ask for requests for the patient
"RTN","MAGDGMRC",29,0)
 S WRK=$NA(^TMP("MAG",$J,$T(+0))) K @WRK
"RTN","MAGDGMRC",30,0)
 S ADFN(1)=DFN
"RTN","MAGDGMRC",31,0)
 D FIND^DIC(123,,"@;.02I","Q",.ADFN,,"F",,,WRK,WRK)
"RTN","MAGDGMRC",32,0)
 ;
"RTN","MAGDGMRC",33,0)
 ; check returns to see if any are actually for this patient (see note
"RTN","MAGDGMRC",34,0)
 ; on SEARCH below)
"RTN","MAGDGMRC",35,0)
 S IX=0
"RTN","MAGDGMRC",36,0)
 F  S IX=$O(@WRK@("DILIST","ID",IX)) Q:'IX  D  Q:$G(FHIT)
"RTN","MAGDGMRC",37,0)
 . I $G(@WRK@("DILIST","ID",IX,.02))=DFN S FHIT=1
"RTN","MAGDGMRC",38,0)
 . Q
"RTN","MAGDGMRC",39,0)
 K @WRK
"RTN","MAGDGMRC",40,0)
 Q +$G(FHIT)
"RTN","MAGDGMRC",41,0)
 ;
"RTN","MAGDGMRC",42,0)
TIULAST(GMRCIEN) ; find the ien of the most recent TIU note for this request
"RTN","MAGDGMRC",43,0)
 N TIUIEN
"RTN","MAGDGMRC",44,0)
 N WRK ; root of work global
"RTN","MAGDGMRC",45,0)
 S TIUIEN=0
"RTN","MAGDGMRC",46,0)
 I GMRCIEN D  ; look for the most recent TIU note for this request
"RTN","MAGDGMRC",47,0)
 . ; set up the array to look through
"RTN","MAGDGMRC",48,0)
 . S WRK=$NA(^TMP("MAG",$J,$T(+0))) K @WRK
"RTN","MAGDGMRC",49,0)
 . D LIST^DIC(123.03,","_GMRCIEN_",",".01I",,,,,,,,WRK,WRK)
"RTN","MAGDGMRC",50,0)
 . ; traverse the array
"RTN","MAGDGMRC",51,0)
 . N TIUPTR
"RTN","MAGDGMRC",52,0)
 . S TIUPTR=" " ; setup for reverse $o from space (" ")
"RTN","MAGDGMRC",53,0)
 . F  S TIUPTR=$O(@WRK@("DILIST","ID",TIUPTR),-1) Q:'TIUPTR  D  Q:TIUIEN
"RTN","MAGDGMRC",54,0)
 . . S TIUIEN=$P($G(@WRK@("DILIST","ID",TIUPTR,.01)),"^",1)
"RTN","MAGDGMRC",55,0)
 . . I $P(TIUIEN,";",2)'="TIU(8925," S TIUIEN=0 ; not a TIU document
"RTN","MAGDGMRC",56,0)
 . . Q
"RTN","MAGDGMRC",57,0)
 . Q
"RTN","MAGDGMRC",58,0)
 K @WRK
"RTN","MAGDGMRC",59,0)
 Q +TIUIEN
"RTN","MAGDGMRC",60,0)
 ;
"RTN","MAGDGMRC",61,0)
TIUALL(GMRCIEN,RESULT) ; find all ien's for the TIU notes for this request
"RTN","MAGDGMRC",62,0)
 N MAGIEN,TIUIEN,TIUPTR,TIUXIEN
"RTN","MAGDGMRC",63,0)
 N WRK ; root of work global
"RTN","MAGDGMRC",64,0)
 K RESULT
"RTN","MAGDGMRC",65,0)
 ; set up the array to look through
"RTN","MAGDGMRC",66,0)
 S WRK=$NA(^TMP("MAG",$J,$T(+0))) K @WRK
"RTN","MAGDGMRC",67,0)
 D LIST^DIC(123.03,","_GMRCIEN_",",".01I",,,,,,,,WRK,WRK)
"RTN","MAGDGMRC",68,0)
 ; traverse the array
"RTN","MAGDGMRC",69,0)
 S (RESULT,TIUPTR)=0
"RTN","MAGDGMRC",70,0)
 F  S TIUPTR=$O(@WRK@("DILIST","ID",TIUPTR)) Q:'TIUPTR  D
"RTN","MAGDGMRC",71,0)
 . S TIUIEN=$P($G(@WRK@("DILIST","ID",TIUPTR,.01)),"^",1)
"RTN","MAGDGMRC",72,0)
 . I $P(TIUIEN,";",2)'="TIU(8925," Q  ; not a TIU document
"RTN","MAGDGMRC",73,0)
 . S TIUIEN=+TIUIEN ; strip off variable pointer stuff
"RTN","MAGDGMRC",74,0)
 . S DIC="^TIU(8925.91,",DIC(0)="SXZ",D="B",X=TIUIEN D IX^DIC Q:Y'>0
"RTN","MAGDGMRC",75,0)
 . S TIUXIEN=+Y,MAGIEN=$P($G(Y(0)),"^",2)
"RTN","MAGDGMRC",76,0)
 . S RESULT=RESULT+1
"RTN","MAGDGMRC",77,0)
 . S RESULT(RESULT)=TIUIEN_"^"_TIUXIEN_"^"_MAGIEN
"RTN","MAGDGMRC",78,0)
 . Q
"RTN","MAGDGMRC",79,0)
 K @WRK
"RTN","MAGDGMRC",80,0)
 Q
"RTN","MAGDGMRC",81,0)
 ;
"RTN","MAGDGMRC",82,0)
FWDFROM(GMRCIEN) ; for a forwarded request, determine the FORWARD FROM service
"RTN","MAGDGMRC",83,0)
 N FWDFROM,I
"RTN","MAGDGMRC",84,0)
 N WRK ; root of work global
"RTN","MAGDGMRC",85,0)
 ; set up the array to look through
"RTN","MAGDGMRC",86,0)
 S WRK=$NA(^TMP("MAG",$J,$T(+0))) K @WRK
"RTN","MAGDGMRC",87,0)
 D LIST^DIC(123.02,","_GMRCIEN_",",".01I;6I",,,,,,,,WRK,WRK)
"RTN","MAGDGMRC",88,0)
 ; traverse the array
"RTN","MAGDGMRC",89,0)
 S FWDFROM=0
"RTN","MAGDGMRC",90,0)
 I GMRCIEN D
"RTN","MAGDGMRC",91,0)
 . S I=$O(@WRK@("DILIST","ID"," "),-1)
"RTN","MAGDGMRC",92,0)
 . I I D  ; get the FORWARDED FROM service
"RTN","MAGDGMRC",93,0)
 . . S FWDFROM=$G(@WRK@("DILIST","ID",I,6))
"RTN","MAGDGMRC",94,0)
 . . Q
"RTN","MAGDGMRC",95,0)
 . Q
"RTN","MAGDGMRC",96,0)
 K @WRK
"RTN","MAGDGMRC",97,0)
 Q +FWDFROM
"RTN","MAGDGMRC",98,0)
 ;
"RTN","MAGDGMRC",99,0)
UNSIGNED(GMRCIEN) ; check if there are any unsigned TIU notes for the request
"RTN","MAGDGMRC",100,0)
 N TIUPTR,NRESULTS,TIUSTAT,UNSIGNED,X
"RTN","MAGDGMRC",101,0)
 N WRK ; root of work global
"RTN","MAGDGMRC",102,0)
 ; set up the array to look through
"RTN","MAGDGMRC",103,0)
 S WRK=$NA(^TMP("MAG",$J,$T(+0))) K @WRK
"RTN","MAGDGMRC",104,0)
 D LIST^DIC(123.03,","_GMRCIEN_",",".01I",,,,,,,,WRK,WRK)
"RTN","MAGDGMRC",105,0)
 S UNSIGNED=0,TIUPTR=""
"RTN","MAGDGMRC",106,0)
 ; traverse the array, check all associated results, bail if any unsigned
"RTN","MAGDGMRC",107,0)
 F  S TIUPTR=$O(@WRK@("DILIST","ID",TIUPTR)) Q:'TIUPTR  D  Q:UNSIGNED
"RTN","MAGDGMRC",108,0)
 . S X=$P($G(@WRK@("DILIST","ID",TIUPTR,.01)),"^",1)
"RTN","MAGDGMRC",109,0)
 . ; if TIU note, check if unsigned
"RTN","MAGDGMRC",110,0)
 . I X?.N1";TIU(8925," D  ; check status of TIU note for completion
"RTN","MAGDGMRC",111,0)
 . . ; status in ^TIU(8925.6) - use first 5 "UN's" per Margy McClenanhan
"RTN","MAGDGMRC",112,0)
 . . S TIUSTAT=$$GET1^DIQ(8925,+X,.05,"I")
"RTN","MAGDGMRC",113,0)
 . . I TIUSTAT,TIUSTAT<6 S UNSIGNED=1 ; got one!
"RTN","MAGDGMRC",114,0)
 . . Q
"RTN","MAGDGMRC",115,0)
 . Q
"RTN","MAGDGMRC",116,0)
 K @WRK
"RTN","MAGDGMRC",117,0)
 Q UNSIGNED
"RTN","MAGDGMRC",118,0)
 ;
"RTN","MAGDGMRC",119,0)
SEARCH(DFN,CUTOFF,CLINIC,REQUEST) ; search for requests for a given clinic
"RTN","MAGDGMRC",120,0)
 ;
"RTN","MAGDGMRC",121,0)
 ; It is a bit of a trick to determine if a given appointment is for
"RTN","MAGDGMRC",122,0)
 ; an existing GMRC request.  This determination is performed by using
"RTN","MAGDGMRC",123,0)
 ; an association between the SERVICE for the request and the CLINIC
"RTN","MAGDGMRC",124,0)
 ; where the request is to be performed.
"RTN","MAGDGMRC",125,0)
 ;
"RTN","MAGDGMRC",126,0)
 ; This subroutine passes all of the (recent) requests for a patient and
"RTN","MAGDGMRC",127,0)
 ; builds a list of those that can be performed in the designated clinic.
"RTN","MAGDGMRC",128,0)
 ;
"RTN","MAGDGMRC",129,0)
 ; Maybe the replacement for Appointment Management and future versions
"RTN","MAGDGMRC",130,0)
 ; of CPRS Order Entry and Consult Request Tracking will capable of
"RTN","MAGDGMRC",131,0)
 ; correctly maintaining this essential association.
"RTN","MAGDGMRC",132,0)
 ;
"RTN","MAGDGMRC",133,0)
 N GMRIDX,GMRC0,GMRCDATE,GMRCIEN,SERVICE,STATUS
"RTN","MAGDGMRC",134,0)
 N WRK ; --- root of results global
"RTN","MAGDGMRC",135,0)
 N ADFN ; -- array for DFNs to look up
"RTN","MAGDGMRC",136,0)
 K REQUEST S REQUEST=0
"RTN","MAGDGMRC",137,0)
 I 'DFN Q  ; no patient number provided
"RTN","MAGDGMRC",138,0)
 ; build the array of results
"RTN","MAGDGMRC",139,0)
 ; Note the use of the "Q[uick]" flag to allow lookup by *internal* DFN.
"RTN","MAGDGMRC",140,0)
 ; However, even though we define ADFN(1) to force lookup on the *first*
"RTN","MAGDGMRC",141,0)
 ; level subscript of the F index only, FileMan also looks up on the IEN
"RTN","MAGDGMRC",142,0)
 ; directly (because there is a .001 field defined in the DD of File
"RTN","MAGDGMRC",143,0)
 ; #123).  So we grab the DFN in the .02 field for later double-
"RTN","MAGDGMRC",144,0)
 ; checking.
"RTN","MAGDGMRC",145,0)
 ;
"RTN","MAGDGMRC",146,0)
 S ADFN(1)=DFN
"RTN","MAGDGMRC",147,0)
 S WRK=$NA(^TMP("MAG",$J,$T(+0))) K @WRK
"RTN","MAGDGMRC",148,0)
 D FIND^DIC(123,,"@;.02I;1I;3I;5I;8I","Q",.ADFN,,"F",,,WRK,WRK)
"RTN","MAGDGMRC",149,0)
 ; traverse the results
"RTN","MAGDGMRC",150,0)
 S GMRIDX=""
"RTN","MAGDGMRC",151,0)
 F  S GMRIDX=$O(@WRK@("DILIST","ID",GMRIDX)) Q:'GMRIDX  D
"RTN","MAGDGMRC",152,0)
 . S GMRCIEN=+$G(@WRK@("DILIST",2,GMRIDX))
"RTN","MAGDGMRC",153,0)
 . I $G(@WRK@("DILIST","ID",GMRIDX,.02))'=DFN Q  ; not for this patient!
"RTN","MAGDGMRC",154,0)
 . I $G(@WRK@("DILIST","ID",GMRIDX,3))<CUTOFF Q  ; too far back
"RTN","MAGDGMRC",155,0)
 . S SERVICE=$G(@WRK@("DILIST","ID",GMRIDX,1)) Q:SERVICE=""
"RTN","MAGDGMRC",156,0)
 . I '$$ISCLINIC^MAGDGMRC(SERVICE,CLINIC) Q  ; not a service or clinic
"RTN","MAGDGMRC",157,0)
 . S STATUS=$G(@WRK@("DILIST","ID",GMRIDX,8)) ; cprs status
"RTN","MAGDGMRC",158,0)
 . I STATUS S STATUS=$$GET1^DIQ(100.01,STATUS,.1) ; cprs status abbrev
"RTN","MAGDGMRC",159,0)
 . S REQUEST=$G(REQUEST)+1
"RTN","MAGDGMRC",160,0)
 . S REQUEST(REQUEST)=GMRCIEN_"^"_SERVICE_"^"_STATUS
"RTN","MAGDGMRC",161,0)
 . Q
"RTN","MAGDGMRC",162,0)
 K @WRK
"RTN","MAGDGMRC",163,0)
 Q
"RTN","MAGDGMRC",164,0)
 ;
"RTN","MAGDGMRC",165,0)
ISCLINIC(SERVICE,CLINIC) ; is a particular clinic defined for a given service?
"RTN","MAGDGMRC",166,0)
 ; this entry point is called by ^MAGDGMRC as well as below
"RTN","MAGDGMRC",167,0)
 N ISCLINIC
"RTN","MAGDGMRC",168,0)
 S ISCLINIC=0
"RTN","MAGDGMRC",169,0)
 I SERVICE,CLINIC,$D(^MAG(2006.5831,SERVICE,1,"B",CLINIC)) S ISCLINIC=1
"RTN","MAGDGMRC",170,0)
 Q ISCLINIC
"RTN","MAGDHWA")
0^13^B58804489
"RTN","MAGDHWA",1,0)
MAGDHWA ;WOIFO/PMK - Capture Consult/Request data ; 06/06/2005  09:18
"RTN","MAGDHWA",2,0)
 ;;3.0;IMAGING;**10,51**;26-August-2005
"RTN","MAGDHWA",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHWA",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHWA",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHWA",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHWA",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHWA",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHWA",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHWA",10,0)
 ;; |                                                               |
"RTN","MAGDHWA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHWA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHWA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHWA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHWA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHWA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHWA",17,0)
 ;;
"RTN","MAGDHWA",18,0)
 Q
"RTN","MAGDHWA",19,0)
 ; entry points called by both ^MAGDHWC and ^MAGDHWS
"RTN","MAGDHWA",20,0)
 ;
"RTN","MAGDHWA",21,0)
MSH ; update MSH segment
"RTN","MAGDHWA",22,0)
 S $P(HL7(1),DEL,5)="VI-CONSULT" ; receiving application
"RTN","MAGDHWA",23,0)
 S $P(HL7(1),DEL,6)=$P(HL7(1),DEL,4) ; receiving facility
"RTN","MAGDHWA",24,0)
 S $P(HL7(1),DEL,7)=$$FMTHL7^XLFDT(FMDATETM)
"RTN","MAGDHWA",25,0)
 Q
"RTN","MAGDHWA",26,0)
 ;
"RTN","MAGDHWA",27,0)
PID ; update PID & PV1 segments
"RTN","MAGDHWA",28,0)
 N ADDRESS,FIRSTNAM,GEOLOC,I,J,LASTNAME,MIDNAME,PNAME
"RTN","MAGDHWA",29,0)
 N VA,VADM,VAIN,VAPA,VAERR,X,WARD,Z
"RTN","MAGDHWA",30,0)
 ; update PID segment
"RTN","MAGDHWA",31,0)
 S I=0 I $$FINDSEG^MAGDHW0(.HL7,"PID",.I,.X) D
"RTN","MAGDHWA",32,0)
 . S DFN=$P(X,DEL,3) D  ; protect I and X
"RTN","MAGDHWA",33,0)
 . . N %,DIQUIET,I,IO,X
"RTN","MAGDHWA",34,0)
 . . S DIQUIET=1 D DEM^VADPT,ADD^VADPT,INP^VADPT
"RTN","MAGDHWA",35,0)
 . . Q
"RTN","MAGDHWA",36,0)
 . S ADDRESS=VAPA(1) ; construct the patient's address string
"RTN","MAGDHWA",37,0)
 . F J=2:1:3 I VAPA(J)'="" S ADDRESS=ADDRESS_"^"_VAPA(J)
"RTN","MAGDHWA",38,0)
 . S GEOLOC=VAPA(4)_"^"_$P(VAPA(5),"^")_"^"_VAPA(6) ; city, state & zip
"RTN","MAGDHWA",39,0)
 . ; stuff the data into the segment
"RTN","MAGDHWA",40,0)
 . S $P(X,DEL,2)=VA("PID") ; patient id - ssn
"RTN","MAGDHWA",41,0)
 . S $P(X,DEL,4)=$E(VADM(1))_VA("BID") ; alt. patient id - quick pid
"RTN","MAGDHWA",42,0)
 . ; format patient name: last~first~middle
"RTN","MAGDHWA",43,0)
 . S LASTNAME=$P(VADM(1),","),Z=$P(VADM(1),",",2,999)
"RTN","MAGDHWA",44,0)
 . S FIRSTNAM=$P(Z," ",1),MIDNAME=$TR($P(Z," ",2,999),".")
"RTN","MAGDHWA",45,0)
 . S $P(X,DEL,5)=LASTNAME_DEL2_FIRSTNAM_DEL2_MIDNAME ; patient name
"RTN","MAGDHWA",46,0)
 . S $P(X,DEL,7)=17000000+VADM(3) ; dob
"RTN","MAGDHWA",47,0)
 . S $P(X,DEL,8)=$P(VADM(5),"^") ; sex
"RTN","MAGDHWA",48,0)
 . S $P(X,DEL,10)=DEL2_$P(VADM(8),"^",2) ; race
"RTN","MAGDHWA",49,0)
 . S $P(X,DEL,11)=$$HLADDR^HLFNC(ADDRESS,GEOLOC,DEL2)
"RTN","MAGDHWA",50,0)
 . S $P(X,DEL,13)=VAPA(8)_DEL2_"PRN" ; primary phone number
"RTN","MAGDHWA",51,0)
 . S $P(X,DEL,19)=$P(VADM(2),"^") ; ssn (without dashes)
"RTN","MAGDHWA",52,0)
 . D SAVESEG^MAGDHW0(I,X)
"RTN","MAGDHWA",53,0)
 . Q
"RTN","MAGDHWA",54,0)
 ;
"RTN","MAGDHWA",55,0)
 ; update PV1 segment for inpatients only
"RTN","MAGDHWA",56,0)
 S I=0 I $$FINDSEG^MAGDHW0(.HL7,"PV1",.I,.X) D
"RTN","MAGDHWA",57,0)
 . ; get assigned patient location
"RTN","MAGDHWA",58,0)
 . I VAIN(1) D  ; inpatient code
"RTN","MAGDHWA",59,0)
 . . S $P(X,DEL,2)="I" ; inpatient flag
"RTN","MAGDHWA",60,0)
 . . ; assigned patient location
"RTN","MAGDHWA",61,0)
 . . S Z=$TR(VAIN(4),"^",DEL5)_DEL5_"VISTA42"
"RTN","MAGDHWA",62,0)
 . . S $P(X,DEL,3)=Z_DEL2_$TR(VAIN(5),"-",DEL2)
"RTN","MAGDHWA",63,0)
 . . ; attending physician
"RTN","MAGDHWA",64,0)
 . . S $P(X,DEL,7)=$TR(VAIN(2),"^, ",DEL2_DEL2_DEL2)
"RTN","MAGDHWA",65,0)
 . . ; referring (primary care) physician
"RTN","MAGDHWA",66,0)
 . . S $P(X,DEL,8)=$TR(VAIN(11),"^, ",DEL2_DEL2_DEL2)
"RTN","MAGDHWA",67,0)
 . . ; hospital service
"RTN","MAGDHWA",68,0)
 . . S $P(X,DEL,10)=$TR(VAIN(3),"^",DEL2)
"RTN","MAGDHWA",69,0)
 . . ; visit number
"RTN","MAGDHWA",70,0)
 . . S $P(X,DEL,19)=VAIN(1)
"RTN","MAGDHWA",71,0)
 . . Q
"RTN","MAGDHWA",72,0)
 . E  S $P(X,DEL,2)="O" ; outpatient flag
"RTN","MAGDHWA",73,0)
 . D SAVESEG^MAGDHW0(I,X)
"RTN","MAGDHWA",74,0)
 . Q
"RTN","MAGDHWA",75,0)
 Q
"RTN","MAGDHWA",76,0)
 ;
"RTN","MAGDHWA",77,0)
ORC ; update ORC segment
"RTN","MAGDHWA",78,0)
 N D0,I,J,NAME,X
"RTN","MAGDHWA",79,0)
 S CONSULT=DEL2 ; consult always contains DEL2
"RTN","MAGDHWA",80,0)
 S I=0 I $$FINDSEG^MAGDHW0(.HL7,"ORC",.I,.X) D
"RTN","MAGDHWA",81,0)
 . ; get consult ien for OBR segment
"RTN","MAGDHWA",82,0)
 . S CONSULT=$P(X,DEL,3)
"RTN","MAGDHWA",83,0)
 . ; add names of order enterer and ordering provider
"RTN","MAGDHWA",84,0)
 . F J=10,12 D
"RTN","MAGDHWA",85,0)
 . . S D0=$P(X,DEL,J),NAME=$S(D0:$$GET1^DIQ(200,D0,.01),1:"")
"RTN","MAGDHWA",86,0)
 . . S NAME=$TR(NAME,", ",DEL2_DEL2)
"RTN","MAGDHWA",87,0)
 . . S $P(X,DEL,J)=D0_DEL2_NAME
"RTN","MAGDHWA",88,0)
 . . Q
"RTN","MAGDHWA",89,0)
 . D SAVESEG^MAGDHW0(I,X)
"RTN","MAGDHWA",90,0)
 . Q
"RTN","MAGDHWA",91,0)
 Q
"RTN","MAGDHWA",92,0)
 ;
"RTN","MAGDHWA",93,0)
OBR ; update OBR segment
"RTN","MAGDHWA",94,0)
 N I,X,Z
"RTN","MAGDHWA",95,0)
 S I=0 I $$FINDSEG^MAGDHW0(.HL7,"OBR",.I,.X) D
"RTN","MAGDHWA",96,0)
 . S $P(X,DEL,3)=CONSULT_DEL2_"L",GMRCIEN=+CONSULT
"RTN","MAGDHWA",97,0)
 . S Z=$$GET1^DIQ(123,GMRCIEN,5,"I") ; urgency
"RTN","MAGDHWA",98,0)
 . I Z S $P(X,DEL,5)=$$GET1^DIQ(101,Z,1) ; priority
"RTN","MAGDHWA",99,0)
 . ;
"RTN","MAGDHWA",100,0)
 . S Z=$$GET1^DIQ(123,GMRCIEN,6,"I") ; place of consult
"RTN","MAGDHWA",101,0)
 . I Z S $P(X,DEL,18)=$$GET1^DIQ(101,Z,1) ; placer field #1
"RTN","MAGDHWA",102,0)
 . ;
"RTN","MAGDHWA",103,0)
 . S Z=$$GET1^DIQ(123,GMRCIEN,13,"I") ; request type
"RTN","MAGDHWA",104,0)
 . S Z=$S(Z="C":"CONSULT",Z="P":"PROCEDURE",1:"UNKNOWN")
"RTN","MAGDHWA",105,0)
 . S $P(X,DEL,19)=Z ; consult/procedure flag - placer field #2
"RTN","MAGDHWA",106,0)
 . ;
"RTN","MAGDHWA",107,0)
 . ; store the current CPRS GMRC or Appointment Scheduling status
"RTN","MAGDHWA",108,0)
 . ; FILLER1 is also set in ^MAGDHRS
"RTN","MAGDHWA",109,0)
 . I '$D(FILLER1) S FILLER1="GMRC-"_$$GET1^DIQ(123,GMRCIEN,8)
"RTN","MAGDHWA",110,0)
 . ; make linkage between the image group and the TIU note, if necessary
"RTN","MAGDHWA",111,0)
 . I MSGTYPE["RESULT",$$NEWTIU(GMRCIEN) S $P(FILLER1,DEL2,2)="LINKED"
"RTN","MAGDHWA",112,0)
 . S $P(X,DEL,20)=FILLER1
"RTN","MAGDHWA",113,0)
 . ;
"RTN","MAGDHWA",114,0)
 . ; store the clinic for the appointment in "filler field 2"
"RTN","MAGDHWA",115,0)
 . I $D(APTSCHED("CLINIC IEN")),$D(APTSCHED("CLINIC NAME")) D
"RTN","MAGDHWA",116,0)
 . . S $P(X,DEL,21)=APTSCHED("CLINIC IEN")_DEL2_APTSCHED("CLINIC NAME")
"RTN","MAGDHWA",117,0)
 . . Q
"RTN","MAGDHWA",118,0)
 . ;
"RTN","MAGDHWA",119,0)
 . ; CPRS Attention - HL7 "Result Copies To" field
"RTN","MAGDHWA",120,0)
 . S Z=$$GET1^DIQ(123,GMRCIEN,7,"I") ; pointer to ^VA(200)
"RTN","MAGDHWA",121,0)
 . I Z S $P(X,DEL,28)=Z_DEL2_$TR($$GET1^DIQ(200,Z,.01),", ",DEL2_DEL2)
"RTN","MAGDHWA",122,0)
 . ;
"RTN","MAGDHWA",123,0)
 . ; date and time of scheduled appointment
"RTN","MAGDHWA",124,0)
 . I $D(APTSCHED("FM DATETIME")) D
"RTN","MAGDHWA",125,0)
 . . S $P(X,DEL,36)=$$FMTHL7^XLFDT(APTSCHED("FM DATETIME"))
"RTN","MAGDHWA",126,0)
 . . Q
"RTN","MAGDHWA",127,0)
 . ;
"RTN","MAGDHWA",128,0)
 . ; from service (requesting service)
"RTN","MAGDHWA",129,0)
 . S Z=$$GET1^DIQ(123,GMRCIEN,2,"I") ; pointer to ^SC(Z)
"RTN","MAGDHWA",130,0)
 . I Z S $P(X,DEL,47)=Z_DEL2_$$GET1^DIQ(44,Z,.01)
"RTN","MAGDHWA",131,0)
 . D SAVESEG^MAGDHW0(I,X)
"RTN","MAGDHWA",132,0)
 . Q
"RTN","MAGDHWA",133,0)
 Q
"RTN","MAGDHWA",134,0)
 ;
"RTN","MAGDHWA",135,0)
ZSV ; find ZSV segment and add imaging type code
"RTN","MAGDHWA",136,0)
 N I,Z
"RTN","MAGDHWA",137,0)
 S I=0 I $$FINDSEG^MAGDHW0(.HL7,"ZSV",.I,.X) D
"RTN","MAGDHWA",138,0)
 . S $P(X,DEL,3)=ITYPCODE_DEL2_ITYPNAME_DEL2_DIVISION
"RTN","MAGDHWA",139,0)
 . S $P(X,DEL,4)=$G(ORIGSERV) ; original service for a FORWARD request
"RTN","MAGDHWA",140,0)
 . D SAVESEG^MAGDHW0(I,X)
"RTN","MAGDHWA",141,0)
 . Q
"RTN","MAGDHWA",142,0)
 Q
"RTN","MAGDHWA",143,0)
 ;
"RTN","MAGDHWA",144,0)
ALLERGY ; check to see if patient has any allergies
"RTN","MAGDHWA",145,0)
 N GMRA,GMRAL,I,X
"RTN","MAGDHWA",146,0)
 D EN1^GMRADPT
"RTN","MAGDHWA",147,0)
 S I=0 F  S I=$O(GMRAL(I)) Q:'I  D  ; include each allergy string as an HL7 OBX segment
"RTN","MAGDHWA",148,0)
 . S OBXSEGNO=OBXSEGNO+1
"RTN","MAGDHWA",149,0)
 . S X="OBX|"_OBXSEGNO_"|TX|A^ALLERGIES^L||",X=$TR(X,"|^",DEL_DEL2)
"RTN","MAGDHWA",150,0)
 . S X=X_$P(GMRAL(I),"^",2)
"RTN","MAGDHWA",151,0)
 . S X=X_DEL_DEL_DEL_DEL_DEL_DEL ; final six delimiters
"RTN","MAGDHWA",152,0)
 . D ADDSEG^MAGDHW0(X)
"RTN","MAGDHWA",153,0)
 . Q
"RTN","MAGDHWA",154,0)
 Q
"RTN","MAGDHWA",155,0)
 ;
"RTN","MAGDHWA",156,0)
POSTINGS ; check if the patient has any other postings
"RTN","MAGDHWA",157,0)
 N I,HIT,MSG
"RTN","MAGDHWA",158,0)
 D ENCOVER^TIUPP3(DFN) I MSG Q  ; MSG="0^Patient posting found"
"RTN","MAGDHWA",159,0)
 S (I,HIT)=0
"RTN","MAGDHWA",160,0)
 F  S I=$O(^TMP("TIUPPCV",$J,I)) Q:'I  I $P(^(I),"^",2)'="A" S HIT=1 Q
"RTN","MAGDHWA",161,0)
 I HIT D
"RTN","MAGDHWA",162,0)
 . S X="OBX|"_OBXSEGNO_"|TX|P^POSTINGS^L||"
"RTN","MAGDHWA",163,0)
 . S X=$TR(X,"|^",DEL_DEL2)
"RTN","MAGDHWA",164,0)
 . S X=X_"Please see CPRS for additional information about Postings."
"RTN","MAGDHWA",165,0)
 . S X=X_DEL_DEL_DEL_DEL_DEL_DEL ; final six delimiters
"RTN","MAGDHWA",166,0)
 . D ADDSEG^MAGDHW0(X)
"RTN","MAGDHWA",167,0)
 . Q
"RTN","MAGDHWA",168,0)
 Q
"RTN","MAGDHWA",169,0)
 ;
"RTN","MAGDHWA",170,0)
NEWTIU(GMRCIEN) ; check if this is a TIU note to be linked to an image group
"RTN","MAGDHWA",171,0)
 ; if so, create the cross-linkages now
"RTN","MAGDHWA",172,0)
 N CROSSREF,D0,FILEDATA,HIT,MAGGP,MAGIEN,NIMAGE,TIUIEN
"RTN","MAGDHWA",173,0)
 S HIT=0
"RTN","MAGDHWA",174,0)
 S D0=""
"RTN","MAGDHWA",175,0)
 F  S D0=$O(^MAG(2006.5839,"C",123,GMRCIEN,D0)) Q:'D0  D
"RTN","MAGDHWA",176,0)
 . S MAGGP=$P($G(^MAG(2006.5839,D0,0)),"^",3) Q:'MAGGP
"RTN","MAGDHWA",177,0)
 . S TIUIEN=$$TIULAST^MAGDGMRC(GMRCIEN) Q:'TIUIEN
"RTN","MAGDHWA",178,0)
 . S $P(^MAG(2005,MAGGP,2),"^",6,7)="8925^"_TIUIEN
"RTN","MAGDHWA",179,0)
 . D TIUXLINK ; create the cross-linkages to TIU
"RTN","MAGDHWA",180,0)
 . ; update the parent file pointers for all the images
"RTN","MAGDHWA",181,0)
 . S CROSSREF="8925^"_TIUIEN_"^"_FILEDATA("PARENT FILE PTR")
"RTN","MAGDHWA",182,0)
 . S NIMAGE=0 F  S NIMAGE=$O(^MAG(2005,MAGGP,1,NIMAGE)) Q:'NIMAGE  D
"RTN","MAGDHWA",183,0)
 . . S MAGIEN=$P(^MAG(2005,MAGGP,1,NIMAGE,0),"^")
"RTN","MAGDHWA",184,0)
 . . S $P(^MAG(2005,MAGIEN,2),"^",6,8)=CROSSREF
"RTN","MAGDHWA",185,0)
 . . Q
"RTN","MAGDHWA",186,0)
 . ; remove entries from ^MAG(2006.5839) & decrement the counter
"RTN","MAGDHWA",187,0)
 . K ^MAG(2006.5839,D0),^MAG(2006.5839,"C",123,GMRCIEN,D0)
"RTN","MAGDHWA",188,0)
 . L +^MAG(2006.5839)
"RTN","MAGDHWA",189,0)
 . S $P(^MAG(2006.5839,0),"^",4)=$P(^MAG(2006.5839,0),"^",4)-1
"RTN","MAGDHWA",190,0)
 . L -^MAG(2006.5839)
"RTN","MAGDHWA",191,0)
 . S HIT=1
"RTN","MAGDHWA",192,0)
 . Q
"RTN","MAGDHWA",193,0)
 Q HIT
"RTN","MAGDHWA",194,0)
 ;
"RTN","MAGDHWA",195,0)
TIUXLINK ; create the cross-linkages to TIU EXTERNAL DATA LINK file
"RTN","MAGDHWA",196,0)
 N TIUXDIEN
"RTN","MAGDHWA",197,0)
 D PUTIMAGE^TIUSRVPL(.TIUXDIEN,TIUIEN,MAGGP)
"RTN","MAGDHWA",198,0)
 I TIUXDIEN D
"RTN","MAGDHWA",199,0)
 . S FILEDATA("PARENT FILE PTR")=TIUXDIEN
"RTN","MAGDHWA",200,0)
 . S $P(^MAG(2005,MAGGP,2),"^",8)=TIUXDIEN
"RTN","MAGDHWA",201,0)
 . Q
"RTN","MAGDHWA",202,0)
 E  D  ; fatal error
"RTN","MAGDHWA",203,0)
 . N MSG
"RTN","MAGDHWA",204,0)
 . S MSG(1)="ERROR ASSOCIATING WITH TIU EXTERNAL DATA LINK (file 8925.91):"
"RTN","MAGDHWA",205,0)
 . S MSG(2)=$P(TIUXDIEN,"^",2,999)
"RTN","MAGDHWA",206,0)
 . S X="ERR^MAGGTERR",@^%ZOSF("TRAP")
"RTN","MAGDHWA",207,0)
 . Q
"RTN","MAGDHWA",208,0)
 Q
"RTN","MAGDHWC")
0^14^B43939437
"RTN","MAGDHWC",1,0)
MAGDHWC ;WOIFO/PMK - Capture Consult/Procedure Request data ; 03/08/2005  07:00
"RTN","MAGDHWC",2,0)
 ;;3.0;IMAGING;**10,51**;26-August-2005
"RTN","MAGDHWC",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHWC",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHWC",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHWC",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHWC",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHWC",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHWC",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHWC",10,0)
 ;; |                                                               |
"RTN","MAGDHWC",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHWC",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHWC",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHWC",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHWC",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHWC",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHWC",17,0)
 ;;
"RTN","MAGDHWC",18,0)
ENTRY ;
"RTN","MAGDHWC",19,0)
 ; determine the kind of message and branch appropriately
"RTN","MAGDHWC",20,0)
 N %,APTSCHED,CONSULT,DATETIME,DEL,DEL2,DEL3,DEL4,DEL5,DFN
"RTN","MAGDHWC",21,0)
 N DIVISION,FILLER1,FWDFROM,FMDATE,FMDATETM,GMRCIEN,HL,HL7,HL7ORC,HL7REC
"RTN","MAGDHWC",22,0)
 N I,IGNORE,ITYPCODE,IGNORE,MSGTYPE,OBXSEGNO,ORIGSERV,SERVICE,X,Y,Z
"RTN","MAGDHWC",23,0)
 I '$D(GMRCMSG) Q  ; can't handle this!
"RTN","MAGDHWC",24,0)
 M HL7=GMRCMSG
"RTN","MAGDHWC",25,0)
 S HL7REC=HL7(1)
"RTN","MAGDHWC",26,0)
 S DEL=$E(HL7REC,4),X=$P(HL7REC,DEL,2)
"RTN","MAGDHWC",27,0)
 F I=1:1:$L(X) S @("DEL"_(I+1))=$E(X,I)
"RTN","MAGDHWC",28,0)
 D NOW^%DTC S FMDATE=%\1,FMDATETM=%
"RTN","MAGDHWC",29,0)
 ;
"RTN","MAGDHWC",30,0)
 S IGNORE=1 ; decide if service is one that requires HL7->DICOM gateway
"RTN","MAGDHWC",31,0)
 ;
"RTN","MAGDHWC",32,0)
 ; find PID segment and get the DFN
"RTN","MAGDHWC",33,0)
 S I=0 I '$$FINDSEG^MAGDHW0(.HL7,"PID",.I,.X) Q  ; no PID segment
"RTN","MAGDHWC",34,0)
 S DFN=$P(X,DEL,3)
"RTN","MAGDHWC",35,0)
 ;
"RTN","MAGDHWC",36,0)
 ; find ORC segment and check for an "OK" order control value
"RTN","MAGDHWC",37,0)
 S I=0 I '$$FINDSEG^MAGDHW0(.HL7,"ORC",.I,.HL7ORC) Q  ; no ORC segment
"RTN","MAGDHWC",38,0)
 S GMRCIEN=+$P(HL7ORC,DEL,3) ; GMRC request is in ^GMR(123,GMRCIEN,...)
"RTN","MAGDHWC",39,0)
 I $P(HL7ORC,DEL)="OK" D  Q  ; generate message by ^MAGDHWS
"RTN","MAGDHWC",40,0)
 . S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHWC",41,0)
 . D SERVICE ; send this transaction to the DICOM gateway?
"RTN","MAGDHWC",42,0)
 . I 'IGNORE D
"RTN","MAGDHWC",43,0)
 . . D INIT^MAGDHW0 ; initialize variables
"RTN","MAGDHWC",44,0)
 . . S DATETIME=""
"RTN","MAGDHWC",45,0)
 . . D MESSAGE^MAGDHWS("O") ; indicates new order
"RTN","MAGDHWC",46,0)
 . . Q
"RTN","MAGDHWC",47,0)
 . Q
"RTN","MAGDHWC",48,0)
 I " CA CR DR OC OD "[(" "_$P(HL7ORC,DEL)_" ") D  Q  ; Discontinued order
"RTN","MAGDHWC",49,0)
 . S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDHWC",50,0)
 . D SERVICE ; send this transaction to the DICOM gateway?
"RTN","MAGDHWC",51,0)
 . I 'IGNORE D
"RTN","MAGDHWC",52,0)
 . . D INIT^MAGDHW0 ; initialize variables
"RTN","MAGDHWC",53,0)
 . . S DATETIME=""
"RTN","MAGDHWC",54,0)
 . . D MESSAGE^MAGDHWS("C") ; Cancelled/Discontinued order
"RTN","MAGDHWC",55,0)
 . . Q
"RTN","MAGDHWC",56,0)
 . Q
"RTN","MAGDHWC",57,0)
 ;
"RTN","MAGDHWC",58,0)
 ; check for a FORWARD in the ORC segment
"RTN","MAGDHWC",59,0)
 I $P($P(HL7ORC,DEL,16),DEL2,5)="FORWARD" D
"RTN","MAGDHWC",60,0)
 . ; get previous service from REQUEST PROCESSING ACTIVITY
"RTN","MAGDHWC",61,0)
 . S FWDFROM=$$FWDFROM^MAGDGMRC(GMRCIEN) ; FORWARDED FROM service
"RTN","MAGDHWC",62,0)
 . S Y=0 I FWDFROM S Y=$G(^MAG(2006.5831,FWDFROM,0))
"RTN","MAGDHWC",63,0)
 . I Y D  ; forwarded from location was one in the service group
"RTN","MAGDHWC",64,0)
 . . N DIVISION,Z
"RTN","MAGDHWC",65,0)
 . . ; original service request probably was sent to DICOM Gateway
"RTN","MAGDHWC",66,0)
 . . S ORIGSERV=DEL2_DEL2_DEL2_FWDFROM_DEL2
"RTN","MAGDHWC",67,0)
 . . S ORIGSERV=ORIGSERV_$S(FWDFROM:$$GET1^DIQ(123.5,FWDFROM,.01),1:"")
"RTN","MAGDHWC",68,0)
 . . S ORIGSERV=ORIGSERV_DEL2_"99CON"
"RTN","MAGDHWC",69,0)
 . . D DIVISION(Y)
"RTN","MAGDHWC",70,0)
 . . S Z=$P(Y,"^",2)
"RTN","MAGDHWC",71,0)
 . . S ITYPNAME=$P(^MAG(2005.84,Z,0),"^",1)
"RTN","MAGDHWC",72,0)
 . . S ITYPCODE=$P(^MAG(2005.84,Z,2),"^",1)
"RTN","MAGDHWC",73,0)
 . . S ORIGSERV=ORIGSERV_DEL_ITYPCODE_DEL2_ITYPNAME_DEL2_DIVISION
"RTN","MAGDHWC",74,0)
 . . S (ITYPCODE,ITYPNAME)="" ; may need them nulled in ZSV^MAGDHWA
"RTN","MAGDHWC",75,0)
 . . S IGNORE=0
"RTN","MAGDHWC",76,0)
 . . Q
"RTN","MAGDHWC",77,0)
 . Q
"RTN","MAGDHWC",78,0)
 ;
"RTN","MAGDHWC",79,0)
 ; find ZSV segment and requested service - check if appropriate
"RTN","MAGDHWC",80,0)
 S I=0 I '$$FINDSEG^MAGDHW0(.HL7,"ZSV",.I,.X) Q  ; no ZSV segment
"RTN","MAGDHWC",81,0)
 S SERVICE=$P($P(X,DEL),DEL2,4)
"RTN","MAGDHWC",82,0)
 D SERVICE ; send this transaction to the DICOM gateway?
"RTN","MAGDHWC",83,0)
 I IGNORE Q  ; just ignore HL7 message, don't send it to DICOM gateway
"RTN","MAGDHWC",84,0)
 ;
"RTN","MAGDHWC",85,0)
 S Z=$P(HL7ORC,DEL,1) ; Order Control
"RTN","MAGDHWC",86,0)
 S Y=$P(HL7ORC,DEL,5) ; Order Status
"RTN","MAGDHWC",87,0)
 I Z="SC" S MSGTYPE="RECEIVED" ; received
"RTN","MAGDHWC",88,0)
 E  I Z="RE" D  ; result
"RTN","MAGDHWC",89,0)
 . I Y="A" S MSGTYPE="PARTIAL RESULT" ; unsigned TIU note
"RTN","MAGDHWC",90,0)
 . E  I Y="CM" D  ; check for a new unsigned note
"RTN","MAGDHWC",91,0)
 . . I $$UNSIGNED^MAGDGMRC(GMRCIEN) D
"RTN","MAGDHWC",92,0)
 . . . S MSGTYPE="PARTIAL RESULT" ; unsigned TIU note
"RTN","MAGDHWC",93,0)
 . . . S FILLER1="GMRC-NEW UNSIGNED RESULT"
"RTN","MAGDHWC",94,0)
 . . . Q
"RTN","MAGDHWC",95,0)
 . . E  S MSGTYPE="COMPLETE RESULT"  ; signed TIU note
"RTN","MAGDHWC",96,0)
 . . Q
"RTN","MAGDHWC",97,0)
 . Q
"RTN","MAGDHWC",98,0)
 E  S MSGTYPE="UNKNOWN"
"RTN","MAGDHWC",99,0)
 D MSH^MAGDHWA,PID^MAGDHWA,ORC^MAGDHWA,OBR^MAGDHWA,ZSV^MAGDHWA
"RTN","MAGDHWC",100,0)
 I '$$OBX() D  ; get OBX segment from database
"RTN","MAGDHWC",101,0)
 . S I=$O(HL7(""),-1)+1 S I=$$OBX^MAGDHWS(I)
"RTN","MAGDHWC",102,0)
 . Q
"RTN","MAGDHWC",103,0)
 E  D  ; process existing OBX segment
"RTN","MAGDHWC",104,0)
 . D OBX1
"RTN","MAGDHWC",105,0)
 . Q
"RTN","MAGDHWC",106,0)
 D ALLERGY^MAGDHWA,POSTINGS^MAGDHWA
"RTN","MAGDHWC",107,0)
 D OUTPUT^MAGDHW0
"RTN","MAGDHWC",108,0)
 Q
"RTN","MAGDHWC",109,0)
 ;
"RTN","MAGDHWC",110,0)
SERVICE ; check if the service is in the DICOM Clinical Service dictionary
"RTN","MAGDHWC",111,0)
 N Y
"RTN","MAGDHWC",112,0)
 I SERVICE D  ; ignore SERVICE if it is null
"RTN","MAGDHWC",113,0)
 . S Y=$G(^MAG(2006.5831,SERVICE,0))
"RTN","MAGDHWC",114,0)
 . S DIVISION=DEL2
"RTN","MAGDHWC",115,0)
 . I Y D  ; new service is of interest to DICOM Gateway
"RTN","MAGDHWC",116,0)
 . . D DIVISION(Y)
"RTN","MAGDHWC",117,0)
 . . S Z=$P(Y,"^",2)
"RTN","MAGDHWC",118,0)
 . . S ITYPNAME=$P(^MAG(2005.84,Z,0),"^",1)
"RTN","MAGDHWC",119,0)
 . . S ITYPCODE=$P(^MAG(2005.84,Z,2),"^",1)
"RTN","MAGDHWC",120,0)
 . . S IGNORE=0
"RTN","MAGDHWC",121,0)
 . . D APPOINT
"RTN","MAGDHWC",122,0)
 . . Q
"RTN","MAGDHWC",123,0)
 . Q
"RTN","MAGDHWC",124,0)
 Q
"RTN","MAGDHWC",125,0)
 ;
"RTN","MAGDHWC",126,0)
DIVISION(Y) ;
"RTN","MAGDHWC",127,0)
 S DIVISION=$P(Y,"^",3)
"RTN","MAGDHWC",128,0)
 S DIVISION=DIVISION_DEL2_$S(DIVISION:$$GET1^DIQ(4,DIVISION,.01),1:"")
"RTN","MAGDHWC",129,0)
 Q
"RTN","MAGDHWC",130,0)
 ;
"RTN","MAGDHWC",131,0)
APPOINT ; quite often the appointment is entered before the order is entered
"RTN","MAGDHWC",132,0)
 ; if this is the case, see if we can find the corresponding appointment
"RTN","MAGDHWC",133,0)
 N CLINIC,HIT,I,LOCIEN,ORDERIEN,VASD,XE,XI
"RTN","MAGDHWC",134,0)
 ; look for appointments for today or later - don't need VASD parameters
"RTN","MAGDHWC",135,0)
 D SDA^VADPT ; get the list of the appointments
"RTN","MAGDHWC",136,0)
 ; first check the order record for the patient location
"RTN","MAGDHWC",137,0)
 ; it might be the clinic for the appointment
"RTN","MAGDHWC",138,0)
 S HIT=0 ; indicator for finding an appointment match
"RTN","MAGDHWC",139,0)
 S ORDERIEN=$$GET1^DIQ(123,GMRCIEN,.03,"I")
"RTN","MAGDHWC",140,0)
 S LOCIEN=$S(ORDERIEN:$$GET1^DIQ(100,ORDERIEN,6,"I"),1:"")
"RTN","MAGDHWC",141,0)
 I LOCIEN?1N.N1";SC(" D
"RTN","MAGDHWC",142,0)
 . S CLINIC=+LOCIEN
"RTN","MAGDHWC",143,0)
 . I $$ISCLINIC^MAGDGMRC(SERVICE,CLINIC) D
"RTN","MAGDHWC",144,0)
 . . S I=0 F  S I=$O(^UTILITY("VASD",$J,I)) Q:'I  Q:HIT  D
"RTN","MAGDHWC",145,0)
 . . . S XI=^UTILITY("VASD",$J,I,"I"),XE=^("E")
"RTN","MAGDHWC",146,0)
 . . . ; check if there is an appointment in this clinic
"RTN","MAGDHWC",147,0)
 . . . I CLINIC=$P(XI,"^",2) D APPOINT1 ; select first apt. in clinic
"RTN","MAGDHWC",148,0)
 . . . Q
"RTN","MAGDHWC",149,0)
 . . Q
"RTN","MAGDHWC",150,0)
 . Q
"RTN","MAGDHWC",151,0)
 I 'HIT D  ; no appointment for the pt. location, look for other clinics
"RTN","MAGDHWC",152,0)
 . S I=0 F  S I=$O(^UTILITY("VASD",$J,I)) Q:'I  Q:HIT  D
"RTN","MAGDHWC",153,0)
 . . S XI=^UTILITY("VASD",$J,I,"I"),XE=^("E")
"RTN","MAGDHWC",154,0)
 . . S CLINIC=$P(XI,"^",2)
"RTN","MAGDHWC",155,0)
 . . I $$ISCLINIC^MAGDGMRC(SERVICE,CLINIC) D APPOINT1
"RTN","MAGDHWC",156,0)
 . . Q
"RTN","MAGDHWC",157,0)
 . Q
"RTN","MAGDHWC",158,0)
 K ^UTILITY("VASD",$J)
"RTN","MAGDHWC",159,0)
 Q
"RTN","MAGDHWC",160,0)
 ;
"RTN","MAGDHWC",161,0)
APPOINT1 ; fill the appointment schedule array
"RTN","MAGDHWC",162,0)
 S APTSCHED("FM DATETIME")=$P(XI,"^")
"RTN","MAGDHWC",163,0)
 S APTSCHED("CLINIC IEN")=CLINIC
"RTN","MAGDHWC",164,0)
 S APTSCHED("DATETIME")=$P(XE,"^")
"RTN","MAGDHWC",165,0)
 S APTSCHED("CLINIC NAME")=$P(XE,"^",2)
"RTN","MAGDHWC",166,0)
 S HIT=1 ; to exit loop
"RTN","MAGDHWC",167,0)
 Q
"RTN","MAGDHWC",168,0)
 ;
"RTN","MAGDHWC",169,0)
OBX() ; find OBX segments to determine the highest value of OBXSEGNO
"RTN","MAGDHWC",170,0)
 N I,X
"RTN","MAGDHWC",171,0)
 S OBXSEGNO=0
"RTN","MAGDHWC",172,0)
 S I=0 F  D  Q:I=""  ; $o through HL7 message - quit when at end
"RTN","MAGDHWC",173,0)
 . I $$FINDSEG^MAGDHW0(.HL7,"OBX",.I,.X) S OBXSEGNO=$P(X,DEL,1)
"RTN","MAGDHWC",174,0)
 . Q
"RTN","MAGDHWC",175,0)
 Q OBXSEGNO
"RTN","MAGDHWC",176,0)
 ;
"RTN","MAGDHWC",177,0)
OBX1 ; if there are second level OBX data, add OBX segment prefix
"RTN","MAGDHWC",178,0)
 ; add additional OBX segments to convey the Reason for the Request
"RTN","MAGDHWC",179,0)
 ; more than one, so can't use "I $$FINDSEG^MAGDHW0(.HL7,"OBX",.I) D  "
"RTN","MAGDHWC",180,0)
 S I="" F  S I=$O(HL7(I)) Q:I=""  I $P(HL7(I),DEL)="OBX" D
"RTN","MAGDHWC",181,0)
 . I '$D(HL7(I,1)) Q  ; no additional OBX segments needed
"RTN","MAGDHWC",182,0)
 . S X=$P(HL7(I),DEL,1,5) ; copy pieces 1-5 to other segments
"RTN","MAGDHWC",183,0)
 . S J="" F  S J=$O(HL7(I,J)) Q:'J  S HL7(I,J)=X_DEL_HL7(I,J)
"RTN","MAGDHWC",184,0)
 . Q
"RTN","MAGDHWC",185,0)
 Q
"RTN","MAGDHWS")
0^15^B24229864
"RTN","MAGDHWS",1,0)
MAGDHWS ;WOIFO/PMK - Capture Consult/GMRC data ; 03/08/2005  09:21
"RTN","MAGDHWS",2,0)
 ;;3.0;IMAGING;**10,11,51**;26-August-2005
"RTN","MAGDHWS",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHWS",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHWS",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHWS",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHWS",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHWS",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHWS",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHWS",10,0)
 ;; |                                                               |
"RTN","MAGDHWS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHWS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHWS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHWS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHWS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHWS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHWS",17,0)
 ;;
"RTN","MAGDHWS",18,0)
ENTRY ; entry point from scheduling package
"RTN","MAGDHWS",19,0)
 N %,AFTERSTS,APTNUMB,APTSCHED,CLINIC,CONSULTM,CUTOFF,DATETIME
"RTN","MAGDHWS",20,0)
 N DEL,DEL2,DEL3,DEL4,DEL5,DFN,DIVISION,DONE,FILLER1,FMDATE,FMDATETM
"RTN","MAGDHWS",21,0)
 N GMRCIEN,HL,IGNORE,IREQ,ITYPCODE,ITYPNAME,MSGTYPE,REQUEST
"RTN","MAGDHWS",22,0)
 N SERVICE,STATUS,UNKNOWN,X,Y,Z
"RTN","MAGDHWS",23,0)
 S APTNUMB=$P(SDATA,"^",1) I APTNUMB<1 Q  ; not a valid appointment
"RTN","MAGDHWS",24,0)
 D INIT^MAGDHW0 ; initialize variables
"RTN","MAGDHWS",25,0)
 D NOW^%DTC S FMDATE=%\1,FMDATETM=%
"RTN","MAGDHWS",26,0)
 S %H=%H-90 D TT^%DTC S CUTOFF=X ; cutoff date is 90 days ago
"RTN","MAGDHWS",27,0)
 S DFN=$P(SDATA,"^",2),DATETIME=$P(SDATA,"^",3),CLINIC=$P(SDATA,"^",4)
"RTN","MAGDHWS",28,0)
 S APTSCHED("CLINIC IEN")=CLINIC,APTSCHED("FM DATETIME")=DATETIME
"RTN","MAGDHWS",29,0)
 S AFTERSTS=SDATA("AFTER","STATUS"),X=$P(AFTERSTS,"^",3)
"RTN","MAGDHWS",30,0)
 ; appointment management transactions from ^SD(409.63)
"RTN","MAGDHWS",31,0)
 I X["CHECKED IN" S FILLER1="SDAM-CHECKIN"
"RTN","MAGDHWS",32,0)
 E  I X["CHECKED OUT" S FILLER1="SDAM-CHECKOUT"
"RTN","MAGDHWS",33,0)
 E  I X["AUTO RE-BOOK" S FILLER1="SDAM-SCHEDULED"
"RTN","MAGDHWS",34,0)
 E  I X["ACTION REQUIRED" S FILLER1="SDAM-SCHEDULED"
"RTN","MAGDHWS",35,0)
 E  I X["NON-COUNT" S FILLER1="SDAM-SCHEDULED"
"RTN","MAGDHWS",36,0)
 E  I X["CANCELLED" S FILLER1="SDAM-CANCELLED"
"RTN","MAGDHWS",37,0)
 E  I X["NO-SHOW" S FILLER1="SDAM-CANCELLED"
"RTN","MAGDHWS",38,0)
 E  I X["DELETED" S FILLER1="SDAM-CANCELLED"
"RTN","MAGDHWS",39,0)
 E  I X="FUTURE" S FILLER1="SDAM-FUTURE"
"RTN","MAGDHWS",40,0)
 E  I X="INPATIENT APPOINTMENT" S FILLER1="SDAM-SCHEDULED"
"RTN","MAGDHWS",41,0)
 E  I X["NO ACTION TAKEN" S FILLER1="SDAM-SCHEDULED"
"RTN","MAGDHWS",42,0)
 I  D  ; if one of the above conditions, do the following
"RTN","MAGDHWS",43,0)
 . S APTSCHED("CLINIC NAME")=$S(CLINIC:$$GET1^DIQ(44,CLINIC,.01),1:"")
"RTN","MAGDHWS",44,0)
 . Q
"RTN","MAGDHWS",45,0)
 E  D  Q
"RTN","MAGDHWS",46,0)
 . W !!,"Unknown Status: """,$P(AFTERSTS,"^",3),""""
"RTN","MAGDHWS",47,0)
 . W !,"Please notify the Imaging Project"
"RTN","MAGDHWS",48,0)
 . R !,"Push <Enter> to continue",X:$G(DTIME,300)
"RTN","MAGDHWS",49,0)
 . Q
"RTN","MAGDHWS",50,0)
 ;
"RTN","MAGDHWS",51,0)
 ; find requests that can be performed in this clinic
"RTN","MAGDHWS",52,0)
 D SEARCH^MAGDGMRC(DFN,CUTOFF,CLINIC,.REQUEST)
"RTN","MAGDHWS",53,0)
 ;
"RTN","MAGDHWS",54,0)
 ; output an HL7 message for each request related to this appointment
"RTN","MAGDHWS",55,0)
 F IREQ=1:1:REQUEST D
"RTN","MAGDHWS",56,0)
 . S GMRCIEN=$P(REQUEST(IREQ),"^",1),SERVICE=$P(REQUEST(IREQ),"^",2)
"RTN","MAGDHWS",57,0)
 . S STATUS=$P(REQUEST(IREQ),"^",3)
"RTN","MAGDHWS",58,0)
 . S IGNORE=1 D SERVICE^MAGDHWC Q:IGNORE  ; not a service of interest
"RTN","MAGDHWS",59,0)
 . ; if {pending, active, scheduled, partially resulted, or complete}
"RTN","MAGDHWS",60,0)
 . I "^p^a^s^pr^c^"[("^"_STATUS_"^") D
"RTN","MAGDHWS",61,0)
 . . ; completed requests can only be checked out or cancelled
"RTN","MAGDHWS",62,0)
 . . I STATUS="c","SDAM-CHECKOUT^SDAM-CANCELLED"'[FILLER1 Q
"RTN","MAGDHWS",63,0)
 . . D MESSAGE("S")
"RTN","MAGDHWS",64,0)
 . . Q
"RTN","MAGDHWS",65,0)
 . Q
"RTN","MAGDHWS",66,0)
 Q
"RTN","MAGDHWS",67,0)
 ;
"RTN","MAGDHWS",68,0)
MESSAGE(MSGTYPE) ; invoked above and also from ^MAGDHWC for the initial order
"RTN","MAGDHWS",69,0)
 N CONSULT,HL7,MSG,NEXT,OBXSEGNO,ORCTRL,ORSTATUS
"RTN","MAGDHWS",70,0)
 I MSGTYPE="O" D  ; ordered - set in ^MAGDHWC
"RTN","MAGDHWS",71,0)
 . S MSGTYPE="ORDERED"
"RTN","MAGDHWS",72,0)
 . S ORCTRL="NW" ; order control
"RTN","MAGDHWS",73,0)
 . S ORSTATUS="IP" ; order status
"RTN","MAGDHWS",74,0)
 . Q
"RTN","MAGDHWS",75,0)
 E  D
"RTN","MAGDHWS",76,0)
 . S MSGTYPE="SCHEDULED"
"RTN","MAGDHWS",77,0)
 . S ORCTRL="SC" ; order control -- status changed
"RTN","MAGDHWS",78,0)
 . S ORSTATUS="ZC" ; scheduling
"RTN","MAGDHWS",79,0)
 . Q
"RTN","MAGDHWS",80,0)
 D MSH^HLFNC2(.HL,100000,.MSG) S $P(MSG,DEL,9)="ORM"
"RTN","MAGDHWS",81,0)
 S NEXT=0
"RTN","MAGDHWS",82,0)
 S NEXT=NEXT+1,HL7(NEXT)=MSG D MSH^MAGDHWA
"RTN","MAGDHWS",83,0)
 S NEXT=NEXT+1,HL7(NEXT)="PID",$P(HL7(NEXT),DEL,1+3)=DFN
"RTN","MAGDHWS",84,0)
 S NEXT=NEXT+1,HL7(NEXT)="PV1"
"RTN","MAGDHWS",85,0)
 D PID^MAGDHWA ; generate PID and PV1 segments
"RTN","MAGDHWS",86,0)
 S NEXT=NEXT+1,HL7(NEXT)=$$ORC D ORC^MAGDHWA
"RTN","MAGDHWS",87,0)
 S NEXT=NEXT+1,HL7(NEXT)=$$OBR D OBR^MAGDHWA
"RTN","MAGDHWS",88,0)
 S NEXT=NEXT+1,HL7(NEXT)=$$ZSV D ZSV^MAGDHWA
"RTN","MAGDHWS",89,0)
 S NEXT=NEXT+1,NEXT=$$OBX(NEXT)
"RTN","MAGDHWS",90,0)
 D ALLERGY^MAGDHWA,POSTINGS^MAGDHWA
"RTN","MAGDHWS",91,0)
 D OUTPUT^MAGDHW0
"RTN","MAGDHWS",92,0)
 Q
"RTN","MAGDHWS",93,0)
 ;
"RTN","MAGDHWS",94,0)
PV1() ; build a PV1 segment
"RTN","MAGDHWS",95,0)
 N X,Z
"RTN","MAGDHWS",96,0)
 S FROM=$$GET1^DIQ(123,GMRCIEN,.04,"I") ; patient location
"RTN","MAGDHWS",97,0)
 S Z=FROM_DEL3_$S(FROM:$$GET1^DIQ(44,FROM,.01),1:"")_DEL3_SERVICE
"RTN","MAGDHWS",98,0)
 S $P(X,DEL,10)=Z
"RTN","MAGDHWS",99,0)
 Q "PV1"_DEL_X
"RTN","MAGDHWS",100,0)
 ;
"RTN","MAGDHWS",101,0)
ORC() ; build an ORC segment
"RTN","MAGDHWS",102,0)
 N ORC,ORCPLCR,ORURG
"RTN","MAGDHWS",103,0)
 S ORCPLCR=$$GET1^DIQ(123,GMRCIEN,10,"I") ; sending provider
"RTN","MAGDHWS",104,0)
 D ORC^GMRCHL7(GMRCIEN,ORCTRL,ORCPLCR,,FMDATETM)
"RTN","MAGDHWS",105,0)
 S $P(ORC,DEL,5+1)=ORSTATUS
"RTN","MAGDHWS",106,0)
 Q ORC
"RTN","MAGDHWS",107,0)
 ;
"RTN","MAGDHWS",108,0)
ZSV() ; build a ZSV segment
"RTN","MAGDHWS",109,0)
 N ZSV
"RTN","MAGDHWS",110,0)
 D ZSV^GMRCHL7(GMRCIEN)
"RTN","MAGDHWS",111,0)
 Q ZSV
"RTN","MAGDHWS",112,0)
 ;
"RTN","MAGDHWS",113,0)
OBR() ; build an OBR segment
"RTN","MAGDHWS",114,0)
 N NOTIFY,OBR
"RTN","MAGDHWS",115,0)
 D OBR^GMRCHL72(GMRCIEN,"",FMDATETM)
"RTN","MAGDHWS",116,0)
 Q OBR
"RTN","MAGDHWS",117,0)
 ;
"RTN","MAGDHWS",118,0)
OBX(NEXT) ; build one or more OBX segments
"RTN","MAGDHWS",119,0)
 N GMRCND,GMRCND1,I,J,OBX,X
"RTN","MAGDHWS",120,0)
 D OBX^GMRCHL72(GMRCIEN)
"RTN","MAGDHWS",121,0)
 S OBXSEGNO=0
"RTN","MAGDHWS",122,0)
 F I=1:1 Q:'$D(OBX(I))  D
"RTN","MAGDHWS",123,0)
 . D OBX1(OBX(I))
"RTN","MAGDHWS",124,0)
 . I $D(OBX(I,1)) S X=$P(OBX(I),DEL,1,5) F J=1:1 Q:'$D(OBX(I,J))  D
"RTN","MAGDHWS",125,0)
 . . D OBX1(X_DEL_OBX(I,J))
"RTN","MAGDHWS",126,0)
 . . Q
"RTN","MAGDHWS",127,0)
 . Q
"RTN","MAGDHWS",128,0)
 Q NEXT
"RTN","MAGDHWS",129,0)
 ;
"RTN","MAGDHWS",130,0)
OBX1(RECORD) ; store one OBX segment into the HL7 array
"RTN","MAGDHWS",131,0)
 S HL7(NEXT)=RECORD
"RTN","MAGDHWS",132,0)
 S OBXSEGNO=$P(RECORD,DEL,2) ; get the highest value of OBXSEGNO
"RTN","MAGDHWS",133,0)
 S NEXT=NEXT+1
"RTN","MAGDHWS",134,0)
 Q
"RTN","MAGDIR8")
0^16^B11043357
"RTN","MAGDIR8",1,0)
MAGDIR8 ;WOIFO/PMK - Read a DICOM image file ; 05/16/2005  09:23
"RTN","MAGDIR8",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDIR8",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR8",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR8",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR8",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR8",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR8",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR8",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR8",10,0)
 ;; |                                                               |
"RTN","MAGDIR8",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR8",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR8",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR8",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR8",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR8",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR8",17,0)
 ;;
"RTN","MAGDIR8",18,0)
 Q
"RTN","MAGDIR8",19,0)
 ; M2MB server
"RTN","MAGDIR8",20,0)
 ;
"RTN","MAGDIR8",21,0)
 ; This routine is invoked by the M2M Broker RPC to process an image.
"RTN","MAGDIR8",22,0)
 ; It extracts each item from the REQUEST list and transfers control
"RTN","MAGDIR8",23,0)
 ; to the appropriate routine to process it.  These routines, in turn,
"RTN","MAGDIR8",24,0)
 ; add items to the RESULT list for processing back on the gateway.
"RTN","MAGDIR8",25,0)
 ;
"RTN","MAGDIR8",26,0)
ENTRY(RESULT,REQUEST) ; RPC = MAG DICOM IMAGE PROCESSING
"RTN","MAGDIR8",27,0)
 N ARGS ; ---- argument string of the REQUEST item
"RTN","MAGDIR8",28,0)
 N DATETIME ;- fileman date/time of the study
"RTN","MAGDIR8",29,0)
 N DCMPID ;--- DICOM patient id
"RTN","MAGDIR8",30,0)
 N DFN ;------ VistA's internal patient identifier
"RTN","MAGDIR8",31,0)
 N ERRCODE ;-- code for an error, if encountered
"RTN","MAGDIR8",32,0)
 N IREQUEST ;- pointer to item in REQUEST array
"RTN","MAGDIR8",33,0)
 N OPCODE ;--- operation code of the REQUEST item
"RTN","MAGDIR8",34,0)
 N RETURN ;--- intermediate return code
"RTN","MAGDIR8",35,0)
 ;
"RTN","MAGDIR8",36,0)
 ; pass the request list and determine what has to be done
"RTN","MAGDIR8",37,0)
 F IREQUEST=2:1:$G(REQUEST(1)) D
"RTN","MAGDIR8",38,0)
 . S OPCODE=$P(REQUEST(IREQUEST),"|")
"RTN","MAGDIR8",39,0)
 . S ARGS=$P(REQUEST(IREQUEST),"|",2,999)
"RTN","MAGDIR8",40,0)
 . I OPCODE="STORE1" D
"RTN","MAGDIR8",41,0)
 . . D ENTRY^MAGDIR81
"RTN","MAGDIR8",42,0)
 . . Q
"RTN","MAGDIR8",43,0)
 . E  I OPCODE="ACQUIRED" D
"RTN","MAGDIR8",44,0)
 . . D ACQUIRED^MAGDIR82
"RTN","MAGDIR8",45,0)
 . . Q
"RTN","MAGDIR8",46,0)
 . E  I OPCODE="PROCESSED" D
"RTN","MAGDIR8",47,0)
 . . D POSTPROC^MAGDIR82
"RTN","MAGDIR8",48,0)
 . . Q
"RTN","MAGDIR8",49,0)
 . E  I OPCODE="CORRECT" D
"RTN","MAGDIR8",50,0)
 . . D ENTRY^MAGDIR83
"RTN","MAGDIR8",51,0)
 . . Q
"RTN","MAGDIR8",52,0)
 . E  I OPCODE="PATIENT SAFETY" D
"RTN","MAGDIR8",53,0)
 . . D ENTRY^MAGDIR84
"RTN","MAGDIR8",54,0)
 . . Q
"RTN","MAGDIR8",55,0)
 . E  I OPCODE="ROLLBACK" D
"RTN","MAGDIR8",56,0)
 . . D ENTRY^MAGDIR85
"RTN","MAGDIR8",57,0)
 . . Q
"RTN","MAGDIR8",58,0)
 . E  I OPCODE="CRASH" D
"RTN","MAGDIR8",59,0)
 . . S I=1/0 ; generate an error on the server to test error trapping
"RTN","MAGDIR8",60,0)
 . . Q
"RTN","MAGDIR8",61,0)
 . E  W !,"#",IREQUEST," -- Ignored: ",REQUEST(IREQUEST)
"RTN","MAGDIR8",62,0)
 . Q
"RTN","MAGDIR8",63,0)
 Q
"RTN","MAGDIR8",64,0)
 ;
"RTN","MAGDIR8",65,0)
ERROR(OPCODE,ERRCODE,MSG,ROUTINE) ; build the RESULT array for the error
"RTN","MAGDIR8",66,0)
 ; this must be called after ^MAGDIRVE is invoked to put the message
"RTN","MAGDIR8",67,0)
 ; into the RESULT array - otherwise the message will be lost
"RTN","MAGDIR8",68,0)
 N I,X
"RTN","MAGDIR8",69,0)
 S X=ERRCODE_"|"_$G(MSG("TITLE"))_"|"_ROUTINE_"|"_$G(MSG("CRITICAL"))
"RTN","MAGDIR8",70,0)
 D RESULT^MAGDIR8(OPCODE,X)
"RTN","MAGDIR8",71,0)
 S I="" F  S I=$O(MSG(I)) Q:'I  D
"RTN","MAGDIR8",72,0)
 . I MSG(I)?1"Problem detected by routine".E  D
"RTN","MAGDIR8",73,0)
 . . ; add error code to the message
"RTN","MAGDIR8",74,0)
 . . S MSG(I)=MSG(I)_"  Error Code: "_ERRCODE
"RTN","MAGDIR8",75,0)
 . . Q
"RTN","MAGDIR8",76,0)
 . D RESULT^MAGDIR8("MSG","|"_MSG(I))
"RTN","MAGDIR8",77,0)
 . Q
"RTN","MAGDIR8",78,0)
 S $P(RESULT(RESULT(1)),"|",2)="END"
"RTN","MAGDIR8",79,0)
 Q
"RTN","MAGDIR8",80,0)
 ;
"RTN","MAGDIR8",81,0)
RESULT(OPCODE,ARGS) ; add an item to the RESULT list
"RTN","MAGDIR8",82,0)
 N LAST
"RTN","MAGDIR8",83,0)
 S LAST=$G(RESULT(1),1) ; first element in array is counter
"RTN","MAGDIR8",84,0)
 S LAST=LAST+1,RESULT(LAST)=OPCODE_"|"_ARGS,RESULT(1)=LAST
"RTN","MAGDIR8",85,0)
 Q
"RTN","MAGDIR81")
0^17^B73980751
"RTN","MAGDIR81",1,0)
MAGDIR81 ;WOIFO/PMK - Read a DICOM image file ; 06/06/2005  09:20
"RTN","MAGDIR81",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDIR81",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR81",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR81",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR81",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR81",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR81",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR81",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR81",10,0)
 ;; |                                                               |
"RTN","MAGDIR81",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR81",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR81",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR81",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR81",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR81",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR81",17,0)
 ;;
"RTN","MAGDIR81",18,0)
 ;
"RTN","MAGDIR81",19,0)
 ; M2MB server
"RTN","MAGDIR81",20,0)
 ;
"RTN","MAGDIR81",21,0)
 ; This routine is invoked by the ^MAGDIR8 for the "STORE1/STORE2"
"RTN","MAGDIR81",22,0)
 ; REQUEST items when there is an image to be stored into the database.
"RTN","MAGDIR81",23,0)
 ; It adds it to the ^MAG global with appropriate pointers to the
"RTN","MAGDIR81",24,0)
 ; "parent data files".
"RTN","MAGDIR81",25,0)
 ;
"RTN","MAGDIR81",26,0)
ENTRY ; process one image
"RTN","MAGDIR81",27,0)
 N MEDATA ;--- medicine pkg patient & study data (set in ^MAGDIR8A)
"RTN","MAGDIR81",28,0)
 N FILEDATA ;- array of data to be passed between routines
"RTN","MAGDIR81",29,0)
 N FIRSTDCM ;- patient first name from the image header (ie, PNAMEDCM)
"RTN","MAGDIR81",30,0)
 N GMRCIEN ;-- internal entry number of consult/procedure request
"RTN","MAGDIR81",31,0)
 N LASTDCM ;-- patient last name from the image header (ie, PNAMEDCM)
"RTN","MAGDIR81",32,0)
 N MAGGP ;---- image's group pointer in ^MAG(2005)
"RTN","MAGDIR81",33,0)
 N MAGIEN ;--- pointer to the entry for the image in ^MAG(2005)
"RTN","MAGDIR81",34,0)
 N MIDCM ;---- patient middle initial from the image header (PNAMEDCM)
"RTN","MAGDIR81",35,0)
 N PNAMEVAH ;- patient name from VADM(1)
"RTN","MAGDIR81",36,0)
 N PROCDESC ;- procedure description (VA's name)
"RTN","MAGDIR81",37,0)
 N RADATA ;--- radiology pkg patient & study data (set in ^MAGDIR8A)
"RTN","MAGDIR81",38,0)
 N VADM ;----- array of demographic variables filled in by DEM^VADPT
"RTN","MAGDIR81",39,0)
 N MAG0,MAG1,MAG2,QUIT,X
"RTN","MAGDIR81",40,0)
 ;
"RTN","MAGDIR81",41,0)
 N ACNUMB,CASENUMB,EMAIL,FROMPATH,IMAGEUID,IMAGNAME,IMAGNUMB,IMGSVC
"RTN","MAGDIR81",42,0)
 N INSTLOC,INSTNAME,LASTIMG,LOCATION,MACHID,MODALITY,MODPARMS
"RTN","MAGDIR81",43,0)
 N MULTFRAM,PID,PNAMEDCM,ROUTRULE,SERINUMB,SERIEUID,SOPCLASS,STATUS
"RTN","MAGDIR81",44,0)
 N STUDYDAT,STUDYTIM,STUDYDAT,STUDYTIM,STUDYUID,SYSTITLE
"RTN","MAGDIR81",45,0)
 ;
"RTN","MAGDIR81",46,0)
 S STATUS=$P(ARGS,"|",1),LOCATION=$P(ARGS,"|",2)
"RTN","MAGDIR81",47,0)
 S MACHID=$P(ARGS,"|",3),IMGSVC=$P(ARGS,"|",4)
"RTN","MAGDIR81",48,0)
 S INSTNAME=$P(ARGS,"|",5),FROMPATH=$P(ARGS,"|",6)
"RTN","MAGDIR81",49,0)
 S PID=$P(ARGS,"|",7),PNAMEDCM=$P(ARGS,"|",8)
"RTN","MAGDIR81",50,0)
 S CASENUMB=$P(ARGS,"|",9),ACNUMB=$P(ARGS,"|",10)
"RTN","MAGDIR81",51,0)
 S STUDYDAT=$P(ARGS,"|",11),STUDYTIM=$P(ARGS,"|",12)
"RTN","MAGDIR81",52,0)
 S MODALITY=$P(ARGS,"|",14)
"RTN","MAGDIR81",53,0)
 S IMAGNAME=$P(ARGS,"|",15),MODPARMS=$P(ARGS,"|",16)
"RTN","MAGDIR81",54,0)
 S SERINUMB=$P(ARGS,"|",17),IMAGNUMB=$P(ARGS,"|",18)
"RTN","MAGDIR81",55,0)
 S INSTLOC=$P(ARGS,"|",19),MULTFRAM=$P(ARGS,"|",20)
"RTN","MAGDIR81",56,0)
 S SYSTITLE=$P(ARGS,"|",21),EMAIL=$P(ARGS,"|",22)
"RTN","MAGDIR81",57,0)
 S IREQUEST=IREQUEST+1,OPCODE=$P(REQUEST(IREQUEST),"|")
"RTN","MAGDIR81",58,0)
 I OPCODE'="STORE2" D  Q
"RTN","MAGDIR81",59,0)
 . D RESULT^MAGDIR8("STORE","-101 Expecting STORE2, got """_OPCODE_"""")
"RTN","MAGDIR81",60,0)
 . Q
"RTN","MAGDIR81",61,0)
 S ARGS=$P(REQUEST(IREQUEST),"|",2,999)
"RTN","MAGDIR81",62,0)
 S STUDYUID=$P(ARGS,"|",1),SERIEUID=$P(ARGS,"|",2)
"RTN","MAGDIR81",63,0)
 S IMAGEUID=$P(ARGS,"|",3),SOPCLASS=$P(ARGS,"|",4)
"RTN","MAGDIR81",64,0)
 S LASTIMG=$P(ARGS,"|",5),ROUTRULE=$P(ARGS,"|",6)
"RTN","MAGDIR81",65,0)
 S MFGR=$P(ARGS,"|",7),MODEL=$P(ARGS,"|",8)
"RTN","MAGDIR81",66,0)
 ;
"RTN","MAGDIR81",67,0)
 ; get a pointer to the image, if it is already on file
"RTN","MAGDIR81",68,0)
 S MAGIEN=$O(^MAG(2005,"P",IMAGEUID,0))
"RTN","MAGDIR81",69,0)
 ;
"RTN","MAGDIR81",70,0)
 ; the following line will have to be adjusted for DICOM SR
"RTN","MAGDIR81",71,0)
 S FILEDATA("TYPE")=$O(^MAG(2005.83,"B","IMAGE",""))
"RTN","MAGDIR81",72,0)
 ;
"RTN","MAGDIR81",73,0)
 I MULTFRAM,MAGIEN D  ; subsequent image of a multiframe object
"RTN","MAGDIR81",74,0)
 . D MULTFRAM ; require both MULTFRAM and MAGIEN to be non-zero
"RTN","MAGDIR81",75,0)
 . Q
"RTN","MAGDIR81",76,0)
 E  D  Q:ERRCODE  ; new image
"RTN","MAGDIR81",77,0)
 . S ERRCODE=$$NEWIMAGE()
"RTN","MAGDIR81",78,0)
 . I ERRCODE D  ; error - abort image processing
"RTN","MAGDIR81",79,0)
 . . D ERROR^MAGDIR8("STORE",ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR81",80,0)
 . . Q
"RTN","MAGDIR81",81,0)
 . Q
"RTN","MAGDIR81",82,0)
 ;
"RTN","MAGDIR81",83,0)
 ;create the image pointer
"RTN","MAGDIR81",84,0)
 I MODPARMS="<DICOM>" D  ; store DICOM image type in VistA
"RTN","MAGDIR81",85,0)
 . S FILEDATA("OBJECT TYPE")=100 ; DICOM image type
"RTN","MAGDIR81",86,0)
 . S FILEDATA("EXTENSION")="EXT^DCM" ; specify the DICOM file extension
"RTN","MAGDIR81",87,0)
 . Q
"RTN","MAGDIR81",88,0)
 E  D  ; convert DICOM image type to TGA and store it in VistA
"RTN","MAGDIR81",89,0)
 . S FILEDATA("OBJECT TYPE")=3 ; XRAY image type
"RTN","MAGDIR81",90,0)
 . S FILEDATA("EXTENSION")="EXT^TGA" ; specify the TGA file extension
"RTN","MAGDIR81",91,0)
 . Q
"RTN","MAGDIR81",92,0)
 S FILEDATA("ABSTRACT")="ABS^STUFFONLY" ; specify the abstract net loc
"RTN","MAGDIR81",93,0)
 ;
"RTN","MAGDIR81",94,0)
 S ERRCODE=$$IMAGE^MAGDIR9B ; create the ^MAG(2005) entry for the image
"RTN","MAGDIR81",95,0)
 I ERRCODE D  ; error - abort image processing
"RTN","MAGDIR81",96,0)
 . D ERROR^MAGDIR8("STORE",ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR81",97,0)
 . Q
"RTN","MAGDIR81",98,0)
 E  D  ; no error
"RTN","MAGDIR81",99,0)
 . S X="0|"_RETURN
"RTN","MAGDIR81",100,0)
 . ; save pname, pid, dob, age, and sex from DEM^VADPT for gateway
"RTN","MAGDIR81",101,0)
 . F I=1:1:5 S X=X_"|"_VADM(I)
"RTN","MAGDIR81",102,0)
 . D RESULT^MAGDIR8("STORE",X)
"RTN","MAGDIR81",103,0)
 . Q
"RTN","MAGDIR81",104,0)
 Q
"RTN","MAGDIR81",105,0)
 ;
"RTN","MAGDIR81",106,0)
NEWIMAGE() ; processing for a new image
"RTN","MAGDIR81",107,0)
 N ERRORMSG ;- error message causing processing to stop
"RTN","MAGDIR81",108,0)
 N PIDCHECK ;- return value of from $$PIDCHECK^MAGDIR8A()
"RTN","MAGDIR81",109,0)
 ;
"RTN","MAGDIR81",110,0)
 I MAGIEN D  I $L(ERRORMSG) Q ERRORMSG
"RTN","MAGDIR81",111,0)
 . K MSG
"RTN","MAGDIR81",112,0)
 . I IMAGEUID=$$GETUID(MACHID) D  ; same image as last one
"RTN","MAGDIR81",113,0)
 . . ; process the image again, after software crash
"RTN","MAGDIR81",114,0)
 . . ; If the software crashed processing the first image, it might
"RTN","MAGDIR81",115,0)
 . . ; delete the image without ever writing it to the file server.
"RTN","MAGDIR81",116,0)
 . . ; Now, the image processing software has a second chance.
"RTN","MAGDIR81",117,0)
 . . S Y=$P($G(^MAG(2005,MAGIEN,2)),"^") I Y D DD^%DT
"RTN","MAGDIR81",118,0)
 . . S MSG(1)="Reprocessing image """_FROMPATH_""""
"RTN","MAGDIR81",119,0)
 . . S MSG(2)="which is partially in the database (#"_MAGIEN_") for"
"RTN","MAGDIR81",120,0)
 . . S MSG(3)=""""_$P($G(^MAG(2005,MAGIEN,0)),"^")_""""
"RTN","MAGDIR81",121,0)
 . . S MSG(4)="Acquired on "_Y
"RTN","MAGDIR81",122,0)
 . . S MSG(5)="UID = "_IMAGEUID
"RTN","MAGDIR81",123,0)
 . . D ERROR^MAGDIR8("STORE","1 Image partially in the database",.MSG,$T(+0))
"RTN","MAGDIR81",124,0)
 . . S ERRORMSG="" ; this is not an error!
"RTN","MAGDIR81",125,0)
 . . Q
"RTN","MAGDIR81",126,0)
 . E  D  ; don't accept images with duplicate UIDs
"RTN","MAGDIR81",127,0)
 . . S Y=$P($G(^MAG(2005,MAGIEN,2)),"^") I Y D DD^%DT
"RTN","MAGDIR81",128,0)
 . . S MSG(1)="Image """_FROMPATH_""""
"RTN","MAGDIR81",129,0)
 . . S MSG(2)="is already in the database (#"_MAGIEN_") for"
"RTN","MAGDIR81",130,0)
 . . S MSG(3)=""""_$P($G(^MAG(2005,MAGIEN,0)),"^")_""""
"RTN","MAGDIR81",131,0)
 . . S MSG(4)="Acquired on "_Y
"RTN","MAGDIR81",132,0)
 . . S MSG(5)="UID = "_IMAGEUID
"RTN","MAGDIR81",133,0)
 . . S ERRORMSG="-1 Image already in database"
"RTN","MAGDIR81",134,0)
 . . Q
"RTN","MAGDIR81",135,0)
 . Q
"RTN","MAGDIR81",136,0)
 ;
"RTN","MAGDIR81",137,0)
 D SAVEUID(MACHID,IMAGEUID) ; record the UID of the image being processed
"RTN","MAGDIR81",138,0)
 ;
"RTN","MAGDIR81",139,0)
 ; lookup the study by ACNUMB/CASENUMB, get DFN, and double-check PID
"RTN","MAGDIR81",140,0)
 S ERRCODE=$$LOOKUP Q:ERRCODE ERRCODE
"RTN","MAGDIR81",141,0)
 ;
"RTN","MAGDIR81",142,0)
 S PIDCHECK=$$PIDCHECK^MAGDIR8A()
"RTN","MAGDIR81",143,0)
 I PIDCHECK D  Q "-2 Image Association Problem" ; didn't find the study
"RTN","MAGDIR81",144,0)
 . N CASETEXT,COLUMNS,MFGR,MODEL,MODIEN,OFFSET,ROWS
"RTN","MAGDIR81",145,0)
 . ; formulate error message
"RTN","MAGDIR81",146,0)
 . K MSG
"RTN","MAGDIR81",147,0)
 . S MSG(1)=PIDCHECK
"RTN","MAGDIR81",148,0)
 . S (ROWS,COLUMNS,OFFSET,MODIEN,MFGR,MODEL,CASETEXT)=""
"RTN","MAGDIR81",149,0)
 . D MOVE^MAGDLBAA
"RTN","MAGDIR81",150,0)
 . Q
"RTN","MAGDIR81",151,0)
 ; create the group pointer
"RTN","MAGDIR81",152,0)
 I IMGSVC="RAD" D  Q:ERRCODE ERRCODE
"RTN","MAGDIR81",153,0)
 . S ERRCODE=$$GROUP^MAGDIR9A
"RTN","MAGDIR81",154,0)
 . Q
"RTN","MAGDIR81",155,0)
 E  I IMGSVC="CON" D  Q:ERRCODE ERRCODE
"RTN","MAGDIR81",156,0)
 . S ERRCODE=$$GROUP^MAGDIR9E
"RTN","MAGDIR81",157,0)
 . Q
"RTN","MAGDIR81",158,0)
 E  D  Q 3  ; undefined imaging service - same as error #4 in LOOKUP
"RTN","MAGDIR81",159,0)
 . K MSG
"RTN","MAGDIR81",160,0)
 . S MSG(1)="Undefined Imaging Service: "_IMGSVC
"RTN","MAGDIR81",161,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR81",162,0)
 . Q
"RTN","MAGDIR81",163,0)
 Q 0
"RTN","MAGDIR81",164,0)
 ;
"RTN","MAGDIR81",165,0)
SAVEUID(MACHID,UID) ; record the UID of the image being processed
"RTN","MAGDIR81",166,0)
 N D0,X
"RTN","MAGDIR81",167,0)
 S D0=$O(^MAGD(2006.5715,"B",MACHID,"")) D:'D0
"RTN","MAGDIR81",168,0)
 . L +^MAGD(2006.5715):1E9 ; Background process MUST wait
"RTN","MAGDIR81",169,0)
 . S D0=$O(^MAGD(2006.5715," "),-1)+1
"RTN","MAGDIR81",170,0)
 . S X=$G(^MAGD(2006.5715,0))
"RTN","MAGDIR81",171,0)
 . S $P(X,"^",1,2)="CURRENT IMAGE^2006.5715"
"RTN","MAGDIR81",172,0)
 . S $P(X,"^",3)=D0
"RTN","MAGDIR81",173,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDIR81",174,0)
 . S ^MAGD(2006.5715,0)=X
"RTN","MAGDIR81",175,0)
 . S ^MAGD(2006.5715,D0,0)=MACHID
"RTN","MAGDIR81",176,0)
 . S ^MAGD(2006.5715,"B",MACHID,D0)=""
"RTN","MAGDIR81",177,0)
 . L -^MAGD(2006.5715)
"RTN","MAGDIR81",178,0)
 . Q
"RTN","MAGDIR81",179,0)
 S $P(^MAGD(2006.5715,D0,0),"^",2)=UID
"RTN","MAGDIR81",180,0)
 Q
"RTN","MAGDIR81",181,0)
 ;
"RTN","MAGDIR81",182,0)
GETUID(MACHID) ; lookup the UID of the last image processed
"RTN","MAGDIR81",183,0)
 N D0
"RTN","MAGDIR81",184,0)
 S D0=+$O(^MAGD(2006.5715,"B",MACHID,""))
"RTN","MAGDIR81",185,0)
 Q $P($G(^MAGD(2006.5715,D0,0)),"^",2)
"RTN","MAGDIR81",186,0)
 ;
"RTN","MAGDIR81",187,0)
MULTFRAM ; Handle additional images in a multiframe object
"RTN","MAGDIR81",188,0)
 ; Get the information from the first image for the additional ones
"RTN","MAGDIR81",189,0)
 ;
"RTN","MAGDIR81",190,0)
 N DIQUIET,INAME,MAG0,MAG40,MAG100,MAGPACS
"RTN","MAGDIR81",191,0)
 N SOPCLASP ; pointer to SOP Class file (#2006.532)
"RTN","MAGDIR81",192,0)
 S MAG0=^MAG(2005,MAGIEN,0),MAG1=$G(^(1)),MAG2=$G(^(2))
"RTN","MAGDIR81",193,0)
 S MAG40=$G(^MAG(2005,MAGIEN,40)),MAG100=$G(^(100))
"RTN","MAGDIR81",194,0)
 S MAGPACS=$G(^MAG(2005,MAGIEN,"PACS"))
"RTN","MAGDIR81",195,0)
 S INAME=$P(MAG0,"^",1) ; field .01
"RTN","MAGDIR81",196,0)
 S PNAMEVAH=$P(INAME,"  ",1),DCMPID=$P(INAME,"  ",2)
"RTN","MAGDIR81",197,0)
 S DFN=$P(MAG0,"^",7) ; field 5
"RTN","MAGDIR81",198,0)
 S MAGGP=$P(MAG0,"^",10) ; field 14
"RTN","MAGDIR81",199,0)
 S DATETIME=$P(MAG2,"^",5) ; field 15
"RTN","MAGDIR81",200,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR81",201,0)
 S FILEDATA("PARENT FILE")=$P(MAG2,"^",6) ; field 16
"RTN","MAGDIR81",202,0)
 S FILEDATA("PARENT IEN")=$P(MAG2,"^",7) ; field 17
"RTN","MAGDIR81",203,0)
 S FILEDATA("PARENT FILE PTR")=$P(MAG2,"^",8) ; field 18
"RTN","MAGDIR81",204,0)
 S FILEDATA("RAD REPORT")=$P(MAGPACS,"^",2) ; field 61
"RTN","MAGDIR81",205,0)
 S FILEDATA("RAD PROC PTR")=$P(MAGPACS,"^",3) ; field 62
"RTN","MAGDIR81",206,0)
 S FILEDATA("PACKAGE")=$P(MAG40,"^",1) ; field 40
"RTN","MAGDIR81",207,0)
 ; field 41 is not needed
"RTN","MAGDIR81",208,0)
 S FILEDATA("TYPE")=$P(MAG40,"^",3) ; field 42
"RTN","MAGDIR81",209,0)
 S FILEDATA("PROC/EVENT")=$P(MAG40,"^",4) ; field 43
"RTN","MAGDIR81",210,0)
 S FILEDATA("SPEC/SUBSPEC")=$P(MAG40,"^",5) ; field 44
"RTN","MAGDIR81",211,0)
 S FILEDATA("ACQUISITION DEVICE")=$P(MAG100,"^",4) ; field 107
"RTN","MAGDIR81",212,0)
 ; get the SOP Class pointer (file 2005, field 251)
"RTN","MAGDIR81",213,0)
 S SOPCLASP=$O(^MAG(2006.532,"B",SOPCLASS,""))
"RTN","MAGDIR81",214,0)
 S FILEDATA("SOP CLASS POINTER")=SOPCLASP
"RTN","MAGDIR81",215,0)
 S PROCDESC=$P(MAG2,"^",4) ; field 10
"RTN","MAGDIR81",216,0)
 ; S X="" F  S X=$O(FILEDATA(X)) Q:X=""  I FILEDATA(X)="" K FILEDATA(X)
"RTN","MAGDIR81",217,0)
 I PROCDESC?.E1" (#".N1")" S PROCDESC=$P(PROCDESC," (#")
"RTN","MAGDIR81",218,0)
 ; lookup patient in VistA database - needed to build VADM array
"RTN","MAGDIR81",219,0)
 S DIQUIET=1 D DEM^VADPT
"RTN","MAGDIR81",220,0)
 Q
"RTN","MAGDIR81",221,0)
 ;
"RTN","MAGDIR81",222,0)
LOOKUP() ; lookup the patient/study using cross-reference
"RTN","MAGDIR81",223,0)
 I IMGSVC="RAD" D
"RTN","MAGDIR81",224,0)
 . D RADLKUP^MAGDIR8A
"RTN","MAGDIR81",225,0)
 . Q
"RTN","MAGDIR81",226,0)
 E  I IMGSVC="CON" D
"RTN","MAGDIR81",227,0)
 . S ACNUMB=CASENUMB
"RTN","MAGDIR81",228,0)
 . D CONLKUP^MAGDIR8A
"RTN","MAGDIR81",229,0)
 . Q
"RTN","MAGDIR81",230,0)
 E  D  Q 4 ; undefined imaging service - same as error #3 in NEWIMAGE
"RTN","MAGDIR81",231,0)
 . K MSG
"RTN","MAGDIR81",232,0)
 . S MSG(1)="Undefined Imaging Service: "_IMGSVC
"RTN","MAGDIR81",233,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR81",234,0)
 . Q
"RTN","MAGDIR81",235,0)
 Q 0
"RTN","MAGDIR82")
0^18^B61661475
"RTN","MAGDIR82",1,0)
MAGDIR82 ;WOIFO/PMK - Read a DICOM image file ; 06/06/2005  09:20
"RTN","MAGDIR82",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDIR82",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR82",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR82",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR82",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR82",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR82",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR82",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR82",10,0)
 ;; |                                                               |
"RTN","MAGDIR82",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR82",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR82",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR82",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR82",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR82",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR82",17,0)
 ;;
"RTN","MAGDIR82",18,0)
 ; M2MB server
"RTN","MAGDIR82",19,0)
 ;
"RTN","MAGDIR82",20,0)
 ; This routine is invoked by the ^MAGDIR8 to update statistics & add
"RTN","MAGDIR82",21,0)
 ; an image to the background processor and auto-router queues.
"RTN","MAGDIR82",22,0)
 ;
"RTN","MAGDIR82",23,0)
 ; There are two entry points, one for the "ACQUIRED" RESULT item, and
"RTN","MAGDIR82",24,0)
 ; the other (POSTPROC) for the "PROCESSED" RESULT item.
"RTN","MAGDIR82",25,0)
 ;
"RTN","MAGDIR82",26,0)
ACQUIRED ; update image acquisition statistics
"RTN","MAGDIR82",27,0)
 N INSTNAME,LOCATION,STATUS
"RTN","MAGDIR82",28,0)
 S STATUS=$P(ARGS,"|",1)
"RTN","MAGDIR82",29,0)
 S LOCATION=$P(ARGS,"|",2)
"RTN","MAGDIR82",30,0)
 S INSTNAME=$P(ARGS,"|",3)
"RTN","MAGDIR82",31,0)
 D COUNT("ACQUIRED")
"RTN","MAGDIR82",32,0)
 Q
"RTN","MAGDIR82",33,0)
 ;
"RTN","MAGDIR82",34,0)
POSTPROC ; update image processing statistics and add to BP & AR queues
"RTN","MAGDIR82",35,0)
 N COUNTFLG,ERRCODE,EVAL,I,IMAGEPTR,INSTNAME,LOCATION,MACHID,MSG,STATUS
"RTN","MAGDIR82",36,0)
 S STATUS=$P(ARGS,"|",1)
"RTN","MAGDIR82",37,0)
 S LOCATION=$P(ARGS,"|",2)
"RTN","MAGDIR82",38,0)
 S INSTNAME=$P(ARGS,"|",3)
"RTN","MAGDIR82",39,0)
 S IMAGEPTR=$P(ARGS,"|",4)
"RTN","MAGDIR82",40,0)
 S COUNTFLG=$P(ARGS,"|",5) ; zero for multiframe images
"RTN","MAGDIR82",41,0)
 S EVAL=$P(ARGS,"|",6)
"RTN","MAGDIR82",42,0)
 S MACHID=$P(ARGS,"|",7)
"RTN","MAGDIR82",43,0)
 I COUNTFLG D
"RTN","MAGDIR82",44,0)
 . D COUNT("PROCESSED") ; update the count
"RTN","MAGDIR82",45,0)
 . D SAVEUID^MAGDIR81(MACHID,"") ; clear the last image UID
"RTN","MAGDIR82",46,0)
 . Q
"RTN","MAGDIR82",47,0)
 ;
"RTN","MAGDIR82",48,0)
 S ERRCODE=""
"RTN","MAGDIR82",49,0)
 ;
"RTN","MAGDIR82",50,0)
 I $$CONSOLID^MAGDFCNV D
"RTN","MAGDIR82",51,0)
 . D POSTPRO2 ; consolidation code
"RTN","MAGDIR82",52,0)
 . Q
"RTN","MAGDIR82",53,0)
 E  D
"RTN","MAGDIR82",54,0)
 . D POSTPRO1 ; non-consolidation code
"RTN","MAGDIR82",55,0)
 . Q
"RTN","MAGDIR82",56,0)
 I ERRCODE="" D
"RTN","MAGDIR82",57,0)
 . D RESULT^MAGDIR8(OPCODE,"|"_$P(ARGS,"|",2,999))
"RTN","MAGDIR82",58,0)
 . Q
"RTN","MAGDIR82",59,0)
 E  D
"RTN","MAGDIR82",60,0)
 . D ERROR^MAGDIR8(OPCODE,ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR82",61,0)
 . Q
"RTN","MAGDIR82",62,0)
 Q
"RTN","MAGDIR82",63,0)
 ;
"RTN","MAGDIR82",64,0)
POSTPRO1 ; non-consolidation code version of post processing
"RTN","MAGDIR82",65,0)
 ; add the image to the jukebox queue
"RTN","MAGDIR82",66,0)
 D:'$$JUKEBOX^MAGBAPI(IMAGEPTR)
"RTN","MAGDIR82",67,0)
 . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",68,0)
 . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",69,0)
 . S I=I+1,MSG(I)="JUKEBOX QUEUE CREATION ERROR:"
"RTN","MAGDIR82",70,0)
 . S I=I+1,MSG(I)="An image has not been entered into the jukebox queue."
"RTN","MAGDIR82",71,0)
 . S I=I+1,MSG(I)="Image pointer: "_IMAGEPTR
"RTN","MAGDIR82",72,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",73,0)
 . S ERRCODE=-401
"RTN","MAGDIR82",74,0)
 . Q
"RTN","MAGDIR82",75,0)
 ;
"RTN","MAGDIR82",76,0)
 D:EVAL  ; Add the image to the routing evaluator queue
"RTN","MAGDIR82",77,0)
 . D WARNROUT(0)
"RTN","MAGDIR82",78,0)
 . D:$$EVAL^MAGBAPI(IMAGEPTR)<0
"RTN","MAGDIR82",79,0)
 . . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",80,0)
 . . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",81,0)
 . . S I=I+1,MSG(I)="AUTOROUTER EVALUATION QUEUE CREATION ERROR:"
"RTN","MAGDIR82",82,0)
 . . S I=I+1,MSG(I)="An image could not be evaluated for autorouting purposes."
"RTN","MAGDIR82",83,0)
 . . S I=I+1,MSG(I)="Image pointer: "_IMAGEPTR
"RTN","MAGDIR82",84,0)
 . . S I=I+1,MSG(I)="Error code is """_Z_"""."
"RTN","MAGDIR82",85,0)
 . . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",86,0)
 . . S ERRCODE=ERRCODE_"-402"
"RTN","MAGDIR82",87,0)
 . . Q
"RTN","MAGDIR82",88,0)
 . Q
"RTN","MAGDIR82",89,0)
 Q
"RTN","MAGDIR82",90,0)
 ;
"RTN","MAGDIR82",91,0)
POSTPRO2 ; consolidation code version of post processing
"RTN","MAGDIR82",92,0)
 N PLACE
"RTN","MAGDIR82",93,0)
 S PLACE=$O(^MAG(2006.1,"B",LOCATION,""))
"RTN","MAGDIR82",94,0)
 ;
"RTN","MAGDIR82",95,0)
 ; add the image to the jukebox queue
"RTN","MAGDIR82",96,0)
 D:'$$JUKEBOX^MAGBAPI(IMAGEPTR,PLACE)
"RTN","MAGDIR82",97,0)
 . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",98,0)
 . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",99,0)
 . S I=I+1,MSG(I)="JUKEBOX QUEUE CREATION ERROR:"
"RTN","MAGDIR82",100,0)
 . S I=I+1,MSG(I)="An image has not been entered into the jukebox queue."
"RTN","MAGDIR82",101,0)
 . S I=I+1,MSG(I)="Image pointer: "_IMAGEPTR_"   Location: "_LOCATION
"RTN","MAGDIR82",102,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",103,0)
 . S ERRCODE=-403
"RTN","MAGDIR82",104,0)
 . Q
"RTN","MAGDIR82",105,0)
 ;
"RTN","MAGDIR82",106,0)
 D:EVAL  ; Add the image to the routing evaluator queue
"RTN","MAGDIR82",107,0)
 . D WARNROUT(PLACE)
"RTN","MAGDIR82",108,0)
 . D:$$EVAL^MAGBAPI(IMAGEPTR,PLACE)<0
"RTN","MAGDIR82",109,0)
 . . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",110,0)
 . . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",111,0)
 . . S I=I+1,MSG(I)="AUTOROUTER EVALUATION QUEUE CREATION ERROR:"
"RTN","MAGDIR82",112,0)
 . . S I=I+1,MSG(I)="An image could not be evaluated for autorouting purposes."
"RTN","MAGDIR82",113,0)
 . . S I=I+1,MSG(I)="Image pointer: "_IMAGEPTR_"   Place: "_PLACE
"RTN","MAGDIR82",114,0)
 . . S I=I+1,MSG(I)="Error code is """_Z_"""."
"RTN","MAGDIR82",115,0)
 . . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",116,0)
 . . S ERRCODE=ERRCODE_"-404"
"RTN","MAGDIR82",117,0)
 . . Q
"RTN","MAGDIR82",118,0)
 . Q
"RTN","MAGDIR82",119,0)
 Q
"RTN","MAGDIR82",120,0)
 ;
"RTN","MAGDIR82",121,0)
COUNT(STEP) ; update today's count
"RTN","MAGDIR82",122,0)
 N %,D2,%H,NOW,PC,TODAY,X
"RTN","MAGDIR82",123,0)
 D NOW^%DTC S TODAY=X,NOW=%
"RTN","MAGDIR82",124,0)
 L +^MAGDAUDT(2006.5762,TODAY)
"RTN","MAGDIR82",125,0)
 D:'$D(^MAGDAUDT(2006.5762,TODAY))
"RTN","MAGDIR82",126,0)
 . S X=$G(^MAGDAUDT(2006.5762,0))
"RTN","MAGDIR82",127,0)
 . S $P(X,"^",1,2)="DICOM INSTRUMENT STATISTICS^2006.5762"
"RTN","MAGDIR82",128,0)
 . S $P(X,"^",3)=TODAY
"RTN","MAGDIR82",129,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDIR82",130,0)
 . S ^MAGDAUDT(2006.5762,0)=X
"RTN","MAGDIR82",131,0)
 . S ^MAGDAUDT(2006.5762,TODAY,0)=TODAY
"RTN","MAGDIR82",132,0)
 . S ^MAGDAUDT(2006.5762,"B",TODAY,TODAY)=""
"RTN","MAGDIR82",133,0)
 . Q
"RTN","MAGDIR82",134,0)
 S D2=$O(^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,"B",INSTNAME,""))
"RTN","MAGDIR82",135,0)
 D:'D2
"RTN","MAGDIR82",136,0)
 . S D2=$O(^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1," "),-1)+1
"RTN","MAGDIR82",137,0)
 . S X=$G(^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,0))
"RTN","MAGDIR82",138,0)
 . S $P(X,"^",2)="2006.576211"
"RTN","MAGDIR82",139,0)
 . S $P(X,"^",3)=D2
"RTN","MAGDIR82",140,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDIR82",141,0)
 . S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,0)=LOCATION
"RTN","MAGDIR82",142,0)
 . S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,0)=X
"RTN","MAGDIR82",143,0)
 . S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,D2,0)=INSTNAME
"RTN","MAGDIR82",144,0)
 . S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,"B",INSTNAME,D2)=""
"RTN","MAGDIR82",145,0)
 . Q
"RTN","MAGDIR82",146,0)
 S X=$G(^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,D2,0))
"RTN","MAGDIR82",147,0)
 S PC=$S(STEP="ACQUIRED":2,STEP="PROCESSED":4,1:6)
"RTN","MAGDIR82",148,0)
 S $P(X,"^",PC)=$P(X,"^",PC)+1
"RTN","MAGDIR82",149,0)
 S $P(X,"^",PC+1)=NOW
"RTN","MAGDIR82",150,0)
 S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,D2,0)=X
"RTN","MAGDIR82",151,0)
 L -^MAGDAUDT(2006.5762,TODAY)
"RTN","MAGDIR82",152,0)
 Q
"RTN","MAGDIR82",153,0)
 ;
"RTN","MAGDIR82",154,0)
WARNROUT(PLACE) N LAST,X1,X2,X3
"RTN","MAGDIR82",155,0)
 D:'PLACE
"RTN","MAGDIR82",156,0)
 . S PLACE=$$PLACE^MAGDRPC2(LOCATION)
"RTN","MAGDIR82",157,0)
 . Q
"RTN","MAGDIR82",158,0)
 S LAST=$G(^MAG(2006.1,+PLACE,"LASTROUTE"))
"RTN","MAGDIR82",159,0)
 S (X2,X3)=LAST\1 D:X3
"RTN","MAGDIR82",160,0)
 . N DEST,E,I,PRI,T
"RTN","MAGDIR82",161,0)
 . S X1=DT D ^%DTC Q:X<7
"RTN","MAGDIR82",162,0)
 . S X2=$P(LAST,"^",2) Q:X2'<DT  ; Only send one message per day
"RTN","MAGDIR82",163,0)
 . S (E,T,I)=0 F  S I=$O(^MAGQUEUE(2006.03,"C",PLACE,"EVAL",I)) Q:I=""  S E=E+1
"RTN","MAGDIR82",164,0)
 . S PRI="" F  S PRI=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI)) Q:PRI=""  D
"RTN","MAGDIR82",165,0)
 . . S DEST="" F  S DEST=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DEST)) Q:DEST=""  D
"RTN","MAGDIR82",166,0)
 . . . S I="" F  S I=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DEST,I)) Q:I=""  S T=T+1
"RTN","MAGDIR82",167,0)
 . . . Q
"RTN","MAGDIR82",168,0)
 . . Q
"RTN","MAGDIR82",169,0)
 . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",170,0)
 . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",171,0)
 . S I=I+1,MSG(I)="More than a week has elapsed since "_(X3#100)_"-"_$P("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"," ",X3\100#100)_"-"_(X3\10000+1700)
"RTN","MAGDIR82",172,0)
 . S I=I+1,MSG(I)="when the last activity occurred that is related"
"RTN","MAGDIR82",173,0)
 . S I=I+1,MSG(I)="to the processing of Routed Image files."
"RTN","MAGDIR82",174,0)
 . S I=I+1,MSG(I)=" "
"RTN","MAGDIR82",175,0)
 . S I=I+1,MSG(I)="The site parameter for ""This is a Routing Site"" is"
"RTN","MAGDIR82",176,0)
 . S I=I+1,MSG(I)="currently turned ON."
"RTN","MAGDIR82",177,0)
 . S I=I+1,MSG(I)="If this site is no longer actively routing image files"
"RTN","MAGDIR82",178,0)
 . S I=I+1,MSG(I)="this site parameter must be turned OFF."
"RTN","MAGDIR82",179,0)
 . S I=I+1,MSG(I)="This parameter needs to be turned OFF on each VistA"
"RTN","MAGDIR82",180,0)
 . S I=I+1,MSG(I)="DICOM Gateway that processes incoming images."
"RTN","MAGDIR82",181,0)
 . S I=I+1,MSG(I)=" "
"RTN","MAGDIR82",182,0)
 . S I=I+1,MSG(I)="There are currently "_E_" entr"_$S(E=1:"y",1:"ies")
"RTN","MAGDIR82",183,0)
 . S I=I+1,MSG(I)="waiting to be processed in the evaluation queue."
"RTN","MAGDIR82",184,0)
 . S I=I+1,MSG(I)=" "
"RTN","MAGDIR82",185,0)
 . S I=I+1,MSG(I)="There are currently "_T_" entr"_$S(T=1:"y",1:"ies")
"RTN","MAGDIR82",186,0)
 . S I=I+1,MSG(I)="waiting to be processed in the transmission queue."
"RTN","MAGDIR82",187,0)
 . S I=I+1,MSG(I)=" "
"RTN","MAGDIR82",188,0)
 . S I=I+1,MSG(I)="If this site is still a routing site, then both the"
"RTN","MAGDIR82",189,0)
 . S I=I+1,MSG(I)="Routing Rule Evaluator and the Routing Transmitter"
"RTN","MAGDIR82",190,0)
 . S I=I+1,MSG(I)="must be restarted."
"RTN","MAGDIR82",191,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",192,0)
 . S ERRCODE=ERRCODE_"-405"
"RTN","MAGDIR82",193,0)
 . S $P(^MAG(2006.1,PLACE,"LASTROUTE"),"^",2)=DT
"RTN","MAGDIR82",194,0)
 . Q
"RTN","MAGDIR82",195,0)
 Q
"RTN","MAGDIR82",196,0)
 ;
"RTN","MAGDIR83")
0^19^B24672823
"RTN","MAGDIR83",1,0)
MAGDIR83 ;WOIFO/PMK - Read a DICOM image file ; 06/06/2005  09:20
"RTN","MAGDIR83",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDIR83",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR83",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR83",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR83",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR83",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR83",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR83",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR83",10,0)
 ;; |                                                               |
"RTN","MAGDIR83",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR83",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR83",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR83",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR83",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR83",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR83",17,0)
 ;;
"RTN","MAGDIR83",18,0)
 ;
"RTN","MAGDIR83",19,0)
 ; M2MB server
"RTN","MAGDIR83",20,0)
 ;
"RTN","MAGDIR83",21,0)
 ; This routine is invoked by the ^MAGDIR8 to update handle DICOM
"RTN","MAGDIR83",22,0)
 ; CORRECT functions, that is, the "CORRECT" REQUEST item.
"RTN","MAGDIR83",23,0)
 ;
"RTN","MAGDIR83",24,0)
 ; This is a four-step process:
"RTN","MAGDIR83",25,0)
 ;
"RTN","MAGDIR83",26,0)
 ;    1) The "QUERY" record is sent, to obtain a list of corrected
"RTN","MAGDIR83",27,0)
 ;       images.  The list is sent back to the gateway in a list of
"RTN","MAGDIR83",28,0)
 ;       "CORRECT" RESULT items, each with new patient/study values.
"RTN","MAGDIR83",29,0)
 ;       If the images are to be deleted, the list will contain "DELETE"
"RTN","MAGDIR83",30,0)
 ;       instead of "FIXED" RESULT items.
"RTN","MAGDIR83",31,0)
 ;    2) The gateway processes each corrected/deleted image, one at a
"RTN","MAGDIR83",32,0)
 ;       time.
"RTN","MAGDIR83",33,0)
 ;    3) The gateway sends a "PROCESSED | IMAGE" record is sent back to
"RTN","MAGDIR83",34,0)
 ;       the server for each corrected image, so that each can be
"RTN","MAGDIR83",35,0)
 ;       deleted from the list.  (This is called an RPC Callback.)
"RTN","MAGDIR83",36,0)
 ;    4) Finally, the gateway sends a "PROCESSED | STUDY" record back to
"RTN","MAGDIR83",37,0)
 ;       the server to delete the remainder of the study from the list.
"RTN","MAGDIR83",38,0)
 ;
"RTN","MAGDIR83",39,0)
ENTRY ; update image acquisition statistics
"RTN","MAGDIR83",40,0)
 N LOCATION,MACHID,STATUS
"RTN","MAGDIR83",41,0)
 S STATUS=$P(ARGS,"|",1)
"RTN","MAGDIR83",42,0)
 I STATUS="QUERY" D
"RTN","MAGDIR83",43,0)
 . D QUERY
"RTN","MAGDIR83",44,0)
 . Q
"RTN","MAGDIR83",45,0)
 E  I STATUS="PROCESSED" D
"RTN","MAGDIR83",46,0)
 . D PROCESS
"RTN","MAGDIR83",47,0)
 . Q
"RTN","MAGDIR83",48,0)
 Q
"RTN","MAGDIR83",49,0)
 ;
"RTN","MAGDIR83",50,0)
QUERY ; get the list of DICOM CORRECTED files
"RTN","MAGDIR83",51,0)
 N DELFLAG,ICOUNT,IMAGEIEN,INSTNAME,LOCATION,MACHID
"RTN","MAGDIR83",52,0)
 N NEW,NEWNAME,NEWPID,NEWACN,NIMAGES,STUDYIEN,STUDYUID
"RTN","MAGDIR83",53,0)
 ;
"RTN","MAGDIR83",54,0)
 S LOCATION=$P(ARGS,"|",2),MACHID=$P(ARGS,"|",3)
"RTN","MAGDIR83",55,0)
 S NIMAGES=0,STUDYIEN=""
"RTN","MAGDIR83",56,0)
 F  S STUDYIEN=$O(^MAGD(2006.575,"AFX",LOCATION,MACHID,STUDYIEN)) Q:'STUDYIEN  Q:NIMAGES>24  D
"RTN","MAGDIR83",57,0)
 . S DELFLAG=^MAGD(2006.575,"AFX",LOCATION,MACHID,STUDYIEN)
"RTN","MAGDIR83",58,0)
 . S INSTNAME=$P(^MAGD(2006.575,STUDYIEN,"AMFG"),"^",1)
"RTN","MAGDIR83",59,0)
 . S STUDYUID=^MAGD(2006.575,STUDYIEN,"ASUID")
"RTN","MAGDIR83",60,0)
 . S NEW=^MAGD(2006.575,STUDYIEN,"FIXD")
"RTN","MAGDIR83",61,0)
 . S NEWNAME=$P(NEW,"^",3),NEWPID=$P(NEW,"^",4),NEWACN=$P(NEW,"^",5)
"RTN","MAGDIR83",62,0)
 . S IMAGEIEN=STUDYIEN ; need to process the first image
"RTN","MAGDIR83",63,0)
 . D QUERY1("NONE") ; first time - defer deleting this node
"RTN","MAGDIR83",64,0)
 . S ICOUNT=0
"RTN","MAGDIR83",65,0)
 . F  S ICOUNT=$O(^MAGD(2006.575,STUDYIEN,"RLATE",ICOUNT)) Q:'ICOUNT  Q:NIMAGES>24  D
"RTN","MAGDIR83",66,0)
 . . S IMAGEIEN=^MAGD(2006.575,STUDYIEN,"RLATE",ICOUNT,0)
"RTN","MAGDIR83",67,0)
 . . D QUERY1("IMAGE") ; regular image - delete it
"RTN","MAGDIR83",68,0)
 . . S NIMAGES=NIMAGES+1
"RTN","MAGDIR83",69,0)
 . . Q
"RTN","MAGDIR83",70,0)
 . I 'ICOUNT D  ; end of study reached - delete first image & study
"RTN","MAGDIR83",71,0)
 . . S IMAGEIEN=STUDYIEN ; need to delete first image and the study
"RTN","MAGDIR83",72,0)
 . . D QUERY1("STUDY") ; second time, now delete the study entry
"RTN","MAGDIR83",73,0)
 . . Q
"RTN","MAGDIR83",74,0)
 . Q
"RTN","MAGDIR83",75,0)
 Q
"RTN","MAGDIR83",76,0)
 ;
"RTN","MAGDIR83",77,0)
QUERY1(DELTYPE) ; build one CORRECT Result PROCESS array node
"RTN","MAGDIR83",78,0)
 N FROMPATH,X
"RTN","MAGDIR83",79,0)
 S FROMPATH=$P($G(^MAGD(2006.575,IMAGEIEN,0)),"^",1) Q:FROMPATH=""
"RTN","MAGDIR83",80,0)
 S X=$S(DELFLAG="D":"DELETE",1:"FIXED")
"RTN","MAGDIR83",81,0)
 S X=X_"|"_IMAGEIEN_"|"_STUDYIEN_"|"_DELTYPE_"|"_INSTNAME
"RTN","MAGDIR83",82,0)
 S X=X_"|"_FROMPATH_"|"_STUDYUID_"|"_NEWNAME_"|"_NEWPID_"|"_NEWACN
"RTN","MAGDIR83",83,0)
 D RESULT^MAGDIR8("CORRECT",X)
"RTN","MAGDIR83",84,0)
 Q
"RTN","MAGDIR83",85,0)
 ;
"RTN","MAGDIR83",86,0)
 ; -----------------------  RPC CALLBACK ------------------------------
"RTN","MAGDIR83",87,0)
 ;
"RTN","MAGDIR83",88,0)
PROCESS ; delete the processed corrected entry from the ^MAGD(2006.575) file
"RTN","MAGDIR83",89,0)
 N DELTYPE,EXIST,FILEPATH,IMAGEIEN,LOCATION,RLATEIEN,STUDYIEN
"RTN","MAGDIR83",90,0)
 S IMAGEIEN=$P(ARGS,"|",2),STUDYIEN=$P(ARGS,"|",3)
"RTN","MAGDIR83",91,0)
 S DELTYPE=$P(ARGS,"|",4),FILEPATH=$P(ARGS,"|",6) ; ignore piece #5
"RTN","MAGDIR83",92,0)
 I DELTYPE'="NONE" D  ; don't delete the first image/study in the list
"RTN","MAGDIR83",93,0)
 . L +^MAGD(2006.575,0):1E9 ; Background process MUST wait
"RTN","MAGDIR83",94,0)
 . I DELTYPE="IMAGE" D  ; delete this image
"RTN","MAGDIR83",95,0)
 . . ; remove the related image cross-references
"RTN","MAGDIR83",96,0)
 . . S RLATEIEN=$O(^MAGD(2006.575,STUDYIEN,"RLATE","B",IMAGEIEN,""))
"RTN","MAGDIR83",97,0)
 . . I RLATEIEN D
"RTN","MAGDIR83",98,0)
 . . . K ^MAGD(2006.575,STUDYIEN,"RLATE",RLATEIEN)
"RTN","MAGDIR83",99,0)
 . . . K ^MAGD(2006.575,STUDYIEN,"RLATE","B",IMAGEIEN,RLATEIEN)
"RTN","MAGDIR83",100,0)
 . . . S $P(^(0),"^",4)=$P(^MAGD(2006.575,STUDYIEN,"RLATE",0),"^",4)-1
"RTN","MAGDIR83",101,0)
 . . . Q
"RTN","MAGDIR83",102,0)
 . . Q
"RTN","MAGDIR83",103,0)
 . E  I DELTYPE="STUDY" D  ; delete the first image and study information
"RTN","MAGDIR83",104,0)
 . . ; remove the "AFX" and "F" cross-references
"RTN","MAGDIR83",105,0)
 . . S STUDYUID=$P(ARGS,"|",7),MACHID=$P(ARGS,"|",8)
"RTN","MAGDIR83",106,0)
 . . S LOCATION=$P(ARGS,"|",9)
"RTN","MAGDIR83",107,0)
 . . K ^MAGD(2006.575,"AFX",LOCATION,MACHID,STUDYIEN)
"RTN","MAGDIR83",108,0)
 . . K ^MAGD(2006.575,"F",LOCATION,STUDYUID,STUDYIEN)
"RTN","MAGDIR83",109,0)
 . . Q
"RTN","MAGDIR83",110,0)
 . ; Only subtract 1 from #entries, if we're actually deleting one:
"RTN","MAGDIR83",111,0)
 . S EXIST=$D(^MAGD(2006.575,IMAGEIEN))
"RTN","MAGDIR83",112,0)
 . K ^MAGD(2006.575,IMAGEIEN)
"RTN","MAGDIR83",113,0)
 . K ^MAGD(2006.575,"B",FILEPATH,IMAGEIEN)
"RTN","MAGDIR83",114,0)
 . S:EXIST $P(^(0),"^",4)=$P(^MAGD(2006.575,0),"^",4)-1
"RTN","MAGDIR83",115,0)
 . L -^MAGD(2006.575,0)
"RTN","MAGDIR83",116,0)
 . Q
"RTN","MAGDIR83",117,0)
 D RESULT^MAGDIR8("CORRECT","COMPLETE|"_IMAGEIEN_"|"_STUDYIEN_"|"_DELTYPE)
"RTN","MAGDIR83",118,0)
 Q
"RTN","MAGDIR8A")
0^20^B36949369
"RTN","MAGDIR8A",1,0)
MAGDIR8A ;WOIFO/PMK - Read a DICOM image file ; 03/08/2005  07:02
"RTN","MAGDIR8A",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDIR8A",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR8A",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR8A",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR8A",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR8A",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR8A",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR8A",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR8A",10,0)
 ;; |                                                               |
"RTN","MAGDIR8A",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR8A",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR8A",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR8A",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR8A",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR8A",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR8A",17,0)
 ;;
"RTN","MAGDIR8A",18,0)
 ;
"RTN","MAGDIR8A",19,0)
 ; M2MB server
"RTN","MAGDIR8A",20,0)
 ;
"RTN","MAGDIR8A",21,0)
 ; Lookup the patient/study in the imaging service's database
"RTN","MAGDIR8A",22,0)
 ; Different entry points are invoked from LOOKUP^MAGDIR81
"RTN","MAGDIR8A",23,0)
 ;
"RTN","MAGDIR8A",24,0)
RADLKUP ; Radiology patient/study lookup -- called by ^MAGDIR81
"RTN","MAGDIR8A",25,0)
 ; (also invoked by ^MAGDEXC4, ^MAGDFND4 and ^MAGDIW1)
"RTN","MAGDIR8A",26,0)
 ;
"RTN","MAGDIR8A",27,0)
 ; returns RADATA array DFN, DATETIME, and PROCDESC
"RTN","MAGDIR8A",28,0)
 ;
"RTN","MAGDIR8A",29,0)
 N CPTCODE ;-- CPT code for the procedure
"RTN","MAGDIR8A",30,0)
 N CPTNAME ;-- CPT name for the procedure
"RTN","MAGDIR8A",31,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDIR8A",32,0)
 N PROCIEN ;-- radiology procedure ien in ^RAMIS(71)
"RTN","MAGDIR8A",33,0)
 N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDIR8A",34,0)
 N RADPT1 ;--- first level subscript in ^RADPT
"RTN","MAGDIR8A",35,0)
 N RADPT2 ;--- second level subscript in ^RADPT (after "DT")
"RTN","MAGDIR8A",36,0)
 N RADPT3 ;--- third level subscript in ^RADPT (after "P")
"RTN","MAGDIR8A",37,0)
 N I,LIST,VARIABLE,X,Z
"RTN","MAGDIR8A",38,0)
 ;
"RTN","MAGDIR8A",39,0)
 ; find the patient/study in ^RARPT using the Radiology Case Number
"RTN","MAGDIR8A",40,0)
 K RADATA ; kill returned array of Radiology Package data
"RTN","MAGDIR8A",41,0)
 D RADLKUP1
"RTN","MAGDIR8A",42,0)
 S LIST="RADPT1^RADPT2^RADPT3^PROCIEN^CPTCODE^CPTNAME^Z^EXAMSTS"
"RTN","MAGDIR8A",43,0)
 F I=1:1:$L(LIST,"^") D
"RTN","MAGDIR8A",44,0)
 . S VARIABLE=$P(LIST,"^",I)
"RTN","MAGDIR8A",45,0)
 . S RADATA(VARIABLE)=$G(@VARIABLE)
"RTN","MAGDIR8A",46,0)
 . Q
"RTN","MAGDIR8A",47,0)
 Q
"RTN","MAGDIR8A",48,0)
 ;
"RTN","MAGDIR8A",49,0)
RADLKUP1 ; not an entry point
"RTN","MAGDIR8A",50,0)
 Q:CASENUMB=""    ;LB 12/16/98
"RTN","MAGDIR8A",51,0)
 S RAIX=$S($D(^RADPT("C")):"C",1:"AE") ; for Radiology Patch RA*5*7
"RTN","MAGDIR8A",52,0)
 S RAIX=$S(CASENUMB["-":"ADC",1:RAIX) ; select the cross-reference
"RTN","MAGDIR8A",53,0)
 S RADPT1=$O(^RADPT(RAIX,CASENUMB,"")) I 'RADPT1 Q
"RTN","MAGDIR8A",54,0)
 S RADPT2=$O(^RADPT(RAIX,CASENUMB,RADPT1,"")) I 'RADPT2 Q
"RTN","MAGDIR8A",55,0)
 S RADPT3=$O(^RADPT(RAIX,CASENUMB,RADPT1,RADPT2,"")) I 'RADPT3 Q
"RTN","MAGDIR8A",56,0)
 S X=$O(^RADPT(RAIX,CASENUMB,RADPT1,RADPT2,RADPT3))
"RTN","MAGDIR8A",57,0)
 I '$D(^RADPT(RADPT1,0)) Q  ; no patient demographics file pointer
"RTN","MAGDIR8A",58,0)
 ; get patient demographics file pointer
"RTN","MAGDIR8A",59,0)
 S X=^RADPT(RADPT1,0),DFN=$P(X,"^")
"RTN","MAGDIR8A",60,0)
 I '$D(^RADPT(RADPT1,"DT",RADPT2,0)) Q  ; no datetime level
"RTN","MAGDIR8A",61,0)
 ; get date and time of examination
"RTN","MAGDIR8A",62,0)
 S DATETIME=$P($G(^RADPT(RADPT1,"DT",RADPT2,0)),"^",1)
"RTN","MAGDIR8A",63,0)
 ; get case info
"RTN","MAGDIR8A",64,0)
 S X=$G(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDIR8A",65,0)
 S PROCIEN=$P(X,"^",2),EXAMSTS=$P(X,"^",3)
"RTN","MAGDIR8A",66,0)
 I EXAMSTS S EXAMSTS=$$GET1^DIQ(72,EXAMSTS,.01)
"RTN","MAGDIR8A",67,0)
 S (PROCDESC,CPTNAME,CPTCODE)=""
"RTN","MAGDIR8A",68,0)
 I 'PROCIEN Q  ; need PROCIEN to do lookup in ^RAMIS
"RTN","MAGDIR8A",69,0)
 S Z=$G(^RAMIS(71,PROCIEN,0))
"RTN","MAGDIR8A",70,0)
 S PROCDESC=$P(Z,"^"),CPTCODE=$P(Z,"^",9)
"RTN","MAGDIR8A",71,0)
 S CPTNAME=PROCDESC ; approximate value since ^ICPT is not translated
"RTN","MAGDIR8A",72,0)
 Q
"RTN","MAGDIR8A",73,0)
 ;
"RTN","MAGDIR8A",74,0)
CONLKUP ; CPRS Consult/Procedure patient/study lookup -- called by ^MAGDIR81
"RTN","MAGDIR8A",75,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDIR8A",76,0)
 N CONPROC,Z
"RTN","MAGDIR8A",77,0)
 I ACNUMB'?1"GMRC-".1N.N Q
"RTN","MAGDIR8A",78,0)
 S GMRCIEN=$P(ACNUMB,"-",2)
"RTN","MAGDIR8A",79,0)
 S DFN=$$GET1^DIQ(123,GMRCIEN,.02,"I")
"RTN","MAGDIR8A",80,0)
 I DFN="" Q  ; no patient demographics file pointer
"RTN","MAGDIR8A",81,0)
 S EXAMSTS=$$GET1^DIQ(123,GMRCIEN,8) ; check for cancelled exam
"RTN","MAGDIR8A",82,0)
 I EXAMSTS="CANCELLED" S RADATA("EXAMSTS")=EXAMSTS Q
"RTN","MAGDIR8A",83,0)
 S PROCDESC=$$GET1^DIQ(123,GMRCIEN,1)
"RTN","MAGDIR8A",84,0)
 S Z=$$GET1^DIQ(123,GMRCIEN,13,"I") ; request type
"RTN","MAGDIR8A",85,0)
 S CONPROC=$S(Z="C":"CONSULT",Z="P":"PROCEDURE",1:"UNKNOWN")
"RTN","MAGDIR8A",86,0)
 Q
"RTN","MAGDIR8A",87,0)
 ;
"RTN","MAGDIR8A",88,0)
PIDCHECK() ; compare VistA patient ID with DICOM patient ID
"RTN","MAGDIR8A",89,0)
 N CHECK ;---- patient demographic comparison check value
"RTN","MAGDIR8A",90,0)
 N FIRSTVAH ;- patient first name from VADM(1)
"RTN","MAGDIR8A",91,0)
 N IDDCM ;---- patient id, w/o punctuation, from image header
"RTN","MAGDIR8A",92,0)
 N IDVAH ;---- patient id from VADM(2)
"RTN","MAGDIR8A",93,0)
 N LASTVAH ;-- patient last name from VADM(1)
"RTN","MAGDIR8A",94,0)
 N MIVAH ;---- patient middle initial from VADM(1)
"RTN","MAGDIR8A",95,0)
 N DIQUIET,I,VA,VAERR,X,Y
"RTN","MAGDIR8A",96,0)
 ;
"RTN","MAGDIR8A",97,0)
 S X=PNAMEDCM X ^%ZOSF("UPPERCASE") S PNAMEDCM=Y
"RTN","MAGDIR8A",98,0)
 ; parse the DICOM patient name (2 formats)
"RTN","MAGDIR8A",99,0)
 I PNAMEDCM["^" D  ; DICOM format patient name
"RTN","MAGDIR8A",100,0)
 . S LASTDCM=$P(PNAMEDCM,"^"),FIRSTDCM=$P(PNAMEDCM,"^",2)
"RTN","MAGDIR8A",101,0)
 . S MIDCM=$P(PNAMEDCM,"^",3)
"RTN","MAGDIR8A",102,0)
 . Q
"RTN","MAGDIR8A",103,0)
 E  I PNAMEDCM["," D  ; ACR-NEMA format patient name
"RTN","MAGDIR8A",104,0)
 . F  Q:'$F(PNAMEDCM,", ")  D  ; remove blanks after last name comma
"RTN","MAGDIR8A",105,0)
 . . S PNAMEDCM=$P(PNAMEDCM,", ")_","_$P(PNAMEDCM,", ",2,999)
"RTN","MAGDIR8A",106,0)
 . . Q
"RTN","MAGDIR8A",107,0)
 . S LASTDCM=$P(PNAMEDCM,","),FIRSTDCM=$P(PNAMEDCM,",",2)
"RTN","MAGDIR8A",108,0)
 . S MIDCM=$S(PNAMEDCM[",":$P(FIRSTDCM,",",2),1:$P(FIRSTDCM," ",2,999))
"RTN","MAGDIR8A",109,0)
 . Q
"RTN","MAGDIR8A",110,0)
 E  D  ; patient name in "last first mi" order with space delimiters
"RTN","MAGDIR8A",111,0)
 . S LASTDCM=$P(PNAMEDCM," "),FIRSTDCM=$P(PNAMEDCM," ",2)
"RTN","MAGDIR8A",112,0)
 . S MIDCM=$P(PNAMEDCM," ",3)
"RTN","MAGDIR8A",113,0)
 . Q
"RTN","MAGDIR8A",114,0)
 S FIRSTDCM=$S(FIRSTDCM[",":$P(FIRSTDCM,","),1:$P(FIRSTDCM," "))
"RTN","MAGDIR8A",115,0)
 ; only check the first part of the name
"RTN","MAGDIR8A",116,0)
 ; remove dashes and atypical punctuation from the DICOM PID
"RTN","MAGDIR8A",117,0)
 S IDDCM="" F I=1:1:$L(PID) I $E(PID,I)?1AN S IDDCM=IDDCM_$E(PID,I)
"RTN","MAGDIR8A",118,0)
 ;
"RTN","MAGDIR8A",119,0)
 I CASENUMB="" Q "-1,NO CASE #"
"RTN","MAGDIR8A",120,0)
 I '$G(DFN) Q "-2,BAD CASE #"
"RTN","MAGDIR8A",121,0)
 I $G(RADATA("EXAMSTS"))="CANCELLED" Q "-3,CANCELLED"
"RTN","MAGDIR8A",122,0)
 ;
"RTN","MAGDIR8A",123,0)
 ; lookup patient in VistA database
"RTN","MAGDIR8A",124,0)
 S DIQUIET=1 D DEM^VADPT
"RTN","MAGDIR8A",125,0)
 S PNAMEVAH=VADM(1)
"RTN","MAGDIR8A",126,0)
 S LASTVAH=$P(PNAMEVAH,","),FIRSTVAH=$P(PNAMEVAH,",",2)
"RTN","MAGDIR8A",127,0)
 S MIVAH=$TR($P(FIRSTVAH," ",2,999),"."),FIRSTVAH=$P(FIRSTVAH," ")
"RTN","MAGDIR8A",128,0)
 S IDVAH=$P(VADM(2),"^"),DCMPID=$P(VADM(2),"^",2)
"RTN","MAGDIR8A",129,0)
 ;
"RTN","MAGDIR8A",130,0)
 ; compare the values - allow a single transposition in the patient name,
"RTN","MAGDIR8A",131,0)
 ; but require exact patient id values (i.e., social security numbers)
"RTN","MAGDIR8A",132,0)
 S CHECK=(5*$$COMPARE(LASTDCM,LASTVAH))
"RTN","MAGDIR8A",133,0)
 S CHECK=CHECK+(5*$$COMPARE($E(FIRSTDCM,1,6),$E(FIRSTVAH,1,6)))
"RTN","MAGDIR8A",134,0)
 S CHECK=CHECK+(1*$$COMPARE(MIDCM,MIVAH))
"RTN","MAGDIR8A",135,0)
 S CHECK=CHECK+(5*(IDDCM=IDVAH)) ; patient id requires an exact match
"RTN","MAGDIR8A",136,0)
 I CHECK<14.5 Q "-4,PID ERROR" ; require an "almost exact" match
"RTN","MAGDIR8A",137,0)
 Q 0  ; correct patient
"RTN","MAGDIR8A",138,0)
 ;
"RTN","MAGDIR8A",139,0)
COMPARE(A,B) ; pattern match checker
"RTN","MAGDIR8A",140,0)
 Q:A=B 1 ; exact match
"RTN","MAGDIR8A",141,0)
 Q:A="" 0 Q:B="" 0 ; don't count missing data
"RTN","MAGDIR8A",142,0)
 ; calculate fractional value for pattern match
"RTN","MAGDIR8A",143,0)
 N I,LENGTH,MATCH
"RTN","MAGDIR8A",144,0)
 S MATCH=0,LENGTH=$S($L(B)>$L(A):$L(B),1:$L(A))
"RTN","MAGDIR8A",145,0)
 F I=1:1:LENGTH D
"RTN","MAGDIR8A",146,0)
 . I $E(A,I)=$E(B,I) S MATCH=MATCH+1
"RTN","MAGDIR8A",147,0)
 . E  I $E(A,I)=$E(B,I-1) S MATCH=MATCH+.25
"RTN","MAGDIR8A",148,0)
 . E  I $E(A,I)=$E(B,I+1) S MATCH=MATCH+.25
"RTN","MAGDIR8A",149,0)
 . E  I $E(A,I-1)=$E(B,I) S MATCH=MATCH+.25
"RTN","MAGDIR8A",150,0)
 . E  I $E(A,I+1)=$E(B,I) S MATCH=MATCH+.25
"RTN","MAGDIR8A",151,0)
 . Q
"RTN","MAGDIR8A",152,0)
 Q MATCH/LENGTH ; return fractional pattern match value
"RTN","MAGDIR9A")
0^21^B49392347
"RTN","MAGDIR9A",1,0)
MAGDIR9A ;WOIFO/PMK - Read a DICOM image file ; 07 Mar 2005  11:00 AM
"RTN","MAGDIR9A",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDIR9A",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9A",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR9A",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR9A",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR9A",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR9A",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR9A",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR9A",10,0)
 ;; |                                                               |
"RTN","MAGDIR9A",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR9A",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR9A",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR9A",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR9A",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR9A",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9A",17,0)
 ;;
"RTN","MAGDIR9A",18,0)
 ;
"RTN","MAGDIR9A",19,0)
 ; M2MB server
"RTN","MAGDIR9A",20,0)
 ;
"RTN","MAGDIR9A",21,0)
 ; This routine creates a ^mag(2005) group entry and links it to the
"RTN","MAGDIR9A",22,0)
 ; associated radiology report
"RTN","MAGDIR9A",23,0)
 ;
"RTN","MAGDIR9A",24,0)
 ;   XXXXXX      XX    XXXXXX
"RTN","MAGDIR9A",25,0)
 ;    XX  XX    XXXX    XX  XX
"RTN","MAGDIR9A",26,0)
 ;    XX  XX   XX  XX   XX  XX
"RTN","MAGDIR9A",27,0)
 ;    XXXXX    XX  XX   XX  XX
"RTN","MAGDIR9A",28,0)
 ;    XX XX    XXXXXX   XX  XX
"RTN","MAGDIR9A",29,0)
 ;    XX  XX   XX  XX   XX  XX
"RTN","MAGDIR9A",30,0)
 ;   XXX  XX   XX  XX  XXXXXX
"RTN","MAGDIR9A",31,0)
 ;
"RTN","MAGDIR9A",32,0)
GROUP() ; entry point from ^MAGDIR81
"RTN","MAGDIR9A",33,0)
 N ACQDEVP ;-- pointer to acquisition device file (#2006.04)
"RTN","MAGDIR9A",34,0)
 N DA ;------ fileman variable
"RTN","MAGDIR9A",35,0)
 N ERRCODE ;- error trap code
"RTN","MAGDIR9A",36,0)
 N GROUP ;--- array to pass group data to ^MAGGTIA
"RTN","MAGDIR9A",37,0)
 N GROUPDFN ; DFN value from image group entry for double checking
"RTN","MAGDIR9A",38,0)
 N P ;-------- scratch variable (pointer to ACQUISITION DEVICE file)
"RTN","MAGDIR9A",39,0)
 N RACNE ;--- external "3rd level" subscript in ^RADPT
"RTN","MAGDIR9A",40,0)
 N RACNI ;--- internal "3rd level" subscript in ^RADPT
"RTN","MAGDIR9A",41,0)
 N RADFN ;--- radiology package's DFN
"RTN","MAGDIR9A",42,0)
 N RADTE ;--- external "2nd level" subscript in ^RADPT
"RTN","MAGDIR9A",43,0)
 N RADTI ;--- internal "2nd level" subscript in ^RADPT
"RTN","MAGDIR9A",44,0)
 N RARPT ;--- 1st level node in ^RARPT for report (ie, the ien)
"RTN","MAGDIR9A",45,0)
 N RARPT3 ;-- 3rd level node for 2005 multiple under ^RARPT's report
"RTN","MAGDIR9A",46,0)
 N RARPTDFN ; DFN value from ^RARPT for double checking
"RTN","MAGDIR9A",47,0)
 N SOPCLASP ; pointer to SOP Class file (#2006.532)
"RTN","MAGDIR9A",48,0)
 N HIT,P200584,X,Y ; scratch variables
"RTN","MAGDIR9A",49,0)
 ;
"RTN","MAGDIR9A",50,0)
 S ERRCODE=""
"RTN","MAGDIR9A",51,0)
 ;
"RTN","MAGDIR9A",52,0)
 S (RADFN,DA(2))=DFN ; patient DFN variables
"RTN","MAGDIR9A",53,0)
 S RADTI=RADATA("RADPT2") ; case subscript
"RTN","MAGDIR9A",54,0)
 I RADTI="" D  Q ERRCODE
"RTN","MAGDIR9A",55,0)
 . K MSG
"RTN","MAGDIR9A",56,0)
 . S MSG(1)="No radiology case number specified for patient "_DFN
"RTN","MAGDIR9A",57,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",58,0)
 . S ERRCODE=-301
"RTN","MAGDIR9A",59,0)
 . Q
"RTN","MAGDIR9A",60,0)
 ;
"RTN","MAGDIR9A",61,0)
 S RADTE=$TR(RADATA("RADPT2"),"0123456789","9876543210")
"RTN","MAGDIR9A",62,0)
 S RACNI=RADATA("RADPT3")
"RTN","MAGDIR9A",63,0)
 S RACNE=$S(CASENUMB["-":$P(CASENUMB,"-",2),1:CASENUMB) ; short case #
"RTN","MAGDIR9A",64,0)
 ;
"RTN","MAGDIR9A",65,0)
 ; check for the existence of the entry in ^RADPT (redundant)
"RTN","MAGDIR9A",66,0)
 I '$D(^RADPT(RADFN,"DT",RADTI,0)) D  Q ERRCODE ; can't process further
"RTN","MAGDIR9A",67,0)
 . K MSG
"RTN","MAGDIR9A",68,0)
 . S MSG(1)="Radiology case "_RADTI_" is not in ^RADPT("_RADFN_")"
"RTN","MAGDIR9A",69,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",70,0)
 . S ERRCODE=-302
"RTN","MAGDIR9A",71,0)
 . Q
"RTN","MAGDIR9A",72,0)
 ;
"RTN","MAGDIR9A",73,0)
 ; check for the existence of the report pointer
"RTN","MAGDIR9A",74,0)
 S RARPT=$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),"^",17)
"RTN","MAGDIR9A",75,0)
 ; if the report does not yet exist, create it
"RTN","MAGDIR9A",76,0)
 D:RARPT=""
"RTN","MAGDIR9A",77,0)
 . N RACN
"RTN","MAGDIR9A",78,0)
 . S RACN=RACNE D CREATE^RARIC ; create the report
"RTN","MAGDIR9A",79,0)
 . Q
"RTN","MAGDIR9A",80,0)
 ;
"RTN","MAGDIR9A",81,0)
 ; If RARPT is no longer defined at this point, this means
"RTN","MAGDIR9A",82,0)
 ; that we're dealing with an old study, and the report has
"RTN","MAGDIR9A",83,0)
 ; been archived and purged.
"RTN","MAGDIR9A",84,0)
 ;
"RTN","MAGDIR9A",85,0)
 I '$G(RARPT) D  Q ERRCODE
"RTN","MAGDIR9A",86,0)
 . K MSG
"RTN","MAGDIR9A",87,0)
 . S MSG(1)="IMAGE GROUP CREATION ERROR:"
"RTN","MAGDIR9A",88,0)
 . S MSG(2)="Radiology Report has been archived and purged."
"RTN","MAGDIR9A",89,0)
 . S MSG(3)="Patient "_$G(RADFN)_", Date "_$G(RADTI)_", Case "_$G(RACNI)
"RTN","MAGDIR9A",90,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",91,0)
 . S ERRCODE=-303
"RTN","MAGDIR9A",92,0)
 . Q
"RTN","MAGDIR9A",93,0)
 ;
"RTN","MAGDIR9A",94,0)
 ; double check the DFN value from ^RARPT to make sure its right
"RTN","MAGDIR9A",95,0)
 S RARPTDFN=$P($G(^RARPT(RARPT,0)),"^",2)
"RTN","MAGDIR9A",96,0)
 I RARPTDFN'=DFN D  Q ERRCODE ; fatal error
"RTN","MAGDIR9A",97,0)
 . D RADMISS^MAGDIRVE($T(+0),DFN,RARPT,RARPTDFN)
"RTN","MAGDIR9A",98,0)
 . S ERRCODE=-304
"RTN","MAGDIR9A",99,0)
 . Q
"RTN","MAGDIR9A",100,0)
 ;
"RTN","MAGDIR9A",101,0)
 ; initialize FILEDATA for GROUP and IMAGE
"RTN","MAGDIR9A",102,0)
 ; get the acquisition device pointer (file 2005, field 107)
"RTN","MAGDIR9A",103,0)
 S ACQDEVP=$$ACQDEV^MAGDFCNV(MFGR,MODEL,INSTLOC)
"RTN","MAGDIR9A",104,0)
 S FILEDATA("ACQUISITION DEVICE")=ACQDEVP
"RTN","MAGDIR9A",105,0)
 ; get the SOP Class pointer (file 2005, field 251)
"RTN","MAGDIR9A",106,0)
 S SOPCLASP=$O(^MAG(2006.532,"B",SOPCLASS,""))
"RTN","MAGDIR9A",107,0)
 S FILEDATA("SOP CLASS POINTER")=SOPCLASP
"RTN","MAGDIR9A",108,0)
 ;
"RTN","MAGDIR9A",109,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR9A",110,0)
 S FILEDATA("PARENT FILE")=74
"RTN","MAGDIR9A",111,0)
 S FILEDATA("PARENT IEN")=RARPT
"RTN","MAGDIR9A",112,0)
 S FILEDATA("RAD REPORT")=RARPT
"RTN","MAGDIR9A",113,0)
 S FILEDATA("RAD PROC PTR")=RADATA("PROCIEN")
"RTN","MAGDIR9A",114,0)
 S FILEDATA("PACKAGE")="RAD"
"RTN","MAGDIR9A",115,0)
 S X=$S(MODALITY="NM":"NUCLEAR MEDICINE",1:"RADIOLOGY")
"RTN","MAGDIR9A",116,0)
 S P200584=$O(^MAG(2005.84,"B",X,""))
"RTN","MAGDIR9A",117,0)
 S X=$$FIELD43^MAGXMA(MODALITY,P200584,.Y)
"RTN","MAGDIR9A",118,0)
 S FILEDATA("PROC/EVENT")=$S(X=0:Y,1:"")
"RTN","MAGDIR9A",119,0)
 S FILEDATA("SPEC/SUBSPEC")=P200584
"RTN","MAGDIR9A",120,0)
 ;
"RTN","MAGDIR9A",121,0)
 ; find the corresponding image group node under the report
"RTN","MAGDIR9A",122,0)
 S (HIT,RARPT3)=0
"RTN","MAGDIR9A",123,0)
 F  S RARPT3=$O(^RARPT(RARPT,2005,RARPT3)) Q:'RARPT3  D  Q:HIT  Q:ERRCODE
"RTN","MAGDIR9A",124,0)
 . S MAGGP=+$G(^RARPT(RARPT,2005,RARPT3,0)) ; get imaging group pointer
"RTN","MAGDIR9A",125,0)
 . S GROUPDFN=$P($G(^MAG(2005,MAGGP,0)),"^",7) ; check image DFN value
"RTN","MAGDIR9A",126,0)
 . I GROUPDFN'=DFN D  ; fatal error
"RTN","MAGDIR9A",127,0)
 . . D MISMATCH^MAGDIRVE($T(+0),DFN,MAGGP)
"RTN","MAGDIR9A",128,0)
 . . S ERRCODE=-305
"RTN","MAGDIR9A",129,0)
 . . Q
"RTN","MAGDIR9A",130,0)
 . E  I $P($G(^MAG(2005,MAGGP,0)),"^",6)=11 D
"RTN","MAGDIR9A",131,0)
 . . ; check to see that this group is for the same SOP Class
"RTN","MAGDIR9A",132,0)
 . . S P=$P($G(^MAG(2005,MAGGP,"SOP")),"^",1)
"RTN","MAGDIR9A",133,0)
 . . S HIT=$$EQUIVGRP^MAGDFCNV(P,SOPCLASP) ; equivalent groups?
"RTN","MAGDIR9A",134,0)
 . . Q
"RTN","MAGDIR9A",135,0)
 . Q
"RTN","MAGDIR9A",136,0)
 ;
"RTN","MAGDIR9A",137,0)
 I ERRCODE Q ERRCODE ; fatal image DFN problem
"RTN","MAGDIR9A",138,0)
 ;
"RTN","MAGDIR9A",139,0)
 I 'HIT D  Q:ERRCODE ERRCODE ; the 2005 node does not yet exist
"RTN","MAGDIR9A",140,0)
 . ; create the radiology imaging group
"RTN","MAGDIR9A",141,0)
 . N PROCEDUR,RADRPT,RADPTR
"RTN","MAGDIR9A",142,0)
 . S PROCEDUR="RAD "_FILEDATA("MODALITY")
"RTN","MAGDIR9A",143,0)
 . S RADRPT=FILEDATA("RAD REPORT")
"RTN","MAGDIR9A",144,0)
 . S RADPTR=FILEDATA("RAD PROC PTR")
"RTN","MAGDIR9A",145,0)
 . D NEWGROUP(PROCEDUR,RADRPT,RADPTR) Q:ERRCODE
"RTN","MAGDIR9A",146,0)
 . ;
"RTN","MAGDIR9A",147,0)
 . ; store the cross-reference for the report
"RTN","MAGDIR9A",148,0)
 . D PTR^RARIC
"RTN","MAGDIR9A",149,0)
 . Q
"RTN","MAGDIR9A",150,0)
 ;
"RTN","MAGDIR9A",151,0)
 I 'MAGGP D  Q ERRCODE ; fatal error
"RTN","MAGDIR9A",152,0)
 . K MSG
"RTN","MAGDIR9A",153,0)
 . S MSG(1)="IMAGE GROUP LOOKUP ERROR:"
"RTN","MAGDIR9A",154,0)
 . S MSG(2)="Looking for 2005 cross reference in ^RARPT("_RARPT_")"
"RTN","MAGDIR9A",155,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",156,0)
 . S ERRCODE=-308
"RTN","MAGDIR9A",157,0)
 . Q
"RTN","MAGDIR9A",158,0)
 Q 0
"RTN","MAGDIR9A",159,0)
 ;
"RTN","MAGDIR9A",160,0)
NEWGROUP(PROCEDUR,RADRPT,RADPTR) ; create an imaging group (called by ^MAGDIR9E)
"RTN","MAGDIR9A",161,0)
 K GROUP
"RTN","MAGDIR9A",162,0)
 S GROUP(1)=".01^"_PNAMEVAH_"  "_DCMPID_"  "_PROCDESC
"RTN","MAGDIR9A",163,0)
 S GROUP(2)="3^11" ; Object Type -- XRAY Group
"RTN","MAGDIR9A",164,0)
 S GROUP(3)="5^"_DFN
"RTN","MAGDIR9A",165,0)
 S GROUP(4)="6^"_PROCEDUR
"RTN","MAGDIR9A",166,0)
 S GROUP(5)="2005.04^0"
"RTN","MAGDIR9A",167,0)
 S GROUP(6)="10^"_PROCDESC
"RTN","MAGDIR9A",168,0)
 S GROUP(7)="15^"_DATETIME
"RTN","MAGDIR9A",169,0)
 S GROUP(8)="16^"_FILEDATA("PARENT FILE")
"RTN","MAGDIR9A",170,0)
 S GROUP(9)="17^"_FILEDATA("PARENT IEN")
"RTN","MAGDIR9A",171,0)
 S GROUP(10)="60^"_STUDYUID
"RTN","MAGDIR9A",172,0)
 ;
"RTN","MAGDIR9A",173,0)
 ; the following two fields are only for radiology
"RTN","MAGDIR9A",174,0)
 I $D(RADRPT) S GROUP(11)="61^"_RADRPT
"RTN","MAGDIR9A",175,0)
 I $D(RADPTR) S GROUP(12)="62^"_RADPTR
"RTN","MAGDIR9A",176,0)
 ;
"RTN","MAGDIR9A",177,0)
 S GROUP(13)=".05^"_INSTLOC
"RTN","MAGDIR9A",178,0)
 S GROUP(14)="40^"_FILEDATA("PACKAGE")
"RTN","MAGDIR9A",179,0)
 S GROUP(15)="41^"_$O(^MAG(2005.82,"B","CLIN",""))
"RTN","MAGDIR9A",180,0)
 S GROUP(16)="42^"_FILEDATA("TYPE")
"RTN","MAGDIR9A",181,0)
 S GROUP(17)="43^"_FILEDATA("PROC/EVENT")
"RTN","MAGDIR9A",182,0)
 S GROUP(18)="44^"_FILEDATA("SPEC/SUBSPEC")
"RTN","MAGDIR9A",183,0)
 S GROUP(19)="107^"_FILEDATA("ACQUISITION DEVICE")
"RTN","MAGDIR9A",184,0)
 S GROUP(20)="251^"_FILEDATA("SOP CLASS POINTER")
"RTN","MAGDIR9A",185,0)
 D ADD^MAGGTIA(.RETURN,.GROUP)
"RTN","MAGDIR9A",186,0)
 S MAGGP=+RETURN
"RTN","MAGDIR9A",187,0)
 I 'MAGGP D  Q  ; fatal error
"RTN","MAGDIR9A",188,0)
 . K MSG
"RTN","MAGDIR9A",189,0)
 . S MSG(1)="IMAGE GROUP CREATION ERROR:"
"RTN","MAGDIR9A",190,0)
 . S MSG(2)=$P(RETURN,"^",2,999)
"RTN","MAGDIR9A",191,0)
 . D BADERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",192,0)
 . S ERRCODE=-306
"RTN","MAGDIR9A",193,0)
 . Q
"RTN","MAGDIR9A",194,0)
 ;
"RTN","MAGDIR9A",195,0)
 I MAGGP<LASTIMG D  Q  ; fatal last image pointer error
"RTN","MAGDIR9A",196,0)
 . D GROUPPTR^MAGDIRVE($T(+0),MAGGP,LASTIMG)
"RTN","MAGDIR9A",197,0)
 . S ERRCODE=-307
"RTN","MAGDIR9A",198,0)
 . Q
"RTN","MAGDIR9A",199,0)
 Q
"RTN","MAGDIR9A",200,0)
 ;
"RTN","MAGDIR9B")
0^22^B17435777
"RTN","MAGDIR9B",1,0)
MAGDIR9B ;WOIFO/PMK - Read a DICOM image file ; 06/06/2005  09:21
"RTN","MAGDIR9B",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDIR9B",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9B",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR9B",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR9B",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR9B",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR9B",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR9B",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR9B",10,0)
 ;; |                                                               |
"RTN","MAGDIR9B",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR9B",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR9B",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR9B",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR9B",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR9B",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9B",17,0)
 ;;
"RTN","MAGDIR9B",18,0)
 ; M2MB server
"RTN","MAGDIR9B",19,0)
 ;
"RTN","MAGDIR9B",20,0)
 ; Create an image entry in ^MAG(2005)
"RTN","MAGDIR9B",21,0)
 ;
"RTN","MAGDIR9B",22,0)
IMAGE() ; entry point from ^MAGDIR81 to create an image entry in ^MAG(2005)
"RTN","MAGDIR9B",23,0)
 N IMAGE ;---- image array for ^MAGGTIA
"RTN","MAGDIR9B",24,0)
 N IMAGECNT ;- counter of image in the group
"RTN","MAGDIR9B",25,0)
 N IMAGEPTR ;- value returned by ^MAGGTIA
"RTN","MAGDIR9B",26,0)
 ;
"RTN","MAGDIR9B",27,0)
 ; check that the group has right object type and is for the same person
"RTN","MAGDIR9B",28,0)
 I $P($G(^MAG(2005,MAGGP,0)),"^",6)'=11 D  Q -101 ; fatal error
"RTN","MAGDIR9B",29,0)
 . D OBJECT^MAGDIRVE($T(+0),MAGGP)
"RTN","MAGDIR9B",30,0)
 . Q
"RTN","MAGDIR9B",31,0)
 ;
"RTN","MAGDIR9B",32,0)
 ; check that the group patient DFN matches the image patient DFN
"RTN","MAGDIR9B",33,0)
 I $P(^MAG(2005,MAGGP,0),"^",7)'=DFN D  Q -102 ; fatal error
"RTN","MAGDIR9B",34,0)
 . D MISMATCH^MAGDIRVE($T(+0),DFN,MAGGP)
"RTN","MAGDIR9B",35,0)
 . Q
"RTN","MAGDIR9B",36,0)
 ;
"RTN","MAGDIR9B",37,0)
 ; get the next file number and create the entry for this image
"RTN","MAGDIR9B",38,0)
 ;
"RTN","MAGDIR9B",39,0)
 S IMAGECNT=$P($G(^MAG(2005,MAGGP,1,0)),"^",4)+1 ; next image # in group
"RTN","MAGDIR9B",40,0)
 ;
"RTN","MAGDIR9B",41,0)
 K IMAGE
"RTN","MAGDIR9B",42,0)
 S IMAGE(1)=".01^"_PNAMEVAH_"  "_DCMPID_"  "_PROCDESC ; used in ^MAGDIR8
"RTN","MAGDIR9B",43,0)
 S IMAGE(2)="5^"_DFN
"RTN","MAGDIR9B",44,0)
 I $D(FILEDATA("SHORT DESCRIPTION")) D  ; set in ^MAGDIR7F
"RTN","MAGDIR9B",45,0)
 . S IMAGE(3)="10^"_FILEDATA("SHORT DESCRIPTION")
"RTN","MAGDIR9B",46,0)
 . Q
"RTN","MAGDIR9B",47,0)
 E  S IMAGE(3)="10^"_PROCDESC_" (#"_IMAGECNT_")" ; used in ^MAGDIR81
"RTN","MAGDIR9B",48,0)
 S IMAGE(4)="14^"_MAGGP
"RTN","MAGDIR9B",49,0)
 S IMAGE(5)="15^"_DATETIME
"RTN","MAGDIR9B",50,0)
 S IMAGE(6)="60^"_IMAGEUID
"RTN","MAGDIR9B",51,0)
 S IMAGE(7)=FILEDATA("EXTENSION") ; specify the image file extension
"RTN","MAGDIR9B",52,0)
 I $D(FILEDATA("ABSTRACT")) S IMAGE(8)=FILEDATA("ABSTRACT")
"RTN","MAGDIR9B",53,0)
 S IMAGE(9)="WRITE^PACS" ; select the PACS image write location
"RTN","MAGDIR9B",54,0)
 S IMAGE(10)="3^"_FILEDATA("OBJECT TYPE")
"RTN","MAGDIR9B",55,0)
 S IMAGE(11)="6^"_FILEDATA("MODALITY")
"RTN","MAGDIR9B",56,0)
 S IMAGE(12)="16^"_FILEDATA("PARENT FILE")
"RTN","MAGDIR9B",57,0)
 S IMAGE(13)="17^"_FILEDATA("PARENT IEN")
"RTN","MAGDIR9B",58,0)
 I $D(FILEDATA("PARENT FILE PTR")) S IMAGE(14)="18^"_FILEDATA("PARENT FILE PTR")
"RTN","MAGDIR9B",59,0)
 I $D(FILEDATA("RAD REPORT")) S IMAGE(15)="61^"_FILEDATA("RAD REPORT")
"RTN","MAGDIR9B",60,0)
 I $D(FILEDATA("RAD PROC PTR")) S IMAGE(16)="62^"_FILEDATA("RAD PROC PTR")
"RTN","MAGDIR9B",61,0)
 I MODPARMS["/" S IMAGE(17)="BIG^1" ; big file will be output
"RTN","MAGDIR9B",62,0)
 S IMAGE(18)="DICOMSN^"_SERINUMB ; series number
"RTN","MAGDIR9B",63,0)
 S IMAGE(19)="DICOMIN^"_IMAGNUMB ; image number
"RTN","MAGDIR9B",64,0)
 S IMAGE(20)=".05^"_INSTLOC
"RTN","MAGDIR9B",65,0)
 S IMAGE(21)="40^"_FILEDATA("PACKAGE")
"RTN","MAGDIR9B",66,0)
 S IMAGE(22)="41^"_$O(^MAG(2005.82,"B","CLIN",""))
"RTN","MAGDIR9B",67,0)
 S IMAGE(23)="42^"_FILEDATA("TYPE")
"RTN","MAGDIR9B",68,0)
 S IMAGE(24)="43^"_FILEDATA("PROC/EVENT")
"RTN","MAGDIR9B",69,0)
 S IMAGE(25)="44^"_FILEDATA("SPEC/SUBSPEC")
"RTN","MAGDIR9B",70,0)
 S IMAGE(26)="107^"_FILEDATA("ACQUISITION DEVICE")
"RTN","MAGDIR9B",71,0)
 S IMAGE(27)="251^"_FILEDATA("SOP CLASS POINTER")
"RTN","MAGDIR9B",72,0)
 D ADD^MAGGTIA(.RETURN,.IMAGE)
"RTN","MAGDIR9B",73,0)
 ;
"RTN","MAGDIR9B",74,0)
 S IMAGEPTR=+RETURN
"RTN","MAGDIR9B",75,0)
 I 'IMAGEPTR D  Q -103 ; fatal error
"RTN","MAGDIR9B",76,0)
 . K MSG
"RTN","MAGDIR9B",77,0)
 . S MSG(1)="IMAGE FILE CREATION ERROR:"
"RTN","MAGDIR9B",78,0)
 . S MSG(2)=$P(RETURN,"^",2,999)
"RTN","MAGDIR9B",79,0)
 . D BADERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9B",80,0)
 . Q
"RTN","MAGDIR9B",81,0)
 ;
"RTN","MAGDIR9B",82,0)
 I IMAGEPTR<LASTIMG D  Q -104 ; fatal last image pointer error
"RTN","MAGDIR9B",83,0)
 . D IMAGEPTR^MAGDIRVE($T(+0),IMAGEPTR,LASTIMG)
"RTN","MAGDIR9B",84,0)
 . Q
"RTN","MAGDIR9B",85,0)
 ;
"RTN","MAGDIR9B",86,0)
 S $P(RETURN,"^",4)=$$CHKPATH() ; hierarchal file patch check
"RTN","MAGDIR9B",87,0)
 ;
"RTN","MAGDIR9B",88,0)
 Q 0
"RTN","MAGDIR9B",89,0)
 ;
"RTN","MAGDIR9B",90,0)
CHKPATH() ; determine if the path is hierarchal (true) or not (false)
"RTN","MAGDIR9B",91,0)
 N D0,PATH
"RTN","MAGDIR9B",92,0)
 S D0="",PATH=$P(RETURN,"^",2)
"RTN","MAGDIR9B",93,0)
 I $D(^MAG(2005.2,"AC")) S D0=$O(^MAG(2005.2,"AC",PATH,""))
"RTN","MAGDIR9B",94,0)
 E  D
"RTN","MAGDIR9B",95,0)
 . N PLACE
"RTN","MAGDIR9B",96,0)
 . S PLACE=""
"RTN","MAGDIR9B",97,0)
 . F  S PLACE=$O(^MAG(2005.2,"E",PLACE)) Q:PLACE=""  D  Q:D0
"RTN","MAGDIR9B",98,0)
 . . S D0=$O(^MAG(2005.2,"E",PLACE,PATH,""))
"RTN","MAGDIR9B",99,0)
 . . Q
"RTN","MAGDIR9B",100,0)
 . Q
"RTN","MAGDIR9B",101,0)
 Q 'D0 ; network location file
"RTN","MAGDIR9B",102,0)
 ;
"RTN","MAGDIR9E")
0^23^B60855818
"RTN","MAGDIR9E",1,0)
MAGDIR9E ;WOIFO/PMK - Read a DICOM image file ; 06/06/2005  09:23
"RTN","MAGDIR9E",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDIR9E",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9E",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR9E",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR9E",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR9E",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR9E",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR9E",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR9E",10,0)
 ;; |                                                               |
"RTN","MAGDIR9E",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR9E",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR9E",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR9E",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR9E",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR9E",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9E",17,0)
 ;;
"RTN","MAGDIR9E",18,0)
 ;
"RTN","MAGDIR9E",19,0)
 ; M2MB server
"RTN","MAGDIR9E",20,0)
 ;
"RTN","MAGDIR9E",21,0)
 ; This routine creates the group entry in ^MAG(2005) and links it
"RTN","MAGDIR9E",22,0)
 ; to the consult/procedure request in GMRC.
"RTN","MAGDIR9E",23,0)
 ;
"RTN","MAGDIR9E",24,0)
 ;     XXXX                                         XXX       X
"RTN","MAGDIR9E",25,0)
 ;    XX  XX                                         XX      XX
"RTN","MAGDIR9E",26,0)
 ;   XX         XXXX    XX XXX  XXXXXXX  XX  XXX     XX     XXXXX
"RTN","MAGDIR9E",27,0)
 ;   XX        XX  XX   XXX XX  XX       XX  XX      XX      XX
"RTN","MAGDIR9E",28,0)
 ;   XX    X   XX  XX   XX  XX  XXXXXXX  XX  XX      XX      XX
"RTN","MAGDIR9E",29,0)
 ;    XX  XX   XX  XX   XX  XX       XX  XX  XX      XX      XX XX
"RTN","MAGDIR9E",30,0)
 ;     XXXX     XXXX    XX  XX  XXXXXXX   XXX XX    XXXX      XXX
"RTN","MAGDIR9E",31,0)
 ;
"RTN","MAGDIR9E",32,0)
 ;
"RTN","MAGDIR9E",33,0)
GROUP() ; entry point from ^MAGDIR8 for consult/procedure groups
"RTN","MAGDIR9E",34,0)
 N ACQDEVP ;-- pointer to acquisition device file (#2006.04)
"RTN","MAGDIR9E",35,0)
 N DA ;------- fileman variable
"RTN","MAGDIR9E",36,0)
 N ERRCODE ;-- error trap code
"RTN","MAGDIR9E",37,0)
 N GROUP ;---- array to pass group data to ^MAGGTIA
"RTN","MAGDIR9E",38,0)
 N MAGGPP ;--- pointer to group in DICOM GMRC TEMP LIST ^MAG(20006.5839)
"RTN","MAGDIR9E",39,0)
 N P ;-------- scratch variable (pointer to ACQUISITION DEVICE file)
"RTN","MAGDIR9E",40,0)
 N SERVICE ;-- service performing the consult/procedure - ^GMR(123.5)
"RTN","MAGDIR9E",41,0)
 N SOPCLASP ;- pointer to SOP Class file (#2006.532)
"RTN","MAGDIR9E",42,0)
 N TIUIEN ;--- TIU file 8925 IEN value
"RTN","MAGDIR9E",43,0)
 ;
"RTN","MAGDIR9E",44,0)
 S ERRCODE=""
"RTN","MAGDIR9E",45,0)
 ;
"RTN","MAGDIR9E",46,0)
 I STUDYDAT,STUDYTIM D  ; get study date/time from image header
"RTN","MAGDIR9E",47,0)
 . S DATETIME=(STUDYDAT_"."_STUDYTIM)-17000000 ; FileMan date.time fmt
"RTN","MAGDIR9E",48,0)
 . Q
"RTN","MAGDIR9E",49,0)
 E  D  ; use current date/time
"RTN","MAGDIR9E",50,0)
 . N %,%H,%I,X
"RTN","MAGDIR9E",51,0)
 . D NOW^%DTC S DATETIME=%
"RTN","MAGDIR9E",52,0)
 . Q
"RTN","MAGDIR9E",53,0)
 ;
"RTN","MAGDIR9E",54,0)
 ; initialize FILEDATA for GROUP and IMAGE
"RTN","MAGDIR9E",55,0)
 ; get the acquisition device pointer (file 2005, field 107)
"RTN","MAGDIR9E",56,0)
 S ACQDEVP=$$ACQDEV^MAGDFCNV(MFGR,MODEL,INSTLOC)
"RTN","MAGDIR9E",57,0)
 S FILEDATA("ACQUISITION DEVICE")=ACQDEVP
"RTN","MAGDIR9E",58,0)
 ; get the SOP Class pointer (file 2005, field 251)
"RTN","MAGDIR9E",59,0)
 S SOPCLASP=$O(^MAG(2006.532,"B",SOPCLASS,""))
"RTN","MAGDIR9E",60,0)
 S FILEDATA("SOP CLASS POINTER")=SOPCLASP
"RTN","MAGDIR9E",61,0)
 ;
"RTN","MAGDIR9E",62,0)
 S MAGGP="" ; initialize pointer to the image group
"RTN","MAGDIR9E",63,0)
 ;
"RTN","MAGDIR9E",64,0)
 ; check if there already is a TIU note attached to this request
"RTN","MAGDIR9E",65,0)
 ;
"RTN","MAGDIR9E",66,0)
 S TIUIEN=$$TIULAST^MAGDGMRC(GMRCIEN)
"RTN","MAGDIR9E",67,0)
 I TIUIEN D  Q:ERRCODE ERRCODE ; there is TIU note already
"RTN","MAGDIR9E",68,0)
 . ; double check TIU note DFN to make sure that it matches
"RTN","MAGDIR9E",69,0)
 . N HIT ; scratch variable used in finding corresponding image group
"RTN","MAGDIR9E",70,0)
 . N TIUDFN ; DFN value from ^TIU for double checking
"RTN","MAGDIR9E",71,0)
 . N TIUXDIEN ; TIU External Data File IEN
"RTN","MAGDIR9E",72,0)
 . S TIUDFN=$P($G(^TIU(8925,TIUIEN,0)),"^",2)
"RTN","MAGDIR9E",73,0)
 . I TIUDFN'=DFN D  Q  ; fatal error
"RTN","MAGDIR9E",74,0)
 . . D TIUMISS^MAGDIRVE($T(+0),DFN,TIUIEN,TIUDFN)
"RTN","MAGDIR9E",75,0)
 . . S ERRCODE=-501
"RTN","MAGDIR9E",76,0)
 . . Q
"RTN","MAGDIR9E",77,0)
 . ;
"RTN","MAGDIR9E",78,0)
 . S FILEDATA("PARENT FILE")=8925 ; TIU file
"RTN","MAGDIR9E",79,0)
 . S FILEDATA("PARENT IEN")=TIUIEN
"RTN","MAGDIR9E",80,0)
 . ;
"RTN","MAGDIR9E",81,0)
 . ; is there an entry in TIU External Data File for this note
"RTN","MAGDIR9E",82,0)
 . S (HIT,TIUXDIEN)=0
"RTN","MAGDIR9E",83,0)
 . F  S TIUXDIEN=$O(^TIU(8925.91,"B",TIUIEN,TIUXDIEN)) Q:'TIUXDIEN  D  Q:HIT  Q:ERRCODE
"RTN","MAGDIR9E",84,0)
 . . N MAG2 ;----- data value for getting parent file attributes
"RTN","MAGDIR9E",85,0)
 . . N GROUPDFN ;- DFN value from image group entry for double checking
"RTN","MAGDIR9E",86,0)
 . . ; there is a TIU External Data File
"RTN","MAGDIR9E",87,0)
 . . ; does the TIU External Data File entry point to an image group?
"RTN","MAGDIR9E",88,0)
 . . S MAGGP=$$GET1^DIQ(8925.91,TIUXDIEN,.02,"I") Q:'MAGGP
"RTN","MAGDIR9E",89,0)
 . . ; double check image group entry DFN
"RTN","MAGDIR9E",90,0)
 . . S GROUPDFN=$P($G(^MAG(2005,MAGGP,0)),"^",7)
"RTN","MAGDIR9E",91,0)
 . . I GROUPDFN'=DFN D  Q  ; fatal error
"RTN","MAGDIR9E",92,0)
 . . . D MISMATCH^MAGDIRVE($T(+0),DFN,MAGGP)
"RTN","MAGDIR9E",93,0)
 . . . S ERRCODE=-502
"RTN","MAGDIR9E",94,0)
 . . . Q
"RTN","MAGDIR9E",95,0)
 . . I $P($G(^MAG(2005,MAGGP,0)),"^",6)'=11 D  Q  ; 11=XRAY GROUP
"RTN","MAGDIR9E",96,0)
 . . . S MAGGP="" ; wrong object type - skip this image group
"RTN","MAGDIR9E",97,0)
 . . . Q
"RTN","MAGDIR9E",98,0)
 . . S P=$P($G(^MAG(2005,MAGGP,"SOP")),"^",1)
"RTN","MAGDIR9E",99,0)
 . . ; skip this image group if wrong SOP Class
"RTN","MAGDIR9E",100,0)
 . . I '$$EQUIVGRP^MAGDFCNV(P,SOPCLASP) S MAGGP="" Q
"RTN","MAGDIR9E",101,0)
 . . ; add the new image to this existing image group
"RTN","MAGDIR9E",102,0)
 . . S HIT=1,MAG2=$G(^MAG(2005,MAGGP,2))
"RTN","MAGDIR9E",103,0)
 . . S FILEDATA("PARENT FILE")=$P(MAG2,"^",6)
"RTN","MAGDIR9E",104,0)
 . . S FILEDATA("PARENT IEN")=$P(MAG2,"^",7)
"RTN","MAGDIR9E",105,0)
 . . S FILEDATA("PARENT FILE PTR")=$P(MAG2,"^",8)
"RTN","MAGDIR9E",106,0)
 . . I FILEDATA("PARENT IEN")'=TIUIEN D  ; fatal error
"RTN","MAGDIR9E",107,0)
 . . . D TIUMISS2^MAGDIRVE($T(+0),TIUIEN,FILEDATA("PARENT IEN"),TIUXDIEN,MAGGP)
"RTN","MAGDIR9E",108,0)
 . . . S ERRCODE=-503
"RTN","MAGDIR9E",109,0)
 . . . Q
"RTN","MAGDIR9E",110,0)
 . . Q
"RTN","MAGDIR9E",111,0)
 . Q
"RTN","MAGDIR9E",112,0)
 ;
"RTN","MAGDIR9E",113,0)
 ; need a temporary association for the consult/procedure request
"RTN","MAGDIR9E",114,0)
 ;
"RTN","MAGDIR9E",115,0)
 E  D  Q:ERRCODE ERRCODE ; check if there is a temporary association
"RTN","MAGDIR9E",116,0)
 . ;
"RTN","MAGDIR9E",117,0)
 . ; Note: this algorithm creates multiple groups for a study,
"RTN","MAGDIR9E",118,0)
 . ;       for instance a GI fluoroscopy + color images
"RTN","MAGDIR9E",119,0)
 . ;
"RTN","MAGDIR9E",120,0)
 . S MAGGPP=""
"RTN","MAGDIR9E",121,0)
 . F  S MAGGPP=$O(^MAG(2006.5839,"C",123,GMRCIEN,MAGGPP)) Q:'MAGGPP  D  Q:ERRCODE
"RTN","MAGDIR9E",122,0)
 . . N GROUPDFN ; DFN value from image group entry for double checking
"RTN","MAGDIR9E",123,0)
 . . S MAGGP=$P(^MAG(2006.5839,MAGGPP,0),"^",3)
"RTN","MAGDIR9E",124,0)
 . . ; double check image group entry DFN in existing 2005 group node
"RTN","MAGDIR9E",125,0)
 . . S GROUPDFN=$P($G(^MAG(2005,MAGGP,0)),"^",7)
"RTN","MAGDIR9E",126,0)
 . . I GROUPDFN'=DFN D  ; fatal error
"RTN","MAGDIR9E",127,0)
 . . . D MISMATCH^MAGDIRVE($T(+0),DFN,MAGGP)
"RTN","MAGDIR9E",128,0)
 . . . S MAGGP="" ; bad group
"RTN","MAGDIR9E",129,0)
 . . . S ERRCODE=-504
"RTN","MAGDIR9E",130,0)
 . . . Q
"RTN","MAGDIR9E",131,0)
 . . E  S P=$P($G(^MAG(2005,MAGGP,100)),"^",4) I P,P'=ACQDEVP D  ; wrong device
"RTN","MAGDIR9E",132,0)
 . . . S MAGGP="" ; wrong acquisition device - skip this image group
"RTN","MAGDIR9E",133,0)
 . . . Q
"RTN","MAGDIR9E",134,0)
 . . E  D  ; add the new image to this existing image group
"RTN","MAGDIR9E",135,0)
 . . . N MAG2 ; data value for getting parent file attributes
"RTN","MAGDIR9E",136,0)
 . . . S MAG2=$G(^MAG(2005,MAGGP,2))
"RTN","MAGDIR9E",137,0)
 . . . S FILEDATA("PARENT FILE")=$P(MAG2,"^",6)
"RTN","MAGDIR9E",138,0)
 . . . S FILEDATA("PARENT IEN")=$P(MAG2,"^",7)
"RTN","MAGDIR9E",139,0)
 . . . S FILEDATA("PARENT FILE PTR")=$P(MAG2,"^",8) ; should be null
"RTN","MAGDIR9E",140,0)
 . . . I FILEDATA("PARENT FILE")'=2006.5839 D  ; fatal error
"RTN","MAGDIR9E",141,0)
 . . . . D TMPMISS^MAGDIRVE($T(+0),FILEDATA("PARENT FILE"),MAGGP)
"RTN","MAGDIR9E",142,0)
 . . . . S ERRCODE=-505
"RTN","MAGDIR9E",143,0)
 . . . . Q
"RTN","MAGDIR9E",144,0)
 . . . Q
"RTN","MAGDIR9E",145,0)
 . . Q
"RTN","MAGDIR9E",146,0)
 . ;
"RTN","MAGDIR9E",147,0)
 . I 'MAGGP  D  ; no group exists yet create a temporary association
"RTN","MAGDIR9E",148,0)
 . . S FILEDATA("PARENT FILE")=2006.5839 ; GMRC file
"RTN","MAGDIR9E",149,0)
 . . S FILEDATA("PARENT IEN")=GMRCIEN
"RTN","MAGDIR9E",150,0)
 . . Q
"RTN","MAGDIR9E",151,0)
 . Q
"RTN","MAGDIR9E",152,0)
 ;
"RTN","MAGDIR9E",153,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR9E",154,0)
 S FILEDATA("PACKAGE")="CONS"
"RTN","MAGDIR9E",155,0)
 ;
"RTN","MAGDIR9E",156,0)
 ; lookup study in ^GMR(123) and get FILEDATA variables
"RTN","MAGDIR9E",157,0)
 S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDIR9E",158,0)
 I SERVICE D
"RTN","MAGDIR9E",159,0)
 . N P200584,X,Y
"RTN","MAGDIR9E",160,0)
 . I $D(^MAG(2006.5831,SERVICE,0)) D
"RTN","MAGDIR9E",161,0)
 . . S P200584=$P(^MAG(2006.5831,SERVICE,0),"^",2)
"RTN","MAGDIR9E",162,0)
 . . S X=$$FIELD43^MAGXMA(MODALITY,P200584,.Y)
"RTN","MAGDIR9E",163,0)
 . . S FILEDATA("PROC/EVENT")=$S(X=0:Y,1:"")
"RTN","MAGDIR9E",164,0)
 . . S FILEDATA("SPEC/SUBSPEC")=P200584
"RTN","MAGDIR9E",165,0)
 . . Q
"RTN","MAGDIR9E",166,0)
 . E  D  ; service was removed from ^MAG(2006.5831)
"RTN","MAGDIR9E",167,0)
 . . S FILEDATA("PROC/EVENT")=""
"RTN","MAGDIR9E",168,0)
 . . S FILEDATA("SPEC/SUBSPEC")=""
"RTN","MAGDIR9E",169,0)
 . . Q
"RTN","MAGDIR9E",170,0)
 . Q
"RTN","MAGDIR9E",171,0)
 E  D
"RTN","MAGDIR9E",172,0)
 . S FILEDATA("PROC/EVENT")=""
"RTN","MAGDIR9E",173,0)
 . S FILEDATA("SPEC/SUBSPEC")=""
"RTN","MAGDIR9E",174,0)
 . Q
"RTN","MAGDIR9E",175,0)
 ;
"RTN","MAGDIR9E",176,0)
 ; if the 2005 group node does not yet exist, create it
"RTN","MAGDIR9E",177,0)
 ;
"RTN","MAGDIR9E",178,0)
 I 'MAGGP D  Q:ERRCODE ERRCODE ; create the imaging group
"RTN","MAGDIR9E",179,0)
 . D NEWGROUP^MAGDIR9A("CON/PROC") Q:ERRCODE
"RTN","MAGDIR9E",180,0)
 . ;
"RTN","MAGDIR9E",181,0)
 . I FILEDATA("PARENT FILE")=8925 D  Q:ERRCODE  ; fix for ^TIU
"RTN","MAGDIR9E",182,0)
 . . S ERRCODE=$$TIUXLINK^MAGDIR9E()
"RTN","MAGDIR9E",183,0)
 . . Q
"RTN","MAGDIR9E",184,0)
 . E  I FILEDATA("PARENT FILE")=2006.5839 D  ; fix for ^GMR
"RTN","MAGDIR9E",185,0)
 . . L +^MAG(2006.5839)
"RTN","MAGDIR9E",186,0)
 . . I '$D(^MAG(2006.5839,0)) D
"RTN","MAGDIR9E",187,0)
 . . . S ^MAG(2006.5839,0)="DICOM GMRC TEMP LIST^^0^0"
"RTN","MAGDIR9E",188,0)
 . . . Q
"RTN","MAGDIR9E",189,0)
 . . S D0=$P(^MAG(2006.5839,0),"^",3)+1
"RTN","MAGDIR9E",190,0)
 . . S $P(^MAG(2006.5839,0),"^",3)=D0,$P(^(0),"^",4)=$P(^(0),"^",4)+1
"RTN","MAGDIR9E",191,0)
 . . L -^MAG(2006.5839)
"RTN","MAGDIR9E",192,0)
 . . S ^MAG(2006.5839,D0,0)="123^"_GMRCIEN_"^"_MAGGP
"RTN","MAGDIR9E",193,0)
 . . S ^MAG(2006.5839,"C",123,GMRCIEN,D0)=""
"RTN","MAGDIR9E",194,0)
 . . Q
"RTN","MAGDIR9E",195,0)
 . Q
"RTN","MAGDIR9E",196,0)
 ;
"RTN","MAGDIR9E",197,0)
 ; check for intra-oral x-ray images & get tooth number(s)
"RTN","MAGDIR9E",198,0)
 I IMAGNAME'="" S FILEDATA("SHORT DESCRIPTION")=IMAGNAME
"RTN","MAGDIR9E",199,0)
 Q 0
"RTN","MAGDIR9E",200,0)
 ;
"RTN","MAGDIR9E",201,0)
TIUXLINK() ; create the cross-linkages to TIU EXTERNAL DATA LINK file
"RTN","MAGDIR9E",202,0)
 N TIUXDIEN
"RTN","MAGDIR9E",203,0)
 D PUTIMAGE^TIUSRVPL(.TIUXDIEN,TIUIEN,MAGGP)
"RTN","MAGDIR9E",204,0)
 I TIUXDIEN D
"RTN","MAGDIR9E",205,0)
 . S FILEDATA("PARENT FILE PTR")=TIUXDIEN
"RTN","MAGDIR9E",206,0)
 . S $P(^MAG(2005,MAGGP,2),"^",8)=TIUXDIEN
"RTN","MAGDIR9E",207,0)
 . Q
"RTN","MAGDIR9E",208,0)
 E  D  Q ERRCODE ; fatal error
"RTN","MAGDIR9E",209,0)
 . K MSG
"RTN","MAGDIR9E",210,0)
 . S MSG(1)="ERROR ASSOCIATING WITH TIU EXTERNAL DATA LINK (file 8925.91):"
"RTN","MAGDIR9E",211,0)
 . S MSG(2)=$P(TIUXDIEN,"^",2,999)
"RTN","MAGDIR9E",212,0)
 . D BADERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9E",213,0)
 . S ERRCODE=-508
"RTN","MAGDIR9E",214,0)
 . Q
"RTN","MAGDIR9E",215,0)
 Q 0
"RTN","MAGDIR9E",216,0)
 ;
"RTN","MAGDLB12")
0^24^B22785592
"RTN","MAGDLB12",1,0)
MAGDLB12 ;WOIFO/LB,MLH - Routine to fix failed DICOM entries  ; 06/06/2005  09:24
"RTN","MAGDLB12",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDLB12",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB12",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLB12",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLB12",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLB12",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLB12",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLB12",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLB12",10,0)
 ;; |                                                               |
"RTN","MAGDLB12",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLB12",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLB12",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLB12",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLB12",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLB12",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB12",17,0)
 ;;
"RTN","MAGDLB12",18,0)
 Q
"RTN","MAGDLB12",19,0)
LOOP ;
"RTN","MAGDLB12",20,0)
 N ANS,ANSR,CASENO,COMNT1,DATA,DATA1,DATA2,DATE,FILE,FIRST,FIRSTS
"RTN","MAGDLB12",21,0)
 N MACHID,MAGDY,MAGDIEN,MAGIEN,MAGTYPE,MSG,START,STOP
"RTN","MAGDLB12",22,0)
 N MOD,MODEL,NEWCAS,NEWDFN,NEWDTI,NEWDTIM,NEWMUL,NEWNME,NEWPIEN,NEWPROC
"RTN","MAGDLB12",23,0)
 N NEWSSN,OK,OOUT,OUT,PAT,PID,PP,PREV,PREVS,REASON,SITE,STUDYUID,WHY,MAGFIX
"RTN","MAGDLB12",24,0)
 N KFIXALL ; -- does user hold MAGDFIX ALL security key?
"RTN","MAGDLB12",25,0)
 ;
"RTN","MAGDLB12",26,0)
 S KFIXALL=$$SECKEY()
"RTN","MAGDLB12",27,0)
 S (OOUT,OUT,PREV,FIRST)=0
"RTN","MAGDLB12",28,0)
 ; select a site - bail if no images to correct or no site selected
"RTN","MAGDLB12",29,0)
 S STAT=$$SITE(.SITE) Q:'SITE
"RTN","MAGDLB12",30,0)
 S SUID=0
"RTN","MAGDLB12",31,0)
 F  S SUID=$O(^MAGD(2006.575,"F",SITE,SUID)) Q:SUID=""!(OOUT)  D
"RTN","MAGDLB12",32,0)
 . S MAGIEN=$O(^MAGD(2006.575,"F",SITE,SUID,0)) Q:'MAGIEN
"RTN","MAGDLB12",33,0)
 . ; if image isn't on file, clean up xrefs
"RTN","MAGDLB12",34,0)
 . I '$D(^MAGD(2006.575,MAGIEN,0)) D  Q
"RTN","MAGDLB12",35,0)
 . . K ^MAGD(2006.575,"F",SITE,SUID,MAGIEN)
"RTN","MAGDLB12",36,0)
 . . Q
"RTN","MAGDLB12",37,0)
 . ; if gateway site isn't the user's site, bail unless the user holds
"RTN","MAGDLB12",38,0)
 . ; the MAGDFIX ALL security key
"RTN","MAGDLB12",39,0)
 . I $P($G(^MAGD(2006.575,MAGIEN,1)),U,5)'=DUZ(2),'KFIXALL Q
"RTN","MAGDLB12",40,0)
 . ;Only process Radiology images...medicine images done by other rtns.
"RTN","MAGDLB12",41,0)
 . S MAGTYPE=$P($G(^MAGD(2006.575,MAGIEN,"TYPE")),"^") I MAGTYPE'["RAD" Q
"RTN","MAGDLB12",42,0)
 . I $D(^MAGD(2006.575,MAGIEN,"FIXD")),$P(^MAGD(2006.575,MAGIEN,"FIXD"),"^") Q
"RTN","MAGDLB12",43,0)
 . I 'FIRST S PREV=MAGIEN,PREVS=SUID,FIRST=MAGIEN
"RTN","MAGDLB12",44,0)
 . D SET^MAGDLB1
"RTN","MAGDLB12",45,0)
 . Q
"RTN","MAGDLB12",46,0)
 Q
"RTN","MAGDLB12",47,0)
SITE(XSITE) ; select a site for which to process entries
"RTN","MAGDLB12",48,0)
 ; input:        none
"RTN","MAGDLB12",49,0)
 ; output:   .XSITE   site number for which to process entries
"RTN","MAGDLB12",50,0)
 ;
"RTN","MAGDLB12",51,0)
 ; return:   0 always
"RTN","MAGDLB12",52,0)
 ;
"RTN","MAGDLB12",53,0)
 N CNT,KFIXALL,RESULT,SITES
"RTN","MAGDLB12",54,0)
 S (CNT,XSITE)=0 F  S XSITE=$O(^MAGD(2006.575,"F",XSITE)) Q:'XSITE  D
"RTN","MAGDLB12",55,0)
 . Q:'$$FIND1^DIC(4,"","","`"_XSITE)
"RTN","MAGDLB12",56,0)
 . S CNT=CNT+1,SITES(CNT)=XSITE
"RTN","MAGDLB12",57,0)
 . Q
"RTN","MAGDLB12",58,0)
 Q:'CNT 0
"RTN","MAGDLB12",59,0)
 ;
"RTN","MAGDLB12",60,0)
 S KFIXALL=$$SECKEY I '$$MDIV S KFIXALL=1
"RTN","MAGDLB12",61,0)
 ; If not multi-division set the KFIXALL - site should be able to correct any entry
"RTN","MAGDLB12",62,0)
 I KFIXALL D FIX(.SITES,CNT) Q 0
"RTN","MAGDLB12",63,0)
 I $D(DUZ(2)) D  Q 0
"RTN","MAGDLB12",64,0)
 . S XSITE=DUZ(2)
"RTN","MAGDLB12",65,0)
 . I '$D(^MAGD(2006.575,"F",XSITE)) W !,"No entries for division "_$$GET1^DIQ(4,+XSITE,".01","E")
"RTN","MAGDLB12",66,0)
 . Q
"RTN","MAGDLB12",67,0)
 D LKUSR(.RESULT,DUZ)
"RTN","MAGDLB12",68,0)
 I '$D(RESULT(0)) Q 0
"RTN","MAGDLB12",69,0)
 I $P(RESULT(0),"^")=0 W !,$P(RESULT,"^",2) Q 0
"RTN","MAGDLB12",70,0)
 ;
"RTN","MAGDLB12",71,0)
 N EN,II,NSITE,MAGSITE,X
"RTN","MAGDLB12",72,0)
 S (CNT,XSITE)=0
"RTN","MAGDLB12",73,0)
 S X=0 F  S X=$O(SITES(X)) Q:'X  S II=$G(SITES(X)) I II S NSITE(II)=""
"RTN","MAGDLB12",74,0)
 S II=0
"RTN","MAGDLB12",75,0)
 F  S II=$O(RESULT(II)) Q:'II  S EN=$G(RESULT(II)) I $D(NSITE(EN)) S CNT=CNT+1,MAGSITE(CNT)=EN
"RTN","MAGDLB12",76,0)
 I 'CNT Q 0 ;no matches
"RTN","MAGDLB12",77,0)
 I CNT=1 S XSITE=$G(MAGSITE(1)) Q 0
"RTN","MAGDLB12",78,0)
 D FIX(.MAGSITE,CNT) ; select a SITE to fix
"RTN","MAGDLB12",79,0)
 Q 0
"RTN","MAGDLB12",80,0)
 ;
"RTN","MAGDLB12",81,0)
FIX(SITES,CNT) ;SUBROUTINE - Prepare to fix the entries for the user's division entries.
"RTN","MAGDLB12",82,0)
 ; Multiple divisions have images to be corrected and user has appropriate security key.
"RTN","MAGDLB12",83,0)
 N DIR,I,Y,X
"RTN","MAGDLB12",84,0)
 I 'CNT Q
"RTN","MAGDLB12",85,0)
 I CNT=1 S SITE=$G(SITES(CNT)) Q
"RTN","MAGDLB12",86,0)
 S I=0 F  S I=$O(SITES(I)) Q:'I  D
"RTN","MAGDLB12",87,0)
 . W !,I,") ",$G(SITES(I)),"  ",$$GET1^DIQ(4,+$G(SITES(I)),".01","E")
"RTN","MAGDLB12",88,0)
 . Q
"RTN","MAGDLB12",89,0)
 F  D  Q:Y'>CNT
"RTN","MAGDLB12",90,0)
 . S DIR(0)="N:1:"_CNT
"RTN","MAGDLB12",91,0)
 . S DIR("A",1)="There are images to be corrected for multiple divisions."
"RTN","MAGDLB12",92,0)
 . S DIR("A")="Select by number (1-"_CNT_")"
"RTN","MAGDLB12",93,0)
 . D ^DIR
"RTN","MAGDLB12",94,0)
 . W:Y>CNT " ??"
"RTN","MAGDLB12",95,0)
 . Q
"RTN","MAGDLB12",96,0)
 S:Y SITE=$G(SITES(+Y))
"RTN","MAGDLB12",97,0)
 Q
"RTN","MAGDLB12",98,0)
 ;
"RTN","MAGDLB12",99,0)
SECKEY() ;
"RTN","MAGDLB12",100,0)
 N MAGKY,MAGRSLT
"RTN","MAGDLB12",101,0)
 I '$D(DUZ) Q 0
"RTN","MAGDLB12",102,0)
 S MAGKY("MAGDFIX ALL")="MAGDFIX ALL"
"RTN","MAGDLB12",103,0)
 D OWNSKEY^XUSRB(.MAGRSLT,.MAGKY)
"RTN","MAGDLB12",104,0)
 I +$G(MAGRSLT("MAGDFIX ALL")) Q 1
"RTN","MAGDLB12",105,0)
 Q 0
"RTN","MAGDLB12",106,0)
 ;
"RTN","MAGDLB12",107,0)
MDIV() ;Multi-divisional flag
"RTN","MAGDLB12",108,0)
 N CNT,I
"RTN","MAGDLB12",109,0)
 S (CNT,I)=0
"RTN","MAGDLB12",110,0)
 F  S I=$O(^MAG(2006.1,I)) Q:'I  S CNT=CNT+1
"RTN","MAGDLB12",111,0)
 I CNT>1 Q 1
"RTN","MAGDLB12",112,0)
 Q 0
"RTN","MAGDLB12",113,0)
 ;
"RTN","MAGDLB12",114,0)
LKUSR(RESULT,USER) ;
"RTN","MAGDLB12",115,0)
 ;RETURNS: 0^Message for failure
"RTN","MAGDLB12",116,0)
 ;         IENs for Institution file entry^
"RTN","MAGDLB12",117,0)
 ; If the user has more than one division and more than one match in the Imaging Site
"RTN","MAGDLB12",118,0)
 ; Parameter file, then it returns the 1st matching division entry in the New Person file.
"RTN","MAGDLB12",119,0)
 I $D(DUZ(2)) S RESULT(0)="1^Number of entries",RESULT(DUZ(2))=DUZ(2) Q
"RTN","MAGDLB12",120,0)
 N MAGARRAY,CNT,MAGERR,MAGOUT,MAGDV,MAGX
"RTN","MAGDLB12",121,0)
 S RESULT(0)="0^Your division entry is not part of the Imaging Site Parameter."
"RTN","MAGDLB12",122,0)
 D GETS^DIQ(200,USER,"16*","I","MAGOUT")
"RTN","MAGDLB12",123,0)
 ;MAGOUT(200.02,"institution entry,duz,",.01,"I")=institution entry
"RTN","MAGDLB12",124,0)
 I $D(MAGOUT)=0 Q
"RTN","MAGDLB12",125,0)
 S MAGX="",CNT=0
"RTN","MAGDLB12",126,0)
 F  S MAGX=$O(MAGOUT(200.02,MAGX)) Q:MAGX=""  D
"RTN","MAGDLB12",127,0)
 . S MAGDV=$P(MAGX,",") I $D(^MAG(2006.1,"B",MAGDV)) S CNT=CNT+1,MAGARRAY(CNT)=MAGDV
"RTN","MAGDLB12",128,0)
 . Q
"RTN","MAGDLB12",129,0)
 I 'CNT Q
"RTN","MAGDLB12",130,0)
 S CNT=0
"RTN","MAGDLB12",131,0)
 S X=0 F  S X=$O(MAGARRAY(X)) Q:'X  S CNT=CNT+1,RESULT(X)=$P(MAGARRAY(X),"^")
"RTN","MAGDLB12",132,0)
 S RESULT(0)=CNT_"^Number of entries"
"RTN","MAGDLB12",133,0)
 ; Get the 1st institution, the calling routine should check for keys.
"RTN","MAGDLB12",134,0)
 Q
"RTN","MAGDLB12",135,0)
 ;
"RTN","MAGDLB6")
0^25^B5741563
"RTN","MAGDLB6",1,0)
MAGDLB6 ;WOIFO/LB,MLH - DICOM file utilities ; 12/16/2004  11:30
"RTN","MAGDLB6",2,0)
 ;;3.0;IMAGING;**21,10,11,51**;26-August-2005
"RTN","MAGDLB6",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB6",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLB6",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLB6",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLB6",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLB6",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLB6",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLB6",10,0)
 ;; |                                                               |
"RTN","MAGDLB6",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLB6",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLB6",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLB6",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLB6",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLB6",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB6",17,0)
 ;;
"RTN","MAGDLB6",18,0)
 Q
"RTN","MAGDLB6",19,0)
 ;
"RTN","MAGDLB6",20,0)
XREF ; Set "F" xref for fields 36 and 9 - Gateway Location and Study UID
"RTN","MAGDLB6",21,0)
 N GWLOC ; -- location number of DICOM Gateway
"RTN","MAGDLB6",22,0)
 N ORIG ; --- Entry number for original image for this study
"RTN","MAGDLB6",23,0)
 N PREDA ; -- original DA value
"RTN","MAGDLB6",24,0)
 S GWLOC=$P(^MAGD(2006.575,DA,1),"^",5) Q:'GWLOC
"RTN","MAGDLB6",25,0)
 ;
"RTN","MAGDLB6",26,0)
 ; If this is the first one, create the "F" cross-reference
"RTN","MAGDLB6",27,0)
 ;
"RTN","MAGDLB6",28,0)
 I '$D(^MAGD(2006.575,"F",GWLOC,X)) D  Q
"RTN","MAGDLB6",29,0)
 . S ^MAGD(2006.575,"F",GWLOC,X,DA)=""
"RTN","MAGDLB6",30,0)
 . Q
"RTN","MAGDLB6",31,0)
 ;
"RTN","MAGDLB6",32,0)
 ; Otherwise, the image is "related" to the original one
"RTN","MAGDLB6",33,0)
 ; for this study.
"RTN","MAGDLB6",34,0)
 ;
"RTN","MAGDLB6",35,0)
 S ORIG=$O(^MAGD(2006.575,"F",GWLOC,X,0))
"RTN","MAGDLB6",36,0)
 Q:'$D(^MAGD(2006.575,ORIG,0))  ; No longer in database
"RTN","MAGDLB6",37,0)
 S PREDA=DA D
"RTN","MAGDLB6",38,0)
 . N D0,DA,DD,DIC,DIE,ERR,X,Y
"RTN","MAGDLB6",39,0)
 . S DIC="^MAGD(2006.575,"_ORIG_",""RLATE"","
"RTN","MAGDLB6",40,0)
 . S DIC(0)="L"
"RTN","MAGDLB6",41,0)
 . S DA(1)=ORIG,X=PREDA
"RTN","MAGDLB6",42,0)
 . S ERR="Related Image ("_X_") for image #"_ORIG_" not filed."
"RTN","MAGDLB6",43,0)
 . D FILE^DICN
"RTN","MAGDLB6",44,0)
 . I Y=-1 D EN^DDIOL(ERR,"","!")
"RTN","MAGDLB6",45,0)
 . Q
"RTN","MAGDLB6",46,0)
 Q
"RTN","MAGDLB6",47,0)
 ;
"RTN","MAGDLB6",48,0)
XREFK ; Kill "F" cross-reference
"RTN","MAGDLB6",49,0)
 N GWLOC
"RTN","MAGDLB6",50,0)
 Q:'DA
"RTN","MAGDLB6",51,0)
 S GWLOC=$P(^MAGD(2006.575,DA,1),"^",5) Q:'GWLOC
"RTN","MAGDLB6",52,0)
 K ^MAGD(2006.575,"F",GWLOC,X,DA)
"RTN","MAGDLB6",53,0)
 Q
"RTN","MAGDLB6",54,0)
 ;
"RTN","MAGDLBAA")
0^26^B12734072
"RTN","MAGDLBAA",1,0)
MAGDLBAA ;WOIFO/LB - Routine to move failed dicom images to ^MAG(2006.575 ; 03/08/2005  07:04
"RTN","MAGDLBAA",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDLBAA",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLBAA",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLBAA",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLBAA",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLBAA",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLBAA",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLBAA",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLBAA",10,0)
 ;; |                                                               |
"RTN","MAGDLBAA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLBAA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLBAA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLBAA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLBAA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLBAA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLBAA",17,0)
 ;;
"RTN","MAGDLBAA",18,0)
 Q
"RTN","MAGDLBAA",19,0)
MOVE ;called from MAGDIR1 to move entries not matching Radiology case #.
"RTN","MAGDLBAA",20,0)
 ;Not done thru FM because the system should be independent.
"RTN","MAGDLBAA",21,0)
 ;These variable are needed to be defined before using this routine:
"RTN","MAGDLBAA",22,0)
 ;PIDCHECK, FIRSTDCM, IMGSVC, MIDCM, MACHID,ACNUMB, CASENUMB, PNAMEDCM, PID
"RTN","MAGDLBAA",23,0)
 ;MODALITY, CASETEXT
"RTN","MAGDLBAA",24,0)
 N DATE,REASON,IEN,NIEN,ORIG,DCMPNME,CASE,CASENUM,PATIENT
"RTN","MAGDLBAA",25,0)
 D NOW^%DTC S DATE=X
"RTN","MAGDLBAA",26,0)
 ;ADD ENTRY
"RTN","MAGDLBAA",27,0)
 L +^MAGD(2006.575,0):1E9 ; Background process MUST wait
"RTN","MAGDLBAA",28,0)
 S X=$G(^MAGD(2006.575,0))
"RTN","MAGDLBAA",29,0)
 S $P(X,"^",1,2)="DICOM FAILED IMAGES^2006.575"
"RTN","MAGDLBAA",30,0)
 S IEN=$O(^MAGD(2006.575," "),-1)+1,$P(X,"^",3)=IEN
"RTN","MAGDLBAA",31,0)
 S $P(X,"^",4)=$P(X,"^",4)+1 ; # entries
"RTN","MAGDLBAA",32,0)
 S ^MAGD(2006.575,0)=X
"RTN","MAGDLBAA",33,0)
 ;
"RTN","MAGDLBAA",34,0)
 S REASON=$P(PIDCHECK,",",2)
"RTN","MAGDLBAA",35,0)
 S PATIENT=LASTDCM_","_FIRSTDCM_$S($L(MIDCM)>0:" "_MIDCM,1:"")
"RTN","MAGDLBAA",36,0)
 S MACHID=$G(MACHID,"A")
"RTN","MAGDLBAA",37,0)
 ; PNAMEDCM usually contains an "^" between last & first name
"RTN","MAGDLBAA",38,0)
 ; CHANGE ^ TO ~
"RTN","MAGDLBAA",39,0)
 S CASE=$TR(ACNUMB,"^","~"),CASENUM=$TR(CASENUMB,"^","~")
"RTN","MAGDLBAA",40,0)
 S DCMPNME=$TR(PNAMEDCM,"^","~")
"RTN","MAGDLBAA",41,0)
 S ^MAGD(2006.575,IEN,0)=FROMPATH_"^"_REASON_"^"_PID_"^"_PATIENT_"^"_DCMPNME
"RTN","MAGDLBAA",42,0)
 S ^MAGD(2006.575,IEN,1)=CASE_"^"_CASENUM_"^"_DATE_"^"_MACHID_"^"_LOCATION
"RTN","MAGDLBAA",43,0)
 S ^MAGD(2006.575,IEN,"AIUID")=$G(IMAGEUID)
"RTN","MAGDLBAA",44,0)
 S ^MAGD(2006.575,IEN,"ASUID")=STUDYUID
"RTN","MAGDLBAA",45,0)
 S ^MAGD(2006.575,IEN,"AMFG")=$G(INSTNAME)_"^"_$G(ROWS)_"^"_$G(COLUMNS)_"^"_$G(OFFSET)_"^"_$G(MODIEN)_"^"_$G(MODALITY)_"^"_$$UP^MAGDFCNV($G(MFGR))_"^"_$$UP^MAGDFCNV($G(MODEL))_"^"_LOCATION
"RTN","MAGDLBAA",46,0)
 S ^MAGD(2006.575,IEN,"ACSTXT")=$G(CASETEXT)
"RTN","MAGDLBAA",47,0)
 ; Image type can be RAD, MEDICINE, SURGERY, etc.
"RTN","MAGDLBAA",48,0)
 S ^MAGD(2006.575,IEN,"TYPE")=$G(IMGSVC)
"RTN","MAGDLBAA",49,0)
 ;Setting xrefs
"RTN","MAGDLBAA",50,0)
 S ^MAGD(2006.575,"B",FROMPATH,IEN)=""
"RTN","MAGDLBAA",51,0)
 ; Clean up---no longer need this cross reference
"RTN","MAGDLBAA",52,0)
 K ^MAGD(2006.575,"D") ; Used for Consults only
"RTN","MAGDLBAA",53,0)
 L -^MAGD(2006.575,0)
"RTN","MAGDLBAA",54,0)
 ;
"RTN","MAGDLBAA",55,0)
 ;The following xref ("F") will be set on the 1st entry having a unique
"RTN","MAGDLBAA",56,0)
 ;STUDYUID. The remaining entries with the same # will be added
"RTN","MAGDLBAA",57,0)
 ;to the RELATED IMAGES multiple field for the entry that set the
"RTN","MAGDLBAA",58,0)
 ;F xref.
"RTN","MAGDLBAA",59,0)
 S ORIG=0
"RTN","MAGDLBAA",60,0)
 I '$D(^MAGD(2006.575,"F",LOCATION,STUDYUID)) D  Q  ; Quit if 1st entry
"RTN","MAGDLBAA",61,0)
 . S ^MAGD(2006.575,"F",LOCATION,STUDYUID,IEN)=""
"RTN","MAGDLBAA",62,0)
 . Q
"RTN","MAGDLBAA",63,0)
 S ORIG=$O(^MAGD(2006.575,"F",LOCATION,STUDYUID,0))
"RTN","MAGDLBAA",64,0)
 Q:'ORIG
"RTN","MAGDLBAA",65,0)
 I ORIG'=IEN D
"RTN","MAGDLBAA",66,0)
 . I '$D(^MAGD(2006.575,ORIG,"RLATE",0)) D
"RTN","MAGDLBAA",67,0)
 . . S ^MAGD(2006.575,ORIG,"RLATE",0)="^2006.57526PA^^"
"RTN","MAGDLBAA",68,0)
 . S NIEN=$P(^MAGD(2006.575,ORIG,"RLATE",0),"^",3),NIEN=NIEN+1
"RTN","MAGDLBAA",69,0)
 . S $P(^MAGD(2006.575,ORIG,"RLATE",0),"^",3)=NIEN ; #next ien entry
"RTN","MAGDLBAA",70,0)
 . S $P(^MAGD(2006.575,ORIG,"RLATE",0),"^",4)=$P(^MAGD(2006.575,ORIG,"RLATE",0),"^",4)+1 ; #record for multiple field
"RTN","MAGDLBAA",71,0)
 . S ^MAGD(2006.575,ORIG,"RLATE",NIEN,0)=IEN
"RTN","MAGDLBAA",72,0)
 . S ^MAGD(2006.575,ORIG,"RLATE","B",IEN,NIEN)=""
"RTN","MAGDLBAA",73,0)
 . Q
"RTN","MAGDLBAA",74,0)
 Q
"RTN","MAGDLBAA",75,0)
 ;
"RTN","MAGDLBV")
0^27^B16977570
"RTN","MAGDLBV",1,0)
MAGDLBV ;WOIFO/EdM - Validate Table with failed DICOM entries ; 12/16/2004  06:59
"RTN","MAGDLBV",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGDLBV",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLBV",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLBV",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLBV",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLBV",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLBV",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLBV",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLBV",10,0)
 ;; |                                                               |
"RTN","MAGDLBV",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLBV",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLBV",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLBV",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLBV",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLBV",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLBV",17,0)
 ;;
"RTN","MAGDLBV",18,0)
 Q
"RTN","MAGDLBV",19,0)
 ;
"RTN","MAGDLBV",20,0)
MENU ; This entry is called from the VistA menu
"RTN","MAGDLBV",21,0)
 W !!,"Starting Validation of data in DICOM Failed Images Table.",!
"RTN","MAGDLBV",22,0)
 D VALIDATE(.OUT,1)
"RTN","MAGDLBV",23,0)
 W !!,OUT," entr",$S(OUT=1:"y",1:"ies")," currently in database.",!
"RTN","MAGDLBV",24,0)
 Q
"RTN","MAGDLBV",25,0)
 ;
"RTN","MAGDLBV",26,0)
VALIDATE(OUT,MENU) ; RPC = MAG DICOM CORRECT VALIDATE
"RTN","MAGDLBV",27,0)
 N D0,D1,FIXED,L0,L1,LOC,N0,N1,TP,V,X
"RTN","MAGDLBV",28,0)
 L +^MAGD(2006.575):1E9
"RTN","MAGDLBV",29,0)
 S MENU=+$G(MENU)
"RTN","MAGDLBV",30,0)
 F X="AD","AFX","B","D","F" K ^MAGD(2006.575,X)
"RTN","MAGDLBV",31,0)
 S (L0,N0)=0
"RTN","MAGDLBV",32,0)
 S D0=0 F  S D0=$O(^MAGD(2006.575,D0)) Q:'D0  D
"RTN","MAGDLBV",33,0)
 . S X=$G(^MAGD(2006.575,D0,0)) I X="" K ^MAGD(2006.575,D0) Q
"RTN","MAGDLBV",34,0)
 . S L0=D0,N0=N0+1,(L1,N1)=0
"RTN","MAGDLBV",35,0)
 . S FIXED=+$G(^MAGD(2006.575,D0,"FIXD"))
"RTN","MAGDLBV",36,0)
 . S TYPE=$P($G(^MAGD(2006.575,D0,"TYPE")),"^",1)
"RTN","MAGDLBV",37,0)
 . S V=$P(X,"^",1) S:V'="" ^MAGD(2006.575,"B",V,D0)=""
"RTN","MAGDLBV",38,0)
 . S V=$P(X,"^",3) I V'="",'FIXED,TYPE="CON" S ^MAGD(2006.575,"D",V,D0)=""
"RTN","MAGDLBV",39,0)
 . S X=$G(^MAGD(2006.575,D0,1)),LOC=$P(X,"^",5)
"RTN","MAGDLBV",40,0)
 . S V=$P(X,"^",3) I V'="",'FIXED,TYPE="CON" S ^MAGD(2006.575,"AD",V,D0)=""
"RTN","MAGDLBV",41,0)
 . S FIXED=+$G(^MAGD(2006.575,D0,"FIXD"))
"RTN","MAGDLBV",42,0)
 . S V=$P(X,"^",4) I FIXED,LOC'="",V'="" S ^MAGD(2006.575,"AFX",LOC,V,D0)=""
"RTN","MAGDLBV",43,0)
 . S V=$P($G(^MAGD(2006.575,D0,"ASUID")),"^",1)
"RTN","MAGDLBV",44,0)
 . I LOC'="",V'="" S ^MAGD(2006.575,"F",LOC,V,D0)=""
"RTN","MAGDLBV",45,0)
 . S D1=0 F  S D1=$O(^MAGD(2006.575,D0,"RLATE",D1)) Q:'D1  D
"RTN","MAGDLBV",46,0)
 . . S X=+$G(^MAGD(2006.575,D0,"RLATE",D1,0))
"RTN","MAGDLBV",47,0)
 . . I 'X D  Q
"RTN","MAGDLBV",48,0)
 . . . W:MENU !,"Invalid pointer to related entry: """_X_"""."
"RTN","MAGDLBV",49,0)
 . . . K ^MAGD(2006.575,D0,"RLATE",D1)
"RTN","MAGDLBV",50,0)
 . . . Q
"RTN","MAGDLBV",51,0)
 . . I '$D(^MAGD(2006.575,X)) D  Q
"RTN","MAGDLBV",52,0)
 . . . W:MENU !,"Pointer to non-existent related entry: """_X_"""."
"RTN","MAGDLBV",53,0)
 . . . K ^MAGD(2006.575,D0,"RLATE",D1)
"RTN","MAGDLBV",54,0)
 . . . K ^MAGD(2006.575,D0,"RLATE","B",X,D1)
"RTN","MAGDLBV",55,0)
 . . . Q
"RTN","MAGDLBV",56,0)
 . . S L1=D1,N1=N1+1
"RTN","MAGDLBV",57,0)
 . . Q
"RTN","MAGDLBV",58,0)
 . I 'N1 K ^MAGD(2006.575,D0,"RLATE") Q
"RTN","MAGDLBV",59,0)
 . S ^MAGD(2006.575,D0,"RLATE",0)="^2006.57526PA^"_L1_"^"_N1
"RTN","MAGDLBV",60,0)
 . ;
"RTN","MAGDLBV",61,0)
 . S X="" F  S X=$O(^MAGD(2006.575,D0,"RLATE","B",X)) Q:X=""  D
"RTN","MAGDLBV",62,0)
 . . I '$D(^MAGD(2006.575,X)) D  Q
"RTN","MAGDLBV",63,0)
 . . . W:MENU !,"Cross-reference for non-existent related entry: """_X_"""."
"RTN","MAGDLBV",64,0)
 . . . K ^MAGD(2006.575,D0,"RLATE","B",X)
"RTN","MAGDLBV",65,0)
 . . . Q
"RTN","MAGDLBV",66,0)
 . . S D1="" F  S D1=$O(^MAGD(2006.575,D0,"RLATE","B",X,D1)) Q:D1=""  D
"RTN","MAGDLBV",67,0)
 . . . I '$D(^MAGD(2006.575,D0,"RLATE",D1)) D  Q
"RTN","MAGDLBV",68,0)
 . . . . W:MENU !,"Cross-reference for invalid related entry: """_D1_"""."
"RTN","MAGDLBV",69,0)
 . . . . K ^MAGD(2006.575,D0,"RLATE","B",X,D1)
"RTN","MAGDLBV",70,0)
 . . . . Q
"RTN","MAGDLBV",71,0)
 . . Q
"RTN","MAGDLBV",72,0)
 . Q
"RTN","MAGDLBV",73,0)
 S LOC="" F  S LOC=$O(^MAGD(2006.575,"F",LOC)) Q:LOC=""  D
"RTN","MAGDLBV",74,0)
 . S V="" F  S V=$O(^MAGD(2006.575,"F",LOC,V)) Q:V=""  D
"RTN","MAGDLBV",75,0)
 . . N I,N,R
"RTN","MAGDLBV",76,0)
 . . S N=0,D0="" F  S D0=$O(^MAGD(2006.575,"F",LOC,V,D0)) Q:D0=""  D
"RTN","MAGDLBV",77,0)
 . . . S N=N+1,N(''$D(^MAGD(2006.575,D0,"RLATE")),D0)=""
"RTN","MAGDLBV",78,0)
 . . . Q
"RTN","MAGDLBV",79,0)
 . . Q:N<2
"RTN","MAGDLBV",80,0)
 . . I '$O(N(1,"")) S R=$O(N(0,"")) K N(0,R) S N(1,R)=""
"RTN","MAGDLBV",81,0)
 . . S D0=$O(N(1,"")),(L1,N1)=0
"RTN","MAGDLBV",82,0)
 . . S D1=0 F  S D1=$O(^MAGD(2006.575,D0,"RLATE",D1)) Q:'D1  S L1=D1,N1=N1+1
"RTN","MAGDLBV",83,0)
 . . F I=0,1 S N="" F  S N=$O(N(I,N)) Q:N=""  D:D0'=N
"RTN","MAGDLBV",84,0)
 . . . K ^MAGD(2006.575,"F",LOC,V,N)
"RTN","MAGDLBV",85,0)
 . . . Q:$D(^MAGD(2006.575,D0,"RLATE","B",N))
"RTN","MAGDLBV",86,0)
 . . . S L1=L1+1,N1=N1+1
"RTN","MAGDLBV",87,0)
 . . . S ^MAGD(2006.575,D0,"RLATE",L1,0)=N
"RTN","MAGDLBV",88,0)
 . . . S ^MAGD(2006.575,D0,"RLATE","B",N,L1)=""
"RTN","MAGDLBV",89,0)
 . . . Q
"RTN","MAGDLBV",90,0)
 . . S ^MAGD(2006.575,D0,"RLATE",0)="^2006.57526PA^"_L1_"^"_N1
"RTN","MAGDLBV",91,0)
 . . Q
"RTN","MAGDLBV",92,0)
 . Q
"RTN","MAGDLBV",93,0)
 S ^MAGD(2006.575,0)="DICOM FAILED IMAGES^2006.575^"_L0_"^"_N0
"RTN","MAGDLBV",94,0)
 L -^MAGD(2006.575)
"RTN","MAGDLBV",95,0)
 S OUT=N0
"RTN","MAGDLBV",96,0)
 Q
"RTN","MAGDLBV",97,0)
 ;
"RTN","MAGDMEDK")
0^28^B5415662
"RTN","MAGDMEDK",1,0)
MAGDMEDK ;WOIFO/LB Routine to find Medicine subspecialty [ 06/20/2001 08:56 ] ; 06/06/2005  09:25
"RTN","MAGDMEDK",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGDMEDK",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDMEDK",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDMEDK",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDMEDK",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDMEDK",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDMEDK",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDMEDK",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDMEDK",10,0)
 ;; |                                                               |
"RTN","MAGDMEDK",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDMEDK",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDMEDK",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDMEDK",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDMEDK",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDMEDK",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDMEDK",17,0)
 ;;
"RTN","MAGDMEDK",18,0)
 Q
"RTN","MAGDMEDK",19,0)
SUB(MAGSUB,MAGPAT) ;Get Medicine subspecialty and entries.
"RTN","MAGDMEDK",20,0)
 ; an array should be produced and only for entries found from call to
"RTN","MAGDMEDK",21,0)
 ; api SUB^MCARUTL2:
"RTN","MAGDMEDK",22,0)
 ;  MAGMC(#)=data formatted from call to SUB^MCARUTL2
"RTN","MAGDMEDK",23,0)
 Q:'$D(MAGPAT)!'$D(MAGSUB)
"RTN","MAGDMEDK",24,0)
 N I,II,X,Y,MAGMC,MAGXX,SUB
"RTN","MAGDMEDK",25,0)
 S MAGMC(0)="0^0"
"RTN","MAGDMEDK",26,0)
 D SUB^MCARUTL2(.MAGXX,MAGPAT,MAGSUB)
"RTN","MAGDMEDK",27,0)
 Q:'MAGXX
"RTN","MAGDMEDK",28,0)
 S I=0 F  S I=$O(MAGXX(I)) Q:'I  D
"RTN","MAGDMEDK",29,0)
 . S (X,Y)="",X=$P(MAGXX(I),"^"),%DT="ST" D ^%DT
"RTN","MAGDMEDK",30,0)
 . S MAGMC(MAGPAT,SUB,Y,I)=$G(MAGXX(I))
"RTN","MAGDMEDK",31,0)
 . I $D(MAGXX(I,2005)) S II=0 D
"RTN","MAGDMEDK",32,0)
 . . F  S II=$O(MAGXX(I,2005,II)) Q:'II  D
"RTN","MAGDMEDK",33,0)
 . . . S MAGMC(MAGPAT,SUB,Y,I,2005,II)=MAGXX(I,2005,II)
"RTN","MAGDMEDK",34,0)
 S MAGMC(0)="1^"_$G(MAGXX(0))
"RTN","MAGDMEDK",35,0)
 Q
"RTN","MAGDMEDK",36,0)
PATSUB(MAGSUB1,MAGDFN) ;
"RTN","MAGDMEDK",37,0)
 Q:'MAGDFN
"RTN","MAGDMEDK",38,0)
 N I,MAGX
"RTN","MAGDMEDK",39,0)
 D PATSUB^MCARUTL2(.MAGX,MAGDFN)
"RTN","MAGDMEDK",40,0)
 Q:'MAGX
"RTN","MAGDMEDK",41,0)
 Q:'$D(MAGX(0))
"RTN","MAGDMEDK",42,0)
 S MAGSUB1(0)="1^"_+MAGX_"^"_$P(MAGX(0),"^",2)
"RTN","MAGDMEDK",43,0)
 ; MAGSUB1(0)=1^#entries^msg text
"RTN","MAGDMEDK",44,0)
 S I=0 F  S I=$O(MAGX(I)) Q:'I  D
"RTN","MAGDMEDK",45,0)
 . S MAGSUB1(I)=$P(MAGX(I),"^")_" ("_$P(MAGX(I),"^",2)_")"
"RTN","MAGDMEDK",46,0)
 . ; MAGSUB1(#)=OPH (25)  --25 being ien for procedure
"RTN","MAGDMEDK",47,0)
 Q
"RTN","MAGDMEDL")
0^29^B19875835
"RTN","MAGDMEDL",1,0)
MAGDMEDL ;WOIFO/LB - Routine to look up entries in the Medicine files ; 05/16/2005  09:18
"RTN","MAGDMEDL",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGDMEDL",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDMEDL",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDMEDL",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDMEDL",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDMEDL",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDMEDL",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDMEDL",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDMEDL",10,0)
 ;; |                                                               |
"RTN","MAGDMEDL",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDMEDL",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDMEDL",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDMEDL",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDMEDL",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDMEDL",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDMEDL",17,0)
 ;;
"RTN","MAGDMEDL",18,0)
 Q
"RTN","MAGDMEDL",19,0)
SELECT(ITEM,ARRAY) ;
"RTN","MAGDMEDL",20,0)
 ;
"RTN","MAGDMEDL",21,0)
 N CNT,DIR,DIROUT,DIRUT,ENTRY
"RTN","MAGDMEDL",22,0)
 S CNT=+ARRAY
"RTN","MAGDMEDL",23,0)
 I 'CNT Q 0
"RTN","MAGDMEDL",24,0)
 S DIR(0)="NO^1:"_CNT,DIR("A")="Select a Medicine Procedure"
"RTN","MAGDMEDL",25,0)
 S DIR("T")=600 D ^DIR
"RTN","MAGDMEDL",26,0)
 I $D(DIRUT)!($D(DIROUT)) Q 0
"RTN","MAGDMEDL",27,0)
 S ENTRY=+Y
"RTN","MAGDMEDL",28,0)
 I '$D(ARRAY(ENTRY)) D  G SELECT
"RTN","MAGDMEDL",29,0)
 . W !,"Please select an entry or use '^' to exit"
"RTN","MAGDMEDL",30,0)
 W !,"You have selected ",$P(ARRAY(ENTRY),"^"),"."
"RTN","MAGDMEDL",31,0)
 Q $P(ARRAY(ENTRY),"^",2)
"RTN","MAGDMEDL",32,0)
 ;
"RTN","MAGDMEDL",33,0)
LOOP(ARRAY,MAGPAT,SUB,CASEDT) ;
"RTN","MAGDMEDL",34,0)
 ; MAGPAT = patient's dfn
"RTN","MAGDMEDL",35,0)
 ; SUB = Medicine specialty
"RTN","MAGDMEDL",36,0)
 ; CASEDT = case date
"RTN","MAGDMEDL",37,0)
 ;  array(0)= 1 or 0 ^ # entries found ^ message text
"RTN","MAGDMEDL",38,0)
 ;  array(#)= formatted out display without delimiters
"RTN","MAGDMEDL",39,0)
 ;  array(#,1) = internal stored values
"RTN","MAGDMEDL",40,0)
 ; Variable MAGDIMG
"RTN","MAGDMEDL",41,0)
 S ARRAY(0)="0^^No entries found"
"RTN","MAGDMEDL",42,0)
 Q:'MAGPAT
"RTN","MAGDMEDL",43,0)
 Q:'$D(MAGMC)#10   ;Array should be available.
"RTN","MAGDMEDL",44,0)
 N BEG,CDT,CNT,DATA,DICOM,EN,END,IMG,IMAGEPTR,MAGDIMG,PATIENT,PATNME,PRC,PRCNM,SSN,THEDT,X1,X2,X
"RTN","MAGDMEDL",45,0)
 N IEN,II,IOUT,MAGMC,MEDFILE
"RTN","MAGDMEDL",46,0)
 Q:'$$FIND1^DIC(2,,"A",MAGPAT,"","")
"RTN","MAGDMEDL",47,0)
 S PATNME=$P(^DPT(MAGPAT,0),"^"),SSN=$P(^(0),"^",9)
"RTN","MAGDMEDL",48,0)
 S PATIENT=PATNME_" "_SSN
"RTN","MAGDMEDL",49,0)
 I 'CASEDT S CASEDT=DT
"RTN","MAGDMEDL",50,0)
 S X1=CASEDT,X2=-3 D C^%DTC S BEG=X
"RTN","MAGDMEDL",51,0)
 S END=CASEDT+.9999
"RTN","MAGDMEDL",52,0)
 S CNT=0,CDT=BEG-.001
"RTN","MAGDMEDL",53,0)
 F  S CDT=$O(MAGMC(MAGPAT,SUB,CDT)) Q:'CDT!(CDT>END)  D
"RTN","MAGDMEDL",54,0)
 . S EN=0 F  S EN=$O(MAGMC(MAGPAT,SUB,CDT,EN)) Q:'EN  D
"RTN","MAGDMEDL",55,0)
 . . S DATA=MAGMC(MAGPAT,SUB,CDT,EN)
"RTN","MAGDMEDL",56,0)
 . . S PRCNM=$P(DATA,"^",2),PRC=SUB
"RTN","MAGDMEDL",57,0)
 . . S THEDT=$P(DATA,"^"),IEN=$P(DATA,"^",5)
"RTN","MAGDMEDL",58,0)
 . . I $D(MAGMC(MAGPAT,SUB,CDT,EN,2005)) S (IOUT,II)=0 D
"RTN","MAGDMEDL",59,0)
 . . . F  S II=$O(MAGMC(MAGPAT,SUB,CDT,EN,2005,II)) Q:'II!IOUT  D
"RTN","MAGDMEDL",60,0)
 . . . . S IMAGEPTR=MAGMC(MAGPAT,SUB,CDT,EN,2005,II)
"RTN","MAGDMEDL",61,0)
 . . . . I '$D(^MAG(2005,IMAGEPTR)) S IMAGEPTR="" Q
"RTN","MAGDMEDL",62,0)
 . . . . I '$D(^MAG(2005,IMAGEPTR,"PACS"))  S IMAGEPTR="",IOUT=1
"RTN","MAGDMEDL",63,0)
 . . S MEDFILE=$P(DATA,"^",4),MEDFILE=$P(MEDFILE,"MCAR(",2)
"RTN","MAGDMEDL",64,0)
 . . S DICOM="" D DICOMID^MAGDMEDI(.DICOM,MEDFILE,IEN,PRC,MAGPAT)
"RTN","MAGDMEDL",65,0)
 . . I DICOM'="" D
"RTN","MAGDMEDL",66,0)
 . . . S DICOM=$P(DICOM,":",2)
"RTN","MAGDMEDL",67,0)
 . . . S CNT=CNT+1
"RTN","MAGDMEDL",68,0)
 . . . S ARRAY(CNT)=DICOM_" "_PRCNM_", "_THEDT_" "_PATIENT
"RTN","MAGDMEDL",69,0)
 . . . S ARRAY(CNT,1)=DICOM_"^"_PATNME_"^"_SSN_"^"_EN_"^"_PRCNM_"^"_PRC_"^"_$G(IMAGEPTR)_"^"_MEDFILE
"RTN","MAGDMEDL",70,0)
 I CNT S ARRAY(0)="1^"_CNT_"^Medicine file entries for "_PATIENT
"RTN","MAGDMEDL",71,0)
 Q
"RTN","MAGDMEDL",72,0)
DISPLAY(ARRAY) ;
"RTN","MAGDMEDL",73,0)
 ; Call routine needs to pass array in the following sequence
"RTN","MAGDMEDL",74,0)
 ; ARRAY(0)= 1 or 0 ^ #entries ^ message
"RTN","MAGDMEDL",75,0)
 ; ARRAY(#)=  Formatted output to be displayed.
"RTN","MAGDMEDL",76,0)
 ; Will set the RES variable for selected entry.
"RTN","MAGDMEDL",77,0)
 I '$D(ARRAY(0)) Q 0
"RTN","MAGDMEDL",78,0)
 ; If only one entry return the subscript variable.
"RTN","MAGDMEDL",79,0)
 I $P(ARRAY(0),"^",2)=1 Q 1
"RTN","MAGDMEDL",80,0)
 I $P(ARRAY(0),"^")'=1 Q 0
"RTN","MAGDMEDL",81,0)
 N ENTRY,ITEM,ITEMS,MSG,OUT,OUTPUT,RES
"RTN","MAGDMEDL",82,0)
 S RES=0,MSG=$P(ARRAY(0),"^",3)
"RTN","MAGDMEDL",83,0)
 S IOF="#,$C(27,91,72,27,91,74,8,8,8,8)",IO=0,IOSL=24,POP=0
"RTN","MAGDMEDL",84,0)
 D HEAD
"RTN","MAGDMEDL",85,0)
 S (ENTRY,OUT)=0,ITEMS=$P(ARRAY(0),"^",2)
"RTN","MAGDMEDL",86,0)
 F  S ENTRY=$O(ARRAY(ENTRY)) Q:'ENTRY!OUT  D
"RTN","MAGDMEDL",87,0)
 . S OUTPUT=$G(ARRAY(ENTRY))
"RTN","MAGDMEDL",88,0)
 . D:$Y+3>IOSL HEAD D LINE
"RTN","MAGDMEDL",89,0)
 . D:$Y+3>IOSL ASKQ
"RTN","MAGDMEDL",90,0)
 I 'OUT D ASKQ S RES=ITEM
"RTN","MAGDMEDL",91,0)
 Q RES
"RTN","MAGDMEDL",92,0)
HEAD ;
"RTN","MAGDMEDL",93,0)
 W:$Y+3>IOSL @IOF W !,MSG
"RTN","MAGDMEDL",94,0)
 Q
"RTN","MAGDMEDL",95,0)
LINE ;
"RTN","MAGDMEDL",96,0)
 W !,ENTRY,".) "_OUTPUT
"RTN","MAGDMEDL",97,0)
 Q
"RTN","MAGDMEDL",98,0)
ASKQ ;
"RTN","MAGDMEDL",99,0)
 N X,Y,DIR
"RTN","MAGDMEDL",100,0)
 S DIR(0)="L^1:"_$S('ENTRY:ITEMS,1:ENTRY)
"RTN","MAGDMEDL",101,0)
 S DIR("T")=600,DIR("A")="Select an entry: " D ^DIR
"RTN","MAGDMEDL",102,0)
 S ITEM=+Y
"RTN","MAGDMEDL",103,0)
 Q:$D(DIRUT)!($D(DIROUT))
"RTN","MAGDMEDL",104,0)
 Q:'ITEM
"RTN","MAGDMEDL",105,0)
 I '$D(ARRAY(ITEM)) W !,"Please select an entry or '^' to exit" G ASKQ
"RTN","MAGDMEDL",106,0)
 W !,"You have selected ",$P($G(ARRAY(ITEM)),"^")
"RTN","MAGDMEDL",107,0)
 S OUT=1
"RTN","MAGDMEDL",108,0)
 Q
"RTN","MAGDMEDL",109,0)
ASKMORE() ;
"RTN","MAGDMEDL",110,0)
 N DIR,DATE,X,XX,Y
"RTN","MAGDMEDL",111,0)
 Q:'$D(MAGPAT)
"RTN","MAGDMEDL",112,0)
 Q:'$D(SUB)
"RTN","MAGDMEDL",113,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","MAGDMEDL",114,0)
 S DIR("A")="Search further"
"RTN","MAGDMEDL",115,0)
 D ^DIR K DIR
"RTN","MAGDMEDL",116,0)
 I 'Y Q 0
"RTN","MAGDMEDL",117,0)
 W !,"Search will include 3 days prior to the day specified."
"RTN","MAGDMEDL",118,0)
 S DIR(0)="D^::EXP" D ^DIR
"RTN","MAGDMEDL",119,0)
 ; Y2K compliance all calls to %DT must have either past or future date
"RTN","MAGDMEDL",120,0)
 I 'Y Q 0
"RTN","MAGDMEDL",121,0)
 S DATE=Y
"RTN","MAGDMEDL",122,0)
 D LOOP(.XX,MAGPAT,SUB,DATE)
"RTN","MAGDMEDL",123,0)
 I $D(XX(0)),$P(XX(0),"^")=0 D  Q 0
"RTN","MAGDMEDL",124,0)
 . W "No entries found."
"RTN","MAGDMEDL",125,0)
 Q 1
"RTN","MAGDQR00")
0^30^B3096939
"RTN","MAGDQR00",1,0)
MAGDQR00 ;WOIFO/EdM - Imaging RPCs for Query/Retrieve ; 06/06/2005  09:27
"RTN","MAGDQR00",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGDQR00",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR00",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR00",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR00",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR00",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR00",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR00",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR00",10,0)
 ;; |                                                               |
"RTN","MAGDQR00",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR00",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR00",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR00",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR00",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR00",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR00",17,0)
 ;;
"RTN","MAGDQR00",18,0)
 Q
"RTN","MAGDQR00",19,0)
 ;
"RTN","MAGDQR00",20,0)
 ; Query/Retrieve
"RTN","MAGDQR00",21,0)
 ;
"RTN","MAGDQR00",22,0)
 ; Step 1: The application (Java system) receives a C-FIND request
"RTN","MAGDQR00",23,0)
 ;
"RTN","MAGDQR00",24,0)
 ; Step 2: The application interprets the DICOM message and
"RTN","MAGDQR00",25,0)
 ;         calls an RPC on traditional VistA
"RTN","MAGDQR00",26,0)
 ;
"RTN","MAGDQR00",27,0)
 ;           RPC name: MAG CFIND QUERY
"RTN","MAGDQR00",28,0)
 ;             input:  array of:    tag | VR | flag | value
"RTN","MAGDQR00",29,0)
 ;             input:  scalar:      batch-identifier, see below
"RTN","MAGDQR00",30,0)
 ;             input:  scalar:      max # entities in response
"RTN","MAGDQR00",31,0)
 ;             output: array of:    header = # entities total | # in current batch
"RTN","MAGDQR00",32,0)
 ;                    followed by   tag | VR | flag | value
"RTN","MAGDQR00",33,0)
 ;                             or   <start sequence>
"RTN","MAGDQR00",34,0)
 ;                             or   <end sequence>
"RTN","MAGDQR00",35,0)
 ;
"RTN","MAGDQR00",36,0)
 ;          Batch-identifier:
"RTN","MAGDQR00",37,0)
 ;          There are four kinds of calls:
"RTN","MAGDQR00",38,0)
 ;           1. initial call
"RTN","MAGDQR00",39,0)
 ;              value of this parameter is "0"
"RTN","MAGDQR00",40,0)
 ;              RPC will create result-set and start a background process to
"RTN","MAGDQR00",41,0)
 ;              perform the query
"RTN","MAGDQR00",42,0)
 ;           2. "are you ready" call
"RTN","MAGDQR00",43,0)
 ;              value of this parameter is "n|0"
"RTN","MAGDQR00",44,0)
 ;              where 'n' identifies the result-set
"RTN","MAGDQR00",45,0)
 ;              RPC will check if the query is ready and, when available, will
"RTN","MAGDQR00",46,0)
 ;              return "initial batch" of responses
"RTN","MAGDQR00",47,0)
 ;           3. continuation call
"RTN","MAGDQR00",48,0)
 ;              value of this parameter is "n|m"
"RTN","MAGDQR00",49,0)
 ;              where 'n' identifies the result-set
"RTN","MAGDQR00",50,0)
 ;              where 'm' identifies the sequence
"RTN","MAGDQR00",51,0)
 ;              number of the first item to be returned RPC will return
"RTN","MAGDQR00",52,0)
 ;              next batch of responses
"RTN","MAGDQR00",53,0)
 ;           4. final call
"RTN","MAGDQR00",54,0)
 ;              value of this parameter is "n|-1"
"RTN","MAGDQR00",55,0)
 ;              where 'n' identifies the result-set
"RTN","MAGDQR00",56,0)
 ;              RPC will not return any responses but clean-up any storage used
"RTN","MAGDQR00",57,0)
 ;              for result-set
"RTN","MAGDQR00",58,0)
 ;
"RTN","MAGDQR00",59,0)
 ;          Suggested values for second parameter:
"RTN","MAGDQR00",60,0)
 ;            0 for initial call
"RTN","MAGDQR00",61,0)
 ;           -1 for final call
"RTN","MAGDQR00",62,0)
 ;           >0 (sequence number of first entity to be returned)
"RTN","MAGDQR00",63,0)
 ;              for continuation call
"RTN","MAGDQR00",64,0)
 ;          Result-set will also have a "time stamp of last access"
"RTN","MAGDQR00",65,0)
 ;          so that an overall clean-up process can get rid of
"RTN","MAGDQR00",66,0)
 ;          obsolete result-sets.
"RTN","MAGDQR00",67,0)
 ;
"RTN","MAGDQR00",68,0)
 ; Step 3: The application interprets the results from the RPC
"RTN","MAGDQR00",69,0)
 ;         and will ask VistA which images belong to a
"RTN","MAGDQR00",70,0)
 ;         study-UID:
"RTN","MAGDQR00",71,0)
 ;
"RTN","MAGDQR00",72,0)
 ;           RPC name: MAG STUDY UID QUERY
"RTN","MAGDQR00",73,0)
 ;             input:  scalar       study uid
"RTN","MAGDQR00",74,0)
 ;             input:  scalar       flag: include routed copies in result
"RTN","MAGDQR00",75,0)
 ;             input:  scalar       "my location" identifier
"RTN","MAGDQR00",76,0)
 ;             output: array of:    header = # of entities in response
"RTN","MAGDQR00",77,0)
 ;                                  image# | path+file name | username | password
"RTN","MAGDQR00",78,0)
 ;
"RTN","MAGDQR00",79,0)
 ;         Do we want to return the username and password in each
"RTN","MAGDQR00",80,0)
 ;         result, or do we want two separate RPC calls: one to
"RTN","MAGDQR00",81,0)
 ;         get path+filename for each file, and one that returns
"RTN","MAGDQR00",82,0)
 ;         the username and password given a path?
"RTN","MAGDQR00",83,0)
 ;
"RTN","MAGDQR00",84,0)
 ; Step 4: The application will create new DICOM entities to transmit
"RTN","MAGDQR00",85,0)
 ;         to its client. It has the information to access the
"RTN","MAGDQR00",86,0)
 ;         image files that exist on VistA (either .dcm files or
"RTN","MAGDQR00",87,0)
 ;         .txt + .tga pairs). It needs to ask VistA for the
"RTN","MAGDQR00",88,0)
 ;         current and correct information to place in the headers
"RTN","MAGDQR00",89,0)
 ;         of the DICOM entities to be transmitted:
"RTN","MAGDQR00",90,0)
 ;
"RTN","MAGDQR00",91,0)
 ;           RPC name: MAG IMAGE CURRENT INFO
"RTN","MAGDQR00",92,0)
 ;             input:  scalar       image #
"RTN","MAGDQR00",93,0)
 ;             output: array of:    header = # of entities in response
"RTN","MAGDQR00",94,0)
 ;                                  tag | VS | flag | value
"RTN","MAGDQR00",95,0)
 ;
"RTN","MAGDQR00",96,0)
 ;         Do we need an additional input array to specify the
"RTN","MAGDQR00",97,0)
 ;         list of data-fields to be returned?
"RTN","MAGDQR00",98,0)
 ;
"RTN","MAGDQR00",99,0)
 ; Non-supported tags for Query/Retrieve
"RTN","MAGDQR00",100,0)
 ; 0008,1110  O  Referenced Study Sequence
"RTN","MAGDQR00",101,0)
 ; 0008,1150  O  >Referenced SOP Class UID
"RTN","MAGDQR00",102,0)
 ; 0008,1155  O  >Referenced SOP Instance UID
"RTN","MAGDQR00",103,0)
 ; 0008,1120  O  Referenced Patient Sequence
"RTN","MAGDQR00",104,0)
 ; 0008,1150  O  >Referenced SOP Class UID
"RTN","MAGDQR00",105,0)
 ; 0008,1155  O  >Referenced SOP Instance UID
"RTN","MAGDQR00",106,0)
 ; 0010,1020  O  Patient's Size   [field not populated]
"RTN","MAGDQR00",107,0)
 ; 0010,1030  O  Patient's Weight [field not populated]
"RTN","MAGDQR00",108,0)
 ; 0020,1070  O  Other Study Numbers
"RTN","MAGDQR00",109,0)
 ; 0020,1200  O  Number of Patient Related Studies
"RTN","MAGDQR00",110,0)
 ; 0020,1202  O  Number of Patient Related Series
"RTN","MAGDQR00",111,0)
 ; 0020,1204  O  Number of Patient Related Instances
"RTN","MAGDQR00",112,0)
 ;
"RTN","MAGDQR00",113,0)
 ; Supported tags
"RTN","MAGDQR00",114,0)
 ; 0008,0020  R  Study Date
"RTN","MAGDQR00",115,0)
 ; 0008,0030  R  Study Time
"RTN","MAGDQR00",116,0)
 ; 0008,0050  R  Accession Number
"RTN","MAGDQR00",117,0)
 ; 0010,0010  R  Patient's Name
"RTN","MAGDQR00",118,0)
 ; 0010,0020  R  Patient ID
"RTN","MAGDQR00",119,0)
 ; 0020,0010  R  Study ID
"RTN","MAGDQR00",120,0)
 ; 0020,000D  U  Study Instance UID
"RTN","MAGDQR00",121,0)
 ;
"RTN","MAGDQR00",122,0)
 ; 0008,0061  O  Modalities in Study
"RTN","MAGDQR00",123,0)
 ; 0008,0090  O  Referring Physician's Name
"RTN","MAGDQR00",124,0)
 ; 0008,1030  O  Study Description
"RTN","MAGDQR00",125,0)
 ; 0008,1032  O  Procedure Code Sequence
"RTN","MAGDQR00",126,0)
 ; 0008,0100  O  >Code Value
"RTN","MAGDQR00",127,0)
 ; 0008,0102  O  >Coding Scheme Designator
"RTN","MAGDQR00",128,0)
 ; 0008,0103  O  >Coding Scheme Version
"RTN","MAGDQR00",129,0)
 ; 0008,0104  O  >Code Meaning
"RTN","MAGDQR00",130,0)
 ; 0008,1060  O  Name of Physician(s) Reading Study
"RTN","MAGDQR00",131,0)
 ; 0010,0030  O  Patient's Birth Date
"RTN","MAGDQR00",132,0)
 ; 0010,0032  O  Patient's Birth Time [probably always blank]
"RTN","MAGDQR00",133,0)
 ; 0010,0040  O  Patient's Sex
"RTN","MAGDQR00",134,0)
 ; 0010,1000  O  Other Patient IDs
"RTN","MAGDQR00",135,0)
 ; 0010,1001  O  Other Patient Names
"RTN","MAGDQR00",136,0)
 ; 0010,1010  O  Patient's Age
"RTN","MAGDQR00",137,0)
 ; 0010,2160  O  Ethnic Group
"RTN","MAGDQR00",138,0)
 ; 0010,2180  O  Occupation
"RTN","MAGDQR00",139,0)
 ; 0010,21B0  O  Additional Patient History
"RTN","MAGDQR00",140,0)
 ; 0020,1206  O  Number of Study Related Series
"RTN","MAGDQR00",141,0)
 ; 0020,1208  O  Number of Study Related Instances
"RTN","MAGDQR00",142,0)
 ; 4008,010C  O  Interpretation Author
"RTN","MAGDQR00",143,0)
 ;
"RTN","MAGDQR00",144,0)
 ; Problem cases left over:
"RTN","MAGDQR00",145,0)
 ; 0008,0062  O  SOP Classes in Study [supported?]
"RTN","MAGDQR00",146,0)
 ; 0008,1080  O  Admitting Diagnoses Description
"RTN","MAGDQR00",147,0)
 ; 0010,4000  O  Patient Comments
"RTN","MAGDQR00",148,0)
 ;
"RTN","MAGDQR01")
0^31^B25742875
"RTN","MAGDQR01",1,0)
MAGDQR01 ;WOIFO/EdM - Imaging RPCs for Query/Retrieve ; 05/16/2005  08:45
"RTN","MAGDQR01",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGDQR01",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR01",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR01",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR01",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR01",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR01",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR01",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR01",10,0)
 ;; |                                                               |
"RTN","MAGDQR01",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR01",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR01",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR01",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR01",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR01",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR01",17,0)
 ;;
"RTN","MAGDQR01",18,0)
 Q
"RTN","MAGDQR01",19,0)
 ;
"RTN","MAGDQR01",20,0)
FIND(OUT,TAGS,RESULT,OFFSET,MAX) ; RPC = MAG CFIND QUERY
"RTN","MAGDQR01",21,0)
 N ERROR,I,N,P,REQ,T,V,X,ZTDESC,ZTDTH,ZTRTN,ZTSAVE,ZTSK
"RTN","MAGDQR01",22,0)
 ;
"RTN","MAGDQR01",23,0)
 S RESULT=$G(RESULT),OFFSET=$G(OFFSET)
"RTN","MAGDQR01",24,0)
 S ERROR=0
"RTN","MAGDQR01",25,0)
 ;
"RTN","MAGDQR01",26,0)
 I 'RESULT D  Q
"RTN","MAGDQR01",27,0)
 . S REQ("0008,0020")=-1 ; Study Date
"RTN","MAGDQR01",28,0)
 . S REQ("0008,0030")=-1 ; Study Time
"RTN","MAGDQR01",29,0)
 . S REQ("0008,0050")=-1 ; Accession Number
"RTN","MAGDQR01",30,0)
 . S REQ("0010,0010")=-1 ; Patient's Name
"RTN","MAGDQR01",31,0)
 . S REQ("0010,0020")=-1 ; Patient ID
"RTN","MAGDQR01",32,0)
 . S REQ("0020,0010")=-1 ; Study ID
"RTN","MAGDQR01",33,0)
 . ; TAGS(i) = tag | VR | flag | value
"RTN","MAGDQR01",34,0)
 . S I="" F  S I=$O(TAGS(I)) Q:I=""  D
"RTN","MAGDQR01",35,0)
 . . S X=TAGS(I),T=$P(X,"|",1) Q:T=""
"RTN","MAGDQR01",36,0)
 . . S V=$P(X,"|",4,$L(X)+2) S:V="*" V=""
"RTN","MAGDQR01",37,0)
 . . S:$TR(V,"UNKOW","unkow")="<unknown>" V=""
"RTN","MAGDQR01",38,0)
 . . S L=$L(V,"\") S:V="" L=0
"RTN","MAGDQR01",39,0)
 . . S REQ(T)=L F P=1:1:L S REQ(T,P)=$P(V,"\",P)
"RTN","MAGDQR01",40,0)
 . . Q
"RTN","MAGDQR01",41,0)
 . S T="" F  S T=$O(REQ(T)) Q:T=""  D:REQ(T)<0 ERR("Missing required tag """_T_""".")
"RTN","MAGDQR01",42,0)
 . I ERROR D ERRLOG Q
"RTN","MAGDQR01",43,0)
 . ;
"RTN","MAGDQR01",44,0)
 . ; Convert DICOM name to VA name
"RTN","MAGDQR01",45,0)
 . ;
"RTN","MAGDQR01",46,0)
 . S T="0010,0010"
"RTN","MAGDQR01",47,0)
 . S P="" F  S P=$O(REQ(T,P)) Q:P=""  S REQ(T,P)=$$DCM2VA(REQ(T,P))
"RTN","MAGDQR01",48,0)
 . ;
"RTN","MAGDQR01",49,0)
 . ; Initialize Result Set
"RTN","MAGDQR01",50,0)
 . ;
"RTN","MAGDQR01",51,0)
 . L +^MAGDQR(2006.5732,0):1E9 ; Background process MUST wait
"RTN","MAGDQR01",52,0)
 . S X=$G(^MAGDQR(2006.5732,0))
"RTN","MAGDQR01",53,0)
 . S $P(X,"^",1,2)="DICOM QUERY RETRIEVE RESULT^2006.2006.5732"
"RTN","MAGDQR01",54,0)
 . S RESULT=$O(^MAGDQR(2006.5732," "),-1)+1
"RTN","MAGDQR01",55,0)
 . S $P(X,"^",3)=RESULT
"RTN","MAGDQR01",56,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDQR01",57,0)
 . S ^MAGDQR(2006.5732,0)=X
"RTN","MAGDQR01",58,0)
 . S ^MAGDQR(2006.5732,RESULT,0)=RESULT_"^IP^"_$$NOW^XLFDT()
"RTN","MAGDQR01",59,0)
 . S ^MAGDQR(2006.5732,"B",RESULT,RESULT)=""
"RTN","MAGDQR01",60,0)
 . L -^MAGDQR(2006.5732,0)
"RTN","MAGDQR01",61,0)
 . ;
"RTN","MAGDQR01",62,0)
 . ; Queue up actual query
"RTN","MAGDQR01",63,0)
 . ;
"RTN","MAGDQR01",64,0)
 . S ZTRTN="QUERY^MAGDQR02"
"RTN","MAGDQR01",65,0)
 . S ZTDESC="Perform DICOM Query, result-set="_RESULT
"RTN","MAGDQR01",66,0)
 . S ZTDTH=$H
"RTN","MAGDQR01",67,0)
 . S ZTSAVE("RESULT")=RESULT
"RTN","MAGDQR01",68,0)
 . S T="" F  S T=$O(REQ(T)) Q:T=""  D
"RTN","MAGDQR01",69,0)
 . . S ZTSAVE("REQ("""_T_""")")=REQ(T)
"RTN","MAGDQR01",70,0)
 . . S P="" F  S P=$O(REQ(T,P)) Q:P=""  S ZTSAVE("REQ("""_T_""","_P_")")=REQ(T,P)
"RTN","MAGDQR01",71,0)
 . . Q
"RTN","MAGDQR01",72,0)
 . D ^%ZTLOAD,HOME^%ZIS
"RTN","MAGDQR01",73,0)
 . D:'$G(ZTSK) ERR("TaskMan did not Accept Request")
"RTN","MAGDQR01",74,0)
 . S:$G(ZTSK) $P(^MAGDQR(2006.5732,RESULT,0),"^",4)=ZTSK
"RTN","MAGDQR01",75,0)
 . I ERROR D ERRLOG Q
"RTN","MAGDQR01",76,0)
 . S OUT(1)="0,"_RESULT_",Query Started through TaskMan"
"RTN","MAGDQR01",77,0)
 . Q
"RTN","MAGDQR01",78,0)
 ;
"RTN","MAGDQR01",79,0)
 I OFFSET<0 D  Q  ; All done, clean up result-set
"RTN","MAGDQR01",80,0)
 . S OUT(1)="1,Result Set Cleaned Up"
"RTN","MAGDQR01",81,0)
 . Q:'$D(^MAGDQR(2006.5732,RESULT))
"RTN","MAGDQR01",82,0)
 . L +^MAGDQR(2006.5732,0):1E9 ; Background process MUST wait
"RTN","MAGDQR01",83,0)
 . S X=$G(^MAGDQR(2006.5732,0))
"RTN","MAGDQR01",84,0)
 . S $P(X,"^",1,2)="DICOM QUERY RETRIEVE RESULT^2006.2006.5732"
"RTN","MAGDQR01",85,0)
 . S:$P(X,"^",4)>0 $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDQR01",86,0)
 . S ^MAGDQR(2006.5732,0)=X
"RTN","MAGDQR01",87,0)
 . K ^MAGDQR(2006.5732,RESULT)
"RTN","MAGDQR01",88,0)
 . K ^MAGDQR(2006.5732,"B",RESULT)
"RTN","MAGDQR01",89,0)
 . L -^MAGDQR(2006.5732,0)
"RTN","MAGDQR01",90,0)
 . Q
"RTN","MAGDQR01",91,0)
 ;
"RTN","MAGDQR01",92,0)
 I 'OFFSET D  Q:V'="OK"  ; Is the query done?
"RTN","MAGDQR01",93,0)
 . S X=$G(^MAGDQR(2006.5732,RESULT,0))
"RTN","MAGDQR01",94,0)
 . S V=$P(X,"^",2) Q:V="OK"
"RTN","MAGDQR01",95,0)
 . I V="X" S OUT(1)="-2,No result returned" S V="OK" Q
"RTN","MAGDQR01",96,0)
 . S ZTSK=$P(X,"^",4) D STAT^%ZTLOAD
"RTN","MAGDQR01",97,0)
 . I $G(ZTSK(2))'["Inactive" S OUT(1)="-1,TaskMan still active" Q
"RTN","MAGDQR01",98,0)
 . I ZTSK(2)["Finished" S V="OK" Q
"RTN","MAGDQR01",99,0)
 . S OUT(1)="-13,TaskMan aborted: "_ZTSK(2)
"RTN","MAGDQR01",100,0)
 . Q
"RTN","MAGDQR01",101,0)
 ;
"RTN","MAGDQR01",102,0)
 S:'$G(MAX) MAX=100
"RTN","MAGDQR01",103,0)
 S I=OFFSET,N=1 F  S I=$O(^MAGDQR(2006.5732,RESULT,1,I)) Q:'I  D  Q:N>MAX
"RTN","MAGDQR01",104,0)
 . S OFFSET=I
"RTN","MAGDQR01",105,0)
 . S N=N+1,OUT(N)=$G(^MAGDQR(2006.5732,RESULT,1,I,0))
"RTN","MAGDQR01",106,0)
 . Q
"RTN","MAGDQR01",107,0)
 I N=1 S OUT(1)="0,No more results." Q
"RTN","MAGDQR01",108,0)
 S OUT(1)=(N-1)_","_OFFSET_",result(s)."
"RTN","MAGDQR01",109,0)
 Q
"RTN","MAGDQR01",110,0)
 ;
"RTN","MAGDQR01",111,0)
DCM2VA(NAME) N I,P
"RTN","MAGDQR01",112,0)
 S NAME=$TR(NAME,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGDQR01",113,0)
 ; Ignore prefixes and suffices
"RTN","MAGDQR01",114,0)
 F I=1:1:3 D
"RTN","MAGDQR01",115,0)
 . S P(I)=$P(NAME,"^",I)
"RTN","MAGDQR01",116,0)
 . F  Q:$E(P(I),1)'=" "   S P(I)=$E(P(I),2,$L(P(I)))
"RTN","MAGDQR01",117,0)
 . F  Q:$E(P(I),$L(P(I)))'=" "   S P(I)=$E(P(I),1,$L(P(I))-1)
"RTN","MAGDQR01",118,0)
 . Q
"RTN","MAGDQR01",119,0)
 S NAME=P(1)_","_P(2) S:P(3)'="" NAME=NAME_" "_P(3)
"RTN","MAGDQR01",120,0)
 Q NAME
"RTN","MAGDQR01",121,0)
 ;
"RTN","MAGDQR01",122,0)
ERR(X) S ERROR=ERROR+1,ERROR(ERROR)=X
"RTN","MAGDQR01",123,0)
 Q
"RTN","MAGDQR01",124,0)
 ;
"RTN","MAGDQR01",125,0)
ERRLOG N I,O
"RTN","MAGDQR01",126,0)
 S O=1,I="" F  S I=$O(ERROR(I)) Q:I=""  S O=O+1,OUT(O)=ERROR(I)
"RTN","MAGDQR01",127,0)
 SET OUT(1)=(-O)_",Errors encountered"
"RTN","MAGDQR01",128,0)
 Q
"RTN","MAGDQR01",129,0)
 ;
"RTN","MAGDQR01",130,0)
ERRSAV N I,O
"RTN","MAGDQR01",131,0)
 S $P(^MAGDQR(2006.5732,RESULT,0),"^",2,3)="OK^"_$$NOW^XLFDT()
"RTN","MAGDQR01",132,0)
 K ^MAGDQR(2006.5732,"RESULT",1)
"RTN","MAGDQR01",133,0)
 S O=0,I="" F  S I=$O(ERROR(I)) Q:I=""  D
"RTN","MAGDQR01",134,0)
 . S O=O+1,^MAGDQR(2006.5732,RESULT,1,O,0)="0000,0902^"_ERROR(I)
"RTN","MAGDQR01",135,0)
 . Q
"RTN","MAGDQR01",136,0)
 Q
"RTN","MAGDQR01",137,0)
 ;
"RTN","MAGDQR02")
0^32^B75305659
"RTN","MAGDQR02",1,0)
MAGDQR02 ;WOIFO/EdM - Imaging RPCs for Query/Retrieve ; 05/16/2005  09:30
"RTN","MAGDQR02",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGDQR02",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR02",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR02",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR02",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR02",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR02",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR02",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR02",10,0)
 ;; |                                                               |
"RTN","MAGDQR02",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR02",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR02",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR02",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR02",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR02",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR02",17,0)
 ;;
"RTN","MAGDQR02",18,0)
 Q
"RTN","MAGDQR02",19,0)
 ;
"RTN","MAGDQR02",20,0)
QUERY ; --- perform actual query --- Called by TaskMan
"RTN","MAGDQR02",21,0)
 N ACC,ANY,MAGD0,MAGD1,MAGD2,ERROR,FD,FT,I,IMAGE,L,LD,LT,OFFSET,P,PAT,SID,SSN,T,TIM,UID,V,X
"RTN","MAGDQR02",22,0)
 ;
"RTN","MAGDQR02",23,0)
 K ^TMP("MAG",$J,"QR")
"RTN","MAGDQR02",24,0)
 S (PAT,SSN,ACC,UID,SID,SDT,TIM,ERROR)=0
"RTN","MAGDQR02",25,0)
 S FD=0,LD=9999999,FT=0,LT=240000
"RTN","MAGDQR02",26,0)
 ;
"RTN","MAGDQR02",27,0)
 S T="0008,0020",I=0
"RTN","MAGDQR02",28,0)
 S P="" F  S P=$O(REQ(T,P)) Q:P=""  D:REQ(T,P)'=""
"RTN","MAGDQR02",29,0)
 . N F,U
"RTN","MAGDQR02",30,0)
 . S I=I+1 I I>1 D ERR^MAGDQR01("More than one study date specified.") Q
"RTN","MAGDQR02",31,0)
 . S (X,F,U)=REQ(T,P) S:X["-" F=$P(X,"-",1),U=$P(X,"-",2)
"RTN","MAGDQR02",32,0)
 . I F'="",F'?8N D ERR^MAGDQR01("Invalid 'from' date: """_F_""".")
"RTN","MAGDQR02",33,0)
 . I U'="",U'?8N D ERR^MAGDQR01("Invalid 'until' date: """_U_""".")
"RTN","MAGDQR02",34,0)
 . S FD=+F S:FD FD=FD-17000000
"RTN","MAGDQR02",35,0)
 . S LD=+U S:LD LD=LD-17000000
"RTN","MAGDQR02",36,0)
 . S TIM=1
"RTN","MAGDQR02",37,0)
 . Q
"RTN","MAGDQR02",38,0)
 ;
"RTN","MAGDQR02",39,0)
 S T="0008,0030",I=0
"RTN","MAGDQR02",40,0)
 S P="" F  S P=$O(REQ(T,P)) Q:P=""  D:REQ(T,P)'=""
"RTN","MAGDQR02",41,0)
 . N F,U
"RTN","MAGDQR02",42,0)
 . S I=I+1 I I>1 D ERR^MAGDQR01("More than one study time specified.") Q
"RTN","MAGDQR02",43,0)
 . S (X,F,U)=REQ(T,P) S:X["-" F=$P(X,"-",1),U=$P(X,"-",2)
"RTN","MAGDQR02",44,0)
 . D CHKTIM(F,"from")
"RTN","MAGDQR02",45,0)
 . D CHKTIM(U,"until")
"RTN","MAGDQR02",46,0)
 . S FT=+$E(F_"000000",1,6)
"RTN","MAGDQR02",47,0)
 . S LT=+$E(U_"000000",1,6)
"RTN","MAGDQR02",48,0)
 . S TIM=1
"RTN","MAGDQR02",49,0)
 . Q
"RTN","MAGDQR02",50,0)
 I ERROR D ERRSAV^MAGDQR01 Q
"RTN","MAGDQR02",51,0)
 ;
"RTN","MAGDQR02",52,0)
 S FD=FT/1E6+FD,LD=LT/1E6+LD
"RTN","MAGDQR02",53,0)
 ;
"RTN","MAGDQR02",54,0)
 S T="0010,0010",ANY=0
"RTN","MAGDQR02",55,0)
 S P="" F  S P=$O(REQ(T,P)) Q:P=""  D:REQ(T,P)'=""
"RTN","MAGDQR02",56,0)
 . ; The references below to ^DPT are permitted according to the
"RTN","MAGDQR02",57,0)
 . ; explicit permission in Section II of the PIMS V5.3 technical manual
"RTN","MAGDQR02",58,0)
 . ; (dated 23 Nov 2004)
"RTN","MAGDQR02",59,0)
 . S ANY=1
"RTN","MAGDQR02",60,0)
 . S I=$$MATCHD^MAGDQR03(REQ(T,P),"^DPT(""B"",LOOP)","^TMP(""MAG"",$J,""QR"",1,LOOP)")
"RTN","MAGDQR02",61,0)
 . S V="" F  S V=$O(^TMP("MAG",$J,"QR",1,V)) Q:V=""  D
"RTN","MAGDQR02",62,0)
 . . S I="" F  S I=$O(^DPT("B",V,I)) Q:I=""  S ^TMP("MAG",$J,"QR",2,I)="",PAT=1
"RTN","MAGDQR02",63,0)
 . . Q
"RTN","MAGDQR02",64,0)
 . Q
"RTN","MAGDQR02",65,0)
 I ANY,'PAT D  Q
"RTN","MAGDQR02",66,0)
 . D ERR^MAGDQR01("No matches for tag "_T)
"RTN","MAGDQR02",67,0)
 . D ERRSAV^MAGDQR01
"RTN","MAGDQR02",68,0)
 . Q
"RTN","MAGDQR02",69,0)
 ;
"RTN","MAGDQR02",70,0)
 S T="0010,0020",ANY=0
"RTN","MAGDQR02",71,0)
 S P="" F  S P=$O(REQ(T,P)) Q:P=""  D:REQ(T,P)'=""
"RTN","MAGDQR02",72,0)
 . ; The references below to ^DPT are permitted according to the
"RTN","MAGDQR02",73,0)
 . ; explicit permission in Section II of the PIMS V5.3 technical manual
"RTN","MAGDQR02",74,0)
 . ; (dated 23 Nov 2004)
"RTN","MAGDQR02",75,0)
 . S ANY=1
"RTN","MAGDQR02",76,0)
 . S I=$$MATCHD^MAGDQR03($TR(REQ(T,P),"-"),"^DPT(""SSN"",LOOP)","^TMP(""MAG"",$J,""QR"",3,LOOP)")
"RTN","MAGDQR02",77,0)
 . S V="" F  S V=$O(^TMP("MAG",$J,"QR",3,V)) Q:V=""  D
"RTN","MAGDQR02",78,0)
 . . S I="" F  S I=$O(^DPT("SSN",V,I)) Q:I=""  S ^TMP("MAG",$J,"QR",4,I)="",SSN=1
"RTN","MAGDQR02",79,0)
 . . Q
"RTN","MAGDQR02",80,0)
 . Q
"RTN","MAGDQR02",81,0)
 I ANY,'SSN D  Q
"RTN","MAGDQR02",82,0)
 . D ERR^MAGDQR01("No matches for tag "_T)
"RTN","MAGDQR02",83,0)
 . D ERRSAV^MAGDQR01
"RTN","MAGDQR02",84,0)
 . Q
"RTN","MAGDQR02",85,0)
 ;
"RTN","MAGDQR02",86,0)
 S T="0008,0050",ANY=0
"RTN","MAGDQR02",87,0)
 S P="" F  S P=$O(REQ(T,P)) Q:P=""  D:REQ(T,P)'=""
"RTN","MAGDQR02",88,0)
 . ; The references below to ^RADPT are permitted according to the
"RTN","MAGDQR02",89,0)
 . ; existing Integration Agreement # 1172
"RTN","MAGDQR02",90,0)
 . S ANY=1
"RTN","MAGDQR02",91,0)
 . S I=$$MATCHD^MAGDQR03(REQ(T,P),"^RADPT(""ADC"",LOOP)","^TMP(""MAG"",$J,""QR"",5,LOOP)")
"RTN","MAGDQR02",92,0)
 . S V="" F  S V=$O(^TMP("MAG",$J,"QR",5,V)) Q:V=""  D
"RTN","MAGDQR02",93,0)
 . . S MAGD0="" F  S MAGD0=$O(^RADPT("ADC",V,MAGD0)) Q:MAGD0=""  D
"RTN","MAGDQR02",94,0)
 . . . S MAGD1="" F  S MAGD1=$O(^RADPT("ADC",V,MAGD0,MAGD1)) Q:MAGD1=""  D
"RTN","MAGDQR02",95,0)
 . . . . S MAGD2="" F  S MAGD2=$O(^RADPT("ADC",V,MAGD0,MAGD1,MAGD2)) Q:MAGD2=""  D
"RTN","MAGDQR02",96,0)
 . . . . . S ^TMP("MAG",$J,"QR",6,MAGD0_"^"_MAGD1_"^"_MAGD2)="",ACC=1
"RTN","MAGDQR02",97,0)
 . . . . . Q
"RTN","MAGDQR02",98,0)
 . . . . Q
"RTN","MAGDQR02",99,0)
 . . . Q
"RTN","MAGDQR02",100,0)
 . . Q
"RTN","MAGDQR02",101,0)
 . Q
"RTN","MAGDQR02",102,0)
 I ANY,'ACC D  Q
"RTN","MAGDQR02",103,0)
 . D ERR^MAGDQR01("No matches for tag "_T)
"RTN","MAGDQR02",104,0)
 . D ERRSAV^MAGDQR01
"RTN","MAGDQR02",105,0)
 . Q
"RTN","MAGDQR02",106,0)
 ;
"RTN","MAGDQR02",107,0)
 S T="0020,0010",ANY=0
"RTN","MAGDQR02",108,0)
 S P="" F  S P=$O(REQ(T,P)) Q:P=""  D:REQ(T,P)'=""
"RTN","MAGDQR02",109,0)
 . ; The references below to ^RADPT are permitted according to the
"RTN","MAGDQR02",110,0)
 . ; existing Integration Agreement # 1172
"RTN","MAGDQR02",111,0)
 . S ANY=1
"RTN","MAGDQR02",112,0)
 . S I=$$MATCHD^MAGDQR03("*-"_REQ(T,P),"^RADPT(""ADC"",LOOP)","^TMP(""MAG"",$J,""QR"",9,LOOP)")
"RTN","MAGDQR02",113,0)
 . S V="" F  S V=$O(^TMP("MAG",$J,"QR",9,V)) Q:V=""  D
"RTN","MAGDQR02",114,0)
 . . S MAGD0="" F  S MAGD0=$O(^RADPT("ADC",V,MAGD0)) Q:MAGD0=""  D
"RTN","MAGDQR02",115,0)
 . . . S MAGD1="" F  S MAGD1=$O(^RADPT("ADC",V,MAGD0,MAGD1)) Q:MAGD1=""  D
"RTN","MAGDQR02",116,0)
 . . . . S MAGD2="" F  S MAGD2=$O(^RADPT("ADC",V,MAGD0,MAGD1,MAGD2)) Q:MAGD2=""  D
"RTN","MAGDQR02",117,0)
 . . . . . S ^TMP("MAG",$J,"QR",10,MAGD0_"^"_MAGD1_"^"_MAGD2)="",SID=1
"RTN","MAGDQR02",118,0)
 . . . . . Q
"RTN","MAGDQR02",119,0)
 . . . . Q
"RTN","MAGDQR02",120,0)
 . . . Q
"RTN","MAGDQR02",121,0)
 . . Q
"RTN","MAGDQR02",122,0)
 . Q
"RTN","MAGDQR02",123,0)
 I ANY,'SID D  Q
"RTN","MAGDQR02",124,0)
 . D ERR^MAGDQR01("No matches for tag "_T)
"RTN","MAGDQR02",125,0)
 . D ERRSAV^MAGDQR01
"RTN","MAGDQR02",126,0)
 . Q
"RTN","MAGDQR02",127,0)
 ;
"RTN","MAGDQR02",128,0)
 S T="0020,000D",ANY=0
"RTN","MAGDQR02",129,0)
 S P="" F  S P=$O(REQ(T,P)) Q:P=""  D:REQ(T,P)'=""
"RTN","MAGDQR02",130,0)
 . S ANY=1
"RTN","MAGDQR02",131,0)
 . S I=$$MATCHD^MAGDQR03(REQ(T,P),"^MAG(2005,""P"",LOOP)","^TMP(""MAG"",$J,""QR"",7,LOOP)")
"RTN","MAGDQR02",132,0)
 . S V="" F  S V=$O(^TMP("MAG",$J,"QR",7,V)) Q:V=""  D
"RTN","MAGDQR02",133,0)
 . . S I="" F  S I=$O(^MAG(2005,"P",V,I)) Q:I=""  D
"RTN","MAGDQR02",134,0)
 . . . ; If this image has a parent, its UID is not a study UID
"RTN","MAGDQR02",135,0)
 . . . Q:$P($G(^MAG(2005,I,0)),"^",10)
"RTN","MAGDQR02",136,0)
 . . . S ^TMP("MAG",$J,"QR",8,I)="",UID=1
"RTN","MAGDQR02",137,0)
 . . . Q
"RTN","MAGDQR02",138,0)
 . . Q
"RTN","MAGDQR02",139,0)
 . Q
"RTN","MAGDQR02",140,0)
 I ANY,'UID D  Q
"RTN","MAGDQR02",141,0)
 . D ERR^MAGDQR01("No matches for tag "_T)
"RTN","MAGDQR02",142,0)
 . D ERRSAV^MAGDQR01
"RTN","MAGDQR02",143,0)
 . Q
"RTN","MAGDQR02",144,0)
 ;
"RTN","MAGDQR02",145,0)
 I TIM,'(PAT+SSN+SID+UID+ACC) D TIM^MAGDQR04
"RTN","MAGDQR02",146,0)
 ;
"RTN","MAGDQR02",147,0)
 I '(PAT+SSN+SID+UID+ACC) D  Q
"RTN","MAGDQR02",148,0)
 . D ERR^MAGDQR01("No Selection Specified.")
"RTN","MAGDQR02",149,0)
 . D ERRSAV^MAGDQR01
"RTN","MAGDQR02",150,0)
 . Q
"RTN","MAGDQR02",151,0)
 ;
"RTN","MAGDQR02",152,0)
 D ELIM(ACC,SID,6,10,"Accession and Study ID",0)
"RTN","MAGDQR02",153,0)
 M ^TMP("MAG",$J,"QR",12)=^TMP("MAG",$J,"QR",6)
"RTN","MAGDQR02",154,0)
 M ^TMP("MAG",$J,"QR",12)=^TMP("MAG",$J,"QR",10)
"RTN","MAGDQR02",155,0)
 ;
"RTN","MAGDQR02",156,0)
 D ELIM(PAT,SSN,2,4,"Patient Name and ID",0)
"RTN","MAGDQR02",157,0)
 M ^TMP("MAG",$J,"QR",11)=^TMP("MAG",$J,"QR",2)
"RTN","MAGDQR02",158,0)
 M ^TMP("MAG",$J,"QR",11)=^TMP("MAG",$J,"QR",4)
"RTN","MAGDQR02",159,0)
 ;
"RTN","MAGDQR02",160,0)
 D ELIM(PAT+SSN,ACC+SID,11,12,"Patient and Study Info",1)
"RTN","MAGDQR02",161,0)
 I ERROR D ERRSAV^MAGDQR01 Q
"RTN","MAGDQR02",162,0)
 ;
"RTN","MAGDQR02",163,0)
 S ANY=0
"RTN","MAGDQR02",164,0)
 D
"RTN","MAGDQR02",165,0)
 . I UID D  Q
"RTN","MAGDQR02",166,0)
 . . S IMAGE="" F  S IMAGE=$O(^TMP("MAG",$J,"QR",8,IMAGE)) Q:IMAGE=""  D
"RTN","MAGDQR02",167,0)
 . . . S X=$G(^MAG(2005,IMAGE,0)),P=$P(X,"^",7)
"RTN","MAGDQR02",168,0)
 . . . I PAT+SSN,P,'$D(^TMP("MAG",$J,"QR",11,P)) Q
"RTN","MAGDQR02",169,0)
 . . . S X=$G(^MAG(2005,IMAGE,2)),V=$P(X,"^",6) Q:V'=74
"RTN","MAGDQR02",170,0)
 . . . S V=$P(X,"^",5) I V,(V<FD)!(V>LD) Q
"RTN","MAGDQR02",171,0)
 . . . S X=$G(^RARPT(+$P(X,"^",7),0)) ; IA # 1171
"RTN","MAGDQR02",172,0)
 . . . S MAGD0=$P(X,"^",2),MAGD1=9999999.9999-$P(X,"^",3),V=$P(X,"^",4)
"RTN","MAGDQR02",173,0)
 . . . S MAGD2=$O(^RADPT(MAGD0,"DT",MAGD1,"P","B",V,"")) ; IA # 1172
"RTN","MAGDQR02",174,0)
 . . . I ACC+SID,'$D(^TMP("MAG",$J,"QR",12,MAGD0_"^"_MAGD1_"^"_MAGD2)) Q
"RTN","MAGDQR02",175,0)
 . . . D RESULT^MAGDQR03
"RTN","MAGDQR02",176,0)
 . . . Q
"RTN","MAGDQR02",177,0)
 . . Q
"RTN","MAGDQR02",178,0)
 . ;
"RTN","MAGDQR02",179,0)
 . I ACC+SID D  Q
"RTN","MAGDQR02",180,0)
 . . N OK,P1,P2,P3,P4
"RTN","MAGDQR02",181,0)
 . . S P="" F  S P=$O(^TMP("MAG",$J,"QR",12,P)) Q:P=""  D
"RTN","MAGDQR02",182,0)
 . . . S MAGD0=$P(P,"^",1),MAGD1=$P(P,"^",2),MAGD2=$P(P,"^",3)
"RTN","MAGDQR02",183,0)
 . . . I PAT+SSN,'$D(^TMP("MAG",$J,"QR",11,MAGD0)) Q
"RTN","MAGDQR02",184,0)
 . . . S OK=0 D  Q:'OK
"RTN","MAGDQR02",185,0)
 . . . . S V=$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",17) Q:'V  ; IA # 1172
"RTN","MAGDQR02",186,0)
 . . . . S P1=0 F  S P1=$O(^RARPT(V,2005,P1)) Q:'P1  D  Q:OK  ; IA # 1171
"RTN","MAGDQR02",187,0)
 . . . . . S P2=+$G(^RARPT(V,2005,P1,0)) Q:'P2  ; IA # 1171
"RTN","MAGDQR02",188,0)
 . . . . . I UID,$D(^TMP("MAG",$J,"QR",8,P2)) S OK=1,IMAGE=P2 Q
"RTN","MAGDQR02",189,0)
 . . . . . I 'UID S OK=1,IMAGE=P2 Q
"RTN","MAGDQR02",190,0)
 . . . . . S P3=0 F  S P3=$O(^MAG(2005,P2,1,P3)) Q:'P3  D  Q:OK
"RTN","MAGDQR02",191,0)
 . . . . . . S P4=$P($G(^MAG(2005,P2,1,P3,0)),"^",1) Q:'P4
"RTN","MAGDQR02",192,0)
 . . . . . . I UID,$D(^TMP("MAG",$J,"QR",8,P4)) S OK=1,IMAGE=P4 Q
"RTN","MAGDQR02",193,0)
 . . . . . . I 'UID S OK=1,IMAGE=P4 Q
"RTN","MAGDQR02",194,0)
 . . . . . . Q
"RTN","MAGDQR02",195,0)
 . . . . . Q
"RTN","MAGDQR02",196,0)
 . . . . Q
"RTN","MAGDQR02",197,0)
 . . . D RESULT^MAGDQR03
"RTN","MAGDQR02",198,0)
 . . . Q
"RTN","MAGDQR02",199,0)
 . . Q
"RTN","MAGDQR02",200,0)
 . ;
"RTN","MAGDQR02",201,0)
 . I PAT+SSN D  Q
"RTN","MAGDQR02",202,0)
 . . S P="" F  S P=$O(^TMP("MAG",$J,"QR",11,P)) Q:P=""  D
"RTN","MAGDQR02",203,0)
 . . . S IMAGE="" F  S IMAGE=$O(^MAG(2005,"AC",P,IMAGE)) Q:IMAGE=""  D
"RTN","MAGDQR02",204,0)
 . . . . Q:$P($G(^MAG(2005,IMAGE,0)),"^",10)
"RTN","MAGDQR02",205,0)
 . . . . S X=$G(^MAG(2005,IMAGE,2)),V=$P(X,"^",6) Q:V'=74
"RTN","MAGDQR02",206,0)
 . . . . S V=$P(X,"^",5) I V,(V<FD)!(V>LD) Q
"RTN","MAGDQR02",207,0)
 . . . . S X=$G(^RARPT(+$P(X,"^",7),0)) ; IA # 1171
"RTN","MAGDQR02",208,0)
 . . . . S MAGD0=$P(X,"^",2),MAGD1=9999999.9999-$P(X,"^",3),V=$P(X,"^",4)
"RTN","MAGDQR02",209,0)
 . . . . S MAGD2=$O(^RADPT(MAGD0,"DT",MAGD1,"P","B",V,"")) ; IA # 1172
"RTN","MAGDQR02",210,0)
 . . . . I ACC+SID,'$D(^TMP("MAG",$J,"QR",12,MAGD0_"^"_MAGD1_"^"_MAGD2)) Q
"RTN","MAGDQR02",211,0)
 . . . . D RESULT^MAGDQR03
"RTN","MAGDQR02",212,0)
 . . . . Q
"RTN","MAGDQR02",213,0)
 . . . Q
"RTN","MAGDQR02",214,0)
 . . Q
"RTN","MAGDQR02",215,0)
 . Q
"RTN","MAGDQR02",216,0)
 ;
"RTN","MAGDQR02",217,0)
 S $P(^MAGDQR(2006.5732,RESULT,0),"^",2,3)="OK^"_$$NOW^XLFDT()
"RTN","MAGDQR02",218,0)
 K ^TMP("MAG",$J,"QR")
"RTN","MAGDQR02",219,0)
 Q
"RTN","MAGDQR02",220,0)
 ;
"RTN","MAGDQR02",221,0)
CHKTIM(V,L) ;
"RTN","MAGDQR02",222,0)
 Q:V=""
"RTN","MAGDQR02",223,0)
 I V'?1.6N D ERR^MAGDQR01("Invalid '"_L_"' time: """_V_""".")
"RTN","MAGDQR02",224,0)
 I $E(V,1,2)>23 D ERR^MAGDQR01("Invalid hours in '"_L_"' time: """_V_""".")
"RTN","MAGDQR02",225,0)
 I $E(V,3,4),$E(V,3,4)>59 D ERR^MAGDQR01("Invalid minutes in '"_L_"' time: """_V_""".")
"RTN","MAGDQR02",226,0)
 I $E(V,5,6),$E(V,5,6)>59 D ERR^MAGDQR01("Invalid seconds '"_L_"' time: """_V_""".")
"RTN","MAGDQR02",227,0)
 Q
"RTN","MAGDQR02",228,0)
 ;
"RTN","MAGDQR02",229,0)
ELIM(ONE,TWO,I1,I2,E,C) N ANY,I,O
"RTN","MAGDQR02",230,0)
 Q:'ONE  Q:'TWO
"RTN","MAGDQR02",231,0)
 S I="" F  S I=$O(^TMP("MAG",$J,"QR",I1,I)) Q:I=""  D
"RTN","MAGDQR02",232,0)
 . S O=I I C Q:I'["^"  S O=+I
"RTN","MAGDQR02",233,0)
 . I '$D(^TMP("MAG",$J,"QR",I2,O)) K ^TMP("MAG",$J,"QR",I1,I)
"RTN","MAGDQR02",234,0)
 . Q
"RTN","MAGDQR02",235,0)
 S I="" F  S I=$O(^TMP("MAG",$J,"QR",I2,I)) Q:I=""  D
"RTN","MAGDQR02",236,0)
 . S O=I I C Q:I'["^"  S O=+I
"RTN","MAGDQR02",237,0)
 . I '$D(^TMP("MAG",$J,"QR",I1,O)) K ^TMP("MAG",$J,"QR",I2,I)
"RTN","MAGDQR02",238,0)
 . Q
"RTN","MAGDQR02",239,0)
 S ANY=$O(^TMP("MAG",$J,"QR",I1,""))*$O(^TMP("MAG",$J,"QR",I2,""))
"RTN","MAGDQR02",240,0)
 D:'ANY ERR^MAGDQR01("No matches left, conflict between "_E)
"RTN","MAGDQR02",241,0)
 Q
"RTN","MAGDQR02",242,0)
 ;
"RTN","MAGDQR03")
0^33^B63890253
"RTN","MAGDQR03",1,0)
MAGDQR03 ;WOIFO/EdM - Imaging RPCs for Query/Retrieve ; 05/16/2005  08:45
"RTN","MAGDQR03",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGDQR03",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR03",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR03",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR03",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR03",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR03",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR03",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR03",10,0)
 ;; |                                                               |
"RTN","MAGDQR03",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR03",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR03",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR03",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR03",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR03",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR03",17,0)
 ;;
"RTN","MAGDQR03",18,0)
 Q
"RTN","MAGDQR03",19,0)
 ;
"RTN","MAGDQR03",20,0)
RESULT N E,L,OK,V,X,T
"RTN","MAGDQR03",21,0)
 S OK=1
"RTN","MAGDQR03",22,0)
 S T="" F  S T=$O(REQ(T)) Q:T=""  D
"RTN","MAGDQR03",23,0)
 . S L=$TR(T,",")
"RTN","MAGDQR03",24,0)
 . S E=$TR($E(L,1),"0123456789abcdef","QRSTUVWXYZABCDEF")
"RTN","MAGDQR03",25,0)
 . S $E(L,1)=E S:L'?8UN L=""
"RTN","MAGDQR03",26,0)
 . I L'="",$T(@L)'="" D @L Q
"RTN","MAGDQR03",27,0)
 . D ERR^MAGDQR01("Undefined tag: """_T_""".") S OK=0
"RTN","MAGDQR03",28,0)
 . Q
"RTN","MAGDQR03",29,0)
 Q:'OK
"RTN","MAGDQR03",30,0)
 ;
"RTN","MAGDQR03",31,0)
 S ANY=ANY+1
"RTN","MAGDQR03",32,0)
 D
"RTN","MAGDQR03",33,0)
 . N R1,V1,V2,VAL
"RTN","MAGDQR03",34,0)
 . S R1=$O(^MAGDQR(2006.5732,RESULT,1," "),-1)+1
"RTN","MAGDQR03",35,0)
 . S ^MAGDQR(2006.5732,RESULT,1,R1,0)="0000,0902^Result # "_ANY
"RTN","MAGDQR03",36,0)
 . S T="" F  S T=$O(V(T)) Q:T=""  D
"RTN","MAGDQR03",37,0)
 . . S VAL=$G(V(T))
"RTN","MAGDQR03",38,0)
 . . S V1="" F  S V1=$O(V(T,V1)) Q:V1=""  D
"RTN","MAGDQR03",39,0)
 . . . Q:$G(V(T,V1))=""
"RTN","MAGDQR03",40,0)
 . . . S:VAL'="" VAL=VAL_"\" S VAL=VAL_V(T,V1)
"RTN","MAGDQR03",41,0)
 . . . Q
"RTN","MAGDQR03",42,0)
 . . S R1=R1+1,^MAGDQR(2006.5732,RESULT,1,R1,0)=T_"^"_VAL
"RTN","MAGDQR03",43,0)
 . . S ^MAGDQR(2006.5732,RESULT,1,"B",T,R1)=""
"RTN","MAGDQR03",44,0)
 . . Q:$D(V(T))<10
"RTN","MAGDQR03",45,0)
 . . S V1="" F  S V1=$O(V(T,V1)) Q:V1=""  D
"RTN","MAGDQR03",46,0)
 . . . S V2="" F  S V2=$O(V(T,V1,V2)) Q:V2=""  D
"RTN","MAGDQR03",47,0)
 . . . . S VAL=$G(V(T,V1,V2)) Q:VAL=""
"RTN","MAGDQR03",48,0)
 . . . . S R1=R1+1,^MAGDQR(2006.5732,RESULT,1,R1,0)=T_"^"_VAL
"RTN","MAGDQR03",49,0)
 . . . . S ^MAGDQR(2006.5732,RESULT,1,"B",T,R1)=""
"RTN","MAGDQR03",50,0)
 . . . . Q
"RTN","MAGDQR03",51,0)
 . . . Q
"RTN","MAGDQR03",52,0)
 . . Q
"RTN","MAGDQR03",53,0)
 . Q
"RTN","MAGDQR03",54,0)
 Q
"RTN","MAGDQR03",55,0)
 ;
"RTN","MAGDQR03",56,0)
COMPARE(TAG,ACTUAL) N LOC,TMP,WILD
"RTN","MAGDQR03",57,0)
 Q:'$G(REQ(TAG)) 1
"RTN","MAGDQR03",58,0)
 S WILD=$G(REQ(TAG,1)) Q:WILD="" 0
"RTN","MAGDQR03",59,0)
 Q:$G(ACTUAL)="" 0
"RTN","MAGDQR03",60,0)
 S LOC(ACTUAL)=""
"RTN","MAGDQR03",61,0)
 Q $$MATCHD(WILD,"LOC(LOOP)","TMP(LOOP)")
"RTN","MAGDQR03",62,0)
 ;
"RTN","MAGDQR03",63,0)
MATCH1(X,Y) N I,M
"RTN","MAGDQR03",64,0)
 F  Q:X=""  Q:Y=""  D
"RTN","MAGDQR03",65,0)
 . I $E(X,1)=$E(Y,1) S X=$E(X,2,$L(X)),Y=$E(Y,2,$L(Y)) Q
"RTN","MAGDQR03",66,0)
 . I $E(Y,1)="?" S X=$E(X,2,$L(X)),Y=$E(Y,2,$L(Y)) Q
"RTN","MAGDQR03",67,0)
 . I $E(Y,1)="*" D  Q:M
"RTN","MAGDQR03",68,0)
 . . I Y="*" S (X,Y)="",M=1 Q
"RTN","MAGDQR03",69,0)
 . . S Y=$E(Y,2,$L(Y)),M=0
"RTN","MAGDQR03",70,0)
 . . F I=1:1:$L(X) I $$MATCH1($E(X,I,$L(X)),Y) S M=1,X=$E(X,I,$L(X)) Q
"RTN","MAGDQR03",71,0)
 . . Q
"RTN","MAGDQR03",72,0)
 . S X="!",Y=""
"RTN","MAGDQR03",73,0)
 . Q
"RTN","MAGDQR03",74,0)
 S:$TR(Y,"*")="" Y="" Q:X'="" 0 Q:Y'="" 0
"RTN","MAGDQR03",75,0)
 Q 1
"RTN","MAGDQR03",76,0)
 ;
"RTN","MAGDQR03",77,0)
MATCHD(WILDCARD,STRUCTUR,FOUND) N C,LOOP,L1,L9,SEEK,X,Y
"RTN","MAGDQR03",78,0)
 ;  -- Scans a structure,
"RTN","MAGDQR03",79,0)
 ;     reports entries in @STRUCTUR that match WILDCARD;
"RTN","MAGDQR03",80,0)
 ;     the result is reported in local array @FOUND
"RTN","MAGDQR03",81,0)
 S C=0
"RTN","MAGDQR03",82,0)
 S L1=$P($P(WILDCARD,"?",1),"*",1),L9=L1_"~"
"RTN","MAGDQR03",83,0)
 I L1=WILDCARD D  Q C
"RTN","MAGDQR03",84,0)
 . S LOOP=L1
"RTN","MAGDQR03",85,0)
 . I $D(@STRUCTUR) S @FOUND="" Q
"RTN","MAGDQR03",86,0)
 . Q
"RTN","MAGDQR03",87,0)
 S LOOP=L1 F  D  S LOOP=$O(@STRUCTUR) Q:LOOP=""  Q:LOOP]]L9
"RTN","MAGDQR03",88,0)
 . Q:LOOP=""  Q:'$D(@STRUCTUR)
"RTN","MAGDQR03",89,0)
 . Q:'$$MATCH1(LOOP,WILDCARD)
"RTN","MAGDQR03",90,0)
 . S C=C+1
"RTN","MAGDQR03",91,0)
 . S @FOUND=""
"RTN","MAGDQR03",92,0)
 . Q
"RTN","MAGDQR03",93,0)
 Q C
"RTN","MAGDQR03",94,0)
 ;
"RTN","MAGDQR03",95,0)
Q0080020 ;R Study Date
"RTN","MAGDQR03",96,0)
 S V(T)=$P($G(^MAG(2005,IMAGE,2)),"^",5)\1+17000000
"RTN","MAGDQR03",97,0)
 Q
"RTN","MAGDQR03",98,0)
 ;
"RTN","MAGDQR03",99,0)
Q0080030 ;R  Study Time
"RTN","MAGDQR03",100,0)
 S V(T)=$TR($J("."_$P($P($G(^MAG(2005,IMAGE,2)),"^",5),".",2)*1E6,6)," ",0)
"RTN","MAGDQR03",101,0)
 Q
"RTN","MAGDQR03",102,0)
 ;
"RTN","MAGDQR03",103,0)
Q0080050 ;R  Accession Number
"RTN","MAGDQR03",104,0)
 S X=$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",17) ; IA # 1172
"RTN","MAGDQR03",105,0)
 S V(T)=$P($G(^RARPT(+X,0)),"^",1) ; IA # 1171
"RTN","MAGDQR03",106,0)
 Q
"RTN","MAGDQR03",107,0)
 ;
"RTN","MAGDQR03",108,0)
Q0100010 ;R  Patient's Name
"RTN","MAGDQR03",109,0)
 S V(T)=$P($G(^DPT(MAGD0,0)),"^",1) ; No IA needed, PIMS 5.3
"RTN","MAGDQR03",110,0)
 Q
"RTN","MAGDQR03",111,0)
 ;
"RTN","MAGDQR03",112,0)
Q0100020 ;R  Patient ID
"RTN","MAGDQR03",113,0)
 S V(T)=$P($G(^DPT(MAGD0,0)),"^",9) ; No IA needed, PIMS 5.3
"RTN","MAGDQR03",114,0)
 Q
"RTN","MAGDQR03",115,0)
 ;
"RTN","MAGDQR03",116,0)
Q0200010 ;R  Study ID
"RTN","MAGDQR03",117,0)
 S V(T)=$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",1) ; IA # 1172
"RTN","MAGDQR03",118,0)
 Q
"RTN","MAGDQR03",119,0)
 ;
"RTN","MAGDQR03",120,0)
Q020000D ;U  Study Instance UID
"RTN","MAGDQR03",121,0)
 S V(T)=$P($G(^MAG(2005,IMAGE,"PACS")),"^",1)
"RTN","MAGDQR03",122,0)
 Q
"RTN","MAGDQR03",123,0)
 ;
"RTN","MAGDQR03",124,0)
Q0080061 ;O  Modalities in Study
"RTN","MAGDQR03",125,0)
 N P1,P2,R
"RTN","MAGDQR03",126,0)
 S R=""
"RTN","MAGDQR03",127,0)
 S P1=0 F  S P1=$O(^MAG(2005,IMAGE,1,P1)) Q:'P1  D
"RTN","MAGDQR03",128,0)
 . S P2=+$G(^MAG(2005,IMAGE,1,P1,0)) Q:'P2
"RTN","MAGDQR03",129,0)
 . S X=$P($G(^MAG(2005,P2,0)),"^",8) Q:$E(X,1,4)'="RAD"
"RTN","MAGDQR03",130,0)
 . S:R'="" R=R_"," S R=R_$E(X,5,$L(X))
"RTN","MAGDQR03",131,0)
 . Q
"RTN","MAGDQR03",132,0)
 S V(T)=R
"RTN","MAGDQR03",133,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",134,0)
 Q
"RTN","MAGDQR03",135,0)
 ;
"RTN","MAGDQR03",136,0)
Q0080062 ;O  SOP Classes in Study
"RTN","MAGDQR03",137,0)
 ; --- probably not supported --- ?
"RTN","MAGDQR03",138,0)
 ; ? ? ?
"RTN","MAGDQR03",139,0)
 Q
"RTN","MAGDQR03",140,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",141,0)
 Q
"RTN","MAGDQR03",142,0)
 ;
"RTN","MAGDQR03",143,0)
Q0080090 ;O  Referring Physician's Name
"RTN","MAGDQR03",144,0)
 S X=$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",14) ; IA # 1172
"RTN","MAGDQR03",145,0)
 S V(T)=$P($G(^VA(200,+X,0)),"^",1)
"RTN","MAGDQR03",146,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",147,0)
 Q
"RTN","MAGDQR03",148,0)
 ;
"RTN","MAGDQR03",149,0)
Q0081030 ;O  Study Description
"RTN","MAGDQR03",150,0)
 S X=$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",2) ; IA # 1172
"RTN","MAGDQR03",151,0)
 S V(T)=$P($G(^RAMIS(71,+X,0)),"^",1) ; IA # 1174
"RTN","MAGDQR03",152,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",153,0)
 Q
"RTN","MAGDQR03",154,0)
 ;
"RTN","MAGDQR03",155,0)
Q0081032 ;O  Procedure Code Sequence
"RTN","MAGDQR03",156,0)
 Q
"RTN","MAGDQR03",157,0)
 ;
"RTN","MAGDQR03",158,0)
Q0080100 ;O  >Code Value
"RTN","MAGDQR03",159,0)
 S X=$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",2) ; IA # 1172
"RTN","MAGDQR03",160,0)
 S X=$P($G(^RAMIS(71,+X,0)),"^",9) ; IA # 1174
"RTN","MAGDQR03",161,0)
 S X=$$CPT^ICPTCOD(+X) ; IA # 1995, supported reference
"RTN","MAGDQR03",162,0)
 S V("0008,1030",1,T)=$P(X,"^",2)
"RTN","MAGDQR03",163,0)
 Q
"RTN","MAGDQR03",164,0)
 ;
"RTN","MAGDQR03",165,0)
Q0080102 ;O  >Coding Scheme Designator
"RTN","MAGDQR03",166,0)
 S V("0008,1030",1,T)="C4"
"RTN","MAGDQR03",167,0)
 Q
"RTN","MAGDQR03",168,0)
 ;
"RTN","MAGDQR03",169,0)
Q0080103 ;O  >Coding Scheme Version
"RTN","MAGDQR03",170,0)
 S V("0008,1030",1,T)=4
"RTN","MAGDQR03",171,0)
 Q
"RTN","MAGDQR03",172,0)
 ;
"RTN","MAGDQR03",173,0)
Q0080104 ;O  >Code Meaning
"RTN","MAGDQR03",174,0)
 S X=$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",2) ; IA # 1172
"RTN","MAGDQR03",175,0)
 S X=$P($G(^RAMIS(71,+X,0)),"^",9) ; IA # 1174
"RTN","MAGDQR03",176,0)
 S X=$$CPT^ICPTCOD(+X) ; IA # 1995, supported reference
"RTN","MAGDQR03",177,0)
 S V("0008,1030",1,T)=$P(X,"^",3)
"RTN","MAGDQR03",178,0)
 Q
"RTN","MAGDQR03",179,0)
 ;
"RTN","MAGDQR03",180,0)
Q0081060 ;O  Name of Physician(s) Reading Study
"RTN","MAGDQR03",181,0)
 S X=$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",17) ; IA # 1172
"RTN","MAGDQR03",182,0)
 S X=$P($G(^RARPT(+X,0)),"^",9) ; IA # 1171
"RTN","MAGDQR03",183,0)
 S V(T)=$P($G(^VA(200,+X,0)),"^",1)
"RTN","MAGDQR03",184,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",185,0)
 Q
"RTN","MAGDQR03",186,0)
 ;
"RTN","MAGDQR03",187,0)
Q0081080 ;O  Admitting Diagnoses Description
"RTN","MAGDQR03",188,0)
 ; ? ? ?
"RTN","MAGDQR03",189,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",190,0)
 Q
"RTN","MAGDQR03",191,0)
 ;
"RTN","MAGDQR03",192,0)
Q0100021 ;O  Issuer of Patient ID
"RTN","MAGDQR03",193,0)
 S V(T)="USSSA"
"RTN","MAGDQR03",194,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",195,0)
 Q
"RTN","MAGDQR03",196,0)
 ;
"RTN","MAGDQR03",197,0)
Q0100030 ;O  Patient's Birth Date
"RTN","MAGDQR03",198,0)
 S V(T)=$P($G(^DPT(MAGD0,0)),"^",3)\1+17000000
"RTN","MAGDQR03",199,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",200,0)
 Q
"RTN","MAGDQR03",201,0)
 ;
"RTN","MAGDQR03",202,0)
Q0100032 ;O  Patient's Birth Time
"RTN","MAGDQR03",203,0)
 S V(T)=$TR($J("."_$P($P($G(^DPT(MAGD0,0)),"^",3),".",2)*1E6,6)," ",0)
"RTN","MAGDQR03",204,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",205,0)
 Q
"RTN","MAGDQR03",206,0)
 ;
"RTN","MAGDQR03",207,0)
Q0100040 ;O  Patient's Sex
"RTN","MAGDQR03",208,0)
 S V(T)=$P($G(^DPT(MAGD0,0)),"^",2)
"RTN","MAGDQR03",209,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",210,0)
 Q
"RTN","MAGDQR03",211,0)
 ;
"RTN","MAGDQR03",212,0)
Q0101000 ;O  Other Patient IDs
"RTN","MAGDQR03",213,0)
 N DFN,I,VA,VADPT
"RTN","MAGDQR03",214,0)
 S DFN=+MAGD0 D DEM^VADPT
"RTN","MAGDQR03",215,0)
 S X=$P(^DPT(DFN,0),"^",9) S:X'="" DFN(X)=""
"RTN","MAGDQR03",216,0)
 S:$G(VA("PID"))'="" DFN(VA("PID"))=""
"RTN","MAGDQR03",217,0)
 S:$G(VA("BID"))'="" DFN(VA("BID"))=""
"RTN","MAGDQR03",218,0)
 S X=$$GETICN^MPIF001(DFN) S:X'="" DFN(X)=""
"RTN","MAGDQR03",219,0)
 S I=0,X="" F  S X=$O(DFN(X)) Q:X=""  S I=I+1,V(T,I)=DFN(X)
"RTN","MAGDQR03",220,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",221,0)
 Q
"RTN","MAGDQR03",222,0)
 ;
"RTN","MAGDQR03",223,0)
Q0101001 ;O  Other Patient Names
"RTN","MAGDQR03",224,0)
 N D1,I
"RTN","MAGDQR03",225,0)
 S (I,D1)=0 F  S D1=$O(^DPT(MAGD0,0.01,D1)) Q:'D1  D
"RTN","MAGDQR03",226,0)
 . S X=$P($G(^DPT(MAGD0,0.01,D1,0)),"^",1)
"RTN","MAGDQR03",227,0)
 . S:X'="" I=I+1,V(T,I)=X
"RTN","MAGDQR03",228,0)
 . Q
"RTN","MAGDQR03",229,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",230,0)
 Q
"RTN","MAGDQR03",231,0)
 ;
"RTN","MAGDQR03",232,0)
Q0101010 ;O  Patient's Age
"RTN","MAGDQR03",233,0)
 N DD,DM,DY,WHEN
"RTN","MAGDQR03",234,0)
 S X=$P($G(^DPT(MAGD0,0)),"^",3)
"RTN","MAGDQR03",235,0)
 S WHEN=9999999.9999-MAGD1 ;;; select one of these two
"RTN","MAGDQR03",236,0)
 S WHEN=DT                 ;;; select one of these two
"RTN","MAGDQR03",237,0)
 S DY=$E(WHEN,1,3)-$E(X,1,3)
"RTN","MAGDQR03",238,0)
 S DM=$E(WHEN,4,5)-$E(X,4,5)
"RTN","MAGDQR03",239,0)
 S DD=$E(WHEN,6,7)-$E(X,6,7)
"RTN","MAGDQR03",240,0)
 S:DD<0 DM=DM-1 S:DM<0 DY=DY-1
"RTN","MAGDQR03",241,0)
 S V(T)=DY
"RTN","MAGDQR03",242,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",243,0)
 Q
"RTN","MAGDQR03",244,0)
 ;
"RTN","MAGDQR03",245,0)
Q0001020 ;O  Patient's Size
"RTN","MAGDQR03",246,0)
 S V(T)=$P($G(^DPT(MAGD0,57)),"^",1) ; height in cm - field not populated
"RTN","MAGDQR03",247,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",248,0)
 Q
"RTN","MAGDQR03",249,0)
 ;
"RTN","MAGDQR03",250,0)
Q0101030 ;O  Patient's Weight
"RTN","MAGDQR03",251,0)
 S V(T)=$P($G(^DPT(MAGD0,57)),"^",2) ; weight in kg - field not populated
"RTN","MAGDQR03",252,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",253,0)
 Q
"RTN","MAGDQR03",254,0)
 ;
"RTN","MAGDQR03",255,0)
Q0102160 ;O  Ethnic Group
"RTN","MAGDQR03",256,0)
 S V(T)=$P($G(^DPT(MAGD0,0)),"^",6)
"RTN","MAGDQR03",257,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",258,0)
 Q
"RTN","MAGDQR03",259,0)
 ;
"RTN","MAGDQR03",260,0)
Q0102180 ;O  Occupation
"RTN","MAGDQR03",261,0)
 S V(T)=$P($G(^DPT(MAGD0,0)),"^",7)
"RTN","MAGDQR03",262,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",263,0)
 Q
"RTN","MAGDQR03",264,0)
 ;
"RTN","MAGDQR03",265,0)
Q01021B0 ;O  Additional Patient History
"RTN","MAGDQR03",266,0)
 N D1,I
"RTN","MAGDQR03",267,0)
 S X=+$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",17) ; IA # 1172
"RTN","MAGDQR03",268,0)
 S (D1,I)=0 F  S D1=$O(^RARPT(X,"H",D1)) Q:'D1  D  ; IA # 1171
"RTN","MAGDQR03",269,0)
 . S I=I+1,V(T,I)=$G(^RARPT(X,"H",D1,0)) ; IA # 1171
"RTN","MAGDQR03",270,0)
 . Q
"RTN","MAGDQR03",271,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",272,0)
 Q
"RTN","MAGDQR03",273,0)
 ;
"RTN","MAGDQR03",274,0)
Q0104000 ;O  Patient Comments
"RTN","MAGDQR03",275,0)
 ; ? ? ?
"RTN","MAGDQR03",276,0)
 ; (there is a modality that passes the accession number in this field)
"RTN","MAGDQR03",277,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",278,0)
 Q
"RTN","MAGDQR03",279,0)
 ;
"RTN","MAGDQR03",280,0)
Q0201206 ;O  Number of Study Related Series
"RTN","MAGDQR03",281,0)
 N N,S,UID
"RTN","MAGDQR03",282,0)
 S UID=$G(V("0020,000D")),N=0
"RTN","MAGDQR03",283,0)
 I UID'=""  S S="" F  S S=$O(^MAG(2005,"P",UID,S)) Q:S=""  S N=N+1
"RTN","MAGDQR03",284,0)
 S V(T)=N
"RTN","MAGDQR03",285,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",286,0)
 Q
"RTN","MAGDQR03",287,0)
 ;
"RTN","MAGDQR03",288,0)
Q0201208 ;O  Number of Study Related Instances
"RTN","MAGDQR03",289,0)
 N N,P1,P2,S,UID
"RTN","MAGDQR03",290,0)
 S UID=$G(V("0020,000D")),N=0
"RTN","MAGDQR03",291,0)
 I UID'=""  S S="" F  S S=$O(^MAG(2005,"P",UID,S)) Q:S=""  D
"RTN","MAGDQR03",292,0)
 . S P1=0 F  S P1=$O(^MAG(2005,S,1,P1)) Q:'P1  D
"RTN","MAGDQR03",293,0)
 . . S P2=+$G(^MAG(2005,S,1,P1,0)) Q:'P2
"RTN","MAGDQR03",294,0)
 . . S N=N+1
"RTN","MAGDQR03",295,0)
 . . Q
"RTN","MAGDQR03",296,0)
 . Q
"RTN","MAGDQR03",297,0)
 S V(T)=N
"RTN","MAGDQR03",298,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",299,0)
 Q
"RTN","MAGDQR03",300,0)
 ;
"RTN","MAGDQR03",301,0)
U008010C ;O  Interpretation Author
"RTN","MAGDQR03",302,0)
 S X=+$P($G(^RADPT(MAGD0,"DT",MAGD1,"P",MAGD2,0)),"^",12) ; IA # 1172
"RTN","MAGDQR03",303,0)
 S V(T)=$P($G(^VA(200,X,0)),"^",1)
"RTN","MAGDQR03",304,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",305,0)
 Q
"RTN","MAGDQR03",306,0)
 ;
"RTN","MAGDQR04")
0^34^B52493648
"RTN","MAGDQR04",1,0)
MAGDQR04 ;WOIFO/EdM - Imaging RPCs for Query/Retrieve ; 05/16/2005  09:30
"RTN","MAGDQR04",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGDQR04",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR04",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR04",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR04",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR04",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR04",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR04",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR04",10,0)
 ;; |                                                               |
"RTN","MAGDQR04",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR04",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR04",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR04",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR04",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR04",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR04",17,0)
 ;;
"RTN","MAGDQR04",18,0)
 Q
"RTN","MAGDQR04",19,0)
 ;
"RTN","MAGDQR04",20,0)
TIM ; Overflow from MAGDQR02
"RTN","MAGDQR04",21,0)
 N SDT,V
"RTN","MAGDQR04",22,0)
 ; The references below to ^RADPT are permitted according to the
"RTN","MAGDQR04",23,0)
 ; existing Integration Agreement # 1172
"RTN","MAGDQR04",24,0)
 S V="" F  S V=$O(^RADPT("ADC",V)) Q:V=""  D
"RTN","MAGDQR04",25,0)
 . S MAGD0="" F  S MAGD0=$O(^RADPT("ADC",V,MAGD0)) Q:MAGD0=""  D
"RTN","MAGDQR04",26,0)
 . . S MAGD1="" F  S MAGD1=$O(^RADPT("ADC",V,MAGD0,MAGD1)) Q:MAGD1=""  D
"RTN","MAGDQR04",27,0)
 . . . S SDT=9999999.9999-MAGD1 Q:SDT<FD  Q:SDT>LD
"RTN","MAGDQR04",28,0)
 . . . S MAGD2="" F  S MAGD2=$O(^RADPT("ADC",V,MAGD0,MAGD1,MAGD2)) Q:MAGD2=""  D
"RTN","MAGDQR04",29,0)
 . . . . S ^TMP("MAG",$J,"QR",10,MAGD0_"^"_MAGD1_"^"_MAGD2)="",TIM=2
"RTN","MAGDQR04",30,0)
 . . . . S ANY=1,SID=1
"RTN","MAGDQR04",31,0)
 . . . . Q
"RTN","MAGDQR04",32,0)
 . . . Q
"RTN","MAGDQR04",33,0)
 . . Q
"RTN","MAGDQR04",34,0)
 . Q
"RTN","MAGDQR04",35,0)
 I TIM=1 D  Q
"RTN","MAGDQR04",36,0)
 . D ERR^MAGDQR01("No matches for tag 0008,0020 / 0008,0030")
"RTN","MAGDQR04",37,0)
 . D ERRSAV^MAGDQR01
"RTN","MAGDQR04",38,0)
 . Q
"RTN","MAGDQR04",39,0)
 ;
"RTN","MAGDQR04",40,0)
 Q
"RTN","MAGDQR04",41,0)
 ;
"RTN","MAGDQR04",42,0)
STUDY(OUT,UID) ; RPC = MAG STUDY UID QUERY
"RTN","MAGDQR04",43,0)
 N D1,F1,F2,F3,IMAGE,N,NET,PASS,SERIES,USER,X
"RTN","MAGDQR04",44,0)
 I $G(UID)="" S OUT(1)="-1,No UID specified." Q
"RTN","MAGDQR04",45,0)
 I UID'?1.64(1N,1".") S OUT(1)="-2,Invalid UID format: """_UID_"""." Q
"RTN","MAGDQR04",46,0)
 S N=1
"RTN","MAGDQR04",47,0)
 S SERIES="" F  S SERIES=$O(^MAG(2005,"P",UID,SERIES)) Q:SERIES=""  D
"RTN","MAGDQR04",48,0)
 . Q:$P($G(^MAG(2005,SERIES,0)),"^",10)
"RTN","MAGDQR04",49,0)
 . S D1=0 F  S D1=$O(^MAG(2005,SERIES,1,D1)) Q:'D1  D
"RTN","MAGDQR04",50,0)
 . . S IMAGE=+$G(^MAG(2005,SERIES,1,D1,0)) Q:'IMAGE
"RTN","MAGDQR04",51,0)
 . . S NET=$P($G(^MAG(2005,IMAGE,0)),"^",3),(USER,PASS)=""
"RTN","MAGDQR04",52,0)
 . . I NET S X=$G(^MAG(2005.2,NET,2)),USER=$P(X,"^",1),PASS=$P(X,"^",2)
"RTN","MAGDQR04",53,0)
 . . D FILEFIND^MAGDFB(IMAGE,"FULL",0,0,.F1,.F2,.F3)
"RTN","MAGDQR04",54,0)
 . . S N=N+1,OUT(N)=IMAGE_"^"_F2_"^"_USER_"^"_PASS
"RTN","MAGDQR04",55,0)
 . . Q
"RTN","MAGDQR04",56,0)
 . Q
"RTN","MAGDQR04",57,0)
 S X=" image" S:N'=2 X=X_"s" S X=X_" found"
"RTN","MAGDQR04",58,0)
 S OUT(1)=(N-1)_X
"RTN","MAGDQR04",59,0)
 Q
"RTN","MAGDQR04",60,0)
 ;
"RTN","MAGDQR04",61,0)
INFO(OUT,IMAGE) ; RPC = MAG IMAGE CURRENT INFO
"RTN","MAGDQR04",62,0)
 ;
"RTN","MAGDQR04",63,0)
 ; 0008,0020  Study Date
"RTN","MAGDQR04",64,0)
 ; 0008,0050  Accession Number
"RTN","MAGDQR04",65,0)
 ; 0008,0060  Modality
"RTN","MAGDQR04",66,0)
 ; 0008,0090  Referring Physician's Name
"RTN","MAGDQR04",67,0)
 ; 0008,1030  Study Description (may be VA procedure name)
"RTN","MAGDQR04",68,0)
 ; 0008,1050  Performing (attending) Physician
"RTN","MAGDQR04",69,0)
 ; 0010,0010  Patient Name
"RTN","MAGDQR04",70,0)
 ; 0010,0020  Patient ID
"RTN","MAGDQR04",71,0)
 ; 0010,0030  Patient's Birth Date
"RTN","MAGDQR04",72,0)
 ; 0010,0040  Patient's Sex
"RTN","MAGDQR04",73,0)
 ; 0010,1000  Other Patient IDs (= ICN, Integration Control Number)
"RTN","MAGDQR04",74,0)
 ; 0010,1040  Address
"RTN","MAGDQR04",75,0)
 ; 0010,2160  Ethnic Group
"RTN","MAGDQR04",76,0)
 ; 0010,2000  Medical Alerts
"RTN","MAGDQR04",77,0)
 ; 0020,000D  Study Instance UID
"RTN","MAGDQR04",78,0)
 ; 0032,1032  Requesting Physician
"RTN","MAGDQR04",79,0)
 ; 0032,1033  Requesting Service
"RTN","MAGDQR04",80,0)
 ; 0032,1060  Requested Procedure Description (CPT name)
"RTN","MAGDQR04",81,0)
 ; 0032,1064  Requested Procedure Code Sequence
"RTN","MAGDQR04",82,0)
 ; 0008,0100  > Code Value (CPT code)
"RTN","MAGDQR04",83,0)
 ; 0008,0102  > Coding Scheme Designator ("C4")
"RTN","MAGDQR04",84,0)
 ; 0008,0104  > Code Meaning (CPT name)
"RTN","MAGDQR04",85,0)
 ; 0038,0300  Current Patient Location (ward)
"RTN","MAGDQR04",86,0)
 ;
"RTN","MAGDQR04",87,0)
 N ACN,ATP,CPT,D0,D1,D2,D3,DFN,I,MO,N,P,REQP,RFP,RQL,T,TAG,UID,V,WRD,X
"RTN","MAGDQR04",88,0)
 I '$G(IMAGE) S OUT(1)="-1,No Image Specified." Q
"RTN","MAGDQR04",89,0)
 I '$D(^MAG(2005,IMAGE)) S OUT(1)="-2,No Such Image ("_IMAGE_")." Q
"RTN","MAGDQR04",90,0)
 ;
"RTN","MAGDQR04",91,0)
 S X=$G(^MAG(2005,IMAGE,0)),P=$P(X,"^",10)
"RTN","MAGDQR04",92,0)
 S TAG("0008,1030")=$P(X,"^",8) ; Procedure
"RTN","MAGDQR04",93,0)
 S DFN=$P(X,"^",7) D:DFN
"RTN","MAGDQR04",94,0)
 . ; The following references to ^DPT are allowed according to
"RTN","MAGDQR04",95,0)
 . ; PIMS V5.3 Technical Manual, Section II.
"RTN","MAGDQR04",96,0)
 . S TAG("0010,0010")=$P(^DPT(DFN,0),"^",1) ; Patient Name
"RTN","MAGDQR04",97,0)
 . S TAG("0010,0020")=$P(^DPT(DFN,0),"^",9) ; Patient ID (SSN)
"RTN","MAGDQR04",98,0)
 . S TAG("0010,0030")=$P(^DPT(DFN,0),"^",3)\1+17000000 ; Patient's Birth Date
"RTN","MAGDQR04",99,0)
 . S TAG("0010,0032")=$TR($J("."_$P($P(^DPT(DFN,0),"^",3),".",2)*1E6,6)," ",0) ; Patient's Birth Time [probably always blank]
"RTN","MAGDQR04",100,0)
 . S TAG("0010,2160")=$P(^DPT(DFN,0),"^",6) ; Patient's Race
"RTN","MAGDQR04",101,0)
 . S TAG("0010,0040")=$P(^DPT(DFN,0),"^",2) ; Patient's Sex
"RTN","MAGDQR04",102,0)
 . S X=$$GETICN^MPIF001(DFN)
"RTN","MAGDQR04",103,0)
 . S:X'="" TAG("0010,1000")=X ; Other Patient ID
"RTN","MAGDQR04",104,0)
 . S X=$G(^DPT(DFN,0.11)) D:X'=""
"RTN","MAGDQR04",105,0)
 . . S P=$P(X,"^",5) S:P V=$P($G(^DIC(5,+P,0)),"^",1) ; IA # 10056
"RTN","MAGDQR04",106,0)
 . . S:V'="" $P(X,"^",5)=V ; State
"RTN","MAGDQR04",107,0)
 . . S TAG("0010,1040")=$P(X,"^",1,6) ; Patient's Address
"RTN","MAGDQR04",108,0)
 . . Q
"RTN","MAGDQR04",109,0)
 . Q
"RTN","MAGDQR04",110,0)
 ;
"RTN","MAGDQR04",111,0)
 S UID=$S(P:$G(^MAG(2005,+P,"PACS")),1:$G(^MAG(2005,IMAGE,"PACS")))
"RTN","MAGDQR04",112,0)
 S TAG("0020,000D")=UID ; Study Instance UID
"RTN","MAGDQR04",113,0)
 ; The following references to ^RADPT are allowed according to IA # 1172
"RTN","MAGDQR04",114,0)
 S I=0
"RTN","MAGDQR04",115,0)
 I UID'="" S D0="" F  S D0=$O(^RADPT("ADC",UID,D0)) Q:D0=""  D
"RTN","MAGDQR04",116,0)
 . S D1="" F  S D1=$O(^RADPT("ADC",UID,D0,D1)) Q:D1=""  D
"RTN","MAGDQR04",117,0)
 . . N VAINDT
"RTN","MAGDQR04",118,0)
 . . S I=I+1,TAG("0008,0020",I)=9999999.9999-D1\1+17000000 ; Study Date
"RTN","MAGDQR04",119,0)
 . . S VAINDT=9999999.9999-D1 D INP^VADPT ; Supported reference
"RTN","MAGDQR04",120,0)
 . . S:$G(VAIN(2))'="" RFP(VAIN(2))="" ; Referring Physician's Name
"RTN","MAGDQR04",121,0)
 . . S:$G(VAIN(4))'="" RFP(VAIN(4))="" ; Current Ward
"RTN","MAGDQR04",122,0)
 . . S:$G(VAIN(11))'="" ATP(VAIN(11))="" ; Performing (attending) Physician
"RTN","MAGDQR04",123,0)
 . . S D2="" F  S D2=$O(^RADPT("ADC",UID,D0,D1,D2)) Q:D2=""  D
"RTN","MAGDQR04",124,0)
 . . . S X=$G(^RADPT(D0,"DT",D1,"P",D2,0))
"RTN","MAGDQR04",125,0)
 . . . S P=$P(X,"^",2) D:P
"RTN","MAGDQR04",126,0)
 . . . . S M1=0 F  S M1=$O(^RAMIS(71,+P,"MDL",M1)) Q:'M1  D  ; IA # 1174
"RTN","MAGDQR04",127,0)
 . . . . . S V=$P($G(^RAMIS(71,+P,"MDL",M1,0)),"^",1) S:V'="" MO(V)="" ; IA # 1174
"RTN","MAGDQR04",128,0)
 . . . . . Q
"RTN","MAGDQR04",129,0)
 . . . . S V=$P($G(^RAMIS(71,+P,0)),"^",9) S:V CPT(+V)="" ; IA # 1174
"RTN","MAGDQR04",130,0)
 . . . . Q
"RTN","MAGDQR04",131,0)
 . . . S P=$P(X,"^",14) D:P
"RTN","MAGDQR04",132,0)
 . . . . S V=$P($G(^VA(200,+P,0)),"^",1)
"RTN","MAGDQR04",133,0)
 . . . . S:V'="" REQP(V)=""
"RTN","MAGDQR04",134,0)
 . . . . Q
"RTN","MAGDQR04",135,0)
 . . . S P=$P(X,"^",17) D:P
"RTN","MAGDQR04",136,0)
 . . . . S X=$G(^RARPT(+P,0)) Q:X=""  ; IA # 1171
"RTN","MAGDQR04",137,0)
 . . . . S V=$P(X,"^",1) S:V'="" ACN(V)=""
"RTN","MAGDQR04",138,0)
 . . . . Q
"RTN","MAGDQR04",139,0)
 . . . S P=$P(X,"^",22) D:P
"RTN","MAGDQR04",140,0)
 . . . . S X=$G(^SC(+P,0)) Q:X=""  ; IA # 10040
"RTN","MAGDQR04",141,0)
 . . . . S V=$P(X,"^",1) S:V'="" RQL(V)=""
"RTN","MAGDQR04",142,0)
 . . . . Q
"RTN","MAGDQR04",143,0)
 . . . S P=0,D3=0 F  S D3=$O(^RADPT(D0,"P",D1,"DT",D2,"H",D3)) Q:'D3  D
"RTN","MAGDQR04",144,0)
 . . . . S X=$G(^RADPT(D0,"P",D1,"DT",D2,"H",D3,0)) Q:X=""
"RTN","MAGDQR04",145,0)
 . . . . S P=P+1,TAG("0010,2000  "_$J(P,5))=X
"RTN","MAGDQR04",146,0)
 . . . . Q
"RTN","MAGDQR04",147,0)
 . . . Q
"RTN","MAGDQR04",148,0)
 . . Q
"RTN","MAGDQR04",149,0)
 . Q
"RTN","MAGDQR04",150,0)
 S V="" F  S V=$O(ACN(V)) Q:V=""  D
"RTN","MAGDQR04",151,0)
 . S I=I+1,TAG("0008,0050",I)=ACN(V) ; Accession Number
"RTN","MAGDQR04",152,0)
 . Q
"RTN","MAGDQR04",153,0)
 S V="" F  S V=$O(WRD(V)) Q:V=""  D
"RTN","MAGDQR04",154,0)
 . S I=I+1,TAG("0038,0300",I)=$P(V,"^",2) ; Current Patient Location
"RTN","MAGDQR04",155,0)
 . Q
"RTN","MAGDQR04",156,0)
 S V="" F  S V=$O(RFP(V)) Q:V=""  D
"RTN","MAGDQR04",157,0)
 . S I=I+1,TAG("0008,0090",I)=$P(V,"^",2) ; Referring Physician's Name
"RTN","MAGDQR04",158,0)
 . Q
"RTN","MAGDQR04",159,0)
 S V="" F  S V=$O(ATP(V)) Q:V=""  D
"RTN","MAGDQR04",160,0)
 . S I=I+1,TAG("0008,1050",I)=$P(V,"^",2) ; Performing (attending) Physician
"RTN","MAGDQR04",161,0)
 . Q
"RTN","MAGDQR04",162,0)
 S V="" F  S V=$O(RQL(V)) Q:V=""  D
"RTN","MAGDQR04",163,0)
 . S I=I+1,TAG("0032,1033",I)=RQL(V) ; Requesting Service
"RTN","MAGDQR04",164,0)
 . Q
"RTN","MAGDQR04",165,0)
 S V="" F  S V=$O(MO(V)) Q:V=""  D
"RTN","MAGDQR04",166,0)
 . S I=I+1,TAG("0008,0060",I)=MO(V) ; Modality
"RTN","MAGDQR04",167,0)
 . Q
"RTN","MAGDQR04",168,0)
 S V="" F  S V=$O(REQP(V)) Q:V=""  D
"RTN","MAGDQR04",169,0)
 . S I=I+1,TAG("0032,1032",I)=REQP(V) ; Requesting Physician
"RTN","MAGDQR04",170,0)
 . Q
"RTN","MAGDQR04",171,0)
 S V="" F  S V=$O(CPT(V)) Q:V=""  D
"RTN","MAGDQR04",172,0)
 . S X=$$CPT^ICPTCOD(V) ; IA # 1995, supported reference
"RTN","MAGDQR04",173,0)
 . Q:$P(X,"^",2)=""
"RTN","MAGDQR04",174,0)
 . S I=I+1
"RTN","MAGDQR04",175,0)
 . S TAG("0031,1064 0008,0100",I)=$P(X,"^",2) ; CPT Code
"RTN","MAGDQR04",176,0)
 . S TAG("0031,1064 0008,0104",I)=$P(X,"^",3) ; Code Meaning
"RTN","MAGDQR04",177,0)
 . S TAG("0031,1060",I)=$P(X,"^",3) ; Requested Procedure Description
"RTN","MAGDQR04",178,0)
 . S TAG("0031,1064 0008,0102",I)="C4" ; Coding Scheme Designator
"RTN","MAGDQR04",179,0)
 . Q
"RTN","MAGDQR04",180,0)
 ;
"RTN","MAGDQR04",181,0)
 S N=1,T="" F  S T=$O(TAG(T)) Q:T=""  D
"RTN","MAGDQR04",182,0)
 . S V=""
"RTN","MAGDQR04",183,0)
 . S:$D(TAG(T))#2 V=TAG(T)
"RTN","MAGDQR04",184,0)
 . S I="" F  S I=$O(TAG(T,I)) Q:I=""  S:V'="" V=V_"\" S V=V_TAG(T,I)
"RTN","MAGDQR04",185,0)
 . S:V'="" N=N+1,OUT(N)=T_"^"_V
"RTN","MAGDQR04",186,0)
 . Q
"RTN","MAGDQR04",187,0)
 ;
"RTN","MAGDQR04",188,0)
 S OUT(1)=(N-1)_" data fields returned."
"RTN","MAGDQR04",189,0)
 Q
"RTN","MAGDQR04",190,0)
 ;
"RTN","MAGDQR04",191,0)
CLEAN(OUT) ; RPC = MAG DICOM QUERY CLEANUP
"RTN","MAGDQR04",192,0)
 N D0,H,N,STAMP
"RTN","MAGDQR04",193,0)
 L +^MAGDQR(2006.5732,0):1E6 ; Background task MUST wait
"RTN","MAGDQR04",194,0)
 S D0=0 F  S D0=$O(^MAGDQR(2006.5732,D0)) Q:'D0  D
"RTN","MAGDQR04",195,0)
 . S X=$G(^MAGDQR(2006.5732,D0,0)),STAMP=$P(X,"^",3)
"RTN","MAGDQR04",196,0)
 . Q:DT-STAMP<5
"RTN","MAGDQR04",197,0)
 . K ^MAGDQR(2006.5732,D0)
"RTN","MAGDQR04",198,0)
 . K ^MAGDQR(2006.5732,"B",D0)
"RTN","MAGDQR04",199,0)
 . Q
"RTN","MAGDQR04",200,0)
 S (D0,N,H)=0 F  S D0=$O(^MAGDQR(2006.5732,D0)) Q:'D0  S N=N+1,H=D0
"RTN","MAGDQR04",201,0)
 S X="DICOM QUERY RETRIEVE RESULT^2006.2006.5732^"_H_"^"_N
"RTN","MAGDQR04",202,0)
 S ^MAGDQR(2006.5732,0)=X
"RTN","MAGDQR04",203,0)
 L -^MAGDQR(2006.5732,0)
"RTN","MAGDQR04",204,0)
 Q
"RTN","MAGDQR04",205,0)
 ;
"RTN","MAGDRA2")
0^35^B25261561
"RTN","MAGDRA2",1,0)
MAGDRA2 ;WOIFO/LB -Routine for DICOM fix  [ 06/20/2001 08:56 ] ; 06/06/2005  09:28
"RTN","MAGDRA2",2,0)
 ;;3.0;IMAGING;**10,11,51**;26-August-2005
"RTN","MAGDRA2",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRA2",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRA2",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRA2",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRA2",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRA2",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRA2",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRA2",10,0)
 ;; |                                                               |
"RTN","MAGDRA2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRA2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRA2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRA2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRA2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRA2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRA2",17,0)
 ;;
"RTN","MAGDRA2",18,0)
 Q
"RTN","MAGDRA2",19,0)
 ; Routine to create the MAGDY variable needed by MAGDLB1 routine when
"RTN","MAGDRA2",20,0)
 ; manually correcting DICOM FIX files.
"RTN","MAGDRA2",21,0)
EN ;
"RTN","MAGDRA2",22,0)
 ; MAGDY variable to be created during this execution.
"RTN","MAGDRA2",23,0)
 N MAGBEG,MAGEND,MAGDFN,MAGOUT,MAGX,MAGXX,INFO,MAGNME,MAGSSN
"RTN","MAGDRA2",24,0)
 S MAGBEG=1070101,MAGEND=$$DT^XLFDT
"RTN","MAGDRA2",25,0)
READ ;
"RTN","MAGDRA2",26,0)
 S (MAGDFN,MAGX)=$$READ^MAGDRA3
"RTN","MAGDRA2",27,0)
 Q:MAGX="^"
"RTN","MAGDRA2",28,0)
 S MAGDFN=+MAGDFN
"RTN","MAGDRA2",29,0)
 I 'MAGDFN W !,"Entry not found, enter a ""^"" to quit." G READ
"RTN","MAGDRA2",30,0)
 ;
"RTN","MAGDRA2",31,0)
 I MAGX["~" G ONE  ;Lookup was on case number and successful
"RTN","MAGDRA2",32,0)
 S MAGXX=$$FIND1^DIC(70,"","","`"_MAGDFN)   ;Radiology patient
"RTN","MAGDRA2",33,0)
 ;
"RTN","MAGDRA2",34,0)
 I MAGDFN=MAGXX D
"RTN","MAGDRA2",35,0)
 . S INFO=$$PTINFO Q:$D(MAGERR)
"RTN","MAGDRA2",36,0)
 . S MAGNME=$P(INFO,"^"),MAGSSN=$P(INFO,"^",2)
"RTN","MAGDRA2",37,0)
 . K ^TMP($J,"RAE1")  ;Re-established by EN1^RA07PC1 -DBIA available
"RTN","MAGDRA2",38,0)
 . ; Set the beginning and ending date.
"RTN","MAGDRA2",39,0)
 . D EN1^RAO7PC1(MAGDFN,MAGBEG,MAGEND,500)
"RTN","MAGDRA2",40,0)
 . D:$D(^TMP($J,"RAE1")) LOOP^MAGDRA1
"RTN","MAGDRA2",41,0)
 . Q
"RTN","MAGDRA2",42,0)
 E  D  G:MAGX'="^" READ
"RTN","MAGDRA2",43,0)
 . W !,"No Radiology information found for the supplied answer.",$C(7)
"RTN","MAGDRA2",44,0)
 . Q
"RTN","MAGDRA2",45,0)
 Q
"RTN","MAGDRA2",46,0)
 ;
"RTN","MAGDRA2",47,0)
PTINFO() ;
"RTN","MAGDRA2",48,0)
 N INFO,MAGOUT
"RTN","MAGDRA2",49,0)
 I '$D(MAGDFN) Q ""
"RTN","MAGDRA2",50,0)
 D GETS^DIQ(2,MAGDFN,".01;.09","E","MAGOUT","MAGERR")
"RTN","MAGDRA2",51,0)
 I $D(MAGERR) Q ""
"RTN","MAGDRA2",52,0)
 I $D(MAGOUT) D  Q INFO
"RTN","MAGDRA2",53,0)
 . S INFO=$G(MAGOUT(2,MAGDFN_",",.01,"E"))
"RTN","MAGDRA2",54,0)
 . S INFO=INFO_"^"_$G(MAGOUT(2,MAGDFN_",",.09,"E"))
"RTN","MAGDRA2",55,0)
 . Q
"RTN","MAGDRA2",56,0)
 Q ""
"RTN","MAGDRA2",57,0)
 ;
"RTN","MAGDRA2",58,0)
LCASE(MAGDT,MAGCASE) ;
"RTN","MAGDRA2",59,0)
 Q $TR($TR($$FMTE^XLFDT(MAGDT,"2FD")," ","0"),"/","")_"-"_MAGCASE
"RTN","MAGDRA2",60,0)
 ;
"RTN","MAGDRA2",61,0)
IMG(MAGRPT) ;
"RTN","MAGDRA2",62,0)
 N INFO,MAGOUT,MAGERR
"RTN","MAGDRA2",63,0)
 I 'MAGRPT Q ""
"RTN","MAGDRA2",64,0)
 D GETS^DIQ(74,MAGRPT,"2005*","I","MAGOUT","MAGERR")
"RTN","MAGDRA2",65,0)
 I $D(MAGERR) Q ""
"RTN","MAGDRA2",66,0)
 I $D(MAGOUT(74.02005)) Q " i"
"RTN","MAGDRA2",67,0)
 Q ""
"RTN","MAGDRA2",68,0)
 ;
"RTN","MAGDRA2",69,0)
PROC(MAGPRC) ;
"RTN","MAGDRA2",70,0)
 Q $$FIND1^DIC(71,,"XB",MAGPRC)
"RTN","MAGDRA2",71,0)
 ;
"RTN","MAGDRA2",72,0)
ONE ;
"RTN","MAGDRA2",73,0)
 ;MAGDFN,MAGX variables expected from EN
"RTN","MAGDRA2",74,0)
 I 'MAGDFN,'+MAGX Q
"RTN","MAGDRA2",75,0)
 N BEG,CASE,CDATE,CS,DATA,END,FLDS,INFO,MAGCASE,MAGCNI,MAGDATE,MAGDTI
"RTN","MAGDRA2",76,0)
 N MAGEXST,MAGLOC,MAGNME,MAGOUT,MAGPIEN,MAGPRC,MAGPSET,MAGPST,MAGRPT
"RTN","MAGDRA2",77,0)
 N PP,PSET,RAENTRY,RAMEMLOW,RAPRTSET,RIEN,STAT,X,X1,X2,XX
"RTN","MAGDRA2",78,0)
 N RARPT,RADFN,RADTI,RACNI ;<--Variables needed for EN1^RAUTL20
"RTN","MAGDRA2",79,0)
 ; RAUTL20 used to retrieve if case is part of a print set.
"RTN","MAGDRA2",80,0)
 S MAGDFN=$P(MAGX,"~"),INFO=$$PTINFO
"RTN","MAGDRA2",81,0)
 S MAGNME=$P(INFO,"^"),MAGSSN=$P(INFO,"^",2)
"RTN","MAGDRA2",82,0)
 S RIEN=$P(MAGX,"~",2)_","_$P(MAGX,"~",1)
"RTN","MAGDRA2",83,0)
 S X1=9999999.9999-$P(MAGX,"~",2),X2=+2 D C^%DTC
"RTN","MAGDRA2",84,0)
 S END=X,BEG=9999999.9999-$P(MAGX,"~",2)
"RTN","MAGDRA2",85,0)
 K ^TMP($J,"RAE1")
"RTN","MAGDRA2",86,0)
 D EN1^RAO7PC1(MAGDFN,BEG,END,20)
"RTN","MAGDRA2",87,0)
 S RAENTRY=$P(MAGX,"~",2)_"-"_$P(MAGX,"~",3)
"RTN","MAGDRA2",88,0)
 Q:'$D(^TMP($J,"RAE1"))
"RTN","MAGDRA2",89,0)
 Q:'$D(^TMP($J,"RAE1",MAGDFN,RAENTRY))
"RTN","MAGDRA2",90,0)
 S DATA=^TMP($J,"RAE1",MAGDFN,RAENTRY)
"RTN","MAGDRA2",91,0)
 S MAGDATE=$P(RAENTRY,"-"),CDATE=9999999.9999-MAGDATE
"RTN","MAGDRA2",92,0)
 S MAGDATE=$TR($$FMTE^XLFDT(CDATE,"2FD")," ","0")
"RTN","MAGDRA2",93,0)
 S MAGPRC=$P(DATA,"^"),CASE=$P(DATA,"^",2),STAT=$P(DATA,"^",6)
"RTN","MAGDRA2",94,0)
 S MAGEXST=$P(STAT,"~",2),MAGLOC=$P(DATA,"^",7)
"RTN","MAGDRA2",95,0)
 S (MAGRPT,RARPT)=$P(DATA,"^",5)
"RTN","MAGDRA2",96,0)
 S (MAGDTI,RADTI)=$P(RAENTRY,"-")
"RTN","MAGDRA2",97,0)
 S (MAGCNI,RACNI)=$P(RAENTRY,"-",2),RADFN=MAGDFN
"RTN","MAGDRA2",98,0)
 S MAGCASE=$$LCASE(CDATE,CASE),MAGPIEN=$$PROC(MAGPRC)
"RTN","MAGDRA2",99,0)
 ; RADTI, RADFN, RACNI variables needed for EN1^RAULT20
"RTN","MAGDRA2",100,0)
 D EN1^RAUTL20
"RTN","MAGDRA2",101,0)
 S (PSET,MAGPSET)=""
"RTN","MAGDRA2",102,0)
 S PSET=$S(RAMEMLOW:"+",RAPRTSET:".",1:"")
"RTN","MAGDRA2",103,0)
 I PSET=".",RACNI>1 D
"RTN","MAGDRA2",104,0)
 . N OLDENTRY S OLDENTRY=$P(RAENTRY,"-")_"-"
"RTN","MAGDRA2",105,0)
 . S OLDENTRY=$O(^TMP($J,"RAE1",MAGDFN,OLDENTRY)) I $L(OLDENTRY) D
"RTN","MAGDRA2",106,0)
 . . S MAGCASE=$P(^TMP($J,"RAE1",MAGDFN,OLDENTRY),"^",2)
"RTN","MAGDRA2",107,0)
 . . S CDATE=$P(RAENTRY,"-")
"RTN","MAGDRA2",108,0)
 . . S CDATE=9999999.9999-CDATE
"RTN","MAGDRA2",109,0)
 . . S MAGCASE=$$LCASE^MAGDRA2(CDATE,MAGCASE),RACNI=$P(OLDENTRY,"-",2)
"RTN","MAGDRA2",110,0)
 . . S MAGPST=CASE_" is part of this printset."
"RTN","MAGDRA2",111,0)
 . . Q
"RTN","MAGDRA2",112,0)
 . Q
"RTN","MAGDRA2",113,0)
 I $D(RAPRTSET) S PP=$S(MAGCNI>1:".",MAGCNI=1:"+",1:"")
"RTN","MAGDRA2",114,0)
 S MAGCNI=RACNI
"RTN","MAGDRA2",115,0)
 W !,"PATIENT: ",MAGNME,?51,"SSN: ",MAGSSN
"RTN","MAGDRA2",116,0)
 W !,"Case No.",?15,"Procedure",?42,"Location",?64,"Exam Date"
"RTN","MAGDRA2",117,0)
 W !,"________",?15,"_________",?42,"________________",?64,"________"
"RTN","MAGDRA2",118,0)
 W !,$G(PP),CASE,$$IMG(MAGRPT),?15,MAGPRC,?42,MAGLOC,?64,MAGDATE
"RTN","MAGDRA2",119,0)
 W !,"Exam status: ",MAGEXST," "," ",$G(MAGPST)
"RTN","MAGDRA2",120,0)
 D MAGDY
"RTN","MAGDRA2",121,0)
 Q
"RTN","MAGDRA2",122,0)
 ;
"RTN","MAGDRA2",123,0)
MAGDY ;
"RTN","MAGDRA2",124,0)
 S MAGDY=MAGDFN_"^"_MAGNME_"^"_MAGSSN_"^"_MAGCASE_"^"_MAGPRC_"^"_MAGDTI
"RTN","MAGDRA2",125,0)
 S MAGDY=MAGDY_"^"_MAGCNI_"^"_MAGPIEN_"^"_$G(MAGPST)_"^"
"RTN","MAGDRA2",126,0)
 K MAGNME,MAGSSN,MAGCASE,MAGPRC,MAGDTI,MAGCNI,MAGPIEN,MAPST
"RTN","MAGDRA2",127,0)
 Q
"RTN","MAGDRCU2")
0^36^B38123577
"RTN","MAGDRCU2",1,0)
MAGDRCU2 ;WOIFO/PMK - List entries in ^MAG(2006.5839) ; 06/06/2005  09:29
"RTN","MAGDRCU2",2,0)
 ;;3.0;IMAGING;**10,11,51**;26-August-2005
"RTN","MAGDRCU2",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRCU2",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRCU2",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRCU2",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRCU2",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRCU2",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRCU2",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRCU2",10,0)
 ;; |                                                               |
"RTN","MAGDRCU2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRCU2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRCU2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRCU2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRCU2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRCU2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRCU2",17,0)
 ;;
"RTN","MAGDRCU2",18,0)
 ; This routine lists the entries in the temporary Imaging/CPRS Consult
"RTN","MAGDRCU2",19,0)
 ; Request Tracking association file
"RTN","MAGDRCU2",20,0)
 ;
"RTN","MAGDRCU2",21,0)
 ;
"RTN","MAGDRCU2",22,0)
 ;     XXXX                                         XXX       X
"RTN","MAGDRCU2",23,0)
 ;    XX  XX                                         XX      XX
"RTN","MAGDRCU2",24,0)
 ;   XX         XXXX    XX XXX  XXXXXXX  XX  XXX     XX     XXXXX
"RTN","MAGDRCU2",25,0)
 ;   XX        XX  XX   XXX XX  XX       XX  XX      XX      XX
"RTN","MAGDRCU2",26,0)
 ;   XX    X   XX  XX   XX  XX  XXXXXXX  XX  XX      XX      XX
"RTN","MAGDRCU2",27,0)
 ;    XX  XX   XX  XX   XX  XX       XX  XX  XX      XX      XX XX
"RTN","MAGDRCU2",28,0)
 ;     XXXX     XXXX    XX  XX  XXXXXXX   XXX XX    XXXX      XXX
"RTN","MAGDRCU2",29,0)
 ;
"RTN","MAGDRCU2",30,0)
 ;
"RTN","MAGDRCU2",31,0)
 ; Routine 2/2 in for application
"RTN","MAGDRCU2",32,0)
 ;
"RTN","MAGDRCU2",33,0)
REPORT ; now scan the database and generate the report
"RTN","MAGDRCU2",34,0)
 N D0,DATE,DFN,DOB,EXAMDATE,GMRCDFN,GMRCIEN,I,LASTDFN,LASTEXAM
"RTN","MAGDRCU2",35,0)
 N MAGIEN,MAGIEN1,NOW,ORDRDATE,PAGE,PID,PNAME,REQTYPE
"RTN","MAGDRCU2",36,0)
 N SEX,STATUS,STOP,VA,VAERR,VADM,WRK,X,Y,Z
"RTN","MAGDRCU2",37,0)
 ;
"RTN","MAGDRCU2",38,0)
 S WRK=$NA(^TMP("MAG",$J,"GMRC"))
"RTN","MAGDRCU2",39,0)
 D NOW^%DTC,YX^%DTC S NOW=Y
"RTN","MAGDRCU2",40,0)
 K @WRK
"RTN","MAGDRCU2",41,0)
 ;
"RTN","MAGDRCU2",42,0)
 S D0=0
"RTN","MAGDRCU2",43,0)
 I $E(IOST)="C" W !,"Building"
"RTN","MAGDRCU2",44,0)
 F  S D0=$O(^MAG(2006.5839,D0)) Q:'D0  S X=^(D0,0) D
"RTN","MAGDRCU2",45,0)
 . I $P(X,"^",1)'="123" D
"RTN","MAGDRCU2",46,0)
 . . N MSG
"RTN","MAGDRCU2",47,0)
 . . S MSG(1)="Problem with Temporary Imaging/CPRS file"
"RTN","MAGDRCU2",48,0)
 . . S MSG(2)="Entry #"_D0_" in ^MAG(2006.5839) does not begin"
"RTN","MAGDRCU2",49,0)
 . . S MSG(3)="with 123 - it doesn't point to CPRS Consult Request Tracking"
"RTN","MAGDRCU2",50,0)
 . . S MSG(4)="Bad record: <<"_X_">>"
"RTN","MAGDRCU2",51,0)
 . . D ERROR(.MSG)
"RTN","MAGDRCU2",52,0)
 . . Q
"RTN","MAGDRCU2",53,0)
 . E  D
"RTN","MAGDRCU2",54,0)
 . . S GMRCIEN=$P(X,"^",2),MAGIEN=$P(X,"^",3)
"RTN","MAGDRCU2",55,0)
 . . S DFN=$P(^MAG(2005,MAGIEN,0),"^",7)
"RTN","MAGDRCU2",56,0)
 . . S GMRCDFN=$$GET1^DIQ(123,GMRCIEN,.02,"I")
"RTN","MAGDRCU2",57,0)
 . . I DFN'=GMRCDFN D
"RTN","MAGDRCU2",58,0)
 . . . N MSG
"RTN","MAGDRCU2",59,0)
 . . . S MSG(1)="DICOM IMAGE PROCESSING ERROR - CONSULT/IMAGING PATIENT MISMATCH"
"RTN","MAGDRCU2",60,0)
 . . . S MSG(2)="The image and the consult point to different patients."
"RTN","MAGDRCU2",61,0)
 . . . S MSG(3)=""
"RTN","MAGDRCU2",62,0)
 . . . S MSG(4)="The Image points to PATIENT file internal entry number "_DFN
"RTN","MAGDRCU2",63,0)
 . . . S MSG(5)=$$PATDEMO^MAGDIRVE(DFN)
"RTN","MAGDRCU2",64,0)
 . . . S MSG(6)=""
"RTN","MAGDRCU2",65,0)
 . . . S MSG(7)="The Consult points to PATIENT file internal entry number "_GMRCDFN
"RTN","MAGDRCU2",66,0)
 . . . S MSG(8)=$$PATDEMO^MAGDIRVE(GMRCDFN)
"RTN","MAGDRCU2",67,0)
 . . . S MSG(9)=""
"RTN","MAGDRCU2",68,0)
 . . . D ERROR(.MSG)
"RTN","MAGDRCU2",69,0)
 . . . Q
"RTN","MAGDRCU2",70,0)
 . . E  D
"RTN","MAGDRCU2",71,0)
 . . . ; check that this is a service of interest
"RTN","MAGDRCU2",72,0)
 . . . S SERVICE=$$GET1^DIQ(123,GMRCIEN,1,"I")
"RTN","MAGDRCU2",73,0)
 . . . I '$D(SERVICE("S",SERVICE)) Q
"RTN","MAGDRCU2",74,0)
 . . . ; check cutoff date
"RTN","MAGDRCU2",75,0)
 . . . S I=$O(^MAG(2005,MAGIEN,1,0)),MAGIEN1=$P(^(I,0),"^",1)
"RTN","MAGDRCU2",76,0)
 . . . S EXAMDATE=$P(^MAG(2005,MAGIEN1,2),"^",1) I EXAMDATE>CUTOFF Q
"RTN","MAGDRCU2",77,0)
 . . . S ORDRDATE=$$GET1^DIQ(123,GMRCIEN,.01)
"RTN","MAGDRCU2",78,0)
 . . . S ORDRDATE=$P(ORDRDATE,",",1)_","_$E($P(ORDRDATE,",",2),4,5)
"RTN","MAGDRCU2",79,0)
 . . . S STATUS=$$GET1^DIQ(123,GMRCIEN,8,"I")
"RTN","MAGDRCU2",80,0)
 . . . I '$D(STATUS(STATUS)) D
"RTN","MAGDRCU2",81,0)
 . . . . S STATUS(STATUS)=$$GET1^DIQ(100.01,STATUS,.1)
"RTN","MAGDRCU2",82,0)
 . . . . Q
"RTN","MAGDRCU2",83,0)
 . . . S REQTYPE=$$GET1^DIQ(123,GMRCIEN,13,"I")
"RTN","MAGDRCU2",84,0)
 . . . D DEM^VADPT
"RTN","MAGDRCU2",85,0)
 . . . S PNAME=VADM(1),PID=VA("PID")
"RTN","MAGDRCU2",86,0)
 . . . S DOB=$P(VADM(3),"^",2),SEX=$P(VADM(5),"^",2)
"RTN","MAGDRCU2",87,0)
 . . . S (I,@WRK@(0))=$G(@WRK@(0))+1
"RTN","MAGDRCU2",88,0)
 . . . S Z=DFN_"^"_PNAME_"^"_PID_"^"_SEX_"^"_DOB
"RTN","MAGDRCU2",89,0)
 . . . S Z=Z_"^"_GMRCIEN_"^"_SERVICE_"^"_ORDRDATE_"^"_STATUS
"RTN","MAGDRCU2",90,0)
 . . . S Z=Z_"^"_REQTYPE_"^"_EXAMDATE
"RTN","MAGDRCU2",91,0)
 . . . S @WRK@(I)=Z
"RTN","MAGDRCU2",92,0)
 . . . S @WRK@("P",PNAME,DFN,I)=""
"RTN","MAGDRCU2",93,0)
 . . . S @WRK@("D",EXAMDATE\1,PNAME,DFN,I)=""
"RTN","MAGDRCU2",94,0)
 . . . I $E(IOST)="C" W:$X>79 ! W "."
"RTN","MAGDRCU2",95,0)
 . . . Q
"RTN","MAGDRCU2",96,0)
 . . Q
"RTN","MAGDRCU2",97,0)
 . Q
"RTN","MAGDRCU2",98,0)
 ;
"RTN","MAGDRCU2",99,0)
 ; output the report
"RTN","MAGDRCU2",100,0)
 ;
"RTN","MAGDRCU2",101,0)
 U IO D HEADING
"RTN","MAGDRCU2",102,0)
 S STOP=0
"RTN","MAGDRCU2",103,0)
 ;
"RTN","MAGDRCU2",104,0)
 I "Dd"[SORT D  ; output sorted by examination date
"RTN","MAGDRCU2",105,0)
 . S DATE="" F  S DATE=$O(@WRK@("D",DATE)) Q:DATE=""!STOP  D
"RTN","MAGDRCU2",106,0)
 . . D NEWLINE(5)
"RTN","MAGDRCU2",107,0)
 . . K LASTDFN ; force output of name
"RTN","MAGDRCU2",108,0)
 . . S PNAME="" F  S PNAME=$O(@WRK@("D",DATE,PNAME)) Q:PNAME=""!STOP  D
"RTN","MAGDRCU2",109,0)
 . . . S DFN="" F  S DFN=$O(@WRK@("D",DATE,PNAME,DFN)) Q:DFN=""!STOP  D
"RTN","MAGDRCU2",110,0)
 . . . . S I="" F  S I=$O(@WRK@("D",DATE,PNAME,DFN,I)) Q:I=""!STOP  D
"RTN","MAGDRCU2",111,0)
 . . . . . D ONELINE
"RTN","MAGDRCU2",112,0)
 . . . . . Q
"RTN","MAGDRCU2",113,0)
 . . . . Q
"RTN","MAGDRCU2",114,0)
 . . . Q
"RTN","MAGDRCU2",115,0)
 . . Q
"RTN","MAGDRCU2",116,0)
 . Q
"RTN","MAGDRCU2",117,0)
 ;
"RTN","MAGDRCU2",118,0)
 E  D  ; output sorted by name
"RTN","MAGDRCU2",119,0)
 . S PNAME="" F  S PNAME=$O(@WRK@("P",PNAME)) Q:PNAME=""!STOP  D
"RTN","MAGDRCU2",120,0)
 . . S DFN="" F  S DFN=$O(@WRK@("P",PNAME,DFN)) Q:DFN=""!STOP  D
"RTN","MAGDRCU2",121,0)
 . . . S I="" F  S I=$O(@WRK@("P",PNAME,DFN,I)) Q:I=""!STOP  D
"RTN","MAGDRCU2",122,0)
 . . . . K LASTEXAM ; force output of examination date
"RTN","MAGDRCU2",123,0)
 . . . . D ONELINE
"RTN","MAGDRCU2",124,0)
 . . . . Q
"RTN","MAGDRCU2",125,0)
 . . . Q
"RTN","MAGDRCU2",126,0)
 . . Q
"RTN","MAGDRCU2",127,0)
 . Q
"RTN","MAGDRCU2",128,0)
 ;
"RTN","MAGDRCU2",129,0)
 D ^%ZISC I $D(ZTQUEUED) S ZTREQ="@" ; standard kernel exit
"RTN","MAGDRCU2",130,0)
 K @WRK
"RTN","MAGDRCU2",131,0)
 Q
"RTN","MAGDRCU2",132,0)
 ;
"RTN","MAGDRCU2",133,0)
ONELINE ; output one line of the report
"RTN","MAGDRCU2",134,0)
 S X=@WRK@(I)
"RTN","MAGDRCU2",135,0)
 I DFN'=$G(LASTDFN) D
"RTN","MAGDRCU2",136,0)
 . S PID=$P(X,"^",3),SEX=$P(X,"^",4),DOB=$P(X,"^",5)
"RTN","MAGDRCU2",137,0)
 . D NEWLINE(4),NEWLINE(3)
"RTN","MAGDRCU2",138,0)
 . W PNAME,"   ",PID,"   (",SEX,")   ",DOB
"RTN","MAGDRCU2",139,0)
 . S LASTDFN=DFN
"RTN","MAGDRCU2",140,0)
 . Q
"RTN","MAGDRCU2",141,0)
 S GMRCIEN=$P(X,"^",6),SERVICE=$P(X,"^",7),ORDRDATE=$P(X,"^",8)
"RTN","MAGDRCU2",142,0)
 S STATUS=$P(X,"^",9),REQTYPE=$P(X,"^",10),EXAMDATE=$P(X,"^",11)
"RTN","MAGDRCU2",143,0)
 S REQTYPE=$S(REQTYPE="C":"Consult",REQTYPE="P":"Procedure",1:"Unknown")
"RTN","MAGDRCU2",144,0)
 D NEWLINE(1)
"RTN","MAGDRCU2",145,0)
 W "  ",ORDRDATE," (",STATUS(STATUS),") ",$E(SERVICE("S",SERVICE),1,30)
"RTN","MAGDRCU2",146,0)
 W "  ",REQTYPE," #",GMRCIEN
"RTN","MAGDRCU2",147,0)
 S Y=EXAMDATE D DD^%DT S EXAMDATE=$P(Y,",",1)_","_$E($P(Y,",",2),4,5)
"RTN","MAGDRCU2",148,0)
 I EXAMDATE'=$G(LASTEXAM) D
"RTN","MAGDRCU2",149,0)
 . W ?65,"Exam: ",EXAMDATE
"RTN","MAGDRCU2",150,0)
 . S LASTEXAM=EXAMDATE
"RTN","MAGDRCU2",151,0)
 . Q
"RTN","MAGDRCU2",152,0)
 Q
"RTN","MAGDRCU2",153,0)
 ;
"RTN","MAGDRCU2",154,0)
NEWLINE(J) ; output a <cr> <lf> with scrolling control or pagination
"RTN","MAGDRCU2",155,0)
 N I
"RTN","MAGDRCU2",156,0)
 W !
"RTN","MAGDRCU2",157,0)
 I $Y<(IOSL-J) Q  ; nothing else to do
"RTN","MAGDRCU2",158,0)
 I $E(IOST)="C" D  ; scrolling for a crt
"RTN","MAGDRCU2",159,0)
 . N I,X
"RTN","MAGDRCU2",160,0)
 . W "more..." R X:DTIME F I=1:1:$X W $C(8,32,8)
"RTN","MAGDRCU2",161,0)
 . S $Y=0 Q:X=""
"RTN","MAGDRCU2",162,0)
 . S:$TR(X,"quitexnQUITEXN","^^^^^^^^^^^^^^")["^" STOP=1
"RTN","MAGDRCU2",163,0)
 . Q
"RTN","MAGDRCU2",164,0)
 E  D  ; pagination for a file or a printer
"RTN","MAGDRCU2",165,0)
 . F Y=$Y:1:(IOSL-1) W !
"RTN","MAGDRCU2",166,0)
 . S PAGE=$G(PAGE)+1 W ?IOM-10,"Page ",PAGE,!
"RTN","MAGDRCU2",167,0)
 . D HEADING
"RTN","MAGDRCU2",168,0)
 . Q
"RTN","MAGDRCU2",169,0)
 Q
"RTN","MAGDRCU2",170,0)
 ;
"RTN","MAGDRCU2",171,0)
HEADING ; print heading
"RTN","MAGDRCU2",172,0)
 W @IOF,TITLE,?IOM-$L(NOW),NOW,!
"RTN","MAGDRCU2",173,0)
 I ($L(SUBTITLE(1))+$L(SUBTITLE(2)))<(IOM-4) D
"RTN","MAGDRCU2",174,0)
 . W SUBTITLE(1)," -- ",SUBTITLE(2)
"RTN","MAGDRCU2",175,0)
 . Q
"RTN","MAGDRCU2",176,0)
 E  D
"RTN","MAGDRCU2",177,0)
 . W SUBTITLE(1),!,SUBTITLE(2)
"RTN","MAGDRCU2",178,0)
 . Q
"RTN","MAGDRCU2",179,0)
 W !
"RTN","MAGDRCU2",180,0)
 Q
"RTN","MAGDRCU2",181,0)
 ;
"RTN","MAGDRCU2",182,0)
ERROR(MSG) ; Error Message
"RTN","MAGDRCU2",183,0)
 N I
"RTN","MAGDRCU2",184,0)
 W ! F I=1:1:80 W "*"
"RTN","MAGDRCU2",185,0)
 F I=1:1 Q:'$D(MSG(I))  W !,"*** ",MSG(I),?76," ***"
"RTN","MAGDRCU2",186,0)
 W ! F I=1:1:80 W "*"
"RTN","MAGDRCU2",187,0)
 Q
"RTN","MAGDRPC1")
0^37^B59309742
"RTN","MAGDRPC1",1,0)
MAGDRPC1 ;WOIFO/EdM - Imaging RPCs ; 06/06/2005  09:31
"RTN","MAGDRPC1",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDRPC1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC1",10,0)
 ;; |                                                               |
"RTN","MAGDRPC1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC1",17,0)
 ;;
"RTN","MAGDRPC1",18,0)
 Q
"RTN","MAGDRPC1",19,0)
 ;
"RTN","MAGDRPC1",20,0)
 ;
"RTN","MAGDRPC1",21,0)
CHECKID(OUT,ID,HOSTNAME) ; RPC = MAG DICOM CHECK MACHINE ID
"RTN","MAGDRPC1",22,0)
 N D0,H0,I0,N,NH,NI,S,X
"RTN","MAGDRPC1",23,0)
 S OUT=0,ID=$GET(ID)
"RTN","MAGDRPC1",24,0)
 I $G(HOSTNAME)="" S OUT="-1,No Hostname Specified" Q
"RTN","MAGDRPC1",25,0)
 I ID'?1U S OUT="-2,No valid ID specified ("""_ID_""")" Q
"RTN","MAGDRPC1",26,0)
 S (NH,NI)=0
"RTN","MAGDRPC1",27,0)
 S D0="" F  S D0=$O(^MAGDICOM(2006.5641,"B",ID,D0)) Q:D0=""  S NI=NI+1,I0=D0
"RTN","MAGDRPC1",28,0)
 S D0="" F  S D0=$O(^MAGDICOM(2006.5641,"C",HOSTNAME,D0)) Q:D0=""  S NH=NH+1,H0=D0
"RTN","MAGDRPC1",29,0)
 I NH=1,NI=1,I0=H0 S OUT=1 Q  ; This ID belongs to this hostname
"RTN","MAGDRPC1",30,0)
 I 'NI S OUT=1 Q  ; This ID is still unused
"RTN","MAGDRPC1",31,0)
 S OUT="-1,Machine ID """_ID_""" is already used by",S=" "
"RTN","MAGDRPC1",32,0)
 S D0="" F  S D0=$O(^MAGDICOM(2006.5641,"B",ID,D0)) Q:D0=""  D
"RTN","MAGDRPC1",33,0)
 . I S=", ",$O(^MAGDICOM(2006.5641,"B",ID,D0))="" S S=" and "
"RTN","MAGDRPC1",34,0)
 . S X=$P($G(^MAGDICOM(2006.5641,D0,0)),"^",2)
"RTN","MAGDRPC1",35,0)
 . S OUT=OUT_S_""""_X_"""",S=", "
"RTN","MAGDRPC1",36,0)
 . Q
"RTN","MAGDRPC1",37,0)
 S OUT=OUT_"."
"RTN","MAGDRPC1",38,0)
 Q
"RTN","MAGDRPC1",39,0)
 ;
"RTN","MAGDRPC1",40,0)
UPDTID(OUT,ID,HOSTNAME) ; RPC = MAG DICOM UPDATE MACHINE  ID
"RTN","MAGDRPC1",41,0)
 N D0,I,N,X
"RTN","MAGDRPC1",42,0)
 I $G(HOSTNAME)="" S OUT="-1,No Hostname Specified" Q
"RTN","MAGDRPC1",43,0)
 I $G(ID)'?1U S OUT="-2,No valid ID specified ("""_$G(ID)_""")" Q
"RTN","MAGDRPC1",44,0)
 L +^MAGDICOM(2006.5641,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC1",45,0)
 S N=0,D0="" F  S D0=$O(^MAGDICOM(2006.5641,"C",HOSTNAME,D0)) Q:D0=""  D
"RTN","MAGDRPC1",46,0)
 . S X=$G(^MAGDICOM(2006.5641,D0,0)),N=N+1
"RTN","MAGDRPC1",47,0)
 . D:N=1
"RTN","MAGDRPC1",48,0)
 . . S I=$P(X,"^",1) I I'="" K ^MAGDICOM(2006.5641,"B",I,D0)
"RTN","MAGDRPC1",49,0)
 . . S $P(X,"^",1)=ID,$P(X,"^",2)=HOSTNAME,$P(X,"^",3)=$H
"RTN","MAGDRPC1",50,0)
 . . S ^MAGDICOM(2006.5641,D0,0)=X
"RTN","MAGDRPC1",51,0)
 . . S ^MAGDICOM(2006.5641,"B",ID,D0)=""
"RTN","MAGDRPC1",52,0)
 . . S ^MAGDICOM(2006.5641,"C",HOSTNAME,D0)=""
"RTN","MAGDRPC1",53,0)
 . . Q
"RTN","MAGDRPC1",54,0)
 . D:N>1
"RTN","MAGDRPC1",55,0)
 . . S I=$P(X,"^",1) I I'="" K ^MAGDICOM(2006.5641,"B",I,D0)
"RTN","MAGDRPC1",56,0)
 . . K ^MAGDICOM(2006.5641,"C",HOSTNAME,D0)
"RTN","MAGDRPC1",57,0)
 . . K ^MAGDICOM(2006.5641,D0)
"RTN","MAGDRPC1",58,0)
 . . Q
"RTN","MAGDRPC1",59,0)
 . Q
"RTN","MAGDRPC1",60,0)
 D:'N
"RTN","MAGDRPC1",61,0)
 . S D0=$O(^MAGDICOM(2006.5641," "),-1)+1
"RTN","MAGDRPC1",62,0)
 . S ^MAGDICOM(2006.5641,D0,0)=ID_"^"_HOSTNAME_"^"_$H
"RTN","MAGDRPC1",63,0)
 . S ^MAGDICOM(2006.5641,"B",ID,D0)=""
"RTN","MAGDRPC1",64,0)
 . S ^MAGDICOM(2006.5641,"C",HOSTNAME,D0)=""
"RTN","MAGDRPC1",65,0)
 . Q
"RTN","MAGDRPC1",66,0)
 S (N,I,D0)=0 F  S D0=$O(^MAGDICOM(2006.5641,D0)) Q:'D0  S N=N+1,I=D0
"RTN","MAGDRPC1",67,0)
 S ^MAGDICOM(2006.5641,0)="DICOM GATEWAY MACHINE ID^2006.5641^"_I_"^"_N
"RTN","MAGDRPC1",68,0)
 L -^MAGDICOM(2006.5641,0)
"RTN","MAGDRPC1",69,0)
 S OUT=""
"RTN","MAGDRPC1",70,0)
 S N=0,D0="" F  S D0=$O(^MAGDICOM(2006.5641,"B",ID,D0)) Q:D0=""  D
"RTN","MAGDRPC1",71,0)
 . S N=N+1,X=$G(^MAGDICOM(2006.5641,D0,0)),I=$P(X,"^",2)
"RTN","MAGDRPC1",72,0)
 . I I'=HOSTNAME,I'="" S OUT=OUT_", """_I_""""
"RTN","MAGDRPC1",73,0)
 . Q
"RTN","MAGDRPC1",74,0)
 I N=1 S OUT=1 Q
"RTN","MAGDRPC1",75,0)
 S OUT=N_OUT
"RTN","MAGDRPC1",76,0)
 Q
"RTN","MAGDRPC1",77,0)
 ;
"RTN","MAGDRPC1",78,0)
DOMAIN(OUT) ; RPC = MAG DICOM GET DOMAIN
"RTN","MAGDRPC1",79,0)
 N X
"RTN","MAGDRPC1",80,0)
 I $T(WHERE^XUPARAM)'="" S OUT=$$KSP^XUPARAM("WHERE") Q
"RTN","MAGDRPC1",81,0)
 ; The coding standards frown upon the line below,
"RTN","MAGDRPC1",82,0)
 ; but it is the best we can do when the line above cannot be used.
"RTN","MAGDRPC1",83,0)
 S X=^DD("SITE") S:X'[".DOMAIN.EXT" X=X_".DOMAIN.EXT"
"RTN","MAGDRPC1",84,0)
 S OUT=X
"RTN","MAGDRPC1",85,0)
 Q
"RTN","MAGDRPC1",86,0)
 ;
"RTN","MAGDRPC1",87,0)
INFO(OUT,LOCATION) ; RPC = MAG DICOM ET PHONE HOME
"RTN","MAGDRPC1",88,0)
 N FST,N,X
"RTN","MAGDRPC1",89,0)
 K OUT
"RTN","MAGDRPC1",90,0)
 S X1=DT,X2=-25 D C^%DTC S FST=X
"RTN","MAGDRPC1",91,0)
 S N=2
"RTN","MAGDRPC1",92,0)
 ;
"RTN","MAGDRPC1",93,0)
 ; Site-ID
"RTN","MAGDRPC1",94,0)
 D DOMAIN(.X)
"RTN","MAGDRPC1",95,0)
 S OUT(N)=X
"RTN","MAGDRPC1",96,0)
 ;
"RTN","MAGDRPC1",97,0)
 D ROUTEDAY^MAGDRPC2 ; Get routing statistics
"RTN","MAGDRPC1",98,0)
 ;
"RTN","MAGDRPC1",99,0)
 D  ; Text Gateway Statistics
"RTN","MAGDRPC1",100,0)
 . N A,C,D0,D2,M,X
"RTN","MAGDRPC1",101,0)
 . S A=0,D0=FST F  S D0=$O(^MAGDAUDT(2006.5761,D0)) Q:'D0  D
"RTN","MAGDRPC1",102,0)
 . . S D2=0 F  S D2=$O(^MAGDAUDT(2006.5761,D0,1,LOCATION,1,D2)) Q:'D2  D
"RTN","MAGDRPC1",103,0)
 . . . S X=$G(^MAGDAUDT(2006.5761,D0,1,LOCATION,1,D2,0))
"RTN","MAGDRPC1",104,0)
 . . . S M=$P(X,"^",2) Q:'M
"RTN","MAGDRPC1",105,0)
 . . . S:'A N=N+1,OUT(N)="Audit",A=1
"RTN","MAGDRPC1",106,0)
 . . . S N=N+1,OUT(N)="STTX="_D0_"^"_$P(X,"^",1)_"^"_M
"RTN","MAGDRPC1",107,0)
 . . . Q
"RTN","MAGDRPC1",108,0)
 . . Q
"RTN","MAGDRPC1",109,0)
 . Q
"RTN","MAGDRPC1",110,0)
 ;
"RTN","MAGDRPC1",111,0)
 S OUT(1)=N-1
"RTN","MAGDRPC1",112,0)
 Q
"RTN","MAGDRPC1",113,0)
 ;
"RTN","MAGDRPC1",114,0)
STATION(OUT,STATION,VERSION) ; RPC = MAG DICOM WORKSTATION VERSION
"RTN","MAGDRPC1",115,0)
 N %,D0,%H,%I,X
"RTN","MAGDRPC1",116,0)
 I $G(STATION)="" S OUT="-1,No Station Identifier Specified" Q
"RTN","MAGDRPC1",117,0)
 ;
"RTN","MAGDRPC1",118,0)
 S D0=$O(^MAG(2006.83,"B",STATION,"")) D:'D0
"RTN","MAGDRPC1",119,0)
 . L +^MAG(2006.83,0):1E9 ; Background process must wait for LOCK
"RTN","MAGDRPC1",120,0)
 . S X=$G(^MAG(2006.83,0))
"RTN","MAGDRPC1",121,0)
 . S $P(X,"^",1,2)="DICOM WORKSTATION^2006.83"
"RTN","MAGDRPC1",122,0)
 . S D0=$O(^MAG(2006.83," "),-1)+1
"RTN","MAGDRPC1",123,0)
 . S $P(X,"^",3)=D0
"RTN","MAGDRPC1",124,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDRPC1",125,0)
 . S ^MAG(2006.83,0)=X,^MAG(2006.83,D0,0)=STATION
"RTN","MAGDRPC1",126,0)
 . S ^MAG(2006.83,"B",STATION,D0)=""
"RTN","MAGDRPC1",127,0)
 . L -^MAG(2006.83,0)
"RTN","MAGDRPC1",128,0)
 . Q
"RTN","MAGDRPC1",129,0)
 S $P(^MAG(2006.83,D0,0),"^",3)=VERSION
"RTN","MAGDRPC1",130,0)
 S X=$P(^MAG(2006.83,D0,0),"^",2)
"RTN","MAGDRPC1",131,0)
 D NOW^%DTC
"RTN","MAGDRPC1",132,0)
 S $P(^MAG(2006.83,D0,0),"^",2)=%
"RTN","MAGDRPC1",133,0)
 S OUT=D0
"RTN","MAGDRPC1",134,0)
 Q
"RTN","MAGDRPC1",135,0)
 ;
"RTN","MAGDRPC1",136,0)
FMGET(OUT,FILE,D0,FIELD) ; RPC = MAG DICOM FILEMAN GET
"RTN","MAGDRPC1",137,0)
 ; Get the value of a data field
"RTN","MAGDRPC1",138,0)
 S OUT=$$GET1^DIQ(FILE,D0,FIELD)
"RTN","MAGDRPC1",139,0)
 Q
"RTN","MAGDRPC1",140,0)
 ;
"RTN","MAGDRPC1",141,0)
CUTOFF(OUT,D0) ; RPC = MAG DICOM PACS CUTOFF DATE
"RTN","MAGDRPC1",142,0)
 ; Retention Period for PACS
"RTN","MAGDRPC1",143,0)
 N X
"RTN","MAGDRPC1",144,0)
 I '$$CONSOLID^MAGBAPI() D  Q
"RTN","MAGDRPC1",145,0)
 . ; Non-consolidated site
"RTN","MAGDRPC1",146,0)
 . I '$D(^MAG(2006.1,"APACS")) S OUT="-2,No PACS Installed" Q
"RTN","MAGDRPC1",147,0)
 . ;
"RTN","MAGDRPC1",148,0)
 . S X=$G(^MAG(2006.1,"AIMDELPACS"))
"RTN","MAGDRPC1",149,0)
 . I X="" S OUT="-3,PACS Retention Parameter not defined" Q
"RTN","MAGDRPC1",150,0)
 . S OUT=X
"RTN","MAGDRPC1",151,0)
 . Q
"RTN","MAGDRPC1",152,0)
 ; Consolidated site:
"RTN","MAGDRPC1",153,0)
 I '$P($G(^MAG(2006.1,D0,"PACS")),"^",1) S OUT="-2,No PACS Installed" Q
"RTN","MAGDRPC1",154,0)
 ;
"RTN","MAGDRPC1",155,0)
 S X=$P($G(^MAG(2006.1,D0,1)),"^",5)
"RTN","MAGDRPC1",156,0)
 I X="" S OUT="-3,PACS Retention Parameter not defined" Q
"RTN","MAGDRPC1",157,0)
 S OUT=X
"RTN","MAGDRPC1",158,0)
 Q
"RTN","MAGDRPC1",159,0)
 ;
"RTN","MAGDRPC1",160,0)
MINSPACE(OUT,D0) ; RPC = MAG DICOM PACS MINIMUM SPACE
"RTN","MAGDRPC1",161,0)
 ; Minimum Percentage of Free Disk Space
"RTN","MAGDRPC1",162,0)
 N X
"RTN","MAGDRPC1",163,0)
 I '$$CONSOLID^MAGBAPI() D  Q
"RTN","MAGDRPC1",164,0)
 . ; Non-consolidated site
"RTN","MAGDRPC1",165,0)
 . I '$D(^MAG(2006.1,"APACS")) S OUT="-2,No PACS Installed" Q
"RTN","MAGDRPC1",166,0)
 . ;
"RTN","MAGDRPC1",167,0)
 . S X=$G(^MAG(2006.1,"AIMDELPACS2"))
"RTN","MAGDRPC1",168,0)
 . I X="" S OUT="-3,PACS Minimum Space Percentage Parameter not defined" Q
"RTN","MAGDRPC1",169,0)
 . S OUT=X
"RTN","MAGDRPC1",170,0)
 . Q
"RTN","MAGDRPC1",171,0)
 ; Consolidated site:
"RTN","MAGDRPC1",172,0)
 I '$P($G(^MAG(2006.1,D0,"PACS")),"^",1) S OUT="-2,No PACS Installed" Q
"RTN","MAGDRPC1",173,0)
 ;
"RTN","MAGDRPC1",174,0)
 S X=$P($G(^MAG(2006.1,D0,3)),"^",5)
"RTN","MAGDRPC1",175,0)
 I X="" S OUT="-3,PACS Minimum Space Percentage Parameter not defined" Q
"RTN","MAGDRPC1",176,0)
 S OUT=X
"RTN","MAGDRPC1",177,0)
 Q
"RTN","MAGDRPC1",178,0)
 ;
"RTN","MAGDRPC1",179,0)
HL7PURGE(OUT,CUTOFF) ; RPC = MAG DICOM PURGE HL7
"RTN","MAGDRPC1",180,0)
 ; Purge HL7 transactions
"RTN","MAGDRPC1",181,0)
 N D,D0,P,T,X
"RTN","MAGDRPC1",182,0)
 S OUT=0
"RTN","MAGDRPC1",183,0)
 S D="" F  S D=$O(^MAGDHL7(2006.5,"B",D)) Q:'D  Q:D'<CUTOFF  D
"RTN","MAGDRPC1",184,0)
 . S D0="" F  S D0=$O(^MAGDHL7(2006.5,"B",D,D0)) Q:'D0  D
"RTN","MAGDRPC1",185,0)
 . . S X=$G(^MAGDHL7(2006.5,D0,0)),P=$P(X,"^",4),T=$P(X,"^",3)
"RTN","MAGDRPC1",186,0)
 . . K ^MAGDHL7(2006.5,D0)
"RTN","MAGDRPC1",187,0)
 . . K ^MAGDHL7(2006.5,"B",D,D0)
"RTN","MAGDRPC1",188,0)
 . . K:T'="" ^MAGDHL7(2006.5,"C",T,D0)
"RTN","MAGDRPC1",189,0)
 . . K:P'="" ^MAGDHL7(2006.5,"D",P,D0)
"RTN","MAGDRPC1",190,0)
 . . S OUT=OUT+1
"RTN","MAGDRPC1",191,0)
 . . Q
"RTN","MAGDRPC1",192,0)
 . Q
"RTN","MAGDRPC1",193,0)
 D:OUT
"RTN","MAGDRPC1",194,0)
 . L +^MAGDHL7(2006.5,0):1E9
"RTN","MAGDRPC1",195,0)
 . S X=$G(^MAGDHL7(2006.5,0))
"RTN","MAGDRPC1",196,0)
 . S $P(X,"^",1,2)="PACS MESSAGES^2006.5D"
"RTN","MAGDRPC1",197,0)
 . S $P(X,"^",4)=$P(X,"^",4)-OUT
"RTN","MAGDRPC1",198,0)
 . S ^MAGDHL7(2006.5,0)=X
"RTN","MAGDRPC1",199,0)
 . L -^MAGDHL7(2006.5,0)
"RTN","MAGDRPC1",200,0)
 . Q
"RTN","MAGDRPC1",201,0)
 Q
"RTN","MAGDRPC1",202,0)
 ;
"RTN","MAGDRPC1",203,0)
VALDEST(OUT,NAME) ; RPC = MAG DICOM ROUTE VALID DEST
"RTN","MAGDRPC1",204,0)
 N D0,PLACE,X
"RTN","MAGDRPC1",205,0)
 ; This function is also called from various routines
"RTN","MAGDRPC1",206,0)
 ; that belong to automated routing.
"RTN","MAGDRPC1",207,0)
 ;
"RTN","MAGDRPC1",208,0)
 S OUT="-1,"""_NAME_""" is not a valid destination"
"RTN","MAGDRPC1",209,0)
 ;
"RTN","MAGDRPC1",210,0)
 I $D(^MAG(2005.2,"B")) D  Q
"RTN","MAGDRPC1",211,0)
 . S D0=$O(^MAG(2005.2,"B",NAME,"")) Q:'D0
"RTN","MAGDRPC1",212,0)
 . S:$P($G(^MAG(2005.2,D0,0)),"^",9) OUT=D0
"RTN","MAGDRPC1",213,0)
 . Q
"RTN","MAGDRPC1",214,0)
 ;
"RTN","MAGDRPC1",215,0)
 S D0=""
"RTN","MAGDRPC1",216,0)
 S PLACE="" F  S PLACE=$O(^MAG(2005.2,"D",PLACE)) Q:PLACE=""  D  Q:OUT>0
"RTN","MAGDRPC1",217,0)
 . S D0=$O(^MAG(2005.2,"D",PLACE,NAME,""))
"RTN","MAGDRPC1",218,0)
 . S:$P($G(^MAG(2005.2,D0,0)),"^",9) OUT=D0
"RTN","MAGDRPC1",219,0)
 . Q
"RTN","MAGDRPC1",220,0)
 Q
"RTN","MAGDRPC1",221,0)
 ;
"RTN","MAGDRPC1",222,0)
PAT(OUT,DFN) ; RPC = MAG DICOM GET PATIENT
"RTN","MAGDRPC1",223,0)
 N DIQUIET,I,N,VADM,VAIN,VAPA,VASD
"RTN","MAGDRPC1",224,0)
 K OUT
"RTN","MAGDRPC1",225,0)
 I '$G(DFN) S OUT(1)="-1,No Patient Identified" Q
"RTN","MAGDRPC1",226,0)
 S N=1,DIQUIET=1
"RTN","MAGDRPC1",227,0)
 D DEM^VADPT
"RTN","MAGDRPC1",228,0)
 S I="" F  S I=$O(VADM(I)) Q:I=""  S:VADM(I)'="" N=N+1,OUT(N)="DEM^"_I_"^"_VADM(I)
"RTN","MAGDRPC1",229,0)
 D ADD^VADPT
"RTN","MAGDRPC1",230,0)
 S I="" F  S I=$O(VAPA(I)) Q:I=""  S:VAPA(I)'="" N=N+1,OUT(N)="ADD^"_I_"^"_VAPA(I)
"RTN","MAGDRPC1",231,0)
 D INP^VADPT
"RTN","MAGDRPC1",232,0)
 S I="" F  S I=$O(VAIN(I)) Q:I=""  S:VAIN(I)'="" N=N+1,OUT(N)="INP^"_I_"^"_VAIN(I)
"RTN","MAGDRPC1",233,0)
 D SDA^VADPT
"RTN","MAGDRPC1",234,0)
 S I="" F  S I=$O(VASD(I)) Q:I=""  S:VASD(I)'="" N=N+1,OUT(N)="SDA^"_I_"^"_VASD(I)
"RTN","MAGDRPC1",235,0)
 S X=$$GETICN^MPIF001(DFN) S:X'<0 N=N+1,OUT(N)="ICN^1^"_X
"RTN","MAGDRPC1",236,0)
 S OUT(1)=N-1
"RTN","MAGDRPC1",237,0)
 Q
"RTN","MAGDRPC1",238,0)
 ;
"RTN","MAGDRPC1",239,0)
RARPTO(OUT,TYPE,D0,F,D1) ; RPC = MAG DICOM GET RAD RPT INFO
"RTN","MAGDRPC1",240,0)
 S TYPE=$G(TYPE),D0=$G(D0),F=$G(F,1),D1=+$G(D1)
"RTN","MAGDRPC1",241,0)
 I TYPE="O1" S OUT=+$O(^RARPT(D0),F) Q
"RTN","MAGDRPC1",242,0)
 I TYPE="O2" S OUT=+$O(^RARPT(D0,F,D1)) Q
"RTN","MAGDRPC1",243,0)
 I TYPE="G1" S OUT=$G(^RARPT(D0,0)) Q
"RTN","MAGDRPC1",244,0)
 I TYPE="G2" S OUT=$G(^RARPT(D0,F,D1,0)) Q
"RTN","MAGDRPC1",245,0)
 S OUT="-1,Invalid request type ("""_TYPE_""")"
"RTN","MAGDRPC1",246,0)
 Q
"RTN","MAGDRPC1",247,0)
 ;
"RTN","MAGDRPC2")
0^38^B65160462
"RTN","MAGDRPC2",1,0)
MAGDRPC2 ;WOIFO/EdM - Imaging RPCs ; 06/17/2005  08:53
"RTN","MAGDRPC2",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDRPC2",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC2",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC2",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC2",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC2",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC2",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC2",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC2",10,0)
 ;; |                                                               |
"RTN","MAGDRPC2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC2",17,0)
 ;;
"RTN","MAGDRPC2",18,0)
 Q
"RTN","MAGDRPC2",19,0)
 ;
"RTN","MAGDRPC2",20,0)
SERVICE(OUT) ; RPC = MAG DICOM GET SERVICE INFO
"RTN","MAGDRPC2",21,0)
 N D0,X
"RTN","MAGDRPC2",22,0)
 S D0=$O(^MAG(2006.1,0)),OUT="-1,No Imaging Site Parameters defined" Q:'D0
"RTN","MAGDRPC2",23,0)
 S X=$G(^MAG(2006.1,D0,"GW"))
"RTN","MAGDRPC2",24,0)
 S OUT=$$ENCRYP^ROUTINE($$DECRYP($P(X,"^",1))_";"_$$DECRYP($P(X,"^",2)))
"RTN","MAGDRPC2",25,0)
 Q
"RTN","MAGDRPC2",26,0)
 ;
"RTN","MAGDRPC2",27,0)
SAME(SET,D0,NODE,PIECE,X) ; Called from FileMan ^DD
"RTN","MAGDRPC2",28,0)
 N L0
"RTN","MAGDRPC2",29,0)
 S L0=0 F  S L0=$O(^MAG(2006.1,L0)) Q:'L0  D:L0'=D0
"RTN","MAGDRPC2",30,0)
 . S $P(^MAG(2006.1,L0,NODE),"^",PIECE)=$S(SET:X,1:"")
"RTN","MAGDRPC2",31,0)
 . Q
"RTN","MAGDRPC2",32,0)
 Q
"RTN","MAGDRPC2",33,0)
 ;
"RTN","MAGDRPC2",34,0)
IMAGE(OUT,D0) ; RPC = MAG DICOM GET BASIC IMAGE
"RTN","MAGDRPC2",35,0)
 N I,MSG,TARGET,V,VE,VI,X
"RTN","MAGDRPC2",36,0)
 K OUT S I=1
"RTN","MAGDRPC2",37,0)
 I '$G(D0) S OUT(1)="-1,Invalid IEN ("_$G(D0)_")" Q
"RTN","MAGDRPC2",38,0)
 I $D(^MAG(2005.1,D0,0)) S OUT(1)="-3,Image #"_D0_" has been deleted." Q
"RTN","MAGDRPC2",39,0)
 I '$D(^MAG(2005,D0,0)) S OUT(1)="-2,No data for """_D0_"""." Q
"RTN","MAGDRPC2",40,0)
 ;
"RTN","MAGDRPC2",41,0)
 D GETS^DIQ(2005,D0_",","*","REIN","TARGET","MSG")
"RTN","MAGDRPC2",42,0)
 S X="" F  S X=$O(TARGET(2005,D0_",",X)) Q:X=""  D
"RTN","MAGDRPC2",43,0)
 . S VI=$G(TARGET(2005,D0_",",X,"I"))
"RTN","MAGDRPC2",44,0)
 . S VE=$G(TARGET(2005,D0_",",X,"E"))
"RTN","MAGDRPC2",45,0)
 . S I=I+1,OUT(I)=X_"^"_VI S:VI'=VE OUT(I)=OUT(I)_"^"_VE
"RTN","MAGDRPC2",46,0)
 . Q
"RTN","MAGDRPC2",47,0)
 ;
"RTN","MAGDRPC2",48,0)
 D FILEFIND^MAGDFB(D0,"FULL",0,0,.X,.V)
"RTN","MAGDRPC2",49,0)
 S:X'<0 I=I+1,OUT(I)="Full FileName^"_X
"RTN","MAGDRPC2",50,0)
 S:V'<0 I=I+1,OUT(I)="Full Path+FileName^"_V
"RTN","MAGDRPC2",51,0)
 ;
"RTN","MAGDRPC2",52,0)
 D FILEFIND^MAGDFB(D0,"BIG",0,0,.X,.V)
"RTN","MAGDRPC2",53,0)
 S:X'<0 I=I+1,OUT(I)="Big FileName^"_X
"RTN","MAGDRPC2",54,0)
 S:V'<0 I=I+1,OUT(I)="Big Path+FileName^"_V
"RTN","MAGDRPC2",55,0)
 ;
"RTN","MAGDRPC2",56,0)
 D FILEFIND^MAGDFB(D0,"ABSTRACT",0,0,.X,.V)
"RTN","MAGDRPC2",57,0)
 S:X'<0 I=I+1,OUT(I)="Abstract FileName^"_X
"RTN","MAGDRPC2",58,0)
 S:V'<0 I=I+1,OUT(I)="Abstract Path+FileName^"_V
"RTN","MAGDRPC2",59,0)
 ;
"RTN","MAGDRPC2",60,0)
 S (V,X)=0 F  S X=$O(^MAG(2005,D0,1,X)) Q:'X  S V=V+1
"RTN","MAGDRPC2",61,0)
 S:V I=I+1,OUT(I)="# Images^"_V
"RTN","MAGDRPC2",62,0)
 ;
"RTN","MAGDRPC2",63,0)
 S OUT(1)=I-1
"RTN","MAGDRPC2",64,0)
 Q
"RTN","MAGDRPC2",65,0)
 ;
"RTN","MAGDRPC2",66,0)
GRPIMG(OUT,D0) ; RPC = MAG DICOM GET IMAGE GROUP
"RTN","MAGDRPC2",67,0)
 N I,D1,X
"RTN","MAGDRPC2",68,0)
 K OUT S I=1
"RTN","MAGDRPC2",69,0)
 S D1=0 F  S D1=$O(^MAG(2005,D0,1,D1)) Q:'D1  D
"RTN","MAGDRPC2",70,0)
 . S X=$P($G(^MAG(2005,D0,1,D1,0)),"^",1) Q:'X
"RTN","MAGDRPC2",71,0)
 . S I=I+1,OUT(I)=X
"RTN","MAGDRPC2",72,0)
 . Q
"RTN","MAGDRPC2",73,0)
 S OUT(1)=I-1
"RTN","MAGDRPC2",74,0)
 Q
"RTN","MAGDRPC2",75,0)
 ;
"RTN","MAGDRPC2",76,0)
DECRYP(X) Q $S(X="":"",1:$$DECRYP^ROUTINE(X))
"RTN","MAGDRPC2",77,0)
 ;
"RTN","MAGDRPC2",78,0)
IMGVER(OUT) ; RPC = MAG DICOM GET VERSION
"RTN","MAGDRPC2",79,0)
 N D0,DATINS,FME,FML,I,L,N,P,PATCH,X
"RTN","MAGDRPC2",80,0)
 D FIND^DIC(9.7,"",".01;2I;51I","QU","MAG*3.0","*","B","","","FML","FME")
"RTN","MAGDRPC2",81,0)
 S I="" F  S I=$O(FML("DILIST","ID",I)) Q:I=""  D
"RTN","MAGDRPC2",82,0)
 . S N=$G(FML("DILIST","ID",I,.01)) Q:$P(N,"*",2)'="3.0"
"RTN","MAGDRPC2",83,0)
 . S PATCH=$P(N,"*",3) Q:'PATCH
"RTN","MAGDRPC2",84,0)
 . S PATCH(PATCH)=1
"RTN","MAGDRPC2",85,0)
 . S DATINS=$G(FML("DILIST","ID",I,2)) Q:DATINS=""
"RTN","MAGDRPC2",86,0)
 . S P=$G(FML("DILIST","ID",I,51)) Q:P=""
"RTN","MAGDRPC2",87,0)
 . S L(DATINS,PATCH_"-"_P)=""
"RTN","MAGDRPC2",88,0)
 . Q
"RTN","MAGDRPC2",89,0)
 ;
"RTN","MAGDRPC2",90,0)
 S (DATINS,L,OUT)="" F  S DATINS=$O(L(DATINS),-1) Q:DATINS=""  D
"RTN","MAGDRPC2",91,0)
 . S PATCH="" F  S PATCH=$O(L(DATINS,PATCH)) Q:PATCH=""  D
"RTN","MAGDRPC2",92,0)
 . . S:OUT="" OUT=PATCH
"RTN","MAGDRPC2",93,0)
 . . S:$G(PATCH(+PATCH)) PATCH(+PATCH)=0,L=(+PATCH)_","_L
"RTN","MAGDRPC2",94,0)
 . . Q
"RTN","MAGDRPC2",95,0)
 . Q
"RTN","MAGDRPC2",96,0)
 S OUT=L_OUT
"RTN","MAGDRPC2",97,0)
 Q
"RTN","MAGDRPC2",98,0)
 ;
"RTN","MAGDRPC2",99,0)
PLACE(LOCATION) N D0,FST,LST
"RTN","MAGDRPC2",100,0)
 S FST=+$O(^MAG(2006.1,0)),LST=+$O(^MAG(2006.1," "),-1) Q:LST=FST FST
"RTN","MAGDRPC2",101,0)
 S D0=$O(^MAG(2006.1,"B",+$G(LOCATION),"")) Q:D0 D0
"RTN","MAGDRPC2",102,0)
 Q FST
"RTN","MAGDRPC2",103,0)
 ;
"RTN","MAGDRPC2",104,0)
ROUTEDAY ; Scan for Routing Activity
"RTN","MAGDRPC2",105,0)
 N BUCKET ;- Daily tallies
"RTN","MAGDRPC2",106,0)
 N D0 ;----- Image pointer for child of current parent
"RTN","MAGDRPC2",107,0)
 N D1 ;----- Pointer to multiple in image file
"RTN","MAGDRPC2",108,0)
 N D4 ;----- Loop counter
"RTN","MAGDRPC2",109,0)
 N DAY ;---- Current FileMan date
"RTN","MAGDRPC2",110,0)
 N DAYTIM ;- Current FileMan timestamp
"RTN","MAGDRPC2",111,0)
 N DEST ;--- Destination
"RTN","MAGDRPC2",112,0)
 N FIRST ;-- First date for scan
"RTN","MAGDRPC2",113,0)
 N FSTX ;--- First transmission for current study
"RTN","MAGDRPC2",114,0)
 N %H ;----- $Horolog timestamp
"RTN","MAGDRPC2",115,0)
 N IMAGE ;-- Image Pointer for current image
"RTN","MAGDRPC2",116,0)
 N LAST ;--- Last date for scan
"RTN","MAGDRPC2",117,0)
 N LSTQ ;--- Timestamp for last queue entry in current study
"RTN","MAGDRPC2",118,0)
 N P3 ;----- Highest IEN in statistics file
"RTN","MAGDRPC2",119,0)
 N P4 ;----- Number of entries in statistics file
"RTN","MAGDRPC2",120,0)
 N PARENT ;- Image Pointer for parent of current image
"RTN","MAGDRPC2",121,0)
 N X ;------ Scratch
"RTN","MAGDRPC2",122,0)
 N XMIT ;--- Total duration of transmissions for current study
"RTN","MAGDRPC2",123,0)
 ;
"RTN","MAGDRPC2",124,0)
 K ^TMP("MAG",$J,"RTD1")
"RTN","MAGDRPC2",125,0)
 K ^TMP("MAG",$J,"RTD2")
"RTN","MAGDRPC2",126,0)
 K ^TMP("MAG",$J,"RTD3")
"RTN","MAGDRPC2",127,0)
 S %H=$H-4 D YMD^%DTC S FIRST=X
"RTN","MAGDRPC2",128,0)
 S %H=$H+2 D YMD^%DTC S LAST=X
"RTN","MAGDRPC2",129,0)
 ;
"RTN","MAGDRPC2",130,0)
 S DEST="" F  S DEST=$O(^MAG(2005,"ROUTE",DEST)) Q:DEST=""  D
"RTN","MAGDRPC2",131,0)
 . S NAME(DEST)=$P($G(^MAG(2005.2,DEST,0)," ? "_DEST),"^",1)
"RTN","MAGDRPC2",132,0)
 . S DAYTIM=FIRST F  D  S DAYTIM=$O(^MAG(2005,"ROUTE",DEST,DAYTIM)) Q:DAYTIM=""  Q:DAYTIM'<LAST
"RTN","MAGDRPC2",133,0)
 . . S DAY=DAYTIM\1
"RTN","MAGDRPC2",134,0)
 . . S IMAGE="" F  S IMAGE=$O(^MAG(2005,"ROUTE",DEST,DAYTIM,IMAGE)) Q:IMAGE=""  D
"RTN","MAGDRPC2",135,0)
 . . . S PARENT=$P($G(^MAG(2005,IMAGE,0)),"^",10)
"RTN","MAGDRPC2",136,0)
 . . . I PARENT,$G(^TMP("MAG",$J,"RTD3",PARENT)) S PARENT=0
"RTN","MAGDRPC2",137,0)
 . . . S:PARENT ^TMP("MAG",$J,"RTD3",PARENT)=1
"RTN","MAGDRPC2",138,0)
 . . . S (XMIT,LSTQ)=0,FSTX=1E9
"RTN","MAGDRPC2",139,0)
 . . . S D0=IMAGE,D1=0 D  I PARENT F  S D1=$O(^MAG(2005,PARENT,1,D1)) Q:'D1  S D0=+$P($G(^MAG(2005,PARENT,1,D1,0)),"^",1) D
"RTN","MAGDRPC2",140,0)
 . . . . Q:'D0
"RTN","MAGDRPC2",141,0)
 . . . . Q:$D(^TMP("MAG",$J,"RTD1",D0,D1))
"RTN","MAGDRPC2",142,0)
 . . . . S ^TMP("MAG",$J,"RTD1",D0,D1)=""
"RTN","MAGDRPC2",143,0)
 . . . . S D4=0 F  S D4=$O(^MAG(2005,D0,4,D4)) Q:'D4  D
"RTN","MAGDRPC2",144,0)
 . . . . . S X=$G(^MAG(2005,D0,4,D4,0))
"RTN","MAGDRPC2",145,0)
 . . . . . Q:$P($P(X,"^",1),".",1)'=DAY
"RTN","MAGDRPC2",146,0)
 . . . . . Q:$P(X,"^",2)'=DEST
"RTN","MAGDRPC2",147,0)
 . . . . . S:$P(X,"^",6)>LSTQ LSTQ=$P(X,"^",6)
"RTN","MAGDRPC2",148,0)
 . . . . . S:$P(X,"^",5)<FSTX FSTX=$P(X,"^",5)
"RTN","MAGDRPC2",149,0)
 . . . . . S XMIT=XMIT+$$DELTA($P(X,"^",5),$P(X,"^",1))
"RTN","MAGDRPC2",150,0)
 . . . . . Q
"RTN","MAGDRPC2",151,0)
 . . . . Q
"RTN","MAGDRPC2",152,0)
 . . . S X=$$DELTA(LSTQ,FSTX)
"RTN","MAGDRPC2",153,0)
 . . . S:X>$G(BUCKET(DAY,DEST,1)) BUCKET(DAY,DEST,1)=X
"RTN","MAGDRPC2",154,0)
 . . . S X=$S(X<300:1,X<900:2,X<3600:3,1:4)
"RTN","MAGDRPC2",155,0)
 . . . S BUCKET(DAY,DEST,1,X)=$G(BUCKET(DAY,DEST,1,X))+1
"RTN","MAGDRPC2",156,0)
 . . . S:XMIT>$G(BUCKET(DAY,DEST,2)) BUCKET(DAY,DEST,2)=XMIT
"RTN","MAGDRPC2",157,0)
 . . . S X=$S(XMIT<300:1,XMIT<900:2,XMIT<3600:3,1:4)
"RTN","MAGDRPC2",158,0)
 . . . S BUCKET(DAY,DEST,2,X)=$G(BUCKET(DAY,DEST,2,X))+1
"RTN","MAGDRPC2",159,0)
 . . . Q
"RTN","MAGDRPC2",160,0)
 . . Q
"RTN","MAGDRPC2",161,0)
 . Q
"RTN","MAGDRPC2",162,0)
 ;
"RTN","MAGDRPC2",163,0)
 S X=$G(^TMP("MAG",$J,"RTD2",0)),P3=+$P(X,"^",3),P4=+$P(X,"^",4)
"RTN","MAGDRPC2",164,0)
 S DAY="" F  S DAY=$O(BUCKET(DAY)) Q:DAY=""  D
"RTN","MAGDRPC2",165,0)
 . S:'$D(^TMP("MAG",$J,"RTD2",DAY)) P4=P4+1,^TMP("MAG",$J,"RTD2",DAY,0)=DAY
"RTN","MAGDRPC2",166,0)
 . S D1=0,DEST="" F  S DEST=$O(BUCKET(DAY,DEST)) Q:DEST=""  D
"RTN","MAGDRPC2",167,0)
 . . S D1=D1+1
"RTN","MAGDRPC2",168,0)
 . . S X=$G(BUCKET(DAY,DEST,2,1))       ; Less than 5 minutes
"RTN","MAGDRPC2",169,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,2,2)) ; Less than 15 minutes
"RTN","MAGDRPC2",170,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,2,3)) ; Less than 1 hour
"RTN","MAGDRPC2",171,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,2,4)) ; 1 hour or more
"RTN","MAGDRPC2",172,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,2))   ; Longest
"RTN","MAGDRPC2",173,0)
 . . S X=X_"^Duration ("_NAME(DEST)_")"
"RTN","MAGDRPC2",174,0)
 . . S ^TMP("MAG",$J,"RTD2",DAY,1,D1,0)=X
"RTN","MAGDRPC2",175,0)
 . . S D1=D1+1
"RTN","MAGDRPC2",176,0)
 . . S X=$G(BUCKET(DAY,DEST,1,1))       ; Less than 5 minutes
"RTN","MAGDRPC2",177,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,1,2)) ; Less than 15 minutes
"RTN","MAGDRPC2",178,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,1,3)) ; Less than 1 hour
"RTN","MAGDRPC2",179,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,1,4)) ; 1 hour or more
"RTN","MAGDRPC2",180,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,1))   ; Longest
"RTN","MAGDRPC2",181,0)
 . . S X=X_"^Lag ("_NAME(DEST)_")"
"RTN","MAGDRPC2",182,0)
 . . S ^TMP("MAG",$J,"RTD2",DAY,1,D1,0)=X
"RTN","MAGDRPC2",183,0)
 . . Q
"RTN","MAGDRPC2",184,0)
 . S:DAY>P3 P3=DAY
"RTN","MAGDRPC2",185,0)
 . Q
"RTN","MAGDRPC2",186,0)
 ; Purge old entries
"RTN","MAGDRPC2",187,0)
 S R=$G(^MAGDICOM(2006.563,1,"RETAIN ROUTING STATISTICS")) S:R<1 R=30
"RTN","MAGDRPC2",188,0)
 S %H=$H-R D YMD^%DTC S DAY=X
"RTN","MAGDRPC2",189,0)
 S D0=0 F  S D0=$O(^TMP("MAG",$J,"RTD2",D0)) Q:'D0  Q:D0'<DAY  D
"RTN","MAGDRPC2",190,0)
 . K ^TMP("MAG",$J,"RTD2",D0) S P4=P4-1
"RTN","MAGDRPC2",191,0)
 . Q
"RTN","MAGDRPC2",192,0)
 ;
"RTN","MAGDRPC2",193,0)
 D  ; Get routing statistics
"RTN","MAGDRPC2",194,0)
 . N A,W
"RTN","MAGDRPC2",195,0)
 . S (A,DAY)=0 F  S DAY=$O(^TMP("MAG",$J,"RTD2",DAY)) Q:'DAY  D
"RTN","MAGDRPC2",196,0)
 . . S:'A N=N+1,OUT(N)="Route",A=1
"RTN","MAGDRPC2",197,0)
 . . S N=N+1,OUT(N)="RDT="_DAY
"RTN","MAGDRPC2",198,0)
 . . S W=0 F  S W=$O(^TMP("MAG",$J,"RTD2",DAY,1,W)) Q:'W  D
"RTN","MAGDRPC2",199,0)
 . . . S X=$G(^TMP("MAG",$J,"RTD2",DAY,1,W,0))
"RTN","MAGDRPC2",200,0)
 . . . S N=N+1,OUT(N)="DST="_$P($P($P(X,"^",6),"(",2),")",1)
"RTN","MAGDRPC2",201,0)
 . . . S W=W+1,$P(X,"^",6,10)=$P($G(^TMP("MAG",$J,"RTD2",DAY,1,W,0)),"^",1,5)
"RTN","MAGDRPC2",202,0)
 . . . S N=N+1,OUT(N)="RST="_X
"RTN","MAGDRPC2",203,0)
 . . . Q
"RTN","MAGDRPC2",204,0)
 . . Q
"RTN","MAGDRPC2",205,0)
 . S:A N=N+1,OUT(N)="RouteEnd"
"RTN","MAGDRPC2",206,0)
 . Q
"RTN","MAGDRPC2",207,0)
 K ^TMP("MAG",$J,"RTD1")
"RTN","MAGDRPC2",208,0)
 K ^TMP("MAG",$J,"RTD2")
"RTN","MAGDRPC2",209,0)
 K ^TMP("MAG",$J,"RTD3")
"RTN","MAGDRPC2",210,0)
 Q
"RTN","MAGDRPC2",211,0)
 ;
"RTN","MAGDRPC2",212,0)
DELTA(START,STOP) N D,D1,D2,T1,T2
"RTN","MAGDRPC2",213,0)
 S D1=$P(START,".",1),D2=$P(STOP,".",1)
"RTN","MAGDRPC2",214,0)
 S T1=START*1E6#1E6,T2=STOP*1E6#1E6
"RTN","MAGDRPC2",215,0)
 S T1=T1\10000*60+(T1\100#100)*60+(T1#100)
"RTN","MAGDRPC2",216,0)
 S T2=T2\10000*60+(T2\100#100)*60+(T2#100)
"RTN","MAGDRPC2",217,0)
 S D=0 D:D1'=D2
"RTN","MAGDRPC2",218,0)
 . N %H,%T,%Y,X
"RTN","MAGDRPC2",219,0)
 . S X=D1 D H^%DTC S D1=%H
"RTN","MAGDRPC2",220,0)
 . S X=D2 D H^%DTC S D2=%H
"RTN","MAGDRPC2",221,0)
 . S D=D2-D1
"RTN","MAGDRPC2",222,0)
 . Q
"RTN","MAGDRPC2",223,0)
 Q D*86400+T2-T1
"RTN","MAGDRPC2",224,0)
 ;
"RTN","MAGDRPC3")
0^39^B44058911
"RTN","MAGDRPC3",1,0)
MAGDRPC3 ;WOIFO/EdM - Imaging RPCs ; 06/03/2005  06:49
"RTN","MAGDRPC3",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDRPC3",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC3",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC3",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC3",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC3",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC3",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC3",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC3",10,0)
 ;; |                                                               |
"RTN","MAGDRPC3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC3",17,0)
 ;;
"RTN","MAGDRPC3",18,0)
 Q
"RTN","MAGDRPC3",19,0)
 ;
"RTN","MAGDRPC3",20,0)
RADLKUP(OUT,CASENUMB,STUDYDAT) ; RPC = MAG DICOM LOOKUP RAD STUDY
"RTN","MAGDRPC3",21,0)
 ; Radiology patient/study lookup
"RTN","MAGDRPC3",22,0)
 N ACCNUM ;--- Accession Number
"RTN","MAGDRPC3",23,0)
 N CPTCODE ;-- CPT code for the procedure
"RTN","MAGDRPC3",24,0)
 N CPTNAME ;-- CPT name for the procedure
"RTN","MAGDRPC3",25,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDRPC3",26,0)
 N PROCDESC ;- Procedure description
"RTN","MAGDRPC3",27,0)
 N PROCIEN ;-- radiology procedure ien in ^RAMIS(71)
"RTN","MAGDRPC3",28,0)
 N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDRPC3",29,0)
 N RADPT1 ;--- first level subscript in ^RADPT
"RTN","MAGDRPC3",30,0)
 N RADPT2 ;--- second level subscript in ^RADPT (after "DT")
"RTN","MAGDRPC3",31,0)
 N RADPT3 ;--- third level subscript in ^RADPT (after "P")
"RTN","MAGDRPC3",32,0)
 N D1,I,LIST,X,Z
"RTN","MAGDRPC3",33,0)
 ;
"RTN","MAGDRPC3",34,0)
 ; find the patient/study in ^RADPT using the Radiology Case Number
"RTN","MAGDRPC3",35,0)
 K OUT
"RTN","MAGDRPC3",36,0)
 D
"RTN","MAGDRPC3",37,0)
 . I $G(CASENUMB)="" S OUT(1)="-1,No Case Number Specified" Q
"RTN","MAGDRPC3",38,0)
 . S RAIX=$S($D(^RADPT("C")):"C",1:"AE") ; for Radiology Patch RA*5*7
"RTN","MAGDRPC3",39,0)
 . S RAIX=$S(CASENUMB["-":"ADC",1:RAIX) ; select the cross-reference
"RTN","MAGDRPC3",40,0)
 . S RADPT1=$O(^RADPT(RAIX,CASENUMB,"")) I 'RADPT1 D  Q:'RADPT1
"RTN","MAGDRPC3",41,0)
 . . I '$G(STUDYDAT) S OUT(1)="-2,No Study Date Specified",RADPT1=0 Q
"RTN","MAGDRPC3",42,0)
 . . ;
"RTN","MAGDRPC3",43,0)
 . . ; Search 1-3 days prior the study date OR a day in advance but only
"RTN","MAGDRPC3",44,0)
 . . ; if the study date is not equal to today or greater than today.
"RTN","MAGDRPC3",45,0)
 . . ; Has to be long case number or must have an image study date
"RTN","MAGDRPC3",46,0)
 . . ;
"RTN","MAGDRPC3",47,0)
 . . N II,RCASE,SDATE,TODAY,X,Y,%,%I
"RTN","MAGDRPC3",48,0)
 . . ;
"RTN","MAGDRPC3",49,0)
 . . S RCASE=$S(CASENUMB["-":$P(CASENUMB,"-",2),1:CASENUMB)
"RTN","MAGDRPC3",50,0)
 . . I 'RCASE S RADPT1=0 Q
"RTN","MAGDRPC3",51,0)
 . . ;
"RTN","MAGDRPC3",52,0)
 . . D NOW^%DTC S TODAY=X
"RTN","MAGDRPC3",53,0)
 . . S X=$P(STUDYDAT,"."),SDATE=$E(X,1,4)-1700_$E(X,5,8) ; FileMan date
"RTN","MAGDRPC3",54,0)
 . . ;
"RTN","MAGDRPC3",55,0)
 . . ; 1-3 days prior study date
"RTN","MAGDRPC3",56,0)
 . . F II=1:1:3 S RADPT1=$$FIND(SDATE,RCASE,-II) Q:RADPT1
"RTN","MAGDRPC3",57,0)
 . . Q:RADPT1
"RTN","MAGDRPC3",58,0)
 . . ;
"RTN","MAGDRPC3",59,0)
 . . ; Wild goose chase, but check for today's case
"RTN","MAGDRPC3",60,0)
 . . S RADPT1=$O(^RADPT("ADC",$$MMDDYY(TODAY)_"-"_RCASE,"")) Q:RADPT1
"RTN","MAGDRPC3",61,0)
 . . ;
"RTN","MAGDRPC3",62,0)
 . . I SDATE'<TODAY S RADPT1=0 Q
"RTN","MAGDRPC3",63,0)
 . . ;
"RTN","MAGDRPC3",64,0)
 . . ; One day in advance?
"RTN","MAGDRPC3",65,0)
 . . S RADPT1=$$FIND(SDATE,RCASE,1) Q:RADPT1
"RTN","MAGDRPC3",66,0)
 . . ;
"RTN","MAGDRPC3",67,0)
 . . ; Finally just check the "C" or "AE" x-reference for the case number
"RTN","MAGDRPC3",68,0)
 . . S X=$S($O(^RADPT("C","")):"C",1:"AE") ; RA*5*7 patch
"RTN","MAGDRPC3",69,0)
 . . S RADPT1=$O(^RADPT(X,RCASE,""))
"RTN","MAGDRPC3",70,0)
 . . Q
"RTN","MAGDRPC3",71,0)
 . S RADPT2=$O(^RADPT(RAIX,CASENUMB,RADPT1,"")) Q:'RADPT2
"RTN","MAGDRPC3",72,0)
 . S RADPT3=$O(^RADPT(RAIX,CASENUMB,RADPT1,RADPT2,"")) Q:'RADPT3
"RTN","MAGDRPC3",73,0)
 . Q:'$D(^RADPT(RADPT1,0))  ; no patient demographics file pointer
"RTN","MAGDRPC3",74,0)
 . ; get patient demographics file pointer
"RTN","MAGDRPC3",75,0)
 . S DFN=$P(^RADPT(RADPT1,0),"^",1)
"RTN","MAGDRPC3",76,0)
 . Q:'$D(^RADPT(RADPT1,"DT",RADPT2,0))  ; no datetime level
"RTN","MAGDRPC3",77,0)
 . ; get date and time of examination
"RTN","MAGDRPC3",78,0)
 . S DATETIME=$P($G(^RADPT(RADPT1,"DT",RADPT2,0)),"^",1)
"RTN","MAGDRPC3",79,0)
 . ; get case info
"RTN","MAGDRPC3",80,0)
 . S X=$G(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDRPC3",81,0)
 . S Z=$P(X,"^",17) I Z S Z=$P($G(^RARPT(Z,0)),"^",1) S:Z'="" ACCNUM=Z
"RTN","MAGDRPC3",82,0)
 . S PROCIEN=$P(X,"^",2),EXAMSTS=$P(X,"^",3)
"RTN","MAGDRPC3",83,0)
 . S:EXAMSTS EXAMSTS=$$GET1^DIQ(72,EXAMSTS,.01)
"RTN","MAGDRPC3",84,0)
 . S (PROCDESC,CPTNAME,CPTCODE)=""
"RTN","MAGDRPC3",85,0)
 . Q:'PROCIEN  ; need PROCIEN to do lookup in ^RAMIS
"RTN","MAGDRPC3",86,0)
 . S Z=$G(^RAMIS(71,PROCIEN,0))
"RTN","MAGDRPC3",87,0)
 . S PROCDESC=$P(Z,"^",1),CPTCODE=$P(Z,"^",9)
"RTN","MAGDRPC3",88,0)
 . S CPTNAME=$P($$CPT^ICPTCOD(+CPTCODE),"^",3) ; IA 1995
"RTN","MAGDRPC3",89,0)
 . S:CPTNAME="" CPTNAME=PROCDESC
"RTN","MAGDRPC3",90,0)
 . Q
"RTN","MAGDRPC3",91,0)
 S OUT(2)=$G(RADPT1)
"RTN","MAGDRPC3",92,0)
 S OUT(3)=$G(RADPT2)
"RTN","MAGDRPC3",93,0)
 S OUT(4)=$G(RADPT3)
"RTN","MAGDRPC3",94,0)
 S OUT(5)=$G(PROCIEN)
"RTN","MAGDRPC3",95,0)
 S OUT(6)=$G(CPTCODE)
"RTN","MAGDRPC3",96,0)
 S OUT(7)=$G(CPTNAME)
"RTN","MAGDRPC3",97,0)
 S OUT(8)=$G(Z)
"RTN","MAGDRPC3",98,0)
 S OUT(9)=$G(EXAMSTS)
"RTN","MAGDRPC3",99,0)
 S OUT(10)=$G(DFN)
"RTN","MAGDRPC3",100,0)
 S OUT(11)=$G(DATETIME)
"RTN","MAGDRPC3",101,0)
 S OUT(12)=$G(PROCDESC)
"RTN","MAGDRPC3",102,0)
 S X=""
"RTN","MAGDRPC3",103,0)
 I $G(PROCIEN) S D1=0 F  S D1=$O(^RAMIS(71,PROCIEN,"MDL",D1)) Q:'D1  D
"RTN","MAGDRPC3",104,0)
 . S Z=+$P($G(^RAMIS(71,PROCIEN,"MDL",D1,0)),"^",1) Q:'Z
"RTN","MAGDRPC3",105,0)
 . S Z=$P($G(^RAMIS(73.1,Z,0)),"^",1) Q:Z=""
"RTN","MAGDRPC3",106,0)
 . S:X'="" X=X_"," S X=X_Z
"RTN","MAGDRPC3",107,0)
 . Q
"RTN","MAGDRPC3",108,0)
 S OUT(13)=X ; List of Modality-codes
"RTN","MAGDRPC3",109,0)
 S X="" I $G(RADPT1),$G(RADPT2) S X=$G(^RADPT(RADPT1,"DT",RADPT2,0))
"RTN","MAGDRPC3",110,0)
 S OUT(14)=$P(X,"^",3) ; Site
"RTN","MAGDRPC3",111,0)
 ; Patient's pregnancy status at the time of the exam
"RTN","MAGDRPC3",112,0)
 S X="" I $G(DFN),$G(RADPT2),$G(RADPT3) S X=$G(^RADPT(DFN,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDRPC3",113,0)
 S OUT(15)=$P($G(^RAO(75.1,+$P(X,"^",11),0)),"^",13)
"RTN","MAGDRPC3",114,0)
 S OUT(16)=$G(ACCNUM)
"RTN","MAGDRPC3",115,0)
 S OUT(1)=1 ; OK
"RTN","MAGDRPC3",116,0)
 Q
"RTN","MAGDRPC3",117,0)
 ;
"RTN","MAGDRPC3",118,0)
QUEUE(OUT,IMAGE,APPNAM,LOCATION,ACCNUM,REASON) ; RPC = MAG DICOM QUEUE IMAGE
"RTN","MAGDRPC3",119,0)
 ; Add the DICOM study send image request to the queue
"RTN","MAGDRPC3",120,0)
 N COUNT,D0,D1,DFN,TYPE,X
"RTN","MAGDRPC3",121,0)
 ;
"RTN","MAGDRPC3",122,0)
 I '$G(IMAGE) S OUT="-1,No Image specified" Q
"RTN","MAGDRPC3",123,0)
 I $G(APPNAM)="" S OUT="-2,No Destination specified" Q
"RTN","MAGDRPC3",124,0)
 I '$G(LOCATION) S OUT="-3,No Origin specified" Q
"RTN","MAGDRPC3",125,0)
 ;
"RTN","MAGDRPC3",126,0)
 S X=$G(^MAG(2005,IMAGE,0))
"RTN","MAGDRPC3",127,0)
 S TYPE=+$P(X,"^",6),DFN=$P(X,"^",7)
"RTN","MAGDRPC3",128,0)
 I " 0 11 3 100 "'[(" "_TYPE_" ") D  Q
"RTN","MAGDRPC3",129,0)
 . S OUT="-4,Cannot Queue Image Object Type """_TYPE_"""."
"RTN","MAGDRPC3",130,0)
 . Q
"RTN","MAGDRPC3",131,0)
 ;
"RTN","MAGDRPC3",132,0)
 L +^MAGDOUTP(2006.574,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC3",133,0)
 S X=$G(^MAGDOUTP(2006.574,0))
"RTN","MAGDRPC3",134,0)
 S $P(X,"^",1,2)="DICOM IMAGE OUTPUT FILE^2006.574"
"RTN","MAGDRPC3",135,0)
 S D0=$O(^MAGDOUTP(2006.574," "),-1)+1 ; Next number
"RTN","MAGDRPC3",136,0)
 S $P(X,"^",3)=D0
"RTN","MAGDRPC3",137,0)
 S $P(X,"^",4)=$P(X,"^",4)+1 ; Total count
"RTN","MAGDRPC3",138,0)
 S ^MAGDOUTP(2006.574,0)=X
"RTN","MAGDRPC3",139,0)
 ;
"RTN","MAGDRPC3",140,0)
 S ^MAGDOUTP(2006.574,D0,0)=APPNAM_"^"_IMAGE_"^"_$G(ACCNUM)_"^"_LOCATION
"RTN","MAGDRPC3",141,0)
 L -^MAGDOUTP(2006.574,0)
"RTN","MAGDRPC3",142,0)
 ;
"RTN","MAGDRPC3",143,0)
 S COUNT=0
"RTN","MAGDRPC3",144,0)
 I (TYPE=3)!(TYPE=100) D  ; Single XRAY or DICOM image
"RTN","MAGDRPC3",145,0)
 . D ENQUEUE(IMAGE,D0,1)
"RTN","MAGDRPC3",146,0)
 . S COUNT=1
"RTN","MAGDRPC3",147,0)
 . Q
"RTN","MAGDRPC3",148,0)
 I TYPE=11 D  ; Process all the images in an XRAY group
"RTN","MAGDRPC3",149,0)
 . S D1=0 F  S D1=$O(^MAG(2005,IMAGE,1,D1)) Q:'D1  D
"RTN","MAGDRPC3",150,0)
 . . D ENQUEUE($P($G(^MAG(2005,IMAGE,1,D1,0)),"^",1),D0,D1)
"RTN","MAGDRPC3",151,0)
 . . S COUNT=COUNT+1
"RTN","MAGDRPC3",152,0)
 . . Q
"RTN","MAGDRPC3",153,0)
 . Q
"RTN","MAGDRPC3",154,0)
 ;
"RTN","MAGDRPC3",155,0)
 S X="DICOM transmit to "_APPNAM_" for reason "_REASON
"RTN","MAGDRPC3",156,0)
 D ENTRY^MAGLOG($C(REASON+64),DUZ,IMAGE,"DICOM Gateway",DFN,COUNT,X)
"RTN","MAGDRPC3",157,0)
 S OUT=1
"RTN","MAGDRPC3",158,0)
 Q
"RTN","MAGDRPC3",159,0)
 ;
"RTN","MAGDRPC3",160,0)
ENQUEUE(IMAGE,D0,D1) ; Add an image to the DICOM send image request queue sub-file
"RTN","MAGDRPC3",161,0)
 Q:'IMAGE
"RTN","MAGDRPC3",162,0)
 L +^MAGDOUTP(2006.574,D0,1,0):1E9 ; Background Process MUST wait
"RTN","MAGDRPC3",163,0)
 S X=$G(^MAGDOUTP(2006.574,D0,1,0))
"RTN","MAGDRPC3",164,0)
 S $P(X,"^",1,2)="^2006.5744"
"RTN","MAGDRPC3",165,0)
 S $P(X,"^",3)=D1
"RTN","MAGDRPC3",166,0)
 S $P(X,"^",4)=$P(X,"^",4)+1,OUT=$P(X,"^",4)
"RTN","MAGDRPC3",167,0)
 S ^MAGDOUTP(2006.574,D0,1,0)=X
"RTN","MAGDRPC3",168,0)
 S ^MAGDOUTP(2006.574,D0,1,D1,0)=IMAGE_"^WAITING^"_$H
"RTN","MAGDRPC3",169,0)
 S ^MAGDOUTP(2006.574,"STS",LOCATION,"WAITING",D0,D1)=""
"RTN","MAGDRPC3",170,0)
 L -^MAGDOUTP(2006.574,D0,1,0)
"RTN","MAGDRPC3",171,0)
 Q
"RTN","MAGDRPC3",172,0)
 ;
"RTN","MAGDRPC3",173,0)
FIND(DATE,CASE,NUM) ; ADC x-reference (Radiology patient file)
"RTN","MAGDRPC3",174,0)
 N X,X1,X2,Y
"RTN","MAGDRPC3",175,0)
 Q:'$G(DATE) 0
"RTN","MAGDRPC3",176,0)
 S (X,X1)=DATE,X2=NUM D:NUM C^%DTC Q:X<1 0
"RTN","MAGDRPC3",177,0)
 Q $O(^RADPT("ADC",$$MMDDYY(X)_"-"_CASE,""))
"RTN","MAGDRPC3",178,0)
 ;
"RTN","MAGDRPC3",179,0)
MMDDYY(DAY) ; YYYMMDD --> MMDDYY
"RTN","MAGDRPC3",180,0)
 I DAY'?7N Q 0
"RTN","MAGDRPC3",181,0)
 Q $E(DAY,4,7)_$E(DAY,2,3)
"RTN","MAGDRPC3",182,0)
 ;
"RTN","MAGDRPC4")
0^40^B72718318
"RTN","MAGDRPC4",1,0)
MAGDRPC4 ;WOIFO/EdM - Imaging RPCs ; 01/26/2005  14:31
"RTN","MAGDRPC4",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDRPC4",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC4",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC4",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC4",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC4",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC4",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC4",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC4",10,0)
 ;; |                                                               |
"RTN","MAGDRPC4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC4",17,0)
 ;;
"RTN","MAGDRPC4",18,0)
 Q
"RTN","MAGDRPC4",19,0)
 ;
"RTN","MAGDRPC4",20,0)
LOOKUP(OUT,NUMBER) ; RPC = MAG DICOM LOOKUP STUDY
"RTN","MAGDRPC4",21,0)
 ; Look Up for both Radiology and Consults
"RTN","MAGDRPC4",22,0)
 N ACCNUM ;--- Accession Number
"RTN","MAGDRPC4",23,0)
 N CPTCODE ;-- CPT code for the procedure
"RTN","MAGDRPC4",24,0)
 N CPTNAME ;-- CPT name for the procedure
"RTN","MAGDRPC4",25,0)
 N DFN ;------ Patient pointer
"RTN","MAGDRPC4",26,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDRPC4",27,0)
 N EXAMTYP ;-- Type of exam (Rad or Con)
"RTN","MAGDRPC4",28,0)
 N GMRCIEN ;-- Pointer for GMRC
"RTN","MAGDRPC4",29,0)
 N PROCDESC ;- Procedure description
"RTN","MAGDRPC4",30,0)
 N PROCIEN ;-- Radiology procedure IEN in ^RAMIS(71)
"RTN","MAGDRPC4",31,0)
 N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDRPC4",32,0)
 N RADFN ;---- first level subscript in ^RADPT
"RTN","MAGDRPC4",33,0)
 N RADTI ;---- second level subscript in ^RADPT (after "DT")
"RTN","MAGDRPC4",34,0)
 N RACNI ;---- third level subscript in ^RADPT (after "P")
"RTN","MAGDRPC4",35,0)
 N RARPT ;---- Radiology Report pointer
"RTN","MAGDRPC4",36,0)
 N I,LIST,NOUT,X,Z
"RTN","MAGDRPC4",37,0)
 ;
"RTN","MAGDRPC4",38,0)
 K OUT S NOUT=1
"RTN","MAGDRPC4",39,0)
 I $G(NUMBER)="" S OUT(1)="-1,No Case or Consult Number Specified" Q
"RTN","MAGDRPC4",40,0)
 ;
"RTN","MAGDRPC4",41,0)
 S EXAMTYP=$E(NUMBER,1)
"RTN","MAGDRPC4",42,0)
 I "RC"[EXAMTYP S NUMBER=$E(NUMBER,2,$L(NUMBER))
"RTN","MAGDRPC4",43,0)
 E  S EXAMTYP=""
"RTN","MAGDRPC4",44,0)
 K DFN
"RTN","MAGDRPC4",45,0)
 D  ; First try Radiology candidates
"RTN","MAGDRPC4",46,0)
 . I EXAMTYP'="",EXAMTYP'="R" Q
"RTN","MAGDRPC4",47,0)
 . D  ; Look for the patient/study in ^RADPT using the Radiology Case Number
"RTN","MAGDRPC4",48,0)
 . . N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDRPC4",49,0)
 . . S RAIX=$S($D(^RADPT("C")):"C",1:"AE") ; for Radiology Patch RA*5*7
"RTN","MAGDRPC4",50,0)
 . . S RAIX=$S(NUMBER["-":"ADC",1:RAIX) ; select the cross-reference
"RTN","MAGDRPC4",51,0)
 . . S RADFN=$O(^RADPT(RAIX,NUMBER,"")) I 'RADFN D  Q:'RADFN
"RTN","MAGDRPC4",52,0)
 . . . I NUMBER'["-" S OUT(1)="-2,No Study Date Specified" Q
"RTN","MAGDRPC4",53,0)
 . . . S X=$P(NUMBER,"-",1)
"RTN","MAGDRPC4",54,0)
 . . . I $L(X)'=6 S OUT(1)="-3,Invalid study date """_X_"""." Q
"RTN","MAGDRPC4",55,0)
 . . . S SDATE=$S($E(X,5,6)<30:3,1:2)_$E(X,5,6)_$E(X,1,4)
"RTN","MAGDRPC4",56,0)
 . . . D:SDATE
"RTN","MAGDRPC4",57,0)
 . . . . ; Search 1-3 days prior the study date OR a day in advance but only
"RTN","MAGDRPC4",58,0)
 . . . . ; if the study date is not equal to today or greater than today.
"RTN","MAGDRPC4",59,0)
 . . . . ; Has to be long case number or must have an image study date
"RTN","MAGDRPC4",60,0)
 . . . . N %,%I,II,RCASE,TODAY,X,Y
"RTN","MAGDRPC4",61,0)
 . . . . S RCASE=$S(NUMBER["-":$P(NUMBER,"-",2),1:NUMBER) Q:'RCASE
"RTN","MAGDRPC4",62,0)
 . . . . D NOW^%DTC S TODAY=X
"RTN","MAGDRPC4",63,0)
 . . . . ;
"RTN","MAGDRPC4",64,0)
 . . . . ;  1-3 days prior study date
"RTN","MAGDRPC4",65,0)
 . . . . F II=1:1:3 S RADFN=$$FIND(SDATE,RCASE,-II) Q:RADFN
"RTN","MAGDRPC4",66,0)
 . . . . Q:RADFN
"RTN","MAGDRPC4",67,0)
 . . . . ;
"RTN","MAGDRPC4",68,0)
 . . . . ; Wild goose chase but check for today's case
"RTN","MAGDRPC4",69,0)
 . . . . S RADFN=$O(^RADPT("ADC",$$MMDDYY(TODAY)_"-"_RCASE,"")) Q:RADFN
"RTN","MAGDRPC4",70,0)
 . . . . ;
"RTN","MAGDRPC4",71,0)
 . . . . Q:SDATE'<TODAY
"RTN","MAGDRPC4",72,0)
 . . . . S RADFN=$$FIND(SDATE,RCASE,1) Q:RADFN  ; Advance a day
"RTN","MAGDRPC4",73,0)
 . . . . ;
"RTN","MAGDRPC4",74,0)
 . . . . ; Finally just check the "C" or "AE" x-reference for the case number
"RTN","MAGDRPC4",75,0)
 . . . . ; based on RA*5*7 patch
"RTN","MAGDRPC4",76,0)
 . . . . S RADFN=$O(^RADPT($S($O(^RADPT("C","")):"C",1:"AE"),RCASE,""))
"RTN","MAGDRPC4",77,0)
 . . . . Q
"RTN","MAGDRPC4",78,0)
 . . . Q
"RTN","MAGDRPC4",79,0)
 . . S RADTI=$O(^RADPT(RAIX,NUMBER,RADFN,"")) Q:'RADTI
"RTN","MAGDRPC4",80,0)
 . . S RACNI=$O(^RADPT(RAIX,NUMBER,RADFN,RADTI,"")) Q:'RACNI
"RTN","MAGDRPC4",81,0)
 . . Q:'$D(^RADPT(RADFN,0))  ; No patient demographics file pointer
"RTN","MAGDRPC4",82,0)
 . . S DFN=$P(^RADPT(RADFN,0),"^",1)
"RTN","MAGDRPC4",83,0)
 . . Q
"RTN","MAGDRPC4",84,0)
 . Q:'$G(DFN)
"RTN","MAGDRPC4",85,0)
 . Q:'$D(^RADPT(DFN,"DT",RADTI,0))
"RTN","MAGDRPC4",86,0)
 . S RARPT=$P($G(^RADPT(DFN,"DT",RADTI,"P",RACNI,0)),"^",17) Q:'RARPT
"RTN","MAGDRPC4",87,0)
 . S ACCNUM=$P($G(^RARPT(RARPT,0)),"^",1)
"RTN","MAGDRPC4",88,0)
 . S I=0 F  S I=$O(^RARPT(RARPT,2005,I)) Q:'I  D
"RTN","MAGDRPC4",89,0)
 . . S X="74^"_RARPT_"^"_$P($G(^RARPT(RARPT,2005,I,0)),"^",1)_"^"_ACCNUM
"RTN","MAGDRPC4",90,0)
 . . S NOUT=NOUT+1,OUT(NOUT)=X
"RTN","MAGDRPC4",91,0)
 . . Q
"RTN","MAGDRPC4",92,0)
 . Q
"RTN","MAGDRPC4",93,0)
 ;
"RTN","MAGDRPC4",94,0)
 K DFN
"RTN","MAGDRPC4",95,0)
 D  ; Now look for any consults that might qualify
"RTN","MAGDRPC4",96,0)
 . N ACCNUM,MAGIEN,MAGPTR,REPORTF,REPORTI,TIUIEN,TIUPTR,TIUXIEN
"RTN","MAGDRPC4",97,0)
 . I EXAMTYP'="",EXAMTYP'="C" Q
"RTN","MAGDRPC4",98,0)
 . S ACCNUM="GMRC-"_$S(NUMBER?1"GMRC-"1.N:$P(NUMBER,"GMRC-",2),1:NUMBER)
"RTN","MAGDRPC4",99,0)
 . S GMRCIEN=$P(ACCNUM,"-",2)
"RTN","MAGDRPC4",100,0)
 . D
"RTN","MAGDRPC4",101,0)
 . . N D0,Z
"RTN","MAGDRPC4",102,0)
 . . S D0=$P(ACCNUM,"-",2)
"RTN","MAGDRPC4",103,0)
 . . S DFN=$$GET1^DIQ(123,D0,.02,"I") Q:'DFN
"RTN","MAGDRPC4",104,0)
 . . S EXAMSTS=$$GET1^DIQ(123,D0,8) ; check for cancelled exam
"RTN","MAGDRPC4",105,0)
 . . I EXAMSTS="CANCELLED" S OUT(1)="-4,Consult is cancelled" Q
"RTN","MAGDRPC4",106,0)
 . . S PROCDESC=$$GET1^DIQ(123,D0,1)
"RTN","MAGDRPC4",107,0)
 . . S Z=$$GET1^DIQ(123,D0,13,"I") ; request type
"RTN","MAGDRPC4",108,0)
 . . Q
"RTN","MAGDRPC4",109,0)
 . I '$G(DFN) S OUT(1)="-5,Consult/procedure not on file" Q
"RTN","MAGDRPC4",110,0)
 . ; Find the images - they can be linked to TIU or imaging file 2006.5839
"RTN","MAGDRPC4",111,0)
 . S MAGPTR=$O(^MAG(2006.5839,"C",123,GMRCIEN,0))
"RTN","MAGDRPC4",112,0)
 . I MAGPTR D  Q  ; Found it in ^MAG(2006.5839 - not in ^TIU yet
"RTN","MAGDRPC4",113,0)
 . . S X=^MAG(2006.5839,MAGPTR,0)
"RTN","MAGDRPC4",114,0)
 . . S X=$P(X,"^",1)_"^"_$P(X,"^",2)_"^^"_$P(X,"^",3)
"RTN","MAGDRPC4",115,0)
 . . S NOUT=NOUT+1,OUT(NOUT)=X
"RTN","MAGDRPC4",116,0)
 . . Q
"RTN","MAGDRPC4",117,0)
 . D  ; Otherwise find images in ^TIU
"RTN","MAGDRPC4",118,0)
 . . N I,X
"RTN","MAGDRPC4",119,0)
 . . D TIUALL^MAGDGMRC(GMRCIEN,.RESULT)
"RTN","MAGDRPC4",120,0)
 . . S I="" F  S I=$O(RESULT(I)) Q:I=""  D
"RTN","MAGDRPC4",121,0)
 . . . S X="8925^"_$P(RESULT(I),"^",1)_"^"_$P(RESULT(I),"^",3)_"^"_$P(RESULT(I),"^",2)
"RTN","MAGDRPC4",122,0)
 . . . S NOUT=NOUT+1,OUT(NOUT)=X
"RTN","MAGDRPC4",123,0)
 . . . Q
"RTN","MAGDRPC4",124,0)
 . . Q
"RTN","MAGDRPC4",125,0)
 . Q
"RTN","MAGDRPC4",126,0)
 S OUT(1)=NOUT-1
"RTN","MAGDRPC4",127,0)
 Q
"RTN","MAGDRPC4",128,0)
 ;
"RTN","MAGDRPC4",129,0)
NEXTIMG(OUT,FROM,D0,D1,SENT) ; RPC = MAG DICOM GET NEXT QUEUE ENTRY
"RTN","MAGDRPC4",130,0)
 ; Get next file to be DICOM transmitted
"RTN","MAGDRPC4",131,0)
 N H,F1,F2,F3,I,LOC,N,S0,S1,STS,TYPE,X
"RTN","MAGDRPC4",132,0)
 I $G(FROM)="" S OUT(1)="-1,No Origin Specified"
"RTN","MAGDRPC4",133,0)
 ; First clean up transmitted queue entries
"RTN","MAGDRPC4",134,0)
 S I="" F  S I=$O(SENT(I)) Q:I=""  D
"RTN","MAGDRPC4",135,0)
 . S S0=$P(SENT(I),"^",1),S1=$P(SENT(I),"^",2)
"RTN","MAGDRPC4",136,0)
 . Q:'$D(^MAGDOUTP(2006.574,S0,1,S1))
"RTN","MAGDRPC4",137,0)
 . L +^MAGDOUTP(2006.574,S0,1,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC4",138,0)
 . S LOC=$P($G(^MAGDOUTP(2006.574,S0,0)),"^",4)
"RTN","MAGDRPC4",139,0)
 . S STS=$P($G(^MAGDOUTP(2006.574,S0,1,S1,0)),"^",2)
"RTN","MAGDRPC4",140,0)
 . K ^MAGDOUTP(2006.574,S0,1,S1)
"RTN","MAGDRPC4",141,0)
 . I LOC'="",STS'="" K ^MAGDOUTP(2006.574,"STS",LOC,STS,S0,S1)
"RTN","MAGDRPC4",142,0)
 . S X=$G(^MAGDOUTP(2006.574,S0,1,0))
"RTN","MAGDRPC4",143,0)
 . S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC4",144,0)
 . S ^MAGDOUTP(2006.574,S0,1,0)=X
"RTN","MAGDRPC4",145,0)
 . L -^MAGDOUTP(2006.574,S0,1,0)
"RTN","MAGDRPC4",146,0)
 . Q:$O(^MAGDOUTP(2006.574,S0,1,0))
"RTN","MAGDRPC4",147,0)
 . L +^MAGDOUTP(2006.574,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC4",148,0)
 . K ^MAGDOUTP(2006.574,S0)
"RTN","MAGDRPC4",149,0)
 . S X=$G(^MAGDOUTP(2006.574,0))
"RTN","MAGDRPC4",150,0)
 . S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC4",151,0)
 . S ^MAGDOUTP(2006.574,0)=X
"RTN","MAGDRPC4",152,0)
 . L -^MAGDOUTP(2006.574,0)
"RTN","MAGDRPC4",153,0)
 . Q
"RTN","MAGDRPC4",154,0)
 S H=$$SECOND($H)
"RTN","MAGDRPC4",155,0)
 L +^MAGDOUTP(2006.574,"STS"):1E9 ; Background process MUST wait
"RTN","MAGDRPC4",156,0)
 S S0="" F  S S0=$O(^MAGDOUTP(2006.574,"STS",FROM,"XMIT",S0)) Q:S0=""  D
"RTN","MAGDRPC4",157,0)
 . S S1="" F  S S1=$O(^MAGDOUTP(2006.574,"STS",FROM,"XMIT",S0,S1)) Q:S1=""  D
"RTN","MAGDRPC4",158,0)
 . . S X=$$SECOND($P($G(^MAGDOUTP(2006.574,S0,1,S1,0),"^^"_$H),"^",3))
"RTN","MAGDRPC4",159,0)
 . . Q:H-X<300
"RTN","MAGDRPC4",160,0)
 . . S $P(^MAGDOUTP(2006.574,S0,1,S1,0),"^",2)="WAITING"
"RTN","MAGDRPC4",161,0)
 . . K ^MAGDOUTP(2006.574,"STS",FROM,"XMIT",S0,S1)
"RTN","MAGDRPC4",162,0)
 . . S ^MAGDOUTP(2006.574,"STS",FROM,"WAITING",S0,S1)=""
"RTN","MAGDRPC4",163,0)
 . . Q
"RTN","MAGDRPC4",164,0)
 . Q
"RTN","MAGDRPC4",165,0)
 S OUT(1)=""
"RTN","MAGDRPC4",166,0)
 S S0="" F  S S0=$O(^MAGDOUTP(2006.574,"STS",FROM,"WAITING",S0)) Q:S0=""  D  Q:OUT(1)'=""
"RTN","MAGDRPC4",167,0)
 . S S1="" F  S S1=$O(^MAGDOUTP(2006.574,"STS",FROM,"WAITING",S0,S1)) Q:S1=""  D  Q:OUT(1)'=""
"RTN","MAGDRPC4",168,0)
 . . S $P(^MAGDOUTP(2006.574,S0,1,S1,0),"^",2,3)="XMIT^"_$H
"RTN","MAGDRPC4",169,0)
 . . K ^MAGDOUTP(2006.574,"STS",FROM,"WAITING",S0,S1)
"RTN","MAGDRPC4",170,0)
 . . S ^MAGDOUTP(2006.574,"STS",FROM,"XMIT",S0,S1)=""
"RTN","MAGDRPC4",171,0)
 . . S OUT(1)=1
"RTN","MAGDRPC4",172,0)
 . . S OUT(2)=S0
"RTN","MAGDRPC4",173,0)
 . . S OUT(3)=S1
"RTN","MAGDRPC4",174,0)
 . . S X=$G(^MAGDOUTP(2006.574,S0,0))
"RTN","MAGDRPC4",175,0)
 . . S OUT(4)=$P(X,"^",1) ; Application
"RTN","MAGDRPC4",176,0)
 . . S OUT(5)=$P(X,"^",2) ; Group
"RTN","MAGDRPC4",177,0)
 . . S OUT(6)=$P(X,"^",3) ; Accession Number
"RTN","MAGDRPC4",178,0)
 . . S OUT(7)=+$G(^MAGDOUTP(2006.574,S0,1,S1,0)) ; Image
"RTN","MAGDRPC4",179,0)
 . . S OUT(8)=$P($G(^MAG(2005,+OUT(7),0)),"^",6)
"RTN","MAGDRPC4",180,0)
 . . S TYPE=$S($G(^MAG(2005,+OUT(7),"FBIG"))'="":"BIG",1:"FULL")
"RTN","MAGDRPC4",181,0)
 . . ; 3rd parameter set to 1 to allow retrieval from jukebox
"RTN","MAGDRPC4",182,0)
 . . D FILEFIND^MAGDFB(+OUT(7),TYPE,1,0,.F1,.F2)
"RTN","MAGDRPC4",183,0)
 . . S OUT(9)=F1
"RTN","MAGDRPC4",184,0)
 . . S OUT(10)=F2
"RTN","MAGDRPC4",185,0)
 . . S OUT(11)=$P($G(^MAG(2005,+OUT(5),0)),"^",7) ; get DFN
"RTN","MAGDRPC4",186,0)
 . . ; get path for *.TXT, always the same as the FULL file
"RTN","MAGDRPC4",187,0)
 . . D FILEFIND^MAGDFB(+OUT(7),"FULL",1,0,.F1,.F3)
"RTN","MAGDRPC4",188,0)
 . . S OUT(12)=F3
"RTN","MAGDRPC4",189,0)
 . . Q
"RTN","MAGDRPC4",190,0)
 . Q
"RTN","MAGDRPC4",191,0)
 S:OUT(1)="" OUT(1)="-2,Nothing to be transmitted."
"RTN","MAGDRPC4",192,0)
 L -^MAGDOUTP(2006.574,"STS")
"RTN","MAGDRPC4",193,0)
 Q
"RTN","MAGDRPC4",194,0)
 ;
"RTN","MAGDRPC4",195,0)
FIND(DATE,CASE,NUM) ;
"RTN","MAGDRPC4",196,0)
 ; Use the ADC x-reference in the radiology patient file
"RTN","MAGDRPC4",197,0)
 N NDATE,X,X1,X2,Y
"RTN","MAGDRPC4",198,0)
 S X1=DATE,X2=NUM D C^%DTC S NDATE=X
"RTN","MAGDRPC4",199,0)
 I NDATE<1 Q 0
"RTN","MAGDRPC4",200,0)
 S NDATE=$$MMDDYY(NDATE)
"RTN","MAGDRPC4",201,0)
 Q $O(^RADPT("ADC",NDATE_"-"_CASE,""))
"RTN","MAGDRPC4",202,0)
 ;
"RTN","MAGDRPC4",203,0)
MMDDYY(DAY) ; Convert Fileman date to mmddyy
"RTN","MAGDRPC4",204,0)
 I DAY'?7N Q 0
"RTN","MAGDRPC4",205,0)
 Q $E(DAY,4,7)_$E(DAY,2,3)
"RTN","MAGDRPC4",206,0)
 ;
"RTN","MAGDRPC4",207,0)
INIT(OUT,LOCATION) ; RPC = MAG DICOM QUEUE INIT
"RTN","MAGDRPC4",208,0)
 N D0,N,STS
"RTN","MAGDRPC4",209,0)
 I '$G(LOCATION) S OUT="-3,No origin specified." Q
"RTN","MAGDRPC4",210,0)
 I '$D(^MAGDOUTP(2006.574,0)) S OUT="-1,No entries at all in queue." Q
"RTN","MAGDRPC4",211,0)
 ;
"RTN","MAGDRPC4",212,0)
 S N=0,STS="" F  S STS=$O(^MAGDOUTP(2006.574,"STS",LOCATION,STS)) Q:STS=""  D
"RTN","MAGDRPC4",213,0)
 . S D0="" F  S D0=$O(^MAGDOUTP(2006.574,"STS",LOCATION,STS,D0)) Q:D0=""  D
"RTN","MAGDRPC4",214,0)
 . . K ^MAGDOUTP(2006.574,D0)
"RTN","MAGDRPC4",215,0)
 . . K ^MAGDOUTP(2006.574,"STS",LOCATION,STS,D0)
"RTN","MAGDRPC4",216,0)
 . . S N=N+1
"RTN","MAGDRPC4",217,0)
 . . Q
"RTN","MAGDRPC4",218,0)
 . Q
"RTN","MAGDRPC4",219,0)
 ;
"RTN","MAGDRPC4",220,0)
 I 'N S OUT="-2,No entries present for "_$$GET1^DIQ(4,LOCATION,.01)_"." Q
"RTN","MAGDRPC4",221,0)
 ;
"RTN","MAGDRPC4",222,0)
 S $P(^MAGDOUTP(2006.574,0),"^",4)=$P(^MAGDOUTP(2006.574,0),"^",4)-N
"RTN","MAGDRPC4",223,0)
 S OUT=N_" entr"_$S(N=1:"y",1:"ies")_" removed from Image Transmission Queue."
"RTN","MAGDRPC4",224,0)
 Q
"RTN","MAGDRPC4",225,0)
 ;
"RTN","MAGDRPC4",226,0)
SECOND(H) Q H*86400+$P(H,",",2)
"RTN","MAGDRPC4",227,0)
 ;
"RTN","MAGDRPC5")
0^41^B79459148
"RTN","MAGDRPC5",1,0)
MAGDRPC5 ;WOIFO/EdM - Routing RPCs ; 06/06/2005  07:20
"RTN","MAGDRPC5",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDRPC5",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC5",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC5",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC5",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC5",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC5",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC5",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC5",10,0)
 ;; |                                                               |
"RTN","MAGDRPC5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC5",17,0)
 ;;
"RTN","MAGDRPC5",18,0)
 Q
"RTN","MAGDRPC5",19,0)
 ;
"RTN","MAGDRPC5",20,0)
START(OUT,LOCATION,RULES) ; RPC = MAG DICOM ROUTE EVAL START
"RTN","MAGDRPC5",21,0)
 N I,LOC,X,ZTDESC,ZTDTH,ZTRTN,ZTSAVE
"RTN","MAGDRPC5",22,0)
 ;
"RTN","MAGDRPC5",23,0)
 D XTINIT
"RTN","MAGDRPC5",24,0)
 ;
"RTN","MAGDRPC5",25,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC5",26,0)
 I '$O(RULES("")) S OUT="-2,No Routing Rules Specified" Q
"RTN","MAGDRPC5",27,0)
 ;
"RTN","MAGDRPC5",28,0)
 S LOC=$$GET1^DIQ(4,LOCATION,.01)
"RTN","MAGDRPC5",29,0)
 L +^MAGDICOM(2006.563,1,"EVAL",LOCATION):0 E  D  Q
"RTN","MAGDRPC5",30,0)
 . S OUT="-3,A Rule Evaluator is Already Running for "_LOC
"RTN","MAGDRPC5",31,0)
 . Q
"RTN","MAGDRPC5",32,0)
 ;
"RTN","MAGDRPC5",33,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=1
"RTN","MAGDRPC5",34,0)
 S ZTRTN="EVAL^MAGBRTE4"
"RTN","MAGDRPC5",35,0)
 S ZTDESC="Evaluate Routing Rules for Origin="_LOC
"RTN","MAGDRPC5",36,0)
 S ZTDTH=$H
"RTN","MAGDRPC5",37,0)
 S ZTSAVE("LOCATION")=LOCATION
"RTN","MAGDRPC5",38,0)
 S I="" F  S I=$O(RULES(I)) Q:I=""  S:+I=I ZTSAVE("RULES("_I_")")=RULES(I)
"RTN","MAGDRPC5",39,0)
 D ^%ZTLOAD,HOME^%ZIS
"RTN","MAGDRPC5",40,0)
 L -^MAGDICOM(2006.563,1,"EVAL",LOCATION)
"RTN","MAGDRPC5",41,0)
 I '$D(ZTSK) S OUT="-4,TaskMan did not Accept Request" Q
"RTN","MAGDRPC5",42,0)
 S OUT="0,TaskMan task#="_ZTSK
"RTN","MAGDRPC5",43,0)
 Q
"RTN","MAGDRPC5",44,0)
 ;
"RTN","MAGDRPC5",45,0)
STOP(OUT) ; RPC = MAG DICOM ROUTE EVAL STOP
"RTN","MAGDRPC5",46,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=0,OUT=1
"RTN","MAGDRPC5",47,0)
 Q
"RTN","MAGDRPC5",48,0)
 ;
"RTN","MAGDRPC5",49,0)
XMIT(OUT,LOCATION,DEST,PRIOR,MECH,DESTS) ; RPC = MAG DICOM ROUTE NEXT FILE
"RTN","MAGDRPC5",50,0)
 N D0,DIR,DL,IM,M,OK,PLACE,TP,VP,X
"RTN","MAGDRPC5",51,0)
 ;
"RTN","MAGDRPC5",52,0)
 S PLACE=$$PLACE^MAGDRPC2(LOCATION)
"RTN","MAGDRPC5",53,0)
 S $P(^MAG(2006.1,PLACE,"LASTROUTE"),"^",1)=DT
"RTN","MAGDRPC5",54,0)
 ;
"RTN","MAGDRPC5",55,0)
 K OUT S OUT(1)=0,OK=0
"RTN","MAGDRPC5",56,0)
 S:'$G(MECH) MECH=1 I MECH'=1,MECH'=2 S MECH=1
"RTN","MAGDRPC5",57,0)
 I '$G(LOCATION) S OUT(1)="-1,No Location Specified" Q
"RTN","MAGDRPC5",58,0)
 S VP(1)=";MAG(2005.2,"
"RTN","MAGDRPC5",59,0)
 S VP(2)=";MAG(2006.587,"
"RTN","MAGDRPC5",60,0)
 S:$G(DEST) DEST=+DEST_VP(MECH)
"RTN","MAGDRPC5",61,0)
 S M="" F  S M=$O(DESTS(M)) Q:M=""  D
"RTN","MAGDRPC5",62,0)
 . S X=DESTS(M) Q:X'["^"  Q:$P(X,"^",1)'=MECH  Q:'$P(X,"^",2)
"RTN","MAGDRPC5",63,0)
 . S DL($P(X,"^",2)_VP(MECH))=""
"RTN","MAGDRPC5",64,0)
 . Q
"RTN","MAGDRPC5",65,0)
 I $O(DL(""))="" S OUT(1)="-2,No Valid Destinations Specified" Q
"RTN","MAGDRPC5",66,0)
 S:'$G(DEST) (PRIOR,DEST)=""
"RTN","MAGDRPC5",67,0)
 I $G(PRIOR) D
"RTN","MAGDRPC5",68,0)
 . I DEST S X=0 F  D  Q:X
"RTN","MAGDRPC5",69,0)
 . . I $P($G(^MAG(2005.2,+DEST,0)),"^",6) S X=1 Q
"RTN","MAGDRPC5",70,0)
 . . D NOW^%DTC S %=%*1E6
"RTN","MAGDRPC5",71,0)
 . . S X=$P($G(^MAG(2005.2,+DEST,3)),"^",6)*1E6
"RTN","MAGDRPC5",72,0)
 . . I %-X>1500 D ONOFLINE(.X,+DEST,1) Q
"RTN","MAGDRPC5",73,0)
 . . S X=0,DEST=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST))
"RTN","MAGDRPC5",74,0)
 . . S:'DEST X=1
"RTN","MAGDRPC5",75,0)
 . . Q
"RTN","MAGDRPC5",76,0)
 . I 'DEST S (PRIOR,DEST)="" Q
"RTN","MAGDRPC5",77,0)
 . F  D  Q:OK
"RTN","MAGDRPC5",78,0)
 . . S D0=+$G(D0)
"RTN","MAGDRPC5",79,0)
 . . S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST,D0))
"RTN","MAGDRPC5",80,0)
 . . I 'D0 S OK=1 Q
"RTN","MAGDRPC5",81,0)
 . . S M=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",4) I M'=1,M'=2 S M=1
"RTN","MAGDRPC5",82,0)
 . . I M=MECH S OK=1 Q
"RTN","MAGDRPC5",83,0)
 . . S (PRIOR,DEST)=""
"RTN","MAGDRPC5",84,0)
 . . Q
"RTN","MAGDRPC5",85,0)
 . Q
"RTN","MAGDRPC5",86,0)
 I OK D:$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR))
"RTN","MAGDRPC5",87,0)
 . ;
"RTN","MAGDRPC5",88,0)
 . ; Ignore higher priority items for destinations that are not accessible
"RTN","MAGDRPC5",89,0)
 . ;
"RTN","MAGDRPC5",90,0)
 . N A,D,P,T,X
"RTN","MAGDRPC5",91,0)
 . S P=PRIOR F  S P=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",P)) Q:'P  D  Q:'PRIOR
"RTN","MAGDRPC5",92,0)
 . . S D="" F  S D=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",P,D)) Q:D=""  D  Q:'PRIOR
"RTN","MAGDRPC5",93,0)
 . . . ; Interrupt only if we're transmitting there
"RTN","MAGDRPC5",94,0)
 . . . Q:'$D(DL(D))
"RTN","MAGDRPC5",95,0)
 . . . ;
"RTN","MAGDRPC5",96,0)
 . . . D:'$P(^MAG(2005.2,+D,0),"^",6)
"RTN","MAGDRPC5",97,0)
 . . . . D NOW^%DTC S %=%*1E6
"RTN","MAGDRPC5",98,0)
 . . . . S X=$P($G(^MAG(2005.2,+D,3)),"^",6)*1E6 Q:%-X<1500
"RTN","MAGDRPC5",99,0)
 . . . . D ONOFLINE(.X,+D,1)
"RTN","MAGDRPC5",100,0)
 . . . . Q
"RTN","MAGDRPC5",101,0)
 . . . S:$P(^MAG(2005.2,+D,0),"^",6) PRIOR=0
"RTN","MAGDRPC5",102,0)
 . . . Q
"RTN","MAGDRPC5",103,0)
 . . Q
"RTN","MAGDRPC5",104,0)
 . Q
"RTN","MAGDRPC5",105,0)
 I '$G(PRIOR) F  D  Q:OK  Q:'PRIOR
"RTN","MAGDRPC5",106,0)
 . S PRIOR=" " F  S PRIOR=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR),-1) Q:'PRIOR  D  Q:OK
"RTN","MAGDRPC5",107,0)
 . . S DEST="" F  S DEST=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST)) Q:DEST=""  D:$D(DL(DEST))  Q:OK
"RTN","MAGDRPC5",108,0)
 . . . D:'$P(^MAG(2005.2,+DEST,0),"^",6)
"RTN","MAGDRPC5",109,0)
 . . . . D NOW^%DTC S %=%*1E6
"RTN","MAGDRPC5",110,0)
 . . . . S X=$P($G(^MAG(2005.2,+DEST,3)),"^",6)*1E6 Q:%-X<1500
"RTN","MAGDRPC5",111,0)
 . . . . D ONOFLINE(.X,+DEST,1)
"RTN","MAGDRPC5",112,0)
 . . . . Q
"RTN","MAGDRPC5",113,0)
 . . . Q:'$P(^MAG(2005.2,+DEST,0),"^",6)
"RTN","MAGDRPC5",114,0)
 . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST,D0)) Q:D0=""  D  Q:OK
"RTN","MAGDRPC5",115,0)
 . . . . S M=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",4) I M'=1,M'=2 S M=1
"RTN","MAGDRPC5",116,0)
 . . . . I M=MECH S OK=1 Q
"RTN","MAGDRPC5",117,0)
 . . . . Q
"RTN","MAGDRPC5",118,0)
 . . . Q
"RTN","MAGDRPC5",119,0)
 . . Q
"RTN","MAGDRPC5",120,0)
 . Q
"RTN","MAGDRPC5",121,0)
 Q:'PRIOR
"RTN","MAGDRPC5",122,0)
 Q:'OK
"RTN","MAGDRPC5",123,0)
 I 'D0 S OUT(1)=0 Q  ; All files transmitted
"RTN","MAGDRPC5",124,0)
 ;
"RTN","MAGDRPC5",125,0)
 S X=^MAGQUEUE(2006.035,D0,0),IM=$P(X,"^",1),TP=$P(X,"^",3)
"RTN","MAGDRPC5",126,0)
 I 'IM D STATUS(X,D0,"SENT",LOCATION) S OUT(1)=2 Q
"RTN","MAGDRPC5",127,0)
 S OUT(2)=+DEST,OUT(3)=PRIOR,OUT(4)=MECH,OUT(9)=D0
"RTN","MAGDRPC5",128,0)
 S X=$G(^MAG(2005.2,+DEST,2)),OUT(5)=$P(X,"^",1),OUT(6)=$P(X,"^",2)
"RTN","MAGDRPC5",129,0)
 D STATUS(X,D0,"SENDING",LOCATION)
"RTN","MAGDRPC5",130,0)
 S OUT(10)=$P(^MAG(2005.2,+DEST,0),"^",2)
"RTN","MAGDRPC5",131,0)
 S DIR=$P($G(^MAG(2005.2,+DEST,4)),"^",2)
"RTN","MAGDRPC5",132,0)
 S OUT(11)=$G(^MAG(2005.2,+DEST,3))
"RTN","MAGDRPC5",133,0)
 S OUT(12)=IM
"RTN","MAGDRPC5",134,0)
 S OUT(13)=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",3)
"RTN","MAGDRPC5",135,0)
 S OUT(14)=$P($G(^MAG(2005.2,+DEST,1)),"^",7) S:OUT(14)="" OUT(14)="NONE"
"RTN","MAGDRPC5",136,0)
 D XMIT^MAGDRPC6 ; Routine grew over 10,000 characters
"RTN","MAGDRPC5",137,0)
 I MECH=2 S OUT(2)=OUT(2)_"^"_$P($G(^MAG(2006.587,+DEST,0)),"^",1)
"RTN","MAGDRPC5",138,0)
 Q
"RTN","MAGDRPC5",139,0)
 ;
"RTN","MAGDRPC5",140,0)
PURGE(OUT,LOCATION,DEST,MAX,DONE) ; RPC = MAG DICOM ROUTE GET PURGE
"RTN","MAGDRPC5",141,0)
 N D0,D1,FILE,FMFILE,I,LIMIT,MORE,NOW,RETAIN,STAMP,STATUS,X
"RTN","MAGDRPC5",142,0)
 ;
"RTN","MAGDRPC5",143,0)
 D NOW^%DTC S NOW=%
"RTN","MAGDRPC5",144,0)
 K OUT S OUT(1)=1
"RTN","MAGDRPC5",145,0)
 S:$D(^MAG(2005.2,DEST,0)) $P(^MAG(2005.2,DEST,3),"^",4)=DT
"RTN","MAGDRPC5",146,0)
 S X=^MAG(2005.2,DEST,3)
"RTN","MAGDRPC5",147,0)
 S RETAIN=$P(X,"^",1) S:RETAIN="" RETAIN=32 S:RETAIN<0 RETAIN=0
"RTN","MAGDRPC5",148,0)
 S LIMIT=$H-RETAIN
"RTN","MAGDRPC5",149,0)
 ;
"RTN","MAGDRPC5",150,0)
 S X=$G(DONE(1)),MORE="" S:$E(X,1)="^" MORE=$P(X,"^",4,6)
"RTN","MAGDRPC5",151,0)
 ;
"RTN","MAGDRPC5",152,0)
 S I="" F  S I=$O(DONE(I)) Q:I=""  D
"RTN","MAGDRPC5",153,0)
 . N D41,D61
"RTN","MAGDRPC5",154,0)
 . S X=$G(DONE(I))
"RTN","MAGDRPC5",155,0)
 . S D0=$P(X,"^",2),D41=$P(X,"^",3)
"RTN","MAGDRPC5",156,0)
 . S STAMP=$P(X,"^",4)
"RTN","MAGDRPC5",157,0)
 . Q:'D0  Q:'D41
"RTN","MAGDRPC5",158,0)
 . ; Just in case the image is being deleted as this purge is taking place
"RTN","MAGDRPC5",159,0)
 . F FMFILE=2005,2005.1 D
"RTN","MAGDRPC5",160,0)
 . . K ^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D41)
"RTN","MAGDRPC5",161,0)
 . . S D61=$P($G(^MAG(FMFILE,D0,4,D41,0)),"^",7)
"RTN","MAGDRPC5",162,0)
 . . K ^MAG(FMFILE,D0,4,"LOC",DEST,D41)
"RTN","MAGDRPC5",163,0)
 . . K ^MAG(FMFILE,D0,4,D41,0)
"RTN","MAGDRPC5",164,0)
 . . S:D61 $P(^MAG(FMFILE,D0,6,D61,0),"^",5)=NOW
"RTN","MAGDRPC5",165,0)
 . . Q
"RTN","MAGDRPC5",166,0)
 . S MORE=""
"RTN","MAGDRPC5",167,0)
 . Q
"RTN","MAGDRPC5",168,0)
 ;
"RTN","MAGDRPC5",169,0)
 D
"RTN","MAGDRPC5",170,0)
 . N %,%H,%I
"RTN","MAGDRPC5",171,0)
 . S %H=LIMIT D TT^%DTC S LIMIT=X
"RTN","MAGDRPC5",172,0)
 . Q
"RTN","MAGDRPC5",173,0)
 ;
"RTN","MAGDRPC5",174,0)
 S MAX=$G(MAX) S:MAX<1 MAX=100
"RTN","MAGDRPC5",175,0)
 F FMFILE=2005,2005.1 D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",176,0)
 . S STAMP="" F  S STAMP=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP)) Q:STAMP=""  Q:STAMP'<LIMIT  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",177,0)
 . . S D0="" F  S D0=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP,D0)) Q:D0=""  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",178,0)
 . . . S D1="" F  S D1=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D1)) Q:D1=""  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",179,0)
 . . . . I MORE'="",FMFILE_"^"_D0_"^"_D1'=MORE Q
"RTN","MAGDRPC5",180,0)
 . . . . S MORE=""
"RTN","MAGDRPC5",181,0)
 . . . . S FILE=$P($G(^MAG(FMFILE,D0,4,D1,0)),"^",4),STATUS=0
"RTN","MAGDRPC5",182,0)
 . . . . S:FILE="" FILE=$P($G(^MAG(2005.1,D0,4,D1,0)),"^",4)
"RTN","MAGDRPC5",183,0)
 . . . . I FILE="" D  Q
"RTN","MAGDRPC5",184,0)
 . . . . . K ^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D1)
"RTN","MAGDRPC5",185,0)
 . . . . . K ^MAG(FMFILE,D0,4,"LOC",DEST,D1)
"RTN","MAGDRPC5",186,0)
 . . . . . K ^MAG(FMFILE,D0,4,D1,0)
"RTN","MAGDRPC5",187,0)
 . . . . . Q
"RTN","MAGDRPC5",188,0)
 . . . . S OUT(1)=OUT(1)+1,OUT(OUT(1))=FMFILE_"^"_D0_"^"_D1_"^"_STAMP_"^"_FILE
"RTN","MAGDRPC5",189,0)
 . . . . Q
"RTN","MAGDRPC5",190,0)
 . . . Q
"RTN","MAGDRPC5",191,0)
 . . Q
"RTN","MAGDRPC5",192,0)
 . Q
"RTN","MAGDRPC5",193,0)
 Q
"RTN","MAGDRPC5",194,0)
 ;
"RTN","MAGDRPC5",195,0)
STATUS(OUT,D0,STATUS,LOCATION) ; RPC = MAG DICOM ROUTE STATUS
"RTN","MAGDRPC5",196,0)
 ; D0 ------- Internal Entry Number of Send Queue Entry
"RTN","MAGDRPC5",197,0)
 ; STATUS --- New Status
"RTN","MAGDRPC5",198,0)
 N DEST ;---- Internal Entry Number of destination
"RTN","MAGDRPC5",199,0)
 N IMAGE ;--- Internal Entry Number of image
"RTN","MAGDRPC5",200,0)
 N OLD ;----- Old Status Value
"RTN","MAGDRPC5",201,0)
 N ORIGIN ;-- Origin of image
"RTN","MAGDRPC5",202,0)
 N PRIOR ;--- Priority
"RTN","MAGDRPC5",203,0)
 N TYPE ;---- File Type (Big, Text, DICOM, etc)
"RTN","MAGDRPC5",204,0)
 N X0,X1 ;--- Queue data
"RTN","MAGDRPC5",205,0)
 ;
"RTN","MAGDRPC5",206,0)
 I '$G(D0) S OUT="-1,Invalid queue identifier: """_$G(D0)_"""." Q
"RTN","MAGDRPC5",207,0)
 ;
"RTN","MAGDRPC5",208,0)
 S X0=$G(^MAGQUEUE(2006.035,D0,0))
"RTN","MAGDRPC5",209,0)
 S X1=$G(^MAGQUEUE(2006.035,D0,1))
"RTN","MAGDRPC5",210,0)
 S OUT=0
"RTN","MAGDRPC5",211,0)
 ;
"RTN","MAGDRPC5",212,0)
 S DEST=$P(X0,"^",2) Q:DEST=""
"RTN","MAGDRPC5",213,0)
 S PRIOR=$P(X1,"^",2) Q:PRIOR=""
"RTN","MAGDRPC5",214,0)
 S ORIGIN=$P(X0,"^",5)
"RTN","MAGDRPC5",215,0)
 S:'ORIGIN ORIGIN=$G(LOCATION) Q:'ORIGIN
"RTN","MAGDRPC5",216,0)
 S OLD=$P(X1,"^",1),IMAGE=$P(X0,"^",1),TYPE=$P(X0,"^",3)
"RTN","MAGDRPC5",217,0)
 ;
"RTN","MAGDRPC5",218,0)
 K:OLD'="" ^MAGQUEUE(2006.035,"DEST",DEST,OLD,IMAGE,TYPE,D0)
"RTN","MAGDRPC5",219,0)
 K:OLD'="" ^MAGQUEUE(2006.035,"STS",ORIGIN,OLD,PRIOR,DEST,D0)
"RTN","MAGDRPC5",220,0)
 Q:STATUS=""
"RTN","MAGDRPC5",221,0)
 S $P(^MAGQUEUE(2006.035,D0,0),"^",5)=ORIGIN
"RTN","MAGDRPC5",222,0)
 S $P(^MAGQUEUE(2006.035,D0,1),"^",1)=STATUS
"RTN","MAGDRPC5",223,0)
 S ^MAGQUEUE(2006.035,"DEST",DEST,STATUS,IMAGE,TYPE,D0)=""
"RTN","MAGDRPC5",224,0)
 S ^MAGQUEUE(2006.035,"STS",ORIGIN,STATUS,PRIOR,DEST,D0)=""
"RTN","MAGDRPC5",225,0)
 S OUT=1
"RTN","MAGDRPC5",226,0)
 Q
"RTN","MAGDRPC5",227,0)
 ;
"RTN","MAGDRPC5",228,0)
LISTDEST(OUT,LOCATION) ; RPC = MAG DICOM ROUTE LIST DESTI
"RTN","MAGDRPC5",229,0)
 N D0,F,I,X
"RTN","MAGDRPC5",230,0)
 ; Return list of possible routing destinations
"RTN","MAGDRPC5",231,0)
 K OUT
"RTN","MAGDRPC5",232,0)
 S I=1,D0=0 F  S D0=$O(^MAG(2005.2,D0)) Q:'D0  D
"RTN","MAGDRPC5",233,0)
 . S X=$G(^MAG(2005.2,D0,0)) Q:'$P(X,"^",9)
"RTN","MAGDRPC5",234,0)
 . L +^MAGQUEUE("ROUTE",LOCATION,D0):0 S F='$T
"RTN","MAGDRPC5",235,0)
 . L:'F -^MAGQUEUE("ROUTE",LOCATION,D0)
"RTN","MAGDRPC5",236,0)
 . S I=I+1,OUT(I)=D0_"^"_F_"^"_$P(X,"^",1,2)
"RTN","MAGDRPC5",237,0)
 . Q
"RTN","MAGDRPC5",238,0)
 S OUT(1)=I-1
"RTN","MAGDRPC5",239,0)
 Q
"RTN","MAGDRPC5",240,0)
 ;
"RTN","MAGDRPC5",241,0)
LOCK(OUT,D0,LOCATION,PLUSMIN) ; RPC = MAG DICOM ROUTE LOCK TRANSMIT
"RTN","MAGDRPC5",242,0)
 S OUT=0
"RTN","MAGDRPC5",243,0)
 I $G(PLUSMIN) L +^MAGQUEUE("ROUTE",LOCATION,D0):0 S OUT=$T Q
"RTN","MAGDRPC5",244,0)
 L -^MAGQUEUE("ROUTE",LOCATION,D0) S OUT=2
"RTN","MAGDRPC5",245,0)
 Q
"RTN","MAGDRPC5",246,0)
 ;
"RTN","MAGDRPC5",247,0)
ONOFLINE(OUT,DEST,STATUS) ; RPC = MAG DICOM NETWORK STATUS
"RTN","MAGDRPC5",248,0)
 N NET
"RTN","MAGDRPC5",249,0)
 I '$G(DEST) S OUT="-1,No Network Location Specified" Q
"RTN","MAGDRPC5",250,0)
 S STATUS=''$G(STATUS)
"RTN","MAGDRPC5",251,0)
 S NET=$P($G(^MAG(2005.2,DEST,0)),"^",2)
"RTN","MAGDRPC5",252,0)
 K ^MAG(2005.2,"C",NET,0,DEST)
"RTN","MAGDRPC5",253,0)
 K ^MAG(2005.2,"C",NET,1,DEST)
"RTN","MAGDRPC5",254,0)
 S ^MAG(2005.2,"C",NET,STATUS,DEST)=""
"RTN","MAGDRPC5",255,0)
 S $P(^MAG(2005.2,DEST,0),"^",6)=STATUS
"RTN","MAGDRPC5",256,0)
 D NOW^%DTC
"RTN","MAGDRPC5",257,0)
 S $P(^MAG(2005.2,DEST,3),"^",6)=$S(STATUS:"",1:%)
"RTN","MAGDRPC5",258,0)
 S OUT=1
"RTN","MAGDRPC5",259,0)
 Q
"RTN","MAGDRPC5",260,0)
 ;
"RTN","MAGDRPC5",261,0)
XTINIT ;
"RTN","MAGDRPC5",262,0)
 D DT^DICRW
"RTN","MAGDRPC5",263,0)
 S X=$G(^XTMP("MAGEVAL",0))
"RTN","MAGDRPC5",264,0)
 S $P(X,"^",2)=DT
"RTN","MAGDRPC5",265,0)
 S $P(X,"^",3)="Routing Rule Evaluator Log - Can be purged at any time"
"RTN","MAGDRPC5",266,0)
 S ^XTMP("MAGEVAL",0)=X
"RTN","MAGDRPC5",267,0)
 Q
"RTN","MAGDRPC5",268,0)
 ;
"RTN","MAGDRPC6")
0^42^B36593110
"RTN","MAGDRPC6",1,0)
MAGDRPC6 ;WOIFO/EdM - Routing RPCs ; 11/08/2004  11:35
"RTN","MAGDRPC6",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDRPC6",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC6",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC6",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC6",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC6",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC6",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC6",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC6",10,0)
 ;; |                                                               |
"RTN","MAGDRPC6",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC6",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC6",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC6",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC6",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC6",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC6",17,0)
 ;;
"RTN","MAGDRPC6",18,0)
 Q
"RTN","MAGDRPC6",19,0)
 ;
"RTN","MAGDRPC6",20,0)
PURGDONE(OUT,DAYS,LOCATION) ; RPC = MAG DICOM ROUTE PURGE DONE
"RTN","MAGDRPC6",21,0)
 ; Purge Entries from Queue that have been sent successfully
"RTN","MAGDRPC6",22,0)
 N D0,DE,ID,IM,LIM,PR,RT,STS,TP,TX,X
"RTN","MAGDRPC6",23,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC6",24,0)
 ;
"RTN","MAGDRPC6",25,0)
 S OUT=0
"RTN","MAGDRPC6",26,0)
 F STS="SENT","NOT FOUND" D
"RTN","MAGDRPC6",27,0)
 . S PR="" F  S PR=$O(^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR)) Q:PR=""  D
"RTN","MAGDRPC6",28,0)
 . . S DE="" F  S DE=$O(^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR,DE)) Q:DE=""  D
"RTN","MAGDRPC6",29,0)
 . . . S RT=$P($G(^MAG(2005.2,DE,3)),"^",1) S:'RT RT=31
"RTN","MAGDRPC6",30,0)
 . . . S:$G(DAYS)'<1 RT=DAYS
"RTN","MAGDRPC6",31,0)
 . . . S LIM=$H-RT
"RTN","MAGDRPC6",32,0)
 . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR,DE,D0)) Q:D0=""  D
"RTN","MAGDRPC6",33,0)
 . . . . N %H,%T,%Y
"RTN","MAGDRPC6",34,0)
 . . . . S X=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",4)\1 D H^%DTC
"RTN","MAGDRPC6",35,0)
 . . . . Q:%H'<LIM
"RTN","MAGDRPC6",36,0)
 . . . . S X=$G(^MAGQUEUE(2006.035,D0,0)),IM=$P(X,"^",1),TP=$P(X,"^",3),ID=$P(X,"^",6)
"RTN","MAGDRPC6",37,0)
 . . . . K ^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR,DE,D0)
"RTN","MAGDRPC6",38,0)
 . . . . K:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)
"RTN","MAGDRPC6",39,0)
 . . . . I IM'="",TP'="" K ^MAGQUEUE(2006.035,"DEST",DE,STS,IM,TP,D0)
"RTN","MAGDRPC6",40,0)
 . . . . K ^MAGQUEUE(2006.035,D0)
"RTN","MAGDRPC6",41,0)
 . . . . S OUT=OUT+1
"RTN","MAGDRPC6",42,0)
 . . . . Q
"RTN","MAGDRPC6",43,0)
 . . . Q
"RTN","MAGDRPC6",44,0)
 . . Q
"RTN","MAGDRPC6",45,0)
 . S DE="" F  S DE=$O(^MAGQUEUE(2006.035,"DEST",DE)) Q:DE=""  D
"RTN","MAGDRPC6",46,0)
 . . S IM="" F  S IM=$O(^MAGQUEUE(2006.035,"DEST",DE,STS,IM)) Q:IM=""  D
"RTN","MAGDRPC6",47,0)
 . . . S TP="" F  S TP=$O(^MAGQUEUE(2006.035,"DEST",DE,STS,IM,TP)) Q:TP=""  D
"RTN","MAGDRPC6",48,0)
 . . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"DEST",DE,STS,IM,TP,D0)) Q:D0=""  D
"RTN","MAGDRPC6",49,0)
 . . . . . S PR=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",2)
"RTN","MAGDRPC6",50,0)
 . . . . . S ID=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",6)
"RTN","MAGDRPC6",51,0)
 . . . . . K ^MAGQUEUE(2006.035,D0)
"RTN","MAGDRPC6",52,0)
 . . . . . K:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)
"RTN","MAGDRPC6",53,0)
 . . . . . K ^MAGQUEUE(2006.035,"DEST",DE,STS,IM,TP,D0)
"RTN","MAGDRPC6",54,0)
 . . . . . K:PR'="" ^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR,DE,D0)
"RTN","MAGDRPC6",55,0)
 . . . . . S OUT=OUT+1
"RTN","MAGDRPC6",56,0)
 . . . . . Q
"RTN","MAGDRPC6",57,0)
 . . . . Q
"RTN","MAGDRPC6",58,0)
 . . . Q
"RTN","MAGDRPC6",59,0)
 . . Q
"RTN","MAGDRPC6",60,0)
 . Q
"RTN","MAGDRPC6",61,0)
 S D0=0 F  S D0=$O(^MAGQUEUE(2006.035,D0)) Q:'D0  D
"RTN","MAGDRPC6",62,0)
 . S X=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",1) I X'="SENT",X'="NOT FOUND" Q
"RTN","MAGDRPC6",63,0)
 . S ID=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",6)
"RTN","MAGDRPC6",64,0)
 . K ^MAGQUEUE(2006.035,D0)
"RTN","MAGDRPC6",65,0)
 . K:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)
"RTN","MAGDRPC6",66,0)
 . S OUT=OUT+1
"RTN","MAGDRPC6",67,0)
 . Q
"RTN","MAGDRPC6",68,0)
 Q
"RTN","MAGDRPC6",69,0)
 ;
"RTN","MAGDRPC6",70,0)
REQUEUE(OUT,LOCATION) ; RPC = MAG DICOM ROUTE REQUEUE
"RTN","MAGDRPC6",71,0)
 ; ReQueue Files that Failed during transmission
"RTN","MAGDRPC6",72,0)
 N D0,DE,FL,IM,PR,TP,WW,X
"RTN","MAGDRPC6",73,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC6",74,0)
 ;
"RTN","MAGDRPC6",75,0)
 S WW="WAITING",OUT=0
"RTN","MAGDRPC6",76,0)
 F FL="FAILED","SENDING" D
"RTN","MAGDRPC6",77,0)
 . S PR="" F  S PR=$O(^MAGQUEUE(2006.035,"STS",LOCATION,FL,PR)) Q:PR=""  D
"RTN","MAGDRPC6",78,0)
 . . S DE="" F  S DE=$O(^MAGQUEUE(2006.035,"STS",LOCATION,FL,PR,DE)) Q:DE=""  D
"RTN","MAGDRPC6",79,0)
 . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,FL,PR,DE,D0)) Q:D0=""  D
"RTN","MAGDRPC6",80,0)
 . . . . K ^MAGQUEUE(2006.035,"STS",LOCATION,FL,PR,DE,D0)
"RTN","MAGDRPC6",81,0)
 . . . . I '$D(^MAGQUEUE(2006.035,D0,0)) K ^MAGQUEUE(2006.035,D0) Q
"RTN","MAGDRPC6",82,0)
 . . . . S $P(^MAGQUEUE(2006.035,D0,1),"^",1)=WW
"RTN","MAGDRPC6",83,0)
 . . . . S ^MAGQUEUE(2006.035,"STS",LOCATION,WW,PR,DE,D0)=""
"RTN","MAGDRPC6",84,0)
 . . . . S X=^MAGQUEUE(2006.035,D0,0),IM=$P(X,"^",1),TP=$P(X,"^",3)
"RTN","MAGDRPC6",85,0)
 . . . . I IM'="",TP'="" K ^MAGQUEUE(2006.035,"DEST",DE,FL,IM,TP,D0)
"RTN","MAGDRPC6",86,0)
 . . . . I IM'="",TP'="" S ^MAGQUEUE(2006.035,"DEST",DE,WW,IM,TP,D0)=""
"RTN","MAGDRPC6",87,0)
 . . . . S OUT=OUT+1
"RTN","MAGDRPC6",88,0)
 . . . . Q
"RTN","MAGDRPC6",89,0)
 . . . Q
"RTN","MAGDRPC6",90,0)
 . . Q
"RTN","MAGDRPC6",91,0)
 . Q
"RTN","MAGDRPC6",92,0)
 Q
"RTN","MAGDRPC6",93,0)
 ;
"RTN","MAGDRPC6",94,0)
REMOBSO(OUT,UPTO,LOCATION) ; RPC = MAG DICOM ROUTE REMOVE OBSO
"RTN","MAGDRPC6",95,0)
 ; Purge Unprocessed entries requested before a certain date
"RTN","MAGDRPC6",96,0)
 N D0,DE,ID,IM,N,PRI,RDT,ST,TY
"RTN","MAGDRPC6",97,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC6",98,0)
 ;
"RTN","MAGDRPC6",99,0)
 S OUT=0
"RTN","MAGDRPC6",100,0)
 S PRI="" F  S PRI=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI)) Q:PRI=""  D
"RTN","MAGDRPC6",101,0)
 . S DE="" F  S DE=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DE)) Q:DE=""  D
"RTN","MAGDRPC6",102,0)
 . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DE,D0)) Q:D0=""  D  Q:'D0
"RTN","MAGDRPC6",103,0)
 . . . S X=$G(^MAGQUEUE(2006.035,D0,0)),IM=$P(X,"^",1),TY=$P(X,"^",3),ID=$P(X,"^",6)
"RTN","MAGDRPC6",104,0)
 . . . S X=$G(^MAGQUEUE(2006.035,D0,1)),ST=$P(X,"^",1),RDT=$P(X,"^",3)
"RTN","MAGDRPC6",105,0)
 . . . I RDT'<UPTO S D0=0 Q
"RTN","MAGDRPC6",106,0)
 . . . I ST'="",IM'="",TY'="" K ^MAGQUEUE(2006.035,"DEST",DE,ST,IM,TY,D0)
"RTN","MAGDRPC6",107,0)
 . . . K ^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DE,D0)
"RTN","MAGDRPC6",108,0)
 . . . K:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)
"RTN","MAGDRPC6",109,0)
 . . . K ^MAGQUEUE(2006.035,D0)
"RTN","MAGDRPC6",110,0)
 . . . S OUT=OUT+1
"RTN","MAGDRPC6",111,0)
 . . . Q
"RTN","MAGDRPC6",112,0)
 . . Q
"RTN","MAGDRPC6",113,0)
 . Q
"RTN","MAGDRPC6",114,0)
 Q
"RTN","MAGDRPC6",115,0)
 ;
"RTN","MAGDRPC6",116,0)
EVALLOG(OUT,TASK,MSG,MAX,LOCATION) ; RPC = MAG DICOM ROUTE EVAL LOG
"RTN","MAGDRPC6",117,0)
 N L,N,PLACE,ZTSK
"RTN","MAGDRPC6",118,0)
 ;
"RTN","MAGDRPC6",119,0)
 S PLACE=$$PLACE^MAGDRPC2(LOCATION)
"RTN","MAGDRPC6",120,0)
 S $P(^MAG(2006.1,PLACE,"LASTROUTE"),"^",1)=DT
"RTN","MAGDRPC6",121,0)
 ;
"RTN","MAGDRPC6",122,0)
 I '$D(^XTMP("MAGEVAL",+$G(TASK))) S OUT(1)="-1,No task #"_(+$G(TASK)) Q
"RTN","MAGDRPC6",123,0)
 I $G(MAX)<1 S OUT(1)="-2,MAXIMUM parameter = "_$G(MAX)_" < 1" Q
"RTN","MAGDRPC6",124,0)
 S (L,MSG)=+$G(MSG),N=1
"RTN","MAGDRPC6",125,0)
 F  S MSG=$O(^XTMP("MAGEVAL",TASK,MSG)) Q:MSG=""  D  Q:N'<MAX
"RTN","MAGDRPC6",126,0)
 . S L=MSG,N=N+1,OUT(N)=^XTMP("MAGEVAL",TASK,MSG)
"RTN","MAGDRPC6",127,0)
 . Q
"RTN","MAGDRPC6",128,0)
 S OUT(1)=(N-1)_" "_L
"RTN","MAGDRPC6",129,0)
 Q:N>1
"RTN","MAGDRPC6",130,0)
 S ZTSK=TASK D STAT^%ZTLOAD
"RTN","MAGDRPC6",131,0)
 I $G(ZTSK(2))["Inactive" S OUT(1)="-3,"_ZTSK(2) Q
"RTN","MAGDRPC6",132,0)
 Q
"RTN","MAGDRPC6",133,0)
 ;
"RTN","MAGDRPC6",134,0)
XMIT ; Continuation from MAGDRPC5
"RTN","MAGDRPC6",135,0)
 N FROM,HASH,TO,TTP
"RTN","MAGDRPC6",136,0)
 S (FROM,TO,OUT(7),OUT(8))=-13
"RTN","MAGDRPC6",137,0)
 S TTP=TP S:TP="TEXT" TTP="FULL" ; MAGFILEB does not support type="TEXT"
"RTN","MAGDRPC6",138,0)
 D FILEFIND^MAGDFB(IM,TTP,0,0,.TO,.FROM)
"RTN","MAGDRPC6",139,0)
 S:FROM["~NO NETWORK LOCATION DEFINED" (FROM,TO)="-1~No routable files found for image "_IM
"RTN","MAGDRPC6",140,0)
 I TP="TEXT" S TO=$E(TO,1,$L(TO)-4)_".TXT",FROM=$E(FROM,1,$L(FROM)-4)_".TXT"
"RTN","MAGDRPC6",141,0)
 I (FROM<0)!(TO<0)!(FROM="") D STATUS^MAGDRPC5(X,D0,"SENT",LOCATION) S OUT(1)=2 Q
"RTN","MAGDRPC6",142,0)
 S HASH=$$DIRHASH^MAGFILEB(TO,+DEST) D:HASH'=""
"RTN","MAGDRPC6",143,0)
 . I $E(TO,1)="\",$E(HASH,$L(HASH))="\" S HASH=$E(HASH,1,$L(HASH)-1)
"RTN","MAGDRPC6",144,0)
 . I $E(TO,1)'="\",$E(HASH,$L(HASH))'="\" S HASH=HASH_"\"
"RTN","MAGDRPC6",145,0)
 . S TO=HASH_TO
"RTN","MAGDRPC6",146,0)
 . Q
"RTN","MAGDRPC6",147,0)
 D:DIR'=""
"RTN","MAGDRPC6",148,0)
 . I $E(TO,1)="\",$E(DIR,$L(DIR))="\" S DIR=$E(DIR,1,$L(DIR)-1)
"RTN","MAGDRPC6",149,0)
 . I $E(TO,1)'="\",$E(DIR,$L(DIR))'="\" S DIR=DIR_"\"
"RTN","MAGDRPC6",150,0)
 . S TO=DIR_TO
"RTN","MAGDRPC6",151,0)
 . Q
"RTN","MAGDRPC6",152,0)
 S:$E(TO,1)'="\" TO="\"_TO
"RTN","MAGDRPC6",153,0)
 S OUT(7)=FROM,OUT(8)=TO
"RTN","MAGDRPC6",154,0)
 S OUT(1)=1
"RTN","MAGDRPC6",155,0)
 Q
"RTN","MAGDRPC7")
0^43^B33129765
"RTN","MAGDRPC7",1,0)
MAGDRPC7 ;WOIFO/EdM - RPC to fetch a Audit Info ; 05/16/2005  07:28
"RTN","MAGDRPC7",2,0)
 ;;3.0;IMAGING;**11,51**;26-August-2005
"RTN","MAGDRPC7",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC7",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC7",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC7",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC7",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC7",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC7",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC7",10,0)
 ;; |                                                               |
"RTN","MAGDRPC7",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC7",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC7",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC7",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC7",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC7",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC7",17,0)
 ;;
"RTN","MAGDRPC7",18,0)
 Q
"RTN","MAGDRPC7",19,0)
 ;
"RTN","MAGDRPC7",20,0)
GET1(OUT,LOCATION,TODAY) ; RPC = MAG DICOM TEXT AUDIT GET
"RTN","MAGDRPC7",21,0)
 ; Get the numbers of text-messages per day per purpose
"RTN","MAGDRPC7",22,0)
 N COUNT,D2,DATE,I,MSG,N,X
"RTN","MAGDRPC7",23,0)
 D:'$D(DT) DT^DICRW
"RTN","MAGDRPC7",24,0)
 K OUT S (OUT(1),N)=1,I=100
"RTN","MAGDRPC7",25,0)
 S TODAY=+$G(TODAY),DATE=DT
"RTN","MAGDRPC7",26,0)
 D:TODAY  I 'TODAY S DATE=0 F  S DATE=$O(^MAGDAUDT(2006.5761,DATE)) Q:'DATE  D
"RTN","MAGDRPC7",27,0)
 . Q:'$D(^MAGDAUDT(2006.5761,DATE,1,LOCATION))
"RTN","MAGDRPC7",28,0)
 . ; Retrieve one day's statistics
"RTN","MAGDRPC7",29,0)
 . S MSG="" F  S MSG=$O(^MAGDAUDT(2006.5761,DATE,1,LOCATION,1,"B",MSG)) Q:MSG=""  D
"RTN","MAGDRPC7",30,0)
 . . S D2=$O(^MAGDAUDT(2006.5761,DATE,1,LOCATION,1,"B",MSG,"")) Q:'D2
"RTN","MAGDRPC7",31,0)
 . . S X=$G(^MAGDAUDT(2006.5761,DATE,1,LOCATION,1,D2,0))
"RTN","MAGDRPC7",32,0)
 . . S COUNT=$P(X,"^",2) Q:'COUNT
"RTN","MAGDRPC7",33,0)
 . . S LAST=$P(X,"^",3)
"RTN","MAGDRPC7",34,0)
 . . S I=I+1,N=N+1,OUT(I)=DATE_"^"_COUNT_"^"_MSG_"^"_LAST,MSG(MSG)=""
"RTN","MAGDRPC7",35,0)
 . . Q
"RTN","MAGDRPC7",36,0)
 . Q
"RTN","MAGDRPC7",37,0)
 S I=1,MSG="" F  S MSG=$O(MSG(MSG)) Q:MSG=""  D
"RTN","MAGDRPC7",38,0)
 . S I=I+1,N=N+1,OUT(I)="^^"_MSG
"RTN","MAGDRPC7",39,0)
 . Q
"RTN","MAGDRPC7",40,0)
 S OUT(1)=N-1
"RTN","MAGDRPC7",41,0)
 Q
"RTN","MAGDRPC7",42,0)
 ;
"RTN","MAGDRPC7",43,0)
GET2(OUT,LOCATION,START,STOP) ; RPC = MAG DICOM IMAGE AUDIT GET
"RTN","MAGDRPC7",44,0)
 ; Get the numbers of messages per day per instrument
"RTN","MAGDRPC7",45,0)
 N COUNT,D2,DATE,I,INSTR,N,X
"RTN","MAGDRPC7",46,0)
 D:'$D(DT) DT^DICRW
"RTN","MAGDRPC7",47,0)
 K OUT S (OUT(1),N)=1,I=100
"RTN","MAGDRPC7",48,0)
 S START=+$G(START)-1,STOP=+$G(STOP)
"RTN","MAGDRPC7",49,0)
 S:START<0 START=0
"RTN","MAGDRPC7",50,0)
 S:'STOP STOP=9999999
"RTN","MAGDRPC7",51,0)
 S DATE=START F  S DATE=$O(^MAGDAUDT(2006.5762,DATE)) Q:'DATE  Q:DATE>STOP  D
"RTN","MAGDRPC7",52,0)
 . Q:'$D(^MAGDAUDT(2006.5762,DATE,1,LOCATION))
"RTN","MAGDRPC7",53,0)
 . ; Retrieve one day's statistics
"RTN","MAGDRPC7",54,0)
 . S INSTR="" F  S INSTR=$O(^MAGDAUDT(2006.5762,DATE,1,LOCATION,1,"B",INSTR)) Q:INSTR=""  D
"RTN","MAGDRPC7",55,0)
 . . S D2=$O(^MAGDAUDT(2006.5762,DATE,1,LOCATION,1,"B",INSTR,"")) Q:'D2
"RTN","MAGDRPC7",56,0)
 . . S X=$G(^MAGDAUDT(2006.5762,DATE,1,LOCATION,1,D2,0))
"RTN","MAGDRPC7",57,0)
 . . S COUNT=$P(X,"^",2) S:$P(X,"^",4)>COUNT COUNT=$P(X,"^",4)
"RTN","MAGDRPC7",58,0)
 . . Q:'COUNT
"RTN","MAGDRPC7",59,0)
 . . S INSTR(INSTR)=""
"RTN","MAGDRPC7",60,0)
 . . S I=I+1,N=N+1,OUT(I)=DATE_"^"_$P(X,"^",2)_"^"_INSTR_"^"_$P(X,"^",3,5)
"RTN","MAGDRPC7",61,0)
 . . Q
"RTN","MAGDRPC7",62,0)
 . Q
"RTN","MAGDRPC7",63,0)
 S I=1,INSTR="" F  S INSTR=$O(INSTR(INSTR)) Q:INSTR=""  D
"RTN","MAGDRPC7",64,0)
 . S I=I+1,N=N+1,OUT(I)="^^"_INSTR
"RTN","MAGDRPC7",65,0)
 . Q
"RTN","MAGDRPC7",66,0)
 S OUT(1)=N-1
"RTN","MAGDRPC7",67,0)
 Q
"RTN","MAGDRPC7",68,0)
 ;
"RTN","MAGDRPC7",69,0)
RANGE(OUT) ; RPC = MAG DICOM AUDIT RANGE
"RTN","MAGDRPC7",70,0)
 ; Get the date-ranges for the various audit files
"RTN","MAGDRPC7",71,0)
 N DF,DL,FM,N
"RTN","MAGDRPC7",72,0)
 K OUT S N=1
"RTN","MAGDRPC7",73,0)
 F FM=2006.5761,2006.5762 D
"RTN","MAGDRPC7",74,0)
 . S DF=$O(^MAGDAUDT(FM,0)) S:'DF DF=""
"RTN","MAGDRPC7",75,0)
 . S DL=$O(^MAGDAUDT(FM," "),-1) S:'DL DL=""
"RTN","MAGDRPC7",76,0)
 . S N=N+1,OUT(N)=FM_"^"_DF_"^"_DL
"RTN","MAGDRPC7",77,0)
 . Q
"RTN","MAGDRPC7",78,0)
 S N=N+1,OUT(N)="-END-"
"RTN","MAGDRPC7",79,0)
 Q
"RTN","MAGDRPC7",80,0)
 ;
"RTN","MAGDRPC7",81,0)
PURGE(OUT,FM,DATE) ; RPC = MAG DICOM AUDIT PURGE
"RTN","MAGDRPC7",82,0)
 ; Purge Audit FIle
"RTN","MAGDRPC7",83,0)
 N D0,DAYS,X
"RTN","MAGDRPC7",84,0)
 L +^MAGDAUDT(FM)
"RTN","MAGDRPC7",85,0)
 S DAYS=$P($G(^MAGDAUDT(FM,0)),"^",4),OUT=0
"RTN","MAGDRPC7",86,0)
 S X=0 F  S X=$O(^MAGDAUDT(FM,X)) Q:'X  Q:X'<DATE  D
"RTN","MAGDRPC7",87,0)
 . K ^MAGDAUDT(FM,X)
"RTN","MAGDRPC7",88,0)
 . S DAYS=DAYS-1,OUT=OUT+1
"RTN","MAGDRPC7",89,0)
 . Q
"RTN","MAGDRPC7",90,0)
 S:DAYS<1 DAYS=0
"RTN","MAGDRPC7",91,0)
 S $P(^MAGDAUDT(FM,0),"^",4)=DAYS
"RTN","MAGDRPC7",92,0)
 L -^MAGDAUDT(FM)
"RTN","MAGDRPC7",93,0)
 S OUT=OUT_" day"_$S(OUT=1:"",1:"s")_" purged."
"RTN","MAGDRPC7",94,0)
 Q
"RTN","MAGDRPC7",95,0)
 ;
"RTN","MAGDRPC7",96,0)
COUNT(OUT,LOCATION,MESSAGE) ; RPC = MAG DICOM AUDIT COUNT
"RTN","MAGDRPC7",97,0)
 ; update today's count
"RTN","MAGDRPC7",98,0)
 N %,D2,%H,%I,TODAY,NOW,X
"RTN","MAGDRPC7",99,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC7",100,0)
 I $G(MESSAGE)="" S OUT="-2,No Message Specified" Q
"RTN","MAGDRPC7",101,0)
 ;
"RTN","MAGDRPC7",102,0)
 D NOW^%DTC S TODAY=X,NOW=%
"RTN","MAGDRPC7",103,0)
 S D2=$O(^MAGDAUDT(2006.5761,TODAY,1,LOCATION,1,"B",MESSAGE,""))
"RTN","MAGDRPC7",104,0)
 D:'D2
"RTN","MAGDRPC7",105,0)
 . L +^MAGDAUDT(2006.5761,TODAY)
"RTN","MAGDRPC7",106,0)
 . S D2=$O(^MAGDAUDT(2006.5761,TODAY,1,LOCATION,1," "),-1)+1
"RTN","MAGDRPC7",107,0)
 . S X=$G(^MAGDAUDT(2006.5761,TODAY,1,LOCATION,1,0))
"RTN","MAGDRPC7",108,0)
 . S $P(X,"^",2)="2006.576111"
"RTN","MAGDRPC7",109,0)
 . S $P(X,"^",3)=D2
"RTN","MAGDRPC7",110,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDRPC7",111,0)
 . S ^MAGDAUDT(2006.5761,TODAY,1,LOCATION,0)=LOCATION
"RTN","MAGDRPC7",112,0)
 . S ^MAGDAUDT(2006.5761,TODAY,1,LOCATION,1,0)=X
"RTN","MAGDRPC7",113,0)
 . S ^MAGDAUDT(2006.5761,TODAY,1,LOCATION,1,D2,0)=MESSAGE
"RTN","MAGDRPC7",114,0)
 . S ^MAGDAUDT(2006.5761,TODAY,1,LOCATION,1,"B",MESSAGE,D2)=""
"RTN","MAGDRPC7",115,0)
 . L -^MAGDAUDT(2006.5761,TODAY)
"RTN","MAGDRPC7",116,0)
 . Q
"RTN","MAGDRPC7",117,0)
 S X=$G(^MAGDAUDT(2006.5761,TODAY,1,LOCATION,1,D2,0))
"RTN","MAGDRPC7",118,0)
 S X=MESSAGE_"^"_($P(X,"^",2)+1)_"^"_NOW
"RTN","MAGDRPC7",119,0)
 S ^MAGDAUDT(2006.5761,TODAY,1,LOCATION,1,D2,0)=X
"RTN","MAGDRPC7",120,0)
 S OUT=$P(X,"^",2)
"RTN","MAGDRPC7",121,0)
 Q
"RTN","MAGDRPC7",122,0)
 ;
"RTN","MAGDRPC7",123,0)
LOGXIMG(OUT,D0,DEST,LOCATION,STATUS,TO,XMIT,MECH) ; RPC = MAG DICOM ROUTE LOG XMIT
"RTN","MAGDRPC7",124,0)
 N %H,%I,X
"RTN","MAGDRPC7",125,0)
 ; D0 ;---- IEN of queue entry (2006.035)
"RTN","MAGDRPC7",126,0)
 ; DEST ;-- IEN of destination in 2005.2 or in 2006.585
"RTN","MAGDRPC7",127,0)
 ; TO ;---- Name of file at destination
"RTN","MAGDRPC7",128,0)
 ; XMIT ;-- Date and time transmission started
"RTN","MAGDRPC7",129,0)
 N % ;----- Current date and time
"RTN","MAGDRPC7",130,0)
 N D41 ;--- IEN in "routed" multiple
"RTN","MAGDRPC7",131,0)
 N D61 ;--- IEN in "permanent" multiple
"RTN","MAGDRPC7",132,0)
 N IMG ;--- IEN of Image in 2005
"RTN","MAGDRPC7",133,0)
 N QUEUED ; Date and time file was queued
"RTN","MAGDRPC7",134,0)
 N TP ;---- File TP (FULL, ABS, BIG, TXT, DICOM)
"RTN","MAGDRPC7",135,0)
 ;
"RTN","MAGDRPC7",136,0)
 D STATUS^MAGDRPC5(.X,D0,STATUS,LOCATION) I X<1 S OUT="-1,"_X Q
"RTN","MAGDRPC7",137,0)
 I STATUS="FAILED" S OUT=1 Q
"RTN","MAGDRPC7",138,0)
 S X=$G(^MAGQUEUE(2006.035,D0,0)),IMG=$P(X,"^",1),TP=$P(X,"^",3)
"RTN","MAGDRPC7",139,0)
 S QUEUED=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",3)
"RTN","MAGDRPC7",140,0)
 ;
"RTN","MAGDRPC7",141,0)
 D NOW^%DTC
"RTN","MAGDRPC7",142,0)
 S $P(^MAGQUEUE(2006.035,D0,1),"^",4)=%
"RTN","MAGDRPC7",143,0)
 L +^MAG(2005,IMG)
"RTN","MAGDRPC7",144,0)
 S D41=$O(^MAG(2005,IMG,4," "),-1)+1
"RTN","MAGDRPC7",145,0)
 S D61=$O(^MAG(2005,IMG,6," "),-1)+1
"RTN","MAGDRPC7",146,0)
 D:MECH=1
"RTN","MAGDRPC7",147,0)
 . S ^MAG(2005,IMG,4,0)="^2005.0106^"_D41_"^"_D41
"RTN","MAGDRPC7",148,0)
 . S ^MAG(2005,IMG,4,D41,0)=%_"^"_DEST_"^"_TP_"^"_TO_"^"_$G(XMIT)_"^"_QUEUED_"^"_D61
"RTN","MAGDRPC7",149,0)
 . S ^MAG(2005,IMG,4,"LOC",DEST,D41)=""
"RTN","MAGDRPC7",150,0)
 . S ^MAG(2005,"ROUTE",DEST,%,IMG,D41)=""
"RTN","MAGDRPC7",151,0)
 . Q
"RTN","MAGDRPC7",152,0)
 S X=""
"RTN","MAGDRPC7",153,0)
 I MECH=1 S X=$P($G(^MAG(2005.2,+DEST,0)),"^",1)_"^"_(+DEST)_"^"
"RTN","MAGDRPC7",154,0)
 I MECH=2 S X=$P($G(^MAG(2006.587,+DEST,0)),"^",1)_"^^"_(+DEST)
"RTN","MAGDRPC7",155,0)
 S $P(X,"^",4)=% ; Timestamp of transmission
"RTN","MAGDRPC7",156,0)
 S $P(X,"^",6)=TO ; Filename at destination
"RTN","MAGDRPC7",157,0)
 S $P(X,"^",7)=TP ; File Type
"RTN","MAGDRPC7",158,0)
 S ^MAG(2005,IMG,6,0)="^2005.0106^"_D61_"^"_D61
"RTN","MAGDRPC7",159,0)
 S ^MAG(2005,IMG,6,D61,0)=X
"RTN","MAGDRPC7",160,0)
 L -^MAG(2005,IMG)
"RTN","MAGDRPC7",161,0)
 S OUT=1
"RTN","MAGDRPC7",162,0)
 Q
"RTN","MAGDRPC7",163,0)
 ;
"RTN","MAGDRPC8")
0^44^B49397368
"RTN","MAGDRPC8",1,0)
MAGDRPC8 ;WOIFO/EdM - RPCs for Master Files ; 06/09/2005  09:07
"RTN","MAGDRPC8",2,0)
 ;;3.0;IMAGING;**11,30,51**;26-August-2005
"RTN","MAGDRPC8",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC8",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC8",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC8",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC8",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC8",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC8",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC8",10,0)
 ;; |                                                               |
"RTN","MAGDRPC8",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC8",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC8",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC8",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC8",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC8",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC8",17,0)
 ;;
"RTN","MAGDRPC8",18,0)
 Q
"RTN","MAGDRPC8",19,0)
 ;
"RTN","MAGDRPC8",20,0)
UPDTAPP(OUT,APP) ; RPC = MAG DICOM UPDATE SCU LIST
"RTN","MAGDRPC8",21,0)
 N A,D0,GWLOC,GWNAM,HDR,I,MIN,N,NOW,P5,P7,PLUS,SERVNAM,UP,X
"RTN","MAGDRPC8",22,0)
 S (GWNAM,GWLOC)="",N=0
"RTN","MAGDRPC8",23,0)
 S A="" F  S A=$O(APP(A)) Q:A=""  D
"RTN","MAGDRPC8",24,0)
 . S X=APP(A) F I=1:1:7 S:$P(X,"^",I)="" N=N+1
"RTN","MAGDRPC8",25,0)
 . S:GWNAM="" GWNAM=$P(X,"^",5)
"RTN","MAGDRPC8",26,0)
 . S:GWLOC="" GWLOC=$P(X,"^",7)
"RTN","MAGDRPC8",27,0)
 . S:GWNAM'=$P(X,"^",5) N=N+1
"RTN","MAGDRPC8",28,0)
 . S:GWLOC'=$P(X,"^",7) N=N+1
"RTN","MAGDRPC8",29,0)
 . S:'N A($P(X,"^",1))=A ; ^MAGDMFBS guarantees unique names
"RTN","MAGDRPC8",30,0)
 . Q
"RTN","MAGDRPC8",31,0)
 I N S OUT="-1,Missing or Inconsistent Parameters." Q
"RTN","MAGDRPC8",32,0)
 ;
"RTN","MAGDRPC8",33,0)
 L +^MAG(2006.587,0):1E9 ; Background task MUST wait
"RTN","MAGDRPC8",34,0)
 S HDR=$G(^MAG(2006.587,0))
"RTN","MAGDRPC8",35,0)
 S $P(HDR,"^",1,2)="DICOM TRANSMIT DESTINATION^2006.587"
"RTN","MAGDRPC8",36,0)
 ;
"RTN","MAGDRPC8",37,0)
 D NOW^%DTC S NOW=%,(MIN,PLUS,UP)=0
"RTN","MAGDRPC8",38,0)
 ;
"RTN","MAGDRPC8",39,0)
 S D0="" F  S D0=$O(^MAG(2006.587,"D",GWNAM,GWLOC,D0)) Q:D0=""  D
"RTN","MAGDRPC8",40,0)
 . S X=$G(^MAG(2006.587,D0,0)),SERVNAM=$P(X,"^",1) Q:SERVNAM=""
"RTN","MAGDRPC8",41,0)
 . S P5=$P(X,"^",5),P7=$P(X,"^",7)
"RTN","MAGDRPC8",42,0)
 . I P5'="",P7'="" K ^MAG(2006.587,"C",SERVNAM,P7,P5,D0),^MAG(2006.587,"D",P5,P7,D0)
"RTN","MAGDRPC8",43,0)
 . I '$D(A(SERVNAM)) D  Q
"RTN","MAGDRPC8",44,0)
 . . K ^MAG(2006.587,D0),^MAG(2006.587,"B",SERVNAM,D0) S MIN=MIN+1
"RTN","MAGDRPC8",45,0)
 . . Q
"RTN","MAGDRPC8",46,0)
 . S X=APP(A(SERVNAM)),$P(X,"^",8)=NOW K APP(A(SERVNAM))
"RTN","MAGDRPC8",47,0)
 . S ^MAG(2006.587,D0,0)=$P(X,"^",1,8),UP=UP+1
"RTN","MAGDRPC8",48,0)
 . S ^MAG(2006.587,"C",SERVNAM,GWLOC,GWNAM,D0)=""
"RTN","MAGDRPC8",49,0)
 . S ^MAG(2006.587,"D",GWNAM,GWLOC,D0)=""
"RTN","MAGDRPC8",50,0)
 . Q
"RTN","MAGDRPC8",51,0)
 S $P(HDR,"^",4)=$P(HDR,"^",4)-MIN
"RTN","MAGDRPC8",52,0)
 ;
"RTN","MAGDRPC8",53,0)
 S A="" F  S A=$O(APP(A)) Q:A=""  D
"RTN","MAGDRPC8",54,0)
 . S X=APP(A),$P(X,"^",8)=NOW
"RTN","MAGDRPC8",55,0)
 . S D0=$O(^MAG(2006.587," "),-1)+1,PLUS=PLUS+1,$P(HDR,"^",3)=D0
"RTN","MAGDRPC8",56,0)
 . S ^MAG(2006.587,D0,0)=$P(X,"^",1,8),SERVNAM=$P(X,"^",1)
"RTN","MAGDRPC8",57,0)
 . S ^MAG(2006.587,"B",SERVNAM,D0)=""
"RTN","MAGDRPC8",58,0)
 . S ^MAG(2006.587,"C",SERVNAM,GWLOC,GWNAM,D0)=""
"RTN","MAGDRPC8",59,0)
 . S ^MAG(2006.587,"D",GWNAM,GWLOC,D0)=""
"RTN","MAGDRPC8",60,0)
 . Q
"RTN","MAGDRPC8",61,0)
 S $P(HDR,"^",4)=$P(HDR,"^",4)+PLUS
"RTN","MAGDRPC8",62,0)
 S ^MAG(2006.587,0)=HDR
"RTN","MAGDRPC8",63,0)
 L -^MAG(2006.587,0)
"RTN","MAGDRPC8",64,0)
 S OUT="1"
"RTN","MAGDRPC8",65,0)
 S:PLUS OUT=OUT_", "_PLUS_" added"
"RTN","MAGDRPC8",66,0)
 S:MIN OUT=OUT_", "_MIN_" removed"
"RTN","MAGDRPC8",67,0)
 S:UP OUT=OUT_", "_UP_" updated"
"RTN","MAGDRPC8",68,0)
 Q
"RTN","MAGDRPC8",69,0)
 ;
"RTN","MAGDRPC8",70,0)
UPDTGW(OUT,ONAM,NNAM,OLOC,NLOC) ; RPC = MAG DICOM UPDATE GATEWAY NAME
"RTN","MAGDRPC8",71,0)
 N D0,P1,P5,P7,N
"RTN","MAGDRPC8",72,0)
 I $G(NNAM)="" S OUT="-1,No Gateway Name specified" Q
"RTN","MAGDRPC8",73,0)
 I '$G(NLOC) S OUT="-2,No Gateway Location specified" Q
"RTN","MAGDRPC8",74,0)
 S OLOC=$G(OLOC),ONAM=$G(ONAM)
"RTN","MAGDRPC8",75,0)
 S (N,D0)=0 F  S D0=$O(^MAG(2006.587,D0)) Q:'D0  D
"RTN","MAGDRPC8",76,0)
 . S X=$G(^MAG(2006.587,D0,0)),P5=$P(X,"^",5) Q:P5'=ONAM
"RTN","MAGDRPC8",77,0)
 . S P1=$P(X,"^",1),P7=$P(X,"^",7)
"RTN","MAGDRPC8",78,0)
 . I OLOC'="",P5'="" K ^MAG(2006.587,"C",P1,OLOC,P5,D0),^MAG(2006.587,"D",P5,OLOC,D0)
"RTN","MAGDRPC8",79,0)
 . S $P(X,"^",5)=NNAM,$P(X,"^",7)=NLOC
"RTN","MAGDRPC8",80,0)
 . S ^MAG(2006.587,D0,0)=X
"RTN","MAGDRPC8",81,0)
 . S ^MAG(2006.587,"C",P1,NLOC,NNAM,D0)=""
"RTN","MAGDRPC8",82,0)
 . S ^MAG(2006.587,"D",NNAM,NLOC,D0)=""
"RTN","MAGDRPC8",83,0)
 . S N=N+1
"RTN","MAGDRPC8",84,0)
 . Q
"RTN","MAGDRPC8",85,0)
 S OUT=N
"RTN","MAGDRPC8",86,0)
 Q
"RTN","MAGDRPC8",87,0)
 ;
"RTN","MAGDRPC8",88,0)
SIBS(P0,T) N MAGLOC,P1,P2
"RTN","MAGDRPC8",89,0)
 S T(P0)=""
"RTN","MAGDRPC8",90,0)
 D SIBLING^XUAF4("MAGLOC",P0,"PARENT FACILITY") ; General API, IA #2171
"RTN","MAGDRPC8",91,0)
 S P1="" F  S P1=$O(MAGLOC("P",P1)) Q:P1=""  D
"RTN","MAGDRPC8",92,0)
 . S P2="" F  S P2=$O(MAGLOC("P",P1,"C",P2)) Q:P2=""  S T(P2)=""
"RTN","MAGDRPC8",93,0)
 . Q
"RTN","MAGDRPC8",94,0)
 Q
"RTN","MAGDRPC8",95,0)
 ;
"RTN","MAGDRPC8",96,0)
LOCS(OUT) ; RPC = MAG DICOM VALID LOCATIONS
"RTN","MAGDRPC8",97,0)
 N D0,I,M,N,P1,R,T
"RTN","MAGDRPC8",98,0)
 S N=1
"RTN","MAGDRPC8",99,0)
 S D0=0 F  S D0=$O(^MAG(2006.1,D0)) Q:'D0  D
"RTN","MAGDRPC8",100,0)
 . S X=$G(^MAG(2006.1,D0,0)),P1=$P(X,"^",1) Q:P1=""
"RTN","MAGDRPC8",101,0)
 . I +P1=P1 S T(P1)="" Q
"RTN","MAGDRPC8",102,0)
 . D FIND^DIC(4,"","","BX",P1,"*","","","","R","M") ; IA #4389
"RTN","MAGDRPC8",103,0)
 . S I=0 F  S I=$O(R("DILIST",2,I)) Q:'I  D
"RTN","MAGDRPC8",104,0)
 . . S P1=R("DILIST",2,I) I P1 K R S T(P1)=""
"RTN","MAGDRPC8",105,0)
 . . Q
"RTN","MAGDRPC8",106,0)
 . Q
"RTN","MAGDRPC8",107,0)
 I $T(+1^XUPARAM)'="" S P1=$$KSP^XUPARAM("INST") D:P1 SIBS(P1,.T)
"RTN","MAGDRPC8",108,0)
 S P1=+$G(^DD("SITE",1)) D:P1 SIBS(P1,.T)
"RTN","MAGDRPC8",109,0)
 ;
"RTN","MAGDRPC8",110,0)
 S P1="" F  S P1=$O(T(P1)) Q:P1=""  D
"RTN","MAGDRPC8",111,0)
 . S N=N+1,OUT(N)=P1_"^"_$$GET1^DIQ(4,P1,.01)_"^"_$$GET1^DIQ(4,P1,99)
"RTN","MAGDRPC8",112,0)
 . Q
"RTN","MAGDRPC8",113,0)
 S OUT(1)=N-1
"RTN","MAGDRPC8",114,0)
 Q
"RTN","MAGDRPC8",115,0)
 ;
"RTN","MAGDRPC8",116,0)
GETPLACE(OUT,LOCATION) ; RPC = MAG DICOM GET PLACE
"RTN","MAGDRPC8",117,0)
 N D0,P1,M,R,X
"RTN","MAGDRPC8",118,0)
 S LOCATION=+$G(LOCATION)
"RTN","MAGDRPC8",119,0)
 S OUT="-1,Location """_LOCATION_""" not found."
"RTN","MAGDRPC8",120,0)
 S D0=0 F  S D0=$O(^MAG(2006.1,D0)) Q:'D0  D  Q:OUT>0
"RTN","MAGDRPC8",121,0)
 . S X=$G(^MAG(2006.1,D0,0)),P1=$P(X,"^",1) Q:P1=""
"RTN","MAGDRPC8",122,0)
 . I +P1=P1,LOCATION=P1 S OUT=D0 Q
"RTN","MAGDRPC8",123,0)
 . D FIND^DIC(4,"","","BX",P1,"*","","","","R","M")
"RTN","MAGDRPC8",124,0)
 . S I=0 F  S I=$O(R("DILIST",2,I)) Q:'I  D
"RTN","MAGDRPC8",125,0)
 . . I LOCATION=R("DILIST",2,I) S OUT=D0
"RTN","MAGDRPC8",126,0)
 . . Q
"RTN","MAGDRPC8",127,0)
 . Q
"RTN","MAGDRPC8",128,0)
 Q
"RTN","MAGDRPC8",129,0)
 ;
"RTN","MAGDRPC8",130,0)
SETPACS(OUT,D0) ; RPC = MAG DICOM SET PACS PARAMS
"RTN","MAGDRPC8",131,0)
 N X
"RTN","MAGDRPC8",132,0)
 I '$G(D0) S OUT="-1,No Place Specified." Q
"RTN","MAGDRPC8",133,0)
 I '$D(^MAG(2006.1,D0)) S OUT="-2,Invalid Place Specified." Q
"RTN","MAGDRPC8",134,0)
 ;
"RTN","MAGDRPC8",135,0)
 ; There is a PACS
"RTN","MAGDRPC8",136,0)
 S $P(^MAG(2006.1,D0,"PACS"),"^",1)=1
"RTN","MAGDRPC8",137,0)
 ;
"RTN","MAGDRPC8",138,0)
 ; Number of days to retain "PACS" images
"RTN","MAGDRPC8",139,0)
 S X=$P($G(^MAG(2006.1,D0,1)),"^",5)
"RTN","MAGDRPC8",140,0)
 S:'X $P(^MAG(2006.1,D0,1),"^",5)=30
"RTN","MAGDRPC8",141,0)
 ;
"RTN","MAGDRPC8",142,0)
 ; Set minimum % of free disk space to trigger automatic file delete
"RTN","MAGDRPC8",143,0)
 S X=$P($G(^MAG(2006.1,D0,3)),"^",6)
"RTN","MAGDRPC8",144,0)
 S:'X $P(^MAG(2006.1,D0,3),"^",6)=25
"RTN","MAGDRPC8",145,0)
 S OUT=1
"RTN","MAGDRPC8",146,0)
 Q
"RTN","MAGDRPC8",147,0)
 ;
"RTN","MAGDRPC8",148,0)
HIGHHL7(OUT) ; RPC = MAG DICOM GET HIGHEST HL7
"RTN","MAGDRPC8",149,0)
 S OUT=+$O(^MAGDHL7(2006.5," "),-1)
"RTN","MAGDRPC8",150,0)
 Q
"RTN","MAGDRPC8",151,0)
 ;
"RTN","MAGDRPC8",152,0)
FINDLOC(OUT,NAME) ; RPC = MAG DICOM FIND LOCATION
"RTN","MAGDRPC8",153,0)
 N I,M,P1,R,X
"RTN","MAGDRPC8",154,0)
 S OUT="-1,Invalid location """_NAME_"""."
"RTN","MAGDRPC8",155,0)
 D FIND^DIC(4,"",.01,"BXA",NAME,"*","","","","R","M")
"RTN","MAGDRPC8",156,0)
 S I=0 F  S I=$O(R("DILIST",2,I)) Q:'I  D
"RTN","MAGDRPC8",157,0)
 . S P1=R("DILIST",2,I) I P1 K R S OUT=P1
"RTN","MAGDRPC8",158,0)
 . Q
"RTN","MAGDRPC8",159,0)
 Q
"RTN","MAGDRPC8",160,0)
 ;
"RTN","MAGDRPC8",161,0)
VALIMGT(OUT) ; RPC = MAG DICOM GET IMAGING TYPES
"RTN","MAGDRPC8",162,0)
 N N,X
"RTN","MAGDRPC8",163,0)
 S N=1
"RTN","MAGDRPC8",164,0)
 ; Lists of valid imaging types
"RTN","MAGDRPC8",165,0)
 S X="" F  S X=$O(^RA(79.2,"C",X)) Q:X=""  S N=N+1,OUT(N)="RAD^"_X
"RTN","MAGDRPC8",166,0)
 S X="" F  S X=$O(^MAG(2005.84,"C",X)) Q:X=""  S N=N+1,OUT(N)="CON^"_X
"RTN","MAGDRPC8",167,0)
 S OUT(1)=N-1
"RTN","MAGDRPC8",168,0)
 Q
"RTN","MAGDRPC8",169,0)
 ;
"RTN","MAGDRPC8",170,0)
CORRECT(OUT,LOCATION,MACHID) ; RPC = MAG DICOM INCORRECT IMAGE CT
"RTN","MAGDRPC8",171,0)
 ; Check for images needing corrections
"RTN","MAGDRPC8",172,0)
 N CNT,D0,STUDY
"RTN","MAGDRPC8",173,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC8",174,0)
 I $G(MACHID)="" S OUT="-2,No Gateway Specified" Q
"RTN","MAGDRPC8",175,0)
 S OUT=0
"RTN","MAGDRPC8",176,0)
 Q:'$O(^MAGD(2006.575,0))
"RTN","MAGDRPC8",177,0)
 Q:'$D(^MAGD(2006.575,"F",LOCATION))
"RTN","MAGDRPC8",178,0)
 S STUDY="" F  S STUDY=$O(^MAGD(2006.575,"F",LOCATION,STUDY)) Q:STUDY=""  D
"RTN","MAGDRPC8",179,0)
 . S D0=0 S D0=$O(^MAGD(2006.575,"F",LOCATION,STUDY,D0)) Q:'D0  D
"RTN","MAGDRPC8",180,0)
 . . Q:'$D(^MAGD(2006.575,D0,0))
"RTN","MAGDRPC8",181,0)
 . . S:MACHID=$P($G(^MAGD(2006.575,D0,1)),"^",4) OUT=OUT+1
"RTN","MAGDRPC8",182,0)
 . . Q
"RTN","MAGDRPC8",183,0)
 . Q
"RTN","MAGDRPC8",184,0)
 Q
"RTN","MAGDRPC8",185,0)
 ;
"RTN","MAGDRPC8",186,0)
HL7PTR(OUT,ACTION,VALUE) ; RPC = MAG DICOM HL7 POINTER ACTION
"RTN","MAGDRPC8",187,0)
 ; Manipulate HL7 Pointer
"RTN","MAGDRPC8",188,0)
 N D0,P1,P2,X,Y
"RTN","MAGDRPC8",189,0)
 S ACTION=$G(ACTION),VALUE=$G(VALUE)
"RTN","MAGDRPC8",190,0)
 S OUT="-2,Invalid Request: """_ACTION_"""."
"RTN","MAGDRPC8",191,0)
 I ACTION="GetDate" D  Q
"RTN","MAGDRPC8",192,0)
 . S X=$G(^MAGDHL7(2006.5,+VALUE,0))
"RTN","MAGDRPC8",193,0)
 . I X="" S OUT="-1,Invalid Pointer """_VALUE_"""." Q
"RTN","MAGDRPC8",194,0)
 . S Y=$P(X,"^",3) D DD^%DT S OUT=Y
"RTN","MAGDRPC8",195,0)
 . Q
"RTN","MAGDRPC8",196,0)
 I ACTION="DatePtr" D  Q
"RTN","MAGDRPC8",197,0)
 . S Y=$O(^MAGDHL7(2006.5,"C",VALUE),-1)
"RTN","MAGDRPC8",198,0)
 . I 'Y D  ; before any date on file
"RTN","MAGDRPC8",199,0)
 . . ; if the requested date is before the first entry,
"RTN","MAGDRPC8",200,0)
 . . ; move the pointer to the first entry
"RTN","MAGDRPC8",201,0)
 . . S OUT=0
"RTN","MAGDRPC8",202,0)
 . . Q
"RTN","MAGDRPC8",203,0)
 . E  D  ; if the requested date is in the cross reference, use it.
"RTN","MAGDRPC8",204,0)
 . . S Y=$O(^MAGDHL7(2006.5,"C",Y,""))
"RTN","MAGDRPC8",205,0)
 . . I Y S OUT=Y ; found date
"RTN","MAGDRPC8",206,0)
 . . E  D
"RTN","MAGDRPC8",207,0)
  . . . ; otherwise, find the appropriate entry the hard way
"RTN","MAGDRPC8",208,0)
 . . . S D0=$O(^MAGDHL7(2006.5,0))
"RTN","MAGDRPC8",209,0)
 . . . S Y=$P($G(^MAGDHL7(2006.5,D0,0)),"^",3) I Y'<X S OUT=0 Q
"RTN","MAGDRPC8",210,0)
 . . . S D0=" " F  S D0=$O(^MAGDHL7(2006.5,D0),-1) Q:'D0  D  Q:OUT
"RTN","MAGDRPC8",211,0)
 . . . . S Y=$P($G(^MAGDHL7(2006.5,D0,0)),"^",3) S:Y<X OUT=D0
"RTN","MAGDRPC8",212,0)
 . . . . Q
"RTN","MAGDRPC8",213,0)
 . . . Q
"RTN","MAGDRPC8",214,0)
 . . Q
"RTN","MAGDRPC8",215,0)
 . Q
"RTN","MAGDRPC8",216,0)
 Q
"RTN","MAGDRPC8",217,0)
 ;
"RTN","MAGIPS51")
0^^B34716479
"RTN","MAGIPS51",1,0)
MAGIPS51 ;Post init routine to queue site activity at install. ; 06/09/2005  09:45
"RTN","MAGIPS51",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGIPS51",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIPS51",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIPS51",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIPS51",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIPS51",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIPS51",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIPS51",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIPS51",10,0)
 ;; |                                                               |
"RTN","MAGIPS51",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIPS51",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIPS51",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIPS51",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIPS51",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIPS51",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIPS51",17,0)
 ;;
"RTN","MAGIPS51",18,0)
 Q
"RTN","MAGIPS51",19,0)
 ;
"RTN","MAGIPS51",20,0)
PRE ;
"RTN","MAGIPS51",21,0)
 N DIU
"RTN","MAGIPS51",22,0)
 ; Remove obsolete DD definitions
"RTN","MAGIPS51",23,0)
 F DIU=2006.574,2006.575,2006.5762,2006.587 D
"RTN","MAGIPS51",24,0)
 . S DIU(0)="" D EN^DIU2
"RTN","MAGIPS51",25,0)
 . Q
"RTN","MAGIPS51",26,0)
 ; File-roots can be left.
"RTN","MAGIPS51",27,0)
 Q
"RTN","MAGIPS51",28,0)
 ;
"RTN","MAGIPS51",29,0)
POST N CVT
"RTN","MAGIPS51",30,0)
 ; 1. Convert simple pointers to variable pointers
"RTN","MAGIPS51",31,0)
 ; 2. Add RPCs to secondary menus
"RTN","MAGIPS51",32,0)
 ; 3. Clean up obsolete cross-references
"RTN","MAGIPS51",33,0)
 ; 4. Clean up obsolete FileMan header
"RTN","MAGIPS51",34,0)
 ; 5. Create missing PT pointers (QA issue)
"RTN","MAGIPS51",35,0)
 ; 6. Pre-populate AutoRoute Prior Studies table
"RTN","MAGIPS51",36,0)
 ; 7. Re-Cross-Reference file # 2006.587
"RTN","MAGIPS51",37,0)
 ; 8. Send confirmation message
"RTN","MAGIPS51",38,0)
 ;
"RTN","MAGIPS51",39,0)
 D  ; Pointer Conversion
"RTN","MAGIPS51",40,0)
 . N D0,DE,H1,H2,IM,N,OR,PR,ST,T,TY,X
"RTN","MAGIPS51",41,0)
 . S H1=$H L +^MAGQUEUE(2006.035):1E9 ; Background process MUST wait.
"RTN","MAGIPS51",42,0)
 . W !,"Starting correction of variable pointers in SEND QUEUE."
"RTN","MAGIPS51",43,0)
 . K ^MAGQUEUE(2006.035,"DEST")
"RTN","MAGIPS51",44,0)
 . K ^MAGQUEUE(2006.035,"STS")
"RTN","MAGIPS51",45,0)
 . S N=0,D0=0 F  S D0=$O(^MAGQUEUE(2006.035,D0)) Q:'D0  D
"RTN","MAGIPS51",46,0)
 . . S X=$G(^MAGQUEUE(2006.035,D0,1)),N=N+1
"RTN","MAGIPS51",47,0)
 . . S ST=$P(X,"^",1),PR=$P(X,"^",2)
"RTN","MAGIPS51",48,0)
 . . S X=$G(^MAGQUEUE(2006.035,D0,0))
"RTN","MAGIPS51",49,0)
 . . S IM=$P(X,"^",1),DE=$P(X,"^",2),TY=$P(X,"^",3)
"RTN","MAGIPS51",50,0)
 . . S ME=$P(X,"^",4),OR=$P(X,"^",5)
"RTN","MAGIPS51",51,0)
 . . I DE,ME=1 S DE=(+DE)_";MAG(2005.2,"
"RTN","MAGIPS51",52,0)
 . . I DE,ME=2 S DE=(+DE)_";MAG(2006.587,"
"RTN","MAGIPS51",53,0)
 . . I 'DE!(DE'[";") S DE=""
"RTN","MAGIPS51",54,0)
 . . S $P(X,"^",2)=DE,^MAGQUEUE(2006.035,D0,0)=X
"RTN","MAGIPS51",55,0)
 . . Q:DE=""  Q:ST=""
"RTN","MAGIPS51",56,0)
 . . I IM'="",TY'="" S ^MAGQUEUE(2006.035,"DEST",DE,ST,IM,TY,D0)=""
"RTN","MAGIPS51",57,0)
 . . I OR'="",PR'="" S ^MAGQUEUE(2006.035,"STS",OR,ST,PR,DE,D0)=""
"RTN","MAGIPS51",58,0)
 . . Q
"RTN","MAGIPS51",59,0)
 . L -^MAGQUEUE(2006.035)
"RTN","MAGIPS51",60,0)
 . S H2=$H,H1=H1*86400+$P(H1,",",2),H2=H2*86400+$P(H2,",",2)
"RTN","MAGIPS51",61,0)
 . S X=H2-H1,CVT=N_" entr"_$S(N=1:"y",1:"ies")_" in "
"RTN","MAGIPS51",62,0)
 . S T=X\3600 S:T CVT=CVT_T_" hour" S:T>1 CVT=CVT_"s"
"RTN","MAGIPS51",63,0)
 . S T=X\60#60 I T S:CVT'="" CVT=CVT_", " S SVT=CVT_T_" minute" S:T>1 CVT=CVT_"s"
"RTN","MAGIPS51",64,0)
 . S T=X#60 I T S:CVT'="" CVT=CVT_", " S SVT=CVT_T_" second" S:T>1 CVT=CVT_"s"
"RTN","MAGIPS51",65,0)
 . S:'X CVT=CVT_"less than 1 second."
"RTN","MAGIPS51",66,0)
 . Q
"RTN","MAGIPS51",67,0)
 ;
"RTN","MAGIPS51",68,0)
 D ADDRPC("MAG CFIND QUERY","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS51",69,0)
 D ADDRPC("MAG STUDY UID QUERY","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS51",70,0)
 D ADDRPC("MAG DICOM CHECK MACHINE ID","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS51",71,0)
 D ADDRPC("MAG DICOM UPDATE MACHINE ID","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS51",72,0)
 D ADDRPC("MAG VISTA CHECKSUMS","MAG DICOM GATEWAY FULL")
"RTN","MAGIPS51",73,0)
 ;
"RTN","MAGIPS51",74,0)
 D ADDRPC("MAG CFIND QUERY","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS51",75,0)
 D ADDRPC("MAG STUDY UID QUERY","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS51",76,0)
 D ADDRPC("MAG DICOM CHECK MACHINE ID","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS51",77,0)
 D ADDRPC("MAG DICOM UPDATE MACHINE ID","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS51",78,0)
 D ADDRPC("MAG VISTA CHECKSUMS","MAG DICOM GATEWAY VIEW")
"RTN","MAGIPS51",79,0)
 ;
"RTN","MAGIPS51",80,0)
 F X="C","DPAT","E" K ^MAGD(2006.575,X)
"RTN","MAGIPS51",81,0)
 K ^MAGDICOM("HL7")
"RTN","MAGIPS51",82,0)
 ;
"RTN","MAGIPS51",83,0)
 S ^DD(2006.587,0,"PT",2005.0111,3)=""
"RTN","MAGIPS51",84,0)
 S ^DD(2006.587,0,"PT",2005.1111,3)=""
"RTN","MAGIPS51",85,0)
 ;
"RTN","MAGIPS51",86,0)
 D  ; Pre-populate AutoRoute Prior Studies Table
"RTN","MAGIPS51",87,0)
 . N A,D0,D1,X
"RTN","MAGIPS51",88,0)
 . S D0=0 F  S D0=$O(^MAG(2006.65,D0)) Q:'D0  D
"RTN","MAGIPS51",89,0)
 . . S D1=0 F  S D1=$O(^MAG(2006.65,D0,1,D1)) Q:'D1  D
"RTN","MAGIPS51",90,0)
 . . . S X=$G(^MAG(2006.65,D0,1,D1,0)),A=0
"RTN","MAGIPS51",91,0)
 . . . I $P(X,"^",2)="" S:$P(X,"^",5) $P(X,"^",2)=$P(X,"^",5),A=1
"RTN","MAGIPS51",92,0)
 . . . I $P(X,"^",3)="" S $P(X,"^",3)=1800,A=1
"RTN","MAGIPS51",93,0)
 . . . I $P(X,"^",4)="" S $P(X,"^",4)=1,A=1
"RTN","MAGIPS51",94,0)
 . . . S:A ^MAG(2006.65,D0,1,D1,0)=X
"RTN","MAGIPS51",95,0)
 . . . Q
"RTN","MAGIPS51",96,0)
 . . Q
"RTN","MAGIPS51",97,0)
 . Q
"RTN","MAGIPS51",98,0)
 ;
"RTN","MAGIPS51",99,0)
 ; Re-Crossreference
"RTN","MAGIPS51",100,0)
 ;
"RTN","MAGIPS51",101,0)
 F X="B","C","D" K ^MAG(2006.587,X)
"RTN","MAGIPS51",102,0)
 S DIK="^MAG(2006.587," D IXALL^DIK
"RTN","MAGIPS51",103,0)
 ;
"RTN","MAGIPS51",104,0)
 D  ; Confirmation message
"RTN","MAGIPS51",105,0)
 . N CT,CNT,D,D0,D1,D2,DDATE,DG,DIC,DICR,DIW,MAGMSG,ST,XMID,XMY
"RTN","MAGIPS51",106,0)
 . ;
"RTN","MAGIPS51",107,0)
 . D GETENV^%ZOSV
"RTN","MAGIPS51",108,0)
 . S CNT=0
"RTN","MAGIPS51",109,0)
 . S CNT=CNT+1,MAGMSG(CNT)="PACKAGE INSTALL"
"RTN","MAGIPS51",110,0)
 . S CNT=CNT+1,MAGMSG(CNT)="SITE: "_$$KSP^XUPARAM("WHERE")
"RTN","MAGIPS51",111,0)
 . S CNT=CNT+1,MAGMSG(CNT)="PACKAGE: "_XPDNM
"RTN","MAGIPS51",112,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Version: "_$$VER^XPDUTL(XPDNM)
"RTN","MAGIPS51",113,0)
 . S ST=$$GET1^DIQ(9.7,XPDA,11,"I")
"RTN","MAGIPS51",114,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Start time: "_$$FMTE^XLFDT(ST)
"RTN","MAGIPS51",115,0)
 . S CT=$$GET1^DIQ(9.7,XPDA,17,"I") S:+CT'=CT CT=$$NOW^XLFDT()
"RTN","MAGIPS51",116,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Completion time: "_$$FMTE^XLFDT(CT)
"RTN","MAGIPS51",117,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Run time: "_$$FMDIFF^XLFDT(CT,ST,3)
"RTN","MAGIPS51",118,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Environment: "_Y
"RTN","MAGIPS51",119,0)
 . S CNT=CNT+1,MAGMSG(CNT)="FILE COMMENT: "_$$GET1^DIQ(9.7,XPDA,6,"I")
"RTN","MAGIPS51",120,0)
 . S CNT=CNT+1,MAGMSG(CNT)="DATE: "_$$NOW^XLFDT()
"RTN","MAGIPS51",121,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Installed by: "_$$GET1^DIQ(9.7,XPDA,9,"E")
"RTN","MAGIPS51",122,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Install Name: "_$$GET1^DIQ(9.7,XPDA,.01,"E")
"RTN","MAGIPS51",123,0)
 . S DDATE=$$GET1^DIQ(9.7,XPDA,51,"I")
"RTN","MAGIPS51",124,0)
 . S CNT=CNT+1,MAGMSG(CNT)="Distribution Date: "_$$FMTE^XLFDT(DDATE)
"RTN","MAGIPS51",125,0)
 . S:$G(CVT)'="" CNT=CNT+1,MAGMSG(CNT)="Conversion time: "_CVT
"RTN","MAGIPS51",126,0)
 . S XMSUB=XPDNM_" INSTALLATION"
"RTN","MAGIPS51",127,0)
 . S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGIPS51",128,0)
 . S XMY(XMID)=""
"RTN","MAGIPS51",129,0)
 . S XMY("G.MAG SERVER")=""
"RTN","MAGIPS51",130,0)
 . S:$G(MAGDUZ) XMY(MAGDUZ)=""
"RTN","MAGIPS51",131,0)
 . S XMSUB=$E(XMSUB,1,63)
"RTN","MAGIPS51",132,0)
 . D SENDMSG^XMXAPI(XMID,XMSUB,"MAGMSG",.XMY,,.XMZ,)
"RTN","MAGIPS51",133,0)
 . I $G(XMERR) M XMERR=^TMP("XMERR",$J) S $EC=",U13-Cannot send MailMan message,"
"RTN","MAGIPS51",134,0)
 . Q
"RTN","MAGIPS51",135,0)
 Q
"RTN","MAGIPS51",136,0)
 ;
"RTN","MAGIPS51",137,0)
ADDRPC(RPCNAME,OPTNAME) N DA,DIC
"RTN","MAGIPS51",138,0)
 S DIC="^DIC(19,",DIC(0)="",X=OPTNAME D ^DIC
"RTN","MAGIPS51",139,0)
 I Y<0 D  Q
"RTN","MAGIPS51",140,0)
 . W !,"Cannot add """_RPCNAME_""" to """_OPTNAME_"""."
"RTN","MAGIPS51",141,0)
 . W !,"Cannot find """_OPTNAME_"""."
"RTN","MAGIPS51",142,0)
 . Q
"RTN","MAGIPS51",143,0)
 S DA(1)=+Y
"RTN","MAGIPS51",144,0)
 S DIC=DIC_DA(1)_",""RPC"","
"RTN","MAGIPS51",145,0)
 S DIC(0)="L" ; LAYGO should be allowed here
"RTN","MAGIPS51",146,0)
 S X=RPCNAME
"RTN","MAGIPS51",147,0)
 D ^DIC
"RTN","MAGIPS51",148,0)
 I Y<0 D  Q
"RTN","MAGIPS51",149,0)
 . W !,"Cannot add """_RPCNAME_""" to """_OPTNAME_"""."
"RTN","MAGIPS51",150,0)
 . W !,"Cannot find """_RPCNAME_"""."
"RTN","MAGIPS51",151,0)
 . Q
"RTN","MAGIPS51",152,0)
 Q
"RTN","MAGIPS51",153,0)
 ;
"RTN","MAGJEX2")
0^45^B48782421
"RTN","MAGJEX2",1,0)
MAGJEX2 ; ; 06/06/2005  09:33
"RTN","MAGJEX2",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGJEX2",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX2",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJEX2",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJEX2",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJEX2",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJEX2",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJEX2",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJEX2",10,0)
 ;; |                                                               |
"RTN","MAGJEX2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJEX2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJEX2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJEX2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJEX2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJEX2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX2",17,0)
 ;;
"RTN","MAGJEX2",18,0)
 Q
"RTN","MAGJEX2",19,0)
 ; Subroutines for pre-fetch/ auto-display prior exams' images
"RTN","MAGJEX2",20,0)
 ; Entry Points:
"RTN","MAGJEX2",21,0)
 ;   PRIOR1  -- Pre-Fetch/Auto-Display images for other related cases;
"RTN","MAGJEX2",22,0)
 ;    RPC Call: MAGJ PRIOREXAMS
"RTN","MAGJEX2",23,0)
 ;   PREFETCH -- Pre-Fetch initiated from
"RTN","MAGJEX2",24,0)
 ;
"RTN","MAGJEX2",25,0)
 Q
"RTN","MAGJEX2",26,0)
ERR N ERR S ERR=$$EC^%ZOSV S MAGGRY(0)="0^Server Program Error: "_ERR
"RTN","MAGJEX2",27,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGJEX2",28,0)
 Q:$Q 1  Q
"RTN","MAGJEX2",29,0)
PREFETCH ; Entry point from HL7 processing, to initiate prefetch at
"RTN","MAGJEX2",30,0)
 ; time of radiology "Register Patient for Exam" function
"RTN","MAGJEX2",31,0)
 ; Do not process if the exam is being Canceled (RACANC true)
"RTN","MAGJEX2",32,0)
 ;
"RTN","MAGJEX2",33,0)
 N RET S RET=""
"RTN","MAGJEX2",34,0)
 I '$P($G(^MAG(2006.69,1,0)),U,5) G PREFQ          ; Prefetch disabled
"RTN","MAGJEX2",35,0)
 I '($G(RADFN)&$G(RADTI)&$G(RACNI)&'$G(RACANC)) G PREFQ ; Required vars
"RTN","MAGJEX2",36,0)
 D PRIOR1(.RET,"P"_U_RADFN_U_RADTI_U_RACNI)
"RTN","MAGJEX2",37,0)
PREFQ ; W !,"End PRE-FETCH RET=" N JHC R JHC ZW RET
"RTN","MAGJEX2",38,0)
 Q
"RTN","MAGJEX2",39,0)
 ;
"RTN","MAGJEX2",40,0)
PRIOR1(MAGGRY,DATA) ; review all exams for a patient to find "related" exams
"RTN","MAGJEX2",41,0)
 ; This ep also called as subroutine from routing software (P51)
"RTN","MAGJEX2",42,0)
 ; MAGGRY - return array of exams to PreFetch, or Auto-send to RAD W/S
"RTN","MAGJEX2",43,0)
 ; DATA:  - input params for the Current Exam
"RTN","MAGJEX2",44,0)
 ;   1) ACTION = P -- Pre-fetch Exams (from Jukebox to Magnetic Disk)
"RTN","MAGJEX2",45,0)
 ;             = A -- Auto-route priors
"RTN","MAGJEX2",46,0)
 ;   2) RADFN  = Case pointers to Rad/Nuc Med Patient file
"RTN","MAGJEX2",47,0)
 ;   3) RADTI  =  ""        ""         ""          ""
"RTN","MAGJEX2",48,0)
 ;   4) RACNI  =  ""        ""         ""          ""
"RTN","MAGJEX2",49,0)
 ;   5) RARPT  - Case pointer to ^RARPT global
"RTN","MAGJEX2",50,0)
 ;
"RTN","MAGJEX2",51,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJEX2"
"RTN","MAGJEX2",52,0)
 E  S X="ERR^MAGJEX2",@^%ZOSF("TRAP")
"RTN","MAGJEX2",53,0)
 K MAGGRY
"RTN","MAGJEX2",54,0)
 N RADFN,RADTI,RACNI,RARPT,RADATA
"RTN","MAGJEX2",55,0)
 N DAYCASE,DIQUIET,ACTION,CPT,HDR,MAGDFN,MAGDTI,MAGCNI,MAGRET,MAGRACNT
"RTN","MAGJEX2",56,0)
 S ACTION=$P(DATA,U)
"RTN","MAGJEX2",57,0)
 I ACTION="P"!(ACTION="A")
"RTN","MAGJEX2",58,0)
 E  S MAGGRY(0)="0^Invalid Request (Action code="_ACTION_")" G PRIOR1Z
"RTN","MAGJEX2",59,0)
 S MAGDFN=$P(DATA,U,2),MAGDTI=$P(DATA,U,3),MAGCNI=$P(DATA,U,4)
"RTN","MAGJEX2",60,0)
 I MAGDFN,MAGDTI,MAGCNI
"RTN","MAGJEX2",61,0)
 E  S MAGGRY(0)="0^Request Contains Invalid Case Pointer ("_DATA_")" G PRIOR1Z
"RTN","MAGJEX2",62,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJEX2",63,0)
 N MAGJOB D MAGJOB^MAGJUTL3
"RTN","MAGJEX2",64,0)
 S HDR=$S(ACTION="P":"Pre-fetch",ACTION="A":"Auto-Display",1:"???")_" Prior Exams for CASE: "
"RTN","MAGJEX2",65,0)
 I '$D(^DPT(MAGDFN,0)) S MAGGRY(0)="0^Request Contains Invalid Patient Pointer ("_MAGDFN_")" G PRIOR1Z
"RTN","MAGJEX2",66,0)
 I $D(^RADPT(MAGDFN,"DT",MAGDTI,"P",MAGCNI))
"RTN","MAGJEX2",67,0)
 E  S MAGGRY(0)="0^Request Contains Invalid Case Pointer ("_MAGCNI_")" G PRIOR1Z
"RTN","MAGJEX2",68,0)
 S MAGRACNT=0
"RTN","MAGJEX2",69,0)
 S MAGGRY(0)="0^Compiling Prior Radiology Exams"
"RTN","MAGJEX2",70,0)
 D GETEXAM2^MAGJUTL1(MAGDFN,MAGDTI,MAGCNI,"",.MAGRET) ; Current Exam only
"RTN","MAGJEX2",71,0)
 S RADFN=MAGDFN,RADTI=MAGDTI,RACNI=MAGCNI
"RTN","MAGJEX2",72,0)
 I 'MAGRET S MAGGRY(0)="0^Current Case is Not Accessible" G PRIOR1Z
"RTN","MAGJEX2",73,0)
 S RADATA=$G(^TMP($J,"MAGRAEX",1,1)) S DAYCASE=$P(RADATA,U,12) D SVMAG2A
"RTN","MAGJEX2",74,0)
 I 'MAGGRY(0) S MAGGRY(0)="0^Current Case either has no CPT code, or has no rules defined for its CPT code." G PRIOR1Z
"RTN","MAGJEX2",75,0)
 S HDR=HDR_DAYCASE
"RTN","MAGJEX2",76,0)
 D SRCH(MAGDFN)  ;  Search prior exams for this patient
"RTN","MAGJEX2",77,0)
PRIOR1Z ;
"RTN","MAGJEX2",78,0)
 I 'MAGGRY(0) S:(MAGGRY(0)["Compiling") MAGGRY(0)="0^No Exams Found"
"RTN","MAGJEX2",79,0)
 E  I +MAGGRY(0)=1 S MAGGRY(0)="0^No Prior Exams Found" K MAGGRY(1)
"RTN","MAGJEX2",80,0)
 E  D SVMAG2B
"RTN","MAGJEX2",81,0)
 K ^TMP($J,"MAGRAEX"),^("RAE1")
"RTN","MAGJEX2",82,0)
 Q
"RTN","MAGJEX2",83,0)
 ;
"RTN","MAGJEX2",84,0)
SRCH(RADFN) ; Traverse all exams for a patient, up to limits of age & total
"RTN","MAGJEX2",85,0)
 ; numbers of exams to consider
"RTN","MAGJEX2",86,0)
 N BEGDT,LIMYRS,LIMEXAMS,X
"RTN","MAGJEX2",87,0)
 S X=$G(^MAG(2006.69,1,0))
"RTN","MAGJEX2",88,0)
 S LIMYRS=+$P(X,U,14),LIMEXAMS=+$P(X,U,15)
"RTN","MAGJEX2",89,0)
 S:'LIMYRS LIMYRS=10 S:'LIMEXAMS LIMEXAMS=100 ; default limit # Exams
"RTN","MAGJEX2",90,0)
 S BEGDT=($E(DT,1,3)-LIMYRS)_$E(DT,4,7)
"RTN","MAGJEX2",91,0)
 I BEGDT<2950101 S BEGDT=2950101 ; 2 yrs prior to earliest VistaPACS
"RTN","MAGJEX2",92,0)
 S MAGRACNT=1 D GETEXAM3^MAGJUTL1(RADFN,BEGDT,"",.MAGRACNT,.MAGRET,"",LIMEXAMS)
"RTN","MAGJEX2",93,0)
 I MAGRET N IDAT S IDAT=1 D
"RTN","MAGJEX2",94,0)
 . F  S IDAT=$O(^TMP($J,"MAGRAEX",IDAT)) Q:'IDAT  S RADATA=^(IDAT,1) D
"RTN","MAGJEX2",95,0)
 .. S RADTI=$P(RADATA,U,2),RACNI=$P(RADATA,U,3)
"RTN","MAGJEX2",96,0)
 .. I RADTI=MAGDTI&(RACNI=MAGCNI) Q  ; skip current case
"RTN","MAGJEX2",97,0)
 .. D SVMAG2A
"RTN","MAGJEX2",98,0)
 Q
"RTN","MAGJEX2",99,0)
 ;
"RTN","MAGJEX2",100,0)
SVMAG2A ; 2A and 2B used by subroutine at tag PRIOR1
"RTN","MAGJEX2",101,0)
 ; Find all the patient's exams whose CPT codes are related to the
"RTN","MAGJEX2",102,0)
 ; Current exam's CPT code, according to dictionary 2006.65
"RTN","MAGJEX2",103,0)
 N RAIMGTYP
"RTN","MAGJEX2",104,0)
 N CPT,CPT3,CPT4,CPT5,CURCPTX,CURCPTS,HIT,MAGMATCH,MAGDTH
"RTN","MAGJEX2",105,0)
 S RARPT=+$P(RADATA,U,10)
"RTN","MAGJEX2",106,0)
 I MAGGRY(0) Q:'$P(MAGGRY(1),U)           ;  Cur Case CPT not in map file
"RTN","MAGJEX2",107,0)
 I  Q:(ACTION="P")&'$D(^RARPT(RARPT,2005))  ; nothing to pre-fetch
"RTN","MAGJEX2",108,0)
 I  Q:$P(RADATA,U,15)<2          ; Cancel or Waiting
"RTN","MAGJEX2",109,0)
 ;   Note: if no images, may still want to do Auto-Disp to get Report;
"RTN","MAGJEX2",110,0)
 ;      also, Current Case should still proceed
"RTN","MAGJEX2",111,0)
 S CPT=$P(RADATA,U,17)
"RTN","MAGJEX2",112,0)
 Q:'CPT  ;  algorithm REQUIRES CPT codes be used
"RTN","MAGJEX2",113,0)
 S CPT5=CPT,CPT4=$E(CPT,1,4),CPT3=$E(CPT,1,3)
"RTN","MAGJEX2",114,0)
 S MAGMATCH="^^"
"RTN","MAGJEX2",115,0)
 I 'MAGGRY(0) D  Q:'MAGMATCH  ; No rules defined for Cur. Case's CPT
"RTN","MAGJEX2",116,0)
 . S Y=""
"RTN","MAGJEX2",117,0)
 .  ;  Order of CPT5/4/3 is important for the algorithm, which
"RTN","MAGJEX2",118,0)
 .  ;  uses the 1st rule found at the LOWEST level of detail defined
"RTN","MAGJEX2",119,0)
 . F X=CPT5,CPT4,CPT3 I $D(^MAG(2006.65,"B",X)) S Y=Y_$S(Y:",",1:"")_X S $P(MAGMATCH,U)=Y
"RTN","MAGJEX2",120,0)
 I CPT,MAGGRY(0) D
"RTN","MAGJEX2",121,0)
 .  ; curcpts has the cpt5/4/3 list generated above for Cur. Case CPT's
"RTN","MAGJEX2",122,0)
 . S HIT=0,CURCPTS=$P(MAGGRY(1),U)
"RTN","MAGJEX2",123,0)
 . F  Q:CURCPTS=""  S CURCPTX=$O(^MAG(2006.65,"B",$P(CURCPTS,","),"")) S CURCPTS=$P(CURCPTS,",",2,9) I CURCPTX]"" D  Q:HIT  ; 1st hit only
"RTN","MAGJEX2",124,0)
 .. ;  This algorithm checks from lowest detail to most general, and acts
"RTN","MAGJEX2",125,0)
 .. ;  on the information found at the FIRST Hit only
"RTN","MAGJEX2",126,0)
 .. F CPT="CPT5","CPT4","CPT3" S CPT=@CPT I CPT]"",$D(^MAG(2006.65,CURCPTX,1,"B",CPT)) S X=$O(^(CPT,"")) D  S HIT=1 Q  ;1st hit only
"RTN","MAGJEX2",127,0)
 ... S X=^MAG(2006.65,CURCPTX,1,X,0) S Y=$S(ACTION="A":2,1:5),X=$P(X,U,Y,Y+2)
"RTN","MAGJEX2",128,0)
 ... I +X S MAGMATCH=CPT F I=2,3 S $P(MAGMATCH,U,I)=$P(X,U,I)
"RTN","MAGJEX2",129,0)
 ;         sample of logic file:
"RTN","MAGJEX2",130,0)
 ; ^MAG(2006.65,1,0) = 730
"RTN","MAGJEX2",131,0)
 ; ^MAG(2006.65,1,1,0) = ^12000011.01^2^2
"RTN","MAGJEX2",132,0)
 ; ^MAG(2006.65,1,1,1,0) = 730^1^40^6^1^120^10
"RTN","MAGJEX2",133,0)
 ; ^MAG(2006.65,1,1,2,0) = 732^1^40^2^1^120^4
"RTN","MAGJEX2",134,0)
 ; ^MAG(2006.65,1,1,"B",730,1) =
"RTN","MAGJEX2",135,0)
 ; ^MAG(2006.65,1,1,"B",732,2) =
"RTN","MAGJEX2",136,0)
 ; ^MAG(2006.65,"B",730,1) =
"RTN","MAGJEX2",137,0)
 ;
"RTN","MAGJEX2",138,0)
 Q:'MAGMATCH
"RTN","MAGJEX2",139,0)
   ; 1  RADFN   RADTI    RACNI   RANME   RASSN    <-- from GETEXAM
"RTN","MAGJEX2",140,0)
   ; 6  RADATE  RADTE    RACN    RAPRC   RARPT
"RTN","MAGJEX2",141,0)
   ; 11 RAST    DAYCASE  RAELOC  RASTP   RASTORD
"RTN","MAGJEX2",142,0)
   ; 16 RADTPRT RACPT    RAIMGTYP
"RTN","MAGJEX2",143,0)
 S X=$P(RADATA,U,7) D H^%DTC S MAGDTH=+%H
"RTN","MAGJEX2",144,0)
 S X=$P(RADATA,U,18)
"RTN","MAGJEX2",145,0)
 S RAIMGTYP=$S(X]"":$O(^RA(79.2,"C",X,"")),1:X) ; <*> chg to Fileman call
"RTN","MAGJEX2",146,0)
 S Y=MAGGRY(0)+1,$P(MAGGRY(0),U)=Y,MAGGRY(Y)=MAGMATCH_U_MAGDTH_U_U_$P(RADATA,U,9)_U_RAIMGTYP_U_RADFN_U_RADTI_U_RACNI_U_RARPT_U_$P(RADATA,U,12)_U_$P(RADATA,U,11)
"RTN","MAGJEX2",147,0)
 Q
"RTN","MAGJEX2",148,0)
 ;
"RTN","MAGJEX2",149,0)
SVMAG2B ; For exams whose CPTs match, select a subset that are within defined
"RTN","MAGJEX2",150,0)
 ; limits with respect to time interval & maximum # exams to retrieve
"RTN","MAGJEX2",151,0)
 ; Return MAGGRY(0) =  count ^ message
"RTN","MAGJEX2",152,0)
 ;        MAGGRY(1:N) = "M08" | RADFN ^ RADTI ^ RACNI ^ RARPT
"RTN","MAGJEX2",153,0)
 N CPT,CT,CURDAT,ICPT,IREC,GO
"RTN","MAGJEX2",154,0)
 S CURDAT=$P(MAGGRY(1),U,4)
"RTN","MAGJEX2",155,0)
 F IREC=2:1:MAGGRY(0) S X=MAGGRY(IREC),CPT=+X D  K MAGGRY(IREC)
"RTN","MAGJEX2",156,0)
 . I $P(X,U,2) S Y=CURDAT-$P(X,U,4) S:Y<0 Y=-Y I Y>$P(X,U,2) Q  ;too old
"RTN","MAGJEX2",157,0)
 . S Y=$G(GO(CPT))+1 I CPT,(Y>$P(X,U,3)) Q  ; already have enough cases
"RTN","MAGJEX2",158,0)
 . S GO(CPT)=Y,GO(CPT,Y)=X
"RTN","MAGJEX2",159,0)
 K MAGGRY
"RTN","MAGJEX2",160,0)
 I $D(GO) S CT=0,CPT="" D
"RTN","MAGJEX2",161,0)
 . F  S CPT=$O(GO(CPT)) Q:CPT=""  F ICPT=1:1:GO(CPT) D
"RTN","MAGJEX2",162,0)
 .. S CT=CT+1,X=GO(CPT,ICPT),RARPT=$P(X,U,11)
"RTN","MAGJEX2",163,0)
 .. S MAGGRY(CT)="M08^"_CPT_"|"_$P(X,U,8,11)
"RTN","MAGJEX2",164,0)
 .. I ACTION="P"!(ACTION="A") S Y=$$JBFETCH^MAGJUTL2(RARPT)  ; fetch from jukebox
"RTN","MAGJEX2",165,0)
 . S MAGGRY(0)=CT_"^"_HDR
"RTN","MAGJEX2",166,0)
 E  S MAGGRY(0)="0^No Exams Found for "_HDR
"RTN","MAGJEX2",167,0)
 Q
"RTN","MAGJEX2",168,0)
 ;
"RTN","MAGJEX2",169,0)
END ;
"RTN","MAGUXRF")
0^46^B17102779
"RTN","MAGUXRF",1,0)
MAGUXRF ;WOIFO/SRR - Imaging MUMPS cross-references ; 03/08/2005  09:16
"RTN","MAGUXRF",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGUXRF",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGUXRF",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGUXRF",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGUXRF",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGUXRF",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGUXRF",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGUXRF",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGUXRF",10,0)
 ;; |                                                               |
"RTN","MAGUXRF",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGUXRF",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGUXRF",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGUXRF",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGUXRF",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGUXRF",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGUXRF",17,0)
 ;;
"RTN","MAGUXRF",18,0)
SETACT D AC(1) Q
"RTN","MAGUXRF",19,0)
KILLACT D AC(0) Q
"RTN","MAGUXRF",20,0)
 ;
"RTN","MAGUXRF",21,0)
AC(SETKIL) N ACTION,ROUTINE,TYPE
"RTN","MAGUXRF",22,0)
 ; "AC" Cross Reference for OBJECT TYPE - ACTION subfile
"RTN","MAGUXRF",23,0)
 ;  ^MAG(2005.02,"AC",OBJECT TYPE,ACTION)=OBJECT TYPE^ACTION ROUTINE
"RTN","MAGUXRF",24,0)
 S TYPE=$P(^MAG(2005.02,DA(1),0),"^",1)
"RTN","MAGUXRF",25,0)
 S ACTION=^MAG(2005.02,DA(1),1,DA,0)
"RTN","MAGUXRF",26,0)
 S ROUTINE=$P(ACTION,".",2),ACTION=$P(ACTION,".",1)
"RTN","MAGUXRF",27,0)
 S:SETKIL ^MAG(2005.02,"AC",TYPE,ACTION)=TYPE_"^"_ROUTINE
"RTN","MAGUXRF",28,0)
 K:'SETKIL ^MAG(2005.02,"AC",TYPE,ACTION)
"RTN","MAGUXRF",29,0)
 K MAGACT1,MAGMETH,MAG
"RTN","MAGUXRF",30,0)
 Q
"RTN","MAGUXRF",31,0)
 ;
"RTN","MAGUXRF",32,0)
SETPX ; Set PACS switch on; check fields first
"RTN","MAGUXRF",33,0)
 ; Write checks
"RTN","MAGUXRF",34,0)
 S ^MAG(2006.1,"APACS")=1
"RTN","MAGUXRF",35,0)
 Q
"RTN","MAGUXRF",36,0)
 ;
"RTN","MAGUXRF",37,0)
KILPX ; Stop PACS system
"RTN","MAGUXRF",38,0)
 K ^MAG(2006.1,"APACS")
"RTN","MAGUXRF",39,0)
 Q
"RTN","MAGUXRF",40,0)
 ;
"RTN","MAGUXRF",41,0)
SETPDPX ; Set P(atient) D(ate) PX(procedure)
"RTN","MAGUXRF",42,0)
 D SET Q:PDT=""  Q:DFN=""
"RTN","MAGUXRF",43,0)
 S ^MAG(2005,"APDPX",DFN,PDT,PX,DA)=""
"RTN","MAGUXRF",44,0)
 Q
"RTN","MAGUXRF",45,0)
 ;
"RTN","MAGUXRF",46,0)
SET S X0=^MAG(2005,DA,0),X2=$G(^(2))
"RTN","MAGUXRF",47,0)
 S PDT=$P(X2,U,5) I PDT="" S PDT=$P(X2,U) Q:PDT=""
"RTN","MAGUXRF",48,0)
 S DFN=$P(X0,U,7) Q:DFN=""
"RTN","MAGUXRF",49,0)
 ;
"RTN","MAGUXRF",50,0)
4 S PX=$P(X0,U,8) I PX="" S PX="OTHER"
"RTN","MAGUXRF",51,0)
 Q
"RTN","MAGUXRF",52,0)
 ;
"RTN","MAGUXRF",53,0)
KILPDPX ; Kill
"RTN","MAGUXRF",54,0)
 D SET Q:PDT=""  Q:DFN=""
"RTN","MAGUXRF",55,0)
 K ^MAG(2005,"APDPX",DFN,PDT,PX,DA)
"RTN","MAGUXRF",56,0)
 Q
"RTN","MAGUXRF",57,0)
 ;
"RTN","MAGUXRF",58,0)
SETPPXD ; #5:Set (patient=X=DFN); #6:PX(procedure); #15:DT(procedure date/time)
"RTN","MAGUXRF",59,0)
 ; Xref for patient field#5=Patient name (in form of DFN)
"RTN","MAGUXRF",60,0)
 ; ^MAG(2005,"APPXDT",X,PX,reverseDT)=""
"RTN","MAGUXRF",61,0)
 N CDT,RDT,PX,ER
"RTN","MAGUXRF",62,0)
 D SETUP Q:$D(ER)
"RTN","MAGUXRF",63,0)
 S ^MAG(2005,"APPXDT",X,PX,RDT,DA)=""
"RTN","MAGUXRF",64,0)
 S ^MAG(2005,"APDTPX",X,RDT,PX,DA)=""
"RTN","MAGUXRF",65,0)
 Q
"RTN","MAGUXRF",66,0)
 ;
"RTN","MAGUXRF",67,0)
SETUP ; Set up for patient Xref's-for field #5l
"RTN","MAGUXRF",68,0)
 S PX=$P(^MAG(2005,DA,0),U,8),CDT=$P($G(^(2)),U,5)
"RTN","MAGUXRF",69,0)
 I CDT="" S ER=1 Q
"RTN","MAGUXRF",70,0)
 I PX="" S ER=1 Q
"RTN","MAGUXRF",71,0)
 S RDT=9999999.9999-CDT
"RTN","MAGUXRF",72,0)
 Q
"RTN","MAGUXRF",73,0)
 ;
"RTN","MAGUXRF",74,0)
KILPPXD ;#5:KILL (PATIENT=X=DFN); #6:PX(PROCEDURE); #15:DT(PROCEDURE DATE/TIME)
"RTN","MAGUXRF",75,0)
 N CDT,PX,RDT,ER
"RTN","MAGUXRF",76,0)
 D SETUP Q:$D(ER)
"RTN","MAGUXRF",77,0)
 K ^MAG(2005,"APPXDT",X,PX,RDT,DA)
"RTN","MAGUXRF",78,0)
 K ^MAG(2005,"APDTPX",X,RDT,PX,DA)
"RTN","MAGUXRF",79,0)
 Q
"RTN","MAGUXRF",80,0)
 ;
"RTN","MAGUXRF",81,0)
SETPPXD6 ;#5:SET (PATIENT=X=DFN); #6:PX(PROCEDURE); #15:DT(PROCEDURE DATE/TIME)
"RTN","MAGUXRF",82,0)
 ;XREF FOR PROCEDURE,FIELD#6
"RTN","MAGUXRF",83,0)
 N DFN,CDT,RDT,ER
"RTN","MAGUXRF",84,0)
 D SETUP6 Q:$D(ER)
"RTN","MAGUXRF",85,0)
 S ^MAG(2005,"APPXDT",DFN,X,RDT,DA)=""
"RTN","MAGUXRF",86,0)
 S ^MAG(2005,"APDTPX",DFN,RDT,X,DA)=""
"RTN","MAGUXRF",87,0)
 Q
"RTN","MAGUXRF",88,0)
 ;
"RTN","MAGUXRF",89,0)
SETUP6 ; Set up for procedure xref-field#6
"RTN","MAGUXRF",90,0)
 S DFN=$P(^MAG(2005,DA,0),U,7),CDT=$P($G(^(2)),U,5)
"RTN","MAGUXRF",91,0)
 I CDT="" S ER=1 Q
"RTN","MAGUXRF",92,0)
 I DFN="" S ER=1 Q
"RTN","MAGUXRF",93,0)
 S RDT=9999999.9999-CDT
"RTN","MAGUXRF",94,0)
 Q
"RTN","MAGUXRF",95,0)
 ;
"RTN","MAGUXRF",96,0)
KILPPXD6 ;#5:KILL (PATIENT=X=DFN); #6:PX(PROCEDURE); #15:DT(PROCEDURE DATE/TIME)
"RTN","MAGUXRF",97,0)
 N DFN,CDT,RDT,ER
"RTN","MAGUXRF",98,0)
 D SETUP6 Q:$D(ER)
"RTN","MAGUXRF",99,0)
 K ^MAG(2005,"APPXDT",DFN,X,RDT,DA)
"RTN","MAGUXRF",100,0)
 K ^MAG(2005,"APDTPX",DFN,RDT,X,DA)
"RTN","MAGUXRF",101,0)
 Q
"RTN","MAGUXRF",102,0)
 ;
"RTN","MAGUXRF",103,0)
SETPPXD5 ;#5:SET (PATIENT=X=DFN); #6:PX(PROCEDURE); #15:DT(PROCEDURE DATE/TIME)
"RTN","MAGUXRF",104,0)
 ;XREF FOR FIELD#15
"RTN","MAGUXRF",105,0)
 ;^MAG(2005,"APPXDT",DFN,PX,reverseDT)=""
"RTN","MAGUXRF",106,0)
 N DFN,PX,RDT,ER
"RTN","MAGUXRF",107,0)
 D SETUP5 Q:$D(ER)
"RTN","MAGUXRF",108,0)
 S ^MAG(2005,"APPXDT",DFN,PX,RDT,DA)=""
"RTN","MAGUXRF",109,0)
 S ^MAG(2005,"APDTPX",DFN,RDT,PX,DA)=""
"RTN","MAGUXRF",110,0)
 Q
"RTN","MAGUXRF",111,0)
 ;
"RTN","MAGUXRF",112,0)
SETUP5 ; Set up for for date/time procedure field#15
"RTN","MAGUXRF",113,0)
 S DFN=$P(^MAG(2005,DA,0),U,7),PX=$P(^(0),U,8)
"RTN","MAGUXRF",114,0)
 I PX="" S ER=1 Q
"RTN","MAGUXRF",115,0)
 I DFN="" S ER=1 Q
"RTN","MAGUXRF",116,0)
 S RDT=9999999.9999-X
"RTN","MAGUXRF",117,0)
 Q
"RTN","MAGUXRF",118,0)
 ;
"RTN","MAGUXRF",119,0)
KILPPXD5 ;#5:SET (PATIENT=X=DFN); #6:PX(PROCEDURE); #15:DT(PROCEDURE DATE/TIME)
"RTN","MAGUXRF",120,0)
 N DFN,CDT,ER
"RTN","MAGUXRF",121,0)
 D SETUP5 Q:$D(ER)
"RTN","MAGUXRF",122,0)
 K ^MAG(2005,"APPXDT",DFN,PX,RDT,DA)
"RTN","MAGUXRF",123,0)
 K ^MAG(2005,"APDTPX",DFN,RDT,PX,DA)
"RTN","MAGUXRF",124,0)
 Q
"RTN","MAGUXRF",125,0)
 ;
"RTN","MAGUXRF",126,0)
SETDCM ; Set the cross reference for DICOM SERIES NUM
"RTN","MAGUXRF",127,0)
 ; and DICOM IMAGE NUM fields of the OBJECT GROUP Multiple
"RTN","MAGUXRF",128,0)
 N MAGDSN,MAGDIN
"RTN","MAGUXRF",129,0)
 I '$$BOTHNUM(.MAGDSN,.MAGDIN) Q
"RTN","MAGUXRF",130,0)
 S Z=+^MAG(2005,DA(1),1,DA,0)
"RTN","MAGUXRF",131,0)
 S ^MAG(2005,DA(1),1,"ADCM",MAGDSN,MAGDIN,Z,DA)=""
"RTN","MAGUXRF",132,0)
 Q
"RTN","MAGUXRF",133,0)
 ;
"RTN","MAGUXRF",134,0)
KILLDSN ; Kill the cross reference for DICOM SERIES NUM
"RTN","MAGUXRF",135,0)
 N MAGDSN,MAGDIN
"RTN","MAGUXRF",136,0)
 I '$$BOTHNUM(.MAGDSN,.MAGDIN) Q
"RTN","MAGUXRF",137,0)
 S Z=+^MAG(2005,DA(1),1,DA,0)
"RTN","MAGUXRF",138,0)
 K ^MAG(2005,DA(1),1,"ADCM",X,MAGDIN,Z,DA)
"RTN","MAGUXRF",139,0)
 Q
"RTN","MAGUXRF",140,0)
 ;
"RTN","MAGUXRF",141,0)
KILLDIN ; Kill the DICOM IMAGE NUM cross reference
"RTN","MAGUXRF",142,0)
 ; of the OBJECT GROUP Multiple
"RTN","MAGUXRF",143,0)
 N MAGDSN,MAGDIN
"RTN","MAGUXRF",144,0)
 I '$$BOTHNUM(.MAGDSN,.MAGDIN) Q
"RTN","MAGUXRF",145,0)
 S Z=+^MAG(2005,DA(1),1,DA,0)
"RTN","MAGUXRF",146,0)
 K ^MAG(2005,DA(1),1,"ADCM",MAGDSN,X,Z,DA)
"RTN","MAGUXRF",147,0)
 Q
"RTN","MAGUXRF",148,0)
 ;
"RTN","MAGUXRF",149,0)
BOTHNUM(MAGDSN,MAGDIN) ;
"RTN","MAGUXRF",150,0)
 S MAGDSN=$P($G(^MAG(2005,DA(1),1,DA,0)),U,2)
"RTN","MAGUXRF",151,0)
 S MAGDIN=$P($G(^MAG(2005,DA(1),1,DA,0)),U,3)
"RTN","MAGUXRF",152,0)
 ;GEK 4/4/00
"RTN","MAGUXRF",153,0)
 ; Changed to test for "", not to test I 'DINUM (0 would fail)
"RTN","MAGUXRF",154,0)
 I ((MAGDIN="")!(MAGDSN="")) Q 0
"RTN","MAGUXRF",155,0)
 Q 1
"RTN","MAGVCHK")
0^47^B21002170
"RTN","MAGVCHK",1,0)
MAGVCHK ;WOIFO/EdM - Checksums of Imaging Routines ; 08/22/2005  10:58
"RTN","MAGVCHK",2,0)
 ;;3.0;IMAGING;**51**;26-August-2005
"RTN","MAGVCHK",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVCHK",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGVCHK",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGVCHK",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGVCHK",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGVCHK",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGVCHK",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGVCHK",10,0)
 ;; |                                                               |
"RTN","MAGVCHK",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGVCHK",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGVCHK",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGVCHK",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGVCHK",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGVCHK",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGVCHK",17,0)
 ;;
"RTN","MAGVCHK",18,0)
 Q
"RTN","MAGVCHK",19,0)
 ;
"RTN","MAGVCHK",20,0)
 ; The entry below is called from ET-Phone-Home
"RTN","MAGVCHK",21,0)
 ;
"RTN","MAGVCHK",22,0)
GATEWAY(ZTSK,MAGDBB) ; RPC = MAG VISTA CHECKSUMS
"RTN","MAGVCHK",23,0)
 N D0,X,ZTDESC,ZTDTH,ZTRTN,ZTSAVE
"RTN","MAGVCHK",24,0)
 S ZTSK=0,D0=$O(^MAG(2006.1,0)) Q:'D0
"RTN","MAGVCHK",25,0)
 Q:$G(MAGDBB)'["@"  ; Must be valid e-mail address
"RTN","MAGVCHK",26,0)
 L +^MAG(2006.1,"CHECKSUM"):10 Q:'$T  ; Don't hold up other processing...
"RTN","MAGVCHK",27,0)
 D:$G(^MAG(2006.1,D0,"LAST CHECKSUM"))<DT
"RTN","MAGVCHK",28,0)
 . ;
"RTN","MAGVCHK",29,0)
 . S ZTRTN="CHECK^"_$T(+0)
"RTN","MAGVCHK",30,0)
 . S ZTDESC="Imaging Checksum Collection"
"RTN","MAGVCHK",31,0)
 . S ZTDTH=$H ; Now!
"RTN","MAGVCHK",32,0)
 . S ZTSAVE("MAGDBB")=MAGDBB
"RTN","MAGVCHK",33,0)
 . D ^%ZTLOAD,HOME^%ZIS
"RTN","MAGVCHK",34,0)
 . I '$D(ZTSK) S ZTSK=0 Q  ; TaskMan did not Accept Request
"RTN","MAGVCHK",35,0)
 . ; No matter how many sub-sites in the consolidated site,
"RTN","MAGVCHK",36,0)
 . ; run this program only once per day:
"RTN","MAGVCHK",37,0)
 . S D0=0 F  S D0=$O(^MAG(2006.1,D0)) Q:'D0  S ^MAG(2006.1,D0,"LAST CHECKSUM")=DT
"RTN","MAGVCHK",38,0)
 . Q
"RTN","MAGVCHK",39,0)
 L -^MAG(2006.1,"CHECKSUM")
"RTN","MAGVCHK",40,0)
 Q
"RTN","MAGVCHK",41,0)
 ;
"RTN","MAGVCHK",42,0)
CHECK ; Collect checksums for Imaging Routines
"RTN","MAGVCHK",43,0)
 N CUR,I,MAGFM,R,SITE,X,XMERR,XMID,XMSUB,XMY,XMZ
"RTN","MAGVCHK",44,0)
 Q:$G(MAGDBB)'["@"  ; Must be valid e-mail address
"RTN","MAGVCHK",45,0)
 D DT^DICRW
"RTN","MAGVCHK",46,0)
 D
"RTN","MAGVCHK",47,0)
 . N DATE,I,MAGDATA,MSG,N,PKG,PKT,PV
"RTN","MAGVCHK",48,0)
 . S CUR=$$VERSION^XPDUTL("IMAGING")
"RTN","MAGVCHK",49,0)
 . D LIST^DIC(9.7,,".01;2I;51I","K","*","MAG","MAG*","B",,,"MAGDATA","MSG")
"RTN","MAGVCHK",50,0)
 . S I="" F  S I=$O(MAGDATA("DILIST",2,I)) Q:I=""  D
"RTN","MAGVCHK",51,0)
 . . S I(+$G(MAGDATA("DILIST","ID",I,2)),I)=""
"RTN","MAGVCHK",52,0)
 . . Q
"RTN","MAGVCHK",53,0)
 . S N=0,DATE="" F  S DATE=$O(I(DATE)) Q:DATE=""  D
"RTN","MAGVCHK",54,0)
 . . S I="" F  S I=$O(I(DATE,I)) Q:I=""  D
"RTN","MAGVCHK",55,0)
 . . . S X=$G(MAGDATA("DILIST","ID",I,.01)) Q:$P(X,"*",2)'=CUR
"RTN","MAGVCHK",56,0)
 . . . S PATCH=+$P(X,"*",3) Q:'PATCH
"RTN","MAGVCHK",57,0)
 . . . K:$G(N(1,PATCH)) N(2,N(1,PATCH))
"RTN","MAGVCHK",58,0)
 . . . S N=N+1,N(1,PATCH)=N,N(2,N)=PATCH
"RTN","MAGVCHK",59,0)
 . . . S N(3,N)=$G(MAGDATA("DILIST","ID",I,51))
"RTN","MAGVCHK",60,0)
 . . . Q
"RTN","MAGVCHK",61,0)
 . . Q
"RTN","MAGVCHK",62,0)
 . S CUR=CUR_";IMAGING;",I="**",X=""
"RTN","MAGVCHK",63,0)
 . S N="" F  S N=$O(N(2,N)) Q:N=""  S CUR=CUR_I_N(2,N),X=N(3,N),I=","
"RTN","MAGVCHK",64,0)
 . S:I'="**" CUR=CUR_"**"
"RTN","MAGVCHK",65,0)
 . S:X'="" CUR=CUR_";"_$$FMDATE(X)
"RTN","MAGVCHK",66,0)
 . Q
"RTN","MAGVCHK",67,0)
 S SITE=0 S:$T(INST^XUPARAM)'="" SITE=$$KSP^XUPARAM("INST")
"RTN","MAGVCHK",68,0)
 D:SITE FIND^DIC(4,"",.01,"A",SITE,"*",,,,"MAGFM")
"RTN","MAGVCHK",69,0)
 S SITE=$G(MAGFM("DILIST",1,1)) S:SITE'="" SITE=SITE_" "
"RTN","MAGVCHK",70,0)
 S SITE=SITE_"VistA System"
"RTN","MAGVCHK",71,0)
 K ^TMP("MAG",$J,"CHECKSUM"),MAGFM
"RTN","MAGVCHK",72,0)
 S I=0
"RTN","MAGVCHK",73,0)
 K X D DOMAIN^MAGDRPC1(.X)
"RTN","MAGVCHK",74,0)
 S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)="SID="_X
"RTN","MAGVCHK",75,0)
 S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)="DT="_DT
"RTN","MAGVCHK",76,0)
 S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)="IP=VistA"
"RTN","MAGVCHK",77,0)
 S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)="BLD="_CUR
"RTN","MAGVCHK",78,0)
 S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)="TTL="_SITE
"RTN","MAGVCHK",79,0)
 S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)="PHY=VistA"
"RTN","MAGVCHK",80,0)
 S R="MAG" F  S R=$O(^$R(R)) Q:$E(R,1,3)'="MAG"  D
"RTN","MAGVCHK",81,0)
 . S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)="RTN="_R
"RTN","MAGVCHK",82,0)
 . S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)="CHK="_$$CHK1(R)_"^"_$$CHK2(R)
"RTN","MAGVCHK",83,0)
 . Q
"RTN","MAGVCHK",84,0)
 S I=I+1,^TMP("MAG",$J,"CHECKSUM",I)=""
"RTN","MAGVCHK",85,0)
 S XMSUB="Daily Report"
"RTN","MAGVCHK",86,0)
 S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGVCHK",87,0)
 S XMY(XMID)=""
"RTN","MAGVCHK",88,0)
 S XMY(MAGDBB)=""
"RTN","MAGVCHK",89,0)
 D SENDMSG^XMXAPI(XMID,XMSUB,$NAME(^TMP("MAG",$J,"CHECKSUM")),.XMY,,.XMZ,)
"RTN","MAGVCHK",90,0)
 I $G(XMERR) M XMERR=^TMP("XMERR",$J) S $EC=",U13-Cannot send MailMan message,"
"RTN","MAGVCHK",91,0)
 Q
"RTN","MAGVCHK",92,0)
 ;
"RTN","MAGVCHK",93,0)
CHK1(R) N K,X,Y
"RTN","MAGVCHK",94,0)
 S Y=0
"RTN","MAGVCHK",95,0)
 F K=1:1 S X=$T(+K^@R) Q:X=""  S:K'=2 Y=Y+$$C1(X)
"RTN","MAGVCHK",96,0)
 Q Y
"RTN","MAGVCHK",97,0)
 ;
"RTN","MAGVCHK",98,0)
C1(X) N F,I,Y
"RTN","MAGVCHK",99,0)
 S Y=0
"RTN","MAGVCHK",100,0)
 S F=$F(X," "),F=$S($E(X,F)'=";":$L(X),$E(X,F+1)=";":$L(X),1:F-2)
"RTN","MAGVCHK",101,0)
 F I=1:1:F S Y=$A(X,I)*I+Y
"RTN","MAGVCHK",102,0)
 Q Y
"RTN","MAGVCHK",103,0)
 ;
"RTN","MAGVCHK",104,0)
CHK2(R) N K,X,Y
"RTN","MAGVCHK",105,0)
 S Y=0
"RTN","MAGVCHK",106,0)
 F K=1:1 S X=$T(+K^@R) Q:X=""  S:K'=2 Y=Y+$$C2(X,K)
"RTN","MAGVCHK",107,0)
 Q Y
"RTN","MAGVCHK",108,0)
 ;
"RTN","MAGVCHK",109,0)
C2(X,K) N F,I,Y
"RTN","MAGVCHK",110,0)
 S Y=0
"RTN","MAGVCHK",111,0)
 S F=$F(X," "),F=$S($E(X,F)'=";":$L(X),$E(X,F+1)=";":$L(X),1:F-2)
"RTN","MAGVCHK",112,0)
 F I=1:1:F S Y=$A(X,I)*(I+K)+Y
"RTN","MAGVCHK",113,0)
 Q Y
"RTN","MAGVCHK",114,0)
 ;
"RTN","MAGVCHK",115,0)
FMDATE(X) N D,M,Y
"RTN","MAGVCHK",116,0)
 S X=X\1,D=X#100,M=X\100#100,Y=X\10000+1700
"RTN","MAGVCHK",117,0)
 Q D_"-"_$P("January February March April May June July August September October November December"," ",M)_"-"_Y
"RTN","MAGVCHK",118,0)
 ;
"SEC","^DIC",2006.51,2006.51,0,"AUDIT")
@
"SEC","^DIC",2006.51,2006.51,0,"DD")
@
"SEC","^DIC",2006.51,2006.51,0,"DEL")
@
"SEC","^DIC",2006.51,2006.51,0,"LAYGO")
@
"SEC","^DIC",2006.51,2006.51,0,"RD")
@
"SEC","^DIC",2006.51,2006.51,0,"WR")
@
"SEC","^DIC",2006.532,2006.532,0,"AUDIT")
@
"SEC","^DIC",2006.532,2006.532,0,"DD")
@
"SEC","^DIC",2006.532,2006.532,0,"DEL")
@
"SEC","^DIC",2006.532,2006.532,0,"LAYGO")
@
"SEC","^DIC",2006.532,2006.532,0,"RD")
@
"SEC","^DIC",2006.532,2006.532,0,"WR")
@
"SEC","^DIC",2006.5641,2006.5641,0,"AUDIT")
@
"SEC","^DIC",2006.5641,2006.5641,0,"DD")
@
"SEC","^DIC",2006.5641,2006.5641,0,"DEL")
@
"SEC","^DIC",2006.5641,2006.5641,0,"LAYGO")
@
"SEC","^DIC",2006.5641,2006.5641,0,"RD")
@
"SEC","^DIC",2006.5641,2006.5641,0,"WR")
@
"SEC","^DIC",2006.57,2006.57,0,"AUDIT")
@
"SEC","^DIC",2006.57,2006.57,0,"DD")
@
"SEC","^DIC",2006.57,2006.57,0,"DEL")
@
"SEC","^DIC",2006.57,2006.57,0,"LAYGO")
@
"SEC","^DIC",2006.57,2006.57,0,"RD")
@
"SEC","^DIC",2006.57,2006.57,0,"WR")
@
"SEC","^DIC",2006.5715,2006.5715,0,"AUDIT")
@
"SEC","^DIC",2006.5715,2006.5715,0,"DD")
@
"SEC","^DIC",2006.5715,2006.5715,0,"DEL")
@
"SEC","^DIC",2006.5715,2006.5715,0,"LAYGO")
@
"SEC","^DIC",2006.5715,2006.5715,0,"RD")
@
"SEC","^DIC",2006.5715,2006.5715,0,"WR")
@
"SEC","^DIC",2006.5732,2006.5732,0,"AUDIT")
@
"SEC","^DIC",2006.5732,2006.5732,0,"DD")
@
"SEC","^DIC",2006.5732,2006.5732,0,"DEL")
@
"SEC","^DIC",2006.5732,2006.5732,0,"LAYGO")
@
"SEC","^DIC",2006.5732,2006.5732,0,"RD")
@
"SEC","^DIC",2006.5732,2006.5732,0,"WR")
@
"SEC","^DIC",2006.574,2006.574,0,"AUDIT")
@
"SEC","^DIC",2006.574,2006.574,0,"DD")
@
"SEC","^DIC",2006.574,2006.574,0,"DEL")
@
"SEC","^DIC",2006.574,2006.574,0,"LAYGO")
@
"SEC","^DIC",2006.574,2006.574,0,"RD")
@
"SEC","^DIC",2006.574,2006.574,0,"WR")
@
"SEC","^DIC",2006.575,2006.575,0,"AUDIT")
@
"SEC","^DIC",2006.575,2006.575,0,"DD")
@
"SEC","^DIC",2006.575,2006.575,0,"DEL")
@
"SEC","^DIC",2006.575,2006.575,0,"LAYGO")
@
"SEC","^DIC",2006.575,2006.575,0,"RD")
@
"SEC","^DIC",2006.575,2006.575,0,"WR")
@
"SEC","^DIC",2006.5762,2006.5762,0,"AUDIT")
@
"SEC","^DIC",2006.5762,2006.5762,0,"DD")
@
"SEC","^DIC",2006.5762,2006.5762,0,"DEL")
@
"SEC","^DIC",2006.5762,2006.5762,0,"LAYGO")
@
"SEC","^DIC",2006.5762,2006.5762,0,"RD")
@
"SEC","^DIC",2006.5762,2006.5762,0,"WR")
@
"SEC","^DIC",2006.587,2006.587,0,"AUDIT")
@
"SEC","^DIC",2006.587,2006.587,0,"DD")
@
"SEC","^DIC",2006.587,2006.587,0,"DEL")
@
"SEC","^DIC",2006.587,2006.587,0,"LAYGO")
@
"SEC","^DIC",2006.587,2006.587,0,"RD")
@
"SEC","^DIC",2006.587,2006.587,0,"WR")
@
"VER")
8.0^22.0
"^DD",2005,2005,251,0)
DICOM SOP CLASS^P2006.532'^MAG(2006.532,^SOP;1^Q
"^DD",2005,2005,251,3)
Identify the SOP Class that was used to acquire this image.
"^DD",2005,2005,251,21,0)
^^2^2^3050111^
"^DD",2005,2005,251,21,1,0)
The value of this field is a pointer. The pointed to record
"^DD",2005,2005,251,21,2,0)
identifies the DICOM SOP Class that was used to acquire this image.
"^DD",2005,2005,251,"DT")
3050111
"^DD",2005.1,2005.1,251,0)
DICOM SOP CLASS^P2006.532'^MAG(2006.532,^SOP;1^Q
"^DD",2005.1,2005.1,251,3)
Identify the SOP Class that was used to acquire this image.
"^DD",2005.1,2005.1,251,21,0)
^^2^2^3050111^
"^DD",2005.1,2005.1,251,21,1,0)
The value of this field is a pointer. The pointed to record
"^DD",2005.1,2005.1,251,21,2,0)
identifies the DICOM SOP Class that was used to acquire this image.
"^DD",2005.1,2005.1,251,"DT")
3050111
"^DD",2005.2,2005.2,14,0)
COMPRESSION^S^NONE:None;J2K:JPEG-2000;^1;7^Q
"^DD",2005.2,2005.2,14,.1)
Type of data compression
"^DD",2005.2,2005.2,14,3)
Enter a code for the type of compression (NONE means no compression).
"^DD",2005.2,2005.2,14,21,0)
^.001^2^2^3040903^^^
"^DD",2005.2,2005.2,14,21,1,0)
The value of this field is a code that indicate which type of compression,
"^DD",2005.2,2005.2,14,21,2,0)
if any, is to be used while transmitting files to this network location.
"^DD",2005.2,2005.2,14,"DT")
3040903
"^DD",2005.2,2005.2,26,0)
ROUTER^SOX^0:NO;1:YES;^0;9^Q:DA="+1"  S:$P(^MAG(2005.2,DA,0),U,9)="" $P(^MAG(2005.2,DA,0),U,9)="0"
"^DD",2005.2,2005.2,26,2)
S Y(0)=Y S:Y="" Y="0"
"^DD",2005.2,2005.2,26,2.1)
S:Y="" Y="0"
"^DD",2005.2,2005.2,26,21,0)
^.001^4^4^3050119^^^
"^DD",2005.2,2005.2,26,21,1,0)
This boolean value is used to designate certain network location shares
"^DD",2005.2,2005.2,26,21,2,0)
as routing shares.  This is necessary to allow clinical WS applications
"^DD",2005.2,2005.2,26,21,3,0)
access to images on these shares but to prevent the background processor
"^DD",2005.2,2005.2,26,21,4,0)
from designating this share as the current write location.
"^DD",2005.2,2005.2,26,"DT")
3050119
"^DD",2006.035,2006.035,.01,0)
IMAGE^RP2005'^MAG(2005,^0;1^Q
"^DD",2006.035,2006.035,.01,.1)
Image
"^DD",2006.035,2006.035,.01,1,0)
^.1^^0
"^DD",2006.035,2006.035,.01,3)

"^DD",2006.035,2006.035,.01,21,0)
^^3^3^3000216^^
"^DD",2006.035,2006.035,.01,21,1,0)
The value of this field is a pointer to the image file.
"^DD",2006.035,2006.035,.01,21,2,0)
This entry in the SEND queue is intended to cause transmission
"^DD",2006.035,2006.035,.01,21,3,0)
of files for the image that is indicated by this pointer.
"^DD",2006.035,2006.035,.01,"DT")
3020312
"^DD",2006.035,2006.035,1,0)
DESTINATION^RV^^0;2^Q
"^DD",2006.035,2006.035,1,3)
Enter the name of the destination to which images are to be transmitted.
"^DD",2006.035,2006.035,1,21,0)
^.001^10^10^3041029^^^
"^DD",2006.035,2006.035,1,21,1,0)
The value of this field is a "Variable Pointer".
"^DD",2006.035,2006.035,1,21,2,0)
 
"^DD",2006.035,2006.035,1,21,3,0)
The pointer may reference either an entry in
"^DD",2006.035,2006.035,1,21,4,0)
either File 2005.2 (Imaging Network Location) or
"^DD",2006.035,2006.035,1,21,5,0)
File 2006.585 (DICOM User Application).
"^DD",2006.035,2006.035,1,21,6,0)
 
"^DD",2006.035,2006.035,1,21,7,0)
When pointing to File 2005.2, images will be
"^DD",2006.035,2006.035,1,21,8,0)
transmitted using a host-system copy protocol;
"^DD",2006.035,2006.035,1,21,9,0)
when pointing to File 2006.585, images will be
"^DD",2006.035,2006.035,1,21,10,0)
transmitted using the DICOM protocol.
"^DD",2006.035,2006.035,1,"DT")
3020312
"^DD",2006.035,2006.035,1,"V",0)
^.12P^3^3
"^DD",2006.035,2006.035,1,"V",1,0)
2005.2^Send to which Network Location^1^N^n^n
"^DD",2006.035,2006.035,1,"V",2,0)
2006.585^Send to which DICOM SCU^2^D^n^n
"^DD",2006.035,2006.035,1,"V",3,0)
2006.587^Send to which DICOM SCU^3^DCM^n^n
"^DD",2006.035,2006.035,2,0)
TYPE^RS^ABSTRACT:ABSTRACT;FULL:FULL;BIG:BIG;TEXT:TEXT;DICOM:DICOM;^0;3^Q
"^DD",2006.035,2006.035,2,.1)
Type of file
"^DD",2006.035,2006.035,2,1,0)
^.1^^0
"^DD",2006.035,2006.035,2,21,0)
^^2^2^2980921^
"^DD",2006.035,2006.035,2,21,1,0)
This field identifies the kind of file that is to be transmitted.
"^DD",2006.035,2006.035,2,21,2,0)
Currently 5 possible types exist (Abstract, Full, Big, Text and DICOM).
"^DD",2006.035,2006.035,2,"DT")
3020312
"^DD",2006.035,2006.035,3,0)
STATUS^S^WAITING:WAITING;SENDING:SENDING;SENT:SENT;FAILED:FAILED;^1;1^Q
"^DD",2006.035,2006.035,3,.1)
Status
"^DD",2006.035,2006.035,3,1,0)
^.1^^0
"^DD",2006.035,2006.035,3,21,0)
^^11^11^3000216^^
"^DD",2006.035,2006.035,3,21,1,0)
The value of this field indicates the status of the queue-entry.
"^DD",2006.035,2006.035,3,21,2,0)
Normally, an entry goes through three stages:
"^DD",2006.035,2006.035,3,21,3,0)
First, the status is "WAITING".
"^DD",2006.035,2006.035,3,21,4,0)
When the queue-processor starts working on the current file, the status will become "SENDING".
"^DD",2006.035,2006.035,3,21,5,0)
When the file has been transmitted, the status will change to "SENT".
"^DD",2006.035,2006.035,3,21,6,0)
 
"^DD",2006.035,2006.035,3,21,7,0)
When a transmission fails, the queue processor will make a number of additional attempts to
"^DD",2006.035,2006.035,3,21,8,0)
transmit the file. If all attempts remain unsuccessful, the status
"^DD",2006.035,2006.035,3,21,9,0)
will be changed to "FAILED".
"^DD",2006.035,2006.035,3,21,10,0)
 
"^DD",2006.035,2006.035,3,21,11,0)
There is a menu option to "re-queue" entries with a status of "FAILED".
"^DD",2006.035,2006.035,3,"DT")
3020312
"^DD",2006.035,2006.035,4,0)
PRIORITY^NJ3,0^^1;2^K:+X'=X!(X>999)!(X<1)!(X?.E1"."1N.N) X
"^DD",2006.035,2006.035,4,.1)
Relative priority
"^DD",2006.035,2006.035,4,1,0)
^.1^^0
"^DD",2006.035,2006.035,4,3)
Enter a number that represents the priority (normal is 500).
"^DD",2006.035,2006.035,4,21,0)
^^4^4^3000216^^
"^DD",2006.035,2006.035,4,21,1,0)
This field indicates the relative priority of the entry in the queue.
"^DD",2006.035,2006.035,4,21,2,0)
Normally, all entries have priority 500.
"^DD",2006.035,2006.035,4,21,3,0)
The software may assign a low priority (250) or a high priority (750).
"^DD",2006.035,2006.035,4,21,4,0)
In the future further refinement of these priorities is expected.
"^DD",2006.035,2006.035,4,"DT")
3020312
"^DD",2006.035,2006.035,8,0)
ORIGIN^RP4'^DIC(4,^0;5^Q
"^DD",2006.035,2006.035,8,3)
Enter the location from which this image originates.
"^DD",2006.035,2006.035,8,21,0)
^^5^5^3010309^
"^DD",2006.035,2006.035,8,21,1,0)
The value of this field is a pointer (to the Institution
"^DD",2006.035,2006.035,8,21,2,0)
file, #4). The institution that is identified by this value
"^DD",2006.035,2006.035,8,21,3,0)
is the place where the image "comes from". In the context
"^DD",2006.035,2006.035,8,21,4,0)
of auto-routing, the image "comes from" the place where it
"^DD",2006.035,2006.035,8,21,5,0)
is permanently stored.
"^DD",2006.035,2006.035,8,"DT")
3020312
"^DD",2006.51,2006.51,0)
FIELD^^6^7
"^DD",2006.51,2006.51,0,"DDA")
N
"^DD",2006.51,2006.51,0,"DT")
3050111
"^DD",2006.51,2006.51,0,"IX","B",2006.51,.01)

"^DD",2006.51,2006.51,0,"NM","DICOM DATA ELEMENT DICTIONARY")

"^DD",2006.51,2006.51,0,"VRPK")
IMAGING
"^DD",2006.51,2006.51,.01,0)
TAG^RF^^0;1^K:$L(X)>20!($L(X)<10)!'(X'?1P.E) X
"^DD",2006.51,2006.51,.01,.1)
ELEMENT TAG
"^DD",2006.51,2006.51,.01,1,0)
^.1
"^DD",2006.51,2006.51,.01,1,1,0)
2006.51^B
"^DD",2006.51,2006.51,.01,1,1,1)
S ^MAGDICOM(2006.51,"B",$E(X,1,30),DA)=""
"^DD",2006.51,2006.51,.01,1,1,2)
K ^MAGDICOM(2006.51,"B",$E(X,1,30),DA)
"^DD",2006.51,2006.51,.01,3)
The ELEMENT TAG must be of the format gggg,owner,eeee.
"^DD",2006.51,2006.51,.01,21,0)
^^2^2^2950421^^
"^DD",2006.51,2006.51,.01,21,1,0)
The ELEMENT TAG is a the triplet {group, owner, element} that uniquely
"^DD",2006.51,2006.51,.01,21,2,0)
identifies each DICOM element.
"^DD",2006.51,2006.51,.01,"DT")
2950421
"^DD",2006.51,2006.51,1,0)
DESCRIPTION^F^^0;2^K:$L(X)>30!($L(X)<3) X
"^DD",2006.51,2006.51,1,1,0)
^.1^^0
"^DD",2006.51,2006.51,1,3)
Answer must be 3-30 characters in length.
"^DD",2006.51,2006.51,1,21,0)
^^1^1^2980128^^
"^DD",2006.51,2006.51,1,21,1,0)
Description from the DICOM Data Dictionary.
"^DD",2006.51,2006.51,1,"DT")
2990830
"^DD",2006.51,2006.51,2,0)
VALUE REPRESENTATION^RS^AE:AE;AS:AS;AT:AT;CS:CS;DA:DA;DS:DS;DT:DT;FL:FL;FD:FD;IS:IS;LO:LO;LT:LT;OB:OB;OW:OW;PN:PN;SH:SH;SL:SL;SQ:SQ;SS:SS;ST:ST;TM:TM;UI:UI;UL:UL;US:US;NULL:NULL;UT:UT;^0;3^Q
"^DD",2006.51,2006.51,2,21,0)
^^29^29^3000216^^^^
"^DD",2006.51,2006.51,2,21,1,0)
The value of this field is a code for the "value representation"
"^DD",2006.51,2006.51,2,21,2,0)
of the DICOM element.
"^DD",2006.51,2006.51,2,21,3,0)
Possible values are taken from part 5, section 6 of the DICOM standard:
"^DD",2006.51,2006.51,2,21,4,0)
 AE: Application Entity
"^DD",2006.51,2006.51,2,21,5,0)
 AS: Age String
"^DD",2006.51,2006.51,2,21,6,0)
 AT: Attribute Tag
"^DD",2006.51,2006.51,2,21,7,0)
 CS: Code String
"^DD",2006.51,2006.51,2,21,8,0)
 DA: Date
"^DD",2006.51,2006.51,2,21,9,0)
 DS: Decimal String
"^DD",2006.51,2006.51,2,21,10,0)
 DT: Date Time
"^DD",2006.51,2006.51,2,21,11,0)
 FL: Floating Point
"^DD",2006.51,2006.51,2,21,12,0)
 FD: Floating Point Double
"^DD",2006.51,2006.51,2,21,13,0)
 IS: Integer String
"^DD",2006.51,2006.51,2,21,14,0)
 LO: Long String
"^DD",2006.51,2006.51,2,21,15,0)
 LT: Long Text
"^DD",2006.51,2006.51,2,21,16,0)
 OB: Other Byte String
"^DD",2006.51,2006.51,2,21,17,0)
 OW: Other Word String
"^DD",2006.51,2006.51,2,21,18,0)
 PN: Person Name
"^DD",2006.51,2006.51,2,21,19,0)
 SH: Short String
"^DD",2006.51,2006.51,2,21,20,0)
 SL: Signed Long
"^DD",2006.51,2006.51,2,21,21,0)
 SQ: Sequence of Items
"^DD",2006.51,2006.51,2,21,22,0)
 SS: Signed Short
"^DD",2006.51,2006.51,2,21,23,0)
 ST: Short Text
"^DD",2006.51,2006.51,2,21,24,0)
 TM: Time
"^DD",2006.51,2006.51,2,21,25,0)
 UI: Unique Identifier (UID)
"^DD",2006.51,2006.51,2,21,26,0)
 UL: Unsigned Long
"^DD",2006.51,2006.51,2,21,27,0)
 UN: Unknown
"^DD",2006.51,2006.51,2,21,28,0)
 US: Unsigned Short
"^DD",2006.51,2006.51,2,21,29,0)
 UT: Unlimited Text
"^DD",2006.51,2006.51,2,"DT")
3000216
"^DD",2006.51,2006.51,3,0)
VALUE MULTIPLICITY^RF^^0;4^K:$L(X)>10!($L(X)<1) X
"^DD",2006.51,2006.51,3,3)
Answer must be 1-10 characters in length.
"^DD",2006.51,2006.51,3,21,0)
^^2^2^3000216^^
"^DD",2006.51,2006.51,3,21,1,0)
Specifies the maximum number of values contained in the value field of a
"^DD",2006.51,2006.51,3,21,2,0)
DICOM data element.
"^DD",2006.51,2006.51,3,"DT")
2950421
"^DD",2006.51,2006.51,4,0)
ENUMERATED VALUE^2006.514^^1;0
"^DD",2006.51,2006.51,5,0)
PERMITTED VALUES^S^E:Enumerated List;D:Defined List;^0;5^Q
"^DD",2006.51,2006.51,5,3)
Qualify the type of values that are allowed for this entity.
"^DD",2006.51,2006.51,5,21,0)
^^7^7^3050111^
"^DD",2006.51,2006.51,5,21,1,0)
The value of this field provides information about
"^DD",2006.51,2006.51,5,21,2,0)
the meaning of the list of possible values.
"^DD",2006.51,2006.51,5,21,3,0)
When the value of this field is "D" (Defined list),
"^DD",2006.51,2006.51,5,21,4,0)
an implementor may choose to add values to the list
"^DD",2006.51,2006.51,5,21,5,0)
for their implementation.
"^DD",2006.51,2006.51,5,21,6,0)
When the value of this field is "E" (Enumerated list),
"^DD",2006.51,2006.51,5,21,7,0)
only those values specified in the DICOM standard may occur.
"^DD",2006.51,2006.51,5,"DT")
3050111
"^DD",2006.51,2006.51,6,0)
STATUS^S^R:Retired;^0;6^Q
"^DD",2006.51,2006.51,6,3)
Indicate whether or not this entity is retired.
"^DD",2006.51,2006.51,6,21,0)
^^5^5^3050111^
"^DD",2006.51,2006.51,6,21,1,0)
The value of this field is a code that indicates whether
"^DD",2006.51,2006.51,6,21,2,0)
or not the current entity is "Retired" from the DICOM Standard.
"^DD",2006.51,2006.51,6,21,3,0)
 
"^DD",2006.51,2006.51,6,21,4,0)
When the value of this field is blank, this entity is active.
"^DD",2006.51,2006.51,6,21,5,0)
When the value of this field is equal to "R", this entity is retired.
"^DD",2006.51,2006.51,6,"DT")
3050111
"^DD",2006.51,2006.514,0)
ENUMERATED VALUE SUB-FIELD^^2^2
"^DD",2006.51,2006.514,0,"DT")
2990830
"^DD",2006.51,2006.514,0,"IX","B",2006.514,.01)

"^DD",2006.51,2006.514,0,"NM","ENUMERATED VALUE")

"^DD",2006.51,2006.514,0,"UP")
2006.51
"^DD",2006.51,2006.514,.01,0)
ENUMERATED VALUE^MF^^0;1^K:$L(X)>50!($L(X)<1) X
"^DD",2006.51,2006.514,.01,1,0)
^.1
"^DD",2006.51,2006.514,.01,1,1,0)
2006.514^B
"^DD",2006.51,2006.514,.01,1,1,1)
S ^MAGDICOM(2006.51,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",2006.51,2006.514,.01,1,1,2)
K ^MAGDICOM(2006.51,DA(1),1,"B",$E(X,1,30),DA)
"^DD",2006.51,2006.514,.01,3)
Answer must be 1-50 characters in length.
"^DD",2006.51,2006.514,.01,21,0)
^^2^2^3001004^^
"^DD",2006.51,2006.514,.01,21,1,0)
The value of this field is a code.
"^DD",2006.51,2006.514,.01,21,2,0)
Possible values for these codes are described in the DICOM standard.
"^DD",2006.51,2006.514,.01,"DT")
2950421
"^DD",2006.51,2006.514,2,0)
MEANING^F^^0;2^K:$L(X)>50!($L(X)<1) X
"^DD",2006.51,2006.514,2,3)
Enter a text that describes the meaning of the value.
"^DD",2006.51,2006.514,2,21,0)
^^2^2^3001004^^
"^DD",2006.51,2006.514,2,21,1,0)
The value of this field is a text that describes the meaning
"^DD",2006.51,2006.514,2,21,2,0)
of the code that is specified in the current entry.
"^DD",2006.51,2006.514,2,"DT")
2990830
"^DD",2006.532,2006.532,0)
FIELD^^4^4
"^DD",2006.532,2006.532,0,"DT")
3050114
"^DD",2006.532,2006.532,0,"NM","DICOM SOP CLASS")

"^DD",2006.532,2006.532,0,"PT",2005,251)

"^DD",2006.532,2006.532,0,"PT",2005.1,251)

"^DD",2006.532,2006.532,0,"PT",2006.532,3)

"^DD",2006.532,2006.532,.01,0)
SOP CLASS UID^RF^^0;1^K:$L(X)>64!($L(X)<1)!'($TR(X,"1234567890.")="") X
"^DD",2006.532,2006.532,.01,1,0)
^.1^^0
"^DD",2006.532,2006.532,.01,3)
Enter the SOP Class that was used to acquire an image.
"^DD",2006.532,2006.532,.01,21,0)
^^6^6^3050111^
"^DD",2006.532,2006.532,.01,21,1,0)
The value of this field is a DICOM UID.
"^DD",2006.532,2006.532,.01,21,2,0)
A unique identifier (UID) in DICOM is a string of up to 64 characters
"^DD",2006.532,2006.532,.01,21,3,0)
long that consists of only digits and periods.
"^DD",2006.532,2006.532,.01,21,4,0)
 
"^DD",2006.532,2006.532,.01,21,5,0)
The UIDs that are stored in this file identify the SOP Classes
"^DD",2006.532,2006.532,.01,21,6,0)
that are being used for Image Acquisition.
"^DD",2006.532,2006.532,.01,"DT")
3050111
"^DD",2006.532,2006.532,2,0)
SOP CLASS NAME^RF^^0;2^K:$L(X)>100!($L(X)<1) X
"^DD",2006.532,2006.532,2,3)
Enter the name of this SOP Class.
"^DD",2006.532,2006.532,2,21,0)
^^4^4^3050114^
"^DD",2006.532,2006.532,2,21,1,0)
The value of this field is a string. This string identifies
"^DD",2006.532,2006.532,2,21,2,0)
a DICOM SOP Class.
"^DD",2006.532,2006.532,2,21,3,0)
 
"^DD",2006.532,2006.532,2,21,4,0)
Valid names for SOP Classes are defined in the DICOM Standard.
"^DD",2006.532,2006.532,2,"DT")
3050114
"^DD",2006.532,2006.532,3,0)
EQUIVALENCE CLASS^P2006.532'^MAG(2006.532,^0;3^Q
"^DD",2006.532,2006.532,3,3)
If there is an equivalent SOP Class, enter its identification.
"^DD",2006.532,2006.532,3,21,0)
^^6^6^3050114^
"^DD",2006.532,2006.532,3,21,1,0)
The value of this field is a pointer to another entry in this same table.
"^DD",2006.532,2006.532,3,21,2,0)
If the SOP Class that is described in the current record is
"^DD",2006.532,2006.532,3,21,3,0)
equivalent to another one, the value of this field identifies
"^DD",2006.532,2006.532,3,21,4,0)
this other SOP Class.
"^DD",2006.532,2006.532,3,21,5,0)
 
"^DD",2006.532,2006.532,3,21,6,0)
If there is no equivalent SOP Class, this field is empty.
"^DD",2006.532,2006.532,3,"DT")
3050114
"^DD",2006.532,2006.532,4,0)
ACTIVE^RS^A:Active;R:Retired;^0;4^Q
"^DD",2006.532,2006.532,4,3)
Indicate whether the current entry is Active or Retired.
"^DD",2006.532,2006.532,4,21,0)
^^6^6^3050114^
"^DD",2006.532,2006.532,4,21,1,0)
The value of this field is a code that indicates whether the
"^DD",2006.532,2006.532,4,21,2,0)
SOP Class that is described in the current entry is active or
"^DD",2006.532,2006.532,4,21,3,0)
retired.
"^DD",2006.532,2006.532,4,21,4,0)
 
"^DD",2006.532,2006.532,4,21,5,0)
Retired entries cannot be removed from this table (because
"^DD",2006.532,2006.532,4,21,6,0)
they may still be "pointed to").
"^DD",2006.532,2006.532,4,"DT")
3050114
"^DD",2006.563,2006.563,84,0)
ET ADDRESS^F^^ET ADDRESS;1^K:$L(X)>100!($L(X)<3) X
"^DD",2006.563,2006.563,84,3)
Enter the e-mail address for the ET Phone Home mailgroup.
"^DD",2006.563,2006.563,84,21,0)
^^5^5^3050224^
"^DD",2006.563,2006.563,84,21,1,0)
The value of this field is a string. This string identifies
"^DD",2006.563,2006.563,84,21,2,0)
the mail-group that is used to process messages containing
"^DD",2006.563,2006.563,84,21,3,0)
routine checksum information.
"^DD",2006.563,2006.563,84,21,4,0)
 
"^DD",2006.563,2006.563,84,21,5,0)
Typically, the value will look like: G.MAGDBB@DOMAIN.EXT
"^DD",2006.563,2006.563,84,"DT")
3050224
"^DD",2006.563,2006.563,85,0)
MAG VISTA CHECKSUMS^S^YES:Yes;NO:No;^MAG VISTA CHECKSUMS;1^Q
"^DD",2006.563,2006.563,85,3)
Indicate whether or not reports with VistA routine checksums are to be sent.
"^DD",2006.563,2006.563,85,21,0)
^^6^6^3050224^
"^DD",2006.563,2006.563,85,21,1,0)
The value of this field is a code that indicates whether or not
"^DD",2006.563,2006.563,85,21,2,0)
reports will be sent containing the checksums of all imaging
"^DD",2006.563,2006.563,85,21,3,0)
routines on the VistA system.
"^DD",2006.563,2006.563,85,21,4,0)
 
"^DD",2006.563,2006.563,85,21,5,0)
A value of YES indicates that reports are to be sent.
"^DD",2006.563,2006.563,85,21,6,0)
A value of NO indicates that no reports are to be sent.
"^DD",2006.563,2006.563,85,"DT")
3050224
"^DD",2006.5641,2006.5641,0)
FIELD^^3^3
"^DD",2006.5641,2006.5641,0,"DT")
3041210
"^DD",2006.5641,2006.5641,0,"IX","B",2006.5641,.01)

"^DD",2006.5641,2006.5641,0,"IX","C",2006.5641,2)

"^DD",2006.5641,2006.5641,0,"NM","DICOM GATEWAY MACHINE ID")

"^DD",2006.5641,2006.5641,.01,0)
MACHINE ID^RF^^0;1^K:$L(X)>1!($L(X)<1)!'(X?1U) X
"^DD",2006.5641,2006.5641,.01,1,0)
^.1
"^DD",2006.5641,2006.5641,.01,1,1,0)
2006.5641^B
"^DD",2006.5641,2006.5641,.01,1,1,1)
S ^MAGDICOM(2006.5641,"B",$E(X,1,30),DA)=""
"^DD",2006.5641,2006.5641,.01,1,1,2)
K ^MAGDICOM(2006.5641,"B",$E(X,1,30),DA)
"^DD",2006.5641,2006.5641,.01,3)
Enter the Machine ID (1 letter) of this DICOM Gateway.
"^DD",2006.5641,2006.5641,.01,21,0)
^^3^3^3041210^
"^DD",2006.5641,2006.5641,.01,21,1,0)
The value of this field is a string that is used as the
"^DD",2006.5641,2006.5641,.01,21,2,0)
"Machine ID" of a DICOM Gateway. A "Machine ID" is a
"^DD",2006.5641,2006.5641,.01,21,3,0)
single uppercase character.
"^DD",2006.5641,2006.5641,.01,"DT")
3041210
"^DD",2006.5641,2006.5641,2,0)
HOSTNAME^RF^^0;2^K:$L(X)>30!($L(X)<1) X
"^DD",2006.5641,2006.5641,2,1,0)
^.1
"^DD",2006.5641,2006.5641,2,1,1,0)
2006.5641^C
"^DD",2006.5641,2006.5641,2,1,1,1)
S ^MAGDICOM(2006.5641,"C",$E(X,1,30),DA)=""
"^DD",2006.5641,2006.5641,2,1,1,2)
K ^MAGDICOM(2006.5641,"C",$E(X,1,30),DA)
"^DD",2006.5641,2006.5641,2,1,1,"%D",0)
^^1^1^3041210^
"^DD",2006.5641,2006.5641,2,1,1,"%D",1,0)
This cross reference keeps track of which hostnames are registered.
"^DD",2006.5641,2006.5641,2,1,1,"DT")
3041210
"^DD",2006.5641,2006.5641,2,3)
Enter the hostname of the computer that is used for this DICOM Gateway.
"^DD",2006.5641,2006.5641,2,21,0)
^^9^9^3041210^
"^DD",2006.5641,2006.5641,2,21,1,0)
The value of this field is a string. This string represents the
"^DD",2006.5641,2006.5641,2,21,2,0)
'hostname' of the computer that is used for the DICOM Gateway that
"^DD",2006.5641,2006.5641,2,21,3,0)
is described in the current record.
"^DD",2006.5641,2006.5641,2,21,4,0)
 
"^DD",2006.5641,2006.5641,2,21,5,0)
The format of the 'hostname' is subject to VA policy.
"^DD",2006.5641,2006.5641,2,21,6,0)
Policies regarding the format of these names are subject to change, hence no
"^DD",2006.5641,2006.5641,2,21,7,0)
additional formatting restrictions are imposed in this data
"^DD",2006.5641,2006.5641,2,21,8,0)
definition.
"^DD",2006.5641,2006.5641,2,21,9,0)
 
"^DD",2006.5641,2006.5641,2,"DT")
3041210
"^DD",2006.5641,2006.5641,3,0)
TIMESTAMP^F^^0;3^K:$L(X)>10!($L(X)<1)!'(X?1.N1","1.N) X
"^DD",2006.5641,2006.5641,3,3)
Enter the current date and time ($Horolog format)
"^DD",2006.5641,2006.5641,3,21,0)
^.001^3^3^3041210^^
"^DD",2006.5641,2006.5641,3,21,1,0)
The value of this field is a date/time value ($Horolog format).
"^DD",2006.5641,2006.5641,3,21,2,0)
This value represents the date and time when the content of this
"^DD",2006.5641,2006.5641,3,21,3,0)
record was most recently confirmed.
"^DD",2006.5641,2006.5641,3,"DT")
3041210
"^DD",2006.57,2006.57,0)
FIELD^^3^3
"^DD",2006.57,2006.57,0,"DDA")
N
"^DD",2006.57,2006.57,0,"DT")
3001004
"^DD",2006.57,2006.57,0,"IX","B",2006.57,.01)

"^DD",2006.57,2006.57,0,"NM","DICOM HL7 SEGMENT")

"^DD",2006.57,2006.57,0,"VRPK")
IMAGING
"^DD",2006.57,2006.57,.01,0)
SEGMENT^RF^^0;1^K:$L(X)>3!($L(X)<3)!'(X'?1P.E) X
"^DD",2006.57,2006.57,.01,1,0)
^.1
"^DD",2006.57,2006.57,.01,1,1,0)
2006.57^B
"^DD",2006.57,2006.57,.01,1,1,1)
S ^MAGDICOM(2006.57,"B",$E(X,1,30),DA)=""
"^DD",2006.57,2006.57,.01,1,1,2)
K ^MAGDICOM(2006.57,"B",$E(X,1,30),DA)
"^DD",2006.57,2006.57,.01,3)
Enter the abbreviation for the segment-name.
"^DD",2006.57,2006.57,.01,21,0)
^^1^1^2990830^
"^DD",2006.57,2006.57,.01,21,1,0)
The value of this field is the abbreviation for the name of the segment.
"^DD",2006.57,2006.57,.01,"DT")
2990830
"^DD",2006.57,2006.57,2,0)
NAME^RF^^0;2^K:$L(X)>50!($L(X)<1) X
"^DD",2006.57,2006.57,2,3)
Enter the name of the segment.
"^DD",2006.57,2006.57,2,21,0)
^^1^1^2990830^
"^DD",2006.57,2006.57,2,21,1,0)
The value of this field is the name of the segment (fully written out).
"^DD",2006.57,2006.57,2,"DT")
2990830
"^DD",2006.57,2006.57,3,0)
ELEMENT^2006.5701A^^1;0
"^DD",2006.57,2006.5701,0)
ELEMENT SUB-FIELD^^.01^2
"^DD",2006.57,2006.5701,0,"DT")
3001004
"^DD",2006.57,2006.5701,0,"NM","ELEMENT")

"^DD",2006.57,2006.5701,0,"UP")
2006.57
"^DD",2006.57,2006.5701,.001,0)
POSITION NUMBER^NJ9,0^^ ^K:+X'=X!(X>999999999)!(X<1)!(X?.E1"."1N.N) X
"^DD",2006.57,2006.5701,.001,3)
Enter the sequence number of this element.
"^DD",2006.57,2006.5701,.001,21,0)
^^1^1^3001004^
"^DD",2006.57,2006.5701,.001,21,1,0)
The value of this field is the position number of the current element.
"^DD",2006.57,2006.5701,.001,"DT")
3001004
"^DD",2006.57,2006.5701,.01,0)
ELEMENT^F^^0;1^K:$L(X)>50!($L(X)<1) X
"^DD",2006.57,2006.5701,.01,1,0)
^.1^^0
"^DD",2006.57,2006.5701,.01,3)
Enter the name of the element.
"^DD",2006.57,2006.5701,.01,21,0)
^.001^3^3^3001004^^
"^DD",2006.57,2006.5701,.01,21,1,0)
The value of this field is the name of the element.
"^DD",2006.57,2006.5701,.01,21,2,0)
Note that the internal entry number is also the position-number
"^DD",2006.57,2006.5701,.01,21,3,0)
of the element in the segment.
"^DD",2006.57,2006.5701,.01,"DT")
2990830
"^DD",2006.5715,2006.5715,0)
FIELD^^2^2
"^DD",2006.5715,2006.5715,0,"DT")
3050225
"^DD",2006.5715,2006.5715,0,"IX","B",2006.5715,.01)

"^DD",2006.5715,2006.5715,0,"NM","CURRENT IMAGE")

"^DD",2006.5715,2006.5715,.01,0)
MACHINE ID^RF^^0;1^K:$L(X)>1!($L(X)<1)!'(X?1U) X
"^DD",2006.5715,2006.5715,.01,1,0)
^.1
"^DD",2006.5715,2006.5715,.01,1,1,0)
2006.5715^B
"^DD",2006.5715,2006.5715,.01,1,1,1)
S ^MAGD(2006.5715,"B",$E(X,1,30),DA)=""
"^DD",2006.5715,2006.5715,.01,1,1,2)
K ^MAGD(2006.5715,"B",$E(X,1,30),DA)
"^DD",2006.5715,2006.5715,.01,3)
Enter the Machine ID for the current DICOM Gateway.
"^DD",2006.5715,2006.5715,.01,21,0)
^^3^3^3050225^
"^DD",2006.5715,2006.5715,.01,21,1,0)
The value of this field is a 1-character string.
"^DD",2006.5715,2006.5715,.01,21,2,0)
This value identifies the DICOM Gateway for which the
"^DD",2006.5715,2006.5715,.01,21,3,0)
current image is tracked in this record.
"^DD",2006.5715,2006.5715,.01,"DT")
3050225
"^DD",2006.5715,2006.5715,2,0)
UID^RF^^0;2^K:$L(X)>64!($L(X)<1)!'(X?.(1.N,1".")) X
"^DD",2006.5715,2006.5715,2,3)
Enter the UID of the image that is being processed for this DICOM Gateway.
"^DD",2006.5715,2006.5715,2,21,0)
^^5^5^3050225^
"^DD",2006.5715,2006.5715,2,21,1,0)
The value of this field is a string.
"^DD",2006.5715,2006.5715,2,21,2,0)
This string conforms to the DICOM definition of a UID
"^DD",2006.5715,2006.5715,2,21,3,0)
(unique object identifier).
"^DD",2006.5715,2006.5715,2,21,4,0)
This value identifies the image that is currently being processed
"^DD",2006.5715,2006.5715,2,21,5,0)
for the DICOM Gateway that is registered in this record.
"^DD",2006.5715,2006.5715,2,"DT")
3050225
"^DD",2006.5732,2006.5732,0)
FIELD^^5^5
"^DD",2006.5732,2006.5732,0,"DT")
3041201
"^DD",2006.5732,2006.5732,0,"IX","B",2006.5732,.01)

"^DD",2006.5732,2006.5732,0,"NM","DICOM QUERY RETRIEVE RESULT")

"^DD",2006.5732,2006.5732,.01,0)
RESULT^RNJ12,0^^0;1^K:+X'=X!(X>999999999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.5732,2006.5732,.01,1,0)
^.1
"^DD",2006.5732,2006.5732,.01,1,1,0)
2006.5732^B
"^DD",2006.5732,2006.5732,.01,1,1,1)
S ^MAGDQR(2006.5732,"B",$E(X,1,30),DA)=""
"^DD",2006.5732,2006.5732,.01,1,1,2)
K ^MAGDQR(2006.5732,"B",$E(X,1,30),DA)
"^DD",2006.5732,2006.5732,.01,3)
Enter the sequence number of this result-set.
"^DD",2006.5732,2006.5732,.01,21,0)
^^5^5^3041201^
"^DD",2006.5732,2006.5732,.01,21,1,0)
The value of this field is an integer number.
"^DD",2006.5732,2006.5732,.01,21,2,0)
This number uniquely identifies a result-set that
"^DD",2006.5732,2006.5732,.01,21,3,0)
results from a DICOM Query/Retrieve request.
"^DD",2006.5732,2006.5732,.01,21,4,0)
 
"^DD",2006.5732,2006.5732,.01,21,5,0)
The rest of the record is the result-set in question.
"^DD",2006.5732,2006.5732,.01,"DT")
3041201
"^DD",2006.5732,2006.5732,2,0)
STATUS^S^IP:Query in progress;OK:Query complete;X:Query completely reported;^0;2^Q
"^DD",2006.5732,2006.5732,2,3)
Indicate the status of this query.
"^DD",2006.5732,2006.5732,2,21,0)
^^14^14^3041201^
"^DD",2006.5732,2006.5732,2,21,1,0)
The value of this field is a code that indicates the status of
"^DD",2006.5732,2006.5732,2,21,2,0)
a query.
"^DD",2006.5732,2006.5732,2,21,3,0)
 
"^DD",2006.5732,2006.5732,2,21,4,0)
When a query is initiated, the value of this field will be set
"^DD",2006.5732,2006.5732,2,21,5,0)
to IP = In Progress.
"^DD",2006.5732,2006.5732,2,21,6,0)
 
"^DD",2006.5732,2006.5732,2,21,7,0)
When a query is complete, the value of this field will be changed
"^DD",2006.5732,2006.5732,2,21,8,0)
to OK = Query Complete.
"^DD",2006.5732,2006.5732,2,21,9,0)
 
"^DD",2006.5732,2006.5732,2,21,10,0)
When all results that are logged for the query have been reported,
"^DD",2006.5732,2006.5732,2,21,11,0)
the value of this field will be set to X = Query Completely Reported,
"^DD",2006.5732,2006.5732,2,21,12,0)
so that a clean-up process may remove the now obsolete result-set.
"^DD",2006.5732,2006.5732,2,21,13,0)
 
"^DD",2006.5732,2006.5732,2,21,14,0)
(See also the field TIMESTAMP.)
"^DD",2006.5732,2006.5732,2,"DT")
3041201
"^DD",2006.5732,2006.5732,3,0)
TIMESTAMP^D^^0;3^S %DT="ESTXR" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5732,2006.5732,3,3)
Enter the date and time of last access to this result-set.
"^DD",2006.5732,2006.5732,3,21,0)
^^10^10^3041201^
"^DD",2006.5732,2006.5732,3,21,1,0)
The value of this field is a timestamp that indicates when a
"^DD",2006.5732,2006.5732,3,21,2,0)
result-set was last accessed.
"^DD",2006.5732,2006.5732,3,21,3,0)
 
"^DD",2006.5732,2006.5732,3,21,4,0)
This value is set to the current date and time when the result-set
"^DD",2006.5732,2006.5732,3,21,5,0)
is first marked as complete, and will be updated each time
"^DD",2006.5732,2006.5732,3,21,6,0)
a (partial) result is reported.
"^DD",2006.5732,2006.5732,3,21,7,0)
 
"^DD",2006.5732,2006.5732,3,21,8,0)
The main purpose of this field to to assist a maintenance process
"^DD",2006.5732,2006.5732,3,21,9,0)
in cleaning up result-sets that haven't been accessed in more than
"^DD",2006.5732,2006.5732,3,21,10,0)
a couple of days.
"^DD",2006.5732,2006.5732,3,"DT")
3041201
"^DD",2006.5732,2006.5732,4,0)
TAG^2006.57321A^^1;0
"^DD",2006.5732,2006.5732,5,0)
TASKMAN^NJ12,0^^0;4^K:+X'=X!(X>999999999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.5732,2006.5732,5,3)
Enter the process-number of the TaskMan process that does the query.
"^DD",2006.5732,2006.5732,5,21,0)
^^11^11^3041201^
"^DD",2006.5732,2006.5732,5,21,1,0)
The value of this field is a number.
"^DD",2006.5732,2006.5732,5,21,2,0)
 
"^DD",2006.5732,2006.5732,5,21,3,0)
This number is returned by TaskMan when a new background
"^DD",2006.5732,2006.5732,5,21,4,0)
process is created to perform the actual query.
"^DD",2006.5732,2006.5732,5,21,5,0)
 
"^DD",2006.5732,2006.5732,5,21,6,0)
This number will be used to query TaskMan to see whether
"^DD",2006.5732,2006.5732,5,21,7,0)
the background process has completed.
"^DD",2006.5732,2006.5732,5,21,8,0)
 
"^DD",2006.5732,2006.5732,5,21,9,0)
Note: if the background process is no longer active,
"^DD",2006.5732,2006.5732,5,21,10,0)
and no result-set has been delivered, the error log should
"^DD",2006.5732,2006.5732,5,21,11,0)
be checked for any problems.
"^DD",2006.5732,2006.5732,5,"DT")
3041201
"^DD",2006.5732,2006.57321,0)
TAG SUB-FIELD^^2^2
"^DD",2006.5732,2006.57321,0,"DT")
3041201
"^DD",2006.5732,2006.57321,0,"IX","B",2006.57321,.01)

"^DD",2006.5732,2006.57321,0,"NM","TAG")

"^DD",2006.5732,2006.57321,0,"UP")
2006.5732
"^DD",2006.5732,2006.57321,.01,0)
TAG^RF^^0;1^K:$L(X)>9!($L(X)<9) X
"^DD",2006.5732,2006.57321,.01,1,0)
^.1
"^DD",2006.5732,2006.57321,.01,1,1,0)
2006.57321^B
"^DD",2006.5732,2006.57321,.01,1,1,1)
S ^MAGDQR(2006.5732,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",2006.5732,2006.57321,.01,1,1,2)
K ^MAGDQR(2006.5732,DA(1),1,"B",$E(X,1,30),DA)
"^DD",2006.5732,2006.57321,.01,3)
Enter the DICOM tag (xxxx,xxxx) for the current value.
"^DD",2006.5732,2006.57321,.01,21,0)
^^6^6^3041201^
"^DD",2006.5732,2006.57321,.01,21,1,0)
The value of this field is a string that represents a DICOM tag.
"^DD",2006.5732,2006.57321,.01,21,2,0)
A DICOM tag consists of two pairs of 4 hexadecimal digits,
"^DD",2006.5732,2006.57321,.01,21,3,0)
separated by a comma.
"^DD",2006.5732,2006.57321,.01,21,4,0)
 
"^DD",2006.5732,2006.57321,.01,21,5,0)
The DICOM tag qualifies the meaning of the data-value that
"^DD",2006.5732,2006.57321,.01,21,6,0)
is stored in the rest of the current record.
"^DD",2006.5732,2006.57321,.01,"DT")
3041201
"^DD",2006.5732,2006.57321,2,0)
VALUE^F^^0;2^K:$L(X)>200!($L(X)<1) X
"^DD",2006.5732,2006.57321,2,3)
Enter the value for the current DICOM tag.
"^DD",2006.5732,2006.57321,2,21,0)
^^5^5^3041201^
"^DD",2006.5732,2006.57321,2,21,1,0)
The value of this field is a string.
"^DD",2006.5732,2006.57321,2,21,2,0)
This value is used to report the actual value of a certain
"^DD",2006.5732,2006.57321,2,21,3,0)
DICOM element in response to a query. The DICOM element in
"^DD",2006.5732,2006.57321,2,21,4,0)
question is identified by the TAG at the start of the current
"^DD",2006.5732,2006.57321,2,21,5,0)
record.
"^DD",2006.5732,2006.57321,2,"DT")
3041201
"^DD",2006.574,2006.574,0)
FIELD^^5^5
"^DD",2006.574,2006.574,0,"DDA")
N
"^DD",2006.574,2006.574,0,"DT")
3041029
"^DD",2006.574,2006.574,0,"NM","DICOM IMAGE OUTPUT")

"^DD",2006.574,2006.574,0,"VRPK")
IMAGING
"^DD",2006.574,2006.574,.01,0)
APPLICATION^RF^^0;1^K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X
"^DD",2006.574,2006.574,.01,1,0)
^.1^^0
"^DD",2006.574,2006.574,.01,3)
Enter the name of the application that will receive the file(s).
"^DD",2006.574,2006.574,.01,21,0)
^^8^8^3000222^^
"^DD",2006.574,2006.574,.01,21,1,0)
The value of this field is a string that identifies
"^DD",2006.574,2006.574,.01,21,2,0)
the application that will receive the image files
"^DD",2006.574,2006.574,.01,21,3,0)
for which this entry describes the parameters.
"^DD",2006.574,2006.574,.01,21,4,0)
 
"^DD",2006.574,2006.574,.01,21,5,0)
The name that is entered here corresponds to the
"^DD",2006.574,2006.574,.01,21,6,0)
name (.01 field) in file 2006.585 (stored in ^MAGDICOM(2006.585,...)
"^DD",2006.574,2006.574,.01,21,7,0)
of the storage provider that will receive the image
"^DD",2006.574,2006.574,.01,21,8,0)
files.
"^DD",2006.574,2006.574,.01,"DT")
3000222
"^DD",2006.574,2006.574,2,0)
GROUP^P2005'^MAG(2005,^0;2^Q
"^DD",2006.574,2006.574,2,3)
Identify the group of images that is to be transported.
"^DD",2006.574,2006.574,2,21,0)
^^7^7^3000222^^
"^DD",2006.574,2006.574,2,21,1,0)
The value of this field is a pointer that identifies
"^DD",2006.574,2006.574,2,21,2,0)
the image that is the 'parent' of the group of images
"^DD",2006.574,2006.574,2,21,3,0)
for which this entry describes the transmission to
"^DD",2006.574,2006.574,2,21,4,0)
another storage provider.
"^DD",2006.574,2006.574,2,21,5,0)
 
"^DD",2006.574,2006.574,2,21,6,0)
The value of this field is a pointer to the Image File
"^DD",2006.574,2006.574,2,21,7,0)
(2005, stored in ^MAG(2005,...).
"^DD",2006.574,2006.574,2,"DT")
3000222
"^DD",2006.574,2006.574,3,0)
ACCESSION NUMBER^F^^0;3^K:$L(X)>20!($L(X)<1) X
"^DD",2006.574,2006.574,3,3)
Enter the accession number for the (group of) image(s) to be transported.
"^DD",2006.574,2006.574,3,21,0)
^^10^10^3000222^^
"^DD",2006.574,2006.574,3,21,1,0)
The value of this field is the (short) case number
"^DD",2006.574,2006.574,3,21,2,0)
for the study that is referenced in this entry.
"^DD",2006.574,2006.574,3,21,3,0)
 
"^DD",2006.574,2006.574,3,21,4,0)
A long case number consists of two groups of digits
"^DD",2006.574,2006.574,3,21,5,0)
separated by a dash. The first group is 6 digits,
"^DD",2006.574,2006.574,3,21,6,0)
and is derived from the date. The second group is
"^DD",2006.574,2006.574,3,21,7,0)
an integer number that uniquely identifies the study
"^DD",2006.574,2006.574,3,21,8,0)
for that date.
"^DD",2006.574,2006.574,3,21,9,0)
 
"^DD",2006.574,2006.574,3,21,10,0)
For this field, the whole accession number is entered.
"^DD",2006.574,2006.574,3,"DT")
3000222
"^DD",2006.574,2006.574,4,0)
IMAGE^2006.5744PA^^1;0
"^DD",2006.574,2006.574,5,0)
FROM^P4'^DIC(4,^0;4^Q
"^DD",2006.574,2006.574,5,1,0)
^.1^^0
"^DD",2006.574,2006.574,5,3)
Enter the name of the "place" from which the image originates.
"^DD",2006.574,2006.574,5,21,0)
^^3^3^3010308^
"^DD",2006.574,2006.574,5,21,1,0)
The value of this field is a pointer (to the Institution file, #4).
"^DD",2006.574,2006.574,5,21,2,0)
This pointer identifies the "place" where the image is permanently
"^DD",2006.574,2006.574,5,21,3,0)
stored.
"^DD",2006.574,2006.574,5,"DT")
3041029
"^DD",2006.574,2006.5744,0)
IMAGE SUB-FIELD^^3^3
"^DD",2006.574,2006.5744,0,"DT")
3041029
"^DD",2006.574,2006.5744,0,"NM","IMAGE")

"^DD",2006.574,2006.5744,0,"UP")
2006.574
"^DD",2006.574,2006.5744,.01,0)
IMAGE^P2005'^MAG(2005,^0;1^Q
"^DD",2006.574,2006.5744,.01,1,0)
^.1^^0
"^DD",2006.574,2006.5744,.01,3)
Identify the image(s) in this transmission.
"^DD",2006.574,2006.5744,.01,21,0)
^^6^6^3000222^^
"^DD",2006.574,2006.5744,.01,21,1,0)
The value of this field is a pointer that identifies
"^DD",2006.574,2006.5744,.01,21,2,0)
one of the images that is to be transmitted to
"^DD",2006.574,2006.5744,.01,21,3,0)
another storage provider.
"^DD",2006.574,2006.5744,.01,21,4,0)
 
"^DD",2006.574,2006.5744,.01,21,5,0)
The value of this field is a pointer to the Image File
"^DD",2006.574,2006.5744,.01,21,6,0)
(2005, stored in ^MAG(2005,...).
"^DD",2006.574,2006.5744,.01,"DT")
3000222
"^DD",2006.574,2006.5744,2,0)
STATUS^S^WAITING:Waiting to be transmitted;XMIT:Transmission in progress;FAIL:Transmission failed;SUCCESS:Transmission successfully completed;^0;2^Q
"^DD",2006.574,2006.5744,2,3)
Indicate the current status of this entry.
"^DD",2006.574,2006.5744,2,21,0)
^^7^7^3041029^
"^DD",2006.574,2006.5744,2,21,1,0)
The value of this field is a code that indicates the current
"^DD",2006.574,2006.5744,2,21,2,0)
status of the entry in this table.
"^DD",2006.574,2006.5744,2,21,3,0)
Possible values are "waiting to be transmitted", "transmission
"^DD",2006.574,2006.5744,2,21,4,0)
in progress" and "successful transmission" or "failed transmission".
"^DD",2006.574,2006.5744,2,21,5,0)
 
"^DD",2006.574,2006.5744,2,21,6,0)
A cross-reference on this field is used to prevent issuing the
"^DD",2006.574,2006.5744,2,21,7,0)
same file to multiple transmission processes.
"^DD",2006.574,2006.5744,2,"DT")
3041029
"^DD",2006.574,2006.5744,3,0)
TIMESTAMP^F^^0;3^K:$L(X)>15!($L(X)<3)!'(X?1.N1","1.N) X
"^DD",2006.574,2006.5744,3,3)
Indicate the current time ($H format).
"^DD",2006.574,2006.5744,3,21,0)
^^10^10^3041029^
"^DD",2006.574,2006.5744,3,21,1,0)
The value of this field is a string ($Horolog format) that
"^DD",2006.574,2006.5744,3,21,2,0)
indicates the date and time that the current status was established.
"^DD",2006.574,2006.5744,3,21,3,0)
 
"^DD",2006.574,2006.5744,3,21,4,0)
This value is used when checking on files that are in a status
"^DD",2006.574,2006.5744,3,21,5,0)
of "transmission in progress". When a file is too long in this
"^DD",2006.574,2006.5744,3,21,6,0)
status, the current entry will be moved back to a status of
"^DD",2006.574,2006.5744,3,21,7,0)
"waiting for transmission".
"^DD",2006.574,2006.5744,3,21,8,0)
 
"^DD",2006.574,2006.5744,3,21,9,0)
See the RPC named "MAG DICOM GET NEXT QUEUE ENTRY" for the
"^DD",2006.574,2006.5744,3,21,10,0)
actual time-lag that decides on a change-back of the status.
"^DD",2006.574,2006.5744,3,"DT")
3041029
"^DD",2006.575,2006.575,0)
FIELD^^37^37
"^DD",2006.575,2006.575,0,"DDA")
N
"^DD",2006.575,2006.575,0,"DT")
3040609
"^DD",2006.575,2006.575,0,"IX","B",2006.575,.01)

"^DD",2006.575,2006.575,0,"IX","F",2006.575,9)

"^DD",2006.575,2006.575,0,"NM","DICOM FAILED IMAGES")

"^DD",2006.575,2006.575,0,"PT",2006.5712,.01)

"^DD",2006.575,2006.575,0,"PT",2006.5712,2)

"^DD",2006.575,2006.575,0,"PT",2006.57526,.01)

"^DD",2006.575,2006.575,0,"VRPK")
MAG
"^DD",2006.575,2006.575,.01,0)
FILEPATH^RF^^0;1^K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X
"^DD",2006.575,2006.575,.01,.1)
File Path
"^DD",2006.575,2006.575,.01,1,0)
^.1
"^DD",2006.575,2006.575,.01,1,1,0)
2006.575^B
"^DD",2006.575,2006.575,.01,1,1,1)
S ^MAGD(2006.575,"B",$E(X,1,30),DA)=""
"^DD",2006.575,2006.575,.01,1,1,2)
K ^MAGD(2006.575,"B",$E(X,1,30),DA)
"^DD",2006.575,2006.575,.01,3)
Enter the name of the image file (including directory path).
"^DD",2006.575,2006.575,.01,21,0)
^^3^3^3000306^^
"^DD",2006.575,2006.575,.01,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,.01,21,2,0)
the name of the image file that failed the matching
"^DD",2006.575,2006.575,.01,21,3,0)
process on the local DICOM Image gateway processing the image.
"^DD",2006.575,2006.575,.01,"DT")
2970226
"^DD",2006.575,2006.575,1,0)
FAILED REASON^S^NO CASE #:No case number;PID ERROR:Could not match patient;UNKNOWN:Any other reason;BAD CASE #:Format error in case number;CANCELLED:Case cancelled;^0;2^Q
"^DD",2006.575,2006.575,1,.1)
Reason for Failure
"^DD",2006.575,2006.575,1,3)
Enter 'No Case #', 'Bad Case #', 'PID Error' or 'Unknown' or 'Cancelled'.
"^DD",2006.575,2006.575,1,21,0)
^^11^11^3030421^
"^DD",2006.575,2006.575,1,21,1,0)
The value of this field is a code that indicates the
"^DD",2006.575,2006.575,1,21,2,0)
reason why the image file that is described in the
"^DD",2006.575,2006.575,1,21,3,0)
current entry could not be matched with a patient
"^DD",2006.575,2006.575,1,21,4,0)
and study.
"^DD",2006.575,2006.575,1,21,5,0)
 
"^DD",2006.575,2006.575,1,21,6,0)
The possible values for this field are NOCASE#, PATIENT, UNKNOWN or 
"^DD",2006.575,2006.575,1,21,7,0)
CANCELLED.
"^DD",2006.575,2006.575,1,21,8,0)
 
"^DD",2006.575,2006.575,1,21,9,0)
When the entry is processed the match for the Radiology entry is by
"^DD",2006.575,2006.575,1,21,10,0)
case number and then by patient ID. If these entries are not provided
"^DD",2006.575,2006.575,1,21,11,0)
correctly then entries are made into this file.
"^DD",2006.575,2006.575,1,"DT")
3030421
"^DD",2006.575,2006.575,2,0)
PID^F^^0;3^K:$L(X)>12!($L(X)<3) X
"^DD",2006.575,2006.575,2,.1)
Patient ID
"^DD",2006.575,2006.575,2,1,0)
^.1^^0
"^DD",2006.575,2006.575,2,3)
Enter the patient's SSN.
"^DD",2006.575,2006.575,2,21,0)
^^11^11^3001006^^
"^DD",2006.575,2006.575,2,21,1,0)
The value of this field is the value that is transmitted
"^DD",2006.575,2006.575,2,21,2,0)
by the modality for DICOM element 0010,0020.
"^DD",2006.575,2006.575,2,21,3,0)
Typically, the value of this field is equal to
"^DD",2006.575,2006.575,2,21,4,0)
the Social Security Number of the patient
"^DD",2006.575,2006.575,2,21,5,0)
for whom the study is scheduled.
"^DD",2006.575,2006.575,2,21,6,0)
(Without the dashes between the number-groups.)
"^DD",2006.575,2006.575,2,21,7,0)
 
"^DD",2006.575,2006.575,2,21,8,0)
This value is copied from the VistA Database, so that
"^DD",2006.575,2006.575,2,21,9,0)
worklist queries can also be performed when the network
"^DD",2006.575,2006.575,2,21,10,0)
connection (DDP) with the main Hospital Information System
"^DD",2006.575,2006.575,2,21,11,0)
is not available.
"^DD",2006.575,2006.575,2,"DT")
3041216
"^DD",2006.575,2006.575,3,0)
PATIENT^F^^0;4^K:$L(X)>35!($L(X)<3) X
"^DD",2006.575,2006.575,3,.1)
Patient Name (VA)
"^DD",2006.575,2006.575,3,1,0)
^.1^^0
"^DD",2006.575,2006.575,3,3)
Enter the name of the patient.
"^DD",2006.575,2006.575,3,21,0)
^^7^7^3000306^^
"^DD",2006.575,2006.575,3,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,3,21,2,0)
the name of the patient.
"^DD",2006.575,2006.575,3,21,3,0)
 
"^DD",2006.575,2006.575,3,21,4,0)
This value is reformatted as LAST NAME,FIRST NAME MID. The actual
"^DD",2006.575,2006.575,3,21,5,0)
name sent by the Radiology modality is in field PNAMEDCM. This field
"^DD",2006.575,2006.575,3,21,6,0)
will be used as one of the possible lookups for correction to this
"^DD",2006.575,2006.575,3,21,7,0)
entry.
"^DD",2006.575,2006.575,3,"DT")
3041216
"^DD",2006.575,2006.575,4,0)
PNAMEDCM^F^^0;5^K:$L(X)>35!($L(X)<3) X
"^DD",2006.575,2006.575,4,.1)
Patient Name (DICOM)
"^DD",2006.575,2006.575,4,1,0)
^.1^^0
"^DD",2006.575,2006.575,4,3)
Enter the name of the patient.
"^DD",2006.575,2006.575,4,21,0)
^^6^6^3000306^^
"^DD",2006.575,2006.575,4,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,4,21,2,0)
the name of the patient.
"^DD",2006.575,2006.575,4,21,3,0)
 
"^DD",2006.575,2006.575,4,21,4,0)
This value is copied from the information that was
"^DD",2006.575,2006.575,4,21,5,0)
transmitted by the Radiology
"^DD",2006.575,2006.575,4,21,6,0)
modality.
"^DD",2006.575,2006.575,4,"DT")
3041216
"^DD",2006.575,2006.575,5,0)
CASENUMB^F^^1;1^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,5,.1)
Case Number (Modality)
"^DD",2006.575,2006.575,5,3)
Enter the case number.
"^DD",2006.575,2006.575,5,21,0)
^^6^6^3000306^^
"^DD",2006.575,2006.575,5,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,5,21,2,0)
the case number for the study.
"^DD",2006.575,2006.575,5,21,3,0)
 
"^DD",2006.575,2006.575,5,21,4,0)
This value is copied from the information that was
"^DD",2006.575,2006.575,5,21,5,0)
transmitted by the Radiology
"^DD",2006.575,2006.575,5,21,6,0)
X-Ray equipment.
"^DD",2006.575,2006.575,5,"DT")
2970226
"^DD",2006.575,2006.575,6,0)
CASE NO.^F^^1;2^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,6,.1)
Case Number (Technician)
"^DD",2006.575,2006.575,6,3)
Enter the case number.
"^DD",2006.575,2006.575,6,21,0)
^^8^8^3000306^^
"^DD",2006.575,2006.575,6,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,6,21,2,0)
the case number for the study.
"^DD",2006.575,2006.575,6,21,3,0)
 
"^DD",2006.575,2006.575,6,21,4,0)
This value is copied from the information that was
"^DD",2006.575,2006.575,6,21,5,0)
entered by the technician during the image capture at
"^DD",2006.575,2006.575,6,21,6,0)
the Radiology X-Ray modality. This field will usually be empty since the
"^DD",2006.575,2006.575,6,21,7,0)
file will contain only entries that failed during the copying of images
"^DD",2006.575,2006.575,6,21,8,0)
to the Imaging file.
"^DD",2006.575,2006.575,6,"DT")
2970226
"^DD",2006.575,2006.575,7,0)
DATE ENTERED^D^^1;3^S %DT="E" D ^%DT S X=Y K:X<1 X
"^DD",2006.575,2006.575,7,.1)
Date Entered
"^DD",2006.575,2006.575,7,3)
Enter today's date.
"^DD",2006.575,2006.575,7,21,0)
^^4^4^3000306^^
"^DD",2006.575,2006.575,7,21,1,0)
The value of this field is a date value.
"^DD",2006.575,2006.575,7,21,2,0)
 
"^DD",2006.575,2006.575,7,21,3,0)
This value must be an exact date and represents
"^DD",2006.575,2006.575,7,21,4,0)
the date on which the entry was made into this file.
"^DD",2006.575,2006.575,7,"DT")
3041216
"^DD",2006.575,2006.575,8,0)
IMAGE UID^F^^AIUID;1^K:$L(X)>70!($L(X)<1) X
"^DD",2006.575,2006.575,8,.1)
Image UID
"^DD",2006.575,2006.575,8,3)
Enter the Image UID code.
"^DD",2006.575,2006.575,8,21,0)
^^7^7^3000306^^
"^DD",2006.575,2006.575,8,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,8,21,2,0)
the Image UID.
"^DD",2006.575,2006.575,8,21,3,0)
 
"^DD",2006.575,2006.575,8,21,4,0)
This value is copied from the information that is
"^DD",2006.575,2006.575,8,21,5,0)
transmitted by the modality. The Image UID is
"^DD",2006.575,2006.575,8,21,6,0)
a unique ID number assigned to the image by the Radiology X-Ray
"^DD",2006.575,2006.575,8,21,7,0)
modality.
"^DD",2006.575,2006.575,8,"DT")
2970226
"^DD",2006.575,2006.575,9,0)
STUDY UID^F^^ASUID;1^K:$L(X)>70!($L(X)<1) X
"^DD",2006.575,2006.575,9,.1)
Study UID
"^DD",2006.575,2006.575,9,1,0)
^.1^^-1
"^DD",2006.575,2006.575,9,1,1,0)
2006.575^F^MUMPS
"^DD",2006.575,2006.575,9,1,1,1)
D XREF^MAGDLB6
"^DD",2006.575,2006.575,9,1,1,2)
D XREFK^MAGDLB6
"^DD",2006.575,2006.575,9,1,1,"%D",0)
^^2^2^3030828^
"^DD",2006.575,2006.575,9,1,1,"%D",1,0)
This cross-reference indexes failed images by location and study instance 
"^DD",2006.575,2006.575,9,1,1,"%D",2,0)
UID.
"^DD",2006.575,2006.575,9,1,1,"DT")
3030828
"^DD",2006.575,2006.575,9,3)
Enter the Study UID code.
"^DD",2006.575,2006.575,9,21,0)
^.001^9^9^3021018^^^
"^DD",2006.575,2006.575,9,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,9,21,2,0)
the Study UID.
"^DD",2006.575,2006.575,9,21,3,0)
 
"^DD",2006.575,2006.575,9,21,4,0)
This value is copied from the information that is
"^DD",2006.575,2006.575,9,21,5,0)
transmitted by the modality. The Image UID is
"^DD",2006.575,2006.575,9,21,6,0)
a unique ID number assigned to the image by the Radiology X-Ray
"^DD",2006.575,2006.575,9,21,7,0)
modality.
"^DD",2006.575,2006.575,9,21,8,0)
A case study will consist of several images, each of which has its
"^DD",2006.575,2006.575,9,21,9,0)
own unique Image UID code.
"^DD",2006.575,2006.575,9,"DT")
3041216
"^DD",2006.575,2006.575,10,0)
INSTRUMENT NAME^F^^AMFG;1^K:$L(X)>10!($L(X)<1) X
"^DD",2006.575,2006.575,10,.1)
Instrument Name
"^DD",2006.575,2006.575,10,1,0)
^.1^^0
"^DD",2006.575,2006.575,10,3)
Enter the name of the instrument.
"^DD",2006.575,2006.575,10,21,0)
^^5^5^3000306^^
"^DD",2006.575,2006.575,10,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,10,21,2,0)
the name of the instrument that produced the image file.
"^DD",2006.575,2006.575,10,21,3,0)
 
"^DD",2006.575,2006.575,10,21,4,0)
Typical values for this field are texts like
"^DD",2006.575,2006.575,10,21,5,0)
CT1, CT2, CR3, and so forth.
"^DD",2006.575,2006.575,10,"DT")
3041216
"^DD",2006.575,2006.575,11,0)
ROWS^F^^AMFG;2^K:$L(X)>10!($L(X)<1) X
"^DD",2006.575,2006.575,11,.1)
Rows
"^DD",2006.575,2006.575,11,3)
Enter the number of pixel rows in the image.
"^DD",2006.575,2006.575,11,21,0)
^^5^5^3000306^^
"^DD",2006.575,2006.575,11,21,1,0)
The value of this field is an integer number that
"^DD",2006.575,2006.575,11,21,2,0)
represents the number of pixel rows in the image.
"^DD",2006.575,2006.575,11,21,3,0)
 
"^DD",2006.575,2006.575,11,21,4,0)
This value is copied from the information that is
"^DD",2006.575,2006.575,11,21,5,0)
transmitted by the Radiology modality.
"^DD",2006.575,2006.575,11,"DT")
2970226
"^DD",2006.575,2006.575,12,0)
COLUMNS^F^^AMFG;3^K:$L(X)>10!($L(X)<1) X
"^DD",2006.575,2006.575,12,.1)
Columns
"^DD",2006.575,2006.575,12,3)
Enter the number of pixel columns in the image.
"^DD",2006.575,2006.575,12,21,0)
^^5^5^3000306^^
"^DD",2006.575,2006.575,12,21,1,0)
The value of this field is an integer number that
"^DD",2006.575,2006.575,12,21,2,0)
represents the number of pixel columns in the image.
"^DD",2006.575,2006.575,12,21,3,0)
 
"^DD",2006.575,2006.575,12,21,4,0)
This value is copied from the information that is
"^DD",2006.575,2006.575,12,21,5,0)
transmitted by the Radiology modality.
"^DD",2006.575,2006.575,12,"DT")
2970226
"^DD",2006.575,2006.575,13,0)
OFFSET^F^^AMFG;4^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,13,.1)
Offset
"^DD",2006.575,2006.575,13,3)
Enter the byte address where the image data begins.
"^DD",2006.575,2006.575,13,21,0)
^^6^6^3000306^^
"^DD",2006.575,2006.575,13,21,1,0)
The value of this field is an integer number that
"^DD",2006.575,2006.575,13,21,2,0)
represents the byte address in the image file where
"^DD",2006.575,2006.575,13,21,3,0)
the image data begins.
"^DD",2006.575,2006.575,13,21,4,0)
 
"^DD",2006.575,2006.575,13,21,5,0)
This value is copied from the information that is
"^DD",2006.575,2006.575,13,21,6,0)
transmitted by the Radiology modality.
"^DD",2006.575,2006.575,13,"DT")
2970226
"^DD",2006.575,2006.575,14,0)
MODIEN^F^^AMFG;5^K:$L(X)>10!($L(X)<1) X
"^DD",2006.575,2006.575,14,.1)
Modien
"^DD",2006.575,2006.575,14,3)
Identify the modality.
"^DD",2006.575,2006.575,14,21,0)
^^5^5^3000306^^
"^DD",2006.575,2006.575,14,21,1,0)
The value of this field is a pointer to the Modality
"^DD",2006.575,2006.575,14,21,2,0)
file (# 2006.582, stored in ^MAGDICOM(2006.582,...).
"^DD",2006.575,2006.575,14,21,3,0)
 
"^DD",2006.575,2006.575,14,21,4,0)
This value identifies the modality (type of instrument)
"^DD",2006.575,2006.575,14,21,5,0)
that transmitted the image file.
"^DD",2006.575,2006.575,14,"DT")
2970226
"^DD",2006.575,2006.575,16,0)
FIXED^S^1:YES;^FIXD;1^Q
"^DD",2006.575,2006.575,16,.1)
Fixed
"^DD",2006.575,2006.575,16,1,0)
^.1^^0
"^DD",2006.575,2006.575,16,3)
Identify whether or not this entry has been corrected.
"^DD",2006.575,2006.575,16,21,0)
^^12^12^3000306^^
"^DD",2006.575,2006.575,16,21,1,0)
The value of this field is a code that identifies
"^DD",2006.575,2006.575,16,21,2,0)
whether or not the problem that is reported in the
"^DD",2006.575,2006.575,16,21,3,0)
current entry has been corrected.
"^DD",2006.575,2006.575,16,21,4,0)
 
"^DD",2006.575,2006.575,16,21,5,0)
Entries are corrected in this file using either of
"^DD",2006.575,2006.575,16,21,6,0)
the menu options
"^DD",2006.575,2006.575,16,21,7,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,16,21,8,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,16,21,9,0)
 
"^DD",2006.575,2006.575,16,21,10,0)
When the entry is
"^DD",2006.575,2006.575,16,21,11,0)
manually matched with a patient and procedure the correction routine will
"^DD",2006.575,2006.575,16,21,12,0)
update this field.
"^DD",2006.575,2006.575,16,23,0)
^^2^2^3000216^
"^DD",2006.575,2006.575,16,23,1,0)
This field creates a cross reference used by the DICOM Image server to know
"^DD",2006.575,2006.575,16,23,2,0)
which entries are ready for re-processing. 
"^DD",2006.575,2006.575,16,"DT")
3041216
"^DD",2006.575,2006.575,17,0)
NEWDFN^F^^FIXD;2^K:$L(X)>10!($L(X)<1) X
"^DD",2006.575,2006.575,17,.1)
New DFN
"^DD",2006.575,2006.575,17,3)
Identify the patient.
"^DD",2006.575,2006.575,17,21,0)
^^8^8^3000306^^
"^DD",2006.575,2006.575,17,21,1,0)
The value of this field is a pointer to the Patient
"^DD",2006.575,2006.575,17,21,2,0)
file (# 2, stored in ^DPT(...).
"^DD",2006.575,2006.575,17,21,3,0)
 
"^DD",2006.575,2006.575,17,21,4,0)
This value identifies the (new) patient, and is
"^DD",2006.575,2006.575,17,21,5,0)
defined using either of
"^DD",2006.575,2006.575,17,21,6,0)
the menu options
"^DD",2006.575,2006.575,17,21,7,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,17,21,8,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,17,"DT")
2970226
"^DD",2006.575,2006.575,18,0)
NEWNME^F^^FIXD;3^K:$L(X)>35!($L(X)<1) X
"^DD",2006.575,2006.575,18,.1)
New Name
"^DD",2006.575,2006.575,18,3)
Enter the name of the patient.
"^DD",2006.575,2006.575,18,21,0)
^^8^8^3000306^^
"^DD",2006.575,2006.575,18,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,18,21,2,0)
the name of a patient.
"^DD",2006.575,2006.575,18,21,3,0)
 
"^DD",2006.575,2006.575,18,21,4,0)
This value identifies the (new) patient, and is
"^DD",2006.575,2006.575,18,21,5,0)
defined using either of
"^DD",2006.575,2006.575,18,21,6,0)
the menu options
"^DD",2006.575,2006.575,18,21,7,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,18,21,8,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,18,"DT")
2970226
"^DD",2006.575,2006.575,19,0)
NEWSSN^F^^FIXD;4^K:$L(X)>10!($L(X)<1) X
"^DD",2006.575,2006.575,19,.1)
Newssn
"^DD",2006.575,2006.575,19,3)
Enter the patient's SSN.
"^DD",2006.575,2006.575,19,21,0)
^^8^8^3000306^^
"^DD",2006.575,2006.575,19,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,19,21,2,0)
the Social Security Number of a patient.
"^DD",2006.575,2006.575,19,21,3,0)
 
"^DD",2006.575,2006.575,19,21,4,0)
This value identifies the (new) patient, and is
"^DD",2006.575,2006.575,19,21,5,0)
defined using either of
"^DD",2006.575,2006.575,19,21,6,0)
the menu options
"^DD",2006.575,2006.575,19,21,7,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,19,21,8,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,19,"DT")
2970226
"^DD",2006.575,2006.575,20,0)
NEWCASE NO^F^^FIXD;5^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,20,.1)
New Case Number
"^DD",2006.575,2006.575,20,3)
Enter the case number.
"^DD",2006.575,2006.575,20,21,0)
^^8^8^3000306^^
"^DD",2006.575,2006.575,20,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,20,21,2,0)
the accession number for a study.
"^DD",2006.575,2006.575,20,21,3,0)
 
"^DD",2006.575,2006.575,20,21,4,0)
This value identifies the (new) study, and is
"^DD",2006.575,2006.575,20,21,5,0)
defined using either of
"^DD",2006.575,2006.575,20,21,6,0)
the menu options
"^DD",2006.575,2006.575,20,21,7,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,20,21,8,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,20,"DT")
2970226
"^DD",2006.575,2006.575,21,0)
NEW RADTI^F^^FIXD;6^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,21,.1)
New Reverse Date
"^DD",2006.575,2006.575,21,3)
Identify the date/time of the study.
"^DD",2006.575,2006.575,21,21,0)
^^12^12^3000306^^
"^DD",2006.575,2006.575,21,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,21,21,2,0)
the date and time when the study was executed.
"^DD",2006.575,2006.575,21,21,3,0)
 
"^DD",2006.575,2006.575,21,21,4,0)
This value is a 'reverse' date time, as defined by
"^DD",2006.575,2006.575,21,21,5,0)
the Radiology software. It is used as the second subscript (RADTI)
"^DD",2006.575,2006.575,21,21,6,0)
in references like ^RARPT(RADPT,"DT",RADTI,"P",RACNI
"^DD",2006.575,2006.575,21,21,7,0)
 
"^DD",2006.575,2006.575,21,21,8,0)
This value timestamps the (new) study, and is
"^DD",2006.575,2006.575,21,21,9,0)
defined using either of
"^DD",2006.575,2006.575,21,21,10,0)
the menu options
"^DD",2006.575,2006.575,21,21,11,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,21,21,12,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,21,"DT")
2970226
"^DD",2006.575,2006.575,22,0)
NEW RACNI^F^^FIXD;7^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,22,.1)
New Case Number
"^DD",2006.575,2006.575,22,3)
Enter the case number.
"^DD",2006.575,2006.575,22,21,0)
^^11^11^3000306^^
"^DD",2006.575,2006.575,22,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,22,21,2,0)
the case number for the study.
"^DD",2006.575,2006.575,22,21,3,0)
 
"^DD",2006.575,2006.575,22,21,4,0)
This value is used as the third subscript (RADCNI)
"^DD",2006.575,2006.575,22,21,5,0)
in references like ^RARPT(RADPT,"DT",RADTI,"P",RACNI
"^DD",2006.575,2006.575,22,21,6,0)
 
"^DD",2006.575,2006.575,22,21,7,0)
This value identifies the (new) study, and is
"^DD",2006.575,2006.575,22,21,8,0)
defined using either of
"^DD",2006.575,2006.575,22,21,9,0)
the menu options
"^DD",2006.575,2006.575,22,21,10,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,22,21,11,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,22,"DT")
2970226
"^DD",2006.575,2006.575,23,0)
DATE/TIME^F^^FIXD;8^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,23,.1)
Date/Time
"^DD",2006.575,2006.575,23,3)
Enter this moment's date and time.
"^DD",2006.575,2006.575,23,21,0)
^^7^7^3000306^^
"^DD",2006.575,2006.575,23,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,23,21,2,0)
a date/time value.
"^DD",2006.575,2006.575,23,21,3,0)
 
"^DD",2006.575,2006.575,23,21,4,0)
This value is copied from the information that was
"^DD",2006.575,2006.575,23,21,5,0)
transmitted by the Radiology modality. It is
"^DD",2006.575,2006.575,23,21,6,0)
a timestamp for the moment when the image
"^DD",2006.575,2006.575,23,21,7,0)
file was processed.
"^DD",2006.575,2006.575,23,"DT")
2970226
"^DD",2006.575,2006.575,24,0)
NEW PROC IEN^F^^FIXPR;1^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,24,.1)
New Procedure IEN
"^DD",2006.575,2006.575,24,3)
Identify the procedure.
"^DD",2006.575,2006.575,24,21,0)
^^8^8^3000306^^
"^DD",2006.575,2006.575,24,21,1,0)
The value of this field is a pointer to the
"^DD",2006.575,2006.575,24,21,2,0)
Rad/Nuc procedure file (#71, stored in ^RAMIS(71,...).
"^DD",2006.575,2006.575,24,21,3,0)
 
"^DD",2006.575,2006.575,24,21,4,0)
This value is an internal entry number, and is
"^DD",2006.575,2006.575,24,21,5,0)
defined using either of
"^DD",2006.575,2006.575,24,21,6,0)
the menu options
"^DD",2006.575,2006.575,24,21,7,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,24,21,8,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,24,"DT")
2970226
"^DD",2006.575,2006.575,25,0)
NEW PROCEDURE^F^^FIXPR;2^K:$L(X)>70!($L(X)<1) X
"^DD",2006.575,2006.575,25,.1)
New Procedure
"^DD",2006.575,2006.575,25,3)
Enter the name of the procedure.
"^DD",2006.575,2006.575,25,21,0)
^^9^9^3000306^^
"^DD",2006.575,2006.575,25,21,1,0)
This is the new procedure name defined using the MAGD FIX DICOM or MAGD FIX MEDICINE menu option.
"^DD",2006.575,2006.575,25,21,2,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,25,21,3,0)
the name of a procedure found in the Rad/Nuc procedure file (#71, stored in ^RAMIS(71,...).
"^DD",2006.575,2006.575,25,21,4,0)
 
"^DD",2006.575,2006.575,25,21,5,0)
This value is the name of a procedure, and is
"^DD",2006.575,2006.575,25,21,6,0)
defined using either of
"^DD",2006.575,2006.575,25,21,7,0)
the menu options
"^DD",2006.575,2006.575,25,21,8,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,25,21,9,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,25,"DT")
2970226
"^DD",2006.575,2006.575,26,0)
RELATED IMAGES^2006.57526PA^^RLATE;0
"^DD",2006.575,2006.575,26,21,0)
^^2^2^3000216^
"^DD",2006.575,2006.575,26,21,1,0)
This is the multiple sub-file that repoints to this file.  This sub-file
"^DD",2006.575,2006.575,26,21,2,0)
will point to all the related images having the same study instance UID.
"^DD",2006.575,2006.575,26,23,0)
^^5^5^3000216^
"^DD",2006.575,2006.575,26,23,1,0)
This field creates a cross reference that is used by the DICOM Image
"^DD",2006.575,2006.575,26,23,2,0)
gateway to process all images pertaining to one unique study instance UID.
"^DD",2006.575,2006.575,26,23,3,0)
 This field also allow the manual correction routines to only
"^DD",2006.575,2006.575,26,23,4,0)
prompt/display a single entry needing corrections and will apply the
"^DD",2006.575,2006.575,26,23,5,0)
corrections made to all entries in this sub-file.
"^DD",2006.575,2006.575,27,0)
MODALITY^F^^AMFG;6^K:$L(X)>30!($L(X)<1) X
"^DD",2006.575,2006.575,27,.1)
Modality
"^DD",2006.575,2006.575,27,3)
Enter the name of the modality (instrument type).
"^DD",2006.575,2006.575,27,21,0)
^^5^5^3000306^^
"^DD",2006.575,2006.575,27,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,27,21,2,0)
the name of a modality.
"^DD",2006.575,2006.575,27,21,3,0)
 
"^DD",2006.575,2006.575,27,21,4,0)
This value represents the name of the modality
"^DD",2006.575,2006.575,27,21,5,0)
(i.e., the type of of instrument) for the images requiring manual correction.
"^DD",2006.575,2006.575,27,"DT")
2970305
"^DD",2006.575,2006.575,28,0)
MACHINE ID^F^^1;4^K:$L(X)>10!($L(X)<1) X
"^DD",2006.575,2006.575,28,.1)
Machine ID
"^DD",2006.575,2006.575,28,3)
Identify the Image Gateway that received the image file.
"^DD",2006.575,2006.575,28,21,0)
^^5^5^3000306^^
"^DD",2006.575,2006.575,28,21,1,0)
The value of this field is a code that identifies
"^DD",2006.575,2006.575,28,21,2,0)
the VistA DICOM Image Gateway computer that received
"^DD",2006.575,2006.575,28,21,3,0)
the image file.
"^DD",2006.575,2006.575,28,21,4,0)
 
"^DD",2006.575,2006.575,28,21,5,0)
Such a code is a single alphabetic letter.
"^DD",2006.575,2006.575,28,"DT")
3041216
"^DD",2006.575,2006.575,29,0)
COMMENT^F^^ACSTXT;1^K:$L(X)>250!($L(X)<2) X
"^DD",2006.575,2006.575,29,.1)
Comment
"^DD",2006.575,2006.575,29,3)
Enter a comment.
"^DD",2006.575,2006.575,29,21,0)
^^7^7^3000306^^
"^DD",2006.575,2006.575,29,21,1,0)
The value of this field is a string that represents
"^DD",2006.575,2006.575,29,21,2,0)
a comment.
"^DD",2006.575,2006.575,29,21,3,0)
 
"^DD",2006.575,2006.575,29,21,4,0)
This value is copied from the information that was
"^DD",2006.575,2006.575,29,21,5,0)
transmitted by the Radiology equipment.
"^DD",2006.575,2006.575,29,21,6,0)
 
"^DD",2006.575,2006.575,29,21,7,0)
Typically, this value contains the accession number.
"^DD",2006.575,2006.575,29,"DT")
2970521
"^DD",2006.575,2006.575,30,0)
IMAGE POINTER^NJ11,0^^FIXPR;3^K:+X'=X!(X>99999999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.575,2006.575,30,.1)
Image Pointer
"^DD",2006.575,2006.575,30,3)
Identify the image.
"^DD",2006.575,2006.575,30,21,0)
^^6^6^3000306^^
"^DD",2006.575,2006.575,30,21,1,0)
The value of this field is a pointer to the Image
"^DD",2006.575,2006.575,30,21,2,0)
file (#2005, stored in ^MAG(2005,...).
"^DD",2006.575,2006.575,30,21,3,0)
 
"^DD",2006.575,2006.575,30,21,4,0)
This value identifies the image that is the 'parent'
"^DD",2006.575,2006.575,30,21,5,0)
of the group to which the image that is described in
"^DD",2006.575,2006.575,30,21,6,0)
this entry belongs.
"^DD",2006.575,2006.575,30,"DT")
2980501
"^DD",2006.575,2006.575,31,0)
PARENT FILE^NJ10,0^^FIXPR;4^K:+X'=X!(X>9999999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.575,2006.575,31,.1)
Parent File
"^DD",2006.575,2006.575,31,3)
Identity the parent file.
"^DD",2006.575,2006.575,31,21,0)
^^23^23^3000306^^
"^DD",2006.575,2006.575,31,21,1,0)
The value of this field is a pointer to the File of
"^DD",2006.575,2006.575,31,21,2,0)
Files (#1, stored in ^DIC(...).
"^DD",2006.575,2006.575,31,21,3,0)
 
"^DD",2006.575,2006.575,31,21,4,0)
This value identifies the Imaging Parent file that
"^DD",2006.575,2006.575,31,21,5,0)
contains the clinical information of which the image
"^DD",2006.575,2006.575,31,21,6,0)
file that is described in this entry is a part.
"^DD",2006.575,2006.575,31,21,7,0)
 
"^DD",2006.575,2006.575,31,21,8,0)
Possible parent files are:
"^DD",2006.575,2006.575,31,21,9,0)
    3.9    MAIL MESSAGE
"^DD",2006.575,2006.575,31,21,10,0)
   63      AUTOPSY (MICROSCOPIC)
"^DD",2006.575,2006.575,31,21,11,0)
   63.02   ELECTRON MICROSCOPY
"^DD",2006.575,2006.575,31,21,12,0)
   63.08   SURGICAL PATHOLOGY
"^DD",2006.575,2006.575,31,21,13,0)
   63.09   CYTOLOGY
"^DD",2006.575,2006.575,31,21,14,0)
   63.2    AUTOPSY (GROSS)
"^DD",2006.575,2006.575,31,21,15,0)
   74      RADIOLOGY
"^DD",2006.575,2006.575,31,21,16,0)
  130      SURGERY
"^DD",2006.575,2006.575,31,21,17,0)
  691      ECHOCARDIOGRAM
"^DD",2006.575,2006.575,31,21,18,0)
  691.1    CARDIAC CATHETERIZATION
"^DD",2006.575,2006.575,31,21,19,0)
  691.5    ELECTROCARDIOGRAPHY
"^DD",2006.575,2006.575,31,21,20,0)
  694      HEMATOLOGY
"^DD",2006.575,2006.575,31,21,21,0)
  699      ENDOSCOPY
"^DD",2006.575,2006.575,31,21,22,0)
  699.5    GENERIC MEDICINE
"^DD",2006.575,2006.575,31,21,23,0)
 8925      TIU
"^DD",2006.575,2006.575,31,"DT")
2980501
"^DD",2006.575,2006.575,32,0)
SERVICE TYPE^F^^TYPE;1^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,32,.1)
Service Type
"^DD",2006.575,2006.575,32,3)
Enter the name of the imaging service.
"^DD",2006.575,2006.575,32,21,0)
^^9^9^3000306^^
"^DD",2006.575,2006.575,32,21,1,0)
The value of this field is a string that identifies
"^DD",2006.575,2006.575,32,21,2,0)
the 'imaging service' that is performed by the
"^DD",2006.575,2006.575,32,21,3,0)
instrument that is described in this entry.
"^DD",2006.575,2006.575,32,21,4,0)
 
"^DD",2006.575,2006.575,32,21,5,0)
The imaging services are itemized in file 2006.589
"^DD",2006.575,2006.575,32,21,6,0)
(stored in ^MAGDICOM(2006.589,...)
"^DD",2006.575,2006.575,32,21,7,0)
 
"^DD",2006.575,2006.575,32,21,8,0)
Currently, the only entries in this file are RAD
"^DD",2006.575,2006.575,32,21,9,0)
and MED-ENDO.
"^DD",2006.575,2006.575,32,"DT")
3041216
"^DD",2006.575,2006.575,33,0)
DELETE FLAG^S^1:FILE IS DELETED;^0;6^Q
"^DD",2006.575,2006.575,33,.1)
Delete Flag
"^DD",2006.575,2006.575,33,3)
Indicate whether or not this file is to be deleted.
"^DD",2006.575,2006.575,33,21,0)
^^12^12^3000306^^
"^DD",2006.575,2006.575,33,21,1,0)
The value of this field is a code that indicates
"^DD",2006.575,2006.575,33,21,2,0)
whether of not the image file that is described
"^DD",2006.575,2006.575,33,21,3,0)
in this entry is to be deleted.
"^DD",2006.575,2006.575,33,21,4,0)
 
"^DD",2006.575,2006.575,33,21,5,0)
Corrections are made using either of
"^DD",2006.575,2006.575,33,21,6,0)
the menu options
"^DD",2006.575,2006.575,33,21,7,0)
 MAGD FIX DICOM or
"^DD",2006.575,2006.575,33,21,8,0)
 MAGD FIX MEDICINE
"^DD",2006.575,2006.575,33,21,9,0)
 
"^DD",2006.575,2006.575,33,21,10,0)
If the images files are for a test patient, then
"^DD",2006.575,2006.575,33,21,11,0)
setting this field will not process the images but delete the files from
"^DD",2006.575,2006.575,33,21,12,0)
the DICOM Image gateway. 
"^DD",2006.575,2006.575,33,23,0)
^^2^2^3000216^^
"^DD",2006.575,2006.575,33,23,1,0)
If this field is present, the software on the DICOM Image gateway will
"^DD",2006.575,2006.575,33,23,2,0)
not process this image file but will delete it from the IMAGE_IN directory.
"^DD",2006.575,2006.575,33,"DT")
3000216
"^DD",2006.575,2006.575,34,0)
MANUFACTURER^F^^AMFG;7^K:$L(X)>20!($L(X)<1) X
"^DD",2006.575,2006.575,34,.1)
Manufacturer
"^DD",2006.575,2006.575,34,3)
Enter the name of the manufacturer of the modality
"^DD",2006.575,2006.575,34,21,0)
^^3^3^3000306^^
"^DD",2006.575,2006.575,34,21,1,0)
The value of this field is a string that identifies
"^DD",2006.575,2006.575,34,21,2,0)
the manufacturer of the instrument that transmitted
"^DD",2006.575,2006.575,34,21,3,0)
the images that require manual correction.
"^DD",2006.575,2006.575,34,"DT")
2991210
"^DD",2006.575,2006.575,35,0)
MODEL^F^^AMFG;8^K:$L(X)>10!($L(X)<1) X
"^DD",2006.575,2006.575,35,.1)
Model
"^DD",2006.575,2006.575,35,3)
Enter the name of the model of the modality.
"^DD",2006.575,2006.575,35,21,0)
^^3^3^3000306^^
"^DD",2006.575,2006.575,35,21,1,0)
The value of this field is a string that identifies
"^DD",2006.575,2006.575,35,21,2,0)
the model of the instrument that transmitted
"^DD",2006.575,2006.575,35,21,3,0)
the images that require manual correction.
"^DD",2006.575,2006.575,35,"DT")
2991210
"^DD",2006.575,2006.575,36,0)
GATEWAY LOCATION^P4'^DIC(4,^1;5^Q
"^DD",2006.575,2006.575,36,3)
Identify the institution where the gateway is located.
"^DD",2006.575,2006.575,36,21,0)
^.001^1^1^3041216^^^
"^DD",2006.575,2006.575,36,21,1,0)
This field will contain the institution where the gateway is located.
"^DD",2006.575,2006.575,36,"DT")
3041216
"^DD",2006.575,2006.575,37,0)
Instrument Site^F^^AMFG;9^K:$L(X)>30!($L(X)<1) X
"^DD",2006.575,2006.575,37,3)
Answer must be 1-30 characters in length.
"^DD",2006.575,2006.575,37,21,0)
^^1^1^3010319^
"^DD",2006.575,2006.575,37,21,1,0)
This field will contain the institution where the instrument is located.
"^DD",2006.575,2006.575,37,"DT")
3010319
"^DD",2006.575,2006.57526,0)
RELATED IMAGES SUB-FIELD^^.01^1
"^DD",2006.575,2006.57526,0,"DT")
2970226
"^DD",2006.575,2006.57526,0,"IX","B",2006.57526,.01)

"^DD",2006.575,2006.57526,0,"NM","RELATED IMAGES")

"^DD",2006.575,2006.57526,0,"UP")
2006.575
"^DD",2006.575,2006.57526,.01,0)
RELATED IMAGES^P2006.575'^MAGD(2006.575,^0;1^Q
"^DD",2006.575,2006.57526,.01,.1)
Related Image
"^DD",2006.575,2006.57526,.01,1,0)
^.1
"^DD",2006.575,2006.57526,.01,1,1,0)
2006.57526^B
"^DD",2006.575,2006.57526,.01,1,1,1)
S ^MAGD(2006.575,DA(1),"RLATE","B",$E(X,1,30),DA)=""
"^DD",2006.575,2006.57526,.01,1,1,2)
K ^MAGD(2006.575,DA(1),"RLATE","B",$E(X,1,30),DA)
"^DD",2006.575,2006.57526,.01,3)

"^DD",2006.575,2006.57526,.01,21,0)
^^7^7^3000306^^
"^DD",2006.575,2006.57526,.01,21,1,0)
The value of this field is a pointer to the Image
"^DD",2006.575,2006.57526,.01,21,2,0)
file (#2005, stored in ^MAG(2005,...).
"^DD",2006.575,2006.57526,.01,21,3,0)
 
"^DD",2006.575,2006.57526,.01,21,4,0)
The entries in this subfile constitute the list of
"^DD",2006.575,2006.57526,.01,21,5,0)
all images which have the same unique study UID.
"^DD",2006.575,2006.57526,.01,21,6,0)
The first entry made into this subfile will be the parent entry. The next images with
"^DD",2006.575,2006.57526,.01,21,7,0)
the same Study UID will be entered as additional entries in this subfile.
"^DD",2006.575,2006.57526,.01,"DT")
2970226
"^DD",2006.5762,2006.5762,0)
FIELD^^2^4
"^DD",2006.5762,2006.5762,0,"DDA")
N
"^DD",2006.5762,2006.5762,0,"DT")
3041108
"^DD",2006.5762,2006.5762,0,"NM","DICOM INSTRUMENT STATISTICS")

"^DD",2006.5762,2006.5762,0,"VRPK")
IMAGING
"^DD",2006.5762,2006.5762,.001,0)
NUMBER^NJ8,0^^ ^K:+X'=X!(X>99999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.5762,2006.5762,.001,3)
Enter a FileMan Date.
"^DD",2006.5762,2006.5762,.001,21,0)
^^3^3^3010227^^
"^DD",2006.5762,2006.5762,.001,21,1,0)
The value of this field is a date string (no time part) that
"^DD",2006.5762,2006.5762,.001,21,2,0)
identifies the day on which the statistics in the current
"^DD",2006.5762,2006.5762,.001,21,3,0)
entry were collected.
"^DD",2006.5762,2006.5762,.001,"DT")
3010227
"^DD",2006.5762,2006.5762,.01,0)
DATE^RDX^^0;1^S %DT="EX" D ^%DT S X=Y K:Y<1 X S:$D(X) DINUM=X
"^DD",2006.5762,2006.5762,.01,1,0)
^.1^^0
"^DD",2006.5762,2006.5762,.01,3)
Enter today's date (no time).
"^DD",2006.5762,2006.5762,.01,21,0)
^^3^3^3010223^^
"^DD",2006.5762,2006.5762,.01,21,1,0)
The value of this field is a date string (no time part) that
"^DD",2006.5762,2006.5762,.01,21,2,0)
identifies the day on which the statistics in the current
"^DD",2006.5762,2006.5762,.01,21,3,0)
entry were collected.
"^DD",2006.5762,2006.5762,.01,"DT")
3010223
"^DD",2006.5762,2006.5762,1,0)
LOCATION^2006.57621PA^^1;0
"^DD",2006.5762,2006.57621,0)
LOCATION SUB-FIELD^^5^6
"^DD",2006.5762,2006.57621,0,"DT")
3041108
"^DD",2006.5762,2006.57621,0,"IX","B",2006.57621,.01)

"^DD",2006.5762,2006.57621,0,"NM","LOCATION")

"^DD",2006.5762,2006.57621,0,"UP")
2006.5762
"^DD",2006.5762,2006.57621,.01,0)
LOCATION^RP4'^DIC(4,^0;1^Q
"^DD",2006.5762,2006.57621,.01,1,0)
^.1^^0
"^DD",2006.5762,2006.57621,.01,1,1,0)
2006.57621^B
"^DD",2006.5762,2006.57621,.01,1,1,1)
S ^MAGDAUDT(2006.5762,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",2006.5762,2006.57621,.01,1,1,2)
K ^MAGDAUDT(2006.5762,DA(1),1,"B",$E(X,1,30),DA)
"^DD",2006.5762,2006.57621,.01,3)
Enter the name of the division for this instrument.
"^DD",2006.5762,2006.57621,.01,21,0)
^^3^3^3041108^
"^DD",2006.5762,2006.57621,.01,21,1,0)
The value of this field is a pointer. This pointer identifies
"^DD",2006.5762,2006.57621,.01,21,2,0)
the location (division) in the Institution file (#4) with which
"^DD",2006.5762,2006.57621,.01,21,3,0)
the instrument is associated.
"^DD",2006.5762,2006.57621,.01,"DT")
3041108
"^DD",2006.5762,2006.57621,1,0)
INSTRUMENT^2006.576211A^^1;0
"^DD",2006.5762,2006.576211,0)
INSTRUMENT SUB-FIELD^^5^5
"^DD",2006.5762,2006.576211,0,"DT")
3010403
"^DD",2006.5762,2006.576211,0,"IX","B",2006.576211,.01)

"^DD",2006.5762,2006.576211,0,"NM","INSTRUMENT")

"^DD",2006.5762,2006.576211,0,"UP")
2006.57621
"^DD",2006.5762,2006.576211,.01,0)
INSTRUMENT^RF^^0;1^K:$L(X)>30!($L(X)<1) X
"^DD",2006.5762,2006.576211,.01,1,0)
^.1
"^DD",2006.5762,2006.576211,.01,1,1,0)
2006.576211^B
"^DD",2006.5762,2006.576211,.01,1,1,1)
S ^MAGDAUDT(2006.5762,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",2006.5762,2006.576211,.01,1,1,2)
K ^MAGDAUDT(2006.5762,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)
"^DD",2006.5762,2006.576211,.01,3)
Enter the name of the current instrument.
"^DD",2006.5762,2006.576211,.01,21,0)
^^2^2^3010403^^
"^DD",2006.5762,2006.576211,.01,21,1,0)
The value of this field is a string that identifies the instrument
"^DD",2006.5762,2006.576211,.01,21,2,0)
for which statistics are being tallied in the current entry.
"^DD",2006.5762,2006.576211,.01,"DT")
3010403
"^DD",2006.5762,2006.576211,2,0)
ACQUIRED^NJ10,0^^0;2^K:+X'=X!(X>9999999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.5762,2006.576211,2,3)
Enter the number of images acquired from this instrument.
"^DD",2006.5762,2006.576211,2,21,0)
^^4^4^3010403^^
"^DD",2006.5762,2006.576211,2,21,1,0)
The value of this field is an integer number that represents
"^DD",2006.5762,2006.576211,2,21,2,0)
the number of images that have been acquired from the instrument
"^DD",2006.5762,2006.576211,2,21,3,0)
that is described in the current record (on the date
"^DD",2006.5762,2006.576211,2,21,4,0)
for this record).
"^DD",2006.5762,2006.576211,2,"DT")
3010403
"^DD",2006.5762,2006.576211,3,0)
LAST ACQUISITION^D^^0;3^S %DT="ESTXR" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5762,2006.576211,3,3)
Enter the time of today's last image acquisition from this instrument.
"^DD",2006.5762,2006.576211,3,21,0)
^^4^4^3010403^^
"^DD",2006.5762,2006.576211,3,21,1,0)
The value of this field is a date/time string that represents
"^DD",2006.5762,2006.576211,3,21,2,0)
the time-stamp for the most recent acquisition of an image
"^DD",2006.5762,2006.576211,3,21,3,0)
for the instrument that is described in the current record
"^DD",2006.5762,2006.576211,3,21,4,0)
(on the date for this record).
"^DD",2006.5762,2006.576211,3,"DT")
3010403
"^DD",2006.5762,2006.576211,4,0)
PROCESSED^NJ10,0^^0;4^K:+X'=X!(X>9999999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",2006.5762,2006.576211,4,3)
Enter the number of images processed.
"^DD",2006.5762,2006.576211,4,21,0)
^^3^3^3010403^^
"^DD",2006.5762,2006.576211,4,21,1,0)
The value of this field is an integer number that represents
"^DD",2006.5762,2006.576211,4,21,2,0)
the number of images from the instrument that have been processed
"^DD",2006.5762,2006.576211,4,21,3,0)
on the date for this record.
"^DD",2006.5762,2006.576211,4,"DT")
3010403
"^DD",2006.5762,2006.576211,5,0)
LAST PROCESSING^D^^0;5^S %DT="ESTXR" D ^%DT S X=Y K:Y<1 X
"^DD",2006.5762,2006.576211,5,3)
Enter the date and time when the last image was processed for this instrument.
"^DD",2006.5762,2006.576211,5,21,0)
^^4^4^3010403^^
"^DD",2006.5762,2006.576211,5,21,1,0)
The value of this field is a date/time string that represents
"^DD",2006.5762,2006.576211,5,21,2,0)
the time-stamp for the most recent image processing of an
"^DD",2006.5762,2006.576211,5,21,3,0)
image from the instrument that is described in the current record
"^DD",2006.5762,2006.576211,5,21,4,0)
(on the date for this record).
"^DD",2006.5762,2006.576211,5,"DT")
3010403
"^DD",2006.582,2006.582,9,0)
ACTIVE^S^1:Active;0:Not Currently Used;^0;9^Q
"^DD",2006.582,2006.582,9,3)
Indicate whether this entry is active.
"^DD",2006.582,2006.582,9,21,0)
^^4^4^3041029^
"^DD",2006.582,2006.582,9,21,1,0)
The value of this field is a code that indicates whether
"^DD",2006.582,2006.582,9,21,2,0)
or not this entry is currently active. Possible values:
"^DD",2006.582,2006.582,9,21,3,0)
    1: active
"^DD",2006.582,2006.582,9,21,4,0)
    0: currently not in use
"^DD",2006.582,2006.582,9,"DT")
3041029
"^DD",2006.587,2006.587,0)
FIELD^^8^8
"^DD",2006.587,2006.587,0,"DT")
3030514
"^DD",2006.587,2006.587,0,"IX","B",2006.587,.01)

"^DD",2006.587,2006.587,0,"NM","DICOM TRANSMIT DESTINATION")

"^DD",2006.587,2006.587,0,"PT",2005.0111,3)

"^DD",2006.587,2006.587,0,"PT",2005.1111,3)

"^DD",2006.587,2006.587,0,"PT",2006.035,1)

"^DD",2006.587,2006.587,.01,0)
SERVICE NAME^RF^^0;1^K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X
"^DD",2006.587,2006.587,.01,1,0)
^.1
"^DD",2006.587,2006.587,.01,1,1,0)
2006.587^B
"^DD",2006.587,2006.587,.01,1,1,1)
S ^MAG(2006.587,"B",$E(X,1,30),DA)=""
"^DD",2006.587,2006.587,.01,1,1,2)
K ^MAG(2006.587,"B",$E(X,1,30),DA)
"^DD",2006.587,2006.587,.01,3)
Enter the name of the Service Class Provider.
"^DD",2006.587,2006.587,.01,21,0)
^^2^2^3030514^^
"^DD",2006.587,2006.587,.01,21,1,0)
The value of this field is a string that specifies the name of the
"^DD",2006.587,2006.587,.01,21,2,0)
service that is called for the application described in the current entry.
"^DD",2006.587,2006.587,.01,"DT")
3050609
"^DD",2006.587,2006.587,2,0)
SERVICE PROVIDER AE^F^^0;2^K:$L(X)>30!($L(X)<1) X
"^DD",2006.587,2006.587,2,3)
Enter the Application Entity Title of the Service Class Provider.
"^DD",2006.587,2006.587,2,21,0)
^^3^3^3030514^^
"^DD",2006.587,2006.587,2,21,1,0)
The value of this field is a string that specifies the Application
"^DD",2006.587,2006.587,2,21,2,0)
Entity Title for the equipment being called for the application that
"^DD",2006.587,2006.587,2,21,3,0)
is described in the current entry.
"^DD",2006.587,2006.587,2,"DT")
3030514
"^DD",2006.587,2006.587,3,0)
IP ADDRESS^F^^0;3^K:$L(X)>30!($L(X)<1) X
"^DD",2006.587,2006.587,3,3)
Enter the TCP/IP address of the Service Class Provider.
"^DD",2006.587,2006.587,3,21,0)
^^2^2^3030514^^
"^DD",2006.587,2006.587,3,21,1,0)
The value of this field is a string that specifies the TCP/IP address
"^DD",2006.587,2006.587,3,21,2,0)
of the called application entity.
"^DD",2006.587,2006.587,3,"DT")
3030514
"^DD",2006.587,2006.587,4,0)
PORT NUMBER^NJ5,0^^0;4^K:+X'=X!(X>65535)!(X<1)!(X?.E1"."1N.N) X
"^DD",2006.587,2006.587,4,3)
Enter the port number for the Service Class Provider.
"^DD",2006.587,2006.587,4,21,0)
^^3^3^3030514^^
"^DD",2006.587,2006.587,4,21,1,0)
The value of this field is an integer number that identifies the TCP/IP
"^DD",2006.587,2006.587,4,21,2,0)
port number to which the equipment connects calls the application that
"^DD",2006.587,2006.587,4,21,3,0)
is described in this entry. 
"^DD",2006.587,2006.587,4,"DT")
3030514
"^DD",2006.587,2006.587,5,0)
GATEWAY SYSTEM TITLE^F^^0;5^K:$L(X)>30!($L(X)<1) X
"^DD",2006.587,2006.587,5,3)
Enter the system title of the DICOM Gateway.
"^DD",2006.587,2006.587,5,21,0)
^^5^5^3030514^^
"^DD",2006.587,2006.587,5,21,1,0)
The value of this field is a text that identifies the computer that
"^DD",2006.587,2006.587,5,21,2,0)
communicates with this service class provider.
"^DD",2006.587,2006.587,5,21,3,0)
 
"^DD",2006.587,2006.587,5,21,4,0)
Note that each VistA DICOM Gateway computer has its own copy of ^MAGDICOM,
"^DD",2006.587,2006.587,5,21,5,0)
in which its station-parameters are stored.
"^DD",2006.587,2006.587,5,"DT")
3050609
"^DD",2006.587,2006.587,6,0)
GATEWAY AE^F^^0;6^K:$L(X)>30!($L(X)<1) X
"^DD",2006.587,2006.587,6,3)
Enter the Application Entity Title of the DICOM Gateway
"^DD",2006.587,2006.587,6,21,0)
^^3^3^3030514^^
"^DD",2006.587,2006.587,6,21,1,0)
The value of this field is a string that specifies the Application
"^DD",2006.587,2006.587,6,21,2,0)
Entity Title for the VistA DICOM Gatewat from which the application is called
"^DD",2006.587,2006.587,6,21,3,0)
that is described in the current entry.
"^DD",2006.587,2006.587,6,"DT")
3030514
"^DD",2006.587,2006.587,7,0)
GATEWAY LOCATION^RP4'^DIC(4,^0;7^Q
"^DD",2006.587,2006.587,7,3)
Identify the clinic where the DICOM Gateway is located.
"^DD",2006.587,2006.587,7,21,0)
^^2^2^3030514^^
"^DD",2006.587,2006.587,7,21,1,0)
The value of this field is a pointer to the Institution file (#4).
"^DD",2006.587,2006.587,7,21,2,0)
This value identifies the institution where this DICOM Gateway computer resides.
"^DD",2006.587,2006.587,7,"DT")
3050609
"^DD",2006.587,2006.587,8,0)
TIMESTAMP^RD^^0;8^S %DT="ESTXR" D ^%DT S X=Y K:Y<1 X
"^DD",2006.587,2006.587,8,3)
Enter the date and time of this update.
"^DD",2006.587,2006.587,8,"DT")
3030514
"^DIC",2006.51,2006.51,0)
DICOM DATA ELEMENT DICTIONARY^2006.51
"^DIC",2006.51,2006.51,0,"GL")
^MAGDICOM(2006.51,
"^DIC",2006.51,2006.51,"%",0)
^1.005^^0
"^DIC",2006.51,2006.51,"%D",0)
^^24^24^3010619^
"^DIC",2006.51,2006.51,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.51,2006.51,"%D",2,0)
 |                                                               |
"^DIC",2006.51,2006.51,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.51,2006.51,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.51,2006.51,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.51,2006.51,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.51,2006.51,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.51,2006.51,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.51,2006.51,"%D",9,0)
 |                                                               |
"^DIC",2006.51,2006.51,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.51,2006.51,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.51,2006.51,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.51,2006.51,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.51,2006.51,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.51,2006.51,"%D",15,0)
 |                                                               |
"^DIC",2006.51,2006.51,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.51,2006.51,"%D",17,0)
 
"^DIC",2006.51,2006.51,"%D",18,0)
This table contains the DICOM Element Dictionary.
"^DIC",2006.51,2006.51,"%D",19,0)
Every element that is part of the 1999 DICOM Standard is stored
"^DIC",2006.51,2006.51,"%D",20,0)
in this table.
"^DIC",2006.51,2006.51,"%D",21,0)
Elements that may only have a restricted number of values are marked,
"^DIC",2006.51,2006.51,"%D",22,0)
and the list of allowed values is itemized in this table.
"^DIC",2006.51,2006.51,"%D",23,0)
Elements that are marked as "Obsolete" in the DICOM standard are
"^DIC",2006.51,2006.51,"%D",24,0)
present in this table, and also marked as "Obsolete".
"^DIC",2006.51,"B","DICOM DATA ELEMENT DICTIONARY",2006.51)

"^DIC",2006.532,2006.532,0)
DICOM SOP CLASS^2006.532
"^DIC",2006.532,2006.532,0,"GL")
^MAG(2006.532,
"^DIC",2006.532,2006.532,"%D",0)
^^23^23^3050111^^
"^DIC",2006.532,2006.532,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.532,2006.532,"%D",2,0)
 |                                                               |
"^DIC",2006.532,2006.532,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.532,2006.532,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.532,2006.532,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.532,2006.532,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.532,2006.532,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.532,2006.532,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.532,2006.532,"%D",9,0)
 |                                                               |
"^DIC",2006.532,2006.532,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.532,2006.532,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.532,2006.532,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.532,2006.532,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.532,2006.532,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.532,2006.532,"%D",15,0)
 |                                                               |
"^DIC",2006.532,2006.532,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.532,2006.532,"%D",17,0)
 
"^DIC",2006.532,2006.532,"%D",18,0)
This file will contain a list of unique identifiers for
"^DIC",2006.532,2006.532,"%D",19,0)
DICOM SOP Classes.
"^DIC",2006.532,2006.532,"%D",20,0)
 
"^DIC",2006.532,2006.532,"%D",21,0)
Each of these UIDs (Unique IDentifiers) corresponds to a
"^DIC",2006.532,2006.532,"%D",22,0)
DICOM Service Class that is used for the acquisition of
"^DIC",2006.532,2006.532,"%D",23,0)
images.
"^DIC",2006.532,"B","DICOM SOP CLASS",2006.532)

"^DIC",2006.5641,2006.5641,0)
DICOM GATEWAY MACHINE ID^2006.5641
"^DIC",2006.5641,2006.5641,0,"GL")
^MAGDICOM(2006.5641,
"^DIC",2006.5641,2006.5641,"%D",0)
^^21^21^3041210^^
"^DIC",2006.5641,2006.5641,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.5641,2006.5641,"%D",2,0)
 |                                                               |
"^DIC",2006.5641,2006.5641,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.5641,2006.5641,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.5641,2006.5641,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.5641,2006.5641,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.5641,2006.5641,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.5641,2006.5641,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.5641,2006.5641,"%D",9,0)
 |                                                               |
"^DIC",2006.5641,2006.5641,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.5641,2006.5641,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.5641,2006.5641,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.5641,2006.5641,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.5641,2006.5641,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.5641,2006.5641,"%D",15,0)
 |                                                               |
"^DIC",2006.5641,2006.5641,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.5641,2006.5641,"%D",17,0)
 
"^DIC",2006.5641,2006.5641,"%D",18,0)
This table is used to keep track of the various Machine IDs on
"^DIC",2006.5641,2006.5641,"%D",19,0)
the DICOM Gateways. Since each ID has to be a unique one, the
"^DIC",2006.5641,2006.5641,"%D",20,0)
software that maintains this table uses the data in this table
"^DIC",2006.5641,2006.5641,"%D",21,0)
to ensure that the same ID is not issued multiple times.
"^DIC",2006.5641,"B","DICOM GATEWAY MACHINE ID",2006.5641)

"^DIC",2006.5715,2006.5715,0)
CURRENT IMAGE^2006.5715
"^DIC",2006.5715,2006.5715,0,"GL")
^MAGD(2006.5715,
"^DIC",2006.5715,2006.5715,"%D",0)
^^27^27^3050225^
"^DIC",2006.5715,2006.5715,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.5715,2006.5715,"%D",2,0)
 |                                                               |
"^DIC",2006.5715,2006.5715,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.5715,2006.5715,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.5715,2006.5715,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.5715,2006.5715,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.5715,2006.5715,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.5715,2006.5715,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.5715,2006.5715,"%D",9,0)
 |                                                               |
"^DIC",2006.5715,2006.5715,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.5715,2006.5715,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.5715,2006.5715,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.5715,2006.5715,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.5715,2006.5715,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.5715,2006.5715,"%D",15,0)
 |                                                               |
"^DIC",2006.5715,2006.5715,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.5715,2006.5715,"%D",17,0)
 
"^DIC",2006.5715,2006.5715,"%D",18)
This table contains the list of DICOM Image Gateways
"^DIC",2006.5715,2006.5715,"%D",18,0)
This table contains the DICOM Element Dictionary.
"^DIC",2006.5715,2006.5715,"%D",19)
and for each Image Gateway an identification of the image
"^DIC",2006.5715,2006.5715,"%D",19,0)
Every element that is part of the 1999 DICOM Standard is stored
"^DIC",2006.5715,2006.5715,"%D",20)
that is currently being processed (DICOM UID).
"^DIC",2006.5715,2006.5715,"%D",20,0)
in this table.
"^DIC",2006.5715,2006.5715,"%D",21)
 
"^DIC",2006.5715,2006.5715,"%D",21,0)
Elements that may only have a restricted number of values are marked,
"^DIC",2006.5715,2006.5715,"%D",22)
The purpose of this table is to allow for the situation that processing
"^DIC",2006.5715,2006.5715,"%D",22,0)
and the list of allowed values is itemized in this table.
"^DIC",2006.5715,2006.5715,"%D",23)
of an image is interrupted, and needs to resume once a DICOM Gateway is
"^DIC",2006.5715,2006.5715,"%D",23,0)
Elements that are marked as "Obsolete" in the DICOM standard are
"^DIC",2006.5715,2006.5715,"%D",24)
started. In this case (and only in this case) it is allowed to acquire
"^DIC",2006.5715,2006.5715,"%D",24,0)
present in this table, and also marked as "Obsolete".
"^DIC",2006.5715,2006.5715,"%D",25,0)
an image with a UID that is already in the database (but only if the
"^DIC",2006.5715,2006.5715,"%D",26,0)
UID of the new image is equal to the UID of the image that was being
"^DIC",2006.5715,2006.5715,"%D",27,0)
processed when the DICOM Image Gateway was interrupted.
"^DIC",2006.5715,"B","CURRENT IMAGE",2006.5715)

"^DIC",2006.57,2006.57,0)
DICOM HL7 SEGMENT^2006.57
"^DIC",2006.57,2006.57,0,"GL")
^MAGDICOM(2006.57,
"^DIC",2006.57,2006.57,"%",0)
^1.005^^0
"^DIC",2006.57,2006.57,"%D",0)
^^21^21^3010619^
"^DIC",2006.57,2006.57,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.57,2006.57,"%D",2,0)
 |                                                               |
"^DIC",2006.57,2006.57,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.57,2006.57,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.57,2006.57,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.57,2006.57,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.57,2006.57,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.57,2006.57,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.57,2006.57,"%D",9,0)
 |                                                               |
"^DIC",2006.57,2006.57,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.57,2006.57,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.57,2006.57,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.57,2006.57,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.57,2006.57,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.57,2006.57,"%D",15,0)
 |                                                               |
"^DIC",2006.57,2006.57,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.57,2006.57,"%D",17,0)
 
"^DIC",2006.57,2006.57,"%D",18,0)
The entries in this table describe the various HL7 segments that are
"^DIC",2006.57,2006.57,"%D",19,0)
being processed in the context of the DICOM-related activities.
"^DIC",2006.57,2006.57,"%D",20,0)
Currently, only HL7 messages that are germane to the building and purging
"^DIC",2006.57,2006.57,"%D",21,0)
of DICOM Modality Worklists, are being processed.
"^DIC",2006.5732,2006.5732,0)
DICOM QUERY RETRIEVE RESULT^2006.5732
"^DIC",2006.5732,2006.5732,0,"GL")
^MAGDQR(2006.5732,
"^DIC",2006.5732,2006.5732,"%D",0)
^^33^33^3041201^^
"^DIC",2006.5732,2006.5732,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.5732,2006.5732,"%D",2,0)
 |                                                               |
"^DIC",2006.5732,2006.5732,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.5732,2006.5732,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.5732,2006.5732,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.5732,2006.5732,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.5732,2006.5732,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.5732,2006.5732,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.5732,2006.5732,"%D",9,0)
 |                                                               |
"^DIC",2006.5732,2006.5732,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.5732,2006.5732,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.5732,2006.5732,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.5732,2006.5732,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.5732,2006.5732,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.5732,2006.5732,"%D",15,0)
 |                                                               |
"^DIC",2006.5732,2006.5732,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.5732,2006.5732,"%D",17,0)
 
"^DIC",2006.5732,2006.5732,"%D",18,0)
The entries in this table are the result-sets that are created
"^DIC",2006.5732,2006.5732,"%D",19,0)
in response to DICOM Query/Retrieve requests that may be processed
"^DIC",2006.5732,2006.5732,"%D",20,0)
through Remote Procedure Calls.
"^DIC",2006.5732,2006.5732,"%D",21,0)
 
"^DIC",2006.5732,2006.5732,"%D",22,0)
Each entry in this table is one such result-set.
"^DIC",2006.5732,2006.5732,"%D",23,0)
 
"^DIC",2006.5732,2006.5732,"%D",24,0)
Result-sets are kept in this table, so that client-stations can
"^DIC",2006.5732,2006.5732,"%D",25,0)
call Remote Procedures to obtain the content of a result-set in
"^DIC",2006.5732,2006.5732,"%D",26,0)
portions of a limited size.
"^DIC",2006.5732,2006.5732,"%D",27,0)
 
"^DIC",2006.5732,2006.5732,"%D",28,0)
Also, since the creation of a result-set may need more time than
"^DIC",2006.5732,2006.5732,"%D",29,0)
is reasonable wait for in a single Remote Procedure Call, the
"^DIC",2006.5732,2006.5732,"%D",30,0)
existence of this table makes it possible to call a first
"^DIC",2006.5732,2006.5732,"%D",31,0)
Remote Procedure to create the result-set through a TaskMan process
"^DIC",2006.5732,2006.5732,"%D",32,0)
and then call subsequent Remote Procedures to inquire whether
"^DIC",2006.5732,2006.5732,"%D",33,0)
the result-set is complete, and subsequently to obtain the results.
"^DIC",2006.5732,"B","DICOM QUERY RETRIEVE RESULT",2006.5732)

"^DIC",2006.574,2006.574,0)
DICOM IMAGE OUTPUT^2006.574
"^DIC",2006.574,2006.574,0,"GL")
^MAGDOUTP(2006.574,
"^DIC",2006.574,2006.574,"%",0)
^1.005^^0
"^DIC",2006.574,2006.574,"%D",0)
^^21^21^3010619^
"^DIC",2006.574,2006.574,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.574,2006.574,"%D",2,0)
 |                                                               |
"^DIC",2006.574,2006.574,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.574,2006.574,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.574,2006.574,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.574,2006.574,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.574,2006.574,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.574,2006.574,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.574,2006.574,"%D",9,0)
 |                                                               |
"^DIC",2006.574,2006.574,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.574,2006.574,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.574,2006.574,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.574,2006.574,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.574,2006.574,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.574,2006.574,"%D",15,0)
 |                                                               |
"^DIC",2006.574,2006.574,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.574,2006.574,"%D",17,0)
 
"^DIC",2006.574,2006.574,"%D",18,0)
The entries in this table describe requests to transmit image files
"^DIC",2006.574,2006.574,"%D",19,0)
to an alternate storage provider.
"^DIC",2006.574,2006.574,"%D",20,0)
The top-level of this table identifies the storage provider, the next
"^DIC",2006.574,2006.574,"%D",21,0)
level identifies the images for which files are to be transmitted.
"^DIC",2006.574,"B","DICOM IMAGE OUTPUT",2006.574)

"^DIC",2006.575,2006.575,0)
DICOM FAILED IMAGES^2006.575
"^DIC",2006.575,2006.575,0,"GL")
^MAGD(2006.575,
"^DIC",2006.575,2006.575,"%",0)
^1.005^^0
"^DIC",2006.575,2006.575,"%D",0)
^^32^32^3010619^
"^DIC",2006.575,2006.575,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.575,2006.575,"%D",2,0)
 |                                                               |
"^DIC",2006.575,2006.575,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.575,2006.575,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.575,2006.575,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.575,2006.575,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.575,2006.575,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.575,2006.575,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.575,2006.575,"%D",9,0)
 |                                                               |
"^DIC",2006.575,2006.575,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.575,2006.575,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.575,2006.575,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.575,2006.575,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.575,2006.575,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.575,2006.575,"%D",15,0)
 |                                                               |
"^DIC",2006.575,2006.575,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.575,2006.575,"%D",17,0)
 
"^DIC",2006.575,2006.575,"%D",18,0)
The entries in this table describe image files that were received by the
"^DIC",2006.575,2006.575,"%D",19,0)
DICOM Image Gateway, and could not be matched with a patient and an
"^DIC",2006.575,2006.575,"%D",20,0)
ordered study.
"^DIC",2006.575,2006.575,"%D",21,0)
 
"^DIC",2006.575,2006.575,"%D",22,0)
The MAGD FIX DICOM FILE and MAGD FIX MEDICINE DICOM FILE menu options are
"^DIC",2006.575,2006.575,"%D",23,0)
used to update the entries in this file.  The DICOM Image Gateway will
"^DIC",2006.575,2006.575,"%D",24,0)
poll this file for corrected entries. The cross reference used to poll
"^DIC",2006.575,2006.575,"%D",25,0)
this information is ^MAGD(2006.575,"AFX".
"^DIC",2006.575,2006.575,"%D",26,0)
 
"^DIC",2006.575,2006.575,"%D",27,0)
The routine L^MAGDLB1 is used by the above menu options and will loop thru
"^DIC",2006.575,2006.575,"%D",28,0)
the following cross reference ^MAGD(2006.575,"F".  This cross reference is
"^DIC",2006.575,2006.575,"%D",29,0)
set by the DICOM Study Instance UID; this is a unique number assigned by
"^DIC",2006.575,2006.575,"%D",30,0)
modalities (imaging equipment) and is unique by case study.  So it is
"^DIC",2006.575,2006.575,"%D",31,0)
possible to have over 20 entries in the file and only one unique "F" cross
"^DIC",2006.575,2006.575,"%D",32,0)
reference. 
"^DIC",2006.575,"B","DICOM FAILED IMAGES",2006.575)

"^DIC",2006.5762,2006.5762,0)
DICOM INSTRUMENT STATISTICS^2006.5762
"^DIC",2006.5762,2006.5762,0,"GL")
^MAGDAUDT(2006.5762,
"^DIC",2006.5762,2006.5762,"%",0)
^1.005^^0
"^DIC",2006.5762,2006.5762,"%D",0)
^^25^25^3010619^
"^DIC",2006.5762,2006.5762,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.5762,2006.5762,"%D",2,0)
 |                                                               |
"^DIC",2006.5762,2006.5762,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.5762,2006.5762,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.5762,2006.5762,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.5762,2006.5762,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.5762,2006.5762,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.5762,2006.5762,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.5762,2006.5762,"%D",9,0)
 |                                                               |
"^DIC",2006.5762,2006.5762,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.5762,2006.5762,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.5762,2006.5762,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.5762,2006.5762,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.5762,2006.5762,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.5762,2006.5762,"%D",15,0)
 |                                                               |
"^DIC",2006.5762,2006.5762,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.5762,2006.5762,"%D",17,0)
 
"^DIC",2006.5762,2006.5762,"%D",18,0)
 
"^DIC",2006.5762,2006.5762,"%D",19,0)
As images are being processed by VistA DICOM Image ext Gateways,
"^DIC",2006.5762,2006.5762,"%D",20,0)
statistics are being logged about the number and nature of these
"^DIC",2006.5762,2006.5762,"%D",21,0)
images.
"^DIC",2006.5762,2006.5762,"%D",22,0)
 
"^DIC",2006.5762,2006.5762,"%D",23,0)
The entries in this file keep track of how many images were
"^DIC",2006.5762,2006.5762,"%D",24,0)
acquired per day from the various instruments that produce images,
"^DIC",2006.5762,2006.5762,"%D",25,0)
and how many of these images were processed.
"^DIC",2006.5762,"B","DICOM INSTRUMENT STATISTICS",2006.5762)

"^DIC",2006.57,"B","DICOM HL7 SEGMENT",2006.57)

"^DIC",2006.587,2006.587,0)
DICOM TRANSMIT DESTINATION^2006.587
"^DIC",2006.587,2006.587,0,"GL")
^MAG(2006.587,
"^DIC",2006.587,2006.587,"%D",0)
^^33^33^3030804^^
"^DIC",2006.587,2006.587,"%D",1,0)
 +---------------------------------------------------------------+
"^DIC",2006.587,2006.587,"%D",2,0)
 |                                                               |
"^DIC",2006.587,2006.587,"%D",3,0)
 | Property of the US Government.                                |
"^DIC",2006.587,2006.587,"%D",4,0)
 | No permission to copy or redistribute this software is given. |
"^DIC",2006.587,2006.587,"%D",5,0)
 | Use of unreleased versions of this software requires the user |
"^DIC",2006.587,2006.587,"%D",6,0)
 | to execute a written test agreement with the VistA Imaging    |
"^DIC",2006.587,2006.587,"%D",7,0)
 | Development Office of the Department of Veterans Affairs,     |
"^DIC",2006.587,2006.587,"%D",8,0)
 | telephone (301) 734-0100.                                     |
"^DIC",2006.587,2006.587,"%D",9,0)
 |                                                               |
"^DIC",2006.587,2006.587,"%D",10,0)
 | The Food and Drug Administration classifies this software as  |
"^DIC",2006.587,2006.587,"%D",11,0)
 | a medical device.  As such, it may not be changed in any way. |
"^DIC",2006.587,2006.587,"%D",12,0)
 | Modifications to this software may result in an adulterated   |
"^DIC",2006.587,2006.587,"%D",13,0)
 | medical device under 21CFR820, the use of which is considered |
"^DIC",2006.587,2006.587,"%D",14,0)
 | to be a violation of US Federal Statutes.                     |
"^DIC",2006.587,2006.587,"%D",15,0)
 |                                                               |
"^DIC",2006.587,2006.587,"%D",16,0)
 +---------------------------------------------------------------+
"^DIC",2006.587,2006.587,"%D",17,0)
 
"^DIC",2006.587,2006.587,"%D",18,0)
The routing software is able to transmit image files from the
"^DIC",2006.587,2006.587,"%D",19,0)
VistA system where the images are stored permanently to various
"^DIC",2006.587,2006.587,"%D",20,0)
destinations that may receive temporary copies of images.
"^DIC",2006.587,2006.587,"%D",21,0)
Files can be transmitted to these destinations using several
"^DIC",2006.587,2006.587,"%D",22,0)
protocols. Valid destinations for files that are transmitted
"^DIC",2006.587,2006.587,"%D",23,0)
using the MS-DOS copy protocol are stored in the Network Location
"^DIC",2006.587,2006.587,"%D",24,0)
table (FileMan file #2005.2).
"^DIC",2006.587,2006.587,"%D",25,0)
Valid destinations for files that are transmitted using the
"^DIC",2006.587,2006.587,"%D",26,0)
DICOM C-Store protocol are stored in this file.
"^DIC",2006.587,2006.587,"%D",27,0)
 
"^DIC",2006.587,2006.587,"%D",28,0)
For each destination, this table contains the identifying information
"^DIC",2006.587,2006.587,"%D",29,0)
for the destinations, as well as the identifying information for
"^DIC",2006.587,2006.587,"%D",30,0)
the DICOM Gateways that are allowed to transmit images to these
"^DIC",2006.587,2006.587,"%D",31,0)
destinations. If multiple DICOM Gateways are allowed to transmit
"^DIC",2006.587,2006.587,"%D",32,0)
images to a specific destination, this table will contain multiple
"^DIC",2006.587,2006.587,"%D",33,0)
entries for that destination, one for each source and destination pair.
"^DIC",2006.587,"B","DICOM TRANSMIT DESTINATION",2006.587)

**END**
**END**


****
****

KIDS Distribution saved on Sep 16, 2004@16:13:07
VistA Imaging V3.0 - Patch 30  09/16/2004 16:13PM
**KIDS**:MAG*3.0*30^

**INSTALL NAME**
MAG*3.0*30
"BLD",3463,0)
MAG*3.0*30^IMAGING^0^3040916^y
"BLD",3463,1,0)
^^56^56^3040916^
"BLD",3463,1,1,0)
Version 3.0 Patch 30 - DICOM Gateway Maintenance II
"BLD",3463,1,2,0)
 
"BLD",3463,1,3,0)
 
"BLD",3463,1,4,0)
This build contains security key MAGDFIX ALL
"BLD",3463,1,5,0)
 for Imaging V3.0 Patch 11.
"BLD",3463,1,6,0)
 
"BLD",3463,1,7,0)
VistA Imaging Version 3.0 Patch 11 Security Key MAGJ DEMAND ROUTE DICOM
"BLD",3463,1,8,0)
 
"BLD",3463,1,9,0)
RPC definition for "MAG DICOM GET RAD RPT INFO".
"BLD",3463,1,10,0)
 
"BLD",3463,1,11,0)
RPC definition for "MAG DICOM ROUTE EVAL LOG".
"BLD",3463,1,12,0)
 
"BLD",3463,1,13,0)
RPC definition for "MAG DICOM ROUTE EVAL START".
"BLD",3463,1,14,0)
 
"BLD",3463,1,15,0)
This KIDS package adds two fields to file #2006.1 (Imaging Site
"BLD",3463,1,16,0)
Parameters):
"BLD",3463,1,17,0)
 #126: LAST ROUTING ACTIVITY
"BLD",3463,1,18,0)
 #120: LAST ROUTING CHECK
"BLD",3463,1,19,0)
 
"BLD",3463,1,20,0)
Correct the single field #36: GATEWAY LOCATION
"BLD",3463,1,21,0)
that was shipped incorrectly in patch 11.
"BLD",3463,1,22,0)
 
"BLD",3463,1,23,0)
Routines:
"BLD",3463,1,24,0)
MAG7RS      value = 12193599
"BLD",3463,1,25,0)
MAGBRTE4    value = 15019760
"BLD",3463,1,26,0)
MAGBRTE5    value = 12363938
"BLD",3463,1,27,0)
MAGBRTLD    value = 5665322
"BLD",3463,1,28,0)
MAGBRTUT    value = 6805146
"BLD",3463,1,29,0)
MAGDCCS2    value = 6363543
"BLD",3463,1,30,0)
MAGDHL7     value = 7399823
"BLD",3463,1,31,0)
MAGDHRS1    value = 5025884
"BLD",3463,1,32,0)
MAGDIR81    value = 14282136
"BLD",3463,1,33,0)
MAGDIR82    value = 13464369
"BLD",3463,1,34,0)
MAGDIR83    value = 7606355
"BLD",3463,1,35,0)
MAGDIR85    value = 2914037
"BLD",3463,1,36,0)
MAGDIR9A    value = 10789655
"BLD",3463,1,37,0)
MAGDIRVE    value = 15732775
"BLD",3463,1,38,0)
MAGDLB1     value = 11911075
"BLD",3463,1,39,0)
MAGDRA1     value = 7842219
"BLD",3463,1,40,0)
MAGDRCU1    value = 8485773
"BLD",3463,1,41,0)
MAGDRPC1    value = 8395133
"BLD",3463,1,42,0)
MAGDRPC2    value = 12950501
"BLD",3463,1,43,0)
MAGDRPC3    value = 11631756
"BLD",3463,1,44,0)
MAGDRPC4    value = 15201662
"BLD",3463,1,45,0)
MAGDRPC5    value = 14221287
"BLD",3463,1,46,0)
MAGDRPC6    value = 11175169
"BLD",3463,1,47,0)
MAGDRPC8    value = 10596480
"BLD",3463,1,48,0)
MAGIPS30    value = 4783130
"BLD",3463,1,49,0)
MAGQE1      value = 4871610
"BLD",3463,1,50,0)
MAGQE3      value = 15528150
"BLD",3463,1,51,0)
MAGQE4      value = 5670112
"BLD",3463,1,52,0)
MAGQE5      value = 10174225
"BLD",3463,1,53,0)
MAGQST      value = 4967326
"BLD",3463,1,54,0)
 
"BLD",3463,1,55,0)
Please note that routine MAGIPS30 is deleted after the KIDS Build is
"BLD",3463,1,56,0)
installed.
"BLD",3463,4,0)
^9.64PA^2006.575^2
"BLD",3463,4,2006.1,0)
2006.1
"BLD",3463,4,2006.1,2,0)
^9.641^2006.1^1
"BLD",3463,4,2006.1,2,2006.1,0)
IMAGING SITE PARAMETERS  (File-top level)
"BLD",3463,4,2006.1,2,2006.1,1,0)
^9.6411^127^2
"BLD",3463,4,2006.1,2,2006.1,1,126,0)
LAST ROUTING ACTIVITY
"BLD",3463,4,2006.1,2,2006.1,1,127,0)
LAST ROUTING CHECK
"BLD",3463,4,2006.1,222)
y^y^p^^^^n
"BLD",3463,4,2006.575,0)
2006.575
"BLD",3463,4,2006.575,2,0)
^9.641^2006.575^1
"BLD",3463,4,2006.575,2,2006.575,0)
DICOM FAILED IMAGES  (File-top level)
"BLD",3463,4,2006.575,2,2006.575,1,0)
^9.6411^36^1
"BLD",3463,4,2006.575,2,2006.575,1,36,0)
GATEWAY PLACE
"BLD",3463,4,2006.575,222)
y^y^p^^^^n
"BLD",3463,4,"B",2006.1,2006.1)

"BLD",3463,4,"B",2006.575,2006.575)

"BLD",3463,"ABNS",0)
^9.66A^^
"BLD",3463,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@DOMAIN.EXT
"BLD",3463,"INI")
PRE^MAGIPS30
"BLD",3463,"INID")
n^y^n
"BLD",3463,"INIT")
POST^MAGIPS30
"BLD",3463,"KRN",0)
^9.67PA^8994^19
"BLD",3463,"KRN",.4,0)
.4
"BLD",3463,"KRN",.401,0)
.401
"BLD",3463,"KRN",.402,0)
.402
"BLD",3463,"KRN",.403,0)
.403
"BLD",3463,"KRN",.5,0)
.5
"BLD",3463,"KRN",.84,0)
.84
"BLD",3463,"KRN",3.6,0)
3.6
"BLD",3463,"KRN",3.8,0)
3.8
"BLD",3463,"KRN",9.2,0)
9.2
"BLD",3463,"KRN",9.8,0)
9.8
"BLD",3463,"KRN",9.8,"NM",0)
^9.68A^29^29
"BLD",3463,"KRN",9.8,"NM",1,0)
MAG7RS^^0^B54368283
"BLD",3463,"KRN",9.8,"NM",2,0)
MAGBRTE4^^0^B79381896
"BLD",3463,"KRN",9.8,"NM",3,0)
MAGBRTE5^^0^B56261952
"BLD",3463,"KRN",9.8,"NM",4,0)
MAGBRTLD^^0^B10941757
"BLD",3463,"KRN",9.8,"NM",5,0)
MAGBRTUT^^0^B19180259
"BLD",3463,"KRN",9.8,"NM",6,0)
MAGDCCS2^^0^B15096146
"BLD",3463,"KRN",9.8,"NM",7,0)
MAGDHL7^^0^B24648346
"BLD",3463,"KRN",9.8,"NM",8,0)
MAGDHRS1^^0^B9937319
"BLD",3463,"KRN",9.8,"NM",9,0)
MAGDIR81^^0^B59204036
"BLD",3463,"KRN",9.8,"NM",10,0)
MAGDIR82^^0^B60062731
"BLD",3463,"KRN",9.8,"NM",11,0)
MAGDIR83^^0^B22465931
"BLD",3463,"KRN",9.8,"NM",12,0)
MAGDIR85^^0^B4149874
"BLD",3463,"KRN",9.8,"NM",13,0)
MAGDIR9A^^0^B43886625
"BLD",3463,"KRN",9.8,"NM",14,0)
MAGDIRVE^^0^B66702010
"BLD",3463,"KRN",9.8,"NM",15,0)
MAGDLB1^^0^B50516394
"BLD",3463,"KRN",9.8,"NM",16,0)
MAGDRA1^^0^B21186342
"BLD",3463,"KRN",9.8,"NM",17,0)
MAGDRCU1^^0^B29209213
"BLD",3463,"KRN",9.8,"NM",18,0)
MAGDRPC1^^0^B35396762
"BLD",3463,"KRN",9.8,"NM",19,0)
MAGDRPC2^^0^B62553446
"BLD",3463,"KRN",9.8,"NM",20,0)
MAGDRPC3^^0^B43162021
"BLD",3463,"KRN",9.8,"NM",21,0)
MAGDRPC4^^0^B67528572
"BLD",3463,"KRN",9.8,"NM",22,0)
MAGDRPC5^^0^B73787531
"BLD",3463,"KRN",9.8,"NM",23,0)
MAGDRPC6^^0^B36584708
"BLD",3463,"KRN",9.8,"NM",24,0)
MAGDRPC8^^0^B49397368
"BLD",3463,"KRN",9.8,"NM",25,0)
MAGQE1^^0^B11477872
"BLD",3463,"KRN",9.8,"NM",26,0)
MAGQE3^^0^B75455460
"BLD",3463,"KRN",9.8,"NM",27,0)
MAGQE4^^0^B12918669
"BLD",3463,"KRN",9.8,"NM",28,0)
MAGQE5^^0^B37769146
"BLD",3463,"KRN",9.8,"NM",29,0)
MAGQST^^0^B13256864
"BLD",3463,"KRN",9.8,"NM","B","MAG7RS",1)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTE4",2)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTE5",3)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTLD",4)

"BLD",3463,"KRN",9.8,"NM","B","MAGBRTUT",5)

"BLD",3463,"KRN",9.8,"NM","B","MAGDCCS2",6)

"BLD",3463,"KRN",9.8,"NM","B","MAGDHL7",7)

"BLD",3463,"KRN",9.8,"NM","B","MAGDHRS1",8)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR81",9)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR82",10)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR83",11)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR85",12)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR9A",13)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIRVE",14)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLB1",15)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRA1",16)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRCU1",17)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC1",18)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC2",19)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC3",20)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC4",21)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC5",22)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC6",23)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC8",24)

"BLD",3463,"KRN",9.8,"NM","B","MAGQE1",25)

"BLD",3463,"KRN",9.8,"NM","B","MAGQE3",26)

"BLD",3463,"KRN",9.8,"NM","B","MAGQE4",27)

"BLD",3463,"KRN",9.8,"NM","B","MAGQE5",28)

"BLD",3463,"KRN",9.8,"NM","B","MAGQST",29)

"BLD",3463,"KRN",19,0)
19
"BLD",3463,"KRN",19,"NM",0)
^9.68A^^
"BLD",3463,"KRN",19.1,0)
19.1
"BLD",3463,"KRN",19.1,"NM",0)
^9.68A^2^2
"BLD",3463,"KRN",19.1,"NM",1,0)
MAGDFIX ALL^^0
"BLD",3463,"KRN",19.1,"NM",2,0)
MAGJ DEMAND ROUTE DICOM^^0
"BLD",3463,"KRN",19.1,"NM","B","MAGDFIX ALL",1)

"BLD",3463,"KRN",19.1,"NM","B","MAGJ DEMAND ROUTE DICOM",2)

"BLD",3463,"KRN",101,0)
101
"BLD",3463,"KRN",101,"NM",0)
^9.68A^^
"BLD",3463,"KRN",409.61,0)
409.61
"BLD",3463,"KRN",771,0)
771
"BLD",3463,"KRN",870,0)
870
"BLD",3463,"KRN",8989.51,0)
8989.51
"BLD",3463,"KRN",8989.52,0)
8989.52
"BLD",3463,"KRN",8994,0)
8994
"BLD",3463,"KRN",8994,"NM",0)
^9.68A^3^3
"BLD",3463,"KRN",8994,"NM",1,0)
MAG DICOM GET RAD RPT INFO^^0
"BLD",3463,"KRN",8994,"NM",2,0)
MAG DICOM ROUTE EVAL LOG^^0
"BLD",3463,"KRN",8994,"NM",3,0)
MAG DICOM ROUTE EVAL START^^0
"BLD",3463,"KRN",8994,"NM","B","MAG DICOM GET RAD RPT INFO",1)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM ROUTE EVAL LOG",2)

"BLD",3463,"KRN",8994,"NM","B","MAG DICOM ROUTE EVAL START",3)

"BLD",3463,"KRN","B",.4,.4)

"BLD",3463,"KRN","B",.401,.401)

"BLD",3463,"KRN","B",.402,.402)

"BLD",3463,"KRN","B",.403,.403)

"BLD",3463,"KRN","B",.5,.5)

"BLD",3463,"KRN","B",.84,.84)

"BLD",3463,"KRN","B",3.6,3.6)

"BLD",3463,"KRN","B",3.8,3.8)

"BLD",3463,"KRN","B",9.2,9.2)

"BLD",3463,"KRN","B",9.8,9.8)

"BLD",3463,"KRN","B",19,19)

"BLD",3463,"KRN","B",19.1,19.1)

"BLD",3463,"KRN","B",101,101)

"BLD",3463,"KRN","B",409.61,409.61)

"BLD",3463,"KRN","B",771,771)

"BLD",3463,"KRN","B",870,870)

"BLD",3463,"KRN","B",8989.51,8989.51)

"BLD",3463,"KRN","B",8989.52,8989.52)

"BLD",3463,"KRN","B",8994,8994)

"BLD",3463,"REQB",0)
^9.611^2^2
"BLD",3463,"REQB",1,0)
MAG*3.0*11^2
"BLD",3463,"REQB",2,0)
MAG*3.0*40^2
"BLD",3463,"REQB","B","MAG*3.0*11",1)

"BLD",3463,"REQB","B","MAG*3.0*40",2)

"FIA",2006.1)
IMAGING SITE PARAMETERS
"FIA",2006.1,0)
^MAG(2006.1,
"FIA",2006.1,0,0)
2006.1I
"FIA",2006.1,0,1)
y^y^p^^^^n
"FIA",2006.1,0,10)

"FIA",2006.1,0,11)

"FIA",2006.1,0,"RLRO")

"FIA",2006.1,2006.1)
1
"FIA",2006.1,2006.1,126)

"FIA",2006.1,2006.1,127)

"FIA",2006.575)
DICOM FAILED IMAGES
"FIA",2006.575,0)
^MAGD(2006.575,
"FIA",2006.575,0,0)
2006.575
"FIA",2006.575,0,1)
y^y^p^^^^n
"FIA",2006.575,0,10)

"FIA",2006.575,0,11)

"FIA",2006.575,0,"RLRO")

"FIA",2006.575,2006.575)
1
"FIA",2006.575,2006.575,36)

"INI")
PRE^MAGIPS30
"INIT")
POST^MAGIPS30
"KRN",19.1,123457,-1)
0^1
"KRN",19.1,123457,0)
MAGDFIX ALL^Fix failed images at all sites^l^n
"KRN",19.1,123457,1,0)
^^7^7^3040108^
"KRN",19.1,123457,1,1,0)
This security key allows the holder to perform DICOM CORRECT functions on 
"KRN",19.1,123457,1,2,0)
any entry in the DICOM FAILED IMAGE File (#2006.575), whether or not
"KRN",19.1,123457,1,3,0)
that entry
"KRN",19.1,123457,1,4,0)
was captured through the DICOM Gateway of the user's site.
"KRN",19.1,123457,1,5,0)
 
"KRN",19.1,123457,1,6,0)
Users who do not hold this key will only be able to correct entries that 
"KRN",19.1,123457,1,7,0)
were captured on their own site's gateway.
"KRN",19.1,123458,-1)
0^2
"KRN",19.1,123458,0)
MAGJ DEMAND ROUTE DICOM^Demand Routing of DICOM images
"KRN",19.1,123458,1,0)
^^3^3^3031231^
"KRN",19.1,123458,1,1,0)
 Allow the user to queue DICOM images to be routed on demand.
"KRN",19.1,123458,1,2,0)
  This functionality exists in the VistaRad Exam List, and only for
"KRN",19.1,123458,1,3,0)
  sites that have been configured for routing of DICOM images.
"KRN",8994,123459,-1)
0^1
"KRN",8994,123459,0)
MAG DICOM GET RAD RPT INFO^RARPTO^MAGDRPC1^1^R^0^0^1^3^0
"KRN",8994,123459,1,0)
^8994.01^18^18
"KRN",8994,123459,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123459,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123459,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123459,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123459,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123459,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123459,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123459,1,8,0)
 |                                                               |
"KRN",8994,123459,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123459,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123459,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123459,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123459,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123459,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123459,1,15,0)
 
"KRN",8994,123459,1,16,0)
This RPC returns information from the Radiology Report Table.
"KRN",8994,123459,1,17,0)
The type of information returned depends on the values of the
"KRN",8994,123459,1,18,0)
input parameters.
"KRN",8994,123459,2,0)
^8994.02^4^4
"KRN",8994,123459,2,1,0)
TYPE^1^30^1^1
"KRN",8994,123459,2,1,1,0)
^8994.021^6^6
"KRN",8994,123459,2,1,1,1,0)
The value of this parameter is a string that indicates
"KRN",8994,123459,2,1,1,2,0)
the type of information that is requested:
"KRN",8994,123459,2,1,1,3,0)
  "O1":   Next or Previous report pointer at highest level
"KRN",8994,123459,2,1,1,4,0)
  "O2":   Next pointer at deeper level
"KRN",8994,123459,2,1,1,5,0)
  "G1":   Data record at highest level
"KRN",8994,123459,2,1,1,6,0)
  "G2":   Data record at deeper level
"KRN",8994,123459,2,2,0)
D0^1^30^1^2
"KRN",8994,123459,2,2,1,0)
^8994.021^2^2
"KRN",8994,123459,2,2,1,1,0)
The value of this parameter is a numeric value that identifies
"KRN",8994,123459,2,2,1,2,0)
the current record in the Radiology Report table.
"KRN",8994,123459,2,3,0)
F^1^30^1^3
"KRN",8994,123459,2,3,1,0)
^8994.021^6^6
"KRN",8994,123459,2,3,1,1,0)
If the value of the first input parameter is equal to "O1",
"KRN",8994,123459,2,3,1,2,0)
the value of this parameter is either -1 or +1, indicating
"KRN",8994,123459,2,3,1,3,0)
the traversal direction through the table.
"KRN",8994,123459,2,3,1,4,0)
For the other values of the first input parameter, the value
"KRN",8994,123459,2,3,1,5,0)
is the fixed subscript between the highest level entry number
"KRN",8994,123459,2,3,1,6,0)
and the next level internal entry number.
"KRN",8994,123459,2,4,0)
D1^1^30^1^4
"KRN",8994,123459,2,4,1,0)
^8994.021^2^2
"KRN",8994,123459,2,4,1,1,0)
The value of this parameter is the second-level FileMan internal
"KRN",8994,123459,2,4,1,2,0)
entry number into the Radiology Report table.
"KRN",8994,123459,2,"B","D0",2)

"KRN",8994,123459,2,"B","D1",4)

"KRN",8994,123459,2,"B","F",3)

"KRN",8994,123459,2,"B","TYPE",1)

"KRN",8994,123459,2,"PARAMSEQ",1,1)

"KRN",8994,123459,2,"PARAMSEQ",2,2)

"KRN",8994,123459,2,"PARAMSEQ",3,3)

"KRN",8994,123459,2,"PARAMSEQ",4,4)

"KRN",8994,123459,3,0)
^8994.03^2^2
"KRN",8994,123459,3,1,0)
The output value is a string that contains the requested information
"KRN",8994,123459,3,2,0)
(see input parameters).
"KRN",8994,123460,-1)
0^2
"KRN",8994,123460,0)
MAG DICOM ROUTE EVAL LOG^EVALLOG^MAGDRPC6^2^R^0^0^1^3.0^0
"KRN",8994,123460,1,0)
^8994.01^18^18
"KRN",8994,123460,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123460,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123460,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123460,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123460,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123460,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123460,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123460,1,8,0)
 |                                                               |
"KRN",8994,123460,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123460,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123460,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123460,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123460,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123460,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123460,1,15,0)
 
"KRN",8994,123460,1,16,0)
As a rule evaluator runs, it will produce an activity log.
"KRN",8994,123460,1,17,0)
This RPC can be called to return information from this log
"KRN",8994,123460,1,18,0)
from the VistA system to the DICOM Gateway.
"KRN",8994,123460,2,0)
^8994.02^4^4
"KRN",8994,123460,2,1,0)
TASK^1^30^1^1
"KRN",8994,123460,2,1,1,0)
^8994.021^2^2
"KRN",8994,123460,2,1,1,1,0)
The value of this parameter is a pointer to a TaskMan task.
"KRN",8994,123460,2,1,1,2,0)
This RPC will return log-information for the specified task.
"KRN",8994,123460,2,2,0)
MSG^1^30^1^2
"KRN",8994,123460,2,2,1,0)
^8994.021^3^3
"KRN",8994,123460,2,2,1,1,0)
The value of this parameter is an integer number.
"KRN",8994,123460,2,2,1,2,0)
This value is "one less than" the number of the first log-entry
"KRN",8994,123460,2,2,1,3,0)
to be returned.
"KRN",8994,123460,2,3,0)
MAX^1^30^1^3
"KRN",8994,123460,2,3,1,0)
^8994.021^3^3
"KRN",8994,123460,2,3,1,1,0)
The value of this parameter is an integer number.
"KRN",8994,123460,2,3,1,2,0)
This value is the maximum number of log-entries
"KRN",8994,123460,2,3,1,3,0)
to be returned.
"KRN",8994,123460,2,4,0)
LOCATION^1^30^1^4
"KRN",8994,123460,2,4,1,0)
^8994.021^2^2
"KRN",8994,123460,2,4,1,1,0)
The value of this parameter is a pointer to ^DIC(4).
"KRN",8994,123460,2,4,1,2,0)
This pointer identifies the location at which images were acquired.
"KRN",8994,123460,2,"B","LOCATION",4)

"KRN",8994,123460,2,"B","MAX",3)

"KRN",8994,123460,2,"B","MSG",2)

"KRN",8994,123460,2,"B","TASK",1)

"KRN",8994,123460,2,"PARAMSEQ",1,1)

"KRN",8994,123460,2,"PARAMSEQ",2,2)

"KRN",8994,123460,2,"PARAMSEQ",3,3)

"KRN",8994,123460,2,"PARAMSEQ",4,4)

"KRN",8994,123460,3,0)
^8994.03^7^7
"KRN",8994,123460,3,1,0)
This RPC returns an array.
"KRN",8994,123460,3,2,0)
OUT(1) = either a negative value, indicating an error condition
"KRN",8994,123460,3,3,0)
         or a string consisting of two non-negative integer values,
"KRN",8994,123460,3,4,0)
         separated by a space (" "). The first of these numbers
"KRN",8994,123460,3,5,0)
         indicates the number of log-entries returned, the second
"KRN",8994,123460,3,6,0)
         is the internal sequence number of the last message returned.
"KRN",8994,123460,3,7,0)
OUT(i) = a log entry text
"KRN",8994,123461,-1)
0^3
"KRN",8994,123461,0)
MAG DICOM ROUTE EVAL START^START^MAGDRPC5^1^R^0^0^1^3.0^0
"KRN",8994,123461,1,0)
^8994.01^20^20
"KRN",8994,123461,1,1,0)
 +---------------------------------------------------------------+
"KRN",8994,123461,1,2,0)
 | Property of the US Government.                                |
"KRN",8994,123461,1,3,0)
 | No permission to copy or redistribute this software is given. |
"KRN",8994,123461,1,4,0)
 | Use of unreleased versions of this software requires the user |
"KRN",8994,123461,1,5,0)
 | to execute a written test agreement with the VistA Imaging    |
"KRN",8994,123461,1,6,0)
 | Development Office of the Department of Veterans Affairs,     |
"KRN",8994,123461,1,7,0)
 | telephone (301) 734-0100.                                     |
"KRN",8994,123461,1,8,0)
 |                                                               |
"KRN",8994,123461,1,9,0)
 | The Food and Drug Administration classifies this software as  |
"KRN",8994,123461,1,10,0)
 | a medical device.  As such, it may not be changed in any way. |
"KRN",8994,123461,1,11,0)
 | Modifications to this software may result in an adulterated   |
"KRN",8994,123461,1,12,0)
 | medical device under 21CFR820, the use of which is considered |
"KRN",8994,123461,1,13,0)
 | to be a violation of US Federal Statutes.                     |
"KRN",8994,123461,1,14,0)
 +---------------------------------------------------------------+
"KRN",8994,123461,1,15,0)
 
"KRN",8994,123461,1,16,0)
Start one rule evaluator to evaluate the newly acquired
"KRN",8994,123461,1,17,0)
images for one specific location.
"KRN",8994,123461,1,18,0)
 
"KRN",8994,123461,1,19,0)
The rule-evaluators will run on the VistA system. They will be
"KRN",8994,123461,1,20,0)
started and stopped, however, from the DICOM Gateways.
"KRN",8994,123461,2,0)
^8994.02^2^2
"KRN",8994,123461,2,1,0)
LOCATION^1^30^1^1
"KRN",8994,123461,2,1,1,0)
^8994.021^2^2
"KRN",8994,123461,2,1,1,1,0)
The value of this parameter is a pointer to ^DIC(4).
"KRN",8994,123461,2,1,1,2,0)
This pointer identifies the location at which images were acquired.
"KRN",8994,123461,2,2,0)
RULES^2^^1^2
"KRN",8994,123461,2,2,1,0)
^8994.021^39^39
"KRN",8994,123461,2,2,1,1,0)
The value of this parameter is an array (one integer subscript).
"KRN",8994,123461,2,2,1,2,0)
This array contains the routing rules. Each element of this
"KRN",8994,123461,2,2,1,3,0)
array represents one part of a rule; the strings in these elements
"KRN",8994,123461,2,2,1,4,0)
each contain a number of fields, separated by carets ("^").
"KRN",8994,123461,2,2,1,5,0)
 
"KRN",8994,123461,2,2,1,6,0)
In all rule-elements, the first caret-piece is the rule-number.
"KRN",8994,123461,2,2,1,7,0)
 
"KRN",8994,123461,2,2,1,8,0)
The second piece is equal to either "ACTION", "CONDITION"
"KRN",8994,123461,2,2,1,9,0)
or "PRIORITY".
"KRN",8994,123461,2,2,1,10,0)
 
"KRN",8994,123461,2,2,1,11,0)
When the second piece is equal to "ACTION", there may be one or more
"KRN",8994,123461,2,2,1,12,0)
additional pieces. If there is only an additional third piece,
"KRN",8994,123461,2,2,1,13,0)
this piece represents the action-verb ("SEND" or "BALANCE"
"KRN",8994,123461,2,2,1,14,0)
currently).
"KRN",8994,123461,2,2,1,15,0)
When there are four or more pieces, the third piece represents
"KRN",8994,123461,2,2,1,16,0)
the sequence number of the command-parameter, and the additional
"KRN",8994,123461,2,2,1,17,0)
pieces represent the command-specific parameters.
"KRN",8994,123461,2,2,1,18,0)
 
"KRN",8994,123461,2,2,1,19,0)
When the second piece is equal to "PRIORITY", the third piece
"KRN",8994,123461,2,2,1,20,0)
will indicate the relative priority. Typical values are "LOW",
"KRN",8994,123461,2,2,1,21,0)
"MEDIUM" and "HIGH".
"KRN",8994,123461,2,2,1,22,0)
 
"KRN",8994,123461,2,2,1,23,0)
When the second piece is equal to "CONDITION", there are either
"KRN",8994,123461,2,2,1,24,0)
five or seven pieces in total. 
"KRN",8994,123461,2,2,1,25,0)
In that case, the third piece always represents the sequence number
"KRN",8994,123461,2,2,1,26,0)
of the current condition for the current rule.
"KRN",8994,123461,2,2,1,27,0)
When there are five pieces,
"KRN",8994,123461,2,2,1,28,0)
the fourth and fifth are a keyword=value pair and describe
"KRN",8994,123461,2,2,1,29,0)
the nature of the condition. Valid keywords are "KW" (keyword),
"KRN",8994,123461,2,2,1,30,0)
"DT" (data-type), "OP" (operator) and "VA" (value).
"KRN",8994,123461,2,2,1,31,0)
A sequence of seven pieces only occurs when the data-type is
"KRN",8994,123461,2,2,1,32,0)
equal to DT (Date/Time). When there are seven pieces, the fourth
"KRN",8994,123461,2,2,1,33,0)
piece is always equal to "VA" (value) and the fifth through seventh
"KRN",8994,123461,2,2,1,34,0)
pieces indicate a possible date/time range that applies for the
"KRN",8994,123461,2,2,1,35,0)
condition.
"KRN",8994,123461,2,2,1,36,0)
 
"KRN",8994,123461,2,2,1,37,0)
Note that conditions are always ANDed with one another, and
"KRN",8994,123461,2,2,1,38,0)
the multiple date/time ranges for a date/time value are always
"KRN",8994,123461,2,2,1,39,0)
ORed with one another.
"KRN",8994,123461,2,"B","LOCATION",1)

"KRN",8994,123461,2,"B","RULES",2)

"KRN",8994,123461,2,"PARAMSEQ",1,1)

"KRN",8994,123461,2,"PARAMSEQ",2,2)

"KRN",8994,123461,3,0)
^8994.03^6^6
"KRN",8994,123461,3,1,0)
The value of this parameter is one of:
"KRN",8994,123461,3,2,0)
  "0,TaskMan task#=nnn"
"KRN",8994,123461,3,3,0)
  "-1,No Location Specified"
"KRN",8994,123461,3,4,0)
  "-2,No Routing Rules Specified"
"KRN",8994,123461,3,5,0)
  "-3,A Rule Evaluator is Already Running for <location>"
"KRN",8994,123461,3,6,0)
  "-4,TaskMan did not Accept Request"
"MBREQ")
0
"ORD",3,19.1)
19.1;3;1;;KEY^XPDTA1;;;KEYF2^XPDIA1;;KEYDEL^XPDIA1
"ORD",3,19.1,0)
SECURITY KEY
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging Release History
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020328^3020328^.5
"PKG",454,22,1,"PAH",1,0)
30^3040916^.5
"PKG",454,22,1,"PAH",1,1,0)
^9.49011^36^36^3040916
"PKG",454,22,1,"PAH",1,1,1,0)
Routines for Patch 30, Test Build 11.
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
MAG7RS      value = 12193599
"PKG",454,22,1,"PAH",1,1,5,0)
MAGBRTE4    value = 15019760
"PKG",454,22,1,"PAH",1,1,6,0)
MAGBRTE5    value = 12363938
"PKG",454,22,1,"PAH",1,1,7,0)
MAGBRTLD    value = 5665322
"PKG",454,22,1,"PAH",1,1,8,0)
MAGBRTUT    value = 6805146
"PKG",454,22,1,"PAH",1,1,9,0)
MAGDCCS2    value = 6363543
"PKG",454,22,1,"PAH",1,1,10,0)
MAGDHL7     value = 7399823
"PKG",454,22,1,"PAH",1,1,11,0)
MAGDHRS1    value = 5025884
"PKG",454,22,1,"PAH",1,1,12,0)
MAGDIR81    value = 14282136
"PKG",454,22,1,"PAH",1,1,13,0)
MAGDIR82    value = 13464369
"PKG",454,22,1,"PAH",1,1,14,0)
MAGDIR83    value = 7606355
"PKG",454,22,1,"PAH",1,1,15,0)
MAGDIR85    value = 2914037
"PKG",454,22,1,"PAH",1,1,16,0)
MAGDIR9A    value = 10789655
"PKG",454,22,1,"PAH",1,1,17,0)
MAGDIRVE    value = 15732775
"PKG",454,22,1,"PAH",1,1,18,0)
MAGDLB1     value = 11911075
"PKG",454,22,1,"PAH",1,1,19,0)
MAGDRA1     value = 7842219
"PKG",454,22,1,"PAH",1,1,20,0)
MAGDRCU1    value = 8485773
"PKG",454,22,1,"PAH",1,1,21,0)
MAGDRPC1    value = 8395133
"PKG",454,22,1,"PAH",1,1,22,0)
MAGDRPC2    value = 12950501
"PKG",454,22,1,"PAH",1,1,23,0)
MAGDRPC3    value = 11631756
"PKG",454,22,1,"PAH",1,1,24,0)
MAGDRPC4    value = 15201662
"PKG",454,22,1,"PAH",1,1,25,0)
MAGDRPC5    value = 14221287
"PKG",454,22,1,"PAH",1,1,26,0)
MAGDRPC6    value = 11175169
"PKG",454,22,1,"PAH",1,1,27,0)
MAGDRPC8    value = 10596480
"PKG",454,22,1,"PAH",1,1,28,0)
MAGIPS30    value = 4783130
"PKG",454,22,1,"PAH",1,1,29,0)
MAGQE1      value = 4871610
"PKG",454,22,1,"PAH",1,1,30,0)
MAGQE3      value = 15528150
"PKG",454,22,1,"PAH",1,1,31,0)
MAGQE4      value = 5670112
"PKG",454,22,1,"PAH",1,1,32,0)
MAGQE5      value = 10174225
"PKG",454,22,1,"PAH",1,1,33,0)
MAGQST      value = 4967326
"PKG",454,22,1,"PAH",1,1,34,0)
 
"PKG",454,22,1,"PAH",1,1,35,0)
Please note that routine MAGIPS30 is deleted after the KIDS Build is
"PKG",454,22,1,"PAH",1,1,36,0)
installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
30
"RTN","MAG7RS")
0^1^B54368283
"RTN","MAG7RS",1,0)
MAG7RS ;WOIFO/PMK,MLH - copy radiology message from HLSDATA to ^MAGDHL7 - add segment data ; 30 Jun 2004  4:32 PM
"RTN","MAG7RS",2,0)
 ;;3.0;IMAGING;**11,40,30**;16-September-2004
"RTN","MAG7RS",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7RS",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAG7RS",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAG7RS",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAG7RS",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAG7RS",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAG7RS",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAG7RS",10,0)
 ;; |                                                               |
"RTN","MAG7RS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAG7RS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAG7RS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAG7RS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAG7RS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAG7RS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7RS",17,0)
 ;;
"RTN","MAG7RS",18,0)
 ;
"RTN","MAG7RS",19,0)
PIDADD ; SUBROUTINE - called by ADDDTA^MAGDHL7
"RTN","MAG7RS",20,0)
 ; Add PID info for DICOM Gateway.
"RTN","MAG7RS",21,0)
 ; Uses multi-tier array structure MAG7WRK produced by call to MAG7UP.
"RTN","MAG7RS",22,0)
 ;
"RTN","MAG7RS",23,0)
 N DIQUIET ; -------------- FileMan verbose/silent variable
"RTN","MAG7RS",24,0)
 N IXPID ; ---------------- index to PID segment in MAG7WRK array
"RTN","MAG7RS",25,0)
 N VADM,VAPA ; ------------ VADPT return arrays
"RTN","MAG7RS",26,0)
 ;
"RTN","MAG7RS",27,0)
 ; ====================================================
"RTN","MAG7RS",28,0)
 ; Get patient DFN and retrieve demo data.
"RTN","MAG7RS",29,0)
 S IXPID=$O(MAG7WRK("B","PID","")) I 'IXPID Q
"RTN","MAG7RS",30,0)
 S DFN=MAG7WRK(IXPID,3,1,1,1) I 'DFN Q
"RTN","MAG7RS",31,0)
 ;
"RTN","MAG7RS",32,0)
 ; ================================================
"RTN","MAG7RS",33,0)
 ; load demo information into HL7 PID segment
"RTN","MAG7RS",34,0)
 S DIQUIET=1
"RTN","MAG7RS",35,0)
 D DEM^VADPT ; demo into VADM()
"RTN","MAG7RS",36,0)
 I '$G(VAERR),VADM(3)]"" D
"RTN","MAG7RS",37,0)
 . S MAG7WRK(IXPID,7,1,1,1)=$P(VADM(3),"^")+17000000 ; DOB
"RTN","MAG7RS",38,0)
 . Q
"RTN","MAG7RS",39,0)
 ;
"RTN","MAG7RS",40,0)
 ; ================================================
"RTN","MAG7RS",41,0)
 ; load address information into HL7 PID segment
"RTN","MAG7RS",42,0)
 S DIQUIET=1
"RTN","MAG7RS",43,0)
 D ADD^VADPT ; address & phone into VAPA()
"RTN","MAG7RS",44,0)
 I '$G(VAERR) D
"RTN","MAG7RS",45,0)
 . S MAG7WRK(IXPID,10,1,2,1)=$P(VADM(8),"^",2) ; race
"RTN","MAG7RS",46,0)
 . S MAG7WRK(IXPID,11,1,1,1)=VAPA(1) ; street address 1st line
"RTN","MAG7RS",47,0)
 . S MAG7WRK(IXPID,11,1,2,1)=VAPA(2)_$S(VAPA(3)="":"",1:", "_VAPA(3)) ; lns 2-3
"RTN","MAG7RS",48,0)
 . S MAG7WRK(IXPID,11,1,3,1)=VAPA(4) ; city
"RTN","MAG7RS",49,0)
 . S MAG7WRK(IXPID,11,1,4,1)=VAPA(5) ; 2-letter state
"RTN","MAG7RS",50,0)
 . S MAG7WRK(IXPID,11,1,5,1)=VAPA(6) ; ZIP
"RTN","MAG7RS",51,0)
 . ; phone
"RTN","MAG7RS",52,0)
 . S MAG7WRK(IXPID,13,1,1,1)=VAPA(8)
"RTN","MAG7RS",53,0)
 . S MAG7WRK(IXPID,13,1,2,1)="PRN" ; phone
"RTN","MAG7RS",54,0)
 . Q
"RTN","MAG7RS",55,0)
 Q
"RTN","MAG7RS",56,0)
 ;
"RTN","MAG7RS",57,0)
ADDVSDG ; SUBROUTINE - called by ADDDTA^MAGDHL7
"RTN","MAG7RS",58,0)
 ; Add visit and diagnosis info for DICOM Gateway.
"RTN","MAG7RS",59,0)
 ;
"RTN","MAG7RS",60,0)
 N DIQUIET ; ------ FileMan verbose/silent variable
"RTN","MAG7RS",61,0)
 N I,IX,IX1 ; ----- scratch index vars
"RTN","MAG7RS",62,0)
 N IXPID,IXPV1 ; -- indices to PID, PV1 segs in MAG7WRK array
"RTN","MAG7RS",63,0)
 N IXDG1,IXOBR ; -- indices to DG1, OBR segs in MAG7WRK array
"RTN","MAG7RS",64,0)
 N IXVAEL ; ------- index of entries in VAEL()
"RTN","MAG7RS",65,0)
 N VAIN,VAEL ; ---- VADPT return arrays
"RTN","MAG7RS",66,0)
 N MAGPHYNM ; ----- physician name
"RTN","MAG7RS",67,0)
 N ELCODE ; ------- eligibility code
"RTN","MAG7RS",68,0)
 ;
"RTN","MAG7RS",69,0)
 ; ====================================================
"RTN","MAG7RS",70,0)
 ; Get patient DFN and retrieve inpatient data.
"RTN","MAG7RS",71,0)
 S IXPID=$O(MAG7WRK("B","PID","")) I 'IXPID Q
"RTN","MAG7RS",72,0)
 S DFN=MAG7WRK(IXPID,3,1,1,1) I 'DFN Q
"RTN","MAG7RS",73,0)
 S DIQUIET=1
"RTN","MAG7RS",74,0)
 D INP^VADPT Q:VAERR  ; inpatient data in VAIN()
"RTN","MAG7RS",75,0)
 D ELIG^VADPT Q:VAERR  ; eligibility data in VAEL()
"RTN","MAG7RS",76,0)
 D PV1ADD($S($G(VAIN(1))]"":"IN",1:"OUT"))
"RTN","MAG7RS",77,0)
 ; add pregnancy status and modalities if not already part of order
"RTN","MAG7RS",78,0)
 ; message
"RTN","MAG7RS",79,0)
 I $G(MAG7WRK(1,9,1,1,1))="ORM" D
"RTN","MAG7RS",80,0)
 . S IXOBR=$O(MAG7WRK("B","OBR",""))
"RTN","MAG7RS",81,0)
 . I IXOBR D PV1RAD ; pregnancy status & modality info from Radiology
"RTN","MAG7RS",82,0)
 . Q
"RTN","MAG7RS",83,0)
 Q
"RTN","MAG7RS",84,0)
 ;
"RTN","MAG7RS",85,0)
PV1ADD(XPTSTA) ; SUBROUTINE - called by ADDVSDG
"RTN","MAG7RS",86,0)
 ; Get the index of the PV1 segment - create one for the order message
"RTN","MAG7RS",87,0)
 ; if we need to.
"RTN","MAG7RS",88,0)
 ; 
"RTN","MAG7RS",89,0)
 ; input:  XPTSTA        patient status { IN | OUT }
"RTN","MAG7RS",90,0)
 ; 
"RTN","MAG7RS",91,0)
 ; Expects:  VAEL()      eligibility array from ELIG^VADPT
"RTN","MAG7RS",92,0)
 ;           VAIN()      inpatient data array from INP^VADPT
"RTN","MAG7RS",93,0)
 ;
"RTN","MAG7RS",94,0)
 N FSTAT ; -- status flag returned by MAG7UDR
"RTN","MAG7RS",95,0)
 N IXSEG ; -- segment index in message
"RTN","MAG7RS",96,0)
 N IXPRED ; -- index to predecessor segment
"RTN","MAG7RS",97,0)
 N IXSUCC ; -- index to successor segment
"RTN","MAG7RS",98,0)
 ;
"RTN","MAG7RS",99,0)
 S IXPV1=$O(MAG7WRK("B","PV1",""))
"RTN","MAG7RS",100,0)
 I 'IXPV1 Q:MAG7WRK(1,9,1,1,1)'="ORM"  D
"RTN","MAG7RS",101,0)
 . S (IXSEG,IXPRED)=$O(MAG7WRK("B","PID","")) Q:'IXSEG
"RTN","MAG7RS",102,0)
 . F  S IXSEG=$O(MAG7WRK(IXSEG)) Q:"^PD1^NTE^"'[("^"_$G(MAG7WRK(IXSEG,0))_"^")  S IXPRED=IXSEG
"RTN","MAG7RS",103,0)
 . S IXSUCC=$O(MAG7WRK(IXPRED)),IXPV1=$S(IXSUCC:IXPRED+IXSUCC/2,1:IXPRED+1)
"RTN","MAG7RS",104,0)
 . S MAG7WRK(IXPV1,0)="PV1"
"RTN","MAG7RS",105,0)
 . Q
"RTN","MAG7RS",106,0)
 ;
"RTN","MAG7RS",107,0)
 ; pt status
"RTN","MAG7RS",108,0)
 I XPTSTA="OUT" D  ; if op, just status for now
"RTN","MAG7RS",109,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="O"
"RTN","MAG7RS",110,0)
 . Q
"RTN","MAG7RS",111,0)
 E  I XPTSTA'="IN" D  ; not applicable 
"RTN","MAG7RS",112,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="N"
"RTN","MAG7RS",113,0)
 . Q
"RTN","MAG7RS",114,0)
 E  D  ; get visit information too
"RTN","MAG7RS",115,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="I" ; -- class - always inpatient
"RTN","MAG7RS",116,0)
 . ; location
"RTN","MAG7RS",117,0)
 . ;    point of care <--- ward -- needs to be a triplet for Pete's DICOM msg
"RTN","MAG7RS",118,0)
 . S MAG7WRK(IXPV1,3,1,1,1)=$P(VAIN(4),U)
"RTN","MAG7RS",119,0)
 . S MAG7WRK(IXPV1,3,1,1,2)=$P(VAIN(4),U,2)
"RTN","MAG7RS",120,0)
 . S MAG7WRK(IXPV1,3,1,1,3)="VISTA42"
"RTN","MAG7RS",121,0)
 . S MAG7WRK(IXPV1,3,1,2,1)=$P(VAIN(5),"-") ; -------- room
"RTN","MAG7RS",122,0)
 . S MAG7WRK(IXPV1,3,1,3,1)=$P(VAIN(5),"-",2) ; ------ bed
"RTN","MAG7RS",123,0)
 . ; add segment for admitting dx to ADT and ORM messages
"RTN","MAG7RS",124,0)
 . I $G(VAIN(9))]"" D DG1DGADM^MAG7RSD
"RTN","MAG7RS",125,0)
 . Q
"RTN","MAG7RS",126,0)
 ;
"RTN","MAG7RS",127,0)
 ; add PV1 fields and ROL segments for the attending and referring DRs
"RTN","MAG7RS",128,0)
 S FSTAT=$$PRCTADD^MAG7UDR($NA(MAG7WRK(IXPV1,7)),"ATT") ; attending DR
"RTN","MAG7RS",129,0)
 I $G(MAG7WRK(IXPV1,7,1,1,1)),$G(MAG7WRK(1,9,1,1,1))="ADT" D
"RTN","MAG7RS",130,0)
 . D ROLADD^MAG7RSR($NA(MAG7WRK(IXPV1,7,1)),"AT")
"RTN","MAG7RS",131,0)
 . Q
"RTN","MAG7RS",132,0)
 S FSTAT=$$PRCTADD^MAG7UDR($NA(MAG7WRK(IXPV1,8)),"REF") ; referring DR
"RTN","MAG7RS",133,0)
 I $G(MAG7WRK(IXPV1,8,1,1,1)),$G(MAG7WRK(1,9,1,1,1))="ADT" D
"RTN","MAG7RS",134,0)
 . D ROLADD^MAG7RSR($NA(MAG7WRK(IXPV1,8,1)),"RP")
"RTN","MAG7RS",135,0)
 . Q
"RTN","MAG7RS",136,0)
 I $D(VAEL) D  ; add VIP flag if applicable and not yet present
"RTN","MAG7RS",137,0)
 . S VAEL(1,0)=VAEL(1) ; for easy array navigation
"RTN","MAG7RS",138,0)
 . S IXVAEL=""
"RTN","MAG7RS",139,0)
 . F  Q:$D(IXPV1(16))  S IXVAEL=$O(VAEL(1,IXVAEL)) Q:IXVAEL=""  D
"RTN","MAG7RS",140,0)
 . . S ELCODE=$P($G(VAEL(1,IXVAEL)),"^")
"RTN","MAG7RS",141,0)
 . . I "^6^15^"[("^"_ELCODE_"^") S IXPV1(16,1,1,1,1)=ELCODE
"RTN","MAG7RS",142,0)
 . . Q
"RTN","MAG7RS",143,0)
 . Q
"RTN","MAG7RS",144,0)
 Q
"RTN","MAG7RS",145,0)
 ;
"RTN","MAG7RS",146,0)
PV1RAD ; SUBROUTINE - called by ADDVSDG
"RTN","MAG7RS",147,0)
 ; Add "pregnant" to Ambulatory Status if patient is pregnant.
"RTN","MAG7RS",148,0)
 ; Add modalities to Diagnostic Service Section ID.
"RTN","MAG7RS",149,0)
 ; 
"RTN","MAG7RS",150,0)
 ; Expects:  MAG7WRK()     HL7 message array
"RTN","MAG7RS",151,0)
 ;           IXOBR         Index of OBR segment on MAG7WRK()
"RTN","MAG7RS",152,0)
 ;           IXPV1         Index of PV1 segment on MAG7WRK()
"RTN","MAG7RS",153,0)
 ;           
"RTN","MAG7RS",154,0)
 N RADPT2 ; ------- FileMan date of rad order
"RTN","MAG7RS",155,0)
 N RADPT3 ; ------- index of order under date on Rad/NM pt file
"RTN","MAG7RS",156,0)
 N RADPT0 ; ------- data for order on Rad/NM pt file
"RTN","MAG7RS",157,0)
 N RAOIEN ; ------- index of order on Rad/NM order file
"RTN","MAG7RS",158,0)
 N RAO0 ; --------- data for order on Rad/NM order file
"RTN","MAG7RS",159,0)
 N PROCIEN ; ------ ien of procedure on Rad/NM procedure file
"RTN","MAG7RS",160,0)
 N PROCMOD ; ------ ien of modality on Rad/NM procedure file
"RTN","MAG7RS",161,0)
 N MODIEN ; ------- ien of modality on modality defined terms file
"RTN","MAG7RS",162,0)
 N MODTERM ; ------ term for the modality
"RTN","MAG7RS",163,0)
 N PREGSTAT ; ----- pregnancy status on order
"RTN","MAG7RS",164,0)
 N REPIX ; -------- repetition index
"RTN","MAG7RS",165,0)
 N EDTA ; --------- element data
"RTN","MAG7RS",166,0)
 N AAMBMSG ; ------ ambulatory status array (from message data)
"RTN","MAG7RS",167,0)
 N AMODMSG ; ------ modality array (from message data)
"RTN","MAG7RS",168,0)
 ;
"RTN","MAG7RS",169,0)
 ; get data from Rad/NM pt and order files
"RTN","MAG7RS",170,0)
 S RADPT2=$P(MAG7WRK(IXOBR,3,1,1,1),"-")
"RTN","MAG7RS",171,0)
 S RADPT3=$P(MAG7WRK(IXOBR,3,1,1,1),"-",2)
"RTN","MAG7RS",172,0)
 S RADPT0=$G(^RADPT(DFN,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAG7RS",173,0)
 S RAOIEN=$P(RADPT0,"^",11) ; IEN for ^RAO(75.1)
"RTN","MAG7RS",174,0)
 S RAO0="" I RAOIEN S RAO0=$G(^RAO(75.1,RAOIEN,0))
"RTN","MAG7RS",175,0)
 ;
"RTN","MAG7RS",176,0)
 ; add "pregnant" to ambulatory status if needed
"RTN","MAG7RS",177,0)
 ;   get data from message
"RTN","MAG7RS",178,0)
 S REPIX=""
"RTN","MAG7RS",179,0)
 F  S REPIX=$O(MAG7WRK(IXPV1,15,REPIX)) Q:'REPIX  D
"RTN","MAG7RS",180,0)
 . S EDTA=$G(MAG7WRK(IXPV1,15,REPIX,1,1)) I EDTA]"" S AAMBMSG(EDTA)=""
"RTN","MAG7RS",181,0)
 . Q
"RTN","MAG7RS",182,0)
 ;   get data from Radiology and add to message if needed and not present
"RTN","MAG7RS",183,0)
 S PREGSTAT=$P(RAO0,"^",13) I PREGSTAT="" S PREGSTAT="u"
"RTN","MAG7RS",184,0)
 I '$D(AAMBMSG("B6")),PREGSTAT="y" D
"RTN","MAG7RS",185,0)
 . S MAG7WRK(IXPV1,15,$O(MAG7WRK(IXPV1,15," "),-1)+1,1,1)="B6"
"RTN","MAG7RS",186,0)
 . Q
"RTN","MAG7RS",187,0)
 ;
"RTN","MAG7RS",188,0)
 ; add modalities to Diagnostic Service Section ID
"RTN","MAG7RS",189,0)
 ;   get data from message
"RTN","MAG7RS",190,0)
 F  S REPIX=$O(MAG7WRK(IXOBR,24,REPIX)) Q:'REPIX  D
"RTN","MAG7RS",191,0)
 . S EDTA=$G(MAG7WRK(IXOBR,24,REPIX,1,1)) I EDTA]"" S AMODMSG(EDTA)=""
"RTN","MAG7RS",192,0)
 . Q
"RTN","MAG7RS",193,0)
 ;   get data from Radiology and add to message if needed and not present
"RTN","MAG7RS",194,0)
 S PROCIEN=$P(RADPT0,U,2)
"RTN","MAG7RS",195,0)
 I PROCIEN D
"RTN","MAG7RS",196,0)
 . S PROCMOD=0
"RTN","MAG7RS",197,0)
 . F  S PROCMOD=$O(^RAMIS(71,PROCIEN,"MDL",PROCMOD)) Q:'PROCMOD  D
"RTN","MAG7RS",198,0)
 . . S MODIEN=$P($G(^RAMIS(71,PROCIEN,"MDL",PROCMOD,0)),U)
"RTN","MAG7RS",199,0)
 . . I MODIEN,$D(^RAMIS(73.1,MODIEN,0)) D
"RTN","MAG7RS",200,0)
 . . . S MODTERM=$P($G(^RAMIS(73.1,MODIEN,0)),U)
"RTN","MAG7RS",201,0)
 . . . I MODTERM]"",'$D(AMODMSG(MODTERM)) D
"RTN","MAG7RS",202,0)
 . . . . S MAG7WRK(IXOBR,24,$O(MAG7WRK(IXOBR,24," "),-1)+1,1,1)=MODTERM
"RTN","MAG7RS",203,0)
 . . . . Q
"RTN","MAG7RS",204,0)
 . . . Q
"RTN","MAG7RS",205,0)
 . . Q
"RTN","MAG7RS",206,0)
 . Q
"RTN","MAG7RS",207,0)
 Q
"RTN","MAGBRTE4")
0^2^B79381896
"RTN","MAGBRTE4",1,0)
MAGBRTE4 ;WOIFO/EdM - Process Routing Rule Evaluation Queue ; 09/08/2004  07:29
"RTN","MAGBRTE4",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGBRTE4",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE4",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTE4",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTE4",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTE4",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTE4",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTE4",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTE4",10,0)
 ;; |                                                               |
"RTN","MAGBRTE4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTE4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTE4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTE4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTE4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTE4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE4",17,0)
 ;;
"RTN","MAGBRTE4",18,0)
 Q
"RTN","MAGBRTE4",19,0)
 ;
"RTN","MAGBRTE4",20,0)
EVAL ;
"RTN","MAGBRTE4",21,0)
 N ACTIVE ;--- Switch that controls start/stop queue processor
"RTN","MAGBRTE4",22,0)
 N ANY ;------ Flag: processed any rule
"RTN","MAGBRTE4",23,0)
 N CONS ;----- Switch that indicates whether or not site has "consolidated" code
"RTN","MAGBRTE4",24,0)
 ;
"RTN","MAGBRTE4",25,0)
 K ^XTMP("MAGEVAL",ZTSK)
"RTN","MAGBRTE4",26,0)
 D LOG("Started at "_$H)
"RTN","MAGBRTE4",27,0)
 D
"RTN","MAGBRTE4",28,0)
 . S CONS=0
"RTN","MAGBRTE4",29,0)
 . Q:$E($O(^MAG(2006.1," ")),1)="A"
"RTN","MAGBRTE4",30,0)
 . S CONS=1
"RTN","MAGBRTE4",31,0)
 . Q
"RTN","MAGBRTE4",32,0)
 S PLACE=$S(CONS:$O(^MAG(2006.1,"B",LOCATION,"")),1:1)
"RTN","MAGBRTE4",33,0)
 L +^MAGDICOM(2006.563,1,"EVAL",LOCATION):0 E  D  Q
"RTN","MAGBRTE4",34,0)
 . D LOG("A rule evaluator is already running for "_$$GET1^DIQ(4,LOCATION,.01))
"RTN","MAGBRTE4",35,0)
 . Q
"RTN","MAGBRTE4",36,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=1
"RTN","MAGBRTE4",37,0)
 ;
"RTN","MAGBRTE4",38,0)
 S I="" F  S I=$O(RULES(I)) Q:I=""  D
"RTN","MAGBRTE4",39,0)
 . N D0,D1,D2,L,Q1
"RTN","MAGBRTE4",40,0)
 . S X=RULES(I),D0=$P(X,"^",1),Q1=$P(X,"^",2),L=$L(X,"^")
"RTN","MAGBRTE4",41,0)
 . I L=3 S RULE(D0,Q1)=$P(X,"^",3) Q
"RTN","MAGBRTE4",42,0)
 . I Q1="ACTION" S RULE(D0,Q1,$P(X,"^",3))=$P(X,"^",4,L) Q
"RTN","MAGBRTE4",43,0)
 . I Q1'="CONDITION" D LOG("Rule "_D0_" has a qualifier """_Q1_""".") Q
"RTN","MAGBRTE4",44,0)
 . I L=5 S RULE(D0,Q1,$P(X,"^",3),$P(X,"^",4))=$P(X,"^",5) Q
"RTN","MAGBRTE4",45,0)
 . S RULE(D0,Q1,$P(X,"^",3),$P(X,"^",4),$P(X,"^",6),$P(X,"^",5))=$P(X,"^",7)
"RTN","MAGBRTE4",46,0)
 . Q
"RTN","MAGBRTE4",47,0)
 K RULES
"RTN","MAGBRTE4",48,0)
 ;
"RTN","MAGBRTE4",49,0)
 S ACTIVE=1 F  D  Q:'ACTIVE
"RTN","MAGBRTE4",50,0)
 . S ANY=0
"RTN","MAGBRTE4",51,0)
 . S ACTIVE=+$G(^MAGDICOM(2006.563,1,"EVAL")) I 'ACTIVE D  Q
"RTN","MAGBRTE4",52,0)
 . . D LOG("Stopped at "_$H)
"RTN","MAGBRTE4",53,0)
 . . Q
"RTN","MAGBRTE4",54,0)
 . D
"RTN","MAGBRTE4",55,0)
 . . N IMAGE,QPTR,QPTR2,STATUS,X
"RTN","MAGBRTE4",56,0)
 . . D:'CONS ADD^MAGBAPI(0,"EVAL")
"RTN","MAGBRTE4",57,0)
 . . D:CONS ADD^MAGBAPI(0,"EVAL",PLACE)
"RTN","MAGBRTE4",58,0)
 . . S QPTR2=$O(^MAGQUEUE(2006.031,"B","EVAL",""))
"RTN","MAGBRTE4",59,0)
 . . S QPTR=$S(QPTR2:$P(^MAGQUEUE(2006.031,QPTR2,0),"^",2),1:"")
"RTN","MAGBRTE4",60,0)
 . . ; Get next queue pointer value
"RTN","MAGBRTE4",61,0)
 . . S:'CONS QPTR=$O(^MAGQUEUE(2006.03,"B","EVAL",QPTR))
"RTN","MAGBRTE4",62,0)
 . . S:CONS QPTR=$O(^MAGQUEUE(2006.03,"C",PLACE,"EVAL",QPTR))
"RTN","MAGBRTE4",63,0)
 . . I QPTR="" Q  ; Nothing to do
"RTN","MAGBRTE4",64,0)
 . . ;
"RTN","MAGBRTE4",65,0)
 . . S X=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGBRTE4",66,0)
 . . ; After an error, sometimes the entry is purged,
"RTN","MAGBRTE4",67,0)
 . . ; but the cross reference is still present.
"RTN","MAGBRTE4",68,0)
 . . ; In such a case, remove the cross reference.
"RTN","MAGBRTE4",69,0)
 . . I X="" D  Q
"RTN","MAGBRTE4",70,0)
 . . . K:'CONS ^MAGQUEUE(2006.03,"B","EVAL",QPTR)
"RTN","MAGBRTE4",71,0)
 . . . K:CONS ^MAGQUEUE(2006.03,"C",PLACE,"EVAL",QPTR)
"RTN","MAGBRTE4",72,0)
 . . . Q
"RTN","MAGBRTE4",73,0)
 . . ;
"RTN","MAGBRTE4",74,0)
 . . S IMAGE=$P(X,"^",7),ANY=1
"RTN","MAGBRTE4",75,0)
 . . I IMAGE,$D(^MAG(2005,IMAGE,0)) D
"RTN","MAGBRTE4",76,0)
 . . . S STATUS=$$RULES() Q:STATUS'<0
"RTN","MAGBRTE4",77,0)
 . . . I STATUS["NO NETWORK LOCATION" D  Q
"RTN","MAGBRTE4",78,0)
 . . . . D LOG("Image "_IMAGE_" has no files associated with it")
"RTN","MAGBRTE4",79,0)
 . . . . Q
"RTN","MAGBRTE4",80,0)
 . . . D LOG("*** EVAL queue error: "_STATUS_" ***")
"RTN","MAGBRTE4",81,0)
 . . . Q
"RTN","MAGBRTE4",82,0)
 . . K ^MAGQUEUE(2006.03,QPTR)
"RTN","MAGBRTE4",83,0)
 . . K:'CONS ^MAGQUEUE(2006.03,"B","EVAL",QPTR)
"RTN","MAGBRTE4",84,0)
 . . K:CONS ^MAGQUEUE(2006.03,"C",PLACE,"EVAL",QPTR)
"RTN","MAGBRTE4",85,0)
 . . S $P(^MAGQUEUE(2006.03,0),"^",4)=$P(^MAGQUEUE(2006.03,0),"^",4)-1
"RTN","MAGBRTE4",86,0)
 . . Q
"RTN","MAGBRTE4",87,0)
 . H:'ANY 1
"RTN","MAGBRTE4",88,0)
 . Q
"RTN","MAGBRTE4",89,0)
 L -^MAGDICOM(2006.563,1,"EVAL",LOCATION)
"RTN","MAGBRTE4",90,0)
 Q
"RTN","MAGBRTE4",91,0)
 ;
"RTN","MAGBRTE4",92,0)
LOG(X) N D,H,I,M,T
"RTN","MAGBRTE4",93,0)
 S I=$O(^XTMP("MAGEVAL",ZTSK," "),-1)+1
"RTN","MAGBRTE4",94,0)
 S D=$P("Thu Fri Sat Sun Mon Tue Wed"," ",$H#7+1)
"RTN","MAGBRTE4",95,0)
 S T=$P($H,",",2),H=T\3600,M=T\60#60 S:H<10 H=0_H S:M<10 M=0_M
"RTN","MAGBRTE4",96,0)
 S ^XTMP("MAGEVAL",ZTSK,I)=D_" "_H_":"_M_" "_X
"RTN","MAGBRTE4",97,0)
 Q
"RTN","MAGBRTE4",98,0)
 ;
"RTN","MAGBRTE4",99,0)
RULES() ; To be called from above
"RTN","MAGBRTE4",100,0)
 ; IMAGE ;---- IEN for image (2005)
"RTN","MAGBRTE4",101,0)
 ; LOCATION ;- Location from which queue entry originates
"RTN","MAGBRTE4",102,0)
 N ACTION ;--- Action to be taken (SEND)
"RTN","MAGBRTE4",103,0)
 N C ;-------- Loop-variable for looping through parameters and conditions
"RTN","MAGBRTE4",104,0)
 N D ;-------- Data type
"RTN","MAGBRTE4",105,0)
 N DS ;------- Data type enclosed in space-characters
"RTN","MAGBRTE4",106,0)
 N F ;-------- ...
"RTN","MAGBRTE4",107,0)
 N METMSG ;--- Message to be issued when rule is evaluated
"RTN","MAGBRTE4",108,0)
 N O ;-------- Operator
"RTN","MAGBRTE4",109,0)
 N OK ;------- Flag: indicates whether or not rule is met
"RTN","MAGBRTE4",110,0)
 N RDT ;------ Current date (don't use DT, process might run over midnight)
"RTN","MAGBRTE4",111,0)
 N V ;-------- Value for property as specified in rule
"RTN","MAGBRTE4",112,0)
 N VAL ;------ Actual value of property
"RTN","MAGBRTE4",113,0)
 N VRS ;------ String of Queue Entry numbers when rule(s) are met
"RTN","MAGBRTE4",114,0)
 N X ;-------- Scratch variable
"RTN","MAGBRTE4",115,0)
 ;
"RTN","MAGBRTE4",116,0)
 S VRS=""
"RTN","MAGBRTE4",117,0)
 ;
"RTN","MAGBRTE4",118,0)
 D KEYWORD^MAGBRTE5
"RTN","MAGBRTE4",119,0)
 ;
"RTN","MAGBRTE4",120,0)
 D FILEFIND^MAGDFB(IMAGE,"FULL",0,0,.MAGFILE1)
"RTN","MAGBRTE4",121,0)
 Q:MAGFILE1<0 MAGFILE1
"RTN","MAGBRTE4",122,0)
 ;
"RTN","MAGBRTE4",123,0)
 S RULE=0 F  S RULE=$O(RULE(RULE)) Q:'RULE  D
"RTN","MAGBRTE4",124,0)
 . S METMSG=$G(RULE(RULE,"ACTION"))
"RTN","MAGBRTE4",125,0)
 . S X=" (",C=0 F  S C=$O(RULE(RULE,"ACTION",C)) Q:'C  D
"RTN","MAGBRTE4",126,0)
 . . S METMSG=METMSG_X_$G(RULE(RULE,"ACTION",C)),X=", "
"RTN","MAGBRTE4",127,0)
 . . Q
"RTN","MAGBRTE4",128,0)
 . S:X'=" (" METMSG=METMSG_")"
"RTN","MAGBRTE4",129,0)
 . S:METMSG="" METMSG="Rule #"_RULE
"RTN","MAGBRTE4",130,0)
 . S OK=1,C=0 F  S C=$O(RULE(RULE,"CONDITION",C)) Q:'C  D  Q:'OK
"RTN","MAGBRTE4",131,0)
 . . S F=$G(RULE(RULE,"CONDITION",C,"KW")) Q:F=""
"RTN","MAGBRTE4",132,0)
 . . S X=$G(KEYWORD("CONDITION",F),"^DICOM^MAGBRTE3(F,""OUT"",.VAL)")
"RTN","MAGBRTE4",133,0)
 . . K VAL D @$P(X,"^",2,9)
"RTN","MAGBRTE4",134,0)
 . . ; If the field is not defined, the test passes...
"RTN","MAGBRTE4",135,0)
 . . Q:$D(VAL)'=1  ; We won't deal with multiple values just yet...
"RTN","MAGBRTE4",136,0)
 . . ;
"RTN","MAGBRTE4",137,0)
 . . S V=$G(RULE(RULE,"CONDITION",C,"VA"))
"RTN","MAGBRTE4",138,0)
 . . S D=$G(RULE(RULE,"CONDITION",C,"DT"))
"RTN","MAGBRTE4",139,0)
 . . S O=$G(RULE(RULE,"CONDITION",C,"OP"))
"RTN","MAGBRTE4",140,0)
 . . S:D="" D="S"
"RTN","MAGBRTE4",141,0)
 . . S DS=" "_D_" "
"RTN","MAGBRTE4",142,0)
 . . D:" S CS DS IS LO LT OB OW PN SH ST "[DS
"RTN","MAGBRTE4",143,0)
 . . . N WILD ;-- Wildcard to be matched
"RTN","MAGBRTE4",144,0)
 . . . S WILD=$$WLDMATCH(VAL,V)
"RTN","MAGBRTE4",145,0)
 . . . I O="=",'WILD S OK=0 Q
"RTN","MAGBRTE4",146,0)
 . . . I O="!=",WILD S OK=0 Q
"RTN","MAGBRTE4",147,0)
 . . . Q
"RTN","MAGBRTE4",148,0)
 . . D:" DT DA TM "[DS
"RTN","MAGBRTE4",149,0)
 . . . Q:O'="="  ; Only "within range" comparisons allowed currently
"RTN","MAGBRTE4",150,0)
 . . . ;
"RTN","MAGBRTE4",151,0)
 . . . N A ;--- Flag: indicates whether at least one time-frame matches
"RTN","MAGBRTE4",152,0)
 . . . N B ;--- Begin date/time
"RTN","MAGBRTE4",153,0)
 . . . N E ;--- End date/time
"RTN","MAGBRTE4",154,0)
 . . . N %H ;-- FileMan API parameter value -- date
"RTN","MAGBRTE4",155,0)
 . . . N I ;--- Loopcounter
"RTN","MAGBRTE4",156,0)
 . . . N M ;--- Date/time mask
"RTN","MAGBRTE4",157,0)
 . . . N N ;--- Loopcounter (time-frames)
"RTN","MAGBRTE4",158,0)
 . . . N %T ;-- FileMan internal variable
"RTN","MAGBRTE4",159,0)
 . . . N VV ;-- Actual value
"RTN","MAGBRTE4",160,0)
 . . . N WD ;-- Weekday
"RTN","MAGBRTE4",161,0)
 . . . N X1 ;-- FileMan API parameter value -- date
"RTN","MAGBRTE4",162,0)
 . . . N X2 ;-- FileMan API parameter value -- date
"RTN","MAGBRTE4",163,0)
 . . . ;
"RTN","MAGBRTE4",164,0)
 . . . ; convert the literal date/time field into the format for comparison
"RTN","MAGBRTE4",165,0)
 . . . S VV=VAL
"RTN","MAGBRTE4",166,0)
 . . . ;
"RTN","MAGBRTE4",167,0)
 . . . S (A,N)=0 F  S N=$O(RULE(RULE,"CONDITION",C,"VA",N)) Q:'N  D
"RTN","MAGBRTE4",168,0)
 . . . . N T,VB,VC,VE
"RTN","MAGBRTE4",169,0)
 . . . . S M=$G(RULE(RULE,"CONDITION",C,"VA",N,"M"))
"RTN","MAGBRTE4",170,0)
 . . . . S B=$G(RULE(RULE,"CONDITION",C,"VA",N,"B"))
"RTN","MAGBRTE4",171,0)
 . . . . S E=$G(RULE(RULE,"CONDITION",C,"VA",N,"E"))
"RTN","MAGBRTE4",172,0)
 . . . . S T=1
"RTN","MAGBRTE4",173,0)
 . . . . I $E(M,1,3)="HOL" S:$$GET1^DIQ(40.5,+$E(VV,5,11),.01)="" T=0 ; IA 10038
"RTN","MAGBRTE4",174,0)
 . . . . I $E(M,1,3)="DDD",$E(B,1,3)'=$E(VAL,1,3) S T=0
"RTN","MAGBRTE4",175,0)
 . . . . S (VB,VC,VE)=""
"RTN","MAGBRTE4",176,0)
 . . . . F I=4:1:$L(M) S:$E(M,I)?1U VC=VC_$E(VV,I),VB=VB_$E(B,I),VE=VE_$E(E,I)
"RTN","MAGBRTE4",177,0)
 . . . . S:VB>VC T=0
"RTN","MAGBRTE4",178,0)
 . . . . S:VE<VC T=0
"RTN","MAGBRTE4",179,0)
 . . . . S:T A=1
"RTN","MAGBRTE4",180,0)
 . . . . Q
"RTN","MAGBRTE4",181,0)
 . . . S:'A OK=0
"RTN","MAGBRTE4",182,0)
 . . . Q
"RTN","MAGBRTE4",183,0)
 . . Q
"RTN","MAGBRTE4",184,0)
 . S METMSG(OK,METMSG)=""
"RTN","MAGBRTE4",185,0)
 . D NOW^%DTC S RDT=%\1
"RTN","MAGBRTE4",186,0)
 . Q:'OK
"RTN","MAGBRTE4",187,0)
 . S ACTION=$G(RULE(RULE,"ACTION"))
"RTN","MAGBRTE4",188,0)
 . Q:ACTION=""
"RTN","MAGBRTE4",189,0)
 . I ACTION="SEND" D  Q
"RTN","MAGBRTE4",190,0)
 . . N %,D,PRI,X
"RTN","MAGBRTE4",191,0)
 . . S X=$G(RULE(RULE,"ACTION",1))
"RTN","MAGBRTE4",192,0)
 . . I X="" S METMSG(0,"No location for rule "_RULE)="" Q
"RTN","MAGBRTE4",193,0)
 . . D VALDEST^MAGDRPC1(.D,X)
"RTN","MAGBRTE4",194,0)
 . . I D<0 S METMSG(0,"Cannot find location """_X_""".")="" Q
"RTN","MAGBRTE4",195,0)
 . . S PRI=$$PRI($G(RULE(RULE,"PRIORITY")),IMAGE)
"RTN","MAGBRTE4",196,0)
 . . S VRS=VRS_$$SEND^MAGBRTUT(IMAGE,D,PRI,1,LOCATION)
"RTN","MAGBRTE4",197,0)
 . . Q
"RTN","MAGBRTE4",198,0)
 . I ACTION="DICOM" D  Q
"RTN","MAGBRTE4",199,0)
 . . N %,D,PRI,X
"RTN","MAGBRTE4",200,0)
 . . S X=$G(RULE(RULE,"ACTION",1))
"RTN","MAGBRTE4",201,0)
 . . I X="" S METMSG(0,"No location for rule "_RULE)="" Q
"RTN","MAGBRTE4",202,0)
 . . S D=$O(^MAG(2006.587,"B",X,""))
"RTN","MAGBRTE4",203,0)
 . . I D="" S METMSG(0,"Cannot find location """_X_""".")="" Q
"RTN","MAGBRTE4",204,0)
 . . S PRI=$$PRI($G(RULE(RULE,"PRIORITY")),IMAGE)
"RTN","MAGBRTE4",205,0)
 . . S VRS=VRS_$$SEND^MAGBRTUT(IMAGE,D,PRI,2,LOCATION)
"RTN","MAGBRTE4",206,0)
 . . Q
"RTN","MAGBRTE4",207,0)
 . I ACTION="BALANCE" D BALANCE^MAGBRTE5(IMAGE,.RULE) Q
"RTN","MAGBRTE4",208,0)
 . ;
"RTN","MAGBRTE4",209,0)
 . ; Other actions to be inserted here...
"RTN","MAGBRTE4",210,0)
 . ;
"RTN","MAGBRTE4",211,0)
 . Q
"RTN","MAGBRTE4",212,0)
 ;
"RTN","MAGBRTE4",213,0)
 ; Note: we may have:
"RTN","MAGBRTE4",214,0)
 ;    Rule 1: If CR, send to XXX
"RTN","MAGBRTE4",215,0)
 ;    Rule 2: If CT, send to XXX
"RTN","MAGBRTE4",216,0)
 ; For a CR, this would cause an entry of
"RTN","MAGBRTE4",217,0)
 ;    METMSG(0,"SEND(XXX)") for rule 2
"RTN","MAGBRTE4",218,0)
 ; and an entry of
"RTN","MAGBRTE4",219,0)
 ;    METMSG(1,"SEND(XXX)") for rule 1
"RTN","MAGBRTE4",220,0)
 ; and for a CT it would be the other way around.
"RTN","MAGBRTE4",221,0)
 ; So, first remove all "failed" entries that were successful
"RTN","MAGBRTE4",222,0)
 ; for a different rule.
"RTN","MAGBRTE4",223,0)
 ;
"RTN","MAGBRTE4",224,0)
 S X="" F  S X=$O(METMSG(1,X)) Q:X=""  D
"RTN","MAGBRTE4",225,0)
 . D LOG("Image "_IMAGE_": "_X)
"RTN","MAGBRTE4",226,0)
 . K METMSG(0,X)
"RTN","MAGBRTE4",227,0)
 . Q
"RTN","MAGBRTE4",228,0)
 S X="" F  S X=$O(METMSG(0,X)) Q:X=""  D
"RTN","MAGBRTE4",229,0)
 . D LOG("Image "_IMAGE_": Do not "_X)
"RTN","MAGBRTE4",230,0)
 . Q
"RTN","MAGBRTE4",231,0)
 Q VRS
"RTN","MAGBRTE4",232,0)
 ;
"RTN","MAGBRTE4",233,0)
 ;
"RTN","MAGBRTE4",234,0)
PRI(PRI,IMAGE) N C,D0,D1,D2,O,P,R,X
"RTN","MAGBRTE4",235,0)
 S PRI=$S(PRI="HIGH":750,PRI="NORMAL":500,PRI="LOW":250,1:500)
"RTN","MAGBRTE4",236,0)
 S X=$G(^MAG(2005,IMAGE,2))
"RTN","MAGBRTE4",237,0)
 S P=$P(X,"^",6) Q:P'=74 PRI
"RTN","MAGBRTE4",238,0)
 S R=$P(X,"^",7) Q:'R PRI
"RTN","MAGBRTE4",239,0)
 S C=$P($G(^RARPT(R,0)),"^",1) Q:C="" PRI  ; IA 1171
"RTN","MAGBRTE4",240,0)
 S D0=$O(^RADPT("ADC",C,"")) Q:'D0 PRI  ; IA 1172
"RTN","MAGBRTE4",241,0)
 S D1=$O(^RADPT("ADC",C,D0,"")) Q:'D1 PRI  ; IA 1172
"RTN","MAGBRTE4",242,0)
 S D2=$O(^RADPT("ADC",C,D0,D1,"")) Q:'D2 PRI  ; IA 1172
"RTN","MAGBRTE4",243,0)
 S O=$P($G(^RADPT(D0,"DT",D1,"P",D2,0)),"^",11) Q:'O PRI  ; IA 1172
"RTN","MAGBRTE4",244,0)
 S X=$P($G(^RAO(75.1,O,0)),"^",6) ; IA 3074
"RTN","MAGBRTE4",245,0)
 Q PRI+$S(X=1:20,X=2:10,1:0)
"RTN","MAGBRTE4",246,0)
 ;
"RTN","MAGBRTE4",247,0)
WLDMATCH(VAL,WILD) ;
"RTN","MAGBRTE4",248,0)
 ;
"RTN","MAGBRTE4",249,0)
 ; Returns true if VAL=WILD (Val=Actual value, Wild=Wildcard)
"RTN","MAGBRTE4",250,0)
 ;
"RTN","MAGBRTE4",251,0)
 ; Wild characters are:
"RTN","MAGBRTE4",252,0)
 ;   ?   matches any single character
"RTN","MAGBRTE4",253,0)
 ;   *   matches any string of characters
"RTN","MAGBRTE4",254,0)
 ;
"RTN","MAGBRTE4",255,0)
 N I,M
"RTN","MAGBRTE4",256,0)
 F  Q:VAL=""  Q:WILD=""  D
"RTN","MAGBRTE4",257,0)
 . I $E(VAL,1)=$E(WILD,1) S VAL=$E(VAL,2,$L(VAL)),WILD=$E(WILD,2,$L(WILD)) Q
"RTN","MAGBRTE4",258,0)
 . I $E(WILD,1)="?" S VAL=$E(VAL,2,$L(VAL)),WILD=$E(WILD,2,$L(WILD)) Q
"RTN","MAGBRTE4",259,0)
 . I $E(WILD,1)="*" D  Q:M
"RTN","MAGBRTE4",260,0)
 . . I WILD="*" S (VAL,WILD)="",M=1 Q
"RTN","MAGBRTE4",261,0)
 . . S WILD=$E(WILD,2,$L(WILD)),M=0
"RTN","MAGBRTE4",262,0)
 . . F I=1:1:$L(VAL) I $$WLDMATCH($E(VAL,I,$L(VAL)),WILD) S M=1,VAL=$E(VAL,I,$L(VAL)) Q
"RTN","MAGBRTE4",263,0)
 . . Q
"RTN","MAGBRTE4",264,0)
 . S VAL="!",WILD=""
"RTN","MAGBRTE4",265,0)
 . Q
"RTN","MAGBRTE4",266,0)
 Q:VAL'="" 0 Q:WILD'="" 0 Q 1
"RTN","MAGBRTE4",267,0)
 ;
"RTN","MAGBRTE5")
0^3^B56261952
"RTN","MAGBRTE5",1,0)
MAGBRTE5 ;WOIFO/PMK - Background Routing - Load Balance ; 05/06/2004  06:32
"RTN","MAGBRTE5",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGBRTE5",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE5",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTE5",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTE5",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTE5",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTE5",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTE5",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTE5",10,0)
 ;; |                                                               |
"RTN","MAGBRTE5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTE5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTE5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTE5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTE5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTE5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTE5",17,0)
 ;;
"RTN","MAGBRTE5",18,0)
 Q
"RTN","MAGBRTE5",19,0)
 ;
"RTN","MAGBRTE5",20,0)
BALANCE(IMAGE,RULE) N %,D,DEST,PARENT,PRI,X
"RTN","MAGBRTE5",21,0)
 S PARENT=$P(^MAG(2005,IMAGE,0),"^",10) ; ~~~
"RTN","MAGBRTE5",22,0)
 D:'$D(^MAGRT(2006.5906,RULE,1,PARENT))
"RTN","MAGBRTE5",23,0)
 . N CP,M1,M2,MAX,B,E,L,RD,T
"RTN","MAGBRTE5",24,0)
 . ;
"RTN","MAGBRTE5",25,0)
 . L +^MAGRT(2006.5906,0):1E9 ; Background task must wait for lock
"RTN","MAGBRTE5",26,0)
 . ;
"RTN","MAGBRTE5",27,0)
 . ; Clean up old info
"RTN","MAGBRTE5",28,0)
 . ; Allow for a study to cross one day boundary,
"RTN","MAGBRTE5",29,0)
 . ; and remove everything that is older than a day.
"RTN","MAGBRTE5",30,0)
 . ;
"RTN","MAGBRTE5",31,0)
 . S RD=RDT-1 F  S RD=$O(^MAGRT(2006.5906,"D",RD),-1) Q:'RD  D
"RTN","MAGBRTE5",32,0)
 . . N DE,RU,PA
"RTN","MAGBRTE5",33,0)
 . . S DE="" F  S DE=$O(^MAGRT(2006.5906,"D",RD,DE)) Q:DE=""  D
"RTN","MAGBRTE5",34,0)
 . . . S RU="" F  S RU=$O(^MAGRT(2006.5906,"D",RD,DE,RU)) Q:RU=""  D
"RTN","MAGBRTE5",35,0)
 . . . . S PA="" F  S PA=$O(^MAGRT(2006.5906,"D",RD,DE,RU,PA)) Q:PA=""  D
"RTN","MAGBRTE5",36,0)
 . . . . . K ^MAGRT(2006.5906,"D",RD,DE,RU,PA)
"RTN","MAGBRTE5",37,0)
 . . . . . K ^MAGRT(2006.5906,RU,1,PA)
"RTN","MAGBRTE5",38,0)
 . . . . . S X=^MAGRT(2006.5906,RU,1,0)
"RTN","MAGBRTE5",39,0)
 . . . . . S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGBRTE5",40,0)
 . . . . . S ^MAGRT(2006.5906,RU,1,0)=X
"RTN","MAGBRTE5",41,0)
 . . . . . Q
"RTN","MAGBRTE5",42,0)
 . . . . Q
"RTN","MAGBRTE5",43,0)
 . . . Q
"RTN","MAGBRTE5",44,0)
 . . Q
"RTN","MAGBRTE5",45,0)
 . ;
"RTN","MAGBRTE5",46,0)
 . D:'$D(^MAGRT(2006.5906,RULE))
"RTN","MAGBRTE5",47,0)
 . . S X=$G(^MAGRT(2006.5906,0))
"RTN","MAGBRTE5",48,0)
 . . S $P(X,"^",1,2)="ROUTE LOAD BALANCE^2006.5906"
"RTN","MAGBRTE5",49,0)
 . . S:RULE>$P(X,"^",3) $P(X,"^",3)=RULE
"RTN","MAGBRTE5",50,0)
 . . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGBRTE5",51,0)
 . . S:RULE>$P(X,"^",3) $P(X,"^",3)=RULE
"RTN","MAGBRTE5",52,0)
 . . S ^MAGRT(2006.5906,0)=X
"RTN","MAGBRTE5",53,0)
 . . S ^MAGRT(2006.5906,RULE,0)=RULE
"RTN","MAGBRTE5",54,0)
 . . Q
"RTN","MAGBRTE5",55,0)
 . ;
"RTN","MAGBRTE5",56,0)
 . M CP=^MAGRT(2006.5906,"D",RDT)
"RTN","MAGBRTE5",57,0)
 . S (B,DEST,L,M1,M2,MAX)=0
"RTN","MAGBRTE5",58,0)
 . F  S DEST=$O(RULE(RULE,"ACTION",DEST)) Q:'DEST  D
"RTN","MAGBRTE5",59,0)
 . . N I,T
"RTN","MAGBRTE5",60,0)
 . . S B=B+1,B(B)=DEST
"RTN","MAGBRTE5",61,0)
 . . S X=RULE(RULE,"ACTION",DEST)
"RTN","MAGBRTE5",62,0)
 . . S M(B)=$P(X,"^",2),MAX=MAX+M(B)
"RTN","MAGBRTE5",63,0)
 . . ; Don't exceed maximum number of studies per day days
"RTN","MAGBRTE5",64,0)
 . . S T=0,I="" F  S I=$O(CP(DEST,I)) Q:I=""  S T=T+1
"RTN","MAGBRTE5",65,0)
 . . I $P(X,"^",3),T'<$P(X,"^",3) S M2=M2+M(B),M(B)=-1,M1=M1+1
"RTN","MAGBRTE5",66,0)
 . . Q
"RTN","MAGBRTE5",67,0)
 . ; If one destination has reached its cap, redistribute...
"RTN","MAGBRTE5",68,0)
 . D:M1
"RTN","MAGBRTE5",69,0)
 . . N I,L,R
"RTN","MAGBRTE5",70,0)
 . . S R=M2#M1,L=0
"RTN","MAGBRTE5",71,0)
 . . F I=1:1:B S:M(I)>0 M(I)=M2\M1+M(I),L=I
"RTN","MAGBRTE5",72,0)
 . . S M(L)=M(L)+R
"RTN","MAGBRTE5",73,0)
 . . Q
"RTN","MAGBRTE5",74,0)
 . ;
"RTN","MAGBRTE5",75,0)
 . S X=$G(^MAGRT(2006.5906,RULE,2))
"RTN","MAGBRTE5",76,0)
 . ; X = LAST ^ TOTAL ^ COUNT(DEST) ^ COUNT(DEST) ^ ...
"RTN","MAGBRTE5",77,0)
 . F L=1:1:B S E(L)=+$P(X,"^",L+2)
"RTN","MAGBRTE5",78,0)
 . S L=$P(X,"^",1) F  S L=L+1 S:L>B L=1 Q:E(L)<M(L)
"RTN","MAGBRTE5",79,0)
 . S T=$P(X,"^",2)+1,E(L)=E(L)+1,DEST=B(L)
"RTN","MAGBRTE5",80,0)
 . I T'<MAX S T=0 F L=1:1:B S E(L)=0
"RTN","MAGBRTE5",81,0)
 . S X=L_"^"_T F L=1:1:B S X=X_"^"_E(L)
"RTN","MAGBRTE5",82,0)
 . S ^MAGRT(2006.5906,RULE,2)=X
"RTN","MAGBRTE5",83,0)
 . ;
"RTN","MAGBRTE5",84,0)
 . ; Note: on consolidated sites 'origins' and 'destinations'
"RTN","MAGBRTE5",85,0)
 . ; matter even more than on non-consolidated ones.
"RTN","MAGBRTE5",86,0)
 . ; In the case of load-balancing, however, the 'destinations'
"RTN","MAGBRTE5",87,0)
 . ; part is taken care of by the balancing parameters, and the
"RTN","MAGBRTE5",88,0)
 . ; origin is moot, because each study has one (and only one)
"RTN","MAGBRTE5",89,0)
 . ; origin.
"RTN","MAGBRTE5",90,0)
 . ;
"RTN","MAGBRTE5",91,0)
 . D:'$D(^MAGRT(2006.5906,RULE,1,PARENT))
"RTN","MAGBRTE5",92,0)
 . . S X=$G(^MAGRT(2006.5906,RULE,1,0))
"RTN","MAGBRTE5",93,0)
 . . S $P(X,"^",1,2)="^2006.59061"
"RTN","MAGBRTE5",94,0)
 . . S:PARENT>$P(X,"^",3) $P(X,"^",3)=PARENT
"RTN","MAGBRTE5",95,0)
 . . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGBRTE5",96,0)
 . . S ^MAGRT(2006.5906,RULE,1,0)=X
"RTN","MAGBRTE5",97,0)
 . . S ^MAGRT(2006.5906,RULE,1,PARENT,0)=PARENT_"^"_RDT_"^"_DEST
"RTN","MAGBRTE5",98,0)
 . . Q
"RTN","MAGBRTE5",99,0)
 . L -^MAGRT(2006.5906,0)
"RTN","MAGBRTE5",100,0)
 . Q
"RTN","MAGBRTE5",101,0)
 S DEST=$P(^MAGRT(2006.5906,RULE,1,PARENT,0),"^",3)
"RTN","MAGBRTE5",102,0)
 S X=$G(RULE(RULE,"ACTION",DEST))
"RTN","MAGBRTE5",103,0)
 I X="" S METMSG(0,"No location for rule "_RULE_", alternative "_DEST)="" Q
"RTN","MAGBRTE5",104,0)
 S X=$P(X,"^",1) Q:X="<LOCAL>"
"RTN","MAGBRTE5",105,0)
 S DEST=0
"RTN","MAGBRTE5",106,0)
 S D=0 F  S D=$O(RULE(RULE,"ACTION",D)) Q:'D  D  Q:DEST
"RTN","MAGBRTE5",107,0)
 . Q:$P($G(RULE(RULE,"ACTION",D)),"^",1)'=X
"RTN","MAGBRTE5",108,0)
 . S DEST=D
"RTN","MAGBRTE5",109,0)
 . Q
"RTN","MAGBRTE5",110,0)
 I 'DEST S METMSG(0,"Cannot find location """_X_""".")="" Q
"RTN","MAGBRTE5",111,0)
 S ^MAGRT(2006.5906,"D",RDT,DEST,RULE,PARENT)=""
"RTN","MAGBRTE5",112,0)
 ;
"RTN","MAGBRTE5",113,0)
 ; Current version assumes that BALANCE means DOS-Copy, not DICOM...
"RTN","MAGBRTE5",114,0)
 D VALDEST^MAGDRPC1(.DEST,X)
"RTN","MAGBRTE5",115,0)
 D LOG^MAGBRTE4("Load-Balance Destination is "_X)
"RTN","MAGBRTE5",116,0)
 S PRI=$$PRI^MAGBRTE4($G(RULE(RULE,"PRIORITY")),IMAGE)
"RTN","MAGBRTE5",117,0)
 S VRS=VRS_$$SEND^MAGBRTUT(IMAGE,DEST,PRI,1,LOCATION)
"RTN","MAGBRTE5",118,0)
 Q
"RTN","MAGBRTE5",119,0)
 ;
"RTN","MAGBRTE5",120,0)
KEYWORD ; build the KEYWORD array
"RTN","MAGBRTE5",121,0)
 N C,CD,D,D0,KW,M,V,X
"RTN","MAGBRTE5",122,0)
 S CD="CONDITION" K KEYWORD
"RTN","MAGBRTE5",123,0)
 ; Actions
"RTN","MAGBRTE5",124,0)
 F X="SEND","BALANCE","DICOM" S KEYWORD("ACTION",X)="-"
"RTN","MAGBRTE5",125,0)
 F X="DESTINATION","HOLIDAY" S KEYWORD("ACTION",X)="I"
"RTN","MAGBRTE5",126,0)
 ;
"RTN","MAGBRTE5",127,0)
 F X="HIGH","NORMAL","LOW" S KEYWORD("PRIORITY",X)="-"
"RTN","MAGBRTE5",128,0)
 ;
"RTN","MAGBRTE5",129,0)
 ; Fields in ^MAG(2005,
"RTN","MAGBRTE5",130,0)
 S M="LO^MAG^MAGBRTE3(IMAGE,"
"RTN","MAGBRTE5",131,0)
 S KEYWORD(CD,"OBJECT NAME")=M_"0,0,1,.VAL)"
"RTN","MAGBRTE5",132,0)
 S KEYWORD(CD,"FILE_REF")=M_"0,0,2,.VAL)"
"RTN","MAGBRTE5",133,0)
 S KEYWORD(CD,"MAGNETIC_REF")=M_"0,0,3,.VAL)"
"RTN","MAGBRTE5",134,0)
 S KEYWORD(CD,"ABSTRACT_REF")=M_"0,0,4,.VAL)"
"RTN","MAGBRTE5",135,0)
 S KEYWORD(CD,"WORM_REF")=M_"0,0,5,.VAL)"
"RTN","MAGBRTE5",136,0)
 S KEYWORD(CD,"OBJECT_TYPE")=M_"2005.02,0,6,.VAL)"
"RTN","MAGBRTE5",137,0)
 S KEYWORD(CD,"PATIENT")=M_"2,0,7,.VAL)"
"RTN","MAGBRTE5",138,0)
 S KEYWORD(CD,"PROCEDURE")=M_"0,0,8,.VAL)"
"RTN","MAGBRTE5",139,0)
 S KEYWORD(CD,"MODALITY")=M_"0,0,8,.VAL)"
"RTN","MAGBRTE5",140,0)
 S KEYWORD(CD,"SAVED_BY")=M_"200,2,2,.VAL)"
"RTN","MAGBRTE5",141,0)
 S KEYWORD(CD,"SUMMARY_OBJECT")=M_"0,2,3,.VAL)"
"RTN","MAGBRTE5",142,0)
 S KEYWORD(CD,"SHORT_DESCRIPTION")=M_"0,2,4,.VAL)"
"RTN","MAGBRTE5",143,0)
 S KEYWORD(CD,"PARENT_DATA")=M_"2005.03,2,6,.VAL)"
"RTN","MAGBRTE5",144,0)
 S KEYWORD(CD,"PARENT_GLOBAL_ROOT_D0")=M_"0,2,7,.VAL)"
"RTN","MAGBRTE5",145,0)
 S KEYWORD(CD,"PARENT_DATA_FILE_IMAGE_POINTER")=M_"0,2,8,.VAL)"
"RTN","MAGBRTE5",146,0)
 S KEYWORD(CD,"EXPORT_REQUEST_STATUS")=M_"0,2,9,.VAL)"
"RTN","MAGBRTE5",147,0)
 S KEYWORD(CD,"PATH_ACCESSION_NUMBER")=M_"0,""PATH"",1,.VAL)"
"RTN","MAGBRTE5",148,0)
 S KEYWORD(CD,"SPECIMEN_DESCRIPTION")=M_"0,""PATH"",2,.VAL)"
"RTN","MAGBRTE5",149,0)
 S KEYWORD(CD,"SPECIMEN")=M_"0,""PATH"",3,.VAL)"
"RTN","MAGBRTE5",150,0)
 S KEYWORD(CD,"STAIN")=M_"0,""PATH"",4,.VAL)"
"RTN","MAGBRTE5",151,0)
 S KEYWORD(CD,"MICROSCOPIC_OBJECTIVE")=M_"0,""PATH"",5,.VAL)"
"RTN","MAGBRTE5",152,0)
 S KEYWORD(CD,"PACS_UID")=M_"0,""PACS"",1,.VAL)"
"RTN","MAGBRTE5",153,0)
 S KEYWORD(CD,"RADIOLOGY_REPORT")=M_"74,""PACS"",2,.VAL)"
"RTN","MAGBRTE5",154,0)
 S KEYWORD(CD,"PACS_PROCEDURE")=M_"71,""PACS"",3,.VAL)"
"RTN","MAGBRTE5",155,0)
 S KEYWORD(CD,"PARENT_GLOBAL_ROOT_D1")=M_"0,2,10,.VAL)"
"RTN","MAGBRTE5",156,0)
 S KEYWORD(CD,"DESCRIPTIVE_CATEGORY")=M_"2005.81,100,1,.VAL)"
"RTN","MAGBRTE5",157,0)
 S KEYWORD(CD,"CLINIC")=M_"44,100,2,.VAL)"
"RTN","MAGBRTE5",158,0)
 S KEYWORD(CD,"BIG_MAGNETIC_PATH")=M_"2005.2,""FBIG"",1,.VAL)"
"RTN","MAGBRTE5",159,0)
 S KEYWORD(CD,"BIG_JUKEBOX_PATH")=M_"2005.2,""FBIG"",2,.VAL)"
"RTN","MAGBRTE5",160,0)
 ; Date and time fields
"RTN","MAGBRTE5",161,0)
 S M="DT^MAG^MAGBRTE3(IMAGE,"
"RTN","MAGBRTE5",162,0)
 S KEYWORD(CD,"IMAGE_SAVED")=M_"0,2,1,.VAL)"
"RTN","MAGBRTE5",163,0)
 S KEYWORD(CD,"LAST_ACCESS")=M_"0,0,9,.VAL)"
"RTN","MAGBRTE5",164,0)
 S KEYWORD(CD,"PROCEDURE_TIME")=M_"0,2,5,.VAL)"
"RTN","MAGBRTE5",165,0)
 S KEYWORD(CD,"EXAM_TIME")=M_"0,2,5,.VAL)"
"RTN","MAGBRTE5",166,0)
 ;
"RTN","MAGBRTE5",167,0)
 S M="DT^DATE^MAGBRTE3(IMAGE,"
"RTN","MAGBRTE5",168,0)
 S KEYWORD(CD,"IMAGE_SAVED_FIRST")=M_"0,2,1,1,.VAL)"
"RTN","MAGBRTE5",169,0)
 S KEYWORD(CD,"LAST_ACCESS_FIRST")=M_"0,0,9,1,.VAL)"
"RTN","MAGBRTE5",170,0)
 S KEYWORD(CD,"PROCEDURE_TIME_FIRST")=M_"0,2,5,1,.VAL)"
"RTN","MAGBRTE5",171,0)
 S KEYWORD(CD,"EXAM_TIME_FIRST")=M_"0,2,5,1,.VAL)"
"RTN","MAGBRTE5",172,0)
 S KEYWORD(CD,"STUDY_TIME")=M_"0,2,5,1,.VAL)"
"RTN","MAGBRTE5",173,0)
 ;
"RTN","MAGBRTE5",174,0)
 S KEYWORD(CD,"IMAGE_SAVED_LAST")=M_"0,2,1,2,.VAL)"
"RTN","MAGBRTE5",175,0)
 S KEYWORD(CD,"LAST_ACCESS_LAST")=M_"0,0,9,2,.VAL)"
"RTN","MAGBRTE5",176,0)
 S KEYWORD(CD,"PROCEDURE_TIME_LAST")=M_"0,2,5,2,.VAL)"
"RTN","MAGBRTE5",177,0)
 S KEYWORD(CD,"EXAM_TIME_LAST")=M_"0,2,5,2,.VAL)"
"RTN","MAGBRTE5",178,0)
 ;
"RTN","MAGBRTE5",179,0)
 ; Built-in Fields
"RTN","MAGBRTE5",180,0)
 S KEYWORD(CD,"SOURCE")="SH^SOURCE^MAGBRTE3(IMAGE,.VAL)"
"RTN","MAGBRTE5",181,0)
 S KEYWORD(CD,"URGENCY")="SH^URGENCY^MAGBRTE3(IMAGE,.VAL)"
"RTN","MAGBRTE5",182,0)
 S KEYWORD(CD,"NOW")="DT^NOW^MAGBRTE3(.VAL)"
"RTN","MAGBRTE5",183,0)
 Q
"RTN","MAGBRTE5",184,0)
 ;
"RTN","MAGBRTE5",185,0)
VARNAME(F) ;
"RTN","MAGBRTE5",186,0)
 S F=$TR(F," !""#$%&'()*+,-./:;<=>?@[\]^_`{|}~","_________________________________")
"RTN","MAGBRTE5",187,0)
 F  Q:F'["__"  S F=$P(F,"__",1)_"_"_$P(F,"__",2,$L(F)+2)
"RTN","MAGBRTE5",188,0)
 F  Q:$E(F,1)'="_"  S F=$E(F,2,$L(F))
"RTN","MAGBRTE5",189,0)
 F  Q:$E(F,$L(F))'="_"  S F=$E(F,1,$L(F)-1)
"RTN","MAGBRTE5",190,0)
 S F=$TR(F,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGBRTE5",191,0)
 Q F
"RTN","MAGBRTLD")
0^4^B10941757
"RTN","MAGBRTLD",1,0)
MAGBRTLD ;WOIFO/EdM - List of destinations ; 06/29/2004  15:01
"RTN","MAGBRTLD",2,0)
 ;;3.0;IMAGING;**9,11,30**;16-September-2004
"RTN","MAGBRTLD",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTLD",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTLD",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTLD",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTLD",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTLD",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTLD",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTLD",10,0)
 ;; |                                                               |
"RTN","MAGBRTLD",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTLD",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTLD",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTLD",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTLD",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTLD",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTLD",17,0)
 ;;
"RTN","MAGBRTLD",18,0)
 Q
"RTN","MAGBRTLD",19,0)
 ;
"RTN","MAGBRTLD",20,0)
LIST(TO,LIST) N DEST,N,X
"RTN","MAGBRTLD",21,0)
 S TO=$$UPNOPU(TO),N=0 K LIST
"RTN","MAGBRTLD",22,0)
 ;
"RTN","MAGBRTLD",23,0)
 S DEST="" F  S DEST=$O(^MAG(2005,"ROUTE",DEST)) Q:DEST=""  D
"RTN","MAGBRTLD",24,0)
 . S DEST(DEST)=""
"RTN","MAGBRTLD",25,0)
 . Q
"RTN","MAGBRTLD",26,0)
 ;
"RTN","MAGBRTLD",27,0)
 S DEST="" F  S DEST=$O(DEST(DEST)) Q:DEST=""  D
"RTN","MAGBRTLD",28,0)
 . N PW
"RTN","MAGBRTLD",29,0)
 . S PW=$P($G(^MAG(2005.2,DEST,2)),"^",1,2)
"RTN","MAGBRTLD",30,0)
 . S $P(PW,"^",2)=$$DECRYP^MAGDRPC2($P(PW,"^",2))
"RTN","MAGBRTLD",31,0)
 . S X=$G(^MAG(2005.2,DEST,0))
"RTN","MAGBRTLD",32,0)
 . Q:$$UPNOPU($P(X,"^",1))'[TO
"RTN","MAGBRTLD",33,0)
 . S N=N+1,LIST(N)=$P(X,"^",2)_"^"_$P($G(^MAG(2005.2,DEST,4)),"^",2)_"^"_$P(X,"^",8)_"^"_PW_"^"_$P($G(^MAG(2005.2,DEST,3)),"^",5)_"^"_DEST
"RTN","MAGBRTLD",34,0)
 . Q
"RTN","MAGBRTLD",35,0)
 S LIST=N
"RTN","MAGBRTLD",36,0)
 Q
"RTN","MAGBRTLD",37,0)
 ;
"RTN","MAGBRTLD",38,0)
AVERAGE() N A,D0,D1,N,P,X
"RTN","MAGBRTLD",39,0)
 S (A,N)=0
"RTN","MAGBRTLD",40,0)
 S D0=0 F  S D0=$O(^MAGQUEUE(2006.036,D0)) Q:'D0  D
"RTN","MAGBRTLD",41,0)
 . S N=N+1
"RTN","MAGBRTLD",42,0)
 . S D1=0 F  S D1=$O(^MAGQUEUE(2006.036,D0,1,D1)) Q:'D1  D
"RTN","MAGBRTLD",43,0)
 . . S X=$G(^MAGQUEUE(2006.036,D0,1,D1,0)) Q:$P(X,"^",6)'["Duration"
"RTN","MAGBRTLD",44,0)
 . . F P=1:1:4 S A=A+$P(X,"^",P)
"RTN","MAGBRTLD",45,0)
 . . Q
"RTN","MAGBRTLD",46,0)
 . Q
"RTN","MAGBRTLD",47,0)
 Q A/$S(N:N,1:1)
"RTN","MAGBRTLD",48,0)
 ;
"RTN","MAGBRTLD",49,0)
UPNOPU(X) Q $TR(X,"abcdefghijklmnopqrstuvwxyz !""#$%&'()*+,-./:;<=>?@[\]^_`{|}~","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGBRTLD",50,0)
 ;
"RTN","MAGBRTLD",51,0)
PURGSTAT N COUNT,DATE,FIRST,IMAGE,LAST,LOC
"RTN","MAGBRTLD",52,0)
 W !!,"Overview of images to be purged.",!
"RTN","MAGBRTLD",53,0)
 S LOC="" F  S LOC=$O(^MAG(2005,"ROUTE",LOC)) Q:LOC=""  D
"RTN","MAGBRTLD",54,0)
 . S FIRST=$O(^MAG(2005,"ROUTE",LOC,""))\1
"RTN","MAGBRTLD",55,0)
 . S LAST=$O(^MAG(2005,"ROUTE",LOC,""),-1)\1
"RTN","MAGBRTLD",56,0)
 . S COUNT=0
"RTN","MAGBRTLD",57,0)
 . S DATE="" F  S DATE=$O(^MAG(2005,"ROUTE",LOC,DATE)) Q:DATE=""  D
"RTN","MAGBRTLD",58,0)
 . . S IMAGE="" F  S IMAGE=$O(^MAG(2005,"ROUTE",LOC,DATE,IMAGE)) Q:IMAGE=""  S COUNT=COUNT+1
"RTN","MAGBRTLD",59,0)
 . . Q
"RTN","MAGBRTLD",60,0)
 . W !,COUNT," image" W:COUNT'=1 "s"
"RTN","MAGBRTLD",61,0)
 . W " to be purged on ",$P(^MAG(2005.2,LOC,0),"^",2)
"RTN","MAGBRTLD",62,0)
 . W !?5,"(transmitted "
"RTN","MAGBRTLD",63,0)
 . I FIRST=LAST W " on ",$$FMD(FIRST)
"RTN","MAGBRTLD",64,0)
 . E  W " between ",$$FMD(FIRST)," and ",$$FMD(LAST)
"RTN","MAGBRTLD",65,0)
 . W ")"
"RTN","MAGBRTLD",66,0)
 . Q
"RTN","MAGBRTLD",67,0)
 Q
"RTN","MAGBRTLD",68,0)
 ;
"RTN","MAGBRTLD",69,0)
FMD(X) Q (X#100)_" "_$P("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"," ",X\100#100)_" "_(X\10000+1700)
"RTN","MAGBRTLD",70,0)
 ;
"RTN","MAGBRTUT")
0^5^B19180259
"RTN","MAGBRTUT",1,0)
MAGBRTUT ;WOIFO/EdM - Routing Utilities ; 06/08/2004  08:00
"RTN","MAGBRTUT",2,0)
 ;;3.0;IMAGING;**9,11,30**;16-September-2004
"RTN","MAGBRTUT",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTUT",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGBRTUT",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGBRTUT",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGBRTUT",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGBRTUT",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGBRTUT",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGBRTUT",10,0)
 ;; |                                                               |
"RTN","MAGBRTUT",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGBRTUT",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGBRTUT",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGBRTUT",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGBRTUT",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGBRTUT",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGBRTUT",17,0)
 ;;
"RTN","MAGBRTUT",18,0)
 Q
"RTN","MAGBRTUT",19,0)
 ;
"RTN","MAGBRTUT",20,0)
SEND(IMAGE,LOC,PRI,MECH,FROM,ID) ; Enter image into Routing Queue
"RTN","MAGBRTUT",21,0)
 ; IMAGE ;---- Internal Entry Number in Image FIle
"RTN","MAGBRTUT",22,0)
 ; LOC ;------ Internal Entry Number in either Network Location file
"RTN","MAGBRTUT",23,0)
 ;             or SCU_List file
"RTN","MAGBRTUT",24,0)
 ; PRI ;------ Priority
"RTN","MAGBRTUT",25,0)
 ; MECHanism = 1: Send using MS-DOS-Copy
"RTN","MAGBRTUT",26,0)
 ;           = 2: Send using DICOM_Send
"RTN","MAGBRTUT",27,0)
 ; FROM ;----- Location from which request originates
"RTN","MAGBRTUT",28,0)
 ; ID ;------- Transaction ID
"RTN","MAGBRTUT",29,0)
 N D0 ;------- Internal Entry number
"RTN","MAGBRTUT",30,0)
 N FLAG ;----- List of file-types to transmit
"RTN","MAGBRTUT",31,0)
 N I ;-------- Scratch and loop counter
"RTN","MAGBRTUT",32,0)
 N ORIGIN ;--- Location from which image is being sent (IEN in Institution file)
"RTN","MAGBRTUT",33,0)
 N QQ ;------- List of queue-entries created
"RTN","MAGBRTUT",34,0)
 ;
"RTN","MAGBRTUT",35,0)
 S QQ="",MECH=$G(MECH) S:'MECH MECH=1
"RTN","MAGBRTUT",36,0)
 I '$D(^MAG(2005,+$G(IMAGE))) Q:$Q QQ Q
"RTN","MAGBRTUT",37,0)
 I MECH=1,'$D(^MAG(2005.2,+$G(LOC))) Q:$Q QQ Q
"RTN","MAGBRTUT",38,0)
 I MECH=2,'$D(^MAG(2006.587,+$G(LOC))) Q:$Q QQ Q
"RTN","MAGBRTUT",39,0)
 I MECH'=1,MECH'=2 Q:$Q QQ Q
"RTN","MAGBRTUT",40,0)
 ;
"RTN","MAGBRTUT",41,0)
 S ORIGIN=$G(FROM) D:'ORIGIN
"RTN","MAGBRTUT",42,0)
 . S ORIGIN=$P($G(^MAG(2005,IMAGE,100)),"^",3)
"RTN","MAGBRTUT",43,0)
 . S:'ORIGIN ORIGIN=$G(DUZ(2))
"RTN","MAGBRTUT",44,0)
 . S:'ORIGIN ORIGIN=$$KSP^XUPARAM("INST")
"RTN","MAGBRTUT",45,0)
 . Q
"RTN","MAGBRTUT",46,0)
 ;
"RTN","MAGBRTUT",47,0)
 S PRI=$G(PRI,500),ID=$G(ID)
"RTN","MAGBRTUT",48,0)
 S FLAG=$G(^MAG(2005.2,+LOC,1)) S:MECH=2 FLAG="^^^^5"
"RTN","MAGBRTUT",49,0)
 ;
"RTN","MAGBRTUT",50,0)
 I MECH=2 D  Q:$Q QQ Q
"RTN","MAGBRTUT",51,0)
 . ; Stopgap until "native DICOM" storage is supported
"RTN","MAGBRTUT",52,0)
 . N APPNAM
"RTN","MAGBRTUT",53,0)
 . S APPNAM=$P($G(^MAG(2006.587,LOC,0)),"^",1)
"RTN","MAGBRTUT",54,0)
 . D QUEUE^MAGDRPC3(.QQ,IMAGE,APPNAM,ORIGIN,"","6: Copy to HIPAA Compliant Storage")
"RTN","MAGBRTUT",55,0)
 . Q
"RTN","MAGBRTUT",56,0)
 ;
"RTN","MAGBRTUT",57,0)
 F I=1:1:5 D:$P(FLAG,"^",I)
"RTN","MAGBRTUT",58,0)
 . N D0,T,X
"RTN","MAGBRTUT",59,0)
 . S T=$P("ABSTRACT FULL BIG TEXT DICOM"," ",I)
"RTN","MAGBRTUT",60,0)
 . ;
"RTN","MAGBRTUT",61,0)
 . S D0=$O(^MAGQUEUE(2006.035,"DEST",LOC,"WAITING",IMAGE,T,"")) I D0 D  Q
"RTN","MAGBRTUT",62,0)
 . . N O,P,T,X0,X1
"RTN","MAGBRTUT",63,0)
 . . S X0=$G(^MAGQUEUE(2006.035,D0,0)),O=$P(X0,"^",5),T=$P(X0,"^",6)
"RTN","MAGBRTUT",64,0)
 . . S X1=$G(^MAGQUEUE(2006.035,D0,1)),P=$P(X1,"^",2)
"RTN","MAGBRTUT",65,0)
 . . ; Don't send multiple copies, but do increase priority if needed
"RTN","MAGBRTUT",66,0)
 . . Q:PRI'>P
"RTN","MAGBRTUT",67,0)
 . . S $P(X0,"^",5)=ORIGIN,^MAGQUEUE(2006.035,D0,0)=X0
"RTN","MAGBRTUT",68,0)
 . . I T'=ID,ID'="" D
"RTN","MAGBRTUT",69,0)
 . . . S $P(X0,"^",6)=ID
"RTN","MAGBRTUT",70,0)
 . . . S ^MAGQUEUE(2006.035,D0,0)=X0
"RTN","MAGBRTUT",71,0)
 . . . K:O'="" ^MAGQUEUE(2006.035,"ID",T,D0)
"RTN","MAGBRTUT",72,0)
 . . . S ^MAGQUEUE(2006.035,"ID",ID,D0)=""
"RTN","MAGBRTUT",73,0)
 . . . Q
"RTN","MAGBRTUT",74,0)
 . . S $P(X1,"^",2)=PRI,^MAGQUEUE(2006.035,D0,1)=X1
"RTN","MAGBRTUT",75,0)
 . . K:O ^MAGQUEUE(2006.035,"STS",O,"WAITING",P,LOC,D0)
"RTN","MAGBRTUT",76,0)
 . . S ^MAGQUEUE(2006.035,"STS",ORIGIN,"WAITING",PRI,LOC,D0)=""
"RTN","MAGBRTUT",77,0)
 . . Q
"RTN","MAGBRTUT",78,0)
 . ;
"RTN","MAGBRTUT",79,0)
 . L +^MAGQUEUE(2006.035,0)
"RTN","MAGBRTUT",80,0)
 . S D0=$O(^MAGQUEUE(2006.035," "),-1)+1
"RTN","MAGBRTUT",81,0)
 . S X=$G(^MAGQUEUE(2006.035,0))
"RTN","MAGBRTUT",82,0)
 . S $P(X,"^",1,2)="IMAGE ROUTING QUEUE^2006.035"
"RTN","MAGBRTUT",83,0)
 . S $P(X,"^",3)=D0
"RTN","MAGBRTUT",84,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGBRTUT",85,0)
 . S ^MAGQUEUE(2006.035,0)=X
"RTN","MAGBRTUT",86,0)
 . S X=IMAGE_"^"_LOC_"^"_T_"^"_MECH_"^"_ORIGIN_"^"_ID
"RTN","MAGBRTUT",87,0)
 . S:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)=""
"RTN","MAGBRTUT",88,0)
 . S ^MAGQUEUE(2006.035,D0,0)=X
"RTN","MAGBRTUT",89,0)
 . D NOW^%DTC
"RTN","MAGBRTUT",90,0)
 . S ^MAGQUEUE(2006.035,D0,1)="WAITING^"_PRI_"^"_%
"RTN","MAGBRTUT",91,0)
 . S ^MAGQUEUE(2006.035,"STS",ORIGIN,"WAITING",PRI,LOC,D0)=""
"RTN","MAGBRTUT",92,0)
 . S ^MAGQUEUE(2006.035,"DEST",LOC,"WAITING",IMAGE,T,D0)=""
"RTN","MAGBRTUT",93,0)
 . L -^MAGQUEUE(2006.035,0)
"RTN","MAGBRTUT",94,0)
 . S QQ=QQ_D0_"^"
"RTN","MAGBRTUT",95,0)
 . Q
"RTN","MAGBRTUT",96,0)
 Q:$Q QQ Q
"RTN","MAGBRTUT",97,0)
 ;
"RTN","MAGBRTUT",98,0)
DCMLIST(OUT,LOCATION) N D0,LO,LST,N,NM,X
"RTN","MAGBRTUT",99,0)
 S LOCATION=+$G(LOCATION)
"RTN","MAGBRTUT",100,0)
 S D0=0 F  S D0=$O(^MAG(2006.587,D0)) Q:'D0  D
"RTN","MAGBRTUT",101,0)
 . S X=$G(^MAG(2006.587,D0,0))
"RTN","MAGBRTUT",102,0)
 . S NM=$P(X,"^",1),LO=$P(X,"^",7) Q:NM=""
"RTN","MAGBRTUT",103,0)
 . I LOCATION,LO,LO'=LOCATION Q
"RTN","MAGBRTUT",104,0)
 . S LST(NM,LO)=D0
"RTN","MAGBRTUT",105,0)
 . Q
"RTN","MAGBRTUT",106,0)
 S N=1,NM="" F  S NM=$O(LST(NM)) Q:NM=""  D
"RTN","MAGBRTUT",107,0)
 . S LO="",X=0 F  S LO=$O(LST(NM,LO)) Q:LO=""  S X=X+1,D0=LST(NM,LO)
"RTN","MAGBRTUT",108,0)
 . I X=1 S N=N+1,OUT(N)=NM_"^"_D0 Q
"RTN","MAGBRTUT",109,0)
 . S LO="" F  S LO=$O(LST(NM,LO)) Q:LO=""  S N=N+1,OUT(N)=NM_" ("_LO_")^"_LST(NM,LO)
"RTN","MAGBRTUT",110,0)
 . Q
"RTN","MAGBRTUT",111,0)
 S OUT(1)=N-1
"RTN","MAGBRTUT",112,0)
 Q
"RTN","MAGBRTUT",113,0)
 ;
"RTN","MAGDCCS2")
0^6^B15096146
"RTN","MAGDCCS2",1,0)
MAGDCCS2 ;WOIFO/MLH - DICOM Correct - Clinical Specialties - subroutines ; 05/06/2004  06:32
"RTN","MAGDCCS2",2,0)
 ;;3.0;IMAGING;**10,11,30**;16-September-2004
"RTN","MAGDCCS2",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCS2",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDCCS2",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDCCS2",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDCCS2",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDCCS2",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDCCS2",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDCCS2",10,0)
 ;; |                                                               |
"RTN","MAGDCCS2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDCCS2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDCCS2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDCCS2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDCCS2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDCCS2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCS2",17,0)
 ;;
"RTN","MAGDCCS2",18,0)
 Q
"RTN","MAGDCCS2",19,0)
 ; Routine to create the MAGDY variable needed by MAGDCCS routine when
"RTN","MAGDCCS2",20,0)
 ; manually correcting DICOM FIX files. 
"RTN","MAGDCCS2",21,0)
EN ;
"RTN","MAGDCCS2",22,0)
 ; MAGDY variable to be created during this execution.
"RTN","MAGDCCS2",23,0)
 N D,DIC,DZ,MAGBEG,MAGEND,MAGDFN,MAGOUT,MAGX,MAGXX,INFO,MAGNME,MAGSSN
"RTN","MAGDCCS2",24,0)
 S MAGBEG=1070101,MAGEND=$$DT^XLFDT
"RTN","MAGDCCS2",25,0)
 W !,"*** Select a request/consult with whose ***"
"RTN","MAGDCCS2",26,0)
 W !,"***  TIU note to associate this image   ***"
"RTN","MAGDCCS2",27,0)
 S DIC="^GMR(123,",DIC(0)="AENZ"
"RTN","MAGDCCS2",28,0)
 S DIC("A")="Enter patient or request/consultation: "
"RTN","MAGDCCS2",29,0)
 S D="F",DZ="??"
"RTN","MAGDCCS2",30,0)
 S DIC("W")="W ""  REQ/CON #"",Y"
"RTN","MAGDCCS2",31,0)
 S DIC("W")=DIC("W")_",""  "",$$GET1^DIQ(123,Y,1)" ; TO SERVICE
"RTN","MAGDCCS2",32,0)
 S DIC("W")=DIC("W")_",""  "",$$GET1^DIQ(123,Y,.02)" ; PATIENT NAME
"RTN","MAGDCCS2",33,0)
 ;
"RTN","MAGDCCS2",34,0)
 D IX^DIC
"RTN","MAGDCCS2",35,0)
 Q:$D(DUOUT)
"RTN","MAGDCCS2",36,0)
 Q:'$D(Y(0))  ; nothing selected
"RTN","MAGDCCS2",37,0)
 S (MAGDFN,MAGX)=$P(Y(0),U,2)_"~"_Y
"RTN","MAGDCCS2",38,0)
 ;
"RTN","MAGDCCS2",39,0)
 D ONE ; Lookup was on req/con number and successful
"RTN","MAGDCCS2",40,0)
 Q
"RTN","MAGDCCS2",41,0)
 ;
"RTN","MAGDCCS2",42,0)
PTINFO() ;
"RTN","MAGDCCS2",43,0)
 N INFO,MAGOUT
"RTN","MAGDCCS2",44,0)
 I '$D(MAGDFN) Q ""
"RTN","MAGDCCS2",45,0)
 D GETS^DIQ(2,MAGDFN,".01;.09","E","MAGOUT","MAGERR")
"RTN","MAGDCCS2",46,0)
 I $D(MAGERR) Q ""
"RTN","MAGDCCS2",47,0)
 I $D(MAGOUT) D  Q INFO
"RTN","MAGDCCS2",48,0)
 . S INFO=$G(MAGOUT(2,MAGDFN_",",.01,"E"))
"RTN","MAGDCCS2",49,0)
 . S INFO=INFO_"^"_$G(MAGOUT(2,MAGDFN_",",.09,"E"))
"RTN","MAGDCCS2",50,0)
 Q ""
"RTN","MAGDCCS2",51,0)
 ;
"RTN","MAGDCCS2",52,0)
ONE ; Process the single entry that was selected.
"RTN","MAGDCCS2",53,0)
 ; MAGDFN,MAGX variables expected from EN
"RTN","MAGDCCS2",54,0)
 I 'MAGDFN,'+MAGX Q
"RTN","MAGDCCS2",55,0)
 N BEG,CASE,CDATE,CS,DATA,END,FLDS,INFO,MAGCASE,MAGCNI,MAGDATE,MAGDTI
"RTN","MAGDCCS2",56,0)
 N MAGEXST,MAGLOC,MAGNME,MAGOUT,MAGPIEN,MAGPRC,MAGPSET,MAGPST,MAGRPT
"RTN","MAGDCCS2",57,0)
 N PP,PSET,RAENTRY,RAMEMLOW,RAPRTSET,RIEN,STAT,X,X1,X2,XX
"RTN","MAGDCCS2",58,0)
 N RARPT,RADFN,RADTI,RACNI ;<--Variables needed for EN1^RAUTL20
"RTN","MAGDCCS2",59,0)
 ; RAUTL20 used to retrieve if case is part of a print set.
"RTN","MAGDCCS2",60,0)
 N MAGRCARY ; array of req/con data from file 123
"RTN","MAGDCCS2",61,0)
 N MAGIENS  ; internal entry number for MAGRCARY
"RTN","MAGDCCS2",62,0)
 ;
"RTN","MAGDCCS2",63,0)
 S MAGDFN=$P(MAGX,"~"),INFO=$$PTINFO
"RTN","MAGDCCS2",64,0)
 S MAGNME=$P(INFO,"^"),MAGSSN=$P(INFO,"^",2)
"RTN","MAGDCCS2",65,0)
 S MAGCASE=$P($P(MAGX,"~",2),U)
"RTN","MAGDCCS2",66,0)
 S (MAGPRC,MAGDTI,MAGCNI,MAGPIEN,MAGLOC,MAGDATE,MAGEXST,MAGPST)=""
"RTN","MAGDCCS2",67,0)
 K MAGRCARY D GETS^DIQ(123,MAGCASE,"*","EI","MAGRCARY")
"RTN","MAGDCCS2",68,0)
 ;
"RTN","MAGDCCS2",69,0)
 S MAGIENS=$O(MAGRCARY(123,""))
"RTN","MAGDCCS2",70,0)
 S MAGPRC=MAGRCARY(123,MAGIENS,4,"E") ; procedure
"RTN","MAGDCCS2",71,0)
 S MAGLOC=MAGRCARY(123,MAGIENS,1,"E") ; to service
"RTN","MAGDCCS2",72,0)
 S MAGDATE=MAGRCARY(123,MAGIENS,.01,"E") ; request date
"RTN","MAGDCCS2",73,0)
 S MAGPST=MAGRCARY(123,MAGIENS,8,"E") ; procedure status
"RTN","MAGDCCS2",74,0)
 W !,"PATIENT: ",MAGNME,?51,"SSN: ",MAGSSN
"RTN","MAGDCCS2",75,0)
 W !,"Req/Con No.",?13,"Procedure",?38,"To Service",?58,"Req Date"
"RTN","MAGDCCS2",76,0)
 W !,"-----------",?13,"---------",?38,"----------------",?58,"--------"
"RTN","MAGDCCS2",77,0)
 W !,MAGCASE,?13,MAGPRC,?38,MAGLOC,?58,MAGDATE
"RTN","MAGDCCS2",78,0)
 W !,"Exam status: ",MAGEXST," "," ",$G(MAGPST)
"RTN","MAGDCCS2",79,0)
 D MAGDY
"RTN","MAGDCCS2",80,0)
 Q
"RTN","MAGDCCS2",81,0)
 ;
"RTN","MAGDCCS2",82,0)
MAGDY ;
"RTN","MAGDCCS2",83,0)
 S MAGDY=MAGDFN_"^"_MAGNME_"^"_MAGSSN_"^"_"GMRC-"_MAGCASE_"^"_MAGPRC_"^"_MAGDTI
"RTN","MAGDCCS2",84,0)
 S MAGDY=MAGDY_"^"_MAGCNI_"^"_MAGPIEN_"^"_$G(MAGPST)_"^"
"RTN","MAGDCCS2",85,0)
 K MAGNME,MAGSSN,MAGCASE,MAGPRC,MAGDTI,MAGCNI,MAGPIEN,MAPST
"RTN","MAGDCCS2",86,0)
 Q
"RTN","MAGDHL7")
0^7^B24648346
"RTN","MAGDHL7",1,0)
MAGDHL7 ;WOIFO/PMK,MLH - Routine to copy HL7 data from HLSDATA to ^MAGDHL7 ; 05/06/2004  06:32
"RTN","MAGDHL7",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDHL7",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHL7",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHL7",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHL7",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHL7",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHL7",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHL7",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHL7",10,0)
 ;; |                                                               |
"RTN","MAGDHL7",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHL7",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHL7",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHL7",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHL7",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHL7",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHL7",17,0)
 ;;
"RTN","MAGDHL7",18,0)
 Q
"RTN","MAGDHL7",19,0)
 ;Steps for setting up the HL7 package. Version 1.5
"RTN","MAGDHL7",20,0)
 ;1) Create an entry in the HL7 APPLICATION PARAMETER file (771) called
"RTN","MAGDHL7",21,0)
 ;   'PACS GATEWAY' and set ACTIVE/INACTIVE field to ACTIVE.
"RTN","MAGDHL7",22,0)
 ;2) Create an entry in the HL7 NON-DHCP APPLICATION PARAMETER file (770)
"RTN","MAGDHL7",23,0)
 ;   called 'PACS GATEWAY' and set DHCP APPLICATION field to 'PACS GATEWAY'
"RTN","MAGDHL7",24,0)
 ;   (repoint to file 771).
"RTN","MAGDHL7",25,0)
 ;3) Set the Entry Action field of the RA SEND entry in the Protocol file
"RTN","MAGDHL7",26,0)
 ;   (101) to call 'PACS GATEWAY
"RTN","MAGDHL7",27,0)
 ;   EXAMPLE:  Replace xxxx With PACS GATEWAY
"RTN","MAGDHL7",28,0)
 ;
"RTN","MAGDHL7",29,0)
ENTRY ; Entry point for HL7 1.5 version
"RTN","MAGDHL7",30,0)
 ; Entry point from ^HLTRANS to copy the data from HLSDATA to ^MAGDHL7(
"RTN","MAGDHL7",31,0)
 ; This code was reset due to a max. string code error.  Peter indicated
"RTN","MAGDHL7",32,0)
 ; he did not need the 5th piece of the OBR segment.
"RTN","MAGDHL7",33,0)
 I $D(HLSDATA(3)),$P(HLSDATA(3),"^")="OBR" S $P(HLSDATA(3),"^",5)=""
"RTN","MAGDHL7",34,0)
 D ADDDTA($NA(HLSDATA))
"RTN","MAGDHL7",35,0)
 ; Adjust the returned HLSDATA array to start at 0 instead of 1
"RTN","MAGDHL7",36,0)
 S IX=1
"RTN","MAGDHL7",37,0)
 F  Q:'IX  Q:'$D(HLSDATA(IX))  D
"RTN","MAGDHL7",38,0)
 . S HLSDATA(IX-1)=HLSDATA(IX) K HLSDATA(IX)
"RTN","MAGDHL7",39,0)
 . S IX=$O(HLSDATA(IX))
"RTN","MAGDHL7",40,0)
 . Q
"RTN","MAGDHL7",41,0)
 G:$D(HLSDT) EX
"RTN","MAGDHL7",42,0)
 D NOW^%DTC S X=$P(%,"."),DIC="^MAGDHL7(2006.5,"
"RTN","MAGDHL7",43,0)
 S DIC(0)="LZ" D FILE^DICN
"RTN","MAGDHL7",44,0)
 S $P(^MAGDHL7(2006.5,+Y,0),"^",2)=$P(HLSDATA(0),"^",9) ; Message type
"RTN","MAGDHL7",45,0)
 S L=1,J=0 S ^MAGDHL7(2006.5,+Y,1,L,0)=HLSDATA(0)
"RTN","MAGDHL7",46,0)
 F  S J=$O(HLSDATA(J)) Q:J'>0  D
"RTN","MAGDHL7",47,0)
 . S L=L+1,^MAGDHL7(2006.5,+Y,1,L,0)=HLSDATA(J)
"RTN","MAGDHL7",48,0)
 . Q
"RTN","MAGDHL7",49,0)
 S ^MAGDHL7(2006.5,+Y,1,0)="^^"_L_U_L_U_DT
"RTN","MAGDHL7",50,0)
 S DIE=DIC,DR=".03///^S X=""NOW""",DA=+Y D ^DIE ; Capture time
"RTN","MAGDHL7",51,0)
 G EX
"RTN","MAGDHL7",52,0)
 ;
"RTN","MAGDHL7",53,0)
KIL ; Kill off old HL7 data in ^MAGDHL7(2006.5
"RTN","MAGDHL7",54,0)
 ; Keep how many days?
"RTN","MAGDHL7",55,0)
 S DIR("A")="   Select number of days to save HL7 Global",DIR(0)="N^0:31"
"RTN","MAGDHL7",56,0)
 D ^DIR G EX:Y=""
"RTN","MAGDHL7",57,0)
 S MAGN=Y
"RTN","MAGDHL7",58,0)
 S %ZIS="Q",IOP="Q;""""" W !! D ^%ZIS I POP S MAGOUT="" G EX
"RTN","MAGDHL7",59,0)
 I '$D(IO("Q")) D TK1^MAGDHL7 G EX
"RTN","MAGDHL7",60,0)
 S ZTRTN="TK1^MAGDHL7",ZTSAVE("MAGN")="",ZTDESC="DELETE OLD HL7 RECORDS"
"RTN","MAGDHL7",61,0)
 S ZTIO="",ZTDTH=$H D ^%ZTLOAD
"RTN","MAGDHL7",62,0)
 G EX
"RTN","MAGDHL7",63,0)
 ;
"RTN","MAGDHL7",64,0)
TK1 ; Tasked job
"RTN","MAGDHL7",65,0)
 S EDT=DT-MAGN,DIC="^MAGDHL7(2006.5,"
"RTN","MAGDHL7",66,0)
 S KDT="" F  S KDT=$O(^MAGDHL7(2006.5,"B",KDT)) Q:KDT=""  Q:KDT>EDT  D
"RTN","MAGDHL7",67,0)
 . S DA="" F  S DA=$O(^MAGDHL7(2006.5,"B",KDT,DA)) Q:DA=""  D ^DIK
"RTN","MAGDHL7",68,0)
 . Q
"RTN","MAGDHL7",69,0)
 G EX
"RTN","MAGDHL7",70,0)
 ;
"RTN","MAGDHL7",71,0)
EX ; EXIT
"RTN","MAGDHL7",72,0)
 K DA,EDT,DIK,DIR,HLSDT,KDT,MAGN,MAGOUT,POP
"RTN","MAGDHL7",73,0)
 Q
"RTN","MAGDHL7",74,0)
 ;
"RTN","MAGDHL7",75,0)
EN ; Entry point for HL7 1.6. Called from the MAG SEND ORU/ORM protocols.
"RTN","MAGDHL7",76,0)
 ; Executed after the RA protocols setup the HL7 message segments.
"RTN","MAGDHL7",77,0)
 D EN2
"RTN","MAGDHL7",78,0)
 Q
"RTN","MAGDHL7",79,0)
 ;
"RTN","MAGDHL7",80,0)
EN2 ;
"RTN","MAGDHL7",81,0)
 N DA,DIE,DIC,DR,I,J,K,L,MAGRAD,MAGRAN,MAGSAN,MAGTYPE,Y,X
"RTN","MAGDHL7",82,0)
 I $D(HLQUIT),HLQUIT Q  ; HL7 routines may have failed.
"RTN","MAGDHL7",83,0)
 S MAGRAD=""
"RTN","MAGDHL7",84,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MAGDHL7",85,0)
 . S MAGRAD(I)=HLNODE,J=0
"RTN","MAGDHL7",86,0)
 . F  S J=$O(HLNODE(J)) Q:'J  S MAGRAD(I)=MAGRAD(I)_HLNODE(J)
"RTN","MAGDHL7",87,0)
 . Q
"RTN","MAGDHL7",88,0)
 ; Above code needed for segments greater than 245 characters.
"RTN","MAGDHL7",89,0)
 S MAGTYPE=$G(HL("MTN")),MAGRAN=$G(HL("RAN")),MAGSAN=$G(HL("SAN"))
"RTN","MAGDHL7",90,0)
 ; Add demo and modality info expected by MAGDHR* routines on gateway
"RTN","MAGDHL7",91,0)
 D ADDDTA($NA(MAGRAD))
"RTN","MAGDHL7",92,0)
 ; Fall-Through intentional
"RTN","MAGDHL7",93,0)
UPDATE ; Add the entry in the MAGDHL7(2006.5 global.
"RTN","MAGDHL7",94,0)
 D NOW^%DTC S X=$P(%,".") ; Getting today's date
"RTN","MAGDHL7",95,0)
 S DIC="^MAGDHL7(2006.5,",DIC(0)="LZ" D FILE^DICN
"RTN","MAGDHL7",96,0)
 I +Y<1 Q  ; Entry not made in file.
"RTN","MAGDHL7",97,0)
 S $P(^MAGDHL7(2006.5,+Y,0),"^",2)=MAGTYPE
"RTN","MAGDHL7",98,0)
 ; Add HL7 message into word processing field.
"RTN","MAGDHL7",99,0)
 S (L,K)=0 F  S K=$O(MAGRAD(K)) Q:'K  S L=L+1,^MAGDHL7(2006.5,+Y,1,L,0)=MAGRAD(K) D
"RTN","MAGDHL7",100,0)
 . ; If segment has more than one line of data, add as a single line
"RTN","MAGDHL7",101,0)
 . ; Peter's code will take care of this.
"RTN","MAGDHL7",102,0)
 . S J=0 F  S J=$O(MAGRAD(K,J)) Q:'J  S L=L+1,^MAGDHL7(2006.5,+Y,1,L,0)=MAGRAD(K,J)
"RTN","MAGDHL7",103,0)
 S ^MAGDHL7(2006.5,+Y,1,0)="^^"_L_"^"_L_"^"_DT
"RTN","MAGDHL7",104,0)
 S DIE=DIC,DR=".03///^S X=""NOW""",DA=+Y D ^DIE
"RTN","MAGDHL7",105,0)
 Q
"RTN","MAGDHL7",106,0)
 ;
"RTN","MAGDHL7",107,0)
ADDDTA(XARY) ; SUBROUTINE - called by ENTRY, EN2
"RTN","MAGDHL7",108,0)
 ; Add demographic, visit, and modality information to HL7 messages.
"RTN","MAGDHL7",109,0)
 ; 
"RTN","MAGDHL7",110,0)
 ; input:  XARY   name of array into which additional HL7 message data is to 
"RTN","MAGDHL7",111,0)
 ;                be populated (@XARY should already contain HL7 msg segments)
"RTN","MAGDHL7",112,0)
 ;                valued  "MAGRAD"   for radiology orders
"RTN","MAGDHL7",113,0)
 ;                        "HLSDATA"  for ADT messages
"RTN","MAGDHL7",114,0)
 ;                        
"RTN","MAGDHL7",115,0)
 ; output: @XARY  with demo, visit, modality segments added
"RTN","MAGDHL7",116,0)
 ;                or NTE segment added after MSH if there was a problem
"RTN","MAGDHL7",117,0)
 ; 
"RTN","MAGDHL7",118,0)
 ; The DICOM gateway's MAGDHR* routines formerly expected to be able to use
"RTN","MAGDHL7",119,0)
 ; a DDP link to gather supplementary information about patient demographics
"RTN","MAGDHL7",120,0)
 ; and modality.  This subroutine populates the HL7 segments with the
"RTN","MAGDHL7",121,0)
 ; supplementary data, eliminating the need for the DDP link.
"RTN","MAGDHL7",122,0)
 ;
"RTN","MAGDHL7",123,0)
 N MAG7WRK ; -- work array for HL7 message
"RTN","MAGDHL7",124,0)
 N STSRBLD ; -- rebuild status
"RTN","MAGDHL7",125,0)
 N S1,S2 ; ---- scratch segment index vars
"RTN","MAGDHL7",126,0)
 ;
"RTN","MAGDHL7",127,0)
 ; Break out message -- If parse fails, insert a NTE segment and bail
"RTN","MAGDHL7",128,0)
 ; 
"RTN","MAGDHL7",129,0)
 I $$PARSE^MAG7UP(XARY,$NA(MAG7WRK)) D  Q
"RTN","MAGDHL7",130,0)
 . ; Set 1st, 2nd seg indices - don't overwrite bare MSH
"RTN","MAGDHL7",131,0)
 . S S1=$O(@XARY@(0)) S:'S1 S1=1
"RTN","MAGDHL7",132,0)
 . S S2=$O(@XARY@(S1)) S:'S2 S2=S1+1
"RTN","MAGDHL7",133,0)
 . S @XARY@((S1+S2)/2)="NTE|1||bad HL7 message structure"
"RTN","MAGDHL7",134,0)
 . Q
"RTN","MAGDHL7",135,0)
 D PIDADD^MAG7RS ; Add patient demographic data
"RTN","MAGDHL7",136,0)
 D ADDVSDG^MAG7RS ; Add patient visit and diagnosis data
"RTN","MAGDHL7",137,0)
 I MAG7WRK(1,9,1,1,1)="ORU" D OBXUPD^MAG7RSO ; Add numeric diag codes
"RTN","MAGDHL7",138,0)
 S STSRBLD=$$MAKE^MAG7UM($NA(MAG7WRK),XARY)
"RTN","MAGDHL7",139,0)
 I STSRBLD D  Q
"RTN","MAGDHL7",140,0)
 . ; Set 1st, 2nd seg indices - don't overwrite bare MSH
"RTN","MAGDHL7",141,0)
 . S S1=$O(@XARY@(0)) S:'S1 S1=1
"RTN","MAGDHL7",142,0)
 . S S2=$O(@XARY@(S1)) S:'S2 S2=S1+1
"RTN","MAGDHL7",143,0)
 . S @XARY@((S1+S2)/2)="NTE|1||bad HL7 message structure"
"RTN","MAGDHL7",144,0)
 . Q
"RTN","MAGDHL7",145,0)
 Q
"RTN","MAGDHL7",146,0)
 ;
"RTN","MAGDHRS1")
0^8^B9937319
"RTN","MAGDHRS1",1,0)
MAGDHRS1 ;WOIFO/PMK - Read HL7 and generate DICOM ; 08/20/2004  08:27
"RTN","MAGDHRS1",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDHRS1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHRS1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHRS1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHRS1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHRS1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHRS1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHRS1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHRS1",10,0)
 ;; |                                                               |
"RTN","MAGDHRS1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHRS1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHRS1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHRS1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHRS1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHRS1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHRS1",17,0)
 ;;
"RTN","MAGDHRS1",18,0)
 Q
"RTN","MAGDHRS1",19,0)
 ; M-to-M Broker Server
"RTN","MAGDHRS1",20,0)
 ;
"RTN","MAGDHRS1",21,0)
ENTRY(RESULT,REQUEST) ; RPC = MAG DICOM TEXT PROCESSING
"RTN","MAGDHRS1",22,0)
 N HIT ;------ indicates that the requested HL7 message exists
"RTN","MAGDHRS1",23,0)
 N HL7MSGNO ;- number of HL7 message
"RTN","MAGDHRS1",24,0)
 N ITIMEOUT ;- second counter incremented up to TIMEOUT
"RTN","MAGDHRS1",25,0)
 N SEGCOUNT ;- count of segments in the HL7 message
"RTN","MAGDHRS1",26,0)
 N TIMEOUT ;-- number of seconds to wait before returning void
"RTN","MAGDHRS1",27,0)
 N WAIT ;----- number of seconds to wait for an HL7 message
"RTN","MAGDHRS1",28,0)
 N I,J,X,Y,Z ;---- working variables
"RTN","MAGDHRS1",29,0)
 ;
"RTN","MAGDHRS1",30,0)
 K RESULT
"RTN","MAGDHRS1",31,0)
 ;
"RTN","MAGDHRS1",32,0)
 S WAIT=200 ; Time-out period for incomplete message
"RTN","MAGDHRS1",33,0)
 ; (30 seconds was not enough in Amarillo)
"RTN","MAGDHRS1",34,0)
 ;
"RTN","MAGDHRS1",35,0)
 S HL7MSGNO=+$P(REQUEST(2),"|",1),TIMEOUT=$P(REQUEST(2),"|",2)
"RTN","MAGDHRS1",36,0)
 D:'$D(^MAGDHL7(2006.5,HL7MSGNO))
"RTN","MAGDHRS1",37,0)
 . S I=$O(^MAGDHL7(2006.5,HL7MSGNO)) Q:'I
"RTN","MAGDHRS1",38,0)
 . S HL7MSGNO=I
"RTN","MAGDHRS1",39,0)
 . Q
"RTN","MAGDHRS1",40,0)
 ;
"RTN","MAGDHRS1",41,0)
 ; wait for HL7 message to be generated
"RTN","MAGDHRS1",42,0)
 S HIT=0 F  D  Q:HIT  S TIMEOUT=TIMEOUT-1 Q:TIMEOUT<0  H 1
"RTN","MAGDHRS1",43,0)
 . I $D(^MAGDHL7(2006.5,HL7MSGNO)) S HIT=1
"RTN","MAGDHRS1",44,0)
 . Q
"RTN","MAGDHRS1",45,0)
 ;
"RTN","MAGDHRS1",46,0)
 I HIT D
"RTN","MAGDHRS1",47,0)
 . I $$WAIT(0,WAIT) Q
"RTN","MAGDHRS1",48,0)
 . S SEGCOUNT=$P(^MAGDHL7(2006.5,HL7MSGNO,1,0),"^",3)
"RTN","MAGDHRS1",49,0)
 . S RESULT(1)=HL7MSGNO
"RTN","MAGDHRS1",50,0)
 . S RESULT(2)=^MAGDHL7(2006.5,HL7MSGNO,0)
"RTN","MAGDHRS1",51,0)
 . S RESULT(3)=^MAGDHL7(2006.5,HL7MSGNO,1,0)
"RTN","MAGDHRS1",52,0)
 . F I=1:1:SEGCOUNT D
"RTN","MAGDHRS1",53,0)
 . . I $$WAIT(I,WAIT) S I=999999 Q
"RTN","MAGDHRS1",54,0)
 . . S (X,Y)=^MAGDHL7(2006.5,HL7MSGNO,1,I,0)
"RTN","MAGDHRS1",55,0)
 . . D:$TR($T(+2^XWBVLL),",","*")'["*34*"
"RTN","MAGDHRS1",56,0)
 . . . N E,J
"RTN","MAGDHRS1",57,0)
 . . . S Y="" F J=1:1:$L(X) S E=$E(X,J),Y=Y_$S(E="<":"&lt;",E=">":"&gt;",E="&":"&amp;",E="""":"&quot;",1:E)
"RTN","MAGDHRS1",58,0)
 . . . Q
"RTN","MAGDHRS1",59,0)
 . . S RESULT(I+3)=Y
"RTN","MAGDHRS1",60,0)
 . . Q
"RTN","MAGDHRS1",61,0)
 . Q
"RTN","MAGDHRS1",62,0)
 E  S RESULT(1)=""
"RTN","MAGDHRS1",63,0)
 Q
"RTN","MAGDHRS1",64,0)
 ;
"RTN","MAGDHRS1",65,0)
WAIT(I,WAIT) ; wait for node to be written
"RTN","MAGDHRS1",66,0)
 N JTIMEOUT
"RTN","MAGDHRS1",67,0)
 F JTIMEOUT=1:1:WAIT Q:$D(^MAGDHL7(2006.5,HL7MSGNO,1,I))  H 1
"RTN","MAGDHRS1",68,0)
 I JTIMEOUT=WAIT D  Q 1
"RTN","MAGDHRS1",69,0)
 . ; an error occurred during the waiting
"RTN","MAGDHRS1",70,0)
 . K RESULT
"RTN","MAGDHRS1",71,0)
 . S RESULT(1)="-1 ^MAGDHL7(2006.5,"_HL7MSGNO_","_I_",...) is incomplete"
"RTN","MAGDHRS1",72,0)
 . Q
"RTN","MAGDHRS1",73,0)
 Q 0
"RTN","MAGDIR81")
0^9^B59204036
"RTN","MAGDIR81",1,0)
MAGDIR81 ;WOIFO/PMK - Read a DICOM image file ; 09/08/2004  07:30
"RTN","MAGDIR81",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDIR81",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR81",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR81",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR81",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR81",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR81",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR81",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR81",10,0)
 ;; |                                                               |
"RTN","MAGDIR81",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR81",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR81",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR81",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR81",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR81",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR81",17,0)
 ;;
"RTN","MAGDIR81",18,0)
 ;
"RTN","MAGDIR81",19,0)
 ; M2MB server
"RTN","MAGDIR81",20,0)
 ;
"RTN","MAGDIR81",21,0)
 ; This routine is invoked by the ^MAGDIR8 for the "STORE1/STORE2"
"RTN","MAGDIR81",22,0)
 ; REQUEST items when there is an image to be stored into the database.
"RTN","MAGDIR81",23,0)
 ; It adds it to the ^MAG global with appropriate pointers to the
"RTN","MAGDIR81",24,0)
 ; "parent data files".
"RTN","MAGDIR81",25,0)
 ;
"RTN","MAGDIR81",26,0)
ENTRY ; process one image
"RTN","MAGDIR81",27,0)
 N MEDATA ;--- medicine pkg patient & study data (set in ^MAGDIR8A)
"RTN","MAGDIR81",28,0)
 N FILEDATA ;- array of data to be passed between routines
"RTN","MAGDIR81",29,0)
 N FIRSTDCM ;- patient first name from the image header (ie, PNAMEDCM)
"RTN","MAGDIR81",30,0)
 N GMRCIEN ;-- internal entry number of consult/procedure request
"RTN","MAGDIR81",31,0)
 N LASTDCM ;-- patient last name from the image header (ie, PNAMEDCM)
"RTN","MAGDIR81",32,0)
 N MAGGP ;---- image's group pointer in ^MAG(2005)
"RTN","MAGDIR81",33,0)
 N MAGIEN ;--- pointer to the entry for the image in ^MAG(2005)
"RTN","MAGDIR81",34,0)
 N MIDCM ;---- patient middle initial from the image header (PNAMEDCM)
"RTN","MAGDIR81",35,0)
 N PNAMEVAH ;- patient name from VADM(1)
"RTN","MAGDIR81",36,0)
 N PROCDESC ;- procedure description (VA's name)
"RTN","MAGDIR81",37,0)
 N RADATA ;--- radiology pkg patient & study data (set in ^MAGDIR8A)
"RTN","MAGDIR81",38,0)
 N VADM ;----- array of demographic variables filled in by DEM^VADPT
"RTN","MAGDIR81",39,0)
 N MAG0,MAG1,MAG2,QUIT,X
"RTN","MAGDIR81",40,0)
 ;
"RTN","MAGDIR81",41,0)
 N ACNUMB,CASENUMB,EMAIL,FROMPATH,IMAGEUID,IMAGNAME,IMAGNUMB,IMGSVC
"RTN","MAGDIR81",42,0)
 N INSTLOC,INSTNAME,LASTIMG,LOCATION,LOOPCNT,MACHID,MODALITY,MODPARMS
"RTN","MAGDIR81",43,0)
 N MULTFRAM,PID,PNAMEDCM,ROUTRULE,SERINUMB,SERIEUID,STATUS,STUDYDAT
"RTN","MAGDIR81",44,0)
 N STUDYTIM,STUDYDAT,STUDYTIM,STUDYUID,SYSTITLE
"RTN","MAGDIR81",45,0)
 ;
"RTN","MAGDIR81",46,0)
 S STATUS=$P(ARGS,"|",1),LOCATION=$P(ARGS,"|",2)
"RTN","MAGDIR81",47,0)
 S MACHID=$P(ARGS,"|",3),IMGSVC=$P(ARGS,"|",4)
"RTN","MAGDIR81",48,0)
 S INSTNAME=$P(ARGS,"|",5),FROMPATH=$P(ARGS,"|",6)
"RTN","MAGDIR81",49,0)
 S PID=$P(ARGS,"|",7),PNAMEDCM=$P(ARGS,"|",8)
"RTN","MAGDIR81",50,0)
 S CASENUMB=$P(ARGS,"|",9),ACNUMB=$P(ARGS,"|",10)
"RTN","MAGDIR81",51,0)
 S STUDYDAT=$P(ARGS,"|",11),STUDYTIM=$P(ARGS,"|",12)
"RTN","MAGDIR81",52,0)
 S LOOPCNT=$P(ARGS,"|",13),MODALITY=$P(ARGS,"|",14)
"RTN","MAGDIR81",53,0)
 S IMAGNAME=$P(ARGS,"|",15),MODPARMS=$P(ARGS,"|",16)
"RTN","MAGDIR81",54,0)
 S SERINUMB=$P(ARGS,"|",17),IMAGNUMB=$P(ARGS,"|",18)
"RTN","MAGDIR81",55,0)
 S INSTLOC=$P(ARGS,"|",19),MULTFRAM=$P(ARGS,"|",20)
"RTN","MAGDIR81",56,0)
 S SYSTITLE=$P(ARGS,"|",21),EMAIL=$P(ARGS,"|",22)
"RTN","MAGDIR81",57,0)
 S IREQUEST=IREQUEST+1,OPCODE=$P(REQUEST(IREQUEST),"|")
"RTN","MAGDIR81",58,0)
 I OPCODE'="STORE2" D  Q
"RTN","MAGDIR81",59,0)
 . D RESULT^MAGDIR8("STORE","-101 Expecting STORE2, got """_OPCODE_"""")
"RTN","MAGDIR81",60,0)
 . Q
"RTN","MAGDIR81",61,0)
 S ARGS=$P(REQUEST(IREQUEST),"|",2,999)
"RTN","MAGDIR81",62,0)
 S STUDYUID=$P(ARGS,"|",1),SERIEUID=$P(ARGS,"|",2)
"RTN","MAGDIR81",63,0)
 S IMAGEUID=$P(ARGS,"|",3),LASTIMG=$P(ARGS,"|",4)
"RTN","MAGDIR81",64,0)
 S ROUTRULE=$P(ARGS,"|",5),MFGR=$P(ARGS,"|",6)
"RTN","MAGDIR81",65,0)
 S MODEL=$P(ARGS,"|",7)
"RTN","MAGDIR81",66,0)
 ;
"RTN","MAGDIR81",67,0)
 ; get a pointer to the image, if it is already on file
"RTN","MAGDIR81",68,0)
 S MAGIEN=$O(^MAG(2005,"P",IMAGEUID,0))
"RTN","MAGDIR81",69,0)
 ;
"RTN","MAGDIR81",70,0)
 ; the following line will have to be adjusted for DICOM SR
"RTN","MAGDIR81",71,0)
 S FILEDATA("TYPE")=$O(^MAG(2005.83,"B","IMAGE",""))
"RTN","MAGDIR81",72,0)
 ;
"RTN","MAGDIR81",73,0)
 I MULTFRAM,MAGIEN D  ; subsequent image of a multiframe object
"RTN","MAGDIR81",74,0)
 . D MULTFRAM ; require both MULTFRAM and MAGIEN to be non-zero
"RTN","MAGDIR81",75,0)
 . Q 
"RTN","MAGDIR81",76,0)
 E  D  Q:ERRCODE  ; new image
"RTN","MAGDIR81",77,0)
 . S ERRCODE=$$NEWIMAGE()
"RTN","MAGDIR81",78,0)
 . I ERRCODE D  ; error - abort image processing
"RTN","MAGDIR81",79,0)
 . . D ERROR^MAGDIR8("STORE",ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR81",80,0)
 . . Q
"RTN","MAGDIR81",81,0)
 . Q
"RTN","MAGDIR81",82,0)
 ;
"RTN","MAGDIR81",83,0)
 ;create the image pointer
"RTN","MAGDIR81",84,0)
 I MODPARMS="<DICOM>" D  ; store DICOM image type in VistA
"RTN","MAGDIR81",85,0)
 . S FILEDATA("OBJECT TYPE")=100 ; DICOM image type
"RTN","MAGDIR81",86,0)
 . S FILEDATA("EXTENSION")="EXT^DCM" ; specify the DICOM file extension
"RTN","MAGDIR81",87,0)
 . Q
"RTN","MAGDIR81",88,0)
 E  D  ; convert DICOM image type to TGA and store it in VistA
"RTN","MAGDIR81",89,0)
 . S FILEDATA("OBJECT TYPE")=3 ; XRAY image type
"RTN","MAGDIR81",90,0)
 . S FILEDATA("EXTENSION")="EXT^TGA" ; specify the TGA file extension
"RTN","MAGDIR81",91,0)
 . Q
"RTN","MAGDIR81",92,0)
 S FILEDATA("ABSTRACT")="ABS^STUFFONLY" ; specify the abstract net loc
"RTN","MAGDIR81",93,0)
 ;
"RTN","MAGDIR81",94,0)
 S ERRCODE=$$IMAGE^MAGDIR9B ; create the ^MAG(2005) entry for the image
"RTN","MAGDIR81",95,0)
 I ERRCODE D  ; error - abort image processing
"RTN","MAGDIR81",96,0)
 . D ERROR^MAGDIR8("STORE",ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR81",97,0)
 . Q
"RTN","MAGDIR81",98,0)
 E  D  ; no error
"RTN","MAGDIR81",99,0)
 . S X="0|"_RETURN
"RTN","MAGDIR81",100,0)
 . ; save pname, pid, dob, age, and sex from DEM^VADPT for gateway
"RTN","MAGDIR81",101,0)
 . F I=1:1:5 S X=X_"|"_VADM(I)
"RTN","MAGDIR81",102,0)
 . D RESULT^MAGDIR8("STORE",X)
"RTN","MAGDIR81",103,0)
 . Q
"RTN","MAGDIR81",104,0)
 Q
"RTN","MAGDIR81",105,0)
 ;
"RTN","MAGDIR81",106,0)
NEWIMAGE() ; processing for a new image
"RTN","MAGDIR81",107,0)
 N PIDCHECK ;- return value of from $$PIDCHECK^MAGDIR8A()
"RTN","MAGDIR81",108,0)
 ;
"RTN","MAGDIR81",109,0)
 I MAGIEN,LOOPCNT>2 D  Q "-1 Image already in database"
"RTN","MAGDIR81",110,0)
 . K MSG
"RTN","MAGDIR81",111,0)
 . S Y=$P($G(^MAG(2005,MAGIEN,2)),"^") I Y D DD^%DT
"RTN","MAGDIR81",112,0)
 . S MSG(1)="Image """_FROMPATH_""""
"RTN","MAGDIR81",113,0)
 . S MSG(2)="is already in the database (#"_MAGIEN_") for"
"RTN","MAGDIR81",114,0)
 . S MSG(3)=""""_$P($G(^MAG(2005,MAGIEN,0)),"^")_""""
"RTN","MAGDIR81",115,0)
 . S MSG(4)="Acquired on "_Y
"RTN","MAGDIR81",116,0)
 . S MSG(5)="UID = "_IMAGEUID
"RTN","MAGDIR81",117,0)
 . Q
"RTN","MAGDIR81",118,0)
 ;
"RTN","MAGDIR81",119,0)
 I MAGIEN D  ; process the image again, after software crash
"RTN","MAGDIR81",120,0)
 . ; If the software crashed processing the first image, it might
"RTN","MAGDIR81",121,0)
 . ; delete the image without ever writing it to the file server.
"RTN","MAGDIR81",122,0)
 . ; Now, the image processing software has a second chance.
"RTN","MAGDIR81",123,0)
 . K MSG
"RTN","MAGDIR81",124,0)
 . S Y=$P($G(^MAG(2005,MAGIEN,2)),"^") I Y D DD^%DT
"RTN","MAGDIR81",125,0)
 . S MSG(1)="Reprocessing image """_FROMPATH_""""
"RTN","MAGDIR81",126,0)
 . S MSG(2)="which is partially in the database (#"_MAGIEN_") for"
"RTN","MAGDIR81",127,0)
 . S MSG(3)=""""_$P($G(^MAG(2005,MAGIEN,0)),"^")_""""
"RTN","MAGDIR81",128,0)
 . S MSG(4)="Acquired on "_Y
"RTN","MAGDIR81",129,0)
 . S MSG(5)="UID = "_IMAGEUID
"RTN","MAGDIR81",130,0)
 . D ERROR^MAGDIR8("STORE","1 Image partially in the database",.MSG,$T(+0))
"RTN","MAGDIR81",131,0)
 . Q
"RTN","MAGDIR81",132,0)
 ;
"RTN","MAGDIR81",133,0)
 ; lookup the study by ACNUMB/CASENUMB, get DFN, and double-check PID
"RTN","MAGDIR81",134,0)
 S ERRCODE=$$LOOKUP Q:ERRCODE ERRCODE
"RTN","MAGDIR81",135,0)
 ;
"RTN","MAGDIR81",136,0)
 S PIDCHECK=$$PIDCHECK^MAGDIR8A()
"RTN","MAGDIR81",137,0)
 I PIDCHECK D  Q "-2 Image Association Problem" ; didn't find the study
"RTN","MAGDIR81",138,0)
 . N CASETEXT,COLUMNS,MFGR,MODEL,MODIEN,OFFSET,ROWS
"RTN","MAGDIR81",139,0)
 . ; formulate error message
"RTN","MAGDIR81",140,0)
 . K MSG
"RTN","MAGDIR81",141,0)
 . S MSG(1)=PIDCHECK
"RTN","MAGDIR81",142,0)
 . S (ROWS,COLUMNS,OFFSET,MODIEN,MFGR,MODEL,CASETEXT)=""
"RTN","MAGDIR81",143,0)
 . D MOVE^MAGDLBAA
"RTN","MAGDIR81",144,0)
 . Q
"RTN","MAGDIR81",145,0)
 ; create the group pointer
"RTN","MAGDIR81",146,0)
 I IMGSVC="RAD" D  Q:ERRCODE ERRCODE
"RTN","MAGDIR81",147,0)
 . S ERRCODE=$$GROUP^MAGDIR9A
"RTN","MAGDIR81",148,0)
 . Q
"RTN","MAGDIR81",149,0)
 E  I IMGSVC="CON" D  Q:ERRCODE ERRCODE
"RTN","MAGDIR81",150,0)
 . S ERRCODE=$$GROUP^MAGDIR9E
"RTN","MAGDIR81",151,0)
 . Q
"RTN","MAGDIR81",152,0)
 E  D  Q 3  ; undefined imaging service - same as error #4 in LOOKUP
"RTN","MAGDIR81",153,0)
 . K MSG
"RTN","MAGDIR81",154,0)
 . S MSG(1)="Undefined Imaging Service: "_IMGSVC
"RTN","MAGDIR81",155,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR81",156,0)
 . Q
"RTN","MAGDIR81",157,0)
 ;
"RTN","MAGDIR81",158,0)
 Q 0
"RTN","MAGDIR81",159,0)
 ;
"RTN","MAGDIR81",160,0)
MULTFRAM ; Handle additional images in a multiframe object
"RTN","MAGDIR81",161,0)
 ; Get the information from the first image for the additional ones
"RTN","MAGDIR81",162,0)
 ;
"RTN","MAGDIR81",163,0)
 N DIQUIET,INAME,MAG0,MAG40,MAG100,MAGPACS
"RTN","MAGDIR81",164,0)
 S MAG0=^MAG(2005,MAGIEN,0),MAG1=$G(^(1)),MAG2=$G(^(2))
"RTN","MAGDIR81",165,0)
 S MAG40=$G(^MAG(2005,MAGIEN,40)),MAG100=$G(^(100))
"RTN","MAGDIR81",166,0)
 S MAGPACS=$G(^MAG(2005,MAGIEN,"PACS"))
"RTN","MAGDIR81",167,0)
 S INAME=$P(MAG0,"^",1) ; field .01
"RTN","MAGDIR81",168,0)
 S PNAMEVAH=$P(INAME,"  ",1),DCMPID=$P(INAME,"  ",2)
"RTN","MAGDIR81",169,0)
 S DFN=$P(MAG0,"^",7) ; field 5
"RTN","MAGDIR81",170,0)
 S MAGGP=$P(MAG0,"^",10) ; field 14
"RTN","MAGDIR81",171,0)
 S DATETIME=$P(MAG2,"^",5) ; field 15
"RTN","MAGDIR81",172,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR81",173,0)
 S FILEDATA("PARENT FILE")=$P(MAG2,"^",6) ; field 16
"RTN","MAGDIR81",174,0)
 S FILEDATA("PARENT IEN")=$P(MAG2,"^",7) ; field 17
"RTN","MAGDIR81",175,0)
 S FILEDATA("PARENT FILE PTR")=$P(MAG2,"^",8) ; field 18
"RTN","MAGDIR81",176,0)
 S FILEDATA("RAD REPORT")=$P(MAGPACS,"^",2) ; field 61
"RTN","MAGDIR81",177,0)
 S FILEDATA("RAD PROC PTR")=$P(MAGPACS,"^",3) ; field 62
"RTN","MAGDIR81",178,0)
 S FILEDATA("PACKAGE")=$P(MAG40,"^",1) ; field 40
"RTN","MAGDIR81",179,0)
 ; field 41 is not needed
"RTN","MAGDIR81",180,0)
 S FILEDATA("TYPE")=$P(MAG40,"^",3) ; field 42
"RTN","MAGDIR81",181,0)
 S FILEDATA("PROC/EVENT")=$P(MAG40,"^",4) ; field 43
"RTN","MAGDIR81",182,0)
 S FILEDATA("SPEC/SUBSPEC")=$P(MAG40,"^",5) ; field 44
"RTN","MAGDIR81",183,0)
 S FILEDATA("ACQUISITION DEVICE")=$P(MAG100,"^",4) ; field 107
"RTN","MAGDIR81",184,0)
 S PROCDESC=$P(MAG2,"^",4) ; field 10
"RTN","MAGDIR81",185,0)
 ; S X="" F  S X=$O(FILEDATA(X)) Q:X=""  I FILEDATA(X)="" K FILEDATA(X)
"RTN","MAGDIR81",186,0)
 I PROCDESC?.E1" (#".N1")" S PROCDESC=$P(PROCDESC," (#")
"RTN","MAGDIR81",187,0)
 ; lookup patient in VistA database - needed to build VADM array
"RTN","MAGDIR81",188,0)
 S DIQUIET=1 D DEM^VADPT
"RTN","MAGDIR81",189,0)
 Q
"RTN","MAGDIR81",190,0)
 ;
"RTN","MAGDIR81",191,0)
LOOKUP() ; lookup the patient/study using cross-reference
"RTN","MAGDIR81",192,0)
 I IMGSVC="RAD" D
"RTN","MAGDIR81",193,0)
 . D RADLKUP^MAGDIR8A
"RTN","MAGDIR81",194,0)
 . Q
"RTN","MAGDIR81",195,0)
 E  I IMGSVC="CON" D
"RTN","MAGDIR81",196,0)
 . S ACNUMB=CASENUMB
"RTN","MAGDIR81",197,0)
 . D CONLKUP^MAGDIR8A
"RTN","MAGDIR81",198,0)
 . Q
"RTN","MAGDIR81",199,0)
 E  D  Q 4 ; undefined imaging service - same as error #3 in NEWIMAGE
"RTN","MAGDIR81",200,0)
 . K MSG
"RTN","MAGDIR81",201,0)
 . S MSG(1)="Undefined Imaging Service: "_IMGSVC
"RTN","MAGDIR81",202,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR81",203,0)
 . Q
"RTN","MAGDIR81",204,0)
 Q 0
"RTN","MAGDIR82")
0^10^B60062731
"RTN","MAGDIR82",1,0)
MAGDIR82 ;WOIFO/PMK - Read a DICOM image file ; 07/02/2004  08:05
"RTN","MAGDIR82",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDIR82",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR82",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR82",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR82",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR82",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR82",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR82",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR82",10,0)
 ;; |                                                               |
"RTN","MAGDIR82",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR82",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR82",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR82",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR82",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR82",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR82",17,0)
 ;;
"RTN","MAGDIR82",18,0)
 ;
"RTN","MAGDIR82",19,0)
 ; M2MB server
"RTN","MAGDIR82",20,0)
 ;
"RTN","MAGDIR82",21,0)
 ; This routine is invoked by the ^MAGDIR8 to update statistics & add
"RTN","MAGDIR82",22,0)
 ; an image to the background processor and auto-router queues.
"RTN","MAGDIR82",23,0)
 ; 
"RTN","MAGDIR82",24,0)
 ; There are two entry points, one for the "ACQUIRED" RESULT item, and
"RTN","MAGDIR82",25,0)
 ; the other (POSTPROC) for the "PROCESSED" RESULT item.
"RTN","MAGDIR82",26,0)
 ; 
"RTN","MAGDIR82",27,0)
ACQUIRED ; update image acquisition statistics
"RTN","MAGDIR82",28,0)
 N INSTNAME,LOCATION,STATUS
"RTN","MAGDIR82",29,0)
 S STATUS=$P(ARGS,"|",1)
"RTN","MAGDIR82",30,0)
 S LOCATION=$P(ARGS,"|",2)
"RTN","MAGDIR82",31,0)
 S INSTNAME=$P(ARGS,"|",3)
"RTN","MAGDIR82",32,0)
 D COUNT("ACQUIRED")
"RTN","MAGDIR82",33,0)
 Q
"RTN","MAGDIR82",34,0)
 ;
"RTN","MAGDIR82",35,0)
POSTPROC ; update image processing statistics and add to BP & AR queues
"RTN","MAGDIR82",36,0)
 N COUNTFLG,ERRCODE,EVAL,I,IMAGEPTR,INSTNAME,LOCATION,MSG,STATUS
"RTN","MAGDIR82",37,0)
 S STATUS=$P(ARGS,"|",1)
"RTN","MAGDIR82",38,0)
 S LOCATION=$P(ARGS,"|",2)
"RTN","MAGDIR82",39,0)
 S INSTNAME=$P(ARGS,"|",3)
"RTN","MAGDIR82",40,0)
 S IMAGEPTR=$P(ARGS,"|",4)
"RTN","MAGDIR82",41,0)
 S COUNTFLG=$P(ARGS,"|",5) ; zero for multiframe images
"RTN","MAGDIR82",42,0)
 S EVAL=$P(ARGS,"|",6)
"RTN","MAGDIR82",43,0)
 I COUNTFLG D COUNT("PROCESSED")
"RTN","MAGDIR82",44,0)
 ;
"RTN","MAGDIR82",45,0)
 S ERRCODE=""
"RTN","MAGDIR82",46,0)
 ; 
"RTN","MAGDIR82",47,0)
 I $$CONSOLID^MAGDFCNV D
"RTN","MAGDIR82",48,0)
 . D POSTPRO2 ; consolidation code
"RTN","MAGDIR82",49,0)
 . Q
"RTN","MAGDIR82",50,0)
 E  D
"RTN","MAGDIR82",51,0)
 . D POSTPRO1 ; non-consolidation code
"RTN","MAGDIR82",52,0)
 . Q
"RTN","MAGDIR82",53,0)
 I ERRCODE="" D
"RTN","MAGDIR82",54,0)
 . D RESULT^MAGDIR8(OPCODE,"|"_$P(ARGS,"|",2,999))
"RTN","MAGDIR82",55,0)
 . Q
"RTN","MAGDIR82",56,0)
 E  D
"RTN","MAGDIR82",57,0)
 . D ERROR^MAGDIR8(OPCODE,ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR82",58,0)
 . Q
"RTN","MAGDIR82",59,0)
 Q 
"RTN","MAGDIR82",60,0)
 ;
"RTN","MAGDIR82",61,0)
POSTPRO1 ; non-consolidation code version of post processing
"RTN","MAGDIR82",62,0)
 ; add the image to the jukebox queue
"RTN","MAGDIR82",63,0)
 D:'$$JUKEBOX^MAGBAPI(IMAGEPTR)
"RTN","MAGDIR82",64,0)
 . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",65,0)
 . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",66,0)
 . S I=I+1,MSG(I)="JUKEBOX QUEUE CREATION ERROR:"
"RTN","MAGDIR82",67,0)
 . S I=I+1,MSG(I)="An image has not been entered into the jukebox queue."
"RTN","MAGDIR82",68,0)
 . S I=I+1,MSG(I)="Image pointer: "_IMAGEPTR
"RTN","MAGDIR82",69,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",70,0)
 . S ERRCODE=-401
"RTN","MAGDIR82",71,0)
 . Q
"RTN","MAGDIR82",72,0)
 ;
"RTN","MAGDIR82",73,0)
 D:EVAL  ; Add the image to the routing evaluator queue
"RTN","MAGDIR82",74,0)
 . D WARNROUT(0)
"RTN","MAGDIR82",75,0)
 . D:$$EVAL^MAGBAPI(IMAGEPTR)<0
"RTN","MAGDIR82",76,0)
 . . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",77,0)
 . . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",78,0)
 . . S I=I+1,MSG(I)="AUTOROUTER EVALUATION QUEUE CREATION ERROR:"
"RTN","MAGDIR82",79,0)
 . . S I=I+1,MSG(I)="An image could not be evaluated for autorouting purposes."
"RTN","MAGDIR82",80,0)
 . . S I=I+1,MSG(I)="Image pointer: "_IMAGEPTR
"RTN","MAGDIR82",81,0)
 . . S I=I+1,MSG(I)="Error code is """_Z_"""."
"RTN","MAGDIR82",82,0)
 . . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",83,0)
 . . S ERRCODE=ERRCODE_"-402"
"RTN","MAGDIR82",84,0)
 . . Q
"RTN","MAGDIR82",85,0)
 . Q
"RTN","MAGDIR82",86,0)
 Q
"RTN","MAGDIR82",87,0)
 ;
"RTN","MAGDIR82",88,0)
POSTPRO2 ; consolidation code version of post processing
"RTN","MAGDIR82",89,0)
 N PLACE
"RTN","MAGDIR82",90,0)
 S PLACE=$O(^MAG(2006.1,"B",LOCATION,""))
"RTN","MAGDIR82",91,0)
 ;
"RTN","MAGDIR82",92,0)
 ; add the image to the jukebox queue
"RTN","MAGDIR82",93,0)
 D:'$$JUKEBOX^MAGBAPI(IMAGEPTR,PLACE)
"RTN","MAGDIR82",94,0)
 . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",95,0)
 . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",96,0)
 . S I=I+1,MSG(I)="JUKEBOX QUEUE CREATION ERROR:"
"RTN","MAGDIR82",97,0)
 . S I=I+1,MSG(I)="An image has not been entered into the jukebox queue."
"RTN","MAGDIR82",98,0)
 . S I=I+1,MSG(I)="Image pointer: "_IMAGEPTR_"   Location: "_LOCATION
"RTN","MAGDIR82",99,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",100,0)
 . S ERRCODE=-403
"RTN","MAGDIR82",101,0)
 . Q
"RTN","MAGDIR82",102,0)
 ;
"RTN","MAGDIR82",103,0)
 D:EVAL  ; Add the image to the routing evaluator queue
"RTN","MAGDIR82",104,0)
 . D WARNROUT(PLACE)
"RTN","MAGDIR82",105,0)
 . D:$$EVAL^MAGBAPI(IMAGEPTR,PLACE)<0
"RTN","MAGDIR82",106,0)
 . . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",107,0)
 . . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",108,0)
 . . S I=I+1,MSG(I)="AUTOROUTER EVALUATION QUEUE CREATION ERROR:"
"RTN","MAGDIR82",109,0)
 . . S I=I+1,MSG(I)="An image could not be evaluated for autorouting purposes."
"RTN","MAGDIR82",110,0)
 . . S I=I+1,MSG(I)="Image pointer: "_IMAGEPTR_"   Place: "_PLACE
"RTN","MAGDIR82",111,0)
 . . S I=I+1,MSG(I)="Error code is """_Z_"""."
"RTN","MAGDIR82",112,0)
 . . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",113,0)
 . . S ERRCODE=ERRCODE_"-404"
"RTN","MAGDIR82",114,0)
 . . Q
"RTN","MAGDIR82",115,0)
 . Q
"RTN","MAGDIR82",116,0)
 Q
"RTN","MAGDIR82",117,0)
 ;
"RTN","MAGDIR82",118,0)
COUNT(STEP) ; update today's count
"RTN","MAGDIR82",119,0)
 N %,D2,%H,NOW,PC,TODAY,X
"RTN","MAGDIR82",120,0)
 D NOW^%DTC S TODAY=X,NOW=%
"RTN","MAGDIR82",121,0)
 L +^MAGDAUDT(2006.5762,TODAY)
"RTN","MAGDIR82",122,0)
 D:'$D(^MAGDAUDT(2006.5752,TODAY))
"RTN","MAGDIR82",123,0)
 . S X=$G(^MAGDAUDT(2006.5762,0))
"RTN","MAGDIR82",124,0)
 . S $P(X,"^",1,2)="DICOM INSTRUMENT STATISTICS^2006.5762"
"RTN","MAGDIR82",125,0)
 . S $P(X,"^",3)=TODAY
"RTN","MAGDIR82",126,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDIR82",127,0)
 . S ^MAGDAUDT(2006.5762,0)=X
"RTN","MAGDIR82",128,0)
 . S ^MAGDAUDT(2006.5762,TODAY,0)=TODAY
"RTN","MAGDIR82",129,0)
 . S ^MAGDAUDT(2006.5762,"B",TODAY,TODAY)=""
"RTN","MAGDIR82",130,0)
 . Q 
"RTN","MAGDIR82",131,0)
 S D2=$O(^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,"B",INSTNAME,""))
"RTN","MAGDIR82",132,0)
 D:'D2
"RTN","MAGDIR82",133,0)
 . S D2=$O(^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1," "),-1)+1
"RTN","MAGDIR82",134,0)
 . S X=$G(^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,0))
"RTN","MAGDIR82",135,0)
 . S $P(X,"^",2)="2006.576211"
"RTN","MAGDIR82",136,0)
 . S $P(X,"^",3)=D2
"RTN","MAGDIR82",137,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDIR82",138,0)
 . S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,0)=LOCATION
"RTN","MAGDIR82",139,0)
 . S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,0)=X
"RTN","MAGDIR82",140,0)
 . S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,D2,0)=INSTNAME
"RTN","MAGDIR82",141,0)
 . S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,"B",INSTNAME,D2)=""
"RTN","MAGDIR82",142,0)
 . Q
"RTN","MAGDIR82",143,0)
 S X=$G(^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,D2,0))
"RTN","MAGDIR82",144,0)
 S PC=$S(STEP="ACQUIRED":2,STEP="PROCESSED":4,1:6)
"RTN","MAGDIR82",145,0)
 S $P(X,"^",PC)=$P(X,"^",PC)+1
"RTN","MAGDIR82",146,0)
 S $P(X,"^",PC+1)=NOW
"RTN","MAGDIR82",147,0)
 S ^MAGDAUDT(2006.5762,TODAY,1,LOCATION,1,D2,0)=X
"RTN","MAGDIR82",148,0)
 L -^MAGDAUDT(2006.5762,TODAY)
"RTN","MAGDIR82",149,0)
 Q
"RTN","MAGDIR82",150,0)
 ;
"RTN","MAGDIR82",151,0)
WARNROUT(PLACE) N LAST,X1,X2,X3
"RTN","MAGDIR82",152,0)
 D:'PLACE
"RTN","MAGDIR82",153,0)
 . S PLACE=$$PLACE^MAGDRPC2(LOCATION)
"RTN","MAGDIR82",154,0)
 . Q
"RTN","MAGDIR82",155,0)
 S LAST=$G(^MAG(2006.1,+PLACE,"LASTROUTE"))
"RTN","MAGDIR82",156,0)
 S (X2,X3)=LAST\1 D:X3
"RTN","MAGDIR82",157,0)
 . N DEST,E,I,PRI,T
"RTN","MAGDIR82",158,0)
 . S X1=DT D ^%DTC Q:X<7
"RTN","MAGDIR82",159,0)
 . S X2=$P(LAST,"^",2) Q:X2'<DT  ; Only send one message per day
"RTN","MAGDIR82",160,0)
 . S (E,T,I)=0 F  S I=$O(^MAGQUEUE(2006.03,"C",PLACE,"EVAL",I)) Q:I=""  S E=E+1
"RTN","MAGDIR82",161,0)
 . S PRI="" F  S PRI=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI)) Q:PRI=""  D
"RTN","MAGDIR82",162,0)
 . . S DEST="" F  S DEST=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DEST)) Q:DEST=""  D
"RTN","MAGDIR82",163,0)
 . . . S I="" F  S I=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DEST,I)) Q:I=""  S T=T+1
"RTN","MAGDIR82",164,0)
 . . . Q
"RTN","MAGDIR82",165,0)
 . . Q
"RTN","MAGDIR82",166,0)
 . S I=$O(MSG(" "),-1)
"RTN","MAGDIR82",167,0)
 . S:I I=I+1,MSG(I)=" "
"RTN","MAGDIR82",168,0)
 . S I=I+1,MSG(I)="More than a week has elapsed since "_(X3#100)_"-"_$P("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"," ",X3\100#100)_"-"_(X3\10000+1700)
"RTN","MAGDIR82",169,0)
 . S I=I+1,MSG(I)="when the last activity occurred that is related"
"RTN","MAGDIR82",170,0)
 . S I=I+1,MSG(I)="to the processing of Routed Image files."
"RTN","MAGDIR82",171,0)
 . S I=I+1,MSG(I)=" "
"RTN","MAGDIR82",172,0)
 . S I=I+1,MSG(I)="The site parameter for ""This is a Routing Site"" is"
"RTN","MAGDIR82",173,0)
 . S I=I+1,MSG(I)="currently turned ON."
"RTN","MAGDIR82",174,0)
 . S I=I+1,MSG(I)="If this site is no longer actively routing image files"
"RTN","MAGDIR82",175,0)
 . S I=I+1,MSG(I)="this site parameter must be turned OFF."
"RTN","MAGDIR82",176,0)
 . S I=I+1,MSG(I)="This parameter needs to be turned OFF on each VistA"
"RTN","MAGDIR82",177,0)
 . S I=I+1,MSG(I)="DICOM Gateway that processes incoming images."
"RTN","MAGDIR82",178,0)
 . S I=I+1,MSG(I)=" "
"RTN","MAGDIR82",179,0)
 . S I=I+1,MSG(I)="There are currently "_E_" entr"_$S(E=1:"y",1:"ies")
"RTN","MAGDIR82",180,0)
 . S I=I+1,MSG(I)="waiting to be processed in the evaluation queue."
"RTN","MAGDIR82",181,0)
 . S I=I+1,MSG(I)=" "
"RTN","MAGDIR82",182,0)
 . S I=I+1,MSG(I)="There are currently "_T_" entr"_$S(T=1:"y",1:"ies")
"RTN","MAGDIR82",183,0)
 . S I=I+1,MSG(I)="waiting to be processed in the transmission queue."
"RTN","MAGDIR82",184,0)
 . S I=I+1,MSG(I)=" "
"RTN","MAGDIR82",185,0)
 . S I=I+1,MSG(I)="If this site is still a routing site, then both the"
"RTN","MAGDIR82",186,0)
 . S I=I+1,MSG(I)="Routing Rule Evaluator and the Routing Transmitter"
"RTN","MAGDIR82",187,0)
 . S I=I+1,MSG(I)="must be restarted."
"RTN","MAGDIR82",188,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR82",189,0)
 . S ERRCODE=ERRCODE_"-405"
"RTN","MAGDIR82",190,0)
 . S $P(^MAG(2006.1,PLACE,"LASTROUTE"),"^",2)=DT
"RTN","MAGDIR82",191,0)
 . Q
"RTN","MAGDIR82",192,0)
 Q
"RTN","MAGDIR82",193,0)
 ;
"RTN","MAGDIR83")
0^11^B22465931
"RTN","MAGDIR83",1,0)
MAGDIR83 ;WOIFO/PMK - Read a DICOM image file ; 05/06/2004  06:32
"RTN","MAGDIR83",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDIR83",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR83",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR83",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR83",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR83",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR83",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR83",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR83",10,0)
 ;; |                                                               |
"RTN","MAGDIR83",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR83",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR83",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR83",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR83",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR83",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR83",17,0)
 ;;
"RTN","MAGDIR83",18,0)
 ;
"RTN","MAGDIR83",19,0)
 ; M2MB server
"RTN","MAGDIR83",20,0)
 ;
"RTN","MAGDIR83",21,0)
 ; This routine is invoked by the ^MAGDIR8 to update handle DICOM
"RTN","MAGDIR83",22,0)
 ; CORRECT functions, that is, the "CORRECT" REQUEST item.
"RTN","MAGDIR83",23,0)
 ; 
"RTN","MAGDIR83",24,0)
 ; This is a four-step process:
"RTN","MAGDIR83",25,0)
 ;
"RTN","MAGDIR83",26,0)
 ;    1) The "QUERY" record is sent, to obtain a list of corrected
"RTN","MAGDIR83",27,0)
 ;       images.  The list is sent back to the gateway in a list of
"RTN","MAGDIR83",28,0)
 ;       "CORRECT" RESULT items, each with new patient/study values.
"RTN","MAGDIR83",29,0)
 ;       If the images are to be deleted, the list will contain "DELETE"
"RTN","MAGDIR83",30,0)
 ;       instead of "FIXED" RESULT items.
"RTN","MAGDIR83",31,0)
 ;    2) The gateway processes each corrected/deleted image, one at a
"RTN","MAGDIR83",32,0)
 ;       time.
"RTN","MAGDIR83",33,0)
 ;    3) The gateway sends a "PROCESSED | IMAGE" record is sent back to
"RTN","MAGDIR83",34,0)
 ;       the server for each corrected image, so that each can be
"RTN","MAGDIR83",35,0)
 ;       deleted from the list.  (This is called an RPC Callback.)
"RTN","MAGDIR83",36,0)
 ;    4) Finally, the gateway sends a "PROCESSED | STUDY" record back to
"RTN","MAGDIR83",37,0)
 ;       the server to delete the remainder of the study from the list.
"RTN","MAGDIR83",38,0)
 ; 
"RTN","MAGDIR83",39,0)
ENTRY ; update image acquisition statistics
"RTN","MAGDIR83",40,0)
 N LOCATION,MACHID,STATUS
"RTN","MAGDIR83",41,0)
 S STATUS=$P(ARGS,"|",1)
"RTN","MAGDIR83",42,0)
 I STATUS="QUERY" D
"RTN","MAGDIR83",43,0)
 . D QUERY
"RTN","MAGDIR83",44,0)
 . Q
"RTN","MAGDIR83",45,0)
 E  I STATUS="PROCESSED" D
"RTN","MAGDIR83",46,0)
 . D PROCESS
"RTN","MAGDIR83",47,0)
 . Q
"RTN","MAGDIR83",48,0)
 Q
"RTN","MAGDIR83",49,0)
 ;
"RTN","MAGDIR83",50,0)
QUERY ; get the list of DICOM CORRECTED files
"RTN","MAGDIR83",51,0)
 N DELFLAG,ICOUNT,IMAGEIEN,INSTNAME,LOCATION,MACHID
"RTN","MAGDIR83",52,0)
 N NEW,NEWNAME,NEWPID,NEWACN,NIMAGES,STUDYIEN,STUDYUID
"RTN","MAGDIR83",53,0)
 ;
"RTN","MAGDIR83",54,0)
 S LOCATION=$P(ARGS,"|",2),MACHID=$P(ARGS,"|",3)
"RTN","MAGDIR83",55,0)
 S NIMAGES=0,STUDYIEN=""
"RTN","MAGDIR83",56,0)
 F  S STUDYIEN=$O(^MAGD(2006.575,"AFX",LOCATION,MACHID,STUDYIEN)) Q:'STUDYIEN  Q:NIMAGES>24  D
"RTN","MAGDIR83",57,0)
 . S DELFLAG=^MAGD(2006.575,"AFX",LOCATION,MACHID,STUDYIEN)
"RTN","MAGDIR83",58,0)
 . S INSTNAME=$P(^MAGD(2006.575,STUDYIEN,"AMFG"),"^",1)
"RTN","MAGDIR83",59,0)
 . S STUDYUID=^MAGD(2006.575,STUDYIEN,"ASUID")
"RTN","MAGDIR83",60,0)
 . S NEW=^MAGD(2006.575,STUDYIEN,"FIXD")
"RTN","MAGDIR83",61,0)
 . S NEWNAME=$P(NEW,"^",3),NEWPID=$P(NEW,"^",4),NEWACN=$P(NEW,"^",5)
"RTN","MAGDIR83",62,0)
 . S IMAGEIEN=STUDYIEN ; need to process the first image
"RTN","MAGDIR83",63,0)
 . D QUERY1("NONE") ; first time - defer deleting this node
"RTN","MAGDIR83",64,0)
 . S ICOUNT=0
"RTN","MAGDIR83",65,0)
 . F  S ICOUNT=$O(^MAGD(2006.575,STUDYIEN,"RLATE",ICOUNT)) Q:'ICOUNT  Q:NIMAGES>24  D
"RTN","MAGDIR83",66,0)
 . . S IMAGEIEN=^MAGD(2006.575,STUDYIEN,"RLATE",ICOUNT,0)
"RTN","MAGDIR83",67,0)
 . . D QUERY1("IMAGE") ; regular image - delete it
"RTN","MAGDIR83",68,0)
 . . S NIMAGES=NIMAGES+1
"RTN","MAGDIR83",69,0)
 . . Q
"RTN","MAGDIR83",70,0)
 . I 'ICOUNT D  ; end of study reached - delete first image & study
"RTN","MAGDIR83",71,0)
 . . S IMAGEIEN=STUDYIEN ; need to delete first image and the study
"RTN","MAGDIR83",72,0)
 . . D QUERY1("STUDY") ; second time, now delete the study entry
"RTN","MAGDIR83",73,0)
 . . Q
"RTN","MAGDIR83",74,0)
 . Q
"RTN","MAGDIR83",75,0)
 Q
"RTN","MAGDIR83",76,0)
 ;
"RTN","MAGDIR83",77,0)
QUERY1(DELTYPE) ; build one CORRECT Result PROCESS array node
"RTN","MAGDIR83",78,0)
 N FROMPATH,X
"RTN","MAGDIR83",79,0)
 S FROMPATH=$P(^MAGD(2006.575,IMAGEIEN,0),"^",1)
"RTN","MAGDIR83",80,0)
 S X=$S(DELFLAG="D":"DELETE",1:"FIXED")
"RTN","MAGDIR83",81,0)
 S X=X_"|"_IMAGEIEN_"|"_STUDYIEN_"|"_DELTYPE_"|"_INSTNAME
"RTN","MAGDIR83",82,0)
 S X=X_"|"_FROMPATH_"|"_STUDYUID_"|"_NEWNAME_"|"_NEWPID_"|"_NEWACN
"RTN","MAGDIR83",83,0)
 D RESULT^MAGDIR8("CORRECT",X)
"RTN","MAGDIR83",84,0)
 Q
"RTN","MAGDIR83",85,0)
 ;
"RTN","MAGDIR83",86,0)
 ; -----------------------  RPC CALLBACK ------------------------------
"RTN","MAGDIR83",87,0)
 ;
"RTN","MAGDIR83",88,0)
PROCESS ; delete the processed corrected entry from the ^MAGD(2006.575) file
"RTN","MAGDIR83",89,0)
 N DELTYPE,FILEPATH,IMAGEIEN,LOCATION,RLATEIEN,STUDYIEN,X
"RTN","MAGDIR83",90,0)
 S IMAGEIEN=$P(ARGS,"|",2),STUDYIEN=$P(ARGS,"|",3)
"RTN","MAGDIR83",91,0)
 S DELTYPE=$P(ARGS,"|",4),FILEPATH=$P(ARGS,"|",6) ; ignore piece #5
"RTN","MAGDIR83",92,0)
 I DELTYPE'="NONE" D  ; don't delete the first image/study in the list
"RTN","MAGDIR83",93,0)
 . I DELTYPE="IMAGE" D  ; delete this image
"RTN","MAGDIR83",94,0)
 . . ; remove the related image cross-references
"RTN","MAGDIR83",95,0)
 . . S RLATEIEN=$O(^MAGD(2006.575,STUDYIEN,"RLATE","B",IMAGEIEN,""))
"RTN","MAGDIR83",96,0)
 . . I RLATEIEN D
"RTN","MAGDIR83",97,0)
 . . . K ^MAGD(2006.575,STUDYIEN,"RLATE",RLATEIEN)
"RTN","MAGDIR83",98,0)
 . . . K ^MAGD(2006.575,STUDYIEN,"RLATE","B",IMAGEIEN,RLATEIEN)
"RTN","MAGDIR83",99,0)
 . . . S $P(^(0),"^",4)=$P(^MAGD(2006.575,STUDYIEN,"RLATE",0),"^",4)-1
"RTN","MAGDIR83",100,0)
 . . . Q
"RTN","MAGDIR83",101,0)
 . . Q
"RTN","MAGDIR83",102,0)
 . E  I DELTYPE="STUDY" D  ; delete the first image and study information
"RTN","MAGDIR83",103,0)
 . . ; remove the "AFX" and "F" cross-references
"RTN","MAGDIR83",104,0)
 . . S STUDYUID=$P(ARGS,"|",7),MACHID=$P(ARGS,"|",8)
"RTN","MAGDIR83",105,0)
 . . S LOCATION=$P(ARGS,"|",9)
"RTN","MAGDIR83",106,0)
 . . K ^MAGD(2006.575,"AFX",LOCATION,MACHID,STUDYIEN)
"RTN","MAGDIR83",107,0)
 . . K ^MAGD(2006.575,"F",LOCATION,STUDYUID,STUDYIEN)
"RTN","MAGDIR83",108,0)
 . . Q
"RTN","MAGDIR83",109,0)
 . K ^MAGD(2006.575,IMAGEIEN)
"RTN","MAGDIR83",110,0)
 . K ^MAGD(2006.575,"B",FILEPATH,IMAGEIEN)
"RTN","MAGDIR83",111,0)
 . S $P(^(0),"^",4)=$P(^MAGD(2006.575,0),"^",4)-1
"RTN","MAGDIR83",112,0)
 . Q
"RTN","MAGDIR83",113,0)
 S X="COMPLETE"_"|"_IMAGEIEN_"|"_STUDYIEN_"|"_DELTYPE
"RTN","MAGDIR83",114,0)
 D RESULT^MAGDIR8("CORRECT",X)
"RTN","MAGDIR83",115,0)
 Q
"RTN","MAGDIR85")
0^12^B4149874
"RTN","MAGDIR85",1,0)
MAGDIR85 ;WOIFO/PMK - Read a DICOM image file ; 05/06/2004  06:32
"RTN","MAGDIR85",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDIR85",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR85",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR85",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR85",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR85",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR85",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR85",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR85",10,0)
 ;; |                                                               |
"RTN","MAGDIR85",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR85",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR85",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR85",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR85",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR85",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR85",17,0)
 ;;
"RTN","MAGDIR85",18,0)
 Q
"RTN","MAGDIR85",19,0)
 ; M2MB server
"RTN","MAGDIR85",20,0)
 ;
"RTN","MAGDIR85",21,0)
 ; This routine handles the "ROLLBACK" RESULT item.
"RTN","MAGDIR85",22,0)
 ; 
"RTN","MAGDIR85",23,0)
ENTRY ; remove ^MAG(2005,IMAGEPTR) entry because of a fatal problem
"RTN","MAGDIR85",24,0)
 N ERRORMSG,IMAGEPTR,ROLLBACK
"RTN","MAGDIR85",25,0)
 S IMAGEPTR=$P(ARGS,"|",2),U="^"
"RTN","MAGDIR85",26,0)
 D DELETE^MAGGTID(.ROLLBACK,IMAGEPTR_"^1",1) ; invoke Garrett's routine
"RTN","MAGDIR85",27,0)
 I ROLLBACK(0)?1"1^".E D
"RTN","MAGDIR85",28,0)
 . S ERRORMSG="0||"_IMAGEPTR
"RTN","MAGDIR85",29,0)
 . Q
"RTN","MAGDIR85",30,0)
 E  D
"RTN","MAGDIR85",31,0)
 . S ERRORMSG="-1|"_$P(ROLLBACK(0),"^",2,999)_"|"_IMAGEPTR
"RTN","MAGDIR85",32,0)
 . Q
"RTN","MAGDIR85",33,0)
 D RESULT^MAGDIR8("ROLLBACK",ERRORMSG)
"RTN","MAGDIR85",34,0)
 Q
"RTN","MAGDIR9A")
0^13^B43886625
"RTN","MAGDIR9A",1,0)
MAGDIR9A ;WOIFO/PMK - Read a DICOM image file ; 05/06/2004  06:32
"RTN","MAGDIR9A",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDIR9A",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9A",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR9A",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR9A",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR9A",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR9A",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR9A",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR9A",10,0)
 ;; |                                                               |
"RTN","MAGDIR9A",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR9A",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR9A",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR9A",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR9A",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR9A",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR9A",17,0)
 ;;
"RTN","MAGDIR9A",18,0)
 ;
"RTN","MAGDIR9A",19,0)
 ; M2MB server
"RTN","MAGDIR9A",20,0)
 ;
"RTN","MAGDIR9A",21,0)
 ; This routine creates a ^mag(2005) group entry and links it to the
"RTN","MAGDIR9A",22,0)
 ; associated radiology report
"RTN","MAGDIR9A",23,0)
 ;
"RTN","MAGDIR9A",24,0)
 ;   XXXXXX      XX    XXXXXX
"RTN","MAGDIR9A",25,0)
 ;    XX  XX    XXXX    XX  XX
"RTN","MAGDIR9A",26,0)
 ;    XX  XX   XX  XX   XX  XX
"RTN","MAGDIR9A",27,0)
 ;    XXXXX    XX  XX   XX  XX
"RTN","MAGDIR9A",28,0)
 ;    XX XX    XXXXXX   XX  XX
"RTN","MAGDIR9A",29,0)
 ;    XX  XX   XX  XX   XX  XX
"RTN","MAGDIR9A",30,0)
 ;   XXX  XX   XX  XX  XXXXXX
"RTN","MAGDIR9A",31,0)
 ;
"RTN","MAGDIR9A",32,0)
GROUP() ; entry point from ^MAGDIR81
"RTN","MAGDIR9A",33,0)
 N ACQDEVP ;-- pointer to acquisition device file (#2006.04)
"RTN","MAGDIR9A",34,0)
 N DA ;------ fileman variable
"RTN","MAGDIR9A",35,0)
 N ERRCODE ;- error trap code
"RTN","MAGDIR9A",36,0)
 N GROUP ;--- array to pass group data to ^MAGGTIA
"RTN","MAGDIR9A",37,0)
 N GROUPDFN ; DFN value from image group entry for double checking
"RTN","MAGDIR9A",38,0)
 N P ;-------- scratch variable (pointer to ACQUISITION DEVICE file)
"RTN","MAGDIR9A",39,0)
 N RACNE ;--- external "3rd level" subscript in ^RADPT
"RTN","MAGDIR9A",40,0)
 N RACNI ;--- internal "3rd level" subscript in ^RADPT
"RTN","MAGDIR9A",41,0)
 N RADFN ;--- radiology package's DFN
"RTN","MAGDIR9A",42,0)
 N RADTE ;--- external "2nd level" subscript in ^RADPT
"RTN","MAGDIR9A",43,0)
 N RADTI ;--- internal "2nd level" subscript in ^RADPT
"RTN","MAGDIR9A",44,0)
 N RARPT ;--- 1st level node in ^RARPT for report (ie, the ien)
"RTN","MAGDIR9A",45,0)
 N RARPT3 ;-- 3rd level node for 2005 multiple under ^RARPT's report
"RTN","MAGDIR9A",46,0)
 N RARPTDFN ; DFN value from ^RARPT for double checking
"RTN","MAGDIR9A",47,0)
 N HIT,P200584,X,Y ; scratch variables
"RTN","MAGDIR9A",48,0)
 ;
"RTN","MAGDIR9A",49,0)
 S ERRCODE=""
"RTN","MAGDIR9A",50,0)
 ;
"RTN","MAGDIR9A",51,0)
 S (RADFN,DA(2))=DFN ; patient DFN variables
"RTN","MAGDIR9A",52,0)
 S RADTI=RADATA("RADPT2") ; case subscript
"RTN","MAGDIR9A",53,0)
 I RADTI="" D  Q ERRCODE
"RTN","MAGDIR9A",54,0)
 . K MSG
"RTN","MAGDIR9A",55,0)
 . S MSG(1)="No radiology case number specified for patient "_DFN
"RTN","MAGDIR9A",56,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",57,0)
 . S ERRCODE=-301
"RTN","MAGDIR9A",58,0)
 . Q
"RTN","MAGDIR9A",59,0)
 ;
"RTN","MAGDIR9A",60,0)
 S RADTE=$TR(RADATA("RADPT2"),"0123456789","9876543210")
"RTN","MAGDIR9A",61,0)
 S RACNI=RADATA("RADPT3")
"RTN","MAGDIR9A",62,0)
 S RACNE=$S(CASENUMB["-":$P(CASENUMB,"-",2),1:CASENUMB) ; short case #
"RTN","MAGDIR9A",63,0)
 ;
"RTN","MAGDIR9A",64,0)
 ; check for the existence of the entry in ^RADPT (redundant)
"RTN","MAGDIR9A",65,0)
 I '$D(^RADPT(RADFN,"DT",RADTI,0)) D  Q ERRCODE ; can't process further
"RTN","MAGDIR9A",66,0)
 . K MSG
"RTN","MAGDIR9A",67,0)
 . S MSG(1)="Radiology case "_RADTI_" is not in ^RADPT("_RADFN_")"
"RTN","MAGDIR9A",68,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",69,0)
 . S ERRCODE=-302
"RTN","MAGDIR9A",70,0)
 . Q
"RTN","MAGDIR9A",71,0)
 ;
"RTN","MAGDIR9A",72,0)
 ; check for the existence of the report pointer
"RTN","MAGDIR9A",73,0)
 S RARPT=$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),"^",17)
"RTN","MAGDIR9A",74,0)
 ; if the report does not yet exist, create it
"RTN","MAGDIR9A",75,0)
 D:RARPT=""
"RTN","MAGDIR9A",76,0)
 . N RACN
"RTN","MAGDIR9A",77,0)
 . S RACN=RACNE D CREATE^RARIC ; create the report
"RTN","MAGDIR9A",78,0)
 . Q
"RTN","MAGDIR9A",79,0)
 ;
"RTN","MAGDIR9A",80,0)
 ; If RARPT is no longer defined at this point, this means
"RTN","MAGDIR9A",81,0)
 ; that we're dealing with an old study, and the report has
"RTN","MAGDIR9A",82,0)
 ; been archived and purged.
"RTN","MAGDIR9A",83,0)
 ;
"RTN","MAGDIR9A",84,0)
 I '$G(RARPT) D  Q ERRCODE
"RTN","MAGDIR9A",85,0)
 . K MSG
"RTN","MAGDIR9A",86,0)
 . S MSG(1)="IMAGE GROUP CREATION ERROR:"
"RTN","MAGDIR9A",87,0)
 . S MSG(2)="Radiology Report has been archived and purged."
"RTN","MAGDIR9A",88,0)
 . S MSG(3)="Patient "_$G(RADFN)_", Date "_$G(RADTI)_", Case "_$G(RACNI)
"RTN","MAGDIR9A",89,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",90,0)
 . S ERRCODE=-303
"RTN","MAGDIR9A",91,0)
 . Q
"RTN","MAGDIR9A",92,0)
 ;
"RTN","MAGDIR9A",93,0)
 ; double check the DFN value from ^RARPT to make sure its right
"RTN","MAGDIR9A",94,0)
 S RARPTDFN=$P($G(^RARPT(RARPT,0)),"^",2)
"RTN","MAGDIR9A",95,0)
 I RARPTDFN'=DFN D  Q ERRCODE ; fatal error
"RTN","MAGDIR9A",96,0)
 . D RADMISS^MAGDIRVE($T(+0),DFN,RARPT,RARPTDFN)
"RTN","MAGDIR9A",97,0)
 . S ERRCODE=-304
"RTN","MAGDIR9A",98,0)
 . Q
"RTN","MAGDIR9A",99,0)
 ;
"RTN","MAGDIR9A",100,0)
 ; initialize FILEDATA for GROUP and IMAGE
"RTN","MAGDIR9A",101,0)
 ; get the acquisition device pointer (file 2005, field 107)
"RTN","MAGDIR9A",102,0)
 S ACQDEVP=$$ACQDEV^MAGDFCNV(MFGR,MODEL,INSTLOC)
"RTN","MAGDIR9A",103,0)
 S FILEDATA("ACQUISITION DEVICE")=ACQDEVP
"RTN","MAGDIR9A",104,0)
 ;
"RTN","MAGDIR9A",105,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR9A",106,0)
 S FILEDATA("PARENT FILE")=74
"RTN","MAGDIR9A",107,0)
 S FILEDATA("PARENT IEN")=RARPT
"RTN","MAGDIR9A",108,0)
 S FILEDATA("RAD REPORT")=RARPT
"RTN","MAGDIR9A",109,0)
 S FILEDATA("RAD PROC PTR")=RADATA("PROCIEN")
"RTN","MAGDIR9A",110,0)
 S FILEDATA("PACKAGE")="RAD"
"RTN","MAGDIR9A",111,0)
 S X=$S(MODALITY="NM":"NUCLEAR MEDICINE",1:"RADIOLOGY")
"RTN","MAGDIR9A",112,0)
 S P200584=$O(^MAG(2005.84,"B",X,""))
"RTN","MAGDIR9A",113,0)
 S X=$$FIELD43^MAGXMA(MODALITY,P200584,.Y)
"RTN","MAGDIR9A",114,0)
 S FILEDATA("PROC/EVENT")=$S(X=0:Y,1:"")
"RTN","MAGDIR9A",115,0)
 S FILEDATA("SPEC/SUBSPEC")=P200584
"RTN","MAGDIR9A",116,0)
 ;
"RTN","MAGDIR9A",117,0)
 ; find the corresponding image group node under the report
"RTN","MAGDIR9A",118,0)
 S (HIT,RARPT3)=0
"RTN","MAGDIR9A",119,0)
 F  S RARPT3=$O(^RARPT(RARPT,2005,RARPT3)) Q:'RARPT3  D  Q:HIT  Q:ERRCODE
"RTN","MAGDIR9A",120,0)
 . S MAGGP=+$G(^RARPT(RARPT,2005,RARPT3,0)) ; get imaging group pointer
"RTN","MAGDIR9A",121,0)
 . S GROUPDFN=$P($G(^MAG(2005,MAGGP,0)),"^",7) ; check image DFN value
"RTN","MAGDIR9A",122,0)
 . I GROUPDFN'=DFN D  ; fatal error
"RTN","MAGDIR9A",123,0)
 . . D MISMATCH^MAGDIRVE($T(+0),DFN,MAGGP)
"RTN","MAGDIR9A",124,0)
 . . S ERRCODE=-305
"RTN","MAGDIR9A",125,0)
 . . Q
"RTN","MAGDIR9A",126,0)
 . E  I $P($G(^MAG(2005,MAGGP,0)),"^",6)=11 D
"RTN","MAGDIR9A",127,0)
 . . ; check to see that this group is for the same acquisition device
"RTN","MAGDIR9A",128,0)
 . . S P=$P($G(^MAG(2005,MAGGP,100)),"^",4) I P,P=ACQDEVP S HIT=1
"RTN","MAGDIR9A",129,0)
 . . Q
"RTN","MAGDIR9A",130,0)
 . Q
"RTN","MAGDIR9A",131,0)
 ;
"RTN","MAGDIR9A",132,0)
 I ERRCODE Q ERRCODE ; fatal image DFN problem
"RTN","MAGDIR9A",133,0)
 ;
"RTN","MAGDIR9A",134,0)
 I 'HIT D  Q:ERRCODE ERRCODE ; the 2005 node does not yet exist
"RTN","MAGDIR9A",135,0)
 . ; create the imaging group
"RTN","MAGDIR9A",136,0)
 . K GROUP
"RTN","MAGDIR9A",137,0)
 . S GROUP(1)=".01^"_PNAMEVAH_"  "_DCMPID_"  "_PROCDESC
"RTN","MAGDIR9A",138,0)
 . S GROUP(2)="3^11" ; Object Type -- XRAY Group
"RTN","MAGDIR9A",139,0)
 . S GROUP(3)="5^"_DFN
"RTN","MAGDIR9A",140,0)
 . S GROUP(4)="6^RAD "_FILEDATA("MODALITY")
"RTN","MAGDIR9A",141,0)
 . S GROUP(5)="2005.04^0"
"RTN","MAGDIR9A",142,0)
 . S GROUP(6)="10^"_PROCDESC
"RTN","MAGDIR9A",143,0)
 . S GROUP(7)="15^"_DATETIME
"RTN","MAGDIR9A",144,0)
 . S GROUP(8)="16^"_FILEDATA("PARENT FILE")
"RTN","MAGDIR9A",145,0)
 . S GROUP(9)="17^"_FILEDATA("PARENT IEN")
"RTN","MAGDIR9A",146,0)
 . S GROUP(10)="60^"_STUDYUID
"RTN","MAGDIR9A",147,0)
 . S GROUP(11)="61^"_FILEDATA("RAD REPORT")
"RTN","MAGDIR9A",148,0)
 . S GROUP(12)="62^"_FILEDATA("RAD PROC PTR")
"RTN","MAGDIR9A",149,0)
 . S GROUP(13)=".05^"_INSTLOC
"RTN","MAGDIR9A",150,0)
 . S GROUP(14)="40^"_FILEDATA("PACKAGE")
"RTN","MAGDIR9A",151,0)
 . S GROUP(15)="41^"_$O(^MAG(2005.82,"B","CLIN",""))
"RTN","MAGDIR9A",152,0)
 . S GROUP(16)="42^"_FILEDATA("TYPE")
"RTN","MAGDIR9A",153,0)
 . S GROUP(17)="43^"_FILEDATA("PROC/EVENT")
"RTN","MAGDIR9A",154,0)
 . S GROUP(18)="44^"_FILEDATA("SPEC/SUBSPEC")
"RTN","MAGDIR9A",155,0)
 . S GROUP(19)="107^"_FILEDATA("ACQUISITION DEVICE")
"RTN","MAGDIR9A",156,0)
 . D ADD^MAGGTIA(.RETURN,.GROUP)
"RTN","MAGDIR9A",157,0)
 . S MAGGP=+RETURN
"RTN","MAGDIR9A",158,0)
 . I 'MAGGP D  Q  ; fatal error
"RTN","MAGDIR9A",159,0)
 . . K MSG
"RTN","MAGDIR9A",160,0)
 . . S MSG(1)="IMAGE GROUP CREATION ERROR:"
"RTN","MAGDIR9A",161,0)
 . . S MSG(2)=$P(RETURN,"^",2,999)
"RTN","MAGDIR9A",162,0)
 . . D BADERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",163,0)
 . . S ERRCODE=-306
"RTN","MAGDIR9A",164,0)
 . . Q
"RTN","MAGDIR9A",165,0)
 . ;
"RTN","MAGDIR9A",166,0)
 . I MAGGP<LASTIMG D  Q  ; fatal last image pointer error
"RTN","MAGDIR9A",167,0)
 . . D GROUPPTR^MAGDIRVE($T(+0),MAGGP,LASTIMG)
"RTN","MAGDIR9A",168,0)
 . . S ERRCODE=-307
"RTN","MAGDIR9A",169,0)
 . . Q
"RTN","MAGDIR9A",170,0)
 . ;
"RTN","MAGDIR9A",171,0)
 . ; store the cross-reference for the report
"RTN","MAGDIR9A",172,0)
 . D PTR^RARIC
"RTN","MAGDIR9A",173,0)
 . Q
"RTN","MAGDIR9A",174,0)
 ;
"RTN","MAGDIR9A",175,0)
 I 'MAGGP D  Q ERRCODE ; fatal error
"RTN","MAGDIR9A",176,0)
 . K MSG
"RTN","MAGDIR9A",177,0)
 . S MSG(1)="IMAGE GROUP LOOKUP ERROR:"
"RTN","MAGDIR9A",178,0)
 . S MSG(2)="Looking for 2005 cross reference in ^RARPT("_RARPT_")"
"RTN","MAGDIR9A",179,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR9A",180,0)
 . S ERRCODE=-308
"RTN","MAGDIR9A",181,0)
 . Q
"RTN","MAGDIR9A",182,0)
 Q 0
"RTN","MAGDIRVE")
0^14^B66702010
"RTN","MAGDIRVE",1,0)
MAGDIRVE ;WOIFO/PMK - Serious Fatal Image Processing Error Messages ; 09/08/2004  07:31
"RTN","MAGDIRVE",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDIRVE",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIRVE",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIRVE",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIRVE",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIRVE",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIRVE",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIRVE",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIRVE",10,0)
 ;; |                                                               |
"RTN","MAGDIRVE",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIRVE",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIRVE",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIRVE",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIRVE",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIRVE",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIRVE",17,0)
 ;;
"RTN","MAGDIRVE",18,0)
 Q
"RTN","MAGDIRVE",19,0)
 ;
"RTN","MAGDIRVE",20,0)
 ; new version for RPC client-server image processing error messages
"RTN","MAGDIRVE",21,0)
 ;
"RTN","MAGDIRVE",22,0)
MAGZERO(RTN,LASTIEN,LASTIMG) ; from ^MAGDIR1B/^MAGDIR84 for bad ^MAG(2005)
"RTN","MAGDIRVE",23,0)
 N TITLE
"RTN","MAGDIRVE",24,0)
 K MSG
"RTN","MAGDIRVE",25,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - IMAGE FILE CORRUPTION"
"RTN","MAGDIRVE",26,0)
 S MSG(2)="The ^MAG(2005) file has been corrupted so that new images will"
"RTN","MAGDIRVE",27,0)
 S MSG(3)="overwrite old ones and general image database inconsistency"
"RTN","MAGDIRVE",28,0)
 S MSG(4)="will result."
"RTN","MAGDIRVE",29,0)
 S MSG(5)=""
"RTN","MAGDIRVE",30,0)
 S MSG(6)="Latest internal entry number processed: "
"RTN","MAGDIRVE",31,0)
 S MSG(6)=MSG(6)_LASTIMG ; ^MAGDICOM(2006.563,1,"LAST IMAGE POINTER")
"RTN","MAGDIRVE",32,0)
 S MSG(7)="Bad ^MAG(2005,0) internal entry number: "_LASTIEN
"RTN","MAGDIRVE",33,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",34,0)
 Q
"RTN","MAGDIRVE",35,0)
 ;
"RTN","MAGDIRVE",36,0)
ZERONODE(RTN,LASTIEN,LASTPTR,FILE,FILENAME) ; from ^MAGDIR1/^MAGDIR84
"RTN","MAGDIRVE",37,0)
 ; invoked for an arbitrary file corrupted value
"RTN","MAGDIRVE",38,0)
 N TITLE,ZERONODE
"RTN","MAGDIRVE",39,0)
 K MSG
"RTN","MAGDIRVE",40,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - "_FILE_" FILE CORRUPTION"
"RTN","MAGDIRVE",41,0)
 S MSG(2)="The "_FILENAME_" file has been corrupted so that new reports will"
"RTN","MAGDIRVE",42,0)
 S MSG(3)="overwrite old ones and general image/report database inconsistency"
"RTN","MAGDIRVE",43,0)
 S MSG(4)="will result."
"RTN","MAGDIRVE",44,0)
 S MSG(5)=""
"RTN","MAGDIRVE",45,0)
 S MSG(6)="Latest internal entry number processed: "
"RTN","MAGDIRVE",46,0)
 S MSG(6)=MSG(6)_LASTPTR ; from ^MAGDICOM(2006.563,1,"LAST ... POINTER")
"RTN","MAGDIRVE",47,0)
 S ZERONODE=$S(FILE[")":$P(FILE,")")_",0)",1:FILE_"(0)")
"RTN","MAGDIRVE",48,0)
 S MSG(7)="Bad "_ZERONODE_" internal entry number: "_LASTIEN
"RTN","MAGDIRVE",49,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",50,0)
 Q
"RTN","MAGDIRVE",51,0)
 ;
"RTN","MAGDIRVE",52,0)
OBJECT(RTN,MAGGP) ; from ^MAGDIR2B/^MAGDIR9B
"RTN","MAGDIRVE",53,0)
 N TITLE
"RTN","MAGDIRVE",54,0)
 K MSG
"RTN","MAGDIRVE",55,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - WRONG GROUP OBJECT TYPE"
"RTN","MAGDIRVE",56,0)
 S MSG(2)="The group entry in ^MAG(2005) does not have the proper group"
"RTN","MAGDIRVE",57,0)
 S MSG(3)="object type."
"RTN","MAGDIRVE",58,0)
 S MSG(4)=""
"RTN","MAGDIRVE",59,0)
 S MSG(5)="The expected value is 11.  The value in the group entry is "
"RTN","MAGDIRVE",60,0)
 S MSG(5)=MSG(5)_$P($G(^MAG(2005,MAGGP,0),"^^^^^not defined"),"^",6)_"."
"RTN","MAGDIRVE",61,0)
 S MSG(6)=""
"RTN","MAGDIRVE",62,0)
 S MSG(7)="Internal entry number of incorrect group: "_MAGGP
"RTN","MAGDIRVE",63,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",64,0)
 Q
"RTN","MAGDIRVE",65,0)
 ;
"RTN","MAGDIRVE",66,0)
MISMATCH(RTN,DFN,MAGGP) ; from ^MAGDIR2B/E & ^MAGDIR9B/E for a patient mismatch
"RTN","MAGDIRVE",67,0)
 N GROUPDFN,TITLE
"RTN","MAGDIRVE",68,0)
 K MSG
"RTN","MAGDIRVE",69,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - PATIENT MISMATCH PROBLEM"
"RTN","MAGDIRVE",70,0)
 S GROUPDFN=$P($G(^MAG(2005,MAGGP,0)),"^",7)
"RTN","MAGDIRVE",71,0)
 S MSG(2)="The image and the group point to different patients."
"RTN","MAGDIRVE",72,0)
 S MSG(3)=""
"RTN","MAGDIRVE",73,0)
 S MSG(4)="The Image points to PATIENT file internal entry number "_DFN
"RTN","MAGDIRVE",74,0)
 S MSG(5)=$$PATDEMO(DFN)
"RTN","MAGDIRVE",75,0)
 S MSG(6)=""
"RTN","MAGDIRVE",76,0)
 S MSG(7)="The Group points to PATIENT file internal entry number "_GROUPDFN
"RTN","MAGDIRVE",77,0)
 S MSG(8)=$$PATDEMO(GROUPDFN)
"RTN","MAGDIRVE",78,0)
 S MSG(9)=""
"RTN","MAGDIRVE",79,0)
 S MSG(10)="Internal entry number of group: ^MAG(2005,"_MAGGP_")"
"RTN","MAGDIRVE",80,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",81,0)
 Q
"RTN","MAGDIRVE",82,0)
 ;
"RTN","MAGDIRVE",83,0)
PATDEMO(DFN) ; display patient demographics
"RTN","MAGDIRVE",84,0)
 N %,DISYS,DTIME,VA,VADM,X
"RTN","MAGDIRVE",85,0)
 S X=""
"RTN","MAGDIRVE",86,0)
 I 'DFN S X="<null DFN>"
"RTN","MAGDIRVE",87,0)
 E  D
"RTN","MAGDIRVE",88,0)
 . D DEM^VADPT
"RTN","MAGDIRVE",89,0)
 . S X=$G(VADM(1))_"  |  "_$G(VA("PID")) ; name & id
"RTN","MAGDIRVE",90,0)
 . S X=X_" | "_$P($G(VADM(5)),"^",2)_" | "_$P($G(VADM(3)),"^",2) ; sex & dob
"RTN","MAGDIRVE",91,0)
 . Q
"RTN","MAGDIRVE",92,0)
 Q X ; name | id | sex | dob
"RTN","MAGDIRVE",93,0)
 ;
"RTN","MAGDIRVE",94,0)
RADMISS(RTN,DFN,RARPT,RARPTDFN) ; from ^MAGDIR2A/^MAGDIR9A for a patient mismatch
"RTN","MAGDIRVE",95,0)
 ; this is bad DFN value for the radiology report in ^RARPT
"RTN","MAGDIRVE",96,0)
 N TITLE
"RTN","MAGDIRVE",97,0)
 K MSG
"RTN","MAGDIRVE",98,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - RAD PATIENT/REPORT MISMATCH"
"RTN","MAGDIRVE",99,0)
 S MSG(2)="The image and the radiology report point to different patients."
"RTN","MAGDIRVE",100,0)
 S MSG(3)=""
"RTN","MAGDIRVE",101,0)
 S MSG(4)="The Image points to PATIENT file internal entry number "_DFN
"RTN","MAGDIRVE",102,0)
 S MSG(5)=$$PATDEMO(DFN)
"RTN","MAGDIRVE",103,0)
 S MSG(6)=""
"RTN","MAGDIRVE",104,0)
 S MSG(7)="The Rad Report points to PATIENT file internal entry number "_RARPTDFN
"RTN","MAGDIRVE",105,0)
 S MSG(8)=$$PATDEMO(RARPTDFN)
"RTN","MAGDIRVE",106,0)
 S MSG(9)=""
"RTN","MAGDIRVE",107,0)
 S MSG(10)="Internal entry number of report: ^RARPT("_RARPT_")"
"RTN","MAGDIRVE",108,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",109,0)
 Q
"RTN","MAGDIRVE",110,0)
 ;
"RTN","MAGDIRVE",111,0)
TIUMISS(RTN,DFN,TIUIEN,TIUDFN) ; from ^MAGDIR2E/^MAGDIR9E for a patient mismatch
"RTN","MAGDIRVE",112,0)
 ; this is bad DFN value for the consult/procedure request note in ^TIU(8925)
"RTN","MAGDIRVE",113,0)
 N TITLE
"RTN","MAGDIRVE",114,0)
 K MSG
"RTN","MAGDIRVE",115,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - TIU PATIENT/REPORT MISMATCH"
"RTN","MAGDIRVE",116,0)
 S MSG(2)="The image and the TIU note point to different patients."
"RTN","MAGDIRVE",117,0)
 S MSG(3)=""
"RTN","MAGDIRVE",118,0)
 S MSG(4)="The Image points to PATIENT file internal entry number "_DFN
"RTN","MAGDIRVE",119,0)
 S MSG(5)=$$PATDEMO(DFN)
"RTN","MAGDIRVE",120,0)
 S MSG(6)=""
"RTN","MAGDIRVE",121,0)
 S MSG(7)="The TIU note points to PATIENT file internal entry number "_TIUDFN
"RTN","MAGDIRVE",122,0)
 S MSG(8)=$$PATDEMO(TIUDFN)
"RTN","MAGDIRVE",123,0)
 S MSG(9)=""
"RTN","MAGDIRVE",124,0)
 S MSG(10)="Internal entry number of TIU note: ^TIU(8925,"_TIUIEN_")"
"RTN","MAGDIRVE",125,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",126,0)
 Q
"RTN","MAGDIRVE",127,0)
 ;
"RTN","MAGDIRVE",128,0)
TIUMISS2(RTN,TIUIEN1,TIUIEN2,TIUXDIEN,MAGGP) ; from ^MAGDIR2E/^MAGDIR9E - TIU mismatch
"RTN","MAGDIRVE",129,0)
 ; mismatch between TIU, TIU External Data File, and the image group  
"RTN","MAGDIRVE",130,0)
 N TITLE
"RTN","MAGDIRVE",131,0)
 K MSG
"RTN","MAGDIRVE",132,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - TIU/IMAGE GROUP MISMATCH"
"RTN","MAGDIRVE",133,0)
 S MSG(2)="The image group and TIU point to different notes."
"RTN","MAGDIRVE",134,0)
 S MSG(3)=""
"RTN","MAGDIRVE",135,0)
 S MSG(4)="TIU points to TUI note ien #"_TIUIEN1
"RTN","MAGDIRVE",136,0)
 S MSG(5)="The image points to TIU note ien #"_TIUIEN2
"RTN","MAGDIRVE",137,0)
 S MSG(6)="TIU External Data File (8925.91) ien #"_TIUXDIEN
"RTN","MAGDIRVE",138,0)
 S MSG(7)="points to image group ien #"_MAGGP
"RTN","MAGDIRVE",139,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",140,0)
 Q
"RTN","MAGDIRVE",141,0)
 ;
"RTN","MAGDIRVE",142,0)
TMPMISS(RTN,PARENTFP,MAGGP) ; from ^MAGDIR2E/^MAGDIR9E
"RTN","MAGDIRVE",143,0)
 ; the image group does not have 2006.5839 for the PARENT FILE
"RTN","MAGDIRVE",144,0)
 N TITLE
"RTN","MAGDIRVE",145,0)
 K MSG
"RTN","MAGDIRVE",146,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - IMAGE GROUP MISMATCH"
"RTN","MAGDIRVE",147,0)
 S MSG(2)="The image group does not point to PARENT FILE 2006.5839."
"RTN","MAGDIRVE",148,0)
 S MSG(3)=""
"RTN","MAGDIRVE",149,0)
 S MSG(4)="The image group should point to PARENT FILE 2006.5839."
"RTN","MAGDIRVE",150,0)
 S MSG(5)="Instead it point to PARENT FILE #"_PARENTFP
"RTN","MAGDIRVE",151,0)
 S MSG(6)="The image group is ^MAG(2005,"_MAGGP_")"
"RTN","MAGDIRVE",152,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",153,0)
 Q
"RTN","MAGDIRVE",154,0)
 ;
"RTN","MAGDIRVE",155,0)
IMAGEPTR(RTN,IMAGEPTR,LASTIMG) ; from ^MAGDIR2B/^MAGDIR9B for a corrupted image pointer value
"RTN","MAGDIRVE",156,0)
 N TITLE
"RTN","MAGDIRVE",157,0)
 K MSG
"RTN","MAGDIRVE",158,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - IMAGE ENTRY NUMBER PROBLEM"
"RTN","MAGDIRVE",159,0)
 S MSG(2)="The internal entry number for this image is less than that of the"
"RTN","MAGDIRVE",160,0)
 S MSG(3)="last processed image.  This will cause new images to overwrite"
"RTN","MAGDIRVE",161,0)
 S MSG(4)="old ones and general image database inconsistency will result."
"RTN","MAGDIRVE",162,0)
 S MSG(5)=""
"RTN","MAGDIRVE",163,0)
 S MSG(6)="Latest internal entry number processed: "
"RTN","MAGDIRVE",164,0)
 S MSG(6)=MSG(6)_LASTIMG ; ^MAGDICOM(2006.563,1,"LAST IMAGE POINTER")
"RTN","MAGDIRVE",165,0)
 S MSG(7)="Bad internal entry number of new image: "_IMAGEPTR
"RTN","MAGDIRVE",166,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",167,0)
 Q
"RTN","MAGDIRVE",168,0)
 ;
"RTN","MAGDIRVE",169,0)
GROUPPTR(RTN,MAGGP,LASTIMG) ; from ^MAGDIR2A/E & ^MAGDIR9A/E and ^MAGDMED3 for bad group pointer
"RTN","MAGDIRVE",170,0)
 N TITLE
"RTN","MAGDIRVE",171,0)
 K MSG
"RTN","MAGDIRVE",172,0)
 S TITLE="DICOM IMAGE PROCESSING ERROR - GROUP ENTRY NUMBER PROBLEM"
"RTN","MAGDIRVE",173,0)
 S MSG(2)="The internal entry number for this group is less than that of the"
"RTN","MAGDIRVE",174,0)
 S MSG(3)="last processed image.  This will cause new images to overwrite"
"RTN","MAGDIRVE",175,0)
 S MSG(4)="old ones and general image database inconsistency will result."
"RTN","MAGDIRVE",176,0)
 S MSG(5)=""
"RTN","MAGDIRVE",177,0)
 S MSG(6)="Latest internal entry number processed: "
"RTN","MAGDIRVE",178,0)
 S MSG(6)=MSG(6)_LASTIMG ; ^MAGDICOM(2006.563,1,"LAST IMAGE POINTER")
"RTN","MAGDIRVE",179,0)
 S MSG(7)="Bad internal entry number of new group: "_MAGGP
"RTN","MAGDIRVE",180,0)
 D BADERROR(RTN,TITLE,.MSG)
"RTN","MAGDIRVE",181,0)
 Q
"RTN","MAGDIRVE",182,0)
 ;
"RTN","MAGDIRVE",183,0)
BADERROR(RTN,TITLE,MSG) ; final common pathway for all msgs
"RTN","MAGDIRVE",184,0)
 ; invoked by other image processing error checking code as well
"RTN","MAGDIRVE",185,0)
 N I
"RTN","MAGDIRVE",186,0)
 S I=$O(MSG(" "),-1)
"RTN","MAGDIRVE",187,0)
 S MSG(1)=$G(MSG(1)) ; usually null
"RTN","MAGDIRVE",188,0)
 S MSG(I+1)="Gateway: """_$G(SYSTITLE,"<unknown>")_""""
"RTN","MAGDIRVE",189,0)
 S MSG(I+2)=""
"RTN","MAGDIRVE",190,0)
 S MSG(I+3)="          This is a VERY SERIOUS ERROR.  Image processing"
"RTN","MAGDIRVE",191,0)
 S MSG(I+4)="              will be halted until it is resolved."
"RTN","MAGDIRVE",192,0)
 S MSG(I+5)=""
"RTN","MAGDIRVE",193,0)
 S MSG(I+6)="Call IRM and the National VistA Support Help Desk (888) 596-HELP"
"RTN","MAGDIRVE",194,0)
 S MSG(I+7)=""
"RTN","MAGDIRVE",195,0)
 S MSG(I+8)="Problem detected by routine "_RTN_"."
"RTN","MAGDIRVE",196,0)
 S MSG(I+9)=""
"RTN","MAGDIRVE",197,0)
 S MSG("TITLE")=TITLE,MSG("CRITICAL")=1 ; send email to Silver Spring
"RTN","MAGDIRVE",198,0)
 Q
"RTN","MAGDIRVE",199,0)
 ;
"RTN","MAGDIRVE",200,0)
ERROR(RTN,TITLE,MSG) ; application error - local to the site - no email
"RTN","MAGDIRVE",201,0)
 N I
"RTN","MAGDIRVE",202,0)
 S I=$O(MSG(" "),-1)
"RTN","MAGDIRVE",203,0)
 S MSG(I+1)="Problem detected by routine "_RTN_"."
"RTN","MAGDIRVE",204,0)
 S MSG(I+2)=""
"RTN","MAGDIRVE",205,0)
 S MSG("TITLE")=TITLE,MSG("CRITICAL")=0 ; no email to Silver Spring
"RTN","MAGDIRVE",206,0)
 Q
"RTN","MAGDLB1")
0^15^B50516394
"RTN","MAGDLB1",1,0)
MAGDLB1 ;WOIFO/LB - Routine to fix failed DICOM entries ; 09/08/2004  07:32
"RTN","MAGDLB1",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDLB1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLB1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLB1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLB1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLB1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLB1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLB1",10,0)
 ;; |                                                               |
"RTN","MAGDLB1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLB1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLB1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLB1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLB1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLB1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB1",17,0)
 ;;
"RTN","MAGDLB1",18,0)
 Q
"RTN","MAGDLB1",19,0)
 ;
"RTN","MAGDLB1",20,0)
DISPLAY ;
"RTN","MAGDLB1",21,0)
 S OUT=0
"RTN","MAGDLB1",22,0)
 W !,"**************Processing entry**********"
"RTN","MAGDLB1",23,0)
 W !!?2,"PATIENT: ",PAT,?50,"SSN: ",PID,!,"RADIOLOGY CASE #: ",CASENO
"RTN","MAGDLB1",24,0)
 W !?2,"Equipment: ",MOD,?50,"Model: ",MODEL
"RTN","MAGDLB1",25,0)
 W !?2,"Date Processed: ",DATE,?50,"Problem with: ",REASON
"RTN","MAGDLB1",26,0)
 W !?2,"Comment: ",COMNT1
"RTN","MAGDLB1",27,0)
 W !?2,"Correcting file on Image gateway server ID: ",MACHID,!?5,FILE
"RTN","MAGDLB1",28,0)
 S MSG="Do you want to Correct this entry? "
"RTN","MAGDLB1",29,0)
 Q
"RTN","MAGDLB1",30,0)
NEWCASE ;
"RTN","MAGDLB1",31,0)
 S NEWDFN=$P(MAGDY,"^"),NEWNME=$P(MAGDY,"^",2),NEWSSN=$P(MAGDY,"^",3)
"RTN","MAGDLB1",32,0)
 S NEWCAS=$P(MAGDY,"^",4),NEWPROC=$P(MAGDY,"^",5),NEWDTI=$P(MAGDY,"^",6)
"RTN","MAGDLB1",33,0)
 S NEWMUL=$P(MAGDY,"^",7),NEWPIEN=$P(MAGDY,"^",8),PP=$P(MAGDY,"^",9)
"RTN","MAGDLB1",34,0)
 Q
"RTN","MAGDLB1",35,0)
ASK() ;
"RTN","MAGDLB1",36,0)
 N ANS,ASK
"RTN","MAGDLB1",37,0)
ASK1 S ASK="Y/N/D/Q"
"RTN","MAGDLB1",38,0)
 I $G(PREV)'=$G(MAGIEN),MAGTYPE="RAD" S ASK=ASK_"/P"
"RTN","MAGDLB1",39,0)
 W !,$G(MSG),"("_ASK_")// " R ANS:600
"RTN","MAGDLB1",40,0)
 I '$T!(ANS["^") Q "^"
"RTN","MAGDLB1",41,0)
 I ANS="" Q "N"
"RTN","MAGDLB1",42,0)
 I "YNDPQyndpq"'[$E(ANS) D  G ASK1
"RTN","MAGDLB1",43,0)
 . W !,"Please respond with one of the following codes."
"RTN","MAGDLB1",44,0)
 . W !,"Legend: Y=yes, N=no, D=delete, P=Previous entry, and Q=quit",!
"RTN","MAGDLB1",45,0)
 S ANS=$TR(ANS,"yndpq","YNDPQ")
"RTN","MAGDLB1",46,0)
 Q $E(ANS)
"RTN","MAGDLB1",47,0)
CHK ;remove any punctuation before doing comparison on SSN
"RTN","MAGDLB1",48,0)
 ;stop on 1st check.
"RTN","MAGDLB1",49,0)
 N OLD,I
"RTN","MAGDLB1",50,0)
 S OLD="" F I=1:1:$L(PID) I $E(PID,I)?1AN S OLD=OLD_$E(PID,I)
"RTN","MAGDLB1",51,0)
 I NEWSSN'=OLD D  Q
"RTN","MAGDLB1",52,0)
 . S MSG="Social Security numbers do not match. Update? "
"RTN","MAGDLB1",53,0)
 I NEWNME'=PAT D  Q
"RTN","MAGDLB1",54,0)
 . S MSG="Patient names do not match. Update? "
"RTN","MAGDLB1",55,0)
 ;Finally the problem is with the case number...either no longer in "C"
"RTN","MAGDLB1",56,0)
 ;xref or invalid number provided
"RTN","MAGDLB1",57,0)
 S MSG="Radiology case number different. Update? "
"RTN","MAGDLB1",58,0)
 Q
"RTN","MAGDLB1",59,0)
NEWDIS ;
"RTN","MAGDLB1",60,0)
 W !?2,"****Please review the following: *****"
"RTN","MAGDLB1",61,0)
 W !?2,"Previous name: ",PAT,!?2,"     New name: ",NEWNME
"RTN","MAGDLB1",62,0)
 W !?2,"Previous ssn: ",PID,!?2,"     New ssn: ",NEWSSN
"RTN","MAGDLB1",63,0)
 W !?2,"Previous case #: ",CASENO,!?2,"     New case #: ",NEWCAS
"RTN","MAGDLB1",64,0)
 I $L($G(PP)) W !?15,"Case number selected: ",PP
"RTN","MAGDLB1",65,0)
 ; Variable PP already has text message about being part of printset.
"RTN","MAGDLB1",66,0)
 Q
"RTN","MAGDLB1",67,0)
UPDT ;
"RTN","MAGDLB1",68,0)
 N GWLOC ; -- gateway location
"RTN","MAGDLB1",69,0)
 W !,"Will change the following: " D NEWDIS
"RTN","MAGDLB1",70,0)
 W !,"Are you sure you want to correct this entry? " S %=2 D YN^DICN
"RTN","MAGDLB1",71,0)
 I %=-1!(%=2) S OUT=1 Q
"RTN","MAGDLB1",72,0)
 W !,"Updating the file."
"RTN","MAGDLB1",73,0)
 S NEWDTIM=$TR(NEWDTI,"0123456789","9876543210")
"RTN","MAGDLB1",74,0)
 S ^MAGD(2006.575,MAGIEN,"FIXD")="1^"_NEWDFN_"^"_NEWNME_"^"_NEWSSN_"^"_NEWCAS_"^"_NEWDTI_"^"_NEWMUL_"^"_NEWDTIM W "."
"RTN","MAGDLB1",75,0)
 S ^MAGD(2006.575,MAGIEN,"FIXPR")=NEWPIEN_"^"_NEWPROC W "."
"RTN","MAGDLB1",76,0)
 ;Same as ^radpt(newdfn,"DT",newdti,"P",newmul,0) & ^RAMIS(71,newpien,0)
"RTN","MAGDLB1",77,0)
 S MACHID=$S(MACHID="":"A",1:MACHID) ; server ID
"RTN","MAGDLB1",78,0)
 S GWLOC=$P($G(^MAGD(2006.575,MAGIEN,1)),"^",5)
"RTN","MAGDLB1",79,0)
 I GWLOC S ^MAGD(2006.575,"AFX",GWLOC,MACHID,MAGIEN)="" W "."
"RTN","MAGDLB1",80,0)
 E  W !,"Gateway place not defined on image entry "_MAGIEN_", continuing.."
"RTN","MAGDLB1",81,0)
 ;Xref to loop & process entries; processing will be minimal.
"RTN","MAGDLB1",82,0)
 S MAGFIX(MAGIEN)="F"
"RTN","MAGDLB1",83,0)
 Q
"RTN","MAGDLB1",84,0)
SETDEL ;Entry to be deleted
"RTN","MAGDLB1",85,0)
 N GWLOC ; -- gateway location
"RTN","MAGDLB1",86,0)
 D LOGERR I ANS="^" S OUT=1 Q
"RTN","MAGDLB1",87,0)
 S GWLOC=$P($G(^MAGD(2006.575,MAGIEN,1)),"^",5)
"RTN","MAGDLB1",88,0)
 I GWLOC S ^MAGD(2006.575,"AFX",GWLOC,MACHID,MAGIEN)="D" W "."
"RTN","MAGDLB1",89,0)
 E  W !,"Gateway place not defined on this image entry "_MAGIEN_", continuing.."
"RTN","MAGDLB1",90,0)
 S $P(^MAGD(2006.575,MAGIEN,0),"^",6)="1"
"RTN","MAGDLB1",91,0)
 S ^MAGD(2006.575,MAGIEN,"FIXD")=1
"RTN","MAGDLB1",92,0)
 S MAGFIX(MAGIEN)="D"
"RTN","MAGDLB1",93,0)
 Q
"RTN","MAGDLB1",94,0)
LOGERR ;Need to record error
"RTN","MAGDLB1",95,0)
 N DIR,DIRUT,DTOUT,ENTRY,I,MAGERR,MAGOUT,X,Y,WHY,WHO
"RTN","MAGDLB1",96,0)
 W !! F I=1:1:80 W "*"
"RTN","MAGDLB1",97,0)
 W !,"*** Will log in error log (file 2006.599). ****"
"RTN","MAGDLB1",98,0)
 D NOW^%DTC
"RTN","MAGDLB1",99,0)
 S DIR(0)="F^3:30"
"RTN","MAGDLB1",100,0)
 S DIR("A")="Reason for deletion"
"RTN","MAGDLB1",101,0)
 S DIR("A",1)="Please enter a reason for deleting."
"RTN","MAGDLB1",102,0)
 S DIR("A",2)="For example: TEST PATIENT"
"RTN","MAGDLB1",103,0)
 D ^DIR
"RTN","MAGDLB1",104,0)
 I $D(DIRUT)!($D(DTOUT))!(Y="") D  S ANS="^" Q
"RTN","MAGDLB1",105,0)
 . W !,"Can not delete if a reason is not provided."
"RTN","MAGDLB1",106,0)
 . Q
"RTN","MAGDLB1",107,0)
 S WHY=Y,WHO=$G(DUZ)
"RTN","MAGDLB1",108,0)
 I WHO D 
"RTN","MAGDLB1",109,0)
 . D GETS^DIQ(200,DUZ,".01","E","MAGOUT","MAGERR")
"RTN","MAGDLB1",110,0)
 . Q:$D(MAGERR("DIERR"))
"RTN","MAGDLB1",111,0)
 . S WHO=$G(MAGOUT(200,DUZ_",",.01,"E"))
"RTN","MAGDLB1",112,0)
 I WHO="" S WHO="UNKNOWN"
"RTN","MAGDLB1",113,0)
 I '$D(^MAGD(2006.599,0)) D
"RTN","MAGDLB1",114,0)
 . S ^MAGD(2006.599,0)="Dicom Error Log^2006.599^^"
"RTN","MAGDLB1",115,0)
 . Q
"RTN","MAGDLB1",116,0)
 S ENTRY=$P(^MAGD(2006.599,0),"^",3)+1
"RTN","MAGDLB1",117,0)
 S $P(^MAGD(2006.599,0),"^",3)=ENTRY
"RTN","MAGDLB1",118,0)
 S $P(^MAGD(2006.599,0),"^",4)=$P(^MAGD(2006.599,0),"^",4)+1
"RTN","MAGDLB1",119,0)
 S ^MAGD(2006.599,ENTRY,0)=%_"^"_WHY_"^"_FILE_"^"_MODEL
"RTN","MAGDLB1",120,0)
 S ^MAGD(2006.599,ENTRY,1)=WHO_"^"_PAT_"^"_PID_"^"_CASENO_"^"_MACHID
"RTN","MAGDLB1",121,0)
 S ^MAGD(2006.599,"B",%,ENTRY)=""
"RTN","MAGDLB1",122,0)
 Q
"RTN","MAGDLB1",123,0)
SET ;
"RTN","MAGDLB1",124,0)
 S MAGTYPE=$P(^MAGD(2006.575,MAGIEN,"TYPE"),"^")
"RTN","MAGDLB1",125,0)
 Q:$P($G(^MAGD(2006.575,MAGIEN,"FIXD")),"^")  ; Already fixed.
"RTN","MAGDLB1",126,0)
 ; Only process Radiology images...medicine images done by other rtns.
"RTN","MAGDLB1",127,0)
 I MAGTYPE'["RAD" Q
"RTN","MAGDLB1",128,0)
 S DATA=^MAGD(2006.575,MAGIEN,0)
"RTN","MAGDLB1",129,0)
 S FILE=$P(^MAGD(2006.575,MAGIEN,0),"^")
"RTN","MAGDLB1",130,0)
 S DATA1=^MAGD(2006.575,MAGIEN,1) ; Case no. info
"RTN","MAGDLB1",131,0)
 S DATA2=^MAGD(2006.575,MAGIEN,"AMFG") ; Modality info
"RTN","MAGDLB1",132,0)
 S PAT=$P(DATA,"^",4),PID=$P(DATA,"^",3),REASON=$P(DATA,"^",2)
"RTN","MAGDLB1",133,0)
 S MOD=$P(DATA2,"^"),MODEL=$P(DATA2,"^",6)
"RTN","MAGDLB1",134,0)
 S CASENO=$P(DATA1,"^",2),MACHID=$P(DATA1,"^",4)
"RTN","MAGDLB1",135,0)
 S Y=$P(DATA1,"^",3) X ^DD("DD") S DATE=Y
"RTN","MAGDLB1",136,0)
 S COMNT1=$G(^MAGD(2006.575,MAGIEN,"ACSTXT")) ; 1st line comment.
"RTN","MAGDLB1",137,0)
 S MACHID=$P(DATA1,"^",4),GWLOC=$P(DATA2,"^",9)
"RTN","MAGDLB1",138,0)
 S ANS="" D DISPLAY S ANS=$$ASK
"RTN","MAGDLB1",139,0)
 I ANS="Q"!(ANS["^") S (OOUT,OUT)=1 D SETPREV Q
"RTN","MAGDLB1",140,0)
 I ANS="N" S OUT=1 D SETPREV Q
"RTN","MAGDLB1",141,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDLB1",142,0)
 I ANS="D" D SETDEL,SETPREV Q
"RTN","MAGDLB1",143,0)
 Q:OUT
"RTN","MAGDLB1",144,0)
 K MAGDY W !," Lookup by case number or patient name"
"RTN","MAGDLB1",145,0)
LOOK ;
"RTN","MAGDLB1",146,0)
 ;D ^MAGDLB2 Q:'$D(MAGDY)  Q:MAGDY'[""
"RTN","MAGDLB1",147,0)
 D EN^MAGDRA2 Q:'$D(MAGDY)  Q:MAGDY'[""
"RTN","MAGDLB1",148,0)
 D NEWCASE,CHK,NEWDIS S ANS=$$ASK
"RTN","MAGDLB1",149,0)
 I ANS="Q"!(ANS["^") S (OOUT,OUT)=1 D SETPREV Q
"RTN","MAGDLB1",150,0)
 I ANS="D" D SETDEL,SETPREV Q
"RTN","MAGDLB1",151,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDLB1",152,0)
 I ANS="N" S OUT=1 D SETPREV Q
"RTN","MAGDLB1",153,0)
 Q:OUT
"RTN","MAGDLB1",154,0)
 D UPDT
"RTN","MAGDLB1",155,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDLB1",156,0)
 D SETMAG
"RTN","MAGDLB1",157,0)
 Q
"RTN","MAGDLB1",158,0)
DATELOOP(START,STOP) ;Loop thru the "AD" cross reference
"RTN","MAGDLB1",159,0)
 N MAGIEN,SUID,THEDT,FIRST,OOUT,MAGFIX,MDV
"RTN","MAGDLB1",160,0)
 S KFIXALL=$$SECKEY^MAGDLB12
"RTN","MAGDLB1",161,0)
 S THEDT=START-.1,(OOUT,FIRST)=0
"RTN","MAGDLB1",162,0)
 F  S THEDT=$O(^MAGD(2006.575,"AD",THEDT)) Q:'THEDT!(THEDT>STOP)!(OOUT)  D
"RTN","MAGDLB1",163,0)
 . S MAGIEN=0
"RTN","MAGDLB1",164,0)
 . F  S MAGIEN=$O(^MAGD(2006.575,"AD",THEDT,MAGIEN)) Q:'MAGIEN  D
"RTN","MAGDLB1",165,0)
 . . I '$D(^MAGD(2006.575,MAGIEN,0)) D  Q
"RTN","MAGDLB1",166,0)
 . . . K ^MAGD(2006.575,"AD",THEDT,MAGIEN)
"RTN","MAGDLB1",167,0)
 . . . Q
"RTN","MAGDLB1",168,0)
 . . I $P($G(^MAGD(2006.575,MAGIEN,"TYPE")),U,1)'["RAD" Q
"RTN","MAGDLB1",169,0)
 . . ; No security key, or gateway site other than this site
"RTN","MAGDLB1",170,0)
 . . I 'KFIXALL,$P($G(^MAGD(2006.575,MAGIEN,1)),U,5)'=$G(DUZ(2)) Q
"RTN","MAGDLB1",171,0)
 . . I 'FIRST S PREV=MAGIEN,FIRST=1
"RTN","MAGDLB1",172,0)
 . . D SET
"RTN","MAGDLB1",173,0)
 . . Q
"RTN","MAGDLB1",174,0)
 . Q
"RTN","MAGDLB1",175,0)
 Q
"RTN","MAGDLB1",176,0)
SETPREV ;
"RTN","MAGDLB1",177,0)
 S PREV=MAGIEN,PREVS=$G(SUID)
"RTN","MAGDLB1",178,0)
 Q
"RTN","MAGDLB1",179,0)
SETMAG ;
"RTN","MAGDLB1",180,0)
 S FIRST=MAGIEN,FIRSTS=$G(SUID),MAGIEN=PREV,SUID=$G(PREVS)
"RTN","MAGDLB1",181,0)
 S PREV=FIRST,PREVS=FIRSTS
"RTN","MAGDLB1",182,0)
 Q
"RTN","MAGDLB1",183,0)
CHKPREV ;
"RTN","MAGDLB1",184,0)
 S OUT=1 N STATUS
"RTN","MAGDLB1",185,0)
 I '$D(MAGFIX(PREV)) D SETMAG G SET
"RTN","MAGDLB1",186,0)
 S STATUS=$S($G(MAGFIX(PREV))="D":"deleted",1:"corrected")
"RTN","MAGDLB1",187,0)
 W !,"Previous entry has been "_STATUS_".",$C(7)
"RTN","MAGDLB1",188,0)
 G SET
"RTN","MAGDLB1",189,0)
 Q
"RTN","MAGDLB1",190,0)
NAME(ENTRY) ;SITE NAME
"RTN","MAGDLB1",191,0)
 N NAME,MAGOUT,MAGERR
"RTN","MAGDLB1",192,0)
 I '$G(ENTRY) Q ""
"RTN","MAGDLB1",193,0)
 D GETS^DIQ(4,ENTRY,".01","E","MAGOUT","MAGERR")
"RTN","MAGDLB1",194,0)
 I $D(MAGERR("DIERR")) Q ""
"RTN","MAGDLB1",195,0)
 S NAME=$G(MAGOUT(4,ENTRY_",",.01,"E"))
"RTN","MAGDLB1",196,0)
 Q NAME
"RTN","MAGDRA1")
0^16^B21186342
"RTN","MAGDRA1",1,0)
MAGDRA1 ;WOIFO/LB -Routine for DICOM fix ; 09/15/2004  13:34
"RTN","MAGDRA1",2,0)
 ;;3.0;IMAGING;**10,11,30**;16-September-2004
"RTN","MAGDRA1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRA1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRA1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRA1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRA1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRA1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRA1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRA1",10,0)
 ;; |                                                               |
"RTN","MAGDRA1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRA1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRA1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRA1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRA1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRA1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRA1",17,0)
 ;;
"RTN","MAGDRA1",18,0)
 Q
"RTN","MAGDRA1",19,0)
LOOP ;Loop thru ^TMP($J,"RAE1" global
"RTN","MAGDRA1",20,0)
 ;MAGDFN should exist.
"RTN","MAGDRA1",21,0)
 ;MAGNME,MAGSSN may exist.
"RTN","MAGDRA1",22,0)
 Q:'$D(^TMP($J,"RAE1"))!('$D(MAGDFN))
"RTN","MAGDRA1",23,0)
 N CCASE,CASE,CDATE,CODE,DATA,DATE,ENTRY,ENTRIES,ERR,ESTAT,INDEX
"RTN","MAGDRA1",24,0)
 N LOC,MAGCASE,MAGCNI,MAGCPT,MAGDTI,MAGPIEN,MAGPRC,MAGPSET,MAGPST
"RTN","MAGDRA1",25,0)
 N OUT,OLDCNI,OLDDT,OLDENTRY,PROC,PSET,PTINFO,RARPT,RADTI,RACNI,RADFN
"RTN","MAGDRA1",26,0)
 N RAMELOW,RAPRTSET,REIN,STAT,X,Y
"RTN","MAGDRA1",27,0)
 S (ENTRY,ENTRIES,OLDDT)=0
"RTN","MAGDRA1",28,0)
 F  S ENTRY=$O(^TMP($J,"RAE1",MAGDFN,ENTRY)) Q:'ENTRY!$G(OUT)  D
"RTN","MAGDRA1",29,0)
 . S DATA=^TMP($J,"RAE1",MAGDFN,ENTRY),ENTRIES=ENTRIES+1
"RTN","MAGDRA1",30,0)
 . S DATE=$P(ENTRY,"-"),CDATE=9999999.9999-DATE
"RTN","MAGDRA1",31,0)
 . S DATE=$TR($$FMTE^XLFDT(CDATE,"2FD")," ","0")
"RTN","MAGDRA1",32,0)
 . S PROC=$P(DATA,"^"),CASE=$P(DATA,"^",2),STAT=$P(DATA,"^",6)
"RTN","MAGDRA1",33,0)
 . S ESTAT=$P(STAT,"~",2),LOC=$P(DATA,"^",7)
"RTN","MAGDRA1",34,0)
 . S RARPT=$P(DATA,"^",5)
"RTN","MAGDRA1",35,0)
 . S RADTI=$P(ENTRY,"-"),RACNI=$P(ENTRY,"-",2),RADFN=MAGDFN
"RTN","MAGDRA1",36,0)
 . S MAGCASE=$$LCASE^MAGDRA2(CDATE,CASE)
"RTN","MAGDRA1",37,0)
 . ;Above radiology variables needed for EN1^RAULT20
"RTN","MAGDRA1",38,0)
 . K RAMELOW,RAPRTSET
"RTN","MAGDRA1",39,0)
 . D EN1^RAUTL20
"RTN","MAGDRA1",40,0)
 . S (PSET,MAGPSET)=""
"RTN","MAGDRA1",41,0)
 . I OLDDT'=RADTI S OLDCNI=""
"RTN","MAGDRA1",42,0)
 . S PSET=$S(RAMEMLOW:"+",RAPRTSET:".",1:"")
"RTN","MAGDRA1",43,0)
 . I PSET="+" S OLDCNI=RACNI
"RTN","MAGDRA1",44,0)
 . I PSET=".",OLDCNI D
"RTN","MAGDRA1",45,0)
 . . N OLDENTRY S OLDENTRY=$P(ENTRY,"-")_"-"_OLDCNI
"RTN","MAGDRA1",46,0)
 . . I $D(^TMP($J,"RAE1",MAGDFN,OLDENTRY)) D
"RTN","MAGDRA1",47,0)
 . . . S MAGCASE=$P(^TMP($J,"RAE1",MAGDFN,OLDENTRY),"^",2)
"RTN","MAGDRA1",48,0)
 . . . S CDATE=$P(ENTRY,"-")
"RTN","MAGDRA1",49,0)
 . . . S CDATE=9999999.9999-CDATE,RADTI=$P(OLDENTRY,"-"),RACNI=OLDCNI
"RTN","MAGDRA1",50,0)
 . . . S MAGCASE=$$LCASE^MAGDRA2(CDATE,MAGCASE)
"RTN","MAGDRA1",51,0)
 . . . S MAGPSET=CASE_" is part of this printset."
"RTN","MAGDRA1",52,0)
 . . . Q
"RTN","MAGDRA1",53,0)
 . . Q
"RTN","MAGDRA1",54,0)
 . I '$D(MAGNME)!'($D(MAGSSN)) D
"RTN","MAGDRA1",55,0)
 . . S PTINFO=$$PTINFO^MAGDRA2
"RTN","MAGDRA1",56,0)
 . . S MAGNME=$P(PTINFO,"^"),MAGSSN=$P(PTINFO,"^",2)
"RTN","MAGDRA1",57,0)
 . . Q
"RTN","MAGDRA1",58,0)
 . S INDEX(ENTRIES)=PROC_"^"_$G(MAGPSET)_"^"_RADTI_"^"_RACNI_"^"_MAGCASE
"RTN","MAGDRA1",59,0)
 . ; Radiology procedure^Printset^Inverse radiology date/time^Radioloty multiple^radiology case number
"RTN","MAGDRA1",60,0)
 . D PRT S OLDDT=RADTI
"RTN","MAGDRA1",61,0)
 . Q
"RTN","MAGDRA1",62,0)
 D:'$G(OUT) SEL I +X,$D(INDEX(+X)) D SET
"RTN","MAGDRA1",63,0)
 K OUT
"RTN","MAGDRA1",64,0)
 Q
"RTN","MAGDRA1",65,0)
PRT ;
"RTN","MAGDRA1",66,0)
 S (X,Y)=0
"RTN","MAGDRA1",67,0)
 I ENTRIES=1 D HEAD
"RTN","MAGDRA1",68,0)
 I $Y+6>IOSL D HEAD
"RTN","MAGDRA1",69,0)
 W !?1,ENTRIES,?5,PSET,?6,CASE_$$IMG^MAGDRA2(RARPT),?12,$E(PROC,1,28)
"RTN","MAGDRA1",70,0)
 W ?41,DATE,?52,$E(ESTAT,1,12),?67,$E(LOC,1,12) Q:ENTRIES#15
"RTN","MAGDRA1",71,0)
 D SEL
"RTN","MAGDRA1",72,0)
 Q
"RTN","MAGDRA1",73,0)
HEAD ;
"RTN","MAGDRA1",74,0)
 W @IOF,"Patient: ",MAGNME,?50,"SSN: ",MAGSSN
"RTN","MAGDRA1",75,0)
 W !!,?3,"Case #",?12,"Procedure",?41,"Exam Date",?52,"Status of"
"RTN","MAGDRA1",76,0)
 W "Exam",?69,"Imaging Loc"
"RTN","MAGDRA1",77,0)
 W !?3,"--------",?12,"-------------",?41,"---------"
"RTN","MAGDRA1",78,0)
 W ?52,"--------------",?67,"-----------"
"RTN","MAGDRA1",79,0)
 Q
"RTN","MAGDRA1",80,0)
SEL ;
"RTN","MAGDRA1",81,0)
 N DIR ; -- array for FileMan prompt data
"RTN","MAGDRA1",82,0)
 S DIR(0)="NAO^1:"_ENTRIES
"RTN","MAGDRA1",83,0)
 S DIR("?",1)="Enter a number between 1 and "_ENTRIES
"RTN","MAGDRA1",84,0)
 S DIR("?")="corresponding to a single exam you wish to select."
"RTN","MAGDRA1",85,0)
 S DIR("A",1)="'i' next to a case number denotes images collected on study."
"RTN","MAGDRA1",86,0)
 S DIR("A")="Select an exam: "
"RTN","MAGDRA1",87,0)
 D ^DIR
"RTN","MAGDRA1",88,0)
 I '$D(DTOUT),'$D(DUOUT) ; didn't time out or uparrow out
"RTN","MAGDRA1",89,0)
 E  S OUT=1 Q
"RTN","MAGDRA1",90,0)
 I Y,$D(INDEX(Y)) D CHECK I 'Y G SEL
"RTN","MAGDRA1",91,0)
 I Y S Y=INDEX(Y) S OUT=1
"RTN","MAGDRA1",92,0)
 Q
"RTN","MAGDRA1",93,0)
SET ;
"RTN","MAGDRA1",94,0)
 S DATA=Y K Y
"RTN","MAGDRA1",95,0)
 S MAGCASE=$P(INDEX(+X),"^",5)
"RTN","MAGDRA1",96,0)
 S MAGPRC=$P(INDEX(+X),"^"),MAGPIEN=$$PROC^MAGDRA2(MAGPRC)
"RTN","MAGDRA1",97,0)
 S MAGDTI=$P(INDEX(+X),"^",3)
"RTN","MAGDRA1",98,0)
 S MAGPST=$P(INDEX(+X),"^",2)
"RTN","MAGDRA1",99,0)
 S MAGCNI=$P(INDEX(+X),"^",4)
"RTN","MAGDRA1",100,0)
 D MAGDY^MAGDRA2
"RTN","MAGDRA1",101,0)
 Q
"RTN","MAGDRA1",102,0)
CHECK ;
"RTN","MAGDRA1",103,0)
 ;Check to see if the entry still exists.
"RTN","MAGDRA1",104,0)
 N RADTI,CNI
"RTN","MAGDRA1",105,0)
 Q:'MAGDFN
"RTN","MAGDRA1",106,0)
 S RADTI=$P(INDEX(Y),"^",3),CNI=$P(INDEX(Y),"^",4)
"RTN","MAGDRA1",107,0)
 I '$D(^RADPT(MAGDFN,"DT",RADTI,"P",CNI)) D
"RTN","MAGDRA1",108,0)
 . S Y=""
"RTN","MAGDRA1",109,0)
 . W !,"There is a database problem with the entry selected.",!
"RTN","MAGDRA1",110,0)
 . Q
"RTN","MAGDRA1",111,0)
 I $P(INDEX(Y),"^")="" D
"RTN","MAGDRA1",112,0)
 . S Y=""
"RTN","MAGDRA1",113,0)
 . W !,"There are no procedures for the entry selected.",!
"RTN","MAGDRA1",114,0)
 Q
"RTN","MAGDRCU1")
0^17^B29209213
"RTN","MAGDRCU1",1,0)
MAGDRCU1 ;WOIFO/PMK - List entries in ^MAG(2006.5839) ; 05/06/2004  06:32
"RTN","MAGDRCU1",2,0)
 ;;3.0;IMAGING;**10,30**;16-September-2004
"RTN","MAGDRCU1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRCU1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRCU1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRCU1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRCU1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRCU1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRCU1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRCU1",10,0)
 ;; |                                                               |
"RTN","MAGDRCU1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRCU1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRCU1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRCU1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRCU1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRCU1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRCU1",17,0)
 ;;
"RTN","MAGDRCU1",18,0)
 Q
"RTN","MAGDRCU1",19,0)
 ; This routine lists the entries in the temporary Imaging/CPRS Consult
"RTN","MAGDRCU1",20,0)
 ; Request Tracking association file
"RTN","MAGDRCU1",21,0)
 ;
"RTN","MAGDRCU1",22,0)
 ;     XXXX                                         XXX       X
"RTN","MAGDRCU1",23,0)
 ;    XX  XX                                         XX      XX
"RTN","MAGDRCU1",24,0)
 ;   XX         XXXX    XX XXX  XXXXXXX  XX  XXX     XX     XXXXX
"RTN","MAGDRCU1",25,0)
 ;   XX        XX  XX   XXX XX  XX       XX  XX      XX      XX
"RTN","MAGDRCU1",26,0)
 ;   XX    X   XX  XX   XX  XX  XXXXXXX  XX  XX      XX      XX
"RTN","MAGDRCU1",27,0)
 ;    XX  XX   XX  XX   XX  XX       XX  XX  XX      XX      XX XX
"RTN","MAGDRCU1",28,0)
 ;     XXXX     XXXX    XX  XX  XXXXXXX   XXX XX    XXXX      XXX
"RTN","MAGDRCU1",29,0)
 ;
"RTN","MAGDRCU1",30,0)
 ; Routine 1/2 for application
"RTN","MAGDRCU1",31,0)
 ;
"RTN","MAGDRCU1",32,0)
ENTRY ; read the entries in file ^MAG(2006.5839)
"RTN","MAGDRCU1",33,0)
 N COUNT,CUTOFF,DAYS,DIVISION,DONE,INDEX,SELECT,SERVICE,SORT,SUBTITLE,TITLE,X
"RTN","MAGDRCU1",34,0)
 ;
"RTN","MAGDRCU1",35,0)
 S TITLE="UNREAD LIST FOR HEALTHCARE PROVIDERS"
"RTN","MAGDRCU1",36,0)
 W !!,TITLE,!!
"RTN","MAGDRCU1",37,0)
 ;
"RTN","MAGDRCU1",38,0)
 ; get the division and service list
"RTN","MAGDRCU1",39,0)
 S SERVICE=0 F  S SERVICE=$O(^MAG(2006.5831,SERVICE)) Q:'SERVICE  D
"RTN","MAGDRCU1",40,0)
 . S X=^MAG(2006.5831,SERVICE,0)
"RTN","MAGDRCU1",41,0)
 . S INDEX=$P(X,"^",2),DIVISION=$P(X,"^",3)
"RTN","MAGDRCU1",42,0)
 . S SERVICE(DIVISION)=$$GET1^DIQ(4,DIVISION,.01)
"RTN","MAGDRCU1",43,0)
 . S SERVICE(DIVISION,INDEX)=$P(^MAG(2005.84,INDEX,0),"^",1)
"RTN","MAGDRCU1",44,0)
 . S SERVICE(DIVISION,INDEX,SERVICE)=$$GET1^DIQ(123.5,SERVICE,.01)
"RTN","MAGDRCU1",45,0)
 . Q
"RTN","MAGDRCU1",46,0)
 ;
"RTN","MAGDRCU1",47,0)
 I '$D(SERVICE) W !,"No SERVICEs are defined in file 2006.5831" Q
"RTN","MAGDRCU1",48,0)
 ;
"RTN","MAGDRCU1",49,0)
 ; select the SERVICE of interest
"RTN","MAGDRCU1",50,0)
 S DONE=0 F  D  Q:DONE
"RTN","MAGDRCU1",51,0)
 . S COUNT=0,DIVISION=""
"RTN","MAGDRCU1",52,0)
 . W !
"RTN","MAGDRCU1",53,0)
 . F  S DIVISION=$O(SERVICE(DIVISION)) Q:'DIVISION  D
"RTN","MAGDRCU1",54,0)
 . . S INDEX=""
"RTN","MAGDRCU1",55,0)
 . . F  S INDEX=$O(SERVICE(DIVISION,INDEX)) Q:INDEX=""  D
"RTN","MAGDRCU1",56,0)
 . . . S COUNT=COUNT+1
"RTN","MAGDRCU1",57,0)
 . . . W !,$J(COUNT,2),") ",$J(DIVISION,4)," -- ",SERVICE(DIVISION)
"RTN","MAGDRCU1",58,0)
 . . . W " -- ",SERVICE(DIVISION,INDEX)
"RTN","MAGDRCU1",59,0)
 . . . S SERVICE("B",COUNT)=DIVISION_"^"_INDEX
"RTN","MAGDRCU1",60,0)
 . . . Q
"RTN","MAGDRCU1",61,0)
 . . Q
"RTN","MAGDRCU1",62,0)
 . I COUNT=1 S SELECT="ALL",DONE=1
"RTN","MAGDRCU1",63,0)
 . E  D
"RTN","MAGDRCU1",64,0)
 . . W !!,"Select the proper service (1-",COUNT,") or enter ALL: " R X:DTIME
"RTN","MAGDRCU1",65,0)
 . . I X?.N,X,X'>COUNT S SELECT=SERVICE("B",X),DONE=1
"RTN","MAGDRCU1",66,0)
 . . E  I $L(X),"Aa"[$E(X) S SELECT="ALL",DONE=1
"RTN","MAGDRCU1",67,0)
 . . E  I X["^" S DONE=-1
"RTN","MAGDRCU1",68,0)
 . . E  I X["?" D
"RTN","MAGDRCU1",69,0)
 . . . W !!,"Please enter the number of the corresponding service."
"RTN","MAGDRCU1",70,0)
 . . . W !,"Enter ""ALL"" if you want all of the services."
"RTN","MAGDRCU1",71,0)
 . . . Q
"RTN","MAGDRCU1",72,0)
 . . E  W " ???"
"RTN","MAGDRCU1",73,0)
 . . Q
"RTN","MAGDRCU1",74,0)
 . Q
"RTN","MAGDRCU1",75,0)
 I DONE=-1 Q  ; cancelled by user
"RTN","MAGDRCU1",76,0)
 ;
"RTN","MAGDRCU1",77,0)
 I SELECT="ALL" D
"RTN","MAGDRCU1",78,0)
 . S DIVISION=""
"RTN","MAGDRCU1",79,0)
 . F  S DIVISION=$O(SERVICE(DIVISION)) Q:'DIVISION  D
"RTN","MAGDRCU1",80,0)
 . . S INDEX=""
"RTN","MAGDRCU1",81,0)
 . . F  S INDEX=$O(SERVICE(DIVISION,INDEX)) Q:INDEX=""  D
"RTN","MAGDRCU1",82,0)
 . . . D SELSERV(DIVISION,INDEX)
"RTN","MAGDRCU1",83,0)
 . . . Q
"RTN","MAGDRCU1",84,0)
 E  D
"RTN","MAGDRCU1",85,0)
 . S DIVISION=$P(SELECT,"^",1),INDEX=$P(SELECT,"^",2)
"RTN","MAGDRCU1",86,0)
 . D SELSERV(DIVISION,INDEX)
"RTN","MAGDRCU1",87,0)
 . Q
"RTN","MAGDRCU1",88,0)
 ;
"RTN","MAGDRCU1",89,0)
 S DONE=0 F  D  Q:DONE
"RTN","MAGDRCU1",90,0)
 . W !!,"Display studies older than how many days?  0// "
"RTN","MAGDRCU1",91,0)
 . R X:DTIME I X="" S X=0 W X
"RTN","MAGDRCU1",92,0)
 . I X?.N S DAYS=X,DONE=1 Q
"RTN","MAGDRCU1",93,0)
 . E  I X["^" S DONE=-1
"RTN","MAGDRCU1",94,0)
 . E  I X["?" D
"RTN","MAGDRCU1",95,0)
 . . W !!,"Please enter the minimum number of days that have elapsed since"
"RTN","MAGDRCU1",96,0)
 . . W !,"the examination was performed.  This allows only the old studies"
"RTN","MAGDRCU1",97,0)
 . . W !,"to be reported.  Enter 0 days to display all the studies."
"RTN","MAGDRCU1",98,0)
 . . Q
"RTN","MAGDRCU1",99,0)
 . E  W " ???"
"RTN","MAGDRCU1",100,0)
 . Q
"RTN","MAGDRCU1",101,0)
 I DONE=-1 Q  ; cancelled by user
"RTN","MAGDRCU1",102,0)
 S %H=($H+1)-DAYS D YMD^%DTC S CUTOFF=X
"RTN","MAGDRCU1",103,0)
 ;
"RTN","MAGDRCU1",104,0)
 S DONE=0 F  D  Q:DONE
"RTN","MAGDRCU1",105,0)
 . W !!,"Sort by patient name or examination date? (N or D) D// "
"RTN","MAGDRCU1",106,0)
 . R X:DTIME I X="" S X="D" W X
"RTN","MAGDRCU1",107,0)
 . I "NnDd"[$E(X) S SORT=X,DONE=1 Q
"RTN","MAGDRCU1",108,0)
 . E  I X["^" S DONE=-1
"RTN","MAGDRCU1",109,0)
 . E  I X["?" D
"RTN","MAGDRCU1",110,0)
 . . W !!,"Designate the sort order for the report, alphabetically by patient"
"RTN","MAGDRCU1",111,0)
 . . W !,"name or chronologically by the examination date."
"RTN","MAGDRCU1",112,0)
 . . Q
"RTN","MAGDRCU1",113,0)
 . E  W " ???"
"RTN","MAGDRCU1",114,0)
 . Q
"RTN","MAGDRCU1",115,0)
 I DONE=-1 Q  ; cancelled by user
"RTN","MAGDRCU1",116,0)
 ;
"RTN","MAGDRCU1",117,0)
 I SELECT="ALL" S SUBTITLE(1)="ALL SERVICES"
"RTN","MAGDRCU1",118,0)
 E  D
"RTN","MAGDRCU1",119,0)
 . S SUBTITLE(1)=$P(SELECT,"^",1)_" -- "_SERVICE($P(SELECT,"^",1))
"RTN","MAGDRCU1",120,0)
 . S SUBTITLE(1)=SUBTITLE(1)_" -- "_SERVICE($P(SELECT,"^",1),$P(SELECT,"^",2))
"RTN","MAGDRCU1",121,0)
 . Q
"RTN","MAGDRCU1",122,0)
 I DAYS S SUBTITLE(2)="Studies more than "_DAYS_" days old"
"RTN","MAGDRCU1",123,0)
 E  S SUBTITLE(2)="All studies regardless of age"
"RTN","MAGDRCU1",124,0)
 S SUBTITLE(2)=SUBTITLE(2)_" sorted by "_$S(SORT="D":"date",1:"name")
"RTN","MAGDRCU1",125,0)
 ;
"RTN","MAGDRCU1",126,0)
 ; Output the report
"RTN","MAGDRCU1",127,0)
 ;
"RTN","MAGDRCU1",128,0)
 W ! S %ZIS="Q" D ^%ZIS I POP Q  ; select the output device, quit if none
"RTN","MAGDRCU1",129,0)
 ;
"RTN","MAGDRCU1",130,0)
 ; setup for queueing the report to print in the background via Taskman 
"RTN","MAGDRCU1",131,0)
 I $D(IO("Q")) D  ; queued
"RTN","MAGDRCU1",132,0)
 . S ZTSAVE("CUTOFF")=""
"RTN","MAGDRCU1",133,0)
 . S ZTSAVE("SELECT")=""
"RTN","MAGDRCU1",134,0)
 . S ZTSAVE("SERVICE(")=""
"RTN","MAGDRCU1",135,0)
 . S ZTSAVE("SORT")=""
"RTN","MAGDRCU1",136,0)
 . S ZTSAVE("SUBTITLE(")=""
"RTN","MAGDRCU1",137,0)
 . S ZTSAVE("TITLE")=""
"RTN","MAGDRCU1",138,0)
 . S ZTRTN="REPORT^MAGDRCU2",ZTDESC=TITLE
"RTN","MAGDRCU1",139,0)
 . D ^%ZTLOAD D HOME^%ZIS K IO("Q")
"RTN","MAGDRCU1",140,0)
 . Q
"RTN","MAGDRCU1",141,0)
 E  D  ; immediate
"RTN","MAGDRCU1",142,0)
 . D REPORT^MAGDRCU2
"RTN","MAGDRCU1",143,0)
 . Q
"RTN","MAGDRCU1",144,0)
 Q
"RTN","MAGDRCU1",145,0)
 ;
"RTN","MAGDRCU1",146,0)
SELSERV(DIVISION,INDEX) ; select service
"RTN","MAGDRCU1",147,0)
 N S
"RTN","MAGDRCU1",148,0)
 S S=""
"RTN","MAGDRCU1",149,0)
 F  S S=$O(SERVICE(DIVISION,INDEX,S)) Q:S=""  D
"RTN","MAGDRCU1",150,0)
 . S SERVICE("S",S)=SERVICE(DIVISION,INDEX,S)
"RTN","MAGDRCU1",151,0)
 . Q
"RTN","MAGDRCU1",152,0)
 Q
"RTN","MAGDRCU1",153,0)
 ;
"RTN","MAGDRPC1")
0^18^B35439796
"RTN","MAGDRPC1",1,0)
MAGDRPC1 ;WOIFO/EdM - Imaging RPCs ; 09/03/2004  06:44
"RTN","MAGDRPC1",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDRPC1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC1",10,0)
 ;; |                                                               |
"RTN","MAGDRPC1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC1",17,0)
 ;;
"RTN","MAGDRPC1",18,0)
 Q
"RTN","MAGDRPC1",19,0)
 ;
"RTN","MAGDRPC1",20,0)
DOMAIN(OUT) ; RPC = MAG DICOM GET DOMAIN
"RTN","MAGDRPC1",21,0)
 N X
"RTN","MAGDRPC1",22,0)
 I $T(WHERE^XUPARAM)'="" S OUT=$$KSP^XUPARAM("WHERE") Q
"RTN","MAGDRPC1",23,0)
 ; The coding standards frown upon the line below,
"RTN","MAGDRPC1",24,0)
 ; but it is the best we can do when the line above cannot be used.
"RTN","MAGDRPC1",25,0)
 S X=^DD("SITE") S:X'[".DOMAIN.EXT" X=X_".DOMAIN.EXT"
"RTN","MAGDRPC1",26,0)
 S OUT=X
"RTN","MAGDRPC1",27,0)
 Q
"RTN","MAGDRPC1",28,0)
 ;
"RTN","MAGDRPC1",29,0)
INFO(OUT,LOCATION) ; RPC = MAG DICOM ET PHONE HOME
"RTN","MAGDRPC1",30,0)
 N FST,N,X
"RTN","MAGDRPC1",31,0)
 K OUT
"RTN","MAGDRPC1",32,0)
 S X1=DT,X2=-25 D C^%DTC S FST=X
"RTN","MAGDRPC1",33,0)
 S N=2
"RTN","MAGDRPC1",34,0)
 ;
"RTN","MAGDRPC1",35,0)
 ; Site-ID
"RTN","MAGDRPC1",36,0)
 D DOMAIN(.X)
"RTN","MAGDRPC1",37,0)
 S OUT(N)=X
"RTN","MAGDRPC1",38,0)
 ;
"RTN","MAGDRPC1",39,0)
 D ROUTEDAY^MAGDRPC2 ; Get routing statistics
"RTN","MAGDRPC1",40,0)
 ;
"RTN","MAGDRPC1",41,0)
 D  ; Text Gateway Statistics
"RTN","MAGDRPC1",42,0)
 . N A,C,D0,D2,M,X
"RTN","MAGDRPC1",43,0)
 . S A=0,D0=FST F  S D0=$O(^MAGDAUDT(2006.5761,D0)) Q:'D0  D
"RTN","MAGDRPC1",44,0)
 . . S D2=0 F  S D2=$O(^MAGDAUDT(2006.5761,D0,1,LOCATION,1,D2)) Q:'D2  D
"RTN","MAGDRPC1",45,0)
 . . . S X=$G(^MAGDAUDT(2006.5761,D0,1,LOCATION,1,D2,0))
"RTN","MAGDRPC1",46,0)
 . . . S M=$P(X,"^",2) Q:'M
"RTN","MAGDRPC1",47,0)
 . . . S:'A N=N+1,OUT(N)="Audit",A=1
"RTN","MAGDRPC1",48,0)
 . . . S N=N+1,OUT(N)="STTX="_D0_"^"_$P(X,"^",1)_"^"_M
"RTN","MAGDRPC1",49,0)
 . . . Q
"RTN","MAGDRPC1",50,0)
 . . Q
"RTN","MAGDRPC1",51,0)
 . Q
"RTN","MAGDRPC1",52,0)
 ;
"RTN","MAGDRPC1",53,0)
 S OUT(1)=N-1
"RTN","MAGDRPC1",54,0)
 Q
"RTN","MAGDRPC1",55,0)
 ;
"RTN","MAGDRPC1",56,0)
STATION(OUT,STATION,VERSION) ; RPC = MAG DICOM WORKSTATION VERSION
"RTN","MAGDRPC1",57,0)
 N %,D0,%H,%I,X
"RTN","MAGDRPC1",58,0)
 I $G(STATION)="" S OUT="-1,No Station Identifier Specified" Q
"RTN","MAGDRPC1",59,0)
 ;
"RTN","MAGDRPC1",60,0)
 S D0=$O(^MAG(2006.83,"B",STATION,"")) D:'D0
"RTN","MAGDRPC1",61,0)
 . L +^MAG(2006.83,0):1E9 ; Background process must wait for LOCK
"RTN","MAGDRPC1",62,0)
 . S X=$G(^MAG(2006.83,0))
"RTN","MAGDRPC1",63,0)
 . S $P(X,"^",1,2)="DICOM WORKSTATION^2006.83"
"RTN","MAGDRPC1",64,0)
 . S D0=$O(^MAG(2006.83," "),-1)+1
"RTN","MAGDRPC1",65,0)
 . S $P(X,"^",3)=D0
"RTN","MAGDRPC1",66,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDRPC1",67,0)
 . S ^MAG(2006.83,0)=X,^MAG(2006.83,D0,0)=STATION
"RTN","MAGDRPC1",68,0)
 . S ^MAG(2006.83,"B",STATION,D0)=""
"RTN","MAGDRPC1",69,0)
 . L -^MAG(2006.83,0)
"RTN","MAGDRPC1",70,0)
 . Q
"RTN","MAGDRPC1",71,0)
 S $P(^MAG(2006.83,D0,0),"^",3)=VERSION
"RTN","MAGDRPC1",72,0)
 S X=$P(^MAG(2006.83,D0,0),"^",2)
"RTN","MAGDRPC1",73,0)
 D NOW^%DTC
"RTN","MAGDRPC1",74,0)
 S $P(^MAG(2006.83,D0,0),"^",2)=%
"RTN","MAGDRPC1",75,0)
 S OUT=D0
"RTN","MAGDRPC1",76,0)
 Q
"RTN","MAGDRPC1",77,0)
 ;
"RTN","MAGDRPC1",78,0)
FMGET(OUT,FILE,D0,FIELD) ; RPC = MAG DICOM FILEMAN GET
"RTN","MAGDRPC1",79,0)
 ; Get the value of a data field
"RTN","MAGDRPC1",80,0)
 S OUT=$$GET1^DIQ(FILE,D0,FIELD)
"RTN","MAGDRPC1",81,0)
 Q
"RTN","MAGDRPC1",82,0)
 ;
"RTN","MAGDRPC1",83,0)
CUTOFF(OUT,D0) ; RPC = MAG DICOM PACS CUTOFF DATE
"RTN","MAGDRPC1",84,0)
 ; Retention Period for PACS
"RTN","MAGDRPC1",85,0)
 N X
"RTN","MAGDRPC1",86,0)
 I $E($O(^MAG(2006.1," ")),1)="A" D  Q
"RTN","MAGDRPC1",87,0)
 . ; Non-consolidated site
"RTN","MAGDRPC1",88,0)
 . I '$D(^MAG(2006.1,"APACS")) S OUT="-2,No PACS Installed" Q
"RTN","MAGDRPC1",89,0)
 . ;
"RTN","MAGDRPC1",90,0)
 . S X=$G(^MAG(2006.1,"AIMDELPACS"))
"RTN","MAGDRPC1",91,0)
 . I X="" S OUT="-3,PACS Retention Parameter not defined" Q
"RTN","MAGDRPC1",92,0)
 . S OUT=X
"RTN","MAGDRPC1",93,0)
 . Q
"RTN","MAGDRPC1",94,0)
 ; Consolidated site:
"RTN","MAGDRPC1",95,0)
 I '$P($G(^MAG(2006.1,D0,"PACS")),"^",1) S OUT="-2,No PACS Installed" Q
"RTN","MAGDRPC1",96,0)
 ;
"RTN","MAGDRPC1",97,0)
 S X=$P($G(^MAG(2006.1,D0,1)),"^",5)
"RTN","MAGDRPC1",98,0)
 I X="" S OUT="-3,PACS Retention Parameter not defined" Q
"RTN","MAGDRPC1",99,0)
 S OUT=X
"RTN","MAGDRPC1",100,0)
 Q
"RTN","MAGDRPC1",101,0)
 ;
"RTN","MAGDRPC1",102,0)
MINSPACE(OUT,D0) ; RPC = MAG DICOM PACS MINIMUM SPACE
"RTN","MAGDRPC1",103,0)
 ; Minimum Percentage of Free Disk Space
"RTN","MAGDRPC1",104,0)
 N X
"RTN","MAGDRPC1",105,0)
 I $E($O(^MAG(2006.1," ")),1)="A" D  Q
"RTN","MAGDRPC1",106,0)
 . ; Non-consolidated site
"RTN","MAGDRPC1",107,0)
 . I '$D(^MAG(2006.1,"APACS")) S OUT="-2,No PACS Installed" Q
"RTN","MAGDRPC1",108,0)
 . ;
"RTN","MAGDRPC1",109,0)
 . S X=$G(^MAG(2006.1,"AIMDELPACS2"))
"RTN","MAGDRPC1",110,0)
 . I X="" S OUT="-3,PACS Minimum Space Percentage Parameter not defined" Q
"RTN","MAGDRPC1",111,0)
 . S OUT=X
"RTN","MAGDRPC1",112,0)
 . Q
"RTN","MAGDRPC1",113,0)
 ; Consolidated site:
"RTN","MAGDRPC1",114,0)
 I '$P($G(^MAG(2006.1,D0,"PACS")),"^",1) S OUT="-2,No PACS Installed" Q
"RTN","MAGDRPC1",115,0)
 ;
"RTN","MAGDRPC1",116,0)
 S X=$P($G(^MAG(2006.1,D0,3)),"^",5)
"RTN","MAGDRPC1",117,0)
 I X="" S OUT="-3,PACS Minimum Space Percentage Parameter not defined" Q
"RTN","MAGDRPC1",118,0)
 S OUT=X
"RTN","MAGDRPC1",119,0)
 Q
"RTN","MAGDRPC1",120,0)
 ;
"RTN","MAGDRPC1",121,0)
HL7PURGE(OUT,CUTOFF) ; RPC = MAG DICOM PURGE HL7
"RTN","MAGDRPC1",122,0)
 ; Purge HL7 transactions
"RTN","MAGDRPC1",123,0)
 N D,D0,P,T,X
"RTN","MAGDRPC1",124,0)
 S OUT=0
"RTN","MAGDRPC1",125,0)
 S D="" F  S D=$O(^MAGDHL7(2006.5,"B",D)) Q:'D  Q:D'<CUTOFF  D
"RTN","MAGDRPC1",126,0)
 . S D0="" F  S D0=$O(^MAGDHL7(2006.5,"B",D,D0)) Q:'D0  D
"RTN","MAGDRPC1",127,0)
 . . S X=$G(^MAGDHL7(2006.5,D0,0)),P=$P(X,"^",4),T=$P(X,"^",3)
"RTN","MAGDRPC1",128,0)
 . . K ^MAGDHL7(2006.5,D0)
"RTN","MAGDRPC1",129,0)
 . . K ^MAGDHL7(2006.5,"B",D,D0)
"RTN","MAGDRPC1",130,0)
 . . K:T'="" ^MAGDHL7(2006.5,"C",T,D0)
"RTN","MAGDRPC1",131,0)
 . . K:P'="" ^MAGDHL7(2006.5,"D",P,D0)
"RTN","MAGDRPC1",132,0)
 . . S OUT=OUT+1
"RTN","MAGDRPC1",133,0)
 . . Q
"RTN","MAGDRPC1",134,0)
 . Q
"RTN","MAGDRPC1",135,0)
 D:OUT
"RTN","MAGDRPC1",136,0)
 . L +^MAGDHL7(2006.5,0):1E9
"RTN","MAGDRPC1",137,0)
 . S X=$G(^MAGDHL7(2006.5,0))
"RTN","MAGDRPC1",138,0)
 . S $P(X,"^",1,2)="PACS MESSAGES^2006.5D"
"RTN","MAGDRPC1",139,0)
 . S $P(X,"^",4)=$P(X,"^",4)-OUT
"RTN","MAGDRPC1",140,0)
 . S ^MAGDHL7(2006.5,0)=X
"RTN","MAGDRPC1",141,0)
 . L -^MAGDHL7(2006.5,0)
"RTN","MAGDRPC1",142,0)
 . Q
"RTN","MAGDRPC1",143,0)
 Q
"RTN","MAGDRPC1",144,0)
 ;
"RTN","MAGDRPC1",145,0)
VALDEST(OUT,NAME) ; RPC = MAG DICOM ROUTE VALID DEST
"RTN","MAGDRPC1",146,0)
 N D0,PLACE,X
"RTN","MAGDRPC1",147,0)
 ; This function is also called from various routines
"RTN","MAGDRPC1",148,0)
 ; that belong to automated routing.
"RTN","MAGDRPC1",149,0)
 ;
"RTN","MAGDRPC1",150,0)
 S OUT="-1,"""_NAME_""" is not a valid destination"
"RTN","MAGDRPC1",151,0)
 ;
"RTN","MAGDRPC1",152,0)
 I $D(^MAG(2005.2,"B")) D  Q
"RTN","MAGDRPC1",153,0)
 . S D0=$O(^MAG(2005.2,"B",NAME,"")) Q:'D0
"RTN","MAGDRPC1",154,0)
 . S:$P($G(^MAG(2005.2,D0,0)),"^",9) OUT=D0
"RTN","MAGDRPC1",155,0)
 . Q 
"RTN","MAGDRPC1",156,0)
 ;
"RTN","MAGDRPC1",157,0)
 S D0=""
"RTN","MAGDRPC1",158,0)
 S PLACE="" F  S PLACE=$O(^MAG(2005.2,"D",PLACE)) Q:PLACE=""  D  Q:OUT>0
"RTN","MAGDRPC1",159,0)
 . S D0=$O(^MAG(2005.2,"D",PLACE,NAME,""))
"RTN","MAGDRPC1",160,0)
 . S:$P($G(^MAG(2005.2,D0,0)),"^",9) OUT=D0
"RTN","MAGDRPC1",161,0)
 . Q
"RTN","MAGDRPC1",162,0)
 Q
"RTN","MAGDRPC1",163,0)
 ;
"RTN","MAGDRPC1",164,0)
PAT(OUT,DFN) ; RPC = MAG DICOM GET PATIENT
"RTN","MAGDRPC1",165,0)
 N DIQUIET,I,N,VADM,VAIN,VAPA,VASD
"RTN","MAGDRPC1",166,0)
 K OUT
"RTN","MAGDRPC1",167,0)
 I '$G(DFN) S OUT(1)="-1,No Patient Identified" Q
"RTN","MAGDRPC1",168,0)
 S N=1,DIQUIET=1
"RTN","MAGDRPC1",169,0)
 D DEM^VADPT
"RTN","MAGDRPC1",170,0)
 S I="" F  S I=$O(VADM(I)) Q:I=""  S:VADM(I)'="" N=N+1,OUT(N)="DEM^"_I_"^"_VADM(I)
"RTN","MAGDRPC1",171,0)
 D ADD^VADPT
"RTN","MAGDRPC1",172,0)
 S I="" F  S I=$O(VAPA(I)) Q:I=""  S:VAPA(I)'="" N=N+1,OUT(N)="ADD^"_I_"^"_VAPA(I)
"RTN","MAGDRPC1",173,0)
 D INP^VADPT
"RTN","MAGDRPC1",174,0)
 S I="" F  S I=$O(VAIN(I)) Q:I=""  S:VAIN(I)'="" N=N+1,OUT(N)="INP^"_I_"^"_VAIN(I)
"RTN","MAGDRPC1",175,0)
 D SDA^VADPT
"RTN","MAGDRPC1",176,0)
 S I="" F  S I=$O(VASD(I)) Q:I=""  S:VASD(I)'="" N=N+1,OUT(N)="SDA^"_I_"^"_VASD(I)
"RTN","MAGDRPC1",177,0)
 S OUT(1)=N-1
"RTN","MAGDRPC1",178,0)
 Q
"RTN","MAGDRPC1",179,0)
 ;
"RTN","MAGDRPC1",180,0)
RARPTO(OUT,TYPE,D0,F,D1) ; RPC = MAG DICOM GET RAD RPT INFO
"RTN","MAGDRPC1",181,0)
 S TYPE=$G(TYPE),D0=$G(D0),F=$G(F,1),D1=+$G(D1)
"RTN","MAGDRPC1",182,0)
 I TYPE="O1" S OUT=+$O(^RARPT(D0),F) Q
"RTN","MAGDRPC1",183,0)
 I TYPE="O2" S OUT=+$O(^RARPT(D0,F,D1)) Q
"RTN","MAGDRPC1",184,0)
 I TYPE="G1" S OUT=$G(^RARPT(D0,0)) Q
"RTN","MAGDRPC1",185,0)
 I TYPE="G2" S OUT=$G(^RARPT(D0,F,D1,0)) Q
"RTN","MAGDRPC1",186,0)
 S OUT="-1,Invalid request type ("""_TYPE_""")"
"RTN","MAGDRPC1",187,0)
 Q
"RTN","MAGDRPC1",188,0)
 ;
"RTN","MAGDRPC2")
0^19^B62572365
"RTN","MAGDRPC2",1,0)
MAGDRPC2 ;WOIFO/EdM - Imaging RPCs ; 07/06/2004  11:52
"RTN","MAGDRPC2",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDRPC2",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC2",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC2",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC2",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC2",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC2",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC2",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC2",10,0)
 ;; |                                                               |
"RTN","MAGDRPC2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC2",17,0)
 ;;
"RTN","MAGDRPC2",18,0)
 Q
"RTN","MAGDRPC2",19,0)
 ;
"RTN","MAGDRPC2",20,0)
SERVICE(OUT) ; RPC = MAG DICOM GET SERVICE INFO
"RTN","MAGDRPC2",21,0)
 N D0,X
"RTN","MAGDRPC2",22,0)
 S D0=$O(^MAG(2006.1,0)),OUT="-1,No Imaging Site Parameters defined" Q:'D0
"RTN","MAGDRPC2",23,0)
 S X=$G(^MAG(2006.1,D0,"GW"))
"RTN","MAGDRPC2",24,0)
 S OUT=$$ENCRYP^ROUTINE($$DECRYP($P(X,"^",1))_";"_$$DECRYP($P(X,"^",2)))
"RTN","MAGDRPC2",25,0)
 Q
"RTN","MAGDRPC2",26,0)
 ;
"RTN","MAGDRPC2",27,0)
SAME(SET,D0,NODE,PIECE,X) ; Called from FileMan ^DD
"RTN","MAGDRPC2",28,0)
 N L0
"RTN","MAGDRPC2",29,0)
 S L0=0 F  S L0=$O(^MAG(2006.1,L0)) Q:'L0  D:L0'=D0
"RTN","MAGDRPC2",30,0)
 . S $P(^MAG(2006.1,L0,NODE),"^",PIECE)=$S(SET:X,1:"")
"RTN","MAGDRPC2",31,0)
 . Q
"RTN","MAGDRPC2",32,0)
 Q
"RTN","MAGDRPC2",33,0)
 ;
"RTN","MAGDRPC2",34,0)
IMAGE(OUT,D0) ; RPC = MAG DICOM GET BASIC IMAGE
"RTN","MAGDRPC2",35,0)
 N I,MSG,TARGET,V,VE,VI,X
"RTN","MAGDRPC2",36,0)
 K OUT S I=1
"RTN","MAGDRPC2",37,0)
 I '$G(D0) S OUT(1)="-1,Invalid IEN ("_$G(D0)_")" Q
"RTN","MAGDRPC2",38,0)
 I $D(^MAG(2005.1,D0,0)) S OUT(1)="-3,Image #"_D0_" has been deleted." Q
"RTN","MAGDRPC2",39,0)
 I '$D(^MAG(2005,D0,0)) S OUT(1)="-2,No data for """_D0_"""." Q
"RTN","MAGDRPC2",40,0)
 ;
"RTN","MAGDRPC2",41,0)
 D GETS^DIQ(2005,D0_",","*","REIN","TARGET","MSG")
"RTN","MAGDRPC2",42,0)
 S X="" F  S X=$O(TARGET(2005,D0_",",X)) Q:X=""  D
"RTN","MAGDRPC2",43,0)
 . S VI=$G(TARGET(2005,D0_",",X,"I"))
"RTN","MAGDRPC2",44,0)
 . S VE=$G(TARGET(2005,D0_",",X,"E"))
"RTN","MAGDRPC2",45,0)
 . S I=I+1,OUT(I)=X_"^"_VI S:VI'=VE OUT(I)=OUT(I)_"^"_VE
"RTN","MAGDRPC2",46,0)
 . Q
"RTN","MAGDRPC2",47,0)
 ;
"RTN","MAGDRPC2",48,0)
 D FILEFIND^MAGDFB(D0,"FULL",0,0,.X,.V)
"RTN","MAGDRPC2",49,0)
 S:X'<0 I=I+1,OUT(I)="Full FileName^"_X
"RTN","MAGDRPC2",50,0)
 S:V'<0 I=I+1,OUT(I)="Full Path+FileName^"_V
"RTN","MAGDRPC2",51,0)
 ;
"RTN","MAGDRPC2",52,0)
 D FILEFIND^MAGDFB(D0,"BIG",0,0,.X,.V)
"RTN","MAGDRPC2",53,0)
 S:X'<0 I=I+1,OUT(I)="Big FileName^"_X
"RTN","MAGDRPC2",54,0)
 S:V'<0 I=I+1,OUT(I)="Big Path+FileName^"_V
"RTN","MAGDRPC2",55,0)
 ;
"RTN","MAGDRPC2",56,0)
 D FILEFIND^MAGDFB(D0,"ABSTRACT",0,0,.X,.V)
"RTN","MAGDRPC2",57,0)
 S:X'<0 I=I+1,OUT(I)="Abstract FileName^"_X
"RTN","MAGDRPC2",58,0)
 S:V'<0 I=I+1,OUT(I)="Abstract Path+FileName^"_V
"RTN","MAGDRPC2",59,0)
 ;
"RTN","MAGDRPC2",60,0)
 S (V,X)=0 F  S X=$O(^MAG(2005,D0,1,X)) Q:'X  S V=V+1
"RTN","MAGDRPC2",61,0)
 S:V I=I+1,OUT(I)="# Images^"_V
"RTN","MAGDRPC2",62,0)
 ;
"RTN","MAGDRPC2",63,0)
 S OUT(1)=I-1
"RTN","MAGDRPC2",64,0)
 Q
"RTN","MAGDRPC2",65,0)
 ;
"RTN","MAGDRPC2",66,0)
GRPIMG(OUT,D0) ; RPC = MAG DICOM GET IMAGE GROUP
"RTN","MAGDRPC2",67,0)
 N I,D1,X
"RTN","MAGDRPC2",68,0)
 K OUT S I=1
"RTN","MAGDRPC2",69,0)
 S D1=0 F  S D1=$O(^MAG(2005,D0,1,D1)) Q:'D1  D
"RTN","MAGDRPC2",70,0)
 . S X=$P($G(^MAG(2005,D0,1,D1,0)),"^",1) Q:'X
"RTN","MAGDRPC2",71,0)
 . S I=I+1,OUT(I)=X
"RTN","MAGDRPC2",72,0)
 . Q
"RTN","MAGDRPC2",73,0)
 S OUT(1)=I-1
"RTN","MAGDRPC2",74,0)
 Q
"RTN","MAGDRPC2",75,0)
 ;
"RTN","MAGDRPC2",76,0)
DECRYP(X) Q $S(X="":"",1:$$DECRYP^ROUTINE(X))
"RTN","MAGDRPC2",77,0)
 ;
"RTN","MAGDRPC2",78,0)
IMGVER(OUT) ; RPC = MAG DICOM GET VERSION
"RTN","MAGDRPC2",79,0)
 N D0,DATINS,FME,FML,I,L,N,P,PATCH,X
"RTN","MAGDRPC2",80,0)
 D FIND^DIC(9.7,"",".01;2I;51I","QU","MAG*3.0","*","B","","","FML","FME")
"RTN","MAGDRPC2",81,0)
 S I="" F  S I=$O(FML("DILIST","ID",I)) Q:I=""  D
"RTN","MAGDRPC2",82,0)
 . S N=$G(FML("DILIST","ID",I,.01)) Q:$P(N,"*",2)'="3.0"
"RTN","MAGDRPC2",83,0)
 . S PATCH=$P(N,"*",3) Q:'PATCH
"RTN","MAGDRPC2",84,0)
 . S PATCH(PATCH)=1
"RTN","MAGDRPC2",85,0)
 . S DATINS=$G(FML("DILIST","ID",I,2)) Q:DATINS=""
"RTN","MAGDRPC2",86,0)
 . S P=$G(FML("DILIST","ID",I,51)) Q:P=""
"RTN","MAGDRPC2",87,0)
 . S L(DATINS,PATCH_"-"_P)=""
"RTN","MAGDRPC2",88,0)
 . Q
"RTN","MAGDRPC2",89,0)
 ;
"RTN","MAGDRPC2",90,0)
 S (DATINS,L,OUT)="" F  S DATINS=$O(L(DATINS),-1) Q:DATINS=""  D
"RTN","MAGDRPC2",91,0)
 . S PATCH="" F  S PATCH=$O(L(DATINS,PATCH)) Q:PATCH=""  D
"RTN","MAGDRPC2",92,0)
 . . S:OUT="" OUT=PATCH
"RTN","MAGDRPC2",93,0)
 . . S:$G(PATCH(+PATCH)) PATCH(+PATCH)=0,L=(+PATCH)_","_L
"RTN","MAGDRPC2",94,0)
 . . Q
"RTN","MAGDRPC2",95,0)
 . Q
"RTN","MAGDRPC2",96,0)
 S OUT=L_OUT
"RTN","MAGDRPC2",97,0)
 Q
"RTN","MAGDRPC2",98,0)
 ;
"RTN","MAGDRPC2",99,0)
PLACE(LOCATION) N D0,FST,LST
"RTN","MAGDRPC2",100,0)
 S FST=+$O(^MAG(2006.1,0)),LST=+$O(^MAG(2006.1," "),-1) Q:LST=FST FST
"RTN","MAGDRPC2",101,0)
 S D0=$O(^MAG(2006.1,"B",+$G(LOCATION),"")) Q:D0 D0
"RTN","MAGDRPC2",102,0)
 Q FST
"RTN","MAGDRPC2",103,0)
 ;
"RTN","MAGDRPC2",104,0)
ROUTEDAY ; Scan for Routing Activity
"RTN","MAGDRPC2",105,0)
 N BUCKET ;- Daily tallies
"RTN","MAGDRPC2",106,0)
 N D0 ;----- Image pointer for child of current parent
"RTN","MAGDRPC2",107,0)
 N D1 ;----- Pointer to multiple in image file
"RTN","MAGDRPC2",108,0)
 N DAY ;---- Current FileMan date
"RTN","MAGDRPC2",109,0)
 N DAYTIM ;- Current FileMan timestamp
"RTN","MAGDRPC2",110,0)
 N DEST ;--- Destination
"RTN","MAGDRPC2",111,0)
 N FIRST ;-- First date for scan
"RTN","MAGDRPC2",112,0)
 N FSTX ;--- First transmission for current study
"RTN","MAGDRPC2",113,0)
 N %H ;----- $Horolog timestamp
"RTN","MAGDRPC2",114,0)
 N IMAGE ;-- Image Pointer for current image
"RTN","MAGDRPC2",115,0)
 N LAST ;--- Last date for scan
"RTN","MAGDRPC2",116,0)
 N LSTQ ;--- Timestamp for last queue entry in current study
"RTN","MAGDRPC2",117,0)
 N P3 ;----- Highest IEN in statistics file
"RTN","MAGDRPC2",118,0)
 N P4 ;----- Number of entries in statistics file
"RTN","MAGDRPC2",119,0)
 N PARENT ;- Image Pointer for parent of current image
"RTN","MAGDRPC2",120,0)
 N X ;------ Scratch
"RTN","MAGDRPC2",121,0)
 N XMIT ;--- Total duration of transmissions for current study
"RTN","MAGDRPC2",122,0)
 ;
"RTN","MAGDRPC2",123,0)
 K ^TMP("MAG",$J,"RTD1")
"RTN","MAGDRPC2",124,0)
 K ^TMP("MAG",$J,"RTD2")
"RTN","MAGDRPC2",125,0)
 S %H=$H-4 D YMD^%DTC S FIRST=X
"RTN","MAGDRPC2",126,0)
 S %H=$H+2 D YMD^%DTC S LAST=X
"RTN","MAGDRPC2",127,0)
 ;
"RTN","MAGDRPC2",128,0)
 S DEST="" F  S DEST=$O(^MAG(2005,"ROUTE",DEST)) Q:DEST=""  D
"RTN","MAGDRPC2",129,0)
 . S NAME(DEST)=$P($G(^MAG(2005.2,DEST,0)," ? "_DEST),"^",1)
"RTN","MAGDRPC2",130,0)
 . S DAYTIM=FIRST F  D  S DAYTIM=$O(^MAG(2005,"ROUTE",DEST,DAYTIM)) Q:DAYTIM=""  Q:DAYTIM'<LAST
"RTN","MAGDRPC2",131,0)
 . . S DAY=DAYTIM\1
"RTN","MAGDRPC2",132,0)
 . . S IMAGE="" F  S IMAGE=$O(^MAG(2005,"ROUTE",DEST,DAYTIM,IMAGE)) Q:IMAGE=""  D
"RTN","MAGDRPC2",133,0)
 . . . S PARENT=$P($G(^MAG(2005,IMAGE,0)),"^",10)
"RTN","MAGDRPC2",134,0)
 . . . S (XMIT,LSTQ)=0,FSTX=1E9
"RTN","MAGDRPC2",135,0)
 . . . S D0=IMAGE,D1=0 D  I PARENT F  S D1=$O(^MAG(2005,PARENT,1,D1)) Q:'D1  S D0=+$P($G(^MAG(2005,PARENT,1,D1,0)),"^",1) D
"RTN","MAGDRPC2",136,0)
 . . . . Q:'D0
"RTN","MAGDRPC2",137,0)
 . . . . Q:$D(^TMP("MAG",$J,"RTD1",D0,D1))
"RTN","MAGDRPC2",138,0)
 . . . . S ^TMP("MAG",$J,"RTD1",D0,D1)=""
"RTN","MAGDRPC2",139,0)
 . . . . S D1=0 F  S D1=$O(^MAG(2005,D0,4,D1)) Q:'D1  D
"RTN","MAGDRPC2",140,0)
 . . . . . S X=$G(^MAG(2005,D0,4,D1,0))
"RTN","MAGDRPC2",141,0)
 . . . . . Q:$P($P(X,"^",1),".",1)'=DAY
"RTN","MAGDRPC2",142,0)
 . . . . . Q:$P(X,"^",2)'=DEST
"RTN","MAGDRPC2",143,0)
 . . . . . S:$P(X,"^",6)>LSTQ LSTQ=$P(X,"^",6)
"RTN","MAGDRPC2",144,0)
 . . . . . S:$P(X,"^",5)<FSTX FSTX=$P(X,"^",5)
"RTN","MAGDRPC2",145,0)
 . . . . . S XMIT=XMIT+$$DELTA($P(X,"^",5),$P(X,"^",1))
"RTN","MAGDRPC2",146,0)
 . . . . . Q
"RTN","MAGDRPC2",147,0)
 . . . . Q
"RTN","MAGDRPC2",148,0)
 . . . S X=$$DELTA(LSTQ,FSTX)
"RTN","MAGDRPC2",149,0)
 . . . S:X>$G(BUCKET(DAY,DEST,1)) BUCKET(DAY,DEST,1)=X
"RTN","MAGDRPC2",150,0)
 . . . S X=$S(X<300:1,X<900:2,X<3600:3,1:4)
"RTN","MAGDRPC2",151,0)
 . . . S BUCKET(DAY,DEST,1,X)=$G(BUCKET(DAY,DEST,1,X))+1
"RTN","MAGDRPC2",152,0)
 . . . S:XMIT>$G(BUCKET(DAY,DEST,2)) BUCKET(DAY,DEST,2)=XMIT
"RTN","MAGDRPC2",153,0)
 . . . S X=$S(XMIT<300:1,XMIT<900:2,XMIT<3600:3,1:4)
"RTN","MAGDRPC2",154,0)
 . . . S BUCKET(DAY,DEST,2,X)=$G(BUCKET(DAY,DEST,2,X))+1
"RTN","MAGDRPC2",155,0)
 . . . Q
"RTN","MAGDRPC2",156,0)
 . . Q
"RTN","MAGDRPC2",157,0)
 . Q
"RTN","MAGDRPC2",158,0)
 ;
"RTN","MAGDRPC2",159,0)
 S X=$G(^TMP("MAG",$J,"RTD2",0)),P3=+$P(X,"^",3),P4=+$P(X,"^",4)
"RTN","MAGDRPC2",160,0)
 S DAY="" F  S DAY=$O(BUCKET(DAY)) Q:DAY=""  D
"RTN","MAGDRPC2",161,0)
 . S:'$D(^TMP("MAG",$J,"RTD2",DAY)) P4=P4+1,^TMP("MAG",$J,"RTD2",DAY,0)=DAY
"RTN","MAGDRPC2",162,0)
 . S D1=0,DEST="" F  S DEST=$O(BUCKET(DAY,DEST)) Q:DEST=""  D
"RTN","MAGDRPC2",163,0)
 . . S D1=D1+1
"RTN","MAGDRPC2",164,0)
 . . S X=$G(BUCKET(DAY,DEST,2,1))       ; Less than 5 minutes
"RTN","MAGDRPC2",165,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,2,2)) ; Less than 15 minutes
"RTN","MAGDRPC2",166,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,2,3)) ; Less than 1 hour
"RTN","MAGDRPC2",167,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,2,4)) ; 1 hour or more
"RTN","MAGDRPC2",168,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,2))   ; Longest
"RTN","MAGDRPC2",169,0)
 . . S X=X_"^Duration ("_NAME(DEST)_")"
"RTN","MAGDRPC2",170,0)
 . . S ^TMP("MAG",$J,"RTD2",DAY,1,D1,0)=X
"RTN","MAGDRPC2",171,0)
 . . S D1=D1+1
"RTN","MAGDRPC2",172,0)
 . . S X=$G(BUCKET(DAY,DEST,1,1))       ; Less than 5 minutes
"RTN","MAGDRPC2",173,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,1,2)) ; Less than 15 minutes
"RTN","MAGDRPC2",174,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,1,3)) ; Less than 1 hour
"RTN","MAGDRPC2",175,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,1,4)) ; 1 hour or more
"RTN","MAGDRPC2",176,0)
 . . S X=X_"^"_$G(BUCKET(DAY,DEST,1))   ; Longest
"RTN","MAGDRPC2",177,0)
 . . S X=X_"^Lag ("_NAME(DEST)_")"
"RTN","MAGDRPC2",178,0)
 . . S ^TMP("MAG",$J,"RTD2",DAY,1,D1,0)=X
"RTN","MAGDRPC2",179,0)
 . . Q
"RTN","MAGDRPC2",180,0)
 . S:DAY>P3 P3=DAY
"RTN","MAGDRPC2",181,0)
 . Q
"RTN","MAGDRPC2",182,0)
 ; Purge old entries
"RTN","MAGDRPC2",183,0)
 S R=$G(^MAGDICOM(2006.563,1,"RETAIN ROUTING STATISTICS")) S:R<1 R=30
"RTN","MAGDRPC2",184,0)
 S %H=$H-R D YMD^%DTC S DAY=X
"RTN","MAGDRPC2",185,0)
 S D0=0 F  S D0=$O(^TMP("MAG",$J,"RTD2",D0)) Q:'D0  Q:D0'<DAY  D
"RTN","MAGDRPC2",186,0)
 . K ^TMP("MAG",$J,"RTD2",D0) S P4=P4-1
"RTN","MAGDRPC2",187,0)
 . Q
"RTN","MAGDRPC2",188,0)
 ;
"RTN","MAGDRPC2",189,0)
 D  ; Get routing statistics
"RTN","MAGDRPC2",190,0)
 . N A,W
"RTN","MAGDRPC2",191,0)
 . S (A,DAY)=0 F  S DAY=$O(^TMP("MAG",$J,"RTD2",DAY)) Q:'DAY  D
"RTN","MAGDRPC2",192,0)
 . . S:'A N=N+1,OUT(N)="Route",A=1
"RTN","MAGDRPC2",193,0)
 . . S N=N+1,OUT(N)="RDT="_DAY
"RTN","MAGDRPC2",194,0)
 . . S W=0 F  S W=$O(^TMP("MAG",$J,"RTD2",DAY,1,W)) Q:'W  D
"RTN","MAGDRPC2",195,0)
 . . . S X=$G(^TMP("MAG",$J,"RTD2",DAY,1,W,0))
"RTN","MAGDRPC2",196,0)
 . . . S N=N+1,OUT(N)="DST="_$P($P($P(X,"^",6),"(",2),")",1)
"RTN","MAGDRPC2",197,0)
 . . . S W=W+1,$P(X,"^",6,10)=$P($G(^TMP("MAG",$J,"RTD2",DAY,1,W,0)),"^",1,5)
"RTN","MAGDRPC2",198,0)
 . . . S N=N+1,OUT(N)="RST="_X
"RTN","MAGDRPC2",199,0)
 . . . Q
"RTN","MAGDRPC2",200,0)
 . . Q
"RTN","MAGDRPC2",201,0)
 . S:A N=N+1,OUT(N)="RouteEnd"
"RTN","MAGDRPC2",202,0)
 . Q
"RTN","MAGDRPC2",203,0)
 K ^TMP("MAG",$J,"RTD1")
"RTN","MAGDRPC2",204,0)
 K ^TMP("MAG",$J,"RTD2")
"RTN","MAGDRPC2",205,0)
 Q
"RTN","MAGDRPC2",206,0)
 ;
"RTN","MAGDRPC2",207,0)
DELTA(START,STOP) N D,D1,D2,T1,T2
"RTN","MAGDRPC2",208,0)
 S D1=$P(START,".",1),D2=$P(STOP,".",1)
"RTN","MAGDRPC2",209,0)
 S T1=START*1E6#1E6,T2=STOP*1E6#1E6
"RTN","MAGDRPC2",210,0)
 S T1=T1\10000*60+(T1\100#100)*60+(T1#100)
"RTN","MAGDRPC2",211,0)
 S T2=T2\10000*60+(T2\100#100)*60+(T2#100)
"RTN","MAGDRPC2",212,0)
 S D=0 D:D1'=D2
"RTN","MAGDRPC2",213,0)
 . N %H,%T,%Y,X
"RTN","MAGDRPC2",214,0)
 . S X=D1 D H^%DTC S D1=%H
"RTN","MAGDRPC2",215,0)
 . S X=D2 D H^%DTC S D2=%H
"RTN","MAGDRPC2",216,0)
 . S D=D2-D1
"RTN","MAGDRPC2",217,0)
 . Q
"RTN","MAGDRPC2",218,0)
 Q D*86400+T2-T1
"RTN","MAGDRPC2",219,0)
 ;
"RTN","MAGDRPC3")
0^20^B43162021
"RTN","MAGDRPC3",1,0)
MAGDRPC3 ;WOIFO/EdM - Imaging RPCs ; 06/18/2004  14:42
"RTN","MAGDRPC3",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDRPC3",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC3",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC3",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC3",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC3",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC3",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC3",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC3",10,0)
 ;; |                                                               |
"RTN","MAGDRPC3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC3",17,0)
 ;;
"RTN","MAGDRPC3",18,0)
 Q
"RTN","MAGDRPC3",19,0)
 ;
"RTN","MAGDRPC3",20,0)
RADLKUP(OUT,CASENUMB,STUDYDAT) ; RPC = MAG DICOM LOOKUP RAD STUDY
"RTN","MAGDRPC3",21,0)
 ; Radiology patient/study lookup
"RTN","MAGDRPC3",22,0)
 N ACCNUM ;--- Accession Number
"RTN","MAGDRPC3",23,0)
 N CPTCODE ;-- CPT code for the procedure
"RTN","MAGDRPC3",24,0)
 N CPTNAME ;-- CPT name for the procedure
"RTN","MAGDRPC3",25,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDRPC3",26,0)
 N PROCDESC ;- Procedure description
"RTN","MAGDRPC3",27,0)
 N PROCIEN ;-- radiology procedure ien in ^RAMIS(71)
"RTN","MAGDRPC3",28,0)
 N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDRPC3",29,0)
 N RADPT1 ;--- first level subscript in ^RADPT
"RTN","MAGDRPC3",30,0)
 N RADPT2 ;--- second level subscript in ^RADPT (after "DT")
"RTN","MAGDRPC3",31,0)
 N RADPT3 ;--- third level subscript in ^RADPT (after "P")
"RTN","MAGDRPC3",32,0)
 N D1,I,LIST,X,Z
"RTN","MAGDRPC3",33,0)
 ;
"RTN","MAGDRPC3",34,0)
 ; find the patient/study in ^RADPT using the Radiology Case Number
"RTN","MAGDRPC3",35,0)
 K OUT
"RTN","MAGDRPC3",36,0)
 D
"RTN","MAGDRPC3",37,0)
 . I $G(CASENUMB)="" S OUT(1)="-1,No Case Number Specified" Q
"RTN","MAGDRPC3",38,0)
 . S RAIX=$S($D(^RADPT("C")):"C",1:"AE") ; for Radiology Patch RA*5*7
"RTN","MAGDRPC3",39,0)
 . S RAIX=$S(CASENUMB["-":"ADC",1:RAIX) ; select the cross-reference
"RTN","MAGDRPC3",40,0)
 . S RADPT1=$O(^RADPT(RAIX,CASENUMB,"")) I 'RADPT1 D  Q:'RADPT1
"RTN","MAGDRPC3",41,0)
 . . I '$G(STUDYDAT) S OUT(1)="-2,No Study Date Specified",RADPT1=0 Q
"RTN","MAGDRPC3",42,0)
 . . ;
"RTN","MAGDRPC3",43,0)
 . . ; Search 1-3 days prior the study date OR a day in advance but only
"RTN","MAGDRPC3",44,0)
 . . ; if the study date is not equal to today or greater than today.
"RTN","MAGDRPC3",45,0)
 . . ; Has to be long case number or must have an image study date
"RTN","MAGDRPC3",46,0)
 . . ;
"RTN","MAGDRPC3",47,0)
 . . N II,RCASE,SDATE,TODAY,X,Y,%,%I
"RTN","MAGDRPC3",48,0)
 . . ;
"RTN","MAGDRPC3",49,0)
 . . S RCASE=$S(CASENUMB["-":$P(CASENUMB,"-",2),1:CASENUMB)
"RTN","MAGDRPC3",50,0)
 . . I 'RCASE S RADPT1=0 Q
"RTN","MAGDRPC3",51,0)
 . . ;
"RTN","MAGDRPC3",52,0)
 . . D NOW^%DTC S TODAY=X
"RTN","MAGDRPC3",53,0)
 . . S X=$P(STUDYDAT,"."),SDATE=$E(X,1,4)-1700_$E(X,5,8) ; FileMan date
"RTN","MAGDRPC3",54,0)
 . . ;
"RTN","MAGDRPC3",55,0)
 . . ; 1-3 days prior study date
"RTN","MAGDRPC3",56,0)
 . . F II=1:1:3 S RADPT1=$$FIND(SDATE,RCASE,-II) Q:RADPT1
"RTN","MAGDRPC3",57,0)
 . . Q:RADPT1
"RTN","MAGDRPC3",58,0)
 . . ;
"RTN","MAGDRPC3",59,0)
 . . ; Wild goose chase, but check for today's case
"RTN","MAGDRPC3",60,0)
 . . S RADPT1=$O(^RADPT("ADC",$$MMDDYY(TODAY)_"-"_RCASE,"")) Q:RADPT1
"RTN","MAGDRPC3",61,0)
 . . ;
"RTN","MAGDRPC3",62,0)
 . . I SDATE'<TODAY S RADPT1=0 Q
"RTN","MAGDRPC3",63,0)
 . . ;
"RTN","MAGDRPC3",64,0)
 . . ; One day in advance?
"RTN","MAGDRPC3",65,0)
 . . S RADPT1=$$FIND(SDATE,RCASE,1) Q:RADPT1
"RTN","MAGDRPC3",66,0)
 . . ;
"RTN","MAGDRPC3",67,0)
 . . ; Finally just check the "C" or "AE" x-reference for the case number
"RTN","MAGDRPC3",68,0)
 . . S X=$S($O(^RADPT("C","")):"C",1:"AE") ; RA*5*7 patch
"RTN","MAGDRPC3",69,0)
 . . S RADPT1=$O(^RADPT(X,RCASE,""))
"RTN","MAGDRPC3",70,0)
 . . Q
"RTN","MAGDRPC3",71,0)
 . S RADPT2=$O(^RADPT(RAIX,CASENUMB,RADPT1,"")) Q:'RADPT2
"RTN","MAGDRPC3",72,0)
 . S RADPT3=$O(^RADPT(RAIX,CASENUMB,RADPT1,RADPT2,"")) Q:'RADPT3
"RTN","MAGDRPC3",73,0)
 . Q:'$D(^RADPT(RADPT1,0))  ; no patient demographics file pointer
"RTN","MAGDRPC3",74,0)
 . ; get patient demographics file pointer
"RTN","MAGDRPC3",75,0)
 . S DFN=$P(^RADPT(RADPT1,0),"^",1)
"RTN","MAGDRPC3",76,0)
 . Q:'$D(^RADPT(RADPT1,"DT",RADPT2,0))  ; no datetime level
"RTN","MAGDRPC3",77,0)
 . ; get date and time of examination
"RTN","MAGDRPC3",78,0)
 . S DATETIME=$P($G(^RADPT(RADPT1,"DT",RADPT2,0)),"^",1)
"RTN","MAGDRPC3",79,0)
 . ; get case info
"RTN","MAGDRPC3",80,0)
 . S X=$G(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDRPC3",81,0)
 . S Z=$P(X,"^",17) I Z S Z=$P($G(^RARPT(Z,0)),"^",1) S:Z'="" ACCNUM=Z
"RTN","MAGDRPC3",82,0)
 . S PROCIEN=$P(X,"^",2),EXAMSTS=$P(X,"^",3)
"RTN","MAGDRPC3",83,0)
 . S:EXAMSTS EXAMSTS=$$GET1^DIQ(72,EXAMSTS,.01)
"RTN","MAGDRPC3",84,0)
 . S (PROCDESC,CPTNAME,CPTCODE)=""
"RTN","MAGDRPC3",85,0)
 . Q:'PROCIEN  ; need PROCIEN to do lookup in ^RAMIS
"RTN","MAGDRPC3",86,0)
 . S Z=$G(^RAMIS(71,PROCIEN,0))
"RTN","MAGDRPC3",87,0)
 . S PROCDESC=$P(Z,"^",1),CPTCODE=$P(Z,"^",9)
"RTN","MAGDRPC3",88,0)
 . S CPTNAME=$P($G(^ICPT(+CPTCODE,0)),"^",2) S:CPTNAME="" CPTNAME=PROCDESC
"RTN","MAGDRPC3",89,0)
 . Q
"RTN","MAGDRPC3",90,0)
 S OUT(2)=$G(RADPT1)
"RTN","MAGDRPC3",91,0)
 S OUT(3)=$G(RADPT2)
"RTN","MAGDRPC3",92,0)
 S OUT(4)=$G(RADPT3)
"RTN","MAGDRPC3",93,0)
 S OUT(5)=$G(PROCIEN)
"RTN","MAGDRPC3",94,0)
 S OUT(6)=$G(CPTCODE)
"RTN","MAGDRPC3",95,0)
 S OUT(7)=$G(CPTNAME)
"RTN","MAGDRPC3",96,0)
 S OUT(8)=$G(Z)
"RTN","MAGDRPC3",97,0)
 S OUT(9)=$G(EXAMSTS)
"RTN","MAGDRPC3",98,0)
 S OUT(10)=$G(DFN)
"RTN","MAGDRPC3",99,0)
 S OUT(11)=$G(DATETIME)
"RTN","MAGDRPC3",100,0)
 S OUT(12)=$G(PROCDESC)
"RTN","MAGDRPC3",101,0)
 S X=""
"RTN","MAGDRPC3",102,0)
 I $G(PROCIEN) S D1=0 F  S D1=$O(^RAMIS(71,PROCIEN,"MDL",D1)) Q:'D1  D
"RTN","MAGDRPC3",103,0)
 . S Z=+$P($G(^RAMIS(71,PROCIEN,"MDL",D1,0)),"^",1) Q:'Z
"RTN","MAGDRPC3",104,0)
 . S Z=$P($G(^RAMIS(73.1,Z,0)),"^",1) Q:Z=""
"RTN","MAGDRPC3",105,0)
 . S:X'="" X=X_"," S X=X_Z
"RTN","MAGDRPC3",106,0)
 . Q
"RTN","MAGDRPC3",107,0)
 S OUT(13)=X ; List of Modality-codes
"RTN","MAGDRPC3",108,0)
 S X="" I $G(RADPT1),$G(RADPT2) S X=$G(^RADPT(RADPT1,"DT",RADPT2,0))
"RTN","MAGDRPC3",109,0)
 S OUT(14)=$P(X,"^",3) ; Site
"RTN","MAGDRPC3",110,0)
 ; Patient's pregnancy status at the time of the exam
"RTN","MAGDRPC3",111,0)
 S X="" I $G(DFN),$G(RADPT2),$G(RADPT3) S X=$G(^RADPT(DFN,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDRPC3",112,0)
 S OUT(15)=$P($G(^RAO(75.1,+$P(X,"^",11),0)),"^",13)
"RTN","MAGDRPC3",113,0)
 S OUT(16)=$G(ACCNUM)
"RTN","MAGDRPC3",114,0)
 S OUT(1)=1 ; OK
"RTN","MAGDRPC3",115,0)
 Q
"RTN","MAGDRPC3",116,0)
 ;
"RTN","MAGDRPC3",117,0)
QUEUE(OUT,IMAGE,APPNAM,LOCATION,ACCNUM,REASON) ; RPC = MAG DICOM QUEUE IMAGE
"RTN","MAGDRPC3",118,0)
 ; Add the DICOM study send image request to the queue
"RTN","MAGDRPC3",119,0)
 N COUNT,D0,D1,DFN,TYPE,X
"RTN","MAGDRPC3",120,0)
 ;
"RTN","MAGDRPC3",121,0)
 I '$G(IMAGE) S OUT="-1,No Image specified" Q
"RTN","MAGDRPC3",122,0)
 I $G(APPNAM)="" S OUT="-2,No Destination specified" Q
"RTN","MAGDRPC3",123,0)
 I '$G(LOCATION) S OUT="-3,No Origin specified" Q
"RTN","MAGDRPC3",124,0)
 ;
"RTN","MAGDRPC3",125,0)
 S X=$G(^MAG(2005,IMAGE,0))
"RTN","MAGDRPC3",126,0)
 S TYPE=+$P(X,"^",6),DFN=$P(X,"^",7)
"RTN","MAGDRPC3",127,0)
 I " 0 11 3 100 "'[(" "_TYPE_" ") D  Q
"RTN","MAGDRPC3",128,0)
 . S OUT="-4,Cannot Queue Image Object Type """_TYPE_"""."
"RTN","MAGDRPC3",129,0)
 . Q
"RTN","MAGDRPC3",130,0)
 ;
"RTN","MAGDRPC3",131,0)
 L +^MAGDOUTP(2006.574,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC3",132,0)
 S X=$G(^MAGDOUTP(2006.574,0))
"RTN","MAGDRPC3",133,0)
 S $P(X,"^",1,2)="DICOM IMAGE OUTPUT FILE^2006.574"
"RTN","MAGDRPC3",134,0)
 S D0=$P(X,"^",3)+1,$P(X,"^",3)=D0 ; Next number
"RTN","MAGDRPC3",135,0)
 S $P(X,"^",4)=$P(X,"^",4)+1 ; Total count
"RTN","MAGDRPC3",136,0)
 S ^MAGDOUTP(2006.574,0)=X
"RTN","MAGDRPC3",137,0)
 ;
"RTN","MAGDRPC3",138,0)
 S ^MAGDOUTP(2006.574,D0,0)=APPNAM_"^"_IMAGE_"^"_$G(ACCNUM)_"^"_LOCATION
"RTN","MAGDRPC3",139,0)
 S ^MAGDOUTP(2006.574,"C",LOCATION,D0)=""
"RTN","MAGDRPC3",140,0)
 L -^MAGDOUTP(2006.574,0)
"RTN","MAGDRPC3",141,0)
 ;
"RTN","MAGDRPC3",142,0)
 S COUNT=0
"RTN","MAGDRPC3",143,0)
 I (TYPE=3)!(TYPE=100) D  ; Single XRAY or DICOM image
"RTN","MAGDRPC3",144,0)
 . D ENQUEUE(IMAGE,D0,1)
"RTN","MAGDRPC3",145,0)
 . S COUNT=1
"RTN","MAGDRPC3",146,0)
 . Q
"RTN","MAGDRPC3",147,0)
 I TYPE=11 D  ; Process all the images in an XRAY group
"RTN","MAGDRPC3",148,0)
 . S D1=0 F  S D1=$O(^MAG(2005,IMAGE,1,D1)) Q:'D1  D
"RTN","MAGDRPC3",149,0)
 . . D ENQUEUE($P($G(^MAG(2005,IMAGE,1,D1,0)),"^",1),D0,D1)
"RTN","MAGDRPC3",150,0)
 . . S COUNT=COUNT+1
"RTN","MAGDRPC3",151,0)
 . . Q
"RTN","MAGDRPC3",152,0)
 . Q
"RTN","MAGDRPC3",153,0)
 ;
"RTN","MAGDRPC3",154,0)
 S X="DICOM transmit to "_APPNAM_" for reason "_REASON
"RTN","MAGDRPC3",155,0)
 D ENTRY^MAGLOG($C(REASON+64),DUZ,IMAGE,"DICOM Gateway",DFN,COUNT,X)
"RTN","MAGDRPC3",156,0)
 S OUT=1
"RTN","MAGDRPC3",157,0)
 Q
"RTN","MAGDRPC3",158,0)
 ;
"RTN","MAGDRPC3",159,0)
ENQUEUE(IMAGE,D0,D1) ; Add an image to the DICOM send image request queue sub-file
"RTN","MAGDRPC3",160,0)
 Q:'IMAGE
"RTN","MAGDRPC3",161,0)
 L +^MAGDOUTP(2006.574,D0,1,0):1E9 ; Background Process MUST wait
"RTN","MAGDRPC3",162,0)
 S X=$G(^MAGDOUTP(2006.574,D0,1,0))
"RTN","MAGDRPC3",163,0)
 S $P(X,"^",1,2)="^2006.5741"
"RTN","MAGDRPC3",164,0)
 S $P(X,"^",3)=D1
"RTN","MAGDRPC3",165,0)
 S $P(X,"^",4)=$P(X,"^",4)+1,OUT=$P(X,"^",4)
"RTN","MAGDRPC3",166,0)
 S ^MAGDOUTP(2006.574,D0,1,0)=X
"RTN","MAGDRPC3",167,0)
 S ^MAGDOUTP(2006.574,D0,1,D1,0)=IMAGE
"RTN","MAGDRPC3",168,0)
 L -^MAGDOUTP(2006.574,D0,1,0)
"RTN","MAGDRPC3",169,0)
 Q
"RTN","MAGDRPC3",170,0)
 ;
"RTN","MAGDRPC3",171,0)
FIND(DATE,CASE,NUM) ; ADC x-reference (Radiology patient file)
"RTN","MAGDRPC3",172,0)
 N X,X1,X2,Y
"RTN","MAGDRPC3",173,0)
 Q:'$G(DATE) 0
"RTN","MAGDRPC3",174,0)
 S (X,X1)=DATE,X2=NUM D:NUM C^%DTC Q:X<1 0
"RTN","MAGDRPC3",175,0)
 Q $O(^RADPT("ADC",$$MMDDYY(X)_"-"_CASE,""))
"RTN","MAGDRPC3",176,0)
 ;
"RTN","MAGDRPC3",177,0)
MMDDYY(DAY) ; YYYMMDD --> MMDDYY
"RTN","MAGDRPC3",178,0)
 I DAY'?7N Q 0
"RTN","MAGDRPC3",179,0)
 Q $E(DAY,4,7)_$E(DAY,2,3)
"RTN","MAGDRPC3",180,0)
 ;
"RTN","MAGDRPC4")
0^21^B67528572
"RTN","MAGDRPC4",1,0)
MAGDRPC4 ;WOIFO/EdM - Imaging RPCs ; 09/08/2004  06:44
"RTN","MAGDRPC4",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDRPC4",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC4",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC4",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC4",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC4",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC4",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC4",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC4",10,0)
 ;; |                                                               |
"RTN","MAGDRPC4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC4",17,0)
 ;;
"RTN","MAGDRPC4",18,0)
 Q
"RTN","MAGDRPC4",19,0)
 ;
"RTN","MAGDRPC4",20,0)
LOOKUP(OUT,NUMBER) ; RPC = MAG DICOM LOOKUP STUDY
"RTN","MAGDRPC4",21,0)
 ; Look Up for both Radiology and Consults
"RTN","MAGDRPC4",22,0)
 N ACCNUM ;--- Accession Number
"RTN","MAGDRPC4",23,0)
 N CPTCODE ;-- CPT code for the procedure
"RTN","MAGDRPC4",24,0)
 N CPTNAME ;-- CPT name for the procedure
"RTN","MAGDRPC4",25,0)
 N DFN ;------ Patient pointer
"RTN","MAGDRPC4",26,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDRPC4",27,0)
 N EXAMTYP ;-- Type of exam (Rad or Con)
"RTN","MAGDRPC4",28,0)
 N GMRCIEN ;-- Pointer for GMRC
"RTN","MAGDRPC4",29,0)
 N PROCDESC ;- Procedure description
"RTN","MAGDRPC4",30,0)
 N PROCIEN ;-- Radiology procedure IEN in ^RAMIS(71)
"RTN","MAGDRPC4",31,0)
 N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDRPC4",32,0)
 N RADFN ;---- first level subscript in ^RADPT
"RTN","MAGDRPC4",33,0)
 N RADTI ;---- second level subscript in ^RADPT (after "DT")
"RTN","MAGDRPC4",34,0)
 N RACNI ;---- third level subscript in ^RADPT (after "P")
"RTN","MAGDRPC4",35,0)
 N RARPT ;---- Radiology Report pointer
"RTN","MAGDRPC4",36,0)
 N I,LIST,NOUT,X,Z
"RTN","MAGDRPC4",37,0)
 ;
"RTN","MAGDRPC4",38,0)
 K OUT S NOUT=1
"RTN","MAGDRPC4",39,0)
 I $G(NUMBER)="" S OUT(1)="-1,No Case or Consult Number Specified" Q
"RTN","MAGDRPC4",40,0)
 ;
"RTN","MAGDRPC4",41,0)
 S EXAMTYP=$E(NUMBER,1)
"RTN","MAGDRPC4",42,0)
 I "RC"[EXAMTYP S NUMBER=$E(NUMBER,2,$L(NUMBER))
"RTN","MAGDRPC4",43,0)
 E  S EXAMTYP=""
"RTN","MAGDRPC4",44,0)
 K DFN
"RTN","MAGDRPC4",45,0)
 D  ; First try Radiology candidates
"RTN","MAGDRPC4",46,0)
 . I EXAMTYP'="",EXAMTYP'="R" Q
"RTN","MAGDRPC4",47,0)
 . D  ; Look for the patient/study in ^RADPT using the Radiology Case Number
"RTN","MAGDRPC4",48,0)
 . . N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDRPC4",49,0)
 . . S RAIX=$S($D(^RADPT("C")):"C",1:"AE") ; for Radiology Patch RA*5*7
"RTN","MAGDRPC4",50,0)
 . . S RAIX=$S(NUMBER["-":"ADC",1:RAIX) ; select the cross-reference
"RTN","MAGDRPC4",51,0)
 . . S RADFN=$O(^RADPT(RAIX,NUMBER,"")) I 'RADFN D  Q:'RADFN
"RTN","MAGDRPC4",52,0)
 . . . I NUMBER'["-" S OUT(1)="-2,No Study Date Specified" Q
"RTN","MAGDRPC4",53,0)
 . . . S X=$P(NUMBER,"-",1)
"RTN","MAGDRPC4",54,0)
 . . . I $L(X)'=6 S OUT(1)="-3,Invalid study date """_X_"""." Q
"RTN","MAGDRPC4",55,0)
 . . . S SDATE=$S($E(X,5,6)<30:3,1:2)_$E(X,5,6)_$E(X,1,4)
"RTN","MAGDRPC4",56,0)
 . . . D:SDATE
"RTN","MAGDRPC4",57,0)
 . . . . ; Search 1-3 days prior the study date OR a day in advance but only
"RTN","MAGDRPC4",58,0)
 . . . . ; if the study date is not equal to today or greater than today.
"RTN","MAGDRPC4",59,0)
 . . . . ; Has to be long case number or must have an image study date
"RTN","MAGDRPC4",60,0)
 . . . . N %,%I,II,RCASE,TODAY,X,Y
"RTN","MAGDRPC4",61,0)
 . . . . S RCASE=$S(NUMBER["-":$P(NUMBER,"-",2),1:NUMBER) Q:'RCASE
"RTN","MAGDRPC4",62,0)
 . . . . D NOW^%DTC S TODAY=X
"RTN","MAGDRPC4",63,0)
 . . . . ;
"RTN","MAGDRPC4",64,0)
 . . . . ;  1-3 days prior study date
"RTN","MAGDRPC4",65,0)
 . . . . F II=1:1:3 S RADFN=$$FIND(SDATE,RCASE,-II) Q:RADFN
"RTN","MAGDRPC4",66,0)
 . . . . Q:RADFN
"RTN","MAGDRPC4",67,0)
 . . . . ;
"RTN","MAGDRPC4",68,0)
 . . . . ; Wild goose chase but check for today's case
"RTN","MAGDRPC4",69,0)
 . . . . S RADFN=$O(^RADPT("ADC",$$MMDDYY(TODAY)_"-"_RCASE,"")) Q:RADFN
"RTN","MAGDRPC4",70,0)
 . . . . ;
"RTN","MAGDRPC4",71,0)
 . . . . Q:SDATE'<TODAY
"RTN","MAGDRPC4",72,0)
 . . . . S RADFN=$$FIND(SDATE,RCASE,1) Q:RADFN  ; Advance a day
"RTN","MAGDRPC4",73,0)
 . . . . ;
"RTN","MAGDRPC4",74,0)
 . . . . ; Finally just check the "C" or "AE" x-reference for the case number
"RTN","MAGDRPC4",75,0)
 . . . . ; based on RA*5*7 patch
"RTN","MAGDRPC4",76,0)
 . . . . S RADFN=$O(^RADPT($S($O(^RADPT("C","")):"C",1:"AE"),RCASE,""))
"RTN","MAGDRPC4",77,0)
 . . . . Q
"RTN","MAGDRPC4",78,0)
 . . . Q
"RTN","MAGDRPC4",79,0)
 . . S RADTI=$O(^RADPT(RAIX,NUMBER,RADFN,"")) Q:'RADTI
"RTN","MAGDRPC4",80,0)
 . . S RACNI=$O(^RADPT(RAIX,NUMBER,RADFN,RADTI,"")) Q:'RACNI
"RTN","MAGDRPC4",81,0)
 . . Q:'$D(^RADPT(RADFN,0))  ; No patient demographics file pointer
"RTN","MAGDRPC4",82,0)
 . . S DFN=$P(^RADPT(RADFN,0),"^",1)
"RTN","MAGDRPC4",83,0)
 . . Q
"RTN","MAGDRPC4",84,0)
 . Q:'$G(DFN)
"RTN","MAGDRPC4",85,0)
 . Q:'$D(^RADPT(DFN,"DT",RADTI,0))
"RTN","MAGDRPC4",86,0)
 . S RARPT=$P($G(^RADPT(DFN,"DT",RADTI,"P",RACNI,0)),"^",17) Q:'RARPT
"RTN","MAGDRPC4",87,0)
 . S ACCNUM=$P($G(^RARPT(RARPT,0)),"^",1)
"RTN","MAGDRPC4",88,0)
 . S I=0 F  S I=$O(^RARPT(RARPT,2005,I)) Q:'I  D
"RTN","MAGDRPC4",89,0)
 . . S X="74^"_RARPT_"^"_$P($G(^RARPT(RARPT,2005,I,0)),"^",1)_"^"_ACCNUM
"RTN","MAGDRPC4",90,0)
 . . S NOUT=NOUT+1,OUT(NOUT)=X
"RTN","MAGDRPC4",91,0)
 . . Q
"RTN","MAGDRPC4",92,0)
 . Q
"RTN","MAGDRPC4",93,0)
 ;
"RTN","MAGDRPC4",94,0)
 K DFN
"RTN","MAGDRPC4",95,0)
 D  ; Now look for any consults that might qualify
"RTN","MAGDRPC4",96,0)
 . N ACCNUM,MAGIEN,MAGPTR,REPORTF,REPORTI,TIUIEN,TIUPTR,TIUXIEN
"RTN","MAGDRPC4",97,0)
 . I EXAMTYP'="",EXAMTYP'="C" Q
"RTN","MAGDRPC4",98,0)
 . S ACCNUM="GMRC-"_$S(NUMBER?1"GMRC-"1.N:$P(NUMBER,"GMRC-",2),1:NUMBER)
"RTN","MAGDRPC4",99,0)
 . S GMRCIEN=$P(ACCNUM,"-",2)
"RTN","MAGDRPC4",100,0)
 . D
"RTN","MAGDRPC4",101,0)
 . . N D0,Z
"RTN","MAGDRPC4",102,0)
 . . S D0=$P(ACCNUM,"-",2)
"RTN","MAGDRPC4",103,0)
 . . S DFN=$$GET1^DIQ(123,D0,.02,"I") Q:'DFN
"RTN","MAGDRPC4",104,0)
 . . S EXAMSTS=$$GET1^DIQ(123,D0,8) ; check for cancelled exam
"RTN","MAGDRPC4",105,0)
 . . I EXAMSTS="CANCELLED" S OUT(1)="-4,Consult is cancelled" Q
"RTN","MAGDRPC4",106,0)
 . . S PROCDESC=$$GET1^DIQ(123,D0,1)
"RTN","MAGDRPC4",107,0)
 . . S Z=$$GET1^DIQ(123,D0,13,"I") ; request type
"RTN","MAGDRPC4",108,0)
 . . Q
"RTN","MAGDRPC4",109,0)
 . I '$G(DFN) S OUT(1)="-5,Consult/procedure not on file" Q
"RTN","MAGDRPC4",110,0)
 . ; Find the images - they can be linked to TIU or imaging file 2006.5839
"RTN","MAGDRPC4",111,0)
 . S MAGPTR=$O(^MAG(2006.5839,"C",123,GMRCIEN,0))
"RTN","MAGDRPC4",112,0)
 . I MAGPTR D  Q  ; Found it in ^MAG(2006.5839 - not in ^TIU yet
"RTN","MAGDRPC4",113,0)
 . . S X=^MAG(2006.5839,MAGPTR,0)
"RTN","MAGDRPC4",114,0)
 . . S X=$P(X,"^",1)_"^"_$P(X,"^",2)_"^^"_$P(X,"^",3)
"RTN","MAGDRPC4",115,0)
 . . S NOUT=NOUT+1,OUT(NOUT)=X
"RTN","MAGDRPC4",116,0)
 . . Q
"RTN","MAGDRPC4",117,0)
 . D  ; Otherwise find images in ^TIU
"RTN","MAGDRPC4",118,0)
 . . N I,X
"RTN","MAGDRPC4",119,0)
 . . D TIUALL^MAGDGMRC(GMRCIEN,.RESULT)
"RTN","MAGDRPC4",120,0)
 . . S I="" F  S I=$O(RESULT(I)) Q:I=""  D
"RTN","MAGDRPC4",121,0)
 . . . S X="8925^"_$P(RESULT(I),"^",1)_"^"_$P(RESULT(I),"^",3)_"^"_$P(RESULT(I),"^",2)
"RTN","MAGDRPC4",122,0)
 . . . S NOUT=NOUT+1,OUT(NOUT)=X
"RTN","MAGDRPC4",123,0)
 . . . Q
"RTN","MAGDRPC4",124,0)
 . . Q
"RTN","MAGDRPC4",125,0)
 . Q
"RTN","MAGDRPC4",126,0)
 S OUT(1)=NOUT-1
"RTN","MAGDRPC4",127,0)
 Q
"RTN","MAGDRPC4",128,0)
 ;
"RTN","MAGDRPC4",129,0)
NEXTIMG(OUT,FROM,D0,D1,SENT) ; RPC = MAG DICOM GET NEXT QUEUE ENTRY
"RTN","MAGDRPC4",130,0)
 ; Get next file to be DICOM transmitted
"RTN","MAGDRPC4",131,0)
 N H,F1,F2,F3,I,N,S0,S1,TYPE,X
"RTN","MAGDRPC4",132,0)
 I $G(FROM)="" S OUT(1)="-1,No Origin Specified"
"RTN","MAGDRPC4",133,0)
 ; First clean up transmitted queue entries
"RTN","MAGDRPC4",134,0)
 S I="" F  S I=$O(SENT(I)) Q:I=""  D
"RTN","MAGDRPC4",135,0)
 . S S0=$P(SENT(I),"^",1),S1=$P(SENT(I),"^",2)
"RTN","MAGDRPC4",136,0)
 . Q:'$D(^MAGDOUTP(2006.574,S0,1,S1))
"RTN","MAGDRPC4",137,0)
 . L +^MAGDOUTP(2006.574,S0,1,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC4",138,0)
 . K ^MAGDOUTP(2006.574,S0,1,S1)
"RTN","MAGDRPC4",139,0)
 . S X=$G(^MAGDOUTP(2006.574,S0,1,0))
"RTN","MAGDRPC4",140,0)
 . S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC4",141,0)
 . S ^MAGDOUTP(2006.574,S0,1,0)=X
"RTN","MAGDRPC4",142,0)
 . L -^MAGDOUTP(2006.574,S0,1,0)
"RTN","MAGDRPC4",143,0)
 . Q:$O(^MAGDOUTP(2006.574,S0,1,0))
"RTN","MAGDRPC4",144,0)
 . L +^MAGDOUTP(2006.574,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC4",145,0)
 . K ^MAGDOUTP(2006.574,S0)
"RTN","MAGDRPC4",146,0)
 . K ^MAGDOUTP(2006.574,"C",FROM,S0)
"RTN","MAGDRPC4",147,0)
 . S X=$G(^MAGDOUTP(2006.574,0))
"RTN","MAGDRPC4",148,0)
 . S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC4",149,0)
 . S ^MAGDOUTP(2006.574,0)=X
"RTN","MAGDRPC4",150,0)
 . L -^MAGDOUTP(2006.574,0)
"RTN","MAGDRPC4",151,0)
 . Q
"RTN","MAGDRPC4",152,0)
 S D0=+$G(D0)
"RTN","MAGDRPC4",153,0)
 S D1=+$G(D1)
"RTN","MAGDRPC4",154,0)
 S OUT(1)="" F  D  Q:OUT(1)'=""
"RTN","MAGDRPC4",155,0)
 . S S0=$O(^MAGDOUTP(2006.574,"C",FROM,"")) S:S0>D0 D0=S0,D1=0
"RTN","MAGDRPC4",156,0)
 . I 'S0 S OUT(1)="-2,No studies to be transmitted" Q
"RTN","MAGDRPC4",157,0)
 . S D1=$O(^MAGDOUTP(2006.574,D0,1,D1)) D:'D1
"RTN","MAGDRPC4",158,0)
 . . S D0=$O(^MAGDOUTP(2006.574,"C",FROM,D0)) Q:'D0
"RTN","MAGDRPC4",159,0)
 . . S D1=$O(^MAGDOUTP(2006.574,D0,1,0))
"RTN","MAGDRPC4",160,0)
 . . Q
"RTN","MAGDRPC4",161,0)
 . I 'D0 S OUT(1)="-3,No files to be transmitted" Q
"RTN","MAGDRPC4",162,0)
 . I 'D1 D  Q
"RTN","MAGDRPC4",163,0)
 . . S X=$G(^MAGDOUTP(2006,574,D0,1,0))
"RTN","MAGDRPC4",164,0)
 . . S H=$P(X,"^",5) I H="" S $P(X,"^",5)=$H Q
"RTN","MAGDRPC4",165,0)
 . . S N=$H,N=N*86400+$P(N,",",2),H=H*86400+$P(H,",",2)
"RTN","MAGDRPC4",166,0)
 . . I N-H<300 S OUT(1)="-3,No files to be transmitted" Q
"RTN","MAGDRPC4",167,0)
 . . L +^MAGDOUTP(2006.574,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC4",168,0)
 . . K ^MAGDOUTP(2006.574,D0)
"RTN","MAGDRPC4",169,0)
 . . K ^MAGDOUTP(2006.574,"C",FROM,D0)
"RTN","MAGDRPC4",170,0)
 . . S X=$G(^MAGDOUTP(2006.574,0))
"RTN","MAGDRPC4",171,0)
 . . S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC4",172,0)
 . . S ^MAGDOUTP(2006.574,0)=X
"RTN","MAGDRPC4",173,0)
 . . L -^MAGDOUTP(2006.574,0)
"RTN","MAGDRPC4",174,0)
 . . Q
"RTN","MAGDRPC4",175,0)
 . S OUT(1)=1
"RTN","MAGDRPC4",176,0)
 . S OUT(2)=D0
"RTN","MAGDRPC4",177,0)
 . S OUT(3)=D1
"RTN","MAGDRPC4",178,0)
 . S X=$G(^MAGDOUTP(2006.574,D0,0))
"RTN","MAGDRPC4",179,0)
 . S OUT(4)=$P(X,"^",1) ; Application
"RTN","MAGDRPC4",180,0)
 . S OUT(5)=$P(X,"^",2) ; Group
"RTN","MAGDRPC4",181,0)
 . S OUT(6)=$P(X,"^",3) ; Accession Number
"RTN","MAGDRPC4",182,0)
 . S OUT(7)=+$G(^MAGDOUTP(2006.574,D0,1,D1,0)) ; Image
"RTN","MAGDRPC4",183,0)
 . S OUT(8)=$P($G(^MAG(2005,+OUT(7),0)),"^",6)
"RTN","MAGDRPC4",184,0)
 . S TYPE=$S($G(^MAG(2005,+OUT(7),"FBIG"))'="":"BIG",1:"FULL")
"RTN","MAGDRPC4",185,0)
 . ; 3rd parameter set to 1 to allow retrieval from jukebox
"RTN","MAGDRPC4",186,0)
 . D FILEFIND^MAGDFB(+OUT(7),TYPE,1,0,.F1,.F2)
"RTN","MAGDRPC4",187,0)
 . S OUT(9)=F1
"RTN","MAGDRPC4",188,0)
 . S OUT(10)=F2
"RTN","MAGDRPC4",189,0)
 . S OUT(11)=$P($G(^MAG(2005,+OUT(5),0)),"^",7) ; get DFN
"RTN","MAGDRPC4",190,0)
 . ; get path for *.TXT, always the same as the FULL file
"RTN","MAGDRPC4",191,0)
 . D FILEFIND^MAGDFB(+OUT(7),"FULL",1,0,.F1,.F3)
"RTN","MAGDRPC4",192,0)
 . S OUT(12)=F3
"RTN","MAGDRPC4",193,0)
 . Q
"RTN","MAGDRPC4",194,0)
 Q
"RTN","MAGDRPC4",195,0)
 ;
"RTN","MAGDRPC4",196,0)
FIND(DATE,CASE,NUM) ;
"RTN","MAGDRPC4",197,0)
 ; Use the ADC x-reference in the radiology patient file
"RTN","MAGDRPC4",198,0)
 N NDATE,X,X1,X2,Y
"RTN","MAGDRPC4",199,0)
 S X1=DATE,X2=NUM D C^%DTC S NDATE=X
"RTN","MAGDRPC4",200,0)
 I NDATE<1 Q 0
"RTN","MAGDRPC4",201,0)
 S NDATE=$$MMDDYY(NDATE)
"RTN","MAGDRPC4",202,0)
 Q $O(^RADPT("ADC",NDATE_"-"_CASE,""))
"RTN","MAGDRPC4",203,0)
 ;
"RTN","MAGDRPC4",204,0)
MMDDYY(DAY) ; Convert Fileman date to mmddyy
"RTN","MAGDRPC4",205,0)
 I DAY'?7N Q 0
"RTN","MAGDRPC4",206,0)
 Q $E(DAY,4,7)_$E(DAY,2,3)
"RTN","MAGDRPC4",207,0)
 ;
"RTN","MAGDRPC4",208,0)
INIT(OUT,LOCATION) ; RPC = MAG DICOM QUEUE INIT
"RTN","MAGDRPC4",209,0)
 N D0,N
"RTN","MAGDRPC4",210,0)
 I '$G(LOCATION) S OUT="-3,No origin specified." Q
"RTN","MAGDRPC4",211,0)
 I '$D(^MAGDOUTP(2006.574,0)) S OUT="-1,No entries at all in queue." Q
"RTN","MAGDRPC4",212,0)
 ;
"RTN","MAGDRPC4",213,0)
 S N=0,D0="" F  S D0=$O(^MAGDOUTP(2006.574,"C",LOCATION,D0)) Q:D0=""  D
"RTN","MAGDRPC4",214,0)
 . K ^MAGDOUTP(2006.574,D0)
"RTN","MAGDRPC4",215,0)
 . K ^MAGDOUTP(2006.574,"C",LOCATION,D0)
"RTN","MAGDRPC4",216,0)
 . S N=N+1
"RTN","MAGDRPC4",217,0)
 . Q
"RTN","MAGDRPC4",218,0)
 ;
"RTN","MAGDRPC4",219,0)
 I 'N S OUT="-2,No entries present for "_$$GET1^DIQ(4,LOCATION,.01)_"." Q
"RTN","MAGDRPC4",220,0)
 ;
"RTN","MAGDRPC4",221,0)
 S $P(^MAGDOUTP(2006.574,0),"^",4)=$P(^MAGDOUTP(2006.574,0),"^",4)-N
"RTN","MAGDRPC4",222,0)
 S OUT=N_" entr"_$S(N=1:"y",1:"ies")_" removed from Image Transmission Queue."
"RTN","MAGDRPC4",223,0)
 Q
"RTN","MAGDRPC4",224,0)
 ;
"RTN","MAGDRPC5")
0^22^B73787531
"RTN","MAGDRPC5",1,0)
MAGDRPC5 ;WOIFO/EdM - Routing RPCs ; 08/10/2004  07:35
"RTN","MAGDRPC5",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDRPC5",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC5",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC5",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC5",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC5",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC5",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC5",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC5",10,0)
 ;; |                                                               |
"RTN","MAGDRPC5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC5",17,0)
 ;;
"RTN","MAGDRPC5",18,0)
 Q
"RTN","MAGDRPC5",19,0)
 ;
"RTN","MAGDRPC5",20,0)
START(OUT,LOCATION,RULES) ; RPC = MAG DICOM ROUTE EVAL START
"RTN","MAGDRPC5",21,0)
 N I,LOC,X,ZTDESC,ZTDTH,ZTRTN,ZTSAVE
"RTN","MAGDRPC5",22,0)
 ;
"RTN","MAGDRPC5",23,0)
 S X=$G(^XTMP("MAGEVAL",0))
"RTN","MAGDRPC5",24,0)
 S $P(X,"^",2)=DT
"RTN","MAGDRPC5",25,0)
 S $P(X,"^",3)="Routing Rule Evaluator Log - Can be purged at any time"
"RTN","MAGDRPC5",26,0)
 S ^XTMP("MAGEVAL",0)=X
"RTN","MAGDRPC5",27,0)
 ;
"RTN","MAGDRPC5",28,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC5",29,0)
 I '$O(RULES("")) S OUT="-2,No Routing Rules Specified" Q
"RTN","MAGDRPC5",30,0)
 ;
"RTN","MAGDRPC5",31,0)
 S LOC=$$GET1^DIQ(4,LOCATION,.01)
"RTN","MAGDRPC5",32,0)
 L +^MAGDICOM(2006.563,1,"EVAL",LOCATION):0 E  D  Q
"RTN","MAGDRPC5",33,0)
 . S OUT="-3,A Rule Evaluator is Already Running for "_LOC
"RTN","MAGDRPC5",34,0)
 . Q
"RTN","MAGDRPC5",35,0)
 ;
"RTN","MAGDRPC5",36,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=1
"RTN","MAGDRPC5",37,0)
 S ZTRTN="EVAL^MAGBRTE4"
"RTN","MAGDRPC5",38,0)
 S ZTDESC="Evaluate Routing Rules for Origin="_LOC
"RTN","MAGDRPC5",39,0)
 S ZTDTH=$H
"RTN","MAGDRPC5",40,0)
 S ZTSAVE("LOCATION")=LOCATION
"RTN","MAGDRPC5",41,0)
 S I="" F  S I=$O(RULES(I)) Q:I=""  S:+I=I ZTSAVE("RULES("_I_")")=RULES(I)
"RTN","MAGDRPC5",42,0)
 D ^%ZTLOAD,HOME^%ZIS
"RTN","MAGDRPC5",43,0)
 L -^MAGDICOM(2006.563,1,"EVAL",LOCATION)
"RTN","MAGDRPC5",44,0)
 I '$D(ZTSK) S OUT="-4,TaskMan did not Accept Request" Q
"RTN","MAGDRPC5",45,0)
 S OUT="0,TaskMan task#="_ZTSK
"RTN","MAGDRPC5",46,0)
 Q
"RTN","MAGDRPC5",47,0)
 ;
"RTN","MAGDRPC5",48,0)
STOP(OUT) ; RPC = MAG DICOM ROUTE EVAL STOP
"RTN","MAGDRPC5",49,0)
 S ^MAGDICOM(2006.563,1,"EVAL")=0,OUT=1
"RTN","MAGDRPC5",50,0)
 Q
"RTN","MAGDRPC5",51,0)
 ;
"RTN","MAGDRPC5",52,0)
XMIT(OUT,LOCATION,DEST,PRIOR,MECH,DESTS) ; RPC = MAG DICOM ROUTE NEXT FILE
"RTN","MAGDRPC5",53,0)
 N D0,DIR,DL,IM,M,OK,PLACE,TP,X
"RTN","MAGDRPC5",54,0)
 ;
"RTN","MAGDRPC5",55,0)
 S PLACE=$$PLACE^MAGDRPC2(LOCATION)
"RTN","MAGDRPC5",56,0)
 S $P(^MAG(2006.1,PLACE,"LASTROUTE"),"^",1)=DT
"RTN","MAGDRPC5",57,0)
 ;
"RTN","MAGDRPC5",58,0)
 K OUT S OUT(1)=0,OK=0
"RTN","MAGDRPC5",59,0)
 S:'$G(MECH) MECH=1 I MECH'=1,MECH'=2 S MECH=1
"RTN","MAGDRPC5",60,0)
 I '$G(LOCATION) S OUT(1)="-1,No Location Specified" Q
"RTN","MAGDRPC5",61,0)
 S M="" F  S M=$O(DESTS(M)) Q:M=""  D
"RTN","MAGDRPC5",62,0)
 . S X=DESTS(M) Q:X'["^"  Q:$P(X,"^",1)'=MECH  Q:'$P(X,"^",2)
"RTN","MAGDRPC5",63,0)
 . S DL($P(X,"^",2))=""
"RTN","MAGDRPC5",64,0)
 . Q
"RTN","MAGDRPC5",65,0)
 I $O(DL(""))="" S OUT(1)="-2,No Valid Destinations Specified" Q
"RTN","MAGDRPC5",66,0)
 S:'$G(DEST) (PRIOR,DEST)=""
"RTN","MAGDRPC5",67,0)
 I $G(PRIOR) D
"RTN","MAGDRPC5",68,0)
 . I DEST S X=0 F  D  Q:X
"RTN","MAGDRPC5",69,0)
 . . I $P($G(^MAG(2005.2,DEST,0)),"^",6) S X=1 Q
"RTN","MAGDRPC5",70,0)
 . . D NOW^%DTC S %=%*1E6
"RTN","MAGDRPC5",71,0)
 . . S X=$P($G(^MAG(2005.2,DEST,3)),"^",6)*1E6
"RTN","MAGDRPC5",72,0)
 . . I %-X>1500 D ONOFLINE(.X,DEST,1) Q
"RTN","MAGDRPC5",73,0)
 . . S X=0,DEST=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST))
"RTN","MAGDRPC5",74,0)
 . . S:'DEST X=1
"RTN","MAGDRPC5",75,0)
 . . Q
"RTN","MAGDRPC5",76,0)
 . I 'DEST S (PRIOR,DEST)="" Q
"RTN","MAGDRPC5",77,0)
 . F  D  Q:OK
"RTN","MAGDRPC5",78,0)
 . . S D0=+$G(D0)
"RTN","MAGDRPC5",79,0)
 . . S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST,D0))
"RTN","MAGDRPC5",80,0)
 . . I 'D0 S OK=1 Q
"RTN","MAGDRPC5",81,0)
 . . S M=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",4) I M'=1,M'=2 S M=1
"RTN","MAGDRPC5",82,0)
 . . I M=MECH S OK=1 Q
"RTN","MAGDRPC5",83,0)
 . . S (PRIOR,DEST)=""
"RTN","MAGDRPC5",84,0)
 . . Q
"RTN","MAGDRPC5",85,0)
 . Q
"RTN","MAGDRPC5",86,0)
 I OK D:$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR))
"RTN","MAGDRPC5",87,0)
 . ;
"RTN","MAGDRPC5",88,0)
 . ; Ignore higher priority items for destinations that are not accessible
"RTN","MAGDRPC5",89,0)
 . ;
"RTN","MAGDRPC5",90,0)
 . N A,D,P,T,X
"RTN","MAGDRPC5",91,0)
 . S P=PRIOR F  S P=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",P)) Q:'P  D  Q:'PRIOR
"RTN","MAGDRPC5",92,0)
 . . S D="" F  S D=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",P,D)) Q:D=""  D  Q:'PRIOR
"RTN","MAGDRPC5",93,0)
 . . . ; Interrupt only if we're transmitting there
"RTN","MAGDRPC5",94,0)
 . . . Q:'$D(DL(D))
"RTN","MAGDRPC5",95,0)
 . . . ;
"RTN","MAGDRPC5",96,0)
 . . . D:'$P(^MAG(2005.2,D,0),"^",6)
"RTN","MAGDRPC5",97,0)
 . . . . D NOW^%DTC S %=%*1E6
"RTN","MAGDRPC5",98,0)
 . . . . S X=$P($G(^MAG(2005.2,D,3)),"^",6)*1E6 Q:%-X<1500
"RTN","MAGDRPC5",99,0)
 . . . . D ONOFLINE(.X,D,1)
"RTN","MAGDRPC5",100,0)
 . . . . Q
"RTN","MAGDRPC5",101,0)
 . . . S:$P(^MAG(2005.2,D,0),"^",6) PRIOR=0
"RTN","MAGDRPC5",102,0)
 . . . Q
"RTN","MAGDRPC5",103,0)
 . . Q
"RTN","MAGDRPC5",104,0)
 . Q
"RTN","MAGDRPC5",105,0)
 I '$G(PRIOR) F  D  Q:OK  Q:'PRIOR
"RTN","MAGDRPC5",106,0)
 . S PRIOR=" " F  S PRIOR=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR),-1) Q:'PRIOR  D  Q:OK
"RTN","MAGDRPC5",107,0)
 . . S DEST="" F  S DEST=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST)) Q:DEST=""  D:$D(DL(DEST))  Q:OK
"RTN","MAGDRPC5",108,0)
 . . . D:'$P(^MAG(2005.2,DEST,0),"^",6)
"RTN","MAGDRPC5",109,0)
 . . . . D NOW^%DTC S %=%*1E6
"RTN","MAGDRPC5",110,0)
 . . . . S X=$P($G(^MAG(2005.2,DEST,3)),"^",6)*1E6 Q:%-X<1500
"RTN","MAGDRPC5",111,0)
 . . . . D ONOFLINE(.X,DEST,1)
"RTN","MAGDRPC5",112,0)
 . . . . Q
"RTN","MAGDRPC5",113,0)
 . . . Q:'$P(^MAG(2005.2,DEST,0),"^",6)
"RTN","MAGDRPC5",114,0)
 . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRIOR,DEST,D0)) Q:D0=""  D  Q:OK
"RTN","MAGDRPC5",115,0)
 . . . . S M=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",4) I M'=1,M'=2 S M=1
"RTN","MAGDRPC5",116,0)
 . . . . I M=MECH S OK=1 Q
"RTN","MAGDRPC5",117,0)
 . . . . Q
"RTN","MAGDRPC5",118,0)
 . . . Q
"RTN","MAGDRPC5",119,0)
 . . Q
"RTN","MAGDRPC5",120,0)
 . Q
"RTN","MAGDRPC5",121,0)
 Q:'PRIOR
"RTN","MAGDRPC5",122,0)
 Q:'OK
"RTN","MAGDRPC5",123,0)
 I 'D0 S OUT(1)=0 Q  ; All files transmitted
"RTN","MAGDRPC5",124,0)
 ;
"RTN","MAGDRPC5",125,0)
 S X=^MAGQUEUE(2006.035,D0,0),IM=$P(X,"^",1),TP=$P(X,"^",3)
"RTN","MAGDRPC5",126,0)
 I 'IM D STATUS(X,D0,"SENT",LOCATION) S OUT(1)=2 Q
"RTN","MAGDRPC5",127,0)
 S OUT(2)=DEST,OUT(3)=PRIOR,OUT(4)=MECH,OUT(9)=D0
"RTN","MAGDRPC5",128,0)
 S X=$G(^MAG(2005.2,DEST,2)),OUT(5)=$P(X,"^",1),OUT(6)=$P(X,"^",2)
"RTN","MAGDRPC5",129,0)
 D STATUS(X,D0,"SENDING",LOCATION)
"RTN","MAGDRPC5",130,0)
 S OUT(10)=$P(^MAG(2005.2,DEST,0),"^",2)
"RTN","MAGDRPC5",131,0)
 S DIR=$P($G(^MAG(2005.2,DEST,4)),"^",2)
"RTN","MAGDRPC5",132,0)
 S OUT(11)=$G(^MAG(2005.2,DEST,3))
"RTN","MAGDRPC5",133,0)
 S OUT(12)=IM,OUT(13)=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",3)
"RTN","MAGDRPC5",134,0)
 D XMIT^MAGDRPC6 ; Routine grew over 10,000 characters
"RTN","MAGDRPC5",135,0)
 I MECH=2 S OUT(2)=OUT(2)_"^"_$P($G(^MAG(2006.587,+DEST,0)),"^",1)
"RTN","MAGDRPC5",136,0)
 Q
"RTN","MAGDRPC5",137,0)
 ;
"RTN","MAGDRPC5",138,0)
PURGE(OUT,LOCATION,DEST,MAX,DONE) ; RPC = MAG DICOM ROUTE GET PURGE
"RTN","MAGDRPC5",139,0)
 N D0,D1,FILE,FMFILE,I,LIMIT,MORE,NOW,RETAIN,STAMP,STATUS,X
"RTN","MAGDRPC5",140,0)
 ;
"RTN","MAGDRPC5",141,0)
 D NOW^%DTC S NOW=%
"RTN","MAGDRPC5",142,0)
 K OUT S OUT(1)=1
"RTN","MAGDRPC5",143,0)
 S $P(^MAG(2005.2,DEST,3),"^",4)=DT
"RTN","MAGDRPC5",144,0)
 S X=^MAG(2005.2,DEST,3)
"RTN","MAGDRPC5",145,0)
 S RETAIN=$P(X,"^",1) S:RETAIN="" RETAIN=32 S:RETAIN<0 RETAIN=0
"RTN","MAGDRPC5",146,0)
 S LIMIT=$H-RETAIN
"RTN","MAGDRPC5",147,0)
 ;
"RTN","MAGDRPC5",148,0)
 S X=$G(DONE(1)),MORE="" S:$E(X,1)="^" MORE=$P(X,"^",4,6)
"RTN","MAGDRPC5",149,0)
 ;
"RTN","MAGDRPC5",150,0)
 S I="" F  S I=$O(DONE(I)) Q:I=""  D
"RTN","MAGDRPC5",151,0)
 . N D41,D61
"RTN","MAGDRPC5",152,0)
 . S X=$G(DONE(I))
"RTN","MAGDRPC5",153,0)
 . S D0=$P(X,"^",2),D41=$P(X,"^",3)
"RTN","MAGDRPC5",154,0)
 . S STAMP=$P(X,"^",4)
"RTN","MAGDRPC5",155,0)
 . Q:'D0  Q:'D41
"RTN","MAGDRPC5",156,0)
 . ; Just in case the image is being deleted as this purge is taking place
"RTN","MAGDRPC5",157,0)
 . F FMFILE=2005,2005.1 D
"RTN","MAGDRPC5",158,0)
 . . K ^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D41)
"RTN","MAGDRPC5",159,0)
 . . S D61=$P($G(^MAG(FMFILE,D0,4,D41,0)),"^",7)
"RTN","MAGDRPC5",160,0)
 . . K ^MAG(FMFILE,D0,4,"LOC",DEST,D41)
"RTN","MAGDRPC5",161,0)
 . . K ^MAG(FMFILE,D0,4,D41,0)
"RTN","MAGDRPC5",162,0)
 . . S:D61 $P(^MAG(FMFILE,D0,6,D61,0),"^",5)=NOW
"RTN","MAGDRPC5",163,0)
 . . Q
"RTN","MAGDRPC5",164,0)
 . S MORE=""
"RTN","MAGDRPC5",165,0)
 . Q
"RTN","MAGDRPC5",166,0)
 ;
"RTN","MAGDRPC5",167,0)
 D
"RTN","MAGDRPC5",168,0)
 . N %,%H,%I
"RTN","MAGDRPC5",169,0)
 . S %H=LIMIT D TT^%DTC S LIMIT=X
"RTN","MAGDRPC5",170,0)
 . Q
"RTN","MAGDRPC5",171,0)
 ;
"RTN","MAGDRPC5",172,0)
 S MAX=$G(MAX) S:MAX<1 MAX=100
"RTN","MAGDRPC5",173,0)
 F FMFILE=2005,2005.1 D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",174,0)
 . S STAMP="" F  S STAMP=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP)) Q:STAMP=""  Q:STAMP'<LIMIT  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",175,0)
 . . S D0="" F  S D0=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP,D0)) Q:D0=""  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",176,0)
 . . . S D1="" F  S D1=$O(^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D1)) Q:D1=""  D  Q:OUT(1)'<MAX
"RTN","MAGDRPC5",177,0)
 . . . . I MORE'="",FMFILE_"^"_D0_"^"_D1'=MORE Q
"RTN","MAGDRPC5",178,0)
 . . . . S MORE=""
"RTN","MAGDRPC5",179,0)
 . . . . S FILE=$P($G(^MAG(FMFILE,D0,4,D1,0)),"^",4),STATUS=0
"RTN","MAGDRPC5",180,0)
 . . . . S:FILE="" FILE=$P($G(^MAG(2005.1,D0,4,D1,0)),"^",4)
"RTN","MAGDRPC5",181,0)
 . . . . I FILE="" D  Q
"RTN","MAGDRPC5",182,0)
 . . . . . K ^MAG(FMFILE,"ROUTE",DEST,STAMP,D0,D1)
"RTN","MAGDRPC5",183,0)
 . . . . . K ^MAG(FMFILE,D0,4,"LOC",DEST,D1)
"RTN","MAGDRPC5",184,0)
 . . . . . K ^MAG(FMFILE,D0,4,D1,0)
"RTN","MAGDRPC5",185,0)
 . . . . . Q
"RTN","MAGDRPC5",186,0)
 . . . . S OUT(1)=OUT(1)+1,OUT(OUT(1))=FMFILE_"^"_D0_"^"_D1_"^"_STAMP_"^"_FILE
"RTN","MAGDRPC5",187,0)
 . . . . Q
"RTN","MAGDRPC5",188,0)
 . . . Q
"RTN","MAGDRPC5",189,0)
 . . Q
"RTN","MAGDRPC5",190,0)
 . Q
"RTN","MAGDRPC5",191,0)
 Q
"RTN","MAGDRPC5",192,0)
 ;
"RTN","MAGDRPC5",193,0)
STATUS(OUT,D0,STATUS,LOCATION) ; RPC = MAG DICOM ROUTE STATUS
"RTN","MAGDRPC5",194,0)
 ; D0 ------- Internal Entry Number of Send Queue Entry
"RTN","MAGDRPC5",195,0)
 ; STATUS --- New Status
"RTN","MAGDRPC5",196,0)
 N DEST ;---- Internal Entry Number of destination
"RTN","MAGDRPC5",197,0)
 N IMAGE ;--- Internal Entry Number of image
"RTN","MAGDRPC5",198,0)
 N OLD ;----- Old Status Value
"RTN","MAGDRPC5",199,0)
 N ORIGIN ;-- Origin of image
"RTN","MAGDRPC5",200,0)
 N PRIOR ;--- Priority
"RTN","MAGDRPC5",201,0)
 N TYPE ;---- File Type (Big, Text, DICOM, etc)
"RTN","MAGDRPC5",202,0)
 N X0,X1 ;--- Queue data
"RTN","MAGDRPC5",203,0)
 ;
"RTN","MAGDRPC5",204,0)
 S X0=$G(^MAGQUEUE(2006.035,D0,0))
"RTN","MAGDRPC5",205,0)
 S X1=$G(^MAGQUEUE(2006.035,D0,1))
"RTN","MAGDRPC5",206,0)
 S OUT=0
"RTN","MAGDRPC5",207,0)
 ;
"RTN","MAGDRPC5",208,0)
 S DEST=$P(X0,"^",2) Q:DEST=""
"RTN","MAGDRPC5",209,0)
 S PRIOR=$P(X1,"^",2) Q:PRIOR=""
"RTN","MAGDRPC5",210,0)
 S ORIGIN=$P(X0,"^",5)
"RTN","MAGDRPC5",211,0)
 S:'ORIGIN ORIGIN=$G(LOCATION) Q:'ORIGIN
"RTN","MAGDRPC5",212,0)
 S OLD=$P(X1,"^",1),IMAGE=$P(X0,"^",1),TYPE=$P(X0,"^",3)
"RTN","MAGDRPC5",213,0)
 ;
"RTN","MAGDRPC5",214,0)
 K:OLD'="" ^MAGQUEUE(2006.035,"DEST",DEST,OLD,IMAGE,TYPE,D0)
"RTN","MAGDRPC5",215,0)
 K:OLD'="" ^MAGQUEUE(2006.035,"STS",ORIGIN,OLD,PRIOR,DEST,D0)
"RTN","MAGDRPC5",216,0)
 Q:STATUS=""
"RTN","MAGDRPC5",217,0)
 S $P(^MAGQUEUE(2006.035,D0,0),"^",5)=ORIGIN
"RTN","MAGDRPC5",218,0)
 S $P(^MAGQUEUE(2006.035,D0,1),"^",1)=STATUS
"RTN","MAGDRPC5",219,0)
 S ^MAGQUEUE(2006.035,"DEST",DEST,STATUS,IMAGE,TYPE,D0)=""
"RTN","MAGDRPC5",220,0)
 S ^MAGQUEUE(2006.035,"STS",ORIGIN,STATUS,PRIOR,DEST,D0)=""
"RTN","MAGDRPC5",221,0)
 S OUT=1
"RTN","MAGDRPC5",222,0)
 Q
"RTN","MAGDRPC5",223,0)
 ;
"RTN","MAGDRPC5",224,0)
LISTDEST(OUT,LOCATION) ; RPC = MAG DICOM ROUTE LIST DESTI
"RTN","MAGDRPC5",225,0)
 N D0,F,I,X
"RTN","MAGDRPC5",226,0)
 ; Return list of possible routing destinations
"RTN","MAGDRPC5",227,0)
 K OUT
"RTN","MAGDRPC5",228,0)
 S I=1,D0=0 F  S D0=$O(^MAG(2005.2,D0)) Q:'D0  D
"RTN","MAGDRPC5",229,0)
 . S X=$G(^MAG(2005.2,D0,0)) Q:'$P(X,"^",9)
"RTN","MAGDRPC5",230,0)
 . L +^MAGQUEUE("ROUTE",LOCATION,D0):0 S F='$T
"RTN","MAGDRPC5",231,0)
 . L:'F -^MAGQUEUE("ROUTE",LOCATION,D0)
"RTN","MAGDRPC5",232,0)
 . S I=I+1,OUT(I)=D0_"^"_F_"^"_$P(X,"^",1,2)
"RTN","MAGDRPC5",233,0)
 . Q
"RTN","MAGDRPC5",234,0)
 S OUT(1)=I-1
"RTN","MAGDRPC5",235,0)
 Q
"RTN","MAGDRPC5",236,0)
 ;
"RTN","MAGDRPC5",237,0)
LOCK(OUT,D0,LOCATION,PLUSMIN) ; RPC = MAG DICOM ROUTE LOCK TRANSMIT
"RTN","MAGDRPC5",238,0)
 S OUT=0
"RTN","MAGDRPC5",239,0)
 I $G(PLUSMIN) L +^MAGQUEUE("ROUTE",LOCATION,D0):0 S OUT=$T Q
"RTN","MAGDRPC5",240,0)
 L -^MAGQUEUE("ROUTE",LOCATION,D0) S OUT=2
"RTN","MAGDRPC5",241,0)
 Q
"RTN","MAGDRPC5",242,0)
 ;
"RTN","MAGDRPC5",243,0)
ONOFLINE(OUT,DEST,STATUS) ; RPC = MAG DICOM NETWORK STATUS
"RTN","MAGDRPC5",244,0)
 N NET
"RTN","MAGDRPC5",245,0)
 I '$G(DEST) S OUT="-1,No Network Location Specified" Q
"RTN","MAGDRPC5",246,0)
 S STATUS=''$G(STATUS)
"RTN","MAGDRPC5",247,0)
 S NET=$P($G(^MAG(2005.2,DEST,0)),"^",2)
"RTN","MAGDRPC5",248,0)
 K ^MAG(2005.2,"C",NET,0,DEST)
"RTN","MAGDRPC5",249,0)
 K ^MAG(2005.2,"C",NET,1,DEST)
"RTN","MAGDRPC5",250,0)
 S ^MAG(2005.2,"C",NET,STATUS,DEST)=""
"RTN","MAGDRPC5",251,0)
 S $P(^MAG(2005.2,DEST,0),"^",6)=STATUS
"RTN","MAGDRPC5",252,0)
 D NOW^%DTC
"RTN","MAGDRPC5",253,0)
 S $P(^MAG(2005.2,DEST,3),"^",6)=$S(STATUS:"",1:%)
"RTN","MAGDRPC5",254,0)
 S OUT=1
"RTN","MAGDRPC5",255,0)
 Q
"RTN","MAGDRPC5",256,0)
 ;
"RTN","MAGDRPC6")
0^23^B36584708
"RTN","MAGDRPC6",1,0)
MAGDRPC6 ;WOIFO/EdM - Routing RPCs ; 08/13/2004  08:08
"RTN","MAGDRPC6",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDRPC6",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC6",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC6",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC6",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC6",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC6",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC6",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC6",10,0)
 ;; |                                                               |
"RTN","MAGDRPC6",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC6",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC6",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC6",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC6",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC6",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC6",17,0)
 ;;
"RTN","MAGDRPC6",18,0)
 Q
"RTN","MAGDRPC6",19,0)
 ;
"RTN","MAGDRPC6",20,0)
PURGDONE(OUT,DAYS,LOCATION) ; RPC = MAG DICOM ROUTE PURGE DONE
"RTN","MAGDRPC6",21,0)
 ; Purge Entries from Queue that have been sent successfully
"RTN","MAGDRPC6",22,0)
 N D0,DE,ID,IM,LIM,PR,RT,STS,TP,TX,X
"RTN","MAGDRPC6",23,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC6",24,0)
 ;
"RTN","MAGDRPC6",25,0)
 S OUT=0
"RTN","MAGDRPC6",26,0)
 F STS="SENT","NOT FOUND" D
"RTN","MAGDRPC6",27,0)
 . S PR="" F  S PR=$O(^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR)) Q:PR=""  D
"RTN","MAGDRPC6",28,0)
 . . S DE="" F  S DE=$O(^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR,DE)) Q:DE=""  D
"RTN","MAGDRPC6",29,0)
 . . . S RT=$P($G(^MAG(2005.2,DE,3)),"^",1) S:'RT RT=31
"RTN","MAGDRPC6",30,0)
 . . . S:$G(DAYS)'<1 RT=DAYS
"RTN","MAGDRPC6",31,0)
 . . . S LIM=$H-RT
"RTN","MAGDRPC6",32,0)
 . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR,DE,D0)) Q:D0=""  D
"RTN","MAGDRPC6",33,0)
 . . . . N %H,%T,%Y
"RTN","MAGDRPC6",34,0)
 . . . . S X=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",4)\1 D H^%DTC
"RTN","MAGDRPC6",35,0)
 . . . . Q:%H'<LIM
"RTN","MAGDRPC6",36,0)
 . . . . S X=$G(^MAGQUEUE(2006.035,D0,0)),IM=$P(X,"^",1),TP=$P(X,"^",3),ID=$P(X,"^",6)
"RTN","MAGDRPC6",37,0)
 . . . . K ^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR,DE,D0)
"RTN","MAGDRPC6",38,0)
 . . . . K:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)
"RTN","MAGDRPC6",39,0)
 . . . . I IM'="",TP'="" K ^MAGQUEUE(2006.035,"DEST",DE,STS,IM,TP,D0)
"RTN","MAGDRPC6",40,0)
 . . . . K ^MAGQUEUE(2006.035,D0)
"RTN","MAGDRPC6",41,0)
 . . . . S OUT=OUT+1
"RTN","MAGDRPC6",42,0)
 . . . . Q
"RTN","MAGDRPC6",43,0)
 . . . Q
"RTN","MAGDRPC6",44,0)
 . . Q
"RTN","MAGDRPC6",45,0)
 . S DE="" F  S DE=$O(^MAGQUEUE(2006.035,"DEST",DE)) Q:DE=""  D
"RTN","MAGDRPC6",46,0)
 . . S IM="" F  S IM=$O(^MAGQUEUE(2006.035,"DEST",DE,STS,IM)) Q:IM=""  D
"RTN","MAGDRPC6",47,0)
 . . . S TP="" F  S TP=$O(^MAGQUEUE(2006.035,"DEST",DE,STS,IM,TP)) Q:TP=""  D
"RTN","MAGDRPC6",48,0)
 . . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"DEST",DE,STS,IM,TP,D0)) Q:D0=""  D
"RTN","MAGDRPC6",49,0)
 . . . . . S PR=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",2)
"RTN","MAGDRPC6",50,0)
 . . . . . S ID=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",6)
"RTN","MAGDRPC6",51,0)
 . . . . . K ^MAGQUEUE(2006.035,D0)
"RTN","MAGDRPC6",52,0)
 . . . . . K:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)
"RTN","MAGDRPC6",53,0)
 . . . . . K ^MAGQUEUE(2006.035,"DEST",DE,STS,IM,TP,D0)
"RTN","MAGDRPC6",54,0)
 . . . . . K:PR'="" ^MAGQUEUE(2006.035,"STS",LOCATION,STS,PR,DE,D0)
"RTN","MAGDRPC6",55,0)
 . . . . . S OUT=OUT+1
"RTN","MAGDRPC6",56,0)
 . . . . . Q
"RTN","MAGDRPC6",57,0)
 . . . . Q
"RTN","MAGDRPC6",58,0)
 . . . Q
"RTN","MAGDRPC6",59,0)
 . . Q
"RTN","MAGDRPC6",60,0)
 . Q
"RTN","MAGDRPC6",61,0)
 S D0=0 F  S D0=$O(^MAGQUEUE(2006.035,D0)) Q:'D0  D
"RTN","MAGDRPC6",62,0)
 . S X=$P($G(^MAGQUEUE(2006.035,D0,1)),"^",1) I X'="SENT",X'="NOT FOUND" Q
"RTN","MAGDRPC6",63,0)
 . S ID=$P($G(^MAGQUEUE(2006.035,D0,0)),"^",6)
"RTN","MAGDRPC6",64,0)
 . K ^MAGQUEUE(2006.035,D0)
"RTN","MAGDRPC6",65,0)
 . K:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)
"RTN","MAGDRPC6",66,0)
 . S OUT=OUT+1
"RTN","MAGDRPC6",67,0)
 . Q
"RTN","MAGDRPC6",68,0)
 Q
"RTN","MAGDRPC6",69,0)
 ;
"RTN","MAGDRPC6",70,0)
REQUEUE(OUT,LOCATION) ; RPC = MAG DICOM ROUTE REQUEUE
"RTN","MAGDRPC6",71,0)
 ; ReQueue Files that Failed during transmission
"RTN","MAGDRPC6",72,0)
 N D0,DE,FL,IM,PR,TP,WW,X
"RTN","MAGDRPC6",73,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC6",74,0)
 ;
"RTN","MAGDRPC6",75,0)
 S WW="WAITING",OUT=0
"RTN","MAGDRPC6",76,0)
 F FL="FAILED","SENDING" D
"RTN","MAGDRPC6",77,0)
 . S PR="" F  S PR=$O(^MAGQUEUE(2006.035,"STS",LOCATION,FL,PR)) Q:PR=""  D
"RTN","MAGDRPC6",78,0)
 . . S DE="" F  S DE=$O(^MAGQUEUE(2006.035,"STS",LOCATION,FL,PR,DE)) Q:DE=""  D
"RTN","MAGDRPC6",79,0)
 . . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,FL,PR,DE,D0)) Q:D0=""  D
"RTN","MAGDRPC6",80,0)
 . . . . K ^MAGQUEUE(2006.035,"STS",LOCATION,FL,PR,DE,D0)
"RTN","MAGDRPC6",81,0)
 . . . . I '$D(^MAGQUEUE(2006.035,D0,0)) K ^MAGQUEUE(2006.035,D0) Q
"RTN","MAGDRPC6",82,0)
 . . . . S $P(^MAGQUEUE(2006.035,D0,1),"^",1)=WW
"RTN","MAGDRPC6",83,0)
 . . . . S ^MAGQUEUE(2006.035,"STS",LOCATION,WW,PR,DE,D0)=""
"RTN","MAGDRPC6",84,0)
 . . . . S X=^MAGQUEUE(2006.035,D0,0),IM=$P(X,"^",1),TP=$P(X,"^",3)
"RTN","MAGDRPC6",85,0)
 . . . . I IM'="",TP'="" K ^MAGQUEUE(2006.035,"DEST",DE,FL,IM,TP,D0)
"RTN","MAGDRPC6",86,0)
 . . . . I IM'="",TP'="" S ^MAGQUEUE(2006.035,"DEST",DE,WW,IM,TP,D0)=""
"RTN","MAGDRPC6",87,0)
 . . . . S OUT=OUT+1
"RTN","MAGDRPC6",88,0)
 . . . . Q
"RTN","MAGDRPC6",89,0)
 . . . Q
"RTN","MAGDRPC6",90,0)
 . . Q
"RTN","MAGDRPC6",91,0)
 . Q
"RTN","MAGDRPC6",92,0)
 Q
"RTN","MAGDRPC6",93,0)
 ;
"RTN","MAGDRPC6",94,0)
REMOBSO(OUT,UPTO,LOCATION) ; RPC = MAG DICOM ROUTE REMOVE OBSO
"RTN","MAGDRPC6",95,0)
 ; Purge Unprocessed entries requested before a certain date
"RTN","MAGDRPC6",96,0)
 N D0,DE,ID,IM,N,PRI,RDT,ST,TY
"RTN","MAGDRPC6",97,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC6",98,0)
 ;
"RTN","MAGDRPC6",99,0)
 S OUT=0
"RTN","MAGDRPC6",100,0)
 S PRI="" F  S PRI=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI)) Q:PRI=""  D
"RTN","MAGDRPC6",101,0)
 . S DE="" F  S DE=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DE)) Q:DE=""  D
"RTN","MAGDRPC6",102,0)
 . . S D0="" F  S D0=$O(^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DE,D0)) Q:D0=""  D  Q:'D0
"RTN","MAGDRPC6",103,0)
 . . . S X=$G(^MAGQUEUE(2006.035,D0,0)),IM=$P(X,"^",1),TY=$P(X,"^",3),ID=$P(X,"^",6)
"RTN","MAGDRPC6",104,0)
 . . . S X=$G(^MAGQUEUE(2006.035,D0,1)),ST=$P(X,"^",1),RDT=$P(X,"^",3)
"RTN","MAGDRPC6",105,0)
 . . . I RDT'<UPTO S D0=0 Q
"RTN","MAGDRPC6",106,0)
 . . . I ST'="",IM'="",TY'="" K ^MAGQUEUE(2006.035,"DEST",DE,ST,IM,TY,D0)
"RTN","MAGDRPC6",107,0)
 . . . K ^MAGQUEUE(2006.035,"STS",LOCATION,"WAITING",PRI,DE,D0)
"RTN","MAGDRPC6",108,0)
 . . . K:ID'="" ^MAGQUEUE(2006.035,"ID",ID,D0)
"RTN","MAGDRPC6",109,0)
 . . . K ^MAGQUEUE(2006.035,D0)
"RTN","MAGDRPC6",110,0)
 . . . S OUT=OUT+1
"RTN","MAGDRPC6",111,0)
 . . . Q
"RTN","MAGDRPC6",112,0)
 . . Q
"RTN","MAGDRPC6",113,0)
 . Q
"RTN","MAGDRPC6",114,0)
 Q
"RTN","MAGDRPC6",115,0)
 ;
"RTN","MAGDRPC6",116,0)
EVALLOG(OUT,TASK,MSG,MAX,LOCATION) ; RPC = MAG DICOM ROUTE EVAL LOG
"RTN","MAGDRPC6",117,0)
 N L,N,PLACE,ZTSK
"RTN","MAGDRPC6",118,0)
 ;
"RTN","MAGDRPC6",119,0)
 S PLACE=$$PLACE^MAGDRPC2(LOCATION)
"RTN","MAGDRPC6",120,0)
 S $P(^MAG(2006.1,PLACE,"LASTROUTE"),"^",1)=DT
"RTN","MAGDRPC6",121,0)
 ;
"RTN","MAGDRPC6",122,0)
 I '$D(^XTMP("MAGEVAL",+$G(TASK))) S OUT(1)="-1,No task #"_(+$G(TASK)) Q
"RTN","MAGDRPC6",123,0)
 I $G(MAX)<1 S OUT(1)="-2,MAXIMUM parameter = "_$G(MAX)_" < 1" Q
"RTN","MAGDRPC6",124,0)
 S (L,MSG)=+$G(MSG),N=1
"RTN","MAGDRPC6",125,0)
 F  S MSG=$O(^XTMP("MAGEVAL",TASK,MSG)) Q:MSG=""  D  Q:N'<MAX
"RTN","MAGDRPC6",126,0)
 . S L=MSG,N=N+1,OUT(N)=^XTMP("MAGEVAL",TASK,MSG)
"RTN","MAGDRPC6",127,0)
 . Q
"RTN","MAGDRPC6",128,0)
 S OUT(1)=(N-1)_" "_L
"RTN","MAGDRPC6",129,0)
 Q:N>1
"RTN","MAGDRPC6",130,0)
 S ZTSK=TASK D STAT^%ZTLOAD
"RTN","MAGDRPC6",131,0)
 I $G(ZTSK(2))["Inactive" S OUT(1)="-3,"_ZTSK(2) Q
"RTN","MAGDRPC6",132,0)
 Q
"RTN","MAGDRPC6",133,0)
 ;
"RTN","MAGDRPC6",134,0)
XMIT ; Continuation from MAGDRPC5
"RTN","MAGDRPC6",135,0)
 N FROM,HASH,TO,TTP
"RTN","MAGDRPC6",136,0)
 S (FROM,TO,OUT(7),OUT(8))=-13
"RTN","MAGDRPC6",137,0)
 S TTP=TP S:TP="TEXT" TTP="FULL" ; MAGFILEB does not support type="TEXT"
"RTN","MAGDRPC6",138,0)
 D FILEFIND^MAGDFB(IM,TTP,0,0,.TO,.FROM)
"RTN","MAGDRPC6",139,0)
 S:FROM["~NO NETWORK LOCATION DEFINED" (FROM,TO)="-1~No routable files found for image "_IM
"RTN","MAGDRPC6",140,0)
 I TP="TEXT" S TO=$E(TO,1,$L(TO)-4)_".TXT",FROM=$E(FROM,1,$L(FROM)-4)_".TXT"
"RTN","MAGDRPC6",141,0)
 I (FROM<0)!(TO<0)!(FROM="") D STATUS^MAGDRPC5(X,D0,"SENT",LOCATION) S OUT(1)=2 Q
"RTN","MAGDRPC6",142,0)
 S HASH=$$DIRHASH^MAGFILEB(TO,DEST) D:HASH'=""
"RTN","MAGDRPC6",143,0)
 . I $E(TO,1)="\",$E(HASH,$L(HASH))="\" S HASH=$E(HASH,1,$L(HASH)-1)
"RTN","MAGDRPC6",144,0)
 . I $E(TO,1)'="\",$E(HASH,$L(HASH))'="\" S HASH=HASH_"\"
"RTN","MAGDRPC6",145,0)
 . S TO=HASH_TO
"RTN","MAGDRPC6",146,0)
 . Q
"RTN","MAGDRPC6",147,0)
 D:DIR'=""
"RTN","MAGDRPC6",148,0)
 . I $E(TO,1)="\",$E(DIR,$L(DIR))="\" S DIR=$E(DIR,1,$L(DIR)-1)
"RTN","MAGDRPC6",149,0)
 . I $E(TO,1)'="\",$E(DIR,$L(DIR))'="\" S DIR=DIR_"\"
"RTN","MAGDRPC6",150,0)
 . S TO=DIR_TO
"RTN","MAGDRPC6",151,0)
 . Q
"RTN","MAGDRPC6",152,0)
 S:$E(TO,1)'="\" TO="\"_TO
"RTN","MAGDRPC6",153,0)
 S OUT(7)=FROM,OUT(8)=TO
"RTN","MAGDRPC6",154,0)
 S OUT(1)=1
"RTN","MAGDRPC6",155,0)
 Q
"RTN","MAGDRPC8")
0^24^B49397368
"RTN","MAGDRPC8",1,0)
MAGDRPC8 ;WOIFO/EdM - RPCs for Master Files ; 05/18/2004  11:04
"RTN","MAGDRPC8",2,0)
 ;;3.0;IMAGING;**11,30**;16-September-2004
"RTN","MAGDRPC8",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC8",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC8",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC8",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC8",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC8",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC8",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC8",10,0)
 ;; |                                                               |
"RTN","MAGDRPC8",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC8",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC8",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC8",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC8",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC8",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC8",17,0)
 ;;
"RTN","MAGDRPC8",18,0)
 Q
"RTN","MAGDRPC8",19,0)
 ;
"RTN","MAGDRPC8",20,0)
UPDTAPP(OUT,APP) ; RPC = MAG DICOM UPDATE SCU LIST
"RTN","MAGDRPC8",21,0)
 N A,D0,GWLOC,GWNAM,HDR,I,MIN,N,NOW,P5,P7,PLUS,SERVNAM,UP,X
"RTN","MAGDRPC8",22,0)
 S (GWNAM,GWLOC)="",N=0
"RTN","MAGDRPC8",23,0)
 S A="" F  S A=$O(APP(A)) Q:A=""  D
"RTN","MAGDRPC8",24,0)
 . S X=APP(A) F I=1:1:7 S:$P(X,"^",I)="" N=N+1
"RTN","MAGDRPC8",25,0)
 . S:GWNAM="" GWNAM=$P(X,"^",5)
"RTN","MAGDRPC8",26,0)
 . S:GWLOC="" GWLOC=$P(X,"^",7)
"RTN","MAGDRPC8",27,0)
 . S:GWNAM'=$P(X,"^",5) N=N+1
"RTN","MAGDRPC8",28,0)
 . S:GWLOC'=$P(X,"^",7) N=N+1
"RTN","MAGDRPC8",29,0)
 . S:'N A($P(X,"^",1))=A ; ^MAGDMFBS guarantees unique names
"RTN","MAGDRPC8",30,0)
 . Q
"RTN","MAGDRPC8",31,0)
 I N S OUT="-1,Missing or Inconsistent Parameters." Q
"RTN","MAGDRPC8",32,0)
 ;
"RTN","MAGDRPC8",33,0)
 L +^MAG(2006.587,0):1E9 ; Background task MUST wait
"RTN","MAGDRPC8",34,0)
 S HDR=$G(^MAG(2006.587,0))
"RTN","MAGDRPC8",35,0)
 S $P(HDR,"^",1,2)="DICOM TRANSMIT DESTINATION^2006.587"
"RTN","MAGDRPC8",36,0)
 ;
"RTN","MAGDRPC8",37,0)
 D NOW^%DTC S NOW=%,(MIN,PLUS,UP)=0
"RTN","MAGDRPC8",38,0)
 ;
"RTN","MAGDRPC8",39,0)
 S D0="" F  S D0=$O(^MAG(2006.587,"D",GWNAM,GWLOC,D0)) Q:D0=""  D
"RTN","MAGDRPC8",40,0)
 . S X=$G(^MAG(2006.587,D0,0)),SERVNAM=$P(X,"^",1) Q:SERVNAM=""
"RTN","MAGDRPC8",41,0)
 . S P5=$P(X,"^",5),P7=$P(X,"^",7)
"RTN","MAGDRPC8",42,0)
 . I P5'="",P7'="" K ^MAG(2006.587,"C",SERVNAM,P7,P5,D0),^MAG(2006.587,"D",P5,P7,D0)
"RTN","MAGDRPC8",43,0)
 . I '$D(A(SERVNAM)) D  Q
"RTN","MAGDRPC8",44,0)
 . . K ^MAG(2006.587,D0),^MAG(2006.587,"B",SERVNAM,D0) S MIN=MIN+1
"RTN","MAGDRPC8",45,0)
 . . Q
"RTN","MAGDRPC8",46,0)
 . S X=APP(A(SERVNAM)),$P(X,"^",8)=NOW K APP(A(SERVNAM))
"RTN","MAGDRPC8",47,0)
 . S ^MAG(2006.587,D0,0)=$P(X,"^",1,8),UP=UP+1
"RTN","MAGDRPC8",48,0)
 . S ^MAG(2006.587,"C",SERVNAM,GWLOC,GWNAM,D0)=""
"RTN","MAGDRPC8",49,0)
 . S ^MAG(2006.587,"D",GWNAM,GWLOC,D0)=""
"RTN","MAGDRPC8",50,0)
 . Q
"RTN","MAGDRPC8",51,0)
 S $P(HDR,"^",4)=$P(HDR,"^",4)-MIN
"RTN","MAGDRPC8",52,0)
 ;
"RTN","MAGDRPC8",53,0)
 S A="" F  S A=$O(APP(A)) Q:A=""  D
"RTN","MAGDRPC8",54,0)
 . S X=APP(A),$P(X,"^",8)=NOW
"RTN","MAGDRPC8",55,0)
 . S D0=$O(^MAG(2006.587," "),-1)+1,PLUS=PLUS+1,$P(HDR,"^",3)=D0
"RTN","MAGDRPC8",56,0)
 . S ^MAG(2006.587,D0,0)=$P(X,"^",1,8),SERVNAM=$P(X,"^",1)
"RTN","MAGDRPC8",57,0)
 . S ^MAG(2006.587,"B",SERVNAM,D0)=""
"RTN","MAGDRPC8",58,0)
 . S ^MAG(2006.587,"C",SERVNAM,GWLOC,GWNAM,D0)=""
"RTN","MAGDRPC8",59,0)
 . S ^MAG(2006.587,"D",GWNAM,GWLOC,D0)=""
"RTN","MAGDRPC8",60,0)
 . Q
"RTN","MAGDRPC8",61,0)
 S $P(HDR,"^",4)=$P(HDR,"^",4)+PLUS
"RTN","MAGDRPC8",62,0)
 S ^MAG(2006.587,0)=HDR
"RTN","MAGDRPC8",63,0)
 L -^MAG(2006.587,0)
"RTN","MAGDRPC8",64,0)
 S OUT="1"
"RTN","MAGDRPC8",65,0)
 S:PLUS OUT=OUT_", "_PLUS_" added"
"RTN","MAGDRPC8",66,0)
 S:MIN OUT=OUT_", "_MIN_" removed"
"RTN","MAGDRPC8",67,0)
 S:UP OUT=OUT_", "_UP_" updated"
"RTN","MAGDRPC8",68,0)
 Q
"RTN","MAGDRPC8",69,0)
 ;
"RTN","MAGDRPC8",70,0)
UPDTGW(OUT,ONAM,NNAM,OLOC,NLOC) ; RPC = MAG DICOM UPDATE GATEWAY NAME
"RTN","MAGDRPC8",71,0)
 N D0,P1,P5,P7,N
"RTN","MAGDRPC8",72,0)
 I $G(NNAM)="" S OUT="-1,No Gateway Name specified" Q
"RTN","MAGDRPC8",73,0)
 I '$G(NLOC) S OUT="-2,No Gateway Location specified" Q
"RTN","MAGDRPC8",74,0)
 S OLOC=$G(OLOC),ONAM=$G(ONAM)
"RTN","MAGDRPC8",75,0)
 S (N,D0)=0 F  S D0=$O(^MAG(2006.587,D0)) Q:'D0  D
"RTN","MAGDRPC8",76,0)
 . S X=$G(^MAG(2006.587,D0,0)),P5=$P(X,"^",5) Q:P5'=ONAM
"RTN","MAGDRPC8",77,0)
 . S P1=$P(X,"^",1),P7=$P(X,"^",7)
"RTN","MAGDRPC8",78,0)
 . I OLOC'="",P5'="" K ^MAG(2006.587,"C",P1,OLOC,P5,D0),^MAG(2006.587,"D",P5,OLOC,D0)
"RTN","MAGDRPC8",79,0)
 . S $P(X,"^",5)=NNAM,$P(X,"^",7)=NLOC
"RTN","MAGDRPC8",80,0)
 . S ^MAG(2006.587,D0,0)=X
"RTN","MAGDRPC8",81,0)
 . S ^MAG(2006.587,"C",P1,NNAM,NLOC,D0)=""
"RTN","MAGDRPC8",82,0)
 . S ^MAG(2006.587,"D",NLOC,NNAM,D0)=""
"RTN","MAGDRPC8",83,0)
 . S N=N+1
"RTN","MAGDRPC8",84,0)
 . Q
"RTN","MAGDRPC8",85,0)
 S OUT=N
"RTN","MAGDRPC8",86,0)
 Q
"RTN","MAGDRPC8",87,0)
 ;
"RTN","MAGDRPC8",88,0)
SIBS(P0,T) N MAGLOC,P1,P2
"RTN","MAGDRPC8",89,0)
 S T(P0)=""
"RTN","MAGDRPC8",90,0)
 D SIBLING^XUAF4("MAGLOC",P0,"PARENT FACILITY") ; General API, IA #2171
"RTN","MAGDRPC8",91,0)
 S P1="" F  S P1=$O(MAGLOC("P",P1)) Q:P1=""  D
"RTN","MAGDRPC8",92,0)
 . S P2="" F  S P2=$O(MAGLOC("P",P1,"C",P2)) Q:P2=""  S T(P2)=""
"RTN","MAGDRPC8",93,0)
 . Q
"RTN","MAGDRPC8",94,0)
 Q
"RTN","MAGDRPC8",95,0)
 ;
"RTN","MAGDRPC8",96,0)
LOCS(OUT) ; RPC = MAG DICOM VALID LOCATIONS
"RTN","MAGDRPC8",97,0)
 N D0,I,M,N,P1,R,T
"RTN","MAGDRPC8",98,0)
 S N=1
"RTN","MAGDRPC8",99,0)
 S D0=0 F  S D0=$O(^MAG(2006.1,D0)) Q:'D0  D
"RTN","MAGDRPC8",100,0)
 . S X=$G(^MAG(2006.1,D0,0)),P1=$P(X,"^",1) Q:P1=""
"RTN","MAGDRPC8",101,0)
 . I +P1=P1 S T(P1)="" Q
"RTN","MAGDRPC8",102,0)
 . D FIND^DIC(4,"","","BX",P1,"*","","","","R","M") ; IA #4389
"RTN","MAGDRPC8",103,0)
 . S I=0 F  S I=$O(R("DILIST",2,I)) Q:'I  D
"RTN","MAGDRPC8",104,0)
 . . S P1=R("DILIST",2,I) I P1 K R S T(P1)=""
"RTN","MAGDRPC8",105,0)
 . . Q
"RTN","MAGDRPC8",106,0)
 . Q
"RTN","MAGDRPC8",107,0)
 I $T(+1^XUPARAM)'="" S P1=$$KSP^XUPARAM("INST") D:P1 SIBS(P1,.T)
"RTN","MAGDRPC8",108,0)
 S P1=+$G(^DD("SITE",1)) D:P1 SIBS(P1,.T)
"RTN","MAGDRPC8",109,0)
 ;
"RTN","MAGDRPC8",110,0)
 S P1="" F  S P1=$O(T(P1)) Q:P1=""  D
"RTN","MAGDRPC8",111,0)
 . S N=N+1,OUT(N)=P1_"^"_$$GET1^DIQ(4,P1,.01)_"^"_$$GET1^DIQ(4,P1,99)
"RTN","MAGDRPC8",112,0)
 . Q
"RTN","MAGDRPC8",113,0)
 S OUT(1)=N-1
"RTN","MAGDRPC8",114,0)
 Q
"RTN","MAGDRPC8",115,0)
 ;
"RTN","MAGDRPC8",116,0)
GETPLACE(OUT,LOCATION) ; RPC = MAG DICOM GET PLACE
"RTN","MAGDRPC8",117,0)
 N D0,P1,M,R,X
"RTN","MAGDRPC8",118,0)
 S LOCATION=+$G(LOCATION)
"RTN","MAGDRPC8",119,0)
 S OUT="-1,Location """_LOCATION_""" not found."
"RTN","MAGDRPC8",120,0)
 S D0=0 F  S D0=$O(^MAG(2006.1,D0)) Q:'D0  D  Q:OUT>0
"RTN","MAGDRPC8",121,0)
 . S X=$G(^MAG(2006.1,D0,0)),P1=$P(X,"^",1) Q:P1=""
"RTN","MAGDRPC8",122,0)
 . I +P1=P1,LOCATION=P1 S OUT=D0 Q
"RTN","MAGDRPC8",123,0)
 . D FIND^DIC(4,"","","BX",P1,"*","","","","R","M")
"RTN","MAGDRPC8",124,0)
 . S I=0 F  S I=$O(R("DILIST",2,I)) Q:'I  D
"RTN","MAGDRPC8",125,0)
 . . I LOCATION=R("DILIST",2,I) S OUT=D0
"RTN","MAGDRPC8",126,0)
 . . Q
"RTN","MAGDRPC8",127,0)
 . Q
"RTN","MAGDRPC8",128,0)
 Q
"RTN","MAGDRPC8",129,0)
 ;
"RTN","MAGDRPC8",130,0)
SETPACS(OUT,D0) ; RPC = MAG DICOM SET PACS PARAMS
"RTN","MAGDRPC8",131,0)
 N X
"RTN","MAGDRPC8",132,0)
 I '$G(D0) S OUT="-1,No Place Specified." Q
"RTN","MAGDRPC8",133,0)
 I '$D(^MAG(2006.1,D0)) S OUT="-2,Invalid Place Specified." Q
"RTN","MAGDRPC8",134,0)
 ;
"RTN","MAGDRPC8",135,0)
 ; There is a PACS
"RTN","MAGDRPC8",136,0)
 S $P(^MAG(2006.1,D0,"PACS"),"^",1)=1
"RTN","MAGDRPC8",137,0)
 ;
"RTN","MAGDRPC8",138,0)
 ; Number of days to retain "PACS" images
"RTN","MAGDRPC8",139,0)
 S X=$P($G(^MAG(2006.1,D0,1)),"^",5)
"RTN","MAGDRPC8",140,0)
 S:'X $P(^MAG(2006.1,D0,1),"^",5)=30
"RTN","MAGDRPC8",141,0)
 ;
"RTN","MAGDRPC8",142,0)
 ; Set minimum % of free disk space to trigger automatic file delete
"RTN","MAGDRPC8",143,0)
 S X=$P($G(^MAG(2006.1,D0,3)),"^",6)
"RTN","MAGDRPC8",144,0)
 S:'X $P(^MAG(2006.1,D0,3),"^",6)=25
"RTN","MAGDRPC8",145,0)
 S OUT=1
"RTN","MAGDRPC8",146,0)
 Q
"RTN","MAGDRPC8",147,0)
 ;
"RTN","MAGDRPC8",148,0)
HIGHHL7(OUT) ; RPC = MAG DICOM GET HIGHEST HL7
"RTN","MAGDRPC8",149,0)
 S OUT=+$O(^MAGDHL7(2006.5," "),-1)
"RTN","MAGDRPC8",150,0)
 Q
"RTN","MAGDRPC8",151,0)
 ;
"RTN","MAGDRPC8",152,0)
FINDLOC(OUT,NAME) ; RPC = MAG DICOM FIND LOCATION
"RTN","MAGDRPC8",153,0)
 N I,M,P1,R,X
"RTN","MAGDRPC8",154,0)
 S OUT="-1,Invalid location """_NAME_"""."
"RTN","MAGDRPC8",155,0)
 D FIND^DIC(4,"",.01,"BXA",NAME,"*","","","","R","M")
"RTN","MAGDRPC8",156,0)
 S I=0 F  S I=$O(R("DILIST",2,I)) Q:'I  D
"RTN","MAGDRPC8",157,0)
 . S P1=R("DILIST",2,I) I P1 K R S OUT=P1
"RTN","MAGDRPC8",158,0)
 . Q
"RTN","MAGDRPC8",159,0)
 Q
"RTN","MAGDRPC8",160,0)
 ;
"RTN","MAGDRPC8",161,0)
VALIMGT(OUT) ; RPC = MAG DICOM GET IMAGING TYPES
"RTN","MAGDRPC8",162,0)
 N N,X
"RTN","MAGDRPC8",163,0)
 S N=1
"RTN","MAGDRPC8",164,0)
 ; Lists of valid imaging types
"RTN","MAGDRPC8",165,0)
 S X="" F  S X=$O(^RA(79.2,"C",X)) Q:X=""  S N=N+1,OUT(N)="RAD^"_X
"RTN","MAGDRPC8",166,0)
 S X="" F  S X=$O(^MAG(2005.84,"C",X)) Q:X=""  S N=N+1,OUT(N)="CON^"_X
"RTN","MAGDRPC8",167,0)
 S OUT(1)=N-1
"RTN","MAGDRPC8",168,0)
 Q
"RTN","MAGDRPC8",169,0)
 ;
"RTN","MAGDRPC8",170,0)
CORRECT(OUT,LOCATION,MACHID) ; RPC = MAG DICOM INCORRECT IMAGE CT
"RTN","MAGDRPC8",171,0)
 ; Check for images needing corrections
"RTN","MAGDRPC8",172,0)
 N CNT,D0,STUDY
"RTN","MAGDRPC8",173,0)
 I '$G(LOCATION) S OUT="-1,No Location Specified" Q
"RTN","MAGDRPC8",174,0)
 I $G(MACHID)="" S OUT="-2,No Gateway Specified" Q
"RTN","MAGDRPC8",175,0)
 S OUT=0
"RTN","MAGDRPC8",176,0)
 Q:'$O(^MAGD(2006.575,0))
"RTN","MAGDRPC8",177,0)
 Q:'$D(^MAGD(2006.575,"F",LOCATION))
"RTN","MAGDRPC8",178,0)
 S STUDY="" F  S STUDY=$O(^MAGD(2006.575,"F",LOCATION,STUDY)) Q:STUDY=""  D
"RTN","MAGDRPC8",179,0)
 . S D0=0 S D0=$O(^MAGD(2006.575,"F",LOCATION,STUDY,D0)) Q:'D0  D
"RTN","MAGDRPC8",180,0)
 . . Q:'$D(^MAGD(2006.575,D0,0))
"RTN","MAGDRPC8",181,0)
 . . S:MACHID=$P($G(^MAGD(2006.575,D0,1)),"^",4) OUT=OUT+1
"RTN","MAGDRPC8",182,0)
 . . Q
"RTN","MAGDRPC8",183,0)
 . Q
"RTN","MAGDRPC8",184,0)
 Q
"RTN","MAGDRPC8",185,0)
 ;
"RTN","MAGDRPC8",186,0)
HL7PTR(OUT,ACTION,VALUE) ; RPC = MAG DICOM HL7 POINTER ACTION
"RTN","MAGDRPC8",187,0)
 ; Manipulate HL7 Pointer
"RTN","MAGDRPC8",188,0)
 N D0,P1,P2,X,Y
"RTN","MAGDRPC8",189,0)
 S ACTION=$G(ACTION),VALUE=$G(VALUE)
"RTN","MAGDRPC8",190,0)
 S OUT="-2,Invalid Request: """_ACTION_"""."
"RTN","MAGDRPC8",191,0)
 I ACTION="GetDate" D  Q
"RTN","MAGDRPC8",192,0)
 . S X=$G(^MAGDHL7(2006.5,+VALUE,0))
"RTN","MAGDRPC8",193,0)
 . I X="" S OUT="-1,Invalid Pointer """_VALUE_"""." Q
"RTN","MAGDRPC8",194,0)
 . S Y=$P(X,"^",3) D DD^%DT S OUT=Y
"RTN","MAGDRPC8",195,0)
 . Q
"RTN","MAGDRPC8",196,0)
 I ACTION="DatePtr" D  Q
"RTN","MAGDRPC8",197,0)
 . S Y=$O(^MAGDHL7(2006.5,"C",VALUE),-1)
"RTN","MAGDRPC8",198,0)
 . I 'Y D  ; before any date on file
"RTN","MAGDRPC8",199,0)
 . . ; if the requested date is before the first entry,
"RTN","MAGDRPC8",200,0)
 . . ; move the pointer to the first entry
"RTN","MAGDRPC8",201,0)
 . . S OUT=0
"RTN","MAGDRPC8",202,0)
 . . Q
"RTN","MAGDRPC8",203,0)
 . E  D  ; if the requested date is in the cross reference, use it.
"RTN","MAGDRPC8",204,0)
 . . S Y=$O(^MAGDHL7(2006.5,"C",Y,""))
"RTN","MAGDRPC8",205,0)
 . . I Y S OUT=Y ; found date
"RTN","MAGDRPC8",206,0)
 . . E  D
"RTN","MAGDRPC8",207,0)
  . . . ; otherwise, find the appropriate entry the hard way
"RTN","MAGDRPC8",208,0)
 . . . S D0=$O(^MAGDHL7(2006.5,0))
"RTN","MAGDRPC8",209,0)
 . . . S Y=$P($G(^MAGDHL7(2006.5,D0,0)),"^",3) I Y'<X S OUT=0 Q
"RTN","MAGDRPC8",210,0)
 . . . S D0=" " F  S D0=$O(^MAGDHL7(2006.5,D0),-1) Q:'D0  D  Q:OUT
"RTN","MAGDRPC8",211,0)
 . . . . S Y=$P($G(^MAGDHL7(2006.5,D0,0)),"^",3) S:Y<X OUT=D0
"RTN","MAGDRPC8",212,0)
 . . . . Q
"RTN","MAGDRPC8",213,0)
 . . . Q
"RTN","MAGDRPC8",214,0)
 . . Q
"RTN","MAGDRPC8",215,0)
 . Q
"RTN","MAGDRPC8",216,0)
 Q
"RTN","MAGDRPC8",217,0)
 ;
"RTN","MAGIPS30")
0^^B9510429
"RTN","MAGIPS30",1,0)
MAGIPS30 ;Post init routine to queue site activity at install. ; 08/27/2004  07:27
"RTN","MAGIPS30",2,0)
 ;;3.0;IMAGING;**30**;16-September-2004
"RTN","MAGIPS30",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIPS30",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIPS30",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIPS30",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIPS30",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIPS30",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIPS30",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIPS30",10,0)
 ;; |                                                               |
"RTN","MAGIPS30",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIPS30",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIPS30",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIPS30",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIPS30",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIPS30",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIPS30",17,0)
 ;;
"RTN","MAGIPS30",18,0)
 Q
"RTN","MAGIPS30",19,0)
 ;
"RTN","MAGIPS30",20,0)
PRE ;
"RTN","MAGIPS30",21,0)
 N DIU
"RTN","MAGIPS30",22,0)
 ; Remove obsolete DD definitions
"RTN","MAGIPS30",23,0)
 F DIU=2006.79,2006.592,2006.593 D
"RTN","MAGIPS30",24,0)
 . S DIU(0)="" D EN^DIU2
"RTN","MAGIPS30",25,0)
 . Q
"RTN","MAGIPS30",26,0)
 ; Remove FileRoots too
"RTN","MAGIPS30",27,0)
 K ^MAGD(2006.592)
"RTN","MAGIPS30",28,0)
 K ^MAGD(2006.593)
"RTN","MAGIPS30",29,0)
 K ^MAGD(2006.79)
"RTN","MAGIPS30",30,0)
 Q
"RTN","MAGIPS30",31,0)
 ;
"RTN","MAGIPS30",32,0)
POST ;
"RTN","MAGIPS30",33,0)
 N CT,CNT,D,D0,D1,D2,DDATE,DG,DIC,DICR,DIW,MAGMSG,ST,XMID,XMY
"RTN","MAGIPS30",34,0)
 ;
"RTN","MAGIPS30",35,0)
 D GETENV^%ZOSV
"RTN","MAGIPS30",36,0)
 S CNT=0
"RTN","MAGIPS30",37,0)
 S CNT=CNT+1,MAGMSG(CNT)="PACKAGE INSTALL"
"RTN","MAGIPS30",38,0)
 S CNT=CNT+1,MAGMSG(CNT)="SITE: "_$$KSP^XUPARAM("WHERE")
"RTN","MAGIPS30",39,0)
 S CNT=CNT+1,MAGMSG(CNT)="PACKAGE: "_XPDNM
"RTN","MAGIPS30",40,0)
 S CNT=CNT+1,MAGMSG(CNT)="Version: "_$$VER^XPDUTL(XPDNM)
"RTN","MAGIPS30",41,0)
 S ST=$$GET1^DIQ(9.7,XPDA,11,"I")
"RTN","MAGIPS30",42,0)
 S CNT=CNT+1,MAGMSG(CNT)="Start time: "_$$FMTE^XLFDT(ST)
"RTN","MAGIPS30",43,0)
 S CT=$$GET1^DIQ(9.7,XPDA,17,"I") S:+CT'=CT CT=$$NOW^XLFDT()
"RTN","MAGIPS30",44,0)
 S CNT=CNT+1,MAGMSG(CNT)="Completion time: "_$$FMTE^XLFDT(CT)
"RTN","MAGIPS30",45,0)
 S CNT=CNT+1,MAGMSG(CNT)="Run time: "_$$FMDIFF^XLFDT(CT,ST,3)
"RTN","MAGIPS30",46,0)
 S CNT=CNT+1,MAGMSG(CNT)="Environment: "_Y
"RTN","MAGIPS30",47,0)
 S CNT=CNT+1,MAGMSG(CNT)="FILE COMMENT: "_$$GET1^DIQ(9.7,XPDA,6,"I")
"RTN","MAGIPS30",48,0)
 S CNT=CNT+1,MAGMSG(CNT)="DATE: "_$$NOW^XLFDT()
"RTN","MAGIPS30",49,0)
 S CNT=CNT+1,MAGMSG(CNT)="Installed by: "_$$GET1^DIQ(9.7,XPDA,9,"E")
"RTN","MAGIPS30",50,0)
 S CNT=CNT+1,MAGMSG(CNT)="Install Name: "_$$GET1^DIQ(9.7,XPDA,.01,"E")
"RTN","MAGIPS30",51,0)
 S DDATE=$$GET1^DIQ(9.7,XPDA,51,"I")
"RTN","MAGIPS30",52,0)
 S CNT=CNT+1,MAGMSG(CNT)="Distribution Date: "_$$FMTE^XLFDT(DDATE)
"RTN","MAGIPS30",53,0)
 S XMSUB=XPDNM_" INSTALLATION"
"RTN","MAGIPS30",54,0)
 S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGIPS30",55,0)
 S XMY(XMID)=""
"RTN","MAGIPS30",56,0)
 S XMY("G.MAG SERVER")=""
"RTN","MAGIPS30",57,0)
 S:$G(MAGDUZ) XMY(MAGDUZ)=""
"RTN","MAGIPS30",58,0)
 S XMSUB=$E(XMSUB,1,63)
"RTN","MAGIPS30",59,0)
 D SENDMSG^XMXAPI(XMID,XMSUB,"MAGMSG",.XMY,,.XMZ,)
"RTN","MAGIPS30",60,0)
 I $G(XMERR) M XMERR=^TMP("XMERR",$J) S $EC=",U13-Cannot send MailMan message,"
"RTN","MAGIPS30",61,0)
 Q
"RTN","MAGIPS30",62,0)
 ;
"RTN","MAGQE1")
0^25^B11477872
"RTN","MAGQE1",1,0)
MAGQE1 ;WOIFO/RMP - Support for MAG Enterprise ; 05/06/2004  06:32
"RTN","MAGQE1",2,0)
 ;;3.0;IMAGING;**27,29,30**;16-September-2004
"RTN","MAGQE1",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE1",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQE1",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQE1",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQE1",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQE1",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQE1",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQE1",10,0)
 ;; |                                                               |
"RTN","MAGQE1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQE1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQE1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQE1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQE1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQE1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE1",17,0)
 ;;
"RTN","MAGQE1",18,0)
 Q
"RTN","MAGQE1",19,0)
 ;
"RTN","MAGQE1",20,0)
SDATE(FDAY,ORDER) ; Find first image before/after specified date
"RTN","MAGQE1",21,0)
 ; EdM: In a future patch, this function must be replaced by a cross-reference.
"RTN","MAGQE1",22,0)
 N I1,I2
"RTN","MAGQE1",23,0)
 I $G(ORDER)'="R" Q 0
"RTN","MAGQE1",24,0)
 S I1=$O(^MAG(2005," "),-1)+1 S I2=$O(^MAG(2005.1," "),-1)+1
"RTN","MAGQE1",25,0)
 Q $S(I1>I2:I1,1:I2)
"RTN","MAGQE1",26,0)
 ;
"RTN","MAGQE1",27,0)
BPV(PLACE) ;
"RTN","MAGQE1",28,0)
 N BPWS,D0,NODE,INDEX
"RTN","MAGQE1",29,0)
 S D0=0 F  S D0=$O(^MAG(2006.8,"D",PLACE,D0)) Q:'D0  D
"RTN","MAGQE1",30,0)
 . Q:$P($G(^MAG(2006.8,D0,0)),"^",12)'="1"
"RTN","MAGQE1",31,0)
 . S NODE=$G(^MAG(2006.8,D0,1))
"RTN","MAGQE1",32,0)
 . D:$P(NODE,"^",2)>0
"RTN","MAGQE1",33,0)
 . . S INDEX=$P(NODE,"^",2)_"^"_$P(NODE,"^",4)
"RTN","MAGQE1",34,0)
 . . S BPWS(INDEX)=$G(BPWS(INDEX))+1
"RTN","MAGQE1",35,0)
 . . S $P(BPWS(INDEX),"^",2)=$P(NODE,"^",3)
"RTN","MAGQE1",36,0)
 . . Q
"RTN","MAGQE1",37,0)
 . Q
"RTN","MAGQE1",38,0)
 D:$D(BPWS) LLOAD^MAGQE5(.BPWS,"BP VERS NUM DATE: ")
"RTN","MAGQE1",39,0)
 Q
"RTN","MAGQE1",40,0)
 ;
"RTN","MAGQE1",41,0)
IWSV(PLACE) ; Image workstation versions
"RTN","MAGQE1",42,0)
 N D0,IDX,OS,RD,WSC,WSD,WSV,X
"RTN","MAGQE1",43,0)
 S RD=$$FMADD^XLFDT($$NOW^XLFDT,-180,"","","")
"RTN","MAGQE1",44,0)
 S D0=0 F  S D0=$O(^MAG(2006.81,"C",PLACE,D0)) Q:'D0  D
"RTN","MAGQE1",45,0)
 . S X=^MAG(2006.81,D0,0) Q:$P(X,"^",3)<RD
"RTN","MAGQE1",46,0)
 . S OS=$P($G(^MAG(2006.81,D0,1)),"^",2)
"RTN","MAGQE1",47,0)
 . S:OS?.N OS=$P($G(^MAG(2006.81,D0,1)),"^",3)
"RTN","MAGQE1",48,0)
 . S IDX=$P(X,"^",9) D:IDX'=""  ; Display Station
"RTN","MAGQE1",49,0)
 . . S:OS'="" IDX=IDX_"^"_OS S WSD(IDX)=$G(WSD(IDX))+1
"RTN","MAGQE1",50,0)
 . . Q
"RTN","MAGQE1",51,0)
 . S IDX=$P(X,"^",13) D:IDX'=""  ; Capture Station
"RTN","MAGQE1",52,0)
 . . S:OS'="" IDX=IDX_"^"_OS S WSC(IDX)=$G(WSC(IDX))+1
"RTN","MAGQE1",53,0)
 . . Q
"RTN","MAGQE1",54,0)
 . S IDX=$P(X,"^",15) D:IDX'=""  ; VistARad Station
"RTN","MAGQE1",55,0)
 . . S:OS'="" IDX=IDX_"^"_OS S WSV(IDX)=$G(WSV(IDX))+1
"RTN","MAGQE1",56,0)
 . . Q
"RTN","MAGQE1",57,0)
 . Q
"RTN","MAGQE1",58,0)
 D LLOAD^MAGQE5(.WSD," WS DIS VERS: ")
"RTN","MAGQE1",59,0)
 D LLOAD^MAGQE5(.WSC," WS CAP VERS: ")
"RTN","MAGQE1",60,0)
 D LLOAD^MAGQE5(.WSV," WS VR VERS: ")
"RTN","MAGQE1",61,0)
 Q
"RTN","MAGQE1",62,0)
 ;
"RTN","MAGQE1",63,0)
DICOMV() ; Version of DICOM
"RTN","MAGQE1",64,0)
 N D0,DCMG,RD,T,VER,X
"RTN","MAGQE1",65,0)
 S RD=$$FMADD^XLFDT($$NOW^XLFDT,-30,"","","")
"RTN","MAGQE1",66,0)
 S X="" F  S X=$O(^MAG(2006.83,"B",X)) Q:X=""  D
"RTN","MAGQE1",67,0)
 . S D0=$O(^MAG(2006.83,"B",X,"")) Q:'D0
"RTN","MAGQE1",68,0)
 . S T=$G(^MAG(2006.83,D0,0)) Q:$P(T,"^",2)<RD
"RTN","MAGQE1",69,0)
 . S VER=$P(T,"^",3) S:VER="" VER="?"
"RTN","MAGQE1",70,0)
 . S DCMG(VER)=$G(DCMG(VER))+1
"RTN","MAGQE1",71,0)
 . Q
"RTN","MAGQE1",72,0)
 D:$D(DCMG) LLOAD^MAGQE5(.DCMG,"DICOM Gateway Version: ")
"RTN","MAGQE1",73,0)
 Q
"RTN","MAGQE1",74,0)
 ;
"RTN","MAGQE1",75,0)
VSTAV() ;
"RTN","MAGQE1",76,0)
 N VER
"RTN","MAGQE1",77,0)
 S VER=$$VERSION^XPDUTL("IMAGING")
"RTN","MAGQE1",78,0)
 S:$T(LAST^XPDUTL)'="" VER=VER_"^"_$$LAST^XPDUTL("IMAGING",VER)
"RTN","MAGQE1",79,0)
 Q VER
"RTN","MAGQE1",80,0)
 ;
"RTN","MAGQE1",81,0)
SNS(PLACE) ;
"RTN","MAGQE1",82,0)
 N D1,RESULT
"RTN","MAGQE1",83,0)
 S RESULT=$P(^MAG(2006.1,PLACE,0),"^",2)
"RTN","MAGQE1",84,0)
 S D1=0 F  S D1=$O(^MAG(2006.1,PLACE,4,D1)) Q:'D1  D
"RTN","MAGQE1",85,0)
 . S RESULT=RESULT_"^"_$P($G(^MAG(2006.1,PLACE,4,D1,0)),"^",1)
"RTN","MAGQE1",86,0)
 . Q
"RTN","MAGQE1",87,0)
 Q RESULT
"RTN","MAGQE1",88,0)
 ;
"RTN","MAGQE3")
0^26^B75455460
"RTN","MAGQE3",1,0)
MAGQE3 ;WOIFO/RMP - Support for MAG Enterprise ; 05/06/2004  06:32
"RTN","MAGQE3",2,0)
 ;;3.0;IMAGING;**27,29,30**;16-September-2004
"RTN","MAGQE3",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE3",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQE3",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQE3",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQE3",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQE3",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQE3",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQE3",10,0)
 ;; |                                                               |
"RTN","MAGQE3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQE3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQE3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQE3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQE3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQE3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE3",17,0)
 ;;
"RTN","MAGQE3",18,0)
 Q
"RTN","MAGQE3",19,0)
 ;
"RTN","MAGQE3",20,0)
COUNT(SDATE,EDATE,INST) ;
"RTN","MAGQE3",21,0)
 N CLIN,CONSENTS,CPTR,D0,DAT,DELETED,DICOM,DOC,DOCGRP,DOCUMENT,ED0,GRPPRNT,I,IMAGE,IMPORT,NAME,NODE,OTHER,PCE,PROC,SD0,TRK
"RTN","MAGQE3",22,0)
 S SD0=$$SDATE^MAGQE1(SDATE,"F")
"RTN","MAGQE3",23,0)
 S ED0=$$SDATE^MAGQE1(EDATE,"R")
"RTN","MAGQE3",24,0)
 D MSG^MAGQE2(" From, FileMan Date="""_SDATE_""", D0="""_SD0_""".")
"RTN","MAGQE3",25,0)
 D MSG^MAGQE2("Until, FileMan Date="""_EDATE_""", D0="""_ED0_""".")
"RTN","MAGQE3",26,0)
 S D0="" F  S D0=$O(^MAG(2005.02,"B","DOCUMENT",D0)) Q:D0=""  D
"RTN","MAGQE3",27,0)
 . S:$G(^MAG(2005.02,D0,4))["TIF" DOC(D0)=""
"RTN","MAGQE3",28,0)
 . Q
"RTN","MAGQE3",29,0)
 S (CONSENTS,GRPPRNT,IMAGE,DELETED,DOCGRP,DOCUMENT)=0
"RTN","MAGQE3",30,0)
 S CPTR=$O(^MAG(2005.83,"B","CONSENT",""))
"RTN","MAGQE3",31,0)
 S D0=SD0 F  S D0=$O(^MAG(2005,D0)) Q:'D0  Q:D0'<ED0  D
"RTN","MAGQE3",32,0)
 . S X=$P($G(^MAG(2005,D0,2)),"^",1) Q:'X  Q:X<SDATE  Q:X>EDATE
"RTN","MAGQE3",33,0)
 . S NODE=$G(^MAG(2005,D0,100)),TRK=""
"RTN","MAGQE3",34,0)
 . S PCE=$P(NODE,"^",3) I PCE Q:PCE'=INST
"RTN","MAGQE3",35,0)
 . S PCE=$P(NODE,"^",5) I PCE'="" S TRK=$P(TRK,";",1) S:TRK="" TRK="?"
"RTN","MAGQE3",36,0)
 . S NODE=$G(^MAG(2005,D0,0))
"RTN","MAGQE3",37,0)
 . I $P(NODE,"^",2)="" D  Q
"RTN","MAGQE3",38,0)
 . . S GRPPRNT=GRPPRNT+1
"RTN","MAGQE3",39,0)
 . . S PCE=$P(NODE,"^",8) S:PCE="" PCE="NIL"
"RTN","MAGQE3",40,0)
 . . S:$D(^MAG(2005,D0,"PACS")) DICOM(PCE,0)=$G(DICOM(PCE,0))+1
"RTN","MAGQE3",41,0)
 . . S PCE=$P(NODE,"^",6) I PCE,$D(DOC(PCE)) S DOCGRP=DOCGRP+1
"RTN","MAGQE3",42,0)
 . . S:TRK'="" IMPORT(TRK,0)=$G(IMPORT(TRK,0))+1
"RTN","MAGQE3",43,0)
 . . Q
"RTN","MAGQE3",44,0)
 . S:TRK'="" IMPORT(TRK)=$G(IMPORT(TRK))+1
"RTN","MAGQE3",45,0)
 . I CPTR,$P($G(^MAG(2005,D0,40)),"^",3)=CPTR S CONSENTS=CONSENTS+1
"RTN","MAGQE3",46,0)
 . E  S PCE=$$UPPER^MAGQE4($P($G(^MAG(2005,D0,2)),"^",4)) S:PCE["CONSENT" OTHER(PCE)=$G(OTHER(PCE))+1
"RTN","MAGQE3",47,0)
 . S IMAGE=IMAGE+1
"RTN","MAGQE3",48,0)
 . S PCE=$P(NODE,"^",6) I PCE,$D(DOC(PCE)) S DOCUMENT=DOCUMENT+1
"RTN","MAGQE3",49,0)
 . S PCE=$P(NODE,"^",7) S:PCE="" PCE="NIL"
"RTN","MAGQE3",50,0)
 . S ^TMP($J,"MAGQ","ACQPAT",PCE)=""
"RTN","MAGQE3",51,0)
 . S ^TMP($J,"MAGQ","ALLPAT",PCE)=""
"RTN","MAGQE3",52,0)
 . S PCE=$P(NODE,"^",8) S:PCE="" PCE="NIL"
"RTN","MAGQE3",53,0)
 . I $D(^MAG(2005,D0,"PACS")) S DICOM(PCE)=$G(DICOM(PCE))+1
"RTN","MAGQE3",54,0)
 . E  S CLIN(PCE)=$G(CLIN(PCE))+1
"RTN","MAGQE3",55,0)
 . Q
"RTN","MAGQE3",56,0)
 S NAME="" F  S NAME=$O(DICOM(NAME)) Q:NAME=""  D
"RTN","MAGQE3",57,0)
 . D:$E(NAME,1,4)="RAD "
"RTN","MAGQE3",58,0)
 . . Q:'$D(DICOM(NAME,0))
"RTN","MAGQE3",59,0)
 . . S I=$E(NAME,5,$L(NAME)) Q:I=""
"RTN","MAGQE3",60,0)
 . . Q:$D(DICOM(I,0))
"RTN","MAGQE3",61,0)
 . . S DICOM(I,0)=DICOM(NAME,0) K DICOM(NAME,0)
"RTN","MAGQE3",62,0)
 . . Q
"RTN","MAGQE3",63,0)
 . S PROC=$O(^RAMIS(73.1,"B",NAME,"")) Q:'PROC
"RTN","MAGQE3",64,0)
 . S $P(DICOM(NAME),"^",2)=$P($G(^RAMIS(73.1,PROC,0)),"^",2)
"RTN","MAGQE3",65,0)
 . Q
"RTN","MAGQE3",66,0)
 S D0=SD0 F  S D0=$O(^MAG(2005.1,D0)) Q:'D0  Q:D0'<ED0  D
"RTN","MAGQE3",67,0)
 . S X=$P($G(^MAG(2005.1,D0,2)),"^",1) Q:'X  Q:X<SDATE  Q:X>EDATE
"RTN","MAGQE3",68,0)
 . S PCE=$P($G(^MAG(2005.1,D0,100)),"^",3) I PCE Q:PCE'=INST
"RTN","MAGQE3",69,0)
 . S DELETED=DELETED+1
"RTN","MAGQE3",70,0)
 . Q
"RTN","MAGQE3",71,0)
 S I="" F  S I=$O(DICOM(I)) Q:I=""  D
"RTN","MAGQE3",72,0)
 . S X=" DICOM CAPTURE: "_I_"^"_$G(DICOM(I))
"RTN","MAGQE3",73,0)
 . S:$G(DICOM(I,0)) $P(X,"^",4)=DICOM(I,0)
"RTN","MAGQE3",74,0)
 . D MSG^MAGQE2(X)
"RTN","MAGQE3",75,0)
 . Q
"RTN","MAGQE3",76,0)
 S I="" F  S I=$O(IMPORT(I)) Q:I=""  D
"RTN","MAGQE3",77,0)
 . S X=" IMPORT API: "_I_"^"_IMPORT(I)
"RTN","MAGQE3",78,0)
 . S:$G(IMPORT(I,0)) X=X_"^"_IMPORT(I,0)
"RTN","MAGQE3",79,0)
 . D MSG^MAGQE2(X)
"RTN","MAGQE3",80,0)
 . Q
"RTN","MAGQE3",81,0)
 D LLOAD^MAGQE5(.CLIN,"CLIN CAPTURE:")
"RTN","MAGQE3",82,0)
 D MSG^MAGQE2("CONSENT FORMS: "_CONSENTS)
"RTN","MAGQE3",83,0)
 D LLOAD^MAGQE5(.OTHER,"OTHER CONSENTS:")
"RTN","MAGQE3",84,0)
 D MSG^MAGQE2("Image file group parents: "_GRPPRNT)
"RTN","MAGQE3",85,0)
 D MSG^MAGQE2("Image file objects: "_IMAGE)
"RTN","MAGQE3",86,0)
 D MSG^MAGQE2("Image file deletes: "_DELETED)
"RTN","MAGQE3",87,0)
 D MSG^MAGQE2("Document Images (TIF): "_DOCUMENT)
"RTN","MAGQE3",88,0)
 D MSG^MAGQE2("Document Groups (TIF): "_DOCGRP)
"RTN","MAGQE3",89,0)
 Q
"RTN","MAGQE3",90,0)
 ;
"RTN","MAGQE3",91,0)
ACT(D0,DIS,CAP,VD,VI,RES) ;
"RTN","MAGQE3",92,0)
 N ACT,AN,AN2,D1,IMG
"RTN","MAGQE3",93,0)
 S D1=0 F  S D1=$O(^MAG(2006.82,D0,"ACT",D1)) Q:'D1  D
"RTN","MAGQE3",94,0)
 . S AN=^MAG(2006.82,D0,"ACT",D1,0)
"RTN","MAGQE3",95,0)
 . S ACT="^"_$P(AN,"^",1)_"^",AN2=+$P(AN,"^",2)
"RTN","MAGQE3",96,0)
 . Q:"^LOGON^LOGOFF^PAT^"[ACT
"RTN","MAGQE3",97,0)
 . I "^SC_BAD^SCR_OK^"[ACT D  Q
"RTN","MAGQE3",98,0)
 . . S AN=$P(AN,"^",10,14) Q:AN=""
"RTN","MAGQE3",99,0)
 . . S RES(ACT,AN)=$G(RES(ACT,AN))+1
"RTN","MAGQE3",100,0)
 . . Q
"RTN","MAGQE3",101,0)
 . I "^CAP^IMG^"[ACT D  Q
"RTN","MAGQE3",102,0)
 . . S IMG=+$P(AN,"^",3) Q:'IMG  Q:$P($G(^MAG(2005,IMG,0)),"^",2)=""
"RTN","MAGQE3",103,0)
 . . I ACT="^CAP^" S CAP=CAP+1 Q
"RTN","MAGQE3",104,0)
 . . S DIS=DIS+1,^TMP($J,"MAGQ","DISPAT",AN2)="",^TMP($J,"MAGQ","ALLPAT",AN2)=""
"RTN","MAGQE3",105,0)
 . . Q
"RTN","MAGQE3",106,0)
 . I "^VR-VW^"[ACT D VRAD(.VD,AN) S ^TMP($J,"MAGQ","DISPAT",AN2)="",^TMP($J,"MAGQ","ALLPAT",AN2)="" Q
"RTN","MAGQE3",107,0)
 . I "^VR-INT^"[ACT D VRAD(.VI,AN) S ^TMP($J,"MAGQ","DISPAT",AN2)="",^TMP($J,"MAGQ","ALLPAT",AN2)="" Q
"RTN","MAGQE3",108,0)
 . Q
"RTN","MAGQE3",109,0)
 Q
"RTN","MAGQE3",110,0)
 ;
"RTN","MAGQE3",111,0)
VRAD(ARR,AN) ;
"RTN","MAGQE3",112,0)
 ;ARR=STUDIES^IMAGES^PATIENTS^User Type(Rad/Non-Rad)^Remotes(Remote/Local)^Modalities
"RTN","MAGQE3",113,0)
 N P,X
"RTN","MAGQE3",114,0)
 S $P(ARR,"^",1)=$P($G(ARR),"^",1)+1 ; Studies
"RTN","MAGQE3",115,0)
 S $P(ARR,"^",2)=$P($G(ARR),"^",2)+$P(AN,"^",6) ; Images
"RTN","MAGQE3",116,0)
 S $P(ARR,"^",3)=$P($G(ARR),"^",3)+$P(AN,"^",7) ; Patients
"RTN","MAGQE3",117,0)
 S P=$P(ARR,"^",4)
"RTN","MAGQE3",118,0)
 I +$P(AN,"^",8)=1 S $P(P,"/",1)=$P(P,"/",1)+1
"RTN","MAGQE3",119,0)
 E  S $P(P,"/",2)=$P(P,"/",2)+1
"RTN","MAGQE3",120,0)
 S $P(ARR,"^",4)=P ; User Type
"RTN","MAGQE3",121,0)
 S P=$P(ARR,"^",5)
"RTN","MAGQE3",122,0)
 I +$P(AN,"^",9)=1 S $P(P,"/",1)=$P(P,"/",1)+1
"RTN","MAGQE3",123,0)
 E  S $P(P,"/",2)=$P(P,"/",2)+1
"RTN","MAGQE3",124,0)
 S $P(ARR,"^",5)=P ; Remotes
"RTN","MAGQE3",125,0)
 S P=$P(AN,"^",4) S:P="" P="unknown"
"RTN","MAGQE3",126,0)
 S ARR(P)=$G(ARR(P))+1
"RTN","MAGQE3",127,0)
 S (P,X)="" F  S P=$O(ARR(P)) Q:P=""  S X=X_"/"_P_"="_ARR(P)
"RTN","MAGQE3",128,0)
 S $P(ARR,"^",6)=X ; Modalities
"RTN","MAGQE3",129,0)
 Q
"RTN","MAGQE3",130,0)
 ;
"RTN","MAGQE3",131,0)
GPACHX() ; Get Package File Install History of Imaging
"RTN","MAGQE3",132,0)
 N I,LCNT,MSG,PKG,PKT,PV
"RTN","MAGQE3",133,0)
 S LCNT=0
"RTN","MAGQE3",134,0)
 F PKG="IMAGING","MAGJ RADIOLOGY" D
"RTN","MAGQE3",135,0)
 . N J,K,L,PKNAM,VERS
"RTN","MAGQE3",136,0)
 . S J=$$FIND1^DIC(9.4,",","MX",PKG) Q:'J
"RTN","MAGQE3",137,0)
 . I PKG="MAGJ RADIOLOGY" D  Q
"RTN","MAGQE3",138,0)
 . . N TAR
"RTN","MAGQE3",139,0)
 . . D LIST^DIC(9.49,","_J_",","@;.01;2;3","","","","","","","","TAR","MSG")
"RTN","MAGQE3",140,0)
 . . Q:$D(MSG("DIERR"))
"RTN","MAGQE3",141,0)
 . . S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQE3",142,0)
 . . . S LCNT=LCNT+1
"RTN","MAGQE3",143,0)
 . . . S PV(LCNT)=PKG_"^P"_$P(TAR("DILIST","ID",L,".01"),"^",1)
"RTN","MAGQE3",144,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$P(TAR("DILIST","ID",L,"2"),"^",1)
"RTN","MAGQE3",145,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$P(TAR("DILIST","ID",L,"3"),"^",1)
"RTN","MAGQE3",146,0)
 . . . Q
"RTN","MAGQE3",147,0)
 . . Q
"RTN","MAGQE3",148,0)
 . K PKT D LIST^DIC(9.49,","_J_",",.01,"","*","","","B","","","PKT","MSG")
"RTN","MAGQE3",149,0)
 . S VERS="" F  S VERS=$O(PKT("DILIST",2,VERS)) Q:VERS=""  S K=PKT("DILIST",2,VERS) D
"RTN","MAGQE3",150,0)
 . . K MSG
"RTN","MAGQE3",151,0)
 . . D LIST^DIC(9.4901,","_K_","_J_",","@;.01;.02;.03","","","","","","","","TAR","MSG")
"RTN","MAGQE3",152,0)
 . . Q:$D(MSG("DIERR"))
"RTN","MAGQE3",153,0)
 . . S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQE3",154,0)
 . . . S LCNT=LCNT+1
"RTN","MAGQE3",155,0)
 . . . S PV(LCNT)=PKG_"^"_VERS_"P"_$P(TAR("DILIST","ID",L,".01"),"^",1)
"RTN","MAGQE3",156,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$P(TAR("DILIST","ID",L,".02"),"^",1)
"RTN","MAGQE3",157,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$P(TAR("DILIST","ID",L,".03"),"^",1)
"RTN","MAGQE3",158,0)
 . . . Q
"RTN","MAGQE3",159,0)
 . . Q
"RTN","MAGQE3",160,0)
 . Q
"RTN","MAGQE3",161,0)
 S I="" F  S I=$O(PV(I)) Q:I=""  D
"RTN","MAGQE3",162,0)
 . D MSG^MAGQE2("IMAGING PACKAGE INSTALLATION HX: "_I_"^"_PV(I))
"RTN","MAGQE3",163,0)
 . Q
"RTN","MAGQE3",164,0)
 Q
"RTN","MAGQE3",165,0)
 ;
"RTN","MAGQE3",166,0)
ADCNT(SDATE,EDATE,INST) ;
"RTN","MAGQE3",167,0)
 ; SAC = Scanned, Administrative Closure
"RTN","MAGQE3",168,0)
 ; SMC = Scanned, Manual Closure
"RTN","MAGQE3",169,0)
 ; UMC = Unscanned, Manual Closure
"RTN","MAGQE3",170,0)
 N ARRY,D0,D1,DATE,DATES,DOC,HLOC,SAC,SCR,SMC,STAT,STATA,STATC,TITLE,TIUDA,UMC
"RTN","MAGQE3",171,0)
 S STATA="^",D0=0 F  S D0=$O(^TIU(8925.6,"B","AMENDED",D0)) Q:'D0  D
"RTN","MAGQE3",172,0)
 . S STATA=STATA_D0_"^"
"RTN","MAGQE3",173,0)
 . Q
"RTN","MAGQE3",174,0)
 S STATC="^",D0=0 F  S D0=$O(^TIU(8925.6,"B","COMPLETED",D0)) Q:'D0  D
"RTN","MAGQE3",175,0)
 . S STATC=STATC_D0_"^"
"RTN","MAGQE3",176,0)
 . Q
"RTN","MAGQE3",177,0)
 S DOC="ADVANCE DIRECTIVE"
"RTN","MAGQE3",178,0)
 S D0=0 F  S D0=$O(^TIU(8925.1,"B",DOC,D0)) Q:'D0  D
"RTN","MAGQE3",179,0)
 . Q:$P($G(^TIU(8925.1,D0,0)),"^",4)'="DC"
"RTN","MAGQE3",180,0)
 . S D1=0 F  S D1=$O(^TIU(8925.1,D0,10,"B",D1)) Q:'D1  D
"RTN","MAGQE3",181,0)
 . . S TITLE=$P($G(^TIU(8925.1,+D1,0)),"^",1) S:TITLE="" TITLE=" "
"RTN","MAGQE3",182,0)
 . . S ARRY(TITLE,D1)=""
"RTN","MAGQE3",183,0)
 . . Q
"RTN","MAGQE3",184,0)
 . Q
"RTN","MAGQE3",185,0)
 S SCR="",(SAC,SMC,UMC)=0
"RTN","MAGQE3",186,0)
 S TITLE="" F  S TITLE=$O(ARRY(TITLE)) Q:TITLE=""  D
"RTN","MAGQE3",187,0)
 . S D1="" F  S D1=$O(ARRY(TITLE,D1)) Q:D1=""  D
"RTN","MAGQE3",188,0)
 . . S TIUDA=0 F  S TIUDA=$O(^TIU(8925,"B",D1,TIUDA)) Q:'TIUDA  D
"RTN","MAGQE3",189,0)
 . . . N MSG,TARGET
"RTN","MAGQE3",190,0)
 . . . S SCR="" ; INSTITIUTION screen for consolidation sites only.
"RTN","MAGQE3",191,0)
 . . . D GETS^DIQ(8925,TIUDA,".05;1205;1501;1507;1603;1606;1613","IE","TARGET","MSG")
"RTN","MAGQE3",192,0)
 . . . Q:$D(MSG("DIERR"))
"RTN","MAGQE3",193,0)
 . . . I $$CONSOLID^MAGQE5() D  Q:SCR
"RTN","MAGQE3",194,0)
 . . . . S HLOC=TARGET(8925,TIUDA_",",1205,"I") ; INSTITIUTION screen - dependent upon TIU*1*113
"RTN","MAGQE3",195,0)
 . . . . I HLOC="" S SCR=1
"RTN","MAGQE3",196,0)
 . . . . E  I $P($G(^SC(HLOC,0)),"^",4)'=INST S SCR=1
"RTN","MAGQE3",197,0)
 . . . . Q
"RTN","MAGQE3",198,0)
 . . . S STAT="^"_TARGET(8925,TIUDA_",",.05,"I")_"^"
"RTN","MAGQE3",199,0)
 . . . Q:STATA_STATC'[STAT
"RTN","MAGQE3",200,0)
 . . . I TARGET(8925,TIUDA_",",1613,"I")="S" D  Q
"RTN","MAGQE3",201,0)
 . . . . Q:TARGET(8925,TIUDA_",",1606,"I")<SDATE
"RTN","MAGQE3",202,0)
 . . . . Q:$P(TARGET(8925,TIUDA_",",1606,"I"),".")>EDATE
"RTN","MAGQE3",203,0)
 . . . . S SAC=SAC+1,SAC(TITLE)=$G(SAC(TITLE))+1
"RTN","MAGQE3",204,0)
 . . . . Q
"RTN","MAGQE3",205,0)
 . . . I STATC[STAT D  Q
"RTN","MAGQE3",206,0)
 . . . . S DATE=TARGET(8925,TIUDA_",",1507,"I")
"RTN","MAGQE3",207,0)
 . . . . S DATE=$S(DATE?1.N:DATE,1:+TARGET(8925,TIUDA_",",1501,"I"))
"RTN","MAGQE3",208,0)
 . . . . Q:DATE<SDATE
"RTN","MAGQE3",209,0)
 . . . . Q:$P(DATE,".")>EDATE
"RTN","MAGQE3",210,0)
 . . . . I $$SCAN(TIUDA) S SMC=SMC+1,SMC(TITLE)=$G(SMC(TITLE))+1 Q
"RTN","MAGQE3",211,0)
 . . . . S UMC=UMC+1,UMC(TITLE)=$G(UMC(TITLE))+1
"RTN","MAGQE3",212,0)
 . . . . Q
"RTN","MAGQE3",213,0)
 . . . I STATA[STAT D  Q
"RTN","MAGQE3",214,0)
 . . . . Q:TARGET(8925,TIUDA_",",1603,"I")<SDATE
"RTN","MAGQE3",215,0)
 . . . . Q:$P(TARGET(8925,TIUDA_",",1603,"I"),".")>EDATE
"RTN","MAGQE3",216,0)
 . . . . I $$SCAN(TIUDA) S SMC=SMC+1,SMC(TITLE)=$G(SMC(TITLE))+1 Q
"RTN","MAGQE3",217,0)
 . . . . S UMC=UMC+1,UMC(TITLE)=$G(UMC(TITLE))+1
"RTN","MAGQE3",218,0)
 . . . . Q
"RTN","MAGQE3",219,0)
 . . . Q
"RTN","MAGQE3",220,0)
 . . Q
"RTN","MAGQE3",221,0)
 . Q
"RTN","MAGQE3",222,0)
 D MSG^MAGQE2(DOC_" SCANNED ADMINISTRATIVE CLOSURE: "_SAC)
"RTN","MAGQE3",223,0)
 S TITLE="" F  S TITLE=$O(SAC(TITLE)) Q:TITLE=""  D
"RTN","MAGQE3",224,0)
 . D MSG^MAGQE2(DOC_" - SAC - "_TITLE_": "_SAC(TITLE))
"RTN","MAGQE3",225,0)
 . Q
"RTN","MAGQE3",226,0)
 D MSG^MAGQE2(DOC_" UNSCANNED MANUAL CLOSURE: "_UMC)
"RTN","MAGQE3",227,0)
 S TITLE="" F  S TITLE=$O(UMC(TITLE)) Q:TITLE=""  D
"RTN","MAGQE3",228,0)
 . D MSG^MAGQE2(DOC_" - UMC - "_TITLE_": "_UMC(TITLE))
"RTN","MAGQE3",229,0)
 . Q
"RTN","MAGQE3",230,0)
 D MSG^MAGQE2(DOC_" SCANNED MANUAL CLOSURE: "_SMC)
"RTN","MAGQE3",231,0)
 S TITLE="" F  S TITLE=$O(SMC(TITLE)) Q:TITLE=""  D
"RTN","MAGQE3",232,0)
 . D MSG^MAGQE2(DOC_" - SMC - "_TITLE_": "_SMC(TITLE))
"RTN","MAGQE3",233,0)
 . Q
"RTN","MAGQE3",234,0)
 Q
"RTN","MAGQE3",235,0)
 ;
"RTN","MAGQE3",236,0)
SCAN(IEN) ;
"RTN","MAGQE3",237,0)
 N LINK
"RTN","MAGQE3",238,0)
 S LINK=$O(^TIU(8925.91,"B",IEN,"")) Q:'LINK 0
"RTN","MAGQE3",239,0)
 Q $S($P($G(^TIU(8925.1,LINK,0)),"^",2)?1.N:0,1:1)
"RTN","MAGQE3",240,0)
 ;
"RTN","MAGQE4")
0^27^B12918669
"RTN","MAGQE4",1,0)
MAGQE4 ;WOIFO/RMP - Support for MAG Enterprise ; 05/06/2004  06:32
"RTN","MAGQE4",2,0)
 ;;3.0;IMAGING;**27,29,30**;16-September-2004
"RTN","MAGQE4",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE4",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQE4",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQE4",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQE4",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQE4",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQE4",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQE4",10,0)
 ;; |                                                               |
"RTN","MAGQE4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQE4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQE4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQE4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQE4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQE4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE4",17,0)
 ;;
"RTN","MAGQE4",18,0)
 Q
"RTN","MAGQE4",19,0)
 ;
"RTN","MAGQE4",20,0)
TASK ;Re-task the job
"RTN","MAGQE4",21,0)
 N DA,DIE,DR,I,MAGTSK,X,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","MAGQE4",22,0)
 ; First clean up any entries that might already be there
"RTN","MAGQE4",23,0)
 D RTN^%ZTLOAD("ISU^MAGQE2","MAGTSK")
"RTN","MAGQE4",24,0)
 ; EdM: Note: The above procedure only returns tasks submitted
"RTN","MAGQE4",25,0)
 ;      with the DUZ of the current requestor, unless...:
"RTN","MAGQE4",26,0)
 ;      When $D(^XUSEC("ZTMQ",DUZ))>0,
"RTN","MAGQE4",27,0)
 ;      tasks with other DUZs are reported as well.
"RTN","MAGQE4",28,0)
 S I=0 F  S I=$O(MAGTSK(I)) Q:'I  D
"RTN","MAGQE4",29,0)
 . N ZTSK
"RTN","MAGQE4",30,0)
 . S ZTSK=I D KILL^%ZTLOAD
"RTN","MAGQE4",31,0)
 . Q
"RTN","MAGQE4",32,0)
 ; Then queue up the next report for 2nd day of the next month
"RTN","MAGQE4",33,0)
 S ZTDTH=$$NOW^XLFDT()\100+1 S:(ZTDTH#100)>12 ZTDTH=ZTDTH+88
"RTN","MAGQE4",34,0)
 S ZTDTH=ZTDTH_"02.040101"
"RTN","MAGQE4",35,0)
 S ZTRTN="ISU^MAGQE2",ZTDESC="Site Imaging Utilization report",ZTIO=""
"RTN","MAGQE4",36,0)
 S:$D(MAGDUZ) ZTSAVE("MAGDUZ")=MAGDUZ
"RTN","MAGQE4",37,0)
 D ^%ZTLOAD
"RTN","MAGQE4",38,0)
 ; Record the task number in the Site Parameter Table
"RTN","MAGQE4",39,0)
 S DA=$S($T(PLACE^MAGBAPI)'="":$$PLACE^MAGBAPI($$MAGDUZ2^MAGQE5()),1:1)
"RTN","MAGQE4",40,0)
 S DIE="^MAG(2006.1,",DR="10///^S X=ZTSK" D ^DIE
"RTN","MAGQE4",41,0)
 Q
"RTN","MAGQE4",42,0)
 ;
"RTN","MAGQE4",43,0)
STTASK ; Start the Imaging task report
"RTN","MAGQE4",44,0)
 N DAYS,MAGDUZ,MCON,REC,TASK,ZTSK
"RTN","MAGQE4",45,0)
 S REC=$$PLACE^MAGQE5($$MAGDUZ2^MAGQE5()) Q:'$D(^MAG(2006.1,REC))
"RTN","MAGQE4",46,0)
 S TASK=$P($G(^MAG(2006.1,REC,1)),"^",7)
"RTN","MAGQE4",47,0)
 I TASK'="" D  Q:TASK'=""
"RTN","MAGQE4",48,0)
 . S ZTSK=TASK D STAT^%ZTLOAD
"RTN","MAGQE4",49,0)
 . I ZTSK(0)=0 S TASK=""
"RTN","MAGQE4",50,0)
 . E  W:$G(XQY0)["MAG" !,"Task is already running"
"RTN","MAGQE4",51,0)
 . Q
"RTN","MAGQE4",52,0)
 S MCON="",MAGDUZ=DUZ,DAYS=1
"RTN","MAGQE4",53,0)
 D RESTASK ; Also called from elsewhere
"RTN","MAGQE4",54,0)
 Q
"RTN","MAGQE4",55,0)
 ;
"RTN","MAGQE4",56,0)
RESTASK ; Restart the Imaging task report
"RTN","MAGQE4",57,0)
 N DA,DIC,DIE,DR,ZTDESC,ZTIO,ZTRTN,ZTSAVE
"RTN","MAGQE4",58,0)
 S ZTRTN="ISU^MAGQE2",ZTDESC="Site Imaging Utilization report",ZTIO=""
"RTN","MAGQE4",59,0)
 S:$D(MAGDUZ) ZTSAVE("MAGDUZ")=MAGDUZ
"RTN","MAGQE4",60,0)
 S ZTDTH=$$NOW^XLFDT()\100+1 S:(ZTDTH#100)>12 ZTDTH=ZTDTH+88
"RTN","MAGQE4",61,0)
 S ZTDTH=ZTDTH_"02.040101"
"RTN","MAGQE4",62,0)
 D ^%ZTLOAD
"RTN","MAGQE4",63,0)
 S DIE="^MAG(2006.1,",DA=$$PLACE^MAGQE5($$MAGDUZ2^MAGQE5()),DR="10///^S X=ZTSK" D ^DIE
"RTN","MAGQE4",64,0)
 W:$G(XQY0)["MAG" !,"Task is started. To remove task execute option MAGREPSTOP"
"RTN","MAGQE4",65,0)
 K MCDUZ
"RTN","MAGQE4",66,0)
 Q
"RTN","MAGQE4",67,0)
 ;
"RTN","MAGQE4",68,0)
REMTASK ;Remove the Imaging Task Report
"RTN","MAGQE4",69,0)
 N DA,DIE,DR,FIND,REC,TASK,ZTSK
"RTN","MAGQE4",70,0)
 S REC=$$PLACE^MAGQE5($$MAGDUZ2^MAGQE5())
"RTN","MAGQE4",71,0)
 S TASK=$P($G(^MAG(2006.1,REC,1)),"^",7)
"RTN","MAGQE4",72,0)
 I TASK D  Q
"RTN","MAGQE4",73,0)
 . S DIE="^MAG(2006.1,",DA=REC,DR="10///@" D ^DIE
"RTN","MAGQE4",74,0)
 . S ZTSK=TASK D KILL^%ZTLOAD
"RTN","MAGQE4",75,0)
 . Q:$G(XQY0)'["MAG"
"RTN","MAGQE4",76,0)
 . I ZTSK(0)=1 W !,"Task is removed.  To restart execute option MAGREPSTART"
"RTN","MAGQE4",77,0)
 . E  W !,"Could not stop task or task was no longer active."
"RTN","MAGQE4",78,0)
 . Q
"RTN","MAGQE4",79,0)
 I $G(XQY0)["MAG" W !,"No task to stop."
"RTN","MAGQE4",80,0)
 Q
"RTN","MAGQE4",81,0)
 ;
"RTN","MAGQE4",82,0)
UPPER(X) ;
"RTN","MAGQE4",83,0)
 Q $TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGQE4",84,0)
 ;
"RTN","MAGQE5")
0^28^B37769146
"RTN","MAGQE5",1,0)
MAGQE5 ;WOIFO/RMP - Support for MAG Enterprise ; 05/06/2004  06:32
"RTN","MAGQE5",2,0)
 ;;3.0;IMAGING;**27,29,8,30**;16-September-2004
"RTN","MAGQE5",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE5",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQE5",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQE5",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQE5",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQE5",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQE5",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQE5",10,0)
 ;; |                                                               |
"RTN","MAGQE5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQE5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQE5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQE5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQE5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQE5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQE5",17,0)
 ;;
"RTN","MAGQE5",18,0)
ISU2 ;
"RTN","MAGQE5",19,0)
 ; Workstation Session and Patient counts
"RTN","MAGQE5",20,0)
 N CCNT,D0,DATE,ICNT,M1,M2,PCNT,RES,SCNAD,SCNMN,SCNT,TD,TD1,UNSCN,VD,VI,X1,X2,YR
"RTN","MAGQE5",21,0)
 S (SCNT,PCNT,ICNT,CCNT)=0
"RTN","MAGQE5",22,0)
 S (VD,VI)=""
"RTN","MAGQE5",23,0)
 I '$$CONSOLID() D
"RTN","MAGQE5",24,0)
 . S DATE="L"_START
"RTN","MAGQE5",25,0)
 . F  S DATE=$O(^MAG(2006.82,"AC",DATE)) Q:DATE=""  Q:$P(DATE,"L",2)\1>STOP  D
"RTN","MAGQE5",26,0)
 . . S D0=0 F  S D0=$O(^MAG(2006.82,"AC",DATE,D0)) Q:'D0  D
"RTN","MAGQE5",27,0)
 . . . Q:'$D(^MAG(2006.82,D0,1))
"RTN","MAGQE5",28,0)
 . . . S SCNT=SCNT+1
"RTN","MAGQE5",29,0)
 . . . S PCNT=PCNT+$P($G(^MAG(2006.82,D0,1)),"^",1)
"RTN","MAGQE5",30,0)
 . . . D ACT^MAGQE3(D0,.ICNT,.CCNT,.VD,.VI,.RES)
"RTN","MAGQE5",31,0)
 . . . Q
"RTN","MAGQE5",32,0)
 . . Q
"RTN","MAGQE5",33,0)
 . Q
"RTN","MAGQE5",34,0)
 E  D
"RTN","MAGQE5",35,0)
 . S DATE=START
"RTN","MAGQE5",36,0)
 . F  S DATE=$O(^MAG(2006.82,"APL",PLACE,DATE)) Q:DATE=""  Q:DATE\1>STOP  D
"RTN","MAGQE5",37,0)
 . . S D0=0 F  S D0=$O(^MAG(2006.82,"APL",PLACE,DATE,D0)) Q:D0'?1.N  D
"RTN","MAGQE5",38,0)
 . . . Q:'$D(^MAG(2006.82,D0,1))
"RTN","MAGQE5",39,0)
 . . . S SCNT=SCNT+1
"RTN","MAGQE5",40,0)
 . . . S PCNT=PCNT+$P($G(^MAG(2006.82,D0,1)),"^",1)
"RTN","MAGQE5",41,0)
 . . . D ACT^MAGQE3(D0,.ICNT,.CCNT,.VD,.VI,.RES)
"RTN","MAGQE5",42,0)
 . . . Q
"RTN","MAGQE5",43,0)
 . . Q
"RTN","MAGQE5",44,0)
 . Q
"RTN","MAGQE5",45,0)
 S X1=START,X2=STOP D ^%DTC S X=$TR(X,"-")+1_" day "
"RTN","MAGQE5",46,0)
 D MSG^MAGQE2(X_"Image Workstation Sessions: "_SCNT)
"RTN","MAGQE5",47,0)
 D MSG^MAGQE2(X_"Image Workstation Patients: "_PCNT)
"RTN","MAGQE5",48,0)
 D MSG^MAGQE2(X_"Image Workstation Images: "_ICNT)
"RTN","MAGQE5",49,0)
 D MSG^MAGQE2(X_"Image Workstation Captures: "_CCNT)
"RTN","MAGQE5",50,0)
 D MSG^MAGQE2(X_"VistaRad WS Display: "_VD)
"RTN","MAGQE5",51,0)
 D MSG^MAGQE2(X_"VistaRad WS Interpretations: "_VI)
"RTN","MAGQE5",52,0)
 K VD,VI
"RTN","MAGQE5",53,0)
 I $T(AVERAGE^MAGBRTLD)'="" D
"RTN","MAGQE5",54,0)
 . D MSG^MAGQE2(X_"average daily routed images: "_$$AVERAGE^MAGBRTLD())
"RTN","MAGQE5",55,0)
 . Q
"RTN","MAGQE5",56,0)
 D BPV^MAGQE1(PLACE)
"RTN","MAGQE5",57,0)
 D MSG^MAGQE2("Vista Image Version/Build: "_$$VSTAV^MAGQE1())
"RTN","MAGQE5",58,0)
 D DICOMV^MAGQE1()
"RTN","MAGQE5",59,0)
 D MSG^MAGQE2("Image file namespace(s): "_$$SNS^MAGQE1(PLACE))
"RTN","MAGQE5",60,0)
 S I="" F  S I=$O(RES(I)) Q:I=""  D
"RTN","MAGQE5",61,0)
 . S RES="" F  S RES=$O(RES(I,RES)) Q:RES=""  D
"RTN","MAGQE5",62,0)
 . . S X=$TR(I,"^")_"^"_RES S $P(X,"^",6)=RES(I,RES)
"RTN","MAGQE5",63,0)
 . . D MSG^MAGQE2(" RESOLUTION: "_X)
"RTN","MAGQE5",64,0)
 . . Q
"RTN","MAGQE5",65,0)
 . Q
"RTN","MAGQE5",66,0)
 K RES
"RTN","MAGQE5",67,0)
 ;
"RTN","MAGQE5",68,0)
 D COUNT^MAGQE3(START,STOP,INST)
"RTN","MAGQE5",69,0)
 ;
"RTN","MAGQE5",70,0)
 S (I,D0)=0 F  S D0=$O(^TMP($J,"MAGQ","ACQPAT",D0)) Q:D0=""  S I=I+1
"RTN","MAGQE5",71,0)
 D MSG^MAGQE2("Unique Image patients captured: "_I)
"RTN","MAGQE5",72,0)
 K ^TMP($J,"MAGQ","ACQPAT")
"RTN","MAGQE5",73,0)
 S (I,D0)=0 F  S D0=$O(^TMP($J,"MAGQ","DISPAT",D0)) Q:D0=""  S I=I+1
"RTN","MAGQE5",74,0)
 D MSG^MAGQE2("Unique Image patients display: "_I)
"RTN","MAGQE5",75,0)
 K ^TMP($J,"MAGQ","DISPAT")
"RTN","MAGQE5",76,0)
 S (I,D0)=0 F  S D0=$O(^TMP($J,"MAGQ","ALLPAT",D0)) Q:D0=""  S I=I+1
"RTN","MAGQE5",77,0)
 D MSG^MAGQE2("Unique Image patients All: "_I)
"RTN","MAGQE5",78,0)
 K ^TMP($J,"MAGQ","ALLPAT")
"RTN","MAGQE5",79,0)
 ;
"RTN","MAGQE5",80,0)
 D ADCNT^MAGQE3(START,STOP,INST)
"RTN","MAGQE5",81,0)
 D GPACHX^MAGQE3()
"RTN","MAGQE5",82,0)
 D GS1^MAGQE5() ;Get Share data
"RTN","MAGQE5",83,0)
 Q
"RTN","MAGQE5",84,0)
 ;
"RTN","MAGQE5",85,0)
AHOPT ;
"RTN","MAGQE5",86,0)
 N %DT,START,STOP
"RTN","MAGQE5",87,0)
 S STOP=$$FMADD^XLFDT($$NOW^XLFDT()\100_"01",-1)
"RTN","MAGQE5",88,0)
 S START=STOP\100_"01"
"RTN","MAGQE5",89,0)
 S Y=START D DD^%DT S %DT("B")=Y
"RTN","MAGQE5",90,0)
 S %DT="AEXP",%DT("A")="Enter starting Date: "
"RTN","MAGQE5",91,0)
 D ^%DT I ((X="")!(X="^")!($D(DTOUT))) K %DT(0) Q
"RTN","MAGQE5",92,0)
 S START=Y
"RTN","MAGQE5",93,0)
 S Y=STOP D DD^%DT S %DT("B")=Y
"RTN","MAGQE5",94,0)
 S %DT="AEXP",%DT("A")="Enter ending Date: "
"RTN","MAGQE5",95,0)
 D ^%DT I ((X="")!(X="^")!($D(DTOUT))) K %DT(0) Q
"RTN","MAGQE5",96,0)
 S STOP=Y
"RTN","MAGQE5",97,0)
 W !!,"Creating ad-hoc report over the period "
"RTN","MAGQE5",98,0)
 W $$DT(START)," until ",$$DT(STOP),".",!
"RTN","MAGQE5",99,0)
 D AHISU^MAGQE2(START,STOP)
"RTN","MAGQE5",100,0)
 Q
"RTN","MAGQE5",101,0)
 ;
"RTN","MAGQE5",102,0)
DT(X) ;
"RTN","MAGQE5",103,0)
 Q (X\1#100)_"-"_$P("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"," ",X\100#100)_"-"_(X\10000+1700)
"RTN","MAGQE5",104,0)
 ;
"RTN","MAGQE5",105,0)
LLOAD(AR,LBL) ;
"RTN","MAGQE5",106,0)
 N I
"RTN","MAGQE5",107,0)
 S I="" F  S I=$O(AR(I)) Q:I=""  D MSG^MAGQE2(" "_LBL_" "_I_"^"_AR(I))
"RTN","MAGQE5",108,0)
 Q
"RTN","MAGQE5",109,0)
 ;
"RTN","MAGQE5",110,0)
GETPLACE(PLACE) ; Validate place
"RTN","MAGQE5",111,0)
 S PLACE=$S($$CONSOLID():$G(PLACE),1:+$O(^MAG(2006.1," "),-1)) Q:'PLACE 0
"RTN","MAGQE5",112,0)
 S:$P($G(^MAG(2006.1,PLACE,0)),"^",1)="" PLACE=0
"RTN","MAGQE5",113,0)
 Q PLACE
"RTN","MAGQE5",114,0)
 ;
"RTN","MAGQE5",115,0)
CONSOLID() ;
"RTN","MAGQE5",116,0)
 ; Return value: 0 = site not consolidated,
"RTN","MAGQE5",117,0)
 ;               1 = site is consolidated
"RTN","MAGQE5",118,0)
 N FLDNFO
"RTN","MAGQE5",119,0)
 D FIELD^DID(2006.1,.01,"","SPECIFIER","FLDNFO")
"RTN","MAGQE5",120,0)
 I $G(FLDNFO("SPECIFIER"))["P" Q 1
"RTN","MAGQE5",121,0)
 Q 0
"RTN","MAGQE5",122,0)
 ;
"RTN","MAGQE5",123,0)
PLACE(INST) ;
"RTN","MAGQE5",124,0)
 Q:'$$CONSOLID() +$O(^MAG(2006.1," "),-1)
"RTN","MAGQE5",125,0)
 Q $$GETPLACE(+$O(^MAG(2006.1,"B",INST,"")))
"RTN","MAGQE5",126,0)
 ;
"RTN","MAGQE5",127,0)
QCNT(READY,PLACE) ;
"RTN","MAGQE5",128,0)
 N D0,FAILED,NEXT,TYPE
"RTN","MAGQE5",129,0)
 S (READY,FAILED)=0
"RTN","MAGQE5",130,0)
 I $$CONSOLID() D
"RTN","MAGQE5",131,0)
 . S TYPE="" F  S TYPE=$O(^MAGQUEUE(2006.031,"C",PLACE,TYPE)) Q:TYPE=""  D
"RTN","MAGQE5",132,0)
 . . S NEXT=+$O(^MAGQUEUE(2006.031,"C",PLACE,TYPE,""))
"RTN","MAGQE5",133,0)
 . . S NEXT=+$P($G(^MAGQUEUE(2006.031,NEXT,0)),"^",2)
"RTN","MAGQE5",134,0)
 . . S D0=0 F  S D0=$O(^MAGQUEUE(2006.03,"C",PLACE,TYPE,D0)) Q:'D0  D
"RTN","MAGQE5",135,0)
 . . . I D0<NEXT S FAILED=FAILED+1
"RTN","MAGQE5",136,0)
 . . . E  S READY=READY+1
"RTN","MAGQE5",137,0)
 . . . Q
"RTN","MAGQE5",138,0)
 . . Q
"RTN","MAGQE5",139,0)
 E  D
"RTN","MAGQE5",140,0)
 . S TYPE="" F  S TYPE=$O(^MAGQUEUE(2006.031,"B",TYPE)) Q:TYPE=""  D
"RTN","MAGQE5",141,0)
 . . S NEXT=+$O(^MAGQUEUE(2006.031,"B",TYPE,""))
"RTN","MAGQE5",142,0)
 . . S NEXT=+$P($G(^MAGQUEUE(2006.031,NEXT,0)),"^",2)
"RTN","MAGQE5",143,0)
 . . S D0=0 F  S D0=$O(^MAGQUEUE(2006.03,"B",TYPE,D0)) Q:'D0  D
"RTN","MAGQE5",144,0)
 . . . I D0<NEXT S FAILED=FAILED+1
"RTN","MAGQE5",145,0)
 . . . E  S READY=READY+1
"RTN","MAGQE5",146,0)
 . . . Q
"RTN","MAGQE5",147,0)
 . . Q
"RTN","MAGQE5",148,0)
 . Q
"RTN","MAGQE5",149,0)
 Q READY+FAILED
"RTN","MAGQE5",150,0)
 ;
"RTN","MAGQE5",151,0)
WSP(PLACE) ; Imaging workstations per place
"RTN","MAGQE5",152,0)
 N COUNT,D0,RD
"RTN","MAGQE5",153,0)
 S RD=$$FMADD^XLFDT($$NOW^XLFDT,-180,"","","")
"RTN","MAGQE5",154,0)
 S (D0,COUNT)=0 F  S D0=$O(^MAG(2006.81,"C",PLACE,D0)) Q:'D0  D
"RTN","MAGQE5",155,0)
 . S:$P(^MAG(2006.81,D0,0),"^",3)'<RD COUNT=COUNT+1
"RTN","MAGQE5",156,0)
 . Q
"RTN","MAGQE5",157,0)
 Q COUNT
"RTN","MAGQE5",158,0)
 ;
"RTN","MAGQE5",159,0)
MAGDUZ2() Q $G(DUZ(2),$$KSP^XUPARAM("INST"))
"RTN","MAGQE5",160,0)
 ;
"RTN","MAGQE5",161,0)
GS1() ; Get local Network location share data
"RTN","MAGQE5",162,0)
 N I,L,M,MSG,RESULT,TAR
"RTN","MAGQE5",163,0)
 S RESULT(0)="NETWORK LOCATION^PHYSICAL REFERENCE^TOTAL SPACE^SPACE USED^FREE SPACE^OPERATIONAL STATUS^STORAGE TYPE^HASH"
"RTN","MAGQE5",164,0)
 D LIST^DIC(2005.2,"","@;.01;1;2;3;4;5;6;7","","","","","","","","TAR","MSG")
"RTN","MAGQE5",165,0)
 Q:$D(MSG("DIERR"))
"RTN","MAGQE5",166,0)
 S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQE5",167,0)
 . S RESULT(L)=$P(TAR("DILIST","ID",L,.01),U,1)
"RTN","MAGQE5",168,0)
 . F M=1,2,3,4,5,6,7 S RESULT(L)=RESULT(L)_U_$P(TAR("DILIST","ID",L,M),U,1)
"RTN","MAGQE5",169,0)
 . Q
"RTN","MAGQE5",170,0)
 S I="" F  S I=$O(RESULT(I)) Q:I=""  D
"RTN","MAGQE5",171,0)
 . D MSG^MAGQE2("LOCAL NETWORK LOCATIONS: "_I_"^"_RESULT(I))
"RTN","MAGQE5",172,0)
 . Q
"RTN","MAGQE5",173,0)
 Q
"RTN","MAGQE5",174,0)
 ;
"RTN","MAGQST")
0^29^B13256864
"RTN","MAGQST",1,0)
MAGQST ;WOIFO/DCB,RMP-SERVER TASKS [ 06/20/2001 08:57 ] ; 05/06/2004  06:32
"RTN","MAGQST",2,0)
 ;;3.0;IMAGING;**7,29,30**;16-September-2004
"RTN","MAGQST",3,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQST",4,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQST",5,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQST",6,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQST",7,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQST",8,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQST",9,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQST",10,0)
 ;; |                                                               |
"RTN","MAGQST",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQST",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQST",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQST",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQST",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQST",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQST",17,0)
 ;;
"RTN","MAGQST",18,0)
 Q
"RTN","MAGQST",19,0)
 ;
"RTN","MAGQST",20,0)
RESTASK D RESTASK^MAGQE4 Q
"RTN","MAGQST",21,0)
STTASK D STTASK^MAGQE4 Q
"RTN","MAGQST",22,0)
REMTASK D REMTASK^MAGQE4 Q
"RTN","MAGQST",23,0)
 ;
"RTN","MAGQST",24,0)
CHECK ;Check to see if the task is running
"RTN","MAGQST",25,0)
 N REC,TASK,ZTSK
"RTN","MAGQST",26,0)
 S REC=$S($T(PLACE^MAGBAPI)'="":$$PLACE^MAGBAPI(DUZ(2)),1:1)
"RTN","MAGQST",27,0)
 S TASK=$P($G(^MAG(2006.1,REC,1)),U,7) Q:TASK=""
"RTN","MAGQST",28,0)
 S ZTSK=TASK D STAT^%ZTLOAD
"RTN","MAGQST",29,0)
 D:ZTSK(0)=0 RESTASK^MAGQE4
"RTN","MAGQST",30,0)
 Q
"RTN","MAGQST",31,0)
 ;
"RTN","MAGQST",32,0)
POST ;
"RTN","MAGQST",33,0)
 D REMTASK^MAGQE4,STTASK^MAGQE4
"RTN","MAGQST",34,0)
 D INS^MAGQST(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGQST",35,0)
 D POSTI^MAGQBUT ;
"RTN","MAGQST",36,0)
 Q
"RTN","MAGQST",37,0)
 ;
"RTN","MAGQST",38,0)
ENHS ;Enable Health Summary Component
"RTN","MAGQST",39,0)
PRE ; REMOVE SITE 2006.19 ENTRIES SO THAT THEY CAN BE REPLACED
"RTN","MAGQST",40,0)
 ; THE "ID" NODE ON FIELD .2 MAKES CHANGING THEM DIFFICULT
"RTN","MAGQST",41,0)
 ;We require a DUZ(0)="@" for installer S DUZ(0)="@"
"RTN","MAGQST",42,0)
 N INDX
"RTN","MAGQST",43,0)
 S INDX=0 F  S INDX=$O(^MAG(2006.19,INDX)) Q:'INDX  D
"RTN","MAGQST",44,0)
 . N DA,DIE,DR
"RTN","MAGQST",45,0)
 . S DIE=2006.19,DA=INDX,DR=".01///@"
"RTN","MAGQST",46,0)
 . D ^DIE
"RTN","MAGQST",47,0)
 . Q
"RTN","MAGQST",48,0)
 Q
"RTN","MAGQST",49,0)
 ;
"RTN","MAGQST",50,0)
NUMBER(VAL,SP) ;
"RTN","MAGQST",51,0)
 Q $J($FN(VAL,",",0),SP)
"RTN","MAGQST",52,0)
 ;
"RTN","MAGQST",53,0)
INS(XP,DUZ,DATE,IDA) ;
"RTN","MAGQST",54,0)
 N ST,CT,DDATE
"RTN","MAGQST",55,0)
 D GETENV^%ZOSV
"RTN","MAGQST",56,0)
 K ^TMP($J,"MAGQ")
"RTN","MAGQST",57,0)
 S ^TMP($J,"MAGQ",1)="PACKAGE INSTALL"
"RTN","MAGQST",58,0)
 S ^TMP($J,"MAGQ",2)="SITE: "_$$KSP^XUPARAM("WHERE")
"RTN","MAGQST",59,0)
 S ^TMP($J,"MAGQ",3)="PACKAGE: "_XP
"RTN","MAGQST",60,0)
 S ^TMP($J,"MAGQ",4)="Version: "_$$VER^XPDUTL(XP)
"RTN","MAGQST",61,0)
 S ST=$$GET1^DIQ(9.7,IDA,11,"I")
"RTN","MAGQST",62,0)
 S ^TMP($J,"MAGQ",5)="Start time: "_$$FMTE^XLFDT(ST)
"RTN","MAGQST",63,0)
 S CT=$$GET1^DIQ(9.7,IDA,17,"I")
"RTN","MAGQST",64,0)
 S ^TMP($J,"MAGQ",6)="Completion time: "_$$FMTE^XLFDT(CT)
"RTN","MAGQST",65,0)
 S ^TMP($J,"MAGQ",7)="Run time: "_$$FMDIFF^XLFDT(CT,ST,3)
"RTN","MAGQST",66,0)
 S ^TMP($J,"MAGQ",8)="Environment: "_Y
"RTN","MAGQST",67,0)
 S ^TMP($J,"MAGQ",9)="DATE: "_DATE
"RTN","MAGQST",68,0)
 S ^TMP($J,"MAGQ",10)="Installed by: "_$$GET1^DIQ(9.7,IDA,9,"E")
"RTN","MAGQST",69,0)
 S ^TMP($J,"MAGQ",11)="Install Name: "_$$GET1^DIQ(9.7,IDA,.01,"E")
"RTN","MAGQST",70,0)
 S DDATE=$$GET1^DIQ(9.7,IDA,51,"I")
"RTN","MAGQST",71,0)
 S ^TMP($J,"MAGQ",11)="Distribution Date: "_$$FMTE^XLFDT(DDATE)
"RTN","MAGQST",72,0)
 S XMSUB="MAG "_XP_" INSTALLATION"
"RTN","MAGQST",73,0)
 D MAILSHR^MAGUSIT
"RTN","MAGQST",74,0)
 K ^TMP($J,"MAGQ")
"RTN","MAGQST",75,0)
 Q
"RTN","MAGQST",76,0)
 ;
"RTN","MAGQST",77,0)
TQ ; Test Queue functionality
"RTN","MAGQST",78,0)
 N CNT,RESULT
"RTN","MAGQST",79,0)
 S CNT=1,RESULT="" K ^TMP("MAGQ",$J)
"RTN","MAGQST",80,0)
 F  D GETQUE^MAGQBTM(.RESULT,"JBTOHD") S CNT=CNT+1 Q:CNT>200  D
"RTN","MAGQST",81,0)
 . S ^TMP("MAGQ",$J,CNT)=RESULT
"RTN","MAGQST",82,0)
 . Q
"RTN","MAGQST",83,0)
 Q
"RTN","MAGQST",84,0)
 ;
"RTN","MAGQST",85,0)
UPPER(X) ;
"RTN","MAGQST",86,0)
 Q $TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGQST",87,0)
 ;
"RTN","MAGQST",88,0)
TRIM(X) ; remove both leading and trailing blanks
"RTN","MAGQST",89,0)
 N I,J
"RTN","MAGQST",90,0)
 F I=1:1:$L(X) Q:$E(X,I)'=" "
"RTN","MAGQST",91,0)
 F J=$L(X):-1:I Q:$E(X,J)'=" "
"RTN","MAGQST",92,0)
 Q $S($E(X,I,J)=" ":"",1:$E(X,I,J))
"RTN","MAGQST",93,0)
 ;
"RTN","MAGQST",94,0)
CHKTSK(RTN) ;
"RTN","MAGQST",95,0)
 N ARR,I,BOOL
"RTN","MAGQST",96,0)
 S ARR="MAGCT",BOOL=0,I=""
"RTN","MAGQST",97,0)
 K @ARR
"RTN","MAGQST",98,0)
 D RTN^%ZTLOAD(RTN,ARR)
"RTN","MAGQST",99,0)
 I $D(@ARR) D
"RTN","MAGQST",100,0)
 . F  S I=$O(@ARR@(I)) Q:I'?1N.N  D  Q:BOOL
"RTN","MAGQST",101,0)
 . . S ZTSK=I D ISQED^%ZTLOAD S BOOL=ZTSK(0)
"RTN","MAGQST",102,0)
 Q BOOL
"RTN","MAGQST",103,0)
 ;
"VER")
8.0^22.0
"^DD",2006.1,2006.1,126,0)
LAST ROUTING ACTIVITY^D^^LASTROUTE;1^S %DT="EX" D ^%DT S X=Y K:Y<1 X
"^DD",2006.1,2006.1,126,3)
Enter the date when routing was last active.
"^DD",2006.1,2006.1,126,21,0)
^^5^5^3040603^
"^DD",2006.1,2006.1,126,21,1,0)
The value of this field is a date (FileMan format, date only,
"^DD",2006.1,2006.1,126,21,2,0)
no time). This value indicates the most recent date
"^DD",2006.1,2006.1,126,21,3,0)
on which any routing activity took place at the current site.
"^DD",2006.1,2006.1,126,21,4,0)
 
"^DD",2006.1,2006.1,126,21,5,0)
Routing activity can be either Rule Evaluation or Image Transmission.
"^DD",2006.1,2006.1,126,"DT")
3040603
"^DD",2006.1,2006.1,127,0)
LAST ROUTING CHECK^D^^LASTROUTE;2^S %DT="EX" D ^%DT S X=Y K:Y<1 X
"^DD",2006.1,2006.1,127,3)
Enter the date when routing activity was most recently checked.
"^DD",2006.1,2006.1,127,21,0)
^^4^4^3040603^
"^DD",2006.1,2006.1,127,21,1,0)
The value of this field is a date (FileMan format, date only,
"^DD",2006.1,2006.1,127,21,2,0)
no time part). This value indicates the most recent date
"^DD",2006.1,2006.1,127,21,3,0)
on which a check was performed whether or not Routing is
"^DD",2006.1,2006.1,127,21,4,0)
still active at the current site.
"^DD",2006.1,2006.1,127,"DT")
3040603
"^DD",2006.575,2006.575,36,0)
GATEWAY PLACE^P4'^DIC(4,^1;5^Q
"^DD",2006.575,2006.575,36,3)
Identify the institution where the gateway is located.
"^DD",2006.575,2006.575,36,21,0)
^.001^1^1^3040609^^
"^DD",2006.575,2006.575,36,21,1,0)
This field will contain the institution where the gateway is located.
"^DD",2006.575,2006.575,36,"DT")
3040609
**END**
**END**


****
****

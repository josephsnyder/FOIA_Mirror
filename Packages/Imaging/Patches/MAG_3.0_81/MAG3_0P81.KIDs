KIDS Distribution saved on May 23, 2007@12:44:42
Vista Imaging - 3.0 - P81
**KIDS**:MAG*3.0*81^

**INSTALL NAME**
MAG*3.0*81
"BLD",5032,0)
MAG*3.0*81^IMAGING^0^3070523^y
"BLD",5032,1,0)
^^9^9^3070517^
"BLD",5032,1,1,0)
Select BUILD NAME:    MAG*3.0*81     IMAGING
"BLD",5032,1,2,0)
MAGIP81   value = 4894048
"BLD",5032,1,3,0)
MAGQBPG1  value = 76244753
"BLD",5032,1,4,0)
MAGQBPRG  value = 57300845
"BLD",5032,1,5,0)
MAGQBTM   value = 79858508
"BLD",5032,1,6,0)
MAGQBUT1  value = 76309021
"BLD",5032,1,7,0)
MAGQBUT2  value = 55361113
"BLD",5032,1,8,0)
MAGQBUT4  value = 78049028
"BLD",5032,1,9,0)
MAGQBUT5  value = 15869460
"BLD",5032,4,0)
^9.64PA^^0
"BLD",5032,"ABNS",0)
^9.66A^^
"BLD",5032,"ABPKG")
n^n
"BLD",5032,"INI")
PRE^MAGIP81
"BLD",5032,"INID")
^y^n
"BLD",5032,"INIT")
POST^MAGIP81
"BLD",5032,"KRN",0)
^9.67PA^8989.52^19
"BLD",5032,"KRN",.4,0)
.4
"BLD",5032,"KRN",.4,"NM",0)
^9.68A^^
"BLD",5032,"KRN",.401,0)
.401
"BLD",5032,"KRN",.401,"NM",0)
^9.68A^^
"BLD",5032,"KRN",.402,0)
.402
"BLD",5032,"KRN",.402,"NM",0)
^9.68A^^
"BLD",5032,"KRN",.403,0)
.403
"BLD",5032,"KRN",.403,"NM",0)
^9.68A^^
"BLD",5032,"KRN",.5,0)
.5
"BLD",5032,"KRN",.5,"NM",0)
^9.68A^^
"BLD",5032,"KRN",.84,0)
.84
"BLD",5032,"KRN",.84,"NM",0)
^9.68A^^
"BLD",5032,"KRN",3.6,0)
3.6
"BLD",5032,"KRN",3.6,"NM",0)
^9.68A^^
"BLD",5032,"KRN",3.8,0)
3.8
"BLD",5032,"KRN",3.8,"NM",0)
^9.68A^^
"BLD",5032,"KRN",9.2,0)
9.2
"BLD",5032,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",5032,"KRN",9.8,0)
9.8
"BLD",5032,"KRN",9.8,"NM",0)
^9.68A^22^7
"BLD",5032,"KRN",9.8,"NM",16,0)
MAGQBUT4^^0^B78049028
"BLD",5032,"KRN",9.8,"NM",17,0)
MAGQBTM^^0^B79858508
"BLD",5032,"KRN",9.8,"NM",18,0)
MAGQBUT2^^0^B55361113
"BLD",5032,"KRN",9.8,"NM",19,0)
MAGQBPG1^^0^B76244753
"BLD",5032,"KRN",9.8,"NM",20,0)
MAGQBUT5^^0^B15869460
"BLD",5032,"KRN",9.8,"NM",21,0)
MAGQBPRG^^0^B57300845
"BLD",5032,"KRN",9.8,"NM",22,0)
MAGQBUT1^^0^B76309021
"BLD",5032,"KRN",9.8,"NM","B","MAGQBPG1",19)

"BLD",5032,"KRN",9.8,"NM","B","MAGQBPRG",21)

"BLD",5032,"KRN",9.8,"NM","B","MAGQBTM",17)

"BLD",5032,"KRN",9.8,"NM","B","MAGQBUT1",22)

"BLD",5032,"KRN",9.8,"NM","B","MAGQBUT2",18)

"BLD",5032,"KRN",9.8,"NM","B","MAGQBUT4",16)

"BLD",5032,"KRN",9.8,"NM","B","MAGQBUT5",20)

"BLD",5032,"KRN",19,0)
19
"BLD",5032,"KRN",19,"NM",0)
^9.68A^^
"BLD",5032,"KRN",19.1,0)
19.1
"BLD",5032,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",5032,"KRN",101,0)
101
"BLD",5032,"KRN",101,"NM",0)
^9.68A^^
"BLD",5032,"KRN",409.61,0)
409.61
"BLD",5032,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",5032,"KRN",771,0)
771
"BLD",5032,"KRN",771,"NM",0)
^9.68A^^
"BLD",5032,"KRN",870,0)
870
"BLD",5032,"KRN",870,"NM",0)
^9.68A^^
"BLD",5032,"KRN",8989.51,0)
8989.51
"BLD",5032,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",5032,"KRN",8989.52,0)
8989.52
"BLD",5032,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",5032,"KRN",8994,0)
8994
"BLD",5032,"KRN",8994,"NM",0)
^9.68A^1^1
"BLD",5032,"KRN",8994,"NM",1,0)
MAGQ VOK^^0
"BLD",5032,"KRN",8994,"NM","B","MAGQ VOK",1)

"BLD",5032,"KRN","B",.4,.4)

"BLD",5032,"KRN","B",.401,.401)

"BLD",5032,"KRN","B",.402,.402)

"BLD",5032,"KRN","B",.403,.403)

"BLD",5032,"KRN","B",.5,.5)

"BLD",5032,"KRN","B",.84,.84)

"BLD",5032,"KRN","B",3.6,3.6)

"BLD",5032,"KRN","B",3.8,3.8)

"BLD",5032,"KRN","B",9.2,9.2)

"BLD",5032,"KRN","B",9.8,9.8)

"BLD",5032,"KRN","B",19,19)

"BLD",5032,"KRN","B",19.1,19.1)

"BLD",5032,"KRN","B",101,101)

"BLD",5032,"KRN","B",409.61,409.61)

"BLD",5032,"KRN","B",771,771)

"BLD",5032,"KRN","B",870,870)

"BLD",5032,"KRN","B",8989.51,8989.51)

"BLD",5032,"KRN","B",8989.52,8989.52)

"BLD",5032,"KRN","B",8994,8994)

"BLD",5032,"PRE")

"BLD",5032,"QUES",0)
^9.62^^
"BLD",5032,"REQB",0)
^9.611^2^1
"BLD",5032,"REQB",2,0)
MAG*3.0*20^2
"BLD",5032,"REQB","B","MAG*3.0*20",2)

"INI")
PRE^MAGIP81
"INIT")
POST^MAGIP81
"KRN",8994,2074,-1)
0^1
"KRN",8994,2074,0)
MAGQ VOK^VOKR^MAGQBUT4^1^P
"KRN",8994,2074,1,0)
^8994.01^4^4^3070125^^^^
"KRN",8994,2074,1,1,0)
This procedure checks the 2nd line of the routine MAGQBUT4 for
"KRN",8994,2074,1,2,0)
the latest version number.  It will return 1 if the version
"KRN",8994,2074,1,3,0)
matches the input "version" parameter and 0 if there is no
"KRN",8994,2074,1,4,0)
match.
"KRN",8994,2074,2,0)
^8994.02A^1^1
"KRN",8994,2074,2,1,0)
Version^1^^1^1
"KRN",8994,2074,2,1,1,0)
^8994.021^3^3^3070125^^^^
"KRN",8994,2074,2,1,1,1,0)
This version number is expect to be the VistA Imaging major release number (x.x)
"KRN",8994,2074,2,1,1,2,0)
concatenated with P and then concatenated with the patch number.
"KRN",8994,2074,2,1,1,3,0)
For example 3.0P81
"KRN",8994,2074,2,"B","Version",1)

"KRN",8994,2074,2,"PARAMSEQ",1,1)

"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging-V1 to release 
"PKG",454,20,0)
^9.402P^^
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020319^3020517^126
"PKG",454,22,1,"PAH",1,0)
81^3070523^126
"PKG",454,22,1,"PAH",1,1,0)
^^9^9^3070523
"PKG",454,22,1,"PAH",1,1,1,0)
Select BUILD NAME:    MAG*3.0*81     IMAGING
"PKG",454,22,1,"PAH",1,1,2,0)
MAGIP81   value = 4894048
"PKG",454,22,1,"PAH",1,1,3,0)
MAGQBPG1  value = 76244753
"PKG",454,22,1,"PAH",1,1,4,0)
MAGQBPRG  value = 57300845
"PKG",454,22,1,"PAH",1,1,5,0)
MAGQBTM   value = 79858508
"PKG",454,22,1,"PAH",1,1,6,0)
MAGQBUT1  value = 76309021
"PKG",454,22,1,"PAH",1,1,7,0)
MAGQBUT2  value = 55361113
"PKG",454,22,1,"PAH",1,1,8,0)
MAGQBUT4  value = 78049028
"PKG",454,22,1,"PAH",1,1,9,0)
MAGQBUT5  value = 15869460
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","MAGIP81")
0^^B4894048
"RTN","MAGIP81",1,0)
MAGIP81 ;Post init routine to queue site activity at install.
"RTN","MAGIP81",2,0)
 ;;3.0;IMAGING;**81**;May 17, 2007
"RTN","MAGIP81",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP81",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP81",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP81",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP81",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP81",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP81",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP81",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP81",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP81",12,0)
 ;; | a medical device.  As such, it may not be changed             |
"RTN","MAGIP81",13,0)
 ;; | in any way.  Modifications to this software may result in an  |
"RTN","MAGIP81",14,0)
 ;; | adulterated medical device under 21CFR820, the use of which   |
"RTN","MAGIP81",15,0)
 ;; | is considered to be a violation of US Federal Statutes.       |
"RTN","MAGIP81",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP81",17,0)
 ;;
"RTN","MAGIP81",18,0)
PRE ;
"RTN","MAGIP81",19,0)
 ; Remove RPC so that it installs cleanly
"RTN","MAGIP81",20,0)
 D RMRPC("MAGQ VOK")
"RTN","MAGIP81",21,0)
 Q
"RTN","MAGIP81",22,0)
POST ;
"RTN","MAGIP81",23,0)
 D BMES^XPDUTL("Updating MAG WINDOWS: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP81",24,0)
 D ADDRPC^MAGQBUT4("MAGQ VOK","MAG WINDOWS")
"RTN","MAGIP81",25,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP81",26,0)
 Q
"RTN","MAGIP81",27,0)
RMRPC(NAME) ; Removing an RPC in order to revise
"RTN","MAGIP81",28,0)
 N MW,RPC,MWE,DIERR
"RTN","MAGIP81",29,0)
 S MW=$$FIND1^DIC(19,"","X","MAG WINDOWS","","","")
"RTN","MAGIP81",30,0)
 D CLEAN^DILF
"RTN","MAGIP81",31,0)
 Q:'MW
"RTN","MAGIP81",32,0)
 S RPC=$$FIND1^DIC(8994,"","X",NAME,"","","")
"RTN","MAGIP81",33,0)
 D CLEAN^DILF
"RTN","MAGIP81",34,0)
 Q:'RPC
"RTN","MAGIP81",35,0)
 S MWE=$$FIND1^DIC(19.05,","_MW_",","X",NAME,"","","")
"RTN","MAGIP81",36,0)
 D CLEAN^DILF
"RTN","MAGIP81",37,0)
 Q:'MWE
"RTN","MAGIP81",38,0)
 S DA=MWE,DA(1)=MW,DIK="^DIC(19,"_DA(1)_",""RPC"","
"RTN","MAGIP81",39,0)
 D ^DIK
"RTN","MAGIP81",40,0)
 K DA,DIK
"RTN","MAGIP81",41,0)
 S DA=RPC,DIK="^XWB(8994,"
"RTN","MAGIP81",42,0)
 D ^DIK
"RTN","MAGIP81",43,0)
 K DA,DIK
"RTN","MAGIP81",44,0)
 Q
"RTN","MAGIP81",45,0)
 ;
"RTN","MAGQBPG1")
0^19^B76244753
"RTN","MAGQBPG1",1,0)
MAGQBPG1 ;WOIFO/RMP - REMOTE Task SERVER Program [ 11/08/2001 17:18 ]
"RTN","MAGQBPG1",2,0)
 ;;3.0;IMAGING;**7,8,20,81**;May 17, 2007
"RTN","MAGQBPG1",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBPG1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPG1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBPG1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBPG1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBPG1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBPG1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBPG1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBPG1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBPG1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBPG1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBPG1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBPG1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBPG1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPG1",17,0)
 ;;
"RTN","MAGQBPG1",18,0)
ENTRY(RESULT,WSTAT,PROCESS) ;RPC[MAGQ JBS]
"RTN","MAGQBPG1",19,0)
 N X,SYSIEN,SYSNAME,ZNODE,NODE,INDX,CNT,PROC,%,QPTR,QCNT,SHARE,PLACE
"RTN","MAGQBPG1",20,0)
 D NOW^%DTC
"RTN","MAGQBPG1",21,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",22,0)
 S (SYSIEN,CNT)=0,SYSNAME="",U="^",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBPG1",23,0)
 S SYSIEN=$O(^MAG(2006.8,"C",WSTAT,"")) ;TRUE WORKSTATION NAME
"RTN","MAGQBPG1",24,0)
 I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",$$UPPER^MAGQE4(WSTAT),""))
"RTN","MAGQBPG1",25,0)
 I 'SYSIEN D  ;ATTEMPT TO FIND A MATCH FROM LOCAL NAME
"RTN","MAGQBPG1",26,0)
 . N TRY
"RTN","MAGQBPG1",27,0)
 . F TRY=1:1:$L(WSTAT,".") D  Q:SYSIEN?1N.N
"RTN","MAGQBPG1",28,0)
 . . S SYSIEN=$O(^MAG(2006.8,"C",$P(WSTAT,".",TRY),""))
"RTN","MAGQBPG1",29,0)
 . . I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",$$UPPER^MAGQE4($P(WSTAT,".",TRY)),""))
"RTN","MAGQBPG1",30,0)
 I SYSIEN="" D  Q
"RTN","MAGQBPG1",31,0)
 . S RESULT(0)="-1^This workstation is not currently setup as a Background Processor."
"RTN","MAGQBPG1",32,0)
 . Q
"RTN","MAGQBPG1",33,0)
 S NODE=^MAG(2006.8,SYSIEN,0)
"RTN","MAGQBPG1",34,0)
 S SYSNAME=$P(NODE,U)
"RTN","MAGQBPG1",35,0)
 I SYSNAME="" D  Q
"RTN","MAGQBPG1",36,0)
 . S RESULT(0)="-1^This workstation is not currently setup as a Background Processor."
"RTN","MAGQBPG1",37,0)
 . Q
"RTN","MAGQBPG1",38,0)
 S RESULT(0)="0^BP List^PID: "_$$BASE^XLFUTL($J,10,16)_U_SYSNAME_U_WSTAT_U_$P(^MAG(2006.1,PLACE,0),U,2)
"RTN","MAGQBPG1",39,0)
 S (X,CNT)=0
"RTN","MAGQBPG1",40,0)
 F  S X=$O(^MAG(2005.2,X)) Q:X'?1N.N  S ZNODE=^(X,0) D
"RTN","MAGQBPG1",41,0)
 . Q:'$P(ZNODE,U,6)  ;1=on-line
"RTN","MAGQBPG1",42,0)
 . Q:$E($P(ZNODE,U,2),1,2)'="\\"
"RTN","MAGQBPG1",43,0)
 . Q:$P(ZNODE,U,10)'=PLACE
"RTN","MAGQBPG1",44,0)
 . Q:(($P(ZNODE,U,7)'["WORM")&($P(ZNODE,U,7)'="RW"))
"RTN","MAGQBPG1",45,0)
 . S CNT=CNT+1,SHARE=$P(ZNODE,U,2)
"RTN","MAGQBPG1",46,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBPG1",47,0)
 . S RESULT(CNT)=X_U_SHARE_U_$P(ZNODE,U,8)
"RTN","MAGQBPG1",48,0)
 Q
"RTN","MAGQBPG1",49,0)
JBPTR(RESULT,FILE) ;[MAGQ JBPTR]
"RTN","MAGQBPG1",50,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",51,0)
 N IEN,SITEID
"RTN","MAGQBPG1",52,0)
 S SITEID=$$UPPER^MAGQE4($P(^MAG(2006.1,$$PLACE^MAGBAPI(+$G(DUZ(2))),0),U,2))
"RTN","MAGQBPG1",53,0)
 S IEN=$P(+$P(FILE,SITEID,2),".")
"RTN","MAGQBPG1",54,0)
 S RESULT=$$JBPTR^MAGQBPRG(IEN,$$FTYPE^MAGQBPRG($P(FILE,".",2)))
"RTN","MAGQBPG1",55,0)
 Q
"RTN","MAGQBPG1",56,0)
SHR(RESULT) ; RPC[MAGQ SHARES]
"RTN","MAGQBPG1",57,0)
 N TMP,INDX,DATA,CNT,SHARE,CWL,VALUE,PLACE ;CWL=CURRENT WRITE LOCATION
"RTN","MAGQBPG1",58,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",59,0)
 S (CNT,INDX)=0,U="^",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBPG1",60,0)
 S CWL=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBPG1",61,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBPG1",62,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBPG1",63,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBPG1",64,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBPG1",65,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBPG1",66,0)
 . Q:$P(DATA,U,10)'=PLACE
"RTN","MAGQBPG1",67,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBPG1",68,0)
 . Q:$E(SHARE,1,2)'="\\"
"RTN","MAGQBPG1",69,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBPG1",70,0)
 . S SHARE=SHARE_U_$P(DATA,U,8)
"RTN","MAGQBPG1",71,0)
 . Q:$D(TMP(SHARE))
"RTN","MAGQBPG1",72,0)
 . S TMP(SHARE)=INDX
"RTN","MAGQBPG1",73,0)
 S INDX=""
"RTN","MAGQBPG1",74,0)
 F  S INDX=$O(TMP(INDX)) Q:INDX=""  D
"RTN","MAGQBPG1",75,0)
 . S RESULT(CNT)=TMP(INDX)_U_INDX,CNT=CNT+1
"RTN","MAGQBPG1",76,0)
 . S ^TMP("MAGQBP",$J,"SHRLST",CNT-1)=TMP(INDX)_U_INDX
"RTN","MAGQBPG1",77,0)
 K TMP
"RTN","MAGQBPG1",78,0)
 Q
"RTN","MAGQBPG1",79,0)
CNP2(RESULT,IEN,START,STOP) ;[MAGQ JBSCN]
"RTN","MAGQBPG1",80,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",81,0)
 N FNAME,PIECE,ZNODE,NODE2,BNODE,BNAME,PTR,HASH,TEMP,ORDER,RDATE,PLACE,OFFLINE,PLACEOK,GL,END,ACQSITE
"RTN","MAGQBPG1",82,0)
 S (RESULT,GL)="",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2))),(OFFLINE,PLACEOK)=0
"RTN","MAGQBPG1",83,0)
 S:START="" START=$O(^MAG(2005,0)) S:STOP="" STOP=$O(^MAG(2005,"A"),-1)
"RTN","MAGQBPG1",84,0)
 S ORDER=$S(START>STOP:"R",1:"F")
"RTN","MAGQBPG1",85,0)
 I (IEN'?1N.N)!IEN=0 D  I IEN="" S RESULT=0 Q
"RTN","MAGQBPG1",86,0)
 . I START=0 S IEN=START Q
"RTN","MAGQBPG1",87,0)
 . I ORDER="R" D
"RTN","MAGQBPG1",88,0)
 . . S I1=+$O(^MAG(2005," "),-1),I2=+$O(^MAG(2005.1," "),-1),END=$S(I1>I2:I1,1:I2)
"RTN","MAGQBPG1",89,0)
 . . S IEN=$S(START>END:START,1:START+1) Q
"RTN","MAGQBPG1",90,0)
 . E  S IEN=START-1
"RTN","MAGQBPG1",91,0)
 . Q
"RTN","MAGQBPG1",92,0)
 S IEN=+IEN
"RTN","MAGQBPG1",93,0)
 F  D SCAN^MAGQBPG1(.IEN,ORDER,.GL) D  Q:((('OFFLINE)&PLACEOK)!('IEN)!($P(RESULT,U,21)="DUPE")!'$G(ACQSITE))
"RTN","MAGQBPG1",94,0)
 . Q:'IEN
"RTN","MAGQBPG1",95,0)
 . S ZNODE=$G(@(GL_IEN_",0)")),ACQSITE=$P($G(@(GL_IEN_",100)")),U,3)
"RTN","MAGQBPG1",96,0)
 . S PLACEOK=$S($$PLACE^MAGBAPI(+ACQSITE)=$$PLACE^MAGBAPI($G(DUZ(2))):1,1:"")
"RTN","MAGQBPG1",97,0)
 . I $P(ZNODE,U,2)'="" S OFFLINE=$$IMOFFLN^MAGFILEB($P(ZNODE,U,2))  ; Only check the offline status of image files
"RTN","MAGQBPG1",98,0)
 . I ($D(^MAG(2005.1,IEN,0))&$D(^MAG(2005,IEN,0))) D  Q  ; Image is duplicated in the Archive file
"RTN","MAGQBPG1",99,0)
 . . I $P(^MAG(2005,IEN,0),U,1,8)="^^^^^^^",+$P(^MAG(2005,IEN,0),U,9) K ^MAG(2005,IEN,0) Q
"RTN","MAGQBPG1",100,0)
 . . S FDA(2005,IEN_",",13.5)="1" ; Set Dupe field in the Image File 
"RTN","MAGQBPG1",101,0)
 . . S FDA(2005,IEN_",",13)="1" ; Set IQ field in the Image File  
"RTN","MAGQBPG1",102,0)
 . . D FILE^DIE("I","FDA","MSG") K FDA,MSG
"RTN","MAGQBPG1",103,0)
 . . S FDA(2005.1,IEN_",",13.5)="1" ; Set the Dupe field in the archive file
"RTN","MAGQBPG1",104,0)
 . . S FDA(2005.1,IEN_",",13)="1" ; and set the IQ field in the archive file
"RTN","MAGQBPG1",105,0)
 . . D FILE^DIE("I","FDA","MSG") K FDA,MSG
"RTN","MAGQBPG1",106,0)
 . . S $P(RESULT,U,21)="DUPE"
"RTN","MAGQBPG1",107,0)
 . . S $P(RESULT,U)=IEN
"RTN","MAGQBPG1",108,0)
 . . I $P(ZNODE,U,2)=$P($G(^MAG(2005.1,IEN,0)),U,2) S $P(RESULT,U,2)=$P(ZNODE,U,2) D
"RTN","MAGQBPG1",109,0)
 . . . I $P(RESULT,U,2)="" S $P(RESULT,U,2)="No File Name" Q
"RTN","MAGQBPG1",110,0)
 . . E  S $P(RESULT,U,2)=$P(ZNODE,U,2)_"/"_$P($G(^MAG(2005.1,IEN,0)),U,2) D
"RTN","MAGQBPG1",111,0)
 . . . I $P($P(RESULT,U,2),"/")="" S $P(RESULT,U,2)="No File Name"_$P(RESULT,U,2)
"RTN","MAGQBPG1",112,0)
 . . . I $P($P(RESULT,U,2),"/",2)="" S $P(RESULT,U,2)=$P(RESULT,U,2)_"No File Name"
"RTN","MAGQBPG1",113,0)
 . . . Q
"RTN","MAGQBPG1",114,0)
 . . Q
"RTN","MAGQBPG1",115,0)
 . E  I $P(ZNODE,U,2)'="" S $P(@(GL_IEN_",0)"),U,12)="0"
"RTN","MAGQBPG1",116,0)
 . Q
"RTN","MAGQBPG1",117,0)
 I $S('IEN:1,((ORDER="F")&(IEN>STOP)):1,((ORDER="R")&(IEN<STOP)):1,1:0) D  Q
"RTN","MAGQBPG1",118,0)
 . S RESULT=0
"RTN","MAGQBPG1",119,0)
 . Q
"RTN","MAGQBPG1",120,0)
 S FNAME=$P(ZNODE,U,2)
"RTN","MAGQBPG1",121,0)
 S $P(RESULT,U)=IEN
"RTN","MAGQBPG1",122,0)
 Q:($P(RESULT,U,21)="DUPE")
"RTN","MAGQBPG1",123,0)
 S $P(RESULT,U,19)=$P($P($G(@(GL_IEN_",2)")),U),".")
"RTN","MAGQBPG1",124,0)
 I $P(ZNODE,U,2)'="" D  ;NON-GROUP PARENT
"RTN","MAGQBPG1",125,0)
 . S BNODE=$G(@(GL_IEN_",""FBIG"")"))
"RTN","MAGQBPG1",126,0)
 . I $P(ZNODE,U,5)?1N.N S $P(RESULT,U,3)=$P(ZNODE,U,5)
"RTN","MAGQBPG1",127,0)
 . S:$P(BNODE,U,2)?1N.N $P(RESULT,U,4)=$P(BNODE,U,2)
"RTN","MAGQBPG1",128,0)
 . S:$P(ZNODE,U,3)?1N.N $P(RESULT,U,5)=$P(ZNODE,U,3)
"RTN","MAGQBPG1",129,0)
 . S:$P(ZNODE,U,4)?1N.N $P(RESULT,U,6)=$P(ZNODE,U,4)
"RTN","MAGQBPG1",130,0)
 . S:$P(BNODE,U)?1N.N $P(RESULT,U,7)=$P(BNODE,U)
"RTN","MAGQBPG1",131,0)
 . S $P(RESULT,U,8)=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBPG1",132,0)
 . S $P(RESULT,U,2)=FNAME
"RTN","MAGQBPG1",133,0)
 . I $D(@(GL_IEN_",""FBIG"")")),'$P(BNODE,U),'$P(BNODE,U,2) S $P(RESULT,U,22)="EMPTY_FBIG"
"RTN","MAGQBPG1",134,0)
 . Q
"RTN","MAGQBPG1",135,0)
 I '$P($G(@(GL_IEN_",100)")),U,3) S $P(RESULT,U,23)=-1 ;"NO ACQ SITE VALUE"
"RTN","MAGQBPG1",136,0)
 ;
"RTN","MAGQBPG1",137,0)
 I GL[("^MAG(2005.1,") S $P(RESULT,U,21)="ARCH"
"RTN","MAGQBPG1",138,0)
 E  S $P(RESULT,U,12,17)=$$CHKIMG^MAGQBUT2(IEN)
"RTN","MAGQBPG1",139,0)
 Q
"RTN","MAGQBPG1",140,0)
JPUD(RESULT,JPTR,EXT,IEN) ; RPC[MAGQ JPUD]
"RTN","MAGQBPG1",141,0)
 N TYPE,PIECE,NODE,GL
"RTN","MAGQBPG1",142,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP"),RESULT="0"
"RTN","MAGQBPG1",143,0)
 S TYPE=$$FTYPE^MAGQBPRG(EXT)
"RTN","MAGQBPG1",144,0)
 S PIECE=$S(TYPE="BIG":2,1:5)
"RTN","MAGQBPG1",145,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPG1",146,0)
 I JPTR="0" D  Q:(RESULT<0)
"RTN","MAGQBPG1",147,0)
 . S JPTR=""
"RTN","MAGQBPG1",148,0)
 . S GL=$S($D(^MAG(2005,IEN)):"^MAG(2005,",$D(^MAG(2005.1,IEN)):"^MAG(2005.1,",1:0)
"RTN","MAGQBPG1",149,0)
 . I GL=0 S RESULT="-1" Q
"RTN","MAGQBPG1",150,0)
 . I $D(^MAGQUEUE(2006.033,"B",$P($G(@(GL_IEN_",0)")),U,2))) D  Q
"RTN","MAGQBPG1",151,0)
 . . S RESULT=-2 Q  ;Don't clear the JB pointer if image is on an Off-line Platter
"RTN","MAGQBPG1",152,0)
 . . Q
"RTN","MAGQBPG1",153,0)
 . Q
"RTN","MAGQBPG1",154,0)
 S:$D(^MAG(2005,IEN,NODE)) $P(^MAG(2005,IEN,NODE),U,PIECE)=JPTR
"RTN","MAGQBPG1",155,0)
 S:$D(^MAG(2005.1,IEN,NODE)) $P(^MAG(2005.1,IEN,NODE),U,PIECE)=JPTR
"RTN","MAGQBPG1",156,0)
 S RESULT="1"
"RTN","MAGQBPG1",157,0)
 Q
"RTN","MAGQBPG1",158,0)
VCUD(RESULT,VCPTR,EXT,IEN) ; RPC[MAGQ VCUD]
"RTN","MAGQBPG1",159,0)
 N TYPE,PIECE,NODE
"RTN","MAGQBPG1",160,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP"),RESULT="0"
"RTN","MAGQBPG1",161,0)
 S TYPE=$$FTYPE^MAGQBPRG(EXT)
"RTN","MAGQBPG1",162,0)
 S PIECE=$S(TYPE="BIG":1,TYPE="ABS":4,1:3)
"RTN","MAGQBPG1",163,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPG1",164,0)
 S:VCPTR="0" VCPTR=""
"RTN","MAGQBPG1",165,0)
 S:$D(^MAG(2005,IEN,NODE)) $P(^MAG(2005,IEN,NODE),U,PIECE)=VCPTR
"RTN","MAGQBPG1",166,0)
 S:$D(^MAG(2005.1,IEN,NODE)) $P(^MAG(2005.1,IEN,NODE),U,PIECE)=VCPTR
"RTN","MAGQBPG1",167,0)
 S RESULT="1"
"RTN","MAGQBPG1",168,0)
 Q
"RTN","MAGQBPG1",169,0)
DFNIQ(RESULT,INPUT,SEND) ;
"RTN","MAGQBPG1",170,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",171,0)
 N LOC,CNT,Y
"RTN","MAGQBPG1",172,0)
 S U="^"
"RTN","MAGQBPG1",173,0)
 S CNT=+$O(^TMP($J,"MAGQDFN",""),-1)
"RTN","MAGQBPG1",174,0)
 I CNT<2 D
"RTN","MAGQBPG1",175,0)
 . D NOW^%DTC S Y=% D DD^%DT
"RTN","MAGQBPG1",176,0)
 . S LOC=$$KSP^XUPARAM("WHERE")
"RTN","MAGQBPG1",177,0)
 . S ^TMP($J,"MAGQDFN",1)="            SITE: "_LOC
"RTN","MAGQBPG1",178,0)
 . S ^TMP($J,"MAGQDFN",2)="            DATE: "_Y_" "_$G(^XMB("TIMEZONE"))
"RTN","MAGQBPG1",179,0)
 . S CNT=2
"RTN","MAGQBPG1",180,0)
 . Q
"RTN","MAGQBPG1",181,0)
 I SEND="1" D
"RTN","MAGQBPG1",182,0)
 . S XMSUB=INPUT
"RTN","MAGQBPG1",183,0)
 . N XMY,XMTEXT
"RTN","MAGQBPG1",184,0)
 . S XMTEXT="^TMP($J,""MAGQDFN"","
"RTN","MAGQBPG1",185,0)
 . S XMY("G.MAG SERVER")=""
"RTN","MAGQBPG1",186,0)
 . S:$G(DUZ) XMY(DUZ)=""
"RTN","MAGQBPG1",187,0)
 . D ^XMD
"RTN","MAGQBPG1",188,0)
 . K ^TMP($J,"MAGQDFN")
"RTN","MAGQBPG1",189,0)
 . K XMSUB
"RTN","MAGQBPG1",190,0)
 . Q
"RTN","MAGQBPG1",191,0)
 E  S CNT=CNT+1,^TMP($J,"MAGQDFN",CNT)=INPUT
"RTN","MAGQBPG1",192,0)
 S RESULT="1"
"RTN","MAGQBPG1",193,0)
 Q
"RTN","MAGQBPG1",194,0)
MOVE(RESULT,FNAM) ;[MAGQ MOVE]
"RTN","MAGQBPG1",195,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPG1",196,0)
 N IEN,FTYPE,NMSPC,SITEID,EXT,ALT,J
"RTN","MAGQBPG1",197,0)
 S NMSPC=$TR($P(FNAM,"."),"0123456789","")
"RTN","MAGQBPG1",198,0)
 S SITEID=$$INIS^MAGQBPG2($$PLACE^MAGBAPI(+DUZ(2)))
"RTN","MAGQBPG1",199,0)
 I SITEID'[(","_NMSPC_",") D  Q
"RTN","MAGQBPG1",200,0)
 . S RESULT="0^Invalid Imaging Namespace"
"RTN","MAGQBPG1",201,0)
 S IEN=$O(^MAG(2005,"F",$P(FNAM,"."),""))
"RTN","MAGQBPG1",202,0)
 I IEN'?1N.N!('$D(^MAG(2005,IEN,0))) D  Q
"RTN","MAGQBPG1",203,0)
 . S RESULT="0^No matching 2005 entry"
"RTN","MAGQBPG1",204,0)
 S EXT=$P(FNAM,".",2)
"RTN","MAGQBPG1",205,0)
 I $P($G(^MAG(2005,IEN,0)),U,2)[FNAM S RESULT=IEN_U_"FULL"
"RTN","MAGQBPG1",206,0)
 E  D
"RTN","MAGQBPG1",207,0)
 . S FTYPE=$$FTYPE^MAGQBPRG(EXT)
"RTN","MAGQBPG1",208,0)
 . I FTYPE="FULL" D  Q
"RTN","MAGQBPG1",209,0)
 . . D FTYPE^MAGQBUT(.ALT)
"RTN","MAGQBPG1",210,0)
 . . S J=""
"RTN","MAGQBPG1",211,0)
 . . F  S J=$O(ALT(J)) Q:J'?1N.N  S:ALT(J)[EXT FTYPE="ALT"
"RTN","MAGQBPG1",212,0)
 . . I FTYPE["ALT" S RESULT=IEN_U_FTYPE
"RTN","MAGQBPG1",213,0)
 . . E  S RESULT="0^Invalid File Extension"
"RTN","MAGQBPG1",214,0)
 . E  S RESULT=IEN_U_FTYPE
"RTN","MAGQBPG1",215,0)
 Q
"RTN","MAGQBPG1",216,0)
SCAN(IEN,ORDER,GB) ; Find the next image spanning the Image and the Image Archive file
"RTN","MAGQBPG1",217,0)
 I IEN,GB="^MAG(2005,",$D(^MAG(2005.1,IEN)) D  Q
"RTN","MAGQBPG1",218,0)
 . S IEN=IEN,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",219,0)
 N I1,I2
"RTN","MAGQBPG1",220,0)
 I $G(ORDER)="F" D 
"RTN","MAGQBPG1",221,0)
 . S I1=$O(^MAG(2005,IEN)),I1=$S(I1:I1,1:"")
"RTN","MAGQBPG1",222,0)
 . S I2=$O(^MAG(2005.1,IEN)),I2=$S(I2:I2,1:"")
"RTN","MAGQBPG1",223,0)
 . I I1,'I2 S IEN=I1,GB="^MAG(2005," Q
"RTN","MAGQBPG1",224,0)
 . I I2,'I1 S IEN=I2,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",225,0)
 . S GB=$S(I1>I2:"^MAG(2005.1,",1:"^MAG(2005,")
"RTN","MAGQBPG1",226,0)
 . S IEN=$S(I1>I2:I2,1:I1)
"RTN","MAGQBPG1",227,0)
 . Q
"RTN","MAGQBPG1",228,0)
 E  D  ;Reverse
"RTN","MAGQBPG1",229,0)
 . S I1=$O(^MAG(2005,IEN),-1),I1=$S(I1:I1,1:"")
"RTN","MAGQBPG1",230,0)
 . S I2=$O(^MAG(2005.1,IEN),-1),I2=$S(I2:I2,1:"")
"RTN","MAGQBPG1",231,0)
 . I I1,'I2 S IEN=I1,GB="^MAG(2005," Q
"RTN","MAGQBPG1",232,0)
 . I I2,'I1 S IEN=I2,GB="^MAG(2005.1," Q
"RTN","MAGQBPG1",233,0)
 . S GB=$S(I1<I2:"^MAG(2005.1,",1:"^MAG(2005,")
"RTN","MAGQBPG1",234,0)
 . S IEN=$S(I1<I2:I2,1:I1)
"RTN","MAGQBPG1",235,0)
 . Q
"RTN","MAGQBPG1",236,0)
 S IEN=$S('IEN:"",1:IEN)
"RTN","MAGQBPG1",237,0)
 Q
"RTN","MAGQBPRG")
0^21^B57300845
"RTN","MAGQBPRG",1,0)
MAGQBPRG ;WOIOFO/RMP Magnetic Server Purge processes [ 06/29/2001 18:28 ]
"RTN","MAGQBPRG",2,0)
 ;;3.0;IMAGING;**7,3,8,20,81**;May 17, 2007
"RTN","MAGQBPRG",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBPRG",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPRG",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBPRG",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBPRG",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBPRG",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBPRG",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBPRG",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBPRG",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBPRG",12,0)
 ;; | a medical device.  As such, it may not be changed in any way  |
"RTN","MAGQBPRG",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBPRG",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBPRG",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBPRG",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBPRG",17,0)
 ;;
"RTN","MAGQBPRG",18,0)
FILEREF(RESULT,FILEPATH,FNAM,EXT,NETLOC,RADHOLD) ; RPC[MAGQBP FREF]
"RTN","MAGQBPRG",19,0)
 ;VALIDATES THAT THE FILEPATH IS CONSISTENT WITH VISTA MAGFILE REFERENCE
"RTN","MAGQBPRG",20,0)
 ;SET THE SECOND PIECE TO "PACS" IF IT REPRESENTS DICOM
"RTN","MAGQBPRG",21,0)
 ;VALIDATES THAT A JUKEBOX POINTER EXISTS
"RTN","MAGQBPRG",22,0)
 ;RESULT VALUES
"RTN","MAGQBPRG",23,0)
 ;PIECE  1:-3 = FOREIGN FILE, DO NOT PURGE
"RTN","MAGQBPRG",24,0)
 ;         -2 = QUEUED FOR JUKEBOX COPY, DO NOT PURGE
"RTN","MAGQBPRG",25,0)
 ;         -1 = DO NOT PURGE
"RTN","MAGQBPRG",26,0)
 ;          0 = PURGE('MAG 2005 ENTRY)!('JUKEBOX PTRS & 'EXCEPTIONS)
"RTN","MAGQBPRG",27,0)
 ;          1 = PURGE GIVEN NORMAL DATE CRITERIA (NDC) + CONFIRMED ON JB
"RTN","MAGQBPRG",28,0)
 ;          2 = PURGE GIVEN NDC IF TGA PRESENT
"RTN","MAGQBPRG",29,0)
 ;          3 = PURGE IF FILE IS AT ALTERNATE NETWORK LOCATION SITE
"RTN","MAGQBPRG",30,0)
 ;              ELSE PURGE IF AGED & UPDATE FILE REFERENCES
"RTN","MAGQBPRG",31,0)
 ;        **4 = (**NA**)AGE PURGE IF ON JUKEBOX, UPDATE FILE REFERENCES
"RTN","MAGQBPRG",32,0)
 ;              ELSE UPDATE FILEREFENCES, QUEUE JUKEBOX COPY
"RTN","MAGQBPRG",33,0)
 ;          5 = PURGE IF AT ALTERNATE SITE,QUEUE JUKEBOX IF NOT ON JB
"RTN","MAGQBPRG",34,0)
 ;          6 = PURGE GIVEN NORMAL DATE CRITERIA
"RTN","MAGQBPRG",35,0)
 ;PIECE   2:0 = NONPACS
"RTN","MAGQBPRG",36,0)
 ;         :1 = PACS
"RTN","MAGQBPRG",37,0)
 ;PIECE    3: RECORD CATEGORY
"RTN","MAGQBPRG",38,0)
 ;         1 = 'NO 2005 ENTRY
"RTN","MAGQBPRG",39,0)
 ;         2 = RADIOLOGY HOLD
"RTN","MAGQBPRG",40,0)
 ;         3 = NO JUKEBOX/JUKEBOX PTRS
"RTN","MAGQBPRG",41,0)
 ;         4 = JUKEBOX - NO JUKEBOX PTRS (P/EXCEPT)ELSE QUEUE
"RTN","MAGQBPRG",42,0)
 ;         5 = JUKEBOX/JUKEBOX PTRS, NO CACHE PTRS,PURGE IF CONFIRMED
"RTN","MAGQBPRG",43,0)
 ;         6 = JUKEBOX/JUKEBOX PTRS, WRONG CACHE PTRS PURGE IF AT ALT
"RTN","MAGQBPRG",44,0)
 ;         7 = JUKEBOX/JUKEBOX PTRS, NO CACHE PTRS, FIX PTRS
"RTN","MAGQBPRG",45,0)
 ;         8 = JUKEBOX/JUKEBOX PTRS, CACHE PTRS, AGE (IF CONFIRMED)
"RTN","MAGQBPRG",46,0)
 ;         9 = RECORD NOT IN THE IMAGE FILE
"RTN","MAGQBPRG",47,0)
 ;        10 = FOREIGN IMAGE FILE
"RTN","MAGQBPRG",48,0)
 ;        11 = NOT AN IMAGE FILE
"RTN","MAGQBPRG",49,0)
 ;        12 = FILE LOCATION NOT VALID 
"RTN","MAGQBPRG",50,0)
 ;        13 = DELETE 2005 ENTRY (LAST LOCATION REFERENCED)
"RTN","MAGQBPRG",51,0)
 ;        14 = Duplicate 2005/2005.1 entry
"RTN","MAGQBPRG",52,0)
 ;        15 = Foreign Place
"RTN","MAGQBPRG",53,0)
 ;        16 = Record in Archive file
"RTN","MAGQBPRG",54,0)
 ;        17 = Jukebox offline
"RTN","MAGQBPRG",55,0)
 N FILEXT,IEN,SITEID,MAGXX,MAGFILE,MAGFILE1,MAGFILE2,PACS,RIEN,ZNODE
"RTN","MAGQBPRG",56,0)
 N FILETYPE,CPTR,JBPTR,CPOK,BNODE,ALTPATH,NMSPC,PLACE,RDHOLD,XX
"RTN","MAGQBPRG",57,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPRG",58,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBPRG",59,0)
 S U="^",(MAGFILE2,RESULT)=""
"RTN","MAGQBPRG",60,0)
 S FNAM=$$UPPER^MAGQE4(FNAM)
"RTN","MAGQBPRG",61,0)
 S ^TMP("MAGQ",$J,"PRG","LAST")=FILEPATH_U_FNAM_U_EXT_U_NETLOC_U_RADHOLD
"RTN","MAGQBPRG",62,0)
 I FNAM'?1.5A1.13N1"."1.3E  D  Q  ;LATER ADD EXT VERIFY USING 2005.02
"RTN","MAGQBPRG",63,0)
 . D ELOG(FNAM,FILEPATH) S RESULT="-3^^11" Q  ;'IMAGE FILE
"RTN","MAGQBPRG",64,0)
 S SITEID=$$UPPER^MAGQE4($$INIS^MAGQBPG2(PLACE))
"RTN","MAGQBPRG",65,0)
 S NMSPC=$TR($P(FNAM,"."),"0123456789","")
"RTN","MAGQBPRG",66,0)
 S FILEPATH=$$UPPER^MAGQE4(FILEPATH)
"RTN","MAGQBPRG",67,0)
 I SITEID'[NMSPC D ELOG(FNAM,FILEPATH) S RESULT="-3^^10" Q  ;FOREIGN FILE
"RTN","MAGQBPRG",68,0)
 S IEN=$O(^MAG(2005,"F",$P(FNAM,"."),""))
"RTN","MAGQBPRG",69,0)
 S:'IEN IEN=$O(^MAG(2005.1,"F",$P(FNAM,"."),""))
"RTN","MAGQBPRG",70,0)
 I 'IEN S RESULT="1^^9^^^"_IEN Q
"RTN","MAGQBPRG",71,0)
 S FTYPE=$$FTYPE(EXT)
"RTN","MAGQBPRG",72,0)
 S JBPTR=$$JBPTR(IEN,FTYPE)
"RTN","MAGQBPRG",73,0)
 ;PURGE UNCONDITIONALLY IF NO 2005 ENTRY
"RTN","MAGQBPRG",74,0)
 I '$D(^MAG(2005,IEN,0)) D  Q
"RTN","MAGQBPRG",75,0)
 . I $D(^MAG(2005.1,IEN,0)) D  Q
"RTN","MAGQBPRG",76,0)
 . . I ('JBPTR&($P($G(^MAG(2005.2,+$$CWP^MAGBAPI(PLACE),0)),U,6)="1"))  D
"RTN","MAGQBPRG",77,0)
 . . . S XX=$$JUKEBOX^MAGBAPI(IEN,PLACE)
"RTN","MAGQBPRG",78,0)
 . . . S RESULT="-2^^9^^^"_IEN
"RTN","MAGQBPRG",79,0)
 . . . Q
"RTN","MAGQBPRG",80,0)
 . . E  D 
"RTN","MAGQBPRG",81,0)
 . . . I JBPTR S RESULT="5^^16^"_$$JBPATH(FNAM,JBPTR)_U_$$JBPATH(FNAM,JBPTR)_U_IEN
"RTN","MAGQBPRG",82,0)
 . . . E  S RESULT="-1^^17"
"RTN","MAGQBPRG",83,0)
 . . . Q
"RTN","MAGQBPRG",84,0)
 . E  S RESULT="1^^9^^^"_IEN
"RTN","MAGQBPRG",85,0)
 . Q
"RTN","MAGQBPRG",86,0)
 I PLACE'=$$PLACE^MAGBAPI(+$P($G(^MAG(2005,IEN,100)),U,3)) D  Q
"RTN","MAGQBPRG",87,0)
 . S RESULT="-3^^15" Q  ;Foreign Place
"RTN","MAGQBPRG",88,0)
 S ZNODE=^MAG(2005,IEN,0)
"RTN","MAGQBPRG",89,0)
 I $P(ZNODE,U,12)="1" S RESULT="-1^^14" Q  ; Duplicate Image/Archive entry 
"RTN","MAGQBPRG",90,0)
 S BNODE=$S(FTYPE="BIG":$G(^MAG(2005,IEN,"FBIG")),1:"")
"RTN","MAGQBPRG",91,0)
 ; NEXT PROCESS MAGNETIC PTR~LESS
"RTN","MAGQBPRG",92,0)
 S CPTR=$$CHKCP($S(FTYPE="BIG":BNODE,1:ZNODE),FTYPE)
"RTN","MAGQBPRG",93,0)
 I 'CPTR D  Q
"RTN","MAGQBPRG",94,0)
 . D CPUPD(FTYPE,IEN,FILEPATH,FNAM)
"RTN","MAGQBPRG",95,0)
 . I 'JBPTR,$P($G(^MAG(2005.2,+$$CWP^MAGBAPI(PLACE),0)),U,6)="1" D
"RTN","MAGQBPRG",96,0)
 . . S XX=$$JUKEBOX^MAGBAPI(IEN,PLACE)
"RTN","MAGQBPRG",97,0)
 . S RESULT="-1^^7^^"_JBPTR_U_IEN ;$S(JBPTR:JBPTR,1:XX)_U_IEN
"RTN","MAGQBPRG",98,0)
 S CPOK=$S('CPTR:0,1:$$CPOK(FTYPE,.ALTPATH,FILEPATH,IEN))
"RTN","MAGQBPRG",99,0)
 S ALTPATH=ALTPATH_FNAM
"RTN","MAGQBPRG",100,0)
 S PACS=$S($D(^MAG(2005,IEN,"PACS")):1,1:0)
"RTN","MAGQBPRG",101,0)
 I 'CPOK,JBPTR D  Q
"RTN","MAGQBPRG",102,0)
 . S RESULT="3^"_PACS_"^6^"_ALTPATH_U_$$JBPATH(FNAM,JBPTR)_U_IEN
"RTN","MAGQBPRG",103,0)
 I 'JBPTR D  Q
"RTN","MAGQBPRG",104,0)
 . I $P($G(^MAG(2005.2,+$$CWP^MAGBAPI(PLACE),0)),U,6)="1" D
"RTN","MAGQBPRG",105,0)
 . . S XX=$$JUKEBOX^MAGBAPI(IEN,PLACE)
"RTN","MAGQBPRG",106,0)
 . . S RESULT="-1^^7^^"_JBPTR_U_IEN ;$S(JBPTR:JBPTR,1:XX)_U_IEN
"RTN","MAGQBPRG",107,0)
 . . Q
"RTN","MAGQBPRG",108,0)
 . E  S RESULT="-1^^17"
"RTN","MAGQBPRG",109,0)
 . Q
"RTN","MAGQBPRG",110,0)
 S RESULT="1^"_PACS_"^8^^"_$$JBPATH(FNAM,JBPTR)_U_IEN
"RTN","MAGQBPRG",111,0)
 Q
"RTN","MAGQBPRG",112,0)
 ;
"RTN","MAGQBPRG",113,0)
LASTNP(TYPE) ;
"RTN","MAGQBPRG",114,0)
 I TYPE="BIG" Q $S($P(ZNODE,U,3,4)="^":1,1:0)
"RTN","MAGQBPRG",115,0)
 I TYPE="ABS" Q $S((($P(ZNODE,U,3)="")&($P(BNODE,U)="")):1,1:0)
"RTN","MAGQBPRG",116,0)
 Q $S((($P(ZNODE,U,4)="")&($P(BNODE,U)="")):1,1:0)
"RTN","MAGQBPRG",117,0)
JBPATH(FN,NL) ;
"RTN","MAGQBPRG",118,0)
 Q $P($G(^MAG(2005.2,NL,0)),U,2)_$$DIRHASH^MAGFILEB(FN,NL)_FN
"RTN","MAGQBPRG",119,0)
WXCPT(RESULT,XPACS,TYPE) ;Check for Worm Exceptions
"RTN","MAGQBPRG",120,0)
 ;                        when no Worm reference in 2005
"RTN","MAGQBPRG",121,0)
 ;NO JUKEBOX Q:1 ????
"RTN","MAGQBPRG",122,0)
 ;SITE PARAMETER EXCEPTIONS
"RTN","MAGQBPRG",123,0)
 ; ALL           "JBEX";1
"RTN","MAGQBPRG",124,0)
 ; ALL PACS      "JBEX";2
"RTN","MAGQBPRG",125,0)
 ; ALL PACS BIG  "JBEX";3
"RTN","MAGQBPRG",126,0)
 ; ALL PACS BIG IF TGA PRESENT ON MAGNETIC
"RTN","MAGQBPRG",127,0)
 ; ALL BIG NON PACS "JBEX";4
"RTN","MAGQBPRG",128,0)
 N PARNODE,RY
"RTN","MAGQBPRG",129,0)
 ; I '$D(^MAG(2006.1,PLACE,"JBEX")) D  Q
"RTN","MAGQBPRG",130,0)
 S $P(RESULT,U)="-2^"_XPACS_"^4"  ;NO WXCPT - We no longer support this activity
"RTN","MAGQBPRG",131,0)
 S PARNODE=$G(^MAG(2006.1,1,"JBEX"))
"RTN","MAGQBPRG",132,0)
 I +$P(PARNODE,U)?1"1" S $P(RESULT,U)="6^"_XPACS_"^4" Q  ;ALL
"RTN","MAGQBPRG",133,0)
 I +$P(PARNODE,U)?1"2" S $P(RESULT,U)="6^"_XPACS_"^4" D  Q  ;ALL
"RTN","MAGQBPRG",134,0)
 . S ^XUSEC("MAG DELETE",DUZ)=""
"RTN","MAGQBPRG",135,0)
 . D DELETE^MAGGTID(.RY,IEN,0)
"RTN","MAGQBPRG",136,0)
 . S ^TMP("MAGQ",$J,IEN)=RY(0)
"RTN","MAGQBPRG",137,0)
 . K RY
"RTN","MAGQBPRG",138,0)
 I XPACS D  Q
"RTN","MAGQBPRG",139,0)
 . I $P(PARNODE,U,2) S $P(RESULT,U)="6^1^4" Q  ;ALL PACS
"RTN","MAGQBPRG",140,0)
 . I TYPE="BIG" D 
"RTN","MAGQBPRG",141,0)
 . . I +$P(PARNODE,U,3) S $P(RESULT,U)="6^1^4" Q  ;ALL BIG PACS
"RTN","MAGQBPRG",142,0)
 . . I +$P(PARNODE,U,6) S $P(RESULT,U)="2^1^4" Q  ;BIG PACS IF TGA 
"RTN","MAGQBPRG",143,0)
 . I $P(RESULT,U)="" D
"RTN","MAGQBPRG",144,0)
 . . I $P($G(^MAG(2005.2,+$$CWP^MAGBAPI(PLACE),0)),U,6)'="1" S RESULT="-1" Q
"RTN","MAGQBPRG",145,0)
 . . S RESULT="-2^1^4"
"RTN","MAGQBPRG",146,0)
 ;NON PACS
"RTN","MAGQBPRG",147,0)
 I ((TYPE="BIG")&(+$P(PARNODE,U,4))) S RESULT="6^0^4" Q
"RTN","MAGQBPRG",148,0)
 I $P($G(^MAG(2005.2,+$$CWP^MAGBAPI(PLACE),0)),U,6)'="1" S RESULT="-1^0^4" Q
"RTN","MAGQBPRG",149,0)
 S RESULT="-2^0^4"
"RTN","MAGQBPRG",150,0)
 Q
"RTN","MAGQBPRG",151,0)
 ;
"RTN","MAGQBPRG",152,0)
FTYPE(FEXT) ;
"RTN","MAGQBPRG",153,0)
 S FEXT=$$UPPER^MAGQE4(FEXT)
"RTN","MAGQBPRG",154,0)
 I "^ABS^"[("^"_FEXT_"^") Q "ABS"
"RTN","MAGQBPRG",155,0)
 I "^BIG^"[("^"_FEXT_"^") Q "BIG"
"RTN","MAGQBPRG",156,0)
 Q "FULL"
"RTN","MAGQBPRG",157,0)
CHKCP(NODE,TYPE) ;
"RTN","MAGQBPRG",158,0)
 N PIECE,CP
"RTN","MAGQBPRG",159,0)
 S PIECE=$S(TYPE="ABS":4,TYPE="BIG":1,TYPE="FULL":3,1:0)
"RTN","MAGQBPRG",160,0)
 Q $P(NODE,U,PIECE)
"RTN","MAGQBPRG",161,0)
JBPTR(MAGIEN,TYPE) ;
"RTN","MAGQBPRG",162,0)
 N PTR
"RTN","MAGQBPRG",163,0)
 I TYPE="BIG" D
"RTN","MAGQBPRG",164,0)
 . S PTR=+$P($G(^MAG(2005,MAGIEN,"FBIG")),"^",2)
"RTN","MAGQBPRG",165,0)
 . S:'PTR PTR=+$P($G(^MAG(2005.1,MAGIEN,"FBIG")),"^",2)
"RTN","MAGQBPRG",166,0)
 E  D
"RTN","MAGQBPRG",167,0)
 . S PTR=+$P($G(^MAG(2005,MAGIEN,0)),"^",5)
"RTN","MAGQBPRG",168,0)
 . S:'PTR PTR=+$P($G(^MAG(2005.1,MAGIEN,"FBIG")),"^",2)
"RTN","MAGQBPRG",169,0)
 Q $S($P($G(^MAG(2005.2,PTR,0)),U,6)=1:PTR,1:0)
"RTN","MAGQBPRG",170,0)
RDHOLD(IEN) ;
"RTN","MAGQBPRG",171,0)
 N HOLD,RIEN
"RTN","MAGQBPRG",172,0)
 S RIEN=$G(^MAG(2005,IEN,2))
"RTN","MAGQBPRG",173,0)
 Q:$P(RIEN,"^",6)'=74 0
"RTN","MAGQBPRG",174,0)
 S HOLD=$G(^RARPT($P(RIEN,"^",7),"NOPURGE"))
"RTN","MAGQBPRG",175,0)
 Q $S($$UPPER^MAGQE4(HOLD)="N":1,1:0)
"RTN","MAGQBPRG",176,0)
CPOK(TYPE,ALTPATH,FILEPATH,IEN) ;
"RTN","MAGQBPRG",177,0)
 N MAGXX,PIECE,NODE,LOC
"RTN","MAGQBPRG",178,0)
 S MAGXX=IEN
"RTN","MAGQBPRG",179,0)
 S PIECE=$S(TYPE="ABS":4,TYPE="BIG":1,TYPE="FULL":3,1:0)
"RTN","MAGQBPRG",180,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPRG",181,0)
 S LOC=$P($G(^MAG(2005,IEN,NODE)),U,PIECE)
"RTN","MAGQBPRG",182,0)
 Q:'LOC 0
"RTN","MAGQBPRG",183,0)
 S ALTPATH=$$UPPER^MAGQE4($P($G(^MAG(2005.2,LOC,0)),U,2)_$$DIRHASH^MAGFILEB(FNAM,LOC))
"RTN","MAGQBPRG",184,0)
 Q $S(ALTPATH=FILEPATH:1,1:0)
"RTN","MAGQBPRG",185,0)
CPUPD(TYPE,IEN,FP,FN) ;
"RTN","MAGQBPRG",186,0)
 N PIECE,CP,NODE,LOC
"RTN","MAGQBPRG",187,0)
 S PIECE=$S(TYPE="ABS":4,TYPE="BIG":1,TYPE="FULL":3,1:0)
"RTN","MAGQBPRG",188,0)
 S NODE=$S(TYPE="BIG":"FBIG",1:0)
"RTN","MAGQBPRG",189,0)
 S LOC=$$UNHASH(FN,FP)
"RTN","MAGQBPRG",190,0)
 I (PIECE=0)!(+LOC=0) D ELOG(FN,FP) Q
"RTN","MAGQBPRG",191,0)
 S $P(^MAG(2005,IEN,NODE),U,PIECE)=LOC
"RTN","MAGQBPRG",192,0)
 Q
"RTN","MAGQBPRG",193,0)
CUPD(RESULT,FILEPATH,FILENAME,EXT,IEN) ; RPC[MAGQ CUPDTE]
"RTN","MAGQBPRG",194,0)
 N TYPE
"RTN","MAGQBPRG",195,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPRG",196,0)
 S TYPE=$$FTYPE(EXT)
"RTN","MAGQBPRG",197,0)
 D CPUPD(TYPE,IEN,FILEPATH,FILENAME)
"RTN","MAGQBPRG",198,0)
 Q
"RTN","MAGQBPRG",199,0)
UNHASH(FN,FP) ; RETURN NETWORK LOCATION NUMBER
"RTN","MAGQBPRG",200,0)
 N SHARE,HASH
"RTN","MAGQBPRG",201,0)
 S SHARE=$S(FP[":":$P(FP,"\",1,2)_"\",1:$P(FP,"\",1,4)_"\")
"RTN","MAGQBPRG",202,0)
 S HASH=$S($P(FP,SHARE,2)["\":"Y",1:"")
"RTN","MAGQBPRG",203,0)
 Q $$SHNAM(SHARE,HASH)
"RTN","MAGQBPRG",204,0)
ELOG(FN,FP) ;
"RTN","MAGQBPRG",205,0)
 N INDX
"RTN","MAGQBPRG",206,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPRG",207,0)
 S INDX=+$O(^TMP("MAGQ",$J,"PRG",FN,99999),-1)+1
"RTN","MAGQBPRG",208,0)
 S ^TMP("MAGQ",$J,"PRG",FN,INDX)=FN_"^"_FP
"RTN","MAGQBPRG",209,0)
 Q
"RTN","MAGQBPRG",210,0)
ELOGR(RESULT) ;[MAGQ ELOGR] - Error log report and purge
"RTN","MAGQBPRG",211,0)
 N FN,INDX,CNT
"RTN","MAGQBPRG",212,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBPRG",213,0)
 S FN="",CNT=0
"RTN","MAGQBPRG",214,0)
 F  S FN=$O(^TMP("MAGQ",$J,"PRG",FN)) Q:FN=""  D
"RTN","MAGQBPRG",215,0)
 . S INDX=""
"RTN","MAGQBPRG",216,0)
 . F  S INDX=$O(^TMP("MAGQ",$J,"PRG",FN,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBPRG",217,0)
 . . S CNT=CNT+1,RESULT(CNT)=^TMP("MAGQ",$J,"PRG",FN,INDX)
"RTN","MAGQBPRG",218,0)
 S RESULT(0)=CNT
"RTN","MAGQBPRG",219,0)
 K ^TMP("MAGQ",$J,"PRG")
"RTN","MAGQBPRG",220,0)
 Q
"RTN","MAGQBPRG",221,0)
SHNAM(SHARE,HASH) ;
"RTN","MAGQBPRG",222,0)
 N NUM,ONLINE,ZNODE
"RTN","MAGQBPRG",223,0)
 S (NUM,ONLINE)=0
"RTN","MAGQBPRG",224,0)
 Q:((SHARE="")!(SHARE[":")) ""
"RTN","MAGQBPRG",225,0)
 F  S NUM=$O(^MAG(2005.2,"AC",SHARE,NUM)) Q:'NUM  D  Q:ONLINE
"RTN","MAGQBPRG",226,0)
 . S ZNODE=^MAG(2005.2,NUM,0)
"RTN","MAGQBPRG",227,0)
 . Q:($P(ZNODE,"^",6)'="1")
"RTN","MAGQBPRG",228,0)
 . Q:($P(ZNODE,"^",8)'=HASH)
"RTN","MAGQBPRG",229,0)
 . S ONLINE="1"
"RTN","MAGQBPRG",230,0)
 Q NUM
"RTN","MAGQBTM")
0^17^B79858508
"RTN","MAGQBTM",1,0)
MAGQBTM ;WOIFO/RMP - REMOTE Task SERVER Program [ 03/25/2001 11:20 ]
"RTN","MAGQBTM",2,0)
 ;;3.0;IMAGING;**1,7,8,20,81**;May 17, 2007
"RTN","MAGQBTM",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBTM",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBTM",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBTM",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBTM",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBTM",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBTM",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBTM",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBTM",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBTM",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBTM",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBTM",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBTM",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBTM",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBTM",17,0)
 ;;
"RTN","MAGQBTM",18,0)
 ;
"RTN","MAGQBTM",19,0)
ENTRY(RESULT,WSTAT,PROCESS) ; RPC[MAGQ ABP]
"RTN","MAGQBTM",20,0)
 N X,SYSIEN,SYSNAME,NODE,INDX,CNT,PROC,%,QPTR,QCNT,VERS,EXEDATE,WSOS,PLACE,VOK
"RTN","MAGQBTM",21,0)
 D NOW^%DTC
"RTN","MAGQBTM",22,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",23,0)
 S (SYSIEN,CNT)=0,SYSNAME="",PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2))),VOK=""
"RTN","MAGQBTM",24,0)
 S $P(RESULT(0),U,6)=$D(^XUSEC("MAG SYSTEM",DUZ))
"RTN","MAGQBTM",25,0)
 Q:'$P(RESULT(0),U,6)
"RTN","MAGQBTM",26,0)
 S VERS=$P(WSTAT,U,2),EXEDATE=$P(WSTAT,U,3),WSOS=$P(WSTAT,U,4)
"RTN","MAGQBTM",27,0)
 S WSTAT=$P(WSTAT,U)
"RTN","MAGQBTM",28,0)
 S SYSIEN=$O(^MAG(2006.8,"C",PLACE,WSTAT,""))
"RTN","MAGQBTM",29,0)
 I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$$UPPER^MAGQE4(WSTAT),""))
"RTN","MAGQBTM",30,0)
 I 'SYSIEN D
"RTN","MAGQBTM",31,0)
 . N TRY
"RTN","MAGQBTM",32,0)
 . F TRY=1:1:$L(WSTAT,".") D  Q:SYSIEN?1.N
"RTN","MAGQBTM",33,0)
 . . S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$P(WSTAT,".",TRY),""))
"RTN","MAGQBTM",34,0)
 . . I 'SYSIEN S SYSIEN=$O(^MAG(2006.8,"C",PLACE,$$UPPER^MAGQE4($P(WSTAT,".",TRY)),""))
"RTN","MAGQBTM",35,0)
 Q:SYSIEN=""
"RTN","MAGQBTM",36,0)
 S $P(^MAG(2006.8,SYSIEN,1),U,2)=VERS
"RTN","MAGQBTM",37,0)
 S $P(^MAG(2006.8,SYSIEN,1),U,3)=EXEDATE
"RTN","MAGQBTM",38,0)
 S $P(^MAG(2006.8,SYSIEN,1),U,4)=WSOS
"RTN","MAGQBTM",39,0)
 S VERS=$P(VERS,".",1,2)_"P"_$P(VERS,".",3)
"RTN","MAGQBTM",40,0)
 D VOKR^MAGQBUT4(.VOK,VERS)
"RTN","MAGQBTM",41,0)
 Q:'$P(VOK,U)
"RTN","MAGQBTM",42,0)
 S ^TMP("MAGQN",$J,0)=SYSIEN_"^"_WSTAT
"RTN","MAGQBTM",43,0)
 S NODE=^MAG(2006.8,SYSIEN,0)
"RTN","MAGQBTM",44,0)
 S SYSNAME=$P(NODE,U)
"RTN","MAGQBTM",45,0)
 I SYSNAME="" D  Q
"RTN","MAGQBTM",46,0)
 . S $P(RESULT(0),U,1,2)="-1^No Background Processor parameters on system"
"RTN","MAGQBTM",47,0)
 I $P(NODE,U,12)'=1 D  Q
"RTN","MAGQBTM",48,0)
 . S $P(RESULT(0),U,1,2)="-1^Not assigned as a Background Processor"
"RTN","MAGQBTM",49,0)
 F PROC="ABSTRACT","JUKEBOX","JBTOHD","DELETE","PREFET","GCC","IMPORT" D
"RTN","MAGQBTM",50,0)
 . N FNUM,PIECE
"RTN","MAGQBTM",51,0)
 . S FNUM=$$FNUM(PROC)
"RTN","MAGQBTM",52,0)
 . S PIECE=$$GET1^DID(2006.8,FNUM,"","GLOBAL SUBSCRIPT LOCATION")
"RTN","MAGQBTM",53,0)
 . S PIECE=$P(PIECE,";",2)
"RTN","MAGQBTM",54,0)
 . I $P(NODE,U,PIECE)="1" D
"RTN","MAGQBTM",55,0)
 . . N QCNT,QPTR
"RTN","MAGQBTM",56,0)
 . . D ADD^MAGBAPI(0,PROC,PLACE)
"RTN","MAGQBTM",57,0)
 . . S QPTR=$O(^MAGQUEUE(2006.031,"C",PLACE,PROC,""))
"RTN","MAGQBTM",58,0)
 . . S QCNT=$P($G(^MAGQUEUE(2006.031,+QPTR,0)),U,3)
"RTN","MAGQBTM",59,0)
 . . S CNT=CNT+1
"RTN","MAGQBTM",60,0)
 . . S RESULT(CNT)=PROC_U_QCNT
"RTN","MAGQBTM",61,0)
 . . Q
"RTN","MAGQBTM",62,0)
 . Q
"RTN","MAGQBTM",63,0)
 S $P(RESULT(0),U,1,5)="0^BP List^PID: "_$$BASE^XLFUTL($J,10,16)_"^"_SYSNAME_U_WSTAT
"RTN","MAGQBTM",64,0)
 Q
"RTN","MAGQBTM",65,0)
FNUM(PROCESS) ;
"RTN","MAGQBTM",66,0)
 Q:PROC="ABSTRACT" 12
"RTN","MAGQBTM",67,0)
 Q:PROC="JUKEBOX" 13
"RTN","MAGQBTM",68,0)
 Q:PROC="JBTOHD" 14
"RTN","MAGQBTM",69,0)
 Q:PROC="PREFET" 15
"RTN","MAGQBTM",70,0)
 Q:PROC="IMPORT" 16
"RTN","MAGQBTM",71,0)
 Q:PROC="GCC" 17
"RTN","MAGQBTM",72,0)
 Q:PROC="DELETE" 20
"RTN","MAGQBTM",73,0)
 Q 0
"RTN","MAGQBTM",74,0)
GETQUE(RESULT,ACTION) ; RPC[MAGQ GET]
"RTN","MAGQBTM",75,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",76,0)
 D @(ACTION_"(.RESULT)")
"RTN","MAGQBTM",77,0)
 I +RESULT<0 D
"RTN","MAGQBTM",78,0)
 . D NOW^%DTC
"RTN","MAGQBTM",79,0)
 . D QSTAT($P(RESULT,U,2),$P(RESULT,U,3),ACTION,$$PLACE^MAGBAPI(+$G(DUZ(2))))
"RTN","MAGQBTM",80,0)
 . D QPTER(ACTION,$P(RESULT,U,2))
"RTN","MAGQBTM",81,0)
 Q
"RTN","MAGQBTM",82,0)
ABSTRACT(RESULT) ;
"RTN","MAGQBTM",83,0)
 D DEQUEUE("ABSTRACT",.RESULT) Q
"RTN","MAGQBTM",84,0)
JUKEBOX(RESULT) ;
"RTN","MAGQBTM",85,0)
 D DEQUEUE("JUKEBOX",.RESULT) Q
"RTN","MAGQBTM",86,0)
JBTOHD(RESULT) ;
"RTN","MAGQBTM",87,0)
 D DEQUEUE("JBTOHD",.RESULT) Q
"RTN","MAGQBTM",88,0)
GCC(RESULT) ;
"RTN","MAGQBTM",89,0)
 D DEQUEUE("GCC",.RESULT) Q
"RTN","MAGQBTM",90,0)
DELETE(RESULT) ;
"RTN","MAGQBTM",91,0)
 D DEQUEUE("DELETE",.RESULT) Q
"RTN","MAGQBTM",92,0)
PREFET(RESULT) ;
"RTN","MAGQBTM",93,0)
 D DEQUEUE("PREFET",.RESULT) Q
"RTN","MAGQBTM",94,0)
IMPORT(RESULT) ;
"RTN","MAGQBTM",95,0)
 D DEQUEUE("IMPORT",.RESULT) Q
"RTN","MAGQBTM",96,0)
DEQUEUE(QUE,RESULT) ;
"RTN","MAGQBTM",97,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",98,0)
 N QPTR,QPTR2,ROU,MAGIEN,ZNODE,MSG,IMQUE,PLACE
"RTN","MAGQBTM",99,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBTM",100,0)
 S QPTR2=$O(^MAGQUEUE(2006.031,"C",PLACE,QUE,""))
"RTN","MAGQBTM",101,0)
 S QPTR=$S(QPTR2:$P(^MAGQUEUE(2006.031,QPTR2,0),U,2),1:"")
"RTN","MAGQBTM",102,0)
 S QPTR=$O(^MAGQUEUE(2006.03,"C",PLACE,QUE,QPTR))
"RTN","MAGQBTM",103,0)
 I QPTR="" D  Q
"RTN","MAGQBTM",104,0)
 . S RESULT="0"_U_QPTR2_U_"No "_QUE_" "_QPTR2_" to process."
"RTN","MAGQBTM",105,0)
 D QSTAT(QPTR,QUE_" in progress.",QUE,PLACE)
"RTN","MAGQBTM",106,0)
 S ZNODE=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",107,0)
 I ZNODE="" S RESULT=-101_U_QPTR_U_"Queue Record does not exist" Q
"RTN","MAGQBTM",108,0)
 I QUE="IMPORT" D ENTRY^MAGQBIM(QPTR,QUE,QPTR2,ZNODE,.RESULT) Q
"RTN","MAGQBTM",109,0)
 S MAGIEN=$P(ZNODE,"^",7)
"RTN","MAGQBTM",110,0)
 I ("^DELETE^JUKEBOX^")'[(U_QUE_U),(('(+MAGIEN))!('$D(^MAG(2005,+MAGIEN,0)))!($P(ZNODE,U)'=QUE)) D  Q
"RTN","MAGQBTM",111,0)
 . I $D(^MAG(2005.1,+MAGIEN,0)) D
"RTN","MAGQBTM",112,0)
 . . S MSG="Image Record Deleted and in archive file."
"RTN","MAGQBTM",113,0)
 . E  S MSG="No valid image file number to process."
"RTN","MAGQBTM",114,0)
 . S RESULT=-101_U_QPTR_U_MSG
"RTN","MAGQBTM",115,0)
 S ROU=$$RESET(QUE)
"RTN","MAGQBTM",116,0)
 I ROU="" S RESULT="-1"_U_QPTR_U_QUE_" Is an inactive process" Q
"RTN","MAGQBTM",117,0)
 D @("ENTRY^"_ROU_"(.RESULT,QPTR)")
"RTN","MAGQBTM",118,0)
 Q
"RTN","MAGQBTM",119,0)
QSTAT(QPTR,MESSAGE,ACTION,PLACE) ;
"RTN","MAGQBTM",120,0)
 N ZNODE
"RTN","MAGQBTM",121,0)
 Q:QPTR=""
"RTN","MAGQBTM",122,0)
 S MESSAGE=$TR(MESSAGE,":;<>.?/\'()*^%$#@!0123456789","")
"RTN","MAGQBTM",123,0)
 Q:'$D(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",124,0)
 S ZNODE=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",125,0)
 D NOW^%DTC
"RTN","MAGQBTM",126,0)
 I $P(ZNODE,U,5)]"" D
"RTN","MAGQBTM",127,0)
 . K ^MAGQUEUE(2006.03,"D",PLACE,$P(ZNODE,U),$E($P(ZNODE,U,5),1,30),QPTR) Q
"RTN","MAGQBTM",128,0)
 S ^MAGQUEUE(2006.03,"D",PLACE,$P(ZNODE,U),$E(MESSAGE,1,30),QPTR)=""
"RTN","MAGQBTM",129,0)
 S $P(^MAGQUEUE(2006.03,QPTR,0),U,5,6)=$P(MESSAGE,U)_U_%
"RTN","MAGQBTM",130,0)
 I ACTION["IMPORT" D STAT^MAGQBIM(QPTR,%,MESSAGE)
"RTN","MAGQBTM",131,0)
 Q
"RTN","MAGQBTM",132,0)
QPTER(QUEUE,QPTR) ;
"RTN","MAGQBTM",133,0)
 N QREC,PREV,PNODE,PLACE
"RTN","MAGQBTM",134,0)
 S PLACE=$P($G(^MAGQUEUE(2006.03,QPTR,0)),U,12)
"RTN","MAGQBTM",135,0)
 S PLACE=$S(PLACE:PLACE,1:$$PLACE^MAGBAPI(+$G(DUZ(2))))
"RTN","MAGQBTM",136,0)
 S QREC=$O(^MAGQUEUE(2006.031,"C",PLACE,QUEUE,""))
"RTN","MAGQBTM",137,0)
 S PREV=$S(QREC:$P(^MAGQUEUE(2006.031,QREC,0),U,2),1:"")
"RTN","MAGQBTM",138,0)
 I PREV'=QPTR D  Q
"RTN","MAGQBTM",139,0)
 . D ADD^MAGBAPI(-1,QUEUE,PLACE)
"RTN","MAGQBTM",140,0)
 . L +^MAGQUEUE(2006.031,QREC,0)
"RTN","MAGQBTM",141,0)
 . S $P(^MAGQUEUE(2006.031,QREC,0),U,2)=QPTR
"RTN","MAGQBTM",142,0)
 . L -^MAGQUEUE(2006.031,QREC,0)
"RTN","MAGQBTM",143,0)
 . Q
"RTN","MAGQBTM",144,0)
 D ADD^MAGBAPI(0,QUEUE,PLACE)
"RTN","MAGQBTM",145,0)
 Q
"RTN","MAGQBTM",146,0)
RESET(QUEUE) ; Set Routine parameter
"RTN","MAGQBTM",147,0)
 Q:QUEUE="ABSTRACT" "MAGQBAB"
"RTN","MAGQBTM",148,0)
 Q:QUEUE="JUKEBOX" "MAGQBJB"
"RTN","MAGQBTM",149,0)
 Q:QUEUE="JBTOHD" "MAGQBJH"
"RTN","MAGQBTM",150,0)
 Q:QUEUE="DELETE" "MAGQBD"
"RTN","MAGQBTM",151,0)
 Q:QUEUE="PREFET" "MAGQBJH"
"RTN","MAGQBTM",152,0)
 Q:QUEUE="IMPORT" "MAGQBIM"
"RTN","MAGQBTM",153,0)
 Q:QUEUE="GCC" "MAGQBGCC"
"RTN","MAGQBTM",154,0)
 Q ""
"RTN","MAGQBTM",155,0)
RQCNT(PLACE) ;
"RTN","MAGQBTM",156,0)
 N QIEN,QPTR,QNAM
"RTN","MAGQBTM",157,0)
 S QNAM=""
"RTN","MAGQBTM",158,0)
 F  S QNAM=$O(^MAGQUEUE(2006.031,"C",PLACE,QNAM)) Q:QNAM=""  D
"RTN","MAGQBTM",159,0)
 . S QIEN=$O(^MAGQUEUE(2006.031,"C",PLACE,QNAM,"")) Q:QIEN'?1.N
"RTN","MAGQBTM",160,0)
 . S QPTR=+$P(^MAGQUEUE(2006.031,QIEN,0),U,2)
"RTN","MAGQBTM",161,0)
 . S $P(^MAGQUEUE(2006.031,QIEN,0),U,3)=""
"RTN","MAGQBTM",162,0)
 . D ADD^MAGBAPI(0,QNAM,PLACE)
"RTN","MAGQBTM",163,0)
 . Q
"RTN","MAGQBTM",164,0)
 Q
"RTN","MAGQBTM",165,0)
QUPDTE(RESULT,QPTR,UPDATE) ;RPC[MAGQ QUD]
"RTN","MAGQBTM",166,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",167,0)
 N NODE,STAT,TYPE,VPTR,MPTR,IEN,IDFN,MSG,PLACE
"RTN","MAGQBTM",168,0)
 S NODE=$G(^MAGQUEUE(2006.03,QPTR,0))
"RTN","MAGQBTM",169,0)
 S PLACE=$P(NODE,U,12)
"RTN","MAGQBTM",170,0)
 S RESULT="1^QUEUE UPDATE COMPLETE"
"RTN","MAGQBTM",171,0)
 S STAT=$P(UPDATE,U)
"RTN","MAGQBTM",172,0)
 S TYPE=$P(NODE,U)
"RTN","MAGQBTM",173,0)
 S MSG=$S($P(UPDATE,U,2)="":TYPE_" Process Error",1:$P(UPDATE,U,2))
"RTN","MAGQBTM",174,0)
 D QSTAT(QPTR,MSG,TYPE,PLACE)
"RTN","MAGQBTM",175,0)
 D QPTER(TYPE,QPTR)
"RTN","MAGQBTM",176,0)
 I STAT<0 Q
"RTN","MAGQBTM",177,0)
 I "^DELETE^"[("^"_TYPE_"^") D DQUE^MAGQBUT(QPTR) Q
"RTN","MAGQBTM",178,0)
 I "^IMPORT^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBTM",179,0)
 . D DQUE^MAGQBUT(QPTR)
"RTN","MAGQBTM",180,0)
 . S DIK="^MAG(2006.034,",DA=QPTR D ^DIK
"RTN","MAGQBTM",181,0)
 . S DIK="^MAG(2006.041,",DA=QPTR D ^DIK
"RTN","MAGQBTM",182,0)
 . K DIK,DA
"RTN","MAGQBTM",183,0)
 . Q 
"RTN","MAGQBTM",184,0)
 S VPTR=$P(UPDATE,U,3)
"RTN","MAGQBTM",185,0)
 I VPTR?1.N D
"RTN","MAGQBTM",186,0)
 . S MPTR=$P(NODE,U,7)
"RTN","MAGQBTM",187,0)
 . I "^ABSTRACT^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBTM",188,0)
 . . S $P(^MAG(2005,MPTR,0),U,4)=VPTR
"RTN","MAGQBTM",189,0)
 . . S X=$$JUKEBOX^MAGBAPI(MPTR,PLACE)
"RTN","MAGQBTM",190,0)
 . . D DQUE^MAGQBUT(QPTR) Q
"RTN","MAGQBTM",191,0)
 . I ("^JBTOHD^"[("^"_TYPE_"^"))!("^PREFET^"[("^"_TYPE_"^")) D  Q
"RTN","MAGQBTM",192,0)
 . . I "^FULL^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,0),U,3)=VPTR
"RTN","MAGQBTM",193,0)
 . . I "^ABSTRACT^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,0),U,4)=VPTR
"RTN","MAGQBTM",194,0)
 . . I "^BIG^"[$P(NODE,U,8) S $P(^MAG(2005,MPTR,"FBIG"),U)=VPTR
"RTN","MAGQBTM",195,0)
 . . D DQUE^MAGQBUT(QPTR) Q
"RTN","MAGQBTM",196,0)
 . I "^JUKEBOX^"[("^"_TYPE_"^") D  Q 
"RTN","MAGQBTM",197,0)
 . . I $P(UPDATE,U,2)["BIG" D  Q
"RTN","MAGQBTM",198,0)
 . . . S:$D(^MAG(2005,MPTR)) $P(^MAG(2005,MPTR,"FBIG"),U,2)=VPTR
"RTN","MAGQBTM",199,0)
 . . . S:$D(^MAG(2005.1,MPTR)) $P(^MAG(2005.1,MPTR,"FBIG"),U,2)=VPTR
"RTN","MAGQBTM",200,0)
 . . . D DQUE^MAGQBUT(QPTR) Q
"RTN","MAGQBTM",201,0)
 . . E  D
"RTN","MAGQBTM",202,0)
 . . . S:$D(^MAG(2005,MPTR)) $P(^MAG(2005,MPTR,0),U,5)=VPTR
"RTN","MAGQBTM",203,0)
 . . . S:$D(^MAG(2005.1,MPTR)) $P(^MAG(2005.1,MPTR,0),U,5)=VPTR
"RTN","MAGQBTM",204,0)
 . . . D DQUE^MAGQBUT(QPTR) Q
"RTN","MAGQBTM",205,0)
 . . Q
"RTN","MAGQBTM",206,0)
 . I "^GCC^"[("^"_TYPE_"^") D  Q
"RTN","MAGQBTM",207,0)
 . . D NOW^%DTC
"RTN","MAGQBTM",208,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",.01)=VPTR
"RTN","MAGQBTM",209,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",1)=%
"RTN","MAGQBTM",210,0)
 . . S FDA(2005.01,"+1,"_MPTR_",",2)=$P($$TRIM^MAGQBUT4($P(UPDATE,U,2))," ")
"RTN","MAGQBTM",211,0)
 . . D UPDATE^DIE("U","FDA","","MAGIMP")
"RTN","MAGQBTM",212,0)
 . . S IDFN=$P(^MAG(2005,MPTR,0),U,7)
"RTN","MAGQBTM",213,0)
 . . D ENTRY^MAGLOG("EXPORT->"_$P($G(^MAG(2005.2,VPTR,0)),U,2),$P(NODE,U,2),MPTR,"Document Imaging",IDFN,0)
"RTN","MAGQBTM",214,0)
 . . D DQUE^MAGQBUT(QPTR) Q
"RTN","MAGQBTM",215,0)
 . Q
"RTN","MAGQBTM",216,0)
 Q
"RTN","MAGQBTM",217,0)
REQUE(RESULT,QPTR) ;
"RTN","MAGQBTM",218,0)
 ; RPC[MAGQ REQ]
"RTN","MAGQBTM",219,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBTM",220,0)
 N PROC,NODE,INDX,PARAM,OPDUZ,STATUS,TRACKID,PLACE
"RTN","MAGQBTM",221,0)
 S INDX=$$TRIM^MAGQBUT4(QPTR),TRACKID=0
"RTN","MAGQBTM",222,0)
 S NODE=$G(^MAGQUEUE(2006.03,INDX,0))
"RTN","MAGQBTM",223,0)
 Q:NODE']""
"RTN","MAGQBTM",224,0)
 S PLACE=$P(NODE,U,12)
"RTN","MAGQBTM",225,0)
 Q:'PLACE
"RTN","MAGQBTM",226,0)
 S PROC=$P(NODE,U),STATUS=$P(NODE,U,5)
"RTN","MAGQBTM",227,0)
 I PROC'="IMPORT" D
"RTN","MAGQBTM",228,0)
 . D RQP(PROC,NODE,.PARAM)
"RTN","MAGQBTM",229,0)
 . S @("RESULT=$$"_PROC_"^MAGBAPI(PARAM,PLACE)")
"RTN","MAGQBTM",230,0)
 . Q
"RTN","MAGQBTM",231,0)
 E  D
"RTN","MAGQBTM",232,0)
 . S $P(PARAM,U,3)=+$P(NODE,U,9)+1
"RTN","MAGQBTM",233,0)
 . S $P(PARAM,U,4)=$S($P(NODE,U,11)?1N.N:$P(NODE,U,11),1:QPTR)
"RTN","MAGQBTM",234,0)
 . D TIDL^MAGQBIM($S($P(NODE,U,11)?1N.N:$P(NODE,U,11),1:QPTR),PROC,.TRACKID)
"RTN","MAGQBTM",235,0)
 . Q:TRACKID=0
"RTN","MAGQBTM",236,0)
 . S @("RESULT=$$"_PROC_"^MAGBAPI(PARAM,$P(NODE,U,10),TRACKID,PLACE)")
"RTN","MAGQBTM",237,0)
 Q:((PROC="IMPORT")&(TRACKID=0))
"RTN","MAGQBTM",238,0)
 D DQUE^MAGQBUT(INDX)
"RTN","MAGQBTM",239,0)
 Q
"RTN","MAGQBTM",240,0)
RQP(P,N,PAR) ;
"RTN","MAGQBTM",241,0)
 N P1,P2,P3,P4
"RTN","MAGQBTM",242,0)
 I ("^JBTOHD^PREFET^")[P S P1=$P(N,U,7),P2=$P(N,U,8),P3=+$P(N,U,9)+1,PAR=P1_U_P2_U_P3 Q
"RTN","MAGQBTM",243,0)
 I P["DELETE" S P1=$P(N,U,10),P2=+$P(N,U,9)+1,PAR=P2_U_P1 Q
"RTN","MAGQBTM",244,0)
 I P["GCC" D  Q
"RTN","MAGQBTM",245,0)
 . S P1=$P(N,U,7),P2=$P(N,U,10),P3=$P(N,U,11),P4=$P(N,U,9)+1,PAR=P1_U_P2_U_P3_U_P4 Q
"RTN","MAGQBTM",246,0)
 S P1=$P(N,U,7)_"^^",P2=+$P(N,U,9)+1,PAR=P1_P2 ;JUKEBOX + ABSTRACT
"RTN","MAGQBTM",247,0)
 Q
"RTN","MAGQBTM",248,0)
ERR ;
"RTN","MAGQBTM",249,0)
 N ERRXX
"RTN","MAGQBTM",250,0)
 S ERRXX=$$EC^%ZOSV
"RTN","MAGQBTM",251,0)
 D ^%ZTER
"RTN","MAGQBTM",252,0)
 D ^XUSCLEAN
"RTN","MAGQBTM",253,0)
 Q
"RTN","MAGQBUT1")
0^22^B76309021
"RTN","MAGQBUT1",1,0)
MAGQBUT1 ;WOIFO/RP; Utilities for Background [ 03/25/2001 11:20 ]
"RTN","MAGQBUT1",2,0)
 ;;3.0;IMAGING;**7,8,20,81**;May 17, 2007
"RTN","MAGQBUT1",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT1",17,0)
 ;;
"RTN","MAGQBUT1",18,0)
 Q
"RTN","MAGQBUT1",19,0)
BPPS(INPUT,WS,PROCESS) ;INPUT TRANSFORM FOR FILE 2006.8
"RTN","MAGQBUT1",20,0)
 N IEN,FND,WSNAME,WSNAME2,ZNODE,PIECE,MAGX,MAGY,PLACE
"RTN","MAGQBUT1",21,0)
 S U="^"
"RTN","MAGQBUT1",22,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT1",23,0)
 Q:'(+$P($G(^MAG(2006.8,WS,0)),U,12)) 0  ;NOT A BACKGROUND PROCESSOR
"RTN","MAGQBUT1",24,0)
 Q:'INPUT 1
"RTN","MAGQBUT1",25,0)
 S WSNAME=$$UPPER^MAGQE4($P($G(^MAG(2006.8,WS,1)),U)) ;Workstation Name
"RTN","MAGQBUT1",26,0)
 Q:$L(WSNAME)<3 0 ;BP WS NOT PROPERLY INSTALLED
"RTN","MAGQBUT1",27,0)
 Q:$O(^MAG(2006.8,"C",PLACE,WSNAME,""))'?1N.N 0
"RTN","MAGQBUT1",28,0)
 F MAGX=12,13,14,15,16,17,20 D  Q:MAGY=PROCESS
"RTN","MAGQBUT1",29,0)
 . S MAGY=$$GET1^DID(2006.8,MAGX,"","LABEL")
"RTN","MAGQBUT1",30,0)
 . D:MAGY=PROCESS
"RTN","MAGQBUT1",31,0)
 . . S PIECE=$$GET1^DID(2006.8,MAGX,"","GLOBAL SUBSCRIPT LOCATION")
"RTN","MAGQBUT1",32,0)
 Q:MAGY'=PROCESS 0
"RTN","MAGQBUT1",33,0)
 S PIECE=$P(PIECE,";",2)
"RTN","MAGQBUT1",34,0)
 S IEN=0,WSNAME2="",FND=0
"RTN","MAGQBUT1",35,0)
 F  S WSNAME2=$$UPPER^MAGQE4($O(^MAG(2006.8,"C",PLACE,WSNAME2))) Q:WSNAME2=""  D  Q:FND
"RTN","MAGQBUT1",36,0)
 . Q:WSNAME2=WSNAME
"RTN","MAGQBUT1",37,0)
 . S IEN=$O(^MAG(2006.8,"C",PLACE,WSNAME2,"")) Q:IEN'?1N.N
"RTN","MAGQBUT1",38,0)
 . S ZNODE=$G(^MAG(2006.8,IEN,0))
"RTN","MAGQBUT1",39,0)
 . Q:$P(ZNODE,"^",12)'="1"
"RTN","MAGQBUT1",40,0)
 . S:($P(ZNODE,"^",PIECE)="1") FND="1"
"RTN","MAGQBUT1",41,0)
 Q $S(FND="1":0,1:1)
"RTN","MAGQBUT1",42,0)
RSQUE(RESULT,IEN,QUEUE) ;[MAGQB RSQUE]
"RTN","MAGQBUT1",43,0)
 N PTR,PLACE
"RTN","MAGQBUT1",44,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT1",45,0)
 S PTR=$O(^MAGQUEUE(2006.031,"C",PLACE,QUEUE,""))
"RTN","MAGQBUT1",46,0)
 I $P(^MAGQUEUE(2006.031,PTR,0),"^")=QUEUE D
"RTN","MAGQBUT1",47,0)
 . S $P(^MAGQUEUE(2006.031,PTR,0),"^",2)=IEN
"RTN","MAGQBUT1",48,0)
 . ;D RQCNT^MAGQBTM(PLACE)
"RTN","MAGQBUT1",49,0)
 Q
"RTN","MAGQBUT1",50,0)
ICCL(SRVRCNT,NMESS,PLACE) ;UPDATE IMAGING DISTRIBUTION
"RTN","MAGQBUT1",51,0)
 N Y,LOC,INDEX,CNT,IEN,ARRAY,SUB1,SUB2,NAME
"RTN","MAGQBUT1",52,0)
 D NOW^%DTC S Y=% D DD^%DT
"RTN","MAGQBUT1",53,0)
 S LOC=$$KSP^XUPARAM("WHERE")
"RTN","MAGQBUT1",54,0)
 S CNT=1,^TMP($J,"MAGQ",CNT)="SITE: "_LOC
"RTN","MAGQBUT1",55,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="DATE: "_Y_" "_$G(^XMB("TIMEZONE"))
"RTN","MAGQBUT1",56,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="SENDER: "_$$PLNM^MAGQBUT5(PLACE)_" Imaging Background Processor"
"RTN","MAGQBUT1",57,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="Total Cache Free: "_$P(SRVRCNT,U,2)_" gigabytes"
"RTN","MAGQBUT1",58,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="Total Cache Available: "_$P(SRVRCNT,U,3)_" gigabytes"
"RTN","MAGQBUT1",59,0)
 I $P(SRVRCNT,U,4) S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="An Automatic Purge process has been Activated."
"RTN","MAGQBUT1",60,0)
 E  S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="The Automatic Purge process is NOT configured."
"RTN","MAGQBUT1",61,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="The "_$P(SRVRCNT,U)_" Imaging cache servers will"
"RTN","MAGQBUT1",62,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="require operator intervention to ensure continued"
"RTN","MAGQBUT1",63,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="availability.  The following MAG SERVER members"
"RTN","MAGQBUT1",64,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="are being notified:"
"RTN","MAGQBUT1",65,0)
 S INDEX=0,IEN=$$FIND1^DIC(3.8,"","MX","MAG SERVER","","","ERR")
"RTN","MAGQBUT1",66,0)
 Q:IEN'?1N.N
"RTN","MAGQBUT1",67,0)
 D GETS^DIQ(3.8,IEN_",","2*;11*;12*","","ARRAY")
"RTN","MAGQBUT1",68,0)
 S (SUB1,SUB2)=""
"RTN","MAGQBUT1",69,0)
 F  S SUB1=$O(ARRAY(SUB1)) Q:SUB1=""  D
"RTN","MAGQBUT1",70,0)
 . F  S SUB2=$O(ARRAY(SUB1,SUB2)) Q:SUB2=""  D
"RTN","MAGQBUT1",71,0)
 . . S NAME=$G(ARRAY(SUB1,SUB2,".01")) D:NAME'=""
"RTN","MAGQBUT1",72,0)
 . . . S CNT=CNT+1,^TMP($J,"MAGQ",8+CNT)=NAME
"RTN","MAGQBUT1",73,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="The next notifications will occur in:"
"RTN","MAGQBUT1",74,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)=NMESS
"RTN","MAGQBUT1",75,0)
 D MAILIT
"RTN","MAGQBUT1",76,0)
 S $P(^MAG(2006.1,$$PLACE^MAGBAPI($G(DUZ(2))),3),"^",11)=$$NOW^XLFDT
"RTN","MAGQBUT1",77,0)
 K ARRAY
"RTN","MAGQBUT1",78,0)
 Q
"RTN","MAGQBUT1",79,0)
MAILIT ;Send the report to the Clinical Application Time
"RTN","MAGQBUT1",80,0)
 N XMSUB
"RTN","MAGQBUT1",81,0)
 S XMSUB="Image Cache Critically Low at "_LOC
"RTN","MAGQBUT1",82,0)
MAILSHR ;Shared Mail server code
"RTN","MAGQBUT1",83,0)
 ;If dropping in...must manage XMSUB
"RTN","MAGQBUT1",84,0)
 N XMY,XMTEXT
"RTN","MAGQBUT1",85,0)
 S XMTEXT="^TMP($J,""MAGQ"","
"RTN","MAGQBUT1",86,0)
 S:$G(DUZ) XMY(DUZ)=""
"RTN","MAGQBUT1",87,0)
 S XMY("G.MAG SERVER")=""
"RTN","MAGQBUT1",88,0)
 S:$G(MAGDUZ) XMY(MAGDUZ)=""
"RTN","MAGQBUT1",89,0)
 D ^XMD
"RTN","MAGQBUT1",90,0)
 K ^TMP($J,"MAGQ")
"RTN","MAGQBUT1",91,0)
 Q
"RTN","MAGQBUT1",92,0)
ALLSERV(RESULT) ;
"RTN","MAGQBUT1",93,0)
 ; RPC[MAGQ ALL SERVER]
"RTN","MAGQBUT1",94,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT1",95,0)
 N INDX,DATA,CNT,SHARE,CWL,VALUE,TMP,PLACE ;CWL=CURRENT WRITE LOCATION
"RTN","MAGQBUT1",96,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT1",97,0)
 S CWL=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBUT1",98,0)
 I CWL D
"RTN","MAGQBUT1",99,0)
 . S DATA=$G(^MAG(2005.2,CWL,0))
"RTN","MAGQBUT1",100,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBUT1",101,0)
 . S RESULT(0)=SHARE_U_CWL_U_+$P(DATA,U,5)_U_+$P(DATA,U,3)_U_$P(DATA,U)
"RTN","MAGQBUT1",102,0)
 . Q
"RTN","MAGQBUT1",103,0)
 E  S RESULT(0)="-1^The Current Write Location (CWL) could not be set."
"RTN","MAGQBUT1",104,0)
 S INDX=0,U="^",CNT=1
"RTN","MAGQBUT1",105,0)
 K ^TMP("MAGQAS")
"RTN","MAGQBUT1",106,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT1",107,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBUT1",108,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBUT1",109,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBUT1",110,0)
 . Q:($P(DATA,U,10)'=PLACE)
"RTN","MAGQBUT1",111,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBUT1",112,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBUT1",113,0)
 . Q:$E(SHARE,1,2)'="\\"
"RTN","MAGQBUT1",114,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBUT1",115,0)
 . S TMP(SHARE)=""
"RTN","MAGQBUT1",116,0)
 . S VALUE=SHARE_U_INDX_U_+$P(DATA,U,5)_U_+$P(DATA,U,3)_U_$P(DATA,U)
"RTN","MAGQBUT1",117,0)
 . I INDX=CWL D  Q  ;ELSE CONTINUE 
"RTN","MAGQBUT1",118,0)
 . . S RESULT(0)=VALUE_U_$G(^TMP("MAGQ","WSUD"))
"RTN","MAGQBUT1",119,0)
 . . S ^TMP("MAGQAS",0)=VALUE ;1ST SHARE=CWL
"RTN","MAGQBUT1",120,0)
 . S RESULT(CNT)=VALUE,CNT=CNT+1
"RTN","MAGQBUT1",121,0)
 . S ^TMP("MAGQAS",CNT-1)=VALUE
"RTN","MAGQBUT1",122,0)
 Q
"RTN","MAGQBUT1",123,0)
ALLSHR(RESULT) ; RPC[MAGQBP ALL SHARES]
"RTN","MAGQBUT1",124,0)
 N TMP,INDX,DATA,CNT,SHARE,CWL,VALUE,PLACE ;CWL=CURRENT WRITE LOCATION
"RTN","MAGQBUT1",125,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT1",126,0)
 S (CNT,INDX)=0,U="^"
"RTN","MAGQBUT1",127,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT1",128,0)
 S CWL=$$CWL^MAGBAPI(PLACE)
"RTN","MAGQBUT1",129,0)
 F  S INDX=$O(^MAG(2005.2,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT1",130,0)
 . S DATA=$G(^MAG(2005.2,INDX,0))
"RTN","MAGQBUT1",131,0)
 . Q:$P(DATA,U,6,7)'["1^MAG"
"RTN","MAGQBUT1",132,0)
 . Q:$P(DATA,U,9)="1"  ;ROUTING SHARE
"RTN","MAGQBUT1",133,0)
 . Q:$P(DATA,U,2)[":"
"RTN","MAGQBUT1",134,0)
 . Q:($P(DATA,U,10)'=PLACE)
"RTN","MAGQBUT1",135,0)
 . S SHARE=$P(DATA,U,2)
"RTN","MAGQBUT1",136,0)
 . Q:$E(SHARE,1,2)'="\\"
"RTN","MAGQBUT1",137,0)
 . I $E(SHARE,$L(SHARE))="\" S SHARE=$E(SHARE,1,$L(SHARE)-1)
"RTN","MAGQBUT1",138,0)
 . Q:$D(TMP(SHARE))
"RTN","MAGQBUT1",139,0)
 . S TMP(SHARE)=""
"RTN","MAGQBUT1",140,0)
 S INDX=""
"RTN","MAGQBUT1",141,0)
 F  S INDX=$O(TMP(INDX)) Q:INDX=""  D
"RTN","MAGQBUT1",142,0)
 . S RESULT(CNT)=INDX,CNT=CNT+1
"RTN","MAGQBUT1",143,0)
 K TMP
"RTN","MAGQBUT1",144,0)
 Q
"RTN","MAGQBUT1",145,0)
FSUPDT(RESULT,IEN,SPACE,SIZE) ;
"RTN","MAGQBUT1",146,0)
 ;File Server Update
"RTN","MAGQBUT1",147,0)
 ; RPC[MAGQ FS UPDATE]
"RTN","MAGQBUT1",148,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT1",149,0)
 N NODE,X,Y,INDEX,SHNAME,PLACE
"RTN","MAGQBUT1",150,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT1",151,0)
 S X=$$NOW^XLFDT S Y=X D DD^%DT S ^TMP("MAGQ","WSUD")=Y
"RTN","MAGQBUT1",152,0)
 S ^TMP("MAGQ","WSUD",XWBTIP)=Y
"RTN","MAGQBUT1",153,0)
 I $G(^MAG(2005.2,IEN,0))="" S RESULT="-1^No Network Location Entry" Q
"RTN","MAGQBUT1",154,0)
 S NODE=^MAG(2005.2,IEN,0)
"RTN","MAGQBUT1",155,0)
 D FSW(IEN,NODE)
"RTN","MAGQBUT1",156,0)
 S INDEX=0,SHNAME=$P(NODE,"^",2)
"RTN","MAGQBUT1",157,0)
 ; NOW UPDATE THE SIZING FIELDS FOR SHARES OF SAME PHYS LOCATION
"RTN","MAGQBUT1",158,0)
 F  S INDEX=$O(^MAG(2005.2,"AC",SHNAME,INDEX)) Q:INDEX'?1N.N  D
"RTN","MAGQBUT1",159,0)
 . Q:INDEX=IEN
"RTN","MAGQBUT1",160,0)
 . S NODE=^MAG(2005.2,INDEX,0)
"RTN","MAGQBUT1",161,0)
 . D FSW(INDEX,NODE)
"RTN","MAGQBUT1",162,0)
 S RESULT="1^Update Complete"
"RTN","MAGQBUT1",163,0)
 Q
"RTN","MAGQBUT1",164,0)
FSW(INDEX,NODE) ;
"RTN","MAGQBUT1",165,0)
 I (($P(NODE,"^",3)'=(+SIZE))!($P(NODE,"^",5)'=(+SPACE))) D
"RTN","MAGQBUT1",166,0)
 . S $P(NODE,"^",3)=+SIZE,$P(NODE,"^",5)=+SPACE,^MAG(2005.2,INDEX,0)=NODE
"RTN","MAGQBUT1",167,0)
 Q
"RTN","MAGQBUT1",168,0)
QUEUER(QUE,FROM,TO) ;
"RTN","MAGQBUT1",169,0)
 N TYPE,INC,CNT,AR,TMP,PLACE,INST,MAGFILE
"RTN","MAGQBUT1",170,0)
 I $$GET1^DIQ(200,+$G(DUZ),.01)="" D  Q
"RTN","MAGQBUT1",171,0)
 . W !,"You must have a valid User ID (DUZ) to use this function!"
"RTN","MAGQBUT1",172,0)
 I "^JBTOHD^PREFET^ABSTRACT^JUKEBOX^GCC^DELETE^EVAL^"'[QUE D  Q
"RTN","MAGQBUT1",173,0)
 . W !,"Only JBTOHD, PREFET, ABSTRACT, JUKEBOX, DELETE, EVAL & GCC queues are valid!"
"RTN","MAGQBUT1",174,0)
 . W !,"Input values: ""Queue type"",""From Image IEN"",""To Image IEN"""
"RTN","MAGQBUT1",175,0)
 S CNT=0
"RTN","MAGQBUT1",176,0)
 ;
"RTN","MAGQBUT1",177,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT1",178,0)
 ;
"RTN","MAGQBUT1",179,0)
 S INST=$$GET1^DIQ(2006.1,PLACE,.01,"I")
"RTN","MAGQBUT1",180,0)
 F INC=FROM:1:TO D
"RTN","MAGQBUT1",181,0)
 . I ('$D(^MAG(2005,INC,0))&('$D(^MAG(2005.1,INC,0)))) Q
"RTN","MAGQBUT1",182,0)
 . I ($$PLACE^MAGBAPI(+$P($G(^MAG(2005,INC,100)),U,3))'=PLACE)&($$PLACE^MAGBAPI(+$P($G(^MAG(2005.1,INC,100)),U,3)'=PLACE)) Q
"RTN","MAGQBUT1",183,0)
 . I ($P($G(^MAG(2005,INC,0)),"^",2)="")&($P($G(^MAG(2005.1,INC,0)),"^",2)="") Q  ;No full filename attribute
"RTN","MAGQBUT1",184,0)
 . I (+$P($G(^MAG(2005,INC,1,0)),"^",4)>0)!(+$P($G(^MAG(2005.1,INC,1,0)),"^",4)>0) Q  ;GROUP PARENT
"RTN","MAGQBUT1",185,0)
 . I "^DELETE^"[QUE D  Q
"RTN","MAGQBUT1",186,0)
 . . S MAGXX=INC D VSTNOCP^MAGFILEB I $P(MAGFILE,U)="-1" W !,"Image # "_INC Q 
"RTN","MAGQBUT1",187,0)
 . . S MAGXX=INC D ABSNOCP^MAGFILEB I $P(MAGFILE,U)="-1" W !,"Image # "_INC Q
"RTN","MAGQBUT1",188,0)
 . . S MAGXX=INC D BIGNOCP^MAGFILEB I $P(MAGFILE,U)="-1" W !,"Image # "_INC Q
"RTN","MAGQBUT1",189,0)
 . . D IMAGEDEL^MAGGTID(.MAGFILE,INC,"","TESTING") Q
"RTN","MAGQBUT1",190,0)
 . I "^JBTOHD^PREFET^"[QUE F TYPE="ABSTRACT","FULL","BIG" D
"RTN","MAGQBUT1",191,0)
 . . Q:(TYPE="BIG")&('$D(^MAG(2005,INC,"FBIG"))&'$D(^MAG(2005.1,INC,"FBIG")))
"RTN","MAGQBUT1",192,0)
 . . D MAPI(QUE,INC_"^"_TYPE,.CNT)
"RTN","MAGQBUT1",193,0)
 . E  D MAPI(QUE,INC,.CNT)
"RTN","MAGQBUT1",194,0)
 Q
"RTN","MAGQBUT1",195,0)
MPAC(SW,FROM,TO) ;
"RTN","MAGQBUT1",196,0)
 N INDEX
"RTN","MAGQBUT1",197,0)
 I (SW'=1)&(SW'=0) W !,"The first parameter must equal 0 or 1" Q
"RTN","MAGQBUT1",198,0)
 I (FROM<0)!((TO<0)!(TO<FROM)) W !,"The second parameter must be greater than 0 and less than the third!" Q
"RTN","MAGQBUT1",199,0)
 S FROM=FROM-1
"RTN","MAGQBUT1",200,0)
 F  S INDEX=$O(^MAG(2005,INDEX)) Q:INDEX'?1N.N  Q:INDEX>TO  D
"RTN","MAGQBUT1",201,0)
 . I '$D(^MAG(2005,INDEX,0)) Q
"RTN","MAGQBUT1",202,0)
 . I $P($G(^MAG(2005,INDEX,0)),"^",2)="" Q  ;No full filename attribute
"RTN","MAGQBUT1",203,0)
 . I +$P($G(^MAG(2005,INDEX,1,0)),"^",4)>0 Q  ;GROUP PARENT
"RTN","MAGQBUT1",204,0)
 . I (SW=1)&('$D(^MAG(2005,INDEX,"PACS"))) S ^MAG(2005,INDEX,"PACS")="TEST PACS" Q
"RTN","MAGQBUT1",205,0)
 . I SW=0 K ^MAG(2005,INDEX,"PACS")
"RTN","MAGQBUT1",206,0)
 Q
"RTN","MAGQBUT1",207,0)
MAPI(TYP,PARAM,CNT) ;
"RTN","MAGQBUT1",208,0)
 N PLACE
"RTN","MAGQBUT1",209,0)
 S CNT=CNT+1,PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT1",210,0)
 W !,CNT," TYPE: ",TYP,": ",PARAM_" QUEUE #: ",@("$$"_TYP_"^MAGBAPI(PARAM,PLACE)")
"RTN","MAGQBUT1",211,0)
 Q
"RTN","MAGQBUT1",212,0)
BPQSL(RESULT,TYPE) ;
"RTN","MAGQBUT1",213,0)
 ; RPC[MAGQB QSL]
"RTN","MAGQBUT1",214,0)
 N STATUS,CNT,IEN,CP,PLACE
"RTN","MAGQBUT1",215,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGQBUT1",216,0)
 S STATUS="",CNT=0
"RTN","MAGQBUT1",217,0)
 F  S STATUS=$O(^MAGQUEUE(2006.03,"D",PLACE,TYPE,STATUS)) Q:STATUS=""  D
"RTN","MAGQBUT1",218,0)
 . Q:+STATUS>0
"RTN","MAGQBUT1",219,0)
 . S IEN=$O(^MAGQUEUE(2006.03,"D",PLACE,TYPE,STATUS,""))
"RTN","MAGQBUT1",220,0)
 . S CP=$P(^MAGQUEUE(2006.031,$O(^MAGQUEUE(2006.031,"C",PLACE,TYPE,"")),0),"^",2)
"RTN","MAGQBUT1",221,0)
 . Q:IEN>(CP)
"RTN","MAGQBUT1",222,0)
 . S CNT=CNT+1,RESULT(CNT)=STATUS
"RTN","MAGQBUT1",223,0)
 Q
"RTN","MAGQBUT2")
0^18^B55361113
"RTN","MAGQBUT2",1,0)
MAGQBUT2 ;WOIFO/SRR/RMP -IMAGE SITE PARAMETERS COMPANION [ 11/08/2001 17:18 ]
"RTN","MAGQBUT2",2,0)
 ;;3.0;IMAGING;**7,8,20,81**;May 17, 2007
"RTN","MAGQBUT2",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT2",17,0)
 ;;
"RTN","MAGQBUT2",18,0)
MAGSYS(LIST) ;
"RTN","MAGQBUT2",19,0)
 ; RPC[MAGQ SYSTEM]
"RTN","MAGQBUT2",20,0)
 N VAIEN,NODE,MGIEN,UNAME,TDATE
"RTN","MAGQBUT2",21,0)
 S MGIEN=$$FIND1^DIC(3.8,"","MX","MAG SERVER","","","ERR")
"RTN","MAGQBUT2",22,0)
 S VAIEN=0
"RTN","MAGQBUT2",23,0)
 F  S VAIEN=$O(^XUSEC("MAG SYSTEM",VAIEN)) Q:VAIEN'?1N.N  D
"RTN","MAGQBUT2",24,0)
 . S UNAME=$$GET1^DIQ(200,VAIEN,.01)
"RTN","MAGQBUT2",25,0)
 . Q:UNAME=""
"RTN","MAGQBUT2",26,0)
 . ;CHECK FOR TERMINATION DATE
"RTN","MAGQBUT2",27,0)
 . S TDATE=$$GET1^DIQ(200,VAIEN,9.2)
"RTN","MAGQBUT2",28,0)
 . Q:((TDATE'="")&(TDATE<$$NOW^XLFDT))
"RTN","MAGQBUT2",29,0)
 . ;the next line screens existing 'MAG SERVER' members
"RTN","MAGQBUT2",30,0)
 . I MGIEN?1N.N,$$FIND1^DIC(3.81,","_MGIEN_",","QA",VAIEN,"","","ERR") Q
"RTN","MAGQBUT2",31,0)
 . S LIST(VAIEN)=VAIEN_"^"_UNAME
"RTN","MAGQBUT2",32,0)
 Q
"RTN","MAGQBUT2",33,0)
IMPAR(RESULT,QIEN) ; Import Array
"RTN","MAGQBUT2",34,0)
 N INDX,CNT
"RTN","MAGQBUT2",35,0)
 S (INDX,CNT)=0
"RTN","MAGQBUT2",36,0)
 F  S INDX=$O(^MAG(2006.034,QIEN,1,INDX)) Q:INDX'?1N.N  D
"RTN","MAGQBUT2",37,0)
 . S CNT=CNT+1
"RTN","MAGQBUT2",38,0)
 . S RESULT(CNT)=$G(^MAG(2006.034,QIEN,1,INDX,0))
"RTN","MAGQBUT2",39,0)
 I CNT<1 S RESULT(0)="0^Corrupted Import Array"
"RTN","MAGQBUT2",40,0)
 E  S RESULT(0)="1"
"RTN","MAGQBUT2",41,0)
 Q
"RTN","MAGQBUT2",42,0)
CHKIMG(IEN) ;
"RTN","MAGQBUT2",43,0)
 ; Given an Image IEN, return:
"RTN","MAGQBUT2",44,0)
 ;   1: Case # or accession #
"RTN","MAGQBUT2",45,0)
 ;   2: Parent application~IEN
"RTN","MAGQBUT2",46,0)
 ;   3: Application DFN
"RTN","MAGQBUT2",47,0)
 ;   4: Image DFN
"RTN","MAGQBUT2",48,0)
 ;   5: Flag: true = all DFNs in images in same parent group are identical
"RTN","MAGQBUT2",49,0)
 ;   6: Image object Class
"RTN","MAGQBUT2",50,0)
 ;
"RTN","MAGQBUT2",51,0)
 ; PF: Parent Data file number
"RTN","MAGQBUT2",52,0)
 ; PT(): Parent file data dictionary
"RTN","MAGQBUT2",53,0)
 ; PD0: Parent (Global root) IEN (D0)
"RTN","MAGQBUT2",54,0)
 ; PD1:  Lab Parent Global Root (D1)
"RTN","MAGQBUT2",55,0)
 ; PD2:  Parent Data File Image Pointer
"RTN","MAGQBUT2",56,0)
 ; T():  Error types
"RTN","MAGQBUT2",57,0)
 ; IDFN: Image file entry DFN
"RTN","MAGQBUT2",58,0)
 ; PDFN: Parent file DFN
"RTN","MAGQBUT2",59,0)
 ; GRG:  virtual Parent File Image Multiple
"RTN","MAGQBUT2",60,0)
 ; IOR: Image Object Referenced (by parent)
"RTN","MAGQBUT2",61,0)
 N GF,GP,G0,GR,GRD,GRG,GR0,IDFN,IENV,P0,PD0,PD1,PD2,PF,PT,X0,X2,N0,N1,R,T,GPDFN,PACS,IOR,APR,I,PDFN
"RTN","MAGQBUT2",62,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT2",63,0)
 S R="^^^^^"
"RTN","MAGQBUT2",64,0)
 S T(1)="No Image ptr in AP"
"RTN","MAGQBUT2",65,0)
 S T(2)="GP has no Images"
"RTN","MAGQBUT2",66,0)
 S T(3)="Conflicting AP & Image DFNs"
"RTN","MAGQBUT2",67,0)
 S T(4)="Invalid Image Ptr to AP"
"RTN","MAGQBUT2",68,0)
 S T(5)="Conflicting GP and GO DFN"
"RTN","MAGQBUT2",69,0)
 S T(6)="GP & GO AP Mismatch"
"RTN","MAGQBUT2",70,0)
 S T(7)="GP Missing GO ptr"
"RTN","MAGQBUT2",71,0)
 S T(8)="No AP Ptr"
"RTN","MAGQBUT2",72,0)
 S T(9)="No AP Entry ptr"
"RTN","MAGQBUT2",73,0)
 S T(10)="No AP Mult ptr"
"RTN","MAGQBUT2",74,0)
 S T(11)="GO DFN mismatches"
"RTN","MAGQBUT2",75,0)
 S T(12)="Null Image Ptr"
"RTN","MAGQBUT2",76,0)
 S T(13)="Invalid Image Ptr"
"RTN","MAGQBUT2",77,0)
 S T(14)="Invalid Image Ptr to AP"
"RTN","MAGQBUT2",78,0)
 S T(15)="Image Entry is structurally abnormal"
"RTN","MAGQBUT2",79,0)
 S T(16)="Missing Group Objects"
"RTN","MAGQBUT2",80,0)
 S T(21)="DFN Mismatches in AP Image Mult"
"RTN","MAGQBUT2",81,0)
 I IEN="" S $P(R,"^",5)=T(12)_"~1" Q R
"RTN","MAGQBUT2",82,0)
 S X0=$G(^MAG(2005,IEN,0))
"RTN","MAGQBUT2",83,0)
 I X0="" S $P(R,"^",5)=T(13)_"~1" Q R
"RTN","MAGQBUT2",84,0)
 S IDFN=$P(X0,"^",7),$P(R,"^",4)=IDFN
"RTN","MAGQBUT2",85,0)
 S PT(3.9)="^XMB(3.9,PD0,|Mail message||2|^XMB(3.9,PD0,2005,|MAIL"
"RTN","MAGQBUT2",86,0)
 ; The following 5 Lab subsections must be in-synch with FILE+42^MAGGTLB1
"RTN","MAGQBUT2",87,0)
 S PT(63)="^LR(PD0,GF,PD1,|Autopsy (microscopic)|AY|1|^LR(PD0,GF,PD1,2005,|AUM"
"RTN","MAGQBUT2",88,0)
 S PT(63.02)="^LR(PD0,GF,PD1,|Electron microscopy|EM|1|^LR(PD0,GF,PD1,2005,|EM"
"RTN","MAGQBUT2",89,0)
 S PT(63.08)="^LR(PD0,GF,PD1,|Surgical pathology|SP|1|^LR(PD0,GF,PD1,2005,|SP"
"RTN","MAGQBUT2",90,0)
 S PT(63.09)="^LR(PD0,GF,PD1,|Cytology|CY|1|^LR(PD0,GF,PD1,2005,|CY|"
"RTN","MAGQBUT2",91,0)
 S PT(63.2)="^LR(PD0,GF,PD1,|Autopsy (gross)|AY|1|^LR(PD0,GF,PD1,2005,|AUG"
"RTN","MAGQBUT2",92,0)
 S PT(70)="^RADPT(PDFN,|Radiology Patient||1|"
"RTN","MAGQBUT2",93,0)
 S PT(74)="^RARPT(PD0,|Radiology||2|^RARPT(PD0,2005,|RAD"
"RTN","MAGQBUT2",94,0)
 S PT(130)="^SRF(PD0,|Surgery||1|^SRF(PD0,2005,|SUR"
"RTN","MAGQBUT2",95,0)
 S PT(691)="^MCAR(691,PD0,|Echocardiogram||2|^MCAR(691,PD0,2005,|ECHO"
"RTN","MAGQBUT2",96,0)
 S PT(691.1)="^MCAR(691.1,PD0,|Cardiac catheterization||2|^MCAR(691.1,PD0,2005,|CATH"
"RTN","MAGQBUT2",97,0)
 S PT(691.5)="^MCAR(691.5,PD0,|Electrocardiography||2|^MCAR(691.5,PD0,2005,|ECG"
"RTN","MAGQBUT2",98,0)
 S PT(694)="^MCAR(694,PD0,|Hematology||2|^MCAR(694,PD0,2005,|HEM"
"RTN","MAGQBUT2",99,0)
 S PT(699)="^MCAR(699,PD0,|Endoscopy||2|^MCAR(699,PD0,2005,|ENDO"
"RTN","MAGQBUT2",100,0)
 S PT(699.5)="^MCAR(699.5,PD0,|Medicine||2|^MCAR(699.5,PD0,2005,|GEN"
"RTN","MAGQBUT2",101,0)
 S PT(8925)="^TIU(8925,PD0,|TIU||2|^TIU(8925.91,""ADI"",PD0,|TIU"
"RTN","MAGQBUT2",102,0)
 S IC=$$IC(IEN,.N0,.N2,.GPDFN),$P(R,U,6)=IC
"RTN","MAGQBUT2",103,0)
 I IC="ER" S $P(R,U,5)=T(15)_"~1" Q R
"RTN","MAGQBUT2",104,0)
 I IC["GP",'$O(^MAG(2005,IEN,1,0)) S $P(R,U,5)=T(2)_"~1" Q R
"RTN","MAGQBUT2",105,0)
 D PF(IEN,IC,N0,.PF,.PD0,.PD1,.PD2,.PACS,.IOR,.APR)
"RTN","MAGQBUT2",106,0)
 I "GP^GO"[IC D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",107,0)
 . S I=0
"RTN","MAGQBUT2",108,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  D
"RTN","MAGQBUT2",109,0)
 . . I '$D(^MAG(2005,$P($G(^MAG(2005,IOR,1,I,0)),U),0)) S $P(R,U,5)=T(16)_$S(IC="GO":"~2",1:"~1")
"RTN","MAGQBUT2",110,0)
 . . Q
"RTN","MAGQBUT2",111,0)
 I IC["GO" S $P(R,U,6)=$P(R,U,6)_"~"_IOR
"RTN","MAGQBUT2",112,0)
 I PD2'?1N.N,(('PACS)&(PD0?1N.N)) S $P(R,U,5)=T(10)_$S(IC["GO":"~2",1:"~1") Q R
"RTN","MAGQBUT2",113,0)
 I IC["GO" D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",114,0)
 . N I,J
"RTN","MAGQBUT2",115,0)
 . S (I,J)=0
"RTN","MAGQBUT2",116,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  S:IEN=$P($G(^MAG(2005,IOR,1,I,0)),U,1) J=1
"RTN","MAGQBUT2",117,0)
 . S:J=0 $P(R,U,5)=T(7)_"~2"
"RTN","MAGQBUT2",118,0)
 . Q
"RTN","MAGQBUT2",119,0)
 I IC["GO",IDFN'=GPDFN S $P(R,U,5)=T(5)_"~1",$P(R,U,3)=GPDFN Q R
"RTN","MAGQBUT2",120,0)
 I IC["GO" D  Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",121,0)
 . N I,J
"RTN","MAGQBUT2",122,0)
 . S I=0
"RTN","MAGQBUT2",123,0)
 . F  S I=$O(^MAG(2005,IOR,1,I)) Q:I'?1N.N  D  Q:$P(R,U,5)'=""
"RTN","MAGQBUT2",124,0)
 . . S J=$P($G(^MAG(2005,IOR,1,I,0)),U)
"RTN","MAGQBUT2",125,0)
 . . I $P($G(^MAG(2005,J,0)),U,7)'=IDFN S $P(R,U,5)=T(11)_"~2",$P(R,U,3)=$P($G(^MAG(2005,J,0)),U,7)
"RTN","MAGQBUT2",126,0)
 . . Q
"RTN","MAGQBUT2",127,0)
 I IC["GO",PACS,(($P(N2,U,6,7)'="")&($P(N2,U,6,7)'="^")),$P(N2,U,6,7)'=$P($G(^MAG(2005,$P(N0,U,10),2)),U,6,7) D  Q R
"RTN","MAGQBUT2",128,0)
 . S $P(R,U,5)=T(6)_"~1",$P(R,U,3)=$P(^MAG(2005,IOR,0),U,7) Q
"RTN","MAGQBUT2",129,0)
 I (PF\1=63),PD1'?1N.N,PD1'?1N.N1"."1N.N Q R
"RTN","MAGQBUT2",130,0)
 I PF?1N.E,$D(PT(+PF)),PD0?1N.N D
"RTN","MAGQBUT2",131,0)
 . S $P(R,"^",2)=$P(PT(PF),"|",6)_"~"_PD0
"RTN","MAGQBUT2",132,0)
 . S GR=$P(PT(PF),"|",1),GR0=GR_"0)"
"RTN","MAGQBUT2",133,0)
 . S GF=$P(PT(PF),"|",3),GP=$P(PT(PF),"|",4)
"RTN","MAGQBUT2",134,0)
 . S T=$P(PT(PF),"|",5),GRD=T_"G0,0)",GRG=T_"G0)"
"RTN","MAGQBUT2",135,0)
 E  D  Q R
"RTN","MAGQBUT2",136,0)
 . S:((IC["GP")&($P(R,U,5)="")) $P(R,U,5)="1"
"RTN","MAGQBUT2",137,0)
 S P0=$G(@GR0)
"RTN","MAGQBUT2",138,0)
 I P0="" S $P(R,"^",5)=T(4)_$S((('PACS)&(IC["GO")):"~2",1:"~1") Q R
"RTN","MAGQBUT2",139,0)
 S PDFN=$S(PF\1=63:$P(^LR(PD0,0),U,3),$P(P0,"^",GP)'="":$P(P0,"^",GP),1:PDFN)
"RTN","MAGQBUT2",140,0)
 I 'PDFN,$P($G(^VA(200,IDFN,0)),"^",1)=PDFN S PDFN=IDFN
"RTN","MAGQBUT2",141,0)
 S $P(R,"^",3)=PDFN
"RTN","MAGQBUT2",142,0)
 I PDFN'=IDFN S $P(R,U,5)=T(3)_$S((('PACS)&(IC["GO")):"~2",1:"~1") Q R
"RTN","MAGQBUT2",143,0)
 I PF=74 D
"RTN","MAGQBUT2",144,0)
 . S GR=$P(PT(70),"|",1),GR0=GR_"0)"
"RTN","MAGQBUT2",145,0)
 . S GF=$P(PT(70),"|",3),GP=$P(PT(70),"|",4)
"RTN","MAGQBUT2",146,0)
 . S P0=$G(@GR0),$P(R,"^",3)=$P(R,"^",3)_"~"_$P(P0,"^",GP)
"RTN","MAGQBUT2",147,0)
 S T=1,G0=0,IENV=0
"RTN","MAGQBUT2",148,0)
 F  S G0=$O(@GRG) Q:'G0  Q:$P(R,U,5)'=""  D  I 'T K PT Q
"RTN","MAGQBUT2",149,0)
 . I PF=8925 D  Q
"RTN","MAGQBUT2",150,0)
 . . I '$D(^MAG(2005,+G0,0)) S $P(R,U,5)=T(14)_$S((('PACS)&(IC["GO")):"~2",1:"~1")
"RTN","MAGQBUT2",151,0)
 . . S:G0=IOR IENV=1
"RTN","MAGQBUT2",152,0)
 . . I $P($G(^MAG(2005,+G0,0)),"^",7)'=IDFN S $P(R,U,5)=T(21)_"~2",$P(R,U,3)=$P($G(^MAG(2005,+G0,0)),"^",7)
"RTN","MAGQBUT2",153,0)
 . . Q
"RTN","MAGQBUT2",154,0)
 . I '$D(^MAG(2005,+$P($G(@GRD),"^",1),0)) S $P(R,U,5)=T(14)_$S((('PACS)&(IC["GO")):"~2",1:"~1")
"RTN","MAGQBUT2",155,0)
 . I $P($G(^MAG(2005,+$P($G(@GRD),"^",1),0)),"^",7)'=IDFN D  Q
"RTN","MAGQBUT2",156,0)
 . . S $P(R,U,5)=T(21)_"~2",$P(R,U,3)=$P($G(^MAG(2005,+$P($G(@GRD),"^",1),0)),"^",7) Q
"RTN","MAGQBUT2",157,0)
 . I PF=63 S:+$P($G(^LR(PD0,GF,PD1,2005.1,G0,0)),U)=IOR IENV=1
"RTN","MAGQBUT2",158,0)
 . I PF=63.2 S:+$P($G(^LR(PD0,GF,PD1,2005,G0,0)),U)=IOR IENV=1
"RTN","MAGQBUT2",159,0)
 . S:+$P($G(@GRD),"^",1)=IOR IENV=1
"RTN","MAGQBUT2",160,0)
 . Q
"RTN","MAGQBUT2",161,0)
 Q:$P(R,U,5)'="" R
"RTN","MAGQBUT2",162,0)
 I IC["GP" S $P(R,U,5)="1"
"RTN","MAGQBUT2",163,0)
 I IENV=0 S $P(R,U,5)=T(1)_"~1"
"RTN","MAGQBUT2",164,0)
 I PF=74 S $P(R,"^",1)=$P(P0,"^",1)
"RTN","MAGQBUT2",165,0)
 K PT
"RTN","MAGQBUT2",166,0)
 Q R
"RTN","MAGQBUT2",167,0)
IC(IEN,N0,N2,GPDFN) ;
"RTN","MAGQBUT2",168,0)
 S N0=$G(^MAG(2005,IEN,0))
"RTN","MAGQBUT2",169,0)
 S N1=$G(^MAG(2005,IEN,1,0))
"RTN","MAGQBUT2",170,0)
 S N2=$G(^MAG(2005,IEN,2))
"RTN","MAGQBUT2",171,0)
 I ($P(N0,U,2)="")&($P(N0,U,10)="")&($P(N1,U,4)>0) Q "GP"
"RTN","MAGQBUT2",172,0)
 I (($P(N0,U,2)'="")&($P(N0,U,10)?1N.N)&(N1="")) D  Q "GO"
"RTN","MAGQBUT2",173,0)
 . S GPDFN=$P($G(^MAG(2005,$P(N0,U,10),0)),U,7) Q
"RTN","MAGQBUT2",174,0)
 I ($P(N0,U,2)'="")&($P(N0,U,10)'?1N.N)&(N1="") Q "NG"
"RTN","MAGQBUT2",175,0)
 Q "ER"
"RTN","MAGQBUT2",176,0)
PF(IEN,IC,N0,PF,PD0,PD1,PD2,PACS,IOR,APR) ;
"RTN","MAGQBUT2",177,0)
 N N2
"RTN","MAGQBUT2",178,0)
 S PACS=$S($D(^MAG(2005,IEN,"PACS")):1,1:0)
"RTN","MAGQBUT2",179,0)
 S IOR=$S(IC="GO":$P($G(N0),U,10),1:IEN)
"RTN","MAGQBUT2",180,0)
 I ((IC="GP")!(IC="NG")!((PACS)&(IC="GO"))) S N2=$G(^MAG(2005,IEN,2))
"RTN","MAGQBUT2",181,0)
 I ((IC="GO")&('PACS)) S N2=$G(^MAG(2005,IOR,2))
"RTN","MAGQBUT2",182,0)
 S PF=$P(N2,"^",6),PD0=$P(N2,"^",7),PD1=$P(N2,"^",10),PD2=$P(N2,"^",8)
"RTN","MAGQBUT2",183,0)
 I PACS S APR=$S(PD0?1N.N:1,1:0)
"RTN","MAGQBUT2",184,0)
 E  S APR=$S(((PF'="")&(PD0?1N.N)):1,$P($G(^MAG(2005,IOR,100)),U)?1N.N:1,$P($G(^MAG(2005,IOR,0)),U,6)="18":1,1:0)
"RTN","MAGQBUT2",185,0)
 Q
"RTN","MAGQBUT4")
0^16^B78049028
"RTN","MAGQBUT4",1,0)
MAGQBUT4 ;WOIFO/RMP - BP Utilities  ;19 Nov 2001 1:23 PM
"RTN","MAGQBUT4",2,0)
 ;;3.0;IMAGING;**7,8,48,20,81**;May 17, 2007
"RTN","MAGQBUT4",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT4",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT4",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT4",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT4",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT4",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT4",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT4",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGQBUT4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGQBUT4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGQBUT4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGQBUT4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT4",17,0)
 ;;
"RTN","MAGQBUT4",18,0)
 ;
"RTN","MAGQBUT4",19,0)
 Q
"RTN","MAGQBUT4",20,0)
CONV(ARR,ICT) ;Convert any single node array to FM Style multiple
"RTN","MAGQBUT4",21,0)
 ;  The node subscripts of ARR are ignored, and not retained
"RTN","MAGQBUT4",22,0)
 ; i.e.  ARR(34)=8
"RTN","MAGQBUT4",23,0)
 ;       ARR("BLUE")=9
"RTN","MAGQBUT4",24,0)
 ;       ARR("D")=10
"RTN","MAGQBUT4",25,0)
 ; converts to
"RTN","MAGQBUT4",26,0)
 ;      ARR(1,0)=8
"RTN","MAGQBUT4",27,0)
 ;      ARR(2,0)=9
"RTN","MAGQBUT4",28,0)
 ;      ARR(3,0)=10
"RTN","MAGQBUT4",29,0)
 N I,ARO
"RTN","MAGQBUT4",30,0)
 S ICT=0,I=""
"RTN","MAGQBUT4",31,0)
 F  S I=$O(ARR(I)) Q:(I="")  D
"RTN","MAGQBUT4",32,0)
 . S ICT=ICT+1
"RTN","MAGQBUT4",33,0)
 . S ARO(ICT,0)=ARR(I)
"RTN","MAGQBUT4",34,0)
 K ARR
"RTN","MAGQBUT4",35,0)
 M ARR=ARO
"RTN","MAGQBUT4",36,0)
 Q
"RTN","MAGQBUT4",37,0)
MRGMULT(ARR,RT,RTDSC,CT) ;Merge the FM formatted array into a FM File
"RTN","MAGQBUT4",38,0)
 ;   multiple field.
"RTN","MAGQBUT4",39,0)
 ;   This isn't for general consumption.
"RTN","MAGQBUT4",40,0)
 ; RT = FILE ROOT, RECORD NUMBER, NODE
"RTN","MAGQBUT4",41,0)
 ; i.e.  "^MAG(2006.034,44,1,"   -> 44 is the IEN of MAG(2006.34
"RTN","MAGQBUT4",42,0)
 ; RTDSC is the 2nd piece of the 0 node of the multiple field.
"RTN","MAGQBUT4",43,0)
 S RT=$E(RT,1,$L(RT)-1)_")"
"RTN","MAGQBUT4",44,0)
 S @RT@(0)=U_RTDSC_U_CT_U_CT ;  i.e.    ^2006.341A^13^13
"RTN","MAGQBUT4",45,0)
 M @RT=ARR
"RTN","MAGQBUT4",46,0)
 Q
"RTN","MAGQBUT4",47,0)
DDLF(RESULTS,FILE,FIELD,FLAGS,ATTR) ;[MAG FLD ATT]
"RTN","MAGQBUT4",48,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",49,0)
 K X
"RTN","MAGQBUT4",50,0)
 D FIELD^DID(FILE,FIELD,FLAGS,ATTR,"RESULTS","RESULTS")
"RTN","MAGQBUT4",51,0)
 Q
"RTN","MAGQBUT4",52,0)
DDFA(RESULTS) ;[MAG ATT LST]
"RTN","MAGQBUT4",53,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",54,0)
 K X
"RTN","MAGQBUT4",55,0)
 D FIELDLST^DID(RESULTS)
"RTN","MAGQBUT4",56,0)
 Q
"RTN","MAGQBUT4",57,0)
DHRPC(RESULTS,FNAME,FLOC) ;[MAG DIRHASH]
"RTN","MAGQBUT4",58,0)
 N TMP
"RTN","MAGQBUT4",59,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",60,0)
 K X
"RTN","MAGQBUT4",61,0)
 S TMP=$$DIRHASH^MAGFILEB(FNAME,FLOC)
"RTN","MAGQBUT4",62,0)
 S RESULTS=$S(TMP="":U,1:TMP)
"RTN","MAGQBUT4",63,0)
 Q
"RTN","MAGQBUT4",64,0)
GPACHX(PV) ; Get Package File Install History of Imaging
"RTN","MAGQBUT4",65,0)
 N I,LCNT,MSG,PKG
"RTN","MAGQBUT4",66,0)
 S LCNT=0
"RTN","MAGQBUT4",67,0)
 S PV(0)="Version^Install Date"
"RTN","MAGQBUT4",68,0)
 F PKG="IMAGING" D
"RTN","MAGQBUT4",69,0)
 . N J,K,L,VERS,DATE,X,Y,%DT
"RTN","MAGQBUT4",70,0)
 . S J=$O(^DIC(9.4,"B",PKG,"")) Q:'J
"RTN","MAGQBUT4",71,0)
 . S VERS="" F  S VERS=$O(^DIC(9.4,J,22,"B",VERS)) Q:VERS=""  D
"RTN","MAGQBUT4",72,0)
 . . N MSG,TAR
"RTN","MAGQBUT4",73,0)
 . . S K=$O(^DIC(9.4,J,22,"B",VERS,""))
"RTN","MAGQBUT4",74,0)
 . . D LIST^DIC(9.4901,","_K_","_J_",","@;.01;.02;.03","","","","","","","","TAR","MSG")
"RTN","MAGQBUT4",75,0)
 . . Q:$D(MSG("DIERR"))
"RTN","MAGQBUT4",76,0)
 . . S L=0 F  S L=$O(TAR("DILIST","ID",L)) Q:'L  D
"RTN","MAGQBUT4",77,0)
 . . . S LCNT=LCNT+1
"RTN","MAGQBUT4",78,0)
 . . . S PV(LCNT)=VERS_"P"_$P(TAR("DILIST","ID",L,".01"),"^",1)
"RTN","MAGQBUT4",79,0)
 . . . S X=$P(TAR("DILIST","ID",L,".02"),"^",1) D ^%DT S DATE=$$FMTE^XLFDT(Y,2)
"RTN","MAGQBUT4",80,0)
 . . . S PV(LCNT)=PV(LCNT)_"^"_$S(DATE["-1":"",1:DATE)
"RTN","MAGQBUT4",81,0)
 . . . Q
"RTN","MAGQBUT4",82,0)
 . . Q
"RTN","MAGQBUT4",83,0)
 . Q
"RTN","MAGQBUT4",84,0)
 Q
"RTN","MAGQBUT4",85,0)
 ;
"RTN","MAGQBUT4",86,0)
VOKR(RESULT,VER) ; RPC for VOK [MAGQ VOK]
"RTN","MAGQBUT4",87,0)
 N CVERS,PNUM,SLINE
"RTN","MAGQBUT4",88,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",89,0)
 S SLINE=$T(+2)
"RTN","MAGQBUT4",90,0)
 S PNUM=$$TRIM($P(SLINE,"**",2)),PNUM=$$TRIM($P(PNUM,",",$L(PNUM,",")))
"RTN","MAGQBUT4",91,0)
 S CVERS=$$TRIM($P(SLINE,";",3))_"P"_PNUM
"RTN","MAGQBUT4",92,0)
 S RESULT=$S(CVERS=VER:1,1:0)_U_CVERS
"RTN","MAGQBUT4",93,0)
 Q
"RTN","MAGQBUT4",94,0)
 ;
"RTN","MAGQBUT4",95,0)
TRIM(X) ; remove both leading and trailing blanks
"RTN","MAGQBUT4",96,0)
 N I,J
"RTN","MAGQBUT4",97,0)
 F I=1:1:$L(X) Q:$E(X,I)'=" "
"RTN","MAGQBUT4",98,0)
 F J=$L(X):-1:I Q:$E(X,J)'=" "
"RTN","MAGQBUT4",99,0)
 Q $S($E(X,I,J)=" ":"",1:$E(X,I,J))
"RTN","MAGQBUT4",100,0)
 ;
"RTN","MAGQBUT4",101,0)
QCNT(RESULT,PLC,QUE) ; [MAGQ QCNT]
"RTN","MAGQBUT4",102,0)
 S X="ERR^MAGQBTM",@^%ZOSF("TRAP")
"RTN","MAGQBUT4",103,0)
 N CNT,DA,CQ,IA
"RTN","MAGQBUT4",104,0)
 S (NODE,IA)="",RESULT=0
"RTN","MAGQBUT4",105,0)
 S (CNT,IA)=0,DA=""
"RTN","MAGQBUT4",106,0)
 S QP=$S($D(^MAGQUEUE(2006.031,"C",PLC,QUE)):$O(^MAGQUEUE(2006.031,"C",PLC,QUE,"")),1:"")
"RTN","MAGQBUT4",107,0)
 S CQ=$S('QP:0,1:$P($G(^MAGQUEUE(2006.031,QP,0)),U,2))
"RTN","MAGQBUT4",108,0)
 F  S DA=$O(^MAGQUEUE(2006.03,"C",PLC,QUE,DA)) Q:'DA  S CNT=CNT+1 I CQ<DA S IA=IA+1
"RTN","MAGQBUT4",109,0)
 D QPUP(PLC,QUE,CNT,CQ,IA,QP) Q
"RTN","MAGQBUT4",110,0)
 Q
"RTN","MAGQBUT4",111,0)
 ;
"RTN","MAGQBUT4",112,0)
QPUP(PLC,QUE,CNT,CQ,IA,QP) ;
"RTN","MAGQBUT4",113,0)
 N IEN,DIC,VAL
"RTN","MAGQBUT4",114,0)
 K VAL
"RTN","MAGQBUT4",115,0)
 S VAL(1)=PLC,VAL(2)=QUE
"RTN","MAGQBUT4",116,0)
 S QP=$S(QP:QP,1:$$FIND1^DIC(2006.031,"","QX",.VAL,"C","",""))
"RTN","MAGQBUT4",117,0)
 ;I IEN>0 D  Q:IEN
"RTN","MAGQBUT4",118,0)
 ;. S $P(^MAGQUEUE(2006.031,IEN,0),U,5)=CNT Q
"RTN","MAGQBUT4",119,0)
 I 'QP D  Q
"RTN","MAGQBUT4",120,0)
 . K DIE,FDA
"RTN","MAGQBUT4",121,0)
 . S FDA(2006.031,"+1,",.01)=QUE
"RTN","MAGQBUT4",122,0)
 . S FDA(2006.031,"+1,",.04)=PLC
"RTN","MAGQBUT4",123,0)
 . S FDA(2006.031,"+1,",1)=CQ
"RTN","MAGQBUT4",124,0)
 . S FDA(2006.031,"+1,",2)=IA
"RTN","MAGQBUT4",125,0)
 . S FDA(2006.031,"+1,",3)=CNT
"RTN","MAGQBUT4",126,0)
 . D UPDATE^DIE("U","FDA","","MAGQUP")
"RTN","MAGQBUT4",127,0)
 . K DIE,FDA
"RTN","MAGQBUT4",128,0)
 E  D
"RTN","MAGQBUT4",129,0)
 . K DIE,FDA
"RTN","MAGQBUT4",130,0)
 . S FDA(2006.031,QP_",",.01)=QUE
"RTN","MAGQBUT4",131,0)
 . S FDA(2006.031,QP_",",.04)=PLC
"RTN","MAGQBUT4",132,0)
 . S FDA(2006.031,QP_",",1)=CQ
"RTN","MAGQBUT4",133,0)
 . S FDA(2006.031,QP_",",2)=IA
"RTN","MAGQBUT4",134,0)
 . S FDA(2006.031,QP_",",3)=CNT
"RTN","MAGQBUT4",135,0)
 . D FILE^DIE("","FDA","MAGERR")
"RTN","MAGQBUT4",136,0)
 . K DIE,FDA
"RTN","MAGQBUT4",137,0)
 Q
"RTN","MAGQBUT4",138,0)
 ;
"RTN","MAGQBUT4",139,0)
CPUD ;
"RTN","MAGQBUT4",140,0)
 N PLC,INS,QUE
"RTN","MAGQBUT4",141,0)
 S (INS,PLC)=""
"RTN","MAGQBUT4",142,0)
 F  S INS=$O(^MAG(2006.1,"B",INS)) Q:INS=""  D
"RTN","MAGQBUT4",143,0)
 . S PLC=$O(^MAG(2006.1,"B",INS,""))
"RTN","MAGQBUT4",144,0)
 . S QUE="" F  S QUE=$O(^MAGQUEUE(2006.031,"C",PLC,QUE)) Q:QUE=""  D
"RTN","MAGQBUT4",145,0)
 . . D QCNT^MAGQBUT4("",PLC,QUE)
"RTN","MAGQBUT4",146,0)
 . . Q
"RTN","MAGQBUT4",147,0)
 . Q
"RTN","MAGQBUT4",148,0)
 Q
"RTN","MAGQBUT4",149,0)
CNL(GL,IEN,NLC) ;  Check Network Location
"RTN","MAGQBUT4",150,0)
 N MAGREF,MAG0,MAG1,PLC
"RTN","MAGQBUT4",151,0)
 S NLC=NLC+1
"RTN","MAGQBUT4",152,0)
 I '$G(IEN) Q ""
"RTN","MAGQBUT4",153,0)
 S MAG0=$G(@(GL_IEN_",0)"))
"RTN","MAGQBUT4",154,0)
 S MAGREF=+$P(MAG0,"^",3)            ; get file from raid
"RTN","MAGQBUT4",155,0)
 I MAGREF=0 S MAGREF=+$P(MAG0,"^",5) ; get file from jukebox
"RTN","MAGQBUT4",156,0)
 I 'MAGREF Q ""
"RTN","MAGQBUT4",157,0)
 I '$D(^MAG(2005.2,MAGREF,0)) Q ""
"RTN","MAGQBUT4",158,0)
 S PLC=$P($G(^MAG(2005.2,MAGREF,0)),U,10)
"RTN","MAGQBUT4",159,0)
 Q:'PLC ""
"RTN","MAGQBUT4",160,0)
 S PLC=$P($G(^MAG(2006.1,PLC,0)),U)
"RTN","MAGQBUT4",161,0)
 Q $S('PLC:"",1:PLC)
"RTN","MAGQBUT4",162,0)
CNSP(GL,IEN,NMSP,NSC) ;  Check NameSPace
"RTN","MAGQBUT4",163,0)
 N NMSPC,MAG0,FNAM,INSTIEN
"RTN","MAGQBUT4",164,0)
 S NSC=NSC+1
"RTN","MAGQBUT4",165,0)
 S MAG0=$G(@(GL_IEN_",0)"))
"RTN","MAGQBUT4",166,0)
 S FNAM=$P(MAG0,U,2)
"RTN","MAGQBUT4",167,0)
 S NMSPC=$TR($P(FNAM,"."),"0123456789","")
"RTN","MAGQBUT4",168,0)
 Q:NMSPC="" ""
"RTN","MAGQBUT4",169,0)
 S INSTIEN=$S($D(NMSP(NMSPC)):$O(NMSP(NMSPC,"")),1:"")
"RTN","MAGQBUT4",170,0)
 Q INSTIEN
"RTN","MAGQBUT4",171,0)
ACQUD(LIMIT) ;
"RTN","MAGQBUT4",172,0)
 N I,TMP,CNT
"RTN","MAGQBUT4",173,0)
 S (I,CNT)=0
"RTN","MAGQBUT4",174,0)
 F  S I=$O(^TMP($J,"CHANGE_IEN",I)) Q:I=""  D
"RTN","MAGQBUT4",175,0)
 . S TMP=$G(^TMP($J,"CHANGE_IEN",I))
"RTN","MAGQBUT4",176,0)
 . D DFNIQ^MAGQBPG1("","Original Acquisition Site at IEN: "_$P(TMP,U,3)_" Value: "_$P(TMP,U)_" New value: "_$P(TMP,U,2),0)
"RTN","MAGQBUT4",177,0)
 . S CNT=CNT+1
"RTN","MAGQBUT4",178,0)
 . I (CNT+1)>LIMIT D
"RTN","MAGQBUT4",179,0)
 . . D DFNIQ^MAGQBPG1("Post Install Acquisition Site field Updates","",1)
"RTN","MAGQBUT4",180,0)
 . . S CNT=0
"RTN","MAGQBUT4",181,0)
 . . Q
"RTN","MAGQBUT4",182,0)
 . Q
"RTN","MAGQBUT4",183,0)
 D DFNIQ^MAGQBPG1("Post Install Acquisition Site field Updates","",1)
"RTN","MAGQBUT4",184,0)
 K ^TMP($J,"CHANGE_IEN"),TMP
"RTN","MAGQBUT4",185,0)
 Q
"RTN","MAGQBUT4",186,0)
NMSP(TMPA) ;
"RTN","MAGQBUT4",187,0)
 N IEN,INS,TMP,I,J
"RTN","MAGQBUT4",188,0)
 S INS="" F  S INS=$O(^MAG(2006.1,"B",INS)) Q:INS=""  S IEN="" D
"RTN","MAGQBUT4",189,0)
 . S IEN=$O(^MAG(2006.1,"B",INS,IEN)) Q:IEN=""  D  Q
"RTN","MAGQBUT4",190,0)
 . . S TMP=","_$$UPPER^MAGQE4($$INIS^MAGQBPG2(IEN))_"," D  Q
"RTN","MAGQBUT4",191,0)
 . . . F I=2:1 S J=$P(TMP,",",I) Q:J=""  S TMPA(J,INS)=""
"RTN","MAGQBUT4",192,0)
 . . . Q
"RTN","MAGQBUT4",193,0)
 S J="" F  S J=$O(TMPA(J)) Q:J=""  S INS=$O(TMPA(J,"")) K:($O(TMPA(J,INS))]"") TMPA(J)
"RTN","MAGQBUT4",194,0)
 Q
"RTN","MAGQBUT4",195,0)
CLRQ ; Clears the Queue file and Queue Pointer files
"RTN","MAGQBUT4",196,0)
 N DA,DIK,FILE,IEN
"RTN","MAGQBUT4",197,0)
 F FILE=2006.03,2006.031 D
"RTN","MAGQBUT4",198,0)
 . S IEN=0 F  S IEN=$O(^MAGQUEUE(FILE,IEN)) Q:'IEN  D
"RTN","MAGQBUT4",199,0)
 . . S DIK="^MAGQUEUE("_FILE_","
"RTN","MAGQBUT4",200,0)
 . . S DA=IEN,DA(1)=FILE D ^DIK
"RTN","MAGQBUT4",201,0)
 K DIK,DA
"RTN","MAGQBUT4",202,0)
 Q
"RTN","MAGQBUT4",203,0)
 ; We add RPC to MAG WINDOWS Option this way instead of sending Option : MAG WINDOWS
"RTN","MAGQBUT4",204,0)
 ; If we send MAG WINDOWS Option, the last one installed will overwrite others.
"RTN","MAGQBUT4",205,0)
 ; ADDRPC copied from Patch 51, added the call "D MES^XPDUTL(" instead of "W !"
"RTN","MAGQBUT4",206,0)
ADDRPC(RPCNAME,OPTNAME) ;
"RTN","MAGQBUT4",207,0)
 N DA,DIC
"RTN","MAGQBUT4",208,0)
 S DIC="^DIC(19,",DIC(0)="",X=OPTNAME D ^DIC
"RTN","MAGQBUT4",209,0)
 I Y<0 D  Q
"RTN","MAGQBUT4",210,0)
 . D MES^XPDUTL("Cannot add RPC: """_RPCNAME_""" to Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",211,0)
 . D MES^XPDUTL("Cannot find Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",212,0)
 . Q
"RTN","MAGQBUT4",213,0)
 I '$D(^XWB(8994,"B",RPCNAME)) D  Q
"RTN","MAGQBUT4",214,0)
 . D MES^XPDUTL("Cannot add RPC: """_RPCNAME_""" to Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",215,0)
 . D MES^XPDUTL("Cannot find RPC: """_RPCNAME_""".")
"RTN","MAGQBUT4",216,0)
 . Q
"RTN","MAGQBUT4",217,0)
 S DA(1)=+Y
"RTN","MAGQBUT4",218,0)
 I $D(^DIC(19,+Y,"RPC","B",$O(^XWB(8994,"B",RPCNAME,"")))) D  Q
"RTN","MAGQBUT4",219,0)
 . D MES^XPDUTL("Cannot add RPC: """_RPCNAME_""" to Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",220,0)
 . D MES^XPDUTL("RPC: """_RPCNAME_""" is already a member of """_OPTNAME_""".")
"RTN","MAGQBUT4",221,0)
 . Q
"RTN","MAGQBUT4",222,0)
 S DIC=DIC_DA(1)_",""RPC"","
"RTN","MAGQBUT4",223,0)
 S DIC(0)="L" ; LAYGO should be allowed here
"RTN","MAGQBUT4",224,0)
 S X=RPCNAME
"RTN","MAGQBUT4",225,0)
 D ^DIC
"RTN","MAGQBUT4",226,0)
 I Y<0 D  Q
"RTN","MAGQBUT4",227,0)
 . D MES^XPDUTL("Cannot add RPC: """_RPCNAME_""" to Option: """_OPTNAME_""".")
"RTN","MAGQBUT4",228,0)
 . D MES^XPDUTL("Cannot find RPC: """_RPCNAME_""".")
"RTN","MAGQBUT4",229,0)
 . Q
"RTN","MAGQBUT4",230,0)
 Q
"RTN","MAGQBUT4",231,0)
INS(XP,DUZ,DATE,IDA) ;
"RTN","MAGQBUT4",232,0)
 N CT,CNT,COM,D,D0,D1,D2,DDATE,DG,DIC,DICR,DIW,MAGMSG,ST,XMID,XMY
"RTN","MAGQBUT4",233,0)
 D GETENV^%ZOSV
"RTN","MAGQBUT4",234,0)
 S CNT=0
"RTN","MAGQBUT4",235,0)
 S CNT=CNT+1,MAGMSG(CNT)="PACKAGE INSTALL"
"RTN","MAGQBUT4",236,0)
 S CNT=CNT+1,MAGMSG(CNT)="SITE: "_$$KSP^XUPARAM("WHERE")
"RTN","MAGQBUT4",237,0)
 S CNT=CNT+1,MAGMSG(CNT)="PACKAGE: "_XP
"RTN","MAGQBUT4",238,0)
 S CNT=CNT+1,MAGMSG(CNT)="Version: "_$$VER^XPDUTL(XP)
"RTN","MAGQBUT4",239,0)
 S ST=$$GET1^DIQ(9.7,IDA,11,"I")
"RTN","MAGQBUT4",240,0)
 S CNT=CNT+1,MAGMSG(CNT)="Start time: "_$$FMTE^XLFDT(ST)
"RTN","MAGQBUT4",241,0)
 S CT=$$GET1^DIQ(9.7,IDA,17,"I") S:+CT'=CT CT=$$NOW^XLFDT
"RTN","MAGQBUT4",242,0)
 S CNT=CNT+1,MAGMSG(CNT)="Completion time: "_$$FMTE^XLFDT(CT)
"RTN","MAGQBUT4",243,0)
 S CNT=CNT+1,MAGMSG(CNT)="Run time: "_$$FMDIFF^XLFDT(CT,ST,3)
"RTN","MAGQBUT4",244,0)
 S CNT=CNT+1,MAGMSG(CNT)="Environment: "_Y
"RTN","MAGQBUT4",245,0)
 S COM=$$GET1^DIQ(9.7,IDA,6,"I")
"RTN","MAGQBUT4",246,0)
 S CNT=CNT+1,MAGMSG(CNT)="FILE COMMENT: "_COM
"RTN","MAGQBUT4",247,0)
 S CNT=CNT+1,MAGMSG(CNT)="DATE: "_DATE
"RTN","MAGQBUT4",248,0)
 S CNT=CNT+1,MAGMSG(CNT)="Installed by: "_$$GET1^DIQ(9.7,IDA,9,"E")
"RTN","MAGQBUT4",249,0)
 S CNT=CNT+1,MAGMSG(CNT)="Install Name: "_$$GET1^DIQ(9.7,IDA,.01,"E")
"RTN","MAGQBUT4",250,0)
 S DDATE=$$GET1^DIQ(9.7,IDA,51,"I")
"RTN","MAGQBUT4",251,0)
 S CNT=CNT+1,MAGMSG(CNT)="Distribution Date: "_$$FMTE^XLFDT(DDATE)
"RTN","MAGQBUT4",252,0)
 S XMSUB=XP_" INSTALLATION"
"RTN","MAGQBUT4",253,0)
 S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGQBUT4",254,0)
 S XMY(XMID)=""
"RTN","MAGQBUT4",255,0)
 S XMY("G.MAG SERVER")=""
"RTN","MAGQBUT4",256,0)
 S:$G(MAGDUZ) XMY(MAGDUZ)=""
"RTN","MAGQBUT4",257,0)
 S XMSUB=$E(XMSUB,1,63)
"RTN","MAGQBUT4",258,0)
 D SENDMSG^XMXAPI(XMID,XMSUB,"MAGMSG",.XMY,,.XMZ,)
"RTN","MAGQBUT4",259,0)
 I $G(XMERR) M XMERR=^TMP("XMERR",$J) S $EC=",U13-Cannot send MailMan message," K XMERR
"RTN","MAGQBUT4",260,0)
 Q
"RTN","MAGQBUT4",261,0)
 ;
"RTN","MAGQBUT5")
0^20^B15869460
"RTN","MAGQBUT5",1,0)
MAGQBUT5 ;WOIFO/RMP - BP Utilities  ;Oct 21, 2005 1:23 PM
"RTN","MAGQBUT5",2,0)
 ;;3.0;IMAGING;**20,81**;May 17, 2007
"RTN","MAGQBUT5",3,0)
 ;;  Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGQBUT5",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT5",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGQBUT5",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGQBUT5",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGQBUT5",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGQBUT5",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGQBUT5",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGQBUT5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGQBUT5",12,0)
 ;; | a medical device.  As such, it may not be changed             |
"RTN","MAGQBUT5",13,0)
 ;; | in any way.  Modifications to this software may result in an  |
"RTN","MAGQBUT5",14,0)
 ;; | adulterated medical device under 21CFR820, the use of which   |
"RTN","MAGQBUT5",15,0)
 ;; | is considered to be a violation of US Federal Statutes.       |
"RTN","MAGQBUT5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGQBUT5",17,0)
 ;;
"RTN","MAGQBUT5",18,0)
AI(RESULT) ; List of Associated Institution candidates;
"RTN","MAGQBUT5",19,0)
 N INDEX,INST,J,K,L,OUT
"RTN","MAGQBUT5",20,0)
 S K=0
"RTN","MAGQBUT5",21,0)
 S RESULT(K)=""
"RTN","MAGQBUT5",22,0)
 S K=K+1
"RTN","MAGQBUT5",23,0)
 D LIST^DIC(40.8,,".01;.07I",,,,,,,,"OUT")
"RTN","MAGQBUT5",24,0)
 S RESULT(K)="The following Medical Center Divisions have Imaging Site Parameters defined on",K=K+1
"RTN","MAGQBUT5",25,0)
 S RESULT(K)="your system:" D
"RTN","MAGQBUT5",26,0)
 . S INDEX=0,K=K+1 F  S INDEX=INDEX+1 Q:'$D(OUT("DILIST","ID",INDEX))  D
"RTN","MAGQBUT5",27,0)
 . . S INST=OUT("DILIST","ID",INDEX,.07),J=0 F  S J=$O(^MAG(2006.1,J)) Q:'J  I $P(^MAG(2006.1,J,0),U)=INST D  Q
"RTN","MAGQBUT5",28,0)
 . . . S RESULT(K)=OUT("DILIST","ID",INDEX,.01)_" "_INST,K=K+1 Q
"RTN","MAGQBUT5",29,0)
 . . Q
"RTN","MAGQBUT5",30,0)
 . Q
"RTN","MAGQBUT5",31,0)
 I INDEX=1 S RESULT(K)="None",K=K+1
"RTN","MAGQBUT5",32,0)
 S RESULT(K)="The following Medical Center Divisions have 'Associated Institutions' defined on",K=K+1
"RTN","MAGQBUT5",33,0)
 S RESULT(K)="your system:" D
"RTN","MAGQBUT5",34,0)
 . S INDEX="",K=K+1,L=K  F  S INDEX=$O(^MAG(2006.1,"B",INDEX)) Q:'INDEX  D
"RTN","MAGQBUT5",35,0)
 . . Q:$P($G(^MAG(2006.1,$O(^MAG(2006.1,"B",INDEX,"")),0)),U)=INDEX
"RTN","MAGQBUT5",36,0)
 . . S RESULT(K)=$P($G(^DIC(4,INDEX,0)),U)_" "_INDEX,K=K+1 Q
"RTN","MAGQBUT5",37,0)
 . Q
"RTN","MAGQBUT5",38,0)
 I K=L S RESULT(K)="None",K=K+1
"RTN","MAGQBUT5",39,0)
 S RESULT(K)="The following Medical Center Divisions have NO Imaging parameter affiliations",K=K+1
"RTN","MAGQBUT5",40,0)
 S RESULT(K)="defined on your system:" D
"RTN","MAGQBUT5",41,0)
 . S INDEX=0,K=K+1,L=K F  S INDEX=INDEX+1 Q:'$D(OUT("DILIST","ID",INDEX))  D
"RTN","MAGQBUT5",42,0)
 . . S INST=OUT("DILIST","ID",INDEX,.07) Q:$D(^MAG(2006.1,"B",INST))  D
"RTN","MAGQBUT5",43,0)
 . . . S RESULT(K)=OUT("DILIST","ID",INDEX,.01)_" "_INST,K=K+1 Q
"RTN","MAGQBUT5",44,0)
 . . Q
"RTN","MAGQBUT5",45,0)
 . Q
"RTN","MAGQBUT5",46,0)
 I K=L S RESULT(K)="None",K=K+1
"RTN","MAGQBUT5",47,0)
 K OUT
"RTN","MAGQBUT5",48,0)
 D CLEAN^DILF
"RTN","MAGQBUT5",49,0)
 Q
"RTN","MAGQBUT5",50,0)
PLNM(PLACE) ;  Returns the Institution name of the Place
"RTN","MAGQBUT5",51,0)
 N INST
"RTN","MAGQBUT5",52,0)
 Q:'PLACE " "
"RTN","MAGQBUT5",53,0)
 S INST=$P($G(^MAG(2006.1,PLACE,0)),U)
"RTN","MAGQBUT5",54,0)
 Q $P($G(^DIC(4,INST,0)),U)
"RTN","MAGQBUT5",55,0)
TPMESS(PLACE) ;Trigger a purge message
"RTN","MAGQBUT5",56,0)
 N Y,LOC,CNT,XMSUB
"RTN","MAGQBUT5",57,0)
 D NOW^%DTC S Y=% D DD^%DT
"RTN","MAGQBUT5",58,0)
 S LOC=$$KSP^XUPARAM("WHERE")
"RTN","MAGQBUT5",59,0)
 S CNT=1,^TMP($J,"MAGQ",CNT)="SITE: "_LOC
"RTN","MAGQBUT5",60,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="DATE: "_Y_" "_$G(^XMB("TIMEZONE"))
"RTN","MAGQBUT5",61,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="SENDER: "_$$PLNM^MAGQBUT5(PLACE)_" Imaging Background Processor"
"RTN","MAGQBUT5",62,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="An automatic purge event has been initiated"
"RTN","MAGQBUT5",63,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="in order to maintain adequate image storage"
"RTN","MAGQBUT5",64,0)
 S CNT=CNT+1,^TMP($J,"MAGQ",CNT)="no operator intervention is required."
"RTN","MAGQBUT5",65,0)
 S XMSUB="Vista Imaging BP Queue processor - Autopurge"
"RTN","MAGQBUT5",66,0)
 D MAILSHR^MAGQBUT1
"RTN","MAGQBUT5",67,0)
 Q
"RTN","MAGQBUT5",68,0)
RMRPC(NAME) ; Removing an RPC in order to revise
"RTN","MAGQBUT5",69,0)
 N MW,RPC,MWE,DIERR
"RTN","MAGQBUT5",70,0)
 S MW=$$FIND1^DIC(19,"","X","MAG WINDOWS","","","")
"RTN","MAGQBUT5",71,0)
 D CLEAN^DILF
"RTN","MAGQBUT5",72,0)
 Q:'MW
"RTN","MAGQBUT5",73,0)
 S RPC=$$FIND1^DIC(8994,"","X",NAME,"","","")
"RTN","MAGQBUT5",74,0)
 D CLEAN^DILF
"RTN","MAGQBUT5",75,0)
 Q:'RPC
"RTN","MAGQBUT5",76,0)
 S MWE=$$FIND1^DIC(19.05,","_MW_",","X",NAME,"","","")
"RTN","MAGQBUT5",77,0)
 D CLEAN^DILF
"RTN","MAGQBUT5",78,0)
 Q:'MWE
"RTN","MAGQBUT5",79,0)
 S DA=MWE,DA(1)=MW,DIK="^DIC(19,"_DA(1)_",""RPC"","
"RTN","MAGQBUT5",80,0)
 D ^DIK
"RTN","MAGQBUT5",81,0)
 K DA,DIK
"RTN","MAGQBUT5",82,0)
 S DA=RPC,DIK="^XWB(8994,"
"RTN","MAGQBUT5",83,0)
 D ^DIK
"RTN","MAGQBUT5",84,0)
 K DA,DIK
"RTN","MAGQBUT5",85,0)
 Q
"RTN","MAGQBUT5",86,0)
 ;
"VER")
8.0^22.0
**END**
**END**

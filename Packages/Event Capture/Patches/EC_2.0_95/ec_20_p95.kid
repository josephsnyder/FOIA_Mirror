KIDS Distribution saved on Sep 02, 2008@10:06:28
ECS FY08 ENHANCEMENTS EC*2.0*95 (9/2/08)
**KIDS**:EC*2.0*95^

**INSTALL NAME**
EC*2.0*95
"BLD",7278,0)
EC*2.0*95^EVENT CAPTURE^0^3080902^y
"BLD",7278,1,0)
^^2^2^3080614^
"BLD",7278,1,1,0)
Refer to the patch description for patch EC*2.0*95 in the National Patch
"BLD",7278,1,2,0)
Module (NPM) on FORUM.
"BLD",7278,4,0)
^9.64PA^721^1
"BLD",7278,4,721,0)
721
"BLD",7278,4,721,2,0)
^9.641^721.042^1
"BLD",7278,4,721,2,721.042,0)
PROVIDER MULTIPLE  (sub-file)
"BLD",7278,4,721,2,721.042,1,0)
^9.6411^.01^1
"BLD",7278,4,721,2,721.042,1,.01,0)
PROVIDER
"BLD",7278,4,721,222)
y^n^p^^^^n^^n
"BLD",7278,4,721,224)

"BLD",7278,4,"APDD",721,721.042)

"BLD",7278,4,"APDD",721,721.042,.01)

"BLD",7278,4,"B",721,721)

"BLD",7278,6.3)
26
"BLD",7278,"ABPKG")
n
"BLD",7278,"INI")
PRE^EC20P95
"BLD",7278,"INID")
n^n^n
"BLD",7278,"INIT")
POST^EC20P95
"BLD",7278,"KRN",0)
^9.67PA^8989.52^19
"BLD",7278,"KRN",.4,0)
.4
"BLD",7278,"KRN",.401,0)
.401
"BLD",7278,"KRN",.402,0)
.402
"BLD",7278,"KRN",.403,0)
.403
"BLD",7278,"KRN",.5,0)
.5
"BLD",7278,"KRN",.84,0)
.84
"BLD",7278,"KRN",3.6,0)
3.6
"BLD",7278,"KRN",3.8,0)
3.8
"BLD",7278,"KRN",9.2,0)
9.2
"BLD",7278,"KRN",9.2,"NM",0)
^9.68A^1^1
"BLD",7278,"KRN",9.2,"NM",1,0)
ECRDSSA^^0
"BLD",7278,"KRN",9.2,"NM","B","ECRDSSA",1)

"BLD",7278,"KRN",9.8,0)
9.8
"BLD",7278,"KRN",9.8,"NM",0)
^9.68A^34^27
"BLD",7278,"KRN",9.8,"NM",1,0)
ECBEN2U^^0^B34259052
"BLD",7278,"KRN",9.8,"NM",2,0)
ECEFPAT^^0^B57770429
"BLD",7278,"KRN",9.8,"NM",3,0)
ECMFECS^^0^B37201667
"BLD",7278,"KRN",9.8,"NM",4,0)
ECOSSUM^^0^B64825146
"BLD",7278,"KRN",9.8,"NM",5,0)
ECPAT^^0^B32218957
"BLD",7278,"KRN",9.8,"NM",6,0)
ECPCER^^0^B20555015
"BLD",7278,"KRN",9.8,"NM",7,0)
ECPCEU^^0^B29653566
"BLD",7278,"KRN",9.8,"NM",8,0)
ECPROV3^^0^B36456147
"BLD",7278,"KRN",9.8,"NM",9,0)
ECPRSUM1^^0^B29801966
"BLD",7278,"KRN",9.8,"NM",10,0)
ECRDSSA^^0^B100885193
"BLD",7278,"KRN",9.8,"NM",11,0)
ECRDSSU^^0^B52276776
"BLD",7278,"KRN",9.8,"NM",12,0)
ECRRPC^^0^B12656189
"BLD",7278,"KRN",9.8,"NM",13,0)
ECRRPT^^0^B53873531
"BLD",7278,"KRN",9.8,"NM",14,0)
ECRRPT1^^0^B51929894
"BLD",7278,"KRN",9.8,"NM",21,0)
ECSCPT^^0^B11029333
"BLD",7278,"KRN",9.8,"NM",22,0)
ECSCPT1^^0^B9008177
"BLD",7278,"KRN",9.8,"NM",23,0)
ECSUM^^0^B13051883
"BLD",7278,"KRN",9.8,"NM",24,0)
ECSUM1^^0^B11875694
"BLD",7278,"KRN",9.8,"NM",25,0)
ECUERPC^^0^B51135256
"BLD",7278,"KRN",9.8,"NM",27,0)
ECUURPC^^0^B5658708
"BLD",7278,"KRN",9.8,"NM",28,0)
ECV2RPC^^0^B23577970
"BLD",7278,"KRN",9.8,"NM",29,0)
ECDSS1^^0^B15692712
"BLD",7278,"KRN",9.8,"NM",30,0)
ECDSS3^^0^B4631829
"BLD",7278,"KRN",9.8,"NM",31,0)
ECUTL^^0^B25415242
"BLD",7278,"KRN",9.8,"NM",32,0)
ECUTL2^^0^B28978680
"BLD",7278,"KRN",9.8,"NM",33,0)
ECUMRPC1^^0^B63202010
"BLD",7278,"KRN",9.8,"NM",34,0)
ECUMRPC2^^0^B30358856
"BLD",7278,"KRN",9.8,"NM","B","ECBEN2U",1)

"BLD",7278,"KRN",9.8,"NM","B","ECDSS1",29)

"BLD",7278,"KRN",9.8,"NM","B","ECDSS3",30)

"BLD",7278,"KRN",9.8,"NM","B","ECEFPAT",2)

"BLD",7278,"KRN",9.8,"NM","B","ECMFECS",3)

"BLD",7278,"KRN",9.8,"NM","B","ECOSSUM",4)

"BLD",7278,"KRN",9.8,"NM","B","ECPAT",5)

"BLD",7278,"KRN",9.8,"NM","B","ECPCER",6)

"BLD",7278,"KRN",9.8,"NM","B","ECPCEU",7)

"BLD",7278,"KRN",9.8,"NM","B","ECPROV3",8)

"BLD",7278,"KRN",9.8,"NM","B","ECPRSUM1",9)

"BLD",7278,"KRN",9.8,"NM","B","ECRDSSA",10)

"BLD",7278,"KRN",9.8,"NM","B","ECRDSSU",11)

"BLD",7278,"KRN",9.8,"NM","B","ECRRPC",12)

"BLD",7278,"KRN",9.8,"NM","B","ECRRPT",13)

"BLD",7278,"KRN",9.8,"NM","B","ECRRPT1",14)

"BLD",7278,"KRN",9.8,"NM","B","ECSCPT",21)

"BLD",7278,"KRN",9.8,"NM","B","ECSCPT1",22)

"BLD",7278,"KRN",9.8,"NM","B","ECSUM",23)

"BLD",7278,"KRN",9.8,"NM","B","ECSUM1",24)

"BLD",7278,"KRN",9.8,"NM","B","ECUERPC",25)

"BLD",7278,"KRN",9.8,"NM","B","ECUMRPC1",33)

"BLD",7278,"KRN",9.8,"NM","B","ECUMRPC2",34)

"BLD",7278,"KRN",9.8,"NM","B","ECUTL",31)

"BLD",7278,"KRN",9.8,"NM","B","ECUTL2",32)

"BLD",7278,"KRN",9.8,"NM","B","ECUURPC",27)

"BLD",7278,"KRN",9.8,"NM","B","ECV2RPC",28)

"BLD",7278,"KRN",19,0)
19
"BLD",7278,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",7278,"KRN",19,"NM",1,0)
EC GUI CONTEXT^^0
"BLD",7278,"KRN",19,"NM",2,0)
EC PCE FEED^^0
"BLD",7278,"KRN",19,"NM","B","EC GUI CONTEXT",1)

"BLD",7278,"KRN",19,"NM","B","EC PCE FEED",2)

"BLD",7278,"KRN",19.1,0)
19.1
"BLD",7278,"KRN",101,0)
101
"BLD",7278,"KRN",409.61,0)
409.61
"BLD",7278,"KRN",771,0)
771
"BLD",7278,"KRN",870,0)
870
"BLD",7278,"KRN",8989.51,0)
8989.51
"BLD",7278,"KRN",8989.52,0)
8989.52
"BLD",7278,"KRN",8994,0)
8994
"BLD",7278,"KRN",8994,"NM",0)
^9.68A^1^1
"BLD",7278,"KRN",8994,"NM",1,0)
EC GETLIST^^0
"BLD",7278,"KRN",8994,"NM","B","EC GETLIST",1)

"BLD",7278,"KRN","B",.4,.4)

"BLD",7278,"KRN","B",.401,.401)

"BLD",7278,"KRN","B",.402,.402)

"BLD",7278,"KRN","B",.403,.403)

"BLD",7278,"KRN","B",.5,.5)

"BLD",7278,"KRN","B",.84,.84)

"BLD",7278,"KRN","B",3.6,3.6)

"BLD",7278,"KRN","B",3.8,3.8)

"BLD",7278,"KRN","B",9.2,9.2)

"BLD",7278,"KRN","B",9.8,9.8)

"BLD",7278,"KRN","B",19,19)

"BLD",7278,"KRN","B",19.1,19.1)

"BLD",7278,"KRN","B",101,101)

"BLD",7278,"KRN","B",409.61,409.61)

"BLD",7278,"KRN","B",771,771)

"BLD",7278,"KRN","B",870,870)

"BLD",7278,"KRN","B",8989.51,8989.51)

"BLD",7278,"KRN","B",8989.52,8989.52)

"BLD",7278,"KRN","B",8994,8994)

"BLD",7278,"PRE")
EC20P95
"BLD",7278,"QUES",0)
^9.62^^
"BLD",7278,"REQB",0)
^9.611^5^5
"BLD",7278,"REQB",1,0)
EC*2.0*65^2
"BLD",7278,"REQB",2,0)
EC*2.0*82^2
"BLD",7278,"REQB",3,0)
EC*2.0*88^2
"BLD",7278,"REQB",4,0)
EC*2.0*90^2
"BLD",7278,"REQB",5,0)
EC*2.0*92^2
"BLD",7278,"REQB","B","EC*2.0*65",1)

"BLD",7278,"REQB","B","EC*2.0*82",2)

"BLD",7278,"REQB","B","EC*2.0*88",3)

"BLD",7278,"REQB","B","EC*2.0*90",4)

"BLD",7278,"REQB","B","EC*2.0*92",5)

"FIA",721)
EVENT CAPTURE PATIENT
"FIA",721,0)
^ECH(
"FIA",721,0,0)
721A
"FIA",721,0,1)
y^n^p^^^^n^^n
"FIA",721,0,10)

"FIA",721,0,11)

"FIA",721,0,"RLRO")

"FIA",721,0,"VR")
2.0^EC
"FIA",721,721)
1
"FIA",721,721,42)

"FIA",721,721.042)
1
"FIA",721,721.042,.01)

"INI")
PRE^EC20P95
"INIT")
POST^EC20P95
"KRN",9.2,1551,-1)
0^1
"KRN",9.2,1551,0)
ECRDSSA^DSS Unit Activity Report^3071023.124544^
"KRN",9.2,1551,1,0)
^^18^18^3071023^
"KRN",9.2,1551,1,1,0)
This option allows the user to print/display all patients for a specified 
"KRN",9.2,1551,1,2,0)
location and specified DSS Unit within a selected date range.  The 
"KRN",9.2,1551,1,3,0)
patients may be sorted in Patient Name, SSN, or Provider Name order.  The 
"KRN",9.2,1551,1,4,0)
output includes:
"KRN",9.2,1551,1,5,0)
 
"KRN",9.2,1551,1,6,0)
 - Patient Name
"KRN",9.2,1551,1,7,0)
 - SSN
"KRN",9.2,1551,1,8,0)
 - Inpatient/Outpatient indicator
"KRN",9.2,1551,1,9,0)
 - Date and Time
"KRN",9.2,1551,1,10,0)
 - Procedure Code
"KRN",9.2,1551,1,11,0)
 - Procedure Name
"KRN",9.2,1551,1,12,0)
 - Volume
"KRN",9.2,1551,1,13,0)
 - Primary Provider
"KRN",9.2,1551,1,14,0)
 - Primary Diagnosis
"KRN",9.2,1551,1,15,0)
 
"KRN",9.2,1551,1,16,0)
If more than one location has been set up, you will be prompted to 
"KRN",9.2,1551,1,17,0)
select all or specific locations. You will also be prompted to select all
"KRN",9.2,1551,1,18,0)
or specific DSS Units.
"KRN",9.2,1551,10.2)
W @IOF
"KRN",19,7753,-1)
0^2
"KRN",19,7753,0)
EC PCE FEED^EC Data Feed to PCE^^R^^^^^^^^EVENT CAPTURE
"KRN",19,7753,1,0)
^19.06^6^6^3070926^^
"KRN",19,7753,1,1,0)
This option controls the routine that sends Event Capture data 
"KRN",19,7753,1,2,0)
to Patient Care Encounter (PCE) software.  The EC system data 
"KRN",19,7753,1,3,0)
is stored in the EVENT CAPTURE PATIENT file (#721).  EC data
"KRN",19,7753,1,4,0)
that has been flagged to send to PCE will be picked and sent when
"KRN",19,7753,1,5,0)
this routine is run. It is recommended that this routine be schedule 
"KRN",19,7753,1,6,0)
to run every 60-180 (1-3 minutes).
"KRN",19,7753,25)
NITE^ECPCEU
"KRN",19,7753,"U")
EC DATA FEED TO PCE
"KRN",19,11187,-1)
0^1
"KRN",19,11187,0)
EC GUI CONTEXT^EC GUI Context version 2.1.1.0^^B^^^^^^^^EVENT CAPTURE
"KRN",19,11187,1,0)
^19.06^1^1^3070426^^^^
"KRN",19,11187,1,1,0)
This is the Broker Client/Server type option for the Event Capture GUI option
"KRN",19,11187,99)
58583,58456
"KRN",19,11187,99.1)
61090,58595
"KRN",19,11187,"RPC",0)
^19.05P^53^53
"KRN",19,11187,"RPC",1,0)
EC DSSCATCHECK
"KRN",19,11187,"RPC",2,0)
EC FILER
"KRN",19,11187,"RPC",3,0)
EC GETBATPROCS
"KRN",19,11187,"RPC",4,0)
EC GETCAT
"KRN",19,11187,"RPC",5,0)
EC GETCPTLST
"KRN",19,11187,"RPC",6,0)
EC GETDSSECS
"KRN",19,11187,"RPC",7,0)
EC GETDSSUNIT
"KRN",19,11187,"RPC",8,0)
EC GETDSSUNITUSRS
"KRN",19,11187,"RPC",9,0)
EC GETECLOC
"KRN",19,11187,"RPC",10,0)
EC GETECSCATS
"KRN",19,11187,"RPC",11,0)
EC GETECSCREEN
"KRN",19,11187,"RPC",12,0)
EC GETECSDETAIL
"KRN",19,11187,"RPC",13,0)
EC GETECSPROCS
"KRN",19,11187,"RPC",14,0)
EC GETENCDXS
"KRN",19,11187,"RPC",15,0)
EC GETIEN
"KRN",19,11187,"RPC",16,0)
EC GETLIST
"KRN",19,11187,"RPC",17,0)
EC GETLOC
"KRN",19,11187,"RPC",18,0)
EC GETNATPX
"KRN",19,11187,"RPC",19,0)
EC GETPATCLASTAT
"KRN",19,11187,"RPC",20,0)
EC GETPATELIG
"KRN",19,11187,"RPC",21,0)
EC GETPATINFO
"KRN",19,11187,"RPC",22,0)
EC GETPATPROCS
"KRN",19,11187,"RPC",23,0)
EC GETPRODEFS
"KRN",19,11187,"RPC",24,0)
EC GETPROVIDER
"KRN",19,11187,"RPC",25,0)
EC GETPXLST
"KRN",19,11187,"RPC",26,0)
EC GETPXMODIFIER
"KRN",19,11187,"RPC",27,0)
EC GETPXREASON
"KRN",19,11187,"RPC",28,0)
EC GETSCNHELP
"KRN",19,11187,"RPC",29,0)
EC GETUSRDSSUNIT
"KRN",19,11187,"RPC",30,0)
EC REPORTS
"KRN",19,11187,"RPC",31,0)
EC VALIDATE SPREADSHEET DATA
"KRN",19,11187,"RPC",32,0)
ORWU USERINFO
"KRN",19,11187,"RPC",33,0)
ORWU HASKEY
"KRN",19,11187,"RPC",34,0)
ORWU DEVICE
"KRN",19,11187,"RPC",35,0)
SC PATIENT LOOKUP
"KRN",19,11187,"RPC",36,0)
ORWU NEWPERS
"KRN",19,11187,"RPC",37,0)
DDR GET DD HELP
"KRN",19,11187,"RPC",38,0)
DDR FINDER
"KRN",19,11187,"RPC",39,0)
DDR FIND1
"KRN",19,11187,"RPC",40,0)
DDR LISTER
"KRN",19,11187,"RPC",41,0)
EC GETDATE
"KRN",19,11187,"RPC",42,0)
EC CLASHELP
"KRN",19,11187,"RPC",43,0)
DDR GETS ENTRY DATA
"KRN",19,11187,"RPC",44,0)
DG CHK BS5 XREF Y/N
"KRN",19,11187,"RPC",45,0)
DG SENSITIVE RECORD ACCESS
"KRN",19,11187,"RPC",46,0)
DG SENSITIVE RECORD BULLETIN
"KRN",19,11187,"RPC",47,0)
DG CHK PAT/DIV MEANS TEST
"KRN",19,11187,"RPC",48,0)
EC SPACEBAR
"KRN",19,11187,"RPC",49,0)
EC DIEDON
"KRN",19,11187,"RPC",50,0)
EC GETPATCH
"KRN",19,11187,"RPC",51,0)
EC GETVISITINFO
"KRN",19,11187,"RPC",52,0)
EC GETVERSION
"KRN",19,11187,"RPC",53,0)
ORWU DT
"KRN",19,11187,"U")
EC GUI CONTEXT VERSION 2.1.1.0
"KRN",8994,843,-1)
0^1
"KRN",8994,843,0)
EC GETLIST^SRCLST^ECUMRPC1^4^R^^^1
"KRN",8994,843,1,0)
^8994.01^1^1^3080724^^^
"KRN",8994,843,1,1,0)
This call is used to perform a search on a file based on a search string.
"KRN",8994,843,2,0)
^8994.02A^1^1
"KRN",8994,843,2,1,0)
ECARY^1^^1
"KRN",8994,843,2,1,1,0)
^^5^5^3080724^
"KRN",8994,843,2,1,1,1,0)
The input string ECARY contains four pieces separated by "^"
"KRN",8994,843,2,1,1,2,0)
     ECSTR  - Search string
"KRN",8994,843,2,1,1,3,0)
     ECFIL  - File to search
"KRN",8994,843,2,1,1,4,0)
     ECDIR  - Search order
"KRN",8994,843,2,1,1,5,0)
     ECNUM  - (Optional) Number of records to return [DEFAULT: 44]
"KRN",8994,843,2,"B","ECARY",1)

"KRN",8994,843,3,0)
^8994.03^1^1^3010503^^
"KRN",8994,843,3,1,0)
Returns a list of values based on the search criteria.
"MBREQ")
0
"ORD",1,9.2)
9.2;1;;;HELP^XPDTA1;HLPF1^XPDIA1;HLPE1^XPDIA1;HLPF2^XPDIA1;;HLPDEL^XPDIA1
"ORD",1,9.2,0)
HELP FRAME
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",486,-1)
1^1
"PKG",486,0)
EVENT CAPTURE^EC^Event Capture Workload Capture System^
"PKG",486,20,0)
^9.402P^^
"PKG",486,22,0)
^9.49I^1^1
"PKG",486,22,1,0)
2.0^2960508^2981027^66481
"PKG",486,22,1,"PAH",1,0)
95^3080902^101042
"PKG",486,22,1,"PAH",1,1,0)
^^2^2^3080902
"PKG",486,22,1,"PAH",1,1,1,0)
Refer to the patch description for patch EC*2.0*95 in the National Patch
"PKG",486,22,1,"PAH",1,1,2,0)
Module (NPM) on FORUM.
"PRE")
EC20P95
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
28
"RTN","EC20P95")
0^^B17418626
"RTN","EC20P95",1,0)
EC20P95 ;ALB/RPM - PATCH 95 ENV/PRE/POST INSTALL ; 07/29/08
"RTN","EC20P95",2,0)
 ;;2.0; EVENT CAPTURE ;**95**; 8 MAY 96;Build 26
"RTN","EC20P95",3,0)
 ;
"RTN","EC20P95",4,0)
ENV ;environment check
"RTN","EC20P95",5,0)
 S XPDABORT=""
"RTN","EC20P95",6,0)
 D PROGCHK(.XPDABORT) ;checks programmer variables
"RTN","EC20P95",7,0)
 ;rename option only during install, not during load
"RTN","EC20P95",8,0)
 I '$G(XPDABORT),$G(XPDENV)=1 D
"RTN","EC20P95",9,0)
 . I '$$RENOPT("EC NIGHT","EC PCE FEED") S XPDABORT=2
"RTN","EC20P95",10,0)
 I XPDABORT="" K XPDABORT
"RTN","EC20P95",11,0)
 Q
"RTN","EC20P95",12,0)
 ;
"RTN","EC20P95",13,0)
 ;
"RTN","EC20P95",14,0)
PRE ;pre-install
"RTN","EC20P95",15,0)
 Q
"RTN","EC20P95",16,0)
 ;
"RTN","EC20P95",17,0)
 ;
"RTN","EC20P95",18,0)
POST ;post-install
"RTN","EC20P95",19,0)
 D POST1  ;build 'APRV' index
"RTN","EC20P95",20,0)
 Q
"RTN","EC20P95",21,0)
 ;
"RTN","EC20P95",22,0)
 ;
"RTN","EC20P95",23,0)
PROGCHK(XPDABORT) ;checks for necessary programmer variables
"RTN","EC20P95",24,0)
 ;
"RTN","EC20P95",25,0)
 I '$G(DUZ)!($G(DUZ(0))'="@")!('$G(DT))!($G(U)'="^") DO
"RTN","EC20P95",26,0)
 . D BMES^XPDUTL("******")
"RTN","EC20P95",27,0)
 . D MES^XPDUTL("Your programming variables are not set up properly.")
"RTN","EC20P95",28,0)
 . D MES^XPDUTL("Installation aborted.")
"RTN","EC20P95",29,0)
 . D MES^XPDUTL("******")
"RTN","EC20P95",30,0)
 . S XPDABORT=2
"RTN","EC20P95",31,0)
 Q
"RTN","EC20P95",32,0)
 ;
"RTN","EC20P95",33,0)
 ;
"RTN","EC20P95",34,0)
RENOPT(ECOLD,ECNEW) ;rename option
"RTN","EC20P95",35,0)
 ;
"RTN","EC20P95",36,0)
 ;  Input:
"RTN","EC20P95",37,0)
 ;    ECOLD - original option name
"RTN","EC20P95",38,0)
 ;    ECNEW - new option name
"RTN","EC20P95",39,0)
 ;
"RTN","EC20P95",40,0)
 ;  Output:
"RTN","EC20P95",41,0)
 ;   Function value - returns 1 on success; 0 on failure
"RTN","EC20P95",42,0)
 ;
"RTN","EC20P95",43,0)
 N ECRSLT
"RTN","EC20P95",44,0)
 S ECRSLT=1
"RTN","EC20P95",45,0)
 I $G(ECOLD)'="",$G(ECNEW)'="",+$$LKOPT^XPDMENU(ECOLD)>0 D
"RTN","EC20P95",46,0)
 . D RENAME^XPDMENU(ECOLD,ECNEW)
"RTN","EC20P95",47,0)
 . I +$$LKOPT^XPDMENU(ECNEW)'>0 D
"RTN","EC20P95",48,0)
 . . D BMES^XPDUTL("******")
"RTN","EC20P95",49,0)
 . . D MES^XPDUTL("The installation process failed to rename the")
"RTN","EC20P95",50,0)
 . . D MES^XPDUTL(ECOLD_" option to "_ECNEW_".")
"RTN","EC20P95",51,0)
 . . D MES^XPDUTL("Installation aborted.")
"RTN","EC20P95",52,0)
 . . D MES^XPDUTL("******")
"RTN","EC20P95",53,0)
 . . S ECRSLT=0
"RTN","EC20P95",54,0)
 Q ECRSLT
"RTN","EC20P95",55,0)
 ;
"RTN","EC20P95",56,0)
POST1 ;Set up TaskMan to build 'APRV' index in the background
"RTN","EC20P95",57,0)
 N ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK
"RTN","EC20P95",58,0)
 S ZTRTN="BLDIDX^EC20P95"
"RTN","EC20P95",59,0)
 S ZTDESC="Populate 'APRV' index for EC*2.0*95"
"RTN","EC20P95",60,0)
 ;Queue Task to start in 60 seconds
"RTN","EC20P95",61,0)
 S ZTDTH=$$SCH^XLFDT("60S",$$NOW^XLFDT)
"RTN","EC20P95",62,0)
 S ZTIO=""
"RTN","EC20P95",63,0)
 D ^%ZTLOAD
"RTN","EC20P95",64,0)
 D BMES^XPDUTL("*****")
"RTN","EC20P95",65,0)
 D
"RTN","EC20P95",66,0)
 . I $D(ZTSK)[0 D  Q
"RTN","EC20P95",67,0)
 . .D MES^XPDUTL("TaskMan run to populate 'APRV' index for EC*2.0*95 was not started.")
"RTN","EC20P95",68,0)
 . .D MES^XPDUTL("Re-run Post Install routine POST1^EC20P95.")
"RTN","EC20P95",69,0)
 . D MES^XPDUTL("Task "_ZTSK_" started to populate 'APRV' index.")
"RTN","EC20P95",70,0)
 . I $D(ZTSK("D")) D
"RTN","EC20P95",71,0)
 . . D MES^XPDUTL("Task will start at "_$$HTE^XLFDT(ZTSK("D")))
"RTN","EC20P95",72,0)
 D MES^XPDUTL("*****")
"RTN","EC20P95",73,0)
 Q
"RTN","EC20P95",74,0)
 ;
"RTN","EC20P95",75,0)
BLDIDX ;BUILD 'APRV' INDEX
"RTN","EC20P95",76,0)
 N DA,DIK
"RTN","EC20P95",77,0)
 N ECMSG    ;error/stop messages
"RTN","EC20P95",78,0)
 N ECSTIME  ;start time
"RTN","EC20P95",79,0)
 N ECCNT    ;record counter
"RTN","EC20P95",80,0)
 N ECQUIT   ;task stop flag
"RTN","EC20P95",81,0)
 ;
"RTN","EC20P95",82,0)
 S ECQUIT=0
"RTN","EC20P95",83,0)
 S ECCNT=0
"RTN","EC20P95",84,0)
 S ECMSG=""
"RTN","EC20P95",85,0)
 S ECSTIME=$$NOW^XLFDT()
"RTN","EC20P95",86,0)
 S DA(1)=0
"RTN","EC20P95",87,0)
 F  S DA(1)=$O(^ECH(DA(1))) Q:'DA(1)!(ECQUIT)  D
"RTN","EC20P95",88,0)
 . S ECCNT=ECCNT+1
"RTN","EC20P95",89,0)
 . S DIK="^ECH(DA(1),""PRV"","
"RTN","EC20P95",90,0)
 . S DIK(1)=".01^APRV"
"RTN","EC20P95",91,0)
 . D ENALL^DIK
"RTN","EC20P95",92,0)
 . I ECCNT#1000,$$S^%ZTLOAD D  Q
"RTN","EC20P95",93,0)
 . . S ECMSG=2
"RTN","EC20P95",94,0)
 . . S ECMSG(1)="Patch EC*2.0*95 'APRV' Re-index Task Stopped by User"
"RTN","EC20P95",95,0)
 . . S ECMSG(2)="Re-run Post Install routine POST1^EC20P95."
"RTN","EC20P95",96,0)
 . . S (ZTSTOP,ECQUIT)=1
"RTN","EC20P95",97,0)
 D NOTIFY(ECSTIME,.ECMSG)
"RTN","EC20P95",98,0)
 Q
"RTN","EC20P95",99,0)
 ;
"RTN","EC20P95",100,0)
NOTIFY(ECSTIME,ECMESS) ;send job msg
"RTN","EC20P95",101,0)
 ;
"RTN","EC20P95",102,0)
 ;  Input
"RTN","EC20P95",103,0)
 ;    ECSTIME - job start date/time
"RTN","EC20P95",104,0)
 ;    ECMESS - free text message array for task stop or errors passed
"RTN","EC20P95",105,0)
 ;             by reference
"RTN","EC20P95",106,0)
 ;
"RTN","EC20P95",107,0)
 ;  Output
"RTN","EC20P95",108,0)
 ;    none
"RTN","EC20P95",109,0)
 ;
"RTN","EC20P95",110,0)
 N DIFROM,XMDUZ,XMSUB,XMTEXT,XMY,XMZ
"RTN","EC20P95",111,0)
 N ECSITE,ECETIME,ECTEXT,ECI
"RTN","EC20P95",112,0)
 S ECSITE=$$SITE^VASITE
"RTN","EC20P95",113,0)
 S ECETIME=$$NOW^XLFDT
"RTN","EC20P95",114,0)
 S XMDUZ="'APRV' RE-INDEX"
"RTN","EC20P95",115,0)
 S XMSUB="Patch EC*2.0*95 ECS FY08 Enhancements"
"RTN","EC20P95",116,0)
 S XMTEXT="ECTEXT("
"RTN","EC20P95",117,0)
 S XMY(DUZ)=""
"RTN","EC20P95",118,0)
 S ECTEXT(1)=""
"RTN","EC20P95",119,0)
 S ECTEXT(2)="          Facility Name:  "_$P(ECSITE,U,2)
"RTN","EC20P95",120,0)
 S ECTEXT(3)="         Station Number:  "_$P(ECSITE,U,3)
"RTN","EC20P95",121,0)
 S ECTEXT(4)=""
"RTN","EC20P95",122,0)
 S ECTEXT(5)="  Date/Time job started:  "_$$FMTE^XLFDT(ECSTIME)
"RTN","EC20P95",123,0)
 S ECTEXT(6)="  Date/Time job stopped:  "_$$FMTE^XLFDT(ECETIME)
"RTN","EC20P95",124,0)
 S ECTEXT(7)=""
"RTN","EC20P95",125,0)
 I $G(ECMESS) D
"RTN","EC20P95",126,0)
 . F ECI=1:1:ECMESS D
"RTN","EC20P95",127,0)
 . . S ECTEXT(7+ECI)="*** "_$E($G(ECMESS(ECI)),1,65)
"RTN","EC20P95",128,0)
 I '$G(ECMESS) D
"RTN","EC20P95",129,0)
 . S ECTEXT(8)="'APRV' Index Populated Successfully"
"RTN","EC20P95",130,0)
 D ^XMD
"RTN","EC20P95",131,0)
 Q
"RTN","ECBEN2U")
0^1^B34259052
"RTN","ECBEN2U",1,0)
ECBEN2U ;BIR/MAM,JPW - Categories and Procedures Selection ;23 Jul 2008
"RTN","ECBEN2U",2,0)
 ;;2.0; EVENT CAPTURE ;**4,5,7,10,17,18,23,42,47,54,72,95**;8 May 96;Build 26
"RTN","ECBEN2U",3,0)
END Q
"RTN","ECBEN2U",4,0)
HDR ;screen header
"RTN","ECBEN2U",5,0)
 W @IOF,!,"Location: ",ECLN
"RTN","ECBEN2U",6,0)
 W !,"DSS Unit: ",$E(ECDN,1,30) I $G(ECCN)]"" W ?48,"Category: ",$E(ECCN,1,20)
"RTN","ECBEN2U",7,0)
 W !,"Ordering Section: ",ECON
"RTN","ECBEN2U",8,0)
 W !,"Procedure Date: ",ECDATE,!
"RTN","ECBEN2U",9,0)
 D DSP1416^ECPRVMUT(.ECPRVARY)
"RTN","ECBEN2U",10,0)
 W !
"RTN","ECBEN2U",11,0)
 Q
"RTN","ECBEN2U",12,0)
MSG W !!,"No procedures entered.  No Action Taken.",!!,"Press <RET> to continue " R X:DTIME S ECOUT=1
"RTN","ECBEN2U",13,0)
 Q
"RTN","ECBEN2U",14,0)
MSG1 ;
"RTN","ECBEN2U",15,0)
 W !!,"Please enter the number that corresponds to the "_$S(OK:"procedure",1:"category")_" from which",!,"you would like to select a procedure.  If you would like to continue",!,"with the list, press <RET>.  Enter ^ to quit."
"RTN","ECBEN2U",16,0)
 S CNT=CNT-5
"RTN","ECBEN2U",17,0)
 Q
"RTN","ECBEN2U",18,0)
HDRP ;hdr batch by proc
"RTN","ECBEN2U",19,0)
 W @IOF,!,"Location: ",ECLN
"RTN","ECBEN2U",20,0)
 I $G(ECCN)]"" W !,"Category: ",ECCN
"RTN","ECBEN2U",21,0)
 W !,"Procedure Date: ",ECDATE
"RTN","ECBEN2U",22,0)
 D DSP1442^ECPRVMUT(.ECPRVARY)
"RTN","ECBEN2U",23,0)
 W !
"RTN","ECBEN2U",24,0)
 Q
"RTN","ECBEN2U",25,0)
PCEQST ;entry pt for PCE questions
"RTN","ECBEN2U",26,0)
 S (ECDX,ECDXN,ECVST,ECSC,ECAO,ECIR,ECZEC,ECMST,ECHNC,ECCV)=""
"RTN","ECBEN2U",27,0)
INP ;- Set inpatient/outpatient status
"RTN","ECBEN2U",28,0)
 S ECINP=$G(ECPTSTAT)
"RTN","ECBEN2U",29,0)
 D CLINIC I ECOUT Q
"RTN","ECBEN2U",30,0)
 ;ask dx
"RTN","ECBEN2U",31,0)
 D DIAG^ECUTL2 I ECOUT Q
"RTN","ECBEN2U",32,0)
 I $P(ECPCE,"~",2)="O"&(ECINP'="O") Q
"RTN","ECBEN2U",33,0)
 D VISIT
"RTN","ECBEN2U",34,0)
 Q
"RTN","ECBEN2U",35,0)
CLINIC ;display default clinic
"RTN","ECBEN2U",36,0)
 Q:$P(ECPCE,"~",2)="N"  I $P(ECPCE,"~",2)="O"&(ECINP'="O") Q
"RTN","ECBEN2U",37,0)
 K DA,DIR,DIROUT,DIRUT,DTOUT,DUOUT S DIR(0)="721,26",DIR("A")="Associated Clinic",DIR("?")="An active clinic is required. Enter an active clinic or an ^ to exit"
"RTN","ECBEN2U",38,0)
 I EC4,EC4N'["NO ASSOCIATED CLINIC" S DIR("B")=EC4N
"RTN","ECBEN2U",39,0)
 D ^DIR K DIR
"RTN","ECBEN2U",40,0)
 I Y S EC4=+Y,ECID=$P($G(^SC(+EC4,0)),"^",7)
"RTN","ECBEN2U",41,0)
 I $D(DTOUT)!$D(DUOUT) S ECOUT=1 Q
"RTN","ECBEN2U",42,0)
 I +EC4,'$G(ECOUT) D CLIN I 'ECPCL W !!,"You must enter an active clinic now.",! G CLINIC
"RTN","ECBEN2U",43,0)
 I $D(DTOUT)!$D(DUOUT)!('Y)!(Y<0) W:$P(ECPCE,"~",2)'="N" !!,"Please note that this record cannot be sent to PCE without an active clinic.",!!
"RTN","ECBEN2U",44,0)
 Q
"RTN","ECBEN2U",45,0)
VISIT ;ask visit info
"RTN","ECBEN2U",46,0)
 Q:ECINP="I"
"RTN","ECBEN2U",47,0)
 ;
"RTN","ECBEN2U",48,0)
 ;- Ask classification questions applicable to patient and file in #721
"RTN","ECBEN2U",49,0)
 I $$ASKCLASS^ECUTL1(+$G(ECPT(CNT)),.ECCLFLDS,.ECOUT,ECPCE,ECINP),($O(ECCLFLDS(""))]"") D SETCLASS^ECUTL1(.ECCLFLDS)
"RTN","ECBEN2U",50,0)
 I +$G(ECOUT) Q
"RTN","ECBEN2U",51,0)
 K ECCLFLDS
"RTN","ECBEN2U",52,0)
 Q
"RTN","ECBEN2U",53,0)
PCEE ;checks edited data and sets PCE node for filing
"RTN","ECBEN2U",54,0)
 S ECVST=+$P(EC(0),"^",21) I 'ECVST G PCE
"RTN","ECBEN2U",55,0)
DEL ;delete visit and refresh data to PCE
"RTN","ECBEN2U",56,0)
 K DA,DIE,DR S DA=ECFN,DIE=721,DR="25///@;28///@" D ^DIE K DA,DIE,DR
"RTN","ECBEN2U",57,0)
 ;
"RTN","ECBEN2U",58,0)
 ;* Prepare all EC records with same Visit file entry to resend to PCE
"RTN","ECBEN2U",59,0)
 N ECVAR1,EC2PCE S ECVAR1=$$FNDVST^ECUTL(ECVST,ECFN,.EC2PCE) K ECVAR1
"RTN","ECBEN2U",60,0)
 ;
"RTN","ECBEN2U",61,0)
 ;- Set VALQUIET to stop Amb Care validator from broadcasting to screen
"RTN","ECBEN2U",62,0)
 N ECPKG,ECSOU
"RTN","ECBEN2U",63,0)
 S ECPKG=$O(^DIC(9.4,"B","EVENT CAPTURE",0)),ECSOU="EVENT CAPTURE DATA"
"RTN","ECBEN2U",64,0)
 S VALQUIET=1,ECVV=$$DELVFILE^PXAPI("ALL",ECVST,ECPKG,ECSOU) K ECVST,VALQUIET
"RTN","ECBEN2U",65,0)
 ;- Resend to PCE task
"RTN","ECBEN2U",66,0)
 D PCETASK^ECPCEU(.EC2PCE) K EC2PCE
"RTN","ECBEN2U",67,0)
PCE ;set data for PCE filing
"RTN","ECBEN2U",68,0)
 Q:$P(ECPCE,"~",2)="N"  I $P(ECPCE,"~",2)="O"&(ECINP'="O") Q
"RTN","ECBEN2U",69,0)
 S ECREAS=""
"RTN","ECBEN2U",70,0)
 ;
"RTN","ECBEN2U",71,0)
 ;- Kill Reason node
"RTN","ECBEN2U",72,0)
 D KILLR
"RTN","ECBEN2U",73,0)
 I EC4 D CLIN^ECPCEU
"RTN","ECBEN2U",74,0)
 I 'EC4 S ECREAS="Clinic missing;"
"RTN","ECBEN2U",75,0)
 I 'ECDX S ECREAS="Diagnosis not entered;"
"RTN","ECBEN2U",76,0)
 I EC4,'ECPCL S ECREAS=ECREAS_"Clinic inactive;"
"RTN","ECBEN2U",77,0)
 I 'ECCPT S ECREAS=ECREAS_"CPT code missing;"
"RTN","ECBEN2U",78,0)
 I ECREAS]"" S ^ECH(ECFN,"R")=ECREAS K ECPCL,ECREAS Q
"RTN","ECBEN2U",79,0)
 I '$D(^ECH(ECFN,0)) Q
"RTN","ECBEN2U",80,0)
 I '$D(^ECH(ECFN,"P")) Q
"RTN","ECBEN2U",81,0)
 S PN=^ECH(ECFN,0),PNP=^ECH(ECFN,"P")
"RTN","ECBEN2U",82,0)
 S PNMOD="" I $D(^ECH(ECFN,"MOD")) D
"RTN","ECBEN2U",83,0)
 . N MOD,MODS S MODS=0 F  S MODS=$O(^ECH(ECFN,"MOD",MODS)) Q:'MODS  D
"RTN","ECBEN2U",84,0)
 . . S MOD=$P($G(^ECH(ECFN,"MOD",MODS,0)),U)
"RTN","ECBEN2U",85,0)
 . . S MOD=$$MOD^ICPTMOD(MOD,"I",$P(PN,U,3)) I +MOD<0 Q
"RTN","ECBEN2U",86,0)
 . . S PNMOD=$S(PNMOD'="":PNMOD_";",1:"")_$P(MOD,U,2)
"RTN","ECBEN2U",87,0)
SET ;set data pieces
"RTN","ECBEN2U",88,0)
 S ECP3=+$P(PN,"^",3) I ECP3'["." K ECP3 D DELNOD Q
"RTN","ECBEN2U",89,0)
 S ECP2=+$P(PN,"^",2) I 'ECP2 K ECP2 D DELNOD Q
"RTN","ECBEN2U",90,0)
 S ECP19=+$P(PN,"^",19) I 'ECP19 K ECP19 D DELNOD Q
"RTN","ECBEN2U",91,0)
 S ECP4=+$P(PN,"^",4) I 'ECP4 K ECP4 D DELNOD Q
"RTN","ECBEN2U",92,0)
 S ECP20=+$P(PN,"^",20) I 'ECP20 K ECP20 D DELNOD Q
"RTN","ECBEN2U",93,0)
 S ECP10=+$P(PN,"^",10) I 'ECP10 K ECP10 D DELNOD Q
"RTN","ECBEN2U",94,0)
 S ECPP1=+$P(PNP,"^") I 'ECPP1 K ECPP1 D DELNOD Q
"RTN","ECBEN2U",95,0)
 S ECPP2=+$P(PNP,"^",2) I 'ECPP2 K ECPP2 D DELNOD Q
"RTN","ECBEN2U",96,0)
 S ECPP3=$P(PNP,"^",3),ECPP3=$S(ECPP3="Y":1,ECPP3="N":0,1:"")
"RTN","ECBEN2U",97,0)
 S ECPP4=$P(PNP,"^",4),ECPP4=$S(ECPP4="Y":1,ECPP4="N":0,1:"")
"RTN","ECBEN2U",98,0)
 S ECPP5=$P(PNP,"^",5),ECPP5=$S(ECPP5="Y":1,ECPP5="N":0,1:"")
"RTN","ECBEN2U",99,0)
 S ECPP6=$P(PNP,"^",6),ECPP6=$S(ECPP6="Y":1,ECPP6="N":0,1:"")
"RTN","ECBEN2U",100,0)
 S ECPP9=$P(PNP,"^",9),ECPP9=$S(ECPP9="Y":1,ECPP9="N":0,1:"")
"RTN","ECBEN2U",101,0)
 S ECPP10=$P(PNP,"^",10),ECPP10=$S(ECPP10="Y":1,ECPP10="N":0,1:"")
"RTN","ECBEN2U",102,0)
 S ECPP11=$P(PNP,"^",11),ECPP11=$S(ECPP11="Y":1,ECPP11="N":0,1:"")
"RTN","ECBEN2U",103,0)
 S ECPP1A="" I $P(PN,"^",9)["EC" S ECPP1A=$G(^EC(725,+$P(PN,"^",9),0)),ECPP1A=$P(ECPP1A,"^",2)_"  "_$P(ECPP1A,"^")
"RTN","ECBEN2U",104,0)
 S ECELIG=$S($G(ECELIG):ECELIG,1:"")
"RTN","ECBEN2U",105,0)
NODE ;sets "PCE" node
"RTN","ECBEN2U",106,0)
 ;d/t~dfn~hosp loc~inst~dss id~*prov(not filled)~*prov2~*prov3~vol~cpt~dx~ao~rad~env~sc~ecs nat # & name~eligibility~mst~hnc~cv
"RTN","ECBEN2U",107,0)
 S PNODE=ECP3_"~"_ECP2_"~"_ECP19_"~"_ECP4_"~"_ECP20_"~~~~"_ECP10_"~"_ECPP1_"~"_ECPP2_"~"_ECPP3_"~"_ECPP4_"~"_ECPP5_"~"_ECPP6_"~"_ECPP1A_"~"_ECELIG_"~"_ECPP9_"~"_ECPP10_"~"_ECPP11
"RTN","ECBEN2U",108,0)
 S ^ECH(ECFN,"PCE")=PNODE
"RTN","ECBEN2U",109,0)
 ;set "PCE1" node
"RTN","ECBEN2U",110,0)
 ;CPT modifier1;CPT modifier 2;CPT modifier 3;...CPT modifier n
"RTN","ECBEN2U",111,0)
 I PNMOD'="" S ^ECH(ECFN,"PCE1")=PNMOD
"RTN","ECBEN2U",112,0)
 ;Replace set of SEND TO PCE w/direct task call - patch 95
"RTN","ECBEN2U",113,0)
 ;S DA=ECFN,DIE=721,DR="31////"_ECDT D ^DIE K DA,DIE,DR
"RTN","ECBEN2U",114,0)
 S EC2PCE(ECDT,ECFN)=""
"RTN","ECBEN2U",115,0)
 D PCETASK^ECPCEU(.EC2PCE) K EC2PCE  ;send to PCE task
"RTN","ECBEN2U",116,0)
 K ECP2,ECP3,ECP4,ECP10,ECP19,ECP20,ECPP1,ECPP1A,ECPP2,ECPP3,ECPP4,ECPP5,ECPP6,ECPP9,ECPP10,ECPP11,ECREAS,ECPCL,PN,PNP,PNODE,ECELIG,PNMOD
"RTN","ECBEN2U",117,0)
 Q
"RTN","ECBEN2U",118,0)
CLIN ;check for active associated clinic
"RTN","ECBEN2U",119,0)
 S MSG1=1,MSG2=0
"RTN","ECBEN2U",120,0)
 D CLIN^ECPCEU
"RTN","ECBEN2U",121,0)
 I 'ECPCL D
"RTN","ECBEN2U",122,0)
 .W !!,"The clinic ",$S(MSG1:"associated with",1:"you selected for")," this procedure ",$S(MSG2:"has not been entered",1:"is inactive"),"."
"RTN","ECBEN2U",123,0)
 .W !,"Workload data cannot be sent to PCE for this procedure with ",!,$S(MSG2:"a missing",1:"an inactive")," clinic."
"RTN","ECBEN2U",124,0)
 S (MSG1,MSG2)=0
"RTN","ECBEN2U",125,0)
 Q
"RTN","ECBEN2U",126,0)
 ;
"RTN","ECBEN2U",127,0)
 ;
"RTN","ECBEN2U",128,0)
KILLR ;- Kill 'R' (Reason) node
"RTN","ECBEN2U",129,0)
 ;
"RTN","ECBEN2U",130,0)
 K ^ECH(ECFN,"R")
"RTN","ECBEN2U",131,0)
 Q
"RTN","ECBEN2U",132,0)
 ;
"RTN","ECBEN2U",133,0)
 ;
"RTN","ECBEN2U",134,0)
DELNOD ;- Delete 'PCE' and 'Send' nodes
"RTN","ECBEN2U",135,0)
 ;
"RTN","ECBEN2U",136,0)
 N DA,DIE,DR
"RTN","ECBEN2U",137,0)
 ;
"RTN","ECBEN2U",138,0)
 ;- Lock node
"RTN","ECBEN2U",139,0)
 L +^ECH(ECFN):5 Q:'$T
"RTN","ECBEN2U",140,0)
 S DA=ECFN
"RTN","ECBEN2U",141,0)
 S DIE="^ECH("
"RTN","ECBEN2U",142,0)
 S DR="30////@;31////@;37////@"
"RTN","ECBEN2U",143,0)
 ;
"RTN","ECBEN2U",144,0)
 ;- Delete contents
"RTN","ECBEN2U",145,0)
 D ^DIE
"RTN","ECBEN2U",146,0)
 ;
"RTN","ECBEN2U",147,0)
 ;- Unlock node
"RTN","ECBEN2U",148,0)
 L -^ECH(ECFN)
"RTN","ECBEN2U",149,0)
 Q
"RTN","ECDSS1")
0^29^B15692712
"RTN","ECDSS1",1,0)
ECDSS1 ;BIR/RHK,JPW-Active/Inactive Procedure Report ; 03 JUL 2008
"RTN","ECDSS1",2,0)
 ;;2.0; EVENT CAPTURE ;**4,25,95**;8 May 96;Build 26
"RTN","ECDSS1",3,0)
 ; Routine to report active and inactive procedures
"RTN","ECDSS1",4,0)
START ; Routine execution
"RTN","ECDSS1",5,0)
 N ECRAS S ECRAS=1  ;roll and scroll
"RTN","ECDSS1",6,0)
 S DIR(0)="SO^A:Active Procedures;I:Inactive Procedures"
"RTN","ECDSS1",7,0)
 S DIR("A")="Select Report"
"RTN","ECDSS1",8,0)
 S DIR("?")="Enter an A for active procedures, I for inactive procedures, or ^ to quit."
"RTN","ECDSS1",9,0)
 S DIR("??")="ECDSS1^"
"RTN","ECDSS1",10,0)
 D ^DIR K DIR I $D(DIRUT) G END
"RTN","ECDSS1",11,0)
 S ECRTN=Y
"RTN","ECDSS1",12,0)
INACT ;list inact procs
"RTN","ECDSS1",13,0)
 I ECRTN="I" D LISTI G END
"RTN","ECDSS1",14,0)
ASK ;
"RTN","ECDSS1",15,0)
 S DIR(0)="SO^N:National;L:Local;B:Both",DIR("A")="Select Preferred Report"
"RTN","ECDSS1",16,0)
 S DIR("?,1")="Enter an N for National Procedures only, L for Local Procedures only,"
"RTN","ECDSS1",17,0)
 S DIR("?")="B for a combined report, or ^ to quit."
"RTN","ECDSS1",18,0)
 S DIR("??")="ECDSAC^" D ^DIR K DIR I $D(DIRUT) G END
"RTN","ECDSS1",19,0)
 S ECRN=Y
"RTN","ECDSS1",20,0)
SORT ;ask sort
"RTN","ECDSS1",21,0)
 S DIR(0)="SO^P:Procedure Name;N:National Number",DIR("A")="Select Sort Method"
"RTN","ECDSS1",22,0)
 S DIR("?")="Enter N to sort by National Number, P by Procedure Name, or ^ to quit."
"RTN","ECDSS1",23,0)
 S DIR("??")="ECDSAC1^" D ^DIR K DIR I $D(DIRUT) G END
"RTN","ECDSS1",24,0)
 S ECRD=Y
"RTN","ECDSS1",25,0)
PRT ;start prints
"RTN","ECDSS1",26,0)
 I ECRN="N",ECRD="N" D LISTNN G END
"RTN","ECDSS1",27,0)
 I ECRN="N",ECRD="P" D LISTNP G END
"RTN","ECDSS1",28,0)
 I ECRN="L",ECRD="N" D LISTPN G END
"RTN","ECDSS1",29,0)
 I ECRN="L",ECRD="P" D LISTPP G END
"RTN","ECDSS1",30,0)
 I ECRN="B",ECRD="N" D LISTBN G END
"RTN","ECDSS1",31,0)
 I ECRN="B",ECRD="P" D LISTBP
"RTN","ECDSS1",32,0)
END ;kills var and quit
"RTN","ECDSS1",33,0)
 W @IOF D ^ECKILL
"RTN","ECDSS1",34,0)
 Q
"RTN","ECDSS1",35,0)
LISTI ;all inact proc
"RTN","ECDSS1",36,0)
 W ! K DIC S DIC="^EC(725,",FLDS=".01,1,4,2",BY=".01",(FR,TO)="",L=0,DHD="NATIONAL/LOCAL PROCEDURE REPORT - INACTIVE",DIS(0)="I +$P(^EC(725,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS1",37,0)
 D MSG
"RTN","ECDSS1",38,0)
 Q
"RTN","ECDSS1",39,0)
LISTNN ;nat only by nat num
"RTN","ECDSS1",40,0)
 W ! K DIC S DIC="^EC(725,",FLDS="1,4,.01",BY="1",(FR,TO)="",L=0,DHD="NATIONAL/LOCAL PROCEDURE REPORT - ACTIVE NATIONAL BY NATIONAL NUMBER",DIS(0)="I D0<90000,'$P(^EC(725,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS1",41,0)
 D MSG
"RTN","ECDSS1",42,0)
 Q
"RTN","ECDSS1",43,0)
LISTNP ;nat only by proc
"RTN","ECDSS1",44,0)
 W ! K DIC S DIC="^EC(725,",FLDS=".01,1,4",BY=".01",(FR,TO)="",L=0,DHD="NATIONAL/LOCAL PROCEDURE REPORT - ACTIVE NATIONAL BY PROCEDURE",DIS(0)="I D0<90000,'$P(^EC(725,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS1",45,0)
 D MSG
"RTN","ECDSS1",46,0)
 Q
"RTN","ECDSS1",47,0)
LISTPN ;loc by nat num
"RTN","ECDSS1",48,0)
 W ! K DIC S DIC="^EC(725,",FLDS="1,4,.01",BY="1",(FR,TO)="",L=0,DHD="NATIONAL/LOCAL PROCEDURE REPORT - ACTIVE LOCAL BY NATIONAL NUMBER",DIS(0)="I D0>89999,'$P(^EC(725,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS1",49,0)
 D MSG
"RTN","ECDSS1",50,0)
 Q
"RTN","ECDSS1",51,0)
LISTPP ;loc by proc
"RTN","ECDSS1",52,0)
 W ! K DIC S DIC="^EC(725,",FLDS=".01,1,4",BY=".01",(FR,TO)="",L=0,DHD="NATIONAL/LOCAL PROCEDURE REPORT - ACTIVE LOCAL BY PROCEDURE",DIS(0)="I D0>89999,'$P(^EC(725,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS1",53,0)
 D MSG
"RTN","ECDSS1",54,0)
 Q
"RTN","ECDSS1",55,0)
LISTBN ;both by nat num
"RTN","ECDSS1",56,0)
 W ! K DIC S DIC="^EC(725,",FLDS="1,4,.01",BY="1",(FR,TO)="",L=0,DHD="NATIONAL/LOCAL PROCEDURE REPORT - ACTIVE NATIONAL AND LOCAL BY NATIONAL NUMBER",DIS(0)="I '$P(^EC(725,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS1",57,0)
 D MSG
"RTN","ECDSS1",58,0)
 Q
"RTN","ECDSS1",59,0)
LISTBP ;both by proc
"RTN","ECDSS1",60,0)
 W ! K DIC S DIC="^EC(725,",FLDS=".01,1,4",BY=".01",(FR,TO)="",L=0,DHD="NATIONAL/LOCAL PROCEDURE REPORT - ACTIVE NATIONAL AND LOCAL BY PROCEDURE",DIS(0)="I '$P(^EC(725,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS1",61,0)
 D MSG
"RTN","ECDSS1",62,0)
 Q
"RTN","ECDSS1",63,0)
MSG I $D(ECRAS) W !!,"Press <RET> to continue  " R X:DTIME
"RTN","ECDSS1",64,0)
 Q
"RTN","ECDSS3")
0^30^B4631829
"RTN","ECDSS3",1,0)
ECDSS3 ;BIR/RHK,JPW-Active/Inactive Category Report ; 03 JUL 2008
"RTN","ECDSS3",2,0)
 ;;2.0; EVENT CAPTURE ;**25,95**;8 May 96;Build 26
"RTN","ECDSS3",3,0)
 ; Routine to report active and inactive procedures
"RTN","ECDSS3",4,0)
START ; Routine execution
"RTN","ECDSS3",5,0)
 N ECRAS S ECRAS=1  ;roll and scroll flag
"RTN","ECDSS3",6,0)
 S DIR(0)="SO^A:Active Categories;I:Inactive Categories;B:Both"
"RTN","ECDSS3",7,0)
 S DIR("A")="Select Report"
"RTN","ECDSS3",8,0)
 S DIR("?",1)="Enter an A for Active Categories, I for Inactive Categories,"
"RTN","ECDSS3",9,0)
 S DIR("?")="B for a consolidated report of all categories, or ^ to quit."
"RTN","ECDSS3",10,0)
 S DIR("??")="ECDSS3^"
"RTN","ECDSS3",11,0)
 D ^DIR K DIR I $D(DIRUT) G END
"RTN","ECDSS3",12,0)
 S ECRTN=Y
"RTN","ECDSS3",13,0)
ACT ;list active cats (LISTA)
"RTN","ECDSS3",14,0)
INACT ;list inactive cats (LISTI)
"RTN","ECDSS3",15,0)
ALL ;list all cats (LISTB)
"RTN","ECDSS3",16,0)
 W ! D PRINT W @IOF
"RTN","ECDSS3",17,0)
 Q
"RTN","ECDSS3",18,0)
PRINT ;starts print for RPC
"RTN","ECDSS3",19,0)
 I ECRTN="A" D LISTA
"RTN","ECDSS3",20,0)
 I ECRTN="I" D LISTI
"RTN","ECDSS3",21,0)
 I ECRTN="B" D LISTB
"RTN","ECDSS3",22,0)
END ; Kill variables and exit
"RTN","ECDSS3",23,0)
 D ^ECKILL
"RTN","ECDSS3",24,0)
 Q
"RTN","ECDSS3",25,0)
LISTA ;list active categories
"RTN","ECDSS3",26,0)
 K DIC S DIC="^EC(726,",FLDS=".01",BY=".01",(FR,TO)="",L=0,DHD="CATEGORY REPORT - ACTIVE",DIS(0)="I '$P(^EC(726,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS3",27,0)
 I $D(ECRAS) W !!,"Press <RET> to continue   " R X:DTIME
"RTN","ECDSS3",28,0)
 Q
"RTN","ECDSS3",29,0)
LISTI ;list inactive categories
"RTN","ECDSS3",30,0)
 K DIC S DIC="^EC(726,",FLDS=".01,2;""INACTIVE DATE""",BY=".01",(FR,TO)="",L=0,DHD="CATEGORY REPORT - INACTIVE",DIS(0)="I +$P(^EC(726,D0,0),""^"",3)" D EN1^DIP
"RTN","ECDSS3",31,0)
 I $D(ECRAS) W !!,"Press <RET> to continue   " R X:DTIME
"RTN","ECDSS3",32,0)
 Q
"RTN","ECDSS3",33,0)
LISTB ;list all cats
"RTN","ECDSS3",34,0)
 K DIC S DIC="^EC(726,",FLDS=".01,2;""INACTIVE DATE""",BY=".01",(FR,TO)="",L=0,DHD="CATEGORY REPORT - BOTH ACTIVE AND INACTIVE" D EN1^DIP
"RTN","ECDSS3",35,0)
 I $D(ECRAS) W !!,"Press <RET> to continue   " R X:DTIME
"RTN","ECDSS3",36,0)
 Q
"RTN","ECEFPAT")
0^2^B57770429
"RTN","ECEFPAT",1,0)
ECEFPAT ;ALB/JAM - Enter Event Capture Data Patient Filer ;14 JUL 2008
"RTN","ECEFPAT",2,0)
 ;;2.0; EVENT CAPTURE ;**25,32,39,42,47,49,54,65,72,95**;8 May 96;Build 26
"RTN","ECEFPAT",3,0)
 ;
"RTN","ECEFPAT",4,0)
FILE ;Used by the RPC broker to file patient encounter in file #721
"RTN","ECEFPAT",5,0)
 ;  Uses Supported IA 1995 - allow access to $$CPT^ICPTCOD
"RTN","ECEFPAT",6,0)
 ;
"RTN","ECEFPAT",7,0)
 ;     Variables passed in
"RTN","ECEFPAT",8,0)
 ;       ECIEN   - IEN of #721, if editing
"RTN","ECEFPAT",9,0)
 ;       ECDEL   - Delete record. 1- YES; 0- 0, null or undefine for NO.
"RTN","ECEFPAT",10,0)
 ;       ECDFN   - Patient IEN for file #2
"RTN","ECEFPAT",11,0)
 ;       ECDT    - Date and time of procedure
"RTN","ECEFPAT",12,0)
 ;       ECL     - Location
"RTN","ECEFPAT",13,0)
 ;       ECD     - DSS Unit
"RTN","ECEFPAT",14,0)
 ;       ECC     - Category
"RTN","ECEFPAT",15,0)
 ;       ECP     - Procedure
"RTN","ECEFPAT",16,0)
 ;       ECVOL   - Volume
"RTN","ECEFPAT",17,0)
 ;       ECU1..n - Provider (1 thru n), Prov 1 is required,other optional
"RTN","ECEFPAT",18,0)
 ;       ECMN    - Ordering Section
"RTN","ECEFPAT",19,0)
 ;       ECDUZ   - Entered/Edited by, pointer to #200
"RTN","ECEFPAT",20,0)
 ;       ECDX    - Primary Diagnosis
"RTN","ECEFPAT",21,0)
 ;       ECDXS   - Secondary Diagnosis; multiple, optional
"RTN","ECEFPAT",22,0)
 ;       EC4     - Associated Clinic, required if sending data to PCE
"RTN","ECEFPAT",23,0)
 ;       ECPTSTAT- Patient Status
"RTN","ECEFPAT",24,0)
 ;       ECPXREAS- Procedure reason, optional
"RTN","ECEFPAT",25,0)
 ;       ECMOD   - CPT modifiers, optional
"RTN","ECEFPAT",26,0)
 ;       ECLASS  - Classification, optional
"RTN","ECEFPAT",27,0)
 ;       ECELIG  - Eligibility, optional
"RTN","ECEFPAT",28,0)
 ;
"RTN","ECEFPAT",29,0)
 ;     Variable return
"RTN","ECEFPAT",30,0)
 ;       ^TMP($J,"ECMSG",n)=Success or failure to file in #721^Message
"RTN","ECEFPAT",31,0)
 ;
"RTN","ECEFPAT",32,0)
 N NODE,ECS,ECM,ECID,ECCPT,ECINT,ECPCE,ECX,ECERR,ECOUT,ECFLG,ECRES
"RTN","ECEFPAT",33,0)
 N ECFIL,ECPRV
"RTN","ECEFPAT",34,0)
 S ECFLG=1,ECERR=0 D CHKDT(1) I ECERR Q
"RTN","ECEFPAT",35,0)
 F ECX=1:1 Q:'$D(@("ECU"_ECX))  D  I ECERR Q
"RTN","ECEFPAT",36,0)
 .I @("ECU"_ECX)="" Q
"RTN","ECEFPAT",37,0)
 .S NODE=$$GET^XUA4A72(@("ECU"_ECX),ECDT) I +NODE'>0 S ECERR=1 D  Q
"RTN","ECEFPAT",38,0)
 ..S ^TMP($J,"ECMSG",1)="0^Provider doesn't have an active Person class"
"RTN","ECEFPAT",39,0)
 .S ECPRV(ECX)=@("ECU"_ECX)_"^^"_$S(ECX=1:"P",1:"S")
"RTN","ECEFPAT",40,0)
 I $G(ECIEN)'="" S ECFLG=0 D  I ECERR Q
"RTN","ECEFPAT",41,0)
 . I '$D(^ECH(ECIEN)) S ECERR=1,^TMP($J,"ECMSG",1)="0^Pat IEN Not Found"
"RTN","ECEFPAT",42,0)
 I $G(ECDEL) K ^TMP($J,"ECMSG") D  Q
"RTN","ECEFPAT",43,0)
 .S ECVST=$P($G(^ECH(ECIEN,0)),"^",21) I ECVST D
"RTN","ECEFPAT",44,0)
 ..;* Resend all EC records with same Visit file entry to PCE
"RTN","ECEFPAT",45,0)
 ..;* Remove Visit entry from ^ECH( so DELVFILE will complete cleanup
"RTN","ECEFPAT",46,0)
 ..K EC2PCE S ECVAR1=$$FNDVST^ECUTL(ECVST,,.EC2PCE) K ECVAR1
"RTN","ECEFPAT",47,0)
 ..;Set VALQUIET to stop Amb Care validator from broadcasting to screen
"RTN","ECEFPAT",48,0)
 ..N ECPKG,ECSOU
"RTN","ECEFPAT",49,0)
 ..S ECPKG=$O(^DIC(9.4,"B","EVENT CAPTURE",0)),ECSOU="EVENT CAPTURE DATA"
"RTN","ECEFPAT",50,0)
 ..S VALQUIET=1,ECVV=$$DELVFILE^PXAPI("ALL",ECVST,ECPKG,ECSOU) K ECVST,VALQUIET
"RTN","ECEFPAT",51,0)
 ..;- Send to PCE task
"RTN","ECEFPAT",52,0)
 ..D PCETASK^ECPCEU(.EC2PCE) K EC2PCE
"RTN","ECEFPAT",53,0)
 .S DA=ECIEN,DIK="^ECH(" D ^DIK K DA,DIK,ECVV
"RTN","ECEFPAT",54,0)
 .S ^TMP($J,"ECMSG",1)="1^Procedure Deleted"
"RTN","ECEFPAT",55,0)
 I '$D(ECPRV) S ^TMP($J,"ECMSG",1)="0^No provider present" Q
"RTN","ECEFPAT",56,0)
 S ECDT=+ECDT,NODE=$G(^ECD(ECD,0)) I NODE="" D MSG Q
"RTN","ECEFPAT",57,0)
 S ECFN=$G(ECIEN),ECVOL=$G(ECVOL,1),ECS=$P(NODE,U,2),ECM=$P(NODE,U,3)
"RTN","ECEFPAT",58,0)
 S ECPCE="U~"_$S($P(NODE,"^",14)]"":$P(NODE,"^",14),1:"N")
"RTN","ECEFPAT",59,0)
 ;S ECPTSTAT=$$INOUTPT^ECUTL0(ECDFN,+ECDT) ;pat stat may not need
"RTN","ECEFPAT",60,0)
 I $G(EC4)="" D GETCLN^ECEDF
"RTN","ECEFPAT",61,0)
 S ECID=$S(+EC4:$P($G(^SC(+EC4,0)),"^",7),1:""),ECINP=ECPTSTAT
"RTN","ECEFPAT",62,0)
 I $S($P(ECPCE,"~",2)="N":0,$P(ECPCE,"~",2)="O"&(ECINP'="O"):0,1:1) D
"RTN","ECEFPAT",63,0)
 .D CHKDT(2)
"RTN","ECEFPAT",64,0)
 I +EC4 S ECRES=$$CLNCK^SDUTL2(+EC4,0) I 'ECRES D  S ECERR=1
"RTN","ECEFPAT",65,0)
 .S ^TMP($J,"ECMSG",1)=ECRES_" Clinic MUST be corrected before filing."
"RTN","ECEFPAT",66,0)
 Q:ECERR  I ECFLG D NEWIEN
"RTN","ECEFPAT",67,0)
 S ECCPT=$S(ECP["ICPT":+ECP,1:$P($G(^EC(725,+ECP,0)),U,5))
"RTN","ECEFPAT",68,0)
 ;validate CPT value and handle HCPCS name to IEN conversion (HD223010)
"RTN","ECEFPAT",69,0)
 S ECCPT=+$$CPT^ICPTCOD(ECCPT)
"RTN","ECEFPAT",70,0)
 S ECCPT=$S(+ECCPT>0:ECCPT,1:0)
"RTN","ECEFPAT",71,0)
 K DA,DR,DIE S DIE="^ECH(",(DA,ECFN)=ECIEN K ECIEN
"RTN","ECEFPAT",72,0)
 S DR=".01////"_ECFN_";1////"_ECDFN_";3////"_ECL_";4////"_ECS
"RTN","ECEFPAT",73,0)
 S DR=DR_";5////"_ECM_";6////"_ECD_";7////"_+ECC_";9////"_ECVOL
"RTN","ECEFPAT",74,0)
 S $P(^ECH(ECFN,0),"^",9)=ECP
"RTN","ECEFPAT",75,0)
 D ^DIE I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",76,0)
 S DA=ECFN,DR="11////"_ECMN_";13////"_ECDUZ_";2////"_ECDT
"RTN","ECEFPAT",77,0)
 S ECPXREAS=$G(ECPXREAS)
"RTN","ECEFPAT",78,0)
 S DR=DR_";19////"_$S(+ECCPT:ECCPT,1:"@")_";20////"_ECDX
"RTN","ECEFPAT",79,0)
 S DR=DR_";26////"_$G(EC4)_";27////"_$G(ECID)_";29////"_ECPTSTAT
"RTN","ECEFPAT",80,0)
 S DR=DR_";34////"_$S(ECPXREAS="":"@",1:ECPXREAS)
"RTN","ECEFPAT",81,0)
 D ^DIE I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",82,0)
 I ECDX S ^DISV(DUZ,"^ICD9(")=ECDX  ;last ICD9 code
"RTN","ECEFPAT",83,0)
 S ECX=$O(ECPRV("A"),-1) I ECX'="" S ^DISV(DUZ,"^VA(200,")=+ECPRV(ECX)
"RTN","ECEFPAT",84,0)
 ;Remove Old CPT modifiers
"RTN","ECEFPAT",85,0)
 I 'ECFLG D
"RTN","ECEFPAT",86,0)
 . K OLDMOD S (ECDA,DA(1))=ECFN,DIK="^ECH("_DA(1)_",""MOD"",",DA=0
"RTN","ECEFPAT",87,0)
 . F  S DA=$O(^ECH(ECDA,"MOD",DA)) Q:'DA  S OLDMOD(DA)="" D ^DIK
"RTN","ECEFPAT",88,0)
 . K DA,ECDA,DIK,^ECH(ECFN,"MOD")
"RTN","ECEFPAT",89,0)
 .;Remove old secondary diagnosis codes
"RTN","ECEFPAT",90,0)
 . K OLDDXS S (ECDA,DA(1))=ECFN,DIK="^ECH("_DA(1)_",""DX"",",DA=0
"RTN","ECEFPAT",91,0)
 . F  S DA=$O(^ECH(ECDA,"DX",DA)) Q:'DA  S OLDDXS(DA)="" D ^DIK
"RTN","ECEFPAT",92,0)
 . K DA,ECDA,DIK,^ECH(ECFN,"DX")
"RTN","ECEFPAT",93,0)
 I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",94,0)
 ;File multiple providers
"RTN","ECEFPAT",95,0)
 S ECFIL=$$FILPRV^ECPRVMUT(ECFN,.ECPRV,.ECOUT) K ECOUT
"RTN","ECEFPAT",96,0)
 I 'ECFIL D RECDEL,MSG Q
"RTN","ECEFPAT",97,0)
 ;File CPT modifiers
"RTN","ECEFPAT",98,0)
 I $G(ECMOD)'="" D
"RTN","ECEFPAT",99,0)
 . S DIC(0)="L",DA(1)=ECFN,DIC("P")=$P(^DD(721,36,0),U,2)
"RTN","ECEFPAT",100,0)
 . S DIC="^ECH("_DA(1)_","_"""MOD"""_","
"RTN","ECEFPAT",101,0)
 . F ECX=1:1:$L(ECMOD,"^") S MODIEN=$P(ECMOD,U,ECX) I +MODIEN>0 D
"RTN","ECEFPAT",102,0)
 . . K DD,DO S X=MODIEN D FILE^DICN
"RTN","ECEFPAT",103,0)
 . K MODIEN,DIC
"RTN","ECEFPAT",104,0)
 I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",105,0)
 ; File multiple secondary diagnosis codes
"RTN","ECEFPAT",106,0)
 I $G(ECDXS)'="" D
"RTN","ECEFPAT",107,0)
 . S DXS="",DIC(0)="L",DA(1)=ECFN,DIC("P")=$P(^DD(721,38,0),U,2)
"RTN","ECEFPAT",108,0)
 . S DIC="^ECH("_DA(1)_","_"""DX"""_",",ECDXY=ECDX K ECDXX
"RTN","ECEFPAT",109,0)
 . F ECX=1:1:$L(ECDXS,"^") S DXSIEN=$P(ECDXS,U,ECX) I +DXSIEN>0 D
"RTN","ECEFPAT",110,0)
 . . S DXCDE=$$ICDDX^ICDCODE(DXSIEN,ECDT) Q:+DXCDE<0  I '$P(DXCDE,U,10) Q
"RTN","ECEFPAT",111,0)
 . . K DD,DO S X=DXSIEN D FILE^DICN
"RTN","ECEFPAT",112,0)
 . . S DXCDE=$P(DXCDE,U,2),ECDXX(DXCDE)=DXSIEN
"RTN","ECEFPAT",113,0)
 . . S ^DISV(DUZ,"^ICD9(")=DXSIEN  ;last ICD9 code
"RTN","ECEFPAT",114,0)
 . ; Update all procedures for an encounter with same primary & second dx
"RTN","ECEFPAT",115,0)
 . S PXUPD=$$PXUPD^ECUTL2(ECDFN,ECDT,ECL,EC4,ECDXY,.ECDXX,ECFN)
"RTN","ECEFPAT",116,0)
 . K PXUPD,ECDXY,ECDXX,DXS,DXSIEN,DIC,DXCDE,DA,DD,DO
"RTN","ECEFPAT",117,0)
 I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",118,0)
 S DA=ECFN
"RTN","ECEFPAT",119,0)
 ;File classification AO^IR^SC^EC^MST^HNC^CV
"RTN","ECEFPAT",120,0)
 I $G(ECLASS)'="" D
"RTN","ECEFPAT",121,0)
 . S CLSTR="21^22^24^23^35^39^40",DR=""
"RTN","ECEFPAT",122,0)
 . F ECX=1:1:$L(CLSTR,"^") D
"RTN","ECEFPAT",123,0)
 . . S DR=DR_$P(CLSTR,U,ECX)_"////"_$P(ECLASS,U,ECX)_";"
"RTN","ECEFPAT",124,0)
 . S DR=$E(DR,1,($L(DR)-1)) D ^DIE
"RTN","ECEFPAT",125,0)
 . K CLSTR,DR,DIE
"RTN","ECEFPAT",126,0)
 I $D(DTOUT) D RECDEL,MSG Q
"RTN","ECEFPAT",127,0)
 ;
"RTN","ECEFPAT",128,0)
PCE ; format PCE data to send
"RTN","ECEFPAT",129,0)
 I ($P(ECPCE,"~",2)="N")!($P(ECPCE,"~",2)="O"&(ECINP'="O")) D  Q
"RTN","ECEFPAT",130,0)
 .S ^TMP($J,"ECMSG",1)="1^Record Filed"
"RTN","ECEFPAT",131,0)
 D:ECFLG PCE^ECBEN2U I 'ECFLG S EC(0)=^ECH(ECFN,0) D PCEE^ECBEN2U K EC
"RTN","ECEFPAT",132,0)
 I $G(ECOUT)!(ECERR) D  Q
"RTN","ECEFPAT",133,0)
 . D RECDEL S STR=$S($G(^ECH(ECFN,"R")):^("R"),1:" PCE Data Missing")
"RTN","ECEFPAT",134,0)
 . S ^TMP($J,"ECMSG",1)="0^Record Not Filed, "_STR K STR
"RTN","ECEFPAT",135,0)
 S ^TMP($J,"ECMSG",1)="1^Record Filed"_U_$G(ECIEN)
"RTN","ECEFPAT",136,0)
 Q
"RTN","ECEFPAT",137,0)
 ;
"RTN","ECEFPAT",138,0)
NEWIEN ;Create new IEN in file #721
"RTN","ECEFPAT",139,0)
 N DIC,DA,DD,DO,ECRN
"RTN","ECEFPAT",140,0)
RLCK L +^ECH(0) S ECRN=$P(^ECH(0),"^",3)+1
"RTN","ECEFPAT",141,0)
 I $D(^ECH(ECRN)) S $P(^ECH(0),"^",3)=$P(^(0),"^",3)+1 L -^ECH(0) G RLCK
"RTN","ECEFPAT",142,0)
 L -^ECH(0) S DIC(0)="L",DIC="^ECH(",X=ECRN
"RTN","ECEFPAT",143,0)
 D FILE^DICN S ECIEN=+Y
"RTN","ECEFPAT",144,0)
 Q
"RTN","ECEFPAT",145,0)
RECDEL ; Delete record
"RTN","ECEFPAT",146,0)
 ;restore old data
"RTN","ECEFPAT",147,0)
 I 'ECFLG D  Q
"RTN","ECEFPAT",148,0)
 . I $O(OLDMOD("")) D
"RTN","ECEFPAT",149,0)
 . . S DIC(0)="L",DA(1)=ECFN,DIC("P")=$P(^DD(721,36,0),U,2)
"RTN","ECEFPAT",150,0)
 . . S DIC="^ECH("_DA(1)_","_"""MOD"""_",",ECX=0
"RTN","ECEFPAT",151,0)
 . . F  S ECX=$O(OLDMOD(ECX)) Q:'ECX  I ECX>0 K DD,DO S X=ECX D FILE^DICN
"RTN","ECEFPAT",152,0)
 . I $O(OLDDXS("")) D
"RTN","ECEFPAT",153,0)
 . . S DIC(0)="L",DA(1)=ECFN,DIC("P")=$P(^DD(721,38,0),U,2)
"RTN","ECEFPAT",154,0)
 . . S DIC="^ECH("_DA(1)_","_"""DX"""_",",ECX=0
"RTN","ECEFPAT",155,0)
 . . F  S ECX=$O(OLDDXS(ECX)) Q:'ECX  I ECX>0 K DD,DO S X=ECX D FILE^DICN
"RTN","ECEFPAT",156,0)
 . K DIC,DA,DD,DO,OLDMOD,OLDDXS,ECX
"RTN","ECEFPAT",157,0)
 S DA=ECFN,DIK="^ECH(" D ^DIK K DA,DIK
"RTN","ECEFPAT",158,0)
 Q
"RTN","ECEFPAT",159,0)
MSG ;Record not filed
"RTN","ECEFPAT",160,0)
 S ^TMP($J,"ECMSG",1)="0^Record not Filed"
"RTN","ECEFPAT",161,0)
 Q
"RTN","ECEFPAT",162,0)
CHKDT(FLG) ;Required Data Check
"RTN","ECEFPAT",163,0)
 N I,C
"RTN","ECEFPAT",164,0)
 S C=1
"RTN","ECEFPAT",165,0)
 I FLG=1 D  Q
"RTN","ECEFPAT",166,0)
 .F I="ECD","ECC","ECL","ECDT","ECP","ECDFN","ECMN","ECDUZ","ECPTSTAT" D
"RTN","ECEFPAT",167,0)
 ..I $G(@I)="" S ^TMP($J,"ECMSG",C)="0^Key data missing "_I,C=C+1,ECERR=1
"RTN","ECEFPAT",168,0)
 .I $G(ECDEL),$D(ECIEN) K ^TMP($J,"ECMSG") S ECERR=0
"RTN","ECEFPAT",169,0)
 ;check PCE data
"RTN","ECEFPAT",170,0)
 I FLG=2 D  Q
"RTN","ECEFPAT",171,0)
 .F I="EC4","ECDX" D  Q
"RTN","ECEFPAT",172,0)
 ..I $G(@I)="" S ^TMP($J,"ECMSG",C)="0^Key PCE data missing "_I,C=C+1,ECERR=1
"RTN","ECEFPAT",173,0)
 Q
"RTN","ECEFPAT",174,0)
VALDATA ;validate data
"RTN","ECEFPAT",175,0)
 N ECRRX
"RTN","ECEFPAT",176,0)
 D CHK^DIE(721,1,,"`"_ECDFN,.ECRRX) I ECRRX'=ECDFN D  Q
"RTN","ECEFPAT",177,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Patient"
"RTN","ECEFPAT",178,0)
 D CHK^DIE(721,2,,ECDT,.ECRRX) I ECRRX'=ECDT D  Q
"RTN","ECEFPAT",179,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Procedure Date"
"RTN","ECEFPAT",180,0)
 D CHK^DIE(721,3,,"`"_ECL,.ECRRX) I ECRRX'=ECL D  Q
"RTN","ECEFPAT",181,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Location"
"RTN","ECEFPAT",182,0)
 D CHK^DIE(721,6,,"`"_ECD,.ECRRX) I ECRRX'=ECD D  Q
"RTN","ECEFPAT",183,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid DSS Unit"
"RTN","ECEFPAT",184,0)
 D CHK^DIE(721,7,,"`"_ECC,.ECRRX) I ECRRX'=ECC D  Q
"RTN","ECEFPAT",185,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Category"
"RTN","ECEFPAT",186,0)
 D  I ECERR Q
"RTN","ECEFPAT",187,0)
 .I ECP["ICPT" S ECRRX=$$CPT^ICPTCOD(+ECP,ECDT) I +ECRRX>0,$P(ECRRX,U,7) Q
"RTN","ECEFPAT",188,0)
 .I ECP["EC",$D(^EC(725,+ECP,0)) Q
"RTN","ECEFPAT",189,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Procedure"
"RTN","ECEFPAT",190,0)
 D CHK^DIE(721,11,,"`"_ECMN,.ECRRX) I ECRRX'=ECMN D  Q
"RTN","ECEFPAT",191,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Ordering Section"
"RTN","ECEFPAT",192,0)
 D CHK^DIE(721,20,,"`"_ECDX,.ECRRX) I ECRRX'=ECDX D  Q
"RTN","ECEFPAT",193,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Primary Diagnosis"
"RTN","ECEFPAT",194,0)
 I $G(EC4)'="" D CHK^DIE(721,26,,"`"_EC4,.ECRRX) I ECRRX'=EC4 D  Q
"RTN","ECEFPAT",195,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Associated Clinic"
"RTN","ECEFPAT",196,0)
 Q
"RTN","ECMFECS")
0^3^B37201667
"RTN","ECMFECS",1,0)
ECMFECS ;ALB/JAM - Event Capture Management - Event Code Screen Filer ;1 Jul 08
"RTN","ECMFECS",2,0)
 ;;2.0; EVENT CAPTURE ;**25,33,47,55,65,95**;8 May 96;Build 26
"RTN","ECMFECS",3,0)
 ;
"RTN","ECMFECS",4,0)
 I $G(ECL0)'="" D MULTLOC Q  ;multiple location filing
"RTN","ECMFECS",5,0)
 ;
"RTN","ECMFECS",6,0)
FILE ;Used by the RPC broker to file EC Code Screens in file #720.3
"RTN","ECMFECS",7,0)
 ;     Variables passed in
"RTN","ECMFECS",8,0)
 ;       ECIEN     - IEN of #720.3, if editing
"RTN","ECMFECS",9,0)
 ;       ECL       - Location
"RTN","ECMFECS",10,0)
 ;       ECD       - DSS Unit
"RTN","ECMFECS",11,0)
 ;       ECC       - Category
"RTN","ECMFECS",12,0)
 ;       ECP       - Procedure
"RTN","ECMFECS",13,0)
 ;       ECST      - Event code screen status
"RTN","ECMFECS",14,0)
 ;       ECSYN     - Synonym
"RTN","ECMFECS",15,0)
 ;       ECVOL     - Volume
"RTN","ECMFECS",16,0)
 ;       ECAC      - Associated Clinic
"RTN","ECMFECS",17,0)
 ;       ECREAS    - Reason indicator
"RTN","ECMFECS",18,0)
 ;       ECRES0..n - array of reasons
"RTN","ECMFECS",19,0)
 ;
"RTN","ECMFECS",20,0)
 ;     Variable return
"RTN","ECMFECS",21,0)
 ;       ^TMP($J,"ECMSG",n)=Success or failure to file in #720.3^Message
"RTN","ECMFECS",22,0)
 ;
"RTN","ECMFECS",23,0)
 N ECCH,ECERR,ECX,ECY,ECFLG,ECR,ECI,X,Y,DIK,DIE
"RTN","ECMFECS",24,0)
 N ECLOC  ;protect from XREF reuse & kills
"RTN","ECMFECS",25,0)
 N ECRES  ;prevent ECREAS overwrite
"RTN","ECMFECS",26,0)
 S ECERR=0 D CHKDT I ECERR Q
"RTN","ECMFECS",27,0)
 D VALDATA I ECERR Q
"RTN","ECMFECS",28,0)
 I ECIEN'="" S ECFLG=0,ECX=$G(^ECJ(ECIEN,0)),ECY=$P(ECX,U) D  I ECERR Q
"RTN","ECMFECS",29,0)
 .I ECX="" D  Q
"RTN","ECMFECS",30,0)
 ..S ECERR=1,^TMP($J,"ECMSG",1)="0^Event Code Screen Not on File" Q
"RTN","ECMFECS",31,0)
 .S ECL=$P(ECY,"-"),ECD=$P(ECY,"-",2),ECC=$P(ECY,"-",3),ECP=$P(ECY,"-",4)
"RTN","ECMFECS",32,0)
 .I ECST="A",$P(ECX,U,2)'="" S DA=ECIEN,DIE="^ECJ(",DR="1///@" D ^DIE Q
"RTN","ECMFECS",33,0)
 .I ECST="I",$P(ECX,U,2)="" S $P(^ECJ(ECIEN,0),U,2)=DT
"RTN","ECMFECS",34,0)
 S ECC=$G(ECC,0),ECCH=ECL_"-"_ECD_"-"_ECC_"-"_ECP
"RTN","ECMFECS",35,0)
 I '$P($G(^ECD(ECD,0)),U,11),ECC D  Q
"RTN","ECMFECS",36,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^DSS Unit/Category inconsistency" Q
"RTN","ECMFECS",37,0)
 I ECIEN="" D  I ECERR Q
"RTN","ECMFECS",38,0)
 .I $D(^ECJ("B",ECCH)) D  Q
"RTN","ECMFECS",39,0)
 ..S ECERR=1,^TMP($J,"ECMSG",1)="0^EC Screen Exist" Q
"RTN","ECMFECS",40,0)
 .D NEWIEN
"RTN","ECMFECS",41,0)
 S DA=ECIEN,DIK="^ECJ(",ECRES=$S(ECREAS="Y":1,1:0) D IX^DIK
"RTN","ECMFECS",42,0)
 S ^ECJ("AP",ECL,ECD,ECC,ECP,ECIEN)="",^ECJ("APP",ECL,ECD,ECP,ECIEN)=""
"RTN","ECMFECS",43,0)
 S $P(^ECJ(ECIEN,"PRO"),U)=ECP
"RTN","ECMFECS",44,0)
 S DR="53////"_$S($G(ECSYN)'="":ECSYN,1:"@")_";54////"_$G(ECVOL,1)
"RTN","ECMFECS",45,0)
 S DR=DR_";55////"_$S($G(ECAC)'="":ECAC,1:"@")_";56////"_ECRES,DIE="^ECJ(",DA=ECIEN
"RTN","ECMFECS",46,0)
 D ^DIE K DA,DR,DIE
"RTN","ECMFECS",47,0)
 I $D(DTOUT) D RECDEL S ^TMP($J,"ECMSG",1)="0^Record not Filed" Q
"RTN","ECMFECS",48,0)
 I ECRES D
"RTN","ECMFECS",49,0)
 .K DIC,DA,DR,ECX S DIC="^ECL(",DIC(0)="L",DLAYGO=720.5,ECR=0
"RTN","ECMFECS",50,0)
 .F ECI=0:1 S ECX="ECRES"_ECI Q:'$D(@ECX)  S ECR=(@ECX) D
"RTN","ECMFECS",51,0)
 ..Q:ECR=""  I '$D(^ECR(ECR,0)) Q
"RTN","ECMFECS",52,0)
 ..I '$D(^ECL("AD",ECIEN,ECR)) S X=ECR,DIC("DR")=".02////"_ECIEN
"RTN","ECMFECS",53,0)
 ..K DD,DO,DLAYGO D FILE^DICN
"RTN","ECMFECS",54,0)
 S ^TMP($J,"ECMSG",1)="1^Record Filed"_U_ECIEN
"RTN","ECMFECS",55,0)
 Q
"RTN","ECMFECS",56,0)
 ;
"RTN","ECMFECS",57,0)
VALDATA ;validate data
"RTN","ECMFECS",58,0)
 N ECRRX,ECRES
"RTN","ECMFECS",59,0)
 S DIC="^DIC(4,",DIC(0)="NX",X=ECL D ^DIC I Y=-1 D  Q
"RTN","ECMFECS",60,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Location"
"RTN","ECMFECS",61,0)
 S DIC="^ECD(",DIC(0)="NX",X=ECD D ^DIC I Y=-1 D  Q
"RTN","ECMFECS",62,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid DSS Unit"
"RTN","ECMFECS",63,0)
 I ECC S DIC="^EC(726,",DIC(0)="NX",X=ECC D ^DIC I Y=-1 D  Q
"RTN","ECMFECS",64,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Category"
"RTN","ECMFECS",65,0)
 I ECP'="" D  I ECERR Q
"RTN","ECMFECS",66,0)
 .; ATG-1003-32110 : by VMP
"RTN","ECMFECS",67,0)
 .I ECP["ICPT" S ECRRX=$$CPT^ICPTCOD(+ECP) I +ECRRX>0 Q:$G(ECIEN)  I $P(ECRRX,U,7) Q
"RTN","ECMFECS",68,0)
 .I ECP["EC",$D(^EC(725,+ECP,0)) Q
"RTN","ECMFECS",69,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Procedure"
"RTN","ECMFECS",70,0)
 I $G(ECAC)'="" D  I ECERR Q
"RTN","ECMFECS",71,0)
 .D CHK^DIE(720.3,55,"E","`"_ECAC,.ECRRX) I ECRRX'=ECAC D  Q
"RTN","ECMFECS",72,0)
 ..S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Associated Clinic"
"RTN","ECMFECS",73,0)
 .S ECRES=$$CLNCK^SDUTL2(ECAC,0) I 'ECRES D  S ECERR=1
"RTN","ECMFECS",74,0)
 ..S ^TMP($J,"ECMSG",1)=ECRES_" Clinic MUST be corrected before filing."
"RTN","ECMFECS",75,0)
 I $G(ECSYN)'="" D CHK^DIE(720.3,53,"E",ECSYN,.ECRRX) I ECRRX'=ECSYN D  Q
"RTN","ECMFECS",76,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Synonym"
"RTN","ECMFECS",77,0)
 I "^N^Y^"'[U_ECREAS_U D  Q
"RTN","ECMFECS",78,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Invalid Reason Response"
"RTN","ECMFECS",79,0)
 Q
"RTN","ECMFECS",80,0)
RECDEL ; Delete record
"RTN","ECMFECS",81,0)
 I ECFLG S DA=ECIEN,DIK="^ECJ(" D ^DIK K DA,DIK
"RTN","ECMFECS",82,0)
 Q
"RTN","ECMFECS",83,0)
 ;
"RTN","ECMFECS",84,0)
NEWIEN ;Create new IEN in file #720.3
"RTN","ECMFECS",85,0)
 N DIC,DA,DD,DO
"RTN","ECMFECS",86,0)
 L +^ECJ(0)
"RTN","ECMFECS",87,0)
 S X=ECCH,DIC="^ECJ(",DIC(0)="L",DLAYGO=720.3 D FILE^DICN
"RTN","ECMFECS",88,0)
 L -^ECJ(0)
"RTN","ECMFECS",89,0)
 S ECIEN=+Y,$P(^ECJ(ECIEN,0),U,3)=DT,$P(^ECJ(ECIEN,"PRO"),U)=ECP
"RTN","ECMFECS",90,0)
 I ECST="I" S $P(^ECJ(ECIEN,0),U,2)=DT
"RTN","ECMFECS",91,0)
 Q
"RTN","ECMFECS",92,0)
CHKDT ;Required Data Check
"RTN","ECMFECS",93,0)
 N I,C
"RTN","ECMFECS",94,0)
 S C=1
"RTN","ECMFECS",95,0)
 F I="ECL","ECD","ECC","ECP","ECREAS" D
"RTN","ECMFECS",96,0)
 .I $G(@I)="" S ^TMP($J,"ECMSG",C)="0^Key data missing "_I,C=C+1,ECERR=1
"RTN","ECMFECS",97,0)
 Q
"RTN","ECMFECS",98,0)
REASON ;Used by the RPC broker to file EC Reasons in file #720.4
"RTN","ECMFECS",99,0)
 ;     Variables passed in
"RTN","ECMFECS",100,0)
 ;       ECIEN     - IEN of #720.4, if editing
"RTN","ECMFECS",101,0)
 ;       ECRES     - Reason
"RTN","ECMFECS",102,0)
 ;       ECST      - Reason status
"RTN","ECMFECS",103,0)
 ;
"RTN","ECMFECS",104,0)
 ;     Variable return
"RTN","ECMFECS",105,0)
 ;       ^TMP($J,"ECMSG",n)=Success or failure to file in #720.4^Message
"RTN","ECMFECS",106,0)
 ;
"RTN","ECMFECS",107,0)
 N ECOST,ECERR,ECFLG,X,Y,DIC,DIE
"RTN","ECMFECS",108,0)
 S ECERR=0 I $G(ECRES)="" D  I ECERR Q
"RTN","ECMFECS",109,0)
 .S ^TMP($J,"ECMSG",1)="0^Key data missing - Reason",ECERR=1
"RTN","ECMFECS",110,0)
 D CHK^DIE(720.4,.01,,ECRES,.ECRRX) I ECRRX="^" D  Q
"RTN","ECMFECS",111,0)
 .S ^TMP($J,"ECMSG",1)="0^Invalid Reason",ECERR=1
"RTN","ECMFECS",112,0)
 S ECST=$G(ECST,"A")
"RTN","ECMFECS",113,0)
 I "^I^A^"'[U_ECST_U S ^TMP($J,"ECMSG",1)="0^Invalid Reason Status" Q
"RTN","ECMFECS",114,0)
 S ECST=$S(ECST="I":0,1:1),ECIEN=$G(ECIEN),ECFLG=1
"RTN","ECMFECS",115,0)
 I ECIEN'="" S ECFLG=0 I $G(^ECR(ECIEN,0))="" D  I ECERR K ECST Q
"RTN","ECMFECS",116,0)
 .S ECERR=1,^TMP($J,"ECMSG",1)="0^Reason Not on File" Q
"RTN","ECMFECS",117,0)
 I ECIEN="" D  I ECERR K ECST Q
"RTN","ECMFECS",118,0)
 .I $D(^ECR("B",ECRES)) S ECERR=1,^TMP($J,"ECMSG",1)="0^Reason Exist" Q
"RTN","ECMFECS",119,0)
 .K DIE,DR,DA
"RTN","ECMFECS",120,0)
 .L +^ECR(0)
"RTN","ECMFECS",121,0)
 .S X=ECRES,DIC="^ECR(",DIC(0)="L",DLAYGO=720.4 D FILE^DICN
"RTN","ECMFECS",122,0)
 .L -^ECR(0)
"RTN","ECMFECS",123,0)
 .S ECIEN=+Y
"RTN","ECMFECS",124,0)
 S ECOST=$P($G(^ECR(ECIEN,0)),U,2)
"RTN","ECMFECS",125,0)
 I ECST'=ECOST D
"RTN","ECMFECS",126,0)
 .S DIE=DIC,DA=ECIEN,DR=".02////"_ECST D ^DIE
"RTN","ECMFECS",127,0)
 S ^TMP($J,"ECMSG",1)="1^Reason Filed"_U_ECIEN K ECST
"RTN","ECMFECS",128,0)
 Q
"RTN","ECMFECS",129,0)
 ;
"RTN","ECMFECS",130,0)
MULTLOC ;Entry point for multiple locations
"RTN","ECMFECS",131,0)
 ;  Input:
"RTN","ECMFECS",132,0)
 ;    ECL0..n - locations IEN
"RTN","ECMFECS",133,0)
 ;    ECIEN - IEN for edits; "" for new records
"RTN","ECMFECS",134,0)
 ;    See FILE tag for other variables passed in
"RTN","ECMFECS",135,0)
 ;
"RTN","ECMFECS",136,0)
 ;  Output:
"RTN","ECMFECS",137,0)
 ;    ^TMP($J,"ECMSG",n)=Success or failure
"RTN","ECMFECS",138,0)
 ;
"RTN","ECMFECS",139,0)
 N ECERR  ;error flag
"RTN","ECMFECS",140,0)
 N ECI    ;generic index
"RTN","ECMFECS",141,0)
 N ECL    ;location IEN
"RTN","ECMFECS",142,0)
 N ECLN   ;location name
"RTN","ECMFECS",143,0)
 N ECLOC  ;array of locations
"RTN","ECMFECS",144,0)
 N ECX    ;variable name (ex. ECL1)
"RTN","ECMFECS",145,0)
 ;
"RTN","ECMFECS",146,0)
 ;short circuit when IEN passed w/multiple locations
"RTN","ECMFECS",147,0)
 I (+$G(ECIEN)>0)&(ECL0="ALL"!($D(ECL1))) D  Q
"RTN","ECMFECS",148,0)
 . S ^TMP($J,"ECMSG",1)=0_U_"Multiple location edits not allowed"
"RTN","ECMFECS",149,0)
 ;
"RTN","ECMFECS",150,0)
 I ECL0="ALL" D
"RTN","ECMFECS",151,0)
 . D LOCARRY^ECRUTL  ;returns all sites in ECLOC(n)=IEN^name format
"RTN","ECMFECS",152,0)
 E  D
"RTN","ECMFECS",153,0)
 . F ECI=0:1 S ECX="ECL"_ECI Q:'$D(@ECX)  D
"RTN","ECMFECS",154,0)
 . . S ECLN=$$GET1^DIQ(4,@ECX_",",.01,"")
"RTN","ECMFECS",155,0)
 . . S ECLOC(ECI+1)=@ECX_U_ECLN
"RTN","ECMFECS",156,0)
 ;
"RTN","ECMFECS",157,0)
 S ECI=0
"RTN","ECMFECS",158,0)
 F  S ECI=$O(ECLOC(ECI)) Q:'ECI  D
"RTN","ECMFECS",159,0)
 . I ECL0="ALL"!($D(ECL1)) N ECIEN S ECIEN=""  ;reset IEN for multiple
"RTN","ECMFECS",160,0)
 . S ECL=+ECLOC(ECI)
"RTN","ECMFECS",161,0)
 . D FILE^ECMFECS
"RTN","ECMFECS",162,0)
 . I $P(^TMP($J,"ECMSG",1),U)=0 S ECERR(ECI)=ECLOC(ECI)_U_$P(^TMP($J,"ECMSG",1),U,2)
"RTN","ECMFECS",163,0)
 ;
"RTN","ECMFECS",164,0)
 ;process results
"RTN","ECMFECS",165,0)
 I '$D(ECERR) S ^TMP($J,"ECMSG",1)=1_U_"Records filed for all locations"
"RTN","ECMFECS",166,0)
 E  D PROCERR(.ECERR)
"RTN","ECMFECS",167,0)
 Q
"RTN","ECMFECS",168,0)
 ;
"RTN","ECMFECS",169,0)
PROCERR(ECERR) ;process multiple location errors
"RTN","ECMFECS",170,0)
 ;  Input:
"RTN","ECMFECS",171,0)
 ;    ECERR - array of location errors
"RTN","ECMFECS",172,0)
 ;
"RTN","ECMFECS",173,0)
 ;  Output:
"RTN","ECMFECS",174,0)
 ;    ^TMP($J,"ECMSG" - RPC results global array
"RTN","ECMFECS",175,0)
 ;    Format:  ^TMP($J,"ECMSG",1)="0^One or more locations did not file"
"RTN","ECMFECS",176,0)
 ;             ^TMP($J,"ECMSG",n)=Location_IEN^Location_name^Error_text
"RTN","ECMFECS",177,0)
 ;
"RTN","ECMFECS",178,0)
 Q:'$D(ECERR)
"RTN","ECMFECS",179,0)
 ;
"RTN","ECMFECS",180,0)
 N ECCNT,ECI
"RTN","ECMFECS",181,0)
 S ECCNT=1
"RTN","ECMFECS",182,0)
 S ^TMP($J,"ECMSG",ECCNT)=0_U_"One or more locations did not file"
"RTN","ECMFECS",183,0)
 S ECI=0
"RTN","ECMFECS",184,0)
 F  S ECI=$O(ECERR(ECI)) Q:'ECI  S ECCNT=ECCNT+1 D
"RTN","ECMFECS",185,0)
 . S ^TMP($J,"ECMSG",ECCNT)=$P(ECERR(ECI),U)_U_$P(ECERR(ECI),U,2)_U_$P(ECERR(ECI),U,3)
"RTN","ECMFECS",186,0)
 Q
"RTN","ECOSSUM")
0^4^B64825146
"RTN","ECOSSUM",1,0)
ECOSSUM ;BIR/DMA,RHK,JPW - Ordering Section Summary ;1 Jul 2008
"RTN","ECOSSUM",2,0)
 ;;2.0; EVENT CAPTURE ;**5,8,18,47,72,95**;8 May 96;Build 26
"RTN","ECOSSUM",3,0)
EN ;entry point from menu option
"RTN","ECOSSUM",4,0)
 W !
"RTN","ECOSSUM",5,0)
 K DIC S DIC=723,DIC(0)="AQEMZ",DIC("A")="Select Ordering Section: " D ^DIC K DIC
"RTN","ECOSSUM",6,0)
 I Y<0 G EXIT
"RTN","ECOSSUM",7,0)
 S ECOS=+Y,ECOSN=$P(Y,"^",2)
"RTN","ECOSSUM",8,0)
 D RANGE
"RTN","ECOSSUM",9,0)
 I '$G(ECLOOP)!'$G(ECSD)!'$G(ECED) G EXIT
"RTN","ECOSSUM",10,0)
 W !
"RTN","ECOSSUM",11,0)
 S JJ=$$ASKLOC^ECRUTL
"RTN","ECOSSUM",12,0)
 I 'JJ G EXIT
"RTN","ECOSSUM",13,0)
 W !
"RTN","ECOSSUM",14,0)
 S JJ=$$ASKDSS^ECRUTL
"RTN","ECOSSUM",15,0)
 I 'JJ G EXIT
"RTN","ECOSSUM",16,0)
 W !
"RTN","ECOSSUM",17,0)
 D DEVICE
"RTN","ECOSSUM",18,0)
 I POP G EXIT
"RTN","ECOSSUM",19,0)
 I $G(ZTSK) G EXIT
"RTN","ECOSSUM",20,0)
 I $G(IO("Q")),'$G(ZTSK) G EXIT
"RTN","ECOSSUM",21,0)
 D START
"RTN","ECOSSUM",22,0)
 D HOME^%ZIS
"RTN","ECOSSUM",23,0)
 G EXIT
"RTN","ECOSSUM",24,0)
 Q
"RTN","ECOSSUM",25,0)
 ;
"RTN","ECOSSUM",26,0)
START ;queued entry point or continuation
"RTN","ECOSSUM",27,0)
 D PROCESS
"RTN","ECOSSUM",28,0)
 U IO D PRINT
"RTN","ECOSSUM",29,0)
 I $D(ECGUI) D EXIT Q
"RTN","ECOSSUM",30,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECOSSUM",31,0)
 I $D(ZTQUEUED) S ZTREQ="@" D EXIT
"RTN","ECOSSUM",32,0)
 Q
"RTN","ECOSSUM",33,0)
 ;
"RTN","ECOSSUM",34,0)
RANGE ;get any date range
"RTN","ECOSSUM",35,0)
 N ECSTDT,ECENDDT
"RTN","ECOSSUM",36,0)
 W !!,?5,"Enter a Begin Date and End Date for the Event Capture "
"RTN","ECOSSUM",37,0)
 W !,?5,"Ordering Section report.",!
"RTN","ECOSSUM",38,0)
 S (ECSD,ECED)=0
"RTN","ECOSSUM",39,0)
 F  D  Q:ECSD>0  Q:'$G(ECLOOP)
"RTN","ECOSSUM",40,0)
 .S ECLOOP=$$STDT^ECRUTL() I 'ECLOOP Q
"RTN","ECOSSUM",41,0)
 .S ECSD=ECSTDT
"RTN","ECOSSUM",42,0)
 Q:'$G(ECLOOP)!'$G(ECSD)
"RTN","ECOSSUM",43,0)
 F  D  Q:ECED>0  Q:'$G(ECLOOP)
"RTN","ECOSSUM",44,0)
 .S ECLOOP=$$ENDDT^ECRUTL(ECSTDT) I 'ECLOOP Q
"RTN","ECOSSUM",45,0)
 .S ECED=ECENDDT
"RTN","ECOSSUM",46,0)
 .I ECED>(DT+1) D
"RTN","ECOSSUM",47,0)
 ..W !!,?15,"The End Date for this report may not be"
"RTN","ECOSSUM",48,0)
 ..W !,?15,"a future date.  Try again...",!
"RTN","ECOSSUM",49,0)
 ..S ECED=0
"RTN","ECOSSUM",50,0)
 Q 
"RTN","ECOSSUM",51,0)
 ;
"RTN","ECOSSUM",52,0)
DEVICE ;select output device
"RTN","ECOSSUM",53,0)
 W !,"This report is formatted for 132 column output.",!
"RTN","ECOSSUM",54,0)
 K IOP S %ZIS="QM" D ^%ZIS
"RTN","ECOSSUM",55,0)
 I POP W !!,"No device selected.  Exiting...",!! S DIR(0)="E" W ! D ^DIR K DIR Q
"RTN","ECOSSUM",56,0)
 I $D(IO("Q")) D
"RTN","ECOSSUM",57,0)
 .S ZTRTN="START^ECOSSUM",ZTDESC="EC Ordering Section Summary"
"RTN","ECOSSUM",58,0)
 .S ZTSAVE("ECSD")="",ZTSAVE("ECED")="",ZTSAVE("ECOS")="",ZTSAVE("ECOSN")=""
"RTN","ECOSSUM",59,0)
 .S ZTSAVE("ECLOC(")="",ZTSAVE("ECDSSU(")=""
"RTN","ECOSSUM",60,0)
 .D ^%ZTLOAD
"RTN","ECOSSUM",61,0)
 .I '$G(ZTSK) W !,"Report canceled..." S DIR(0)="E" W ! D ^DIR K DIR Q
"RTN","ECOSSUM",62,0)
 .W !,"Report queued as Task #: ",ZTSK S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECOSSUM",63,0)
 Q
"RTN","ECOSSUM",64,0)
 ;
"RTN","ECOSSUM",65,0)
PROCESS ;get data to print
"RTN","ECOSSUM",66,0)
 N EC,ECD,ECDA,ECPA,ECPATN,ECSS,ECSSN,ECP,ECPN,ECLOCA,ECUNIT,ECCAT,ECFILE,ECPSY,ECPSYN,ECPRV,ECPRVN,EC725
"RTN","ECOSSUM",67,0)
 N NLOC,NUNIT,JJ,ECPXD
"RTN","ECOSSUM",68,0)
 K ^TMP("ECOS",$J)
"RTN","ECOSSUM",69,0)
 ;put locations and units into ien subscripted arrays
"RTN","ECOSSUM",70,0)
 S JJ="" F  S JJ=$O(ECLOC(JJ)) Q:JJ=""  D
"RTN","ECOSSUM",71,0)
 .S NLOC($P(ECLOC(JJ),"^",1))=$P(ECLOC(JJ),"^",2)
"RTN","ECOSSUM",72,0)
 S JJ="" F  S JJ=$O(ECDSSU(JJ)) Q:JJ=""  D
"RTN","ECOSSUM",73,0)
 .S NUNIT($P(ECDSSU(JJ),"^",1))=$P(ECDSSU(JJ),"^",2)
"RTN","ECOSSUM",74,0)
 S ECD=ECSD
"RTN","ECOSSUM",75,0)
 F  S ECD=$O(^ECH("AC",ECD)) Q:'ECD  Q:ECD>ECED  D
"RTN","ECOSSUM",76,0)
 .S ECDA="" F  S ECDA=$O(^ECH("AC",ECD,ECDA)) Q:'ECDA  S EC=$G(^ECH(ECDA,0)) I $P(EC,"^",12)=ECOS D
"RTN","ECOSSUM",77,0)
 ..I $P(EC,"^",3)<ECSD!($P(EC,"^",3)>ECED) Q  ;file or x-ref problem
"RTN","ECOSSUM",78,0)
 ..S ECLOCA=+$P(EC,U,4),ECUNIT=+$P(EC,U,7)
"RTN","ECOSSUM",79,0)
 ..I '$D(NLOC(ECLOCA))!('$D(NUNIT(ECUNIT))) Q
"RTN","ECOSSUM",80,0)
 ..S ECP=$P(EC,U,9) Q:ECP']""
"RTN","ECOSSUM",81,0)
 ..S ECCAT=+$P(EC,U,8)
"RTN","ECOSSUM",82,0)
 ..S ECPSY=+$O(^ECJ("AP",ECLOCA,ECUNIT,ECCAT,ECP,""))
"RTN","ECOSSUM",83,0)
 ..S ECPSYN=$P($G(^ECJ(ECPSY,"PRO")),"^",2)
"RTN","ECOSSUM",84,0)
 ..S ECFILE=$P(ECP,";",2),ECFILE=$S($E(ECFILE)="I":81,$E(ECFILE)="E":725,1:"UNKNOWN")
"RTN","ECOSSUM",85,0)
 ..I ECFILE="UNKNOWN" S ECPN="UNKNOWN"
"RTN","ECOSSUM",86,0)
 ..S ECCPT=$S(ECFILE=81:+ECP,1:$P($G(^EC(725,+ECP,0)),"^",5)),ECPXD=""
"RTN","ECOSSUM",87,0)
 ..I ECCPT'="" D
"RTN","ECOSSUM",88,0)
 ...S ECPXD=$$CPT^ICPTCOD(ECCPT,$P(EC,"^",3)),ECCPT=$P(ECPXD,"^",2)
"RTN","ECOSSUM",89,0)
 ..I ECFILE=81 S ECPN=$S($P(ECPXD,"^",3)]"":$P(ECPXD,"^",3),1:"UNKNOWN")
"RTN","ECOSSUM",90,0)
 ..I ECFILE=725 D
"RTN","ECOSSUM",91,0)
 ...S EC725=$G(^EC(725,+ECP,0)),ECPN=$P(EC725,"^",2)_" "_$P(EC725,"^")
"RTN","ECOSSUM",92,0)
 ..S ECPN=$E(ECPN,1,37)_$S(ECPSYN]"":" ["_ECPSYN_"] ",1:"")_"~"_ECCPT
"RTN","ECOSSUM",93,0)
 ..;ALB/JAM - Get Procedure CPT modifiers
"RTN","ECOSSUM",94,0)
 ..S ECMODF=0 I $O(^ECH(ECDA,"MOD",0))'="" D
"RTN","ECOSSUM",95,0)
 ...K ECMOD S ECMODF=$$MOD^ECUTL(ECDA,"E",.ECMOD)
"RTN","ECOSSUM",96,0)
 ..S (ECPA,ECPATN,ECSS)="",ECPA=$G(^DPT(+$P(EC,"^",2),0)) Q:ECPA=""
"RTN","ECOSSUM",97,0)
 ..S ECPATN=$P(ECPA,"^",1),ECSS=$P(ECPA,"^",9)
"RTN","ECOSSUM",98,0)
 ..S:+ECSS ECSSN=$E(ECSS,6,10) S:ECSS="" ECSSN="UNKN"
"RTN","ECOSSUM",99,0)
 ..S:ECPATN="" ECPATN="UNKNOWN" S ECPATN=ECPATN_"^"_ECSSN
"RTN","ECOSSUM",100,0)
 ..S ECV=+$P(EC,"^",10)
"RTN","ECOSSUM",101,0)
 ..K ECPRV S ECPRV=$$GETPRV^ECPRVMUT(ECDA,.ECPRV) I 'ECPRV D  K ECPRV
"RTN","ECOSSUM",102,0)
 ...M ^TMP("ECOS",$J,ECLOCA,ECUNIT,ECPATN,ECDA,"PRV")=ECPRV
"RTN","ECOSSUM",103,0)
 ..S ^TMP("ECOS",$J,ECLOCA,ECUNIT,ECPATN,ECDA)=ECSSN_"^"_ECPN_"^"_ECV
"RTN","ECOSSUM",104,0)
 ..I ECMODF D
"RTN","ECOSSUM",105,0)
 ...M ^TMP("ECOS",$J,ECLOCA,ECUNIT,ECPATN,ECDA,"MOD")=ECMOD
"RTN","ECOSSUM",106,0)
 Q
"RTN","ECOSSUM",107,0)
 ;
"RTN","ECOSSUM",108,0)
PRINT ;output report
"RTN","ECOSSUM",109,0)
 N ECDA,ECLOCA,ECUNIT,ECPATN,ECSSN,ECPN,ECV
"RTN","ECOSSUM",110,0)
 N PAGE,QFLAG,DASH,DASH2,PRNTDT,JJ,SS,ALOC,AUNIT,LOC,UNNAME,UNIT,DATA,PTNAME,PROV,PROVN,V,X,Y
"RTN","ECOSSUM",111,0)
 S (PAGE,QFLAG)=0 S $P(DASH,"-",130)="",$P(DASH2,"-",64)=""
"RTN","ECOSSUM",112,0)
 S Y=$P(ECSD,".",1)+1 D DD^%DT S ECSD=Y S Y=$P(ECED,".",1) D DD^%DT S ECED=Y
"RTN","ECOSSUM",113,0)
 D NOW^%DTC S Y=$E(%,1,12) D DD^%DT S PRNTDT=Y
"RTN","ECOSSUM",114,0)
 S ECV("L")=0,ECV("O")=0,ECV("P")=0,ECV("U")=0
"RTN","ECOSSUM",115,0)
 ;if no data exists then print the header and quit
"RTN","ECOSSUM",116,0)
 I '$D(^TMP("ECOS",$J)) D  Q
"RTN","ECOSSUM",117,0)
 .S LOC="" D HEAD
"RTN","ECOSSUM",118,0)
 .W !!,?26,"No data for this Ordering Section for the date range specified.",!!
"RTN","ECOSSUM",119,0)
 .I $E(IOST)="C"&('QFLAG) S DIR(0)="E" D  D ^DIR K DIR
"RTN","ECOSSUM",120,0)
 ..S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECOSSUM",121,0)
 .W:$E(IOST)'="C" @IOF
"RTN","ECOSSUM",122,0)
 ;if there's data in ^TMP then need to present the data alphabetically;
"RTN","ECOSSUM",123,0)
 ;put locations and units in alpha ordered array
"RTN","ECOSSUM",124,0)
 S JJ="" F  S JJ=$O(ECLOC(JJ)) Q:JJ=""  D
"RTN","ECOSSUM",125,0)
 .S ALOC($P(ECLOC(JJ),"^",2))=$P(ECLOC(JJ),"^",1)
"RTN","ECOSSUM",126,0)
 S JJ="" F  S JJ=$O(ECDSSU(JJ)) Q:JJ=""  D
"RTN","ECOSSUM",127,0)
 .S AUNIT($P(ECDSSU(JJ),"^",2))=$P(ECDSSU(JJ),"^",1)
"RTN","ECOSSUM",128,0)
 ;process the ^TMP global data in alpha order for location and unit
"RTN","ECOSSUM",129,0)
 S LOC="" F  S LOC=$O(ALOC(LOC)) Q:LOC=""  S ECLOCA=ALOC(LOC),ECV("L")=0 D  Q:QFLAG
"RTN","ECOSSUM",130,0)
 .D HEAD Q:QFLAG  ;always start a new location at top of page
"RTN","ECOSSUM",131,0)
 .S UNIT="" F  S UNIT=$O(AUNIT(UNIT)) Q:UNIT=""  S ECUNIT=AUNIT(UNIT),ECV("U")=0 D  Q:QFLAG
"RTN","ECOSSUM",132,0)
 ..I '$D(^TMP("ECOS",$J,ECLOCA,ECUNIT)) Q
"RTN","ECOSSUM",133,0)
 ..S UNNAME=$E(UNIT,1,20)
"RTN","ECOSSUM",134,0)
 ..D:($Y+6>IOSL) HEAD Q:QFLAG  W !!,UNNAME
"RTN","ECOSSUM",135,0)
 ..S ECPATN="" F  S ECPATN=$O(^TMP("ECOS",$J,ECLOCA,ECUNIT,ECPATN)) Q:ECPATN=""  S ECV("P")=0 D  Q:QFLAG
"RTN","ECOSSUM",136,0)
 ...S PTNAME=$P(ECPATN,"^",1),PTNAME=$E(PTNAME,1,22),ECSSN=$P(ECPATN,"^",2)
"RTN","ECOSSUM",137,0)
 ...W ?24,PTNAME,?48,ECSSN
"RTN","ECOSSUM",138,0)
 ...S ECDA="" F  S ECDA=$O(^TMP("ECOS",$J,ECLOCA,ECUNIT,ECPATN,ECDA)) Q:ECDA=""  S DATA=^(ECDA) D  Q:QFLAG
"RTN","ECOSSUM",139,0)
 ....S ECPN=$P(DATA,"^",2),ECPN=$J($P(ECPN,"~",2)_" ",6)_$P(ECPN,"~")
"RTN","ECOSSUM",140,0)
 ....S ECPN=$E(ECPN,1,41),ECV=$P(DATA,"^",3),ECV=ECV\1 D
"RTN","ECOSSUM",141,0)
 .....F V="L","O","P","U" S ECV(V)=ECV(V)+ECV
"RTN","ECOSSUM",142,0)
 .....S:+ECV>9999 ECV="9999+" S ECV=$$RJ^XLFSTR(ECV,5," ") ;unusually high individual volume figure
"RTN","ECOSSUM",143,0)
 ....K PROV M PROV=^TMP("ECOS",$J,ECLOCA,ECUNIT,ECPATN,ECDA,"PRV")
"RTN","ECOSSUM",144,0)
 ....K ECMOD M ECMOD=^TMP("ECOS",$J,ECLOCA,ECUNIT,ECPATN,ECDA,"MOD")
"RTN","ECOSSUM",145,0)
 ....W ?54,ECPN,?96,ECV,?105,$E($P($G(PROV(1)),"^",2),1,24) K PROV(1)
"RTN","ECOSSUM",146,0)
 ....D:($Y+6>IOSL) HEAD Q:QFLAG
"RTN","ECOSSUM",147,0)
 ....;ALB/JAM - write cpt procedure modifiers on same line with providers
"RTN","ECOSSUM",148,0)
 ....S MOD=0,PROVN=1 F  S MOD=$O(ECMOD(MOD)),PROVN=$O(PROV(PROVN)) Q:(MOD="")&(PROVN="")  D  I QFLAG Q
"RTN","ECOSSUM",149,0)
 .....I ($Y+6>IOSL) D HEAD Q:QFLAG  W !?54,ECPN
"RTN","ECOSSUM",150,0)
 .....W !
"RTN","ECOSSUM",151,0)
 .....I MOD'="" W ?58,"- ",MOD," ",$E($P(ECMOD(MOD),U,3),1,36) K ECMOD(MOD)
"RTN","ECOSSUM",152,0)
 .....I PROVN'="" W ?105,$E($P($G(PROV(PROVN)),"^",2),1,24) K PROV(PROVN)
"RTN","ECOSSUM",153,0)
 ....W ! ;start a new line
"RTN","ECOSSUM",154,0)
 ...;write subtotal for patient
"RTN","ECOSSUM",155,0)
 ...Q:QFLAG  D:($Y+6>IOSL) HEAD Q:QFLAG
"RTN","ECOSSUM",156,0)
 ...W ?54,DASH2,!
"RTN","ECOSSUM",157,0)
 ...W ?24,"Subtotal for "_$P(ECPATN,"^",1)_":",?96,$$RJ^XLFSTR(ECV("P"),5," "),!!
"RTN","ECOSSUM",158,0)
 ..;write total for unit
"RTN","ECOSSUM",159,0)
 ..Q:QFLAG  D:($Y+6>IOSL) HEAD Q:QFLAG
"RTN","ECOSSUM",160,0)
 ..W !,"Subtotal for DSS Unit "_UNIT_":",?95,$$RJ^XLFSTR(ECV("U"),6," "),!
"RTN","ECOSSUM",161,0)
 .;write the total for the location
"RTN","ECOSSUM",162,0)
 .Q:QFLAG  D:($Y+6>IOSL) HEAD Q:QFLAG
"RTN","ECOSSUM",163,0)
 .W !!,"Total for Location "_LOC_":",?95,$$RJ^XLFSTR(ECV("L"),6," "),!
"RTN","ECOSSUM",164,0)
 ;write the ordering section grandtotal
"RTN","ECOSSUM",165,0)
 Q:QFLAG  D:($Y+8>IOSL) HEAD Q:QFLAG
"RTN","ECOSSUM",166,0)
 W !!!,"Grand Total for Ordering Section "_ECOSN_":",?95,$$RJ^XLFSTR(ECV("O"),6," "),!
"RTN","ECOSSUM",167,0)
 ;all done
"RTN","ECOSSUM",168,0)
 D FOOTER  ;print footer on last page
"RTN","ECOSSUM",169,0)
 I $E(IOST)="C"&('QFLAG) S DIR(0)="E" D  D ^DIR W @IOF
"RTN","ECOSSUM",170,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECOSSUM",171,0)
 W:$E(IOST)'="C" @IOF
"RTN","ECOSSUM",172,0)
 Q
"RTN","ECOSSUM",173,0)
HEAD ;header
"RTN","ECOSSUM",174,0)
 I $E(IOST)="C" S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECOSSUM",175,0)
 I PAGE>0 D FOOTER
"RTN","ECOSSUM",176,0)
 I $E(IOST)="C",PAGE>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLAG=1 Q
"RTN","ECOSSUM",177,0)
 W:$Y!($E(IOST)="C") @IOF
"RTN","ECOSSUM",178,0)
 S PAGE=PAGE+1
"RTN","ECOSSUM",179,0)
 W !,?26,"Event Capture Ordering Section Summary for ",ECOSN,?105,"Page: ",PAGE
"RTN","ECOSSUM",180,0)
 W !,?26,"for the Date Range ",$$FMTE^XLFDT(ECSD)," to ",$$FMTE^XLFDT(ECED),?102,"Printed: "_PRNTDT
"RTN","ECOSSUM",181,0)
 W !,?26,"Location: ",LOC,!
"RTN","ECOSSUM",182,0)
 W !,"DSS Unit",?24,"Patient",?48,"SSN",?54,"Procedure",?98,"Vol.",?105,"Provider(s)"
"RTN","ECOSSUM",183,0)
 W !,DASH,!
"RTN","ECOSSUM",184,0)
 Q
"RTN","ECOSSUM",185,0)
 ;
"RTN","ECOSSUM",186,0)
FOOTER ;print page footer
"RTN","ECOSSUM",187,0)
 W !!?4,"Volume totals may represent days, minutes, numbers of procedures"
"RTN","ECOSSUM",188,0)
 W !?4,"and/or a combination of these."
"RTN","ECOSSUM",189,0)
 Q
"RTN","ECOSSUM",190,0)
 ;
"RTN","ECOSSUM",191,0)
EXIT ;common exit point
"RTN","ECOSSUM",192,0)
 D ^ECKILL
"RTN","ECOSSUM",193,0)
 D:'$D(ECGUI) ^%ZISC
"RTN","ECOSSUM",194,0)
 K ^TMP("ECOS",$J)
"RTN","ECOSSUM",195,0)
 K JJ,X,Y,ZTSK,IO("Q"),DIR,DIRUT,DTOUT,DUOUT,ECOS,ECOSN,ECSD,ECED,ECLOOP,ECLOC,ECDSSU
"RTN","ECOSSUM",196,0)
 Q
"RTN","ECPAT")
0^5^B32218957
"RTN","ECPAT",1,0)
ECPAT ;BIR/MAM,JPW - Event Capture Patient Summary ;1 Jul 2008
"RTN","ECPAT",2,0)
 ;;2.0; EVENT CAPTURE ;**5,18,47,72,95**;8 May 96;Build 26
"RTN","ECPAT",3,0)
SET ; set ^TMP($J,"ECPAT")
"RTN","ECPAT",4,0)
 N ECPXD,EC725
"RTN","ECPAT",5,0)
 I $Y+11>IOSL D PAGE I ECOUT Q
"RTN","ECPAT",6,0)
 S ECEC=$G(^ECH(ECFN,0))
"RTN","ECPAT",7,0)
 S ECL=+$P(ECEC,"^",4),ECC=+$P(ECEC,"^",8),ECP=$P(ECEC,"^",9),ECD=+$P(ECEC,"^",7),ECV=+$P(ECEC,"^",10)
"RTN","ECPAT",8,0)
 S ECU=$$GETPPRV^ECPRVMUT(ECFN,.ECUN),ECUN=$S(ECU:"UNKNOWN",1:$P(ECUN,"^",2))
"RTN","ECPAT",9,0)
 Q:ECP']""
"RTN","ECPAT",10,0)
 ;set default med spec and ord sect to administrative if blank
"RTN","ECPAT",11,0)
 S ECM=$S($P(ECEC,"^",6)]"":+$P(ECEC,"^",6),1:108),ECO=$S($P(ECEC,"^",12)]"":+$P(ECEC,"^",12),1:108)
"RTN","ECPAT",12,0)
 S ECMN=$S($P($G(^ECC(723,ECM,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPAT",13,0)
 S ECON=$S($P($G(^ECC(723,ECO,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPAT",14,0)
 S ECS=+$P(ECEC,"^",5),ECSN=$S($P($G(^DIC(49,ECS,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPAT",15,0)
 S ECCN=$S($P($G(^EC(726,ECC,0)),"^")]"":$P(^(0),"^"),1:"None")
"RTN","ECPAT",16,0)
 S ECPSY=+$O(^ECJ("AP",ECL,ECD,ECC,ECP,""))
"RTN","ECPAT",17,0)
 S ECPSYN=$P($G(^ECJ(ECPSY,"PRO")),"^",2)
"RTN","ECPAT",18,0)
 S ECFILE=$P(ECP,";",2),ECFILE=$S($E(ECFILE)="I":81,1:725)
"RTN","ECPAT",19,0)
 S ECCPT=$S(ECFILE=81:+ECP,1:$P($G(^EC(725,+ECP,0)),"^",5)),ECPXD=""
"RTN","ECPAT",20,0)
 I ECCPT'="" D
"RTN","ECPAT",21,0)
 . S ECPXD=$$CPT^ICPTCOD(ECCPT,$P(ECEC,"^",3)),ECCPT=$P(ECPXD,"^",2)
"RTN","ECPAT",22,0)
 . I ECCPT'="" S ECCPT=ECCPT_" "
"RTN","ECPAT",23,0)
 I ECFILE=81 S ECPN=$S($P(ECPXD,"^",3)]"":$P(ECPXD,"^",3),1:"UNKNOWN")
"RTN","ECPAT",24,0)
 I ECFILE=725 D
"RTN","ECPAT",25,0)
 .S EC725=$G(^EC(725,+ECP,0)),ECPN=$P(EC725,"^",2)_" "_$P(EC725,"^")
"RTN","ECPAT",26,0)
 S ECPN=$J(ECCPT,6)_$E(ECPN,1,38)_$S(ECPSYN]"":" ["_ECPSYN_"] ",1:"")
"RTN","ECPAT",27,0)
 S ECDN=$S($P($G(^ECD(ECD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPAT",28,0)
 S ECLN=$S($P($G(^DIC(4,ECL,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPAT",29,0)
 S ECUN=$S(ECUN'="UNKNOWN":$P(ECUN,",",2)_" "_$P(ECUN,","),1:"UNKNOWN")
"RTN","ECPAT",30,0)
 S ECDT=$$FMTE^XLFDT(DATE)
"RTN","ECPAT",31,0)
 ;
"RTN","ECPAT",32,0)
 ;ALB/ESD - Add Procedure Reason to report
"RTN","ECPAT",33,0)
 N ECLNK
"RTN","ECPAT",34,0)
 S ECPRSN=""
"RTN","ECPAT",35,0)
 S ECLNK=+$P(ECEC,"^",23)
"RTN","ECPAT",36,0)
 I +ECLNK>0 DO
"RTN","ECPAT",37,0)
 .S ECPRSN=$P($G(^ECL(ECLNK,0)),"^",1)
"RTN","ECPAT",38,0)
 .S:+ECPRSN'>0 ECPRSN="REASON NOT DEFINED"
"RTN","ECPAT",39,0)
 .S:+ECPRSN>0 ECPRSN=$P(^ECR(ECPRSN,0),"^",1)
"RTN","ECPAT",40,0)
 S:+ECLNK'>0 ECPRSN="REASON NOT DEFINED"
"RTN","ECPAT",41,0)
 ;
"RTN","ECPAT",42,0)
 ;Get Procedure CPT modifiers
"RTN","ECPAT",43,0)
 S ECMODF=0 K ECMOD
"RTN","ECPAT",44,0)
 I $O(^ECH(ECFN,"MOD",0))'="" S ECMODF=$$MOD^ECUTL(ECFN,"E",.ECMOD)
"RTN","ECPAT",45,0)
 I $D(ECY) DO
"RTN","ECPAT",46,0)
 .W !!,ECDT,?25,ECCN,?80,ECPN_" ("_ECV_")",!
"RTN","ECPAT",47,0)
 .I ECMODF S MD="" D  K MD I ECOUT Q
"RTN","ECPAT",48,0)
 ..F  S MD=$O(ECMOD(MD)) Q:MD=""  D  I ECOUT Q
"RTN","ECPAT",49,0)
 ...D:$Y+5>IOSL PAGE Q:ECOUT  W ?84,"- ",MD," ",$P(ECMOD(MD),U,3),!
"RTN","ECPAT",50,0)
 .W $E(ECLN,1,22),?25,ECSN,?80,ECMN,!
"RTN","ECPAT",51,0)
 .W:$D(ECRY) ECPRSN
"RTN","ECPAT",52,0)
 .W ?25,ECON,?80,ECUN
"RTN","ECPAT",53,0)
 I $D(ECN) DO
"RTN","ECPAT",54,0)
 .W !!,ECDT,?25,ECPN_" ("_ECV_")",!
"RTN","ECPAT",55,0)
 .I ECMODF S MD="" D  K MD I ECOUT Q
"RTN","ECPAT",56,0)
 ..F  S MD=$O(ECMOD(MD)) Q:MD=""  D  I ECOUT Q
"RTN","ECPAT",57,0)
 ...D:$Y+5>IOSL PAGE Q:ECOUT  W ?29,"- ",MD," ",$P(ECMOD(MD),U,3),!
"RTN","ECPAT",58,0)
 .W $E(ECLN,1,22),?25,ECSN,?80,ECMN,!
"RTN","ECPAT",59,0)
 .W:$D(ECRY) ECPRSN
"RTN","ECPAT",60,0)
 .W ?25,ECON,?80,ECUN
"RTN","ECPAT",61,0)
 Q
"RTN","ECPAT",62,0)
PAT ; entry point
"RTN","ECPAT",63,0)
 K DIC S DIC=2,DIC(0)="QEAMZ",DIC("A")="Select Patient: " D ^DIC K DIC G:Y<0 END S ECDFN=+Y,ECPAT=$P(Y,"^",2)
"RTN","ECPAT",64,0)
DATE K %DT S %DT="AEX",%DT("A")="Start with Date:  " D ^%DT G:Y<0 END S ECSD=Y,%DT("A")="End with Date:  " D ^%DT G:Y<0 END S ECED=Y I ECED<ECSD W !,"End date must be after start date",! G DATE
"RTN","ECPAT",65,0)
 S ECDATE=$$FMTE^XLFDT(ECSD)_"^"_$$FMTE^XLFDT(ECED),ECSD=ECSD-.0001,ECED=ECED+.9999
"RTN","ECPAT",66,0)
 D REASON^ECRUTL ;* Prompt to report Procedure Reasons
"RTN","ECPAT",67,0)
 K IOP,%ZIS,POP,IO("Q") S %ZIS("A")="Select Device: ",%ZIS="QM" W !!,"This report is designed to use a 132 column format.",! D ^%ZIS G:POP END
"RTN","ECPAT",68,0)
 I $D(IO("Q")) S:$D(ECRY) ZTSAVE("ECRY")=""
"RTN","ECPAT",69,0)
 I $D(IO("Q")) K IO("Q") S (ZTSAVE("ECDFN"),ZTSAVE("ECPAT"),ZTSAVE("ECDATE"),ZTSAVE("ECED"),ZTSAVE("ECSD"))="",ZTDESC="EVENT CAPTURE PATIENT SUMMARY",ZTRTN="SUM^ECPAT",ZTIO=ION D ^%ZTLOAD,HOME^%ZIS G END
"RTN","ECPAT",70,0)
SUM ; entry when queued
"RTN","ECPAT",71,0)
 S %H=$H D YX^%DTC S ECRDT=Y
"RTN","ECPAT",72,0)
 U IO S DATE=$O(^ECH("APAT",ECDFN,ECSD)) I 'DATE W:$Y @IOF W !!,"No Data for "_ECPAT_" during the time selected." G END
"RTN","ECPAT",73,0)
 S ECFN=+$O(^ECH("APAT",ECDFN,DATE,0)),ECL=+$P(^ECH(ECFN,0),"^",4) D BRO D:$D(ECY) HDR D:$D(ECN) HDR1
"RTN","ECPAT",74,0)
 S DATE=ECSD,(ECFN,ECOUT)=0 F I=0:0 S DATE=$O(^ECH("APAT",ECDFN,DATE)) Q:'DATE!(DATE>ECED)!(ECOUT)  F I=0:0 S ECFN=$O(^ECH("APAT",ECDFN,DATE,ECFN)) Q:'ECFN!(ECOUT)  D SET
"RTN","ECPAT",75,0)
 D FOOTER  ;for last page
"RTN","ECPAT",76,0)
END I $D(ECGUI) D ^ECKILL Q
"RTN","ECPAT",77,0)
 W ! I $D(ECOUT),'ECOUT D
"RTN","ECPAT",78,0)
 . I $E(IOST,1,2)="C-" W !!,"Press <RET> to continue  " R X:DTIME
"RTN","ECPAT",79,0)
 W @IOF D ^%ZISC D ^ECKILL S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECPAT",80,0)
 Q
"RTN","ECPAT",81,0)
HDR ; print heading
"RTN","ECPAT",82,0)
 ;
"RTN","ECPAT",83,0)
 ;ALB/ESD - Add Procedure Reason to column headings
"RTN","ECPAT",84,0)
 W:$Y @IOF
"RTN","ECPAT",85,0)
 W !,?32,"EVENT CAPTURE PATIENT SUMMARY FOR "_ECPAT,!,?32,"FROM "_$P(ECDATE,"^")_"   TO "_$P(ECDATE,"^",2),!,?32,"Run Date : ",ECRDT
"RTN","ECPAT",86,0)
 W !,"PROCEDURE DATE/TIME",?25,"CATEGORY",?80,"PROCEDURE",!,?80,"PROCEDURE (CPT) MODIFIER",!,"LOCATION",?25,"SERVICE",?80,"SECTION"
"RTN","ECPAT",87,0)
 W !
"RTN","ECPAT",88,0)
 W:$D(ECRY) "PROCEDURE REASON"
"RTN","ECPAT",89,0)
 W ?25,"ORDERING SECTION",?80,"PROVIDER",! F LINE=1:1:132 W "-"
"RTN","ECPAT",90,0)
 W !
"RTN","ECPAT",91,0)
 Q
"RTN","ECPAT",92,0)
PAGE ; end of page
"RTN","ECPAT",93,0)
 I $G(X)'["?" D FOOTER
"RTN","ECPAT",94,0)
 S X="" I $E(IOST,1,2)="C-" W !!,"Press <RET> to continue, or ^ to quit   " R X:DTIME I '$T!(X="^") S ECOUT=1 Q
"RTN","ECPAT",95,0)
 I X["?" W !!,"If you want to continue with this report, press <RET>.  Entering an ^ will",!,"exit you from this option." G PAGE
"RTN","ECPAT",96,0)
 D:$D(ECY) HDR D:$D(ECN) HDR1
"RTN","ECPAT",97,0)
 Q
"RTN","ECPAT",98,0)
HDR1 ; print heading without categories
"RTN","ECPAT",99,0)
 ;
"RTN","ECPAT",100,0)
 ;ALB/ESD - Add Run Date to header
"RTN","ECPAT",101,0)
 W @IOF,!!,?32,"EVENT CAPTURE PATIENT SUMMARY FOR "_ECPAT,!,?36,"FROM "_$P(ECDATE,"^")_"   TO "_$P(ECDATE,"^",2),!,?36,"Run Date : ",ECRDT
"RTN","ECPAT",102,0)
 ;
"RTN","ECPAT",103,0)
 ;ALB/ESD - Add Procedure Reason to column headings
"RTN","ECPAT",104,0)
 W !!,"PROCEDURE DATE/TIME",?25,"PROCEDURE(VOLUME)",!,?25,"PROCEDURE (CPT) MODIFIER",!,"LOCATION",?25,"SERVICE",?80,"SECTION"
"RTN","ECPAT",105,0)
 W !
"RTN","ECPAT",106,0)
 W:$D(ECRY) "PROCEDURE REASON"
"RTN","ECPAT",107,0)
 W ?25,"ORDERING SECTION",?80,"PROVIDER",! F LINE=1:1:132 W "-"
"RTN","ECPAT",108,0)
 W !
"RTN","ECPAT",109,0)
 Q
"RTN","ECPAT",110,0)
 ;
"RTN","ECPAT",111,0)
FOOTER ;print page footer
"RTN","ECPAT",112,0)
 W !!?4,"Volume totals may represent days, minutes, numbers of procedures"
"RTN","ECPAT",113,0)
 W !?4,"and/or a combination of these."
"RTN","ECPAT",114,0)
 Q
"RTN","ECPAT",115,0)
 ;
"RTN","ECPAT",116,0)
BRO ;ask prt with category or without
"RTN","ECPAT",117,0)
 S ECN=1
"RTN","ECPAT",118,0)
 Q
"RTN","ECPCER")
0^6^B20555015
"RTN","ECPCER",1,0)
ECPCER ;BIR/JPW - Event Capture PCE Data Summary ;1 Jul 2008
"RTN","ECPCER",2,0)
 ;;2.0; EVENT CAPTURE ;**4,18,23,47,72,95**;8 May 96;Build 26
"RTN","ECPCER",3,0)
EN ; entry point
"RTN","ECPCER",4,0)
 K DIC S DIC=2,DIC(0)="QEAMZ",DIC("A")="Select Patient: " D ^DIC K DIC G:Y<0 END S ECDFN=+Y,ECPAT=$P(Y,"^",2)
"RTN","ECPCER",5,0)
DATE K %DT S %DT="AEX",%DT("A")="Start with Date:  " D ^%DT G:Y<0 END S ECSD=Y,%DT("A")="End with Date:  " D ^%DT G:Y<0 END S ECED=Y I ECED<ECSD W !,"End date must be after start date",! G DATE
"RTN","ECPCER",6,0)
 S ECDATE=$$FMTE^XLFDT(ECSD)_"^"_$$FMTE^XLFDT(ECED),ECSD=ECSD-.0001,ECED=ECED+.9999
"RTN","ECPCER",7,0)
 K IOP,%ZIS,POP,IO("Q") S %ZIS("A")="Select Device: ",%ZIS="QM" W !!,"This report is designed to use a 132 column format.",! D ^%ZIS G:POP END
"RTN","ECPCER",8,0)
 I $D(IO("Q")) K IO("Q") S (ZTSAVE("ECDFN"),ZTSAVE("ECPAT"),ZTSAVE("ECDATE"),ZTSAVE("ECED"),ZTSAVE("ECSD"))="",ZTDESC="ECS/PCE PATIENT SUMMARY",ZTRTN="SUM^ECPCER",ZTIO=ION D ^%ZTLOAD,HOME^%ZIS G END
"RTN","ECPCER",9,0)
SUM ; entry when queued
"RTN","ECPCER",10,0)
 S %H=$H D YX^%DTC S ECRDT=Y
"RTN","ECPCER",11,0)
 U IO S DATE=$O(^ECH("APAT",ECDFN,ECSD)) I 'DATE W:$Y @IOF W !!,"No Data for "_ECPAT_" during the time selected." G END
"RTN","ECPCER",12,0)
 S ECFN=+$O(^ECH("APAT",ECDFN,DATE,0)),ECL=+$P(^ECH(ECFN,0),"^",4) D HDR1
"RTN","ECPCER",13,0)
 S DATE=ECSD,(ECFN,ECOUT)=0 F  S DATE=$O(^ECH("APAT",ECDFN,DATE)) Q:'DATE!(DATE>ECED)!(ECOUT)  F  S ECFN=$O(^ECH("APAT",ECDFN,DATE,ECFN)) Q:'ECFN!(ECOUT)  D SET
"RTN","ECPCER",14,0)
 D FOOTER  ;print footer on last page
"RTN","ECPCER",15,0)
END I $D(ECGUI) D ^ECKILL Q
"RTN","ECPCER",16,0)
 W ! I $E(IOST,1,2)="C-" W !!,"Press <RET> to continue  " R X:DTIME
"RTN","ECPCER",17,0)
 W @IOF D ^%ZISC D ^ECKILL S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECPCER",18,0)
 Q
"RTN","ECPCER",19,0)
PAGE ; end of page
"RTN","ECPCER",20,0)
 I $G(X)'["?" D FOOTER
"RTN","ECPCER",21,0)
 S X="" I $E(IOST,1,2)="C-" W !!,"Press <RET> to continue, or ^ to quit   " R X:DTIME I '$T!(X="^") S ECOUT=1 Q
"RTN","ECPCER",22,0)
 I X["?" W !!,"If you want to continue with this report, press <RET>.  Entering an ^ will",!,"exit you from this option." G PAGE
"RTN","ECPCER",23,0)
 D HDR1
"RTN","ECPCER",24,0)
 Q
"RTN","ECPCER",25,0)
HDR1 ; print heading without categories
"RTN","ECPCER",26,0)
 W:$Y @IOF
"RTN","ECPCER",27,0)
 ;W !,?31,"ECS/PCE PATIENT SUMMARY FOR "_ECPAT,!,?36,"FROM "_$P(ECDATE,"^")_"   TO "_$P(ECDATE,"^",2),!!,"PROCEDURE DATE/TIME",?25,"PROCEDURE NAME SENT (VOLUME)",?78,"CPT CODE (DIAGNOSIS)",!?78,"PROCEDURE (CPT) MODIFIER"
"RTN","ECPCER",28,0)
 W !,?31,"ECS/PCE PATIENT SUMMARY FOR "_ECPAT,!,?36,"FROM "_$P(ECDATE,"^")_"   TO "_$P(ECDATE,"^",2),!!,"PROCEDURE DATE/TIME",?25,"PROCEDURE NAME SENT (VOLUME)",?78,"PROVIDER"
"RTN","ECPCER",29,0)
 ;W !,"LOCATION",?25,"CLINIC (DSS ID)",?78,"PROVIDER",!
"RTN","ECPCER",30,0)
 W !,"LOCATION",?25,"CLINIC (DSS ID)",?78,"CPT CODE"
"RTN","ECPCER",31,0)
 W !,?25,"DIAGNOSIS",?78,"PROCEDURE (CPT) MODIFIER",!
"RTN","ECPCER",32,0)
 F LINE=1:1:132 W "-"
"RTN","ECPCER",33,0)
 W !
"RTN","ECPCER",34,0)
 Q
"RTN","ECPCER",35,0)
FOOTER ;print page footer
"RTN","ECPCER",36,0)
 W !!?4,"Volume totals may represent days, minutes, numbers of procedures"
"RTN","ECPCER",37,0)
 W !?4,"and/or a combination of these."
"RTN","ECPCER",38,0)
 Q
"RTN","ECPCER",39,0)
 ;
"RTN","ECPCER",40,0)
SET ; set data
"RTN","ECPCER",41,0)
 I $Y+10>IOSL D PAGE I ECOUT Q
"RTN","ECPCER",42,0)
 Q:'$D(^ECH(ECFN,"PCE"))  S ECEC=$G(^ECH(ECFN,"PCE"))
"RTN","ECPCER",43,0)
 I '$P($G(^ECH(ECFN,"P")),"^",7) Q
"RTN","ECPCER",44,0)
 S ECL=+$P(ECEC,"~",4),ECCPT=+$P(ECEC,"~",10),ECD=+$P(ECEC,"~",3),ECV=+$P(ECEC,"~",9),ECDX=+$P(ECEC,"~",11),ECID=$P(ECEC,"~",5),ECDT=+$P(ECEC,"~")
"RTN","ECPCER",45,0)
 S ECDN=$S($P($G(^SC(ECD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPCER",46,0)
 S ECPS=$$CPT^ICPTCOD(ECCPT,$P(ECEC,"~")),ECCPT=$S(+ECPS>0:$P(ECPS,"^",2),1:""),ECPS=$S(+ECPS>0:$P(ECPS,"^",2)_" "_$P(ECPS,"^",3),1:"CPT NAME UNKNOWN")
"RTN","ECPCER",47,0)
 S ECLN=$S($P($G(^DIC(4,ECL,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPCER",48,0)
 S ECID=$S($P($G(^DIC(40.7,ECID,0)),"^",2)]"":$P(^(0),"^",2),1:"DSS ID UNKNOWN")
"RTN","ECPCER",49,0)
 S ECDXN=$P($$ICDDX^ICDCODE(ECDX,$P(ECEC,"~")),U,2) S:ECDXN="" ECDXN="UNKNOWN"
"RTN","ECPCER",50,0)
 S ECPN=$S($P(ECEC,"~",16)]"":$P(ECEC,"~",16),1:ECPS)
"RTN","ECPCER",51,0)
 S ECU=$$GETPPRV^ECPRVMUT(ECFN,.ECUN),ECUN=$S(ECU:"UNKNOWN",1:$P(ECUN,"^",2))
"RTN","ECPCER",52,0)
 S ECUN=$S(ECUN'="UNKNOWN":$P(ECUN,",",2)_" "_$P(ECUN,","),1:"UNKNOWN")
"RTN","ECPCER",53,0)
 S ECDT=$$FMTE^XLFDT(ECDT)
"RTN","ECPCER",54,0)
 ;get secondary diagnosis codes, ALB/JAM
"RTN","ECPCER",55,0)
 S DXS=0,ECI=2 F  S DXS=$O(^ECH(ECFN,"DX",DXS)) Q:'DXS  D
"RTN","ECPCER",56,0)
 . S DXSIEN=+$G(^ECH(ECFN,"DX",DXS,0)) I DXSIEN="" Q
"RTN","ECPCER",57,0)
 . S ECDXSN=$P($$ICDDX^ICDCODE(DXSIEN,$P(ECEC,"~")),"^",2) I ECDXSN="" Q
"RTN","ECPCER",58,0)
 . I $L($G(ECDXS(ECI)))+$L(ECDXSN)>52 S ECI=ECI+1
"RTN","ECPCER",59,0)
 . I $G(ECDXS(ECI))="" S ECDXS(ECI)="Secondary Dx: "
"RTN","ECPCER",60,0)
 . S ECDXS(ECI)=ECDXS(ECI)_$S($L(ECDXS(ECI))=14:"",1:", ")_ECDXSN
"RTN","ECPCER",61,0)
 S ECMOD="" I $D(^ECH(ECFN,"PCE1")) S ECMOD=^("PCE1")
"RTN","ECPCER",62,0)
PRT W !,ECDT,?25,ECPN_" ("_ECV_")",?78,ECUN,!
"RTN","ECPCER",63,0)
 W $E(ECLN,1,22),?25,ECDN_" ("_ECID_")",?78,ECCPT,!
"RTN","ECPCER",64,0)
 W ?25,"Primary DX: ",ECDXN
"RTN","ECPCER",65,0)
 ;ALB/JAM print CPT modifiers and secondary diagnosis code
"RTN","ECPCER",66,0)
 F I=1:1 S MOD=$P(ECMOD,";",I) Q:MOD=""  D  I ECOUT Q
"RTN","ECPCER",67,0)
 . S MODESC=$$MODP^ICPTMOD(ECCPT,MOD,"E",$P(ECEC,"~")) I +MODESC'>0 Q
"RTN","ECPCER",68,0)
 . W ?25,$S(I>1:$G(ECDXS(I)),1:""),?79,"- ",MOD," ",$P(MODESC,"^",2),!
"RTN","ECPCER",69,0)
 . K ECDXS(I) I ($Y+6)>IOSL D PAGE I ECOUT Q
"RTN","ECPCER",70,0)
 W:ECMOD="" ! S DXS=""
"RTN","ECPCER",71,0)
 F  S DXS=$O(ECDXS(DXS)) Q:DXS=""  W ?25,ECDXS(DXS),!
"RTN","ECPCER",72,0)
 K I,MOD,MODESC,ECI,DXS,DXSIEN,ECDXS,ECDXN,ECDXSN
"RTN","ECPCER",73,0)
 Q
"RTN","ECPCEU")
0^7^B29653566
"RTN","ECPCEU",1,0)
ECPCEU ;BIR/JPW - ECS to PCE Utilities ;23 Jul 2008
"RTN","ECPCEU",2,0)
 ;;2.0; EVENT CAPTURE ;**4,5,7,10,17,18,23,42,54,73,72,95**;8 May 96;Build 26
"RTN","ECPCEU",3,0)
CLIN ;check for active inactive clinic
"RTN","ECPCEU",4,0)
 N ECCLDT
"RTN","ECPCEU",5,0)
 I $L($G(ECDT))>6,+ECDT=ECDT S ECCLDT=ECDT
"RTN","ECPCEU",6,0)
 I '$G(ECCLDT) S ECCLDT=DT
"RTN","ECPCEU",7,0)
 K ECPCL
"RTN","ECPCEU",8,0)
 I '$D(EC4) S ECPCL=0 Q
"RTN","ECPCEU",9,0)
 I 'EC4 S ECPCL=0 Q
"RTN","ECPCEU",10,0)
 I '$D(^SC(+EC4,"I")) S ECPCL=1 Q
"RTN","ECPCEU",11,0)
 S ECPCID=+$P(^SC(+EC4,"I"),"^"),ECPCRD=+$P(^("I"),"^",2)
"RTN","ECPCEU",12,0)
 I ECPCID,ECPCID'>ECCLDT I 'ECPCRD!(ECPCRD>ECCLDT) S ECPCL=0 Q
"RTN","ECPCEU",13,0)
 I ECPCID,ECPCRD,ECPCRD'>ECCLDT S ECPCL=1 Q
"RTN","ECPCEU",14,0)
 I ECPCID,ECPCID>ECCLDT S ECPCL=1 Q
"RTN","ECPCEU",15,0)
 S ECPCL=1
"RTN","ECPCEU",16,0)
 K ECPCID,ECPCRD
"RTN","ECPCEU",17,0)
 Q
"RTN","ECPCEU",18,0)
NITE ;start nightly job
"RTN","ECPCEU",19,0)
 K ^TMP("ECPXAPI",$J)
"RTN","ECPCEU",20,0)
 D NOW^%DTC S ECCKDT=+$E(%,1,12)
"RTN","ECPCEU",21,0)
 S ECPKG=$O(^DIC(9.4,"B","EVENT CAPTURE",0)),ECS="EVENT CAPTURE DATA"
"RTN","ECPCEU",22,0)
 S ECJJ=0 F  S ECJJ=$O(^ECH("AD",ECJJ)) Q:'ECJJ  S ECJJ1=0 F  S ECJJ1=$O(^ECH("AD",ECJJ,ECJJ1)) Q:'ECJJ1  I $D(^ECH(ECJJ1,"PCE")) D SET
"RTN","ECPCEU",23,0)
 K DA,DIE,DR,EC4,EC725,ECAO,ECCPT,ECDT,ECDX,ECHL,ECID,ECIR,ECJJ,ECJJ1,ECL,ECNODE,ECPKG,ECPS,ECS,ECSC,ECV,ECVST,ECVV,ECZEC,ECMST,ECHNC,ECCV,ECDFAPT,CNT,ECPRVARY,ECPRV,ECUSR
"RTN","ECPCEU",24,0)
 K %,%H,%I,ECCKDT
"RTN","ECPCEU",25,0)
 K ^TMP("ECPXAPI",$J)
"RTN","ECPCEU",26,0)
 Q
"RTN","ECPCEU",27,0)
SET ;set variables
"RTN","ECPCEU",28,0)
 S ECNODE=^ECH(ECJJ1,"PCE"),ECDT=$P(ECNODE,"~"),ECPS=$P(ECNODE,"~",2),ECHL=$P(ECNODE,"~",3),ECL=$P(ECNODE,"~",4),ECID=$P(ECNODE,"~",5),ECV=$P(ECNODE,"~",9),ECUSR=$P($G(^ECH(ECJJ1,0)),U,13)
"RTN","ECPCEU",29,0)
 S ECCPT=$P(ECNODE,"~",10),ECDX=$P(ECNODE,"~",11),ECAO=$P(ECNODE,"~",12),ECIR=$P(ECNODE,"~",13),ECZEC=$P(ECNODE,"~",14),ECSC=$P(ECNODE,"~",15),EC725=$P(ECNODE,"~",16),ECELIG=$P(ECNODE,"~",17),ECMST=$P(ECNODE,"~",18)
"RTN","ECPCEU",30,0)
 S ECHNC=$P(ECNODE,"~",19),ECCV=$P(ECNODE,"~",20)
"RTN","ECPCEU",31,0)
 ; EC*2.0*73 next line added to get default appt type if defined
"RTN","ECPCEU",32,0)
 S ECDFAPT="" S:$D(^SC(ECHL,"AT")) ECDFAPT=+$G(^SC(ECHL,"AT"))
"RTN","ECPCEU",33,0)
TMP ;set ^TMP for PCE call
"RTN","ECPCEU",34,0)
ENC S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"ENC D/T")=ECDT
"RTN","ECPCEU",35,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"PATIENT")=ECPS
"RTN","ECPCEU",36,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"HOS LOC")=ECHL
"RTN","ECPCEU",37,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"INSTITUTION")=ECL
"RTN","ECPCEU",38,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"APPT")=ECDFAPT  ; added EC*2.0*73
"RTN","ECPCEU",39,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"SC")=ECSC
"RTN","ECPCEU",40,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"AO")=ECAO
"RTN","ECPCEU",41,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"IR")=ECIR
"RTN","ECPCEU",42,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"EC")=ECZEC
"RTN","ECPCEU",43,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"MST")=ECMST
"RTN","ECPCEU",44,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"HNC")=ECHNC
"RTN","ECPCEU",45,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"CV")=ECCV
"RTN","ECPCEU",46,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"SERVICE CATEGORY")="X"
"RTN","ECPCEU",47,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"ENCOUNTER TYPE")="A"
"RTN","ECPCEU",48,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"DSS ID")=ECID
"RTN","ECPCEU",49,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"CHECKOUT D/T")=ECCKDT
"RTN","ECPCEU",50,0)
 S ^TMP("ECPXAPI",$J,"ENCOUNTER",1,"ELIGIBILITY")=ECELIG
"RTN","ECPCEU",51,0)
PROV ;Set providers in ^TMP("ECPXAPI",$J,"PROVIDER",n,"NAME")=provider
"RTN","ECPCEU",52,0)
 K ECPRVARY S ECPRV=$$GETPRV^ECPRVMUT(ECJJ1,.ECPRVARY),ECI=0
"RTN","ECPCEU",53,0)
 ;set primary provider in ^TMP global
"RTN","ECPCEU",54,0)
 F  S ECI=$O(ECPRVARY(ECI)) Q:'ECI  I $P(ECPRVARY(ECI),U,3)="P" D  Q
"RTN","ECPCEU",55,0)
 .S ^TMP("ECPXAPI",$J,"PROVIDER",1,"NAME")=$P(ECPRVARY(ECI),U)
"RTN","ECPCEU",56,0)
 .S ^TMP("ECPXAPI",$J,"PROVIDER",1,"PRIMARY")=1
"RTN","ECPCEU",57,0)
 .S ^TMP("ECPXAPI",$J,"PROCEDURE",1,"ENC PROVIDER")=$P(ECPRVARY(ECI),U)
"RTN","ECPCEU",58,0)
 .K ECPRVARY(ECI)
"RTN","ECPCEU",59,0)
 ;set secondary providers in ^TMP global
"RTN","ECPCEU",60,0)
 S ECI=0,CNT=2 F  S ECI=$O(ECPRVARY(ECI)) Q:'ECI  D
"RTN","ECPCEU",61,0)
 .S ^TMP("ECPXAPI",$J,"PROVIDER",CNT,"NAME")=$P(ECPRVARY(ECI),U),CNT=CNT+1
"RTN","ECPCEU",62,0)
 I $O(^ECH(ECJJ1,"MOD",0))'="" S ECMODF=$$MOD^ECUTL(ECJJ1,"E",.ECMOD) D
"RTN","ECPCEU",63,0)
 . I ECMODF S MOD="" F  S MOD=$O(ECMOD(MOD)) Q:MOD=""  D 
"RTN","ECPCEU",64,0)
 . . S ^TMP("ECPXAPI",$J,"PROCEDURE",1,"MODIFIERS",MOD)=""
"RTN","ECPCEU",65,0)
DX S ^TMP("ECPXAPI",$J,"DX/PL",1,"DIAGNOSIS")=ECDX
"RTN","ECPCEU",66,0)
 S ^TMP("ECPXAPI",$J,"DX/PL",1,"PRIMARY")=1
"RTN","ECPCEU",67,0)
 ;Set secondary diagnosis codes in ^TMP("ECPXAPI",$J,"DX/PL",1,"DIAGNOSIS",diagnosis
"RTN","ECPCEU",68,0)
 S DXS=0 F ECI=2:1 S DXS=$O(^ECH(ECJJ1,"DX",DXS)) Q:DXS=""  D
"RTN","ECPCEU",69,0)
 . S DXSIEN=$G(^ECH(ECJJ1,"DX",DXS,0)) I DXSIEN="" Q
"RTN","ECPCEU",70,0)
 . S ^TMP("ECPXAPI",$J,"DX/PL",ECI,"DIAGNOSIS")=DXSIEN
"RTN","ECPCEU",71,0)
PROC S ^TMP("ECPXAPI",$J,"PROCEDURE",1,"EVENT D/T")=ECDT
"RTN","ECPCEU",72,0)
 S ^TMP("ECPXAPI",$J,"PROCEDURE",1,"PROCEDURE")=ECCPT
"RTN","ECPCEU",73,0)
 S ^TMP("ECPXAPI",$J,"PROCEDURE",1,"QTY")=ECV
"RTN","ECPCEU",74,0)
 S:EC725]"" ^TMP("ECPXAPI",$J,"PROCEDURE",1,"NARRATIVE")=EC725
"RTN","ECPCEU",75,0)
MOD ;Set modifiers in ^TMP("ECPXAPI",$J,"PROCEDURE",1,"MODIFIERS",modifier
"RTN","ECPCEU",76,0)
 I $O(^ECH(ECJJ1,"MOD",0))'="" S ECMODF=$$MOD^ECUTL(ECJJ1,"E",.ECMOD) D
"RTN","ECPCEU",77,0)
 . I ECMODF S MOD="" F  S MOD=$O(ECMOD(MOD)) Q:MOD=""  D 
"RTN","ECPCEU",78,0)
 . . S ^TMP("ECPXAPI",$J,"PROCEDURE",1,"MODIFIERS",MOD)=""
"RTN","ECPCEU",79,0)
D2PCE S VALQUIET=1,ECVV=$$DATA2PCE^PXAPI("^TMP(""ECPXAPI"",$J)",ECPKG,ECS,.ECVST,ECUSR)
"RTN","ECPCEU",80,0)
 I ECVST K DA,DIE,DR S DA=ECJJ1,DIE=721,DR="25////1;31///@;28////"_ECVST_";32////"_ECCKDT D ^DIE K DA,DIE,DR
"RTN","ECPCEU",81,0)
 K ^TMP("ECPXAPI",$J),ECVST,VALQUIET,MOD,ECMODF,ECMOD,ECI,DXSIEN,DXS
"RTN","ECPCEU",82,0)
 K DA,D0,DIE,DR,EC725,ECAO,ECCPT,ECDT,ECDX,ECHL,ECID,ECIR,ECNODE,ECPS,ECSC,ECV,ECVV,ECZEC,ECELIG,ECMST,ECHNC,ECCV,CNT,ECPRVARY,ECPRV
"RTN","ECPCEU",83,0)
 Q
"RTN","ECPCEU",84,0)
 ;
"RTN","ECPCEU",85,0)
PCETASK(ECPCE) ;Set up task for transfer to PCE
"RTN","ECPCEU",86,0)
 ;
"RTN","ECPCEU",87,0)
 ;  Input:
"RTN","ECPCEU",88,0)
 ;    ECPCE - [pass by reference] array subscripted by FM date/time
"RTN","ECPCEU",89,0)
 ;            and pointer to EVENT CAPTURE PATIENT (#721) file
"RTN","ECPCEU",90,0)
 ;            [ex: ECPCE(3080101.140425,611)]
"RTN","ECPCEU",91,0)
 ;
"RTN","ECPCEU",92,0)
 ;  Output:
"RTN","ECPCEU",93,0)
 ;   Function value - Task ID on success; 0 on failure
"RTN","ECPCEU",94,0)
 ;
"RTN","ECPCEU",95,0)
 N ZTRTN,ZTDESC,ZTDTH,ZTIO,ZTUCI,ZTCPU,ZTPRI,ZTSAVE,ZTKIL,ZTSYNC,ZTSK
"RTN","ECPCEU",96,0)
 S ZTIO=""
"RTN","ECPCEU",97,0)
 S ZTRTN="XFER2PCE^ECPCEU"
"RTN","ECPCEU",98,0)
 S ZTDESC="ECS2PCE TRANSFER"
"RTN","ECPCEU",99,0)
 S ZTDTH=$$NOW^XLFDT()
"RTN","ECPCEU",100,0)
 S ZTSAVE("ECPCE(")=""
"RTN","ECPCEU",101,0)
 D ^%ZTLOAD
"RTN","ECPCEU",102,0)
 Q $S($D(ZTSK):ZTSK,1:0)
"RTN","ECPCEU",103,0)
 ;
"RTN","ECPCEU",104,0)
XFER2PCE ;Task entry point for single ECS record xfer to PCE
"RTN","ECPCEU",105,0)
 ;Input from Task: ECPCE -array subscripted by date and pointer
"RTN","ECPCEU",106,0)
 ;                 to EVENT CAPTURE PATIENT (#721) file
"RTN","ECPCEU",107,0)
 ;                 [Ex: ECPCE(3080101,611)]
"RTN","ECPCEU",108,0)
 ;
"RTN","ECPCEU",109,0)
 N ECPKG  ;package name
"RTN","ECPCEU",110,0)
 N ECS    ;source
"RTN","ECPCEU",111,0)
 N ECCKDT  ;check-out date/time
"RTN","ECPCEU",112,0)
 N ECJJ   ;date iterator
"RTN","ECPCEU",113,0)
 N ECJJ1  ;file #721 IEN iterator
"RTN","ECPCEU",114,0)
 K ^TMP("ECPXAPI",$J)
"RTN","ECPCEU",115,0)
 D NOW^%DTC S ECCKDT=+$E(%,1,12)
"RTN","ECPCEU",116,0)
 S ECPKG=$O(^DIC(9.4,"B","EVENT CAPTURE",0)),ECS="EVENT CAPTURE DATA"
"RTN","ECPCEU",117,0)
 S ECJJ=0 F  S ECJJ=$O(ECPCE(ECJJ)) Q:'ECJJ  D
"RTN","ECPCEU",118,0)
 . S ECJJ1=0
"RTN","ECPCEU",119,0)
 . F  S ECJJ1=$O(ECPCE(ECJJ,ECJJ1)) Q:'ECJJ1  D
"RTN","ECPCEU",120,0)
 . . I $D(^ECH(ECJJ1,"PCE")) D SET
"RTN","ECPCEU",121,0)
 K DA,DIE,DR,EC4,EC725,ECAO,ECCPT,ECDT,ECDX,ECHL,ECID,ECIR,ECJJ,ECJJ1,ECL,ECNODE,ECPKG,ECPS,ECS,ECSC,ECV,ECVST,ECVV,ECZEC,ECMST,ECHNC,ECCV,ECDFAPT,CNT,ECPRVARY,ECPRV,ECUSR
"RTN","ECPCEU",122,0)
 K %,%H,%I,ECCKDT
"RTN","ECPCEU",123,0)
 K ^TMP("ECPXAPI",$J)
"RTN","ECPCEU",124,0)
 S ZTREQ="@"
"RTN","ECPCEU",125,0)
 Q
"RTN","ECPROV3")
0^8^B36456147
"RTN","ECPROV3",1,0)
ECPROV3 ;BIR/MAM,JPW - Event Capture Provider Summary (cont'd) ;1 Jul 2008
"RTN","ECPROV3",2,0)
 ;;2.0; EVENT CAPTURE ;**5,8,18,29,47,56,63,72,95**;8 May 96;Build 26
"RTN","ECPROV3",3,0)
 ; This routine is used when printing the report for
"RTN","ECPROV3",4,0)
 ; all ACCESSIBLE DSS Units
"RTN","ECPROV3",5,0)
 ;JAM/3/7/03, This routine now combines ECPROV3, ECPROV4 and ECPROV5
"RTN","ECPROV3",6,0)
 ;
"RTN","ECPROV3",7,0)
 S %H=$H D YX^%DTC S ECRDT=Y
"RTN","ECPROV3",8,0)
 I ECL D  D LOC,PRINT Q
"RTN","ECPROV3",9,0)
 .I ECPRV=1 D UNIT Q
"RTN","ECPROV3",10,0)
 .I 'ECPRV S ECC=+$P(^ECD(ECD,0),U,11) Q
"RTN","ECPROV3",11,0)
 S ECL=0 D
"RTN","ECPROV3",12,0)
 .F I=0:0 S ECL=$O(^ECH("ADT",ECL)) Q:'ECL  D
"RTN","ECPROV3",13,0)
 ..S ECLN=$P(^DIC(4,ECL,0),"^") I ECPRV D UNIT
"RTN","ECPROV3",14,0)
 ..I 'ECPRV S ECC=+$P(^ECD(ECD,0),U,11)
"RTN","ECPROV3",15,0)
 ..D LOC
"RTN","ECPROV3",16,0)
PRINT ;Changes below were made by VMP to correct NOIS ATG-1003-32545
"RTN","ECPROV3",17,0)
 S (ECLN,ECPN)=0,ECCN=""
"RTN","ECPROV3",18,0)
 F I=0:0 S ECLN=$O(^TMP($J,ECLN)) Q:ECLN=""!(ECOUT)!(ECLN["^")  D
"RTN","ECPROV3",19,0)
 .I 'ECPRV D CATS Q
"RTN","ECPROV3",20,0)
 . S ECDN="" D NOUNIT F I=0:0 S ECDN=$O(^TMP($J,ECLN,ECDN)) Q:ECDN=""!(ECOUT)  D CATS
"RTN","ECPROV3",21,0)
 K ECPNAM
"RTN","ECPROV3",22,0)
 D FOOTER  ;print footer on last page
"RTN","ECPROV3",23,0)
 Q
"RTN","ECPROV3",24,0)
CATS ; continue looping
"RTN","ECPROV3",25,0)
 I $O(^TMP($J,ECLN,ECDN,""))']"" D PAGE W !!!,?12,"NO PROCEDURES" S ECPG=1 Q
"RTN","ECPROV3",26,0)
 D PAGE Q:ECOUT  S ECPG=1,ECUN=0 F I=0:0 S ECUN=$O(^TMP($J,ECLN,ECDN,ECUN)) Q:ECUN=""!(ECOUT)  S ECINZ="^"_$O(^(ECUN,0)) D:$Y+10>IOSL PAGE Q:ECOUT  D PRO
"RTN","ECPROV3",27,0)
 Q
"RTN","ECPROV3",28,0)
PRO I $Y+13>IOSL D PAGE I ECOUT Q
"RTN","ECPROV3",29,0)
 W !!,ECUN S ECCN=0 F I=0:0 S ECCN=$O(^TMP($J,ECINZ,ECCN)) D:ECCN="" TOTP Q:ECCN=""!(ECOUT)  D MORE
"RTN","ECPROV3",30,0)
 Q
"RTN","ECPROV3",31,0)
MORE ;
"RTN","ECPROV3",32,0)
 ;ALB/ESD - Loop through to get procedure reason and print
"RTN","ECPROV3",33,0)
 W !,?3,ECCN S ECPN=0,(ECPRSN,ECPI)=""
"RTN","ECPROV3",34,0)
 F  S ECPN=$O(^TMP($J,ECINZ,ECCN,ECPN)) Q:ECPN=""!(ECOUT)  S ECUSER=1 D:$Y+10>IOSL PAGE Q:ECOUT  K ECUSER F  S ECPRSN=$O(^TMP($J,ECINZ,ECCN,ECPN,ECPRSN)) Q:ECPRSN=""!(ECOUT)  DO
"RTN","ECPROV3",35,0)
 .S ECCPT=$S($P(ECPN,"~",3)="I":$P(ECPN,"~",2),1:$P($G(^EC(725,$P(ECPN,"~",2),0)),"^",5))
"RTN","ECPROV3",36,0)
 .I ECCPT'="" D
"RTN","ECPROV3",37,0)
 ..;Changes made by VMP to correct NOIS ATG-1003-32545
"RTN","ECPROV3",38,0)
 ..;use end date/date range to get CPT description; CTD project.
"RTN","ECPROV3",39,0)
 ..S ECPI=$$CPT^ICPTCOD(ECCPT,$P(ECED,".")),ECCPT=$P(ECPI,"^",2)
"RTN","ECPROV3",40,0)
 .S EC725="" I $P(ECPN,"~",3)="E" S EC725=$G(^EC(725,+$P(ECPN,"~",2),0))
"RTN","ECPROV3",41,0)
 .S ECPNAM=$S($P(ECPN,"~",3)="E":$P(EC725,"^",2)_" "_$P(EC725,"^"),$P(ECPN,"~",3)="I":$P(ECPI,"^",3),1:"UNKNOWN")
"RTN","ECPROV3",42,0)
 .S ECPSY=$P(ECPN,"~",4),ECPSYN=""
"RTN","ECPROV3",43,0)
 .I ECPSY'="" S ECPSYN=$P($G(^ECJ(ECPSY,"PRO")),"^",2)
"RTN","ECPROV3",44,0)
 .W !,?6,$J(ECCPT_" ",6),$E(ECPNAM,1,40)
"RTN","ECPROV3",45,0)
 .W:ECPSYN'="" " [",$E(ECPSYN,1,25),"]"
"RTN","ECPROV3",46,0)
 .W:$D(ECRY) ?70,ECPRSN
"RTN","ECPROV3",47,0)
 .W ?105,$J(^TMP($J,ECINZ,ECCN,ECPN,ECPRSN),6)
"RTN","ECPROV3",48,0)
 .;print CPT procedure modifiers
"RTN","ECPROV3",49,0)
 .S IEN=""
"RTN","ECPROV3",50,0)
 .F  S IEN=$O(^TMP($J,ECINZ,ECCN,ECPN,ECPRSN,"MOD",IEN)) Q:IEN=""  D  I ECOUT Q
"RTN","ECPROV3",51,0)
 ..;used end date to get description,CTD project
"RTN","ECPROV3",52,0)
 ..S MODI=$$MOD^ICPTMOD(IEN,"I",$P(ECED,"."))
"RTN","ECPROV3",53,0)
 ..S MOD=$P(MODI,"^",2) I MOD="" K MODI Q
"RTN","ECPROV3",54,0)
 ..S MODESC=$P(MODI,"^",3) I MODESC="" S MODESC="UNKNOWN"
"RTN","ECPROV3",55,0)
 ..S MODAMT=^TMP($J,ECINZ,ECCN,ECPN,ECPRSN,"MOD",IEN)
"RTN","ECPROV3",56,0)
 ..W !?10,"- ",MOD," ",MODESC," (",MODAMT,")"
"RTN","ECPROV3",57,0)
 ..I ($Y+6)>IOSL D PAGE
"RTN","ECPROV3",58,0)
 .K MODESC,MOD,IEN,MODAMT,MODI,EC725
"RTN","ECPROV3",59,0)
 Q
"RTN","ECPROV3",60,0)
LOC S (ECDFN,ECOUT,^TMP($J,ECLN))=0
"RTN","ECPROV3",61,0)
 F I=0:0 S ECDFN=$O(^ECH("ADT",ECL,ECDFN)) Q:'ECDFN  D
"RTN","ECPROV3",62,0)
 .I ECPRV D GECD Q
"RTN","ECPROV3",63,0)
 .D GMM
"RTN","ECPROV3",64,0)
 Q
"RTN","ECPROV3",65,0)
GECD S ECD=0 F I=0:0 S ECD=$O(^ECH("ADT",ECL,ECDFN,ECD)) Q:'ECD  D GMM
"RTN","ECPROV3",66,0)
 Q
"RTN","ECPROV3",67,0)
GMM S MM=ECSD F I=0:0 S MM=$O(^ECH("ADT",ECL,ECDFN,ECD,MM)) Q:'MM!(MM>ECED)  D LOC1
"RTN","ECPROV3",68,0)
 Q
"RTN","ECPROV3",69,0)
LOC1 S ECFN=0 F I=0:0 S ECFN=$O(^ECH("ADT",ECL,ECDFN,ECD,MM,ECFN)) Q:'ECFN  D UTL
"RTN","ECPROV3",70,0)
 Q
"RTN","ECPROV3",71,0)
UTL ; set ^TMP($J,"ECPROV"
"RTN","ECPROV3",72,0)
 Q:'$D(^ECH(+ECFN,0))!(+$G(ECD)'=$P($G(^ECH(+ECFN,0)),"^",7))
"RTN","ECPROV3",73,0)
 S ECEC=^ECH(+ECFN,0),ECV=+$P(ECEC,"^",10),ECC=+$P(ECEC,"^",8)
"RTN","ECPROV3",74,0)
 ;S ECP=$P(ECEC,"^",9),ECU=+$P(ECEC,"^",11)
"RTN","ECPROV3",75,0)
 S ECP=$P(ECEC,"^",9),ECU=$$GETPPRV^ECPRVMUT(ECFN,.ECUN),ECUN=$S(ECU:"UNKNOWN",1:$P(ECUN,"^",2))
"RTN","ECPROV3",76,0)
 S ECCN=$S($P($G(^EC(726,ECC,0)),"^")]"":$P(^(0),"^"),1:"None")
"RTN","ECPROV3",77,0)
 Q:ECP']""
"RTN","ECPROV3",78,0)
 S ECD=+$P(ECEC,"^",7)
"RTN","ECPROV3",79,0)
 I ECPRV=1 Q:'$D(ECDU(ECD))  S ECDN=ECDU(ECD)
"RTN","ECPROV3",80,0)
 I ECPRV=2 S ECDN=$S($P($G(^ECD(ECD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPROV3",81,0)
 ;S ECUN=$S($P($G(^VA(200,ECU,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECPROV3",82,0)
 S ECPSY=+$O(^ECJ("AP",ECL,ECD,ECC,ECP,"")),ECPN=""
"RTN","ECPROV3",83,0)
 S ECFILE=$P(ECP,";",2),ECFILE=$S($E(ECFILE)="I":81,$E(ECFILE)="E":725,1:"UNKNOWN")
"RTN","ECPROV3",84,0)
 I ECFILE=81 S ECPN=$P($$CPT^ICPTCOD(+ECP,$P(ECED,".")),"^",3)
"RTN","ECPROV3",85,0)
 I ECFILE=725 S ECPN=$P($G(^EC(725,+ECP,0)),"^")
"RTN","ECPROV3",86,0)
 I ECFILE="UNKNOWN"!(ECPN="") S ECPN="UNKNOWN"
"RTN","ECPROV3",87,0)
 ;Changes made by VMP to correct NOIS SDC-1003-60397
"RTN","ECPROV3",88,0)
 S ECPN=$E(ECPN,1,5)_"~"_$P(ECP,";")_"~"_$E($P(ECP,";",2))_"~"_ECPSY
"RTN","ECPROV3",89,0)
 ;Get Procedure CPT modifiers
"RTN","ECPROV3",90,0)
 S ECMODF=0 K ECMOD
"RTN","ECPROV3",91,0)
 I $O(^ECH(+ECFN,"MOD",0))'="" S ECMODF=$$MOD^ECUTL(+ECFN,"I",.ECMOD)
"RTN","ECPROV3",92,0)
 ;
"RTN","ECPROV3",93,0)
 ;ALB/ESD - Get procedure reason from EC Patient file (#721) record
"RTN","ECPROV3",94,0)
 N ECLNK
"RTN","ECPROV3",95,0)
 S ECPRSN=""
"RTN","ECPROV3",96,0)
 S ECLNK=+$P(ECEC,"^",23)
"RTN","ECPROV3",97,0)
 I +ECLNK>0 DO
"RTN","ECPROV3",98,0)
 .S ECPRSN=$P($G(^ECL(ECLNK,0)),"^",1)
"RTN","ECPROV3",99,0)
 .S:+ECPRSN'>0 ECPRSN="REASON NOT DEFINED"
"RTN","ECPROV3",100,0)
 .S:+ECPRSN>0 ECPRSN=$P(^ECR(ECPRSN,0),"^",1)
"RTN","ECPROV3",101,0)
 S:+ECLNK'>0 ECPRSN="REASON NOT DEFINED"
"RTN","ECPROV3",102,0)
 I '$D(ECRY) S ECPRSN="REASON NOT DEFINED" ;group proc reason-not print
"RTN","ECPROV3",103,0)
 I '$D(^TMP($J,ECLN,ECDN,ECUN)) S ECINC=ECINC+1,ECINZ="^"_ECINC,^(ECUN)=0,^(ECUN,ECINC)=0
"RTN","ECPROV3",104,0)
 S ECINZ="^"_$O(^TMP($J,ECLN,ECDN,ECUN,0))
"RTN","ECPROV3",105,0)
 I '$D(^TMP($J,ECINZ,ECCN)) S ^TMP($J,ECINZ,ECCN)=0
"RTN","ECPROV3",106,0)
 ;
"RTN","ECPROV3",107,0)
 ;ALB/ESD - Add procedure reason to ^TMP array
"RTN","ECPROV3",108,0)
 I '$D(^TMP($J,ECINZ,ECCN,ECPN,ECPRSN)) S ^TMP($J,ECINZ,ECCN,ECPN,ECPRSN)=0
"RTN","ECPROV3",109,0)
 S ^TMP($J,ECLN)=^TMP($J,ECLN)+ECV
"RTN","ECPROV3",110,0)
 S ^TMP($J,ECLN,ECDN,ECUN)=^TMP($J,ECLN,ECDN,ECUN)+ECV
"RTN","ECPROV3",111,0)
 S ^TMP($J,ECINZ,ECCN)=^TMP($J,ECINZ,ECCN)+ECV
"RTN","ECPROV3",112,0)
 ;
"RTN","ECPROV3",113,0)
 ;ALB/ESD - Add procedure reason to ^TMP array
"RTN","ECPROV3",114,0)
 S ^TMP($J,ECINZ,ECCN,ECPN,ECPRSN)=^TMP($J,ECINZ,ECCN,ECPN,ECPRSN)+ECV
"RTN","ECPROV3",115,0)
 ;ALB/JAM - Add Procedure CPT modifier to ^TMP array
"RTN","ECPROV3",116,0)
 S MOD="" F  S MOD=$O(ECMOD(MOD)) Q:MOD=""  D
"RTN","ECPROV3",117,0)
 . S ^TMP($J,ECINZ,ECCN,ECPN,ECPRSN,"MOD",MOD)=$G(^TMP($J,ECINZ,ECCN,ECPN,ECPRSN,"MOD",MOD))+ECV
"RTN","ECPROV3",118,0)
 Q
"RTN","ECPROV3",119,0)
PAGE ; end of page
"RTN","ECPROV3",120,0)
 D:$D(ECPG) FOOTER
"RTN","ECPROV3",121,0)
 I $D(ECPG),$E(IOST,1,2)="C-" W !!,"Press <RET> to continue, or ^ to quit  " R X:DTIME I '$T!(X="^") S ECOUT=1 Q
"RTN","ECPROV3",122,0)
HDR ; print heading
"RTN","ECPROV3",123,0)
 W:$Y @IOF W !!,?49,"EVENT CAPTURE PROVIDER SUMMARY",!,?49,"FROM "_$P(ECDATE,"^")_"  TO "_$P(ECDATE,"^",2),!,?49,"Run Date : ",ECRDT
"RTN","ECPROV3",124,0)
 W !!?3,"Category",!,?6,"CPT Code",?20,"Description"
"RTN","ECPROV3",125,0)
 W:$D(ECRY) ?70,"Procedure Reason"
"RTN","ECPROV3",126,0)
 W ?105,"Volume",!,?10,"CPT Modifier (volume)",!
"RTN","ECPROV3",127,0)
 F LINE=1:1:132 W "-"
"RTN","ECPROV3",128,0)
 W !!,"Location: "_ECLN,! W:ECDN]"" "DSS Unit: "_ECDN
"RTN","ECPROV3",129,0)
 I ECPRV,$D(ECUSER) W !!,ECUN,!,ECCN
"RTN","ECPROV3",130,0)
 Q
"RTN","ECPROV3",131,0)
FOOTER ;print page footer
"RTN","ECPROV3",132,0)
 W !!?4,"Volume totals may represent days, minutes, numbers of procedures"
"RTN","ECPROV3",133,0)
 W !?4,"and/or a combination of these."
"RTN","ECPROV3",134,0)
 Q
"RTN","ECPROV3",135,0)
 ;
"RTN","ECPROV3",136,0)
TOTP Q:ECOUT  W !,?105,"------",!,"Total Procedures for "_ECUN,?105,$J(^TMP($J,ECLN,ECDN,ECUN),6)
"RTN","ECPROV3",137,0)
 Q
"RTN","ECPROV3",138,0)
UNIT ; set units
"RTN","ECPROV3",139,0)
 S CNT=0 F I=0:0 S CNT=$O(UNIT(CNT)) Q:'CNT  S ECDU(+UNIT(CNT))=$P(UNIT(CNT),"^",2)
"RTN","ECPROV3",140,0)
 Q
"RTN","ECPROV3",141,0)
 ;
"RTN","ECPROV3",142,0)
NOUNIT ;Nothing there
"RTN","ECPROV3",143,0)
 I $O(^TMP($J,ECLN,ECDN))']"" D PAGE W !!!,?12,"NO PROCEDURES",! S ECPG=1
"RTN","ECPROV3",144,0)
 Q
"RTN","ECPRSUM1")
0^9^B29801966
"RTN","ECPRSUM1",1,0)
ECPRSUM1 ;BIR/DMA,RHK,JPW - Provider Summary (1 to 7) ;22 Jul 2008
"RTN","ECPRSUM1",2,0)
 ;;2.0; EVENT CAPTURE ;**5,18,33,47,62,63,61,72,88,95**;8 May 96;Build 26
"RTN","ECPRSUM1",3,0)
 S DIC=200,DIC(0)="AQEMZ",DIC("A")="Select Provider: "
"RTN","ECPRSUM1",4,0)
 D ^DIC K DIC G END:Y<0 S ECU=+Y,ECUN=$P(Y,"^",2)
"RTN","ECPRSUM1",5,0)
 D REASON^ECRUTL ;* Prompt to include Procedure Reasons
"RTN","ECPRSUM1",6,0)
 I ($D(DIRUT))!($D(DUOUT)) G END
"RTN","ECPRSUM1",7,0)
BDATE K %DT S %DT="AEX",%DT("A")="Starting with Date: "
"RTN","ECPRSUM1",8,0)
 D ^%DT G:Y<0 END S ECSD=Y
"RTN","ECPRSUM1",9,0)
EDATE K %DT S %DT="AEX",%DT("A")="Ending with Date: " D ^%DT G:Y<0 END
"RTN","ECPRSUM1",10,0)
 I Y<ECSD D  G EDATE
"RTN","ECPRSUM1",11,0)
 .W !!,"The ending date cannot be earlier than the starting date.  "
"RTN","ECPRSUM1",12,0)
 .W "Please re-enter",!,"the ending date.",!
"RTN","ECPRSUM1",13,0)
 S ECED=Y,ECDATE=ECSD_"^"_ECED
"RTN","ECPRSUM1",14,0)
DEV ;dev call
"RTN","ECPRSUM1",15,0)
 W !!,"This report is formatted for 132 column output.",!!
"RTN","ECPRSUM1",16,0)
 S %ZIS="Q",%ZIS("A")="Select Device: " D ^%ZIS G END:POP
"RTN","ECPRSUM1",17,0)
 I $D(IO("Q")) K ZTSAVE S (ZTSAVE("ECRY"),ZTSAVE("ECSD"),ZTSAVE("ECDATE"),ZTSAVE("ECED"),ZTSAVE("ECU"),ZTSAVE("ECUN"))="",ZTDESC="Event Capture Provider Summary",ZTRTN="EN^ECPRSUM1" D ^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","ECPRSUM1",18,0)
 ;
"RTN","ECPRSUM1",19,0)
EN ;QUEUED ENTRY POINT
"RTN","ECPRSUM1",20,0)
 N ECPG,ECGT,EC,ECCAT,ECPXD,MODI,ECI,ECPRV,RK,A,ECX,EC725
"RTN","ECPRSUM1",21,0)
 U IO
"RTN","ECPRSUM1",22,0)
 S (ECOUT,ECPG)=0 F ECI=1:1:7 S ECGT(ECI)=0,A(ECI)=0
"RTN","ECPRSUM1",23,0)
 K ^TMP($J) S ECOUT=0,ECSD=ECSD-.1,ECED=ECED+.3
"RTN","ECPRSUM1",24,0)
 F ECD=ECSD:0 S ECD=$O(^ECH("AC",ECD)) Q:'ECD  Q:ECD>ECED  F DA=0:0 S DA=$O(^ECH("AC",ECD,DA)) Q:'DA  I $D(^ECH("APRV",ECU,DA)) S EC=$G(^ECH(DA,0)) D 
"RTN","ECPRSUM1",25,0)
 .K ECPRV S ECPRV=$$GETPRV^ECPRVMUT(DA,.ECPRV),ECX=0 I ECPRV Q
"RTN","ECPRSUM1",26,0)
 .F ECI=1:1:7 S A(ECI)=0
"RTN","ECPRSUM1",27,0)
 .F ECI=1:1:7 S ECX=$O(ECPRV(ECX)) Q:'ECX  D
"RTN","ECPRSUM1",28,0)
 ..S A(ECI)=$P(ECPRV(ECX),U)=ECU
"RTN","ECPRSUM1",29,0)
 .S ECX=A(1)=A(2)=A(3)=A(4)=A(5)=A(6)=A(7) I 'ECX Q
"RTN","ECPRSUM1",30,0)
 .S ECPAT=+$P(EC,"^",2),PA=$G(^DPT(ECPAT,0)),SS=$P(PA,"^",9)
"RTN","ECPRSUM1",31,0)
 .S PA=$S($P(PA,"^")]"":$P(PA,"^"),1:"UNKNOWN"),ECP=$P(EC,"^",9)
"RTN","ECPRSUM1",32,0)
 .Q:ECP']""
"RTN","ECPRSUM1",33,0)
 .S ECLOC=+$P(EC,U,4),ECUNIT=+$P(EC,U,7),ECCAT=+$P(EC,U,8)
"RTN","ECPRSUM1",34,0)
 .S ECPSY=+$O(^ECJ("AP",ECLOC,ECUNIT,ECCAT,ECP,""))
"RTN","ECPRSUM1",35,0)
 .S ECPSYN=$P($G(^ECJ(ECPSY,"PRO")),"^",2)
"RTN","ECPRSUM1",36,0)
 .S ECFILE=$P(ECP,";",2),ECFILE=$S($E(ECFILE)="I":81,$E(ECFILE)="E":725,1:"UNKNOWN")
"RTN","ECPRSUM1",37,0)
 .I ECFILE="UNKNOWN" S ECPN="UNKNOWN"
"RTN","ECPRSUM1",38,0)
 .S ECCPT=$S(ECFILE=81:+ECP,1:$P($G(^EC(725,+ECP,0)),"^",5)),ECPXD=""
"RTN","ECPRSUM1",39,0)
 .I ECCPT'="" D
"RTN","ECPRSUM1",40,0)
 ..S ECPXD=$$CPT^ICPTCOD(ECCPT,$P(ECED,".")),ECCPT=$P(ECPXD,"^",2)_" "
"RTN","ECPRSUM1",41,0)
 .I ECFILE=81 S ECPN=$S($P(ECPXD,"^",3)]"":$P(ECPXD,"^",3),1:"UNKNOWN")
"RTN","ECPRSUM1",42,0)
 .I ECFILE=725 S EC725=$G(^EC(725,+ECP,0)),ECPN=$P(EC725,"^",2)_" "_$P(EC725,"^")
"RTN","ECPRSUM1",43,0)
 .S ECPTDS=ECCPT_ECPN_$S(ECPSYN]"":" ["_ECPSYN_"] ",1:"")
"RTN","ECPRSUM1",44,0)
 .;Get Procedure CPT modifiers
"RTN","ECPRSUM1",45,0)
 . K ECMOD S ECMODF=0 I $O(^ECH(DA,"MOD",0))'="" D
"RTN","ECPRSUM1",46,0)
 ..S ECMODF=$$MOD^ECUTL(DA,"I",.ECMOD)
"RTN","ECPRSUM1",47,0)
 ..;K ECMOD S ECMODF=$$MOD^ECUTL(DA,"I",.ECMOD)
"RTN","ECPRSUM1",48,0)
 .;
"RTN","ECPRSUM1",49,0)
 .;ALB/ESD - Get procedure reason from EC Patient file (#721) record
"RTN","ECPRSUM1",50,0)
 .S ECPRSN="",ECLNK=+$P(EC,"^",23)
"RTN","ECPRSUM1",51,0)
 .I +ECLNK>0 DO
"RTN","ECPRSUM1",52,0)
 ..S ECPRSN=$P($G(^ECL(ECLNK,0)),"^",1)
"RTN","ECPRSUM1",53,0)
 ..S:+ECPRSN'>0 ECPRSN="REASON NOT DEFINED"
"RTN","ECPRSUM1",54,0)
 ..S:+ECPRSN>0 ECPRSN=$P(^ECR(ECPRSN,0),"^",1)
"RTN","ECPRSUM1",55,0)
 .S:+ECLNK'>0 ECPRSN="REASON NOT DEFINED"
"RTN","ECPRSUM1",56,0)
 .I '$D(ECRY) S ECPRSN="REASON NOT DEFINED"
"RTN","ECPRSUM1",57,0)
 .;
"RTN","ECPRSUM1",58,0)
 .;ALB/ESD - Add procedure reason to ^TMP array
"RTN","ECPRSUM1",59,0)
 .S PRO=ECCPT_ECPN I PRO]"" S V=+$P(EC,"^",10) D
"RTN","ECPRSUM1",60,0)
 ..F J=1:1:7 I A(J) S ^(J)=$G(^TMP($J,PRO,ECPRSN,PA_"^"_SS,J))+V D
"RTN","ECPRSUM1",61,0)
 ...I $G(^TMP($J,PRO))="" S ^TMP($J,PRO)=ECPTDS
"RTN","ECPRSUM1",62,0)
 ..;ALB/JAM - Add Procedure CPT modifier to ^TMP array
"RTN","ECPRSUM1",63,0)
 ..S MOD="" F  S MOD=$O(ECMOD(MOD)) Q:MOD=""  D
"RTN","ECPRSUM1",64,0)
 ...S ^TMP($J,PRO,ECPRSN,PA_"^"_SS,"MOD",MOD)=$G(^TMP($J,PRO,ECPRSN,PA_"^"_SS,"MOD",MOD))+V
"RTN","ECPRSUM1",65,0)
 K ECLNK,MOD,ECPTDS
"RTN","ECPRSUM1",66,0)
 ;
"RTN","ECPRSUM1",67,0)
PRINT ;print report
"RTN","ECPRSUM1",68,0)
 S ECSD=$P(ECDATE,"^"),ECED=$P(ECDATE,"^",2)
"RTN","ECPRSUM1",69,0)
 D HDR I '$D(^TMP($J)) W !!,?12,"No Event Capture Provider Summary for "_ECUN_" to report for the date range selected.",!! D PAGE G END
"RTN","ECPRSUM1",70,0)
 F ECI=1:1:7 S A(ECI)=0
"RTN","ECPRSUM1",71,0)
 S (ECREAS,PA,PR)=""
"RTN","ECPRSUM1",72,0)
 F  S PR=$O(^TMP($J,PR)),PA="" Q:PR=""  D  Q:ECOUT
"RTN","ECPRSUM1",73,0)
 .W !,^TMP($J,PR)
"RTN","ECPRSUM1",74,0)
 .F  S ECREAS=$O(^TMP($J,PR,ECREAS)) Q:ECREAS=""  D  Q:ECOUT
"RTN","ECPRSUM1",75,0)
 ..F  S PA=$O(^TMP($J,PR,ECREAS,PA)) D:PA="" TOT Q:PA=""  D  Q:ECOUT
"RTN","ECPRSUM1",76,0)
 ...S A=$G(^TMP($J,PR,ECREAS,PA,0))
"RTN","ECPRSUM1",77,0)
 ...W ! W:$D(ECRY) $E(ECREAS,1,23)
"RTN","ECPRSUM1",78,0)
 ...W ?25,$E($P(PA,"^"),1,24),?50,$P(PA,"^",2)
"RTN","ECPRSUM1",79,0)
 ...F J=1:1:7 S A=$G(^TMP($J,PR,ECREAS,PA,J)),A(J)=A(J)+A W ?10*J+50,$J(A,5,0) I J=7 I $Y+8>IOSL D PAGE Q:ECOUT  D HDR
"RTN","ECPRSUM1",80,0)
 ...;print CPT procedure modifiers
"RTN","ECPRSUM1",81,0)
 ...Q:ECOUT  S IEN=""
"RTN","ECPRSUM1",82,0)
 ...F  S IEN=$O(^TMP($J,PR,ECREAS,PA,"MOD",IEN)) Q:IEN=""  D  I ECOUT Q
"RTN","ECPRSUM1",83,0)
 ....S MODI=$$MOD^ICPTMOD(IEN,"I",$P(ECED,"."))
"RTN","ECPRSUM1",84,0)
 ....S MOD=$P(MODI,U,2) I MOD="" Q
"RTN","ECPRSUM1",85,0)
 ....S MODESC=$P(MODI,U,3)  I MODESC="" S MODESC="UNKNOWN"
"RTN","ECPRSUM1",86,0)
 ....S MODAMT=^TMP($J,PR,ECREAS,PA,"MOD",IEN)
"RTN","ECPRSUM1",87,0)
 ....W !?5,"- ",MOD," ",MODESC," (",MODAMT,")"
"RTN","ECPRSUM1",88,0)
 ....I ($Y+7)>IOSL D PAGE Q:ECOUT  D HDR
"RTN","ECPRSUM1",89,0)
 ...K MODESC,MOD,MODAMT
"RTN","ECPRSUM1",90,0)
 W !!,?60 F RK=61:1:IOM W "*"
"RTN","ECPRSUM1",91,0)
 W !,?35,"GRAND TOTAL - PROCEDURES"
"RTN","ECPRSUM1",92,0)
 F J=1:1:7 W ?10*J+50,$J(ECGT(J),5,0)
"RTN","ECPRSUM1",93,0)
 D:'ECOUT PAGE G END
"RTN","ECPRSUM1",94,0)
 ;
"RTN","ECPRSUM1",95,0)
PAGE ; end of page
"RTN","ECPRSUM1",96,0)
 D FOOTER
"RTN","ECPRSUM1",97,0)
 I $E(IOST,1,2)="C-" S DIR(0)="E" D ^DIR K DIR I 'Y S ECOUT=1
"RTN","ECPRSUM1",98,0)
 Q
"RTN","ECPRSUM1",99,0)
HDR ;
"RTN","ECPRSUM1",100,0)
 W:$Y @IOF S ECPG=ECPG+1
"RTN","ECPRSUM1",101,0)
 W !!?33,"EVENT CAPTURE PROVIDER SUMMARY FOR ",ECUN,?118,"Page: ",ECPG,!,?33,"FOR THE DATE RANGE ",$$FMTE^XLFDT(ECSD)," TO ",$$FMTE^XLFDT(ECED),!!,"PROCEDURE",?85,"TOTALS AS PROVIDER #",!
"RTN","ECPRSUM1",102,0)
 W:$D(ECRY) "PROCEDURE REASON" W ?25,"PATIENT",?52,"SSN",?64,1,?74,2,?84,3,?94,4,?104,5,?114,6,?124,7
"RTN","ECPRSUM1",103,0)
 W !,?5,"CPT MODIFIER (Volume of modifiers use)",!
"RTN","ECPRSUM1",104,0)
 F RK=1:1:IOM W "-"
"RTN","ECPRSUM1",105,0)
 W !
"RTN","ECPRSUM1",106,0)
 Q
"RTN","ECPRSUM1",107,0)
 ;
"RTN","ECPRSUM1",108,0)
TOT W !,?60 F RK=61:1:IOM W "-"
"RTN","ECPRSUM1",109,0)
 W !?35,"TOTAL PROCEDURES"
"RTN","ECPRSUM1",110,0)
 F J=1:1:7 W ?10*J+50,$J(A(J),5,0) S ECGT(J)=ECGT(J)+A(J)
"RTN","ECPRSUM1",111,0)
 W ! F ECI=1:1:7 S A(ECI)=0
"RTN","ECPRSUM1",112,0)
 Q
"RTN","ECPRSUM1",113,0)
 ;
"RTN","ECPRSUM1",114,0)
FOOTER ;print page footer
"RTN","ECPRSUM1",115,0)
 W !!?4,"Volume totals may represent days, minutes, numbers of procedures"
"RTN","ECPRSUM1",116,0)
 W !?4,"and/or a combination of these."
"RTN","ECPRSUM1",117,0)
 Q
"RTN","ECPRSUM1",118,0)
 ;
"RTN","ECPRSUM1",119,0)
END D ^ECKILL K ^TMP($J),ZTSK W @IOF
"RTN","ECPRSUM1",120,0)
 K ^TMP($J) Q:$D(ECGUI)
"RTN","ECPRSUM1",121,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","ECPRSUM1",122,0)
 D ^%ZISC
"RTN","ECPRSUM1",123,0)
 Q
"RTN","ECRDSSA")
0^10^B100885193
"RTN","ECRDSSA",1,0)
ECRDSSA ;ALB/RPM - DSS Unit Activity Report ; 2 Sep 2008
"RTN","ECRDSSA",2,0)
 ;;2.0; EVENT CAPTURE ;**95**;8 May 96;Build 26
"RTN","ECRDSSA",3,0)
 ;
"RTN","ECRDSSA",4,0)
EN ;Get location(s), DSS Unit(s), sort type, start & end dates, device
"RTN","ECRDSSA",5,0)
 ;
"RTN","ECRDSSA",6,0)
 N ECLOC,ECDSSU,ECSRT,ECSTDT,ECENDDT
"RTN","ECRDSSA",7,0)
 I '$$ASKLOC^ECRUTL G ENQ
"RTN","ECRDSSA",8,0)
 I '$$ASKDSS^ECRUTL G ENQ
"RTN","ECRDSSA",9,0)
 I '$$ASKSRT(.ECSORT) G ENQ
"RTN","ECRDSSA",10,0)
 I '$$STDT^ECRUTL G ENQ
"RTN","ECRDSSA",11,0)
 I '$$ENDDT^ECRUTL(ECSTDT) G ENQ
"RTN","ECRDSSA",12,0)
 I $$ASKDEV D STRPT^ECRDSSA
"RTN","ECRDSSA",13,0)
ENQ Q
"RTN","ECRDSSA",14,0)
 ;
"RTN","ECRDSSA",15,0)
STRPT ;Main entry point
"RTN","ECRDSSA",16,0)
 N ECCRT  ;is CRT?
"RTN","ECRDSSA",17,0)
 N ECPAGE  ;page cnt
"RTN","ECRDSSA",18,0)
 S ECPAGE=0
"RTN","ECRDSSA",19,0)
 S ECCRT=$S($E(IOST,1,2)="C-":1,1:0)
"RTN","ECRDSSA",20,0)
 U IO
"RTN","ECRDSSA",21,0)
 K ^TMP("ECRPT",$J)
"RTN","ECRDSSA",22,0)
 D FNDREC(ECSORT)
"RTN","ECRDSSA",23,0)
 D PRINT(ECSORT)
"RTN","ECRDSSA",24,0)
 K ^TMP("ECRPT",$J)
"RTN","ECRDSSA",25,0)
 Q
"RTN","ECRDSSA",26,0)
 ;
"RTN","ECRDSSA",27,0)
FNDREC(ECSRT) ;Loop through "ADT" xref of EVENT CAPTURE PATIENT (#721) file
"RTN","ECRDSSA",28,0)
 ;  Input:
"RTN","ECRDSSA",29,0)
 ;    ECSRT - sort type
"RTN","ECRDSSA",30,0)
 ;
"RTN","ECRDSSA",31,0)
 ;  Output: none
"RTN","ECRDSSA",32,0)
 ;
"RTN","ECRDSSA",33,0)
 N ECNT   ;record cnt
"RTN","ECRDSSA",34,0)
 N ECL     ;location cnt
"RTN","ECRDSSA",35,0)
 N ECD     ;DSS unit cnt
"RTN","ECRDSSA",36,0)
 N ECDFN   ;DFN
"RTN","ECRDSSA",37,0)
 N ECLOCF  ;Location IEN
"RTN","ECRDSSA",38,0)
 N ECDSSF  ;DSS unit IEN
"RTN","ECRDSSA",39,0)
 N ECDT    ;date index
"RTN","ECRDSSA",40,0)
 N ECREC   ;"0" node
"RTN","ECRDSSA",41,0)
 S ECNT=0
"RTN","ECRDSSA",42,0)
 ;
"RTN","ECRDSSA",43,0)
 S ECL=0
"RTN","ECRDSSA",44,0)
 F  S ECL=$O(ECLOC(ECL)) Q:'ECL  S ECLOCF=+$P(ECLOC(ECL),U) D
"RTN","ECRDSSA",45,0)
 . S ^TMP("ECRPT",$J,ECLOCF)=0  ;initialize location counter
"RTN","ECRDSSA",46,0)
 . S ECD=0
"RTN","ECRDSSA",47,0)
 . F  S ECD=$O(ECDSSU(ECD)) Q:'ECD  S ECDSSF=+$P(ECDSSU(ECD),U) D
"RTN","ECRDSSA",48,0)
 . . S ^TMP("ECRPT",$J,ECLOCF,ECDSSF)=0  ;initialize DSS Unit counter
"RTN","ECRDSSA",49,0)
 . S ECDFN=0
"RTN","ECRDSSA",50,0)
 . F  S ECDFN=+$O(^ECH("ADT",ECLOCF,ECDFN)) Q:'ECDFN  D
"RTN","ECRDSSA",51,0)
 . . S ECD=0
"RTN","ECRDSSA",52,0)
 . . F  S ECD=$O(ECDSSU(ECD)) Q:'ECD  S ECDSSF=+$P(ECDSSU(ECD),U) D
"RTN","ECRDSSA",53,0)
 . . . S ECDT=ECSTDT
"RTN","ECRDSSA",54,0)
 . . . F  S ECDT=+$O(^ECH("ADT",ECLOCF,ECDFN,ECDSSF,ECDT)) Q:'ECDT!(ECDT>ECENDDT)  D
"RTN","ECRDSSA",55,0)
 . . . . S ECIEN=0
"RTN","ECRDSSA",56,0)
 . . . . F  S ECIEN=+$O(^ECH("ADT",ECLOCF,ECDFN,ECDSSF,ECDT,ECIEN)) Q:'ECIEN  D
"RTN","ECRDSSA",57,0)
 . . . . . I $P($G(^ECH(ECIEN,0)),U,7)=ECDSSF D BLDTMP(ECIEN,ECSRT,.ECNT)
"RTN","ECRDSSA",58,0)
 Q
"RTN","ECRDSSA",59,0)
 ;
"RTN","ECRDSSA",60,0)
BLDTMP(ECIEN,ECSRT,ECCNT) ;add record to list
"RTN","ECRDSSA",61,0)
 ;  Input:
"RTN","ECRDSSA",62,0)
 ;    ECIEN - pointer to EVENT CAPTURE PATIENT (#721) file
"RTN","ECRDSSA",63,0)
 ;    ECSRT - sort type
"RTN","ECRDSSA",64,0)
 ;    ECCNT - record counter
"RTN","ECRDSSA",65,0)
 ;
"RTN","ECRDSSA",66,0)
 ;  Output:
"RTN","ECRDSSA",67,0)
 ;    ^TMP("ECRPT",$J,location,DSS unit,sort key1,sort key2,count)
"RTN","ECRDSSA",68,0)
 ;
"RTN","ECRDSSA",69,0)
 N ECLOCA  ;location
"RTN","ECRDSSA",70,0)
 N ECDSS  ;DSS unit
"RTN","ECRDSSA",71,0)
 N ECIENS  ;IENS
"RTN","ECRDSSA",72,0)
 N ECKEY  ;sort key array
"RTN","ECRDSSA",73,0)
 N ECREC  ;record string
"RTN","ECRDSSA",74,0)
 N ECERR  ;FM error
"RTN","ECRDSSA",75,0)
 I +$G(ECIEN)>0,$$GETKEYS(ECSRT,ECIEN,.ECKEY) D
"RTN","ECRDSSA",76,0)
 . S ECCNT=+$G(ECCNT)+1
"RTN","ECRDSSA",77,0)
 . S ECIENS=ECIEN_","
"RTN","ECRDSSA",78,0)
 . S ECREC=""
"RTN","ECRDSSA",79,0)
 . D GETS^DIQ(721,ECIENS,"1;2;3;6;8;9;10;20;29","IE","ECREC","ECERR")
"RTN","ECRDSSA",80,0)
 . S ECLOCA=+$G(ECREC(721,ECIENS,3,"I"))
"RTN","ECRDSSA",81,0)
 . S ECDSS=+$G(ECREC(721,ECIENS,6,"I"))
"RTN","ECRDSSA",82,0)
 . S ECREC=ECREC_$E($G(ECREC(721,ECIENS,1,"E")),1,30)_"^"  ;pt name
"RTN","ECRDSSA",83,0)
 . S ECREC=ECREC_$E($$GETSSN(ECIEN),1,10)_"^"              ;ssn
"RTN","ECRDSSA",84,0)
 . S ECREC=ECREC_$E($G(ECREC(721,ECIENS,29,"I")),1)_"^"    ;in/out
"RTN","ECRDSSA",85,0)
 . S ECREC=ECREC_$E($G(ECREC(721,ECIENS,2,"I")),1,13)_"^"  ;dt/tm
"RTN","ECRDSSA",86,0)
 . S ECREC=ECREC_$E($$GETPROC($G(ECREC(721,ECIENS,8,"I"))),1,5)_"^"   ;proc code
"RTN","ECRDSSA",87,0)
 . S ECREC=ECREC_$E($$GETPRNM($G(ECREC(721,ECIENS,8,"I"))),1,10)_"^"  ;proc name
"RTN","ECRDSSA",88,0)
 . S ECREC=ECREC_$E($G(ECREC(721,ECIENS,9,"I")),1,2)_"^"   ;vol
"RTN","ECRDSSA",89,0)
 . S ECREC=ECREC_$E($$GETPROV(ECIEN),1,30)_"^"  ;provider
"RTN","ECRDSSA",90,0)
 . S ECREC=ECREC_$E($G(ECREC(721,ECIENS,20,"E")),1,7)      ;dx
"RTN","ECRDSSA",91,0)
 . S ^TMP("ECRPT",$J,ECLOCA,ECDSS,ECKEY(1),ECKEY(2),ECNT)=ECREC
"RTN","ECRDSSA",92,0)
 . S ^TMP("ECRPT",$J,ECLOCA)=$G(^TMP("ECRPT",$J,ECLOCA))+1
"RTN","ECRDSSA",93,0)
 . S ^TMP("ECRPT",$J,ECLOCA,ECDSS)=$G(^TMP("ECRPT",$J,ECLOCA,ECDSS))+1
"RTN","ECRDSSA",94,0)
 Q
"RTN","ECRDSSA",95,0)
 ;
"RTN","ECRDSSA",96,0)
PRINT(ECSRT) ;loop results array and format output
"RTN","ECRDSSA",97,0)
 ;  Input:
"RTN","ECRDSSA",98,0)
 ;    ECSRT - sort type
"RTN","ECRDSSA",99,0)
 ;
"RTN","ECRDSSA",100,0)
 ;  Output: none
"RTN","ECRDSSA",101,0)
 ;
"RTN","ECRDSSA",102,0)
 N ECCLOC  ;current location
"RTN","ECRDSSA",103,0)
 N ECPLOC  ;previous location
"RTN","ECRDSSA",104,0)
 N ECLOCNM  ;location name
"RTN","ECRDSSA",105,0)
 N ECCDSS  ;current DSS unit
"RTN","ECRDSSA",106,0)
 N ECPDSS  ;previous DSS unit
"RTN","ECRDSSA",107,0)
 N ECDSSNM  ;DSS unit name
"RTN","ECRDSSA",108,0)
 N ECCNT   ;record count
"RTN","ECRDSSA",109,0)
 N ECDAT   ;procedure date/time
"RTN","ECRDSSA",110,0)
 N ECRDT   ;run date
"RTN","ECRDSSA",111,0)
 N ECFDT   ;from date
"RTN","ECRDSSA",112,0)
 N ECTDT   ;to date
"RTN","ECRDSSA",113,0)
 N ECKEY1  ;sort key 1
"RTN","ECRDSSA",114,0)
 N ECKEY2  ;sort key 2
"RTN","ECRDSSA",115,0)
 N ECSRTBY  ;sort type text
"RTN","ECRDSSA",116,0)
 N ECQUIT  ;user quit indicator
"RTN","ECRDSSA",117,0)
 N ECREC   ;tmp record data
"RTN","ECRDSSA",118,0)
 I '$D(^TMP("ECRPT",$J)) G PRINTQ
"RTN","ECRDSSA",119,0)
 S ECRDT=$$FMTE^XLFDT($$NOW^XLFDT,"5DZ")
"RTN","ECRDSSA",120,0)
 S ECFDT=$$FMTE^XLFDT($P(ECSTDT+.0001,"."),"5DZ")
"RTN","ECRDSSA",121,0)
 S ECTDT=$$FMTE^XLFDT($P(ECENDDT,"."),"5DZ")
"RTN","ECRDSSA",122,0)
 S ECSRTBY=$S(ECSRT="P":"Patient Name",ECSRT="R":"Provider Name",ECSRT="S":"Patient SSN",1:"")
"RTN","ECRDSSA",123,0)
 S (ECCLOC,ECPLOC,ECQUIT)=0
"RTN","ECRDSSA",124,0)
 F  S ECCLOC=$O(^TMP("ECRPT",$J,ECCLOC)) Q:'ECCLOC!(ECQUIT)  D
"RTN","ECRDSSA",125,0)
 . I ECCLOC'=ECPLOC D  ;location changed
"RTN","ECRDSSA",126,0)
 . . S ECPLOC=ECCLOC
"RTN","ECRDSSA",127,0)
 . . S ECLOCNM=$$GETLOCN(ECCLOC,.ECLOC)
"RTN","ECRDSSA",128,0)
 . . I $O(^TMP("ECRPT",$J,ECCLOC,0))>0 D:ECPAGE>0 PAUSE Q:ECQUIT  D HDR(ECLOCNM,ECRDT,ECFDT,ECTDT,ECSRTBY)
"RTN","ECRDSSA",129,0)
 . I $G(^TMP("ECRPT",$J,ECCLOC))=0 D  Q
"RTN","ECRDSSA",130,0)
 . . W !!,"    ** No records found on Location that match selection criteria"
"RTN","ECRDSSA",131,0)
 . S (ECCDSS,ECPDSS)=0
"RTN","ECRDSSA",132,0)
 . F  S ECCDSS=$O(^TMP("ECRPT",$J,ECCLOC,ECCDSS)) Q:'ECCDSS!(ECQUIT)  D
"RTN","ECRDSSA",133,0)
 . . I ECCDSS'=ECPDSS D  Q:ECQUIT  ;dss unit changed
"RTN","ECRDSSA",134,0)
 . . . S ECPDSS=ECCDSS
"RTN","ECRDSSA",135,0)
 . . . S ECDSSNM=$$GETDSSN(ECCDSS,.ECDSSU)
"RTN","ECRDSSA",136,0)
 . . . I $Y>(IOSL-10) D PAUSE Q:ECQUIT  D HDR(ECLOCNM,ECRDT,ECFDT,ECTDT,ECSRTBY)
"RTN","ECRDSSA",137,0)
 . . . D DSSHDR(ECCDSS,ECDSSNM)
"RTN","ECRDSSA",138,0)
 . . I $G(^TMP("ECRPT",$J,ECCLOC,ECCDSS))=0 D  Q
"RTN","ECRDSSA",139,0)
 . . . W !,"** No records found on DSS Unit that match selection criteria"
"RTN","ECRDSSA",140,0)
 . . S ECKEY1=""
"RTN","ECRDSSA",141,0)
 . . F  S ECKEY1=$O(^TMP("ECRPT",$J,ECCLOC,ECCDSS,ECKEY1)) Q:ECKEY1=""!(ECQUIT)  D
"RTN","ECRDSSA",142,0)
 . . . S ECKEY2=""
"RTN","ECRDSSA",143,0)
 . . . F  S ECKEY2=$O(^TMP("ECRPT",$J,ECCLOC,ECCDSS,ECKEY1,ECKEY2)) Q:ECKEY2=""!(ECQUIT)  D
"RTN","ECRDSSA",144,0)
 . . . . S ECCNT=0
"RTN","ECRDSSA",145,0)
 . . . . F  S ECCNT=$O(^TMP("ECRPT",$J,ECCLOC,ECCDSS,ECKEY1,ECKEY2,ECCNT)) Q:'ECCNT!(ECQUIT)  D
"RTN","ECRDSSA",146,0)
 . . . . . I $Y>(IOSL-7) D PAUSE Q:ECQUIT  D HDR(ECLOCNM,ECRDT,ECFDT,ECTDT,ECSRTBY),DSSHDR(ECCDSS,ECDSSNM) W " (cont'd)"
"RTN","ECRDSSA",147,0)
 . . . . . S ECREC=^TMP("ECRPT",$J,ECCLOC,ECCDSS,ECKEY1,ECKEY2,ECCNT)
"RTN","ECRDSSA",148,0)
 . . . . . W !,$P(ECREC,U,1)  ;name
"RTN","ECRDSSA",149,0)
 . . . . . W ?31,$P(ECREC,U,2)  ;ssn
"RTN","ECRDSSA",150,0)
 . . . . . W ?42,$P(ECREC,U,3)  ;inpt/outpt
"RTN","ECRDSSA",151,0)
 . . . . . S ECDAT=$$FMTE^XLFDT($P(ECREC,U,4),"2MZ")
"RTN","ECRDSSA",152,0)
 . . . . . W ?44,$P(ECDAT,":")_$P(ECDAT,":",2)  ;dt/tm
"RTN","ECRDSSA",153,0)
 . . . . . W ?58,$P(ECREC,U,5)  ;proc code
"RTN","ECRDSSA",154,0)
 . . . . . W ?64,$P(ECREC,U,6)  ;proc name
"RTN","ECRDSSA",155,0)
 . . .  .. W ?75,$P(ECREC,U,7)  ;vol
"RTN","ECRDSSA",156,0)
 . . . . . W ?78,$P(ECREC,U,8)  ;provider
"RTN","ECRDSSA",157,0)
 . . . . . W ?109,$P(ECREC,U,9)  ;dx
"RTN","ECRDSSA",158,0)
 I 'ECQUIT D PAUSE
"RTN","ECRDSSA",159,0)
PRINTQ Q
"RTN","ECRDSSA",160,0)
 ;
"RTN","ECRDSSA",161,0)
HDR(ECLOCN,ECRDT,ECFDT,ECTDT,ECSRT) ;Report header
"RTN","ECRDSSA",162,0)
 ;  Input:
"RTN","ECRDSSA",163,0)
 ;    ECLOCN - location name
"RTN","ECRDSSA",164,0)
 ;    ECRDT - run date
"RTN","ECRDSSA",165,0)
 ;    EDFDT - from date
"RTN","ECRDSSA",166,0)
 ;    EDTDT - to date
"RTN","ECRDSSA",167,0)
 ;    ECSRT - sort text
"RTN","ECRDSSA",168,0)
 ;
"RTN","ECRDSSA",169,0)
 ;  Output:  none
"RTN","ECRDSSA",170,0)
 ;
"RTN","ECRDSSA",171,0)
 I ECCRT!(ECPAGE) W @IOF
"RTN","ECRDSSA",172,0)
 S ECPAGE=ECPAGE+1
"RTN","ECRDSSA",173,0)
 W !,?11,"EVENT CAPTURE DSS UNIT ACTIVITY REPORT"
"RTN","ECRDSSA",174,0)
 W ?58,"Run Date: ",ECRDT
"RTN","ECRDSSA",175,0)
 W ?109,"Page: ",ECPAGE
"RTN","ECRDSSA",176,0)
 W !!,?13,"For Location ",ECLOCN
"RTN","ECRDSSA",177,0)
 W !,?13,"From "_ECFDT_" through "_ECTDT
"RTN","ECRDSSA",178,0)
 W !,?13,"Sorted by ",ECSRT
"RTN","ECRDSSA",179,0)
 W !!?4,"Patient",?31,"SSN",?40,"I/O",?45,"Date/Time",?58,"Proc",?64,"Procedure",?75,"Vol",?80,"Primary",?109,"Primary"
"RTN","ECRDSSA",180,0)
 W !?58,"Code",?64,"Name",?80,"Provider",?109,"Diagnosis"
"RTN","ECRDSSA",181,0)
 Q
"RTN","ECRDSSA",182,0)
 ;
"RTN","ECRDSSA",183,0)
DSSHDR(ECDSS,ECDSSNM) ;DSS header
"RTN","ECRDSSA",184,0)
 ;  Input:
"RTN","ECRDSSA",185,0)
 ;    ECDSS - DSS unit
"RTN","ECRDSSA",186,0)
 ;    ECDSSNM - DSS unit name
"RTN","ECRDSSA",187,0)
 ;
"RTN","ECRDSSA",188,0)
 ;  Output:  none
"RTN","ECRDSSA",189,0)
 ;
"RTN","ECRDSSA",190,0)
 W !!,"DSS Unit: ",ECDSSNM," (IEN #",ECDSS,")"
"RTN","ECRDSSA",191,0)
 Q
"RTN","ECRDSSA",192,0)
 ;
"RTN","ECRDSSA",193,0)
PAUSE ;page break
"RTN","ECRDSSA",194,0)
 N DIR,DIRUT,DUOUT
"RTN","ECRDSSA",195,0)
 D FOOTER
"RTN","ECRDSSA",196,0)
 Q:'ECCRT
"RTN","ECRDSSA",197,0)
 I IOSL<30 F  W ! Q:$Y>(IOSL-7)
"RTN","ECRDSSA",198,0)
 W !
"RTN","ECRDSSA",199,0)
 S DIR(0)="E"
"RTN","ECRDSSA",200,0)
 D ^DIR
"RTN","ECRDSSA",201,0)
 I $D(DIRUT)!($D(DUOUT)) S ECQUIT=1
"RTN","ECRDSSA",202,0)
 Q
"RTN","ECRDSSA",203,0)
 ;
"RTN","ECRDSSA",204,0)
FOOTER ;page footer
"RTN","ECRDSSA",205,0)
 W !!?4,"Volume totals may represent days, minutes, numbers of procedures"
"RTN","ECRDSSA",206,0)
 W !?4,"and/or a combination of these."
"RTN","ECRDSSA",207,0)
 Q
"RTN","ECRDSSA",208,0)
 ;
"RTN","ECRDSSA",209,0)
GETLOCN(ECLOCA,ECLOC) ;get location name
"RTN","ECRDSSA",210,0)
 ;  Input:
"RTN","ECRDSSA",211,0)
 ;    ECLOCA - location
"RTN","ECRDSSA",212,0)
 ;    ECLOC - array of selected locations
"RTN","ECRDSSA",213,0)
 ;
"RTN","ECRDSSA",214,0)
 ;  Output:
"RTN","ECRDSSA",215,0)
 ;   Function value - returns location name on success; "" on failure
"RTN","ECRDSSA",216,0)
 ;
"RTN","ECRDSSA",217,0)
 N ECI
"RTN","ECRDSSA",218,0)
 N ECLOCNM
"RTN","ECRDSSA",219,0)
 S ECLOCNM=""
"RTN","ECRDSSA",220,0)
 I +$G(ECLOCA)>0 D
"RTN","ECRDSSA",221,0)
 . S ECI=0
"RTN","ECRDSSA",222,0)
 . F  S ECI=$O(ECLOC(ECI)) Q:'ECI!(ECLOCNM'="")  D
"RTN","ECRDSSA",223,0)
 . . I $P(ECLOC(ECI),U)=ECLOCA S ECLOCNM=$P(ECLOC(ECI),U,2)
"RTN","ECRDSSA",224,0)
 Q ECLOCNM
"RTN","ECRDSSA",225,0)
 ;
"RTN","ECRDSSA",226,0)
GETDSSN(ECDSS,ECDSSU) ;-get DSS unit name
"RTN","ECRDSSA",227,0)
 ;  Input:
"RTN","ECRDSSA",228,0)
 ;    ECDSS - DSS unit
"RTN","ECRDSSA",229,0)
 ;    ECDSSU - array of selected DSS units
"RTN","ECRDSSA",230,0)
 ;
"RTN","ECRDSSA",231,0)
 ;  Output:
"RTN","ECRDSSA",232,0)
 ;   Function value - returns DSS unit name on success; "" on failure
"RTN","ECRDSSA",233,0)
 ;
"RTN","ECRDSSA",234,0)
 N ECI
"RTN","ECRDSSA",235,0)
 N ECDSSNM
"RTN","ECRDSSA",236,0)
 S ECDSSNM=""
"RTN","ECRDSSA",237,0)
 I +$G(ECDSS)>0 D
"RTN","ECRDSSA",238,0)
 . S ECI=0
"RTN","ECRDSSA",239,0)
 . F  S ECI=$O(ECDSSU(ECI)) Q:'ECI!(ECDSSNM'="")  D
"RTN","ECRDSSA",240,0)
 . . I $P(ECDSSU(ECI),U)=ECDSS S ECDSSNM=$P(ECDSSU(ECI),U,2)
"RTN","ECRDSSA",241,0)
 Q ECDSSNM
"RTN","ECRDSSA",242,0)
 ;
"RTN","ECRDSSA",243,0)
GETKEYS(ECSRT,ECIEN,ECKEYS) ;get sort keys based on sort type
"RTN","ECRDSSA",244,0)
 ;  Input:
"RTN","ECRDSSA",245,0)
 ;    ECSRT - (required) sort type indicator (P, S, R)
"RTN","ECRDSSA",246,0)
 ;    ECIEN - (required) pointer to EVENT CAPTURE PATIENT (#721) file
"RTN","ECRDSSA",247,0)
 ;    
"RTN","ECRDSSA",248,0)
 ;  Output:
"RTN","ECRDSSA",249,0)
 ;    ECKEYS - (pass by reference) array of sort keys
"RTN","ECRDSSA",250,0)
 ;    Function value - returns 1 on success;0 on failure
"RTN","ECRDSSA",251,0)
 ;
"RTN","ECRDSSA",252,0)
 N ECRSLT  ;function value
"RTN","ECRDSSA",253,0)
 S ECRSLT=0
"RTN","ECRDSSA",254,0)
 S (ECKEYS(1),ECKEYS(2))=""
"RTN","ECRDSSA",255,0)
 I $G(ECSRT)'="",+$G(ECIEN)>0 D
"RTN","ECRDSSA",256,0)
 . I ECSRT="P" D
"RTN","ECRDSSA",257,0)
 . . S ECKEYS(1)=$$GET1^DIQ(721,ECIEN_",",1)  ;name
"RTN","ECRDSSA",258,0)
 . . S ECKEYS(2)=$E($$GETSSN(ECIEN),1,9)  ;ssn
"RTN","ECRDSSA",259,0)
 . I ECSRT="R" D
"RTN","ECRDSSA",260,0)
 . . S ECKEYS(1)=$$GETPROV(ECIEN)  ;provider
"RTN","ECRDSSA",261,0)
 . . I ECKEYS(1)="" S ECKEYS(1)=" "  ;missing provider sorts to top
"RTN","ECRDSSA",262,0)
 . . S ECKEYS(2)=$$GET1^DIQ(721,ECIEN_",",1)  ;name
"RTN","ECRDSSA",263,0)
 . I ECSRT="S" D
"RTN","ECRDSSA",264,0)
 . . S ECKEYS(1)=$E($$GETSSN(ECIEN),1,9)  ;ssn
"RTN","ECRDSSA",265,0)
 . . S ECKEYS(2)=$$GET1^DIQ(721,ECIEN_",",1)  ;name
"RTN","ECRDSSA",266,0)
 . I ECKEYS(1)'="",ECKEYS(2)'="" S ECRSLT=1
"RTN","ECRDSSA",267,0)
 Q ECRSLT
"RTN","ECRDSSA",268,0)
 ;
"RTN","ECRDSSA",269,0)
GETSSN(ECIEN) ;get patient SSN
"RTN","ECRDSSA",270,0)
 ;  Input:
"RTN","ECRDSSA",271,0)
 ;    ECIEN - (required) pointer to EVENT CAPTURE PATIENT (#721) file
"RTN","ECRDSSA",272,0)
 ;    
"RTN","ECRDSSA",273,0)
 ;  Output:
"RTN","ECRDSSA",274,0)
 ;    Function value - returns patient's SSN on success; "" on failure
"RTN","ECRDSSA",275,0)
 ;
"RTN","ECRDSSA",276,0)
 N DFN,VADM,VAERR  ;VADPT variables
"RTN","ECRDSSA",277,0)
 I +$G(ECIEN)>0 D
"RTN","ECRDSSA",278,0)
 . S DFN=$$GET1^DIQ(721,ECIEN_",",1,"I")
"RTN","ECRDSSA",279,0)
 . D DEM^VADPT
"RTN","ECRDSSA",280,0)
 Q $P($G(VADM(2)),U)
"RTN","ECRDSSA",281,0)
 ;
"RTN","ECRDSSA",282,0)
GETPROV(ECIEN) ;get primary provider
"RTN","ECRDSSA",283,0)
 ;This function retrieves the primary provider for a given Event
"RTN","ECRDSSA",284,0)
 ;Capture record.  Searches the PROVIDER MULTIPLE (#42) field first
"RTN","ECRDSSA",285,0)
 ;and falls back to the PROVIDER (#10) field.
"RTN","ECRDSSA",286,0)
 ;  Input:
"RTN","ECRDSSA",287,0)
 ;    ECIEN -(required) pointer to EVENT CAPTURE PATIENT (#721) file
"RTN","ECRDSSA",288,0)
 ;
"RTN","ECRDSSA",289,0)
 ;  Output:
"RTN","ECRDSSA",290,0)
 ;   Function value - returns provider's name on success; "" on failure
"RTN","ECRDSSA",291,0)
 ;
"RTN","ECRDSSA",292,0)
 N ECPROV  ;provider name
"RTN","ECRDSSA",293,0)
 S ECPROV=""
"RTN","ECRDSSA",294,0)
 I $G(ECIEN)'="",$D(^ECH(ECIEN)) D
"RTN","ECRDSSA",295,0)
 . ;try PROVIDER MULTIPLE
"RTN","ECRDSSA",296,0)
 . I '$$GETPPRV^ECPRVMUT(ECIEN,.ECPROV) D  ;api returns "0" on success
"RTN","ECRDSSA",297,0)
 . . S ECPROV=$P(ECPROV,U,2)
"RTN","ECRDSSA",298,0)
 . E  D  ;try PROVIDER
"RTN","ECRDSSA",299,0)
 . . S ECPROV=$$GET1^DIQ(721,ECIEN_",",10)
"RTN","ECRDSSA",300,0)
 Q ECPROV
"RTN","ECRDSSA",301,0)
 ;
"RTN","ECRDSSA",302,0)
GETPRNM(ECVIEN) ;get procedure name
"RTN","ECRDSSA",303,0)
 ;  Input:
"RTN","ECRDSSA",304,0)
 ;    ECVIEN - variable pointer to CPT (#81) file or EC PROC file
"RTN","ECRDSSA",305,0)
 ;    
"RTN","ECRDSSA",306,0)
 ;  Output:
"RTN","ECRDSSA",307,0)
 ;    Function value - returns procedure name on success; "" on failure
"RTN","ECRDSSA",308,0)
 ;
"RTN","ECRDSSA",309,0)
 N ECIEN   ;IEN part of variable pointer
"RTN","ECRDSSA",310,0)
 N ECFILE  ;file part of variable pointer
"RTN","ECRDSSA",311,0)
 S ECIEN=$P(ECVIEN,";",1)
"RTN","ECRDSSA",312,0)
 S ECFILE=$P(ECVIEN,";",2)
"RTN","ECRDSSA",313,0)
 Q $S(ECFILE["ICPT(":$$GET1^DIQ(81,ECIEN_",",2),ECFILE["EC(725":$$GET1^DIQ(725,ECIEN_",",.01),1:"")
"RTN","ECRDSSA",314,0)
 ;
"RTN","ECRDSSA",315,0)
GETPROC(ECVIEN) ;get procedure code
"RTN","ECRDSSA",316,0)
 ;  Input:
"RTN","ECRDSSA",317,0)
 ;    ECVIEN - varialbe pointer to CPT (#81) file or EC PROC file
"RTN","ECRDSSA",318,0)
 ;
"RTN","ECRDSSA",319,0)
 ;  Output:
"RTN","ECRDSSA",320,0)
 ;   Function value - returns procedure code on success; "" on failure
"RTN","ECRDSSA",321,0)
 ;
"RTN","ECRDSSA",322,0)
 N ECIEN  ;IEN part of variable pointer
"RTN","ECRDSSA",323,0)
 N ECFILE  ;file part of variable pointer
"RTN","ECRDSSA",324,0)
 S ECIEN=$P(ECVIEN,";",1)
"RTN","ECRDSSA",325,0)
 S ECFILE=$P(ECVIEN,";",2)
"RTN","ECRDSSA",326,0)
 Q $S(ECFILE["ICPT(":$$GET1^DIQ(81,ECIEN_",",.01),ECFILE["EC(725":$$GET1^DIQ(725,ECIEN_",",1),1:"")
"RTN","ECRDSSA",327,0)
 ;
"RTN","ECRDSSA",328,0)
ASKSRT(ECTYP) ;Ask report sort type
"RTN","ECRDSSA",329,0)
 ;  Input:  none
"RTN","ECRDSSA",330,0)
 ;  
"RTN","ECRDSSA",331,0)
 ;  Output:
"RTN","ECRDSSA",332,0)
 ;    ECTYP - (pass by reference) Sort type
"RTN","ECRDSSA",333,0)
 ;            (P: Patient Name,S: SSN,R: Provider Name)
"RTN","ECRDSSA",334,0)
 ;    Function value - returns 1 on success; 0 on failure
"RTN","ECRDSSA",335,0)
 ;
"RTN","ECRDSSA",336,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y  ;^DIR variables
"RTN","ECRDSSA",337,0)
 S DIR(0)="SA^P:PATIENT NAME;S:SSN;R:PROVIDER NAME"
"RTN","ECRDSSA",338,0)
 S DIR("A")="Sort within each DSS Unit by: "
"RTN","ECRDSSA",339,0)
 S DIR("B")="SSN"
"RTN","ECRDSSA",340,0)
 D ^DIR
"RTN","ECRDSSA",341,0)
 S ECTYP=$P(Y,U)
"RTN","ECRDSSA",342,0)
 Q $S($D(DUOUT):0,$D(DTOUT):0,$D(DIROUT):0,1:1)
"RTN","ECRDSSA",343,0)
 ;
"RTN","ECRDSSA",344,0)
ASKDEV() ;Ask output device
"RTN","ECRDSSA",345,0)
 ;  Input:  none
"RTN","ECRDSSA",346,0)
 ;
"RTN","ECRDSSA",347,0)
 ; Output:  1 if report is printed
"RTN","ECRDSSA",348,0)
 ;          0 if report is queued (or exited)
"RTN","ECRDSSA",349,0)
 ;
"RTN","ECRDSSA",350,0)
 N ECX,ZTDESC,ZTRTN,ZTSAVE
"RTN","ECRDSSA",351,0)
 S ECX=1
"RTN","ECRDSSA",352,0)
 K %ZIS S %ZIS="QMP"
"RTN","ECRDSSA",353,0)
 D ^%ZIS
"RTN","ECRDSSA",354,0)
 S:POP ECX=0
"RTN","ECRDSSA",355,0)
 I ECX&($D(IO("Q"))) D
"RTN","ECRDSSA",356,0)
 . S ZTRTN="STRPT^ECRDSSA",ZTDESC="DSS UNIT ACTIVITY REPORT"
"RTN","ECRDSSA",357,0)
 . S (ZTSAVE("ECLOC("),ZTSAVE("ECDSSU("),ZTSAVE("ECSRT"))=""
"RTN","ECRDSSA",358,0)
 . S (ZTSAVE("ECSTDT"),ZTSAVE("ECENDDT"))=""
"RTN","ECRDSSA",359,0)
 . D ^%ZTLOAD
"RTN","ECRDSSA",360,0)
 . D HOME^%ZIS
"RTN","ECRDSSA",361,0)
 . S ECX=0
"RTN","ECRDSSA",362,0)
 Q ECX
"RTN","ECRDSSU")
0^11^B52276776
"RTN","ECRDSSU",1,0)
ECRDSSU ;ALB/ESD - DSS Unit Workload Summary Report ; 1 Jul 2008
"RTN","ECRDSSU",2,0)
 ;;2.0; EVENT CAPTURE ;**5,8,10,14,18,47,63,72,95**;8 May 96;Build 26
"RTN","ECRDSSU",3,0)
 ;
"RTN","ECRDSSU",4,0)
EN ;- Get location(s), DSS Unit(s), start & end dates, device
"RTN","ECRDSSU",5,0)
 ;
"RTN","ECRDSSU",6,0)
 N ECLOC,ECDSSU,ECSTDT,ECENDDT
"RTN","ECRDSSU",7,0)
 I '$$ASKLOC^ECRUTL G ENQ
"RTN","ECRDSSU",8,0)
 I '$$ASKDSS^ECRUTL G ENQ
"RTN","ECRDSSU",9,0)
 I '$$STDT^ECRUTL G ENQ
"RTN","ECRDSSU",10,0)
 I '$$ENDDT^ECRUTL(ECSTDT) G ENQ
"RTN","ECRDSSU",11,0)
 I $$ASKDEV D STRPT^ECRDSSU
"RTN","ECRDSSU",12,0)
ENQ Q
"RTN","ECRDSSU",13,0)
 ;
"RTN","ECRDSSU",14,0)
 ;
"RTN","ECRDSSU",15,0)
STRPT ;- Main entry point
"RTN","ECRDSSU",16,0)
 ;
"RTN","ECRDSSU",17,0)
 N ECCRT,ECDSSNM,ECDSSTOT,ECLOCNM,ECQUIT,ECPAGE
"RTN","ECRDSSU",18,0)
 S (ECDSSTOT,ECPAGE,ECQUIT)=0,(ECDSSNM,ECLOCNM)=""
"RTN","ECRDSSU",19,0)
 ; Determine if device is CRT
"RTN","ECRDSSU",20,0)
 S ECCRT=$S($E(IOST,1,2)="C-":1,1:0)
"RTN","ECRDSSU",21,0)
 U IO
"RTN","ECRDSSU",22,0)
 D GETREC
"RTN","ECRDSSU",23,0)
 D LOOP
"RTN","ECRDSSU",24,0)
 I ECQUIT G STRPTQ
"RTN","ECRDSSU",25,0)
 D PRTCAT
"RTN","ECRDSSU",26,0)
 I ECQUIT G STRPTQ
"RTN","ECRDSSU",27,0)
 D DSSCHG
"RTN","ECRDSSU",28,0)
 I ECQUIT G STRPTQ
"RTN","ECRDSSU",29,0)
 I $D(ECGUI) G STRPTQ
"RTN","ECRDSSU",30,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","ECRDSSU",31,0)
 D ^%ZISC
"RTN","ECRDSSU",32,0)
STRPTQ K ^TMP("ECRPT")
"RTN","ECRDSSU",33,0)
 Q
"RTN","ECRDSSU",34,0)
 ;
"RTN","ECRDSSU",35,0)
 ;
"RTN","ECRDSSU",36,0)
GETREC ;- Loop thru "ADT" x-ref of EC Patient file (#721)
"RTN","ECRDSSU",37,0)
 ;
"RTN","ECRDSSU",38,0)
 N ECD,ECDFN,ECIEN,ECL,ECNT,I,J,ECREC,ECST
"RTN","ECRDSSU",39,0)
 S ECNT=0
"RTN","ECRDSSU",40,0)
 F I=0:0 S I=$O(ECLOC(I)) Q:'I  S ECL=+$P(ECLOC(I),U) D
"RTN","ECRDSSU",41,0)
 . S ECDFN=0
"RTN","ECRDSSU",42,0)
 . F  S ECDFN=+$O(^ECH("ADT",ECL,ECDFN)) Q:'ECDFN  F J=0:0 S J=$O(ECDSSU(J)) Q:'J  S ECD=+$P(ECDSSU(J),U) D
"RTN","ECRDSSU",43,0)
 .. S ECIEN=0
"RTN","ECRDSSU",44,0)
 .. S ECST=ECSTDT
"RTN","ECRDSSU",45,0)
 .. F  S ECST=+$O(^ECH("ADT",ECL,ECDFN,ECD,ECST)) Q:'ECST!(ECST>ECENDDT)  F  S ECIEN=+$O(^ECH("ADT",ECL,ECDFN,ECD,ECST,ECIEN)) Q:'ECIEN  D
"RTN","ECRDSSU",46,0)
 ... S ECREC=$G(^ECH(ECIEN,0))
"RTN","ECRDSSU",47,0)
 ... I ECD=+$P(ECREC,"^",7) D CRETMP
"RTN","ECRDSSU",48,0)
 Q
"RTN","ECRDSSU",49,0)
 ;
"RTN","ECRDSSU",50,0)
 ;
"RTN","ECRDSSU",51,0)
CRETMP ;- Create ^TMP("ECRPT" array w/format:
"RTN","ECRDSSU",52,0)
 ;    ^TMP("ECRPT",$J,location,DSS Unit,category,count)=procedure^volume^
"RTN","ECRDSSU",53,0)
 ;                                                         CPT modifiers
"RTN","ECRDSSU",54,0)
 ;
"RTN","ECRDSSU",55,0)
 N ECTC,ECTP,ECMOD,ECMODS,ECMODF,SEQ
"RTN","ECRDSSU",56,0)
 S ECTC=$S(+$P(ECREC,"^",8)=0:-1,1:+$P(ECREC,"^",8)),ECTP=$P($G(ECREC),"^",9)
"RTN","ECRDSSU",57,0)
 S ECNT=ECNT+1,ECTP=$P(ECTP,";")_";"_$E($P(ECTP,";",2),1)
"RTN","ECRDSSU",58,0)
 ;ALB/JAM - Get Procedure CPT modifiers
"RTN","ECRDSSU",59,0)
 S ECMODS="" I $O(^ECH(ECIEN,"MOD",0))'="" D
"RTN","ECRDSSU",60,0)
 . K ECMOD S ECMODF=$$MOD^ECUTL(ECIEN,"I",.ECMOD) I 'ECMODF Q
"RTN","ECRDSSU",61,0)
 . S SEQ="" F  S SEQ=$O(ECMOD(SEQ)) Q:SEQ=""  D
"RTN","ECRDSSU",62,0)
 . . S ECMODS=ECMODS_$S(ECMODS="":"",1:";")_SEQ
"RTN","ECRDSSU",63,0)
 S ^TMP("ECRPT",$J,+$P(ECREC,"^",4),+$P(ECREC,"^",7),ECTC,ECNT)=ECTP_"^"_+$P(ECREC,"^",10)_"^"_ECMODS
"RTN","ECRDSSU",64,0)
 Q
"RTN","ECRDSSU",65,0)
 ;
"RTN","ECRDSSU",66,0)
LOOP ;- Loop through data
"RTN","ECRDSSU",67,0)
 ;
"RTN","ECRDSSU",68,0)
 N ECCAT,ECNT,ECOCAT,ECDSS,ECLOCAT,ECPR,ECVOL,ECMOD
"RTN","ECRDSSU",69,0)
 S (ECNT,ECDSS,ECLOCAT)=0,(ECCAT,ECOCAT)=""
"RTN","ECRDSSU",70,0)
 I '$D(^TMP("ECRPT",$J)) G LOOPQ
"RTN","ECRDSSU",71,0)
 F  S ECLOCAT=$O(^TMP("ECRPT",$J,ECLOCAT)) Q:'ECLOCAT  D
"RTN","ECRDSSU",72,0)
 . F  S ECDSS=$O(^TMP("ECRPT",$J,ECLOCAT,ECDSS)) Q:'ECDSS  D
"RTN","ECRDSSU",73,0)
 .. Q:ECQUIT
"RTN","ECRDSSU",74,0)
 .. D PRTCAT Q:ECQUIT
"RTN","ECRDSSU",75,0)
 .. D DSSCHG Q:ECQUIT
"RTN","ECRDSSU",76,0)
 .. S ECOCAT=0
"RTN","ECRDSSU",77,0)
 .. D HDR
"RTN","ECRDSSU",78,0)
 .. D LOCNAM,DSSUNAM
"RTN","ECRDSSU",79,0)
 .. W !!,"Location: ",$G(ECLOCNM),!,"DSS Unit: ",$G(ECDSSNM)
"RTN","ECRDSSU",80,0)
 .. F  S ECCAT=$O(^TMP("ECRPT",$J,ECLOCAT,ECDSS,ECCAT)) Q:ECCAT=""  D
"RTN","ECRDSSU",81,0)
 ... D CATCHG
"RTN","ECRDSSU",82,0)
 ... Q:ECQUIT
"RTN","ECRDSSU",83,0)
 ... F  S ECNT=$O(^TMP("ECRPT",$J,ECLOCAT,ECDSS,ECCAT,ECNT)) Q:'ECNT  D
"RTN","ECRDSSU",84,0)
 .... S (ECPR,ECVOL)=0
"RTN","ECRDSSU",85,0)
 .... S ECPR=$P($G(^TMP("ECRPT",$J,ECLOCAT,ECDSS,ECCAT,ECNT)),"^")
"RTN","ECRDSSU",86,0)
 .... S ECVOL=$P($G(^TMP("ECRPT",$J,ECLOCAT,ECDSS,ECCAT,ECNT)),"^",2)
"RTN","ECRDSSU",87,0)
 .... S ECMOD=$P($G(^TMP("ECRPT",$J,ECLOCAT,ECDSS,ECCAT,ECNT)),"^",3)
"RTN","ECRDSSU",88,0)
 .... I '$D(ECTMP(ECLOCAT,ECDSS,ECCAT,ECPR)) S ECTMP(ECLOCAT,ECDSS,ECCAT,ECPR)=ECVOL D:ECMOD'="" SETMOD Q
"RTN","ECRDSSU",89,0)
 .... S ECTMP(ECLOCAT,ECDSS,ECCAT,ECPR)=ECTMP(ECLOCAT,ECDSS,ECCAT,ECPR)+ECVOL D:ECMOD'="" SETMOD
"RTN","ECRDSSU",90,0)
LOOPQ Q
"RTN","ECRDSSU",91,0)
SETMOD ;ALB/JAM - Set CPT modifiers in ECTMP array
"RTN","ECRDSSU",92,0)
 N MOD,I
"RTN","ECRDSSU",93,0)
 F I=1:1 S MOD=$P(ECMOD,";",I) Q:MOD=""  D
"RTN","ECRDSSU",94,0)
 . S ECTMP(ECLOCAT,ECDSS,ECCAT,ECPR,MOD)=$G(ECTMP(ECLOCAT,ECDSS,ECCAT,ECPR,MOD))+ECVOL
"RTN","ECRDSSU",95,0)
 Q
"RTN","ECRDSSU",96,0)
 ;
"RTN","ECRDSSU",97,0)
CATCHG ;- Category change
"RTN","ECRDSSU",98,0)
 ;
"RTN","ECRDSSU",99,0)
 I ECCAT=""&(ECOCAT="") G CATCHGQ
"RTN","ECRDSSU",100,0)
 I ECOCAT="" S ECOCAT=ECCAT G CATCHGQ
"RTN","ECRDSSU",101,0)
 I $G(ECOCAT)'=$G(ECCAT) D
"RTN","ECRDSSU",102,0)
 . D PRTCAT
"RTN","ECRDSSU",103,0)
 . S ECOCAT=ECCAT
"RTN","ECRDSSU",104,0)
CATCHGQ Q
"RTN","ECRDSSU",105,0)
 ;
"RTN","ECRDSSU",106,0)
PRTCAT ;- Print category
"RTN","ECRDSSU",107,0)
 ;
"RTN","ECRDSSU",108,0)
 Q:'$D(ECTMP)
"RTN","ECRDSSU",109,0)
 N ECC,ECCATOT,ECDSS,ECFLG,ECLOC,ECPR,ECPRN,ECSYI,ECSYN,ECCNAM,ECPNAM
"RTN","ECRDSSU",110,0)
 N ECCPT,ECPI
"RTN","ECRDSSU",111,0)
 S (ECCATOT,ECDSS,ECFLG,ECLOC)=0,(ECC,ECCNAM,ECPR)=""
"RTN","ECRDSSU",112,0)
 F  S ECLOC=$O(ECTMP(ECLOC)) Q:'ECLOC  F  S ECDSS=$O(ECTMP(ECLOC,ECDSS)) Q:'ECDSS  F  S ECC=$O(ECTMP(ECLOC,ECDSS,ECC)) Q:ECC=""  F  S ECPR=$O(ECTMP(ECLOC,ECDSS,ECC,ECPR)) Q:ECPR=""  D  I ECQUIT Q
"RTN","ECRDSSU",113,0)
 . S ECCNAM=$S($P($G(^EC(726,$S(ECC<1:0,1:+ECC),0)),"^")'="":$P($G(^EC(726,$S(ECC<1:0,1:+ECC),0)),"^"),1:"None")
"RTN","ECRDSSU",114,0)
 . S ECPRN=$S($P(ECPR,";",2)="E":ECPR_"C(725,",1:ECPR_"CPT(")
"RTN","ECRDSSU",115,0)
 . S ECSYI=+$O(^ECJ("AP",ECLOC,ECDSS,$S(ECC<1:0,1:+ECC),ECPRN,0)),ECSYN=$P($G(^ECJ(ECSYI,"PRO")),"^",2)
"RTN","ECRDSSU",116,0)
 . S ECPI=""
"RTN","ECRDSSU",117,0)
 . S ECCPT=$S($P(ECPR,";",2)="I":+ECPR,1:$P($G(^EC(725,+ECPR,0)),"^",5))
"RTN","ECRDSSU",118,0)
 . I ECCPT'="" S ECPI=$$CPT^ICPTCOD(ECCPT,$P(ECENDDT,".")),ECCPT=$P(ECPI,"^",2)
"RTN","ECRDSSU",119,0)
 . S ECPNAM=$S($P(ECPR,";",2)="E":$G(^EC(725,+$P(ECPR,";"),0)),$P(ECPR,";",2)="I":$P(ECPI,"^",3),1:"") S:$P(ECPR,";",2)="E" ECPNAM=$P(ECPNAM,"^",2)_" "_$P(ECPNAM,"^")
"RTN","ECRDSSU",120,0)
 . Q:ECQUIT
"RTN","ECRDSSU",121,0)
 . I $Y>(IOSL-11) D PAUSE Q:ECQUIT  D HDR
"RTN","ECRDSSU",122,0)
 . W:'ECFLG !!?1,"Category:",!?2,ECCNAM S ECFLG=1
"RTN","ECRDSSU",123,0)
 . W !?3,ECCPT,?9,$E(ECPNAM,1,35),?46,$S(ECSYN]"":$E(ECSYN,1,21),1:""),?69,$J($P($G(ECTMP(ECLOC,ECDSS,ECC,ECPR)),"^"),6)
"RTN","ECRDSSU",124,0)
 . S ECCATOT=ECCATOT+$P($G(ECTMP(ECLOC,ECDSS,ECC,ECPR)),"^")
"RTN","ECRDSSU",125,0)
 . I $O(ECTMP(ECLOC,ECDSS,ECC,ECPR,""))'="" D PRTMOD I ECQUIT Q
"RTN","ECRDSSU",126,0)
 G:ECQUIT PRTCATQ
"RTN","ECRDSSU",127,0)
 I $Y>(IOSL-11) D PAUSE G:ECQUIT PRTCATQ D HDR
"RTN","ECRDSSU",128,0)
 W !?69,"------"
"RTN","ECRDSSU",129,0)
 W !?6,"Total Procedures for ",ECCNAM,?69,$J(ECCATOT,6),!
"RTN","ECRDSSU",130,0)
 S ECDSSTOT=ECDSSTOT+ECCATOT
"RTN","ECRDSSU",131,0)
PRTCATQ K ECTMP
"RTN","ECRDSSU",132,0)
 Q
"RTN","ECRDSSU",133,0)
 ;
"RTN","ECRDSSU",134,0)
PRTMOD ;ALB/JAM - Print CPT modifiers
"RTN","ECRDSSU",135,0)
 N MOD,IEN,MODESC,MODI S IEN=""
"RTN","ECRDSSU",136,0)
 F  S IEN=$O(ECTMP(ECLOC,ECDSS,ECC,ECPR,IEN)) Q:IEN=""  D
"RTN","ECRDSSU",137,0)
 . I $Y>(IOSL-8) D PAUSE Q:ECQUIT  D HDR
"RTN","ECRDSSU",138,0)
 . S MODI=$$MOD^ICPTMOD(IEN,"I",$P(ECENDDT,"."))
"RTN","ECRDSSU",139,0)
 . S MOD=$P(MODI,"^",2) I MOD="" Q
"RTN","ECRDSSU",140,0)
 . S MODESC=$P(MODI,"^",3) I MODESC="" S MODESC="Unknown"
"RTN","ECRDSSU",141,0)
 . W !?7,"- ",MOD," ",$E(MODESC,1,40)," ("
"RTN","ECRDSSU",142,0)
 . W ECTMP(ECLOC,ECDSS,ECC,ECPR,IEN),")"
"RTN","ECRDSSU",143,0)
 Q
"RTN","ECRDSSU",144,0)
 ;
"RTN","ECRDSSU",145,0)
DSSCHG ;- DSS Unit change
"RTN","ECRDSSU",146,0)
 ;
"RTN","ECRDSSU",147,0)
 Q:'$G(ECDSSTOT)
"RTN","ECRDSSU",148,0)
 I ECDSSTOT>0 D
"RTN","ECRDSSU",149,0)
 . I $Y>(IOSL-11) D PAUSE Q:ECQUIT  D HDR
"RTN","ECRDSSU",150,0)
 . W !!?69,"======"
"RTN","ECRDSSU",151,0)
 . W !?6,"Total Procedures for ",$G(ECDSSNM),?69,$J(ECDSSTOT,6)
"RTN","ECRDSSU",152,0)
 . S ECDSSTOT=0,(ECLOCNM,ECDSSNM)=""
"RTN","ECRDSSU",153,0)
 . D PAUSE
"RTN","ECRDSSU",154,0)
 Q
"RTN","ECRDSSU",155,0)
 ;
"RTN","ECRDSSU",156,0)
HDR ;- Report header
"RTN","ECRDSSU",157,0)
 ;
"RTN","ECRDSSU",158,0)
 I ECCRT!(ECPAGE) W @IOF
"RTN","ECRDSSU",159,0)
 S ECPAGE=ECPAGE+1
"RTN","ECRDSSU",160,0)
 W !,?((IOM-32)\2),"DSS UNIT WORKLOAD SUMMARY REPORT"
"RTN","ECRDSSU",161,0)
 W !,?((IOM-40)\2),"Date Range: "_$$FMTE^XLFDT($P((ECSTDT+.0001),"."))_" to "_$$FMTE^XLFDT($P(ECENDDT,"."))
"RTN","ECRDSSU",162,0)
 W !!,"Run Date: "_$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","ECRDSSU",163,0)
 W ?65,"    Page: ",ECPAGE
"RTN","ECRDSSU",164,0)
 W !!?3,"CPT Code",?13,"Description",?46,"Synonym",?69,"Volume"
"RTN","ECRDSSU",165,0)
 W !?7,"CPT Modifier (volume of modifiers use)"
"RTN","ECRDSSU",166,0)
 W !,$TR($J("",79)," ","-")
"RTN","ECRDSSU",167,0)
 Q
"RTN","ECRDSSU",168,0)
 ;
"RTN","ECRDSSU",169,0)
 ;
"RTN","ECRDSSU",170,0)
LOCNAM ;- Get location name
"RTN","ECRDSSU",171,0)
 ;
"RTN","ECRDSSU",172,0)
 N I
"RTN","ECRDSSU",173,0)
 F I=0:0 S I=$O(ECLOC(I)) Q:'I  I $P($G(ECLOC(I)),"^")=ECLOCAT S ECLOCNM=$P(ECLOC(I),"^",2)
"RTN","ECRDSSU",174,0)
 Q
"RTN","ECRDSSU",175,0)
 ;
"RTN","ECRDSSU",176,0)
 ;
"RTN","ECRDSSU",177,0)
DSSUNAM ;- Get DSS Unit name
"RTN","ECRDSSU",178,0)
 ;
"RTN","ECRDSSU",179,0)
 N I
"RTN","ECRDSSU",180,0)
 F I=0:0 S I=$O(ECDSSU(I)) Q:'I  I $P($G(ECDSSU(I)),"^")=ECDSS S ECDSSNM=$P(ECDSSU(I),"^",2)
"RTN","ECRDSSU",181,0)
 Q
"RTN","ECRDSSU",182,0)
 ;
"RTN","ECRDSSU",183,0)
 ;
"RTN","ECRDSSU",184,0)
PAUSE ;- Pause for screen output
"RTN","ECRDSSU",185,0)
 D FOOTER
"RTN","ECRDSSU",186,0)
 Q:'ECCRT
"RTN","ECRDSSU",187,0)
 N DIR,DIRUT,DUOUT
"RTN","ECRDSSU",188,0)
 I IOSL<30 F  W ! Q:$Y>(IOSL-4)
"RTN","ECRDSSU",189,0)
 W ! S DIR(0)="E" D ^DIR I $D(DIRUT)!($D(DUOUT)) S ECQUIT=1
"RTN","ECRDSSU",190,0)
 Q
"RTN","ECRDSSU",191,0)
 ;
"RTN","ECRDSSU",192,0)
 ;
"RTN","ECRDSSU",193,0)
FOOTER ;- Print page footer
"RTN","ECRDSSU",194,0)
 W !!?4,"Volume totals may represent days, minutes, numbers of procedures"
"RTN","ECRDSSU",195,0)
 W !?4,"and/or a combination of these."
"RTN","ECRDSSU",196,0)
 Q
"RTN","ECRDSSU",197,0)
 ;
"RTN","ECRDSSU",198,0)
 ;
"RTN","ECRDSSU",199,0)
ASKDEV() ;- Ask device for printing or queuing report
"RTN","ECRDSSU",200,0)
 ;  Input:     None
"RTN","ECRDSSU",201,0)
 ;
"RTN","ECRDSSU",202,0)
 ; Output:     1 if report is printed
"RTN","ECRDSSU",203,0)
 ;             0 if report is queued (or exited out)
"RTN","ECRDSSU",204,0)
 ;
"RTN","ECRDSSU",205,0)
 N ECX,ZTDESC,ZTRTN,ZTSAVE
"RTN","ECRDSSU",206,0)
 S ECX=1
"RTN","ECRDSSU",207,0)
 K %ZIS S %ZIS="QMP"
"RTN","ECRDSSU",208,0)
 D ^%ZIS
"RTN","ECRDSSU",209,0)
 S:POP ECX=0
"RTN","ECRDSSU",210,0)
 I ECX&($D(IO("Q"))) D
"RTN","ECRDSSU",211,0)
 . S ZTRTN="STRPT^ECRDSSU",ZTDESC="DSS UNIT WORKLOAD SUMMARY REPORT"
"RTN","ECRDSSU",212,0)
 . S (ZTSAVE("ECLOC("),ZTSAVE("ECDSSU("),ZTSAVE("ECSTDT"),ZTSAVE("ECENDDT"))=""
"RTN","ECRDSSU",213,0)
 . D ^%ZTLOAD
"RTN","ECRDSSU",214,0)
 . D HOME^%ZIS
"RTN","ECRDSSU",215,0)
 . S ECX=0
"RTN","ECRDSSU",216,0)
 Q ECX
"RTN","ECRRPC")
0^12^B12656189
"RTN","ECRRPC",1,0)
ECRRPC ;ALB/JAM - Event Capture Report RPC Broker ;2 Sep 2008
"RTN","ECRRPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,47,61,72,95**;8 May 96;Build 26
"RTN","ECRRPC",3,0)
 ;
"RTN","ECRRPC",4,0)
RPTEN(RESULTS,ECARY) ;RPC Broker entry point for EC Reports
"RTN","ECRRPC",5,0)
 ;All EC GUI reports will call this line tag
"RTN","ECRRPC",6,0)
 ;        RPC: EC REPORTS
"RTN","ECRRPC",7,0)
 ;INPUTS   ECARY - Contains the following elements for report printing
"RTN","ECRRPC",8,0)
 ;          ECDEV  - Print to queue, if device
"RTN","ECRRPC",9,0)
 ;          ECQDT  - Queue to print (date/time), optional
"RTN","ECRRPC",10,0)
 ;
"RTN","ECRRPC",11,0)
 ;OUTPUTS  RESULTS - Array of help text in the HELP FRAM File (#9.2)
"RTN","ECRRPC",12,0)
 ;
"RTN","ECRRPC",13,0)
 N HLPDA,HND,ECSTR,ECFILER,ECERR,ECDIRY,ECUFILE,ECGUI
"RTN","ECRRPC",14,0)
 D SETENV^ECUMRPC
"RTN","ECRRPC",15,0)
 S ECERR=0,ECGUI=1 D PARSE,CHKDT I ECERR Q
"RTN","ECRRPC",16,0)
 K ^TMP("ECMSG",$J),^TMP($J,"ECRPT")
"RTN","ECRRPC",17,0)
 D  I ECERR D END Q
"RTN","ECRRPC",18,0)
 . I ECPTYP="D" D HFSOPEN(ECHNDL) Q
"RTN","ECRRPC",19,0)
 . I '$D(ECDEV) S ^TMP("ECMSG",$J,1)="0^Device undefined",ECERR=1
"RTN","ECRRPC",20,0)
 S HND=$P($T(@ECHNDL),";;",2) I HND="" D  Q
"RTN","ECRRPC",21,0)
 . S ^TMP("ECMSG",$J,1)="0^Line Tag undefined" D END
"RTN","ECRRPC",22,0)
 S ECQDT=$G(ECQDT,"NOW"),%DT="XT",X=ECQDT D ^%DT  ;Print time
"RTN","ECRRPC",23,0)
 S ECQDT=$S(Y>0:Y,1:"NOW")
"RTN","ECRRPC",24,0)
 D @$P(HND,";",2)
"RTN","ECRRPC",25,0)
 I ECPTYP="D" D HFSCLOSE(ECFILER) ;S RESULTS=$NA(^TMP($J))
"RTN","ECRRPC",26,0)
END D KILLVAR
"RTN","ECRRPC",27,0)
 I $D(^TMP("ECMSG",$J)) S RESULTS=$NA(^TMP("ECMSG",$J)) Q
"RTN","ECRRPC",28,0)
 S RESULTS=$NA(^TMP($J))
"RTN","ECRRPC",29,0)
 Q
"RTN","ECRRPC",30,0)
 ;
"RTN","ECRRPC",31,0)
PARSE ;Parse data from array for filing
"RTN","ECRRPC",32,0)
 N SUB
"RTN","ECRRPC",33,0)
 S SUB="" F  S SUB=$O(ECARY(SUB)) Q:SUB=""  S @SUB=ECARY(SUB)
"RTN","ECRRPC",34,0)
 Q
"RTN","ECRRPC",35,0)
CHKDT ;Required Data Check
"RTN","ECRRPC",36,0)
 N I,C
"RTN","ECRRPC",37,0)
 S C=1
"RTN","ECRRPC",38,0)
 F I="ECHNDL","ECPTYP" D
"RTN","ECRRPC",39,0)
 .I $G(@I)="" S ^TMP("ECMSG",$J,C)="0^Key data missing "_I,C=C+1,ECERR=1
"RTN","ECRRPC",40,0)
 Q
"RTN","ECRRPC",41,0)
KILLVAR ;Kill variables
"RTN","ECRRPC",42,0)
 N SUB
"RTN","ECRRPC",43,0)
 S SUB="" F  S SUB=$O(ECARY(SUB)) Q:SUB=""  K @SUB
"RTN","ECRRPC",44,0)
 K ECARY,POP,ECQDT
"RTN","ECRRPC",45,0)
 Q
"RTN","ECRRPC",46,0)
HFSOPEN(HANDLE) ; 
"RTN","ECRRPC",47,0)
 S ECDIRY=$$GET^XPAR("DIV","EC HFS SCRATCH")
"RTN","ECRRPC",48,0)
 I ECDIRY="" S ECERR=1 D  Q
"RTN","ECRRPC",49,0)
 .S ^TMP("ECMSG",$J,1)="0^A scratch directory for reports doesn't exist"
"RTN","ECRRPC",50,0)
 S ECFILER="EC"_DUZ_".DAT",ECUFILE=ECFILER S ^TMP("JEN",$J,.1)=ECUFILE
"RTN","ECRRPC",51,0)
 D OPEN^%ZISH(HANDLE,ECDIRY,ECFILER,"W") D:POP  Q:POP
"RTN","ECRRPC",52,0)
 .S ECERR=1,^TMP("ECMSG",$J,1)="0^Unable to open file "_ECDIRY_ECFILER
"RTN","ECRRPC",53,0)
 S IOM=132,IOSL=99999,IOST="P-DUMMY",IOF=""""""
"RTN","ECRRPC",54,0)
 Q
"RTN","ECRRPC",55,0)
 ;
"RTN","ECRRPC",56,0)
HFSCLOSE(HANDLE) ; 
"RTN","ECRRPC",57,0)
 N ECDEL
"RTN","ECRRPC",58,0)
 D CLOSE^%ZISH(ECDIRY_HANDLE)
"RTN","ECRRPC",59,0)
 K ^TMP($J)
"RTN","ECRRPC",60,0)
 S ECDEL(ECFILER)=""
"RTN","ECRRPC",61,0)
 S X=$$FTG^%ZISH(ECDIRY,ECFILER,$NAME(^TMP($J,1)),2)
"RTN","ECRRPC",62,0)
 S X=$$DEL^%ZISH(ECDIRY,$NA(ECDEL))
"RTN","ECRRPC",63,0)
 Q
"RTN","ECRRPC",64,0)
ECPAT ;;Patient Summary Report;ECPAT^ECRRPT
"RTN","ECRRPC",65,0)
ECRDSSA ;;DSS Unit Activity;ECRDSSA^ECRRPT
"RTN","ECRRPC",66,0)
ECRDSSU ;;DSS Unit Workload Summary;ECRDSSU^ECRRPT
"RTN","ECRRPC",67,0)
ECPROV ;;Provider Summary Report;ECPROV^ECRRPT
"RTN","ECRRPC",68,0)
PROSUM ;;Provider (1-7) Summary Report;PROSUM^ECRRPT
"RTN","ECRRPC",69,0)
ECOSSUM ;;Ordering Section Summary Report;ECOSSUM^ECRRPT
"RTN","ECRRPC",70,0)
ECPCER ;;PCE Data Summary Report;ECPCER^ECRRPT
"RTN","ECRRPC",71,0)
ECRPERS ;;Inactive Person Class Report;ECRPERS^ECRRPT1
"RTN","ECRRPC",72,0)
ECRPRSN ;;Procedure Reason Report;ECRPRSN^ECRRPT1
"RTN","ECRRPC",73,0)
ECDSS1 ;;National/Local Procedure Reports;ECDSS1^ECRRPT1
"RTN","ECRRPC",74,0)
ECDSS3 ;;Category Reports;ECDSS3^ECRRPT1
"RTN","ECRRPC",75,0)
ECSUM ;;Print Category and Procedure Summary (Report);ECSUM^ECRRPT1
"RTN","ECRRPC",76,0)
ECNTPCE ;;Records Failing Transmission to PCE Report;ECNTPCE^ECRRPT1
"RTN","ECRRPC",77,0)
ECSCPT ;;Event Code Screens with CPT Codes;ECSCPT^ECRRPT1
"RTN","ECRRPC",78,0)
ECINCPT ;;National/Local Procedure Codes with Inactive CPT;ECINCPT^ECRRPT1
"RTN","ECRRPT")
0^13^B53873531
"RTN","ECRRPT",1,0)
ECRRPT ;ALB/JAM - Event Capture Report RPC Broker ; 10 JUL 2008
"RTN","ECRRPT",2,0)
 ;;2.0; EVENT CAPTURE ;**25,32,41,56,61,82,94,95**;8 May 96;Build 26
"RTN","ECRRPT",3,0)
 ;
"RTN","ECRRPT",4,0)
REQCHK(ECV) ;Required data check
"RTN","ECRRPT",5,0)
 N I,C
"RTN","ECRRPT",6,0)
 S C=1
"RTN","ECRRPT",7,0)
 F I=1:1:$L(ECV,U) I '$D(@$P(ECV,U,I)) D
"RTN","ECRRPT",8,0)
 . S ^TMP("ECMSG",$J,C)="0^Required data missing "_$P(ECV,U,I)
"RTN","ECRRPT",9,0)
 . S C=C+1,ECERR=1
"RTN","ECRRPT",10,0)
 Q
"RTN","ECRRPT",11,0)
DATECHK(ECSD,ECED) ;Check human format date and converts to FileMan format
"RTN","ECRRPT",12,0)
 ;    Input  ECSD  - Start Date (ex. 10/9/01)
"RTN","ECRRPT",13,0)
 ;           ECED  - End Date
"RTN","ECRRPT",14,0)
 N ECI,X,Y
"RTN","ECRRPT",15,0)
 S %DT="X" F ECI="ECSD","ECED" S X=@ECI D ^%DT S @ECI=Y
"RTN","ECRRPT",16,0)
 S ECSD=$S(ECSD=-1:DT,1:ECSD),ECED=$S(ECED=-1:DT,1:ECED)
"RTN","ECRRPT",17,0)
 S ECDATE=$$FMTE^XLFDT(ECSD)_"^"_$$FMTE^XLFDT(ECED)
"RTN","ECRRPT",18,0)
 Q
"RTN","ECRRPT",19,0)
QUEUE ;Queues report to printer
"RTN","ECRRPT",20,0)
 N ZTIO,ZTDESC,ZTRTN,ZTDTH,ZTSAVE,%ZIS,I,IOP,POP
"RTN","ECRRPT",21,0)
 S XNAM=$P($G(^%ZIS(1,ECDEV,0)),U,2)
"RTN","ECRRPT",22,0)
 S IOP="Q;`"_ECDEV,%ZIS="Q" D ^%ZIS I POP D  Q
"RTN","ECRRPT",23,0)
 . ;S IOP="Q;"_XNAM,%ZIS="Q" D ^%ZIS I POP D  Q
"RTN","ECRRPT",24,0)
 . S ^TMP("ECMSG",$J,1)="0^Device selection unsuccessful"
"RTN","ECRRPT",25,0)
 S ZTIO=ION,ZTDESC=ECDESC,ZTRTN=ECROU
"RTN","ECRRPT",26,0)
 S ZTDTH=$$FMTH^XLFDT(ECQDT)
"RTN","ECRRPT",27,0)
 ;D NOW^%DTC S ZTDTH=$S(%'<ECQDT:%+.0002,1:ECQDT)
"RTN","ECRRPT",28,0)
 F I=1:1:$L(ECV,U) I $D(@$P(ECV,U,I)) S ZTSAVE($P(ECV,U,I))=""
"RTN","ECRRPT",29,0)
 M ZTSAVE=ECSAVE
"RTN","ECRRPT",30,0)
 D ^%ZTLOAD,HOME^%ZIS,^%ZISC ;K IO("Q")
"RTN","ECRRPT",31,0)
 I $D(ZTSK) S ^TMP("ECMSG",$J)="1^Report queued. Task #"_ZTSK Q
"RTN","ECRRPT",32,0)
 S ^TMP("ECMSG",$J)="0^Task Rejected"
"RTN","ECRRPT",33,0)
 Q
"RTN","ECRRPT",34,0)
 ;
"RTN","ECRRPT",35,0)
ECPAT ;Patient Summary Report for RPC Call
"RTN","ECRRPT",36,0)
 ;     Variables passed in
"RTN","ECRRPT",37,0)
 ;       ECDFN  - Patient IEN for file #2
"RTN","ECRRPT",38,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT",39,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT",40,0)
 ;       ECRY   - Print Procedure Reason (optional)
"RTN","ECRRPT",41,0)
 ;
"RTN","ECRRPT",42,0)
 ;     Variable return
"RTN","ECRRPT",43,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT",44,0)
 N ECDATE,ECPAT,ECV,DIC,X,Y,ECROU,ECDESC
"RTN","ECRRPT",45,0)
 S ECV="ECDFN^ECSD^ECED" D REQCHK(ECV) I ECERR Q
"RTN","ECRRPT",46,0)
 S DIC=2,DIC(0)="QNMZX",X=ECDFN D ^DIC Q:Y<0  S ECPAT=$P(Y,U,2)
"RTN","ECRRPT",47,0)
 D DATECHK(.ECSD,.ECED)
"RTN","ECRRPT",48,0)
 S ECSD=ECSD-.0001,ECED=ECED+.9999
"RTN","ECRRPT",49,0)
 I $E($G(ECRY))'="Y" K ECRY
"RTN","ECRRPT",50,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT",51,0)
 . S ECV="ECDFN^ECPAT^ECDATE^ECSD^ECED^ECRY",ECROU="SUM^ECPAT"
"RTN","ECRRPT",52,0)
 . S ECDESC="EVENT CAPTURE PATIENT SUMMARY"
"RTN","ECRRPT",53,0)
 . D QUEUE
"RTN","ECRRPT",54,0)
 D SUM^ECPAT
"RTN","ECRRPT",55,0)
 Q
"RTN","ECRRPT",56,0)
ECRDSSU ;DSS Unit Workload Summary Report
"RTN","ECRRPT",57,0)
 ;     Variables passed in
"RTN","ECRRPT",58,0)
 ;       ECL    - Location to report (1 or ALL)
"RTN","ECRRPT",59,0)
 ;       ECD    - DSS Unit to report (1, some or ALL)
"RTN","ECRRPT",60,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT",61,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT",62,0)
 ;       ECDUZ  - User IEN from file (#200)
"RTN","ECRRPT",63,0)
 ;
"RTN","ECRRPT",64,0)
 ;     Variable return
"RTN","ECRRPT",65,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT",66,0)
 N ECLOC,ECDSSU,ECV,ECI,ECSTDT,ECENDDT,ECKEY,ECROU,ECSAVE,ECDESC,ECNT
"RTN","ECRRPT",67,0)
 N ECDATE,ECX,DIC,X,Y
"RTN","ECRRPT",68,0)
 S ECV="ECL^ECD0^ECSD^ECED^ECDUZ" D REQCHK(ECV) I ECERR Q
"RTN","ECRRPT",69,0)
 D  I '$D(ECLOC) S ^TMP("ECMSG",$J)="1^Invalid Location." Q
"RTN","ECRRPT",70,0)
 . I ECL="ALL" D LOCARRY^ECRUTL Q
"RTN","ECRRPT",71,0)
 . S DIC=4,DIC(0)="QNZX",X=ECL D ^DIC Q:Y<0  S ECLOC(1)=+Y_"^"_$P(Y,U,2)
"RTN","ECRRPT",72,0)
 D  I '$D(ECDSSU) S ^TMP("ECMSG",$J)="1^Invalid DSS Unit." Q
"RTN","ECRRPT",73,0)
 . I ECD0="ALL" D  Q
"RTN","ECRRPT",74,0)
 . . S ECKEY=$S($D(^XUSEC("ECALLU",ECDUZ)):1,1:0) D ALLU^ECRUTL
"RTN","ECRRPT",75,0)
 . S (ECI,ECNT)=0 F ECI=0:1 S ECX="ECD"_ECI Q:'$D(@ECX)  D
"RTN","ECRRPT",76,0)
 . . K DIC S DIC=724,DIC(0)="QNZX",X=@ECX D ^DIC I Y<0 Q
"RTN","ECRRPT",77,0)
 . . S ECNT=ECNT+1,ECDSSU(ECNT)=Y
"RTN","ECRRPT",78,0)
 D DATECHK(.ECSD,.ECED)
"RTN","ECRRPT",79,0)
 S ECSTDT=ECSD-.0001,ECENDDT=ECED+.9999
"RTN","ECRRPT",80,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT",81,0)
 . S ECV="ECDATE^ECSTDT^ECENDDT",ECROU="STRPT^ECRDSSU"
"RTN","ECRRPT",82,0)
 . S (ECSAVE("ECLOC("),ECSAVE("ECDSSU("))=""
"RTN","ECRRPT",83,0)
 . S ECDESC="DSS UNIT WORKLOAD SUMMARY REPORT"
"RTN","ECRRPT",84,0)
 . D QUEUE
"RTN","ECRRPT",85,0)
 D STRPT^ECRDSSU
"RTN","ECRRPT",86,0)
 Q
"RTN","ECRRPT",87,0)
PROSUM ;Provider (1-3) Summary Report for RPC Call
"RTN","ECRRPT",88,0)
 ;     Variables passed in
"RTN","ECRRPT",89,0)
 ;       ECU    - Provider IEN for file #200
"RTN","ECRRPT",90,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT",91,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT",92,0)
 ;       ECRY   - Print Procedure Reason (optional)
"RTN","ECRRPT",93,0)
 ;
"RTN","ECRRPT",94,0)
 ;     Variable return
"RTN","ECRRPT",95,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT",96,0)
 N ECV,ECDATE,ECUN,ECROU,ECDESC,DIC,X,Y
"RTN","ECRRPT",97,0)
 S ECV="ECU^ECSD^ECED" D REQCHK(ECV) I ECERR Q
"RTN","ECRRPT",98,0)
 S DIC=200,DIC(0)="QNZX",X=ECU D ^DIC D:Y<0  Q:Y<0  S ECUN=$P(Y,U,2)
"RTN","ECRRPT",99,0)
 . S ^TMP("ECMSG",$J)="1^Invalid Provider."
"RTN","ECRRPT",100,0)
 D DATECHK(.ECSD,.ECED)
"RTN","ECRRPT",101,0)
 I ECRY'="Y" K ECRY
"RTN","ECRRPT",102,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT",103,0)
 . S ECV="ECU^ECUN^ECDATE^ECSD^ECED^ECRY"
"RTN","ECRRPT",104,0)
 . S ECROU="EN^ECPRSUM1",ECDESC="Event Capture Provider Summary"
"RTN","ECRRPT",105,0)
 . D QUEUE
"RTN","ECRRPT",106,0)
 D EN^ECPRSUM1
"RTN","ECRRPT",107,0)
 Q
"RTN","ECRRPT",108,0)
ECPROV ;Provider Summary Report for RPC Call
"RTN","ECRRPT",109,0)
 ;     Variables passed in
"RTN","ECRRPT",110,0)
 ;       ECL    - Location to report (1 or ALL)
"RTN","ECRRPT",111,0)
 ;       ECD    - DSS Unit to report (1 or ALL)
"RTN","ECRRPT",112,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT",113,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT",114,0)
 ;       ECRY   - Print Procedure Reason (optional)
"RTN","ECRRPT",115,0)
 ;       ECDUZ  - User DUZ (ien in #200)
"RTN","ECRRPT",116,0)
 ;
"RTN","ECRRPT",117,0)
 ;     Variable return
"RTN","ECRRPT",118,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT",119,0)
 N ECV,ECDN,ECDATE,ECLN,ECSAVE,ECDESC,ECROU,DIC,X,Y,CNT,UNIT
"RTN","ECRRPT",120,0)
 S ECDN="ALL",ECV="ECL^ECD^ECSD^ECED^ECDUZ" D REQCHK(ECV) I ECERR Q
"RTN","ECRRPT",121,0)
 I ECL'="ALL" D  I ECERR Q
"RTN","ECRRPT",122,0)
 . ;The line below was changed by VMP for NOIS ANN-1003-42305
"RTN","ECRRPT",123,0)
 . S DIC=4,DIC(0)="QNZX",X=ECL D ^DIC D:Y<0  Q:Y<0  S ECLN=$P(Y,U,2)
"RTN","ECRRPT",124,0)
 . . S ^TMP("ECMSG",$J)="1^Invalid Location.",ECERR=1
"RTN","ECRRPT",125,0)
 I ECD'="ALL" K DIC D  I ECERR Q
"RTN","ECRRPT",126,0)
 . S DIC=724,DIC(0)="QNMZX",X=ECD D ^DIC D:Y<0  Q:Y<0  S ECDN=$P(Y,U,2)
"RTN","ECRRPT",127,0)
 . . S ^TMP("ECMSG",$J)="1^Invalid Location.",ECERR=1
"RTN","ECRRPT",128,0)
 I ECD="ALL",'$D(^XUSEC("ECALLU",ECDUZ)) D
"RTN","ECRRPT",129,0)
 . S (ECD,ECDN)="SOME",(X,CNT)=0
"RTN","ECRRPT",130,0)
 . F  S X=$O(^VA(200,ECDUZ,"EC",X)) Q:'X  D
"RTN","ECRRPT",131,0)
 . . S CNT=CNT+1,UNIT=$P(^VA(200,ECDUZ,"EC",X,0),"^")
"RTN","ECRRPT",132,0)
 . . S UNIT(CNT)=UNIT_"^"_$P(^ECD(UNIT,0),"^")
"RTN","ECRRPT",133,0)
 I $E($G(ECRY))'="Y" K ECRY
"RTN","ECRRPT",134,0)
 D DATECHK(.ECSD,.ECED)
"RTN","ECRRPT",135,0)
 S ECSD=ECSD-.0001,ECED=ECED+.9999 S:'$D(UNIT) UNIT=""
"RTN","ECRRPT",136,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT",137,0)
 . S ECV="ECDATE^ECSD^ECED^ECRY",ECROU="START^ECPROV2"
"RTN","ECRRPT",138,0)
 . S (ECSAVE("ECL*"),ECSAVE("ECD*"),ECSAVE("UNIT*"))=""
"RTN","ECRRPT",139,0)
 . S ECDESC="EVENT CAPTURE PROVIDER SUMMARY"
"RTN","ECRRPT",140,0)
 . D QUEUE
"RTN","ECRRPT",141,0)
 U IO D START^ECPROV2
"RTN","ECRRPT",142,0)
 Q
"RTN","ECRRPT",143,0)
ECOSSUM ;Ordering Section Summary Report for RPC Call
"RTN","ECRRPT",144,0)
 ;     Variables passed in
"RTN","ECRRPT",145,0)
 ;       ECOS   - Ordering Section
"RTN","ECRRPT",146,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT",147,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT",148,0)
 ;       ECL    - Location to report (1 or ALL)
"RTN","ECRRPT",149,0)
 ;       ECD    - DSS Unit to report (1, some or ALL)
"RTN","ECRRPT",150,0)
 ;       ECDUZ  - User ien (#200)
"RTN","ECRRPT",151,0)
 ;
"RTN","ECRRPT",152,0)
 ;     Variable return
"RTN","ECRRPT",153,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT",154,0)
 N ECV,ECI,ECOSN,ECLOC,ECDSSU,ECDATE,ECNT,ECSAVE,ECROU,ECDESC,DIC,X,Y
"RTN","ECRRPT",155,0)
 S ECV="ECOS^ECL^ECD0^ECSD^ECED^ECDUZ" D REQCHK(ECV) I ECERR Q
"RTN","ECRRPT",156,0)
 S DIC=723,DIC(0)="QNMZX",X=ECOS D ^DIC D:Y<0  Q:Y<0  S ECOSN=$P(Y,U,2)
"RTN","ECRRPT",157,0)
 . S ^TMP("ECMSG",$J)="1^Invalid Ordering Section.",ECERR=1
"RTN","ECRRPT",158,0)
 D  I '$D(ECLOC) S ^TMP("ECMSG",$J)="1^Invalid Location.",ECERR=1 Q
"RTN","ECRRPT",159,0)
 . K DIC I ECL="ALL" D LOCARRY^ECRUTL Q
"RTN","ECRRPT",160,0)
 . S DIC=4,DIC(0)="QNZX",X=ECL D ^DIC Q:Y<0  S ECLOC(1)=+Y_"^"_$P(Y,U,2)
"RTN","ECRRPT",161,0)
 D  I '$D(ECDSSU) S ^TMP("ECMSG",$J)="1^Invalid DSS Unit." Q
"RTN","ECRRPT",162,0)
 . I ECD0="ALL" D  Q
"RTN","ECRRPT",163,0)
 . . S ECKEY=$S($D(^XUSEC("ECALLU",ECDUZ)):1,1:0) D ALLU^ECRUTL
"RTN","ECRRPT",164,0)
 . S (ECI,ECNT)=0 F ECI=0:1 S ECX="ECD"_ECI Q:'$D(@ECX)  D
"RTN","ECRRPT",165,0)
 . . K DIC S DIC=724,DIC(0)="QNMZX",X=@ECX D ^DIC I Y<0 Q
"RTN","ECRRPT",166,0)
 . . S ECNT=ECNT+1,ECDSSU(ECNT)=Y
"RTN","ECRRPT",167,0)
 D DATECHK(.ECSD,.ECED)
"RTN","ECRRPT",168,0)
 S ECSD=ECSD-.0001,ECED=ECED+.9999
"RTN","ECRRPT",169,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT",170,0)
 . S ECV="ECOS^ECSD^ECED^ECOSN",ECROU="START^ECOSSUM"
"RTN","ECRRPT",171,0)
 . S (ECSAVE("ECLOC("),ECSAVE("ECDSSU("))=""
"RTN","ECRRPT",172,0)
 . S ECDESC="EC Ordering Section Summary"
"RTN","ECRRPT",173,0)
 . D QUEUE
"RTN","ECRRPT",174,0)
 D START^ECOSSUM
"RTN","ECRRPT",175,0)
 Q
"RTN","ECRRPT",176,0)
ECPCER ;PCE Data Summary Report for RPC Call
"RTN","ECRRPT",177,0)
 ;     Variables passed in
"RTN","ECRRPT",178,0)
 ;       ECDFN  - Patient IEN for file #2
"RTN","ECRRPT",179,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT",180,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT",181,0)
 ;
"RTN","ECRRPT",182,0)
 ;     Variable return
"RTN","ECRRPT",183,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT",184,0)
 N ECV,ECDATE,ECPAT,ECROU,ECDESC,X,DIC,Y
"RTN","ECRRPT",185,0)
 S ECV="ECDFN^ECSD^ECED" D REQCHK(ECV) I ECERR Q
"RTN","ECRRPT",186,0)
 S DIC=2,DIC(0)="QNMZX",X=ECDFN D ^DIC D:Y<0  Q:Y<0  S ECPAT=$P(Y,U,2)
"RTN","ECRRPT",187,0)
 . S ^TMP("ECMSG",$J)="1^Invalid Provider."
"RTN","ECRRPT",188,0)
 D DATECHK(.ECSD,.ECED)
"RTN","ECRRPT",189,0)
 S ECSD=ECSD-.0001,ECED=ECED+.9999
"RTN","ECRRPT",190,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT",191,0)
 . S ECV="ECDFN^ECPAT^ECDATE^ECSD^ECED",ECROU="SUM^ECPCER"
"RTN","ECRRPT",192,0)
 . S ECDESC="ECS/PCE PATIENT SUMMARY"
"RTN","ECRRPT",193,0)
 . D QUEUE
"RTN","ECRRPT",194,0)
 D SUM^ECPCER
"RTN","ECRRPT",195,0)
 Q
"RTN","ECRRPT",196,0)
ECRDSSA ;DSS Unit Activity Report
"RTN","ECRRPT",197,0)
 ;     Variables passed in
"RTN","ECRRPT",198,0)
 ;       ECL    - Location to report (1 or ALL)
"RTN","ECRRPT",199,0)
 ;       ECD0   - DSS Unit to report (1, some or ALL)
"RTN","ECRRPT",200,0)
 ;       ECSORT  - Sort type(P,S or R)
"RTN","ECRRPT",201,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT",202,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT",203,0)
 ;       ECDUZ  - User IEN from file (#200)
"RTN","ECRRPT",204,0)
 ;
"RTN","ECRRPT",205,0)
 ;     Variable return
"RTN","ECRRPT",206,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT",207,0)
 N ECLOC,ECDSSU,ECV,ECI,ECSTDT,ECENDDT,ECKEY,ECROU,ECSAVE,ECDESC,ECNT
"RTN","ECRRPT",208,0)
 N ECDATE,ECX,DIC,X,Y
"RTN","ECRRPT",209,0)
 S ECV="ECL^ECD0^ECSORT^ECSD^ECED^ECDUZ" D REQCHK(ECV) I ECERR Q
"RTN","ECRRPT",210,0)
 D  I '$D(ECLOC) S ^TMP("ECMSG",$J)="1^Invalid Location." Q
"RTN","ECRRPT",211,0)
 . I ECL="ALL" D LOCARRY^ECRUTL Q
"RTN","ECRRPT",212,0)
 . S DIC=4,DIC(0)="QNZX",X=ECL D ^DIC Q:Y<0  S ECLOC(1)=+Y_"^"_$P(Y,U,2)
"RTN","ECRRPT",213,0)
 D  I '$D(ECDSSU) S ^TMP("ECMSG",$J)="1^Invalid DSS Unit." Q
"RTN","ECRRPT",214,0)
 . I ECD0="ALL" D  Q
"RTN","ECRRPT",215,0)
 . . S ECKEY=$S($D(^XUSEC("ECALLU",ECDUZ)):1,1:0) D ALLU^ECRUTL
"RTN","ECRRPT",216,0)
 . S (ECI,ECNT)=0 F ECI=0:1 S ECX="ECD"_ECI Q:'$D(@ECX)  D
"RTN","ECRRPT",217,0)
 . . K DIC S DIC=724,DIC(0)="QNZX",X=@ECX D ^DIC I Y<0 Q
"RTN","ECRRPT",218,0)
 . . S ECNT=ECNT+1,ECDSSU(ECNT)=Y
"RTN","ECRRPT",219,0)
 D DATECHK(.ECSD,.ECED)
"RTN","ECRRPT",220,0)
 S ECSTDT=ECSD-.0001,ECENDDT=ECED+.9999
"RTN","ECRRPT",221,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT",222,0)
 . S ECV="ECSORT^ECDATE^ECSTDT^ECENDDT",ECROU="STRPT^ECRDSSA"
"RTN","ECRRPT",223,0)
 . S (ECSAVE("ECLOC("),ECSAVE("ECDSSU("))=""
"RTN","ECRRPT",224,0)
 . S ECDESC="DSS UNIT ACTIVITY REPORT"
"RTN","ECRRPT",225,0)
 . D QUEUE
"RTN","ECRRPT",226,0)
 D STRPT^ECRDSSA
"RTN","ECRRPT",227,0)
 Q
"RTN","ECRRPT1")
0^14^B51929894
"RTN","ECRRPT1",1,0)
ECRRPT1 ;ALB/JAM;Event Capture Report RPC Broker ;10 JUL 2008
"RTN","ECRRPT1",2,0)
 ;;2.0; EVENT CAPTURE ;**25,32,33,61,78,72,90,95**;8 May 96;Build 26
"RTN","ECRRPT1",3,0)
 ;
"RTN","ECRRPT1",4,0)
ECRPRSN ;Procedure Reason Report for RPC Call
"RTN","ECRRPT1",5,0)
 ;     Variables passed in
"RTN","ECRRPT1",6,0)
 ;       ECSD     - Start Date or Report
"RTN","ECRRPT1",7,0)
 ;       ECED     - End Date or Report
"RTN","ECRRPT1",8,0)
 ;       ECL      - Location to report (1 or ALL)
"RTN","ECRRPT1",9,0)
 ;       ECD0..n  - DSS Unit to report (1,some or ALL)
"RTN","ECRRPT1",10,0)
 ;       ECRY0..n - Procedure reason (some or ALL)
"RTN","ECRRPT1",11,0)
 ;
"RTN","ECRRPT1",12,0)
 ;     Variable return
"RTN","ECRRPT1",13,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT1",14,0)
 N ECV,ECI,ECLOC,ECDSSU,ECDN,ECDATE,ECUN,ECNT,ECKEY,ECX,ECLINK,ECZ
"RTN","ECRRPT1",15,0)
 N ECROU,ECSAVE,ECDESC,ECW,DIC,X,Y
"RTN","ECRRPT1",16,0)
 S ECV="ECL^ECD0^ECSD^ECED^ECRY0" D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",17,0)
 D  I '$D(ECLOC) S ^TMP("ECMSG",$J)="1^Invalid Location." Q
"RTN","ECRRPT1",18,0)
 . I ECL="ALL" D LOCARRY^ECRUTL Q
"RTN","ECRRPT1",19,0)
 . S DIC=4,DIC(0)="QNMZX",X=ECL D ^DIC Q:Y<0  S ECLOC(1)=+Y_"^"_$P(Y,U,2)
"RTN","ECRRPT1",20,0)
 D  I '$D(ECDSSU) S ^TMP("ECMSG",$J)="1^Invalid DSS Unit." Q
"RTN","ECRRPT1",21,0)
 . I ECD0="ALL" D  Q
"RTN","ECRRPT1",22,0)
 . . I '$D(ECDUZ) Q
"RTN","ECRRPT1",23,0)
 . . S ECKEY=$S($D(^XUSEC("ECALLU",ECDUZ)):1,1:0) D ALLU^ECRUTL
"RTN","ECRRPT1",24,0)
 . S (ECI,ECNT)=0 F ECI=0:1 S ECX="ECD"_ECI Q:'$D(@ECX)  D
"RTN","ECRRPT1",25,0)
 . . K DIC S DIC=724,DIC(0)="QNMZX",X=@ECX D ^DIC I Y<0 Q
"RTN","ECRRPT1",26,0)
 . . S ECNT=ECNT+1,ECDSSU(ECNT)=Y
"RTN","ECRRPT1",27,0)
 S ECX=0 D
"RTN","ECRRPT1",28,0)
 .I ECRY0="ALL" D PXREAS Q
"RTN","ECRRPT1",29,0)
 .N TLOC,TDSS,ECY
"RTN","ECRRPT1",30,0)
 .S ECI=0 F  S ECI=$O(ECLOC(ECI)) Q:'ECI  S TLOC(+ECLOC(ECI))=""
"RTN","ECRRPT1",31,0)
 .S ECI=0 F  S ECI=$O(ECDSSU(ECI)) Q:'ECI  S TDSS(+ECDSSU(ECI))=""
"RTN","ECRRPT1",32,0)
 .S ECI=0 F ECI=0:1 S ECZ="ECRY"_ECI Q:'$D(@ECZ)  D
"RTN","ECRRPT1",33,0)
 ..S ECW=0 F  S ECW=$O(^ECL("B",@ECZ,ECW)) Q:'ECW  D
"RTN","ECRRPT1",34,0)
 ...S ECY=$P($G(^ECL(ECW,0)),U,2) Q:ECY=""  S ECJ=$P($G(^ECJ(ECY,0)),U)
"RTN","ECRRPT1",35,0)
 ...Q:ECJ=""  Q:'$D(TLOC($P(ECJ,"-")))  Q:'$D(TDSS($P(ECJ,"-",2)))
"RTN","ECRRPT1",36,0)
 ...S ECLINK(ECW)=$P($G(^ECL(ECW,0)),U)
"RTN","ECRRPT1",37,0)
 D DATECHK^ECRRPT(.ECSD,.ECED) S ECSD=ECSD-.0001,ECED=ECED+.9999
"RTN","ECRRPT1",38,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT1",39,0)
 . S ECV="ECSD^ECED",ECROU="START^ECRPRSN"
"RTN","ECRRPT1",40,0)
 . S (ECSAVE("ECLOC("),ECSAVE("ECDSSU("),ECSAVE("ECLINK("))=""
"RTN","ECRRPT1",41,0)
 . S ECDESC="EC Procedure Reason Report"
"RTN","ECRRPT1",42,0)
 . D QUEUE^ECRRPT
"RTN","ECRRPT1",43,0)
 D START^ECRPRSN,EXIT^ECRPRSN
"RTN","ECRRPT1",44,0)
 Q
"RTN","ECRRPT1",45,0)
PXREAS ;Procedure reason link
"RTN","ECRRPT1",46,0)
 N ECZ,ECX,ECY,ECV
"RTN","ECRRPT1",47,0)
 S ECX=0 F  S ECX=$O(ECLOC(ECX)) Q:'ECX  S ECY=0 D
"RTN","ECRRPT1",48,0)
 . F  S ECY=$O(ECDSSU(ECY)) Q:'ECY  S ECV=+ECLOC(ECX)_"-"_+ECDSSU(ECY) D
"RTN","ECRRPT1",49,0)
 . . S ECZ=ECV_"-0-0"
"RTN","ECRRPT1",50,0)
 . . F  S ECZ=$O(^ECJ("B",ECZ)) Q:('ECZ)!($P(ECZ,"-",1,2)'=ECV)  D
"RTN","ECRRPT1",51,0)
 . . . S ECW=$O(^ECJ("B",ECZ,"")) Q:ECW=""  D REALNK
"RTN","ECRRPT1",52,0)
 Q
"RTN","ECRRPT1",53,0)
REALNK ;Reason link
"RTN","ECRRPT1",54,0)
 N XX,YY,ZZ
"RTN","ECRRPT1",55,0)
 S XX=0 F  S XX=$O(^ECL("AD",ECW,XX)) Q:'XX  S YY=0 D
"RTN","ECRRPT1",56,0)
 . F  S YY=$O(^ECL("AD",ECW,XX,YY)) Q:'YY  D
"RTN","ECRRPT1",57,0)
 . . Q:$G(^ECL(YY,0))=""  S ECLINK(YY)=XX
"RTN","ECRRPT1",58,0)
 Q
"RTN","ECRRPT1",59,0)
ECRPERS ;Inactive Person Class Report for RPC Call
"RTN","ECRRPT1",60,0)
 ;     Variables passed in
"RTN","ECRRPT1",61,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT1",62,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT1",63,0)
 ;       ECSORT - Sort by Patient (P) or Provider (R)
"RTN","ECRRPT1",64,0)
 ;
"RTN","ECRRPT1",65,0)
 ;     Variable return
"RTN","ECRRPT1",66,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT1",67,0)
 N ECV,ECDATE,ECBEGIN,ECEND,ECROU,ECDESC
"RTN","ECRRPT1",68,0)
 S ECV="ECSD^ECED^ECSORT" D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",69,0)
 D DATECHK^ECRRPT(.ECSD,.ECED)
"RTN","ECRRPT1",70,0)
 S ECBEGIN=ECSD-.0001,ECEND=ECED+.9999
"RTN","ECRRPT1",71,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT1",72,0)
 . S ECV="ECBEGIN^ECEND^ECSORT",ECROU="START^ECRPCLS"
"RTN","ECRRPT1",73,0)
 . S ECDESC="EC Invalid Provider Report"
"RTN","ECRRPT1",74,0)
 . D QUEUE^ECRRPT
"RTN","ECRRPT1",75,0)
 D START^ECRPCLS
"RTN","ECRRPT1",76,0)
 Q
"RTN","ECRRPT1",77,0)
ECDSS1 ;National/Local Procedure Reports for RPC Call
"RTN","ECRRPT1",78,0)
 ;     Variables passed in
"RTN","ECRRPT1",79,0)
 ;       ECRTN    - Procedure Report (A-active or I-inactive)
"RTN","ECRRPT1",80,0)
 ;    If ECRTN=A, also
"RTN","ECRRPT1",81,0)
 ;       ECRN     - Preferred Report (N-ational, L-ocal or Both)
"RTN","ECRRPT1",82,0)
 ;       ECRD     - Sort Method (P-rocedure Name, N-ational Number)
"RTN","ECRRPT1",83,0)
 ;
"RTN","ECRRPT1",84,0)
 ;     Variable return
"RTN","ECRRPT1",85,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT1",86,0)
 N ECV,ECDESC,ECROU,DQTIME
"RTN","ECRRPT1",87,0)
 S ECV=$S($G(ECRTN)="A":"ECRTN^ECRN^ECRD",1:"ECRTN")
"RTN","ECRRPT1",88,0)
 D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",89,0)
 S DQTIME=ECQDT
"RTN","ECRRPT1",90,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT1",91,0)
 . S ECV="ECRTN^ECRN^ECRD",ECROU=$S(ECRTN="I":"LISTI",1:"PRT")_"^ECDSS1"
"RTN","ECRRPT1",92,0)
 . S ECDESC="Event Capture National Procedure Report",ECDIP=1
"RTN","ECRRPT1",93,0)
 . ;S ECSAVE("IO*")=""
"RTN","ECRRPT1",94,0)
 .D QUEDIP D @$S(ECRTN="I":"LISTI^ECDSS1",1:"PRT^ECDSS1")
"RTN","ECRRPT1",95,0)
 D CLOSE^%ZISH(ECDIRY_ECFILER)
"RTN","ECRRPT1",96,0)
 S %ZIS("HFSNAME")=ECDIRY_ECFILER,%ZIS("HFSMODE")="W",IOP="HFS"
"RTN","ECRRPT1",97,0)
 D @$S(ECRTN="I":"LISTI^ECDSS1",1:"PRT^ECDSS1")
"RTN","ECRRPT1",98,0)
 Q
"RTN","ECRRPT1",99,0)
ECDSS3 ;Category Reports for RPC Call
"RTN","ECRRPT1",100,0)
 ;     Variables passed in
"RTN","ECRRPT1",101,0)
 ;       ECRTN    - Category Procedure Report 
"RTN","ECRRPT1",102,0)
 ;                  (A-active, I-inactive or B-oth)
"RTN","ECRRPT1",103,0)
 ;
"RTN","ECRRPT1",104,0)
 ;     Variable return
"RTN","ECRRPT1",105,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT1",106,0)
 N ECV,ECDIP,DQTIME
"RTN","ECRRPT1",107,0)
 S ECV="ECRTN" D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",108,0)
 S DQTIME=ECQDT
"RTN","ECRRPT1",109,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT1",110,0)
 . S ECV="ECRTN",ECROU="PRINT^ECDSS3"
"RTN","ECRRPT1",111,0)
 . S ECDESC="Event Capture Category Reports"
"RTN","ECRRPT1",112,0)
 . D QUEDIP D PRINT^ECDSS3
"RTN","ECRRPT1",113,0)
 D CLOSE^%ZISH(ECDIRY_ECFILER)
"RTN","ECRRPT1",114,0)
 S %ZIS("HFSNAME")=ECDIRY_ECFILER,%ZIS("HFSMODE")="W",IOP="HFS"
"RTN","ECRRPT1",115,0)
 D PRINT^ECDSS3
"RTN","ECRRPT1",116,0)
 Q
"RTN","ECRRPT1",117,0)
QUEDIP ;Queue when using DIP
"RTN","ECRRPT1",118,0)
 N DIC,X,Y
"RTN","ECRRPT1",119,0)
 D  I Y=-1 S ECERR=1 Q
"RTN","ECRRPT1",120,0)
 . S DIC(0)="MN",X=ECDEV,DIC="^%ZIS(1," D ^DIC
"RTN","ECRRPT1",121,0)
 . S:+Y>0 IOP="Q;"_$P(Y,U,2)
"RTN","ECRRPT1",122,0)
 . S Y=ECQDT X ^DD("DD") S DQTIME=Y
"RTN","ECRRPT1",123,0)
 Q
"RTN","ECRRPT1",124,0)
ECSUM ;Print Category and Procedure Summary (Report) for RPC Call
"RTN","ECRRPT1",125,0)
 ;     Variables passed in
"RTN","ECRRPT1",126,0)
 ;       ECL      - Location to report (1 or ALL)
"RTN","ECRRPT1",127,0)
 ;       ECD      - DSS Unit to report (1 or ALL), If ECD'="ALL" then ECC
"RTN","ECRRPT1",128,0)
 ;       ECC      - Category (1 or ALL) (optional)
"RTN","ECRRPT1",129,0)
 ;       ECRTN    - Event Code Screen (Active, Inactive or Both)
"RTN","ECRRPT1",130,0)
 ;
"RTN","ECRRPT1",131,0)
 ;     Variable return
"RTN","ECRRPT1",132,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT1",133,0)
 N ECV,ECDN,ECCN,ECROU,ECSAVE,ECDESC,ECLOC,ECS,ECJLP,ECSN,ECALL,DIC,X,Y
"RTN","ECRRPT1",134,0)
 N ECSCN
"RTN","ECRRPT1",135,0)
 S (ECJLP,ECALL)=0,ECV="ECL^ECD^ECRTN" D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",136,0)
 D  I '$D(ECLOC) S ^TMP("ECMSG",$J)="1^Invalid Location." Q
"RTN","ECRRPT1",137,0)
 . I ECL="ALL" D LOCARRY^ECRUTL Q
"RTN","ECRRPT1",138,0)
 . S DIC=4,DIC(0)="QNZX",X=ECL D ^DIC Q:Y<0  S ECLOC(1)=+Y_U_$P(Y,U,2)
"RTN","ECRRPT1",139,0)
 S ECSCN=ECRTN D  I ECERR S ^TMP("ECMSG",$J)="1^Invalid DSS Unit." Q
"RTN","ECRRPT1",140,0)
 . I ECD="ALL" S ECALL=1 Q
"RTN","ECRRPT1",141,0)
 . K DIC S DIC=724,DIC(0)="QNMZX",X=ECD D ^DIC I Y<0 S ECERR=1 Q
"RTN","ECRRPT1",142,0)
 . S ECDN=$P(Y,U,2)_$S($P($G(^ECD(+ECD,0)),"^",6):" **Inactive**",1:"")
"RTN","ECRRPT1",143,0)
 . S ECS=+$P(^ECD(ECD,0),"^",2),ECJLP=+$P(^(0),"^",11)
"RTN","ECRRPT1",144,0)
 . S ECSN=$S($P($G(^DIC(49,ECS,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECRRPT1",145,0)
 . I 'ECJLP S ECC=0,ECCN="None"
"RTN","ECRRPT1",146,0)
 I ECALL D PXRUN Q
"RTN","ECRRPT1",147,0)
 S ECV="ECC" D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",148,0)
 D  I ECERR S ^TMP("ECMSG",$J)="1^Invalid Category." Q
"RTN","ECRRPT1",149,0)
 . I (ECC="ALL")!(ECC=0) Q
"RTN","ECRRPT1",150,0)
 . K DIC S DIC=726,DIC(0)="QNMZX",X=ECC D ^DIC I Y<0 S ECERR=1 Q
"RTN","ECRRPT1",151,0)
 . S ECCN=$P(Y,U,2)
"RTN","ECRRPT1",152,0)
PXRUN I ECPTYP="P" D  Q
"RTN","ECRRPT1",153,0)
 . S ECV="ECALL^ECSCN",ECROU="START^ECSUM"
"RTN","ECRRPT1",154,0)
 . S ECSAVE("ECLOC(")=""
"RTN","ECRRPT1",155,0)
 . I 'ECALL S ECV=ECV_"^ECD^ECC^ECSN^ECDN^ECJLP^ECCN^ECSCN"
"RTN","ECRRPT1",156,0)
 . S ECDESC="EC Print Category and Procedure Summary"
"RTN","ECRRPT1",157,0)
 . D QUEUE^ECRRPT
"RTN","ECRRPT1",158,0)
 U IO D START^ECSUM
"RTN","ECRRPT1",159,0)
 Q
"RTN","ECRRPT1",160,0)
ECNTPCE ;ECS Records Failing Transmission to PCE
"RTN","ECRRPT1",161,0)
 ;     Variables passed in
"RTN","ECRRPT1",162,0)
 ;       ECSD   - Start Date or Report
"RTN","ECRRPT1",163,0)
 ;       ECED   - End Date or Report
"RTN","ECRRPT1",164,0)
 ;
"RTN","ECRRPT1",165,0)
 ;     Variable return
"RTN","ECRRPT1",166,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT1",167,0)
 N ECV,ECDATE,ECROU,ECDESC
"RTN","ECRRPT1",168,0)
 S ECV="ECSD^ECED" D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",169,0)
 D DATECHK^ECRRPT(.ECSD,.ECED)
"RTN","ECRRPT1",170,0)
 S ECSD=ECSD-.0001,ECED=ECED+.9999
"RTN","ECRRPT1",171,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT1",172,0)
 . S ECV="ECSD^ECED^ECDATE",ECROU="START^ECNTPCE"
"RTN","ECRRPT1",173,0)
 . S ECDESC="ECS Records Failing Transmission to PCE Report"
"RTN","ECRRPT1",174,0)
 . D QUEUE^ECRRPT
"RTN","ECRRPT1",175,0)
 D START^ECNTPCE
"RTN","ECRRPT1",176,0)
 Q
"RTN","ECRRPT1",177,0)
ECSCPT ;Event Code Screens with CPT Codes
"RTN","ECRRPT1",178,0)
 ;     Variables passed in
"RTN","ECRRPT1",179,0)
 ;       ECL      - Location to report (1 or ALL)
"RTN","ECRRPT1",180,0)
 ;       ECD      - DSS Unit to report (1 or ALL), If ECD'="ALL" then ECC
"RTN","ECRRPT1",181,0)
 ;       ECC      - Category (1 or ALL) (optional)
"RTN","ECRRPT1",182,0)
 ;       ECCPT    - CPT Codes to Display (Active, Inactive or Both)
"RTN","ECRRPT1",183,0)
 ;
"RTN","ECRRPT1",184,0)
 ;     Variable return
"RTN","ECRRPT1",185,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT1",186,0)
 N ECV,ECDN,ECCN,ECROU,ECSAVE,ECDESC,ECLOC,ECS,ECJLP,ECALL,DIC,X,Y
"RTN","ECRRPT1",187,0)
 S (ECJLP,ECALL)=0,ECV="ECL^ECD^ECCPT" D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",188,0)
 D  I '$D(ECLOC) S ^TMP("ECMSG",$J)="1^Invalid Location." Q
"RTN","ECRRPT1",189,0)
 . I ECL="ALL" D LOCARRY^ECRUTL Q
"RTN","ECRRPT1",190,0)
 . S DIC=4,DIC(0)="QNZX",X=ECL D ^DIC Q:Y<0  S ECLOC(1)=+Y_U_$P(Y,U,2)
"RTN","ECRRPT1",191,0)
 D  I ECERR S ^TMP("ECMSG",$J)="1^Invalid DSS Unit." Q
"RTN","ECRRPT1",192,0)
 . I ECD="ALL" S ECALL=1 Q
"RTN","ECRRPT1",193,0)
 . K DIC S DIC=724,DIC(0)="QNMZX",X=ECD D ^DIC I Y<0 S ECERR=1 Q
"RTN","ECRRPT1",194,0)
 . S ECDN=$P(Y,U,2)_$S($P($G(^ECD(+ECD,0)),"^",6):" **Inactive**",1:"")
"RTN","ECRRPT1",195,0)
 . S ECJLP=+$P(^ECD(ECD,0),"^",11)
"RTN","ECRRPT1",196,0)
 . I 'ECJLP S ECC=0,ECCN="None"
"RTN","ECRRPT1",197,0)
 I ECALL D CPTRUN Q
"RTN","ECRRPT1",198,0)
 S ECV="ECC" D REQCHK^ECRRPT(ECV) I ECERR Q
"RTN","ECRRPT1",199,0)
 D  I ECERR S ^TMP("ECMSG",$J)="1^Invalid Category." Q
"RTN","ECRRPT1",200,0)
 . I (ECC="ALL")!(ECC=0) Q
"RTN","ECRRPT1",201,0)
 . K DIC S DIC=726,DIC(0)="QNMZX",X=ECC D ^DIC I Y<0 S ECERR=1 Q
"RTN","ECRRPT1",202,0)
 . S ECCN=$P(Y,U,2)
"RTN","ECRRPT1",203,0)
CPTRUN I ECPTYP="P" D  Q
"RTN","ECRRPT1",204,0)
 . S ECV="ECALL^ECCPT",ECROU="START^ECSCPT"
"RTN","ECRRPT1",205,0)
 . S ECSAVE("ECLOC(")=""
"RTN","ECRRPT1",206,0)
 . I 'ECALL S ECV=ECV_"^ECD^ECC^ECDN^ECJLP^ECCN"
"RTN","ECRRPT1",207,0)
 . S ECDESC="Event Code Screens with CPT Codes"
"RTN","ECRRPT1",208,0)
 . D QUEUE^ECRRPT
"RTN","ECRRPT1",209,0)
 U IO D START^ECSCPT
"RTN","ECRRPT1",210,0)
 Q
"RTN","ECRRPT1",211,0)
ECINCPT ;National/Local Procedure Codes with Inactive CPT Reports for RPC Call
"RTN","ECRRPT1",212,0)
 ;     Variables passed in
"RTN","ECRRPT1",213,0)
 ;       NONE     - No input variables
"RTN","ECRRPT1",214,0)
 ;
"RTN","ECRRPT1",215,0)
 ;     Variable return
"RTN","ECRRPT1",216,0)
 ;       ^TMP($J,"ECRPT",n)=report output or to print device.
"RTN","ECRRPT1",217,0)
 N ECV,ECL,ECDESC,ECROU,DQTIME,ECPG
"RTN","ECRRPT1",218,0)
 S ECPG=1
"RTN","ECRRPT1",219,0)
 I ECPTYP="P" D  Q
"RTN","ECRRPT1",220,0)
 . S ECROU="START^ECINCPT",ECV="ECL",ECL=""
"RTN","ECRRPT1",221,0)
 . S ECDESC="National/Local Procedure Codes with Inactive CPT"
"RTN","ECRRPT1",222,0)
 . D QUEUE^ECRRPT
"RTN","ECRRPT1",223,0)
 U IO D START^ECINCPT
"RTN","ECRRPT1",224,0)
 Q
"RTN","ECSCPT")
0^21^B11029333
"RTN","ECSCPT",1,0)
ECSCPT ;ALB/JAM - Event Code Screen With CPT Codes ; 8 Nov 07
"RTN","ECSCPT",2,0)
 ;;2.0; EVENT CAPTURE ;**72,92,95**;8 May 96;Build 26
"RTN","ECSCPT",3,0)
LOC K ECL S EC1=0 D ^ECL S:$D(LOC(2)) EC1=1 K LOC I '$D(ECL) S ECOUT=1 G END
"RTN","ECSCPT",4,0)
UNIT ;set var and sel dss unit
"RTN","ECSCPT",5,0)
 S ECJLP=0
"RTN","ECSCPT",6,0)
 S (ECOUT,ECALL)=0,ECPG=1
"RTN","ECSCPT",7,0)
 W @IOF F Q=0:0 D  Q:%
"RTN","ECSCPT",8,0)
 .W !!,"Do you want to list all DSS Units for "_ECLN S %=1 D YN^DICN Q:%
"RTN","ECSCPT",9,0)
 .W !!?5,"Enter <RET> to list all your DSS Units for this location, or"
"RTN","ECSCPT",10,0)
 .W !?11,"NO to select a specific DSS Unit"
"RTN","ECSCPT",11,0)
 G:%<0 END I %=1 S ECALL=1 G ECCPT
"RTN","ECSCPT",12,0)
 W @IOF,! K DIC S DIC=724,DIC(0)="QEAMZ",DIC("A")="Select DSS Unit: "
"RTN","ECSCPT",13,0)
 S:ECL DIC("S")="I $D(^ECJ(""AP"",ECL,+Y))"
"RTN","ECSCPT",14,0)
 D ^DIC K DIC G:Y<0 END S ECD=+Y,ECDN=$P(Y,"^",2)
"RTN","ECSCPT",15,0)
 S ECDN=ECDN_$S($P($G(^ECD(+ECD,0)),"^",6):" **Inactive**",1:"")
"RTN","ECSCPT",16,0)
 S ECJLP=+$P(^ECD(ECD,0),"^",11)
"RTN","ECSCPT",17,0)
SEL ;
"RTN","ECSCPT",18,0)
 I 'ECJLP S ECC=0,ECCN="None" G ECCPT
"RTN","ECSCPT",19,0)
 W @IOF F Q=0:0 D  Q:%
"RTN","ECSCPT",20,0)
 .W !!,"Do you want to list all categories for "_ECDN S %=1 D YN^DICN Q:%
"RTN","ECSCPT",21,0)
 .W !!,"Enter <RET> if you would like to list all categories for this "
"RTN","ECSCPT",22,0)
 .W "DSS Unit,",!," or NO to select a specific category"
"RTN","ECSCPT",23,0)
 G:%<0 END I %=1 S ECC="ALL" G ECCPT
"RTN","ECSCPT",24,0)
 W @IOF,! K DIC S DIC=726,DIC(0)="QEAMZ",DIC("A")="Select Category for "
"RTN","ECSCPT",25,0)
 S DIC("A")=DIC("A")_ECDN_" DSS Unit:  "
"RTN","ECSCPT",26,0)
 S:ECD DIC("S")="I $D(^ECJ(""AP"",ECL,ECD,+Y))"
"RTN","ECSCPT",27,0)
 D ^DIC K DIC G:Y<0 END S ECC=+Y,ECCN=$P(Y,"^",2)
"RTN","ECSCPT",28,0)
ECCPT ;CPT Codes to display
"RTN","ECSCPT",29,0)
 K DIR
"RTN","ECSCPT",30,0)
 S DIR(0)="SO^A:Active CPT Codes;I:Inactive CPT Codes;B:Both"
"RTN","ECSCPT",31,0)
 S DIR("B")="I",DIR("A")="CPT Codes to display"
"RTN","ECSCPT",32,0)
 S DIR("?",1)="Enter an A for Event Code screens with Active CPT Codes,"
"RTN","ECSCPT",33,0)
 S DIR("?",1)=DIR("?",1)_" I for Inactive Codes,"
"RTN","ECSCPT",34,0)
 S DIR("?")="B for a consolidated report of CPT codes, or ^ to quit."
"RTN","ECSCPT",35,0)
 S DIR("??")="ECSCPT^"
"RTN","ECSCPT",36,0)
 D ^DIR K DIR I $D(DIRUT) G END
"RTN","ECSCPT",37,0)
 S ECCPT=Y
"RTN","ECSCPT",38,0)
DEV W !! K IOP,POP,IO("Q"),%ZIS,ZTSK
"RTN","ECSCPT",39,0)
 S %ZIS="QM",%ZIS("A")="Select Device:  " D ^%ZIS I POP S ECOUT=1 G END
"RTN","ECSCPT",40,0)
 I $D(IO("Q")) K IO("Q") D  G END
"RTN","ECSCPT",41,0)
 .S ZTDESC="CATEGORY AND PROCEDURE SUMMARY",ZTRTN="START^ECSCPT",ZTIO=ION
"RTN","ECSCPT",42,0)
 .D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK
"RTN","ECSCPT",43,0)
 U IO
"RTN","ECSCPT",44,0)
START ;
"RTN","ECSCPT",45,0)
 N ECI  ;generic index
"RTN","ECSCPT",46,0)
 N ECL  ;location IEN
"RTN","ECSCPT",47,0)
 N ECLN  ;location name
"RTN","ECSCPT",48,0)
 S %H=$H D YX^%DTC S ECRDT=Y
"RTN","ECSCPT",49,0)
 S ECOUT=0,ECPG=1
"RTN","ECSCPT",50,0)
 S ECI=0
"RTN","ECSCPT",51,0)
 F  S ECI=$O(ECLOC(ECI)) Q:'ECI  D
"RTN","ECSCPT",52,0)
 . S ECL=$P(ECLOC(ECI),U),ECLN=$P(ECLOC(ECI),U,2)
"RTN","ECSCPT",53,0)
 . D ^ECSCPT1
"RTN","ECSCPT",54,0)
CLEAR I $E(IOST,1,2)'="C-" G END
"RTN","ECSCPT",55,0)
 G:ECOUT END
"RTN","ECSCPT",56,0)
 I ECPG W !!!!!,"Press <RET> to continue  " R X:DTIME I '$T!(X="^") S ECOUT=1 G END
"RTN","ECSCPT",57,0)
 G:ECALL END
"RTN","ECSCPT",58,0)
ASK ;
"RTN","ECSCPT",59,0)
 W @IOF F Q=0:0 D  I % Q
"RTN","ECSCPT",60,0)
 .W !!,"Would you like to list another DSS Unit for this Location"
"RTN","ECSCPT",61,0)
 .S %=2 D YN^DICN I % Q
"RTN","ECSCPT",62,0)
 .W !!,"Enter YES to list another DSS Unit or <RET> to continue"
"RTN","ECSCPT",63,0)
 G:%<0 END I %=1 D  G UNIT
"RTN","ECSCPT",64,0)
 .K ECD,ECDN,ECC,ECCN,ECP,ECPN,NATN,ECFILE,ECCPT
"RTN","ECSCPT",65,0)
 K ECD,ECDN,ECC,ECCN,ECP,ECPN,NATN,ECFILE,ECCPT
"RTN","ECSCPT",66,0)
 I EC1 G LOC
"RTN","ECSCPT",67,0)
END ;
"RTN","ECSCPT",68,0)
 D ^ECKILL Q:$D(ECGUI)  W @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECSCPT",69,0)
 Q
"RTN","ECSCPT",70,0)
SAVE ;
"RTN","ECSCPT",71,0)
 S (ZTSAVE("ECALL"),ZTSAVE("ECJLP"),ZTSAVE("ECC*"),ZTSAVE("ECD*"),ZTSAVE("ECL*"),ZTSAVE("ECP*"))=""
"RTN","ECSCPT",72,0)
 Q
"RTN","ECSCPT1")
0^22^B9008177
"RTN","ECSCPT1",1,0)
ECSCPT1 ;ALB/JAM - Event Code Screens with CPT Codes ; 8 Nov 07
"RTN","ECSCPT1",2,0)
 ;;2.0; EVENT CAPTURE ;**72,95**;8 May 96;Build 26
"RTN","ECSCPT1",3,0)
EN ;entry point
"RTN","ECSCPT1",4,0)
 N UCNT,ECDO,ECCO,ECNT,ECINDT,ECP0
"RTN","ECSCPT1",5,0)
 S (ECMORE,ECNT,ECDO,ECCO)=0,ECPG=$G(ECPG,1),ECCPT=$G(ECCPT,"B")
"RTN","ECSCPT1",6,0)
 ;Process all DSS Units
"RTN","ECSCPT1",7,0)
 I ECALL S ECD=0 D  G END
"RTN","ECSCPT1",8,0)
 .F  S ECD=$O(^ECJ("AP",ECL,ECD)) Q:'ECD  D  Q:ECOUT
"RTN","ECSCPT1",9,0)
 ..D SET,CATS,PAGE:'ECOUT&UCNT
"RTN","ECSCPT1",10,0)
 ;Process a specific DSS Unit
"RTN","ECSCPT1",11,0)
 S UCNT=0 D
"RTN","ECSCPT1",12,0)
 .I ECC="ALL" D CATS Q
"RTN","ECSCPT1",13,0)
 .I 'ECJLP S ECC=0,ECCN="None",ECCO=999
"RTN","ECSCPT1",14,0)
 .D PROC
"RTN","ECSCPT1",15,0)
END I 'ECNT W !!!,"Nothing Found."
"RTN","ECSCPT1",16,0)
 S ECPG=$G(ECPG,1)
"RTN","ECSCPT1",17,0)
 Q
"RTN","ECSCPT1",18,0)
SET ;set var
"RTN","ECSCPT1",19,0)
 S ECDN=$S($P($G(^ECD(+ECD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN"),UCNT=0
"RTN","ECSCPT1",20,0)
 S ECDN=ECDN_$S($P($G(^ECD(+ECD,0)),"^",6):" **Inactive**",1:"")
"RTN","ECSCPT1",21,0)
 Q
"RTN","ECSCPT1",22,0)
SETC ;set cats
"RTN","ECSCPT1",23,0)
 I ECC=0 S ECCN="None" Q
"RTN","ECSCPT1",24,0)
 S ECCN=$S($P($G(^EC(726,+ECC,0)),"^")]"":$P(^(0),"^"),1:"ZZ #"_ECC_" MISSING DATA")
"RTN","ECSCPT1",25,0)
 S ECMORE=1
"RTN","ECSCPT1",26,0)
 Q
"RTN","ECSCPT1",27,0)
HEADER ;
"RTN","ECSCPT1",28,0)
 W:$E(IOST,1,2)="C-"!(ECPG>1) @IOF
"RTN","ECSCPT1",29,0)
 W !!,?24,"EVENT CODE SCREENS WITH"
"RTN","ECSCPT1",30,0)
 W $S(ECCPT="I":" INACTIVE",ECCPT="A":" ACTIVE",1:"")_" CPT CODES"
"RTN","ECSCPT1",31,0)
 W ?70,"Page: ",ECPG,!?25,"Run Date: ",ECRDT,!?25,"LOCATION:  "_ECLN
"RTN","ECSCPT1",32,0)
 W !?25,"DSS UNIT:  "_ECDN,! S ECPG=ECPG+1
"RTN","ECSCPT1",33,0)
 F I=1:1:80 W "-"
"RTN","ECSCPT1",34,0)
 Q
"RTN","ECSCPT1",35,0)
CATS ;
"RTN","ECSCPT1",36,0)
 S ECC="",ECCO=0
"RTN","ECSCPT1",37,0)
 F  S ECC=$O(^ECJ("AP",ECL,ECD,ECC)) Q:ECC=""  D SETC,PROC Q:ECOUT
"RTN","ECSCPT1",38,0)
 S ECMORE=0
"RTN","ECSCPT1",39,0)
 Q
"RTN","ECSCPT1",40,0)
PROC ;
"RTN","ECSCPT1",41,0)
 S ECP=""
"RTN","ECSCPT1",42,0)
 F  S ECP=$O(^ECJ("AP",ECL,ECD,ECC,ECP)) Q:ECP=""  D SETP Q:ECOUT
"RTN","ECSCPT1",43,0)
 S ECMORE=0
"RTN","ECSCPT1",44,0)
 Q
"RTN","ECSCPT1",45,0)
SETP ;set procs
"RTN","ECSCPT1",46,0)
 S ECPSY=+$O(^ECJ("AP",ECL,ECD,ECC,ECP,"")),ECPI=""
"RTN","ECSCPT1",47,0)
 S ECPSYN=$P($G(^ECJ(ECPSY,"PRO")),"^",2),ECFILE=$P(ECP,";",2)
"RTN","ECSCPT1",48,0)
 S ECFILE=$S($E(ECFILE)="I":81,$E(ECFILE)="E":725,1:"")
"RTN","ECSCPT1",49,0)
 I ECFILE="" Q
"RTN","ECSCPT1",50,0)
 S (ECPN,ECPT,NATN)="",ECPI=0
"RTN","ECSCPT1",51,0)
 I ECFILE=81 S ECPI=$$CPT^ICPTCOD(+ECP) I +ECPI>0 D
"RTN","ECSCPT1",52,0)
 .S ECPN=$P(ECPI,"^",3),ECPT=$P(ECPI,"^",2),ECINDT=$P(ECPI,"^",7)
"RTN","ECSCPT1",53,0)
 I ECFILE=725 D
"RTN","ECSCPT1",54,0)
 .S ECP0=$G(^EC(725,+ECP,0)),ECPT="",ECPN=$P(ECP0,"^")
"RTN","ECSCPT1",55,0)
 .S NATN=$P(ECP0,"^",2)
"RTN","ECSCPT1",56,0)
 .I $P(ECP0,"^",5)'="" S ECPI=$$CPT^ICPTCOD($P(ECP0,"^",5)) I +ECPI>0 D 
"RTN","ECSCPT1",57,0)
 ..S ECPT=$P(ECPI,"^",2),ECINDT=$P(ECPI,"^",7)
"RTN","ECSCPT1",58,0)
 I +ECPI<1 Q
"RTN","ECSCPT1",59,0)
 I ECCPT="A",'ECINDT Q
"RTN","ECSCPT1",60,0)
 I ECCPT="I",ECINDT Q
"RTN","ECSCPT1",61,0)
 I ECD'=ECDO D HEADER S ECDO=ECD
"RTN","ECSCPT1",62,0)
 I ECC'=ECCO D  S ECCO=ECC I ECOUT Q
"RTN","ECSCPT1",63,0)
 .W !!,"Category:  "_ECCN D:$Y+4>IOSL CONTD
"RTN","ECSCPT1",64,0)
 S ECPN=$S(ECPSYN]"":ECPSYN,1:ECPN),ECNT=ECNT+1,UCNT=UCNT+1
"RTN","ECSCPT1",65,0)
 W !,"Procedure: ",$E(ECPN,1,30)," (",$S(ECFILE=81:"CPT",1:"EC"),")",?48,"Nat'l #: ",NATN,?64,"CPT: ",ECPT
"RTN","ECSCPT1",66,0)
 I ECCPT="B",'ECINDT W ?70," *I*"
"RTN","ECSCPT1",67,0)
 D:($Y+3)>IOSL CONTD I ECOUT Q
"RTN","ECSCPT1",68,0)
 Q
"RTN","ECSCPT1",69,0)
CONTD ;Check whether to continue or exit
"RTN","ECSCPT1",70,0)
 D PAGE I ECOUT Q
"RTN","ECSCPT1",71,0)
 D HEADER:ECPG,MORE:$D(ECCN)
"RTN","ECSCPT1",72,0)
 Q
"RTN","ECSCPT1",73,0)
 ;
"RTN","ECSCPT1",74,0)
PAGE ;
"RTN","ECSCPT1",75,0)
 N SS,JJ
"RTN","ECSCPT1",76,0)
 I $D(ECPG),$E(IOST,1,2)="C-" D
"RTN","ECSCPT1",77,0)
 . S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECSCPT1",78,0)
 . S DIR(0)="E" W ! D ^DIR K DIR I 'Y S ECOUT=1
"RTN","ECSCPT1",79,0)
 Q
"RTN","ECSCPT1",80,0)
MORE I ECMORE W !!,"Category:  "_ECCN
"RTN","ECSCPT1",81,0)
 Q
"RTN","ECSUM")
0^23^B13051883
"RTN","ECSUM",1,0)
ECSUM ;BIR/JLP,RHK-Category and Procedure Summary ;7 Nov 2007
"RTN","ECSUM",2,0)
 ;;2.0; EVENT CAPTURE ;**4,19,33,47,95**;8 May 96;Build 26
"RTN","ECSUM",3,0)
LOC K ECL S EC1=0 D ^ECL S:$D(LOC(2)) EC1=1 K LOC I '$D(ECL) S ECOUT=1 G END
"RTN","ECSUM",4,0)
UNIT ;set var and sel dss unit
"RTN","ECSUM",5,0)
 S ECJLP=0
"RTN","ECSUM",6,0)
 S (ECOUT,ECALL)=0,ECPG=1
"RTN","ECSUM",7,0)
 W @IOF F Q=0:0 D  Q:%
"RTN","ECSUM",8,0)
 .W !!,"Do you want to list all DSS Units for "_ECLN S %=1 D YN^DICN Q:%
"RTN","ECSUM",9,0)
 .W !!?5,"Enter <RET> to list all your DSS Units for this location, or"
"RTN","ECSUM",10,0)
 .W !?11,"NO to select a specific DSS Unit"
"RTN","ECSUM",11,0)
 G:%<0 END I %=1 S ECALL=1 G ECSCN
"RTN","ECSUM",12,0)
 W @IOF,! K DIC S DIC=724,DIC(0)="QEAMZ",DIC("A")="Select DSS Unit: "
"RTN","ECSUM",13,0)
 S:ECL DIC("S")="I $D(^ECJ(""AP"",ECL,+Y))"
"RTN","ECSUM",14,0)
 D ^DIC K DIC G:Y<0 END S ECD=+Y,ECDN=$P(Y,"^",2)
"RTN","ECSUM",15,0)
 S ECDN=ECDN_$S($P($G(^ECD(+ECD,0)),"^",6):" **Inactive**",1:"")
"RTN","ECSUM",16,0)
 S ECS=+$P(^ECD(ECD,0),"^",2),ECJLP=+$P(^(0),"^",11)
"RTN","ECSUM",17,0)
 S ECSN=$S($P($G(^DIC(49,ECS,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECSUM",18,0)
SEL ;
"RTN","ECSUM",19,0)
 I 'ECJLP S ECC=0,ECCN="None" G ECSCN
"RTN","ECSUM",20,0)
 W @IOF F Q=0:0 D  Q:%
"RTN","ECSUM",21,0)
 .W !!,"Do you want to list all categories for "_ECDN S %=1 D YN^DICN Q:%
"RTN","ECSUM",22,0)
 .W !!,"Enter <RET> if you would like to list all categories for this "
"RTN","ECSUM",23,0)
 .W "DSS Unit,",!," or NO to select a specific category"
"RTN","ECSUM",24,0)
 G:%<0 END I %=1 S ECC="ALL" G ECSCN
"RTN","ECSUM",25,0)
 W @IOF,! K DIC S DIC=726,DIC(0)="QEAMZ",DIC("A")="Select Category for "
"RTN","ECSUM",26,0)
 S DIC("A")=DIC("A")_ECDN_" DSS Unit:  "
"RTN","ECSUM",27,0)
 S:ECD DIC("S")="I $D(^ECJ(""AP"",ECL,ECD,+Y))"
"RTN","ECSUM",28,0)
 D ^DIC K DIC G:Y<0 END S ECC=+Y,ECCN=$P(Y,"^",2)
"RTN","ECSUM",29,0)
ECSCN ;Event Codes Screens to display, ALB/JAM-10/16/01
"RTN","ECSUM",30,0)
 K DIR
"RTN","ECSUM",31,0)
 S DIR(0)="SO^A:Active Event Code Screens;I:Inactive Event Code Screens"
"RTN","ECSUM",32,0)
 S DIR(0)=DIR(0)_";B:Both",DIR("B")="A"
"RTN","ECSUM",33,0)
 S DIR("A")="Event Code Screen to display"
"RTN","ECSUM",34,0)
 S DIR("?",1)="Enter an A for Active Event Code Screens, I for Inactive "
"RTN","ECSUM",35,0)
 S DIR("?",1)=DIR("?",1)_"Code Screens,"
"RTN","ECSUM",36,0)
 S DIR("?")="B for a consolidated report of all Event Code Screens, or "
"RTN","ECSUM",37,0)
 S DIR("?")=DIR("?")_"^ to quit."
"RTN","ECSUM",38,0)
 S DIR("??")="ECSUM^"
"RTN","ECSUM",39,0)
 D ^DIR K DIR I $D(DIRUT) G END
"RTN","ECSUM",40,0)
 S ECSCN=Y
"RTN","ECSUM",41,0)
DEV W !! K IOP,POP,IO("Q"),%ZIS,ZTSK
"RTN","ECSUM",42,0)
 S %ZIS="QM",%ZIS("A")="Select Device:  " D ^%ZIS I POP S ECOUT=1 G END
"RTN","ECSUM",43,0)
 I $D(IO("Q")) K IO("Q") D  G END
"RTN","ECSUM",44,0)
 .S ZTDESC="CATEGORY AND PROCEDURE SUMMARY",ZTRTN="START^ECSUM",ZTIO=ION
"RTN","ECSUM",45,0)
 .D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK
"RTN","ECSUM",46,0)
 U IO
"RTN","ECSUM",47,0)
START ;
"RTN","ECSUM",48,0)
 N ECI  ;generic index
"RTN","ECSUM",49,0)
 N ECL  ;location IEN
"RTN","ECSUM",50,0)
 N ECLN  ;location name
"RTN","ECSUM",51,0)
 S %H=$H D YX^%DTC S ECRDT=Y
"RTN","ECSUM",52,0)
 S ECOUT=0,ECPG=1
"RTN","ECSUM",53,0)
 S ECI=0
"RTN","ECSUM",54,0)
 F  S ECI=$O(ECLOC(ECI)) Q:'ECI  D
"RTN","ECSUM",55,0)
 . S ECL=$P(ECLOC(ECI),U),ECLN=$P(ECLOC(ECI),U,2)
"RTN","ECSUM",56,0)
 . I ECALL D
"RTN","ECSUM",57,0)
 . . D ^ECSUM1
"RTN","ECSUM",58,0)
 . E  D SUM2^ECSUM1
"RTN","ECSUM",59,0)
CLEAR I $E(IOST,1,2)'="C-" G END
"RTN","ECSUM",60,0)
 G:ECOUT END
"RTN","ECSUM",61,0)
 I ECPG W !!!!!,"Press <RET> to continue  " R X:DTIME I '$T!(X="^") S ECOUT=1 G END
"RTN","ECSUM",62,0)
 G:ECALL END
"RTN","ECSUM",63,0)
ASK ;
"RTN","ECSUM",64,0)
 W @IOF F Q=0:0 D  I % Q
"RTN","ECSUM",65,0)
 .W !!,"Would you like to list another DSS Unit for this Location"
"RTN","ECSUM",66,0)
 .S %=2 D YN^DICN I % Q
"RTN","ECSUM",67,0)
 .W !!,"Enter YES to list another DSS Unit or <RET> to continue"
"RTN","ECSUM",68,0)
 G:%<0 END I %=1 D  G UNIT
"RTN","ECSUM",69,0)
 .K EC4,ECD,ECDN,ECC,ECCN,ECP,ECPN,ECSY,ECSYN,NATN,ECS,ECSN,ECFILE,ECSCN
"RTN","ECSUM",70,0)
 K EC4,ECD,ECDN,ECC,ECCN,ECP,ECPN,ECSY,ECSYN,NATN,ECS,ECSN,ECFILE,ECSCN
"RTN","ECSUM",71,0)
 I EC1 G LOC
"RTN","ECSUM",72,0)
END ;
"RTN","ECSUM",73,0)
 D ^ECKILL Q:$D(ECGUI)  W @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","ECSUM",74,0)
 Q
"RTN","ECSUM",75,0)
SAVE ;
"RTN","ECSUM",76,0)
 S (ZTSAVE("ECA*"),ZTSAVE("ECJLP"),ZTSAVE("ECC*"),ZTSAVE("ECD*"),ZTSAVE("ECL*"),ZTSAVE("ECM*"),ZTSAVE("ECP*"),ZTSAVE("ECS*"),ZTSAVE("EC4"))=""
"RTN","ECSUM",77,0)
 Q
"RTN","ECSUM1")
0^24^B11875694
"RTN","ECSUM1",1,0)
ECSUM1 ;BIR/JLP,RHK-Category and Procedure Summary (cont'd) ;7 Nov 2007
"RTN","ECSUM1",2,0)
 ;;2.0; EVENT CAPTURE ;**4,19,23,33,47,95**;8 May 96;Build 26
"RTN","ECSUM1",3,0)
ALLU ;
"RTN","ECSUM1",4,0)
 N UCNT,ECDO,ECCO,ECNT
"RTN","ECSUM1",5,0)
 S (ECD,ECMORE,ECNT,ECDO,ECCO)=0,ECPG=$G(ECPG,1),ECSCN=$G(ECSCN,"B")
"RTN","ECSUM1",6,0)
 F  S ECD=$O(^ECJ("AP",ECL,ECD)) Q:'ECD  D  Q:ECOUT
"RTN","ECSUM1",7,0)
 .D SET,CATS,PAGE:'ECOUT&UCNT
"RTN","ECSUM1",8,0)
END I 'ECNT W !!!,"Nothing Found."
"RTN","ECSUM1",9,0)
 S ECPG=$G(ECPG,1)
"RTN","ECSUM1",10,0)
 Q
"RTN","ECSUM1",11,0)
SUM2 ;Prints Categories and Procedures for a DSS Unit
"RTN","ECSUM1",12,0)
 N UCNT,ECDO,ECCO,ECNT
"RTN","ECSUM1",13,0)
 S (ECDO,ECMORE,UCNT,ECNT,ECCO)=0,ECPG=$G(ECPG,1),ECSCN=$G(ECSCN,"B")
"RTN","ECSUM1",14,0)
 I ECC="ALL" D CATS G END
"RTN","ECSUM1",15,0)
 I 'ECJLP S ECC=0,ECCN="None",ECCO=999
"RTN","ECSUM1",16,0)
 D PROC
"RTN","ECSUM1",17,0)
 D END
"RTN","ECSUM1",18,0)
 Q
"RTN","ECSUM1",19,0)
SET ;set var
"RTN","ECSUM1",20,0)
 S ECDN=$S($P($G(^ECD(+ECD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN"),UCNT=0
"RTN","ECSUM1",21,0)
 S ECDN=ECDN_$S($P($G(^ECD(+ECD,0)),"^",6):" **Inactive**",1:"")
"RTN","ECSUM1",22,0)
 S ECS=+$P($G(^ECD(+ECD,0)),"^",2)
"RTN","ECSUM1",23,0)
 S ECSN=$S($P($G(^DIC(49,ECS,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","ECSUM1",24,0)
 Q
"RTN","ECSUM1",25,0)
SETC ;set cats
"RTN","ECSUM1",26,0)
 I ECC=0 S ECCN="None" Q
"RTN","ECSUM1",27,0)
 S ECCN=$S($P($G(^EC(726,+ECC,0)),"^")]"":$P(^(0),"^"),1:"ZZ #"_ECC_" MISSING DATA")
"RTN","ECSUM1",28,0)
 S ECMORE=1
"RTN","ECSUM1",29,0)
 Q
"RTN","ECSUM1",30,0)
HEADER ;
"RTN","ECSUM1",31,0)
 W:$E(IOST,1,2)="C-"!(ECPG>1) @IOF
"RTN","ECSUM1",32,0)
 W !!,?25,"CATEGORY AND PROCEDURE SUMMARY",?70,"Page: ",ECPG,!
"RTN","ECSUM1",33,0)
 W ?27,$S(ECSCN="I":"INACTIVE",ECSCN="A":"ACTIVE",1:" ALL")_" EVENT CODE"
"RTN","ECSUM1",34,0)
 W " SCREENS",!?25,"Run Date : ",ECRDT,!?25,"LOCATION:  "_ECLN
"RTN","ECSUM1",35,0)
 W !,?25,"SERVICE:   ",ECSN,!?25,"DSS UNIT:  "_ECDN,! S ECPG=ECPG+1
"RTN","ECSUM1",36,0)
 F I=1:1:80 W "-"
"RTN","ECSUM1",37,0)
 Q
"RTN","ECSUM1",38,0)
CATS ;
"RTN","ECSUM1",39,0)
 S ECC="",ECCO=0
"RTN","ECSUM1",40,0)
 F  S ECC=$O(^ECJ("AP",ECL,ECD,ECC)) Q:ECC=""  D SETC,PROC Q:ECOUT
"RTN","ECSUM1",41,0)
 S ECMORE=0
"RTN","ECSUM1",42,0)
 Q
"RTN","ECSUM1",43,0)
PROC ;
"RTN","ECSUM1",44,0)
 S ECP=""
"RTN","ECSUM1",45,0)
 F  S ECP=$O(^ECJ("AP",ECL,ECD,ECC,ECP)) Q:ECP=""  D SETP Q:ECOUT
"RTN","ECSUM1",46,0)
 S ECMORE=0
"RTN","ECSUM1",47,0)
 Q
"RTN","ECSUM1",48,0)
SETP ;set procs
"RTN","ECSUM1",49,0)
 S ECPSY=+$O(^ECJ("AP",ECL,ECD,ECC,ECP,""))
"RTN","ECSUM1",50,0)
 S ECINDT=$P($G(^ECJ(ECPSY,0)),"^",2)
"RTN","ECSUM1",51,0)
 I ECSCN="A",ECINDT'="" Q
"RTN","ECSUM1",52,0)
 I ECSCN="I",ECINDT="" Q
"RTN","ECSUM1",53,0)
 I ECD'=ECDO D HEADER S ECDO=ECD
"RTN","ECSUM1",54,0)
 I ECC'=ECCO D  S ECCO=ECC I ECOUT Q
"RTN","ECSUM1",55,0)
 .W !!,?3,"Category:  "_ECCN D:$Y+4>IOSL PAGE,HEADER:ECPG,MORE:$D(ECCN)
"RTN","ECSUM1",56,0)
 S ECPSYN=$P($G(^ECJ(ECPSY,"PRO")),"^",2),EC4=+$P($G(^("PRO")),"^",4)
"RTN","ECSUM1",57,0)
 S EC2="" I EC4 S EC2=$S($P($G(^SC(EC4,0)),"^")]"":$P(^(0),"^"),1:"NO ASSOCIATED CLINIC")
"RTN","ECSUM1",58,0)
 S ECFILE=$P(ECP,";",2),ECFILE=$S($E(ECFILE)="I":81,$E(ECFILE)="E":725,1:"UNKNOWN")
"RTN","ECSUM1",59,0)
 I ECFILE="UNKNOWN" S ECPN="UNKNOWN",NATN="UNKNOWN"
"RTN","ECSUM1",60,0)
 I ECFILE=81 S ECPI=$$CPT^ICPTCOD(+ECP) D
"RTN","ECSUM1",61,0)
 .S ECPN=$S($P(ECPI,"^",3)]"":$P(ECPI,"^",3),1:"UNKNOWN"),NATN=$S($P(ECPI,"^",2)]"":$P(ECPI,"^",2),1:"NOT LISTED") K ECPI
"RTN","ECSUM1",62,0)
 I ECFILE=725 S ECPN=$S($P($G(^EC(725,+ECP,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN"),NATN=$S($P($G(^EC(725,+ECP,0)),"^",2)]"":$P(^(0),"^",2),1:"NOT LISTED")
"RTN","ECSUM1",63,0)
 S ECPN=$S(ECPSYN]"":ECPSYN,1:ECPN),ECNT=ECNT+1,UCNT=UCNT+1
"RTN","ECSUM1",64,0)
 W !,?3,"Procedure: ",$E(ECPN,1,30),"   (",$S(ECFILE=81:"CPT",1:"EC"),")",?52,"Nat'l No.: ",NATN
"RTN","ECSUM1",65,0)
 W:EC2]"" !,?14,"(Clinic: "_EC2_")"
"RTN","ECSUM1",66,0)
 I $P($G(^ECJ(+ECPSY,0)),"^",2),ECSCN="B" W ?70,"*INACTIVE*"
"RTN","ECSUM1",67,0)
 D:($Y+3)>IOSL PAGE,HEADER:ECPG,MORE:$D(ECCN) Q:ECOUT
"RTN","ECSUM1",68,0)
 Q
"RTN","ECSUM1",69,0)
PAGE ;
"RTN","ECSUM1",70,0)
 N SS,JJ
"RTN","ECSUM1",71,0)
 I $D(ECPG),$E(IOST,1,2)="C-" D
"RTN","ECSUM1",72,0)
 . S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECSUM1",73,0)
 . S DIR(0)="E" W ! D ^DIR K DIR I 'Y S ECOUT=1
"RTN","ECSUM1",74,0)
 Q
"RTN","ECSUM1",75,0)
MORE I ECMORE W !!,?3,"Category:  "_ECCN
"RTN","ECSUM1",76,0)
 Q
"RTN","ECUERPC")
0^25^B51135256
"RTN","ECUERPC",1,0)
ECUERPC ;ALB/JAM - Event Capture Data Entry Broker Utilities ;29 Oct 07
"RTN","ECUERPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,32,33,46,47,59,72,95**;8 May 96;Build 26
"RTN","ECUERPC",3,0)
 ;
"RTN","ECUERPC",4,0)
USRUNT(RESULTS,ECARY) ;
"RTN","ECUERPC",5,0)
 ;This broker call returns an array of DSS units for a user & location
"RTN","ECUERPC",6,0)
 ;        RPC: EC GETUSRDSSUNIT
"RTN","ECUERPC",7,0)
 ;INPUTS     ECARY  - Contains the following subscripted elements
"RTN","ECUERPC",8,0)
 ;            1. ECL   - Location IEN (if define gives User's DSS 
"RTN","ECUERPC",9,0)
 ;                       units for a location)
"RTN","ECUERPC",10,0)
 ;            2. ECDUZ - New Person IEN (if define gives list of 
"RTN","ECUERPC",11,0)
 ;                       DSS Units available to user)
"RTN","ECUERPC",12,0)
 ;
"RTN","ECUERPC",13,0)
 ;OUTPUTS     RESULTS - Array of DSS Units. Data pieces as follows:-
"RTN","ECUERPC",14,0)
 ;            PIECE - Description
"RTN","ECUERPC",15,0)
 ;              1     IEN of file 724
"RTN","ECUERPC",16,0)
 ;              2     Name of DSS Unit
"RTN","ECUERPC",17,0)
 ;              3     Send to PCE Flag
"RTN","ECUERPC",18,0)
 ;              4     Data Entry Date/Time Default
"RTN","ECUERPC",19,0)
 N ECL,ECDUZ,CNT,STR,DPT,IEN
"RTN","ECUERPC",20,0)
 D SETENV^ECUMRPC
"RTN","ECUERPC",21,0)
 S ECL=$P(ECARY,U),ECDUZ=$P(ECARY,U,2) I ECL="",ECDUZ="" Q
"RTN","ECUERPC",22,0)
 ;S ECDUZ=$G(DUZ,U),ECL=$P(ECARY,U) I (ECDUZ="")!(ECL="") Q
"RTN","ECUERPC",23,0)
 K ^TMP($J,"ECUSRUNT") S (DPT,CNT)=0
"RTN","ECUERPC",24,0)
 I ECL'="",ECDUZ="" S ECDUZ=$G(DUZ,U) I ECDUZ="" Q
"RTN","ECUERPC",25,0)
 I $D(^XUSEC("ECALLU",ECDUZ)) S DPT="" D
"RTN","ECUERPC",26,0)
 .I ECL="" S ^TMP($J,"ECUSRUNT",CNT+1)="ALL^ALL" Q
"RTN","ECUERPC",27,0)
 .I ECL="ALL" S ECL=""
"RTN","ECUERPC",28,0)
 .F  S DPT=$O(^ECD("B",DPT))  Q:DPT=""  S IEN=0 D
"RTN","ECUERPC",29,0)
 ..F  S IEN=$O(^ECD("B",DPT,IEN)) Q:'IEN  D UNTCHK
"RTN","ECUERPC",30,0)
 E  D
"RTN","ECUERPC",31,0)
 .I ECL="ALL" S ECL=""
"RTN","ECUERPC",32,0)
 .F  S DPT=$O(^VA(200,ECDUZ,"EC",DPT)) Q:'DPT  S IEN=DPT D UNTCHK
"RTN","ECUERPC",33,0)
 S RESULTS=$NA(^TMP($J,"ECUSRUNT"))
"RTN","ECUERPC",34,0)
 Q
"RTN","ECUERPC",35,0)
UNTCHK ;Check if DSS unit exist as event code screen and if active
"RTN","ECUERPC",36,0)
 N DSSF,DFD
"RTN","ECUERPC",37,0)
 ;I '$D(^ECJ("AP",ECL,IEN))!($P($G(^ECD(IEN,0)),U,6)) Q
"RTN","ECUERPC",38,0)
 I ECL'="",'$D(^ECJ("AP",ECL,IEN)) Q
"RTN","ECUERPC",39,0)
 I ($P($G(^ECD(IEN,0)),U,6))!('$P($G(^ECD(IEN,0)),U,8)) Q
"RTN","ECUERPC",40,0)
 S DSSF=$P(^ECD(IEN,0),"^",14) S:DSSF="" DSSF="N"
"RTN","ECUERPC",41,0)
 S DFD=$S($P(^ECD(IEN,0),"^",12)="N":"N",1:"X") ; added by VMP
"RTN","ECUERPC",42,0)
 S CNT=CNT+1,STR=IEN_"^"_$P(^ECD(IEN,0),"^")_U_DSSF_"^"_DFD
"RTN","ECUERPC",43,0)
 S ^TMP($J,"ECUSRUNT",CNT)=STR
"RTN","ECUERPC",44,0)
 Q
"RTN","ECUERPC",45,0)
CAT(RESULTS,ECARY) ;
"RTN","ECUERPC",46,0)
 ;This broker entry point returns an array of categories for an Event 
"RTN","ECUERPC",47,0)
 ;Code screen based on location and DSS unit.
"RTN","ECUERPC",48,0)
 ;        RPC: EC GETECSCATS
"RTN","ECUERPC",49,0)
 ;INPUTS     ECARY  - Contains the following values separated by "^"
"RTN","ECUERPC",50,0)
 ;            ECL  - Location IEN
"RTN","ECUERPC",51,0)
 ;            ECD  - DSS Unit IEN
"RTN","ECUERPC",52,0)
 ;            ECCSTA-Active or inactive category
"RTN","ECUERPC",53,0)
 ;                   A-ctive (default), I-nactive, B-oth
"RTN","ECUERPC",54,0)
 ;
"RTN","ECUERPC",55,0)
 ;OUTPUTS     RESULTS - Array of categories. Data pieces as follows:-
"RTN","ECUERPC",56,0)
 ;            PIECE - Description
"RTN","ECUERPC",57,0)
 ;              1 - Category IEN
"RTN","ECUERPC",58,0)
 ;              2 - Category description
"RTN","ECUERPC",59,0)
 ;
"RTN","ECUERPC",60,0)
 N ECL,ECD,ECC,CNT,DATA,ECCSTA
"RTN","ECUERPC",61,0)
 D SETENV^ECUMRPC
"RTN","ECUERPC",62,0)
 S ECL=$P(ECARY,U),ECD=$P(ECARY,U,2) I (ECL="")!(ECD="") Q
"RTN","ECUERPC",63,0)
 S ECCSTA=$P(ECARY,U,3)
"RTN","ECUERPC",64,0)
 K ^TMP($J,"ECSCATS")
"RTN","ECUERPC",65,0)
 D CATS^ECHECK1
"RTN","ECUERPC",66,0)
 M ^TMP($J,"ECSCATS")=ECC
"RTN","ECUERPC",67,0)
 S RESULTS=$NA(^TMP($J,"ECSCATS"))
"RTN","ECUERPC",68,0)
 Q
"RTN","ECUERPC",69,0)
PROC(RESULTS,ECARY) ;
"RTN","ECUERPC",70,0)
 ;This broker entry point returns an array of procedures for an Event 
"RTN","ECUERPC",71,0)
 ;Code screen (file #720.3) based on location, DSS unit, and Category
"RTN","ECUERPC",72,0)
 ;        RPC: EC GETECSPROCS
"RTN","ECUERPC",73,0)
 ;INPUTS     ECARY  - Contains the following values separated by "^"
"RTN","ECUERPC",74,0)
 ;            ECL  - Location IEN
"RTN","ECUERPC",75,0)
 ;            ECD  - DSS Unit IEN
"RTN","ECUERPC",76,0)
 ;            ECC  - Category IEN
"RTN","ECUERPC",77,0)
 ;            ECDT - Procedure Date
"RTN","ECUERPC",78,0)
 ;
"RTN","ECUERPC",79,0)
 ;OUTPUTS     RESULTS - Array of procedures. Data pieces as follows:-
"RTN","ECUERPC",80,0)
 ;            PIECE - Description
"RTN","ECUERPC",81,0)
 ;              1  - EC National Number SPACE Procedure Name SPACE
"RTN","ECUERPC",82,0)
 ;                - [Synonym]
"RTN","ECUERPC",83,0)
 ;              2  - Procedure Code
"RTN","ECUERPC",84,0)
 ;              3  - CPT Code
"RTN","ECUERPC",85,0)
 ;              4  - Default volume (1 if no default volume)
"RTN","ECUERPC",86,0)
 ;              5  - Event code screen IEN
"RTN","ECUERPC",87,0)
 ;
"RTN","ECUERPC",88,0)
 N ECL,ECD,ECC,CNT,DATA,STR,ECCPT,PX
"RTN","ECUERPC",89,0)
 D SETENV^ECUMRPC
"RTN","ECUERPC",90,0)
 S ECL=$P(ECARY,U),ECD=$P(ECARY,U,2),ECC=$P(ECARY,U,3) S:ECC="" ECC=0
"RTN","ECUERPC",91,0)
 I (ECL="")!(ECD="") Q
"RTN","ECUERPC",92,0)
 S ECDT=$P(ECARY,U,4)
"RTN","ECUERPC",93,0)
 K ^TMP($J,"ECPRO")
"RTN","ECUERPC",94,0)
 D PROS^ECHECK1
"RTN","ECUERPC",95,0)
 S CNT=0 F  S CNT=$O(^TMP("ECPRO",$J,CNT)) Q:'CNT  D
"RTN","ECUERPC",96,0)
 .S DATA=^TMP("ECPRO",$J,CNT),PX=$P(DATA,U)
"RTN","ECUERPC",97,0)
 .S ECCPT=$S(PX["EC":$P($G(^EC(725,+PX,0)),"^",5),1:+PX)
"RTN","ECUERPC",98,0)
 .S STR=$P(DATA,U,5)_" "_$P(DATA,U,4)_" ["_$P(DATA,U,3)_"]"_U_PX
"RTN","ECUERPC",99,0)
 .S STR=STR_U_ECCPT_U_$S($P(DATA,U,6):+$P(DATA,U,6),1:1)_U_$P(DATA,U,2)
"RTN","ECUERPC",100,0)
 .S ^TMP($J,"ECPRO",CNT)=STR
"RTN","ECUERPC",101,0)
 S RESULTS=$NA(^TMP($J,"ECPRO"))
"RTN","ECUERPC",102,0)
 K ^TMP("ECPRO",$J)
"RTN","ECUERPC",103,0)
 Q
"RTN","ECUERPC",104,0)
ECPXMOD(RESULTS,ECARY) ;
"RTN","ECUERPC",105,0)
 ;Broker call returns modifier entries for a CPT Procedure
"RTN","ECUERPC",106,0)
 ;        RPC: EC GETPXMODIFIER
"RTN","ECUERPC",107,0)
 ;INPUTS   ECARY  - Contains the following values separated by "^"
"RTN","ECUERPC",108,0)
 ;          ECCPT - CPT code ien (file #81)
"RTN","ECUERPC",109,0)
 ;          ECDT  - Procedure date and time (fileman format)
"RTN","ECUERPC",110,0)
 ;
"RTN","ECUERPC",111,0)
 ;OUTPUTS  RESULTS - Array of procedure modifiers
"RTN","ECUERPC",112,0)
 ;          2-character modifier^modifer name^modifier ien #81.3
"RTN","ECUERPC",113,0)
 ;
"RTN","ECUERPC",114,0)
 N CNT,SUB,ECCPT,ECDT,DATA,ECMOD
"RTN","ECUERPC",115,0)
 D SETENV^ECUMRPC
"RTN","ECUERPC",116,0)
 S ECCPT=$P(ECARY,U),ECDT=$P(ECARY,U,2) I ECDT="" D NOW^%DTC S ECDT=%
"RTN","ECUERPC",117,0)
 I ECCPT="" Q
"RTN","ECUERPC",118,0)
 K ^TMP($J,"ECPXMODS") S (SUB,CNT)=0
"RTN","ECUERPC",119,0)
 S DATA=$$CODM^ICPTCOD(ECCPT,"ECMOD","",ECDT) I +DATA<0 Q
"RTN","ECUERPC",120,0)
 F  S SUB=$O(ECMOD(SUB)) Q:SUB=""  I $P(ECMOD(SUB),U,2)'="" D
"RTN","ECUERPC",121,0)
 . I +$$MODP^ICPTMOD(ECCPT,$P(ECMOD(SUB),U,2),"I",ECDT)>0 D
"RTN","ECUERPC",122,0)
 . . S CNT=CNT+1,^TMP($J,"ECPXMODS",CNT)=SUB_U_ECMOD(SUB)
"RTN","ECUERPC",123,0)
 S RESULTS=$NA(^TMP($J,"ECPXMODS"))
"RTN","ECUERPC",124,0)
 Q
"RTN","ECUERPC",125,0)
PRVDER(RESULTS,ECARY) ;
"RTN","ECUERPC",126,0)
 ;remove this rpc before release;JAM 6/4/01
"RTN","ECUERPC",127,0)
 ;This broker entry point returns an array of valid providers
"RTN","ECUERPC",128,0)
 ;        RPC: EC GETPROVIDER
"RTN","ECUERPC",129,0)
 ;INPUTS     ECARY  - Contains the following subscripted elements
"RTN","ECUERPC",130,0)
 ;            ECDT  - Procedure date
"RTN","ECUERPC",131,0)
 ;
"RTN","ECUERPC",132,0)
 ;OUTPUTS     RESULTS - Array of providers. Data pieces as follows:-
"RTN","ECUERPC",133,0)
 ;            PIECE - Description
"RTN","ECUERPC",134,0)
 ;             IEN of file 200^Provider Name^occupation^specialty^
"RTN","ECUERPC",135,0)
 ;             subspecialty
"RTN","ECUERPC",136,0)
 ;
"RTN","ECUERPC",137,0)
 N IEN,CNT,ECUTN,KEY,USR
"RTN","ECUERPC",138,0)
 D SETENV^ECUMRPC
"RTN","ECUERPC",139,0)
 S ECDT=$P($G(ECARY),U),ECDT=$S(ECDT="":DT,1:ECDT)
"RTN","ECUERPC",140,0)
 K ^TMP($J,"ECPRVDRS") S CNT=0
"RTN","ECUERPC",141,0)
 F KEY="PROVIDER" S IEN=0 D
"RTN","ECUERPC",142,0)
 .F  S IEN=$O(^XUSEC(KEY,IEN)) Q:'IEN  S USR=$G(^VA(200,IEN,0)) D:USR'=""
"RTN","ECUERPC",143,0)
 ..S ECUTN=$$GET^XUA4A72(IEN,ECDT) I +ECUTN'>0 Q
"RTN","ECUERPC",144,0)
 ..S CNT=CNT+1,^TMP($J,"ECPRVDRS",CNT)=IEN_U_$P(USR,U)_U_$P(ECUTN,2,4)
"RTN","ECUERPC",145,0)
 S RESULTS=$NA(^TMP($J,"ECPRVDRS"))
"RTN","ECUERPC",146,0)
 Q
"RTN","ECUERPC",147,0)
 ;
"RTN","ECUERPC",148,0)
ELIG(RESULTS,ECARY) ;
"RTN","ECUERPC",149,0)
 ;
"RTN","ECUERPC",150,0)
 ;Broker call returns a list of patient eligibilities
"RTN","ECUERPC",151,0)
 ;        RPC: EC GETPATELIG
"RTN","ECUERPC",152,0)
 ;INPUTS   ECARY  - Contains the following subscripted elements
"RTN","ECUERPC",153,0)
 ;          DFN - Patient ien (file #2)
"RTN","ECUERPC",154,0)
 ;
"RTN","ECUERPC",155,0)
 ;OUTPUTS  RESULTS - Array of eligibilities
"RTN","ECUERPC",156,0)
 ;          primary/secondary elig flag^elig ien^elig description
"RTN","ECUERPC",157,0)
 ;
"RTN","ECUERPC",158,0)
 N CNT,SUB,DFN,VAEL
"RTN","ECUERPC",159,0)
 D SETENV^ECUMRPC
"RTN","ECUERPC",160,0)
 S DFN=$P(ECARY,U) I DFN="" Q
"RTN","ECUERPC",161,0)
 K ^TMP($J,"ECPATELIG")
"RTN","ECUERPC",162,0)
 D ELIG^VADPT I $G(VAEL(1))="" Q
"RTN","ECUERPC",163,0)
 S ^TMP($J,"ECPATELIG",1)="1^"_VAEL(1),SUB=0,CNT=1
"RTN","ECUERPC",164,0)
 F  S SUB=$O(VAEL(1,SUB)) Q:SUB=""  D
"RTN","ECUERPC",165,0)
 . S CNT=CNT+1,^TMP($J,"ECPATELIG",CNT)="0^"_VAEL(1,SUB)
"RTN","ECUERPC",166,0)
 S RESULTS=$NA(^TMP($J,"ECPATELIG"))
"RTN","ECUERPC",167,0)
 Q
"RTN","ECUERPC",168,0)
PRDEFS(RESULTS,ECARY) ;
"RTN","ECUERPC",169,0)
 ;This broker entry point returns the defaults for procedure data entry
"RTN","ECUERPC",170,0)
 ;        RPC: EC GETPRODEFS
"RTN","ECUERPC",171,0)
 ;INPUTS     ECARY  - Contains the following values separated by "^"
"RTN","ECUERPC",172,0)
 ;            ECL  - Location IEN
"RTN","ECUERPC",173,0)
 ;            ECD  - DSS Unit IEN
"RTN","ECUERPC",174,0)
 ;            ECC  - Category IEN
"RTN","ECUERPC",175,0)
 ;
"RTN","ECUERPC",176,0)
 ;OUTPUTS    RESULTS - Data pieces as follows:-
"RTN","ECUERPC",177,0)
 ;           PIECE - Description
"RTN","ECUERPC",178,0)
 ;             1 - Associated Clinic IEN
"RTN","ECUERPC",179,0)
 ;             2 - Associated Clinic
"RTN","ECUERPC",180,0)
 ;             3 - Medical Specialty IEN
"RTN","ECUERPC",181,0)
 ;             4 - Medical Specialty
"RTN","ECUERPC",182,0)
 ;
"RTN","ECUERPC",183,0)
 N ECL,ECD,ECC,ECP,IEN,ASC,ASCNM,MEDSP,MEDSPNM,ECCH
"RTN","ECUERPC",184,0)
 D SETENV^ECUMRPC
"RTN","ECUERPC",185,0)
 S ECL=$P(ECARY,U),ECD=$P(ECARY,U,2),ECC=$P(ECARY,U,3),ECP=$P(ECARY,U,4)
"RTN","ECUERPC",186,0)
 S:ECC="" ECC=0 I (ECL="")!(ECD="") Q
"RTN","ECUERPC",187,0)
 S (ASCNM,MEDSPNM)="",ECCH=ECL_"-"_ECD_"-"_ECC_"-"_ECP
"RTN","ECUERPC",188,0)
 I '$D(^ECJ("B",ECCH)) Q
"RTN","ECUERPC",189,0)
 S IEN=$O(^ECJ("B",ECCH,0)) I IEN="" Q
"RTN","ECUERPC",190,0)
 S ASC=$P($G(^ECJ(IEN,"PRO")),U,4) I ASC D
"RTN","ECUERPC",191,0)
 .S ASCNM=$$GET1^DIQ(44,ASC,.01,"I")
"RTN","ECUERPC",192,0)
 S MEDSP=$P($G(^ECD(ECD,0)),U,3) I MEDSP D 
"RTN","ECUERPC",193,0)
 .S MEDSPNM=$$GET1^DIQ(723,MEDSP,.01,"I")
"RTN","ECUERPC",194,0)
 S RESULTS=ASC_U_ASCNM_U_MEDSP_U_MEDSPNM
"RTN","ECUERPC",195,0)
 Q
"RTN","ECUERPC",196,0)
PATPROC(RESULTS,ECARY) ;
"RTN","ECUERPC",197,0)
 ;
"RTN","ECUERPC",198,0)
 ;Broker call returns the entries from EVENT CAPTURE PATIENT FILE #721
"RTN","ECUERPC",199,0)
 ;        RPC: EC GETPATPROCS
"RTN","ECUERPC",200,0)
 ;INPUTS   ECARY - Contains the following values separated by "^"
"RTN","ECUERPC",201,0)
 ;          ECLOC - Location ien
"RTN","ECUERPC",202,0)
 ;          ECPAT - Patient DFN ien
"RTN","ECUERPC",203,0)
 ;          ECUNT - DSS unit ien
"RTN","ECUERPC",204,0)
 ;          ECSD  - Start Date
"RTN","ECUERPC",205,0)
 ;          ECED  - End Date
"RTN","ECUERPC",206,0)
 ;
"RTN","ECUERPC",207,0)
 ;OUTPUTS  RESULTS - Array of Event Capture Patient entries contain
"RTN","ECUERPC",208,0)
 ;          721 IEN^Procedure date/time^Category^Procedure^Volume^
"RTN","ECUERPC",209,0)
 ;          Provider^ordering section^associated clinic^primary dx
"RTN","ECUERPC",210,0)
 ;          ^Provider IEN
"RTN","ECUERPC",211,0)
 ;
"RTN","ECUERPC",212,0)
 N IEN,CNT,ECV,ECLOC,ECUNT,ECPAT,PX,NODE,DATA,PDT,PDX,PND,PDXD,CAT,ECI
"RTN","ECUERPC",213,0)
 N ORS,PRV,PRO,PROV,ECU
"RTN","ECUERPC",214,0)
 D SETENV^ECUMRPC
"RTN","ECUERPC",215,0)
 S ECV="ECLOC^ECPAT^ECUNT^ECSD^ECED"
"RTN","ECUERPC",216,0)
 D PARSE(ECV,ECARY) I (ECLOC="")!(ECPAT="")!(ECUNT="") Q
"RTN","ECUERPC",217,0)
 K ^TMP($J,"ECPATPX")
"RTN","ECUERPC",218,0)
 S ECSD=$G(ECSD,DT),ECED=$G(ECED,DT)
"RTN","ECUERPC",219,0)
 S %DT="X" F ECI="ECSD","ECED" S X=@ECI D ^%DT S @ECI=Y
"RTN","ECUERPC",220,0)
 K X,Y
"RTN","ECUERPC",221,0)
 S ECSD=$S(ECSD=-1:DT,1:ECSD)-.0001,ECED=$S(ECED=-1:DT,1:ECED)+.9999
"RTN","ECUERPC",222,0)
 Q:ECED'>ECSD  S PDT=ECSD,CNT=0
"RTN","ECUERPC",223,0)
 F  S PDT=$O(^ECH("ADT",ECLOC,ECPAT,ECUNT,PDT)) Q:'PDT!(PDT>ECED)  D
"RTN","ECUERPC",224,0)
 . S IEN=0 F  S IEN=$O(^ECH("ADT",ECLOC,ECPAT,ECUNT,PDT,IEN)) Q:'IEN  D
"RTN","ECUERPC",225,0)
 . . S NODE=$G(^ECH(IEN,0)),PND=$G(^ECH(IEN,"P")),PX=$P(NODE,U,9)
"RTN","ECUERPC",226,0)
 . . Q:NODE=""  S (PRV,CAT,ORS,ASC,PDXD)="",PDX=$P(PND,U,2)
"RTN","ECUERPC",227,0)
 . . I PX["EC" D
"RTN","ECUERPC",228,0)
 . . . S PRO=$G(^EC(725,$P(PX,";"),0)),PX=$P(PRO,U,2)_" "_$P(PRO,U)
"RTN","ECUERPC",229,0)
 . . E  S PRO=$$CPT^ICPTCOD($P(PX,";"),PDT) S PX=$P(PRO,U,2)_" "_$P(PRO,U,3)
"RTN","ECUERPC",230,0)
 . . S:$P(NODE,U,8) CAT=$$GET1^DIQ(726,$P(NODE,U,8),.01,"I")
"RTN","ECUERPC",231,0)
 . . K PROV S ECU=$$GETPPRV^ECPRVMUT(IEN,.PROV),PRV=$S(ECU:"UNKNOWN",1:$P(PROV,"^",2)),ECU=$S('ECU:+PROV,1:"")
"RTN","ECUERPC",232,0)
 . . S:$P(NODE,U,12) ORS=$$GET1^DIQ(723,$P(NODE,U,12),.01,"I")
"RTN","ECUERPC",233,0)
 . . S:$P(NODE,U,19) ASC=$$GET1^DIQ(44,$P(NODE,U,19),.01,"I")
"RTN","ECUERPC",234,0)
 . . S:PDX PDXD=$$ICDDX^ICDCODE(PDX,PDT),PDXD=$P(PDXD,U,2)_" "_$P(PDXD,U,4)
"RTN","ECUERPC",235,0)
 . . S DATA=$P(NODE,U)_U_$$FMTE^XLFDT($P(NODE,U,3),"2F")_U_CAT_U_PX
"RTN","ECUERPC",236,0)
 . . S DATA=DATA_U_$P(NODE,U,10)_U_PRV_U_ORS_U_ASC_U_PDXD_U_ECU
"RTN","ECUERPC",237,0)
 . . S CNT=CNT+1,^TMP($J,"ECPATPX",CNT)=DATA
"RTN","ECUERPC",238,0)
 S RESULTS=$NA(^TMP($J,"ECPATPX"))
"RTN","ECUERPC",239,0)
 Q
"RTN","ECUERPC",240,0)
PARSE(ECV,ECARY) ;Parse Variable
"RTN","ECUERPC",241,0)
 N I
"RTN","ECUERPC",242,0)
 F I=1:1:$L(ECARY,U) S @$P(ECV,U,I)=$P(ECARY,U,I)
"RTN","ECUERPC",243,0)
 Q
"RTN","ECUMRPC1")
0^33^B63202010
"RTN","ECUMRPC1",1,0)
ECUMRPC1 ;ALB/JAM-Event Capture Management Broker Utilities ;23 Jul 2008
"RTN","ECUMRPC1",2,0)
 ;;2.0; EVENT CAPTURE ;**25,30,33,72,94,95**;8 May 96;Build 26
"RTN","ECUMRPC1",3,0)
 ;
"RTN","ECUMRPC1",4,0)
DSSUNT(RESULTS,ECARY) ;
"RTN","ECUMRPC1",5,0)
 ;
"RTN","ECUMRPC1",6,0)
 ;This broker entry point returns DSS units from file 724
"RTN","ECUMRPC1",7,0)
 ;        RPC: EC GETDSSUNIT
"RTN","ECUMRPC1",8,0)
 ;INPUTS         ECARY - Contains the following subscripted elements
"RTN","ECUMRPC1",9,0)
 ;               STAT   - Active or inactive DSS Units (optional)
"RTN","ECUMRPC1",10,0)
 ;               A-ctive (default), I-nactive, B-oth
"RTN","ECUMRPC1",11,0)
 ;
"RTN","ECUMRPC1",12,0)
 ;OUTPUTS        RESULTS - Array of DSS units. Data pieces as follows:-
"RTN","ECUMRPC1",13,0)
 ;               PIECE - Description
"RTN","ECUMRPC1",14,0)
 ;                 1     IEN of DSS Unit
"RTN","ECUMRPC1",15,0)
 ;                 2     Name of DSS Unit
"RTN","ECUMRPC1",16,0)
 ;                 3     Service
"RTN","ECUMRPC1",17,0)
 ;                 4     Medical Specialty
"RTN","ECUMRPC1",18,0)
 ;                 5     Cost Center
"RTN","ECUMRPC1",19,0)
 ;                 6     Unit Number
"RTN","ECUMRPC1",20,0)
 ;                 7     Inactive Flag
"RTN","ECUMRPC1",21,0)
 ;                 8     Associated Stop code (if not sending to PCE)
"RTN","ECUMRPC1",22,0)
 ;                 9     Category flag
"RTN","ECUMRPC1",23,0)
 ;                 10    Default date entry
"RTN","ECUMRPC1",24,0)
 ;                 11    Send to PCE Flag
"RTN","ECUMRPC1",25,0)
 ;
"RTN","ECUMRPC1",26,0)
 N UNT,STAT,CNT,CAT,NODE,ECS,STR,SRV,MED,CST,UNO,INACT,ASC,PCE,ACT,NODE
"RTN","ECUMRPC1",27,0)
 N DFD
"RTN","ECUMRPC1",28,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC1",29,0)
 K ^TMP($J,"ECDSSUNT")
"RTN","ECUMRPC1",30,0)
 S STAT=$P($G(ECARY),U),(CNT,UNT)=0 S:STAT="" STAT="A"
"RTN","ECUMRPC1",31,0)
 F  S UNT=$O(^ECD(UNT)) Q:'UNT  S NODE=$G(^ECD(UNT,0)) I NODE'="" D
"RTN","ECUMRPC1",32,0)
 . S ECS=$P(NODE,U,8),ACT=$P(NODE,U,6),ACT=$S(ACT:1,1:0)
"RTN","ECUMRPC1",33,0)
 . Q:'ECS  I $S(STAT="A"&(ACT):1,STAT="I"&('ACT):1,1:0) Q
"RTN","ECUMRPC1",34,0)
 . S CNT=CNT+1,CAT=$P(NODE,U,11),CAT=$S(CAT:"Y",1:"N"),UNO=$P(NODE,U,5)
"RTN","ECUMRPC1",35,0)
 . S SRV=$$GET1^DIQ(49,$P(NODE,U,2),.01,"I")
"RTN","ECUMRPC1",36,0)
 . S MED=$$GET1^DIQ(723,$P(NODE,U,3),.01,"I")
"RTN","ECUMRPC1",37,0)
 . S CST=$$GET1^DIQ(420.1,$P(NODE,U,4),.01,"I")
"RTN","ECUMRPC1",38,0)
 . S INACT=$P(NODE,U,6),INACT=$S(INACT:"I",1:"A"),ASC=$P(NODE,U,10)
"RTN","ECUMRPC1",39,0)
 . S:ASC ASC=$$GET1^DIQ(40.7,ASC,.01,"I")
"RTN","ECUMRPC1",40,0)
 . S DFD=$S($P(NODE,U,12)="N":"N",1:"X"),PCE=$P(NODE,U,14)
"RTN","ECUMRPC1",41,0)
 . S PCE=$S(PCE="A":PCE,PCE="O":PCE,1:"N")
"RTN","ECUMRPC1",42,0)
 . S STR=UNT_U_$P(NODE,U)_U_SRV_U_MED_U_CST_U_UNO_U_INACT_U_ASC_U_CAT
"RTN","ECUMRPC1",43,0)
 . S STR=STR_U_DFD_U_PCE,^TMP($J,"ECDSSUNT",CNT)=STR
"RTN","ECUMRPC1",44,0)
 S RESULTS=$NA(^TMP($J,"ECDSSUNT"))
"RTN","ECUMRPC1",45,0)
 Q
"RTN","ECUMRPC1",46,0)
CAT(RESULTS,ECARY) ;
"RTN","ECUMRPC1",47,0)
 ;
"RTN","ECUMRPC1",48,0)
 ;This broker entry point returns a list of categories from file 726
"RTN","ECUMRPC1",49,0)
 ;        RPC: EC GETCAT
"RTN","ECUMRPC1",50,0)
 ;INPUTS         ECARY - Contains the following subscripted elements
"RTN","ECUMRPC1",51,0)
 ;                STAT - Active or inactive category (optional)
"RTN","ECUMRPC1",52,0)
 ;                A-ctive (default), I-nactive, B-oth
"RTN","ECUMRPC1",53,0)
 ;
"RTN","ECUMRPC1",54,0)
 ;OUTPUTS        RESULTS - Array of category. Data pieces as follows:-
"RTN","ECUMRPC1",55,0)
 ;               PIECE - Description
"RTN","ECUMRPC1",56,0)
 ;                 1     IEN of Category
"RTN","ECUMRPC1",57,0)
 ;                 2     Name of Category
"RTN","ECUMRPC1",58,0)
 ;                 3     Creation Date
"RTN","ECUMRPC1",59,0)
 ;                 4     Inactive Date
"RTN","ECUMRPC1",60,0)
 ;
"RTN","ECUMRPC1",61,0)
 N STAT,CNT,CAT,NODE,ECDT,INDT,CRDT
"RTN","ECUMRPC1",62,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC1",63,0)
 K ^TMP($J,"ECCAT")
"RTN","ECUMRPC1",64,0)
 S STAT=$P($G(ECARY),U),(CNT,CAT)=0 S:STAT="" STAT="A"
"RTN","ECUMRPC1",65,0)
 F  S CAT=$O(^EC(726,CAT)) Q:'CAT  S NODE=$G(^EC(726,CAT,0)) I NODE'="" D
"RTN","ECUMRPC1",66,0)
 . S ECDT=$P(NODE,U,3)
"RTN","ECUMRPC1",67,0)
 . I STAT="A",ECDT'="",ECDT'>DT Q
"RTN","ECUMRPC1",68,0)
 . I STAT="I",ECDT="" Q
"RTN","ECUMRPC1",69,0)
 . S CRDT=$$FMTE^XLFDT($P(NODE,U,2),"2F")
"RTN","ECUMRPC1",70,0)
 . S INDT=$$FMTE^XLFDT($P(NODE,U,3),"2F")
"RTN","ECUMRPC1",71,0)
 . ;S CNT=CNT+1,^TMP($J,"ECCAT",CNT)=CAT_U_$P(NODE,U)_U_CRDT_U_INDT
"RTN","ECUMRPC1",72,0)
 . S CNT=CNT+1,^TMP($J,"ECCAT",CNT)=CAT_U_$P(NODE,U)_U_$P(CRDT,"@",1)_U_$P(INDT,"@",1)
"RTN","ECUMRPC1",73,0)
 S RESULTS=$NA(^TMP($J,"ECCAT"))
"RTN","ECUMRPC1",74,0)
 Q
"RTN","ECUMRPC1",75,0)
 ;
"RTN","ECUMRPC1",76,0)
CATCHK(RESULTS,ECARY) ;
"RTN","ECUMRPC1",77,0)
 ;
"RTN","ECUMRPC1",78,0)
 ;Broker call checks whether category is used in an Event Code Screen.
"RTN","ECUMRPC1",79,0)
 ;        RPC: EC DSSCATCHECK
"RTN","ECUMRPC1",80,0)
 ;INPUTS   ECARY  - Contains the following subscripted elements
"RTN","ECUMRPC1",81,0)
 ;          ECDA  - DSS Unit ien (file #724)
"RTN","ECUMRPC1",82,0)
 ;
"RTN","ECUMRPC1",83,0)
 ;OUTPUTS  RESULTS - Category used in Event Code Screen, 1-Yes or 0-No
"RTN","ECUMRPC1",84,0)
 ;
"RTN","ECUMRPC1",85,0)
 N ECDA,ECFLG,ECX
"RTN","ECUMRPC1",86,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC1",87,0)
 S ECDA=$P(ECARY,U) I ECDA="" Q
"RTN","ECUMRPC1",88,0)
 S (ECFLG,ECX)=0
"RTN","ECUMRPC1",89,0)
 F  S ECX=$O(^ECJ("AP",ECX)) Q:'ECX!(ECFLG)  D
"RTN","ECUMRPC1",90,0)
 . I $D(^ECJ("AP",ECX,ECDA)) S ECFLG=1
"RTN","ECUMRPC1",91,0)
 S RESULTS=ECFLG
"RTN","ECUMRPC1",92,0)
 Q
"RTN","ECUMRPC1",93,0)
PXCHK(RESULTS,ECARY) ;
"RTN","ECUMRPC1",94,0)
 ;
"RTN","ECUMRPC1",95,0)
 ;Checks whether procedure description or national number exist
"RTN","ECUMRPC1",96,0)
 ;INPUTS   ECARY  - Contains the following subscripted elements
"RTN","ECUMRPC1",97,0)
 ;          ECP - Procedure description
"RTN","ECUMRPC1",98,0)
 ;          ECN - EC National Number
"RTN","ECUMRPC1",99,0)
 ;
"RTN","ECUMRPC1",100,0)
 ;OUTPUTS  RESULTS - Px used^National # used, 1-Yes or 0-No ex. 1^0
"RTN","ECUMRPC1",101,0)
 ;
"RTN","ECUMRPC1",102,0)
 N ECX,ECP,ECN
"RTN","ECUMRPC1",103,0)
 Q:$G(ECARY)
"RTN","ECUMRPC1",104,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC1",105,0)
 S ECP=$P(ECARY,U),ECN=$P(ECARY,U,2),RESULTS="0^0"
"RTN","ECUMRPC1",106,0)
 I ECP'="",$D(^EC(725,"B",ECP)) S $P(RESULTS,U)=1
"RTN","ECUMRPC1",107,0)
 I ECN'="" F ECX="E","D","DL" D  I $P(RESULTS,U,2) Q
"RTN","ECUMRPC1",108,0)
 . I $D(^EC(725,ECX,ECN)) S $P(RESULTS,U,2)=1
"RTN","ECUMRPC1",109,0)
 Q
"RTN","ECUMRPC1",110,0)
SRCLST(RESULTS,ECARY) ;
"RTN","ECUMRPC1",111,0)
 ;
"RTN","ECUMRPC1",112,0)
 ;This broker entry returns an array of codes from a file based on a 
"RTN","ECUMRPC1",113,0)
 ;search string.
"RTN","ECUMRPC1",114,0)
 ;        RPC: EC GETLIST
"RTN","ECUMRPC1",115,0)
 ;
"RTN","ECUMRPC1",116,0)
 ;INPUTS   ECARY   - Contains the following subscripted elements
"RTN","ECUMRPC1",117,0)
 ;           ECSTR  - Search string
"RTN","ECUMRPC1",118,0)
 ;           ECFIL  - File to search
"RTN","ECUMRPC1",119,0)
 ;           ECDIR  - Search order
"RTN","ECUMRPC1",120,0)
 ;           ECNUM  - (Optional) # records to return [default=44]
"RTN","ECUMRPC1",121,0)
 ;OUTPUTS     RESULTS - Array of values based on the search criteria.
"RTN","ECUMRPC1",122,0)
 ;
"RTN","ECUMRPC1",123,0)
 N ECNT,DIC,ECSTR,ECFIL,ECORD,ECER,ECDI,ECNUM
"RTN","ECUMRPC1",124,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC1",125,0)
 S ECNT=0,ECFIL=$P(ECARY,U),ECSTR=$P(ECARY,U,2),ECDIR=$P(ECARY,U,3)
"RTN","ECUMRPC1",126,0)
 S ECORD=$S(ECDIR=-1:"B",1:"I")
"RTN","ECUMRPC1",127,0)
 K ^TMP($J,"ECFIND"),^TMP("ECSRCH",$J)
"RTN","ECUMRPC1",128,0)
 I ECFIL="" Q
"RTN","ECUMRPC1",129,0)
 S ECNUM=$S(+$P(ECARY,U,4)>0:$P(ECARY,U,4),1:44)
"RTN","ECUMRPC1",130,0)
 I ECFIL=420.1 D CSTCTR            ;Cost Center search
"RTN","ECUMRPC1",131,0)
 I ECFIL=49 D SERVC                ;Service search
"RTN","ECUMRPC1",132,0)
 I ECFIL=723 D MEDSPC              ;Medical specialty
"RTN","ECUMRPC1",133,0)
 I ECFIL=40.7 D STPCDE G EXIT      ;Associated stop code
"RTN","ECUMRPC1",134,0)
 I ECFIL=724 D DUNT G EXIT         ;DSS Unit
"RTN","ECUMRPC1",135,0)
 I ECFIL=726 D ECAT                ;Category
"RTN","ECUMRPC1",136,0)
 I ECFIL=4 D LOC                   ;Location
"RTN","ECUMRPC1",137,0)
 I ECFIL=44 D ASCLN G EXIT         ;Associated clinic
"RTN","ECUMRPC1",138,0)
 I ECFIL=757.01 D LEX^ECUMRPC2 G EXIT  ;Lex ICD code
"RTN","ECUMRPC1",139,0)
 I ECFIL=200 D PROV^ECUMRPC2(ECNUM)      ;Providers
"RTN","ECUMRPC1",140,0)
 I $D(ECER) S ^TMP($J,"ECFIND",1)="0^Error occurred during search" G EXIT
"RTN","ECUMRPC1",141,0)
 D SORT
"RTN","ECUMRPC1",142,0)
EXIT K ^TMP("ECSRCH",$J)
"RTN","ECUMRPC1",143,0)
 S RESULTS=$NA(^TMP($J,"ECFIND"))
"RTN","ECUMRPC1",144,0)
 Q
"RTN","ECUMRPC1",145,0)
ASCLN ;Search for active associated clinics (file #44)
"RTN","ECUMRPC1",146,0)
 N CNT,NOD,ECDT,INACT,REACT,ERR
"RTN","ECUMRPC1",147,0)
 S CNT=0,ECDT=DT
"RTN","ECUMRPC1",148,0)
 F  Q:CNT=ECNUM  S ECSTR=$O(^SC("B",ECSTR),ECDIR) Q:ECSTR=""  S CLN="" D
"RTN","ECUMRPC1",149,0)
 .F  S CLN=$O(^SC("B",ECSTR,CLN),ECDIR) Q:CLN=""  S NOD=$G(^SC(CLN,0)) D
"RTN","ECUMRPC1",150,0)
 ..Q:NOD=""  Q:$P(NOD,U,3)'="C"  ;Q:+$G(^SC(CLN,"OOS"))
"RTN","ECUMRPC1",151,0)
 ..S ERR=0 I $D(^SC(CLN,"I")) D  I ERR Q
"RTN","ECUMRPC1",152,0)
 ...S INACT=$P(^SC(CLN,"I"),U),REACT=$P(^SC(CLN,"I"),U,2)
"RTN","ECUMRPC1",153,0)
 ...I INACT D  I ERR Q
"RTN","ECUMRPC1",154,0)
 ....I REACT="" S:ECDT'<INACT ERR=1 Q
"RTN","ECUMRPC1",155,0)
 ....I ECDT'<INACT,ECDT<REACT S ERR=1 Q
"RTN","ECUMRPC1",156,0)
 ...I REACT,ECDT<REACT S ERR=1
"RTN","ECUMRPC1",157,0)
 ..S CNT=CNT+1,^TMP($J,"ECFIND",CNT)=CLN_U_$P(NOD,U)
"RTN","ECUMRPC1",158,0)
 Q
"RTN","ECUMRPC1",159,0)
CSTCTR ;Search for cost centers (File #420.1)
"RTN","ECUMRPC1",160,0)
 N ECNULL,INDX,STR,NSTR,I
"RTN","ECUMRPC1",161,0)
 S $P(ECNULL," ",7)=" ",INDX="B"
"RTN","ECUMRPC1",162,0)
 I $E(ECSTR)?.N,$L(ECSTR)<7 S ECSTR=ECSTR_$E(ECNULL,1,7-$L(ECSTR))
"RTN","ECUMRPC1",163,0)
 I $L($P(ECSTR," "))=6,$P(ECSTR," ",2)?.A D   ;truncate for x-ref
"RTN","ECUMRPC1",164,0)
 . S ECSTR=$P(ECSTR," ")_" "_$E($P(ECSTR," ",2,999),1,22)
"RTN","ECUMRPC1",165,0)
 I $E(ECSTR)?.A S INDX="C",(STR,NSTR)="" D  S ECSTR=NSTR
"RTN","ECUMRPC1",166,0)
 .F I=1:1 S STR=$P(ECSTR," ",I) Q:STR=""  D
"RTN","ECUMRPC1",167,0)
 ..S STR=$E(STR)_$TR($E(STR,2,9999),"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","ECUMRPC1",168,0)
 ..S NSTR=NSTR_STR
"RTN","ECUMRPC1",169,0)
 D LISTDIC(ECFIL,"",.01,ECORD,ECNUM,ECSTR,"",INDX,"I '$P(^(0),U,2)","","^TMP(""ECSRCH"",$J)","ECER")
"RTN","ECUMRPC1",170,0)
 Q
"RTN","ECUMRPC1",171,0)
SERVC ;Search for services (File #49)
"RTN","ECUMRPC1",172,0)
 D LISTDIC(ECFIL,"",.01,ECORD,ECNUM,ECSTR,"","","","","^TMP(""ECSRCH"",$J)","ECER")
"RTN","ECUMRPC1",173,0)
 Q
"RTN","ECUMRPC1",174,0)
MEDSPC ;Search for medical specialty (File #723)
"RTN","ECUMRPC1",175,0)
 D LISTDIC(ECFIL,"",.01,ECORD,ECNUM,ECSTR,"","","","","^TMP(""ECSRCH"",$J)","ECER")
"RTN","ECUMRPC1",176,0)
 Q
"RTN","ECUMRPC1",177,0)
STPCDE ;Search for associated stop code (File #40.7)
"RTN","ECUMRPC1",178,0)
 N ECNT,INDX,ECNUL,STR,IEN
"RTN","ECUMRPC1",179,0)
 S $P(ECNUL,"  ",30)=" ",INDX="B",ECNT=0,ECSTR=$P(ECSTR,"~")
"RTN","ECUMRPC1",180,0)
 I +ECSTR,+ECSTR?.N S INDX="C",IEN=0 D  Q
"RTN","ECUMRPC1",181,0)
 .S ECSTR=$O(^DIC(40.7,INDX,+ECSTR)) I ECSTR="" Q
"RTN","ECUMRPC1",182,0)
 .F  S IEN=$O(^DIC(40.7,INDX,ECSTR,IEN)) Q:'IEN  D  I ECNT>(ECNUM-1) Q
"RTN","ECUMRPC1",183,0)
 ..S STR=$G(^DIC(40.7,IEN,0)) I (STR="")!($P(STR,U,3)'="") Q
"RTN","ECUMRPC1",184,0)
 ..S STR=$E($P(STR,U),1,30)_"  ["_$J($P(STR,U,2),3,0)_"]"_U_$P(STR,U,2)_U_IEN
"RTN","ECUMRPC1",185,0)
 ..S ECNT=ECNT+1,^TMP($J,"ECFIND",ECNT)=STR
"RTN","ECUMRPC1",186,0)
 D LISTDIC(ECFIL,"",".01;1",ECORD,ECNUM,ECSTR,"",INDX,"I $P(^(0),""^"",3)=""""!($P(^(0),U,3)'<DT)","","^TMP(""ECSRCH"",$J)","ECER")
"RTN","ECUMRPC1",187,0)
 S ECNT=0
"RTN","ECUMRPC1",188,0)
 F  S ECNT=$O(^TMP("ECSRCH",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC1",189,0)
 .S STR=$G(^TMP("ECSRCH",$J,"DILIST","ID",ECNT,.01))_U_$G(^(1))
"RTN","ECUMRPC1",190,0)
 .S STR=$E($P(STR,U),1,30)_"  ["_$J($P(STR,U,2),3,0)_"]"_U_$P(STR,U,2)
"RTN","ECUMRPC1",191,0)
 .S ^TMP($J,"ECFIND",ECNT)=STR_U_^TMP("ECSRCH",$J,"DILIST",2,ECNT)
"RTN","ECUMRPC1",192,0)
 Q
"RTN","ECUMRPC1",193,0)
DUNT ;Search for DSS unit (File #724)
"RTN","ECUMRPC1",194,0)
 N ECNT,SNDPCE
"RTN","ECUMRPC1",195,0)
 D LISTDIC(ECFIL,"",".01;10;13",ECORD,ECNUM,ECSTR,"","","I '$P(^(0),""^"",6),$P(^(0),U,8)","","^TMP(""ECSRCH"",$J)","ECER")
"RTN","ECUMRPC1",196,0)
 S ECNT=0
"RTN","ECUMRPC1",197,0)
 F  S ECNT=$O(^TMP("ECSRCH",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC1",198,0)
 .S SNDPCE=$G(^TMP("ECSRCH",$J,"DILIST","ID",ECNT,13))
"RTN","ECUMRPC1",199,0)
 .S SNDPCE=$S(SNDPCE="O":1,SNDPCE="A":1,1:0)
"RTN","ECUMRPC1",200,0)
 .S ^TMP($J,"ECFIND",ECNT)=$G(^TMP("ECSRCH",$J,"DILIST","ID",ECNT,.01))_U_^TMP("ECSRCH",$J,"DILIST",2,ECNT)_U_$G(^TMP("ECSRCH",$J,"DILIST","ID",ECNT,10))_U_SNDPCE
"RTN","ECUMRPC1",201,0)
 Q
"RTN","ECUMRPC1",202,0)
ECAT ;Search for Category (File #726)
"RTN","ECUMRPC1",203,0)
 D LISTDIC(ECFIL,"",.01,ECORD,ECNUM,ECSTR,"","","I $P(^(0),""^"",3)=""""!($P(^(0),U,3)>DT)","","^TMP(""ECSRCH"",$J)","ECER")
"RTN","ECUMRPC1",204,0)
 Q
"RTN","ECUMRPC1",205,0)
LOC ;Search for Location (File #4)
"RTN","ECUMRPC1",206,0)
 D LISTDIC(ECFIL,"",.01,ECORD,ECNUM,ECSTR,"","","I $G(^(""EC""))","","^TMP(""ECSRCH"",$J)","ECER")
"RTN","ECUMRPC1",207,0)
 Q
"RTN","ECUMRPC1",208,0)
LISTDIC(ECFL,ECIEN,ECFLD,ECFLG,ECNUM,ECFRM,ECPRT,ECINDX,ECSCN,ECIND,ECTG,ECER) ;
"RTN","ECUMRPC1",209,0)
 ;Produces a list of records in a file base on search string
"RTN","ECUMRPC1",210,0)
 N DIC
"RTN","ECUMRPC1",211,0)
 D LIST^DIC(ECFL,ECIEN,ECFLD,ECFLG,ECNUM,ECFRM,ECPRT,ECINDX,ECSCN,ECIND,ECTG,ECER)
"RTN","ECUMRPC1",212,0)
 K ECFL,ECIEN,ECFLD,ECFLG,ECNUM,ECFRM,ECPRT,ECINDX,ECSCN,ECID
"RTN","ECUMRPC1",213,0)
 Q
"RTN","ECUMRPC1",214,0)
SORT ;Extracts data to be returned to broker
"RTN","ECUMRPC1",215,0)
 N ECNT,STR
"RTN","ECUMRPC1",216,0)
 S ECNT=0
"RTN","ECUMRPC1",217,0)
 F  S ECNT=$O(^TMP("ECSRCH",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC1",218,0)
 .S ^TMP($J,"ECFIND",ECNT)=$G(^TMP("ECSRCH",$J,"DILIST","ID",ECNT,.01))_U_^TMP("ECSRCH",$J,"DILIST",2,ECNT)
"RTN","ECUMRPC1",219,0)
 Q
"RTN","ECUMRPC2")
0^34^B30358856
"RTN","ECUMRPC2",1,0)
ECUMRPC2 ;ALB/JAM;Event Capture Management Broker Utils ; 23 Jul 2008
"RTN","ECUMRPC2",2,0)
 ;;2.0; EVENT CAPTURE ;**25,30,42,46,47,49,75,72,95**;8 May 96;Build 26
"RTN","ECUMRPC2",3,0)
GLOC(RESULTS,ECARY) ;
"RTN","ECUMRPC2",4,0)
 ;
"RTN","ECUMRPC2",5,0)
 ;This broker entry point returns all active Event Capture locations
"RTN","ECUMRPC2",6,0)
 ;        RPC: EC GETLOC
"RTN","ECUMRPC2",7,0)
 ;INPUTS         ECARY - Contains the following subscripted elements
"RTN","ECUMRPC2",8,0)
 ;               STAT   - Active or inactive locations (optional)
"RTN","ECUMRPC2",9,0)
 ;               A-ctive (default), I-nactive, B-oth
"RTN","ECUMRPC2",10,0)
 ;
"RTN","ECUMRPC2",11,0)
 ;OUTPUTS        RESULTS - The array of active Event Capture locations.
"RTN","ECUMRPC2",12,0)
 ;               PIECE - Description
"RTN","ECUMRPC2",13,0)
 ;                 1     Location IEN
"RTN","ECUMRPC2",14,0)
 ;                 2     LOC description
"RTN","ECUMRPC2",15,0)
 ;                 3     State Abbreviation
"RTN","ECUMRPC2",16,0)
 ;                 4     Current Location Flag
"RTN","ECUMRPC2",17,0)
 ;                 5     Facility Type
"RTN","ECUMRPC2",18,0)
 ;                 6     Station Number
"RTN","ECUMRPC2",19,0)
 N LOC,STAT,CNT,CLOC,ST,NODE,ACT,ECLOC,ELOC,ECFT,ECSN
"RTN","ECUMRPC2",20,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC2",21,0)
 K ^TMP($J,"ECLOCATION")
"RTN","ECUMRPC2",22,0)
 S STAT=$P($G(ECARY),U),(CNT,LOC)=0,ACT=0 S:STAT="" STAT="A"
"RTN","ECUMRPC2",23,0)
 D GETLOC^ECL(.ECLOC)
"RTN","ECUMRPC2",24,0)
 F  S LOC=$O(ECLOC(LOC)) Q:'LOC  S ELOC($P(ECLOC(LOC),U,2))=""
"RTN","ECUMRPC2",25,0)
 S LOC=0
"RTN","ECUMRPC2",26,0)
 F  S LOC=$O(^DIC(4,LOC)) Q:'LOC  S NODE=$G(^DIC(4,LOC,0)) I NODE'="" D
"RTN","ECUMRPC2",27,0)
 . I $P(NODE,U)="" Q
"RTN","ECUMRPC2",28,0)
 . I ($P(NODE,U,11)="I")!($P($G(^DIC(4,LOC,99)),U,4)) S ACT=1
"RTN","ECUMRPC2",29,0)
 . I $S(STAT="A"&(ACT):1,STAT="I"&('ACT):1,1:0) Q
"RTN","ECUMRPC2",30,0)
 . S CLOC=$D(ELOC(LOC)),CLOC=$S(CLOC:"YES",1:"")
"RTN","ECUMRPC2",31,0)
 . S CNT=CNT+1,ST=$P(NODE,U,2) S:ST'="" ST=$$GET1^DIQ(5,ST,1,"I")
"RTN","ECUMRPC2",32,0)
 . S ECFT=$P($G(^DIC(4.1,+$G(^DIC(4,LOC,3)),0)),U)
"RTN","ECUMRPC2",33,0)
 . S ECSN=$P($G(^DIC(4,LOC,99)),U)
"RTN","ECUMRPC2",34,0)
 . S ^TMP($J,"ECLOCATION",CNT)=LOC_U_$P(NODE,U)_U_ST_U_CLOC_U_ECFT_U_ECSN
"RTN","ECUMRPC2",35,0)
 S RESULTS=$NA(^TMP($J,"ECLOCATION"))
"RTN","ECUMRPC2",36,0)
 Q
"RTN","ECUMRPC2",37,0)
CPTFND(RESULTS,ECARY) ;
"RTN","ECUMRPC2",38,0)
 ;
"RTN","ECUMRPC2",39,0)
 ;This broker entry point does a search on a CPT string and returns
"RTN","ECUMRPC2",40,0)
 ;a list of matches from file #81
"RTN","ECUMRPC2",41,0)
 ;        RPC: EC GETCPTLST
"RTN","ECUMRPC2",42,0)
 ;INPUTS      ECARY   - Contains the following subscripted elements
"RTN","ECUMRPC2",43,0)
 ;             CPTSTR - CPT search string
"RTN","ECUMRPC2",44,0)
 ;
"RTN","ECUMRPC2",45,0)
 ;OUTPUTS     RESULTS - The array of cpt codes. Data pieces as follows:-
"RTN","ECUMRPC2",46,0)
 ;             CPT ien^CPT code^Name
"RTN","ECUMRPC2",47,0)
 ;
"RTN","ECUMRPC2",48,0)
 N CPTSTR,ECNT,DIC,ECTG,ECER
"RTN","ECUMRPC2",49,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC2",50,0)
 S CPTSTR=$P(ECARY,U),ECNT=0 I CPTSTR="" Q
"RTN","ECUMRPC2",51,0)
 K ^TMP($J,"ECPTSRCH"),^TMP("ECCPT",$J)
"RTN","ECUMRPC2",52,0)
 D CPTSRH(81,CPTSTR)
"RTN","ECUMRPC2",53,0)
 F  S ECNT=$O(^TMP("ECCPT",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC2",54,0)
 .S ^TMP($J,"ECPTSRCH",ECNT)=$G(^TMP("ECCPT",$J,"DILIST",2,ECNT))_U_^TMP("ECCPT",$J,"DILIST","ID",ECNT,.01)_U_^TMP("ECCPT",$J,"DILIST","ID",ECNT,2)
"RTN","ECUMRPC2",55,0)
 K ^TMP("ECCPT",$J)
"RTN","ECUMRPC2",56,0)
 S RESULTS=$NA(^TMP($J,"ECPTSRCH"))
"RTN","ECUMRPC2",57,0)
 Q
"RTN","ECUMRPC2",58,0)
 ;
"RTN","ECUMRPC2",59,0)
PXFND(RESULTS,ECARY) ;
"RTN","ECUMRPC2",60,0)
 ;
"RTN","ECUMRPC2",61,0)
 ;This broker entry point does a search on a procedure string and returns
"RTN","ECUMRPC2",62,0)
 ;a list of matches from file #81 and/or #725
"RTN","ECUMRPC2",63,0)
 ;        RPC: EC GETPXLST
"RTN","ECUMRPC2",64,0)
 ;INPUTS      ECARY   - Contains the following subscripted elements
"RTN","ECUMRPC2",65,0)
 ;             PXSTR -  Procedure search string
"RTN","ECUMRPC2",66,0)
 ;
"RTN","ECUMRPC2",67,0)
 ;OUTPUTS     RESULTS - The array of procedures. Data pieces as follows:-
"RTN","ECUMRPC2",68,0)
 ;             Procedure ien^Procedure code  Procedure Name
"RTN","ECUMRPC2",69,0)
 ;
"RTN","ECUMRPC2",70,0)
 N CPTSTR,ECNT,DIC,ECX,CNT,ECTG,ECER,PXSTR,ECSTR
"RTN","ECUMRPC2",71,0)
 D SETENV^ECUMRPC
"RTN","ECUMRPC2",72,0)
 S PXSTR=$P(ECARY,U),ECNT=0 I PXSTR="" Q
"RTN","ECUMRPC2",73,0)
 K ^TMP($J,"ECPXSRCH"),^TMP("ECCPT",$J),^TMP("ECCPT1",$J)
"RTN","ECUMRPC2",74,0)
 D 
"RTN","ECUMRPC2",75,0)
 . I $P(PXSTR,".")="A" D CPTSRH(81,$P(PXSTR,".",2)) Q
"RTN","ECUMRPC2",76,0)
 . I $P(PXSTR,".")="B" D CPTSRH(725,$P(PXSTR,".",2)) Q
"RTN","ECUMRPC2",77,0)
 . F ECX=81,725 D CPTSRH(ECX,PXSTR)
"RTN","ECUMRPC2",78,0)
 F  S ECNT=$O(^TMP("ECCPT",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC2",79,0)
 .S ECID=$G(^TMP("ECCPT",$J,"DILIST",2,ECNT))_";ICPT("
"RTN","ECUMRPC2",80,0)
 .S ECSTR=^TMP("ECCPT",$J,"DILIST","ID",ECNT,.01)_"  "_^(2)
"RTN","ECUMRPC2",81,0)
 .S ^TMP($J,"ECPXSRCH",ECNT)=ECID_U_ECSTR
"RTN","ECUMRPC2",82,0)
 S ECNT=0,CNT=+$O(^TMP($J,"ECPXSRCH","A"),-1)
"RTN","ECUMRPC2",83,0)
 F  S ECNT=$O(^TMP("ECCPT1",$J,"DILIST","ID",ECNT)) Q:'ECNT  D
"RTN","ECUMRPC2",84,0)
 .S CNT=CNT+1,ECID=$G(^TMP("ECCPT1",$J,"DILIST",2,ECNT))_";EC(725,"
"RTN","ECUMRPC2",85,0)
 .S ECSTR=^TMP("ECCPT1",$J,"DILIST","ID",ECNT,1)_"  "_^(.01)
"RTN","ECUMRPC2",86,0)
 .S ^TMP($J,"ECPXSRCH",CNT)=ECID_U_ECSTR
"RTN","ECUMRPC2",87,0)
 K ^TMP("ECCPT",$J),^TMP("ECCPT1",$J)
"RTN","ECUMRPC2",88,0)
 S RESULTS=$NA(^TMP($J,"ECPXSRCH"))
"RTN","ECUMRPC2",89,0)
 Q
"RTN","ECUMRPC2",90,0)
CPTSRH(FILE,CPTSTR) ;Searches either file 81 or 725 for a CPT string
"RTN","ECUMRPC2",91,0)
 I FILE=81 D
"RTN","ECUMRPC2",92,0)
 .D FINDIC(81,"",".01;2","M",CPTSTR,100,"","I $P($$CPT^ICPTCOD(+Y),""^"",7)","","^TMP(""ECCPT"",$J)")
"RTN","ECUMRPC2",93,0)
 I FILE=725 D
"RTN","ECUMRPC2",94,0)
 .D FINDIC(725,"",".01;1","M",CPTSTR,100,"","I '$P(^(0),""^"",3)","","^TMP(""ECCPT1"",$J)")
"RTN","ECUMRPC2",95,0)
 Q
"RTN","ECUMRPC2",96,0)
FINDIC(ECFL,ECIEN,ECFLD,ECFLG,ECVAL,ECN,ECINDX,ECSCN,ECID,ECTG,ECER) ;
"RTN","ECUMRPC2",97,0)
 ;Find records in a file base on search string
"RTN","ECUMRPC2",98,0)
 S ECER=$G(ECER)
"RTN","ECUMRPC2",99,0)
 D FIND^DIC(ECFL,ECIEN,ECFLD,ECFLG,ECVAL,ECN,ECINDX,ECSCN,ECID,ECTG,ECER)
"RTN","ECUMRPC2",100,0)
 K ECFL,ECIEN,ECFLD,ECFLG,ECVAL,ECN,ECINDX,ECSCN,ECID
"RTN","ECUMRPC2",101,0)
 Q
"RTN","ECUMRPC2",102,0)
PROV(ECNUM) ;Return a set of providers from the NEW PERSON file
"RTN","ECUMRPC2",103,0)
 ;Input Variables:-
"RTN","ECUMRPC2",104,0)
 ;  ECNUM  - # of records to return
"RTN","ECUMRPC2",105,0)
 ;  FROM   - text to $O from
"RTN","ECUMRPC2",106,0)
 ;  DATE   - checks for an active person class on this date (optional)
"RTN","ECUMRPC2",107,0)
 ;  ECDIR  - $O direction
"RTN","ECUMRPC2",108,0)
 ;  KEY    - screen users by security key (optional)
"RTN","ECUMRPC2",109,0)
 ;
"RTN","ECUMRPC2",110,0)
 ;Output Variables:-
"RTN","ECUMRPC2",111,0)
 ;  ^TMP($J,"ECFIND",1..n - returned array
"RTN","ECUMRPC2",112,0)
 ;     IEN of file 200^Provider Name^occupation^specialty^subspecialty
"RTN","ECUMRPC2",113,0)
 ;
"RTN","ECUMRPC2",114,0)
 N I,IEN,CNT,FROM,DATE,ECUTN S I=0,CNT=$S(+$G(ECNUM)>0:ECNUM,1:44)  ;KEY="PROVIDER"
"RTN","ECUMRPC2",115,0)
 ;S FROM=$P(ECSTR,"|"),DATE=$P(ECSTR,"|",2)
"RTN","ECUMRPC2",116,0)
 S FROM=$P(ECSTR,"|"),DATE=$P(ECSTR,"|",2),REPORT=$P(ECSTR,"|",3)
"RTN","ECUMRPC2",117,0)
 F  Q:I'<CNT  S FROM=$O(^VA(200,"B",FROM),ECDIR) Q:FROM=""  D
"RTN","ECUMRPC2",118,0)
 . S IEN="" F  S IEN=$O(^VA(200,"B",FROM,IEN),ECDIR) Q:'IEN  D 
"RTN","ECUMRPC2",119,0)
 . . ;I $L(KEY),'$D(^XUSEC(KEY,+IEN)) Q
"RTN","ECUMRPC2",120,0)
 . . ;I +$G(ALLUSERS)=0,'$$ACTIVE^XUSER(IEN) Q  ; terminated user
"RTN","ECUMRPC2",121,0)
 . . I REPORT="R" S I=I+1,^TMP($J,"ECFIND",I)=IEN_"^"_FROM_"^" Q
"RTN","ECUMRPC2",122,0)
 . . S ECUTN=$$GET^XUA4A72(IEN,DATE)
"RTN","ECUMRPC2",123,0)
 . . I DATE>0,ECUTN<1 Q
"RTN","ECUMRPC2",124,0)
 . . S I=I+1,^TMP($J,"ECFIND",I)=IEN_"^"_FROM_"^"_$P(ECUTN,"^",2,4)
"RTN","ECUMRPC2",125,0)
 Q
"RTN","ECUMRPC2",126,0)
LEX ; returns a list of ICD code from lexicon lookup; called from ECUMRPC1
"RTN","ECUMRPC2",127,0)
 ;Input Variables:-
"RTN","ECUMRPC2",128,0)
 ;  ECSTR  - APP|ECX|ECDT
"RTN","ECUMRPC2",129,0)
 ;           application|Search string|procedure date
"RTN","ECUMRPC2",130,0)
 ;
"RTN","ECUMRPC2",131,0)
 ;Output Variables:-
"RTN","ECUMRPC2",132,0)
 ;  ^TMP($J,"ECFIND",1..n - returned array
"RTN","ECUMRPC2",133,0)
 ;     ICD9 Code^LEX description^IEN of file 80^IEN of file 757.01
"RTN","ECUMRPC2",134,0)
 ;
"RTN","ECUMRPC2",135,0)
 N LEX,ILST,I,IEN,ECX,APP,ECDT,ICD9,ICDIEN,DIC,ECCD
"RTN","ECUMRPC2",136,0)
 S APP=$P(ECSTR,"|"),ECX=$P(ECSTR,"|",2),ECDT=$P(ECSTR,"|",3)
"RTN","ECUMRPC2",137,0)
 S ECDT=$G(ECDT,DT),DIC="^ICD9("
"RTN","ECUMRPC2",138,0)
 ;spacebar default for DUZ
"RTN","ECUMRPC2",139,0)
 I ECX=" ",+($G(DUZ))>0 S IEN=$G(^DISV(DUZ,DIC)) I +IEN D
"RTN","ECUMRPC2",140,0)
 .S ECCD=$$ICDDX^ICDCODE(IEN,ECDT) S:+ECCD>0 ECX=$P(ECCD,U,2)
"RTN","ECUMRPC2",141,0)
 D CONFIG^LEXSET(APP,APP,ECDT)    ;LEX DBIA1577
"RTN","ECUMRPC2",142,0)
 D LOOK^LEXA(ECX,APP,1,"",ECDT)   ;LEX DBIA2950
"RTN","ECUMRPC2",143,0)
 I '$D(LEX("LIST",1)) S ^TMP($J,"ECFIND",1)="0^No matches found." Q
"RTN","ECUMRPC2",144,0)
 ;LEX DBIA1573
"RTN","ECUMRPC2",145,0)
 S ILST=1,IEN=+LEX("LIST",1)
"RTN","ECUMRPC2",146,0)
 D ICD I ICDIEN<0 S ^TMP($J,"ECFIND",1)="0^No matches found." Q
"RTN","ECUMRPC2",147,0)
 S ^TMP($J,"ECFIND",ILST)=ICD9_U_$P(LEX("LIST",1),U,2)_U_ICDIEN_U_LEX("LIST",1),I=""
"RTN","ECUMRPC2",148,0)
 F  S I=$O(^TMP("LEXFND",$J,I)) Q:I'<0  D
"RTN","ECUMRPC2",149,0)
 . S IEN=$O(^TMP("LEXFND",$J,I,0))
"RTN","ECUMRPC2",150,0)
 . D ICD I ICDIEN<0 Q
"RTN","ECUMRPC2",151,0)
 . S ILST=ILST+1
"RTN","ECUMRPC2",152,0)
 . S ^TMP($J,"ECFIND",ILST)=ICD9_U_^TMP("LEXFND",$J,I,IEN)_U_ICDIEN_U_IEN
"RTN","ECUMRPC2",153,0)
 I $O(^TMP($J,"ECFIND",0))="" S ^TMP($J,"ECFIND",1)="0^No matches found."
"RTN","ECUMRPC2",154,0)
 K ^TMP("LEXFND",$J),^TMP("LEXHIT",$J)
"RTN","ECUMRPC2",155,0)
 Q
"RTN","ECUMRPC2",156,0)
ICD ;ICD code
"RTN","ECUMRPC2",157,0)
 S ICD9=$$ICDONE^LEXU(IEN,ECDT)
"RTN","ECUMRPC2",158,0)
 S ICDIEN=+$$ICDDX^ICDCODE(ICD9,ECDT)
"RTN","ECUMRPC2",159,0)
 Q
"RTN","ECUTL")
0^31^B25415242
"RTN","ECUTL",1,0)
ECUTL ;ALB/GTS/JAM - Event Capture Utilities ;23 Jul 2008
"RTN","ECUTL",2,0)
 ;;2.0; EVENT CAPTURE ;**10,18,47,63,95**;8 May 96;Build 26
"RTN","ECUTL",3,0)
 ;
"RTN","ECUTL",4,0)
FNDVST(ECVST,ECRECNUM,EC2PCE) ; Search EC Patient records for associated Visits
"RTN","ECUTL",5,0)
 ;
"RTN","ECUTL",6,0)
 ;   Input: ECVST    - Visit file IEN to search for
"RTN","ECUTL",7,0)
 ;          ECRECNUM - Event Capture record number to skip processing
"RTN","ECUTL",8,0)
 ;          EC2PCE   - Array passed by reference to contain results
"RTN","ECUTL",9,0)
 ;
"RTN","ECUTL",10,0)
 ;  Output: ECERR  1 - One of the records to resend lacks a zero node
"RTN","ECUTL",11,0)
 ;                 0 - All of the records to resend have zero nodes
"RTN","ECUTL",12,0)
 ;          EC2PCE   - array subscripted by date and pointer
"RTN","ECUTL",13,0)
 ;                     to EVENT CAPTURE PATIENT (#721) file
"RTN","ECUTL",14,0)
 ;                     [Ex: ECPCE(3080101,611)]
"RTN","ECUTL",15,0)
 ;
"RTN","ECUTL",16,0)
 N ECIEN,ECERR,ECVAR
"RTN","ECUTL",17,0)
 I '$D(ECRECNUM) S ECRECNUM=0
"RTN","ECUTL",18,0)
 S (ECVAR,ECERR)=0
"RTN","ECUTL",19,0)
 S:+ECVST'>0 ECERR=1
"RTN","ECUTL",20,0)
 I ECERR=0 DO
"RTN","ECUTL",21,0)
 .S ECIEN=""
"RTN","ECUTL",22,0)
 .F  S ECIEN=$O(^ECH("C",ECVST,ECIEN)) Q:+ECIEN=0  DO
"RTN","ECUTL",23,0)
 ..S:ECRECNUM'=ECIEN ECVAR=$$RSEND(ECIEN,.EC2PCE)
"RTN","ECUTL",24,0)
 ..S:ECVAR>0 ECERR=1
"RTN","ECUTL",25,0)
FNDVSTQ Q ECERR
"RTN","ECUTL",26,0)
 ;
"RTN","ECUTL",27,0)
RSEND(ECIEN,ECPCE) ; Prepare EC Patient record for resending to PCE
"RTN","ECUTL",28,0)
 ;
"RTN","ECUTL",29,0)
 ;   Input:  ECIEN - IEN for record to resend to PCE
"RTN","ECUTL",30,0)
 ;           ECPCE - array passed by reference to contain results
"RTN","ECUTL",31,0)
 ;  Output:  0 if successful   - EC Patient record will be resent to PCE
"RTN","ECUTL",32,0)
 ;           1 if Unsuccessful - EC Patient record lacks zero node
"RTN","ECUTL",33,0)
 ;           ECPCE - array subscripted by date and pointer
"RTN","ECUTL",34,0)
 ;                  to EVENT CAPTURE PATIENT (#721) file
"RTN","ECUTL",35,0)
 ;                  [Ex: ECPCE(3080101,611)]
"RTN","ECUTL",36,0)
 ;
"RTN","ECUTL",37,0)
 N ECERR,DA,DIE,DR,ECPROCDT
"RTN","ECUTL",38,0)
 S ECERR=0
"RTN","ECUTL",39,0)
 I '$D(^ECH(ECIEN,0)) S ECERR=1
"RTN","ECUTL",40,0)
 I ECERR=0 DO
"RTN","ECUTL",41,0)
 .S ECPROCDT=$P(^ECH(ECIEN,0),"^",3)
"RTN","ECUTL",42,0)
 .;remove set of field #31 and create ECPCE array to pass to
"RTN","ECUTL",43,0)
 .;direct EC to PCE xfer task
"RTN","ECUTL",44,0)
 .;S DA=ECIEN,DIE=721,DR="25///@;28///@;31///^S X=ECPROCDT;32///@"
"RTN","ECUTL",45,0)
 .S DA=ECIEN,DIE=721,DR="25///@;28///@;32///@"
"RTN","ECUTL",46,0)
 .D ^DIE
"RTN","ECUTL",47,0)
 .S ECPCE(ECPROCDT,ECIEN)=""
"RTN","ECUTL",48,0)
RSENDQ Q ECERR
"RTN","ECUTL",49,0)
MODSCN() ;Screen CPT Procedure Modifier
"RTN","ECUTL",50,0)
 N ECPT,ECCPT,ECPDT
"RTN","ECUTL",51,0)
 S ECCPT="" I $G(ECP)'="" D
"RTN","ECUTL",52,0)
 . S ECCPT=$S(ECP["EC":$P($G(^EC(725,+ECP,0)),"^",5),1:+ECP)
"RTN","ECUTL",53,0)
 S ECPDT=$S($D(^ECH(DA,0)):$P(^ECH(DA,0),U,3),$D(ECDT):ECDT,1:"")
"RTN","ECUTL",54,0)
 S ECPT=$S($D(^ECH(DA,"P")):$P(^ECH(DA,"P"),U),ECCPT'="":ECCPT,1:"")
"RTN","ECUTL",55,0)
 I ECPT'="",+$$MODP^ICPTMOD(ECPT,+Y,"I",ECPDT)>0
"RTN","ECUTL",56,0)
 Q
"RTN","ECUTL",57,0)
ASKMOD(PROC,MOD,PRDT,ECMOD,ECERR) ; Ask CPT modifiers for CPT procedure
"RTN","ECUTL",58,0)
 ; Input           PROC  = CPT Procedure
"RTN","ECUTL",59,0)
 ;                 MOD   = Default modifier
"RTN","ECUTL",60,0)
 ;                 PRDT  = Date/Time of procedure. Checks modifier status
"RTN","ECUTL",61,0)
 ;
"RTN","ECUTL",62,0)
 ;Output           ECMOD(  array with modifiers
"RTN","ECUTL",63,0)
 ;                 ECERR = Error flag 1 - error or 0 - no error.
"RTN","ECUTL",64,0)
 ;
"RTN","ECUTL",65,0)
 N DTOUT,DUOUT,DIROUT,SUB,I,DEF,DIR,DIC,DSC,IEN,DATA,MODAR
"RTN","ECUTL",66,0)
 S ECERR=$G(ECERR,0),DEF=""
"RTN","ECUTL",67,0)
 I PROC="" S ECERR=1 G ASKMODQ
"RTN","ECUTL",68,0)
 I '$D(PRDT) S PRDT=""
"RTN","ECUTL",69,0)
 S DIC="^ICPT(",DIC(0)="N",X=PROC
"RTN","ECUTL",70,0)
 S DIC("S")="I $P($$CPT^ICPTCOD(+Y,PRDT),""^"",7)"
"RTN","ECUTL",71,0)
 D ^DIC I +Y=-1 S ECERR=1 G ASKMODQ
"RTN","ECUTL",72,0)
 ;If no modifiers present for CPT code quit
"RTN","ECUTL",73,0)
 S DATA=$$CODM^ICPTCOD(PROC,"MODAR","",PRDT)
"RTN","ECUTL",74,0)
 G:$O(MODAR(""))="" ASKMODQ K MODAR
"RTN","ECUTL",75,0)
 ;Set modifiers in ECMOD array if a valid pair (CPT code/modifier)
"RTN","ECUTL",76,0)
 S SUB="" F I=1:1 S SUB=$P(MOD,",",I) Q:SUB=""  D
"RTN","ECUTL",77,0)
 . S DATA=$$MODP^ICPTMOD(PROC,SUB,"E",PRDT)
"RTN","ECUTL",78,0)
 . I +DATA'>0 W !?2,"Modifier: ",SUB," Invalid - ",$P(DATA,U,2) Q
"RTN","ECUTL",79,0)
 . S DSC=$P(DATA,U,2),IEN=$P(DATA,U),ECMOD(PROC,SUB)=DSC_U_IEN,DEF=SUB
"RTN","ECUTL",80,0)
 ;List modifiers entered
"RTN","ECUTL",81,0)
 S SUB="" F I=1:1 S SUB=$O(ECMOD(PROC,SUB)) Q:SUB=""  D
"RTN","ECUTL",82,0)
 . W !?2,"Modifier: ",SUB," ",$P(ECMOD(PROC,SUB),U)
"RTN","ECUTL",83,0)
 I DEF'="" S DIR("B")=DEF
"RTN","ECUTL",84,0)
AGAIN N Y,X,DEFX,ECY
"RTN","ECUTL",85,0)
 S DIR("A")="Modifier",DIR("?")="^D MODHLP^ECUTL"
"RTN","ECUTL",86,0)
 S DIR(0)="FO^^I $$VALMOD^ECUTL(PROC,X,PRDT)",DEFX=""
"RTN","ECUTL",87,0)
 D ^DIR K DIR G:X="" ASKMODQ
"RTN","ECUTL",88,0)
 I $D(DTOUT)!($D(DUOUT))!($D(DIROUT)) K ECMOD(PROC) S ECERR=1 G ASKMODQ
"RTN","ECUTL",89,0)
 D  G AGAIN
"RTN","ECUTL",90,0)
 . I X="@" K:DEF'="" ECMOD(PROC,DEF) W "  ...deleted" Q
"RTN","ECUTL",91,0)
 . I '$D(ECY) Q
"RTN","ECUTL",92,0)
 . I DEF'=DEFX,DEFX'="",$D(ECMOD(PROC,DEFX)) S (DEF,DIR("B"))=DEFX Q
"RTN","ECUTL",93,0)
 . K DIR("B") S ECMOD(PROC,$P(ECY,U,2))=$P(ECY(0),U,2)_U_$P(ECY,U),DEF=""
"RTN","ECUTL",94,0)
 ;
"RTN","ECUTL",95,0)
ASKMODQ Q $S(ECERR:0,1:1)
"RTN","ECUTL",96,0)
 ;
"RTN","ECUTL",97,0)
VALMOD(PROC,X,PRDT) ;Validate modifiers
"RTN","ECUTL",98,0)
 N DIC,DTOUT,DUOUT,DIROUT,DUOUT
"RTN","ECUTL",99,0)
 S DIC="^DIC(81.3,",DIC(0)="MEQZ"
"RTN","ECUTL",100,0)
 S DIC("W")="W ""   "" W ""   "",$P($$MOD^ICPTMOD(+Y,""I"",$G(PRDT)),U,3)"
"RTN","ECUTL",101,0)
 S DIC("S")="I +$$MODP^ICPTMOD(PROC,Y,""I"",PRDT)>0"
"RTN","ECUTL",102,0)
 D ^DIC I Y<0 K X Q 1
"RTN","ECUTL",103,0)
 M ECY=Y S DEFX=$P(Y,U,2)
"RTN","ECUTL",104,0)
 Q 1
"RTN","ECUTL",105,0)
MODHLP ;Help for CPT modifiers
"RTN","ECUTL",106,0)
 N DIC,MOD,D
"RTN","ECUTL",107,0)
 Q:'$D(PROC)  I $D(ECMOD(PROC)) D
"RTN","ECUTL",108,0)
 . W !?2,"Answer with CPT MODIFIER",!?1,"Choose from:"
"RTN","ECUTL",109,0)
 . S MOD="" F  S MOD=$O(ECMOD(PROC,MOD)) Q:MOD=""  W !,?4,MOD
"RTN","ECUTL",110,0)
 W !?6,"You may enter a new CPT MODIFIER, if you wish"
"RTN","ECUTL",111,0)
 W !?6,"Enter a modifier that is valid for the CPT procedure code."
"RTN","ECUTL",112,0)
 S DIC="^DIC(81.3,",DIC("W")="W ""   "" W ""   "",$P($$MOD^ICPTMOD(+Y,""I"",$G(PRDT)),U,3)",D="B"
"RTN","ECUTL",113,0)
 S DIC(0)="QEZ",DIC("S")="I +$$MODP^ICPTMOD(PROC,Y,""I"",$G(PRDT))>0"
"RTN","ECUTL",114,0)
 D DQ^DICQ
"RTN","ECUTL",115,0)
 Q
"RTN","ECUTL",116,0)
MOD(ECIEN,MFT,OUTARR) ;Returns modifiers associated with an EC Patient IEN
"RTN","ECUTL",117,0)
 ;  Input: ECIEN  - IEN entry in file 721/^ECH(
"RTN","ECUTL",118,0)
 ;         MFT    - format to provide modifier
"RTN","ECUTL",119,0)
 ;                  "I" - ien format
"RTN","ECUTL",120,0)
 ;                  "E" - .01 format (default)
"RTN","ECUTL",121,0)
 ;
"RTN","ECUTL",122,0)
 ; Output: OUTARR - output array subscripted by modifer ien or .01 value 
"RTN","ECUTL",123,0)
 ;                  ien^modifier^modifier description
"RTN","ECUTL",124,0)
 ;         returns 1 if successful or 0 if unsuccessful
"RTN","ECUTL",125,0)
 ;      
"RTN","ECUTL",126,0)
 I $G(ECIEN)="" Q 0  ;IEN not define.
"RTN","ECUTL",127,0)
 I '$D(^ECH(ECIEN)) Q 0  ;IEN does not exist in file 721/^ECH(
"RTN","ECUTL",128,0)
 I $O(^ECH(ECIEN,"MOD",0))="" Q 0  ;No modifiers on file for entry
"RTN","ECUTL",129,0)
 N MOD,IEN,ECMERR,MODARY,MODESC,SUB,SEQ,ECDT
"RTN","ECUTL",130,0)
 S MFT=$S($G(MFT)="":"E",1:MFT) I "E^I"'[$E(MFT) S MFT="E"
"RTN","ECUTL",131,0)
 S ECDT=$P($G(^ECH(ECIEN,0)),U,3)
"RTN","ECUTL",132,0)
 D GETS^DIQ(721,ECIEN,"36*","IE","MODARY","ECMERR")
"RTN","ECUTL",133,0)
 I $D(ECMERR) Q 0  ;Error looking up entry
"RTN","ECUTL",134,0)
 S SEQ="" F  S SEQ=$O(MODARY(721.036,SEQ)) Q:SEQ=""  D
"RTN","ECUTL",135,0)
 . S SUB=$G(MODARY(721.036,SEQ,.01,MFT)) I SUB="" Q
"RTN","ECUTL",136,0)
 . S IEN=$G(MODARY(721.036,SEQ,.01,"I")) I IEN="" Q
"RTN","ECUTL",137,0)
 . S MOD=$G(MODARY(721.036,SEQ,.01,"E")) I MOD="" S MOD="Unknown"
"RTN","ECUTL",138,0)
 . S MODESC=$P($$MOD^ICPTMOD(MOD,"E",ECDT),U,3)
"RTN","ECUTL",139,0)
 . I MODESC="" S MODESC="Unknown"
"RTN","ECUTL",140,0)
 . S OUTARR(SUB)=IEN_U_MOD_U_MODESC
"RTN","ECUTL",141,0)
 Q $S($D(OUTARR):1,1:0)
"RTN","ECUTL2")
0^32^B28978680
"RTN","ECUTL2",1,0)
ECUTL2 ;ALB/JAM - Event Capture Diagnosis Code Selection ;23 Aug 2007
"RTN","ECUTL2",2,0)
 ;;2.0; EVENT CAPTURE ;**23,33,47,63,72,95**;8 May 96;Build 26
"RTN","ECUTL2",3,0)
DIAG ;ask dx question (primary and multiple secondary) 
"RTN","ECUTL2",4,0)
 ;check for primary dx and display message
"RTN","ECUTL2",5,0)
 D PDXMSG
"RTN","ECUTL2",6,0)
 ;ask for primary dx
"RTN","ECUTL2",7,0)
 D PDX I ECOUT Q
"RTN","ECUTL2",8,0)
 ;ask for secondary dx
"RTN","ECUTL2",9,0)
 D SDX I ECOUT Q
"RTN","ECUTL2",10,0)
 I $D(DTOUT)!$D(DUOUT) W:$P(ECPCE,"~",2)'="N" !!,"Please note that this record cannot be sent to PCE without a diagnosis.",!!
"RTN","ECUTL2",11,0)
 Q
"RTN","ECUTL2",12,0)
PDXMSG ; Check for existence of primary diagnoses and display message
"RTN","ECUTL2",13,0)
 N TXT,ECPDX
"RTN","ECUTL2",14,0)
 S (ECDX,ECDXN,ECDXO)="" K ECDXS
"RTN","ECUTL2",15,0)
 ;Check if primary dx exist in file #721
"RTN","ECUTL2",16,0)
 S ECPDX=$$PDXCK(ECDFN,ECDT,ECL,EC4)
"RTN","ECUTL2",17,0)
 I +ECPDX W ! D 
"RTN","ECUTL2",18,0)
 . W !?5,"WARNING: Primary Diagnoses already on File for this encounter."
"RTN","ECUTL2",19,0)
 . W !?5,"If changed, all procedures will be updated. ("_ECDXN_")"
"RTN","ECUTL2",20,0)
 . S ECDXO=ECDX
"RTN","ECUTL2",21,0)
 I $P(ECPDX,U,2) D
"RTN","ECUTL2",22,0)
 . S TXT="WARNING: Primary diagnoses already sent to PCE. If changed,"
"RTN","ECUTL2",23,0)
 . S TXT=TXT_" all procedures"
"RTN","ECUTL2",24,0)
 . W !!?5,TXT
"RTN","ECUTL2",25,0)
 . S TXT="associated with this encounter will be updated and resent "
"RTN","ECUTL2",26,0)
 . S TXT=TXT_"to PCE."
"RTN","ECUTL2",27,0)
 . W !?5,TXT
"RTN","ECUTL2",28,0)
 Q
"RTN","ECUTL2",29,0)
PDXCK(ECDFN,ECDTX,ECLX,EC4X) ;Get primary dx frm file #721 for pat encounter
"RTN","ECUTL2",30,0)
 ;   Input:   ECDFN     = Patient ien
"RTN","ECUTL2",31,0)
 ;            ECDTX     = Date/time of procedure
"RTN","ECUTL2",32,0)
 ;            ECLX      = Location ien
"RTN","ECUTL2",33,0)
 ;            EC4X      = Clinic ien
"RTN","ECUTL2",34,0)
 ;
"RTN","ECUTL2",35,0)
 ;   Output:  PDXF^PCEF = primary dx flag (1/0)^dx sent to PCE flag (1/0)
"RTN","ECUTL2",36,0)
 ;            ECDX      = Primary diagnoses ien
"RTN","ECUTL2",37,0)
 ;            ECDXN     = Primary diagnoses code
"RTN","ECUTL2",38,0)
 ;            ECDXIEN   = Array of encounter IENs w primary dx
"RTN","ECUTL2",39,0)
 ;
"RTN","ECUTL2",40,0)
 N PDXF,PCEF,DA,DXIEN,DXS,DXN
"RTN","ECUTL2",41,0)
 S (PDXF,PCEF)=0,DA="" K ECDXIEN
"RTN","ECUTL2",42,0)
 I $G(ECDFN)=""!($G(ECDTX)="")!($G(ECLX)="")!($G(EC4X)="") Q PDXF_U_PCEF
"RTN","ECUTL2",43,0)
 I $O(^ECH("APAT",ECDFN,ECDTX,""))="" Q PDXF_U_PCEF
"RTN","ECUTL2",44,0)
 F  S DA=$O(^ECH("APAT",ECDFN,ECDTX,DA)) Q:DA=""  D
"RTN","ECUTL2",45,0)
 . I EC4X'=$P($G(^ECH(DA,0)),U,19) Q
"RTN","ECUTL2",46,0)
 . S ECDX=$P($G(^ECH(DA,"P")),U,2) I ECDX="" Q
"RTN","ECUTL2",47,0)
 . S ECDXN=$P($$ICDDX^ICDCODE(ECDX,ECDTX),U,2)
"RTN","ECUTL2",48,0)
 . S ECDXIEN(DA)=ECDXN_U_ECDX,PDXF=1
"RTN","ECUTL2",49,0)
 . I $D(^ECH(DA,"SEND")),^("SEND")="" S PCEF=1
"RTN","ECUTL2",50,0)
 . I $D(^ECH(DA,"DX")) D
"RTN","ECUTL2",51,0)
 . . S DXS=0 F  S DXS=$O(^ECH(DA,"DX",DXS)) Q:'DXS  D
"RTN","ECUTL2",52,0)
 ...S DXIEN=$P($G(^ECH(DA,"DX",DXS,0)),U)
"RTN","ECUTL2",53,0)
 ...S DXN=$P($$ICDDX^ICDCODE(DXIEN,ECDTX),U,2) S:DXN'="" ECDXS(DXN)=DXIEN
"RTN","ECUTL2",54,0)
 Q PDXF_U_PCEF
"RTN","ECUTL2",55,0)
PDX ;Ask primary diagnoses code
"RTN","ECUTL2",56,0)
 ;   Variables:   ECDX    = Primary diagnoses ien
"RTN","ECUTL2",57,0)
 ;                ECDXN   = Primary diagnoses code, default if define
"RTN","ECUTL2",58,0)
 ;                ECOUT   = Error flag (1/0)
"RTN","ECUTL2",59,0)
 ;   
"RTN","ECUTL2",60,0)
 N DIC,X,Y,DTOUT,DUOUT,DEFX,ECODE,PROMPT
"RTN","ECUTL2",61,0)
 S ECDX=$G(ECDX),ECDXN=$G(ECDXN),PROMPT="Primary ICD-9 Code: "
"RTN","ECUTL2",62,0)
 S:ECDXN'="" DEFX=ECDXN
"RTN","ECUTL2",63,0)
 F  D LEX Q:$G(ECOUT)  D  I $D(ECODE) Q
"RTN","ECUTL2",64,0)
 .I X="" W !,"This is a required response. Enter '^' to exit" Q
"RTN","ECUTL2",65,0)
 .S ECDXN=ECODE,ECDX=+$$ICDDX^ICDCODE(ECODE,$G(ECDT))
"RTN","ECUTL2",66,0)
 Q
"RTN","ECUTL2",67,0)
SDX ;Ask secondary diagnoses code
"RTN","ECUTL2",68,0)
 ;   Variables:   ECDX    = Primary diagnoses ien, default if define
"RTN","ECUTL2",69,0)
 ;                ECDXN   = Primary diagnoses code
"RTN","ECUTL2",70,0)
 ;                ECOUT   = Error flag (1/0)
"RTN","ECUTL2",71,0)
 ;                ECDXS   = Array with secondary diagnosis code
"RTN","ECUTL2",72,0)
 ;                          subscript=dx code and set equal to dx ien
"RTN","ECUTL2",73,0)
 ;
"RTN","ECUTL2",74,0)
 N Y,X,DEFX,DIC,DTOUT,DUOUT,ECODE
"RTN","ECUTL2",75,0)
 S ECOUT=$G(ECOUT),PROMPT="Secondary ICD-9 Code: "
"RTN","ECUTL2",76,0)
 F  D LSTDXS,LEX Q:Y<0  D  I ECOUT Q
"RTN","ECUTL2",77,0)
 .I ECODE="" Q
"RTN","ECUTL2",78,0)
 .I ECODE=$G(ECDXN) W "  Already exist as primary dx." Q
"RTN","ECUTL2",79,0)
 .I $D(ECDXS(ECODE)) D DELDUP Q
"RTN","ECUTL2",80,0)
 .S ECDXS(ECODE)=+$$ICDDX^ICDCODE(ECODE,$G(ECDT))
"RTN","ECUTL2",81,0)
 Q
"RTN","ECUTL2",82,0)
DELDUP ;Delete secondary diagnosis code from list
"RTN","ECUTL2",83,0)
 N DIR,DIRUT,DTOUT,DUOUT,DIROUT
"RTN","ECUTL2",84,0)
 S DIR("A")="Delete "_ECODE_" Code from List"
"RTN","ECUTL2",85,0)
 S DIR(0)="Y"
"RTN","ECUTL2",86,0)
 D ^DIR
"RTN","ECUTL2",87,0)
 I $D(DIRUT)!($D(DIROUT)) S ECOUT=1 Q
"RTN","ECUTL2",88,0)
 I Y K ECDXS(ECODE)
"RTN","ECUTL2",89,0)
 Q
"RTN","ECUTL2",90,0)
LEX ;ICD code from LEX database
"RTN","ECUTL2",91,0)
 ;K X,Y
"RTN","ECUTL2",92,0)
 S X=$G(DEFX)
"RTN","ECUTL2",93,0)
 ;LEX DBIA1577
"RTN","ECUTL2",94,0)
 D CONFIG^LEXSET("ICD",,$G(ECDT))
"RTN","ECUTL2",95,0)
 S DIC="757.01",DIC(0)=$S('$L($G(X)):"A",1:"")_"EQM",DIC("A")=PROMPT
"RTN","ECUTL2",96,0)
 D ^DIC
"RTN","ECUTL2",97,0)
 I $D(DTOUT)!$D(DUOUT) S ECOUT=1 Q
"RTN","ECUTL2",98,0)
 I X="" Q
"RTN","ECUTL2",99,0)
 I Y<0 S ECOUT=1 Q
"RTN","ECUTL2",100,0)
 S ECODE=$G(Y(1))
"RTN","ECUTL2",101,0)
 Q
"RTN","ECUTL2",102,0)
LSTDXS ;list icd9-code
"RTN","ECUTL2",103,0)
 N DXS
"RTN","ECUTL2",104,0)
 I $D(ECDXS) D
"RTN","ECUTL2",105,0)
 . W !?1,"Secondary ICD-9 code entered:"
"RTN","ECUTL2",106,0)
 . S DXS=""
"RTN","ECUTL2",107,0)
 . F  S DXS=$O(ECDXS(DXS)) Q:DXS=""  W !,?4,DXS,?15,$P($$ICDDX^ICDCODE(DXS,$G(ECDT)),"^",4)
"RTN","ECUTL2",108,0)
 Q
"RTN","ECUTL2",109,0)
PXUPD(ECDFN,ECDT,ECL,EC4,ECDXP,ECDXX,ECXIEN) ; Update all associated
"RTN","ECUTL2",110,0)
 ; procedures for an EC Patient encounter with the same primary and 
"RTN","ECUTL2",111,0)
 ; secondary dx codes
"RTN","ECUTL2",112,0)
 ;
"RTN","ECUTL2",113,0)
 ;   Input:   ECDFN     = Patient ien
"RTN","ECUTL2",114,0)
 ;            ECDT      = Date/time of procedure
"RTN","ECUTL2",115,0)
 ;            ECL       = Location ien
"RTN","ECUTL2",116,0)
 ;            EC4       = Clinic ien
"RTN","ECUTL2",117,0)
 ;            ECDXP     = Primary diagnoses code
"RTN","ECUTL2",118,0)
 ;            ECDXX     = Array of secondary diagnoses codes
"RTN","ECUTL2",119,0)
 ;            ECXIEN    = 721 ien, if define don't process
"RTN","ECUTL2",120,0)
 ;
"RTN","ECUTL2",121,0)
 ;  Output: ECERR  0 - Process completed
"RTN","ECUTL2",122,0)
 ;
"RTN","ECUTL2",123,0)
 N ECIEN,ECERR,DIE,DR,DA,DTOUT,DIROUT,ECDXIEN,ECPDX,ECDX,ECDXN,DIC,X
"RTN","ECUTL2",124,0)
 N ECVST,ECVAR1,VALQUIET,DXN,DXSIEN,DIK,ECDXS
"RTN","ECUTL2",125,0)
 S ECERR=0
"RTN","ECUTL2",126,0)
 I $D(ECDXP)="" Q ECERR
"RTN","ECUTL2",127,0)
 S ECPDX=$$PDXCK(ECDFN,ECDT,ECL,EC4)
"RTN","ECUTL2",128,0)
 I '$D(ECDXIEN) Q ECERR
"RTN","ECUTL2",129,0)
 S ECIEN="",DIE="^ECH("
"RTN","ECUTL2",130,0)
 F  S ECIEN=$O(ECDXIEN(ECIEN)) Q:ECIEN=""  D
"RTN","ECUTL2",131,0)
 . I $G(ECXIEN)'="",ECXIEN=ECIEN Q
"RTN","ECUTL2",132,0)
 . S ECNODE=$G(^ECH(ECIEN,"P")) I ECNODE="" Q
"RTN","ECUTL2",133,0)
 . I ECDXP'=$P(ECNODE,U,2) D
"RTN","ECUTL2",134,0)
 . . S DA=ECIEN,DR="20////"_ECDXP D ^DIE
"RTN","ECUTL2",135,0)
 . . S $P(^ECH(ECIEN,"PCE"),"~",11)=ECDXP
"RTN","ECUTL2",136,0)
 . ;delete all secondary diagnosis codes
"RTN","ECUTL2",137,0)
 . S DA(1)=ECIEN,DIK="^ECH("_DA(1)_",""DX"",",DA=0
"RTN","ECUTL2",138,0)
 . F  S DA=$O(^ECH(ECIEN,"DX",DA)) Q:'DA  D ^DIK
"RTN","ECUTL2",139,0)
 . I $D(^ECH(ECIEN,"DX")) K ^ECH(ECIEN,"DX")
"RTN","ECUTL2",140,0)
 . ;update secondary diagnosis codes on procedure
"RTN","ECUTL2",141,0)
 . S DXN="" F  S DXN=$O(ECDXX(DXN)) Q:DXN=""  D
"RTN","ECUTL2",142,0)
 . . S DXSIEN=$P(ECDXX(DXN),U) I DXSIEN<0 Q
"RTN","ECUTL2",143,0)
 . . K DIC,DD,DO S DIC(0)="L",DA(1)=ECIEN,DIC("P")=$P(^DD(721,38,0),U,2)
"RTN","ECUTL2",144,0)
 . . S X=DXSIEN,DIC="^ECH("_DA(1)_","_"""DX"""_"," D FILE^DICN
"RTN","ECUTL2",145,0)
 . ;delete visit and resend to PCE
"RTN","ECUTL2",146,0)
 . S ECVST=+$P($G(^ECH(ECIEN,0)),"^",21) I 'ECVST Q
"RTN","ECUTL2",147,0)
 . ;* Prepare all EC records with same Visit file entry to resend to PCE
"RTN","ECUTL2",148,0)
 . K EC2PCE S ECVAR1=$$FNDVST^ECUTL(ECVST,,.EC2PCE)
"RTN","ECUTL2",149,0)
 . ;- Set VALQUIET to stop Amb Care validator from broadcasting to screen
"RTN","ECUTL2",150,0)
 . N ECPKG,ECSOU
"RTN","ECUTL2",151,0)
 . S ECPKG=$O(^DIC(9.4,"B","EVENT CAPTURE",0)),ECSOU="EVENT CAPTURE DATA"
"RTN","ECUTL2",152,0)
 . S VALQUIET=1,ECVV=$$DELVFILE^PXAPI("ALL",ECVST,ECPKG,ECSOU)
"RTN","ECUTL2",153,0)
 . ;- Send to PCE task
"RTN","ECUTL2",154,0)
 . D PCETASK^ECPCEU(.EC2PCE) K EC2PCE
"RTN","ECUTL2",155,0)
 Q ECERR
"RTN","ECUURPC")
0^27^B5658708
"RTN","ECUURPC",1,0)
ECUURPC ;ALB/JAM - Event Capture Data Entry Broker Utilities ; 5 May 2008
"RTN","ECUURPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,42,49,94,95**;8 May 96;Build 26
"RTN","ECUURPC",3,0)
 ;
"RTN","ECUURPC",4,0)
ECHELP(RESULTS,ECARY) ;
"RTN","ECUURPC",5,0)
 ;
"RTN","ECUURPC",6,0)
 ;Broker call returns the entries from HELP FILE #9.2
"RTN","ECUURPC",7,0)
 ;        RPC: EC GETSCNHELP
"RTN","ECUURPC",8,0)
 ;INPUTS   ECARY - Contains the following elements
"RTN","ECUURPC",9,0)
 ;          HLPDA  - Help Frame Name
"RTN","ECUURPC",10,0)
 ;
"RTN","ECUURPC",11,0)
 ;OUTPUTS  RESULTS - Array of help text in the HELP FRAM File (#9.2)
"RTN","ECUURPC",12,0)
 ;
"RTN","ECUURPC",13,0)
 N HLPDA,DIC,X,Y
"RTN","ECUURPC",14,0)
 S HLPDA=$G(ECARY) I HLPDA="" Q
"RTN","ECUURPC",15,0)
 D SETENV^ECUMRPC K ^TMP($J,"ECHELP")
"RTN","ECUURPC",16,0)
 S DIC="^DIC(9.2,",DIC(0)="MN",X=HLPDA
"RTN","ECUURPC",17,0)
 D ^DIC M ^TMP($J,"ECHELP")=^DIC(9.2,+Y,1)
"RTN","ECUURPC",18,0)
 I $D(^TMP($J,"ECHELP")) D
"RTN","ECUURPC",19,0)
 . S $P(^TMP($J,"ECHELP",0),U)=$P(^DIC(9.2,+Y,0),U,2)
"RTN","ECUURPC",20,0)
 S RESULTS=$NA(^TMP($J,"ECHELP"))
"RTN","ECUURPC",21,0)
 Q
"RTN","ECUURPC",22,0)
FNDIEN(RESULTS,ECARY) ;find IEN
"RTN","ECUURPC",23,0)
 ;Broker call returns the IEN from a file
"RTN","ECUURPC",24,0)
 ;        RPC: EC GETIEN
"RTN","ECUURPC",25,0)
 ;INPUTS   ECARY - Contains the following data elements
"RTN","ECUURPC",26,0)
 ;          FIL  - File number
"RTN","ECUURPC",27,0)
 ;          TXT  - .01 description
"RTN","ECUURPC",28,0)
 ;
"RTN","ECUURPC",29,0)
 ;OUTPUTS  RESULTS - File IEN
"RTN","ECUURPC",30,0)
 ;
"RTN","ECUURPC",31,0)
 N TXT,FIL,DIC,X,Y
"RTN","ECUURPC",32,0)
 D SETENV^ECUMRPC
"RTN","ECUURPC",33,0)
 S FIL=$P(ECARY,U),TXT=$P(ECARY,U,2) I TXT=""!(FIL="") Q
"RTN","ECUURPC",34,0)
 S DIC=FIL,DIC(0)="MN",X=TXT
"RTN","ECUURPC",35,0)
 I FIL=81.3 S DIC("S")="I $P(^DIC(81.3,Y,0),U,5)'=1" ;PATCH 94
"RTN","ECUURPC",36,0)
 D ^DIC I Y=-1 Q
"RTN","ECUURPC",37,0)
 S RESULTS=+Y
"RTN","ECUURPC",38,0)
 Q
"RTN","ECUURPC",39,0)
ECDATE(RESULTS,ECARY) ;
"RTN","ECUURPC",40,0)
 ;
"RTN","ECUURPC",41,0)
 ;Broker call returns an Fileman internal date
"RTN","ECUURPC",42,0)
 ;        RPC: EC GETDATE
"RTN","ECUURPC",43,0)
 ;INPUTS   ECARY - Contains the following elements
"RTN","ECUURPC",44,0)
 ;          DTSTR  - Date String
"RTN","ECUURPC",45,0)
 ;          FLG    - Date Flag (optional)
"RTN","ECUURPC",46,0)
 ;
"RTN","ECUURPC",47,0)
 ;OUTPUTS  RESULTS - A valid Fileman date format^External format
"RTN","ECUURPC",48,0)
 ;
"RTN","ECUURPC",49,0)
 N ECDTSTR,DIC,X,Y,DTSTR,FLG
"RTN","ECUURPC",50,0)
 D SETENV^ECUMRPC
"RTN","ECUURPC",51,0)
 S DTSTR=$P(ECARY,U),FLG=$P(ECARY,U,2) I DTSTR="" Q
"RTN","ECUURPC",52,0)
 S X=DTSTR,%DT="XT"_$S(FLG="R":"R",1:""),%DT(0)="-NOW" D ^%DT
"RTN","ECUURPC",53,0)
 I +Y<1 S RESULTS="0^Invalid Date/Time" Q
"RTN","ECUURPC",54,0)
 S RESULTS=Y D D^DIQ
"RTN","ECUURPC",55,0)
 S RESULTS=RESULTS_U_Y
"RTN","ECUURPC",56,0)
 Q
"RTN","ECUURPC",57,0)
PATCH(RESULTS,ECARY)    ;
"RTN","ECUURPC",58,0)
 ;
"RTN","ECUURPC",59,0)
 ;Broker call returns 1 if patch X is installed
"RTN","ECUURPC",60,0)
 ;        RPC: EC GETPATCH
"RTN","ECUURPC",61,0)
 ;INPUTS   ECARY - contains the patch number
"RTN","ECUURPC",62,0)
 ;
"RTN","ECUURPC",63,0)
 ;OUTPUTS  RESULTS 1 OR 0
"RTN","ECUURPC",64,0)
 ;
"RTN","ECUURPC",65,0)
 I ECARY="" Q
"RTN","ECUURPC",66,0)
 D SETENV^ECUMRPC
"RTN","ECUURPC",67,0)
 S RESULTS=$$PATCH^XPDUTL(ECARY)
"RTN","ECUURPC",68,0)
 Q
"RTN","ECUURPC",69,0)
VERSRV(RESULTS,ECARY,VERSION)   ; Return server version of option name and 
"RTN","ECUURPC",70,0)
 ; minimum GUI client version.
"RTN","ECUURPC",71,0)
 ;
"RTN","ECUURPC",72,0)
 ;Server/client version consist of 4 pieces, namely
"RTN","ECUURPC",73,0)
 ;    major version.minor version.release.build  (ex. 2.0.10.1)
"RTN","ECUURPC",74,0)
 ;
"RTN","ECUURPC",75,0)
 ;Broker call returns server version of option name
"RTN","ECUURPC",76,0)
 ;        RPC: EC GETVERSION
"RTN","ECUURPC",77,0)
 ;INPUTS   ECARY - contains the option name
"RTN","ECUURPC",78,0)
 ;         VERSION - EC GUI client version ;stay in partition for session
"RTN","ECUURPC",79,0)
 ;
"RTN","ECUURPC",80,0)
 ;OUTPUTS  RESULTS version number OR null ("")
"RTN","ECUURPC",81,0)
 ;           current server version^minimum client version
"RTN","ECUURPC",82,0)
 ;
"RTN","ECUURPC",83,0)
 S ECCLVER=$G(VERSION)
"RTN","ECUURPC",84,0)
 I $G(ECARY)="" Q
"RTN","ECUURPC",85,0)
 N ECLST,ECMINV
"RTN","ECUURPC",86,0)
 S ECMINV="2.1.1.0"  ;Minimum version of EC GUI client
"RTN","ECUURPC",87,0)
 D FIND^DIC(19,"",1,"X",ECARY,1,,,,"ECLST")
"RTN","ECUURPC",88,0)
 I 'ECLST("DILIST",0) S RESULTS="" Q
"RTN","ECUURPC",89,0)
 S RESULTS=ECLST("DILIST","ID",1,1)
"RTN","ECUURPC",90,0)
 S RESULTS=$P(RESULTS,"version ",2)_U_ECMINV
"RTN","ECUURPC",91,0)
 Q
"RTN","ECV2RPC")
0^28^B23577970
"RTN","ECV2RPC",1,0)
ECV2RPC ;ALB/ACS - Event Capture Spreadsheet Validation ;30 Aug 2007
"RTN","ECV2RPC",2,0)
 ;;2.0; EVENT CAPTURE ;**25,30,49,95**;8 May 96;Build 26
"RTN","ECV2RPC",3,0)
 ;
"RTN","ECV2RPC",4,0)
 ;-----------------------------------------------------------------------
"RTN","ECV2RPC",5,0)
 ;       Validates the following Event Capture spreadsheet fields:
"RTN","ECV2RPC",6,0)
 ;       1. Location
"RTN","ECV2RPC",7,0)
 ;       2. Patient SSN
"RTN","ECV2RPC",8,0)
 ;       3. Patient Name
"RTN","ECV2RPC",9,0)
 ;-----------------------------------------------------------------------
"RTN","ECV2RPC",10,0)
 ;=======================================================================
"RTN","ECV2RPC",11,0)
 ;MODIFICATIONS
"RTN","ECV2RPC",12,0)
 ;08/2001    EC*2.0*30  Updated the error message for Location
"RTN","ECV2RPC",13,0)
 ;=======================================================================
"RTN","ECV2RPC",14,0)
 ;
"RTN","ECV2RPC",15,0)
 ;--Set up error flag
"RTN","ECV2RPC",16,0)
 S ECERRFLG=0
"RTN","ECV2RPC",17,0)
 ;
"RTN","ECV2RPC",18,0)
 ;--Location must be on the Institution file
"RTN","ECV2RPC",19,0)
 I '$D(^DIC(4,ECSTAV)),'$D(^DIC(4,"D",ECSTAV)) D 
"RTN","ECV2RPC",20,0)
 . ; Location not on the VistA file
"RTN","ECV2RPC",21,0)
 . S ECERRMSG=$P($T(STA1^ECV2RPC),";;",2)
"RTN","ECV2RPC",22,0)
 . S ECCOLERR=ECSTAPC
"RTN","ECV2RPC",23,0)
 . D ERROR
"RTN","ECV2RPC",24,0)
 . Q
"RTN","ECV2RPC",25,0)
 ;Check for multiple station number entries
"RTN","ECV2RPC",26,0)
 N LOC,C,STR
"RTN","ECV2RPC",27,0)
 S (LOC,C)=0,STR=""
"RTN","ECV2RPC",28,0)
 F  S LOC=$O(^DIC(4,"D",ECSTAV,LOC)) Q:'LOC  S C=C+1 D
"RTN","ECV2RPC",29,0)
 . S LOC(LOC)=ECSTAV_", Location IEN "_LOC_", "_$P(^DIC(4,LOC,0),"^")
"RTN","ECV2RPC",30,0)
 I C>1 S LOC=0 F  S LOC=$O(LOC(LOC)) Q:'LOC  D
"RTN","ECV2RPC",31,0)
 . S ECERRMSG=$P($T(STA2^ECV2RPC),";;",2)_LOC(LOC)
"RTN","ECV2RPC",32,0)
 . S ECCOLERR=ECSTAPC
"RTN","ECV2RPC",33,0)
 . D ERROR
"RTN","ECV2RPC",34,0)
 I C=1,$D(^DIC(4,"D",ECSTAV)) S ECSTAV=$O(^DIC(4,"D",ECSTAV,"")) ;get ien
"RTN","ECV2RPC",35,0)
 ;
"RTN","ECV2RPC",36,0)
 ;--Patient SSN must be on the Patient file--
"RTN","ECV2RPC",37,0)
 N ECNAMEU,ECVNAMEV,ECVNAME,ECSSNNUM,ECI
"RTN","ECV2RPC",38,0)
 S (ECSSNIEN,ECERRFLG)=0,ECSSNNUM=+ECSSNV
"RTN","ECV2RPC",39,0)
 I $L(ECSSNNUM)>9!$L(ECSSNV)>10 D
"RTN","ECV2RPC",40,0)
 . ; User has entered an SSN that is too long
"RTN","ECV2RPC",41,0)
 . S ECERRMSG=$P($T(SSN5^ECV2RPC),";;",2)
"RTN","ECV2RPC",42,0)
 . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",43,0)
 . D ERROR
"RTN","ECV2RPC",44,0)
 . Q
"RTN","ECV2RPC",45,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",46,0)
 . ; -add leading zeros if needed
"RTN","ECV2RPC",47,0)
 . I $L(ECSSNNUM)<9 S ECSSNV=$E("000000000",1,9-$L(ECSSNNUM))_ECSSNNUM
"RTN","ECV2RPC",48,0)
 . I $L(ECSSNV)>10 D 
"RTN","ECV2RPC",49,0)
 . . ; User has entered an invalid SSN
"RTN","ECV2RPC",50,0)
 . . S ECERRMSG=$P($T(SSN5^ECV2RPC),";;",2)
"RTN","ECV2RPC",51,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",52,0)
 . . D ERROR
"RTN","ECV2RPC",53,0)
 . . Q
"RTN","ECV2RPC",54,0)
 . I 'ECERRFLG,$L(ECSSNV)=10 D
"RTN","ECV2RPC",55,0)
 . . I $E(ECSSNV,10,10)'="P" D
"RTN","ECV2RPC",56,0)
 . . . ; Invalid SSN
"RTN","ECV2RPC",57,0)
 . . . S ECERRMSG=$P($T(SSN5^ECV2RPC),";;",2)
"RTN","ECV2RPC",58,0)
 . . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",59,0)
 . . . D ERROR
"RTN","ECV2RPC",60,0)
 . . Q
"RTN","ECV2RPC",61,0)
 . I 'ECERRFLG,'$D(^DPT("SSN",ECSSNV)) D
"RTN","ECV2RPC",62,0)
 . . ; No SSN x-ref on patient file
"RTN","ECV2RPC",63,0)
 . . S ECERRMSG=$P($T(SSN1^ECV2RPC),";;",2)
"RTN","ECV2RPC",64,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",65,0)
 . . D ERROR
"RTN","ECV2RPC",66,0)
 . . Q
"RTN","ECV2RPC",67,0)
 . Q
"RTN","ECV2RPC",68,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",69,0)
 . ; -get SSN IEN
"RTN","ECV2RPC",70,0)
 . S ECSSNIEN=$O(^DPT("SSN",ECSSNV,0))
"RTN","ECV2RPC",71,0)
 . I 'ECSSNIEN D
"RTN","ECV2RPC",72,0)
 . . S ECERRMSG=$P($T(SSN2^ECV2RPC),";;",2)
"RTN","ECV2RPC",73,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",74,0)
 . . D ERROR
"RTN","ECV2RPC",75,0)
 . . Q
"RTN","ECV2RPC",76,0)
 . Q
"RTN","ECV2RPC",77,0)
 I 'ECERRFLG,'$D(^DPT(ECSSNIEN,0)) D
"RTN","ECV2RPC",78,0)
 . ; SSN record not found
"RTN","ECV2RPC",79,0)
 . S ECERRMSG=$P($T(SSN3^ECV2RPC),";;",2)
"RTN","ECV2RPC",80,0)
 . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",81,0)
 . D ERROR
"RTN","ECV2RPC",82,0)
 . Q
"RTN","ECV2RPC",83,0)
 ;
"RTN","ECV2RPC",84,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",85,0)
 . ; -Compare patient file ssn to patient ssn
"RTN","ECV2RPC",86,0)
 . S ECVSSN=$P(^DPT(ECSSNIEN,0),U,9)
"RTN","ECV2RPC",87,0)
 . I ECVSSN'=ECSSNV D
"RTN","ECV2RPC",88,0)
 . . ; Spreadsheet ssn doesn't match vista
"RTN","ECV2RPC",89,0)
 . . S ECERRMSG=$P($T(SSN4^ECV2RPC),";;",2)
"RTN","ECV2RPC",90,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",91,0)
 . . D ERROR
"RTN","ECV2RPC",92,0)
 . . Q
"RTN","ECV2RPC",93,0)
 . Q
"RTN","ECV2RPC",94,0)
 ;--Patient Name must match VistA name--
"RTN","ECV2RPC",95,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",96,0)
 . S ECVNAME=$P(^DPT(ECSSNIEN,0),U,1)
"RTN","ECV2RPC",97,0)
 . I '$D(ECVNAME) D
"RTN","ECV2RPC",98,0)
 . . ; Patient name missing from VistA file
"RTN","ECV2RPC",99,0)
 . . S ECERRMSG=$P($T(NAME1^ECV2RPC),";;",2)
"RTN","ECV2RPC",100,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",101,0)
 . . D ERROR
"RTN","ECV2RPC",102,0)
 . . Q
"RTN","ECV2RPC",103,0)
 . Q
"RTN","ECV2RPC",104,0)
 I 'ECERRFLG,'ECDECPAT D
"RTN","ECV2RPC",105,0)
 . N DFN,VADM S DFN=ECSSNIEN D 2^VADPT I +VADM(6) D
"RTN","ECV2RPC",106,0)
 . . S ECERRMSG="WARNING: [PATIENT DIED ON "_$P(VADM(6),U,2)_"]"
"RTN","ECV2RPC",107,0)
 . . S ECCOLERR=ECSSNPC
"RTN","ECV2RPC",108,0)
 . . D ERROR
"RTN","ECV2RPC",109,0)
 ; -- Patient last name check
"RTN","ECV2RPC",110,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",111,0)
 . F ECI=1:1:$L($P(ECPATV,",")) D  Q:ECERRFLG
"RTN","ECV2RPC",112,0)
 . .S ECVNAMEV=$E($P(ECVNAME,","),1,ECI),ECNAMEU=$E($P(ECPATV,","),1,ECI)
"RTN","ECV2RPC",113,0)
 . .I ECVNAMEV=ECNAMEU Q
"RTN","ECV2RPC",114,0)
 . .S ECERRMSG=$P($T(NAME2^ECV2RPC),";;",2)
"RTN","ECV2RPC",115,0)
 . .S ECCOLERR=ECPATLPC
"RTN","ECV2RPC",116,0)
 . .D ERROR
"RTN","ECV2RPC",117,0)
 ; -- Patient first name check
"RTN","ECV2RPC",118,0)
 I 'ECERRFLG D
"RTN","ECV2RPC",119,0)
 . F ECI=1:1:$L($P(ECPATV,",",2)) D  Q:ECERRFLG
"RTN","ECV2RPC",120,0)
 . .S ECVNAMEV=$E($P(ECVNAME,",",2),1,ECI),ECNAMEU=$E($P(ECPATV,",",2),1,ECI)
"RTN","ECV2RPC",121,0)
 . .I ECVNAMEV=ECNAMEU Q
"RTN","ECV2RPC",122,0)
 . .S ECERRMSG=$P($T(NAME3^ECV2RPC),";;",2)
"RTN","ECV2RPC",123,0)
 . .S ECCOLERR=ECPATLPC
"RTN","ECV2RPC",124,0)
 . .D ERROR
"RTN","ECV2RPC",125,0)
 Q
"RTN","ECV2RPC",126,0)
 ;
"RTN","ECV2RPC",127,0)
ERROR ;--Set up array entry to contain the following:
"RTN","ECV2RPC",128,0)
 ;1. record number
"RTN","ECV2RPC",129,0)
 ;2. column number on spreadsheet containing the record number
"RTN","ECV2RPC",130,0)
 ;3. column number on spreadsheet containing the data in error
"RTN","ECV2RPC",131,0)
 ;4. error message
"RTN","ECV2RPC",132,0)
 ;
"RTN","ECV2RPC",133,0)
 S ECINDEX=ECINDEX+1
"RTN","ECV2RPC",134,0)
 S RESULTS(ECINDEX)=ECRECV_"^"_ECRECPC_"^"_ECCOLERR_"^"_ECERRMSG_"^"
"RTN","ECV2RPC",135,0)
 S ECERRFLG=1
"RTN","ECV2RPC",136,0)
 Q
"RTN","ECV2RPC",137,0)
 ;
"RTN","ECV2RPC",138,0)
 ;Error messages:
"RTN","ECV2RPC",139,0)
 ;
"RTN","ECV2RPC",140,0)
STA1 ;;Location not on institution file(#4)
"RTN","ECV2RPC",141,0)
STA2 ;;Multiple entries found for Location/Station #
"RTN","ECV2RPC",142,0)
SSN1 ;;No SSN x-ref on patient file(#2)
"RTN","ECV2RPC",143,0)
SSN2 ;;No SSN entry on patient file(#2)
"RTN","ECV2RPC",144,0)
SSN3 ;;No internal entry on patient file(#2) for ssn x-ref
"RTN","ECV2RPC",145,0)
SSN4 ;;SSN doesn't match SSN on patient file(#2)
"RTN","ECV2RPC",146,0)
SSN5 ;;SSN invalid
"RTN","ECV2RPC",147,0)
NAME1 ;;Patient Name is missing from VistA patient file(#2)
"RTN","ECV2RPC",148,0)
NAME2 ;;Patient last name doesn't match VistA
"RTN","ECV2RPC",149,0)
NAME3 ;;Patient first name doesn't match VistA
"UP",721,721.042,-1)
721^PRV
"UP",721,721.042,0)
721.042
"VER")
8.0^22.0
"^DD",721,721,42,0)
PROVIDER MULTIPLE^721.042PA^^PRV;0
"^DD",721,721,42,21,0)
^.001^5^5^3080722^^^
"^DD",721,721,42,21,1,0)
This is the provider(s) giving patient care for this encounter.
"^DD",721,721,42,21,2,0)
 
"^DD",721,721,42,21,3,0)
Prior to the installation of EC*2.0*72 provider data was stored in fields 
"^DD",721,721,42,21,4,0)
#10, #15 and #17.  EC*2.0*72 converted and stored these fields' data in 
"^DD",721,721,42,21,5,0)
this field #42,"PROVIDER MULTIPLE".
"^DD",721,721,42,23,0)
^.001^1^1^3080722^^^^
"^DD",721,721,42,23,1,0)
This is a pointer to the NEW PERSON file #200.
"^DD",721,721.042,0)
PROVIDER MULTIPLE SUB-FIELD^^.02^2
"^DD",721,721.042,0,"NM","PROVIDER MULTIPLE")

"^DD",721,721.042,.01,0)
PROVIDER^MRP200'^VA(200,^0;1^Q
"^DD",721,721.042,.01,1,0)
^.1
"^DD",721,721.042,.01,1,1,0)
721.042^B
"^DD",721,721.042,.01,1,1,1)
S ^ECH(DA(1),"PRV","B",$E(X,1,30),DA)=""
"^DD",721,721.042,.01,1,1,2)
K ^ECH(DA(1),"PRV","B",$E(X,1,30),DA)
"^DD",721,721.042,.01,1,2,0)
721^APRV
"^DD",721,721.042,.01,1,2,1)
S ^ECH("APRV",$E(X,1,30),DA(1),DA)=""
"^DD",721,721.042,.01,1,2,2)
K ^ECH("APRV",$E(X,1,30),DA(1),DA)
"^DD",721,721.042,.01,1,2,"%D",0)
^^3^3^3080722^
"^DD",721,721.042,.01,1,2,"%D",1,0)
This cross-reference provides a whole file index of the the PROVIDER
"^DD",721,721.042,.01,1,2,"%D",2,0)
(#.01) subfield of the PROVIDER MULTIPLE (#42) field to improve the
"^DD",721,721.042,.01,1,2,"%D",3,0)
performance of provider-based reports.
"^DD",721,721.042,.01,1,2,"DT")
3080722
"^DD",721,721.042,.01,3)
Enter the name of the provider performing this procedure.
"^DD",721,721.042,.01,21,0)
^^8^8^3080722^
"^DD",721,721.042,.01,21,1,0)
This field contains the primary or secondary provider associated with the
"^DD",721,721.042,.01,21,2,0)
encounter.
"^DD",721,721.042,.01,21,3,0)
 
"^DD",721,721.042,.01,21,4,0)
The primary provider is usually the physician responsible for THIS
"^DD",721,721.042,.01,21,5,0)
PARTICULAR encounter.
"^DD",721,721.042,.01,21,6,0)
 
"^DD",721,721.042,.01,21,7,0)
Secondary providers are those providers who also provided care for this 
"^DD",721,721.042,.01,21,8,0)
encounter.
"^DD",721,721.042,.01,23,0)
^.001^1^1^3080722^^^^
"^DD",721,721.042,.01,23,1,0)
A pointer to file #200.
"^DD",721,721.042,.01,"DT")
3080722
**END**
**END**

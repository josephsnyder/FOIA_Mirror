Released IB*2*397 SEQ #365
Extracted from mail message
**KIDS**:IB*2.0*397^

**INSTALL NAME**
IB*2.0*397
"BLD",7620,0)
IB*2.0*397^INTEGRATED BILLING^0^3080515^y
"BLD",7620,1,0)
^^2^2^3080506^
"BLD",7620,1,1,0)
This patch is addressing an issue regarding bills not automatically 
"BLD",7620,1,2,0)
audited by the Auto Audit process in Accounts Receivable package.
"BLD",7620,4,0)
^9.64PA^^
"BLD",7620,6.3)
3
"BLD",7620,"KRN",0)
^9.67PA^8989.52^19
"BLD",7620,"KRN",.4,0)
.4
"BLD",7620,"KRN",.401,0)
.401
"BLD",7620,"KRN",.402,0)
.402
"BLD",7620,"KRN",.403,0)
.403
"BLD",7620,"KRN",.5,0)
.5
"BLD",7620,"KRN",.84,0)
.84
"BLD",7620,"KRN",3.6,0)
3.6
"BLD",7620,"KRN",3.8,0)
3.8
"BLD",7620,"KRN",9.2,0)
9.2
"BLD",7620,"KRN",9.8,0)
9.8
"BLD",7620,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",7620,"KRN",9.8,"NM",1,0)
IBCEST^^0^B78288248
"BLD",7620,"KRN",9.8,"NM",2,0)
IBCEST1^^0^B3887328
"BLD",7620,"KRN",9.8,"NM","B","IBCEST",1)

"BLD",7620,"KRN",9.8,"NM","B","IBCEST1",2)

"BLD",7620,"KRN",19,0)
19
"BLD",7620,"KRN",19.1,0)
19.1
"BLD",7620,"KRN",101,0)
101
"BLD",7620,"KRN",409.61,0)
409.61
"BLD",7620,"KRN",771,0)
771
"BLD",7620,"KRN",870,0)
870
"BLD",7620,"KRN",8989.51,0)
8989.51
"BLD",7620,"KRN",8989.52,0)
8989.52
"BLD",7620,"KRN",8994,0)
8994
"BLD",7620,"KRN","B",.4,.4)

"BLD",7620,"KRN","B",.401,.401)

"BLD",7620,"KRN","B",.402,.402)

"BLD",7620,"KRN","B",.403,.403)

"BLD",7620,"KRN","B",.5,.5)

"BLD",7620,"KRN","B",.84,.84)

"BLD",7620,"KRN","B",3.6,3.6)

"BLD",7620,"KRN","B",3.8,3.8)

"BLD",7620,"KRN","B",9.2,9.2)

"BLD",7620,"KRN","B",9.8,9.8)

"BLD",7620,"KRN","B",19,19)

"BLD",7620,"KRN","B",19.1,19.1)

"BLD",7620,"KRN","B",101,101)

"BLD",7620,"KRN","B",409.61,409.61)

"BLD",7620,"KRN","B",771,771)

"BLD",7620,"KRN","B",870,870)

"BLD",7620,"KRN","B",8989.51,8989.51)

"BLD",7620,"KRN","B",8989.52,8989.52)

"BLD",7620,"KRN","B",8994,8994)

"BLD",7620,"QUES",0)
^9.62^^
"BLD",7620,"REQB",0)
^9.611^1^1
"BLD",7620,"REQB",1,0)
IB*2.0*368^2
"BLD",7620,"REQB","B","IB*2.0*368",1)

"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
397^3080515
"PKG",200,22,1,"PAH",1,1,0)
^^2^2^3080515
"PKG",200,22,1,"PAH",1,1,1,0)
This patch is addressing an issue regarding bills not automatically 
"PKG",200,22,1,"PAH",1,1,2,0)
audited by the Auto Audit process in Accounts Receivable package.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","IBCEST")
0^1^B78288248^B78410269
"RTN","IBCEST",1,0)
IBCEST ;ALB/TMP - 837 EDI STATUS MESSAGE PROCESSING ;17-APR-96
"RTN","IBCEST",2,0)
 ;;2.0;INTEGRATED BILLING;**137,189,197,135,283,320,368,397**;21-MAR-94;Build 3
"RTN","IBCEST",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBCEST",4,0)
 ; IA 4043 for call to AUDITX^PRCAUDT
"RTN","IBCEST",5,0)
 Q
"RTN","IBCEST",6,0)
 ;
"RTN","IBCEST",7,0)
UPD361(IBTDA) ; Update IB BILL STATUS MESSAGES file
"RTN","IBCEST",8,0)
 ; IBTDA = ien of return message in file 364.2
"RTN","IBCEST",9,0)
 ;
"RTN","IBCEST",10,0)
 N IB,IB0,IBSEQ,IB00,IBBILL,IBBTCH,IBMNUM
"RTN","IBCEST",11,0)
 ;
"RTN","IBCEST",12,0)
 I '$$LOCK^IBCEM(IBTDA) G UPDQ ;Lock message in file 364.2
"RTN","IBCEST",13,0)
 ;
"RTN","IBCEST",14,0)
 S IB0=$G(^IBA(364.2,IBTDA,0))
"RTN","IBCEST",15,0)
 S IBMNUM=$P(IB0,U) ; Message number
"RTN","IBCEST",16,0)
 S IB00=$G(^IBA(364,+$P(IB0,U,5),0)) ; Transmit bill entry
"RTN","IBCEST",17,0)
 S IBBILL=+IB00 ; Actual bill ien in file 399
"RTN","IBCEST",18,0)
 S IBBTCH=$P(IB0,U,4) ; Batch #
"RTN","IBCEST",19,0)
 ;
"RTN","IBCEST",20,0)
 ; Auto-audit bills based on status code on '10' record of status msg
"RTN","IBCEST",21,0)
 ; flat file
"RTN","IBCEST",22,0)
 I IBBILL,$P($T(PRCAUDT+1^PRCAUDT),"**",2)[",173" D
"RTN","IBCEST",23,0)
 . N Z,Z0,Z1,OK
"RTN","IBCEST",24,0)
 . Q:+$$STA^PRCAFN(IBBILL)'=104
"RTN","IBCEST",25,0)
 . S (Z,OK)=0
"RTN","IBCEST",26,0)
 . F  S Z=$O(^IBA(364.2,IBTDA,2,Z)) Q:'Z  S Z0=$P($G(^(Z,0)),"##RAW DATA: ",2) I +Z0=10 S Z0=$P(Z0,U,5) D  Q:OK
"RTN","IBCEST",27,0)
 .. ; Strip leading spaces
"RTN","IBCEST",28,0)
 .. S Z0=$$TRIM^XLFSTR(Z0)
"RTN","IBCEST",29,0)
 .. Q:Z0=""
"RTN","IBCEST",30,0)
 .. I $$SCODE^IBCEST1(Z0),$P($G(^DGCR(399.3,+$P($G(^DGCR(399,IBBILL,0)),U,7),0)),U,11) D AUDITX^PRCAUDT(IBBILL) S OK=1 ; IA 4043
"RTN","IBCEST",31,0)
 ;
"RTN","IBCEST",32,0)
 I $S(IBMNUM="":1,1:'IBBILL&(IBBTCH="")) D DELMSG^IBCESRV2(IBTDA) G UPDQ
"RTN","IBCEST",33,0)
 ;
"RTN","IBCEST",34,0)
 ; Individual bill
"RTN","IBCEST",35,0)
 I IBBILL D  G UPDQ
"RTN","IBCEST",36,0)
 . N IBA1,IBMSG0,IBPID
"RTN","IBCEST",37,0)
 . S IBPID="",IBA1=0
"RTN","IBCEST",38,0)
 . F  S IBA1=$O(^IBA(364.2,IBTDA,2,IBA1)) Q:'IBA1  S IBMSG0=$P($G(^(IBA1,0)),"##RAW DATA: ",2) I +IBMSG0=277,$P(IBMSG0,U,5)="N" S IBPID=$P(IBMSG0,U,11) Q
"RTN","IBCEST",39,0)
 . S IBSEQ=$P(IB00,U,8) S:IBSEQ="" IBSEQ="P"
"RTN","IBCEST",40,0)
 . D STORE(IB0,IBBTCH,IBMNUM,IBTDA,IBBILL,IBSEQ,IBPID,1)
"RTN","IBCEST",41,0)
 ;
"RTN","IBCEST",42,0)
 ; Batch - update each bill separately
"RTN","IBCEST",43,0)
 S IBBILL=""
"RTN","IBCEST",44,0)
 F  S IBBILL=$O(^IBA(364,"ABABI",+IBBTCH,IBBILL)) Q:'IBBILL  D
"RTN","IBCEST",45,0)
 . Q:$D(^TMP("IBCONF",$J,IBBILL))  ;Bill was rejected
"RTN","IBCEST",46,0)
 . S IB=$O(^IBA(364,"ABABI",+IBBTCH,IBBILL,0)) Q:'IB
"RTN","IBCEST",47,0)
 . S IBSEQ=$P($G(^IBA(364,IB,0)),U,8) S:IBSEQ="" IBSEQ="P"
"RTN","IBCEST",48,0)
 . D STORE(IB0,IBBTCH,IBMNUM,IBTDA,IBBILL,IBSEQ,"",0)
"RTN","IBCEST",49,0)
 ;
"RTN","IBCEST",50,0)
 Q
"RTN","IBCEST",51,0)
 ;
"RTN","IBCEST",52,0)
STORE(IB0,IBBTCH,IBMNUM,IBTDA,IBBILL,IBSEQ,IBPID,IB1) ;
"RTN","IBCEST",53,0)
 ;
"RTN","IBCEST",54,0)
 ; IB0 = 0-node of message in file 364.2
"RTN","IBCEST",55,0)
 ; IBBTCH = ien of batch in file 364.1
"RTN","IBCEST",56,0)
 ; IBMNUM = actual message number
"RTN","IBCEST",57,0)
 ; IBTDA = ien of message in file 364.2
"RTN","IBCEST",58,0)
 ; IBBILL = ien of bill in 399
"RTN","IBCEST",59,0)
 ; IBSEQ = P/S/T/ for COB sequence related to message
"RTN","IBCEST",60,0)
 ; IBPID = the payer id returned from clearinghouse for the claim
"RTN","IBCEST",61,0)
 ; IB1 = flag that says if the message was for a single bill or a batch.
"RTN","IBCEST",62,0)
 ;       Batch statuses have an additional standard text entry.
"RTN","IBCEST",63,0)
 ;       1 = single bill 0 = batch
"RTN","IBCEST",64,0)
 ; 
"RTN","IBCEST",65,0)
 N DA,DIK,DIE,DIC,X,Y,DR,DO,DD,DLAYGO,Z,Z0,Z1,Z2,Z3,IBT,IBDUP,IBFLDS,IBY,IBAUTO,IBLN
"RTN","IBCEST",66,0)
 ;
"RTN","IBCEST",67,0)
 S X=IBBILL,IBDUP=0
"RTN","IBCEST",68,0)
 ;
"RTN","IBCEST",69,0)
 I $D(^IBM(361,"AC",IBMNUM\1)) D  ; Message already there for bill
"RTN","IBCEST",70,0)
 . S Z=0 F  S Z=$O(^IBM(361,"AC",IBMNUM\1,Z)) Q:'Z  I +$G(^IBM(361,Z,0))=IBBILL S IBDUP=Z Q
"RTN","IBCEST",71,0)
 ;
"RTN","IBCEST",72,0)
 S IBFLDS=".02////"_$P(IB0,U,3)
"RTN","IBCEST",73,0)
 S IBFLDS=IBFLDS_";.03////"_$S($$EXTERNAL^DILFD(364.2,.02,"U",$P(IB0,U,2))["REJ":"R",1:"I")_";.05////"_IBBTCH_";.06////"_IBMNUM_";.04////"_+$P(IB0,U,8)_";.07////"_IBSEQ_$S($P(IB0,U,5):";.11////"_$P(IB0,U,5),1:"")
"RTN","IBCEST",74,0)
 S IBFLDS=IBFLDS_";.12////"_$P(IB0,U,10)_";.09////0"
"RTN","IBCEST",75,0)
 S IBFLDS=IBFLDS_";.15////"_$$CHKSUM^IBCEST1("^IBA(364.2,"_IBTDA_",2)")
"RTN","IBCEST",76,0)
 I IBPID'="" D
"RTN","IBCEST",77,0)
 . S IBPID("TYPE")=$S($$FT^IBCEF(IBBILL)=2:"P",1:"I")
"RTN","IBCEST",78,0)
 . D UPDINS(.IBPID,$$POLICY^IBCEF(IBBILL,1,$TR(IBSEQ,"PST","123")),IBBILL)
"RTN","IBCEST",79,0)
 ;
"RTN","IBCEST",80,0)
 I IBDUP D  I $D(Y) G UPDQ
"RTN","IBCEST",81,0)
 . ; Stuff fields into existing entry
"RTN","IBCEST",82,0)
 . ; (may be needed for reprocessing of aborted updates)
"RTN","IBCEST",83,0)
 . S DIE="^IBM(361,",DA=IBDUP,DR=IBFLDS_";1///@"
"RTN","IBCEST",84,0)
 . D ^DIE
"RTN","IBCEST",85,0)
 . I $D(Y) S IBY=-1 Q  ;Update not successful
"RTN","IBCEST",86,0)
 . S IBY=IBDUP
"RTN","IBCEST",87,0)
 ;
"RTN","IBCEST",88,0)
 K IBT
"RTN","IBCEST",89,0)
 I 'IBDUP D  ; Create new entry and stuff fields
"RTN","IBCEST",90,0)
 . S DIC(0)="L",DIC="^IBM(361,",DLAYGO=361
"RTN","IBCEST",91,0)
 . S DIC("DR")=IBFLDS
"RTN","IBCEST",92,0)
 . D FILE^DICN
"RTN","IBCEST",93,0)
 . K DO,DD,DLAYGO,DIC
"RTN","IBCEST",94,0)
 . S IBY=+Y
"RTN","IBCEST",95,0)
 . Q:IBY'>0
"RTN","IBCEST",96,0)
 . ;
"RTN","IBCEST",97,0)
 . ; IB*2*320 - Check for duplicate status message
"RTN","IBCEST",98,0)
 . NEW IBNEW,IBOLD,PCE,Z,DIK,DA
"RTN","IBCEST",99,0)
 . S IBNEW=""
"RTN","IBCEST",100,0)
 . F PCE=3,4,5,7,8,11,15 S IBNEW=IBNEW_$P($G(^IBM(361,IBY,0)),U,PCE)_U
"RTN","IBCEST",101,0)
 . S Z=0
"RTN","IBCEST",102,0)
 . F  S Z=$O(^IBM(361,"B",IBBILL,Z)) Q:'Z  I Z'=IBY D  Q:IBY'>0
"RTN","IBCEST",103,0)
 .. S IBOLD=""
"RTN","IBCEST",104,0)
 .. F PCE=3,4,5,7,8,11,15 S IBOLD=IBOLD_$P($G(^IBM(361,Z,0)),U,PCE)_U
"RTN","IBCEST",105,0)
 .. I IBNEW'=IBOLD Q   ; no duplicate so get the next one
"RTN","IBCEST",106,0)
 .. S DIK="^IBM(361,",DA=IBY,IBY=-1 D ^DIK D DELMSG^IBCESRV2(IBTDA)
"RTN","IBCEST",107,0)
 .. Q
"RTN","IBCEST",108,0)
 . Q
"RTN","IBCEST",109,0)
 ;
"RTN","IBCEST",110,0)
 I IBY>0 D  ;Move text over
"RTN","IBCEST",111,0)
 . K IBT
"RTN","IBCEST",112,0)
 . ;
"RTN","IBCEST",113,0)
 . D BLDMSG(IB1,IBTDA,.IBT,.IBAUTO)
"RTN","IBCEST",114,0)
 . ;
"RTN","IBCEST",115,0)
 . ; IB*2*368 - ymg - 2Q,RE,RP messages will be filed as informational
"RTN","IBCEST",116,0)
 . ; Z0 is the flag for 2Q code
"RTN","IBCEST",117,0)
 . ; Z1 is the flag for RE code
"RTN","IBCEST",118,0)
 . ; Z2 is the flag for RP code
"RTN","IBCEST",119,0)
 . ; Z3 is the flag for autofiling the message
"RTN","IBCEST",120,0)
 . I $P($G(^IBM(361,+IBY,0)),U,3)="R" D
"RTN","IBCEST",121,0)
 .. S Z="",(Z0,Z1,Z2,Z3)=0 F  S Z=$O(IBT(Z)) Q:Z=""!(Z3=1)  D
"RTN","IBCEST",122,0)
 ... S IBLN=$$UP^XLFSTR($G(IBT(Z)))
"RTN","IBCEST",123,0)
 ... I (Z0!Z1!Z2)=0 D
"RTN","IBCEST",124,0)
 .... S:IBLN?.E1"CODE:".P1"2Q".E Z0=1
"RTN","IBCEST",125,0)
 .... S:IBLN?.E1"CODE:".P1"RE".E Z1=1
"RTN","IBCEST",126,0)
 .... S:IBLN?.E1"CODE:".P1"RP".E Z2=1
"RTN","IBCEST",127,0)
 ... I Z0=1 S:IBLN?.P1"CLAIM".P1"REJECTED".P1"BY".P1"CLEARINGHOUSE".E Z3=1
"RTN","IBCEST",128,0)
 ... I Z1=1 S:IBLN?.P1"ELECTRONIC".P1"CLAIM".P1"REJECTED".P1"BY".P1"EMDEON".E Z3=1
"RTN","IBCEST",129,0)
 ... I Z2=1 S:IBLN?.P1"PAPER".P1"CLAIM".P1"REJECTED".P1"BY".P1"EMDEON".E Z3=1
"RTN","IBCEST",130,0)
 .. I Z3=1 S IBAUTO=1,DIE=361,DA=+IBY,DR=".03////I" D ^DIE
"RTN","IBCEST",131,0)
 .. Q
"RTN","IBCEST",132,0)
 . ;
"RTN","IBCEST",133,0)
 . ; if info msg, ck for no review needed based on first line of text
"RTN","IBCEST",134,0)
 . I $G(IBAUTO),$P($G(^IBM(361,+IBY,0)),U,3)="I" D
"RTN","IBCEST",135,0)
 .. S DIE="^IBM(361,",DR=".09////2;.14////1;.1////F",DA=+IBY D ^DIE
"RTN","IBCEST",136,0)
 .. I IB1,$P($G(^IBM(361,+IBY,0)),U,11) S Z="",Z0=0 F  S Z=$O(IBT(Z)) Q:Z=""!(Z0=1)  D
"RTN","IBCEST",137,0)
 ... S Z0=$$PRINTUPD^IBCEU0($$UP^XLFSTR($G(IBT(Z))),$P($G(^IBM(361,+IBY,0)),U,11))
"RTN","IBCEST",138,0)
 . ;
"RTN","IBCEST",139,0)
 . D MSGLNSZ(.IBT) ; Convert Message Lines in IBT to be no longer than 70 chars
"RTN","IBCEST",140,0)
 . D WP^DIE(361,+IBY_",",1,"A","IBT")    ; file message text
"RTN","IBCEST",141,0)
 . ;
"RTN","IBCEST",142,0)
 . ; Delete message after it successfully updates the database.
"RTN","IBCEST",143,0)
 . D DELMSG^IBCESRV2(IBTDA)
"RTN","IBCEST",144,0)
 . Q
"RTN","IBCEST",145,0)
 ;
"RTN","IBCEST",146,0)
UPDQ L -^IBA(364.2,IBTDA,0)
"RTN","IBCEST",147,0)
 Q
"RTN","IBCEST",148,0)
 ;
"RTN","IBCEST",149,0)
BLDMSG(IB1,IBTDA,IBT,IBAUTO) ; Builds message text
"RTN","IBCEST",150,0)
 ; IB1 = flag for batch message
"RTN","IBCEST",151,0)
 ; IBTDA = ien of entry in file 364.2
"RTN","IBCEST",152,0)
 ; IBT = array returned with message text
"RTN","IBCEST",153,0)
 ; IBAUTO = if passed by reference, returns 1 if text indicates review
"RTN","IBCEST",154,0)
 ;          not needed
"RTN","IBCEST",155,0)
 N IBDATA,IBCK,IBZ,IBZ0,IBZ1,Z
"RTN","IBCEST",156,0)
 S (IBZ,IBZ0,IBDATA,IBAUTO,IBCK)=0
"RTN","IBCEST",157,0)
 I 'IB1 S IBT(1)="Status message received for batch "_$P($G(^IBA(364.1,IBBTCH,0)),U)_" dated "_$$FMTE^XLFDT($P($G(^IBA(364.2,IBTDA,0)),U,10),2),IBZ0=1
"RTN","IBCEST",158,0)
 ; Don't move the raw data over, just move the text of the message
"RTN","IBCEST",159,0)
 F  S IBZ=$O(^IBA(364.2,IBTDA,2,IBZ)) Q:'IBZ  S IBZ1=$G(^(IBZ,0)) S IBDATA=($E(IBZ1,1,2)="##") Q:IBDATA  S IBZ0=IBZ0+1,IBT(IBZ0)=IBZ1 I 'IBCK S Z=$$CKREVU^IBCEM4(IBZ1,,,.IBCK),IBAUTO=$S(IBCK:0,Z:1,1:IBAUTO)
"RTN","IBCEST",160,0)
 Q
"RTN","IBCEST",161,0)
 ;
"RTN","IBCEST",162,0)
UPDINS(IBPID,IBINS,IBIFN) ; Update the insurance id or the bill printed at
"RTN","IBCEST",163,0)
 ;    the EDI contractor's print shop and mailed to the ins co.
"RTN","IBCEST",164,0)
 ; IBPID = the id returned from the EDI contractor for the ins co
"RTN","IBCEST",165,0)
 ;      ("TYPE") = P if professional id or I if institutional id
"RTN","IBCEST",166,0)
 ; IBINS = the ien of the insurance co it was sent to (file 36)
"RTN","IBCEST",167,0)
 ; IBIFN = the ien of the claim (file 399)
"RTN","IBCEST",168,0)
 ;
"RTN","IBCEST",169,0)
 N IBID,IBIDFLD,IBPRT,IBLOOK,DA,DR,DIE,X,Y,Z
"RTN","IBCEST",170,0)
 ;
"RTN","IBCEST",171,0)
 Q:'$G(IBINS)!($G(IBPID)="")
"RTN","IBCEST",172,0)
 ;
"RTN","IBCEST",173,0)
 ; Strip spaces off the end of data
"RTN","IBCEST",174,0)
 S IBLOOK=""
"RTN","IBCEST",175,0)
 I $L(IBPID) F Z=$L(IBPID):-1:1 I $E(IBPID,Z)'=" " S IBLOOK=$E(IBPID,1,Z) Q
"RTN","IBCEST",176,0)
 ;
"RTN","IBCEST",177,0)
 S IBPRT=($E(IBLOOK,2,5)="PRNT")
"RTN","IBCEST",178,0)
 I IBPRT D  ; Set printed via EDI field on bill
"RTN","IBCEST",179,0)
 . S DA=IBIFN,DIE="^DGCR(399,",DR="26////1" D ^DIE
"RTN","IBCEST",180,0)
 ;
"RTN","IBCEST",181,0)
 S IBLOOK=$E($S('IBPRT:$P(IBLOOK,"PAYID=",2),1:""),1,5)
"RTN","IBCEST",182,0)
 Q:IBLOOK=""!($E(IBLOOK,2,5)="PRNT")
"RTN","IBCEST",183,0)
 S IBIDFLD="3.0"_$S($G(IBPID("TYPE"))="I":4,1:2)
"RTN","IBCEST",184,0)
 S IBID=$P($G(^DIC(36,+IBINS,3)),U,IBIDFLD*100#100)
"RTN","IBCEST",185,0)
 Q:IBID=IBLOOK
"RTN","IBCEST",186,0)
 I IBID="" D  G UPDINSQ ; Update insurance co electronic id # if blank
"RTN","IBCEST",187,0)
 . S DIE="^DIC(36,",DR=IBIDFLD_"////"_IBLOOK,DA=IBINS D ^DIE
"RTN","IBCEST",188,0)
 I IBID'="",IBLOOK'="" D  ; Bulletin that the id on file and id returned
"RTN","IBCEST",189,0)
 . ; are different
"RTN","IBCEST",190,0)
 . N XMTO,XMDUZ,XMBODY,IBXM,XMSUBJ,XMZ
"RTN","IBCEST",191,0)
 . S XMTO("I:G.IB EDI")=""
"RTN","IBCEST",192,0)
 . S XMDUZ="",XMBODY="IBXM",XMSUBJ="PAYER ID RETURNED IS DIFFERENT THAN PAYER ID ON FILE"
"RTN","IBCEST",193,0)
 . S IBXM(1)="BILL #     : "_$P($G(^DGCR(399,IBIFN,0)),U)
"RTN","IBCEST",194,0)
 . S IBXM(2)="PAYER      : "_$P($G(^DIC(36,+IBINS,0)),U)
"RTN","IBCEST",195,0)
 . S IBXM(3)="BILL TYPE  : "_$S($G(IBPID("TYPE"))="I":"INSTITUT",1:"PROFESS")_"IONAL"
"RTN","IBCEST",196,0)
 . S IBXM(4)="ID ON FILE : "_IBID
"RTN","IBCEST",197,0)
 . S IBXM(5)="ID RETURNED: "_IBLOOK
"RTN","IBCEST",198,0)
 . S IBXM(6)=" ",IBXM(7)="   Please determine which id number is correct and correct the id in the",IBXM(8)="insurance file for this payer, if needed"
"RTN","IBCEST",199,0)
 . D SENDMSG^XMXAPI(XMDUZ,XMSUBJ,XMBODY,.XMTO,,.XMZ)
"RTN","IBCEST",200,0)
 ;
"RTN","IBCEST",201,0)
UPDINSQ Q
"RTN","IBCEST",202,0)
 ;
"RTN","IBCEST",203,0)
MSGLNSZ(MSG) ; Change Input Message Lines to be no more than 70 characters long each
"RTN","IBCEST",204,0)
 ;
"RTN","IBCEST",205,0)
 ; Input/Output:   MSG  - array of Input Message Lines; this is also the Output Message
"RTN","IBCEST",206,0)
 ; which is an array of Converted Message Lines (with lines no more than 70 chars each)
"RTN","IBCEST",207,0)
 ;
"RTN","IBCEST",208,0)
 N LN,XARY,XARYLN,CNT,OUTMSG,TMPMSG,LDNGSP,LDNGSPN
"RTN","IBCEST",209,0)
 S LN="",CNT=0 F  S LN=$O(MSG(LN)) Q:LN=""  D  ;
"RTN","IBCEST",210,0)
 . ; Find any leading spaces in original message line, 
"RTN","IBCEST",211,0)
 . ; to be used if line got split below
"RTN","IBCEST",212,0)
 . S TMPMSG=$$TRIM^XLFSTR(MSG(LN),"L"," ")  ;Trim Leading Spaces
"RTN","IBCEST",213,0)
 . S LDNGSP=$P(MSG(LN),TMPMSG,1)  ;get leading spaces if any
"RTN","IBCEST",214,0)
 . S LDNGSPN=$L(LDNGSP) S:LDNGSPN>30 LDNGSP=$E(LDNGSP,1,30) ;make sure there are no more than 30 leading spaces 
"RTN","IBCEST",215,0)
 . ; Converts a single line to multiple lines with a maximum width of 70 each
"RTN","IBCEST",216,0)
 . ; If line is 70 chars or less, this call returns the exact line
"RTN","IBCEST",217,0)
 . K XARY D FSTRNG^IBJU1(TMPMSG,70-LDNGSPN,.XARY)
"RTN","IBCEST",218,0)
 . ; Scan lines and merge them into the final output array (OUTMSG)
"RTN","IBCEST",219,0)
 . ; On lines 2 and higher, add Leading Spaces found above, if any.
"RTN","IBCEST",220,0)
 . S XARYLN="" F  S XARYLN=$O(XARY(XARYLN)) Q:XARYLN=""  S CNT=CNT+1,OUTMSG(CNT)=LDNGSP_XARY(XARYLN)
"RTN","IBCEST",221,0)
 ;
"RTN","IBCEST",222,0)
 ; Move the final Message Lines (OUTMSG) into MSG array to be returned
"RTN","IBCEST",223,0)
 K MSG M MSG=OUTMSG
"RTN","IBCEST",224,0)
 Q
"RTN","IBCEST",225,0)
 ;
"RTN","IBCEST1")
0^2^B3887328^B1659665
"RTN","IBCEST1",1,0)
IBCEST1 ;ALB/ESG - IB 837 EDI Status Message Processing Cont ;18-JUL-2005
"RTN","IBCEST1",2,0)
 ;;2.0;INTEGRATED BILLING;**320,397**;21-MAR-94;Build 3
"RTN","IBCEST1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBCEST1",4,0)
 ;
"RTN","IBCEST1",5,0)
 Q
"RTN","IBCEST1",6,0)
 ;
"RTN","IBCEST1",7,0)
CHKSUM(IBARRAY) ; Incoming 277STAT status message checksum calculation
"RTN","IBCEST1",8,0)
 ; This function calculates the checksum of the raw 277stat data from
"RTN","IBCEST1",9,0)
 ; the data in array IBARRAY.  This is done to prevent duplicates.
"RTN","IBCEST1",10,0)
 ; Input parameter IBARRAY is the array reference where the data exists
"RTN","IBCEST1",11,0)
 ;    at @IBARRAY@(n,0) where n is a sequential #
"RTN","IBCEST1",12,0)
 ; For file 364.2, IBARRAY = "^IBA(364.2,IBTDA,2)" where IBTDA = the ien
"RTN","IBCEST1",13,0)
 ;    of the entry in file 364.2 being evaluated
"RTN","IBCEST1",14,0)
 ;
"RTN","IBCEST1",15,0)
 NEW Y,LN,DATA,IBREC,POS,STSFLG
"RTN","IBCEST1",16,0)
 S Y=0,STSFLG=0
"RTN","IBCEST1",17,0)
 S LN=0
"RTN","IBCEST1",18,0)
 F  S LN=$O(@IBARRAY@(LN)) Q:'LN  D
"RTN","IBCEST1",19,0)
 . S DATA=$$EXT($G(@IBARRAY@(LN,0))) Q:DATA=""
"RTN","IBCEST1",20,0)
 . S IBREC=$P(DATA,U,1)
"RTN","IBCEST1",21,0)
 . I IBREC="277STAT" S STSFLG=1 Q      ; set the STS flag
"RTN","IBCEST1",22,0)
 . I IBREC<1 Q             ; rec# too low
"RTN","IBCEST1",23,0)
 . I IBREC'<99 Q           ; rec# too high
"RTN","IBCEST1",24,0)
 . F POS=1:1:$L(DATA) S Y=Y+($A(DATA,POS)*POS)
"RTN","IBCEST1",25,0)
 . Q
"RTN","IBCEST1",26,0)
 ;
"RTN","IBCEST1",27,0)
 I 'STSFLG S Y=0   ; if this array is not a 277stat message
"RTN","IBCEST1",28,0)
 Q Y
"RTN","IBCEST1",29,0)
 ;
"RTN","IBCEST1",30,0)
EXT(DATA) ; Extracts from the text in DATA if the text contains 
"RTN","IBCEST1",31,0)
 ;  "##RAW DATA: "
"RTN","IBCEST1",32,0)
 Q $S(DATA["##RAW DATA: ":$P(DATA,"##RAW DATA: ",2,99),1:DATA)
"RTN","IBCEST1",33,0)
 ;
"RTN","IBCEST1",34,0)
SCODE(Z0) ; status code for message
"RTN","IBCEST1",35,0)
 N IBFD,IBI,IBRD S IBFD=0
"RTN","IBCEST1",36,0)
 F IBI=1:1 S IBRD=$P($T(CODE+IBI),";;",2,999) Q:IBRD=""!IBFD  D
"RTN","IBCEST1",37,0)
 . I IBRD[Z0 S IBFD=1
"RTN","IBCEST1",38,0)
 Q IBFD
"RTN","IBCEST1",39,0)
 ;
"RTN","IBCEST1",40,0)
CODE ; *397
"RTN","IBCEST1",41,0)
 ;;A3^AC^A7^A8^AA^2P^10^11
"RTN","IBCEST1",42,0)
 ;;19^20^21^30^40^221^960^1AE^1AF^1AG^1AI^1AJ^1AK^1AL^1AS^1BS^1BV^1BY
"RTN","IBCEST1",43,0)
 ;;2B^2D^2H^2M^2U^3A^3C^3E^3F^3G^3I^3K^3L^3N^3P^3S
"RTN","IBCEST1",44,0)
 ;;4B^4C^4D^4E^4H^4I^4J^4P^4S^4T^4U^4X^4Y^7A^7D^7I^7U^7V
"RTN","IBCEST1",45,0)
 ;;A0^A9^ACCEPT^ACCEPTED^AE^AP^APPROVE^C01^CI^CP^CTRL!99001^INQUIRY
"RTN","IBCEST1",46,0)
 ;;OA7^OAH^OAI^OAK^OAT^OAV^OAY^OAZ^OB9^OBX^OCU^PG^PN5
"RTN","IBCEST1",47,0)
 ;;TE^W!00000117^Z3^ZAI^ZAN
"RTN","IBCEST1",48,0)
 ;
"VER")
8.0^22.0
"BLD",7620,6)
^365
**END**
**END**

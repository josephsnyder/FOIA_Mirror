Released IB*2*383 SEQ #368
Extracted from mail message
**KIDS**:IB*2.0*383^

**INSTALL NAME**
IB*2.0*383
"BLD",7432,0)
IB*2.0*383^INTEGRATED BILLING^0^3080610^y
"BLD",7432,4,0)
^9.64PA^366.14^2
"BLD",7432,4,366.14,0)
366.14
"BLD",7432,4,366.14,2,0)
^9.641^366.141^1
"BLD",7432,4,366.14,2,366.141,0)
EVENT  (sub-file)
"BLD",7432,4,366.14,2,366.141,1,0)
^9.6411^.311^1
"BLD",7432,4,366.14,2,366.141,1,.311,0)
COPAY AMOUNT
"BLD",7432,4,366.14,222)
y^n^p^^^^n^^n
"BLD",7432,4,366.14,224)

"BLD",7432,4,366.15,0)
366.15
"BLD",7432,4,366.15,222)
y^y^f^^^^n
"BLD",7432,4,"APDD",366.14,366.141)

"BLD",7432,4,"APDD",366.14,366.141,.311)

"BLD",7432,4,"B",366.14,366.14)

"BLD",7432,4,"B",366.15,366.15)

"BLD",7432,6.3)
11
"BLD",7432,"INID")
^n
"BLD",7432,"INIT")
POST^IB20P383
"BLD",7432,"KRN",0)
^9.67PA^8989.52^19
"BLD",7432,"KRN",.4,0)
.4
"BLD",7432,"KRN",.401,0)
.401
"BLD",7432,"KRN",.402,0)
.402
"BLD",7432,"KRN",.403,0)
.403
"BLD",7432,"KRN",.5,0)
.5
"BLD",7432,"KRN",.84,0)
.84
"BLD",7432,"KRN",3.6,0)
3.6
"BLD",7432,"KRN",3.8,0)
3.8
"BLD",7432,"KRN",9.2,0)
9.2
"BLD",7432,"KRN",9.8,0)
9.8
"BLD",7432,"KRN",9.8,"NM",0)
^9.68A^12^12
"BLD",7432,"KRN",9.8,"NM",1,0)
IB20P383^^0^B59153997
"BLD",7432,"KRN",9.8,"NM",2,0)
IBNCPDP^^0^B1881095
"BLD",7432,"KRN",9.8,"NM",3,0)
IBNCPDP1^^0^B67408703
"BLD",7432,"KRN",9.8,"NM",4,0)
IBNCPDP2^^0^B53296275
"BLD",7432,"KRN",9.8,"NM",5,0)
IBNCPDP3^^0^B30635379
"BLD",7432,"KRN",9.8,"NM",6,0)
IBNCPDP6^^0^B11789689
"BLD",7432,"KRN",9.8,"NM",7,0)
IBNCPDPU^^0^B68802824
"BLD",7432,"KRN",9.8,"NM",8,0)
IBCRCC^^0^B28233162
"BLD",7432,"KRN",9.8,"NM",9,0)
IBRXUTL^^0^B74176189
"BLD",7432,"KRN",9.8,"NM",10,0)
IBNCPLOG^^0^B61812598
"BLD",7432,"KRN",9.8,"NM",11,0)
IBNCPEV^^0^B84966832
"BLD",7432,"KRN",9.8,"NM",12,0)
IBNCPDPI^^0^B8589835
"BLD",7432,"KRN",9.8,"NM","B","IB20P383",1)

"BLD",7432,"KRN",9.8,"NM","B","IBCRCC",8)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPDP",2)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPDP1",3)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPDP2",4)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPDP3",5)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPDP6",6)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPDPI",12)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPDPU",7)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPEV",11)

"BLD",7432,"KRN",9.8,"NM","B","IBNCPLOG",10)

"BLD",7432,"KRN",9.8,"NM","B","IBRXUTL",9)

"BLD",7432,"KRN",19,0)
19
"BLD",7432,"KRN",19.1,0)
19.1
"BLD",7432,"KRN",101,0)
101
"BLD",7432,"KRN",409.61,0)
409.61
"BLD",7432,"KRN",771,0)
771
"BLD",7432,"KRN",870,0)
870
"BLD",7432,"KRN",8989.51,0)
8989.51
"BLD",7432,"KRN",8989.52,0)
8989.52
"BLD",7432,"KRN",8994,0)
8994
"BLD",7432,"KRN","B",.4,.4)

"BLD",7432,"KRN","B",.401,.401)

"BLD",7432,"KRN","B",.402,.402)

"BLD",7432,"KRN","B",.403,.403)

"BLD",7432,"KRN","B",.5,.5)

"BLD",7432,"KRN","B",.84,.84)

"BLD",7432,"KRN","B",3.6,3.6)

"BLD",7432,"KRN","B",3.8,3.8)

"BLD",7432,"KRN","B",9.2,9.2)

"BLD",7432,"KRN","B",9.8,9.8)

"BLD",7432,"KRN","B",19,19)

"BLD",7432,"KRN","B",19.1,19.1)

"BLD",7432,"KRN","B",101,101)

"BLD",7432,"KRN","B",409.61,409.61)

"BLD",7432,"KRN","B",771,771)

"BLD",7432,"KRN","B",870,870)

"BLD",7432,"KRN","B",8989.51,8989.51)

"BLD",7432,"KRN","B",8989.52,8989.52)

"BLD",7432,"KRN","B",8994,8994)

"BLD",7432,"PRE")
IB20P383
"BLD",7432,"QUES",0)
^9.62^^
"BLD",7432,"REQB",0)
^9.611^3^3
"BLD",7432,"REQB",1,0)
BPS*1.0*6^2
"BLD",7432,"REQB",2,0)
IB*2.0*363^2
"BLD",7432,"REQB",3,0)
IB*2.0*370^2
"BLD",7432,"REQB","B","BPS*1.0*6",1)

"BLD",7432,"REQB","B","IB*2.0*363",2)

"BLD",7432,"REQB","B","IB*2.0*370",3)

"FIA",366.14)
IB NCPDP EVENT LOG
"FIA",366.14,0)
^IBCNR(366.14,
"FIA",366.14,0,0)
366.14D
"FIA",366.14,0,1)
y^n^p^^^^n^^n
"FIA",366.14,0,10)

"FIA",366.14,0,11)

"FIA",366.14,0,"RLRO")

"FIA",366.14,0,"VR")
2.0^IB
"FIA",366.14,366.14)
1
"FIA",366.14,366.141)
1
"FIA",366.14,366.141,.311)

"FIA",366.15)
IB NCPDP PRESCRIPTION
"FIA",366.15,0)
^IBCNR(366.15,
"FIA",366.15,0,0)
366.15
"FIA",366.15,0,1)
y^y^f^^^^n
"FIA",366.15,0,10)

"FIA",366.15,0,11)

"FIA",366.15,0,"RLRO")

"FIA",366.15,0,"VR")
2.0^IB
"FIA",366.15,366.15)
0
"INIT")
POST^IB20P383
"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
383^3080610
"PRE")
IB20P383
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","IB20P383")
0^1^B59153997^n/a
"RTN","IB20P383",1,0)
IB20P383 ;OAK/ELZ - IB*2.0*383 CHECK/POST INSTALL ;11/15/07  09:47
"RTN","IB20P383",2,0)
 ;;2.0;INTEGRATED BILLING;**383**;21-MAR-94;Build 11
"RTN","IB20P383",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IB20P383",4,0)
 ;
"RTN","IB20P383",5,0)
 ;
"RTN","IB20P383",6,0)
CHECK ; - pre-install check
"RTN","IB20P383",7,0)
 ;
"RTN","IB20P383",8,0)
 N IBI,IBLN,IBX,IBRT
"RTN","IB20P383",9,0)
 ;
"RTN","IB20P383",10,0)
 ; - check for rate types that must be defined
"RTN","IB20P383",11,0)
 ; get active list
"RTN","IB20P383",12,0)
 F IBI=1:1 S IBLN=$P($T(RTF+IBI),";;",2) Q:+IBLN!(IBLN="")  S IBX=$O(^DGCR(399.3,"B",IBLN,0)) I IBX,'$P($G(^DGCR(399.3,IBX,0)),"^",3) S IBRT(IBLN,+IBX)=""
"RTN","IB20P383",13,0)
 ;
"RTN","IB20P383",14,0)
 ; do i have what i need?
"RTN","IB20P383",15,0)
 F IBI=1:1 S IBLN=$P($T(RTF+IBI),";;",2) Q:+IBLN!(IBLN="")!($G(XPDABORT))  D
"RTN","IB20P383",16,0)
 . S IBX=$O(IBRT(IBLN,0))
"RTN","IB20P383",17,0)
 . I 'IBX W !,"    *** Rate Type ",IBLN," does not exist or is not active." S XPDABORT=1 Q
"RTN","IB20P383",18,0)
 . I $O(IBRT(IBLN,IBX)) W !,"    *** Rate Type ",IBLN," has an active duplicate." S XPDABORT=1
"RTN","IB20P383",19,0)
 I $G(XPDABORT) W !!,"The rate type(s) must exist and be active before you can install."
"RTN","IB20P383",20,0)
 ;
"RTN","IB20P383",21,0)
 Q
"RTN","IB20P383",22,0)
 ;
"RTN","IB20P383",23,0)
POST ; - post-install
"RTN","IB20P383",24,0)
 N IBA,IBCS,IBNCS,IBDT
"RTN","IB20P383",25,0)
 ;
"RTN","IB20P383",26,0)
 S IBDT=3060101
"RTN","IB20P383",27,0)
 ;
"RTN","IB20P383",28,0)
 S IBA(1)="",IBA(2)="    e-Pharmacy Tricare Support Post-Install .....",IBA(3)="" D MES^XPDUTL(.IBA) K IBA
"RTN","IB20P383",29,0)
 ;
"RTN","IB20P383",30,0)
 D CLEANCS(.IBCS) ; clean up local charge sets
"RTN","IB20P383",31,0)
 D ADDCS(.IBCS,.IBNCS) ; add charge sets
"RTN","IB20P383",32,0)
 D OLDRS($$FMADD^XLFDT(IBDT,-1),.IBNCS) ; inactivate old rate schedules
"RTN","IB20P383",33,0)
 D ADDRS(IBDT) ; add rate schedules
"RTN","IB20P383",34,0)
 ;
"RTN","IB20P383",35,0)
 S IBA(1)="",IBA(2)="    e-Pharmacy Tricare Support Post-Install Complete",IBA(3)="" D MES^XPDUTL(.IBA)
"RTN","IB20P383",36,0)
 ;
"RTN","IB20P383",37,0)
 Q
"RTN","IB20P383",38,0)
 ;
"RTN","IB20P383",39,0)
CLEANCS(IBCS) ; cleans up locally defined charge sets (if any) for VA Cost
"RTN","IB20P383",40,0)
 ; saves data in IBCS(billable event,old ien)=old revenue code
"RTN","IB20P383",41,0)
 ;
"RTN","IB20P383",42,0)
 N IBI,IBBR,IBZ,DIK,DA
"RTN","IB20P383",43,0)
 ;
"RTN","IB20P383",44,0)
 D MSG("   Cleaning up old local Charge Sets")
"RTN","IB20P383",45,0)
 S IBBR=$O(^IBE(363.3,"B","VA COST",0)) I 'IBBR D MSG("   *** Missing Billing Rate VA COST !!!") Q
"RTN","IB20P383",46,0)
 I '$O(^IBE(363.1,"C",IBBR,999)) D MSG("   - No Charge Sets to clean up...ok") Q
"RTN","IB20P383",47,0)
 S IBI=999 F  S IBI=$O(^IBE(363.1,"C",IBBR,IBI)) Q:'IBI  D
"RTN","IB20P383",48,0)
 . S IBZ=$G(^IBE(363.1,IBI,0))
"RTN","IB20P383",49,0)
 . D MSG("   - Deleting Charge Set "_$P(IBZ,"^")_"...ok")
"RTN","IB20P383",50,0)
 . I $P(IBZ,"^",3),$P(IBZ,"^",5) S IBCS($P(IBZ,"^",3),IBI)=$P(IBZ,"^",5)
"RTN","IB20P383",51,0)
 . S DIK="^IBE(363.1,",DA=IBI D ^DIK
"RTN","IB20P383",52,0)
 ;
"RTN","IB20P383",53,0)
 D MSG("   Done cleaning up old local Charge Sets")
"RTN","IB20P383",54,0)
 ;
"RTN","IB20P383",55,0)
 Q
"RTN","IB20P383",56,0)
 ;
"RTN","IB20P383",57,0)
 ;
"RTN","IB20P383",58,0)
ADDCS(IBCS,IBNCS) ; Add Charge Set (363.1)
"RTN","IB20P383",59,0)
 ; puts data in IBNCS(ien)="" for new charge sets added
"RTN","IB20P383",60,0)
 ;
"RTN","IB20P383",61,0)
 N IBCNT,IBI,IBLN,IBFN,IBBR,IBBE,IBRVCD,DD,DO,DLAYGO,DIC,DIE,DA,DR,X,Y,IBORVCD,IBY,IBZ,DINUM,IBJ
"RTN","IB20P383",62,0)
 S IBCNT=0
"RTN","IB20P383",63,0)
 ;
"RTN","IB20P383",64,0)
 D MSG("   Adding new National Charge Sets")
"RTN","IB20P383",65,0)
 F IBI=1:1 S IBLN=$P($T(CSF+IBI),";;",2) Q:+IBLN!(IBLN="")  I $E(IBLN)?1A D
"RTN","IB20P383",66,0)
 . ;
"RTN","IB20P383",67,0)
 . I $O(^IBE(363.1,"B",$P(IBLN,U,1),0)) Q
"RTN","IB20P383",68,0)
 . S IBBR=$P(IBLN,U,2),IBBR=$O(^IBE(363.3,"B",IBBR,0)) I 'IBBR Q
"RTN","IB20P383",69,0)
 . S IBBE=$$MCCRUTL($P(IBLN,U,3),14) Q:'IBBE
"RTN","IB20P383",70,0)
 . S IBORVCD=+$G(IBCS(IBBE,+$O(IBCS(IBBE,999))))
"RTN","IB20P383",71,0)
 . S IBRVCD=+$$RVCD($P(IBLN,U,5))
"RTN","IB20P383",72,0)
 . F IBJ=1:1 I $G(^IBE(363.1,IBJ,0))="" S DINUM=IBJ Q
"RTN","IB20P383",73,0)
 . ;
"RTN","IB20P383",74,0)
 . K DD,DO S DLAYGO=363.1,DIC="^IBE(363.1,",DIC(0)="L",X=$P(IBLN,U,1) D FILE^DICN K DIC,DINUM I Y<1 K X,Y Q
"RTN","IB20P383",75,0)
 . D MSG("   Charge Set "_$P(IBLN,U,1)_" added...ok")
"RTN","IB20P383",76,0)
 . S IBFN=+Y,IBCNT=IBCNT+1,IBNCS(IBFN)=""
"RTN","IB20P383",77,0)
 . ;
"RTN","IB20P383",78,0)
 . S DR=".02////"_IBBR_";.03////"_IBBE
"RTN","IB20P383",79,0)
 . I IBORVCD D MSG("   - Using old Revenue Code...ok")
"RTN","IB20P383",80,0)
 . I IBRVCD!(IBORVCD) S DR=DR_";.05////"_$S(IBORVCD:IBORVCD,1:IBRVCD)
"RTN","IB20P383",81,0)
 . D MSG("   - Assigning Bed Section...")
"RTN","IB20P383",82,0)
 . S DR=DR_";.06////"_$$MCCRUTL($P(IBLN,U,6),5)
"RTN","IB20P383",83,0)
 . S DIE="^IBE(363.1,",DA=+IBFN D ^DIE K DIE,DA,DR,X,Y
"RTN","IB20P383",84,0)
 . Q:'$O(IBCS(IBBE,999))
"RTN","IB20P383",85,0)
 . D MSG("   - Resetting pointers from old Charge Sets...ok")
"RTN","IB20P383",86,0)
 . S IBCS=0 F  S IBCS=$O(IBCS(IBBE,IBCS)) Q:'IBCS  D
"RTN","IB20P383",87,0)
 .. ; possible pointer stored in 350.9 for old RNA sites
"RTN","IB20P383",88,0)
 .. I $P($G(^IBE(350.9,1,9)),"^",12)=IBCS D  K DIE,DA,DR,X,Y
"RTN","IB20P383",89,0)
 ... S DIE="^IBE(350.9,",DA=1,DR="9.12////^S X=+IBFN" D ^DIE
"RTN","IB20P383",90,0)
 .. ; fix Rate Schedules with pointers
"RTN","IB20P383",91,0)
 .. S IBY=0 F  S IBY=$O(^IBE(363,"C",IBCS,IBY)) Q:'IBY  S IBZ=0 F  S IBZ=$O(^IBE(363,"C",IBCS,IBY,IBZ)) Q:'IBZ  D  K DIE,DA,DR,X,Y
"RTN","IB20P383",92,0)
 ... S DIE="^IBE(363,"_IBY_",11,",DA(1)=IBY,DA=IBZ,DR=".01////^S X=+IBFN" D ^DIE
"RTN","IB20P383",93,0)
 .. ; fix Billing Special Groups with pointers
"RTN","IB20P383",94,0)
 .. S IBZ=0 F  S IBZ=$O(^IBE(363.32,IBZ)) Q:'IBZ  S IBY=0 F  S IBY=$O(^IBE(363.32,IBZ,11,IBY)) Q:'IBY  I $P($G(^IBE(363.32,IBZ,11,IBY,0)),"^",2)=IBCS D  K DIE,DA,DR,X,Y
"RTN","IB20P383",95,0)
 ... S DIE="^IBE(363.32,"_IBZ_",11,",DA(1)=IBZ,DA=IBY,DR=".02////^S X=+IBFN" D ^DIE
"RTN","IB20P383",96,0)
 ;
"RTN","IB20P383",97,0)
CSQ ;
"RTN","IB20P383",98,0)
 D MSG("      >> "_IBCNT_" Charge Sets added (363.1)...")
"RTN","IB20P383",99,0)
 ;
"RTN","IB20P383",100,0)
 Q
"RTN","IB20P383",101,0)
 ;
"RTN","IB20P383",102,0)
OLDRS(IBDT,IBNCS) ; inactivate old rate schedules
"RTN","IB20P383",103,0)
 ;
"RTN","IB20P383",104,0)
 D MSG("   Inactivating old Rate Schedules")
"RTN","IB20P383",105,0)
 ;
"RTN","IB20P383",106,0)
 N IBY,IBX,IBZ,IBC,IBD,IBCNT,DA,DIE,DIK,DR,X,Y S IBCNT=0
"RTN","IB20P383",107,0)
 ;
"RTN","IB20P383",108,0)
 S IBNCS=0 F  S IBNCS=$O(IBNCS(IBNCS)) Q:'IBNCS  S IBY=0 F  S IBY=$O(^IBE(363,"C",IBNCS,IBY)) Q:'IBY  S IBZ=999 F  S IBZ=$O(^IBE(363,"C",IBNCS,IBY,IBZ)) Q:'IBZ  D
"RTN","IB20P383",109,0)
 . S IBD=$G(^IBE(363,IBY,0))
"RTN","IB20P383",110,0)
 . Q:$P(IBD,"^",6)
"RTN","IB20P383",111,0)
 . Q:$G(^DGCR(399.3,+$P(IBD,"^",2),0))'["TRICARE"
"RTN","IB20P383",112,0)
 . S (IBC,IBX)=0 F  S IBX=$O(^IBE(363,IBZ,11,IBX)) Q:'IBX  S IBC=IBC+1
"RTN","IB20P383",113,0)
 . I IBC>1 D  Q
"RTN","IB20P383",114,0)
 .. D MSG("   - Rate Schedule "_$P(IBD,"^")_" has multiple Charge Sets")
"RTN","IB20P383",115,0)
 .. D MSG("     removing "_$P($G(^IBE(363.1,IBNCS,0)),"^")_" Charge Set but leaving active.")
"RTN","IB20P383",116,0)
 .. S DIK="^IBE(363,"_IBY_",11,",DA(1)=IBY,DA=IBZ D ^DIK K DIK,DA
"RTN","IB20P383",117,0)
 . D MSG("   - Inactivating Rate Schedule "_$P(IBD,"^"))
"RTN","IB20P383",118,0)
 . S DIE="^IBE(363,",DA=IBY,DR=".06////^S X=IBDT" D ^DIE K DIE,DA,X,Y
"RTN","IB20P383",119,0)
 ;
"RTN","IB20P383",120,0)
 D MSG("   Done inactivating old Rate Schedules...")
"RTN","IB20P383",121,0)
 ;
"RTN","IB20P383",122,0)
 Q
"RTN","IB20P383",123,0)
 ;
"RTN","IB20P383",124,0)
ADDRS(IBDT) ; add Rate Schedule (363)  (needs billable service and charge sets)
"RTN","IB20P383",125,0)
 N IBX,IBCNT,IBI,IBLN,IBFN,IBRT,IBBS,IBJ,IBLNCS,IBCS,IBCSFN,DD,DO,DLAYGO,DIC,DIE,DA,DR,X,Y,IBAJ,DINUM S IBCNT=0
"RTN","IB20P383",126,0)
 ;
"RTN","IB20P383",127,0)
 D MSG("   Adding new National Rate Schedules")
"RTN","IB20P383",128,0)
 ;
"RTN","IB20P383",129,0)
 F IBI=1:1 S IBLN=$P($T(RSF+IBI),";",3),IBAJ=$P($T(RSF+IBI),";",4) Q:+IBLN!(IBLN="")  I $E(IBLN)?1A D
"RTN","IB20P383",130,0)
 . ;
"RTN","IB20P383",131,0)
 . I $O(^IBE(363,"B",$P(IBLN,U,1),0)) Q
"RTN","IB20P383",132,0)
 . S IBBS=$P(IBLN,U,4) I IBBS'="" S IBBS=$$MCCRUTL(IBBS,13) I 'IBBS D  Q
"RTN","IB20P383",133,0)
 .. D MSG("*** Billable Service "_$P(IBLN,U,4)_" NOT FOUND, Rate Schedule "_$P(IBLN,"^")_" not created!!!")
"RTN","IB20P383",134,0)
 . S IBRT=$P(IBLN,U,2),IBRT=$O(^DGCR(399.3,"B",IBRT,0)) D  Q:'IBRT
"RTN","IB20P383",135,0)
 .. I 'IBRT D MSG("**** Rate Type "_$P(IBLN,U,2)_" not defined, Rate Schedule "_$P(IBLN,U,1)_" NOT created!!!")
"RTN","IB20P383",136,0)
 .. I $P($G(^DGCR(399.3,+IBRT,0)),U,3) S (IBRT,IBX)=0 F  S IBX=$O(^DGCR(399.3,"B",$P(IBLN,U,2),IBX)) Q:'IBX  I '$P($G(^DGCR(399.3,+IBX,0)),U,3) S IBRT=+IBX Q
"RTN","IB20P383",137,0)
 .. I $P($G(^DGCR(399.3,+IBRT,0)),U,3) S IBRT=0 D MSG("**** Rate Type "_$P(IBLN,U,2)_" not Active, RS "_$P(IBLN,U,1)_" not created!!!")
"RTN","IB20P383",138,0)
 . F IBJ=1:1 I $G(^IBE(363,IBJ,0))="" S DINUM=IBJ Q
"RTN","IB20P383",139,0)
 . ;
"RTN","IB20P383",140,0)
 . K DD,DO S DLAYGO=363,DIC="^IBE(363,",DIC(0)="L",X=$P(IBLN,U,1) D FILE^DICN K DIC,DINUM,DLAYGO I Y<1 K X,Y Q
"RTN","IB20P383",141,0)
 . S IBFN=+Y,IBCNT=IBCNT+1
"RTN","IB20P383",142,0)
 . ;
"RTN","IB20P383",143,0)
 . S DR=".02////"_IBRT_";.03////"_$P(IBLN,U,3)_";.05////"_IBDT_";.04////"_IBBS
"RTN","IB20P383",144,0)
 . I $L(IBAJ) D
"RTN","IB20P383",145,0)
 .. F IBJ=1,2 S:$L($P(IBAJ,U,IBJ)) DR=DR_";1.0"_IBJ_"////"_$P(IBAJ,U,IBJ)
"RTN","IB20P383",146,0)
 .. I $L($P(IBAJ,U,3)) S DR=DR_";10////^S X=$P(IBAJ,U,3)"
"RTN","IB20P383",147,0)
 . ;
"RTN","IB20P383",148,0)
 . S DIE="^IBE(363,",DA=IBFN D ^DIE K DIE,DA,DR,X,Y
"RTN","IB20P383",149,0)
 . ;
"RTN","IB20P383",150,0)
 . ; charge sets (multiple)
"RTN","IB20P383",151,0)
 . S IBLNCS=$P(IBLN,":",2,999) F IBJ=1:1 S IBCS=$P(IBLNCS,":",IBJ) Q:IBCS=""  D
"RTN","IB20P383",152,0)
 .. S IBCSFN=$O(^IBE(363.1,"B",IBCS,0)) Q:'IBCSFN
"RTN","IB20P383",153,0)
 .. ;
"RTN","IB20P383",154,0)
 .. S DLAYGO=363,DA(1)=+IBFN,DIC="^IBE(363,"_DA(1)_",11,",DIC(0)="L",X=IBCS,DIC("DR")=".02////"_1,DIC("P")="363.0011P" D ^DIC K DIC,DIE
"RTN","IB20P383",155,0)
 ;
"RTN","IB20P383",156,0)
 ;
"RTN","IB20P383",157,0)
RSQ D MSG("      >> "_IBCNT_" Rate Schedules added (363)...")
"RTN","IB20P383",158,0)
 Q
"RTN","IB20P383",159,0)
 ;
"RTN","IB20P383",160,0)
 ;
"RTN","IB20P383",161,0)
MCCRUTL(X,P) ; returns IFN of item in 399.1 if Name is found and piece P is true
"RTN","IB20P383",162,0)
 N IBX,IBY S IBY=""
"RTN","IB20P383",163,0)
 I $G(X)'="" S IBX=0 F  S IBX=$O(^DGCR(399.1,"B",X,IBX)) Q:'IBX  I $P($G(^DGCR(399.1,IBX,0)),U,+$G(P)) S IBY=IBX
"RTN","IB20P383",164,0)
 Q IBY
"RTN","IB20P383",165,0)
 ;
"RTN","IB20P383",166,0)
RVCD(RVCD) ; returns IFN if revenue code is valid and active
"RTN","IB20P383",167,0)
 N IBX,IBY S IBY=""
"RTN","IB20P383",168,0)
 I +$G(RVCD) S IBX=$G(^DGCR(399.2,+RVCD,0)) I +$P(IBX,U,3) S IBY=RVCD
"RTN","IB20P383",169,0)
 Q IBY
"RTN","IB20P383",170,0)
 ;
"RTN","IB20P383",171,0)
MSG(X) ;
"RTN","IB20P383",172,0)
 D MES^XPDUTL(X)
"RTN","IB20P383",173,0)
 Q
"RTN","IB20P383",174,0)
 ;
"RTN","IB20P383",175,0)
CSF ; Charge Set (363.1)
"RTN","IB20P383",176,0)
 ;;RX COST^VA COST^PRESCRIPTION FILL^^250^PRESCRIPTION
"RTN","IB20P383",177,0)
 ;;PI COST^VA COST^PROSTHETICS ITEM^^274^OUTPATIENT VISIT
"RTN","IB20P383",178,0)
 ;;1
"RTN","IB20P383",179,0)
 ;
"RTN","IB20P383",180,0)
RSF ; Rate Schedules (363)
"RTN","IB20P383",181,0)
 ;;TR-RX^TRICARE^3^PRESCRIPTION^^^:RX COST;8^^S X=X+8
"RTN","IB20P383",182,0)
 ;;TRRI-RX^TRICARE REIMB. INS.^3^PRESCRIPTION^^^:RX COST;8^^S X=X+8
"RTN","IB20P383",183,0)
 ;;1
"RTN","IB20P383",184,0)
 ;
"RTN","IB20P383",185,0)
RTF ; Rate Types (399.3) that must exist
"RTN","IB20P383",186,0)
 ;;TRICARE
"RTN","IB20P383",187,0)
 ;;TRICARE REIMB. INS.
"RTN","IB20P383",188,0)
 ;;1
"RTN","IB20P383",189,0)
 ;
"RTN","IBCRCC")
0^8^B28233162^B26741603
"RTN","IBCRCC",1,0)
IBCRCC ;ALB/ARH - RATES: CALCULATION OF ITEM CHARGE ;22-MAY-1996
"RTN","IBCRCC",2,0)
 ;;2.0;INTEGRATED BILLING;**52,80,106,138,245,223,309,347,370,383**;21-MAR-94;Build 11
"RTN","IBCRCC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBCRCC",4,0)
 ;
"RTN","IBCRCC",5,0)
 ; ITMCHG and RATECHG are basic item/set/rate charge functions, IBCRCI contains more standard callable functions
"RTN","IBCRCC",6,0)
 ;
"RTN","IBCRCC",7,0)
ITMCHG(CS,ITEM,EVDT,MOD,ARR) ; get the base unit charges for a specific item, given a charge set, item and date
"RTN","IBCRCC",8,0)
 ; this is the primary function to get an item charge and works for all Charge Methods, given an Item
"RTN","IBCRCC",9,0)
 ; returns ARR = count of items in array ^ total charge for item ^ total base charge
"RTN","IBCRCC",10,0)
 ;         ARR(x) = charge item IFN (if any) ^ rev code (if any) ^ $ charge ^ $ base charge
"RTN","IBCRCC",11,0)
 ; checks Item effective and inactive dates, modifier match, and only sets array if the charge is non-zero
"RTN","IBCRCC",12,0)
 ; each item will be passed back separately in the array, no combination of charges
"RTN","IBCRCC",13,0)
 ;
"RTN","IBCRCC",14,0)
 N IBCSBR,IBEVDT,IBEFDT,IBXREF,IBITEM,IBDA,IBLN,IBCHRG,IBITMFND K ARR S ARR=0
"RTN","IBCRCC",15,0)
 S CS=+$G(CS),IBEVDT=$S(+$G(EVDT):+EVDT,1:DT),IBITEM=+$G(ITEM),MOD=$G(MOD) I 'CS!'IBITEM Q
"RTN","IBCRCC",16,0)
 S IBCSBR=$$CSBR^IBCRU3(CS)
"RTN","IBCRCC",17,0)
 ;
"RTN","IBCRCC",18,0)
 ; va cost
"RTN","IBCRCC",19,0)
 I $P(IBCSBR,U,5)=2 D  Q  ; va cost
"RTN","IBCRCC",20,0)
 . I $P(IBCSBR,U,1)["PROSTHETICS" S IBCHRG=$$PICOST(IBITEM)  I +IBCHRG D SETARR(0,0,+IBCHRG,.ARR) Q
"RTN","IBCRCC",21,0)
 . I $P(IBCSBR,U,1)["PRESCRIPTION" S IBCHRG=$$RXCOST(IBITEM) I +IBCHRG D SETARR(0,0,+IBCHRG,.ARR) Q
"RTN","IBCRCC",22,0)
 ;
"RTN","IBCRCC",23,0)
 ; all others - have Charge Item entries
"RTN","IBCRCC",24,0)
 ;
"RTN","IBCRCC",25,0)
 ; find most recent Charge Item for the item, search until modifiers match (only BI=CPT should have mods defined)
"RTN","IBCRCC",26,0)
 S IBXREF="AIVDTS"_CS,IBITMFND=0
"RTN","IBCRCC",27,0)
 S IBEFDT=-(IBEVDT+.01) F  S IBEFDT=$O(^IBA(363.2,IBXREF,IBITEM,IBEFDT)) Q:'IBEFDT  D  Q:IBITMFND
"RTN","IBCRCC",28,0)
 . S IBDA=0 F  S IBDA=$O(^IBA(363.2,IBXREF,IBITEM,IBEFDT,IBDA)) Q:'IBDA  D
"RTN","IBCRCC",29,0)
 .. S IBLN=$G(^IBA(363.2,IBDA,0))
"RTN","IBCRCC",30,0)
 .. I +$P(IBLN,U,7)'=+MOD Q  ; charge item modifier does not match modifier passed in
"RTN","IBCRCC",31,0)
 .. S IBITMFND=1 ; item found
"RTN","IBCRCC",32,0)
 .. I +$P(IBLN,U,4),+$P(IBLN,U,4)<IBEVDT Q  ; charge is inactive on event date
"RTN","IBCRCC",33,0)
 .. I +$P(IBLN,U,5) D SETARR(IBDA,+$P(IBLN,U,6),+$P(IBLN,U,5),.ARR,$P(IBLN,U,8))
"RTN","IBCRCC",34,0)
 Q
"RTN","IBCRCC",35,0)
 ;
"RTN","IBCRCC",36,0)
SETARR(CI,RVCD,CHRG,ARR,CHRGB) ; set charges into an array, does not allow zero charge, a new entry is created each time,
"RTN","IBCRCC",37,0)
 ; no attempt to combine like items, the new item charge is added to any that may already be in the array 
"RTN","IBCRCC",38,0)
 ; returns ARR = count of items in array ^ total charge for item
"RTN","IBCRCC",39,0)
 ;         ARR(x) = charge item IFN (if any) ^ item rev code (if any) ^ $ charge
"RTN","IBCRCC",40,0)
 ;
"RTN","IBCRCC",41,0)
 N CNT,TCHRG,TCHRGB
"RTN","IBCRCC",42,0)
 S CNT=+$G(ARR)+1,TCHRG=$P($G(ARR),U,2)+$G(CHRG) I +$G(CHRGB) S TCHRGB=+$P($G(ARR),U,3)+CHRGB
"RTN","IBCRCC",43,0)
 I +$G(CHRG) S ARR=CNT_U_+TCHRG_U_$G(TCHRGB),ARR(CNT)=$G(CI)_U_+$G(RVCD)_U_+CHRG_U_$G(TCHRGB)
"RTN","IBCRCC",44,0)
 Q
"RTN","IBCRCC",45,0)
 ;
"RTN","IBCRCC",46,0)
PICOST(PI) ; returns (PI=ptr 362.5): total VA cost of an item (660,14) ^ quantity (660,5) from prosthetics ^ bill IFN
"RTN","IBCRCC",47,0)
 ;
"RTN","IBCRCC",48,0)
 N IBPIP,IBLN,IBX,IBIFN S (IBPIP,IBX)=0
"RTN","IBCRCC",49,0)
 I +$G(PI) S IBLN=$G(^IBA(362.5,+PI,0)),IBPIP=$P(IBLN,U,4),IBIFN=$P(IBLN,U,2)
"RTN","IBCRCC",50,0)
 I +IBPIP S IBLN=$G(^RMPR(660,+IBPIP,0)) I IBLN'="" S IBX=$P(IBLN,U,16)_U_$P(IBLN,U,7)_U_IBIFN
"RTN","IBCRCC",51,0)
 Q IBX
"RTN","IBCRCC",52,0)
 ;
"RTN","IBCRCC",53,0)
RATECHG(RS,CHG,EVDT,FEE) ; returns modifed item charge based on rate schedule:  check effective dates, apply adjustment
"RTN","IBCRCC",54,0)
 ; adjusted amount ^ comment (if there is an adjustment)
"RTN","IBCRCC",55,0)
 ; if FEE passed by reference, returns disp fee^admin fee
"RTN","IBCRCC",56,0)
 ;
"RTN","IBCRCC",57,0)
 N IBX,IBRS0,IBRS10,IBEFDT,IBINADT,IBRTY,X S IBRTY=""
"RTN","IBCRCC",58,0)
 S IBX=+$G(CHG),IBRS0=$G(^IBE(363,+$G(RS),0)),IBRS10=$G(^IBE(363,+$G(RS),10))
"RTN","IBCRCC",59,0)
 S EVDT=$S(+$G(EVDT):EVDT,1:DT),IBEFDT=$P(IBRS0,U,5),IBINADT=$P(IBRS0,U,6)
"RTN","IBCRCC",60,0)
 I +IBEFDT>EVDT!(+IBINADT&(IBINADT<EVDT)) S IBX=0
"RTN","IBCRCC",61,0)
 I +IBX,IBRS10'="" S X=IBX X IBRS10 S IBX=X,IBRTY="^Rate Schedule Adjustment ("_$J(CHG,"",2)_")"
"RTN","IBCRCC",62,0)
 S FEE=$P($G(^IBE(363,+$G(RS),1)),"^",1,2)
"RTN","IBCRCC",63,0)
 Q IBX_IBRTY
"RTN","IBCRCC",64,0)
 ;
"RTN","IBCRCC",65,0)
RXCOST(RX) ; returns (RX=ptr 362.4): VA Cost of an Rx - Per Unit Cost ^ bill IFN
"RTN","IBCRCC",66,0)
 ; w/ Per Unit Cost = Refill (Current Unit Price of Drug - 52.1,1.2) or RX (Unit Price of Drug - 52,17)
"RTN","IBCRCC",67,0)
 ;
"RTN","IBCRCC",68,0)
 N IBRXP,IBDGP,IBLN,IBX,IBIFN,IBDT,IBY
"RTN","IBCRCC",69,0)
 S (IBRXP,IBX)=0
"RTN","IBCRCC",70,0)
 I +$G(RX) S IBLN=$G(^IBA(362.4,+RX,0)),IBRXP=$P(IBLN,U,5),IBDGP=$P(IBLN,U,4),IBIFN=$P(IBLN,U,2),IBDT=$P(IBLN,U,3)
"RTN","IBCRCC",71,0)
 ;
"RTN","IBCRCC",72,0)
 I +IBRXP S IBY=$$RFLNUM^IBRXUTL(IBRXP,IBDT) I +IBY S IBX=$$SUBFILE^IBRXUTL(IBRXP,+IBY,52,1.2)_U_IBIFN
"RTN","IBCRCC",73,0)
 I +IBRXP,'IBX S IBX=$$FILE^IBRXUTL(IBRXP,17)_U_IBIFN
"RTN","IBCRCC",74,0)
 I 'IBRXP,+IBDGP D DATA^IBRXUTL(+IBDGP) S IBLN=$G(^TMP($J,"IBDRUG",0)) I IBLN'="" S IBX=$G(^TMP($J,"IBDRUG",+IBDGP,16))_U_IBIFN
"RTN","IBCRCC",75,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBCRCC",76,0)
 Q IBX
"RTN","IBCRCC",77,0)
 ;
"RTN","IBCRCC",78,0)
PRVCHG(CS,CHG,PRV,EVDT,ITEM) ; return discounted amount, based on total charge for a the care, the provider and Charge Set (BR)
"RTN","IBCRCC",79,0)
 ; if no discount record found for the Charge Set or the provider then returns original amount
"RTN","IBCRCC",80,0)
 ; no provider discount for Lab charges (80000-89999)
"RTN","IBCRCC",81,0)
 ;   discounted amount ^ comment (if discounted) ^ percent discount
"RTN","IBCRCC",82,0)
 ;
"RTN","IBCRCC",83,0)
 N IBPC,IBSGFN,IBSG,IBPDFN,IBPD0,IBPDTY,IBI,IBX,IBY S IBX=+$G(CHG),(IBSGFN,IBPDTY)="" I '$G(EVDT) S EVDT=DT
"RTN","IBCRCC",84,0)
 I +$G(ITEM),ITEM>79999,ITEM<90000 S (CS,PRV)=""
"RTN","IBCRCC",85,0)
 I +$G(CS) S IBSGFN=+$$CSSG^IBCRU6(+CS,"",2,.IBSG)
"RTN","IBCRCC",86,0)
 I +$G(PRV),+IBSGFN S IBPC=$$GET^XUA4A72(PRV,EVDT)
"RTN","IBCRCC",87,0)
 ;
"RTN","IBCRCC",88,0)
 S IBI=0 F  S IBI=$O(IBSG(IBI)) Q:'IBI  S IBSGFN=+IBSG(IBI) I +IBSGFN D
"RTN","IBCRCC",89,0)
 . S IBPDFN=0 F  S IBPDFN=$O(^IBE(363.34,"C",+IBSGFN,IBPDFN)) Q:'IBPDFN  D  Q:IBPDTY'=""
"RTN","IBCRCC",90,0)
 .. I '$O(^IBE(363.34,+IBPDFN,11,"B",+IBPC,0)) Q
"RTN","IBCRCC",91,0)
 .. S IBPD0=$G(^IBE(363.34,+IBPDFN,0)),IBY=$P(IBPD0,U,3) Q:IBY=""
"RTN","IBCRCC",92,0)
 .. S IBY=+IBY/100,IBX=IBY*IBX
"RTN","IBCRCC",93,0)
 .. S IBPDTY=U_$P($G(^VA(200,+PRV,0)),U,1)_" - "_$P(IBPD0,U,1)_" "_$P(IBPD0,U,3)_"% of "_$J(CHG,0,2)_U_+IBY
"RTN","IBCRCC",94,0)
 Q IBX_IBPDTY
"RTN","IBCRCC",95,0)
 ;
"RTN","IBCRCC",96,0)
MODCHG(CS,CHG,MODS) ; return adjusted amount due to RC modifier adjustment
"RTN","IBCRCC",97,0)
 ; straight adjustment for RC Physician charges by modifier, if no modifier adjustment returns original amount
"RTN","IBCRCC",98,0)
 ; Input:  Charge Set, Procedure Charge, Modifiers - list with modifier IEN's separated by ','
"RTN","IBCRCC",99,0)
 ; Output: discounted amount ^ comment (if discounted) ^ percent discount
"RTN","IBCRCC",100,0)
 ;
"RTN","IBCRCC",101,0)
 N IBCS0,IBBR0,IBMOD,IBMODS,IBMODE,IBDSCNT,IBPDTY,IBI,IBX,IBY
"RTN","IBCRCC",102,0)
 S CHG=+$G(CHG),MODS=$G(MODS),(IBBR0,IBPDTY,IBMODS)="",IBDSCNT=1,IBX=+CHG
"RTN","IBCRCC",103,0)
 I +$G(CS) S IBCS0=$G(^IBE(363.1,+CS,0)),IBBR0=$G(^IBE(363.3,+$P(IBCS0,U,2),0))
"RTN","IBCRCC",104,0)
 I $P(IBBR0,U,1)'["RC PHYSICIAN" S MODS="" ; professional charge only
"RTN","IBCRCC",105,0)
 I $P(IBBR0,U,4)'=2 S MODS="" ; CPT item only
"RTN","IBCRCC",106,0)
 I 'CHG S MODS=""
"RTN","IBCRCC",107,0)
 ;
"RTN","IBCRCC",108,0)
 I +MODS F IBI=1:1 S IBMOD=$P(MODS,",",IBI) Q:'IBMOD  S IBY=0 D
"RTN","IBCRCC",109,0)
 . I IBMOD=3 S IBMODE=22,IBY=1.2,IBX=IBX*IBY ; modifier 22 at 120% adjustment
"RTN","IBCRCC",110,0)
 . I IBMOD=10 S IBMODE=50,IBY=1.54,IBX=IBX*IBY ; modifier 50 at 154% adjustment
"RTN","IBCRCC",111,0)
 . I +IBY S IBMODS=IBMODS_$S(IBMODS="":"",1:",")_IBMODE,IBDSCNT=IBDSCNT*IBY ; allow for multiple discounts
"RTN","IBCRCC",112,0)
 I IBMODS'="" S IBPDTY=U_"Modifier "_IBMODS_" Adjustment "_(IBDSCNT*100)_"% of "_$J(CHG,0,2)_U_+IBDSCNT
"RTN","IBCRCC",113,0)
 Q IBX_IBPDTY
"RTN","IBCRCC",114,0)
 ;
"RTN","IBCRCC",115,0)
HRUNIT(HRS) ; returns Hour Units based on the Hours passed in
"RTN","IBCRCC",116,0)
 ; Hour Units are the hours rounded to the nearest whole hour (less than 30 minutes is 0 units)
"RTN","IBCRCC",117,0)
 N IBX S IBX=0 I +$G(HRS) S IBX=$J(HRS,0,0)
"RTN","IBCRCC",118,0)
 Q IBX
"RTN","IBCRCC",119,0)
 ;
"RTN","IBCRCC",120,0)
MLUNIT(MLS) ; returns Miles Units based on the Miles passed in
"RTN","IBCRCC",121,0)
 ; Mile Units are the miles rounded to the nearest whole mile
"RTN","IBCRCC",122,0)
 N IBX S IBX=0 I +$G(MLS) S IBX=$J(MLS,0,0) I 'IBX S IBX=1
"RTN","IBCRCC",123,0)
 Q IBX
"RTN","IBCRCC",124,0)
 ;
"RTN","IBCRCC",125,0)
MNUNIT(MNS) ; return Minute Units based on the Minutes passed in
"RTN","IBCRCC",126,0)
 ; Minute Units are 15 minute intervals, rounded up after any minutes
"RTN","IBCRCC",127,0)
 N IBX S IBX=0 I +$G(MNS) S IBX=(MNS\15) S:+(MNS#15) IBX=IBX+1 I 'IBX S IBX=1
"RTN","IBCRCC",128,0)
 Q IBX
"RTN","IBNCPDP")
0^2^B1881095^B1668933
"RTN","IBNCPDP",1,0)
IBNCPDP ;OAK/ELZ - APIS FOR NCPCP/ECME ;1/9/08  17:27
"RTN","IBNCPDP",2,0)
 ;;2.0;INTEGRATED BILLING;**223,276,363,383**;21-MAR-94;Build 11
"RTN","IBNCPDP",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBNCPDP",4,0)
 ;
"RTN","IBNCPDP",5,0)
 ;
"RTN","IBNCPDP",6,0)
RX(DFN,IBD) ; pharmacy package call, passing in IBD by ref
"RTN","IBNCPDP",7,0)
 ; this is called by PSO for all prescriptions issued, return is
"RTN","IBNCPDP",8,0)
 ; a response to bill ECME or not with array for billing data elements
"RTN","IBNCPDP",9,0)
 ; third piece of return is an Eligibility indicator for the prescription
"RTN","IBNCPDP",10,0)
 ;
"RTN","IBNCPDP",11,0)
 ; IBD("IEN")         = Prescription IEN
"RTN","IBNCPDP",12,0)
 ;    ("FILL NUMBER") = Fill number (0 is initial)
"RTN","IBNCPDP",13,0)
 ;    ("FILL DATE")   = Fill or refill date
"RTN","IBNCPDP",14,0)
 ;    ("RELEASE DATE")= Date of the Rx release in FileMan format
"RTN","IBNCPDP",15,0)
 ;    ("NDC")         = NDC number for drug
"RTN","IBNCPDP",16,0)
 ;    ("DEA")         = DEA special handling info
"RTN","IBNCPDP",17,0)
 ;    ("COST")        = cost of medication being dispenced
"RTN","IBNCPDP",18,0)
 ;    ("AO")          = Agent Orange (0,1 OR Null)
"RTN","IBNCPDP",19,0)
 ;    ("EC")          = Environmental Contaminant (0,1 OR Null)
"RTN","IBNCPDP",20,0)
 ;    ("HNC")         = Head/neck cancer (0,1 OR Null)
"RTN","IBNCPDP",21,0)
 ;    ("IR")          = Ionizing radiation (0,1 OR Null)
"RTN","IBNCPDP",22,0)
 ;    ("MST")         = Military sexual trauma (0,1 OR Null)
"RTN","IBNCPDP",23,0)
 ;    ("SC")          = Service connected (0,1 OR Null)
"RTN","IBNCPDP",24,0)
 ;    ("CV")          = Combat Veteran (0,1 OR Null)
"RTN","IBNCPDP",25,0)
 ;    ("QTY")         = Quantity of med
"RTN","IBNCPDP",26,0)
 ;    ("EPHARM")      = #9002313.56 ien (E-PHARMACY division)
"RTN","IBNCPDP",27,0)
 ;
"RTN","IBNCPDP",28,0)
 ;
"RTN","IBNCPDP",29,0)
 ; IBD("INS",n,1) = insurance array to bill in n order
"RTN","IBNCPDP",30,0)
 ;                  file 355.3 ien (group)^bin^pcn^payer sheet^group id^
"RTN","IBNCPDP",31,0)
 ;                  cardholder id^patient relationship code^
"RTN","IBNCPDP",32,0)
 ;                  cardholder first name^cardholder last name^
"RTN","IBNCPDP",33,0)
 ;                  home plan state ^Payer Sheet B2 ^Payer Sheet B3
"RTN","IBNCPDP",34,0)
 ;                  Software/Vendor Cert ID ^ Ins Name
"RTN","IBNCPDP",35,0)
 ;    ("INS",n,2) = dispensing fee^basis of cost determination^
"RTN","IBNCPDP",36,0)
 ;                  awp or tort rate or cost^gross amount due^
"RTN","IBNCPDP",37,0)
 ;                  administrative fee
"RTN","IBNCPDP",38,0)
 ;
"RTN","IBNCPDP",39,0)
 ;   for basis of cost determination the following is used:
"RTN","IBNCPDP",40,0)
 ;      "07" would be sent for Usual & Customary
"RTN","IBNCPDP",41,0)
 ;      "01" would be sent for AWP
"RTN","IBNCPDP",42,0)
 ;      "05" would be sent for Cost calculations
"RTN","IBNCPDP",43,0)
 ;
"RTN","IBNCPDP",44,0)
 ;    ("INS",n,3) = group name^ins co ph 3^plan ID^
"RTN","IBNCPDP",45,0)
 ;                  insurance type (V=vet, T=tricare)^
"RTN","IBNCPDP",46,0)
 ;                  insurance company (#36) ien
"RTN","IBNCPDP",47,0)
 ;
"RTN","IBNCPDP",48,0)
 N IBRES,IBNB
"RTN","IBNCPDP",49,0)
 S IBRES=$$RX^IBNCPDP1(DFN,.IBD)
"RTN","IBNCPDP",50,0)
 ;remove "Not ECME billable: " from the reason text
"RTN","IBNCPDP",51,0)
 S IBNB="Not ECME billable: "
"RTN","IBNCPDP",52,0)
 I IBRES[IBNB S IBRES=$P(IBRES,U)_U_$P($P(IBRES,U,2),IBNB,2)_U_$P(IBRES,U,3)
"RTN","IBNCPDP",53,0)
 Q IBRES
"RTN","IBNCPDP",54,0)
 ;
"RTN","IBNCPDP",55,0)
 ;
"RTN","IBNCPDP",56,0)
STORESP(DFN,IBD) ; this is an API for pharmacy/ecme to use to relay
"RTN","IBNCPDP",57,0)
 ; results of billing using the ecme software.  If electronic billing is
"RTN","IBNCPDP",58,0)
 ; successful, then bills will be established.  If not, then we will
"RTN","IBNCPDP",59,0)
 ; flag the entry in ct for paper or not billable.
"RTN","IBNCPDP",60,0)
 ;
"RTN","IBNCPDP",61,0)
 ; IBD("STATUS")       = Bill status (PAID, REJECTED,REVERSED
"RTN","IBNCPDP",62,0)
 ;                        CLOSED,RELEASED,or SUBMITTED)
"RTN","IBNCPDP",63,0)
 ;    ("FILL DATE")    = Fill Date
"RTN","IBNCPDP",64,0)
 ;    ("PRESCRIPTION") = Prescription IEN from drug file (#52)
"RTN","IBNCPDP",65,0)
 ;    ("FILL NUMBER")  = Fill or refill number
"RTN","IBNCPDP",66,0)
 ;    ("BILLED")       = Amount billed
"RTN","IBNCPDP",67,0)
 ;    ("PAID")         = Amount paid
"RTN","IBNCPDP",68,0)
 ;    ("BCID")         = Reference number to the claim for payment
"RTN","IBNCPDP",69,0)
 ;                       BCID stands for Bill Claim ID
"RTN","IBNCPDP",70,0)
 ;    ("PLAN")         = IEN of the the entry in the GROUP INSURANCE
"RTN","IBNCPDP",71,0)
 ;                       PLAN file(#355.3)(captured from the
"RTN","IBNCPDP",72,0)
 ;                       $$RX^IBNCPDP call)
"RTN","IBNCPDP",73,0)
 ;    ("COPAY")        = Patient's copay from ECME response
"RTN","IBNCPDP",74,0)
 ;    ("RX NO")        = RX number from file 52
"RTN","IBNCPDP",75,0)
 ;    ("DRUG")         = IEN of file #50 DRUG
"RTN","IBNCPDP",76,0)
 ;    ("DAYS SUPPLY")  = Days Supply
"RTN","IBNCPDP",77,0)
 ;    ("QTY")          = Quantity
"RTN","IBNCPDP",78,0)
 ;    ("NDC")          = NDC
"RTN","IBNCPDP",79,0)
 ;    ("CLOSE REASON") = Optional, Pointer to the IB file #356.8
"RTN","IBNCPDP",80,0)
 ;                      "CLAIMS TRACKING NON-BILLABLE REASONS"
"RTN","IBNCPDP",81,0)
 ;    ("CLOSE COMMENT")= Optional, if the close reason is defined
"RTN","IBNCPDP",82,0)
 ;                       then the Close Comment parameter may be
"RTN","IBNCPDP",83,0)
 ;                       sent to IB
"RTN","IBNCPDP",84,0)
 ;    ("DROP TO PAPER")= Optional, this parameter may be set to 1(TRUE)
"RTN","IBNCPDP",85,0)
 ;                       for certain Close Claim Reasons, indicating
"RTN","IBNCPDP",86,0)
 ;                       that that the closed episode still may be
"RTN","IBNCPDP",87,0)
 ;                       "dropped to paper" - passed to the Autobiller
"RTN","IBNCPDP",88,0)
 ;    ("RELEASE COPAY")= Optional, if the claim is being closed, setting
"RTN","IBNCPDP",89,0)
 ;                       this parameter to 1 (TRUE) indicates that the
"RTN","IBNCPDP",90,0)
 ;                       patients copay should be released off hold
"RTN","IBNCPDP",91,0)
 ;    ("DIVISION")     = Pointer to the MC DIVISION file (#40.8)
"RTN","IBNCPDP",92,0)
 ;    ("AUTH #")       = ECME approval/authorization number
"RTN","IBNCPDP",93,0)
 ;    ("CLAIMID")      = Reference Number to ECME
"RTN","IBNCPDP",94,0)
 ;    ("EPHARM")       = Optional, #9002313.56 ien (E-PHARMACY division)
"RTN","IBNCPDP",95,0)
 ;
"RTN","IBNCPDP",96,0)
 ;
"RTN","IBNCPDP",97,0)
 ; Return is the bill number for success or 1 if not billable.
"RTN","IBNCPDP",98,0)
 ; "0^reason" indicates not success
"RTN","IBNCPDP",99,0)
 ;
"RTN","IBNCPDP",100,0)
 Q $$ECME^IBNCPDP2(DFN,.IBD)
"RTN","IBNCPDP",101,0)
 ;
"RTN","IBNCPDP",102,0)
 ;
"RTN","IBNCPDP",103,0)
UPAWP(IBNDC,IBAWP,IBADT) ; used to update AWPs.  This is an API that
"RTN","IBNCPDP",104,0)
 ; pharmacy will call.
"RTN","IBNCPDP",105,0)
 ;
"RTN","IBNCPDP",106,0)
 ;  IBNDC = NDC number to update with the price.
"RTN","IBNCPDP",107,0)
 ;  IBAWP = average wholesale price of the NDC
"RTN","IBNCPDP",108,0)
 ;  IBADT  = effective date of change (optional, default it today)
"RTN","IBNCPDP",109,0)
 ;
"RTN","IBNCPDP",110,0)
 ;  return will be a positive number indicating success.
"RTN","IBNCPDP",111,0)
 ;  if it is unsuccessful, then "0^reason" will be returned.
"RTN","IBNCPDP",112,0)
 ;
"RTN","IBNCPDP",113,0)
 Q $$UPAWP^IBNCPDP3(IBNDC,IBAWP,$G(IBADT,DT))
"RTN","IBNCPDP",114,0)
 ;
"RTN","IBNCPDP",115,0)
 ;
"RTN","IBNCPDP1")
0^3^B67408703^B56920205
"RTN","IBNCPDP1",1,0)
IBNCPDP1 ;OAK/ELZ - PROCESSING FOR NEW RX REQUESTS ;3/27/08  17:36
"RTN","IBNCPDP1",2,0)
 ;;2.0;INTEGRATED BILLING;**223,276,339,363,383**;21-MAR-94;Build 11
"RTN","IBNCPDP1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBNCPDP1",4,0)
 ;
"RTN","IBNCPDP1",5,0)
 ;
"RTN","IBNCPDP1",6,0)
RX(DFN,IBD) ; pharmacy package call, passing in IBD by ref
"RTN","IBNCPDP1",7,0)
 ; this is called by PSO for all prescriptions issued, return is
"RTN","IBNCPDP1",8,0)
 ; a response to bill ECME or not with array for billing data elements
"RTN","IBNCPDP1",9,0)
 ;warning: back-billing flag:
"RTN","IBNCPDP1",10,0)
 ;if passed IBSCRES(IBRXN,IBFIL)=1
"RTN","IBNCPDP1",11,0)
 ; - the the SC Determination is just done by the IB clerk (billable)
"RTN","IBNCPDP1",12,0)
 ;
"RTN","IBNCPDP1",13,0)
 ;clean up the list of non-answered SC/Env.indicators questions and INS
"RTN","IBNCPDP1",14,0)
 K IBD("SC/EI NO ANSW"),IBD("INS")
"RTN","IBNCPDP1",15,0)
 ;
"RTN","IBNCPDP1",16,0)
 N IBTRKR,IBARR,IBADT,IBRXN,IBFIL,IBTRKRN,IBRMARK,IBANY,IBX,IBT,IBINS,IBSAVE
"RTN","IBNCPDP1",17,0)
 N IBFEE,IBEABD,IBBI,IBIT,IBPRICE,IBRS,IBRT,IBTRN,IBCHG,IBERMSG,IBRES,IBNEEDS
"RTN","IBNCPDP1",18,0)
 ;
"RTN","IBNCPDP1",19,0)
 I '$G(DFN) S IBRES="0^No DFN" G RXQ
"RTN","IBNCPDP1",20,0)
 S IBRXN=+$G(IBD("IEN")) I 'IBRXN S IBRES="0^No Rx IEN" G RXQ
"RTN","IBNCPDP1",21,0)
 S IBFIL=+$G(IBD("FILL NUMBER"),-1) I IBFIL<0 S IBRES="0^No fill number" G RXQ
"RTN","IBNCPDP1",22,0)
 S IBD("QTY")=+$G(IBD("QTY")) I 'IBD("QTY") S IBRES="0^No Quantity" G RXQ
"RTN","IBNCPDP1",23,0)
 ;
"RTN","IBNCPDP1",24,0)
 S IBRES="0^Error"
"RTN","IBNCPDP1",25,0)
 S (IBEABD,IBADT)=+$G(IBD("FILL DATE"),DT)
"RTN","IBNCPDP1",26,0)
 ;
"RTN","IBNCPDP1",27,0)
 ; -- look up insurance for patient
"RTN","IBNCPDP1",28,0)
 D ALL^IBCNS1(DFN,"IBINS",1,IBADT,1)
"RTN","IBNCPDP1",29,0)
 ;
"RTN","IBNCPDP1",30,0)
 ; -- determine rate type
"RTN","IBNCPDP1",31,0)
 S IBRT=$$RT^IBNCPDPU(DFN,.IBINS)
"RTN","IBNCPDP1",32,0)
 ;
"RTN","IBNCPDP1",33,0)
 ; -- claims tracking info
"RTN","IBNCPDP1",34,0)
 S IBTRKR=$G(^IBE(350.9,1,6))
"RTN","IBNCPDP1",35,0)
 ; date can't be before parameters
"RTN","IBNCPDP1",36,0)
 S $P(IBTRKR,U)=$S('$P(IBTRKR,U,4):0,+IBTRKR&(IBADT<+IBTRKR):0,1:IBADT)
"RTN","IBNCPDP1",37,0)
 ; already in claims tracking
"RTN","IBNCPDP1",38,0)
 S IBTRKRN=+$O(^IBT(356,"ARXFL",IBRXN,IBFIL,0))
"RTN","IBNCPDP1",39,0)
 I IBTRKRN,$$PAPERBIL(IBTRKRN) S IBRES="0^Existing IB Bill in CT",IBD("NO ECME INSURANCE")=1 G RXQ
"RTN","IBNCPDP1",40,0)
 ; already billed as Tricare
"RTN","IBNCPDP1",41,0)
 I $D(^IBA(351.5,"B",IBRXN_";"_IBFIL)) S IBRES="0^Already billed under prior Tricare process",IBD("NO ECME INSURANCE")=1 G RXQ
"RTN","IBNCPDP1",42,0)
 ;
"RTN","IBNCPDP1",43,0)
 ; -- no pharmacy coverage, update ct if applicable, quit
"RTN","IBNCPDP1",44,0)
 I '$$PTCOV^IBCNSU3(DFN,IBADT,"PHARMACY",.IBANY) S IBRMARK=$S($G(IBANY):"SERVICE NOT COVERED",1:"NOT INSURED") D:$P(IBTRKR,U,4)=2 CT S IBRES="0^"_IBRMARK,IBD("NO ECME INSURANCE")=1 G RXQ
"RTN","IBNCPDP1",45,0)
 ;
"RTN","IBNCPDP1",46,0)
 ;  -- check for compound,  NOT BILLABLE
"RTN","IBNCPDP1",47,0)
 I $G(IBD("DEA"))="" D CT S IBRES="0^Null DEA Special Handling field" G RXQ
"RTN","IBNCPDP1",48,0)
 I IBD("DEA")["M"!(IBD("DEA")["0") S IBRMARK="DRUG NOT BILLABLE" D CT S IBRES="0^COMPOUND DRUG" G RXQ
"RTN","IBNCPDP1",49,0)
 ; -- check drug (not investigational, supply, or over the counter drug
"RTN","IBNCPDP1",50,0)
 ;  "E" means always ecme billable
"RTN","IBNCPDP1",51,0)
 I (IBD("DEA")["I"!(IBD("DEA")["S")!(IBD("DEA")["9")),IBD("DEA")'["E" S IBRMARK="DRUG NOT BILLABLE" D CT S IBRES="0^"_IBRMARK G RXQ
"RTN","IBNCPDP1",52,0)
 ;
"RTN","IBNCPDP1",53,0)
 ;retrieve indicators from file #52 and overwrite the indicators in IBD array
"RTN","IBNCPDP1",54,0)
 D GETINDIC^IBNCPUT2(+IBD("IEN"),.IBD)
"RTN","IBNCPDP1",55,0)
 ; -- process patient exemptions if any (if not already resolved)
"RTN","IBNCPDP1",56,0)
 I $G(IBD("SC/EI OVR"))'=1 D CL^SDCO21(DFN,IBADT,"",.IBARR)
"RTN","IBNCPDP1",57,0)
 ; check out exemptions
"RTN","IBNCPDP1",58,0)
 S IBNEEDS=0 ;flag will be set to 1 if at least one of the questions wasn't answered
"RTN","IBNCPDP1",59,0)
 I $G(IBD("SC/EI OVR"))'=1 I $D(IBARR)>9 F IBX=2:1 S IBT=$P($T(EXEMPT+IBX),";;",2) Q:IBT=""  D:$D(IBARR(+IBT))
"RTN","IBNCPDP1",60,0)
 . I $G(IBD($P(IBT,U,2)))=0 Q
"RTN","IBNCPDP1",61,0)
 . I $G(IBD($P(IBT,U,2))) S IBRMARK=$P(IBT,U,3) Q
"RTN","IBNCPDP1",62,0)
 . I '$G(IBSCRES(IBRXN,IBFIL)) S IBNEEDS=1 D
"RTN","IBNCPDP1",63,0)
 . . S IBD("SC/EI NO ANSW")=$S($G(IBD("SC/EI NO ANSW"))="":$P(IBT,U,2),1:$G(IBD("SC/EI NO ANSW"))_","_$P(IBT,U,2))
"RTN","IBNCPDP1",64,0)
 I '$D(IBRMARK),IBNEEDS=1 S IBRMARK="NEEDS SC DETERMINATION"
"RTN","IBNCPDP1",65,0)
 I $D(IBRMARK) D CT S IBRES="0^"_IBRMARK G RXQ
"RTN","IBNCPDP1",66,0)
 ; Clean-up the NEEDS SC DETERMINATION record if resolved
"RTN","IBNCPDP1",67,0)
 ; And check if it is non-billable in CT
"RTN","IBNCPDP1",68,0)
 I IBTRKRN D
"RTN","IBNCPDP1",69,0)
 . N IBNBR,IBNBRT
"RTN","IBNCPDP1",70,0)
 . S IBNBR=$P($G(^IBT(356,+IBTRKRN,0)),U,19) Q:'IBNBR
"RTN","IBNCPDP1",71,0)
 . S IBNBRT=$P($G(^IBE(356.8,IBNBR,0)),U) Q:IBNBRT=""
"RTN","IBNCPDP1",72,0)
 . ; if refill was deleted (not RX) and now the refill is re-entered
"RTN","IBNCPDP1",73,0)
 . ;use $$RXSTATUS^IBNCPRR instead of $G(^PSRX(IBRXN,"STA"))
"RTN","IBNCPDP1",74,0)
 . I IBNBRT="PRESCRIPTION DELETED",$$RXSTATUS^IBNCPRR(DFN,IBRXN)'=13 D  Q
"RTN","IBNCPDP1",75,0)
 . . N DIE,DA,DR
"RTN","IBNCPDP1",76,0)
 . . ; clean up REASON NOT BILLABLE and ADDITIONAL COMMENT
"RTN","IBNCPDP1",77,0)
 . . S DIE="^IBT(356,",DA=+IBTRKRN,DR=".19////@;1.08////@" D ^DIE
"RTN","IBNCPDP1",78,0)
 . ; Clean up NBR if released
"RTN","IBNCPDP1",79,0)
 . I IBNBRT="PRESCRIPTION NOT RELEASED" D:$G(IBD("RELEASE DATE"))  Q
"RTN","IBNCPDP1",80,0)
 . . N DIE,DA,DR
"RTN","IBNCPDP1",81,0)
 . . S DIE="^IBT(356,",DA=+IBTRKRN,DR=".19////@" D ^DIE
"RTN","IBNCPDP1",82,0)
 . ; Clean up 'Needs SC determ'
"RTN","IBNCPDP1",83,0)
 . I IBNBRT="NEEDS SC DETERMINATION" D  Q
"RTN","IBNCPDP1",84,0)
 . . N DIE,DA,DR
"RTN","IBNCPDP1",85,0)
 . . S DIE="^IBT(356,",DA=+IBTRKRN,DR=".19////@" D ^DIE
"RTN","IBNCPDP1",86,0)
 . S IBRMARK=IBNBRT
"RTN","IBNCPDP1",87,0)
 I $D(IBRMARK) S IBRES="0^Non-Billable in CT: "_IBRMARK G RXQ
"RTN","IBNCPDP1",88,0)
 ;
"RTN","IBNCPDP1",89,0)
 ; -- setup insurance data for patient
"RTN","IBNCPDP1",90,0)
 S IBERMSG="" ; Error message
"RTN","IBNCPDP1",91,0)
 S IBX=0 F  S IBX=$O(IBINS("S",IBX)) Q:'IBX  D
"RTN","IBNCPDP1",92,0)
 . S IBT=0 F  S IBT=$O(IBINS("S",IBX,IBT)) Q:'IBT  D
"RTN","IBNCPDP1",93,0)
 .. N IBDAT,IBPL,IBINSN,IBPIEN,IBY,IBZ
"RTN","IBNCPDP1",94,0)
 .. S IBZ=$G(IBINS(IBT,0)) Q:IBZ=""
"RTN","IBNCPDP1",95,0)
 .. S IBPL=$P(IBZ,U,18) ; plan
"RTN","IBNCPDP1",96,0)
 .. Q:'IBPL
"RTN","IBNCPDP1",97,0)
 .. Q:'$$PLCOV^IBCNSU3(IBPL,IBADT,3)  ; not covered
"RTN","IBNCPDP1",98,0)
 .. I '$D(IBD("INS")),$P(IBRT,"^",3)="V",($P($G(^IBE(355.1,+$P($G(^IBA(355.3,+IBPL,0)),"^",9),0)),"^")["TRICARE"!($P($G(^(0)),"^")="CHAMPVA")) K IBINS Q  ;Tricare/ChampVa coverage for a Vet
"RTN","IBNCPDP1",99,0)
 .. S IBINSN=$P($G(^DIC(36,+$G(^IBA(355.3,+IBPL,0)),0)),U) ; ins name
"RTN","IBNCPDP1",100,0)
 .. S IBPIEN=+$G(^IBA(355.3,+IBPL,6))
"RTN","IBNCPDP1",101,0)
 .. I 'IBPIEN S IBERMSG="Plan not linked to the Payer" Q  ; Not linked
"RTN","IBNCPDP1",102,0)
 .. D STCHK^IBCNRU1(IBPIEN,.IBY)
"RTN","IBNCPDP1",103,0)
 .. I $E($G(IBY(1)))'="A" S IBERMSG=$$ERMSG($P($G(IBY(6)),",")) Q  ; not active
"RTN","IBNCPDP1",104,0)
 .. S IBDAT=IBPL ; Plan IEN
"RTN","IBNCPDP1",105,0)
 .. S $P(IBDAT,U,2)=$G(IBY(2)) ; BIN
"RTN","IBNCPDP1",106,0)
 .. S $P(IBDAT,U,3)=$G(IBY(3)) ; PCN
"RTN","IBNCPDP1",107,0)
 .. S $P(IBDAT,U,4)=$P($G(^BPSF(9002313.92,+$P($G(IBY(5)),",",1),0)),U) ; Payer Sheet B1
"RTN","IBNCPDP1",108,0)
 .. S $P(IBDAT,U,5)=$P($G(IBINS(IBT,355.3)),U,4) ; Group ID
"RTN","IBNCPDP1",109,0)
 .. S $P(IBDAT,U,6)=$P(IBZ,U,2) ; Cardholder ID
"RTN","IBNCPDP1",110,0)
 .. S $P(IBDAT,U,7)=$P(IBZ,U,16) ; Patient Relationship Code
"RTN","IBNCPDP1",111,0)
 .. S $P(IBDAT,U,8)=$P($P($P(IBZ,U,17),",",2)," ") ; Cardholder First Name
"RTN","IBNCPDP1",112,0)
 .. S $P(IBDAT,U,9)=$P($P(IBZ,U,17),",") ; Cardholder Last Name
"RTN","IBNCPDP1",113,0)
 .. S $P(IBDAT,U,10)=$P($G(^DIC(36,+IBZ,.11)),U,5) ; State
"RTN","IBNCPDP1",114,0)
 .. S $P(IBDAT,U,11)=$P($G(^BPSF(9002313.92,+$P($G(IBY(5)),",",2),0)),U) ; Payer Sheet B2
"RTN","IBNCPDP1",115,0)
 .. S $P(IBDAT,U,12)=$P($G(^BPSF(9002313.92,+$P($G(IBY(5)),",",3),0)),U) ; Payer Sheet B3
"RTN","IBNCPDP1",116,0)
 .. S $P(IBDAT,U,13)=$G(IBY(4)) ; Software/Vendor Cert ID
"RTN","IBNCPDP1",117,0)
 .. S $P(IBDAT,U,14)=IBINSN ; Ins Name
"RTN","IBNCPDP1",118,0)
 .. S IBD("INS",IBX,1)=IBDAT
"RTN","IBNCPDP1",119,0)
 .. S IBDAT=$P($G(IBINS(IBT,355.3)),"^",3) ;group name
"RTN","IBNCPDP1",120,0)
 .. S $P(IBDAT,U,2)=$$PHONE(+IBZ) ;ins co ph 3
"RTN","IBNCPDP1",121,0)
 .. S $P(IBDAT,U,3)=$$GET1^DIQ(366.03,IBPIEN_",",.01) ;plan ID
"RTN","IBNCPDP1",122,0)
 .. S $P(IBDAT,U,4)=$S($P($G(^IBE(355.1,+$P($G(IBINS(IBT,355.3)),"^",9),0)),"^")="TRICARE":"T",1:"V") ; plan type
"RTN","IBNCPDP1",123,0)
 .. S $P(IBDAT,U,5)=+$G(^IBA(355.3,+IBPL,0)) ; insurance co ien
"RTN","IBNCPDP1",124,0)
 .. S IBD("INS",IBX,3)=IBDAT
"RTN","IBNCPDP1",125,0)
 I '$D(IBD("INS")),IBERMSG'="" S IBRES="0^Not ECME billable: "_IBERMSG,IBD("NO ECME INSURANCE")=1 G RXQ
"RTN","IBNCPDP1",126,0)
 I '$D(IBD("INS")) S IBRES="0^No Insurance ECME billable",IBD("NO ECME INSURANCE")=1 G RXQ
"RTN","IBNCPDP1",127,0)
 ;
"RTN","IBNCPDP1",128,0)
 ; determine rates/prices to use
"RTN","IBNCPDP1",129,0)
 I 'IBRT D CT S IBRES="0^Cannot determine Rate type" G RXQ
"RTN","IBNCPDP1",130,0)
 S IBBI=$$EVNTITM^IBCRU3(+IBRT,3,"PRESCRIPTION FILL",IBADT,.IBRS)
"RTN","IBNCPDP1",131,0)
 I 'IBBI,$P(IBBI,";")'="VA COST" D CT S IBRES="0^Cannot find Billable Item" G RXQ
"RTN","IBNCPDP1",132,0)
 ;1;BEDSECTION;1^
"RTN","IBNCPDP1",133,0)
 ;IBRS(1,18,5)=
"RTN","IBNCPDP1",134,0)
 S IBRS=+$O(IBRS($P(IBBI,";"),0))
"RTN","IBNCPDP1",135,0)
 S IBIT=$$ITPTR^IBCRU2($P(IBBI,";"),$S($P(IBRT,U,2)="A":$$NDC^IBNCPDPU($G(IBD("NDC"))),1:"PRESCRIPTION"))
"RTN","IBNCPDP1",136,0)
 I 'IBIT,$P(IBRT,U,2)'="C" D CT S IBRES="0^Cannot find Item Pointer" G RXQ
"RTN","IBNCPDP1",137,0)
 ;8
"RTN","IBNCPDP1",138,0)
 S IBPRICE=+$$BICOST^IBCRCI(+IBRT,3,IBADT,"PRESCRIPTION FILL",+IBIT,,,$S($P(IBRT,U,2)="A":IBD("QTY"),1:1))
"RTN","IBNCPDP1",139,0)
 ;36^2991001
"RTN","IBNCPDP1",140,0)
 ;
"RTN","IBNCPDP1",141,0)
 ; get fees if any, ignore return, don't care about price, just need fees
"RTN","IBNCPDP1",142,0)
 S IBCHG=$$RATECHG^IBCRCC(+IBRS,$S($P(IBRT,U,2)'="C":1,1:IBD("QTY")*IBD("COST")),IBADT,.IBFEE)
"RTN","IBNCPDP1",143,0)
 I $P(IBRT,U,2)="C" S IBPRICE=+IBCHG
"RTN","IBNCPDP1",144,0)
 ;
"RTN","IBNCPDP1",145,0)
 I 'IBPRICE D CT S IBRES="0^Cannot find price for Item" G RXQ
"RTN","IBNCPDP1",146,0)
 ;
"RTN","IBNCPDP1",147,0)
 S IBPRICE=(+$G(IBFEE))_U_$S($P(IBRT,U,2)="A":"01",$P(IBRT,U,2)="C":"05",1:"07")_U_$S($P(IBRT,U,2)="C":IBD("QTY")*IBD("COST")+$G(IBFEE),$P(IBRT,U,2)="A":IBPRICE-$G(IBFEE)-$P($G(IBFEE),U,2),1:IBPRICE)_U_IBPRICE_U_(+$P($G(IBFEE),U,2))
"RTN","IBNCPDP1",148,0)
 S IBX=0 F  S IBX=$O(IBD("INS",IBX)) Q:IBX<1  S IBD("INS",IBX,2)=IBPRICE ;_U_$P(IBPAYER,U,6)
"RTN","IBNCPDP1",149,0)
 ;
"RTN","IBNCPDP1",150,0)
 S IBRES=$S($D(IBRMARK):"0^"_IBRMARK,1:1)
"RTN","IBNCPDP1",151,0)
 I IBRES,'$G(IBD("RELEASE DATE")) S IBRMARK="PRESCRIPTION NOT RELEASED"
"RTN","IBNCPDP1",152,0)
 D CT
"RTN","IBNCPDP1",153,0)
 ;
"RTN","IBNCPDP1",154,0)
RXQ S $P(IBRES,"^",3)=$S($L($P($G(IBRT),"^",3)):$P(IBRT,"^",3),1:"V")
"RTN","IBNCPDP1",155,0)
 I IBRES D START^IBNCPDP6(IBRXN_";"_IBFIL,$P(IBRES,"^",3),+IBRT)
"RTN","IBNCPDP1",156,0)
 D LOG^IBNCPDP2("BILLABLE STATUS CHECK",IBRES)
"RTN","IBNCPDP1",157,0)
 Q IBRES
"RTN","IBNCPDP1",158,0)
 ;
"RTN","IBNCPDP1",159,0)
 ;
"RTN","IBNCPDP1",160,0)
CT ; files in claims tracking
"RTN","IBNCPDP1",161,0)
 I IBTRKR D CT^IBNCPDPU(DFN,IBRXN,IBFIL,IBADT,$G(IBRMARK))
"RTN","IBNCPDP1",162,0)
 Q
"RTN","IBNCPDP1",163,0)
 ;
"RTN","IBNCPDP1",164,0)
EXEMPT ; exemption reasons
"RTN","IBNCPDP1",165,0)
 ; variable from SD call ^ variable from PSO ^ reason not billable
"RTN","IBNCPDP1",166,0)
 ;;1^AO^AGENT ORANGE
"RTN","IBNCPDP1",167,0)
 ;;2^IR^IONIZING RADIATION
"RTN","IBNCPDP1",168,0)
 ;;3^SC^SC TREATMENT
"RTN","IBNCPDP1",169,0)
 ;;4^SWA^SOUTHWEST ASIA
"RTN","IBNCPDP1",170,0)
 ;;5^MST^MILITARY SEXUAL TRAUMA
"RTN","IBNCPDP1",171,0)
 ;;6^HNC^HEAD/NECK CANCER
"RTN","IBNCPDP1",172,0)
 ;;7^CV^COMBAT VETERAN
"RTN","IBNCPDP1",173,0)
 ;;8^SHAD^PROJECT 112/SHAD
"RTN","IBNCPDP1",174,0)
 ;;
"RTN","IBNCPDP1",175,0)
 ;
"RTN","IBNCPDP1",176,0)
ERMSG(IBSTL) ; Inactive status reason
"RTN","IBNCPDP1",177,0)
 N IBSTA,IBI,IBARR,IBTXT
"RTN","IBNCPDP1",178,0)
 D STATAR^IBCNRU1(.IBARR)
"RTN","IBNCPDP1",179,0)
 F IBI=1:1:$L(IBSTL,",")+1 S IBSTA=+$P(IBSTL,",",IBI) Q:"^100^200^300^400^"'[(U_IBSTA_U)
"RTN","IBNCPDP1",180,0)
 S IBTXT=$G(IBARR(+IBSTA),"Plan is not active.")
"RTN","IBNCPDP1",181,0)
 Q IBTXT
"RTN","IBNCPDP1",182,0)
 ;
"RTN","IBNCPDP1",183,0)
NEEDSC(IBTXT) ; is the CT NBR one of 'needs sc determination'?
"RTN","IBNCPDP1",184,0)
 I IBTXT="NEEDS SC DETERMINATION" Q 1
"RTN","IBNCPDP1",185,0)
 N I,RES,IBT
"RTN","IBNCPDP1",186,0)
 S RES=0
"RTN","IBNCPDP1",187,0)
 F I=2:1 S IBT=$P($P($T(EXEMPT+I),";;",2),U,3) Q:IBT=""  I IBT=IBTXT S RES=1 Q
"RTN","IBNCPDP1",188,0)
 Q RES
"RTN","IBNCPDP1",189,0)
 ;
"RTN","IBNCPDP1",190,0)
PAPERBIL(IBTRKRN) ; 'paper' bill in CT?
"RTN","IBNCPDP1",191,0)
 N IBZ,IBIFN
"RTN","IBNCPDP1",192,0)
 S IBZ=$G(^IBT(356,IBTRKRN,0)) I IBZ="" Q 0
"RTN","IBNCPDP1",193,0)
 S IBIFN=+$P(IBZ,U,11) I 'IBIFN Q 0
"RTN","IBNCPDP1",194,0)
 I $P($G(^DGCR(399,IBIFN,0)),U,13)=7 Q 0  ; cancelled
"RTN","IBNCPDP1",195,0)
 I $P($G(^DGCR(399,IBIFN,"M1")),U,8)'="" Q 0  ; ecme bill
"RTN","IBNCPDP1",196,0)
 Q 1
"RTN","IBNCPDP1",197,0)
 ;
"RTN","IBNCPDP1",198,0)
 ;gets the insurance phone
"RTN","IBNCPDP1",199,0)
 ;input:
"RTN","IBNCPDP1",200,0)
 ; IB36 - ptr to INSURANCE COMPANY File (#36)
"RTN","IBNCPDP1",201,0)
 ;output:
"RTN","IBNCPDP1",202,0)
 ; the phone number
"RTN","IBNCPDP1",203,0)
PHONE(IB36) ;
"RTN","IBNCPDP1",204,0)
 N IB1
"RTN","IBNCPDP1",205,0)
 ;check first CLAIMS (RX) PHONE NUMBER if empty
"RTN","IBNCPDP1",206,0)
 S IB1=$$GET1^DIQ(36,+IB36,.1311,"E")
"RTN","IBNCPDP1",207,0)
 Q:$L(IB1)>0 IB1
"RTN","IBNCPDP1",208,0)
 ;check BILLING PHONE NUMBER if empty - return nothing
"RTN","IBNCPDP1",209,0)
 S IB1=$$GET1^DIQ(36,+IB36,.132,"E")
"RTN","IBNCPDP1",210,0)
 Q IB1
"RTN","IBNCPDP1",211,0)
 ;
"RTN","IBNCPDP1",212,0)
 ;IBNCPDP1
"RTN","IBNCPDP2")
0^4^B53296275^B35333171
"RTN","IBNCPDP2",1,0)
IBNCPDP2 ;OAK/ELZ - PROCESSING FOR ECME RESP ;11/15/07  09:43
"RTN","IBNCPDP2",2,0)
 ;;2.0;INTEGRATED BILLING;**223,276,342,347,363,383**;21-MAR-94;Build 11
"RTN","IBNCPDP2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBNCPDP2",4,0)
 ;
"RTN","IBNCPDP2",5,0)
ECME(DFN,IBD) ; function called by STORESP^IBNCPDP
"RTN","IBNCPDP2",6,0)
 ; input - DFN - patient IEN for the prescription
"RTN","IBNCPDP2",7,0)
 ;         IBD array passed in by reference
"RTN","IBNCPDP2",8,0)
 ;      The IBD array is passed to various subroutines depending
"RTN","IBNCPDP2",9,0)
 ;      on the ePharmacy event as evaluated by IBD("STATUS")
"RTN","IBNCPDP2",10,0)
 I $G(IBD("EPHARM"))="" S IBD("EPHARM")=$$EPHARM(+$G(IBD("PRESCRIPTION")),+$G(IBD("FILL NUMBER")))
"RTN","IBNCPDP2",11,0)
 I IBD("STATUS")="PAID" Q $$BILL(DFN,.IBD)
"RTN","IBNCPDP2",12,0)
 I IBD("STATUS")="REVERSED" Q $$REVERSE^IBNCPDP3(DFN,.IBD)
"RTN","IBNCPDP2",13,0)
 I IBD("STATUS")="CLOSED" Q $$CLOSE^IBNCPDP4(DFN,.IBD)
"RTN","IBNCPDP2",14,0)
 I IBD("STATUS")="RELEASED" Q $$RELEASE^IBNCPDP4(DFN,.IBD)
"RTN","IBNCPDP2",15,0)
 I IBD("STATUS")="SUBMITTED" Q $$SUBMIT^IBNCPDP4(DFN,.IBD)
"RTN","IBNCPDP2",16,0)
 I IBD("STATUS")="REOPEN" Q $$REOPEN^IBNCPDP4(DFN,.IBD)
"RTN","IBNCPDP2",17,0)
 D LOG("UNKNOWN")
"RTN","IBNCPDP2",18,0)
 Q "0^Cannot determine ECME event status"
"RTN","IBNCPDP2",19,0)
 ;
"RTN","IBNCPDP2",20,0)
MATCH(BCID) ;
"RTN","IBNCPDP2",21,0)
 N IBX,IBHAVE
"RTN","IBNCPDP2",22,0)
 S IBX=0,IBHAVE=0 F  S IBX=$O(^DGCR(399,"AG",BCID,IBX)) Q:'IBX  S IBHAVE=1 I '$P($G(^DGCR(399,IBX,"S")),U,16) Q
"RTN","IBNCPDP2",23,0)
 I 'IBX,IBHAVE Q ""
"RTN","IBNCPDP2",24,0)
 Q +IBX
"RTN","IBNCPDP2",25,0)
 ;
"RTN","IBNCPDP2",26,0)
BILL(DFN,IBD) ; create bills
"RTN","IBNCPDP2",27,0)
 N IBDIV,IBAMT,IBY,IBSERV,IBFAC,IBSITE,IBDRX,IB,IBCDFN,IBINS,IBIDS,IBIFN,IBDFN,PRCASV,IBTRIC
"RTN","IBNCPDP2",28,0)
 N PRCAERR,IBADT,IBRXN,IBFIL,IBTRKRN,DIE,DA,DR,IBRES,IBLOCK,IBLDT,IBNOW,IBDUZ,RCDUZ,IBPREV,IBQUERY,IBPAID,IBACT,%,DGRVRCAL
"RTN","IBNCPDP2",29,0)
 ;
"RTN","IBNCPDP2",30,0)
 S IBDUZ=.5 ;POSTMASTER
"RTN","IBNCPDP2",31,0)
 ;I $G(IBD("FILLED BY")),$D(^VA(200,+IBD("FILLED BY"))) S IBDUZ=+IBD("FILLED BY")
"RTN","IBNCPDP2",32,0)
 S RCDUZ=IBDUZ
"RTN","IBNCPDP2",33,0)
 ;
"RTN","IBNCPDP2",34,0)
 S IBY=1,IBLOCK=0
"RTN","IBNCPDP2",35,0)
 I 'DFN S IBY="0^Missing DFN" G BILLQ
"RTN","IBNCPDP2",36,0)
 S IBAMT=+$G(IBD("BILLED")) ;FI portion of charge
"RTN","IBNCPDP2",37,0)
 I 'IBAMT S IBY="-1^Zero amount billed" G BILLQ
"RTN","IBNCPDP2",38,0)
 S IBADT=+$G(IBD("FILL DATE"),DT)
"RTN","IBNCPDP2",39,0)
 S IBRXN=+$G(IBD("PRESCRIPTION")) I 'IBRXN S IBY="0^Missing Rx IEN" G BILLQ
"RTN","IBNCPDP2",40,0)
 S IBFIL=+$G(IBD("FILL NUMBER"),-1) I IBFIL<0 S IBY="0^No fill number" G BILLQ
"RTN","IBNCPDP2",41,0)
 S IBDIV=+$G(IBD("DIVISION"))
"RTN","IBNCPDP2",42,0)
 I '$L($G(IBD("CLAIMID"))) S IBY="-1^Missing ECME Number" G BILLQ
"RTN","IBNCPDP2",43,0)
 S IBD("BCID")=(+IBD("CLAIMID"))_";"_IBADT ; The BCID#
"RTN","IBNCPDP2",44,0)
 L +^DGCR(399,"AG",IBD("BCID")):15 E  S IBY="0^Cannot lock ECME number." G BILLQ
"RTN","IBNCPDP2",45,0)
 ;
"RTN","IBNCPDP2",46,0)
 S IBTRIC=$$TRICARE^IBNCPDP6(IBRXN_";"_IBFIL)
"RTN","IBNCPDP2",47,0)
 ; do patient copay first (only applicable if Tricare)
"RTN","IBNCPDP2",48,0)
 I $G(IBD("COPAY")),IBTRIC D BILL^IBNCPDP6(IBRXN_";"_IBFIL,IBD("COPAY"))
"RTN","IBNCPDP2",49,0)
 I IBTRIC,'$G(IBD("PAID")) S IBY="1^Nothing paid in Tricare claim." G BILLQ
"RTN","IBNCPDP2",50,0)
 ;
"RTN","IBNCPDP2",51,0)
 S IBLOCK=1
"RTN","IBNCPDP2",52,0)
 S IBLDT=$G(^DGCR(399,"AG",IBD("BCID"))) ;Last time called
"RTN","IBNCPDP2",53,0)
 D NOW^%DTC S IBNOW=%
"RTN","IBNCPDP2",54,0)
 ; 2 calls in 45 sec
"RTN","IBNCPDP2",55,0)
 I $P(IBLDT,"^",2)="B" I $$FMDIFF^XLFDT(IBNOW,+IBLDT,2)<45 S IBY="0^Duplicate billing call" G BILLQ
"RTN","IBNCPDP2",56,0)
 ;
"RTN","IBNCPDP2",57,0)
 I $$MATCH(IBD("BCID")) D   ;cancel the previous bill
"RTN","IBNCPDP2",58,0)
 . N IBARR M IBARR=IBD I $$REVERSE^IBNCPDP3(DFN,.IBARR,2)
"RTN","IBNCPDP2",59,0)
 ;
"RTN","IBNCPDP2",60,0)
 ; derive minimal variables
"RTN","IBNCPDP2",61,0)
 I '$$CHECK^IBECEAU(0) S IBY="-1^IB SITE" G BILLQ
"RTN","IBNCPDP2",62,0)
 S IBSERV=$P($G(^IBE(350.1,1,0)),"^",4)
"RTN","IBNCPDP2",63,0)
 I '$$SERV^IBARX1(IBSERV) S IBY="-1^IB SERVICE" G BILLQ
"RTN","IBNCPDP2",64,0)
 I 'IBDIV S IBDIV=$P($$MCDIV^IBNCPEB(IBRXN,IBFIL),U,2)
"RTN","IBNCPDP2",65,0)
 I 'IBDIV S IBDIV=+$P($G(^SC(+$$FILE^IBRXUTL(IBRXN,5),0)),"^",15)
"RTN","IBNCPDP2",66,0)
 I 'IBDIV S IBDIV=+$P($G(^IBE(350.9,1,1)),U,25) ;dflt
"RTN","IBNCPDP2",67,0)
 I IBDIV S IBD("DIVISION")=IBDIV
"RTN","IBNCPDP2",68,0)
 ; - establish a stub claim/receivable
"RTN","IBNCPDP2",69,0)
 D SET^IBR I IBY<0 G BILLQ
"RTN","IBNCPDP2",70,0)
 ;
"RTN","IBNCPDP2",71,0)
 ; set up the following variables for claim establishment:
"RTN","IBNCPDP2",72,0)
 ; .01 BILL #
"RTN","IBNCPDP2",73,0)
 ; .17 ORIG CLAIM
"RTN","IBNCPDP2",74,0)
 ; .2  AUTO?
"RTN","IBNCPDP2",75,0)
 ; .02 DFN
"RTN","IBNCPDP2",76,0)
 ; .06 TIMEFRAME
"RTN","IBNCPDP2",77,0)
 ; .07 RATE TYPE
"RTN","IBNCPDP2",78,0)
 ; .18 SC AT TIME?
"RTN","IBNCPDP2",79,0)
 ; .04 LOCATION
"RTN","IBNCPDP2",80,0)
 ; .22 DIVISION
"RTN","IBNCPDP2",81,0)
 ; .05 BILL CLASSIF  (3)
"RTN","IBNCPDP2",82,0)
 ; .03 EVT DATE (FILL DATE)
"RTN","IBNCPDP2",83,0)
 ; 151 BILL FROM
"RTN","IBNCPDP2",84,0)
 ; 152 BILL TO
"RTN","IBNCPDP2",85,0)
 ; 101 PRIMARY INS CARRIER
"RTN","IBNCPDP2",86,0)
 K IB
"RTN","IBNCPDP2",87,0)
 S (IB(.02),IBDFN)=DFN
"RTN","IBNCPDP2",88,0)
 S IB(.07)=$$RT^IBNCPDP6(IBRXN_";"_IBFIL) ; previously determined rate type
"RTN","IBNCPDP2",89,0)
 I 'IB(.07) S IB(.07)=+$$RT^IBNCPDPU(DFN) ; cannot find previously, try to recompute
"RTN","IBNCPDP2",90,0)
 I 'IB(.07) S IBY="-1^IB RATE TYPE" G BILLQ
"RTN","IBNCPDP2",91,0)
 ;
"RTN","IBNCPDP2",92,0)
 S IBIFN=PRCASV("ARREC")
"RTN","IBNCPDP2",93,0)
 S IB(.01)=$P(PRCASV("ARBIL"),"-",2)
"RTN","IBNCPDP2",94,0)
 S IB(.17)=""
"RTN","IBNCPDP2",95,0)
 S IB(.2)=0
"RTN","IBNCPDP2",96,0)
 S IB(.06)=1
"RTN","IBNCPDP2",97,0)
 S IB(.18)=$$SC^IBCU3(DFN)
"RTN","IBNCPDP2",98,0)
 S IB(.04)=$S(+$P($G(^DG(40.8,+IBDIV,0)),U,3):7,1:1)
"RTN","IBNCPDP2",99,0)
 S:IBDIV IB(.22)=+IBDIV
"RTN","IBNCPDP2",100,0)
 S IB(.05)=3
"RTN","IBNCPDP2",101,0)
 S (IB(.03),IB(151),IB(152))=IBADT
"RTN","IBNCPDP2",102,0)
 S IBINS=$P($G(^IBA(355.3,+$G(IBD("PLAN")),0)),"^") I IBINS S IB(101)=IBINS
"RTN","IBNCPDP2",103,0)
 ;
"RTN","IBNCPDP2",104,0)
 ; set 362.4 node to rx#^p50^days sup^fill date^qty^ndc
"RTN","IBNCPDP2",105,0)
 S IB(362.4,IBRXN,1)=IBD("RX NO")_"^"_IBD("DRUG")_"^"_IBD("DAYS SUPPLY")_"^"_IBD("FILL DATE")_"^"_IBD("QTY")_"^"_IBD("NDC")
"RTN","IBNCPDP2",106,0)
 ;
"RTN","IBNCPDP2",107,0)
 ; call the autobiller module to create the claim with a default
"RTN","IBNCPDP2",108,0)
 ; diagnosis and procedure for prescriptions
"RTN","IBNCPDP2",109,0)
 D EN^IBCD3(.IBQUERY)
"RTN","IBNCPDP2",110,0)
 D CLOSE^IBSDU(.IBQUERY)
"RTN","IBNCPDP2",111,0)
 ;
"RTN","IBNCPDP2",112,0)
 S ^DGCR(399,"AG",IBD("BCID"))=IBNOW_"^B"
"RTN","IBNCPDP2",113,0)
 S DIE="^DGCR(399,",DA=IBIFN
"RTN","IBNCPDP2",114,0)
 ; update the ECME fields
"RTN","IBNCPDP2",115,0)
 S DR="460////^S X=IBD(""BCID"")" S:$L($G(IBD("AUTH #"))) DR=DR_";461////^S X=IBD(""AUTH #"")"
"RTN","IBNCPDP2",116,0)
 D ^DIE K DA,DR,DIE
"RTN","IBNCPDP2",117,0)
 D SETCT ; Set Claims Tracking record
"RTN","IBNCPDP2",118,0)
 ;
"RTN","IBNCPDP2",119,0)
 ; IEN to 2.3121
"RTN","IBNCPDP2",120,0)
 S IBCDFN=$$PLANN^IBNCPDPU(DFN,IBD("PLAN"),IBADT)
"RTN","IBNCPDP2",121,0)
 I 'IBCDFN S IBY="-1^Plan not found in Patient's Profile." G BILLQ
"RTN","IBNCPDP2",122,0)
 ;
"RTN","IBNCPDP2",123,0)
 ; add the payer (fiscal intermediary) to the claim
"RTN","IBNCPDP2",124,0)
 S IBINS=+IBCDFN,IBCDFN=$P(IBCDFN,"^",2)
"RTN","IBNCPDP2",125,0)
 S DIE="^DGCR(399,",DA=IBIFN,DR="112////"_IBCDFN
"RTN","IBNCPDP2",126,0)
 D ^DIE K DA,DR,DIE,DGRVRCAL
"RTN","IBNCPDP2",127,0)
 ;
"RTN","IBNCPDP2",128,0)
 ; need to make sure we have computed charges.
"RTN","IBNCPDP2",129,0)
 Q:'$$CHARGES(IBIFN,IBINS,+IB(.07),$G(IBD("PAID")),IBDIV,IBTRIC,.IBY)
"RTN","IBNCPDP2",130,0)
 ;
"RTN","IBNCPDP2",131,0)
 ; update the authorize/print fields
"RTN","IBNCPDP2",132,0)
 S DIE="^DGCR(399,",DA=IBIFN
"RTN","IBNCPDP2",133,0)
 S DR="9////1;12////"_DT D ^DIE
"RTN","IBNCPDP2",134,0)
 K DA,DR,DIE
"RTN","IBNCPDP2",135,0)
 ;
"RTN","IBNCPDP2",136,0)
 ; pass the claim to AR
"RTN","IBNCPDP2",137,0)
 D GVAR^IBCBB,ARRAY^IBCBB1 S PRCASV("APR")=IBDUZ D ^PRCASVC6
"RTN","IBNCPDP2",138,0)
 I 'PRCASV("OKAY") S IBY="-1^Cannot establish receivable in AR." G BILLQ
"RTN","IBNCPDP2",139,0)
 D REL^PRCASVC
"RTN","IBNCPDP2",140,0)
 ;
"RTN","IBNCPDP2",141,0)
 ; update the AR status to Active
"RTN","IBNCPDP2",142,0)
 ;  D AUDITX^PRCAUDT(PRCASV("ARREC"))
"RTN","IBNCPDP2",143,0)
 S PRCASV("STATUS")=16
"RTN","IBNCPDP2",144,0)
 D STATUS^PRCASVC1
"RTN","IBNCPDP2",145,0)
 ;
"RTN","IBNCPDP2",146,0)
 ; decrease adjust bill
"RTN","IBNCPDP2",147,0)
 ; Auto decrease from service Bill#,Tran amt,person,reason,Tran date
"RTN","IBNCPDP2",148,0)
 S IBAMT=$G(^DGCR(399,IBIFN,"U1"))
"RTN","IBNCPDP2",149,0)
 S IBPAID=$G(IBD("PAID"))
"RTN","IBNCPDP2",150,0)
 I IBAMT-IBPAID>.01,'IBTRIC D
"RTN","IBNCPDP2",151,0)
 . D DEC^PRCASER1(PRCASV("ARREC"),IBAMT-IBPAID,IBDUZ,"Adjust based on ECME amount paid.",IBADT)
"RTN","IBNCPDP2",152,0)
 . I 'IBPAID S PRCASV("STATUS")=22 D STATUS^PRCASVC1 ; collected/closed
"RTN","IBNCPDP2",153,0)
 ;
"RTN","IBNCPDP2",154,0)
 D  ; set the user in 399
"RTN","IBNCPDP2",155,0)
 . N IBI,IBT F IBI=2,5,11,13,15 S IBT(399,IBIFN_",",IBI)=IBDUZ
"RTN","IBNCPDP2",156,0)
 . D FILE^DIE("","IBT")
"RTN","IBNCPDP2",157,0)
 ;
"RTN","IBNCPDP2",158,0)
BILLQ S IBRES=$S(IBY<0:"0^"_$S($L($P(IBY,"^",2)):$P(IBY,"^",2),1:$P(IBY,"^",3)),$G(IBIFN):+IBIFN,1:IBY)
"RTN","IBNCPDP2",159,0)
 I $G(IBIFN) S IBD("BILL")=IBIFN
"RTN","IBNCPDP2",160,0)
 D LOG("BILL",IBRES)
"RTN","IBNCPDP2",161,0)
 I IBY<0 D BULL^IBNCPEB($G(DFN),.IBD,IBRES,$G(IBIFN))
"RTN","IBNCPDP2",162,0)
 I IBLOCK L -^DGCR(399,"AG",IBD("BCID"))
"RTN","IBNCPDP2",163,0)
 Q IBRES
"RTN","IBNCPDP2",164,0)
 ;
"RTN","IBNCPDP2",165,0)
SETCT ; update claims tracking saying bill has been billed
"RTN","IBNCPDP2",166,0)
 S IBTRKRN=+$O(^IBT(356,"ARXFL",IBRXN,IBFIL,0))
"RTN","IBNCPDP2",167,0)
 I IBTRKRN S DIE="^IBT(356,",DA=IBTRKRN,DR=".11////^S X=IBIFN;.17///@" D ^DIE
"RTN","IBNCPDP2",168,0)
 I IBTRKRN,IBIFN D CTB^IBCDC(IBTRKRN,IBIFN)
"RTN","IBNCPDP2",169,0)
 Q
"RTN","IBNCPDP2",170,0)
 ;
"RTN","IBNCPDP2",171,0)
LOG(PROC,RESULT) ;Store the data
"RTN","IBNCPDP2",172,0)
 ;Log values passed into IB by outside applications
"RTN","IBNCPDP2",173,0)
 ;
"RTN","IBNCPDP2",174,0)
 ;implicit input variables/arrays :
"RTN","IBNCPDP2",175,0)
 ; IBD array with values sent to IB (see calling subroutines)
"RTN","IBNCPDP2",176,0)
 ; DFN - patient's IEN (file #2)
"RTN","IBNCPDP2",177,0)
 ; DUZ - user's IEN(file #200)
"RTN","IBNCPDP2",178,0)
 ;explicit parameters:
"RTN","IBNCPDP2",179,0)
 ; PROC - type of event as string, i.e. BILL, REJECT and so on
"RTN","IBNCPDP2",180,0)
 ; RESULT - result of the event processing, format: return_code^message
"RTN","IBNCPDP2",181,0)
 ;
"RTN","IBNCPDP2",182,0)
 D LOG^IBNCPLOG(.IBD,DFN,PROC,RESULT,$J,$$NOW^XLFDT(),+DUZ)
"RTN","IBNCPDP2",183,0)
 Q
"RTN","IBNCPDP2",184,0)
 ;
"RTN","IBNCPDP2",185,0)
EPHARM(IBRX,IBREFILL) ;
"RTN","IBNCPDP2",186,0)
 ;returns ien of #9002313.56 BPS PHARMACIES associated
"RTN","IBNCPDP2",187,0)
 ;with the prescription specified by:
"RTN","IBNCPDP2",188,0)
 ; IBRX - IEN in file #52
"RTN","IBNCPDP2",189,0)
 ; IBREFILL - zero(0) for the original prescription or the refill
"RTN","IBNCPDP2",190,0)
 ;    number for a refill (IEN of REFILL multiple #52.1)
"RTN","IBNCPDP2",191,0)
 I +$G(IBRX)=0 Q ""
"RTN","IBNCPDP2",192,0)
 I $G(IBREFILL)="" Q ""
"RTN","IBNCPDP2",193,0)
 N IBDIV59
"RTN","IBNCPDP2",194,0)
 S IBDIV59=+$$RXSITE^PSOBPSUT(+IBRX,+IBREFILL)
"RTN","IBNCPDP2",195,0)
 I IBDIV59>0 Q $$GETPHARM^BPSUTIL(IBDIV59)
"RTN","IBNCPDP2",196,0)
 Q ""
"RTN","IBNCPDP2",197,0)
 ;
"RTN","IBNCPDP2",198,0)
CHARGES(IBIFN,IBINS,IBRT,IBAMT,IBDIV,IBTRIC,IBY) ;
"RTN","IBNCPDP2",199,0)
 ; will add charges onto bill based on rate type
"RTN","IBNCPDP2",200,0)
 ;
"RTN","IBNCPDP2",201,0)
 ; Input:  IBIFN = Bill (399) ien
"RTN","IBNCPDP2",202,0)
 ;         IBINS = Insurance Co (36) ien
"RTN","IBNCPDP2",203,0)
 ;         IBRT = Rate Type (399.3) ien
"RTN","IBNCPDP2",204,0)
 ; Output: 1 = Ok all done
"RTN","IBNCPDP2",205,0)
 ;         0 = not ok, bill doesn't have charges
"RTN","IBNCPDP2",206,0)
 ;
"RTN","IBNCPDP2",207,0)
 N IBCSZ,IBRVCD,IBBS,IBUNITS,IBCPT,IBAA,IBTYPE,IBITEM,X
"RTN","IBNCPDP2",208,0)
 ;
"RTN","IBNCPDP2",209,0)
 I 'IBTRIC D BILL^IBCRBC(IBIFN) Q 1
"RTN","IBNCPDP2",210,0)
 ;
"RTN","IBNCPDP2",211,0)
 ; - manually add charge to the claim (based on cost for Tricare)
"RTN","IBNCPDP2",212,0)
 S IBRVCD=$P($G(^DIC(36,IBINS,0)),"^",15) ;                   rx refill rev code
"RTN","IBNCPDP2",213,0)
 S IBCSZ=$G(^IBE(363.1,+$O(^IBE(363.1,"B","RX COST",0)),0)) ; using cost CS
"RTN","IBNCPDP2",214,0)
 I IBRVCD="" S IBRVCD=$P(IBCSZ,U,5) ;                         CS def rev code
"RTN","IBNCPDP2",215,0)
 I IBRVCD="" S X=250 ;                                        gen'l rx rev code
"RTN","IBNCPDP2",216,0)
 ;
"RTN","IBNCPDP2",217,0)
 S IBBS=$P(IBCSZ,U,6) ;                                       CS def bedsection
"RTN","IBNCPDP2",218,0)
 S IBUNITS=1 ;                                                one unit
"RTN","IBNCPDP2",219,0)
 S IBCPT=$P($G(^IBE(350.9,1,1)),"^",30) ;                     def rx refill cpt
"RTN","IBNCPDP2",220,0)
 S IBAA=0 ;                                                   not auto calc charges
"RTN","IBNCPDP2",221,0)
 S IBTYPE=3 ;                                                 rx type
"RTN","IBNCPDP2",222,0)
 S IBITEM="" ;                                                charge item link
"RTN","IBNCPDP2",223,0)
 ;
"RTN","IBNCPDP2",224,0)
 S X=$$ADDRC^IBCRBF(IBIFN,IBRVCD,IBBS,IBAMT,IBUNITS,IBCPT,IBDIV,IBAA,IBTYPE,IBITEM)
"RTN","IBNCPDP2",225,0)
 I X<0 S IBY="-1^^Unable to add Revenue Code charge to claim." Q 0
"RTN","IBNCPDP2",226,0)
 Q 1
"RTN","IBNCPDP2",227,0)
 ;
"RTN","IBNCPDP3")
0^5^B30635379^B29885103
"RTN","IBNCPDP3",1,0)
IBNCPDP3 ;OAK/ELZ - STORES NDC/AWP UPDATES ;11/14/07  13:18
"RTN","IBNCPDP3",2,0)
 ;;2.0;INTEGRATED BILLING;**223,276,342,363,383**;21-MAR-94;Build 11
"RTN","IBNCPDP3",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBNCPDP3",4,0)
 ;
"RTN","IBNCPDP3",5,0)
 ;
"RTN","IBNCPDP3",6,0)
UPAWP(IBNDC,IBAWP,IBADT) ; updates AWP prices for NDCs
"RTN","IBNCPDP3",7,0)
 ;
"RTN","IBNCPDP3",8,0)
 N IBITEM,IBCS
"RTN","IBNCPDP3",9,0)
 ;
"RTN","IBNCPDP3",10,0)
 ;
"RTN","IBNCPDP3",11,0)
 S IBCS=$P($G(^IBE(350.9,1,9)),"^",12)
"RTN","IBNCPDP3",12,0)
 I 'IBCS Q "0^Unable to find Charge Set"
"RTN","IBNCPDP3",13,0)
 ;
"RTN","IBNCPDP3",14,0)
 S IBNDC=$$NDC^IBNCPDPU(IBNDC)
"RTN","IBNCPDP3",15,0)
 ;
"RTN","IBNCPDP3",16,0)
 S IBITEM=+$$ADDBI^IBCREF("NDC",IBNDC) I IBITEM Q "0^Unable to add item"
"RTN","IBNCPDP3",17,0)
 ;
"RTN","IBNCPDP3",18,0)
 I '$$ADDCI^IBCREF(IBCS,IBITEM,IBADT,IBAWP) Q "0^Unable to add charge"
"RTN","IBNCPDP3",19,0)
 ;
"RTN","IBNCPDP3",20,0)
 Q 1
"RTN","IBNCPDP3",21,0)
 ;
"RTN","IBNCPDP3",22,0)
 ;
"RTN","IBNCPDP3",23,0)
 ;
"RTN","IBNCPDP3",24,0)
 ;
"RTN","IBNCPDP3",25,0)
REVERSE(DFN,IBD,IBAUTO) ;process reversed claims
"RTN","IBNCPDP3",26,0)
 N IBIFN,I,IB,IBIL,IBCHG,IBCRES,IBY,X,Y,DA,DIE,DR,IBADT,IBLOCK,IBLDT
"RTN","IBNCPDP3",27,0)
 N IBNOW,IBDUZ,IBCR,IBRELC,IBCC,IBPAP,IBRXN,IBFIL,IBRTS,IBARES,IBUSR
"RTN","IBNCPDP3",28,0)
 S IBDUZ=.5
"RTN","IBNCPDP3",29,0)
 S IBLOCK=0
"RTN","IBNCPDP3",30,0)
 ; find bill number
"RTN","IBNCPDP3",31,0)
 I 'DFN S IBY="0^No patient" G REVQ
"RTN","IBNCPDP3",32,0)
 I '$L($G(IBD("CLAIMID"))) S IBY="0^Missing ECME Number" G REVQ
"RTN","IBNCPDP3",33,0)
 S IBADT=+$G(IBD("FILL DATE")) I 'IBADT S IBY="0^Missing Fill Date" G REVQ
"RTN","IBNCPDP3",34,0)
 S IBRXN=+$G(IBD("PRESCRIPTION")) I 'IBRXN S IBY="0^No Rx IEN" G REVQ
"RTN","IBNCPDP3",35,0)
 S IBFIL=+$G(IBD("FILL NUMBER"),-1) I IBFIL<0 S IBY="0^No fill number" G REVQ
"RTN","IBNCPDP3",36,0)
 I $E($G(IBD("RESPONSE")),1)="R" D  G REVQ:+'$G(IBRTS)
"RTN","IBNCPDP3",37,0)
 . S IBY="0^REVERSAL rejected by payer"
"RTN","IBNCPDP3",38,0)
 . S IBRTS=$$RTS(IBD("REVERSAL REASON"))
"RTN","IBNCPDP3",39,0)
 ;
"RTN","IBNCPDP3",40,0)
 D CANC^IBNCPDP6(IBRXN_";"_IBFIL) ; cancel 1st party charge for Tricare
"RTN","IBNCPDP3",41,0)
 ;
"RTN","IBNCPDP3",42,0)
 S IBD("BCID")=(+IBD("CLAIMID"))_";"_IBADT ; BC ID Number
"RTN","IBNCPDP3",43,0)
 L +^DGCR(399,"AG",IBD("BCID")):15 E  S IBY="0^Cannot lock ECME number" G REVQ
"RTN","IBNCPDP3",44,0)
 S IBLOCK=1
"RTN","IBNCPDP3",45,0)
 S IBUSR=$S(+$G(IBD("USER"))=0:DUZ,1:IBD("USER"))
"RTN","IBNCPDP3",46,0)
 I $D(^DGCR(399,"AG",IBD("BCID"))) S ^(IBD("BCID"))=""
"RTN","IBNCPDP3",47,0)
 S IBIFN=$$MATCH^IBNCPDP2(IBD("BCID"))
"RTN","IBNCPDP3",48,0)
 I $D(IBD("CLOSE REASON")),'$D(IBD("DROP TO PAPER")) S IBD("DROP TO PAPER")=""
"RTN","IBNCPDP3",49,0)
 S IBCR=+$G(IBD("CLOSE REASON"))
"RTN","IBNCPDP3",50,0)
 S IBPAP=$G(IBD("DROP TO PAPER"))
"RTN","IBNCPDP3",51,0)
 S IBRELC=$G(IBD("RELEASE COPAY"))
"RTN","IBNCPDP3",52,0)
 S IBCC=$G(IBD("CLOSE COMMENT"))
"RTN","IBNCPDP3",53,0)
 D NONBR^IBNCPNB(DFN,IBRXN,IBFIL,IBADT,IBCR,IBPAP,IBRELC,IBCC,IBUSR)
"RTN","IBNCPDP3",54,0)
 I 'IBIFN S IBY="0^"_$S(IBPAP:"Dropped to paper",IBCR>1:"Set non-billable reason in CT",1:"Cannot find the bill to reverse") G REVQ
"RTN","IBNCPDP3",55,0)
 ;
"RTN","IBNCPDP3",56,0)
 F I=0,"S" S IB(I)=$G(^DGCR(399,IBIFN,I))
"RTN","IBNCPDP3",57,0)
 I IB(0)="" S IBY="0^No data in bill" G REVQ
"RTN","IBNCPDP3",58,0)
 I +$P(IB("S"),U,16),$P(IB("S"),U,17)]"" S IBY="0^Bill already cancelled" G REVQ
"RTN","IBNCPDP3",59,0)
 ;
"RTN","IBNCPDP3",60,0)
 S:'$D(IBCRES) IBCRES="ECME PRESCRIPTION REVERSED"
"RTN","IBNCPDP3",61,0)
 S DA=IBIFN,DR="16////1;19////"_IBCRES,DIE="^DGCR(399,"
"RTN","IBNCPDP3",62,0)
 D ^DIE K DA,DIE,DR
"RTN","IBNCPDP3",63,0)
 ;
"RTN","IBNCPDP3",64,0)
 ; - decrease out the receivable in AR
"RTN","IBNCPDP3",65,0)
 S IB("U1")=$G(^DGCR(399,IBIFN,"U1"))
"RTN","IBNCPDP3",66,0)
 S IBIL=$P($G(^PRCA(430,IBIFN,0)),"^")
"RTN","IBNCPDP3",67,0)
 S IBCHG=$S(IB("U1")']"":0,$P(IB("U1"),"^",1)]"":$P(IB("U1"),"^",1),1:0)
"RTN","IBNCPDP3",68,0)
 ;
"RTN","IBNCPDP3",69,0)
 S X="21^"_IBCHG_"^"_IBIL_"^"_IBDUZ_"^"_DT_"^"_IBCRES
"RTN","IBNCPDP3",70,0)
 D ^PRCASER1
"RTN","IBNCPDP3",71,0)
 S IBARES=Y
"RTN","IBNCPDP3",72,0)
 I IBARES<0 S IBY=IBARES D BULL
"RTN","IBNCPDP3",73,0)
 ;
"RTN","IBNCPDP3",74,0)
 S IBY=$S(IBARES<0:"0^"_$P(IBARES,"^",2),1:1)
"RTN","IBNCPDP3",75,0)
 ;
"RTN","IBNCPDP3",76,0)
 I IBDUZ'=DUZ D  ; set the real user
"RTN","IBNCPDP3",77,0)
 . N IBI,IBT S IBI=18,IBT(399,IBIFN_",",IBI)=IBDUZ D FILE^DIE("","IBT")
"RTN","IBNCPDP3",78,0)
 ;
"RTN","IBNCPDP3",79,0)
REVQ ; perform end of job tasks
"RTN","IBNCPDP3",80,0)
 D LOG^IBNCPDP2($S($G(IBAUTO)=1:"AUTO REVERSE",$G(IBAUTO)=2:"BILL CANCELLED",1:"REVERSE"),IBY)
"RTN","IBNCPDP3",81,0)
 I IBLOCK L -^DGCR(399,"AG",IBD("BCID"))
"RTN","IBNCPDP3",82,0)
 I IBY=1,$G(IBIFN) S IBY=+IBIFN
"RTN","IBNCPDP3",83,0)
 Q IBY
"RTN","IBNCPDP3",84,0)
 ;
"RTN","IBNCPDP3",85,0)
RTS(IBRR) ; Return to Stock processing on Released Rx
"RTN","IBNCPDP3",86,0)
 ; input - IBRR = reversal reason
"RTN","IBNCPDP3",87,0)
 ;         IBCRSN = passed in by reference
"RTN","IBNCPDP3",88,0)
 ; output - 0 = reversal not due to a Rx RETURN TO STOCK or Rx DELETE
"RTN","IBNCPDP3",89,0)
 ;          1 = reversal due to a Rx RETURN TO STOCK or Rx DELETE
"RTN","IBNCPDP3",90,0)
 ;          IBCRSN = charge removal reason
"RTN","IBNCPDP3",91,0)
 N IBTRKRN,IBLOCK2,IBCMT,DA,DIE,DR
"RTN","IBNCPDP3",92,0)
 ;
"RTN","IBNCPDP3",93,0)
 I IBRR'="RX RETURNED TO STOCK"&(IBRR'="RX DELETED") Q 0
"RTN","IBNCPDP3",94,0)
 S IBTRKRN=+$O(^IBT(356,"ARXFL",IBRXN,IBFIL,0))
"RTN","IBNCPDP3",95,0)
 I 'IBTRKRN Q 0  ; CT record does not exist
"RTN","IBNCPDP3",96,0)
 I '$P($G(^IBT(356,IBTRKRN,0)),U,11) Q 0  ; BILL does not exist
"RTN","IBNCPDP3",97,0)
 S IBCRES=$$GETRSN(DFN,IBRXN,IBFIL)  ; recorded in file 399 entry
"RTN","IBNCPDP3",98,0)
 L +^IBT(356,IBTRKRN):5 S IBLOCK2=$T
"RTN","IBNCPDP3",99,0)
 S DIE="^IBT(356,",DA=IBTRKRN,IBCMT="Rx RTS - May Need Refund"
"RTN","IBNCPDP3",100,0)
 S DR="1.08////"_IBCMT
"RTN","IBNCPDP3",101,0)
 D ^DIE
"RTN","IBNCPDP3",102,0)
 I IBLOCK2 L -^IBT(356,IBTRKRN)
"RTN","IBNCPDP3",103,0)
 Q 1
"RTN","IBNCPDP3",104,0)
 ;
"RTN","IBNCPDP3",105,0)
BULL ; Generate a bulletin if there is an error in cancelling the claim.
"RTN","IBNCPDP3",106,0)
 N IBC,IBT,IBPT,IBGRP,XMDUZ,XMTEXT,XMSUB,XMY
"RTN","IBNCPDP3",107,0)
 ;
"RTN","IBNCPDP3",108,0)
 S IBPT=$$PT^IBEFUNC(DFN)
"RTN","IBNCPDP3",109,0)
 S XMSUB=$E($P(IBPT,"^"),1,14)_"  "_$P(IBPT,"^",3)_" - ERROR ENCOUNTERED"
"RTN","IBNCPDP3",110,0)
 S XMDUZ="INTEGRATED BILLING PACKAGE",XMTEXT="IBT("
"RTN","IBNCPDP3",111,0)
 S XMY(IBDUZ)=""
"RTN","IBNCPDP3",112,0)
 S XMY("G.IBCNR EPHARM")=""
"RTN","IBNCPDP3",113,0)
 ;
"RTN","IBNCPDP3",114,0)
 S IBT(1)="An error occurred while cancelling the Pharmacy claim from ECME"
"RTN","IBNCPDP3",115,0)
 S IBT(2)="fiscal intermediary for the following patient:"
"RTN","IBNCPDP3",116,0)
 S IBT(3)=" " S IBC=3
"RTN","IBNCPDP3",117,0)
 D PAT^IBAERR1 ; Accepts IBDUZ
"RTN","IBNCPDP3",118,0)
 S IBC=IBC+1,IBT(IBC)="   Bill #: "_IBIL
"RTN","IBNCPDP3",119,0)
 S IBC=IBC+1,IBT(IBC)=" "
"RTN","IBNCPDP3",120,0)
 S IBC=IBC+1,IBT(IBC)="The following error was encountered:"
"RTN","IBNCPDP3",121,0)
 S IBC=IBC+1,IBT(IBC)=" "
"RTN","IBNCPDP3",122,0)
 D ERR^IBAERR1
"RTN","IBNCPDP3",123,0)
 S IBC=IBC+1,IBT(IBC)=" "
"RTN","IBNCPDP3",124,0)
 S IBC=IBC+1,IBT(IBC)="Please review the circumstances surrounding this error and decrease"
"RTN","IBNCPDP3",125,0)
 S IBC=IBC+1,IBT(IBC)="out this receivable in Accounts Receivable if necessary."
"RTN","IBNCPDP3",126,0)
 D ^XMD
"RTN","IBNCPDP3",127,0)
 Q
"RTN","IBNCPDP3",128,0)
 ;
"RTN","IBNCPDP3",129,0)
GETRSN(DFN,IBRXN,IBFIL) ;
"RTN","IBNCPDP3",130,0)
 ; retrieve charge removal reason from file 354.71
"RTN","IBNCPDP3",131,0)
 ; input - DFN,IBRXN=Rx ien,IBFIL=fill number
"RTN","IBNCPDP3",132,0)
 ; output - charge removal reason
"RTN","IBNCPDP3",133,0)
 N IBDT,IBDA,IBXRSN,IBRXFIL,IB0
"RTN","IBNCPDP3",134,0)
 S (IBDT,IBDA)=0,IBXRSN=""
"RTN","IBNCPDP3",135,0)
 S IBRXFIL=$S('IBFIL:IBRXN,1:IBRXN_";"_IBFIL)
"RTN","IBNCPDP3",136,0)
 F  S IBDT=$O(^IBAM(354.71,"AD",DFN,IBDT)) Q:'IBDT  Q:IBXRSN]""  D
"RTN","IBNCPDP3",137,0)
 . F  S IBDA=$O(^IBAM(354.71,"AD",DFN,IBDT,IBDA)) Q:'IBDA  Q:IBXRSN]""  D
"RTN","IBNCPDP3",138,0)
 . . S IB0=^IBAM(354.71,IBDA,0)
"RTN","IBNCPDP3",139,0)
 . . Q:$P(IB0,"^",6)'[IBRXFIL
"RTN","IBNCPDP3",140,0)
 . . S IBXRSN=$$GET1^DIQ(354.71,IBDA_",",.19)
"RTN","IBNCPDP3",141,0)
 S:IBXRSN']"" IBXRSN="CHARGE REMOVAL REASON NOT FOUND"
"RTN","IBNCPDP3",142,0)
 Q "Reversal Rej, no pymt due<>"_IBXRSN
"RTN","IBNCPDP3",143,0)
 ;
"RTN","IBNCPDP3",144,0)
 ;IBNCPDP3
"RTN","IBNCPDP6")
0^6^B11789689^n/a
"RTN","IBNCPDP6",1,0)
IBNCPDP6 ;OAK/ELZ - TRICARE NCPDP TOOLS; 02-AUG-96 ;10/18/07  13:40
"RTN","IBNCPDP6",2,0)
 ;;2.0;INTEGRATED BILLING;**383**;21-MAR-94;Build 11
"RTN","IBNCPDP6",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBNCPDP6",4,0)
 ;
"RTN","IBNCPDP6",5,0)
START(IBKEY,IBELIG,IBRT) ; initial storage done during
"RTN","IBNCPDP6",6,0)
 ; billing determination check (updates allowed)
"RTN","IBNCPDP6",7,0)
 ;  Input:    IBKEY  --  1 ; 2, where
"RTN","IBNCPDP6",8,0)
 ;                         1 = Pointer to the prescription in file #52
"RTN","IBNCPDP6",9,0)
 ;                         2 = Pointer to the refill in file #52.1, or
"RTN","IBNCPDP6",10,0)
 ;                             0 for the original fill
"RTN","IBNCPDP6",11,0)
 ;            IBELIG --  single character indicating elig indicator
"RTN","IBNCPDP6",12,0)
 ;                         V = Veteran
"RTN","IBNCPDP6",13,0)
 ;                         T = Tricare
"RTN","IBNCPDP6",14,0)
 ;            IBRT   --  Rate type pointer to be used for the bill later
"RTN","IBNCPDP6",15,0)
 ;
"RTN","IBNCPDP6",16,0)
 N IBCHTRN,DO,DIC,X,Y,DIE,DA,DR
"RTN","IBNCPDP6",17,0)
 S IBCHTRN=$O(^IBCNR(366.15,"B",IBKEY,0))
"RTN","IBNCPDP6",18,0)
 I 'IBCHTRN D
"RTN","IBNCPDP6",19,0)
 . S DIC="^IBCNR(366.15,",DIC(0)="",X=IBKEY D FILE^DICN
"RTN","IBNCPDP6",20,0)
 . S IBCHTRN=+Y
"RTN","IBNCPDP6",21,0)
 S DIE="^IBCNR(366.15,",DA=IBCHTRN,DR=".02////^S X=IBELIG;.03////^S X=IBRT"
"RTN","IBNCPDP6",22,0)
 D ^DIE
"RTN","IBNCPDP6",23,0)
 Q
"RTN","IBNCPDP6",24,0)
 ;
"RTN","IBNCPDP6",25,0)
BILL(IBKEY,IBCHG) ; Create the TRICARE Rx copay charge.
"RTN","IBNCPDP6",26,0)
 ;  Input:    IBKEY  --  1 ; 2, where
"RTN","IBNCPDP6",27,0)
 ;                         1 = Pointer to the prescription in file #52
"RTN","IBNCPDP6",28,0)
 ;                         2 = Pointer to the refill in file #52.1, or
"RTN","IBNCPDP6",29,0)
 ;                             0 for the original fill
"RTN","IBNCPDP6",30,0)
 ;            IBCHG  --  charge amount
"RTN","IBNCPDP6",31,0)
 ;
"RTN","IBNCPDP6",32,0)
 N IBCHTRN,IBY,IBATYP,IBSERV,IBDESC,IBUNIT,IBSL,IBFR,DA,DIE,DR,DFN,IBN,IBZ
"RTN","IBNCPDP6",33,0)
 ;
"RTN","IBNCPDP6",34,0)
 S IBY=1
"RTN","IBNCPDP6",35,0)
 I '$G(IBKEY) G BILLQ
"RTN","IBNCPDP6",36,0)
 S IBCHTRN=$O(^IBCNR(366.15,"B",IBKEY,0))
"RTN","IBNCPDP6",37,0)
 I 'IBCHTRN G BILLQ
"RTN","IBNCPDP6",38,0)
 S IBZ=$G(^IBCNR(366.15,IBCHTRN,0))
"RTN","IBNCPDP6",39,0)
 ;
"RTN","IBNCPDP6",40,0)
 ; - Tricare?
"RTN","IBNCPDP6",41,0)
 I $P(IBZ,"^",2)'="T" G BILLQ
"RTN","IBNCPDP6",42,0)
 ;
"RTN","IBNCPDP6",43,0)
 ; - already billed, need to cancel to bill
"RTN","IBNCPDP6",44,0)
 I $P(IBZ,"^",4) D CANC(IBKEY)
"RTN","IBNCPDP6",45,0)
 ;
"RTN","IBNCPDP6",46,0)
 I $$FILE^IBRXUTL(+IBKEY,.01)="" G BILLQ
"RTN","IBNCPDP6",47,0)
 ;
"RTN","IBNCPDP6",48,0)
 ; - need patient
"RTN","IBNCPDP6",49,0)
 S DFN=$$FILE^IBRXUTL(+IBKEY,2)
"RTN","IBNCPDP6",50,0)
 I 'DFN S IBY="-1^IB002" G BILLQ
"RTN","IBNCPDP6",51,0)
 ;
"RTN","IBNCPDP6",52,0)
 ; - need action type
"RTN","IBNCPDP6",53,0)
 S IBATYP=$O(^IBE(350.1,"E","TRICARE RX COPAY",0))
"RTN","IBNCPDP6",54,0)
 I 'IBATYP S IBY="-1^IB008" G BILLQ
"RTN","IBNCPDP6",55,0)
 ;
"RTN","IBNCPDP6",56,0)
 ; - need facility number
"RTN","IBNCPDP6",57,0)
 I '$$CHECK^IBECEAU(0) S IBY="-1^IB009" G BILLQ
"RTN","IBNCPDP6",58,0)
 ;
"RTN","IBNCPDP6",59,0)
 ; - need the Pharmacy service pointer; get from #350.1 and check it
"RTN","IBNCPDP6",60,0)
 S IBSERV=$P($G(^IBE(350.1,1,0)),"^",4)
"RTN","IBNCPDP6",61,0)
 I '$$SERV^IBARX1(IBSERV) S IBY="-1^IB003" G BILLQ
"RTN","IBNCPDP6",62,0)
 ;
"RTN","IBNCPDP6",63,0)
 ; - need a charge amount
"RTN","IBNCPDP6",64,0)
 S IBCHG=+$G(IBCHG)
"RTN","IBNCPDP6",65,0)
 I 'IBCHG S IBY="-1^IB029" G BILLQ
"RTN","IBNCPDP6",66,0)
 ;
"RTN","IBNCPDP6",67,0)
 ; - set remaining variables
"RTN","IBNCPDP6",68,0)
 S IBDESC="TRICARE RX COPAY",IBUNIT=1
"RTN","IBNCPDP6",69,0)
 S IBSL="52:"_+IBKEY S:$P(IBKEY,";",2) IBSL=IBSL_";1:"_$P(IBKEY,";",2)
"RTN","IBNCPDP6",70,0)
 S IBFR=DT
"RTN","IBNCPDP6",71,0)
 ;
"RTN","IBNCPDP6",72,0)
 ; - add the charge to file #350
"RTN","IBNCPDP6",73,0)
 D ADD^IBECEAU3 I IBY<0 G BILLQ
"RTN","IBNCPDP6",74,0)
 ;
"RTN","IBNCPDP6",75,0)
 ; - release the charge to AR
"RTN","IBNCPDP6",76,0)
 D AR^IBR
"RTN","IBNCPDP6",77,0)
 ;
"RTN","IBNCPDP6",78,0)
 ; - update the rx file (#366.15)
"RTN","IBNCPDP6",79,0)
 S DA=IBCHTRN,DIE="^IBCNR(366.15,",DR=".04////"_IBN D ^DIE K DA,DIE,DR
"RTN","IBNCPDP6",80,0)
 ;
"RTN","IBNCPDP6",81,0)
BILLQ ;
"RTN","IBNCPDP6",82,0)
 I IBY<0 D ERRMSG^IBACVA2(1,2)
"RTN","IBNCPDP6",83,0)
 ;
"RTN","IBNCPDP6",84,0)
 Q
"RTN","IBNCPDP6",85,0)
 ;
"RTN","IBNCPDP6",86,0)
 ;
"RTN","IBNCPDP6",87,0)
CANC(IBKEY) ; Cancel the TRICARE Rx copay charge.
"RTN","IBNCPDP6",88,0)
 ;  Input:    IBKEY  --  1 ; 2, where
"RTN","IBNCPDP6",89,0)
 ;                         1 = Pointer to the prescription in file #52
"RTN","IBNCPDP6",90,0)
 ;                         2 = Pointer to the refill in file #52.1, or
"RTN","IBNCPDP6",91,0)
 ;                             0 for the original fill
"RTN","IBNCPDP6",92,0)
 ;
"RTN","IBNCPDP6",93,0)
 N IBCHTRND,IBDUZ,IBN,IBCRES,DFN,IBSITE,IBFAC,IBND,IBPARNT,IBCANC,IBH,IBCANTR,IBXA,IBATYP,IBSEQNO,IBIL,IBUNIT,IBCHG,IBFR,DIE,DA,DR,IBCHTRN,IBY
"RTN","IBNCPDP6",94,0)
 ;
"RTN","IBNCPDP6",95,0)
 S IBY=1,IBDUZ=DUZ
"RTN","IBNCPDP6",96,0)
 S IBCHTRN=$O(^IBCNR(366.15,"B",IBKEY,0))
"RTN","IBNCPDP6",97,0)
 I 'IBCHTRN G CANCQ
"RTN","IBNCPDP6",98,0)
 S IBCHTRND=$G(^IBCNR(366.15,IBCHTRN,0)),DFN=$$FILE^IBRXUTL(+IBKEY,2)
"RTN","IBNCPDP6",99,0)
 S IBN=+$P(IBCHTRND,"^",4) I 'IBN G CANCQ
"RTN","IBNCPDP6",100,0)
 I '$$CHECK^IBECEAU(0) S IBY="-1^IB009" G CANCQ
"RTN","IBNCPDP6",101,0)
 S IBCRES=$O(^IBE(350.3,"B","RX CANCELLED",0)) S:'IBCRES IBCRES=5
"RTN","IBNCPDP6",102,0)
 ;
"RTN","IBNCPDP6",103,0)
 ; - cancel the charge
"RTN","IBNCPDP6",104,0)
 D CED^IBECEAU4(IBN) I IBY<0 G CANCQ
"RTN","IBNCPDP6",105,0)
 D CANC^IBECEAU4(IBN,IBCRES,1)
"RTN","IBNCPDP6",106,0)
 ;
"RTN","IBNCPDP6",107,0)
 S DIE="^IBCNR(366.15,",DA=IBCHTRN,DR=".04///@" D ^DIE
"RTN","IBNCPDP6",108,0)
CANCQ ;
"RTN","IBNCPDP6",109,0)
 I IBY<0 D ERRMSG^IBACVA2(0,2)
"RTN","IBNCPDP6",110,0)
 ;
"RTN","IBNCPDP6",111,0)
 Q
"RTN","IBNCPDP6",112,0)
 ;
"RTN","IBNCPDP6",113,0)
RT(IBKEY) ; returns rate type previously determined
"RTN","IBNCPDP6",114,0)
 Q $P($G(^IBCNR(366.15,+$O(^IBCNR(366.15,"B",IBKEY,0)),0)),"^",3)
"RTN","IBNCPDP6",115,0)
 ;
"RTN","IBNCPDP6",116,0)
TRICARE(IBKEY) ; returns if the Key is RT Tricare
"RTN","IBNCPDP6",117,0)
 N IBRT
"RTN","IBNCPDP6",118,0)
 S IBRT=+$$RT(IBKEY)
"RTN","IBNCPDP6",119,0)
 Q $S($P($G(^DGCR(399.3,IBRT,0)),"^")["TRICARE":1,1:0)
"RTN","IBNCPDP6",120,0)
 ;
"RTN","IBNCPDPI")
0^12^B8589835^B8352830
"RTN","IBNCPDPI",1,0)
IBNCPDPI ;DALOI/SS - for ECME SCREEN INSURANCE VIEW AND UTILITIES ;3/27/08  13:05
"RTN","IBNCPDPI",2,0)
 ;;2.0;INTEGRATED BILLING;**276,383**;21-MAR-94;Build 11
"RTN","IBNCPDPI",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBNCPDPI",4,0)
 ; -- main entry point
"RTN","IBNCPDPI",5,0)
 Q
"RTN","IBNCPDPI",6,0)
EN ;
"RTN","IBNCPDPI",7,0)
 Q
"RTN","IBNCPDPI",8,0)
EN1(DFN) ;
"RTN","IBNCPDPI",9,0)
 I $G(DFN)'>0 Q
"RTN","IBNCPDPI",10,0)
 Q:$$PFSSON()  ;quit if PFSS is ON
"RTN","IBNCPDPI",11,0)
 N J,POP,START,X,VA,ALMBG,DIC,DT,C,CTRLCOL,DILN
"RTN","IBNCPDPI",12,0)
 ;
"RTN","IBNCPDPI",13,0)
 ;if the user does have IB keys to edit insurances
"RTN","IBNCPDPI",14,0)
 I $D(^XUSEC("IB INSURANCE SUPERVISOR",DUZ))!($D(^XUSEC("IB INSURANCE COMPANY ADD",DUZ))) D  Q
"RTN","IBNCPDPI",15,0)
 . N D1,DA,DDER,DDH,DIE,DR,I
"RTN","IBNCPDPI",16,0)
 . N IBCH,IBCNS,IBCNSEH,IBCNT,IBCPOL,IBDT,IBDUZ,IBFILE,IBLCNT,IBN,IBNEW,IBPPOL
"RTN","IBNCPDPI",17,0)
 . N IBTYP,IBYE,IBCDFN,IBCDFND1,IBCGN
"RTN","IBNCPDPI",18,0)
 . D EN^VALM("IBNCPDP INSURANCE MANAGEMENT")
"RTN","IBNCPDPI",19,0)
 ;if the user doesn't have insurance IB keys
"RTN","IBNCPDPI",20,0)
 D
"RTN","IBNCPDPI",21,0)
 . N D0,IBCAB,IBCDFN,IBCDFND1,IBCNS,IBCNT,IBCPOL,IBDT,IBEXP1
"RTN","IBNCPDPI",22,0)
 . N IBEXP2,IBFILE,IBLCNT,IBN,IBPPOL
"RTN","IBNCPDPI",23,0)
 . D EN1^IBNCPDPV(DFN)
"RTN","IBNCPDPI",24,0)
 Q
"RTN","IBNCPDPI",25,0)
 ;
"RTN","IBNCPDPI",26,0)
INIT ; -- set up initial variables
"RTN","IBNCPDPI",27,0)
 ;DFN should be defined
"RTN","IBNCPDPI",28,0)
 I '$D(DFN) Q
"RTN","IBNCPDPI",29,0)
 S U="^",VALMCNT=0,VALMBG=1
"RTN","IBNCPDPI",30,0)
 K ^TMP("IBNSM",$J),^TMP("IBNSMDX",$J)
"RTN","IBNCPDPI",31,0)
 S IBTYP="P"
"RTN","IBNCPDPI",32,0)
 D BLD^IBCNSM
"RTN","IBNCPDPI",33,0)
 Q
"RTN","IBNCPDPI",34,0)
 ;
"RTN","IBNCPDPI",35,0)
HDR ; -- screen header for initial screen
"RTN","IBNCPDPI",36,0)
 D HDR^IBCNSM
"RTN","IBNCPDPI",37,0)
 Q
"RTN","IBNCPDPI",38,0)
 ;
"RTN","IBNCPDPI",39,0)
HELP ; -- help code
"RTN","IBNCPDPI",40,0)
 Q
"RTN","IBNCPDPI",41,0)
 ;
"RTN","IBNCPDPI",42,0)
EXIT ; -- exit code
"RTN","IBNCPDPI",43,0)
 Q
"RTN","IBNCPDPI",44,0)
 ;
"RTN","IBNCPDPI",45,0)
EXPND ; -- expand code
"RTN","IBNCPDPI",46,0)
 Q
"RTN","IBNCPDPI",47,0)
 ;
"RTN","IBNCPDPI",48,0)
 ;check if PFSS On?
"RTN","IBNCPDPI",49,0)
 ;returns:
"RTN","IBNCPDPI",50,0)
 ; 1 - PFSS is ON
"RTN","IBNCPDPI",51,0)
 ; 0 - PFSS is OFF or not installed
"RTN","IBNCPDPI",52,0)
PFSSON() ;
"RTN","IBNCPDPI",53,0)
 N BPST
"RTN","IBNCPDPI",54,0)
 S BPST=0
"RTN","IBNCPDPI",55,0)
 I $L($T(SWSTAT^IBBAPI))>0 S BPST=+$$SWSTAT^IBBAPI()
"RTN","IBNCPDPI",56,0)
 I BPST=1 D  Q 1
"RTN","IBNCPDPI",57,0)
 . W !,"This functionality is not supported on PFSS sites." D PAUSE^VALM1
"RTN","IBNCPDPI",58,0)
 Q 0
"RTN","IBNCPDPI",59,0)
 ;**
"RTN","IBNCPDPI",60,0)
 ;API for ECME (DBIA #4721)
"RTN","IBNCPDPI",61,0)
 ;Insurance Company lookup API
"RTN","IBNCPDPI",62,0)
 ;NOTE: PFSS needs to modify this code to return back values
"RTN","IBNCPDPI",63,0)
 ;  from the appropriate PFSS file instead of ALL ("0")
"RTN","IBNCPDPI",64,0)
 ;input:
"RTN","IBNCPDPI",65,0)
 ; PRMTMSG - prompt message
"RTN","IBNCPDPI",66,0)
 ; DFLTVAL - INSURANCE NAME as a default value for the prompt (optional)
"RTN","IBNCPDPI",67,0)
 ;output:
"RTN","IBNCPDPI",68,0)
 ; IEN^INSURANCE_NAME^PFSS_STATUS
"RTN","IBNCPDPI",69,0)
 ;   0^^PFSS_STATUS  means ALL selected (temporary solution for PFSS sites)
"RTN","IBNCPDPI",70,0)
 ;  -1^^PFSS_STATUS  nothing was selected, timeout expired or uparrow entered
"RTN","IBNCPDPI",71,0)
 ; where: IEN is record number in file #36.
"RTN","IBNCPDPI",72,0)
 ; PFSS_STATUS - the value returned by the PFSS switch: 0 - OFF, 1- ON
"RTN","IBNCPDPI",73,0)
SELINSUR(PRMTMSG,DFLTVAL) ;*/
"RTN","IBNCPDPI",74,0)
 N Y,DUOUT,DTOUT,IBQUIT,DIROUT,IBPFSS
"RTN","IBNCPDPI",75,0)
 S IBPFSS=$$PFSSON()
"RTN","IBNCPDPI",76,0)
 ;PFSS needs to modify this code to return back
"RTN","IBNCPDPI",77,0)
 ;selection in new PFSS file instead of ALL ("0")
"RTN","IBNCPDPI",78,0)
 I IBPFSS=1 Q "0^^"_IBPFSS
"RTN","IBNCPDPI",79,0)
 S IBQUIT=0
"RTN","IBNCPDPI",80,0)
 N DIC
"RTN","IBNCPDPI",81,0)
 S DIC="^DIC(36,"
"RTN","IBNCPDPI",82,0)
 S DIC(0)="AEMNQ"
"RTN","IBNCPDPI",83,0)
 S:$L($G(DFLTVAL))>0 DIC("B")=DFLTVAL
"RTN","IBNCPDPI",84,0)
 S DIC("A")=PRMTMSG_": "
"RTN","IBNCPDPI",85,0)
 D ^DIC
"RTN","IBNCPDPI",86,0)
 I (Y=-1)!$D(DUOUT)!$D(DTOUT) S IBQUIT=1
"RTN","IBNCPDPI",87,0)
 I IBQUIT=1 Q "-1^^"_IBPFSS
"RTN","IBNCPDPI",88,0)
 Q Y_U_IBPFSS
"RTN","IBNCPDPI",89,0)
 ;
"RTN","IBNCPDPI",90,0)
 ;API for ECME (DBIA #4729)
"RTN","IBNCPDPI",91,0)
 ;Determine Bill# and Account Receivable information about the bill
"RTN","IBNCPDPI",92,0)
 ;input:
"RTN","IBNCPDPI",93,0)
 ; IBRX - pointer to file #52 (internal prescription number)
"RTN","IBNCPDPI",94,0)
 ; IBREF - re-fill number
"RTN","IBNCPDPI",95,0)
 ;output:
"RTN","IBNCPDPI",96,0)
 ;Returns a string of information about the bill requested:
"RTN","IBNCPDPI",97,0)
 ; piece #1:  Bill number (field(#.01) of file (#399))
"RTN","IBNCPDPI",98,0)
 ; piece #2:  Original Amount of bill
"RTN","IBNCPDPI",99,0)
 ; piece #3:  Current Status (pointer to file #430.3)
"RTN","IBNCPDPI",100,0)
 ; piece #4:  Current Balance
"RTN","IBNCPDPI",101,0)
 ; piece #5:  Total Collected
"RTN","IBNCPDPI",102,0)
 ; piece #6:  % Collected Returns null if no data or bill found.
"RTN","IBNCPDPI",103,0)
 ; piece #7:  PFSS switch status: 0-OFF, 1-ON
"RTN","IBNCPDPI",104,0)
 ;On PFSS site the API will always return "^^^^^^1"
"RTN","IBNCPDPI",105,0)
 ;
"RTN","IBNCPDPI",106,0)
BILLINFO(IBRX,IBREF) ;
"RTN","IBNCPDPI",107,0)
 N IBIEN,IBBNUM,RCRET
"RTN","IBNCPDPI",108,0)
 N IBPFSS,IBRETV
"RTN","IBNCPDPI",109,0)
 S RCRET="",IBRETV=""
"RTN","IBNCPDPI",110,0)
 S IBPFSS=$$PFSSON()
"RTN","IBNCPDPI",111,0)
 I IBPFSS=1 S $P(IBRETV,U,7)=IBPFSS Q IBRETV
"RTN","IBNCPDPI",112,0)
 S IBBNUM=$$BILL^IBNCPDPU(IBRX,IBREF)
"RTN","IBNCPDPI",113,0)
 I IBBNUM]"" D
"RTN","IBNCPDPI",114,0)
 .S IBIEN=$O(^DGCR(399,"B",IBBNUM,"")) Q:IBIEN=""
"RTN","IBNCPDPI",115,0)
 .S RCRET=$$BILL^RCJIBFN2(IBIEN)
"RTN","IBNCPDPI",116,0)
 S IBRETV=IBBNUM_U_RCRET
"RTN","IBNCPDPI",117,0)
 S $P(IBRETV,U,7)=IBPFSS
"RTN","IBNCPDPI",118,0)
 Q IBRETV
"RTN","IBNCPDPI",119,0)
 ;
"RTN","IBNCPDPI",120,0)
 ;entry point for TPJI option of the ECME User Screen
"RTN","IBNCPDPI",121,0)
TPJI(DFN) ;
"RTN","IBNCPDPI",122,0)
 Q:$$PFSSON()  ;quit if PFSS is ON
"RTN","IBNCPDPI",123,0)
 I DFN>0 D EN^IBJTLA
"RTN","IBNCPDPI",124,0)
 Q
"RTN","IBNCPDPI",125,0)
 ;
"RTN","IBNCPDPI",126,0)
EPHON() ; API to return if ePhamracy is on within IB
"RTN","IBNCPDPI",127,0)
 ;   1 FOR Active
"RTN","IBNCPDPI",128,0)
 ;   0 FOR Not Active
"RTN","IBNCPDPI",129,0)
 ;
"RTN","IBNCPDPI",130,0)
 Q +$G(^IBE(350.9,1,11))
"RTN","IBNCPDPI",131,0)
 ;
"RTN","IBNCPDPU")
0^7^B68802824^B59313586
"RTN","IBNCPDPU",1,0)
IBNCPDPU ;OAK/ELZ - UTILITIES FOR NCPCP ;6/10/08  13:26
"RTN","IBNCPDPU",2,0)
 ;;2.0;INTEGRATED BILLING;**223,276,347,383**;21-MAR-94;Build 11
"RTN","IBNCPDPU",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBNCPDPU",4,0)
 ;
"RTN","IBNCPDPU",5,0)
 ;IA 4702
"RTN","IBNCPDPU",6,0)
 ;
"RTN","IBNCPDPU",7,0)
 ;
"RTN","IBNCPDPU",8,0)
CT(DFN,IBRXN,IBFIL,IBADT,IBRMARK) ; files in claims tracking
"RTN","IBNCPDPU",9,0)
 ; Input:
"RTN","IBNCPDPU",10,0)
 ;  DFN - Patient IEN
"RTN","IBNCPDPU",11,0)
 ;  IBRXN - Rx IEN
"RTN","IBNCPDPU",12,0)
 ;  IBFIL - Fill#
"RTN","IBNCPDPU",13,0)
 ;  IBADT - Fill Date
"RTN","IBNCPDPU",14,0)
 ;  IBRMARK - Non-billable Reason (.01 from 356.8)
"RTN","IBNCPDPU",15,0)
 ;
"RTN","IBNCPDPU",16,0)
 N DIE,DR,DA,IBRXTYP,IBEABD
"RTN","IBNCPDPU",17,0)
 I IBTRKRN D:$D(IBRMARK)  Q
"RTN","IBNCPDPU",18,0)
 . S DIE="^IBT(356,",DA=IBTRKRN,DR=".19///"_IBRMARK D ^DIE
"RTN","IBNCPDPU",19,0)
 ; event type pointer for rx billing
"RTN","IBNCPDPU",20,0)
 S IBRXTYP=$O(^IBE(356.6,"AC",4,0))
"RTN","IBNCPDPU",21,0)
 ; earliest auto-billing date
"RTN","IBNCPDPU",22,0)
 S IBEABD=$$EABD^IBTUTL(IBRXTYP,$$FMADD^XLFDT(IBADT,60))
"RTN","IBNCPDPU",23,0)
 ; space out earliest auto bill date
"RTN","IBNCPDPU",24,0)
 D REFILL^IBTUTL1(DFN,IBRXTYP,IBADT,IBRXN,IBFIL,$G(IBRMARK),IBEABD)
"RTN","IBNCPDPU",25,0)
 Q
"RTN","IBNCPDPU",26,0)
 ;
"RTN","IBNCPDPU",27,0)
NDC(X) ; Massage the NDC as it is stored in Pharmacy
"RTN","IBNCPDPU",28,0)
 ;  Input:  X  --  The NDC as it is stored in Pharmacy
"RTN","IBNCPDPU",29,0)
 ; Output:  X  --  The NDC in the format 5N 1"-" 4N 1"-" 2N
"RTN","IBNCPDPU",30,0)
 ;
"RTN","IBNCPDPU",31,0)
 I $G(X)="" S X="" G NDCQ
"RTN","IBNCPDPU",32,0)
 ;
"RTN","IBNCPDPU",33,0)
 N LEN,PCE,Y,Z
"RTN","IBNCPDPU",34,0)
 ;
"RTN","IBNCPDPU",35,0)
 S Z(1)=5,Z(2)=4,Z(3)=2
"RTN","IBNCPDPU",36,0)
 S PCE=0 F  S PCE=$O(Z(PCE)) Q:'PCE  S LEN=Z(PCE) D
"RTN","IBNCPDPU",37,0)
 .S Y=$P(X,"-",PCE)
"RTN","IBNCPDPU",38,0)
 .I $L(Y)>LEN S Y=$E(Y,2,LEN+1)
"RTN","IBNCPDPU",39,0)
 .I $L(+Y)<LEN S Y=$$FILL(Y,LEN)
"RTN","IBNCPDPU",40,0)
 .S $P(X,"-",PCE)=Y
"RTN","IBNCPDPU",41,0)
 ;
"RTN","IBNCPDPU",42,0)
NDCQ Q X
"RTN","IBNCPDPU",43,0)
 ;
"RTN","IBNCPDPU",44,0)
FILL(X,LEN) ; Zero-fill, right justified.
"RTN","IBNCPDPU",45,0)
 N Y
"RTN","IBNCPDPU",46,0)
 S:'$G(LEN) LEN=1
"RTN","IBNCPDPU",47,0)
 S Y=$E($G(X),1,LEN)
"RTN","IBNCPDPU",48,0)
 F  Q:$L(Y)>(LEN-1)  S Y="0"_Y
"RTN","IBNCPDPU",49,0)
 Q Y
"RTN","IBNCPDPU",50,0)
 ;
"RTN","IBNCPDPU",51,0)
PLANN(DFN,IBX,IBADT) ; returns the ien in the insurance multiple for the given plan
"RTN","IBNCPDPU",52,0)
 ; /patient privided.
"RTN","IBNCPDPU",53,0)
 ;   ien in multiple^insurance co ien
"RTN","IBNCPDPU",54,0)
 N IBPOL,IBY,IBR
"RTN","IBNCPDPU",55,0)
 S IBR=""
"RTN","IBNCPDPU",56,0)
 D ALL^IBCNS1(DFN,"IBPOL",3,IBADT)
"RTN","IBNCPDPU",57,0)
 S IBY=0 F  S IBY=$O(IBPOL(IBY)) Q:IBY<1!(IBR)  I $P(IBPOL(IBY,0),"^",18)=IBX S IBR=$P(IBPOL(IBY,0),"^")_"^"_IBY
"RTN","IBNCPDPU",58,0)
 Q IBR
"RTN","IBNCPDPU",59,0)
 ;
"RTN","IBNCPDPU",60,0)
RT(DFN,IBINS,IBN) ; returns rate type to use for bill
"RTN","IBNCPDPU",61,0)
 ; pass in insurance by ref and which insurance entry to use
"RTN","IBNCPDPU",62,0)
 ; if '$d(ibn) then it loops through to find the first one
"RTN","IBNCPDPU",63,0)
 ; format is RT (ien) ^ Rate Type (Tort or Awp or Cost) ^ Eligibility Basis (V=vet, T=tricare)
"RTN","IBNCPDPU",64,0)
 N VAEL,VAERR,IBPT,IBRT,IBX,IBE,IBI
"RTN","IBNCPDPU",65,0)
 D ELIG^VADPT
"RTN","IBNCPDPU",66,0)
 ;
"RTN","IBNCPDPU",67,0)
 ; if primary elig is vet type, use reimbursable
"RTN","IBNCPDPU",68,0)
 S IBPT=$P($G(^DIC(8,+VAEL(1),0)),"^",5) ; = N:NON-VETERAN;Y:VETERAN
"RTN","IBNCPDPU",69,0)
 I IBPT="Y" S IBRT=$O(^DGCR(399.3,"B","REIMBURSABLE INS.",0)) Q $S(IBRT:IBRT,1:8)_"^T^V"
"RTN","IBNCPDPU",70,0)
 ;
"RTN","IBNCPDPU",71,0)
 Q $S($D(IBRT):IBRT,1:"0^Vet Rate Type not determined")
"RTN","IBNCPDPU",72,0)
 ;
"RTN","IBNCPDPU",73,0)
 ; if patient is only Tricare elig and only Tricare ins bill for Tricare
"RTN","IBNCPDPU",74,0)
 ; ia #'s 427 & 2516
"RTN","IBNCPDPU",75,0)
 ;  -  determine eligibilities
"RTN","IBNCPDPU",76,0)
 S IBE=$P($G(^DIC(8.1,+$P($G(^DIC(8,+VAEL(1),0)),"^",9),0)),"^"),IBE($S(IBE="TRICARE"!(IBE="SHARING AGREEMENT"):"T",IBE="CHAMPVA":"C",1:"O"))=""
"RTN","IBNCPDPU",77,0)
 S IBX=0 F  S IBX=$O(VAEL(1,IBX)) Q:'IBX  S IBE=$P($G(^DIC(8.1,+$P($G(^DIC(8,+VAEL(1,IBX),0)),"^",9),0)),"^") S IBE($S(IBE="TRICARE"!(IBE="SHARING AGREEMENT"):"T",IBE="CHAMPVA":"C",1:"O"))=""
"RTN","IBNCPDPU",78,0)
 ;  -  determine insurance policies
"RTN","IBNCPDPU",79,0)
 S IBX=0 F  S IBX=$O(IBINS(IBX)) Q:'IBX  S IBI=$P($G(^IBE(355.1,+$P($G(IBINS(IBX,355.3)),"^",9),0)),"^") S IBI($S(IBI="TRICARE":"T",IBI="CHAMPVA":"C",1:"O"))=""
"RTN","IBNCPDPU",80,0)
 ;  -  tricare?
"RTN","IBNCPDPU",81,0)
 I $D(IBE("T")),'$D(IBE("O")),'$D(IBE("C")),$D(IBI("T")),'$D(IBI("O")),'$D(IBI("C")) S IBRT=$O(^DGCR(399.3,"B","TRICARE",0)) Q:IBRT IBRT_"^C^T"
"RTN","IBNCPDPU",82,0)
 ;
"RTN","IBNCPDPU",83,0)
 Q $S($D(IBRT):IBRT,1:"0^unable to determine rate type")
"RTN","IBNCPDPU",84,0)
 ;
"RTN","IBNCPDPU",85,0)
 ;
"RTN","IBNCPDPU",86,0)
 ; ********* temp code for tricare/champus ************** not currently used
"RTN","IBNCPDPU",87,0)
 ; if primary elig is TRICARE/CHAMPUS use one of the champus', depending
"RTN","IBNCPDPU",88,0)
 ; on insurance coverage
"RTN","IBNCPDPU",89,0)
 I $P($G(^DIC(8.1,+$P($G(^DIC(8,+VAEL(3),0)),"^",9),0)),"^")="TRICARE/CHAMPUS" S IBRT=$$UINS("CHAMPUS",.IBINS,.IBN)
"RTN","IBNCPDPU",90,0)
 ;
"RTN","IBNCPDPU",91,0)
 ; if primary elig is CHAMPVA use one of the champva's, depending
"RTN","IBNCPDPU",92,0)
 ; on insurance coverage
"RTN","IBNCPDPU",93,0)
 I $P($G(^DIC(8.1,+$P($G(^DIC(8,+VAEL(3),0)),"^",9),0)),"^")="CHAMPVA" S IBRT=$$UINS("CHAMPVA",.IBINS,.IBN)
"RTN","IBNCPDPU",94,0)
 ;
"RTN","IBNCPDPU",95,0)
 Q $S($D(IBRT):IBRT,1:"0^unable to determine rate type")
"RTN","IBNCPDPU",96,0)
 ;
"RTN","IBNCPDPU",97,0)
 ;
"RTN","IBNCPDPU",98,0)
UINS(IBT,IBINS,IBN) ; in the case of tricare or champva you may have to use
"RTN","IBNCPDPU",99,0)
 ; insurance different rate types insted of the actual tricare or champva
"RTN","IBNCPDPU",100,0)
 N IBRT
"RTN","IBNCPDPU",101,0)
 S IBN=+$G(IBN,$O(IBINS("S",+$O(IBINS("S",0)),0)))
"RTN","IBNCPDPU",102,0)
 I $P($G(^IBE(355.1,+$P($G(IBINS(IBN,355.3)),"^",9),0)),"^")=IBT S IBRT=$O(^DGCR(399.3,"B",IBT,0)),IBRT=$S(IBRT:IBRT_"^"_$S(IBT="CHAMPUS":"A",1:"C"),1:"0^"_IBT_" Rate type not found")
"RTN","IBNCPDPU",103,0)
 I '$D(IBRT) S IBRT=$O(^DGCR(399.3,"B",IBT_" REIMB. INS.",0)),IBRT=$S(IBRT:IBRT_"^"_$S(IBT="CHAMPUS":"A",1:"C"),1:"0^"_IBT_" REIMB. INS. Rate type not found")
"RTN","IBNCPDPU",104,0)
 Q IBRT
"RTN","IBNCPDPU",105,0)
 ;
"RTN","IBNCPDPU",106,0)
BS() ; returns the mccr utility to use
"RTN","IBNCPDPU",107,0)
 N IBX
"RTN","IBNCPDPU",108,0)
 S IBX=0 F  S IBX=$O(^DGCR(399.1,"B","PRESCRIPTION",IBX)) Q:IBX<1  I $P($G(^DGCR(399.1,+$G(IBX),0)),U,5) Q
"RTN","IBNCPDPU",109,0)
 Q IBX
"RTN","IBNCPDPU",110,0)
 ;
"RTN","IBNCPDPU",111,0)
 ; Match IB Bill by the 7-digit ECME number
"RTN","IBNCPDPU",112,0)
RXBIL(IBINP,IBERR) ; Matching NCPDP payments
"RTN","IBNCPDPU",113,0)
 ;Input:
"RTN","IBNCPDPU",114,0)
 ;   IBINP("ECME") - the 7-digit ECME number (Reference Number)
"RTN","IBNCPDPU",115,0)
 ;   IBINP("FILLDT")  - the Rx fill date, YYYYMMDD or FileMan format
"RTN","IBNCPDPU",116,0)
 ;   IBINP("PNM") (optional) - the patient's last name
"RTN","IBNCPDPU",117,0)
 ;Returns:
"RTN","IBNCPDPU",118,0)
 ;   IBERR (by ref) - the error code, or null string if found
"RTN","IBNCPDPU",119,0)
 ;   $$RXBIL - IB Bill IEN, or 0 if not matched
"RTN","IBNCPDPU",120,0)
 N IBKEY,IBECME,BILLDA,IBFOUND,IBMATCH,IBDAT,IBPNAME
"RTN","IBNCPDPU",121,0)
 S IBERR=""
"RTN","IBNCPDPU",122,0)
 S IBECME=$G(IBINP("ECME"))
"RTN","IBNCPDPU",123,0)
 I IBECME'?1.7N S IBERR="Invalid ECME number" Q 0
"RTN","IBNCPDPU",124,0)
 S IBDAT=$G(IBINP("FILLDT")) ; Rx fill date
"RTN","IBNCPDPU",125,0)
 I IBDAT?8N S IBDAT=($E(IBDAT,1,4)-1700)_$E(IBDAT,5,8) ; conv date to FM format
"RTN","IBNCPDPU",126,0)
 I IBDAT'?7N Q $$RXBILND(IBECME)  ; date is not correct or null
"RTN","IBNCPDPU",127,0)
 S IBPNAME=$G(IBINP("PNM")) ; patient's name (optional)
"RTN","IBNCPDPU",128,0)
 S IBKEY=+IBECME_";"_IBDAT ; The ECME Number (BC ID)
"RTN","IBNCPDPU",129,0)
 S BILLDA="",IBFOUND=0,IBMATCH=0
"RTN","IBNCPDPU",130,0)
 ; Search backward
"RTN","IBNCPDPU",131,0)
 F  S BILLDA=$O(^DGCR(399,"AG",IBKEY,BILLDA),-1) Q:BILLDA=""  D  Q:IBFOUND
"RTN","IBNCPDPU",132,0)
 . I 'BILLDA Q  ; IEN must be numeric
"RTN","IBNCPDPU",133,0)
 . I '$D(^DGCR(399,BILLDA,0)) Q  ; Corrupted index
"RTN","IBNCPDPU",134,0)
 . S IBMATCH=1
"RTN","IBNCPDPU",135,0)
 . I IBPNAME'="" I '$$TXMATCH($P(IBPNAME,","),$P($G(^DPT(+$P(^DGCR(399,BILLDA,0),U,2),0)),","),8) Q  ; Patient name doesn't match
"RTN","IBNCPDPU",136,0)
 . S IBFOUND=1
"RTN","IBNCPDPU",137,0)
 I 'BILLDA S IBERR=$S(IBMATCH:"Patient's name does not match",1:"Matching bill not found") ; not matched
"RTN","IBNCPDPU",138,0)
 Q +BILLDA
"RTN","IBNCPDPU",139,0)
 ;
"RTN","IBNCPDPU",140,0)
RXBILND(IBECME) ;Match the bill with no date
"RTN","IBNCPDPU",141,0)
 N IBKEY,IBBC,BILLDA,IBY,IBCUT
"RTN","IBNCPDPU",142,0)
 S IBKEY=+IBECME_";"
"RTN","IBNCPDPU",143,0)
 S IBCUT=$$FMADD^XLFDT(DT,-180) ; only 180 days in the past
"RTN","IBNCPDPU",144,0)
 S BILLDA=0
"RTN","IBNCPDPU",145,0)
 ; Search PRNT/TX forward
"RTN","IBNCPDPU",146,0)
 S IBBC=IBKEY_IBCUT
"RTN","IBNCPDPU",147,0)
 F  S IBBC=$O(^DGCR(399,"AG",IBBC)) Q:IBBC'[IBKEY  D  Q:BILLDA
"RTN","IBNCPDPU",148,0)
 . S IBY="" F  S IBY=$O(^DGCR(399,"AG",IBBC,IBY)) Q:'IBY  D  Q:BILLDA
"RTN","IBNCPDPU",149,0)
 .. I $P($G(^DGCR(399,+IBY,0)),U,13)'=4 Q  ; not PRNT/TX
"RTN","IBNCPDPU",150,0)
 .. S BILLDA=+IBY
"RTN","IBNCPDPU",151,0)
 I BILLDA Q BILLDA
"RTN","IBNCPDPU",152,0)
 ; Search ANY backward
"RTN","IBNCPDPU",153,0)
 S IBBC=IBKEY_"8000000"
"RTN","IBNCPDPU",154,0)
 F  S IBBC=$O(^DGCR(399,"AG",IBBC),-1) Q:IBBC'[IBKEY  Q:$P(IBBC,";",2)<IBCUT  D  Q:BILLDA
"RTN","IBNCPDPU",155,0)
 . S IBY="" F  S IBY=$O(^DGCR(399,"AG",IBBC,IBY),-1) Q:IBY=""  D  Q:BILLDA
"RTN","IBNCPDPU",156,0)
 .. ;I $P($G(^DGCR(399,+IBY,0)),U,13)'=7 Q  ; not CANCELLED
"RTN","IBNCPDPU",157,0)
 .. S BILLDA=+IBY
"RTN","IBNCPDPU",158,0)
 Q BILLDA
"RTN","IBNCPDPU",159,0)
 ;
"RTN","IBNCPDPU",160,0)
 ;Check matching of two strings - case insensitive, no spaces etc.
"RTN","IBNCPDPU",161,0)
TXMATCH(IBTXT1,IBTXT2,IBMAX) ;
"RTN","IBNCPDPU",162,0)
 N IBTR1,IBTR2,IBT1,IBT2
"RTN","IBNCPDPU",163,0)
 ;Checking only first IBMAX characters (long names may be trancated
"RTN","IBNCPDPU",164,0)
 S IBTR1="ABCDEFGHIJKLMNOPQRSTUVWXYZ:;"",'._()<>/\|@#$%&*-=!`~ "
"RTN","IBNCPDPU",165,0)
 S IBTR2="abcdefghijklmnopqrstuvwxyz"
"RTN","IBNCPDPU",166,0)
 S IBT1=$E($TR(IBTXT1,IBTR1,IBTR2),1,IBMAX)
"RTN","IBNCPDPU",167,0)
 S IBT2=$E($TR(IBTXT2,IBTR1,IBTR2),1,IBMAX)
"RTN","IBNCPDPU",168,0)
 Q IBT1=IBT2
"RTN","IBNCPDPU",169,0)
 ;
"RTN","IBNCPDPU",170,0)
ECMEBIL(DFN,IBADT) ; Is the pat ECME Billable (pharmacy coverage only)
"RTN","IBNCPDPU",171,0)
 ; DFN - ptr to the patient
"RTN","IBNCPDPU",172,0)
 ; IBADT  - the date
"RTN","IBNCPDPU",173,0)
 N IBANY,IBERMSG,IBX,IBINS,IBT,IBZ,IBRES,IBCAT,IBCOV,IBPCOV
"RTN","IBNCPDPU",174,0)
 S IBRES=0 ; Not ECME Billable by default
"RTN","IBNCPDPU",175,0)
 S (IBCOV,IBPCOV)=0
"RTN","IBNCPDPU",176,0)
 ; -- look up ins with Rx
"RTN","IBNCPDPU",177,0)
 D ALL^IBCNS1(DFN,"IBINS",1,IBADT,1)
"RTN","IBNCPDPU",178,0)
 S IBERMSG="" ; Error message
"RTN","IBNCPDPU",179,0)
 S IBCAT=$O(^IBE(355.31,"B","PHARMACY",0))
"RTN","IBNCPDPU",180,0)
 S IBX=0 F  S IBX=$O(IBINS("S",IBX)) Q:'IBX  D  Q:IBRES
"RTN","IBNCPDPU",181,0)
 . S IBT=0 F  S IBT=$O(IBINS("S",IBX,IBT)) Q:'IBT  D  Q:IBRES
"RTN","IBNCPDPU",182,0)
 . . N IBZ,IBPIEN,IBY,IBPL
"RTN","IBNCPDPU",183,0)
 . . S IBZ=$G(IBINS(IBT,0))
"RTN","IBNCPDPU",184,0)
 . . S IBPL=+$P(IBZ,U,18) Q:'IBPL
"RTN","IBNCPDPU",185,0)
 . . S IBCOV=1 ; covered
"RTN","IBNCPDPU",186,0)
 . . I '$$PLCOV^IBCNSU3(IBPL,IBADT,IBCAT) Q
"RTN","IBNCPDPU",187,0)
 . . S IBPCOV=1
"RTN","IBNCPDPU",188,0)
 . . S IBPIEN=+$G(^IBA(355.3,IBPL,6))
"RTN","IBNCPDPU",189,0)
 . . I 'IBPIEN S IBERMSG="Plan not linked to the Payer" Q  ; Not linked
"RTN","IBNCPDPU",190,0)
 . . D STCHK^IBCNRU1(IBPIEN,.IBY)
"RTN","IBNCPDPU",191,0)
 . . I $E($G(IBY(1)))'="A" S:IBERMSG="" IBERMSG=$$ERMSG^IBNCPDP1($P($G(IBY(6)),",")) Q
"RTN","IBNCPDPU",192,0)
 . . S IBRES=1
"RTN","IBNCPDPU",193,0)
 I 'IBCOV Q "0^Not Insured"
"RTN","IBNCPDPU",194,0)
 I 'IBPCOV Q "0^No Pharmacy Coverage"
"RTN","IBNCPDPU",195,0)
 I 'IBRES,IBERMSG'="" Q "0^"_IBERMSG
"RTN","IBNCPDPU",196,0)
 I 'IBRES Q "0^No Insurance ECME billable"
"RTN","IBNCPDPU",197,0)
 ;
"RTN","IBNCPDPU",198,0)
 Q IBRES
"RTN","IBNCPDPU",199,0)
 ;
"RTN","IBNCPDPU",200,0)
SUBMIT(IBRX,IBFIL) ; Submit the Rx claim through ECME
"RTN","IBNCPDPU",201,0)
 ; IBRX - RX ien in file #52
"RTN","IBNCPDPU",202,0)
 ; IBFIL - Fill No (0 for orig fill)
"RTN","IBNCPDPU",203,0)
 N IBDT,IBNDC,IBX
"RTN","IBNCPDPU",204,0)
 I '$G(IBRX)!('$D(IBFIL)) Q "0^Invalid parameters."
"RTN","IBNCPDPU",205,0)
 S IBDT=$S('IBFIL:$$FILE^IBRXUTL(IBRX,22),1:$$SUBFILE^IBRXUTL(IBRX,IBFIL,52,.01))
"RTN","IBNCPDPU",206,0)
 S IBX=$$EN^BPSNCPDP(+IBRX,+IBFIL,IBDT,"BB")
"RTN","IBNCPDPU",207,0)
 I +IBX=0 D ECMEACT^PSOBPSU1(+IBRX,+IBFIL,"Claim submitted to 3rd party payer: IB BACK BILLING")
"RTN","IBNCPDPU",208,0)
 Q IBX
"RTN","IBNCPDPU",209,0)
 ;
"RTN","IBNCPDPU",210,0)
REASON(IBX,EXACT) ; Close Claim Reasons
"RTN","IBNCPDPU",211,0)
 Q $P($G(^IBE(356.8,+IBX,0)),U) ; non-billable reason
"RTN","IBNCPDPU",212,0)
 ;
"RTN","IBNCPDPU",213,0)
NABP(IBIFN) ;NABP Number
"RTN","IBNCPDPU",214,0)
 N IBY,IBTRKN,IBRX,IBFIL,IBZ,IBNABP
"RTN","IBNCPDPU",215,0)
 S IBY=+$O(^IBT(356.399,"C",IBIFN,0)) I 'IBY Q ""
"RTN","IBNCPDPU",216,0)
 S IBTRKN=$P($G(^IBT(356.399,IBY,0)),U) I 'IBTRKN Q ""
"RTN","IBNCPDPU",217,0)
 S IBZ=$G(^IBT(356,IBTRKN,0)) I IBZ="" Q ""
"RTN","IBNCPDPU",218,0)
 S IBRX=$P(IBZ,U,8)
"RTN","IBNCPDPU",219,0)
 S IBFIL=$P(IBZ,U,10)
"RTN","IBNCPDPU",220,0)
 S IBNABP=$$NABP^BPSBUTL(IBRX,IBFIL)
"RTN","IBNCPDPU",221,0)
 Q $S(IBNABP=0:"",1:IBNABP)
"RTN","IBNCPDPU",222,0)
 ;
"RTN","IBNCPDPU",223,0)
 ; Get the K-bill# from CT
"RTN","IBNCPDPU",224,0)
BILL(IBRX,IBFIL) ;
"RTN","IBNCPDPU",225,0)
 N IBTRKN,IBIFN
"RTN","IBNCPDPU",226,0)
 S IBTRKN=+$O(^IBT(356,"ARXFL",+$G(IBRX),+$G(IBFIL),""))
"RTN","IBNCPDPU",227,0)
 S IBIFN=+$P($G(^IBT(356,IBTRKN,0)),U,11)
"RTN","IBNCPDPU",228,0)
 Q $P($G(^DGCR(399,IBIFN,0)),U)
"RTN","IBNCPDPU",229,0)
 ;
"RTN","IBNCPDPU",230,0)
REJECT(IBECME,IBDATE) ; Is the e-claim rejected?
"RTN","IBNCPDPU",231,0)
 N IBINP,IBTRKRN,IBY
"RTN","IBNCPDPU",232,0)
 I IBECME'?1.7N Q 0
"RTN","IBNCPDPU",233,0)
 ;S IBINP("ECME")=IBECME
"RTN","IBNCPDPU",234,0)
 ;S IBINP("FILLDT")=IBDATE
"RTN","IBNCPDPU",235,0)
 ;I $$RXBIL(.IBINP) Q 0  ; bill exists
"RTN","IBNCPDPU",236,0)
 S IBTRKRN=+$O(^IBT(356,"AE",IBECME,0)) I 'IBTRKRN Q 0
"RTN","IBNCPDPU",237,0)
 S IBY=$G(^IBT(356,IBTRKRN,1))
"RTN","IBNCPDPU",238,0)
 I $P(IBY,U,11)>0 Q 1  ; Rejected or closed
"RTN","IBNCPDPU",239,0)
 Q 0
"RTN","IBNCPDPU",240,0)
 ;
"RTN","IBNCPDPU",241,0)
 ;
"RTN","IBNCPDPU",242,0)
 ;IBNCPDPU
"RTN","IBNCPEV")
0^11^B84966832^B83555880
"RTN","IBNCPEV",1,0)
IBNCPEV ;DALOI/SS - NCPDP BILLING EVENTS REPORT ;3/5/08  14:31
"RTN","IBNCPEV",2,0)
 ;;2.0;INTEGRATED BILLING;**342,363,383**;21-MAR-94;Build 11
"RTN","IBNCPEV",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBNCPEV",4,0)
 ;
"RTN","IBNCPEV",5,0)
 Q
"RTN","IBNCPEV",6,0)
RPT ;
"RTN","IBNCPEV",7,0)
 ;
"RTN","IBNCPEV",8,0)
 N IBPAT,IBRX,IBBDT,IBEDT,Y,IBM1,IBM2,IBM3,IBQ,IBSCR,IBPAGE,IBDTL,IBDIVS
"RTN","IBNCPEV",9,0)
 N IBECME
"RTN","IBNCPEV",10,0)
 D SETVARS^IBNCPEV1
"RTN","IBNCPEV",11,0)
 Q:IBQ
"RTN","IBNCPEV",12,0)
 D START
"RTN","IBNCPEV",13,0)
 D ^%ZISC
"RTN","IBNCPEV",14,0)
 I IBQ W !,"Cancelled"
"RTN","IBNCPEV",15,0)
 Q
"RTN","IBNCPEV",16,0)
 ;
"RTN","IBNCPEV",17,0)
START ;
"RTN","IBNCPEV",18,0)
 N REF,IBFROM,IBTO,IBI,IBN,IBRX1,IBFN,IBNDX,IB1ST,IBNUM,X,IBSC,IBNB
"RTN","IBNCPEV",19,0)
 N Z,Z1
"RTN","IBNCPEV",20,0)
 ;Constants
"RTN","IBNCPEV",21,0)
 S IBSC="STATUS CHECK",IBNB="Not ECME billable: ",IBNDX="IBNCPDP-"
"RTN","IBNCPEV",22,0)
 ;get the first date
"RTN","IBNCPEV",23,0)
 S IBFROM=$O(^IBCNR(366.14,"B",IBBDT-1)) Q:+IBFROM=0
"RTN","IBNCPEV",24,0)
 ;get the last date
"RTN","IBNCPEV",25,0)
 S IBTO=$O(^IBCNR(366.14,"B",IBEDT+1),-1) Q:+IBTO=0
"RTN","IBNCPEV",26,0)
 ;
"RTN","IBNCPEV",27,0)
 S REF=$NA(^TMP($J,"IBNCPDPE"))
"RTN","IBNCPEV",28,0)
 ;
"RTN","IBNCPEV",29,0)
 K @REF
"RTN","IBNCPEV",30,0)
 ;
"RTN","IBNCPEV",31,0)
 I +$G(IBECME) S IBRX=$$GETRX^IBNCPEV1(IBECME,IBFROM,IBTO) I 'IBRX  W !!,"No data found for the specified date range and ECME #" Q  ; no match with ECME #
"RTN","IBNCPEV",32,0)
 ;collect
"RTN","IBNCPEV",33,0)
 N IBDTIEN,IBRXIEN,IBZ0,IBZ1,IBZ2,IBDFN,IBEVNT,IBP4
"RTN","IBNCPEV",34,0)
 S IBI=IBFROM-1
"RTN","IBNCPEV",35,0)
 F  S IBI=$O(^IBCNR(366.14,"B",IBI)) Q:+IBI=0  Q:IBI>IBTO  D
"RTN","IBNCPEV",36,0)
 . S IBDTIEN=$O(^IBCNR(366.14,"B",IBI,0))
"RTN","IBNCPEV",37,0)
 . S IBN=0 F  S IBN=$O(^IBCNR(366.14,IBDTIEN,1,IBN)) Q:+IBN=0  D
"RTN","IBNCPEV",38,0)
 . . S IBZ0=$G(^IBCNR(366.14,IBDTIEN,1,IBN,0))
"RTN","IBNCPEV",39,0)
 . . ;if not "ALL" was selected IBDIVS>0 AND the division in #366.14 record is among those selected by the user
"RTN","IBNCPEV",40,0)
 . . I IBDIVS>0,$$CHECKDIV^IBNCPEV1(+$P(IBZ0,U,9),.IBDIVS)=0 Q
"RTN","IBNCPEV",41,0)
 . . S IBDFN=+$P(IBZ0,U,3)
"RTN","IBNCPEV",42,0)
 . . Q:IBDFN=0
"RTN","IBNCPEV",43,0)
 . . S IBEVNT=$$GET1^DIQ(366.141,IBN_","_IBDTIEN_",",.01)
"RTN","IBNCPEV",44,0)
 . . S IBZ2=$G(^IBCNR(366.14,IBDTIEN,1,IBN,2))
"RTN","IBNCPEV",45,0)
 . . S IBRXIEN=$P(IBZ2,U,12)
"RTN","IBNCPEV",46,0)
 . . I IBRXIEN="" S IBRXIEN=$P(IBZ2,U,1)
"RTN","IBNCPEV",47,0)
 . . I IBPAT,IBDFN'=IBPAT Q
"RTN","IBNCPEV",48,0)
 . . I IBRX,IBRXIEN'=IBRX Q
"RTN","IBNCPEV",49,0)
 . . I $$RXNUM(IBRXIEN)="" Q
"RTN","IBNCPEV",50,0)
 . . I IBM2="E",IBEVNT[IBSC,'$P(IBZ0,U,7) Q
"RTN","IBNCPEV",51,0)
 . . I IBM2="N",IBEVNT'[IBSC Q
"RTN","IBNCPEV",52,0)
 . . I IBM2="N",IBEVNT[IBSC,$P(IBZ0,U,7) Q
"RTN","IBNCPEV",53,0)
 . . I IBM3'="A",IBM3'=$$RXWMC^IBNCPRR(+IBRXIEN) Q
"RTN","IBNCPEV",54,0)
 . . S @REF@(+IBRXIEN,+$P(IBZ2,U,3),IBDTIEN,IBN)=""
"RTN","IBNCPEV",55,0)
 ;
"RTN","IBNCPEV",56,0)
 I '$D(@REF) W !!,"No data found for the specified input criteria" Q
"RTN","IBNCPEV",57,0)
 ;print
"RTN","IBNCPEV",58,0)
 S IBNUM=0
"RTN","IBNCPEV",59,0)
 U IO D HDR
"RTN","IBNCPEV",60,0)
 S IBRX1="" F  S IBRX1=$O(@REF@(IBRX1)) Q:IBRX1=""  D  Q:IBQ
"RTN","IBNCPEV",61,0)
 .S IBFN="" F  S IBFN=$O(@REF@(IBRX1,IBFN)) Q:IBFN=""  D  Q:IBQ
"RTN","IBNCPEV",62,0)
 ..S IB1ST=1
"RTN","IBNCPEV",63,0)
 ..S IBI="" F  S IBI=$O(@REF@(IBRX1,IBFN,IBI)) Q:IBI=""  D  Q:IBQ
"RTN","IBNCPEV",64,0)
 ...S IBN="" F  S IBN=$O(@REF@(IBRX1,IBFN,IBI,IBN)) Q:IBN=""  D  Q:IBQ
"RTN","IBNCPEV",65,0)
 ....N IBZ,IBD1,IBD2,IBD3,IBD4,IBINS,IBY
"RTN","IBNCPEV",66,0)
 ....;load main
"RTN","IBNCPEV",67,0)
 ....S IBZ=$G(^IBCNR(366.14,IBI,1,IBN,0))
"RTN","IBNCPEV",68,0)
 ....;load IBD array
"RTN","IBNCPEV",69,0)
 ....S IBD1=$G(^IBCNR(366.14,IBI,1,IBN,1))
"RTN","IBNCPEV",70,0)
 ....S IBD2=$G(^IBCNR(366.14,IBI,1,IBN,2))
"RTN","IBNCPEV",71,0)
 ....S IBD3=$G(^IBCNR(366.14,IBI,1,IBN,3))
"RTN","IBNCPEV",72,0)
 ....S IBD4=$G(^IBCNR(366.14,IBI,1,IBN,4))
"RTN","IBNCPEV",73,0)
 ....S IBY=0
"RTN","IBNCPEV",74,0)
 ....;load insurance multiple
"RTN","IBNCPEV",75,0)
 ....F  S IBY=$O(^IBCNR(366.14,IBI,1,IBN,5,IBY)) Q:+IBY=0  D
"RTN","IBNCPEV",76,0)
 .....S IBINS(IBY,0)=$G(^IBCNR(366.14,IBI,1,IBN,5,IBY,0))
"RTN","IBNCPEV",77,0)
 .....S IBINS(IBY,1)=$G(^IBCNR(366.14,IBI,1,IBN,5,IBY,1))
"RTN","IBNCPEV",78,0)
 .....S IBINS(IBY,2)=$G(^IBCNR(366.14,IBI,1,IBN,5,IBY,2))
"RTN","IBNCPEV",79,0)
 .....S IBINS(IBY,3)=$G(^IBCNR(366.14,IBI,1,IBN,5,IBY,3))
"RTN","IBNCPEV",80,0)
 ....;
"RTN","IBNCPEV",81,0)
 ....I IB1ST D  Q:IBQ
"RTN","IBNCPEV",82,0)
 .....S IBNUM=IBNUM+1 I IBNUM>1 D ULINE("-") Q:IBQ
"RTN","IBNCPEV",83,0)
 .....D CHKP Q:IBQ
"RTN","IBNCPEV",84,0)
 .....W !,IBNUM," ",?4,$$RXNUM(IBRX1)," ",?12,IBFN," ",?16,$$DAT(+$P(IBD2,U,6)) ;RX# Fill# Fiil_date
"RTN","IBNCPEV",85,0)
 .....W " ",?28,$E($$PAT(+$P(IBZ,U,3)),1,21)," ",?50,$E($$DRUG(+$P(IBZ,U,3),IBRX1),1,30)
"RTN","IBNCPEV",86,0)
 .....S IB1ST=0
"RTN","IBNCPEV",87,0)
 ....N IND S IND=6
"RTN","IBNCPEV",88,0)
 ....D CHKP Q:IBQ
"RTN","IBNCPEV",89,0)
 ....S IBEVNT=$$GET1^DIQ(366.141,IBN_","_IBI_",",.01)
"RTN","IBNCPEV",90,0)
 ....W !,?IND,$$EVNT(IBEVNT)," ",?16,$$TIM($P(IBZ,U,5)),?31," Status:",$E($$STAT(IBEVNT,$P(IBZ,U,7)_U_$P(IBZ,U,8),$P(IBD3,U,7),$P(IBD3,U,1)),1,40)
"RTN","IBNCPEV",91,0)
 ....Q:'IBDTL  ; no details
"RTN","IBNCPEV",92,0)
 ....I IBEVNT="BILL" D DBILL Q
"RTN","IBNCPEV",93,0)
 ....I IBEVNT="REJECT" D DREJ Q
"RTN","IBNCPEV",94,0)
 ....I IBEVNT["REVERSE" D DREV Q
"RTN","IBNCPEV",95,0)
 ....I IBEVNT["SUBMIT" D DSUB Q
"RTN","IBNCPEV",96,0)
 ....I IBEVNT["CLOSE" D DCLO Q
"RTN","IBNCPEV",97,0)
 ....I IBEVNT["REOPEN" D REOPEN^IBNCPEV1 Q
"RTN","IBNCPEV",98,0)
 ....I IBEVNT["RELEASE" D DREL Q
"RTN","IBNCPEV",99,0)
 ....I IBEVNT[IBSC D DSTAT^IBNCPEV1(.IBD2,.IBD3,.IBD4,.IBINS) Q
"RTN","IBNCPEV",100,0)
 ....I IBEVNT["BILL CANCELLED" D BCANC Q
"RTN","IBNCPEV",101,0)
 I IBSCR,'IBQ W !,"End of report, press RETURN to continue." R X:DTIME
"RTN","IBNCPEV",102,0)
 K @REF
"RTN","IBNCPEV",103,0)
 Q
"RTN","IBNCPEV",104,0)
 ;
"RTN","IBNCPEV",105,0)
 ;provides STATUS information
"RTN","IBNCPEV",106,0)
 ;
"RTN","IBNCPEV",107,0)
STAT(X,RES,CR,IBIFN) ;
"RTN","IBNCPEV",108,0)
 N IBSC
"RTN","IBNCPEV",109,0)
 N IBNL
"RTN","IBNCPEV",110,0)
 S IBSC="STATUS CHECK"
"RTN","IBNCPEV",111,0)
 S IBNL="Plan not linked to the Payer"
"RTN","IBNCPEV",112,0)
 I X[IBSC,RES[IBNB S RES="0^"_$P(RES,IBNB,2)
"RTN","IBNCPEV",113,0)
 I X[IBSC,RES[IBNL S RES="0^Plan not linked" ; shorten too long line
"RTN","IBNCPEV",114,0)
 I X[IBSC,'RES,RES["Non-Billable in CT" Q $P(RES,U,2)
"RTN","IBNCPEV",115,0)
 I X[IBSC Q $S(RES:"",1:"non-")_"ECME Billable"_$S(RES:"",$P(RES,U,2)="":"",$P(RES,U,2)="NEEDS SC DETERMINATION":" NEEDS "_$$GETNOANS^IBNCPEV1(IBD4)_" DETERMINATION",1:", "_$P(RES,U,2))
"RTN","IBNCPEV",116,0)
 I X="BILL",'RES,IBIFN Q "Bill "_$$BILL(IBIFN)_" created with ERRORs"
"RTN","IBNCPEV",117,0)
 I X="BILL",'RES Q "Error: "_$P(RES,U,2)
"RTN","IBNCPEV",118,0)
 I X="BILL",'IBIFN Q $P(RES,U,2)
"RTN","IBNCPEV",119,0)
 I X="BILL" Q "Bill# "_$$BILL(+IBIFN)_" created"
"RTN","IBNCPEV",120,0)
 I X["REVERSE",$G(CR)=7,RES=1 Q "set N/B Reason: Rx deleted, no Bill to cancel."
"RTN","IBNCPEV",121,0)
 I X["REVERSE" Q $S(RES=1:"success",RES>1:"Bill# "_$$BILL(+RES)_" cancelled",'RES:"ECME Claim reversed, no Bill to cancel",1:$P(RES,U,2))
"RTN","IBNCPEV",122,0)
 I 'RES Q $P(RES,U,2)
"RTN","IBNCPEV",123,0)
 Q "OK"
"RTN","IBNCPEV",124,0)
 ;
"RTN","IBNCPEV",125,0)
 ;BILL section
"RTN","IBNCPEV",126,0)
 ;input params IBD*, IBZ, IBINS*
"RTN","IBNCPEV",127,0)
DBILL ;
"RTN","IBNCPEV",128,0)
 I '$P(IBZ,U,7),$L($P(IBZ,U,8)),$P(IBD3,U,1) D CHKP Q:IBQ  W !?10,"ERROR DESCRIPTION: ",$P(IBZ,U,8)
"RTN","IBNCPEV",129,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",130,0)
 D SUBHDR
"RTN","IBNCPEV",131,0)
 ;I $P(IBD1,U,5) D CHKP Q:IBQ  W !?10,"MEDICAL CENTER DIVISION: ",$P($G(^DG(40.8,+$P(IBD1,U,5),0)),U)
"RTN","IBNCPEV",132,0)
 I $P(IBD2,U,4) D CHKP Q:IBQ  W !?10,"DRUG:",$$DRUGAPI^IBNCPEV1(+$P(IBD2,U,4),.01)
"RTN","IBNCPEV",133,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",134,0)
 W !,?10,"NDC:",$S($P(IBD2,U,5):$P(IBD2,U,5),1:"No"),", BILLED QTY:",$S($P(IBD2,U,8):$P(IBD2,U,8),1:"No"),", DAYS SUPPLY:",$S($P(IBD2,U,9):$P(IBD2,U,9),1:"No")
"RTN","IBNCPEV",135,0)
 W !,?10,"BILLED:",$J($P(IBD3,U,2),0,2),", "
"RTN","IBNCPEV",136,0)
 W "PAID:",$J($P(IBD3,U,5),0,2)
"RTN","IBNCPEV",137,0)
 W:$P(IBD3,U,11) ", 3RD PARTY REPORTED COPAY:",$J($P(IBD3,U,11),0,2)
"RTN","IBNCPEV",138,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",139,0)
 W !?10,"PLAN:",$P($G(^IBA(355.3,+$P(IBD3,U,3),0)),U,3),", INSURANCE: ",$P($G(^DIC(36,+$G(^IBA(355.3,+$P(IBD3,U,3),0)),0)),U)
"RTN","IBNCPEV",140,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",141,0)
 D DISPUSR
"RTN","IBNCPEV",142,0)
 Q
"RTN","IBNCPEV",143,0)
 ;
"RTN","IBNCPEV",144,0)
 ;reject section
"RTN","IBNCPEV",145,0)
DREJ ;
"RTN","IBNCPEV",146,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",147,0)
 D SUBHDR
"RTN","IBNCPEV",148,0)
 I +$P(IBD3,U,3) D CHKP Q:IBQ  W !?10,"PLAN:",$P($G(^IBA(355.3,+$P(IBD3,U,3),0)),U,3),", INSURANCE: ",$P($G(^DIC(36,+$G(^IBA(355.3,+$P(IBD3,U,3),0)),0)),U)
"RTN","IBNCPEV",149,0)
 D CLRS Q:IBQ
"RTN","IBNCPEV",150,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",151,0)
 D DISPUSR
"RTN","IBNCPEV",152,0)
 Q
"RTN","IBNCPEV",153,0)
 ;close
"RTN","IBNCPEV",154,0)
DCLO ;
"RTN","IBNCPEV",155,0)
 D DREJ
"RTN","IBNCPEV",156,0)
 Q
"RTN","IBNCPEV",157,0)
 ;submit
"RTN","IBNCPEV",158,0)
DSUB ;
"RTN","IBNCPEV",159,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",160,0)
 D SUBHDR
"RTN","IBNCPEV",161,0)
 I $L($P(IBD1,U,6)) D CHKP W !?10,"PAYER RESPONSE: ",$P(IBD1,U,6)
"RTN","IBNCPEV",162,0)
 I $L($P(IBD3,U,3)) D CHKP Q:IBQ  W !?10,"PLAN:",$P($G(^IBA(355.3,+$P(IBD3,U,3),0)),U,3),", INSURANCE: ",$P($G(^DIC(36,+$G(^IBA(355.3,+$P(IBD3,U,3),0)),0)),U)
"RTN","IBNCPEV",163,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",164,0)
 D DISPUSR
"RTN","IBNCPEV",165,0)
 Q
"RTN","IBNCPEV",166,0)
 ;release
"RTN","IBNCPEV",167,0)
DREL ;
"RTN","IBNCPEV",168,0)
 D DREJ
"RTN","IBNCPEV",169,0)
 Q
"RTN","IBNCPEV",170,0)
 ;reverse
"RTN","IBNCPEV",171,0)
DREV ;
"RTN","IBNCPEV",172,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",173,0)
 D SUBHDR
"RTN","IBNCPEV",174,0)
 I $L($P(IBD1,U,6)),$E($P(IBD1,U,6),1)'="A"&($E($P(IBD1,U,6),1)'="R") S $P(IBD1,U,6)=""  ; only display accepted and rejected on REVERSALS
"RTN","IBNCPEV",175,0)
 I $L($P(IBD1,U,6)) D CHKP W !?10,"PAYER RESPONSE: ",$P(IBD1,U,6)
"RTN","IBNCPEV",176,0)
 I $L($P(IBD3,U,3)) D CHKP Q:IBQ  W !?10,"PLAN:",$P($G(^IBA(355.3,+$P(IBD3,U,3),0)),U,3),", INSURANCE: ",$P($G(^DIC(36,+$G(^IBA(355.3,+$P(IBD3,U,3),0)),0)),U)
"RTN","IBNCPEV",177,0)
 D CLRS Q:IBQ
"RTN","IBNCPEV",178,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",179,0)
 D DISPUSR
"RTN","IBNCPEV",180,0)
 W !?10,"REVERSAL REASON:",$P(IBD1,U,7)
"RTN","IBNCPEV",181,0)
 Q
"RTN","IBNCPEV",182,0)
 ;
"RTN","IBNCPEV",183,0)
BCANC ; bill cancellation generated by auto-reversal (duplicate bill)
"RTN","IBNCPEV",184,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",185,0)
 W !?10,"SYSTEM FOUND DUPLICATE BILL WHILE PROCESSING CLAIM"
"RTN","IBNCPEV",186,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",187,0)
 D DISPUSR
"RTN","IBNCPEV",188,0)
 Q
"RTN","IBNCPEV",189,0)
 ;
"RTN","IBNCPEV",190,0)
 ;
"RTN","IBNCPEV",191,0)
RELT(X) I X W ",",?45,"RELEASE DATE:",$$TIM(X)
"RTN","IBNCPEV",192,0)
 Q
"RTN","IBNCPEV",193,0)
CLRS ;
"RTN","IBNCPEV",194,0)
 N TX,PP,RC
"RTN","IBNCPEV",195,0)
 S TX="CLOSE REASON"
"RTN","IBNCPEV",196,0)
 S PP="DROP TO PAPER"
"RTN","IBNCPEV",197,0)
 S RC="RELEASE COPAY"
"RTN","IBNCPEV",198,0)
 I $P(IBD3,U,7)'="" D CHKP Q:IBQ  W !?10,TX,":",$$REASON^IBNCPDPU($P(IBD3,U,7)) W:$P(IBD3,U,8) ", ",PP W:$P(IBD3,U,9) ", ",RC
"RTN","IBNCPEV",199,0)
 S TX="CLOSE COMMENT"
"RTN","IBNCPEV",200,0)
 I $L($P(IBD3,U,6))>2 D CHKP Q:IBQ  W !?10,"COMMENT:",$P(IBD3,U,6)
"RTN","IBNCPEV",201,0)
 Q
"RTN","IBNCPEV",202,0)
 ;
"RTN","IBNCPEV",203,0)
HDR ;header
"RTN","IBNCPEV",204,0)
 W @IOF S IBPAGE=IBPAGE+1 W ?72,"PAGE ",IBPAGE
"RTN","IBNCPEV",205,0)
 W !,$$DISPTITL^IBNCPEV1(IBBDT,IBEDT,IBDTL,.IBDIVS)
"RTN","IBNCPEV",206,0)
 W:IBDIVS'=0 !,$$DISPLDIV^IBNCPEV1(.IBDIVS)
"RTN","IBNCPEV",207,0)
 W !?15
"RTN","IBNCPEV",208,0)
 I IBM1="R" W "SINGLE PRESCRIPTION - ",$$RXNUM(IBRX),"  "
"RTN","IBNCPEV",209,0)
 I IBM1="P" W "SINGLE PATIENT - ",$P($G(^DPT(IBPAT,0)),U),"  "
"RTN","IBNCPEV",210,0)
 I IBM1="E" W "SINGLE ECME # - ",IBECME
"RTN","IBNCPEV",211,0)
 I IBM2="E" W "ECME BILLABLE RX  "
"RTN","IBNCPEV",212,0)
 I IBM2="N" W "NON ECME BILLABLE RX  "
"RTN","IBNCPEV",213,0)
 I IBM3'="A",IBM1'="R" W $S(IBM3="M":"MAIL",IBM3="C":"CMOP",1:"WINDOW")_" PRESCRIPTIONS ONLY"
"RTN","IBNCPEV",214,0)
 W !,?4," RX#   FILL  DATE       PATIENT NAME",?55,"DRUG"
"RTN","IBNCPEV",215,0)
 N I W ! F I=1:1:80 W "="
"RTN","IBNCPEV",216,0)
 Q
"RTN","IBNCPEV",217,0)
 ;
"RTN","IBNCPEV",218,0)
ULINE(X) ;line
"RTN","IBNCPEV",219,0)
 D CHKP Q:IBQ
"RTN","IBNCPEV",220,0)
 N I W ! F I=1:1:80 W $G(X,"-")
"RTN","IBNCPEV",221,0)
 Q
"RTN","IBNCPEV",222,0)
CHKP ;Check for EOP
"RTN","IBNCPEV",223,0)
 N Y
"RTN","IBNCPEV",224,0)
 I $Y>(IOSL-4) D:IBSCR PAUSE Q:IBQ  D HDR
"RTN","IBNCPEV",225,0)
 Q
"RTN","IBNCPEV",226,0)
DAT(X,Y) Q $$DAT1^IBOUTL(X,.Y)
"RTN","IBNCPEV",227,0)
TIM(X) N IBT ;time
"RTN","IBNCPEV",228,0)
 S IBT=$$DAT1^IBOUTL(X,1) I $L(IBT," ")<3 Q IBT
"RTN","IBNCPEV",229,0)
 I $P(IBT," ",3)="pm" S IBT=$P(IBT," ",1,2)_"p" Q IBT
"RTN","IBNCPEV",230,0)
 I $P(IBT," ",3)="am" S IBT=$P(IBT," ",1,2)_"a" Q IBT
"RTN","IBNCPEV",231,0)
 Q IBT
"RTN","IBNCPEV",232,0)
 ;
"RTN","IBNCPEV",233,0)
USR(X) ;
"RTN","IBNCPEV",234,0)
 I $D(^VA(200,+X,0)) Q $P(^(0),U)
"RTN","IBNCPEV",235,0)
 Q X
"RTN","IBNCPEV",236,0)
 ;
"RTN","IBNCPEV",237,0)
PAT(DFN) ;
"RTN","IBNCPEV",238,0)
 Q $P($G(^DPT(DFN,0),"?"),"^")
"RTN","IBNCPEV",239,0)
BILL(BN) ;
"RTN","IBNCPEV",240,0)
 Q $P($G(^DGCR(399,BN,0),"?"),"^")
"RTN","IBNCPEV",241,0)
ARBILL(BN) ;
"RTN","IBNCPEV",242,0)
 Q $P($G(^PRCA(430,BN,0),"?"),"^")
"RTN","IBNCPEV",243,0)
 ;/*
"RTN","IBNCPEV",244,0)
 ;Returns
"RTN","IBNCPEV",245,0)
 ;return DRUG name (#50,.01)
"RTN","IBNCPEV",246,0)
 ;IBDFN - IEN in PATIENT file #2
"RTN","IBNCPEV",247,0)
 ;IBRX - IEN in PRESCRIPTION file #52
"RTN","IBNCPEV",248,0)
DRUG(IBDFN,IBRX) ;
"RTN","IBNCPEV",249,0)
 I +$G(IBDFN)=0 Q ""
"RTN","IBNCPEV",250,0)
 N X1
"RTN","IBNCPEV",251,0)
 K ^TMP($J,"IBNCPDP52")
"RTN","IBNCPEV",252,0)
 D RX^PSO52API(IBDFN,"IBNCPDP52",IBRX,"",0)
"RTN","IBNCPEV",253,0)
 S X1=+$G(^TMP($J,"IBNCPDP52",IBDFN,IBRX,6))
"RTN","IBNCPEV",254,0)
 K ^TMP($J,"IBNCPDP52")
"RTN","IBNCPEV",255,0)
 I X1=0 Q ""
"RTN","IBNCPEV",256,0)
 Q $$DRUGNAM^IBNCPEV1(X1)
"RTN","IBNCPEV",257,0)
 ;
"RTN","IBNCPEV",258,0)
EVNT(X) ;Transl
"RTN","IBNCPEV",259,0)
 I X="BILL" Q "BILLING"
"RTN","IBNCPEV",260,0)
 I X="REVERSE" Q "REVERSAL"
"RTN","IBNCPEV",261,0)
 I X="AUTO REVERSE" Q "REVERSAL(A)"
"RTN","IBNCPEV",262,0)
 I X["RELEASE" Q "RELEASE"
"RTN","IBNCPEV",263,0)
 I X["SUBMIT" Q "SUBMIT"
"RTN","IBNCPEV",264,0)
 I X["CLOSE" Q "CLOSE"
"RTN","IBNCPEV",265,0)
 I X[IBSC Q "FINISH"  ;IBSC = "STATUS CHECK"
"RTN","IBNCPEV",266,0)
 Q X
"RTN","IBNCPEV",267,0)
 ;
"RTN","IBNCPEV",268,0)
BOCD(X) ;Basis of Cost Determ
"RTN","IBNCPEV",269,0)
 I +X=7 Q "USUAL & CUSTOMARY"
"RTN","IBNCPEV",270,0)
 I +X=1 Q "AWP"
"RTN","IBNCPEV",271,0)
 I +X=5 Q "COST CALCULATIONS"
"RTN","IBNCPEV",272,0)
 Q X
"RTN","IBNCPEV",273,0)
 ;
"RTN","IBNCPEV",274,0)
PAUSE ;
"RTN","IBNCPEV",275,0)
 N X U IO(0) W !,"Press RETURN to continue, '^' to exit:" R X:DTIME S:'$T X="^" S:X["^" IBQ=1
"RTN","IBNCPEV",276,0)
 U IO
"RTN","IBNCPEV",277,0)
 Q
"RTN","IBNCPEV",278,0)
 ;
"RTN","IBNCPEV",279,0)
SUBHDR ;
"RTN","IBNCPEV",280,0)
 W !?10,"ECME# ",$P(IBD1,U,3),",",?25,"FILL DATE:",$$DAT($P(IBD2,U,6))
"RTN","IBNCPEV",281,0)
 D RELT($P(IBD2,U,7))
"RTN","IBNCPEV",282,0)
 Q
"RTN","IBNCPEV",283,0)
DISPUSR ;
"RTN","IBNCPEV",284,0)
 W !?10,"USER:",$$USR(+$P(IBD3,U,10))
"RTN","IBNCPEV",285,0)
 Q
"RTN","IBNCPEV",286,0)
 ;
"RTN","IBNCPEV",287,0)
 ;/*
"RTN","IBNCPEV",288,0)
 ;Returns RX number (external value: #52,.01)
"RTN","IBNCPEV",289,0)
 ;IBRX - IEN in PRESCRIPTION file #52
"RTN","IBNCPEV",290,0)
RXNUM(IBRX) ;*/
"RTN","IBNCPEV",291,0)
 Q $$RXAPI1^IBNCPUT1(IBRX,.01,"E")
"RTN","IBNCPEV",292,0)
 ;
"RTN","IBNCPEV",293,0)
 ;IBNCPEV
"RTN","IBNCPLOG")
0^10^B61812598^B61207907
"RTN","IBNCPLOG",1,0)
IBNCPLOG ;BHAM ISC/SS - IB ECME EVNT REPORT ;3/5/08  14:02
"RTN","IBNCPLOG",2,0)
 ;;2.0;INTEGRATED BILLING;**342,339,363,383**;21-MAR-94;Build 11
"RTN","IBNCPLOG",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","IBNCPLOG",4,0)
 ;
"RTN","IBNCPLOG",5,0)
 ;store data related to the IB calls made by ECME package in the file #366.14
"RTN","IBNCPLOG",6,0)
 ;input:
"RTN","IBNCPLOG",7,0)
 ;.IBIBD - (by referrence) IBD array with parameter sent to IB by ECME
"RTN","IBNCPLOG",8,0)
 ;DFN patient's ien
"RTN","IBNCPLOG",9,0)
 ;IBPROC - type of event. i.e. content of CALL such as BILL, REJECT and so on
"RTN","IBNCPLOG",10,0)
 ;IBRESULT - (optional) result of the event processing, format: return_code^message
"RTN","IBNCPLOG",11,0)
 ;IBJOB - (optional) job, default = $J
"RTN","IBNCPLOG",12,0)
 ;IBDTTM - (optional) datetime, default = "NOW"
"RTN","IBNCPLOG",13,0)
 ;IBUSR - (optional) user ID, default = DUZ
"RTN","IBNCPLOG",14,0)
 ;output:
"RTN","IBNCPLOG",15,0)
 ;none
"RTN","IBNCPLOG",16,0)
LOG(IBIBD,DFN,IBPROC,IBRESULT,IBJOB,IBDTTM,IBUSR) ;Store the data
"RTN","IBNCPLOG",17,0)
 N NDX,Z,REF,IBDATE,IBDTIEN,IBEVNIEN,IBIBDTYP,IBRETV
"RTN","IBNCPLOG",18,0)
 S IBRESULT=$G(IBRESULT)
"RTN","IBNCPLOG",19,0)
 ;
"RTN","IBNCPLOG",20,0)
 I '$G(IBJOB) S IBJOB=$J
"RTN","IBNCPLOG",21,0)
 I '$G(IBDTTM) S IBDTTM=$$NOW^XLFDT()
"RTN","IBNCPLOG",22,0)
 I '$G(IBUSR) S IBUSR=+DUZ
"RTN","IBNCPLOG",23,0)
 ;
"RTN","IBNCPLOG",24,0)
 S IBDATE=DT
"RTN","IBNCPLOG",25,0)
 S IBDTIEN=+$O(^IBCNR(366.14,"B",IBDATE,0))
"RTN","IBNCPLOG",26,0)
 L +^IBCNR(366.14):30 E  Q
"RTN","IBNCPLOG",27,0)
 I IBDTIEN=0 S IBDTIEN=+$$ADDDATE(IBDATE)
"RTN","IBNCPLOG",28,0)
 ;create an event
"RTN","IBNCPLOG",29,0)
 S IBEVNIEN=$$NEWEVENT(IBDTIEN,IBPROC)
"RTN","IBNCPLOG",30,0)
 L -^IBCNR(366.14)
"RTN","IBNCPLOG",31,0)
 I IBEVNIEN=0 W !,"New event creation Error : LOG^IBNCPLOG",! Q
"RTN","IBNCPLOG",32,0)
 ;
"RTN","IBNCPLOG",33,0)
 I +$$FILLFLDS^IBNCPUT1(366.141,".03",IBEVNIEN_","_IBDTIEN,DFN) ;DFN
"RTN","IBNCPLOG",34,0)
 I +$$FILLFLDS^IBNCPUT1(366.141,".04",IBEVNIEN_","_IBDTIEN,IBJOB) ;JOB
"RTN","IBNCPLOG",35,0)
 I +$$FILLFLDS^IBNCPUT1(366.141,".05",IBEVNIEN_","_IBDTIEN,IBDTTM) ;DATETIME
"RTN","IBNCPLOG",36,0)
 I +$$FILLFLDS^IBNCPUT1(366.141,".06",IBEVNIEN_","_IBDTIEN,DUZ) ;USER
"RTN","IBNCPLOG",37,0)
 I IBRESULT'="" D
"RTN","IBNCPLOG",38,0)
 . S IBRETV=+$$FILLFLDS^IBNCPUT1(366.141,".07",IBEVNIEN_","_IBDTIEN,+IBRESULT) ;RESULT
"RTN","IBNCPLOG",39,0)
 . S IBRETV=+$$FILLFLDS^IBNCPUT1(366.141,".08",IBEVNIEN_","_IBDTIEN,$P(IBRESULT,U,2)) ;RESULT MESSAGE
"RTN","IBNCPLOG",40,0)
 ;store IBIBD array
"RTN","IBNCPLOG",41,0)
 S IBIBDTYP=""
"RTN","IBNCPLOG",42,0)
 F  S IBIBDTYP=$O(IBIBD(IBIBDTYP)) Q:IBIBDTYP=""  D
"RTN","IBNCPLOG",43,0)
 . D IBD(IBDTIEN,IBEVNIEN,IBIBDTYP,$G(IBIBD(IBIBDTYP)),.IBIBD)
"RTN","IBNCPLOG",44,0)
 ;store "INS" node of IBIBD array
"RTN","IBNCPLOG",45,0)
 I $D(IBIBD("INS")) I $$INS(.IBIBD,IBDTIEN,IBEVNIEN)
"RTN","IBNCPLOG",46,0)
 Q
"RTN","IBNCPLOG",47,0)
 ;
"RTN","IBNCPLOG",48,0)
 ;store IBD array data
"RTN","IBNCPLOG",49,0)
 ;IBDTIEN -  ien on top [DATE] level
"RTN","IBNCPLOG",50,0)
 ;IBRECNO - ien in [EVENTS] multiple
"RTN","IBNCPLOG",51,0)
 ;IBIBDTYP - type subscript in IBD array (BILL, PAID, RESPONSE, etc)
"RTN","IBNCPLOG",52,0)
 ;IBVAL - value to store
"RTN","IBNCPLOG",53,0)
 ;IBIBD - array with data passed by reference (for efficiency)
"RTN","IBNCPLOG",54,0)
IBD(IBDTIEN,IBRECNO,IBIBDTYP,IBVAL,IBIBD) ;
"RTN","IBNCPLOG",55,0)
 N IBFLDNO
"RTN","IBNCPLOG",56,0)
 ;W !," - ",IBRECNO," ",IBIBDTYP," = ",IBVAL
"RTN","IBNCPLOG",57,0)
 ;free text like "WEBMD: PAID"
"RTN","IBNCPLOG",58,0)
 I IBIBDTYP="AUTH #" S IBFLDNO=".11",IBVAL=$E(IBVAL,1,30) G EDITIBD
"RTN","IBNCPLOG",59,0)
 ;free text like "0504597;3051229"
"RTN","IBNCPLOG",60,0)
 I IBIBDTYP="BCID" S IBFLDNO=".12" G EDITIBD
"RTN","IBNCPLOG",61,0)
 ;7 digits ECME number - identifier (stored as a text - might have leading zeroes)
"RTN","IBNCPLOG",62,0)
 I IBIBDTYP="CLAIMID" S IBFLDNO=".13" G EDITIBD
"RTN","IBNCPLOG",63,0)
 ;pointer to file #2
"RTN","IBNCPLOG",64,0)
 I IBIBDTYP="DFN" S IBFLDNO=".14" G EDITIBD
"RTN","IBNCPLOG",65,0)
 ;pointer to file #40.8
"RTN","IBNCPLOG",66,0)
 I IBIBDTYP="DIVISION" S IBFLDNO=".15" G EDITIBD
"RTN","IBNCPLOG",67,0)
 ;free text
"RTN","IBNCPLOG",68,0)
 I IBIBDTYP="RESPONSE" S IBFLDNO=".16",IBVAL=$E(IBVAL,1,20) G EDITIBD
"RTN","IBNCPLOG",69,0)
 ;free text
"RTN","IBNCPLOG",70,0)
 I IBIBDTYP="REVERSAL REASON" S IBFLDNO=".17",IBVAL=$E(IBVAL,1,40) G EDITIBD
"RTN","IBNCPLOG",71,0)
 ;1 digit number
"RTN","IBNCPLOG",72,0)
 I IBIBDTYP="RTS-DEL" S IBFLDNO=".18" G EDITIBD
"RTN","IBNCPLOG",73,0)
 ;free text
"RTN","IBNCPLOG",74,0)
 I IBIBDTYP="STATUS" S IBFLDNO=".19",IBVAL=$E(IBVAL,1,20) G EDITIBD
"RTN","IBNCPLOG",75,0)
 ;Prescription number as a text, might have alpha characters (external value, this is not IEN)
"RTN","IBNCPLOG",76,0)
 I IBIBDTYP="RX NO" S IBFLDNO=".202",IBVAL=$E(IBVAL,1,20) G EDITIBD
"RTN","IBNCPLOG",77,0)
 ;0 - original, 1,2,3,... - refill number
"RTN","IBNCPLOG",78,0)
 I IBIBDTYP="FILL NUMBER" S IBFLDNO=".203" G EDITIBD
"RTN","IBNCPLOG",79,0)
 ;internal identifier number for a DRUG
"RTN","IBNCPLOG",80,0)
 I IBIBDTYP="DRUG" S IBFLDNO=".204" G EDITIBD
"RTN","IBNCPLOG",81,0)
 I IBIBDTYP="NDC" S IBFLDNO=".205" G EDITIBD
"RTN","IBNCPLOG",82,0)
 I IBIBDTYP="FILL DATE" S IBFLDNO=".206" G EDITIBD
"RTN","IBNCPLOG",83,0)
 I IBIBDTYP="RELEASE DATE" S IBFLDNO=".207" G EDITIBD
"RTN","IBNCPLOG",84,0)
 I IBIBDTYP="QTY" S IBFLDNO=".208" G EDITIBD
"RTN","IBNCPLOG",85,0)
 I IBIBDTYP="DAYS SUPPLY" S IBFLDNO=".209" G EDITIBD
"RTN","IBNCPLOG",86,0)
 I IBIBDTYP="DEA" S IBFLDNO=".21" G EDITIBD
"RTN","IBNCPLOG",87,0)
 I IBIBDTYP="FILLED BY" S IBFLDNO=".211" G EDITIBD
"RTN","IBNCPLOG",88,0)
 I IBIBDTYP="COPAY" S IBFLDNO=".311" G EDITIBD
"RTN","IBNCPLOG",89,0)
 ; for environmental indicators:
"RTN","IBNCPLOG",90,0)
 ; if IBIBD("SC/EI OVR")=1 - the user overrides any answers (3)
"RTN","IBNCPLOG",91,0)
 ; if $G(IBIBD("SC/EI NO ANSW")) contains the IBIBDTYP - this question was not answered (2)
"RTN","IBNCPLOG",92,0)
 ; otherwise - use whatever in the IBVAL (0 - NO, 1 -YES)
"RTN","IBNCPLOG",93,0)
 I IBIBDTYP="AO" S IBFLDNO=".401",IBVAL=$S($G(IBIBD("SC/EI OVR"))=1:3,(","_$G(IBIBD("SC/EI NO ANSW"))_",")[(","_IBIBDTYP_","):2,1:IBVAL) G EDITIBD
"RTN","IBNCPLOG",94,0)
 I IBIBDTYP="CV" S IBFLDNO=".402",IBVAL=$S($G(IBIBD("SC/EI OVR"))=1:3,(","_$G(IBIBD("SC/EI NO ANSW"))_",")[(","_IBIBDTYP_","):2,1:IBVAL) G EDITIBD
"RTN","IBNCPLOG",95,0)
 I IBIBDTYP="SWA" S IBFLDNO=".403",IBVAL=$S($G(IBIBD("SC/EI OVR"))=1:3,(","_$G(IBIBD("SC/EI NO ANSW"))_",")[(","_IBIBDTYP_","):2,1:IBVAL) G EDITIBD
"RTN","IBNCPLOG",96,0)
 I IBIBDTYP="IR" S IBFLDNO=".404",IBVAL=$S($G(IBIBD("SC/EI OVR"))=1:3,(","_$G(IBIBD("SC/EI NO ANSW"))_",")[(","_IBIBDTYP_","):2,1:IBVAL) G EDITIBD
"RTN","IBNCPLOG",97,0)
 I IBIBDTYP="MST" S IBFLDNO=".405",IBVAL=$S($G(IBIBD("SC/EI OVR"))=1:3,(","_$G(IBIBD("SC/EI NO ANSW"))_",")[(","_IBIBDTYP_","):2,1:IBVAL) G EDITIBD
"RTN","IBNCPLOG",98,0)
 I IBIBDTYP="HNC" S IBFLDNO=".406",IBVAL=$S($G(IBIBD("SC/EI OVR"))=1:3,(","_$G(IBIBD("SC/EI NO ANSW"))_",")[(","_IBIBDTYP_","):2,1:IBVAL) G EDITIBD
"RTN","IBNCPLOG",99,0)
 I IBIBDTYP="SC" S IBFLDNO=".407",IBVAL=$S($G(IBIBD("SC/EI OVR"))=1:3,(","_$G(IBIBD("SC/EI NO ANSW"))_",")[(","_IBIBDTYP_","):2,1:IBVAL) G EDITIBD
"RTN","IBNCPLOG",100,0)
 I IBIBDTYP="SHAD" S IBFLDNO=".408",IBVAL=$S($G(IBIBD("SC/EI OVR"))=1:3,(","_$G(IBIBD("SC/EI NO ANSW"))_",")[(","_IBIBDTYP_","):2,1:IBVAL) G EDITIBD
"RTN","IBNCPLOG",101,0)
 I IBIBDTYP="BILL" S IBFLDNO=".301" G EDITIBD
"RTN","IBNCPLOG",102,0)
 I IBIBDTYP="BILLED" S IBFLDNO=".302" G EDITIBD
"RTN","IBNCPLOG",103,0)
 I IBIBDTYP="PLAN" S IBFLDNO=".303" G EDITIBD
"RTN","IBNCPLOG",104,0)
 I IBIBDTYP="COST" S IBFLDNO=".304" G EDITIBD
"RTN","IBNCPLOG",105,0)
 I IBIBDTYP="PAID" S IBFLDNO=".305" G EDITIBD
"RTN","IBNCPLOG",106,0)
 I IBIBDTYP="CLOSE COMMENT" S IBFLDNO=".306" G EDITIBD
"RTN","IBNCPLOG",107,0)
 I IBIBDTYP="REOPEN COMMENT" S IBFLDNO=".306" G EDITIBD
"RTN","IBNCPLOG",108,0)
 I IBIBDTYP="CLOSE REASON" S IBFLDNO=".307" G EDITIBD
"RTN","IBNCPLOG",109,0)
 I IBIBDTYP="DROP TO PAPER" S IBFLDNO=".308" G EDITIBD
"RTN","IBNCPLOG",110,0)
 I IBIBDTYP="RELEASE COPAY" S IBFLDNO=".309" G EDITIBD
"RTN","IBNCPLOG",111,0)
 I IBIBDTYP="USER" S IBFLDNO=".31" G EDITIBD
"RTN","IBNCPLOG",112,0)
 I IBIBDTYP="PRESCRIPTION" S IBFLDNO=".201" G EDITIBD
"RTN","IBNCPLOG",113,0)
 I IBIBDTYP="IEN" S IBFLDNO=".212" G EDITIBD
"RTN","IBNCPLOG",114,0)
 I IBIBDTYP="EPHARM" S IBFLDNO=".09" G EDITIBD
"RTN","IBNCPLOG",115,0)
 Q 0
"RTN","IBNCPLOG",116,0)
EDITIBD ;
"RTN","IBNCPLOG",117,0)
 Q +$$FILLFLDS^IBNCPUT1(366.141,IBFLDNO,IBRECNO_","_IBDTIEN,IBVAL)
"RTN","IBNCPLOG",118,0)
 ;------
"RTN","IBNCPLOG",119,0)
 ;to store IBD("INS") array data
"RTN","IBNCPLOG",120,0)
 ;input:
"RTN","IBNCPLOG",121,0)
 ;IBDARR - IBD array by reference
"RTN","IBNCPLOG",122,0)
 ;IBDTIEN -  ien on top [DATE] level
"RTN","IBNCPLOG",123,0)
 ;IBRECNO - ien in [EVENTS] multiple
"RTN","IBNCPLOG",124,0)
 ;output:
"RTN","IBNCPLOG",125,0)
 ; record number if success
"RTN","IBNCPLOG",126,0)
 ; 0 if failure
"RTN","IBNCPLOG",127,0)
INS(IBDARR,IBDTIEN,IBRECNO) ;
"RTN","IBNCPLOG",128,0)
 N IBSET1,IBSET2,IBSET3,IBFLDNO,IBINSNO,RECNO,IBVAL
"RTN","IBNCPLOG",129,0)
 S IBINSNO=0
"RTN","IBNCPLOG",130,0)
 F  S IBINSNO=$O(IBDARR("INS",IBINSNO)) Q:+IBINSNO=0  D
"RTN","IBNCPLOG",131,0)
 . S IBSET1=$G(IBDARR("INS",IBINSNO,1))
"RTN","IBNCPLOG",132,0)
 . S IBSET2=$G(IBDARR("INS",IBINSNO,2))
"RTN","IBNCPLOG",133,0)
 . S IBSET3=$G(IBDARR("INS",IBINSNO,3))
"RTN","IBNCPLOG",134,0)
 . S RECNO=$$ADDINS(IBDTIEN,IBRECNO)
"RTN","IBNCPLOG",135,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.02,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,1))
"RTN","IBNCPLOG",136,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.03,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,2))
"RTN","IBNCPLOG",137,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.04,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,3))
"RTN","IBNCPLOG",138,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.05,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,4))
"RTN","IBNCPLOG",139,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.06,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,5))
"RTN","IBNCPLOG",140,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.07,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,6))
"RTN","IBNCPLOG",141,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.08,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,7))
"RTN","IBNCPLOG",142,0)
 . ;
"RTN","IBNCPLOG",143,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.101,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,8))
"RTN","IBNCPLOG",144,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.102,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,9))
"RTN","IBNCPLOG",145,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.103,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,10))
"RTN","IBNCPLOG",146,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.104,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,11))
"RTN","IBNCPLOG",147,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.105,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,12))
"RTN","IBNCPLOG",148,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.106,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,13))
"RTN","IBNCPLOG",149,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.107,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET1,U,14))
"RTN","IBNCPLOG",150,0)
 . ;
"RTN","IBNCPLOG",151,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.201,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET2,U,1))
"RTN","IBNCPLOG",152,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.202,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET2,U,2))
"RTN","IBNCPLOG",153,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.203,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET2,U,3))
"RTN","IBNCPLOG",154,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.204,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET2,U,4))
"RTN","IBNCPLOG",155,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.205,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET2,U,5))
"RTN","IBNCPLOG",156,0)
 . ;
"RTN","IBNCPLOG",157,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.301,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET3,U,1))
"RTN","IBNCPLOG",158,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.302,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET3,U,2))
"RTN","IBNCPLOG",159,0)
 . I +$$FILLFLDS^IBNCPUT1(366.1412,.303,RECNO_","_IBRECNO_","_IBDTIEN,$P(IBSET3,U,3))
"RTN","IBNCPLOG",160,0)
 Q RECNO
"RTN","IBNCPLOG",161,0)
 ;create top level entry in #366.14
"RTN","IBNCPLOG",162,0)
 ;input:
"RTN","IBNCPLOG",163,0)
 ; IBDATE - date in FileMan format
"RTN","IBNCPLOG",164,0)
 ;output
"RTN","IBNCPLOG",165,0)
 ; returns ien created
"RTN","IBNCPLOG",166,0)
ADDDATE(IBDATE) ;
"RTN","IBNCPLOG",167,0)
 N IBIEN
"RTN","IBNCPLOG",168,0)
 S IBIEN=+$O(^IBCNR(366.14,"B",IBDATE,0))
"RTN","IBNCPLOG",169,0)
 I IBIEN>0 Q IBIEN
"RTN","IBNCPLOG",170,0)
 I $$INSITEM^IBNCPUT1(366.14,"",IBDATE,"")
"RTN","IBNCPLOG",171,0)
 Q +$O(^IBCNR(366.14,"B",IBDATE,0))
"RTN","IBNCPLOG",172,0)
 ;
"RTN","IBNCPLOG",173,0)
 ;create EVENT entry in #366.14
"RTN","IBNCPLOG",174,0)
 ;input:
"RTN","IBNCPLOG",175,0)
 ;IBIEN - ien on top [DATE] level
"RTN","IBNCPLOG",176,0)
 ;EVNTTYPE event type (value for .01)
"RTN","IBNCPLOG",177,0)
 ;returns ien for the event
"RTN","IBNCPLOG",178,0)
 ;or 0 if failed
"RTN","IBNCPLOG",179,0)
NEWEVENT(IBIEN,EVNTTYPE) ;
"RTN","IBNCPLOG",180,0)
 N EVNTRECN
"RTN","IBNCPLOG",181,0)
 S EVNTRECN=$$INSITEM^IBNCPUT1(366.141,IBIEN,$$EXT2INT^IBNCPUT1(EVNTTYPE),"","")
"RTN","IBNCPLOG",182,0)
 I EVNTRECN>0 Q EVNTRECN
"RTN","IBNCPLOG",183,0)
 Q 0
"RTN","IBNCPLOG",184,0)
 ;
"RTN","IBNCPLOG",185,0)
 ;add insurance node
"RTN","IBNCPLOG",186,0)
 ;IBDTIEN - ien on top [DATE] level
"RTN","IBNCPLOG",187,0)
 ;IBEVIEN - ien in [EVENTS] multiple
"RTN","IBNCPLOG",188,0)
 ;returns :
"RTN","IBNCPLOG",189,0)
 ; new ien in INSURANCE multiple
"RTN","IBNCPLOG",190,0)
ADDINS(IBDTIEN,IBEVIEN) ;
"RTN","IBNCPLOG",191,0)
 N IBX,IBX2
"RTN","IBNCPLOG",192,0)
 F IBX=1:1:99999 I '$D(^IBCNR(366.14,IBDTIEN,1,IBEVIEN,5,IBX)) D  Q
"RTN","IBNCPLOG",193,0)
 . S IBX2=$$INSITEM^IBNCPUT1(366.1412,IBEVIEN_","_IBDTIEN,IBX,IBX)
"RTN","IBNCPLOG",194,0)
 Q +$O(^IBCNR(366.14,IBDTIEN,1,IBEVIEN,5,"B",IBX,0))
"RTN","IBNCPLOG",195,0)
 ;
"RTN","IBRXUTL")
0^9^B74176189^B74287218
"RTN","IBRXUTL",1,0)
IBRXUTL ;ALB/MAF - PHARMACY API CALLS ;1/9/08  14:45
"RTN","IBRXUTL",2,0)
 ;;2.0;INTEGRATED BILLING;**309,347,383**;21-MAR-94;Build 11
"RTN","IBRXUTL",3,0)
 ;
"RTN","IBRXUTL",4,0)
ZERO(IBDRV) ;
"RTN","IBRXUTL",5,0)
 N X
"RTN","IBRXUTL",6,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBRXUTL",7,0)
 S X="IBDRUG" D ZERO^PSS50(IBDRV,,,,,X)
"RTN","IBRXUTL",8,0)
 Q
"RTN","IBRXUTL",9,0)
DATA(IBDRV) ;
"RTN","IBRXUTL",10,0)
 N X
"RTN","IBRXUTL",11,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBRXUTL",12,0)
 S X="IBDRUG" D DATA^PSS50(IBDRV,,,,,X)
"RTN","IBRXUTL",13,0)
 Q
"RTN","IBRXUTL",14,0)
FILE(DA,DR,INTEXT) ;Returns single field from file 52
"RTN","IBRXUTL",15,0)
 N RETURN,PSOFILE
"RTN","IBRXUTL",16,0)
 I '$G(DA) S RETURN="" Q RETURN
"RTN","IBRXUTL",17,0)
 I '$G(DR) S RETURN="" Q RETURN
"RTN","IBRXUTL",18,0)
 S PSOFILE=52
"RTN","IBRXUTL",19,0)
 S DA=+DA
"RTN","IBRXUTL",20,0)
 I $G(INTEXT)="" S INTEXT="I"
"RTN","IBRXUTL",21,0)
 S RETURN=$$GET1^PSODI(PSOFILE,DA,DR,INTEXT)
"RTN","IBRXUTL",22,0)
 I $P($G(RETURN),"^",1)=0 S RETURN="" Q RETURN
"RTN","IBRXUTL",23,0)
 Q $P(RETURN,"^",2)
"RTN","IBRXUTL",24,0)
SUBFILE(DA,DASUB,DR,DRSUB,INTEXT) ;Returns single field from subfile 52.1
"RTN","IBRXUTL",25,0)
 ;The DR variable isn't being used because Pharmacy API changed after IB*2.0*347 went
"RTN","IBRXUTL",26,0)
 ;to test site. Rather than changing all the routines that call this API this
"RTN","IBRXUTL",27,0)
 ;input variable is now not used.
"RTN","IBRXUTL",28,0)
 N RETSUB,PSOFILE,IENS
"RTN","IBRXUTL",29,0)
 I '$G(DA) S RETSUB="" Q RETSUB
"RTN","IBRXUTL",30,0)
 I '$G(DASUB) S RETSUB="" Q RETSUB
"RTN","IBRXUTL",31,0)
 I '$G(DRSUB) S RETSUB="" Q RETSUB
"RTN","IBRXUTL",32,0)
 S PSOFILE=52.1
"RTN","IBRXUTL",33,0)
 S IENS=+DASUB_","_+DA
"RTN","IBRXUTL",34,0)
 I $G(INTEXT)="" S INTEXT="I"
"RTN","IBRXUTL",35,0)
 S RETSUB=$$GET1^PSODI(PSOFILE,IENS,DRSUB,INTEXT)
"RTN","IBRXUTL",36,0)
 I $P($G(RETSUB),"^",1)=0 S RETSUB="" Q RETSUB
"RTN","IBRXUTL",37,0)
 Q $P(RETSUB,"^",2)
"RTN","IBRXUTL",38,0)
RXZERO(PDFN,RXIEN) ;Returns zero node of file 52
"RTN","IBRXUTL",39,0)
 N ZEROOUT,LIST,IBTMPARR,NODE
"RTN","IBRXUTL",40,0)
 I '$G(PDFN) S ZEROOUT="" Q ZEROOUT
"RTN","IBRXUTL",41,0)
 I '$G(RXIEN) S ZEROOUT="" Q ZEROOUT
"RTN","IBRXUTL",42,0)
 S NODE=0
"RTN","IBRXUTL",43,0)
 S LIST="IBZEROARR"
"RTN","IBRXUTL",44,0)
 S IBTMPARR="IBTMPZERO"
"RTN","IBRXUTL",45,0)
 D RX^PSO52API(PDFN,LIST,RXIEN,,NODE,,)
"RTN","IBRXUTL",46,0)
 I $P(^TMP($J,LIST,PDFN,0),"^",1)>0  D
"RTN","IBRXUTL",47,0)
 .S $P(^TMP($J,IBTMPARR),"^",1)=$G(^TMP($J,LIST,PDFN,RXIEN,.01))
"RTN","IBRXUTL",48,0)
 .S $P(^TMP($J,IBTMPARR),"^",2)=$P($G(^TMP($J,LIST,PDFN,RXIEN,2)),"^",1)
"RTN","IBRXUTL",49,0)
 .S $P(^TMP($J,IBTMPARR),"^",3)=$P($G(^TMP($J,LIST,PDFN,RXIEN,3)),"^",1)
"RTN","IBRXUTL",50,0)
 .S $P(^TMP($J,IBTMPARR),"^",4)=$P($G(^TMP($J,LIST,PDFN,RXIEN,4)),"^",1)
"RTN","IBRXUTL",51,0)
 .S $P(^TMP($J,IBTMPARR),"^",5)=$P($G(^TMP($J,LIST,PDFN,RXIEN,5)),"^",1)
"RTN","IBRXUTL",52,0)
 .S $P(^TMP($J,IBTMPARR),"^",6)=$P($G(^TMP($J,LIST,PDFN,RXIEN,6)),"^",1)
"RTN","IBRXUTL",53,0)
 .S $P(^TMP($J,IBTMPARR),"^",7)=$G(^TMP($J,LIST,PDFN,RXIEN,7))
"RTN","IBRXUTL",54,0)
 .S $P(^TMP($J,IBTMPARR),"^",8)=$G(^TMP($J,LIST,PDFN,RXIEN,8))
"RTN","IBRXUTL",55,0)
 .S $P(^TMP($J,IBTMPARR),"^",9)=$G(^TMP($J,LIST,PDFN,RXIEN,9))
"RTN","IBRXUTL",56,0)
 .S $P(^TMP($J,IBTMPARR),"^",10)=""
"RTN","IBRXUTL",57,0)
 .S $P(^TMP($J,IBTMPARR),"^",11)=$P($G(^TMP($J,LIST,PDFN,RXIEN,11)),"^",1)
"RTN","IBRXUTL",58,0)
 .S $P(^TMP($J,IBTMPARR),"^",12)=""
"RTN","IBRXUTL",59,0)
 .S $P(^TMP($J,IBTMPARR),"^",13)=$P($G(^TMP($J,LIST,PDFN,RXIEN,1)),"^",1)
"RTN","IBRXUTL",60,0)
 .S $P(^TMP($J,IBTMPARR),"^",14)=""
"RTN","IBRXUTL",61,0)
 .S $P(^TMP($J,IBTMPARR),"^",15)=""
"RTN","IBRXUTL",62,0)
 .S $P(^TMP($J,IBTMPARR),"^",16)=$P($G(^TMP($J,LIST,PDFN,RXIEN,16)),"^",1)
"RTN","IBRXUTL",63,0)
 .S $P(^TMP($J,IBTMPARR),"^",17)=$G(^TMP($J,LIST,PDFN,RXIEN,17))
"RTN","IBRXUTL",64,0)
 .S $P(^TMP($J,IBTMPARR),"^",18)=$G(^TMP($J,LIST,PDFN,RXIEN,10.6))
"RTN","IBRXUTL",65,0)
 .S $P(^TMP($J,IBTMPARR),"^",19)=$P($G(^TMP($J,LIST,PDFN,RXIEN,10.3)),"^",1)
"RTN","IBRXUTL",66,0)
 .S ZEROOUT=^TMP($J,IBTMPARR)
"RTN","IBRXUTL",67,0)
 .K ^TMP($J,IBTMPARR)
"RTN","IBRXUTL",68,0)
 E  S ZEROOUT=""
"RTN","IBRXUTL",69,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",70,0)
 Q ZEROOUT
"RTN","IBRXUTL",71,0)
RXSEC(PDFN,RXIEN) ;Returns second node of file 52
"RTN","IBRXUTL",72,0)
 N SECOUT,LIST,IBTMPARR,NODE
"RTN","IBRXUTL",73,0)
 I '$G(PDFN) S SECOUT="" Q SECOUT
"RTN","IBRXUTL",74,0)
 I '$G(RXIEN) S SECOUT="" Q SECOUT
"RTN","IBRXUTL",75,0)
 S NODE=2
"RTN","IBRXUTL",76,0)
 S LIST="IBSECARR"
"RTN","IBRXUTL",77,0)
 S IBTMPARR="IBTMPSEC"
"RTN","IBRXUTL",78,0)
 D RX^PSO52API(PDFN,LIST,RXIEN,,NODE,,)
"RTN","IBRXUTL",79,0)
 I $P(^TMP($J,LIST,PDFN,0),"^",1)>0  D
"RTN","IBRXUTL",80,0)
 .S $P(^TMP($J,IBTMPARR),"^",1)=$P($G(^TMP($J,LIST,PDFN,RXIEN,21)),"^",1)
"RTN","IBRXUTL",81,0)
 .S $P(^TMP($J,IBTMPARR),"^",2)=$P($G(^TMP($J,LIST,PDFN,RXIEN,22)),"^",1)
"RTN","IBRXUTL",82,0)
 .S $P(^TMP($J,IBTMPARR),"^",3)=$P($G(^TMP($J,LIST,PDFN,RXIEN,23)),"^",1)
"RTN","IBRXUTL",83,0)
 .S $P(^TMP($J,IBTMPARR),"^",4)=$G(^TMP($J,LIST,PDFN,RXIEN,24))
"RTN","IBRXUTL",84,0)
 .S $P(^TMP($J,IBTMPARR),"^",5)=$P($G(^TMP($J,LIST,PDFN,RXIEN,25)),"^",1)
"RTN","IBRXUTL",85,0)
 .S $P(^TMP($J,IBTMPARR),"^",6)=$P($G(^TMP($J,LIST,PDFN,RXIEN,26)),"^",1)
"RTN","IBRXUTL",86,0)
 .S $P(^TMP($J,IBTMPARR),"^",7)=$G(^TMP($J,LIST,PDFN,RXIEN,27))
"RTN","IBRXUTL",87,0)
 .S $P(^TMP($J,IBTMPARR),"^",8)=$G(^TMP($J,LIST,PDFN,RXIEN,28))
"RTN","IBRXUTL",88,0)
 .S $P(^TMP($J,IBTMPARR),"^",9)=$P($G(^TMP($J,LIST,PDFN,RXIEN,20)),"^",1)
"RTN","IBRXUTL",89,0)
 .S $P(^TMP($J,IBTMPARR),"^",10)=$P($G(^TMP($J,LIST,PDFN,RXIEN,104)),"^",1)
"RTN","IBRXUTL",90,0)
 .S $P(^TMP($J,IBTMPARR),"^",11)=$P($G(^TMP($J,LIST,PDFN,RXIEN,29)),"^",1)
"RTN","IBRXUTL",91,0)
 .S $P(^TMP($J,IBTMPARR),"^",12)=$G(^TMP($J,LIST,PDFN,RXIEN,30))
"RTN","IBRXUTL",92,0)
 .S $P(^TMP($J,IBTMPARR),"^",13)=$P($G(^TMP($J,LIST,PDFN,RXIEN,31)),"^",1)
"RTN","IBRXUTL",93,0)
 .S $P(^TMP($J,IBTMPARR),"^",14)=$P($G(^TMP($J,LIST,PDFN,RXIEN,32.2)),"^",1)
"RTN","IBRXUTL",94,0)
 .S $P(^TMP($J,IBTMPARR),"^",15)=$P($G(^TMP($J,LIST,PDFN,RXIEN,32.1)),"^",1)
"RTN","IBRXUTL",95,0)
 .S $P(^TMP($J,IBTMPARR),"^",16)=$G(^TMP($J,LIST,PDFN,RXIEN,32.3))
"RTN","IBRXUTL",96,0)
 .S SECOUT=^TMP($J,IBTMPARR)
"RTN","IBRXUTL",97,0)
 .K ^TMP($J,IBTMPARR)
"RTN","IBRXUTL",98,0)
 E  S SECOUT=""
"RTN","IBRXUTL",99,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",100,0)
 Q SECOUT
"RTN","IBRXUTL",101,0)
RX3(PDFN,RXIEN) ;Returns third node of file 52
"RTN","IBRXUTL",102,0)
 N THRDOUT,LIST,IBTMPARR,NODE
"RTN","IBRXUTL",103,0)
 I '$G(PDFN) S THRDOUT="" Q THRDOUT
"RTN","IBRXUTL",104,0)
 I '$G(RXIEN) S THRDOUT="" Q THRDOUT
"RTN","IBRXUTL",105,0)
 S NODE=3
"RTN","IBRXUTL",106,0)
 S LIST="IBARRTHRD"
"RTN","IBRXUTL",107,0)
 S IBTMPARR="IBTMP3"
"RTN","IBRXUTL",108,0)
 D RX^PSO52API(PDFN,LIST,RXIEN,,NODE,,)
"RTN","IBRXUTL",109,0)
 I $P(^TMP($J,LIST,PDFN,0),"^",1)>0  D
"RTN","IBRXUTL",110,0)
 .S $P(^TMP($J,IBTMPARR),"^",1)=$P($G(^TMP($J,LIST,PDFN,RXIEN,101)),"^",1)
"RTN","IBRXUTL",111,0)
 .S $P(^TMP($J,IBTMPARR),"^",2)=$P($G(^TMP($J,LIST,PDFN,RXIEN,102)),"^",1)
"RTN","IBRXUTL",112,0)
 .S $P(^TMP($J,IBTMPARR),"^",3)=$P($G(^TMP($J,LIST,PDFN,RXIEN,109)),"^",1)
"RTN","IBRXUTL",113,0)
 .S $P(^TMP($J,IBTMPARR),"^",4)=$P($G(^TMP($J,LIST,PDFN,RXIEN,102.1)),"^",1)
"RTN","IBRXUTL",114,0)
 .S $P(^TMP($J,IBTMPARR),"^",5)=$P($G(^TMP($J,LIST,PDFN,RXIEN,26.1)),"^",1)
"RTN","IBRXUTL",115,0)
 .S $P(^TMP($J,IBTMPARR),"^",6)=$P($G(^TMP($J,LIST,PDFN,RXIEN,34.1)),"^",1)
"RTN","IBRXUTL",116,0)
 .S $P(^TMP($J,IBTMPARR),"^",7)=$G(^TMP($J,LIST,PDFN,RXIEN,12))
"RTN","IBRXUTL",117,0)
 .S $P(^TMP($J,IBTMPARR),"^",8)=$G(^TMP($J,LIST,PDFN,RXIEN,102.2))
"RTN","IBRXUTL",118,0)
 .S $P(^TMP($J,IBTMPARR),"^",9)=$G(^TMP($J,LIST,PDFN,RXIEN,112))
"RTN","IBRXUTL",119,0)
 .S THRDOUT=^TMP($J,IBTMPARR)
"RTN","IBRXUTL",120,0)
 .K ^TMP($J,IBTMPARR)
"RTN","IBRXUTL",121,0)
 E  S THRDOUT=""
"RTN","IBRXUTL",122,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",123,0)
 Q THRDOUT
"RTN","IBRXUTL",124,0)
ZEROSUB(PDFN,RXIEN,RXSUB) ;Returns zero node of subfile 52.1
"RTN","IBRXUTL",125,0)
 N ZSUBOUT,LIST,IBTMPARR,NODE
"RTN","IBRXUTL",126,0)
 I '$G(PDFN) S ZSUBOUT="" Q ZSUBOUT
"RTN","IBRXUTL",127,0)
 I '$G(RXIEN) S ZSUBOUT="" Q ZSUBOUT
"RTN","IBRXUTL",128,0)
 I '$G(RXSUB) S ZSUBOUT="" Q ZSUBOUT
"RTN","IBRXUTL",129,0)
 S NODE="R^^"_RXSUB
"RTN","IBRXUTL",130,0)
 S LIST="IBSUBARR"
"RTN","IBRXUTL",131,0)
 S IBTMPARR="IBTMPSUB"
"RTN","IBRXUTL",132,0)
 D RX^PSO52API(PDFN,LIST,RXIEN,,NODE,,)
"RTN","IBRXUTL",133,0)
 I $P(^TMP($J,LIST,PDFN,RXIEN,"RF",0),"^",1)>0  D
"RTN","IBRXUTL",134,0)
 .S $P(^TMP($J,IBTMPARR),"^",1)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,.01)),"^",1)
"RTN","IBRXUTL",135,0)
 .S $P(^TMP($J,IBTMPARR),"^",2)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,2)),"^",1)
"RTN","IBRXUTL",136,0)
 .S $P(^TMP($J,IBTMPARR),"^",3)=$G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,3))
"RTN","IBRXUTL",137,0)
 .S $P(^TMP($J,IBTMPARR),"^",4)=$G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,1))
"RTN","IBRXUTL",138,0)
 .S $P(^TMP($J,IBTMPARR),"^",5)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,4)),"^",1)
"RTN","IBRXUTL",139,0)
 .S $P(^TMP($J,IBTMPARR),"^",6)=$G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,5))
"RTN","IBRXUTL",140,0)
 .S $P(^TMP($J,IBTMPARR),"^",7)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,6)),"^",1)
"RTN","IBRXUTL",141,0)
 .S $P(^TMP($J,IBTMPARR),"^",8)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,7)),"^",1)
"RTN","IBRXUTL",142,0)
 .S $P(^TMP($J,IBTMPARR),"^",9)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,8)),"^",1)
"RTN","IBRXUTL",143,0)
 .S $P(^TMP($J,IBTMPARR),"^",10)=$G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,1.1))
"RTN","IBRXUTL",144,0)
 .S $P(^TMP($J,IBTMPARR),"^",11)=$G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,1.2))
"RTN","IBRXUTL",145,0)
 .S $P(^TMP($J,IBTMPARR),"^",12)=""
"RTN","IBRXUTL",146,0)
 .S $P(^TMP($J,IBTMPARR),"^",13)=""
"RTN","IBRXUTL",147,0)
 .S $P(^TMP($J,IBTMPARR),"^",14)=$G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,12))
"RTN","IBRXUTL",148,0)
 .S $P(^TMP($J,IBTMPARR),"^",15)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,13)),"^",1)
"RTN","IBRXUTL",149,0)
 .S $P(^TMP($J,IBTMPARR),"^",16)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,14)),"^",1)
"RTN","IBRXUTL",150,0)
 .S $P(^TMP($J,IBTMPARR),"^",17)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,15)),"^",1)
"RTN","IBRXUTL",151,0)
 .S $P(^TMP($J,IBTMPARR),"^",18)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,17)),"^",1)
"RTN","IBRXUTL",152,0)
 .S $P(^TMP($J,IBTMPARR),"^",19)=$P($G(^TMP($J,LIST,PDFN,RXIEN,"RF",RXSUB,10.1)),"^",1)
"RTN","IBRXUTL",153,0)
 .S ZSUBOUT=^TMP($J,IBTMPARR)
"RTN","IBRXUTL",154,0)
 .K ^TMP($J,IBTMPARR)
"RTN","IBRXUTL",155,0)
 E  S ZSUBOUT=""
"RTN","IBRXUTL",156,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",157,0)
 Q ZSUBOUT
"RTN","IBRXUTL",158,0)
RFNUM(RXIEN) ;
"RTN","IBRXUTL",159,0)
 N PDFN,RXSUB,LIST,IBTMPARR,NODE
"RTN","IBRXUTL",160,0)
 I '$G(RXIEN) S RXSUB="" Q RXSUB
"RTN","IBRXUTL",161,0)
 S PDFN=$$FILE^IBRXUTL(RXIEN,2)
"RTN","IBRXUTL",162,0)
 S LIST="IBRFNARR"
"RTN","IBRXUTL",163,0)
 S IBTMPARR="IBTMPRFN"
"RTN","IBRXUTL",164,0)
 S NODE="R"
"RTN","IBRXUTL",165,0)
 D RX^PSO52API(PDFN,LIST,RXIEN,,NODE,,)
"RTN","IBRXUTL",166,0)
 I $P(^TMP($J,LIST,PDFN,RXIEN,"RF",0),"^",1)>0  D
"RTN","IBRXUTL",167,0)
 .S RXSUB=^TMP($J,LIST,PDFN,RXIEN,"RF",0)
"RTN","IBRXUTL",168,0)
 E  S RXSUB=""
"RTN","IBRXUTL",169,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",170,0)
 Q RXSUB
"RTN","IBRXUTL",171,0)
IBND(DFN,RXIEN) ;Returns IB node
"RTN","IBRXUTL",172,0)
 N IBNDOUT,LIST,NODE,IBTMPARR
"RTN","IBRXUTL",173,0)
 I '$G(DFN) S IBNDOUT="" Q IBNDOUT
"RTN","IBRXUTL",174,0)
 I '$G(RXIEN) S IBNDOUT="" Q IBNDOUT
"RTN","IBRXUTL",175,0)
 S LIST="IBIBNDARR"
"RTN","IBRXUTL",176,0)
 S NODE="I^O"
"RTN","IBRXUTL",177,0)
 S IBTMPARR="IBTMPIBND"
"RTN","IBRXUTL",178,0)
 D RX^PSO52API(DFN,LIST,RXIEN,,NODE,,)
"RTN","IBRXUTL",179,0)
 I $P(^TMP($J,LIST,DFN,0),"^",1)>0  D
"RTN","IBRXUTL",180,0)
 .S $P(^TMP($J,IBTMPARR),"^",1)=$P($G(^TMP($J,LIST,DFN,RXIEN,105)),"^",1)
"RTN","IBRXUTL",181,0)
 .S $P(^TMP($J,IBTMPARR),"^",2)=$P($G(^TMP($J,LIST,DFN,RXIEN,106)),"^",1)
"RTN","IBRXUTL",182,0)
 .S $P(^TMP($J,IBTMPARR),"^",3)=$G(^TMP($J,LIST,DFN,RXIEN,106.5))
"RTN","IBRXUTL",183,0)
 .S $P(^TMP($J,IBTMPARR),"^",4)=$G(^TMP($J,LIST,DFN,RXIEN,106.6))
"RTN","IBRXUTL",184,0)
 .S IBNDOUT=^TMP($J,IBTMPARR)
"RTN","IBRXUTL",185,0)
 .S:IBNDOUT="^^^" IBNDOUT=""
"RTN","IBRXUTL",186,0)
 .K ^TMP($J,IBTMPARR)
"RTN","IBRXUTL",187,0)
 E  S IBNDOUT=""
"RTN","IBRXUTL",188,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",189,0)
 Q IBNDOUT
"RTN","IBRXUTL",190,0)
IBNDFL(DFN,RXIEN,RXRFL) ;
"RTN","IBRXUTL",191,0)
 N IBNDFL,LIST,NODE,IBTMPARR
"RTN","IBRXUTL",192,0)
 I '$G(DFN) S IBNDFL="" Q IBNDFL
"RTN","IBRXUTL",193,0)
 I '$G(RXIEN) S IBNDFL="" Q IBNDFL
"RTN","IBRXUTL",194,0)
 I '$G(RXRFL) S IBNDFL="" Q IBNDFL
"RTN","IBRXUTL",195,0)
 S LIST="IBIBNDFLARR"
"RTN","IBRXUTL",196,0)
 S NODE="I^R^"_RXRFL
"RTN","IBRXUTL",197,0)
 S IBTMPARR="IBTMPIBNDFL"
"RTN","IBRXUTL",198,0)
 D RX^PSO52API(DFN,LIST,RXIEN,,NODE,,)
"RTN","IBRXUTL",199,0)
 I ^TMP($J,LIST,DFN,RXIEN,"IB",0)>0  D
"RTN","IBRXUTL",200,0)
 .S $P(^TMP($J,IBTMPARR),"^",1)=$G(^TMP($J,LIST,DFN,RXIEN,"IB",RXRFL,9))
"RTN","IBRXUTL",201,0)
 .S $P(^TMP($J,IBTMPARR),"^",2)=$G(^TMP($J,LIST,DFN,RXIEN,"IB",RXRFL,9.1))
"RTN","IBRXUTL",202,0)
 .S IBNDFL=^TMP($J,IBTMPARR)
"RTN","IBRXUTL",203,0)
 .K ^TMP($J,IBTMPARR)
"RTN","IBRXUTL",204,0)
 E  S IBNDFL=""
"RTN","IBRXUTL",205,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",206,0)
 Q IBNDFL
"RTN","IBRXUTL",207,0)
 ;
"RTN","IBRXUTL",208,0)
RFLNUM(IBRXN,FLDT,IBFLG) ; find the refill number in file 52 for the given date
"RTN","IBRXUTL",209,0)
 N NUMOUT,NUM,DFN,LIST,NODE
"RTN","IBRXUTL",210,0)
 I '$G(IBRXN) S NUMOUT="" Q NUMOUT
"RTN","IBRXUTL",211,0)
 I '$G(FLDT) S NUMOUT="" Q NUMOUT
"RTN","IBRXUTL",212,0)
 S LIST="IBRTMP"
"RTN","IBRXUTL",213,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",214,0)
 S NUM=0
"RTN","IBRXUTL",215,0)
 S DFN=$$FILE(IBRXN,2)
"RTN","IBRXUTL",216,0)
 S NODE="R^^"
"RTN","IBRXUTL",217,0)
 D RX^PSO52API(DFN,LIST,IBRXN,,NODE,,)
"RTN","IBRXUTL",218,0)
 F  S NUM=$O(^TMP($J,LIST,DFN,IBRXN,"RF",NUM)) Q:'NUM  D
"RTN","IBRXUTL",219,0)
 .I $P(^TMP($J,LIST,DFN,IBRXN,"RF",NUM,.01),"^",1)=FLDT S NUMOUT=NUM
"RTN","IBRXUTL",220,0)
 K ^TMP($J,LIST)
"RTN","IBRXUTL",221,0)
 S:'$G(NUMOUT) NUMOUT=""
"RTN","IBRXUTL",222,0)
 Q NUMOUT
"SEC","^DIC",366.15,366.15,0,"AUDIT")
@
"SEC","^DIC",366.15,366.15,0,"DD")
@
"SEC","^DIC",366.15,366.15,0,"DEL")
@
"SEC","^DIC",366.15,366.15,0,"LAYGO")
@
"SEC","^DIC",366.15,366.15,0,"RD")
@
"SEC","^DIC",366.15,366.15,0,"WR")
@
"UP",366.14,366.141,-1)
366.14^1
"UP",366.14,366.141,0)
366.141
"VER")
8.0^22.0
"^DD",366.14,366.141,.311,0)
COPAY AMOUNT^NJ9,2^^3;11^S:X["$" X=$P(X,"$",2) K:X'?.N.1".".2N!(X>999999.99)!(X<0)!(X?.E1"."3.N) X
"^DD",366.14,366.141,.311,3)
Enter the copay amount to be billed as specified by the payer.
"^DD",366.14,366.141,.311,21,0)
^^2^2^3080305^
"^DD",366.14,366.141,.311,21,1,0)
This is to store the copayment amount specified by the payer for amounts 
"^DD",366.14,366.141,.311,21,2,0)
that are to be charge for non-Veteran copayment charges such as Tricare.
"^DD",366.14,366.141,.311,"DT")
3080305
"^DD",366.15,366.15,0)
FIELD^^.04^4
"^DD",366.15,366.15,0,"DDA")
N
"^DD",366.15,366.15,0,"DT")
3071016
"^DD",366.15,366.15,0,"IX","B",366.15,.01)

"^DD",366.15,366.15,0,"NM","IB NCPDP PRESCRIPTION")

"^DD",366.15,366.15,.01,0)
PRESCRIPTION REFERENCE^RF^^0;1^K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X
"^DD",366.15,366.15,.01,1,0)
^.1
"^DD",366.15,366.15,.01,1,1,0)
366.15^B
"^DD",366.15,366.15,.01,1,1,1)
S ^IBCNR(366.15,"B",$E(X,1,30),DA)=""
"^DD",366.15,366.15,.01,1,1,2)
K ^IBCNR(366.15,"B",$E(X,1,30),DA)
"^DD",366.15,366.15,.01,3)
Enter the prescription reference
"^DD",366.15,366.15,.01,21,0)
^^3^3^3071016^
"^DD",366.15,366.15,.01,21,1,0)
This prescription reference consists of two semi-colon pieces.  The first 
"^DD",366.15,366.15,.01,21,2,0)
piece is the ien from file 52.  The second piece is the fill/refill 
"^DD",366.15,366.15,.01,21,3,0)
number, with 0 being the initial fill.
"^DD",366.15,366.15,.01,"DT")
3071016
"^DD",366.15,366.15,.02,0)
RATE ELIGIBILITY DETERMINED^F^^0;2^K:$L(X)>1!($L(X)<1) X
"^DD",366.15,366.15,.02,3)
Enter the Eligibility Determination for this Rx/Patient
"^DD",366.15,366.15,.02,21,0)
^^4^4^3071016^
"^DD",366.15,366.15,.02,21,1,0)
This is the Patient Rx/Eligibility determination indicator.  This is the
"^DD",366.15,366.15,.02,21,2,0)
flag returned back to ECME/Pharmacy to indicate what eligibility was
"^DD",366.15,366.15,.02,21,3,0)
determined for this prescription.  This may effect if a medication can be
"^DD",366.15,366.15,.02,21,4,0)
dispensed to the patient if they are not returned as a V (veteran).
"^DD",366.15,366.15,.02,"DT")
3071016
"^DD",366.15,366.15,.03,0)
RATE TYPE DETERMINED^P399.3'^DGCR(399.3,^0;3^Q
"^DD",366.15,366.15,.03,3)
Enter the Rate Type determined
"^DD",366.15,366.15,.03,21,0)
^^2^2^3071016^
"^DD",366.15,366.15,.03,21,1,0)
This is the Rate Type that was determined at the time of the billable
"^DD",366.15,366.15,.03,21,2,0)
check to be used on the bill when the bill is created.
"^DD",366.15,366.15,.03,"DT")
3071016
"^DD",366.15,366.15,.04,0)
COPAYMENT CHARGE^P350'^IB(^0;4^Q
"^DD",366.15,366.15,.04,3)
Enter the copayment charge associated with this NCPDP event
"^DD",366.15,366.15,.04,21,0)
^^3^3^3071016^
"^DD",366.15,366.15,.04,21,1,0)
This is the copayment charge that was created in association with this
"^DD",366.15,366.15,.04,21,2,0)
billing event. This is used to reverse previously billed copayment
"^DD",366.15,366.15,.04,21,3,0)
charges.
"^DD",366.15,366.15,.04,"DT")
3071016
"^DIC",366.15,366.15,0)
IB NCPDP PRESCRIPTION^366.15
"^DIC",366.15,366.15,0,"GL")
^IBCNR(366.15,
"^DIC",366.15,366.15,"%",0)
^1.005^^
"^DIC",366.15,366.15,"%D",0)
^^14^14^3080228^
"^DIC",366.15,366.15,"%D",1,0)
DO NOT delete entries in this file.  DO NOT edit data in this file with VA
"^DIC",366.15,366.15,"%D",2,0)
File Manager.
"^DIC",366.15,366.15,"%D",3,0)
 
"^DIC",366.15,366.15,"%D",4,0)
This file is used to support NCPDP billing for multiple Rate Types.  
"^DIC",366.15,366.15,"%D",5,0)
Entries are created in this file based on the prescription and 
"^DIC",366.15,366.15,"%D",6,0)
fill/refill number.  The Rate Type determined at time of Billing 
"^DIC",366.15,366.15,"%D",7,0)
Determination is stored in this file so it can be utilized when bill 
"^DIC",366.15,366.15,"%D",8,0)
creation occurs.  This file is also used to store the associated 
"^DIC",366.15,366.15,"%D",9,0)
copayment reference number if a non-veteran copayment charge is created 
"^DIC",366.15,366.15,"%D",10,0)
to allow easy lookup if the copayment charge needs to be cancelled.
"^DIC",366.15,366.15,"%D",11,0)
 
"^DIC",366.15,366.15,"%D",12,0)
 
"^DIC",366.15,366.15,"%D",13,0)
Per VHA Directive 2004-038, this file definition should not be
"^DIC",366.15,366.15,"%D",14,0)
modified.  
"^DIC",366.15,"B","IB NCPDP PRESCRIPTION",366.15)

"BLD",7432,6)
^368
**END**
**END**

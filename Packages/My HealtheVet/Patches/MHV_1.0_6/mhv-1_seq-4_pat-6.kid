Released MHV*1*6 SEQ #4
Extracted from mail message
**KIDS**:MHV*1.0*6^

**INSTALL NAME**
MHV*1.0*6
"BLD",7022,0)
MHV*1.0*6^My HealtheVet^0^3080925^y
"BLD",7022,1,0)
^^8^8^3080814^
"BLD",7022,1,1,0)
Summary
"BLD",7022,1,2,0)
-------
"BLD",7022,1,3,0)
MHV*1*6 delivers the HL7 interfaces needed to support Secure Messaging.  
"BLD",7022,1,4,0)
There are nine new queries in the MHV namespace that support the 
"BLD",7022,1,5,0)
administration and daily operation of the Secure Messaging enterprise 
"BLD",7022,1,6,0)
system. MHV*1*6 installs the components necessary to execute the admin
"BLD",7022,1,7,0)
queries to retrieve information on patients, providers, clinics, and
"BLD",7022,1,8,0)
teams.
"BLD",7022,4,0)
^9.64PA^^0
"BLD",7022,6)
6^
"BLD",7022,6.3)
82
"BLD",7022,"ABPKG")
n
"BLD",7022,"INI")
PRE^MHV1P6
"BLD",7022,"INIT")
POST^MHV1P6
"BLD",7022,"KRN",0)
^9.67PA^9002226^20
"BLD",7022,"KRN",.4,0)
.4
"BLD",7022,"KRN",.401,0)
.401
"BLD",7022,"KRN",.402,0)
.402
"BLD",7022,"KRN",.403,0)
.403
"BLD",7022,"KRN",.5,0)
.5
"BLD",7022,"KRN",.84,0)
.84
"BLD",7022,"KRN",3.6,0)
3.6
"BLD",7022,"KRN",3.8,0)
3.8
"BLD",7022,"KRN",9.2,0)
9.2
"BLD",7022,"KRN",9.8,0)
9.8
"BLD",7022,"KRN",9.8,"NM",0)
^9.68A^49^10
"BLD",7022,"KRN",9.8,"NM",16,0)
MHV7B9^^0^B3247817
"BLD",7022,"KRN",9.8,"NM",17,0)
MHV7B9A^^0^B23577236
"BLD",7022,"KRN",9.8,"NM",24,0)
MHV7R5^^0^B32891553
"BLD",7022,"KRN",9.8,"NM",37,0)
MHVXCLN^^0^B3158368
"BLD",7022,"KRN",9.8,"NM",40,0)
MHVXPAT^^0^B60657479
"BLD",7022,"KRN",9.8,"NM",44,0)
MHVXTM^^0^B2860414
"BLD",7022,"KRN",9.8,"NM",45,0)
MHVXUSR^^0^B6533332
"BLD",7022,"KRN",9.8,"NM",46,0)
MHV1P6^^0^B4687174
"BLD",7022,"KRN",9.8,"NM",47,0)
MHV1P6B^^0^B98164475
"BLD",7022,"KRN",9.8,"NM",49,0)
MHVXPRV^^0^B8040639
"BLD",7022,"KRN",9.8,"NM","B","MHV1P6",46)

"BLD",7022,"KRN",9.8,"NM","B","MHV1P6B",47)

"BLD",7022,"KRN",9.8,"NM","B","MHV7B9",16)

"BLD",7022,"KRN",9.8,"NM","B","MHV7B9A",17)

"BLD",7022,"KRN",9.8,"NM","B","MHV7R5",24)

"BLD",7022,"KRN",9.8,"NM","B","MHVXCLN",37)

"BLD",7022,"KRN",9.8,"NM","B","MHVXPAT",40)

"BLD",7022,"KRN",9.8,"NM","B","MHVXPRV",49)

"BLD",7022,"KRN",9.8,"NM","B","MHVXTM",44)

"BLD",7022,"KRN",9.8,"NM","B","MHVXUSR",45)

"BLD",7022,"KRN",19,0)
19
"BLD",7022,"KRN",19.1,0)
19.1
"BLD",7022,"KRN",101,0)
101
"BLD",7022,"KRN",101,"NM",0)
^9.68A^5^4
"BLD",7022,"KRN",101,"NM",1,0)
MHVSM QBP-Q11 Subscriber^^0
"BLD",7022,"KRN",101,"NM",3,0)
MHVSM RSP-K11 Event Driver^^0
"BLD",7022,"KRN",101,"NM",4,0)
MHVSM RSP-K11 Subscriber^^0
"BLD",7022,"KRN",101,"NM",5,0)
MHVSM QBP-Q11 Event Driver^^0
"BLD",7022,"KRN",101,"NM","B","MHVSM QBP-Q11 Event Driver",5)

"BLD",7022,"KRN",101,"NM","B","MHVSM QBP-Q11 Subscriber",1)

"BLD",7022,"KRN",101,"NM","B","MHVSM RSP-K11 Event Driver",3)

"BLD",7022,"KRN",101,"NM","B","MHVSM RSP-K11 Subscriber",4)

"BLD",7022,"KRN",409.61,0)
409.61
"BLD",7022,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",7022,"KRN",771,0)
771
"BLD",7022,"KRN",870,0)
870
"BLD",7022,"KRN",8989.51,0)
8989.51
"BLD",7022,"KRN",8989.52,0)
8989.52
"BLD",7022,"KRN",8994,0)
8994
"BLD",7022,"KRN",9002226,0)
9002226
"BLD",7022,"KRN","B",.4,.4)

"BLD",7022,"KRN","B",.401,.401)

"BLD",7022,"KRN","B",.402,.402)

"BLD",7022,"KRN","B",.403,.403)

"BLD",7022,"KRN","B",.5,.5)

"BLD",7022,"KRN","B",.84,.84)

"BLD",7022,"KRN","B",3.6,3.6)

"BLD",7022,"KRN","B",3.8,3.8)

"BLD",7022,"KRN","B",9.2,9.2)

"BLD",7022,"KRN","B",9.8,9.8)

"BLD",7022,"KRN","B",19,19)

"BLD",7022,"KRN","B",19.1,19.1)

"BLD",7022,"KRN","B",101,101)

"BLD",7022,"KRN","B",409.61,409.61)

"BLD",7022,"KRN","B",771,771)

"BLD",7022,"KRN","B",870,870)

"BLD",7022,"KRN","B",8989.51,8989.51)

"BLD",7022,"KRN","B",8989.52,8989.52)

"BLD",7022,"KRN","B",8994,8994)

"BLD",7022,"KRN","B",9002226,9002226)

"BLD",7022,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7022,"QUES",0)
^9.62^^
"BLD",7022,"REQB",0)
^9.611^1^1
"BLD",7022,"REQB",1,0)
MHV*1.0*5^2
"BLD",7022,"REQB","B","MHV*1.0*5",1)

"INI")
PRE^MHV1P6
"INIT")
POST^MHV1P6
"KRN",101,7111,-1)
0^1
"KRN",101,7111,0)
MHVSM QBP-Q11 Subscriber^MHVSM QBP-Q11 Subscriber^^S^^^^^^^^
"KRN",101,7111,99)
61264,57652
"KRN",101,7111,770)
^MHV VISTA^^K11^^^MHVVA^^^^RSP
"KRN",101,7111,771)
D QBPQ11^MHV7R5
"KRN",101,7111,773)
1^0^0
"KRN",101,7112,-1)
0^5
"KRN",101,7112,0)
MHVSM QBP-Q11 Event Driver^MHVSM QBP-Q11 Event Driver^^E^^^^^^^^
"KRN",101,7112,99)
61264,57652
"KRN",101,7112,770)
MHV SM^^QBP^Q11^164^^^^^2.4^
"KRN",101,7112,775,0)
^101.0775PA^1^1
"KRN",101,7112,775,1,0)
7111
"KRN",101,7112,775,1,"^")
MHVSM QBP-Q11 Subscriber
"KRN",101,7115,-1)
0^3
"KRN",101,7115,0)
MHVSM RSP-K11 Event Driver^^^E^^^^^^^^
"KRN",101,7115,770)
MHV VISTA^^RSP^K11^182^^^AL^NE^2.4^
"KRN",101,7115,775,0)
^101.0775PA^1^1
"KRN",101,7115,775,1,0)
7116
"KRN",101,7115,775,1,"^")
MHVSM RSP-K11 Subscriber
"KRN",101,7116,-1)
0^4
"KRN",101,7116,0)
MHVSM RSP-K11 Subscriber^^^S^^^^^^^^
"KRN",101,7116,770)
^MHV SM^^K11^^^MHVVA^^^^RSP
"KRN",101,7116,773)
1^1^0
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",594,-1)
1^1
"PKG",594,0)
My HealtheVet^MHV^Support for My HealtheVet web site.
"PKG",594,20,0)
^9.402P^^
"PKG",594,22,0)
^9.49I^1^1
"PKG",594,22,1,0)
1.0^3050823^3050829^30
"PKG",594,22,1,"PAH",1,0)
6^3080925^50205
"PKG",594,22,1,"PAH",1,1,0)
^^8^8^3080925
"PKG",594,22,1,"PAH",1,1,1,0)
Summary
"PKG",594,22,1,"PAH",1,1,2,0)
-------
"PKG",594,22,1,"PAH",1,1,3,0)
MHV*1*6 delivers the HL7 interfaces needed to support Secure Messaging.  
"PKG",594,22,1,"PAH",1,1,4,0)
There are nine new queries in the MHV namespace that support the 
"PKG",594,22,1,"PAH",1,1,5,0)
administration and daily operation of the Secure Messaging enterprise 
"PKG",594,22,1,"PAH",1,1,6,0)
system. MHV*1*6 installs the components necessary to execute the admin
"PKG",594,22,1,"PAH",1,1,7,0)
queries to retrieve information on patients, providers, clinics, and
"PKG",594,22,1,"PAH",1,1,8,0)
teams.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","MHV1P6")
0^46^B4687174^n/a
"RTN","MHV1P6",1,0)
MHV1P6 ;WAS/DLF - My HealtheVet Install Utility Routine ; 9/25/08 4:06pm
"RTN","MHV1P6",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHV1P6",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHV1P6",4,0)
 ;
"RTN","MHV1P6",5,0)
 ;  Integration Agreements:
"RTN","MHV1P6",6,0)
 ;        10141 : BMES^XPDUTL
"RTN","MHV1P6",7,0)
 ;              : MES^XPDUTL
"RTN","MHV1P6",8,0)
 ;        10103 : $$HTFM^XLFDT
"RTN","MHV1P6",9,0)
 ;
"RTN","MHV1P6",10,0)
ENV ;
"RTN","MHV1P6",11,0)
 Q
"RTN","MHV1P6",12,0)
 ;
"RTN","MHV1P6",13,0)
PRE ; turn on logging
"RTN","MHV1P6",14,0)
 D LOGON
"RTN","MHV1P6",15,0)
 D LOG^MHVUL2("MHV1P6","PRE-INIT","S","TRACE")
"RTN","MHV1P6",16,0)
 Q
"RTN","MHV1P6",17,0)
 ;
"RTN","MHV1P6",18,0)
POST ; Post-init
"RTN","MHV1P6",19,0)
 N ERR
"RTN","MHV1P6",20,0)
 D LOG^MHVUL2("MHV1P6","POST-INIT BEGIN","S","TRACE")
"RTN","MHV1P6",21,0)
 ;
"RTN","MHV1P6",22,0)
 ; Set up the secure messaging Admin queries
"RTN","MHV1P6",23,0)
 ;
"RTN","MHV1P6",24,0)
 D QRYSETUP^MHV1P6B
"RTN","MHV1P6",25,0)
 ;
"RTN","MHV1P6",26,0)
 ; Add the HL7 protocols for Secure Messaging
"RTN","MHV1P6",27,0)
 ;
"RTN","MHV1P6",28,0)
 D HL7
"RTN","MHV1P6",29,0)
 ;
"RTN","MHV1P6",30,0)
 D LOG^MHVUL2("MHV1P6","POST-INIT END","S","TRACE")
"RTN","MHV1P6",31,0)
 D LOGOFF
"RTN","MHV1P6",32,0)
 D RESET^MHVUL2
"RTN","MHV1P6",33,0)
 Q
"RTN","MHV1P6",34,0)
 ;
"RTN","MHV1P6",35,0)
LOGON ; Turn on logging
"RTN","MHV1P6",36,0)
 N UPDATE,SUCCESS
"RTN","MHV1P6",37,0)
 D BMES^XPDUTL("     Turning on MHV Application Logging")
"RTN","MHV1P6",38,0)
 S UPDATE("STATE")=1
"RTN","MHV1P6",39,0)
 S UPDATE("DELETE")=$$HTFM^XLFDT($H+60)
"RTN","MHV1P6",40,0)
 S UPDATE("LEVEL")="DEBUG"
"RTN","MHV1P6",41,0)
 D LOGSET^MHVUL1(.SUCCESS,.UPDATE)
"RTN","MHV1P6",42,0)
 Q
"RTN","MHV1P6",43,0)
 ;
"RTN","MHV1P6",44,0)
LOGOFF ; Turn off logging
"RTN","MHV1P6",45,0)
 N SUCCESS
"RTN","MHV1P6",46,0)
 D BMES^XPDUTL("     Turning off MHV Application Logging")
"RTN","MHV1P6",47,0)
 D LOGOFF^MHVUL1(.SUCCESS)
"RTN","MHV1P6",48,0)
 Q
"RTN","MHV1P6",49,0)
 ;
"RTN","MHV1P6",50,0)
HL7 ; Set up HL7 protocols
"RTN","MHV1P6",51,0)
 N FLDS,ERR
"RTN","MHV1P6",52,0)
 K FLDS
"RTN","MHV1P6",53,0)
 S ERR=""
"RTN","MHV1P6",54,0)
 S FLDS("SUBSCRIBER")="MHVSM QBP-Q11 Subscriber"
"RTN","MHV1P6",55,0)
 S FLDS("PROTOCOL")="MHVSM QBP-Q11 Event Driver"
"RTN","MHV1P6",56,0)
 S FLDS("BUILDER")="RSPK11~MHV7B9"
"RTN","MHV1P6",57,0)
 S FLDS("SEGMENT")="PID"
"RTN","MHV1P6",58,0)
 D LOG^MHVUL2("UPDATE RESPONSE MAP",.FLDS,"M","DEBUG")
"RTN","MHV1P6",59,0)
 D UPDMAP^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6",60,0)
 I ERR'="" D
"RTN","MHV1P6",61,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6",62,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6",63,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6",64,0)
 . Q
"RTN","MHV1P6",65,0)
 ;
"RTN","MHV1P6",66,0)
 Q
"RTN","MHV1P6B")
0^47^B98164475^n/a
"RTN","MHV1P6B",1,0)
MHV1P6B ;WAS/DLF - My HealtheVet Install Utility Routine ; 9/25/08 4:07pm
"RTN","MHV1P6B",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHV1P6B",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHV1P6B",4,0)
 ;
"RTN","MHV1P6B",5,0)
 ;  Integration Agreements:
"RTN","MHV1P6B",6,0)
 ;        10141 : BMES^XPDUTL
"RTN","MHV1P6B",7,0)
 ;              : MES^XPDUTL
"RTN","MHV1P6B",8,0)
 ;
"RTN","MHV1P6B",9,0)
 ;
"RTN","MHV1P6B",10,0)
 Q
"RTN","MHV1P6B",11,0)
 ;
"RTN","MHV1P6B",12,0)
QRYSETUP  ;
"RTN","MHV1P6B",13,0)
 D USERS,PCPROV,PTCL,PTTM,PTPROV,TEAM,CLINICS,PTREL
"RTN","MHV1P6B",14,0)
 Q
"RTN","MHV1P6B",15,0)
USERS ; Set up user query
"RTN","MHV1P6B",16,0)
 N FLDS,ERR
"RTN","MHV1P6B",17,0)
 S ERR=""
"RTN","MHV1P6B",18,0)
 S FLDS("REQUEST TYPE")="USERS"
"RTN","MHV1P6B",19,0)
 S FLDS("NUMBER")=26
"RTN","MHV1P6B",20,0)
 S FLDS("BLOCK")=1
"RTN","MHV1P6B",21,0)
 S FLDS("REALTIME")=1
"RTN","MHV1P6B",22,0)
 S FLDS("BUILDER")="STF~MHV7B9A"
"RTN","MHV1P6B",23,0)
 S FLDS("DATATYPE")="SMUsers"
"RTN","MHV1P6B",24,0)
 S FLDS("EXECUTE")="USERS~MHVXUSR"
"RTN","MHV1P6B",25,0)
 S FLDS("DESCRIPTION",1)="QBP^Q13 query for user information."
"RTN","MHV1P6B",26,0)
 S FLDS("DESCRIPTION",2)="Specify user by Name or leave blank for all"
"RTN","MHV1P6B",27,0)
 S FLDS("DESCRIPTION",3)="users.  Developed for Secure Messaging."
"RTN","MHV1P6B",28,0)
 D LOG^MHVUL2("UPDATE REQUEST TYPE",.FLDS,"M","DEBUG")
"RTN","MHV1P6B",29,0)
 D UPDREQ^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6B",30,0)
 I ERR'="" D
"RTN","MHV1P6B",31,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",32,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",33,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",34,0)
 . Q
"RTN","MHV1P6B",35,0)
 ;
"RTN","MHV1P6B",36,0)
 ; Enable the Users Query
"RTN","MHV1P6B",37,0)
 ;
"RTN","MHV1P6B",38,0)
 S ERR=""
"RTN","MHV1P6B",39,0)
 D LOG^MHVUL2("ENABLE","USERS","S","TRACE")
"RTN","MHV1P6B",40,0)
 D TOGGLE^MHVU2("USERS","ENABLE",.ERR)
"RTN","MHV1P6B",41,0)
 I ERR'="" D
"RTN","MHV1P6B",42,0)
 . D LOG^MHVUL2("ENABLE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",43,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",44,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",45,0)
 . Q
"RTN","MHV1P6B",46,0)
 ;
"RTN","MHV1P6B",47,0)
 Q
"RTN","MHV1P6B",48,0)
PCPROV ; Set up the PCMM providers query
"RTN","MHV1P6B",49,0)
 N FLDS,ERR
"RTN","MHV1P6B",50,0)
 S ERR=""
"RTN","MHV1P6B",51,0)
 K FLDS
"RTN","MHV1P6B",52,0)
 S FLDS("REQUEST TYPE")="PCMM PROVIDERS"
"RTN","MHV1P6B",53,0)
 S FLDS("NUMBER")=27
"RTN","MHV1P6B",54,0)
 S FLDS("BLOCK")=1
"RTN","MHV1P6B",55,0)
 S FLDS("REALTIME")=1
"RTN","MHV1P6B",56,0)
 S FLDS("BUILDER")="STF~MHV7B9A"
"RTN","MHV1P6B",57,0)
 S FLDS("DATATYPE")="SMPCMMProviders"
"RTN","MHV1P6B",58,0)
 S FLDS("EXECUTE")="CMMPRV~MHVXPRV"
"RTN","MHV1P6B",59,0)
 S FLDS("DESCRIPTION",1)="QBP^Q13 query for provider information."
"RTN","MHV1P6B",60,0)
 S FLDS("DESCRIPTION",2)="Specify provider by Name or leave blank for"
"RTN","MHV1P6B",61,0)
 S FLDS("DESCRIPTION",3)="all providers."
"RTN","MHV1P6B",62,0)
 S FLDS("DESCRIPTION",4)="Developed for Secure Messaging."
"RTN","MHV1P6B",63,0)
 D LOG^MHVUL2("UPDATE REQUEST TYPE",.FLDS,"M","DEBUG")
"RTN","MHV1P6B",64,0)
 D UPDREQ^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6B",65,0)
 I ERR'="" D
"RTN","MHV1P6B",66,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",67,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",68,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",69,0)
 . Q
"RTN","MHV1P6B",70,0)
 ;
"RTN","MHV1P6B",71,0)
 ; Enable the PCMM Providers query
"RTN","MHV1P6B",72,0)
 ;
"RTN","MHV1P6B",73,0)
 S ERR=""
"RTN","MHV1P6B",74,0)
 D LOG^MHVUL2("ENABLE","PCMM PROVIDERS","S","TRACE")
"RTN","MHV1P6B",75,0)
 D TOGGLE^MHVU2("PCMM PROVIDERS","ENABLE",.ERR)
"RTN","MHV1P6B",76,0)
 I ERR'="" D
"RTN","MHV1P6B",77,0)
 . D LOG^MHVUL2("ENABLE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",78,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",79,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",80,0)
 . Q
"RTN","MHV1P6B",81,0)
 ;
"RTN","MHV1P6B",82,0)
 Q
"RTN","MHV1P6B",83,0)
PTCL ; Set up patients for Clinic
"RTN","MHV1P6B",84,0)
 N FLDS,ERR
"RTN","MHV1P6B",85,0)
 S ERR=""
"RTN","MHV1P6B",86,0)
 K FLDS
"RTN","MHV1P6B",87,0)
 S FLDS("REQUEST TYPE")="PCMM PATIENTS FOR CLINIC"
"RTN","MHV1P6B",88,0)
 S FLDS("NUMBER")=28
"RTN","MHV1P6B",89,0)
 S FLDS("BLOCK")=1
"RTN","MHV1P6B",90,0)
 S FLDS("REALTIME")=1
"RTN","MHV1P6B",91,0)
 S FLDS("BUILDER")="PID~MHV7B9A"
"RTN","MHV1P6B",92,0)
 S FLDS("DATATYPE")="SMPCMMPatientsForClinic"
"RTN","MHV1P6B",93,0)
 S FLDS("EXECUTE")="PATCL~MHVXPAT"
"RTN","MHV1P6B",94,0)
 S FLDS("DESCRIPTION",1)="QBP^Q13 query for user information."
"RTN","MHV1P6B",95,0)
 S FLDS("DESCRIPTION",2)="Specify Clinic IEN"
"RTN","MHV1P6B",96,0)
 S FLDS("DESCRIPTION",3)="Developed for Secure Messaging."
"RTN","MHV1P6B",97,0)
 D LOG^MHVUL2("UPDATE REQUEST TYPE",.FLDS,"M","DEBUG")
"RTN","MHV1P6B",98,0)
 D UPDREQ^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6B",99,0)
 I ERR'="" D
"RTN","MHV1P6B",100,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",101,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",102,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",103,0)
 . Q
"RTN","MHV1P6B",104,0)
 ;
"RTN","MHV1P6B",105,0)
 ; Enable patients for clinic query
"RTN","MHV1P6B",106,0)
 ;
"RTN","MHV1P6B",107,0)
 S ERR=""
"RTN","MHV1P6B",108,0)
 D LOG^MHVUL2("ENABLE","PCMM PATIENTS FOR CLINIC","S","TRACE")
"RTN","MHV1P6B",109,0)
 D TOGGLE^MHVU2("PCMM PATIENTS FOR CLINIC","ENABLE",.ERR)
"RTN","MHV1P6B",110,0)
 I ERR'="" D
"RTN","MHV1P6B",111,0)
 . D LOG^MHVUL2("ENABLE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",112,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",113,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",114,0)
 . Q
"RTN","MHV1P6B",115,0)
 Q
"RTN","MHV1P6B",116,0)
PTTM ; Set up Patients for team query
"RTN","MHV1P6B",117,0)
 N FLDS,ERR
"RTN","MHV1P6B",118,0)
 S ERR=""
"RTN","MHV1P6B",119,0)
 K FLDS
"RTN","MHV1P6B",120,0)
 S FLDS("REQUEST TYPE")="PCMM PATIENTS FOR TEAM"
"RTN","MHV1P6B",121,0)
 S FLDS("NUMBER")=29
"RTN","MHV1P6B",122,0)
 S FLDS("BLOCK")=1
"RTN","MHV1P6B",123,0)
 S FLDS("REALTIME")=1
"RTN","MHV1P6B",124,0)
 S FLDS("BUILDER")="PID~MHV7B9A"
"RTN","MHV1P6B",125,0)
 S FLDS("DATATYPE")="SMPCMMPatientsForTeam"
"RTN","MHV1P6B",126,0)
 S FLDS("EXECUTE")="PATTM~MHVXPAT"
"RTN","MHV1P6B",127,0)
 S FLDS("DESCRIPTION",1)="QBP^Q13 query for user information."
"RTN","MHV1P6B",128,0)
 S FLDS("DESCRIPTION",2)="Specify team IEN.  Developed for Secure Messaging."
"RTN","MHV1P6B",129,0)
 D LOG^MHVUL2("UPDATE REQUEST TYPE",.FLDS,"M","DEBUG")
"RTN","MHV1P6B",130,0)
 D UPDREQ^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6B",131,0)
 I ERR'="" D
"RTN","MHV1P6B",132,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",133,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",134,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",135,0)
 . Q
"RTN","MHV1P6B",136,0)
 ;
"RTN","MHV1P6B",137,0)
 ; Enable Patients for team query
"RTN","MHV1P6B",138,0)
 ;
"RTN","MHV1P6B",139,0)
 S ERR=""
"RTN","MHV1P6B",140,0)
 D LOG^MHVUL2("ENABLE","PCMM PATIENTS FOR TEAM","S","TRACE")
"RTN","MHV1P6B",141,0)
 D TOGGLE^MHVU2("PCMM PATIENTS FOR TEAM","ENABLE",.ERR)
"RTN","MHV1P6B",142,0)
 I ERR'="" D
"RTN","MHV1P6B",143,0)
 . D LOG^MHVUL2("ENABLE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",144,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",145,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",146,0)
 . Q
"RTN","MHV1P6B",147,0)
 ;
"RTN","MHV1P6B",148,0)
 Q
"RTN","MHV1P6B",149,0)
PTPROV ; Set up patients for provider query
"RTN","MHV1P6B",150,0)
 N FLDS,ERR
"RTN","MHV1P6B",151,0)
 S ERR=""
"RTN","MHV1P6B",152,0)
 K FLDS
"RTN","MHV1P6B",153,0)
 S FLDS("REQUEST TYPE")="PCMM PATIENTS FOR PROVIDER"
"RTN","MHV1P6B",154,0)
 S FLDS("NUMBER")=30
"RTN","MHV1P6B",155,0)
 S FLDS("BLOCK")=1
"RTN","MHV1P6B",156,0)
 S FLDS("REALTIME")=1
"RTN","MHV1P6B",157,0)
 S FLDS("BUILDER")="PID~MHV7B9A"
"RTN","MHV1P6B",158,0)
 S FLDS("DATATYPE")="SMPCMMPatientsForProvider"
"RTN","MHV1P6B",159,0)
 S FLDS("EXECUTE")="PTPCMP~MHVXPAT"
"RTN","MHV1P6B",160,0)
 S FLDS("DESCRIPTION",1)="QBP^Q13 query for user information."
"RTN","MHV1P6B",161,0)
 S FLDS("DESCRIPTION",2)="Specify provider IEN"
"RTN","MHV1P6B",162,0)
 S FLDS("DESCRIPTION",3)="Developed for Secure Messaging."
"RTN","MHV1P6B",163,0)
 D LOG^MHVUL2("UPDATE REQUEST TYPE",.FLDS,"M","DEBUG")
"RTN","MHV1P6B",164,0)
 D UPDREQ^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6B",165,0)
 I ERR'="" D
"RTN","MHV1P6B",166,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",167,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",168,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",169,0)
 . Q
"RTN","MHV1P6B",170,0)
 ;
"RTN","MHV1P6B",171,0)
 ; Enable Patients for Provider Query
"RTN","MHV1P6B",172,0)
 ;
"RTN","MHV1P6B",173,0)
 S ERR=""
"RTN","MHV1P6B",174,0)
 D LOG^MHVUL2("ENABLE","PCMM PATIENTS FOR PROVIDER","S","TRACE")
"RTN","MHV1P6B",175,0)
 D TOGGLE^MHVU2("PCMM PATIENTS FOR PROVIDER","ENABLE",.ERR)
"RTN","MHV1P6B",176,0)
 I ERR'="" D
"RTN","MHV1P6B",177,0)
 . D LOG^MHVUL2("ENABLE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",178,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",179,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",180,0)
 . Q
"RTN","MHV1P6B",181,0)
 ;
"RTN","MHV1P6B",182,0)
 Q
"RTN","MHV1P6B",183,0)
TEAM ; Set up team query
"RTN","MHV1P6B",184,0)
 ;
"RTN","MHV1P6B",185,0)
 N FLDS,ERR
"RTN","MHV1P6B",186,0)
 S ERR=""
"RTN","MHV1P6B",187,0)
 K FLDS
"RTN","MHV1P6B",188,0)
 S FLDS("REQUEST TYPE")="TEAM"
"RTN","MHV1P6B",189,0)
 S FLDS("NUMBER")=31
"RTN","MHV1P6B",190,0)
 S FLDS("BLOCK")=1
"RTN","MHV1P6B",191,0)
 S FLDS("REALTIME")=1
"RTN","MHV1P6B",192,0)
 S FLDS("DATATYPE")="SMTeam"
"RTN","MHV1P6B",193,0)
 S FLDS("BUILDER")="AIP~MHV7B9A"
"RTN","MHV1P6B",194,0)
 S FLDS("EXECUTE")="TEAM~MHVXTM"
"RTN","MHV1P6B",195,0)
 S FLDS("DESCRIPTION",1)="QBP^Q13 query for team information."
"RTN","MHV1P6B",196,0)
 S FLDS("DESCRIPTION",2)="Specify team name or leave blank for all."
"RTN","MHV1P6B",197,0)
 S FLDS("DESCRIPTION",3)="Developed for Secure Messaging."
"RTN","MHV1P6B",198,0)
 D LOG^MHVUL2("UPDATE REQUEST TYPE",.FLDS,"M","DEBUG")
"RTN","MHV1P6B",199,0)
 D UPDREQ^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6B",200,0)
 I ERR'="" D
"RTN","MHV1P6B",201,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",202,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",203,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",204,0)
 . Q
"RTN","MHV1P6B",205,0)
 ;
"RTN","MHV1P6B",206,0)
 ; Enable Team query
"RTN","MHV1P6B",207,0)
 ;
"RTN","MHV1P6B",208,0)
 S ERR=""
"RTN","MHV1P6B",209,0)
 D LOG^MHVUL2("ENABLE","TEAM","S","TRACE")
"RTN","MHV1P6B",210,0)
 D TOGGLE^MHVU2("TEAM","ENABLE",.ERR)
"RTN","MHV1P6B",211,0)
 I ERR'="" D
"RTN","MHV1P6B",212,0)
 . D LOG^MHVUL2("ENABLE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",213,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",214,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",215,0)
 . Q
"RTN","MHV1P6B",216,0)
 Q
"RTN","MHV1P6B",217,0)
CLINICS ; Set up clinics query
"RTN","MHV1P6B",218,0)
 N FLDS,ERR
"RTN","MHV1P6B",219,0)
 S ERR=""
"RTN","MHV1P6B",220,0)
 K FLDS
"RTN","MHV1P6B",221,0)
 S FLDS("REQUEST TYPE")="CLINICS"
"RTN","MHV1P6B",222,0)
 S FLDS("NUMBER")=32
"RTN","MHV1P6B",223,0)
 S FLDS("BLOCK")=1
"RTN","MHV1P6B",224,0)
 S FLDS("REALTIME")=1
"RTN","MHV1P6B",225,0)
 S FLDS("BUILDER")="ORG~MHV7B9A"
"RTN","MHV1P6B",226,0)
 S FLDS("DATATYPE")="SMClinics"
"RTN","MHV1P6B",227,0)
 S FLDS("EXECUTE")="CLIN~MHVXCLN"
"RTN","MHV1P6B",228,0)
 S FLDS("DESCRIPTION",1)="QBP^Q13 query for clinic information."
"RTN","MHV1P6B",229,0)
 S FLDS("DESCRIPTION",2)="Specify clinic name of leave blank for all."
"RTN","MHV1P6B",230,0)
 S FLDS("DESCRIPTION",3)="Developed for Secure Messaging."
"RTN","MHV1P6B",231,0)
 D LOG^MHVUL2("UPDATE REQUEST TYPE",.FLDS,"M","DEBUG")
"RTN","MHV1P6B",232,0)
 D UPDREQ^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6B",233,0)
 I ERR'="" D
"RTN","MHV1P6B",234,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",235,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",236,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",237,0)
 . Q
"RTN","MHV1P6B",238,0)
 ;
"RTN","MHV1P6B",239,0)
 ; Enable CLinics Query
"RTN","MHV1P6B",240,0)
 ;
"RTN","MHV1P6B",241,0)
 S ERR=""
"RTN","MHV1P6B",242,0)
 D LOG^MHVUL2("ENABLE","CLINICS","S","TRACE")
"RTN","MHV1P6B",243,0)
 D TOGGLE^MHVU2("CLINICS","ENABLE",.ERR)
"RTN","MHV1P6B",244,0)
 I ERR'="" D
"RTN","MHV1P6B",245,0)
 . D LOG^MHVUL2("ENABLE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",246,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",247,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",248,0)
 . Q
"RTN","MHV1P6B",249,0)
 Q
"RTN","MHV1P6B",250,0)
PTREL ; Set up patient relationships query
"RTN","MHV1P6B",251,0)
 N FLDS,ERR
"RTN","MHV1P6B",252,0)
 S ERR=""
"RTN","MHV1P6B",253,0)
 K FLDS
"RTN","MHV1P6B",254,0)
 S FLDS("REQUEST TYPE")="PATIENT RELATIONSHIPS"
"RTN","MHV1P6B",255,0)
 S FLDS("NUMBER")=33
"RTN","MHV1P6B",256,0)
 S FLDS("BLOCK")=1
"RTN","MHV1P6B",257,0)
 S FLDS("REALTIME")=1
"RTN","MHV1P6B",258,0)
 S FLDS("BUILDER")="PTREL~MHV7B9A"
"RTN","MHV1P6B",259,0)
 S FLDS("DATATYPE")="SMPatientRelationships"
"RTN","MHV1P6B",260,0)
 S FLDS("EXECUTE")="PTREL~MHVXPAT"
"RTN","MHV1P6B",261,0)
 S FLDS("DESCRIPTION",1)="QBP^Q13 query for patient information."
"RTN","MHV1P6B",262,0)
 S FLDS("DESCRIPTION",2)="Specify patient IEN.  Returns Provider"
"RTN","MHV1P6B",263,0)
 S FLDS("DESCRIPTION",3)="Team and Clinic information for a date"
"RTN","MHV1P6B",264,0)
 S FLDS("DESCRIPTION",4)="range.  Developed for Secure Messaging."
"RTN","MHV1P6B",265,0)
 D LOG^MHVUL2("UPDATE REQUEST TYPE",.FLDS,"M","DEBUG")
"RTN","MHV1P6B",266,0)
 D UPDREQ^MHVU2(.FLDS,1,.ERR)
"RTN","MHV1P6B",267,0)
 I ERR'="" D
"RTN","MHV1P6B",268,0)
 . D LOG^MHVUL2("UPDATE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",269,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",270,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",271,0)
 . Q
"RTN","MHV1P6B",272,0)
 ;
"RTN","MHV1P6B",273,0)
 ; Enable Patient Relationships Query
"RTN","MHV1P6B",274,0)
 ;
"RTN","MHV1P6B",275,0)
 S ERR=""
"RTN","MHV1P6B",276,0)
 D LOG^MHVUL2("ENABLE","PATIENT RELATIONSHIPS","S","TRACE")
"RTN","MHV1P6B",277,0)
 D TOGGLE^MHVU2("PATIENT RELATIONSHIPS","ENABLE",.ERR)
"RTN","MHV1P6B",278,0)
 I ERR'="" D
"RTN","MHV1P6B",279,0)
 . D LOG^MHVUL2("ENABLE FAILED",ERR,"S","ERROR")
"RTN","MHV1P6B",280,0)
 . D BMES^XPDUTL("     *** An Error occurred during installation.")
"RTN","MHV1P6B",281,0)
 . D MES^XPDUTL("     Please log a remedy ticket.")
"RTN","MHV1P6B",282,0)
 . Q
"RTN","MHV1P6B",283,0)
 Q
"RTN","MHV7B9")
0^16^B3247817^n/a
"RTN","MHV7B9",1,0)
MHV7B9 ;WAS/DLF - HL7 message builder SECURE MESSAGING RSP^K11 ; 9/25/08 4:08pm
"RTN","MHV7B9",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHV7B9",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHV7B9",4,0)
 ;
"RTN","MHV7B9",5,0)
 Q
"RTN","MHV7B9",6,0)
 ;
"RTN","MHV7B9",7,0)
RSPK11(MSGROOT,QRY,ERR,DATAROOT,LEN,HL) ; Build query response
"RTN","MHV7B9",8,0)
 ;
"RTN","MHV7B9",9,0)
 ;  Populates the array pointed to by MSGROOT with an RSP^K11 query
"RTN","MHV7B9",10,0)
 ; response message by calling the appropriate segment builders based
"RTN","MHV7B9",11,0)
 ; on the type of response ACK/Data or NAK.  Extracted data pointed to
"RTN","MHV7B9",12,0)
 ; by DATAROOT, errors, hit counts, and query information are used to
"RTN","MHV7B9",13,0)
 ; build the segments.
"RTN","MHV7B9",14,0)
 ; An error number in ERR^4 indicates a NAK is needed.
"RTN","MHV7B9",15,0)
 ; DATAROOT being null indicates a dataless ACK (testing purposes).
"RTN","MHV7B9",16,0)
 ;
"RTN","MHV7B9",17,0)
 ;  Input:
"RTN","MHV7B9",18,0)
 ;     MSGROOT - Global root of message
"RTN","MHV7B9",19,0)
 ;         QRY - Query parameters
"RTN","MHV7B9",20,0)
 ;             QRY("MID") - original message control ID
"RTN","MHV7B9",21,0)
 ;         ERR - Caret delimited error string
"RTN","MHV7B9",22,0)
 ;               segment^sequence^field^code^ACK type^error text
"RTN","MHV7B9",23,0)
 ;    DATAROOT - Global root of data array
"RTN","MHV7B9",24,0)
 ;          HL - HL7 package array variable
"RTN","MHV7B9",25,0)
 ;
"RTN","MHV7B9",26,0)
 ;  Output: RSP^K11 message in MSGROOT
"RTN","MHV7B9",27,0)
 ;         LEN - Length of formatted message
"RTN","MHV7B9",28,0)
 ;
"RTN","MHV7B9",29,0)
 N CNT,HIT,EXTIME,MTYPE
"RTN","MHV7B9",30,0)
 D LOG^MHVUL2("SM RSP-K11 BUILDER","BEGIN","S","TRACE")
"RTN","MHV7B9",31,0)
 ;
"RTN","MHV7B9",32,0)
 S HIT=0,EXTIME=""
"RTN","MHV7B9",33,0)
 I DATAROOT'="" D
"RTN","MHV7B9",34,0)
 . S HIT=+$P($G(@DATAROOT),"^",1)
"RTN","MHV7B9",35,0)
 . S EXTIME=$P($G(@DATAROOT),"^",2)
"RTN","MHV7B9",36,0)
 . Q
"RTN","MHV7B9",37,0)
 S HIT=HIT_"^"_HIT_"^0"
"RTN","MHV7B9",38,0)
 ;
"RTN","MHV7B9",39,0)
 K @MSGROOT
"RTN","MHV7B9",40,0)
 S CNT=1,@MSGROOT@(CNT)=$$MSA^MHV7BUS($G(QRY("MID")),ERR,.HL)
"RTN","MHV7B9",41,0)
 S LEN=$L(@MSGROOT@(CNT))
"RTN","MHV7B9",42,0)
 I $P(ERR,"^",4)  D
"RTN","MHV7B9",43,0)
 .S CNT=CNT+1,HIT="0^0^0",@MSGROOT@(CNT)=$$ERR^MHV7BUS(ERR,.HL)
"RTN","MHV7B9",44,0)
 .S LEN=LEN+$L(@MSGROOT@(CNT))
"RTN","MHV7B9",45,0)
 S CNT=CNT+1,@MSGROOT@(CNT)=$$QAK^MHV7BUS(.QRY,ERR,HIT,.HL)
"RTN","MHV7B9",46,0)
 S LEN=LEN+$L(@MSGROOT@(CNT))
"RTN","MHV7B9",47,0)
 S CNT=CNT+1,@MSGROOT@(CNT)=$$QPD^MHV7BUS(.QRY,EXTIME,.HL)
"RTN","MHV7B9",48,0)
 S LEN=LEN+$L(@MSGROOT@(CNT))
"RTN","MHV7B9",49,0)
 ;
"RTN","MHV7B9",50,0)
 I '$P(ERR,"^",4)  D
"RTN","MHV7B9",51,0)
 .D @(QRY("BUILDER")_"(MSGROOT,DATAROOT,.CNT,.LEN,.HL)")
"RTN","MHV7B9",52,0)
 ;
"RTN","MHV7B9",53,0)
 D LOG^MHVUL2("SM RSP-K11 BUILDER","END","S","TRACE")
"RTN","MHV7B9",54,0)
 Q
"RTN","MHV7B9",55,0)
 ;
"RTN","MHV7B9A")
0^17^B23577236^n/a
"RTN","MHV7B9A",1,0)
MHV7B9A ;WAS/DLF - HL7 message builder secure messaging ; 9/25/08 4:08pm
"RTN","MHV7B9A",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHV7B9A",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHV7B9A",4,0)
 ;
"RTN","MHV7B9A",5,0)
 Q
"RTN","MHV7B9A",6,0)
 ;
"RTN","MHV7B9A",7,0)
PTREL(MSGROOT,DATAROOT,CNT,LEN,HL)      ;Build ORG, STF, and AIP segments
"RTN","MHV7B9A",8,0)
 D ORG(MSGROOT,DATAROOT,.CNT,.LEN,.HL)
"RTN","MHV7B9A",9,0)
 S DATAROOT=$P(DATAROOT,",",1,3)
"RTN","MHV7B9A",10,0)
 S DATAROOT=$TR(DATAROOT,")","")_","_"""PROVIDERS"""_")"
"RTN","MHV7B9A",11,0)
 D STF(MSGROOT,DATAROOT,.CNT,.LEN,.HL)
"RTN","MHV7B9A",12,0)
 D AIP(MSGROOT,DATAROOT,.CNT,.LEN,.HL)
"RTN","MHV7B9A",13,0)
 Q
"RTN","MHV7B9A",14,0)
PID(MSGROOT,DATAROOT,CNT,LEN,HL) ;Build PID segments for user data
"RTN","MHV7B9A",15,0)
 ;
"RTN","MHV7B9A",16,0)
 ; Walks data in DATAROOT to populate MSGROOT with PID segments
"RTN","MHV7B9A",17,0)
 ; sequentially numbered starting at CNT
"RTN","MHV7B9A",18,0)
 ;
"RTN","MHV7B9A",19,0)
 ;  Integration Agreements:
"RTN","MHV7B9A",20,0)
 ;        10103 : FMTHL7^XLFDT
"RTN","MHV7B9A",21,0)
 ;
"RTN","MHV7B9A",22,0)
 ;  Input:
"RTN","MHV7B9A",23,0)
 ;   MSGROOT - Root of array holding the message
"RTN","MHV7B9A",24,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHV7B9A",25,0)
 ;       CNT - Current message line counter
"RTN","MHV7B9A",26,0)
 ;       LEN - Current message length
"RTN","MHV7B9A",27,0)
 ;        HL - HL7 package array variable
"RTN","MHV7B9A",28,0)
 ;
"RTN","MHV7B9A",29,0)
 ;  Output:
"RTN","MHV7B9A",30,0)
 ;           - Populated message array
"RTN","MHV7B9A",31,0)
 ;           - Updated LEN and CNT
"RTN","MHV7B9A",32,0)
 ;
"RTN","MHV7B9A",33,0)
 N I,USR,PID,NMARR,PNAME
"RTN","MHV7B9A",34,0)
 D LOG^MHVUL2("MHV7B9A","BEGIN PID","S","TRACE")
"RTN","MHV7B9A",35,0)
 F I=1:1 Q:'$D(@DATAROOT@(I))  D
"RTN","MHV7B9A",36,0)
 . S USR=@DATAROOT@(I)
"RTN","MHV7B9A",37,0)
 . S PID(0)="PID"
"RTN","MHV7B9A",38,0)
 . ; IEN+ICN+SSN
"RTN","MHV7B9A",39,0)
 . S PID(3,1,1)=$P(USR,"^")
"RTN","MHV7B9A",40,0)
 . S PID(3,2,1)=$P(USR,"^",4)
"RTN","MHV7B9A",41,0)
 . S PID(3,3,1)=$P(USR,"^",5)
"RTN","MHV7B9A",42,0)
 . S PNAME=$P(USR,"^",3)
"RTN","MHV7B9A",43,0)
 . D FMTNAME^MHV7BU(PNAME,.NMARR,.HL,"XPN")
"RTN","MHV7B9A",44,0)
 . S PID(5,1,1)=NMARR(1)
"RTN","MHV7B9A",45,0)
 . S PID(5,1,2)=NMARR(2)
"RTN","MHV7B9A",46,0)
 . S PID(5,1,3)=NMARR(3)  ;Name in HL7 Format
"RTN","MHV7B9A",47,0)
 . D LOG^MHVUL2("MHV7B9A",PNAME,"S","TRACE")
"RTN","MHV7B9A",48,0)
 . S CNT=CNT+1
"RTN","MHV7B9A",49,0)
 . S @MSGROOT@(CNT)=$$BLDSEG^MHV7U(.PID,.HL)
"RTN","MHV7B9A",50,0)
 . S LEN=LEN+$L(@MSGROOT@(CNT))
"RTN","MHV7B9A",51,0)
 . Q
"RTN","MHV7B9A",52,0)
 D LOG^MHVUL2("MHV7B9A","END PID","S","TRACE")
"RTN","MHV7B9A",53,0)
 Q
"RTN","MHV7B9A",54,0)
STF(MSGROOT,DATAROOT,CNT,LEN,HL) ;Build STF segments for provider data
"RTN","MHV7B9A",55,0)
 ;
"RTN","MHV7B9A",56,0)
 ; Walks data in DATAROOT to populate MSGROOT with STF segments
"RTN","MHV7B9A",57,0)
 ; sequentially numbered starting at CNT
"RTN","MHV7B9A",58,0)
 ;
"RTN","MHV7B9A",59,0)
 ;  Integration Agreements:
"RTN","MHV7B9A",60,0)
 ;        10103 : FMTHL7^XLFDT
"RTN","MHV7B9A",61,0)
 ;
"RTN","MHV7B9A",62,0)
 ;  Input:
"RTN","MHV7B9A",63,0)
 ;   MSGROOT - Root of array holding the message
"RTN","MHV7B9A",64,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHV7B9A",65,0)
 ;       CNT - Current message line counter
"RTN","MHV7B9A",66,0)
 ;       LEN - Current message length
"RTN","MHV7B9A",67,0)
 ;        HL - HL7 package array variable
"RTN","MHV7B9A",68,0)
 ;
"RTN","MHV7B9A",69,0)
 ;  Output:
"RTN","MHV7B9A",70,0)
 ;           - Populated message array
"RTN","MHV7B9A",71,0)
 ;           - Updated LEN and CNT
"RTN","MHV7B9A",72,0)
 ;
"RTN","MHV7B9A",73,0)
 N I,USR,STF,NMARR,PNAME
"RTN","MHV7B9A",74,0)
 D LOG^MHVUL2("MHV7B9A","BEGIN STF","S","TRACE")
"RTN","MHV7B9A",75,0)
 F I=1:1 Q:'$D(@DATAROOT@(I))  D
"RTN","MHV7B9A",76,0)
 . S USR=@DATAROOT@(I)
"RTN","MHV7B9A",77,0)
 . S STF(0)="STF"
"RTN","MHV7B9A",78,0)
 . S STF(2)=$P(USR,"^",1)                       ;IEN
"RTN","MHV7B9A",79,0)
 . S PNAME=$P(USR,"^",2)                       ;Provider name
"RTN","MHV7B9A",80,0)
 . D FMTNAME^MHV7BU(PNAME,.NMARR,.HL,"XPN")
"RTN","MHV7B9A",81,0)
 . S STF(3,1,1)=NMARR(1)
"RTN","MHV7B9A",82,0)
 . S STF(3,1,2)=NMARR(2)
"RTN","MHV7B9A",83,0)
 . S STF(3,1,3)=NMARR(3)  ;Name in HL7 Format
"RTN","MHV7B9A",84,0)
 . S STF(18)=$P(USR,"^",3)                      ;Staff type
"RTN","MHV7B9A",85,0)
 . S STF(8)=$P(USR,"^",8)                       ;Section/Department
"RTN","MHV7B9A",86,0)
 . S STF(10)=$P(USR,"^",7)                      ;Office Phone
"RTN","MHV7B9A",87,0)
 . S CNT=CNT+1
"RTN","MHV7B9A",88,0)
 . S @MSGROOT@(CNT)=$$BLDSEG^MHV7U(.STF,.HL)
"RTN","MHV7B9A",89,0)
 . S LEN=LEN+$L(@MSGROOT@(CNT))
"RTN","MHV7B9A",90,0)
 . Q
"RTN","MHV7B9A",91,0)
 D LOG^MHVUL2("MHV7B9A","END STF","S","TRACE")
"RTN","MHV7B9A",92,0)
 Q
"RTN","MHV7B9A",93,0)
AIP(MSGROOT,DATAROOT,CNT,LEN,HL)  ;Build AIP segments for team
"RTN","MHV7B9A",94,0)
 ;
"RTN","MHV7B9A",95,0)
 ; Walks data in DATAROOT to populate MSGROOT with AIP segments
"RTN","MHV7B9A",96,0)
 ; sequentially numbered starting at CNT
"RTN","MHV7B9A",97,0)
 ;
"RTN","MHV7B9A",98,0)
 ;  Integration Agreements:
"RTN","MHV7B9A",99,0)
 ;        10103 : FMTHL7^XLFDT
"RTN","MHV7B9A",100,0)
 ;
"RTN","MHV7B9A",101,0)
 ;  Input:
"RTN","MHV7B9A",102,0)
 ;   MSGROOT - Root of array holding the message
"RTN","MHV7B9A",103,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHV7B9A",104,0)
 ;       CNT - Current message line counter
"RTN","MHV7B9A",105,0)
 ;       LEN - Current message length
"RTN","MHV7B9A",106,0)
 ;        HL - HL7 package array variable
"RTN","MHV7B9A",107,0)
 ;
"RTN","MHV7B9A",108,0)
 ;  Output:
"RTN","MHV7B9A",109,0)
 ;           - Populated message array
"RTN","MHV7B9A",110,0)
 ;           - Updated LEN and CNT
"RTN","MHV7B9A",111,0)
 ;
"RTN","MHV7B9A",112,0)
 N I,USR,AIP
"RTN","MHV7B9A",113,0)
 S DATAROOT=$P(DATAROOT,",",1,3)
"RTN","MHV7B9A",114,0)
 S DATAROOT=$TR(DATAROOT,")","")_","_"""TEAMS"""_")"
"RTN","MHV7B9A",115,0)
 D LOG^MHVUL2("MHV7B9A","BEGIN AIP","S","TRACE")
"RTN","MHV7B9A",116,0)
 F I=1:1 Q:'$D(@DATAROOT@(I))  D
"RTN","MHV7B9A",117,0)
 . S USR=@DATAROOT@(I)
"RTN","MHV7B9A",118,0)
 . S AIP(0)="AIP"
"RTN","MHV7B9A",119,0)
 . S AIP(3)=$P(USR,"^",1)                                ;IEN
"RTN","MHV7B9A",120,0)
 . S AIP(5)=$$ESCAPE^MHV7U($P(USR,"^",2),.HL)            ;TEAM NAME
"RTN","MHV7B9A",121,0)
 . S CNT=CNT+1
"RTN","MHV7B9A",122,0)
 . S @MSGROOT@(CNT)=$$BLDSEG^MHV7U(.AIP,.HL)
"RTN","MHV7B9A",123,0)
 . S LEN=LEN+$L(@MSGROOT@(CNT))
"RTN","MHV7B9A",124,0)
 . Q
"RTN","MHV7B9A",125,0)
 D LOG^MHVUL2("MHV7B9A","END AIP","S","TRACE")
"RTN","MHV7B9A",126,0)
 Q
"RTN","MHV7B9A",127,0)
ORG(MSGROOT,DATAROOT,CNT,LEN,HL) ;Build ORG segments for clinics
"RTN","MHV7B9A",128,0)
 ;
"RTN","MHV7B9A",129,0)
 ; Walks data in DATAROOT to populate MSGROOT with ORG segments
"RTN","MHV7B9A",130,0)
 ; sequentially numbered starting at CNT
"RTN","MHV7B9A",131,0)
 ;
"RTN","MHV7B9A",132,0)
 ;  Integration Agreements:
"RTN","MHV7B9A",133,0)
 ;        10103 : FMTHL7^XLFDT
"RTN","MHV7B9A",134,0)
 ;
"RTN","MHV7B9A",135,0)
 ;  Input:
"RTN","MHV7B9A",136,0)
 ;   MSGROOT - Root of array holding the message
"RTN","MHV7B9A",137,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHV7B9A",138,0)
 ;       CNT - Current message line counter
"RTN","MHV7B9A",139,0)
 ;       LEN - Current message length
"RTN","MHV7B9A",140,0)
 ;        HL - HL7 package array variable
"RTN","MHV7B9A",141,0)
 ;
"RTN","MHV7B9A",142,0)
 ;  Output:
"RTN","MHV7B9A",143,0)
 ;           - Populated message array
"RTN","MHV7B9A",144,0)
 ;           - Updated LEN and CNT
"RTN","MHV7B9A",145,0)
 ;
"RTN","MHV7B9A",146,0)
 N I,USR,ORG
"RTN","MHV7B9A",147,0)
 D LOG^MHVUL2("MHV7B9A","BEGIN ORG","S","TRACE")
"RTN","MHV7B9A",148,0)
 S DATAROOT=$P(DATAROOT,",",1,3)
"RTN","MHV7B9A",149,0)
 S DATAROOT=$TR(DATAROOT,")","")_","_"""CLINICS"""_")"
"RTN","MHV7B9A",150,0)
 F I=1:1 Q:'$D(@DATAROOT@(I))  D
"RTN","MHV7B9A",151,0)
 . S USR=@DATAROOT@(I)
"RTN","MHV7B9A",152,0)
 . S ORG(0)="ORG"
"RTN","MHV7B9A",153,0)
 . S ORG(2,1,1)=$P(USR,"^",1)
"RTN","MHV7B9A",154,0)
 . S ORG(2,1,2)=$$ESCAPE^MHV7U($P(USR,"^",2),.HL)
"RTN","MHV7B9A",155,0)
 . S CNT=CNT+1
"RTN","MHV7B9A",156,0)
 . S @MSGROOT@(CNT)=$$BLDSEG^MHV7U(.ORG,.HL)
"RTN","MHV7B9A",157,0)
 . S LEN=LEN+$L(@MSGROOT@(CNT))
"RTN","MHV7B9A",158,0)
 . Q
"RTN","MHV7B9A",159,0)
 D LOG^MHVUL2("MHV7B9A","END ORG","S","TRACE")
"RTN","MHV7B9A",160,0)
 Q
"RTN","MHV7B9A",161,0)
PRA(MSGROOT,DATAROOT,CNT,LEN,HL)    ;Build PRA segments for providers
"RTN","MHV7B9A",162,0)
 ;
"RTN","MHV7B9A",163,0)
 ; Walks data in DATAROOT to populate MSGROOT with PRA segments
"RTN","MHV7B9A",164,0)
 ; sequentially numbered starting at CNT
"RTN","MHV7B9A",165,0)
 ;
"RTN","MHV7B9A",166,0)
 ;  Integration Agreements:
"RTN","MHV7B9A",167,0)
 ;        10103 : FMTHL7^XLFDT
"RTN","MHV7B9A",168,0)
 ;
"RTN","MHV7B9A",169,0)
 ;  Input:
"RTN","MHV7B9A",170,0)
 ;   MSGROOT - Root of array holding the message
"RTN","MHV7B9A",171,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHV7B9A",172,0)
 ;       CNT - Current message line counter
"RTN","MHV7B9A",173,0)
 ;       LEN - Current message length
"RTN","MHV7B9A",174,0)
 ;        HL - HL7 package array variable
"RTN","MHV7B9A",175,0)
 ;
"RTN","MHV7B9A",176,0)
 ;  Output:
"RTN","MHV7B9A",177,0)
 ;           - Populated message array
"RTN","MHV7B9A",178,0)
 ;           - Updated LEN and CNT
"RTN","MHV7B9A",179,0)
 ;
"RTN","MHV7B9A",180,0)
 N I,USR,PRA
"RTN","MHV7B9A",181,0)
 D LOG^MHVUL2("MHV7B9A","BEGIN PRA","S","TRACE")
"RTN","MHV7B9A",182,0)
 S DATAROOT=$P(DATAROOT,",",1,3)
"RTN","MHV7B9A",183,0)
 S DATAROOT=$TR(DATAROOT,")","")_","_"""PROVIDERS"""_")"
"RTN","MHV7B9A",184,0)
 F I=1:1 Q:'$D(@DATAROOT@(I))  D
"RTN","MHV7B9A",185,0)
 . S USR=@DATAROOT@(I)
"RTN","MHV7B9A",186,0)
 . S PRA(0)="PRA"
"RTN","MHV7B9A",187,0)
 . S PRA(2,1,1)=$P(USR,"^",1)   ;IEN
"RTN","MHV7B9A",188,0)
 . S PRA(2,1,2)=$P(USR,"^",2)   ;NAME
"RTN","MHV7B9A",189,0)
 . S CNT=CNT+1
"RTN","MHV7B9A",190,0)
 . S @MSGROOT@(CNT)=$$BLDSEG^MHV7U(.PRA,.HL)
"RTN","MHV7B9A",191,0)
 . S LEN=LEN+$L(@MSGROOT@(CNT))
"RTN","MHV7B9A",192,0)
 . Q
"RTN","MHV7B9A",193,0)
 D LOG^MHVUL2("MHV7B9A","END PRA","S","TRACE")
"RTN","MHV7B9A",194,0)
 Q
"RTN","MHV7R5")
0^24^B32891553^n/a
"RTN","MHV7R5",1,0)
MHV7R5 ;WAS/DLF - HL7 RECEIVER FOR ADMIN QUERIES ; 9/25/08 4:09pm
"RTN","MHV7R5",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHV7R5",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHV7R5",4,0)
 ;
"RTN","MHV7R5",5,0)
 Q
"RTN","MHV7R5",6,0)
 ;
"RTN","MHV7R5",7,0)
QBPQ11 ;Process QBP^Q11 messages from the MHVSM QBP-Q11 Subscriber protocol
"RTN","MHV7R5",8,0)
 ;
"RTN","MHV7R5",9,0)
 ; This routine and subroutines assume that all VistA HL7 environment
"RTN","MHV7R5",10,0)
 ; variables are properly initialized and will produce a fatal error
"RTN","MHV7R5",11,0)
 ; if they are missing.
"RTN","MHV7R5",12,0)
 ;
"RTN","MHV7R5",13,0)
 ;  The message will be checked to see if it is a valid query.
"RTN","MHV7R5",14,0)
 ; If not a negative acknowledgement will be sent.  If the query is an
"RTN","MHV7R5",15,0)
 ; immediate mode or synchronous query, the realtime request manager
"RTN","MHV7R5",16,0)
 ; is called to handle the query.  This means the query will be
"RTN","MHV7R5",17,0)
 ; processed and a response generated immediately.
"RTN","MHV7R5",18,0)
 ; In the future deferred mode queries may be filed in a database for
"RTN","MHV7R5",19,0)
 ; later processing, or transmission.
"RTN","MHV7R5",20,0)
 ;
"RTN","MHV7R5",21,0)
 ;  Input:
"RTN","MHV7R5",22,0)
 ;          HL7 environment variables
"RTN","MHV7R5",23,0)
 ;
"RTN","MHV7R5",24,0)
 ; Output:
"RTN","MHV7R5",25,0)
 ;          Processed query or negative acknowledgement
"RTN","MHV7R5",26,0)
 ;          If handled real-time the query response is generated
"RTN","MHV7R5",27,0)
 ;
"RTN","MHV7R5",28,0)
 ;  Integration Agreements
"RTN","MHV7R5",29,0)
 ;
"RTN","MHV7R5",30,0)
 ;          10104 UP^XLFSTR
"RTN","MHV7R5",31,0)
 ;
"RTN","MHV7R5",32,0)
 N MSGROOT,QRY,XMT,ERR,RNAME
"RTN","MHV7R5",33,0)
 S (QRY,XMT,ERR)=""
"RTN","MHV7R5",34,0)
 ; Inbound query messages are small enough to be held in a local.
"RTN","MHV7R5",35,0)
 ; The following lines commented out support use of global and are
"RTN","MHV7R5",36,0)
 ; left in case use a global becomes necessary.
"RTN","MHV7R5",37,0)
 ;S MSGROOT="^TMP(""MHV7"",$J)"
"RTN","MHV7R5",38,0)
 ;K @MSGROOT
"RTN","MHV7R5",39,0)
 S MSGROOT="MHV7MSG"
"RTN","MHV7R5",40,0)
 N MHV7MSG
"RTN","MHV7R5",41,0)
 D LOADXMT^MHV7U(.XMT)         ;Load inbound message information
"RTN","MHV7R5",42,0)
 ;
"RTN","MHV7R5",43,0)
 S RNAME=XMT("MESSAGE TYPE")_"-"_XMT("EVENT TYPE")_" RECEIVER"
"RTN","MHV7R5",44,0)
 D LOG^MHVUL2(RNAME,"BEGIN","S","TRACE")
"RTN","MHV7R5",45,0)
 ;
"RTN","MHV7R5",46,0)
 D LOADMSG^MHV7U(MSGROOT)
"RTN","MHV7R5",47,0)
 D LOG^MHVUL2("LOAD",MSGROOT,"I","DEBUG")
"RTN","MHV7R5",48,0)
 ;
"RTN","MHV7R5",49,0)
 D PARSEMSG^MHV7U(MSGROOT,.HL)
"RTN","MHV7R5",50,0)
 D LOG^MHVUL2("PARSE",MSGROOT,"I","DEBUG")
"RTN","MHV7R5",51,0)
 ;
"RTN","MHV7R5",52,0)
 I '$$VALIDMSG(MSGROOT,.QRY,.XMT,.ERR) D  Q
"RTN","MHV7R5",53,0)
 . D LOG^MHVUL2("MSG CHECK","INVALID^"_ERR,"S","ERROR")
"RTN","MHV7R5",54,0)
 . D XMIT^MHV7T(.QRY,.XMT,ERR,"",.HL)
"RTN","MHV7R5",55,0)
 D LOG^MHVUL2("MSG CHECK","VALID","S","TRACE")
"RTN","MHV7R5",56,0)
 ;
"RTN","MHV7R5",57,0)
 ; Immediate Mode
"RTN","MHV7R5",58,0)
 ; Deferred mode queries are not supported at this time
"RTN","MHV7R5",59,0)
 D REALTIME^MHVRQI(.QRY,.XMT,.HL)
"RTN","MHV7R5",60,0)
 ;
"RTN","MHV7R5",61,0)
 D LOG^MHVUL2(RNAME,"END","S","TRACE")
"RTN","MHV7R5",62,0)
 D RESET^MHVUL2          ;Clean up TMP used by logging
"RTN","MHV7R5",63,0)
 ;K @MSGROOT
"RTN","MHV7R5",64,0)
 ;
"RTN","MHV7R5",65,0)
 Q
"RTN","MHV7R5",66,0)
 ;
"RTN","MHV7R5",67,0)
VALIDMSG(MSGROOT,QRY,XMT,ERR)   ;Validate message
"RTN","MHV7R5",68,0)
 ;
"RTN","MHV7R5",69,0)
 ;  Messages handled: QBP^Q11
"RTN","MHV7R5",70,0)
 ;
"RTN","MHV7R5",71,0)
 ;  QBP query messages must contain QPD and RCP segments
"RTN","MHV7R5",72,0)
 ;  Any additional segments are ignored
"RTN","MHV7R5",73,0)
 ;
"RTN","MHV7R5",74,0)
 ;  Input:
"RTN","MHV7R5",75,0)
 ;    MSGROOT - Root of array holding message
"RTN","MHV7R5",76,0)
 ;        XMT - Transmission parameters
"RTN","MHV7R5",77,0)
 ;
"RTN","MHV7R5",78,0)
 ; Output:
"RTN","MHV7R5",79,0)
 ;        QRY - Query Array
"RTN","MHV7R5",80,0)
 ;        XMT - Transmission parameters
"RTN","MHV7R5",81,0)
 ;        ERR - segment^sequence^field^code^ACK type^error text
"RTN","MHV7R5",82,0)
 ;
"RTN","MHV7R5",83,0)
 N MSH,PID,STF,QPD,RCP,REQFLDS,REQID,REQTYPE,FROMDT,TODT,PRI,QTAG,QNAME
"RTN","MHV7R5",84,0)
 N SEGTYPE,CNT,OCNT,RXNUM,QTY,UNIT,REQFLDS,CHKSEG
"RTN","MHV7R5",85,0)
 K QRY,ERR
"RTN","MHV7R5",86,0)
 S ERR=""
"RTN","MHV7R5",87,0)
 ;
"RTN","MHV7R5",88,0)
 ; Set up basics for responding to message.
"RTN","MHV7R5",89,0)
 ;-----------------------------------------
"RTN","MHV7R5",90,0)
 S QRY("MID")=XMT("MID")        ;Message ID
"RTN","MHV7R5",91,0)
 S QRY("QPD")=""
"RTN","MHV7R5",92,0)
 ;
"RTN","MHV7R5",93,0)
 ; Validate message is a well-formed QBP query message.
"RTN","MHV7R5",94,0)
 ;-----------------------------------------------------------
"RTN","MHV7R5",95,0)
 ; Must have MSH first, followed by QPD,RCP in any order
"RTN","MHV7R5",96,0)
 ; PID and STF are optional.  All other segments are ignored.
"RTN","MHV7R5",97,0)
 ;
"RTN","MHV7R5",98,0)
 I $G(@MSGROOT@(1,0))="MSH" M MSH=@MSGROOT@(1)
"RTN","MHV7R5",99,0)
 E  S ERR="MSH^1^^100^AE^Missing MSH segment" Q 0
"RTN","MHV7R5",100,0)
 ;
"RTN","MHV7R5",101,0)
 S CNT=2,OCNT=0
"RTN","MHV7R5",102,0)
 F  Q:'$D(@MSGROOT@(CNT))  D  S CNT=CNT+1
"RTN","MHV7R5",103,0)
 . S SEGTYPE=$G(@MSGROOT@(CNT,0))
"RTN","MHV7R5",104,0)
 . I SEGTYPE="PID" M PID=@MSGROOT@(CNT),QRY("PID")=PID Q
"RTN","MHV7R5",105,0)
 . I SEGTYPE="STF" M STF=@MSGROOT@(CNT),QRY("STF")=STF Q
"RTN","MHV7R5",106,0)
 . I SEGTYPE="QPD" M QPD=@MSGROOT@(CNT),QRY("QPD")=QPD Q
"RTN","MHV7R5",107,0)
 . I SEGTYPE="RCP" M RCP=@MSGROOT@(CNT),QRY("RCP")=RCP Q
"RTN","MHV7R5",108,0)
 . Q
"RTN","MHV7R5",109,0)
 ;
"RTN","MHV7R5",110,0)
 I '$D(QPD) S ERR="QPD^1^^100^AE^Missing QPD segment" Q 0
"RTN","MHV7R5",111,0)
 ;
"RTN","MHV7R5",112,0)
 S QTAG=$G(QPD(1,1,2))               ;Query Tag
"RTN","MHV7R5",113,0)
 S REQID=$G(QPD(2))                  ;Request ID
"RTN","MHV7R5",114,0)
 S REQTYPE=$G(QPD(3,1,1))            ;Request Type
"RTN","MHV7R5",115,0)
 S PRI=$G(RCP(1))                    ;Query Priority
"RTN","MHV7R5",116,0)
 S QTY=$G(RCP(2,1,1))                ;Quantity Limited
"RTN","MHV7R5",117,0)
 S UNIT=$G(RCP(2,1,2))               ;Quantity units
"RTN","MHV7R5",118,0)
 S:REQTYPE="" REQTYPE=$G(QPD(3))     ;Request Type if no other params
"RTN","MHV7R5",119,0)
 ;
"RTN","MHV7R5",120,0)
 ; Validate required fields and query parameters
"RTN","MHV7R5",121,0)
 ;------------------------------------------------------
"RTN","MHV7R5",122,0)
 ;
"RTN","MHV7R5",123,0)
 ; Check for missing/invalid fields
"RTN","MHV7R5",124,0)
 ;
"RTN","MHV7R5",125,0)
 I '$D(QPD(1)) S ERR="QPD^1^1^101^AE^Missing Message Query Name" Q 0
"RTN","MHV7R5",126,0)
 M QNAME=QPD(1)  ;Message Query Name
"RTN","MHV7R5",127,0)
 ;
"RTN","MHV7R5",128,0)
 I QTAG="" S ERR="QPD^1^2^101^AE^Missing Query Tag" Q 0
"RTN","MHV7R5",129,0)
 I REQID="" S ERR="QPD^1^2^101^AE^Missing Request ID" Q 0
"RTN","MHV7R5",130,0)
 S (QRY("IEN"),QRY("LNAME"),QRY("FNAME"),QRY("DFN"))=""
"RTN","MHV7R5",131,0)
 S QRY("REQID")=REQID
"RTN","MHV7R5",132,0)
 ;
"RTN","MHV7R5",133,0)
 I REQTYPE="" S ERR="QPD^1^3^101^AE^Missing Request Type" Q 0
"RTN","MHV7R5",134,0)
 I '$$VALRTYPE^MHV7RU(REQTYPE,.QRY,.ERR) S ERR="QPD^1^3^"_ERR Q 0
"RTN","MHV7R5",135,0)
 ;
"RTN","MHV7R5",136,0)
 ; If we have a PID, validate it and populate query parameters
"RTN","MHV7R5",137,0)
 ; from the PID.
"RTN","MHV7R5",138,0)
 ;
"RTN","MHV7R5",139,0)
 I $D(PID) D VALIDPID
"RTN","MHV7R5",140,0)
 ;
"RTN","MHV7R5",141,0)
 ; If we have a STF, validate it and populate query parameters
"RTN","MHV7R5",142,0)
 ; from the STF.  
"RTN","MHV7R5",143,0)
 ;
"RTN","MHV7R5",144,0)
 I $D(STF) D VALIDSTF
"RTN","MHV7R5",145,0)
 ;
"RTN","MHV7R5",146,0)
 I ERR Q 0
"RTN","MHV7R5",147,0)
 ;
"RTN","MHV7R5",148,0)
 ; If no PID or STF segment sent, Populate parameters 1-3 with the
"RTN","MHV7R5",149,0)
 ; QPD segment data
"RTN","MHV7R5",150,0)
 ;
"RTN","MHV7R5",151,0)
 I '$D(PID),'$D(STF)  D
"RTN","MHV7R5",152,0)
 .S QRY("IEN")=$G(QPD(3,1,2))          ;ien
"RTN","MHV7R5",153,0)
 .S QRY("LNAME")=$$UP^XLFSTR($G(QPD(3,1,3)))        ;Last Name
"RTN","MHV7R5",154,0)
 .S QRY("FNAME")=$$UP^XLFSTR($G(QPD(3,1,4)))        ;First Name
"RTN","MHV7R5",155,0)
 S FROMDT=$G(QPD(3,1,5))        ;From Date
"RTN","MHV7R5",156,0)
 S TODT=$G(QPD(3,1,6))          ;To Date
"RTN","MHV7R5",157,0)
 ;
"RTN","MHV7R5",158,0)
 ; Validate from and to date if present
"RTN","MHV7R5",159,0)
 ;
"RTN","MHV7R5",160,0)
 I FROMDT]""  D
"RTN","MHV7R5",161,0)
 .I '$$VALIDDT^MHV7RU(.FROMDT) S ERR="QPD^1^7^102^AE^Invalid From Date"
"RTN","MHV7R5",162,0)
 I TODT]""  D
"RTN","MHV7R5",163,0)
 .I '$$VALIDDT^MHV7RU(.TODT) S ERR="QPD^1^8^102^AE^Invalid To Date"
"RTN","MHV7R5",164,0)
 .I TODT'="",TODT<FROMDT  D
"RTN","MHV7R5",165,0)
 ..S ERR="QPD^1^6^102^AE^To Date precedes From Date"
"RTN","MHV7R5",166,0)
 S QRY("FROMDT")=FROMDT,QRY("TODT")=TODT
"RTN","MHV7R5",167,0)
 I ERR'="" Q 0
"RTN","MHV7R5",168,0)
 ;
"RTN","MHV7R5",169,0)
 I PRI="" S ERR="RCP^1^1^101^AE^Missing Query Priority" Q 0
"RTN","MHV7R5",170,0)
 I ",D,I,"'[(","_PRI_",") S ERR="RCP^1^1^102^AE^Invalid Query Priority" Q 0
"RTN","MHV7R5",171,0)
 S QRY("PRI")=PRI
"RTN","MHV7R5",172,0)
 Q:ERR'="" 0
"RTN","MHV7R5",173,0)
 ;
"RTN","MHV7R5",174,0)
 Q 1
"RTN","MHV7R5",175,0)
 ;
"RTN","MHV7R5",176,0)
VALIDPID ;
"RTN","MHV7R5",177,0)
 ;
"RTN","MHV7R5",178,0)
 ; If the IEN was sent, call the validation utility for
"RTN","MHV7R5",179,0)
 ; PID segments
"RTN","MHV7R5",180,0)
 ;
"RTN","MHV7R5",181,0)
 I $D(PID(3,1,1))  D
"RTN","MHV7R5",182,0)
 .S CHKSEG=$$VALIDPID^MHV7RUS(.PID,.QRY,.ERR)
"RTN","MHV7R5",183,0)
 .S QRY("IEN")=QRY("DFN")
"RTN","MHV7R5",184,0)
 ;
"RTN","MHV7R5",185,0)
 ; If no IEN, populate parameters for name
"RTN","MHV7R5",186,0)
 ;
"RTN","MHV7R5",187,0)
 I QRY("IEN")="",ERR=""  D
"RTN","MHV7R5",188,0)
 .S QRY("LNAME")=$$UP^XLFSTR(PID(5,1,1))
"RTN","MHV7R5",189,0)
 .S:$D(PID(5,1,2)) QRY("FNAME")=$$UP^XLFSTR(PID(5,1,2))
"RTN","MHV7R5",190,0)
 Q
"RTN","MHV7R5",191,0)
VALIDSTF        ;
"RTN","MHV7R5",192,0)
 ;
"RTN","MHV7R5",193,0)
 ; If the IEN was sent, call the validation utility for
"RTN","MHV7R5",194,0)
 ; STF segments
"RTN","MHV7R5",195,0)
 ;
"RTN","MHV7R5",196,0)
 I $D(STF(2))  D  Q
"RTN","MHV7R5",197,0)
 .S QRY("IEN")=STF(2,1,1)
"RTN","MHV7R5",198,0)
 ;
"RTN","MHV7R5",199,0)
 ; If no IEN, populate parameters for name
"RTN","MHV7R5",200,0)
 ;
"RTN","MHV7R5",201,0)
 I $G(STF(3))]"" S QRY("LNAME")=$$UP^XLFSTR($TR(STF(3),"^",""))
"RTN","MHV7R5",202,0)
 S:$D(STF(3,1,1)) QRY("LNAME")=$$UP^XLFSTR(STF(3,1,1))
"RTN","MHV7R5",203,0)
 S:$D(STF(3,1,2)) QRY("FNAME")=$$UP^XLFSTR(STF(3,1,2))
"RTN","MHV7R5",204,0)
 Q
"RTN","MHVXCLN")
0^37^B3158368^n/a
"RTN","MHVXCLN",1,0)
MHVXCLN ;WAS/DLF - Clinic extract ; 9/25/08 4:10pm
"RTN","MHVXCLN",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHVXCLN",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHVXCLN",4,0)
 ;
"RTN","MHVXCLN",5,0)
 Q
"RTN","MHVXCLN",6,0)
 ;
"RTN","MHVXCLN",7,0)
 ;  Integration Agreements:
"RTN","MHVXCLN",8,0)
 ;
"RTN","MHVXCLN",9,0)
 ;               10103 : $$DT^XLFDT
"RTN","MHVXCLN",10,0)
 ;                       $$NOW^XLFDT
"RTN","MHVXCLN",11,0)
 ;               10040 : ^SC("B"
"RTN","MHVXCLN",12,0)
 ;
"RTN","MHVXCLN",13,0)
CLIN(QRY,ERR,DATAROOT)               ; return all Clinics
"RTN","MHVXCLN",14,0)
 ;
"RTN","MHVXCLN",15,0)
 ; return provider data in DATAROOT
"RTN","MHVXCLN",16,0)
 ; QRY, ERR passed by ref.
"RTN","MHVXCLN",17,0)
 ;
"RTN","MHVXCLN",18,0)
 ;  Input:
"RTN","MHVXCLN",19,0)
 ;       QRY - Query array
"RTN","MHVXCLN",20,0)
 ;
"RTN","MHVXCLN",21,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHVXCLN",22,0)
 ;
"RTN","MHVXCLN",23,0)
 ;  Output:
"RTN","MHVXCLN",24,0)
 ;  DATAROOT - Populated data array
"RTN","MHVXCLN",25,0)
 ;             includes number of hits and timestamp
"RTN","MHVXCLN",26,0)
 ;       ERR - Errors during extraction, zero on success
"RTN","MHVXCLN",27,0)
 ;
"RTN","MHVXCLN",28,0)
 N DT,EXTIME,HIT,KEYNM,LOGND,CLINAR,CLIEN,CLNM,U,X
"RTN","MHVXCLN",29,0)
 ;
"RTN","MHVXCLN",30,0)
 S LOGND=$T(+0)_"^CLINIC"  ; node for logging
"RTN","MHVXCLN",31,0)
 D LOG^MHVUL2(LOGND,"BEGIN","S","TRACE")
"RTN","MHVXCLN",32,0)
 ; needed vars.
"RTN","MHVXCLN",33,0)
 S U="^",DT=$$DT^XLFDT,ERR=0,EXTIME=$$NOW^XLFDT,HIT=0
"RTN","MHVXCLN",34,0)
 ;
"RTN","MHVXCLN",35,0)
 K @DATAROOT  ; clean up residue
"RTN","MHVXCLN",36,0)
 S HIT=0
"RTN","MHVXCLN",37,0)
 S CLNM=$O(^SC("B",QRY("LNAME")),-1)
"RTN","MHVXCLN",38,0)
 I QRY("LNAME")="" S CLNM=99
"RTN","MHVXCLN",39,0)
 S DATAROOT=$E(DATAROOT,1,$L(DATAROOT)-1)_","_"""CLINICS"""_")"
"RTN","MHVXCLN",40,0)
 F  S CLNM=$O(^SC("B",CLNM)) Q:CLNM=""  D
"RTN","MHVXCLN",41,0)
 .S CLIEN=0
"RTN","MHVXCLN",42,0)
 .S CLIEN=$O(^SC("B",CLNM,CLIEN))
"RTN","MHVXCLN",43,0)
 .I $E(CLNM,1,$L(QRY("LNAME")))=QRY("LNAME")  D
"RTN","MHVXCLN",44,0)
 ..S HIT=HIT+1
"RTN","MHVXCLN",45,0)
 ..S @DATAROOT@(HIT)=CLIEN_U_CLNM
"RTN","MHVXCLN",46,0)
 ;
"RTN","MHVXCLN",47,0)
 S @DATAROOT=HIT_U_EXTIME  ; hits ^ time
"RTN","MHVXCLN",48,0)
 D XITLOG(LOGND,HIT)
"RTN","MHVXCLN",49,0)
 ;
"RTN","MHVXCLN",50,0)
 Q
"RTN","MHVXCLN",51,0)
XITLOG(ND,HT)     ; exit log
"RTN","MHVXCLN",52,0)
 D LOG^MHVUL2(ND,HT_" HITS","S","TRACE")
"RTN","MHVXCLN",53,0)
 D LOG^MHVUL2(ND,"END","S","TRACE") Q
"RTN","MHVXCLN",54,0)
 Q
"RTN","MHVXPAT")
0^40^B60657479^n/a
"RTN","MHVXPAT",1,0)
MHVXPAT ;WAS/DLF - Patient extract ; 9/25/08 4:11pm
"RTN","MHVXPAT",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHVXPAT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHVXPAT",4,0)
 ;
"RTN","MHVXPAT",5,0)
 Q
"RTN","MHVXPAT",6,0)
 ;
"RTN","MHVXPAT",7,0)
 ;  Integration Agreements:
"RTN","MHVXPAT",8,0)
 ;
"RTN","MHVXPAT",9,0)
 ;               10060 : New Person file #200
"RTN","MHVXPAT",10,0)
 ;                1916 : PTPR^SCAPMC
"RTN","MHVXPAT",11,0)
 ;                       PRPT^SCAPMC
"RTN","MHVXPAT",12,0)
 ;                3859 : GETAPPT^SDAMA201
"RTN","MHVXPAT",13,0)
 ;                5250 : PTCL^SCAPMC
"RTN","MHVXPAT",14,0)
 ;                2692 : TEAMPTS^ORQPTQ1
"RTN","MHVXPAT",15,0)
 ;                       TEAMSPT^ORQPTQ1
"RTN","MHVXPAT",16,0)
 ;               10103 : $$DT^XLFDT
"RTN","MHVXPAT",17,0)
 ;                       $$NOW^XLFDT
"RTN","MHVXPAT",18,0)
 ;                       $$HL7TFM$XLFDT
"RTN","MHVXPAT",19,0)
 ;                       
"RTN","MHVXPAT",20,0)
PATCL(QRY,ERR,DATAROOT)             ;Patients for clinic
"RTN","MHVXPAT",21,0)
 ;
"RTN","MHVXPAT",22,0)
 ; Primary Care Management Module interface
"RTN","MHVXPAT",23,0)
 ; return patient list in dataroot
"RTN","MHVXPAT",24,0)
 ; QRY, ERR passed by ref.
"RTN","MHVXPAT",25,0)
 ;
"RTN","MHVXPAT",26,0)
 ;    Input:
"RTN","MHVXPAT",27,0)
 ;       QRY - Query array
"RTN","MHVXPAT",28,0)
 ;       QRY(CLIN IEN) - ien of Hospital location file (#44)
"RTN","MHVXPAT",29,0)
 ;       DATAROOT - Root of array to hold extract data
"RTN","MHVXPAT",30,0)
 ;
"RTN","MHVXPAT",31,0)
 ;    Output:
"RTN","MHVXPAT",32,0)
 ;       DATAROOT - Populated data array
"RTN","MHVXPAT",33,0)
 ;             includes number of hits and timestamp
"RTN","MHVXPAT",34,0)
 ;       ERR - Errors during extraction, zero on success
"RTN","MHVXPAT",35,0)
 ;
"RTN","MHVXPAT",36,0)
 N DT,EXTIME,HIT,LOGND,FROMDT,TODT,RTN,U,X,ICN,SSN,CLINIEN
"RTN","MHVXPAT",37,0)
 ;
"RTN","MHVXPAT",38,0)
 S RTN=$T(+0),LOGND=RTN_"^PTPCMP"  ; node for logging
"RTN","MHVXPAT",39,0)
 D LOG^MHVUL2(LOGND,"BEGIN","S","TRACE")
"RTN","MHVXPAT",40,0)
 ; needed vars.
"RTN","MHVXPAT",41,0)
 S U="^",DT=$$DT^XLFDT,ERR=0,EXTIME=$$NOW^XLFDT,HIT=0
"RTN","MHVXPAT",42,0)
 ;
"RTN","MHVXPAT",43,0)
 K @DATAROOT,^TMP(RTN,$J)  ; clean up residue
"RTN","MHVXPAT",44,0)
 ;
"RTN","MHVXPAT",45,0)
 I '$G(QRY("FROMDT")) S QRY("FROMDT")=2920101
"RTN","MHVXPAT",46,0)
 I '$G(QRY("TODT")) S QRY("TODT")=DT
"RTN","MHVXPAT",47,0)
 S FROMDT=QRY("FROMDT")
"RTN","MHVXPAT",48,0)
 S TODT=QRY("TODT")
"RTN","MHVXPAT",49,0)
 S CLINIEN=$G(QRY("IEN"))
"RTN","MHVXPAT",50,0)
 I '(CLINIEN>0) S ERR="1^Clinic IEN missing" Q
"RTN","MHVXPAT",51,0)
 ;
"RTN","MHVXPAT",52,0)
 ;
"RTN","MHVXPAT",53,0)
 ; get all PCM patients for CLinic
"RTN","MHVXPAT",54,0)
 D:'ERR
"RTN","MHVXPAT",55,0)
 .N MHVDATES,J,RSLT,RSLTLST,SCER,TM,ICN,PTIEN
"RTN","MHVXPAT",56,0)
 .S RSLTLST=$NA(^TMP(RTN,$J,"CLINIC"))
"RTN","MHVXPAT",57,0)
 .S MHVDATES("BEGIN")=$$HL7TFM^XLFDT(FROMDT)
"RTN","MHVXPAT",58,0)
 .S MHVDATES("END")=$$HL7TFM^XLFDT(TODT)
"RTN","MHVXPAT",59,0)
 .S MHVDATES("INCL")=0
"RTN","MHVXPAT",60,0)
 .S RSLT=$$PTCL^SCAPMC(CLINIEN,.MHVDATES,RSLTLST,"SCER")
"RTN","MHVXPAT",61,0)
 .I $G(SCER(0)) D  Q
"RTN","MHVXPAT",62,0)
 ..S ERR="1^errors ("_SCER(0)_") returned by PTCL^SCAPMC"
"RTN","MHVXPAT",63,0)
 .; now save results
"RTN","MHVXPAT",64,0)
 .S J=0
"RTN","MHVXPAT",65,0)
 .F  S J=$O(^TMP(RTN,$J,"CLINIC",J))  Q:'J  S TM=$G(^(J))  D
"RTN","MHVXPAT",66,0)
 ..S PTIEN=$P(TM,U,1)
"RTN","MHVXPAT",67,0)
 ..S ICN=$$GET1^DIQ(2,PTIEN_",",991.01)
"RTN","MHVXPAT",68,0)
 ..S SSN=$$GET1^DIQ(2,PTIEN_",",.09)
"RTN","MHVXPAT",69,0)
 ..S HIT=HIT+1,@DATAROOT@(HIT)=PTIEN_U_""_U_$P(TM,U,2)_U_ICN_U_SSN
"RTN","MHVXPAT",70,0)
 ;
"RTN","MHVXPAT",71,0)
 S @DATAROOT=HIT_U_EXTIME  ; hits ^ time
"RTN","MHVXPAT",72,0)
 D XITLOG(LOGND,HIT)
"RTN","MHVXPAT",73,0)
 ;
"RTN","MHVXPAT",74,0)
 Q
"RTN","MHVXPAT",75,0)
PATTM(QRY,ERR,DATAROOT)             ;Patients for team
"RTN","MHVXPAT",76,0)
 ;
"RTN","MHVXPAT",77,0)
 ; Primary Care Management Module interface
"RTN","MHVXPAT",78,0)
 ; return patient list in dataroot
"RTN","MHVXPAT",79,0)
 ; QRY, ERR passed by ref.
"RTN","MHVXPAT",80,0)
 ;
"RTN","MHVXPAT",81,0)
 ;    Input:
"RTN","MHVXPAT",82,0)
 ;       QRY     - Query array
"RTN","MHVXPAT",83,0)
 ;       QRY(P1) - ien of OE/RR list file (#100.21)
"RTN","MHVXPAT",84,0)
 ;       DATAROOT - Root of array to hold extract data
"RTN","MHVXPAT",85,0)
 ;
"RTN","MHVXPAT",86,0)
 ;    Output:
"RTN","MHVXPAT",87,0)
 ;       DATAROOT - Populated data array
"RTN","MHVXPAT",88,0)
 ;             includes number of hits and timestamp
"RTN","MHVXPAT",89,0)
 ;       ERR - Errors during extraction, zero on success
"RTN","MHVXPAT",90,0)
 ;
"RTN","MHVXPAT",91,0)
 N DT,EXTIME,HIT,LOGND,TEAMIEN,RTN,U,X,ICN,SSN
"RTN","MHVXPAT",92,0)
 ;
"RTN","MHVXPAT",93,0)
 S RTN=$T(+0),LOGND=RTN_"^PATTM"  ; node for logging
"RTN","MHVXPAT",94,0)
 D LOG^MHVUL2(LOGND,"BEGIN","S","TRACE")
"RTN","MHVXPAT",95,0)
 ; needed vars.
"RTN","MHVXPAT",96,0)
 S U="^",DT=$$DT^XLFDT,ERR=0,EXTIME=$$NOW^XLFDT,HIT=0
"RTN","MHVXPAT",97,0)
 ;
"RTN","MHVXPAT",98,0)
 K @DATAROOT,^TMP(RTN,$J)  ; clean up residue
"RTN","MHVXPAT",99,0)
 ;
"RTN","MHVXPAT",100,0)
 S TEAMIEN=$G(QRY("IEN"))
"RTN","MHVXPAT",101,0)
 I '(TEAMIEN>0) S ERR="1^Team IEN missing" Q
"RTN","MHVXPAT",102,0)
 ; get all patients for Team
"RTN","MHVXPAT",103,0)
 N MHVDATES,J,RSLT,RSLTLST,TM,PTIEN,ICN
"RTN","MHVXPAT",104,0)
 S RSLTLST=$NA(^TMP(RTN,$J,"PTTM"))
"RTN","MHVXPAT",105,0)
 S RSLTLST=$E(RSLTLST,1,$L(RSLTLST)-1)_","
"RTN","MHVXPAT",106,0)
 D TEAMPTS^ORQPTQ1(RSLTLST,TEAMIEN,1)
"RTN","MHVXPAT",107,0)
 Q:^TMP(RTN,$J,"PTTM",1)["No patients"
"RTN","MHVXPAT",108,0)
 ; now save results
"RTN","MHVXPAT",109,0)
 S J=0
"RTN","MHVXPAT",110,0)
 F  S J=$O(^TMP(RTN,$J,"PTTM",J))  Q:'J  S TM=$G(^(J))  D
"RTN","MHVXPAT",111,0)
 .S PTIEN=$P(TM,U,1)
"RTN","MHVXPAT",112,0)
 .S ICN=$$GET1^DIQ(2,PTIEN_",",991.01)
"RTN","MHVXPAT",113,0)
 .S SSN=$$GET1^DIQ(2,PTIEN_",",.09)
"RTN","MHVXPAT",114,0)
 .S HIT=HIT+1,@DATAROOT@(HIT)=PTIEN_U_""_U_$P(TM,U,2)_U_ICN_U_SSN
"RTN","MHVXPAT",115,0)
 ;
"RTN","MHVXPAT",116,0)
 S @DATAROOT=HIT_U_EXTIME  ; hits ^ time
"RTN","MHVXPAT",117,0)
 D XITLOG(LOGND,HIT)
"RTN","MHVXPAT",118,0)
 ;
"RTN","MHVXPAT",119,0)
 Q
"RTN","MHVXPAT",120,0)
PTPCMP(QRY,ERR,DATAROOT)           ; patients for PCMM provider
"RTN","MHVXPAT",121,0)
 ; Primary Care Management Module interface
"RTN","MHVXPAT",122,0)
 ; return patient data in DATAROOT
"RTN","MHVXPAT",123,0)
 ; QRY, ERR passed by ref.
"RTN","MHVXPAT",124,0)
 ;
"RTN","MHVXPAT",125,0)
 ;  Input:
"RTN","MHVXPAT",126,0)
 ;       QRY - Query array
"RTN","MHVXPAT",127,0)
 ;       QRY("PRVDR IEN") - ien NEW PERSON file (#200)
"RTN","MHVXPAT",128,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHVXPAT",129,0)
 ;
"RTN","MHVXPAT",130,0)
 ;  Output:
"RTN","MHVXPAT",131,0)
 ;  DATAROOT - Populated data array
"RTN","MHVXPAT",132,0)
 ;             includes number of hits and timestamp
"RTN","MHVXPAT",133,0)
 ;       ERR - Errors during extraction, zero on success
"RTN","MHVXPAT",134,0)
 ;
"RTN","MHVXPAT",135,0)
 N DT,EXTIME,HIT,LOGND,PRVIEN,RTN,U,X,ICN,SSN
"RTN","MHVXPAT",136,0)
 ;
"RTN","MHVXPAT",137,0)
 S RTN=$T(+0),LOGND=RTN_"^PTPCMP"  ; node for logging
"RTN","MHVXPAT",138,0)
 D LOG^MHVUL2(LOGND,"BEGIN","S","TRACE")
"RTN","MHVXPAT",139,0)
 ; needed vars.
"RTN","MHVXPAT",140,0)
 S U="^",DT=$$DT^XLFDT,ERR=0,EXTIME=$$NOW^XLFDT,HIT=0
"RTN","MHVXPAT",141,0)
 ;
"RTN","MHVXPAT",142,0)
 K @DATAROOT,^TMP(RTN,$J)  ; clean up residue
"RTN","MHVXPAT",143,0)
 ;
"RTN","MHVXPAT",144,0)
 S PRVIEN=$G(QRY("IEN"))
"RTN","MHVXPAT",145,0)
 I '(PRVIEN>0) S ERR="1^provider IEN missing" Q
"RTN","MHVXPAT",146,0)
 ;
"RTN","MHVXPAT",147,0)
 ;
"RTN","MHVXPAT",148,0)
 ; get all PCM patients for provider
"RTN","MHVXPAT",149,0)
 D:'ERR
"RTN","MHVXPAT",150,0)
 .N MHVDATES,J,RSLT,RSLTLST,SCER,TM,PTIEN,ICN
"RTN","MHVXPAT",151,0)
 .S RSLTLST=$NA(^TMP(RTN,$J,"PRVDR"))
"RTN","MHVXPAT",152,0)
 .S MHVDATES("BEGIN")="",MHVDATES("END")=DT  ; only for today
"RTN","MHVXPAT",153,0)
 .S MHVDATES("INCL")=1  ; include all
"RTN","MHVXPAT",154,0)
 .S RSLT=$$PTPR^SCAPMC(PRVIEN,.MHVDATES,"","",RSLTLST,"SCER","")
"RTN","MHVXPAT",155,0)
 .I $G(SCER(0)) D  Q
"RTN","MHVXPAT",156,0)
 ..S ERR="1^errors ("_SCER(0)_") returned by PTPR^SCAPMC"
"RTN","MHVXPAT",157,0)
 .; now save results
"RTN","MHVXPAT",158,0)
 .S J=0
"RTN","MHVXPAT",159,0)
 .F  S J=$O(^TMP(RTN,$J,"PRVDR",J))  Q:'J  S TM=$G(^(J))  D
"RTN","MHVXPAT",160,0)
 ..S PTIEN=$P(TM,U,1)
"RTN","MHVXPAT",161,0)
 ..S ICN=$$GET1^DIQ(2,PTIEN_",",991.01)
"RTN","MHVXPAT",162,0)
 ..S SSN=$$GET1^DIQ(2,PTIEN_",",.09)
"RTN","MHVXPAT",163,0)
 ..S HIT=HIT+1,@DATAROOT@(HIT)=PTIEN_U_""_U_$P(TM,U,2)_U_ICN_U_SSN
"RTN","MHVXPAT",164,0)
 ;
"RTN","MHVXPAT",165,0)
 S @DATAROOT=HIT_U_EXTIME  ; hits ^ time
"RTN","MHVXPAT",166,0)
 D XITLOG(LOGND,HIT)
"RTN","MHVXPAT",167,0)
 ;
"RTN","MHVXPAT",168,0)
 Q
"RTN","MHVXPAT",169,0)
PTREL(QRY,ERR,DATAROOT)                       ; patient relationships
"RTN","MHVXPAT",170,0)
 ; Primary Care Management Module interface
"RTN","MHVXPAT",171,0)
 ; return patient data in DATAROOT
"RTN","MHVXPAT",172,0)
 ; QRY, ERR passed by ref.
"RTN","MHVXPAT",173,0)
 ;
"RTN","MHVXPAT",174,0)
 ;  Input:
"RTN","MHVXPAT",175,0)
 ;       QRY - Query array
"RTN","MHVXPAT",176,0)
 ;       QRY("IEN") - Patient
"RTN","MHVXPAT",177,0)
 ;       QRY("FROMDT") - Begin date
"RTN","MHVXPAT",178,0)
 ;       QRY("TODT") - End Date
"RTN","MHVXPAT",179,0)
 ;
"RTN","MHVXPAT",180,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHVXPAT",181,0)
 ;
"RTN","MHVXPAT",182,0)
 ;  Output:
"RTN","MHVXPAT",183,0)
 ;  DATAROOT - Populated data array
"RTN","MHVXPAT",184,0)
 ;             includes number of hits and timestamp
"RTN","MHVXPAT",185,0)
 ;       ERR - Errors during extraction, zero on success
"RTN","MHVXPAT",186,0)
 ;
"RTN","MHVXPAT",187,0)
 N DT,EXTIME,HIT,THIT,LOGND,PRVIEN,RTN,U,X,MHVTEAMS,PATIEN,SCTEAMA
"RTN","MHVXPAT",188,0)
 N SCPOSA,SCUSRA,SCROLEA,SCPURPA,SCER,FROMDT,TODT
"RTN","MHVXPAT",189,0)
 N PPHONE,SSECTION,PTYPE,TYPE,REC
"RTN","MHVXPAT",190,0)
 ;
"RTN","MHVXPAT",191,0)
 S RTN=$T(+0),LOGND=RTN_"^PTREL"  ; node for logging
"RTN","MHVXPAT",192,0)
 D LOG^MHVUL2(LOGND,"BEGIN","S","TRACE")
"RTN","MHVXPAT",193,0)
 ; needed vars.
"RTN","MHVXPAT",194,0)
 S U="^",DT=$$DT^XLFDT,ERR=0,EXTIME=$$NOW^XLFDT,HIT=0
"RTN","MHVXPAT",195,0)
 ;
"RTN","MHVXPAT",196,0)
 K @DATAROOT,^TMP(RTN,$J)  ; clean up residue
"RTN","MHVXPAT",197,0)
 ;
"RTN","MHVXPAT",198,0)
 S PATIEN=$G(QRY("IEN"))
"RTN","MHVXPAT",199,0)
 I '(PATIEN>0) S ERR="1^patient IEN missing" Q
"RTN","MHVXPAT",200,0)
 ;
"RTN","MHVXPAT",201,0)
 ;
"RTN","MHVXPAT",202,0)
 ; get all clinics, providers and PCMM TEAMS for the patient
"RTN","MHVXPAT",203,0)
 ; in the date range
"RTN","MHVXPAT",204,0)
 ;
"RTN","MHVXPAT",205,0)
 Q:ERR
"RTN","MHVXPAT",206,0)
 ;
"RTN","MHVXPAT",207,0)
 N MHVDATES,CLID,J,RSLT,RSLTLST,SCER,TM,PATIEN
"RTN","MHVXPAT",208,0)
 S RSLTLST=$NA(^TMP(RTN,$J,"CLINICS"))
"RTN","MHVXPAT",209,0)
 I '$G(QRY("FROMDT")) S QRY("FROMDT")=2920101
"RTN","MHVXPAT",210,0)
 I '$G(QRY("TODT")) S QRY("TODT")=DT
"RTN","MHVXPAT",211,0)
 S MHVDATES("BEGIN")=QRY("FROMDT")
"RTN","MHVXPAT",212,0)
 S MHVDATES("END")=QRY("TODT")
"RTN","MHVXPAT",213,0)
 S PATIEN=QRY("IEN")
"RTN","MHVXPAT",214,0)
 ;
"RTN","MHVXPAT",215,0)
 ;Load Clinics
"RTN","MHVXPAT",216,0)
 ;
"RTN","MHVXPAT",217,0)
 D GETAPPT^SDAMA201(PATIEN,"1;2","R;NT",QRY("FROMDT"),QRY("TODT"),"")
"RTN","MHVXPAT",218,0)
 I $D(^TMP($J,"SDAMA201","GETAPPT","ERROR")) D  Q
"RTN","MHVXPAT",219,0)
 .S ERR="",ERR=$O(^TMP($J,"SDAMA201","GETAPPT","ERROR",ERR))
"RTN","MHVXPAT",220,0)
 .S ERR="1^"_^TMP($J,"SDAMA201","GETAPPT","ERROR",ERR)
"RTN","MHVXPAT",221,0)
 S REC=""
"RTN","MHVXPAT",222,0)
 F  S REC=$O(^TMP($J,"SDAMA201","GETAPPT",REC)) Q:REC=""  D
"RTN","MHVXPAT",223,0)
 .S CLID=$P(^TMP($J,"SDAMA201","GETAPPT",REC,2),"^",1)
"RTN","MHVXPAT",224,0)
 .Q:$D(^TMP($J,"CLFND",CLID))
"RTN","MHVXPAT",225,0)
 .S @RSLTLST@(REC)=$P(^TMP($J,"SDAMA201","GETAPPT",REC,2),"^",1,2)
"RTN","MHVXPAT",226,0)
 .S ^TMP($J,"CLFND",CLID)=""
"RTN","MHVXPAT",227,0)
 S @RSLTLST@(0)=REC
"RTN","MHVXPAT",228,0)
 K ^TMP($J,"SDAMA201"),^TMP($J,"CLFND")
"RTN","MHVXPAT",229,0)
 ;
"RTN","MHVXPAT",230,0)
 ;Load MHVTEAMS
"RTN","MHVXPAT",231,0)
 ;
"RTN","MHVXPAT",232,0)
 D TMSPT^ORQPTQ1(.MHVTEAMS,PATIEN)
"RTN","MHVXPAT",233,0)
 I MHVTEAMS(1)["No teams" K MHVTEAMS(1)
"RTN","MHVXPAT",234,0)
 M ^TMP("MHVXPAT",$J,"TEAMS")=MHVTEAMS
"RTN","MHVXPAT",235,0)
 ;
"RTN","MHVXPAT",236,0)
 ;Load Providers
"RTN","MHVXPAT",237,0)
 ;
"RTN","MHVXPAT",238,0)
 S (SCPOSA,SCUSRA,SCROLEA,SCPURPA,SCER)=""
"RTN","MHVXPAT",239,0)
 S RSLTLST=$NA(^TMP(RTN,$J,"PROVIDERS"))
"RTN","MHVXPAT",240,0)
 S X=$$PRPT^SCAPMC(PATIEN,.MHVDATES,SCPOSA,SCUSRA,SCROLEA,SCPURPA,RSLTLST,SCER)
"RTN","MHVXPAT",241,0)
 ;
"RTN","MHVXPAT",242,0)
 ; now save results
"RTN","MHVXPAT",243,0)
 ;
"RTN","MHVXPAT",244,0)
 N MHVHDAT
"RTN","MHVXPAT",245,0)
 S MHVHDAT=DATAROOT
"RTN","MHVXPAT",246,0)
 S THIT=0
"RTN","MHVXPAT",247,0)
 F TYPE="CLINICS","PROVIDERS","TEAMS"  D
"RTN","MHVXPAT",248,0)
 .S J=0
"RTN","MHVXPAT",249,0)
 .S HIT=0
"RTN","MHVXPAT",250,0)
 .F  S J=$O(^TMP(RTN,$J,TYPE,J))  Q:'J  S TM=$G(^(J))  D
"RTN","MHVXPAT",251,0)
 ..S HIT=HIT+1,THIT=THIT+1,@DATAROOT@(TYPE,HIT)=$P(TM,U)_"^"_$P(TM,U,2)
"RTN","MHVXPAT",252,0)
 ..I TYPE="PROVIDERS"  D
"RTN","MHVXPAT",253,0)
 ...S PPHONE=$$GET1^DIQ(200,$P(TM,U)_",",.132)
"RTN","MHVXPAT",254,0)
 ...S SSECTION=$$GET1^DIQ(200,$P(TM,U)_",",29)
"RTN","MHVXPAT",255,0)
 ...S PTYPE=$P(TM,U,8)
"RTN","MHVXPAT",256,0)
 ...S @DATAROOT@(TYPE,HIT)=@DATAROOT@(TYPE,HIT)_"^"_PTYPE
"RTN","MHVXPAT",257,0)
 ...S @DATAROOT@(TYPE,HIT)=@DATAROOT@(TYPE,HIT)_"^^^^"_PPHONE_"^"_SSECTION
"RTN","MHVXPAT",258,0)
 S @DATAROOT=THIT_U_EXTIME  ; hits ^ time
"RTN","MHVXPAT",259,0)
 D XITLOG(LOGND,HIT)
"RTN","MHVXPAT",260,0)
 Q
"RTN","MHVXPAT",261,0)
 ;
"RTN","MHVXPAT",262,0)
XITLOG(ND,HT)     ; exit log
"RTN","MHVXPAT",263,0)
 D LOG^MHVUL2(ND,HT_" HITS","S","TRACE")
"RTN","MHVXPAT",264,0)
 D LOG^MHVUL2(ND,"END","S","TRACE") Q
"RTN","MHVXPRV")
0^49^B8040639^n/a
"RTN","MHVXPRV",1,0)
MHVXPRV ;WAS/DLF - Provider extract ; 9/25/08 4:11pm
"RTN","MHVXPRV",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHVXPRV",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHVXPRV",4,0)
 ;
"RTN","MHVXPRV",5,0)
 Q
"RTN","MHVXPRV",6,0)
 ;
"RTN","MHVXPRV",7,0)
 ;  Integration Agreements:
"RTN","MHVXPRV",8,0)
 ;                5250 : TPPR^SCAPMC
"RTN","MHVXPRV",9,0)
 ;               10103 : $$DT^XLFDT
"RTN","MHVXPRV",10,0)
 ;                       $$NOW^XLFDT
"RTN","MHVXPRV",11,0)
 ;               10060 : New Person File #200
"RTN","MHVXPRV",12,0)
 ;               10076 : ^XUSEC
"RTN","MHVXPRV",13,0)
 ;  
"RTN","MHVXPRV",14,0)
 ;
"RTN","MHVXPRV",15,0)
 ;
"RTN","MHVXPRV",16,0)
CMMPRV(QRY,ERR,DATAROOT)        ; return PCMM providers
"RTN","MHVXPRV",17,0)
 ;
"RTN","MHVXPRV",18,0)
 ; Primary Care Management Module interface
"RTN","MHVXPRV",19,0)
 ; return provider data in DATAROOT
"RTN","MHVXPRV",20,0)
 ; QRY, ERR passed by ref.
"RTN","MHVXPRV",21,0)
 ;
"RTN","MHVXPRV",22,0)
 ;  Input:
"RTN","MHVXPRV",23,0)
 ;       QRY - Query array
"RTN","MHVXPRV",24,0)
 ;       ERR - Variable to hold error conditions
"RTN","MHVXPRV",25,0)
 ;       DATAROOT - Root of array to hold extract data
"RTN","MHVXPRV",26,0)
 ;  Output:
"RTN","MHVXPRV",27,0)
 ;       DATAROOT - Populated data array
"RTN","MHVXPRV",28,0)
 ;                  includes number of hits and timestamp
"RTN","MHVXPRV",29,0)
 ;       ERR - Errors during extraction, zero on success
"RTN","MHVXPRV",30,0)
 ;
"RTN","MHVXPRV",31,0)
 ;
"RTN","MHVXPRV",32,0)
 D LOG^MHVUL2("CMMPRV~MHVXPRV","BEGIN","S","TRACE")
"RTN","MHVXPRV",33,0)
 ;
"RTN","MHVXPRV",34,0)
 K @DATAROOT,^TMP("MHVXPRV",$J)  ; clean up residue
"RTN","MHVXPRV",35,0)
 ;
"RTN","MHVXPRV",36,0)
 ; get all PCMM providers for facility, no exclusion
"RTN","MHVXPRV",37,0)
 ;
"RTN","MHVXPRV",38,0)
 N NXT,IIEN,NODE,TEAM,OUT
"RTN","MHVXPRV",39,0)
 N DT,EXTIME,HIT,LOGND,RTN,U,X
"RTN","MHVXPRV",40,0)
 N PRNAME,PRFNAME,PROLE,PRIEN
"RTN","MHVXPRV",41,0)
 ;
"RTN","MHVXPRV",42,0)
 ;
"RTN","MHVXPRV",43,0)
 S NXT=0,IIEN=0
"RTN","MHVXPRV",44,0)
 S U="^",DT=$$DT^XLFDT,ERR=0,EXTIME=$$NOW^XLFDT,HIT=0
"RTN","MHVXPRV",45,0)
 ;
"RTN","MHVXPRV",46,0)
 I QRY("IEN")="" D  ; no IEN, check PROVIDER key holders
"RTN","MHVXPRV",47,0)
 .S PRIEN=""
"RTN","MHVXPRV",48,0)
 .F  S PRIEN=$O(^XUSEC("PROVIDER",PRIEN)) Q:PRIEN=""  D PRVCHK(PRIEN)
"RTN","MHVXPRV",49,0)
 ;
"RTN","MHVXPRV",50,0)
 ; otherwise, check one match
"RTN","MHVXPRV",51,0)
 E  D
"RTN","MHVXPRV",52,0)
 .D PRVCHK(QRY("IEN"))
"RTN","MHVXPRV",53,0)
 ;
"RTN","MHVXPRV",54,0)
 S @DATAROOT=HIT_U_EXTIME  ; count of hits ^ time
"RTN","MHVXPRV",55,0)
 D LOG^MHVUL2("CMMPRV~MHVXPRV",HIT_" HITS","S","TRACE")
"RTN","MHVXPRV",56,0)
 D LOG^MHVUL2("CMMPRV~MHVXPRV","END","S","TRACE")
"RTN","MHVXPRV",57,0)
 Q
"RTN","MHVXPRV",58,0)
 ;
"RTN","MHVXPRV",59,0)
PRVCHK(PRIEN)  ; if provider has roles and matches name paramter,add to the 
"RTN","MHVXPRV",60,0)
 ; list to send back
"RTN","MHVXPRV",61,0)
 ;
"RTN","MHVXPRV",62,0)
 N DIERR,PRVOUT,MHVDATES,MHVPURPA,MHVROLEA,MHVERR,MHVLIST,MHVRLS
"RTN","MHVXPRV",63,0)
 N PHNE,SECTN
"RTN","MHVXPRV",64,0)
 S MHVDATES("BEGIN")="",MHVDATES("END")=""
"RTN","MHVXPRV",65,0)
 S MHVDATES("INCL")=0
"RTN","MHVXPRV",66,0)
 S (MHVPURPA,MHVROLEA,MHVERR)=""
"RTN","MHVXPRV",67,0)
 S X=$$TPPR^SCAPMC(PRIEN,.MHVDATES,MHVPURPA,MHVROLEA,"MHVRLS",MHVERR)
"RTN","MHVXPRV",68,0)
 ;
"RTN","MHVXPRV",69,0)
 ;If there are no roles, this person is not a pcmm provider
"RTN","MHVXPRV",70,0)
 ;
"RTN","MHVXPRV",71,0)
 Q:'$D(MHVRLS)
"RTN","MHVXPRV",72,0)
 ;
"RTN","MHVXPRV",73,0)
 S PROLE=$P(MHVRLS(1),"^",8)
"RTN","MHVXPRV",74,0)
 D GETS^DIQ(200,PRIEN_",",".01;.132;29","E","PRVOUT","DIERR")
"RTN","MHVXPRV",75,0)
 Q:$G(DIERR)
"RTN","MHVXPRV",76,0)
 S PRNAME=$G(PRVOUT(200,PRIEN_",",.01,"E"))
"RTN","MHVXPRV",77,0)
 S PRFNAME=$P(PRNAME,",",2)
"RTN","MHVXPRV",78,0)
 Q:$E(PRNAME,1,$L(QRY("LNAME")))'=QRY("LNAME")
"RTN","MHVXPRV",79,0)
 Q:$E(PRFNAME,1,$L(QRY("FNAME")))'=QRY("FNAME")
"RTN","MHVXPRV",80,0)
 S PHNE=$G(PRVOUT(200,PRIEN_",",.132,"E"))
"RTN","MHVXPRV",81,0)
 S SECTN=$G(PRVOUT(200,PRIEN_",",.29,"E"))
"RTN","MHVXPRV",82,0)
 S HIT=HIT+1
"RTN","MHVXPRV",83,0)
 S @DATAROOT@(HIT)=PRIEN_"^"_PRNAME_"^"_PROLE_"^^^^"_PHNE_"^"_SECTN
"RTN","MHVXPRV",84,0)
 Q
"RTN","MHVXTM")
0^44^B2860414^n/a
"RTN","MHVXTM",1,0)
MHVXTM ;WAS/DLF - team extracts ; 9/25/08 4:12pm
"RTN","MHVXTM",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHVXTM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHVXTM",4,0)
 ;
"RTN","MHVXTM",5,0)
 Q
"RTN","MHVXTM",6,0)
 ;
"RTN","MHVXTM",7,0)
 ;  Integration Agreements:
"RTN","MHVXTM",8,0)
 ;                2692 : TEAMS^ORQPTQ1
"RTN","MHVXTM",9,0)
 ;               10103 : $$DT^XLFDT
"RTN","MHVXTM",10,0)
 ;                       $$NOW^XLFDT
"RTN","MHVXTM",11,0)
 ;              
"RTN","MHVXTM",12,0)
 ;
"RTN","MHVXTM",13,0)
TEAM(QRY,ERR,DATAROOT)             ; return all OE/RR teams
"RTN","MHVXTM",14,0)
 ;
"RTN","MHVXTM",15,0)
 ; return provider data in DATAROOT
"RTN","MHVXTM",16,0)
 ; QRY, ERR passed by ref.
"RTN","MHVXTM",17,0)
 ;
"RTN","MHVXTM",18,0)
 ;  Input:
"RTN","MHVXTM",19,0)
 ;       QRY - Query array
"RTN","MHVXTM",20,0)
 ;   
"RTN","MHVXTM",21,0)
 ;  DATAROOT - Root of array to hold extract data
"RTN","MHVXTM",22,0)
 ;
"RTN","MHVXTM",23,0)
 ;  Output:
"RTN","MHVXTM",24,0)
 ;  DATAROOT - Populated data array
"RTN","MHVXTM",25,0)
 ;             includes number of hits and timestamp
"RTN","MHVXTM",26,0)
 ;       ERR - Errors during extraction, zero on success
"RTN","MHVXTM",27,0)
 ;
"RTN","MHVXTM",28,0)
 N DT,EXTIME,HIT,KEYNM,LOGND,TMIEN,TMNM,U,X
"RTN","MHVXTM",29,0)
 ;
"RTN","MHVXTM",30,0)
 S LOGND=$T(+0)_"^TEAM"  ; node for logging
"RTN","MHVXTM",31,0)
 D LOG^MHVUL2(LOGND,"BEGIN","S","TRACE")
"RTN","MHVXTM",32,0)
 ; needed vars.
"RTN","MHVXTM",33,0)
 S U="^",DT=$$DT^XLFDT,ERR=0,EXTIME=$$NOW^XLFDT,HIT=0
"RTN","MHVXTM",34,0)
 ;
"RTN","MHVXTM",35,0)
 K @DATAROOT  ; clean up residue
"RTN","MHVXTM",36,0)
 D TEAMS^ORQPTQ1(.MHVTMAR)
"RTN","MHVXTM",37,0)
 S (X,HIT)=0
"RTN","MHVXTM",38,0)
 F  S X=$O(MHVTMAR(X)) Q:X=""  D
"RTN","MHVXTM",39,0)
 .I $E($P(MHVTMAR(X),U,2),1,$L(QRY("LNAME")))=QRY("LNAME")  D
"RTN","MHVXTM",40,0)
 ..S TMIEN=$P(MHVTMAR(X),U)
"RTN","MHVXTM",41,0)
 ..S TMNM=$P(MHVTMAR(X),U,2)
"RTN","MHVXTM",42,0)
 ..S HIT=HIT+1
"RTN","MHVXTM",43,0)
 ..S @DATAROOT@("TEAMS",HIT)=TMIEN_U_TMNM
"RTN","MHVXTM",44,0)
 S @DATAROOT=HIT_U_EXTIME  ; hits ^ time
"RTN","MHVXTM",45,0)
 D XITLOG(LOGND,HIT)
"RTN","MHVXTM",46,0)
 K MHVTMAR
"RTN","MHVXTM",47,0)
 ;
"RTN","MHVXTM",48,0)
 Q
"RTN","MHVXTM",49,0)
XITLOG(ND,HT)     ; exit log
"RTN","MHVXTM",50,0)
 D LOG^MHVUL2(ND,HT_" HITS","S","TRACE")
"RTN","MHVXTM",51,0)
 D LOG^MHVUL2(ND,"END","S","TRACE") Q
"RTN","MHVXTM",52,0)
 Q
"RTN","MHVXUSR")
0^45^B6533332^n/a
"RTN","MHVXUSR",1,0)
MHVXUSR ;WAS/DLF - User extract ; 9/25/08 4:12pm
"RTN","MHVXUSR",2,0)
 ;;1.0;My HealtheVet;**6**;Aug 23, 2005;Build 82
"RTN","MHVXUSR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MHVXUSR",4,0)
 ;
"RTN","MHVXUSR",5,0)
 Q
"RTN","MHVXUSR",6,0)
 ;  Integration Agreements:
"RTN","MHVXUSR",7,0)
 ;       10060 : New Person file #200
"RTN","MHVXUSR",8,0)
 ;       10103 : $$DT^XLFDT
"RTN","MHVXUSR",9,0)
 ;               $$NOW^XLFDT
"RTN","MHVXUSR",10,0)
 ;
"RTN","MHVXUSR",11,0)
USERS(QRY,ERR,DATAROOT)        ; return users from file 200
"RTN","MHVXUSR",12,0)
 ;
"RTN","MHVXUSR",13,0)
 ; Primary Care Management Module interface
"RTN","MHVXUSR",14,0)
 ; return user data in DATAROOT
"RTN","MHVXUSR",15,0)
 ; QRY, ERR passed by ref.
"RTN","MHVXUSR",16,0)
 ;
"RTN","MHVXUSR",17,0)
 ;  Input:
"RTN","MHVXUSR",18,0)
 ;       QRY - Query array
"RTN","MHVXUSR",19,0)
 ;       ERR - Variable to hold error conditions
"RTN","MHVXUSR",20,0)
 ;       DATAROOT - Root of array to hold extract data
"RTN","MHVXUSR",21,0)
 ;  Output:
"RTN","MHVXUSR",22,0)
 ;       DATAROOT - Populated data array
"RTN","MHVXUSR",23,0)
 ;                  includes number of hits and timestamp
"RTN","MHVXUSR",24,0)
 ;       ERR - Errors during extraction, zero on success
"RTN","MHVXUSR",25,0)
 ;
"RTN","MHVXUSR",26,0)
 ;
"RTN","MHVXUSR",27,0)
 ;
"RTN","MHVXUSR",28,0)
 D LOG^MHVUL2("USERS~MHVXUSR","BEGIN","S","TRACE")
"RTN","MHVXUSR",29,0)
 ;
"RTN","MHVXUSR",30,0)
 K @DATAROOT,^TMP("MHXUSR",$J)  ; clean up residue
"RTN","MHVXUSR",31,0)
 ;
"RTN","MHVXUSR",32,0)
 N NXT,IIEN,NODE,TEAM,OUT,MHVPURPA,MHVROLEA,MHVLIST,MHVERR
"RTN","MHVXUSR",33,0)
 N DIERR,DT,EXTIME,HIT,LOGND,RTN,TMIEN,NM,U,X
"RTN","MHVXUSR",34,0)
 N USRNAME,USROUT,USRFNAME,OUT,PPHONE,SSECTION,USRIEN,PRV
"RTN","MHVXUSR",35,0)
 ;
"RTN","MHVXUSR",36,0)
 S U="^",DT=$$DT^XLFDT,ERR=0,EXTIME=$$NOW^XLFDT,HIT=0
"RTN","MHVXUSR",37,0)
 ;
"RTN","MHVXUSR",38,0)
 S OUT=$NA(^TMP("MHVXUSR",$J))
"RTN","MHVXUSR",39,0)
 S NXT=0,IIEN=0
"RTN","MHVXUSR",40,0)
 K @OUT
"RTN","MHVXUSR",41,0)
 ;
"RTN","MHVXUSR",42,0)
 ;FIND ALL ACTIVE NEW PERSONS THAT MATCH ENTRY
"RTN","MHVXUSR",43,0)
 ;
"RTN","MHVXUSR",44,0)
 I QRY("IEN")=""  D    ; Name lookup
"RTN","MHVXUSR",45,0)
 .D LIST^DIC(200,"","","",,QRY("LNAME"),QRY("LNAME"),"B","I $$ACTIVE^XUSER(Y)","",OUT)
"RTN","MHVXUSR",46,0)
 E  D  ; Lookup by IEN
"RTN","MHVXUSR",47,0)
 .S @OUT@("DILIST",2,1)=QRY("IEN")
"RTN","MHVXUSR",48,0)
 ;
"RTN","MHVXUSR",49,0)
 ;$O through the OUT array to get the IEN to check for roles
"RTN","MHVXUSR",50,0)
 ;
"RTN","MHVXUSR",51,0)
 S IIEN="",HIT=0
"RTN","MHVXUSR",52,0)
 F  S IIEN=$O(@OUT@("DILIST",2,IIEN)) Q:IIEN=""  D
"RTN","MHVXUSR",53,0)
 .S USRIEN=@OUT@("DILIST",2,IIEN)
"RTN","MHVXUSR",54,0)
 .D GETS^DIQ(200,USRIEN_",",".01;.132;29","E","USROUT","DIERR")
"RTN","MHVXUSR",55,0)
 .Q:$G(DIERR)
"RTN","MHVXUSR",56,0)
 .S USRNAME=$G(USROUT(200,USRIEN_",",.01,"E"))
"RTN","MHVXUSR",57,0)
 .S USRFNAME=$P(USRNAME,",",2)
"RTN","MHVXUSR",58,0)
 .Q:$E(USRFNAME,1,$L(QRY("FNAME")))'=QRY("FNAME")
"RTN","MHVXUSR",59,0)
 .S PPHONE=$G(USROUT(200,USRIEN_",",.132,"E"))
"RTN","MHVXUSR",60,0)
 .S SSECTION=$G(USROUT(200,USRIEN_",",.29,"E"))
"RTN","MHVXUSR",61,0)
 .S PRV=""
"RTN","MHVXUSR",62,0)
 .I $D(^XUSEC("PROVIDER",USRIEN)) S PRV="PROVIDER"
"RTN","MHVXUSR",63,0)
 .S HIT=HIT+1
"RTN","MHVXUSR",64,0)
 .S @DATAROOT@(HIT)=USRIEN_U_USRNAME_U_PRV_U_U_U_U_PPHONE_U_SSECTION
"RTN","MHVXUSR",65,0)
 ;
"RTN","MHVXUSR",66,0)
 ; Update dataroot with number of hits and
"RTN","MHVXUSR",67,0)
 ; write to the log
"RTN","MHVXUSR",68,0)
 ;
"RTN","MHVXUSR",69,0)
 K @OUT
"RTN","MHVXUSR",70,0)
 S @DATAROOT=HIT_U_EXTIME  ; count of hits ^ time
"RTN","MHVXUSR",71,0)
 D LOG^MHVUL2("USERS~MHVXUSR",HIT_" HITS","S","TRACE")
"RTN","MHVXUSR",72,0)
 D LOG^MHVUL2("USERS~MHVXUSR","END","S","TRACE")
"RTN","MHVXUSR",73,0)
 Q
"VER")
8.0^22.0
"BLD",7022,6)
^4
**END**
**END**

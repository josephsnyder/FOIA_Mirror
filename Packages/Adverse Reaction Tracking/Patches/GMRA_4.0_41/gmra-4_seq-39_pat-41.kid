Released GMRA*4*41 SEQ #39
Extracted from mail message
**KIDS**:GMRA*4.0*41^

**INSTALL NAME**
GMRA*4.0*41
"BLD",6876,0)
GMRA*4.0*41^ADVERSE REACTION TRACKING^0^3080617^y
"BLD",6876,1,0)
^^1^1^3080617^^^
"BLD",6876,1,1,0)
See GMRA*4*41 in the National Patch Module
"BLD",6876,4,0)
^9.64PA^^
"BLD",6876,6.3)
8
"BLD",6876,"ABPKG")
n
"BLD",6876,"KRN",0)
^9.67PA^8989.52^19
"BLD",6876,"KRN",.4,0)
.4
"BLD",6876,"KRN",.401,0)
.401
"BLD",6876,"KRN",.402,0)
.402
"BLD",6876,"KRN",.403,0)
.403
"BLD",6876,"KRN",.5,0)
.5
"BLD",6876,"KRN",.84,0)
.84
"BLD",6876,"KRN",3.6,0)
3.6
"BLD",6876,"KRN",3.8,0)
3.8
"BLD",6876,"KRN",9.2,0)
9.2
"BLD",6876,"KRN",9.8,0)
9.8
"BLD",6876,"KRN",9.8,"NM",0)
^9.68A^21^21
"BLD",6876,"KRN",9.8,"NM",1,0)
GMRADSP1^^0^B10440190
"BLD",6876,"KRN",9.8,"NM",2,0)
GMRADSP2^^0^B18399913
"BLD",6876,"KRN",9.8,"NM",3,0)
GMRAFX2^^0^B25396107
"BLD",6876,"KRN",9.8,"NM",4,0)
GMRAHLP0^^0^B6444149
"BLD",6876,"KRN",9.8,"NM",5,0)
GMRAOR^^0^B69044277
"BLD",6876,"KRN",9.8,"NM",6,0)
GMRAOR2^^0^B11000982
"BLD",6876,"KRN",9.8,"NM",7,0)
GMRAOR3^^0^B6735362
"BLD",6876,"KRN",9.8,"NM",8,0)
GMRAOR9^^0^B4659395
"BLD",6876,"KRN",9.8,"NM",9,0)
GMRAPED0^^0^B21403018
"BLD",6876,"KRN",9.8,"NM",10,0)
GMRAPED1^^0^B6980916
"BLD",6876,"KRN",9.8,"NM",11,0)
GMRAPES0^^0^B77518746
"BLD",6876,"KRN",9.8,"NM",12,0)
GMRAPES1^^0^B8419094
"BLD",6876,"KRN",9.8,"NM",13,0)
GMRAPST4^^0^B14046350
"BLD",6876,"KRN",9.8,"NM",14,0)
GMRARAD^^0^B20705781
"BLD",6876,"KRN",9.8,"NM",15,0)
GMRARAD0^^0^B16100133
"BLD",6876,"KRN",9.8,"NM",16,0)
GMRARAD1^^0^B2025322
"BLD",6876,"KRN",9.8,"NM",17,0)
GMRAUIX0^^0^B3830762
"BLD",6876,"KRN",9.8,"NM",18,0)
GMRAUTL2^^0^B81816140
"BLD",6876,"KRN",9.8,"NM",19,0)
GMRAPENC^^0^B4933029
"BLD",6876,"KRN",9.8,"NM",20,0)
GMRAUTL3^^0^B4579634
"BLD",6876,"KRN",9.8,"NM",21,0)
GMRAOR1^^0^B7165118
"BLD",6876,"KRN",9.8,"NM","B","GMRADSP1",1)

"BLD",6876,"KRN",9.8,"NM","B","GMRADSP2",2)

"BLD",6876,"KRN",9.8,"NM","B","GMRAFX2",3)

"BLD",6876,"KRN",9.8,"NM","B","GMRAHLP0",4)

"BLD",6876,"KRN",9.8,"NM","B","GMRAOR",5)

"BLD",6876,"KRN",9.8,"NM","B","GMRAOR1",21)

"BLD",6876,"KRN",9.8,"NM","B","GMRAOR2",6)

"BLD",6876,"KRN",9.8,"NM","B","GMRAOR3",7)

"BLD",6876,"KRN",9.8,"NM","B","GMRAOR9",8)

"BLD",6876,"KRN",9.8,"NM","B","GMRAPED0",9)

"BLD",6876,"KRN",9.8,"NM","B","GMRAPED1",10)

"BLD",6876,"KRN",9.8,"NM","B","GMRAPENC",19)

"BLD",6876,"KRN",9.8,"NM","B","GMRAPES0",11)

"BLD",6876,"KRN",9.8,"NM","B","GMRAPES1",12)

"BLD",6876,"KRN",9.8,"NM","B","GMRAPST4",13)

"BLD",6876,"KRN",9.8,"NM","B","GMRARAD",14)

"BLD",6876,"KRN",9.8,"NM","B","GMRARAD0",15)

"BLD",6876,"KRN",9.8,"NM","B","GMRARAD1",16)

"BLD",6876,"KRN",9.8,"NM","B","GMRAUIX0",17)

"BLD",6876,"KRN",9.8,"NM","B","GMRAUTL2",18)

"BLD",6876,"KRN",9.8,"NM","B","GMRAUTL3",20)

"BLD",6876,"KRN",19,0)
19
"BLD",6876,"KRN",19.1,0)
19.1
"BLD",6876,"KRN",101,0)
101
"BLD",6876,"KRN",409.61,0)
409.61
"BLD",6876,"KRN",771,0)
771
"BLD",6876,"KRN",870,0)
870
"BLD",6876,"KRN",8989.51,0)
8989.51
"BLD",6876,"KRN",8989.52,0)
8989.52
"BLD",6876,"KRN",8994,0)
8994
"BLD",6876,"KRN","B",.4,.4)

"BLD",6876,"KRN","B",.401,.401)

"BLD",6876,"KRN","B",.402,.402)

"BLD",6876,"KRN","B",.403,.403)

"BLD",6876,"KRN","B",.5,.5)

"BLD",6876,"KRN","B",.84,.84)

"BLD",6876,"KRN","B",3.6,3.6)

"BLD",6876,"KRN","B",3.8,3.8)

"BLD",6876,"KRN","B",9.2,9.2)

"BLD",6876,"KRN","B",9.8,9.8)

"BLD",6876,"KRN","B",19,19)

"BLD",6876,"KRN","B",19.1,19.1)

"BLD",6876,"KRN","B",101,101)

"BLD",6876,"KRN","B",409.61,409.61)

"BLD",6876,"KRN","B",771,771)

"BLD",6876,"KRN","B",870,870)

"BLD",6876,"KRN","B",8989.51,8989.51)

"BLD",6876,"KRN","B",8989.52,8989.52)

"BLD",6876,"KRN","B",8994,8994)

"BLD",6876,"QUES",0)
^9.62^^
"BLD",6876,"REQB",0)
^9.611^6^6
"BLD",6876,"REQB",1,0)
PSN*4.0*157^2
"BLD",6876,"REQB",2,0)
GMRA*4.0*33^1
"BLD",6876,"REQB",3,0)
GMRA*4.0*37^1
"BLD",6876,"REQB",4,0)
GMRA*4.0*36^1
"BLD",6876,"REQB",5,0)
GMRA*4.0*20^1
"BLD",6876,"REQB",6,0)
GMRA*4.0*27^1
"BLD",6876,"REQB","B","GMRA*4.0*20",5)

"BLD",6876,"REQB","B","GMRA*4.0*27",6)

"BLD",6876,"REQB","B","GMRA*4.0*33",2)

"BLD",6876,"REQB","B","GMRA*4.0*36",4)

"BLD",6876,"REQB","B","GMRA*4.0*37",3)

"BLD",6876,"REQB","B","PSN*4.0*157",1)

"MBREQ")
0
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
41^3080617
"PKG",140,22,1,"PAH",1,1,0)
^^1^1^3080617
"PKG",140,22,1,"PAH",1,1,1,0)
See GMRA*4*41 in the National Patch Module
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
21
"RTN","GMRADSP1")
0^1^B10440190^B9415199
"RTN","GMRADSP1",1,0)
GMRADSP1 ;HIRMFO/WAA-DISPLAY ALLERGY ;11/13/07  08:07
"RTN","GMRADSP1",2,0)
 ;;4.0;Adverse Reaction Tracking;**41**;Mar 29, 1996;Build 8
"RTN","GMRADSP1",3,0)
DISBLD(IEN,ARRAY) ; This subroutine will bulid the array that will
"RTN","GMRADSP1",4,0)
 ; be displayed for each reactant.  The IEN for each reactant in
"RTN","GMRADSP1",5,0)
 ; stored in GMRAPA.
"RTN","GMRADSP1",6,0)
 N CNT,X,NODE
"RTN","GMRADSP1",7,0)
 S NODE=$G(^GMR(120.8,IEN,0)) Q:NODE=""  S CNT=1
"RTN","GMRADSP1",8,0)
 I $L(GMRANAME)>50 S ARRAY(CNT)=$E(GMRANAME,1,50),CNT=CNT+1,ARRAY(CNT)=$E(GMRANAME,51,999)
"RTN","GMRADSP1",9,0)
 E  S ARRAY(CNT)=GMRANAME
"RTN","GMRADSP1",10,0)
ING ;Find all the ingredents for a reactant.
"RTN","GMRADSP1",11,0)
 I $O(^GMR(120.8,IEN,2,0))>0 D
"RTN","GMRADSP1",12,0)
 .N GMRAFST,GMRAGBAL,GMRAING,GMRAINGR,GMRALLEG,GMRALST
"RTN","GMRADSP1",13,0)
 .S GMRAINGR=0,GMRALLEG=0
"RTN","GMRADSP1",14,0)
 .F  S GMRAINGR=$O(^GMR(120.8,IEN,2,GMRAINGR)) Q:GMRAINGR'>0  S GMRAGBAL=^GMR(120.8,IEN,2,GMRAINGR,0) D
"RTN","GMRADSP1",15,0)
 ..;--41-1
"RTN","GMRADSP1",16,0)
 ..D ZERO^PSN50P41(GMRAGBAL,"","","ENCAP")
"RTN","GMRADSP1",17,0)
 ..I '$D(^TMP($J,"ENCAP",GMRAGBAL)) K ^TMP($J,"ENCAP") Q
"RTN","GMRADSP1",18,0)
 ..;--41-1
"RTN","GMRADSP1",19,0)
 ..;--41-2
"RTN","GMRADSP1",20,0)
 ..I $P(NODE,U,2)=$P(^TMP($J,"ENCAP",GMRAGBAL,.01),U) Q
"RTN","GMRADSP1",21,0)
 ..;--41-2
"RTN","GMRADSP1",22,0)
 ..;--41-3
"RTN","GMRADSP1",23,0)
 ..S GMRALLEG(IEN,$P(^TMP($J,"ENCAP",GMRAGBAL,.01),U))="",GMRALLEG=GMRALLEG+1
"RTN","GMRADSP1",24,0)
 ..K ^TMP($J,"ENCAP")
"RTN","GMRADSP1",25,0)
 ..;--41-3
"RTN","GMRADSP1",26,0)
 ..Q
"RTN","GMRADSP1",27,0)
 .I GMRALLEG S (GMRAINGR,GMRAING)="",CNT=CNT+1,ARRAY(CNT)="",GMRAFST=1,GMRALST=0 F  S GMRAINGR=$O(GMRALLEG(IEN,GMRAINGR)) Q:GMRAINGR=""  D
"RTN","GMRADSP1",28,0)
 ..I $O(GMRALLEG(IEN,GMRAINGR))="" S GMRALST=1
"RTN","GMRADSP1",29,0)
 ..S GMRAING=GMRAINGR
"RTN","GMRADSP1",30,0)
 ..I GMRAFST S GMRAING=" ("_GMRAING,GMRAFST=0
"RTN","GMRADSP1",31,0)
 ..I 'GMRALST S GMRAING=GMRAING_", "
"RTN","GMRADSP1",32,0)
 ..I GMRALST S GMRAING=GMRAING_")"
"RTN","GMRADSP1",33,0)
 ..I $L(ARRAY(CNT)_GMRAING)>52 S CNT=CNT+1,ARRAY(CNT)="  "_GMRAING
"RTN","GMRADSP1",34,0)
 ..E  S ARRAY(CNT)=ARRAY(CNT)_GMRAING
"RTN","GMRADSP1",35,0)
 ..Q
"RTN","GMRADSP1",36,0)
 .Q
"RTN","GMRADSP1",37,0)
SIGN ;Get all the patient Sign/Symptoms
"RTN","GMRADSP1",38,0)
 I $O(^GMR(120.8,IEN,10,0))>0 D
"RTN","GMRADSP1",39,0)
 .N GMRAFST,GMRALST,GMRAOTH,GMRAREAC,GMRAREAN,GMRATONS
"RTN","GMRADSP1",40,0)
 .S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRADSP1",41,0)
 .S GMRAFST=1,GMRALST=0,CNT=CNT+1,ARRAY(CNT)="    Reactions:"
"RTN","GMRADSP1",42,0)
 .S GMRAREAC=0 F  S GMRAREAC=$O(^GMR(120.8,IEN,10,GMRAREAC)) Q:GMRAREAC'>0  S GMRAREAN=$P($G(^GMR(120.8,IEN,10,GMRAREAC,0)),U) I GMRAREAN'="" D
"RTN","GMRADSP1",43,0)
 ..N GMRAREC
"RTN","GMRADSP1",44,0)
 ..I '$O(^GMR(120.8,IEN,10,GMRAREAC)) S GMRALST=1
"RTN","GMRADSP1",45,0)
 ..S GMRATONS=$S(GMRAREAN'=GMRAOTH:$P(^GMRD(120.83,GMRAREAN,0),U),1:$P(^GMR(120.8,IEN,10,GMRAREAC,0),U,2))
"RTN","GMRADSP1",46,0)
 ..S GMRAREC=GMRATONS
"RTN","GMRADSP1",47,0)
 ..I GMRAFST S GMRAREC=" "_GMRAREC,GMRAFST=0
"RTN","GMRADSP1",48,0)
 ..I 'GMRALST S GMRAREC=GMRAREC_", "
"RTN","GMRADSP1",49,0)
 ..I $L(ARRAY(CNT)_GMRAREC)>52 S CNT=CNT+1,ARRAY(CNT)="               "_GMRAREC
"RTN","GMRADSP1",50,0)
 ..E  S ARRAY(CNT)=ARRAY(CNT)_GMRAREC
"RTN","GMRADSP1",51,0)
 ..Q
"RTN","GMRADSP1",52,0)
 .Q
"RTN","GMRADSP1",53,0)
 S %=$S($P(NODE,U,16):"YES",1:" NO") I $P(NODE,U,16),$P(NODE,U,18)="" S %="AUTO"
"RTN","GMRADSP1",54,0)
 S ARRAY(1)=ARRAY(1)_$J(" ",(53-$L(ARRAY(1))))_%
"RTN","GMRADSP1",55,0)
 S %=$P(NODE,U,14),%=$S(%="P":"PHARM  ",%="A":"ALLERGY",%="U":"UNKNOWN ",1:""),ARRAY(1)=ARRAY(1)_$J(" ",(59-$L(ARRAY(1))))_%
"RTN","GMRADSP1",56,0)
 S %=$P(NODE,U,6),%=$S(%="o":"OBS",%="h":"HIST",1:""),ARRAY(1)=ARRAY(1)_$J(" ",(68-$L(ARRAY(1))))_%
"RTN","GMRADSP1",57,0)
TYPE S %="" F X=1:1:($L(GMRATYPE)) D
"RTN","GMRADSP1",58,0)
 .S %=$P("^FOOD^DRUG^OTHER",U,$F("FDO",$E(GMRATYPE,X)))
"RTN","GMRADSP1",59,0)
 .S ARRAY(X)=$G(ARRAY(X))
"RTN","GMRADSP1",60,0)
 .S ARRAY(X)=ARRAY(X)_$J(" ",(74-$L(ARRAY(X))))_%
"RTN","GMRADSP1",61,0)
 .Q
"RTN","GMRADSP1",62,0)
 Q
"RTN","GMRADSP2")
0^2^B18399913^B17340136
"RTN","GMRADSP2",1,0)
GMRADSP2 ;HIRMFO/RM,WAA-PRINT PATIENT A/AR ;11/13/07  09:31
"RTN","GMRADSP2",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,41**;Mar 29, 1996;Build 8
"RTN","GMRADSP2",3,0)
EN1 ; ENTRY TO PRINT DATA FOR A SINGLE RECORD DENOTED BY GMRAPA
"RTN","GMRADSP2",4,0)
 S GMRAOUT=0
"RTN","GMRADSP2",5,0)
 S GMRAPA(0)=$S($D(^GMR(120.8,GMRAPA,0)):^(0),1:"")
"RTN","GMRADSP2",6,0)
 S DFN=$P(GMRAPA(0),"^") D DEM^VADPT S GMRANAM=VADM(1) D KVAR^VADPT K VA
"RTN","GMRADSP2",7,0)
 S GMRADRUG=$S($P(GMRAPA(0),U,20)["D":1,1:0)
"RTN","GMRADSP2",8,0)
 S GMRAERR=$S($D(^GMR(120.8,GMRAPA,"ER")):+^("ER"),1:0) S:'$D(GMRAPG) GMRAPG=0
"RTN","GMRADSP2",9,0)
 D:$Y+3>IOSL EOP^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",10,0)
 ;D:'GMRAPG HDR^GMRADSP3
"RTN","GMRADSP2",11,0)
 I 'GMRAPRNT S GMRASP(1)=7,GMRAHDR(1)="PATIENT: ",GMRALIN(1)=$E(GMRANAM,1,23),GMRASP(2)=41,GMRAHDR(2)="CAUSATIVE AGENT: ",GMRALIN(2)=$E($P(GMRAPA(0),"^",2),1,21) D WRITE^GMRADSP3 G:GMRAOUT EXIT ;21
"RTN","GMRADSP2",12,0)
 I GMRAPRNT S GMRASP(1)=9,GMRAHDR(1)="AGENT: ",GMRALIN(1)=$E($P(GMRAPA(0),"^",2),1,23),GMRASP(2)="" D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",13,0)
 G:'GMRADRUG ORIG S (GMRADI,GMRADC)=0,GMRAFT=1
"RTN","GMRADSP2",14,0)
DICL ;
"RTN","GMRADSP2",15,0)
 S:GMRADI'="" GMRADI=$O(^GMR(120.8,GMRAPA,2,GMRADI)) S:GMRADC'="" GMRADC=$O(^GMR(120.8,GMRAPA,3,GMRADC)) G:GMRADI'>0&(GMRADC'>0)&'GMRAFT ORIG
"RTN","GMRADSP2",16,0)
 ;--41-4
"RTN","GMRADSP2",17,0)
 S GMRASP(1)=$S(GMRAFT:3,'GMRADI:"",1:16),GMRAHDR(1)=$S(GMRAFT:"INGREDIENTS: ",1:""),X=$S($D(^GMR(120.8,GMRAPA,2,+GMRADI,0)):^(0),1:"")
"RTN","GMRADSP2",18,0)
 ;S GMRALIN(1)=$E($S($D(^PS(50.416,+X,0)):$P(^(0),"^"),1:""),1,23)
"RTN","GMRADSP2",19,0)
 D ZERO^PSN50P41(+X,"","","ENCAP")
"RTN","GMRADSP2",20,0)
 S GMRALIN(1)=""
"RTN","GMRADSP2",21,0)
 I $G(^TMP($J,"ENCAP",0))>0 S GMRALIN(1)=$E($G(^TMP($J,"ENCAP",X,.01)),1,23)
"RTN","GMRADSP2",22,0)
 K ^TMP($J,"ENCAP")
"RTN","GMRADSP2",23,0)
 ;--41-4
"RTN","GMRADSP2",24,0)
 S GMRASP(2)=$S(GMRAFT:41,'GMRADC:"",1:58),GMRAHDR(2)=$S(GMRAFT:"VA DRUG CLASSES: ",1:""),X=$S($D(^GMR(120.8,GMRAPA,3,+GMRADC,0)):^(0),1:"")
"RTN","GMRADSP2",25,0)
 ;S GMRALIN(2)=$E($S($D(^PS(50.605,+X,0)):$P(^(0),"^",2),1:""),1,21)
"RTN","GMRADSP2",26,0)
 D IEN^PSN50P65(+X,"","ENCAP")
"RTN","GMRADSP2",27,0)
 S GMRALIN(2)=""
"RTN","GMRADSP2",28,0)
 I $G(^TMP($J,"ENCAP",0))>0 S GMRALIN(2)=$E($G(^TMP($J,"ENCAP",X,1)),1,21)
"RTN","GMRADSP2",29,0)
 K ^TMP($J,"ENCAP")
"RTN","GMRADSP2",30,0)
 D WRITE^GMRADSP3 G:GMRAOUT EXIT S GMRAFT=0 G DICL
"RTN","GMRADSP2",31,0)
ORIG ;
"RTN","GMRADSP2",32,0)
 S GMRAREA=0,GMRATRT=0
"RTN","GMRADSP2",33,0)
 S (GMRASP(1),GMRASP(2))="" D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",34,0)
 S Y=$P(GMRAPA(0),"^",4) S:Y Y=$$FMTE^XLFDT(Y) S GMRASP(1)=4,GMRAHDR(1)="ORIGINATOR: ",GMRALIN(1)=$$GET1^DIQ(200,$P(GMRAPA(0),U,5)_",",".01") ;21
"RTN","GMRADSP2",35,0)
 S GMRASP(2)=46,GMRAHDR(2)="ORIGINATED: ",GMRALIN(2)=Y D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",36,0)
 S GMRASP(1)=6,GMRAHDR(1)="SIGN OFF: ",GMRALIN(1)=$S($P(GMRAPA(0),"^",12)=1:"YES",1:"NO"),GMRASP(2)=48,GMRAHDR(2)="OBS/HIST: ",GMRALIN(2)=$S($P(GMRAPA(0),"^",6)="o":"OBSERVED",$P(GMRAPA(0),"^",6)="h":"HISTORICAL",1:"")
"RTN","GMRADSP2",37,0)
 D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",38,0)
 I $D(^GMR(120.85,"C",GMRAPA)) D  ;21
"RTN","GMRADSP2",39,0)
 .S (GMRASP(1),GMRASP(2))="" ;21
"RTN","GMRADSP2",40,0)
 .N GMRAI,SEVER S (GMRAI,SEVER)=0 F  S GMRAI=$O(^GMR(120.85,"C",GMRAPA,GMRAI)) Q:'+GMRAI  S:+$P(^GMR(120.85,GMRAI,0),U,14)>SEVER SEVER=$P(^(0),U,14) ;21
"RTN","GMRADSP2",41,0)
 .I $G(SEVER) S GMRASP(1)=6,GMRAHDR(1)="SEVERITY: ",GMRALIN(1)=$S(SEVER=1:"MILD",SEVER=2:"MODERATE",1:"SEVERE") ;21
"RTN","GMRADSP2",42,0)
 .S GMRASP(2)=49,GMRAHDR(2)="OBS D/T: ",GMRALIN(2)=$$FMTE^XLFDT($P(^GMR(120.85,$O(^GMR(120.85,"C",GMRAPA,0)),0),U)) ;21
"RTN","GMRADSP2",43,0)
 .D WRITE^GMRADSP3 G:GMRAOUT EXIT ;21
"RTN","GMRADSP2",44,0)
 .Q  ;21
"RTN","GMRADSP2",45,0)
 I ($Y+4)>IOSL D EOP^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",46,0)
 D DISP1^GMRAPEM1(GMRAPA,"O",.GMRAOUT) G:GMRAOUT EXIT
"RTN","GMRADSP2",47,0)
 S (GMRASP(1),GMRASP(2))="" D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",48,0)
 S GMRASP(1)=0,GMRAHDR(1)="ID BAND MARKED: ",Y="",Y=$O(^GMR(120.8,GMRAPA,14,"A",Y)),Y=9999999-Y S:Y'=9999999 Y=$$FMTE^XLFDT(Y) S:Y=9999999 Y="" ;21
"RTN","GMRADSP2",49,0)
 S GMRASP(2)=44,GMRALIN(1)=Y,GMRAHDR(2)="CHART MARKED: ",Y="",Y=$O(^GMR(120.8,GMRAPA,13,"A",Y)),Y=9999999-Y S:Y'=9999999 Y=$$FMTE^XLFDT(Y) S:Y=9999999 Y="" S GMRALIN(2)=Y ;21
"RTN","GMRADSP2",50,0)
 D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",51,0)
 G RESET
"RTN","GMRADSP2",52,0)
LINEOUT ;
"RTN","GMRADSP2",53,0)
 S GMRASP(1)=$S(GMRAFT:6,1:16),GMRAHDR(1)=$S(GMRAFT:"COMMENTS: ",1:""),GMRALIN(1)=$S($D(^UTILITY($J,"W",15,+GMRAX,0)):^(0),1:""),GMRASP(2)="" D WRITE^GMRADSP3 G:GMRAOUT EXIT S GMRAFT=0
"RTN","GMRADSP2",54,0)
 Q
"RTN","GMRADSP2",55,0)
RESET ;
"RTN","GMRADSP2",56,0)
 D ^GMRADSP3
"RTN","GMRADSP2",57,0)
EXIT K DIWF,DIWL,DIWR,GMRA,GMRADC,GMRADI,GMRAHDR,GMRALIN,GMRASP,GMRAFT,GMRAREA,GMRATRT,GMRAX
"RTN","GMRADSP2",58,0)
 Q
"RTN","GMRAFX2")
0^3^B25396107^B24928118
"RTN","GMRAFX2",1,0)
GMRAFX2 ;SLC/DAN - Select reactant for update ;1/7/08  09:36
"RTN","GMRAFX2",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,21,23,41**;Mar 29, 1996;Build 8
"RTN","GMRAFX2",3,0)
 ;DBIA SECTION
"RTN","GMRAFX2",4,0)
 ;10026 - DIR
"RTN","GMRAFX2",5,0)
 ;4631  - XTID
"RTN","GMRAFX2",6,0)
 ;4829  - PSN5067
"RTN","GMRAFX2",7,0)
 ;10104 - XLFSTR
"RTN","GMRAFX2",8,0)
 ;10103 - XLFDT
"RTN","GMRAFX2",9,0)
 ;10006 - DIC
"RTN","GMRAFX2",10,0)
 ;4554  - PSNDI
"RTN","GMRAFX2",11,0)
 ;2574  - $$TGTOG^PSNAPIS
"RTN","GMRAFX2",12,0)
 ;
"RTN","GMRAFX2",13,0)
EN1 ; Select new reactant
"RTN","GMRAFX2",14,0)
 N DIR,Y,DIRUT,X,DTOUT,DUOUT,DIC,GMRALAR,D,ENTRY,OK,CNT,LST,ROOT,NAM,DIROUT
"RTN","GMRAFX2",15,0)
 S DIR(0)="FO^3:30",DIR("A")="Enter Causative Agent",DIR("?")="^D HELP^GMRAFX2" D ^DIR S:$D(DIROUT) STOP=1 Q:$D(DIRUT)  S GMRALAR=$$UP^XLFSTR(Y)
"RTN","GMRAFX2",16,0)
NPA S DIC("S")="I $P(^(0),U)'=""OTHER ALLERGY/ADVERSE REACTION""&($S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.82,.01,Y_"",""),1:1))" ;21,23
"RTN","GMRAFX2",17,0)
 W !!,"Checking GMR ALLERGIES (#120.82) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC ;21
"RTN","GMRAFX2",18,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) Q
"RTN","GMRAFX2",19,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAFX2",20,0)
 K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",21,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAFX2",22,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,Y_"",""),1:1)" D DIC^PSNDI(50.6,"GMRA",.DIC,.X,,$$DT^XLFDT) K DIC S:+Y>0 ENTRY=X D DIC ;23,41
"RTN","GMRAFX2",23,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",24,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAFX2",25,0)
 K DUOUT,DTOUT,Y,ENTRY
"RTN","GMRAFX2",26,0)
 S ROOT="^TMP($J,""GMRASEL"",""B"")",CNT=0,X=GMRALAR ;41
"RTN","GMRAFX2",27,0)
 D ALL^PSN5067(,X,$$DT^XLFDT,"GMRASEL") ;41
"RTN","GMRAFX2",28,0)
 I $D(@ROOT@(X)),$S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(X)_","),1:1) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;23 Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAFX2",29,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",30,0)
 .Q:$S($L($T(SCREEN^XTID)):$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(NAM)_","),1:0)  ;23
"RTN","GMRAFX2",31,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAFX2",32,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",33,0)
 I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",34,0)
 I CNT>1 D
"RTN","GMRAFX2",35,0)
 .D MATCHES
"RTN","GMRAFX2",36,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",37,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",38,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",39,0)
 D DIC
"RTN","GMRAFX2",40,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",41,0)
 ;Selection from file 50 removed in patch 23 and code actually removed in 41
"RTN","GMRAFX2",42,0)
 ;19 - Moved ING and CLASS code here from above
"RTN","GMRAFX2",43,0)
ING W !!,"Now checking INGREDIENT (#50.416) file for matches...",! ;23
"RTN","GMRAFX2",44,0)
 K Y,DTOUT,DUOUT,ENTRY S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.416,.01,Y_"",""),1:1)",X=GMRALAR D IX^PSNDI(50.416,"GMRA",.DIC,D,.X,,$$DT^XLFDT) K DIC S:+Y>0 ENTRY=X D DIC ;23,41
"RTN","GMRAFX2",45,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",46,0)
CLASS W !!,"Now checking VA DRUG CLASS (#50.605) file for matches...",! ;23
"RTN","GMRAFX2",47,0)
 K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.605,.01,Y_"",""),1:1)",D="C" D IX^PSNDI(50.605,"GMRA",.DIC,D,.X,,$$DT^XLFDT) K DIC S:+Y>0 ENTRY=X D DIC ;23,41
"RTN","GMRAFX2",48,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",49,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files.",!,"Please try again (check spelling, etc).",!,"If you need to add a new reactant, use the AE option." G EN1
"RTN","GMRAFX2",50,0)
 Q
"RTN","GMRAFX2",51,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAFX2",52,0)
 N DIR,X,Y
"RTN","GMRAFX2",53,0)
 Q:'$D(ENTRY)
"RTN","GMRAFX2",54,0)
 K OK
"RTN","GMRAFX2",55,0)
 W !!,"You selected ",ENTRY
"RTN","GMRAFX2",56,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Is this correct",DIR("?")="Answer yes if this is the correct reactant" D ^DIR S:Y=1 OK=1
"RTN","GMRAFX2",57,0)
 Q
"RTN","GMRAFX2",58,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAFX2",59,0)
 N I,J,QUIT
"RTN","GMRAFX2",60,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAFX2",61,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAFX2",62,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAFX2",63,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAFX2",64,0)
 Q
"RTN","GMRAFX2",65,0)
        ;
"RTN","GMRAFX2",66,0)
MORE()  ; -- show more matches
"RTN","GMRAFX2",67,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAFX2",68,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAFX2",69,0)
 D ^DIR
"RTN","GMRAFX2",70,0)
 Q +Y
"RTN","GMRAFX2",71,0)
 ;
"RTN","GMRAFX2",72,0)
HELP ;Display help for selection of causative agent
"RTN","GMRAFX2",73,0)
 W !,"Enter new causative agent to be assigned to the selected entries."
"RTN","GMRAFX2",74,0)
 W !,"Enter between 3 and 30 characters.  The entered text will then be"
"RTN","GMRAFX2",75,0)
 W !,"searched for in a number of different files.  Select the appropriate"
"RTN","GMRAFX2",76,0)
 W !,"entry from the appropriate file to update the selected patient."
"RTN","GMRAFX2",77,0)
 W !!,"Enter ^ to skip the current patient or ^^ to exit the entire process."
"RTN","GMRAFX2",78,0)
 Q
"RTN","GMRAHLP0")
0^4^B6444149^B3759009
"RTN","GMRAHLP0",1,0)
GMRAHLP0 ;HIRMFO/YMP,RM-ALLERGY HELP MODULES ;11/16/07  09:06
"RTN","GMRAHLP0",2,0)
 ;;4.0;Adverse Reaction Tracking;**41**;Mar 29, 1996;Build 8
"RTN","GMRAHLP0",3,0)
 ;DBIA Section
"RTN","GMRAHLP0",4,0)
 ;PSNDI - 4554
"RTN","GMRAHLP0",5,0)
 ;DIC   - 10006
"RTN","GMRAHLP0",6,0)
 ;XLFDT - 10103
"RTN","GMRAHLP0",7,0)
EN1 ; PRINT HELP FOR CAUSATIVE AGENT FIELD
"RTN","GMRAHLP0",8,0)
 W !?3,"ENTER THE NAME OF THE CAUSATIVE AGENT, 3-30 CHARACTERS."
"RTN","GMRAHLP0",9,0)
 Q
"RTN","GMRAHLP0",10,0)
HELP ; HELP FOR A/AR LOOKUP
"RTN","GMRAHLP0",11,0)
 I $D(GMRAHLP) D:'$D(GMRAL) EN1^GMRADPT D EN1^GMRADSP0(.GMRAL) Q:GMRAOUT
"RTN","GMRAHLP0",12,0)
EXHLP W !!?4,"Would you like to see a list of:",!?6,"1  Local Allergies (Food/Drug/Other)",!?6,"2  Drug Classes",!?6,"3  Drug Ingredients",!?6,"4  National Drugs" ;41 Removed file 50 from list
"RTN","GMRAHLP0",13,0)
 R !?4,"Select a number (1-4):",X:DTIME S:'$T X="^^" I "^^"[X S:X="^^"!(X="^") GMRAOUT=1 Q  ;41 changed range from 1-5 to 1-4
"RTN","GMRAHLP0",14,0)
 I X\1'=X!(X<1)!(X>4) W !?7,$C(7),"ANSWER WITH THE NUMBER (1-4) OF THE SELECTION FOR",!?7,"WHICH YOU WISH TO SEE MORE HELP." G EXHLP ;41 Changed 5 to 4 for selection
"RTN","GMRAHLP0",15,0)
 S DIC=$S(X=1:120.82,X=2:50.605,X=3:50.416,1:50.6) D HLPLK ;41 Removed file 50 reference
"RTN","GMRAHLP0",16,0)
 G EXHLP
"RTN","GMRAHLP0",17,0)
HLPLK ; LOOKUP ON FILE IN DIC
"RTN","GMRAHLP0",18,0)
 S DIC(0)="E",X="??" S:DIC=50.416 D="P" S:DIC=50.605 DIC("W")="W ?10,$P(^(0),U,2)",DIC(0)="SE",D="C" ;41 Split line due to length
"RTN","GMRAHLP0",19,0)
 I DIC=120.82 D ^DIC Q  ;41 Separate out the call to DIC if it's 120.82
"RTN","GMRAHLP0",20,0)
 I DIC=50.6 D DIC^PSNDI(DIC,"GMRA",.DIC,.X,,$$DT^XLFDT) Q  ;41 Changed DIC calls to associated calls in pharmacy
"RTN","GMRAHLP0",21,0)
 D IX^PSNDI(DIC,"GMRA",.DIC,D,.X,,$$DT^XLFDT) ;41 Changed DIC calls to associated calls in pharmacy
"RTN","GMRAHLP0",22,0)
 Q
"RTN","GMRAOR")
0^5^B69044277^B72764416
"RTN","GMRAOR",1,0)
GMRAOR ;HIRMFO/WAA,RM-OERR UTILITIES ; 1/14/08 11:46am
"RTN","GMRAOR",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,13,26,37,41**;Mar 29, 1996;Build 8
"RTN","GMRAOR",3,0)
ORCHK(DFN,TYP,PTR,LOC) ; Given a patient IEN (DFN), this function will
"RTN","GMRAOR",4,0)
 ; return 1 (true) if the patient has an allergy to an agent defined
"RTN","GMRAOR",5,0)
 ; by TYP and PTR, else it returns 0 (false). See table below.
"RTN","GMRAOR",6,0)
 ; The Contrast Media Reaction check will return a null if the patient
"RTN","GMRAOR",7,0)
 ; is not in the ART database.  Contrast Media checks will also
"RTN","GMRAOR",8,0)
 ; return whether the check is from local or remote data as the second
"RTN","GMRAOR",9,0)
 ; piece of the flag if LOC is defined as a positive integer
"RTN","GMRAOR",10,0)
 ; 
"RTN","GMRAOR",11,0)
 ;    Contrast Media Reaction:  TYP="CM", PTR (undefined)
"RTN","GMRAOR",12,0)
 ;              Drug Reaction:  TYP="DR", PTR=IEN in ^PSNDF(.
"RTN","GMRAOR",13,0)
 ;           Drug Ingredients:  TYP="IN", PTR=IEN in ^PS(50.416,
"RTN","GMRAOR",14,0)
 ;                 Drug Class:  TYP="CL", PTR=IEN in ^PS(50.605,
"RTN","GMRAOR",15,0)
 ;
"RTN","GMRAOR",16,0)
 N GMRAFLG,GMRACM,DA ;37
"RTN","GMRAOR",17,0)
 S GMRAFLG=0
"RTN","GMRAOR",18,0)
 I $G(DFN)<1!("^CM^DR^IN^CL^"'[("^"_$G(TYP)_"^"))!($G(TYP)'="CM"&($G(PTR)<1)) S GMRAFLG=""
"RTN","GMRAOR",19,0)
 E  D
"RTN","GMRAOR",20,0)
 .D GETDATA(DFN) ;26 Retreive local/remote allergy data for order checking
"RTN","GMRAOR",21,0)
 .I TYP="CM" S GMRAFLG=$$RAD(DFN)_$S($G(LOC)&($G(GMRACM)'=""):("^"_$G(GMRACM)),1:"") ;37 check for Contrast Media Reaction, return location if requested
"RTN","GMRAOR",22,0)
 .I TYP="DR" S GMRAFLG=$$DRUG(DFN,PTR) ; check for Drug Reaction
"RTN","GMRAOR",23,0)
 .I TYP="IN" S GMRAFLG=$$ING(DFN,PTR) ; Check for Drug Ingredients
"RTN","GMRAOR",24,0)
 .I TYP="CL" S GMRAFLG=$$CLASS(DFN,PTR) ; Check for Drug Class
"RTN","GMRAOR",25,0)
 .Q
"RTN","GMRAOR",26,0)
 Q GMRAFLG
"RTN","GMRAOR",27,0)
RAD(DFN) ; Subroutine checks for Contrast Media Reaction, returns 1 or 0.
"RTN","GMRAOR",28,0)
 N FLG,DC,LOCAL,REMOTE ;37 entire section added
"RTN","GMRAOR",29,0)
 S FLG=$P($G(^GMR(120.86,DFN,0)),U,2) S:FLG=1 FLG=0 S DC="DX10" F  S DC=$O(^TMP("GMRAOC",$J,"APC",DC)) Q:DC'["DX10"  D
"RTN","GMRAOR",30,0)
 .S FLG=1
"RTN","GMRAOR",31,0)
 .I $G(^TMP("GMRAOC",$J,"APC",DC))["LOCAL" S LOCAL=1
"RTN","GMRAOR",32,0)
 .I $G(^TMP("GMRAOC",$J,"APC",DC))["REMOTE" S REMOTE=1
"RTN","GMRAOR",33,0)
 S GMRACM=$S($G(LOCAL)&($G(REMOTE)):"LOCAL AND REMOTE SITE(S)",$G(LOCAL):"LOCAL",$G(REMOTE):"REMOTE SITE(S)",1:"")
"RTN","GMRAOR",34,0)
 ;D EN1^GMRADPT S FLG=GMRAL
"RTN","GMRAOR",35,0)
 ;I GMRAL S GMRAPA=0 F  S GMRAPA=$O(GMRAL(GMRAPA)) Q:GMRAPA<1  D  Q:FLG
"RTN","GMRAOR",36,0)
 ;.S FLG=$$RALLG^GMRARAD(GMRAPA)
"RTN","GMRAOR",37,0)
 ;.Q
"RTN","GMRAOR",38,0)
 Q FLG
"RTN","GMRAOR",39,0)
DRUG(DFN,PTR) ; Subroutine checks for Drug Reaction, returns 1 or 0.
"RTN","GMRAOR",40,0)
 N %,FLG,GMRAC,GMRADR,GMRAI,PSNVPN,PSNDA S FLG=0
"RTN","GMRAOR",41,0)
 K GMRAING,GMRADRCL
"RTN","GMRAOR",42,0)
 S PSNDA=$P(PTR,"."),PSNVPN=$P(PTR,".",2)
"RTN","GMRAOR",43,0)
 I $G(@($$NDFREF_PSNDA_",0)"))'="" D
"RTN","GMRAOR",44,0)
 .; Check for rxn to ingredients.
"RTN","GMRAOR",45,0)
 .; If use the new entry point if there.
"RTN","GMRAOR",46,0)
 .I $T(DISPDRG^PSNNGR)]"",PSNVPN]"" D
"RTN","GMRAOR",47,0)
 ..K ^TMP("PSNDD",$J) D DISPDRG^PSNNGR ; get ingredients
"RTN","GMRAOR",48,0)
 ..S GMRAI=0,%=1 F  S GMRAI=$O(^TMP("PSNDD",$J,GMRAI)) Q:GMRAI<1  I $D(^TMP("GMRAOC",$J,"API",GMRAI)) S FLG=1,GMRAING(%)=^TMP("PSNDD",$J,GMRAI)_$$FAC(^TMP("GMRAOC",$J,"API",GMRAI)),%=%+1 ;26
"RTN","GMRAOR",49,0)
 ..K ^TMP("PSNDD",$J)
"RTN","GMRAOR",50,0)
 ..Q
"RTN","GMRAOR",51,0)
 .E  D  ; get ingredients
"RTN","GMRAOR",52,0)
 ..K ^TMP("PSN",$J) D ^PSNNGR
"RTN","GMRAOR",53,0)
 ..S GMRAI=0,%=1 F  S GMRAI=$O(^TMP("PSN",$J,GMRAI)) Q:GMRAI<1  I $D(^TMP("GMRAOC",$J,"API",GMRAI)) S FLG=1,GMRAING(%)=^TMP("PSN",$J,GMRAI)_$$FAC(^TMP("GMRAOC",$J,"API",GMRAI)),%=%+1 ;26
"RTN","GMRAOR",54,0)
 ..K ^TMP("PSN",$J)
"RTN","GMRAOR",55,0)
 ..Q
"RTN","GMRAOR",56,0)
 .Q:FLG  ; Rxn to ingredient, quit now.
"RTN","GMRAOR",57,0)
 .; Check for rxn to VA Drug Class
"RTN","GMRAOR",58,0)
 .S PSNDA=$P(PTR,"."),PSNVPN=$P(PTR,".",2)
"RTN","GMRAOR",59,0)
 .N CLASS
"RTN","GMRAOR",60,0)
 .I PSNVPN S CLASS=$$DCLCODE^PSNAPIS(PSNDA,PSNVPN) D DRCL(CLASS) Q
"RTN","GMRAOR",61,0)
 .N CLASS,GMRALIST
"RTN","GMRAOR",62,0)
 .S GMRALIST=$$CLIST^PSNAPIS(PSNDA,.GMRALIST) Q:'$G(GMRALIST)
"RTN","GMRAOR",63,0)
 .S GMRALIST=0 F  S GMRALIST=$O(GMRALIST(GMRALIST)) Q:'GMRALIST  D DRCL($P(GMRALIST(GMRALIST),U,2))
"RTN","GMRAOR",64,0)
 .Q
"RTN","GMRAOR",65,0)
 Q FLG
"RTN","GMRAOR",66,0)
FAC(NODE) ;
"RTN","GMRAOR",67,0)
 N FAC
"RTN","GMRAOR",68,0)
 S FAC=$S($L(NODE):" ("_NODE_")",1:"")
"RTN","GMRAOR",69,0)
 Q FAC
"RTN","GMRAOR",70,0)
DRCL(CODE) ;return any rxn's in GMRADRCL(
"RTN","GMRAOR",71,0)
 I '$D(^TMP("GMRAOC",$J,"APC",CODE)) Q
"RTN","GMRAOR",72,0)
 N J S J=$S('$D(GMRADRCL):1,1:$O(GMRADRCL(999),-1)+1)
"RTN","GMRAOR",73,0)
 ;S GMRADRCL(J)=$$CLASS2^PSNAPIS(CODE)
"RTN","GMRAOR",74,0)
 N CLSFN
"RTN","GMRAOR",75,0)
 ;S CLSFN=$P(^PS(50.605,+$O(^PS(50.605,"B",CODE,0)),0),U,2)
"RTN","GMRAOR",76,0)
 S CLSFN=$$CODE2CL^GMRAPENC(CODE)
"RTN","GMRAOR",77,0)
 S GMRADRCL(J)=CODE_"^"_CLSFN_$$FAC(^TMP("GMRAOC",$J,"APC",CODE))
"RTN","GMRAOR",78,0)
 S FLG=2
"RTN","GMRAOR",79,0)
 Q 
"RTN","GMRAOR",80,0)
ING(DFN,PTR) ; Subroutine checks for Drug Ingredients, returns:
"RTN","GMRAOR",81,0)
 ;                  If found FLG= 1 with GMRAIEN Array Drug Ingredients
"RTN","GMRAOR",82,0)
 ;                 Not found FLG= 0
"RTN","GMRAOR",83,0)
 N GMRAX K GMRAIEN
"RTN","GMRAOR",84,0)
 S FLG=0
"RTN","GMRAOR",85,0)
 S GMRAX=0
"RTN","GMRAOR",86,0)
 F  S GMRAX=$O(^GMR(120.8,"API",DFN,PTR,GMRAX)) Q:GMRAX<1  S FLG=1,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",87,0)
 Q FLG
"RTN","GMRAOR",88,0)
CLASS(DFN,PTR) ; Subroutine checks for Drug Class, returns:
"RTN","GMRAOR",89,0)
 ;                  If found FLG= 1 with GMRAIEN Array Drug Class
"RTN","GMRAOR",90,0)
 ;                 Not found FLG= 0
"RTN","GMRAOR",91,0)
 N GMRAC,GMRAX K GMRAIEN
"RTN","GMRAOR",92,0)
 ;S GMRAX=0,FLG=0,GMRAC=$P($G(^PS(50.605,PTR,0)),U)
"RTN","GMRAOR",93,0)
 S GMRAX=0,FLG=0,GMRAC=$$CLP2CODE^GMRAPENC(PTR)
"RTN","GMRAOR",94,0)
 I GMRAC'="" F  S GMRAX=$O(^GMR(120.8,"APC",DFN,GMRAC,GMRAX)) Q:GMRAX<1  S FLG=1,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",95,0)
 Q FLG
"RTN","GMRAOR",96,0)
NDFREF() ;get version dependent NDF reference
"RTN","GMRAOR",97,0)
 I $$VERSION^XPDUTL("PSN")<4 Q "^PSNDF("
"RTN","GMRAOR",98,0)
 Q "^PSNDF(50.6," ; new reference for ver 4.0
"RTN","GMRAOR",99,0)
 ;
"RTN","GMRAOR",100,0)
GETDATA(DFN) ;Obtain local and HDR related allergy data for use in order checking.  Section added in patch 26
"RTN","GMRAOR",101,0)
 ;Output from call will be stored in ^TMP as follows:
"RTN","GMRAOR",102,0)
 ;^TMP("GMRAOC",$J,"API",J)="" where J is the ingredient IEN
"RTN","GMRAOR",103,0)
 ;^TMP("GMRAOC",$J,"APC",K)="" where K is the drug class classification (e.g. MS105)
"RTN","GMRAOR",104,0)
 ;
"RTN","GMRAOR",105,0)
 L +^XTMP("GMRAOC",DFN)
"RTN","GMRAOR",106,0)
 S ^XTMP("GMRAOC",0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","GMRAOR",107,0)
 N GMRRECDT,GMRCACHE,GMRFRESH,GMRNEW,GMRXTMP
"RTN","GMRAOR",108,0)
 S (GMRFRESH,GMRNEW,GMRXTMP)=0
"RTN","GMRAOR",109,0)
 S GMRRECDT=$P($G(^XTMP("ORRDI","ART",DFN,0)),U)
"RTN","GMRAOR",110,0)
 S GMRCACHE=$$GET^XPAR("SYS","OR RDI CACHE TIME")
"RTN","GMRAOR",111,0)
 I $$FMDIFF^XLFDT($$NOW^XLFDT,GMRRECDT,2)<(60*GMRCACHE),$P(^XTMP("ORRDI","ART",DFN,0),U,3)>-1 S GMRFRESH=1
"RTN","GMRAOR",112,0)
 S GMRXTMP=$D(^XTMP("GMRAOC",DFN))
"RTN","GMRAOR",113,0)
 S GMRNEW=$S($D(^XTMP("GMRAOC",DFN,"ERROR")):2,$D(^XTMP("GMRAOC",DFN,"NEW")):1,1:0)
"RTN","GMRAOR",114,0)
 I GMRFRESH&GMRXTMP&(GMRNEW=1) K ^XTMP("GMRAOC",DFN,"NEW") D LOCAL(DFN)
"RTN","GMRAOR",115,0)
 I 'GMRFRESH!'GMRXTMP!(GMRNEW=2) K ^XTMP("GMRAOC",DFN) D REMOTE(DFN),LOCAL(DFN)
"RTN","GMRAOR",116,0)
 I GMRRECDT'=$G(^XTMP("GMRAOC",DFN,0)) K ^XTMP("GMRAOC",DFN) D REMOTE(DFN),LOCAL(DFN)
"RTN","GMRAOR",117,0)
 K ^TMP("GMRAOC",$J)
"RTN","GMRAOR",118,0)
 M ^TMP("GMRAOC",$J)=^XTMP("GMRAOC",DFN)
"RTN","GMRAOR",119,0)
 L -^XTMP("GMRAOC",DFN)
"RTN","GMRAOR",120,0)
 Q
"RTN","GMRAOR",121,0)
 ;
"RTN","GMRAOR",122,0)
LOCAL(DFN) ;
"RTN","GMRAOR",123,0)
 N J
"RTN","GMRAOR",124,0)
 S J=0 F  S J=$O(^GMR(120.8,"API",DFN,J)) Q:'+J  S ^XTMP("GMRAOC",DFN,"API",J)=$$SETNODE^GMRAOR1($G(^XTMP("GMRAOC",DFN,"API",J)),"LOCAL")
"RTN","GMRAOR",125,0)
 S J="" F  S J=$O(^GMR(120.8,"APC",DFN,J)) Q:J=""  S ^XTMP("GMRAOC",DFN,"APC",J)=$$SETNODE^GMRAOR1($G(^XTMP("GMRAOC",DFN,"APC",J)),"LOCAL")
"RTN","GMRAOR",126,0)
 Q
"RTN","GMRAOR",127,0)
 ;
"RTN","GMRAOR",128,0)
REMOTE(DFN) ;
"RTN","GMRAOR",129,0)
 ;I $G(TYP)'="DR" Q  ;only get remote data for order checking on drug orders
"RTN","GMRAOR",130,0)
 N J,FLG,REACT,IN,VUID,FILE,GMRARAY,DC,DCLASS,GMRAING,GMRADC,K,INGLST,I,PRIM,IEN
"RTN","GMRAOR",131,0)
 ;Check for HDR data
"RTN","GMRAOR",132,0)
 Q:'$L($T(HAVEHDR^ORRDI1))  Q:'$$HAVEHDR^ORRDI1  ;Quit if call doesn't exist or if the HDR isn't available
"RTN","GMRAOR",133,0)
 Q:'$$GET^ORRDI1(DFN,"ART")  ;Quit if no HDR data for selected patient
"RTN","GMRAOR",134,0)
 S ^XTMP("GMRAOC",DFN,0)=$P($G(^XTMP("ORRDI","ART",DFN,0)),U)
"RTN","GMRAOR",135,0)
 S J=0 F  S J=$O(^XTMP("ORRDI","ART",DFN,J)) Q:'+J  D
"RTN","GMRAOR",136,0)
 .S FLG=0
"RTN","GMRAOR",137,0)
 .S REACT=$G(^XTMP("ORRDI","ART",DFN,J,"REACTANT",0)) ;Reaction VUID
"RTN","GMRAOR",138,0)
 .I $D(^XTMP("ORRDI","ART",DFN,J,"DRUG INGREDIENTS")) D  ;Ingredient data exists
"RTN","GMRAOR",139,0)
 ..S FLG=1 ;Have ingredient data so REACT is ok
"RTN","GMRAOR",140,0)
 ..S IN=0 F  S IN=$O(^XTMP("ORRDI","ART",DFN,J,"DRUG INGREDIENTS",IN)) Q:'+IN  D
"RTN","GMRAOR",141,0)
 ...S VUID=$P(^(IN),U),FILE=$P(^(IN),U,3) ;Naked from above line
"RTN","GMRAOR",142,0)
 ...S FILE=$P(FILE,"99VA",2)
"RTN","GMRAOR",143,0)
 ...D GETIREF^XTID(FILE,,VUID,"GMRARAY") ;Get IENs related to VUID
"RTN","GMRAOR",144,0)
 ...S IEN=0 F  S IEN=$O(GMRARAY(FILE,.01,IEN)) Q:'+IEN  S ^XTMP("GMRAOC",DFN,"API",+IEN)=$$SETNODE^GMRAOR1($G(^XTMP("GMRAOC",DFN,"API",+IEN)),"REMOTE SITE(S)")
"RTN","GMRAOR",145,0)
 ...K GMRARAY
"RTN","GMRAOR",146,0)
 .I $D(^XTMP("ORRDI","ART",DFN,J,"DRUG CLASSES")) D  ;Drug class data exists
"RTN","GMRAOR",147,0)
 ..S FLG=1
"RTN","GMRAOR",148,0)
 ..S DC=0 F  S DC=$O(^XTMP("ORRDI","ART",DFN,J,"DRUG CLASSES",DC)) Q:'+DC  D
"RTN","GMRAOR",149,0)
 ...S DCLASS=$P(^(DC),U,2) ;Naked from above, gets drug class (e.g.MS105)
"RTN","GMRAOR",150,0)
 ...S ^XTMP("GMRAOC",DFN,"APC",DCLASS)=$$SETNODE^GMRAOR1($G(^XTMP("GMRAOC",DFN,"APC",DCLASS)),"REMOTE SITE(S)")
"RTN","GMRAOR",151,0)
 .D FIND(REACT,.GMRAING,.GMRADC) I $D(GMRAING)!($D(GMRADC)) D
"RTN","GMRAOR",152,0)
 ..S K=0 F  S K=$O(GMRAING(K)) Q:'+K  S ^XTMP("GMRAOC",DFN,"API",K)=$$SETNODE^GMRAOR1($G(^XTMP("GMRAOC",DFN,"API",K)),"REMOTE SITE(S)")
"RTN","GMRAOR",153,0)
 ..S K="" F  S K=$O(GMRADC(K)) Q:K=""  S ^XTMP("GMRAOC",DFN,"APC",K)=$$SETNODE^GMRAOR1($G(^XTMP("GMRAOC",DFN,"APC",K)),"REMOTE SITE(S)")
"RTN","GMRAOR",154,0)
 I $D(^XTMP("GMRAOC",DFN,"API")) D
"RTN","GMRAOR",155,0)
 .N I,INGLST
"RTN","GMRAOR",156,0)
 .S I=0 F  S I=$O(^XTMP("GMRAOC",DFN,"API",I)) Q:'I  D
"RTN","GMRAOR",157,0)
 ..N PRIM
"RTN","GMRAOR",158,0)
 ..S PRIM=$$PRIMARY(I)
"RTN","GMRAOR",159,0)
 ..I PRIM S INGLST(PRIM)=^XTMP("GMRAOC",DFN,"API",I) K ^XTMP("GMRAOC",DFN,"API",I)
"RTN","GMRAOR",160,0)
 .S I=0 F  S I=$O(INGLST(I)) Q:'I  S ^XTMP("GMRAOC",DFN,"API",I)=INGLST(I)
"RTN","GMRAOR",161,0)
 Q
"RTN","GMRAOR",162,0)
 ;
"RTN","GMRAOR",163,0)
FIND(REACT,ING,DC) ;If reactant didn't include drug classes and/or ingredients, try and find them locally.  Section added in patch 26
"RTN","GMRAOR",164,0)
 N VUID,FILE,PSNDA,GMRAIEN,LIST,GMRAI,GMRALIST,GMRARAY,J,SUB,FLAG
"RTN","GMRAOR",165,0)
 S FLAG=0
"RTN","GMRAOR",166,0)
 S VUID=$P(REACT,U)
"RTN","GMRAOR",167,0)
 S FILE=$P(REACT,U,3)
"RTN","GMRAOR",168,0)
 S FILE=$P(FILE,"99VA",2)
"RTN","GMRAOR",169,0)
 D GETIREF^XTID(,,VUID,"GMRARAY")
"RTN","GMRAOR",170,0)
 S FILE="" F  S FILE=$O(GMRARAY(FILE)) Q:FILE=""  D
"RTN","GMRAOR",171,0)
 .S GMRAIEN=0 F  S GMRAIEN=$O(GMRARAY(FILE,.01,GMRAIEN)) Q:'+GMRAIEN  D
"RTN","GMRAOR",172,0)
 ..I FILE=50.6 D
"RTN","GMRAOR",173,0)
 ...K ^TMP("PSN",$J) S PSNDA=+GMRAIEN D ^PSNNGR
"RTN","GMRAOR",174,0)
 ...S GMRAI=0 F  S GMRAI=$O(^TMP("PSN",$J,GMRAI)) Q:GMRAI<1  S ING(GMRAI)=""
"RTN","GMRAOR",175,0)
 ...K ^TMP("PSN",$J),GMRARAY
"RTN","GMRAOR",176,0)
 ...S PSNDA=+GMRAIEN,GMRALIST=$$CLIST^PSNAPIS(PSNDA,.GMRALIST) Q:'$G(GMRALIST)
"RTN","GMRAOR",177,0)
 ...S GMRALIST=0 F  S GMRALIST=$O(GMRALIST(GMRALIST)) Q:'GMRALIST  S DC($P(GMRALIST(GMRALIST),U,2))=""
"RTN","GMRAOR",178,0)
 ..I FILE=120.82 D
"RTN","GMRAOR",179,0)
 ...S SUB=0 F  S SUB=$O(^GMRD(120.82,+GMRAIEN,"ING",SUB)) Q:'+SUB  S ING(+$P($G(^GMRD(120.82,+GMRAIEN,"ING",SUB,0)),U))="" ;record ingredients
"RTN","GMRAOR",180,0)
 ...S SUB=0 F  S SUB=$O(^GMRD(120.82,+GMRAIEN,"CLASS",SUB)) Q:'+SUB  S DC($P($$CLASS2^PSNAPIS(+$P($G(^GMRD(120.82,+GMRAIEN,"CLASS",SUB,0)),U)),U))="" ;Get drug classes
"RTN","GMRAOR",181,0)
 ..I FILE=50.605 D
"RTN","GMRAOR",182,0)
 ...S DC($P($$CLASS2^PSNAPIS(+GMRAIEN),U))=""
"RTN","GMRAOR",183,0)
 ..I FILE=50.416 D
"RTN","GMRAOR",184,0)
 ...S ING(+GMRAIEN)=""
"RTN","GMRAOR",185,0)
 Q
"RTN","GMRAOR",186,0)
PRIMARY(INGIEN) ;check if INGIEN is a primary ingredient
"RTN","GMRAOR",187,0)
 ;returns 0 if INGIEN is primary
"RTN","GMRAOR",188,0)
 ;returns the IEN of INGIEN's primary ingredient if INGIEN is not primary
"RTN","GMRAOR",189,0)
 N RETURN
"RTN","GMRAOR",190,0)
 K ^TMP($J,"GMRALIST")
"RTN","GMRAOR",191,0)
 D ZERO^PSN50P41(INGIEN,,,"GMRALIST")
"RTN","GMRAOR",192,0)
 S RETURN=+$G(^TMP($J,"GMRALIST",INGIEN,2))
"RTN","GMRAOR",193,0)
 Q RETURN
"RTN","GMRAOR1")
0^21^B7165118^B6008032
"RTN","GMRAOR1",1,0)
GMRAOR1 ;HIRMFO/RM,WAA-OERR UTILITIES ;8/2/04  15:13
"RTN","GMRAOR1",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,41**;Mar 29, 1996;Build 8
"RTN","GMRAOR1",3,0)
EN1(DFN,ARRAY) ; This entry returns a list of patient allergies/adverse
"RTN","GMRAOR1",4,0)
 ; reactions.
"RTN","GMRAOR1",5,0)
 ; Input variables:
"RTN","GMRAOR1",6,0)
 ;     DFN = IEN of patient in Patient (2) file
"RTN","GMRAOR1",7,0)
 ;     ARRAY = Return array for Patient reactions.
"RTN","GMRAOR1",8,0)
 ;             If ARRAY="" or undefined default will be GMRARXN.
"RTN","GMRAOR1",9,0)
 Q:$G(DFN)'>0
"RTN","GMRAOR1",10,0)
 S ARRAY=$S($G(ARRAY)'="":ARRAY,1:ARRAY="GMRARXN") Q:ARRAY="GMRAL"
"RTN","GMRAOR1",11,0)
 K GMRARXN,GMRAL,@ARRAY
"RTN","GMRAOR1",12,0)
 D EN1^GMRADPT ; Get Patient Allergies
"RTN","GMRAOR1",13,0)
 I GMRAL D  ; If the patient has reaction then reprocess to OERR Fmt
"RTN","GMRAOR1",14,0)
 .N GMRAIEN,GMRADFN,%,GMRASVR
"RTN","GMRAOR1",15,0)
 .S GMRARXN=1,GMRAIEN=0
"RTN","GMRAOR1",16,0)
 .F  S GMRAIEN=$O(GMRAL(GMRAIEN)) Q:GMRAIEN<1  D
"RTN","GMRAOR1",17,0)
 ..S GMRARXN(GMRARXN)=$P(GMRAL(GMRAIEN),U,2)_U ; Get freetext of agent.
"RTN","GMRAOR1",18,0)
 ..; Loop through 120.85 file to find all observed reacting reports for
"RTN","GMRAOR1",19,0)
 ..; this reaction.  Grab severity and store only the highest value.
"RTN","GMRAOR1",20,0)
 ..S GMRADFN=0,%="",GMRASVR="" F  S GMRADFN=$O(^GMR(120.85,"C",GMRAIEN,GMRADFN)) Q:GMRADFN<1  S %=$P($G(^GMR(120.85,GMRADFN,0)),U,14) S:%>+GMRASVR GMRASVR=%
"RTN","GMRAOR1",21,0)
 ..S GMRARXN(GMRARXN)=GMRARXN(GMRARXN)_$S(GMRASVR=1:"MILD",GMRASVR=2:"MODERATE",GMRASVR=3:"SEVERE",1:"")_U_GMRAIEN
"RTN","GMRAOR1",22,0)
 ..;Loop through the S/S multiple and get the external format and possibly the date/time.
"RTN","GMRAOR1",23,0)
 ..S %=0 F  S %=$O(GMRAL(GMRAIEN,"S",%)) Q:%<1  S GMRARXN(GMRARXN,"S",%)=$P(GMRAL(GMRAIEN,"S",%),";")_$S($G(GMRAIDT):";"_$P(^GMR(120.8,GMRAIEN,10,$O(^GMR(120.8,GMRAIEN,10,"B",$P(GMRAL(GMRAIEN,"S",%),";",2),0)),0),U,4),1:"") ;21
"RTN","GMRAOR1",24,0)
 ..S GMRARXN=GMRARXN+1
"RTN","GMRAOR1",25,0)
 ..Q
"RTN","GMRAOR1",26,0)
 .S GMRARXN=1
"RTN","GMRAOR1",27,0)
 .Q
"RTN","GMRAOR1",28,0)
 E  S GMRARXN=GMRAL
"RTN","GMRAOR1",29,0)
 I ARRAY'="GMRARXN" M @ARRAY=GMRARXN K GMRARXN
"RTN","GMRAOR1",30,0)
 K GMRAL
"RTN","GMRAOR1",31,0)
 Q
"RTN","GMRAOR1",32,0)
SETNODE(ITEM,DATA) ;
"RTN","GMRAOR1",33,0)
 N VALUE
"RTN","GMRAOR1",34,0)
 S VALUE=""
"RTN","GMRAOR1",35,0)
 I ITEM[DATA S VALUE=ITEM Q VALUE
"RTN","GMRAOR1",36,0)
 I DATA="LOCAL" D  Q VALUE
"RTN","GMRAOR1",37,0)
 .I ITEM="" S VALUE="LOCAL" Q
"RTN","GMRAOR1",38,0)
 .I ITEM["REMOTE SITE(S)" S VALUE="LOCAL AND REMOTE SITE(S)"
"RTN","GMRAOR1",39,0)
 I DATA="REMOTE SITE(S)" D  Q VALUE
"RTN","GMRAOR1",40,0)
 .I ITEM="" S VALUE="REMOTE SITE(S)" Q
"RTN","GMRAOR1",41,0)
 .I ITEM["LOCAL" S VALUE="LOCAL AND REMOTE SITE(S)"
"RTN","GMRAOR1",42,0)
 Q VALUE
"RTN","GMRAOR1",43,0)
 ;
"RTN","GMRAOR2")
0^6^B11000982^B10543663
"RTN","GMRAOR2",1,0)
GMRAOR2 ;HIRMFO/RM-OERR UTILITIES ; 11/29/07 12:17pm
"RTN","GMRAOR2",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,41**;Mar 29, 1996;Build 8
"RTN","GMRAOR2",3,0)
EN1(IEN,ARRAY) ; This entry point returns detailed information about a
"RTN","GMRAOR2",4,0)
 ; particular patient allergy/adverse reaction.
"RTN","GMRAOR2",5,0)
 ; Input Variables
"RTN","GMRAOR2",6,0)
 ;       IEN = The internal entry number of the reaction in file 120.8
"RTN","GMRAOR2",7,0)
 ;     ARRAY = The array that the reaction data is to be passed back in.
"RTN","GMRAOR2",8,0)
 ;             (Note: The return array cannot be the GMRAL array.)
"RTN","GMRAOR2",9,0)
 Q:$G(IEN)=""
"RTN","GMRAOR2",10,0)
 S ARRAY=$S($G(ARRAY)'="":ARRAY,1:"GMRACT") Q:ARRAY="GMRAL"
"RTN","GMRAOR2",11,0)
 N GMRAPA,GMRAOTH,GMRAL,GMRAI
"RTN","GMRAOR2",12,0)
 S GMRAPA=IEN,GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAOR2",13,0)
 ; Set up GMRAL variable
"RTN","GMRAOR2",14,0)
 S GMRAL=$P(GMRAPA(0),U,2)_U
"RTN","GMRAOR2",15,0)
 S GMRAL=GMRAL_$S($P(GMRAPA(0),U,5)'="":$$GET1^DIQ(200,$P(GMRAPA(0),U,5)_",",".01"),1:"<None>")_U ;21
"RTN","GMRAOR2",16,0)
 S %=$S($P(GMRAPA(0),U,5)'="":$$GET1^DIQ(200,$P(GMRAPA(0),U,5)_",","8","I"),1:"") ;21
"RTN","GMRAOR2",17,0)
 S GMRAL=GMRAL_$S(%>1:$P($G(^DIC(3.1,%,0)),U),1:"")_U
"RTN","GMRAOR2",18,0)
 S GMRAL=GMRAL_$S($P(GMRAPA(0),U,16)=1:"",1:"NOT ")_"VERIFIED"_U
"RTN","GMRAOR2",19,0)
 S GMRAL=GMRAL_$S($P(GMRAPA(0),U,6)="o":"OBSERVED",$P(GMRAPA(0),U,6)="h":"HISTORICAL",1:"")_U
"RTN","GMRAOR2",20,0)
 S GMRAL=GMRAL_$S($P(GMRAPA(0),U,14)="A":"ALLERGY",$P(GMRAPA(0),U,14)="P":"PHARMACOLOGIC",$P(GMRAPA(0),U,14)="U":"UNKNOWN",1:"")_U
"RTN","GMRAOR2",21,0)
 S GMRAL=GMRAL_$$OUTTYPE^GMRAUTL($P(GMRAPA(0),U,20))_U_$S($P(GMRAPA(0),U,16)&('$P(GMRAPA(0),U,18)):"<auto-verified>",1:$$GET1^DIQ(200,$P(GMRAPA(0),U,18)_",",.01))_U_$P(GMRAPA(0),U,17) ;21
"RTN","GMRAOR2",22,0)
 S GMRAL=GMRAL_U_$$FMTE^XLFDT($P(GMRAPA(0),U,4)) ;21 add orig date/time
"RTN","GMRAOR2",23,0)
 ;Set up Comments in to GMRAL("C",
"RTN","GMRAOR2",24,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,26,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",25,0)
 .N GMRACOM
"RTN","GMRAOR2",26,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,26,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",27,0)
 .S GMRAL("C",%)=$P(GMRACOM,U)_U_$S($P(GMRACOM,U,3)="V":"VERIFIER",$P(GMRACOM,U,3)="O":"ORIGINATOR",1:"")_U_$$GET1^DIQ(200,$P(GMRACOM,U,2)_",",.01) ;21
"RTN","GMRAOR2",28,0)
 .M GMRAL("C",%)=^GMR(120.8,GMRAPA,26,GMRAI,2)
"RTN","GMRAOR2",29,0)
 .Q
"RTN","GMRAOR2",30,0)
 ;Observer information from file 120.85
"RTN","GMRAOR2",31,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.85,"C",GMRAPA,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",32,0)
 .N GMRACOM
"RTN","GMRAOR2",33,0)
 .S GMRACOM=$G(^GMR(120.85,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",34,0)
 .S GMRAL("O",%)=$P(GMRACOM,U)_U_$S($P(GMRACOM,U,14)=1:"MILD",$P(GMRACOM,U,14)=2:"MODERATE",$P(GMRACOM,U,14)=3:"SEVERE",1:"")
"RTN","GMRAOR2",35,0)
 .Q
"RTN","GMRAOR2",36,0)
 ;Signs/Symptoms
"RTN","GMRAOR2",37,0)
 S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR2",38,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,10,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",39,0)
 .N GMRAZ
"RTN","GMRAOR2",40,0)
 .S GMRAZ=$G(^GMR(120.8,GMRAPA,10,GMRAI,0)) Q:GMRAZ=""
"RTN","GMRAOR2",41,0)
 .S GMRAL("S",%)=$S(+GMRAZ'=GMRAOTH:$P($G(^GMRD(120.83,+GMRAZ,0)),U),1:$P(GMRAZ,U,2))_$S($P(GMRAZ,U,4)'="":" ("_$$FMTE^XLFDT($P(GMRAZ,U,4),2)_")",1:"") ;21
"RTN","GMRAOR2",42,0)
 .Q
"RTN","GMRAOR2",43,0)
 ;VA Drug Class
"RTN","GMRAOR2",44,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,3,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",45,0)
 .N GMRACOM
"RTN","GMRAOR2",46,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,3,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",47,0)
 .;S GMRAL("V",%)=$P($G(^PS(50.605,GMRACOM,0)),U,1,2)
"RTN","GMRAOR2",48,0)
 .S GMRAL("V",%)=$$CLP2CLDA^GMRAPENC(GMRACOM)
"RTN","GMRAOR2",49,0)
 .Q
"RTN","GMRAOR2",50,0)
 ;Drug Ingredients
"RTN","GMRAOR2",51,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,2,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",52,0)
 .N GMRACOM
"RTN","GMRAOR2",53,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,2,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",54,0)
 .;S GMRAL("I",%)=$P($G(^PS(50.416,GMRACOM,0)),U)
"RTN","GMRAOR2",55,0)
 .S GMRAL("I",%)=$$INP2INNA^GMRAPENC(GMRACOM)
"RTN","GMRAOR2",56,0)
 .Q
"RTN","GMRAOR2",57,0)
 M @ARRAY=GMRAL
"RTN","GMRAOR2",58,0)
 Q
"RTN","GMRAOR3")
0^7^B6735362^B5802670
"RTN","GMRAOR3",1,0)
GMRAOR3 ;HIRMFO/RM,WAA-ORDERABLE LIST UTILITIES ; 11/29/07 12:17pm
"RTN","GMRAOR3",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,41**;Mar 29, 1996;Build 8
"RTN","GMRAOR3",3,0)
 ;;THIS ROUTINE IS NO LONGER IN USE THUS THE REFERENCES TO PHARMACY
"RTN","GMRAOR3",4,0)
 ;;GLOBALS DO NOT NEED TO BE REMOVED
"RTN","GMRAOR3",5,0)
 ;;THIS ROUTINE MAY BE DELETED ON SOME FUTURE DATE
"RTN","GMRAOR3",6,0)
 ;
"RTN","GMRAOR3",7,0)
EN1(START,NUM,ARRAY) ; ENTRY POINT WHERE ALL VARIABLES ARE OPTIONAL.
"RTN","GMRAOR3",8,0)
 ;  START IS THE STARTING POINT OF LIST TO BE RETURNED, NUM IS
"RTN","GMRAOR3",9,0)
 ;  THE NUMBER OF ENTRIES FROM STARTING POINT TO INCLUDE IN LIST,
"RTN","GMRAOR3",10,0)
 ;  AND ARRAY IS THE ADDRESS OF THE ARRAY LIST IS TO BE RETURNED.
"RTN","GMRAOR3",11,0)
 ;
"RTN","GMRAOR3",12,0)
 K:$G(START)="" START ; Force list to start at "A" and skip num./punc.
"RTN","GMRAOR3",13,0)
 S START=$G(START,"A"),NUM=$G(NUM),ARRAY=$G(ARRAY,"GMRALST")
"RTN","GMRAOR3",14,0)
 K ^TMP($J,"GMRALST")
"RTN","GMRAOR3",15,0)
NODE ;Loop through each file in order of X-ref.
"RTN","GMRAOR3",16,0)
 ;
"RTN","GMRAOR3",17,0)
 ; Loop through GMR Allergies file.
"RTN","GMRAOR3",18,0)
 S GMRAST=START
"RTN","GMRAOR3",19,0)
 F GMRACNT=1:1 Q:NUM&(GMRACNT>NUM)  S GMRAST=$O(^GMRD(120.82,"B",GMRAST)) Q:GMRAST=""  S GMRAIEN=$O(^(GMRAST,"")) I GMRAIEN>0 D FILE("ALL",0)
"RTN","GMRAOR3",20,0)
 ;
"RTN","GMRAOR3",21,0)
 ; Loop through VA Drug Class file.
"RTN","GMRAOR3",22,0)
 ; THIS ROUTINE IS NOT IN USE THUS THE DIRECT PHARMACY READ DOES NOT
"RTN","GMRAOR3",23,0)
 ; NEED TO BE UPDATED
"RTN","GMRAOR3",24,0)
 S GMRAST=START
"RTN","GMRAOR3",25,0)
 F GMRACNT=1:1 Q:NUM&(GMRACNT>NUM)  S GMRAST=$O(^PS(50.605,"C",GMRAST)) Q:GMRAST=""  S GMRAIEN=$O(^(GMRAST,"")) I GMRAIEN>0 D FILE("PSC",0)
"RTN","GMRAOR3",26,0)
 ;
"RTN","GMRAOR3",27,0)
 ; Loop through NDF File (B X-ref)
"RTN","GMRAOR3",28,0)
 ; $$B^PSNAPIS returns NDF version dependent root of "B" x-ref
"RTN","GMRAOR3",29,0)
 ; THIS ROUTINE IS NOT IN USE THUS THE DIRECT PHARMACY READ DOES NOT
"RTN","GMRAOR3",30,0)
 ; NEED TO BE UPDATED
"RTN","GMRAOR3",31,0)
 S GMRAST=START
"RTN","GMRAOR3",32,0)
 F GMRACNT=1:1 Q:NUM&(GMRACNT>NUM)  S GMRAST=$O(@($$B^PSNAPIS)@(GMRAST)) Q:GMRAST=""  S GMRAIEN=$O(^(GMRAST,"")) I GMRAIEN>0 D FILE("NDF",0)
"RTN","GMRAOR3",33,0)
 ;
"RTN","GMRAOR3",34,0)
 ; Loop through NDF file (T X-ref)
"RTN","GMRAOR3",35,0)
 ; $$T^PSNAPIS returns NDF version dependent root of "T" x-ref
"RTN","GMRAOR3",36,0)
 ; THIS ROUTINE IS NOT IN USE THUS THE DIRECT PHARMACY READ DOES NOT
"RTN","GMRAOR3",37,0)
 ; NEED TO BE UPDATED
"RTN","GMRAOR3",38,0)
 S GMRAST=START K ^TMP($J,"GMRAT")
"RTN","GMRAOR3",39,0)
 F GMRACNT=1:1 Q:NUM&(GMRACNT>NUM)  S GMRAST=$O(@($$T^PSNAPIS)@(GMRAST))  Q:GMRAST=""  S GMRAIEN=$$TGTOG^PSNAPIS(GMRAST) I GMRAIEN>0 D FILE("NDF",1)
"RTN","GMRAOR3",40,0)
 ; Set the return array.
"RTN","GMRAOR3",41,0)
 S GMRACNT=1,GMRAST="" F  S GMRAST=$O(^TMP($J,"GMRALST",GMRAST)) Q:GMRAST=""  D  I NUM'="" Q:GMRACNT>NUM
"RTN","GMRAOR3",42,0)
 .S @ARRAY@(GMRACNT)=^TMP($J,"GMRALST",GMRAST),GMRACNT=GMRACNT+1
"RTN","GMRAOR3",43,0)
 .Q
"RTN","GMRAOR3",44,0)
 K ^TMP($J,"GMRALST"),^TMP($J,"GMRAT"),GMRACNT,GMRAIEN,GMRAST
"RTN","GMRAOR3",45,0)
 Q
"RTN","GMRAOR3",46,0)
FILE(GMRATAB,GMRAT) ;File away a found entry
"RTN","GMRAOR3",47,0)
 ;    GMRATAB is the table entry in from OE3 HL7 spec.
"RTN","GMRAOR3",48,0)
 ;    GMRAT is (0/1) indicating whether to check for dups of same entry.
"RTN","GMRAOR3",49,0)
 ;
"RTN","GMRAOR3",50,0)
 I GMRAT Q:$D(^TMP($J,"GMRAT",GMRAIEN))  S ^(GMRAIEN)=""
"RTN","GMRAOR3",51,0)
 I '$D(^TMP($J,"GMRALST",GMRAST)) S ^(GMRAST)=GMRAIEN_U_GMRAST_U_"99"_GMRATAB
"RTN","GMRAOR3",52,0)
 K GMRAT,GMRATAB
"RTN","GMRAOR3",53,0)
 Q
"RTN","GMRAOR9")
0^8^B4659395^B5707065
"RTN","GMRAOR9",1,0)
GMRAOR9 ;HIRMFO/RM,WAA,FPT-Stuff Drug Ingredients/Classes ; 1/9/08 5:18am
"RTN","GMRAOR9",2,0)
 ;;4.0;Adverse Reaction Tracking;**4,13,41**;Mar 29, 1996;Build 8
"RTN","GMRAOR9",3,0)
 ; <Copied from GMRAPES1>
"RTN","GMRAOR9",4,0)
EN1 ; Auto stuff Ingredients and VA Drug Classes
"RTN","GMRAOR9",5,0)
 ; GMRAING() will have all the ingredients for the reaction
"RTN","GMRAOR9",6,0)
 ; GMRADRCL() will have all the drug classes for the reaction.
"RTN","GMRAOR9",7,0)
 ;
"RTN","GMRAOR9",8,0)
 K GMRADRCL,GMRAING
"RTN","GMRAOR9",9,0)
 ; If the Reactant is a Drug Ingredient
"RTN","GMRAOR9",10,0)
 I GMRAAR[50.416 S GMRAING(+GMRAAR)="" G STING
"RTN","GMRAOR9",11,0)
 ;If the Reactant is a Drug Class
"RTN","GMRAOR9",12,0)
 I GMRAAR[50.605 S GMRADRCL(+GMRAAR)=""
"RTN","GMRAOR9",13,0)
 ;If the Reactant is an entry in the GMR ALLERGY file
"RTN","GMRAOR9",14,0)
 I GMRAAR[120.82 D
"RTN","GMRAOR9",15,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"ING",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"ING",Y,0)),+^(0)>0 S GMRAING(+^(0))=""
"RTN","GMRAOR9",16,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"CLASS",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"CLASS",Y,0)),+^(0)>0 S GMRADRCL(+^(0))=""
"RTN","GMRAOR9",17,0)
 .Q
"RTN","GMRAOR9",18,0)
 ;I GMRAAR["PSDRUG" D
"RTN","GMRAOR9",19,0)
 ;.N PSODA
"RTN","GMRAOR9",20,0)
 ;.S PSODA=+GMRAAR K ^TMP("PSO",$J) D ^PSONGR F Y=0:0 S Y=$O(^TMP("PSO",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAOR9",21,0)
 ;.N GMRAX,GMRAY
"RTN","GMRAOR9",22,0)
 ;.;S GMRAX=$P($G(^PSDRUG(+GMRAAR,"ND")),U,6) S:GMRAX>0 GMRADRCL(GMRAX)="" Q
"RTN","GMRAOR9",23,0)
 ;.S GMRAX=$$DRP2CLP^GMRAPENC(GMRAAR) S:GMRAX>0 GMRADRCL(GMRAX)="" Q
"RTN","GMRAOR9",24,0)
 ;.;S GMRAX=$P($G(^PSDRUG(+GMRAAR,0)),U,2) Q:GMRAX=""
"RTN","GMRAOR9",25,0)
 ;.S GMRAX=$$DRP2CODE^GMRAPENC(GMRAAR) Q:GMRAX=""
"RTN","GMRAOR9",26,0)
 ;.;S GMRAY=$O(^PS(50.605,"B",GMRAX,"")) S:GMRAY>0 GMRADRCL(GMRAY)=""
"RTN","GMRAOR9",27,0)
 ;.S GMRAY=$$CODE2CLP^GMRAPENC(GMRAX) S:GMRAY>0 GMRADRCL(GMRAY)=""
"RTN","GMRAOR9",28,0)
 ;.Q
"RTN","GMRAOR9",29,0)
 I GMRAAR["PSNDF" D
"RTN","GMRAOR9",30,0)
 .N PSNDA
"RTN","GMRAOR9",31,0)
 .S PSNDA=+GMRAAR K ^TMP("PSN",$J) D ^PSNNGR F Y=0:0 S Y=$O(^TMP("PSN",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAOR9",32,0)
 .; all classes for NDF entry returned in GMRADRCL
"RTN","GMRAOR9",33,0)
 .N CLASS
"RTN","GMRAOR9",34,0)
 .S CLASS=$$CLIST^PSNAPIS(+GMRAAR,.GMRADRCL)
"RTN","GMRAOR9",35,0)
 K ^TMP("PSO",$J),^TMP("PSN",$J),PSODA,PSNID
"RTN","GMRAOR9",36,0)
STING ;Stuffing Drug Ing & VA Drug Classes into file 120.8
"RTN","GMRAOR9",37,0)
 I $D(GMRAING) D
"RTN","GMRAOR9",38,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",2,",DLAYGO=120.8,DIC(0)="L",DIC("P")="120.802PA"
"RTN","GMRAOR9",39,0)
 .F X=0:0 S X=$O(GMRAING(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,2,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAOR9",40,0)
 .K DIC,DLAYGO
"RTN","GMRAOR9",41,0)
 .Q
"RTN","GMRAOR9",42,0)
 I $D(GMRADRCL) D
"RTN","GMRAOR9",43,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",3,",DIC(0)="L",DIC("P")="120.803PA"
"RTN","GMRAOR9",44,0)
 .F X=0:0 S X=$O(GMRADRCL(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,3,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAOR9",45,0)
 .K DIC
"RTN","GMRAOR9",46,0)
 .Q
"RTN","GMRAOR9",47,0)
 K GMRADRCL,GMRAING
"RTN","GMRAOR9",48,0)
 Q
"RTN","GMRAPED0")
0^9^B21403018^B22812955
"RTN","GMRAPED0",1,0)
GMRAPED0 ;HIRMFO/RM,WAA-VERIFIER EDIT OF DRUG A/AR ;11/16/07  10:03
"RTN","GMRAPED0",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,41**;Mar 29, 1996;Build 8
"RTN","GMRAPED0",3,0)
 ;DBIA Section
"RTN","GMRAPED0",4,0)
 ;PSN50P41 - 4531
"RTN","GMRAPED0",5,0)
 ;PSN50P65 - 4543
"RTN","GMRAPED0",6,0)
 ;DICN     - 10009
"RTN","GMRAPED0",7,0)
 ;DIE      - 10018
"RTN","GMRAPED0",8,0)
 ;XLFDT    - 10103
"RTN","GMRAPED0",9,0)
EN1 ; ENTRY TO EDIT INFO SPECIFIC TO DRUG A/AR FOR VERIFIER
"RTN","GMRAPED0",10,0)
 K GMRAINGR,GMRACLAS,^TMP($J,"GMRAING"),^TMP($J,"GMRADCL") ;41 Add ^TMP to list
"RTN","GMRAPED0",11,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) G Q1
"RTN","GMRAPED0",12,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) G:GMRAPA(0)="" Q1
"RTN","GMRAPED0",13,0)
 F GMRAINGR=0:0 S GMRAINGR=$O(^GMR(120.8,GMRAPA,2,GMRAINGR)) Q:GMRAINGR'>0  D  ;41 Added block structure
"RTN","GMRAPED0",14,0)
 .S X=$S($D(^GMR(120.8,GMRAPA,2,GMRAINGR,0)):^(0),1:"") I +X>0 D ZERO^PSN50P41(+X,,$$DT^XLFDT,"GMRAING") S Y=$S($D(^TMP($J,"GMRAING",+X,.01)):^(.01),1:"") I $P(Y,U)'="" S GMRAINGR($P(Y,U),+X)=Y ;41 added call to ZERO
"RTN","GMRAPED0",15,0)
 F GMRACLAS=0:0 S GMRACLAS=$O(^GMR(120.8,GMRAPA,3,GMRACLAS)) Q:GMRACLAS'>0  D  ;41 Added dot structure
"RTN","GMRAPED0",16,0)
 .S X=$S($D(^GMR(120.8,GMRAPA,3,GMRACLAS,0)):^(0),1:"") I +X>0 D C^PSN50P65(+X,,"GMRADCL") S Y=$S($D(^TMP($J,"GMRADCL",+X,.01)):^(.01)_U_$G(^(1)),1:"") I $P(Y,U)'="" S GMRACLAS($P(Y,U),+X)=Y ;41 Added call to C^PSN50P65
"RTN","GMRAPED0",17,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPED0",18,0)
 W @IOF
"RTN","GMRAPED0",19,0)
 W !,"CAUSATIVE AGENT: ",$P(GMRAPA(0),U,2)
"RTN","GMRAPED0",20,0)
 W !?11,"TYPE: ",$$OUTTYPE^GMRAUTL($P(GMRAPA(0),U,20))
"RTN","GMRAPED0",21,0)
 W !?4,"INGREDIENTS: " S Y="",GMRAPRSW=0 F  S Y=$O(GMRAINGR(Y)) Q:Y=""  F X=0:0 S X=$O(GMRAINGR(Y,X)) Q:X'>0  W:GMRAPRSW ! W ?17,Y S:'GMRAPRSW GMRAPRSW=1
"RTN","GMRAPED0",22,0)
 W !,"VA DRUG CLASSES: "
"RTN","GMRAPED0",23,0)
 S Y="",GMRAPRSW=0 F  S Y=$O(GMRACLAS(Y)) Q:Y=""  F X=0:0 S X=$O(GMRACLAS(Y,X)) Q:X'>0  W:GMRAPRSW ! W ?17,Y," - ",$P(GMRACLAS(Y,X),U,2) S:'GMRAPRSW GMRAPRSW=1
"RTN","GMRAPED0",24,0)
 W !,"       OBS/HIST: ",$S($P(GMRAPA(0),U,6)="o":"OBSERVED",$P(GMRAPA(0),U,6)="h":"HISTORICAL",1:"")
"RTN","GMRAPED0",25,0)
 D  ;Sign/Symptoms
"RTN","GMRAPED0",26,0)
 .N GMRAVFY
"RTN","GMRAPED0",27,0)
 .S GMRAVFY=1
"RTN","GMRAPED0",28,0)
 .D EN1^GMRADSP3
"RTN","GMRAPED0",29,0)
 .Q
"RTN","GMRAPED0",30,0)
 W !,"      MECHANISM: ",$S($P(GMRAPA(0),U,14)="A":"ALLERGY",$P(GMRAPA(0),U,14)="P":"PHARMACOLOGIC",$P(GMRAPA(0),U,14)="U":"UNKNOWN",1:"")
"RTN","GMRAPED0",31,0)
YNED W !!,"Would you like to edit any of this data" S %=0 D YN^DICN I '% W !?4,$C(7),"ANSWER YES IF YOU WISH TO CHANGE ANY OF THE DATA ABOVE, ELSE ANSWER NO." G YNED
"RTN","GMRAPED0",32,0)
 S:%=-1 GMRAOUT=1 G Q1:%=2!GMRAOUT
"RTN","GMRAPED0",33,0)
 D EN1^GMRAPED3 G:GMRAOUT Q1 I GMRAAR'="" S DIE="^GMR(120.8,",DA=GMRAPA,DR=".02////^S X=GMRAAR(0);1////^S X=GMRAAR"_$S($D(GMRAAR("O")):";3.1////"_GMRAAR("O"),1:"") D ^DIE
"RTN","GMRAPED0",34,0)
 S GMRAPA(0)=$G(^GMR(120.8,+GMRAPA,0))
"RTN","GMRAPED0",35,0)
 S GMRAEN=GMRAPA_";GMR(120.8," D INPTYPE^GMRAUTL(GMRAEN) G Q1:GMRAOUT
"RTN","GMRAPED0",36,0)
 S DA=GMRAPA,DIE="^GMR(120.8,",DR="2" D ^DIE S:$D(Y) GMRAOUT=1 G Q1:GMRAOUT
"RTN","GMRAPED0",37,0)
 S GMRAPA(0)=$G(^GMR(120.8,+GMRAPA,0))
"RTN","GMRAPED0",38,0)
 D DRGCLS^GMRAPED1
"RTN","GMRAPED0",39,0)
 I 'GMRAOUT F  K Y D  Q:GMRAOUT!('$D(Y))
"RTN","GMRAPED0",40,0)
 .S GMRAPA(0)=$S($D(^GMR(120.8,GMRAPA,0)):^(0),1:"")
"RTN","GMRAPED0",41,0)
 .S DR="6(O)bserved or (H)istorical Allergy/Adverse Reaction",DIE="^GMR(120.8,",DA=GMRAPA D ^DIE
"RTN","GMRAPED0",42,0)
 .I $D(Y) S GMRAOUT=1 Q
"RTN","GMRAPED0",43,0)
 .S GMRANEW(0)=$S($D(^GMR(120.8,GMRAPA,0)):^(0),1:"")
"RTN","GMRAPED0",44,0)
 .I $P(GMRANEW(0),"^",6)="" W $C(7),"  Required??" S Y="" Q
"RTN","GMRAPED0",45,0)
 .Q:$P(GMRANEW(0),"^",6)=$P(GMRAPA(0),"^",6)
"RTN","GMRAPED0",46,0)
 .I $P(GMRAPA(0),"^",6)'=$P(GMRANEW(0),"^",6) D  Q
"RTN","GMRAPED0",47,0)
 ..W !!,"You cannot change the type of reaction.  If this is incorrect",!,"please exit and mark this entry as entered-in-error and then re-enter",!,"the correct information.",!
"RTN","GMRAPED0",48,0)
 ..S DIE="^GMR(120.8,",DR="6////"_$P(GMRAPA(0),"^",6),DA=GMRAPA D ^DIE S Y="" Q
"RTN","GMRAPED0",49,0)
 ..Q
"RTN","GMRAPED0",50,0)
 .Q
"RTN","GMRAPED0",51,0)
 I 'GMRAOUT D EN1^GMRAPER2(GMRAPA,"120.8",.GMRAOUT)
"RTN","GMRAPED0",52,0)
 I 'GMRAOUT D MECH Q:GMRAOUT
"RTN","GMRAPED0",53,0)
 S GMRAPA(0)=$S($D(^GMR(120.8,GMRAPA,0)):^(0),1:"")
"RTN","GMRAPED0",54,0)
 S GMRAOUT=0 G EN1
"RTN","GMRAPED0",55,0)
Q1 ;Exit
"RTN","GMRAPED0",56,0)
 K GMRAEN,X,GMRAAR,^TMP($J,"GMRAING"),^TMP($J,"GMRADCL") ;41 Added ^TMP
"RTN","GMRAPED0",57,0)
 K DA,DIE,DR
"RTN","GMRAPED0",58,0)
 Q
"RTN","GMRAPED0",59,0)
MECH ;Mechanism for ADRs
"RTN","GMRAPED0",60,0)
 F  W !!,?5,"Choose one of the following:",! D  Q:GMRAOUT!('$D(Y))
"RTN","GMRAPED0",61,0)
 .F GMRAMEC="A - ALLERGY","P - PHARMACOLOGICAL","U - UNKNOWN" W !,?20,GMRAMEC
"RTN","GMRAPED0",62,0)
 .W ! S DIE="^GMR(120.8,",DA=GMRAPA,DR=17 D ^DIE
"RTN","GMRAPED0",63,0)
 .S:$D(Y) GMRAOUT=1
"RTN","GMRAPED0",64,0)
 .Q
"RTN","GMRAPED0",65,0)
 Q
"RTN","GMRAPED0",66,0)
HELP ; HELP FOR A/AR LOOKUP
"RTN","GMRAPED0",67,0)
 D HELP^GMRAPED0 ;41 removed duplicate code and added call to HELP
"RTN","GMRAPED0",68,0)
 Q
"RTN","GMRAPED0",69,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPED0",70,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPED0",71,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPED0",72,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 S:%=2 Y=-1 I % W ! Q
"RTN","GMRAPED0",73,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPED0",74,0)
 G YNOK
"RTN","GMRAPED0",75,0)
HEAD ; Header for reactions
"RTN","GMRAPED0",76,0)
 W @IOF
"RTN","GMRAPED0",77,0)
 W !,"Reactions: (cont.) "
"RTN","GMRAPED0",78,0)
 Q
"RTN","GMRAPED1")
0^10^B6980916^B5650357
"RTN","GMRAPED1",1,0)
GMRAPED1 ;HIRMFO/RM-EDIT DRUG CLASS FIELD ;11/16/07  10:06
"RTN","GMRAPED1",2,0)
 ;;4.0;Adverse Reaction Tracking;**41**;Mar 29, 1996;Build 8
"RTN","GMRAPED1",3,0)
 ;DBIA Section
"RTN","GMRAPED1",4,0)
 ;PSN50P65 - 4543
"RTN","GMRAPED1",5,0)
 ;XLFDT    - 10103
"RTN","GMRAPED1",6,0)
 ;PSNDI    - 4554
"RTN","GMRAPED1",7,0)
 ;DIC      - 10006
"RTN","GMRAPED1",8,0)
 ;DIE      - 10018
"RTN","GMRAPED1",9,0)
DRGCLS ; EDIT VA DRUG CLASS MULTIPLE
"RTN","GMRAPED1",10,0)
 K ^TMP($J,"GMRACLASS") ;41 clean out before using
"RTN","GMRAPED1",11,0)
 S GMRAB=$S($D(^GMR(120.8,GMRAPA,3,0)):$P(^(0),"^",3),1:""),GMRAB=$S($D(^GMR(120.8,GMRAPA,3,+GMRAB,0)):+^(0),1:0) D C^PSN50P65(GMRAB,,"GMRACLASS") S GMRAB=$S($D(^TMP($J,"GMRACLASS",GMRAB,1)):$P(^(1),U),1:"") ;41 added C^PSN50P65
"RTN","GMRAPED1",12,0)
RDCLS W !,"Select VA DRUG CLASS: ",$S(GMRAB'="":GMRAB_"// ",1:"") R X:DTIME S:'$T X="^^" I "^^"[X S:X'="" GMRAOUT=1 Q
"RTN","GMRAPED1",13,0)
 I "@"[X W !,"YOU CAN NOT DELETE A VA DRUG CLASS.",$C(7)
"RTN","GMRAPED1",14,0)
 S:'$D(^GMR(120.8,GMRAPA,3,0)) ^(0)="^120.803PA^^" ;41 separated out command
"RTN","GMRAPED1",15,0)
 I X?1"?".E D  W ! ;41 List existing drug class for allergy, entire section added w/ patch 41
"RTN","GMRAPED1",16,0)
 .N SUB,IEN K ^TMP($J,"GMRACLASS")
"RTN","GMRAPED1",17,0)
 .I $O(^GMR(120.8,GMRAPA,3,0)) W !!?3,"Choose from:",!
"RTN","GMRAPED1",18,0)
 .S SUB=0 F  S SUB=$O(^GMR(120.8,GMRAPA,3,SUB)) Q:'+SUB  S IEN=^(SUB,0) D C^PSN50P65(IEN,,"GMRACLASS") W !,?3,$G(^TMP($J,"GMRACLASS",IEN,.01)),?$X+5,$G(^TMP($J,"GMRACLASS",IEN,1))
"RTN","GMRAPED1",19,0)
DGDIC S:X?1"?".E X="?" S DIC="^PS(50.605,",DIC(0)="EQMZ",DIC("W")="W ?$X+5,$P(^(0),U,2)" K DTOUT,DUOUT D DIC^PSNDI(50.605,"GMRA",.DIC,.X,,$$DT^XLFDT) K DIC I +Y'>0 G RDCLS ;41
"RTN","GMRAPED1",20,0)
 S DA(1)=GMRAPA,DA=$O(^GMR(120.8,GMRAPA,3,"B",+Y,0)) I DA'>0 D  S DA=+Y G:DA'>0 RDCLS
"RTN","GMRAPED1",21,0)
 .S DIC="^GMR(120.8,"_GMRAPA_",3,",DLAYGO=120.8,DIC(0)="EQL",X=$P(Y(0),"^") D ^DIC K DIC,DLAYGO
"RTN","GMRAPED1",22,0)
 .Q
"RTN","GMRAPED1",23,0)
EDDC S DIE="^GMR(120.8,"_GMRAPA_",3,",DR=".01  VA DRUG CLASS" D ^DIE S:$D(Y) GMRAOUT=1 S GMRAB=""
"RTN","GMRAPED1",24,0)
 Q:GMRAOUT  G RDCLS
"RTN","GMRAPENC")
0^19^B4933029^n/a
"RTN","GMRAPENC",1,0)
GMRAPENC ;SLC/JMH - Pharmacy API calls ;1/7/08  09:38
"RTN","GMRAPENC",2,0)
 ;;4.0;Adverse Reaction Tracking;**41**;Mar 29, 1996;Build 8
"RTN","GMRAPENC",3,0)
 ;
"RTN","GMRAPENC",4,0)
 ;$$DRP2CLP^GMRAPENC(50 IEN) => 50.605 IEN
"RTN","GMRAPENC",5,0)
 ;$$CODE2CLP^GMRAPENC(DRUG CLASS CODE) => 50.605 IEN
"RTN","GMRAPENC",6,0)
 ;$$CODE2CL^GMRAPENC(DRUG CLASS CODE) => 50.605 CLASS NAME
"RTN","GMRAPENC",7,0)
 ;$$DRP2CODE^GMRAPENC(50 IEN) => 50.605 CLASS CODE
"RTN","GMRAPENC",8,0)
 ;$$CLP2CODE^GMRAPENC(50.605 IEN) => 50.605 CLASS CODE
"RTN","GMRAPENC",9,0)
 ;$$CLP2CLDA^GMRAPENC(50.605 IEN) => 50.605 CLASS CODE ^ 50.605 CLASSIFICATION
"RTN","GMRAPENC",10,0)
 ;$$INP2INNA^GMRAPENC(50.416 IEN) => 50.416 INGREDIENT NAME
"RTN","GMRAPENC",11,0)
 ;
"RTN","GMRAPENC",12,0)
DRP2CLP(GMRAIEN) ;
"RTN","GMRAPENC",13,0)
 ;GMRAIEN = FILE 50 POINTER
"RTN","GMRAPENC",14,0)
 ;RETURN = FILE 50.605 POINTER
"RTN","GMRAPENC",15,0)
 N GMRARET
"RTN","GMRAPENC",16,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",17,0)
 D DATA^PSS50(GMRAIEN,,,,,"GMRADATA")
"RTN","GMRAPENC",18,0)
 S GMRARET=+$G(^TMP($J,"GMRADATA",GMRAIEN,25))
"RTN","GMRAPENC",19,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",20,0)
 Q GMRARET
"RTN","GMRAPENC",21,0)
CODE2CLP(GMRACODE) ;
"RTN","GMRAPENC",22,0)
 ;GMRACODE = DRUG CLASS CODE
"RTN","GMRAPENC",23,0)
 ;RETURN = FILE 50.605 POINTER
"RTN","GMRAPENC",24,0)
 N GMRARET
"RTN","GMRAPENC",25,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",26,0)
 D IEN^PSN50P65(,GMRACODE,"GMRADATA")
"RTN","GMRAPENC",27,0)
 S GMRARET=$O(^TMP($J,"GMRADATA","B",GMRACODE,""))
"RTN","GMRAPENC",28,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",29,0)
 Q GMRARET
"RTN","GMRAPENC",30,0)
CODE2CL(GMRACODE) ;
"RTN","GMRAPENC",31,0)
 ;GMRACODE = DRUG CLASS CODE
"RTN","GMRAPENC",32,0)
 ;RETURN = DRUG CLASS NAME
"RTN","GMRAPENC",33,0)
 N GMRARET
"RTN","GMRAPENC",34,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",35,0)
 D IEN^PSN50P65(,GMRACODE,"GMRADATA")
"RTN","GMRAPENC",36,0)
 S GMRARET=$O(^TMP($J,"GMRADATA","B",GMRACODE,""))
"RTN","GMRAPENC",37,0)
 I GMRARET S GMRARET=$G(^TMP($J,"GMRADATA",GMRARET,1))
"RTN","GMRAPENC",38,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",39,0)
 Q GMRARET
"RTN","GMRAPENC",40,0)
DRP2CODE(GMRAIEN) ;
"RTN","GMRAPENC",41,0)
 ;GMRAIEN = FILE 50 POINTER
"RTN","GMRAPENC",42,0)
 ;RETURN = DRUG CLASS CODE
"RTN","GMRAPENC",43,0)
 N GMRARET
"RTN","GMRAPENC",44,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",45,0)
 D DATA^PSS50(GMRAIEN,,,,,"GMRADATA")
"RTN","GMRAPENC",46,0)
 S GMRARET=$P($G(^TMP($J,"GMRADATA",GMRAIEN,25)),U,2)
"RTN","GMRAPENC",47,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",48,0)
 Q GMRARET
"RTN","GMRAPENC",49,0)
CLP2CODE(GMRAIEN) ;
"RTN","GMRAPENC",50,0)
 ;GMRAIEN = FILE 50.605 POINTER
"RTN","GMRAPENC",51,0)
 ;RETURN = DRUG CLASS CODE
"RTN","GMRAPENC",52,0)
 N GMRARET
"RTN","GMRAPENC",53,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",54,0)
 D C^PSN50P65(GMRAIEN,,"GMRADATA")
"RTN","GMRAPENC",55,0)
 S GMRARET=$G(^TMP($J,"GMRADATA",GMRAIEN,.01))
"RTN","GMRAPENC",56,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",57,0)
 Q GMRARET
"RTN","GMRAPENC",58,0)
CLP2CLDA(GMRAIEN) ;
"RTN","GMRAPENC",59,0)
 ;GMRAIEN = FILE 50.605 POINTER
"RTN","GMRAPENC",60,0)
 ;RETURN = DRUG CLASS CODE^DRUG CLASS CLASSIFICATION
"RTN","GMRAPENC",61,0)
 N GMRARET
"RTN","GMRAPENC",62,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",63,0)
 D C^PSN50P65(GMRAIEN,,"GMRADATA")
"RTN","GMRAPENC",64,0)
 S GMRARET=$G(^TMP($J,"GMRADATA",GMRAIEN,.01))_U_$G(^TMP($J,"GMRADATA",GMRAIEN,1))
"RTN","GMRAPENC",65,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",66,0)
 Q GMRARET
"RTN","GMRAPENC",67,0)
INP2INNA(GMRAIEN) ;
"RTN","GMRAPENC",68,0)
 ;GMRAIEN = FILE 50.416 POINTER
"RTN","GMRAPENC",69,0)
 ;RETURN = DRUG INGREDIENT NAME
"RTN","GMRAPENC",70,0)
 N GMRARET
"RTN","GMRAPENC",71,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",72,0)
 D ZERO^PSN50P41(GMRAIEN,,,"GMRADATA")
"RTN","GMRAPENC",73,0)
 S GMRARET=$G(^TMP($J,"GMRADATA",GMRAIEN,.01))
"RTN","GMRAPENC",74,0)
 K ^TMP($J,"GMRADATA")
"RTN","GMRAPENC",75,0)
 Q GMRARET
"RTN","GMRAPES0")
0^11^B77518746^B74006536
"RTN","GMRAPES0",1,0)
GMRAPES0 ;HIRMFO/RM-SELECT PATIENT ALLERGY TO EDIT ;11/16/07  10:26
"RTN","GMRAPES0",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,17,19,21,23,20,41**;Mar 29, 1996;Build 8
"RTN","GMRAPES0",3,0)
 ;DBIA Section
"RTN","GMRAPES0",4,0)
 ;PSN5067 - 4829
"RTN","GMRAPES0",5,0)
 ;DIC     - 10006
"RTN","GMRAPES0",6,0)
 ;DICN    - 10009
"RTN","GMRAPES0",7,0)
 ;DIQ     - 2056
"RTN","GMRAPES0",8,0)
 ;DIR     - 10026
"RTN","GMRAPES0",9,0)
 ;DIWE    - 10028
"RTN","GMRAPES0",10,0)
 ;PSNAPIS - 2574
"RTN","GMRAPES0",11,0)
 ;PSNDI   - 4554
"RTN","GMRAPES0",12,0)
 ;XLFDT   - 10103
"RTN","GMRAPES0",13,0)
 ;XLFSTR  - 10104
"RTN","GMRAPES0",14,0)
 ;XMD     - 10070
"RTN","GMRAPES0",15,0)
 ;XTID    - 4631
"RTN","GMRAPES0",16,0)
EN1 ; GIVEN DFN, SELECT PATIENT ALLERGY
"RTN","GMRAPES0",17,0)
 N GMRAGOUT,ROOT,CNT,LST,NAM,DIR,GMRAET
"RTN","GMRAPES0",18,0)
 S GMRARET=0
"RTN","GMRAPES0",19,0)
 S GMRAPA=-1,GMRANEW=0 R !!,"Enter Causative Agent: ",GMRALAR:DTIME S:'$T GMRALAR="^^" S:GMRALAR="" GMRARET=1 I "^^"[GMRALAR S GMRAOUT='$L(GMRALAR)+1 G Q1
"RTN","GMRAPES0",20,0)
 I GMRALAR?1P.E!($L(GMRALAR)<3)!($L(GMRALAR)>30) S GMRAHLP=1 D EN1^GMRAHLP0 G EN1:'GMRAOUT,Q1
"RTN","GMRAPES0",21,0)
 I GMRALAR?.E1L.E S GMRALAR=$$UP^XLFSTR(GMRALAR)
"RTN","GMRAPES0",22,0)
PAL K Y,DTOUT,DUOUT S DGSENFLG="",DIC="^GMR(120.8,",DIC(0)="SEZ",X=GMRANAM,DIC("S")="I '+$G(^(""ER"")),$P(^(0),U,2)?@(""1""""""_GMRALAR_"""""".E""),$D(^GMR(120.8,""B"",DFN,+Y))",DIC("W")="W $P(^(0),U,2)"
"RTN","GMRAPES0",23,0)
 W !!,"Checking existing PATIENT ALLERGIES (#120.8) file for matches...",!
"RTN","GMRAPES0",24,0)
 D ^DIC S X=$P($G(Y(0)),"^",2) K DIC,DGSENFLG,DTOUT,DUOUT D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",25,0)
 S:+Y>0 GMRAPA=+Y G Q1:+Y>0!GMRAOUT,PAL:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",26,0)
 G Q1:'GMRALAGO
"RTN","GMRAPES0",27,0)
NPA W !!,"Now checking GMR ALLERGIES (#120.82) file for matches...",!
"RTN","GMRAPES0",28,0)
 S DIC("S")="I $P(^(0),U)'=""OTHER ALLERGY/ADVERSE REACTION""&($S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.82,.01,Y_"",""),1:1))" ;21,23
"RTN","GMRAPES0",29,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 X=$P(Y,"^",2) D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",30,0)
 I +Y>0 S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",31,0)
 G Q1:GMRAOUT,NPA:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",32,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAPES0",33,0)
 K Y,DTOUT,DUOUT
"RTN","GMRAPES0",34,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAPES0",35,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,Y_"",""),1:1)" D DIC^PSNDI(50.6,"GMRA",.DIC,.X,,$$DT^XLFDT) K DIC D DIC ;23,41
"RTN","GMRAPES0",36,0)
 I +Y>0 S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",37,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAPES0",38,0)
 K DUOUT,DTOUT,Y
"RTN","GMRAPES0",39,0)
 S ROOT="^TMP($J,""GMRASEL"",""B"")",CNT=0,X=GMRALAR ;41
"RTN","GMRAPES0",40,0)
 D ALL^PSN5067(,X,$$DT^XLFDT,"GMRASEL") ;41
"RTN","GMRAPES0",41,0)
 I $D(@ROOT@(X)),$S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(X)_","),1:1) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;23 Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAPES0",42,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",43,0)
 .Q:$S($L($T(SCREEN^XTID)):$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(NAM)_","),1:0)  ;23
"RTN","GMRAPES0",44,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAPES0",45,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",46,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",47,0)
 I CNT>1 D
"RTN","GMRAPES0",48,0)
 .D MATCHES
"RTN","GMRAPES0",49,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",50,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",51,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",52,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT=1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",53,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",54,0)
 ;Selection from file 50 removed in patch 23 and code actually removed in 41
"RTN","GMRAPES0",55,0)
 ;19 - Moved ING and CLASS code here
"RTN","GMRAPES0",56,0)
ING W !!,"Now checking the INGREDIENTS (#50.416) file for matches...",!
"RTN","GMRAPES0",57,0)
 K Y,DTOUT,DUOUT S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.416,.01,Y_"",""),1:1)",X=GMRALAR D IX^PSNDI(50.416,"GMRA",.DIC,D,.X,,$$DT^XLFDT) K DIC D DIC ;41
"RTN","GMRAPES0",58,0)
 I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1 ;41
"RTN","GMRAPES0",59,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",60,0)
 G Q1:GMRAOUT,ING:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",61,0)
CLASS W !!,"Now checking VA DRUG CLASS (50.605) file for matches...",!
"RTN","GMRAPES0",62,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.605,.01,Y_"",""),1:1)" D IX^PSNDI(50.605,"GMRA",.DIC,D,.X,,$$DT^XLFDT) K DIC D DIC ;41
"RTN","GMRAPES0",63,0)
 I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1 ;41
"RTN","GMRAPES0",64,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",65,0)
 G Q1:GMRAOUT,CLASS:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",66,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files."
"RTN","GMRAPES0",67,0)
 W !!,"Before sending an email requesting the addition of a new reactant, please",!,"try entering the first 3 or 4 letters of the reactant to search for",!,"the desired entry.",!
"RTN","GMRAPES0",68,0)
 W !,"Would you like to send an email requesting ",GMRALAR,!,"be added as a causative agent?"
"RTN","GMRAPES0",69,0)
 S DIR("A")="Send email"
"RTN","GMRAPES0",70,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("?")="^D MESS^GMRAPES0"
"RTN","GMRAPES0",71,0)
 D ^DIR
"RTN","GMRAPES0",72,0)
 I Y'=+Y S GMRAOUT=1 G Q1
"RTN","GMRAPES0",73,0)
 I '+Y G EN1
"RTN","GMRAPES0",74,0)
YNDRG ;
"RTN","GMRAPES0",75,0)
 D GETINPUT(.GMRAET)
"RTN","GMRAPES0",76,0)
 S X=$$SENDREQ(DUZ,DFN,GMRALAR,.GMRAET)
"RTN","GMRAPES0",77,0)
 I '+X W !!,"Error - Message not sent - ",$P(X,U,2)
"RTN","GMRAPES0",78,0)
 I +X W !!,"Message sent - NOTE: This reactant was NOT added for this patient."
"RTN","GMRAPES0",79,0)
 W !
"RTN","GMRAPES0",80,0)
Q1 ;
"RTN","GMRAPES0",81,0)
 S:GMRAPA>0 GMRAPA(0)=$S($D(^GMR(120.8,+GMRAPA,0)):^(0),1:"")
"RTN","GMRAPES0",82,0)
 K %,D,DA,DIC,DTOUT,DUOUT,GMRAAR,GMRAHLP,GMRAING,GMRALAGO,GMRALAR,PSNDA,PSODA,X,Y
"RTN","GMRAPES0",83,0)
 Q
"RTN","GMRAPES0",84,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPES0",85,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPES0",86,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPES0",87,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 Q:GMRAOUT  S:%=2 Y=-1 Q:Y=-1  S:$$DUPCHK(X,DFN,Y) Y=-1 Q:GMRAOUT  I % W ! Q  ;19
"RTN","GMRAPES0",88,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPES0",89,0)
 G YNOK
"RTN","GMRAPES0",90,0)
DUPCHK(X,Y,Z) ;CHECK FOR ENTERED IN ERROR
"RTN","GMRAPES0",91,0)
 N GMRAPA,GMRAGOUT,%,%Y S GMRAGOUT=0
"RTN","GMRAPES0",92,0)
 I $P($G(^GMR(120.8,+Z,0)),U,2)=X Q GMRAGOUT
"RTN","GMRAPES0",93,0)
 I $O(^GMR(120.8,"B",Y,0)) S GMRAPA=0 F  S GMRAPA=$O(^GMR(120.8,"B",Y,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAOUT!(GMRAGOUT)
"RTN","GMRAPES0",94,0)
 .I $P(^GMR(120.8,GMRAPA,0),U,2)'=X Q
"RTN","GMRAPES0",95,0)
 .I $D(^GMR(120.8,GMRAPA,"ER")) D
"RTN","GMRAPES0",96,0)
 ..F  S %=2 W !,?5,$C(7),"This Agent has been Entered in Error once before.",!,?5,"Are you sure you want to select this Agent again" D  Q:%
"RTN","GMRAPES0",97,0)
 ...D YN^DICN S:%'=1 %=2,GMRAOUT=1  S:%Y?2"^" GMRAOUT=2
"RTN","GMRAPES0",98,0)
 ...Q:%  W !,?10,"ENTER 'Y' FOR YES OR 'N' FOR NO"
"RTN","GMRAPES0",99,0)
 ...Q
"RTN","GMRAPES0",100,0)
 ..S GMRAGOUT=%
"RTN","GMRAPES0",101,0)
 ..Q
"RTN","GMRAPES0",102,0)
 .Q
"RTN","GMRAPES0",103,0)
 I GMRAGOUT=0 S GMRAGOUT=1
"RTN","GMRAPES0",104,0)
 Q (GMRAGOUT-1)
"RTN","GMRAPES0",105,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAPES0",106,0)
 N I,J,QUIT
"RTN","GMRAPES0",107,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAPES0",108,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAPES0",109,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAPES0",110,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAPES0",111,0)
 Q
"RTN","GMRAPES0",112,0)
 ;
"RTN","GMRAPES0",113,0)
MORE()  ; -- show more matches
"RTN","GMRAPES0",114,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAPES0",115,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAPES0",116,0)
 D ^DIR
"RTN","GMRAPES0",117,0)
 Q +Y
"RTN","GMRAPES0",118,0)
 ;
"RTN","GMRAPES0",119,0)
SENDREQ(USER,PAT,TEXT,GMRAET) ;Send email to GMRA REQUEST NEW REACTANT indicating user's request for a new allergy
"RTN","GMRAPES0",120,0)
 ;Returns 0^reason for error
"RTN","GMRAPES0",121,0)
 ;        1 if successful
"RTN","GMRAPES0",122,0)
 N XMDUZ,XMY,XMSUB,GMRATXT,XMTEXT,XMZ,XMMG,GMRAUI,GMRAPI,GMRAUS,GMRAPS,CNT,J
"RTN","GMRAPES0",123,0)
 Q:'$G(USER)!('+$G(DUZ))!('$L(TEXT)) "0^Required information missing"
"RTN","GMRAPES0",124,0)
 S XMDUZ="Allergy Package",XMSUB="Request to add new reactant"
"RTN","GMRAPES0",125,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAPES0",126,0)
 S XMY(DUZ)="" ;Include requestor in message
"RTN","GMRAPES0",127,0)
 D GETS^DIQ(200,USER,".01;.132;.138;8","E","GMRAUI"),GETS^DIQ(2,PAT,".01;.09","IE","GMRAPI") S GMRAUS=USER_",",GMRAPS=PAT_","
"RTN","GMRAPES0",128,0)
 S CNT=1
"RTN","GMRAPES0",129,0)
 S GMRATXT(CNT)="A request to add "_TEXT_" as a new reactant was entered",CNT=CNT+1
"RTN","GMRAPES0",130,0)
 S GMRATXT(CNT)="by "_GMRAUI(200,GMRAUS,.01,"E")_" for patient "_GMRAPI(2,GMRAPS,.01,"E")_" ("_$E(GMRAPI(2,GMRAPS,.09,"I"),6,9)_")",CNT=CNT+1
"RTN","GMRAPES0",131,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",132,0)
 S GMRATXT(CNT)="User's contact information:",CNT=CNT+1
"RTN","GMRAPES0",133,0)
 S GMRATXT(CNT)="Title        : "_GMRAUI(200,GMRAUS,8,"E"),CNT=CNT+1
"RTN","GMRAPES0",134,0)
 S GMRATXT(CNT)="Office Phone : "_GMRAUI(200,GMRAUS,.132,"E"),CNT=CNT+1
"RTN","GMRAPES0",135,0)
 S GMRATXT(CNT)="Digital Pager: "_GMRAUI(200,GMRAUS,.138,"E"),CNT=CNT+1
"RTN","GMRAPES0",136,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",137,0)
 I $D(GMRAET) S GMRATXT(CNT)="The user added the following comment:",CNT=CNT+1,GMRATXT(CNT)="",CNT=CNT+1 F J=1:1:$P(GMRAET(0),U,3) S GMRATXT(CNT)=GMRAET(J,0),CNT=CNT+1 ;20 Added blank line following comment
"RTN","GMRAPES0",138,0)
 I $D(GMRAET) S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",139,0)
 S GMRATXT(CNT)="Please verify with the user the intended reactant and then take the",CNT=CNT+1
"RTN","GMRAPES0",140,0)
 S GMRATXT(CNT)="appropriate action.  Be sure to try alternate spellings, etc before",CNT=CNT+1
"RTN","GMRAPES0",141,0)
 S GMRATXT(CNT)="requesting new reactants through NTRT (New Term Rapid Turnaround).",CNT=CNT+1 ;23
"RTN","GMRAPES0",142,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",143,0)
 S GMRATXT(CNT)="Please note, an allergy to "_TEXT_" was NOT entered for this patient!",CNT=CNT+1 ;20
"RTN","GMRAPES0",144,0)
 S XMTEXT="GMRATXT("
"RTN","GMRAPES0",145,0)
 D ^XMD
"RTN","GMRAPES0",146,0)
 Q $S($D(XMMG):"0^Mail group GMRA REQUEST NEW REACTANT has no members - contact IRM",1:1)
"RTN","GMRAPES0",147,0)
 ;
"RTN","GMRAPES0",148,0)
MESS ;Provide help for sending email message
"RTN","GMRAPES0",149,0)
 W !,"Enter YES to send an email to the allergy coordinator(s) indicating that",!,"Reactant--> ",GMRALAR,!,"was not found when you were trying to add it for this patient.",!,"Enter NO to try entering the reactant again."
"RTN","GMRAPES0",150,0)
 Q
"RTN","GMRAPES0",151,0)
 ;
"RTN","GMRAPES0",152,0)
GETINPUT(GMRAET) ;Allow user to add comment to message
"RTN","GMRAPES0",153,0)
 N DIC,DWLW,DWPK,DIWEPSE
"RTN","GMRAPES0",154,0)
 S ^TMP($J,"TEXT",0)=""
"RTN","GMRAPES0",155,0)
 S DIC="^TMP($J,""TEXT"","
"RTN","GMRAPES0",156,0)
 S DWLW=70,DWPK=1,DIWEPSE=""
"RTN","GMRAPES0",157,0)
 W !!,"You may now add any comments you may have to the message that",!,"is going to be sent with the request to add this reactant."
"RTN","GMRAPES0",158,0)
 W !,"You may want to add things like sign/symptoms, observed or historical, etc",!,"that may be useful to the reviewer.",!
"RTN","GMRAPES0",159,0)
 D EN^DIWE
"RTN","GMRAPES0",160,0)
 I $O(^TMP($J,"TEXT",0)) M GMRAET=^TMP($J,"TEXT")
"RTN","GMRAPES0",161,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAPES0",162,0)
 Q
"RTN","GMRAPES1")
0^12^B8419094^B9930531
"RTN","GMRAPES1",1,0)
GMRAPES1 ;HIRMFO/RM,WAA-SELECT PATIENT ALLERGY TO EDIT ;10/1/07  10:42
"RTN","GMRAPES1",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,14,17,41**;Mar 29, 1996;Build 8
"RTN","GMRAPES1",3,0)
ADAR ; ADD A NEW A/AR FOR THIS PATIENT
"RTN","GMRAPES1",4,0)
 S GMRAPA="" F X=0:0 S X=$O(^GMR(120.8,"B",DFN,X)) Q:X'>0  I $S('$D(^GMR(120.8,X,0)):0,$P(^(0),"^",2)=GMRAAR(0):1,1:0),$S('$D(^("ER")):1,1:'+^("ER")) S GMRAPA=X Q
"RTN","GMRAPES1",5,0)
 Q:GMRAPA>0
"RTN","GMRAPES1",6,0)
 I $D(XRTL) D T0^%ZOSV ; START RT
"RTN","GMRAPES1",7,0)
 D NOW^%DTC
"RTN","GMRAPES1",8,0)
 S GMRAAR(1)=+$E(%,1,12),DIC="^GMR(120.8,",DIC(0)="LQ",DLAYGO=120.8
"RTN","GMRAPES1",9,0)
 S DIC("DR")=".02////"_GMRAAR(0)_";1////^S X=GMRAAR;4////"_GMRAAR(1)_";5////"_DUZ_";15///0;17///U;3.1////"_$S($G(GMRAAR("O"))'="":GMRAAR("O"),1:"O"),X=DFN
"RTN","GMRAPES1",10,0)
 K DD,DO D FILE^DICN
"RTN","GMRAPES1",11,0)
 K DIC,DLAYGO S GMRAPA=+Y,GMRANEW=Y>0
"RTN","GMRAPES1",12,0)
 ;S GMRACAUS="RADIOLOGICAL/CONTRAST MEDIA",GMRADRCL=$O(^PS(50.605,"B","DX100",0))_";PS(50.605," ;41 Code not needed
"RTN","GMRAPES1",13,0)
 K GMRAING,GMRADRCL ;41 Removed GMRACAUS and added GMRAING
"RTN","GMRAPES1",14,0)
 I GMRAPA'>0 D  Q  ;Entry is not added
"RTN","GMRAPES1",15,0)
 .   I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV ; STOP RT IF EXITING HERE
"RTN","GMRAPES1",16,0)
 .   Q
"RTN","GMRAPES1",17,0)
 ;
"RTN","GMRAPES1",18,0)
UPDATE ;Updates entry with drug ingredients and/or drug classes - this API added with patch 17
"RTN","GMRAPES1",19,0)
 ;Start of New code to support Drug Classes
"RTN","GMRAPES1",20,0)
 ;This code section will auto stuff Ings and VA Drug Classes
"RTN","GMRAPES1",21,0)
 ;GMRAING() will have all the Ing for the selected reaction
"RTN","GMRAPES1",22,0)
 ;GMRADRCL() will have all the drug classes for the selected
"RTN","GMRAPES1",23,0)
 ;reaction.
"RTN","GMRAPES1",24,0)
 ;If the Reactant is a Drug Ingrediant
"RTN","GMRAPES1",25,0)
 I GMRAAR[50.416 S GMRAING(+GMRAAR)="" G STING
"RTN","GMRAPES1",26,0)
 ;If the Reacant is a Drug Class
"RTN","GMRAPES1",27,0)
 I GMRAAR[50.605 S GMRADRCL(+GMRAAR)=""
"RTN","GMRAPES1",28,0)
 ;If the Reactant is a entry in the GMR ALLERGY file
"RTN","GMRAPES1",29,0)
 I GMRAAR[120.82 D
"RTN","GMRAPES1",30,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"ING",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"ING",Y,0)),+^(0)>0 S GMRAING(+^(0))=""
"RTN","GMRAPES1",31,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"CLASS",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"CLASS",Y,0)),+^(0)>0 S GMRADRCL(+^(0))=""
"RTN","GMRAPES1",32,0)
 .Q
"RTN","GMRAPES1",33,0)
 ;41 - Section related to PSDRUG no longer needed
"RTN","GMRAPES1",34,0)
 ;I GMRAAR["PSDRUG" D
"RTN","GMRAPES1",35,0)
 ;.N PSODA
"RTN","GMRAPES1",36,0)
 ;.S PSODA=+GMRAAR K ^TMP("PSO",$J) D ^PSONGR F Y=0:0 S Y=$O(^TMP("PSO",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAPES1",37,0)
 ;.N GMRAX,GMRAY
"RTN","GMRAPES1",38,0)
 ;.S GMRAX=$P($G(^PSDRUG(+GMRAAR,"ND")),U,6) S:GMRAX>0 GMRADRCL(GMRAX)="" Q
"RTN","GMRAPES1",39,0)
 ;.S GMRAX=$P($G(^PSDRUG(+GMRAAR,0)),U,2) Q:GMRAX=""
"RTN","GMRAPES1",40,0)
 ;.S GMRAY=$O(^PS(50.605,"B",GMRAX,"")) S:GMRAY>0 GMRADRCL(GMRAY)=""
"RTN","GMRAPES1",41,0)
 ;.Q
"RTN","GMRAPES1",42,0)
 I GMRAAR["PSNDF" D
"RTN","GMRAPES1",43,0)
 .N PSNDA
"RTN","GMRAPES1",44,0)
 .S PSNDA=+GMRAAR K ^TMP("PSN",$J) D ^PSNNGR F Y=0:0 S Y=$O(^TMP("PSN",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAPES1",45,0)
 .; all classes for NDF entry returned in GMRADRCL
"RTN","GMRAPES1",46,0)
 .N CLASS
"RTN","GMRAPES1",47,0)
 .S CLASS=$$CLIST^PSNAPIS(+GMRAAR,.GMRADRCL)
"RTN","GMRAPES1",48,0)
 .Q
"RTN","GMRAPES1",49,0)
 K ^TMP("PSN",$J),PSOID,PSNID ;41 - Removed K ^TMP("PSO",$J)
"RTN","GMRAPES1",50,0)
STING ;Stuffing Drug Ing & VA Drug Classes into file 120.8
"RTN","GMRAPES1",51,0)
 I $D(GMRAING) D
"RTN","GMRAPES1",52,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",2,",DLAYGO=120.8,DIC(0)="L",DIC("P")="120.802PA"
"RTN","GMRAPES1",53,0)
 .F X=0:0 S X=$O(GMRAING(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,2,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAPES1",54,0)
 .K DIC,DLAYGO
"RTN","GMRAPES1",55,0)
 .Q
"RTN","GMRAPES1",56,0)
 I $D(GMRADRCL) D
"RTN","GMRAPES1",57,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",3,",DIC(0)="L",DIC("P")="120.803PA"
"RTN","GMRAPES1",58,0)
 .F X=0:0 S X=$O(GMRADRCL(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,3,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAPES1",59,0)
 .K DIC
"RTN","GMRAPES1",60,0)
 .Q
"RTN","GMRAPES1",61,0)
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV ; STOP RT IF EXITING HERE
"RTN","GMRAPES1",62,0)
 K GMRADRCL,GMRAING
"RTN","GMRAPES1",63,0)
 Q
"RTN","GMRAPST4")
0^13^B14046350^B12376223
"RTN","GMRAPST4",1,0)
GMRAPST4 ;HIRMFO/WAA- PRINT FREQUENCY OF DIST OVR DT BY DC ;6/17/08  09:28
"RTN","GMRAPST4",2,0)
 ;;4.0;Adverse Reaction Tracking;**7,33,41**;Mar 29, 1996;Build 8
"RTN","GMRAPST4",3,0)
EN1 ; This routine will loop through the ADT entry point to get all
"RTN","GMRAPST4",4,0)
 ; the entries in that date range.
"RTN","GMRAPST4",5,0)
 N GMAEN,GMAST,GMRADATE,GMRADC0,GMRADCN,GMRADPDT,GMRATOT  ;41 Added NEW SAC
"RTN","GMRAPST4",6,0)
 S GMRAOUT=0
"RTN","GMRAPST4",7,0)
 W !,"Select an Observed date range for this report."
"RTN","GMRAPST4",8,0)
 D DT^GMRAPL G:GMRAOUT EXIT
"RTN","GMRAPST4",9,0)
 D PRINTER
"RTN","GMRAPST4",10,0)
EXIT ; Exit of program kill cleanup
"RTN","GMRAPST4",11,0)
 K ^TMP($J,"GMRAPST4")
"RTN","GMRAPST4",12,0)
 D KILL^XUSCLEAN
"RTN","GMRAPST4",13,0)
 Q
"RTN","GMRAPST4",14,0)
PRINTER ;Select printer
"RTN","GMRAPST4",15,0)
 W ! K GMRAZIS D DEV^GMRAUTL I POP W !,"PLEASE TRY LATER" S GMRAOUT=1 Q
"RTN","GMRAPST4",16,0)
 I $D(IO("Q")) D  Q
"RTN","GMRAPST4",17,0)
 . S ZTRTN="PRINT^GMRAPST4",(ZTSAVE("GMRAOUT"),ZTSAVE("GMAST"),ZTSAVE("GMAEN"))=""
"RTN","GMRAPST4",18,0)
 . S ZTDESC="Frequency Distribution of Drug Classes" D ^%ZTLOAD
"RTN","GMRAPST4",19,0)
 . W !!,$S($D(ZTSK):"Request queued...",1:"Request NOT queued please try Later.")
"RTN","GMRAPST4",20,0)
 . Q
"RTN","GMRAPST4",21,0)
 U IO D PRINT U IO(0)
"RTN","GMRAPST4",22,0)
 Q
"RTN","GMRAPST4",23,0)
PRINT ;Queue point for report
"RTN","GMRAPST4",24,0)
 ;loop through the 120.85 file and look for the field that 
"RTN","GMRAPST4",25,0)
 D NOW^%DTC S GMRADPDT=X
"RTN","GMRAPST4",26,0)
 S GMRADATE=GMAST-.0001,GMRAPG=1
"RTN","GMRAPST4",27,0)
 K ^TMP($J,"GMRAPST4")
"RTN","GMRAPST4",28,0)
 S GMRATOT=0
"RTN","GMRAPST4",29,0)
 F  S GMRADATE=$O(^GMR(120.85,"B",GMRADATE)) Q:GMRADATE<1  Q:GMRADATE>GMAEN  D
"RTN","GMRAPST4",30,0)
 .S GMRAPA1=0 F  S GMRAPA1=$O(^GMR(120.85,"B",GMRADATE,GMRAPA1)) Q:GMRAPA1<1  D
"RTN","GMRAPST4",31,0)
 ..S GMRAPA1(0)=$G(^GMR(120.85,GMRAPA1,0)) Q:GMRAPA1(0)=""  ;Bad Node
"RTN","GMRAPST4",32,0)
 ..Q:+$G(^GMR(120.8,$P(GMRAPA1(0),U,15),"ER"))  ;Entered in error data
"RTN","GMRAPST4",33,0)
 ..Q:'$$PRDTST^GMRAUTL1($P(GMRAPA1(0),U,2))  ;GMRA*4*33 Exclude test patient from report if production or legacy environment.
"RTN","GMRAPST4",34,0)
 ..S GMRAPA=$P(GMRAPA1(0),U,15) Q:'GMRAPA
"RTN","GMRAPST4",35,0)
 ..S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAPST4",36,0)
 ..S GMRADC=0
"RTN","GMRAPST4",37,0)
 ..F  S GMRADC=$O(^GMR(120.8,GMRAPA,3,GMRADC)) Q:GMRADC<1  D
"RTN","GMRAPST4",38,0)
 ...S GMRATOT=GMRATOT+1
"RTN","GMRAPST4",39,0)
 ...S GMRADCN=$P($G(^GMR(120.8,GMRAPA,3,GMRADC,0)),U) Q:GMRADCN=""
"RTN","GMRAPST4",40,0)
 ...S ^TMP($J,"GMRAPST4",GMRADCN)=$G(^TMP($J,"GMRAPST4",GMRADCN))+1
"RTN","GMRAPST4",41,0)
 ...Q
"RTN","GMRAPST4",42,0)
 ..Q
"RTN","GMRAPST4",43,0)
 .Q
"RTN","GMRAPST4",44,0)
 Q:GMRAOUT
"RTN","GMRAPST4",45,0)
 Q:'$D(^TMP($J,"GMRAPST4"))
"RTN","GMRAPST4",46,0)
 S GMRADCN=0
"RTN","GMRAPST4",47,0)
 ;Sort in value order.
"RTN","GMRAPST4",48,0)
 F  S GMRADCN=$O(^TMP($J,"GMRAPST4",GMRADCN)) Q:GMRADCN<1  D
"RTN","GMRAPST4",49,0)
 .S GMRADC=$G(^TMP($J,"GMRAPST4",GMRADCN))  Q:GMRADC<1
"RTN","GMRAPST4",50,0)
 .S ^TMP($J,"GMRAPST4","B",GMRADC,GMRADCN)=""
"RTN","GMRAPST4",51,0)
 .Q
"RTN","GMRAPST4",52,0)
 D HEAD
"RTN","GMRAPST4",53,0)
 S GMRADC=""
"RTN","GMRAPST4",54,0)
 F  S GMRADC=$O(^TMP($J,"GMRAPST4","B",GMRADC),-1) Q:GMRADC<1  D  Q:GMRAOUT
"RTN","GMRAPST4",55,0)
 .S GMRADCN=0,GMRATAB=0,GMRADC0=0
"RTN","GMRAPST4",56,0)
 .F  S GMRADCN=$O(^TMP($J,"GMRAPST4","B",GMRADC,GMRADCN)) Q:GMRADCN<1  D  Q:GMRAOUT
"RTN","GMRAPST4",57,0)
 ..;  S GMRADC0=$G(^PS(50.605,GMRADCN,0))  ;41 Changed from direct read to API call
"RTN","GMRAPST4",58,0)
 ..D C^PSN50P65(GMRADCN,,"GMRA")  ;41  Added API
"RTN","GMRAPST4",59,0)
 ..S GMRADC0=$G(^TMP($J,"GMRA",GMRADCN,.01))_"^"_$G(^TMP($J,"GMRA",GMRADCN,1))
"RTN","GMRAPST4",60,0)
 ..S GMRATAB=30-$L($E($P(GMRADC0,U,2),1,30))
"RTN","GMRAPST4",61,0)
 ..W !,?GMRATAB,$E($P(GMRADC0,U,2),1,30),"  (",$P(GMRADC0,U),")  :",$J(GMRADC,5)
"RTN","GMRAPST4",62,0)
 ..D HEAD Q:GMRAOUT
"RTN","GMRAPST4",63,0)
 ..Q
"RTN","GMRAPST4",64,0)
 .Q
"RTN","GMRAPST4",65,0)
 W !!,?22,"Total number of records processed ",GMRATOT
"RTN","GMRAPST4",66,0)
 D CLOSE^GMRAUTL
"RTN","GMRAPST4",67,0)
 Q
"RTN","GMRAPST4",68,0)
HEAD ; Print header information
"RTN","GMRAPST4",69,0)
 I GMRAPG'=1  Q:$Y<(IOSL-4)
"RTN","GMRAPST4",70,0)
 I $E(IOST,1,2)="C-" D  Q:GMRAOUT
"RTN","GMRAPST4",71,0)
 .I GMRAPG=1 W @IOF Q
"RTN","GMRAPST4",72,0)
 .I GMRAPG'=1 D  Q:GMRAOUT
"RTN","GMRAPST4",73,0)
 ..N DIR S DIR(0)="E" D ^DIR I 'Y S GMRAOUT=1
"RTN","GMRAPST4",74,0)
 ..K Y
"RTN","GMRAPST4",75,0)
 ..Q
"RTN","GMRAPST4",76,0)
 .Q
"RTN","GMRAPST4",77,0)
 Q:GMRAOUT
"RTN","GMRAPST4",78,0)
 I GMRAPG'=1 W @IOF
"RTN","GMRAPST4",79,0)
 W "Report Date: ",$P($$FMTE^XLFDT(GMRADPDT),"@"),?70,"Page: ",GMRAPG
"RTN","GMRAPST4",80,0)
 W !,?20,"Frequency Distribution of Drug Classes"
"RTN","GMRAPST4",81,0)
 W !,?25,"From: ",$$FMTE^XLFDT(GMAST,"2D")," To: ",$$FMTE^XLFDT(GMAEN,"2D")
"RTN","GMRAPST4",82,0)
 W !,"Drug Class",?43,"Number"
"RTN","GMRAPST4",83,0)
 W !,$$REPEAT^XLFSTR("-",79)
"RTN","GMRAPST4",84,0)
 S GMRAPG=GMRAPG+1
"RTN","GMRAPST4",85,0)
 I $D(ZTQUEUED) S:$$STPCK^GMRAUTL1 GMRAOUT=1 ; Check if stopped by user
"RTN","GMRAPST4",86,0)
 Q
"RTN","GMRARAD")
0^14^B20705781^B19173368
"RTN","GMRARAD",1,0)
GMRARAD ;HIRMFO/RM-Radiology\ART Interface Routine ;12/8/04  08:03
"RTN","GMRARAD",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,27,41**;Mar 29, 1996;Build 8
"RTN","GMRARAD",3,0)
 ;
"RTN","GMRARAD",4,0)
RADD(DFN,OH,YN,VER) ; THIS EXTRINSIC FUNCTION WILL ADD A CONTRAST MEDIA
"RTN","GMRARAD",5,0)
 ; ALLERGY TO FILE 120.8 FOR PATIENT WITH IEN DFN.  INPUT VARIABLES:
"RTN","GMRARAD",6,0)
 ;    DFN = IEN IN FILE 2 OF PATIENT
"RTN","GMRARAD",7,0)
 ;    OH = 'o' FOR OBSERVED, 'h' FOR HISTORICAL, OR
"RTN","GMRARAD",8,0)
 ;         'p' IF THE UTILITY SHOULD PROMPT FOR OBSERVED/HISTORICAL.
"RTN","GMRARAD",9,0)
 ;    YN = 'Y' MEANS CONTRAST RXN, 'N' MEANS NO CONTRAST RXN,
"RTN","GMRARAD",10,0)
 ;         'U' MEANS UNKNOWN CONTRAST RXN, "" MEANS CONTRAST RXN DELETED
"RTN","GMRARAD",11,0)
 ;    VER (optional) = '1' MEANS DATA WILL BE AUTOVERIFIED,
"RTN","GMRARAD",12,0)
 ;                     '0' MEANS DATA WILL NOT BE VERIFIED,
"RTN","GMRARAD",13,0)
 ;                     '$D MEANS USE ART AUTOVERIFICATION CHECKS.
"RTN","GMRARAD",14,0)
 ; FUNCTION RETURNS THE IEN OF NEW 120.8 ENTRY, OR -1 IF NOT ADDED.
"RTN","GMRARAD",15,0)
 N DA,DIK,GMRA,GMRACAUS,GMRADRCL,GMRAL,GMRACLS,GMRANEW,GMRANOW,GMRAX,GMRAY,GMRAER,X,Y
"RTN","GMRARAD",16,0)
 I YN'="YES",YN'="Y" S DA=-1 G RETRA ; if no rxn, then no need to add
"RTN","GMRARAD",17,0)
 I DFN'>0 S DA=-1 G RETRA ; if bad DFN, then quit
"RTN","GMRARAD",18,0)
 ;--41-VS
"RTN","GMRARAD",19,0)
 D IEN^PSN50P65("","DX100","ENCAP")
"RTN","GMRARAD",20,0)
 S GMRACAUS="RADIOLOGICAL/CONTRAST MEDIA"
"RTN","GMRARAD",21,0)
 S GMRADRCL=$O(^TMP($J,"ENCAP","B","DX100",0))_";PS(50.605," I +GMRADRCL'>0 S DA=-1 G RETRA ; is DX100 in file 50.605
"RTN","GMRARAD",22,0)
 K ^TMP($J,"ENCAP")
"RTN","GMRARAD",23,0)
 ;--41-VS
"RTN","GMRARAD",24,0)
 S DA=0 F  S DA=$O(^GMR(120.8,"B",DFN,DA)) Q:DA'>0  I $$RALLG(DA) Q  ; check to see if RAD allergy present
"RTN","GMRARAD",25,0)
 I DA>0 G RETRA ; if RAD allergy present, then quit
"RTN","GMRARAD",26,0)
 I OH="p" D  ; read for OH if desired
"RTN","GMRARAD",27,0)
 .   K DIR S DIR("A")="(O)bserved or (H)istorical reaction? ",DIR(0)="SAO^O:Observed;H:Historical",DIR("?",1)="   IF THIS REACTION HAS BEEN OBSERVED, PLEASE ENTER AN O,",DIR("?")="   IF THIS REACTION IS HISTORICAL, ENTER AN H." D ^DIR
"RTN","GMRARAD",28,0)
 .   K DIR I Y="O"!(Y="H") S OH=$$LOW^XLFSTR(Y)
"RTN","GMRARAD",29,0)
 .   Q
"RTN","GMRARAD",30,0)
 I OH'="o",OH'="h" S DA=-1 G RETRA ; is OH set up right
"RTN","GMRARAD",31,0)
 S GMRANOW=$$HTFM^XLFDT($H),GMRAL=DFN_"^"_GMRACAUS_"^"_GMRADRCL_"^"_GMRANOW_"^"_$S('$G(RAAF18):DUZ,1:"")_"^"_OH_"^^^^^^1^^U^^^^^^D",GMRACLS=+GMRADRCL ; 120.8 record 0th node
"RTN","GMRARAD",32,0)
 I '$D(VER) D  ; need to check site's autoverify parameters
"RTN","GMRARAD",33,0)
 .   S GMRAY="",GMRAY(0)=GMRAL,VER=$$VFY^GMRASIGN(.GMRAY)
"RTN","GMRARAD",34,0)
 .   K GMRASITE,GMRATYPE,GMRAY
"RTN","GMRARAD",35,0)
 .   Q
"RTN","GMRARAD",36,0)
 I VER'=0,VER'=1 S DA=-1 G RETRA ; is VER set up correctly
"RTN","GMRARAD",37,0)
 S $P(GMRAL,U,16)=VER I VER S $P(GMRAL,U,17)=GMRANOW ; set up verify data in 0th node
"RTN","GMRARAD",38,0)
 S GMRANEW=$P($G(^GMR(120.8,0)),"^",3,4) ; get 120.8 0th node
"RTN","GMRARAD",39,0)
 F DA=1+GMRANEW:1 L +^GMR(120.8,DA,0):0 Q:$T&'$D(^GMR(120.8,DA,0))  L:$T&$D(^GMR(120.8,DA,0)) -^GMR(120.8,DA,0) ; find IEN for new record
"RTN","GMRARAD",40,0)
 S ^GMR(120.8,DA,0)=GMRAL ; set 0th node for new record
"RTN","GMRARAD",41,0)
 S ^GMR(120.8,DA,3,0)="^120.803PA^1^1",^GMR(120.8,DA,3,1,0)=GMRACLS ; set drug class multiple for new record
"RTN","GMRARAD",42,0)
 S ^GMR(120.8,DA,13,0)="^120.813DA^1^1",^GMR(120.8,DA,13,1,0)=$$DT^XLFDT_"^"_$G(DUZ,"") ;21 Add marked on chart when entered
"RTN","GMRARAD",43,0)
 S DIK="^GMR(120.8," D IX1^DIK L -^GMR(120.8,DA,0) ; xref new record
"RTN","GMRARAD",44,0)
 S $P(^GMR(120.8,0),"^",3,4)=DA_"^"_($P(GMRANEW,"^",2)+1) ; update 120.8 0th node
"RTN","GMRARAD",45,0)
 I '$G(RAAF18) S GMRAPA=DA,ZTSAVE("GMRAPA")="",ZTDESC="Send GMRA Bulletins For Radiology Allergy",ZTIO="",ZTRTN="QBULL^GMRARAD0",ZTDTH=$H D ^%ZTLOAD K ZTSK,GMRAPA ; send ART bulletins
"RTN","GMRARAD",46,0)
 D NKADD^GMRARAD0 ; add NKA entry if necessary
"RTN","GMRARAD",47,0)
RETRA Q DA ; exit returning entry number of new record
"RTN","GMRARAD",48,0)
 ;
"RTN","GMRARAD",49,0)
RACHK(DFN,YN) ; This function will be called from input transform on the
"RTN","GMRARAD",50,0)
 ; .05 field of file 70.  If the patient (DFN) has allergies in ART
"RTN","GMRARAD",51,0)
 ; to contrast media, and the user is changing the .05 field to
"RTN","GMRARAD",52,0)
 ; indicate NO contrast media allergy (YN), this function will prompt
"RTN","GMRARAD",53,0)
 ; the user if this change is correct.
"RTN","GMRARAD",54,0)
 ;    Input variables:  DFN=Patient IEN in file 2.
"RTN","GMRARAD",55,0)
 ;                      YN=new value of the .05 field.
"RTN","GMRARAD",56,0)
 ;    Return value:  1 if X should be killed, 0 if not
"RTN","GMRARAD",57,0)
 ;
"RTN","GMRARAD",58,0)
 N DA,DIK,DIR,FXN,GMRADA,GMRAER,GMRAX,GMRAY,X,Y
"RTN","GMRARAD",59,0)
 S FXN=0
"RTN","GMRARAD",60,0)
 I YN="N" D CHKEXAL^GMRARAD0
"RTN","GMRARAD",61,0)
 Q FXN
"RTN","GMRARAD",62,0)
RALLG(DA,ERR) ; This function will determine if entry DA in 120.8 represents
"RTN","GMRARAD",63,0)
 ; a contrast media allergy that is not entered in error.
"RTN","GMRARAD",64,0)
 ;    Input variable: DA=entry in file 120.8
"RTN","GMRARAD",65,0)
 ;                    ERR(optional)=if set to 0 do not check for E/E
"RTN","GMRARAD",66,0)
 ;    Return value: 1 if entry is contrast media allergy, 0 if not
"RTN","GMRARAD",67,0)
 ;
"RTN","GMRARAD",68,0)
 N FXN,ZERO,DRCL,DRCL1
"RTN","GMRARAD",69,0)
 S FXN=0,ZERO=$G(^GMR(120.8,DA,0)) I '$D(ERR) S ERR=1
"RTN","GMRARAD",70,0)
 I 'ERR!(ERR&'+$G(^GMR(120.8,DA,"ER"))) D
"RTN","GMRARAD",71,0)
 .;--41-VS
"RTN","GMRARAD",72,0)
 .F DRCL="DX100","DX101","DX102","DX103","DX104","DX105","DX106","DX107","DX108","DX109" D IEN^PSN50P65("",DRCL,"ENCAP") S DRCL1=$O(^TMP($J,"ENCAP","B",DRCL,0))_";PS(50.605," I $P(ZERO,U,3)=DRCL1!$D(^GMR(120.8,DA,3,"B",+DRCL1)) S FXN=1 Q
"RTN","GMRARAD",73,0)
 .I 'FXN,$P(ZERO,U,3)["GMRD(120.82"&$D(^GMRD(120.82,"D","RADIOLOGICAL/CONTRAST MEDIA",+$P(ZERO,U,3))) S FXN=1
"RTN","GMRARAD",74,0)
 .I 'FXN,$$PSCHK^GMRARAD1($P(ZERO,U,3)) S FXN=1
"RTN","GMRARAD",75,0)
 .Q
"RTN","GMRARAD",76,0)
 Q FXN
"RTN","GMRARAD",77,0)
OTHRAD(DFN,DA) ; This function will determine if another entry for patient
"RTN","GMRARAD",78,0)
 ; (DFN) exists other than entry DA that is also a Radiological
"RTN","GMRARAD",79,0)
 ; allergy.
"RTN","GMRARAD",80,0)
 ;    Input Variables:  DFN=IEN of patient,   DA=entry in 120.8
"RTN","GMRARAD",81,0)
 ;    Function Returns:  1 if another entry exists, else returns 0
"RTN","GMRARAD",82,0)
 ;
"RTN","GMRARAD",83,0)
 N FXN,GMRADA
"RTN","GMRARAD",84,0)
 S (GMRADA,FXN)=0 F  S GMRADA=$O(^GMR(120.8,"B",DFN,GMRADA)) Q:GMRADA'>0  I $$RALLG(GMRADA),GMRADA'=DA S FXN=1 Q
"RTN","GMRARAD",85,0)
 Q FXN
"RTN","GMRARAD0")
0^15^B16100133^B15629186
"RTN","GMRARAD0",1,0)
GMRARAD0 ;HIRMFO/RM-Radiology\ART Interface Routine (cont.);12/30/93
"RTN","GMRARAD0",2,0)
 ;;4.0;Adverse Reaction Tracking;**41**;Mar 29, 1996;Build 8
"RTN","GMRARAD0",3,0)
NKADD ; This entry point will add the NKA entry in file 120.8 if needed.
"RTN","GMRARAD0",4,0)
 N GMRATMP,GMRAPA,GMRA,GMRAY,GMRAX,DA,DFN,DIK
"RTN","GMRARAD0",5,0)
 S GMRA(0)=GMRAL
"RTN","GMRARAD0",6,0)
 Q:$P($G(^GMR(120.86,+GMRA(0),0)),U,2)=1
"RTN","GMRARAD0",7,0)
 I '$D(^GMR(120.86,+GMRA(0),0)) D
"RTN","GMRARAD0",8,0)
 .N GMRACNT,GMRADFN,GMRAX
"RTN","GMRARAD0",9,0)
 .S GMRADFN=+GMRA(0),GMRAX=$G(^GMR(120.86,0))
"RTN","GMRARAD0",10,0)
 .S:GMRAX="" GMRAX="ADVERSE REACTION ASSESSMENT^120.86P^^"
"RTN","GMRARAD0",11,0)
 .S GMRACNT=($P(GMRAX,U,4)+1),^GMR(120.86,GMRADFN,0)=GMRADFN_U_"1"
"RTN","GMRARAD0",12,0)
 .S ^GMR(120.86,"B",GMRADFN,GMRADFN)=""
"RTN","GMRARAD0",13,0)
 .S $P(GMRAX,U,3,4)=GMRADFN_U_GMRACNT S ^GMR(120.86,0)=GMRAX
"RTN","GMRARAD0",14,0)
 .Q
"RTN","GMRARAD0",15,0)
 I $P($G(^GMR(120.86,+GMRA(0),0)),U,2)'=1 S $P(^(0),U,2)="1"
"RTN","GMRARAD0",16,0)
 Q
"RTN","GMRARAD0",17,0)
CHKEXAL ; This entry point will check the database for existing Rad. Allergies,
"RTN","GMRARAD0",18,0)
 ; and ask user if they should be entered in error.
"RTN","GMRARAD0",19,0)
 S GMRADA=0 F  S GMRADA=$O(^GMR(120.8,"B",DFN,GMRADA)) Q:GMRADA'>0  I $$RALLG^GMRARAD(GMRADA) Q
"RTN","GMRARAD0",20,0)
 Q:GMRADA'>0  W $C(7),!!!,$C(7)
"RTN","GMRARAD0",21,0)
 S DIR("A",1)="*** WARNING *** WARNING *** WARNING ***",DIR("A",2)="Contrast media allergies have already been documented for this patient.",DIR("A",3)="By answering this question NO, you will be deleting this data."
"RTN","GMRARAD0",22,0)
 S DIR("A")="ARE YOU SURE THIS IS WHAT YOU WANT TO DO? ",DIR("?")="Answer Yes if you want to delete existing data, else answer No.",DIR(0)="YA" D ^DIR
"RTN","GMRARAD0",23,0)
 I Y'=1 S FXN=1 Q
"RTN","GMRARAD0",24,0)
 S GMRADA=0 F  S GMRADA=$O(^GMR(120.8,"B",DFN,GMRADA)) Q:GMRADA'>0  I $$RALLG^GMRARAD(GMRADA) D
"RTN","GMRARAD0",25,0)
 .   S GMRAER=$G(^GMR(120.8,GMRADA,"ER")),DA=GMRADA
"RTN","GMRARAD0",26,0)
 .   F GMRAX=22,23,24 S X=$S(GMRAX=22:$P(GMRAER,U),GMRAX=23:$P(GMRAER,U,2),1:$P(GMRAER,U,3)),GMRAY=0 F  S GMRAY=$O(^DD(120.8,GMRAX,1,GMRAY)) Q:GMRAY'>0  X:$D(^DD(120.8,GMRAX,1,GMRAY,2)) ^(2)
"RTN","GMRARAD0",27,0)
 .   S GMRAER="1^"_$$HTFM^XLFDT($H)_"^"_DUZ,^GMR(120.8,GMRADA,"ER")=GMRAER
"RTN","GMRARAD0",28,0)
 .   F GMRAX=22,23,24 S X=$S(GMRAX=22:$P(GMRAER,U),GMRAX=23:$P(GMRAER,U,2),1:$P(GMRAER,U,3)),GMRAY=0 F  S GMRAY=$O(^DD(120.8,GMRAX,1,GMRAY)) Q:GMRAY'>0  X:$D(^DD(120.8,GMRAX,1,GMRAY,1)) ^(1)
"RTN","GMRARAD0",29,0)
 Q
"RTN","GMRARAD0",30,0)
QBULL ; THIS ENTRY POINT WILL ALLOW BE CALLED AS A TASKED JOB TO SEND
"RTN","GMRARAD0",31,0)
 ; BULLETINS FOR A RAD ALLERGY IF NECESSARY.
"RTN","GMRARAD0",32,0)
 ;  INPUT VARIABLE: GMRAPA = IEN 120.8 ENTRY
"RTN","GMRARAD0",33,0)
 Q:GMRAPA'>0
"RTN","GMRARAD0",34,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:$P(GMRAPA(0),U,2)=""
"RTN","GMRARAD0",35,0)
 S DFN=+GMRAPA(0) Q:DFN'>0
"RTN","GMRARAD0",36,0)
 D 1^VADPT S GMRANAM=VADM(1),GMRALOC=$P(VAIN(4),U,2),GMRAVIP=VA("PID") D KVAR^VADPT K VA
"RTN","GMRARAD0",37,0)
 D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRARAD0",38,0)
 I '$P(GMRAPA(0),U,16) D EN1^GMRAVAB ; Send Verify bull. if not ver.
"RTN","GMRARAD0",39,0)
 I '$O(^GMR(120.8,GMRAPA,13,0))!'($P(GMRASITE(0),U,5)=0!(GMRALOC="")!$O(^GMR(120.8,GMRAPA,14,0))) D BULLT^GMRASEND ; Send Mark Chart/ID Band bull. if necessary.
"RTN","GMRARAD0",40,0)
 I $P(GMRAPA(0),U,6)="o",$P(GMRAPA(0),U,20)["D" D PTBUL^GMRAROBS ; Send P&T bull. if observed drug rxn.
"RTN","GMRARAD0",41,0)
 K %,DFN,GMRAHLOC,GMRALOC,GMRANAM,GMRAOUT,GMRAPA,GMRASITE,GMRATYPE,GMRAVIP,XMB,XMY,XQA,XQAMSG S ZTREQ="@"
"RTN","GMRARAD0",42,0)
 Q
"RTN","GMRARAD0",43,0)
DRCLRACK(DA) ; This function will determine if entry DA in 120.8 represents
"RTN","GMRARAD0",44,0)
 ; a contrast media allergy that is not entered in error if the Drug
"RTN","GMRARAD0",45,0)
 ; Class DX100 is deleted.
"RTN","GMRARAD0",46,0)
 ;    Input variable: DA=entry in file 120.8
"RTN","GMRARAD0",47,0)
 ;    Return value: 1 if entry is contrast media allergy, 0 if not
"RTN","GMRARAD0",48,0)
 ;
"RTN","GMRARAD0",49,0)
 N FXN,ZERO,DRCL,DRCL1,DRCL2
"RTN","GMRARAD0",50,0)
 S FXN=0,ZERO=$G(^GMR(120.8,DA(1),0))
"RTN","GMRARAD0",51,0)
 I '+$G(^GMR(120.8,DA(1),"ER")) D
"RTN","GMRARAD0",52,0)
 .   F DRCL="DX100","DX101","DX102" D  Q:FXN
"RTN","GMRARAD0",53,0)
 .   .   ;41-VS
"RTN","GMRARAD0",54,0)
 .   .   D IEN^PSN50P65("",DRCL,"ENCAP")
"RTN","GMRARAD0",55,0)
 .   .   S DRCL1=$O(^TMP($J,"ENCAP","B",DRCL,0))_";PS(50.605,"
"RTN","GMRARAD0",56,0)
 .   .   K ^TMP($J,"ENCAP")
"RTN","GMRARAD0",57,0)
 .   .   ;41-VS
"RTN","GMRARAD0",58,0)
 .   .   I $P(ZERO,U,3)=DRCL1 S FXN=1 Q
"RTN","GMRARAD0",59,0)
 .   .   S DRCL2=0 F  S DRCL2=$O(^GMR(120.8,DA(1),3,DRCL2)) Q:DRCL2<1  I DRCL2'=DA,+$G(^GMR(120.8,DA(1),3,DRCL2,0))=+DRCL1 S FXN=1 Q
"RTN","GMRARAD0",60,0)
 .   .   Q
"RTN","GMRARAD0",61,0)
 .   I 'FXN,$P(ZERO,U,3)["GMRD(120.82"&$D(^GMRD(120.82,"D","RADIOLOGICAL/CONTRAST MEDIA",+$P(ZERO,U,3))) S FXN=1
"RTN","GMRARAD0",62,0)
 .   Q
"RTN","GMRARAD0",63,0)
 Q FXN
"RTN","GMRARAD1")
0^16^B2025322^B1836385
"RTN","GMRARAD1",1,0)
GMRARAD1 ;HIRMFO/WAA-RADIOLOGY ALLERGY INTERFACE ; 12/4/07 11:47am
"RTN","GMRARAD1",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,27,41**;Mar 29, 1996;Build 8
"RTN","GMRARAD1",3,0)
PSCHK(GMRAVAR) ; This function will return a 1 (true) if the variable ptr
"RTN","GMRARAD1",4,0)
 ; passed in (GMRAVAR) has a RADIOLOGICAL CONTRAST/MEDIA VA Drug
"RTN","GMRARAD1",5,0)
 ; Class associated with it.
"RTN","GMRARAD1",6,0)
 N CHK,GMRAX,GMRAY
"RTN","GMRARAD1",7,0)
 ;--41
"RTN","GMRARAD1",8,0)
 S CHK=0,GMRAX=$P(GMRAVAR,";")
"RTN","GMRARAD1",9,0)
 D ZERO^PSS50(GMRAX,"","","","","ENCAP")
"RTN","GMRARAD1",10,0)
 I $P(GMRAVAR,";",2)="PSDRUG(" S:"^DX100^DX101^DX102^DX103^DX104^DX105^DX106^DX107^DX108^DX109^"[("^"_$G(^TMP($J,"ENCAP",GMRAX,2))_"^") CHK=1
"RTN","GMRARAD1",11,0)
 K ^TMP($J,"ENCAP")
"RTN","GMRARAD1",12,0)
 ;--41
"RTN","GMRARAD1",13,0)
 I $P(GMRAVAR,";",2)=$P($$NDFREF^GMRAOR,U,2) D:$D(@($$NDFREF^GMRAOR_GMRAX_",0)"))
"RTN","GMRARAD1",14,0)
 .N CLASS,GMRACL
"RTN","GMRARAD1",15,0)
 .S CLASS=$$CLIST^PSNAPIS(GMRAX,.GMRACL) I $O(GMRACL(0)) D  Q:CHK
"RTN","GMRARAD1",16,0)
 ..S CLASS=0 F  S CLASS=$O(GMRACL(CLASS)) Q:'CLASS  D
"RTN","GMRARAD1",17,0)
 ...I "^DX100^DX101^DX102^DX103^DX104^DX105^DX106^DX107^DX108^DX109^"[("^"_$P(GMRACL(CLASS),U,2)_"^") S CHK=1
"RTN","GMRARAD1",18,0)
 ..Q
"RTN","GMRARAD1",19,0)
 .Q
"RTN","GMRARAD1",20,0)
 Q CHK
"RTN","GMRAUIX0")
0^17^B3830762^B2854769
"RTN","GMRAUIX0",1,0)
GMRAUIX0 ;HIRMFO/RM-CROSS REFERENCES FOR FILE 120.8 ;11/16/07  10:35
"RTN","GMRAUIX0",2,0)
 ;;4.0;Adverse Reaction Tracking;**14,41**;Mar 29, 1996;Build 8
"RTN","GMRAUIX0",3,0)
 ;DBIA Section
"RTN","GMRAUIX0",4,0)
 ;PSN50P65 - 4543
"RTN","GMRAUIX0",5,0)
EN1 ; ENTRY FROM THE ADRG01 OR ADRG22 XREF [^DD(120.8,.01 and ^DD(120.8,22]
"RTN","GMRAUIX0",6,0)
 ; FOR FURTHER INFO ON THESE XREFS SEE INTERNAL RELATIONS SECTION
"RTN","GMRAUIX0",7,0)
 ; OF THE ADVERSE REACTION TRACKING TECHNICAL MANUAL.
"RTN","GMRAUIX0",8,0)
 S GMRA("DA")=DA N DA S DA(1)=GMRA("DA")
"RTN","GMRAUIX0",9,0)
 S GMRA("ER")=$S(+GMRA=22:X,1:+$G(^GMR(120.8,DA(1),"ER"))),GMRA(1)=$S(+GMRA=.01:X,1:$P($G(^GMR(120.8,DA(1),0)),"^"))
"RTN","GMRAUIX0",10,0)
 F GMRA("X")=2,3 F DA=0:0 S DA=$O(^GMR(120.8,DA(1),GMRA("X"),DA)) Q:DA'>0  S GMRA("INCL")=$P($G(^GMR(120.8,DA(1),GMRA("X"),DA,0)),"^") D IX
"RTN","GMRAUIX0",11,0)
 K GMRA
"RTN","GMRAUIX0",12,0)
 Q
"RTN","GMRAUIX0",13,0)
EN2 ; ENTRY FROM THE ADRG2 OR ADRG3 XREF [^DD(120.802,.01 & ^DD(120.803,.01]
"RTN","GMRAUIX0",14,0)
 ; FOR FURTHER INFO ON THESE XREFS SEE INTERNAL RELATIONS SECTION
"RTN","GMRAUIX0",15,0)
 ; OF THE ADVERSE REACTION TRACKING TECHNICAL MANUAL.
"RTN","GMRAUIX0",16,0)
 S GMRA("INCL")=X,GMRA("X")=+GMRA,GMRA("ER")=+$G(^GMR(120.8,DA(1),"ER")),GMRA(1)=$P($G(^GMR(120.8,DA(1),0)),"^") D IX
"RTN","GMRAUIX0",17,0)
 K GMRA
"RTN","GMRAUIX0",18,0)
 Q
"RTN","GMRAUIX0",19,0)
IX ; SET/KILL THE INDEX
"RTN","GMRAUIX0",20,0)
 K ^TMP($J,"GMRACLASS") ;41 Clear storage before use
"RTN","GMRAUIX0",21,0)
 D C^PSN50P65(+GMRA("INCL"),,"GMRACLASS") ;41 Get drug class data
"RTN","GMRAUIX0",22,0)
 S GMRA("INCL")=$S(GMRA("X")=2:GMRA("INCL"),1:$G(^TMP($J,"GMRACLASS",+GMRA("INCL"),.01))) ;41 Get drug class code from ^TMP
"RTN","GMRAUIX0",23,0)
 Q:'$L(GMRA("INCL"))!'$L(GMRA(1))
"RTN","GMRAUIX0",24,0)
 I $P(GMRA,"^",2)&GMRA("ER")!('$P(GMRA,"^",2)&(+GMRA'=22)) K ^GMR(120.8,$P("API^APC","^",GMRA("X")-1),GMRA(1),GMRA("INCL"),DA(1),DA)
"RTN","GMRAUIX0",25,0)
 E  S ^GMR(120.8,$P("API^APC","^",GMRA("X")-1),GMRA(1),GMRA("INCL"),DA(1),DA)=""
"RTN","GMRAUIX0",26,0)
 Q
"RTN","GMRAUTL2")
0^18^B81816140^B79798893
"RTN","GMRAUTL2",1,0)
GMRAUTL2 ;SLC/DAN - New style index utilities, update utility for 120.8 ;1/7/08  09:36
"RTN","GMRAUTL2",2,0)
 ;;4.0;Adverse Reaction Tracking;**23,36,41**;Mar 29, 1996;Build 8
"RTN","GMRAUTL2",3,0)
 ;DBIA Section
"RTN","GMRAUTL2",4,0)
 ;%ZTLOAD    - 10063
"RTN","GMRAUTL2",5,0)
 ;DIE        - 10018
"RTN","GMRAUTL2",6,0)
 ;FILE^DIE   - 2053
"RTN","GMRAUTL2",7,0)
 ;UPDATE^DIE - 2053
"RTN","GMRAUTL2",8,0)
 ;DIQ        - 2056
"RTN","GMRAUTL2",9,0)
 ;ORCHECK    - 4859
"RTN","GMRAUTL2",10,0)
 ;ORKCHK     - 4135
"RTN","GMRAUTL2",11,0)
 ;ORQOR2     - 3458
"RTN","GMRAUTL2",12,0)
 ;ORX8       - 2467
"RTN","GMRAUTL2",13,0)
 ;PSN50P41   - 4531
"RTN","GMRAUTL2",14,0)
 ;PSN50P65   - 4543
"RTN","GMRAUTL2",15,0)
 ;XLFDT      - 10103
"RTN","GMRAUTL2",16,0)
 ;XTID       - 4631
"RTN","GMRAUTL2",17,0)
 ;
"RTN","GMRAUTL2",18,0)
 N GMRAI,GMRAC,ENTRY,UPDATED
"RTN","GMRAUTL2",19,0)
 Q:$G(X1(1))=$G(X2(1))  ;Entry unchanged
"RTN","GMRAUTL2",20,0)
 S ENTRY=DA(1)_";GMRD(120.82,"_"^"_$P(^GMRD(120.82,DA(1),0),"^")
"RTN","GMRAUTL2",21,0)
 I $G(X1(1))>0,$G(X2(1))>0 S:$G(GMRAT)="ING" GMRAI("D",X1(1))="",GMRAI("A",X2(1))="" S:$G(GMRAT)="CLASS" GMRAC("D",X1(1))="",GMRAC("A",X2(1))="" ;Edited existing entry
"RTN","GMRAUTL2",22,0)
 I $G(X1(1))>0,$G(X2(1))="" S:$G(GMRAT)="ING" GMRAI("D",X1(1))="" S:$G(GMRAT)="CLASS" GMRAC("D",X1(1))="" ;Entry deleted
"RTN","GMRAUTL2",23,0)
 I $G(X1(1))="",$G(X2(1))>0 S:$G(GMRAT)="ING" GMRAI("A",X2(1))="" S:$G(GMRAT)="CLASS" GMRAC("A",X2(1))="" ;New entry
"RTN","GMRAUTL2",24,0)
 D QUP ;Queue updating of existing entries and order checking
"RTN","GMRAUTL2",25,0)
 Q
"RTN","GMRAUTL2",26,0)
 ;
"RTN","GMRAUTL2",27,0)
QUP ;Queue the update
"RTN","GMRAUTL2",28,0)
 S ZTRTN="UPDATE^GMRAUTL2(ENTRY,.GMRAI,.GMRAC)",ZTIO="GMRA UPDATE RESOURCE",ZTDTH=$H,ZTDESC="Update existing allergies",ZTSAVE("*")="" D ^%ZTLOAD Q
"RTN","GMRAUTL2",29,0)
 ;
"RTN","GMRAUTL2",30,0)
UPDATE(ENTRY,ING,CLASS) ;Update existing entries in 120.8 with new information.
"RTN","GMRAUTL2",31,0)
 ;Entry is IEN;File reference^Text of file entry - 6;GMRD(120.82,^STRAWBERRIES
"RTN","GMRAUTL2",32,0)
 ;ING - Array of ingredients - "A",IEN for those to be added and "D",IEN for those to be deleted
"RTN","GMRAUTL2",33,0)
 ;CLASS - Array of drug classes - "A",IEN for those to be added and "D",IEN for those to be deleted
"RTN","GMRAUTL2",34,0)
 ;
"RTN","GMRAUTL2",35,0)
 N ALLERGY,POINTER,ACTION,SUB,SUBI,SUBC,DFN,GMRAS,GMRACOM
"RTN","GMRAUTL2",36,0)
 S ALLERGY=$P(ENTRY,"^",2) Q:ALLERGY=""
"RTN","GMRAUTL2",37,0)
 S POINTER=$P(ENTRY,"^") Q:POINTER=""
"RTN","GMRAUTL2",38,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,"C",ALLERGY,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",39,0)
 .S DFN=$P(^GMR(120.8,SUB,0),U)
"RTN","GMRAUTL2",40,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",41,0)
 .Q:$P(^GMR(120.8,SUB,0),"^",3)'=POINTER  ;Same text name but not the same entry
"RTN","GMRAUTL2",42,0)
 .Q:$G(^GMR(120.8,SUB,"ER"))>0  ;Entered in error
"RTN","GMRAUTL2",43,0)
 .S GMRACOM=0
"RTN","GMRAUTL2",44,0)
 .F ACTION="A","D" D
"RTN","GMRAUTL2",45,0)
 ..S SUBI=0 F  S SUBI=$O(ING(ACTION,SUBI)) Q:'+SUBI  D
"RTN","GMRAUTL2",46,0)
 ...I ACTION="A" D ADD("I",SUB,SUBI,.GMRAS) I $G(GMRAS) S ING(ACTION,SUBI)=1,GMRACOM=1,UPDATED(DFN)=""
"RTN","GMRAUTL2",47,0)
 ...I ACTION="D" D DEL("I",SUB,SUBI,.GMRAS) I $G(GMRAS) S ING(ACTION,SUBI)=1,GMRACOM=1
"RTN","GMRAUTL2",48,0)
 ..S SUBC=0 F  S SUBC=$O(CLASS(ACTION,SUBC)) Q:'+SUBC  D
"RTN","GMRAUTL2",49,0)
 ...I ACTION="A" D ADD("C",SUB,SUBC,.GMRAS) I $G(GMRAS) S CLASS(ACTION,SUBC)=1,UPDATED(DFN)="",GMRACOM=1
"RTN","GMRAUTL2",50,0)
 ...I ACTION="D" D DEL("C",SUB,SUBC,.GMRAS) I $G(GMRAS) S GMRACOM=1,CLASS(ACTION,SUBC)=1
"RTN","GMRAUTL2",51,0)
 .I $G(GMRACOM) D ADDCOM
"RTN","GMRAUTL2",52,0)
 I $D(UPDATED) D CHKORD ;New order checks now?
"RTN","GMRAUTL2",53,0)
 Q
"RTN","GMRAUTL2",54,0)
 ;
"RTN","GMRAUTL2",55,0)
ADD(TYPE,ALENT,SUBENT,GMRAS) ;Adds entry to appropriate multiple
"RTN","GMRAUTL2",56,0)
 N FILE,FDA,EM
"RTN","GMRAUTL2",57,0)
 S GMRAS=1
"RTN","GMRAUTL2",58,0)
 I $D(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT)) S GMRAS=0 Q  ;Entry already exists
"RTN","GMRAUTL2",59,0)
 L +^GMR(120.8,ALENT)
"RTN","GMRAUTL2",60,0)
 S FILE=$S(TYPE="I":120.802,1:120.803)
"RTN","GMRAUTL2",61,0)
 S FDA(FILE,"+1,"_ALENT_",",.01)=SUBENT
"RTN","GMRAUTL2",62,0)
 D UPDATE^DIE("","FDA",,"EM")
"RTN","GMRAUTL2",63,0)
 L -^GMR(120.8,ALENT)
"RTN","GMRAUTL2",64,0)
 Q
"RTN","GMRAUTL2",65,0)
 ;
"RTN","GMRAUTL2",66,0)
DEL(TYPE,ALENT,SUBENT,GMRAS) ;Delete entry from multiple
"RTN","GMRAUTL2",67,0)
 N FILE,FDA,EM,ENTRY
"RTN","GMRAUTL2",68,0)
 S GMRAS=1
"RTN","GMRAUTL2",69,0)
 I '$D(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT)) S GMRAS=0 Q  ;No entry to delete
"RTN","GMRAUTL2",70,0)
 L +^GMR(120.8,ALENT)
"RTN","GMRAUTL2",71,0)
 S ENTRY=$O(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT,0)) Q:'+ENTRY
"RTN","GMRAUTL2",72,0)
 S FILE=$S(TYPE="I":120.802,1:120.803)
"RTN","GMRAUTL2",73,0)
 S FDA(FILE,ENTRY_","_ALENT_",",.01)="@"
"RTN","GMRAUTL2",74,0)
 D FILE^DIE("","FDA","EM")
"RTN","GMRAUTL2",75,0)
 L -^GMR(120.8,ALENT)
"RTN","GMRAUTL2",76,0)
 Q
"RTN","GMRAUTL2",77,0)
 ;
"RTN","GMRAUTL2",78,0)
CHKORD ;Check for orders that are now in conflict with existing allergy data
"RTN","GMRAUTL2",79,0)
 N TIME,GMRAOC,ORX,SUB,GMRAORX,GI,CNT,DFN
"RTN","GMRAUTL2",80,0)
 Q:'+$G(DUZ)  ;Don't check if no valid user to send data to
"RTN","GMRAUTL2",81,0)
 K ^TMP("ORR",$J),^TMP($J,"ERR")
"RTN","GMRAUTL2",82,0)
 S DFN=0 F  S DFN=$O(UPDATED(DFN)) Q:'+DFN  D
"RTN","GMRAUTL2",83,0)
 .D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAUTL2",84,0)
 .S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAUTL2",85,0)
 .Q:'^TMP("ORR",$J,TIME,"TOT")  ;No orders found
"RTN","GMRAUTL2",86,0)
 .S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",87,0)
 ..D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAUTL2",88,0)
 .M GMRAORX=ORX K ORX,GMRAOC
"RTN","GMRAUTL2",89,0)
 .D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT")
"RTN","GMRAUTL2",90,0)
 .S GI=0,CNT=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAUTL2",91,0)
 ..Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAUTL2",92,0)
 ..Q:$D(^OR(100,$P(GMRAOC(GI),U),9,"B",3))  ;Quit if existing allergy order check, can't be for this new information
"RTN","GMRAUTL2",93,0)
 ..S CNT=CNT+1,^TMP($J,"ERR",DFN,CNT)=$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)_" order for "_$P($$OI^ORX8($P(GMRAOC(GI),U)),U,2)_",order #"_$P(GMRAOC(GI),U)
"RTN","GMRAUTL2",94,0)
 .K GMRAORX ;Remove previous list of orders
"RTN","GMRAUTL2",95,0)
 D MAIL K ^TMP("ORR",$J),^TMP($J,"ERR")
"RTN","GMRAUTL2",96,0)
 Q
"RTN","GMRAUTL2",97,0)
 ;
"RTN","GMRAUTL2",98,0)
ADDCOM ;Add comment to updated allergy indicating changes
"RTN","GMRAUTL2",99,0)
 D ADDCOM^GMRAUTL3 ;41 Moved section due to space considerations
"RTN","GMRAUTL2",100,0)
 Q
"RTN","GMRAUTL2",101,0)
 ;
"RTN","GMRAUTL2",102,0)
MAIL ;Send message containing potential order checks to user.
"RTN","GMRAUTL2",103,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,CNT,SUB,ERR,TYPE,NUM
"RTN","GMRAUTL2",104,0)
 Q:'$D(^TMP($J,"ERR"))  ;Nothing to report
"RTN","GMRAUTL2",105,0)
 K ^TMP($J,"TEXT"),^TMP($J,"GMRAINFO") ;41 Clear out storage area
"RTN","GMRAUTL2",106,0)
 S XMDUZ="Allergy auto-update program"
"RTN","GMRAUTL2",107,0)
 S XMY($G(DUZ,.5))="" ;Send to user who initiated change or postmaster
"RTN","GMRAUTL2",108,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")="" ;Include mail group to be sure someone gets this message
"RTN","GMRAUTL2",109,0)
 S CNT=1
"RTN","GMRAUTL2",110,0)
 S ^TMP($J,"TEXT",CNT)="The "_$P(ENTRY,U,2)_" reactant was updated.",CNT=CNT+1
"RTN","GMRAUTL2",111,0)
 S ^TMP($J,"TEXT",CNT)="The following drug classes and/or drug ingredients were added:",CNT=CNT+1,^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",112,0)
 F TYPE="GMRAI","GMRAC" D
"RTN","GMRAUTL2",113,0)
 .I $D(@(TYPE)) D
"RTN","GMRAUTL2",114,0)
 ..S ^TMP($J,"TEXT",CNT)=$S(TYPE="GMRAI":"Ingredients",1:"Classes")_": ",CNT=CNT+1
"RTN","GMRAUTL2",115,0)
 ..S NUM=0 F  S NUM=$O(@TYPE@("A",NUM)) Q:'+NUM  S ^TMP($J,"TEXT",CNT)=$G(^TMP($J,"TEXT",CNT))_$S($L($G(^TMP($J,"TEXT",CNT))):",",1:"") D  ;41 added call for data in structure below
"RTN","GMRAUTL2",116,0)
 ...I TYPE="GMRAI" D ZERO^PSN50P41(NUM,,$$DT^XLFDT,"GMRAINFO") ;41 ingredient call
"RTN","GMRAUTL2",117,0)
 ...I TYPE="GMRAC" D C^PSN50P65(NUM,,"GMRAINFO") ;41 drug class call
"RTN","GMRAUTL2",118,0)
 ...S ^TMP($J,"TEXT",CNT)=^TMP($J,"TEXT",CNT)_$G(^TMP($J,"GMRAINFO",NUM,.01)) ;41 add data
"RTN","GMRAUTL2",119,0)
 ..S CNT=CNT+1,^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",120,0)
 S ^TMP($J,"TEXT",CNT)="As a result of the update the following patients have drug-allergy",CNT=CNT+1
"RTN","GMRAUTL2",121,0)
 S ^TMP($J,"TEXT",CNT)="interactions that need to be reviewed to ensure the patient's safety.",CNT=CNT+1
"RTN","GMRAUTL2",122,0)
 S SUB=0 F  S SUB=$O(^TMP($J,"ERR",SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",123,0)
 .S ^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",124,0)
 .S ^TMP($J,"TEXT",CNT)=$$GET1^DIQ(2,SUB_",",.01),CNT=CNT+1
"RTN","GMRAUTL2",125,0)
 .S ERR=0 F  S ERR=$O(^TMP($J,"ERR",SUB,ERR)) Q:'+ERR  S ^TMP($J,"TEXT",CNT)="   "_^TMP($J,"ERR",SUB,ERR),CNT=CNT+1
"RTN","GMRAUTL2",126,0)
 S XMTEXT="^TMP($J,""TEXT"",",XMSUB="Potential order checks from allergy update"
"RTN","GMRAUTL2",127,0)
 D ^XMD
"RTN","GMRAUTL2",128,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAUTL2",129,0)
 Q
"RTN","GMRAUTL2",130,0)
 ;
"RTN","GMRAUTL2",131,0)
TOP10 ;Check top 10 reactions after push of file 120.83
"RTN","GMRAUTL2",132,0)
 N SUB,REAC,REACNO,ARRAY,SUBNM,REACNM,GMRATXT,XMSUB,XMTEXT,XMDUZ,XMY,DIFROM,CNT
"RTN","GMRAUTL2",133,0)
 I '$L($T(SCREEN^XTID)) Q  ;No screening code so quit
"RTN","GMRAUTL2",134,0)
 S SUB=0 F  S SUB=$O(^GMRD(120.84,SUB)) Q:'+SUB  I $D(^GMRD(120.84,SUB,1)) D
"RTN","GMRAUTL2",135,0)
 .S REAC=0 F  S REAC=$O(^GMRD(120.84,SUB,1,REAC)) Q:'+REAC  D
"RTN","GMRAUTL2",136,0)
 ..S REACNO=$P(^GMRD(120.84,SUB,1,REAC,0),U) Q:'+REACNO
"RTN","GMRAUTL2",137,0)
 ..I $$SCREEN^XTID(120.83,.01,REACNO_",") D
"RTN","GMRAUTL2",138,0)
 ...S SUBNM=$P(^GMRD(120.84,SUB,0),U),REACNM=$P(^GMRD(120.83,REACNO,0),U)
"RTN","GMRAUTL2",139,0)
 ...S ARRAY(SUBNM,REACNM)=""
"RTN","GMRAUTL2",140,0)
 I $D(ARRAY) D
"RTN","GMRAUTL2",141,0)
 .S XMDUZ="Data Standardization update of file 120.83",XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAUTL2",142,0)
 .S GMRATXT(1)="The signs/symptoms file has been automatically updated.  You're receiving"
"RTN","GMRAUTL2",143,0)
 .S GMRATXT(2)="this message because one or more signs/symptoms was inactivated during this"
"RTN","GMRAUTL2",144,0)
 .S GMRATXT(3)="update and the term(s) appear in your top ten list and must be replaced."
"RTN","GMRAUTL2",145,0)
 .S GMRATXT(4)="Below you will find the name of the site parameter and the terms that are now"
"RTN","GMRAUTL2",146,0)
 .S GMRATXT(5)="inactive for that entry.  Use the Enter/Edit Site Parameters [GMRA SITE FILE]"
"RTN","GMRAUTL2",147,0)
 .S GMRATXT(6)="option to find and replace these terms."
"RTN","GMRAUTL2",148,0)
 .S GMRATXT(7)=""
"RTN","GMRAUTL2",149,0)
 .S CNT=7
"RTN","GMRAUTL2",150,0)
 .S SUB="" F  S SUB=$O(ARRAY(SUB)) Q:SUB=""  S CNT=CNT+1,GMRATXT(CNT)="Site parameter: "_SUB D  S CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAUTL2",151,0)
 ..S REAC="" F  S REAC=$O(ARRAY(SUB,REAC)) Q:REAC=""  S CNT=CNT+1,GMRATXT(CNT)="Term: "_REAC
"RTN","GMRAUTL2",152,0)
 .S XMTEXT="GMRATXT(",XMSUB="Signs/symptoms require updating"
"RTN","GMRAUTL2",153,0)
 .D ^XMD
"RTN","GMRAUTL2",154,0)
 Q
"RTN","GMRAUTL2",155,0)
 ;
"RTN","GMRAUTL2",156,0)
QREACT ;Queue name update, called from "AC" xref in file 120.82.  Entire section added in patch 23
"RTN","GMRAUTL2",157,0)
 N OTERM,NTERM,ZTRTN,ZTDTH,ZTIO,ZTDESC
"RTN","GMRAUTL2",158,0)
 Q:X1(1)=""!(X2(1)="")  ;Entry is new or has been deleted, no updating required
"RTN","GMRAUTL2",159,0)
 Q:X1(1)=X2(1)  ;Entry has been updated to same value, no updating required
"RTN","GMRAUTL2",160,0)
 S OTERM=X1(1),NTERM=X2(1)
"RTN","GMRAUTL2",161,0)
 S ZTRTN="REACT^GMRAUTL2",ZTIO="GMRA UPDATE RESOURCE",ZTDTH=$H,ZTDESC="UPDATE REACTANT FIELD IN 120.8",ZTSAVE("*")="" D ^%ZTLOAD
"RTN","GMRAUTL2",162,0)
 Q
"RTN","GMRAUTL2",163,0)
 ;
"RTN","GMRAUTL2",164,0)
REACT ;Update REACTANT field with name from 120.82.  Section added with patch 23
"RTN","GMRAUTL2",165,0)
 N IEN,FDA,EM,DFN
"RTN","GMRAUTL2",166,0)
 S IEN=0 F  S IEN=$O(^GMR(120.8,"C",OTERM,IEN)) Q:'+IEN  D
"RTN","GMRAUTL2",167,0)
 .S DFN=$P(^GMR(120.8,IEN,0),U)
"RTN","GMRAUTL2",168,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",169,0)
 .Q:+$G(^GMR(120.8,IEN,"ER"))  ;Don't update if entered in error
"RTN","GMRAUTL2",170,0)
 .L +^GMR(120.8,IEN)
"RTN","GMRAUTL2",171,0)
 .S FDA(120.8,IEN_",",.02)=NTERM
"RTN","GMRAUTL2",172,0)
 .D FILE^DIE("","FDA","EM")
"RTN","GMRAUTL2",173,0)
 .L -^GMR(120.8,IEN)
"RTN","GMRAUTL2",174,0)
 Q
"RTN","GMRAUTL2",175,0)
 ;
"RTN","GMRAUTL2",176,0)
QTYPE ;Queue allergy type updates, section added in 36
"RTN","GMRAUTL2",177,0)
 N ENTRY
"RTN","GMRAUTL2",178,0)
 S ENTRY=DA_";GMRD(120.82,"_"^"_$P(^GMRD(120.82,DA,0),"^")
"RTN","GMRAUTL2",179,0)
 Q:X1(1)=""!(X2(1)="")
"RTN","GMRAUTL2",180,0)
 Q:X1(1)=X2(1)
"RTN","GMRAUTL2",181,0)
 S ZTRTN="TYPE^GMRAUTL2",ZTIO="",ZTDTH=$H,ZTDESC="Allergy type updates",ZTSAVE("*")="" D ^%ZTLOAD
"RTN","GMRAUTL2",182,0)
 Q
"RTN","GMRAUTL2",183,0)
 ;
"RTN","GMRAUTL2",184,0)
TYPE ;Find related entries in 120.8 and update, section added in 36
"RTN","GMRAUTL2",185,0)
 N ALLERGY,POINTER,DFN,SUB
"RTN","GMRAUTL2",186,0)
 S ALLERGY=$P(ENTRY,"^",2) Q:ALLERGY=""
"RTN","GMRAUTL2",187,0)
 S POINTER=$P(ENTRY,"^") Q:POINTER=""
"RTN","GMRAUTL2",188,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,"C",ALLERGY,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",189,0)
 .Q:$P(^GMR(120.8,SUB,0),"^",3)'=POINTER  ;Same text name but not the same entry
"RTN","GMRAUTL2",190,0)
 .S DFN=$P(^GMR(120.8,SUB,0),U)
"RTN","GMRAUTL2",191,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",192,0)
 .Q:$G(^GMR(120.8,SUB,"ER"))>0  ;Entered in error
"RTN","GMRAUTL2",193,0)
 .S DR="3.1///"_X2(1),DIE=120.8,DA=SUB D ^DIE ;Update allergy type
"RTN","GMRAUTL2",194,0)
 Q
"RTN","GMRAUTL3")
0^20^B4579634^n/a
"RTN","GMRAUTL3",1,0)
GMRAUTL3 ;SLC/DAN - New style index utilities continued ;1/7/08  09:36
"RTN","GMRAUTL3",2,0)
 ;;4.0;Adverse Reaction Tracking;**41**;Mar 29, 1996;Build 8
"RTN","GMRAUTL3",3,0)
 ;DBIA Section
"RTN","GMRAUTL3",4,0)
 ;PSN50P41 - 4531
"RTN","GMRAUTL3",5,0)
 ;PSN50P65 - 4543
"RTN","GMRAUTL3",6,0)
 ;XLFDT    - 10103
"RTN","GMRAUTL3",7,0)
 ;
"RTN","GMRAUTL3",8,0)
ADDCOM ;Add comment to updated allergy indicating changes
"RTN","GMRAUTL3",9,0)
 Q  ;Not currently in use
"RTN","GMRAUTL3",10,0)
 N TYPE,ROOT,SUB2,DICR,DIEL,DL,DP,DM,DK,DIK,DC,DE,GLOB,DH,D,DQ,DR,DIC,DIE,DIA,DI,DG,DDH,DDER,DA,D0,D1
"RTN","GMRAUTL3",11,0)
 K ^TMP($J,"GMRAINFO") ;41 Clear out storage space
"RTN","GMRAUTL3",12,0)
 F GLOB="ING(""A"")","ING(""D"")","CLASS(""A"")","CLASS(""D"")" I $D(@GLOB) D
"RTN","GMRAUTL3",13,0)
 .S TYPE=$S(GLOB="ING(""A"")":1,GLOB="ING(""D"")":2,GLOB="CLASS(""A"")":3,1:4) ;Determines if we're adding or deleting ingredients or classes
"RTN","GMRAUTL3",14,0)
 .S COM="The following "_$S(TYPE=1!(TYPE=2):"ingredients",1:"drug classes")_" were "_$S(TYPE=2!(TYPE=4):"deleted",1:"added")_": "
"RTN","GMRAUTL3",15,0)
 .S ROOT=$S(TYPE=1:"ING(""A"")",TYPE=2:"ING(""D"")",TYPE=3:"CLASS(""A"")",1:"CLASS(""D"")")
"RTN","GMRAUTL3",16,0)
 .S SUB2=0 F  S SUB2=$O(@ROOT@(SUB2)) Q:'+SUB2  I @ROOT@(SUB2) S COM=COM D  ;41 Split code, added dot structure
"RTN","GMRAUTL3",17,0)
 ..I TYPE=1!(TYPE=2) D ZERO^PSN50P41(SUB2,,$$DT^XLFDT,"GMRAINFO") ;41 ingredient call
"RTN","GMRAUTL3",18,0)
 ..I TYPE=3!(TYPE=4) D C^PSN50P65(SUB2,,"GMRAINFO") ;41 drug class call
"RTN","GMRAUTL3",19,0)
 ..S COM=COM_$G(^TMP($J,"GMRAINFO",SUB2,.01)) ;41 adds data
"RTN","GMRAUTL3",20,0)
 .I $P(COM,": ",2)'="" L +^GMR(120.8,SUB) D ADCOM^GMRAFX(SUB,"O",COM) L -^GMR(120.8,SUB)
"RTN","GMRAUTL3",21,0)
 Q
"VER")
8.0^22.0
"BLD",6876,6)
^39
**END**
**END**

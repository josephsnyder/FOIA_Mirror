Released MPIF*1*53 SEQ #50
Extracted from mail message
**KIDS**:MPIF*1.0*53^

**INSTALL NAME**
MPIF*1.0*53
"BLD",2798,0)
MPIF*1.0*53^MASTER PATIENT INDEX VISTA^0^3100409^y
"BLD",2798,1,0)
^^3^3^3100407^
"BLD",2798,1,1,0)
REMOVE POTENTIAL MATCHES RETURNED EXCEPTION REFERENCES
"BLD",2798,1,2,0)
Refer to patch MPIF*1*53 in the FORUM Patch Module for a complete
"BLD",2798,1,3,0)
description.
"BLD",2798,4,0)
^9.64PA^^
"BLD",2798,6.3)
1
"BLD",2798,"ABNS",0)
^9.66A^^
"BLD",2798,"ABPKG")
^n^
"BLD",2798,"KRN",0)
^9.67PA^779.2^20
"BLD",2798,"KRN",.4,0)
.4
"BLD",2798,"KRN",.401,0)
.401
"BLD",2798,"KRN",.402,0)
.402
"BLD",2798,"KRN",.403,0)
.403
"BLD",2798,"KRN",.5,0)
.5
"BLD",2798,"KRN",.84,0)
.84
"BLD",2798,"KRN",3.6,0)
3.6
"BLD",2798,"KRN",3.8,0)
3.8
"BLD",2798,"KRN",9.2,0)
9.2
"BLD",2798,"KRN",9.8,0)
9.8
"BLD",2798,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",2798,"KRN",9.8,"NM",1,0)
MPIFBT2^^0^B51234936
"BLD",2798,"KRN",9.8,"NM",2,0)
MPIFDUP^^0^B55950325
"BLD",2798,"KRN",9.8,"NM",3,0)
MPIFQ3^^0^B16655135
"BLD",2798,"KRN",9.8,"NM","B","MPIFBT2",1)

"BLD",2798,"KRN",9.8,"NM","B","MPIFDUP",2)

"BLD",2798,"KRN",9.8,"NM","B","MPIFQ3",3)

"BLD",2798,"KRN",19,0)
19
"BLD",2798,"KRN",19.1,0)
19.1
"BLD",2798,"KRN",101,0)
101
"BLD",2798,"KRN",409.61,0)
409.61
"BLD",2798,"KRN",771,0)
771
"BLD",2798,"KRN",779.2,0)
779.2
"BLD",2798,"KRN",870,0)
870
"BLD",2798,"KRN",8989.51,0)
8989.51
"BLD",2798,"KRN",8989.52,0)
8989.52
"BLD",2798,"KRN",8994,0)
8994
"BLD",2798,"KRN","B",.4,.4)

"BLD",2798,"KRN","B",.401,.401)

"BLD",2798,"KRN","B",.402,.402)

"BLD",2798,"KRN","B",.403,.403)

"BLD",2798,"KRN","B",.5,.5)

"BLD",2798,"KRN","B",.84,.84)

"BLD",2798,"KRN","B",3.6,3.6)

"BLD",2798,"KRN","B",3.8,3.8)

"BLD",2798,"KRN","B",9.2,9.2)

"BLD",2798,"KRN","B",9.8,9.8)

"BLD",2798,"KRN","B",19,19)

"BLD",2798,"KRN","B",19.1,19.1)

"BLD",2798,"KRN","B",101,101)

"BLD",2798,"KRN","B",409.61,409.61)

"BLD",2798,"KRN","B",771,771)

"BLD",2798,"KRN","B",779.2,779.2)

"BLD",2798,"KRN","B",870,870)

"BLD",2798,"KRN","B",8989.51,8989.51)

"BLD",2798,"KRN","B",8989.52,8989.52)

"BLD",2798,"KRN","B",8994,8994)

"BLD",2798,"QUES",0)
^9.62^^
"BLD",2798,"REQB",0)
^9.611^2^2
"BLD",2798,"REQB",1,0)
MPIF*1.0*48^2
"BLD",2798,"REQB",2,0)
RG*1.0*57^2
"BLD",2798,"REQB","B","MPIF*1.0*48",1)

"BLD",2798,"REQB","B","RG*1.0*57",2)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
53^3100409
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3100409
"PKG",282,22,1,"PAH",1,1,1,0)
REMOVE POTENTIAL MATCHES RETURNED EXCEPTION REFERENCES
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*53 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MPIFBT2")
0^1^B51234936^B50661186
"RTN","MPIFBT2",1,0)
MPIFBT2 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17,21,31,43,53**;30 Apr 99;Build 1
"RTN","MPIFBT2",3,0)
 ;
"RTN","MPIFBT2",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT2",5,0)
 ;   ^DGCN(391.91 - #2751
"RTN","MPIFBT2",6,0)
 ;   EXC, START, STOP ^RGHLLOG - #2796
"RTN","MPIFBT2",7,0)
 ;   XMITFLAG^VAFCDD01 - #3493
"RTN","MPIFBT2",8,0)
 ;   $$PIVNW^VAFHPIVT - #3494
"RTN","MPIFBT2",9,0)
 ;
"RTN","MPIFBT2",10,0)
ADDPAT ;Called when response from MPI is received for messages sent.
"RTN","MPIFBT2",11,0)
 K ^XTMP($J,"MPIF") D NOW^%DTC S ST=%,X1=ST,X2=20 D C^%DTC
"RTN","MPIFBT2",12,0)
 S STP=X,^XTMP($J,"MPIF","MPIIN",0)=STP_"^"_ST_"^"_"MPI BATCH JOB"
"RTN","MPIFBT2",13,0)
 K %,X,Y,X1,X2,ST,STP N RGLOG,MPIMSG S MPIMSG=HLMTIEN
"RTN","MPIFBT2",14,0)
 D START^RGHLLOG(HLMTIEN,"","ADDPAT^MPIFBT2")
"RTN","MPIFBT2",15,0)
 D PREPMSG,PROCESS(MPIMSG),STOP^RGHLLOG(0)
"RTN","MPIFBT2",16,0)
 K ACK1,ACK2,ACK3,ACK4,HDR,MPICKG,MPIIN,MPIIPPF,MPIIT,MPINUM,MPIPPF,DA
"RTN","MPIFBT2",17,0)
 K CNTR,COM,ENC,ESC,LOCAL,MSHDR,PATID,REP,SCOM,SEP,SITE,MPIDTH,VISTDTH,MPITMP,MPICNTR,MPIFOK,^XTMP($J,"MPIF"),DGSENFLG
"RTN","MPIFBT2",18,0)
 Q
"RTN","MPIFBT2",19,0)
PREPMSG ;prepare for response
"RTN","MPIFBT2",20,0)
 N I,J,X F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFBT2",21,0)
 .S ^XTMP($J,"MPIF","MPIIN",I)=HLNODE,J=0
"RTN","MPIFBT2",22,0)
 .F  S J=$O(HLNODE(J))  Q:'J  S ^XTMP($J,"MPIF","MPIIN",I,J)=HLNODE(J)
"RTN","MPIFBT2",23,0)
 Q
"RTN","MPIFBT2",24,0)
PROCESS(MPIMSG) ;Process mesage out of array
"RTN","MPIFBT2",25,0)
 N HDR,MPICNTR S MPICNTR=1,HDR=^XTMP($J,"MPIF","MPIIN",1) ;check hdr here
"RTN","MPIFBT2",26,0)
 D CHDR(HDR,.SEP,MPICNTR,MPIMSG)
"RTN","MPIFBT2",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",28,0)
 F  S MPICNTR=$O(^XTMP($J,"MPIF","MPIIN",MPICNTR)) Q:'MPICNTR  D LOOPS(.MPICNTR,SEP,MPIMSG)
"RTN","MPIFBT2",29,0)
 Q
"RTN","MPIFBT2",30,0)
LOOPS(CNTR,SEP,MPIMSG) ;Loop in the batch
"RTN","MPIFBT2",31,0)
 K ^XTMP($J,"MPIF","MSHERR") N MSHDR,ACK1,ACK2,ACK3,ACK4,ACK5,PATID,LOCAL,MPITMP,LICN
"RTN","MPIFBT2",32,0)
 S MSHDR=^XTMP($J,"MPIF","MPIIN",+CNTR)
"RTN","MPIFBT2",33,0)
 D CHKMSH(MSHDR,.SITE,SEP,MPIMSG)
"RTN","MPIFBT2",34,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",35,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",36,0)
 S ACK1=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",37,0)
 I $P(ACK1,SEP)'="MSA" S ^XTMP($J,"MPIF","MSHERR")="NOT AN MSA SEGMENT" D EXC^RGHLLOG(203,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",38,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",39,0)
 I ACK1["AR" S ^XTMP($J,"MPIF","MSHERR")="APP REJECT ERROR" D EXC^RGHLLOG(207,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",40,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",41,0)
 I ACK1["AE" S ^XTMP($J,"MPIF","MSHERR")="APP ERROR" D EXC^RGHLLOG(208,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",42,0)
 ;ACK1 must be an AA
"RTN","MPIFBT2",43,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",44,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",45,0)
 S ACK2=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",46,0)
 I $P(ACK2,SEP)'="QAK" S ^XTMP($J,"MPIF","MSHERR")="NOT A QAK SEGMENT" D EXC^RGHLLOG(202,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",47,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",48,0)
 I ACK2["NO DATA" D
"RTN","MPIFBT2",49,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NO DATA in MPI "
"RTN","MPIFBT2",50,0)
 .;**43 NO DATA FOUND TRIGGER ADD
"RTN","MPIFBT2",51,0)
 .S MPIFRPC=1 D A28^MPIFQ3($P(ACK2,SEP,2)) K MPIFRPC
"RTN","MPIFBT2",52,0)
 .;I ACK2["POTENTIAL MATCHES" D EXC^RGHLLOG(218,"Potential matches found, please review via MPI/PD Exception Handler",$P(ACK2,SEP,2)) ;**53 MPIC_1853 Remove 218 references
"RTN","MPIFBT2",53,0)
 .;D EXC^RGHLLOG(218,"For Patient DFN="_$P(ACK2,SEP,2)_".  Use Single Patient Initialization to MPI option to manually process.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",54,0)
 .;I $D(^DPT($P(ACK2,SEP,2),0)) S LICN=$$ICNLC^MPIF001($P(ACK2,SEP,2))
"RTN","MPIFBT2",55,0)
 .; ^ create a local ICN
"RTN","MPIFBT2",56,0)
 .;I ACK2'["POTENTIAL MATCHES" D
"RTN","MPIFBT2",57,0)
 .;D EXC^RGHLLOG(209,"For Patient DFN="_$P(ACK2,SEP,2)_".  Need required fields before patient can be processed again the MPI.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",58,0)
 .;I $D(^DPT($P(ACK2,SEP,2),0)) S LICN=$$ICNLC^MPIF001($P(ACK2,SEP,2))
"RTN","MPIFBT2",59,0)
 .; ^ create a local ICN
"RTN","MPIFBT2",60,0)
 .N TACK,TCNTR S TCNTR=CNTR,CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),TACK=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",61,0)
 .I $P(TACK,SEP)="MSH" S CNTR=TCNTR
"RTN","MPIFBT2",62,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",63,0)
 S PATID=$P(ACK2,SEP,2),LOCAL=$G(^DPT(PATID,0)) ;Verify patient is in database
"RTN","MPIFBT2",64,0)
 I LOCAL']"" S ^XTMP($J,"MPIF","MSHERR")="PATIENT DFN NOT IN DATABASE- BAD " D EXC^RGHLLOG(210,"Around line number "_(CNTR*2)_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT2",65,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",66,0)
 ; **43 MOVED CNTR INCREASE TO GET TO NEXT MSH
"RTN","MPIFBT2",67,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",68,0)
 S ACK3=^XTMP($J,"MPIF","MPIIN",CNTR) ;RDF DEFINITION SEGMENT NO-OP
"RTN","MPIFBT2",69,0)
 I $P(ACK3,SEP)'="RDF" S ^XTMP($J,"MPIF","MSHERR")="NOT RDF SEGMENT" D EXC^RGHLLOG(204,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".",PATID)
"RTN","MPIFBT2",70,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",71,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",72,0)
 S RDTSEQ=1
"RTN","MPIFBT2",73,0)
 S ACK4(RDTSEQ)=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",74,0)
 I $P(ACK4(RDTSEQ),SEP)'="RDT" S ^XTMP($J,"MPIF","MSHERR")="NOT RDT SEGMENT" D EXC^RGHLLOG(205,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".",PATID)
"RTN","MPIFBT2",75,0)
 ;
"RTN","MPIFBT2",76,0)
 N RDTSQ S RDTSQ=0
"RTN","MPIFBT2",77,0)
 F  S RDTSQ=$O(^XTMP($J,"MPIF","MPIIN",CNTR,RDTSQ)) Q:'RDTSQ  D
"RTN","MPIFBT2",78,0)
 .S ACK4(RDTSEQ+1)=^XTMP($J,"MPIF","MPIIN",CNTR,RDTSQ),RDTSEQ=RDTSEQ+1
"RTN","MPIFBT2",79,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",80,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",81,0)
 I MPITMP'>0 S:$E($G(^XTMP($J,"MPIF","MPIIN",MPITMP)),1,3)="BTS" CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",82,0)
 Q:CNTR'>0
"RTN","MPIFBT2",83,0)
 D VFYRDT^MPIFBT3(.ACK4,SEP,CNTR,PATID,SITE,MPIMSG)
"RTN","MPIFBT2",84,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",85,0)
 Q:MPITMP'>0
"RTN","MPIFBT2",86,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP)
"RTN","MPIFBT2",87,0)
 I $P(ACK5,SEP)="RDT" D MULT^MPIFBT3(.CNTR,ACK5,SEP,MPIMSG,PATID)
"RTN","MPIFBT2",88,0)
 K RDTSEQ
"RTN","MPIFBT2",89,0)
 Q
"RTN","MPIFBT2",90,0)
TFLIST(TFSITE,PATID) ;adding TFSITE site for patient to Treating Facility List (#391.91)
"RTN","MPIFBT2",91,0)
 I $G(TFSITE)="" S ^XTMP($J,"MPIF","MSHERR")="Treating Facility = null" D EXC^RGHLLOG(212,"DFN = "_PATID_" Treating Facility = Null",PATID) Q
"RTN","MPIFBT2",92,0)
 S TFSITE=$$LKUP^XUAF4(TFSITE)
"RTN","MPIFBT2",93,0)
 Q:+TFSITE'>0
"RTN","MPIFBT2",94,0)
 Q:$D(^DGCN(391.91,"APAT",PATID,TFSITE))
"RTN","MPIFBT2",95,0)
 K DD,DO N DIC,X,Y L +^DGCN(391.91,0):60
"RTN","MPIFBT2",96,0)
 I '$T D EXC^RGHLLOG(212,"Unable to Lock Treating Facility file to add patient DFN="_PATID_" Facility= "_TFSITE,PATID) Q
"RTN","MPIFBT2",97,0)
 S DIC="^DGCN(391.91,",DIC("DR")=".02///`"_TFSITE,X=PATID,DIC(0)="LQZ"
"RTN","MPIFBT2",98,0)
 I $D(^DGCN(391.91,"APAT",PATID,TFSITE)) L -^DGCN(391.91,0) Q
"RTN","MPIFBT2",99,0)
 D FILE^DICN L -^DGCN(391.91,0)
"RTN","MPIFBT2",100,0)
 I +Y=-1,'$D(^DGCN(391.91,"APAT",PATID,TFSITE)) S ^XTMP($J,"MPIF","MSHERR")="Treating Facility Add Failed" D EXC^RGHLLOG(212,"DFN= "_PATID_"  Treating Facility= "_TFSITE_"  failed when adding an entry to the Treating Facility file.",PATID)
"RTN","MPIFBT2",101,0)
 K DD,DO,DIC,X,Y
"RTN","MPIFBT2",102,0)
 Q
"RTN","MPIFBT2",103,0)
TFUPDT(PATID,MPIMSG,CNTR) ;treating facility update message to pivot file
"RTN","MPIFBT2",104,0)
 N ERR,TRANS,EVDT,X,Y,%
"RTN","MPIFBT2",105,0)
 D NOW^%DTC S EVDT=% K %,X,Y
"RTN","MPIFBT2",106,0)
 S ERR=$$PIVNW^VAFHPIVT(PATID,EVDT,5,PATID_";DPT(")
"RTN","MPIFBT2",107,0)
 I +ERR<1 D EXC^RGHLLOG(212,"When trying to add Patient (DFN)"_PATID_"   message# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT2",108,0)
 Q:+ERR<1
"RTN","MPIFBT2",109,0)
 D XMITFLAG^VAFCDD01("",+ERR)
"RTN","MPIFBT2",110,0)
 Q
"RTN","MPIFBT2",111,0)
CHDR(HDR,SEP,CNTR,MPIMSG) ;Only process Batch message responses
"RTN","MPIFBT2",112,0)
 I $P(HDR,"^")'="BHS" S ^XTMP($J,"MPIF","MSHERR")="BHS SEGMENT MISSING" D EXC^RGHLLOG(200,"for message "_MPIMSG_".  The segment contains "_HDR)
"RTN","MPIFBT2",113,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",114,0)
 S SEP=$G(HL("FS")) ;get field sep, and encoding characters
"RTN","MPIFBT2",115,0)
 I SEP="" S ^XTMP($J,"MPIF","MSHERR")="Missing field seperator" D EXC^RGHLLOG(200,"Missing field seperator")
"RTN","MPIFBT2",116,0)
 Q
"RTN","MPIFBT2",117,0)
CHKMSH(MSHDR,SITE,SEP,MPIMSG) ;VERIFY MSH
"RTN","MPIFBT2",118,0)
 I $P(MSHDR,SEP)="BTS" S ^XTMP($J,"MPIF","MSHERR")="BTS FOUND" Q
"RTN","MPIFBT2",119,0)
 S:$P(MSHDR,SEP)'="MSH" ^XTMP($J,"MPIF","MSHERR")="NOT MSH HEADER   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",120,0)
 S:$E(MSHDR,4)'=SEP ^XTMP($J,"MPIF","MSHERR")="FIELD SEPARATOR MISMATCH   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",121,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(201,$G(^XTMP($J,"MPIF","MSHERR")))
"RTN","MPIFBT2",122,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",123,0)
 S SITE=$P(MSHDR,SEP,6)
"RTN","MPIFBT2",124,0)
 I SITE="" S ^XTMP($J,"MPIF","MSHERR")="SITE NOT IN MSH"
"RTN","MPIFBT2",125,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(8,"MSH Doesn't Have SITE as 6th piece.   MESSAGE# "_MPIMSG)
"RTN","MPIFBT2",126,0)
 Q
"RTN","MPIFDUP")
0^2^B55950325^B64880592
"RTN","MPIFDUP",1,0)
MPIFDUP ;BIRM/CMC-RESOLVE DUP ACTION ;DEC 2, 2005
"RTN","MPIFDUP",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**43,46,48,53**;30 Apr 99;Build 1
"RTN","MPIFDUP",3,0)
 ;
"RTN","MPIFDUP",4,0)
POT ;EXCEPTION HANDLER CALLS HERE ;**53 MPIC_1853 The POT module is obsolete and is no longer being called.
"RTN","MPIFDUP",5,0)
 ;Potential Match on MPI, Query MPI, resolve duplicate if needed. **43 Added this entry point
"RTN","MPIFDUP",6,0)
 ; Only available when Exception Being Reviewed is Potential Match
"RTN","MPIFDUP",7,0)
 ;N PELV,PTEN
"RTN","MPIFDUP",8,0)
 ;S PTEN=$P(DATA,"^",10)
"RTN","MPIFDUP",9,0)
 ;I '$D(^RGHL7(991.1,"ADFN",218,DFN)) W !,"Potential Match Review Option is Only Available for Potential Match Exceptions" H 5 S VALMBCK="R" Q
"RTN","MPIFDUP",10,0)
 ;I $D(^RGHL7(991.1,"ADFN",218,DFN,PTEN)) S SUB=$O(^RGHL7(991.1,"ADFN",218,DFN,PTEN,"")) I $P($G(^RGHL7(991.1,PTEN,SUB,1,0)),"^",5)=1 W !,"Potential Match Review is Only Available for Exceptions still pending." H 5 S VALMBCK="R" Q
"RTN","MPIFDUP",11,0)
 ;S PTEN=$P(DATA,"^",10) ;IEN IN 991.1
"RTN","MPIFDUP",12,0)
 ;S PELV=$P(DATA,"^",11) ;IEN IN 991.12
"RTN","MPIFDUP",13,0)
 ;I $P($G(^RGHL7(991.1,PTEN,1,PELV,0)),"^",3)'=218 S VALMSG="Action is ONLY for POTENTIAL MATCH exceptions!",VALMBCK="R" Q
"RTN","MPIFDUP",14,0)
 ; ^**46 changed check to ensure exception is Potential Match exception
"RTN","MPIFDUP",15,0)
 ;I $E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE,"^",3) W !,"Messaging outstanding please try again in a few minutes." H 5 Q
"RTN","MPIFDUP",16,0)
 ;S VALMBCK="",MPIFRES="",MPIFINT=""
"RTN","MPIFDUP",17,0)
 ;D FULL^VALM1
"RTN","MPIFDUP",18,0)
 ;D EXC
"RTN","MPIFDUP",19,0)
 ;D PAUSE^VALM1
"RTN","MPIFDUP",20,0)
 ;K MPIFRES,MPIFINT
"RTN","MPIFDUP",21,0)
 ;N X,Y,DIR,DIE,DA,DR,IEN,IEN2,PROCDT,%,X,%I,%H
"RTN","MPIFDUP",22,0)
 ;I '$D(PROCESS) D
"RTN","MPIFDUP",23,0)
 ;.S DIR("A")="Do you want to mark this exception as processed? ",DIR(0)="YA",DIR("B")="NO" D ^DIR K DIR(0),DIR("A")
"RTN","MPIFDUP",24,0)
 ;.I Y S PROCESS=1 K X,Y
"RTN","MPIFDUP",25,0)
 ;I $D(PROCESS) D
"RTN","MPIFDUP",26,0)
 ;.;**48 CAPTURE DATE/TIME AND WHO MARKED AS PROCESSED
"RTN","MPIFDUP",27,0)
 ;.D NOW^%DTC S PROCDT=%
"RTN","MPIFDUP",28,0)
 ;.S IEN="",IEN2="",IEN=$P(DATA,"^",10),IEN2=$P(DATA,"^",11)
"RTN","MPIFDUP",29,0)
 ;.L +^RGHL7(991.1,IEN):10
"RTN","MPIFDUP",30,0)
 ;.S DA(1)=IEN,DA=IEN2,DR="6///"_1_";7///"_PROCDT_";8///"_$G(DUZ),DIE="^RGHL7(991.1,"_DA(1)_",1," D ^DIE K DIE,DA,DR
"RTN","MPIFDUP",31,0)
 ;.L -^RGHL7(991.1,IEN)
"RTN","MPIFDUP",32,0)
 ;.S $P(DATA,"^",9)=1
"RTN","MPIFDUP",33,0)
 ;K PROCESS
"RTN","MPIFDUP",34,0)
 Q
"RTN","MPIFDUP",35,0)
EXC ; Exception Entry Point
"RTN","MPIFDUP",36,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFDUP",37,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFDUP",38,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFDUP",39,0)
 S HLP("ACKTIME")=300,MPIQRYNM="POTENTIAL_DUP_RES"
"RTN","MPIFDUP",40,0)
 N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFDUP",41,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,MPIDC,SSN
"RTN","MPIFDUP",42,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFDUP",43,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1),MPIFRES=1
"RTN","MPIFDUP",44,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM)
"RTN","MPIFDUP",45,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFDUP",46,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFDUP",47,0)
 ;Create MSH
"RTN","MPIFDUP",48,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1,HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFDUP",49,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VQQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS") ;**38 changed VTQ to VQQ
"RTN","MPIFDUP",50,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFDUP",51,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFDUP",52,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFDUP",53,0)
 K HLP("ACKTIME") ;kill the HLP array set for the ack timeout
"RTN","MPIFDUP",54,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFDUP",55,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFDUP",56,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Could not connect to MPI or Timed Out.  Try again later."
"RTN","MPIFDUP",57,0)
 K ^TMP("MPIFVQQ",$J),^TMP("MPIFQ0",$J) ;array data is parsed into for display in LM
"RTN","MPIFDUP",58,0)
INIPARS ;
"RTN","MPIFDUP",59,0)
 N SEG,INDEX,SKIP,CHECK,AL,TTF2,TFLL,TF,TF2,MPIREP,MPICOMP
"RTN","MPIFDUP",60,0)
 S INDEX=0 K CHECK
"RTN","MPIFDUP",61,0)
LOOP1 ;
"RTN","MPIFDUP",62,0)
 ;process in ADT type messages
"RTN","MPIFDUP",63,0)
 N MPIX S MPIX=0 N REP,SG,MSG,MPIQUIT,MPINODE
"RTN","MPIFDUP",64,0)
 K TWODFN S MPIQUIT=0
"RTN","MPIFDUP",65,0)
 F MPIX=0:1 X "D LOOP2" D  K MPINODE,MSG Q:MPIQUIT'>0
"RTN","MPIFDUP",66,0)
 . I $D(MPINODE(1)) S SG=$E(MPINODE(1),1,3) S MSG(1)=MPINODE(1) D
"RTN","MPIFDUP",67,0)
 .. S MPIJ=1 F  S MPIJ=$O(MPINODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=MPINODE(MPIJ)
"RTN","MPIFDUP",68,0)
 .. D:SG?2A1(1A,1N) @SG
"RTN","MPIFDUP",69,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI w/VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFDUP",70,0)
 N EXC,TEXT,EXACT,EXACT2,DATA,NODE2,ICN,CHKSUM,MORE,COMMON
"RTN","MPIFDUP",71,0)
 I '$D(^TMP("MPIFVQQ",$J)) W !,"No Potential Matches Found.",!!,"Exception has been marked automatically as processed." S PROCESS=1 G EXIT
"RTN","MPIFDUP",72,0)
 I INDEX=1 D
"RTN","MPIFDUP",73,0)
 .;need to check if exact match was returned.
"RTN","MPIFDUP",74,0)
 .S DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFDUP",75,0)
 .S NODE2=$G(^TMP("MPIFVQQ",$J,INDEX,"INDICATOR"))
"RTN","MPIFDUP",76,0)
 .S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFDUP",77,0)
 .S DATA(.03)=$P(DATA,"^",4),DATA(.09)=$P(DATA,"^",3),DATA(.02)=$P(DATA,"^",11) ;DOB, SSN, SEX
"RTN","MPIFDUP",78,0)
 .S ICN=$P(DATA,"^",6),CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),DATA(991.01)=ICN,DATA(991.02)=CHKSUM,DATA(991.03)=$$LKUP^XUAF4($P(DATA,"^",5))
"RTN","MPIFDUP",79,0)
 .Q:NODE2["*"
"RTN","MPIFDUP",80,0)
 .;^ ICN is already known at this site
"RTN","MPIFDUP",81,0)
 .;check if this patient has another VISTA site now OR tfs in common
"RTN","MPIFDUP",82,0)
 .S (MORE,COMMON)=0
"RTN","MPIFDUP",83,0)
 .D COMPARE^MPIF002(DFN,INDEX,.COMMON,.MORE)
"RTN","MPIFDUP",84,0)
 .Q:COMMON!(MORE)
"RTN","MPIFDUP",85,0)
 .; check that now have an exact match returned
"RTN","MPIFDUP",86,0)
 .N MPIFD,SSN,NAME,SEX,NAME3,BIR K COMMON,MORE
"RTN","MPIFDUP",87,0)
 .D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFD",".01;.09;.02;.03","EI")
"RTN","MPIFDUP",88,0)
 .S SSN=$G(MPIFD(2,DFN,.09,"E")),NAME=$G(MPIFD(2,DFN,.01,"E")),SEX=$G(MPIFD(2,DFN,.02,"I"))
"RTN","MPIFDUP",89,0)
 .S BIR=$G(MPIFD(2,DFN,.03,"I")) I BIR]"" S BIR=$TR($$FMTE^XLFDT(BIR,"5D"),"/","-")
"RTN","MPIFDUP",90,0)
 .; if dob doesn't match -- not allowed to update ICN automatically
"RTN","MPIFDUP",91,0)
 .Q:DATA(.03)'=BIR
"RTN","MPIFDUP",92,0)
 .; if sex doesn't match -- not allowed to update ICN automatically
"RTN","MPIFDUP",93,0)
 .Q:DATA(.02)'=SEX
"RTN","MPIFDUP",94,0)
 .;if dob doesn't match -- not allowed to update ICN automatically
"RTN","MPIFDUP",95,0)
 .I SSN["P" S SSN=""
"RTN","MPIFDUP",96,0)
 .Q:DATA(.09)'=SSN
"RTN","MPIFDUP",97,0)
 .D NAME^VAFCPID2(0,.NAME,0) ;reformat name into DG 149 format
"RTN","MPIFDUP",98,0)
 .S NAME3=DATA(.01) D NAME^VAFCPID2(0,.NAME3,0) S DATA(.01)=NAME3 ;reformat name into DG 149 format
"RTN","MPIFDUP",99,0)
 .; check if Last, First MATCH if so is it a middle name vs middle initial
"RTN","MPIFDUP",100,0)
 .I $P(DATA(.01),",")=$P(NAME,",")&($P($P(NAME,",",2)," ")=$P($P(DATA(.01),",",2)," ")) D
"RTN","MPIFDUP",101,0)
 ..N MPIMID,NMMN S MPIMID=$P($P(DATA(.01),",",2)," ",2)
"RTN","MPIFDUP",102,0)
 ..S NMMN=$P($P(NAME,",",2)," ",2)
"RTN","MPIFDUP",103,0)
 ..I $L(NMMN)>1&($L(MPIMID)=1),($E(NMMN,1)=MPIMID) S EXACT=1
"RTN","MPIFDUP",104,0)
 ..I $L(MPIMID)>1&($L(NMMN)=1),($E(MPIMID,1)=NMMN) S EXACT=1
"RTN","MPIFDUP",105,0)
 .I DATA(.01)=NAME!($D(EXACT)) K DATA(.09),DATA(.01),DATA(.03) D  Q
"RTN","MPIFDUP",106,0)
 ..N PID2,ERR
"RTN","MPIFDUP",107,0)
 ..D INIT^HLFNC2("MPIF ADT-A24 SERVER",.HL)
"RTN","MPIFDUP",108,0)
 ..D BLDPID^VAFCQRY(DFN,2,"ALL",.PID2,.HL,.ERR)
"RTN","MPIFDUP",109,0)
 ..;**48 want to resolve an reject exceptions for "current" ICN
"RTN","MPIFDUP",110,0)
 ..D RESEX(DFN)
"RTN","MPIFDUP",111,0)
 ..D EDIT^MPIFQED(DFN,"DATA"),MSG3^MPIFQ3,PROMPT^MPIFQ3
"RTN","MPIFDUP",112,0)
 ..S RESLT=$$A24^MPIFA24B(DFN,.PID2) ;send a24 link icns
"RTN","MPIFDUP",113,0)
 ..S PROCESS=1
"RTN","MPIFDUP",114,0)
 I $G(PROCESS)=1 G END
"RTN","MPIFDUP",115,0)
 D START^MPIFD1(INDEX) G END
"RTN","MPIFDUP",116,0)
EXIT I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN,TWODFN,SDFN
"RTN","MPIFDUP",117,0)
 K VALMCNT,VALMLST,CCMOR,FICN H 3 W:'$D(MPIFRPC) !!
"RTN","MPIFDUP",118,0)
END K ^TMP("MPIFVQQ",$J),^TMP("MPIFQ0",$J) Q
"RTN","MPIFDUP",119,0)
 ;
"RTN","MPIFDUP",120,0)
GETDATA(DIC,DA,MPIFAR,DR,EI) ;
"RTN","MPIFDUP",121,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFDUP",122,0)
 ;DIC=file reference, DA=IEN in file, ARRAY=array for the values to be stored in, DR=fields requested, EI=external/internal values
"RTN","MPIFDUP",123,0)
 N DIQ S DIQ=MPIFAR
"RTN","MPIFDUP",124,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFDUP",125,0)
 D EN^DIQ1
"RTN","MPIFDUP",126,0)
 Q
"RTN","MPIFDUP",127,0)
LOOP2 ;
"RTN","MPIFDUP",128,0)
 N MPIDONE,MPII,MPIJ
"RTN","MPIFDUP",129,0)
 S MPII=0,MPIDONE=0
"RTN","MPIFDUP",130,0)
 F  S MPIQUIT=$O(MPIDC(MPIQUIT)) Q:'MPIQUIT  D  Q:MPIDONE
"RTN","MPIFDUP",131,0)
 . I MPIDC(MPIQUIT)="" S MPIDONE=1 Q
"RTN","MPIFDUP",132,0)
 . S MPII=MPII+1,MPINODE(MPII)=$G(MPIDC(MPIQUIT)) Q
"RTN","MPIFDUP",133,0)
 Q
"RTN","MPIFDUP",134,0)
MSH ;
"RTN","MPIFDUP",135,0)
 S MPIREP=$E(HL("ECH"),2),MPICOMP=$E(HL("ECH"),1)
"RTN","MPIFDUP",136,0)
 Q
"RTN","MPIFDUP",137,0)
MSA ;
"RTN","MPIFDUP",138,0)
 Q
"RTN","MPIFDUP",139,0)
RDF ;
"RTN","MPIFDUP",140,0)
 Q
"RTN","MPIFDUP",141,0)
QAK ;**43 added check for potential matches
"RTN","MPIFDUP",142,0)
 K MPIPOT S MPIPOT=0
"RTN","MPIFDUP",143,0)
 I MSG(1)["POTENTIAL MATCHES" S MPIPOT=1
"RTN","MPIFDUP",144,0)
 S SDFN=$P(MSG(1),HL("FS"),2)
"RTN","MPIFDUP",145,0)
 Q
"RTN","MPIFDUP",146,0)
RDT ;
"RTN","MPIFDUP",147,0)
 N NAME,ICN,BIRTHDAY,CMOR,IEN,SEG,HEREICN,STRING,LASTNAME,FRSTNAME,MIDDLE,SUFF,SEX,THISGUY
"RTN","MPIFDUP",148,0)
 S STRING="",INDEX=$G(INDEX)+1
"RTN","MPIFDUP",149,0)
 D RDT^MPIFSA3(.INDEX,.HL,.MSG)
"RTN","MPIFDUP",150,0)
 S SEG=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFDUP",151,0)
 S FRSTNAME=$P(SEG,"^",7),LASTNAME=$P(SEG,"^",2),MIDDLE=$P(SEG,"^",10),SUFF=$P(SEG,"^",15)
"RTN","MPIFDUP",152,0)
 S SSN=$P(SEG,"^",3),NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFDUP",153,0)
 I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFDUP",154,0)
 I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFDUP",155,0)
 S SEX=$P(SEG,"^",11)
"RTN","MPIFDUP",156,0)
 S ICN=$P(SEG,"^",6)
"RTN","MPIFDUP",157,0)
 S THISGUY=$$GETDFN^MPIF001(+ICN) I THISGUY=DFN Q
"RTN","MPIFDUP",158,0)
 S BIRTHDAY=$P(SEG,"^",4)
"RTN","MPIFDUP",159,0)
 S CMOR=$P(SEG,"^",5),IEN=$$IEN^XUAF4(CMOR)
"RTN","MPIFDUP",160,0)
 S CMOR=$P($$NS^XUAF4(IEN),"^")
"RTN","MPIFDUP",161,0)
 S HEREICN=$$HEREICN^MPIFQ3($P(ICN,"V",1))
"RTN","MPIFDUP",162,0)
 I HEREICN S STRING=$$SETSTR^VALM1("*",STRING,1,1),^TMP("MPIFVQQ",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFDUP",163,0)
 S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4),STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFDUP",164,0)
 S STRING=$$SETSTR^VALM1(SSN,STRING,30,9),STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFDUP",165,0)
 S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFDUP",166,0)
 S ^TMP("MPIFVQQ",$J,INDEX,0)=STRING,^TMP("MPIFVQQ",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFDUP",167,0)
 Q
"RTN","MPIFDUP",168,0)
RESEX(DFN,POT) ;look for any pv reject (234) exceptions and resolve them for this DFN
"RTN","MPIFDUP",169,0)
 ;IF POT IS SET TO 2 LOOK FOR ANY POTENTIAL MATCH (218) EXCEPTIONS AND RESOLVE THEM FOR THIS DFN
"RTN","MPIFDUP",170,0)
 ;**48 CREATED THIS API
"RTN","MPIFDUP",171,0)
 N IEN,DA,DR,PROCDT,DIE,IEN2
"RTN","MPIFDUP",172,0)
 S IEN=0
"RTN","MPIFDUP",173,0)
 F  S IEN=$O(^RGHL7(991.1,"ADFN",234,DFN,IEN)) Q:IEN=""  D
"RTN","MPIFDUP",174,0)
 .S IEN2=$O(^RGHL7(991.1,"ADFN",234,DFN,IEN,""))
"RTN","MPIFDUP",175,0)
 .Q:$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",5)=1  ;**ALREADY MARKED AS PROCESSED
"RTN","MPIFDUP",176,0)
 .D NOW^%DTC S PROCDT=%
"RTN","MPIFDUP",177,0)
 .L +^RGHL7(991.1,IEN):10
"RTN","MPIFDUP",178,0)
 .S DA(1)=IEN,DA=IEN2,DR="6///"_1_";7///"_PROCDT_";8///"_$G(DUZ),DIE="^RGHL7(991.1,"_DA(1)_",1," D ^DIE K DIE,DA,DR
"RTN","MPIFDUP",179,0)
 .L -^RGHL7(991.1,IEN)
"RTN","MPIFDUP",180,0)
 ;
"RTN","MPIFDUP",181,0)
 ;I $G(POT)=2 D  ;**53 MPIC_1853 Remove 218 references
"RTN","MPIFDUP",182,0)
 ;.S IEN=0
"RTN","MPIFDUP",183,0)
 ;.F  S IEN=$O(^RGHL7(991.1,"ADFN",218,DFN,IEN)) Q:IEN=""  D
"RTN","MPIFDUP",184,0)
 ;..S IEN2=$O(^RGHL7(991.1,"ADFN",218,DFN,IEN,""))
"RTN","MPIFDUP",185,0)
 ;..Q:$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",5)=1  ;**ALREADY MARKED AS PROCESSED
"RTN","MPIFDUP",186,0)
 ;..D NOW^%DTC S PROCDT=%
"RTN","MPIFDUP",187,0)
 ;..L +^RGHL7(991.1,IEN):10
"RTN","MPIFDUP",188,0)
 ;..S DA(1)=IEN,DA=IEN2,DR="6///"_1_";7///"_PROCDT_";8///"_$G(DUZ),DIE="^RGHL7(991.1,"_DA(1)_",1," D ^DIE K DIE,DA,DR
"RTN","MPIFDUP",189,0)
 ;..L -^RGHL7(991.1,IEN)
"RTN","MPIFDUP",190,0)
 Q
"RTN","MPIFQ3")
0^3^B16655135^B19268712
"RTN","MPIFQ3",1,0)
MPIFQ3 ;BIRM/CMC-QUERY LIST MANAGER FUNCTIONS ;APR 28, 2003
"RTN","MPIFQ3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**28,43,53**;30 Apr 99;Build 1
"RTN","MPIFQ3",3,0)
 ;
"RTN","MPIFQ3",4,0)
MSG(LOCSSN,LOCNAME,MPISSN,MPINAME,MPIDOB,LOCDOB) ;
"RTN","MPIFQ3",5,0)
 W !!!,"Local SSN = "_LOCSSN,?40,"MPI SSN = "_MPISSN
"RTN","MPIFQ3",6,0)
 W !,"Local NAME = "_LOCNAME,?40,"MPI NAME = "_MPINAME
"RTN","MPIFQ3",7,0)
 W !,"Local DATE OF BIRTH = "_LOCDOB,?40,"MPI DATE OF BIRTH = "_MPIDOB
"RTN","MPIFQ3",8,0)
 Q
"RTN","MPIFQ3",9,0)
MSG3 W !!,"Updating ICN and CMOR"
"RTN","MPIFQ3",10,0)
 Q
"RTN","MPIFQ3",11,0)
MSG1 W !!,"You are attempting to assign an ICN that has already been assigned",!,"to another patient in your Patient file."
"RTN","MPIFQ3",12,0)
 W !,"An exception will be recorded noting that these 2 patients ",!,"need to be reviewed to determine if they are duplicates."
"RTN","MPIFQ3",13,0)
 Q
"RTN","MPIFQ3",14,0)
MSG2 W !!,"You have selected a patient from the list of potential matches",!," where there is a difference found between your data and the MPI."
"RTN","MPIFQ3",15,0)
 W !," Are you sure this is the correct patient?"
"RTN","MPIFQ3",16,0)
 Q
"RTN","MPIFQ3",17,0)
MSG5 W !!,"No Action Taken"
"RTN","MPIFQ3",18,0)
 Q
"RTN","MPIFQ3",19,0)
MSG4 W !!,"When you reach the MPI QUERY RESULTS screen, the software has"
"RTN","MPIFQ3",20,0)
 W !,"queried the Master Patient Index, for possible matches to the patient"
"RTN","MPIFQ3",21,0)
 W !,"you are adding, or have selected (pre-existing record).",!!,"The MPI has returned a list of possible matches for that patient."
"RTN","MPIFQ3",22,0)
 W !,"An '*' indicates the Integration Control Number of a patient",!,"on the list already matches one in your PATIENT (#2) file."
"RTN","MPIFQ3",23,0)
 W !,"To select a patient from the list, choose SE."
"RTN","MPIFQ3",24,0)
 I '$D(MPIFDUP) W !,"If the patients listed as potential matches are not the same patient",!,"select NEW to create a new entry on the MPI for this patient."
"RTN","MPIFQ3",25,0)
 W !,"To view all data for a patient in the list of possible matches",!,"from the MPI, select MPI."
"RTN","MPIFQ3",26,0)
 W !,"To view additional data for a patient in the list of possible",!,"matches from the CMOR site, select CMR."
"RTN","MPIFQ3",27,0)
 I $D(MPIFDUP) D
"RTN","MPIFQ3",28,0)
 .W !,"If the patients listed as potential matches are not the same as"
"RTN","MPIFQ3",29,0)
 .W !,"your patient, there is nothing for you to do.  Therefore, you may",!,"wish to mark the exception as processed."
"RTN","MPIFQ3",30,0)
 Q
"RTN","MPIFQ3",31,0)
PROMPT ;
"RTN","MPIFQ3",32,0)
 W !!
"RTN","MPIFQ3",33,0)
 S DIR("A")="Hit the Enter key, to Continue ",DIR(0)="EA"
"RTN","MPIFQ3",34,0)
 D ^DIR K DIR(0),DIR("A")
"RTN","MPIFQ3",35,0)
 Q
"RTN","MPIFQ3",36,0)
PROMPT1() ;
"RTN","MPIFQ3",37,0)
 N DIR,X,Y
"RTN","MPIFQ3",38,0)
 W !
"RTN","MPIFQ3",39,0)
 S DIR("A")="Are you sure this is the correct patient? Enter YES or NO ",DIR(0)="YA"
"RTN","MPIFQ3",40,0)
 D ^DIR K DIR(0),DIR("A")
"RTN","MPIFQ3",41,0)
 Q Y
"RTN","MPIFQ3",42,0)
HERESSN(SSN) ;
"RTN","MPIFQ3",43,0)
 N DFN
"RTN","MPIFQ3",44,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ3",45,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ3",46,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ3",47,0)
 Q DFN
"RTN","MPIFQ3",48,0)
CHECK(DFN) ;
"RTN","MPIFQ3",49,0)
 N CHECK
"RTN","MPIFQ3",50,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"CHECK",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ3",51,0)
 I $G(CHECK(2,DFN,.01))']"" Q 0
"RTN","MPIFQ3",52,0)
 I $G(CHECK(2,DFN,.02))']"" Q 0
"RTN","MPIFQ3",53,0)
 I $G(CHECK(2,DFN,.03))']"" Q 0
"RTN","MPIFQ3",54,0)
 I $G(CHECK(2,DFN,.09))']"" Q 0
"RTN","MPIFQ3",55,0)
 I $G(CHECK(2,DFN,.301))']"" Q 0
"RTN","MPIFQ3",56,0)
 I $G(CHECK(2,DFN,391))']"" Q 0
"RTN","MPIFQ3",57,0)
 I $G(CHECK(2,DFN,1901))']"" Q 0
"RTN","MPIFQ3",58,0)
 Q 1
"RTN","MPIFQ3",59,0)
TF(DFN,ARR) ;Add you to TF list and trigger TF and Sub msgs
"RTN","MPIFQ3",60,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE,1)
"RTN","MPIFQ3",61,0)
 N RESLT
"RTN","MPIFQ3",62,0)
 S RESLT=$$A24^MPIFA24B(DFN)
"RTN","MPIFQ3",63,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN)
"RTN","MPIFQ3",64,0)
 Q
"RTN","MPIFQ3",65,0)
 ;
"RTN","MPIFQ3",66,0)
A28(DFN) ;
"RTN","MPIFQ3",67,0)
 S ICN=$$A28^MPIFA28(DFN)
"RTN","MPIFQ3",68,0)
 I +ICN>0 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Message sent to MPI requesting Patient to be added."
"RTN","MPIFQ3",69,0)
 Q
"RTN","MPIFQ3",70,0)
LOCAL(DFN) ;
"RTN","MPIFQ3",71,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ3",72,0)
 N ICN S ICN=$$ICNLC^MPIF001(DFN) ;don't assign local if exists
"RTN","MPIFQ3",73,0)
 Q
"RTN","MPIFQ3",74,0)
HEREICN(ICN) ;
"RTN","MPIFQ3",75,0)
 Q:$G(ICN)="" 0
"RTN","MPIFQ3",76,0)
 N DFN S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ3",77,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ3",78,0)
 Q DFN
"RTN","MPIFQ3",79,0)
LOC2(DFN) ;**53 MPIC_1853 The LOC2 module is obsolete and is no longer being called.
"RTN","MPIFQ3",80,0)
 ;W:'$D(MPIFRPC) !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ3",81,0)
 ;D START^RGHLLOG(),EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN),STOP^RGHLLOG()
"RTN","MPIFQ3",82,0)
 ;D LOCAL(DFN)
"RTN","MPIFQ3",83,0)
 Q
"VER")
8.0^22.0
"BLD",2798,6)
^50
**END**
**END**

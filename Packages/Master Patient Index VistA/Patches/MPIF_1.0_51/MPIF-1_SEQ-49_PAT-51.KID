Released MPIF*1*51 SEQ #49
Extracted from mail message
**KIDS**:MPIF*1.0*51^

**INSTALL NAME**
MPIF*1.0*51
"BLD",2574,0)
MPIF*1.0*51^MASTER PATIENT INDEX VISTA^0^3100511^y
"BLD",2574,1,0)
^^4^4^3100414^
"BLD",2574,1,1,0)
 
"BLD",2574,1,2,0)
IDENTITY MANAGEMENT ISSUES FOR HDR II / CDS
"BLD",2574,1,3,0)
Refer to patch MPIF*1*51 in the FORUM Patch Module for a complete
"BLD",2574,1,4,0)
description.
"BLD",2574,4,0)
^9.64PA^^
"BLD",2574,6.3)
3
"BLD",2574,"ABNS",0)
^9.66A^^
"BLD",2574,"ABPKG")
n^n^
"BLD",2574,"INID")
^n
"BLD",2574,"INIT")
MPIF51P
"BLD",2574,"KRN",0)
^9.67PA^8989.52^19
"BLD",2574,"KRN",.4,0)
.4
"BLD",2574,"KRN",.401,0)
.401
"BLD",2574,"KRN",.402,0)
.402
"BLD",2574,"KRN",.403,0)
.403
"BLD",2574,"KRN",.5,0)
.5
"BLD",2574,"KRN",.84,0)
.84
"BLD",2574,"KRN",3.6,0)
3.6
"BLD",2574,"KRN",3.8,0)
3.8
"BLD",2574,"KRN",9.2,0)
9.2
"BLD",2574,"KRN",9.8,0)
9.8
"BLD",2574,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",2574,"KRN",9.8,"NM",1,0)
MPIFA40^^0^B15017531
"BLD",2574,"KRN",9.8,"NM",2,0)
MPIFA24B^^0^B11247511
"BLD",2574,"KRN",9.8,"NM",3,0)
MPIF51P^^0^B31150065
"BLD",2574,"KRN",9.8,"NM","B","MPIF51P",3)

"BLD",2574,"KRN",9.8,"NM","B","MPIFA24B",2)

"BLD",2574,"KRN",9.8,"NM","B","MPIFA40",1)

"BLD",2574,"KRN",19,0)
19
"BLD",2574,"KRN",19.1,0)
19.1
"BLD",2574,"KRN",101,0)
101
"BLD",2574,"KRN",409.61,0)
409.61
"BLD",2574,"KRN",771,0)
771
"BLD",2574,"KRN",870,0)
870
"BLD",2574,"KRN",8989.51,0)
8989.51
"BLD",2574,"KRN",8989.52,0)
8989.52
"BLD",2574,"KRN",8994,0)
8994
"BLD",2574,"KRN","B",.4,.4)

"BLD",2574,"KRN","B",.401,.401)

"BLD",2574,"KRN","B",.402,.402)

"BLD",2574,"KRN","B",.403,.403)

"BLD",2574,"KRN","B",.5,.5)

"BLD",2574,"KRN","B",.84,.84)

"BLD",2574,"KRN","B",3.6,3.6)

"BLD",2574,"KRN","B",3.8,3.8)

"BLD",2574,"KRN","B",9.2,9.2)

"BLD",2574,"KRN","B",9.8,9.8)

"BLD",2574,"KRN","B",19,19)

"BLD",2574,"KRN","B",19.1,19.1)

"BLD",2574,"KRN","B",101,101)

"BLD",2574,"KRN","B",409.61,409.61)

"BLD",2574,"KRN","B",771,771)

"BLD",2574,"KRN","B",870,870)

"BLD",2574,"KRN","B",8989.51,8989.51)

"BLD",2574,"KRN","B",8989.52,8989.52)

"BLD",2574,"KRN","B",8994,8994)

"BLD",2574,"QUES",0)
^9.62^^
"BLD",2574,"REQB",0)
^9.611^2^2
"BLD",2574,"REQB",1,0)
MPIF*1.0*41^1
"BLD",2574,"REQB",2,0)
MPIF*1.0*44^1
"BLD",2574,"REQB","B","MPIF*1.0*41",1)

"BLD",2574,"REQB","B","MPIF*1.0*44",2)

"INIT")
MPIF51P
"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
51^3100511
"PKG",282,22,1,"PAH",1,1,0)
^^4^4^3100511
"PKG",282,22,1,"PAH",1,1,1,0)
 
"PKG",282,22,1,"PAH",1,1,2,0)
IDENTITY MANAGEMENT ISSUES FOR HDR II / CDS
"PKG",282,22,1,"PAH",1,1,3,0)
Refer to patch MPIF*1*51 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,4,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MPIF51P")
0^3^B31150065^n/a
"RTN","MPIF51P",1,0)
MPIF51P ;BP/CMC-MPIF*1*51 PATCH POST INSTALL ROUTINE ;5/20/09
"RTN","MPIF51P",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**51**;30 Apr 99;Build 3
"RTN","MPIF51P",3,0)
 ;
"RTN","MPIF51P",4,0)
 ;References to VA(15.3 are covered by IA #5456
"RTN","MPIF51P",5,0)
 ;
"RTN","MPIF51P",6,0)
QUE     ;
"RTN","MPIF51P",7,0)
 D BMES^XPDUTL("Post-init send A24 HL7 messages for patients related to past merge events.")
"RTN","MPIF51P",8,0)
 S QUEDUZ=$S($G(DUZ)="":.5,1:DUZ)
"RTN","MPIF51P",9,0)
 S ZTSAVE("QUEDUZ")="",ZTRTN="EN^MPIF51P",ZTDESC="MPI/PD - Sending A24s for merged records MPIF*1*51 post init"
"RTN","MPIF51P",10,0)
 S ZTIO="",ZTDTH=$$NOW^XLFDT D ^%ZTLOAD
"RTN","MPIF51P",11,0)
 I $D(ZTSK) D BMES^XPDUTL("Job was queued as Task #"_ZTSK_".")
"RTN","MPIF51P",12,0)
 ;
"RTN","MPIF51P",13,0)
QUIT     ;
"RTN","MPIF51P",14,0)
 K ZTSK S:$D(ZTQUEUED) ZTREQ="@"
"RTN","MPIF51P",15,0)
 K QUEDUZ,ZTDESC,ZTIO,ZTREQ,ZTRTN,ZTSAVE,ZTDTH
"RTN","MPIF51P",16,0)
 Q
"RTN","MPIF51P",17,0)
EN      ;TO DO ALL PARTS
"RTN","MPIF51P",18,0)
 N START,STOP,DIFF,CNT
"RTN","MPIF51P",19,0)
 K ^XTMP("MPIFP51")
"RTN","MPIF51P",20,0)
 I '$D(QUEDUZ) S QUEDUZ=DUZ I QUEDUZ="" S QUEDUZ=.5
"RTN","MPIF51P",21,0)
 S START=$$NOW^XLFDT
"RTN","MPIF51P",22,0)
 D SETUP
"RTN","MPIF51P",23,0)
 D START(QUEDUZ)
"RTN","MPIF51P",24,0)
 S STOP=$$NOW^XLFDT
"RTN","MPIF51P",25,0)
 S DIFF=($$FMDIFF^XLFDT(STOP,START,2))/3600
"RTN","MPIF51P",26,0)
 S CNT=$G(^XTMP("MPIFP51","TOTAL A24S"))
"RTN","MPIF51P",27,0)
 D EMAIL(QUEDUZ,DIFF,CNT)
"RTN","MPIF51P",28,0)
 K ^XTMP("MPIFP51")
"RTN","MPIF51P",29,0)
 K QUEDUZ
"RTN","MPIF51P",30,0)
 Q
"RTN","MPIF51P",31,0)
SETUP ;WANT TO $O THRU ^VA(15.3 -- NEED IA
"RTN","MPIF51P",32,0)
 ;^VA(15.3,2,0)=2
"RTN","MPIF51P",33,0)
 ;^VA(15.3,2,1,0)=^15.31A^159^159
"RTN","MPIF51P",34,0)
 ;^VA(15.3,2,1,1,0)=7169803^7169804
"RTN","MPIF51P",35,0)
 ;^VA(15.3,2,1,2,0)=100000011^7169922
"RTN","MPIF51P",36,0)
 ;^VA(15.3,2,1,3,0)=100000039^100000040
"RTN","MPIF51P",37,0)
 ;^VA(15.3,2,1,4,0)=7169675^17
"RTN","MPIF51P",38,0)
 N %,X,Y,FILE,EN,TO,FROM,SITE,RETURN,CNT,ENT
"RTN","MPIF51P",39,0)
 D NOW^%DTC S SITE=$P($$SITE^VASITE,"^",3),CNT=0
"RTN","MPIF51P",40,0)
 S ^XTMP("MPIFP51",0)=%+30_"^"_%_"^MPIF*1*51 POST INIT"
"RTN","MPIF51P",41,0)
 S FILE=2,EN=0
"RTN","MPIF51P",42,0)
 F  S EN=$O(^VA(15.3,FILE,EN)) Q:EN=""  D
"RTN","MPIF51P",43,0)
 .S ENT=0 F  S ENT=$O(^VA(15.3,FILE,EN,ENT)) Q:'ENT  D
"RTN","MPIF51P",44,0)
 ..S FROM=$P($G(^VA(15.3,FILE,EN,ENT,0)),"^")
"RTN","MPIF51P",45,0)
 ..S TO=$P($G(^VA(15.3,FILE,EN,ENT,0)),"^",2)
"RTN","MPIF51P",46,0)
 ..;check to see what is the primary DFN for FROM record if the TO record has a -9 node
"RTN","MPIF51P",47,0)
 ..I $D(^DPT(TO,-9)) D
"RTN","MPIF51P",48,0)
 ...K RETURN D PRIMARY^MPIFRPC3(.RETURN,SITE,FROM)
"RTN","MPIF51P",49,0)
 ...I $P(RETURN,"^")=-1 S ^XTMP("MPIFP51","ERROR",FROM)=RETURN Q
"RTN","MPIF51P",50,0)
 ...I $P(RETURN,"^")'=1 S TO=$P(RETURN,"^")
"RTN","MPIF51P",51,0)
 ..I $D(^XTMP("MPIFP51",TO)) S ^XTMP("MPIFP51",TO)=$G(^XTMP("MPIFP51",TO))_"^"_FROM
"RTN","MPIF51P",52,0)
 ..I '$D(^XTMP("MPIFP51",TO)) S ^XTMP("MPIFP51",TO)=FROM
"RTN","MPIF51P",53,0)
 ..S CNT=CNT+1
"RTN","MPIF51P",54,0)
 S ^XTMP("MPIFP51","TOTAL")=CNT
"RTN","MPIF51P",55,0)
 Q
"RTN","MPIF51P",56,0)
 ;
"RTN","MPIF51P",57,0)
START(QUEDUZ) ;HAVE ALL THE DATA NOW IN XTMP TO SEND TO MPI
"RTN","MPIF51P",58,0)
 N TO,CNT,PID2,ERR
"RTN","MPIF51P",59,0)
 S TO=0,CNT=0
"RTN","MPIF51P",60,0)
 D INIT^HLFNC2("MPIF ADT-A24 SERVER",.HL)
"RTN","MPIF51P",61,0)
 F  S TO=$O(^XTMP("MPIFP51",TO)) Q:'TO  D
"RTN","MPIF51P",62,0)
 .K PID2
"RTN","MPIF51P",63,0)
 .D BLDPID^VAFCQRY(TO,2,"1,3,5",.PID2,.HL,.ERR)
"RTN","MPIF51P",64,0)
 .D ADDDFNS(.PID2,.HL,TO)
"RTN","MPIF51P",65,0)
 .D A24^MPIFA24B(TO,.PID2,1) S CNT=CNT+1
"RTN","MPIF51P",66,0)
 S ^XTMP("MPIFP51","TOTAL A24S")=CNT
"RTN","MPIF51P",67,0)
 Q
"RTN","MPIF51P",68,0)
ADDDFNS(NPID,HL,TO)     ;ADDING DEPERATED DFNS TO PID2
"RTN","MPIF51P",69,0)
 N MSG,EN,APID,LVL,PID,X,NXT,LNGTH,LVL2,SITE,Y,%,TPID,PDFN,DFNS,DFN,TAPID
"RTN","MPIF51P",70,0)
 S EN=0,MSG="",SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIF51P",71,0)
 F  S EN=$O(NPID(EN)) Q:'EN  D
"RTN","MPIF51P",72,0)
 .I EN=1 S MSG=NPID(EN)
"RTN","MPIF51P",73,0)
 .I EN'=1 S MSG=MSG_NPID(EN)
"RTN","MPIF51P",74,0)
 S APID(2)=2,APID(3)=""
"RTN","MPIF51P",75,0)
 S APID(6)=$P(MSG,HL("FS"),6),APID(5)=""
"RTN","MPIF51P",76,0)
 S TAPID(4)=$P(MSG,HL("FS"),4)
"RTN","MPIF51P",77,0)
 I $L(TAPID(4))<246 S APID(4)=TAPID(4) S TAPID(4)=""
"RTN","MPIF51P",78,0)
 S EN=1
"RTN","MPIF51P",79,0)
AG I $L(TAPID(4))>245 D
"RTN","MPIF51P",80,0)
 .I EN=1 S APID(4)=$E(TAPID(4),1,245)
"RTN","MPIF51P",81,0)
 .I EN=1 S TAPID(4)=$E(TAPID(4),246,$L(TAPID(4)))
"RTN","MPIF51P",82,0)
 .S APID(4,EN)=$E(TAPID(4),1,245),EN=EN+1
"RTN","MPIF51P",83,0)
 .S TAPID(4)=$E(TAPID(4),246,$L(TAPID(4)))
"RTN","MPIF51P",84,0)
 I TAPID(4)'=""&($L(TAPID(4))>245) G AG
"RTN","MPIF51P",85,0)
 I EN>1 S APID(4,EN)=TAPID(4)
"RTN","MPIF51P",86,0)
 ;GET DEPRECATED DFNS
"RTN","MPIF51P",87,0)
 D NOW^%DTC S PDFN=""
"RTN","MPIF51P",88,0)
 S DFNS=$G(^XTMP("MPIFP51",TO)),HL("COMP")=$E(HL("ECH"),1),HL("SUBCOMP")=$E(HL("ECH"),4),HL("REP")=$E(HL("ECH"),2)
"RTN","MPIF51P",89,0)
 S ENT=1 F  S DFN=$P(DFNS,"^",ENT) Q:DFN=""  D
"RTN","MPIF51P",90,0)
 .S PDFN=HL("REP")_DFN_HL("COMP")_HL("COMP")_HL("COMP")_"USVHA"_HL("SUBCOMP")_HL("SUBCOMP")_"0363"_HL("COMP")_"PI"_HL("COMP")_"VA FACILITY ID"_HL("SUBCOMP")_SITE_HL("SUBCOMP")_"L"
"RTN","MPIF51P",91,0)
 .S PDFN=PDFN_HL("COMP")_HL("COMP")_$$HLDATE^HLFNC($P(%,"."))
"RTN","MPIF51P",92,0)
 .I $L($G(APID(4,EN)))+$L(PDFN)<245 S APID(4,EN)=$G(APID(4,EN))_PDFN,ENT=ENT+1 Q
"RTN","MPIF51P",93,0)
 .I $L($G(APID(4,EN)))+$L(PDFN)>245 S EN=EN+1,APID(4,EN)=PDFN,ENT=ENT+1 Q
"RTN","MPIF51P",94,0)
 ;S APID(4,EN)=APID(4,EN)_PDFN
"RTN","MPIF51P",95,0)
 K NPID
"RTN","MPIF51P",96,0)
 S NPID(1)="PID"_HL("FS")
"RTN","MPIF51P",97,0)
 S LVL=1,X=1 F  S X=$O(APID(X)) Q:'X  D
"RTN","MPIF51P",98,0)
 .S NPID(LVL)=$G(NPID(LVL))
"RTN","MPIF51P",99,0)
 .S NXT=APID(X) D
"RTN","MPIF51P",100,0)
 ..I '$O(APID(X,0)) S NXT=NXT_HL("FS")
"RTN","MPIF51P",101,0)
 ..I $L($G(NPID(LVL))_NXT)>245 D
"RTN","MPIF51P",102,0)
 ... S LNGTH=245-$L(NPID(LVL)),NPID(LVL)=NPID(LVL)_$E(NXT,1,LNGTH)
"RTN","MPIF51P",103,0)
 ... S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),LVL=LVL+1
"RTN","MPIF51P",104,0)
 ..I $L($G(NPID(LVL))_NXT)'>245 S NPID(LVL)=$G(NPID(LVL))_NXT
"RTN","MPIF51P",105,0)
 .S LVL2=0 F  S LVL2=$O(APID(X,LVL2)) Q:'LVL2  D
"RTN","MPIF51P",106,0)
 ..S NXT=APID(X,LVL2) D
"RTN","MPIF51P",107,0)
 ...I $L($G(NPID(LVL))_NXT)>245 S LNGTH=245-$L(NPID(LVL)),NPID(LVL)=NPID(LVL)_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),LVL=LVL+1
"RTN","MPIF51P",108,0)
 ...I $L($G(NPID(LVL))_NXT)'>245 S NPID(LVL)=$G(NPID(LVL))_NXT
"RTN","MPIF51P",109,0)
 ...I '$O(APID(X,LVL2)) S NPID(LVL)=NPID(LVL)_HL("FS")
"RTN","MPIF51P",110,0)
 Q
"RTN","MPIF51P",111,0)
 ;
"RTN","MPIF51P",112,0)
EMAIL(QUEDUZ,DIFF,CNT)  ;send results back to MPI
"RTN","MPIF51P",113,0)
 N XMDUZ,XMSUB,SITENM,SITENUM,MPI,XMY,XMTEXT
"RTN","MPIF51P",114,0)
 S SITENM=$P($$SITE^VASITE,"^",2),SITENUM=$P($$SITE^VASITE,"^",3)
"RTN","MPIF51P",115,0)
 S XMDUZ="MPI AUSTIN"
"RTN","MPIF51P",116,0)
 S XMSUB="MPIF*1.0*51 Post Init - "_SITENUM_"/"_SITENM
"RTN","MPIF51P",117,0)
 S XMY("G.MPI POST INIT MONITOR@MPI-AUSTIN.MED.VA.GOV")="",XMTEXT="MPI(1,"
"RTN","MPIF51P",118,0)
 S MPI(1,1)=SITENUM_"/"_SITENM_":   (Run Time = "_$J(DIFF,5,2)_" hrs)"
"RTN","MPIF51P",119,0)
 S MPI(1,2)="Processed "_$G(^XTMP("MPIFP51","TOTAL"))_" merged records"
"RTN","MPIF51P",120,0)
 S MPI(1,3)="Sent "_$G(^XTMP("MPIFP51","TOTAL A24S"))_" A24 messages"
"RTN","MPIF51P",121,0)
 S MPI(1,4)=""
"RTN","MPIF51P",122,0)
 D ^XMD
"RTN","MPIF51P",123,0)
 ;send e-mail to local user who queued this job
"RTN","MPIF51P",124,0)
 N XMDUZ,XMSUB,MPI,XMY,XMTEXT
"RTN","MPIF51P",125,0)
 S XMDUZ="MPI AUSTIN"
"RTN","MPIF51P",126,0)
 S XMSUB="MPIF*1.0*51 Post Init Complete."
"RTN","MPIF51P",127,0)
 S XMY("`"_QUEDUZ_"@"_^XMB("NETNAME"))="",XMTEXT="MPI(1,"
"RTN","MPIF51P",128,0)
 S MPI(1,1)="Post Init for patch MPIF*1.0*51 has run to completion."
"RTN","MPIF51P",129,0)
 S MPI(1,2)="You should now delete routine ^MPIF51P."
"RTN","MPIF51P",130,0)
 D ^XMD
"RTN","MPIF51P",131,0)
 Q
"RTN","MPIFA24B")
0^2^B11247511^B10894461
"RTN","MPIFA24B",1,0)
MPIFA24B ;BP/CMC-BUILD A24 ADD ME MSGS ;JULY 22, 2002
"RTN","MPIFA24B",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,28,31,25,43,44,51**;30 Apr 99;Build 3
"RTN","MPIFA24B",3,0)
 ;
"RTN","MPIFA24B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24B",7,0)
 ;
"RTN","MPIFA24B",8,0)
A24(DFN,PID2,NOA31) ;BUILD AND SEND A24 **43 added PID2 as a parameter - not required.
"RTN","MPIFA24B",9,0)
 ; if PID2 is defined it will contain the previous ICN data, passed by reference
"RTN","MPIFA24B",10,0)
 ; **51 ADDED NOA31 as a parameter to stop the sending of an A31 if set to 1
"RTN","MPIFA24B",11,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA24B",12,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA24B",13,0)
 S CNT=1
"RTN","MPIFA24B",14,0)
 D INIT^HLFNC2("MPIF ADT-A24 SERVER",.HL)
"RTN","MPIFA24B",15,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA24B",16,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24B",17,0)
 S ERR="",TCNT=0
"RTN","MPIFA24B",18,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A24",.ERR)
"RTN","MPIFA24B",19,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",20,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR)
"RTN","MPIFA24B",21,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",22,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA24B",23,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",24,0)
 I '$D(PID2) D BLDPID^VAFCQRY(DFN,2,"ALL",.PID2,.HL,.ERR) ;**43 TO ONLY BUILD 2ND PID SEGMENT IF NOT PASSED
"RTN","MPIFA24B",25,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",26,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA24B",27,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA24B",28,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",29,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA24B",30,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA24B",31,0)
 S CNT=0 F  S CNT=$O(PID2(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",32,0)
 .I CNT=1 S HLA("HLS",4)=PID2(CNT)
"RTN","MPIFA24B",33,0)
 .I CNT>1 S HLA("HLS",4,CNT-1)=PID2(CNT)
"RTN","MPIFA24B",34,0)
 S HLA("HLS",5)=$$EN1^VAFHLZPD(DFN,"1,17,21,34") ;25 ;**44 Adding Pseudo SSN Reason, 1 and 21 to ZPD segment
"RTN","MPIFA24B",35,0)
 K HLL("LINKS")
"RTN","MPIFA24B",36,0)
 D GENERATE^HLMA("MPIF ADT-A24 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA24B",37,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA24B",38,0)
 I '+RESLT S ^XTMP("MPIFA24%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A24 message to MPI for DFN "_DFN,^XTMP("MPIFA24%"_DFN,"MPI",0)="A"
"RTN","MPIFA24B",39,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA24B",40,0)
 ;**44 TRIGGER A31 TO UPDATE ANY DEMOGRAPHIC CHANGES
"RTN","MPIFA24B",41,0)
 ;**51 IF NOT SENDING A31 STOP PROCESSING
"RTN","MPIFA24B",42,0)
 I $G(NOA31)=1 Q RESLT
"RTN","MPIFA24B",43,0)
 N A31 S A31=$$A31^MPIFA31B(DFN)
"RTN","MPIFA24B",44,0)
 I $P(A31,"^",2)'="" D
"RTN","MPIFA24B",45,0)
 .;log exception about A31 not being sent
"RTN","MPIFA24B",46,0)
 .D START^RGHLLOG()
"RTN","MPIFA24B",47,0)
 .D EXC^RGHLLOG(208,$P(A31,"^",2,3),"Unable to generate A31 for DFN"_DFN,DFN)
"RTN","MPIFA24B",48,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFA24B",49,0)
 I $P(A31,"^",2)="" S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A31 message to MPI for DFN "_DFN,^XTMP("MPIFA31%"_DFN,"MPI",0)="A"
"RTN","MPIFA24B",50,0)
 Q RESLT
"RTN","MPIFA24B",51,0)
 ;
"RTN","MPIFA24B",52,0)
RT ;
"RTN","MPIFA24B",53,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA24B",54,0)
 I $P($G(MPI),"^")=-1 D START^RGHLLOG(),EXC^RGHLLOG(224,"No logical link defined for the MPI",$G(DFN)),STOP^RGHLLOG() Q
"RTN","MPIFA24B",55,0)
 S HLL("LINKS",1)="MPIF ADT-A24 CLIENT^"_MPI
"RTN","MPIFA24B",56,0)
 Q
"RTN","MPIFA24B",57,0)
RES ;
"RTN","MPIFA24B",58,0)
 N NXT,DFN
"RTN","MPIFA24B",59,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24B",60,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24B",61,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24B",62,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION --**44 stopped logging exception as MPI has already logged it.
"RTN","MPIFA24B",63,0)
 ..;D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24B",64,0)
 ..;D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24B",65,0)
 ..;D STOP^RGHLLOG(0)
"RTN","MPIFA24B",66,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24B",67,0)
 Q
"RTN","MPIFA40")
0^1^B15017531^B11051193
"RTN","MPIFA40",1,0)
MPIFA40 ;BP/CMC-BUILD A40 MERGE MESSAGE ;25 MARCH 2002
"RTN","MPIFA40",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,41,51**;30 Apr 99;Build 3
"RTN","MPIFA40",3,0)
 ;
"RTN","MPIFA40",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA40",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA40",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA40",7,0)
 ;
"RTN","MPIFA40",8,0)
A40(DFN,DFN2,PICN) ;BUILD AND SEND A40
"RTN","MPIFA40",9,0)
 ;PICN should only be passed if the primary icn is different than the one currently stored in DFN
"RTN","MPIFA40",10,0)
 N PID,PD1,EVN,PD1,MRG,MPI,RESLT,CNT,ICN1,ICN2,STN,SITA,TMP
"RTN","MPIFA40",11,0)
 D INIT^HLFNC2("MPIF ADT-A40 SERVER",.HL)
"RTN","MPIFA40",12,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA40",13,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA40",14,0)
 S ERR=""
"RTN","MPIFA40",15,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A40",.ERR)
"RTN","MPIFA40",16,0)
 Q:ERR'="" ERR
"RTN","MPIFA40",17,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR) ;**41
"RTN","MPIFA40",18,0)
 Q:ERR'="" ERR
"RTN","MPIFA40",19,0)
 I $G(PICN)'="" D 
"RTN","MPIFA40",20,0)
 .;RESET ICN IN PID TO BE THIS (PICN) PRIMARY ICN
"RTN","MPIFA40",21,0)
 .I PICN[-1 S PICN=HL("Q")
"RTN","MPIFA40",22,0)
 .I PICN'["V",PICN'=HL("Q") S PICN=PICN_"V"_$$CHECKDG^MPIFSPC(PICN)
"RTN","MPIFA40",23,0)
 .S STN=$P($$SITE^VASITE,"^",3)
"RTN","MPIFA40",24,0)
 .I $E($P(PICN,"^"),1,3)=STN S SITA=STN
"RTN","MPIFA40",25,0)
 .I $E($P(PICN,"^"),1,3)'=STN S SITA="200M"
"RTN","MPIFA40",26,0)
 .S PICN=PICN_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_SITA_SUBCOMP_"L"
"RTN","MPIFA40",27,0)
 .S TMP=$P(PID(1),HLFS,4)
"RTN","MPIFA40",28,0)
 .S $P(TMP,REP,1)=PICN
"RTN","MPIFA40",29,0)
 .S $P(PID(1),HLFS,4)=TMP
"RTN","MPIFA40",30,0)
 .S $P(PID(1),HLFS,3)=PICN
"RTN","MPIFA40",31,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA40",32,0)
 Q:ERR'="" ERR
"RTN","MPIFA40",33,0)
 D BLDMRG(DFN2,"1,7",.MRG,.HL,.ERR)
"RTN","MPIFA40",34,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA40",35,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA40",36,0)
 S HLA("HLS",4)=MRG
"RTN","MPIFA40",37,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA40",38,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA40",39,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA40",40,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA40",41,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA40",42,0)
 S HLL("LINKS",1)="MPIF ADT-A40 CLIENT^"_MPI
"RTN","MPIFA40",43,0)
 D GENERATE^HLMA("MPIF ADT-A40 SERVER","LM",1,.MPIFRSLT,"","") ;**41
"RTN","MPIFA40",44,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA40",45,0)
 S ^XTMP("MPIFA40%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"MPIA40 msg to MPI for DFN "_DFN
"RTN","MPIFA40",46,0)
 I +RESLT D
"RTN","MPIFA40",47,0)
 .S ICN1=$$GETICN^MPIF001(DFN),ICN2=$$GETICN^MPIF001(DFN2)
"RTN","MPIFA40",48,0)
 .S ^XTMP("MPIFA40%"_DFN,DFN2,"MPI",0)="A"
"RTN","MPIFA40",49,0)
 .S ^XTMP("MPIFA40%"_DFN,DFN2,"MPI",1)=ICN1_"^"_ICN2_"^"_RESLT
"RTN","MPIFA40",50,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT ;**41
"RTN","MPIFA40",51,0)
 Q RESLT
"RTN","MPIFA40",52,0)
 ;
"RTN","MPIFA40",53,0)
RES ;
"RTN","MPIFA40",54,0)
 N NXT
"RTN","MPIFA40",55,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA40",56,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA40",57,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA40",58,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA40",59,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA40",60,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA40",61,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA40",62,0)
 K ^XTMP("MPIFA40%"_DFN)
"RTN","MPIFA40",63,0)
 Q
"RTN","MPIFA40",64,0)
 ;
"RTN","MPIFA40",65,0)
BLDMRG(IEN,FLD,SEG,HL,ERR) ; bld MRG segment ONLY FIELDS 2 AND 8 SUPPORTED
"RTN","MPIFA40",66,0)
 N NODE,MPIZN,MG,X,COMP,SUBCOMP,REP,NAME,ICN,SITE
"RTN","MPIFA40",67,0)
 S COMP=$E(HL("ECH"),1),SUBCOMP=$E(HL("ECH"),4),REP=$E(HL("ECH"),2),ICN=""
"RTN","MPIFA40",68,0)
 S MPIZN=$D(^DPT(IEN,0))
"RTN","MPIFA40",69,0)
 I MPIZN="" S ERR="-1^No such DFN entry "_IEN Q
"RTN","MPIFA40",70,0)
 S SEG="MRG"
"RTN","MPIFA40",71,0)
 ;repeat prior ID's including ICN and DFN
"RTN","MPIFA40",72,0)
 S NODE=$$MPINODE^MPIFAPI(IEN)
"RTN","MPIFA40",73,0)
 I +NODE=-1 S NODE="" ;**51
"RTN","MPIFA40",74,0)
 I NODE'="" S ICN=$P(NODE,"^",1)_"V"_$P(NODE,"^",2) ;**51
"RTN","MPIFA40",75,0)
 S SITE=$P($$SITE^VASITE(),"^",3) ;**51
"RTN","MPIFA40",76,0)
 I ICN=""!(ICN="V") S ICN=HL("Q") ;**51
"RTN","MPIFA40",77,0)
 S MG(2)=ICN_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_SITE_SUBCOMP_"L"_REP_IEN_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"PI"_COMP_"VA FACILITY ID"_SUBCOMP_SITE_SUBCOMP_"L" ;**41
"RTN","MPIFA40",78,0)
 ;NAME
"RTN","MPIFA40",79,0)
 S NAME("FILE")=2,NAME("IENS")=IEN,NAME("FIELD")=.01
"RTN","MPIFA40",80,0)
 S MG(8)=$$HLNAME^XLFNAME(.NAME,"",COMP)
"RTN","MPIFA40",81,0)
 S $P(MG(8),COMP,7)="L"
"RTN","MPIFA40",82,0)
 S $P(SEG,HL("FS"),2)=MG(2)
"RTN","MPIFA40",83,0)
 S $P(SEG,HL("FS"),8)=MG(8)
"RTN","MPIFA40",84,0)
 Q
"VER")
8.0^22.0
"BLD",2574,6)
^49
**END**
**END**

Released RA*5*84 SEQ #76
Extracted from mail message
**KIDS**:RA*5.0*84^

**INSTALL NAME**
RA*5.0*84
"BLD",6612,0)
RA*5.0*84^RADIOLOGY/NUCLEAR MEDICINE^0^3080505^y
"BLD",6612,1,0)
^^3^3^3080416^^^^
"BLD",6612,1,1,0)
Patch eighty-four for the Radiology/Nuclear Medicine 5.0 software.  
"BLD",6612,1,2,0)
Please review the Description and Installation Instructions for RA*5.0*84
"BLD",6612,1,3,0)
before installing this patch.
"BLD",6612,4,0)
^9.64PA^74^2
"BLD",6612,4,74,0)
74
"BLD",6612,4,74,2,0)
^9.641^74^1
"BLD",6612,4,74,2,74,0)
RAD/NUC MED REPORTS  (File-top level)
"BLD",6612,4,74,2,74,1,0)
^9.6411^9.3^3
"BLD",6612,4,74,2,74,1,9.1,0)
TELERADIOLOGY PHYSICIAN NAME
"BLD",6612,4,74,2,74,1,9.2,0)
TELERADIOLOGY PHYSICIAN NPI
"BLD",6612,4,74,2,74,1,9.3,0)
REPORT VERIFIED BY WHOM
"BLD",6612,4,74,222)
y^n^p^^^^n^^n
"BLD",6612,4,74,224)

"BLD",6612,4,79.7,0)
79.7
"BLD",6612,4,79.7,222)
y^n^f^^^^n^^
"BLD",6612,4,79.7,224)

"BLD",6612,4,"APDD",74,74)

"BLD",6612,4,"APDD",74,74,9.1)

"BLD",6612,4,"APDD",74,74,9.2)

"BLD",6612,4,"APDD",74,74,9.3)

"BLD",6612,4,"B",74,74)

"BLD",6612,4,"B",79.7,79.7)

"BLD",6612,6.3)
13
"BLD",6612,"INI")
RA84PRE
"BLD",6612,"INIT")
RA84POS
"BLD",6612,"KRN",0)
^9.67PA^8989.52^19
"BLD",6612,"KRN",.4,0)
.4
"BLD",6612,"KRN",.401,0)
.401
"BLD",6612,"KRN",.402,0)
.402
"BLD",6612,"KRN",.403,0)
.403
"BLD",6612,"KRN",.5,0)
.5
"BLD",6612,"KRN",.84,0)
.84
"BLD",6612,"KRN",3.6,0)
3.6
"BLD",6612,"KRN",3.8,0)
3.8
"BLD",6612,"KRN",9.2,0)
9.2
"BLD",6612,"KRN",9.8,0)
9.8
"BLD",6612,"KRN",9.8,"NM",0)
^9.68A^24^17
"BLD",6612,"KRN",9.8,"NM",2,0)
RAHLR^^0^B54233244
"BLD",6612,"KRN",9.8,"NM",4,0)
RAHLO4^^0^B42844660
"BLD",6612,"KRN",9.8,"NM",5,0)
RAHLTCPB^^0^B70765098
"BLD",6612,"KRN",9.8,"NM",6,0)
RAHLRPC^^0^B16908988
"BLD",6612,"KRN",9.8,"NM",8,0)
RA84PRE^^0^B93971841
"BLD",6612,"KRN",9.8,"NM",9,0)
RAHLO^^0^B47630507
"BLD",6612,"KRN",9.8,"NM",10,0)
RAHLO3^^0^B23255414
"BLD",6612,"KRN",9.8,"NM",11,0)
RA84POS^^0^B17109950
"BLD",6612,"KRN",9.8,"NM",12,0)
RAHLRPT^^0^B65194652
"BLD",6612,"KRN",9.8,"NM",13,0)
RAHLRPTT^^0^B17479415
"BLD",6612,"KRN",9.8,"NM",14,0)
RAHLO1^^0^B58238892
"BLD",6612,"KRN",9.8,"NM",16,0)
RARTR0^^0^B48053293
"BLD",6612,"KRN",9.8,"NM",17,0)
RAHLO2^^0^B22560890
"BLD",6612,"KRN",9.8,"NM",20,0)
RAHLTCPU^^0^B2063802
"BLD",6612,"KRN",9.8,"NM",21,0)
RAHLRS1^^0^B57554802
"BLD",6612,"KRN",9.8,"NM",23,0)
RADD2^^0^B18013466
"BLD",6612,"KRN",9.8,"NM",24,0)
RAUTL1^^0^B52485172
"BLD",6612,"KRN",9.8,"NM","B","RA84POS",11)

"BLD",6612,"KRN",9.8,"NM","B","RA84PRE",8)

"BLD",6612,"KRN",9.8,"NM","B","RADD2",23)

"BLD",6612,"KRN",9.8,"NM","B","RAHLO",9)

"BLD",6612,"KRN",9.8,"NM","B","RAHLO1",14)

"BLD",6612,"KRN",9.8,"NM","B","RAHLO2",17)

"BLD",6612,"KRN",9.8,"NM","B","RAHLO3",10)

"BLD",6612,"KRN",9.8,"NM","B","RAHLO4",4)

"BLD",6612,"KRN",9.8,"NM","B","RAHLR",2)

"BLD",6612,"KRN",9.8,"NM","B","RAHLRPC",6)

"BLD",6612,"KRN",9.8,"NM","B","RAHLRPT",12)

"BLD",6612,"KRN",9.8,"NM","B","RAHLRPTT",13)

"BLD",6612,"KRN",9.8,"NM","B","RAHLRS1",21)

"BLD",6612,"KRN",9.8,"NM","B","RAHLTCPB",5)

"BLD",6612,"KRN",9.8,"NM","B","RAHLTCPU",20)

"BLD",6612,"KRN",9.8,"NM","B","RARTR0",16)

"BLD",6612,"KRN",9.8,"NM","B","RAUTL1",24)

"BLD",6612,"KRN",19,0)
19
"BLD",6612,"KRN",19,"NM",0)
^9.68A^^
"BLD",6612,"KRN",19.1,0)
19.1
"BLD",6612,"KRN",101,0)
101
"BLD",6612,"KRN",101,"NM",0)
^9.68A^4^4
"BLD",6612,"KRN",101,"NM",1,0)
RA SCIMAGE ORM^^0
"BLD",6612,"KRN",101,"NM",2,0)
RA SCIMAGE ORU^^0
"BLD",6612,"KRN",101,"NM",3,0)
RA SCIMAGE TCP REPORT^^0
"BLD",6612,"KRN",101,"NM",4,0)
RA SCIMAGE TCP SERVER RPT^^0
"BLD",6612,"KRN",101,"NM","B","RA SCIMAGE ORM",1)

"BLD",6612,"KRN",101,"NM","B","RA SCIMAGE ORU",2)

"BLD",6612,"KRN",101,"NM","B","RA SCIMAGE TCP REPORT",3)

"BLD",6612,"KRN",101,"NM","B","RA SCIMAGE TCP SERVER RPT",4)

"BLD",6612,"KRN",409.61,0)
409.61
"BLD",6612,"KRN",771,0)
771
"BLD",6612,"KRN",771,"NM",0)
^9.68A^1^1
"BLD",6612,"KRN",771,"NM",1,0)
RA-SCIMAGE-TCP^^0
"BLD",6612,"KRN",771,"NM","B","RA-SCIMAGE-TCP",1)

"BLD",6612,"KRN",870,0)
870
"BLD",6612,"KRN",870,"NM",0)
^9.68A^1^1
"BLD",6612,"KRN",870,"NM",1,0)
RA-SCIMAGE^^0
"BLD",6612,"KRN",870,"NM","B","RA-SCIMAGE",1)

"BLD",6612,"KRN",8989.51,0)
8989.51
"BLD",6612,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",6612,"KRN",8989.52,0)
8989.52
"BLD",6612,"KRN",8994,0)
8994
"BLD",6612,"KRN","B",.4,.4)

"BLD",6612,"KRN","B",.401,.401)

"BLD",6612,"KRN","B",.402,.402)

"BLD",6612,"KRN","B",.403,.403)

"BLD",6612,"KRN","B",.5,.5)

"BLD",6612,"KRN","B",.84,.84)

"BLD",6612,"KRN","B",3.6,3.6)

"BLD",6612,"KRN","B",3.8,3.8)

"BLD",6612,"KRN","B",9.2,9.2)

"BLD",6612,"KRN","B",9.8,9.8)

"BLD",6612,"KRN","B",19,19)

"BLD",6612,"KRN","B",19.1,19.1)

"BLD",6612,"KRN","B",101,101)

"BLD",6612,"KRN","B",409.61,409.61)

"BLD",6612,"KRN","B",771,771)

"BLD",6612,"KRN","B",870,870)

"BLD",6612,"KRN","B",8989.51,8989.51)

"BLD",6612,"KRN","B",8989.52,8989.52)

"BLD",6612,"KRN","B",8994,8994)

"BLD",6612,"PRE")

"BLD",6612,"QDEF")
^^^^NO^^^^NO^^YES
"BLD",6612,"QUES",0)
^9.62^^0
"BLD",6612,"REQB",0)
^9.611^4^3
"BLD",6612,"REQB",2,0)
RA*5.0*80^2
"BLD",6612,"REQB",3,0)
RA*5.0*87^2
"BLD",6612,"REQB",4,0)
RA*5.0*74^2
"BLD",6612,"REQB","B","RA*5.0*74",4)

"BLD",6612,"REQB","B","RA*5.0*80",2)

"BLD",6612,"REQB","B","RA*5.0*87",3)

"FIA",74)
RAD/NUC MED REPORTS
"FIA",74,0)
^RARPT(
"FIA",74,0,0)
74I
"FIA",74,0,1)
y^n^p^^^^n^^n
"FIA",74,0,10)

"FIA",74,0,11)

"FIA",74,0,"RLRO")

"FIA",74,0,"VR")
5.0^RA
"FIA",74,74)
1
"FIA",74,74,9.1)

"FIA",74,74,9.2)

"FIA",74,74,9.3)

"FIA",79.7)
RAD/NUC MED HL7 APPLICATION EXCEPTION
"FIA",79.7,0)
^RA(79.7,
"FIA",79.7,0,0)
79.7P
"FIA",79.7,0,1)
y^n^f^^^^n^^
"FIA",79.7,0,10)

"FIA",79.7,0,11)

"FIA",79.7,0,"RLRO")

"FIA",79.7,0,"VR")
5.0^RA
"FIA",79.7,79.7)
0
"FIA",79.7,79.72)
0
"FIA",79.7,79.721)
0
"FIA",79.7,79.7211)
0
"FIA",79.7,79.72114)
0
"INI")
RA84PRE
"INIT")
RA84POS
"KRN",101,6202,-1)
0^1
"KRN",101,6202,0)
RA SCIMAGE ORM^^^S^^^^^^^^
"KRN",101,6202,770)
^RA-SCIMAGE-TCP^^O01^^^RA-SCIMAGE^^^2.3^ACK
"KRN",101,6202,773)
0^0^0
"KRN",101,6203,-1)
0^2
"KRN",101,6203,0)
RA SCIMAGE ORU^^^S^^^^^^^^
"KRN",101,6203,770)
^RA-SCIMAGE-TCP^^R01^^^RA-SCIMAGE^^^2.3^ACK
"KRN",101,6203,773)
0^0^0
"KRN",101,6204,-1)
0^4
"KRN",101,6204,0)
RA SCIMAGE TCP SERVER RPT^^^E^^^^^^^^
"KRN",101,6204,770)
RA-SCIMAGE-TCP^^ORU^R01^^^^^^2.3^
"KRN",101,6204,775,0)
^101.0775PA^1^1
"KRN",101,6204,775,1,0)
6205
"KRN",101,6204,775,1,"^")
RA SCIMAGE TCP REPORT
"KRN",101,6205,-1)
0^3
"KRN",101,6205,0)
RA SCIMAGE TCP REPORT^^^S^^^^^^^^
"KRN",101,6205,770)
^RA-VOICE-SERVER^^R01^^^^^^2.3^ACK
"KRN",101,6205,771)
D ^RAHLTCPB
"KRN",101,6205,773)
0^0^0
"KRN",771,175,-1)
0^1
"KRN",771,175,0)
RA-SCIMAGE-TCP^a^^RAD HL7 MESSAGES^^^USA
"KRN",771,175,"EC")
^~\&
"KRN",771,175,"FS")
|
"KRN",870,105,-1)
0^1
"KRN",870,105,0)
RA-SCIMAGE^^TCP^^^^^^^^^^^^^^^^^^10
"KRN",870,105,200)
^5^^60^300^^^^^S
"KRN",870,105,400)
^^C^N^^
"MBREQ")
0
"ORD",13,870)
870;13;1;;HLLL^XPDTA1;;HLLLE^XPDIA1;;;HLLLDEL^XPDIA1(%)
"ORD",13,870,0)
HL LOGICAL LINK
"ORD",14,771)
771;14;;;HLAP^XPDTA1;HLAPF1^XPDIA1;HLAPE1^XPDIA1;HLAPF2^XPDIA1;;HLAPDEL^XPDIA1(%)
"ORD",14,771,0)
HL7 APPLICATION PARAMETER
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",18,-1)
1^1
"PKG",18,0)
RADIOLOGY/NUCLEAR MEDICINE^RA^REGISTERS PATIENTS,RECORDS EXAMS,PROFILES,AMIS REPORTS
"PKG",18,20,0)
^9.402P^^
"PKG",18,22,0)
^9.49I^1^1
"PKG",18,22,1,0)
5.0^3051109^2980407^50
"PKG",18,22,1,"PAH",1,0)
84^3080505^4627
"PKG",18,22,1,"PAH",1,1,0)
^^3^3^3080505
"PKG",18,22,1,"PAH",1,1,1,0)
Patch eighty-four for the Radiology/Nuclear Medicine 5.0 software.  
"PKG",18,22,1,"PAH",1,1,2,0)
Please review the Description and Installation Instructions for RA*5.0*84
"PKG",18,22,1,"PAH",1,1,3,0)
before installing this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
17
"RTN","RA84POS")
0^11^B17109950^n/a
"RTN","RA84POS",1,0)
RA84POS ;Hines OI/GJC - Post-init Driver, patch 84 ;01/07/06  06:32
"RTN","RA84POS",2,0)
VERSION ;;5.0;Radiology/Nuclear Medicine;**84**;Mar 16, 1998;Build 13
"RTN","RA84POS",3,0)
 ;
"RTN","RA84POS",4,0)
 ;Integration Agreements
"RTN","RA84POS",5,0)
 ;----------------------
"RTN","RA84POS",6,0)
 ;$$FIND1^DIC(2051); FILE^DIE(2053); UPDATE^DIE(2053); BMES^XPDUTL(10141)
"RTN","RA84POS",7,0)
 ;
"RTN","RA84POS",8,0)
EN ;Entry point
"RTN","RA84POS",9,0)
 N DIERR,RAERR,RAF,RAFDA,RAHLAPP,RAIEN,RATXT,RAY
"RTN","RA84POS",10,0)
 S:'$D(U) U="^"
"RTN","RA84POS",11,0)
 ;Find the IEN of 'RA-SCIMAGE-TCP' in the RAD/NUC MED HL7 APPLICATION EXCEPTION (#79.7) file.
"RTN","RA84POS",12,0)
 ;Is 'RA-SCIMAGE-TCP' already in 79.7? If not find the IEN in file 771 & add it to file 79.7.
"RTN","RA84POS",13,0)
 S RAHLAPP=$$FIND1^DIC(79.7,"","X","RA-SCIMAGE-TCP")
"RTN","RA84POS",14,0)
 I 'RAHLAPP D
"RTN","RA84POS",15,0)
 .S RAHLAPP=$$FIND1^DIC(771,"","X","RA-SCIMAGE-TCP")
"RTN","RA84POS",16,0)
 .S RAFDA(79.7,"+1,",.01)=RAHLAPP,RAFDA(79.7,"+1,",1)=1
"RTN","RA84POS",17,0)
 .S RAIEN(1)=RAHLAPP D UPDATE^DIE("","RAFDA","RAIEN","RAERR")
"RTN","RA84POS",18,0)
 .S:$G(RAIEN(1))'>0 RAERR("DIERR")=""
"RTN","RA84POS",19,0)
 .Q
"RTN","RA84POS",20,0)
 ;
"RTN","RA84POS",21,0)
 I ($D(RAERR("DIERR"))#2) D  Q
"RTN","RA84POS",22,0)
 .S RATXT(1)="'RA-SCIMAGE-TCP' is not a record in the RAD/NUC MED HL7 APPLICATION EXCEPTION"
"RTN","RA84POS",23,0)
 .S RATXT(2)="(#79.7) file. Please contact the national Radiology development team about this"
"RTN","RA84POS",24,0)
 .S RATXT(3)="issue." D BMES^XPDUTL(.RATXT)
"RTN","RA84POS",25,0)
 .Q
"RTN","RA84POS",26,0)
 ;
"RTN","RA84POS",27,0)
 ;The 'TELERADIOLOGY APPLICATION' (fld: 1) for 'RA-SCIMAGE-TCP' should be defined as '1' or Yes
"RTN","RA84POS",28,0)
 I $P(^RA(79.7,RAHLAPP,0),U,2)'=1 D
"RTN","RA84POS",29,0)
 .S RAFDA(79.7,RAHLAPP_",",1)=1 ;internal value
"RTN","RA84POS",30,0)
 .D FILE^DIE("","RAFDA","RAERR") S RATXT(1)=""
"RTN","RA84POS",31,0)
 .S:($D(RAERR("DIERR")))#2 RATXT(2)="Error setting 'RA-SCIMAGE-TCP' as a 'TELERADIOLOGY' application type."
"RTN","RA84POS",32,0)
 .S:$G(RATXT(2))="" RATXT(2)="'RA-SCIMAGE-TCP' is now defined as a 'TELERADIOLOGY' application type."
"RTN","RA84POS",33,0)
 .D BMES^XPDUTL(.RATXT)
"RTN","RA84POS",34,0)
 .Q
"RTN","RA84POS",35,0)
 ;
"RTN","RA84POS",36,0)
 ;The 'APPLICATION TYPE' (fld: 1.3) for 'RA-SCIMAGE-TCP' should be defined as 'S' for
"RTN","RA84POS",37,0)
 ;'Speech Recognition'.
"RTN","RA84POS",38,0)
 I $P(^RA(79.7,RAHLAPP,0),U,5)'="S" D
"RTN","RA84POS",39,0)
 .S RAFDA(79.7,RAHLAPP_",",1.3)="S" ;internal value
"RTN","RA84POS",40,0)
 .D FILE^DIE("","RAFDA","RAERR") S RATXT(1)=""
"RTN","RA84POS",41,0)
 .S:($D(RAERR("DIERR")))#2 RATXT(2)="Error setting 'RA-SCIMAGE-TCP' as a 'Speech Recognition' APPLICATION TYPE."
"RTN","RA84POS",42,0)
 .S:$G(RATXT(2))="" RATXT(2)="'RA-SCIMAGE-TCP' is now defined as a 'Speech Recognition' APPLICATION TYPE."
"RTN","RA84POS",43,0)
 .D BMES^XPDUTL(.RATXT)
"RTN","RA84POS",44,0)
 .Q
"RTN","RA84POS",45,0)
 ;
"RTN","RA84POS",46,0)
 K DIERR,RAERR,RAFDA,RATXT
"RTN","RA84POS",47,0)
 ;update the following fields in the RAD/NUC MED HL7 APPLICATION EXCEPTION
"RTN","RA84POS",48,0)
 ;(#79.7) file with the most recent Dx Codes (999-1003 series implemeted with V9)
"RTN","RA84POS",49,0)
 ; DEFAULT DX FOR 'R' REPORT (#2.1)
"RTN","RA84POS",50,0)
 ; DEFAULT DX FOR 'F' REPORT (#2.2)
"RTN","RA84POS",51,0)
 I $G(^RA(78.3,999,0))="TELERADIOLOGY, NOT YET DICTATED^^N^n" D
"RTN","RA84POS",52,0)
 .S RAFDA(79.7,RAHLAPP_",",2.1)=999
"RTN","RA84POS",53,0)
 .I $G(^RA(78.3,1000,0))="NO ALERT REQUIRED^^N^n" S RAF=1,RAFDA(79.7,RAHLAPP_",",2.2)=1000
"RTN","RA84POS",54,0)
 .D FILE^DIE("","RAFDA","RAERR")
"RTN","RA84POS",55,0)
 .I ($D(RAERR("DIERR")))#2 D
"RTN","RA84POS",56,0)
 ..S RAY=0 F  S RAY=$O(RAERR("DIERR",RAY)) Q:'RAY  S RATXT(RAY)=$G(RAERR("DIERR",RAY,"TEXT",1))
"RTN","RA84POS",57,0)
 ..Q
"RTN","RA84POS",58,0)
 .E  D
"RTN","RA84POS",59,0)
 ..S RATXT(1)="'TELERADIOLOGY, NOT YET DICTATED' added as the 'DEFAULT DX FOR 'R' REPORT' value."
"RTN","RA84POS",60,0)
 ..S:$G(RAF)=1 RATXT(2)="'NO ALERT REQUIRED' added as the 'DEFAULT DX FOR 'F' REPORT' value."
"RTN","RA84POS",61,0)
 ..Q
"RTN","RA84POS",62,0)
 .D BMES^XPDUTL(.RATXT)
"RTN","RA84POS",63,0)
 .Q
"RTN","RA84POS",64,0)
 ;
"RTN","RA84POS",65,0)
ILOC ; assign active imaging locations to RADIOLOGY,OUTSIDE SERVICE
"RTN","RA84POS",66,0)
 ;
"RTN","RA84POS",67,0)
 N DIERR,RAERR,RAFDA,RAIEN,RATODAY
"RTN","RA84POS",68,0)
 S (RAIEN,RAIEN(0))=$$FIND1^DIC(200,"","X","RADIOLOGY,OUTSIDE SERVICE"),RATODAY=$$DT^XLFDT()
"RTN","RA84POS",69,0)
 I RAIEN=0!($D(DIERR)#2) D  Q
"RTN","RA84POS",70,0)
 .D BMES^XPDUTL("Failed NEW PERSON file lookup on: RADIOLOGY,OUTSIDE SERVICE") Q
"RTN","RA84POS",71,0)
 ;
"RTN","RA84POS",72,0)
 ;if this i-loc have been assigned to RADIOLOGY,OUTSIDE SERVICE quit (do not create duplicates)
"RTN","RA84POS",73,0)
 Q:$O(^VA(200,RAIEN,"RAL",0))
"RTN","RA84POS",74,0)
 ;
"RTN","RA84POS",75,0)
 ;find only active radiology imaging locations...
"RTN","RA84POS",76,0)
 N RAX,RAY S RAY=0,RAIEN=","_RAIEN_","
"RTN","RA84POS",77,0)
 F  S RAY=$O(^RA(79.1,RAY)) Q:'RAY  S RAX=$G(^(RAY,0)) D
"RTN","RA84POS",78,0)
 .I $P(RAX,U,19),($P(RAX,U,19)'>RATODAY) Q  ;inactive location
"RTN","RA84POS",79,0)
 .S RAFDA(200.074,"+"_RAY_RAIEN,.01)=RAY Q
"RTN","RA84POS",80,0)
 ;
"RTN","RA84POS",81,0)
 Q:'($D(RAFDA(200.074))\10)  ;quit there is no data to file
"RTN","RA84POS",82,0)
 ;
"RTN","RA84POS",83,0)
 ;lock the RADIOLOGY,OUTSIDE SERVICE record in file 200, exit gracefully if locked by another
"RTN","RA84POS",84,0)
 L +^VA(200,RAIEN(0)):$G(DILOCKTM,3)
"RTN","RA84POS",85,0)
 I '$T D BMES^XPDUTL("RADIOLOGY,OUTSIDE SERVICE is locked by another user!") Q
"RTN","RA84POS",86,0)
 ;
"RTN","RA84POS",87,0)
 D UPDATE^DIE("","RAFDA","","RAERR")
"RTN","RA84POS",88,0)
 I $D(RAERR("DIERR"))#2 D
"RTN","RA84POS",89,0)
 .N RATXT S RATXT(1)="Error assigning imaging locations to RADIOLOGY,OUTSIDE SERVICE."
"RTN","RA84POS",90,0)
 .S RATXT(2)=$G(RAERR("DIERR","1","TEXT",1)) D BMES^XPDUTL(.RATXT) Q
"RTN","RA84POS",91,0)
 E  D BMES^XPDUTL("Imaging locations have been assigned to RADIOLOGY,OUTSIDE SERVICE.")
"RTN","RA84POS",92,0)
 ;
"RTN","RA84POS",93,0)
 ;unlock the RADIOLOGY,OUTSIDE SERVICE record in the NEW PERSON file
"RTN","RA84POS",94,0)
 L -^VA(200,RAIEN(0))
"RTN","RA84POS",95,0)
 Q
"RTN","RA84POS",96,0)
 ;
"RTN","RA84PRE")
0^8^B93971841^n/a
"RTN","RA84PRE",1,0)
RA84PRE ;Hines OI/GJC - Pre-init Driver, patch 84 ;01/05/06  06:32
"RTN","RA84PRE",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**84**;Mar 16, 1998;Build 13
"RTN","RA84PRE",3,0)
 ;
"RTN","RA84PRE",4,0)
EN ; entry point for the pre-install logic
"RTN","RA84PRE",5,0)
 ;
"RTN","RA84PRE",6,0)
 ;Integration Agreements
"RTN","RA84PRE",7,0)
 ;----------------------
"RTN","RA84PRE",8,0)
 ;CREIXN^DDMOD(2916); DELIX^DDMOD(2916); $$FIND1^DIC(2051); UPDATE^DIE(2053); ^DIK(10013)
"RTN","RA84PRE",9,0)
 ;$$GET1^DIQ(2056); GETS^DIQ(2056); $$FMADD^XLFDT(10103); XMD(10070); BMES^XPDUTL(10141)
"RTN","RA84PRE",10,0)
 ;$$KSP^XUPARAM(2541); $$CREATE^XUSAP(4677)
"RTN","RA84PRE",11,0)
 ;
"RTN","RA84PRE",12,0)
 ;check to see if the following condition: RA*5.0*56 is not installed & BEFORE DELETION REPORT
"RTN","RA84PRE",13,0)
 ;STATUS (DD:74.01; Fld: 4) exists is true. If so, delete the BEFORE DELETION REPORT STATUS
"RTN","RA84PRE",14,0)
 ;field from the ACTIVITY LOG sub-file (exported accidentally; no data to be concerned with)
"RTN","RA84PRE",15,0)
 I '($$PATCH^XPDUTL("RA*5.0*56")),($D(^DD(74.01,4,0)))#2 D
"RTN","RA84PRE",16,0)
 .N %,DA,DIC,DIK,X,Y
"RTN","RA84PRE",17,0)
 .S DIK="^DD(74.01,",DA(1)=74.01,DA=4
"RTN","RA84PRE",18,0)
 .D ^DIK Q
"RTN","RA84PRE",19,0)
 ;
"RTN","RA84PRE",20,0)
 N DIERR,RAAPU,RAERR,RAFAC,RAFDA,RAFLD,RAFLG,RAFMC,RAIEN,RAOPT,RARY,RATXT,RAX,RAY,RAZ
"RTN","RA84PRE",21,0)
 S RAAPU="RADIOLOGY,OUTSIDE SERVICE",RAFMC="",RAOPT="RA OVERALL"
"RTN","RA84PRE",22,0)
 ;
"RTN","RA84PRE",23,0)
 ;I RAY>0 then the APU record was created; RAY will be the IEN of the new record.
"RTN","RA84PRE",24,0)
 ;I RAY=0 then the proxy user record existed prior to calling $$CREATE^XUSAP.
"RTN","RA84PRE",25,0)
 ;I RAY=-1 then the function failed to create the proxy user record.
"RTN","RA84PRE",26,0)
 S RAY=+$$CREATE^XUSAP(RAAPU,RAFMC,RAOPT)
"RTN","RA84PRE",27,0)
 ;
"RTN","RA84PRE",28,0)
 I RAY>0 S RAIEN=RAY,RATXT(1)="'"_RAAPU_"' has been created as an Application Proxy User."
"RTN","RA84PRE",29,0)
 ;
"RTN","RA84PRE",30,0)
 ;RAY=-1: The function failed to create the proxy user record; abort the install.
"RTN","RA84PRE",31,0)
 I RAY=-1 S XPDABORT=1 D
"RTN","RA84PRE",32,0)
 .S RATXT(1)="Error: '"_RAAPU_"' has not been created as an Application"
"RTN","RA84PRE",33,0)
 .S RATXT(2)="Proxy User. '"_RAAPU_"' must be unique"
"RTN","RA84PRE",34,0)
 .S RATXT(3)="and used within the scope of the VistA Radiology teleradiology"
"RTN","RA84PRE",35,0)
 .S RATXT(4)="initiative. Installation of RA*5.0*84 has been aborted until this"
"RTN","RA84PRE",36,0)
 .S RATXT(5)="Application Proxy User record can be created."
"RTN","RA84PRE",37,0)
 .Q
"RTN","RA84PRE",38,0)
 ;
"RTN","RA84PRE",39,0)
 ;RAY=0: The proxy user record existed prior to the function call. Is the proxy record
"RTN","RA84PRE",40,0)
 ;secure? If the proxy record is not secure abort the install.
"RTN","RA84PRE",41,0)
 I RAY=0 D
"RTN","RA84PRE",42,0)
 .;determine the IEN of 'RADIOLOGY,OUTSIDE SERVICE' in file 200...
"RTN","RA84PRE",43,0)
 .S RAIEN=$$FIND1^DIC(200,"","X","RADIOLOGY,OUTSIDE SERVICE","B") Q:RAIEN=0
"RTN","RA84PRE",44,0)
 .D GETS^DIQ(200,RAIEN_",","2;3;11;201","I","RARY") S RAFLD=""
"RTN","RA84PRE",45,0)
 .;Are there any NEW PERSON fields defined that jeopardize the security of this record?
"RTN","RA84PRE",46,0)
 .F  S RAFLD=$O(RARY(200,RAIEN,RAFLD)) Q:RAFLD=""  I $L($G(RARY(200,RAIEN,RAFLD,"I"))) S XPDABORT=1 Q
"RTN","RA84PRE",47,0)
 .I $G(XPDABORT)=1 D
"RTN","RA84PRE",48,0)
 ..S RATXT(1)="Error: '"_RAAPU_"' is not a secure application proxy user"
"RTN","RA84PRE",49,0)
 ..S RATXT(2)="record. Please revisit the definition of this type of user record."
"RTN","RA84PRE",50,0)
 ..S RATXT(3)=""
"RTN","RA84PRE",51,0)
 ..S RATXT(4)="Installation of RA*5.0*84 has been aborted until this Application Proxy"
"RTN","RA84PRE",52,0)
 ..S RATXT(5)="User record can be created."
"RTN","RA84PRE",53,0)
 ..Q
"RTN","RA84PRE",54,0)
 .Q
"RTN","RA84PRE",55,0)
 D BMES^XPDUTL(.RATXT)
"RTN","RA84PRE",56,0)
 Q:$G(XPDABORT)=1  K RATXT
"RTN","RA84PRE",57,0)
 ;
"RTN","RA84PRE",58,0)
 ;Add 'S' as a RAD/NUC MED CLASSIFICATION to the 'RADIOLOGY,OUTSIDE SERVICE' NEW PERSON file
"RTN","RA84PRE",59,0)
 ;record. Assign 'RADIOLOGY,OUTSIDE SERVICE' a PERSON CLASS.
"RTN","RA84PRE",60,0)
 ;permitted by IA 5077
"RTN","RA84PRE",61,0)
 I RAY'<0,(RAIEN>0) D
"RTN","RA84PRE",62,0)
 .K RARY S RAZ=RAIEN
"RTN","RA84PRE",63,0)
 .D GETS^DIQ(200,RAIEN_",","72*","I","RARY")
"RTN","RA84PRE",64,0)
 .I ($D(RARY)\10)=0 D  ;'S' not added in the past; add now (missing "B" xref makes this tricky)
"RTN","RA84PRE",65,0)
 ..K DIERR,RAERR,RAFDA,RARY
"RTN","RA84PRE",66,0)
 ..S RAIEN="?+1,"_RAIEN_","
"RTN","RA84PRE",67,0)
 ..S RAFDA(200.072,RAIEN,.01)="S"
"RTN","RA84PRE",68,0)
 ..D UPDATE^DIE("","RAFDA","","RAERR")
"RTN","RA84PRE",69,0)
 ..;
"RTN","RA84PRE",70,0)
 ..;if error inform the user, proceed with filing PERSON CLASS
"RTN","RA84PRE",71,0)
 ..I ($D(RAERR("DIERR"))#2) S RAX="RAD/NUC MED CLASSIFICATION" D ERR
"RTN","RA84PRE",72,0)
 ..Q
"RTN","RA84PRE",73,0)
 .;
"RTN","RA84PRE",74,0)
 .;find the DIAGNOSTIC RADIOLOGY record in the PERSON CLASS (#8932.1) file.
"RTN","RA84PRE",75,0)
 .K DIERR,RAERR,RAFDA
"RTN","RA84PRE",76,0)
 .S RAPCLASS=$$PCLKUP() ;note workload encounter errors if the lookup fails
"RTN","RA84PRE",77,0)
 .I +RAPCLASS'>0 D  Q
"RTN","RA84PRE",78,0)
 ..;cannot find desired record; inform the user & do not execute the PERSON CLASS update
"RTN","RA84PRE",79,0)
 ..S:+RAPCLASS=0 RATXT(1)="PERSON CLASS value DIAGNOSTIC RADIOLOGY' not found."
"RTN","RA84PRE",80,0)
 ..S:+RAPCLASS=-1 RATXT(1)="PERSON CLASS lookup error: "_$P(RAPCLASS,U,2)
"RTN","RA84PRE",81,0)
 ..S RATXT(2)="Encounter based workload calculations will fail until a PERSON CLASS is assigned."
"RTN","RA84PRE",82,0)
 ..D BMES^XPDUTL(.RATXT) K RATXT
"RTN","RA84PRE",83,0)
 ..Q
"RTN","RA84PRE",84,0)
 .;
"RTN","RA84PRE",85,0)
 .;file the PERSON CLASS value into PERSON CLASS sub-file: 200.05 IA 5077
"RTN","RA84PRE",86,0)
 .K DIERR,RAERR,RAFDA,RAY S RAIEN=RAZ
"RTN","RA84PRE",87,0)
 .S RAIEN="?+1,"_RAIEN_","
"RTN","RA84PRE",88,0)
 .S RAFDA(200.05,RAIEN,.01)=RAPCLASS
"RTN","RA84PRE",89,0)
 .S RAFDA(200.05,RAIEN,2)=$$FMADD^XLFDT(DT,-1,0,0,0) ;T-1 to make sure we work today!
"RTN","RA84PRE",90,0)
 .D UPDATE^DIE("","RAFDA","","RAERR")
"RTN","RA84PRE",91,0)
 .;
"RTN","RA84PRE",92,0)
 .;if error inform the user, proceed with install
"RTN","RA84PRE",93,0)
 .I ($D(RAERR("DIERR"))#2) S RAX="PERSON CLASS" D ERR
"RTN","RA84PRE",94,0)
 .Q
"RTN","RA84PRE",95,0)
 K DIERR,RAERR,RAFDA,RAY
"RTN","RA84PRE",96,0)
 ;
"RTN","RA84PRE",97,0)
 ;check to see if the facility has records within the 999-1003 IEN range within the
"RTN","RA84PRE",98,0)
 ;DIAGNOSTIC CODES (#78.3) file. If there are records with these IENs proceed with
"RTN","RA84PRE",99,0)
 ;the install but:
"RTN","RA84PRE",100,0)
 ;1) DO NOT alter (change pointers) the data in the DIAGNOSTIC CODES file at the facility
"RTN","RA84PRE",101,0)
 ;2) Send an email to an Outlook mail group identifying the facility where the
"RTN","RA84PRE",102,0)
 ;   conflict occur.
"RTN","RA84PRE",103,0)
 ;If the IENs in this range are record free add them to the facilities' local DIAGNOSTIC CODES
"RTN","RA84PRE",104,0)
 ;file. RAFLG=1 when there is an existing record in the the IEN range of 999-1003
"RTN","RA84PRE",105,0)
 S RAFLG=0 F RAIEN=999:1:1003 I ($D(^RA(78.3,RAIEN,0))#2) S RAFLG=1 Q
"RTN","RA84PRE",106,0)
 ;
"RTN","RA84PRE",107,0)
 ;if RAFLG=1 send the email to the Outlook mail group
"RTN","RA84PRE",108,0)
 I RAFLG=1 D
"RTN","RA84PRE",109,0)
 .S RAFAC=$$GET1^DIQ(4,+$$KSP^XUPARAM("INST"),.01)
"RTN","RA84PRE",110,0)
 .N XMDUN,XMDUZ,XMSUB,XMTEXT,XMY,XMZ S XMDUZ=.5
"RTN","RA84PRE",111,0)
 .S RATXT(1)=RAFAC_" has a conflict with national teleradiology codes"
"RTN","RA84PRE",112,0)
 .S RATXT(2)="diagnostic codes occupying IENS: 999-1003 in file 78.3."
"RTN","RA84PRE",113,0)
 .S XMSUB="DIAGNOSTIC CODES file IEN issue @ "_RAFAC,XMTEXT="RATXT("
"RTN","RA84PRE",114,0)
 .S XMY("VAOITVHITRadiologyFacilityLevelApplicationIssues@va.gov")=""
"RTN","RA84PRE",115,0)
 .NEW DIFROM
"RTN","RA84PRE",116,0)
 .D ^XMD,BMES^XPDUTL(.RATXT)
"RTN","RA84PRE",117,0)
 .Q
"RTN","RA84PRE",118,0)
 ;If no IEN conflict, add the nationally defined teleradiology diagnostic codes...
"RTN","RA84PRE",119,0)
 E  D  ;do-if RAFLG=0
"RTN","RA84PRE",120,0)
 .K RARY S RARY(999)="TELERADIOLOGY, NOT YET DICTATED^^N^n"
"RTN","RA84PRE",121,0)
 .S RARY(1000)="NO ALERT REQUIRED^^N^n"
"RTN","RA84PRE",122,0)
 .S RARY(1001)="SIGNIFICANT ABNORMALITY, ATTN NEEDED^^Y^y"
"RTN","RA84PRE",123,0)
 .S RARY(1002)="CRITICAL ABNORMALITY^^Y^y"
"RTN","RA84PRE",124,0)
 .S RARY(1003)="POSSIBLE MALIGNANCY^^Y^y",RAIEN=""
"RTN","RA84PRE",125,0)
 .F  S RAIEN=$O(RARY(RAIEN)) Q:RAIEN=""  D
"RTN","RA84PRE",126,0)
 ..S RAFDA(78.3,"+1,",.01)=$P(RARY(RAIEN),U,1)
"RTN","RA84PRE",127,0)
 ..S RAFDA(78.3,"+1,",3)=$P(RARY(RAIEN),U,3)
"RTN","RA84PRE",128,0)
 ..S RAFDA(78.3,"+1,",4)=$P(RARY(RAIEN),U,4)
"RTN","RA84PRE",129,0)
 ..S RAIEN(1)=RAIEN D UPDATE^DIE("","RAFDA","RAIEN","RAERR")
"RTN","RA84PRE",130,0)
 ..I $D(RAERR)#2 D
"RTN","RA84PRE",131,0)
 ...S RATXT(1)="",RATXT(2)="Error adding "_$P(RARY(RAIEN),U,1)_" to the"
"RTN","RA84PRE",132,0)
 ...S RATXT(3)="local DIAGNOSTIC CODES file #78.3." D BMES^XPDUTL(.RATXT)
"RTN","RA84PRE",133,0)
 ...Q
"RTN","RA84PRE",134,0)
 ..Q
"RTN","RA84PRE",135,0)
 .Q
"RTN","RA84PRE",136,0)
 ;
"RTN","RA84PRE",137,0)
 D XREF
"RTN","RA84PRE",138,0)
 Q
"RTN","RA84PRE",139,0)
 ;
"RTN","RA84PRE",140,0)
XREF ;REGARDLESS OF WHETHER FILE 78.3 HAS BEEN UPDATED, delete the traditional cross-reference
"RTN","RA84PRE",141,0)
 ;definition on the PRIMARY DIAGNOSTIC CODE (70.03,13) field. Params: sub-DD, field #,
"RTN","RA84PRE",142,0)
 ;cross-reference number, flag ('K' kills "AD"), array containing information about recompiled
"RTN","RA84PRE",143,0)
 ;templates &/or xrefs, error array dialog (if any)
"RTN","RA84PRE",144,0)
 ;
"RTN","RA84PRE",145,0)
 ;First check if the 'New Style' cross-reference is in place. If it is, quit this function now!
"RTN","RA84PRE",146,0)
 ;If in error, make sure the error is documented and proceed with the install of RA*5.0*84.
"RTN","RA84PRE",147,0)
 ;
"RTN","RA84PRE",148,0)
 N RAERR,RAVALUE,RAY S RAVALUE(1)=70,RAVALUE(2)="AD"
"RTN","RA84PRE",149,0)
 ;Note: "BB" (5th subscript) is the FILE & NAME cross-reference index in the INDEX (#.11) file.
"RTN","RA84PRE",150,0)
 S RAY=$$FIND1^DIC(.11,"","O",.RAVALUE,"BB","","RAERR")
"RTN","RA84PRE",151,0)
 I ($D(RAERR("DIERR")))#2 K RATXT D  Q
"RTN","RA84PRE",152,0)
 .S RATXT(1)=$G(RAERR("DIERR",1,"TEXT",1),"Error finding the 'New Style' ""AD"" cross-reference.")
"RTN","RA84PRE",153,0)
 .D BMES^XPDUTL(.RATXT) K RATXT Q
"RTN","RA84PRE",154,0)
 ;
"RTN","RA84PRE",155,0)
 I RAY K RATXT D  Q
"RTN","RA84PRE",156,0)
 .S RATXT(1)="The 'New Style' PRIMARY DIAGNOSTIC CODE (70.03, #13) ""AD"" cross-reference"
"RTN","RA84PRE",157,0)
 .S RATXT(2)="is currently in existence." D BMES^XPDUTL(.RATXT) K RATXT Q
"RTN","RA84PRE",158,0)
 ;
"RTN","RA84PRE",159,0)
 K DIERR,RAERR,RAFDA,RAIEN,RATXT
"RTN","RA84PRE",160,0)
 N I,RAI,RAMOWIC,RAX S RAY=0
"RTN","RA84PRE",161,0)
 ;find the old cross-reference to delete; set RAY to the record number of the cross-reference
"RTN","RA84PRE",162,0)
 F  S RAY=$O(^DD(70.03,13,1,RAY)) Q:'RAY  Q:$G(^DD(70.03,13,1,RAY,0))="70^AD^MUMPS"
"RTN","RA84PRE",163,0)
 ;RAY="" if there is no traditional "AD" cross-reference to delete, BUT make sure the
"RTN","RA84PRE",164,0)
 ;new style "AD" cross-reference is created ('D NS').
"RTN","RA84PRE",165,0)
 I RAY="" D NS Q
"RTN","RA84PRE",166,0)
 D DELIX^DDMOD(70.03,13,RAY,"K","RAMOWIC","RAERR")
"RTN","RA84PRE",167,0)
 S I=0 F RAX="DDAUD","DIEZ","DIKZ" D
"RTN","RA84PRE",168,0)
 .I ($D(RAMOWIC(RAX)))#2 D
"RTN","RA84PRE",169,0)
 ..S I=I+1,RATXT(I)=""
"RTN","RA84PRE",170,0)
 ..S:RAX="DDAUD" RATXT(I)="DD AUDIT (#.6) updated"
"RTN","RA84PRE",171,0)
 ..S:RAX="DIKZ" RATXT(I)="Cross-references re-compiled in namespace: "_$G(RAMOWIC(RAX)) QUIT
"RTN","RA84PRE",172,0)
 ..I RAX="DIEZ" S RAI=0 F  S RAI=$O(RAMOWIC(RAX,RAI)) Q:'RAI  D
"RTN","RA84PRE",173,0)
 ...S I=I+1,RATXT(I)="Input Template re-compiled: "_$G(RAMOWIC(RAX,RAI))
"RTN","RA84PRE",174,0)
 ...Q
"RTN","RA84PRE",175,0)
 ..Q
"RTN","RA84PRE",176,0)
 .Q
"RTN","RA84PRE",177,0)
 ;
"RTN","RA84PRE",178,0)
 ;Note: RAERR("DIERR") will only be defined if an error occurred...
"RTN","RA84PRE",179,0)
 I ($D(RAERR("DIERR")))#2 D  S XPDABORT=1
"RTN","RA84PRE",180,0)
 .S I=I+1,RATXT(I)="",I=I+1
"RTN","RA84PRE",181,0)
 .S RATXT(I)="Error deleting the PRIMARY DIAGNOSTIC CODE (70.03,13) cross-reference."
"RTN","RA84PRE",182,0)
 .S I=I+1,RATXT(I)="Contact the national VistA Radiology development team."
"RTN","RA84PRE",183,0)
 .Q
"RTN","RA84PRE",184,0)
 D:$O(RATXT(0)) BMES^XPDUTL(.RATXT)
"RTN","RA84PRE",185,0)
 ;
"RTN","RA84PRE",186,0)
 ;if there is an error in deleting the old cross-reference stop the install of the patch.
"RTN","RA84PRE",187,0)
 Q:$G(XPDABORT)=1
"RTN","RA84PRE",188,0)
 ;
"RTN","RA84PRE",189,0)
NS ;Create the new-style cross-reference on the PRIMARY DIAGNOSTIC CODE (70.03,13) field.
"RTN","RA84PRE",190,0)
 ;This cross-reference will be named the same as the prior cross-reference, "AD", but
"RTN","RA84PRE",191,0)
 ;the SET & KILL logic will change. This new style cross-reference will be stored in the
"RTN","RA84PRE",192,0)
 ;INDEX (#.11) file.
"RTN","RA84PRE",193,0)
 N I,J,RAMOWIC,RARSLT,RAXREF K DIERR,RAERR,RATXT
"RTN","RA84PRE",194,0)
 S RAXREF("FILE")=70,RAXREF("TYPE")="MU",RAXREF("NAME")="AD"
"RTN","RA84PRE",195,0)
 S RAXREF("EXECUTION")="F",RAXREF("ROOT FILE")=70.03,RAXREF("USE")="S"
"RTN","RA84PRE",196,0)
 S RAXREF("ACTIVITY")="IR"
"RTN","RA84PRE",197,0)
 S RAXREF("SHORT DESCR")="The 'AD' is used to mark cases eligible for the Abnormal Report option."
"RTN","RA84PRE",198,0)
 S RAXREF("DESCR",1)="If the diagnostic code record in the radiology DIAGNOSTIC CODES (#78.3)"
"RTN","RA84PRE",199,0)
 S RAXREF("DESCR",2)="has the data attribute for field: PRINT ON ABNORMAL REPORT (#3) set to"
"RTN","RA84PRE",200,0)
 S RAXREF("DESCR",3)="'Y' (yes) then the ""AD"" cross-reference will be set for this exam record"
"RTN","RA84PRE",201,0)
 S RAXREF("DESCR",4)="to indicate that this case should be identified on the Abnormal Report."
"RTN","RA84PRE",202,0)
 S RAXREF("DESCR",5)=""
"RTN","RA84PRE",203,0)
 S RAXREF("DESCR",6)="NOTE: When this field is edited the DIAGNOSTIC PRINT DATE (#20) field is"
"RTN","RA84PRE",204,0)
 S RAXREF("DESCR",7)="deleted!",RAXREF("VAL",1)=13
"RTN","RA84PRE",205,0)
 S RAXREF("KILL CONDITION")="S:X1(1)'="""" X=1"
"RTN","RA84PRE",206,0)
 S RAXREF("KILL")="D:($D(X1(1))#2) PRIDXIXK^RADD2(.DA,X1(1))"
"RTN","RA84PRE",207,0)
 S RAXREF("SET CONDITION")="S:X2(1)'="""" X=1"
"RTN","RA84PRE",208,0)
 S RAXREF("SET")="S:$P($G(^RA(78.3,X2(1),0)),U,3)=""Y"" ^RADPT(""AD"",X2(1),DA(2),DA(1),DA)="""""
"RTN","RA84PRE",209,0)
 S RAXREF("WHOLE KILL")="K ^RADPT(""AD"")"
"RTN","RA84PRE",210,0)
 ;
"RTN","RA84PRE",211,0)
 D CREIXN^DDMOD(.RAXREF,"",.RARSLT,"RAMOWIC","RAERR") S I=1,RATXT(I)="",I=I+1
"RTN","RA84PRE",212,0)
 ;
"RTN","RA84PRE",213,0)
 S RATXT(I)="The '"_$P(RARSLT,U,2)_"' cross-reference was"_$S(RARSLT="":" not",1:"")_" successfully created."
"RTN","RA84PRE",214,0)
 ;
"RTN","RA84PRE",215,0)
 F J="DIEZ","DIKZ" D
"RTN","RA84PRE",216,0)
 .I J="DIEZ",($O(RAMOWIC("DIEZ",0))) D
"RTN","RA84PRE",217,0)
 ..N J1 S J1=0
"RTN","RA84PRE",218,0)
 ..F  S J1=$O(RAMOWIC("DIEZ",J1)) Q:'J1  D
"RTN","RA84PRE",219,0)
 ...S I=I+1,RATXT(I)="Input template: "_$P($G(RAMOWIC("DIEZ",J1)),U)_" was re-compiled."
"RTN","RA84PRE",220,0)
 ...Q
"RTN","RA84PRE",221,0)
 ..Q
"RTN","RA84PRE",222,0)
 .;
"RTN","RA84PRE",223,0)
 .I J="DIKZ",$G(RAMOWIC("DIKZ"))'="" D
"RTN","RA84PRE",224,0)
 ..S I=I+1,RATXT(I)="Cross-reference re-compiled in namespace: "_$G(RAMOWIC("DIKZ"))
"RTN","RA84PRE",225,0)
 ..Q
"RTN","RA84PRE",226,0)
 .Q
"RTN","RA84PRE",227,0)
 ;
"RTN","RA84PRE",228,0)
 I ($D(RAERR("DIERR")))#2 D  S XPDABORT=1
"RTN","RA84PRE",229,0)
 .S I=I+1,RATXT(I)="",I=I+1
"RTN","RA84PRE",230,0)
 .S RATXT(I)="Error deleting the PRIMARY DIAGNOSTIC CODE (70.03,13) cross-reference."
"RTN","RA84PRE",231,0)
 .S I=I+1,RATXT(I)="Contact the national VistA Radiology development team."
"RTN","RA84PRE",232,0)
 .Q
"RTN","RA84PRE",233,0)
 D:$O(RATXT(0)) BMES^XPDUTL(.RATXT)
"RTN","RA84PRE",234,0)
 Q
"RTN","RA84PRE",235,0)
 ;
"RTN","RA84PRE",236,0)
PCLKUP() ;PERSON CLASS lookup screened by INACTIVATED field on file 8932.1
"RTN","RA84PRE",237,0)
 ;If successful return the IEN.
"RTN","RA84PRE",238,0)
 ;If the lookup fails (without error) the function returns 0
"RTN","RA84PRE",239,0)
 ;If the lookup fails (with error) the function returns null w/error dialog
"RTN","RA84PRE",240,0)
 ; Ex: RAERR("DIERR","1","TEXT",1)="The input value contains control characters."
"RTN","RA84PRE",241,0)
 ; If error I'll return: -1^error dialog
"RTN","RA84PRE",242,0)
 N RAXEC S RAXEC="N RADT S RADT=$P(^(0),U,5) I $S('RADT:1,RADT>DT:1,1:0)"
"RTN","RA84PRE",243,0)
 S RASULT=$$FIND1^DIC(8932.1,"","X","V183002","F","X RAXEC","RAERR") ;"V183002"
"RTN","RA84PRE",244,0)
 Q $S(($D(RAERR("DIERR"))#2):"-1^"_$G(RAERR("DIERR","1","TEXT",1)),1:RASULT)
"RTN","RA84PRE",245,0)
 ;
"RTN","RA84PRE",246,0)
ERR ;display the error text associated with our failed event
"RTN","RA84PRE",247,0)
 ;input: RAX exists globally the attribute that was not filed Ex: RAD/NUC MED CLASSIFICATION
"RTN","RA84PRE",248,0)
 ;       RAERR("DIERR") exists globally
"RTN","RA84PRE",249,0)
 K RATXT N RACNT,RAI,RAJ S RATXT(1)="APU record error when filing "_RAX_" data"
"RTN","RA84PRE",250,0)
 S RAI=0,RACNT=1
"RTN","RA84PRE",251,0)
 F  S RAI=$O(RAERR("DIERR",RAI)) Q:RAI'>0  S RACNT=RACNT+1,RATXT(RACNT)="" D
"RTN","RA84PRE",252,0)
 .S RAJ=0 F  S RAJ=$O(RAERR("DIERR",RAI,"TEXT",RAJ)) Q:RAJ'>0  D
"RTN","RA84PRE",253,0)
 ..Q:$G(RAERR("DIERR",RAI,"TEXT",RAJ))=""
"RTN","RA84PRE",254,0)
 ..S RACNT=RACNT+1,RATXT(RACNT)=$G(RAERR("DIERR",RAI,"TEXT",RAJ))
"RTN","RA84PRE",255,0)
 ..Q
"RTN","RA84PRE",256,0)
 .Q
"RTN","RA84PRE",257,0)
 D BMES^XPDUTL(.RATXT) K RATXT
"RTN","RA84PRE",258,0)
 Q
"RTN","RA84PRE",259,0)
 ;
"RTN","RADD2")
0^23^B18013466^B14117314
"RTN","RADD2",1,0)
RADD2 ;HISC/GJC/CAH-Radiology Data Dictionary Utility Routine ;5/14/97  10:31
"RTN","RADD2",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**84**;Mar 16, 1998;Build 13
"RTN","RADD2",3,0)
 ;
"RTN","RADD2",4,0)
 ;Integration Agreements
"RTN","RADD2",5,0)
 ;----------------------
"RTN","RADD2",6,0)
 ;EN^DDIOL(10142); FILE^DIE(2053);NOTE^ORX3(868);MES^XPDUTL(10141)
"RTN","RADD2",7,0)
 ;
"RTN","RADD2",8,0)
EN1(RAX,RAY) ; Input transform for the .01 field (Procedure) for the Rad/Nuc
"RTN","RADD2",9,0)
 ; Med Common Procedure file i.e, ^RAMIS(71.3
"RTN","RADD2",10,0)
 ; Procedure must not have an inactive date before today in file 71
"RTN","RADD2",11,0)
 ; Procedure in file 71 must have same imaging type as the one
"RTN","RADD2",12,0)
 ;   selected before editing this record in file 71.3
"RTN","RADD2",13,0)
 ; If 'Parent' type procedure, it must have at least 1 descendent
"RTN","RADD2",14,0)
 ; 'RAX' is the value of the .01 field in ^RAMIS(71.3,
"RTN","RADD2",15,0)
 ; 'RAY' are ien's of entries in ^RAMIS(71,
"RTN","RADD2",16,0)
 I '$G(RAIMGTYI) Q 0
"RTN","RADD2",17,0)
 I $S('$D(^("I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S(RAIMGTYI=$P($G(^RAMIS(71,+RAY,0)),"^",12):1,1:0),$S($P(^RAMIS(71,+RAY,0),U,6)'="P":1,$O(^RAMIS(71,+RAY,4,0)):1,1:0)
"RTN","RADD2",18,0)
 Q $T
"RTN","RADD2",19,0)
 ;
"RTN","RADD2",20,0)
CH(RAY,RAX) ; This subroutine will fire off the 'Radiology Request Cancel
"RTN","RADD2",21,0)
 ; /Hold' notification as defined in the 'OE/RR NOTIFICATIONS' file.
"RTN","RADD2",22,0)
 ; Only if request is either cancelled or held.  Called from the set
"RTN","RADD2",23,0)
 ; logic of the 'ACHN' xref in ^DD(75.1,5) field definition.
"RTN","RADD2",24,0)
 ;
"RTN","RADD2",25,0)
 ; Input variables:
"RTN","RADD2",26,0)
 ; 'RAX'=Request status of the order, $S(X=1:'discontinued',X=3:'hold')
"RTN","RADD2",27,0)
 ; 'RAY'=ien of the order in the RAD/NUC MED ORDERS file.
"RTN","RADD2",28,0)
 ;
"RTN","RADD2",29,0)
 Q:(RAY'=+RAY)  Q:(RAX'=1)&(RAX'=3)
"RTN","RADD2",30,0)
 N %,C,D,D0,DA,DC,DDER,DE,DG,DH,DI,DIC,DIE,DIEDA,DIEL,DIFLD,DIP,DIW,DIWT
"RTN","RADD2",31,0)
 N DK,DL,DM,DN,DP,DQ,DR,DU,DV,DW,I,J,N,ORBPMSG,ORBXDATA,ORIFN,ORNOTE,ORVP
"RTN","RADD2",32,0)
 N RA751,RADFN,RANME,RAOIFN,RAOLP,RAOPTN,RAORDS,RAOREA,RAOSTS,RAPARENT
"RTN","RADD2",33,0)
 N RAPRC,RAXIT,X,Y
"RTN","RADD2",34,0)
 S RA751=$G(^RAO(75.1,RAY,0)) Q:RA751']""
"RTN","RADD2",35,0)
 S RAOIFN=RAY,RADFN=+$P(RA751,"^")
"RTN","RADD2",36,0)
 S RAPRC=$P($G(^RAMIS(71,+$P(RA751,"^",2),0)),"^"),ORVP=RADFN_";DPT("
"RTN","RADD2",37,0)
 S ORBPMSG=$S(RAX=1:"Discontinued - ",1:"On hold - ")_$E(RAPRC,1,17)
"RTN","RADD2",38,0)
 S ORBXDATA=RAOIFN_","_RADFN,ORIFN=+$P(RA751,"^",7),ORNOTE(26)=1
"RTN","RADD2",39,0)
 D NOTE^ORX3
"RTN","RADD2",40,0)
 Q
"RTN","RADD2",41,0)
INACOM(RAD0) ; Check inactive date on the Rad/Nuc Med Procedure file (71)
"RTN","RADD2",42,0)
 ; for the Common Procedure before setting our inactive procedure to
"RTN","RADD2",43,0)
 ; active.  Called from the 'RA COMMON PROCEDURE EDIT' input template.
"RTN","RADD2",44,0)
 ; Option: Common Procedure Enter/Edit (13^RAMAIN2)
"RTN","RADD2",45,0)
 ; Input : RAD0-ien of Rad/Nuc Med Common Procedure
"RTN","RADD2",46,0)
 ; Output: if Common cannot be re-activated, reset the 'Inactive' field
"RTN","RADD2",47,0)
 ;         to 'yes'.
"RTN","RADD2",48,0)
 N RAINA S RAINA=$P($G(^RAMIS(71,+$P($G(^RAMIS(71.3,RAD0,0)),"^"),"I")),"^")
"RTN","RADD2",49,0)
 Q:RAINA=""!(RAINA>DT) "@15" ; we can inactivate the common
"RTN","RADD2",50,0)
 N RAFDA,RAMSG
"RTN","RADD2",51,0)
 S RAFDA(71.3,RAD0_",",4)="Y" D FILE^DIE("","RAFDA","") S RAMSG(1)=$C(7)
"RTN","RADD2",52,0)
 S RAMSG(2)="You cannot add this procedure to the common procedure list"
"RTN","RADD2",53,0)
 S RAMSG(3)="because it is inactivated in the Rad/Nuc Med Procedures file."
"RTN","RADD2",54,0)
 S RAMSG(4)="You must first re-activate the procedure through the 'Procedure"
"RTN","RADD2",55,0)
 S RAMSG(5)="Enter/Edit' option.",RAMSG(6)="" D MES^XPDUTL(.RAMSG)
"RTN","RADD2",56,0)
 Q "@10" ; reset 'Inactive' to 'yes', re-edit field.
"RTN","RADD2",57,0)
 ;
"RTN","RADD2",58,0)
EN2() ; called from ^DD(74,0,"ID","WRITE")
"RTN","RADD2",59,0)
 ; display long case #'s in the same print set as current record
"RTN","RADD2",60,0)
 N RA1,RA2
"RTN","RADD2",61,0)
 S RA1=0,RA2=""
"RTN","RADD2",62,0)
 F  S RA1=$O(^RARPT(Y,1,"B",RA1)) Q:'RA1  S RA2=RA2_$S(RA2="":"-",1:",-")_$P(RA1,"-",2)
"RTN","RADD2",63,0)
 Q RA2
"RTN","RADD2",64,0)
USUAL(RADA,RAX) ; To insure that the USUAL DOSE value falls between the
"RTN","RADD2",65,0)
 ; HIGH ADULT DOSE and the LOW ADULT DOSE.
"RTN","RADD2",66,0)
 ; Input Variables:
"RTN","RADD2",67,0)
 ;     RADA -> top level/sub-file level IEN's
"RTN","RADD2",68,0)
 ;      RAX -> value input by the user
"RTN","RADD2",69,0)
 ; Output Variable: $S(1: value is accepted, 0: value not accepted)
"RTN","RADD2",70,0)
 ;
"RTN","RADD2",71,0)
 Q:RAX="" 0 ; X does not exist
"RTN","RADD2",72,0)
 N RA7108,RAH,RAL S RA7108=$G(^RAMIS(71,RADA(1),"NUC",RADA,0))
"RTN","RADD2",73,0)
 S RAH=$P(RA7108,"^",5),RAL=$P(RA7108,"^",6)
"RTN","RADD2",74,0)
 S RAH=$S(RAH="":99999.9999,1:RAH),RAL=$S(RAL="":.0001,1:RAL)
"RTN","RADD2",75,0)
 I (+RAX<RAL)!(+RAX>RAH) D  Q 0 ; value is not accepted
"RTN","RADD2",76,0)
 . N RARRY S RARRY(1)="The 'USUAL DOSE' must fall within the range of: "
"RTN","RADD2",77,0)
 . S RARRY(1)=RARRY(1)_RAL_" - "_RAH_" "
"RTN","RADD2",78,0)
 . D EN^DDIOL(.RARRY)
"RTN","RADD2",79,0)
 . Q
"RTN","RADD2",80,0)
 E  Q 1 ; value accepted
"RTN","RADD2",81,0)
 ;
"RTN","RADD2",82,0)
RANGE(RADA) ; Determine the range in which the 'USUAL DOSE' must fall
"RTN","RADD2",83,0)
 ; Input Variables:
"RTN","RADD2",84,0)
 ;     RADA  -> top level/sub-file level IEN's
"RTN","RADD2",85,0)
 ; Output Variable:
"RTN","RADD2",86,0)
 ;     RANGE -> the range in which the 'USUAL DOSE' must fall
"RTN","RADD2",87,0)
 N RA7108,RAH,RAL
"RTN","RADD2",88,0)
 S RA7108=$G(^RAMIS(71,RADA(1),"NUC",RADA,0))
"RTN","RADD2",89,0)
 S RAH=$P(RA7108,"^",5),RAL=$P(RA7108,"^",6)
"RTN","RADD2",90,0)
 S RAH=$S(RAH="":99999.9999,1:RAH),RAL=$S(RAL="":.0001,1:RAL)
"RTN","RADD2",91,0)
 Q RAL_"-"_RAH
"RTN","RADD2",92,0)
MEDOSE(RAY,RADT) ; Determine if this individual (RAY) is authorized to
"RTN","RADD2",93,0)
 ; administer medications.  Called from ^DD(70.15,4,12.1)
"RTN","RADD2",94,0)
 ; Input : RAY (pnt to 200) - the individual being checked at the moment 
"RTN","RADD2",95,0)
 ;         RADT - Date of the examination
"RTN","RADD2",96,0)
 ; Output: '1' - user is authorized to administer medications, else '0'
"RTN","RADD2",97,0)
 ;
"RTN","RADD2",98,0)
 Q:$D(^VA(200,"ARC","R",RAY)) 1 ; Rad/Nuc Med Class: Resident
"RTN","RADD2",99,0)
 Q:$D(^VA(200,"ARC","S",RAY)) 1 ; Rad/Nuc Med Class: Staff
"RTN","RADD2",100,0)
 Q:$D(^VA(200,"ARC","T",RAY)) 1 ; Rad/Nuc Med Class: Technologist
"RTN","RADD2",101,0)
 Q:$D(^XUSEC("ORES",RAY)) 1 Q:$D(^XUSEC("ORELSE",RAY)) 1
"RTN","RADD2",102,0)
 N RAUTH S RAUTH=$G(^VA(200,RAY,"PS"))
"RTN","RADD2",103,0)
 ; If authorized to write med orders ($P(RAUTH,"^")=1) and inactivation
"RTN","RADD2",104,0)
 ; date null -OR- inactivation date greater than or equal to the exam
"RTN","RADD2",105,0)
 ; date individual is authorized.
"RTN","RADD2",106,0)
 Q:+$P(RAUTH,"^")&($S('$P(RAUTH,"^",4):1,$P(RAUTH,"^",4)'<RADT:1,1:0)) 1
"RTN","RADD2",107,0)
 Q 0
"RTN","RADD2",108,0)
 ;
"RTN","RADD2",109,0)
PRIDXIXK(DA,X) ;This subroutine executes the KILL logic for the 'new style' AD cross-
"RTN","RADD2",110,0)
 ;reference on the 'PRIMARY DIAGNOSTIC CODE' (data dictionary: 70.03; field: 13)
"RTN","RADD2",111,0)
 ;Input: DA - an array where DA(2)=RADFN, DA(1)=RADTI, & DA=RACNI
"RTN","RADD2",112,0)
 ;        X - the primary diagnostic code value (this field points to file 78.3)
"RTN","RADD2",113,0)
 N RACNI,RADFN,RADTI,RAFDA,RAIENS,RAX
"RTN","RADD2",114,0)
 S RADFN=DA(2),RADTI=DA(1),RACNI=DA,RAX=X ;save the variables just in case
"RTN","RADD2",115,0)
 S RAIENS=DA_","_DA(1)_","_DA(2)_",",RAFDA(70.03,RAIENS,20)="@"
"RTN","RADD2",116,0)
 D FILE^DIE(,"RAFDA") ;delete data in 'DIAGNOSTIC PRINT DATE' (DD: 70.03; field: 20)
"RTN","RADD2",117,0)
 K ^RADPT("AD",RAX,RADFN,RADTI,RACNI)
"RTN","RADD2",118,0)
 Q
"RTN","RADD2",119,0)
 ;
"RTN","RAHLO")
0^9^B47630507^B39097483
"RTN","RAHLO",1,0)
RAHLO ;HIRMFO/GJC-Process data set from the bridge program ;11/18/97  12:13
"RTN","RAHLO",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**4,8,27,55,66,84**;Mar 16, 1998;Build 13
"RTN","RAHLO",3,0)
 ; 09/07/2005 Remedy call 108405 - KAM Allow Radiology to accept dx codes from Talk Technology
"RTN","RAHLO",4,0)
 ;
"RTN","RAHLO",5,0)
 ;Integration Agreements
"RTN","RAHLO",6,0)
 ;----------------------
"RTN","RAHLO",7,0)
 ;DT^DILF(2054); LOCK^DILF(2054); DEM^VADPT(10061); $$DT^XLFDT(10103)
"RTN","RAHLO",8,0)
 ;
"RTN","RAHLO",9,0)
EN1 ; Check the validity of the following data globals:
"RTN","RAHLO",10,0)
 ; Example: '^TMP("RARPT-REC",$J,RASUB,' where RASUB is a
"RTN","RAHLO",11,0)
 ; record in file 772.
"RTN","RAHLO",12,0)
 ;**************** Validates (if data present): ************************
"RTN","RAHLO",13,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RACNI")=case ien
"RTN","RAHLO",14,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RADATE")=date reported/entered/verified
"RTN","RAHLO",15,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RADFN")=patient ien
"RTN","RAHLO",16,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RADTI")=inverted exam date/time
"RTN","RAHLO",17,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RADX",#)=Dx codes (could be more than 1)
"RTN","RAHLO",18,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RAESIG")=Verifier's E-Sig (if present)
"RTN","RAHLO",19,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RAHIST")=Additional Clinical History
"RTN","RAHLO",20,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RAIMP",#)=Impression Text
"RTN","RAHLO",21,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RALONGCN")=Long Case Number
"RTN","RAHLO",22,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RASSN")=Patient SSN
"RTN","RAHLO",23,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RASTAT")=A, F or R (amend, final or prelim)
"RTN","RAHLO",24,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RATXT",#)=Report Text
"RTN","RAHLO",25,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"VENDOR")=vendor
"RTN","RAHLO",26,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RAVERF")=Verifier ien
"RTN","RAHLO",27,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RATRANSCRIPT")=transcriptionist (optional)
"RTN","RAHLO",28,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RASTAFF")=Primary staff
"RTN","RAHLO",29,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RARESIDENT")=Primary resident
"RTN","RAHLO",30,0)
 ; ^TMP("RARPT-REC",$J,RASUB,"RAWHOCHANGE")=Who changed status to Verify
"RTN","RAHLO",31,0)
 ;**********************************************************************
"RTN","RAHLO",32,0)
 K RAERR S RAQUIET=1
"RTN","RAHLO",33,0)
 ; Check if the minimum data set exists.
"RTN","RAHLO",34,0)
 I '$D(^TMP("RARPT-REC",$J,RASUB,"RACNI")) S RAERR="Missing Case Number" Q
"RTN","RAHLO",35,0)
 I '$D(^TMP("RARPT-REC",$J,RASUB,"RADFN")) S RAERR="Internal Patient ID Missing" Q
"RTN","RAHLO",36,0)
 I '$D(^TMP("RARPT-REC",$J,RASUB,"RADTI")) S RAERR="Missing Exam Date" Q
"RTN","RAHLO",37,0)
 I '$D(^TMP("RARPT-REC",$J,RASUB,"RALONGCN")) S RAERR="Missing Exam Date and/or Case Number" Q
"RTN","RAHLO",38,0)
 I '$D(^TMP("RARPT-REC",$J,RASUB,"RASSN")) S RAERR="Missing Patient ID" Q
"RTN","RAHLO",39,0)
 D CHECK ; check the validity of our data.
"RTN","RAHLO",40,0)
XIT ; Kill and quit
"RTN","RAHLO",41,0)
 K A,B,DFN,K,RACNI,RADX,RADENDUM,RADFN,RADTI,RADUZ,RAIMGTY,RALONGCN,RAMDIV,RAMDV,RAMLC,RAQUIET,RADPIECE,RARPT,RARPTSTS,RASSN,RAVLDT,X,Y,RATRANSC
"RTN","RAHLO",42,0)
 Q
"RTN","RAHLO",43,0)
CHECK ; Check if our data is valid.
"RTN","RAHLO",44,0)
 S RACNI=$G(^TMP("RARPT-REC",$J,RASUB,"RACNI"))
"RTN","RAHLO",45,0)
 S RADATE=$G(^TMP("RARPT-REC",$J,RASUB,"RADATE"))
"RTN","RAHLO",46,0)
 S RADFN=$G(^TMP("RARPT-REC",$J,RASUB,"RADFN"))
"RTN","RAHLO",47,0)
 S RADTI=$G(^TMP("RARPT-REC",$J,RASUB,"RADTI"))
"RTN","RAHLO",48,0)
 S RALONGCN=$G(^TMP("RARPT-REC",$J,RASUB,"RALONGCN"))
"RTN","RAHLO",49,0)
 S RASSN=$G(^TMP("RARPT-REC",$J,RASUB,"RASSN"))
"RTN","RAHLO",50,0)
 S (RAVERF,RADUZ)=$G(^TMP("RARPT-REC",$J,RASUB,"RAVERF"))
"RTN","RAHLO",51,0)
 S RATRANSC=$G(^TMP("RARPT-REC",$J,RASUB,"RATRANSCRIPT"))
"RTN","RAHLO",52,0)
 S RASTAT=$G(^TMP("RARPT-REC",$J,RASUB,"RASTAT")) I RASTAT="A" S RADENDUM=""
"RTN","RAHLO",53,0)
 I $D(^TMP("RARPT-REC",$J,RASUB,"RAESIG")) S RAESIG=$G(^("RAESIG"))
"RTN","RAHLO",54,0)
 I $D(^TMP("RARPT-REC",$J,RASUB,"RAIMP")) D IMPTXT^RAHLO2
"RTN","RAHLO",55,0)
 I RADATE']"" S RAERR="Missing report date" Q
"RTN","RAHLO",56,0)
 I RADFN']"" S RAERR="Missing Internal Patient ID" Q
"RTN","RAHLO",57,0)
 I RACNI']"" S RAERR="Missing Case Number" Q
"RTN","RAHLO",58,0)
 I RADTI']"" S RAERR="Missing Exam Date" Q
"RTN","RAHLO",59,0)
 D DT^DILF("ET",RADATE,.RAVLDT)
"RTN","RAHLO",60,0)
 S:RAVLDT=-1 RAERR="Invalid report date" Q:$D(RAERR)
"RTN","RAHLO",61,0)
 K VA,VADM,VAERR S DFN=RADFN D DEM^VADPT
"RTN","RAHLO",62,0)
 I VADM(1)']"" S RAERR="Unknown Internal patient identifier" K VA,VADM,VAERR Q
"RTN","RAHLO",63,0)
 I RASSN'=$P(VADM(2),"^") S RAERR="Internal patient identifier and SSN don't match" K VA,VADM,VAERR Q
"RTN","RAHLO",64,0)
 I '$D(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0))!(RALONGCN']"") D  Q
"RTN","RAHLO",65,0)
 . S RAERR="Invalid Exam Date and/or Case Number"
"RTN","RAHLO",66,0)
 . Q
"RTN","RAHLO",67,0)
 D EDTCHK^RAHLQ ; is user allowed to edit report for a cancelled case?
"RTN","RAHLO",68,0)
 I RARPT=1 S RAERR="Report for CANCELLED case not permitted." Q
"RTN","RAHLO",69,0)
 I RARPT=2 S RAERR="Please use VISTA to edit CANCELLED printset cases." Q
"RTN","RAHLO",70,0)
 S RARPT=+$P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),"^",17)
"RTN","RAHLO",71,0)
 I '$D(^RARPT(RARPT,0)),($D(RADENDUM)#2) S RAERR="Can't add addendum, no report" Q
"RTN","RAHLO",72,0)
 I $D(^RARPT(RARPT,0)),($P(^(0),"^",5)'="V"),($D(RADENDUM)#2) S RAERR="Can't add addendum to an unverified report" Q
"RTN","RAHLO",73,0)
 I $D(^RARPT(RARPT,0)),$P(^(0),"^",5)="V",('$D(RADENDUM)#2) S RAERR="Report already on file" Q
"RTN","RAHLO",74,0)
 I ($D(RADENDUM)#2),'$O(^TMP("RARPT-REC",$J,RASUB,"RAIMP",0)),'$O(^TMP("RARPT-REC",$J,RASUB,"RATXT",0)) S RAERR="Missing addendum report/impression text" Q
"RTN","RAHLO",75,0)
 I $D(^RADPT(RADFN,"DT",RADTI,0)) S RAMDIV=^(0),RAMLC=+$P(RAMDIV,"^",4),RAMDIV=+$P(RAMDIV,"^",3),RAMDV=$S($D(^RA(79,RAMDIV,.1)):^(.1),1:""),RAMDV=$S(RAMDV="":RAMDV,1:$TR(RAMDV,"YyNn",1100))
"RTN","RAHLO",76,0)
 I '($D(RADENDUM)#2) I $P(RAMDV,"^",16),('$D(^TMP("RARPT-REC",$J,RASUB,"RAIMP"))) S RAERR="Missing Impression Text" Q  ; impression req'd for this division
"RTN","RAHLO",77,0)
 I ($D(RADENDUM)#2),($D(^RARPT(RARPT,0))#2),($P(RAMDV,"^",16)),('$O(^RARPT(RARPT,"I",0))),('$D(^TMP("RARPT-REC",$J,RASUB,"RAIMP"))) S RAERR="Impression Text missing for current record." Q  ; impression req'd for this division
"RTN","RAHLO",78,0)
 I $D(RADENDUM)#2 D CKDUPA^RAHLO4 I RADUPA S RAERR="Duplicate Addendum" Q
"RTN","RAHLO",79,0)
 ; check resident and staff
"RTN","RAHLO",80,0)
 N X1,X2,X3 S X2=0,X3=""
"RTN","RAHLO",81,0)
 I '$G(RATELE),+$G(^TMP("RARPT-REC",$J,RASUB,"RARESIDENT"))!(+$G(^("RASTAFF"))) D  Q:$G(RAERR)]""
"RTN","RAHLO",82,0)
 . S X1=+$G(^TMP("RARPT-REC",$J,RASUB,"RARESIDENT"))
"RTN","RAHLO",83,0)
 . I X1 D
"RTN","RAHLO",84,0)
 .. I '$D(^VA(200,"ARC","R",X1)),'$D(^VA(200,"ARC","S",X1)) S X2=1
"RTN","RAHLO",85,0)
 .. I $P($G(^VA(200,X1,"RA")),"^",3),$P(^("RA"),"^",3)'>$$DT^XLFDT S X2=X2+2
"RTN","RAHLO",86,0)
 .. I X2=1 S X3=$E($P($G(^VA(200,X1,0)),"^"),1,20)_" is not class'd as Resident or Staff"
"RTN","RAHLO",87,0)
 .. I X2=2 S X3=$P($G(^VA(200,X1,0)),"^")_"'s INACTIVE DATE is past"
"RTN","RAHLO",88,0)
 .. I X2=3 S X3=$P($G(^VA(200,X1,0)),"^")_" is not class'd as resident and past INACTIVE DATE"
"RTN","RAHLO",89,0)
 .. I X3]"" S RAERR=X3
"RTN","RAHLO",90,0)
 . S X2=0,X3="" S X1=+$G(^TMP("RARPT-REC",$J,RASUB,"RASTAFF"))
"RTN","RAHLO",91,0)
 . I X1 D
"RTN","RAHLO",92,0)
 .. I '$D(^VA(200,"ARC","S",X1)) S X2=1
"RTN","RAHLO",93,0)
 .. I $P($G(^VA(200,X1,"RA")),"^",3),$P(^("RA"),"^",3)'>$$DT^XLFDT S X2=X2+2
"RTN","RAHLO",94,0)
 .. I X2=1 S X3=$E($P($G(^VA(200,X1,0)),"^"),1,20)_" is not class'd as staff"
"RTN","RAHLO",95,0)
 .. I X2=2 S X3=$P($G(^VA(200,X1,0)),"^")_"'s INACTIVE DATE is past"
"RTN","RAHLO",96,0)
 .. I X2=3 S X3=$P($G(^VA(200,X1,0)),"^")_" is not class'd as staff and past INACTIVE DATE"
"RTN","RAHLO",97,0)
 .. I X3]"" S RAERR=$S($G(RAERR)]"":RAERR_", ",1:"")_X3
"RTN","RAHLO",98,0)
 . Q
"RTN","RAHLO",99,0)
 ; raesig is in alphanumeric format, so shouldn't use $g of it here
"RTN","RAHLO",100,0)
 I ($G(RAESIG)]"")!($G(RAVERF)) D:'$G(RATELE) VERCHK^RAHLO3 ; check if provider can verify report
"RTN","RAHLO",101,0)
 ; if verifier fails checks,
"RTN","RAHLO",102,0)
 ;   quit only if vendor is non-kurzweil,
"RTN","RAHLO",103,0)
 ;   if vendor is kurzweil, continue on by deleting raerr, raverf
"RTN","RAHLO",104,0)
 I $D(RAERR) Q:$G(^TMP("RARPT-REC",$J,RASUB,"VENDOR"))'="KURZWEIL"  K RAERR,RAVERF
"RTN","RAHLO",105,0)
 S RAIMGTY=$$IMGTY^RAUTL12("l",RAMLC) I '$L(RAIMGTY) S RAERR="No Imaging Type for Location where exam was performed" Q
"RTN","RAHLO",106,0)
 K RASECDX ;clear secondary dx array because RAHLO2 may not be called
"RTN","RAHLO",107,0)
 ; 09/07/2005 108405 KAM- Removed ('$D(RADENDUM)#2) from next line
"RTN","RAHLO",108,0)
 I $G(RATELE),'$D(RADENDUM),'$D(^TMP("RARPT-REC",$J,RASUB,"RADX")) D  ;Patch 84
"RTN","RAHLO",109,0)
 .I RASTAT="R" S:$D(RATELEDR) ^TMP("RARPT-REC",$J,RASUB,"RADX",1)=RATELEDR Q
"RTN","RAHLO",110,0)
 .S:$D(RATELEDF) ^TMP("RARPT-REC",$J,RASUB,"RADX",1)=RATELEDF
"RTN","RAHLO",111,0)
 D:$D(^TMP("RARPT-REC",$J,RASUB,"RADX")) DIAG^RAHLO2 Q:$D(RAERR)  ; DX code check took out - &('$D(RADENDUM)#2)
"RTN","RAHLO",112,0)
 ; edit sec Dx codes if they exist for non-addendums
"RTN","RAHLO",113,0)
 ; 09/07/2005 108405 KAM - Removed ('$D(RADENDUM)#2)from next line
"RTN","RAHLO",114,0)
 I $D(RASECDX) D SECDX^RAHLO2 Q:$D(RAERR)
"RTN","RAHLO",115,0)
 S B=0 F A="I","R" D  Q:$D(RAERR)
"RTN","RAHLO",116,0)
 . Q:A="R"&('$D(^TMP("RARPT-REC",$J,RASUB,"RATXT")))  ; no rpt text
"RTN","RAHLO",117,0)
 . Q:A="I"&('$D(^TMP("RARPT-REC",$J,RASUB,"RAIMP")))  ; no imp text
"RTN","RAHLO",118,0)
 . S B=$$TEXT^RAHLO3(A)
"RTN","RAHLO",119,0)
 . S:'B RAERR=$$ERR^RAHLO2(A)
"RTN","RAHLO",120,0)
 . Q
"RTN","RAHLO",121,0)
 I $G(RATELE),$G(RARPT) D  Q:$D(RAERR)  ;PATCH 84
"RTN","RAHLO",122,0)
 .I $D(^RARPT(RARPT,0)) D LOCK^DILF($NA(^RARPT(RARPT))) E  S RAERR="Report: "_$P($G(^RARPT(RARPT,0)),"^")_" Locked on VISTA site" Q
"RTN","RAHLO",123,0)
 .L -^RARPT(RARPT)
"RTN","RAHLO",124,0)
 I $G(RATELE),$L($G(RATELEPI)),RATELEPI'?10N S RAERR="Incorrect Teleradiologist's NPI: "_RATELEPI Q
"RTN","RAHLO",125,0)
 D RPTSTAT^RAHLO3 ; determine the status of the report
"RTN","RAHLO",126,0)
 D FILE^RAHLO1:'$D(RAERR)
"RTN","RAHLO",127,0)
 Q
"RTN","RAHLO1")
0^14^B58238892^B46467982
"RTN","RAHLO1",1,0)
RAHLO1 ;HIRMFO/GJC/BNT-File rpt (data from bridge program) ;6/25/04  11:49
"RTN","RAHLO1",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**4,5,12,17,21,27,48,55,66,87,84**;Mar 16, 1998;Build 13
"RTN","RAHLO1",3,0)
 ; 11/15/2007 BAY/KAM RA*5*87 Rem Call 216332 Correct UNDEF on null dx code
"RTN","RAHLO1",4,0)
 ; 09/07/2005 108405 - KAM/BAY Allow Radiology to accept dx codes from Talk Technology
"RTN","RAHLO1",5,0)
 ; 09/29/2005 114302 KAM/BAY Code Added to trigger alert on 2ndary dx
"RTN","RAHLO1",6,0)
 ;
"RTN","RAHLO1",7,0)
 ;Integration Agreements
"RTN","RAHLO1",8,0)
 ;----------------------
"RTN","RAHLO1",9,0)
 ;DIE(10018); ,FILE^DIE(2053); IX^DIK(10013); CREATE^WVRALINK(4793); $$NOW^XLFDT(10103)
"RTN","RAHLO1",10,0)
 ;EN^XUSHSHP(10045)
"RTN","RAHLO1",11,0)
 ;
"RTN","RAHLO1",12,0)
FILE ;Create Entry in File 74 and File Data
"RTN","RAHLO1",13,0)
 I '$D(ZTQUEUED) N ZTQUEUED S ZTQUEUED="1^dummy to suppress screen displays in UP2^RAUTL1 and elsewhere"
"RTN","RAHLO1",14,0)
 I '$D(RAQUIET) N RAQUIET S RAQUIET="1^dummy to suppress screen display in PTR^RARTE2"
"RTN","RAHLO1",15,0)
 N RADATIME S RADATIME=$$NOW^XLFDT() I $L($P(RADATIME,".",2))>4 S RADATIME=$P(RADATIME,".",1)_"."_$E($P(RADATIME,".",2),1,4) S RADATIME=+RADATIME
"RTN","RAHLO1",16,0)
 S RADPIECE=$S($D(^VA(200,"ARC","S",+$G(RAVERF))):15,$D(^VA(200,"ARC","R",+$G(RAVERF))):12,1:"")
"RTN","RAHLO1",17,0)
 N:'$D(RAPRTSET) RAPRTSET N:'$D(RAMEMARR) RAMEMARR
"RTN","RAHLO1",18,0)
 D EN2^RAUTL20(.RAMEMARR) ; 04/30/99 always recalculate RAPRTSET
"RTN","RAHLO1",19,0)
 ; If the report (stub/real) exists, unverify the existing report... Else create a new report
"RTN","RAHLO1",20,0)
 I RARPT,$D(^RARPT(RARPT,0)) S RASAV=RARPT D  S RARPT=RASAV K RASAV Q:$D(RAERR)  G LOCK1
"RTN","RAHLO1",21,0)
 . ; must save off RARPT, RAVERF and other RA* variables because
"RTN","RAHLO1",22,0)
 . ; they are being killed off somewhere in the 'Unverify A Report'
"RTN","RAHLO1",23,0)
 . ; option. 'Unverify A Report' does lock the the report record in file 74!
"RTN","RAHLO1",24,0)
 . N RADFN,RADTI,RACNI,RARPTSTS,RASSN,RADATE,RALONGCN,RAVERF
"RTN","RAHLO1",25,0)
 . ; if report isn't a stub report, then consider it being edited
"RTN","RAHLO1",26,0)
 . S:'$$STUB^RAEDCN1(RARPT) RAEDIT=1
"RTN","RAHLO1",27,0)
 . I $D(RADENDUM)#2,($P(^RARPT(RARPT,0),"^",5)="V") D  Q  ; edit on current record (for activity log)
"RTN","RAHLO1",28,0)
 .. D UNVER^RARTE1(RARPT)
"RTN","RAHLO1",29,0)
 .. Q
"RTN","RAHLO1",30,0)
 . K ^RARPT(RARPT,"I"),^("R"),^("H")
"RTN","RAHLO1",31,0)
 . Q
"RTN","RAHLO1",32,0)
 ; New report logic @NEW1
"RTN","RAHLO1",33,0)
NEW1 S I=$P(^RARPT(0),"^",3)
"RTN","RAHLO1",34,0)
 ;since this is a new report (not linked to an exam), directly lock the new record *1 lR*
"RTN","RAHLO1",35,0)
LOCK S I=I+1 L +^RARPT(I):1 G:'$T LOCK I ($D(^RARPT(I))#2) L -^RARPT(I) G LOCK
"RTN","RAHLO1",36,0)
 S ^RARPT(I,0)=RALONGCN,RARPT=I,^(0)=$P(^RARPT(0),"^",1,2)_"^"_I_"^"_($P(^(0),"^",4)+1)
"RTN","RAHLO1",37,0)
 ;if case is member of a print set, then create sub-recs for file #74
"RTN","RAHLO1",38,0)
 G:'RAPRTSET LOCK1
"RTN","RAHLO1",39,0)
 I '$D(RARPTN) N RARPTN S RARPTN=RALONGCN
"RTN","RAHLO1",40,0)
 N RAXIT D PTR^RARTE2 ;create corresponding subrecs in ^RARPT()
"RTN","RAHLO1",41,0)
 ;
"RTN","RAHLO1",42,0)
 ;if RAERR unlock the report record (locked @LOCK), kill vars, & exit
"RTN","RAHLO1",43,0)
 I $D(RAERR) D LOCKR^RAHLTCPU(.RAERR,1) D KVAR Q  ; *1 uR*
"RTN","RAHLO1",44,0)
 ;
"RTN","RAHLO1",45,0)
LOCK1 I $D(RAESIG) S X=RAESIG,X1=$G(RAVERF),X2=RARPT D EN^XUSHSHP S RAESIG=X
"RTN","RAHLO1",46,0)
 K DA,DIE,DQ,DR S DA=RARPT,DIE="^RARPT("
"RTN","RAHLO1",47,0)
 S DR="5////"_RARPTSTS ; rpt status
"RTN","RAHLO1",48,0)
 ;Verifier & Verified date will be set if RAVERF exists for new
"RTN","RAHLO1",49,0)
 ;reports, edits, and addendums.  Date rpt entered and reported date
"RTN","RAHLO1",50,0)
 ;will be set for new reports, and not reset for edits and addendums
"RTN","RAHLO1",51,0)
 S DR=DR_";6////"_$S($D(RAEDIT):"",1:RADATIME) ; date/time rpt entered
"RTN","RAHLO1",52,0)
 S DR=DR_";7////"_$S($G(RAVERF)&(RARPTSTS="V"):RADATIME,1:"") ; v'fied date/time
"RTN","RAHLO1",53,0)
 S DR=DR_";8////"_$S($D(RAEDIT):"",1:RADATE) ; reported date
"RTN","RAHLO1",54,0)
 S DR=DR_";9////"_$S($G(RAVERF)&(RARPTSTS="V"):RAVERF,1:"") ; v'fying phys
"RTN","RAHLO1",55,0)
 S:$L($G(RATELENM)) DR=DR_";9.1////"_RATELENM ;Teleradiologist name - Patch 84
"RTN","RAHLO1",56,0)
 S:$L($G(RATELEPI)) DR=DR_";9.2////"_RATELEPI ;Teleradiologist NPI  - Patch 84
"RTN","RAHLO1",57,0)
 S DR=DR_";11////"_$S($G(RATRANSC):RATRANSC,$G(RAVERF):RAVERF,1:"") ; transcriptionist
"RTN","RAHLO1",58,0)
 I $G(RAVERF),(RARPTSTS="V") S DR=DR_";17////"_$G(^TMP("RARPT-REC",$J,RASUB,"RAWHOCHANGE")) ;status changed to 'verified' by
"RTN","RAHLO1",59,0)
 ; D ^DIE K DA,DR ;BNT- Moved the DIE call down three lines due to a 
"RTN","RAHLO1",60,0)
 ; problem found at Indy while testing PowerScribe.  Site was doing a
"RTN","RAHLO1",61,0)
 ; local MUMPS cross reference on one of the nodes that are set below.
"RTN","RAHLO1",62,0)
 S $P(^RARPT(RARPT,0),"^",2)=RADFN,$P(^(0),"^",3)=(9999999.9999-RADTI),$P(^(0),"^",4)=$P(RALONGCN,"-",2) ;must set manually due uneditable
"RTN","RAHLO1",63,0)
 S $P(^RARPT(RARPT,0),"^",10)=$S($D(RAESIG)&(RARPTSTS="V"):RAESIG,1:"") ; hard set because Elec Sig Code may contain a semi-colon which causes errors in DIE
"RTN","RAHLO1",64,0)
 D ^DIE K DA,DR
"RTN","RAHLO1",65,0)
 ;don't file a Pri. Dx code for teleradiology reports in the released status (P84v11 bus. rule)
"RTN","RAHLO1",66,0)
 S RARELTEL=$S(($D(RATELE)#2)&(RARPTSTS="R"):1,1:"")
"RTN","RAHLO1",67,0)
 ;
"RTN","RAHLO1",68,0)
 ; 02/08/2008 GJC replaced $G w/($D(RADX)#2) p84
"RTN","RAHLO1",69,0)
 ; 11/15/2007 BAY/KAM RA*5*87 Rem Call 216332 Changed next line to $G
"RTN","RAHLO1",70,0)
 ; 09/07/2005 108405 KAM/BAY Removed('$D(RADENDUM)#2) from next line
"RTN","RAHLO1",71,0)
 I ($D(RADX)#2),RARELTEL="" D  Q:($D(RAERR))#2
"RTN","RAHLO1",72,0)
 .;now a silent FM call w/p84 due to xref being killed when stuffing an identical Dx code
"RTN","RAHLO1",73,0)
 .;as the one already on file.
"RTN","RAHLO1",74,0)
 .N RAFDA,RAIENS S RAIENS=RACNI_","_RADTI_","_RADFN_","
"RTN","RAHLO1",75,0)
 .S RAFDA(70.03,RAIENS,13)=RADX
"RTN","RAHLO1",76,0)
 .;lock the exam record, if the lock fails unlock the report record (locked @LOCK) & quit
"RTN","RAHLO1",77,0)
 .D LOCKX^RAHLTCPU(.RAERR) ;*1 lE*
"RTN","RAHLO1",78,0)
 .I ($D(RAERR)#2) D LOCKR^RAHLTCPU(.RAERR,1) Q  ;*1 uR*
"RTN","RAHLO1",79,0)
 .K RAERR D FILE^DIE(,"RAFDA","RAERR") D LOCKX^RAHLTCPU(.RAERR,1) ;*1 uE*
"RTN","RAHLO1",80,0)
 .I ($D(RAERR("DIERR"))#2) D  Q
"RTN","RAHLO1",81,0)
 ..;set the error dialog; unlock the report (locked @LOCK) *1 uR*
"RTN","RAHLO1",82,0)
 ..D LOCKR^RAHLTCPU(.RAERR,1) S RAERR=$G(RAERR("DIERR",1,"TEXT",1))
"RTN","RAHLO1",83,0)
 ..Q
"RTN","RAHLO1",84,0)
 .S:$P(^RA(78.3,+RADX,0),"^",4)="y" RAAB=1
"RTN","RAHLO1",85,0)
 .Q
"RTN","RAHLO1",86,0)
 ;
"RTN","RAHLO1",87,0)
 K RARELTEL
"RTN","RAHLO1",88,0)
 ; 09/29/2005 114302 KAM/BAY Code Added to trigger alert on 2ndary dx
"RTN","RAHLO1",89,0)
 I $D(RASECDX) D
"RTN","RAHLO1",90,0)
 . N RAX S RAX=0
"RTN","RAHLO1",91,0)
 . F  S RAX=$O(RASECDX(RAX)) Q:RAX'>0  D
"RTN","RAHLO1",92,0)
 .. S:$P(^RA(78.3,+RAX,0),"^",4)="y" RAAB=1
"RTN","RAHLO1",93,0)
 ;
"RTN","RAHLO1",94,0)
 I '$D(RADENDUM)#2,($G(^TMP("RARPT-REC",$J,RASUB,"RASTAFF"))!$G(^("RARESIDENT"))) D
"RTN","RAHLO1",95,0)
 . K DIE,DA S DR=""
"RTN","RAHLO1",96,0)
 . S RAPRIMAR=+$G(^TMP("RARPT-REC",$J,RASUB,"RARESIDENT")) I $D(^VA(200,"ARC","R",RAPRIMAR)) S DR="12////"_RAPRIMAR
"RTN","RAHLO1",97,0)
 . S RAPRIMAR=+$G(^TMP("RARPT-REC",$J,RASUB,"RASTAFF")) I $D(^VA(200,"ARC","S",RAPRIMAR)) S DR=$S(DR]"":DR_";",1:"")_"15////"_RAPRIMAR
"RTN","RAHLO1",98,0)
 . Q:'$G(DR)
"RTN","RAHLO1",99,0)
 . S DA=RACNI,DA(1)=RADTI,DA(2)=RADFN
"RTN","RAHLO1",100,0)
 . D LOCKX^RAHLTCPU(.RAERR) ;*2 lE*
"RTN","RAHLO1",101,0)
 . S DIE="^RADPT("_DA(2)_",""DT"","_DA(1)_",""P"","
"RTN","RAHLO1",102,0)
 . D ^DIE K DIE,DA,DR
"RTN","RAHLO1",103,0)
 . D LOCKX^RAHLTCPU(.RAERR,1) ;*2 uE*
"RTN","RAHLO1",104,0)
 . Q
"RTN","RAHLO1",105,0)
 ;
"RTN","RAHLO1",106,0)
 S $P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),"^",17)=RARPT I $G(RADPIECE),$P(^(0),"^",RADPIECE)="",('$D(RADENDUM)#2) D SETPHYS^RAHLO4
"RTN","RAHLO1",107,0)
 ; file impression text if present & not an addendum
"RTN","RAHLO1",108,0)
 I '$D(RADENDUM) D
"RTN","RAHLO1",109,0)
 . S J=0 I $O(^TMP("RARPT-REC",$J,RASUB,"RAIMP",0)) S I=0 F J=0:1 S I=$O(^TMP("RARPT-REC",$J,RASUB,"RAIMP",I)) Q:I'>0  I $D(^(I)) S ^RARPT(RARPT,"I",(J+1),0)=$G(^TMP("RARPT-REC",$J,RASUB,"RAIMP",I))
"RTN","RAHLO1",110,0)
 . S:J ^RARPT(RARPT,"I",0)="^^"_J_"^"_J_"^"_RADATE
"RTN","RAHLO1",111,0)
 . Q
"RTN","RAHLO1",112,0)
 ; file report text if present & not an addendum
"RTN","RAHLO1",113,0)
 I '$D(RADENDUM) D
"RTN","RAHLO1",114,0)
 . S J=0 I $O(^TMP("RARPT-REC",$J,RASUB,"RATXT",0)) S I=0 F J=0:1 S I=$O(^TMP("RARPT-REC",$J,RASUB,"RATXT",I)) Q:I'>0  I $D(^(I)) S ^RARPT(RARPT,"R",(J+1),0)=$G(^TMP("RARPT-REC",$J,RASUB,"RATXT",I))
"RTN","RAHLO1",115,0)
 . S:J ^RARPT(RARPT,"R",0)="^^"_J_"^"_J_"^"_RADATE
"RTN","RAHLO1",116,0)
 . Q
"RTN","RAHLO1",117,0)
 ; if addendum, add addendum text to impression or report
"RTN","RAHLO1",118,0)
 I $D(RADENDUM),($O(^TMP("RARPT-REC",$J,RASUB,"RAIMP",0))!$O(^TMP("RARPT-REC",$J,RASUB,"RATXT",0))) D ADENDUM^RAHLO2 ; store new lines at the end of existing text
"RTN","RAHLO1",119,0)
 ;
"RTN","RAHLO1",120,0)
 ;
"RTN","RAHLO1",121,0)
 ; Check for History from Dictation
"RTN","RAHLO1",122,0)
 ; If history sent, check if previous history exists.  If previous
"RTN","RAHLO1",123,0)
 ; history then current history will follow adding 'Addendum:' before 
"RTN","RAHLO1",124,0)
 ; the text.
"RTN","RAHLO1",125,0)
 I $O(^TMP("RARPT-REC",$J,RASUB,"RAHIST",0)) D
"RTN","RAHLO1",126,0)
 . S RACNT=+$O(^RARPT(RARPT,"H",9999999),-1),RAHSTNDE=RACNT+1
"RTN","RAHLO1",127,0)
 . S RANEW=$S(RACNT>0:0,1:1)
"RTN","RAHLO1",128,0)
 . S I=0 F  S I=$O(^TMP("RARPT-REC",$J,RASUB,"RAHIST",I)) Q:I'>0  D
"RTN","RAHLO1",129,0)
 . . S RACNT=RACNT+1
"RTN","RAHLO1",130,0)
 . . S RALN=$G(^TMP("RARPT-REC",$J,RASUB,"RAHIST",I))
"RTN","RAHLO1",131,0)
 . . S:'RANEW&(I=$O(^TMP("RARPT-REC",$J,RASUB,"RAHIST",0))) RALN="Addendum: "_RALN ; if the first line, append 'Addendum:'
"RTN","RAHLO1",132,0)
 . . I (RAHSTNDE=RACNT),(RACNT>1) S ^RARPT(RARPT,"H",RACNT,0)=" ",RACNT=RACNT+1
"RTN","RAHLO1",133,0)
 . . S ^RARPT(RARPT,"H",RACNT,0)=RALN
"RTN","RAHLO1",134,0)
 . . Q
"RTN","RAHLO1",135,0)
 . S ^RARPT(RARPT,"H",0)="^^"_RACNT_"^"_RACNT_"^"_RADATE
"RTN","RAHLO1",136,0)
 . Q
"RTN","RAHLO1",137,0)
 ;
"RTN","RAHLO1",138,0)
 ;
"RTN","RAHLO1",139,0)
 I $P(^RARPT(RARPT,0),U,5)="V",$T(CREATE^WVRALINK)]"" D CREATE^WVRALINK(RADFN,RADTI,RACNI) ; women's health
"RTN","RAHLO1",140,0)
 G:'RAPRTSET UPACT ; the next section is for printsets only
"RTN","RAHLO1",141,0)
 ; copy DX (prim & sec), Prim Resid, Prim Staff
"RTN","RAHLO1",142,0)
 N RACNISAV,RA7
"RTN","RAHLO1",143,0)
 N RA13,RA12,RA15 ;prim dx, prim resid, prim staff, rpt pointer
"RTN","RAHLO1",144,0)
 S RACNISAV=RACNI,RA7=0
"RTN","RAHLO1",145,0)
 S RA13=$P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),U,13),RA12=$P(^(0),U,12),RA15=$P(^(0),U,15)
"RTN","RAHLO1",146,0)
 F  S RA7=$O(RAMEMARR(RA7)) Q:RA7=""  I RACNISAV'=RA7 S RACNI=RA7 D UPMEM^RAHLO4 I $D(RASECDX),('$D(RADENDUM)#2) D SECDX^RAHLO2
"RTN","RAHLO1",147,0)
 S RACNI=RACNISAV
"RTN","RAHLO1",148,0)
 ;Update Activity Log
"RTN","RAHLO1",149,0)
UPACT S DA=RARPT,DIE="^RARPT(",DR="100///""NOW""",DR(2,74.01)="2////"_$S(RARPTSTS="V":"V",$D(RAEDIT):"E",1:"I")_";3////"_$S($G(RAVERF):RAVERF,$G(RATRANSC):RATRANSC,1:"") D ^DIE K DA,DR,DE,DQ,DIE
"RTN","RAHLO1",150,0)
 ; use ix^dik to kill before setting xrefs
"RTN","RAHLO1",151,0)
 S DA=RARPT,DIK="^RARPT(",RAQUEUED=1 D IX^DIK
"RTN","RAHLO1",152,0)
 L -^RARPT(RARPT) ;(1 uR) conventionally unlock the report locked @LOCK
"RTN","RAHLO1",153,0)
 ;
"RTN","RAHLO1",154,0)
 ;If verified, update report & exam statuses; else, just update exam status
"RTN","RAHLO1",155,0)
 ;Note: be careful; exam locks are executed within UP1^RAUTL1!
"RTN","RAHLO1",156,0)
 I $D(RAMDV),RAMDV'="" D:RARPTSTS="V" UPSTAT^RAUTL0 D:RARPTSTS'="V" UP1^RAUTL1
"RTN","RAHLO1",157,0)
 D:'$D(RAERR)&($G(^TMP("RARPT-REC",$J,RASUB,"VENDOR"))'="KURZWEIL") GENACK^RAHLTCPB ; generate 'ACK' message
"RTN","RAHLO1",158,0)
 ;
"RTN","RAHLO1",159,0)
PACS ;If there are subscribers to RA RPT xxx events broadcast ORU mesages to those subscribers
"RTN","RAHLO1",160,0)
 ;via TASK^RAHLO4. If VOICE DICTATION AUTO-PRINT (#26) field is set to 'Y' print the report to
"RTN","RAHLO1",161,0)
 ;the printer defined in the REPORT PRINTER NAME (#10) field via VOICE^RAHLO4.
"RTN","RAHLO1",162,0)
 I ($P(^RARPT(RARPT,0),U,5)="V")!($P(^(0),U,5)="R") D TASK^RAHLO4,VOICE^RAHLO4
"RTN","RAHLO1",163,0)
 ;
"RTN","RAHLO1",164,0)
KVAR K RAAB,RAEDIT,RAESIG,RAQUEUED,RARPT,RAHIST
"RTN","RAHLO1",165,0)
 Q
"RTN","RAHLO1",166,0)
 ;
"RTN","RAHLO2")
0^17^B22560890^B19096682
"RTN","RAHLO2",1,0)
RAHLO2 ;HIRMFO/GJC-File rpt (data from bridge program) ;10/30/97  09:02
"RTN","RAHLO2",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**55,80,84**;Mar 16, 1998;Build 13
"RTN","RAHLO2",3,0)
 ;
"RTN","RAHLO2",4,0)
 ;Integration Agreements
"RTN","RAHLO2",5,0)
 ;----------------------
"RTN","RAHLO2",6,0)
 ;$$FIND1^DIC(2051); UPDATE^DIE(2053); $$DT^XLFDT(10103); $$UP^XLFSTR(10104)
"RTN","RAHLO2",7,0)
 ;
"RTN","RAHLO2",8,0)
ADENDUM ; This functions store new lines of text at the end of the existing 
"RTN","RAHLO2",9,0)
 ;impression and report text. If this report is being amended through the
"RTN","RAHLO2",10,0)
 ;teleradiology service, add the addendum text to the IMPRESSION TEXT (#300)
"RTN","RAHLO2",11,0)
 ;field only. Note: Only ADENDUM was edited for RA*5.0*84 gjc/09.18.07
"RTN","RAHLO2",12,0)
 N A,COUNTER,I,J,NODE,ROOT,SUB,X,Y
"RTN","RAHLO2",13,0)
 ;NODE = ^RARPT(RARPT,"I" -or- "R"  -> where the data is to be stored...
"RTN","RAHLO2",14,0)
 ;ROOT = ^TMP("RARPT-REC",$J,RASUB  -> where the addendum data resides...
"RTN","RAHLO2",15,0)
 F A="I","R" D  K I,J
"RTN","RAHLO2",16,0)
 .S SUB=$S(A="I":"RAIMP",1:"RATXT"),ROOT=$NA(^TMP("RARPT-REC",$J,RASUB,SUB)) Q:'$O(@ROOT@(0))
"RTN","RAHLO2",17,0)
 .S NODE=$NA(^RARPT(RARPT,A))
"RTN","RAHLO2",18,0)
 .S COUNTER=+$O(@NODE@($C(32)),-1) ;last record #
"RTN","RAHLO2",19,0)
 .;
"RTN","RAHLO2",20,0)
 .;if there is existing text, add a null line for space.
"RTN","RAHLO2",21,0)
 .I '($D(I)#2),(COUNTER>0) S COUNTER=COUNTER+1,@NODE@(COUNTER,0)=$C(32),I=""
"RTN","RAHLO2",22,0)
 .;
"RTN","RAHLO2",23,0)
 .S Y=0 F  S Y=$O(@ROOT@(Y)) Q:'Y  D
"RTN","RAHLO2",24,0)
 ..S X=@ROOT@(Y)
"RTN","RAHLO2",25,0)
 ..;if addendum text is to be the original text no spacer is needed ('Addendum:' tag applied)
"RTN","RAHLO2",26,0)
 ..;if prior report or impression text exist, insert a blank as a spacer
"RTN","RAHLO2",27,0)
 ..;^RARPT(RARPT,"I",1,0)="original impression"
"RTN","RAHLO2",28,0)
 ..;^RARPT(RARPT,"I",2,0)="" <- insert a null line as a spacer
"RTN","RAHLO2",29,0)
 ..;^RARPT(RARPT,"I",3,0)="Addendum: first line of addendum" ** NOTE 'Addendum:' tag **
"RTN","RAHLO2",30,0)
 ..;^RARPT(RARPT,"I",4,0)="second line of addendum"
"RTN","RAHLO2",31,0)
 ..;...
"RTN","RAHLO2",32,0)
 ..;^RARPT(RARPT,"I",N,0)="Nth and last line of addendum"
"RTN","RAHLO2",33,0)
 ..S COUNTER=COUNTER+1
"RTN","RAHLO2",34,0)
 ..;set the first line of the addendum w/header: 'Addendum: '
"RTN","RAHLO2",35,0)
 ..I '($D(J)#2) S X="Addendum: "_X,J=""
"RTN","RAHLO2",36,0)
 ..S @NODE@(COUNTER,0)=X
"RTN","RAHLO2",37,0)
 ..Q
"RTN","RAHLO2",38,0)
 .S @NODE@(0)="^^"_COUNTER_"^"_COUNTER_"^"_$$DT^XLFDT()
"RTN","RAHLO2",39,0)
 .Q
"RTN","RAHLO2",40,0)
 Q
"RTN","RAHLO2",41,0)
 ;
"RTN","RAHLO2",42,0)
ERR(A) ; Invalid impression/report text message.
"RTN","RAHLO2",43,0)
 ; Input: 'A' - either "I" for impression, or "R" for report
"RTN","RAHLO2",44,0)
 ; Output: the appropriate error message
"RTN","RAHLO2",45,0)
 Q "Invalid "_$S(A="I":"Impression",1:"Report")_" Text"
"RTN","RAHLO2",46,0)
 ;
"RTN","RAHLO2",47,0)
DIAG ; Check if the Diagnostic Codes passed are valid.  Set RADX equal
"RTN","RAHLO2",48,0)
 ; to primary Dx code pntr value.  Set RASECDX(x) to the secondary
"RTN","RAHLO2",49,0)
 ; Dx code(s) if any.
"RTN","RAHLO2",50,0)
 N RAXFIRST
"RTN","RAHLO2",51,0)
 S I=0,RAXFIRST=1
"RTN","RAHLO2",52,0)
 K RASECDX
"RTN","RAHLO2",53,0)
 F  S I=$O(^TMP("RARPT-REC",$J,RASUB,"RADX",I)) Q:I'>0  D  Q:$D(RAERR)
"RTN","RAHLO2",54,0)
 . S RADIAG=$G(^TMP("RARPT-REC",$J,RASUB,"RADX",I))
"RTN","RAHLO2",55,0)
 . ;S:RADIAG']"" RAERR="Missing Diagnostic Code" Q:$D(RAERR)
"RTN","RAHLO2",56,0)
 . Q:RADIAG']""  ;Missing Diagnostic Code  Patch 80
"RTN","RAHLO2",57,0)
 . ; If RADXIEN is a number, set RADXIEN to what is assumed to be a
"RTN","RAHLO2",58,0)
 . ; valid pointer (ien) for file 78.3
"RTN","RAHLO2",59,0)
 . I +RADIAG=RADIAG S RADXIEN=RADIAG
"RTN","RAHLO2",60,0)
 . ; If RADIAG is in a free text format, convert the external value
"RTN","RAHLO2",61,0)
 . ; into the ien for file 78.3
"RTN","RAHLO2",62,0)
 . I +RADIAG'=RADIAG S RADXIEN=$$FIND1^DIC(78.3,"","X",RADIAG)
"RTN","RAHLO2",63,0)
 . I '$D(^RA(78.3,RADXIEN,0)) S RAERR="Invalid Diagnostic Code" Q
"RTN","RAHLO2",64,0)
 . IF RAXFIRST S RADX=RADXIEN,RAXFIRST=0 Q  ; RADX=pri. Dx Code
"RTN","RAHLO2",65,0)
 . ; are any of the sec. Dx codes equal to our pri. Dx code?
"RTN","RAHLO2",66,0)
 . ;S:RADXIEN=RADX RAERR="Secondary Dx codes must differ from the primary Dx code." Q:$D(RAERR)
"RTN","RAHLO2",67,0)
 . Q:RADXIEN=RADX  ;Secondary Dx codes must differ from the primary Dx code  Patch 80
"RTN","RAHLO2",68,0)
 . ;S:$D(RASECDX(RADXIEN))#2 RAERR="Duplicate secondary Dx codes." Q:$D(RAERR)
"RTN","RAHLO2",69,0)
 . Q:$D(RASECDX(RADXIEN))#2  ;Duplicate secondary Dx codes. Patch 80
"RTN","RAHLO2",70,0)
 . S RASECDX(RADXIEN)="" ; set the sec. Dx array
"RTN","RAHLO2",71,0)
 . Q
"RTN","RAHLO2",72,0)
 K I,RADIAG,RADXIEN
"RTN","RAHLO2",73,0)
 Q
"RTN","RAHLO2",74,0)
SECDX ; Kill old sec. Dx nodes, and add the new ones into the 70.14 multiple
"RTN","RAHLO2",75,0)
 ; called from RAHLO.  Needs RADFN,RADTI & RACNI to function.
"RTN","RAHLO2",76,0)
 Q:'$D(RADFN)!('$D(RADTI))!('$D(RACNI))
"RTN","RAHLO2",77,0)
 I $O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"DX",0)) D KILSECDG^RAHLO4
"RTN","RAHLO2",78,0)
 ;K RAFDA N RAX S RAX=0,RAFDA(70,"?1,",.01)=RADFN
"RTN","RAHLO2",79,0)
 ;S RAFDA(70.02,"?2,?1,",.01)=(9999999.9999-RADTI)
"RTN","RAHLO2",80,0)
 ;S RAFDA(70.03,"?3,?2,?1,",.01)=$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),"^")
"RTN","RAHLO2",81,0)
 ;F  S RAX=$O(RASECDX(RAX)) Q:RAX'>0  D
"RTN","RAHLO2",82,0)
 ;. S RAFDA(70.14,"?"_RAX_"9,?3,?2,?1,",.01)=RAX
"RTN","RAHLO2",83,0)
 ;. Q
"RTN","RAHLO2",84,0)
 ;D UPDATE^DIE("","RAFDA",,"RAERR")
"RTN","RAHLO2",85,0)
 ;I $D(RAERR) M ^TMP("ERR")=RAERR
"RTN","RAHLO2",86,0)
 ;
"RTN","RAHLO2",87,0)
 N RAX S RAX=0
"RTN","RAHLO2",88,0)
 N RAFDA,RA2
"RTN","RAHLO2",89,0)
 K RAFDA
"RTN","RAHLO2",90,0)
 ; K ^TMP("RAERR",$J)
"RTN","RAHLO2",91,0)
 S RA2=RACNI_","_RADTI_","_RADFN
"RTN","RAHLO2",92,0)
 F  S RAX=$O(RASECDX(RAX)) Q:RAX'>0  D
"RTN","RAHLO2",93,0)
 . S RAFDA(70.14,"?+"_RAX_"9,"_RA2_",",.01)=RAX
"RTN","RAHLO2",94,0)
 D UPDATE^DIE("","RAFDA",,"RAERR")
"RTN","RAHLO2",95,0)
 ; I $D(RAERR) M ^TMP("RAERR",$J)=RAERR
"RTN","RAHLO2",96,0)
 ;
"RTN","RAHLO2",97,0)
 Q
"RTN","RAHLO2",98,0)
IMPTXT ; Check if the impression text consists only of the string
"RTN","RAHLO2",99,0)
 ; 'impression:".  If 'impression:' is the only set of characters,
"RTN","RAHLO2",100,0)
 ; (spaces are excluded) then delete the "RAIMP" node.
"RTN","RAHLO2",101,0)
 N RA1 S RA1=$O(^TMP("RARPT-REC",$J,RASUB,"RAIMP",0))
"RTN","RAHLO2",102,0)
 Q:'RA1  N RAIMP S RAIMP=$G(^TMP("RARPT-REC",$J,RASUB,"RAIMP",RA1))
"RTN","RAHLO2",103,0)
 I $$UP^XLFSTR($E(RAIMP,1,11))="IMPRESSION:" D
"RTN","RAHLO2",104,0)
 . S $E(RAIMP,1,11)="" ; strip out 'impression:' if it is the first
"RTN","RAHLO2",105,0)
 . ;                     eleven chars of the impression text
"RTN","RAHLO2",106,0)
 . ; now strip off leading spaces from the remaining
"RTN","RAHLO2",107,0)
 . ; text that led with 'impression:' if present
"RTN","RAHLO2",108,0)
 . F I1=1:1 S:$E(RAIMP,I1)'=" " RAIMP=$E(RAIMP,I1,99999) Q:$E(RAIMP)'=" "
"RTN","RAHLO2",109,0)
 . S ^TMP("RARPT-REC",$J,RASUB,"RAIMP",RA1)=RAIMP
"RTN","RAHLO2",110,0)
 . Q
"RTN","RAHLO2",111,0)
 Q:$O(^TMP("RARPT-REC",$J,RASUB,"RAIMP",RA1))  ; more imp. text follows
"RTN","RAHLO2",112,0)
 K:$G(^TMP("RARPT-REC",$J,RASUB,"RAIMP",RA1))="" ^TMP("RARPT-REC",$J,RASUB,"RAIMP",RA1) ; if only "RAIMP" node null, delete "RAIMP" node
"RTN","RAHLO2",113,0)
 Q
"RTN","RAHLO3")
0^10^B23255414^B20660605
"RTN","RAHLO3",1,0)
RAHLO3 ;HIRMFO/GJC-Process data set from the bridge program ;11/18/97  12:13
"RTN","RAHLO3",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**4,81,84**;Mar 16, 1998;Build 13
"RTN","RAHLO3",3,0)
 ;
"RTN","RAHLO3",4,0)
 ;Integration Agreements
"RTN","RAHLO3",5,0)
 ;-----------------------
"RTN","RAHLO3",6,0)
 ;$$GET1^DIQ(2056); $$DT^XLFDT(10103)
"RTN","RAHLO3",7,0)
 ;
"RTN","RAHLO3",8,0)
RPTSTAT ; Determine the status to set this report to.
"RTN","RAHLO3",9,0)
 K RARPTSTS S:$D(RAESIG) RARPTSTS="V" Q:$D(RARPTSTS)
"RTN","RAHLO3",10,0)
 ; $D(RAESIG)=0 now figure out report status
"RTN","RAHLO3",11,0)
 N RASTAT S RASTAT=$E($G(^TMP("RARPT-REC",$J,RASUB,"RASTAT")))
"RTN","RAHLO3",12,0)
 I RASTAT="A" S RARPTSTS="V" Q
"RTN","RAHLO3",13,0)
 I RASTAT]"",("FR"[RASTAT) D
"RTN","RAHLO3",14,0)
 . S:RASTAT="F" RARPTSTS="V" Q:$D(RARPTSTS)
"RTN","RAHLO3",15,0)
 . I $G(RATELE) S RARPTSTS="R" Q  ;Always allow 'Released/Unverified' reports for teleradiology
"RTN","RAHLO3",16,0)
 . ; do we allow 'Released/Unverified' reports for this location?
"RTN","RAHLO3",17,0)
 . S RARPTSTS=$S($P($G(^RA(79.1,RAMLC,0)),"^",17)="Y":"R",1:"D")
"RTN","RAHLO3",18,0)
 . Q
"RTN","RAHLO3",19,0)
 ; if no status, & there's physician data (verifier/primary),set status
"RTN","RAHLO3",20,0)
 I '$D(RARPTSTS),($G(RAVERF)!$G(^TMP("RARPT-REC",$J,RASUB,"RASTAFF"))!$G(^("RARESIDENT"))) S RARPTSTS=$S($P($G(^RA(79.1,RAMLC,0)),"^",17)="Y":"R",1:"D")
"RTN","RAHLO3",21,0)
 ; if still no status, default to draft
"RTN","RAHLO3",22,0)
 S:'$D(RARPTSTS) RARPTSTS="D"
"RTN","RAHLO3",23,0)
 Q
"RTN","RAHLO3",24,0)
TEXT(X) ; Check if the Impression Text and the Report Text contain
"RTN","RAHLO3",25,0)
 ; valid characters.
"RTN","RAHLO3",26,0)
 ; Input : X = "I" if Impr Text is being checked, "R" if Rpt Text
"RTN","RAHLO3",27,0)
 ; Output: 0=invalid, 1=valid
"RTN","RAHLO3",28,0)
 N CNT,DATA,FLAG,I,I1,J,Y S (FLAG,I)=0
"RTN","RAHLO3",29,0)
 F  S I=$O(^TMP("RARPT-REC",$J,RASUB,$S(X="I":"RAIMP",1:"RATXT"),I)) Q:I'>0  D  Q:FLAG
"RTN","RAHLO3",30,0)
 . S CNT=0,DATA=$G(^TMP("RARPT-REC",$J,RASUB,$S(X="I":"RAIMP",1:"RATXT"),I)) Q:DATA']""
"RTN","RAHLO3",31,0)
 . F J=1:1:$L(DATA) D  Q:FLAG
"RTN","RAHLO3",32,0)
 .. S:$E(DATA,J)?1AN CNT=CNT+1
"RTN","RAHLO3",33,0)
 .. S:$E(DATA,J)'?1AN&(CNT>0) CNT=0
"RTN","RAHLO3",34,0)
 .. S:CNT=2 FLAG=1
"RTN","RAHLO3",35,0)
 .. Q
"RTN","RAHLO3",36,0)
 . Q
"RTN","RAHLO3",37,0)
 Q FLAG
"RTN","RAHLO3",38,0)
 ;
"RTN","RAHLO3",39,0)
VERCHK ; Check if our provider can verify reports.
"RTN","RAHLO3",40,0)
 ; Examine the following four (4) conditions if $D(RAESIG)
"RTN","RAHLO3",41,0)
 ; 1) Does this person have a resident or staff classification?
"RTN","RAHLO3",42,0)
 ; 2) If a resident, does the division parameter allow resident
"RTN","RAHLO3",43,0)
 ;    verification?
"RTN","RAHLO3",44,0)
 ; 3) Does this person hold the "RA VERIFY" key?
"RTN","RAHLO3",45,0)
 ; 4) Is this person an activate Rad/Nuc Med user?
"RTN","RAHLO3",46,0)
 ; 5) Can this person verify reports without staff review?
"RTN","RAHLO3",47,0)
 ; If 'No' to any of the above questions, kill RAESIG & set the variable
"RTN","RAHLO3",48,0)
 ; RAERR to the appropriate error message.
"RTN","RAHLO3",49,0)
 I '$D(^VA(200,"ARC","R",+$G(RAVERF))),('$D(^VA(200,"ARC","S",+$G(RAVERF)))),'$G(RATELE) D  Q
"RTN","RAHLO3",50,0)
 . ; neither a resident or staff
"RTN","RAHLO3",51,0)
 . K RAESIG S RAERR="Provider not classified as resident or staff."
"RTN","RAHLO3",52,0)
 . Q
"RTN","RAHLO3",53,0)
 I $D(^VA(200,"ARC","R",+$G(RAVERF))),('$P(RAMDV,"^",18)),'$G(RATELE) D  Q
"RTN","RAHLO3",54,0)
 . ; residents can't verify reports linked to this division
"RTN","RAHLO3",55,0)
 . K RAESIG S RAERR="Residents are not permitted to verify reports."
"RTN","RAHLO3",56,0)
 . Q
"RTN","RAHLO3",57,0)
 I '$D(^XUSEC("RA VERIFY",+$G(RAVERF))),'$G(RATELE) D  Q
"RTN","RAHLO3",58,0)
 . ; verifier MUST have the RA VERIFY key.
"RTN","RAHLO3",59,0)
 . K RAESIG S RAERR="Provider does not meet security requirements to verify report."
"RTN","RAHLO3",60,0)
 . Q
"RTN","RAHLO3",61,0)
 I '$G(RATELE),$P($G(^VA(200,+$G(RAVERF),"RA")),"^",3),($P(^("RA"),"^",3)'>$$DT^XLFDT()) D
"RTN","RAHLO3",62,0)
 . ; Rad/Nuc Med user has been inactivated.
"RTN","RAHLO3",63,0)
 . K RAESIG S RAERR="Inactive Rad/Nuc Med Classification for Interpreting Physician."
"RTN","RAHLO3",64,0)
 . Q
"RTN","RAHLO3",65,0)
 I '$G(RATELE),'$S('$D(^VA(200,+$G(RAVERF),"RA")):1,$P(^("RA"),"^")'="Y":1,1:0) D
"RTN","RAHLO3",66,0)
 . K RAESIG S RAERR="Staff review required to verify report."
"RTN","RAHLO3",67,0)
 . Q
"RTN","RAHLO3",68,0)
 Q
"RTN","RAHLO3",69,0)
VFIER ; Check if the RAVERF string is a partial match to an entry in file
"RTN","RAHLO3",70,0)
 ; 200.  If if is, check to see that is a partial match to only ONE
"RTN","RAHLO3",71,0)
 ; active provider entry in file 200.
"RTN","RAHLO3",72,0)
 I '$L(RAVERF) S RAERR="Missing Provider information" Q
"RTN","RAHLO3",73,0)
 N RAVCNT,RAVIEN,RAVLGTH,RAVPS
"RTN","RAHLO3",74,0)
 S RAVLGTH=$L(RAVERF) ; length of the RAVERF string
"RTN","RAHLO3",75,0)
 S RAVCNT=0,RAVS1=RAVERF,RAVIEN=""
"RTN","RAHLO3",76,0)
 F  S RAVS1=$O(^VA(200,"B",RAVS1)) Q:RAVS1=""!($E(RAVS1,1,RAVLGTH)'=RAVERF)  D  Q:RAVCNT>1
"RTN","RAHLO3",77,0)
 . ; return subscripts that have the RAVERF string as the first
"RTN","RAHLO3",78,0)
 . ; 1 - RAVLGTH chars of RAVS1
"RTN","RAHLO3",79,0)
 . S RAVIEN=0
"RTN","RAHLO3",80,0)
 . F  S RAVIEN=$O(^VA(200,"B",RAVS1,RAVIEN)) Q:RAVIEN'>0  D  Q:RAVCNT>1
"RTN","RAHLO3",81,0)
 .. S RAVPS=$G(^VA(200,RAVIEN,"PS"))
"RTN","RAHLO3",82,0)
 .. S:'$P(RAVPS,"^",4)!($P(RAVPS,"^",4)>DT) RAVCNT=RAVCNT+1
"RTN","RAHLO3",83,0)
 .. I RAVCNT=1,('$D(RAVIEN(RAVCNT))#2) S RAVIEN(RAVCNT)=RAVIEN ; when
"RTN","RAHLO3",84,0)
 .. ; we find the first active provider save the provider ien off
"RTN","RAHLO3",85,0)
 .. ; in a local array.
"RTN","RAHLO3",86,0)
 .. Q
"RTN","RAHLO3",87,0)
 . Q
"RTN","RAHLO3",88,0)
 ; Added for PowerScribe
"RTN","RAHLO3",89,0)
 I RAVIEN']"" D
"RTN","RAHLO3",90,0)
 . ;S RAVIEN=$P(RAVERF,$E(HL("ECH"),4))
"RTN","RAHLO3",91,0)
 . S RAVIEN=+RAVERF
"RTN","RAHLO3",92,0)
 . S RAVPS=$G(^VA(200,RAVIEN,"PS"))
"RTN","RAHLO3",93,0)
 . S:'$P(RAVPS,"^",4)!($P(RAVPS,"^",4)>DT) RAVCNT=RAVCNT+1
"RTN","RAHLO3",94,0)
 . I RAVCNT=1,('$D(RAVIEN(RAVCNT))#2) S RAVIEN(RAVCNT)=RAVIEN
"RTN","RAHLO3",95,0)
 . Q
"RTN","RAHLO3",96,0)
 I RAVCNT=0 S RAERR="Invalid Provider Name: "_RAVERF Q  ; partial match not found
"RTN","RAHLO3",97,0)
 I RAVCNT>1 S RAERR="Non-Unique Provider Name: "_RAVERF Q  ; >1 partial match
"RTN","RAHLO3",98,0)
 ;S RAVERF=$G(RAVIEN(1)) S:'RAVERF RAERR="Provider Name Entry Error"
"RTN","RAHLO3",99,0)
 S:'$G(RAVIEN(1)) RAERR="Provider Name Entry Error: "_RAVERF S RAVERF=$G(RAVIEN(1))
"RTN","RAHLO3",100,0)
 Q
"RTN","RAHLO3",101,0)
ESIG ; Added for COTS E-Sig capability
"RTN","RAHLO3",102,0)
 ;
"RTN","RAHLO3",103,0)
 Q:"FA"'[^TMP(RARRR,$J,RASUB,"RASTAT")!('$D(^("RAVERF")))!($D(^("RAESIG")))
"RTN","RAHLO3",104,0)
 S RADFN=+$G(^TMP(RARRR,$J,RASUB,"RADFN"))
"RTN","RAHLO3",105,0)
 S RADTI=+$G(^TMP(RARRR,$J,RASUB,"RADTI"))
"RTN","RAHLO3",106,0)
 S RADIV=$P($G(^RADPT(RADFN,"DT",RADTI,0)),"^",3)
"RTN","RAHLO3",107,0)
 Q:RADIV=""  ; exam has been deleted - will be rejected
"RTN","RAHLO3",108,0)
 ; Check division parameters for ALLOW E-SIG ON COTS REPORT in file 79
"RTN","RAHLO3",109,0)
 ; for the division that ordered this procedure.
"RTN","RAHLO3",110,0)
 I $P(^RA(79,RADIV,.1),"^",27)["Y" D
"RTN","RAHLO3",111,0)
 . S RAESIG=$$GET1^DIQ(200,RAVERF,20.2)
"RTN","RAHLO3",112,0)
 . S:RAESIG]"" ^TMP(RARRR,$J,RASUB,"RAESIG")=RAESIG
"RTN","RAHLO3",113,0)
 . Q
"RTN","RAHLO3",114,0)
 Q
"RTN","RAHLO4")
0^4^B42844660^B41347235
"RTN","RAHLO4",1,0)
RAHLO4 ;HIRMFO/GJC-File rpt (data from bridge program) ;7/21/99  11:45
"RTN","RAHLO4",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**4,8,81,84**;Mar 16, 1998;Build 13
"RTN","RAHLO4",3,0)
 ;
"RTN","RAHLO4",4,0)
 ;Integration Agreements
"RTN","RAHLO4",5,0)
 ;----------------------
"RTN","RAHLO4",6,0)
 ;NOW^%DTC(10000); %ZTLOAD(10063); FIND^DIC(2051); ^DIE(10018); ^DIK(10013); $$GET1^DIQ(2056)
"RTN","RAHLO4",7,0)
 ;GETS^DIQ(2056); ^XMD(10070)
"RTN","RAHLO4",8,0)
 ;
"RTN","RAHLO4",9,0)
TASK ; Task ORU message
"RTN","RAHLO4",10,0)
 S ZTDESC="Rad/Nuc Med Compiling HL7 ORU Message",ZTDTH=$H,ZTIO="",ZTRTN="RPT^RAHLRPC",ZTSAVE("RADFN")="",ZTSAVE("RADTI")="",ZTSAVE("RACNI")="",ZTSAVE("RARPT")=""
"RTN","RAHLO4",11,0)
 ;Next line of coding will assure that ORU (report) message will be sent after posible ORM message. (10 second)
"RTN","RAHLO4",12,0)
 S $P(ZTDTH,",",2)=$P(ZTDTH,",",2)+4 S:$P(ZTDTH,",",2)>86400 ZTDTH=$P(ZTDTH,",")+1_","_($P(ZTDTH,",",2)-86400)
"RTN","RAHLO4",13,0)
 S:$L($G(RANOSEND)) ZTSAVE("RANOSEND")="" D ^%ZTLOAD
"RTN","RAHLO4",14,0)
 K ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","RAHLO4",15,0)
 Q
"RTN","RAHLO4",16,0)
VOICE ; voice dictation auto-print (background process)
"RTN","RAHLO4",17,0)
 Q:$P(^RA(79.1,+$G(RAMLC),0),U,26)'="Y"  ; Voice Dictation Auto-Print
"RTN","RAHLO4",18,0)
 S ZTIO=$$GET1^DIQ(3.5,+$P(^RA(79.1,+$G(RAMLC),0),U,10),.01) ; dev name
"RTN","RAHLO4",19,0)
 Q:ZTIO']""  ; quit if the device does not exist
"RTN","RAHLO4",20,0)
 S ZTDTH=$H,ZTRTN="DQ^RARTR",ZTSAVE("RARPT")=""
"RTN","RAHLO4",21,0)
 S ZTDESC="Rad/Nuc Med voice dictation auto-print"
"RTN","RAHLO4",22,0)
 D ^%ZTLOAD K RAMES,ZTDESC,ZTSK,ZTIO,ZTSAVE,ZTRTN,RASV,ZTDTH
"RTN","RAHLO4",23,0)
 Q
"RTN","RAHLO4",24,0)
 ;
"RTN","RAHLO4",25,0)
UPMEM ;copy (prim:dx,stf,res),rpt ien to other members of same print set
"RTN","RAHLO4",26,0)
 ; first clear those fields
"RTN","RAHLO4",27,0)
 K DIE,DA,DR S DA=RACNI,DA(1)=RADTI,DA(2)=RADFN
"RTN","RAHLO4",28,0)
 S DIE="^RADPT("_DA(2)_",""DT"","_DA(1)_",""P"","
"RTN","RAHLO4",29,0)
 S DR="13///@;12///@;15///@" D ^DIE
"RTN","RAHLO4",30,0)
 ; now set those fields based on lead case of printset
"RTN","RAHLO4",31,0)
 S DR="13////"_RA13_";12////"_RA12_";15////"_RA15 D ^DIE K DA,DR,DIE
"RTN","RAHLO4",32,0)
 ; now set the report pointer (uneditable, thus must hard set)
"RTN","RAHLO4",33,0)
 S $P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),"^",17)=RARPT
"RTN","RAHLO4",34,0)
 Q
"RTN","RAHLO4",35,0)
SETPHYS ;set Primary Resident or Staff, either piece 12 or piece 15 of case
"RTN","RAHLO4",36,0)
 Q:RADPIECE'=15&(RADPIECE'=12)
"RTN","RAHLO4",37,0)
 S DR=RADPIECE_"////"_$G(RAVERF)
"RTN","RAHLO4",38,0)
 S DA(2)=RADFN,DA(1)=RADTI,DA=RACNI
"RTN","RAHLO4",39,0)
 S DIE="^RADPT("_DA(2)_",""DT"","_DA(1)_",""P"","
"RTN","RAHLO4",40,0)
 D ^DIE K DA,DR
"RTN","RAHLO4",41,0)
 Q
"RTN","RAHLO4",42,0)
KILSECDG ;kill secondary diagnoses nodes of this case
"RTN","RAHLO4",43,0)
 Q:'$D(RADFN)!('$D(RADTI))!('$D(RACNI))
"RTN","RAHLO4",44,0)
 Q:RADFN=""!(RADTI="")!(RACNI="")
"RTN","RAHLO4",45,0)
 Q:'$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"DX",0))
"RTN","RAHLO4",46,0)
 S DA(3)=RADFN,DA(2)=RADTI,DA(1)=RACNI
"RTN","RAHLO4",47,0)
 N RA1 S RA1=""
"RTN","RAHLO4",48,0)
K1 S RA1=$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"DX",RA1)) G:RA1="" KQ
"RTN","RAHLO4",49,0)
 S DA=RA1
"RTN","RAHLO4",50,0)
 S DIK="^RADPT("_DA(3)_",""DT"","_DA(2)_",""P"","_DA(1)_",""DX"","
"RTN","RAHLO4",51,0)
 D ^DIK
"RTN","RAHLO4",52,0)
 G K1
"RTN","RAHLO4",53,0)
KQ K DA Q
"RTN","RAHLO4",54,0)
 ;
"RTN","RAHLO4",55,0)
PCEXTR(RASUB,RASEG,RAPCE,RADEL) ; extract the right piece of data
"RTN","RAHLO4",56,0)
 ; from the right data node
"RTN","RAHLO4",57,0)
 ; input: RASUB-data node subscript
"RTN","RAHLO4",58,0)
 ;        RASEG-HL7 segment (minus the segment header)
"RTN","RAHLO4",59,0)
 ;        RAPCE-data's piece position
"RTN","RAHLO4",60,0)
 ;        RADEL-delimiter (field separator)
"RTN","RAHLO4",61,0)
 S RAHL70="",RAHL7X=0,RAHL7OFF=$L(RASEG,RADEL)
"RTN","RAHLO4",62,0)
 S RAHL7LST=$P(RASEG,RADEL,RAHL7OFF)
"RTN","RAHLO4",63,0)
 I RAPCE<RAHL7OFF S RAHL70=$P(RASEG,RADEL,RAPCE) D KILL Q RAHL70
"RTN","RAHLO4",64,0)
 I RAHL7OFF=RAPCE D  ; check if data wraps to the next node (if any)
"RTN","RAHLO4",65,0)
 . S RAHL70=$P(RASEG,RADEL,RAPCE),II1=$O(^TMP("RARPT-HL7",$J,RASUB,0))
"RTN","RAHLO4",66,0)
 . S:'II1 RAHL7X=1 Q:'II1
"RTN","RAHLO4",67,0)
 . S RAHL70=RAHL70_$P(^TMP("RARPT-HL7",$J,RASUB,II1),RADEL),RAHL7X=1
"RTN","RAHLO4",68,0)
 . Q
"RTN","RAHLO4",69,0)
 I RAHL7X D KILL Q RAHL70
"RTN","RAHLO4",70,0)
 ; check if this node has descendent data nodes
"RTN","RAHLO4",71,0)
 I '$O(^TMP("RARPT-HL7",$J,RASUB,0)) D KILL Q "" ; descendents not found
"RTN","RAHLO4",72,0)
 S I=0,RAHL7CNT=RAHL7OFF
"RTN","RAHLO4",73,0)
 F  S I=$O(^TMP("RARPT-HL7",$J,RASUB,I)) Q:I'>0  D  Q:RAHL7X
"RTN","RAHLO4",74,0)
 . S RAHL7SUB=$G(^TMP("RARPT-HL7",$J,RASUB,I))
"RTN","RAHLO4",75,0)
 . S RAHL7PRE=$O(^TMP("RARPT-HL7",$J,RASUB,I),-1)
"RTN","RAHLO4",76,0)
 . S:RAHL7PRE RAHL7LST=$$LSTPCE(^TMP("RARPT-HL7",$J,RASUB,RAHL7PRE),RADEL)
"RTN","RAHLO4",77,0)
 . F II1=1:1:$L(RAHL7SUB,RADEL) D  Q:RAHL7X
"RTN","RAHLO4",78,0)
 .. ; HL7 may have broken the string on data!
"RTN","RAHLO4",79,0)
 .. I II1=1 S RAHL7ARY(RAHL7CNT)=RAHL7LST_$P(RAHL7SUB,RADEL)
"RTN","RAHLO4",80,0)
 .. E  D  ; for the case II1'=1
"RTN","RAHLO4",81,0)
 ... S RAHL7CNT=RAHL7CNT+1
"RTN","RAHLO4",82,0)
 ... S RAHL7ARY(RAHL7CNT)=$P(RAHL7SUB,RADEL,II1)
"RTN","RAHLO4",83,0)
 ... Q
"RTN","RAHLO4",84,0)
 .. I RAHL7CNT=RAPCE,(II1'=$L(RAHL7SUB,RADEL)) S RAHL7X=1,RAHL70=RAHL7ARY(RAHL7CNT)
"RTN","RAHLO4",85,0)
 .. I RAHL7CNT=RAPCE,(II1=$L(RAHL7SUB,RADEL)) D
"RTN","RAHLO4",86,0)
 ... ; grab the 1st piece of the next node (if any)
"RTN","RAHLO4",87,0)
 ... S RAHL7X=1,RAHL70=RAHL7ARY(RAHL7CNT)
"RTN","RAHLO4",88,0)
 ... S N1=+$O(^TMP("RARPT-HL7",$J,RASUB,I)) Q:'N1
"RTN","RAHLO4",89,0)
 ... S RAHL70=RAHL70_$P(^TMP("RARPT-HL7",$J,RASUB,N1),RADEL)
"RTN","RAHLO4",90,0)
 ... Q
"RTN","RAHLO4",91,0)
 .. K:'RAHL7X RAHL7ARY
"RTN","RAHLO4",92,0)
 .. Q
"RTN","RAHLO4",93,0)
 . Q
"RTN","RAHLO4",94,0)
 D KILL
"RTN","RAHLO4",95,0)
 Q RAHL70
"RTN","RAHLO4",96,0)
KILL ; kill the RAHLD* variables
"RTN","RAHLO4",97,0)
 K I,II1,N1,RAHL7ARY,RAHL7CNT,RAHL7LST,RAHL7OFF,RAHL7PRE,RAHL7SUB,RAHL7X
"RTN","RAHLO4",98,0)
 Q
"RTN","RAHLO4",99,0)
LSTPCE(X,DEL) ; given a string and a delimiter, return the last piece
"RTN","RAHLO4",100,0)
 Q $P(X,DEL,$L(X,DEL))
"RTN","RAHLO4",101,0)
CKDUPA ; if duplicate addendum, send msg to members of unverify rpt mailgroup
"RTN","RAHLO4",102,0)
 S RADUPA=0 ; 0 means not a duplicate
"RTN","RAHLO4",103,0)
 N I1,I2,X1,X2,X3,X4,X21,R0,R1,R2,MATCH,XMSUB
"RTN","RAHLO4",104,0)
 S I1="I",I2="RAIMP" I $O(^RARPT(RARPT,I1,0))'="" D ISITDUP ;Q:'RADUPA
"RTN","RAHLO4",105,0)
 ;
"RTN","RAHLO4",106,0)
 I 'RADUPA S I1="R",I2="RATXT" I $O(^RARPT(RARPT,I1,0))'="" D ISITDUP Q:'RADUPA
"RTN","RAHLO4",107,0)
 ;S I1="R",I2="RATXT" I $O(^RARPT(RARPT,I1,0))'="" D ISITDUP Q:'RADUPA
"RTN","RAHLO4",108,0)
 ;
"RTN","RAHLO4",109,0)
 S XMSUB="Duplicate addendum being sent to Vista"
"RTN","RAHLO4",110,0)
 ;
"RTN","RAHLO4",111,0)
 ; check to see if mail message already sent for
"RTN","RAHLO4",112,0)
 ; this case no. TODAY only. if so quit - no need to
"RTN","RAHLO4",113,0)
 ; re-send to save time backwards $ORDER, duplicate
"RTN","RAHLO4",114,0)
 ; most likely to be most recently.
"RTN","RAHLO4",115,0)
 S (XMB,XMATCH)=""
"RTN","RAHLO4",116,0)
 D NOW^%DTC S RATDY=X K X
"RTN","RAHLO4",117,0)
 F  S XMB=$O(^XMB(3.9,"B",$E(XMSUB,1,30),XMB),-1) Q:XMB=""  D  Q:XMATCH'=""
"RTN","RAHLO4",118,0)
 .I $P($$GET1^DIQ(3.9,XMB,1.4,"I"),".")'=RATDY S XMATCH=0 Q  ;(DBIA2860)
"RTN","RAHLO4",119,0)
 .Q:$G(^XMB(3.9,XMB,2,6,0))'[RALONGCN
"RTN","RAHLO4",120,0)
 .S XMATCH=1
"RTN","RAHLO4",121,0)
 K XMB,RATDY
"RTN","RAHLO4",122,0)
 Q:XMATCH=1
"RTN","RAHLO4",123,0)
 ;
"RTN","RAHLO4",124,0)
 ; send mail to members of unverify bulletin  (DBIA2861)
"RTN","RAHLO4",125,0)
 ; find ien of unverify bulletin
"RTN","RAHLO4",126,0)
 D FIND^DIC(3.6,"","","","RAD/NUC MED REPORT UNVERIFIED",1,"","","","R0")
"RTN","RAHLO4",127,0)
 Q:'$D(R0("DILIST",2,1))#2
"RTN","RAHLO4",128,0)
 ; find name of mail group linked to that bulletin
"RTN","RAHLO4",129,0)
 D GETS^DIQ(3.6,R0("DILIST",2,1),"4*","EI","R1")
"RTN","RAHLO4",130,0)
 ; check to see if MailGroup is PUBLIC, otherwise quit
"RTN","RAHLO4",131,0)
 S X=$G(R1(3.62,"1,"_R0("DILIST",2,1)_",",.01,"I")) I X="" K X Q
"RTN","RAHLO4",132,0)
 I $$GET1^DIQ(3.8,X_",",4,"I")'="PU" K X Q
"RTN","RAHLO4",133,0)
 S X=$G(R1(3.62,"1,"_R0("DILIST",2,1)_",",.01,"E")) I X="" K X Q
"RTN","RAHLO4",134,0)
 N XMDUZ,XMTEXT,XMY,MSGTXT,XRAVERF,XRATRANS,XRADFN
"RTN","RAHLO4",135,0)
 S X="G."_X,XMY(X)="" K X ;recipient mail group
"RTN","RAHLO4",136,0)
 ;
"RTN","RAHLO4",137,0)
 S XMDUZ=.5
"RTN","RAHLO4",138,0)
 S MSGTXT(1)=$G(^TMP("RARPT-REC",$J,RASUB,"VENDOR"))_" is sending duplicate addenda to Radiology/Nuclear Medicine."
"RTN","RAHLO4",139,0)
 S MSGTXT(2)=" "
"RTN","RAHLO4",140,0)
 S MSGTXT(3)="The following radiology report was sent with a duplicate addendum:"
"RTN","RAHLO4",141,0)
 S:RADFN'="" XRADFN=$$GET1^DIQ(2,RADFN,.01)
"RTN","RAHLO4",142,0)
 S:$G(XRADFN)="" XRADFN="Unknown"
"RTN","RAHLO4",143,0)
 S MSGTXT(4)="   1) Patient              : "_XRADFN
"RTN","RAHLO4",144,0)
 S MSGTXT(5)="   2) SSN                  : "_$$SSN^RAUTL()
"RTN","RAHLO4",145,0)
 S MSGTXT(6)="   3) Case Number          : "_RALONGCN
"RTN","RAHLO4",146,0)
 S:RAVERF'="" XRAVERF=$$GET1^DIQ(200,RAVERF,.01)
"RTN","RAHLO4",147,0)
 S:$G(XRAVERF)="" XRAVERF="Unknown"
"RTN","RAHLO4",148,0)
 S MSGTXT(7)="   4) Verifier             : "_XRAVERF
"RTN","RAHLO4",149,0)
 S:RATRANSC'="" XRATRANS=$$GET1^DIQ(200,RATRANSC,.01)
"RTN","RAHLO4",150,0)
 S:$G(XRATRANS)="" XRATRANS="Unknown"
"RTN","RAHLO4",151,0)
 S MSGTXT(8)="   5) Transcriptionist     : "_XRATRANS
"RTN","RAHLO4",152,0)
 S MSGTXT(9)=" "
"RTN","RAHLO4",153,0)
 S MSGTXT(10)="Please notify IRM."
"RTN","RAHLO4",154,0)
 S XMTEXT="MSGTXT("
"RTN","RAHLO4",155,0)
 D ^XMD
"RTN","RAHLO4",156,0)
 Q
"RTN","RAHLO4",157,0)
ISITDUP ; X1=last ien ^RARPT, X2=LAST IEN ^TMP, x21=first ien ^TMP
"RTN","RAHLO4",158,0)
 Q:'$O(^TMP("RARPT-REC",$J,RASUB,I2,0))
"RTN","RAHLO4",159,0)
 N X1,X2,X21,X3,X4,XX
"RTN","RAHLO4",160,0)
 S RADUPA=0 ; Reset to zero otherwise Imp Text match will override
"RTN","RAHLO4",161,0)
 S X1=$O(^RARPT(RARPT,I1,""),-1)
"RTN","RAHLO4",162,0)
 S XX=$G(^RARPT(RARPT,I1,X1,0)) S XX=$S(XX=""!(XX=" "):0,1:1)
"RTN","RAHLO4",163,0)
 S X2=$O(^TMP("RARPT-REC",$J,RASUB,I2,""),-1),X21=$O(^(0))
"RTN","RAHLO4",164,0)
 S X3=X1-X2+XX Q:X3<1  ; begin comparison from ^RARPT(RARPT,I1,X3
"RTN","RAHLO4",165,0)
 ; chk 1st line of previous addendum
"RTN","RAHLO4",166,0)
 Q:^RARPT(RARPT,I1,X3,0)'["Addendum: "  S X4=^(0)
"RTN","RAHLO4",167,0)
 S X4=$E(X4,$L("Addendum: ")+1,$L(X4)) ; exclude "Addendum: " from X4
"RTN","RAHLO4",168,0)
 Q:X4'=^TMP("RARPT-REC",$J,RASUB,I2,X21)
"RTN","RAHLO4",169,0)
 ; chk remaining lines
"RTN","RAHLO4",170,0)
 S X21=X21+1 F X1=X21:1:X2 S X3=X3+1 Q:^RARPT(RARPT,I1,X3,0)'=^TMP("RARPT-REC",$J,RASUB,I2,X1)
"RTN","RAHLO4",171,0)
 Q:X1<X2
"RTN","RAHLO4",172,0)
 S RADUPA=1
"RTN","RAHLO4",173,0)
 Q
"RTN","RAHLR")
0^2^B54233244^B48962117
"RTN","RAHLR",1,0)
RAHLR ;HISC/CAH/BNT - Generate Common Order (ORM) Message ;11/10/99  10:42
"RTN","RAHLR",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**2,12,10,25,71,82,75,80,84**;Mar 16, 1998;Build 13
"RTN","RAHLR",3,0)
 ;Generates msg whenever a case is registered or cancelled or examined
"RTN","RAHLR",4,0)
 ;              registered        cancelled        examined
"RTN","RAHLR",5,0)
 ; Order control : NW                CA               XO
"RTN","RAHLR",6,0)
 ; Order status  : IP                CA               CM
"RTN","RAHLR",7,0)
 ;02/14/2006 BAY/KAM RA*5*71 Add ability to update exam data to V/R
"RTN","RAHLR",8,0)
 ;
"RTN","RAHLR",9,0)
 ;Integration Agreements
"RTN","RAHLR",10,0)
 ;----------------------
"RTN","RAHLR",11,0)
 ;NOW^%DTC(10000); ^%ZTLOAD(10063); $$GET1^DIQ(2056); ^DIWP(10011)
"RTN","RAHLR",12,0)
 ;$$HLDATE/$$HLNAME/$$M11^HLFNC(10106); INIT^HLFNC2(2161)
"RTN","RAHLR",13,0)
 ;GENERATE^HLMA(2164); DEM^VADPT(10061); $$EN^VAFHLPID(263)
"RTN","RAHLR",14,0)
 ;$$FMTHL7^XLFDT(10103)
"RTN","RAHLR",15,0)
 ;
"RTN","RAHLR",16,0)
 ;IA: 10039 global read .01 field WARD LOCATION (#42) file ^DIC(42,
"RTN","RAHLR",17,0)
 ;IA: 10040 global read .01 field HOSPITAL LOCATION (#44) file ^SC(
"RTN","RAHLR",18,0)
 ;
"RTN","RAHLR",19,0)
 S:$D(HLNDAP) ZTSAVE("HLNDAP")="" S:$D(HLDAP) ZTSAVE("HLDAP")="" S:$D(RAEXMDUN) ZTSAVE("RAEXMDUN")=""
"RTN","RAHLR",20,0)
 S:$D(RAEXEDT) ZTSAVE("RAEXEDT")=""
"RTN","RAHLR",21,0)
 S ZTSAVE("RADFN")="",ZTSAVE("RADTI")="",ZTSAVE("RACNI")="",ZTIO="",ZTDTH=$H,ZTDESC="Rad/Nuc Med Compiling HL7 Common Order",ZTRTN="EN^RAHLR" D ^%ZTLOAD
"RTN","RAHLR",22,0)
 K ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE Q
"RTN","RAHLR",23,0)
EN ; Called from the RA REG & RA CANCEL & RA EXAMINED protocols
"RTN","RAHLR",24,0)
 ; Input Variables:
"RTN","RAHLR",25,0)
 ;   RADFN=file 2 IEN (DFN)
"RTN","RAHLR",26,0)
 ;   RADTI=file 70 Exam subrec IEN (reverse date/time of exam)
"RTN","RAHLR",27,0)
 ;   RACNI=file 70 Case subrecord IEN
"RTN","RAHLR",28,0)
 ;   RAEID=ien of the event driver protocol (defined in RAHLRPC)
"RTN","RAHLR",29,0)
 ; Output Variables:
"RTN","RAHLR",30,0)
 ;   HLA("HLS") array containing HL7 msg
"RTN","RAHLR",31,0)
 ;
"RTN","RAHLR",32,0)
 N EID,HL,INT,HLQ,HLFS,HLECH,HLA,HLCS,HLSCS,HLREP,HLECH
"RTN","RAHLR",33,0)
 N DFN,DIWF,DIWL,DIWR,GMRAL,PI,RACANC,RACN0,RACPT,RACPTNDE,RADTE,RAI,RAN,RAOBR4,RAPRCNDE,RAPROC,RAPROCIT,RAPRV,RAX0,VA,VADM,VAERR,X,X0,Y,X1,OBR36
"RTN","RAHLR",34,0)
 ;
"RTN","RAHLR",35,0)
 D INIT ; initialize some HL7 variables
"RTN","RAHLR",36,0)
 ;RAEXMDUN passed from EXM^RAHLRPC if conditions are met
"RTN","RAHLR",37,0)
 Q:+$G(HL)=15  ;no known client(item) linked to the event driver protocol
"RTN","RAHLR",38,0)
 Q:$O(HL(""))=""  ;disabled server appl, or no server appl 
"RTN","RAHLR",39,0)
 ;** branch to new HL7 logic when the HL7 version surpasses 2.3 **
"RTN","RAHLR",40,0)
 I HL("VER")>2.3,($T(^RAHLR1))'="" D EN^RAHLR1(RADFN,RADTI,RACNI,RAEID) Q
"RTN","RAHLR",41,0)
 ;** branch to new HL7 logic when the HL7 version surpasses 2.3 **
"RTN","RAHLR",42,0)
 S RACN0=$S($D(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)):^(0),1:"") Q:RACN0']""
"RTN","RAHLR",43,0)
 ;Generate Message Text
"RTN","RAHLR",44,0)
 S RAPROC=+$P(RACN0,U,2) I 'RAPROC Q  ;If case entered via 'Enter Last Past Visit before DHCP option, and procedure 'OTHER' is inactive, RAPROC will be null and will cause bomb-out unless we quit here
"RTN","RAHLR",45,0)
 S RAPROCIT=+$P($G(^RAMIS(71,RAPROC,0)),U,12),RAPROCIT=$P(^RA(79.2,RAPROCIT,0),U,1)
"RTN","RAHLR",46,0)
 S (RADTE,OBR36)=9999999.9999-RADTI,RADTE=$E(RADTE,4,7)_$E(RADTE,2,3)_"-"_+RACN0,RACANC=$S($D(^RA(72,"AA",RAPROCIT,0,+$P(RACN0,"^",3))):1,1:0)
"RTN","RAHLR",47,0)
 S RAPRCNDE=$G(^RAMIS(71,+RAPROC,0)),RACPT=+$P(RAPRCNDE,U,9),RACPTNDE=$$NAMCODE^RACPTMSC(RACPT,DT)
"RTN","RAHLR",48,0)
 ;RA*5*82 RAEXEDT= Override the EXM conditions if Case edited
"RTN","RAHLR",49,0)
 ;I $G(RAEXMDUN)=1,'$G(RAEXEDT),$P(RACN0,U,30)'="",'$G(RATELE) Q  ;last chance to stop exm'd msg if it's already been sent RA*5*84 Is TELERAD ?? 
"RTN","RAHLR",50,0)
 ;Compile 'PID' Segment
"RTN","RAHLR",51,0)
 K VA,VADM,VAERR,RAVADM S DFN=RADFN D DEM^VADPT I VADM(1)']"" S HLP("ERRTEXT")="Invalid Patient Identifier" G EXIT
"RTN","RAHLR",52,0)
 S RAVADM(3)=$S($E(+VADM(3),6,7)="00":"",1:+VADM(3)) ; NOTE: Check
"RTN","RAHLR",53,0)
 ; for an inexact date of birth.  If inexact, pass null for DOB in
"RTN","RAHLR",54,0)
 ; the 'PID' segment.  Some COTS systems can't handle inexact DOB's.
"RTN","RAHLR",55,0)
 I HL("VER")']"2.2" D
"RTN","RAHLR",56,0)
 .S HLA("HLS",1)="PID"_HLFS_HLFS_$G(VA("PID"))_HLFS_$$M11^HLFNC(RADFN)_HLFS_HLFS_$$HLNAME^HLFNC(VADM(1))_HLFS_HLFS_$$HLDATE^HLFNC(RAVADM(3))_HLFS_$S(VADM(5)]"":$S("MF"[$P(VADM(5),"^"):$P(VADM(5),"^"),1:"O"),1:"U")
"RTN","RAHLR",57,0)
 .S:$P(VADM(2),"^")]"" $P(HLA("HLS",1),HLFS,20)=$P(VADM(2),"^")
"RTN","RAHLR",58,0)
 I HL("VER")]"2.2" S HLA("HLS",1)=$$EN^VAFHLPID(DFN,"2,3,5,7,8,19,20")
"RTN","RAHLR",59,0)
 K RAVADM
"RTN","RAHLR",60,0)
 ;Compile 'ORC' Segment
"RTN","RAHLR",61,0)
 S X0="" ;if exam-set or print-set, store parent name if order exists
"RTN","RAHLR",62,0)
 I $P(RACN0,U,25) S X0=$P(RACN0,U,11),X0=$P($G(^RAO(75.1,+X0,0)),U,2),X0=$P($G(^RAMIS(71,+X0,0)),U),X0=$S(X0="":"ORIGINAL ORDER PURGED",1:X0),X0=$S($P(RACN0,U,25)=1:"EXAM",1:"PRINT")_"SET: "_X0
"RTN","RAHLR",63,0)
 ; BNT - Added ORC4 Placer Group Number for Printset identification.
"RTN","RAHLR",64,0)
 ; ORC4 is a combination of SSN with the order inverted date/time.
"RTN","RAHLR",65,0)
 S RAORC4="" I $P($G(RACN0),U,25)=2 D
"RTN","RAHLR",66,0)
 . S:$P(VADM(2),"^")]"" RAORC4=$P(VADM(2),"^")
"RTN","RAHLR",67,0)
 . S RAORC4=$G(RAORC4)_RADTI
"RTN","RAHLR",68,0)
 S HLA("HLS",2)="ORC"_HLFS_$S(RACANC:"CA",$G(RAEXMDUN)=1:"XO",1:"NW")_HLFS_HLFS_HLFS_RAORC4_HLFS_$S(RACANC:"CA",$G(RAEXMDUN)=1:"CM",1:"IP")_HLFS_HLFS_HLFS_X0_HLFS_HLDT1
"RTN","RAHLR",69,0)
 K RAORC4
"RTN","RAHLR",70,0)
 ;Compile 'OBR' Segment
"RTN","RAHLR",71,0)
 S RAOBR4=$P(RACPTNDE,U)_$E(HLECH)_$P(RACPTNDE,U,2)_$E(HLECH)_"C4"_$E(HLECH)_+RAPROC_$E(HLECH)_$P(RAPRCNDE,U)_$E(HLECH)_"99RAP"
"RTN","RAHLR",72,0)
 ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLR",73,0)
 ; S RAOBR4=$P(RACPTNDE,U)_$E(HLECH)_$$ESCAPE^RAHLRU($P(RACPTNDE,U,2))_$E(HLECH)_"C4"_$E(HLECH)_+RAPROC_$E(HLECH)_$$ESCAPE^RAHLRU($P(RAPRCNDE,U))_$E(HLECH)_"99RAP"
"RTN","RAHLR",74,0)
 I $P(RACPTNDE,U)']"" S $P(RAOBR4,$E(HLECH),1,3)=$P(RAOBR4,$E(HLECH),4,5)_$E(HLECH)_"LOCAL"
"RTN","RAHLR",75,0)
 ;OBR-7 change: from HLDT1 to $$HLDATE^HLFNC(9999999.9999-RADTI) d/t of registration
"RTN","RAHLR",76,0)
 ;Driver of change: CareStream Health PACS. Agfa requires a timestamp down to the second
"RTN","RAHLR",77,0)
 ;POC @ Boston is Maureen Sullivan
"RTN","RAHLR",78,0)
 S HLA("HLS",3)="OBR"_HLFS_HLFS_RADTE_HLFS_RADTI_"-"_RACNI_$E(HLECH)_RADTE_$E(HLECH)_"L"_HLFS_RAOBR4_HLFS_HLFS_HLFS_$$HLDATE^HLFNC(9999999.9999-RADTI)
"RTN","RAHLR",79,0)
 S HLA("HLS",3)=HLA("HLS",3)_HLFS_HLQ_HLFS_HLQ_HLFS_HLFS_HLFS_HLFS_HLFS_HLQ_HLFS_HLFS
"RTN","RAHLR",80,0)
 S RAPRV=$$GET1^DIQ(200,+$P(RACN0,"^",14),.01)
"RTN","RAHLR",81,0)
 S HLA("HLS",3)=HLA("HLS",3)_$S(RAPRV]"":+$P(RACN0,"^",14)_$E(HLECH)_$$HLNAME^HLFNC(RAPRV),1:"")
"RTN","RAHLR",82,0)
 ;
"RTN","RAHLR",83,0)
 N RACN00,RA20 S RACN00=$G(^RADPT(RADFN,"DT",RADTI,0))
"RTN","RAHLR",84,0)
 ;Seg's fld 20 = pce 21 --> ien file #79.1~name of img loc~stn #~stn name
"RTN","RAHLR",85,0)
 S RA20=+$G(^RA(79.1,+$P(RACN00,U,4),0))
"RTN","RAHLR",86,0)
 S $P(HLA("HLS",3),HLFS,21)=$P(RACN00,U,4)_$E(HLECH)_$P($G(^SC(RA20,0)),U)_$E(HLECH)_$P(RACN00,U,3)_$E(HLECH)_$P($G(^DIC(4,+$P(RACN00,U,3),0)),U)
"RTN","RAHLR",87,0)
 S $P(HLA("HLS",3),HLFS,21)=$P(HLA("HLS",3),HLFS,21)
"RTN","RAHLR",88,0)
 ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLR",89,0)
 ; S $P(HLA("HLS",3),HLFS,21)=$$ESCAPE^RAHLRU($P(HLA("HLS",3),HLFS,21))
"RTN","RAHLR",90,0)
 ;Seg's fld 21 = pce 22 --> abbrv I-type~Img type name
"RTN","RAHLR",91,0)
 S RA20=$G(^RA(79.2,+$P(RACN00,U,2),0))
"RTN","RAHLR",92,0)
 S $P(HLA("HLS",3),HLFS,22)=$P(RA20,U,3)_$E(HLECH)_$P(RA20,U)
"RTN","RAHLR",93,0)
 S $P(HLA("HLS",3),HLFS,22)=$P(HLA("HLS",3),HLFS,22)
"RTN","RAHLR",94,0)
 ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLR",95,0)
 ; S $P(HLA("HLS",3),HLFS,22)=$$ESCAPE^RAHLRU($P(HLA("HLS",3),HLFS,22))
"RTN","RAHLR",96,0)
 ;
"RTN","RAHLR",97,0)
 S $P(HLA("HLS",3),HLFS,23)=HLDT1,$P(HLA("HLS",3),HLFS,19)=$S($D(^DIC(42,+$P(RACN0,"^",6),0)):$P(^(0),"^"),$D(^SC(+$P(RACN0,"^",8),0)):$P(^(0),"^"),1:"Unknown")
"RTN","RAHLR",98,0)
 ;
"RTN","RAHLR",99,0)
 ; OBR-31.2 = Reason for Study P75
"RTN","RAHLR",100,0)
 S $P(HLA("HLS",3),HLFS,32)=$E(HLECH)_$$ESCAPE^RAHLRU($P($G(^RAO(75.1,+$P(RACN0,"^",11),.1)),U))
"RTN","RAHLR",101,0)
 ;
"RTN","RAHLR",102,0)
 ; OBR-36 = Exam Date/Time
"RTN","RAHLR",103,0)
 S $P(HLA("HLS",3),HLFS,37)=$$FMTHL7^XLFDT(OBR36)
"RTN","RAHLR",104,0)
 ;
"RTN","RAHLR",105,0)
 I 'RACANC S X=$P($G(^RAO(75.1,+$P(RACN0,"^",11),0)),"^",6),$P(HLA("HLS",3),HLFS,28)=$E(HLECH)_$E(HLECH)_$E(HLECH)_$E(HLECH)_$E(HLECH)_$TR(X,"129","SAR")
"RTN","RAHLR",106,0)
 ; if long str, break so 2nd str begins with separator to avoid abend
"RTN","RAHLR",107,0)
 I $L(HLA("HLS",3))>245 N RAPART,RA1 S RA1=HLA("HLS",3) F RAPART=5:1:15 S RAPART(1)=$P(RA1,HLFS,1,RAPART),RAPART(2)=$P(RA1,HLFS,RAPART+1,99) Q:$L(RAPART(1))<245&($L(RAPART(2))<245)&($P(RAPART(2),HLFS)="")
"RTN","RAHLR",108,0)
 I $D(RAPART) K:RAPART=15 RAPART ;if RAPART reaches 15, then something's wrong so kill RAPART to allow abend due "string too long"
"RTN","RAHLR",109,0)
 I $D(RAPART) S HLA("HLS",3)=$P(RAPART(1),HLFS)_HLFS,HLA("HLS",3,1)=$P(RAPART(1),HLFS,2,99)_HLFS,HLA("HLS",3,2)=RAPART(2) K RAPART,RA1
"RTN","RAHLR",110,0)
OBXPRC ;Compile 'OBX' Segment for Procedure
"RTN","RAHLR",111,0)
 S RAN=4 D OBXPRC^RAHLRU
"RTN","RAHLR",112,0)
OBXMOD ;Compile 'OBX' Segment for two types of Modifiers
"RTN","RAHLR",113,0)
 S RAN=5 D OBXMOD^RAHLRU
"RTN","RAHLR",114,0)
OBXHIST ;Compile 'OBX' Segment for Clinical History
"RTN","RAHLR",115,0)
 I '$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"H",0)) S RAN=RAN+1,HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"H"_$E(HLECH)_"HISTORY"_$E(HLECH)_"L"_HLFS_HLFS_"None Entered" D OBX11^RAHLRU G ALLER
"RTN","RAHLR",116,0)
 K ^UTILITY($J,"W") S DIWF="",DIWR=80,DIWL=1 F RAI=0:0 S RAI=$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"H",RAI)) Q:'RAI  I $D(^(RAI,0)) S X=^(0) D ^DIWP
"RTN","RAHLR",117,0)
 F RAI=0:0 S RAI=$O(^UTILITY($J,"W",DIWL,RAI)) Q:'RAI  I $D(^(RAI,0)) S RAN=RAN+1,HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"H"_$E(HLECH)_"HISTORY"_$E(HLECH)_"L"_HLFS_HLFS_^(0) D OBX11^RAHLRU
"RTN","RAHLR",118,0)
ALLER ;Compile 'OBX' Segment for Allergies
"RTN","RAHLR",119,0)
 S DFN=RADFN D ALLERGY^RADEM S X="" I $D(GMRAL) S RAI=0 F  S RAI=$O(PI(RAI)) Q:RAI'>0  S X0=PI(RAI) I X0]"" Q:($L(X)+$L(X0))>200  S X=X_X0_", "
"RTN","RAHLR",120,0)
 I $L(X) S RAN=RAN+1,HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"A"_$E(HLECH)_"ALLERGIES"_$E(HLECH)_"L"_HLFS_HLFS_X D OBX11^RAHLRU
"RTN","RAHLR",121,0)
OBXTCM ;Compile 'OBX' Segment for Tech Comment
"RTN","RAHLR",122,0)
 D OBXTCM^RAHLRU
"RTN","RAHLR",123,0)
EXIT ; set HL7 message type & return to protocol
"RTN","RAHLR",124,0)
 K ^UTILITY($J,"W")
"RTN","RAHLR",125,0)
 S HL("MTN")="ORM"
"RTN","RAHLR",126,0)
 N HLEID,HLARYTYP,HLFORMAT,HLMTIEN,HLP
"RTN","RAHLR",127,0)
 S HLEID=EID,HLARYTYP="LM",HLFORMAT=1,HLMTIEN="",HLP("PRIORITY")="I"
"RTN","RAHLR",128,0)
 D:$D(RASSSX(HLEID)) GETHLP^RAHLRS1(HLEID,.HLP,"RASSSX")
"RTN","RAHLR",129,0)
 D:$D(RASSSX1(HLEID)) GETHLP^RAHLRS1(HLEID,.HLP,"RASSSX1")
"RTN","RAHLR",130,0)
 D GENERATE^HLMA(HLEID,HLARYTYP,HLFORMAT,.HLRESLT,HLMTIEN,.HLP)
"RTN","RAHLR",131,0)
 Q
"RTN","RAHLR",132,0)
Q ;Entry Point to Process an ORR Message (Just a Quit Since No Processing is Required)
"RTN","RAHLR",133,0)
 Q
"RTN","RAHLR",134,0)
INIT ; initialize HL7 variables
"RTN","RAHLR",135,0)
 D NOW^%DTC S HLDT=%,HLDT1=$$HLDATE^HLFNC(%)
"RTN","RAHLR",136,0)
 ;Note: HLDT1 is used for HL7 fields: ORC-9 & OBR-22
"RTN","RAHLR",137,0)
 Q:'$G(RAEID)  S EID=RAEID
"RTN","RAHLR",138,0)
 S HL="HLS(""HLS"")",INT=1
"RTN","RAHLR",139,0)
 D INIT^HLFNC2(EID,.HL,INT)
"RTN","RAHLR",140,0)
 Q:'$D(HL("Q"))  ;no server application defined
"RTN","RAHLR",141,0)
 S HLQ=HL("Q")
"RTN","RAHLR",142,0)
 S HLECH=HL("ECH")
"RTN","RAHLR",143,0)
 S HLFS=HL("FS")
"RTN","RAHLR",144,0)
 S HLCS=$E(HL("ECH"))
"RTN","RAHLR",145,0)
 S HLSCS=$E(HL("ECH"),4)
"RTN","RAHLR",146,0)
 S HLREP=$E(HL("ECH"),2)
"RTN","RAHLR",147,0)
 Q
"RTN","RAHLRPC")
0^6^B16908988^B13841696
"RTN","RAHLRPC",1,0)
RAHLRPC ;HIRMFO/BNT-Rad/NM HL7 Protocol calls ;05/21/99   14:50
"RTN","RAHLRPC",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**12,25,54,71,82,81,84**;Mar 16, 1998;Build 13
"RTN","RAHLRPC",3,0)
 ; 03/16/2006 *71 Rem Call 124379 allow exam updates to create HL7 msg
"RTN","RAHLRPC",4,0)
 ;
"RTN","RAHLRPC",5,0)
 ;Integration Agreements
"RTN","RAHLRPC",6,0)
 ;----------------------
"RTN","RAHLRPC",7,0)
 ;$$FIND1^DIC(2051); GETS^DIQ(2056)
"RTN","RAHLRPC",8,0)
 ;all access to ^ORD(101 to maintain application specific protocols(872)
"RTN","RAHLRPC",9,0)
 ;read w/FileMan HL7 APPLICATION PARAMETER(10136)
"RTN","RAHLRPC",10,0)
 ; 
"RTN","RAHLRPC",11,0)
REG ; register exam
"RTN","RAHLRPC",12,0)
 N X,RA101Z,RAEID
"RTN","RAHLRPC",13,0)
 S RA101Z="RA REF" ; get all protocols beginning RA REG
"RTN","RAHLRPC",14,0)
 F  S RA101Z=$O(^ORD(101,"B",RA101Z)) Q:RA101Z'["RA REG"  D
"RTN","RAHLRPC",15,0)
 .S RAEID=$O(^ORD(101,"B",RA101Z,0))
"RTN","RAHLRPC",16,0)
 .I RAEID,'$L($P(^ORD(101,RAEID,0),"^",3)) D EN^RAHLR
"RTN","RAHLRPC",17,0)
 Q
"RTN","RAHLRPC",18,0)
CANCEL ; cancel exam
"RTN","RAHLRPC",19,0)
 N X,RA101Z,RAEID
"RTN","RAHLRPC",20,0)
 S RA101Z="RA CANCEK" ; get all protocols beginning RA CANCEL
"RTN","RAHLRPC",21,0)
 F  S RA101Z=$O(^ORD(101,"B",RA101Z)) Q:RA101Z'["RA CANCEL"  D
"RTN","RAHLRPC",22,0)
 .S RAEID=$O(^ORD(101,"B",RA101Z,0))
"RTN","RAHLRPC",23,0)
 .I RAEID,'$L($P(^ORD(101,RAEID,0),"^",3)) D EN^RAHLR
"RTN","RAHLRPC",24,0)
 Q
"RTN","RAHLRPC",25,0)
 ;
"RTN","RAHLRPC",26,0)
RPT ; report verified or released/not verified
"RTN","RAHLRPC",27,0)
 N X,RA101Z,RAEID,RASSS ; RASSS subcriber array to be passed to HLL for GENERATE^HLMA
"RTN","RAHLRPC",28,0)
 ;S X="^%ET",@^%ZOSF("TRAP")
"RTN","RAHLRPC",29,0)
 S RA101Z="RA RPS" ; get all protocols beginning RA RPT
"RTN","RAHLRPC",30,0)
 F  S RA101Z=$O(^ORD(101,"B",RA101Z)) Q:RA101Z'["RA RPT"  D
"RTN","RAHLRPC",31,0)
 .S RAEID=$O(^ORD(101,"B",RA101Z,0)) K RASSS  ; RA*5*81
"RTN","RAHLRPC",32,0)
 .S:$L($G(RANOSEND)) RAEID=$$GETEID(RAEID,RANOSEND,.RASSS) ;RA*5*81
"RTN","RAHLRPC",33,0)
 .I RAEID,'$L($P(^ORD(101,RAEID,0),"^",3)) D EN^RAHLRPT
"RTN","RAHLRPC",34,0)
 K RANOSEND
"RTN","RAHLRPC",35,0)
 Q
"RTN","RAHLRPC",36,0)
 ;
"RTN","RAHLRPC",37,0)
EXM ;Examined case; called from RAUTL1 and RASTED after a case has been edited.
"RTN","RAHLRPC",38,0)
 ;
"RTN","RAHLRPC",39,0)
 ;Called from RAUTL1 and RASTED after a case's status is upgraded
"RTN","RAHLRPC",40,0)
 ; and case's 30th piece is null
"RTN","RAHLRPC",41,0)
 ;
"RTN","RAHLRPC",42,0)
 ;If this new status is :
"RTN","RAHLRPC",43,0)
 ; at a status (or higher than a status) where
"RTN","RAHLRPC",44,0)
 ; GENERATE EXAMINED HL7 MSG = Y,
"RTN","RAHLRPC",45,0)
 ; then :
"RTN","RAHLRPC",46,0)
 ; 1. send an HL7 msg re this case having reached EXAMINED status
"RTN","RAHLRPC",47,0)
 ; 2. set subfile 70.03's HL7 EXAMINED MSG SENT  to  Y
"RTN","RAHLRPC",48,0)
 ;
"RTN","RAHLRPC",49,0)
 ; RALOWER = next lower status
"RTN","RAHLRPC",50,0)
 ; RANEWST = new status ien
"RTN","RAHLRPC",51,0)
 ; RAEXEDT = Indication of editing of: proc, proc mod, req phys, CPT mod, Tech comm...
"RTN","RAHLRPC",52,0)
 ; RAGENHL7 = Indication that sending ORU is due...
"RTN","RAHLRPC",53,0)
 ; RASSSX1(IENs) = Array of subscribers from 771, the message will be sent (SCIMGE)
"RTN","RAHLRPC",54,0)
 ; 
"RTN","RAHLRPC",55,0)
 N RAIMGTYI,RAIMGTYJ,RALOWER,RANEWST,RAEXMDUN,RAGENHL7,RASSSX1
"RTN","RAHLRPC",56,0)
 S RAIMGTYI=$P($G(^RADPT(RADFN,"DT",RADTI,0)),U,2),RAIMGTYJ=$P(^RA(79.2,RAIMGTYI,0),U),RANEWST=$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),U,3)
"RTN","RAHLRPC",57,0)
 S:$P(^RA(72,RANEWST,0),U,8)="Y" RAGENHL7=1 ;this status has GEN HL7 marked Y
"RTN","RAHLRPC",58,0)
 ; look thru lower statuses for GEN HL7 marked Y
"RTN","RAHLRPC",59,0)
DOWN S RALOWER=$P($G(^RA(72,+RANEWST,0)),U,3)
"RTN","RAHLRPC",60,0)
 I '$G(RAGENHL7) F  S RALOWER=$O(^RA(72,"AA",RAIMGTYJ,RALOWER),-1) Q:RALOWER<1  S:$P(^RA(72,+$O(^RA(72,"AA",RAIMGTYJ,RALOWER,0)),0),U,8)="Y" RAGENHL7=1
"RTN","RAHLRPC",61,0)
 ;?? none of the lower status levels have GEN HL7 marked Y
"RTN","RAHLRPC",62,0)
 K:$P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),U,30)="Y" RAGENHL7 ;already sent
"RTN","RAHLRPC",63,0)
 ;Q:'$G(RAEXEDT)&'$G(RAGENHL7)
"RTN","RAHLRPC",64,0)
 ; Business Rule: RA*5*84 sends an examined message to ScImage unconditionally
"RTN","RAHLRPC",65,0)
 I '$G(RAEXEDT),'$G(RAGENHL7) Q:'$O(^RA(79.7,0))  D  Q:'$O(RASSSX1(0))
"RTN","RAHLRPC",66,0)
 .N X,RASSS,RASSSL S X=0 F  S X=$O(^RA(79.7,X)) Q:'X  S:$P(^(X,0),U,2) RASSS(X)=""
"RTN","RAHLRPC",67,0)
 .D:$D(RASSS) GETSUB^RAHLRS1(.RASSS,.RASSSX1,.RASSSL)
"RTN","RAHLRPC",68,0)
1 N RAEXMDUN
"RTN","RAHLRPC",69,0)
 S RAEXMDUN=1
"RTN","RAHLRPC",70,0)
A1 N X,RA101Z,RAEID
"RTN","RAHLRPC",71,0)
 S RA101Z="RA EXAMINEC" ; get all protocols beginning RA EXAMINED
"RTN","RAHLRPC",72,0)
 F  S RA101Z=$O(^ORD(101,"B",RA101Z)) Q:RA101Z'["RA EXAMINED"  D
"RTN","RAHLRPC",73,0)
 .N RAGENHL7 S RAEID=$O(^ORD(101,"B",RA101Z,0))
"RTN","RAHLRPC",74,0)
 .I RAEID,'$L($P(^ORD(101,RAEID,0),"^",3)) D EN^RAHLR
"RTN","RAHLRPC",75,0)
 S:$G(RAGENHL7) $P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),U,30)="Y"
"RTN","RAHLRPC",76,0)
 Q
"RTN","RAHLRPC",77,0)
 ;
"RTN","RAHLRPC",78,0)
GETEID(RAEID,RANOSEND,RASSS) ; RA*5*81   Return RAEID or 0 (zero)  = for future use.
"RTN","RAHLRPC",79,0)
 ; RAEID = IEN of regular Event driver
"RTN","RAHLRPC",80,0)
 ; RANOSEND Application name or IEN from 771 file..  don't send message to Subcr. with this application.
"RTN","RAHLRPC",81,0)
 ; RASSS Array of subcribers (IENs) associated with RANOSEND application
"RTN","RAHLRPC",82,0)
 ; 0 (zero) returned if No subscriber exist or all subscribers associated with RANOSEND application.
"RTN","RAHLRPC",83,0)
 S RAEID=$G(RAEID) Q:'RAEID!'$L($G(RANOSEND))!'$D(^ORD(101,+RAEID,0)) RAEID
"RTN","RAHLRPC",84,0)
 N RAXX,ERR,X1,Y1,YY,RAPL,RANEW,RAPIDS,RAIEDS,DIERR,RAERR
"RTN","RAHLRPC",85,0)
 S RAPL=$S(+RANOSEND:+RANOSEND,1:$$FIND1^DIC(771,"","X",RANOSEND,"","","RAERR"))
"RTN","RAHLRPC",86,0)
 Q:'RAPL!($D(RAERR)#2) RAEID
"RTN","RAHLRPC",87,0)
 D GETS^DIQ(101,RAEID_",","**","I","RAXX","ERR")
"RTN","RAHLRPC",88,0)
 Q:$D(ERR) RAEID ; Was not able get Event driver info... so just pass event driver...
"RTN","RAHLRPC",89,0)
 Q:'$D(RAXX(101.0775)) 0  ;No subcribers exist for Event driver
"RTN","RAHLRPC",90,0)
 S X1="",RANEW=0,Y1=0 F  S X1=$O(RAXX(101.0775,X1)) Q:'$L(X1)  D
"RTN","RAHLRPC",91,0)
 .S YY=$G(RAXX(101.0775,X1,.01,"I"))
"RTN","RAHLRPC",92,0)
 .I $P($G(^ORD(101,+YY,770)),U,2)=RAPL D  Q
"RTN","RAHLRPC",93,0)
 ..S Y1=Y1+1,RASSS("EXCLUDE SUBSCRIBER",Y1)=YY ;Y1= 1,2,3...
"RTN","RAHLRPC",94,0)
 .S RANEW=1
"RTN","RAHLRPC",95,0)
 Q:'RANEW 0  ;All subscribers are associated with application RANOSEND..  Don't send the message.
"RTN","RAHLRPC",96,0)
 Q RAEID
"RTN","RAHLRPT")
0^12^B65194652^B70244672
"RTN","RAHLRPT",1,0)
RAHLRPT ;HISC/CAH AISC/SAW-Compiles HL7 'ORU' Message Type ; 4/26/01 10:40am
"RTN","RAHLRPT",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**2,12,10,25,81,80,84**;Mar 16, 1998;Build 13
"RTN","RAHLRPT",3,0)
EN ; Called from RA RPT and RA RPT 2.3 protocol entry action
"RTN","RAHLRPT",4,0)
 ; Input variables:
"RTN","RAHLRPT",5,0)
 ;   RADFN=file 2 IEN (DFN)
"RTN","RAHLRPT",6,0)
 ;   RADTI=file 70 Exam subrecord IEN (reverse date/time)
"RTN","RAHLRPT",7,0)
 ;   RACNI=file 70 Case subrecord IEN
"RTN","RAHLRPT",8,0)
 ;   RARPT=file 74 Report IEN
"RTN","RAHLRPT",9,0)
 ;   RASSS=List of Subscribers passed into GENERATE^HLMA  will be set into HLP array.
"RTN","RAHLRPT",10,0)
 ; Output variables:
"RTN","RAHLRPT",11,0)
 ;   HLA("HLS", array containing HL7 msg
"RTN","RAHLRPT",12,0)
 ;   RATELREL = 1  Indicates that the text: 'Released for local dictation by National Teleradiology'
"RTN","RAHLRPT",13,0)
 ;              has been included in Impression or Report section
"RTN","RAHLRPT",14,0)
 ;   RATELX =   Text used as indication of Release for local dictation... if not set use defauld above...
"RTN","RAHLRPT",15,0)
 ;   RATELE =   1 If RANOSEND is Teleradiology type vendor
"RTN","RAHLRPT",16,0)
 ;
"RTN","RAHLRPT",17,0)
 ;Integration Agreements
"RTN","RAHLRPT",18,0)
 ;----------------------
"RTN","RAHLRPT",19,0)
 ;$$GET1^DIQ(2056); ^DIWP(10011); $$HLDATE/$$HLNAME^HLFNC(10106)
"RTN","RAHLRPT",20,0)
 ;GENERATE^HLMA(2164); DEM^VADPT(10061); $$FMTHL7^XLFDT(10103)
"RTN","RAHLRPT",21,0)
 ;$$PATCH^XPDUTL(10141); $$VERSION^XPDUTL(10141)
"RTN","RAHLRPT",22,0)
 ;
"RTN","RAHLRPT",23,0)
 N RASET,RACN0,RATELE,RATELREL,RATELX
"RTN","RAHLRPT",24,0)
 D INIT^RAHLRPTT ;Patch 84
"RTN","RAHLRPT",25,0)
 I +$P(RACN0,U,25)=2 D  Q  ; printset
"RTN","RAHLRPT",26,0)
 .; loop through all cases in set and create message
"RTN","RAHLRPT",27,0)
 .S RASET=1
"RTN","RAHLRPT",28,0)
 .N RACNI,RAII S RAII=0
"RTN","RAHLRPT",29,0)
 .F  S RAII=$O(^RADPT(RADFN,"DT",RADTI,"P",RAII)) Q:RAII'>0  D
"RTN","RAHLRPT",30,0)
 .. Q:$P(^RADPT(RADFN,"DT",RADTI,"P",RAII,0),U,25)'=2
"RTN","RAHLRPT",31,0)
 .. S RACNI=RAII
"RTN","RAHLRPT",32,0)
 .. D NEW
"RTN","RAHLRPT",33,0)
NEW ; new variables
"RTN","RAHLRPT",34,0)
 S:$D(ZTQUEUED) ZTREQ="@" ; delete task from task global
"RTN","RAHLRPT",35,0)
 N DFN,DIWF,DIWL,DIWR,RACPT,RACPTNDE,RADTECN,RADTE0,RADTV,RAI,RAN,RAOBR4,RAPRCNDE,RAPROC,RAPROCIT,RAPRV,RARPT0
"RTN","RAHLRPT",36,0)
 N VADM,VAERR,X,X1,X2,XX2,Y,X0,OBR36,EID,HL,INT,HLQ,HLFS,HLECH,HLA,RAN K RAVADM
"RTN","RAHLRPT",37,0)
 D INIT^RAHLRU ;initialize HL7 variables
"RTN","RAHLRPT",38,0)
 Q:+$G(HL)=15  ;no known client(item) linked to the event driver protocol
"RTN","RAHLRPT",39,0)
 Q:$O(HL(""))=""  ;failed return from INIT^HLFNC2 (called by INIT^RAHLRU)
"RTN","RAHLRPT",40,0)
 ;
"RTN","RAHLRPT",41,0)
 ;** branch to new HL7 logic when the HL7 version surpasses 2.3 **
"RTN","RAHLRPT",42,0)
 I HL("VER")>2.3,($T(^RAHLRPT1))'="" D EN^RAHLRPT1(RADFN,RADTI,RACNI,RAEID),EXIT Q
"RTN","RAHLRPT",43,0)
 ;** branch to new HL7 logic when the HL7 version surpasses 2.3 **
"RTN","RAHLRPT",44,0)
 ;
"RTN","RAHLRPT",45,0)
 S DFN=RADFN D DEM^VADPT
"RTN","RAHLRPT",46,0)
 I VADM(1)']"" S HLP("ERRTEXT")="Invalid Patient Identifier" G EXIT
"RTN","RAHLRPT",47,0)
 S RAN=0
"RTN","RAHLRPT",48,0)
 S RAVADM(3)=$S($E(+VADM(3),6,7)="00":"",1:+VADM(3)) ; NOTE: Check
"RTN","RAHLRPT",49,0)
 ; for an inexact date of birth.  If inexact, pass null for DOB in
"RTN","RAHLRPT",50,0)
 ; the 'PID' segment.  Some COTS systems can't handle inexact DOB's.
"RTN","RAHLRPT",51,0)
 D SETUP^RAHLRPTT,PID^RAHLRPTT,OBR,OBXPRC,OBXIMP,OBXDIA,OBXRPT,OBXMOD,OBXTCM
"RTN","RAHLRPT",52,0)
EXIT ; set HL7 message type & return to RA RPT protocol
"RTN","RAHLRPT",53,0)
 ;For P84 see if this is a >>Released for local reading<< type report and if yes resend the ORM (^RAHLRS1)...
"RTN","RAHLRPT",54,0)
 I $G(RATELREL) D RESEND^RAHLRPTT(RADFN,RADTI,RACNI) Q  ;P84 resend in the case that report released from Telerad
"RTN","RAHLRPT",55,0)
 S HL("MTN")="ORU"
"RTN","RAHLRPT",56,0)
 N HLEID,HLARYTYP,HLFORMAT,HLMTIEN,HLP
"RTN","RAHLRPT",57,0)
 S HLEID=RAEID,HLARYTYP="LM",HLFORMAT=1,HLMTIEN="",HLP("PRIORITY")="I"
"RTN","RAHLRPT",58,0)
 M:$D(RASSS) HLP=RASSS
"RTN","RAHLRPT",59,0)
 D:$D(RASSSX(HLEID)) GETHLP^RAHLRS1(HLEID,.HLP,"RASSSX")
"RTN","RAHLRPT",60,0)
 D GENERATE^HLMA(HLEID,HLARYTYP,HLFORMAT,.HLRESLT,HLMTIEN,.HLP)
"RTN","RAHLRPT",61,0)
 K RAVADM
"RTN","RAHLRPT",62,0)
 Q
"RTN","RAHLRPT",63,0)
 ;
"RTN","RAHLRPT",64,0)
OBR ;Compile 'OBR' Segment
"RTN","RAHLRPT",65,0)
 S RAOBR4=$P(RACPTNDE,U)_$E(HLECH)_$P(RACPTNDE,U,2)_$E(HLECH)_"C4"_$E(HLECH)_+RAPROC_$E(HLECH)_$P(RAPRCNDE,U)_$E(HLECH)_"99RAP"
"RTN","RAHLRPT",66,0)
 ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLRPT",67,0)
 ; S RAOBR4=$P(RACPTNDE,U)_$E(HLECH)_$$ESCAPE^RAHLRU($P(RACPTNDE,U,2))_$E(HLECH)_"C4"_$E(HLECH)_+RAPROC_$E(HLECH)_$$ESCAPE^RAHLRU($P(RAPRCNDE,U))_$E(HLECH)_"99RAP"
"RTN","RAHLRPT",68,0)
 ; Have to use LOCAL code if Broad Procedure - no CPT code
"RTN","RAHLRPT",69,0)
 I $P(RAOBR4,$E(HLECH))=""!($P(RAOBR4,$E(HLECH),2)="") S $P(RAOBR4,$E(HLECH),1,3)=$P(RAOBR4,$E(HLECH),4,5)_$E(HLECH)_"LOCAL"
"RTN","RAHLRPT",70,0)
 S X1="OBR"_HLFS_HLFS_HLFS_RADTI_"-"_RACNI_$E(HLECH)_RADTECN_$E(HLECH)_"L"_HLFS_RAOBR4_HLFS_HLFS_HLFS_RADTE0_HLFS_HLQ_HLFS_HLQ_HLFS_HLFS_HLFS_HLFS_HLFS,Y=$$HLDATE^HLFNC($P(RARPT0,"^",6)) S X1=X1_Y_HLFS_HLFS
"RTN","RAHLRPT",71,0)
 S RAPRV=$$GET1^DIQ(200,+$P(RACN0,"^",14),.01)
"RTN","RAHLRPT",72,0)
 S Y=$$HLNAME^HLFNC(RAPRV) S X1=X1_$S(Y]"":+$P(RACN0,"^",14)_$E(HLECH)_Y,1:"")
"RTN","RAHLRPT",73,0)
 S $P(X1,HLFS,19)=$S($D(^DIC(42,+$P(RACN0,"^",6),0)):$P(^(0),"^"),$D(^SC(+$P(RACN0,"^",8),0)):$P(^(0),"^"),1:"Unknown")
"RTN","RAHLRPT",74,0)
 ; PCE 21 -> ien file #79.1~name of img loc~stn #~stn name
"RTN","RAHLRPT",75,0)
 N RACN00,RA20 S RACN00=$G(^RADPT(RADFN,"DT",RADTI,0))
"RTN","RAHLRPT",76,0)
 S RA20=+$G(^RA(79.1,+$P(RACN00,U,4),0))
"RTN","RAHLRPT",77,0)
 S $P(X1,HLFS,21)=$P(RACN00,"^",4)_$E(HLECH)_$P($G(^SC(RA20,0)),"^")_$E(HLECH)_$P(RACN00,"^",3)_$E(HLECH)_$P($G(^DIC(4,$P(RACN00,U,3),0)),"^")
"RTN","RAHLRPT",78,0)
 S $P(X1,HLFS,21)=$P(X1,HLFS,21)
"RTN","RAHLRPT",79,0)
 ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLRPT",80,0)
 ; S $P(X1,HLFS,21)=$$ESCAPE^RAHLRU($P(X1,HLFS,21))
"RTN","RAHLRPT",81,0)
 ;
"RTN","RAHLRPT",82,0)
 S OBR36=9999999.9999-RADTI
"RTN","RAHLRPT",83,0)
 S $P(X1,HLFS,37)=$$FMTHL7^XLFDT(OBR36)
"RTN","RAHLRPT",84,0)
 ;
"RTN","RAHLRPT",85,0)
 S RADTV=HLDT1 I $P(RARPT0,"^",5)="V",$P(RARPT0,"^",7) K RADTV S RADTV=$$HLDATE^HLFNC($P(RARPT0,"^",7))
"RTN","RAHLRPT",86,0)
 S $P(X1,HLFS,23)=RADTV,$P(X1,HLFS,26)=$S($P(RARPT0,"^",5)="V":"F",1:"R")
"RTN","RAHLRPT",87,0)
 ;Principal Result Interpreter = Verifying Physician
"RTN","RAHLRPT",88,0)
 S $P(X1,HLFS,33)="" I $P(RARPT0,"^",9) D
"RTN","RAHLRPT",89,0)
 .S X2=$$GET1^DIQ(200,$P(RARPT0,"^",9),.01) Q:X2']""
"RTN","RAHLRPT",90,0)
 .S Y=$$HLNAME^HLFNC(X2) Q:Y']""
"RTN","RAHLRPT",91,0)
 .S $P(X1,HLFS,33)=$P(RARPT0,"^",9)_$E(HLECH)_Y
"RTN","RAHLRPT",92,0)
 ;Assistant Result Interpreter = Primary Interpreting Staff OR Resident
"RTN","RAHLRPT",93,0)
 S $P(X1,HLFS,34)="" I $P(RACN0,"^",15) D
"RTN","RAHLRPT",94,0)
 .S X2=$$GET1^DIQ(200,$P(RACN0,"^",15),.01) Q:X2']""
"RTN","RAHLRPT",95,0)
 .S Y=$$HLNAME^HLFNC(X2) Q:Y']""
"RTN","RAHLRPT",96,0)
 .S $P(X1,HLFS,34)=$P(RACN0,"^",15)_$E(HLECH)_Y
"RTN","RAHLRPT",97,0)
 I $P(RACN0,"^",12) D
"RTN","RAHLRPT",98,0)
 .S X2=$$GET1^DIQ(200,$P(RACN0,"^",12),.01) Q:X2']""
"RTN","RAHLRPT",99,0)
 .S Y=$$HLNAME^HLFNC(X2) Q:Y']""
"RTN","RAHLRPT",100,0)
 .S $P(X1,HLFS,34)=$P(RACN0,"^",12)_$E(HLECH)_Y
"RTN","RAHLRPT",101,0)
 ;Technician = Technologist
"RTN","RAHLRPT",102,0)
 S $P(X1,HLFS,35)="" I $O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"TC",0)) D
"RTN","RAHLRPT",103,0)
 .S X2=$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"TC",0)) I X2']"" Q
"RTN","RAHLRPT",104,0)
 .S X2=$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"TC",X2,0)),"^",1) I X2']"" Q
"RTN","RAHLRPT",105,0)
 .S XX2=$$GET1^DIQ(200,X2,.01) Q:XX2']""
"RTN","RAHLRPT",106,0)
 .S Y=$$HLNAME^HLFNC(XX2) I Y']"" Q
"RTN","RAHLRPT",107,0)
 .S $P(X1,HLFS,35)=X2_$E(HLECH)_Y
"RTN","RAHLRPT",108,0)
 ;Transcriptionist
"RTN","RAHLRPT",109,0)
 S $P(X1,HLFS,36)="" I $G(^RARPT(RARPT,"T")) D
"RTN","RAHLRPT",110,0)
 .S X2=$$GET1^DIQ(200,$P(^RARPT(RARPT,"T"),"^",1),.01) I X2']"" Q
"RTN","RAHLRPT",111,0)
 .S Y=$$HLNAME^HLFNC(X2) I Y']"" Q
"RTN","RAHLRPT",112,0)
 .S $P(X1,HLFS,36)=^RARPT(RARPT,"T")_$E(HLECH)_Y
"RTN","RAHLRPT",113,0)
 ;
"RTN","RAHLRPT",114,0)
 ; if long str, break so 2nd str begins with separator to avoid abend
"RTN","RAHLRPT",115,0)
 N RAPART I $L(X1)>245 F RAPART=5:1:18 S RAPART(1)=$P(X1,HLFS,1,RAPART),RAPART(2)=$P(X1,HLFS,RAPART+1,99) Q:$L(RAPART(1))<245&($L(RAPART(2))<245)&($P(RAPART(2),HLFS)="")
"RTN","RAHLRPT",116,0)
 I $D(RAPART) K:RAPART=18 RAPART ;if RAPART reaches 18, then something's wrong, so kill RAPART to allow abend due "string too long"
"RTN","RAHLRPT",117,0)
 S RAN=RAN+1
"RTN","RAHLRPT",118,0)
 I $D(RAPART) S HLA("HLS",RAN)=$P(RAPART(1),HLFS)_HLFS,HLA("HLS",RAN,1)=$P(RAPART(1),HLFS,2,99)_HLFS,HLA("HLS",RAN,2)=RAPART(2) K RAPART Q
"RTN","RAHLRPT",119,0)
 S HLA("HLS",RAN)=X1
"RTN","RAHLRPT",120,0)
 Q
"RTN","RAHLRPT",121,0)
OBXDIA ;Compile 'OBX' Segment for Diagnostic Code
"RTN","RAHLRPT",122,0)
 S RAI=$P($G(^RA(78.3,+$P(RACN0,"^",13),0)),"^") I RAI]"" D
"RTN","RAHLRPT",123,0)
 .S RAN=RAN+1
"RTN","RAHLRPT",124,0)
 .I $$PATCH^XPDUTL("MAG*2.5*1")!(+$$VERSION^XPDUTL("MAG")>2.5) D
"RTN","RAHLRPT",125,0)
 ..S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"CE"_HLFS_"D"_$E(HLECH)_"DIAGNOSTIC CODE"_$E(HLECH)_"L"_HLFS_HLFS_+$P(RACN0,"^",13)_$E(HLECH)_RAI_$E(HLECH)_"L"
"RTN","RAHLRPT",126,0)
 ..; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLRPT",127,0)
 ..; S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"CE"_HLFS_"D"_$E(HLECH)_"DIAGNOSTIC CODE"_$E(HLECH)_"L"_HLFS_HLFS_+$P(RACN0,"^",13)_$E(HLECH)_$$ESCAPE^RAHLRU(RAI)_$E(HLECH)_"L"
"RTN","RAHLRPT",128,0)
 .E  D
"RTN","RAHLRPT",129,0)
 ..S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"ST"_HLFS_"D"_$E(HLECH)_"DIAGNOSTIC CODE"_$E(HLECH)_"L"_HLFS_HLFS_RAI
"RTN","RAHLRPT",130,0)
 .D OBX11^RAHLRU
"RTN","RAHLRPT",131,0)
 Q:'$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"DX",0))  ;any secondary dx
"RTN","RAHLRPT",132,0)
 S X2=0
"RTN","RAHLRPT",133,0)
OBXDIA2 S X2=$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"DX",X2)) Q:'X2
"RTN","RAHLRPT",134,0)
 S Y=+^(X2,0),X=$P($G(^RA(78.3,+Y,0)),U)
"RTN","RAHLRPT",135,0)
 I X]"" D
"RTN","RAHLRPT",136,0)
 .S RAN=RAN+1
"RTN","RAHLRPT",137,0)
 .I $$PATCH^XPDUTL("MAG*2.5*1")!(+$$VERSION^XPDUTL("MAG")>2.5) D
"RTN","RAHLRPT",138,0)
 ..S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"CE"_HLFS_"D"_$E(HLECH)_"DIAGNOSTIC CODE"_$E(HLECH)_"L"_HLFS_HLFS_Y_$E(HLECH)_X_$E(HLECH)_"L"
"RTN","RAHLRPT",139,0)
 ..; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLRPT",140,0)
 ..; S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"CE"_HLFS_"D"_$E(HLECH)_"DIAGNOSTIC CODE"_$E(HLECH)_"L"_HLFS_HLFS_Y_$E(HLECH)_$$ESCAPE^RAHLRU(X)_$E(HLECH)_"L"
"RTN","RAHLRPT",141,0)
 .E  D
"RTN","RAHLRPT",142,0)
 ..S HLA("HLS",RAN)="OBX"_HLFS_HLFS_"ST"_HLFS_"D"_$E(HLECH)_"DIAGNOSTIC CODE"_$E(HLECH)_"L"_HLFS_HLFS_X
"RTN","RAHLRPT",143,0)
 .D OBX11^RAHLRU
"RTN","RAHLRPT",144,0)
 G OBXDIA2
"RTN","RAHLRPT",145,0)
 ;
"RTN","RAHLRPT",146,0)
OBXIMP ;Compile 'OBX' segment for Impression
"RTN","RAHLRPT",147,0)
 I '$O(^RARPT(RARPT,"I",0)) S RAN=RAN+1,HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"I"_$E(HLECH)_"IMPRESSION"_$E(HLECH)_"L"_HLFS_HLFS_"None Entered" D OBX11^RAHLRU Q
"RTN","RAHLRPT",148,0)
 K ^UTILITY($J,"W") S DIWF="",DIWR=80,DIWL=1
"RTN","RAHLRPT",149,0)
 F RAI=0:0 S RAI=$O(^RARPT(RARPT,"I",RAI)) Q:'RAI  I $D(^(RAI,0)) S X=^(0) D RATELREL,^DIWP
"RTN","RAHLRPT",150,0)
 F RAI=0:0 S RAI=$O(^UTILITY($J,"W",DIWL,RAI)) Q:'RAI  I $D(^(RAI,0)) S RAN=RAN+1,HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"I"_$E(HLECH)_"IMPRESSION"_$E(HLECH)_"L"_HLFS_HLFS_^(0) D OBX11^RAHLRU
"RTN","RAHLRPT",151,0)
 Q
"RTN","RAHLRPT",152,0)
OBXMOD ;Compile 'OBX' Segment for Modifiers
"RTN","RAHLRPT",153,0)
 S RAN=RAN+1 D OBXMOD^RAHLRU
"RTN","RAHLRPT",154,0)
 Q
"RTN","RAHLRPT",155,0)
OBXPRC ;Compile 'OBX' Segment for Procedure
"RTN","RAHLRPT",156,0)
 S RAN=RAN+1 D OBXPRC^RAHLRU
"RTN","RAHLRPT",157,0)
 Q
"RTN","RAHLRPT",158,0)
OBXTCM ;Compile 'OBX' Segment for Tech Comments
"RTN","RAHLRPT",159,0)
 D OBXTCM^RAHLRU
"RTN","RAHLRPT",160,0)
 Q
"RTN","RAHLRPT",161,0)
OBXRPT ;Compile 'OBX' Segment for Radiology Report Text
"RTN","RAHLRPT",162,0)
 I '$O(^RARPT(RARPT,"R",0)) S RAN=RAN+1,HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"R"_$E(HLECH)_"REPORT"_$E(HLECH)_"L"_HLFS_HLFS_"None Entered" D OBX11^RAHLRU Q
"RTN","RAHLRPT",163,0)
 K ^UTILITY($J,"W") S DIWF="",DIWR=80,DIWL=1
"RTN","RAHLRPT",164,0)
 F RAI=0:0 S RAI=$O(^RARPT(RARPT,"R",RAI)) Q:'RAI  I $D(^(RAI,0)) S X=^(0) D RATELREL,^DIWP
"RTN","RAHLRPT",165,0)
 F RAI=0:0 S RAI=$O(^UTILITY($J,"W",DIWL,RAI)) Q:'RAI  I $D(^(RAI,0)) S RAN=RAN+1,HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"R"_$E(HLECH)_"REPORT"_$E(HLECH)_"L"_HLFS_HLFS_^(0) D OBX11^RAHLRU
"RTN","RAHLRPT",166,0)
 ; Replace above with following when Imaging can cope with ESC chars
"RTN","RAHLRPT",167,0)
 ; F RAI=0:0 S RAI=$O(^UTILITY($J,"W",DIWL,RAI)) Q:'RAI  I $D(^(RAI,0)) S RAN=RAN+1,HLA("HLS",RAN)="OBX"_HLFS_HLFS_"TX"_HLFS_"R"_$E(HLECH)_"REPORT"_$E(HLECH)_"L"_HLFS_HLFS_$$ESCAPE^RAHLRU(^(0)) D OBX11^RAHLRU
"RTN","RAHLRPT",168,0)
 Q
"RTN","RAHLRPT",169,0)
RATELREL ;Release the study for local reading
"RTN","RAHLRPT",170,0)
 I $G(RATELE),X[$G(RATELX) S RATELREL=1 Q
"RTN","RAHLRPT",171,0)
 ; 
"RTN","RAHLRPTT")
0^13^B17479415^n/a
"RTN","RAHLRPTT",1,0)
RAHLRPTT ;HISC/CAH AISC/SAW-Compiles HL7 'ORU' Message Type ; 4/26/01 10:40am
"RTN","RAHLRPTT",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**84**;Mar 16, 1998;Build 13
"RTN","RAHLRPTT",3,0)
EN ; Continuation from RAHLRPT which has been split because the 10 k size problem
"RTN","RAHLRPTT",4,0)
 ; & other inbound patch 84 utility
"RTN","RAHLRPTT",5,0)
 ;
"RTN","RAHLRPTT",6,0)
 ;Integration Agreements
"RTN","RAHLRPTT",7,0)
 ;----------------------
"RTN","RAHLRPTT",8,0)
 ;^%DT(10003); $$FIND1^DIC(2051); $$GET1^DIQ(2056); $$HLDATE^HLFNC(10106); $$HLNAME^HLFNC(10106)
"RTN","RAHLRPTT",9,0)
 ;$$M11^HLFNC(10106); $$EN^VAFHLPID(263)
"RTN","RAHLRPTT",10,0)
 ;read w/FileMan HL7 APPLICATION PARAMETER(10136)
"RTN","RAHLRPTT",11,0)
 ;
"RTN","RAHLRPTT",12,0)
INIT ;
"RTN","RAHLRPTT",13,0)
 D:$D(RANOSEND)  ;Patch 84
"RTN","RAHLRPTT",14,0)
 .N RATIEN,DIERR,RAERR
"RTN","RAHLRPTT",15,0)
 .S RATIEN=$S(+RANOSEND:+RANOSEND,1:$$FIND1^DIC(771,"","X",RANOSEND,"","","RAERR"))
"RTN","RAHLRPTT",16,0)
 .Q:'RATIEN!($D(RAERR)#2)
"RTN","RAHLRPTT",17,0)
 .;RATELE is set to the value of the 'TELERADIOLOGY APPLICATION' (#1) field 0:No; 1:Yes
"RTN","RAHLRPTT",18,0)
 .S RATELE=$P($G(^RA(79.7,RATIEN,0)),U,2) I 'RATELE K RATELE Q
"RTN","RAHLRPTT",19,0)
 .;RATELX is set to the value of the 'RELEASE STUDY KEYWORD' (#1.2) field 
"RTN","RAHLRPTT",20,0)
 .S RATELX=$P($G(^RA(79.7,RATIEN,0)),U,4)
"RTN","RAHLRPTT",21,0)
 .S:'$L(RATELX) RATELX="Released for local dictation by National Teleradiology"
"RTN","RAHLRPTT",22,0)
 S RASET=0,RACN0=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0))
"RTN","RAHLRPTT",23,0)
 S:'$D(RARPT) RARPT=+$P(RACN0,"^",17)
"RTN","RAHLRPTT",24,0)
 Q
"RTN","RAHLRPTT",25,0)
SETUP ; Setup basic examination information
"RTN","RAHLRPTT",26,0)
 S:RASET RACN0=^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)
"RTN","RAHLRPTT",27,0)
 S RADTE0=9999999.9999-RADTI,RADTECN=$E(RADTE0,4,7)_$E(RADTE0,2,3)_"-"_+RACN0,RARPT0=^RARPT(RARPT,0)
"RTN","RAHLRPTT",28,0)
 S RAPROC=+$P(RACN0,U,2),RAPROCIT=+$P($G(^RAMIS(71,RAPROC,0)),U,12),RAPROCIT=$P(^RA(79.2,RAPROCIT,0),U,1)
"RTN","RAHLRPTT",29,0)
 S RAPRCNDE=$G(^RAMIS(71,+RAPROC,0)),RACPT=+$P(RAPRCNDE,U,9)
"RTN","RAHLRPTT",30,0)
 S RACPTNDE=$$NAMCODE^RACPTMSC(RACPT,DT)
"RTN","RAHLRPTT",31,0)
 S Y=$$HLDATE^HLFNC(RADTE0) S RADTE0=$S(Y:Y,1:HLQ),Y=$$M11^HLFNC(RADFN)
"RTN","RAHLRPTT",32,0)
 Q
"RTN","RAHLRPTT",33,0)
TELE ;Setting TELERAD info for RAHLTCPB
"RTN","RAHLRPTT",34,0)
 ;RATELEKN = Keyword to get the name and NPI of teleradiologist
"RTN","RAHLRPTT",35,0)
 ;RATELENM = Teleradiologist Name
"RTN","RAHLRPTT",36,0)
 ;RATELEPI = Teleradiologist NPI
"RTN","RAHLRPTT",37,0)
 ;RATELEDR = Default DX for terad 'R' report
"RTN","RAHLRPTT",38,0)
 ;RATELEDF = Default DX for terad 'F' report
"RTN","RAHLRPTT",39,0)
 N RATIEN,DIERR,RAERR
"RTN","RAHLRPTT",40,0)
 S RATIEN=$$FIND1^DIC(771,"","X",$G(HL("SAN")),"","","RAERR")
"RTN","RAHLRPTT",41,0)
 Q:'RATIEN!($D(RAERR)#2)
"RTN","RAHLRPTT",42,0)
 S RATELE=$P($G(^RA(79.7,RATIEN,0)),U,2) ;Patch 84
"RTN","RAHLRPTT",43,0)
 Q:'RATELE
"RTN","RAHLRPTT",44,0)
 S RATELEKN=$P($G(^RA(79.7,RATIEN,0)),U,3) S:'$L(RATELEKN) RATELEKN="Report dictated by Teleradiologist: "
"RTN","RAHLRPTT",45,0)
 S RATELEDR=$P($G(^RA(79.7,RATIEN,2)),U) K:'$L(RATELEDR) RATELEDR
"RTN","RAHLRPTT",46,0)
 S RATELEDF=$P($G(^RA(79.7,RATIEN,2)),U,2) K:'$L(RATELEDF) RATELEDF
"RTN","RAHLRPTT",47,0)
 Q
"RTN","RAHLRPTT",48,0)
PID ;Compile 'PID' Segment
"RTN","RAHLRPTT",49,0)
 I HL("VER")']"2.2" D
"RTN","RAHLRPTT",50,0)
 .S X1="",X1="PID"_HLFS_HLFS_$G(VA("PID"))_HLFS_Y_HLFS_HLFS S X=VADM(1),Y=$$HLNAME^HLFNC(X) S X1=X1_Y_HLFS_HLFS
"RTN","RAHLRPTT",51,0)
 .S X=RAVADM(3),Y=$$HLDATE^HLFNC(X) S X1=X1_Y_HLFS_$S(VADM(5)]"":$S("MF"[$P(VADM(5),"^"):$P(VADM(5),"^"),1:"O"),1:"U") S:$P(VADM(2),"^")]"" $P(X1,HLFS,20)=$P(VADM(2),"^") S RAN=RAN+1,HLA("HLS",RAN)=X1
"RTN","RAHLRPTT",52,0)
 I HL("VER")]"2.2" S RAN=RAN+1,HLA("HLS",RAN)=$$EN^VAFHLPID(DFN,"2,3,5,7,8,19,20")
"RTN","RAHLRPTT",53,0)
 Q
"RTN","RAHLRPTT",54,0)
RESEND(RADFN,RADTI,RACNI) ; re-send exam message(s) to HL7 subscribers
"RTN","RAHLRPTT",55,0)
 ;
"RTN","RAHLRPTT",56,0)
 Q:'$G(RADFN)!'$G(RADTI)!'$G(RACNI)
"RTN","RAHLRPTT",57,0)
 Q:'$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0))  Q:'$P(^(0),U,2)
"RTN","RAHLRPTT",58,0)
 N RABD,RAEDTT,QUIT
"RTN","RAHLRPTT",59,0)
 ;
"RTN","RAHLRPTT",60,0)
 I '$D(DT) D ^%DT S DT=Y
"RTN","RAHLRPTT",61,0)
 ;
"RTN","RAHLRPTT",62,0)
 S RAEDTT=$$RAED(RADFN,RADTI,RACNI)
"RTN","RAHLRPTT",63,0)
 Q:'$L(RAEDTT)
"RTN","RAHLRPTT",64,0)
 D:RAEDTT[",REG," REG^RAHLRPC
"RTN","RAHLRPTT",65,0)
 D:RAEDTT[",CANCEL," CANCEL^RAHLRPC
"RTN","RAHLRPTT",66,0)
 D:RAEDTT[",EXAM,"
"RTN","RAHLRPTT",67,0)
 .S $P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),"^",30)="" ;Reset sent flag
"RTN","RAHLRPTT",68,0)
 .N RAEXMDUN D 1^RAHLRPC
"RTN","RAHLRPTT",69,0)
 D:RAEDTT[",RPT,"
"RTN","RAHLRPTT",70,0)
 .N RANOSEND,RARPT D RPT^RAHLRPC
"RTN","RAHLRPTT",71,0)
 Q
"RTN","RAHLRPTT",72,0)
 ;
"RTN","RAHLRPTT",73,0)
RAED(RADFN,RADTI,RACNI) ; identify correct ^RAHLRPC entry point(s)
"RTN","RAHLRPTT",74,0)
 ;
"RTN","RAHLRPTT",75,0)
 N RASTAT,RAIMTYP,RAORD,RETURN,RARPT
"RTN","RAHLRPTT",76,0)
 S RASTAT=""
"RTN","RAHLRPTT",77,0)
 ;
"RTN","RAHLRPTT",78,0)
 S RETURN=",REG,"
"RTN","RAHLRPTT",79,0)
 ;
"RTN","RAHLRPTT",80,0)
 S RASTAT=$$GET1^DIQ(70.03,RACNI_","_RADTI_","_RADFN,3,"I")
"RTN","RAHLRPTT",81,0)
 S RARPT=$$GET1^DIQ(70.03,RACNI_","_RADTI_","_RADFN,17,"I")
"RTN","RAHLRPTT",82,0)
 ;
"RTN","RAHLRPTT",83,0)
 S RAIMTYP=$$GET1^DIQ(72,+RASTAT,7) Q:'$L(RAIMTYP) ""
"RTN","RAHLRPTT",84,0)
 S RAORD=$$GET1^DIQ(72,+RASTAT,3)
"RTN","RAHLRPTT",85,0)
 ;
"RTN","RAHLRPTT",86,0)
 S:RAORD=0 RETURN=RETURN_"CANCEL,"
"RTN","RAHLRPTT",87,0)
 ;
"RTN","RAHLRPTT",88,0)
 S:$$GET1^DIQ(72,+RASTAT,8)="YES" RETURN=RETURN_"EXAM," ; Generate Examined HL7 Message
"RTN","RAHLRPTT",89,0)
 ;
"RTN","RAHLRPTT",90,0)
 D:RETURN'[",EXAM,"
"RTN","RAHLRPTT",91,0)
 .; also check previous statuses for 'Generate Examined HL7 Message'
"RTN","RAHLRPTT",92,0)
 .F  S RAORD=$O(^RA(72,"AA",RAIMTYP,RAORD),-1) Q:+RAORD<1  D  Q:RETURN[",EXAM,"
"RTN","RAHLRPTT",93,0)
 ..S RASTAT=$O(^RA(72,"AA",RAIMTYP,RAORD,0))
"RTN","RAHLRPTT",94,0)
 ..S:$$GET1^DIQ(72,+RASTAT,8)="YES" RETURN=RETURN_"EXAM,"
"RTN","RAHLRPTT",95,0)
 ;
"RTN","RAHLRPTT",96,0)
 ; Check if Verified Report exists
"RTN","RAHLRPTT",97,0)
 I RARPT]"",$$GET1^DIQ(74,RARPT_",",5,"I")="V" S RETURN=RETURN_"RPT,"
"RTN","RAHLRPTT",98,0)
 ;
"RTN","RAHLRPTT",99,0)
 Q RETURN
"RTN","RAHLRS1")
0^21^B57554802^B51416412
"RTN","RAHLRS1",1,0)
RAHLRS1 ;HIRMFO/ROB/PAVEL - Resend HL7 messages for selected Timeframe ; 4/2/07 3:42pm
"RTN","RAHLRS1",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**80,84**;Mar 16, 1998;Build 13
"RTN","RAHLRS1",3,0)
 ; Utility to RESEND HL7 messages for selected Timeframe
"RTN","RAHLRS1",4,0)
 ;
"RTN","RAHLRS1",5,0)
 ;Integration Agreements
"RTN","RAHLRS1",6,0)
 ;----------------------
"RTN","RAHLRS1",7,0)
 ;^%DT(10003); C^%DTC(10000); H^%DTC(10000); ^%ZISC(10089); ^%ZTLOAD(10063); $$GET1^DIQ(2056)
"RTN","RAHLRS1",8,0)
 ;^DIR(10026); ^XMD(10070)
"RTN","RAHLRS1",9,0)
 ;all access to ^ORD(101 to maintain application specific protocols(872)
"RTN","RAHLRS1",10,0)
 ;read w/FileMan HL7 APPLICATION PARAMETER(10136)
"RTN","RAHLRS1",11,0)
 ;
"RTN","RAHLRS1",12,0)
 N RACNI,RADFN,RADTI,RARPT,X,RAED,RABD,RASHBD,RASHED,RASHTD,RASHTM,DIC,DA,XX,YY
"RTN","RAHLRS1",13,0)
 N RALOCK,RASSS,RASSSX,RASSSL,I,X S RALOCK=0
"RTN","RAHLRS1",14,0)
CHECK ;
"RTN","RAHLRS1",15,0)
 D SETVARS Q:$G(RAIMGTY)=""
"RTN","RAHLRS1",16,0)
 W !!,"This option re-sends HL7 messages for a date range and for designated Recipients.",!
"RTN","RAHLRS1",17,0)
 W !,"It is strongly recommended you task this to run off hours.",!!
"RTN","RAHLRS1",18,0)
 S:'$D(U) U="^" S:'$D(DTIME) DTIME=9999
"RTN","RAHLRS1",19,0)
1 W ! K %DT S %DT="AEX",%DT("A")="Beginning Date: " D ^%DT
"RTN","RAHLRS1",20,0)
 G:Y<0!($D(DTOUT))!($D(DUOUT)) STOP
"RTN","RAHLRS1",21,0)
 S RABD=Y
"RTN","RAHLRS1",22,0)
 X ^DD("DD") S RASHBD=Y
"RTN","RAHLRS1",23,0)
 S X1=RABD,X2=-1 D C^%DTC S RABD=X
"RTN","RAHLRS1",24,0)
 S RABD=RABD_"."_9999
"RTN","RAHLRS1",25,0)
 ;
"RTN","RAHLRS1",26,0)
 W ! K %DT S %DT="AEX",%DT("A")="Ending Date: ",%DT("B")="NOW" D ^%DT
"RTN","RAHLRS1",27,0)
 G:Y<0!($D(DTOUT))!($D(DUOUT)) STOP
"RTN","RAHLRS1",28,0)
 S RAED=Y
"RTN","RAHLRS1",29,0)
 X ^DD("DD") S RASHED=Y
"RTN","RAHLRS1",30,0)
 S RAED=RAED_"."_9999
"RTN","RAHLRS1",31,0)
 K XX G:'$$GETAP(.XX) STOP
"RTN","RAHLRS1",32,0)
 W !!,"*** Pick the application in which to send the radiology data ***",!!
"RTN","RAHLRS1",33,0)
 F I=1:1 Q:'$D(XX(I))  W !,"  #",I,"   ",$O(XX(I,""))
"RTN","RAHLRS1",34,0)
2 ;user selects the application
"RTN","RAHLRS1",35,0)
 S DIR(0)="N^1:"_(I-1)
"RTN","RAHLRS1",36,0)
 W ! S DIR("?")="Please select an available application from the list."
"RTN","RAHLRS1",37,0)
 D ^DIR Q:$D(DIRUT)
"RTN","RAHLRS1",38,0)
 W !!,"The: ",$O(XX(+X,"")),"   will be the recipient"
"RTN","RAHLRS1",39,0)
 W !!,"Reviewing exams for selected time period... (This may take a few minutes)... "
"RTN","RAHLRS1",40,0)
 S Y=$$GETSUM(RABD,RAED)
"RTN","RAHLRS1",41,0)
 I 'Y W !!,"No exams exist for selected period, change the time frame !!!" H 3 W ! G 1
"RTN","RAHLRS1",42,0)
 W !!,"During this period of time ",Y," Exams were performed and app Run time= ",Y\5000," Hours."
"RTN","RAHLRS1",43,0)
 S RASSS(XX(X,$O(XX(+X,""))))="" D GETSUB(.RASSS,.RASSSX,.RASSSL)
"RTN","RAHLRS1",44,0)
 K ZTSAVE
"RTN","RAHLRS1",45,0)
 S ZTSAVE("RASSSX(")="",ZTSAVE("RASSSL(")="",ZTSAVE("RABD")="",ZTSAVE("RAED")="",ZTSAVE("RADFN")=""
"RTN","RAHLRS1",46,0)
 S ZTSAVE("RADTI")="",ZTSAVE("RACNI")="",ZTSAVE("RASHBD")="",ZTSAVE("RASHED")="",ZTIO=""
"RTN","RAHLRS1",47,0)
 S ZTDESC="Rad/Nuc Med Compiling HL7 Common Order",ZTRTN="TM^RAHLRS1"
"RTN","RAHLRS1",48,0)
 W ! K %DT S %DT="AEXT",%DT("A")="Scheduled time to run: ",%DT("B")="TODAY@23:59" D ^%DT
"RTN","RAHLRS1",49,0)
 G:Y<0!($D(DTOUT))!($D(DUOUT)) STOP
"RTN","RAHLRS1",50,0)
 S X=Y,YY=Y D H^%DTC S ZTDTH=$G(%H)_","_$G(%T)
"RTN","RAHLRS1",51,0)
 S Y=YY X ^DD("DD") S RASHTM=Y
"RTN","RAHLRS1",52,0)
 D ^%ZTLOAD
"RTN","RAHLRS1",53,0)
 W !,"Task ",$S('$D(ZTSK):" Has Not been Tasked !!!",1:"#:"_ZTSK_" Has been Tasked")
"RTN","RAHLRS1",54,0)
 D:$D(ZTSK)
"RTN","RAHLRS1",55,0)
 .N RAX,RAMPG,XMSUB,XMY,XMTEXT
"RTN","RAHLRS1",56,0)
 .S RAX(1)="Task #"_$G(ZTSK)_" is scheduled to run the option: "
"RTN","RAHLRS1",57,0)
 .S RAX(2)=">>Re-send HL7 messages for a date range and for designated Recipient.<<"
"RTN","RAHLRS1",58,0)
 .S RAX(3)=" Scheduled time to run: "_RASHTM
"RTN","RAHLRS1",59,0)
 .S RAX(4)="Date range from: "_$G(RASHBD)_" to: "_$G(RASHED)
"RTN","RAHLRS1",60,0)
 .S XMSUB="TASKMAN SCHEDULE NOTIFICATION/INFO"
"RTN","RAHLRS1",61,0)
 .S RAMPG="G.RAD HL7 MESSAGES"
"RTN","RAHLRS1",62,0)
 .S XMY(RAMPG)="",XMDUZ=.5
"RTN","RAHLRS1",63,0)
 .S XMTEXT="RAX("
"RTN","RAHLRS1",64,0)
 .D ^XMD
"RTN","RAHLRS1",65,0)
 Q
"RTN","RAHLRS1",66,0)
 ;
"RTN","RAHLRS1",67,0)
TM ;Taskman Entry...
"RTN","RAHLRS1",68,0)
 N RASTIME,RASUM7,RASUM7R,RASUM7E
"RTN","RAHLRS1",69,0)
 S RASTIME=$H,(RASUM7,RASUM7R,RASUM7E)=0
"RTN","RAHLRS1",70,0)
 F  S RABD=$O(^RADPT("AR",RABD)) Q:'RABD!(RABD>RAED)  D
"RTN","RAHLRS1",71,0)
 .S RADFN=0 F  S RADFN=$O(^RADPT("AR",RABD,RADFN)) Q:'RADFN  D
"RTN","RAHLRS1",72,0)
 ..S RADTI=0 F  S RADTI=$O(^RADPT("AR",RABD,RADFN,RADTI)) Q:'RADTI  D
"RTN","RAHLRS1",73,0)
 ...S RACNI=0 F  S RACNI=$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI)) Q:'RACNI  D RESEND(RADFN,RADTI,RACNI)
"RTN","RAHLRS1",74,0)
 K RAX S RAX(1)="Task #"_$G(ZTSK)_" successfully completed the option: "
"RTN","RAHLRS1",75,0)
 S RAX(2)=">>Re-send HL7 messages for a date range and for designated Recipient.<<"
"RTN","RAHLRS1",76,0)
 S RAX(3)="Date range from: "_$G(RASHBD)_" to: "_$G(RASHED)
"RTN","RAHLRS1",77,0)
 S RAX(4)="# Of RAD Reports transferred: "_$G(RASUM7R)
"RTN","RAHLRS1",78,0)
 S RAX(5)="# Of Exams transferred:      "_$G(RASUM7)
"RTN","RAHLRS1",79,0)
 S:$G(RASUM7E) X(6)="# Of Exams not transferred because of ""BAD DATA"": "_$G(RASUM7E)
"RTN","RAHLRS1",80,0)
 S XMSUB="TASKMAN ""RESEND HL7 OPTION"" COMPLETED/INFO"
"RTN","RAHLRS1",81,0)
 S RAMPG="G.RAD HL7 MESSAGES"
"RTN","RAHLRS1",82,0)
 S XMY(RAMPG)="",XMDUZ=.5
"RTN","RAHLRS1",83,0)
 S XMTEXT="RAX("
"RTN","RAHLRS1",84,0)
 D ^XMD
"RTN","RAHLRS1",85,0)
 G STOP
"RTN","RAHLRS1",86,0)
 Q
"RTN","RAHLRS1",87,0)
 ;
"RTN","RAHLRS1",88,0)
RESEND(RADFN,RADTI,RACNI) ; re-send exam message(s) to HL7 subscribers
"RTN","RAHLRS1",89,0)
 ; for every 10 messages sent, make sure queue is not clogged... $$HANG
"RTN","RAHLRS1",90,0)
 N RAXAMP80 S RAXAMP80=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0))
"RTN","RAHLRS1",91,0)
 I '(+$P(RAXAMP80,U))!'($P(RAXAMP80,U,2)) S RASUM7E=RASUM7E+1 Q
"RTN","RAHLRS1",92,0)
 N RABD,RAEDP80,QUIT
"RTN","RAHLRS1",93,0)
 ;
"RTN","RAHLRS1",94,0)
 I '$D(DT) D ^%DT S DT=Y
"RTN","RAHLRS1",95,0)
 ;
"RTN","RAHLRS1",96,0)
 S RAEDP80=$$RAED(RADFN,RADTI,RACNI)
"RTN","RAHLRS1",97,0)
 I '$L(RAEDP80) S RASUM7E=RASUM7E+1 Q
"RTN","RAHLRS1",98,0)
 D:RAEDP80[",REG,"
"RTN","RAHLRS1",99,0)
 .D CHSUM N RASUM7,RASUM7R,RASUM7E D REG^RAHLRPC
"RTN","RAHLRS1",100,0)
 D:RAEDP80[",CANCEL,"
"RTN","RAHLRS1",101,0)
 .D CHSUM N RASUM7,RASUM7R,RASUM7E D CANCEL^RAHLRPC
"RTN","RAHLRS1",102,0)
 D:RAEDP80[",EXAM,"
"RTN","RAHLRS1",103,0)
 .D CHSUM
"RTN","RAHLRS1",104,0)
 .S $P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),"^",30)="" ;Reset sent flag
"RTN","RAHLRS1",105,0)
 .N RASUM7,RAEXMDUN,RASUM7R,RASUM7E D 1^RAHLRPC
"RTN","RAHLRS1",106,0)
 D:RAEDP80[",RPT,"
"RTN","RAHLRS1",107,0)
 .D CHSUM N RASUM7,RANOSEND,RASUM7R,RASUM7E,RARPT D RPT^RAHLRPC
"RTN","RAHLRS1",108,0)
 Q
"RTN","RAHLRS1",109,0)
 ;
"RTN","RAHLRS1",110,0)
RAED(RADFN,RADTI,RACNI) ; identify correct ^RAHLRPC entry point(s)
"RTN","RAHLRS1",111,0)
 ;
"RTN","RAHLRS1",112,0)
 N RASTAT,RAIMTYP,RAORD,RETURN,RARPT
"RTN","RAHLRS1",113,0)
 S RASTAT=""
"RTN","RAHLRS1",114,0)
 ;
"RTN","RAHLRS1",115,0)
 S RETURN=",REG,"
"RTN","RAHLRS1",116,0)
 ;
"RTN","RAHLRS1",117,0)
 S RASTAT=$$GET1^DIQ(70.03,RACNI_","_RADTI_","_RADFN,3,"I")
"RTN","RAHLRS1",118,0)
 S RARPT=$$GET1^DIQ(70.03,RACNI_","_RADTI_","_RADFN,17,"I")
"RTN","RAHLRS1",119,0)
 ;
"RTN","RAHLRS1",120,0)
 S RAIMTYP=$$GET1^DIQ(72,+RASTAT,7) Q:'$L(RAIMTYP) ""
"RTN","RAHLRS1",121,0)
 S RAORD=$$GET1^DIQ(72,+RASTAT,3)
"RTN","RAHLRS1",122,0)
 ;
"RTN","RAHLRS1",123,0)
 S:RAORD=0 RETURN=RETURN_"CANCEL,"
"RTN","RAHLRS1",124,0)
 ;
"RTN","RAHLRS1",125,0)
 S:$$GET1^DIQ(72,+RASTAT,8)="YES" RETURN=RETURN_"EXAM," ; Generate Examined HL7 Message
"RTN","RAHLRS1",126,0)
 ;
"RTN","RAHLRS1",127,0)
 D:RETURN'[",EXAM,"
"RTN","RAHLRS1",128,0)
 .; also check previous statuses for 'Generate Examined HL7 Message'
"RTN","RAHLRS1",129,0)
 .F  S RAORD=$O(^RA(72,"AA",RAIMTYP,RAORD),-1) Q:+RAORD<1  D  Q:RETURN[",EXAM,"
"RTN","RAHLRS1",130,0)
 ..S RASTAT=$O(^RA(72,"AA",RAIMTYP,RAORD,0))
"RTN","RAHLRS1",131,0)
 ..S:$$GET1^DIQ(72,+RASTAT,8)="YES" RETURN=RETURN_"EXAM,"
"RTN","RAHLRS1",132,0)
 ;
"RTN","RAHLRS1",133,0)
 ; Check if Verified Report exists
"RTN","RAHLRS1",134,0)
 I RARPT]"",$$GET1^DIQ(74,RARPT_",",5,"I")="V" S RETURN=RETURN_"RPT,",RASUM7R=RASUM7R+1
"RTN","RAHLRS1",135,0)
 ;
"RTN","RAHLRS1",136,0)
 Q RETURN
"RTN","RAHLRS1",137,0)
 ;
"RTN","RAHLRS1",138,0)
SETVARS ; Setup key Rad/Nuc Med variables
"RTN","RAHLRS1",139,0)
 ;
"RTN","RAHLRS1",140,0)
 I $O(RACCESS(DUZ,""))="" D SETVARS^RAPSET1(0)
"RTN","RAHLRS1",141,0)
 Q:'($D(RACCESS(DUZ))\10)  ; user does not have location access
"RTN","RAHLRS1",142,0)
 I $G(RAIMGTY)="" D SETVARS^RAPSET1(1) K:$G(RAIMGTY)="" XQUIT
"RTN","RAHLRS1",143,0)
 Q
"RTN","RAHLRS1",144,0)
STOP ;
"RTN","RAHLRS1",145,0)
 D ^%ZISC
"RTN","RAHLRS1",146,0)
 Q
"RTN","RAHLRS1",147,0)
 ;
"RTN","RAHLRS1",148,0)
GETAP(XX) ;
"RTN","RAHLRS1",149,0)
 ;Get list of Applications in XX
"RTN","RAHLRS1",150,0)
 N XXX,X11,X1,X2,X3,Z,Z1,J
"RTN","RAHLRS1",151,0)
 F X11="RA REG","RA EXAMINED","RA CANCEL","RA RPT" D
"RTN","RAHLRS1",152,0)
 .S X1=$E(X11,1,$L(X11)-1)_$C($A($E(X11,$L(X11)))-1)
"RTN","RAHLRS1",153,0)
 .F  S X1=$O(^ORD(101,"B",X1)) Q:X1'[X11  S X2=$O(^ORD(101,"B",X1,0)) Q:'X2  D
"RTN","RAHLRS1",154,0)
 ..K Z S X3=0 F  S X3=$O(^ORD(101,X2,775,X3)) Q:'X3  S Z(+^(X3,0))=""
"RTN","RAHLRS1",155,0)
 ..Q:'$D(Z)  K Z1 S X3=0 F  S X3=$O(Z(X3)) Q:'X3  D
"RTN","RAHLRS1",156,0)
 ...S Z1=$G(^ORD(101,X3,770)) S:+$P(Z1,U,2) XXX(+$P(Z1,U,2))=""
"RTN","RAHLRS1",157,0)
 S X1=0 F J=1:1 S X1=$O(XXX(X1)) Q:'X1  D
"RTN","RAHLRS1",158,0)
 .N DIERR,RAERR,Y
"RTN","RAHLRS1",159,0)
 .S Y=$$GET1^DIQ(771,X1,.01,"","","RAERR")
"RTN","RAHLRS1",160,0)
 .Q:Y=""!($D(RAERR)#2)  S XX(J,Y)=X1
"RTN","RAHLRS1",161,0)
 .Q
"RTN","RAHLRS1",162,0)
 Q $S($D(XXX):1,1:0)
"RTN","RAHLRS1",163,0)
 ;
"RTN","RAHLRS1",164,0)
GETSUB(APL,SUB,LINK) ;Get all subscribers (not associated with application)... To be excluded as receipients..
"RTN","RAHLRS1",165,0)
 ; Get all logical links to be in business, so we can control flow of messages
"RTN","RAHLRS1",166,0)
 ;APL(IEN) = Application 771 IENs Input
"RTN","RAHLRS1",167,0)
 ;SUB(Event Driver IEN,Subscriber IEN)="" Output
"RTN","RAHLRS1",168,0)
 ;LINK(IEN of logical link)  
"RTN","RAHLRS1",169,0)
 N XX,X11,X1,X2,X3
"RTN","RAHLRS1",170,0)
 Q:'$O(APL(0))
"RTN","RAHLRS1",171,0)
 F X11="RA REG","RA EXAMINED","RA CANCEL","RA RPT" D
"RTN","RAHLRS1",172,0)
 .S X1=$E(X11,1,$L(X11)-1)_$C($A($E(X11,$L(X11)))-1)
"RTN","RAHLRS1",173,0)
 .F  S X1=$O(^ORD(101,"B",X1)) Q:X1'[X11  S X2=$O(^ORD(101,"B",X1,0)) Q:'X2  D
"RTN","RAHLRS1",174,0)
 ..S X3=0 F  S X3=$O(^ORD(101,X2,775,X3)) Q:'X3  S XX=+^(X3,0) D
"RTN","RAHLRS1",175,0)
 ...I '$D(APL(+$P($G(^ORD(101,XX,770)),U,2))) S SUB(X2,XX)=X1 Q
"RTN","RAHLRS1",176,0)
 ...S XX=+$P($G(^ORD(101,XX,770)),U,7) S:XX LINK(XX)=""
"RTN","RAHLRS1",177,0)
 Q
"RTN","RAHLRS1",178,0)
GETHLP(RAEID,HLP,ADR) ; Get excluded subcribers set into HLP array
"RTN","RAHLRS1",179,0)
 N I,J,XX,AA S J=$O(HLP("EXCLUDE SUBSCRIBER",99999999),-1)
"RTN","RAHLRS1",180,0)
 ;XX Set the list of already excluded subscribers, so be sure we don't set it second time
"RTN","RAHLRS1",181,0)
 S AA=ADR_"("_RAEID_",I)"
"RTN","RAHLRS1",182,0)
 S I=0 F I=$O(HLP("EXCLUDE SUBSCRIBER",I)) Q:'I  S XX(HLP("EXCLUDE SUBSCRIBER",I))=""
"RTN","RAHLRS1",183,0)
 S I=0 F  S I=$O(@AA) Q:'I  S:'$D(XX(I)) J=J+1,HLP("EXCLUDE SUBSCRIBER",J)=I
"RTN","RAHLRS1",184,0)
 Q
"RTN","RAHLRS1",185,0)
CHSUM ;CHECKSUM
"RTN","RAHLRS1",186,0)
 S RASUM7=RASUM7+1 I '(RASUM7#50) F  Q:'$$HANG  H 15
"RTN","RAHLRS1",187,0)
 Q
"RTN","RAHLRS1",188,0)
HANG() ; scan all logical links to see if queue is bigger than 100
"RTN","RAHLRS1",189,0)
 N I,S,L,QUIT
"RTN","RAHLRS1",190,0)
 S (QUIT,L)=0
"RTN","RAHLRS1",191,0)
 F  S L=$O(RASSSL(L)) Q:'L  S (S,I)=0 D  Q:QUIT
"RTN","RAHLRS1",192,0)
 .F  S I=$O(^HLMA("AC","O",L,I)) Q:'I  S S=S+1 I S>100 S QUIT=1 Q  ;Quit if more than 100 messages waiting in outgoing queue for link...
"RTN","RAHLRS1",193,0)
 Q QUIT
"RTN","RAHLRS1",194,0)
GETSUM(RABD,RAED) ; Get number of exams for period called from RAHLR RAHLR1 RAHLRPT RAHLRPT1
"RTN","RAHLRS1",195,0)
 N RADFN,RADTI,RACNI,RASUM7
"RTN","RAHLRS1",196,0)
 S RASUM7=0
"RTN","RAHLRS1",197,0)
 F  S RABD=$O(^RADPT("AR",RABD)) Q:'RABD!(RABD>RAED)  D
"RTN","RAHLRS1",198,0)
 .S RADFN=0 F  S RADFN=$O(^RADPT("AR",RABD,RADFN)) Q:'RADFN  D
"RTN","RAHLRS1",199,0)
 ..S RADTI=0 F  S RADTI=$O(^RADPT("AR",RABD,RADFN,RADTI)) Q:'RADTI  D
"RTN","RAHLRS1",200,0)
 ...S RACNI=0 F  S RACNI=$O(^RADPT(RADFN,"DT",RADTI,"P",RACNI)) Q:'RACNI  S:^(RACNI,0) RASUM7=RASUM7+1
"RTN","RAHLRS1",201,0)
 Q RASUM7
"RTN","RAHLRS1",202,0)
 Q
"RTN","RAHLTCPB")
0^5^B70765098^B61371898
"RTN","RAHLTCPB",1,0)
RAHLTCPB ; HIRMFO/REL,GJC,BNT,PAV - Rad/Nuc Med HL7 TCP/IP Bridge;05/21/99
"RTN","RAHLTCPB",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**12,17,25,51,71,81,84**;Mar 16, 1998;Build 13
"RTN","RAHLTCPB",3,0)
 ; 07/05/2006 BAY/KAM Remedy Call 124379 Eliminate unneeded ORM msgs
"RTN","RAHLTCPB",4,0)
 ; 09/01/2006   Acomodate multiple ORC/OBR segments Patch 81
"RTN","RAHLTCPB",5,0)
 ; 
"RTN","RAHLTCPB",6,0)
 ;Integration Agreements
"RTN","RAHLTCPB",7,0)
 ;----------------------
"RTN","RAHLTCPB",8,0)
 ;INIT^HLFNC2(2161); GENACK^HLMA1(2165); $$DT^XLFDT(10103)
"RTN","RAHLTCPB",9,0)
 ; 
"RTN","RAHLTCPB",10,0)
EN1 ; Build the ^TMP("RARPT-REC" global when we receive the
"RTN","RAHLTCPB",11,0)
 ; 07/05/2006 Remedy Call 124379 message from HL7. If RAHLTCPB is defined, do not broadcast ORM messages. As of the writing
"RTN","RAHLTCPB",12,0)
 ; of patch 71, RAHLTCPB is referenced in RAHLTCPB, UPSTAT^RAUTL0, & UP2^RAUTL1 Generic provider: RADIOLOGY,OUTSIDE SERVICE
"RTN","RAHLTCPB",13,0)
 N RATELE,RATELENM,RATELEPI,RATELEKN,RATELEDR,RATELEDF
"RTN","RAHLTCPB",14,0)
 D TELE^RAHLRPTT ;Patch 84
"RTN","RAHLTCPB",15,0)
 ;** branch to new HL7 logic when the HL7 version surpasses 2.3 **
"RTN","RAHLTCPB",16,0)
 I HL("VER")>2.3,($T(^RAHLTCPX))'="" GOTO EN1^RAHLTCPX
"RTN","RAHLTCPB",17,0)
 S RASUB=HL("MID"),RAHLTCPB=1 K RAERR
"RTN","RAHLTCPB",18,0)
 ;**********************************************
"RTN","RAHLTCPB",19,0)
 ;RACN is Counter - Indication that ORC segment present
"RTN","RAHLTCPB",20,0)
 N RACN,II,L,RAPRSET,RARRR,XX,RAHLD,RARSDNT,RATRSCRP S (RACN,RAPRSET)=0 ; = Address where we go to store data...
"RTN","RAHLTCPB",21,0)
 ;**********************************************
"RTN","RAHLTCPB",22,0)
 K ^TMP("RARPT-HL7",$J) ; clean area that holds data from HL7
"RTN","RAHLTCPB",23,0)
 K ^TMP("RARPT-REC",$J,RASUB) ; kill storage area for new HL7 message id
"RTN","RAHLTCPB",24,0)
 S ^TMP("RARPT-REC",$J,RASUB,"RADATE")=$$DT^XLFDT()
"RTN","RAHLTCPB",25,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","RAHLTCPB",26,0)
 .I '$L(HLNODE),$L($G(HLNODE(1))) S HLNODE=HLNODE(1) K HLNODE(1) F J=2:1 Q:'$D(HLNODE(J))  S HLNODE(J-1)=HLNODE(J) K HLNODE(J)
"RTN","RAHLTCPB",27,0)
 .S ^TMP("RARPT-HL7",$J,I)=HLNODE,J=0 F  S J=$O(HLNODE(J)) Q:'J  S ^TMP("RARPT-HL7",$J,I,J)=HLNODE(J)
"RTN","RAHLTCPB",28,0)
 S CNT=2,SEGMNT=$G(^TMP("RARPT-HL7",$J,CNT))
"RTN","RAHLTCPB",29,0)
 S:'$$GETSFLAG^RAHLRU($G(HL("SAN")),$G(HL("MTN")),$G(HL("ETN")),$G(HL("VER"))) RANOSEND=$G(HL("SAN"))
"RTN","RAHLTCPB",30,0)
 S ^TMP("RARPT-REC",$J,RASUB,"VENDOR")=$G(HL("SAN"))
"RTN","RAHLTCPB",31,0)
PID ; Pick data off the 'PID' segment.
"RTN","RAHLTCPB",32,0)
 I $P(SEGMNT,HL("FS"))="PID" D
"RTN","RAHLTCPB",33,0)
 . S SEGMNT=$P(SEGMNT,HL("FS"),2,99999)
"RTN","RAHLTCPB",34,0)
 . I $P($P(SEGMNT,HL("FS"),3),$E(HL("ECH")))]"" D
"RTN","RAHLTCPB",35,0)
 .. S (^TMP("RARPT-REC",$J,RASUB,"RADFN"),RADFN)=$P($P(SEGMNT,HL("FS"),3),$E(HL("ECH")))
"RTN","RAHLTCPB",36,0)
 .. Q
"RTN","RAHLTCPB",37,0)
 . I $P(SEGMNT,HL("FS"),19)]"" D
"RTN","RAHLTCPB",38,0)
 .. S ^TMP("RARPT-REC",$J,RASUB,"RASSN")=$P(SEGMNT,HL("FS"),19)
"RTN","RAHLTCPB",39,0)
 .. Q
"RTN","RAHLTCPB",40,0)
 . Q
"RTN","RAHLTCPB",41,0)
 E  S RAERR="Missing PID segment" D XIT Q
"RTN","RAHLTCPB",42,0)
 I '(+$G(^TMP("RARPT-REC",$J,RASUB,"RADFN"))) D  Q
"RTN","RAHLTCPB",43,0)
 .S RAERR="Invalid Patient ID"
"RTN","RAHLTCPB",44,0)
 .D XIT
"RTN","RAHLTCPB",45,0)
 ; Save off E-Sig information (if it exists)
"RTN","RAHLTCPB",46,0)
 S:$D(HL("ESIG")) ^TMP("RARPT-REC",$J,RASUB,"RAESIG")=HL("ESIG")
"RTN","RAHLTCPB",47,0)
 ;********************************
"RTN","RAHLTCPB",48,0)
ORC ; Pick data off the 'ORC' segment.
"RTN","RAHLTCPB",49,0)
 D
"RTN","RAHLTCPB",50,0)
 .N CNT1 S CNT1=CNT,RARRR=""
"RTN","RAHLTCPB",51,0)
111 .K SEGMNT S CNT1=$O(^TMP("RARPT-HL7",$J,CNT1)) Q:CNT1=""  S SEGMNT=$G(^(CNT1))
"RTN","RAHLTCPB",52,0)
 .I $P(SEGMNT,HL("FS"))="PV1" S CNT=CNT1 G 111
"RTN","RAHLTCPB",53,0)
 .Q:$P(SEGMNT,HL("FS"))'="ORC"
"RTN","RAHLTCPB",54,0)
 .S CNT=CNT1 Q:$P(SEGMNT,HL("FS"),2)'="CN"  ; find the 'ORC' segment
"RTN","RAHLTCPB",55,0)
 .S RACN=RACN+1,RARRR="RARPT-REC-"_RACN
"RTN","RAHLTCPB",56,0)
 ;********************************
"RTN","RAHLTCPB",57,0)
OBR ; Pick data off the 'OBR' segment.
"RTN","RAHLTCPB",58,0)
 I $L(RARRR) K ^TMP(RARRR,$J) M ^TMP(RARRR,$J)=^TMP("RARPT-REC",$J) ;Merge if OBR without Report
"RTN","RAHLTCPB",59,0)
 S:'$L(RARRR) RARRR="RARPT-REC"
"RTN","RAHLTCPB",60,0)
 K SEGMNT F  S CNT=$O(^TMP("RARPT-HL7",$J,CNT)) Q:CNT=""  S SEGMNT=$G(^(CNT)) Q:$P(SEGMNT,HL("FS"))="OBR"  ; find the 'OBR' segment
"RTN","RAHLTCPB",61,0)
 I $P($G(SEGMNT),HL("FS"))'="OBR" S RAERR="Missing OBR segment" D XIT Q
"RTN","RAHLTCPB",62,0)
 S SEGMNT=$P(SEGMNT,HL("FS"),2,99999) K RADTI,RACNI
"RTN","RAHLTCPB",63,0)
 I $P(SEGMNT,HL("FS"),3)]"" D
"RTN","RAHLTCPB",64,0)
 . N RADTCN S RADTCN=$P(SEGMNT,HL("FS"),3)
"RTN","RAHLTCPB",65,0)
 . S:$P($P(RADTCN,$E(HL("ECH"))),"-")]"" (^TMP(RARRR,$J,RASUB,"RADTI"),RADTI)=$P($P(RADTCN,$E(HL("ECH"))),"-")
"RTN","RAHLTCPB",66,0)
 . S:$P($P(RADTCN,$E(HL("ECH"))),"-",2)]"" (^TMP(RARRR,$J,RASUB,"RACNI"),RACNI)=$P($P(RADTCN,$E(HL("ECH"))),"-",2)
"RTN","RAHLTCPB",67,0)
 . S:$P(RADTCN,$E(HL("ECH")),2)["&L" RADTCN=$TR(RADTCN,"&","^")
"RTN","RAHLTCPB",68,0)
 . S:$P(RADTCN,$E(HL("ECH")),2)]"" ^TMP(RARRR,$J,RASUB,"RALONGCN")=$P(RADTCN,$E(HL("ECH")),2)
"RTN","RAHLTCPB",69,0)
 . Q
"RTN","RAHLTCPB",70,0)
 I $G(RADTI)'>0 S RAERR="Invalid exam registration timestamp" D XIT Q
"RTN","RAHLTCPB",71,0)
 I $G(RACNI)'>0 S RAERR="Invalid exam record IEN" D XIT Q
"RTN","RAHLTCPB",72,0)
 S RAHLD=$$PCEXTR^RAHLO4(CNT,SEGMNT,25,HL("FS")) K RAHL70
"RTN","RAHLTCPB",73,0)
 I RAHLD="" S RAERR="Missing Report Status" D XIT Q
"RTN","RAHLTCPB",74,0)
 I "AFR"'[RAHLD S RAERR="Invalid Report Status: "_RAHLD D XIT Q
"RTN","RAHLTCPB",75,0)
 S ^TMP(RARRR,$J,RASUB,"RASTAT")=RAHLD
"RTN","RAHLTCPB",76,0)
 G:$P(RARRR,"-",3) 112 S RAHLD=$$PCEXTR^RAHLO4(CNT,SEGMNT,32,HL("FS")) K RAHL70
"RTN","RAHLTCPB",77,0)
 I RAHLD']"" S RAERR="Missing Provider ID" D XIT Q
"RTN","RAHLTCPB",78,0)
 S RAVERF=RAHLD
"RTN","RAHLTCPB",79,0)
 ; -----   Check the validity of the provider name   -----
"RTN","RAHLTCPB",80,0)
 I '$D(^VA(200,"B",RAVERF)) D  ; check for a partial match in file 200
"RTN","RAHLTCPB",81,0)
 . D VFIER^RAHLO3 ; if one partial match found, return the entry ien
"RTN","RAHLTCPB",82,0)
 E  D  ; $D(^VA(200,"B",RAVERF)) true, get the entry ien
"RTN","RAHLTCPB",83,0)
 . S RAVERF=$O(^VA(200,"B",RAVERF,0))
"RTN","RAHLTCPB",84,0)
 . S:'RAVERF RAERR="Invalid Provider Name: "_RAHLD
"RTN","RAHLTCPB",85,0)
 ; can't get resident info from medspeak
"RTN","RAHLTCPB",86,0)
 S RAHLD=$$PCEXTR^RAHLO4(CNT,SEGMNT,33,HL("FS")),RARSDNT="" K RAHL70
"RTN","RAHLTCPB",87,0)
 I RAHLD]"" D
"RTN","RAHLTCPB",88,0)
 . S RARSDNT=$P(RAHLD,$E(HL("ECH"),4)) I '$D(^VA(200,+RARSDNT,0)) S RARSDNT=""
"RTN","RAHLTCPB",89,0)
 S RAHLD="",RAHLD=$$PCEXTR^RAHLO4(CNT,SEGMNT,35,HL("FS")),RATRSCRP="" K RAHL70
"RTN","RAHLTCPB",90,0)
 I RAHLD]"" D
"RTN","RAHLTCPB",91,0)
 . S RATRSCRP=$P(RAHLD,$E(HL("ECH"),4)) I '$D(^VA(200,+RATRSCRP,0)) S RATRSCRP=""
"RTN","RAHLTCPB",92,0)
 S ^TMP(RARRR,$J,RASUB,"RAVERF")=RAVERF
"RTN","RAHLTCPB",93,0)
 S ^TMP(RARRR,$J,RASUB,"RATRANSCRIPT")=$S(RATRSCRP]"":RATRSCRP,RARSDNT]"":RARSDNT,1:RAVERF)
"RTN","RAHLTCPB",94,0)
 S:$G(RARSDNT) ^TMP(RARRR,$J,RASUB,"RARESIDENT")=RARSDNT
"RTN","RAHLTCPB",95,0)
 S ^TMP(RARRR,$J,RASUB,"RASTAFF")=RAVERF,^("RAWHOCHANGE")=RAVERF
"RTN","RAHLTCPB",96,0)
 I $D(RAERR) D XIT Q
"RTN","RAHLTCPB",97,0)
 D ESIG^RAHLO3
"RTN","RAHLTCPB",98,0)
 ;
"RTN","RAHLTCPB",99,0)
 ;If last OBR set provider info to all OBRs
"RTN","RAHLTCPB",100,0)
 K XX F I=1:1:RACN S XX=RARRR_"-"_I D:$D(^TMP(XX,$J,RASUB))
"RTN","RAHLTCPB",101,0)
 .N XXX M XXX=^TMP(XX,$J,RASUB),^TMP(XX,$J,RASUB)=^TMP(RARRR,$J,RASUB),^TMP(XX,$J,RASUB)=XXX
"RTN","RAHLTCPB",102,0)
112 I $D(RADTI),$D(RACNI),$D(RAPRSET(RADTI,RACNI)) K RAPRSET(RADTI,RACNI),^TMP(RARRR,$J) S RACN=RACN-1 G:$P(RARRR,"-",3) ORC M ^TMP(RARRR,$J)=^TMP("RARPT-REC-"_(RACN+1),$J) K ^TMP("RARPT-REC-"_(RACN+1),$J) G OBX
"RTN","RAHLTCPB",103,0)
 I $D(RADTI),'$D(RAPRSET(RADTI)) D  ;Get array of printset for date...
"RTN","RAHLTCPB",104,0)
 .N RAPRTSET,RACN,RASUB,CNT
"RTN","RAHLTCPB",105,0)
 .K XX D EN2^RAUTL20(.XX) M:$D(XX) RAPRSET(RADTI)=XX K RAPRSET(RADTI,RACNI)
"RTN","RAHLTCPB",106,0)
 ;
"RTN","RAHLTCPB",107,0)
OBX ; Pick data off the 'OBX' segments
"RTN","RAHLTCPB",108,0)
 K SEGMNT F  S CNT=$O(^TMP("RARPT-HL7",$J,CNT)) Q:CNT=""  S SEGMNT=$G(^(CNT)) D:$P(SEGMNT,HL("FS"))="OBX"  Q:$D(RAERR)  I $P(SEGMNT,HL("FS"))="ORC" S CNT=CNT-1 G ORC
"RTN","RAHLTCPB",109,0)
 . S SEGMNT=$P(SEGMNT,HL("FS"),2,9999)
"RTN","RAHLTCPB",110,0)
 . Q:SEGMNT?@("1"""_HL("FS")_"""."""_HL("FS")_"""")  ;Quit if OBX is something as:    OBX||||||||
"RTN","RAHLTCPB",111,0)
 . I $P(SEGMNT,HL("FS"),3)']"" S RAERR="Missing Observation Identifier" Q
"RTN","RAHLTCPB",112,0)
 . S OBXTYP=$P($P(SEGMNT,HL("FS"),3),$E(HL("ECH"))),OBXTYP=$E($P(OBXTYP,"&",2))
"RTN","RAHLTCPB",113,0)
 . S OBX2CE=""
"RTN","RAHLTCPB",114,0)
 . S:OBXTYP="" OBXTYP=" "
"RTN","RAHLTCPB",115,0)
 . I OBXTYP=" "&($P(SEGMNT,HL("FS"),2)="CE") D
"RTN","RAHLTCPB",116,0)
 . . I $P(SEGMNT,HL("FS"),5)=" " S OBXTYP="F" Q
"RTN","RAHLTCPB",117,0)
 . . S OBX2CE=1,OBXTYP="D" Q
"RTN","RAHLTCPB",118,0)
 . I "IDRF"'[OBXTYP S RAERR="Invalid Observation Identifier" Q
"RTN","RAHLTCPB",119,0)
 . D RPT Q
"RTN","RAHLTCPB",120,0)
XIT ; RACKYES  Indicates that Ack will be sent on the last OBR segment or at Error condition.
"RTN","RAHLTCPB",121,0)
 N RACKYES
"RTN","RAHLTCPB",122,0)
 I $D(RAERR) S RACKYES=1 D EN1^RAHLEXF,GENACK G XIT1
"RTN","RAHLTCPB",123,0)
 I $D(^TMP("RARPT-REC",$J)) S:'RACN RACKYES=1 D  G:$D(RAERR) XIT1
"RTN","RAHLTCPB",124,0)
 .N RACN D EN1^RAHLO I $D(RAERR) S RACKYES=1 D EN1^RAHLEXF,GENACK
"RTN","RAHLTCPB",125,0)
 F II=1:1:RACN S RARRR="RARPT-REC-"_II D:$D(^TMP(RARRR,$J))  Q:$D(RAERR)
"RTN","RAHLTCPB",126,0)
 .K ^TMP("RARPT-REC",$J) M ^TMP("RARPT-REC",$J)=^TMP(RARRR,$J) K ^TMP(RARRR,$J)
"RTN","RAHLTCPB",127,0)
 .S RACKYES=(II=RACN) N II,RACN D EN1^RAHLO I $D(RAERR) S RACKYES=1 D EN1^RAHLEXF,GENACK
"RTN","RAHLTCPB",128,0)
XIT1 K ^TMP("RARPT-REC",$J) ; kill storage area for current HL7 message id
"RTN","RAHLTCPB",129,0)
 F II=1:1:RACN S RARRR="RARPT-REC-"_II K:$D(^TMP(RARRR,$J)) ^TMP(RARRR,$J)
"RTN","RAHLTCPB",130,0)
 K ^TMP("RARPT-HL7",$J) ; clean up HL7 storage
"RTN","RAHLTCPB",131,0)
 K CNT,OBXTYP,X1,LIN,RADATE,RADTCN,RAERR,RAESIG,RAHLD,RAHLTCPB,RANODE,RARCNT
"RTN","RAHLTCPB",132,0)
 K RAVERF,RASUB,SEGMNT,RANOSEND,MSA1,OBX2CE,RADX,RADX1,RADX2,RADX3
"RTN","RAHLTCPB",133,0)
 Q
"RTN","RAHLTCPB",134,0)
RPT ; Save off Report Text data.
"RTN","RAHLTCPB",135,0)
 N RAXADEDN
"RTN","RAHLTCPB",136,0)
 S RAXADEDN=^TMP("RARPT-REC",$J,RASUB,"RASTAT")
"RTN","RAHLTCPB",137,0)
 S RANODE=$S(OBXTYP="D":"RADX",OBXTYP="I":"RAIMP",1:"RATXT"),LIN=""
"RTN","RAHLTCPB",138,0)
 I OBX2CE D  Q
"RTN","RAHLTCPB",139,0)
 . S X=$P(SEGMNT,HL("FS"),5),RADX1=$P(X,$E(HL("ECH")))
"RTN","RAHLTCPB",140,0)
 . S LIN=RADX1,L=999 D P2 S LIN=X
"RTN","RAHLTCPB",141,0)
 . Q:X'["~"  F J=0:0 S J=$O(^TMP("RARPT-HL7",$J,CNT,J)) Q:'J  S X1=^(J),LIN=LIN_X1 Q
"RTN","RAHLTCPB",142,0)
 . S RADX=LIN,RADX2=$P($P(RADX,"~",2),"^") S:RADX2]"" LIN=RADX2 D P2
"RTN","RAHLTCPB",143,0)
 . S RADX3=$P($P(RADX,"~",3),"^") Q:RADX3']""  S LIN=RADX3 D P2 Q
"RTN","RAHLTCPB",144,0)
 S X=$P(SEGMNT,HL("FS"),5)
"RTN","RAHLTCPB",145,0)
 I X["\S\"!(X["\R\")!(X["\E\")!(X["\T\") D FORMAT
"RTN","RAHLTCPB",146,0)
 I $G(RATELE),$D(RATELEKN),X[RATELEKN S X=$P(X,RATELEKN,2),RATELENM=$P(X,"-"),RATELEPI=$TR($P(X,"-",2)," ","") ;SFVAMC/DAD/9-7-2007/Comment out the quit Q  ;Patch 84
"RTN","RAHLTCPB",147,0)
 D PAR
"RTN","RAHLTCPB",148,0)
 F J=0:0 S J=$O(^TMP("RARPT-HL7",$J,CNT,J)) Q:'J  S X1=^(J),X=$E(X1,1,125) D PAR I $L(X1)>125 S X=$E(X1,126,999) D PAR
"RTN","RAHLTCPB",149,0)
 I X=""!(LIN'="") S L=999 D P2
"RTN","RAHLTCPB",150,0)
 Q
"RTN","RAHLTCPB",151,0)
 ;
"RTN","RAHLTCPB",152,0)
PAR ; Build text paragraph
"RTN","RAHLTCPB",153,0)
 S LIN=LIN_X
"RTN","RAHLTCPB",154,0)
P1 I $L(LIN)<80 Q
"RTN","RAHLTCPB",155,0)
 F L=80:-1:1 Q:$E(LIN,L)=" "
"RTN","RAHLTCPB",156,0)
 D P2 S LIN=$E(LIN,L+1,999) G P1
"RTN","RAHLTCPB",157,0)
P2 ; Set node
"RTN","RAHLTCPB",158,0)
 ; If Addendum and Report text is a space don't process
"RTN","RAHLTCPB",159,0)
 I $P(SEGMNT,HL("FS"),1)=1,RAXADEDN="A",RANODE="RATXT",$E(LIN,1,L-1)=" " Q
"RTN","RAHLTCPB",160,0)
 S RARCNT(OBXTYP)=$G(RARCNT(OBXTYP))+1
"RTN","RAHLTCPB",161,0)
 S ^TMP("RARPT-REC",$J,RASUB,RANODE,RARCNT(OBXTYP))=$E(LIN,1,L-1)
"RTN","RAHLTCPB",162,0)
 F I=1:1:RACN S RARRR="RARPT-REC-"_I S:$D(^TMP(RARRR,$J)) ^TMP(RARRR,$J,RASUB,RANODE,RARCNT(OBXTYP))=$E(LIN,1,L-1)
"RTN","RAHLTCPB",163,0)
 Q
"RTN","RAHLTCPB",164,0)
 ;
"RTN","RAHLTCPB",165,0)
GENACK ; Compile the 'ACK' segment, generate the 'ACK' message.
"RTN","RAHLTCPB",166,0)
 Q:'$G(RACKYES)
"RTN","RAHLTCPB",167,0)
 S MSA1="AA"
"RTN","RAHLTCPB",168,0)
 Q:$E($G(HL("SAN")),1,3)'="RA-"  ; Don't allow non RA namespaced interfaces
"RTN","RAHLTCPB",169,0)
 I $D(RAERR) S MSA1=$S($G(HL("SAN"))="RA-PSCRIBE-TCP"!$G(RATELE):"AE",1:"AR")
"RTN","RAHLTCPB",170,0)
 ; Added next line to support MedSpeak interface.  Must re-initialize
"RTN","RAHLTCPB",171,0)
 ; FS and EC's before sending ACK.
"RTN","RAHLTCPB",172,0)
 D:$G(HL("SAN"))="RA-CLIENT-TCP" INIT^HLFNC2("RA VOICE TCP SERVER RPT",.HL)
"RTN","RAHLTCPB",173,0)
 S HLA("HLA",1)="MSA"_HL("FS")_MSA1_HL("FS")_HL("MID")_$S($D(RAERR):HL("FS")_RAERR,1:"")
"RTN","RAHLTCPB",174,0)
 ; 06/22/2006 KAM CHANGED NEXT TWO LINES FOR RA*5*71
"RTN","RAHLTCPB",175,0)
 S HLEID=HL("EID"),HLEIDS=HL("EIDS"),HLARYTYP="LM",HLFORMAT=1
"RTN","RAHLTCPB",176,0)
 K HLRESLT D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,HLARYTYP,HLFORMAT)
"RTN","RAHLTCPB",177,0)
 Q
"RTN","RAHLTCPB",178,0)
 ;
"RTN","RAHLTCPB",179,0)
FORMAT ; Format report text for Escape Character delimited codes.
"RTN","RAHLTCPB",180,0)
 S Y=X N T,Q
"RTN","RAHLTCPB",181,0)
 I Y["\S\" S Q=$F(Y,"\S\"),T=Q-4,X=$E(Y,1,T)_$E(HL("ECH"))_$E(Y,Q,$L(X)),Y=X
"RTN","RAHLTCPB",182,0)
 I Y["\R\" S Q=$F(Y,"\R\"),T=Q-4,X=$E(Y,1,T)_$E(HL("ECH"),2)_$E(Y,Q,$L(X)),Y=X
"RTN","RAHLTCPB",183,0)
 I Y["\E\" S Q=$F(Y,"\E\"),T=Q-4,X=$E(Y,1,T)_$E(HL("ECH"),3)_$E(Y,Q,$L(X)),Y=X
"RTN","RAHLTCPB",184,0)
 I Y["\T\" S Q=$F(Y,"\T\"),T=Q-4,X=$E(Y,1,T)_$E(HL("ECH"),4)_$E(Y,Q,$L(X)),Y=X
"RTN","RAHLTCPB",185,0)
 I X["\S\"!(X["\R\")!(X["\E\")!(X["\T\") D FORMAT
"RTN","RAHLTCPB",186,0)
 Q
"RTN","RAHLTCPB",187,0)
 ;
"RTN","RAHLTCPU")
0^20^B2063802^n/a
"RTN","RAHLTCPU",1,0)
RAHLTCPU ; HIRMFO/GJC - Rad/Nuc Med HL7 TCP/IP Bridge utilities;10/10/07
"RTN","RAHLTCPU",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**84**;Mar 16, 1998;Build 13
"RTN","RAHLTCPU",3,0)
 ;
"RTN","RAHLTCPU",4,0)
LOCKX(RAERR,UNLOCK) ;lock/unlock the Rad/Nuc Med Patient record at one of two levels:
"RTN","RAHLTCPU",5,0)
 ;If part of a printset (RAY3(25)=2) lock at the "DT" level
"RTN","RAHLTCPU",6,0)
 ;Else lock at the "P" or case level
"RTN","RAHLTCPU",7,0)
 ;Input: RADFN, RADTI, & RACNI are all assumed to be defined.
"RTN","RAHLTCPU",8,0)
 ;       UNLOCK: if defined the function unlocks the encounter at the appropriate level
"RTN","RAHLTCPU",9,0)
 ;Returns: RAERR (lock attempt only) if $D(RAERR)#2 lock failed, else lock successful
"RTN","RAHLTCPU",10,0)
 N RANODE,RAY3 S RAY3=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),RAY3(25)=$P(RAY3,U,25)
"RTN","RAHLTCPU",11,0)
 S RANODE=$S(RAY3(25)=2:$NA(^RADPT(RADFN,"DT",RADTI)),1:$NA(^RADPT(RADFN,"DT",RADTI,"P",RACNI)))
"RTN","RAHLTCPU",12,0)
 I $G(UNLOCK)=1 L -@RANODE Q
"RTN","RAHLTCPU",13,0)
 L +@RANODE:DILOCKTM E  S RAERR=$S(RAY3(25)=2:"Encounter",1:"Accession")_" locked within VistA"
"RTN","RAHLTCPU",14,0)
 Q
"RTN","RAHLTCPU",15,0)
 ;
"RTN","RAHLTCPU",16,0)
LOCKR(RAERR,UNLOCK) ;lock/unlock the report associated with an exam record/
"RTN","RAHLTCPU",17,0)
 ;Input: RADFN, RADTI, & RACNI are all assumed to be defined.
"RTN","RAHLTCPU",18,0)
 ;       UNLOCK: if defined the function unlocks the report lock
"RTN","RAHLTCPU",19,0)
 ;Returns: RAERR (lock attempt only) if $D(RAERR)#2 lock failed, else lock successful
"RTN","RAHLTCPU",20,0)
 N RANODE,RAY3 S RAY3=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),RAY3(17)=$P(RAY3,U,17)
"RTN","RAHLTCPU",21,0)
 Q:RAY3(17)=""  S RANODE=$NA(^RARPT(RAY3(17)))
"RTN","RAHLTCPU",22,0)
 I $G(UNLOCK)=1 L -@RANODE Q
"RTN","RAHLTCPU",23,0)
 L +@RANODE:DILOCKTM E  S RAERR="The report has been locked within VistA"
"RTN","RAHLTCPU",24,0)
 Q
"RTN","RAHLTCPU",25,0)
 ;
"RTN","RARTR0")
0^16^B48053293^B38118603
"RTN","RARTR0",1,0)
RARTR0 ;HISC/GJC-Queue/Print Radiology Rpts utility routine. ;1/8/97  08:07
"RTN","RARTR0",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**8,26,74,84**;Mar 16, 1998;Build 13
"RTN","RARTR0",3,0)
 ; 06/28/2006 BAY/KAM Remedy Call 146291 - Change Patient Age to DOB
"RTN","RARTR0",4,0)
 ;
"RTN","RARTR0",5,0)
 ;Integration Agreements
"RTN","RARTR0",6,0)
 ;----------------------
"RTN","RARTR0",7,0)
 ;DT^DILF(2054); GETS^DIQ(2056); $$FMTE^XLFDT(10103); $$UP^XLFSTR(10104)
"RTN","RARTR0",8,0)
 ;NEW PERSON file read w/FM (10060)
"RTN","RARTR0",9,0)
 ;
"RTN","RARTR0",10,0)
EN1 ; Called from RARTR ;P84 GETS^DIQ added... 
"RTN","RARTR0",11,0)
 S RARPT(0)=$G(^RARPT(+$G(RARPT),0)) Q:RARPT(0)']""
"RTN","RARTR0",12,0)
 S RARPT(10)=$P(RARPT(0),"^",10)
"RTN","RARTR0",13,0)
 S RAVERF=+$P(RARPT(0),U,9),RAPVERF=+$P(RARPT(0),U,13)
"RTN","RARTR0",14,0)
 K RAPIR,RAPIS S RAPIR=+$P(RALB,"^",12),RAPIS=+$P(RALB,"^",15)
"RTN","RARTR0",15,0)
 ;format of the RAPIR/RAPIS arrays: P84 logic
"RTN","RARTR0",16,0)
 ;RAPI*=IEN file 200
"RTN","RARTR0",17,0)
 ;RAPI*(200,RAPI*,.01)= NAME (required)
"RTN","RARTR0",18,0)
 ;RAPI*(200,RAPI*,20.2) = SIGNATURE BLOCK PRINTED NAME (if any)
"RTN","RARTR0",19,0)
 ;RAPI*(200,RAPI*,20.3) = SIGNATURE BLOCK TITLE (if any)
"RTN","RARTR0",20,0)
 I RAPIR D GETS^DIQ(200,RAPIR,".01;20.2;20.3","","RAPIR") S RAPIR("IENS")=RAPIR_","
"RTN","RARTR0",21,0)
 I RAPIS D GETS^DIQ(200,RAPIS,".01;20.2;20.3","","RAPIS") S RAPIS("IENS")=RAPIS_","
"RTN","RARTR0",22,0)
 S RAWHOVER=+$P(RARPT(0),"^",17)
"RTN","RARTR0",23,0)
 I RAVERF,((RAPIR=RAVERF)!(RAPIS=RAVERF)) D
"RTN","RARTR0",24,0)
 . S RAVERFND="" ; Set verifier found flag
"RTN","RARTR0",25,0)
 . Q
"RTN","RARTR0",26,0)
 I RAPIS D  Q:$D(RAOOUT)
"RTN","RARTR0",27,0)
 . ;get signature block name if defined
"RTN","RARTR0",28,0)
 . S RALBS=$E(RAPIS(200,RAPIS("IENS"),20.2),1,25)
"RTN","RARTR0",29,0)
 . S:RALBS="" RALBS=$E(RAPIS(200,RAPIS("IENS"),.01),1,25) ;default to NAME
"RTN","RARTR0",30,0)
 . ;
"RTN","RARTR0",31,0)
 . ;get signature block title if defined
"RTN","RARTR0",32,0)
 . S RALBST=$G(RAPIS(200,RAPIS("IENS"),20.3)) ; max: 50 chars
"RTN","RARTR0",33,0)
 . S:RALBST="" RALBST=$$TITLE^RARTR0(RAPIS)
"RTN","RARTR0",34,0)
 . ;
"RTN","RARTR0",35,0)
 . I '$D(RAUTOE) D:($Y+RAFOOT+4)>IOSL HANG^RARTR2 Q:$D(RAOOUT)
"RTN","RARTR0",36,0)
 . I '$D(RAUTOE) D HD^RARTR:($Y+RAFOOT+4)>IOSL
"RTN","RARTR0",37,0)
 . I '$D(RAUTOE) D
"RTN","RARTR0",38,0)
 .. W !,"Primary Interpreting Staff:",!?2,$S(RALBS]"":RALBS,1:"Unknown")
"RTN","RARTR0",39,0)
 .. W:$L(RALBST) ", "_$E(RALBST,1,((IOM-$X)-16))
"RTN","RARTR0",40,0)
 .. ; The '-16' above is derived from $L("(Pre-Verifier)")+1 FORMATTING
"RTN","RARTR0",41,0)
 .. Q
"RTN","RARTR0",42,0)
 . E  D
"RTN","RARTR0",43,0)
 .. S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="Primary Interpreting Staff:"
"RTN","RARTR0",44,0)
 .. S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="  "_$S(RALBS]"":RALBS,1:"Unknown")
"RTN","RARTR0",45,0)
 .. Q:'$L(RALBST)  N RALEN S RALEN=$L(^TMP($J,"RA AUTOE",RAACNT))
"RTN","RARTR0",46,0)
 .. S ^TMP($J,"RA AUTOE",RAACNT)=^TMP($J,"RA AUTOE",RAACNT)_", "_$E(RALBST,1,((80-RALEN)-16))
"RTN","RARTR0",47,0)
 .. Q
"RTN","RARTR0",48,0)
 . I $D(RAVERFND)&(RAPIS=RAVERF),(RAPIS(200,RAPIS("IENS"),.01)'="RADIOLOGY,OUTSIDE SERVICE") D
"RTN","RARTR0",49,0)
 .. I $G(RARPT(10))']"",('$D(RAUTOE)) D  Q
"RTN","RARTR0",50,0)
 ... W:RAWHOVER=RAPIS !?10,"(Verifier, no e-sig)"
"RTN","RARTR0",51,0)
 ... W:RAWHOVER'=RAPIS !?10,"Verified by transcriptionist for "_RALBS  ;Removed RA*5*8 _", M.D."
"RTN","RARTR0",52,0)
 ... Q
"RTN","RARTR0",53,0)
 .. I $G(RARPT(10))']"",($D(RAUTOE)) D  Q
"RTN","RARTR0",54,0)
 ... S:RAWHOVER=RAPIS ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="          (Verifier, no e-sig)"
"RTN","RARTR0",55,0)
 ... S:RAWHOVER'=RAPIS ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="          Verified by transcriptionist for "_RALBS  ;Removed RA*5*8 _", M.D."
"RTN","RARTR0",56,0)
 ... Q
"RTN","RARTR0",57,0)
 .. W:'$D(RAUTOE) " (Verifier)"
"RTN","RARTR0",58,0)
 .. S:$D(RAUTOE) ^TMP($J,"RA AUTOE",RAACNT)=^TMP($J,"RA AUTOE",RAACNT)_" (Verifier)"
"RTN","RARTR0",59,0)
 .. Q
"RTN","RARTR0",60,0)
 . I RAPIS=RAPVERF,'$D(RAUTOE) W " (Pre-Verifier)"
"RTN","RARTR0",61,0)
 . I RAPIS=RAPVERF,$D(RAUTOE) S ^TMP($J,"RA AUTOE",RAACNT)=^TMP($J,"RA AUTOE",RAACNT)_" (Pre-Verifier)"
"RTN","RARTR0",62,0)
 . Q
"RTN","RARTR0",63,0)
 D SECSTF^RARTR1 Q:$D(RAOOUT)  ; Print secondary interp'ting staff now
"RTN","RARTR0",64,0)
 ;now for primary resident definitions...
"RTN","RARTR0",65,0)
 I RAPIR D  Q:$D(RAOOUT)
"RTN","RARTR0",66,0)
 . ;get signature block name if defined
"RTN","RARTR0",67,0)
 . S RALBR=$E(RAPIR(200,RAPIR("IENS"),20.2),1,25)
"RTN","RARTR0",68,0)
 . S:RALBR="" RALBR=$E(RAPIR(200,RAPIR("IENS"),.01),1,25) ;default to NAME
"RTN","RARTR0",69,0)
 . ;
"RTN","RARTR0",70,0)
 . ;get signature block title if defined
"RTN","RARTR0",71,0)
 . S RALBRT=$G(RAPIR(200,RAPIR("IENS"),20.3)) ; max: 50 chars
"RTN","RARTR0",72,0)
 . S:RALBRT="" RALBRT=$$TITLE^RARTR0(RAPIR)
"RTN","RARTR0",73,0)
 . ;
"RTN","RARTR0",74,0)
 . I '$D(RAUTOE) D:($Y+RAFOOT+4)>IOSL HANG^RARTR2 Q:$D(RAOOUT)
"RTN","RARTR0",75,0)
 . I '$D(RAUTOE) D HD^RARTR:($Y+RAFOOT+4)>IOSL
"RTN","RARTR0",76,0)
 . I '$D(RAUTOE) D
"RTN","RARTR0",77,0)
 .. W !,"Primary Interpreting Resident:",!?2,$S(RALBR]"":RALBR,1:"Unknown")
"RTN","RARTR0",78,0)
 .. W:$L(RALBRT) ", "_$E(RALBRT,1,((IOM-$X)-16))
"RTN","RARTR0",79,0)
 .. Q
"RTN","RARTR0",80,0)
 . I $D(RAUTOE) D
"RTN","RARTR0",81,0)
 .. S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="Primary Interpreting Resident:"
"RTN","RARTR0",82,0)
 .. S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="  "_$S(RALBR]"":RALBR,1:"Unknown")
"RTN","RARTR0",83,0)
 .. Q:'$L(RALBRT)  N RALEN S RALEN=$L(^TMP($J,"RA AUTOE",RAACNT))
"RTN","RARTR0",84,0)
 .. S ^TMP($J,"RA AUTOE",RAACNT)=^TMP($J,"RA AUTOE",RAACNT)_", "_$E(RALBRT,1,((80-RALEN)-16))
"RTN","RARTR0",85,0)
 .. Q
"RTN","RARTR0",86,0)
 . I $D(RAVERFND)&(RAPIR=RAVERF) D
"RTN","RARTR0",87,0)
 .. I $G(RARPT(10))']"",('$D(RAUTOE)) D  Q
"RTN","RARTR0",88,0)
 ... W:RAWHOVER=RAPIR !?10,"(Verifier, no e-sig)"
"RTN","RARTR0",89,0)
 ... W:RAWHOVER'=RAPIR !?10,"Verified by transcriptionist for "_RALBR  ;Removed RA*5*8 _", M.D."
"RTN","RARTR0",90,0)
 ... Q
"RTN","RARTR0",91,0)
 .. I $G(RARPT(10))']"",($D(RAUTOE)) D  Q
"RTN","RARTR0",92,0)
 ... S:RAWHOVER=RAPIR ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="          (Verifier, no e-sig)"
"RTN","RARTR0",93,0)
 ... S:RAWHOVER'=RAPIR ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="          Verified by transcriptionist for "_RALBR  ;Removed RA*5*8 _", M.D."
"RTN","RARTR0",94,0)
 ... Q
"RTN","RARTR0",95,0)
 .. W:'$D(RAUTOE) " (Verifier)"
"RTN","RARTR0",96,0)
 .. S:$D(RAUTOE) ^TMP($J,"RA AUTOE",RAACNT)=^TMP($J,"RA AUTOE",RAACNT)_" (Verifier)"
"RTN","RARTR0",97,0)
 .. Q
"RTN","RARTR0",98,0)
 . I RAPIR=RAPVERF,('$D(RAUTOE)) W " (Pre-Verifier)"
"RTN","RARTR0",99,0)
 . I RAPIR=RAPVERF,($D(RAUTOE)) S ^TMP($J,"RA AUTOE",RAACNT)=^TMP($J,"RA AUTOE",RAACNT)_" (Pre-Verifier)"
"RTN","RARTR0",100,0)
 . Q
"RTN","RARTR0",101,0)
 D SECRES^RARTR1 ; Print out secondary interp'ting resident now
"RTN","RARTR0",102,0)
 K RAPIR,RAPIS ;P84 kills added
"RTN","RARTR0",103,0)
 Q
"RTN","RARTR0",104,0)
 ;
"RTN","RARTR0",105,0)
TITLE(X) ;Return the radiology classification in lieu of the signature block title
"RTN","RARTR0",106,0)
 ; 'X' is the IEN of the Primary Interpreting Resident i.e, ^DD(70.03,12
"RTN","RARTR0",107,0)
 ; -OR-
"RTN","RARTR0",108,0)
 ; 'X' is the IEN of the Primary Interpreting Staff i.e, ^DD(70.03,15
"RTN","RARTR0",109,0)
 Q $S($D(^VA(200,"ARC","R",X)):"Resident Physician",$D(^VA(200,"ARC","S",X)):"Staff Physician",1:"")
"RTN","RARTR0",110,0)
 ; 
"RTN","RARTR0",111,0)
HEAD ; Set up header info for e-mail message (called from INIT^RARTR)
"RTN","RARTR0",112,0)
 ; 06/28/2006 BAY/KAM Remedy Call 146291 Change Patient Age to DOB
"RTN","RARTR0",113,0)
 N RAGE,RATPHY,RACSE,RAILOC,RANME,RAPRIPHY,RAPTLOC,RAREQPHY,RASERV,RASEX,RADOB
"RTN","RARTR0",114,0)
 N RASPACE,RASSN,X1,X2 S:'$D(RAACNT) RAACNT=0
"RTN","RARTR0",115,0)
 ;Added next line for Remedy Call 146291
"RTN","RARTR0",116,0)
 D DT^DILF("E",$P(RAY0,"^",3),.RADOB) ;Get Date of Birth/External Fmt
"RTN","RARTR0",117,0)
 ;
"RTN","RARTR0",118,0)
 S RANME=$P(RAY0,"^"),RASSN=$P(RAY0,"^",9)
"RTN","RARTR0",119,0)
 S RASEX=$$UP^XLFSTR($P(RAY0,"^",2))
"RTN","RARTR0",120,0)
 S RACSE=$P($G(^RARPT(RARPT,0)),"^")_"@"_$P($$FMTE^XLFDT($P(RAY2,"^")),"@",2)
"RTN","RARTR0",121,0)
 ; Remedy Call 146291 Removed line calculating age
"RTN","RARTR0",122,0)
 S RAREQPHY=$$XTERNAL^RAUTL5($P(RAY3,"^",14),$P($G(^DD(70.03,14,0)),"^",2))
"RTN","RARTR0",123,0)
 S RAPTLOC=$$PTLOC^RAUTL12() S:RAREQPHY']"" RAREQPHY="Unknown"
"RTN","RARTR0",124,0)
 S RASERV=$$XTERNAL^RAUTL5($P(RAY3,"^",7),$P($G(^DD(70.03,7,0)),"^",2))
"RTN","RARTR0",125,0)
 S RATPHY=$$ATND^RAUTL5(RADFN,DT),RAPRIPHY=$$PRIM^RAUTL5(RADFN,DT)
"RTN","RARTR0",126,0)
 S RAILOC=$$XTERNAL^RAUTL5($P(RAY2,"^",4),$P($G(^DD(70.02,4,0)),"^",2))
"RTN","RARTR0",127,0)
 S:RAILOC']"" RAILOC="Unknown" S:RASERV']"" RASERV="Unknown"
"RTN","RARTR0",128,0)
 S RANME=$E(RANME,1,20)_"  "
"RTN","RARTR0",129,0)
 S RASSN=$E(RASSN,1,3)_"-"_$E(RASSN,4,5)_"-"_$E(RASSN,6,9)_"    "
"RTN","RARTR0",130,0)
 ; Remedy Call 146291 Changed next line to use RADOB(0)
"RTN","RARTR0",131,0)
 S RAGE="DOB-"_RADOB(0)_" "_$S(RASEX="F":"F",RASEX="M":"M",1:"UNK")
"RTN","RARTR0",132,0)
 S $P(RASPACE," ",(22-$L(RAGE)))=""
"RTN","RARTR0",133,0)
 S RAGE=RAGE_RASPACE,RACSE="Case: "_RACSE
"RTN","RARTR0",134,0)
 S RAREQPHY="Req Phys: "_$E(RAREQPHY,1,28)
"RTN","RARTR0",135,0)
 S RASPACE="",$P(RASPACE," ",(42-$L(RAREQPHY)))=""
"RTN","RARTR0",136,0)
 S RAREQPHY=RAREQPHY_RASPACE
"RTN","RARTR0",137,0)
 S RAPTLOC="Pat Loc: "_$S(RAPTLOC]"":$E(RAPTLOC,1,30),1:"Unknown")
"RTN","RARTR0",138,0)
 S RATPHY="Att Phys: "_$E(RATPHY,1,28)
"RTN","RARTR0",139,0)
 S RASPACE="",$P(RASPACE," ",(42-$L(RATPHY)))=""
"RTN","RARTR0",140,0)
 S RATPHY=RATPHY_RASPACE
"RTN","RARTR0",141,0)
 S RAILOC="Img Loc: "_$E(RAILOC,1,30)
"RTN","RARTR0",142,0)
 S RAPRIPHY="Pri Phys: "_$E(RAPRIPHY,1,28)
"RTN","RARTR0",143,0)
 S RASPACE="",$P(RASPACE," ",(42-$L(RAPRIPHY)))=""
"RTN","RARTR0",144,0)
 S RAPRIPHY=RAPRIPHY_RASPACE
"RTN","RARTR0",145,0)
 S RASERV="Service: "_$E(RASERV,1,30)
"RTN","RARTR0",146,0)
 S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))=RANME_RASSN_RAGE_RACSE
"RTN","RARTR0",147,0)
 S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))=RAREQPHY_RAPTLOC
"RTN","RARTR0",148,0)
 S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))=RATPHY_RAILOC
"RTN","RARTR0",149,0)
 S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))=RAPRIPHY_RASERV
"RTN","RARTR0",150,0)
 S:$D(RAERRFLG) ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))="         "_$$AMENRPT^RARTR2()
"RTN","RARTR0",151,0)
 S ^TMP($J,"RA AUTOE",$$INCR^RAUTL4(RAACNT))=""
"RTN","RARTR0",152,0)
 Q
"RTN","RAUTL1")
0^24^B52485172^B44121957
"RTN","RAUTL1",1,0)
RAUTL1 ;HISC/CAH,FPT,GJC AISC/MJK,RMO-Utility Routine ;10/22/97  13:54
"RTN","RAUTL1",2,0)
 ;;5.0;Radiology/Nuclear Medicine;**5,9,18,71,82,81,84**;Mar 16, 1998;Build 13
"RTN","RAUTL1",3,0)
 ;last modification by SS for P18 June 19,00
"RTN","RAUTL1",4,0)
 ;02/10/2006 BAY/KAM RA*5*71 Add ability to update exam data to V/R
"RTN","RAUTL1",5,0)
 ;
"RTN","RAUTL1",6,0)
 ;Integration Agreements
"RTN","RAUTL1",7,0)
 ;----------------------
"RTN","RAUTL1",8,0)
 ;DIC(10006); DIE(10018); FILE^DIE(2053); UPDATE^DIE(2053); EN^ORB3(1362); NOTE^ORX3(868)
"RTN","RAUTL1",9,0)
 ;
"RTN","RAUTL1",10,0)
 I "IOSCR"'[X!(X="") S X="Unknown" Q
"RTN","RAUTL1",11,0)
 G @($E(X))
"RTN","RAUTL1",12,0)
 ;Set X=Inpatient Location
"RTN","RAUTL1",13,0)
I S X=$S($D(^DIC(42,+$P(^RADPT(D0,"DT",D1,"P",D2,0),"^",6),0)):$P(^(0),"^"),1:"Unknown")
"RTN","RAUTL1",14,0)
 Q
"RTN","RAUTL1",15,0)
 ;
"RTN","RAUTL1",16,0)
 ;Set X=Outpatient Location
"RTN","RAUTL1",17,0)
O S X=$S($D(^SC(+$P(^RADPT(D0,"DT",D1,"P",D2,0),"^",8),0)):$P(^(0),"^"),1:"Unknown")
"RTN","RAUTL1",18,0)
 Q
"RTN","RAUTL1",19,0)
 ;
"RTN","RAUTL1",20,0)
 ;Set X=Contract/Sharing Agreement patient location
"RTN","RAUTL1",21,0)
S ;
"RTN","RAUTL1",22,0)
C S X=$S($D(^DIC(34,+$P(^RADPT(D0,"DT",D1,"P",D2,0),"^",9),0)):$P(^(0),"^"),1:"Unknown")
"RTN","RAUTL1",23,0)
 Q
"RTN","RAUTL1",24,0)
 ;
"RTN","RAUTL1",25,0)
 ;Set X=Research patient location
"RTN","RAUTL1",26,0)
R S X=$S($D(^RADPT(D0,"DT",D1,"P",D2,"R")):$P(^("R"),"^"),1:"Unknown") Q
"RTN","RAUTL1",27,0)
 ;
"RTN","RAUTL1",28,0)
 ;Set X=time of day in external format (ex: 2:28 PM)
"RTN","RAUTL1",29,0)
NOW S %=$P($H,",",2),X=DT_(%\60#60/100+(%\3600)+(%#60/10000)/100) D TIME
"RTN","RAUTL1",30,0)
 Q
"RTN","RAUTL1",31,0)
 ;Input X=FM date/time, Output X=time (external format)
"RTN","RAUTL1",32,0)
TIME S X=$E($P(X,".",2)_"0000",1,4),%=X>1159 S:X>1259 X=X-1200 S X=X\100_":"_$E(X#100+100,2,3)_" "_$E("AP",%+1)_"M" S:$P(X,":")=0 X=12_":"_$P(X,":",2)
"RTN","RAUTL1",33,0)
 Q
"RTN","RAUTL1",34,0)
 ;
"RTN","RAUTL1",35,0)
ELAPSED ;Pass parameters X (from date) and X1 (to date)
"RTN","RAUTL1",36,0)
 ;Variable Y is returned as either an elapsed time in the form DD:HH:MM where DD=days, HH=hours, MM=minutes or as the string 'Neg. Time' indicating a negative elapsed time
"RTN","RAUTL1",37,0)
 ;Variable Y1 is returned as the # of minutes of elapsed time
"RTN","RAUTL1",38,0)
 I '$D(RAMTIME) S DIC="^DD(""FUNC"",",DIC(0)="FX",RAX=X,X="MINUTES" D ^DIC K DIC S X=RAX S:$D(^DD("FUNC",+Y,1)) RAMTIME=^(1) I '$D(RAMTIME) W $C(7),!!,"Can't continue --- No 'MINUTES' function found in File Manager" K Y,Y1 G Q
"RTN","RAUTL1",39,0)
 X RAMTIME S Y1=X I X<0 S Y="Neg. Time" G Q
"RTN","RAUTL1",40,0)
MINUTS S X(1)=X\1440,X=X-(1440*X(1)),X(2)=X\60,X(3)=X-(60*X(2)),Y=$E(100+X(1),2,3)_":"_$E(100+X(2),2,3)_":"_$E(100+X(3),2,3)
"RTN","RAUTL1",41,0)
Q K RAX,X Q
"RTN","RAUTL1",42,0)
 ;
"RTN","RAUTL1",43,0)
UPDATE ;Entry point for Update Rad/Nuc Med Exam Status option
"RTN","RAUTL1",44,0)
 I $O(RACCESS(DUZ,""))="" D SETVARS^RAPSET1(0)
"RTN","RAUTL1",45,0)
 I $G(RAIMGTY)="" D SETVARS^RAPSET1(1)
"RTN","RAUTL1",46,0)
 I $G(RAIMGTY)="" K XQUIT Q  ; didn't sign-on to an imaging location
"RTN","RAUTL1",47,0)
 D ^RACNLU G UPQ:"^"[X
"RTN","RAUTL1",48,0)
 I $D(^RA(72,"AA",RAIMGTY,9,+RAST)),'$D(^XUSEC("RA MGR",DUZ)) W !!?3,$C(7),"You do not have the appropriate access privileges to act on completed exams." G UPDATE
"RTN","RAUTL1",49,0)
 I $D(^RA(72,"AA",RAIMGTY,0,+RAST)) W !!?3,$C(7),"Exam has been 'cancelled' therefore the status cannot be changed." G UPDATE
"RTN","RAUTL1",50,0)
 ;D UP1 I RAOR>0 S DA(2)=RADFN,DA(1)=RADTI,DA=RACNI,DIE="^RADPT("_DA(2)_",""DT"","_DA(1)_",""P"",",DR="100///""NOW""",DR(2,70.07)="2///U;3////"_$S($G(RADUZ):RADUZ,1:DUZ) D ^DIE
"RTN","RAUTL1",51,0)
 D UP1 I RAOR>0 D
"RTN","RAUTL1",52,0)
 .L +^RADPT(RADFN,"DT",RADTI,"P",RACNI):$G(DILOCKTM,3)
"RTN","RAUTL1",53,0)
 .N RAIEN
"RTN","RAUTL1",54,0)
 .S RAIENS="+1,"_RACNI_","_RADTI_","_RADFN_","
"RTN","RAUTL1",55,0)
 .S RAFDA(70.07,RAIENS,.01)="NOW"
"RTN","RAUTL1",56,0)
 .K RAERR D UPDATE^DIE("E","RAFDA","RAIEN","RAERR")
"RTN","RAUTL1",57,0)
 .K RAFDA,RAIENS
"RTN","RAUTL1",58,0)
 .I $D(RAERR) S RAERR="Error in update of 70.07, .01 "_$G(RAERR("DIERR",1,"TEXT",1)) K RAERR("DIERR") L -^RADPT(RADFN,"DT",RADTI,"P",RACNI) K RAIEN Q
"RTN","RAUTL1",59,0)
 .S RAIENS=RAIEN(1)_","_RACNI_","_RADTI_","_RADFN_","
"RTN","RAUTL1",60,0)
 .S RAFDA(70.07,RAIENS,2)="U"
"RTN","RAUTL1",61,0)
 .S RAFDA(70.07,RAIENS,3)=$S($G(RADUZ):RADUZ,1:DUZ)
"RTN","RAUTL1",62,0)
 .D FILE^DIE(,"RAFDA","RAERR")
"RTN","RAUTL1",63,0)
 .L -^RADPT(RADFN,"DT",RADTI,"P",RACNI)
"RTN","RAUTL1",64,0)
 .I $D(RAERR) S RAERR="Error in update of 70.07, 2,3 "_$G(RAERR("DIERR",1,"TEXT",1)) K RAERR("DIERR")
"RTN","RAUTL1",65,0)
UPQ K RAFDA,RAIENS
"RTN","RAUTL1",66,0)
 K %,D,DA,DE,DIC,DIE,DQ,DR,I,J,POP,RACS,RAEND,RAF5,RAFL,RAFST,RAI,RAIX,RAJ1,RAORDIFN,RAPRIT,RAHEAD,RASN,RAOR,RASTI,RASSN,RADATE,RAST,RACN,RACNI,RADFN,RADTE,RADTI,RANME,RAPRC,RARPT,X,Y,Z,^TMP($J,"RAEX"),C,DIPGM Q
"RTN","RAUTL1",67,0)
 ;
"RTN","RAUTL1",68,0)
 ;Exam status updating and accompanying updates to status log, oe/rr
"RTN","RAUTL1",69,0)
UP1 N RA8,RAEXEDT S RA8=0 ;use this to flag when one alert has been sent
"RTN","RAUTL1",70,0)
 ;Line change for RA*5*82
"RTN","RAUTL1",71,0)
 S RAEXEDT=$$CMPAFTR^RAO7XX(1) ;P18 if procedure changed in RAEDCN or RAEDPT sends XX message to CPRS if needed
"RTN","RAUTL1",72,0)
 ; RA EDITCN and RA EDITPT should process this case only
"RTN","RAUTL1",73,0)
 I $D(RAOPT("EDITCN"))!($D(RAOPT("EDITPT"))) D UP2,UPK Q
"RTN","RAUTL1",74,0)
 ; see if this case belongs to a printset
"RTN","RAUTL1",75,0)
 N:'$D(RAPRTSET) RAPRTSET N:'$D(RAMEMARR) RAMEMARR
"RTN","RAUTL1",76,0)
 D EN2^RAUTL20(.RAMEMARR) ;043099 always recalculate RAPRTSET
"RTN","RAUTL1",77,0)
 ; if not print set, then just process this case only
"RTN","RAUTL1",78,0)
 I 'RAPRTSET D UP2,UPK Q
"RTN","RAUTL1",79,0)
 ;case belongs to print set, so process all members of same print set
"RTN","RAUTL1",80,0)
 N RACNISAV,RA7
"RTN","RAUTL1",81,0)
 S RACNISAV=RACNI,RA7=0
"RTN","RAUTL1",82,0)
 F  S RA7=$O(RAMEMARR(RA7)) Q:RA7=""  S RACNI=RA7 D UP2
"RTN","RAUTL1",83,0)
 S RACNI=RACNISAV
"RTN","RAUTL1",84,0)
 G UPK
"RTN","RAUTL1",85,0)
UP2 ;Remedy Call 124379 Patch *71 BAY/KAM Added next line
"RTN","RAUTL1",86,0)
 ;Patch RA*5*82 next line commented out
"RTN","RAUTL1",87,0)
 ;D:$G(RAHLTCPB)'=1 EXM^RAHLRPC
"RTN","RAUTL1",88,0)
 ;
"RTN","RAUTL1",89,0)
 S DA(2)=RADFN,DA(1)=RADTI,DA=RACNI,DIE="^RADPT("_DA(2)_",""DT"","_DA(1)_",""P"","
"RTN","RAUTL1",90,0)
 N RAAFTER,RABEFORE
"RTN","RAUTL1",91,0)
 D STUFF^RASTREQ1 I RAOR<0,$D(RASN) W:'$D(RAONLINE)&('$D(ZTQUEUED)) !?5,"...exam status remains '",RASN,"'." K DIE,RACS,RAPRIT D  Q
"RTN","RAUTL1",92,0)
 .D:$G(RAEXEDT) EXM^RAHLRPC ; DO statement added by RA*5*82
"RTN","RAUTL1",93,0)
 W:'$D(RAONLINE)&('$D(ZTQUEUED)) !?3,"...will now designate exam status as '",RASN,"'... for case no. ",$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),U)
"RTN","RAUTL1",94,0)
 ; S DR="3////"_RASTI_$S($P(RAMDV,"^",10):";75///^S X=$$MIDNGHT^RAUTL5($$NOW^XLFDT())",1:"")
"RTN","RAUTL1",95,0)
 ; user duz could be in RADUZ, if session is from the Voice recognition
"RTN","RAUTL1",96,0)
 ;S DR(2,70.05)=$S($P(RAMDV,"^",11)&('$D(ZTQUEUED)):".01;",1:"")_"2////"_RASTI_";3////"_$S($G(RADUZ):RADUZ,1:DUZ)
"RTN","RAUTL1",97,0)
 ;D ^DIE
"RTN","RAUTL1",98,0)
 L +^RADPT(RADFN,"DT",RADTI,"P",RACNI):$G(DILOCKTM,3)
"RTN","RAUTL1",99,0)
 N RAIEN
"RTN","RAUTL1",100,0)
 S RAIENS=RACNI_","_RADTI_","_RADFN_","
"RTN","RAUTL1",101,0)
 S RAFDA(70.03,RAIENS,3)=RASTI
"RTN","RAUTL1",102,0)
 K RAERR D FILE^DIE(,"RAFDA","RAERR")
"RTN","RAUTL1",103,0)
 I $D(RAERR) S RAERR="Error in update of 70.03 "_$G(RAERR("DIERR",1,"TEXT",1)) K RAERR("DIERR") L -^RADPT(RADFN,"DT",RADTI,"P",RACNI) G UP2K ;L - P18
"RTN","RAUTL1",104,0)
 I $P(RAMDV,"^",10) D
"RTN","RAUTL1",105,0)
 .N RAERR2
"RTN","RAUTL1",106,0)
 .S RAIENS="+1,"_RACNI_","_RADTI_","_RADFN_","
"RTN","RAUTL1",107,0)
 .S RAFDA(70.05,RAIENS,.01)=$$MIDNGHT^RAUTL5($$NOW^XLFDT())
"RTN","RAUTL1",108,0)
 .D UPDATE^DIE(,"RAFDA","RAIEN","RAERR")
"RTN","RAUTL1",109,0)
 .K RAFDA,RAIENS
"RTN","RAUTL1",110,0)
 .I $D(RAERR) S RAERR="Error in update of 70.05, .01 "_$G(RAERR("DIERR",1,"TEXT",1)) K RAERR("DIERR")
"RTN","RAUTL1",111,0)
 .Q:'$D(RAIEN(1))
"RTN","RAUTL1",112,0)
 .I $P(RAMDV,"^",11),('$D(ZTQUEUED)) D
"RTN","RAUTL1",113,0)
 ..S DIE=DIE_RACNI_",""T"",",DA=RAIEN(1)
"RTN","RAUTL1",114,0)
 ..S DR=".01"
"RTN","RAUTL1",115,0)
 ..D ^DIE
"RTN","RAUTL1",116,0)
 .S RAIENS=RAIEN(1)_","_RACNI_","_RADTI_","_RADFN_","
"RTN","RAUTL1",117,0)
 .S RAFDA(70.05,RAIENS,2)=RASTI
"RTN","RAUTL1",118,0)
 .S RAFDA(70.05,RAIENS,3)=$S($G(RADUZ):RADUZ,1:DUZ)
"RTN","RAUTL1",119,0)
 .K RAERR2 D FILE^DIE(,"RAFDA","RAERR2")
"RTN","RAUTL1",120,0)
 .I $D(RAERR2) S RAERR2="Error in update of 70.05 2,3 "_$G(RAERR2("DIERR",1,"TEXT",1)),RAERR=$S($D(RAERR):RAERR_";"_RAERR2,1:RAERR2)
"RTN","RAUTL1",121,0)
 ;Patch RA*5*82 added next line send EXM message after status update, not before the update
"RTN","RAUTL1",122,0)
 D:'$D(RAERR) EXM^RAHLRPC
"RTN","RAUTL1",123,0)
 L -^RADPT(RADFN,"DT",RADTI,"P",RACNI)
"RTN","RAUTL1",124,0)
 ;
"RTN","RAUTL1",125,0)
UP2K K DE,DQ,DIE,DR,RAFDA,RAIENS K:$D(RAERR) RACS,RAPRIT Q:$D(RAERR)  W:'$D(RAONLINE)&('$D(ZTQUEUED)) !?10,"...exam status ",$S($G(RABEFORE)>$G(RAAFTER):"backed down",1:"successfully updated"),"." D ^RAORDC
"RTN","RAUTL1",126,0)
 I RA8=0,$D(^RA(72,RASTI,"ALERT")),$P(^("ALERT"),"^")="y" D:$$ORVR^RAORDU()=2.5 OERR D:$$ORVR^RAORDU()'<3 OERR3 S RA8=1
"RTN","RAUTL1",127,0)
 I $D(^RA(72,RASTI,0)),$P(^(0),"^",3)>1,RACS'="Y",$S('$D(RAF5):1,$P(^DIC(42,+RAF5,0),U,3)="D":1,1:0) D EN^RAUTL0
"RTN","RAUTL1",128,0)
 K RACS,RAORDIFN,RAPRIT,RAF5
"RTN","RAUTL1",129,0)
 Q
"RTN","RAUTL1",130,0)
UPK K ORIFN,ORVP,ORNOTE,ORBPMSG,RACS,RAORDIFN,RAPRIT,RAF5
"RTN","RAUTL1",131,0)
 Q
"RTN","RAUTL1",132,0)
OERR ;Send Alert to OERR after pt examined
"RTN","RAUTL1",133,0)
 S ORVP=RADFN_";DPT(",ORBPMSG="Rad Pt Examined - "_$S($D(^RAMIS(71,RAPRIT,0)):$E($P(^(0),"^"),1,24),1:"Unknown") S:$D(^RAO(75.1,+RAORDIFN,0)) ORIFN=+$P(^(0),"^",7) S ORNOTE(21)=$S($D(ORIFN):1,1:"") D NOTE^ORX3
"RTN","RAUTL1",134,0)
 Q
"RTN","RAUTL1",135,0)
OERR3 ; Send RADIOLOGY PATIENT EXAMINED notification via oe/rr v3
"RTN","RAUTL1",136,0)
 ; Called from UP1
"RTN","RAUTL1",137,0)
 ;
"RTN","RAUTL1",138,0)
 ; RADFN,RADTI,RACNI,RAPRIT must be defined
"RTN","RAUTL1",139,0)
 Q:'$D(RADFN)!('$D(RADTI))!('$D(RACNI))!('$D(RAPRIT))
"RTN","RAUTL1",140,0)
 ;
"RTN","RAUTL1",141,0)
 N RAIENS,RAMSG,RAOIFN,RAOSTS,RAONODE,RADPTNDE,RAREQPHY
"RTN","RAUTL1",142,0)
 S RADPTNDE=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0))
"RTN","RAUTL1",143,0)
 S RAOIFN=$P(RADPTNDE,U,11) Q:'RAOIFN  ;file 75.1 ien
"RTN","RAUTL1",144,0)
 S RAONODE=$G(^RAO(75.1,+RAOIFN,0))
"RTN","RAUTL1",145,0)
 S RAOSTS=$P(RAONODE,U,5) Q:RAOSTS'=6  ;active exams only
"RTN","RAUTL1",146,0)
 S RAOIFN=$P(RAONODE,U,7) ;file 100 ien
"RTN","RAUTL1",147,0)
 S RAREQPHY=+$P(RADPTNDE,U,14) ;ordering provider
"RTN","RAUTL1",148,0)
 S RAREQPHY(RAREQPHY)=""
"RTN","RAUTL1",149,0)
 S RAMSG="Imaging Pt Examined - "_$S($D(^RAMIS(71,RAPRIT,0)):$E($P(^(0),U),1,24),1:"Unknown"),RAMSG=$E(RAMSG,1,51)
"RTN","RAUTL1",150,0)
 S RAIENS=RADTI_"~"_RACNI
"RTN","RAUTL1",151,0)
 ;
"RTN","RAUTL1",152,0)
 ; oe parameters:
"RTN","RAUTL1",153,0)
 ;         ORN: notification id (#100.9 ien)
"RTN","RAUTL1",154,0)
 ;         |     ORBDFN: patient id (#2 ien)
"RTN","RAUTL1",155,0)
 ;         |     |     ORNUM: order number (#100 ien)
"RTN","RAUTL1",156,0)
 ;         |     |     |        ORBADUZ: recipient array
"RTN","RAUTL1",157,0)
 ;         |     |     |        |     ORBPMSG: message text
"RTN","RAUTL1",158,0)
 ;         |     |     |        |     |      ORBPDATA exam dt~case iens
"RTN","RAUTL1",159,0)
 ;         |     |     |        |     |      |
"RTN","RAUTL1",160,0)
 D EN^ORB3(21,RADFN,RAOIFN,.RAREQPHY,RAMSG,RAIENS)
"RTN","RAUTL1",161,0)
 Q
"RTN","RAUTL1",162,0)
 ;
"RTN","RAUTL1",163,0)
 ;Called by many report programs. Sets RACRT() array containing all
"RTN","RAUTL1",164,0)
 ;exam statuses that are to be included on the report.  RACRT is set
"RTN","RAUTL1",165,0)
 ;to the piece of the Exam Status File #72 record that corresponds
"RTN","RAUTL1",166,0)
 ;to the report being generated.
"RTN","RAUTL1",167,0)
CRIT F I=0:0 S I=$O(^RA(72,I)) Q:'I  I $D(^(I,.3)),$P(^(.3),"^",RACRT)="y" S RACRT(I)=""
"RTN","RAUTL1",168,0)
 Q
"VER")
8.0^22.0
"^DD",74,74,9.1,0)
TELERADIOLOGY PHYSICIAN NAME^FI^^TT;1^K:$L(X)>50!($L(X)<3) X
"^DD",74,74,9.1,3)
Enter the name of the teleradiologist that verified the report. The answer must be 3-50 characters in length.
"^DD",74,74,9.1,21,0)
^.001^2^2^3080430^^^
"^DD",74,74,9.1,21,1,0)
This field identifies the name of the teleradiologist who verified 
"^DD",74,74,9.1,21,2,0)
(signed) the report.
"^DD",74,74,9.1,23,0)
^.001^9^9^3080430^^
"^DD",74,74,9.1,23,1,0)
The name of the teleradiologist and their National Provider Identification
"^DD",74,74,9.1,23,2,0)
(NPI) are not manually entered.
"^DD",74,74,9.1,23,3,0)
 
"^DD",74,74,9.1,23,4,0)
The login to the ScImage application is our identity verification process.
"^DD",74,74,9.1,23,5,0)
Each of the individual physician's credentials, their name and their NPI,
"^DD",74,74,9.1,23,6,0)
are part of their ScImage user profile.
"^DD",74,74,9.1,23,7,0)
 
"^DD",74,74,9.1,23,8,0)
The TELERADIOLOGY PHYSICIAN NAME attribute is passed when reporting a
"^DD",74,74,9.1,23,9,0)
case.
"^DD",74,74,9.1,"DT")
3070913
"^DD",74,74,9.2,0)
TELERADIOLOGY PHYSICIAN NPI^FI^^TT;2^K:$L(X)>10!($L(X)<10) X
"^DD",74,74,9.2,3)
Enter the NPI of the teleradiologist who verified the report. The NPI is a ten digit number.
"^DD",74,74,9.2,21,0)
^.001^2^2^3080430^^^^
"^DD",74,74,9.2,21,1,0)
This field identified the National Provider ID (NPI) of the
"^DD",74,74,9.2,21,2,0)
teleradiologist who verified (signed) the report.
"^DD",74,74,9.2,23,0)
^^8^8^3080430^
"^DD",74,74,9.2,23,1,0)
The name of the teleradiologist and their National Provider Identification
"^DD",74,74,9.2,23,2,0)
(NPI) are not manually entered.
"^DD",74,74,9.2,23,3,0)
 
"^DD",74,74,9.2,23,4,0)
The login to the ScImage application is our identity verification process.
"^DD",74,74,9.2,23,5,0)
Each of the individual physician's credentials, their name and their NPI,
"^DD",74,74,9.2,23,6,0)
are part of their ScImage user profile.
"^DD",74,74,9.2,23,7,0)
 
"^DD",74,74,9.2,23,8,0)
The TELERADIOLOGY PHYSICIAN NPI attribute is passed when reporting a case.
"^DD",74,74,9.2,"DT")
3070913
"^DD",74,74,9.3,0)
REPORT VERIFIED BY COTS APP^P771'^HL(771,^TT;3^Q
"^DD",74,74,9.3,1,0)
^.1
"^DD",74,74,9.3,1,1,0)
74^AC
"^DD",74,74,9.3,1,1,1)
S ^RARPT("AC",$E(X,1,30),DA)=""
"^DD",74,74,9.3,1,1,2)
K ^RARPT("AC",$E(X,1,30),DA)
"^DD",74,74,9.3,1,1,"DT")
3070808
"^DD",74,74,9.3,3)
Enter the HL7 APPLICATION PARAMETER that identifies the COTS application used to dictate and verify this radiology report.
"^DD",74,74,9.3,21,0)
^^8^8^3070807^
"^DD",74,74,9.3,21,1,0)
This field identifies the Commercial Off the Shelf (COTS) application 
"^DD",74,74,9.3,21,2,0)
used to dictate and verify a radiology report. Examples of values for 
"^DD",74,74,9.3,21,3,0)
this field, though these need not be the only permissible values, are: 
"^DD",74,74,9.3,21,4,0)
RA-PSCRIBE-TCP, RA-SCIMAGE-TCP, and 
"^DD",74,74,9.3,21,5,0)
RA-TALKLINK-TCP.                           
"^DD",74,74,9.3,21,6,0)
 
"^DD",74,74,9.3,21,7,0)
If the report was dictated through the use of the VistA Radiology/Nuclear 
"^DD",74,74,9.3,21,8,0)
Medicine application the field will be null.
"^DD",74,74,9.3,"DT")
3080430
"^DD",79.7,79.7,0)
FIELD^^1.3^8
"^DD",79.7,79.7,0,"DDA")
N
"^DD",79.7,79.7,0,"DT")
3080102
"^DD",79.7,79.7,0,"IX","B",79.7,.01)

"^DD",79.7,79.7,0,"NM","RAD/NUC MED HL7 APPLICATION EXCEPTION")

"^DD",79.7,79.7,0,"VRPK")
RA
"^DD",79.7,79.7,.01,0)
HL7 APPLICATION NAME^R*P771'X^HL(771,^0;1^S DIC("S")="I $E(X,1,2)=""RA""" D ^DIC K DIC S DIC=$G(DIE),X=+Y K:Y<0 X S:$D(X) DINUM=X
"^DD",79.7,79.7,.01,1,0)
^.1
"^DD",79.7,79.7,.01,1,1,0)
79.7^B
"^DD",79.7,79.7,.01,1,1,1)
S ^RA(79.7,"B",$E(X,1,30),DA)=""
"^DD",79.7,79.7,.01,1,1,2)
K ^RA(79.7,"B",$E(X,1,30),DA)
"^DD",79.7,79.7,.01,3)
NAME MUST BE 3-30 CHARACTERS, NOT NUMERIC OR STARTING WITH PUNCTUATION
"^DD",79.7,79.7,.01,12)
VistA Radiology HL7 applications are the only HL7 applications selectable.
"^DD",79.7,79.7,.01,12.1)
S DIC("S")="I $E(X,1,2)=""RA"""
"^DD",79.7,79.7,.01,21,0)
^^3^3^3070418^
"^DD",79.7,79.7,.01,21,1,0)
This field allows the user to select a 'RA' namespaced HL7 APPLICATION 
"^DD",79.7,79.7,.01,21,2,0)
PARAMETER (#771) file record in which exceptions are defined that impact 
"^DD",79.7,79.7,.01,21,3,0)
HL7 message routing.
"^DD",79.7,79.7,.01,"DT")
3070403
"^DD",79.7,79.7,1,0)
TELERADIOLOGY APPLICATION^S^0:No;1:Yes;^0;2^Q
"^DD",79.7,79.7,1,3)
Type NO for local or YES for teleradiology (Default=NO).
"^DD",79.7,79.7,1,"DT")
3080102
"^DD",79.7,79.7,1.1,0)
TELERADIOLOGIST KEYWORD^F^^0;3^K:$L(X)>40!($L(X)<5) X
"^DD",79.7,79.7,1.1,3)
Answer must be 5-40 characters in length
"^DD",79.7,79.7,1.1,23,0)
^^4^4^3070731^
"^DD",79.7,79.7,1.1,23,1,0)
The text tag included in Report/Impression section of a dictated report 
"^DD",79.7,79.7,1.1,23,2,0)
that indicates that the teleradiologist name and NPI will follow. For 
"^DD",79.7,79.7,1.1,23,3,0)
example, using a tag of 'Report dictated by Teleradiologist:' as a tag:
"^DD",79.7,79.7,1.1,23,4,0)
Report dictated by Teleradiologist: Doe,John E-1234567891
"^DD",79.7,79.7,1.1,"DT")
3070731
"^DD",79.7,79.7,1.2,0)
RELEASE STUDY KEYWORD^F^^0;4^K:$L(X)>60!($L(X)<5) X
"^DD",79.7,79.7,1.2,3)
Answer must be 5-60 characters in length
"^DD",79.7,79.7,1.2,23,0)
^^4^4^3070731^
"^DD",79.7,79.7,1.2,23,1,0)
The text marker included in Report/Impression section of a dictated 
"^DD",79.7,79.7,1.2,23,2,0)
report that indicates that the study was released for local reading. 
"^DD",79.7,79.7,1.2,23,3,0)
For example, 'Released for local dictation by National Teleradiology'
"^DD",79.7,79.7,1.2,23,4,0)
might be an used as a marker.
"^DD",79.7,79.7,1.2,"DT")
3070731
"^DD",79.7,79.7,1.3,0)
APPLICATION TYPE^RS^O:Other;S:Speech Recognition;P:PACS;^0;5^Q
"^DD",79.7,79.7,1.3,23,0)
^^6^6^3080102^
"^DD",79.7,79.7,1.3,23,1,0)
Only unique single characters should be used as
"^DD",79.7,79.7,1.3,23,2,0)
internal values of this field.
"^DD",79.7,79.7,1.3,23,3,0)
 
"^DD",79.7,79.7,1.3,23,4,0)
Currently, only the 'S:Speech Recognition' value is 
"^DD",79.7,79.7,1.3,23,5,0)
used (to exclude speech recognition workstations from 
"^DD",79.7,79.7,1.3,23,6,0)
some HL7 transmissions).
"^DD",79.7,79.7,1.3,"DT")
3080102
"^DD",79.7,79.7,2,0)
MESSAGE TYPE^79.72P^^1;0
"^DD",79.7,79.7,2,21,0)
^.001^2^2^3070419^^
"^DD",79.7,79.7,2,21,1,0)
This field identifies the HL7 message type. This field is a pointer
"^DD",79.7,79.7,2,21,2,0)
to HL7 MESSAGE TYPE (#771.2) file.
"^DD",79.7,79.7,2,"DT")
3070419
"^DD",79.7,79.7,2.1,0)
DEFAULT DX FOR 'R' REPORT^*P78.3'^RA(78.3,^2;1^S DIC("S")="I +Y'<2000" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",79.7,79.7,2.1,3)
Enter the appropriate diagnostic code associated with a released/not verified teleradiology report.
"^DD",79.7,79.7,2.1,12)
Internal Entry Numbers (IEN) for diagnostic code related to the National Teleradiology initiative assume IEN values of two thousand or greater.
"^DD",79.7,79.7,2.1,12.1)
S DIC("S")="I +Y'<2000"
"^DD",79.7,79.7,2.1,21,0)
^.001^5^5^3070907^^
"^DD",79.7,79.7,2.1,21,1,0)
This field identifies the diagnostic code associated with a released/not 
"^DD",79.7,79.7,2.1,21,2,0)
verified teleradiology report.
"^DD",79.7,79.7,2.1,21,3,0)
 
"^DD",79.7,79.7,2.1,21,4,0)
A released/not verified teleradiology report indicates that the report is
"^DD",79.7,79.7,2.1,21,5,0)
being locked by a teleradiologist at the National Teleradiology Center.
"^DD",79.7,79.7,2.1,"DT")
3070907
"^DD",79.7,79.7,2.2,0)
DEFAULT DX FOR 'F' REPORT^*P78.3'^RA(78.3,^2;2^S DIC("S")="I +Y'<2000" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",79.7,79.7,2.2,3)
Enter the appropriate diagnostic code associated with a signed ('finalized') teleradiology report.
"^DD",79.7,79.7,2.2,12)
Internal Entry Numbers (IEN) for diagnostic code related to the National Teleradiology initiative assume IEN values of two thousand or greater.
"^DD",79.7,79.7,2.2,12.1)
S DIC("S")="I +Y'<2000"
"^DD",79.7,79.7,2.2,21,0)
^^5^5^3070907^
"^DD",79.7,79.7,2.2,21,1,0)
This field identifies the diagnostic code associated with a signed or 
"^DD",79.7,79.7,2.2,21,2,0)
verified teleradiology report.
"^DD",79.7,79.7,2.2,21,3,0)
 
"^DD",79.7,79.7,2.2,21,4,0)
A verified teleradiology report indicates that the report was signed by a
"^DD",79.7,79.7,2.2,21,5,0)
teleradiologist working for the National Teleradiology Center.
"^DD",79.7,79.7,2.2,"DT")
3070907
"^DD",79.7,79.72,0)
MESSAGE TYPE SUB-FIELD^^1^2
"^DD",79.7,79.72,0,"DT")
3070404
"^DD",79.7,79.72,0,"IX","B",79.72,.01)

"^DD",79.7,79.72,0,"NM","MESSAGE TYPE")

"^DD",79.7,79.72,0,"UP")
79.7
"^DD",79.7,79.72,.01,0)
MESSAGE TYPE^MP771.2'X^HL(771.2,^0;1^S:$D(X) DINUM=X Q
"^DD",79.7,79.72,.01,1,0)
^.1
"^DD",79.7,79.72,.01,1,1,0)
79.72^B
"^DD",79.7,79.72,.01,1,1,1)
S ^RA(79.7,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",79.7,79.72,.01,1,1,2)
K ^RA(79.7,DA(1),1,"B",$E(X,1,30),DA)
"^DD",79.7,79.72,.01,3)
Select HL7 Message Type
"^DD",79.7,79.72,.01,21,0)
^.001^3^3^3070419^^
"^DD",79.7,79.72,.01,21,1,0)
This field identifies the HL7 message type. This field is a pointer
"^DD",79.7,79.72,.01,21,2,0)
to HL7 MESSAGE TYPE (#771.2) file and may be set to values such as: ORM 
"^DD",79.7,79.72,.01,21,3,0)
(order message) or ORU (unsolicited observation message).
"^DD",79.7,79.72,.01,"DT")
3070419
"^DD",79.7,79.72,1,0)
EVENT TYPE^79.721P^^1;0
"^DD",79.7,79.72,1,21,0)
^^2^2^3070419^
"^DD",79.7,79.72,1,21,1,0)
This field identifies the HL7 event type. This field is a pointer to HL7
"^DD",79.7,79.72,1,21,2,0)
EVENT TYPE CODE (#779.001) file.
"^DD",79.7,79.72,1,"DT")
3070419
"^DD",79.7,79.721,0)
EVENT TYPE SUB-FIELD^^1^2
"^DD",79.7,79.721,0,"DT")
3070404
"^DD",79.7,79.721,0,"IX","B",79.721,.01)

"^DD",79.7,79.721,0,"NM","EVENT TYPE")

"^DD",79.7,79.721,0,"UP")
79.72
"^DD",79.7,79.721,.01,0)
EVENT TYPE^P779.001'X^HL(779.001,^0;1^S:$D(X) DINUM=X Q
"^DD",79.7,79.721,.01,1,0)
^.1
"^DD",79.7,79.721,.01,1,1,0)
79.721^B
"^DD",79.7,79.721,.01,1,1,1)
S ^RA(79.7,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",79.7,79.721,.01,1,1,2)
K ^RA(79.7,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)
"^DD",79.7,79.721,.01,3)
Select HL7 Event Type
"^DD",79.7,79.721,.01,21,0)
^^3^3^3070419^
"^DD",79.7,79.721,.01,21,1,0)
This field identifies the HL7 event type. This field is a pointer to HL7
"^DD",79.7,79.721,.01,21,2,0)
EVENT TYPE CODE (#779.001) file and may be set to values such as: O01 
"^DD",79.7,79.721,.01,21,3,0)
(Oh-zero-one) or RO1 (R-zero-one).
"^DD",79.7,79.721,.01,"DT")
3070419
"^DD",79.7,79.721,1,0)
HL7 VERSION^79.7211P^^1;0
"^DD",79.7,79.721,1,21,0)
^.001^2^2^3070419^^
"^DD",79.7,79.721,1,21,1,0)
This field identifies the HL7 version. This field is a pointer to HL7
"^DD",79.7,79.721,1,21,2,0)
VERSION (#771.5) file.
"^DD",79.7,79.721,1,"DT")
3070419
"^DD",79.7,79.7211,0)
HL7 VERSION SUB-FIELD^^4^5
"^DD",79.7,79.7211,0,"DT")
3070404
"^DD",79.7,79.7211,0,"IX","B",79.7211,.01)

"^DD",79.7,79.7211,0,"NM","HL7 VERSION")

"^DD",79.7,79.7211,0,"UP")
79.721
"^DD",79.7,79.7211,.01,0)
HL7 VERSION^P771.5'X^HL(771.5,^0;1^S:$D(X) DINUM=X Q
"^DD",79.7,79.7211,.01,.1)
HL7 VERSION
"^DD",79.7,79.7211,.01,1,0)
^.1
"^DD",79.7,79.7211,.01,1,1,0)
79.7211^B
"^DD",79.7,79.7211,.01,1,1,1)
S ^RA(79.7,DA(3),1,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",79.7,79.7211,.01,1,1,2)
K ^RA(79.7,DA(3),1,DA(2),1,DA(1),1,"B",$E(X,1,30),DA)
"^DD",79.7,79.7211,.01,21,0)
^^3^3^3070419^
"^DD",79.7,79.7211,.01,21,1,0)
This field identifies the HL7 version. This field is a pointer to HL7
"^DD",79.7,79.7211,.01,21,2,0)
VERSION (#771.5) file. The following values 2.3, 2.4, & 2.5 are
"^DD",79.7,79.7211,.01,21,3,0)
legitimate HL7 versions.
"^DD",79.7,79.7211,.01,"DT")
3070419
"^DD",79.7,79.7211,1,0)
RETURN HL7 TO SENDER^S^1:Yes;0:No;^0;2^Q
"^DD",79.7,79.7211,1,3)
Type Yes or No
"^DD",79.7,79.7211,1,21,0)
^^5^5^3070419^
"^DD",79.7,79.7211,1,21,1,0)
This field indicates if an inbound HL7 message to the VistA 
"^DD",79.7,79.7211,1,21,2,0)
Radiology/Nuclear Medicine application is to be re-broadcast to the
"^DD",79.7,79.7211,1,21,3,0)
original sender of the HL7 message.
"^DD",79.7,79.7211,1,21,4,0)
 
"^DD",79.7,79.7211,1,21,5,0)
The default value is 'NO'.
"^DD",79.7,79.7211,1,"DT")
3070419
"^DD",79.7,79.7211,2,0)
INBOUND SEGMENT CODING^K^^1;E1,245^K:$L(X)>245 X D:$D(X) ^DIM
"^DD",79.7,79.7211,2,3)
Enter Standard MUMPS code
"^DD",79.7,79.7211,2,21,0)
^^5^5^3070419^
"^DD",79.7,79.7211,2,21,1,0)
For an inbound HL7 messages this field will contain M code to handle
"^DD",79.7,79.7211,2,21,2,0)
business rule exceptions which are to be applied to HL7 segments.
"^DD",79.7,79.7211,2,21,3,0)
 
"^DD",79.7,79.7211,2,21,4,0)
The M code in this field will be executed before the HL7 segment is
"^DD",79.7,79.7211,2,21,5,0)
processed.
"^DD",79.7,79.7211,2,"DT")
3070419
"^DD",79.7,79.7211,3,0)
OUTBOUND SEGMENT CODING^K^^2;E1,245^K:$L(X)>245 X D:$D(X) ^DIM
"^DD",79.7,79.7211,3,3)
Enter Standard MUMPS code
"^DD",79.7,79.7211,3,21,0)
^^8^8^3070419^
"^DD",79.7,79.7211,3,21,1,0)
For Outbound message: M coding to handle exceptions on Segment level. 
"^DD",79.7,79.7211,3,21,2,0)
Coding is invoked before the Segment is processed.
"^DD",79.7,79.7211,3,21,3,0)
 
"^DD",79.7,79.7211,3,21,4,0)
For an outbound HL7 messages this field will contain M code to handle
"^DD",79.7,79.7211,3,21,5,0)
business rule exceptions which are to be applied to HL7 segments.
"^DD",79.7,79.7211,3,21,6,0)
 
"^DD",79.7,79.7211,3,21,7,0)
The M code in this field will be executed before the HL7 segment is
"^DD",79.7,79.7211,3,21,8,0)
broadcast as part of a HL7 message.
"^DD",79.7,79.7211,3,"DT")
3070419
"^DD",79.7,79.7211,4,0)
HL7 FIELD EXCEPTIONS^79.72114^^3;0
"^DD",79.7,79.7211,4,21,0)
^.001^2^2^3070419^^
"^DD",79.7,79.7211,4,21,1,0)
This field will contain M code to handle business rule exceptions which
"^DD",79.7,79.7211,4,21,2,0)
are to be applied to HL7 fields.
"^DD",79.7,79.7211,4,"DT")
3070419
"^DD",79.7,79.72114,0)
HL7 FIELD EXCEPTIONS SUB-FIELD^^2^3
"^DD",79.7,79.72114,0,"DT")
3070404
"^DD",79.7,79.72114,0,"IX","B",79.72114,.01)

"^DD",79.7,79.72114,0,"NM","HL7 FIELD EXCEPTIONS")

"^DD",79.7,79.72114,0,"UP")
79.7211
"^DD",79.7,79.72114,.01,0)
HL7 FIELD EXCEPTIONS NAME^F^^0;1^K:$L(X)>10!($L(X)<3) X
"^DD",79.7,79.72114,.01,1,0)
^.1
"^DD",79.7,79.72114,.01,1,1,0)
79.72114^B
"^DD",79.7,79.72114,.01,1,1,1)
S ^RA(79.7,DA(4),1,DA(3),1,DA(2),1,DA(1),3,"B",$E(X,1,30),DA)=""
"^DD",79.7,79.72114,.01,1,1,2)
K ^RA(79.7,DA(4),1,DA(3),1,DA(2),1,DA(1),3,"B",$E(X,1,30),DA)
"^DD",79.7,79.72114,.01,3)
Answer must be 3-10 characters in length
"^DD",79.7,79.72114,.01,21,0)
^^6^6^3070419^
"^DD",79.7,79.72114,.01,21,1,0)
This field will contain M code to handle business rule exceptions which
"^DD",79.7,79.72114,.01,21,2,0)
are to be applied to HL7 fields.  
"^DD",79.7,79.72114,.01,21,3,0)
 
"^DD",79.7,79.72114,.01,21,4,0)
An example of a HL7 FIELD EXCEPTIONS NAME would be: 'OBR-32'. 'OBR' is the
"^DD",79.7,79.72114,.01,21,5,0)
HL7 segments and thirty-two in the piece position on that segment to which
"^DD",79.7,79.72114,.01,21,6,0)
the business rule exception will be applied.
"^DD",79.7,79.72114,.01,"DT")
3070419
"^DD",79.7,79.72114,1,0)
INBOUND HL7 FIELD CODING^K^^1;E1,245^K:$L(X)>245 X D:$D(X) ^DIM
"^DD",79.7,79.72114,1,3)
Enter Standard MUMPS code
"^DD",79.7,79.72114,1,21,0)
^^5^5^3070419^
"^DD",79.7,79.72114,1,21,1,0)
For an inbound HL7 messages this field will contain M code to handle
"^DD",79.7,79.72114,1,21,2,0)
business rule exceptions which are to be applied to HL7 fields.
"^DD",79.7,79.72114,1,21,3,0)
 
"^DD",79.7,79.72114,1,21,4,0)
The M code in this field will be executed before the HL7 field is
"^DD",79.7,79.72114,1,21,5,0)
processed.
"^DD",79.7,79.72114,1,"DT")
3070419
"^DD",79.7,79.72114,2,0)
OUTBOUND HL7 FIELD CODING^K^^2;E1,245^K:$L(X)>245 X D:$D(X) ^DIM
"^DD",79.7,79.72114,2,3)
Enter Standard MUMPS code
"^DD",79.7,79.72114,2,21,0)
^^5^5^3070419^
"^DD",79.7,79.72114,2,21,1,0)
For an outbound HL7 messages this field will contain M code to handle
"^DD",79.7,79.72114,2,21,2,0)
business rule exceptions which are to be applied to HL7 fields.
"^DD",79.7,79.72114,2,21,3,0)
 
"^DD",79.7,79.72114,2,21,4,0)
The M code in this field will be executed before the HL7 field is
"^DD",79.7,79.72114,2,21,5,0)
broadcast as part of a HL7 message.         
"^DD",79.7,79.72114,2,"DT")
3070419
"^DIC",79.7,79.7,0)
RAD/NUC MED HL7 APPLICATION EXCEPTION^79.7
"^DIC",79.7,79.7,0,"GL")
^RA(79.7,
"^DIC",79.7,79.7,"%",0)
^1.005^^0
"^DIC",79.7,79.7,"%D",0)
^^15^15^3070907^
"^DIC",79.7,79.7,"%D",1,0)
The file holds parameters related to the application exceptions in 
"^DIC",79.7,79.7,"%D",2,0)
processing of HL7 Radiology messages.
"^DIC",79.7,79.7,"%D",3,0)
 
"^DIC",79.7,79.7,"%D",4,0)
DO NOT EDIT THIS FILE!
"^DIC",79.7,79.7,"%D",5,0)
 
"^DIC",79.7,79.7,"%D",6,0)
For designated applications, the file entries held the exceptions in 
"^DIC",79.7,79.7,"%D",7,0)
processing of RAD HL7 messages. If the radiology department at the 
"^DIC",79.7,79.7,"%D",8,0)
facility chooses to rebroadcast HL7 report messages to the 
"^DIC",79.7,79.7,"%D",9,0)
originator of the message, that parameter is set in this file.
"^DIC",79.7,79.7,"%D",10,0)
 
"^DIC",79.7,79.7,"%D",11,0)
Different HL7 interfaces enforce different business rules. For example,
"^DIC",79.7,79.7,"%D",12,0)
Radiology may wish to apply different business rules (for example 
"^DIC",79.7,79.7,"%D",13,0)
provider classification) to ''Principal Result Interpreter' (OBR-32) data.
"^DIC",79.7,79.7,"%D",14,0)
 
"^DIC",79.7,79.7,"%D",15,0)
This file is where interface specific business rules will be codified.
"^DIC",79.7,"B","RAD/NUC MED HL7 APPLICATION EXCEPTION",79.7)

"BLD",6612,6)
^76
**END**
**END**

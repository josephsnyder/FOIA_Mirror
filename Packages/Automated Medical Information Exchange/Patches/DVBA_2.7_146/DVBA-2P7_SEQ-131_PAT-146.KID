Released DVBA*2.7*146 SEQ #131
Extracted from mail message
**KIDS**:DVBA*2.7*146^

**INSTALL NAME**
DVBA*2.7*146
"BLD",8093,0)
DVBA*2.7*146^AUTOMATED MED INFO EXCHANGE^0^3091019^y
"BLD",8093,1,0)
^^2^2^3090611^
"BLD",8093,1,1,0)
This patch adds two new mail bulletins to allow messages triggered
"BLD",8093,1,2,0)
by CAPRI to be processed in Vista and distributed accordingly.
"BLD",8093,4,0)
^9.64PA^^
"BLD",8093,6.3)
6
"BLD",8093,"INID")
^y
"BLD",8093,"INIT")
EN^DVBA146P
"BLD",8093,"KRN",0)
^9.67PA^779.2^20
"BLD",8093,"KRN",.4,0)
.4
"BLD",8093,"KRN",.401,0)
.401
"BLD",8093,"KRN",.402,0)
.402
"BLD",8093,"KRN",.403,0)
.403
"BLD",8093,"KRN",.5,0)
.5
"BLD",8093,"KRN",.84,0)
.84
"BLD",8093,"KRN",3.6,0)
3.6
"BLD",8093,"KRN",3.6,"NM",0)
^9.68A^2^2
"BLD",8093,"KRN",3.6,"NM",1,0)
DVBA CAPRI 2507 CANCELLATION^^0
"BLD",8093,"KRN",3.6,"NM",2,0)
DVBA CAPRI NEW C&P VETERAN^^0
"BLD",8093,"KRN",3.6,"NM","B","DVBA CAPRI 2507 CANCELLATION",1)

"BLD",8093,"KRN",3.6,"NM","B","DVBA CAPRI NEW C&P VETERAN",2)

"BLD",8093,"KRN",3.8,0)
3.8
"BLD",8093,"KRN",9.2,0)
9.2
"BLD",8093,"KRN",9.8,0)
9.8
"BLD",8093,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",8093,"KRN",9.8,"NM",1,0)
DVBAB1^^0^B54214482
"BLD",8093,"KRN",9.8,"NM","B","DVBAB1",1)

"BLD",8093,"KRN",19,0)
19
"BLD",8093,"KRN",19.1,0)
19.1
"BLD",8093,"KRN",101,0)
101
"BLD",8093,"KRN",409.61,0)
409.61
"BLD",8093,"KRN",771,0)
771
"BLD",8093,"KRN",779.2,0)
779.2
"BLD",8093,"KRN",870,0)
870
"BLD",8093,"KRN",8989.51,0)
8989.51
"BLD",8093,"KRN",8989.52,0)
8989.52
"BLD",8093,"KRN",8994,0)
8994
"BLD",8093,"KRN","B",.4,.4)

"BLD",8093,"KRN","B",.401,.401)

"BLD",8093,"KRN","B",.402,.402)

"BLD",8093,"KRN","B",.403,.403)

"BLD",8093,"KRN","B",.5,.5)

"BLD",8093,"KRN","B",.84,.84)

"BLD",8093,"KRN","B",3.6,3.6)

"BLD",8093,"KRN","B",3.8,3.8)

"BLD",8093,"KRN","B",9.2,9.2)

"BLD",8093,"KRN","B",9.8,9.8)

"BLD",8093,"KRN","B",19,19)

"BLD",8093,"KRN","B",19.1,19.1)

"BLD",8093,"KRN","B",101,101)

"BLD",8093,"KRN","B",409.61,409.61)

"BLD",8093,"KRN","B",771,771)

"BLD",8093,"KRN","B",779.2,779.2)

"BLD",8093,"KRN","B",870,870)

"BLD",8093,"KRN","B",8989.51,8989.51)

"BLD",8093,"KRN","B",8989.52,8989.52)

"BLD",8093,"KRN","B",8994,8994)

"BLD",8093,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8093,"QUES",0)
^9.62^^
"BLD",8093,"REQB",0)
^9.611^1^1
"BLD",8093,"REQB",1,0)
DVBA*2.7*137^1
"BLD",8093,"REQB","B","DVBA*2.7*137",1)

"INIT")
EN^DVBA146P
"KRN",3.6,289,-1)
0^1
"KRN",3.6,289,0)
DVBA CAPRI 2507 CANCELLATION^CAPRI: Cancellation of 2507 Exams
"KRN",3.6,289,3,0)
^3.63^3^3^3091019^^^
"KRN",3.6,289,3,1,0)
Notifies DVBA C 2507 CANCELLATION group of cancellation of exams and/or
"KRN",3.6,289,3,2,0)
requests. There are no parameters needed for this bulletin as all data
"KRN",3.6,289,3,3,0)
is contained in the text portion of the bulletin.
"KRN",3.6,290,-1)
0^2
"KRN",3.6,290,0)
DVBA CAPRI NEW C&P VETERAN^CAPRI: New C&P Veteran Added to Patient File
"KRN",3.6,290,3,0)
^3.63^3^3^3090902^^^
"KRN",3.6,290,3,1,0)
Alerts MAS of new C&P veteran when added to Patient file (#2).
"KRN",3.6,290,3,2,0)
There are no parameters needed for this bulletin as all data is contained in
"KRN",3.6,290,3,3,0)
the text portion of the bulletin.
"MBREQ")
0
"ORD",2,3.6)
3.6;2;1;;BUL^XPDTA1;;BULE1^XPDIA1;;;BULDEL^XPDIA1
"ORD",2,3.6,0)
BULLETIN
"PKG",223,-1)
1^1
"PKG",223,0)
AUTOMATED MED INFO EXCHANGE^DVBA^The entire AMIE package 7131/2507.
"PKG",223,20,0)
^9.402P^^
"PKG",223,22,0)
^9.49I^1^1
"PKG",223,22,1,0)
2.7^2950410^2950508
"PKG",223,22,1,"PAH",1,0)
146^3091019
"PKG",223,22,1,"PAH",1,1,0)
^^2^2^3091019
"PKG",223,22,1,"PAH",1,1,1,0)
This patch adds two new mail bulletins to allow messages triggered
"PKG",223,22,1,"PAH",1,1,2,0)
by CAPRI to be processed in Vista and distributed accordingly.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DVBA146P")
0^^B4555778^n/a
"RTN","DVBA146P",1,0)
DVBA146P ;ALB/RRA - Post Init Exam file Update ; 14 Jun 2005
"RTN","DVBA146P",2,0)
 ;;2.7;AMIE;**146**;AUG 7,2003;Build 6
"RTN","DVBA146P",3,0)
 ;
"RTN","DVBA146P",4,0)
 ; This is the post-install for DVBA*2.7*146 to add relevant.
"RTN","DVBA146P",5,0)
 ; mailgroups to the new bulletins added by this patch
"RTN","DVBA146P",6,0)
 ;
"RTN","DVBA146P",7,0)
 Q
"RTN","DVBA146P",8,0)
 ;Must be run from EN^DVBA146P
"RTN","DVBA146P",9,0)
EN ;
"RTN","DVBA146P",10,0)
 N DVBMG,DVBIEN,DVBBLT,DA,DIE,DR,DVBI,DVBFLG,DVBX,DVBMGRP,DIC,X,Y
"RTN","DVBA146P",11,0)
 D BMES^XPDUTL("DVBA*2.7*146 Post Installation --")
"RTN","DVBA146P",12,0)
 D MES^XPDUTL("   Populating mail groups for newly added Bulletins.")
"RTN","DVBA146P",13,0)
 D MES^XPDUTL("  ")
"RTN","DVBA146P",14,0)
 F DVBI="DVBA C 2507 CANCELLATION","DVBA C NEW C&P VETERAN"  N DVBMG D FIND(DVBI,.DVBMG) D UPDATE
"RTN","DVBA146P",15,0)
 D BMES^XPDUTL("DVBA*2.7*146 Post Installation complete!")
"RTN","DVBA146P",16,0)
 Q
"RTN","DVBA146P",17,0)
FIND(DVBI,DVBMG) ;FIND IEN'S OF MAIL GROUPS
"RTN","DVBA146P",18,0)
 S DVBMG=$O(^XMB(3.8,"B",DVBI,0))
"RTN","DVBA146P",19,0)
 D:'DVBMG MES^XPDUTL("The "_DVBI_" MAIL group does not exist")
"RTN","DVBA146P",20,0)
 Q
"RTN","DVBA146P",21,0)
 ;
"RTN","DVBA146P",22,0)
UPDATE ;UPDATE THE BULLETIN FILE (#3.6) ENTRIES WITH MAIL GROUPS
"RTN","DVBA146P",23,0)
 Q:'DVBMG
"RTN","DVBA146P",24,0)
 I DVBI="DVBA C 2507 CANCELLATION" S DVBBLT="DVBA CAPRI 2507 CANCELLATION"
"RTN","DVBA146P",25,0)
 I DVBI="DVBA C NEW C&P VETERAN" S DVBBLT="DVBA CAPRI NEW C&P VETERAN"
"RTN","DVBA146P",26,0)
 S DVBIEN=$O(^XMB(3.6,"B",DVBBLT,0))
"RTN","DVBA146P",27,0)
 Q:'DVBIEN
"RTN","DVBA146P",28,0)
 N DVBFLG D CHECK(DVBIEN,.DVBFLG)
"RTN","DVBA146P",29,0)
 ;if it found a match quit because the bulletin already has the 
"RTN","DVBA146P",30,0)
 ;correct mail group
"RTN","DVBA146P",31,0)
 Q:DVBFLG=1
"RTN","DVBA146P",32,0)
 ;no match found, now update the bulletin with the correct mailgroup
"RTN","DVBA146P",33,0)
 S DA(1)=DVBIEN,DIC="^XMB(3.6,"_DA(1)_",2,",X=DVBMG,DIC("P")=3.62,DIC(0)="X" D FILE^DICN
"RTN","DVBA146P",34,0)
 D:Y>0 BMES^XPDUTL("The "_DVBBLT_" bulletin has been updated.")
"RTN","DVBA146P",35,0)
 Q
"RTN","DVBA146P",36,0)
 ;
"RTN","DVBA146P",37,0)
CHECK(DVBIEN,DVBFLG) ;check to see if the mailgroup has already been added
"RTN","DVBA146P",38,0)
 S DVBFLG=0
"RTN","DVBA146P",39,0)
 I $D(^XMB(3.6,DVBIEN,2))  D
"RTN","DVBA146P",40,0)
 .S DVBX=0
"RTN","DVBA146P",41,0)
 .F  S DVBX=$O(^XMB(3.6,DVBIEN,2,DVBX)) Q:DVBX=""  Q:DVBFLG=1  D
"RTN","DVBA146P",42,0)
 ..S DVBMGRP=$P($G(^XMB(3.6,DVBIEN,2,DVBX,0)),"^")
"RTN","DVBA146P",43,0)
 ..I DVBMGRP=DVBMG S DVBFLG=1 D BMES^XPDUTL("The "_DVBBLT_" bulletin has already been updated!")
"RTN","DVBA146P",44,0)
 Q
"RTN","DVBAB1")
0^1^B54214482^B53258252
"RTN","DVBAB1",1,0)
DVBAB1 ;ALB/SPH - CAPRI UTILITIES ; 01/01/00
"RTN","DVBAB1",2,0)
 ;;2.7;AMIE;**35,37,50,42,53,57,73,104,109,137,146**;Apr 10, 1995;Build 6
"RTN","DVBAB1",3,0)
 ;
"RTN","DVBAB1",4,0)
VERSION(ZMSG,DVBGUIV) ;
"RTN","DVBAB1",5,0)
 ; 
"RTN","DVBAB1",6,0)
 ; --rpc: DVBAB VERSION
"RTN","DVBAB1",7,0)
 ; 
"RTN","DVBAB1",8,0)
 ; Must have a letter at the end of the Version for Delphi compatibility.
"RTN","DVBAB1",9,0)
 ;  1st piece is version description
"RTN","DVBAB1",10,0)
 ;  2nd piece can be YESOLD or NOOLD
"RTN","DVBAB1",11,0)
 ;    YESOLD --> Allow old GUI to run with new KID
"RTN","DVBAB1",12,0)
 ;     NOOLD --> Do not allow old GUI to run with newer version
"RTN","DVBAB1",13,0)
 ; 
"RTN","DVBAB1",14,0)
 ; Sets variables DVBABV* so that the error trap will display what
"RTN","DVBAB1",15,0)
 ; version of the client software the user was utilizing if CAPRI bombs.
"RTN","DVBAB1",16,0)
 ;
"RTN","DVBAB1",17,0)
 ;REMOVE THIS LINE OF CODE WHEN CUTTING BUILD FOR PATCH 137
"RTN","DVBAB1",18,0)
 ;RESOTRE IT AFTER BUILD IS CUT TO ALLOW OLD VERSIONS IN DEVFEX TEMPORARILY  
"RTN","DVBAB1",19,0)
 ;S ZMSG="CAPRI GUI V2.7*71*0*A^NOOLD"
"RTN","DVBAB1",20,0)
 ;
"RTN","DVBAB1",21,0)
 ;ACTIVATE THIS LINE OF CODE WHEN CUTTING BUILD FOR PATCH 137
"RTN","DVBAB1",22,0)
 ;S ZMSG="CAPRI GUI V2.7*123*1*A^NOOLD"
"RTN","DVBAB1",23,0)
 ;
"RTN","DVBAB1",24,0)
 S ZMSG="CAPRI GUI V2.7*123*0*A^NOOLD"
"RTN","DVBAB1",25,0)
 ;
"RTN","DVBAB1",26,0)
 S DVBABVR1="CAPRI Server Version: "_ZMSG
"RTN","DVBAB1",27,0)
 I '$D(DVBGUIV) S DVBGUIV="CAPRI GUI Version: UNKNOWN - Version is prior to DVBA*2.7*123"
"RTN","DVBAB1",28,0)
 S DVBABVR2="CAPRI GUI Version: "_DVBGUIV
"RTN","DVBAB1",29,0)
 S DVBABVR3=$P(^VA(200,DUZ,0),"^",1)
"RTN","DVBAB1",30,0)
 Q 
"RTN","DVBAB1",31,0)
 ;
"RTN","DVBAB1",32,0)
REQUESTS(Y,TYPE) ;
"RTN","DVBAB1",33,0)
 ; TYPE is the internal value of field 17 in file 396.3
"RTN","DVBAB1",34,0)
 ; This relates to which status of request should be returned
"RTN","DVBAB1",35,0)
 N DVBABCNT,DVBABIEN
"RTN","DVBAB1",36,0)
 S DVBABCNT=0,DVBABIEN=0
"RTN","DVBAB1",37,0)
 F  S DVBABIEN=$O(^DVB(396.3,DVBABIEN)) Q:'DVBABIEN  D
"RTN","DVBAB1",38,0)
 .S DVBABST=$P($G(^DVB(396.3,DVBABIEN,0)),"^",18)
"RTN","DVBAB1",39,0)
 .I DVBABST=TYPE D
"RTN","DVBAB1",40,0)
 ..S DVBABNM=$P($G(^DVB(396.3,DVBABIEN,0)),"^",1)
"RTN","DVBAB1",41,0)
 ..S DVBABPT=DVBABNM
"RTN","DVBAB1",42,0)
 ..I DVBABNM'="" S DVBABNM=$P($G(^DPT(DVBABNM,0)),"^",1)
"RTN","DVBAB1",43,0)
 ..S DVBABDT=$$FMTE^XLFDT($P($G(^DVB(396.3,DVBABIEN,0)),"^",2),"2D")
"RTN","DVBAB1",44,0)
 ..S DVBABWHO=$P($G(^DVB(396.3,DVBABIEN,0)),"^",4)
"RTN","DVBAB1",45,0)
 ..I DVBABWHO'="" S DVBABWHO=$P($G(^VA(200,DVBABWHO,0)),"^",1)
"RTN","DVBAB1",46,0)
 ..E  S DVBABWHO="UNKNOWN"
"RTN","DVBAB1",47,0)
 ..S DVBABRO=$P($G(^DVB(396.3,DVBABIEN,0)),"^",3)
"RTN","DVBAB1",48,0)
 ..I DVBABRO'="" S DVBABRO=$P($G(^DIC(4,DVBABRO,0)),"^",1)
"RTN","DVBAB1",49,0)
 ..E  S DVBABRO="UNKNOWN"
"RTN","DVBAB1",50,0)
 ..S ^TMP("DVBAREQ",DUZ,DVBABCNT)=DVBABST_"^"_DVBABPT_"^"_DVBABNM_"^"_DVBABDT_"^"_DVBABWHO_"^"_DVBABRO_"^"_DVBABIEN_$C(13),DVBABCNT=DVBABCNT+1
"RTN","DVBAB1",51,0)
 S Y=$NA(^TMP("DVBAREQ",DUZ))
"RTN","DVBAB1",52,0)
 K DVBABCNT,DVBABIEN,TYPE,DVBABNM,DVBABDT,DVBABST,DVBABWHO,DVBABPT
"RTN","DVBAB1",53,0)
 Q
"RTN","DVBAB1",54,0)
TEAMPTS(DVBORY,TEAM,TMPFLAG) ; RETURN LIST OF PATIENTS IN A TEAM
"RTN","DVBAB1",55,0)
 ; If TMPFLAG passed and = TRUE, code expects a "^TMP(xxx"
"RTN","DVBAB1",56,0)
 ;    global root string passed in ORY, and builds the returned 
"RTN","DVBAB1",57,0)
 ;    list in that global instead of to a memory array.
"RTN","DVBAB1",58,0)
 N DOTMP,NEWTMP,DVBSSN,DVBORI,DVBORPT,I
"RTN","DVBAB1",59,0)
 K ^TMP("DVBATMPT",DUZ)
"RTN","DVBAB1",60,0)
 S (I,DOTMP,DVBORI)=0
"RTN","DVBAB1",61,0)
 I $G(TMPFLAG) D             ; Was value passed?
"RTN","DVBAB1",62,0)
 .I TMPFLAG S DOTMP=1        ; Is value TRUE?
"RTN","DVBAB1",63,0)
 I +$G(TEAM)<1 D
"RTN","DVBAB1",64,0)
 .I DOTMP S NEWTMP=DVBORY_1_")",@NEWTMP="^No team identified"
"RTN","DVBAB1",65,0)
 .E  S DVBORY(1)="^No team identified"
"RTN","DVBAB1",66,0)
 F  S DVBORI=$O(^OR(100.21,+TEAM,10,DVBORI)) Q:DVBORI<1  D
"RTN","DVBAB1",67,0)
 .S DVBORPT=^OR(100.21,+TEAM,10,DVBORI,0)
"RTN","DVBAB1",68,0)
 .I DOTMP D
"RTN","DVBAB1",69,0)
 ..S I=I+1,NEWTMP=DVBORY_+I_")"
"RTN","DVBAB1",70,0)
 ..S @NEWTMP=+DVBORPT_U_$P(^DPT(+DVBORPT,0),U)
"RTN","DVBAB1",71,0)
 .S DVBSSN=$P($G(^DPT($P(DVBORPT,";",1),0)),U,9)
"RTN","DVBAB1",72,0)
 .E  S I=I+1,^TMP("DVBATMPT",DUZ,I)=+DVBORPT_U_$P(^DPT(+DVBORPT,0),U)_U_DVBSSN_$C(13)
"RTN","DVBAB1",73,0)
 I DOTMP S:I<1 NEWTMP=DVBORY_1_")",@NEWTMP="^No patients found."
"RTN","DVBAB1",74,0)
 E  S:I<1 ^TMP("DVBATMPT",DUZ,1)="^No patients found."
"RTN","DVBAB1",75,0)
 S DVBORY=$NA(^TMP("DVBATMPT",DUZ))
"RTN","DVBAB1",76,0)
 Q
"RTN","DVBAB1",77,0)
DIVISION(Y) ; Returns Name for an Institution
"RTN","DVBAB1",78,0)
 N DVBARR,DVBERR,DVBATP
"RTN","DVBAB1",79,0)
 S Y=""
"RTN","DVBAB1",80,0)
 Q:$G(DUZ(2))=""
"RTN","DVBAB1",81,0)
 D GETS^DIQ(4,DUZ(2)_",0",".01","I","DVBARR","DVBERR")
"RTN","DVBAB1",82,0)
 Q:$D(DVBERR)
"RTN","DVBAB1",83,0)
 S Y=$G(DVBARR(4,DUZ(2)_",0,",.01,"I"))
"RTN","DVBAB1",84,0)
 D GETS^DIQ(4,DUZ(2)_",0",13,"I","DVBARR","DVBERR")
"RTN","DVBAB1",85,0)
 S DVBATP=$G(DVBARR(4,DUZ(2)_",0,",13,"I"))
"RTN","DVBAB1",86,0)
 I DVBATP'="" S DVBATP=$P($G(^DIC(4.1,DVBATP,0)),"^",1)
"RTN","DVBAB1",87,0)
 S Y=Y_"-"_DVBATP
"RTN","DVBAB1",88,0)
 Q
"RTN","DVBAB1",89,0)
 ;
"RTN","DVBAB1",90,0)
DT(Y,X1,X2) ; Returns date X1 minus X2 days
"RTN","DVBAB1",91,0)
 ; change the '00:00' that could be passed so Fileman doesn't reject
"RTN","DVBAB1",92,0)
 ;C^%DTC(X1,X2)
"RTN","DVBAB1",93,0)
 ;S %DT=$G(%DT,"TS") D ^%DT
"RTN","DVBAB1",94,0)
 ;K %DT,X1,X2
"RTN","DVBAB1",95,0)
 ;Q
"RTN","DVBAB1",96,0)
DTTM(Y) ;
"RTN","DVBAB1",97,0)
 S Y=$$HTE^XLFDT($H,"P")
"RTN","DVBAB1",98,0)
 Q
"RTN","DVBAB1",99,0)
CHKCRED(Y) ;KLB
"RTN","DVBAB1",100,0)
 S Y="[OK]"
"RTN","DVBAB1",101,0)
 I '$D(DUZ(2)) S Y="Your division number is missing." Q
"RTN","DVBAB1",102,0)
 I $D(DUZ)#2=0 S Y="Your user number is invalid." Q
"RTN","DVBAB1",103,0)
 I +DUZ(2)<1 S Y="Invalid division."
"RTN","DVBAB1",104,0)
 Q
"RTN","DVBAB1",105,0)
PTINQ(REF,DFN) ; Return formatted pt inquiry report
"RTN","DVBAB1",106,0)
 K ^TMP("ORDATA",$J,1)
"RTN","DVBAB1",107,0)
 ; DVBA*2.7*109 - Added $D to next line
"RTN","DVBAB1",108,0)
 I ($D(^DPT(DFN,0))) D START^ORWRP(80,"DGINQB^ORCXPND1(DFN)")
"RTN","DVBAB1",109,0)
 S REF=$NA(^TMP("ORDATA",$J,1))
"RTN","DVBAB1",110,0)
 Q
"RTN","DVBAB1",111,0)
TEMPLATE(Y) ; Returns list of CAPRI exam templates
"RTN","DVBAB1",112,0)
 N DVBABCNT,DVBABIEN,DVBABNM,DVBABAD,DVBABDD,DVBABSL,DVBABOC
"RTN","DVBAB1",113,0)
 K Y,^TMP("DVBALAB1",DUZ)
"RTN","DVBAB1",114,0)
 S DVBABCNT=0,DVBABIEN=0
"RTN","DVBAB1",115,0)
 F  S DVBABIEN=$O(^DVB(396.18,DVBABIEN)) Q:'DVBABIEN  D
"RTN","DVBAB1",116,0)
 .S DVBABNM=$P($G(^DVB(396.18,DVBABIEN,0)),"^",1)
"RTN","DVBAB1",117,0)
 .S DVBABAD=$P($G(^DVB(396.18,DVBABIEN,2)),"^",1)
"RTN","DVBAB1",118,0)
 .S DVBABDD=$P($G(^DVB(396.18,DVBABIEN,2)),"^",2)
"RTN","DVBAB1",119,0)
 .S DVBABSL=$P($G(^DVB(396.18,DVBABIEN,6)),"^",1)
"RTN","DVBAB1",120,0)
 .S DVBABOC=$P($G(^DVB(396.18,DVBABIEN,6)),"^",2)
"RTN","DVBAB1",121,0)
 .S ^TMP("DVBATMPL",DUZ,DVBABCNT)=DVBABNM_"^"_DVBABAD_"^"_DVBABDD_"^"_DVBABSL_"^"_DVBABOC_"^"_DVBABIEN_$C(13),DVBABCNT=DVBABCNT+1
"RTN","DVBAB1",122,0)
 S Y=$NA(^TMP("DVBATMPL",DUZ))
"RTN","DVBAB1",123,0)
 Q
"RTN","DVBAB1",124,0)
 ;
"RTN","DVBAB1",125,0)
LABLIST(Y) ; Returns list of LAB TEST NAMES
"RTN","DVBAB1",126,0)
 N DVBABCNT,DVBABIEN,DVBABLNM
"RTN","DVBAB1",127,0)
 K Y,^TMP("DVBALAB1",DUZ)
"RTN","DVBAB1",128,0)
 S DVBABCNT=0,DVBABIEN=0
"RTN","DVBAB1",129,0)
 F  S DVBABIEN=$O(^LAB(60,DVBABIEN)) Q:'DVBABIEN  D
"RTN","DVBAB1",130,0)
 .S DVBABLNM=$P($G(^LAB(60,DVBABIEN,0)),"^",1)
"RTN","DVBAB1",131,0)
 .S ^TMP("DVBALAB1",DUZ,DVBABCNT)=DVBABLNM_"^"_DVBABIEN_$C(13),DVBABCNT=DVBABCNT+1
"RTN","DVBAB1",132,0)
 S Y=$NA(^TMP("DVBALAB1",DUZ))
"RTN","DVBAB1",133,0)
 Q
"RTN","DVBAB1",134,0)
 ;
"RTN","DVBAB1",135,0)
INSTLIST(Y) ; Returns full list of Institutions
"RTN","DVBAB1",136,0)
 N DVBABCNT,DVBABIEN,DVBABNM,DVBABSTN,DVBABST,DVBABDS,DVBARR,DVBERR,DVBATP
"RTN","DVBAB1",137,0)
 K Y,^TMP("DVBAINST",$J,DUZ)
"RTN","DVBAB1",138,0)
 S (DVBABCNT,DVBABIEN)=0
"RTN","DVBAB1",139,0)
 F  S DVBABIEN=$O(^DIC(4,DVBABIEN)) Q:'DVBABIEN  D 
"RTN","DVBAB1",140,0)
 . K DVBARR,DVBERR
"RTN","DVBAB1",141,0)
 . D GETS^DIQ(4,DVBABIEN_",0",".01:.02:.03:","I","DVBARR","DVBERR")
"RTN","DVBAB1",142,0)
 . Q:$D(DVBERR)
"RTN","DVBAB1",143,0)
 . S DVBABNM=$G(DVBARR(4,DVBABIEN_",0,",.01,"I"))
"RTN","DVBAB1",144,0)
 . Q:DVBABNM=""
"RTN","DVBAB1",145,0)
 . S DVBABSTN=$G(DVBARR(4,DVBABIEN_",0,",.02,"I"))
"RTN","DVBAB1",146,0)
 . Q:DVBABSTN=""
"RTN","DVBAB1",147,0)
 . S DVBABDS=$G(DVBARR(4,DVBABIEN_",0,",.03,"I"))
"RTN","DVBAB1",148,0)
 . K DVBARR,DVBERR
"RTN","DVBAB1",149,0)
 . D GETS^DIQ(5,DVBABSTN_",0",.01,"I","DVBARR","DVBERR")
"RTN","DVBAB1",150,0)
 . Q:$D(DVBERR)
"RTN","DVBAB1",151,0)
 . S DVBABST=$G(DVBARR(5,DVBABSTN_",0,",.01,"I"))
"RTN","DVBAB1",152,0)
 . K DVBARR,DVBERR
"RTN","DVBAB1",153,0)
 . D GETS^DIQ(4,DVBABIEN_",0",13,"I","DVBARR","DVBERR")
"RTN","DVBAB1",154,0)
 . S DVBATP=$G(DVBARR(4,DVBABIEN_",0,",13,"I"))
"RTN","DVBAB1",155,0)
 . I DVBATP'="" D
"RTN","DVBAB1",156,0)
 .. S DVBATP=$P($G(^DIC(4.1,DVBATP,0)),"^",1)
"RTN","DVBAB1",157,0)
 . S ^TMP("DVBAINST",$J,DUZ,DVBABCNT)=DVBABNM_"-"_DVBATP_"^"_DVBABST_"^"_DVBABDS_"^"_DVBABIEN_$C(13)
"RTN","DVBAB1",158,0)
 . S DVBABCNT=DVBABCNT+1
"RTN","DVBAB1",159,0)
 S Y=$NA(^TMP("DVBAINST",$J,DUZ))
"RTN","DVBAB1",160,0)
 Q
"RTN","DVBAB1",161,0)
 ;
"RTN","DVBAB1",162,0)
INCEXAM(ZMSG) ;Increased exam # in file  and passes back the # to user
"RTN","DVBAB1",163,0)
 S ZMSG=+$G(^DVB(396.1,1,5))+1
"RTN","DVBAB1",164,0)
 S ^DVB(396.1,1,5)=ZMSG
"RTN","DVBAB1",165,0)
 Q
"RTN","DVBAB1",166,0)
 ;
"RTN","DVBAB1",167,0)
MSG(ERR,DUZ,XMSUB,XMTEXT,MGN) ;Generate mail message;KLB
"RTN","DVBAB1",168,0)
 ; --rpc: DVBAB SEND MSG
"RTN","DVBAB1",169,0)
 ;
"RTN","DVBAB1",170,0)
 ; This remote procedure is used to generate bulletins for specific CAPRI actions, such as cancellation of 2507 exams.
"RTN","DVBAB1",171,0)
 ;
"RTN","DVBAB1",172,0)
 ;  Supported References:                                               
"RTN","DVBAB1",173,0)
 ;     DBIA #10111: Allows FM read access of ^XMB(3.8,D0,0) using DIC.
"RTN","DVBAB1",174,0)
 K ^TMP($J,"AMIE")
"RTN","DVBAB1",175,0)
 S XMB=""
"RTN","DVBAB1",176,0)
 I '$D(DUZ) S ERR="MISSING DUZ" Q
"RTN","DVBAB1",177,0)
 I '$D(XMSUB) S ERR="MISSING SUBJECT" Q
"RTN","DVBAB1",178,0)
 I '$D(XMTEXT) S ERR="MISSING TEXT" Q
"RTN","DVBAB1",179,0)
 I '$D(MGN) S ERR="MISSING MAIL GROUP NAME" Q
"RTN","DVBAB1",180,0)
 S XMDUZ=DUZ,J=0
"RTN","DVBAB1",181,0)
 F  S J=$O(XMTEXT(J)) Q:'J  S ^TMP($J,"AMIE",J)=$G(XMTEXT(J))
"RTN","DVBAB1",182,0)
 S XMTEXT="^TMP($J,""AMIE"","
"RTN","DVBAB1",183,0)
 S DIC="^XMB(3.8,",DIC(0)="QM",X=MGN D ^DIC
"RTN","DVBAB1",184,0)
 I +Y<0 S ERR="INVALID MAIL GROUP NAME" Q
"RTN","DVBAB1",185,0)
 I '$$GOTLOCAL^XMXAPIG(MGN) S ERR="NO ACTIVE LOCAL MEMBERS IN MAIL GROUP" K ^TMP("XMERR",$J) Q
"RTN","DVBAB1",186,0)
 I MGN="DVBA C NEW C&P VETERAN" S XMB="DVBA CAPRI NEW C&P VETERAN"
"RTN","DVBAB1",187,0)
 I MGN="DVBA C 2507 CANCELLATION" S XMB="DVBA CAPRI 2507 CANCELLATION"
"RTN","DVBAB1",188,0)
 I XMB="" S ERR="UNABLE TO SET BULLETIN" Q
"RTN","DVBAB1",189,0)
 D ^XMB
"RTN","DVBAB1",190,0)
 ;XMB = -1 if bulletin not found in file (#3.6)
"RTN","DVBAB1",191,0)
 S ERR=$S(XMB=-1:"BULLETIN NOT FOUND",1:"MESSAGE SENT")
"RTN","DVBAB1",192,0)
 K XMSUB,XMTEXT,MGN,DIC,DIC(0),J,Y,XMDUZ,XMB
"RTN","DVBAB1",193,0)
 Q
"RTN","DVBAB1",194,0)
FINDEXAM(ZMSG,ZIEN) ;Returns list of exams in 396.4 that are linked to ZIEN in 396.3
"RTN","DVBAB1",195,0)
 N DVBABCNT,DVBABIEN
"RTN","DVBAB1",196,0)
 S DVBABCNT=0,DVBABIEN=0
"RTN","DVBAB1",197,0)
 F  S DVBABIEN=$O(^DVB(396.4,"C",ZIEN,DVBABIEN)) Q:'DVBABIEN  D
"RTN","DVBAB1",198,0)
 .S DVBABD1=$P($G(^DVB(396.4,DVBABIEN,0)),"^",2)
"RTN","DVBAB1",199,0)
 .S DVBABD2=$P($G(^DVB(396.6,+$P($G(^DVB(396.4,DVBABIEN,0)),"^",3),0)),"^",1)  ;Name of Exam
"RTN","DVBAB1",200,0)
 .S DVBABD3=$P($G(^DVB(396.4,DVBABIEN,0)),"^",4)
"RTN","DVBAB1",201,0)
 .I DVBABD3="O" S DVBABD3="[OPEN]"
"RTN","DVBAB1",202,0)
 .I DVBABD3="C" S DVBABD3="[COMPLETE]"
"RTN","DVBAB1",203,0)
 .I DVBABD3="X" S DVBABD3="[CANCELED BY MAS]"
"RTN","DVBAB1",204,0)
 .I DVBABD3="RX" S DVBABD3="[CANCELED BY RO]"
"RTN","DVBAB1",205,0)
 .I DVBABD3="T" S DVBABD3="[TRANSFERRED OUT]"
"RTN","DVBAB1",206,0)
 .I ZIEN=DVBABD1 D
"RTN","DVBAB1",207,0)
 ..S ZMSG(DVBABCNT)=DVBABIEN_"^"_DVBABD2_" "_DVBABD3
"RTN","DVBAB1",208,0)
 ..S DVBABCNT=DVBABCNT+1
"RTN","DVBAB1",209,0)
 K DVBABCNT,DVBABIEN,ZIEN,DVBABD1,DVBABD2,DVBABD3
"RTN","DVBAB1",210,0)
 Q
"VER")
8.0^22.0
"BLD",8093,6)
^131
**END**
**END**

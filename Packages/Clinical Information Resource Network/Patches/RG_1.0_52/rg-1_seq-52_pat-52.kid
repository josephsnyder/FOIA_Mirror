Released RG*1*52 SEQ #52
Extracted from mail message
**KIDS**:RG*1.0*52^

**INSTALL NAME**
RG*1.0*52
"BLD",2576,0)
RG*1.0*52^CLINICAL INFO RESOURCE NETWORK^0^3080710^y
"BLD",2576,1,0)
^9.61A^4^4^3080710^^
"BLD",2576,1,1,0)
 
"BLD",2576,1,2,0)
DATE OF DEATH BULLETINS/EXCEPTIONS
"BLD",2576,1,3,0)
Refer to patch RG*1*52 in the FORUM Patch Module for a complete
"BLD",2576,1,4,0)
description.
"BLD",2576,4,0)
^9.64PA^^
"BLD",2576,6.3)
2
"BLD",2576,"ABNS",0)
^9.66A^^
"BLD",2576,"ABPKG")
n^^
"BLD",2576,"INID")
^y
"BLD",2576,"INIT")
RGP52PST
"BLD",2576,"KRN",0)
^9.67PA^8989.52^19
"BLD",2576,"KRN",.4,0)
.4
"BLD",2576,"KRN",.401,0)
.401
"BLD",2576,"KRN",.402,0)
.402
"BLD",2576,"KRN",.403,0)
.403
"BLD",2576,"KRN",.5,0)
.5
"BLD",2576,"KRN",.84,0)
.84
"BLD",2576,"KRN",3.6,0)
3.6
"BLD",2576,"KRN",3.8,0)
3.8
"BLD",2576,"KRN",9.2,0)
9.2
"BLD",2576,"KRN",9.8,0)
9.8
"BLD",2576,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",2576,"KRN",9.8,"NM",1,0)
RGADTP2^^0^B48194022
"BLD",2576,"KRN",9.8,"NM",2,0)
RGRSPT^^0^B13914646
"BLD",2576,"KRN",9.8,"NM",3,0)
RGRSBUL1^^0^B20578515
"BLD",2576,"KRN",9.8,"NM",4,0)
RGP52PST^^0^B5624802
"BLD",2576,"KRN",9.8,"NM",5,0)
RGEVPRG^^0^B40603844
"BLD",2576,"KRN",9.8,"NM",6,0)
RGEX01^^0^B26588821
"BLD",2576,"KRN",9.8,"NM",7,0)
RGEXHND1^^0^B37317689
"BLD",2576,"KRN",9.8,"NM",8,0)
RGHLLOG^^0^B23997530
"BLD",2576,"KRN",9.8,"NM",9,0)
RGMTETOT^^0^B27906188
"BLD",2576,"KRN",9.8,"NM",10,0)
RGSYSTAT^^0^B9080377
"BLD",2576,"KRN",9.8,"NM","B","RGADTP2",1)

"BLD",2576,"KRN",9.8,"NM","B","RGEVPRG",5)

"BLD",2576,"KRN",9.8,"NM","B","RGEX01",6)

"BLD",2576,"KRN",9.8,"NM","B","RGEXHND1",7)

"BLD",2576,"KRN",9.8,"NM","B","RGHLLOG",8)

"BLD",2576,"KRN",9.8,"NM","B","RGMTETOT",9)

"BLD",2576,"KRN",9.8,"NM","B","RGP52PST",4)

"BLD",2576,"KRN",9.8,"NM","B","RGRSBUL1",3)

"BLD",2576,"KRN",9.8,"NM","B","RGRSPT",2)

"BLD",2576,"KRN",9.8,"NM","B","RGSYSTAT",10)

"BLD",2576,"KRN",19,0)
19
"BLD",2576,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",2576,"KRN",19,"NM",1,0)
RG STATUS DISPLAY^^0
"BLD",2576,"KRN",19,"NM",2,0)
RG ADMIN USER MENU^^1^
"BLD",2576,"KRN",19,"NM","B","RG ADMIN USER MENU",2)

"BLD",2576,"KRN",19,"NM","B","RG STATUS DISPLAY",1)

"BLD",2576,"KRN",19.1,0)
19.1
"BLD",2576,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",2576,"KRN",101,0)
101
"BLD",2576,"KRN",409.61,0)
409.61
"BLD",2576,"KRN",771,0)
771
"BLD",2576,"KRN",870,0)
870
"BLD",2576,"KRN",8989.51,0)
8989.51
"BLD",2576,"KRN",8989.52,0)
8989.52
"BLD",2576,"KRN",8994,0)
8994
"BLD",2576,"KRN","B",.4,.4)

"BLD",2576,"KRN","B",.401,.401)

"BLD",2576,"KRN","B",.402,.402)

"BLD",2576,"KRN","B",.403,.403)

"BLD",2576,"KRN","B",.5,.5)

"BLD",2576,"KRN","B",.84,.84)

"BLD",2576,"KRN","B",3.6,3.6)

"BLD",2576,"KRN","B",3.8,3.8)

"BLD",2576,"KRN","B",9.2,9.2)

"BLD",2576,"KRN","B",9.8,9.8)

"BLD",2576,"KRN","B",19,19)

"BLD",2576,"KRN","B",19.1,19.1)

"BLD",2576,"KRN","B",101,101)

"BLD",2576,"KRN","B",409.61,409.61)

"BLD",2576,"KRN","B",771,771)

"BLD",2576,"KRN","B",870,870)

"BLD",2576,"KRN","B",8989.51,8989.51)

"BLD",2576,"KRN","B",8989.52,8989.52)

"BLD",2576,"KRN","B",8994,8994)

"BLD",2576,"QDEF")
^^^^NO^^^^NO^^YES
"BLD",2576,"QUES",0)
^9.62^^
"BLD",2576,"REQB",0)
^9.611^7^6
"BLD",2576,"REQB",1,0)
RG*1.0*8^2
"BLD",2576,"REQB",2,0)
RG*1.0*19^2
"BLD",2576,"REQB",3,0)
RG*1.0*49^2
"BLD",2576,"REQB",5,0)
RG*1.0*45^2
"BLD",2576,"REQB",6,0)
RG*1.0*48^2
"BLD",2576,"REQB",7,0)
RG*1.0*50^2
"BLD",2576,"REQB","B","RG*1.0*19",2)

"BLD",2576,"REQB","B","RG*1.0*45",5)

"BLD",2576,"REQB","B","RG*1.0*48",6)

"BLD",2576,"REQB","B","RG*1.0*49",3)

"BLD",2576,"REQB","B","RG*1.0*50",7)

"BLD",2576,"REQB","B","RG*1.0*8",1)

"INIT")
RGP52PST
"KRN",19,6720,-1)
0^1
"KRN",19,6720,0)
RG STATUS DISPLAY^Unresolved Exception Summary^^R^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",19,6720,1,0)
^^10^10^3080527^
"KRN",19,6720,1,1,0)
 The Unresolved Exception Summary calculates and presents the
"KRN",19,6720,1,2,0)
 following data.
"KRN",19,6720,1,3,0)
 - the number of unresolved exceptions in the CIRN HL7 EXCEPTION LOG 
"KRN",19,6720,1,4,0)
   (#991.1) file for the MPI/PD related entries in the CIRN HL7
"KRN",19,6720,1,5,0)
   EXCEPTION TYPE (#991.11) file, and
"KRN",19,6720,1,6,0)
 - the number of unique patients with exceptions.
"KRN",19,6720,1,7,0)
 
"KRN",19,6720,1,8,0)
 The Exception Handler numbers indicate how up-to-date a site is in
"KRN",19,6720,1,9,0)
 exception resolution.  This data can be useful in reducing the
"KRN",19,6720,1,10,0)
 number of exceptions.
"KRN",19,6720,25)
RGSYSTAT
"KRN",19,6720,"U")
UNRESOLVED EXCEPTION SUMMARY
"KRN",19,7188,-1)
1^2
"KRN",19,7188,0)
RG ADMIN USER MENU
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
52^3080710
"PKG",272,22,1,"PAH",1,1,0)
^^4^4^3080710
"PKG",272,22,1,"PAH",1,1,1,0)
 
"PKG",272,22,1,"PAH",1,1,2,0)
DATE OF DEATH BULLETINS/EXCEPTIONS
"PKG",272,22,1,"PAH",1,1,3,0)
Refer to patch RG*1*52 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,4,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","RGADTP2")
0^1^B48194022^B49150519
"RTN","RGADTP2",1,0)
RGADTP2 ;BIR/DLR-ADT PROCESSOR TO RETRIGGER A08 or A04 MESSAGES WITH AL/AL (COMMIT/APPLICATION) ACKNOWLEDGEMENTS - CONTINUED ;10/30/02  10:04
"RTN","RGADTP2",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**27,20,45,44,47,48,49,52**;30 Apr 99;Build 2
"RTN","RGADTP2",3,0)
DBIA ;
"RTN","RGADTP2",4,0)
 ;Reference to $$ADD^VAFCEHU1 supported by IA #2753
"RTN","RGADTP2",5,0)
 ;Reference to EDIT^VAFCPTED supported by IA #2784
"RTN","RGADTP2",6,0)
 Q
"RTN","RGADTP2",7,0)
PROCIN(ARRAY,RGLOCAL,RGER,DFN,HL) ;
"RTN","RGADTP2",8,0)
 N RGRSDFN,OTHSITE,NODE,ICN,CMORIEN,CMOR,CMORDISP,SENSTVTY,RMTDOD,LOCDOD,VAFCA,VAFCA08,HERE,BOGUS,ARAY,REP
"RTN","RGADTP2",9,0)
 S REP=$E(HL("ECH"),2)
"RTN","RGADTP2",10,0)
 S HERE=$P($$SITE^VASITE,"^",3)
"RTN","RGADTP2",11,0)
 ;if sending site is your site quit
"RTN","RGADTP2",12,0)
 Q:$G(ARRAY("MPISSITE"))=$G(HERE)
"RTN","RGADTP2",13,0)
 S ARRAY(.097)=$P($$NOW^XLFDT,".")
"RTN","RGADTP2",14,0)
 I $G(ARRAY("ICN"))'="" D
"RTN","RGADTP2",15,0)
 .S RGRSDFN=$$GETDFN^MPIF001(+ARRAY("ICN")) I +RGRSDFN<1 S RGER=RGRSDFN_" ICN#"_$G(ARRAY("ICN")) Q  ;quit and return error msg
"RTN","RGADTP2",16,0)
 .S OTHSITE=ARRAY("SENDING SITE") ;**40 REMOVED THE PLUS TO KEEP SUFFIX ON STATION# & CHANGED THE SITE TO BE SENDING SITE INSTEAD OF AUTHORITATIVE SOURCE
"RTN","RGADTP2",17,0)
 I $G(RGRSDFN)="" S RGRSDFN=$G(DFN)
"RTN","RGADTP2",18,0)
 I $G(RGRSDFN)="" S RGER="-1^DFN not defined"
"RTN","RGADTP2",19,0)
 Q:$G(RGER)
"RTN","RGADTP2",20,0)
 I $G(OTHSITE)="" S OTHSITE=""
"RTN","RGADTP2",21,0)
 S NODE=$$MPINODE^MPIFAPI(RGRSDFN)
"RTN","RGADTP2",22,0)
 S ICN=$P(NODE,"^")
"RTN","RGADTP2",23,0)
 S CMORIEN=$P(NODE,"^",3)
"RTN","RGADTP2",24,0)
 S CMOR=$$NS^XUAF4(CMORIEN)
"RTN","RGADTP2",25,0)
 S CMORDISP=$P(CMOR,"^",1)
"RTN","RGADTP2",26,0)
 S CMOR=$P(CMOR,"^",2)
"RTN","RGADTP2",27,0)
 ;
"RTN","RGADTP2",28,0)
 ;If patient is Sensitive at other site but not here send bulletin
"RTN","RGADTP2",29,0)
 I $G(ARRAY("SENSITIVITY"))'="" S SENSTVTY=$G(ARRAY("SENSITIVITY")) D
"RTN","RGADTP2",30,0)
 .N NAME S NAME=ARRAY("NAME")
"RTN","RGADTP2",31,0)
 .I '$$SENSTIVE^RGRSENS(RGRSDFN),SENSTVTY D
"RTN","RGADTP2",32,0)
 ..S ARAY("SSN")=ARRAY("SSN"),ARAY("SENDING SITE")=ARRAY("SENDING SITE")
"RTN","RGADTP2",33,0)
 ..S ARAY("SENSITIVITY USER")=ARRAY("SENSITIVITY USER"),ARAY("SENSITIVITY DATE")=ARRAY("SENSITIVITY DATE")
"RTN","RGADTP2",34,0)
 ..D SENSTIVE^RGRSBUL1(RGRSDFN,"ARAY",NAME)
"RTN","RGADTP2",35,0)
 ;
"RTN","RGADTP2",36,0)
 ;MPIC_772 - **52; Commented out Remote Date of Death Indicated section.
"RTN","RGADTP2",37,0)
 ;If patient has DATE OF DEATH (DOD) at remote site send bulletin
"RTN","RGADTP2",38,0)
 ;Ignore time if present with date.
"RTN","RGADTP2",39,0)
 ;S RMTDOD=$G(ARRAY("MPIDOD")),RMTDOD=$P(RMTDOD,".")
"RTN","RGADTP2",40,0)
 ;S DFN=RGRSDFN D DEM^VADPT
"RTN","RGADTP2",41,0)
 ;S LOCDOD=$P($P(VADM(6),"^"),".")
"RTN","RGADTP2",42,0)
 ;If there is a remote DOD but no local DOD  OR if remote DOD is different from local DOD, send bulletin
"RTN","RGADTP2",43,0)
 ;I RMTDOD D
"RTN","RGADTP2",44,0)
 ;.N NAME S NAME=ARRAY("NAME"),ARAY("SSN")=ARRAY("SSN"),ARAY("SENDING SITE")=ARRAY("SENDING SITE")
"RTN","RGADTP2",45,0)
 ;.D RMTDOD^RGRSBUL1(RGRSDFN,"ARAY",NAME,RMTDOD,LOCDOD)
"RTN","RGADTP2",46,0)
 ;K VADM
"RTN","RGADTP2",47,0)
 ;
"RTN","RGADTP2",48,0)
NOTLOC I 'RGLOCAL D
"RTN","RGADTP2",49,0)
 .;if sending site is not the CMOR AND NOT THE MPI - log update into PDR if differences exist **45 ADDED MPI
"RTN","RGADTP2",50,0)
 .I (OTHSITE)'=(CMOR)&(OTHSITE'="200M") D  Q
"RTN","RGADTP2",51,0)
 ..S VAFCA=$P($$NOW^XLFDT,".")_"^"_$$NOW^XLFDT_"^"_$G(ARRAY("SENDING SITE"))_"^"_RGRSDFN
"RTN","RGADTP2",52,0)
 ..S ARRAY(.01)=$$FREE^RGRSPARS(ARRAY("NAME")),ARRAY(.03)=$$FREE^RGRSPARS($G(ARRAY("MPIDOB")))
"RTN","RGADTP2",53,0)
 ..S ARRAY(.09)=$$FREE^RGRSPARS($G(ARRAY("SSN"))),ARRAY(.02)=$$SEX^RGRSPARS($G(ARRAY("SEX")))
"RTN","RGADTP2",54,0)
 ..S ARRAY(.2403)=$$FREE^RGRSPARS($G(ARRAY("MMN"))),ARRAY(991.01)=$P($G(ARRAY("ICN")),"V")
"RTN","RGADTP2",55,0)
 ..N ARAY M ARAY(2)=ARRAY
"RTN","RGADTP2",56,0)
 ..S VAFCA08=1  ;S BOGUS=$$ADD^VAFCEHU1(VAFCA,"ARAY") comment out by RG*1*49
"RTN","RGADTP2",57,0)
 .;if sending site is the CMOR OR MPI - synchronize data **45 ADDED MPI AND SSNV TO UPDATED FIELDS
"RTN","RGADTP2",58,0)
 .I (OTHSITE)=(CMOR)!(OTHSITE="200M") D
"RTN","RGADTP2",59,0)
 ..;**44 is there an outstanding edit in the ADT/HL7 PIVOT file for this patient for an identity element
"RTN","RGADTP2",60,0)
 ..S RGER=$$CHKPVT^RGADTP3(.ARRAY) Q:+RGER<0
"RTN","RGADTP2",61,0)
 ..N DR,ARAY2 S RGER=""
"RTN","RGADTP2",62,0)
 ..D DIFF^RGADTP3(.ARRAY,RGRSDFN,.DR,.ARRAY) ;**47
"RTN","RGADTP2",63,0)
 ..I DR'="" D
"RTN","RGADTP2",64,0)
 ...S VAFCA08=1,ARAY(2,.01)=ARRAY("NAME"),ARAY(2,.03)=$G(ARRAY("MPIDOB"))
"RTN","RGADTP2",65,0)
 ...I ARRAY("SSN")'="" S ARAY(2,.09)=$G(ARRAY("SSN")) ;**45 only set SSN to update if it isn't null
"RTN","RGADTP2",66,0)
 ...S ARAY(2,.02)=$G(ARRAY("SEX")),ARAY(2,.2403)=$G(ARRAY("MMN")),ARAY(2,994)=$G(ARRAY("MBI"))
"RTN","RGADTP2",67,0)
 ...;**48 ONLY SET SSN VERIFICATION STATUS AND PSEUDO SSN REASON IF SSN UPDATE WAS SUCCESSFUL
"RTN","RGADTP2",68,0)
 ...I $D(ARRAY("ALIAS")) M ARAY(2,1)=ARRAY("ALIAS") ;**48 ADD ALIAS TO MIX
"RTN","RGADTP2",69,0)
 ...D EDIT^VAFCPTED(RGRSDFN,"ARAY(2)",DR)
"RTN","RGADTP2",70,0)
 ...;check to see if edits were successful, if not set RGER="why it failed"
"RTN","RGADTP2",71,0)
 ...N NAME,SSN,PDOB,SEX,MMN,OLDNAME,OLDHLNAM,OLDMMN,OLDHLMMN,HLNAME,HLMMN,SSNV,MBI
"RTN","RGADTP2",72,0)
 ...S NAME=$$GET1^DIQ(2,+RGRSDFN_",",.01,"I"),PDOB=$$GET1^DIQ(2,+RGRSDFN_",",.03,"I")
"RTN","RGADTP2",73,0)
 ...S SSN=$$GET1^DIQ(2,+RGRSDFN_",",.09,"I"),SEX=$$GET1^DIQ(2,+RGRSDFN_",",.02,"I")
"RTN","RGADTP2",74,0)
 ...S MMN=$$GET1^DIQ(2,+RGRSDFN_",",.2403,"I"),MBI=$$GET1^DIQ(2,+RGRSDFN_",",994,"I")
"RTN","RGADTP2",75,0)
 ...D STDNAME^XLFNAME(.NAME,"F",.OLDNAME) S HLNAME=ARRAY("NAME") D STDNAME^XLFNAME(.HLNAME,"F",.OLDHLNAM)
"RTN","RGADTP2",76,0)
 ...I NAME'=$G(HLNAME) S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"Name field failure"
"RTN","RGADTP2",77,0)
 ...I PDOB'=$G(ARRAY("MPIDOB")) S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"DOB field failure"
"RTN","RGADTP2",78,0)
 ...;**48
"RTN","RGADTP2",79,0)
 ...I SSN["P" D
"RTN","RGADTP2",80,0)
 ....;if pseudo SSN reason field has been added to the DD then attempt to set it
"RTN","RGADTP2",81,0)
 ....N PS,ERROR,LABEL D FIELD^DID(2,.0906,"","LABEL","LABEL","ERROR") I '$D(ERROR("DIERR"))&$D(LABEL("LABEL")) D
"RTN","RGADTP2",82,0)
 .....S ARAY2(2,.0906)=$G(ARRAY(.0906)),DR=".0906;" D EDIT^VAFCPTED(RGRSDFN,"ARAY2(2)",DR)
"RTN","RGADTP2",83,0)
 .....S PS=$$GET1^DIQ(2,+RGRSDFN_",",.0906,"I")
"RTN","RGADTP2",84,0)
 .....I PS=""&(ARAY2(2,.0906)="@") Q
"RTN","RGADTP2",85,0)
 .....I PS'=ARAY2(2,.0906) S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"Pseudo SSN Reason field failure"
"RTN","RGADTP2",86,0)
 .....I PS=ARAY2(2,.0906) D
"RTN","RGADTP2",87,0)
 ......K ARAY2 N ERROR,LABEL D FIELD^DID(2,.0907,"","LABEL","LABEL","ERROR") I '$D(ERROR("DIERR"))&$D(LABEL("LABEL")) D
"RTN","RGADTP2",88,0)
 ......S ARAY2(2,.0907)=$G(ARRAY(.0907)),DR=".0907;" D EDIT^VAFCPTED(RGRSDFN,"ARAY2(2)",DR)
"RTN","RGADTP2",89,0)
 ......S SSNV=$$GET1^DIQ(2,+RGRSDFN_",",.0907,"I")
"RTN","RGADTP2",90,0)
 ......S:$G(ARRAY(.0907))="@" ARRAY(.0907)="" I SSNV'=$G(ARRAY(.0907)) S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"SSN VERIFICATION field failure"
"RTN","RGADTP2",91,0)
 ...I $G(ARRAY("SSN"))'="",SSN'=$G(ARRAY("SSN")) D
"RTN","RGADTP2",92,0)
 ....I $G(ARRAY("SSN"))="P",SSN["P" Q  ;**47 NEEDED TO CREATE PSEUDO AND DID
"RTN","RGADTP2",93,0)
 ....S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"SSN field failure" ;**45 only check if SSN is sent isn't null
"RTN","RGADTP2",94,0)
 ...I SSN=$G(ARRAY("SSN")) D
"RTN","RGADTP2",95,0)
 ....;if SSN VERIFICATION STATUS field has been added to the DD then attempt to set it
"RTN","RGADTP2",96,0)
 ....K ARAY2 N ERROR,LABEL D FIELD^DID(2,.0907,"","LABEL","LABEL","ERROR") I '$D(ERROR("DIERR"))&$D(LABEL("LABEL")) D
"RTN","RGADTP2",97,0)
 .....S ARAY2(2,.0907)=$G(ARRAY(.0907)) S DR=".0907;" D EDIT^VAFCPTED(RGRSDFN,"ARAY2(2)",DR)
"RTN","RGADTP2",98,0)
 .....S SSNV=$$GET1^DIQ(2,+RGRSDFN_",",.0907,"I")
"RTN","RGADTP2",99,0)
 .....S:$G(ARRAY(.0907))="@" ARRAY(.0907)="" I SSNV'=$G(ARRAY(.0907)) S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"SSN VERIFICATION field failure"
"RTN","RGADTP2",100,0)
 .....I SSNV'="" D
"RTN","RGADTP2",101,0)
 ......N PS,ERROR,LABEL D FIELD^DID(2,.0906,"","LABEL","LABEL","ERROR") I '$D(ERROR("DIERR"))&$D(LABEL("LABEL")) D
"RTN","RGADTP2",102,0)
 ......S ARAY2(2,.0906)=$G(ARRAY(.0906)) S DR=".0906;" D EDIT^VAFCPTED(RGRSDFN,"ARAY2(2)",DR)
"RTN","RGADTP2",103,0)
 ......S PS=$$GET1^DIQ(2,+RGRSDFN_",",.0906,"I")
"RTN","RGADTP2",104,0)
 ......I PS=""&(ARAY2(2,.0906)="@") Q
"RTN","RGADTP2",105,0)
 ......S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"Pseudo SSN Reason field failure"
"RTN","RGADTP2",106,0)
 ...I SEX'=$G(ARRAY("SEX")) S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"SEX field failure"
"RTN","RGADTP2",107,0)
 ...D STDNAME^XLFNAME(.MMN,"F",.OLDMMN) S HLMMN=ARRAY("MMN") D STDNAME^XLFNAME(.HLMMN,"F",.OLDHLMMN)
"RTN","RGADTP2",108,0)
 ...I MMN'=$G(HLMMN) S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"MOTHER'S MAIDEN NAME field failure"
"RTN","RGADTP2",109,0)
 ...;**REMOVED MBI FROM PATCH 45 PUT BACK IN **47
"RTN","RGADTP2",110,0)
 ...I MBI'=$G(ARRAY("MBI")) D
"RTN","RGADTP2",111,0)
 ....Q:MBI=""&($G(ARRAY("MBI"))="@")  ;**47 "" AND @ ARE THE SAME
"RTN","RGADTP2",112,0)
 ....S RGER=$S($G(RGER)'="":$G(RGER)_REP,1:"-1^")_"MULTIPLE BIRTH INDICATOR field failure"
"RTN","RGADTP2",113,0)
 ...;send the updated fields to the MPI to synch site with MPI
"RTN","RGADTP2",114,0)
 ...I HL("ETN")'="A31" S ZTSAVE("DFN")="",ZTRTN="MPISYN^RGADTPC",ZTDESC="Sending Synchronized Patient Data to MPI...",ZTIO="RG QUEUE",ZTDTH=$H D ^%ZTLOAD
"RTN","RGADTP2",115,0)
 ...;**45 ^ don't trigger A31 sync message if A31 was being processed-- ack to a31 will sync id elements on MPI
"RTN","RGADTP2",116,0)
 Q
"RTN","RGEVPRG")
0^5^B40603844^B46886438
"RTN","RGEVPRG",1,0)
RGEVPRG ;BAY/ALS-OPTIONS TO PURGE MPI/PD EXCEPTIONS ;08/23/99
"RTN","RGEVPRG",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**3,12,19,32,35,43,44,50,52**;30 Apr 99;Build 2
"RTN","RGEVPRG",3,0)
 ;
"RTN","RGEVPRG",4,0)
MAIN ;
"RTN","RGEVPRG",5,0)
 ;Q:($D(^TMP("RGEXC")))!($D(^TMP("RGEXC2")))
"RTN","RGEVPRG",6,0)
 L +^RGHL7(991.1):0 I '$T Q
"RTN","RGEVPRG",7,0)
 L -^RGHL7(991.1)
"RTN","RGEVPRG",8,0)
 L +^RGHL7(991.1,"RG PURGE EXCEPTION"):5 E  Q
"RTN","RGEVPRG",9,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","RGEVPRG",10,0)
 S $P(^RGSITE(991.8,1,"EXCPRG"),"^",1)=$$NOW^XLFDT
"RTN","RGEVPRG",11,0)
 S $P(^RGSITE(991.8,1,"EXCPRG"),"^",3)="R"
"RTN","RGEVPRG",12,0)
 ;D PROC  ;**52 Module is obsolete
"RTN","RGEVPRG",13,0)
 D PRGDUP
"RTN","RGEVPRG",14,0)
 D PRG30
"RTN","RGEVPRG",15,0)
 D PRGZZ
"RTN","RGEVPRG",16,0)
 S $P(^RGSITE(991.8,1,"EXCPRG"),"^",2)=$$NOW^XLFDT
"RTN","RGEVPRG",17,0)
 S $P(^RGSITE(991.8,1,"EXCPRG"),"^",3)="C"
"RTN","RGEVPRG",18,0)
 L -^RGHL7(991.1,"RG PURGE EXCEPTION")
"RTN","RGEVPRG",19,0)
 Q
"RTN","RGEVPRG",20,0)
PRGPAT ;Purge by Patient
"RTN","RGEVPRG",21,0)
 W !
"RTN","RGEVPRG",22,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: "
"RTN","RGEVPRG",23,0)
 D ^DIC K DIC G:Y<0 QUIT  S RGDFN=+Y
"RTN","RGEVPRG",24,0)
 S EXCT="",FLAG=0
"RTN","RGEVPRG",25,0)
 F  S EXCT=$O(^RGHL7(991.1,"ADFN",EXCT)) Q:EXCT=""  D
"RTN","RGEVPRG",26,0)
 . I $D(^RGHL7(991.1,"ADFN",EXCT,RGDFN)) S FLAG=1 Q
"RTN","RGEVPRG",27,0)
 I FLAG=0 W !,"There are no exceptions on file for this patient." G PRGPAT
"RTN","RGEVPRG",28,0)
 I $$IFLOCAL^MPIF001(RGDFN) W !,"This patient does not have a national ICN assigned, do not purge." Q
"RTN","RGEVPRG",29,0)
 S DFN=RGDFN D DEM^VADPT
"RTN","RGEVPRG",30,0)
 S DIR(0)="YA",DIR("B")="YES"
"RTN","RGEVPRG",31,0)
 S DIR("A")="Are you sure you want to purge all exceptions on file for "_VADM(1)_"?   YES//  "
"RTN","RGEVPRG",32,0)
 D ^DIR Q:$D(DIRUT)  I Y>0 D
"RTN","RGEVPRG",33,0)
 . S EXCT="",CNT=0
"RTN","RGEVPRG",34,0)
 . F  S EXCT=$O(^RGHL7(991.1,"ADFN",EXCT)) Q:'EXCT  D
"RTN","RGEVPRG",35,0)
 .. S IEN=0
"RTN","RGEVPRG",36,0)
 .. F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCT,RGDFN,IEN)) Q:'IEN  D
"RTN","RGEVPRG",37,0)
 ... S IEN2=0
"RTN","RGEVPRG",38,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCT,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",39,0)
 .... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",40,0)
 .... I NUM=1 S DIK="^RGHL7(991.1,",DA=IEN D ^DIK K DIK,DA S CNT=CNT+1
"RTN","RGEVPRG",41,0)
 .... E  I NUM>1 D DEL
"RTN","RGEVPRG",42,0)
 . W !,"All exceptions purged for "_VADM(1)_"   DFN: "_RGDFN
"RTN","RGEVPRG",43,0)
 K EXCT,DFN,FLAG,VADM,CNT,IEN,IEN2,NUM,RGDFN,Y
"RTN","RGEVPRG",44,0)
QUIT Q
"RTN","RGEVPRG",45,0)
 ;
"RTN","RGEVPRG",46,0)
PRGDT ; Purge by Date
"RTN","RGEVPRG",47,0)
 W !!,"Enter a date for the purge. All exceptions on file, on or before that date, will be deleted."
"RTN","RGEVPRG",48,0)
 K DIR,DIRUT,DTOUT,DUOUT
"RTN","RGEVPRG",49,0)
 S DIR(0)="DA^:DT:EPX",DIR("A")="Enter Date for Purge: "
"RTN","RGEVPRG",50,0)
 D ^DIR K DIR Q:$D(DIRUT)
"RTN","RGEVPRG",51,0)
 S PURDT=Y
"RTN","RGEVPRG",52,0)
 S PDATE=$$FMTE^XLFDT(PURDT)
"RTN","RGEVPRG",53,0)
 S DIR(0)="YA",DIR("B")="YES"
"RTN","RGEVPRG",54,0)
 S DIR("A")="Are you sure you want to purge all exceptions on file dated on or before "_PDATE_"?  YES//  "
"RTN","RGEVPRG",55,0)
 D ^DIR Q:$D(DIRUT)  I Y>0 D
"RTN","RGEVPRG",56,0)
 . S EXCDT="",CNT=0
"RTN","RGEVPRG",57,0)
 . F  S EXCDT=$O(^RGHL7(991.1,"AD",EXCDT)) Q:'EXCDT  D
"RTN","RGEVPRG",58,0)
 .. I ($P(EXCDT,".",1)=PURDT)!($P(EXCDT,".",1)<PURDT) D
"RTN","RGEVPRG",59,0)
 ... S IEN=0
"RTN","RGEVPRG",60,0)
 ... F  S IEN=$O(^RGHL7(991.1,"AD",EXCDT,IEN)) Q:'IEN  D
"RTN","RGEVPRG",61,0)
 .... S NUM="" S NUM=$P($G(^RGHL7(991.1,IEN,1,0)),"^",4) Q:NUM<1
"RTN","RGEVPRG",62,0)
 .... S CNT=CNT+NUM
"RTN","RGEVPRG",63,0)
 .... S DIK="^RGHL7(991.1,",DA=IEN
"RTN","RGEVPRG",64,0)
 .... D ^DIK K DIK,DA
"RTN","RGEVPRG",65,0)
 I CNT=0 W !,"There are no exceptions dated on or before "_PDATE_", no data to purge."
"RTN","RGEVPRG",66,0)
 E  I CNT>0 W !,CNT_" exceptions, dated on or before "_PDATE_" have been purged!"
"RTN","RGEVPRG",67,0)
 K PDATE,PURDT,EXCDT,CNT,IEN,NUM,Y
"RTN","RGEVPRG",68,0)
 Q
"RTN","RGEVPRG",69,0)
PRG30   ; Purge Exceptions over 30 days old
"RTN","RGEVPRG",70,0)
 S TODAY=""
"RTN","RGEVPRG",71,0)
 S TODAY=$$NOW^XLFDT D
"RTN","RGEVPRG",72,0)
 . S EXCDT="",CNT=0,DIFF=""
"RTN","RGEVPRG",73,0)
 . F  S EXCDT=$O(^RGHL7(991.1,"AD",EXCDT)) Q:'EXCDT  D
"RTN","RGEVPRG",74,0)
 .. S DIFF=$$FMDIFF^XLFDT(TODAY,EXCDT)
"RTN","RGEVPRG",75,0)
 .. I DIFF>30 D
"RTN","RGEVPRG",76,0)
 ... S IEN=0
"RTN","RGEVPRG",77,0)
 ... F  S IEN=$O(^RGHL7(991.1,"AD",EXCDT,IEN)) Q:'IEN  D
"RTN","RGEVPRG",78,0)
 .... S NUM="" S NUM=$P($G(^RGHL7(991.1,IEN,1,0)),"^",4) Q:'NUM
"RTN","RGEVPRG",79,0)
 .... S IEN2=0
"RTN","RGEVPRG",80,0)
 .... F  S IEN2=$O(^RGHL7(991.1,IEN,1,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",81,0)
 ..... S STAT=""
"RTN","RGEVPRG",82,0)
 ..... S STAT=$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",5)
"RTN","RGEVPRG",83,0)
 ..... ; Only delete PROCESSED exceptions
"RTN","RGEVPRG",84,0)
 ..... I (STAT>0)!(STAT="") D
"RTN","RGEVPRG",85,0)
 ...... I NUM>1 D DEL
"RTN","RGEVPRG",86,0)
 ...... E  I NUM=1 D
"RTN","RGEVPRG",87,0)
 ....... S CNT=CNT+NUM
"RTN","RGEVPRG",88,0)
 ....... S DIK="^RGHL7(991.1,",DA=IEN
"RTN","RGEVPRG",89,0)
 ....... D ^DIK K DIK,DA
"RTN","RGEVPRG",90,0)
 K DIFF,TODAY,EXCDT,CNT,IEN,IEN2,NUM,STAT
"RTN","RGEVPRG",91,0)
 Q
"RTN","RGEVPRG",92,0)
PRGEXC ; Purge by Exception Type
"RTN","RGEVPRG",93,0)
 ;**52 This module was obsolete before 52; just adding comment
"RTN","RGEVPRG",94,0)
 ;S DIC="^RGHL7(991.11,",DIC(0)="QEAM"
"RTN","RGEVPRG",95,0)
 ;S DIC("A")="Enter an exception type to purge: "
"RTN","RGEVPRG",96,0)
 ;D ^DIC K DIC G:Y<200 QUIT  S EXCTYP=+Y,ETYPE=X
"RTN","RGEVPRG",97,0)
 ;S DIR(0)="YA",DIR("B")="YES"
"RTN","RGEVPRG",98,0)
 ;S DIR("A")="*WARNING* This will permanently delete all "_ETYPE_" exceptions. Are you sure you want to do this?  YES//  "
"RTN","RGEVPRG",99,0)
 ;D ^DIR Q:$D(DIRUT)  I Y>0 D
"RTN","RGEVPRG",100,0)
 ;. S CNT=0,IEN=""
"RTN","RGEVPRG",101,0)
 ;. F  S IEN=$O(^RGHL7(991.1,"AC",EXCTYP,IEN)) Q:'IEN  D
"RTN","RGEVPRG",102,0)
 ;.. S IEN2=0
"RTN","RGEVPRG",103,0)
 ;.. F  S IEN2=$O(^RGHL7(991.1,"AC",EXCTYP,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",104,0)
 ;... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",105,0)
 ;... I NUM=1 S DIK="^RGHL7(991.1,",DA=IEN D ^DIK K DIK,DA S CNT=CNT+1
"RTN","RGEVPRG",106,0)
 ;... E  I NUM>1 D DEL
"RTN","RGEVPRG",107,0)
 ;I CNT=0 W !,"There are no "_ETYPE_" exceptions on file."
"RTN","RGEVPRG",108,0)
 ;E  I CNT>0 W !,CNT_" "_ETYPE_" Exceptions purged!"
"RTN","RGEVPRG",109,0)
 ;K ETYPE,CNT,IEN,IEN2,NUM,X,Y
"RTN","RGEVPRG",110,0)
 Q  ;**52;if module accidentally called, should quit instead of falling into next module.
"RTN","RGEVPRG",111,0)
PRGDUP ;Purge Duplicate Entries; retain most recent for all except types.
"RTN","RGEVPRG",112,0)
 ;**50 through remainder of module.
"RTN","RGEVPRG",113,0)
 S EXCTYP="",CNT=0
"RTN","RGEVPRG",114,0)
 K ^TMP("RGEVDUP",$J)
"RTN","RGEVPRG",115,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"ADFN",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEVPRG",116,0)
 . S RGDFN=""
"RTN","RGEVPRG",117,0)
 . F  S RGDFN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN)) Q:'RGDFN  D
"RTN","RGEVPRG",118,0)
 .. S IEN=0
"RTN","RGEVPRG",119,0)
 .. F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN)) Q:'IEN  D
"RTN","RGEVPRG",120,0)
 ... S IEN2=0
"RTN","RGEVPRG",121,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",122,0)
 .... I $P($G(^RGHL7(991.1,IEN,1,IEN2,0)),"^",5)=1 K ^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN,IEN2) Q  ;exception processed
"RTN","RGEVPRG",123,0)
 .... S EXCDT=$P($G(^RGHL7(991.1,IEN,0)),"^",3) ;incoming date
"RTN","RGEVPRG",124,0)
 .... I '$D(^TMP("RGEVDUP",$J,RGDFN,EXCTYP)) D  Q
"RTN","RGEVPRG",125,0)
 ..... S ^TMP("RGEVDUP",$J,RGDFN,EXCTYP)=EXCDT_"^"_IEN_"^"_IEN2
"RTN","RGEVPRG",126,0)
 .... I $D(^TMP("RGEVDUP",$J,RGDFN,EXCTYP)) D  ;duplicate exists; compare incoming to previous.
"RTN","RGEVPRG",127,0)
 ..... S OLDNODE=^TMP("RGEVDUP",$J,RGDFN,EXCTYP)
"RTN","RGEVPRG",128,0)
 ..... S OLDDT=$P(OLDNODE,"^"),OLDIEN=$P(OLDNODE,"^",2),OLDIEN2=$P(OLDNODE,"^",3)
"RTN","RGEVPRG",129,0)
 ..... I EXCDT>OLDDT D  Q  ;incoming date greater than previous? purge old, keep new.
"RTN","RGEVPRG",130,0)
 ...... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",131,0)
 ...... I NUM=1 S DIK="^RGHL7(991.1,",DA=OLDIEN D ^DIK K DIK,DA
"RTN","RGEVPRG",132,0)
 ...... I NUM>1 D
"RTN","RGEVPRG",133,0)
 ....... S DA(1)=OLDIEN,DA=OLDIEN2
"RTN","RGEVPRG",134,0)
 ....... S DIK="^RGHL7(991.1,"_DA(1)_",1," D ^DIK K DIK,DA
"RTN","RGEVPRG",135,0)
 ...... S ^TMP("RGEVDUP",$J,RGDFN,EXCTYP)=EXCDT_"^"_IEN_"^"_IEN2
"RTN","RGEVPRG",136,0)
 ..... ;
"RTN","RGEVPRG",137,0)
 ..... I OLDDT>EXCDT!(OLDDT=EXCDT) D  ;previous date greater or equal incoming? purge new, keep old.
"RTN","RGEVPRG",138,0)
 ...... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",139,0)
 ...... I NUM=1 S DIK="^RGHL7(991.1,",DA=IEN D ^DIK K DIK,DA
"RTN","RGEVPRG",140,0)
 ...... I NUM>1 D DEL
"RTN","RGEVPRG",141,0)
 ...... ;
"RTN","RGEVPRG",142,0)
 K CNT,EXCDT,EXCTYP,IEN,IEN2,NUM,OLDDT,OLDIEN,OLDIEN2,OLDNODE,RGDFN,RGDT,^TMP("RGEVDUP")
"RTN","RGEVPRG",143,0)
 Q
"RTN","RGEVPRG",144,0)
 ;
"RTN","RGEVPRG",145,0)
PRGZZ ;Purge if name field is null (incomplete record)
"RTN","RGEVPRG",146,0)
 ;Purge if -9 node exists, this indicates the record has been merged.
"RTN","RGEVPRG",147,0)
 S EXCTYP="",CNT=""
"RTN","RGEVPRG",148,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"ADFN",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEVPRG",149,0)
 . S RGDFN=""
"RTN","RGEVPRG",150,0)
 . F  S RGDFN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN)) Q:'RGDFN  D
"RTN","RGEVPRG",151,0)
 .. S IEN=0
"RTN","RGEVPRG",152,0)
 .. F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN)) Q:'IEN  D
"RTN","RGEVPRG",153,0)
 ... S IEN2=0
"RTN","RGEVPRG",154,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",155,0)
 .... S DFN=RGDFN D DEM^VADPT
"RTN","RGEVPRG",156,0)
 .... I VADM(1)=""!($D(^DPT(RGDFN,-9))) D
"RTN","RGEVPRG",157,0)
 ..... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",158,0)
 ..... I NUM=1 S DIK="^RGHL7(991.1,",DA=IEN D ^DIK K DIK,DA
"RTN","RGEVPRG",159,0)
 ..... E  I NUM>1 D DEL
"RTN","RGEVPRG",160,0)
 K EXCTYP,RGDFN,DFN,IEN,IEN2,NUM,VADM
"RTN","RGEVPRG",161,0)
 Q
"RTN","RGEVPRG",162,0)
DEL ;
"RTN","RGEVPRG",163,0)
 S CNT=CNT+1
"RTN","RGEVPRG",164,0)
 S DA(1)=IEN,DA=IEN2
"RTN","RGEVPRG",165,0)
 S DIK="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","RGEVPRG",166,0)
 D ^DIK K DIK,DA
"RTN","RGEVPRG",167,0)
 Q
"RTN","RGEVPRG",168,0)
PROC ;Set these exception types to PROCESSED if they have a national ICN
"RTN","RGEVPRG",169,0)
 ;**52 The PROC module is obsolete and is no longer being called.
"RTN","RGEVPRG",170,0)
 ;209 - Required field(s) missing for patient sent to MPI,
"RTN","RGEVPRG",171,0)
 ;227 - Multiple ICNs, 213 - SSN Match Failed, 214 - Name Doesn't Match
"RTN","RGEVPRG",172,0)
 ;S EXCTYP=""
"RTN","RGEVPRG",173,0)
 ;S HOME=$$SITE^VASITE()
"RTN","RGEVPRG",174,0)
 ;F  S EXCTYP=$O(^RGHL7(991.1,"AC",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEVPRG",175,0)
 ;. I (EXCTYP=209)!(EXCTYP=227)!(EXCTYP=213)!(EXCTYP=214) D  ;**43
"RTN","RGEVPRG",176,0)
 ;.. S IEN=0
"RTN","RGEVPRG",177,0)
 ;.. F  S IEN=$O(^RGHL7(991.1,"AC",EXCTYP,IEN)) Q:'IEN  D
"RTN","RGEVPRG",178,0)
 ;... S IEN2=0,ICN="",RGDFN=""
"RTN","RGEVPRG",179,0)
 ;... F  S IEN2=$O(^RGHL7(991.1,"AC",EXCTYP,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",180,0)
 ;.... S RGDFN=$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",4) Q:'RGDFN
"RTN","RGEVPRG",181,0)
 ;.... S ICN=+$$GETICN^MPIF001(RGDFN)
"RTN","RGEVPRG",182,0)
 ;.... I $E(ICN,1,3)'=$E($P(HOME,"^",3),1,3)&(ICN>0) D
"RTN","RGEVPRG",183,0)
 ;..... L +^RGHL7(991.1,IEN):10
"RTN","RGEVPRG",184,0)
 ;..... S DA(1)=IEN,DA=IEN2,DR="6///"_1,DIE="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","RGEVPRG",185,0)
 ;..... D ^DIE K DIE,DA,DR
"RTN","RGEVPRG",186,0)
 ;..... L -^RGHL7(991.1,IEN)
"RTN","RGEVPRG",187,0)
 ;K EXCTYP,HOME,ICN,IEN,IEN2,RGDFN
"RTN","RGEVPRG",188,0)
 Q
"RTN","RGEX01")
0^6^B26588821^B34733554
"RTN","RGEX01",1,0)
RGEX01 ;BAY/ALS-LIST MANAGER FOR MPI/PD EXCEPTIONS ;10/07/99
"RTN","RGEX01",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**3,12,19,23,43,45,47,48,52**;30 Apr 99;Build 2
"RTN","RGEX01",3,0)
 ;
"RTN","RGEX01",4,0)
 ;Reference to MAIN^VAFCPDAT supported by IA #3299
"RTN","RGEX01",5,0)
EN ; -- main entry point for RG EXCPT SUMMARY
"RTN","RGEX01",6,0)
 N STDT,ENDDT,PRGSTAT,XFLAG,NOW,%,X,%H,%I,INDT,RUN,INDTT
"RTN","RGEX01",7,0)
 S XFLAG=0 D NOW^%DTC S NOW=%
"RTN","RGEX01",8,0)
 S STDT=$P($G(^RGSITE(991.8,1,"EXCPRG")),"^",1),INDT=STDT
"RTN","RGEX01",9,0)
 I $D(STDT) S STDT=$$FMTE^XLFDT(STDT,1)
"RTN","RGEX01",10,0)
 S PRGSTAT=$P($G(^RGSITE(991.8,1,"EXCPRG")),"^",3)
"RTN","RGEX01",11,0)
 ;status shows 'running' but lock shows 'not running';**47
"RTN","RGEX01",12,0)
 I PRGSTAT="R" D
"RTN","RGEX01",13,0)
 .L +^RGHL7(991.1,"RG PURGE EXCEPTION"):0 I $T D  ;can get lock
"RTN","RGEX01",14,0)
 ..L +^RGSITE(991.8):10
"RTN","RGEX01",15,0)
 ..S DIE="^RGSITE(991.8,",DA=1,DR="42///@"
"RTN","RGEX01",16,0)
 ..D ^DIE K DA,DIE,DR ;delete old status
"RTN","RGEX01",17,0)
 ..L -^RGSITE(991.8)
"RTN","RGEX01",18,0)
 ..S PRGSTAT=""
"RTN","RGEX01",19,0)
 .L -^RGHL7(991.1,"RG PURGE EXCEPTION")
"RTN","RGEX01",20,0)
 I PRGSTAT="" D
"RTN","RGEX01",21,0)
 . W $C(7)
"RTN","RGEX01",22,0)
 . W !!,"The MPI/PD Exception Purge process has not been run."
"RTN","RGEX01",23,0)
 . ;**48 NO LONGER A CHOICE
"RTN","RGEX01",24,0)
 . W !!,"The MPI/PD Exception Purge process will now run."
"RTN","RGEX01",25,0)
 . W !,"Please come back to this option in five minutes."
"RTN","RGEX01",26,0)
 . W !!,"Please contact IRM to schedule the MPI/PD EXCEPTION PURGE"
"RTN","RGEX01",27,0)
 . W !,"[RG EXCEPTION PURGE] option via TaskMan with a frequency of once an hour."
"RTN","RGEX01",28,0)
 . S XFLAG=1 D QUEPRG
"RTN","RGEX01",29,0)
 L +^RGHL7(991.1,"RG PURGE EXCEPTION"):0 I '$T W $C(7),!!,"The MPI/PD Exception Purge process is currently running.",!,"Please try this option again in five minutes." S XFLAG=1 G EXIT
"RTN","RGEX01",30,0)
 L -^RGHL7(991.1,"RG PURGE EXCEPTION")
"RTN","RGEX01",31,0)
 S RUN=0
"RTN","RGEX01",32,0)
 I $G(PRGSTAT)="C" D
"RTN","RGEX01",33,0)
 . I $P(INDT,".")<$P(NOW,".") S RUN=1 ;RAN A PREVIOUS DAY
"RTN","RGEX01",34,0)
 . I $P(INDT,".")=$P(NOW,".") D
"RTN","RGEX01",35,0)
 .. S INDTT=$E($P(INDT,".",2),1,4),INDTT=INDTT+101
"RTN","RGEX01",36,0)
 .. I INDTT<$E($P(NOW,".",2),1,4) S RUN=1
"RTN","RGEX01",37,0)
 . Q:RUN=0
"RTN","RGEX01",38,0)
 . ;** if job ran more than 1 hour ago, run it now.
"RTN","RGEX01",39,0)
 . W !!,"The MPI/PD Exception Purge process last ran "_STDT_"."
"RTN","RGEX01",40,0)
 . W !!,"The MPI/PD Exception Purge process will now run."
"RTN","RGEX01",41,0)
 . W !,"Please come back to this option in five minutes."
"RTN","RGEX01",42,0)
 . W !!,"Please contact IRM to verify that the MPI/PD EXCEPTION PURGE "
"RTN","RGEX01",43,0)
 . W !,"[RG EXCEPTION PURGE] option is scheduled to run via TaskMan"
"RTN","RGEX01",44,0)
 . W !,"with a frequency of once an hour."
"RTN","RGEX01",45,0)
 . S XFLAG=1 D QUEPRG
"RTN","RGEX01",46,0)
 I XFLAG=1 G EXIT
"RTN","RGEX01",47,0)
 K RGANS
"RTN","RGEX01",48,0)
 D WAIT^DICD
"RTN","RGEX01",49,0)
 D EN^VALM("RG EXCPT SUMMARY")
"RTN","RGEX01",50,0)
 Q
"RTN","RGEX01",51,0)
 ;
"RTN","RGEX01",52,0)
HDR ; -- header code
"RTN","RGEX01",53,0)
 S VALMHDR(1)="MPI/PD Exception Handling"
"RTN","RGEX01",54,0)
 S VALMHDR(2)=""
"RTN","RGEX01",55,0)
 Q
"RTN","RGEX01",56,0)
 ;
"RTN","RGEX01",57,0)
INIT ; -- init variables and list array
"RTN","RGEX01",58,0)
 I '$D(RGSORT) S RGSORT="SD"
"RTN","RGEX01",59,0)
 K @VALMAR
"RTN","RGEX01",60,0)
 I RGSORT="SD" D DTLIST^RGEXHND1
"RTN","RGEX01",61,0)
 E  I RGSORT="ST" D EXCLST^RGEXHND1
"RTN","RGEX01",62,0)
 E  I RGSORT="SN" D PATLST^RGEXHND1
"RTN","RGEX01",63,0)
 E  I RGSORT="VT" D SELTYP^RGEXHND1
"RTN","RGEX01",64,0)
 Q
"RTN","RGEX01",65,0)
 ;
"RTN","RGEX01",66,0)
SORT ;
"RTN","RGEX01",67,0)
 D INIT
"RTN","RGEX01",68,0)
 S VALMBCK="R"
"RTN","RGEX01",69,0)
 Q
"RTN","RGEX01",70,0)
HELP ; -- help code
"RTN","RGEX01",71,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","RGEX01",72,0)
 Q
"RTN","RGEX01",73,0)
HLPPRG ;
"RTN","RGEX01",74,0)
 W !,"Enter Y(YES) to run the MPI/PD Exception Purge process now."
"RTN","RGEX01",75,0)
 W !!,"Enter N(NO) to go directly into the MPI/PD Exception Handling option."
"RTN","RGEX01",76,0)
 Q
"RTN","RGEX01",77,0)
 ;
"RTN","RGEX01",78,0)
EXIT ; -- exit code
"RTN","RGEX01",79,0)
 K VADM,RGDFN,RGNM,RGSORT,RGSSN,STAT,STRING,NDX,NM,IEN,IEN2,X,DATA,CNT,EXCTYPE,ETYPE,^TMP("RGEXC",$J),^TMP("RGEX01",$J)
"RTN","RGEX01",80,0)
 Q
"RTN","RGEX01",81,0)
QUEPRG S ZTRTN="MAIN^RGEVPRG",ZTDESC="PURGE ZZ*, OVER 30 DAY AND DUPLICATE RECORDS FROM THE CIRN HL7 EXCEPTION LOG FILE"
"RTN","RGEX01",82,0)
 D NOW^%DTC
"RTN","RGEX01",83,0)
 S ZTIO="",ZTDTH=%
"RTN","RGEX01",84,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","RGEX01",85,0)
 D ^%ZTLOAD
"RTN","RGEX01",86,0)
 D HOME^%ZIS K IO("Q")
"RTN","RGEX01",87,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%
"RTN","RGEX01",88,0)
 Q
"RTN","RGEX01",89,0)
 ;
"RTN","RGEX01",90,0)
EXPND ; -- expand code
"RTN","RGEX01",91,0)
 Q
"RTN","RGEX01",92,0)
 ;
"RTN","RGEX01",93,0)
CUREX() ;Are there any patients in the CIRN HL7 EXCEPTION LOG file (#991.1)
"RTN","RGEX01",94,0)
 ;that are NOT PROCESSED for specific exception types?
"RTN","RGEX01",95,0)
 ;     Return RGEX:
"RTN","RGEX01",96,0)
 ;If RGEX=3 both unprocessed and Primary View Reject exceptions exist
"RTN","RGEX01",97,0)
 ;If RGEX=2 only Primary View Reject exceptions exist
"RTN","RGEX01",98,0)
 ;If RGEX=1 only unprocessed exceptions exist
"RTN","RGEX01",99,0)
 ;If RGEX=0 no unprocessed exceptions exist
"RTN","RGEX01",100,0)
 ;
"RTN","RGEX01",101,0)
 N EXCTYP,RG1,RG2,RGEX
"RTN","RGEX01",102,0)
 S EXCTYP="",(RG1,RG2,RGEX)=0
"RTN","RGEX01",103,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"ASTAT","0",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEX01",104,0)
 .I (EXCTYP=234)!(EXCTYP=218) S RG1=1 ;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGEX01",105,0)
 .I (EXCTYP=234) S RG2=1 ;Primary View Reject
"RTN","RGEX01",106,0)
 I (RG1=1),(RG2=1) S RGEX=3 ;Send both messages
"RTN","RGEX01",107,0)
 I (RG1=1),(RG2=0) S RGEX=1 ;Only unresolved exceptions exist
"RTN","RGEX01",108,0)
 I (RG1=0),(RG2=1) S RGEX=2 ;Only Primary View Reject exceptions exist
"RTN","RGEX01",109,0)
 Q RGEX
"RTN","RGEX01",110,0)
 ;
"RTN","RGEX01",111,0)
PROC ; For a given patient, set exceptions STATUS to PROCESSED.
"RTN","RGEX01",112,0)
 ;**52 The PROC module is obsolete and is no longer being called.
"RTN","RGEX01",113,0)
 ; DFN must be defined
"RTN","RGEX01",114,0)
 ;Q:'$D(DFN)
"RTN","RGEX01",115,0)
 ;S EXCTYP=""
"RTN","RGEX01",116,0)
 ;S HOME=$$SITE^VASITE()
"RTN","RGEX01",117,0)
 ;F  S EXCTYP=$O(^RGHL7(991.1,"ADFN",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEX01",118,0)
 ;. S RGDFN="",ICN=""
"RTN","RGEX01",119,0)
 ;. F  S RGDFN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN)) Q:'RGDFN  D
"RTN","RGEX01",120,0)
 ;.. I DFN=RGDFN D
"RTN","RGEX01",121,0)
 ;... S ICN=+$$GETICN^MPIF001(DFN)
"RTN","RGEX01",122,0)
 ;... ;Only set to PROCESSED if patient has national ICN.
"RTN","RGEX01",123,0)
 ;... I $E(ICN,1,3)'=$E($P(HOME,"^",3),1,3)&(ICN>0) D
"RTN","RGEX01",124,0)
 ;.... ;Exclude Death exceptions (215-217); they must be processed manually.
"RTN","RGEX01",125,0)
 ;.... ;Exclude 218 Potential Matches Returned exception **43
"RTN","RGEX01",126,0)
 ;.... I (EXCTYP>218)!(EXCTYP<215) D
"RTN","RGEX01",127,0)
 ;..... S IEN=0
"RTN","RGEX01",128,0)
 ;..... F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN)) Q:'IEN  D
"RTN","RGEX01",129,0)
 ;...... S IEN2=0
"RTN","RGEX01",130,0)
 ;...... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEX01",131,0)
 ;....... L +^RGHL7(991.1,IEN):10
"RTN","RGEX01",132,0)
 ;....... S DA(1)=IEN,DA=IEN2,DR="6///"_1,DIE="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","RGEX01",133,0)
 ;....... D ^DIE K DIE,DA,DR
"RTN","RGEX01",134,0)
 ;....... L -^RGHL7(991.1,IEN)
"RTN","RGEX01",135,0)
 ;K IEN,IEN2,RGDFN,EXCTYP,ICN
"RTN","RGEX01",136,0)
 Q
"RTN","RGEX01",137,0)
PDAT ;
"RTN","RGEX01",138,0)
 K DIRUT
"RTN","RGEX01",139,0)
 W !,"This report prints MPI/PD Data for a selected patient.  The"
"RTN","RGEX01",140,0)
 W !,"information displayed includes the Integration Control Number"
"RTN","RGEX01",141,0)
 W !,"(ICN), patient identity information, and Treating Facility list."
"RTN","RGEX01",142,0)
 W !!,"The information is pulled from the Patient (#2) file and the"
"RTN","RGEX01",143,0)
 W !,"Treating Facility List (#391.91) file."
"RTN","RGEX01",144,0)
 ;
"RTN","RGEX01",145,0)
ASK ;Ask for PATIENT
"RTN","RGEX01",146,0)
 I $D(DIRUT) G QUIT
"RTN","RGEX01",147,0)
 W !!,"Patient lookup can be done by Patient Name/SSN or by ICN.",!
"RTN","RGEX01",148,0)
 N DFN,ICN
"RTN","RGEX01",149,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: ",D="SSN^AICN^B^BS^BS5"
"RTN","RGEX01",150,0)
 D MIX^DIC1 K DIC
"RTN","RGEX01",151,0)
 G:Y<0 QUIT
"RTN","RGEX01",152,0)
 S DFN=+Y
"RTN","RGEX01",153,0)
 D MAIN^VAFCPDAT
"RTN","RGEX01",154,0)
 G ASK
"RTN","RGEX01",155,0)
 Q
"RTN","RGEX01",156,0)
QUIT ;
"RTN","RGEX01",157,0)
 K DFN,ICN,D,Y,HOME
"RTN","RGEXHND1")
0^7^B37317689^B37958809
"RTN","RGEXHND1",1,0)
RGEXHND1 ;BAY/ALS-MPI/PD EXCEPTION HANDLING UTILITY ;10/08/99
"RTN","RGEXHND1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**3,12,19,23,43,45,52**;30 Apr 99;Build 2
"RTN","RGEXHND1",3,0)
DTLIST ;List exceptions by date
"RTN","RGEXHND1",4,0)
 K ^TMP("RGEXC",$J)
"RTN","RGEXHND1",5,0)
 I '$D(RGBG) S VALMBG=1
"RTN","RGEXHND1",6,0)
 ;**45 list exception 234 first regardless of date - Primary View Reject
"RTN","RGEXHND1",7,0)
 S EXCDT="",EXCTYP=234,(CNT,IEN)=0
"RTN","RGEXHND1",8,0)
 F  S IEN=$O(^RGHL7(991.1,"ASTAT","0",EXCTYP,IEN)) Q:'IEN  D
"RTN","RGEXHND1",9,0)
 .S IEN2=0
"RTN","RGEXHND1",10,0)
 .F  S IEN2=$O(^RGHL7(991.1,"ASTAT","0",EXCTYP,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEXHND1",11,0)
 ..S EXCDT=$P(^RGHL7(991.1,IEN,0),"^",3)
"RTN","RGEXHND1",12,0)
 ..D ADDREC
"RTN","RGEXHND1",13,0)
 S EXCDT="",EXCTYP=""
"RTN","RGEXHND1",14,0)
 F  S EXCDT=$O(^RGHL7(991.1,"AD",EXCDT)) Q:'EXCDT  D
"RTN","RGEXHND1",15,0)
 . S IEN=0
"RTN","RGEXHND1",16,0)
 . F  S IEN=$O(^RGHL7(991.1,"AD",EXCDT,IEN)) Q:'IEN  D
"RTN","RGEXHND1",17,0)
 .. S NUM="" S NUM=$P($G(^RGHL7(991.1,IEN,1,0)),"^",4) Q:NUM<1  D
"RTN","RGEXHND1",18,0)
 ... S IEN2=0
"RTN","RGEXHND1",19,0)
 ... F  S IEN2=$O(^RGHL7(991.1,IEN,1,IEN2)) Q:'IEN2  D
"RTN","RGEXHND1",20,0)
 .... S EXCTYP=$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",3)
"RTN","RGEXHND1",21,0)
 ....;don't include 234 below; those were done first (above).
"RTN","RGEXHND1",22,0)
 .... I EXCTYP=218 D ADDREC  ;**45;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGEXHND1",23,0)
 K I,NUM,EXCDT,EXCTYP,RGBG
"RTN","RGEXHND1",24,0)
 IF CNT<1 D NDATA
"RTN","RGEXHND1",25,0)
 Q
"RTN","RGEXHND1",26,0)
 ;
"RTN","RGEXHND1",27,0)
NDATA ; There is no data matching the criteria
"RTN","RGEXHND1",28,0)
 S CNT=CNT+1,STRING=""
"RTN","RGEXHND1",29,0)
 S STRING=$$SETSTR^VALM1("There were no exceptions found.",STRING,5,35)
"RTN","RGEXHND1",30,0)
 S ^TMP("RGEXC",$J,CNT,0)=STRING
"RTN","RGEXHND1",31,0)
 S ^TMP("RGEXC",$J,"IDX",CNT,CNT)=""
"RTN","RGEXHND1",32,0)
 S VALMCNT=CNT
"RTN","RGEXHND1",33,0)
 Q
"RTN","RGEXHND1",34,0)
EXCLST ;List exceptions by type
"RTN","RGEXHND1",35,0)
 K ^TMP("RGEXC",$J)
"RTN","RGEXHND1",36,0)
 S CNT=0,EXCDT="",EXCTYP=""
"RTN","RGEXHND1",37,0)
 I '$D(RGBG) S VALMBG=1
"RTN","RGEXHND1",38,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"AC",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEXHND1",39,0)
 . I (EXCTYP=234)!(EXCTYP=218) D  ;**45;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGEXHND1",40,0)
 .. S IEN=0
"RTN","RGEXHND1",41,0)
 .. F  S IEN=$O(^RGHL7(991.1,"AC",EXCTYP,IEN)) Q:'IEN  D
"RTN","RGEXHND1",42,0)
 ... S NUM="" S NUM=$P($G(^RGHL7(991.1,IEN,1,0)),"^",4) Q:NUM<1  D
"RTN","RGEXHND1",43,0)
 .... S IEN2=0
"RTN","RGEXHND1",44,0)
 .... F  S IEN2=$O(^RGHL7(991.1,"AC",EXCTYP,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEXHND1",45,0)
 ..... S EXCDT=$P($G(^RGHL7(991.1,IEN,0)),"^",3) Q:'EXCDT
"RTN","RGEXHND1",46,0)
 ..... D ADDREC
"RTN","RGEXHND1",47,0)
 IF CNT<1 D NDATA
"RTN","RGEXHND1",48,0)
 K RGBG
"RTN","RGEXHND1",49,0)
 Q
"RTN","RGEXHND1",50,0)
PATLST ;List exceptions by patient
"RTN","RGEXHND1",51,0)
 K ^TMP("RGEXC",$J),^TMP("RGEX01",$J)
"RTN","RGEXHND1",52,0)
 S CNT=0,EXCDT="",EXCTYP="",NDX=0,NAME=""
"RTN","RGEXHND1",53,0)
 I '$D(RGBG) S VALMBG=1
"RTN","RGEXHND1",54,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"ADFN",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEXHND1",55,0)
 . I (EXCTYP=234)!(EXCTYP=218) D  ;**45;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGEXHND1",56,0)
 .. S DFN=""
"RTN","RGEXHND1",57,0)
 .. F  S DFN=$O(^RGHL7(991.1,"ADFN",EXCTYP,DFN)) Q:'DFN  D
"RTN","RGEXHND1",58,0)
 ... S IEN=0
"RTN","RGEXHND1",59,0)
 ... F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCTYP,DFN,IEN)) Q:'IEN  D
"RTN","RGEXHND1",60,0)
 .... S IEN2=0
"RTN","RGEXHND1",61,0)
 .... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCTYP,DFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEXHND1",62,0)
 ..... S EXCDT=$P($G(^RGHL7(991.1,IEN,0)),"^",3) Q:'EXCDT
"RTN","RGEXHND1",63,0)
 ..... D DEM^VADPT S NAME=VADM(1) Q:NAME=""
"RTN","RGEXHND1",64,0)
 ..... S NDX=NDX+1
"RTN","RGEXHND1",65,0)
 ..... S ^TMP("RGEX01",$J,NAME,NDX)=$G(VADM(1))_"^"_IEN_"^"_IEN2_"^"_EXCTYP_"^"_EXCDT
"RTN","RGEXHND1",66,0)
 D PATTMP
"RTN","RGEXHND1",67,0)
 IF CNT<1 D NDATA
"RTN","RGEXHND1",68,0)
 K DFN,RGBG
"RTN","RGEXHND1",69,0)
 Q
"RTN","RGEXHND1",70,0)
PATTMP ;
"RTN","RGEXHND1",71,0)
 S NM=""
"RTN","RGEXHND1",72,0)
 F  S NM=$O(^TMP("RGEX01",$J,NM)) Q:NM=""  D
"RTN","RGEXHND1",73,0)
 . S NDX=0
"RTN","RGEXHND1",74,0)
 . F  S NDX=$O(^TMP("RGEX01",$J,NM,NDX)) Q:'NDX  D
"RTN","RGEXHND1",75,0)
 .. S IEN=$P(^TMP("RGEX01",$J,NM,NDX),"^",2)
"RTN","RGEXHND1",76,0)
 .. S IEN2=$P(^TMP("RGEX01",$J,NM,NDX),"^",3)
"RTN","RGEXHND1",77,0)
 .. S EXCTYP=$P(^TMP("RGEX01",$J,NM,NDX),"^",4)
"RTN","RGEXHND1",78,0)
 .. S EXCDT=$P(^TMP("RGEX01",$J,NM,NDX),"^",5)
"RTN","RGEXHND1",79,0)
 .. D ADDREC
"RTN","RGEXHND1",80,0)
 K NDX,NM,NAME
"RTN","RGEXHND1",81,0)
 Q
"RTN","RGEXHND1",82,0)
SELTYP ; List all exceptions of type selected by user
"RTN","RGEXHND1",83,0)
 S EXCTYPE="",FLAG=0,ETYPE=""
"RTN","RGEXHND1",84,0)
 I '$D(RGBG) S VALMBG=1
"RTN","RGEXHND1",85,0)
 K DIR,Y,DIC
"RTN","RGEXHND1",86,0)
 S DIR("A")="Enter an exception type to view: "
"RTN","RGEXHND1",87,0)
 S DIR(0)="SAM^218:Potential Matches Returned;234:Primary View Reject" ;**43;**45;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGEXHND1",88,0)
 S DIR("?")="^D HLPSEL^RGEXHND1"
"RTN","RGEXHND1",89,0)
 D ^DIR
"RTN","RGEXHND1",90,0)
 I Y<1 S RGSORT="SD" D SORT^RGEX01  Q
"RTN","RGEXHND1",91,0)
 Q:$D(DUOUT)!$D(DTOUT)
"RTN","RGEXHND1",92,0)
 S EXCTYPE=+Y,ETYPE=$P(^RGHL7(991.11,EXCTYPE,10),"^",1)
"RTN","RGEXHND1",93,0)
 I (EXCTYPE=234)!(EXCTYPE=218) S FLAG=1 ;**43;**45;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGEXHND1",94,0)
 I FLAG=1 D ADDSEL
"RTN","RGEXHND1",95,0)
 E  I FLAG=0 D
"RTN","RGEXHND1",96,0)
 . W !,"Not a valid selection."
"RTN","RGEXHND1",97,0)
 . D SELTYP
"RTN","RGEXHND1",98,0)
 K FLAG,Y,DIR,DIC,DTOUT,DUOUT,RGBG
"RTN","RGEXHND1",99,0)
 Q
"RTN","RGEXHND1",100,0)
ADDSEL ;called by SELTYP
"RTN","RGEXHND1",101,0)
 K ^TMP("RGEXC",$J)
"RTN","RGEXHND1",102,0)
 S CNT=0,EXCDT="",EXCTYP=""
"RTN","RGEXHND1",103,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"AC",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEXHND1",104,0)
 . I EXCTYP=EXCTYPE D
"RTN","RGEXHND1",105,0)
 .. S IEN=0
"RTN","RGEXHND1",106,0)
 .. F  S IEN=$O(^RGHL7(991.1,"AC",EXCTYP,IEN)) Q:'IEN  D
"RTN","RGEXHND1",107,0)
 ... S IEN2=0
"RTN","RGEXHND1",108,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"AC",EXCTYP,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEXHND1",109,0)
 .... S EXCDT=$P($G(^RGHL7(991.1,IEN,0)),"^",3) Q:'EXCDT  ;**43
"RTN","RGEXHND1",110,0)
 .... D ADDREC
"RTN","RGEXHND1",111,0)
 I CNT<1 D
"RTN","RGEXHND1",112,0)
 . W !,"There are no "_ETYPE
"RTN","RGEXHND1",113,0)
 . W !,"exceptions that need processing."
"RTN","RGEXHND1",114,0)
 . D SELTYP
"RTN","RGEXHND1",115,0)
 Q
"RTN","RGEXHND1",116,0)
HLPSEL ;
"RTN","RGEXHND1",117,0)
 D FULL^VALM1
"RTN","RGEXHND1",118,0)
 ;W !,"The following exception types are handled by this option:"
"RTN","RGEXHND1",119,0)
 ;W !,"Potential Matches Returned",?50,"(218)"
"RTN","RGEXHND1",120,0)
 ;W !,"Primary View Reject",?50,"(234)"
"RTN","RGEXHND1",121,0)
 S VALMBCK="R"
"RTN","RGEXHND1",122,0)
 Q
"RTN","RGEXHND1",123,0)
ADDREC ;
"RTN","RGEXHND1",124,0)
 S ETEXT="",RGDFN="",ICN="",RGNM="",STAT="",DOD=""
"RTN","RGEXHND1",125,0)
 S ETEXT=$P($G(^RGHL7(991.11,EXCTYP,10)),"^",1)
"RTN","RGEXHND1",126,0)
 S RGDFN=$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",4) Q:'RGDFN
"RTN","RGEXHND1",127,0)
 S STAT=$P($G(^RGHL7(991.1,IEN,1,IEN2,0)),"^",5)
"RTN","RGEXHND1",128,0)
 S ICN=+$$GETICN^MPIF001(RGDFN)
"RTN","RGEXHND1",129,0)
 S HOME=$$SITE^VASITE()
"RTN","RGEXHND1",130,0)
 I (STAT<1)!(STAT="") D
"RTN","RGEXHND1",131,0)
 .;Only list exceptions that are Not Processed
"RTN","RGEXHND1",132,0)
 .; only list patients with local ICN, or for exceptions 234 or 218;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGEXHND1",133,0)
 . I $E(ICN,1,3)=$E($P(HOME,"^",3),1,3)!(ICN<0)!(EXCTYP=234)!(EXCTYP=218) D  ;**43,**45,**52
"RTN","RGEXHND1",134,0)
 .. S DFN=RGDFN D DEM^VADPT
"RTN","RGEXHND1",135,0)
 .. S RGNM=VADM(1)
"RTN","RGEXHND1",136,0)
 .. S RGSSN=$P($G(VADM(2)),"^",1)
"RTN","RGEXHND1",137,0)
 .. S DOB=$G(VADM(3)) I DOB="" S DOB="^"
"RTN","RGEXHND1",138,0)
 .. S DOD=$P($P($G(VADM(6)),"^",2),"@",1)
"RTN","RGEXHND1",139,0)
 .. S EXDATE=$P($$FMTE^XLFDT(EXCDT,2),"@",1)
"RTN","RGEXHND1",140,0)
 .. S CNT=CNT+1
"RTN","RGEXHND1",141,0)
 .. S STRING=""
"RTN","RGEXHND1",142,0)
 .. I ICN<0 S ICN=""
"RTN","RGEXHND1",143,0)
 .. S STRING=$$SETSTR^VALM1(CNT,STRING,1,4)
"RTN","RGEXHND1",144,0)
 .. S STRING=$$SETSTR^VALM1($E(RGNM,1,22),STRING,6,21)
"RTN","RGEXHND1",145,0)
 .. S STRING=$$SETSTR^VALM1(RGSSN,STRING,28,10)
"RTN","RGEXHND1",146,0)
 .. S STRING=$$SETSTR^VALM1(EXDATE,STRING,39,8)
"RTN","RGEXHND1",147,0)
 .. S STRING=$$SETSTR^VALM1(ETEXT,STRING,49,32)
"RTN","RGEXHND1",148,0)
 .. S ^TMP("RGEXC",$J,CNT,0)=STRING
"RTN","RGEXHND1",149,0)
 .. S ^TMP("RGEXC",$J,"IDX",CNT,CNT)=""
"RTN","RGEXHND1",150,0)
 .. S ^TMP("RGEXC",$J,CNT,"DATA")=RGNM_"^"_RGSSN_"^"_$P($$FMTE^XLFDT(EXCDT),"@",1)_"^"_ETEXT_"^"_DFN_"^"_ICN_"^"_DOB_"^"_STAT_"^"_IEN_"^"_IEN2_"^"_CNT_"^"_DOD
"RTN","RGEXHND1",151,0)
 S VALMCNT=CNT
"RTN","RGEXHND1",152,0)
 K RGDFN,RGNM,RGSSN,EXDATE,ETEXT,ICN,DOB,STAT,VADM,HOME,STRING,DOD
"RTN","RGEXHND1",153,0)
 Q
"RTN","RGEXHND1",154,0)
SELECT ;
"RTN","RGEXHND1",155,0)
 I $G(STRING)["no exceptions found" D SORT^RGEX01  Q
"RTN","RGEXHND1",156,0)
 N VALMY
"RTN","RGEXHND1",157,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","RGEXHND1",158,0)
 I '$D(VALMY) Q
"RTN","RGEXHND1",159,0)
 S VALMCNT=CNT
"RTN","RGEXHND1",160,0)
 S DATA="",CNT=""
"RTN","RGEXHND1",161,0)
 S CNT=$O(VALMY(0))
"RTN","RGEXHND1",162,0)
 S DATA=$G(^TMP("RGEXC",$J,CNT,"DATA"))
"RTN","RGEXHND1",163,0)
 I '$D(DATA) S CNT=0 Q
"RTN","RGEXHND1",164,0)
 D CLEAN^VALM10
"RTN","RGEXHND1",165,0)
 D EN^RGEX03(DATA)
"RTN","RGEXHND1",166,0)
 I RGSORT="VT" D
"RTN","RGEXHND1",167,0)
 . K @VALMAR
"RTN","RGEXHND1",168,0)
 . D ADDSEL
"RTN","RGEXHND1",169,0)
 E  I RGSORT'="VT" D SORT^RGEX01
"RTN","RGEXHND1",170,0)
 ;
"RTN","RGEXHND1",171,0)
 Q
"RTN","RGEXHND1",172,0)
QUIT ;
"RTN","RGHLLOG")
0^8^B23997530^B22489065
"RTN","RGHLLOG",1,0)
RGHLLOG ;CAIRO/DKM-LOG MESSAGE PROCESSING INFO ;09/04/98
"RTN","RGHLLOG",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**1,3,11,13,18,19,25,45,52**;30 Apr 99;Build 2
"RTN","RGHLLOG",3,0)
 ;
"RTN","RGHLLOG",4,0)
 ;Reference to ^HLMA("C" supported by IA #3244
"RTN","RGHLLOG",5,0)
 ;=================================================================
"RTN","RGHLLOG",6,0)
 ; Log information about message processing and exceptions
"RTN","RGHLLOG",7,0)
 ; in CIRN HL7 Exception Log file.
"RTN","RGHLLOG",8,0)
 ;=================================================================
"RTN","RGHLLOG",9,0)
 ; Start time for run log
"RTN","RGHLLOG",10,0)
START(RGMSG,RGDC,RGPARAM) ;
"RTN","RGHLLOG",11,0)
 ;This entry point starts the log process in the CIRN HL7 EXCEPTION LOG
"RTN","RGHLLOG",12,0)
 ;file (#991.1), if the (#6) MINIMAL EXCEPTION LOGGING? field in
"RTN","RGHLLOG",13,0)
 ;File #990.8 is set to 0.
"RTN","RGHLLOG",14,0)
 ; Input: Required
"RTN","RGHLLOG",15,0)
 ;   RGMSG - IEN of message entry in File #773, usually HLMTIEN
"RTN","RGHLLOG",16,0)
 ;        Optional
"RTN","RGHLLOG",17,0)
 ;   RGDC - Event Class, associated with an entry in File #
"RTN","RGHLLOG",18,0)
 ;   RGPARAM - reprocessing routine
"RTN","RGHLLOG",19,0)
 S U="^"
"RTN","RGHLLOG",20,0)
 K RGLOG
"RTN","RGHLLOG",21,0)
 S RGLOG(3)=$G(RGMSG),RGLOG(5)=$G(RGDC),RGLOG(4)=$G(RGPARAM),RGLOG(1)=$$NOW^XLFDT
"RTN","RGHLLOG",22,0)
 I '$P(^RGSITE("COR",1,0),U,8) S RGLOG=$$CREATE
"RTN","RGHLLOG",23,0)
 Q
"RTN","RGHLLOG",24,0)
 ; Create a log entry
"RTN","RGHLLOG",25,0)
CREATE() Q:$G(RGLOG) RGLOG
"RTN","RGHLLOG",26,0)
 L +^RGHL7(991.1,0):10
"RTN","RGHLLOG",27,0)
 S RGLOG=$O(^RGHL7(991.1,$C(32)),-1)+1
"RTN","RGHLLOG",28,0)
 S:$G(RGLOG(1))="" RGLOG(1)=$$NOW^XLFDT
"RTN","RGHLLOG",29,0)
 S RGLOG(3)=$S($G(RGLOG(3))=0:0,$G(HL("MID"))="":"",1:$$IEN773($G(HL("MID"))))
"RTN","RGHLLOG",30,0)
 S (DA,X)=RGLOG,DIC="^RGHL7(991.1,",DIC(0)="L",DLAYGO=991.1,DIC("DR")="1///"_$G(RGLOG(1))_";3////"_$G(RGLOG(3))_";5///"_$G(RGLOG(5))_";4////"_$G(RGLOG(4)) K DD,DO D FILE^DICN K DIC,DA,X,DLAYGO
"RTN","RGHLLOG",31,0)
 L -^RGHL7(991.1,0)
"RTN","RGHLLOG",32,0)
 Q RGLOG
"RTN","RGHLLOG",33,0)
 ; Log time run completed
"RTN","RGHLLOG",34,0)
STOP(RGQUIT) ;
"RTN","RGHLLOG",35,0)
 ;This entry point completes the logging process
"RTN","RGHLLOG",36,0)
 ; Input: required
"RTN","RGHLLOG",37,0)
 ;    RGQUIT - 0 for success and 1 for failure
"RTN","RGHLLOG",38,0)
 ;
"RTN","RGHLLOG",39,0)
 Q:'$G(RGLOG)
"RTN","RGHLLOG",40,0)
 L +^RGHL7(991.1,RGLOG):10
"RTN","RGHLLOG",41,0)
 S DIE="^RGHL7(991.1,",DR="1.5///NOW;1.6///^S X=$G(RGQUIT)",DA=RGLOG D ^DIE K DIE,DA,DR
"RTN","RGHLLOG",42,0)
 L -^RGHL7(991.1,RGLOG)
"RTN","RGHLLOG",43,0)
 K RGLOG,RGQUIT,X,Y,DIC,DIE
"RTN","RGHLLOG",44,0)
 Q
"RTN","RGHLLOG",45,0)
 ; Log unclassified exception (old entry point)
"RTN","RGHLLOG",46,0)
ERR(RGERR,RGSEV) ;
"RTN","RGHLLOG",47,0)
 D EXC(18,RGERR)
"RTN","RGHLLOG",48,0)
 S RGQUIT=$G(RGQUIT)!$G(RGSEV)
"RTN","RGHLLOG",49,0)
 Q
"RTN","RGHLLOG",50,0)
 ; Log an exception
"RTN","RGHLLOG",51,0)
EXC(RGEXC,RGERR,RGDFN,MSGID,STATNUM) ;
"RTN","RGHLLOG",52,0)
 ;This entry point logs exceptions in the CIRN HL7 EXCEPTION LOG
"RTN","RGHLLOG",53,0)
 ;file (#991.1)
"RTN","RGHLLOG",54,0)
 ; Input: Required
"RTN","RGHLLOG",55,0)
 ;   RGEXC - Exception type in File #991.11
"RTN","RGHLLOG",56,0)
 ;   RGERR - Supplemental text
"RTN","RGHLLOG",57,0)
 ;        Optional
"RTN","RGHLLOG",58,0)
 ;   RGDFN - IEN in the PATIENT file (#2)
"RTN","RGHLLOG",59,0)
 ;   MSGID - message id of the HL7 message where the exception was encountered (optional)
"RTN","RGHLLOG",60,0)
 ;   STATNUM - station # of site that encountered the error (optional) - if not defined then the local site is assumed, using $$SITE^VASITE
"RTN","RGHLLOG",61,0)
 ;
"RTN","RGHLLOG",62,0)
 I (RGEXC=215)!(RGEXC=216)!(RGEXC=217) Q  ;**52 until MPIFBT3 call eliminates these exception types
"RTN","RGHLLOG",63,0)
 I $L($G(HL("MID"))) Q:$$INVEXC(HL("MID"))  ; is the exception valid?
"RTN","RGHLLOG",64,0)
 N RGI,RGZ
"RTN","RGHLLOG",65,0)
 S U="^"
"RTN","RGHLLOG",66,0)
 S:RGEXC[U RGERR=$P(RGEXC,U,2,999),RGEXC=+RGEXC
"RTN","RGHLLOG",67,0)
 S:RGEXC'=+RGEXC RGERR=RGEXC,RGEXC=18
"RTN","RGHLLOG",68,0)
 S:'$D(^RGHL7(991.11,RGEXC)) RGEXC=18
"RTN","RGHLLOG",69,0)
 L +^RGHL7(991.11,RGEXC):10
"RTN","RGHLLOG",70,0)
 S RGZ=$G(^RGHL7(991.11,RGEXC,0))
"RTN","RGHLLOG",71,0)
 S:$L(RGZ) $P(^RGHL7(991.11,RGEXC,0),U,5)=$P(RGZ,U,5)+1
"RTN","RGHLLOG",72,0)
 S:$P(RGZ,U,2)>1 RGQUIT=1
"RTN","RGHLLOG",73,0)
 L -^RGHL7(991.11,RGEXC)
"RTN","RGHLLOG",74,0)
 S RGLOG=$$CREATE
"RTN","RGHLLOG",75,0)
 L +^RGHL7(991.1,RGLOG):10
"RTN","RGHLLOG",76,0)
 S RGI=$O(^RGHL7(991.1,RGLOG,1,$C(32)),-1)+1
"RTN","RGHLLOG",77,0)
 S RGERR=$E($G(RGERR),1,250)
"RTN","RGHLLOG",78,0)
 S DIC="^RGHL7(991.1,"_RGLOG_",1,"
"RTN","RGHLLOG",79,0)
 S X=RGI,DA(1)=RGLOG,DIC(0)="FL",DLAYGO=991.12,DIC("P")=$P(^DD(991.1,2,0),"^",2)
"RTN","RGHLLOG",80,0)
 D ^DIC
"RTN","RGHLLOG",81,0)
 S DIE=DIC
"RTN","RGHLLOG",82,0)
 K DIC,DA,DR,DLAYGO
"RTN","RGHLLOG",83,0)
 S STAT=0
"RTN","RGHLLOG",84,0)
 S DIC="3.8",DIC(0)="Z",X="MPIF EXCEPTIONS" D ^DIC K DIC
"RTN","RGHLLOG",85,0)
 S RGMG=$P($G(Y),"^",1)
"RTN","RGHLLOG",86,0)
 I $P(^RGHL7(991.11,RGEXC,0),U,4)=RGMG S STAT=1
"RTN","RGHLLOG",87,0)
 S DA(1)=RGLOG,DA=RGI,DR="2///"_$G(RGEXC)_";3///"_$S($G(RGDFN):"`"_RGDFN,1:"")_";6///"_$G(STAT)_";10///"_$G(RGERR)
"RTN","RGHLLOG",88,0)
 D ^DIE K DIE,DA,DR
"RTN","RGHLLOG",89,0)
 L -^RGHL7(991.1,RGLOG)
"RTN","RGHLLOG",90,0)
 S RGI=$P(RGZ,U,3),RGZ=$P(RGZ,U,4)
"RTN","RGHLLOG",91,0)
 ;
"RTN","RGHLLOG",92,0)
 ;If the action type is for the MPI Exception Handler, send exception to the handler and quit
"RTN","RGHLLOG",93,0)
 I (RGI=3) D SENDMPI^RGHLLOG1($G(RGEXC),$G(RGERR),$G(RGDFN),$G(MSGID),$G(STATNUM)) Q
"RTN","RGHLLOG",94,0)
 ;
"RTN","RGHLLOG",95,0)
 Q:'RGI!'RGZ
"RTN","RGHLLOG",96,0)
 ;quit and don't send messages for exception types that are now being
"RTN","RGHLLOG",97,0)
 ;handled through the MPI/PD Exception Handling option.
"RTN","RGHLLOG",98,0)
 Q:RGEXC=234!(RGEXC=218)  ;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGHLLOG",99,0)
 S DIC="^XMB(3.8,",DIC(0)="NZ",X="`"_RGZ D ^DIC K DIC Q:+Y<1  S RGZ=$P(Y,U,2) K Y
"RTN","RGHLLOG",100,0)
 Q:RGZ=""!$P($G(^RGSITE("COR",1,0)),U,7)
"RTN","RGHLLOG",101,0)
 S RGERR=$$SHORT(RGEXC,RGERR),RGZ="G."_RGZ
"RTN","RGHLLOG",102,0)
 I RGI=2 D ALERT^RGRSUTL2(RGERR,RGZ) Q
"RTN","RGHLLOG",103,0)
 D MAIL^RGRSUTL2(RGERR,RGZ,"MPI/PD Exception: "_$$SHORT(RGEXC),"MPI/PD exception notification")
"RTN","RGHLLOG",104,0)
 Q
"RTN","RGHLLOG",105,0)
 ;
"RTN","RGHLLOG",106,0)
INVEXC(RGMID) ; determine if this exception needs to be sent to MPI/PD
"RTN","RGHLLOG",107,0)
 ; personnel via FORUM. Return 1 to avoid messaging to FORUM, else 0.
"RTN","RGHLLOG",108,0)
 ; IA#:3244 is applied in this functionality
"RTN","RGHLLOG",109,0)
 N RGFLG,RGIEN S RGFLG=1
"RTN","RGHLLOG",110,0)
 S RGIEN=$$IEN773(RGMID) Q:'RGIEN RGFLG
"RTN","RGHLLOG",111,0)
 S RGIEN("SND")=$$GET1^DIQ(773,RGIEN_",",13)
"RTN","RGHLLOG",112,0)
 S RGIEN("REC")=$$GET1^DIQ(773,RGIEN_",",14)
"RTN","RGHLLOG",113,0)
 ; check the sending application (fld:13, 0;11) & the receiving
"RTN","RGHLLOG",114,0)
 ; application (fld:14, 0;12) to see if they are related to the MPI/PD
"RTN","RGHLLOG",115,0)
 ; project.
"RTN","RGHLLOG",116,0)
 I RGIEN("SND")]""!(RGIEN("REC")]"") D  Q RGFLG
"RTN","RGHLLOG",117,0)
 .S RGFLG=$$APP(RGIEN("SND")) Q:'RGFLG
"RTN","RGHLLOG",118,0)
 .S RGFLG=$$APP(RGIEN("REC"))
"RTN","RGHLLOG",119,0)
 .Q
"RTN","RGHLLOG",120,0)
 ; Only if the sending/receiving applications cannot be determined from
"RTN","RGHLLOG",121,0)
 ; the data in their respective fields, do I check the MSH multiple for
"RTN","RGHLLOG",122,0)
 ; the MSH segment. I identify the sending/receiving application from
"RTN","RGHLLOG",123,0)
 ; this segment. 
"RTN","RGHLLOG",124,0)
 E  D
"RTN","RGHLLOG",125,0)
 .N RG,RG1,RGMSH,RGFS
"RTN","RGHLLOG",126,0)
 .D GETS^DIQ(773,RGIEN_",",200,,"RGMSH") ;check MSH mult for snd/rec app
"RTN","RGHLLOG",127,0)
 .Q:'($D(RGMSH)\10)  ; no data in "MSH" multiple for file 773
"RTN","RGHLLOG",128,0)
 .S RGIEN=RGIEN_",",RG="RGMSH(773,"""_RGIEN_""","_200_")"
"RTN","RGHLLOG",129,0)
 .S RG1=0 F  S RG1=$O(@RG@(RG1)) Q:RG1'>0  D  Q:$E($G(@RG@(RG1)),1,3)="MSH"
"RTN","RGHLLOG",130,0)
 ..I $E($G(@RG@(RG1)),1,3)="MSH" D
"RTN","RGHLLOG",131,0)
 ...S RG(0)=$G(@RG@(RG1)),RGFS=$E(RG(0),4)
"RTN","RGHLLOG",132,0)
 ...S:$P(RG(0),RGFS,3)]"" RGFLG=$$APP($P(RG(0),RGFS,3)) Q:'RGFLG
"RTN","RGHLLOG",133,0)
 ...S:$P(RG(0),RGFS,5)]"" RGFLG=$$APP($P(RG(0),RGFS,5))
"RTN","RGHLLOG",134,0)
 ...Q
"RTN","RGHLLOG",135,0)
 ..Q
"RTN","RGHLLOG",136,0)
 .Q
"RTN","RGHLLOG",137,0)
 Q RGFLG
"RTN","RGHLLOG",138,0)
APP(X) ; check if the sending/receiving application is relevant to the
"RTN","RGHLLOG",139,0)
 ; MPI/PD team.  Returns 1 if a non-relevant namespace, else 0
"RTN","RGHLLOG",140,0)
 I $E(X,1,2)="RG"!($E(X,1,2)="VA")!($E(X,1,3)="MPI") Q 0
"RTN","RGHLLOG",141,0)
 Q 1
"RTN","RGHLLOG",142,0)
 ;
"RTN","RGHLLOG",143,0)
IEN773(RGMID) ; find the ien of the record in the HL7 MESSAGE ADMINISTRATION
"RTN","RGHLLOG",144,0)
 ; (#773) file based on the Message ID.  Input: Message ID
"RTN","RGHLLOG",145,0)
 ; Output: null, no record in 773, else 773 record ien.  IA#: 3244
"RTN","RGHLLOG",146,0)
 Q:$G(RGMID)="" ""
"RTN","RGHLLOG",147,0)
 Q $O(^HLMA("C",RGMID,0))
"RTN","RGHLLOG",148,0)
 ;
"RTN","RGHLLOG",149,0)
SHORT(RGEXC,RGTXT) ;
"RTN","RGHLLOG",150,0)
 ; Retrieve short text description of exception
"RTN","RGHLLOG",151,0)
 Q $G(^RGHL7(991.11,+RGEXC,10))_$S($G(RGTXT)="":"",1:": "_RGTXT)
"RTN","RGHLLOG",152,0)
 ;
"RTN","RGMTETOT")
0^9^B27906188^B28007355
"RTN","RGMTETOT",1,0)
RGMTETOT ;BIR/CML-Compile Totals for Site Exceptions ;11/15/01
"RTN","RGMTETOT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**20,30,43,45,52**;30 Apr 99;Build 2
"RTN","RGMTETOT",3,0)
 ;
"RTN","RGMTETOT",4,0)
 ;Reference to ^DPT("AICNL" supported by IA #2070
"RTN","RGMTETOT",5,0)
 ;
"RTN","RGMTETOT",6,0)
 ;Variable RGHLMQ cannot be killed in this routine, it is needed for the remote query
"RTN","RGMTETOT",7,0)
 ;
"RTN","RGMTETOT",8,0)
 ;Use this routine to compile totals of a site's exceptions in file #991.1
"RTN","RGMTETOT",9,0)
 S DUMP=0 G START
"RTN","RGMTETOT",10,0)
 ;
"RTN","RGMTETOT",11,0)
DUMP1 ;Use this call to dump all data in ascii format for table
"RTN","RGMTETOT",12,0)
 S DUMP=1 G START
"RTN","RGMTETOT",13,0)
 ;
"RTN","RGMTETOT",14,0)
DUMP2 ;Use this call to dump data in ascii format for table - just for exceptions sites have to deal with
"RTN","RGMTETOT",15,0)
 S DUMP=2
"RTN","RGMTETOT",16,0)
 ;
"RTN","RGMTETOT",17,0)
START ;
"RTN","RGMTETOT",18,0)
 ;do purge of any dups for POTENTIAL MATCH Exceptions
"RTN","RGMTETOT",19,0)
 K TYPEARR,^XTMP("RGMT","HLMQETOT")
"RTN","RGMTETOT",20,0)
 S ^XTMP("RGMT",0)=$$FMADD^XLFDT(DT,30)_"^"_$$NOW^XLFDT_"^MPI/PD Maintenance Data"
"RTN","RGMTETOT",21,0)
 D PURGE
"RTN","RGMTETOT",22,0)
 ;create type array from file 991.11
"RTN","RGMTETOT",23,0)
 S TYPE=233 F  S TYPE=$O(^RGHL7(991.11,TYPE)) Q:'TYPE  I TYPE'=218 S TYPEARR(TYPE)=0 ;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGMTETOT",24,0)
 ;
"RTN","RGMTETOT",25,0)
 ;start loop
"RTN","RGMTETOT",26,0)
 S TYPE=233 F  S TYPE=$O(^RGHL7(991.1,"AC",TYPE)) Q:'TYPE  D  ;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGMTETOT",27,0)
 .Q:TYPE=218
"RTN","RGMTETOT",28,0)
 .S IEN1=0 F  S IEN1=$O(^RGHL7(991.1,"AC",TYPE,IEN1)) Q:'IEN1  D
"RTN","RGMTETOT",29,0)
 ..S IEN2=0 F  S IEN2=$O(^RGHL7(991.1,"AC",TYPE,IEN1,IEN2)) Q:'IEN2  D
"RTN","RGMTETOT",30,0)
 ...I '$D(^RGHL7(991.1,IEN1,1,IEN2,0)) Q
"RTN","RGMTETOT",31,0)
 ...S STAT=$P(^RGHL7(991.1,IEN1,1,IEN2,0),"^",5) I STAT<1 S TYPEARR(TYPE)=TYPEARR(TYPE)+1
"RTN","RGMTETOT",32,0)
 ;
"RTN","RGMTETOT",33,0)
PRT ;
"RTN","RGMTETOT",34,0)
 S GRAND=0
"RTN","RGMTETOT",35,0)
 S SITENM=$P($$SITE^VASITE(),"^",2),$P(LN,"-",81)=""
"RTN","RGMTETOT",36,0)
 D NOW^%DTC S RUNDT=$$FMTE^XLFDT($E(%,1,12))
"RTN","RGMTETOT",37,0)
 ;
"RTN","RGMTETOT",38,0)
PRT0 I 'DUMP D
"RTN","RGMTETOT",39,0)
 .W !!,"Exception Totals for ",SITENM
"RTN","RGMTETOT",40,0)
 .W !,"Printed ",RUNDT,!,LN
"RTN","RGMTETOT",41,0)
 .S TYPE=0 F  S TYPE=$O(TYPEARR(TYPE)) Q:'TYPE  I +TYPEARR(TYPE) D
"RTN","RGMTETOT",42,0)
 ..S GRAND=GRAND+TYPEARR(TYPE)
"RTN","RGMTETOT",43,0)
 ..W !!,"TYPE: ",TYPE,?12,$P($T(@TYPE),";;",2),?67,"TOTAL = ",$J(TYPEARR(TYPE),4)
"RTN","RGMTETOT",44,0)
 ..W !,"DESCRIPTION:"
"RTN","RGMTETOT",45,0)
 ..S TXT=0 F  S TXT=$O(^RGHL7(991.11,TYPE,99,TXT)) Q:'TXT  W !,^RGHL7(991.11,TYPE,99,TXT,0)
"RTN","RGMTETOT",46,0)
 .W !!?56,"TOTAL EXCEPTIONS: ",$J(GRAND,5)
"RTN","RGMTETOT",47,0)
 ;
"RTN","RGMTETOT",48,0)
PRT1 I DUMP=1 D
"RTN","RGMTETOT",49,0)
 .W !!,"At this point it is necessary for you to increase the right margin."
"RTN","RGMTETOT",50,0)
 .W !,"At the DEVICE prompt enter=> ;255"
"RTN","RGMTETOT",51,0)
 .W ! D ^%ZIS I POP W !,"DOWNLOAD ABORTED!" Q
"RTN","RGMTETOT",52,0)
 .W !!,"Data string=Site;Run Date;Date CIRN Installed;Exceptions 218 & 234" ;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGMTETOT",53,0)
 .S STR=SITENM_";"_RUNDT_";"
"RTN","RGMTETOT",54,0)
 .S TYPE=0 F  S TYPE=$O(TYPEARR(TYPE)) Q:'TYPE  D
"RTN","RGMTETOT",55,0)
 ..S STR=STR_";"_TYPEARR(TYPE)
"RTN","RGMTETOT",56,0)
 .W !!,STR
"RTN","RGMTETOT",57,0)
 ;
"RTN","RGMTETOT",58,0)
PRT2 I DUMP=2 D
"RTN","RGMTETOT",59,0)
 .S ICN=0,LOCCNT=0 F  S ICN=$O(^DPT("AICNL",1,ICN)) Q:'ICN  S LOCCNT=LOCCNT+1
"RTN","RGMTETOT",60,0)
 .S SITEIEN=+$$SITE^VASITE(),STANUM=$P($$SITE^VASITE(),"^",3)
"RTN","RGMTETOT",61,0)
 .I '$D(RGHLMQ) W !!,"Data string:"
"RTN","RGMTETOT",62,0)
 .I '$D(RGHLMQ) W !,"Site;Sta#;;;LocICNs,218,234" ;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGMTETOT",63,0)
 .S STR=SITENM_";"_STANUM_";;;"_LOCCNT
"RTN","RGMTETOT",64,0)
 .F TYPE=218,234 S STR=STR_";"_TYPEARR(TYPE) ;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGMTETOT",65,0)
 .I '$D(RGHLMQ) W !!,STR
"RTN","RGMTETOT",66,0)
 .I $D(RGHLMQ) S ^XTMP("RGMT","HLMQETOT",STANUM,1)=STR
"RTN","RGMTETOT",67,0)
 ;
"RTN","RGMTETOT",68,0)
QUIT ;
"RTN","RGMTETOT",69,0)
 K %,CIRNIEN,CNT,DA,DIK,DUMP,DUPCNT,EXCDT,GRAND,ICN,IEN,IEN1,IEN2,LN,LOCCNT,OLDDT,OLDNODE,PTNM
"RTN","RGMTETOT",70,0)
 K RGDFN,RUNDT,SITEIEN,SITENM,STANUM,STAT,STR,TXT,TYPE,XCNT,HOME,DFN,RCNT,VADM
"RTN","RGMTETOT",71,0)
 K ^XTMP("RGMT","ETOT")
"RTN","RGMTETOT",72,0)
 Q
"RTN","RGMTETOT",73,0)
 ;
"RTN","RGMTETOT",74,0)
PURGE ;
"RTN","RGMTETOT",75,0)
 I '$D(RGHLMQ) W !!,"...purging duplicate Potential Match Exceptions",!
"RTN","RGMTETOT",76,0)
 K ^XTMP("RGMT","ETOT")
"RTN","RGMTETOT",77,0)
 S (RGDFN,CNT,XCNT,DUPCNT)=0,HOME=$$SITE^VASITE()
"RTN","RGMTETOT",78,0)
 F  S RGDFN=$O(^RGHL7(991.1,"ADFN",218,RGDFN)) Q:'RGDFN  D
"RTN","RGMTETOT",79,0)
 .S IEN=0
"RTN","RGMTETOT",80,0)
 .F  S IEN=$O(^RGHL7(991.1,"ADFN",218,RGDFN,IEN)) Q:'IEN  D
"RTN","RGMTETOT",81,0)
 ..S IEN2=0
"RTN","RGMTETOT",82,0)
 ..F  S IEN2=$O(^RGHL7(991.1,"ADFN",218,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGMTETOT",83,0)
 ...I '$D(^RGHL7(991.1,IEN,0)) Q
"RTN","RGMTETOT",84,0)
 ...S CNT=CNT+1
"RTN","RGMTETOT",85,0)
 ...S EXCDT=$P(^RGHL7(991.1,IEN,0),"^",3)
"RTN","RGMTETOT",86,0)
 ...I '$D(^XTMP("RGMT","ETOT",RGDFN)) D  Q
"RTN","RGMTETOT",87,0)
 ....S XCNT=XCNT+1
"RTN","RGMTETOT",88,0)
 ....D SETTMP
"RTN","RGMTETOT",89,0)
 ...I $D(^XTMP("RGMT","ETOT",RGDFN))  D
"RTN","RGMTETOT",90,0)
 ....S OLDNODE=^XTMP("RGMT","ETOT",RGDFN)
"RTN","RGMTETOT",91,0)
 ....S OLDDT=$P(OLDNODE,"^")
"RTN","RGMTETOT",92,0)
 ....I EXCDT>OLDDT D  Q
"RTN","RGMTETOT",93,0)
 .....S DA(1)=$P(OLDNODE,"^",2),DA=$P(OLDNODE,"^",3)
"RTN","RGMTETOT",94,0)
 .....D DELDUP
"RTN","RGMTETOT",95,0)
 .....D SETTMP
"RTN","RGMTETOT",96,0)
 ....I OLDDT>EXCDT!(OLDDT=EXCDT) D
"RTN","RGMTETOT",97,0)
 .....S DA(1)=IEN,DA=IEN2
"RTN","RGMTETOT",98,0)
 .....D DELDUP
"RTN","RGMTETOT",99,0)
 I '$D(RGHLMQ) W !,DUPCNT," duplicate patient entries for POTENTIAL MATCH exceptions were identified"
"RTN","RGMTETOT",100,0)
 I '$D(RGHLMQ) W !,"and deleted from the CIRN HL7 EXCEPTION LOG file (#991.1)."
"RTN","RGMTETOT",101,0)
 ;
"RTN","RGMTETOT",102,0)
 K ^XTMP("RGMT","ETOT")
"RTN","RGMTETOT",103,0)
 S (RCNT,RGDFN)=0 N IEN,SUB
"RTN","RGMTETOT",104,0)
 F  S RGDFN=$O(^RGHL7(991.1,"ADFN",218,RGDFN)) Q:'RGDFN  D
"RTN","RGMTETOT",105,0)
 .;S ICN=+$$GETICN^MPIF001(RGDFN)
"RTN","RGMTETOT",106,0)
 .;I $E(ICN,1,3)=$P(HOME,"^",3)!(ICN<0) D
"RTN","RGMTETOT",107,0)
 .;**43 shouldn't check for locals or no ICN, check for processed/not processed
"RTN","RGMTETOT",108,0)
 .S IEN=0  F  S IEN=$O(^RGHL7(991.1,"ADFN",218,RGDFN,IEN)) Q:IEN=""  D
"RTN","RGMTETOT",109,0)
 ..S SUB=$O(^RGHL7(991.1,"ADFN",218,RGDFN,IEN,""))
"RTN","RGMTETOT",110,0)
 ..I $P($G(^RGHL7(991.1,IEN,1,SUB,0)),"^",5)=0 D
"RTN","RGMTETOT",111,0)
 ...S DFN=RGDFN D DEM^VADPT
"RTN","RGMTETOT",112,0)
 ...I VADM(1)=""!(VADM(2)="") Q
"RTN","RGMTETOT",113,0)
 ...S RCNT=RCNT+1
"RTN","RGMTETOT",114,0)
 ...S ^XTMP("RGMT","ETOT",VADM(1),RGDFN)=$P(VADM(2),"^")_"^"_$P(VADM(3),"^",2)
"RTN","RGMTETOT",115,0)
 ;
"RTN","RGMTETOT",116,0)
 ;count the number of patients who need to be resolved
"RTN","RGMTETOT",117,0)
 S PTNM="",CNT=0
"RTN","RGMTETOT",118,0)
 F  S PTNM=$O(^XTMP("RGMT","ETOT",PTNM)) Q:PTNM=""  D
"RTN","RGMTETOT",119,0)
 .S RGDFN=0
"RTN","RGMTETOT",120,0)
 .F  S RGDFN=$O(^XTMP("RGMT","ETOT",PTNM,RGDFN)) Q:'RGDFN  S CNT=CNT+1
"RTN","RGMTETOT",121,0)
 S TYPEARR(218)=CNT
"RTN","RGMTETOT",122,0)
 Q
"RTN","RGMTETOT",123,0)
 ;
"RTN","RGMTETOT",124,0)
SETTMP ;set TMP global for patient check
"RTN","RGMTETOT",125,0)
 S ^XTMP("RGMT","ETOT",RGDFN)=EXCDT_"^"_IEN_"^"_IEN2
"RTN","RGMTETOT",126,0)
 Q
"RTN","RGMTETOT",127,0)
 ;
"RTN","RGMTETOT",128,0)
DELDUP ;delete patient dups from file
"RTN","RGMTETOT",129,0)
 S DUPCNT=DUPCNT+1
"RTN","RGMTETOT",130,0)
 S DIK="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","RGMTETOT",131,0)
 D ^DIK K DIK,DA
"RTN","RGMTETOT",132,0)
 Q
"RTN","RGMTETOT",133,0)
 ;
"RTN","RGMTETOT",134,0)
218 ;;(Potential Matches Returned)
"RTN","RGMTETOT",135,0)
234 ;;(Primary View Reject)
"RTN","RGP52PST")
0^4^B5624802^n/a
"RTN","RGP52PST",1,0)
RGP52PST ;BIR/PTD-POST-INIT TO RETIRE EXCEPTIONS #215, 216, and 217 ;05/20/08
"RTN","RGP52PST",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**52**;30 Apr 99;Build 2
"RTN","RGP52PST",3,0)
 ;
"RTN","RGP52PST",4,0)
 ;Loop through the CIRN HL7 EXCEPTION LOG (#991.1) file.
"RTN","RGP52PST",5,0)
 ;Find exceptions with EXCEPTION STATUS of NOT PROCESSED ("0").
"RTN","RGP52PST",6,0)
 ;Get the TYPE which is a pointer to the CIRN HL7 EXCEPTION
"RTN","RGP52PST",7,0)
 ;TYPE (#991.11) file.  If the TYPE is 215, 216, or 217,
"RTN","RGP52PST",8,0)
 ;mark the EXCEPTION STATUS to  PROCESSED ("1").  These exception
"RTN","RGP52PST",9,0)
 ;types will not be generated in the future.
"RTN","RGP52PST",10,0)
 ;
"RTN","RGP52PST",11,0)
EXLOG ;
"RTN","RGP52PST",12,0)
 ;If patch RG*1.0*52 has previously been installed, quit post-init.
"RTN","RGP52PST",13,0)
 I $$PATCH^XPDUTL("RG*1.0*52") D BMES^XPDUTL(" Post-install previously ran; no need to reprocess file 991.1.") Q
"RTN","RGP52PST",14,0)
 ;Else continue with post-init.
"RTN","RGP52PST",15,0)
 ;
"RTN","RGP52PST",16,0)
 D BMES^XPDUTL(" The post-init routine will retire selected exceptions in")
"RTN","RGP52PST",17,0)
 D MES^XPDUTL(" the CIRN HL7 EXCEPTION LOG (#991.1) file.")
"RTN","RGP52PST",18,0)
 ;
"RTN","RGP52PST",19,0)
 N COUNT,DA,DIC,DIE,DR,EXNUM,EXCTYP,LOGIEN,X,Y,ZNODE
"RTN","RGP52PST",20,0)
 S (LOGIEN,COUNT)=0
"RTN","RGP52PST",21,0)
 F  S LOGIEN=$O(^RGHL7(991.1,LOGIEN)) Q:'LOGIEN  D
"RTN","RGP52PST",22,0)
 .S EXNUM=0
"RTN","RGP52PST",23,0)
 .F  S EXNUM=$O(^RGHL7(991.1,LOGIEN,1,EXNUM)) Q:'EXNUM  S ZNODE=$G(^(EXNUM,0)) I $P(ZNODE,"^",5)'=1 D  ;Quit if EXCEPTION STATUS (#6) equals 1 for PROCESSED
"RTN","RGP52PST",24,0)
 ..S EXCTYP=$P(ZNODE,"^",3) ;Quit if TYPE is NOT one of these 3:
"RTN","RGP52PST",25,0)
 ..;215 - Death Entry on MPI not VISTA
"RTN","RGP52PST",26,0)
 ..;216 - Death Entry on Vista not MPI
"RTN","RGP52PST",27,0)
 ..;217 - Death Entries on MPI and Vista DON'T MATCH
"RTN","RGP52PST",28,0)
 ..I $S(EXCTYP=215:0,EXCTYP=216:0,EXCTYP=217:0,1:1) Q  ;TYPE is one of the three we want to mark as PROCESSED
"RTN","RGP52PST",29,0)
 ..;
"RTN","RGP52PST",30,0)
DIE ..;Update the EXCEPTION STATUS (#6) field to '1'.
"RTN","RGP52PST",31,0)
 ..S DA(1)=LOGIEN,DA=EXNUM,DR="6///"_1
"RTN","RGP52PST",32,0)
 ..S DIE="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","RGP52PST",33,0)
 ..L +^RGHL7(991.1,LOGIEN):10
"RTN","RGP52PST",34,0)
 ..D ^DIE K DA,DIE,DR
"RTN","RGP52PST",35,0)
 ..L -^RGHL7(991.1,LOGIEN)
"RTN","RGP52PST",36,0)
 ..S COUNT=COUNT+1
"RTN","RGP52PST",37,0)
 ;
"RTN","RGP52PST",38,0)
 D BMES^XPDUTL(" A total of "_COUNT_" exceptions were retired.")
"RTN","RGP52PST",39,0)
 D MES^XPDUTL(" Post-install routine for RG*1*52 completed successfully.")
"RTN","RGP52PST",40,0)
 Q
"RTN","RGRSBUL1")
0^3^B20578515^B31114951
"RTN","RGRSBUL1",1,0)
RGRSBUL1 ;ALB/RJS,CML-RGRSTEXT BULLETIN ROUTINE (PART 2) ;07/24/98
"RTN","RGRSBUL1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**1,3,19,52**;30 Apr 99;Build 2
"RTN","RGRSBUL1",3,0)
 ;
"RTN","RGRSBUL1",4,0)
SSNBULL(DFN,ARRAY,NAME,SSN,ICN,CMOR) ;
"RTN","RGRSBUL1",5,0)
 ;Entry point generates a bulletin to the RG CIRN DEMOGRAPHIC
"RTN","RGRSBUL1",6,0)
 ;ISSUES mail group about an SSN change for a given patient.
"RTN","RGRSBUL1",7,0)
 ;
"RTN","RGRSBUL1",8,0)
 ;Input:  Required Variables
"RTN","RGRSBUL1",9,0)
 ;
"RTN","RGRSBUL1",10,0)
 ;   DFN   - IEN in the PATIENT file (#2)
"RTN","RGRSBUL1",11,0)
 ;  ARRAY  - Array of data containing sending sites station number
"RTN","RGRSBUL1",12,0)
 ;   NAME  - Patient's Name
"RTN","RGRSBUL1",13,0)
 ;   SSN   - Patient's SSN
"RTN","RGRSBUL1",14,0)
 ;   ICN   - Patient's ICN (Integration Control Number) 
"RTN","RGRSBUL1",15,0)
 ;   CMOR  - Patient's CMOR (Coordinating Master of Record)
"RTN","RGRSBUL1",16,0)
 ;
"RTN","RGRSBUL1",17,0)
 Q:$G(DFN)=""!($G(ARRAY)="")
"RTN","RGRSBUL1",18,0)
 N LOCDATA,RGRSTEXT,INDEX,COUNTER
"RTN","RGRSBUL1",19,0)
 S RGRSTEXT(1)="The MPI/PD Package has received an SSN change from:"
"RTN","RGRSBUL1",20,0)
 S RGRSTEXT(2)=$$INST(@ARRAY@("SENDING SITE"))
"RTN","RGRSBUL1",21,0)
 S RGRSTEXT(3)="           "
"RTN","RGRSBUL1",22,0)
 S RGRSTEXT(4)="This change has been made in your local data base for:"
"RTN","RGRSBUL1",23,0)
 S RGRSTEXT(5)=NAME
"RTN","RGRSBUL1",24,0)
 S RGRSTEXT(6)="           "
"RTN","RGRSBUL1",25,0)
 S RGRSTEXT(7)="=> Local "_$P($$SITE^VASITE(),"^",2)_" data PRIOR to update:"
"RTN","RGRSBUL1",26,0)
 S RGRSTEXT(8)="NAME: "_NAME
"RTN","RGRSBUL1",27,0)
 S RGRSTEXT(9)="SSN: "_SSN
"RTN","RGRSBUL1",28,0)
 S RGRSTEXT(10)="ICN: "_ICN
"RTN","RGRSBUL1",29,0)
 S RGRSTEXT(11)="CMOR: "_CMOR
"RTN","RGRSBUL1",30,0)
 S RGRSTEXT(12)="--------------------------------------------------------"
"RTN","RGRSBUL1",31,0)
 S RGRSTEXT(13)="=> Update received from "_$P($$INST(@ARRAY@("SENDING SITE"))," -->")_":"
"RTN","RGRSBUL1",32,0)
 S RGRSTEXT(14)="SSN: "_@ARRAY@("SSN")
"RTN","RGRSBUL1",33,0)
 D BULL2^RGRSBULL("MPI/PD SSN CHANGE - "_NAME,"RGRSTEXT(")
"RTN","RGRSBUL1",34,0)
 Q
"RTN","RGRSBUL1",35,0)
 ;
"RTN","RGRSBUL1",36,0)
NOT2(ARRAY) ;
"RTN","RGRSBUL1",37,0)
 ;Entry point generates a bulletin to the RG CIRN DEMOGRAPHIC
"RTN","RGRSBUL1",38,0)
 ;ISSUES mail group about invalid subscription information for a given
"RTN","RGRSBUL1",39,0)
 ;patient.
"RTN","RGRSBUL1",40,0)
 ;
"RTN","RGRSBUL1",41,0)
 ;Input:  Required Variables
"RTN","RGRSBUL1",42,0)
 ;
"RTN","RGRSBUL1",43,0)
 ;  ARRAY  - Array of information regarding the invalid subscription
"RTN","RGRSBUL1",44,0)
 ;
"RTN","RGRSBUL1",45,0)
 Q:($G(ARRAY)="")
"RTN","RGRSBUL1",46,0)
 N RGRSTEXT,INDEX,COUNTER
"RTN","RGRSBUL1",47,0)
 S RGRSTEXT(1)="The MPI/PD Package has received a message from:"
"RTN","RGRSBUL1",48,0)
 S RGRSTEXT(2)=$$INST(@ARRAY@("SENDING SITE"))
"RTN","RGRSBUL1",49,0)
 S RGRSTEXT(3)="This patient has your station as a subscriber, however"
"RTN","RGRSBUL1",50,0)
 S RGRSTEXT(4)="the patient was not found in your database."
"RTN","RGRSBUL1",51,0)
 S RGRSTEXT(5)="--------------------------------------------------------"
"RTN","RGRSBUL1",52,0)
 S RGRSTEXT(6)="Remote Data"
"RTN","RGRSBUL1",53,0)
 S RGRSTEXT(7)="           "
"RTN","RGRSBUL1",54,0)
 S INDEX=0,COUNTER=8
"RTN","RGRSBUL1",55,0)
 F  S INDEX=$O(@ARRAY@("MESSAGE",INDEX)) Q:INDEX']""  D
"RTN","RGRSBUL1",56,0)
 . S RGRSTEXT(COUNTER)=@ARRAY@("MESSAGE",INDEX)
"RTN","RGRSBUL1",57,0)
 . S COUNTER=COUNTER+1
"RTN","RGRSBUL1",58,0)
 D BULL2^RGRSBULL("MPI/PD - PATIENT NOT FOUND","RGRSTEXT(")
"RTN","RGRSBUL1",59,0)
 Q
"RTN","RGRSBUL1",60,0)
 ;
"RTN","RGRSBUL1",61,0)
SENSTIVE(DFN,ARRAY,NAME) ;FIRES WHEN PT. IS FLAGGED AS SENSITIVE AT ANOTHER SITE
"RTN","RGRSBUL1",62,0)
 ;Entry point generates a bulletin to the RG CIRN DEMOGRAPHIC
"RTN","RGRSBUL1",63,0)
 ;ISSUES mail group when a given patient is flagged as sensitive at
"RTN","RGRSBUL1",64,0)
 ;another site.
"RTN","RGRSBUL1",65,0)
 ;
"RTN","RGRSBUL1",66,0)
 ;Input:  Required Variables
"RTN","RGRSBUL1",67,0)
 ;
"RTN","RGRSBUL1",68,0)
 ;   DFN  - IEN in the PATIENT file (#2)
"RTN","RGRSBUL1",69,0)
 ;  ARRAY - Array of data containing sending sites station number and SSN
"RTN","RGRSBUL1",70,0)
 ;  NAME  - Patient's name
"RTN","RGRSBUL1",71,0)
 ;  CMOR  - Coordinating Master of Record
"RTN","RGRSBUL1",72,0)
 ;
"RTN","RGRSBUL1",73,0)
 Q:($G(ARRAY)="")!($G(DFN)="")
"RTN","RGRSBUL1",74,0)
 N RGRSTEXT,INDEX,COUNTER,CMOR
"RTN","RGRSBUL1",75,0)
 S CMOR=$$CMOR2^MPIF001(DFN) I $P(CMOR,"^")<0 S CMOR="not assigned"
"RTN","RGRSBUL1",76,0)
 S RGRSTEXT(1)="The MPI/PD Package has received a message from:"
"RTN","RGRSBUL1",77,0)
 S RGRSTEXT(2)=$$INST(@ARRAY@("SENDING SITE"))
"RTN","RGRSBUL1",78,0)
 S RGRSTEXT(3)="   "
"RTN","RGRSBUL1",79,0)
 S RGRSTEXT(4)="This message indicates that patient "_NAME_" is flagged"
"RTN","RGRSBUL1",80,0)
 S RGRSTEXT(5)="as Sensitive at the other facility but is not flagged as"
"RTN","RGRSBUL1",81,0)
 S RGRSTEXT(6)="Sensitive at your facility."
"RTN","RGRSBUL1",82,0)
 S RGRSTEXT(7)="  "
"RTN","RGRSBUL1",83,0)
 S RGRSTEXT(8)="Remote Patient SSN: "_$S(@ARRAY@("SSN")="":"Not Available",1:@ARRAY@("SSN"))
"RTN","RGRSBUL1",84,0)
 S RGRSTEXT(9)="Remote User who Flagged the Patient as Sensitive: "_@ARRAY@("SENSITIVITY USER")
"RTN","RGRSBUL1",85,0)
 S RGRSTEXT(10)="Date/Time Remote User Flagged Patient Sensitive:  "_$$FMTE^XLFDT(@ARRAY@("SENSITIVITY DATE"))
"RTN","RGRSBUL1",86,0)
 S RGRSTEXT(11)="  "
"RTN","RGRSBUL1",87,0)
 S RGRSTEXT(12)="CMOR Site: "_CMOR
"RTN","RGRSBUL1",88,0)
 D BULL2^RGRSBULL("Remote Sensitivity Indicated","RGRSTEXT(")
"RTN","RGRSBUL1",89,0)
 Q
"RTN","RGRSBUL1",90,0)
 ;
"RTN","RGRSBUL1",91,0)
 ;MPIC_772 - **52; Commented out Remote Date of Death Indicated module.
"RTN","RGRSBUL1",92,0)
 ;Only RGADTP2 and RGRSPT called this module; and both have been commented out.
"RTN","RGRSBUL1",93,0)
RMTDOD(DFN,ARRAY,NAME,RDOD,LDOD) ;Fires when patient has a Date of Death at another site
"RTN","RGRSBUL1",94,0)
 ;Entry point generates a bulletin to the RG CIRN DEMOGRAPHIC
"RTN","RGRSBUL1",95,0)
 ;ISSUES mail group when a given patient has a Date of Death at
"RTN","RGRSBUL1",96,0)
 ;another site.
"RTN","RGRSBUL1",97,0)
 ;
"RTN","RGRSBUL1",98,0)
 ;Input:  Required Variables
"RTN","RGRSBUL1",99,0)
 ;
"RTN","RGRSBUL1",100,0)
 ;  DFN   - IEN in the PATIENT file (#2)
"RTN","RGRSBUL1",101,0)
 ;  ARRAY - Array of data containing sending sites station number and SSN
"RTN","RGRSBUL1",102,0)
 ;  NAME  - Patient's name
"RTN","RGRSBUL1",103,0)
 ;  RDOD  - Date of Death at remote site
"RTN","RGRSBUL1",104,0)
 ;  LDOD  - Date of Death at local site
"RTN","RGRSBUL1",105,0)
 ;  CMOR  - Coordinating Master of Record
"RTN","RGRSBUL1",106,0)
 ;
"RTN","RGRSBUL1",107,0)
 ;Q:($G(ARRAY)="")!($G(DFN)="")
"RTN","RGRSBUL1",108,0)
 ;Q:(RDOD=LDOD)  ;If remote DOD and local DOD same, QUIT
"RTN","RGRSBUL1",109,0)
 ;N CMOR
"RTN","RGRSBUL1",110,0)
 ;S CMOR=$$CMOR2^MPIF001(DFN) I $P(CMOR,"^")<0 S CMOR="not assigned"
"RTN","RGRSBUL1",111,0)
 ;N RGRSTEXT
"RTN","RGRSBUL1",112,0)
 ;S RGRSTEXT(1)="The MPI/PD Package has received a message from:"
"RTN","RGRSBUL1",113,0)
 ;S RGRSTEXT(2)=$$INST(@ARRAY@("SENDING SITE"))
"RTN","RGRSBUL1",114,0)
 ;S RGRSTEXT(3)="   "
"RTN","RGRSBUL1",115,0)
 ;S RGRSTEXT(4)="This message indicates that patient "_NAME
"RTN","RGRSBUL1",116,0)
 ;I 'LDOD S RGRSTEXT(5)="has a date of death at the other facility but not at your facility." G RMTMSG
"RTN","RGRSBUL1",117,0)
 ;I LDOD,(LDOD'=RDOD) S RGRSTEXT(5)="has a different date of death at the other facility than at your facility."
"RTN","RGRSBUL1",118,0)
RMTMSG ;S RGRSTEXT(6)="  "
"RTN","RGRSBUL1",119,0)
 ;S RGRSTEXT(7)="Remote Patient SSN: "_$S(@ARRAY@("SSN")="":"Not Available",1:@ARRAY@("SSN"))
"RTN","RGRSBUL1",120,0)
 ;S RGRSTEXT(8)="Date of Death from other facility:  "_$$FMTE^XLFDT(RDOD)
"RTN","RGRSBUL1",121,0)
 ;I LDOD,(LDOD'=RDOD) S RGRSTEXT(9)="Date of Death at your facility:  "_$$FMTE^XLFDT(LDOD)
"RTN","RGRSBUL1",122,0)
 ;S RGRSTEXT(10)="  "
"RTN","RGRSBUL1",123,0)
 ;S RGRSTEXT(11)="CMOR site: "_CMOR
"RTN","RGRSBUL1",124,0)
 ;D BULL2^RGRSBULL("Remote Date of Death Indicated","RGRSTEXT(")
"RTN","RGRSBUL1",125,0)
 Q
"RTN","RGRSBUL1",126,0)
 ;
"RTN","RGRSBUL1",127,0)
INST(SITENUM) ;
"RTN","RGRSBUL1",128,0)
 N RETURN,IEN,DATA,NAME,NUMBER
"RTN","RGRSBUL1",129,0)
 S RETURN=""
"RTN","RGRSBUL1",130,0)
 Q:$G(SITENUM)="" RETURN
"RTN","RGRSBUL1",131,0)
 S IEN=$$LKUP^XUAF4(SITENUM)
"RTN","RGRSBUL1",132,0)
 I IEN>0 S DATA=$$NS^XUAF4(IEN)
"RTN","RGRSBUL1",133,0)
 I $G(DATA)]"" D 
"RTN","RGRSBUL1",134,0)
 . S NAME=$P(DATA,"^",1),NUMBER=$P(DATA,"^",2)
"RTN","RGRSBUL1",135,0)
 . S RETURN=NAME_" --> Site Number: "_NUMBER
"RTN","RGRSBUL1",136,0)
 Q RETURN
"RTN","RGRSBUL1",137,0)
 ;
"RTN","RGRSBUL1",138,0)
FORMAT(DATA1,DATA2) ;
"RTN","RGRSBUL1",139,0)
 N SPACES,SPACENUM,LENGTH1,LENGTH2,RETURN
"RTN","RGRSBUL1",140,0)
 S SPACES="                       "
"RTN","RGRSBUL1",141,0)
 S LENGTH1=$L(DATA1),LENGTH2=$L(DATA2)
"RTN","RGRSBUL1",142,0)
 I LENGTH1>23 S DATA1=$E(DATA1,1,23) S LENGTH1=23
"RTN","RGRSBUL1",143,0)
 I LENGTH2>22 S DATA2=$E(DATA2,1,22)
"RTN","RGRSBUL1",144,0)
 S SPACENUM=23-LENGTH1
"RTN","RGRSBUL1",145,0)
 S SPACES=$E(SPACES,1,SPACENUM)
"RTN","RGRSBUL1",146,0)
 S RETURN=DATA1_SPACES_" "_DATA2
"RTN","RGRSBUL1",147,0)
 Q $G(RETURN)
"RTN","RGRSBUL1",148,0)
 ;
"RTN","RGRSBUL1",149,0)
FREE(DATA) ;
"RTN","RGRSBUL1",150,0)
 Q:$G(DATA)="" ""
"RTN","RGRSBUL1",151,0)
 Q:$G(DATA)["@" ""
"RTN","RGRSBUL1",152,0)
 Q:$G(DATA)=HL("Q") ""
"RTN","RGRSBUL1",153,0)
 Q $G(DATA)
"RTN","RGRSPT")
0^2^B13914646^B14853714
"RTN","RGRSPT",1,0)
RGRSPT ;ALB/RJS,CML-HIGH LEVEL ROUTINE FOR PARSING AND FILING ;06/25/98
"RTN","RGRSPT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**1,3,7,8,52**;30 Apr 99;Build 2
"RTN","RGRSPT",3,0)
 ;
"RTN","RGRSPT",4,0)
 ;Parse Incoming Message, and file.
"RTN","RGRSPT",5,0)
 ;
"RTN","RGRSPT",6,0)
 ;
"RTN","RGRSPT",7,0)
 Q:($G(HL("MTN"))'="ADT")
"RTN","RGRSPT",8,0)
 N RGRSDFN,VAFCA,RGRS,VAFCA08,RGRSARAY,BOGUS,RGDC,SENSTVTY,CMORDISP
"RTN","RGRSPT",9,0)
 N NAME,LASTNAME,SSN,ICN,CMOR,CMORIEN,OTHSITE,RGRSDATA,HERE,BULSUB,NODE
"RTN","RGRSPT",10,0)
 S RGRSARAY="RGRS(2)"
"RTN","RGRSPT",11,0)
 D INITIZE^RGRSUTIL ;copy HL7 message into local RGDC array
"RTN","RGRSPT",12,0)
 S VAFCA=$$EN^RGRSMSH() ;parse MSH for filer
"RTN","RGRSPT",13,0)
 D EN^RGRSPARS(RGRSARAY) ;parse HL7 message into local array RGRS
"RTN","RGRSPT",14,0)
 I $$SKIP^RGRSZZPT(1,RGRSARAY) D  G EXIT ;skip if certain data is not there
"RTN","RGRSPT",15,0)
 . D SKIPBULL^RGRSBULL(RGRSARAY)
"RTN","RGRSPT",16,0)
 S RGRSDFN=$$GETDFN^MPIF001(@RGRSARAY@(991.01)) ;Get DFN from ICN
"RTN","RGRSPT",17,0)
 Q:+$$SEND2^VAFCUTL1(RGRSDFN,"T")  ;safeguard to prevent the processing of test patients
"RTN","RGRSPT",18,0)
 S OTHSITE=@RGRSARAY@("SITENUM")\1
"RTN","RGRSPT",19,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSPT",20,0)
 ;
"RTN","RGRSPT",21,0)
 ;If patient not known in site, send bulletin, go exit
"RTN","RGRSPT",22,0)
 ;
"RTN","RGRSPT",23,0)
 I +RGRSDFN=-1 D EXC^RGHLLOG(210,"Msg#"_$G(HL("MID"))_" Bad DFN#"_$G(RGRSDFN)_" for "_$G(@RGRSARAY@(.01))_" (ICN#"_$G(@RGRSARAY@(991.01))_")") D STOP^RGHLLOG(1) Q
"RTN","RGRSPT",24,0)
 ;
"RTN","RGRSPT",25,0)
 S NAME=$$GET1^DIQ(2,+RGRSDFN_",",.01)
"RTN","RGRSPT",26,0)
 S LASTNAME=$P(NAME,",",1)
"RTN","RGRSPT",27,0)
 S SSN=$$GET1^DIQ(2,+RGRSDFN_",",.09)
"RTN","RGRSPT",28,0)
 S NODE=$$MPINODE^MPIFAPI(RGRSDFN)
"RTN","RGRSPT",29,0)
 S ICN=$P(NODE,"^")
"RTN","RGRSPT",30,0)
 S CMORIEN=$P(NODE,"^",3)
"RTN","RGRSPT",31,0)
 S CMOR=$$NS^XUAF4(CMORIEN)
"RTN","RGRSPT",32,0)
 S CMORDISP=$P(CMOR,"^",1)
"RTN","RGRSPT",33,0)
 S CMOR=$P(CMOR,"^",2)
"RTN","RGRSPT",34,0)
 ;
"RTN","RGRSPT",35,0)
 S @RGRSARAY@("NAME")=@RGRSARAY@(.01)
"RTN","RGRSPT",36,0)
 S @RGRSARAY@("SSN")=@RGRSARAY@(.09)
"RTN","RGRSPT",37,0)
 S @RGRSARAY@("ICN")=@RGRSARAY@(991.01)
"RTN","RGRSPT",38,0)
 S @RGRSARAY@("CMOR")=$P($$NS^XUAF4($$LKUP^XUAF4(OTHSITE)),"^")
"RTN","RGRSPT",39,0)
 ;
"RTN","RGRSPT",40,0)
 ;If ICN or CMOR don't match, send bulletin and go exit
"RTN","RGRSPT",41,0)
 I '$$MATCH(RGRSDFN,RGRSARAY,,,ICN,CMOR,.BULSUB) D  G EXIT
"RTN","RGRSPT",42,0)
 . D MTCHBULL^RGRSBULL(RGRSDFN,RGRSARAY,NAME,SSN,ICN,CMORDISP,BULSUB)
"RTN","RGRSPT",43,0)
 ;
"RTN","RGRSPT",44,0)
 ;if ICN and CMOR match, check for SSN edit from CMOR
"RTN","RGRSPT",45,0)
 I @RGRSARAY@("SENDING SITE")=CMOR,(SSN'=@RGRSARAY@(.09)) D
"RTN","RGRSPT",46,0)
 .D SSNBULL^RGRSBUL1(RGRSDFN,RGRSARAY,NAME,SSN,ICN,CMORDISP)
"RTN","RGRSPT",47,0)
 ;
"RTN","RGRSPT",48,0)
 ;If patient is Sensitive at other site but not here send bulletin
"RTN","RGRSPT",49,0)
 S SENSTVTY=$G(@RGRSARAY@("SENSITIVITY"))
"RTN","RGRSPT",50,0)
 I '$$SENSTIVE^RGRSENS(RGRSDFN),SENSTVTY D SENSTIVE^RGRSBUL1(RGRSDFN,RGRSARAY,NAME)
"RTN","RGRSPT",51,0)
 ;
"RTN","RGRSPT",52,0)
 ;MPIC_772 - **52; Commented out Remote Date of Death Indicated section.
"RTN","RGRSPT",53,0)
 ;If patient has DATE OF DEATH (DOD) at remote site send bulletin
"RTN","RGRSPT",54,0)
 ;Ignore time if present with date.
"RTN","RGRSPT",55,0)
 ;S RMTDOD=@RGRSARAY@(.351),RMTDOD=$P(RMTDOD,".")
"RTN","RGRSPT",56,0)
 ;S DFN=RGRSDFN D DEM^VADPT
"RTN","RGRSPT",57,0)
 ;S LOCDOD=$P($P(VADM(6),"^"),".")
"RTN","RGRSPT",58,0)
 ;If there is a remote DOD but no local DOD  OR
"RTN","RGRSPT",59,0)
 ;if remote DOD is different from local DOD, send bulletin
"RTN","RGRSPT",60,0)
 ;I RMTDOD D RMTDOD^RGRSBUL1(RGRSDFN,RGRSARAY,NAME,RMTDOD,LOCDOD)
"RTN","RGRSPT",61,0)
 ;K LOCDOD,RMTDOD,VADM
"RTN","RGRSPT",62,0)
 ;
"RTN","RGRSPT",63,0)
 D  G EXIT ;**7
"RTN","RGRSPT",64,0)
 . ;
"RTN","RGRSPT",65,0)
 . ;IF it's the CMOR - review file
"RTN","RGRSPT",66,0)
 . ;
"RTN","RGRSPT",67,0)
 . I (OTHSITE)=(HERE) D  Q
"RTN","RGRSPT",68,0)
 . . S VAFCA=VAFCA_"^"_RGRSDFN
"RTN","RGRSPT",69,0)
 . . S VAFCA08=1 S BOGUS=$$ADD^VAFCEHU1(VAFCA,"RGRS")
"RTN","RGRSPT",70,0)
 . ;
"RTN","RGRSPT",71,0)
 . ;IF it's not the CMOR - Don't Rebroadcast
"RTN","RGRSPT",72,0)
 . ;
"RTN","RGRSPT",73,0)
 . I (OTHSITE)'=(HERE) D  Q
"RTN","RGRSPT",74,0)
 . . S VAFCA08=1
"RTN","RGRSPT",75,0)
 . . D EDIT^VAFCPTED(RGRSDFN,RGRSARAY,".01;.03;.09;.02;.2403") ;**7 broadcasted fields - removed .05,.08,.111;.112;.113;.114;.115;.1112;.117;.131;.132;.211;.219;.31115
"RTN","RGRSPT",76,0)
EXIT ;
"RTN","RGRSPT",77,0)
 Q
"RTN","RGRSPT",78,0)
 ;
"RTN","RGRSPT",79,0)
MATCH(DFN,RGRSARAY,LASTNAME,SSN,ICN,CMOR,BULSUB) ;
"RTN","RGRSPT",80,0)
 Q:$G(DFN)=""!($G(RGRSARAY)="") 0
"RTN","RGRSPT",81,0)
 N COUNT,TRUE S (COUNT,TRUE)=0
"RTN","RGRSPT",82,0)
 S BULSUB=""
"RTN","RGRSPT",83,0)
 I $D(LASTNAME) D
"RTN","RGRSPT",84,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",85,0)
 . I (LASTNAME'=""),(LASTNAME=$P(@RGRSARAY@(.01),",",1)) S TRUE=TRUE+1
"RTN","RGRSPT",86,0)
 I $D(SSN) D
"RTN","RGRSPT",87,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",88,0)
 . I (SSN'=""),(SSN=$G(@RGRSARAY@(.09))) S TRUE=TRUE+1
"RTN","RGRSPT",89,0)
 I $D(ICN) D
"RTN","RGRSPT",90,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",91,0)
 . I (ICN'=""),(ICN=$G(@RGRSARAY@(991.01))) S TRUE=TRUE+1 Q
"RTN","RGRSPT",92,0)
 . S BULSUB=BULSUB_"ICN"
"RTN","RGRSPT",93,0)
 I $D(CMOR) D
"RTN","RGRSPT",94,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",95,0)
 . I (CMOR'=""),(CMOR=$G(@RGRSARAY@("SITENUM"))) S TRUE=TRUE+1 Q
"RTN","RGRSPT",96,0)
 . I BULSUB]"" S BULSUB=BULSUB_" & "
"RTN","RGRSPT",97,0)
 . S BULSUB=BULSUB_"CMOR"
"RTN","RGRSPT",98,0)
 I COUNT=TRUE Q 1
"RTN","RGRSPT",99,0)
 Q 0
"RTN","RGSYSTAT")
0^10^B9080377^B16892537
"RTN","RGSYSTAT",1,0)
RGSYSTAT ;BAY/ALS-MPI/PD STATUS DISPLAY ;01/05/01
"RTN","RGSYSTAT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**16,19,23,25,20,43,45,52**;30 Apr 99;Build 2
"RTN","RGSYSTAT",3,0)
 ;
"RTN","RGSYSTAT",4,0)
 ;Reference to ^DGCN(391.98,"AST" supported by IA #3303
"RTN","RGSYSTAT",5,0)
 ;Reference to ^DGCN(391.984 supported by IA #3304
"RTN","RGSYSTAT",6,0)
 ;Reference to ^MPIF(984.9 supported by IA #3298
"RTN","RGSYSTAT",7,0)
 ;Reference to OPTSTAT^XUTMOPT supported by IA #1472
"RTN","RGSYSTAT",8,0)
 ;Reference to ^DPT("ACMORS", ^DPT("AICN", and ^DPT("AICNL" supported by IA #2070
"RTN","RGSYSTAT",9,0)
 ;Reference to ^VAT(391.71 supported by IA #3422
"RTN","RGSYSTAT",10,0)
EN ;
"RTN","RGSYSTAT",11,0)
 ; Count exceptions on hand
"RTN","RGSYSTAT",12,0)
EXC ;
"RTN","RGSYSTAT",13,0)
 W @IOF,"Exception Handler Entries:",!,"--------------------------"
"RTN","RGSYSTAT",14,0)
 S CNT=0,EXCTYP="",NTYP="",TOTL=0,PCNT=0
"RTN","RGSYSTAT",15,0)
 N STAT,DFN,ICN
"RTN","RGSYSTAT",16,0)
 S HOME=$$SITE^VASITE()
"RTN","RGSYSTAT",17,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"AC",EXCTYP)) Q:'EXCTYP  D
"RTN","RGSYSTAT",18,0)
 . I (EXCTYP=234)!(EXCTYP=218) D  ;**45;MPIC_772; **52 remove 215, 216, 217, & 227
"RTN","RGSYSTAT",19,0)
 .. I (EXCTYP'=NTYP)&(CNT>0) D
"RTN","RGSYSTAT",20,0)
 ... S ETEXT=$P($G(^RGHL7(991.11,NTYP,10)),"^",1)
"RTN","RGSYSTAT",21,0)
 ... W !,$E(ETEXT,1,47),?55,$J(CNT,6) S TOTL=TOTL+CNT,CNT=0
"RTN","RGSYSTAT",22,0)
 .. S IEN=0,NTYP=EXCTYP
"RTN","RGSYSTAT",23,0)
 .. F  S IEN=$O(^RGHL7(991.1,"AC",EXCTYP,IEN)) Q:'IEN  D
"RTN","RGSYSTAT",24,0)
 ... S IEN2=0
"RTN","RGSYSTAT",25,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"AC",EXCTYP,IEN,IEN2)) Q:'IEN2  D
"RTN","RGSYSTAT",26,0)
 .... S STAT=$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",5) I STAT<1 D
"RTN","RGSYSTAT",27,0)
 ..... S DFN=$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",4) Q:'DFN
"RTN","RGSYSTAT",28,0)
 ..... S ^XTMP("RGEXC",0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"MPI/PD Status Display"
"RTN","RGSYSTAT",29,0)
 ..... S ^XTMP("RGEXC",DFN)=DFN
"RTN","RGSYSTAT",30,0)
 ..... S ICN=+$$GETICN^MPIF001(DFN)
"RTN","RGSYSTAT",31,0)
 ..... I $E(ICN,1,3)=$E($P(HOME,"^",3),1,3)!(ICN<0)!(EXCTYP=234)!(EXCTYP=218) D  ;**43;**45;MPIC_772; **52 remove 215, 216, and 217
"RTN","RGSYSTAT",32,0)
 ...... S CNT=CNT+1
"RTN","RGSYSTAT",33,0)
 I CNT>0 D
"RTN","RGSYSTAT",34,0)
 .S ETEXT=$P($G(^RGHL7(991.11,NTYP,10)),"^",1)
"RTN","RGSYSTAT",35,0)
 .W !,$E(ETEXT,1,47),?55,$J(CNT,6) S TOTL=TOTL+CNT
"RTN","RGSYSTAT",36,0)
 I TOTL=0 W !,"There are no entries in the Exception Handler."
"RTN","RGSYSTAT",37,0)
 I TOTL>0 D
"RTN","RGSYSTAT",38,0)
 . W !!,"Total number of exceptions: ",?55,$J(TOTL,6)
"RTN","RGSYSTAT",39,0)
 . S PDFN=""
"RTN","RGSYSTAT",40,0)
 . F  S PDFN=$O(^XTMP("RGEXC",PDFN)) Q:'PDFN  D
"RTN","RGSYSTAT",41,0)
 .. S PCNT=PCNT+1
"RTN","RGSYSTAT",42,0)
 . W !,"Total unique patient exceptions: ",?55,$J(PCNT,6)
"RTN","RGSYSTAT",43,0)
 S STDT=$P($G(^RGSITE(991.8,1,"EXCPRG")),"^",1)
"RTN","RGSYSTAT",44,0)
 I $D(^RGSITE(991.8,1,"EXCPRG")) D
"RTN","RGSYSTAT",45,0)
 . S STDT=$$FMTE^XLFDT(STDT,1)
"RTN","RGSYSTAT",46,0)
 . W !!,"The MPI/PD Exception Purge process last ran "_STDT_"."
"RTN","RGSYSTAT",47,0)
 K CNT,EXCTYP,NTYP,ETEXT,TOTL,IEN,IEN2,HOME,PCNT,^XTMP("RGEXC"),PDFN,STDT
"RTN","RGSYSTAT",48,0)
 I $Y>21 D QUIT Q:X="^"
"RTN","RGSYSTAT",49,0)
PDR ;Count entries in Patient Data Review ;**52 Obsolete data removed from report.
"RTN","RGSYSTAT",50,0)
 ;W !!,"Patient Data Review Entries:",!,"----------------------------"
"RTN","RGSYSTAT",51,0)
 ;S CNT=0,PDRTYP="",NTYP="",TOTL=0
"RTN","RGSYSTAT",52,0)
 ;F  S PDRTYP=$O(^DGCN(391.98,"AST",PDRTYP)) Q:'PDRTYP  D
"RTN","RGSYSTAT",53,0)
 ;. I (PDRTYP'=NTYP)&(CNT>0) D
"RTN","RGSYSTAT",54,0)
 ;.. S DIC="^DGCN(391.984,",DR=".01",DA=NTYP,DIQ(0)="E",DIQ="RGPDR"
"RTN","RGSYSTAT",55,0)
 ;.. D EN^DIQ1 K DIC,DA,DR,DIQ
"RTN","RGSYSTAT",56,0)
 ;.. S PTEXT=$G(RGPDR(391.984,NTYP,.01,"E"))
"RTN","RGSYSTAT",57,0)
 ;.. W !,$E(PTEXT,1,47),?55,$J(CNT,6) S TOTL=TOTL+CNT,CNT=0
"RTN","RGSYSTAT",58,0)
 ;. I (PDRTYP=1)!(PDRTYP=2)!(PDRTYP=5) D
"RTN","RGSYSTAT",59,0)
 ;.. S IEN=0,NTYP=PDRTYP
"RTN","RGSYSTAT",60,0)
 ;.. F  S IEN=$O(^DGCN(391.98,"AST",PDRTYP,IEN)) Q:'IEN  D
"RTN","RGSYSTAT",61,0)
 ;... S CNT=CNT+1
"RTN","RGSYSTAT",62,0)
 ;I CNT>0 D
"RTN","RGSYSTAT",63,0)
 ;. S DIC="^DGCN(391.984,",DR=".01",DA=NTYP,DIQ(0)="E",DIQ="RGPDR"
"RTN","RGSYSTAT",64,0)
 ;. D EN^DIQ1 K DIC,DA,DR,DIQ
"RTN","RGSYSTAT",65,0)
 ;. S PTEXT=$G(RGPDR(391.984,NTYP,.01,"E"))
"RTN","RGSYSTAT",66,0)
 ;.W !,$E(PTEXT,1,47),?55,$J(CNT,6) S TOTL=TOTL+CNT
"RTN","RGSYSTAT",67,0)
 ;I TOTL=0 W !,"There are no entries in Patient Data Review."
"RTN","RGSYSTAT",68,0)
 ;K CNT,PDRTYP,NTYP,TOTL,IEN,PTEXT,RGPDR
"RTN","RGSYSTAT",69,0)
 ;Q
"RTN","RGSYSTAT",70,0)
 ;I $Y>20 D QUIT Q:X="^"
"RTN","RGSYSTAT",71,0)
 ;
"RTN","RGSYSTAT",72,0)
CMOR ;CMOR Requests Status ;**52 Obsolete data removed from report.
"RTN","RGSYSTAT",73,0)
 ;W !!,"CMOR Requests Status:",!,"---------------------"
"RTN","RGSYSTAT",74,0)
 ;S CNT=0,STAT="",NSTAT="",TOTL=0
"RTN","RGSYSTAT",75,0)
 ;F  S STAT=$O(^MPIF(984.9,"AC",STAT)) Q:'STAT  D
"RTN","RGSYSTAT",76,0)
 ;. I (STAT'=NSTAT)&(CNT>0) D
"RTN","RGSYSTAT",77,0)
 ;.. S TEXT=$$EXTERNAL^DILFD(984.9,.06,,NSTAT)
"RTN","RGSYSTAT",78,0)
 ;.. W !,$E(TEXT,1,47),?55,$J(CNT,6) S TOTL=TOTL+CNT,CNT=0
"RTN","RGSYSTAT",79,0)
 ;. S IEN=0,NSTAT=STAT
"RTN","RGSYSTAT",80,0)
 ;. F  S IEN=$O(^MPIF(984.9,"AC",STAT,IEN)) Q:'IEN  D
"RTN","RGSYSTAT",81,0)
 ;.. S CNT=CNT+1 S TOTL=TOTL+CNT
"RTN","RGSYSTAT",82,0)
 ;I CNT>0 S TEXT=$$EXTERNAL^DILFD(984.9,.06,,NSTAT) W !,$E(TEXT,1,47),?55,$J(CNT,6) S TOTL=TOTL+CNT,CNT=0
"RTN","RGSYSTAT",83,0)
 ;I TOTL=0 W !,"There are no outstanding CMOR Requests."
"RTN","RGSYSTAT",84,0)
 ;K CNT,STAT,NSTAT,TEXT,TOTL,IEN
"RTN","RGSYSTAT",85,0)
 ;I $Y>20 D QUIT Q:X="^"
"RTN","RGSYSTAT",86,0)
 ;
"RTN","RGSYSTAT",87,0)
 S HOME=$P($$SITE^VASITE(),"^",3)
"RTN","RGSYSTAT",88,0)
 S ICN=0,CNT=0
"RTN","RGSYSTAT",89,0)
 F  S ICN=$O(^DPT("AICN",ICN)) Q:'ICN  D
"RTN","RGSYSTAT",90,0)
 .Q:$E(ICN,1,3)=HOME
"RTN","RGSYSTAT",91,0)
 .S CNT=CNT+1
"RTN","RGSYSTAT",92,0)
 W !!,"Current total number of National ICNs = ",CNT
"RTN","RGSYSTAT",93,0)
 S ICN=0,CNT=0
"RTN","RGSYSTAT",94,0)
 F  S ICN=$O(^DPT("AICNL",1,ICN)) Q:'ICN  S CNT=CNT+1
"RTN","RGSYSTAT",95,0)
 W !,"Current total number of Local ICNs = ",CNT
"RTN","RGSYSTAT",96,0)
 K CNT,DFN,ICN
"RTN","RGSYSTAT",97,0)
 Q
"RTN","RGSYSTAT",98,0)
QUIT S DIR(0)="E" D  D ^DIR K DIR
"RTN","RGSYSTAT",99,0)
 .S SS=21-$Y F JJ=1:1:SS W !
"RTN","RGSYSTAT",100,0)
 S $Y=0
"RTN","RGSYSTAT",101,0)
 K JJ,SS
"RTN","RGSYSTAT",102,0)
 Q
"VER")
8.0^22.0
"BLD",2576,6)
^52
**END**
**END**

Released RG*1*55 SEQ #53
Extracted from mail message
**KIDS**:RG*1.0*55^

**INSTALL NAME**
RG*1.0*55
"BLD",7986,0)
RG*1.0*55^CLINICAL INFO RESOURCE NETWORK^0^3090508^y
"BLD",7986,1,0)
^^5^5^3090507^
"BLD",7986,1,1,0)
This patch will make corrections to the Remote Patient Data Query Menu
"BLD",7986,1,2,0)
[RG REMOTE PDAT MENU].
"BLD",7986,1,3,0)
It will also provide a report for patients that have invalid phone 
"BLD",7986,1,4,0)
numbers in the PHONE NUMBER [RESIDENCE] field(#.131) of the 
"BLD",7986,1,5,0)
Patient file(#2).
"BLD",7986,4,0)
^9.64PA^^
"BLD",7986,6.3)
11
"BLD",7986,"INID")
^n
"BLD",7986,"INIT")
EN^RG1P55
"BLD",7986,"KRN",0)
^9.67PA^779.2^20
"BLD",7986,"KRN",.4,0)
.4
"BLD",7986,"KRN",.401,0)
.401
"BLD",7986,"KRN",.402,0)
.402
"BLD",7986,"KRN",.403,0)
.403
"BLD",7986,"KRN",.5,0)
.5
"BLD",7986,"KRN",.84,0)
.84
"BLD",7986,"KRN",3.6,0)
3.6
"BLD",7986,"KRN",3.8,0)
3.8
"BLD",7986,"KRN",9.2,0)
9.2
"BLD",7986,"KRN",9.8,0)
9.8
"BLD",7986,"KRN",9.8,"NM",0)
^9.68A^2^1
"BLD",7986,"KRN",9.8,"NM",2,0)
RGRPDAT^^0^B52556448
"BLD",7986,"KRN",9.8,"NM","B","RGRPDAT",2)

"BLD",7986,"KRN",19,0)
19
"BLD",7986,"KRN",19.1,0)
19.1
"BLD",7986,"KRN",101,0)
101
"BLD",7986,"KRN",409.61,0)
409.61
"BLD",7986,"KRN",771,0)
771
"BLD",7986,"KRN",779.2,0)
779.2
"BLD",7986,"KRN",870,0)
870
"BLD",7986,"KRN",8989.51,0)
8989.51
"BLD",7986,"KRN",8989.52,0)
8989.52
"BLD",7986,"KRN",8994,0)
8994
"BLD",7986,"KRN","B",.4,.4)

"BLD",7986,"KRN","B",.401,.401)

"BLD",7986,"KRN","B",.402,.402)

"BLD",7986,"KRN","B",.403,.403)

"BLD",7986,"KRN","B",.5,.5)

"BLD",7986,"KRN","B",.84,.84)

"BLD",7986,"KRN","B",3.6,3.6)

"BLD",7986,"KRN","B",3.8,3.8)

"BLD",7986,"KRN","B",9.2,9.2)

"BLD",7986,"KRN","B",9.8,9.8)

"BLD",7986,"KRN","B",19,19)

"BLD",7986,"KRN","B",19.1,19.1)

"BLD",7986,"KRN","B",101,101)

"BLD",7986,"KRN","B",409.61,409.61)

"BLD",7986,"KRN","B",771,771)

"BLD",7986,"KRN","B",779.2,779.2)

"BLD",7986,"KRN","B",870,870)

"BLD",7986,"KRN","B",8989.51,8989.51)

"BLD",7986,"KRN","B",8989.52,8989.52)

"BLD",7986,"KRN","B",8994,8994)

"BLD",7986,"QDEF")
^^^^^^^^^^YES
"BLD",7986,"QUES",0)
^9.62^^
"BLD",7986,"REQB",0)
^9.611^2^1
"BLD",7986,"REQB",2,0)
RG*1.0*31^1
"BLD",7986,"REQB","B","RG*1.0*31",2)

"INIT")
EN^RG1P55
"MBREQ")
0
"PKG",41,-1)
1^1
"PKG",41,0)
CLINICAL INFO RESOURCE NETWORK^RG^WILSON
"PKG",41,20,0)
^9.402P^1^1
"PKG",41,20,1,0)
2^^RGDRM03
"PKG",41,20,1,1)

"PKG",41,20,"B",2,1)

"PKG",41,22,0)
^9.49I^1^1
"PKG",41,22,1,0)
1.0^2990428^3000810^66481
"PKG",41,22,1,"PAH",1,0)
55^3090508
"PKG",41,22,1,"PAH",1,1,0)
^^5^5^3090508
"PKG",41,22,1,"PAH",1,1,1,0)
This patch will make corrections to the Remote Patient Data Query Menu
"PKG",41,22,1,"PAH",1,1,2,0)
[RG REMOTE PDAT MENU].
"PKG",41,22,1,"PAH",1,1,3,0)
It will also provide a report for patients that have invalid phone 
"PKG",41,22,1,"PAH",1,1,4,0)
numbers in the PHONE NUMBER [RESIDENCE] field(#.131) of the 
"PKG",41,22,1,"PAH",1,1,5,0)
Patient file(#2).
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","RG1P55")
0^^B4618641^n/a
"RTN","RG1P55",1,0)
RG1P55 ;ALB/MJB - POST-INSTALL RG*1*55 ; 11/7/08 2:53pm
"RTN","RG1P55",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**55**;30 Apr 99;Build 11
"RTN","RG1P55",3,0)
 Q
"RTN","RG1P55",4,0)
EN ;Entry Point
"RTN","RG1P55",5,0)
 D INIT ;Initialize Variables
"RTN","RG1P55",6,0)
 D REPORT ;Run Report
"RTN","RG1P55",7,0)
 Q
"RTN","RG1P55",8,0)
INIT ;Setup XTMP variable
"RTN","RG1P55",9,0)
 K ^XTMP("RG1P55-"_$J)
"RTN","RG1P55",10,0)
 S ^XTMP("RG1P55-"_$J,0)=$$FMADD^XLFDT(""_DT_"",30)_U_DT_U_"Data for report for RG*1*55" ;Array used to store records that need to be reported.
"RTN","RG1P55",11,0)
 Q
"RTN","RG1P55",12,0)
REPORT ;Report of data to be cleaned up.
"RTN","RG1P55",13,0)
 N RECNUM,RGDFN,RGPHN
"RTN","RG1P55",14,0)
 N DIFROM,XMSUB,XMTEXT,XMY,MSGTXT,LINENUM
"RTN","RG1P55",15,0)
 I '$D(^XTMP("RG1P55-"_$J,0)) D INIT ;If called directly
"RTN","RG1P55",16,0)
 S XMY(DUZ)="" ;Send message to installer
"RTN","RG1P55",17,0)
 S XMSUB="List of records with invalid phone numbers"
"RTN","RG1P55",18,0)
 S XMTEXT="MSGTXT("
"RTN","RG1P55",19,0)
 ;W "DFN",?15,"PHONE NUMBER",?30,!
"RTN","RG1P55",20,0)
 ;F I=1:1:53 W "-"
"RTN","RG1P55",21,0)
 ;W !
"RTN","RG1P55",22,0)
 S LINENUM=1
"RTN","RG1P55",23,0)
 S MSGTXT(LINENUM)="The records listed below have invalid phone numbers",LINENUM=LINENUM+1
"RTN","RG1P55",24,0)
 S MSGTXT(LINENUM)="",LINENUM=LINENUM+1,MSGTXT(LINENUM)="",LINENUM=LINENUM+1
"RTN","RG1P55",25,0)
 S MSGTXT(LINENUM)="DFN            PHONE NUMBER                               ",LINENUM=LINENUM+1
"RTN","RG1P55",26,0)
 S MSGTXT(LINENUM)="----------------------------------------------------------",LINENUM=LINENUM+1
"RTN","RG1P55",27,0)
 S RECNUM=0 ;start after the file header
"RTN","RG1P55",28,0)
 F  S RECNUM=$O(^DPT(RECNUM)) Q:RECNUM'>0  D
"RTN","RG1P55",29,0)
 .S RGDFN=RECNUM
"RTN","RG1P55",30,0)
 .S RGPHN=$G(^DPT(RECNUM,.13)) Q:RGPHN'["~PH"  D
"RTN","RG1P55",31,0)
 ..S ^XTMP("RG1P55-"_$J,RECNUM)=RGPHN ;Store Bad Records
"RTN","RG1P55",32,0)
 ..;W PTDFN,?15,RECNUM,?30,FDATE,!
"RTN","RG1P55",33,0)
 ..S MSGTXT(LINENUM)=$E(RGDFN_"               ",1,15)_RGPHN
"RTN","RG1P55",34,0)
 ..S LINENUM=LINENUM+1
"RTN","RG1P55",35,0)
 D ^XMD
"RTN","RG1P55",36,0)
 Q
"RTN","RGRPDAT")
0^2^B52556448^B52100073
"RTN","RGRPDAT",1,0)
RGRPDAT ;BAY/ALS-ROUTINE TO CALL REMOTE PDAT ;09/14/01
"RTN","RGRPDAT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**23,27,31,55**;30 Apr 99;Build 11
"RTN","RGRPDAT",3,0)
 ;Reference to ^DGCN(391.91 supported by IA #2911
"RTN","RGRPDAT",4,0)
 ;Reference to EN1^XWB2HL7 supported by IA #3144
"RTN","RGRPDAT",5,0)
 ;Reference to RPCCHK^XWB2HL7 supported by IA #3144
"RTN","RGRPDAT",6,0)
 ;Reference to RTNDATA^XWBDRPC supported by IA #3149
"RTN","RGRPDAT",7,0)
 ;Reference to VAFC REMOTE PDAT supported by IA #3496
"RTN","RGRPDAT",8,0)
ASK ;Ask For Patient
"RTN","RGRPDAT",9,0)
 K DIRUT
"RTN","RGRPDAT",10,0)
 W !!,"Patient lookup can be done by Patient Name, SSN or by ICN.",!
"RTN","RGRPDAT",11,0)
 S DFN="",ICN=""
"RTN","RGRPDAT",12,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: ",D="SSN^AICN^B^BS^BS5"
"RTN","RGRPDAT",13,0)
 D MIX^DIC1 K DIC,D
"RTN","RGRPDAT",14,0)
 I Y<0 S REXIT=1 G QUIT
"RTN","RGRPDAT",15,0)
 S DFN=+Y
"RTN","RGRPDAT",16,0)
 S ICN=+$$GETICN^MPIF001(DFN) I ICN<1 W !,"There is no Integration Control Number assigned to this patient,",!,"no treating facilities to query." G ASK
"RTN","RGRPDAT",17,0)
 Q
"RTN","RGRPDAT",18,0)
SEND ;
"RTN","RGRPDAT",19,0)
 N TFL,X,Y,SNTDT,MPIDIR
"RTN","RGRPDAT",20,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",21,0)
 I $D(^XTMP("RGPDAT"_ICN,0)) S SNTDT=$$FMTE^XLFDT($P(^XTMP("RGPDAT"_ICN,0),"^",2)) W !,"Query last sent for this ICN on "_SNTDT,!
"RTN","RGRPDAT",22,0)
 I $P($G(TFL(0)),"^",1)=1 D
"RTN","RGRPDAT",23,0)
 . D SELTF Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",24,0)
 . W !,"Remote patient data queries will be sent to: "
"RTN","RGRPDAT",25,0)
 . S CNT=0,X=0 F  S X=$O(TFARR(X)) Q:'X  S CNT=CNT+1
"RTN","RGRPDAT",26,0)
 . I CNT>22 D D2
"RTN","RGRPDAT",27,0)
 . I CNT<23 D D1
"RTN","RGRPDAT",28,0)
 . W ! K DIR S DIR(0)="Y",DIR("B")="Yes",DIR("A")="Do you want to continue" D ^DIR S MPIDIR=+Y K DIR
"RTN","RGRPDAT",29,0)
 . I MPIDIR=1 S X=0 F  S X=$O(TFL(X)) Q:'X  D
"RTN","RGRPDAT",30,0)
 .. W !?3,"Sending Remote Query to: ",X,"  ",$P(TFL(X),"^")
"RTN","RGRPDAT",31,0)
 .. I $D(^XTMP("RGPDAT"_ICN,X)) K ^XTMP("RGPDAT"_ICN,X)
"RTN","RGRPDAT",32,0)
 .. D REQ(ICN,.TFL,X)
"RTN","RGRPDAT",33,0)
 I '$D(TFL(0)) W !!?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query will be sent."
"RTN","RGRPDAT",34,0)
 K ICNARR,X,Y,CNT,TFARR,TFL
"RTN","RGRPDAT",35,0)
 Q
"RTN","RGRPDAT",36,0)
SEND2 ;
"RTN","RGRPDAT",37,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",38,0)
 W !!,"This option sends a remote query to selected treating"
"RTN","RGRPDAT",39,0)
 W !,"facility site(s) for MPI/PD data for a patient."
"RTN","RGRPDAT",40,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",41,0)
 . D ASK
"RTN","RGRPDAT",42,0)
 . I $D(Y) D SEND
"RTN","RGRPDAT",43,0)
 K ICN,DFN
"RTN","RGRPDAT",44,0)
 Q
"RTN","RGRPDAT",45,0)
CHKSTAT ;check on the status for a given ICN or SSN
"RTN","RGRPDAT",46,0)
 N TFL,L,Y,ICNARR,STATUS,SL
"RTN","RGRPDAT",47,0)
 W !!,"Checking the status of remote patient data query.",!
"RTN","RGRPDAT",48,0)
 I '$D(^XTMP("RGPDAT"_ICN)) W !!,"No remote query sent for this patient." Q
"RTN","RGRPDAT",49,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",50,0)
 W !!,"-> For ICN ",$P(ICN,"V",1),!
"RTN","RGRPDAT",51,0)
 I $D(TFL(0)) D
"RTN","RGRPDAT",52,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("RGPDAT"_ICN,X)) K TFL(X)
"RTN","RGRPDAT",53,0)
 D SELTF
"RTN","RGRPDAT",54,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." Q
"RTN","RGRPDAT",55,0)
 Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",56,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","RGRPDAT",57,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","RGRPDAT",58,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","RGRPDAT",59,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","RGRPDAT",60,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","RGRPDAT",61,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","RGRPDAT",62,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","RGRPDAT",63,0)
 . W !?3,"  ",$P(TFL(SL),"^"),"  status: (",STATUS,")"
"RTN","RGRPDAT",64,0)
 I '$D(TFL(0)) W !!?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query sent for this patient."
"RTN","RGRPDAT",65,0)
 K ICNARR,L,SL,TFARR,TFL
"RTN","RGRPDAT",66,0)
 Q
"RTN","RGRPDAT",67,0)
CHKSTAT2 ;
"RTN","RGRPDAT",68,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",69,0)
 W !!,"This option checks the status of an existing remote patient data query."
"RTN","RGRPDAT",70,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",71,0)
 . D ASK
"RTN","RGRPDAT",72,0)
 . I $D(Y) D CHKSTAT
"RTN","RGRPDAT",73,0)
 K ICN,DFN
"RTN","RGRPDAT",74,0)
 Q
"RTN","RGRPDAT",75,0)
DISP    ;display returned PDAT queries
"RTN","RGRPDAT",76,0)
 W !!,"Display data returned from remote patient data queries."
"RTN","RGRPDAT",77,0)
 W !,"(Be sure HISTORY is enabled to capture data!)",!
"RTN","RGRPDAT",78,0)
 N TFL,L,Y,ICNARR,STATUS
"RTN","RGRPDAT",79,0)
 I '$D(^XTMP("RGPDAT"_ICN)) W !!,"No remote query sent for this patient." Q
"RTN","RGRPDAT",80,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",81,0)
 W !!,"-> For ICN ",$P(ICN,"V",1),!
"RTN","RGRPDAT",82,0)
 I $D(TFL(0)) D
"RTN","RGRPDAT",83,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("RGPDAT"_ICN,X)) K TFL(X)
"RTN","RGRPDAT",84,0)
 D SELTF
"RTN","RGRPDAT",85,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." Q
"RTN","RGRPDAT",86,0)
 Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",87,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","RGRPDAT",88,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","RGRPDAT",89,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","RGRPDAT",90,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","RGRPDAT",91,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","RGRPDAT",92,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","RGRPDAT",93,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","RGRPDAT",94,0)
 . W !?3,"  ",$P(TFL(SL),"^"),"  status: (",STATUS,")",!
"RTN","RGRPDAT",95,0)
 . D DISPLAY(ICN,$P(TFL(SL),"^",2))
"RTN","RGRPDAT",96,0)
 I '$D(TFL(0)) W !?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query exists for this patient."
"RTN","RGRPDAT",97,0)
 K ICNARR,L,SL,TFARR,TFL,STATUS,RESULT,RETURN
"RTN","RGRPDAT",98,0)
 Q
"RTN","RGRPDAT",99,0)
DISP2 ;
"RTN","RGRPDAT",100,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",101,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",102,0)
 . D ASK
"RTN","RGRPDAT",103,0)
 . I $D(Y) D DISP
"RTN","RGRPDAT",104,0)
 K ICN,DFN
"RTN","RGRPDAT",105,0)
 Q
"RTN","RGRPDAT",106,0)
DISPLAY(ICN,LOC) ;display a remote pdat report
"RTN","RGRPDAT",107,0)
 N STATUS,RETURN,RESULT,RET,R
"RTN","RGRPDAT",108,0)
 I '$D(^XTMP("RGPDAT"_ICN,0)) W !?15," - No patient data query exists for this record."
"RTN","RGRPDAT",109,0)
 I $D(^XTMP("RGPDAT"_ICN,LOC,0)) S RETURN(0)=$P(^XTMP("RGPDAT"_ICN,LOC,0),"^") D
"RTN","RGRPDAT",110,0)
 . D RPCCHK^XWB2HL7(.RESULT,RETURN(0)) I +RESULT(0)=1 D
"RTN","RGRPDAT",111,0)
 .. D RTNDATA^XWBDRPC(.RET,RETURN(0))
"RTN","RGRPDAT",112,0)
 .. I $D(RET(0)) I RET(0)<0 W !!,"No data returned due to: "_$P(RET(0),"^",2) Q  ;**31
"RTN","RGRPDAT",113,0)
 .. I $G(RET)'="",$D(@RET) S GLO=RET F  S GLO=$Q(@GLO) Q:$QS(GLO,1)'=$J  S TXT=@GLO W !,TXT I $Y>22 S DIR(0)="E" D ^DIR K DIR W @IOF S $Y=1 ;**31
"RTN","RGRPDAT",114,0)
 .. S R="" F  S R=$O(RET(R)) Q:R=""  W !,RET(R) I $Y>22 S DIR(0)="E" D ^DIR K DIR W @IOF S $Y=1 ;**31
"RTN","RGRPDAT",115,0)
 Q
"RTN","RGRPDAT",116,0)
GETTFL(ICN,TFL) ;Check for existing Treating Facilities
"RTN","RGRPDAT",117,0)
 N LOC,HOME
"RTN","RGRPDAT",118,0)
 S HOME=$$SITE^VASITE()
"RTN","RGRPDAT",119,0)
 S TF=0 F  S TF=$O(^DGCN(391.91,"APAT",DFN,TF)) Q:'TF  D
"RTN","RGRPDAT",120,0)
 . S LOC=$$NNT^XUAF4(TF)
"RTN","RGRPDAT",121,0)
 . I $P(LOC,"^",2)'=$E($P(HOME,"^",3),1,3)&($P(LOC,"^",3)'="OTHER") D
"RTN","RGRPDAT",122,0)
 .. S TFL($P(LOC,"^",2))=LOC
"RTN","RGRPDAT",123,0)
 .. S LOC=$P(LOC,"^",2)
"RTN","RGRPDAT",124,0)
 .. D MONITOR(ICN,LOC,.RESULT)
"RTN","RGRPDAT",125,0)
 .. S $P(TFL(LOC),"^",3)=$P(RESULT(0),"^",2)
"RTN","RGRPDAT",126,0)
 I $O(TFL(0)) S TFL(0)=1
"RTN","RGRPDAT",127,0)
 K TF
"RTN","RGRPDAT",128,0)
 Q
"RTN","RGRPDAT",129,0)
SELTF ;Allow the user to select treating facilites from a list
"RTN","RGRPDAT",130,0)
 K TFARR,TFARR1
"RTN","RGRPDAT",131,0)
 S I=0 F  S I=$O(TFL(I)) Q:'I  D
"RTN","RGRPDAT",132,0)
 . S TFARR1($P(TFL(I),"^",1))=$P(TFL(I),"^",2)_"^"_$P(TFL(I),"^",1)
"RTN","RGRPDAT",133,0)
 S I="",CNT=0 F  S I=$O(TFARR1(I)) Q:I=""  D
"RTN","RGRPDAT",134,0)
 . S CNT=CNT+1 S TFARR(CNT)=TFARR1(I)
"RTN","RGRPDAT",135,0)
 I CNT=1 S Y=1 Q
"RTN","RGRPDAT",136,0)
 K DIR,Y
"RTN","RGRPDAT",137,0)
 S CNT=CNT+1,TFARR(CNT)="ALL"
"RTN","RGRPDAT",138,0)
 S DIR(0)="LA^1:"_CNT
"RTN","RGRPDAT",139,0)
 S DIR("A")="Select site(s) 1-"_(CNT-1)_" or "_CNT_" for all: "
"RTN","RGRPDAT",140,0)
 W !,"Select one or more of the following: "
"RTN","RGRPDAT",141,0)
 I CNT>22 D D2
"RTN","RGRPDAT",142,0)
 I CNT<23 D D1
"RTN","RGRPDAT",143,0)
 D ^DIR K DIR
"RTN","RGRPDAT",144,0)
 I Y<1 K TFARR,TFARR1,L,I,A,CNT Q
"RTN","RGRPDAT",145,0)
 S Y=","_Y
"RTN","RGRPDAT",146,0)
 I Y[(","_CNT_",") K TFARR(CNT),TFARR1,CNT,I Q
"RTN","RGRPDAT",147,0)
 S I=0,A="" F  S I=$O(TFARR(I)) Q:'I  I Y'[(","_I_",") S A=$P(TFARR(I),"^",1) K TFL(A) K TFARR(I)
"RTN","RGRPDAT",148,0)
 K L,I,A,TFARR(CNT),CNT,TFARR1
"RTN","RGRPDAT",149,0)
 Q
"RTN","RGRPDAT",150,0)
MONITOR(ICN,LOC,RESULT) ;
"RTN","RGRPDAT",151,0)
 N STATUS,RETURN
"RTN","RGRPDAT",152,0)
 I '$D(^XTMP("RGPDAT"_ICN,0)) S RESULT(0)="-1^Unknown" Q
"RTN","RGRPDAT",153,0)
 I '$D(^XTMP("RGPDAT"_ICN,LOC,0)) S RESULT(0)="-1^Unknown" Q
"RTN","RGRPDAT",154,0)
 I $D(^XTMP("RGPDAT"_ICN,LOC,0)) S RETURN(0)=$P(^XTMP("RGPDAT"_ICN,LOC,0),"^",1) D RPCCHK^XWB2HL7(.RESULT,RETURN(0))
"RTN","RGRPDAT",155,0)
 Q
"RTN","RGRPDAT",156,0)
REQ(ICN,TFL,LOC)        ;request a remote pdat report
"RTN","RGRPDAT",157,0)
 ;LOC - STATION# OF THE INSTITUTION file entry
"RTN","RGRPDAT",158,0)
 I +LOC>0 D EN1^XWB2HL7(.RETURN,LOC,"VAFC REMOTE PDAT",1,ICN,"")
"RTN","RGRPDAT",159,0)
 S ^XTMP("RGPDAT"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE PDAT QUERY"
"RTN","RGRPDAT",160,0)
 S ^XTMP("RGPDAT"_ICN,LOC,0)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","RGRPDAT",161,0)
 Q
"RTN","RGRPDAT",162,0)
SENS ;Check for patient sensitivity
"RTN","RGRPDAT",163,0)
 N RESULT
"RTN","RGRPDAT",164,0)
 D PTSEC^DGSEC4(.RESULT,DFN,0,"RPC - VAFC REMOTE PDAT^Remote Patient Data Query")
"RTN","RGRPDAT",165,0)
 I RESULT(1)>0 D
"RTN","RGRPDAT",166,0)
 . I '$D(^XUSEC("DG SENSITIVITY",DUZ)) D
"RTN","RGRPDAT",167,0)
 . W !!,"PATIENT MARKED SENSITIVE."
"RTN","RGRPDAT",168,0)
 . W !,"You do not have proper security to view this record."
"RTN","RGRPDAT",169,0)
 Q
"RTN","RGRPDAT",170,0)
D1 ;
"RTN","RGRPDAT",171,0)
 S C1=1,I=0 F  S I=$O(TFARR(I)) Q:'I  D
"RTN","RGRPDAT",172,0)
 . W !,C1_".",?4,"("_$P(TFARR(I),"^",1)_") "_$P(TFARR(I),"^",2) S C1=C1+1
"RTN","RGRPDAT",173,0)
 K C1,I
"RTN","RGRPDAT",174,0)
 Q
"RTN","RGRPDAT",175,0)
D2 ;
"RTN","RGRPDAT",176,0)
 S I2=23 F I=1:1:22 D
"RTN","RGRPDAT",177,0)
 . W !,I_".",?4,"("_$P(TFARR(I),"^",1)_") "_$P(TFARR(I),"^",2)
"RTN","RGRPDAT",178,0)
 . I $D(TFARR(I2)) W ?41,I2_". ",?44,"("_$P(TFARR(I2),"^",1)_") "_$P(TFARR(I2),"^",2) S I2=I2+1
"RTN","RGRPDAT",179,0)
 K I,I2
"RTN","RGRPDAT",180,0)
 Q
"RTN","RGRPDAT",181,0)
QUIT ;
"RTN","RGRPDAT",182,0)
 K Y
"RTN","RGRPDAT",183,0)
 Q
"VER")
8.0^22.0
"BLD",7986,6)
^53
**END**
**END**

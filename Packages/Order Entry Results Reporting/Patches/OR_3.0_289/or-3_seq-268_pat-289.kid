Released OR*3*289 SEQ #268
Extracted from mail message
**KIDS**:OR*3.0*289^

**INSTALL NAME**
OR*3.0*289
"BLD",7579,0)
OR*3.0*289^ORDER ENTRY/RESULTS REPORTING^0^3081124^y
"BLD",7579,1,0)
^^12^12^3081124^
"BLD",7579,1,1,0)
1. When an Outpatient complex prescription contains an EXCEPT conjunction 
"BLD",7579,1,2,0)
there is a problem when it is transferred to Inpatient Medications. The 
"BLD",7579,1,3,0)
new order created does not adequately reflect the provider's intent. This 
"BLD",7579,1,4,0)
patch corrects this problem by no longer allowing an Outpatient complex 
"BLD",7579,1,5,0)
order with a conjunction of 'EXCEPT' to be transferred to Inpatient. 
"BLD",7579,1,6,0)
HD0000000269669, PSPO #1031
"BLD",7579,1,7,0)
 
"BLD",7579,1,8,0)
2. With the release of OR*3*243, there is no longer a 'Give additional 
"BLD",7579,1,9,0)
dose NOW' prompt in the [ORCM QUICK ORDERS] menu option. This patch 
"BLD",7579,1,10,0)
corrects this problem by prompting for 'Give additional dose NOW' if the 
"BLD",7579,1,11,0)
schedule does not have a schedule type of 'ONE-TIME'. 
"BLD",7579,1,12,0)
HD0000000277913, PSPO #1140
"BLD",7579,4,0)
^9.64PA^^
"BLD",7579,6)
1^
"BLD",7579,6.3)
3
"BLD",7579,"ABPKG")
n
"BLD",7579,"KRN",0)
^9.67PA^779.2^20
"BLD",7579,"KRN",.4,0)
.4
"BLD",7579,"KRN",.401,0)
.401
"BLD",7579,"KRN",.402,0)
.402
"BLD",7579,"KRN",.403,0)
.403
"BLD",7579,"KRN",.5,0)
.5
"BLD",7579,"KRN",.84,0)
.84
"BLD",7579,"KRN",3.6,0)
3.6
"BLD",7579,"KRN",3.8,0)
3.8
"BLD",7579,"KRN",9.2,0)
9.2
"BLD",7579,"KRN",9.8,0)
9.8
"BLD",7579,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",7579,"KRN",9.8,"NM",1,0)
ORCACT0^^0^B56723098
"BLD",7579,"KRN",9.8,"NM",2,0)
ORCDPS3^^0^B44868198
"BLD",7579,"KRN",9.8,"NM","B","ORCACT0",1)

"BLD",7579,"KRN",9.8,"NM","B","ORCDPS3",2)

"BLD",7579,"KRN",19,0)
19
"BLD",7579,"KRN",19.1,0)
19.1
"BLD",7579,"KRN",101,0)
101
"BLD",7579,"KRN",409.61,0)
409.61
"BLD",7579,"KRN",771,0)
771
"BLD",7579,"KRN",779.2,0)
779.2
"BLD",7579,"KRN",870,0)
870
"BLD",7579,"KRN",8989.51,0)
8989.51
"BLD",7579,"KRN",8989.52,0)
8989.52
"BLD",7579,"KRN",8994,0)
8994
"BLD",7579,"KRN","B",.4,.4)

"BLD",7579,"KRN","B",.401,.401)

"BLD",7579,"KRN","B",.402,.402)

"BLD",7579,"KRN","B",.403,.403)

"BLD",7579,"KRN","B",.5,.5)

"BLD",7579,"KRN","B",.84,.84)

"BLD",7579,"KRN","B",3.6,3.6)

"BLD",7579,"KRN","B",3.8,3.8)

"BLD",7579,"KRN","B",9.2,9.2)

"BLD",7579,"KRN","B",9.8,9.8)

"BLD",7579,"KRN","B",19,19)

"BLD",7579,"KRN","B",19.1,19.1)

"BLD",7579,"KRN","B",101,101)

"BLD",7579,"KRN","B",409.61,409.61)

"BLD",7579,"KRN","B",771,771)

"BLD",7579,"KRN","B",779.2,779.2)

"BLD",7579,"KRN","B",870,870)

"BLD",7579,"KRN","B",8989.51,8989.51)

"BLD",7579,"KRN","B",8989.52,8989.52)

"BLD",7579,"KRN","B",8994,8994)

"BLD",7579,"QUES",0)
^9.62^^
"BLD",7579,"REQB",0)
^9.611^1^1
"BLD",7579,"REQB",1,0)
OR*3.0*243^2
"BLD",7579,"REQB","B","OR*3.0*243",1)

"MBREQ")
0
"PKG",188,-1)
1^1
"PKG",188,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",188,20,0)
^9.402P^^
"PKG",188,22,0)
^9.49I^1^1
"PKG",188,22,1,0)
3.0^2971217^2981113^1
"PKG",188,22,1,"PAH",1,0)
289^3081124^520665221
"PKG",188,22,1,"PAH",1,1,0)
^^12^12^3081124
"PKG",188,22,1,"PAH",1,1,1,0)
1. When an Outpatient complex prescription contains an EXCEPT conjunction 
"PKG",188,22,1,"PAH",1,1,2,0)
there is a problem when it is transferred to Inpatient Medications. The 
"PKG",188,22,1,"PAH",1,1,3,0)
new order created does not adequately reflect the provider's intent. This 
"PKG",188,22,1,"PAH",1,1,4,0)
patch corrects this problem by no longer allowing an Outpatient complex 
"PKG",188,22,1,"PAH",1,1,5,0)
order with a conjunction of 'EXCEPT' to be transferred to Inpatient. 
"PKG",188,22,1,"PAH",1,1,6,0)
HD0000000269669, PSPO #1031
"PKG",188,22,1,"PAH",1,1,7,0)
 
"PKG",188,22,1,"PAH",1,1,8,0)
2. With the release of OR*3*243, there is no longer a 'Give additional 
"PKG",188,22,1,"PAH",1,1,9,0)
dose NOW' prompt in the [ORCM QUICK ORDERS] menu option. This patch 
"PKG",188,22,1,"PAH",1,1,10,0)
corrects this problem by prompting for 'Give additional dose NOW' if the 
"PKG",188,22,1,"PAH",1,1,11,0)
schedule does not have a schedule type of 'ONE-TIME'. 
"PKG",188,22,1,"PAH",1,1,12,0)
HD0000000277913, PSPO #1140
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","ORCACT0")
0^1^B56723098^B52518165
"RTN","ORCACT0",1,0)
ORCACT0 ;SLC/MKB-Validate order action ;5/19/08
"RTN","ORCACT0",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,27,48,72,86,92,94,141,165,177,173,190,215,243,289**;Dec 17, 1997;Build 3
"RTN","ORCACT0",3,0)
 ;
"RTN","ORCACT0",4,0)
 ;Reference to REFILL^PSOREF supported by IA #2399
"RTN","ORCACT0",5,0)
 ;
"RTN","ORCACT0",6,0)
VALID(IFN,ACTION,ERROR,NATR) ; -- Determines if action is valid for order IFN
"RTN","ORCACT0",7,0)
 N OR0,OR3,ORA0,AIFN,PKG,DG,ORDSTS,ACTSTS,VER,X,Y,MEDPARM K ERROR
"RTN","ORCACT0",8,0)
 S OR0=$G(^OR(100,+IFN,0)),OR3=$G(^(3)),PKG=$$NMSP^ORCD($P(OR0,U,14))
"RTN","ORCACT0",9,0)
 S DG=$P($G(^ORD(100.98,+$P(OR0,U,11),0)),U,3)
"RTN","ORCACT0",10,0)
 S MEDPARM=$S($G(NATR)="A":2,PKG'="PS":2,'$D(^XUSEC("OREMAS",DUZ)):2,DG="NV RX":$$GET^XPAR("ALL","OR OREMAS NON-VA MED ORDERS"),1:$$GET^XPAR("ALL","OR OREMAS MED ORDERS"))
"RTN","ORCACT0",11,0)
 S AIFN=$P(IFN,";",2) S:'AIFN AIFN=+$P(OR3,U,7)
"RTN","ORCACT0",12,0)
 S ORA0=$G(^OR(100,+IFN,8,AIFN,0)),ACTSTS=$P(ORA0,U,15)
"RTN","ORCACT0",13,0)
 S ORDSTS=$P(OR3,U,3),VER=$S($P(OR0,U,5)["101.41":3,1:2)
"RTN","ORCACT0",14,0)
CM I ACTION="CM" S ERROR="This action is no longer available!" G VQ ; ward comments - no restrictions
"RTN","ORCACT0",15,0)
FL I ACTION="FL" D  G VQ ; flag
"RTN","ORCACT0",16,0)
 . I +$G(^OR(100,+IFN,8,AIFN,3)) S ERROR="This order is already flagged!" Q
"RTN","ORCACT0",17,0)
UF I ACTION="UF" D  G VQ ; unflag
"RTN","ORCACT0",18,0)
 . I '+$G(^OR(100,+IFN,8,AIFN,3)) S ERROR="This order is not flagged!" Q
"RTN","ORCACT0",19,0)
DC1 I ACTION="DC",ACTSTS D  G VQ ; discontinue/cancel unrel or canc order
"RTN","ORCACT0",20,0)
 . I (ACTSTS=11)!(ACTSTS=10) D  Q  ; unreleased
"RTN","ORCACT0",21,0)
 .. I 'MEDPARM S ERROR="You are not authorized to cancel med orders!" Q
"RTN","ORCACT0",22,0)
 .. I $G(NATR)="A" S X=$O(^ORE(100.2,"AO",+IFN,0)) I X,'$G(^ORE(100.2,X,1)) S ERROR="Future event orders may not be auto-discontinued!" Q
"RTN","ORCACT0",23,0)
 . I ACTSTS=12 S ERROR="This order has been dc'd due to edit!" Q
"RTN","ORCACT0",24,0)
 . I ACTSTS=13 S ERROR="This order has been cancelled!" Q
"RTN","ORCACT0",25,0)
ES I (ACTION="ES")!(ACTION="OC")!(ACTION="RS")!(ACTION="DS") D ES^ORCACT01 G VQ ; sign
"RTN","ORCACT0",26,0)
VR I ACTION="VR" D  G VQ ; verify
"RTN","ORCACT0",27,0)
 . I $G(ORVER)="N",$P(ORA0,U,9) S ERROR="This order has been verified!" Q
"RTN","ORCACT0",28,0)
 . I $G(ORVER)="C",$P(ORA0,U,11) S ERROR="This order has been verified!" Q
"RTN","ORCACT0",29,0)
 . I $G(ORVER)="R",$P(ORA0,U,19) S ERROR="This order has been reviewed!" Q
"RTN","ORCACT0",30,0)
 . I (ACTSTS=11)!(ACTSTS=10) S ERROR="This order has not been released to the service." Q
"RTN","ORCACT0",31,0)
 . I AIFN=1,ORDSTS=5,PKG="PS" S X=$$DISABLED I X S ERROR=$P(X,U,2) Q
"RTN","ORCACT0",32,0)
DIS S X=$$DISABLED I X S ERROR=$P(X,U,2) G VQ
"RTN","ORCACT0",33,0)
MN I ACTION="MN" D  G VQ ; manually release (delayed)
"RTN","ORCACT0",34,0)
 . I ACTSTS'=10,ACTSTS'=11 S ERROR="This order has already been released!" Q
"RTN","ORCACT0",35,0)
 . I $P(OR0,U,12)="I",'$G(^DPT(+ORVP,.105)) S ERROR="This patient is not currently admitted!"
"RTN","ORCACT0",36,0)
GMRA I PKG="GMRA" S ERROR="This action is not allowed on an allergy/adverse reaction!" G VQ ; no actions allowed on Allergies
"RTN","ORCACT0",37,0)
MEDS I PKG="PS",'MEDPARM S ERROR="You are not authorized to enter med orders!" G VQ
"RTN","ORCACT0",38,0)
RW I ACTION="RW" D RW^ORCACT01 G VQ ; rewrite/copy
"RTN","ORCACT0",39,0)
XFR I ACTION="XFR" D  G VQ
"RTN","ORCACT0",40,0)
 . N A
"RTN","ORCACT0",41,0)
 . S A=""
"RTN","ORCACT0",42,0)
 . F  S A=$O(^OR(100,+IFN,4.5,"ID","CONJ",A)) Q:'A  I ^OR(100,+IFN,4.5,A,1)="X" S ERROR="Orders with a conjunction of 'EXCEPT' may not be transferred." Q
"RTN","ORCACT0",43,0)
 . I $G(ERROR)]"" Q
"RTN","ORCACT0",44,0)
 . D XFR^ORCACT01 ; transfer to in/outpt
"RTN","ORCACT0",45,0)
RN I ACTION="RN" D RN^ORCACT01 G VQ ; renew
"RTN","ORCACT0",46,0)
TRM I $$DONE G VQ ; ORDSTS=1,2,7,12,13
"RTN","ORCACT0",47,0)
EV I ACTION="EV" D  G VQ ; change delay event
"RTN","ORCACT0",48,0)
 . I ORDSTS'=10,ORDSTS'=11 S ERROR="This order has been released!" Q
"RTN","ORCACT0",49,0)
 . I DG="NV RX" S ERROR="Non-VA Med orders do not support this action!" Q
"RTN","ORCACT0",50,0)
 . I $$EVTORDER^OREVNTX(IFN) S ERROR="The release event for this order may not be changed!" Q
"RTN","ORCACT0",51,0)
 . S X=$P(ORA0,U,4) I X'=2,X'=3 S ERROR="Signed orders may not be delayed to another event!" Q
"RTN","ORCACT0",52,0)
DC2 I ACTION="DC",ACTSTS="" D  G VQ ; DC released order
"RTN","ORCACT0",53,0)
 . I $G(NATR)="A" D  Q:$D(ERROR)
"RTN","ORCACT0",54,0)
 .. S X=$O(^ORE(100.2,"AO",+IFN,0)) I X S:'$G(^ORE(100.2,X,1)) ERROR="Future event orders may not be auto-discontinued!" Q
"RTN","ORCACT0",55,0)
 .. I $$GET1^DIQ(9.4,+$P(OR0,U,14)_",",1)="PSO",$G(DGPMT)=1 Q  ;177 If admission auto-dc and order is outpt med then no further checking needed
"RTN","ORCACT0",56,0)
 .. I $G(DGPMT)=1,$P($G(^SC(+$P(OR0,U,10),0)),U,3)'="C" S ERROR="Only outpatient orders may be auto-discontinued!" Q
"RTN","ORCACT0",57,0)
 .. I $G(DGPMT)'=1,$P($G(^SC(+$P(OR0,U,10),0)),U,3)="C",PKG'="PS" S ERROR="Only inpatient orders may be auto-discontinued!" Q
"RTN","ORCACT0",58,0)
 . I PKG="RA",ORDSTS=6 S ERROR="Active Radiology orders cannot be discontinued!" Q
"RTN","ORCACT0",59,0)
 . I PKG="VBEC",ORDSTS=6 S ERROR="Active Blood Product orders cannot be discontinued!" Q
"RTN","ORCACT0",60,0)
 . I PKG="LR" D  Q
"RTN","ORCACT0",61,0)
 .. I $$COLLECTD S ERROR="Lab orders that have been collected may not be discontinued!" Q
"RTN","ORCACT0",62,0)
 .. I $G(NATR)="A","^12^38^"'[(U_$P($G(DGPMA),U,18)_U),$$VALUE^ORX8(+IFN,"COLLECT")="SP",$P(OR0,U,8)'<DT S ERROR="Future Send Patient orders may not be auto-discontinued!" Q
"RTN","ORCACT0",63,0)
 . I PKG="GMRC",ORDSTS=9 S ERROR="Consults orders with partial results cannot be discontinued!" Q
"RTN","ORCACT0",64,0)
 . I DG="DO",$G(DGPMT)'=3,ORDSTS=6,'$$NPO(+IFN) S ERROR="Active Diets cannot be discontinued; please order a new diet!" Q
"RTN","ORCACT0",65,0)
RL I ACTION="RL" D  G VQ  ; release hold
"RTN","ORCACT0",66,0)
 . I ORDSTS'=3 D  Q
"RTN","ORCACT0",67,0)
 ..I $P(ORA0,U,4)=2 S ERROR="Providers has not yet signed the hold order and therefor it cannot yet be released" Q
"RTN","ORCACT0",68,0)
 ..S ERROR="Orders not on hold cannot be released!" Q
"RTN","ORCACT0",69,0)
 . I ACTSTS S ERROR=$$ACTION($P(ORA0,U,2))_" orders cannot be released from hold!" Q
"RTN","ORCACT0",70,0)
 . N NATR,ACT S ACT=$S($P(ORA0,U,2)="HD":AIFN,1:+$P(OR3,U,7))
"RTN","ORCACT0",71,0)
 . S NATR=+$P($G(^OR(100,+IFN,8,ACT,0)),U,12),ACT=$P($G(^(0)),U,2)
"RTN","ORCACT0",72,0)
 . I PKG="RA"!(ACT'="HD")!($P($G(^ORD(100.02,NATR,0)),U,2)="S") S ERROR="Orders held by a service must be released from hold through the service!" Q
"RTN","ORCACT0",73,0)
AIFN S X=$P(ORA0,U,2) I AIFN>1,ACTSTS S ERROR="This action is not allowed on a "_$$ACTION(X)_" order!" G VQ
"RTN","ORCACT0",74,0)
RF I ACTION="RF" D  G VQ
"RTN","ORCACT0",75,0)
 . I DG'="O RX" S ERROR="Only Outpatient Med orders may be refilled!" Q
"RTN","ORCACT0",76,0)
 . I ORDSTS=5 S ERROR="Pending orders may not be refilled!" Q
"RTN","ORCACT0",77,0)
 . I ORDSTS=7 S ERROR="Expired orders may not be refilled!" Q
"RTN","ORCACT0",78,0)
 . N X,PSIFN S PSIFN=$G(^OR(100,+IFN,4))
"RTN","ORCACT0",79,0)
 . S X=$$REFILL^PSOREF(PSIFN) I X'>0 S ERROR=$P(X,U,2) Q
"RTN","ORCACT0",80,0)
CP I ACTION="CP" D  G VQ ; complete
"RTN","ORCACT0",81,0)
 . I PKG'="OR" S ERROR="Only generic text orders may be completed through this option!" Q
"RTN","ORCACT0",82,0)
 . I ORDSTS=11!(ORDSTS=10) S ERROR="This order has not been released!" Q
"RTN","ORCACT0",83,0)
AL I ACTION="AL" D  G VQ
"RTN","ORCACT0",84,0)
 . I PKG'="LR",PKG'="RA",PKG'="GMRC" S ERROR="This order does not generate results!" Q
"RTN","ORCACT0",85,0)
 . I $P(OR3,U,10) S ERROR="This order is already flagged to alert the provider when resulted!" Q
"RTN","ORCACT0",86,0)
XX I ACTION="XX" D  G VQ ; edit/change
"RTN","ORCACT0",87,0)
 . I ORDSTS=7 S ERROR="Expired orders may not be changed!" Q
"RTN","ORCACT0",88,0)
 . D XX^ORCACT01
"RTN","ORCACT0",89,0)
HD I ACTION="HD" D  G VQ ; hold
"RTN","ORCACT0",90,0)
 . I PKG="FH" S ERROR="Diet orders cannot be held!" Q
"RTN","ORCACT0",91,0)
 . I PKG="LR" S ERROR="Lab orders cannot be held!" Q
"RTN","ORCACT0",92,0)
 . I PKG="RA" S ERROR="Radiology orders cannot be held!" Q
"RTN","ORCACT0",93,0)
 . I PKG="GMRC" S ERROR="Consult orders cannot be held!" Q
"RTN","ORCACT0",94,0)
 . I DG="NV RX" S ERROR="Non-VA Med orders cannot be held!" Q
"RTN","ORCACT0",95,0)
 . I ORDSTS=3 S ERROR="This order is already on hold!" Q
"RTN","ORCACT0",96,0)
 . I ORDSTS'=6,PKG="PS" S ERROR="Only active Pharmacy orders may be held!" Q
"RTN","ORCACT0",97,0)
 . I (ORDSTS=11)!(ORDSTS=10) S ERROR="This order has not been released to the service." Q
"RTN","ORCACT0",98,0)
VQ S Y=$S($D(ERROR):0,1:1)
"RTN","ORCACT0",99,0)
 Q Y
"RTN","ORCACT0",100,0)
 ;
"RTN","ORCACT0",101,0)
ACTION(X) ; -- Return text of action X
"RTN","ORCACT0",102,0)
 N Y S Y=$S(X="NW":"New",X="DC":"Discontinue",X="HD":"Hold",X="RL":"Release Hold",X="RN":"Renew",1:X)
"RTN","ORCACT0",103,0)
 Q Y
"RTN","ORCACT0",104,0)
 ;
"RTN","ORCACT0",105,0)
NPO(ORIFN) ; -- Returns 1 or 0, if order ORIFN is for NPO
"RTN","ORCACT0",106,0)
 N X,Y S X=$$VALUE^ORX8(+ORIFN,"ORDERABLE",1,"E")
"RTN","ORCACT0",107,0)
 S Y=$S($E(X,1,3)="NPO":1,1:0)
"RTN","ORCACT0",108,0)
 Q Y
"RTN","ORCACT0",109,0)
 ;
"RTN","ORCACT0",110,0)
COLLECTD() ; -- Lab order collected/active (incl all children)?
"RTN","ORCACT0",111,0)
 I (ORDSTS=11)!(ORDSTS=10) Q 0 ; unreleased
"RTN","ORCACT0",112,0)
 I '$O(^OR(100,+IFN,2,0)) Q (ORDSTS'=5)
"RTN","ORCACT0",113,0)
 ;I ORDSTS'=6 Q 1 ; Parent -> active instead of pending
"RTN","ORCACT0",114,0)
 N Y,Z S Y=1,Z=0
"RTN","ORCACT0",115,0)
 F  S Z=$O(^OR(100,+IFN,2,Z)) Q:Z'>0  I $P($G(^OR(100,Z,3)),U,3)=5 S Y=0 Q
"RTN","ORCACT0",116,0)
 Q Y
"RTN","ORCACT0",117,0)
 ;
"RTN","ORCACT0",118,0)
DONE() ; -- sets ERROR if terminal status
"RTN","ORCACT0",119,0)
 I ORDSTS=1 S ERROR="This order has been discontinued!" Q 1
"RTN","ORCACT0",120,0)
 I ORDSTS=2 S ERROR="This order has been completed!" Q 1
"RTN","ORCACT0",121,0)
 I ORDSTS=7,DG'="O RX" S ERROR="This order has expired!" Q 1
"RTN","ORCACT0",122,0)
 I ORDSTS=12 S ERROR="This order has been changed!" Q 1
"RTN","ORCACT0",123,0)
 I ORDSTS=13 S ERROR="This order has been cancelled!" Q 1
"RTN","ORCACT0",124,0)
 I ORDSTS=14 S ERROR="This order has lapsed!" Q 1
"RTN","ORCACT0",125,0)
 I ORDSTS=15 S ERROR="This order has been renewed!" Q 1
"RTN","ORCACT0",126,0)
 Q 0
"RTN","ORCACT0",127,0)
 ;
"RTN","ORCACT0",128,0)
DISABLED() ; -- Order dialog [or protocol] disabled?
"RTN","ORCACT0",129,0)
 N X,DLG S DLG=$P(OR0,U,5),X=0 I +DLG'>0 Q X
"RTN","ORCACT0",130,0)
 I VER'<3,DLG?1.N1";ORD(101.41," S X=$$MSG^ORXD(+DLG) Q X
"RTN","ORCACT0",131,0)
 S DLG=$S(PKG="RA":"RA OERR EXAM",PKG="GMRC":"GMRCOR CONSULT",1:"")
"RTN","ORCACT0",132,0)
 I $L(DLG) S DLG=+$O(^ORD(101.41,"AB",DLG,0)),X=$$MSG^ORXD(DLG)
"RTN","ORCACT0",133,0)
 Q X
"RTN","ORCDPS3")
0^2^B44868198^B43323695
"RTN","ORCDPS3",1,0)
ORCDPS3 ;SLC/MKB-Pharmacy dialog utilities ;09/11/07
"RTN","ORCDPS3",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**94,116,134,158,149,190,277,243,289**;Dec 17, 1997;Build 3
"RTN","ORCDPS3",3,0)
 ;
"RTN","ORCDPS3",4,0)
 ;Reference to SCNEW^PSOCP supported by IA #2534
"RTN","ORCDPS3",5,0)
 ;Reference to DIS^DGRPDB supported by IA #700
"RTN","ORCDPS3",6,0)
 ;Reference to ^PSJORPOE supported by IA #3167
"RTN","ORCDPS3",7,0)
 ;
"RTN","ORCDPS3",8,0)
START ; -- Start Date entry action
"RTN","ORCDPS3",9,0)
 S $P(ORDIALOG(PROMPT,0),":",3)=$S($G(ORCAT)="I":"ETRX",1:"EX")
"RTN","ORCDPS3",10,0)
 I $G(ORCAT)'="I" K ORSD K:$G(ORENEW)!$G(OREWRITE)!$D(OREDIT) ORDIALOG(PROMPT,INST) ;Inpt only
"RTN","ORCDPS3",11,0)
 Q
"RTN","ORCDPS3",12,0)
 ;
"RTN","ORCDPS3",13,0)
ADMIN ; -- Return default admin time for order in ORSD
"RTN","ORCDPS3",14,0)
 ;    Called from EXDOSE^ORCDPS2
"RTN","ORCDPS3",15,0)
 Q:$D(ORSD)  Q:$G(ORCAT)'="I"  ;inpt only
"RTN","ORCDPS3",16,0)
 N PSOI,PSIFN,SCH,CNJ,ORI,ORX
"RTN","ORCDPS3",17,0)
 S PSOI=+$P($G(^ORD(101.43,+$G(OROI),0)),U,2)
"RTN","ORCDPS3",18,0)
 S PSIFN=$S($G(ORENEW):$G(^OR(100,+$G(ORIFN),4)),1:"")
"RTN","ORCDPS3",19,0)
 S SCH=$$PTR^ORCD("OR GTX SCHEDULE"),CNJ=$$PTR^ORCD("OR GTX AND/THEN"),ORX=""
"RTN","ORCDPS3",20,0)
 S ORI=0 F  S ORI=$O(ORDIALOG(PROMPT,ORI)) Q:ORI<1  S ORX=ORX_$S($L(ORX):U,1:"")_$G(ORDIALOG(CNJ,ORI))_";"_$G(ORDIALOG(SCH,ORI))
"RTN","ORCDPS3",21,0)
 S ORSD=$$FIRST(+ORVP,+$G(ORWARD),PSOI,ORX,PSIFN,"")
"RTN","ORCDPS3",22,0)
 S:$P(ORSD,U)="NEXT" ORSD="NEXTA^"_$P(ORSD,U,2,99)
"RTN","ORCDPS3",23,0)
 Q
"RTN","ORCDPS3",24,0)
 ;
"RTN","ORCDPS3",25,0)
FIRST(DFN,WARD,OI,DATA,ORDER,ADMIN)   ; -- Return expected first admin time of order
"RTN","ORCDPS3",26,0)
 N CNT,ORCNT,ORI,J,ORZ,Y,SCH,ORX,TNUM
"RTN","ORCDPS3",27,0)
 I '$G(DFN)!'$G(OI) Q ""
"RTN","ORCDPS3",28,0)
 S ORCNT=0 F ORI=1:1:$L(DATA,"^") S ORZ=$P(DATA,U,ORI) D  Q:$E(ORZ)="T"
"RTN","ORCDPS3",29,0)
 .S TNUM=$$NUMCHAR(ORZ,";") Q:TNUM=0
"RTN","ORCDPS3",30,0)
 .F CNT=1:1:TNUM D
"RTN","ORCDPS3",31,0)
 .. S SCH=$P(ORZ,";",CNT+1) Q:'$L(SCH)  S ORCNT=ORCNT+1
"RTN","ORCDPS3",32,0)
 .. I ORCNT>1 S ADMIN=""
"RTN","ORCDPS3",33,0)
 .. S ORX(ORCNT)=$$STARTSTP^PSJORPOE(DFN,SCH,OI,WARD,$G(ORDER),$G(ADMIN))
"RTN","ORCDPS3",34,0)
 S Y=9999999,J=0
"RTN","ORCDPS3",35,0)
 F ORI=1:1:ORCNT S ORZ=$P(ORX(ORI),U,4) I ORZ<Y S Y=ORZ,J=ORI ;earliest
"RTN","ORCDPS3",36,0)
 S Y=$S(J:ORX(J),1:"")
"RTN","ORCDPS3",37,0)
 Q Y
"RTN","ORCDPS3",38,0)
 ;
"RTN","ORCDPS3",39,0)
NUMCHAR(STRING,SUB) ;
"RTN","ORCDPS3",40,0)
 N CNT,RESULT
"RTN","ORCDPS3",41,0)
 S RESULT=0
"RTN","ORCDPS3",42,0)
 F CNT=1:1:$L(STRING) I $E(STRING,CNT)=SUB S RESULT=RESULT+1
"RTN","ORCDPS3",43,0)
 Q RESULT
"RTN","ORCDPS3",44,0)
 ;
"RTN","ORCDPS3",45,0)
NOW ; -- First dose now?
"RTN","ORCDPS3",46,0)
 N X,Y,DIR,SCH
"RTN","ORCDPS3",47,0)
 K ^TMP($J,"ORCDPS3 NOW")
"RTN","ORCDPS3",48,0)
 I $G(ORCAT)="O"!'$D(ORSD)!$L($G(OREVENT))!$G(ORENEW) K ORDIALOG(PROMPT,INST),^TMP($J,"ORCDPS3 NOW") Q
"RTN","ORCDPS3",49,0)
 D AP^PSS51P1("PSJ",,,,"ORCDPS3 NOW")
"RTN","ORCDPS3",50,0)
 ; ask on Copy? Change?
"RTN","ORCDPS3",51,0)
 S X=$$PTR^ORCD("OR GTX SCHEDULE"),Y=+$O(ORDIALOG(X,0))
"RTN","ORCDPS3",52,0)
 S SCH=$G(ORDIALOG(X,Y)),Y=+$O(^TMP($J,"ORCDPS3 NOW","APPSJ",SCH,0)) ;1st one
"RTN","ORCDPS3",53,0)
 ;S SCH=$G(ORDIALOG(X,Y)),Y=+$O(^PS(51.1,"APPSJ",SCH,0)) ;1st one
"RTN","ORCDPS3",54,0)
 I $P($G(^TMP($J,"ORCDPS3 NOW",Y,5)),"^")="O"!(Y<1) K ORDIALOG(PROMPT,INST),^TMP($J,"ORCDPS3 NOW") Q
"RTN","ORCDPS3",55,0)
 ;I $P($G(^PS(51.1,Y,0)),U,5)="O"!(Y<1) K ORDIALOG(PROMPT,INST),^TMP($J,"ORCDPS3 NOW") Q
"RTN","ORCDPS3",56,0)
 ; other conditions?
"RTN","ORCDPS3",57,0)
 S DIR(0)="YA",DIR("A")="Give additional dose NOW? "
"RTN","ORCDPS3",58,0)
 S DIR("B")=$S($G(ORDIALOG(PROMPT,INST)):"YES",1:"NO")
"RTN","ORCDPS3",59,0)
 I ORINPT,$P(ORSD,U,4) S DIR("A",1)="Next scheduled administration time: "_$$FMTE^XLFDT($P(ORSD,U,4))
"RTN","ORCDPS3",60,0)
 S DIR("?")="Enter YES if you want a dose given now in addition to the regular administration times for this schedule and ward."
"RTN","ORCDPS3",61,0)
 D ^DIR S:$D(DTOUT)!$D(DUOUT) ORQUIT=1
"RTN","ORCDPS3",62,0)
 I $G(ORQUIT)!(Y'>0) K ORDIALOG(PROMPT,INST),^TMP($J,"ORCDPS3 NOW") Q
"RTN","ORCDPS3",63,0)
 S ORDIALOG(PROMPT,INST)=1 I $G(ORCOMPLX) D
"RTN","ORCDPS3",64,0)
 . W $C(7),!,"  >> First Dose NOW is in addition to those already entered.    <<"
"RTN","ORCDPS3",65,0)
 . W !,"  >> Please adjust the duration of the first one, if necessary. <<"
"RTN","ORCDPS3",66,0)
 K ^TMP($J,"ORCDPS3 NOW")
"RTN","ORCDPS3",67,0)
 Q
"RTN","ORCDPS3",68,0)
 ;
"RTN","ORCDPS3",69,0)
DEFSTRT ; -- Returns default start date/time in Y
"RTN","ORCDPS3",70,0)
 ;    Expects PROMPT,INST,ORDIALOG,ORSD to be defined
"RTN","ORCDPS3",71,0)
 ;
"RTN","ORCDPS3",72,0)
 Q:$G(ORCAT)="O"  Q:$G(ORTYPE)="Z"  ;skip if outpt or editor
"RTN","ORCDPS3",73,0)
 N LAST,STRT,DUR,D1,D2,OFF,F1,F2,UNT,Y1,Y2,I,J K Y
"RTN","ORCDPS3",74,0)
 S LAST=+$O(ORDIALOG(+$$PTR^ORCD("OR GTX INSTRUCTIONS"),INST),-1)
"RTN","ORCDPS3",75,0)
 S STRT=$G(ORDIALOG(PROMPT,LAST))
"RTN","ORCDPS3",76,0)
 I LAST'>0!'$L(STRT) S:$L($P($G(ORSD),U)) Y=$P(ORSD,U) Q  ;first inst
"RTN","ORCDPS3",77,0)
 S DUR=$G(ORDIALOG(+$$PTR^ORCD("OR GTX DURATION"),LAST))
"RTN","ORCDPS3",78,0)
 I +DUR'>0 S Y=STRT Q  ;no duration = same start
"RTN","ORCDPS3",79,0)
 S DUR=$$FMDUR(DUR) I STRT D  Q  ;FM date/time, so just add
"RTN","ORCDPS3",80,0)
 . N X,%DT S %DT="TX",X=STRT_"+"_DUR D ^%DT
"RTN","ORCDPS3",81,0)
 . I Y'>0 S Y=STRT ;error
"RTN","ORCDPS3",82,0)
 S D1=+DUR,D2=$P(DUR,D1,2) S:(STRT="NEXTA")!(STRT="CLOSEST") STRT="NOW"
"RTN","ORCDPS3",83,0)
 S OFF=$P(STRT,"+",2) I '$L(OFF) S Y=STRT_"+"_DUR Q  ;no prev offset
"RTN","ORCDPS3",84,0)
 S F1=+OFF,F2=$P(OFF,F1,2),UNT=F2,Y=STRT
"RTN","ORCDPS3",85,0)
 I D2=F2 S Y=$P(STRT,"+")_"+"_(D1+F1)_UNT Q  ;same units
"RTN","ORCDPS3",86,0)
 F I="S","'","H","D","W","M" I (F2=I)!(D2=I) S UNT=I D  Q
"RTN","ORCDPS3",87,0)
 . S:D2=UNT Y1=D1,X1=F1,X2=F2 ; Y1=# in UNT
"RTN","ORCDPS3",88,0)
 . S:F2=UNT Y1=F1,X1=D1,X2=D2 ; X1=# in other units X2
"RTN","ORCDPS3",89,0)
 . F J=1:1 S Z=$T(CONV+J) Q:Z["ZZZZ"  I $P(Z,";",3,4)=(X2_";"_UNT) S Y2=+$P(Z,";",5) Q
"RTN","ORCDPS3",90,0)
 . S Y=$P(STRT,"+")_"+"_(Y1+$S(Y2:Y2*X1,1:0))_UNT
"RTN","ORCDPS3",91,0)
 Q
"RTN","ORCDPS3",92,0)
 ;
"RTN","ORCDPS3",93,0)
FMDUR(X)        ; -- convert '# DAYS' to #D
"RTN","ORCDPS3",94,0)
 N X1,X2,Y I +X'>0 Q ""
"RTN","ORCDPS3",95,0)
 S X1=+X,X2=$P(X," ",2) S:'$L(X2) X2="DAYS"
"RTN","ORCDPS3",96,0)
 S Y=X1_$S("MINUTES"[X2:"'",1:$E(X2))
"RTN","ORCDPS3",97,0)
 Q Y
"RTN","ORCDPS3",98,0)
 ;
"RTN","ORCDPS3",99,0)
CONV ;;unit;unit;factor
"RTN","ORCDPS3",100,0)
 ;;';S;60
"RTN","ORCDPS3",101,0)
 ;;H;';60
"RTN","ORCDPS3",102,0)
 ;;H;S;3600
"RTN","ORCDPS3",103,0)
 ;;D;H;24
"RTN","ORCDPS3",104,0)
 ;;D;';1440
"RTN","ORCDPS3",105,0)
 ;;D;S;86400
"RTN","ORCDPS3",106,0)
 ;;W;D;7
"RTN","ORCDPS3",107,0)
 ;;W;H;168
"RTN","ORCDPS3",108,0)
 ;;W;';10080
"RTN","ORCDPS3",109,0)
 ;;W;S;604800
"RTN","ORCDPS3",110,0)
 ;;M;W;4
"RTN","ORCDPS3",111,0)
 ;;M;D;30
"RTN","ORCDPS3",112,0)
 ;;M;H;720
"RTN","ORCDPS3",113,0)
 ;;M;';43200
"RTN","ORCDPS3",114,0)
 ;;M;S;2592000
"RTN","ORCDPS3",115,0)
 ;;ZZZZ
"RTN","ORCDPS3",116,0)
 ;
"RTN","ORCDPS3",117,0)
ASKDUR()        ; -- Returns 1 or 0, if Duration prompt should be asked
"RTN","ORCDPS3",118,0)
 K ^TMP($J,"ORCDPS3 ASKDUR")
"RTN","ORCDPS3",119,0)
 N X,Y I '$G(ORCOMPLX) K ORDIALOG(PROMPT,INST) Q 0
"RTN","ORCDPS3",120,0)
 S Y=1 G:'$L($G(ORSCH)) ADQ ;no schedule
"RTN","ORCDPS3",121,0)
 D AP^PSS51P1("PSJ",,,,"ORCDPS3 ASKDUR")
"RTN","ORCDPS3",122,0)
 S X=+$O(^TMP($J,"ORCDPS3 ASKDUR","APPSJ",ORSCH,"")) G:X'>0 ADQ
"RTN","ORCDPS3",123,0)
 ;S X=+$O(^PS(51.1,"APPSJ",ORSCH,0)) G:X'>0 ADQ
"RTN","ORCDPS3",124,0)
 S:^TMP($J,"ORCDPS3 ASKDUR",X,5)="O" Y=0
"RTN","ORCDPS3",125,0)
 ;S:$P($G(^PS(51.1,X,0)),U,5)="O" Y=0
"RTN","ORCDPS3",126,0)
ADQ ;
"RTN","ORCDPS3",127,0)
 K ^TMP($J,"ORCDPS3 ASKDUR")
"RTN","ORCDPS3",128,0)
 Q Y
"RTN","ORCDPS3",129,0)
 ;
"RTN","ORCDPS3",130,0)
CKDUR(X) ; -- Returns validated form of duration X, or null if invalid
"RTN","ORCDPS3",131,0)
 N X1,X2,Y,Z S Y=""
"RTN","ORCDPS3",132,0)
 S X1=+$G(X),X2=$P($G(X),X1,2) I X1'>0 Q ""
"RTN","ORCDPS3",133,0)
 S X2=$$UP^XLFSTR(X2),X2=$$STRIP^XLFSTR(X2," ") S:'$L(X2) X2="DAYS"
"RTN","ORCDPS3",134,0)
 F Z="MONTHS^&MONTHS&MONS","WEEKS^&WEEKS&WKS","DAYS^&DAYS&DYS","HOURS^&HOURS&HRS","MINUTES^&MINUTES&MINS'","SECONDS^&SECONDS&SECS" I $P(Z,U,2)[("&"_X2) S Y=$P(Z,U) Q
"RTN","ORCDPS3",135,0)
 S:$L(Y) Y=X1_" "_$S(X1=1:$E(Y,1,$L(Y)-1),1:Y) ;strip trailing 's'
"RTN","ORCDPS3",136,0)
 Q Y
"RTN","ORCDPS3",137,0)
 ;
"RTN","ORCDPS3",138,0)
DUR ; -- Process duration [from P-S Action]
"RTN","ORCDPS3",139,0)
 N X S X=$G(ORDIALOG(PROMPT,ORI)),X=$$CKDUR(X)
"RTN","ORCDPS3",140,0)
 I '$L(X) K DONE W $C(7),!,ORDIALOG(PROMPT,"?"),! Q
"RTN","ORCDPS3",141,0)
 S ORDIALOG(PROMPT,ORI)=X D:$G(ORESET)'=X CHANGED^ORCDPS1("QUANTITY")
"RTN","ORCDPS3",142,0)
 Q
"RTN","ORCDPS3",143,0)
 ;
"RTN","ORCDPS3",144,0)
TEST(START,DURTN)       ; -- test DEFSTRT
"RTN","ORCDPS3",145,0)
 N INST,ORSD,ORDIALOG,PROMPT
"RTN","ORCDPS3",146,0)
 S ORDIALOG(136,1)="",INST=2,ORSD="NOW",PROMPT=6
"RTN","ORCDPS3",147,0)
 S:$L($G(START)) ORDIALOG(6,1)=START S:$G(DURTN) ORDIALOG(153,1)=DURTN
"RTN","ORCDPS3",148,0)
 D DEFSTRT W !,Y
"RTN","ORCDPS3",149,0)
 Q
"RTN","ORCDPS3",150,0)
 ;
"RTN","ORCDPS3",151,0)
SC ; -- Dialog validation, to ask SC questions
"RTN","ORCDPS3",152,0)
 ;    Expects ORIFN, ORDA, and ORDER
"RTN","ORCDPS3",153,0)
 ;
"RTN","ORCDPS3",154,0)
 Q:'$L($T(SCNEW^PSOCP))  Q:'$G(ORIFN)  Q:'$G(ORDA)
"RTN","ORCDPS3",155,0)
 Q:$P($G(^OR(100,ORIFN,0)),U,12)'="O"  Q:$P($G(^(8,ORDA,0)),U,2)'="NW"  Q:$P($G(^(0)),U,15)=""
"RTN","ORCDPS3",156,0)
 ;
"RTN","ORCDPS3",157,0)
 N OR3,ORDRUG,PSIFN,ORX,I,J,DIE,DR,DA,X,Y,DTOUT,ORIGVIEW,DFN
"RTN","ORCDPS3",158,0)
 S OR3=$G(^OR(100,ORIFN,3)),X=$P(OR3,U,11) I X>2 Q  ;new, edit, or renew
"RTN","ORCDPS3",159,0)
 I X S Y=$P(OR3,U,5),PSIFN=$G(^OR(100,Y,4)) ;get PS# if edit/renewal
"RTN","ORCDPS3",160,0)
 S ORDRUG=$$VALUE^ORCSAVE2(ORIFN,"DRUG")
"RTN","ORCDPS3",161,0)
 D SCNEW^PSOCP(.ORX,+ORVP,ORDRUG,$G(PSIFN)) Q:'$D(ORX)
"RTN","ORCDPS3",162,0)
 S DIE="^OR(100,",DA=ORIFN,DR="",J=0
"RTN","ORCDPS3",163,0)
 F I="SC","MST","AO","IR","EC","HNC","CV" S J=J+1 I $D(ORX(I)) S X=ORX(I) S:I="CV"&(X="") X=1 S DR=DR_";5"_J_"R"_$S($L(X):"//"_$S(X:"YES",1:"NO"),1:"")
"RTN","ORCDPS3",164,0)
 S:$E(DR)=";" DR=$E(DR,2,999) Q:'$L(DR)  S ORIGVIEW=1
"RTN","ORCDPS3",165,0)
 I $D(ORX("SC")) S DFN=+ORVP D DIS^DGRPDB ;show current SC data
"RTN","ORCDPS3",166,0)
 W !!,"Is "_$$ORDITEM^ORCACT(ORDER)_" for treatment related to:"
"RTN","ORCDPS3",167,0)
 D ^DIE S:$D(DTOUT)!$D(Y) ORQUIT=1
"RTN","ORCDPS3",168,0)
 Q
"VER")
8.0^22.0
"BLD",7579,6)
^268
**END**
**END**

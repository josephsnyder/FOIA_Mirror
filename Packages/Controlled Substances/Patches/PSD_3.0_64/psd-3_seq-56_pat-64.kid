Released PSD*3*64 SEQ #56
Extracted from mail message
**KIDS**:PSD*3.0*64^

**INSTALL NAME**
PSD*3.0*64
"BLD",6329,0)
PSD*3.0*64^CONTROLLED SUBSTANCES^0^3070829^y
"BLD",6329,1,0)
^^5^5^3070419^
"BLD",6329,1,1,0)
When a PCA/Syringe is already signed out to a patient and that
"BLD",6329,1,2,0)
green sheet and patient are trasnferred to another NAOU, the 
"BLD",6329,1,3,0)
quantity is subtracted from the sending NAOU and added to the
"BLD",6329,1,4,0)
receiving NAOU even though it has already been signed out to
"BLD",6329,1,5,0)
the patient.
"BLD",6329,4,0)
^9.64PA^^0
"BLD",6329,6)
5^
"BLD",6329,6.3)
33
"BLD",6329,"KRN",0)
^9.67PA^8989.52^19
"BLD",6329,"KRN",.4,0)
.4
"BLD",6329,"KRN",.401,0)
.401
"BLD",6329,"KRN",.402,0)
.402
"BLD",6329,"KRN",.403,0)
.403
"BLD",6329,"KRN",.5,0)
.5
"BLD",6329,"KRN",.84,0)
.84
"BLD",6329,"KRN",3.6,0)
3.6
"BLD",6329,"KRN",3.8,0)
3.8
"BLD",6329,"KRN",9.2,0)
9.2
"BLD",6329,"KRN",9.8,0)
9.8
"BLD",6329,"KRN",9.8,"NM",0)
^9.68A^6^5
"BLD",6329,"KRN",9.8,"NM",2,0)
PSDNTT^^0^B15435993
"BLD",6329,"KRN",9.8,"NM",3,0)
PSDNTTPC^^0^B15234294
"BLD",6329,"KRN",9.8,"NM",4,0)
PSDNTTP1^^0^B14234646
"BLD",6329,"KRN",9.8,"NM",5,0)
PSDNTF^^0^B36476016
"BLD",6329,"KRN",9.8,"NM",6,0)
PSDNTFPC^^0^B27724314
"BLD",6329,"KRN",9.8,"NM","B","PSDNTF",5)

"BLD",6329,"KRN",9.8,"NM","B","PSDNTFPC",6)

"BLD",6329,"KRN",9.8,"NM","B","PSDNTT",2)

"BLD",6329,"KRN",9.8,"NM","B","PSDNTTP1",4)

"BLD",6329,"KRN",9.8,"NM","B","PSDNTTPC",3)

"BLD",6329,"KRN",19,0)
19
"BLD",6329,"KRN",19,"NM",0)
^9.68A^4^4
"BLD",6329,"KRN",19,"NM",1,0)
PSD NURSE TRANS GS MENU^^2
"BLD",6329,"KRN",19,"NM",2,0)
PSD GS REC PCA/INF FOR PATIENT^^0
"BLD",6329,"KRN",19,"NM",3,0)
PSD GS TRANS PCA/INF PATIENT^^0
"BLD",6329,"KRN",19,"NM",4,0)
PSD INFUSION MENU^^2
"BLD",6329,"KRN",19,"NM","B","PSD GS REC PCA/INF FOR PATIENT",2)

"BLD",6329,"KRN",19,"NM","B","PSD GS TRANS PCA/INF PATIENT",3)

"BLD",6329,"KRN",19,"NM","B","PSD INFUSION MENU",4)

"BLD",6329,"KRN",19,"NM","B","PSD NURSE TRANS GS MENU",1)

"BLD",6329,"KRN",19.1,0)
19.1
"BLD",6329,"KRN",101,0)
101
"BLD",6329,"KRN",409.61,0)
409.61
"BLD",6329,"KRN",771,0)
771
"BLD",6329,"KRN",870,0)
870
"BLD",6329,"KRN",8989.51,0)
8989.51
"BLD",6329,"KRN",8989.52,0)
8989.52
"BLD",6329,"KRN",8994,0)
8994
"BLD",6329,"KRN","B",.4,.4)

"BLD",6329,"KRN","B",.401,.401)

"BLD",6329,"KRN","B",.402,.402)

"BLD",6329,"KRN","B",.403,.403)

"BLD",6329,"KRN","B",.5,.5)

"BLD",6329,"KRN","B",.84,.84)

"BLD",6329,"KRN","B",3.6,3.6)

"BLD",6329,"KRN","B",3.8,3.8)

"BLD",6329,"KRN","B",9.2,9.2)

"BLD",6329,"KRN","B",9.8,9.8)

"BLD",6329,"KRN","B",19,19)

"BLD",6329,"KRN","B",19.1,19.1)

"BLD",6329,"KRN","B",101,101)

"BLD",6329,"KRN","B",409.61,409.61)

"BLD",6329,"KRN","B",771,771)

"BLD",6329,"KRN","B",870,870)

"BLD",6329,"KRN","B",8989.51,8989.51)

"BLD",6329,"KRN","B",8989.52,8989.52)

"BLD",6329,"KRN","B",8994,8994)

"BLD",6329,"QUES",0)
^9.62^^
"BLD",6329,"REQB",0)
^9.611^1^1
"BLD",6329,"REQB",1,0)
PSD*3.0*66^2
"BLD",6329,"REQB","B","PSD*3.0*66",1)

"KRN",19,8536,-1)
2^4
"KRN",19,8536,0)
PSD INFUSION MENU^Infusion Order Processing Menu^^M^11595^^^^^^^276
"KRN",19,8536,10,0)
^19.01IP^3^3
"KRN",19,8536,10,3,0)
13187
"KRN",19,8536,10,3,"^")
PSD GS TRANS PCA/INF PATIENT
"KRN",19,8536,"U")
INFUSION ORDER PROCESSING MENU
"KRN",19,8540,-1)
2^1
"KRN",19,8540,0)
PSD NURSE TRANS GS MENU^Transfer Green Sheet Menu^^M^11595^^^^^^^276
"KRN",19,8540,10,0)
^19.01IP^6^6
"KRN",19,8540,10,5,0)
13187^^12
"KRN",19,8540,10,5,"^")
PSD GS TRANS PCA/INF PATIENT
"KRN",19,8540,10,6,0)
13188^^13
"KRN",19,8540,10,6,"^")
PSD GS REC PCA/INF FOR PATIENT
"KRN",19,8540,"U")
TRANSFER GREEN SHEET MENU
"KRN",19,13187,-1)
0^3
"KRN",19,13187,0)
PSD GS TRANS PCA/INF PATIENT^Transfer GS for PCA/Infusion Signed Out to Patient^^R^^^^^^^^CONTROLLED SUBSTANCES
"KRN",19,13187,1,0)
^^3^3^3070423^
"KRN",19,13187,1,1,0)
Use this option to transfer Green Sheets for
"KRN",19,13187,1,2,0)
PCA/Infusions already signed out to a patient
"KRN",19,13187,1,3,0)
to another NAOU.
"KRN",19,13187,25)
PSDNTFPC
"KRN",19,13187,"U")
TRANSFER GS FOR PCA/INFUSION S
"KRN",19,13188,-1)
0^2
"KRN",19,13188,0)
PSD GS REC PCA/INF FOR PATIENT^Receive GS for PCA/Infusion Signed Out to Patient^^R^^^^^^^^CONTROLLED SUBSTANCES
"KRN",19,13188,1,0)
^^3^3^3070423^
"KRN",19,13188,1,1,0)
Use this option to receive Green Sheets
"KRN",19,13188,1,2,0)
already signed out to a patient from another
"KRN",19,13188,1,3,0)
NAOU.
"KRN",19,13188,25)
PSDNTTPC
"KRN",19,13188,"U")
RECEIVE GS FOR PCA/INFUSION SI
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",276,-1)
1^1
"PKG",276,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",276,20,0)
^9.402P^^
"PKG",276,22,0)
^9.49I^1^1
"PKG",276,22,1,0)
3.0^2970213^2970430^11595
"PKG",276,22,1,"PAH",1,0)
64^3070829^10000000073
"PKG",276,22,1,"PAH",1,1,0)
^^5^5^3070829
"PKG",276,22,1,"PAH",1,1,1,0)
When a PCA/Syringe is already signed out to a patient and that
"PKG",276,22,1,"PAH",1,1,2,0)
green sheet and patient are trasnferred to another NAOU, the 
"PKG",276,22,1,"PAH",1,1,3,0)
quantity is subtracted from the sending NAOU and added to the
"PKG",276,22,1,"PAH",1,1,4,0)
receiving NAOU even though it has already been signed out to
"PKG",276,22,1,"PAH",1,1,5,0)
the patient.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSDNTF")
0^5^B36476016^B32655045
"RTN","PSDNTF",1,0)
PSDNTF ;BIR/JPW-Transfer Green Sheet - From this NAOU ; 8/29/07 1:25pm
"RTN","PSDNTF",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,56,63,66,64**;13 Feb 97;Build 33
"RTN","PSDNTF",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDNTF",4,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNTF",5,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):1,1:0)
"RTN","PSDNTF",6,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to",!,?12,"transfer narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, or PSJ RPHARM security key required.",! K OK Q
"RTN","PSDNTF",7,0)
 W !!,"Transfer a Green Sheet from this NAOU" S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDNTF",8,0)
ASKN ;ask transfer from naou
"RTN","PSDNTF",9,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer from NAOU: "
"RTN","PSDNTF",10,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTF",11,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNTF",12,0)
GS ;select green sheet #
"RTN","PSDNTF",13,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNTF",14,0)
 S DIC("S")="I $P(^(0),""^"",11)=4!($P(^(0),U,11)=13),$P(^(0),""^"",18)=AOU",DIC("W")="W "" "",$P($G(^PSDRUG($P(^(0),U,5),0)),U),"" => "",$P($G(^DPT(+$P($G(^PSD(58.81,Y,9)),U),0)),U)"
"RTN","PSDNTF",15,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDNTF",16,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNTF",17,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDNTF",18,0)
 S MFG=$P(Y(0),"^",13),LOT=$P(Y(0),"^",14),EXP=$P(Y(0),"^",15),QTY=+$P(Y(0),"^",6),PSDS=+$P(Y(0),"^",3)
"RTN","PSDNTF",19,0)
 S NBKU=$P($G(^PSD(58.8,+PSDS,1,+PSDR,0)),"^",8)
"RTN","PSDNTF",20,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=+$P(^(4),"^",3)
"RTN","PSDNTF",21,0)
 I AOU'=NAOU W !!,"The Green Sheet # ",PSDPN," does not reside on ",AOUN,".",!,"Please select another Green Sheet.",! G ASKN
"RTN","PSDNTF",22,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTF",23,0)
 I STAT'=4,STAT'=13 W !!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTF",24,0)
 I 'QTY W !!,"Previous transfer quantity was 0.",!,"Use option 'Transfer GS for PCA/Infusion Signed Out to Patient'",! G END
"RTN","PSDNTF",25,0)
ASKT ;ask transfer to naou
"RTN","PSDNTF",26,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer To NAOU: "
"RTN","PSDNTF",27,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTF",28,0)
 D ^DIC K DIC G:Y<0 END S NAOUT=+Y,NAOUTN=$P(Y,"^",2)
"RTN","PSDNTF",29,0)
 I NAOUT=AOU W !!,"You may not transfer a Green Sheet to your NAOU!",!,"Please select another NAOU.",!! G ASKT
"RTN","PSDNTF",30,0)
 ;*64
"RTN","PSDNTF",31,0)
 N PSDGS,PSDGSPTQ,PSDGSP0,PSDGSP9
"RTN","PSDNTF",32,0)
 S PSDGS=0 F  S PSDGS=$O(^PSD(58.81,"D",PSDPN,PSDGS)) Q:'PSDGS  D
"RTN","PSDNTF",33,0)
 .S PSDGSP0=$G(^PSD(58.81,PSDGS,0)),PSDGSP9=$G(^PSD(58.81,PSDGS,9))
"RTN","PSDNTF",34,0)
 .I $P(PSDGSP0,"^",2)=17,$P(PSDGSP9,"^",1)]"" S PSDGSPTQ=$G(PSDGSPTQ)+$P(PSDGSP9,"^",3)
"RTN","PSDNTF",35,0)
 I $G(PSDGSPTQ) W !!,"Green Sheet "_PSDPN_" has dose(s) signed out to patient.",!
"RTN","PSDNTF",36,0)
 I QTY=1 S RQTY=1 W !,"Quantity to Transfer (",NBKU,"/1)",! G OK
"RTN","PSDNTF",37,0)
QTY ;
"RTN","PSDNTF",38,0)
 W !,"Quantity to Transfer ("_NBKU_"/"_QTY_"): " R X:DTIME I '$T!(X="^")!(X="") S PSDOUT=1 W !!,"**** No action taken. ****",!! G END
"RTN","PSDNTF",39,0)
 ;I X'?1.6N!(X=0) W !!,"Enter a whole number between 1 and ",QTY,! G QTY
"RTN","PSDNTF",40,0)
 I +X'=X!(X>999999)!(X'>0)!(X?.E1"."4N.N) D  G QTY
"RTN","PSDNTF",41,0)
 . W !!,"Enter a number between .01 and ",QTY,!
"RTN","PSDNTF",42,0)
 I X>QTY W $C(7),!!,"The quantity returned must not exceed "_QTY_"!",! G QTY
"RTN","PSDNTF",43,0)
 S RQTY=X
"RTN","PSDNTF",44,0)
OK ;if perpetual NAOU and not ordered for patient
"RTN","PSDNTF",45,0)
 D:QTY=1&('$P($G(^PSD(58.81,PSDA,9)),U))  G:$G(PSDOUT) END
"RTN","PSDNTF",46,0)
 .W !,PSDRN," Current Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTF",47,0)
 .S DIR(0)="Y",DIR("A")="Is this a PCA syringe that has already been signed out for a patient",DIR("B")="Y",DIR("?")="If you answer no, your balance will be subtracted by one" D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDNTF",48,0)
 .Q:Y'=1
"RTN","PSDNTF",49,0)
 .S RQTY(1)=1
"RTN","PSDNTF",50,0)
 .S DIC="^DPT(",DIC(0)="AEMQ",DIC("A")="Scan/Enter Patient: "
"RTN","PSDNTF",51,0)
 .W ! D ^DIC K DIC I Y<1 S PSDOUT=1 W !!,"No action taken.",!! Q
"RTN","PSDNTF",52,0)
 .S PAT=+Y
"RTN","PSDNTF",53,0)
 ;ask ok to transfer
"RTN","PSDNTF",54,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="NO"
"RTN","PSDNTF",55,0)
 S DIR("?",1)="Answer 'YES' to transfer this Green Sheet to another NAOU or",DIR("?")="answer 'NO' to leave the Green Sheet status active on your NAOU."
"RTN","PSDNTF",56,0)
 D ^DIR K DIR G:$D(DIRUT) END G:'Y GS
"RTN","PSDNTF",57,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNTF",58,0)
COM ;complete at order level in 58.8
"RTN","PSDNTF",59,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNTF",60,0)
 S BQTY=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",22):$P(^(0),"^",22)-RQTY,1:QTY-RQTY)
"RTN","PSDNTF",61,0)
 W !!,"Updating your records now..."
"RTN","PSDNTF",62,0)
 ;update transaction file (58.81)
"RTN","PSDNTF",63,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="64////"_RECD_";65////"_PSDUZ_";66////"_NAOUT_";70////"_RQTY_";10////10;73////"_$G(PAT) D ^DIE K DA,DIE,DR
"RTN","PSDNTF",64,0)
 I $D(Y)!$D(DTOUT) W $C(7),!!,"** THIS GREEN SHEET HAS NOT BEEN TRANSFERRED **",!!,"The status remains "_STATN,! G END
"RTN","PSDNTF",65,0)
 ;update order
"RTN","PSDNTF",66,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////10;22////"_BQTY D ^DIE K DA,DIE,DR
"RTN","PSDNTF",67,0)
 ;update naou bal
"RTN","PSDNTF",68,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNTF",69,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNTF",70,0)
 S:'$G(RQTY(1)) $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)-RQTY
"RTN","PSDNTF",71,0)
 W:$P($G(^PSD(58.8,NAOU,2)),U,5) !,PSDRN," Remaining Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTF",72,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDNTF",73,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11)
"RTN","PSDNTF",74,0)
 W ?2,!,"*** The status of your Green Sheet #"_PSDPN_" is now",!,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNTF",75,0)
PRINT ;print 2321
"RTN","PSDNTF",76,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDNTF",77,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDNTF",78,0)
 S Y=RECD X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDNTF",79,0)
 S (PG,PSDOUT)=0,REAS="",COMP=999,RECDT=$E(RECD,4,5)_"/"_$E(RECD,6,7)_"/"_PSDYR
"RTN","PSDNTF",80,0)
 I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3) S EXP=EXPD
"RTN","PSDNTF",81,0)
 D ^PSDGSRV2
"RTN","PSDNTF",82,0)
END K %,%DT,%H,%I,AOU,AOUN,BQTY,COMP,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LOT,MFG
"RTN","PSDNTF",83,0)
 K NAOU,NAOUN,NAOUT,NAOUTN,NBKU,NUM,OK,ORD,PG,PSDA,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDUZ,PSDUZN,PSDYR,QTY,REAS,RECD,RECDT,RQTY,STAT,STATN,X,Y
"RTN","PSDNTF",84,0)
 Q
"RTN","PSDNTFPC")
0^6^B27724314^n/a
"RTN","PSDNTFPC",1,0)
PSDNTFPC ;BIR/JPW-Transfer Green Sheet - From this NAOU ; 8/16/07 2:20pm
"RTN","PSDNTFPC",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**64**;13 Feb 97;Build 33
"RTN","PSDNTFPC",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDNTFPC",4,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNTFPC",5,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):1,1:0)
"RTN","PSDNTFPC",6,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to",!,?12,"transfer narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, or PSJ RPHARM security key required.",! K OK Q
"RTN","PSDNTFPC",7,0)
 W !!,"Transfer a Green Sheet from this NAOU" S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDNTFPC",8,0)
 W !!,"THIS OPTION WILL TRANSFER A QUANTITY OF ZERO"
"RTN","PSDNTFPC",9,0)
ASKN ;ask transfer from naou
"RTN","PSDNTFPC",10,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer from NAOU: "
"RTN","PSDNTFPC",11,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTFPC",12,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNTFPC",13,0)
GS ;select green sheet #
"RTN","PSDNTFPC",14,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNTFPC",15,0)
 S DIC("S")="I $P(^(0),""^"",11)=4!($P(^(0),U,11)=13),$P(^(0),""^"",18)=AOU",DIC("W")="W "" "",$P($G(^PSDRUG($P(^(0),U,5),0)),U),"" => "",$P($G(^DPT(+$P($G(^PSD(58.81,Y,9)),U),0)),U)"
"RTN","PSDNTFPC",16,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDNTFPC",17,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNTFPC",18,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDNTFPC",19,0)
 S MFG=$P(Y(0),"^",13),LOT=$P(Y(0),"^",14),EXP=$P(Y(0),"^",15),QTY=0,PSDS=+$P(Y(0),"^",3)  ;;*64
"RTN","PSDNTFPC",20,0)
 S NBKU=$P($G(^PSD(58.8,+PSDS,1,+PSDR,0)),"^",8)
"RTN","PSDNTFPC",21,0)
 ;*64
"RTN","PSDNTFPC",22,0)
 N PSDGS,PSDGSP,PSDGS0,PSDGSPT1
"RTN","PSDNTFPC",23,0)
 S PSDGS=0 F  S PSDGS=$O(^PSD(58.81,"D",PSDPN,PSDGS)) Q:'PSDGS  D
"RTN","PSDNTFPC",24,0)
 .S PSDGSP=$G(^PSD(58.81,PSDGS,9)),PSDGS0=$G(^PSD(58.81,PSDGS,0))
"RTN","PSDNTFPC",25,0)
 .I $P(PSDGSP,"^")]"",$P(PSDGS0,"^",2)=17 S PSDGSPT1=1
"RTN","PSDNTFPC",26,0)
 I '$G(PSDGSPT1) W !!,"Green Sheet not signed out to Patient.",!,"Use option 'Transfer Green Sheet and Drug to another NAOU'.",! G END      ;;*64
"RTN","PSDNTFPC",27,0)
 I AOU'=NAOU W !!,"The Green Sheet # ",PSDPN," does not reside on ",AOUN,".",!,"Please select another Green Sheet.",! G ASKN
"RTN","PSDNTFPC",28,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTFPC",29,0)
 I STAT'=4,STAT'=13 W !!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTFPC",30,0)
ASKT ;ask transfer to naou
"RTN","PSDNTFPC",31,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer To NAOU: "
"RTN","PSDNTFPC",32,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTFPC",33,0)
 D ^DIC K DIC G:Y<0 END S NAOUT=+Y,NAOUTN=$P(Y,"^",2)
"RTN","PSDNTFPC",34,0)
 I NAOUT=AOU W !!,"You may not transfer a Green Sheet to your NAOU!",!,"Please select another NAOU.",!! G ASKT
"RTN","PSDNTFPC",35,0)
 S RQTY=0 W !,"Quantity to Transfer (",NBKU,"/0)",! G OK
"RTN","PSDNTFPC",36,0)
QTY ;
"RTN","PSDNTFPC",37,0)
OK ;already signed out to patient
"RTN","PSDNTFPC",38,0)
 ;ask ok to transfer
"RTN","PSDNTFPC",39,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="NO"
"RTN","PSDNTFPC",40,0)
 S DIR("?",1)="Answer 'YES' to transfer this Green Sheet to another NAOU or",DIR("?")="answer 'NO' to leave the Green Sheet status active on your NAOU."
"RTN","PSDNTFPC",41,0)
 D ^DIR K DIR G:$D(DIRUT) END G:'Y GS
"RTN","PSDNTFPC",42,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNTFPC",43,0)
COM ;complete at order level in 58.8
"RTN","PSDNTFPC",44,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNTFPC",45,0)
 S BQTY=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",22):$P(^(0),"^",22),1:QTY)  ;;*64
"RTN","PSDNTFPC",46,0)
 W !!,"Updating your records now..."
"RTN","PSDNTFPC",47,0)
 ;update transaction file (58.81)
"RTN","PSDNTFPC",48,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="64////"_RECD_";65////"_PSDUZ_";66////"_NAOUT_";70////"_RQTY_";10////10;73////"_$G(PAT) D ^DIE K DA,DIE,DR
"RTN","PSDNTFPC",49,0)
 I $D(Y)!$D(DTOUT) W $C(7),!!,"** THIS GREEN SHEET HAS NOT BEEN TRANSFERRED **",!!,"The status remains "_STATN,! G END
"RTN","PSDNTFPC",50,0)
 ;update order
"RTN","PSDNTFPC",51,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////10;22////"_BQTY D ^DIE K DA,DIE,DR
"RTN","PSDNTFPC",52,0)
 ;update naou bal
"RTN","PSDNTFPC",53,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNTFPC",54,0)
 W:$P($G(^PSD(58.8,NAOU,2)),U,5) !,PSDRN," Remaining Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTFPC",55,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)   ;; *64 - fixed unlock bug
"RTN","PSDNTFPC",56,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11)
"RTN","PSDNTFPC",57,0)
 W ?2,!,"*** The status of your Green Sheet #"_PSDPN_" is now",!,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNTFPC",58,0)
PRINT ;print 2321
"RTN","PSDNTFPC",59,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDNTFPC",60,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDNTFPC",61,0)
 S Y=RECD X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDNTFPC",62,0)
 S (PG,PSDOUT)=0,REAS="",COMP=999,RECDT=$E(RECD,4,5)_"/"_$E(RECD,6,7)_"/"_PSDYR
"RTN","PSDNTFPC",63,0)
 I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3) S EXP=EXPD
"RTN","PSDNTFPC",64,0)
 D ^PSDGSRV2
"RTN","PSDNTFPC",65,0)
END K %,%DT,%H,%I,AOU,AOUN,BQTY,COMP,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LOT,MFG
"RTN","PSDNTFPC",66,0)
 K NAOU,NAOUN,NAOUT,NAOUTN,NBKU,NUM,OK,ORD,PG,PSDA,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDUZ,PSDUZN,PSDYR,QTY,REAS,RECD,RECDT,RQTY,STAT,STATN,X,Y
"RTN","PSDNTFPC",67,0)
 Q
"RTN","PSDNTT")
0^2^B15435993^B14284752
"RTN","PSDNTT",1,0)
PSDNTT ;BIR/JPW-Transfer Green Sheet - Receive this NAOU ; 6/25/07 12:16pm
"RTN","PSDNTT",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**64**;13 Feb 97;Build 33
"RTN","PSDNTT",3,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNTT",4,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,1:0)
"RTN","PSDNTT",5,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to transfer",!,?12,"narcotic orders.",!!,"PSJ RNURSE or PSD NURSE security key required.",! K OK Q
"RTN","PSDNTT",6,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH Q
"RTN","PSDNTT",7,0)
 W !!,"Receive a transferred Green Sheet into this NAOU" S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDNTT",8,0)
ASKN ;ask transfer to naou
"RTN","PSDNTT",9,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Receive Transfer In NAOU: "
"RTN","PSDNTT",10,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTT",11,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNTT",12,0)
GS ;select green sheet #
"RTN","PSDNTT",13,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNTT",14,0)
 S DIC("S")="I $P(^(0),""^"",11)=10,'$P($G(^(7)),""^"",4),($P($G(^(7)),""^"",3)=AOU)!($P(^(0),""^"",18)=AOU)"
"RTN","PSDNTT",15,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDNTT",16,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNTT",17,0)
 S ORD=+$P(Y(0),"^",20),PSDRG=+$P(Y(0),"^",5),PSDRGN=$P($G(^PSDRUG(PSDRG,0)),"^")
"RTN","PSDNTT",18,0)
 S NAOUF=+$P(Y(0),"^",18),NAOUFN=$P($G(^PSD(58.8,+NAOUF,0)),"^")
"RTN","PSDNTT",19,0)
 S PSDSP=$P($G(^PSD(58.8,NAOUF,1,PSDRG,3,ORD,0)),"^",14)
"RTN","PSDNTT",20,0)
 S MFG=$P(Y(0),"^",13),LOT=$P(Y(0),"^",14),EXP=$P(Y(0),"^",15),PSDS=+$P(Y(0),"^",3)
"RTN","PSDNTT",21,0)
 S QTY=+$P(Y(0),"^",6) I $D(^PSD(58.81,+PSDA,4)),+$P(^(4),"^",3) S QTY=+$P(^(4),"^",3)
"RTN","PSDNTT",22,0)
 S RQTY=+$P($G(^PSD(58.81,PSDA,7)),"^",7)
"RTN","PSDNTT",23,0)
 S NAOU=+$P($G(^PSD(58.81,PSDA,7)),"^",3),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^")
"RTN","PSDNTT",24,0)
 S PAT=+$P($G(^PSD(58.81,PSDA,9)),U)
"RTN","PSDNTT",25,0)
 I STAT'=10 W !!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTT",26,0)
 ;*64
"RTN","PSDNTT",27,0)
 I RQTY=0 W !!,"Quantity of zero was transferred.  Use menu option",!,"'Receive GS for PCA/Infusion Signed Out to Patient'",! G END
"RTN","PSDNTT",28,0)
 D CHK G:PSDOUT END N X,X1 D SIG^XUSESIG G:X1="" END
"RTN","PSDNTT",29,0)
 D ^PSDNTT1
"RTN","PSDNTT",30,0)
END K %,%DT,%H,%I,AOU,AOUN,D,DA,DIC,DIE,DIK,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EXP,FLAG,JJ,LOT,MFG
"RTN","PSDNTT",31,0)
 K NAOU,NAOUF,NAOUFN,NAOUN,NAOUT,NAOUTN,OK,ORD,PAT,PSDA,PSDOUT,PSDPN,PSDREC,PSDRG,PSDRGN,PSDRN,PSDS,PSDSP,PSDT,PSDUZ,PSDUZN,QTY,RECD,RECDT,RQTY,STAT,STATN,X,Y
"RTN","PSDNTT",32,0)
 K XMDUZ,XMSUB,XMTEXT,XMY,^TMP("PSDNTMSG",$J)
"RTN","PSDNTT",33,0)
 Q
"RTN","PSDNTT",34,0)
CHK ;check transfer to naou
"RTN","PSDNTT",35,0)
 S PSDOUT=0 W !!,?5,"The Green Sheet # ",PSDPN," and quantity of ",RQTY
"RTN","PSDNTT",36,0)
 I AOU'=NAOU W " was being transferred",!,?10,"*** from ",NAOUFN,!,?10,"*** to ",NAOUN,".",!!,$C(7),?5,"You are transferring it from ",NAOUFN,!,?10,"*** to ",AOUN,"."
"RTN","PSDNTT",37,0)
 I AOU=NAOU W " is being transferred ",!,?10,"*** from ",NAOUFN,!,?10,"*** to ",NAOUN,"."
"RTN","PSDNTT",38,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Do you wish to complete this transfer",DIR("B")="NO"
"RTN","PSDNTT",39,0)
 S DIR("?",1)="Answer 'YES' to complete this Green Sheet transfer,",DIR("?")="answer 'NO' or '^' to quit without completing the transfer."
"RTN","PSDNTT",40,0)
 D ^DIR K DIR I 'Y!($D(DIRUT)) S PSDOUT=1 W !!,"Receive Green Sheet # ",PSDPN," transfer into another NAOU not completed.",!! Q
"RTN","PSDNTT",41,0)
 Q
"RTN","PSDNTTP1")
0^4^B14234646^n/a
"RTN","PSDNTTP1",1,0)
PSDNTTP1 ;BIR/BJW-Transfer Green Sheet - Receive this NAOU ; 7/9/07 10:02am
"RTN","PSDNTTP1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**64**;13 Feb 97;Build 33
"RTN","PSDNTTP1",3,0)
COM ;complete order and transaction
"RTN","PSDNTTP1",4,0)
 S FLAG=0 D NOW^%DTC S PSDT=X,(RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNTTP1",5,0)
 W !!,"Accessing ",PSDRGN," information...",!!
"RTN","PSDNTTP1",6,0)
 I '$D(^PSD(58.8,+AOU,1,+PSDRG,0)) D DRUG
"RTN","PSDNTTP1",7,0)
 W !!,"Updating your records now..."
"RTN","PSDNTTP1",8,0)
DIE ;create the order request in 58.8
"RTN","PSDNTTP1",9,0)
 S:'$D(^PSD(58.8,AOU,1,PSDRG,3,0)) ^(0)="^58.800118A^^"
"RTN","PSDNTTP1",10,0)
 S PSDRN=$P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)+1 I $D(^PSD(58.8,AOU,1,PSDRG,3,PSDRN)) S $P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)=$P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)+1 G DIE
"RTN","PSDNTTP1",11,0)
 W "order..."
"RTN","PSDNTTP1",12,0)
 K DA,DIC,DIE,DD,DR,DO S DIC(0)="L",(DIC,DIE)="^PSD(58.8,"_AOU_",1,"_PSDRG_",3,",DA(2)=AOU,DA(1)=PSDRG,(X,DINUM)=PSDRN D FILE^DICN K DIC
"RTN","PSDNTTP1",13,0)
 S DA=PSDRN,DA(1)=PSDRG,DA(2)=AOU
"RTN","PSDNTTP1",14,0)
 S STAT=$S(+$P($G(^PSD(58.8,AOU,2)),U,5):13,1:4)
"RTN","PSDNTTP1",15,0)
 S DR="16////"_PSDPN_";14////"_PSDSP_";15////"_RECD_";2////"_+PSDS_";6////"_PSDUZ_";7////"_MFG_";8////"_LOT_";9////"_EXP_";10////"_STAT_";19////"_QTY_";20////"_RQTY_";22////"_RQTY
"RTN","PSDNTTP1",16,0)
 D ^DIE K DIE,DR
"RTN","PSDNTTP1",17,0)
 W "transaction..."
"RTN","PSDNTTP1",18,0)
ADD ;find entry number in 58.81
"RTN","PSDNTTP1",19,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNTTP1",20,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDNTTP1",21,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDNTTP1",22,0)
 L -^PSD(58.81,0)
"RTN","PSDNTTP1",23,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDNTTP1",24,0)
 I $P($G(^PSD(58.81,PSDREC,0)),"^")
"RTN","PSDNTTP1",25,0)
 S STAT=$S(+$P($G(^PSD(58.8,AOU,2)),U,5):13,1:4)
"RTN","PSDNTTP1",26,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^5^"_PSDS_"^"_RECD_"^"_PSDRG_"^"_RQTY_"^^^^^"_STAT_"^^"_MFG_"^"_LOT_"^"_EXP_"^^"_PSDPN_"^"_AOU_"^^"_PSDRN
"RTN","PSDNTTP1",27,0)
 S ^PSD(58.81,PSDREC,1)="^^"_PSDUZ_"^"_RECD_"^^^^"_RQTY
"RTN","PSDNTTP1",28,0)
 S ^PSD(58.81,PSDREC,7)="^^^^^"_PSDA,^PSD(58.81,PSDREC,9)=PAT
"RTN","PSDNTTP1",29,0)
 S ^PSD(58.81,PSDREC,"CS")=1,$P(^PSD(58.81,PSDREC,"CS"),"^",4)=1
"RTN","PSDNTTP1",30,0)
 K DA,DIK S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDNTTP1",31,0)
 ;update new order and prev trans #
"RTN","PSDNTTP1",32,0)
 S $P(^PSD(58.8,AOU,1,PSDRG,3,PSDRN,0),"^",17)=PSDREC
"RTN","PSDNTTP1",33,0)
 S $P(^PSD(58.81,PSDA,7),"^",4)=RECD,$P(^(7),"^",5)=PSDUZ,$P(^(7),"^",3)=AOU
"RTN","PSDNTTP1",34,0)
BAL ;update naou to balance  ; *64 - balance will not change
"RTN","PSDNTTP1",35,0)
COMP ;completed msg
"RTN","PSDNTTP1",36,0)
 W "done.",!!
"RTN","PSDNTTP1",37,0)
 S STAT=$P($G(^PSD(58.81,PSDREC,0)),"^",11)
"RTN","PSDNTTP1",38,0)
 W ?2,!,"*** The status of your Green Sheet #"_PSDPN_" is now",!,?2,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNTTP1",39,0)
 G:'FLAG END
"RTN","PSDNTTP1",40,0)
MSG ;send mail message
"RTN","PSDNTTP1",41,0)
 K XMY,^TMP("PSDNTMSG",$J) S ^TMP("PSDNTMSG",$J,1,0)="CS PHARM Transfer Green Sheet between NAOUs",^TMP("PSDNTMSG",$J,2,0)="Transfer In Date: "_RECDT
"RTN","PSDNTTP1",42,0)
 S ^TMP("PSDNTMSG",$J,3,0)=""
"RTN","PSDNTTP1",43,0)
 S ^TMP("PSDNTMSG",$J,4,0)="Drug: "_PSDRGN_"      Green Sheet #"_PSDPN
"RTN","PSDNTTP1",44,0)
 S ^TMP("PSDNTMSG",$J,5,0)="Transfer to: "_AOUN
"RTN","PSDNTTP1",45,0)
 S ^TMP("PSDNTMSG",$J,6,0)="",^TMP("PSDNTMSG",$J,7,0)="This drug has been inactivated."
"RTN","PSDNTTP1",46,0)
 S XMSUB="CS PHARM TRANSFER GREEN SHEET INACTIVATE DRUG",XMTEXT="^TMP(""PSDNTMSG"",$J,",XMDUZ="CONTROLLED SUBSTANCES PHARMACY"
"RTN","PSDNTTP1",47,0)
 F JJ=0:0 S JJ=$O(^XUSEC("PSDMGR",JJ)) Q:'JJ  S XMY(JJ)=""
"RTN","PSDNTTP1",48,0)
 S:'$D(XMY) XMY(.5)="" D ^XMD K XMY,^TMP("PSDNTMSG",$J)
"RTN","PSDNTTP1",49,0)
END Q
"RTN","PSDNTTP1",50,0)
DRUG ;add drug and inactivate it
"RTN","PSDNTTP1",51,0)
 S:'$D(^PSD(58.8,AOU,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSDNTTP1",52,0)
 K DA,DIC,DIE,DD,DO S (DIC,DIE)="^PSD(58.8,"_AOU_",1,",(X,DINUM)=+PSDRG,DA(1)=AOU,DIC(0)="L" D FILE^DICN K DIC I Y<0 S PSDOUT=1 Q
"RTN","PSDNTTP1",53,0)
 K DA,DR S DA=PSDRG,DA(1)=AOU,DR="13////"_PSDT_";14////O;14.5////TRANSFER FROM ANOTHER NAOU" D ^DIE K DA,DIE,DR
"RTN","PSDNTTP1",54,0)
 S FLAG=1
"RTN","PSDNTTP1",55,0)
 Q
"RTN","PSDNTTPC")
0^3^B15234294^n/a
"RTN","PSDNTTPC",1,0)
PSDNTTPC ;BIR/JPW-Transfer Green Sheet - Receive this NAOU ; 8/15/07 11:42am
"RTN","PSDNTTPC",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**64**;13 Feb 97;Build 33
"RTN","PSDNTTPC",3,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNTTPC",4,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,1:0)
"RTN","PSDNTTPC",5,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to transfer",!,?12,"narcotic orders.",!!,"PSJ RNURSE or PSD NURSE security key required.",! K OK Q
"RTN","PSDNTTPC",6,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH Q
"RTN","PSDNTTPC",7,0)
 W !!,"Receive a transferred Green Sheet into this NAOU" S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDNTTPC",8,0)
ASKN ;ask transfer to naou
"RTN","PSDNTTPC",9,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Receive Transfer In NAOU: "
"RTN","PSDNTTPC",10,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTTPC",11,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNTTPC",12,0)
GS ;select green sheet #
"RTN","PSDNTTPC",13,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNTTPC",14,0)
 S DIC("S")="I $P(^(0),""^"",11)=10,'$P($G(^(7)),""^"",4),($P($G(^(7)),""^"",3)=AOU)!($P(^(0),""^"",18)=AOU)"
"RTN","PSDNTTPC",15,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDNTTPC",16,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNTTPC",17,0)
 S ORD=+$P(Y(0),"^",20),PSDRG=+$P(Y(0),"^",5),PSDRGN=$P($G(^PSDRUG(PSDRG,0)),"^")
"RTN","PSDNTTPC",18,0)
 S NAOUF=+$P(Y(0),"^",18),NAOUFN=$P($G(^PSD(58.8,+NAOUF,0)),"^")
"RTN","PSDNTTPC",19,0)
 S PSDSP=$P($G(^PSD(58.8,NAOUF,1,PSDRG,3,ORD,0)),"^",14)
"RTN","PSDNTTPC",20,0)
 S MFG=$P(Y(0),"^",13),LOT=$P(Y(0),"^",14),EXP=$P(Y(0),"^",15),PSDS=+$P(Y(0),"^",3)
"RTN","PSDNTTPC",21,0)
 S QTY=+$P(Y(0),"^",6) I $D(^PSD(58.81,+PSDA,4)),+$P(^(4),"^",3) S QTY=+$P(^(4),"^",3)
"RTN","PSDNTTPC",22,0)
 S RQTY=+$P($G(^PSD(58.81,PSDA,7)),"^",7)
"RTN","PSDNTTPC",23,0)
 S NAOU=+$P($G(^PSD(58.81,PSDA,7)),"^",3),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^")
"RTN","PSDNTTPC",24,0)
 S PAT=+$P($G(^PSD(58.81,PSDA,9)),U)
"RTN","PSDNTTPC",25,0)
 I RQTY W !!,"Transfer quantity is greater than 0.",!,"Use option 'Receive Green Sheet & Drug from another NAOU'.",! G END
"RTN","PSDNTTPC",26,0)
 I STAT'=10 W !!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTTPC",27,0)
 D CHK G:PSDOUT END N X,X1 D SIG^XUSESIG G:X1="" END
"RTN","PSDNTTPC",28,0)
 D ^PSDNTTP1  ;;*64
"RTN","PSDNTTPC",29,0)
END K %,%DT,%H,%I,AOU,AOUN,D,DA,DIC,DIE,DIK,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EXP,FLAG,JJ,LOT,MFG
"RTN","PSDNTTPC",30,0)
 K NAOU,NAOUF,NAOUFN,NAOUN,NAOUT,NAOUTN,OK,ORD,PAT,PSDA,PSDOUT,PSDPN,PSDREC,PSDRG,PSDRGN,PSDRN,PSDS,PSDSP,PSDT,PSDUZ,PSDUZN,QTY,RECD,RECDT,RQTY,STAT,STATN,X,Y
"RTN","PSDNTTPC",31,0)
 K XMDUZ,XMSUB,XMTEXT,XMY,^TMP("PSDNTMSG",$J)
"RTN","PSDNTTPC",32,0)
 Q
"RTN","PSDNTTPC",33,0)
CHK ;check transfer to naou
"RTN","PSDNTTPC",34,0)
 S PSDOUT=0 W !!,?5,"The Green Sheet # ",PSDPN," and quantity of ",RQTY
"RTN","PSDNTTPC",35,0)
 I AOU'=NAOU W " was being transferred",!,?10,"*** from ",NAOUFN,!,?10,"*** to ",NAOUN,".",!!,$C(7),?5,"You are transferring it from ",NAOUFN,!,?10,"*** to ",AOUN,"."
"RTN","PSDNTTPC",36,0)
 I AOU=NAOU W " is being transferred ",!,?10,"*** from ",NAOUFN,!,?10,"*** to ",NAOUN,"."
"RTN","PSDNTTPC",37,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Do you wish to complete this transfer",DIR("B")="NO"
"RTN","PSDNTTPC",38,0)
 S DIR("?",1)="Answer 'YES' to complete this Green Sheet transfer,",DIR("?")="answer 'NO' or '^' to quit without completing the transfer."
"RTN","PSDNTTPC",39,0)
 D ^DIR K DIR I 'Y!($D(DIRUT)) S PSDOUT=1 W !!,"Receive Green Sheet # ",PSDPN," transfer into another NAOU not completed.",!! Q
"RTN","PSDNTTPC",40,0)
 Q
"VER")
8.0^22.0
"BLD",6329,6)
^56
**END**
**END**

Released PSD*3*68 SEQ #59
Extracted from mail message
**KIDS**:PSD*3.0*68^

**INSTALL NAME**
PSD*3.0*68
"BLD",7594,0)
PSD*3.0*68^CONTROLLED SUBSTANCES^0^3100621^y
"BLD",7594,1,0)
^^21^21^3091124^
"BLD",7594,1,1,0)
This patch addresses the following problems:
"BLD",7594,1,2,0)
 
"BLD",7594,1,3,0)
1. HD67437 - BAC-1101-40568  Change in count & inability to track
"BLD",7594,1,4,0)
   The Activity Report [PSD NURSE DISP REPORT] option does not print
"BLD",7594,1,5,0)
   the correct drug balances.
"BLD",7594,1,6,0)
 
"BLD",7594,1,7,0)
2. HD114292 - Activity report for transferred doesn't show activity
"BLD",7594,1,8,0)
              until next day
"BLD",7594,1,9,0)
   The "Activity Report" [PSD NURSE DISP REPORT] option for the NAOUs
"BLD",7594,1,10,0)
   (Narcotics Area Of Use) does not reflect the Greensheet information
"BLD",7594,1,11,0)
   for the transferred to ward but omits that information for the
"BLD",7594,1,12,0)
   transferred from ward.
"BLD",7594,1,13,0)
 
"BLD",7594,1,14,0)
3. HD343422 - Option displays wrong drug w/ PSD NURSE DISPENSING
"BLD",7594,1,15,0)
   The "Sign Out Dose for Patient" [PSD NURSE DISPENSING] option returns
"BLD",7594,1,16,0)
   the incorrect drug when scanned in and the incorrect drug is displayed.
"BLD",7594,1,17,0)
 
"BLD",7594,1,18,0)
4. HD355446 - <undefined>DRUG+18^PSDRF *NAOU
"BLD",7594,1,19,0)
   User receives an error when using the Sign Out Dose For Patient [PSD
"BLD",7594,1,20,0)
   NURSE DISPENSING] option and enters a Pharmacy Dispensing # 
"BLD",7594,1,21,0)
  (Greensheet) that has a dispense date greater than one year old.
"BLD",7594,4,0)
^9.64PA^^
"BLD",7594,6.3)
12
"BLD",7594,"ABPKG")
n
"BLD",7594,"INID")
^n
"BLD",7594,"INIT")
PSD68P
"BLD",7594,"KRN",0)
^9.67PA^779.2^20
"BLD",7594,"KRN",.4,0)
.4
"BLD",7594,"KRN",.401,0)
.401
"BLD",7594,"KRN",.402,0)
.402
"BLD",7594,"KRN",.403,0)
.403
"BLD",7594,"KRN",.5,0)
.5
"BLD",7594,"KRN",.84,0)
.84
"BLD",7594,"KRN",3.6,0)
3.6
"BLD",7594,"KRN",3.8,0)
3.8
"BLD",7594,"KRN",9.2,0)
9.2
"BLD",7594,"KRN",9.8,0)
9.8
"BLD",7594,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",7594,"KRN",9.8,"NM",1,0)
PSDRF^^0^B25617376
"BLD",7594,"KRN",9.8,"NM",2,0)
PSDPAT1^^0^B73058275
"BLD",7594,"KRN",9.8,"NM",3,0)
PSD68P^^0^B13127128
"BLD",7594,"KRN",9.8,"NM",4,0)
PSDPAT2^^0^B45069536
"BLD",7594,"KRN",9.8,"NM","B","PSD68P",3)

"BLD",7594,"KRN",9.8,"NM","B","PSDPAT1",2)

"BLD",7594,"KRN",9.8,"NM","B","PSDPAT2",4)

"BLD",7594,"KRN",9.8,"NM","B","PSDRF",1)

"BLD",7594,"KRN",19,0)
19
"BLD",7594,"KRN",19.1,0)
19.1
"BLD",7594,"KRN",101,0)
101
"BLD",7594,"KRN",409.61,0)
409.61
"BLD",7594,"KRN",771,0)
771
"BLD",7594,"KRN",779.2,0)
779.2
"BLD",7594,"KRN",870,0)
870
"BLD",7594,"KRN",8989.51,0)
8989.51
"BLD",7594,"KRN",8989.52,0)
8989.52
"BLD",7594,"KRN",8994,0)
8994
"BLD",7594,"KRN","B",.4,.4)

"BLD",7594,"KRN","B",.401,.401)

"BLD",7594,"KRN","B",.402,.402)

"BLD",7594,"KRN","B",.403,.403)

"BLD",7594,"KRN","B",.5,.5)

"BLD",7594,"KRN","B",.84,.84)

"BLD",7594,"KRN","B",3.6,3.6)

"BLD",7594,"KRN","B",3.8,3.8)

"BLD",7594,"KRN","B",9.2,9.2)

"BLD",7594,"KRN","B",9.8,9.8)

"BLD",7594,"KRN","B",19,19)

"BLD",7594,"KRN","B",19.1,19.1)

"BLD",7594,"KRN","B",101,101)

"BLD",7594,"KRN","B",409.61,409.61)

"BLD",7594,"KRN","B",771,771)

"BLD",7594,"KRN","B",779.2,779.2)

"BLD",7594,"KRN","B",870,870)

"BLD",7594,"KRN","B",8989.51,8989.51)

"BLD",7594,"KRN","B",8989.52,8989.52)

"BLD",7594,"KRN","B",8994,8994)

"BLD",7594,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7594,"QUES",0)
^9.62^^
"BLD",7594,"REQB",0)
^9.611^2^2
"BLD",7594,"REQB",1,0)
PSD*3.0*60^1
"BLD",7594,"REQB",2,0)
PSD*3.0*62^1
"BLD",7594,"REQB","B","PSD*3.0*60",1)

"BLD",7594,"REQB","B","PSD*3.0*62",2)

"INIT")
PSD68P
"MBREQ")
0
"PKG",276,-1)
1^1
"PKG",276,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",276,20,0)
^9.402P^^
"PKG",276,22,0)
^9.49I^1^1
"PKG",276,22,1,0)
3.0^2970213^2970430^11595
"PKG",276,22,1,"PAH",1,0)
68^3100621^1611
"PKG",276,22,1,"PAH",1,1,0)
^^21^21^3100621
"PKG",276,22,1,"PAH",1,1,1,0)
This patch addresses the following problems:
"PKG",276,22,1,"PAH",1,1,2,0)
 
"PKG",276,22,1,"PAH",1,1,3,0)
1. HD67437 - BAC-1101-40568  Change in count & inability to track
"PKG",276,22,1,"PAH",1,1,4,0)
   The Activity Report [PSD NURSE DISP REPORT] option does not print
"PKG",276,22,1,"PAH",1,1,5,0)
   the correct drug balances.
"PKG",276,22,1,"PAH",1,1,6,0)
 
"PKG",276,22,1,"PAH",1,1,7,0)
2. HD114292 - Activity report for transferred doesn't show activity
"PKG",276,22,1,"PAH",1,1,8,0)
              until next day
"PKG",276,22,1,"PAH",1,1,9,0)
   The "Activity Report" [PSD NURSE DISP REPORT] option for the NAOUs
"PKG",276,22,1,"PAH",1,1,10,0)
   (Narcotics Area Of Use) does not reflect the Greensheet information
"PKG",276,22,1,"PAH",1,1,11,0)
   for the transferred to ward but omits that information for the
"PKG",276,22,1,"PAH",1,1,12,0)
   transferred from ward.
"PKG",276,22,1,"PAH",1,1,13,0)
 
"PKG",276,22,1,"PAH",1,1,14,0)
3. HD343422 - Option displays wrong drug w/ PSD NURSE DISPENSING
"PKG",276,22,1,"PAH",1,1,15,0)
   The "Sign Out Dose for Patient" [PSD NURSE DISPENSING] option returns
"PKG",276,22,1,"PAH",1,1,16,0)
   the incorrect drug when scanned in and the incorrect drug is displayed.
"PKG",276,22,1,"PAH",1,1,17,0)
 
"PKG",276,22,1,"PAH",1,1,18,0)
4. HD355446 - <undefined>DRUG+18^PSDRF *NAOU
"PKG",276,22,1,"PAH",1,1,19,0)
   User receives an error when using the Sign Out Dose For Patient [PSD
"PKG",276,22,1,"PAH",1,1,20,0)
   NURSE DISPENSING] option and enters a Pharmacy Dispensing # 
"PKG",276,22,1,"PAH",1,1,21,0)
  (Greensheet) that has a dispense date greater than one year old.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSD68P")
0^3^B13127128^n/a
"RTN","PSD68P",1,0)
PSD68P ;B'ham ISC/RJS - PSD*3*68 POST INSTALL ; 30 Oct 09
"RTN","PSD68P",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**68**;30 Oct 09;Build 12
"RTN","PSD68P",3,0)
 ;Identify bad PSD(58.81,"D" INDEXES & TRANSACTIONS THEN CLEAN THEM UP
"RTN","PSD68P",4,0)
 S ZTDESC="CONTROLLED SUBSTANCES - PSD*3*68 POST INSTALL",ZTIO="",ZTDTH=$H,ZTRTN="START^PSD68P",ZTSAVE="" D ^%ZTLOAD
"RTN","PSD68P",5,0)
 D BMES^XPDUTL("PSD*3*68 POST INSTALL Task Queued!")
"RTN","PSD68P",6,0)
 Q
"RTN","PSD68P",7,0)
START ; FIND NAOU'S
"RTN","PSD68P",8,0)
 S PSDLOC=0 F  S PSDLOC=$O(^PSD(58.8,PSDLOC)) Q:'PSDLOC  D
"RTN","PSD68P",9,0)
 .I $P(^PSD(58.8,PSDLOC,0),U,2)="N" S PSDLOC(PSDLOC)=1
"RTN","PSD68P",10,0)
 ;
"RTN","PSD68P",11,0)
 ; LOOP THROUGH ^PSD(58.81 & GATHER ALL NAOU TRANSACTIONS WITH RX#
"RTN","PSD68P",12,0)
 ; 
"RTN","PSD68P",13,0)
 S PSDTRN=0 F  S PSDTRN=$O(^PSD(58.81,PSDTRN)) Q:'PSDTRN  D
"RTN","PSD68P",14,0)
 .S PSDNAOU=$P(^PSD(58.81,PSDTRN,0),U,18)
"RTN","PSD68P",15,0)
 .Q:$G(PSDNAOU)=""
"RTN","PSD68P",16,0)
 .Q:'$G(PSDLOC(PSDNAOU))
"RTN","PSD68P",17,0)
 .S PSDPN=$P(^PSD(58.81,PSDTRN,0),U,17),PSDRG=$P(^PSD(58.81,PSDTRN,0),U,5)
"RTN","PSD68P",18,0)
 .I $G(PSDPN) D
"RTN","PSD68P",19,0)
 ..S ^TMP($J,"PSD68P",PSDNAOU,PSDPN,PSDRG,PSDTRN)=^PSD(58.81,PSDTRN,0)
"RTN","PSD68P",20,0)
 ..S ^TMP($J,"PSD68P",PSDNAOU,PSDPN)=$G(^TMP($J,"PSD68P",PSDNAOU,PSDPN))+1
"RTN","PSD68P",21,0)
 ;
"RTN","PSD68P",22,0)
 ; LOOP THROUGH ^TMP($J,"PSD68P AND FIND BAD DRUG DISPENSING # & INDEX
"RTN","PSD68P",23,0)
 ; 
"RTN","PSD68P",24,0)
 S XMSUB="PSD*3*68 POST INSTALL Report",PSDRPT="PSD68P-D"
"RTN","PSD68P",25,0)
 S ^TMP($J,PSDRPT,1)="PSD*3*68 DRUG ACCOUNTABILITY TRANSACTION Drug Dispensing # Index Repair"
"RTN","PSD68P",26,0)
 S ^TMP($J,PSDRPT,2)=""
"RTN","PSD68P",27,0)
 S ^TMP($J,PSDRPT,3)="The following Drug Dispensing # Index for the DRUG ACCOUNTABILITY TRANSACTION"
"RTN","PSD68P",28,0)
 S ^TMP($J,PSDRPT,4)="file have been fixed."
"RTN","PSD68P",29,0)
 S ^TMP($J,PSDRPT,5)=""
"RTN","PSD68P",30,0)
 S PSDTXT="" D TXT("Transaction#",1),TXT("Drug Name",15),TXT("Dispensing#",60)
"RTN","PSD68P",31,0)
 S ^TMP($J,PSDRPT,6)=PSDTXT,^TMP($J,PSDRPT,7)="",PSDCNT=7
"RTN","PSD68P",32,0)
 S PSDNAOU="" F  S PSDNAOU=$O(^TMP($J,"PSD68P",PSDNAOU)) Q:'PSDNAOU  D
"RTN","PSD68P",33,0)
 .S PSDPN="" F  S PSDPN=$O(^TMP($J,"PSD68P",PSDNAOU,PSDPN)) Q:'PSDPN  D
"RTN","PSD68P",34,0)
 ..I $G(^TMP($J,"PSD68P",PSDNAOU,PSDPN))=1 K ^TMP($J,"PSD68P",PSDNAOU,PSDPN) Q
"RTN","PSD68P",35,0)
 ..S PSDRG="" F  S PSDRG=$O(^TMP($J,"PSD68P",PSDNAOU,PSDPN,PSDRG)) Q:'PSDRG  D CLEAN
"RTN","PSD68P",36,0)
 ..K ^TMP($J,"PSD68P",PSDNAOU,PSDPN)
"RTN","PSD68P",37,0)
 I '$G(PSDFND) S ^TMP($J,PSDRPT,3)="There were NO incorrect Drug Dispensing # Indexes found.",^TMP($J,PSDRPT,4)="",PSDCNT=5
"RTN","PSD68P",38,0)
 D MAIL
"RTN","PSD68P",39,0)
 Q
"RTN","PSD68P",40,0)
TXT(PSDVAL,PSDCOL) ; FORAMT THE MAILMAN TEXT
"RTN","PSD68P",41,0)
 S:'$D(PSDTXT) PSDTXT="" S PSDTXT=$$SETSTR^VALM1(PSDVAL,PSDTXT,PSDCOL,$L(PSDVAL))
"RTN","PSD68P",42,0)
 Q
"RTN","PSD68P",43,0)
CLEAN ; REMOVE THE BAD DRUG DISPENSING # & INDEX
"RTN","PSD68P",44,0)
 S PSDTRN=0 F  S PSDTRN=$O(^TMP($J,"PSD68P",PSDNAOU,PSDPN,PSDRG,PSDTRN)) Q:'PSDTRN  D
"RTN","PSD68P",45,0)
 .Q:$P(^TMP($J,"PSD68P",PSDNAOU,PSDPN,PSDRG,PSDTRN),"^",2)'=17
"RTN","PSD68P",46,0)
 .S PSDDT=$P(^TMP($J,"PSD68P",PSDNAOU,PSDPN,PSDRG,PSDTRN),"^",4),PSDDAYS=$$FMDIFF^DILIBF(DT,PSDDT,"")
"RTN","PSD68P",47,0)
 .S $P(^PSD(58.81,PSDTRN,0),U,17)="",$P(^PSD(58.81,PSDTRN,0),U,20)="",PSDFND=1
"RTN","PSD68P",48,0)
 .D MQUE
"RTN","PSD68P",49,0)
 .K ^PSD(58.81,"D",PSDPN,PSDTRN)
"RTN","PSD68P",50,0)
 .K DA,DIK S DA=PSDTRN,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSD68P",51,0)
 Q
"RTN","PSD68P",52,0)
MQUE ; STEP UP THE ^TMP( DATA FOR THE MAILMAN MESSAGE
"RTN","PSD68P",53,0)
 S PSDTXT="" D TXT(PSDTRN,2),TXT($P(^PSDRUG(PSDRG,0),"^"),15),TXT(PSDPN,62)
"RTN","PSD68P",54,0)
 S PSDCNT=PSDCNT+1,^TMP($J,PSDRPT,PSDCNT)=PSDTXT
"RTN","PSD68P",55,0)
 S PSDCNT=PSDCNT+1,^TMP($J,PSDRPT,PSDCNT)=""
"RTN","PSD68P",56,0)
 Q
"RTN","PSD68P",57,0)
MAIL ; SEND THE MAILMAN MESSAGE
"RTN","PSD68P",58,0)
 N DIFROM
"RTN","PSD68P",59,0)
 S PSDCNT=PSDCNT+1,^TMP($J,PSDRPT,PSDCNT)="***** End Of Report *****"
"RTN","PSD68P",60,0)
 S XMTEXT="^TMP($J,PSDRPT,",XMDUZ="PSD*3*68 Post Install"
"RTN","PSD68P",61,0)
 S PSDDUZ=0 F  S PSDDUZ=$O(^XUSEC("PSDMGR",PSDDUZ)) Q:'PSDDUZ  S XMY(PSDDUZ)=""
"RTN","PSD68P",62,0)
 D ^XMD
"RTN","PSD68P",63,0)
EXIT ; CLEAN UP
"RTN","PSD68P",64,0)
 K ^TMP($J),XMDUZ,XMSUB,XMTEXT,XMY,PSDCNT,PSDDAYS,PSDDT,PSDDUZ,PSDFND,PSDRPT,PSDRG,PSDPN,PSDTRN,PSDNAOU,PSDLOC,PSDVAL,PSDCOL,PSDTXT
"RTN","PSD68P",65,0)
 Q
"RTN","PSDPAT1")
0^2^B73058275^B63600329
"RTN","PSDPAT1",1,0)
PSDPAT1 ;B'ham ISC/JPW,BJW - Prt activity report (Patient/Drug) ; 17 Apr 98
"RTN","PSDPAT1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**7,62,68**;13 Feb 97;Build 12
"RTN","PSDPAT1",3,0)
 ;modified for nois:det-0198-42285;displays drugs for destruction,returns,waste,transfers
"RTN","PSDPAT1",4,0)
START ;entry for compile and print
"RTN","PSDPAT1",5,0)
 K ^TMP("PSDPAT",$J),^TMP("PSDPAT1",$J),^TMP("PSDPATB",$J),^TMP("PSDPATL",$J) S (PSDAQTY,PSDCNT)=0,PSDNAOU=NAOU
"RTN","PSDPAT1",6,0)
 I $D(ALL) F PSDR=0:0 S PSDR=$O(^PSD(58.8,+PSDNAOU,1,PSDR)) Q:'PSDR  I $D(^PSD(58.8,+PSDNAOU,1,+PSDR,0)) S PSDRG(+PSDR)=+$P(^(0),U,4)
"RTN","PSDPAT1",7,0)
 F PSDR=0:0 S PSDR=$O(PSDRG(PSDR)) Q:'PSDR  D
"RTN","PSDPAT1",8,0)
 .F PSD=PSDSD:0 S PSD=$O(^PSD(58.81,"ACT",PSD)) Q:'PSD  D
"RTN","PSDPAT1",9,0)
 ..S PSD58=0  F  S PSD58=$O(^PSD(58.81,"ACT",PSD,PSD58)) Q:'PSD58  D
"RTN","PSDPAT1",10,0)
 ...F PSDTYP=0:0 S PSDTYP=$O(^PSD(58.81,"ACT",PSD,PSD58,PSDR,PSDTYP)) Q:'PSDTYP  D
"RTN","PSDPAT1",11,0)
 ....F PSDA=0:0 S PSDA=$O(^PSD(58.81,"ACT",PSD,PSD58,PSDR,PSDTYP,PSDA)) Q:'PSDA  I $P(^PSD(58.81,PSDA,0),U,18)=PSDNAOU!($P(^PSD(58.81,PSDA,0),U,3)=PSDNAOU) D
"RTN","PSDPAT1",12,0)
 .....D CHK2
"RTN","PSDPAT1",13,0)
 .....Q:$G(PSDSTOP)
"RTN","PSDPAT1",14,0)
 .....S PSDEND=0 I PSD>PSDED S PSDEND=1
"RTN","PSDPAT1",15,0)
 .....S ^TMP("PSDPAT1",$J,PSDR,PSDA)=PSDEND
"RTN","PSDPAT1",16,0)
 F PSDR=0:0 S PSDR=$O(PSDRG(PSDR)) Q:'PSDR  F PSDA=0:0 S PSDA=$O(^PSD(58.8,+PSDNAOU,1,PSDR,3,PSDA)) Q:'PSDA  D
"RTN","PSDPAT1",17,0)
 .Q:'$D(^PSD(58.8,PSDNAOU,1,PSDR,3,PSDA,0))  S PSD0=^(0),PSD=$P(PSD0,U,15)
"RTN","PSDPAT1",18,0)
 .I (PSD>PSDSD) D
"RTN","PSDPAT1",19,0)
 ..S PSDEND=0 I PSD>PSDED S PSDEND=1
"RTN","PSDPAT1",20,0)
 ..S PSDTR=+$P($G(PSD0),U,17),PSDTYP=$P(^PSD(58.81,PSDTR,0),U,2),PSDSTOP=0 I PSDTYP'=23 D CHK2
"RTN","PSDPAT1",21,0)
 ..Q:$G(PSDSTOP)
"RTN","PSDPAT1",22,0)
 ..S ^TMP("PSDPAT1",$J,PSDR,PSDTR)=PSDEND
"RTN","PSDPAT1",23,0)
 F PSD=PSDSD:0 S PSD=$O(^PSD(58.81,"ATRN",PSD)) Q:'PSD!(PSD>PSDED)  D
"RTN","PSDPAT1",24,0)
 .F PSDA=0:0 S PSDA=$O(^PSD(58.81,"ATRN",PSD,PSDA)) Q:'PSDA  D
"RTN","PSDPAT1",25,0)
 ..S PSD0=^PSD(58.81,PSDA,0) Q:$P(PSD0,U,18)'=NAOU!('$D(PSDRG($P(PSD0,U,5))))  D
"RTN","PSDPAT1",26,0)
 ...S PSDEND=0 I PSD>PSDED S PSDEND=1
"RTN","PSDPAT1",27,0)
 ...S:PSDRG($P(PSD0,U,5)) ^TMP("PSDPAT1",$J,$P(PSD0,U,5),PSDA)=PSDEND
"RTN","PSDPAT1",28,0)
 S PSDRUG=0 F  S PSDRUG=$O(^TMP("PSDPAT1",$J,PSDRUG)) Q:'PSDRUG  D
"RTN","PSDPAT1",29,0)
 .S (PSDNBAL,PSDA)=0 F  S PSDA=$O(^TMP("PSDPAT1",$J,PSDRUG,PSDA)) Q:'PSDA  D  D PSDPATB^PSDPAT2
"RTN","PSDPAT1",30,0)
 ..;S PSD0=$G(^PSD(58.81,PSDA,0)),PSDTYP=$P(PSD0,U,2),PSD=$P(PSD0,U,4),PSDRQ="" Q:$P(PSD0,U,11)=3!($P(PSD0,U,2)=12)
"RTN","PSDPAT1",31,0)
  ..S PSD0=$G(^PSD(58.81,PSDA,0)),PSDTYP=$P(PSD0,U,2),PSD=$P(PSD0,U,4),PSDRQ=""
"RTN","PSDPAT1",32,0)
 ..S PSDRN=$S($P($G(^PSDRUG(+PSDRUG,0)),U)]"":$P(^(0),U),1:"ZZ/"_PSDRUG_" NAME MISSING")
"RTN","PSDPAT1",33,0)
 ..Q:$P(PSD0,U,11)=3!($P(PSD0,U,2)=12)
"RTN","PSDPAT1",34,0)
 ..S PSDSTOP=0 I PSDTYP'=23 D CHK2
"RTN","PSDPAT1",35,0)
 ..Q:$G(PSDSTOP)
"RTN","PSDPAT1",36,0)
 ..S PSDEND=$G(^TMP("PSDPAT1",$J,PSDRUG,PSDA))
"RTN","PSDPAT1",37,0)
 ..I PSDTYP'=17 S PSDRQ=$P(^PSD(58.81,PSDA,0),U,20) S:$G(PSDRQ) PSD0=$G(^PSD(58.8,PSDNAOU,1,PSDRUG,3,PSDRQ,0))
"RTN","PSDPAT1",38,0)
 ..I '$G(PSDRQ) D  Q
"RTN","PSDPAT1",39,0)
 ...S PSDBAL=$P(PSD0,U,10)
"RTN","PSDPAT1",40,0)
 ...D SET^PSDPAT2 Q
"RTN","PSDPAT1",41,0)
 ..I $G(PSDRQ) D  Q
"RTN","PSDPAT1",42,0)
 ...S PSD=$P(PSD0,U,15)
"RTN","PSDPAT1",43,0)
 ...Q:'$G(PSD)
"RTN","PSDPAT1",44,0)
 ...S PSDNR1=+$P(PSD0,U,4),PSDNR2="",PSDQTY=+$P(PSD0,U,20),PSDBAL=$P(PSD0,U,22),PSDPAT="PHARMACY DISP #"_$P(PSD0,U,16)
"RTN","PSDPAT1",45,0)
 ...S PSDRN=$S($P($G(^PSDRUG(+PSDRUG,0)),U)]"":$P(^(0),U),1:"ZZ/"_PSDRUG_" NAME MISSING") S PSDTR=+$P($G(PSD0),U,17)
"RTN","PSDPAT1",46,0)
 ...I (PSDTYP=18)!(PSDTYP=17) S $P(PSDRG(+PSDRUG),U,2)=+$P(PSDRG(+PSDRUG),U,2)+PSDQTY
"RTN","PSDPAT1",47,0)
 ...S PSDNR1=$S($P($G(^VA(200,PSDNR1,0)),U)]"":$P(^(0),U),1:"UNKNOWN")
"RTN","PSDPAT1",48,0)
 ...S (PSDWQT,PSDWRE,PSDRQT,PSDRRE,PSDDRG1,PSDSOQT,PSDDQT,PSDDRE,PSDRET,PSDDT)="",PSD9="",$P(PSD0,U,16)="",PSDTYP=0
"RTN","PSDPAT1",49,0)
 ...S PSD3=$G(^PSD(58.81,PSDA,3)) S PSDRET=+$P(PSD3,U),PSDRQT=+$P(PSD3,U,2),PSDRRE=$P(PSD3,U,3),PSDDQT=+$P(PSD3,U,5),PSDDRE=$P(PSD3,U,6),PSDDT=+$P(PSD3,U,4)
"RTN","PSDPAT1",50,0)
 ...I $P(^PSD(58.81,PSDA,0),U,2)=9 S PSDTYP=9
"RTN","PSDPAT1",51,0)
 ...I $P(^PSD(58.81,PSDA,0),U,2)=5 S PSDTYP=5 D SET2^PSDPAT2 Q
"RTN","PSDPAT1",52,0)
 ...S $P(PSD0,U,10)=$P(PSD0,U,22) D SET1^PSDPAT2
"RTN","PSDPAT1",53,0)
 F  S PSDR=$O(PSDRG(PSDR)) Q:'PSDR  I $G(PSDRG(PSDR))  S PSDRN=$S($P($G(^PSDRUG(+PSDR,0)),U)]"":$P(^(0),U),1:"ZZ/"_PSDR_" NAME MISSING") D:'$D(^TMP("PSDPAT",$J,PSDRN))
"RTN","PSDPAT1",54,0)
 .S ^TMP("PSDPAT",$J,PSDRN,DT,"NO ACTIVITY",1)=0,^TMP("PSDPATL",$J,PSDRN)=U_PSDRG(PSDR)
"RTN","PSDPAT1",55,0)
PRINT ;prints data
"RTN","PSDPAT1",56,0)
 I SUM="S" D ^PSDPAT2 G DONE
"RTN","PSDPAT1",57,0)
 S (PG,PSDOUT,PSDAQTY)=0,PSDRN="",$P(LN,"-",132)="" D NOW^%DTC S Y=+$E(%,1,12) X ^DD("DD") S PSDRPDT=Y
"RTN","PSDPAT1",58,0)
 I '$D(^TMP("PSDPAT",$J)) D HDR W !!,?15,"**** NO DISPENSING ACTIVITY ****",!! G DONE
"RTN","PSDPAT1",59,0)
 D HDR S PSDRG="" F  S PSDRG=$O(^TMP("PSDPAT",$J,PSDRG)) Q:PSDRG=""!(PSDOUT)  W !,?5,"=> ",PSDRG,! D CHK F PSD=0:0 S PSD=$O(^TMP("PSDPAT",$J,PSDRG,PSD)) D:'PSD TOT Q:PSD=""!(PSDOUT)  D  Q:PSDOUT
"RTN","PSDPAT1",60,0)
 .S PSDPAT="" F  S PSDPAT=$O(^TMP("PSDPAT",$J,PSDRG,PSD,PSDPAT)) Q:PSDPAT=""!(PSDOUT)  F PSD1=0:0 S PSD1=$O(^TMP("PSDPAT",$J,PSDRG,PSD,PSDPAT,PSD1)) Q:'PSD1!(PSDOUT)  D  Q:PSDOUT
"RTN","PSDPAT1",61,0)
 ..S (PSDQTY,PSDSOQT,PSDRQT,PSDWQT,PSDDQT,PSDSTAT)=0,(PSDRRE,PSDWRE,PSDDRE)=""
"RTN","PSDPAT1",62,0)
 ..S PSD0=^TMP("PSDPAT",$J,PSDRG,PSD,PSDPAT,PSD1),PSDRGN=PSDRG
"RTN","PSDPAT1",63,0)
 ..Q:$P(PSD0,U,4)=3
"RTN","PSDPAT1",64,0)
 ..W ! I $Y+8>IOSL D HDR Q:PSDOUT  W !,?5,"=> ",PSDRG,!
"RTN","PSDPAT1",65,0)
 ..S Y=+$E(PSD,1,12) X ^DD("DD") S PSDT=Y
"RTN","PSDPAT1",66,0)
 ..I $G(PSD0)=0 S PSDQTY=0,PSDPQT=$P(^TMP("PSDPATL",$J,PSDRGN),U,2) W PSDT,?22,PSDPAT,?55,$J(PSDQTY,6),?75,$J(PSDPQT,6),! Q
"RTN","PSDPAT1",67,0)
 ..S PSDTYP=+$P(PSD0,U,4),PSDR=$P(PSD0,U,11),PSDSTAT=+$P(PSD0,U,24),PSDQTY=+$P(PSD0,U)
"RTN","PSDPAT1",68,0)
 ..I (PSDTYP)=9 S PSDPQT=+PSDNBAL+PSDQTY,PSDNBAL=PSDPQT W PSDT,?22,PSDPAT,?55,$J(PSDQTY,6),?75,$J(PSDPQT,6),?98,$P(PSD0,U,2),!,?98,$P(PSD0,U,3),!,?25,$P(PSD0,U,6),!
"RTN","PSDPAT1",69,0)
 ..I PSDTYP=11 S PSDPQT=+PSDNBAL+PSDQTY,PSDNBAL=PSDPQT W PSDT,?22,PSDPAT,?55,$J(PSDQTY,6),?75,$J(PSDPQT,6),?98,$P(PSD0,U,2),!,?98,$P(PSD0,U,3),!
"RTN","PSDPAT1",70,0)
 ..I (+$P(PSD0,U,9)) S PSDRQT=+$P(PSD0,U,9)
"RTN","PSDPAT1",71,0)
 ..I PSDTYP=17 S PSDSOQT=+$P(PSD0,U,12),PSDNBAL=+(PSDNBAL-PSDSOQT)+PSDRQT D
"RTN","PSDPAT1",72,0)
 ...W PSDT,?22,PSDPAT,?54 W:PSDTYP=17 "-" W $J(PSDSOQT,6)
"RTN","PSDPAT1",73,0)
 ...W ?75,$J(PSDNBAL,6),?98,$P(PSD0,U,2),! W:$P(PSD0,U,3)'="" ?98,$P(PSD0,U,3),!
"RTN","PSDPAT1",74,0)
 ...W PSDT,?22,PSDPAT,?45,"*GIVEN*" S PSDQTY=PSDSOQT-PSDRQT W ?55,$J(PSDQTY,6),!
"RTN","PSDPAT1",75,0)
 ...I PSDRQT S PSDPRT=1 D PRTRET
"RTN","PSDPAT1",76,0)
 ..I +$P(PSD0,U,5) S PSDWQT=+$P(PSD0,U,5),PSDWRE=$P(PSD0,U,6),PSDQTY=PSDQTY-PSDWQT D
"RTN","PSDPAT1",77,0)
 ...W PSDT,?22,PSDPAT,?45,"*WASTED*",?55,$J(PSDWQT,6)
"RTN","PSDPAT1",78,0)
 ...W ?98,$P(PSD0,U,2),!,?25,PSDWRE,?98,$P(PSD0,U,3),!
"RTN","PSDPAT1",79,0)
 ..I PSDTYP=23 S PSDPQT=+PSDNBAL+PSDQTY,PSDNBAL=PSDPQT W PSDT,?22,PSDPAT,?55,$J(PSDQTY,6),?75,$J(PSDPQT,6),?98,$P(PSD0,U,2),!,?98,$P(PSD0,U,3),!
"RTN","PSDPAT1",80,0)
 ..I PSDTYP=0,'$G(PSDSTAT) D
"RTN","PSDPAT1",81,0)
 ...S PSDPQT=+PSDNBAL+PSDQTY,PSDNBAL=PSDPQT W PSDT,?22,PSDPAT,?55,$J(PSDQTY,6),?75,$J(PSDPQT,6),?98,$P(PSD0,U,2),! I $P(PSD0,U,3)'="" W ?98,$P(PSD0,U,3),!
"RTN","PSDPAT1",82,0)
 ...S PSDRQT=+$P(PSD0,U,9),PSDPRT=0 I $G(PSDRQT) D PRTRET
"RTN","PSDPAT1",83,0)
 ..I PSDTYP=0,$G(PSDSTAT)=10 D
"RTN","PSDPAT1",84,0)
 ...S PSDPQT=+PSDNBAL+$P(PSD0,U),PSDNBAL=PSDPQT
"RTN","PSDPAT1",85,0)
 ...W:$P(PSD0,U)'=0 PSDT,?22,PSDPAT,?55,$J(PSDQTY,6),?75,$J(PSDPQT,6),?98,$P(PSD0,U,2),!,?98,$P(PSD0,U,3),!  ; < *62 RJS
"RTN","PSDPAT1",86,0)
 ... S PSDTFDT=$P(PSD0,U,17),Y=PSDTFDT X ^DD("DD") S PSDTFDT=$E(Y,1,17),PSDTFN=$P(PSD0,U,18),PSDT2N=$P(PSD0,U,19),PSDTTDT=$P(PSD0,U,20)
"RTN","PSDPAT1",87,0)
 ...S PSDTTNR=$P(PSD0,U,21),PSDTRQT=+$P(PSD0,U,23),PSDNBAL=+PSDNBAL-PSDTRQT D PRTTRT
"RTN","PSDPAT1",88,0)
 ..I PSDTYP=5,'$G(PSDSTAT) S PSDPQT=+PSDNBAL+PSDQTY,PSDNBAL=PSDPQT D
"RTN","PSDPAT1",89,0)
 ...W PSDT,?22,PSDPAT,?45,"*TRFER*",?55,$J(PSDQTY,6),?75,$J(PSDPQT,6),?98,$P(PSD0,U,2),! I $P(PSD0,U,3)'="" W ?98,$P(PSD0,U,3),!
"RTN","PSDPAT1",90,0)
 ...W ?29,"*TRANSFERED FROM "_$P(PSD0,U,19),"*",?98,$P(PSD0,U,21),!
"RTN","PSDPAT1",91,0)
 ...S PSDRQT=+$P(PSD0,U,9) I $G(PSDRQT) D
"RTN","PSDPAT1",92,0)
 ....S PSDRRE=$P(PSD0,U,10),PSDNBAL=+PSDNBAL-PSDRQT,PSDRET=$P(PSD0,U,15),Y=PSDRET X ^DD("DD") S PSDRET=$E(Y,1,17)
"RTN","PSDPAT1",93,0)
 ....S:$G(PSDRET)=0 PSDRET="" W !,PSDRET,?22,PSDPAT,?45,"*RETURN* -",?55,$J(PSDRQT,6),?75,$J(PSDNBAL,6),?98,$P(PSD0,U,2),!,?25,PSDRRE,?98,!
"RTN","PSDPAT1",94,0)
 ..I +$P(PSD0,U,13) S PSDDQT=+$P(PSD0,U,13),PSDDRE=$P(PSD0,U,14),PSDDT=+$P(PSD0,U,16),PSDNBAL=PSDNBAL-PSDDQT D
"RTN","PSDPAT1",95,0)
 ...W PSDT,?22,PSDPAT,?44,"*DESTROY* -",?55,$J(PSDDQT,6),?75,$J(PSDNBAL,6),?98,$P(PSD0,U,2),!,?25,PSDDRE,?98,$P(PSD0,U,3),!
"RTN","PSDPAT1",96,0)
 ..I PSDTYP=5,$G(PSDSTAT)=10 D
"RTN","PSDPAT1",97,0)
 ...S PSDPQT=+PSDNBAL+$P(PSD0,U)-$P(PSD0,U,23),PSDNBAL=PSDPQT
"RTN","PSDPAT1",98,0)
 ...W:$P(PSD0,U)'="" PSDT,?22,PSDPAT,?55,$J(PSDQTY,6),?75,$J(PSDPQT,6),?98,$P(PSD0,U,2),!,?98,$P(PSD0,U,3),!  ; < *62 RJS
"RTN","PSDPAT1",99,0)
 ... S PSDTFDT=$P(PSD0,U,17),Y=PSDTFDT X ^DD("DD") S PSDTFDT=$E(Y,1,17),PSDTFN=$P(PSD0,U,18),PSDT2N=$P(PSD0,U,19),PSDTTDT=$P(PSD0,U,20)
"RTN","PSDPAT1",100,0)
 ...S PSDTTNR=$P(PSD0,U,21),PSDTRQT=+$P(PSD0,U,23) D PRTTRT
"RTN","PSDPAT1",101,0)
 ..I PSDTYP=99,+$P(PSD0,U,9)'=0 D
"RTN","PSDPAT1",102,0)
 ...S PSDRQT=+$P(PSD0,U,9),PSDNBAL=+PSDNBAL-PSDRQT D PRTRET
"RTN","PSDPAT1",103,0)
DONE I $E(IOST)'="C" W @IOF
"RTN","PSDPAT1",104,0)
 I $E(IOST,1,2)="C-",'PSDOUT W ! K DIR,DIRUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu" D ^DIR K DIR
"RTN","PSDPAT1",105,0)
END ;
"RTN","PSDPAT1",106,0)
 D KVAR^VADPT K VA,%,%DT,%H,%I,%ZIS,ALL,PSDAQTY,PSDBAL,PSDCNT,DA,PSDT,PSDDT,DFN,DIC,DIR,DIROUT,DIRUT,PSDDQT,DTOUT,PSDDRE,PSDDRG1,DUOUT,LN,LOOP,PSDNAOU,NAOU,NAOUN,PSDNBAL,PSD0,PSD3,PSD7,PSD9,PSDNR1,PSDSTOP
"RTN","PSDPAT1",107,0)
 K PSDNR2,PSDSTAT,PSDPAT,PG,POP,PSD,PSD1,PSDA,PSDATE,PSDED,PSDOUT,PSDPN,PSDPQT,PSDR,PSDRET,PSDRG,PSDRGN,PSDRN,PSDSD,PSDRQT,PSDRRE,PSDRPDT,PSDSOQT,PSD58,PSDRQ,PSDRUG,PSDTBAL,PSDTMP,PSDEND,PSDT2N,PSDTFDT,PSDPRT
"RTN","PSDPAT1",108,0)
 K PSDTFN,PSDTPRV,PSDTRQT,PSDTTDT,PSDTTNR,PSDTTON,PSDTQTY,PSDTYP,PSDQTY,SUM,PSDUQT,VADM,VAERR,PSDWQT,PSDWRE,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK,^TMP("PSDPAT",$J),^TMP("PSDPAT1",$J),^TMP("PSDPATB",$J),^TMP("PSDPATL",$J)
"RTN","PSDPAT1",109,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDPAT1",110,0)
 Q
"RTN","PSDPAT1",111,0)
PRTTRT ; PRINT TRANSFER TO INFORMATION
"RTN","PSDPAT1",112,0)
 W PSDTFDT,?22,PSDPAT,?45,"*TRFER* -",?55,$J(PSDTRQT,6),?75,$J(PSDNBAL,6),?98,$P(PSD0,U,18),!,?32,"*TRANSFER TO "_$P(PSD0,U,19),"*",?98,$P(PSD0,U,21),!
"RTN","PSDPAT1",113,0)
 Q
"RTN","PSDPAT1",114,0)
PRTRET ; PRINT RETURN INFORMATION
"RTN","PSDPAT1",115,0)
 S PSDRRE=$P(PSD0,U,10),PSDRET=$P(PSD0,U,15),Y=PSDRET X ^DD("DD") S PSDRET=$E(Y,1,17)
"RTN","PSDPAT1",116,0)
 S:$G(PSDRET)=0 PSDRET="",PSDNBAL=+PSDNBAL-PSDRQT
"RTN","PSDPAT1",117,0)
 W PSDRET,?22,PSDPAT,?45,"*RETURN*" W:'$G(PSDPRT) " -" W ?55,$J(PSDRQT,6) W:'$G(PSDPRT) ?75,$J(PSDNBAL,6)
"RTN","PSDPAT1",118,0)
 W ?98,$P(PSD0,U,2),!,?25,PSDRRE,?98,$P(PSD0,U,3),!
"RTN","PSDPAT1",119,0)
 K PSDPRT
"RTN","PSDPAT1",120,0)
 Q
"RTN","PSDPAT1",121,0)
HDR ;header
"RTN","PSDPAT1",122,0)
 I $E(IOST,1,2)="C-",PG K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDPAT1",123,0)
 S PG=PG+1 W:$Y @IOF W !,?20,"Activity Report for ",NAOUN,?55,PSDRPDT,?115,"Page: ",PG,!,?20,"Date: ",$P(PSDATE,U)," to ",$P(PSDATE,U,2),!!
"RTN","PSDPAT1",124,0)
 W ?5,"=>  DRUG",!,"DATE/TIME",?22,"PATIENT",?55,"QUANTITY",?75,"BALANCE",?98,"NURSE 1",!,?98,"NURSE2",!,LN,!!
"RTN","PSDPAT1",125,0)
 Q
"RTN","PSDPAT1",126,0)
CHK ;sets total qty used and balance
"RTN","PSDPAT1",127,0)
 S PSDTQTY=+$G(^TMP("PSDPATL",$J,PSDRG)),PSDBAL=+$P($G(^TMP("PSDPATL",$J,PSDRG)),U,2),PSDUQT=PSDBAL-PSDTQTY,PSDNBAL=$P($G(^TMP("PSDPATB",$J,PSDRG)),U,2)-$P($G(^TMP("PSDPATB",$J,PSDRG)),U,1)
"RTN","PSDPAT1",128,0)
 Q
"RTN","PSDPAT1",129,0)
CHK2 ;CHECK THE TTYPE
"RTN","PSDPAT1",130,0)
 S PSDSTOP=0 I PSDTYP'=23 D
"RTN","PSDPAT1",131,0)
 .I '$D(^PSD(58.81,PSDA,1)) D
"RTN","PSDPAT1",132,0)
 ..I PSDTYP'=17 S PSDSTOP=1
"RTN","PSDPAT1",133,0)
 ..I PSDTYP=9 S PSDSTOP=0
"RTN","PSDPAT1",134,0)
 Q
"RTN","PSDPAT1",135,0)
TOT ;prints total qty used and balance
"RTN","PSDPAT1",136,0)
 I $Y+4>IOSL D HDR Q:PSDOUT  W !,?5,"=> ",$S(PSDRG]"":PSDRG,1:PSDRGN),!
"RTN","PSDPAT1",137,0)
 ;W !,?55,"----------",?75,"----------",!,?5,"Total Quantity Used and Balance",?55,$J(PSDAQTY,6),?70,$J(PSDPQT,6),!
"RTN","PSDPAT1",138,0)
 W ! S PSDAQTY=0
"RTN","PSDPAT1",139,0)
 Q
"RTN","PSDPAT2")
0^4^B45069536^B2198141
"RTN","PSDPAT2",1,0)
PSDPAT2 ;B'ham ISC/JPW - Print Patient/Drug Report (summary) ; 1 Feb 94
"RTN","PSDPAT2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**68**;13 Feb 97;Build 12
"RTN","PSDPAT2",3,0)
 D NOW^%DTC S Y=+$E(%,1,12) X ^DD("DD") S RPDT=Y
"RTN","PSDPAT2",4,0)
 S (PG,PSDOUT)=0,$P(LN,"-",80)=""
"RTN","PSDPAT2",5,0)
 I '$D(^TMP("PSDPATL",$J)) D HDR W !!,?45,"****  NO DISPENSING SUMMARY  ****" Q
"RTN","PSDPAT2",6,0)
PRINT ;prints data for dispensing
"RTN","PSDPAT2",7,0)
 D HDR Q:PSDOUT
"RTN","PSDPAT2",8,0)
 S LOOP="" F  S LOOP=$O(^TMP("PSDPATL",$J,LOOP)) Q:LOOP=""!(PSDOUT)  D:$Y+4>IOSL HDR Q:PSDOUT  D  Q:PSDOUT
"RTN","PSDPAT2",9,0)
 .W !,LOOP,?55,$J(+$P(^TMP("PSDPATL",$J,LOOP),"^",3),6),?70,$J(+$P(^(LOOP),"^",2),6),!
"RTN","PSDPAT2",10,0)
DONE I SUM,$E(IOST)'="C" W @IOF
"RTN","PSDPAT2",11,0)
 Q
"RTN","PSDPAT2",12,0)
HDR ;lists header information
"RTN","PSDPAT2",13,0)
 I $E(IOST,1,2)="C-",PG W ! K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDPAT2",14,0)
 W:$Y @IOF S PG=PG+1 W !,?22,"ACTIVITY",?70,"PG "_PG,!,?29,"** SUMMARY **",!,?27,"Date: ",$P(PSDATE,"^")," to ",$P(PSDATE,"^",2),!!,"NAOU: ",NAOUN,!!
"RTN","PSDPAT2",15,0)
 W "DRUG",?55,"QUANTITY USED",?70,"BALANCE",!,LN,!
"RTN","PSDPAT2",16,0)
 Q
"RTN","PSDPAT2",17,0)
 ;; ADDED FOR 3*68 - RJS
"RTN","PSDPAT2",18,0)
SET ;sets data
"RTN","PSDPAT2",19,0)
 Q:'$D(^PSD(58.81,PSDA,0))  S PSD0=^(0),PSDQTY=+$P(PSD0,U,6),PSD=$P(PSD0,U,4)
"RTN","PSDPAT2",20,0)
 S PSD9=$G(^PSD(58.81,PSDA,9)) S PSDSOQT=+$P(PSD9,U,3),PSDWQT=+$P(PSD9,U,4)
"RTN","PSDPAT2",21,0)
 ;I PSDTYP=17,PSD>PSDED S PSDNBAL=PSDNBAL-(PSDSOQT+PSDWQT) D PSDPATB Q
"RTN","PSDPAT2",22,0)
 I +$P(PSD0,U,5) S PSDDRG1=+$P(PSD0,U,5)
"RTN","PSDPAT2",23,0)
 I PSDTYP=17 S $P(PSDRG(+PSDRUG),U,2)=+$P(PSDRG(+PSDRUG),U,2)+PSDSOQT
"RTN","PSDPAT2",24,0)
 S PSD3=$G(^PSD(58.81,PSDA,3)) S PSDRET=+$P(PSD3,U),PSDRQT=+$P(PSD3,U,2),PSDRRE=$P(PSD3,U,3),PSDDQT=+$P(PSD3,U,5),PSDDRE=$P(PSD3,U,6),PSDDT=+$P(PSD3,U,4)
"RTN","PSDPAT2",25,0)
 S DFN=+$P($G(PSD9),U) D DEM^VADPT
"RTN","PSDPAT2",26,0)
 S PSDPAT=$S(PSDTYP=18:"WASTED AMOUNT",PSDTYP=11:"INITIALIZE BALANCE",PSDTYP=9:"BALANCE ADJUSTMENT",PSDTYP=23:"COUNT VERIFICATION",'VAERR:VADM(1),1:"UNKNOWN")
"RTN","PSDPAT2",27,0)
 S:PSDTYP=2!(PSDTYP=3) PSDPAT="PHARMACY DISP#"_$P(PSD0,U,17),PSDTYP=0,PSDTR=PSDA
"RTN","PSDPAT2",28,0)
 S PSDNR1=$S($P(PSD9,U,2)'="":$P(PSD9,U,2),1:$P(PSD0,U,7))
"RTN","PSDPAT2",29,0)
 S:PSDNR1'=$P(PSD0,U,7) PSDNR1(1)=$P(PSD0,U,7)
"RTN","PSDPAT2",30,0)
 S:+$G(PSDNR1) PSDNR1=$S($P($G(^VA(200,+PSDNR1,0)),U)]"":$P(^(0),U),1:"UNKNOWN")
"RTN","PSDPAT2",31,0)
 S PSDNR2=$P($G(PSD9),U,6) S:PSDNR2 PSDNR2=$S($P($G(^VA(200,+PSDNR2,0)),U)]"":$P(^(0),U),1:"")
"RTN","PSDPAT2",32,0)
 S PSDRN=$S($P($G(^PSDRUG(+PSDRUG,0)),U)]"":$P(^(0),U),1:"ZZ/"_PSDRUG_" NAME MISSING")
"RTN","PSDPAT2",33,0)
SET1 ;sets ^TMP("PSDPAT"
"RTN","PSDPAT2",34,0)
 I $G(^PSD(58.81,PSDA,1)),$P(PSD3,U,1)'="" D CHKRET Q:PSD<PSDSD
"RTN","PSDPAT2",35,0)
 I PSD<PSDSD,$P(PSD3,U,4)'="" D CHKDEST Q
"RTN","PSDPAT2",36,0)
 I PSDTYP=0 D CHKNOD7
"RTN","PSDPAT2",37,0)
 S PSDQTY=$S(PSDTYP=17:0,1:PSDQTY),PSDRQT=$S(PSDTYP=17:PSDRQT,1:-PSDRQT)
"RTN","PSDPAT2",38,0)
 I '$G(PSDEND) D
"RTN","PSDPAT2",39,0)
 .Q:PSD<PSDSD
"RTN","PSDPAT2",40,0)
 .K PSDATA
"RTN","PSDPAT2",41,0)
 .I PSDTYP=17 S PSDNBAL=PSDNBAL+(PSDRQT-PSDSOQT)
"RTN","PSDPAT2",42,0)
 .I PSDTYP'=17 S PSDNBAL=PSDNBAL+PSDQTY+PSDRQT-PSDSOQT
"RTN","PSDPAT2",43,0)
 .S PSDATA=PSDQTY_U_PSDNR1_U_PSDNR2_U_PSDTYP_U_PSDWQT_U_$P(PSD0,U,16)_U_PSDBAL_U_$G(PSDNR1(1))_U_PSDRQT_U_PSDRRE_U_PSDDRG1_U_PSDSOQT_"^^^"_PSDRET_U_PSDDT
"RTN","PSDPAT2",44,0)
 .S PSDCNT=PSDCNT+1 D PSDPAT,PSDPATL I $P(PSD3,U,4)'="" D CHKDEST
"RTN","PSDPAT2",45,0)
 I $G(PSDTRQT),PSDTFDT<PSDED D
"RTN","PSDPAT2",46,0)
 .I '$G(PSDEND) S PSDATA="0^^^"_PSDTYP_"^^^"_PSDBAL_"^^^^^^^^^"_U_PSDTFDT_U_PSDTFN_U_PSDT2N_U_PSDTTDT_U_PSDTTNR_U_PSDTPRV_U_PSDTRQT_U_PSDSTAT
"RTN","PSDPAT2",47,0)
 .S PSDNBAL=PSDNBAL-PSDTRQT
"RTN","PSDPAT2",48,0)
 .N PSD S PSD=PSDTFDT,PSDCNT=PSDCNT+1 D PSDPAT,PSDPATL
"RTN","PSDPAT2",49,0)
 I $G(PSDTRQT),(PSDTFDT>PSDED!(PSDTFDT=PSDED)) S PSDNBAL=PSDNBAL-PSDTRQT
"RTN","PSDPAT2",50,0)
 I $G(PSDEND) D
"RTN","PSDPAT2",51,0)
 .I PSDTYP=17 S PSDNBAL=PSDNBAL+(PSDRQT-PSDSOQT)
"RTN","PSDPAT2",52,0)
 .I PSDTYP'=17 S PSDNBAL=PSDNBAL+PSDQTY+PSDRQT-PSDSOQT
"RTN","PSDPAT2",53,0)
 K PSDATA,PSDQTY,PSDTRQT,PSDNR1,PSDNR2,PSD0,PSD3,PSD7,PSDTR Q
"RTN","PSDPAT2",54,0)
SET2 ;SETS ^TMP("PSDPAT"
"RTN","PSDPAT2",55,0)
 N PSDTRDT,PSDPAT
"RTN","PSDPAT2",56,0)
 S PSD0=$G(^PSD(58.81,PSDA,0)),PSDRN=$S($P($G(^PSDRUG(+PSDRUG,0)),U)]"":$P(^(0),U),1:"ZZ/"_PSDRUG_" NAME MISSING")
"RTN","PSDPAT2",57,0)
 S PSDTRDT=$P(^PSD(58.81,PSDA,1),U,4),PSDPAT="PHARMACY DISP #"_$P(PSD0,U,17),PSD=$P(PSD0,U,4)
"RTN","PSDPAT2",58,0)
 Q:$D(^TMP("PSDPAT",$J,PSDRN,PSDTRDT))
"RTN","PSDPAT2",59,0)
 I PSDTYP=5 S PSD7=$G(^PSD(58.81,+PSDA,7)) D NODE7
"RTN","PSDPAT2",60,0)
 I PSDTYP'=5 S PSDTR=PSDA D
"RTN","PSDPAT2",61,0)
 .D CHKNOD7
"RTN","PSDPAT2",62,0)
 .I $G(PSDTRQT) D
"RTN","PSDPAT2",63,0)
 ..I '$G(PSDEND) D
"RTN","PSDPAT2",64,0)
 ...K PSDATA
"RTN","PSDPAT2",65,0)
 ...S PSDCNT=PSDCNT+1,PSDPAT="PHARMACY DISP #"_$P(PSD0,U,17),PSDATA="^^^0^^^^^^^^^^^^^"_PSDTFDT_U_PSDTFN_U_PSDT2N_U_PSDTTDT_U_PSDTTNR_U_PSDTPRV_U_PSDTRQT_U_PSDSTAT
"RTN","PSDPAT2",66,0)
 ...D PSDPAT,PSDPATL
"RTN","PSDPAT2",67,0)
 ..S PSDNBAL=PSDNBAL-PSDTRQT
"RTN","PSDPAT2",68,0)
 K PSDATA,PSDQTY,PSDTRQT,PSDNR1,PSDNR2,PSD0,PSD3,PSD7,PSDTR
"RTN","PSDPAT2",69,0)
 Q
"RTN","PSDPAT2",70,0)
CHKNOD7 ; COLLECTS TRANSFER DATA
"RTN","PSDPAT2",71,0)
 S PSD7=$G(^PSD(58.81,+PSDTR,7))
"RTN","PSDPAT2",72,0)
 S PSDSTAT=$P($G(^PSD(58.81,+PSDTR,0)),U,11)
"RTN","PSDPAT2",73,0)
 S PSDTFDT=+$P(PSD7,U),PSDTTON=+$P(PSD7,U,3),PSDT2N=$P($G(^PSD(58.8,PSDTTON,0)),U),PSDTTDT=+$P(PSD7,U,4),PSDTPRV=+$P(PSD7,U,6),PSDTRQT=+$P(PSD7,U,7)
"RTN","PSDPAT2",74,0)
 S PSDTFN=$S($P(PSD7,U,2):$P(PSD7,U,2),1:$P(PSD0,U,7))
"RTN","PSDPAT2",75,0)
 S:PSDTFN'=$P(PSD0,U,7) PSDTFN(1)=$P(PSD0,U,7) S PSDTFN=$S($P($G(^VA(200,+PSDTFN,0)),U)]"":$P(^(0),U),1:"UNKNOWN")
"RTN","PSDPAT2",76,0)
 S PSDTTNR=$P($G(PSD7),U,5) S:PSDTTNR PSDTTNR=$S($P($G(^VA(200,+PSDTTNR,0)),U)]"":$P(^(0),U),1:"")
"RTN","PSDPAT2",77,0)
 Q
"RTN","PSDPAT2",78,0)
NODE7 ; SETS TRANSFERS BETWEEN NAOU'S
"RTN","PSDPAT2",79,0)
 I $P(PSD3,U,1)'="" D CHKRET Q:PSD<PSDSD
"RTN","PSDPAT2",80,0)
 I $P(PSD3,U,4)'="" D CHKDEST Q:PSD<PSDSD
"RTN","PSDPAT2",81,0)
 S (PSDTFDT,PSDTFN,PSDTTDT,PSDTTNR,PSDTPRV,PSDTRQT,PSDSTAT)=""
"RTN","PSDPAT2",82,0)
 S PSDTTON=+$P(^PSD(58.81,$P(PSD7,U,6),0),U,18),PSDT2N=$P($G(^PSD(58.8,PSDTTON,0)),U),PSDTRQT=+PSDQTY
"RTN","PSDPAT2",83,0)
 I '$G(PSDEND) D
"RTN","PSDPAT2",84,0)
 .K PSDATA S PSDATA=PSDQTY_U_PSDNR1_U_PSDNR2_U_PSDTYP_U_PSDWQT_U_$P(PSD0,U,16)_"^^"_$G(PSDNR1(1))_U_PSDRQT_U_PSDRRE
"RTN","PSDPAT2",85,0)
 .S PSDATA=PSDATA_U_PSDDRG1_U_PSDSOQT_"^^^^^^^"_PSDT2N_"^^^^"_PSDTRQT_U,PSDCNT=PSDCNT+1
"RTN","PSDPAT2",86,0)
 .D PSDPAT,PSDPATL
"RTN","PSDPAT2",87,0)
 S PSDNBAL=PSDNBAL+PSDQTY-PSDDQT-PSDRQT
"RTN","PSDPAT2",88,0)
 I $P(PSD7,U,1) S PSDTR=PSDA D
"RTN","PSDPAT2",89,0)
 .D CHKNOD7
"RTN","PSDPAT2",90,0)
 .I '$G(PSDEND) D
"RTN","PSDPAT2",91,0)
 ..K PSDATA
"RTN","PSDPAT2",92,0)
 ..S $P(PSDATA,U,4)=PSDTYP,$P(PSDATA,U,17)=PSDTFDT,PSDATA=PSDATA_U_PSDTFN_U_PSDT2N_U_PSDTTDT_U_PSDTTNR_U_PSDTPRV_U_PSDTRQT_U_PSDSTAT
"RTN","PSDPAT2",93,0)
 ..S PSDCNT=PSDCNT+1 D PSDPAT,PSDPATL
"RTN","PSDPAT2",94,0)
 .S PSDNBAL=PSDNBAL-PSDTRQT
"RTN","PSDPAT2",95,0)
 Q
"RTN","PSDPAT2",96,0)
CHKRET ; SETS RETURNED ITEM INFORMATION
"RTN","PSDPAT2",97,0)
 N PSD,PSDNR1,PSDNR2,PSDQTY S PSD=$P(^PSD(58.81,PSDA,0),U,19),(PSDQTY,PSDWQT,PSDSOQT,PSDDQT,PSDDRE)=0
"RTN","PSDPAT2",98,0)
 S PSDNR1=+$P(^PSD(58.81,PSDA,1),U,10),PSDNR1=$S($P($G(^VA(200,+PSDNR1,0)),U)]"":$P(^(0),U),1:"UNKNOWN")
"RTN","PSDPAT2",99,0)
 S PSDNR2=+$P(^PSD(58.81,PSDA,1),U,14) S:PSDNR2 PSDNR2=$S($P($G(^VA(200,+PSDNR2,0)),U)]"":$P(^(0),U),1:"")
"RTN","PSDPAT2",100,0)
 K PSDATA
"RTN","PSDPAT2",101,0)
 I '$G(PSDEND) D  Q
"RTN","PSDPAT2",102,0)
 .S PSDATA="0^"_PSDNR1_U_PSDNR2_"^99^0^"_$P(PSD0,U,16)_"^0^^"_PSDRQT_U_PSDRRE_U_PSDDRG1_"^0^0^0^"_PSDRET,PSDNBAL=PSDNBAL-PSDRQT
"RTN","PSDPAT2",103,0)
 .S PSDCNT=PSDCNT+2,PSDQTY=0
"RTN","PSDPAT2",104,0)
 .D PSDPAT,PSDPATL
"RTN","PSDPAT2",105,0)
 .S PSDCNT=PSDCNT-2,PSDRQT=0,PSDRRE=""
"RTN","PSDPAT2",106,0)
 I $G(PSDEND) S PSDNBAL=PSDNBAL-PSDRQT
"RTN","PSDPAT2",107,0)
 S PSDCNT=PSDCNT+1,PSDRQT=0,PSDRRE=""
"RTN","PSDPAT2",108,0)
 Q 
"RTN","PSDPAT2",109,0)
CHKDEST ; SETS DESTROYED ITEM INFORMATION
"RTN","PSDPAT2",110,0)
 N PSD,PSDNR1,PSDNR2,PSDQTY  S PSD=$P(PSD3,U,4)
"RTN","PSDPAT2",111,0)
 S PSDNR1=+$P(^PSD(58.81,PSDA,1),U,10),PSDNR1=$S($P($G(^VA(200,+PSDNR1,0)),U)]"":$P(^(0),U),1:"UNKNOWN")
"RTN","PSDPAT2",112,0)
 S PSDNR2=+$P(^PSD(58.81,PSDA,1),U,14) S:PSDNR2 PSDNR2=$S($P($G(^VA(200,+PSDNR2,0)),U)]"":$P(^(0),U),1:"")
"RTN","PSDPAT2",113,0)
 S PSDDQT=$P(PSD3,U,5),PSDDRE=$P(PSD3,U,6) K PSDATA
"RTN","PSDPAT2",114,0)
 I '$G(PSDEND) D
"RTN","PSDPAT2",115,0)
 .S PSDATA="0^"_PSDNR1_U_PSDNR2_"^4^0^"_$P(PSD0,U,16)_"^0^^0^0^"_PSDDRG1_"^0^"_PSDDQT_U_PSDDRE,PSDNBAL=PSDNBAL-PSDDQT
"RTN","PSDPAT2",116,0)
 .S PSDCNT=PSDCNT+1,PSDQTY=0 D PSDPAT,PSDPATL
"RTN","PSDPAT2",117,0)
 S PSDDQT=0,PSDDRE=""
"RTN","PSDPAT2",118,0)
 Q 
"RTN","PSDPAT2",119,0)
PSDPAT ;sets ^TMP("PSDPAT"
"RTN","PSDPAT2",120,0)
 Q:'$D(PSDATA)
"RTN","PSDPAT2",121,0)
 S ^TMP("PSDPAT",$J,PSDRN,PSD,PSDPAT,PSDCNT)=PSDATA
"RTN","PSDPAT2",122,0)
 Q
"RTN","PSDPAT2",123,0)
PSDPATL ;sets ^TMP("PSDPATL"
"RTN","PSDPAT2",124,0)
 Q:'$D(PSDATA)
"RTN","PSDPAT2",125,0)
 S:'$D(^TMP("PSDPATL",$J,PSDRN)) ^TMP("PSDPATL",$J,PSDRN)=0
"RTN","PSDPAT2",126,0)
 S ^TMP("PSDPATL",$J,PSDRN)=+^TMP("PSDPATL",$J,PSDRN)+($S(PSDTYP=18:-PSDQTY,PSDTYP=17:-PSDSOQT,1:PSDQTY)),$P(^(PSDRN),U,2)=+PSDRG(PSDRUG)
"RTN","PSDPAT2",127,0)
 S $P(^TMP("PSDPATL",$J,PSDRN),U,3)=+$P(^TMP("PSDPATL",$J,PSDRN),U,3)+$P(PSDRG(+PSDRUG),U,2)
"RTN","PSDPAT2",128,0)
 Q
"RTN","PSDPAT2",129,0)
PSDPATB ;sets ^TMP("PSDPATB"
"RTN","PSDPAT2",130,0)
 S ^TMP("PSDPATB",$J,PSDRN)=PSDNBAL_U_PSDRG(PSDRUG)
"RTN","PSDPAT2",131,0)
 Q
"RTN","PSDRF")
0^1^B25617376^B25117230
"RTN","PSDRF",1,0)
PSDRF ;BIR/JPW,LTL - Nurse RF Dispensing ; 8 Aug 94
"RTN","PSDRF",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**25,51,60,68**;13 Feb 97;Build 12
"RTN","PSDRF",3,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDRF",4,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDRF",5,0)
 ;Reference to ^PSDRUG( are covered by DBIA #221
"RTN","PSDRF",6,0)
 ;Reference to $$WITNESS^XUVERIFY are covered by DBIA #1513
"RTN","PSDRF",7,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRF",8,0)
 ;S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,1:0) I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to order",!,?12,"narcotic supplies.",! K OK Q
"RTN","PSDRF",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDRF",10,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDRF",11,0)
NURSE N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDRF",12,0)
NAOU ;select NAOU to dispense from
"RTN","PSDRF",13,0)
 I $G(NAOU) S PSDS=+$P(^PSD(58.8,NAOU,0),U,4) G PATIENT
"RTN","PSDRF",14,0)
 W !!,"Please enter the ward from which the drug(s) will be signed out."
"RTN","PSDRF",15,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ward: "
"RTN","PSDRF",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRF",17,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDRF",18,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDRF",19,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDRF",20,0)
 I '$P(^PSD(58.8,NAOU,0),U,4) S MSG=2 D MSG G END
"RTN","PSDRF",21,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4),PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDRF",22,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDRF",23,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDRF",24,0)
 ;S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDRF",25,0)
PATIENT N DIC,DTOUT,DUOUT,X,Y,PSDOUT S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","PSDRF",26,0)
 S DIC("A")="Scan/Enter Patient: "
"RTN","PSDRF",27,0)
 W ! D ^DIC K DIC G:Y<1 END S PAT=+Y
"RTN","PSDRF",28,0)
DRUG ;select drug
"RTN","PSDRF",29,0)
 N DIR,PSD,PSDR,PSDQ,WQTY,PSDDT
"RTN","PSDRF",30,0)
 S DIR(0)="FAO^1:40"
"RTN","PSDRF",31,0)
 S DIR("A")="Scan Drug Label or Enter Label # or Drug: "
"RTN","PSDRF",32,0)
 W ! D ^DIR K DIR G:Y="" PATIENT G:$D(DIRUT) END
"RTN","PSDRF",33,0)
 I $L(Y)=1,Y'=" " W $C(7),!!,"Please enter more than one character.",! G DRUG
"RTN","PSDRF",34,0)
 I $O(^PSD(58.81,"D",Y,0)) D
"RTN","PSDRF",35,0)
 .S PSD=0
"RTN","PSDRF",36,0)
 .F  S PSD=$O(^PSD(58.81,"D",Y,PSD)) Q:'PSD  S PSD(1)=$G(^PSD(58.81,PSD,0)) I $P(PSD(1),U,11)>3,$P(PSD(1),U,18)=NAOU S PSDR=$P(PSD(1),U,5),PSDPN=$P(PSD(1),U,17),PSDTYP=17
"RTN","PSDRF",37,0)
 I $D(PSDR),PSDR'=Y D  G:$G(PSDEND) END
"RTN","PSDRF",38,0)
 .I $D(^PSDRUG(Y)),$D(^PSD(58.8,NAOU,1,Y)) D
"RTN","PSDRF",39,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRF",40,0)
 ..I PSDDT>365 S PSDR=Y,PSDPN="" ;;<*68 - RJS
"RTN","PSDRF",41,0)
 .I '$D(^PSDRUG(Y)),$D(PSD(1)) D
"RTN","PSDRF",42,0)
 ..S PSDDT=$$FMDIFF^DILIBF(DT,$P(PSD(1),U,4),"")
"RTN","PSDRF",43,0)
 ..I PSDDT>365 K PSDR
"RTN","PSDRF",44,0)
 .I '$D(^PSDRUG(Y)),'$D(^PSD(58.8,NAOU,1,Y)),'$D(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! S PSDEND=1
"RTN","PSDRF",45,0)
 D:'$G(PSDR)  G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 PATIENT
"RTN","PSDRF",46,0)
 .S DIC="^PSD(58.8,NAOU,1,",DIC(0)="EMQSZ",DA(1)=NAOU
"RTN","PSDRF",47,0)
 .W ! D ^DIC K DIC I $D(DTOUT)!($D(DUOUT))!(Y<1) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! Q
"RTN","PSDRF",48,0)
 .S PSDR=+Y,PSDTYP=17
"RTN","PSDRF",49,0)
 I '$G(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRF",50,0)
 W:$G(PSDR) !!,$P($G(^PSDRUG(PSDR,0)),U)
"RTN","PSDRF",51,0)
BAL S PSDR(1)=$G(^PSD(58.8,NAOU,1,PSDR,0)),OQTY=$P(PSDR(1),U,4)
"RTN","PSDRF",52,0)
 W:'OQTY&$D(Y(0,0)) !,?12,Y(0,0)
"RTN","PSDRF",53,0)
 I 'OQTY,'$P($G(^PSD(58.81,+$G(PSD),9)),U) W !!,"Sorry, this drug has a zero balance." G DRUG
"RTN","PSDRF",54,0)
 ;PSD*3*25 (DAVE B)
"RTN","PSDRF",55,0)
 K PSDDAVE D ^PSDRFV I $G(PSDDAVE)=1 K PSDDAVE S PSDOUT=1 G END
"RTN","PSDRF",56,0)
 S DIR(0)="Y",DIR("A")="Starting Balance:  "_OQTY_" "_$P(PSDR(1),U,8)_"     Correct count"
"RTN","PSDRF",57,0)
 S DIR("B")="Yes",NUR1=DUZ
"RTN","PSDRF",58,0)
 S DIR("?")="Answer Yes if the amount on hand equals the starting balance."
"RTN","PSDRF",59,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRF",60,0)
 I Y=0 D ^PSDRF2 G:$G(PSDOUT) END S $P(PSDR(1),U,4)=PSDQ(1),OQTY=PSDQ(1),PSDTYP=17
"RTN","PSDRF",61,0)
 G:'$G(PSDS) END
"RTN","PSDRF",62,0)
LIQ G:$P($G(^PSD(58.8,+PSDS,1,PSDR,7)),U) ^PSDRFL
"RTN","PSDRF",63,0)
QTY S DIR(0)="NA^.01:"_OQTY_":2",DIR("A")="Amount given: "
"RTN","PSDRF",64,0)
 S DIR("B")=1 W ! D ^DIR K DIR G:Y'>0 END S (PSDQ,OQTY)=Y
"RTN","PSDRF",65,0)
WASTE I PSDQ#1 D  G:$G(PSDOUT) END
"RTN","PSDRF",66,0)
 .W ?30,"Amount wasted: ",1-PSDQ#1,! S WQTY=1-PSDQ#1
"RTN","PSDRF",67,0)
 .W !,"You have sixty seconds to find a witness.",!
"RTN","PSDRF",68,0)
WIT .W:$G(NUR2(1)) !,"OK, sixty more seconds, but that's it.",!
"RTN","PSDRF",69,0)
 .S NUR2=$$WITNESS^XUVERIFY("WITNESS"),NUR2(1)=$G(NUR2(1))+1
"RTN","PSDRF",70,0)
 .I NUR2=DUZ W !!,"Wait a minute, you can't witness yourself!",$C(7) G WIT
"RTN","PSDRF",71,0)
 .G:NUR2'>0&(NUR2(1)<2) WIT I NUR2'>0 S PSDOUT=1 Q
"RTN","PSDRF",72,0)
 .W !!,"Thank you, ",$S($P($G(^VA(200,NUR2,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($G(^VA(200,NUR2,0)),U)) S PSDQ=PSDQ+(1-PSDQ#1)
"RTN","PSDRF",73,0)
 W !!,"Remaining Balance: ",$P(PSDR(1),U,4)-PSDQ," ",$P(PSDR(1),U,8)
"RTN","PSDRF",74,0)
 D UPDAT^PSDRF1 G DRUG
"RTN","PSDRF",75,0)
END W:$G(PSDOUT) !!,"No dose signed out.",$C(7),!! K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1
"RTN","PSDRF",76,0)
 K NAOU,NAOUN,NBKU,NPKG,NUR1,NUR2,OK,OKTYP,ORD,PAT,PSDA,PSDEM,PSDEND,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRN,PSDS,PSDT,PSDUZ,PSDUZN,OQTY,REQD,TEXT,TYPE,WORD,X,Y
"RTN","PSDRF",77,0)
 Q
"RTN","PSDRF",78,0)
MSG ;display error message
"RTN","PSDRF",79,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDRF",80,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDRF",81,0)
 Q
"VER")
8.0^22.0
"BLD",7594,6)
^59
**END**
**END**

Released PSD*3*65 SEQ #55
Extracted from mail message
**KIDS**:PSD*3.0*65^

**INSTALL NAME**
PSD*3.0*65
"BLD",7074,0)
PSD*3.0*65^CONTROLLED SUBSTANCES^0^3070824^y
"BLD",7074,1,0)
^^17^17^3061214^
"BLD",7074,1,1,0)
This patch addresses the following problems:
"BLD",7074,1,2,0)
 1. HD169083 - Vault Setup
"BLD",7074,1,3,0)
  In Controlled Substances, under the Site Parameters option (PSD SITE),
"BLD",7074,1,4,0)
  the user is unable to add an inpatient site.
"BLD",7074,1,5,0)
 
"BLD",7074,1,6,0)
 2. HD98252 - Daily Activity Log does not record change on CS  invoice
"BLD",7074,1,7,0)
  After a Drug Accountability Verified Invoice has been edited, the Daily
"BLD",7074,1,8,0)
  Activity report does not properly display Drug Accountability
"BLD",7074,1,9,0)
  adjustments correctly..
"BLD",7074,1,10,0)
  
"BLD",7074,1,11,0)
 3. HD168800 - Inventory  issued  to NAOU somehow was doubled by Nurse
"BLD",7074,1,12,0)
  The Ward Nurse used the PSD REC GS option to accept an update from
"BLD",7074,1,13,0)
  Pharmacy, during this acceptance the inventory was doubled from 10
"BLD",7074,1,14,0)
  units to 20 even though only 10  units were involved. Pharmacy was able
"BLD",7074,1,15,0)
  to correct the problem and present inventories reflect actual
"BLD",7074,1,16,0)
  inventory. This is caused by two users being allowed to access the same
"BLD",7074,1,17,0)
  greensheet at the same time.
"BLD",7074,4,0)
^9.64PA^^
"BLD",7074,6)
2^
"BLD",7074,6.3)
5
"BLD",7074,"ABPKG")
n
"BLD",7074,"KRN",0)
^9.67PA^8989.52^19
"BLD",7074,"KRN",.4,0)
.4
"BLD",7074,"KRN",.401,0)
.401
"BLD",7074,"KRN",.402,0)
.402
"BLD",7074,"KRN",.403,0)
.403
"BLD",7074,"KRN",.5,0)
.5
"BLD",7074,"KRN",.84,0)
.84
"BLD",7074,"KRN",3.6,0)
3.6
"BLD",7074,"KRN",3.8,0)
3.8
"BLD",7074,"KRN",9.2,0)
9.2
"BLD",7074,"KRN",9.8,0)
9.8
"BLD",7074,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",7074,"KRN",9.8,"NM",1,0)
PSDSITE^^0^B8395758
"BLD",7074,"KRN",9.8,"NM",2,0)
PSDACT1^^0^B32437161
"BLD",7074,"KRN",9.8,"NM",3,0)
PSDNRGS^^0^B25527968
"BLD",7074,"KRN",9.8,"NM","B","PSDACT1",2)

"BLD",7074,"KRN",9.8,"NM","B","PSDNRGS",3)

"BLD",7074,"KRN",9.8,"NM","B","PSDSITE",1)

"BLD",7074,"KRN",19,0)
19
"BLD",7074,"KRN",19,"NM",0)
^9.68A^^
"BLD",7074,"KRN",19.1,0)
19.1
"BLD",7074,"KRN",101,0)
101
"BLD",7074,"KRN",409.61,0)
409.61
"BLD",7074,"KRN",771,0)
771
"BLD",7074,"KRN",870,0)
870
"BLD",7074,"KRN",8989.51,0)
8989.51
"BLD",7074,"KRN",8989.52,0)
8989.52
"BLD",7074,"KRN",8994,0)
8994
"BLD",7074,"KRN","B",.4,.4)

"BLD",7074,"KRN","B",.401,.401)

"BLD",7074,"KRN","B",.402,.402)

"BLD",7074,"KRN","B",.403,.403)

"BLD",7074,"KRN","B",.5,.5)

"BLD",7074,"KRN","B",.84,.84)

"BLD",7074,"KRN","B",3.6,3.6)

"BLD",7074,"KRN","B",3.8,3.8)

"BLD",7074,"KRN","B",9.2,9.2)

"BLD",7074,"KRN","B",9.8,9.8)

"BLD",7074,"KRN","B",19,19)

"BLD",7074,"KRN","B",19.1,19.1)

"BLD",7074,"KRN","B",101,101)

"BLD",7074,"KRN","B",409.61,409.61)

"BLD",7074,"KRN","B",771,771)

"BLD",7074,"KRN","B",870,870)

"BLD",7074,"KRN","B",8989.51,8989.51)

"BLD",7074,"KRN","B",8989.52,8989.52)

"BLD",7074,"KRN","B",8994,8994)

"BLD",7074,"QUES",0)
^9.62^^
"BLD",7074,"REQB",0)
^9.611^3^3
"BLD",7074,"REQB",1,0)
PSD*3.0*30^2
"BLD",7074,"REQB",2,0)
PSD*3.0*56^2
"BLD",7074,"REQB",3,0)
PSD*3.0*66^2
"BLD",7074,"REQB","B","PSD*3.0*30",1)

"BLD",7074,"REQB","B","PSD*3.0*56",2)

"BLD",7074,"REQB","B","PSD*3.0*66",3)

"MBREQ")
0
"PKG",499,-1)
1^1
"PKG",499,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",499,20,0)
^9.402P^^
"PKG",499,22,0)
^9.49I^1^1
"PKG",499,22,1,0)
3.0^2970213^2981028^66481
"PKG",499,22,1,"PAH",1,0)
65^3070824^123457078
"PKG",499,22,1,"PAH",1,1,0)
^^17^17^3070824
"PKG",499,22,1,"PAH",1,1,1,0)
This patch addresses the following problems:
"PKG",499,22,1,"PAH",1,1,2,0)
 1. HD169083 - Vault Setup
"PKG",499,22,1,"PAH",1,1,3,0)
  In Controlled Substances, under the Site Parameters option (PSD SITE),
"PKG",499,22,1,"PAH",1,1,4,0)
  the user is unable to add an inpatient site.
"PKG",499,22,1,"PAH",1,1,5,0)
 
"PKG",499,22,1,"PAH",1,1,6,0)
 2. HD98252 - Daily Activity Log does not record change on CS  invoice
"PKG",499,22,1,"PAH",1,1,7,0)
  After a Drug Accountability Verified Invoice has been edited, the Daily
"PKG",499,22,1,"PAH",1,1,8,0)
  Activity report does not properly display Drug Accountability
"PKG",499,22,1,"PAH",1,1,9,0)
  adjustments correctly..
"PKG",499,22,1,"PAH",1,1,10,0)
  
"PKG",499,22,1,"PAH",1,1,11,0)
 3. HD168800 - Inventory  issued  to NAOU somehow was doubled by Nurse
"PKG",499,22,1,"PAH",1,1,12,0)
  The Ward Nurse used the PSD REC GS option to accept an update from
"PKG",499,22,1,"PAH",1,1,13,0)
  Pharmacy, during this acceptance the inventory was doubled from 10
"PKG",499,22,1,"PAH",1,1,14,0)
  units to 20 even though only 10  units were involved. Pharmacy was able
"PKG",499,22,1,"PAH",1,1,15,0)
  to correct the problem and present inventories reflect actual
"PKG",499,22,1,"PAH",1,1,16,0)
  inventory. This is caused by two users being allowed to access the same
"PKG",499,22,1,"PAH",1,1,17,0)
  greensheet at the same time.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSDACT1")
0^2^B32437161^B31523945
"RTN","PSDACT1",1,0)
PSDACT1 ;BIR/JPW,BJW-Print Daily Activity Log (cont'd) ; 17 Jun 98
"RTN","PSDACT1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**10,14,30,65**;13 Feb 97;Build 5
"RTN","PSDACT1",3,0)
 ;Reference to ^PRC(442 supported by IA #682
"RTN","PSDACT1",4,0)
 ;Reference to ^PRCS(410 supported by IA #198
"RTN","PSDACT1",5,0)
 ;Reference to ^PSDRUG( supported by IA #221
"RTN","PSDACT1",6,0)
 ;Reference to ^PSRX( supported by IA #986
"RTN","PSDACT1",7,0)
 ;Reference to ^DD(58.81 supported by IA #10154
"RTN","PSDACT1",8,0)
 ;Reference to PSD(58.8 supported by DBIA # 2711
"RTN","PSDACT1",9,0)
 ;Reference to PSD(58.81 supported by DBIA # 2808
"RTN","PSDACT1",10,0)
 ;References to PSD(58.84 supported by IA # 3485
"RTN","PSDACT1",11,0)
 ;modified for nois:tua-0498-32173,new code added to t6
"RTN","PSDACT1",12,0)
 ;op v.7 chg the status loc in file 52
"RTN","PSDACT1",13,0)
START ;entry for compile
"RTN","PSDACT1",14,0)
 K ^TMP("PSDACT",$J)
"RTN","PSDACT1",15,0)
 I $D(ALL) F PSDR=0:0 S PSDR=$O(^PSD(58.8,+PSDS,1,PSDR)) Q:'PSDR  I $D(^PSD(58.8,+PSDS,1,PSDR,0)) S PSDRG(+PSDR)=""
"RTN","PSDACT1",16,0)
 F PSD=PSDSD:0 S PSD=$O(^PSD(58.81,"ACT",PSD)) Q:'PSD!(PSD>PSDED)  F PSDR=0:0 S PSDR=$O(^PSD(58.81,"ACT",PSD,PSDS,PSDR)) Q:'PSDR  D
"RTN","PSDACT1",17,0)
 .Q:'$D(PSDRG(PSDR))
"RTN","PSDACT1",18,0)
 .F TYP=0:0 S TYP=$O(^PSD(58.81,"ACT",PSD,PSDS,PSDR,TYP)) Q:'TYP!(TYP=12)  F PSDA=0:0 S PSDA=$O(^PSD(58.81,"ACT",PSD,PSDS,PSDR,TYP,PSDA)) Q:'PSDA  D SET
"RTN","PSDACT1",19,0)
 G:$D(ZTQUEUED) PRTQUE G PRINT^PSDACT2
"RTN","PSDACT1",20,0)
END ;
"RTN","PSDACT1",21,0)
 D KVAR^VADPT
"RTN","PSDACT1",22,0)
 K %,%DT,%H,%I,%ZIS,ACT,ALL,BFWD,C,DA,DATE,DIC,DIR,DIROUT,DIRUT,DTOUT,DUOUT,LN,MFG,NAOU,NODE,NQTY,NUM
"RTN","PSDACT1",23,0)
 K PAT,PG,PHARM,POP,PSD,PSDA,PSDATE,PSDED,PSDEV,PSDIO,PSDOUT,PSDPN,PSDR,PSDRG,PSDRGN,PSDS,PSDSD,PSDSN,PSDUZ,PSDUZN,RX,TEXT,TYP,QTY,TYPE,X,Y,VA("BID"),VA("PID")
"RTN","PSDACT1",24,0)
 K ^TMP("PSDACT",$J),ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDACT1",25,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDACT1",26,0)
 Q
"RTN","PSDACT1",27,0)
SET ;sets data
"RTN","PSDACT1",28,0)
 ;Dave B (PSD*3*14) Disregard if type is 15.
"RTN","PSDACT1",29,0)
 Q:'$D(^PSD(58.81,PSDA,0))  Q:TYP=5  Q:TYP=15  S NODE=^(0),QTY=$P(NODE,"^",6),BFWD=$P(NODE,"^",10)
"RTN","PSDACT1",30,0)
 S PSDRGN=$S($P($G(^PSDRUG(PSDR,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_PSDR_" NAME MISSING")
"RTN","PSDACT1",31,0)
 S PSDUZ=$S(TYP=3:+$P($G(^PSD(58.81,PSDA,1)),"^",14),TYP=4:+$P($G(^PSD(58.81,PSDA,1)),"^",14),TYP=13:+$P($G(^PSD(58.81,PSDA,5)),"^",2),TYP=14:+$P($G(^PSD(58.81,PSDA,4)),"^",2),1:+$P(NODE,"^",7))
"RTN","PSDACT1",32,0)
 S:TYP=2 PSDUZ=$S(+$P($G(^PSD(58.81,PSDA,1)),"^"):+$P($G(^(1)),"^"),1:+$P(NODE,"^",7))
"RTN","PSDACT1",33,0)
 S PSDUZN=$P($G(^VA(200,+PSDUZ,0)),"^"),PSDUZN=$S(PSDUZN]"":$E($P(PSDUZN,",",2))_$E(PSDUZN),1:"**")
"RTN","PSDACT1",34,0)
 I TYP=1 D T1 G TMP
"RTN","PSDACT1",35,0)
 I TYP=2 D T2 G TMP
"RTN","PSDACT1",36,0)
 I TYP=3 Q:'$D(^PSD(58.81,PSDA,3))  D T3 G TMP
"RTN","PSDACT1",37,0)
 Q:TYP=4
"RTN","PSDACT1",38,0)
 I TYP=6 Q:'$D(^PSD(58.81,PSDA,6))  D T6 G TMP
"RTN","PSDACT1",39,0)
 I TYP=7 D T7 G TMP
"RTN","PSDACT1",40,0)
 I TYP=9 D T9 G TMP
"RTN","PSDACT1",41,0)
 I TYP=11 D T11 G TMP
"RTN","PSDACT1",42,0)
 I TYP=13 Q:'$D(^PSD(58.81,PSDA,5))  D T13 G TMP
"RTN","PSDACT1",43,0)
 I TYP=14 Q:'$D(^PSD(58.81,PSDA,4))  D T14 G TMP
"RTN","PSDACT1",44,0)
 I TYP=16 D T16 G TMP
"RTN","PSDACT1",45,0)
 I TYP>18 D TOTH
"RTN","PSDACT1",46,0)
TMP ;
"RTN","PSDACT1",47,0)
 S PSDUZN=$P($G(^VA(200,+PSDUZ,0)),"^"),PSDUZN=$S(PSDUZN]"":$E($P(PSDUZN,",",2))_$E(PSDUZN),1:"**")
"RTN","PSDACT1",48,0)
 ;PSD*3*30 (Dave B - Identify person with more than just **)
"RTN","PSDACT1",49,0)
 I $G(PSDUZN)="**" S PSDUZ=$P($G(^PSD(58.81,PSDA,0)),"^",7),PSDUZN=$P($G(^VA(200,+PSDUZ,0)),"^"),PSDUZN=$S(PSDUZN]"":$E($P(PSDUZN,",",2))_$E(PSDUZN),1:"**")
"RTN","PSDACT1",50,0)
 S ^TMP("PSDACT",$J,PSDRGN,PSD,TYP,PSDA)=BFWD_"^"_NUM_"^"_TEXT_"^"_QTY_"^"_PSDUZN I $D(PSDRTS) S ^TMP("PSDACT",$J,PSDRGN,PSD,TYP,PSDA)=^TMP("PSDACT",$J,PSDRGN,PSD,TYP,PSDA)_"^1"
"RTN","PSDACT1",51,0)
 K PSDRTS Q
"RTN","PSDACT1",52,0)
T1 S NUM="***",TEXT="RECEIPT INTO PHARMACY"
"RTN","PSDACT1",53,0)
 I $P($G(^PSD(58.81,PSDA,8)),"^")]"" S NUM=$P($G(^PSD(58.81,PSDA,8)),"^") Q
"RTN","PSDACT1",54,0)
 I +$P(NODE,"^",9) S NUM=+$P(NODE,"^",9),NUM=$P($G(^PRC(442,NUM,0)),"^") Q
"RTN","PSDACT1",55,0)
 I +$P(NODE,"^",8) S NUM=+$P(NODE,"^",8),NUM=$P($G(^PRCS(410,NUM,0)),"^") Q
"RTN","PSDACT1",56,0)
 Q
"RTN","PSDACT1",57,0)
T2 S QTY=-QTY,NUM="DISP",NAOU=+$P(NODE,"^",18) S:NAOU NAOU=$P($G(^PSD(58.8,+NAOU,0)),"^") S TEXT=$S(NAOU]"":NAOU,1:"DISPENSED FROM PHARMACY")
"RTN","PSDACT1",58,0)
 I +$P(NODE,"^",17) S NUM="GS # "_$P(NODE,"^",17)
"RTN","PSDACT1",59,0)
 Q
"RTN","PSDACT1",60,0)
T3 S NUM="GS # ",TEXT="RETURNED TO STOCK"
"RTN","PSDACT1",61,0)
 I +$P(NODE,"^",17) S NUM=NUM_$P(NODE,"^",17)
"RTN","PSDACT1",62,0)
 ;PSD*3*30 (Dave B - more precise infor on RTS)
"RTN","PSDACT1",63,0)
 I $G(NUM)="GS # " D
"RTN","PSDACT1",64,0)
 .S RX=$P($G(^PSD(58.81,PSDA,6)),"^"),RXNUM=$P($G(^PSD(58.81,PSDA,6)),"^",5)
"RTN","PSDACT1",65,0)
 .S PAT=$P($G(^PSRX(RX,0)),"^",2) I PAT S DFN=PAT D PID^VADPT6 S Y=PAT,C=$P(^DD(58.81,73,0),"^",2) D Y^DIQ S TEXT=Y_"("_VA("BID")_")" K DFN,VA("BID"),VA("PID")
"RTN","PSDACT1",66,0)
 .S NUM="RX # "_$G(RXNUM)_" ("_$S($P($G(^PSD(58.81,PSDA,6)),U,2):"R"_$P($G(^(6)),U,2),$P($G(^(6)),U,4):"P"_$P($G(^(6)),U,4),1:"O")_")"
"RTN","PSDACT1",67,0)
 .S QTY=$P(^PSD(58.81,PSDA,3),"^",2),BFWD=$P(^PSD(58.81,PSDA,0),"^",10),PSDRTS=1 Q
"RTN","PSDACT1",68,0)
 I $G(PSDRTS)=1 Q
"RTN","PSDACT1",69,0)
 S QTY=$P(^PSD(58.81,PSDA,3),"^",2),BFWD=$P(^(3),"^",7)
"RTN","PSDACT1",70,0)
 Q
"RTN","PSDACT1",71,0)
T6 S QTY=-QTY,NUM="RX # ",TEXT="OUTPATIENT RX" N RXNUM
"RTN","PSDACT1",72,0)
 S RX=+$P(^PSD(58.81,PSDA,6),"^"),RXNUM=$S($P(^(6),"^",5)]"":$P(^(6),"^",5),$P($G(^PSRX(RX,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN"),NUM=NUM_RXNUM
"RTN","PSDACT1",73,0)
 S NUM=NUM_" ("_$S($P($G(^PSD(58.81,PSDA,6)),U,2):"R"_$P($G(^(6)),U,2),$P($G(^(6)),U,4):"P"_$P($G(^(6)),U,4),1:"O")_")"
"RTN","PSDACT1",74,0)
 S PAT=+$P($G(^PSRX(RX,0)),"^",2)
"RTN","PSDACT1",75,0)
 S PSDRXIN=RX D VER^PSDOPT
"RTN","PSDACT1",76,0)
 ;W !,TEXT,"  ",RXNUM
"RTN","PSDACT1",77,0)
 S TEXT=$S('$O(^PSRX("B",RXNUM,0)):"RX DELETED",$G(PSDSTA)=13:"RX DELETED",1:"UNKNOWN")
"RTN","PSDACT1",78,0)
 ;W !,TEXT
"RTN","PSDACT1",79,0)
 K PSDSTA,PSOVR,PSDRXIN
"RTN","PSDACT1",80,0)
 I PAT S DFN=PAT D PID^VADPT6 D
"RTN","PSDACT1",81,0)
 .K C S Y=PAT,C=$P(^DD(58.81,73,0),"^",2) D Y^DIQ S TEXT=Y_" ("_VA("BID")_")" K DFN,VA("BID"),VA("PID")
"RTN","PSDACT1",82,0)
 Q
"RTN","PSDACT1",83,0)
T7 S NUM="GS # ",TEXT="CANCEL UNVERIFIED ORDER",QTY=0
"RTN","PSDACT1",84,0)
 I +$P(NODE,"^",17) S NUM=NUM_$P(NODE,"^",17)
"RTN","PSDACT1",85,0)
 Q
"RTN","PSDACT1",86,0)
T9 S NUM="ADJ",TEXT=$S($D(^PSD(58.81,+PSDA,9)):$P(NODE,"^",16),1:"ADJUSTMENT")
"RTN","PSDACT1",87,0)
 I $P(NODE,"^",16)]"" S TEXT=$P(NODE,"^",16)
"RTN","PSDACT1",88,0)
 I $D(^PSD(58.81,PSDA,3)) S NUM="DEST # "_$P(^(3),"^",8),TEXT="HOLDING FOR DESTRUCTION"
"RTN","PSDACT1",89,0)
 Q
"RTN","PSDACT1",90,0)
T11 S NUM="***",TEXT="INITIALIZE BALANCE AT SETUP"
"RTN","PSDACT1",91,0)
 Q
"RTN","PSDACT1",92,0)
T13 S NUM="GS # ",TEXT="CANCEL VERIFIED ORDER"
"RTN","PSDACT1",93,0)
 I +$P(NODE,"^",17) S NUM=NUM_$P(NODE,"^",17)
"RTN","PSDACT1",94,0)
 S QTY=$P(^PSD(58.81,PSDA,5),"^",3),BFWD=$P(^(5),"^",5)
"RTN","PSDACT1",95,0)
 Q
"RTN","PSDACT1",96,0)
T14 S NUM="GS # ",TEXT="EDIT VERIFIED ORDER"
"RTN","PSDACT1",97,0)
 I +$P(NODE,"^",17) S NUM=NUM_$P(NODE,"^",17)
"RTN","PSDACT1",98,0)
 S:$D(^PSD(58.81,PSDA,8)) TEXT="EDIT VERIFIED INVOICE",NUM=$P(^PSD(58.81,PSDA,8),"^",1) ; <*65-RJS>
"RTN","PSDACT1",99,0)
 S QTY=$P(^PSD(58.81,PSDA,4),"^",4),BFWD=$P(^(4),"^",7)
"RTN","PSDACT1",100,0)
 Q
"RTN","PSDACT1",101,0)
T16 S NUM="TRV",TEXT="TRANSFER TO VAULT"
"RTN","PSDACT1",102,0)
 Q
"RTN","PSDACT1",103,0)
TOTH ;Type = 19,20,21,22
"RTN","PSDACT1",104,0)
 S NUM="INV",TEXT=$G(^PSD(58.84,+TYP,0)),QTY=""
"RTN","PSDACT1",105,0)
 Q
"RTN","PSDACT1",106,0)
PRTQUE ;queues print after compile
"RTN","PSDACT1",107,0)
 K ZTSAVE,ZTIO S ZTIO=PSDIO,ZTRTN="PRINT^PSDACT2",ZTDESC="CS PHARM Print Daily Activity Log",ZTDTH=$H,ZTSAVE("^TMP(""PSDACT"",$J,")="",ZTSAVE("PSDSN")="",ZTSAVE("PSDATE")=""
"RTN","PSDACT1",108,0)
 D ^%ZTLOAD K ZTSK G END
"RTN","PSDNRGS")
0^3^B25527968^B21669448
"RTN","PSDNRGS",1,0)
PSDNRGS ;BIR/JPW-Receive Green Sheet for NAOU ; 6 Jan 94
"RTN","PSDNRGS",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**56,66,65**;13 Feb 97;Build 5
"RTN","PSDNRGS",3,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNRGS",4,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):2,$D(^XUSEC("PSJ PHARM TECH",DUZ)):2,1:0)
"RTN","PSDNRGS",5,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to complete",!,?12,"narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, PSJ RPHARM, or PSJ PHARM TECH security key required.",! K OK Q
"RTN","PSDNRGS",6,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH Q
"RTN","PSDNRGS",7,0)
 W !!,"Receive Controlled Substances Orders and Green Sheet" S PSDUZ=DUZ,PSDUZN=$S($P($G(^VA(200,PSDUZ,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDNRGS",8,0)
 N X,X1 D SIG^XUSESIG Q:X1=""
"RTN","PSDNRGS",9,0)
ASKN ;ask naou
"RTN","PSDNRGS",10,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select NAOU: "
"RTN","PSDNRGS",11,0)
 S:OK=1 DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNRGS",12,0)
 S:OK=2 DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"""
"RTN","PSDNRGS",13,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNRGS",14,0)
GS ;select green sheet #
"RTN","PSDNRGS",15,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNRGS",16,0)
 S DIC("S")="I $P(^(0),""^"",11),$P(^(0),""^"",11)<12"
"RTN","PSDNRGS",17,0)
 D IX^DIC K DIC G:Y<0 ASKN S PSDA=+Y
"RTN","PSDNRGS",18,0)
ORD S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNRGS",19,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^"),QTY=+$P(Y(0),"^",6)
"RTN","PSDNRGS",20,0)
 ; >> RJS - *65
"RTN","PSDNRGS",21,0)
 L +^PSD(58.81,PSDA):$S($G(DILOCKTM)>0:DILOCKTM,1:3)
"RTN","PSDNRGS",22,0)
 I '$T W !,"The Green Sheet # ",PSDPN," is currently in use by another user",!,"Please select another Green Sheet.",! G GS
"RTN","PSDNRGS",23,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=$P(^(4),"^",3)
"RTN","PSDNRGS",24,0)
 I AOU'=NAOU W $C(7),!!,"The Green Sheet # ",PSDPN," is assigned to ",NAOUN,".",!,"Please select another Green Sheet.",! L -^PSD(58.81,PSDA) G GS  ; <RJS - *65
"RTN","PSDNRGS",25,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! L -^PSD(58.81,PSDA) G END  ; <RJS - *65
"RTN","PSDNRGS",26,0)
 I STAT'=3 W $C(7),!!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please select another Green Sheet.",! L -^PSD(58.81,PSDA) G GS  ; RJS - *65
"RTN","PSDNRGS",27,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNRGS",28,0)
REC ;receive at order level in 58.8
"RTN","PSDNRGS",29,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNRGS",30,0)
 K DA,DIR,DIRUT S DIR(0)="58.81,27",DIR("B")=QTY D ^DIR K DIR I $D(DIRUT) W !!,"Quantity not entered.  No action taken.",!,"This order remains ",STATN,!! L -^PSD(58.81,PSDA) G END  ; < RJS - *65
"RTN","PSDNRGS",31,0)
 S RQTY=Y I RQTY'=QTY W $C(7),!!,"The quantity received does not match the quantity dispensed.",!,"This order must be returned to pharmacy for investigation.",!! L -^PSD(58.81,PSDA) G GS  ;< RJS - *65
"RTN","PSDNRGS",32,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU
"RTN","PSDNRGS",33,0)
 S DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,"
"RTN","PSDNRGS",34,0)
 S DR=$S(OK=1:"6////"_PSDUZ,1:"6RECEIVED BY NURSE")_";20////"_QTY_";15////"_RECD_";10////4;22////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)_";25////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4) D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",35,0)
 I ($D(Y))!($D(DTOUT)) W $C(7),!!,"*** THIS ORDER HAS NOT BEEN RECEIVED ***",!,"Receiving nurses name must be entered.",!!,"The status remains "_STATN,! L -^PSD(58.81,PSDA) G END  ;< RJS - *65
"RTN","PSDNRGS",36,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDNRGS",37,0)
 ;updating drug balance in 58.8
"RTN","PSDNRGS",38,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNRGS",39,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNRGS",40,0)
 S $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)+QTY
"RTN","PSDNRGS",41,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDNRGS",42,0)
 ;update transaction file (58.81)
"RTN","PSDNRGS",43,0)
 S OREC=$P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",7)
"RTN","PSDNRGS",44,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81
"RTN","PSDNRGS",45,0)
 S DR="10////"_$S('$P($G(^PSD(58.8,NAOU,2)),U,5):4,$P($G(^PSD(58.81,PSDA,9)),U):4,1:13)_";20////"_OREC_";21////"_RECD_";27////"_QTY_";I OK=1 S Y=""@1"";15COMMENTS;@1"
"RTN","PSDNRGS",46,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",47,0)
 I OK=2 S $P(^PSD(58.81,PSDA,1),"^",11)=PSDUZ
"RTN","PSDNRGS",48,0)
 W !!,"Updating your records now..."
"RTN","PSDNRGS",49,0)
 ;update worksheet file (58.85) to be purged
"RTN","PSDNRGS",50,0)
 S DA=+$O(^PSD(58.85,"AD",NAOU,PSDR,ORD,0)) I DA,$D(^PSD(58.85,DA,0)) K DIE,DR S DIE=58.85,DR="6////4" D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",51,0)
 W "done.",!!
"RTN","PSDNRGS",52,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?5,"*** Your Green Sheet #"_PSDPN_" is now "_$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNRGS",53,0)
 L -^PSD(58.81,PSDA)  ;< RJS - *65
"RTN","PSDNRGS",54,0)
 G GS
"RTN","PSDNRGS",55,0)
END K %,%DT,%H,%I,AOU,AOUN,D,DA,DIC,DIE,DR,DTOUT,DUOUT
"RTN","PSDNRGS",56,0)
 K NAOU,NAOUN,OK,ORD,OREC,PSDPN,PSDR,PSDRN,PSDUZ,PSDUZN,QTY,RECD,RECDT,RQTY,STAT,STATN,SUB,PSDA,X,Y
"RTN","PSDNRGS",57,0)
 Q
"RTN","PSDSITE")
0^1^B8395758^B8382033
"RTN","PSDSITE",1,0)
PSDSITE ;BIR/JPW,LTL-Site Parameters for CS ; 3 May 95
"RTN","PSDSITE",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**65**;13 Feb 97;Build 5
"RTN","PSDSITE",3,0)
SITE ;entry for selecting inpatient sites in file 59.4
"RTN","PSDSITE",4,0)
 K DIC,DLAYGO S DIC="^PS(59.4,",DLAYGO=59.4,DIC(0)="QEAL",D="B",DZ="??"
"RTN","PSDSITE",5,0)
 D DQ^DICQ K D,DZ W ! D ^DIC K DIC G:Y<0 END
"RTN","PSDSITE",6,0)
 K DA,DIE,DR S DIE=59.4,DA=+Y,DR="31"_"Is "_$P(Y,U,2)_" selectable for Controlled Subs" W ! D ^DIE K DIE
"RTN","PSDSITE",7,0)
END K DA,DIC,DIE,DLAYGO,DR,DTOUT,DUOUT,X,Y
"RTN","PSDSITE",8,0)
 Q
"RTN","PSDSITE",9,0)
 ;
"RTN","PSDSITE",10,0)
LOW ;if auto generate, check low range for numbers
"RTN","PSDSITE",11,0)
 I '$D(X) S PSDFLAG=1 Q
"RTN","PSDSITE",12,0)
 K PSD,PSDFLAG,PSDL F PSD=0:0 S PSD=$O(^PSD(58.8,PSD)) Q:'PSD  I $D(^PSD(58.8,PSD,0)),$D(^(2)),$P(^(2),"^") D
"RTN","PSDSITE",13,0)
 .I +$P(^PSD(58.8,PSD,2),"^",2),+$P(^(2),"^",3) S PSDL(+PSD)=""
"RTN","PSDSITE",14,0)
 I $O(PSDL(0)) F PSD=0:0 S PSD=+$O(PSDL(PSD)) Q:'PSD  D
"RTN","PSDSITE",15,0)
 .I X'<$P($G(^PSD(58.8,PSD,2)),"^",2),(X'>$P($G(^(2)),"^",3)),PSD'=DA D MSG S PSDFLAG=1 Q
"RTN","PSDSITE",16,0)
 W:$D(PSDFLAG) "  Select another range.",! K PSD,PSDL
"RTN","PSDSITE",17,0)
 Q
"RTN","PSDSITE",18,0)
 ;
"RTN","PSDSITE",19,0)
HIGH ;validates high range for dispensing numbers
"RTN","PSDSITE",20,0)
 I '$D(X) S PSDFLAG=1 Q
"RTN","PSDSITE",21,0)
 K PSD,PSDFLAG,PSDH,PSDL F PSD=0:0 S PSD=$O(^PSD(58.8,PSD)) Q:'PSD  I $D(^PSD(58.8,PSD,0)),$D(^(2)),$P(^(2),"^") D
"RTN","PSDSITE",22,0)
 .I +$P(^PSD(58.8,PSD,2),"^",2) S PSDL(+$P(^(2),"^",2))=PSD
"RTN","PSDSITE",23,0)
 S PSDL=+$P($G(^PSD(58.8,DA,2)),"^",2),PSDH=+$O(PSDL(PSDL)) I PSDH S PSD=+$P(PSDL(PSDH),"^")
"RTN","PSDSITE",24,0)
 I X'>PSDL W !!,"High dispensing # must be larger than your low dispensing # "_PSDL_".",!! S PSDFLAG=1 Q
"RTN","PSDSITE",25,0)
 I PSDH,X'<PSDH D MSG S PSDFLAG=1
"RTN","PSDSITE",26,0)
 W:$D(PSDFLAG) "  Select another range.",! K PSD,PSDH,PSDL
"RTN","PSDSITE",27,0)
 Q
"RTN","PSDSITE",28,0)
 ;
"RTN","PSDSITE",29,0)
MSG ;prints message if range already in use
"RTN","PSDSITE",30,0)
 W $C(7),!!,?12," =>  Dispensing Site "_$S($P(^PSD(58.8,PSD,0),"^")]"":$P(^(0),"^"),1:"NAME MISSING")_"  <=",!,"has set aside the range "_$P($G(^PSD(58.8,PSD,2)),"^",2)_" through "_$P($G(^(2)),"^",3)_"."
"RTN","PSDSITE",31,0)
 Q
"RTN","PSDSITE",32,0)
 ;
"RTN","PSDSITE",33,0)
LAST ;checks range for 'last dispensed'
"RTN","PSDSITE",34,0)
 I '$D(X) S PSDFLAG=1 Q
"RTN","PSDSITE",35,0)
 I $D(PSDEN) D LAST1 K LOW,HIGH,PSDCHK Q
"RTN","PSDSITE",36,0)
 I X<$P($G(^PSD(58.8,DA,2)),"^",2) D MSG1 S PSDFLAG=1 Q
"RTN","PSDSITE",37,0)
 I X>$P($G(^PSD(58.8,DA,2)),"^",3) D MSG1 S PSDFLAG=1
"RTN","PSDSITE",38,0)
 Q
"RTN","PSDSITE",39,0)
 ;
"RTN","PSDSITE",40,0)
MSG1 ;prints message if not in dispensing range
"RTN","PSDSITE",41,0)
 W $C(7),!!,"Last number dispensed must be within the range "_$P($G(^PSD(58.8,DA,2)),"^",2)_" to "_$S($P($G(^(2)),"^",3):$P($G(^(2)),"^",3),1:999999999)_".",!
"RTN","PSDSITE",42,0)
 Q
"RTN","PSDSITE",43,0)
LAST1 ;checks LOW/HIGH range and LAST dispensed
"RTN","PSDSITE",44,0)
 I X<LOW D MSG2 S PSDFLAG=1 Q
"RTN","PSDSITE",45,0)
 I X>HIGH D MSG2 S PSDFLAG=1
"RTN","PSDSITE",46,0)
 Q
"RTN","PSDSITE",47,0)
MSG2 ;prints msg if not in dispensing range
"RTN","PSDSITE",48,0)
 S PSDCHK=1
"RTN","PSDSITE",49,0)
 W $C(7),!!,"Last number dispensed must be within the range ",LOW," to ",HIGH,".",!
"RTN","PSDSITE",50,0)
 Q
"VER")
8.0^22.0
"BLD",7074,6)
^55
**END**
**END**

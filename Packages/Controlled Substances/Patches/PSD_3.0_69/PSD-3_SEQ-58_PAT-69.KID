Released PSD*3*69 SEQ #58
Extracted from mail message
**KIDS**:PSD*3.0*69^

**INSTALL NAME**
PSD*3.0*69
"BLD",7003,0)
PSD*3.0*69^CONTROLLED SUBSTANCES^0^3100413^y
"BLD",7003,1,0)
^^47^47^3100127^
"BLD",7003,1,1,0)
The FY10 Q2 Enhancement Release includes the following.
"BLD",7003,1,2,0)
 
"BLD",7003,1,3,0)
Pharmacy Legacy Quarterly Enhancements (PLQE) subcommittee recommended the
"BLD",7003,1,4,0)
creation of a new security key named PSD TECH ADV that will allow
"BLD",7003,1,5,0)
Controlled Substances (CS) V. 3.0 package technicians to perform functions
"BLD",7003,1,6,0)
currently controlled by the pharmacist key and/or on the pharmacist menu.
"BLD",7003,1,7,0)
 
"BLD",7003,1,8,0)
This patch creates this new security key PSD TECH ADV, adds the following
"BLD",7003,1,9,0)
options from the pharmacist menu to the Technician (CS Pharmacy) Menu [PSD
"BLD",7003,1,10,0)
PHARM TECH], and allows the holders of this new key to perform these
"BLD",7003,1,11,0)
additional functions.
"BLD",7003,1,12,0)
 
"BLD",7003,1,13,0)
a. All options under the Receipts Into Pharmacy [PSD RECEIPTS MENU] menu.
"BLD",7003,1,14,0)
     Receiving [PSD RECEIVING]
"BLD",7003,1,15,0)
     Purchase Order Review [PSD PURCHASE ORDER REVIEW]
"BLD",7003,1,16,0)
     Control Point Transaction Review [PSD CP TRANSACTION REVIEW]
"BLD",7003,1,17,0)
     Drug Receipt History [PSD DRUG RECEIPT HISTORY]
"BLD",7003,1,18,0)
     Invoice Review (Prime Vendor) [PSD PV INVOICE REVIEW]
"BLD",7003,1,19,0)
 
"BLD",7003,1,20,0)
b. All options under the Dispensing Menu [PSD DISPENSING MENU].
"BLD",7003,1,21,0)
     Print CS Dispensing Worksheet [PSD WORKSHEET PRINT]
"BLD",7003,1,22,0)
     Fill/Dispense CS Orders from Worksheet [PSD WORKSHEET DISPENSING]
"BLD",7003,1,23,0)
     Dispensing/Receiving Report (VA FORM 10-2321) [PSD PRINT 2321]
"BLD",7003,1,24,0)
     Green Sheet - Print (VA FORM 10-2638) [PSD PRINT 2638]
"BLD",7003,1,25,0)
     Reprint Reports Menu [PSD REPRINT MENU] menu
"BLD",7003,1,26,0)
        Reprint Disp/Receiving Report (VA FORM 10-2321)
"BLD",7003,1,27,0)
        Green Sheet Reprint (VA FORM 10-2638)
"BLD",7003,1,28,0)
        Dispensing Worksheet Reprint
"BLD",7003,1,29,0)
        Label Reprint for Dispensing Drug
"BLD",7003,1,30,0)
        Reprint Transfer Between NAOUs (VA FORM 10-2321)
"BLD",7003,1,31,0)
     Pharmacy Dispense without (VA FORM 10-2638) [PSD DISPENSE W/O GS]
"BLD",7003,1,32,0)
     Label for Dispensing (Barcode) [PSD LABEL DRUG/NUMBER]
"BLD",7003,1,33,0)
     Narcotic Dispensing Equipment Orders [PSD DISPENSE TO NDES]
"BLD",7003,1,34,0)
 
"BLD",7003,1,35,0)
c. The following options under the Destructions Menu [PSD DESTROY MENU].
"BLD",7003,1,36,0)
     Hold a CS Drug (No Inventory Update) [PSD DEST NON-CS DRUG]
"BLD",7003,1,37,0)
     Non-VA Drug Placed on Hold for Destruction [PSD DEST TEXT DRUG]
"BLD",7003,1,38,0)
 
"BLD",7003,1,39,0)
d. The following options were also added to the Technician (CS Pharmacy)
"BLD",7003,1,40,0)
   Menu [PSD PHARM TECH].
"BLD",7003,1,41,0)
     Manufacturer, Lot #, and Exp. Date - Enter/Edit [PSD MFG/LOT/EXP DATE
"BLD",7003,1,42,0)
     EDIT]
"BLD",7003,1,43,0)
     Outpatient Rx's [PSD OUTPATIENT]
"BLD",7003,1,44,0)
 
"BLD",7003,1,45,0)
    Note: The CS technician will be allowed to perform all the
"BLD",7003,1,46,0)
          functionalities of the Outpatient Rx's [PSD OUTPATIENT] option
"BLD",7003,1,47,0)
          except the releasing of a prescription.
"BLD",7003,4,0)
^9.64PA^^
"BLD",7003,6.3)
13
"BLD",7003,"ABPKG")
n
"BLD",7003,"KRN",0)
^9.67PA^779.2^20
"BLD",7003,"KRN",.4,0)
.4
"BLD",7003,"KRN",.401,0)
.401
"BLD",7003,"KRN",.402,0)
.402
"BLD",7003,"KRN",.403,0)
.403
"BLD",7003,"KRN",.5,0)
.5
"BLD",7003,"KRN",.84,0)
.84
"BLD",7003,"KRN",3.6,0)
3.6
"BLD",7003,"KRN",3.8,0)
3.8
"BLD",7003,"KRN",9.2,0)
9.2
"BLD",7003,"KRN",9.8,0)
9.8
"BLD",7003,"KRN",9.8,"NM",0)
^9.68A^20^18
"BLD",7003,"KRN",9.8,"NM",1,0)
PSDOPT^^0^B88195048
"BLD",7003,"KRN",9.8,"NM",2,0)
PSDREC^^0^B19747505
"BLD",7003,"KRN",9.8,"NM",3,0)
PSDPWK^^0^B23890736
"BLD",7003,"KRN",9.8,"NM",4,0)
PSDRWK^^0^B21554388
"BLD",7003,"KRN",9.8,"NM",5,0)
PSDDWK^^0^B27257518
"BLD",7003,"KRN",9.8,"NM",6,0)
PSDPDR^^0^B18434161
"BLD",7003,"KRN",9.8,"NM",7,0)
PSDPGS^^0^B22028447
"BLD",7003,"KRN",9.8,"NM",8,0)
PSDRDR^^0^B24114664
"BLD",7003,"KRN",9.8,"NM",9,0)
PSDLBLR^^0^B13648116
"BLD",7003,"KRN",9.8,"NM",10,0)
PSDRPGS^^0^B12664820
"BLD",7003,"KRN",9.8,"NM",11,0)
PSDRPT^^0^B24521534
"BLD",7003,"KRN",9.8,"NM",13,0)
PSDLBL^^0^B22561219
"BLD",7003,"KRN",9.8,"NM",14,0)
PSDNDES^^0^B21712676
"BLD",7003,"KRN",9.8,"NM",15,0)
PSDESTO^^0^B23866051
"BLD",7003,"KRN",9.8,"NM",16,0)
PSDESTF^^0^B20769006
"BLD",7003,"KRN",9.8,"NM",18,0)
PSDORN^^0^B33160894
"BLD",7003,"KRN",9.8,"NM",19,0)
PSDREPD^^0^B35512558
"BLD",7003,"KRN",9.8,"NM",20,0)
PSDDFP^^0^B22828798
"BLD",7003,"KRN",9.8,"NM","B","PSDDFP",20)

"BLD",7003,"KRN",9.8,"NM","B","PSDDWK",5)

"BLD",7003,"KRN",9.8,"NM","B","PSDESTF",16)

"BLD",7003,"KRN",9.8,"NM","B","PSDESTO",15)

"BLD",7003,"KRN",9.8,"NM","B","PSDLBL",13)

"BLD",7003,"KRN",9.8,"NM","B","PSDLBLR",9)

"BLD",7003,"KRN",9.8,"NM","B","PSDNDES",14)

"BLD",7003,"KRN",9.8,"NM","B","PSDOPT",1)

"BLD",7003,"KRN",9.8,"NM","B","PSDORN",18)

"BLD",7003,"KRN",9.8,"NM","B","PSDPDR",6)

"BLD",7003,"KRN",9.8,"NM","B","PSDPGS",7)

"BLD",7003,"KRN",9.8,"NM","B","PSDPWK",3)

"BLD",7003,"KRN",9.8,"NM","B","PSDRDR",8)

"BLD",7003,"KRN",9.8,"NM","B","PSDREC",2)

"BLD",7003,"KRN",9.8,"NM","B","PSDREPD",19)

"BLD",7003,"KRN",9.8,"NM","B","PSDRPGS",10)

"BLD",7003,"KRN",9.8,"NM","B","PSDRPT",11)

"BLD",7003,"KRN",9.8,"NM","B","PSDRWK",4)

"BLD",7003,"KRN",19,0)
19
"BLD",7003,"KRN",19,"NM",0)
^9.68A^6^6
"BLD",7003,"KRN",19,"NM",1,0)
PSD PHARM TECH^^2
"BLD",7003,"KRN",19,"NM",2,0)
PSD RECEIPTS MENU^^3
"BLD",7003,"KRN",19,"NM",3,0)
PSD DISPENSING MENU^^3
"BLD",7003,"KRN",19,"NM",4,0)
PSD DESTROY MENU^^3
"BLD",7003,"KRN",19,"NM",5,0)
PSD MFG/LOT/EXP DATE EDIT^^4^
"BLD",7003,"KRN",19,"NM",6,0)
PSD OUTPATIENT^^4^
"BLD",7003,"KRN",19,"NM","B","PSD DESTROY MENU",4)

"BLD",7003,"KRN",19,"NM","B","PSD DISPENSING MENU",3)

"BLD",7003,"KRN",19,"NM","B","PSD MFG/LOT/EXP DATE EDIT",5)

"BLD",7003,"KRN",19,"NM","B","PSD OUTPATIENT",6)

"BLD",7003,"KRN",19,"NM","B","PSD PHARM TECH",1)

"BLD",7003,"KRN",19,"NM","B","PSD RECEIPTS MENU",2)

"BLD",7003,"KRN",19.1,0)
19.1
"BLD",7003,"KRN",19.1,"NM",0)
^9.68A^1^1
"BLD",7003,"KRN",19.1,"NM",1,0)
PSD TECH ADV^^0
"BLD",7003,"KRN",19.1,"NM","B","PSD TECH ADV",1)

"BLD",7003,"KRN",101,0)
101
"BLD",7003,"KRN",409.61,0)
409.61
"BLD",7003,"KRN",771,0)
771
"BLD",7003,"KRN",779.2,0)
779.2
"BLD",7003,"KRN",870,0)
870
"BLD",7003,"KRN",8989.51,0)
8989.51
"BLD",7003,"KRN",8989.52,0)
8989.52
"BLD",7003,"KRN",8994,0)
8994
"BLD",7003,"KRN","B",.4,.4)

"BLD",7003,"KRN","B",.401,.401)

"BLD",7003,"KRN","B",.402,.402)

"BLD",7003,"KRN","B",.403,.403)

"BLD",7003,"KRN","B",.5,.5)

"BLD",7003,"KRN","B",.84,.84)

"BLD",7003,"KRN","B",3.6,3.6)

"BLD",7003,"KRN","B",3.8,3.8)

"BLD",7003,"KRN","B",9.2,9.2)

"BLD",7003,"KRN","B",9.8,9.8)

"BLD",7003,"KRN","B",19,19)

"BLD",7003,"KRN","B",19.1,19.1)

"BLD",7003,"KRN","B",101,101)

"BLD",7003,"KRN","B",409.61,409.61)

"BLD",7003,"KRN","B",771,771)

"BLD",7003,"KRN","B",779.2,779.2)

"BLD",7003,"KRN","B",870,870)

"BLD",7003,"KRN","B",8989.51,8989.51)

"BLD",7003,"KRN","B",8989.52,8989.52)

"BLD",7003,"KRN","B",8994,8994)

"BLD",7003,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7003,"QUES",0)
^9.62^^
"BLD",7003,"REQB",0)
^9.611^3^3
"BLD",7003,"REQB",1,0)
PSD*3.0*59^2
"BLD",7003,"REQB",2,0)
PSD*3.0*62^2
"BLD",7003,"REQB",3,0)
PSD*3.0*66^2
"BLD",7003,"REQB","B","PSD*3.0*59",1)

"BLD",7003,"REQB","B","PSD*3.0*62",2)

"BLD",7003,"REQB","B","PSD*3.0*66",3)

"KRN",19,6695,-1)
4^5
"KRN",19,6695,0)
PSD MFG/LOT/EXP DATE EDIT
"KRN",19,6726,-1)
2^1
"KRN",19,6726,0)
PSD PHARM TECH^Technician (CS Pharmacy) Menu^^M^11595^^^^^^^276
"KRN",19,6726,10,0)
^19.01IP^38^16
"KRN",19,6726,10,14,0)
6756^^22
"KRN",19,6726,10,14,"^")
PSD RECEIPTS MENU
"KRN",19,6726,10,32,0)
6748^^30
"KRN",19,6726,10,32,"^")
PSD OUTPATIENT
"KRN",19,6726,10,36,0)
6729^^24
"KRN",19,6726,10,36,"^")
PSD DISPENSING MENU
"KRN",19,6726,10,37,0)
8537^^26
"KRN",19,6726,10,37,"^")
PSD DESTROY MENU
"KRN",19,6726,10,38,0)
6695^^28
"KRN",19,6726,10,38,"^")
PSD MFG/LOT/EXP DATE EDIT
"KRN",19,6726,"U")
TECHNICIAN (CS PHARMACY) MENU
"KRN",19,6729,-1)
3^3
"KRN",19,6729,0)
PSD DISPENSING MENU^Dispensing Menu^^M^^^^^^^^CONTROLLED SUBSTANCES
"KRN",19,6729,1,0)
^^2^2^2961001^^^^
"KRN",19,6729,1,1,0)
This menu contains access to all options associated with the dispensing
"KRN",19,6729,1,2,0)
of Controlled Substances.
"KRN",19,6729,10,0)
^19.01PI^9^9
"KRN",19,6729,25)

"KRN",19,6729,99)
61782,41382
"KRN",19,6729,"U")
DISPENSING MENU
"KRN",19,6748,-1)
4^6
"KRN",19,6748,0)
PSD OUTPATIENT
"KRN",19,6756,-1)
3^2
"KRN",19,6756,0)
PSD RECEIPTS MENU^Receipts Into Pharmacy^^M^^^^^^^^CONTROLLED SUBSTANCES
"KRN",19,6756,1,0)
^19.06^2^2^3091207^^^^
"KRN",19,6756,1,1,0)
Use this option to process receipts for purchase orders, control point
"KRN",19,6756,1,2,0)
transactions, and Prime Vendors.
"KRN",19,6756,10,0)
^19.01IP^5^5
"KRN",19,6756,25)

"KRN",19,6756,99)
57098,44184
"KRN",19,6756,"U")
RECEIPTS INTO PHARMACY
"KRN",19,8537,-1)
3^4
"KRN",19,8537,0)
PSD DESTROY MENU^Destructions Menu^^M^^^^^^^^CONTROLLED SUBSTANCES
"KRN",19,8537,1,0)
^19.06^2^2^3100127^^^
"KRN",19,8537,1,1,0)
This menu allows pharmacy supervisors to maintain the necessary records
"KRN",19,8537,1,2,0)
when destroying a Controlled Substances drug.
"KRN",19,8537,10,0)
^19.01IP^3^3
"KRN",19,8537,99)
57098,44184
"KRN",19,8537,"U")
DESTRUCTIONS MENU
"KRN",19.1,555,-1)
0^1
"KRN",19.1,555,0)
PSD TECH ADV^Pharmacy Technician Advance
"KRN",19.1,555,1,0)
^19.11^5^5^3100112^^^^
"KRN",19.1,555,1,1,0)
This key will give access to a list of additional options on the Pharmacy 
"KRN",19.1,555,1,2,0)
Technician Menu. These added options are Receipts Into Pharmacy, Dispensing
"KRN",19.1,555,1,3,0)
Menu, Destructions Menu, Manufacturer, Lot #, and Exp. Date - Enter/Edit
"KRN",19.1,555,1,4,0)
and Outpatient Rx's. This key is assigned to specific Controlled Substances 
"KRN",19.1,555,1,5,0)
technicians.
"MBREQ")
0
"ORD",3,19.1)
19.1;3;;;KEY^XPDTA1;KEYF1^XPDIA1;KEYE1^XPDIA1;KEYF2^XPDIA1;;KEYDEL^XPDIA1
"ORD",3,19.1,0)
SECURITY KEY
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",276,-1)
1^1
"PKG",276,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",276,20,0)
^9.402P^^
"PKG",276,22,0)
^9.49I^1^1
"PKG",276,22,1,0)
3.0^2970213^2970430^11595
"PKG",276,22,1,"PAH",1,0)
69^3100413
"PKG",276,22,1,"PAH",1,1,0)
^^47^47^3100413
"PKG",276,22,1,"PAH",1,1,1,0)
The FY10 Q2 Enhancement Release includes the following.
"PKG",276,22,1,"PAH",1,1,2,0)
 
"PKG",276,22,1,"PAH",1,1,3,0)
Pharmacy Legacy Quarterly Enhancements (PLQE) subcommittee recommended the
"PKG",276,22,1,"PAH",1,1,4,0)
creation of a new security key named PSD TECH ADV that will allow
"PKG",276,22,1,"PAH",1,1,5,0)
Controlled Substances (CS) V. 3.0 package technicians to perform functions
"PKG",276,22,1,"PAH",1,1,6,0)
currently controlled by the pharmacist key and/or on the pharmacist menu.
"PKG",276,22,1,"PAH",1,1,7,0)
 
"PKG",276,22,1,"PAH",1,1,8,0)
This patch creates this new security key PSD TECH ADV, adds the following
"PKG",276,22,1,"PAH",1,1,9,0)
options from the pharmacist menu to the Technician (CS Pharmacy) Menu [PSD
"PKG",276,22,1,"PAH",1,1,10,0)
PHARM TECH], and allows the holders of this new key to perform these
"PKG",276,22,1,"PAH",1,1,11,0)
additional functions.
"PKG",276,22,1,"PAH",1,1,12,0)
 
"PKG",276,22,1,"PAH",1,1,13,0)
a. All options under the Receipts Into Pharmacy [PSD RECEIPTS MENU] menu.
"PKG",276,22,1,"PAH",1,1,14,0)
     Receiving [PSD RECEIVING]
"PKG",276,22,1,"PAH",1,1,15,0)
     Purchase Order Review [PSD PURCHASE ORDER REVIEW]
"PKG",276,22,1,"PAH",1,1,16,0)
     Control Point Transaction Review [PSD CP TRANSACTION REVIEW]
"PKG",276,22,1,"PAH",1,1,17,0)
     Drug Receipt History [PSD DRUG RECEIPT HISTORY]
"PKG",276,22,1,"PAH",1,1,18,0)
     Invoice Review (Prime Vendor) [PSD PV INVOICE REVIEW]
"PKG",276,22,1,"PAH",1,1,19,0)
 
"PKG",276,22,1,"PAH",1,1,20,0)
b. All options under the Dispensing Menu [PSD DISPENSING MENU].
"PKG",276,22,1,"PAH",1,1,21,0)
     Print CS Dispensing Worksheet [PSD WORKSHEET PRINT]
"PKG",276,22,1,"PAH",1,1,22,0)
     Fill/Dispense CS Orders from Worksheet [PSD WORKSHEET DISPENSING]
"PKG",276,22,1,"PAH",1,1,23,0)
     Dispensing/Receiving Report (VA FORM 10-2321) [PSD PRINT 2321]
"PKG",276,22,1,"PAH",1,1,24,0)
     Green Sheet - Print (VA FORM 10-2638) [PSD PRINT 2638]
"PKG",276,22,1,"PAH",1,1,25,0)
     Reprint Reports Menu [PSD REPRINT MENU] menu
"PKG",276,22,1,"PAH",1,1,26,0)
        Reprint Disp/Receiving Report (VA FORM 10-2321)
"PKG",276,22,1,"PAH",1,1,27,0)
        Green Sheet Reprint (VA FORM 10-2638)
"PKG",276,22,1,"PAH",1,1,28,0)
        Dispensing Worksheet Reprint
"PKG",276,22,1,"PAH",1,1,29,0)
        Label Reprint for Dispensing Drug
"PKG",276,22,1,"PAH",1,1,30,0)
        Reprint Transfer Between NAOUs (VA FORM 10-2321)
"PKG",276,22,1,"PAH",1,1,31,0)
     Pharmacy Dispense without (VA FORM 10-2638) [PSD DISPENSE W/O GS]
"PKG",276,22,1,"PAH",1,1,32,0)
     Label for Dispensing (Barcode) [PSD LABEL DRUG/NUMBER]
"PKG",276,22,1,"PAH",1,1,33,0)
     Narcotic Dispensing Equipment Orders [PSD DISPENSE TO NDES]
"PKG",276,22,1,"PAH",1,1,34,0)
 
"PKG",276,22,1,"PAH",1,1,35,0)
c. The following options under the Destructions Menu [PSD DESTROY MENU].
"PKG",276,22,1,"PAH",1,1,36,0)
     Hold a CS Drug (No Inventory Update) [PSD DEST NON-CS DRUG]
"PKG",276,22,1,"PAH",1,1,37,0)
     Non-VA Drug Placed on Hold for Destruction [PSD DEST TEXT DRUG]
"PKG",276,22,1,"PAH",1,1,38,0)
 
"PKG",276,22,1,"PAH",1,1,39,0)
d. The following options were also added to the Technician (CS Pharmacy)
"PKG",276,22,1,"PAH",1,1,40,0)
   Menu [PSD PHARM TECH].
"PKG",276,22,1,"PAH",1,1,41,0)
     Manufacturer, Lot #, and Exp. Date - Enter/Edit [PSD MFG/LOT/EXP DATE
"PKG",276,22,1,"PAH",1,1,42,0)
     EDIT]
"PKG",276,22,1,"PAH",1,1,43,0)
     Outpatient Rx's [PSD OUTPATIENT]
"PKG",276,22,1,"PAH",1,1,44,0)
 
"PKG",276,22,1,"PAH",1,1,45,0)
    Note: The CS technician will be allowed to perform all the
"PKG",276,22,1,"PAH",1,1,46,0)
          functionalities of the Outpatient Rx's [PSD OUTPATIENT] option
"PKG",276,22,1,"PAH",1,1,47,0)
          except the releasing of a prescription.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
18
"RTN","PSDDFP")
0^20^B22828798^B21804424
"RTN","PSDDFP",1,0)
PSDDFP ;BIR/JPW-Dispense from Pharmacy w/o Green Sheet ; 8 Aug 94
"RTN","PSDDFP",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**16,66,69**;13 Feb 97;Build 13
"RTN","PSDDFP",3,0)
 ;
"RTN","PSDDFP",4,0)
 ;References to ^PSD(58.8, supported by DBIA2711
"RTN","PSDDFP",5,0)
 ;References to ^PSD(58.81 supported by DBIA2808
"RTN","PSDDFP",6,0)
 ;References to ^PSDRUG( supported by DBIA #221
"RTN","PSDDFP",7,0)
 ;References to ^XUSEC("PSJ RPHARM" supported by DBIA #1095
"RTN","PSDDFP",8,0)
 ;
"RTN","PSDDFP",9,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDDFP",10,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)),'$D(^XUSEC("PSD TECH ADV",DUZ)) W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"dispense narcotic supplies.",!!,"PSJ RPHARM or PSD TECH ADV security key required.",! Q
"RTN","PSDDFP",11,0)
 S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDDFP",12,0)
ASKD ;ask disp loc
"RTN","PSDDFP",13,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDDFP",14,0)
 I $P(PSDSITE,U,5) S ASK=$P($G(^PSD(58.8,+PSDS,0)),U,5) G CHKD
"RTN","PSDDFP",15,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDDFP",16,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDDFP",17,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDDFP",18,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),ASK=$P(Y(0),"^",5)
"RTN","PSDDFP",19,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDDFP",20,0)
CHKD I '$O(^PSD(58.8,PSDS,1,0)) W !!,"There are no stocked drugs for this Pharmacy Vault!!",!! G END
"RTN","PSDDFP",21,0)
DRUG ;select drug
"RTN","PSDDFP",22,0)
 S PSDOUT=0 W !
"RTN","PSDDFP",23,0)
 K DA,DIC S DIC("W")="W:$P(^PSDRUG(Y,0),""^"",9) ""   N/F"" I $P(^PSD(58.8,PSDS,1,Y,0),""^"",14)]"""",$P(^(0),""^"",14)'>DT W $C(7),""   *** INACTIVE ***"""
"RTN","PSDDFP",24,0)
 S DIC("S")="I '$P($G(^(7)),U,2)"
"RTN","PSDDFP",25,0)
 S DA(1)=+PSDS,DIC(0)="QEAMZ",DIC="^PSD(58.8,"_PSDS_",1," D ^DIC K DIC G:Y<0 END S PSDR=+Y,PSDRN=$P($G(^PSDRUG(+PSDR,0)),"^")
"RTN","PSDDFP",26,0)
 I '$D(^PSD(58.8,+PSDS,1,+PSDR,0)) W $C(7),!!,?10,"** Your Dispensing Site is missing stock drug data.",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDDFP",27,0)
 S (MFG,LOT,EXP,EXPD,NBKU,NPKG)="",MFG=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",10),LOT=$P(^(0),"^",11),EXP=$P(^(0),"^",12),NBKU=$P(^(0),"^",8),NPKG=$P(^(0),"^",9)
"RTN","PSDDFP",28,0)
 I 'NPKG!(NBKU']"") W $C(7),!!,PSDRN," is missing breakdown unit or",!,"package size data in ",PSDSN,"." D MSG G END
"RTN","PSDDFP",29,0)
 I EXP S Y=EXP X ^DD("DD") S EXPD=Y
"RTN","PSDDFP",30,0)
 ;
"RTN","PSDDFP",31,0)
 ;DAVE B (PSD*3*16 - 28APR99) Move lock of 58.8,loc,1,drg up.
"RTN","PSDDFP",32,0)
 F  L +^PSD(58.8,+PSDS,1,+PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDFP",33,0)
 S NBKU=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",8),NPKG=+$P(^(0),"^",9)
"RTN","PSDDFP",34,0)
 I NBKU']"" W !!,PSDSN,"is missing narcotic breakdown unit",!,"for ",PSDRN,"." G END
"RTN","PSDDFP",35,0)
 I 'NPKG W !!,PSDSN,"is missing narcotic package size",!,"for ",PSDRN,"." G END
"RTN","PSDDFP",36,0)
NAOU ;select NAOU
"RTN","PSDDFP",37,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select NAOU: "
"RTN","PSDDFP",38,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"""
"RTN","PSDDFP",39,0)
 D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDDFP",40,0)
QTY K DA,DIR,DIRUT S DIR(0)="58.85,18O",DIR("B")=NPKG,DIR("A")="QUANTITY DISPENSED ("_NBKU_"/"_NPKG_")" D ^DIR K DIR I 'Y!$D(DIRUT) D MSG G END
"RTN","PSDDFP",41,0)
 S QTY=+Y I QTY>+$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4) W !!,"The drug balance for this drug is ",+$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4),".",!,"You cannot dispense ",QTY," for this drug.",!! G END
"RTN","PSDDFP",42,0)
ASKM I ASK D MFG I PSDOUT D MSG G END
"RTN","PSDDFP",43,0)
OK W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK? ",DIR("?",1)="Answer 'YES' to record dispensing this drug,"
"RTN","PSDDFP",44,0)
 S DIR("?")="NO to select another drug or '^' to quit." D ^DIR K DIR
"RTN","PSDDFP",45,0)
 I $D(DIRUT) D MSG G END
"RTN","PSDDFP",46,0)
 I 'Y D MSG G DRUG
"RTN","PSDDFP",47,0)
 D ^PSDDFP1 G:'PSDOUT DRUG
"RTN","PSDDFP",48,0)
END K %,%DT,%H,%I,ASK,BAL,DA,DIC,DIE,DIK,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EDIT,EXP,EXPD,LOT,MFG,NAOU,NAOUN,NBKU,NPKG,OK
"RTN","PSDDFP",49,0)
 K PSDDT,PSDLES,PSDOUT,PSDREC,PSDRN,PSDSN,PSDUZ,PSDUZN,QTY,TEXP,TLOT,TMFG,X,Y
"RTN","PSDDFP",50,0)
 I $D(PSDS),$D(PSDR) L -^PSD(58.8,+PSDS,1,+PSDR)
"RTN","PSDDFP",51,0)
 K PSDS,PSDR
"RTN","PSDDFP",52,0)
 Q
"RTN","PSDDFP",53,0)
MFG K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,12O",DIR("B")=MFG D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDDFP",54,0)
 I Y]"",Y'=MFG S MFG=Y S $P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",10)=MFG
"RTN","PSDDFP",55,0)
 K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,13O",DIR("B")=LOT D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDDFP",56,0)
 I Y]"",Y'=LOT S LOT=Y S $P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",11)=LOT
"RTN","PSDDFP",57,0)
 K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,14O",DIR("B")=EXPD D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDDFP",58,0)
 I Y,Y'=EXP S EXP=Y W !!,"Updating Expiration Date data..." K DA,DIE,DR S DA=+PSDR,DA(1)=+PSDS,DIE="^PSD(58.8,"_DA(1)_",1,",DR="11///"_EXP D ^DIE K DA,DIE,DR W "done.",!!
"RTN","PSDDFP",59,0)
 Q
"RTN","PSDDFP",60,0)
MSG W !!,"** No action taken. **",!!
"RTN","PSDDFP",61,0)
 Q
"RTN","PSDDWK")
0^5^B27257518^B25989170
"RTN","PSDDWK",1,0)
PSDDWK ;BIR/JPW-Pharm Dispensing Worksheet ;6 July 94
"RTN","PSDDWK",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**59,69**;13 Feb 97;Build 13
"RTN","PSDDWK",3,0)
 ;References to ^PSD(58.8, supported by DBIA2711
"RTN","PSDDWK",4,0)
 ;References to ^PSDRUG( supported by DBIA #221
"RTN","PSDDWK",5,0)
 ;
"RTN","PSDDWK",6,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDDWK",7,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDDWK",8,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"process/dispense narcotic supplies.",!!,"PSJ RPHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDDWK",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH Q
"RTN","PSDDWK",10,0)
 I '$O(^PSD(58.85,0)) W $C(7),!!,"There are no pending request orders.",!! Q
"RTN","PSDDWK",11,0)
 S (PSDNO,NOFLAG)=0
"RTN","PSDDWK",12,0)
ASKD ;ask dispensing location
"RTN","PSDDWK",13,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDDWK",14,0)
 I $P(PSDSITE,U,5) S OKD=1,NODED=^PSD(58.8,+PSDS,0) G SETD
"RTN","PSDDWK",15,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)=""M"":1,$P(^(0),""^"",2)=""S"":1,1:0)"
"RTN","PSDDWK",16,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDDWK",17,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDDWK",18,0)
 ;set PSDS=disp.site,PSDM=ask mfg/lot#/exp.date,SITE=inpat.site,PSDAG=auto gen.disp.#s,PSDRG=using form 10-179,PSDGS=print green sheet
"RTN","PSDDWK",19,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),NODED=Y(0)
"RTN","PSDDWK",20,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDDWK",21,0)
SETD S PSDM=+$P(NODED,"^",5),PSDAG=+$P($G(^PSD(58.8,+PSDS,2)),"^")
"RTN","PSDDWK",22,0)
 S PSDRG=+$P($G(^PSD(58.8,+PSDS,2)),"^",5),PSDGS=+$P($G(^PSD(58.8,+PSDS,2)),"^",6)
"RTN","PSDDWK",23,0)
 I '$D(^PSD(58.85,"AW",+PSDS)) D MSG G END
"RTN","PSDDWK",24,0)
ASKM ;ask method of dispensing - by worksheet or individual request
"RTN","PSDDWK",25,0)
 K DA,DIR,DIRUT S DIR(0)="SOB^W:Worksheet;R:Individual Request",DIR("A")="Dispensing Method"
"RTN","PSDDWK",26,0)
 S DIR("?",1)="Enter 'W' to dispense by last worksheet printed, enter 'R' to",DIR("?")="dispense by individual request, or '^' to quit"
"RTN","PSDDWK",27,0)
 D ^DIR K DIR G:$D(DIRUT) END S ANS=Y
"RTN","PSDDWK",28,0)
 S PSDOUT=0 N X,X1 D SIG^XUSESIG G:X1="" END D:ANS="R" REQ D:ANS="W" WK
"RTN","PSDDWK",29,0)
 I 'NOFLAG D MSG
"RTN","PSDDWK",30,0)
END K %,%H,%I,%ZIS,ACT,ALL,ANS,BAL,CNT,COMM,DA,DIC,DIE,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,EXP,EXPD,FLAG
"RTN","PSDDWK",31,0)
 K LN,LOOP,LOT,MFG,MSG,NAOU,NAOUN,NBKU,NEW,NODE,NODED,NOFLAG,NPKG,NSITE,OK,OKD,ORD,ORDN,ORDS,ORDSN,PAT,PSDLCK
"RTN","PSDDWK",32,0)
 K PRT,PSD,PSDAG,PSDAGN,PSDBY,PSDBYN,PSDDT,PSDG,PSDGS,PSDGSN,PSDIO,PSDLES,PSDM,PSDMN,PSDN,PSDNA,PSDNO,PSDOUT,PSDPN
"RTN","PSDDWK",33,0)
 K PSDR,PSDRN,PSDREC,PSDRG,PSDRGN,PSDRN,PSDS,PSDSN,PSDT,PSDUZA,QTY,REQ,REQD,REQDT,SITE,STAT,TECH,TEXT,WORD,X,Y
"RTN","PSDDWK",34,0)
 Q
"RTN","PSDDWK",35,0)
WK ;compile worksheet dispensing data
"RTN","PSDDWK",36,0)
 W !!,"Accessing worksheet information..."
"RTN","PSDDWK",37,0)
 F PSD=0:0 S PSD=$O(^PSD(58.85,"AW",+PSDS,PSD)) Q:('PSD)!(PSDOUT)  D
"RTN","PSDDWK",38,0)
 .F PSDN=0:0 S PSDN=$O(^PSD(58.85,"AW",+PSDS,PSD,PSDN)) Q:('PSDN)!(PSDOUT)  I $D(^PSD(58.85,PSDN,0)) D SET Q:PSDLCK  D:STAT<3&($D(^PSD(58.8,+$G(ORDS),1,+$G(PSDR)))) ^PSDDWK1,PSDLCK Q:PSDOUT  ;; PSD*3*59 ADDED PSDLCK
"RTN","PSDDWK",39,0)
 Q
"RTN","PSDDWK",40,0)
REQ ;dispense by individual request
"RTN","PSDDWK",41,0)
 W !!,"Accessing worksheet information..."
"RTN","PSDDWK",42,0)
 F PSD=0:0 S PSD=$O(^PSD(58.85,"AW",+PSDS,PSD)) Q:'PSD  F PSDN=0:0 S PSDN=$O(^PSD(58.85,"AW",+PSDS,PSD,PSDN)) Q:'PSDN  I $D(^PSD(58.85,PSDN,0)),$P(^(0),"^",7)<3 S NOFLAG=1
"RTN","PSDDWK",43,0)
 Q:'NOFLAG
"RTN","PSDDWK",44,0)
 K DA,DIC W ! S DIC=58.85,DIC(0)="QEA",DIC("A")="Select Request #: ",DIC("S")="I $P(^(0),""^"",2)=+PSDS,$P(^(0),""^"",7)<3" D ^DIC K DIC Q:Y<0  S PSDN=+Y D SET
"RTN","PSDDWK",45,0)
 I PSDLCK W !!,"This request is currently being processed by ",$P(^VA(200,$P(^XTMP("PSDLCK",PSDN,0),"^",3),0),"^") G REQ  ;; PSD*3*59 LOCK MESSAGE
"RTN","PSDDWK",46,0)
 I STAT>2 W !!,"The status of this request is "_$P($G(^PSD(58.82,STAT,0)),"^")_".",!,"You cannot edit this request using this option.",! G REQ
"RTN","PSDDWK",47,0)
 D ^PSDDWK1,PSDLCK Q:PSDOUT  ;; PSD*3*59 ADDED PSDLCK
"RTN","PSDDWK",48,0)
 G REQ
"RTN","PSDDWK",49,0)
SET ;sets data for display/editing
"RTN","PSDDWK",50,0)
 Q:'$D(^PSD(58.85,PSDN,0))  S NODE=^(0),(NSITE,PSDMN,PSDAGN,PSDRGN,PSDGSN)=0
"RTN","PSDDWK",51,0)
 ;; PSD*3*59  LOCK RECORD
"RTN","PSDDWK",52,0)
 S PSDLCK=0
"RTN","PSDDWK",53,0)
 S STAT=+$P(NODE,"^",7) Q:STAT>2  S PSDRN=+$P(NODE,"^",5)
"RTN","PSDDWK",54,0)
 L +^PSD(58.85,PSDN):0
"RTN","PSDDWK",55,0)
 S:'$T PSDLCK=1 Q:PSDLCK
"RTN","PSDDWK",56,0)
 S ^XTMP("PSDLCK",PSDN,0)=$$FMADD^XLFDT(DT,1,0,0,0)_"^"_DT_"^"_DUZ ;; END PSD*3*59
"RTN","PSDDWK",57,0)
 S NAOU=+$P(NODE,"^",3),NAOUN=$S($P($G(^PSD(58.8,NAOU,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_NAOU)
"RTN","PSDDWK",58,0)
 S PSDR=+$P(NODE,"^",4),PSDRN=$S($P($G(^PSDRUG(PSDR,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_PSDR)
"RTN","PSDDWK",59,0)
 S ORDS=+$P(NODE,"^",2),ORDSN=$P($G(^PSD(58.8,+ORDS,0)),"^")
"RTN","PSDDWK",60,0)
 S PSDUZA=+$P(NODE,"^",19)
"RTN","PSDDWK",61,0)
 S REQ=+$P(NODE,"^",5),REQDT=$P(NODE,"^",18) I REQDT S Y=$E(REQDT,1,7) X ^DD("DD") S REQD=Y
"RTN","PSDDWK",62,0)
 S QTY=$S($P(NODE,"^",17):$P(NODE,"^",17),1:$P(NODE,"^",6)),PSDPN=$P(NODE,"^",15),PSDT=$P(NODE,"^",14) I PSDT S Y=$E(PSDT,1,7) X ^DD("DD") S PSDDT=Y
"RTN","PSDDWK",63,0)
 S ORD=+$P(NODE,"^",12),ORDN=$P($G(^VA(200,+ORD,0)),"^"),PSDBY=+$P(NODE,"^",13),PSDBYN="" I PSDBY S PSDBYN=$P($G(^VA(200,PSDBY,0)),"^")
"RTN","PSDDWK",64,0)
 S PAT=$P($G(^PSD(58.85,PSDN,2)),U,3)
"RTN","PSDDWK",65,0)
 I $D(^XUSEC("PSJ RPHARM",DUZ)),'PSDBY S PSDBY=DUZ,PSDBYN=$P($G(^VA(200,PSDBY,0)),"^")
"RTN","PSDDWK",66,0)
 S (MFG,LOT,EXP,EXPD,NBKU,NPKG)=""
"RTN","PSDDWK",67,0)
 I $D(^PSD(58.8,+ORDS,1,PSDR,0)) S MFG=$P(^(0),"^",10),LOT=$P(^(0),"^",11),EXP=$P(^(0),"^",12),NBKU=$P(^(0),"^",8),NPKG=+$P(^(0),"^",9) I EXP S Y=EXP X ^DD("DD") S EXPD=Y
"RTN","PSDDWK",68,0)
 Q
"RTN","PSDDWK",69,0)
MSG W $C(7),!!,"There are no pending CS requests for ",PSDSN,".",!
"RTN","PSDDWK",70,0)
 W !,"Press <RET> to return to the menu" R X:DTIME W !!
"RTN","PSDDWK",71,0)
 Q
"RTN","PSDDWK",72,0)
PSDLCK ;; PSD*3*59 CLEAR LOCKS FOR THIS ORDER
"RTN","PSDDWK",73,0)
 L -^PSD(58.85,PSDN)
"RTN","PSDDWK",74,0)
 K ^XTMP("PSDLCK",PSDN),STAT
"RTN","PSDDWK",75,0)
 Q
"RTN","PSDESTF")
0^16^B20769006^B19562723
"RTN","PSDESTF",1,0)
PSDESTF ;BIR/BJW-Add Non-CS Drug to Holding file ; 26 Feb 98
"RTN","PSDESTF",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,66,69**;13 Feb 97;Build 13
"RTN","PSDESTF",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDESTF",4,0)
 ;References to ^PSD(58.86, supported by DBIA4472
"RTN","PSDESTF",5,0)
 ;
"RTN","PSDESTF",6,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDESTF",7,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)),'$D(^XUSEC("PSD TECH ADV",DUZ)) W !!,"Please contact your Pharmacy Coordinator for access to",!,"destroy Controlled Substances.",!!,"PSJ RPHARM or PSD TECH ADV security key required.",! G END
"RTN","PSDESTF",8,0)
 S PSDUZ=DUZ,PSDOUT=0 D NOW^%DTC S PSDT=+$E(%,1,12)
"RTN","PSDESTF",9,0)
 W !!,?5,"NOTE: This Holding for Destruction transaction WILL NOT update your",!,?5,"Controlled Substances inventory balance.",!!
"RTN","PSDESTF",10,0)
ASKD ;ask disp location
"RTN","PSDESTF",11,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4) G:$P(PSDSITE,U,5) DEST
"RTN","PSDESTF",12,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDESTF",13,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDESTF",14,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDESTF",15,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDESTF",16,0)
DEST ;set up file 58.86
"RTN","PSDESTF",17,0)
 S PSDOUT=0,PSDCT=1
"RTN","PSDESTF",18,0)
 S (MFG,LOT,EXP)=""
"RTN","PSDESTF",19,0)
DIR ;ask free-text drug name
"RTN","PSDESTF",20,0)
 W !!,"You may create a free-text CS drug to place on hold for destruction.",!,"Your Dispensing Site inventory balance WILL NOT be updated.",!!
"RTN","PSDESTF",21,0)
 K DA,DIR,DIRUT S DIR(0)="58.86,13" D ^DIR K DA,DIR
"RTN","PSDESTF",22,0)
 I $D(DIRUT) D MSG G END
"RTN","PSDESTF",23,0)
 I Y']"" D MSG G END
"RTN","PSDESTF",24,0)
 S PSDRN=Y
"RTN","PSDESTF",25,0)
DIR2 K DA,DIR,DIRUT,DTOUT,DUOUT F PSDANS=2,4,11,12,18 S DIR(0)="58.86,"_PSDANS D ^DIR K DA,DIR D  I PSDOUT D MSG G END
"RTN","PSDESTF",26,0)
 .I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDESTF",27,0)
 .I PSDANS'=4,PSDANS'=18,Y']"" S PSDOUT=1 Q
"RTN","PSDESTF",28,0)
 .S PSD(PSDANS)=Y
"RTN","PSDESTF",29,0)
 .K DIRUT,DTOUT,DUOUT
"RTN","PSDESTF",30,0)
 ;DIR3 added 5/7/95 to add comments field
"RTN","PSDESTF",31,0)
DIR3 ;enter free-text information(comments)
"RTN","PSDESTF",32,0)
 W !!,"You may enter free-text info regarding drug placed on hold for destruction."
"RTN","PSDESTF",33,0)
 K DA,DIR,DIRUT S DIR(0)="58.86,14" D ^DIR K DA,DIR
"RTN","PSDESTF",34,0)
 I $D(DTOUT)!($D(DUOUT)) D MSG G END
"RTN","PSDESTF",35,0)
 S PSDCOMS=Y
"RTN","PSDESTF",36,0)
ASKY ;ask ok to continue
"RTN","PSDESTF",37,0)
 W !!,PSDRN," has been selected.",!
"RTN","PSDESTF",38,0)
 K DA,DIR,DIRUT S DIR(0)="YA",DIR("B")="NO",DIR("A")="Is this OK to create Holding for Destructions number? "
"RTN","PSDESTF",39,0)
 S DIR("?",1)="Answer 'YES' to create a Holding for Destruction number for this drug,",DIR("?")="answer 'NO' to create a different free-text CS drug, or '^' to quit."
"RTN","PSDESTF",40,0)
 D ^DIR K DIR I $D(DIRUT) D MSG G END
"RTN","PSDESTF",41,0)
 I 'Y G DIR
"RTN","PSDESTF",42,0)
 W !!,"Creating an entry in the Destructions file..."
"RTN","PSDESTF",43,0)
 F  L +^PSD(58.86,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDESTF",44,0)
 ;5/7/95 Fld 14 added, 7/28/95 Fld 18 added
"RTN","PSDESTF",45,0)
FIND S PSDHLD=$P(^PSD(58.86,0),"^",3)+1 I $D(^PSD(58.86,PSDHLD)) S $P(^PSD(58.86,0),"^",3)=PSDHLD G FIND
"RTN","PSDESTF",46,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.86,DIC(0)="L",(X,DINUM)=PSDHLD D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSDESTF",47,0)
 L -^PSD(58.86,0)
"RTN","PSDESTF",48,0)
 W !!,"Your Destructions Holding number is ",PSDHLD
"RTN","PSDESTF",49,0)
 K DA,DIE,DR S DIE=58.86,DA=PSDHLD,DR="13////"_PSDRN_";2////"_PSD(2)_";3////"_PSDUZ_";5////"_PSDT_";6////"_PSDS_";4////"_$S(+PSD(4):+PSD(4),1:"")_";11////"_+PSD(11)_";12////"_PSD(12)_";14////"_PSDCOMS_";18////"_+PSD(18)
"RTN","PSDESTF",50,0)
 D ^DIE K DIE,DA,DR
"RTN","PSDESTF",51,0)
 S RQTY=$P($G(^PSD(58.86,PSDHLD,0)),"^",3),PSDRN=$P($G(^(1)),"^")
"RTN","PSDESTF",52,0)
 S PSDOK=1
"RTN","PSDESTF",53,0)
PRINT ;print 2321
"RTN","PSDESTF",54,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDESTF",55,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDESTF",56,0)
 S Y=PSDT X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDESTF",57,0)
 S PG=0,RECDT=$E(PSDT,4,5)_"/"_$E(PSDT,6,7)_"/"_PSDYR I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3)
"RTN","PSDESTF",58,0)
 D ^PSDGSRV2
"RTN","PSDESTF",59,0)
END ;kill variables
"RTN","PSDESTF",60,0)
 K %,%DT,%H,%I,ALL,CNT,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LN,LOT,MFG,NUM
"RTN","PSDESTF",61,0)
 K PG,PSD,PSDANS,PSDCT,PSDCOMS,PSDHLD,PSDOK,PSDOUT,PSDRN,PSDS,PSDSN,PSDT,PSDUZ,PSDYR,RECDT,RPDT,RQTY,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDESTF",62,0)
 Q
"RTN","PSDESTF",63,0)
MSG W $C(7),!!,"WARNING: Holding for Destructions entry HAS NOT been created.",!!
"RTN","PSDESTF",64,0)
 Q
"RTN","PSDESTO")
0^15^B23866051^B22602014
"RTN","PSDESTO",1,0)
PSDESTO ;BIR/BJW-Add CS Non-Inv Drug to Holding file ; 28 Feb 98
"RTN","PSDESTO",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,32,66,69**;13 Feb 97;Build 13
"RTN","PSDESTO",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDESTO",4,0)
 ;References to ^PSD(58.86, supported by DBIA4472
"RTN","PSDESTO",5,0)
 ;
"RTN","PSDESTO",6,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDESTO",7,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)),'$D(^XUSEC("PSD TECH ADV",DUZ)) W !!,"Please contact your Pharmacy Coordinator for access to",!,"destroy Controlled Substances.",!!,"PSJ RPHARM or PSD TECH ADV security key required.",! G END
"RTN","PSDESTO",8,0)
 S PSDUZ=DUZ D NOW^%DTC S PSDT=+$E(%,1,12)
"RTN","PSDESTO",9,0)
 W !!,?5,"NOTE: This Holding for Destruction transaction WILL NOT update your",!,?5,"Controlled Substances inventory balance.",!!
"RTN","PSDESTO",10,0)
ASKD ;ask disp location
"RTN","PSDESTO",11,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4) G:$P(PSDSITE,U,5) DRUG
"RTN","PSDESTO",12,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDESTO",13,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDESTO",14,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDESTO",15,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDESTO",16,0)
DRUG ;ask non-inv CS drug
"RTN","PSDESTO",17,0)
 W !!,"You may select a Controlled Substances drug to place on hold for destruction.",!,"Your Dispensing Site inventory balance WILL NOT be updated.",!!
"RTN","PSDESTO",18,0)
 K DA,DIC S DIC("A")="Select DRUG: ",DIC=50,DIC(0)="QEAM",DIC("S")="I $S('$D(^(""I"")):1,+^(""I"")>DT:1,1:0),$P($G(^(2)),""^"",3)[""N""" D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT)) END I Y<0 G RPTCPY
"RTN","PSDESTO",19,0)
 S PSDR=+Y,PSDRN=$P(Y,"^",2)
"RTN","PSDESTO",20,0)
DEST ;set up file 58.86
"RTN","PSDESTO",21,0)
 S PSDOUT=0,PSDCT=1
"RTN","PSDESTO",22,0)
 S (MFG,LOT,EXP)=""
"RTN","PSDESTO",23,0)
 ;7/27/95 Field 18 added, to prompt for patient name returning drugs.
"RTN","PSDESTO",24,0)
DIR2 K DA,DIR,DIRUT,DTOUT,DUOUT,PSD,PSDANS F PSDANS=2,4,11,12,18 S DIR(0)="58.86,"_PSDANS D ^DIR K DA,DIR D  I PSDOUT D MSG G END
"RTN","PSDESTO",25,0)
 .I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDESTO",26,0)
 .I PSDANS'=4,PSDANS'=18,Y']"" S PSDOUT=1 Q
"RTN","PSDESTO",27,0)
 .S PSD(PSDANS)=Y
"RTN","PSDESTO",28,0)
 .K DIRUT,DTOUT,DUOUT
"RTN","PSDESTO",29,0)
 ;DIR was added for E3R# 3771
"RTN","PSDESTO",30,0)
DIR ;enter free-text information 
"RTN","PSDESTO",31,0)
 W !!,"You may enter free-text info regarding drug placed on hold for destruction."
"RTN","PSDESTO",32,0)
COM K DA,DIR,DIRUT S DIR(0)="58.86,14" D ^DIR K DA,DIR
"RTN","PSDESTO",33,0)
 I $D(DTOUT)!($D(DUOUT)) D MSG G END
"RTN","PSDESTO",34,0)
 S PSDCOMS=Y
"RTN","PSDESTO",35,0)
 I PSDCOMS[";" W !,"A semicolon is not allowed in the COMMENTS field. Please edit your entry.",! G COM
"RTN","PSDESTO",36,0)
ASKY ;ask ok to continue
"RTN","PSDESTO",37,0)
 W !!,PSDRN," has been selected.",!
"RTN","PSDESTO",38,0)
 K DA,DIR,DIRUT S DIR(0)="YA",DIR("B")="NO",DIR("A")="Is this OK to create Holding for Destructions number? "
"RTN","PSDESTO",39,0)
 S DIR("?",1)="Answer 'YES' to create a Holding for Destruction number for this drug,",DIR("?")="answer 'NO' to select a different CS drug or '^' to quit."
"RTN","PSDESTO",40,0)
 D ^DIR K DIR I $D(DIRUT) D MSG G END
"RTN","PSDESTO",41,0)
 I 'Y W !!,"Select a new CS drug to place on hold for destruction",!! G DRUG
"RTN","PSDESTO",42,0)
 W !!,"Creating an entry in the Destructions file..."
"RTN","PSDESTO",43,0)
 F  L +^PSD(58.86,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDESTO",44,0)
 ;Field 14 added for E3R# 3771,Fld 18 added 7/27/95
"RTN","PSDESTO",45,0)
FIND S PSDHLD=$P(^PSD(58.86,0),"^",3)+1 I $D(^PSD(58.86,PSDHLD)) S $P(^PSD(58.86,0),"^",3)=PSDHLD G FIND
"RTN","PSDESTO",46,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.86,DIC(0)="L",(X,DINUM)=PSDHLD D ^DIC K DIC,DLAYGO
"RTN","PSDESTO",47,0)
 L -^PSD(58.86,0)
"RTN","PSDESTO",48,0)
 W !!,"Your Destructions Holding number is ",PSDHLD
"RTN","PSDESTO",49,0)
 K DA,DIE,DR S DIE=58.86,DA=PSDHLD,DR="1////"_PSDR_";2////"_PSD(2)_";3////"_PSDUZ_";5////"_PSDT_";6////"_PSDS_";4////"_$S(+PSD(4):+PSD(4),1:"")_";11////"_+PSD(11)_";12////"_PSD(12)_";14////"_PSDCOMS_";18////"_+PSD(18)
"RTN","PSDESTO",50,0)
 D ^DIE K DIE,DA,DR
"RTN","PSDESTO",51,0)
 S RQTY=+$P($G(^PSD(58.86,PSDHLD,0)),"^",3)
"RTN","PSDESTO",52,0)
 S PSDOK=1
"RTN","PSDESTO",53,0)
TEMPX ;build temp file added june 96
"RTN","PSDESTO",54,0)
 S Y=PSDT X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDESTO",55,0)
 S PG=0,RECDT=$E(PSDT,4,5)_"/"_$E(PSDT,6,7)_"/"_PSDYR I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3)
"RTN","PSDESTO",56,0)
 S ^TMP("PSDESTO",$J,PSDHLD)=PSDHLD_"^"_RECDT_"^"_PSDRN_"^"_RQTY_"^"_PSDCOMS G DRUG
"RTN","PSDESTO",57,0)
RPTCPY ;ask # of report copies
"RTN","PSDESTO",58,0)
 I '$G(PSDHLD) G END
"RTN","PSDESTO",59,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! G END
"RTN","PSDESTO",60,0)
 I $G(NUM) D ^PSDGSRV2 G END
"RTN","PSDESTO",61,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G RPTCPY
"RTN","PSDESTO",62,0)
END ;kill variables
"RTN","PSDESTO",63,0)
 K %,%DT,%H,%I,ALL,CNT,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LN,LOT,MFG,NUM
"RTN","PSDESTO",64,0)
 K PG,PSD,PSDANS,PSDCOMS,PSDCT,PSDHLD,PSDOK,PSDOUT,PSDR,PSDRN,PSDS,PSDSN,PSDT,PSDUZ,PSDYR,RECDT,RPDT,RQTY,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDESTO",65,0)
 K ^TMP("PSDESTO",$J)
"RTN","PSDESTO",66,0)
 Q
"RTN","PSDESTO",67,0)
MSG W $C(7),!!,"WARNING: Holding for Destructions entry HAS NOT been created.",!!
"RTN","PSDESTO",68,0)
 Q
"RTN","PSDLBL")
0^13^B22561219^B21663167
"RTN","PSDLBL",1,0)
PSDLBL ;BIR/JPW-CS Label Print for CS Disp Drug ; 5 Oct 94
"RTN","PSDLBL",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**69**;13 Feb 97;Build 13
"RTN","PSDLBL",3,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDLBL",4,0)
 ;
"RTN","PSDLBL",5,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDLBL",6,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDLBL",7,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"print CS dispensing labels.",!!,"PSJ RPHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDLBL",8,0)
ASKD ;ask disp number range
"RTN","PSDLBL",9,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDLBL",10,0)
 G:$P(PSDSITE,U,5) CHKD
"RTN","PSDLBL",11,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDLBL",12,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDLBL",13,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDLBL",14,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDLBL",15,0)
CHKD I '$O(^PSD(58.8,+PSDS,1,0)) W !!,"There are no CS stocked drugs for your dispensing vault.",!! G END
"RTN","PSDLBL",16,0)
ONE ;asks print type
"RTN","PSDLBL",17,0)
 K DA,DIR,DIRUT S DIR(0)="S^N:NAOU(s);R:Range of Green Sheet Numbers",DIR("A")="Printing Method"
"RTN","PSDLBL",18,0)
 S DIR("?",1)="Answer 'N' to select printing by NAOU(s), 'R' to select a number range",DIR("?")="to print ALL Green Sheets not previously printed, or '^' to quit."
"RTN","PSDLBL",19,0)
 D ^DIR K DIR G:$D(DIRUT) END S ANS=Y
"RTN","PSDLBL",20,0)
 G:ANS="N" SEL
"RTN","PSDLBL",21,0)
GS1 ;ask gs # range
"RTN","PSDLBL",22,0)
 W !!,"You may enter a Green Sheet # list and/or a Green Sheet # range.",!
"RTN","PSDLBL",23,0)
 W "NOTE: This response must be a list or range, e.g. 1,3,5 or 2-4,8.",!
"RTN","PSDLBL",24,0)
 K DA,DIR,DIRUT S DIR(0)="LOA^0:999999999",DIR("A")="Select Green Sheet #(s): "
"RTN","PSDLBL",25,0)
 D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDLBL",26,0)
 S PSD1="" F  S PSD1=$O(Y(PSD1)) Q:PSD1=""  S:$D(Y(PSD1)) PSD1(PSD1)=Y(PSD1) K Y(PSD1)
"RTN","PSDLBL",27,0)
 G DEV
"RTN","PSDLBL",28,0)
SEL ;sel naou or group
"RTN","PSDLBL",29,0)
 W !!,?5,"Select one of the following:",!!,?10,"N",?20,"NAOU (One, Some, or ^ALL)",!,?10,"G",?20,"Group of NAOUs",!
"RTN","PSDLBL",30,0)
 K DA,DIR,DIRUT S DIR(0)="SOA^N:NAOU;G:Group of NAOUs",DIR("A")="Select Method: "
"RTN","PSDLBL",31,0)
 S DIR("?",1)="Enter 'N' to select one, some or ^ALL NAOU(s),",DIR("?")="enter 'G' to select a group of NAOUs, or '^' to quit"
"RTN","PSDLBL",32,0)
 D ^DIR K DIR G:$D(DIRUT) END S SEL=Y D NOW^%DTC S PSDT=X K DA,DIC S CNT=0
"RTN","PSDLBL",33,0)
 I SEL="G" D GROUP G:'$D(PSDG) END G DEV
"RTN","PSDLBL",34,0)
 F  S DIC=58.8,DIC("A")="Select NAOU: ",DIC(0)="QEA",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$P(^(0),""^"",2)=""N""" D ^DIC K DIC Q:Y<0  D
"RTN","PSDLBL",35,0)
 .S NAOU(+Y)="",CNT=CNT+1
"RTN","PSDLBL",36,0)
 I '$D(NAOU)&(X'="^ALL") G END
"RTN","PSDLBL",37,0)
 S:X="^ALL" ALL=1
"RTN","PSDLBL",38,0)
DEV ;ask device and queue info
"RTN","PSDLBL",39,0)
 S DIR(0)="Y",DIR("A")="Would you like to try printing these on PIN FED labels",DIR("B")="No" D ^DIR K DIR Q:$D(DIRUT)  G:Y=1 ^PSDLBL4
"RTN","PSDLBL",40,0)
 W $C(7),!!,?3,"WARNING: The printing of these labels requires the use of a sheet fed",!,?12,"laser printer setup to create Controlled Substances",!,?12,"barcodes.",!
"RTN","PSDLBL",41,0)
 W !,?12,"*** Check printer for LABEL paper before printing! ***",!
"RTN","PSDLBL",42,0)
 W !!,"This report is designed for a 3 column label format.",!,"You may queue this report to print at a later time.",!!
"RTN","PSDLBL",43,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",10),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDLBL",44,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="Q",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDLBL",45,0)
 I $D(IO("Q")) K IO("Q"),ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDLBL0",ZTDESC="Print Dispensing Labels for CS PHARM" D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDLBL",46,0)
 U IO D ^PSDLBL0
"RTN","PSDLBL",47,0)
END ;kill variables and exit
"RTN","PSDLBL",48,0)
 K %,%DT,%H,%I,%ZIS,ALL,ANS,C,CNT,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DRUG,DTOUT,DUOUT,JJ,JLP1,LIQ,NAOU,NAOUN,NODE,OK
"RTN","PSDLBL",49,0)
 K POP,PSD,PSD1,PSD2,PSDA,PSDBAR0,PSDBAR1,PSDCNT,PSDEV,PSDG,PSDJ,PSDN,PSDPN,PSDOUT,PSDR,PSDRG,PSDPRT,PSDRN,PSDS,PSDSN,PSDT,PSDX1,PSDX2
"RTN","PSDLBL",50,0)
 K SEL,STAT,TEMP,TEST,TEXT,X,Y,ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDLBL",51,0)
 K ^TMP("PSDLBL",$J)
"RTN","PSDLBL",52,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDLBL",53,0)
 Q
"RTN","PSDLBL",54,0)
SAVE ;save queued variables
"RTN","PSDLBL",55,0)
 S:$D(ALL) ZTSAVE("ALL")=""
"RTN","PSDLBL",56,0)
 S:$D(PSDS) (ZTSAVE("PSDS"),ZTSAVE("PSDSN"))=""
"RTN","PSDLBL",57,0)
 S:$D(PSD1) ZTSAVE("PSD1(")="" S:$D(NAOU) ZTSAVE("NAOU(")="" S:$D(PSDG) ZTSAVE("PSDG(")="" S:$D(CNT) ZTSAVE("CNT")=""
"RTN","PSDLBL",58,0)
 S (ZTSAVE("ANS"),ZTSAVE("PSDSITE"))=""
"RTN","PSDLBL",59,0)
 Q
"RTN","PSDLBL",60,0)
GROUP ;select group of naous
"RTN","PSDLBL",61,0)
 K DA,DIC F  S DIC=58.2,DIC("A")="Select NAOU INVENTORY GROUP NAME: ",DIC(0)="QEA",DIC("S")="I $S($D(^PSI(58.2,""CS"",+Y)):1,1:0)" D ^DIC K DIC Q:Y<0  S PSDG(+Y)=""
"RTN","PSDLBL",62,0)
 Q
"RTN","PSDLBLR")
0^9^B13648116^B12912842
"RTN","PSDLBLR",1,0)
PSDLBLR ;BIR/JPW-CS Label Reprint for CS Disp Drug ; 29 Aug 94
"RTN","PSDLBLR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**69**;13 Feb 97;Build 13
"RTN","PSDLBLR",3,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDLBLR",4,0)
 ;
"RTN","PSDLBLR",5,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDLBLR",6,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDLBLR",7,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"print CS dispensing labels.",!!,"PSJ RPHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDLBLR",8,0)
 W !!,"Green Sheets/Transactions that have a status of FILLED - NOT DELIVERED",!,"or DELIVERED - ACTIVELY ON NAOU will be reprinted for a given number range.",!!
"RTN","PSDLBLR",9,0)
GS ;ask disp number range
"RTN","PSDLBLR",10,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDLBLR",11,0)
 G:$P(PSDSITE,U,5) GS1
"RTN","PSDLBLR",12,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDLBLR",13,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDLBLR",14,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDLBLR",15,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDLBLR",16,0)
GS1 ;
"RTN","PSDLBLR",17,0)
 W !!,"You may enter a Dispensing Number list and/or a Dispensing Number range.",!
"RTN","PSDLBLR",18,0)
 W "NOTE: This response must be a list or range, e.g., 1,3,5 or 2-4,8.",!
"RTN","PSDLBLR",19,0)
 K DA,DIR,DIRUT S DIR(0)="LOA^0:999999999",DIR("A")="Select Dispensing Number(s): "
"RTN","PSDLBLR",20,0)
 D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDLBLR",21,0)
 S PSD1="" F  S PSD1=$O(Y(PSD1)) Q:PSD1=""  S:$D(Y(PSD1)) PSD1(PSD1)=Y(PSD1) K Y(PSD1)
"RTN","PSDLBLR",22,0)
DEV ;ask device and queue info
"RTN","PSDLBLR",23,0)
 S DIR(0)="Y",DIR("A")="Would you like to try printing these on PIN FED labels",DIR("B")="No" D ^DIR K DIR Q:$D(DIRUT)  G:Y=1 ^PSDLBLR1
"RTN","PSDLBLR",24,0)
 W $C(7),!!,?3,"WARNING: The printing of these labels requires the use of a sheet fed",!,?12,"laser printer setup to create Controlled Substances",!,?12,"barcodes.",!
"RTN","PSDLBLR",25,0)
 W !,?12,"*** Check printer for LABEL paper before printing! ***",!
"RTN","PSDLBLR",26,0)
 W !!,"This report is designed for a 3 column label format.",!,"You may queue this report to print at a later time.",!!
"RTN","PSDLBLR",27,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",10),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDLBLR",28,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="QM",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDLBLR",29,0)
 I $D(IO("Q")) K IO("Q"),ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDLBLR0",ZTDESC="Print Dispensing Labels for CS PHARM" D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDLBLR",30,0)
 U IO D ^PSDLBLR0
"RTN","PSDLBLR",31,0)
END ;kill variables and exit
"RTN","PSDLBLR",32,0)
 K %,%DT,%H,%I,%ZIS,C,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DRUG,DTOUT,DUOUT,JJ,JLP1,LIQ,NAOU,NAOUN,NODE,OK
"RTN","PSDLBLR",33,0)
 K POP,PSD,PSD1,PSDA,PSDBAR0,PSDBAR1,PSDCNT,PSDEV,PSDJ,PSDN,PSDPN,PSDOUT,PSDR,PSDRG,PSDPRT,PSDRN,PSDS,PSDSN,PSDT,PSDX1,PSDX2
"RTN","PSDLBLR",34,0)
 K QTY,STAT,TEMP,TEST,TEXT,X,Y,ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDLBLR",35,0)
 K ^TMP("PSDLBLR",$J)
"RTN","PSDLBLR",36,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDLBLR",37,0)
 Q
"RTN","PSDLBLR",38,0)
SAVE ;save queued variables
"RTN","PSDLBLR",39,0)
 S (ZTSAVE("PSDS"),ZTSAVE("PSDSN"))=""
"RTN","PSDLBLR",40,0)
 S ZTSAVE("PSD1(")=""
"RTN","PSDLBLR",41,0)
 Q
"RTN","PSDNDES")
0^14^B21712676^B20150900
"RTN","PSDNDES",1,0)
PSDNDES ;BIR/JPW-Dispense from Pharmacy w/o Green Sheet ; 8 Aug 94
"RTN","PSDNDES",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**69**;13 Feb 97;Build 13
"RTN","PSDNDES",3,0)
 ;References to ^PSD(58.8, supported by DBIA2711
"RTN","PSDNDES",4,0)
 ;References to ^PSDRUG( supported by DBIA #221
"RTN","PSDNDES",5,0)
 ;
"RTN","PSDNDES",6,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNDES",7,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)),'$D(^XUSEC("PSD TECH ADV",DUZ)) W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"dispense narcotic supplies.  PSJ RPHARM or PSD TECH ADV",!?12,"security key required.",! Q
"RTN","PSDNDES",8,0)
 S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDNDES",9,0)
TEST ;to be reworked for narcotic disp equipment
"RTN","PSDNDES",10,0)
 W !!,"For now this option is the same as dispense w/o green sheet.",!!
"RTN","PSDNDES",11,0)
ASKD ;ask disp loc
"RTN","PSDNDES",12,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDNDES",13,0)
 I $P(PSDSITE,U,5) S ASK=$P($G(^PSD(58.8,+PSDS,0)),U,5) G CHKD
"RTN","PSDNDES",14,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDNDES",15,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDNDES",16,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDNDES",17,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),ASK=$P(Y(0),"^",5)
"RTN","PSDNDES",18,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDNDES",19,0)
CHKD I '$O(^PSD(58.8,PSDS,1,0)) W !!,"There are no stocked drugs for this Pharmacy Vault!!",!! G END
"RTN","PSDNDES",20,0)
DRUG ;select drug
"RTN","PSDNDES",21,0)
 S PSDOUT=0 W !
"RTN","PSDNDES",22,0)
 K DA,DIC S DIC("W")="W:$P(^PSDRUG(Y,0),""^"",9) ""   N/F"" I $P(^PSD(58.8,PSDS,1,Y,0),""^"",14)]"""",$P(^(0),""^"",14)'>DT W $C(7),""   *** INACTIVE ***"""
"RTN","PSDNDES",23,0)
 S DA(1)=+PSDS,DIC(0)="QEAMZ",DIC="^PSD(58.8,"_PSDS_",1," D ^DIC K DIC G:Y<0 END S PSDR=+Y,PSDRN=$P($G(^PSDRUG(+PSDR,0)),"^")
"RTN","PSDNDES",24,0)
 I '$D(^PSD(58.8,+PSDS,1,+PSDR,0)) W $C(7),!!,?10,"** Your Dispensing Site is missing stock drug data.",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNDES",25,0)
 S (MFG,LOT,EXP,EXPD,NBKU,NPKG)="",MFG=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",10),LOT=$P(^(0),"^",11),EXP=$P(^(0),"^",12),NBKU=$P(^(0),"^",8),NPKG=$P(^(0),"^",9)
"RTN","PSDNDES",26,0)
 I 'NPKG!(NBKU']"") W $C(7),!!,PSDRN," is missing breakdown unit or",!,"package size data in ",PSDSN,"." D MSG G END
"RTN","PSDNDES",27,0)
 I EXP S Y=EXP X ^DD("DD") S EXPD=Y
"RTN","PSDNDES",28,0)
 S NBKU=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",8),NPKG=+$P(^(0),"^",9)
"RTN","PSDNDES",29,0)
 I NBKU']"" W !!,PSDSN,"is missing narcotic breakdown unit",!,"for ",PSDRN,"." G END
"RTN","PSDNDES",30,0)
 I 'NPKG W !!,PSDSN,"is missing narcotic package size",!,"for ",PSDRN,"." G END
"RTN","PSDNDES",31,0)
NAOU ;select NAOU
"RTN","PSDNDES",32,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select NAOU: "
"RTN","PSDNDES",33,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"""
"RTN","PSDNDES",34,0)
 D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDNDES",35,0)
QTY K DA,DIR,DIRUT S DIR(0)="58.85,18O",DIR("B")=NPKG,DIR("A")="QUANTITY DISPENSED ("_NBKU_"/"_NPKG_")" D ^DIR K DIR I 'Y!$D(DIRUT) D MSG G END
"RTN","PSDNDES",36,0)
 S QTY=+Y I QTY>+$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4) W !!,"The drug balance for this drug is ",+$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4),".",!,"You cannot dispense ",QTY," for this drug.",!! G END
"RTN","PSDNDES",37,0)
ASKM I ASK D MFG I PSDOUT D MSG G END
"RTN","PSDNDES",38,0)
OK W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK? ",DIR("?",1)="Answer 'YES' to record dispensing this drug,"
"RTN","PSDNDES",39,0)
 S DIR("?")="NO to select another drug or '^' to quit." D ^DIR K DIR
"RTN","PSDNDES",40,0)
 I $D(DIRUT) D MSG G END
"RTN","PSDNDES",41,0)
 I 'Y D MSG G DRUG
"RTN","PSDNDES",42,0)
 D ^PSDDFP1 G:'PSDOUT DRUG
"RTN","PSDNDES",43,0)
END K %,%DT,%H,%I,ASK,BAL,DA,DIC,DIE,DIK,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EDIT,EXP,EXPD,LOT,MFG,NAOU,NAOUN,NBKU,NPKG,OK
"RTN","PSDNDES",44,0)
 K PSDDT,PSDLES,PSDOUT,PSDR,PSDREC,PSDRN,PSDS,PSDSN,PSDUZ,PSDUZN,QTY,TEXP,TLOT,TMFG,X,Y
"RTN","PSDNDES",45,0)
 Q
"RTN","PSDNDES",46,0)
MFG K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,12O",DIR("B")=MFG D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDNDES",47,0)
 I Y]"",Y'=MFG S MFG=Y S $P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",10)=MFG
"RTN","PSDNDES",48,0)
 K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,13O",DIR("B")=LOT D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDNDES",49,0)
 I Y]"",Y'=LOT S LOT=Y S $P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",11)=LOT
"RTN","PSDNDES",50,0)
 K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,14O",DIR("B")=EXPD D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDNDES",51,0)
 I Y,Y'=EXP S EXP=Y W !!,"Updating Expiration Date data..." K DA,DIE,DR S DA=+PSDR,DA(1)=+PSDS,DIE="^PSD(58.8,"_DA(1)_",1,",DR="11///"_EXP D ^DIE K DA,DIE,DR W "done.",!!
"RTN","PSDNDES",52,0)
 Q
"RTN","PSDNDES",53,0)
MSG W !!,"** No action taken. **",!!
"RTN","PSDNDES",54,0)
 Q
"RTN","PSDOPT")
0^1^B88195048^B83861199
"RTN","PSDOPT",1,0)
PSDOPT ;BIR/JPW,LTL,BJW-Outpatient Rx Entry ; 2/5/04 12:15pm
"RTN","PSDOPT",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**10,11,15,21,30,39,48,62,69**;13 Feb 97;Build 13
"RTN","PSDOPT",3,0)
 ;Reference to ^PSDRUG( supported by DBIA #221
"RTN","PSDOPT",4,0)
 ;References to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDOPT",5,0)
 ;References to file 58.81 are covered by DBIA #2808
"RTN","PSDOPT",6,0)
 ;Reference to PSRX( supported by DBIA #986
"RTN","PSDOPT",7,0)
 ;Reference to PSOFUNC supported by DBIA #981
"RTN","PSDOPT",8,0)
 ;Line Tag FINAL^PSOLSET supported by DBIA #982
"RTN","PSDOPT",9,0)
 ;
"RTN","PSDOPT",10,0)
 ;mod.for nois:tua-0498-32173,askp,bc1;ver
"RTN","PSDOPT",11,0)
 ;enhancement for Outpat V7 status code of 12,13,14,15 in askp
"RTN","PSDOPT",12,0)
 ;
"RTN","PSDOPT",13,0)
 ;further modifications related to the deletion of
"RTN","PSDOPT",14,0)
 ;refills made in April 1999 
"RTN","PSDOPT",15,0)
 ;
"RTN","PSDOPT",16,0)
 ;PSD*3*39 Kill all variables
"RTN","PSDOPT",17,0)
 D PSDKLL^PSDOPT2
"RTN","PSDOPT",18,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDOPT",19,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)),'$D(^XUSEC("PSD TECH ADV",DUZ)) W !!,"Please contact your Pharmacy Coordinator for access",!,"to log Outpatient Prescriptions. Either the PSJ RPHARM",!,"or PSD TECH ADV security key required.",!! Q
"RTN","PSDOPT",20,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDOPT",21,0)
 N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDOPT",22,0)
 N LN S (PSDOUT,NEW)=0,PSDUZ=DUZ,$P(LN,"-",80)="",Y=DT
"RTN","PSDOPT",23,0)
 X ^DD("DD") S RPDT=Y
"RTN","PSDOPT",24,0)
ASKD ;ask disp site
"RTN","PSDOPT",25,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDOPT",26,0)
 G:$P(PSDSITE,U,5) CHKD
"RTN","PSDOPT",27,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDOPT",28,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDOPT",29,0)
 W ! D ^DIC K DIC G:Y<0 END
"RTN","PSDOPT",30,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDOPT",31,0)
CHKD I '$O(^PSD(58.8,PSDS,1,0)) W !!,"There are no stocked drugs for this Pharmacy Vault!!",!! G END
"RTN","PSDOPT",32,0)
ASKPH ;ask releasing RPH
"RTN","PSDOPT",33,0)
 S DIC="^VA(200,",DIC(0)="QEAM",DIC("S")="I $D(^XUSEC(""PSORPH"",+Y))"
"RTN","PSDOPT",34,0)
 S DIC("A")="Please identify Pharmacist for Outpatient Release: "
"RTN","PSDOPT",35,0)
 S:$D(^XUSEC("PSORPH",DUZ)) DIC("B")=$P($G(^VA(200,DUZ,0)),U)
"RTN","PSDOPT",36,0)
 W ! D ^DIC K DIC G:Y<1 END S PSDRPH=+Y
"RTN","PSDOPT",37,0)
ASKP ;ask rx #
"RTN","PSDOPT",38,0)
 K PSDSEL,PSDPOST,PSDREL
"RTN","PSDOPT",39,0)
 ;PSD*3*30 (Dave Blocker ) Lock the script node
"RTN","PSDOPT",40,0)
 I $G(PSDRX)'="" L -^PSRX(PSDRX)
"RTN","PSDOPT",41,0)
 W ! K DIR,NEW,PSDRX,PSDRXIN,RXNUM S PSDOUT=0 S DIR("A")="Enter/Wand PRESCRIPTION number"
"RTN","PSDOPT",42,0)
 S DIR("?")="^D HELP^PSODISP",DIR(0)="F^1:35" D ^DIR K DIR
"RTN","PSDOPT",43,0)
 G:$D(DTOUT)!($D(DUOUT)) END G:X="" ASKPH
"RTN","PSDOPT",44,0)
 S X=$$UP^XLFSTR(X)
"RTN","PSDOPT",45,0)
 I X'["-" D  S PSDRX=$G(PSDRXIN)
"RTN","PSDOPT",46,0)
 .S PSDRX=0 F  S PSDRX=$O(^PSRX("B",X,PSDRX)) Q:'PSDRX  S PSDRXIN=PSDRX D VER
"RTN","PSDOPT",47,0)
 I X'["-",'$G(PSDRX)!('$D(^PSRX(+$G(PSDRX),0))) W !,"INVALID PRESCRIPTION NUMBER" G ASKP
"RTN","PSDOPT",48,0)
 ;
"RTN","PSDOPT",49,0)
 ;PSD*3*30 - lock the script
"RTN","PSDOPT",50,0)
 I X'["-" L +^PSRX(PSDRX):5 I '$T W !!,"Sorry, someone else is editing this prescription. Please try again later." K PSDRX G ASKP
"RTN","PSDOPT",51,0)
 ;
"RTN","PSDOPT",52,0)
 ;DAVE B (PSD*3*15) Show previous postings
"RTN","PSDOPT",53,0)
 I X'["-" I $G(PSOVR)=1,$G(PSDSTA)=12!($G(PSDSTA)=13)!($G(PSDSTA)=14)!($G(PSDSTA)=15)!($G(PSDSTA)=11) S PSDXXX=X D CHKRF I $G(PSDNEXT)=1 G ASKP
"RTN","PSDOPT",54,0)
 ;<JD *62
"RTN","PSDOPT",55,0)
 ;
"RTN","PSDOPT",56,0)
 S PSD(1)=X,DIC="^DIC(4,",DR=99,DA=+$P($G(^XMB(1,1,"XUS")),U,17)
"RTN","PSDOPT",57,0)
 K DIQ S DIQ="PSD" D EN^DIQ1 S X=PSD(1) K DIC,DR,DIQ
"RTN","PSDOPT",58,0)
 I X["-",$P(X,"-")'=PSD(4,DA,99) K DA,PSD W !?7,$C(7),"   INVALID STATION NUMBER !!",! G ASKP
"RTN","PSDOPT",59,0)
 K DA,PSD
"RTN","PSDOPT",60,0)
 I X["-" S PSDRX=$P(X,"-",2) I (PSDRX'?1N.N.1U) W !?7,$C(7),"   INVALID PRESCRIPTION NUMBER" G ASKP
"RTN","PSDOPT",61,0)
 I X["-" I '$D(^PSRX(+$G(PSDRX),0))!($G(PSDRX)']"") W !?7,$C(7),"   NON-EXISTENT PRESCRIPTION" G ASKP
"RTN","PSDOPT",62,0)
 ;
"RTN","PSDOPT",63,0)
 I X["-",$D(^PSRX(PSDRX,0)) S PSDRXIN=+PSDRX D VER I PSOVR=1,$G(PSDSTA)=12!($G(PSDSTA)=13)!($G(PSDSTA)=14)!($G(PSDSTA)=15) D CHKRF I $G(PSDNEXT)=1 G ASKP
"RTN","PSDOPT",64,0)
 I X["-" L +^PSRX(PSDRX):5 I '$T W !!,"Sorry, someone else is editing this prescription. Please try again later." K PSDRX G ASKP
"RTN","PSDOPT",65,0)
 ;
"RTN","PSDOPT",66,0)
 ; (PSD*3*21) Check for transmission status for barcode entry
"RTN","PSDOPT",67,0)
 ;
"RTN","PSDOPT",68,0)
 G:$D(^PSRX(PSDRX,0)) BC1
"RTN","PSDOPT",69,0)
 W !?7,$C(7),"   IMPROPER BARCODE FORMAT" G ASKP
"RTN","PSDOPT",70,0)
BC1 ;
"RTN","PSDOPT",71,0)
 S PSDRXIN=+PSDRX D VER
"RTN","PSDOPT",72,0)
 I $G(PSDSTA)=13!(+$P($G(^PSRX(+PSDRX,0)),"^",2)=0) W !?7,$C(7),"    PRESCRIPTION HAS BEEN DELETED." G ASKP
"RTN","PSDOPT",73,0)
 I $G(PSDSTA),$S($G(PSDSTA)=2:0,$G(PSDSTA)=5:0,$G(PSDSTA)=11:0,$G(PSDSTA)=12:0,$G(PSDSTA)=14:0,$G(PSDSTA)=15:0,1:1) D  K J,RX0,RX2,ST,ST0 G ASKP
"RTN","PSDOPT",74,0)
 .S RX0=$G(^PSRX(+PSDRX,0)),RX2=^PSRX(+PSDRX,2),J=PSDRX S $P(RX0,"^",15)=$G(PSDSTA) D ^PSOFUNC
"RTN","PSDOPT",75,0)
 .W !!,$C(7),"     Status of ",ST," is not appropriate for selection."
"RTN","PSDOPT",76,0)
 K PSDSTA,PSOVR,PSDRXIN
"RTN","PSDOPT",77,0)
 S RXNUM=$P($G(^PSRX(+PSDRX,0)),U),PSDR=+$P($G(^(0)),U,6),DFN=+$P($G(^(0)),U,2),QTY=$P($G(^(0)),U,7),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDOPT",78,0)
 N C S Y=DFN,C=$P(^DD(58.81,73,0),U,2) D Y^DIQ S PATN=Y
"RTN","PSDOPT",79,0)
 D PID^VADPT6
"RTN","PSDOPT",80,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,0)) W !!,PSDRN," is not currently stocked in ",PSDSN,".",!!,"** No action taken. **",!! G END
"RTN","PSDOPT",81,0)
 I $D(^PSD(58.81,"AOP",PSDRX)) D ^PSDOPT2 I PSDOUT D MSG G END
"RTN","PSDOPT",82,0)
 G ^PSDOPT0
"RTN","PSDOPT",83,0)
CHK ;displays and checks if ok
"RTN","PSDOPT",84,0)
CLLDIR I $D(PSDSEL("OR")) S DIR(0)="S^1:Original;",CNT=1
"RTN","PSDOPT",85,0)
 I $D(PSDSEL("RF")) D
"RTN","PSDOPT",86,0)
 .S X1=0 F  S X1=$O(PSDSEL("RF",X1)) Q:X1=""  D
"RTN","PSDOPT",87,0)
 ..I $D(PSDRET("RF",X1)),(PSDRET("RF",X1)\1)=$P(PSDSEL("RF",X1),"^") D RTSDTC^PSDOPT2 Q
"RTN","PSDOPT",88,0)
 ..I $D(PSDRET("RF",X1)),PSDRET("RF",X1)<$P(PSDSEL("RF",X1),"^") D CLLDIR2 Q
"RTN","PSDOPT",89,0)
 ..I '$D(PSDRET("RF",X1)) D CLLDIR2 Q
"RTN","PSDOPT",90,0)
 ..Q
"RTN","PSDOPT",91,0)
 I $D(PSDSEL("PR")) D
"RTN","PSDOPT",92,0)
 .S X1=0 F  S X1=$O(PSDSEL("PR",X1)) Q:X1=""  I '$D(PSDRET("PR",X1)) S CNT=$G(CNT)+1,DIR(0)=$S($G(CNT)=1:"S^1:Partial #"_X1,1:DIR(0)_CNT_":Partial #"_X1)_" ("_$P(PSDSEL("PR",X1),"^",2)_");"
"RTN","PSDOPT",93,0)
 I $G(DIR(0))'="" D
"RTN","PSDOPT",94,0)
 .K PSDERR D ^DIR I $D(DIRUT) S PSDERR=1 Q
"RTN","PSDOPT",95,0)
 .S PSDA=$E(Y(0))
"RTN","PSDOPT",96,0)
 Q:$D(PSDERR)
"RTN","PSDOPT",97,0)
 Q:'$D(Y(0))  I PSDA="O" S DAT=$P($G(^PSRX(PSDRX,2)),U,2),PSDPOST=$P(PSDSEL("OR"),"^",3),PSDREL=$P(PSDSEL("OR"),"^",4) G PROCESS
"RTN","PSDOPT",98,0)
 I PSDA="R" S XX=$P(Y(0),"#",2),XXX=$P(XX," ",1),DAT=$P($G(PSDSEL("RF",XXX)),"^",1),QTY=$P(PSDSEL("RF",XXX),U,2),PSDPOST=$P(PSDSEL("RF",XXX),U,3),PSDREL=$P(PSDSEL("RF",XXX),U,4) G PROCESS
"RTN","PSDOPT",99,0)
 I PSDA="P" S XX=$P(Y(0),"#",2),XXX=$P(XX," ",1),DAT=$P($G(PSDSEL("PR",XXX)),"^",1),QTY=$P(PSDSEL("PR",XXX),U,2),PSDPOST=$P(PSDSEL("PR",XXX),U,3),PSDREL=$P(PSDSEL("PR",XXX),U,4) G PROCESS
"RTN","PSDOPT",100,0)
 W !,"Error somewhere" G ASKP
"RTN","PSDOPT",101,0)
PROCESS ;process selection
"RTN","PSDOPT",102,0)
 I PSDA'="O" S PSDFLNO=XXX ;fill number
"RTN","PSDOPT",103,0)
 I PSDA="O" S NEW=1,(NEW(1),NEW(2))=0 ;Original
"RTN","PSDOPT",104,0)
 I PSDA="R" S NEW(1)=XXX,(NEW,NEW(2))=0 ;Refill
"RTN","PSDOPT",105,0)
 I PSDA="P" S NEW(2)=XXX,(NEW,NEW(1))=0 ;Partial
"RTN","PSDOPT",106,0)
 S X=0 F  S X=$O(^PSRX(PSDRX,4,X)) Q:X'>0  S STATUS=$P($G(^PSRX(PSDRX,4,X,0)),"^",4),NUMBER=$P($G(^PSRX(PSDRX,4,X,0)),"^",3) I $G(STATUS)'=3 D
"RTN","PSDOPT",107,0)
 .I NUMBER=0,$G(NEW)=1,$G(NEW(1))=0 D CMOPMSG
"RTN","PSDOPT",108,0)
 .I NUMBER=$G(NEW(1)),$G(NEW)=0,PSDA'="P",'$D(PSDRET("RF",NUMBER)) D CMOPMSG
"RTN","PSDOPT",109,0)
 I $G(PSDOUT)=1 G ASKP
"RTN","PSDOPT",110,0)
 ;
"RTN","PSDOPT",111,0)
 D:PSDA="O" PSDORIG^PSDOPT1 D:PSDA="R" PSDRFL^PSDOPT1 D:PSDA="P" PSDPRTL^PSDOPT1
"RTN","PSDOPT",112,0)
 I $G(PSDOUT)=1 G ASKP
"RTN","PSDOPT",113,0)
 I $G(PSDPOST)=1,$G(PSDREL)="" W !,"This fill has already been posted." D CHKEY D:'$D(PSDOUT) PSDREL^PSDOPT1 G ASKP
"RTN","PSDOPT",114,0)
 I $G(PSDREL)'="",$G(PSDPOST)'>0 W !,"This fill has already been released."
"RTN","PSDOPT",115,0)
 I $G(PSDREL)'="",$G(PSDPOST)>0 W !,"This fill has already been posted & released, no further action required." G ASKP
"RTN","PSDOPT",116,0)
 D DISPLAY G:PSDOUT END
"RTN","PSDOPT",117,0)
 D CHKEY I PSDOUT G ASKP
"RTN","PSDOPT",118,0)
 K DA,DIR,DIRUT S DIR(0)="YA",DIR("B")="YES",DIR("A")="Is this OK? "
"RTN","PSDOPT",119,0)
 S DIR("?",1)="Answer 'YES' to log this RX transaction in your CS vault,",DIR("?")="answer 'NO' to reselect a prescription, or '^' to quit."
"RTN","PSDOPT",120,0)
 D ^DIR K DIR I Y<1 D MSG G:$D(DIRUT) END G:Y<1 ASKP
"RTN","PSDOPT",121,0)
 D ^PSDOPT1 G ASKP
"RTN","PSDOPT",122,0)
END K %,%H,%I,BAL,C,CNT,DA,DAT,DD,DFN,DIC,DIE,DIK,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DO,DR,JJ,LN,NEW,NODE,NODE6 D FINAL^PSOLSET
"RTN","PSDOPT",123,0)
 I $G(PSDRX)'="" L -^PSRX(PSDRX)
"RTN","PSDOPT",124,0)
 K PATN,PHARM,PHARMN,PRF,PSDA,PSDATE,PSDOUT,PSDR,PSDRN,PSDRPH,PSDRX,PSDS,PSDSN,PSDT,PSDUZ,PSOCSUB,QTY,RF,RPDT,RXNUM,X,Y
"RTN","PSDOPT",125,0)
 D KVAR^VADPT K VA("PID"),VA("BID")
"RTN","PSDOPT",126,0)
 Q
"RTN","PSDOPT",127,0)
CHKEY ;check if user has access
"RTN","PSDOPT",128,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)) D  S PSDOUT=1
"RTN","PSDOPT",129,0)
 .W !!?12,"** You have no access to release this prescription."
"RTN","PSDOPT",130,0)
 .W !?15,"The PSJ RPHARM security key is required. **",!
"RTN","PSDOPT",131,0)
 Q
"RTN","PSDOPT",132,0)
CLLDIR2 S CNT=$G(CNT)+1,DIR(0)=$S($G(CNT)=1:"S^1:Refill #"_X1,1:DIR(0)_CNT_":Refill #"_X1)_";"
"RTN","PSDOPT",133,0)
 Q
"RTN","PSDOPT",134,0)
DISPLAY ;disp data
"RTN","PSDOPT",135,0)
 W !!,?20,"View Controlled Substances Rx # ",RXNUM,!,?28,RPDT,!,LN,!!
"RTN","PSDOPT",136,0)
 W "Location: ",?10,PSDSN,?55
"RTN","PSDOPT",137,0)
 S PSDRN(1)=$S(NEW:"Original",$G(NEW(1)):"Refill #"_NEW(1),1:"Partial #"_$G(NEW(2))) W PSDRN(1)
"RTN","PSDOPT",138,0)
 W !,"Drug: ",?10,PSDRN,?55,"Quantity: ",QTY
"RTN","PSDOPT",139,0)
 ;
"RTN","PSDOPT",140,0)
 ;DAVE B (PSD*3*15) check for Non-numeric quantity
"RTN","PSDOPT",141,0)
 I QTY'?.N W !,"The Quantity is not strictly numeric. This will cause the new balance to be",!,"calculated incorrectly.",!
"RTN","PSDOPT",142,0)
 W !,"Patient: ",?10,PATN_"  ("_VA("BID")_")",?55,PSDRN(1)," Date: ",?65,$E(DAT,4,5)_"/"_$E(DAT,6,7)_"/"_$E(DAT,2,3),!
"RTN","PSDOPT",143,0)
 S BAL=+$P($G(^PSD(58.8,+PSDS,1,PSDR,0)),"^",4) I QTY>BAL W !!,?5,"Your balance is ",BAL,".",!,?5,"You may not dispense lower than your balance.",!! D MSG S PSDOUT=1 Q
"RTN","PSDOPT",144,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)) W !!?15,"Current Balance: ",BAL Q
"RTN","PSDOPT",145,0)
 W !!,?15,"Old Balance: ",BAL,?40,"New Balance: ",BAL-QTY,!!
"RTN","PSDOPT",146,0)
 Q
"RTN","PSDOPT",147,0)
MSG W $C(7),!!,"No action taken.  This transaction has not been recorded.",!!
"RTN","PSDOPT",148,0)
 Q
"RTN","PSDOPT",149,0)
VER ;Current Outpatient Version, and Rx status added 6/17/98
"RTN","PSDOPT",150,0)
 K PSDSTA S PSDHOLDX=$G(X) S PSOVR=$$VERSION^XPDUTL("PSO") S X=$G(PSDHOLDX) K PSDHOLDX S PSOVR=$S($G(PSOVR)>6:1,1:0)
"RTN","PSDOPT",151,0)
 I $G(PSDRXIN) S PSDSTA=$S(PSOVR:$P($G(^PSRX(PSDRXIN,"STA")),"^"),1:$P($G(^PSRX(PSDRXIN,0)),"^",15))
"RTN","PSDOPT",152,0)
 Q
"RTN","PSDOPT",153,0)
CHKRF ;Dave B (PSD*3*30) if its deleted, show status.
"RTN","PSDOPT",154,0)
 W !,"This RX has a status of '"_$S(PSDSTA=11:"EXPIRED",PSDSTA=12:"DISCONTINUED",PSDSTA=13:"DELETED",PSDSTA=14:"DISCONTINUED BY PROVIDER",PSDSTA=15:"DISCONTINUED (EDIT)",1:"Unknown  Procedure")_$S(PSDSTA=12:"'.",1:"', no action can be taken.")
"RTN","PSDOPT",155,0)
 ;< JD*62
"RTN","PSDOPT",156,0)
 I $O(^PSRX(PSDRX,"A",0))>0 W !!,"Below is a list of actions taken on the prescription.",!!,"DATE/TIME",?22,"PERSON",?45,"ACTIVITY",! F X=1:1:53 W "=" F X=1:1:(IOM-1) W "="
"RTN","PSDOPT",157,0)
 S X3=0 F  S X3=$O(^PSRX(PSDRX,"A",X3)) Q:X3=""  S DATA=$G(^PSRX(PSDRX,"A",X3,0)),Y=$P(DATA,"^",1) X ^DD("DD") S DATE=Y,X=$P(DATA,"^",2) D
"RTN","PSDOPT",158,0)
 .I $G(X)'="" S ACTIVITY=$$EXTERNAL^DILFD(52.3,.02,,X)
"RTN","PSDOPT",159,0)
 .S DELDUZ=$$EXTERNAL^DILFD(52.3,.03,,$P(DATA,"^",3)) S DELDUZ=$S($G(DELDUZ)="":"Unknown ("_$P(DATA,"^",3)_")",1:DELDUZ)
"RTN","PSDOPT",160,0)
 .K DELREAS S DELREAS=$P(DATA,"^",5)
"RTN","PSDOPT",161,0)
 .W !,DATE,?22,DELDUZ,?45,ACTIVITY I $G(DELREAS)'="" W !,"Comment: ",$G(DELREAS)
"RTN","PSDOPT",162,0)
 I $G(PSDSTA)'=12 S PSDNEXT=1 Q
"RTN","PSDOPT",163,0)
ASK12 R !,"Do you wish to continue? NO // ",AN:DTIME S:AN="" AN="N"
"RTN","PSDOPT",164,0)
 I "YyNn"'[AN W !,"Answer 'N'o, and you will prompted for another prescription." G ASK12
"RTN","PSDOPT",165,0)
 I "nN"[AN S PSDNEXT=1 Q
"RTN","PSDOPT",166,0)
 K PSDNEXT
"RTN","PSDOPT",167,0)
 Q
"RTN","PSDOPT",168,0)
CMOPMSG W !,?10,"This is a CMOP fill and has been transmitted, dispensed or ",!?10,"retransmitted.",! S PSDOUT=1 Q
"RTN","PSDOPT",169,0)
KLLALL ;Kill all
"RTN","PSDORN")
0^18^B33160894^B32697727
"RTN","PSDORN",1,0)
PSDORN ;BIR/JPW,LTL-Nurse CS Order Request Entry ;12/14/99  16:04
"RTN","PSDORN",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**20,69**;13 Feb 97;Build 13
"RTN","PSDORN",3,0)
 ;
"RTN","PSDORN",4,0)
 ; Reference to PSD(58.8 supported by DBIA # 2711
"RTN","PSDORN",5,0)
 ; Reference to XUSEC( supported by DBIA # 10076
"RTN","PSDORN",6,0)
 ; Reference to VA(200 supported by DBIA # 10060
"RTN","PSDORN",7,0)
 ; Reference to DD("DD" supported by DBIA # 10017
"RTN","PSDORN",8,0)
 ; Reference to PSDRUG( supported by DBIA # 221
"RTN","PSDORN",9,0)
 ; Line tag EN^XQH supported by DBIA # 10074
"RTN","PSDORN",10,0)
 ;
"RTN","PSDORN",11,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDORN",12,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):2,$D(^XUSEC("PSJ PHARM TECH",DUZ)):2,$D(^XUSEC("PSD TECH ADV",DUZ)):2,1:0)
"RTN","PSDORN",13,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to order",!,?12,"narcotic supplies.",!!,"PSJ RNURSE, PSJ RPHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDORN",14,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDORN",15,0)
 G:OK=2 ^PSDORP
"RTN","PSDORN",16,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDORN",17,0)
NAOU ;select NAOU to order supplies for
"RTN","PSDORN",18,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ordering NAOU: "
"RTN","PSDORN",19,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDORN",20,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDORN",21,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDORN",22,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDORN",23,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4)
"RTN","PSDORN",24,0)
 S:PSDS PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5)
"RTN","PSDORN",25,0)
 I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDORN",26,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDORN",27,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDORN",28,0)
 S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDORN",29,0)
 K ^UTILITY($J,"W") W ! N X,DIWL,DIWR,DIWF,PSD
"RTN","PSDORN",30,0)
 S PSD=0,DIWL=1,DIWR=80,DIWF="W",X="IORVON;IORVOFF" D ENDR^%ZISS W IORVON
"RTN","PSDORN",31,0)
 F  S PSD=$O(^PSD(58.8,+PSDS,5,PSD)) Q:'PSD  S X=$G(^PSD(58.8,+PSDS,5,PSD,0)) D ^DIWP
"RTN","PSDORN",32,0)
 D ^DIWW W IORVOFF D KILL^%ZISS
"RTN","PSDORN",33,0)
TYPE S DIR(0)="SAM^S:Scheduled Delivery;U:Priority Pick Up"
"RTN","PSDORN",34,0)
 S DIR("A")="Scheduled Delivery or Priority Pick Up (S/U):  "
"RTN","PSDORN",35,0)
 S DIR("B")="Scheduled Delivery"
"RTN","PSDORN",36,0)
 S DIR("?")="^N XQH S XQH=""PSD ORDER ENTRY"" D EN^XQH"
"RTN","PSDORN",37,0)
 D ^DIR K DIR G:$D(DIRUT) END W ! G:Y="S" ^PSDORD
"RTN","PSDORN",38,0)
DRUG ;select drug
"RTN","PSDORN",39,0)
 K DA,DIC,PSDR
"RTN","PSDORN",40,0)
 S DIC("W")="W:$P(^PSDRUG(Y,0),U,9) ""   N/F"" W $S('$G(^PSD(58.8,NAOU,1,Y,0)):""  NOT STOCKED BY ""_NAOUN,$P(^(0),U,14)&($P(^(0),U,14)'>DT):"" INACTIVE on ""_NAOUN,1:"""")"
"RTN","PSDORN",41,0)
 S DIC("S")="I '$P($G(^(7)),U,2),$S('$P(^(0),""^"",14):1,+$P(^(0),""^"",14)>DT:1,1:0)"
"RTN","PSDORN",42,0)
 S DA(1)=+PSDS,DIC(0)="QEAM",DIC="^PSD(58.8,"_+PSDS_",1,"
"RTN","PSDORN",43,0)
 ;no one-time requests allowed by dispensing site
"RTN","PSDORN",44,0)
 D:'$P($G(^PSD(58.8,+PSDS,0)),U,13)
"RTN","PSDORN",45,0)
 .S DIC("W")="W:$P(^PSDRUG(Y,0),U,9) ""  N/F"" I $P(^PSD(58.8,NAOU,1,Y,0),U,14)]"""",$P(^(0),U,14)'>DT W $C(7),""  *** INACTIVE ***"""
"RTN","PSDORN",46,0)
 .S DIC("S")="I $S('$P(^(0),U,14):1,+$P(^(0),U,14)>DT:1,1:0)"
"RTN","PSDORN",47,0)
 .S DA(1)=+NAOU,DIC="^PSD(58.8,"_NAOU_",1,"
"RTN","PSDORN",48,0)
 D ^DIC K DIC G:Y<0 END S PSDR=+Y,PSDRN=$S($P(^PSDRUG(PSDR,0),"^")]"":$P(^(0),"^"),1:"DRUG NAME MISSING")
"RTN","PSDORN",49,0)
 ;zero balance in vault
"RTN","PSDORN",50,0)
 I '$P($G(^PSD(58.8,+PSDS,1,PSDR,0)),U,4) D ENS^%ZISS W IOBON,!!,?20,"ZERO BALANCE IN PHARMACY",IOBOFF D KILL^%ZISS
"RTN","PSDORN",51,0)
 I $S('$D(^PSD(58.8,NAOU,1,PSDR,0)):1,$P(^(0),U,14)&($P(^(0),U,14)'>DT):1,1:0) D ^PSDORNO G:$D(DIRUT) END G TYPE
"RTN","PSDORN",52,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,0)) S MSG=2 D MSG G END
"RTN","PSDORN",53,0)
 S NBKU=$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",8),NPKG=+$P(^(0),"^",9)
"RTN","PSDORN",54,0)
 I NBKU']"" S MSG1=3 D MSG G END
"RTN","PSDORN",55,0)
 I 'NPKG S MSG1=4 D MSG G END
"RTN","PSDORN",56,0)
 D LIST^PSDORL
"RTN","PSDORN",57,0)
 ;Perpetual?
"RTN","PSDORN",58,0)
 G:$P($G(^PSD(58.8,+NAOU,2)),U,5) ^PSDOR2
"RTN","PSDORN",59,0)
QTY K ORD S PSDOUT=0 W !!,"QUANTITY ("_NBKU_"/"_NPKG_"): "_NPKG_"// " R X:DTIME S PSDT(8)=X I '$T!(X["^") G END
"RTN","PSDORN",60,0)
 S DIR(0)="DA^NOW::AEFT",DIR("A")="Date/time required: "
"RTN","PSDORN",61,0)
 S DIR("?",1)="You are on the verge of creating a priority order."
"RTN","PSDORN",62,0)
 S DIR("?",2)="If this is a mistake, enter ""^"" to create a scheduled order, otherwise,"
"RTN","PSDORN",63,0)
 S DIR("?")="Pharmacy needs to know how soon you need this order."
"RTN","PSDORN",64,0)
 W ! D ^DIR K DIR G:$D(DIRUT) TYPE X ^DD("DD") S PSDT(9)=Y
"RTN","PSDORN",65,0)
 S:PSDT(8)="" PSDT(8)=NPKG I PSDT(8)=NPKG S PSDQTY=NPKG,CNT=0 D DIE^PSDORN0 G:$G(PSDOUT) END D ASK^PSDORN1 K PSDEM G:PSDOUT END G DRUG
"RTN","PSDORN",66,0)
 I PSDT(8)["?"!(PSDT(8)'?1.N)!(PSDT(8)#NPKG)!('PSDT(8)) W !!,"Quantity must be "_NPKG_" or a multiple of "_NPKG,! G QTY
"RTN","PSDORN",67,0)
 S CNT=PSDT(8)/NPKG W !!,"This will be "_CNT_" separate order requests.  The quantity is "_NPKG_" per request."
"RTN","PSDORN",68,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Do you want me to generate the "_CNT_" separate order requests",DIR("B")="YES",DIR("?",1)="Answer 'YES' to create the multiple order requests,"
"RTN","PSDORN",69,0)
 S DIR("?")="Answer 'NO' to edit your comments or '^' to quit." D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDORN",70,0)
 I 'Y W !,"No order request created.  You must edit quantity.",! G QTY
"RTN","PSDORN",71,0)
 I Y W !!,"The "_CNT_" requests are being created.  You must review every request.",! S PSDQTY=NPKG D  G:$G(PSDOUT) END D ^PSDORN1
"RTN","PSDORN",72,0)
 .F ORD=1:1:CNT W !!,"Creating your order request # "_ORD_" of "_CNT_" for "_PSDRN D DIE^PSDORN0 Q:$G(PSDOUT)  S ORD(ORD)=PSDA
"RTN","PSDORN",73,0)
 G:'PSDOUT DRUG
"RTN","PSDORN",74,0)
END K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1
"RTN","PSDORN",75,0)
 K NBKU,NPKG,OK,OKTYP,ORD,PSDA,PSDEM,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRN,PSDT,REQD,TEXT,TYPE,WORD,X,Y
"RTN","PSDORN",76,0)
 Q
"RTN","PSDORN",77,0)
MSG ;display error message
"RTN","PSDORN",78,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDORN",79,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDORN",80,0)
 Q
"RTN","PSDPDR")
0^6^B18434161^B17629765
"RTN","PSDPDR",1,0)
PSDPDR ;BIR/BJW-Narc Disp/Rec Report (in lieu of VA FORM 10-2321) ; 09 FEB 95
"RTN","PSDPDR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**69**;13 Feb 97;Build 13
"RTN","PSDPDR",3,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDPDR",4,0)
 ;
"RTN","PSDPDR",5,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDPDR",6,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDPDR",7,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"process/dispense narcotic supplies.",!!,"PSJ RPHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDPDR",8,0)
COPY ;ask vault, nursing or both
"RTN","PSDPDR",9,0)
 K DA,DIR,DIRUT S DIR(0)="SO^V:VAULT COPY ONLY;N:NURSING COPY ONLY;B:BOTH VAULT AND NURSING COPY"
"RTN","PSDPDR",10,0)
 S DIR("A")="Select Disp/Receiving Report(s) to Print"
"RTN","PSDPDR",11,0)
 S DIR("?",1)="Answer 'V' to print only the vault copy of this report,",DIR("?",2)="answer 'N' to print only the nursing copy  or",DIR("?")="answer 'B' to print both the vault and nursing copies."
"RTN","PSDPDR",12,0)
 D ^DIR K DIR
"RTN","PSDPDR",13,0)
 I $D(DIRUT) W !,"No report will be printed.",! G END
"RTN","PSDPDR",14,0)
 S PSDCPY=Y
"RTN","PSDPDR",15,0)
ASKD ;ask dispensing location
"RTN","PSDPDR",16,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDPDR",17,0)
 G:$P(PSDSITE,U,5) ASKN
"RTN","PSDPDR",18,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDPDR",19,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDPDR",20,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDPDR",21,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDPDR",22,0)
ASKN ;ask naou or group
"RTN","PSDPDR",23,0)
 W !!,?5,"Select one of the following:",!!,?10,"N",?20,"NAOU (One, Some, or ^ALL)",!,?10,"G",?20,"Group of NAOUs",!
"RTN","PSDPDR",24,0)
 K DA,DIR,DIRUT S DIR(0)="SOA^N:NAOU;G:Group of NAOUs",DIR("A")="Select Method: "
"RTN","PSDPDR",25,0)
 S DIR("?",1)="Enter 'N' to select one, some or ^ALL NAOU(s),",DIR("?")="enter 'G' to select a group of NAOUs, or '^' to quit"
"RTN","PSDPDR",26,0)
 D ^DIR K DIR G:$D(DIRUT) END S SEL=Y D NOW^%DTC S PSDT=X,PSDPT=+$E(%,1,12) K DA,DIC S CNT=0
"RTN","PSDPDR",27,0)
 I SEL="G" D GROUP G:'$D(PSDG) END G DEV
"RTN","PSDPDR",28,0)
 F  S DIC=58.8,DIC("A")="Select NAOU: ",DIC(0)="QEA",DIC("S")="I $P(^(0),""^"",2)=""N"",$P(^(0),""^"",4)=+PSDS" D ^DIC K DIC Q:Y<0  D
"RTN","PSDPDR",29,0)
 .S NAOU(+Y)="",CNT=CNT+1
"RTN","PSDPDR",30,0)
 I '$D(NAOU)&(X'="^ALL") G END
"RTN","PSDPDR",31,0)
 S:X="^ALL" ALL=1
"RTN","PSDPDR",32,0)
DEV ;ask device and queue info
"RTN","PSDPDR",33,0)
 W !,"This report is designed for a 132 column format.",!,"You may queue this report to print at a later time.",!!
"RTN","PSDPDR",34,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",9),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDPDR",35,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="QM",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDPDR",36,0)
 I $D(IO("Q")) K IO("Q") S PSDIO=ION,ZTIO="" K ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDPDR1",ZTDESC="Compile Narcotic Disp Report" D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDPDR",37,0)
 U IO G START^PSDPDR1
"RTN","PSDPDR",38,0)
END K %,%H,%I,%ZIS,ALL,C,CNT,COPY,COMM,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXPD,FLAG,LOT,MFG,NAOU,NODE,NUM
"RTN","PSDPDR",39,0)
 K OK,ORD,ORDN,POP,PSD,PSDCPY,PSDA,PSDDT,PSDEV,PSDG,PSDIO,PSDN,PSDNA,PSDPT,PSDR,PSDRN,PSDS,PSDSN,PSDT,PSDSN,PSDST,QTY,REQD,REQDT,SEL,STAT,STATN,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDPDR",40,0)
 K ^TMP("PSDRPT",$J) D ^%ZISC
"RTN","PSDPDR",41,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDPDR",42,0)
 Q
"RTN","PSDPDR",43,0)
GROUP ;select group of naous
"RTN","PSDPDR",44,0)
 K DA,DIC F  S DIC=58.2,DIC("A")="Select NAOU INVENTORY GROUP NAME: ",DIC(0)="QEA",DIC("S")="I $S($D(^PSI(58.2,""CS"",+Y)):1,1:0)" D ^DIC K DIC Q:Y<0  S PSDG(+Y)=""
"RTN","PSDPDR",45,0)
 Q
"RTN","PSDPDR",46,0)
SAVE S (ZTSAVE("PSDIO"),ZTSAVE("PSDT"),ZTSAVE("CNT"),ZTSAVE("PSDS"),ZTSAVE("PSDPT"),ZTSAVE("PSDCPY"))="" S:$D(PSDG) ZTSAVE("PSDG(")="" S:$D(NAOU) ZTSAVE("NAOU(")="" S:$D(ALL) ZTSAVE("ALL")=""
"RTN","PSDPDR",47,0)
 Q
"RTN","PSDPGS")
0^7^B22028447^B21156981
"RTN","PSDPGS",1,0)
PSDPGS ;BIR/JPW-Print Green Sheet (VA FORM 10-2638) ; 30 Aug 94
"RTN","PSDPGS",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**69**;13 Feb 97;Build 13
"RTN","PSDPGS",3,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDPGS",4,0)
 ;
"RTN","PSDPGS",5,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDPGS",6,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDPGS",7,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access",!,?12,"to print Green Sheets.",!!,"PSJ PHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDPGS",8,0)
ASKD ;ask dispensing location
"RTN","PSDPGS",9,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDPGS",10,0)
 I $P(PSDSITE,U,5) S PRT=+$P($G(^PSD(58.8,+PSDS,2)),"^",6),ASK=+$G(^(2.5)) G CHKD
"RTN","PSDPGS",11,0)
 W ! K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)",DIC("A")="Select Primary Dispensing Site: ",DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDPGS",12,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDPGS",13,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),PRT=+$P($G(^PSD(58.8,+PSDS,2)),"^",6),ASK=+$G(^PSD(58.8,+PSDS,2.5)),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDPGS",14,0)
CHKD I '$O(^PSD(58.8,+PSDS,1,0)) W !!,"There are no CS stocked drugs for your dispensing vault.",!! G END
"RTN","PSDPGS",15,0)
ONE ;asks print type
"RTN","PSDPGS",16,0)
 K DA,DIR,DIRUT S DIR(0)="S^N:NAOU(s);R:Range of Green Sheet Numbers;A:All Green Sheets",DIR("A")="Printing Method"
"RTN","PSDPGS",17,0)
 S DIR("?",1)="Answer 'N' to select printing by NAOU(s), 'R' to select a number range,",DIR("?",2)="answer 'A' to print ALL Green Sheets not previously printed",DIR("?")="or '^' to quit."
"RTN","PSDPGS",18,0)
 D ^DIR K DIR G:$D(DIRUT) END S ANS=Y
"RTN","PSDPGS",19,0)
 G:ANS="A" DEV G:ANS="N" SEL
"RTN","PSDPGS",20,0)
GS1 ;ask gs # range
"RTN","PSDPGS",21,0)
 W !!,"You may enter a Green Sheet # list and/or a Green Sheet # range.",!
"RTN","PSDPGS",22,0)
 W "NOTE: This response must be a list or range, e.g. 1,3,5 or 2-4,8.",!
"RTN","PSDPGS",23,0)
 K DA,DIR,DIRUT S DIR(0)="LOA^0:999999999",DIR("A")="Select Green Sheet #(s): "
"RTN","PSDPGS",24,0)
 D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDPGS",25,0)
 S PSD1="" F  S PSD1=$O(Y(PSD1)) Q:PSD1=""  S:$D(Y(PSD1)) PSD1(PSD1)=Y(PSD1) K Y(PSD1)
"RTN","PSDPGS",26,0)
 G DEV
"RTN","PSDPGS",27,0)
SEL ;sel naou or group
"RTN","PSDPGS",28,0)
 W !!,?5,"Select one of the following:",!!,?10,"N",?20,"NAOU (One, Some, or ^ALL)",!,?10,"G",?20,"Group of NAOUs",!
"RTN","PSDPGS",29,0)
 K DA,DIR,DIRUT S DIR(0)="SOA^N:NAOU;G:Group of NAOUs",DIR("A")="Select Method: "
"RTN","PSDPGS",30,0)
 S DIR("?",1)="Enter 'N' to select one, some or ^ALL NAOU(s),",DIR("?")="enter 'G' to select a group of NAOUs, or '^' to quit"
"RTN","PSDPGS",31,0)
 D ^DIR K DIR G:$D(DIRUT) END S SEL=Y D NOW^%DTC S PSDT=X K DA,DIC S CNT=0
"RTN","PSDPGS",32,0)
 I SEL="G" D GROUP G:'$D(PSDG) END G DEV
"RTN","PSDPGS",33,0)
 F  S DIC=58.8,DIC("A")="Select NAOU: ",DIC(0)="QEA",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$P(^(0),""^"",2)=""N""" D ^DIC K DIC Q:Y<0  D
"RTN","PSDPGS",34,0)
 .S NAOU(+Y)="",CNT=CNT+1
"RTN","PSDPGS",35,0)
 I '$D(NAOU)&(X'="^ALL") G END
"RTN","PSDPGS",36,0)
 S:X="^ALL" ALL=1
"RTN","PSDPGS",37,0)
DEV ;ask device and queue info
"RTN","PSDPGS",38,0)
 W $C(7),!!,"This report now prints on plain paper.",!,"Please check your printer before starting this report.",!!,"You may queue this report to print at a later time.",!!
"RTN","PSDPGS",39,0)
 S PSDCPI=10
"RTN","PSDPGS",40,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",8),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDPGS",41,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="Q",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDPGS",42,0)
 I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDPGS1",ZTDESC="Print Green Sheets (VA FORM 10-2638)" D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDPGS",43,0)
 U IO G START^PSDPGS1
"RTN","PSDPGS",44,0)
END K %ZIS,ALL,ANS,ASK,C,CNT,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXPD,IOP,JJ,LINE,LOOP,LOT,NAOU,NAOUN,NODE,NODE1
"RTN","PSDPGS",45,0)
 K OK,ORD,ORDN,POP,PRT,PSD,PSD1,PSDA,PSDBY,PSDBYN,PSDCPI,PSDCNT,PSDDT,PSDEV,PSDG,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDSN,PSDT
"RTN","PSDPGS",46,0)
 K QTY,SEL,SITE,STAT,X,Y,ZTDESC,ZTDTH,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDPGS",47,0)
 K ^TMP("PSDPGS",$J)
"RTN","PSDPGS",48,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDPGS",49,0)
 Q
"RTN","PSDPGS",50,0)
SAVE ;saves queued variables
"RTN","PSDPGS",51,0)
 S (ZTSAVE("ASK"),ZTSAVE("ANS"),ZTSAVE("PSDSITE"),ZTSAVE("PSDS"),ZTSAVE("PSDSN"),ZTSAVE("PSDCPI"))="" S:$D(PRT) ZTSAVE("PRT")=""
"RTN","PSDPGS",52,0)
 S:$D(PSD1) ZTSAVE("PSD1(")="" S:$D(PSDG) ZTSAVE("PSDG(")=""
"RTN","PSDPGS",53,0)
 S:$D(ALL) ZTSAVE("ALL")=""
"RTN","PSDPGS",54,0)
 S:$D(NAOU) ZTSAVE("NAOU(")="" S:$D(CNT) ZTSAVE("CNT")=""
"RTN","PSDPGS",55,0)
 Q
"RTN","PSDPGS",56,0)
GROUP ;select group of naous
"RTN","PSDPGS",57,0)
 K DA,DIC F  S DIC=58.2,DIC("A")="Select NAOU INVENTORY GROUP NAME: ",DIC(0)="QEA",DIC("S")="I $S($D(^PSI(58.2,""CS"",+Y)):1,1:0)" D ^DIC K DIC Q:Y<0  S PSDG(+Y)=""
"RTN","PSDPGS",58,0)
 Q
"RTN","PSDPWK")
0^3^B23890736^B22973256
"RTN","PSDPWK",1,0)
PSDPWK ;BIR/JPW,BJW-Print Pharm Disp. Worksheet ; 3 Aug 98
"RTN","PSDPWK",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**10,69**;13 Feb 97;Build 13
"RTN","PSDPWK",3,0)
 ;refer to nois#:sdc-0597-60187
"RTN","PSDPWK",4,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDPWK",5,0)
 ;
"RTN","PSDPWK",6,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDPWK",7,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDPWK",8,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"process/dispense narcotic supplies.",!!,"PSJ RPHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDPWK",9,0)
 W !!,"=>  This report lists all pending CS requests for a dispensing site.",!!
"RTN","PSDPWK",10,0)
 I '$O(^PSD(58.85,0)) W $C(7),!!,"There are no pending request orders.",!! K OK Q
"RTN","PSDPWK",11,0)
SUM ;ask worksheet, summary or both
"RTN","PSDPWK",12,0)
 K DA,DIR,DIRUT S DIR(0)="SO^W:WORKSHEET ONLY;S:SUMMARY TOTALS ONLY;B:BOTH WORKSHEET AND SUMMARY TOTALS"
"RTN","PSDPWK",13,0)
 S DIR("A")="Select Worksheet Report(s) to Print"
"RTN","PSDPWK",14,0)
 S DIR("?",1)="Answer 'W' to print only the worksheet for this report,",DIR("?",2)="answer 'S' to print only the summary totals, or",DIR("?")="answer 'B' to print the worksheet and the summary totals."
"RTN","PSDPWK",15,0)
 D ^DIR K DIR G:$D(DIRUT) END S SUM=Y
"RTN","PSDPWK",16,0)
ASKD ;ask disp location
"RTN","PSDPWK",17,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDPWK",18,0)
 I $P(PSDSITE,U,5) S PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) G CHKD
"RTN","PSDPWK",19,0)
 W ! K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)",DIC("A")="Select Primary Dispensing Site: ",DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDPWK",20,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDPWK",21,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),PSDS=PSDS_"^"_+$P(Y(0),"^",5)
"RTN","PSDPWK",22,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDPWK",23,0)
CHKD I '$O(^PSD(58.85,"AE",+PSDS,0)) W !!,"There are no pending CS requests for "_PSDSN_".",!! G END
"RTN","PSDPWK",24,0)
ASKN ;ask naou or group
"RTN","PSDPWK",25,0)
 W !!,?5,"Select one of the following:",!!,?10,"N",?20,"NAOU (One, Some, or ^ALL)",!,?10,"G",?20,"Group of NAOUs",!
"RTN","PSDPWK",26,0)
 K DA,DIR,DIRUT S DIR(0)="SOA^N:NAOU;G:Group of NAOUs",DIR("A")="Select Method: "
"RTN","PSDPWK",27,0)
 S DIR("?",1)="Enter 'N' to select one, some or ^ALL NAOU(s).",DIR("?")="Enter 'G' to select a group of NAOUs, or '^' to quit"
"RTN","PSDPWK",28,0)
 D ^DIR K DIR
"RTN","PSDPWK",29,0)
 I $D(DIRUT),X="^ALL" S ALL=1,CNT=0,SEL="N" D NOW^%DTC S PSDT=X G SORT
"RTN","PSDPWK",30,0)
 I $D(DIRUT) G END
"RTN","PSDPWK",31,0)
 S SEL=Y D NOW^%DTC S PSDT=X K DA,DIC S CNT=0
"RTN","PSDPWK",32,0)
 I SEL="G" D GROUP G:'$D(PSDG) END G SORT
"RTN","PSDPWK",33,0)
 F  S DIC=58.8,DIC("A")="Select NAOU: ",DIC(0)="QEA",DIC("S")="I $P(^(0),""^"",2)=""N"",$P(^(0),""^"",4)=+PSDS" D ^DIC K DIC Q:Y<0  D
"RTN","PSDPWK",34,0)
 .S NAOU(+Y)="",CNT=CNT+1
"RTN","PSDPWK",35,0)
 I '$D(NAOU)&(X'="^ALL") G END
"RTN","PSDPWK",36,0)
 S:X="^ALL" ALL=1
"RTN","PSDPWK",37,0)
SORT ;asks sort
"RTN","PSDPWK",38,0)
 S ANS=$P($G(^PSD(58.8,+PSDS,2)),"^",7)
"RTN","PSDPWK",39,0)
 I (ANS="D")!(ANS="N") G DEV
"RTN","PSDPWK",40,0)
 K DA,DIR,DIRUT S DIR(0)="SO^D:DRUG/NAOU;N:NAOU/DRUG",DIR("A",1)="You may print by either of these sorting methods."
"RTN","PSDPWK",41,0)
 S DIR("?",1)="Enter 'D' to print the worksheet sorted by DRUG then NAOU",DIR("?")="Enter 'N' to print the worksheet sorted by NAOU then DRUG."
"RTN","PSDPWK",42,0)
 S DIR("A")="Select SORT ORDER for Worksheet" D ^DIR K DIR G:$D(DIRUT) END S ANS=Y
"RTN","PSDPWK",43,0)
DEV ;ask device and queue info
"RTN","PSDPWK",44,0)
 ;chgd L4 to s psdio=ion_";"_iost
"RTN","PSDPWK",45,0)
 W !!,"This report is designed for a 132 column format.",!,"You may queue this report to print at a later time.",!!
"RTN","PSDPWK",46,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",9),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDPWK",47,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="QM",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDPWK",48,0)
 I $D(IO("Q")) K IO("Q") S PSDIO=ION_";"_IOST,ZTIO="" K ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDPWK1",ZTDESC="Compile Worksheet for CS PHARM" D SAVE,^%ZTLOAD K ZTSK G END
"RTN","PSDPWK",49,0)
 U IO G START^PSDPWK1
"RTN","PSDPWK",50,0)
END K %,%H,%I,%ZIS,ALL,ANS,C,CNT,COMM,DA,DIC,DIR,DIROUT,DIRUT,DTOUT,DUOUT,IO("Q"),JJ,JJ1,JJDA,LOOP,LOOP2,NAOU,NODE,OK,ORD,ORDN
"RTN","PSDPWK",51,0)
 K POP,PRT,PSD,PSDCPY,PSDEV,PSDG,PSDIO,PSDN,PSDNA,PSDR,PSDRN,PSDS,PSDSN,PSDT
"RTN","PSDPWK",52,0)
 K QTY,SEL,SUM,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK,^TMP("PSDWK",$J),^TMP("PSDWKT",$J) D ^%ZISC
"RTN","PSDPWK",53,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDPWK",54,0)
 Q
"RTN","PSDPWK",55,0)
GROUP ;select group of naous
"RTN","PSDPWK",56,0)
 K DA,DIC F  S DIC=58.2,DIC("A")="Select NAOU INVENTORY GROUP NAME: ",DIC(0)="QEA",DIC("S")="I $S($D(^PSI(58.2,""CS"",+Y)):1,1:0)" D ^DIC K DIC Q:Y<0  S PSDG(+Y)=""
"RTN","PSDPWK",57,0)
 Q
"RTN","PSDPWK",58,0)
SAVE S (ZTSAVE("PSDT"),ZTSAVE("PSDIO"),ZTSAVE("ANS"),ZTSAVE("CNT"),ZTSAVE("PSDS"),ZTSAVE("PSDSN"),ZTSAVE("SUM"),ZTSAVE("PSDSITE"))=""
"RTN","PSDPWK",59,0)
 S:$D(PSDG) ZTSAVE("PSDG(")="" S:$D(NAOU) ZTSAVE("NAOU(")="" S:$D(ALL) ZTSAVE("ALL")=""
"RTN","PSDPWK",60,0)
 Q
"RTN","PSDRDR")
0^8^B24114664^B23194624
"RTN","PSDRDR",1,0)
PSDRDR ;BIR/BJW-Narc Disp/Rec Report (reprint VA FORM 10-2321) ; 12 Feb 98
"RTN","PSDRDR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,69**;13 Feb 97;Build 13
"RTN","PSDRDR",3,0)
 ;**Y2K compliance**,"P" added to date input string
"RTN","PSDRDR",4,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDRDR",5,0)
 ;
"RTN","PSDRDR",6,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRDR",7,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDRDR",8,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"process/dispense narcotic supplies.",!!,"PSJ RPHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDRDR",9,0)
ASKD ;ask dispensing location
"RTN","PSDRDR",10,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDRDR",11,0)
 G:$P(PSDSITE,U,5) SUM
"RTN","PSDRDR",12,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDRDR",13,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDRDR",14,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDRDR",15,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDRDR",16,0)
SUM ;if ret-to-stock or turn in for dest
"RTN","PSDRDR",17,0)
 K DA,DIR,DIRUT W ! S DIR(0)="Y",DIR("A")="Is this a Return to Stock or Turn in for Destruction Reprint",DIR("B")="NO"
"RTN","PSDRDR",18,0)
 S DIR("?",1)="Answer 'YES' to select a Return to Stock or Turn in for Destruction form,",DIR("?")="answer 'NO' to print a dispensing VA FORM 10-2321."
"RTN","PSDRDR",19,0)
 D ^DIR K DIR G:$D(DIRUT) END S SUM=Y G:SUM TYPE^PSDRPT
"RTN","PSDRDR",20,0)
COPY ;ask vault, nursing or both
"RTN","PSDRDR",21,0)
 K DA,DIR,DIRUT S DIR(0)="SO^V:VAULT COPY ONLY;N:NURSING COPY ONLY;B:BOTH VAULT AND NURSING COPY"
"RTN","PSDRDR",22,0)
 S DIR("A")="Select Disp/Receiving Report(s) to Print"
"RTN","PSDRDR",23,0)
 S DIR("?",1)="Answer 'V' to print only the vault copy of this report,",DIR("?",2)="answer 'N' to print only the nursing copy, or",DIR("?")="answer 'B' to print both the vault and nursing copies."
"RTN","PSDRDR",24,0)
 D ^DIR K DIR
"RTN","PSDRDR",25,0)
 I $D(DIRUT) W !,"No report will be printed.",! G END
"RTN","PSDRDR",26,0)
 S PSDCPY=Y
"RTN","PSDRDR",27,0)
ASKN ;ask naou or green sheet number
"RTN","PSDRDR",28,0)
 K DA,DIR,DIRUT S DIR(0)="SO^N:NAOU;G:Green Sheet #",DIR("A")="Select Method"
"RTN","PSDRDR",29,0)
 S DIR("?",1)="Enter 'N' to select one, several, or ^ALL NAOUs,",DIR("?")="enter 'G' to select a Green Sheet #, or '^' to quit"
"RTN","PSDRDR",30,0)
 D ^DIR K DIR G:$D(DIRUT) END S SEL=Y
"RTN","PSDRDR",31,0)
 I SEL="G" W ! K DA,DIC S DIC("A")="Select Green Sheet #: ",DIC=58.81,D="D",DIC(0)="QEAS",DIC("S")="I $P(^(0),""^"",3)=+PSDS" D IX^DIC G:Y<0 END S PSDA=+Y G DEV
"RTN","PSDRDR",32,0)
NAOU ;sel naou
"RTN","PSDRDR",33,0)
 W !!,?5,"You may select a single NAOU, several NAOUs,",!,?5,"or enter ^ALL to select all NAOUs.",!!
"RTN","PSDRDR",34,0)
 F  S DIC=58.8,DIC("A")="Select NAOU: ",DIC(0)="QEA",DIC("S")="I $P(^(0),""^"",2)=""N"",$P(^(0),""^"",4)=+PSDS" D ^DIC K DIC Q:Y<0  S NAOU(+Y)=""
"RTN","PSDRDR",35,0)
 I '$D(NAOU)&(X'="^ALL") G END
"RTN","PSDRDR",36,0)
 I X="^ALL" F PSD=0:0 S PSD=$O(^PSD(58.8,PSD)) Q:'PSD  I $P($G(^PSD(58.8,PSD,0)),"^",2)="N",$P($G(^(0)),"^",4)=+PSDS S NAOU(PSD)=""
"RTN","PSDRDR",37,0)
DATE ;asks date range if naou is selected
"RTN","PSDRDR",38,0)
 W !!,"Please enter the DATE and TIME period you wish to reprint data for this report",!
"RTN","PSDRDR",39,0)
 W ! K %DT S %DT="AEPRXT",%DT("A")="Start with Date/Time: " D ^%DT I Y<0 S PSDOUT=1 G END
"RTN","PSDRDR",40,0)
 S PSDSD=Y D D^DIQ S PSDATE=Y,%DT("A")="End with Date/Time: " D ^%DT I Y<0 S PSDOUT=1 G END
"RTN","PSDRDR",41,0)
 I Y<PSDSD W !!,"The ending date of the range must be later than the starting date." G DATE
"RTN","PSDRDR",42,0)
 S PSDED=Y D D^DIQ S PSDATE=PSDATE_"^"_Y,PSDSD=PSDSD-.0001,PSDED=PSDED+.0001
"RTN","PSDRDR",43,0)
DEV ;ask device and queue info
"RTN","PSDRDR",44,0)
 W !,"This report is designed for a 132 column format.",!,"You may queue this report to print at a later time.",!!
"RTN","PSDRDR",45,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",9),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDRDR",46,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="QM",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDRDR",47,0)
 I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDRDR1",ZTDESC="Reprint Narcotic Disp Report" D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDRDR",48,0)
 U IO G START^PSDRDR1
"RTN","PSDRDR",49,0)
END K %,%I,%H,%ZIS,C,COMM,COPY,D,DA,DIC,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DRUG,DRUGN,DTOUT,DUOUT,EXP,EXPD,FLAG,LN,LOOP,LOT,MFG,NAOU,NAOUN,NODE,NUM,OK,ORD,ORDN
"RTN","PSDRDR",50,0)
 K PG,PHARM,PHARMN,PSD,PSDA,PSDATE,PSDCPY,PSDDT,PSDED,PSDEV,PSDN,PSDNA,PSDOUT,PSDS,PSDSD,PSDSN,PSDST,QTY,REC,RECN,REQD,REQDT,RPDT,SEL,SUM,TEXT,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDRDR",51,0)
 K ^TMP("PSDRDR",$J) D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDRDR",52,0)
 Q
"RTN","PSDRDR",53,0)
SAVE S (ZTSAVE("PSDATE"),ZTSAVE("PSDSD"),ZTSAVE("PSDED"),ZTSAVE("PSDSN"),ZTSAVE("PSDS"),ZTSAVE("PSDCPY"))=""
"RTN","PSDRDR",54,0)
 S:$D(NAOU) ZTSAVE("NAOU(")="" S:$D(PSDA) ZTSAVE("PSDA")=""
"RTN","PSDRDR",55,0)
 Q
"RTN","PSDREC")
0^2^B19747505^B18294703
"RTN","PSDREC",1,0)
PSDREC ;BIR/LTL-CS Receiving ; 6 July 94
"RTN","PSDREC",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**69**;13 Feb 97;Build 13
"RTN","PSDREC",3,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDREC",4,0)
 ;References to file 58.81 covered by DBIA #2808
"RTN","PSDREC",5,0)
 ;References to ^PRC(442, covered by DBIA#682
"RTN","PSDREC",6,0)
 ;
"RTN","PSDREC",7,0)
 I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) QUIT
"RTN","PSDREC",8,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)),'$D(^XUSEC("PSD TECH ADV",DUZ)) W !!,"Sorry, you need either the PSJ RPHARM or PSD TECH ADV Security key",!,"to do receiving.",!! G QUIT
"RTN","PSDREC",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G QUIT
"RTN","PSDREC",10,0)
SETUP D DT^DICRW N C,D,D0,DA,DIC,DINUM,DIE,DIR,DIRUT,DLAYGO,DR,DTOUT,DUOUT,DZ,PSDAT,PSDB,PSDI,PSDIT,PSDW,PSDLOC,PSDLOCN,PSDOUT,PSDP,PSDPI,PSDS,PSDCON,PSDL,PSDPO,PSDREC,PSDRUG,PSDRUGN,PSDT,PSAPV,X,Y,%,%H,%I S PSDL=0,(PSDI,PSDPO)=""
"RTN","PSDREC",11,0)
 D NOW^%DTC S PSDAT=+$E(%,1,12)
"RTN","PSDREC",12,0)
 S PSDLOC=$P(PSDSITE,U,3),PSDLOCN=$P(PSDSITE,U,4)
"RTN","PSDREC",13,0)
 G:$P(PSDSITE,U,5) CHKD
"RTN","PSDREC",14,0)
LOOK S DIC="^PSD(58.8,",DIC(0)="AEQ",DIC("A")="Select Dispensing Site: "
"RTN","PSDREC",15,0)
 S DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$P($G(^(0)),U,2)[""M""&($S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0))"
"RTN","PSDREC",16,0)
 S:$P($G(^PSD(58.8,+PSDLOC,0)),U,2)["M" DIC("B")=PSDLOCN
"RTN","PSDREC",17,0)
 D ^DIC K DIC G:Y<0 QUIT S PSDLOC=+Y,PSDLOCN=$P(Y,U,2)
"RTN","PSDREC",18,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=$P(Y,U,2)
"RTN","PSDREC",19,0)
CHKD D:$P($G(^PSD(58.8,PSDLOC,0)),U,8)=1  G:$D(DIRUT) QUIT
"RTN","PSDREC",20,0)
PV .W ! S DIR(0)="Y",DIR("A")="Is this a Prime Vendor receipt",DIR("B")="Yes",DIR("?")="If so, I'll retrieve the current Prime Vendor P.O.# for this Dispensing Site." D ^DIR K DIR Q:$D(DIRUT)!(Y<1)  S:Y=1 PSAPV=1
"RTN","PSDREC",21,0)
 .S (PSDPO,Y)=$P($G(^PSD(58.8,+PSDLOC,0)),U,9),C=$P(^DD(58.8,13,0),U,2)
"RTN","PSDREC",22,0)
 .D Y^DIQ S DIC("B")=Y
"RTN","PSDREC",23,0)
 .I +$E($P($G(^PRC(442,+PSDPO,12)),U,5),4,5)'=+$E(DT,4,5) W !!,"Current Prime Vendor P.O.#: ",Y,?40 S Y=$P($G(^(12)),U,5) X ^DD("DD") W "Date Assigned: ",Y
"RTN","PSDREC",24,0)
 I '$O(^PSD(58.8,PSDLOC,1,0)) W !!,"There are no drugs in ",PSDLOCN G QUIT
"RTN","PSDREC",25,0)
PO W ! S DIC="^PRC(442,",DIC(0)="AEMQZ" S:'$G(DIC("B")) DIC("B")=$G(PSDPO)
"RTN","PSDREC",26,0)
 S DIC("A")="Select Pharmacy Purchase Order Number: ",DIC("S")="I $P($G(^(0)),U,5)[822400" D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT)) QUIT S:Y>0 PSDPO=+Y I Y<1 S PSDPO(1)=0 G ^PSDREC2
"RTN","PSDREC",27,0)
 S PSDCON=$P($G(Y(0)),U,12)
"RTN","PSDREC",28,0)
 I $G(PSAPV),PSDPO'=$P($G(^PSD(58.8,+PSDLOC,0)),U,9) S DIE="^PSD(58.8,",DA=PSDLOC,DR="13////"_PSDPO D ^DIE K DIE,DA,DR
"RTN","PSDREC",29,0)
LINE I '$O(^PRC(442,+PSDPO,2,0)) W !!,"No line items on this P.O.",!! S PSDPO(1)=0 G ^PSDREC2
"RTN","PSDREC",30,0)
 I '$O(^PRC(442,+PSDPO,2,1)),'$P($G(^PRC(442,+PSDPO,2,1,0)),U,5) S PSDPO(1)=0 G ^PSDREC2
"RTN","PSDREC",31,0)
PART I '$O(^PRC(442,+PSDPO,11,0)) W !!,"No receipts processed for this P.O.",!! S PSDPO(1)=0 G ^PSDREC2
"RTN","PSDREC",32,0)
PRE I $O(^PSD(58.81,"C",PSDPO,"")) W !!,"Previous receipts have been processed for this P.O.",! S DIR(0)="Y",DIR("A")="Would you like to review them before proceeding",DIR("B")="Yes" D ^DIR K DIR G:$D(DIRUT) QUIT G:Y=1 DEV^PSDREV
"RTN","PSDREC",33,0)
CHO S DIR(0)="Y",DIR("A")="Loop through all items for a selected receipt",DIR("B")="Yes",DIR("?")="If not, I will ask you to select the item(s) to receive."
"RTN","PSDREC",34,0)
 S DIR("??")="^W !!,""If you plan on receiving only certain items, you may prefer NOT to loop."""
"RTN","PSDREC",35,0)
 W ! D ^DIR K DIR
"RTN","PSDREC",36,0)
 Q:$D(DIRUT)  G:'Y ^PSDREC3
"RTN","PSDREC",37,0)
 S PSDPI=$O(^PRC(442,+PSDPO,11,0)),PSDP=$P($G(^PRC(442,+PSDPO,11,+PSDPI,0)),U),Y=1 D:$O(^PRC(442,+PSDPO,11,PSDPI))
"RTN","PSDREC",38,0)
PSEL .S DIC="^PRC(442,+PSDPO,11,",DA(1)=PSDPO,DIC(0)="AEMQ",DIC("A")="Please select Warehouse receipt date: ",DIC("B")=$P($G(^PRC(442,+PSDPO,11,+$P($G(^PRC(442,+PSDPO,11,0)),U,3),0)),U),D="B",DZ="??" D DQ^DICQ
"RTN","PSDREC",39,0)
 .W ! D ^DIC K DIC S PSDPI=+Y,PSDP=$P(Y,U,2)
"RTN","PSDREC",40,0)
 D:Y>0 ^PSDREC1 S PSDPO="" G PO
"RTN","PSDREC",41,0)
QUIT Q
"RTN","PSDREPD")
0^19^B35512558^B33235852
"RTN","PSDREPD",1,0)
PSDREPD ;BIR/BJW-Invoice Review by Date Range ; 12 Feb 98
"RTN","PSDREPD",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**6,8,69**;13 Feb 97;Build 13
"RTN","PSDREPD",3,0)
 ;chgs made for drug acct 8 Oct 97
"RTN","PSDREPD",4,0)
 ;**Y2K compliance**,"P" added to date input string
"RTN","PSDREPD",5,0)
 ;References to ^PRC(442 are covered by DBIA#682
"RTN","PSDREPD",6,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDREPD",7,0)
 ;References to ^PSD(58.81 are covered by DBIA2808
"RTN","PSDREPD",8,0)
 ;References to ^PSDRUG( are covered by DBIA221
"RTN","PSDREPD",9,0)
 ;
"RTN","PSDREPD",10,0)
 I '$D(PSDSITE) W ! D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDREPD",11,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)),'$D(^XUSEC("PSD TECH ADV",DUZ)) D  Q
"RTN","PSDREPD",12,0)
 .W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to print",!,?12,"the Invoice Review Report. Either the PSJ RPHARM or PSD TECH ADV",!?12,"security key required.",!
"RTN","PSDREPD",13,0)
 S PSDS=0 F  S PSDS=$O(^PSD(58.8,"ADISP","M",PSDS)) Q:'PSDS  I $P($G(^PSD(58.8,+PSDS,0)),"^",3)=+PSDSITE&('$G(^PSD(58.8,+PSDS,"I"))!($G(^PSD(58.8,+PSDS,"I"))>DT)) S PSDC=$G(PSDC)+1,PSDONE=PSDS
"RTN","PSDREPD",14,0)
 I '$G(PSDC) W !!,"Sorry, no Master Vaults set up for this site.",!! G END
"RTN","PSDREPD",15,0)
 S:PSDC=1 PSDS=PSDONE
"RTN","PSDREPD",16,0)
 I PSDC>1 D  G:Y<1 END S PSDS=+Y W !
"RTN","PSDREPD",17,0)
 .S DIC="^PSD(58.8,",DIC(0)="AEQ",DIC("A")="Select Dispensing Site: "
"RTN","PSDREPD",18,0)
 .S:$P($G(^PSD(58.8,+$P(PSDSITE,"^",3),0)),"^",2)["M" DIC("B")=$P(PSDSITE,"^",4)
"RTN","PSDREPD",19,0)
 .S DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$P($G(^(0)),U,2)[""M"",$S('$G(^(""I"")):1,+^(""I"")>DT:1,1:0)"
"RTN","PSDREPD",20,0)
 .W ! D ^DIC K DIC S $P(PSDSITE,"^",3)=+Y,$P(PSDSITE,"^",4)=$P(Y,"^",2)
"RTN","PSDREPD",21,0)
 W !,"Select Invoice Date Range",!
"RTN","PSDREPD",22,0)
DATE ;ask date range
"RTN","PSDREPD",23,0)
 K %DT S %DT="AEP",%DT("A")="Start with Date: " D ^%DT I Y<0 S PSDOUT=1 G END
"RTN","PSDREPD",24,0)
 S PSDSD=Y D D^DIQ S PSDATE=Y,%DT("A")="End with Date: " W ! D ^%DT I Y<0 S PSDOUT=1 G END
"RTN","PSDREPD",25,0)
 I Y<PSDSD W !!,"The ending date of the range must be later than the starting date." G DATE
"RTN","PSDREPD",26,0)
 S PSDED=Y D D^DIQ S PSDATE=PSDATE_"^"_Y,PSDSD=PSDSD-.0001,PSDED=PSDED+.9999
"RTN","PSDREPD",27,0)
SUM ;if summary only
"RTN","PSDREPD",28,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Do you want to print the invoice numbers only",DIR("B")="NO"
"RTN","PSDREPD",29,0)
 S DIR("?",1)="Answer 'YES' to print only the invoice numbers for this report,",DIR("?")="answer 'NO' to print the detailed report including drug totals."
"RTN","PSDREPD",30,0)
 D ^DIR K DIR G:$D(DIRUT) END S PSDSUM=Y
"RTN","PSDREPD",31,0)
 D NOW^%DTC S PSDT=X,Y=% X ^DD("DD") S PSDT(1)=Y
"RTN","PSDREPD",32,0)
DEV ;asks device and queueing information
"RTN","PSDREPD",33,0)
 W !!,"This report is designed for a 80 column format.",!,"You may queue this report to print at a later time.",!
"RTN","PSDREPD",34,0)
 S Y=$P($G(^PSD(58.8,+$P(PSDSITE,"^",3),2)),"^",9),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDREPD",35,0)
 K %ZIS,IOP,IO("Q") S %ZIS="QM",%ZIS("B")=PSDEV D ^%ZIS
"RTN","PSDREPD",36,0)
 I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSDOUT=1 G END
"RTN","PSDREPD",37,0)
 I $D(IO("Q")) D  G END
"RTN","PSDREPD",38,0)
 .K IO("Q") S ZTIO=ION,ZTRTN="START^PSDREPD",ZTDESC="CS Invoice Report data"
"RTN","PSDREPD",39,0)
 .S ZTSAVE("PSDSUM")="",ZTSAVE("PSDSITE")="",ZTSAVE("PSD*")=""
"RTN","PSDREPD",40,0)
 .D ^%ZTLOAD,HOME^%ZIS K ZTSK S PSDOUT=1
"RTN","PSDREPD",41,0)
 U IO
"RTN","PSDREPD",42,0)
START S (PSDPG,PSDOUT)=0,PSDSD(1)=PSDSD,$P(PSDSLN,"-",81)="" D HDR  G:PSDOUT END
"RTN","PSDREPD",43,0)
 F  S PSDSD=$O(^PSD(58.81,"AF",PSDSD)) Q:PSDSD>PSDED!('PSDSD)!(PSDOUT)  S PSDTR=0 F  S PSDTR=$O(^PSD(58.81,"AF",PSDSD,PSDS,1,PSDTR)) Q:'PSDTR!(PSDOUT)  D
"RTN","PSDREPD",44,0)
 .S PSD0=$G(^PSD(58.81,+PSDTR,0)),PSDINV=$P($G(^PSD(58.81,+PSDTR,8)),"^")
"RTN","PSDREPD",45,0)
 .S PSDORD=$S(+$P(PSD0,"^",9)&($P($G(^PRC(442,+$P(PSD0,"^",9),0)),"^")'=""):$P($G(^PRC(442,+$P(PSD0,"^",9),0)),"^"),$P($G(^PSD(58.81,+PSDTR,8)),"^",2)'="":$P($G(^PSD(58.81,+PSDTR,8)),"^",2),1:"UNKNOWN")
"RTN","PSDREPD",46,0)
 .Q:PSDINV=""  S:'$D(^TMP("PSD",$J,PSDINV,PSDORD)) ^TMP("PSD",$J,PSDINV,PSDORD)=0
"RTN","PSDREPD",47,0)
 ;
"RTN","PSDREPD",48,0)
 I PSDSUM S PSDINV="" D  G END
"RTN","PSDREPD",49,0)
 .F  S PSDINV=$O(^TMP("PSD",$J,PSDINV)) Q:PSDINV=""!(PSDOUT)  S PSDFND=0,PSDORD="" D
"RTN","PSDREPD",50,0)
 ..F  S PSDORD=$O(^TMP("PSD",$J,PSDINV,PSDORD)) Q:PSDORD=""!(PSDOUT)  D
"RTN","PSDREPD",51,0)
 ...S PSDTR=0 F  S PSDTR=+$O(^PSD(58.81,"PV",PSDINV,PSDTR)) Q:'PSDTR  S PSD0=$G(^PSD(58.81,PSDTR,0)) D:$P(PSD0,"^",4)>PSDSD(1)&($P(PSD0,"^",4)'>PSDED)  Q:PSDOUT!(PSDFND)
"RTN","PSDREPD",52,0)
 ....Q:PSDORD'=$P($G(^PRC(442,+$P(PSD0,"^",9),0)),"^")&(PSDORD'=$P($G(^PSD(58.81,PSDTR,8)),"^",2))
"RTN","PSDREPD",53,0)
 ....Q:'+$P($G(^PSD(58.81,PSDTR,"CS")),"^")
"RTN","PSDREPD",54,0)
 ....D:$Y+5>IOSL HEADER Q:PSDOUT  S PSDDT=$P(PSD0,"^",4)
"RTN","PSDREPD",55,0)
 ....W !!,$$FMTE^XLFDT(PSDDT,"1P"),?26,PSDINV,?38,PSDORD,?54
"RTN","PSDREPD",56,0)
 ....W $E($P($G(^VA(200,+$P(PSD0,"^",7),0)),"^"),1,26) S PSDFND=1
"RTN","PSDREPD",57,0)
 ;
"RTN","PSDREPD",58,0)
 S PSDINV="" F  S PSDINV=$O(^TMP("PSD",$J,PSDINV)) Q:PSDINV=""!(PSDOUT)  S PSDORD="" D
"RTN","PSDREPD",59,0)
 .F  S PSDORD=$O(^TMP("PSD",$J,PSDINV,PSDORD)) Q:PSDORD=""!(PSDOUT)  D
"RTN","PSDREPD",60,0)
 ..S PSDFIRST=2,PSDTR=0 F  S PSDTR=+$O(^PSD(58.81,"PV",PSDINV,PSDTR)) Q:'PSDTR  S PSD0=$G(^PSD(58.81,PSDTR,0)) D:$P(PSD0,"^",4)>PSDSD(1)&($P(PSD0,"^",4)'>PSDED)  Q:PSDOUT
"RTN","PSDREPD",61,0)
 ...Q:PSDORD'=$P($G(^PRC(442,+$P(PSD0,"^",9),0)),"^")&(PSDORD'=$P($G(^PSD(58.81,PSDTR,8)),"^",2))
"RTN","PSDREPD",62,0)
 ...Q:'+$P($G(^PSD(58.81,PSDTR,"CS")),"^")
"RTN","PSDREPD",63,0)
 ...I $Y+5>IOSL D HEADER Q:PSDOUT
"RTN","PSDREPD",64,0)
 ...I PSDFIRST=2 W !!,"Invoice Number ==>  ",PSDINV,"  Order Number ==> ",PSDORD S PSDFIRST=0
"RTN","PSDREPD",65,0)
 ...I PSDFIRST=1 W !!,"Invoice Number ==>  ",PSDINV,"  Order Number ==> ",PSDORD W " (Continued)" S PSDFIRST=0
"RTN","PSDREPD",66,0)
 ...W !!,$E($P($G(^PSDRUG(+$P(PSD0,"^",5),0)),"^"),1,30),?32
"RTN","PSDREPD",67,0)
 ...W $J($P(PSD0,"^",6),8),?41
"RTN","PSDREPD",68,0)
 ...W $P($G(^PSDRUG(+$P(PSD0,"^",5),660)),"^",8),?50
"RTN","PSDREPD",69,0)
 ...W $E($P($G(^VA(200,+$P(PSD0,"^",7),0)),"^"),1,18),?72
"RTN","PSDREPD",70,0)
 ...W $$FMTE^XLFDT($P(PSD0,"^",4),"2D")
"RTN","PSDREPD",71,0)
 ;
"RTN","PSDREPD",72,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSDREPD",73,0)
 I $E(IOST)="C",'$G(PSDOUT) D
"RTN","PSDREPD",74,0)
 .S PSDSS=21-$Y F PSDKK=1:1:PSDSS W !
"RTN","PSDREPD",75,0)
 .S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR S:$G(DIRUT) PSDOUT=1 W @IOF
"RTN","PSDREPD",76,0)
 K %,%DT,%H,%I,%ZIS,C,DA,DIR,DIRUT,DUOUT,DTOUT,IO("Q"),POP,PSD0,PSDATE,PSDC,PSDDT,PSDED,PSDEV,PSDFIRST,PSDFND
"RTN","PSDREPD",77,0)
 K PSDINV,PSDKK,PSDLOC,PSDONE,PSDORD,PSDOUT,PSDPG,PSDS,PSDSD,PSDSLN,PSDSS,PSDSUM,PSDT,PSDTR,X,Y,ZTDESC,ZTIO,ZTRTN,ZTSAVE,^TMP("PSD",$J)
"RTN","PSDREPD",78,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDREPD",79,0)
 Q
"RTN","PSDREPD",80,0)
HEADER ;prints header info
"RTN","PSDREPD",81,0)
 I $E(IOST,1,2)'="P-",PSDPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDREPD",82,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),"^"),"." S PSDOUT=1
"RTN","PSDREPD",83,0)
HDR W:$Y @IOF S PSDPG=PSDPG+1
"RTN","PSDREPD",84,0)
 W !?2,$E($S($P($G(^VA(200,+$G(DUZ),.1)),"^",4)]"":$P($G(^(.1)),"^",4),1:$P($P($G(^VA(200,+$G(DUZ),0)),"^"),",",2)),1,20),"'s Invoice Review From "
"RTN","PSDREPD",85,0)
 W $P(PSDATE,"^")," To ",$P(PSDATE,"^",2),?72,"Page ",PSDPG,!?2,$P($G(^PSD(58.8,PSDS,0)),"^"),!
"RTN","PSDREPD",86,0)
 W ?45,"Report Date:  ",PSDT(1)
"RTN","PSDREPD",87,0)
 I PSDSUM W !!,"Date",?26,"Invoice#",?38,"Order#",?50,"Received By",!,PSDSLN Q
"RTN","PSDREPD",88,0)
 W !!?5,"Drug",?34,"Quantity        Received By             Date",!,PSDSLN
"RTN","PSDREPD",89,0)
 S:PSDPG PSDFIRST=1
"RTN","PSDREPD",90,0)
 Q
"RTN","PSDRPGS")
0^10^B12664820^B11947150
"RTN","PSDRPGS",1,0)
PSDRPGS ;BIR/JPW-Reprint Green Sheet (VA FORM 10-2638) ; 29 Aug 94
"RTN","PSDRPGS",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**69**;13 Feb 97;Build 13
"RTN","PSDRPGS",3,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDRPGS",4,0)
 ;
"RTN","PSDRPGS",5,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRPGS",6,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDRPGS",7,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"reprint Green Sheets.",!!,"PSJ RPHARM or PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDRPGS",8,0)
ASKD ;ask dispensing location
"RTN","PSDRPGS",9,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDRPGS",10,0)
 I $P(PSDSITE,U,5) S PRT=+$P($G(^PSD(58.8,+PSDS,2)),"^",6),ASK=+$G(^(2.5)) G GS1
"RTN","PSDRPGS",11,0)
 W ! K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)",DIC("A")="Select Primary Dispensing Site: ",DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDRPGS",12,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDRPGS",13,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),PRT=+$P($G(^PSD(58.8,+PSDS,2)),"^",6),ASK=+$G(^PSD(58.8,+PSDS,2.5)),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDRPGS",14,0)
GS1 ;ask gs # range
"RTN","PSDRPGS",15,0)
 W !!,"You may enter a Green Sheet # list and/or a Green Sheet # range.",!
"RTN","PSDRPGS",16,0)
 W "NOTE: This response must be a list or range, e.g., 1,3,5 or 2-4,8.",!
"RTN","PSDRPGS",17,0)
 K DA,DIR,DIRUT S DIR(0)="LOA^0:999999999",DIR("A")="Select Green Sheet #(s): "
"RTN","PSDRPGS",18,0)
 D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRPGS",19,0)
 S PSD1="" F  S PSD1=$O(Y(PSD1)) Q:PSD1=""  S:$D(Y(PSD1)) PSD1(PSD1)=Y(PSD1) K Y(PSD1)
"RTN","PSDRPGS",20,0)
DEV ;ask device and queue info
"RTN","PSDRPGS",21,0)
 W $C(7),!!,"This report now prints on plain paper.",!,"Please check your printer before starting this report.",!!,"You may queue this report to print at a later time.",!!
"RTN","PSDRPGS",22,0)
 S PSDCPI=10
"RTN","PSDRPGS",23,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",8),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDRPGS",24,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="Q",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDRPGS",25,0)
 I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDRPGS2",ZTDESC="Reprint Green Sheets (VA FORM 10-2638)" D SAVE D ^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDRPGS",26,0)
 U IO G START^PSDRPGS2
"RTN","PSDRPGS",27,0)
END K %ZIS,ANS,ASK,C,CNT,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXPD,LINE,LOT,NAOU,NAOUN,NODE,NODE1,PSDW
"RTN","PSDRPGS",28,0)
 K OK,ORD,ORDN,POP,PRT,PSD,PSD1,PSDA,PSDBY,PSDBYN,PSDCNT,PSDDT,PSDEV,PSDOUT,PSDCPI,PSDPN,PSDR,PSDRN,PSDS,PSDSN,PSDT,PSDTR,PSDTRN,REPRINT,QTY,SITE,STAT,TRANS,Y,ZTDESC,ZTDTH,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDRPGS",29,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDRPGS",30,0)
 Q
"RTN","PSDRPGS",31,0)
SAVE ;save var
"RTN","PSDRPGS",32,0)
 S (ZTSAVE("ASK"),ZTSAVE("PSDS"),ZTSAVE("PSDSN"),ZTSAVE("PSDCPI"))="" S:$D(REPRINT) ZTSAVE("REPRINT")=""
"RTN","PSDRPGS",33,0)
 S ZTSAVE("PSD1(")=""
"RTN","PSDRPGS",34,0)
 Q
"RTN","PSDRPT")
0^11^B24521534^B22764037
"RTN","PSDRPT",1,0)
PSDRPT ;BIR/BJW-Reprint Misc (VA FORM 10-2321) ; 3 Mar 98
"RTN","PSDRPT",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,69**;13 Feb 97;Build 13
"RTN","PSDRPT",3,0)
 ;**Y2K compliance** display 4 digit year on va forms
"RTN","PSDRPT",4,0)
 ;Reference to PSD(58.8 supported by DBIA # 2711
"RTN","PSDRPT",5,0)
 ;Reference to ^PSD(58.81 supported by DBIA2808
"RTN","PSDRPT",6,0)
 ;Reference to ^PSD(58.86 supported by DBIA4472
"RTN","PSDRPT",7,0)
 ;Reference to ^PSDRUG( supported by DBIA #221
"RTN","PSDRPT",8,0)
 ;
"RTN","PSDRPT",9,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRPT",10,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDRPT",11,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to reprint",!,?12,"this transfer copy of VA FORM 10-2321.",!!,"PSJ RNURSE, PSD NURSE, PSJ RPHARM or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDRPT",12,0)
 W !!,"Reprint Transfer Between NAOUs VA FORM 10-2321",!
"RTN","PSDRPT",13,0)
 W $C(7),!,"Please note that you may reprint only the copy of the VA FORM 10-2321 for",!,"Green Sheets transferred from your NAOU that have NOT BEEN RECEIVED on",!,"the transfer to NAOU.",!
"RTN","PSDRPT",14,0)
ASKN ;ask transfer from naou
"RTN","PSDRPT",15,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer From NAOU: "
"RTN","PSDRPT",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRPT",17,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDRPT",18,0)
 S TYPE=3 G GS
"RTN","PSDRPT",19,0)
TYPE ;select type return to stock or turn in for destruction
"RTN","PSDRPT",20,0)
 K DA,DIR,DIRUT S DIR(0)="SO^1:RETURN TO STOCK;2:TURN IN FOR DESTRUCTION"
"RTN","PSDRPT",21,0)
 S DIR("A")="Select Type of VA FORM 10-2321 to Reprint"
"RTN","PSDRPT",22,0)
 S DIR("?",1)="Answer '1' to reprint a Return to Stock VA FORM 10-2321,"
"RTN","PSDRPT",23,0)
 S DIR("?",2)="answer '2' to reprint a Turn in For Destruction VA FORM 10-2321 or",DIR("?")="answer '^' to quit without reprinting any forms."
"RTN","PSDRPT",24,0)
 D ^DIR K DIR G:$D(DIRUT) END S TYPE=Y
"RTN","PSDRPT",25,0)
 G:TYPE'=2 GS
"RTN","PSDRPT",26,0)
CHK ;check for type of destructions
"RTN","PSDRPT",27,0)
 W ! K DA,DIR,DIRUT S DIR(0)="YO",DIR("B")="YES",DIR("A")="Is this a Green Sheet Turn in for Destructions reprint"
"RTN","PSDRPT",28,0)
 S DIR("?",1)="Answer 'YES' to enter Green Sheet number, 'NO' to select",DIR("?")="a Holding for Destructions number, or '^' to quit."
"RTN","PSDRPT",29,0)
 D ^DIR K DIR I $D(DIRUT) D MSG1 G END
"RTN","PSDRPT",30,0)
 I 'Y D LOOK G:PSDOUT END G PRINT
"RTN","PSDRPT",31,0)
GS ;select green sheet #
"RTN","PSDRPT",32,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDRPT",33,0)
 S:TYPE=1 DIC("S")="I $P(^(0),""^"",3)=+PSDS,$P(^(0),""^"",12)=3"
"RTN","PSDRPT",34,0)
 S:TYPE=2 DIC("S")="I $P(^(0),""^"",3)=+PSDS,$P(^(0),""^"",12)=2"
"RTN","PSDRPT",35,0)
 S:TYPE=3 DIC("S")="I $P(^(0),""^"",11)=10,$P(^(0),""^"",18)=AOU"
"RTN","PSDRPT",36,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDRPT",37,0)
 S PSDPN=$P(Y(0),"^",17),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDRPT",38,0)
 S MFG=$P(Y(0),"^",13),LOT=$P(Y(0),"^",14),EXP=$P(Y(0),"^",15),PSDS=+$P(Y(0),"^",3)
"RTN","PSDRPT",39,0)
 I TYPE'=3,'$D(^PSD(58.81,PSDA,3)) D MSG G:PSDOUT END
"RTN","PSDRPT",40,0)
 I TYPE=3,'$D(^PSD(58.81,PSDA,7)) D MSG G:PSDOUT END
"RTN","PSDRPT",41,0)
 I TYPE'=3 S NODE=^PSD(58.81,PSDA,3) S:TYPE=1 RECD=$P(NODE,"^"),RQTY=$P(NODE,"^",2),REAS=$P(NODE,"^",3) S:TYPE=2 RECD=$P(NODE,"^",4),RQTY=$P(NODE,"^",5),PSDHLD=$P(NODE,"^",8),REAS=$P(NODE,"^",6)
"RTN","PSDRPT",42,0)
 I TYPE=3 S NODE=^PSD(58.81,PSDA,7),RECD=$P(NODE,"^"),NAOUT=+$P(NODE,"^",3),RQTY=$P(NODE,"^",7),NAOUTN=$P($G(^PSD(58.8,NAOUT,0)),"^")
"RTN","PSDRPT",43,0)
PRINT ;print 2321
"RTN","PSDRPT",44,0)
 ;2nd line added for E3R# 3771 to print comments.
"RTN","PSDRPT",45,0)
 S REPRINT=1 S:'$D(REAS) REAS=""
"RTN","PSDRPT",46,0)
 S:$D(^PSD(58.86,+$G(PSDHLD),2)) PSDCOMS=$P(^(2),"^",1)
"RTN","PSDRPT",47,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDRPT",48,0)
 S COMP=$S(TYPE=1:3,TYPE=2:2,1:999)
"RTN","PSDRPT",49,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDRPT",50,0)
 S Y=RECD X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDRPT",51,0)
 S (PG,PSDOUT)=0,RECDT=$E(RECD,4,5)_"/"_$E(RECD,6,7)_"/"_PSDYR
"RTN","PSDRPT",52,0)
 I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3) S EXP=EXPD
"RTN","PSDRPT",53,0)
 D ^PSDGSRV2
"RTN","PSDRPT",54,0)
END K %,%DT,%H,%I,AOU,AOUN,COMP,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LOT,MFG
"RTN","PSDRPT",55,0)
 K NAOUT,NAOUTN,NODE,NUM,OK,ORD,PG,PSDCOMS,PSDA,PSDHLD,PSDOK,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDSN,PSDTYP,PSDUZ,PSDYR,REAS,RECD,RECDT,REPRINT,RQTY,STAT,STATN,SUM,TYPE,X,Y
"RTN","PSDRPT",56,0)
 Q
"RTN","PSDRPT",57,0)
MSG ;check and write msg if not ok
"RTN","PSDRPT",58,0)
 W !!,"Green Sheet #",PSDPN," has not been ",$S(TYPE=1:"returned to stock",TYPE=2:"turned in for destruction",1:"transferred between NAOUs"),".",!
"RTN","PSDRPT",59,0)
MSG1 W !,"No Reprint of VA FORM 10-2321",!!
"RTN","PSDRPT",60,0)
 S PSDOUT=1
"RTN","PSDRPT",61,0)
 Q
"RTN","PSDRPT",62,0)
LOOK ;lookup destructions #
"RTN","PSDRPT",63,0)
 S PSDOUT=0
"RTN","PSDRPT",64,0)
 W ! K DA,DIC S DIC=58.86,DIC(0)="QEAZ",DIC("A")="Select Destructions Holding #: "
"RTN","PSDRPT",65,0)
 S DIC("S")="I $P(^(0),""^"",7)=+PSDS,'+$P(^(0),""^"",11)" D ^DIC K DIC I Y<0 D MSG1 Q
"RTN","PSDRPT",66,0)
 S PSDHLD=+Y,RQTY=+$P(Y(0),"^",3),RECD=+$P(Y(0),"^",6),PSDOK=1,PSDR=+$P(Y(0),"^",2),PSDRN=$S(PSDR:$P($G(^PSDRUG(+PSDR,0)),"^"),1:$G(^PSD(58.86,+PSDHLD,1)))
"RTN","PSDRPT",67,0)
 S:PSDRN']"" PSDRN="UNKNOWN" S (MFG,LOT,EXP)=""
"RTN","PSDRPT",68,0)
 Q
"RTN","PSDRWK")
0^4^B21554388^B21137920
"RTN","PSDRWK",1,0)
PSDRWK ;BIR/JPW-Reprint Pharm Disp. Worksheet ;12/14/99  16:40
"RTN","PSDRWK",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**20,69**;13 Feb 97;Build 13
"RTN","PSDRWK",3,0)
 ;
"RTN","PSDRWK",4,0)
 ; Reference to XUSEC( supported by DBIA # 10076
"RTN","PSDRWK",5,0)
 ; Reference to DD(58.8 supported by DBIA # 10154
"RTN","PSDRWK",6,0)
 ; Reference to DD("DD" supported by DBIA # 10017
"RTN","PSDRWK",7,0)
 ; Reference to PSDRUG( supproted by DBIA # 221
"RTN","PSDRWK",8,0)
 ; Reference to VA(200 supported by DBIA # 10060
"RTN","PSDRWK",9,0)
 ; Reference to PSD(58.8 supported by DBIA # 2711
"RTN","PSDRWK",10,0)
 ;
"RTN","PSDRWK",11,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRWK",12,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSD TECH ADV",DUZ)):1,1:0)
"RTN","PSDRWK",13,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"process/dispense narcotic supplies.",!!,"PSJ RPHARM, PSJ PHARM TECH or PSD TECH ADV security key required.",! K OK Q
"RTN","PSDRWK",14,0)
 W !!,"=>  This report reprints a worksheet listing of all pending CS requests for a",!,"    dispensing site.",!!
"RTN","PSDRWK",15,0)
 I '$O(^PSD(58.85,0)) W $C(7),!!,"There are no pending request orders.",!! K OK Q
"RTN","PSDRWK",16,0)
ASKD ;ask disp location
"RTN","PSDRWK",17,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDRWK",18,0)
 I $P(PSDSITE,U,5) S PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) G CHKD
"RTN","PSDRWK",19,0)
 W ! K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)",DIC("A")="Select Primary Dispensing Site: ",DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDRWK",20,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDRWK",21,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),PSDS=PSDS_"^"_+$P(Y(0),"^",5)
"RTN","PSDRWK",22,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDRWK",23,0)
CHKD I '$O(^PSD(58.85,"AE",+PSDS,0)) W !!,"There are no pending CS requests for "_PSDSN_".",!! G END
"RTN","PSDRWK",24,0)
DEV ;ask device and queue info
"RTN","PSDRWK",25,0)
 W !!,"This report is designed for a 132 column format.",!,"You may queue this report to print at a later time.",!!
"RTN","PSDRWK",26,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",9),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDRWK",27,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="QM",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDRWK",28,0)
 I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDRWK",ZTDESC="Reprint Worksheet for CS PHARM" D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDRWK",29,0)
 U IO
"RTN","PSDRWK",30,0)
START ;entry for reprint
"RTN","PSDRWK",31,0)
 K LN S (CNT,PG,PSDOUT)=0,$P(LN,"-",132)="" D NOW^%DTC S Y=+$E(%,1,12) X ^DD("DD") S RPDT=Y D HDR Q:PSDOUT
"RTN","PSDRWK",32,0)
 F JJ=0:0 S JJ=$O(^PSD(58.85,"AW",+PSDS,JJ)) Q:'JJ!(PSDOUT)  F PSD=0:0 S PSD=$O(^PSD(58.85,"AW",+PSDS,JJ,PSD)) Q:'PSD!(PSDOUT)  I $D(^PSD(58.85,PSD,0)) S PSDN=+$P(^(0),"^",3) D
"RTN","PSDRWK",33,0)
 .S NODE=^PSD(58.85,PSD,0),CNT=CNT+1,WK=$S($P(NODE,"^",7)>2:"*",1:"")
"RTN","PSDRWK",34,0)
 .S PSDNA=$S($P($G(^PSD(58.8,PSDN,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_PSDN)
"RTN","PSDRWK",35,0)
 .S DRUG=+$P(NODE,"^",4),DRUGN=$S($P($G(^PSDRUG(DRUG,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_DRUG)
"RTN","PSDRWK",36,0)
 .S QTY=$P(NODE,"^",6),ORD=+$P(NODE,"^",12),ORDN=$S($P($G(^VA(200,ORD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDRWK",37,0)
 .S COMM=$S($D(^PSD(58.85,PSD,1,0)):1,1:0)
"RTN","PSDRWK",38,0)
 .;prints detail data
"RTN","PSDRWK",39,0)
 .I 'CNT W !!,?45,"****  NO REQUESTS PREVIOUSLY PRINTED FOR THIS DISPENSING LOCATION  ****" S PSDOUT=1 Q
"RTN","PSDRWK",40,0)
 .D:$Y+8>IOSL HDR Q:PSDOUT
"RTN","PSDRWK",41,0)
 .W !,PSD_WK,?10,DRUGN,?52,QTY,?60,PSDNA,?100,ORDN
"RTN","PSDRWK",42,0)
 .W:$P($G(^PSD(58.85,PSD,2)),U,2) !,"* PRIORITY *"
"RTN","PSDRWK",43,0)
 .I COMM K ^UTILITY($J,"W") F TEXT=0:0 S TEXT=$O(^PSD(58.85,PSD,1,TEXT)) Q:'TEXT  S X=$G(^PSD(58.85,PSD,1,TEXT,0)),DIWL=15,DIWR=125,DIWF="W" D ^DIWP
"RTN","PSDRWK",44,0)
 .I COMM D ^DIWW
"RTN","PSDRWK",45,0)
 .W !!,?10,"Disp # ____________  Manufacturer: __________________   Lot # __________   Exp. Date: __________",!
"RTN","PSDRWK",46,0)
DONE I $E(IOST)'="C" W @IOF
"RTN","PSDRWK",47,0)
 I $E(IOST,1,2)="C-",'PSDOUT W ! K DIR,DIRUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu" D ^DIR K DIR
"RTN","PSDRWK",48,0)
END K %,%H,%I,%ZIS,C,CNT,COMM,DA,DIC,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DTOUT,DRUG,DRUGN,DUOUT,IO("Q"),JJ,LN,NODE,OK,ORD,ORDN
"RTN","PSDRWK",49,0)
 K PG,POP,PSD,PSDEV,PSDN,PSDNA,PSDOUT,PSDS,PSDSN,QTY,RPDT,TEXT,WK,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK D ^%ZISC
"RTN","PSDRWK",50,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDRWK",51,0)
 Q
"RTN","PSDRWK",52,0)
SAVE S (ZTSAVE("PSDS"),ZTSAVE("PSDSN"),ZTSAVE("PSDSITE"))=""
"RTN","PSDRWK",53,0)
 Q
"RTN","PSDRWK",54,0)
HDR ;lists header information
"RTN","PSDRWK",55,0)
 I $E(IOST,1,2)="C-",PG W ! K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDRWK",56,0)
 W:$Y @IOF S PG=PG+1 W !,?40,"PHARMACY DISPENSING WORKSHEET (Reprint)",!!,"Dispensing Location: ",PSDSN,?65,RPDT,?105,"PG "_PG,!!
"RTN","PSDRWK",57,0)
 W "WS #",?10,"DRUG",?50,"QUANTITY",?60,"DISPENSE TO",!,?12,"COMMENTS",?50,"ORDERED",?60,"LOCATION",?102,"ORDERED BY",!,LN,!
"RTN","PSDRWK",58,0)
 Q
"VER")
8.0^22.0
"BLD",7003,6)
^58
**END**
**END**

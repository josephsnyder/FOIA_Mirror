Released SD*5.3*547 SEQ #460
Extracted from mail message
**KIDS**:SD*5.3*547^

**INSTALL NAME**
SD*5.3*547
"BLD",7959,0)
SD*5.3*547^SCHEDULING^0^3090902^y
"BLD",7959,1,0)
^^4^4^3090902^
"BLD",7959,1,1,0)
Add new Help text at the date prompts to inform users that past dates 
"BLD",7959,1,2,0)
must include the year when input, do not allow appts to be made prior to
"BLD",7959,1,3,0)
date a new day of the week is added to clinic pattern and fix 
"BLD",7959,1,4,0)
Nonconforming Clinic report to indicate when a stop code was Inactivated.
"BLD",7959,4,0)
^9.64PA^^
"BLD",7959,6.3)
17
"BLD",7959,"ABPKG")
n
"BLD",7959,"KRN",0)
^9.67PA^779.2^20
"BLD",7959,"KRN",.4,0)
.4
"BLD",7959,"KRN",.401,0)
.401
"BLD",7959,"KRN",.402,0)
.402
"BLD",7959,"KRN",.403,0)
.403
"BLD",7959,"KRN",.5,0)
.5
"BLD",7959,"KRN",.84,0)
.84
"BLD",7959,"KRN",3.6,0)
3.6
"BLD",7959,"KRN",3.8,0)
3.8
"BLD",7959,"KRN",9.2,0)
9.2
"BLD",7959,"KRN",9.8,0)
9.8
"BLD",7959,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",7959,"KRN",9.8,"NM",1,0)
SDM0^^0^B88208979
"BLD",7959,"KRN",9.8,"NM",2,0)
SDM1^^0^B53130837
"BLD",7959,"KRN",9.8,"NM",3,0)
SDSCRP^^0^B12484376
"BLD",7959,"KRN",9.8,"NM","B","SDM0",1)

"BLD",7959,"KRN",9.8,"NM","B","SDM1",2)

"BLD",7959,"KRN",9.8,"NM","B","SDSCRP",3)

"BLD",7959,"KRN",19,0)
19
"BLD",7959,"KRN",19.1,0)
19.1
"BLD",7959,"KRN",101,0)
101
"BLD",7959,"KRN",409.61,0)
409.61
"BLD",7959,"KRN",771,0)
771
"BLD",7959,"KRN",779.2,0)
779.2
"BLD",7959,"KRN",870,0)
870
"BLD",7959,"KRN",8989.51,0)
8989.51
"BLD",7959,"KRN",8989.52,0)
8989.52
"BLD",7959,"KRN",8994,0)
8994
"BLD",7959,"KRN","B",.4,.4)

"BLD",7959,"KRN","B",.401,.401)

"BLD",7959,"KRN","B",.402,.402)

"BLD",7959,"KRN","B",.403,.403)

"BLD",7959,"KRN","B",.5,.5)

"BLD",7959,"KRN","B",.84,.84)

"BLD",7959,"KRN","B",3.6,3.6)

"BLD",7959,"KRN","B",3.8,3.8)

"BLD",7959,"KRN","B",9.2,9.2)

"BLD",7959,"KRN","B",9.8,9.8)

"BLD",7959,"KRN","B",19,19)

"BLD",7959,"KRN","B",19.1,19.1)

"BLD",7959,"KRN","B",101,101)

"BLD",7959,"KRN","B",409.61,409.61)

"BLD",7959,"KRN","B",771,771)

"BLD",7959,"KRN","B",779.2,779.2)

"BLD",7959,"KRN","B",870,870)

"BLD",7959,"KRN","B",8989.51,8989.51)

"BLD",7959,"KRN","B",8989.52,8989.52)

"BLD",7959,"KRN","B",8994,8994)

"BLD",7959,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7959,"QUES",0)
^9.62^^
"BLD",7959,"REQB",0)
^9.611^3^3
"BLD",7959,"REQB",1,0)
SD*5.3*317^2
"BLD",7959,"REQB",2,0)
SD*5.3*334^2
"BLD",7959,"REQB",3,0)
SD*5.3*446^2
"BLD",7959,"REQB","B","SD*5.3*317",1)

"BLD",7959,"REQB","B","SD*5.3*334",2)

"BLD",7959,"REQB","B","SD*5.3*446",3)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813
"PKG",16,22,1,"PAH",1,0)
547^3090902
"PKG",16,22,1,"PAH",1,1,0)
^^4^4^3090902
"PKG",16,22,1,"PAH",1,1,1,0)
Add new Help text at the date prompts to inform users that past dates 
"PKG",16,22,1,"PAH",1,1,2,0)
must include the year when input, do not allow appts to be made prior to
"PKG",16,22,1,"PAH",1,1,3,0)
date a new day of the week is added to clinic pattern and fix 
"PKG",16,22,1,"PAH",1,1,4,0)
Nonconforming Clinic report to indicate when a stop code was Inactivated.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","SDM0")
0^1^B88208979^B71919767
"RTN","SDM0",1,0)
SDM0 ;SF/GFT - MAKE APPOINTMENT ; 11 Jun 2001  5:20 PM
"RTN","SDM0",2,0)
 ;;5.3;Scheduling;**140,167,206,186,223,237,241,384,334,547**;Aug 13, 1993;Build 17
"RTN","SDM0",3,0)
 I $D(SDXXX) S SDOK=1 Q
"RTN","SDM0",4,0)
 N SDSRTY,SDDATE,SDSDATE,SDSRFU,SDDMAX,SDONCE
"RTN","SDM0",5,0)
 ;Prompt for scheduling request type
"RTN","SDM0",6,0)
M N SDHX,SDXF,SDXD
"RTN","SDM0",7,0)
 Q:'$$SRTY(.SDSRTY)  S:SDSRTY SDDATE=DT
"RTN","SDM0",8,0)
 ;Calculate appointment follow-up indicator
"RTN","SDM0",9,0)
 S SDSRFU=$$PTFU(DFN,SC)
"RTN","SDM0",10,0)
 ;Determine maximum days for scheduling
"RTN","SDM0",11,0)
 S SDMAX(1)=$P($G(^SC(+SC,"SDP")),U,2) S:'SDMAX(1) SDMAX(1)=365
"RTN","SDM0",12,0)
 S (SDMAX,SDDMAX)=$$FMADD^XLFDT(DT,SDMAX(1))
"RTN","SDM0",13,0)
 ;Prompt for desired date
"RTN","SDM0",14,0)
 Q:'$$DDATE(.SDDATE,SDSRTY,.SDMAX)
"RTN","SDM0",15,0)
 ;If date and time, schedule appt. directly
"RTN","SDM0",16,0)
 W ! I SDDATE#1 S SDSDATE=SDDATE,SDDATE=SDDATE\1 G ^SDM1
"RTN","SDM0",17,0)
 S (X,Y)=SDDATE K SDHX
"RTN","SDM0",18,0)
 ;Find first available after specified date
"RTN","SDM0",19,0)
 I X="F"!(X="f") D SUP,DT1 G NEXT
"RTN","SDM0",20,0)
 ;Find next available appointment
"RTN","SDM0",21,0)
 I SDSRTY,SDDATE D SUP S SDSTRTDT=SDDATE D OVR^SDMULT0 G NEXT
"RTN","SDM0",22,0)
 ;
"RTN","SDM0",23,0)
EN S:$L(X)=1 X=$TR(X,"tnN","TTT") S:X="NOW" X="T" I X?.A!(+X=X),X<13,X'?1"T".E S X=X_" 1"
"RTN","SDM0",24,0)
 D  Q:Y<1
"RTN","SDM0",25,0)
 .N %DT
"RTN","SDM0",26,0)
 .S %DT="T" D ^%DT
"RTN","SDM0",27,0)
 .I Y<1 W !!,"Unable to evaluate date value """_X_""".",!
"RTN","SDM0",28,0)
 .Q
"RTN","SDM0",29,0)
 S:$S($D(DUZ)'[0:1,1:0) ^DISV(DUZ_U_+SC)=Y
"RTN","SDM0",30,0)
DISP S IOF=$S('$D(IOF):"!#",IOF']"":"!#",1:IOF) W @IOF S SDSOH=$S('$D(^SC(+SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1),SDAV=0
"RTN","SDM0",31,0)
 I $D(SDINA),Y'<SDINA,SDRE>Y!('SDRE) S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY D PAUSE^VALM1 Q:'SDRE
"RTN","SDM0",32,0)
 S:Y#100=0 Y=Y+1 S X=Y D D:$E(X,4,5) S (SDX,X1)=X,X2=1 D C^%DTC S X=SDX K SDX G:SDAV ^SDM1 Q
"RTN","SDM0",33,0)
 ;
"RTN","SDM0",34,0)
NEXT D SET I $S('$D(FND):1,'FND:1,1:0) D  G EN
"RTN","SDM0",35,0)
 .K ^DISV($S($D(DUZ)'[0:DUZ,1:0)_U_+SC)
"RTN","SDM0",36,0)
 .I '$O(^SC(+SC,"ST",SDDATE-1)) S (X,Y)=SDDATE Q
"RTN","SDM0",37,0)
 .W $C(7),!?6,"No open slots found in the date range "
"RTN","SDM0",38,0)
 .W $$FMTE^XLFDT(SDDATE)," to ",$$FMTE^XLFDT(SDDMAX),"!",!
"RTN","SDM0",39,0)
 .H 3 S (X,Y)=SDDATE
"RTN","SDM0",40,0)
 .Q
"RTN","SDM0",41,0)
 S (X,Y)=SDAPP K SDXXX G DISP
"RTN","SDM0",42,0)
D W #!?36,$P(SC,U,2) S:$O(^SC(+SC,"T",0))>X X=+$O(^(0)) D DOW S I=Y+32,D=Y S SDXF=0 D WM I SDXF D WMH
"RTN","SDM0",43,0)
X1 S X1=X\100_$P("31^28^31^30^31^30^31^31^30^31^30^31",U,+$E(X,4,5)) ;28
"RTN","SDM0",44,0)
 ;SD*5.3*547 next line don't allow past dates to be added to pattern if prior to date DOW was added
"RTN","SDM0",45,0)
W I '$D(^SC(+SC,"ST",X,1)) S DWFLG=1,POP=0,XDT=X D DOWCHK K DWFLG,XDT G L:POP
"RTN","SDM0",46,0)
 I '$D(^SC(+SC,"ST",X,1)) S Y=D#7 G L:'$D(J(Y)),H:$D(^HOLIDAY(X))&('SDSOH) S SS=+$O(^SC(+SC,"T"_Y,X)) G L:SS'>0,L:^(SS,1)="" S ^SC(+SC,"ST",$P(X,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(X,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(X,".")
"RTN","SDM0",47,0)
 S SDHX=X,SDAV=1 D:X>SM WM I SDXF<2 D WMH
"RTN","SDM0",48,0)
 I $D(^SC(+SC,"ST",X,1)),^(1)["["!(^(1)["CANCELLED")!($D(^HOLIDAY(X))) W !,$E(^SC(+SC,"ST",X,1),1,80) S:'$D(^HOLIDAY(X))&('SDAV) SDAV=1
"RTN","SDM0",49,0)
 I $Y>18 W ! Q
"RTN","SDM0",50,0)
L K POP
"RTN","SDM0",51,0)
 S X=X+1,D=D+1
"RTN","SDM0",52,0)
 I $D(SDINA),X>SDINA,SDRE>X!('SDRE) D:'SDAV NOAV S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,?8,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY Q:'SDRE  D DIFF
"RTN","SDM0",53,0)
 G W:X'>X1 S X2=X-X1 D C^%DTC
"RTN","SDM0",54,0)
 I $D(SDINA),X>SDINA,SDRE>X!('SDRE) D:'SDAV NOAV S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,?8,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY Q:'SDRE
"RTN","SDM0",55,0)
 G X1:D<I W ! D:'SDAV MNTH Q
"RTN","SDM0",56,0)
 ;
"RTN","SDM0",57,0)
NOAV W !,"No availability found between date chosen and inactivate date!" Q
"RTN","SDM0",58,0)
H S ^SC(+SC,"ST",X,1)="   "_$E(X,6,7)_"    "_$P(^(X,0),U,2),^(0)=X G W
"RTN","SDM0",59,0)
 ;
"RTN","SDM0",60,0)
WM W !?36 S Y=$E(X,1,5)_"00",SM=$S($E(X,4,5)[12:$E(X,1,3)+1_"01",1:$E(X,1,3)_$E(X,4,5)+1)_"00"
"RTN","SDM0",61,0)
 S SDXF=SDXF+1 I $E(X,6,7)>20 D
"RTN","SDM0",62,0)
 . S SDXD=$O(^SC(+SC,"ST",X-1)) Q:SDXD=""
"RTN","SDM0",63,0)
 . I $E(SDXD,4,5)'=$E(X,4,5) S SDXF=0
"RTN","SDM0",64,0)
 D:SDXF DT
"RTN","SDM0",65,0)
 Q
"RTN","SDM0",66,0)
WMH ;Write month heading lines
"RTN","SDM0",67,0)
 W !!," TIME",?SI+SI-1 F Y=STARTDAY:1:65\(SI+SI)+STARTDAY W $E("|"_$S('Y:0,1:(Y-1#12+1))_"                 ",1,SI+SI)
"RTN","SDM0",68,0)
 W !," DATE",?SI+SI-1,"|" K J F Y=0:1:6 I $D(^SC(+SC,"T"_Y)) S J(Y)=""
"RTN","SDM0",69,0)
 F Y=1:1:65\(SI+SI) W $J("|",SI+SI)
"RTN","SDM0",70,0)
 S SDXF=2
"RTN","SDM0",71,0)
 Q
"RTN","SDM0",72,0)
DT W $$FMTE^XLFDT(Y) Q
"RTN","SDM0",73,0)
 ;
"RTN","SDM0",74,0)
DOW S Y=$$DOW^XLFDT(X,1) Q
"RTN","SDM0",75,0)
 ;
"RTN","SDM0",76,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDM0",77,0)
MORDIS I '$D(SDHX) W *7," ??" G ADT^SDM1
"RTN","SDM0",78,0)
 S SDXF=0,X1=SDHX,X2=1 D C^%DTC
"RTN","SDM0",79,0)
MORD2 I $D(SDINA),SDINA'>X,SDRE>X!('SDRE) S SDHY=$S($D(Y):Y,1:""),Y=SDINA D DTS^SDUTL W *7,!,"Clinic is inactivated as of ",Y S Y=SDHY K SDHY G ADT^SDM1
"RTN","SDM0",80,0)
 G EN
"RTN","SDM0",81,0)
INPAT S SDI=$O(^DGPM("ATID1",DFN,9999999-X)) I SDI>0 D I1
"RTN","SDM0",82,0)
 S:'$D(SDINP) SDINP="" K SDI,SDI1 Q
"RTN","SDM0",83,0)
I1 F SDI1=0:0 S SDI1=$O(^DGPM("ATID1",DFN,SDI,SDI1)) Q:SDI1'>0  I $D(^DGPM(SDI1,0)) S SDX=^(0) I $S($P(SDX,U,17)']"":1,+^DGPM($P(SDX,U,17),0)>X!(+^DGPM($P(SDX,U,17),0)=0):1,1:0) S SDINP="I" Q
"RTN","SDM0",84,0)
 Q
"RTN","SDM0",85,0)
 ;
"RTN","SDM0",86,0)
SUP ;Set up variables for availability search
"RTN","SDM0",87,0)
 S SDNEXT=1,SDCT=1,G1=+SC,SDC(1)=SC,FND=0,SDAV=0 K SDC1
"RTN","SDM0",88,0)
 D SAVE S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","SDM0",89,0)
 Q
"RTN","SDM0",90,0)
 ;
"RTN","SDM0",91,0)
SET S I1="" F I=0:0 S I1=$O(SDZ(I1)) Q:I1']""  S @I1=SDZ(I1)
"RTN","SDM0",92,0)
 K SDZ Q
"RTN","SDM0",93,0)
SAVE K SDZ F I="SDDIF","STR","SC","DFN","SL","SI","HSI","SB" S Z="SDZ("_""""_I_""")" S:$D(@I) @Z=@I
"RTN","SDM0",94,0)
 Q
"RTN","SDM0",95,0)
MNTH W !," *** No availability found for one full calendar month",!,"  Search stopped at " S Y=X D DTS^SDUTL W Y," ***",! Q
"RTN","SDM0",96,0)
DIFF S X1=SDRE,X2=X D ^%DTC S D=D+X,X=SDRE,X1=X\100_28 Q
"RTN","SDM0",97,0)
 ;
"RTN","SDM0",98,0)
SRTY(SDSRTY) ;Prompt for scheduling request type
"RTN","SDM0",99,0)
 ;Input: SDSRTY=variable to return user response (pass by reference)
"RTN","SDM0",100,0)
 ;Output: '1' if successful, '0' otherwise
"RTN","SDM0",101,0)
 ;
"RTN","SDM0",102,0)
 I $G(DFN)<1 S SDSRTY="M" Q 1  ;patient not defined
"RTN","SDM0",103,0)
 I $G(SDMM)=1 S SDSRTY="M" Q 1  ;multiple appointment booking
"RTN","SDM0",104,0)
 N DIR,DTOUT,DUOUT
"RTN","SDM0",105,0)
 S DIR(0)="Y"
"RTN","SDM0",106,0)
 S DIR("A")="IS THIS A 'NEXT AVAILABLE' APPOINTMENT REQUEST"
"RTN","SDM0",107,0)
 S DIR("?")="Answer 'yes' if scheduling to the next available appointment is desired."
"RTN","SDM0",108,0)
 W ! D ^DIR I $D(DTOUT)!$D(DUOUT) Q 0
"RTN","SDM0",109,0)
 S SDSRTY=Y,SDSRTY(0)=$$TXRT^SDM1A(.SDSRTY) Q 1
"RTN","SDM0",110,0)
 ;
"RTN","SDM0",111,0)
PTFU(DFN,SC)    ;Determine if this is a follow-up (return to clinic within 24 months)
"RTN","SDM0",112,0)
 ;Input: DFN=patient ifn
"RTN","SDM0",113,0)
 ;Input: SC=clinic ifn
"RTN","SDM0",114,0)
 ;Output: '1' if seen within 24 months, '0' otherwise
"RTN","SDM0",115,0)
 ;
"RTN","SDM0",116,0)
 Q:'DFN!'SC 0  ;variable check
"RTN","SDM0",117,0)
 N SDBDT,SDT,SDX,SDY,SDZ,SDCP,SDCP1,SC0,SDENC,SDCT
"RTN","SDM0",118,0)
 ;set up variables
"RTN","SDM0",119,0)
 S SDBDT=(DT-20000)+.24,SDT=DT_.999999,(SDCT,SDY)=0
"RTN","SDM0",120,0)
 S SC0=$G(^SC(+SC,0)),SDX=$$CPAIR^SCRPW71(SC0,.SDCP)  ;get credit pair for this clinic
"RTN","SDM0",121,0)
 ;Iterate through encounters
"RTN","SDM0",122,0)
 W !!,"Calculating follow-up status"
"RTN","SDM0",123,0)
 F  S SDT=$O(^SCE("ADFN",DFN,SDT),-1) Q:SDT<SDBDT!SDY  D
"RTN","SDM0",124,0)
 .S SDENC=0 F  S SDENC=$O(^SCE("ADFN",DFN,SDT,SDENC)) Q:'SDENC!SDY  D
"RTN","SDM0",125,0)
 ..S SDENC0=$G(^SCE(SDENC,0))  ;get encounter node
"RTN","SDM0",126,0)
 ..Q:$P(SDENC0,U,6)  ;parent encounters only
"RTN","SDM0",127,0)
 ..S SDX=$P(SDENC0,U,4) Q:'SDX  ;get clinic
"RTN","SDM0",128,0)
 ..S SC0=$G(^SC(SDX,0))
"RTN","SDM0",129,0)
 ..S SDX=$$CPAIR^SCRPW71(SC0,.SDCP1)  ;get credit pair for encounter
"RTN","SDM0",130,0)
 ..S SDY=SDCP=SDCP1  ;compare credit pairs
"RTN","SDM0",131,0)
 ..S SDCT=SDCT+1 W:SDCT#10=0 "."
"RTN","SDM0",132,0)
 ..Q
"RTN","SDM0",133,0)
 .Q
"RTN","SDM0",134,0)
 Q SDY
"RTN","SDM0",135,0)
 ;
"RTN","SDM0",136,0)
DDATE(SDDATE,SDSRTY,SDMAX) ;Desired date selection
"RTN","SDM0",137,0)
 ;Input: SDDATE=variable to return date selection (pass by reference)
"RTN","SDM0",138,0)
 ;Input: SDSRTY=variable to return request type
"RTN","SDM0",139,0)
 ;Input: SDMAX=variable to return max. days to sched. (pass by ref.)
"RTN","SDM0",140,0)
 ;Output: '1' for success, otherwise '0'
"RTN","SDM0",141,0)
 ;
"RTN","SDM0",142,0)
 Q:SDSRTY 1
"RTN","SDM0",143,0)
 W !!?2,"Select one of the following:",!
"RTN","SDM0",144,0)
 W !?5,"'F'",?20,"for First available following a specified date"
"RTN","SDM0",145,0)
 W !?5,"Date",?20,"(or date computation such as 'T+2M') for a desired date"
"RTN","SDM0",146,0)
 I DFN>0 W !?5,"Date/time",?20,"to schedule a specific appointment - Note: PAST dates",!?20,"must include the Year in the input."  ;added note SD*5.3*547
"RTN","SDM0",147,0)
 W !?5,"'?'",?20,"for detailed help"
"RTN","SDM0",148,0)
DASK N DIR,X,Y,SDX,DTOUT,DUOUT
"RTN","SDM0",149,0)
 ;
"RTN","SDM0",150,0)
 ;BP OIFO/TEH PATCH SD*5.3*384 ; SD*5.3*547 added note to help text
"RTN","SDM0",151,0)
 ;
"RTN","SDM0",152,0)
 S DIR(0)="F^1:30"
"RTN","SDM0",153,0)
 S DIR("A")="ENTER THE DATE DESIRED FOR THIS APPOINTMENT"
"RTN","SDM0",154,0)
 S DIR("?",1)="  Enter the date that is desired for this appointment."
"RTN","SDM0",155,0)
 S DIR("?",2)="  NOTE: PAST dates must include the Year in the input."
"RTN","SDM0",156,0)
 S DIR("?",3)=""
"RTN","SDM0",157,0)
 S DIR("?",4)="  You may enter 'F' to find the first available slot after a specified date."
"RTN","SDM0",158,0)
 S DIR("?",5)="  You will be prompted for begin and end dates for this search."
"RTN","SDM0",159,0)
 S DIR("?",6)=""
"RTN","SDM0",160,0)
 S DIR("?",7)="  A date may be entered to begin the display of clinic availability at the"
"RTN","SDM0",161,0)
 I DFN<1 S DIR("?")="  requested date."
"RTN","SDM0",162,0)
 I DFN>0 D
"RTN","SDM0",163,0)
 .S DIR("?",8)="  requested date."
"RTN","SDM0",164,0)
 .S DIR("?",9)=""
"RTN","SDM0",165,0)
 .S DIR("?",10)="  The entry of a date/time will result in the scheduling of an appointment at"
"RTN","SDM0",166,0)
 .S DIR("?")="  that time, if possible."
"RTN","SDM0",167,0)
 .Q
"RTN","SDM0",168,0)
 W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT) 0
"RTN","SDM0",169,0)
 I Y=" " S SDX=$G(^DISV(DUZ_U_+SC)) I SDX?7N S (X,Y)=SDX
"RTN","SDM0",170,0)
 I $L(Y)=1,"fF"[Y D  Q 1
"RTN","SDM0",171,0)
 .W "    First available"
"RTN","SDM0",172,0)
 .S (SDDATE,SDSRTY)=$TR(Y,"f","F")
"RTN","SDM0",173,0)
 .Q
"RTN","SDM0",174,0)
 N %DT,SDX,SDI
"RTN","SDM0",175,0)
 S SDX="N^n^NOW^now^Now" F SDI=1:1:5 S:X=$P(SDX,U,SDI) X="T"
"RTN","SDM0",176,0)
 S %DT="EFT" D ^%DT
"RTN","SDM0",177,0)
 G:Y<1 DASK S SDDATE=Y
"RTN","SDM0",178,0)
 I DFN<1 S SDDATE=SDDATE\1
"RTN","SDM0",179,0)
 I DFN>0,Y'<DT,(Y\1)>SDMAX D  G DASK
"RTN","SDM0",180,0)
 .W !,$C(7)
"RTN","SDM0",181,0)
 .W "Scheduling cannot be more than ",SDMAX(1)," days in the future"
"RTN","SDM0",182,0)
 .Q
"RTN","SDM0",183,0)
 Q 1
"RTN","SDM0",184,0)
 ;
"RTN","SDM0",185,0)
DOWCHK ;SD*5.3*547 check if date is prior to date DOW was added to pattern
"RTN","SDM0",186,0)
 S (DY,DYW)="" S:'$D(DWFLG) DWFLG=0
"RTN","SDM0",187,0)
 I '$D(^SC(+SC,"ST",$P(XDT,"."),1)) D  Q:DWFLG  I POP D DWWRT Q
"RTN","SDM0",188,0)
 .S DY=$$DOW^XLFDT($P(XDT,"."))
"RTN","SDM0",189,0)
 .S DYW=$E(DY,1,2),DYW=$TR(DYW,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","SDM0",190,0)
 .S PCDT=$P(XDT,"."),CT=0,POP=1
"RTN","SDM0",191,0)
 .F  S PCDT=$O(^SC(+SC,"ST",PCDT),-1) Q:'PCDT!('POP)!(CT>30)  D
"RTN","SDM0",192,0)
 ..S CT=CT+1
"RTN","SDM0",193,0)
 ..Q:'$D(^SC(+SC,"ST",PCDT,0))
"RTN","SDM0",194,0)
 ..Q:'$D(^SC(+SC,"ST",PCDT,1))
"RTN","SDM0",195,0)
 ..Q:$E($G(^SC(+SC,"ST",PCDT,1)),1,2)'=DYW
"RTN","SDM0",196,0)
 ..I $E($G(^SC(+SC,"ST",PCDT,1)),1,2)=DYW S POP=0 Q
"RTN","SDM0",197,0)
 .Q
"RTN","SDM0",198,0)
 K PCDT,CT,DY,DYW
"RTN","SDM0",199,0)
 Q
"RTN","SDM0",200,0)
 ;
"RTN","SDM0",201,0)
DWWRT ;added SD*5.3*547
"RTN","SDM0",202,0)
 S DY=$TR(DY,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","SDM0",203,0)
 W *7,!!,"That date is prior to the date ",DY," was added to the"
"RTN","SDM0",204,0)
 W !,"availability pattern for this clinic.",!!
"RTN","SDM0",205,0)
 K DY,DYW,PCDT,CT
"RTN","SDM0",206,0)
 Q
"RTN","SDM0",207,0)
 ;
"RTN","SDM0",208,0)
1 S SDNEXT="",SDCT=0 G RD^SDMULT
"RTN","SDM0",209,0)
DT1 S FND=0,%DT(0)=-SDMAX,%DT="AEF",%DT("A")="  START SEARCH FOR NEXT AVAILABLE FROM WHAT DATE: " D ^%DT K %DT G:"^"[X 1:$S('$D(SDNEXT):1,'SDNEXT:1,1:0),END^SDMULT0 G:Y<0 DT S (SDDATE,SDSTRTDT)=+Y
"RTN","SDM0",210,0)
LIM W !,"  ENTER LATEST DATE TO CHECK FOR 1ST AVAILABLE SLOT: " S Y=SDMAX D DT^DIQ R "// ",X:DTIME G:X["^"!'($T) END^SDMULT0 I X']"" G OVR^SDMULT0
"RTN","SDM0",211,0)
 I X?.E1"?" W !,"  The latest date for future bookings for ",$P(SDC(1),"^",2)," is: " S Y=SDMAX D DTS^SDUTL W Y,!,"  If you enter a date here, it must be less than this date to further limit the",!,"  search" G LIM
"RTN","SDM0",212,0)
 S %DT="EF",%DT(0)=-SDMAX D ^%DT K %DT G:Y<0!(Y<SDSTRTDT) LIM S:Y>0 (SDDMAX,SDMAX)=+Y
"RTN","SDM0",213,0)
 G OVR^SDMULT0
"RTN","SDM1")
0^2^B53130837^B49317350
"RTN","SDM1",1,0)
SDM1 ;SF/GFT - MAKE APPOINTMENT ; 3/29/05 12:35pm [5/5/05 9:41am]  ; Compiled March 8, 2007 14:55:24  ; Compiled May 9, 2007 13:19:18  ; Compiled August 28, 2007 12:19:08
"RTN","SDM1",2,0)
 ;;5.3;Scheduling;**32,167,168,80,223,263,273,408,327,478,490,446,547**;Aug 13, 1993;Build 17
"RTN","SDM1",3,0)
1 L  Q:$D(SDXXX)  S CCXN=0 K MXOK,COV,SDPROT Q:DFN<0  S SC=+SC
"RTN","SDM1",4,0)
 S X1=DT,SDEDT=365 S:$D(^SC(SC,"SDP")) SDEDT=$P(^SC(SC,"SDP"),"^",2)
"RTN","SDM1",5,0)
 S X2=SDEDT D C^%DTC S SDEDT=X D WRT
"RTN","SDM1",6,0)
 I $D(^SC(SC,"SI")),$O(^("SI",0))>0 W !,*7,?8,"**** SPECIAL INSTRUCTIONS ****",! S %I=0 F %=0:1 S %I=$O(^SC(SC,"SI",%I)) Q:%I'>0  W ^(%I,0) W:% ! I '%,$O(^SC(SC,"SI",%I))>0 S POP=0 D SPIN Q:POP
"RTN","SDM1",7,0)
 I $D(SDINA),SDINA>DT D IN W !,?8,@SDMSG K SDMSG
"RTN","SDM1",8,0)
 G:SDMM RDTY^SDMM
"RTN","SDM1",9,0)
 ;
"RTN","SDM1",10,0)
ADT S:'$D(SDW) SDW=""
"RTN","SDM1",11,0)
 S SDSOH=$S('$D(^SC(SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1),CCX=""
"RTN","SDM1",12,0)
 S SDONCE=$G(SDONCE)+1  ;Prevent repetitive iteration
"RTN","SDM1",13,0)
 ; Section introduced in 446.
"RTN","SDM1",14,0)
 N SDDATE1,SDQT,Y  ; Do not allow progress if there is no availability > 120 days after the desired date.
"RTN","SDM1",15,0)
 S SDDATE1=$S($G(SDDATE)="":DT,1:SDDATE)
"RTN","SDM1",16,0)
 S Y="" D  Q:Y="^"
"RTN","SDM1",17,0)
 .F  Q:Y="^"!$$WLCL120^SDM2A(SC,SDDATE1)  D
"RTN","SDM1",18,0)
 ..S Y=$$WLCLASK^SDM2A() Q:Y="^"  ; Y=0: New date, Y=1: place on EWL, Y="^": quit
"RTN","SDM1",19,0)
 ..I Y=0 D  Q
"RTN","SDM1",20,0)
 ...N SDMAX,SDDMAX
"RTN","SDM1",21,0)
 ...S SDMAX(1)=$P($G(^SC(+SC,"SDP")),U,2) S:'SDMAX(1) SDMAX(1)=365
"RTN","SDM1",22,0)
 ...S (SDMAX,SDDMAX)=$$FMADD^XLFDT(DT,SDMAX(1))
"RTN","SDM1",23,0)
 ...S Y=$$DDATE^SDM0(.SDDATE,"0^0",.SDMAX) Q:'Y  ; Y=0: "^" entered, Y=1: date entered
"RTN","SDM1",24,0)
 ...D D^SDM0
"RTN","SDM1",25,0)
 ...S SDDATE1=SDDATE
"RTN","SDM1",26,0)
 ...Q
"RTN","SDM1",27,0)
 ..D WL^SDM2A(SC)
"RTN","SDM1",28,0)
 ..S Y="^"  ; quit
"RTN","SDM1",29,0)
 ..Q
"RTN","SDM1",30,0)
 .Q
"RTN","SDM1",31,0)
 ;
"RTN","SDM1",32,0)
 S X=$S(SDONCE<2:$G(SDSDATE),1:"")  ;Use default date/time if specified as 'desired date'  
"RTN","SDM1",33,0)
 I 'X R !,"DATE/TIME: ",X:DTIME Q:X="^"!'$$WLCL120A^SDM2A(X,SDDATE1,SC)  ;sd/327,446
"RTN","SDM1",34,0)
 I X="" D WL(SC) Q  ;sd/446
"RTN","SDM1",35,0)
 G:X="M"!(X="m") MORDIS^SDM0
"RTN","SDM1",36,0)
 I X="D"!(X="d") S X=$$REDDT() G:X>0 MORD2^SDM0 S X="" W "  ??",! G ADT
"RTN","SDM1",37,0)
 I X?1"?".E D  G ADT
"RTN","SDM1",38,0)
 .W !,"Enter a date/time for the appointment - PAST dates must include the YEAR"  ;SD*547 added note about past dates
"RTN","SDM1",39,0)
 .W:$D(SD) " or a space to choose the same date/time as the patient you have just previously scheduled into this clinic"
"RTN","SDM1",40,0)
 .W ".",!,"You may also select 'M' to display the next month's availability or"
"RTN","SDM1",41,0)
 .W !,"'D' to specify an earlier or later date to begin the availability display."
"RTN","SDM1",42,0)
 I X=" ",$D(SD),SD S Y=SD D AT^SDUTL W Y S Y=SD G OVR
"RTN","SDM1",43,0)
 I $E($P(X,"@",2),1,4)?1.4"0" K %DT S X=$P(X,"@"),X=$S($L(X):X,1:"T"),%DT="XF" D ^%DT G ADT:Y'>0 S X1=Y,X2=-1 D C^%DTC S X=X_.24
"RTN","SDM1",44,0)
 K %DT S %DT="TXEF" D ^%DT
"RTN","SDM1",45,0)
 ;SD*5.3*408  verify that day hasn't been canceled via "SET UP A CLINIC"
"RTN","SDM1",46,0)
 I $G(^SC(+SC,"ST",$P(Y,"."),1))'="",^SC(+SC,"ST",$P(Y,"."),1)'["[" D  G ADT
"RTN","SDM1",47,0)
 .W !,"There is no availability for this date/time.",!
"RTN","SDM1",48,0)
 I $P(Y,".",2)=24 S X1=$P(Y,"."),X2=1 D C^%DTC S Y=X_".000001"
"RTN","SDM1",49,0)
OVR I $D(^HOLIDAY($P(Y,"."),0)),'SDSOH W *7,?50,$P(^(0),U,2),"??" K SDSDATE G ADT
"RTN","SDM1",50,0)
 I $D(SDINA),$P(Y,".")'<SDINA,$S('$D(SDRE):1,SDRE>$P(Y,".")!('SDRE):1,1:0) D IN W !,*7,@SDMSG K SDMSG K SDSDATE G ADT
"RTN","SDM1",51,0)
 I Y#1=0 K SDSDATE G 1
"RTN","SDM1",52,0)
 I $P(Y,".")'<SDEDT W !,*7,"EXCEEDS MAXIMUM DAYS FOR FUTURE APPOINTMENT!!",*7 K SDSDATE G ADT
"RTN","SDM1",53,0)
 ;
"RTN","SDM1",54,0)
EN1 S (TMPD,X,SD)=Y,SM=0 D DOW  ;SD/478
"RTN","SDM1",55,0)
 F S=$P(SD,"."):0 S S=+$O(^DPT(DFN,"S",S)) Q:$P(S,".")-($P(SD,"."))  S I=+^(S,0) G ^SDM2:$P(^(0),U,2)'["C"
"RTN","SDM1",56,0)
 ;
"RTN","SDM1",57,0)
PRECAN I $D(^DPT(DFN,"S",SD,0)),$P(^(0),U,2)["P" S %=1 W !,"THIS TIME WAS PREVIOUSLY CANCELLED BY THE PATIENT",!,"ARE YOU SURE THAT YOU WANT TO PROCEED" D YN^DICN W:'% !,"ANSWER WITH (Y)ES OR (N)O" I (%-1) K SDSDATE G ADT
"RTN","SDM1",58,0)
 W !
"RTN","SDM1",59,0)
 ;SD*5.3*490 - AVCHK/AVCHK1 to check against pat DOB and clinic avail dt
"RTN","SDM1",60,0)
S S POP=0 D AVCHK G:POP 1
"RTN","SDM1",61,0)
 S POP=0 D AVCHK1 G:POP 1
"RTN","SDM1",62,0)
 ;SD*5.3*547 if selected date is prior to the date the day of the week was added to clinic, do not set the date into availability pattern
"RTN","SDM1",63,0)
 I '$D(^SC(SC,"ST",$P(SD,"."),1)) D
"RTN","SDM1",64,0)
 .S XDT=X,POP=0
"RTN","SDM1",65,0)
 .D DOWCHK^SDM0
"RTN","SDM1",66,0)
 .K XDT
"RTN","SDM1",67,0)
 .K:POP SDSDATE
"RTN","SDM1",68,0)
 G:POP 1
"RTN","SDM1",69,0)
 K POP
"RTN","SDM1",70,0)
 I '$D(^SC(SC,"ST",$P(SD,"."),1)) S SS=+$O(^SC(+SC,"T"_Y,SD)) G XW:SS'>0,XW:^(SS,1)="" S ^SC(+SC,"ST",$P(SD,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(SD,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(SD,".")
"RTN","SDM1",71,0)
 ;
"RTN","SDM1",72,0)
LEN I $P(SL,U,2)]"" W !,"LENGTH OF APPOINTMENT (IN MINUTES): ",+SL,"// " R S:DTIME I S]"" G:$L(S)>3 LEN Q:U[S  S POP=0 D L G LEN:POP,S:S\5*5'=S,S:S>360,S:S<5 S SL=S_U_$P(SL,U,2,99)
"RTN","SDM1",73,0)
 ;
"RTN","SDM1",74,0)
SC S SDLOCK=$S('$D(SDLOCK):1,1:SDLOCK+1) G:SDLOCK>9 LOCK
"RTN","SDM1",75,0)
 L +^SC(SC,"ST",$P(SD,"."),1):$S($G(DILOCKTM)>0:DILOCKTM,1:5) G:'$T SC  ;SD*53.*547 new required lock functionality
"RTN","SDM1",76,0)
 S SDLOCK=0,S=^SC(SC,"ST",$P(SD,"."),1)
"RTN","SDM1",77,0)
 S I=SD#1-SB*100,ST=I#1*SI\.6+($P(I,".")*SI),SS=SL*HSI/60*SDDIF+ST+ST
"RTN","SDM1",78,0)
 G X:(I<1!'$F(S,"["))&(S'["CAN")
"RTN","SDM1",79,0)
 I SM<7 S %=$F(S,"[",SS-1) S:'%!($P(SL,"^",6)<3) %=999 I $F(S,"]",SS)'<%!(SDDIF=2&$E(S,ST+ST+1,SS-1)["[") S SM=7
"RTN","SDM1",80,0)
 ;
"RTN","SDM1",81,0)
SP I ST+ST>$L(S),$L(S)<80 S S=S_" " G SP
"RTN","SDM1",82,0)
 S SDNOT=1   ;SD*5.3*490 naked Do added below
"RTN","SDM1",83,0)
 F I=ST+ST:SDDIF:SS-SDDIF S ST=$E(S,I+1) S:ST="" ST=" " S Y=$E(STR,$F(STR,ST)-2) G C:S["CAN"!(ST="X"&($D(^SC(+SC,"ST",$P(SD,"."),"CAN")))),X:Y="" S:Y'?1NL&(SM<6) SM=6 S ST=$E(S,I+2,999) D  S:ST="" ST=" " S S=$E(S,1,I)_Y_ST
"RTN","SDM1",84,0)
 .Q:ST'=""
"RTN","SDM1",85,0)
 .Q:+SL'>+^SC(SC,"SL")
"RTN","SDM1",86,0)
 .S ST="   "
"RTN","SDM1",87,0)
 .Q
"RTN","SDM1",88,0)
 Q:SDMM  G OK^SDM1A:SM#9=0,^SDM3:$P(SL,U,7)]""&('$D(MXOK))
"RTN","SDM1",89,0)
 ;
"RTN","SDM1",90,0)
E G:'$D(^XUSEC("SDOB",DUZ)) NOOB
"RTN","SDM1",91,0)
 S %=2 W *7,!,$E($T(@SM),5,99),"...OK" D YN^DICN
"RTN","SDM1",92,0)
 I '% W !,"RESPOND YES OR NO" G E
"RTN","SDM1",93,0)
 S SM=9 G SC:'(%-1) K SDSDATE G 1
"RTN","SDM1",94,0)
 ;
"RTN","SDM1",95,0)
LOCK Q:SDMM  W !,*7,"ANOTHER USER HAS LOCKED THIS DATE - TRY AGAIN LATER" Q
"RTN","SDM1",96,0)
 ;
"RTN","SDM1",97,0)
6 ;;OVERBOOK!
"RTN","SDM1",98,0)
7 ;;THAT TIME IS NOT WITHIN SCHEDULED PERIOD!
"RTN","SDM1",99,0)
C S POP=1 W !,*7,"CAN'T BOOK WITHIN A CANCELLED TIME PERIOD!",!
"RTN","SDM1",100,0)
 Q:SDMM  K SDSDATE G 1
"RTN","SDM1",101,0)
 ;
"RTN","SDM1",102,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDM1",103,0)
 ;
"RTN","SDM1",104,0)
DOW S %=$E(X,1,3),Y=$E(X,4,5),Y=Y>2&'(%#4)+$E("144025036146",Y)
"RTN","SDM1",105,0)
 F %=%:-1:281 S Y=%#4=1+1+Y
"RTN","SDM1",106,0)
 S Y=$E(X,6,7)+Y#7 Q
"RTN","SDM1",107,0)
 ;
"RTN","SDM1",108,0)
X I SDMM S POP=1 Q
"RTN","SDM1",109,0)
 G:I<1 XW
"RTN","SDM1",110,0)
 S:Y'?1NL&(SM<6) SM=6
"RTN","SDM1",111,0)
 G OK^SDM1A:SM#9=0,^SDM3:$P(SL,U,7)]""&('$D(MXOK))
"RTN","SDM1",112,0)
XW W *7,"  WHEN??" K SDSDATE G 1
"RTN","SDM1",113,0)
 ;
"RTN","SDM1",114,0)
AVCHK ;added SD*5.3*490
"RTN","SDM1",115,0)
 I '$D(VADM) Q:'DFN  S VADM(3)=$P(^DPT(DFN,0),U,3)
"RTN","SDM1",116,0)
 Q:$P(X,".",1)=$P(VADM(3),U,1)
"RTN","SDM1",117,0)
 I $P(X,".",1)<$P(VADM(3),U,1) W *7,!!,"That date is prior to the patient's date of birth.",!! S POP=1 K SDSDATE Q
"RTN","SDM1",118,0)
 Q
"RTN","SDM1",119,0)
 ;
"RTN","SDM1",120,0)
AVCHK1 ;added SD*5.3*490
"RTN","SDM1",121,0)
 S AVDT=0,AVDT=$O(^SC(+SC,"T",AVDT)) Q:'AVDT
"RTN","SDM1",122,0)
 I $P(X,".",1)<AVDT W *7,!!,"That date is prior to the clinic's availability date.",!! S POP=1 K SDSDATE,AVDT Q
"RTN","SDM1",123,0)
 Q
"RTN","SDM1",124,0)
 ;
"RTN","SDM1",125,0)
NOOB W !,"NO OPEN SLOTS THEN",*7 K SDSDATE G 1
"RTN","SDM1",126,0)
 ;
"RTN","SDM1",127,0)
WRT W !,+SL," MINUTE APPOINTMENTS "
"RTN","SDM1",128,0)
 W $S($P(SL,U,2)["V":"(VARIABLE LENGTH)",1:"") Q
"RTN","SDM1",129,0)
 ;
"RTN","SDM1",130,0)
L S SDSL=$S($P(SL,"^",6)]"":60/$P(SL,"^",6),1:"") Q:'SDSL
"RTN","SDM1",131,0)
 I S\(SDSL)*(SDSL)'=S W *7,!,"Appt. length must = or be a multiple of the increment minutes per hour (",SDSL,")",! S POP=1
"RTN","SDM1",132,0)
 Q
"RTN","SDM1",133,0)
 ;
"RTN","SDM1",134,0)
IN S SDHY=$S($D(Y):Y,1:""),Y=SDINA D DTS^SDUTL S Y1=Y,Y=SDRE
"RTN","SDM1",135,0)
 D:Y DTS^SDUTL
"RTN","SDM1",136,0)
 S SDMSG="""*** Note: Clinic is scheduled to be inactivated on "","_""""_Y1_""""_$S(SDRE:",!,?10,"_""" and reactivated on "","_""""_Y_"""",1:""),Y=SDHY K Y1,SDHY
"RTN","SDM1",137,0)
 Q
"RTN","SDM1",138,0)
 ;
"RTN","SDM1",139,0)
SPIN W !,"There are more special instructions. Do you want to display them"
"RTN","SDM1",140,0)
 S %=2 D YN^DICN
"RTN","SDM1",141,0)
 I '% W !,"Enter Y to see the remaining special instructions, or N if you don't wish to see them" G SPIN
"RTN","SDM1",142,0)
 I (%-1) S POP=1 Q
"RTN","SDM1",143,0)
 W !,^SC(SC,"SI",%I,0),! Q
"RTN","SDM1",144,0)
 ;
"RTN","SDM1",145,0)
REDDT() ;Prompt for availability redisplay date
"RTN","SDM1",146,0)
 N %DT,X,Y
"RTN","SDM1",147,0)
 S %DT="AEX"
"RTN","SDM1",148,0)
 S %DT("A")="DATE TO BEGIN THE RE-DISPLAY OF CLINIC AVAILABILITY: "
"RTN","SDM1",149,0)
 W ! D ^%DT
"RTN","SDM1",150,0)
 Q Y
"RTN","SDM1",151,0)
WL(SC) ;Wait List Hook/teh patch 263 ;SD/327 passed 'SC'
"RTN","SDM1",152,0)
 Q:$G(SC)'>0
"RTN","SDM1",153,0)
 I '$D(^SC(SC)) Q
"RTN","SDM1",154,0)
 I $D(SC) S SDWLFLG=0 D
"RTN","SDM1",155,0)
 .I $D(^SDWL(409.32,"B",+SC)) S SDWLFLG=1
"RTN","SDM1",156,0)
 .I 'SDWLFLG S SDWLDSS=$P($G(^SC(+SC,0)),U,7) I $D(^SDWL(409.31,"B",SDWLDSS)) S SDWLFLG=2 D
"RTN","SDM1",157,0)
 ..I SDWLFLG=1 S SDWLSC=$O(^SDWL(409.32,"B",+SC,0)) I $P(^SDWL(409.32,SDWLSC,0),U,4) S SDWLFLG=0
"RTN","SDM1",158,0)
 .I SDWLFLG=2 S SDWLDS=$O(^SDWL(409.31,"E",DUZ(2),0)) I $D(^SDWL(409.31,SDWLDSS,"I",+SDWLDS,0)),$P(^(0),U,4) S SDWLFLG=0
"RTN","SDM1",159,0)
 .I SDWLFLG D
"RTN","SDM1",160,0)
 ..K SDWLSC,SDWLDSS,SDWLDS,SDWLFLG
"RTN","SDM1",161,0)
 ..S SDWLOPT=1,SDWLERR=0 D OPT^SDWLE D EN^SDWLKIL
"RTN","SDM1",162,0)
 Q
"RTN","SDSCRP")
0^3^B12484376^B11792085
"RTN","SDSCRP",1,0)
SDSCRP ;ALB/JAM - Restricted Stop Code Nonconforming Clinic Report; 07/24/03
"RTN","SDSCRP",2,0)
 ;;5.3;Scheduling;**317,547**;Aug 13, 1993;Build 17
"RTN","SDSCRP",3,0)
 ;
"RTN","SDSCRP",4,0)
EN ;foreground entry point
"RTN","SDSCRP",5,0)
 N ZTRTN,ZTDESC,ZTIO,ZTQUEUED,SDPCF,DIR,DIRUT,X,Y
"RTN","SDSCRP",6,0)
 W @IOF
"RTN","SDSCRP",7,0)
 S DIR(0)="SO^A:Active Clinics;I:Inactive Clinics;B:Both"
"RTN","SDSCRP",8,0)
 S DIR("A")="Select Report"
"RTN","SDSCRP",9,0)
 S DIR("?",1)="Enter an A for Active Clinics, I for Inactive Clinics,"
"RTN","SDSCRP",10,0)
 S DIR("?")="B for Both Active and Inactive Clinics"
"RTN","SDSCRP",11,0)
 D ^DIR K DIR I $D(DIRUT) G END
"RTN","SDSCRP",12,0)
 S SDPCF=Y
"RTN","SDSCRP",13,0)
 ;device selection
"RTN","SDSCRP",14,0)
 K IOP,%ZIS,POP,IO("Q")
"RTN","SDSCRP",15,0)
 S %ZIS("A")="Select Device: ",%ZIS="QM" D ^%ZIS I POP G END
"RTN","SDSCRP",16,0)
 I $D(IO("Q")) K IO("Q") D  G END
"RTN","SDSCRP",17,0)
 .S ZTDESC="Non-Conforming Clinics Stop Code Report",ZTSAVE("SDPCF")=""
"RTN","SDSCRP",18,0)
 .S ZTRTN="PROCESS^SDSCRP",ZTIO=ION D ^%ZTLOAD,HOME^%ZIS K ZTSK
"RTN","SDSCRP",19,0)
 U IO
"RTN","SDSCRP",20,0)
 D PROCESS
"RTN","SDSCRP",21,0)
END D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","SDSCRP",22,0)
 Q
"RTN","SDSCRP",23,0)
 ;
"RTN","SDSCRP",24,0)
PROCESS ;background entry point
"RTN","SDSCRP",25,0)
 ;locate invalid Stop Code in HOSPITAL LOCATION file #44
"RTN","SDSCRP",26,0)
 N NAM,IDT,RDT,IDAT,STR,ECX,IEN,PSC,SSC,PSCN,SSCN,CNTX,SDPG,SDOUT,SDF,LNS
"RTN","SDSCRP",27,0)
 N ACF,SDRDT
"RTN","SDSCRP",28,0)
 S %H=$H D YX^%DTC S SDRDT=Y
"RTN","SDSCRP",29,0)
 S $P(LNS,"-",80)="",(CNTX,IEN,SDOUT,SDF)=0,SDPG=1
"RTN","SDSCRP",30,0)
 D HDR
"RTN","SDSCRP",31,0)
 ;search file #44 for invalid entries
"RTN","SDSCRP",32,0)
 F  S IEN=$O(^SC(IEN)) Q:'IEN  D  Q:SDOUT  S:SDF CNTX=CNTX+1
"RTN","SDSCRP",33,0)
 .S ECX=$G(^SC(IEN,0)),PSC=$P(ECX,U,7),SSC=$P(ECX,U,18),SDF=0
"RTN","SDSCRP",34,0)
 .I $P(ECX,U,3)'="C" Q
"RTN","SDSCRP",35,0)
 .S NAM=$P(ECX,U),IDAT=$G(^SC(IEN,"I")) I IDAT'="" D
"RTN","SDSCRP",36,0)
 ..S IDT=$P(IDAT,U),RDT=$P(IDAT,U,2) Q:IDT=""  I RDT="" S NAM="*"_NAM Q
"RTN","SDSCRP",37,0)
 ..I RDT>IDT S NAM="*"_NAM
"RTN","SDSCRP",38,0)
 .S ACF=$S($E(NAM)="*":0,1:1)
"RTN","SDSCRP",39,0)
 .I $S((SDPCF="A")&('ACF):1,(SDPCF="I")&(ACF):1,1:0) Q
"RTN","SDSCRP",40,0)
 .S PSCN=$S(PSC:$P($G(^DIC(40.7,PSC,0)),U,2),1:"")
"RTN","SDSCRP",41,0)
 .S SSCN=$S(SSC:$P($G(^DIC(40.7,SSC,0)),U,2),1:"")
"RTN","SDSCRP",42,0)
 .D  I SDOUT Q
"RTN","SDSCRP",43,0)
 ..I PSC="" S STR="Missing primary code" D PRN Q
"RTN","SDSCRP",44,0)
 ..D SCCHK(PSC,"P") I $D(STR) D PRN
"RTN","SDSCRP",45,0)
 .I SSC'="" D SCCHK(SSC,"S") I $D(STR) D PRN
"RTN","SDSCRP",46,0)
 W !!,?25,$S(CNTX:CNTX,1:"NO")_" PROBLEM CLINICS FOUND."
"RTN","SDSCRP",47,0)
 K SCIEN,TYP
"RTN","SDSCRP",48,0)
 Q
"RTN","SDSCRP",49,0)
 ;
"RTN","SDSCRP",50,0)
PRN ;print line
"RTN","SDSCRP",51,0)
 I ($Y+3)>IOSL D PAGE,HDR I SDOUT Q
"RTN","SDSCRP",52,0)
 W !,IEN,?8,$E(NAM,1,28),?37,PSCN,?46,SSCN,?57,STR
"RTN","SDSCRP",53,0)
 S SDF=1
"RTN","SDSCRP",54,0)
 Q
"RTN","SDSCRP",55,0)
 ;
"RTN","SDSCRP",56,0)
SCCHK(SCIEN,TYP) ;check stop code against file 40.7; var INACT added SD*547
"RTN","SDSCRP",57,0)
 N SCN,RTY,CTY,INACT
"RTN","SDSCRP",58,0)
 K STR
"RTN","SDSCRP",59,0)
 S CTY=$S(TYP="P":"^P^E^",1:"^S^E^")
"RTN","SDSCRP",60,0)
 S SCN=$G(^DIC(40.7,SCIEN,0)),RTY=$P(SCN,U,6),INACT=$P(SCN,U,3),SCN=$P(SCN,U,2)
"RTN","SDSCRP",61,0)
 I INACT S STR=SCN_" Inactivated "_$$FMTE^XLFDT(INACT,2) Q  ;SD*5.3*547
"RTN","SDSCRP",62,0)
 I SCN="" D  Q
"RTN","SDSCRP",63,0)
 .S STR=SCIEN_" Inv "_$S(TYP="P":"prim",1:"2nd")_" pointr"
"RTN","SDSCRP",64,0)
 I RTY="" S STR=SCN_" No restriction type" Q
"RTN","SDSCRP",65,0)
 I CTY'[("^"_RTY_"^") D
"RTN","SDSCRP",66,0)
 .S STR=SCN_" cannot be "_$S(TYP="P":"prim",1:"second")_"ary"
"RTN","SDSCRP",67,0)
 Q
"RTN","SDSCRP",68,0)
 ;
"RTN","SDSCRP",69,0)
HDR ;Header for data from file #44
"RTN","SDSCRP",70,0)
 W @IOF
"RTN","SDSCRP",71,0)
 W SDRDT,?73,"Page: ",SDPG,!
"RTN","SDSCRP",72,0)
 W !,?18,"NON-CONFORMING CLINICS STOP CODE REPORT",!,?32
"RTN","SDSCRP",73,0)
 W $S(SDPCF="A":"Active",SDPCF="I":"Inactive",1:"All")_" Clinics",!
"RTN","SDSCRP",74,0)
 W !,"HOSPITAL LOCATION FILE (#44) - (Use Set up a Clinic [SDBUILD]"
"RTN","SDSCRP",75,0)
 W " menu option to",!,?32,"make corrections)"
"RTN","SDSCRP",76,0)
 W !!,?37,"PRIMARY",?46,"SECONDARY",?57,"REASON FOR"
"RTN","SDSCRP",77,0)
 W !?8,$S(SDPCF="B":"CLINIC NAME",1:""),?37,"STOP",?46,"CREDIT",?57,"NON"
"RTN","SDSCRP",78,0)
 W !,"IEN",?8,$S(SDPCF="B":"(*currently inactive)",1:"CLINIC NAME")
"RTN","SDSCRP",79,0)
 W ?37,"CODE",?46,"STOP CODE",?57,"CONFORMANCE",!,$E(LNS,1,80)
"RTN","SDSCRP",80,0)
 S SDPG=SDPG+1
"RTN","SDSCRP",81,0)
 Q
"RTN","SDSCRP",82,0)
 ;
"RTN","SDSCRP",83,0)
PAGE ;
"RTN","SDSCRP",84,0)
 N SS,JJ,DIR,X,Y
"RTN","SDSCRP",85,0)
 I $E(IOST,1,2)="C-" D
"RTN","SDSCRP",86,0)
 . S SS=22-$Y F JJ=1:1:SS W !
"RTN","SDSCRP",87,0)
 . S DIR(0)="E" W ! D ^DIR K DIR I 'Y S SDOUT=1
"RTN","SDSCRP",88,0)
 Q
"VER")
8.0^22.0
"BLD",7959,6)
^460
**END**
**END**

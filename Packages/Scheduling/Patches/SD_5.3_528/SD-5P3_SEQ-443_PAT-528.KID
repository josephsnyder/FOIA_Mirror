Released SD*5.3*528 SEQ #443
Extracted from mail message
**KIDS**:SD*5.3*528^

**INSTALL NAME**
SD*5.3*528
"BLD",7633,0)
SD*5.3*528^SCHEDULING^0^3080701^y
"BLD",7633,1,0)
^^1^1^3080701^
"BLD",7633,1,1,0)
This patch addresses five fixes related to PCMM, EWL and PAIT. 
"BLD",7633,4,0)
^9.64PA^^
"BLD",7633,6.3)
4
"BLD",7633,"KRN",0)
^9.67PA^8989.52^19
"BLD",7633,"KRN",.4,0)
.4
"BLD",7633,"KRN",.401,0)
.401
"BLD",7633,"KRN",.402,0)
.402
"BLD",7633,"KRN",.403,0)
.403
"BLD",7633,"KRN",.5,0)
.5
"BLD",7633,"KRN",.84,0)
.84
"BLD",7633,"KRN",3.6,0)
3.6
"BLD",7633,"KRN",3.8,0)
3.8
"BLD",7633,"KRN",9.2,0)
9.2
"BLD",7633,"KRN",9.8,0)
9.8
"BLD",7633,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",7633,"KRN",9.8,"NM",1,0)
SCRPV1A^^0^B44528362
"BLD",7633,"KRN",9.8,"NM",2,0)
SDRPA07^^0^B60226840
"BLD",7633,"KRN",9.8,"NM",3,0)
SDM2A^^0^B17573653
"BLD",7633,"KRN",9.8,"NM",4,0)
SDWLQSC1^^0^B19655747
"BLD",7633,"KRN",9.8,"NM",5,0)
SDRPA08^^0^B40122267
"BLD",7633,"KRN",9.8,"NM","B","SCRPV1A",1)

"BLD",7633,"KRN",9.8,"NM","B","SDM2A",3)

"BLD",7633,"KRN",9.8,"NM","B","SDRPA07",2)

"BLD",7633,"KRN",9.8,"NM","B","SDRPA08",5)

"BLD",7633,"KRN",9.8,"NM","B","SDWLQSC1",4)

"BLD",7633,"KRN",19,0)
19
"BLD",7633,"KRN",19.1,0)
19.1
"BLD",7633,"KRN",101,0)
101
"BLD",7633,"KRN",409.61,0)
409.61
"BLD",7633,"KRN",771,0)
771
"BLD",7633,"KRN",870,0)
870
"BLD",7633,"KRN",8989.51,0)
8989.51
"BLD",7633,"KRN",8989.52,0)
8989.52
"BLD",7633,"KRN",8994,0)
8994
"BLD",7633,"KRN","B",.4,.4)

"BLD",7633,"KRN","B",.401,.401)

"BLD",7633,"KRN","B",.402,.402)

"BLD",7633,"KRN","B",.403,.403)

"BLD",7633,"KRN","B",.5,.5)

"BLD",7633,"KRN","B",.84,.84)

"BLD",7633,"KRN","B",3.6,3.6)

"BLD",7633,"KRN","B",3.8,3.8)

"BLD",7633,"KRN","B",9.2,9.2)

"BLD",7633,"KRN","B",9.8,9.8)

"BLD",7633,"KRN","B",19,19)

"BLD",7633,"KRN","B",19.1,19.1)

"BLD",7633,"KRN","B",101,101)

"BLD",7633,"KRN","B",409.61,409.61)

"BLD",7633,"KRN","B",771,771)

"BLD",7633,"KRN","B",870,870)

"BLD",7633,"KRN","B",8989.51,8989.51)

"BLD",7633,"KRN","B",8989.52,8989.52)

"BLD",7633,"KRN","B",8994,8994)

"BLD",7633,"QDEF")
^^^^^^^^^^YES
"BLD",7633,"QUES",0)
^9.62^^
"BLD",7633,"REQB",0)
^9.611^3^3
"BLD",7633,"REQB",1,0)
SD*5.3*446^2
"BLD",7633,"REQB",2,0)
SD*5.3*177^2
"BLD",7633,"REQB",3,0)
SD*5.3*376^2
"BLD",7633,"REQB","B","SD*5.3*177",2)

"BLD",7633,"REQB","B","SD*5.3*376",3)

"BLD",7633,"REQB","B","SD*5.3*446",1)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813
"PKG",16,22,1,"PAH",1,0)
528^3080701
"PKG",16,22,1,"PAH",1,1,0)
^^1^1^3080701
"PKG",16,22,1,"PAH",1,1,1,0)
This patch addresses five fixes related to PCMM, EWL and PAIT. 
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","SCRPV1A")
0^1^B44528362^B43993883
"RTN","SCRPV1A",1,0)
SCRPV1A ; bp/djb - PCMM Inconsistency Rpt - Get Data ; 8/25/99 9:57am
"RTN","SCRPV1A",2,0)
 ;;5.3;Scheduling;**177,528**;AUG 13, 1993;Build 4
"RTN","SCRPV1A",3,0)
 ;
"RTN","SCRPV1A",4,0)
 ;Return:
"RTN","SCRPV1A",5,0)
 ;  Inconsistency array in format:
"RTN","SCRPV1A",6,0)
 ;     ^TMP("PCMM POSITION",$J,#,Tm,TmPos,)=""
"RTN","SCRPV1A",7,0)
 ;     ^TMP("PCMM PATIENT",$J,Name,DFN,#,Tm,Pos)=""
"RTN","SCRPV1A",8,0)
 ;
"RTN","SCRPV1A",9,0)
 ;For a list of inconsistencies, see bottom of routine SCRPV1B.
"RTN","SCRPV1A",10,0)
 ;
"RTN","SCRPV1A",11,0)
EN ;
"RTN","SCRPV1A",12,0)
 D POSITION
"RTN","SCRPV1A",13,0)
 D PATIENT
"RTN","SCRPV1A",14,0)
 Q
"RTN","SCRPV1A",15,0)
 ;
"RTN","SCRPV1A",16,0)
POSITION ;Check for position inconsistencies.
"RTN","SCRPV1A",17,0)
 ;
"RTN","SCRPV1A",18,0)
 NEW POSI,POSN,TMI,TMN
"RTN","SCRPV1A",19,0)
 ;
"RTN","SCRPV1A",20,0)
 ;Look at each team
"RTN","SCRPV1A",21,0)
 S TMN=""
"RTN","SCRPV1A",22,0)
 F  S TMN=$O(^SCTM(404.51,"B",TMN)) Q:TMN=""  D  ;
"RTN","SCRPV1A",23,0)
 . S TMI=0
"RTN","SCRPV1A",24,0)
 . F  S TMI=$O(^SCTM(404.51,"B",TMN,TMI)) Q:'TMI  D  ;
"RTN","SCRPV1A",25,0)
 .. Q:'$D(^SCTM(404.51,TMI,0))
"RTN","SCRPV1A",26,0)
 .. ;If user selected teams, quit if this one isn't on list.
"RTN","SCRPV1A",27,0)
 .. I SCTYPE("TM")="S" Q:'$D(SCTM(TMI))
"RTN","SCRPV1A",28,0)
 .. ;Look at each position for this team
"RTN","SCRPV1A",29,0)
 .. S POSI=0
"RTN","SCRPV1A",30,0)
 .. F  S POSI=$O(^SCTM(404.57,"C",TMI,POSI)) Q:'POSI  D  ;
"RTN","SCRPV1A",31,0)
 ... S POSN=$P($G(^SCTM(404.57,POSI,0)),U,1) Q:POSN']""
"RTN","SCRPV1A",32,0)
 ... D CHECK45(TMI,POSI) ;..Check for inconsistencies 4 & 5.
"RTN","SCRPV1A",33,0)
 ... Q:'$D(^SCPT(404.43,"APTPA",POSI))
"RTN","SCRPV1A",34,0)
 ... D CHECK1(TMI,POSI) ;...Check for inconsistency 1.
"RTN","SCRPV1A",35,0)
 Q
"RTN","SCRPV1A",36,0)
 ;
"RTN","SCRPV1A",37,0)
PATIENT ;Check for patient inconsistencies.
"RTN","SCRPV1A",38,0)
 D CHECK28
"RTN","SCRPV1A",39,0)
 D CHECK367
"RTN","SCRPV1A",40,0)
 Q
"RTN","SCRPV1A",41,0)
 ;
"RTN","SCRPV1A",42,0)
CHECK1(TMI,POSI) ;Check positions for inconsistency 1.
"RTN","SCRPV1A",43,0)
 ;Input:
"RTN","SCRPV1A",44,0)
 ;   TMI  - Team IEN
"RTN","SCRPV1A",45,0)
 ;   POSI - Team Position IEN
"RTN","SCRPV1A",46,0)
 ;
"RTN","SCRPV1A",47,0)
 NEW POSN,TMN
"RTN","SCRPV1A",48,0)
 Q:+$$GETPRTP^SCAPMCU2(POSI,DT)  ;Current provider. Fld 304 in 404.57.
"RTN","SCRPV1A",49,0)
 Q:+$$ACTTM^SCMCTMU(TMI,DT)'=1  ;Team inactive
"RTN","SCRPV1A",50,0)
 Q:+$$ACTTP^SCMCTPU(POSI,DT)'=1  ;Position inactive
"RTN","SCRPV1A",51,0)
 S TMN=$$TMNAME(TMI)
"RTN","SCRPV1A",52,0)
 S POSN=$$POSNAME(POSI)
"RTN","SCRPV1A",53,0)
 S ^TMP("PCMM POSITION",$J,1,TMN,POSN)="" ;.........................#1
"RTN","SCRPV1A",54,0)
 Q
"RTN","SCRPV1A",55,0)
 ;
"RTN","SCRPV1A",56,0)
CHECK28 ;Check patients for inconsistencies 2 & 8.
"RTN","SCRPV1A",57,0)
 ;
"RTN","SCRPV1A",58,0)
 ;Loop thru 404.43 for each patient.
"RTN","SCRPV1A",59,0)
 ;Use "ACTDFN" xref. Active entries sorted by patient IEN.
"RTN","SCRPV1A",60,0)
 ;
"RTN","SCRPV1A",61,0)
 NEW DATA,DFN,DFNNAM,NUM,POSI,POSN,PTI,PTPI,TMI,TMN
"RTN","SCRPV1A",62,0)
 ;
"RTN","SCRPV1A",63,0)
 S DFN=0
"RTN","SCRPV1A",64,0)
 F  S DFN=$O(^SCPT(404.43,"ACTDFN",DFN)) Q:'DFN  D  ;
"RTN","SCRPV1A",65,0)
 . S PTPI=0
"RTN","SCRPV1A",66,0)
 . F  S PTPI=$O(^SCPT(404.43,"ACTDFN",DFN,PTPI)) Q:'PTPI  D  ;
"RTN","SCRPV1A",67,0)
 .. S DATA=$G(^SCPT(404.43,PTPI,0)) ;Team Position Assign zero node
"RTN","SCRPV1A",68,0)
 .. Q:$P(DATA,U,4)]""  ;.............Inactive
"RTN","SCRPV1A",69,0)
 .. S PTI=$P(DATA,U,1) Q:'PTI  ;.....Team Assign IEN
"RTN","SCRPV1A",70,0)
 .. S POSI=$P(DATA,U,2) Q:'POSI  ;...Position
"RTN","SCRPV1A",71,0)
 .. S DATA=$G(^SCPT(404.42,PTI,0)) ;.Team Assign zero node
"RTN","SCRPV1A",72,0)
 .. S TMI=$P(DATA,U,3) Q:'TMI  ;.....Team IEN
"RTN","SCRPV1A",73,0)
 .. ;
"RTN","SCRPV1A",74,0)
 .. ;If user selected teams, quit if this one isn't on list.
"RTN","SCRPV1A",75,0)
 .. I SCTYPE("TM")="S" Q:'$D(SCTM(TMI))
"RTN","SCRPV1A",76,0)
 .. ;
"RTN","SCRPV1A",77,0)
 .. S POSN=$$POSNAME(POSI)
"RTN","SCRPV1A",78,0)
 .. S TMN=$$TMNAME(TMI)
"RTN","SCRPV1A",79,0)
 .. S DFNNAM=$$PTNAME(DFN) ;Patient name
"RTN","SCRPV1A",80,0)
 .. ;
"RTN","SCRPV1A",81,0)
 .. D  ;Check for nconsistency 8
"RTN","SCRPV1A",82,0)
 ... I $P(DATA,U,9)]"" D  ;...............Tm Pos Assign Inactive....#8
"RTN","SCRPV1A",83,0)
 .... S ^TMP("PCMM PATIENT",$J,DFNNAM,DFN,8.1,TMN,POSN)=PTPI
"RTN","SCRPV1A",84,0)
 ... I +$$ACTTM^SCMCTMU(TMI,DT)'=1 D  ;...Team inactive.............#8
"RTN","SCRPV1A",85,0)
 .... S ^TMP("PCMM PATIENT",$J,DFNNAM,DFN,8.2,TMN,POSN)=PTPI
"RTN","SCRPV1A",86,0)
 ... I +$$ACTTP^SCMCTPU(POSI,DT)'=1 D  ;..Position inactive.........#8
"RTN","SCRPV1A",87,0)
 .... S ^TMP("PCMM PATIENT",$J,DFNNAM,DFN,8.3,TMN,POSN)=PTPI
"RTN","SCRPV1A",88,0)
 .. ;
"RTN","SCRPV1A",89,0)
 .. Q:$P(DATA,U,8)'=1  ;..Team Assign not PC
"RTN","SCRPV1A",90,0)
 .. Q:$P(DATA,U,9)]""  ;..Team Assign inactive
"RTN","SCRPV1A",91,0)
 .. ;
"RTN","SCRPV1A",92,0)
 .. ;Q:$D(^SCPT(404.43,"APCPOS",DFN,1))
"RTN","SCRPV1A",93,0)
 .. I $$GETPRTP^SCAPMCU2(POSI,DT)>0 Q  ;sd/528
"RTN","SCRPV1A",94,0)
 .. S ^TMP("PCMM PATIENT",$J,DFNNAM,DFN,2,TMN,POSN)=PTPI ;..........#2
"RTN","SCRPV1A",95,0)
 Q
"RTN","SCRPV1A",96,0)
 ;
"RTN","SCRPV1A",97,0)
CHECK367 ;Check patients for inconsistencies 3,6,7.
"RTN","SCRPV1A",98,0)
 ;
"RTN","SCRPV1A",99,0)
 ;Loop thru 404.43 for each patient.
"RTN","SCRPV1A",100,0)
 ;Use "ACTPC" xref. Active entries sorted by patient IEN & PC ROLE.
"RTN","SCRPV1A",101,0)
 ;
"RTN","SCRPV1A",102,0)
 NEW CNT,DATA,DFN,DFNNAM,HLD,POSI,POSN,PTI,PTPI,TMI,TMN
"RTN","SCRPV1A",103,0)
 ;
"RTN","SCRPV1A",104,0)
 S DFN=0
"RTN","SCRPV1A",105,0)
 F  S DFN=$O(^SCPT(404.43,"ACTPC",DFN)) Q:'DFN  D  ;
"RTN","SCRPV1A",106,0)
 . S CNT=0 KILL HLD ;Initialize for each DFN
"RTN","SCRPV1A",107,0)
 . S PTPI=0
"RTN","SCRPV1A",108,0)
 . F  S PTPI=$O(^SCPT(404.43,"ACTPC",DFN,1,PTPI)) Q:'PTPI  D  ;
"RTN","SCRPV1A",109,0)
 .. S DATA=$G(^SCPT(404.43,PTPI,0)) ;..Team Position Assign zero node
"RTN","SCRPV1A",110,0)
 .. Q:$P(DATA,U,4)]""  ;...............Inactive
"RTN","SCRPV1A",111,0)
 .. S PTI=$P(DATA,U,1) Q:'PTI  ;.......Team Assign IEN
"RTN","SCRPV1A",112,0)
 .. S POSI=$P(DATA,U,2) Q:'POSI  ;.....Position
"RTN","SCRPV1A",113,0)
 .. S DATA=$G(^SCPT(404.42,PTI,0)) ;...Team Assign zero node
"RTN","SCRPV1A",114,0)
 .. S TMI=$P(DATA,U,3) Q:'TMI  ;.......Team IEN
"RTN","SCRPV1A",115,0)
 .. ;
"RTN","SCRPV1A",116,0)
 .. ;If user selected teams, quit if this one isn't on list.
"RTN","SCRPV1A",117,0)
 .. I SCTYPE("TM")="S" Q:'$D(SCTM(TMI))
"RTN","SCRPV1A",118,0)
 .. ;
"RTN","SCRPV1A",119,0)
 .. Q:$P(DATA,U,8)'=1  ;...............Team Assign not PC
"RTN","SCRPV1A",120,0)
 .. Q:$P(DATA,U,9)]""  ;...............Team Assign inactive
"RTN","SCRPV1A",121,0)
 .. S POSN=$$POSNAME(POSI)
"RTN","SCRPV1A",122,0)
 .. S TMN=$$TMNAME(TMI)
"RTN","SCRPV1A",123,0)
 .. S DFNNAM=$$PTNAME(DFN) ;Patient name
"RTN","SCRPV1A",124,0)
 .. ;
"RTN","SCRPV1A",125,0)
 .. D CHECK67
"RTN","SCRPV1A",126,0)
 .. ;
"RTN","SCRPV1A",127,0)
 .. S CNT=CNT+1
"RTN","SCRPV1A",128,0)
 .. ;Save 1st occurance. Asingle occurance is not a problem.
"RTN","SCRPV1A",129,0)
 .. I CNT=1 S HLD(DFNNAM,DFN,3,TMN,POSN)="" Q
"RTN","SCRPV1A",130,0)
 .. ;
"RTN","SCRPV1A",131,0)
 .. ;If there is a 2nd occurance, move 1st occurance into array.
"RTN","SCRPV1A",132,0)
 .. I CNT=2 M ^TMP("PCMM PATIENT",$J)=HLD KILL HLD
"RTN","SCRPV1A",133,0)
 .. S ^TMP("PCMM PATIENT",$J,DFNNAM,DFN,3,TMN,POSN)=PTPI ;..........#3
"RTN","SCRPV1A",134,0)
 Q
"RTN","SCRPV1A",135,0)
 ;
"RTN","SCRPV1A",136,0)
CHECK45(TMI,POSI) ;Check positions for inconsistencies 4 & 5.
"RTN","SCRPV1A",137,0)
 ;Input:
"RTN","SCRPV1A",138,0)
 ;   TMI  - Team IEN
"RTN","SCRPV1A",139,0)
 ;   POSI - Team Position IEN
"RTN","SCRPV1A",140,0)
 ;
"RTN","SCRPV1A",141,0)
 NEW AP,DATA,PCP,POSN,PREHI,STAFFAP,STAFFPCP,TMN
"RTN","SCRPV1A",142,0)
 ;
"RTN","SCRPV1A",143,0)
 S PREHI=0
"RTN","SCRPV1A",144,0)
 F  S PREHI=$O(^SCTM(404.53,"B",POSI,PREHI)) Q:'PREHI  D  ;
"RTN","SCRPV1A",145,0)
 . S DATA=$G(^SCTM(404.53,PREHI,0))
"RTN","SCRPV1A",146,0)
 . Q:DATA']""
"RTN","SCRPV1A",147,0)
 . S AP=$P(DATA,U,1) ;.....................Preceptee position
"RTN","SCRPV1A",148,0)
 . S PCP=$P(DATA,U,6) ;....................Preceptor position
"RTN","SCRPV1A",149,0)
 . S STAFFAP=+$$GETPRTP^SCAPMCU2(AP,DT) ;..Preceptee staff person
"RTN","SCRPV1A",150,0)
 . S STAFFPCP=+$$GETPRTP^SCAPMCU2(PCP,DT) ;Preceptor staff person
"RTN","SCRPV1A",151,0)
 . ;
"RTN","SCRPV1A",152,0)
 . S TMN=$$TMNAME(TMI)
"RTN","SCRPV1A",153,0)
 . S POSN=$$POSNAME(POSI)
"RTN","SCRPV1A",154,0)
 . I STAFFAP,STAFFAP=STAFFPCP D  ;
"RTN","SCRPV1A",155,0)
 .. S ^TMP("PCMM POSITION",$J,4,TMN,POSN)="" ;......................#4
"RTN","SCRPV1A",156,0)
 . I STAFFPCP="" D  ;
"RTN","SCRPV1A",157,0)
 .. S ^TMP("PCMM POSITION",$J,5,TMN,POSN)="" ;......................#5
"RTN","SCRPV1A",158,0)
 Q
"RTN","SCRPV1A",159,0)
 ;
"RTN","SCRPV1A",160,0)
CHECK67 ;Check patients for inconsistencies 6 & 7.
"RTN","SCRPV1A",161,0)
 NEW ERROR,ID,LIST,NUM,POS,RESULT,TYPE,ZDATE
"RTN","SCRPV1A",162,0)
 ;
"RTN","SCRPV1A",163,0)
 S ZDATE("BEGIN")=DT
"RTN","SCRPV1A",164,0)
 S ZDATE("END")=DT
"RTN","SCRPV1A",165,0)
 S ZDATE("INCL")=0
"RTN","SCRPV1A",166,0)
 ;
"RTN","SCRPV1A",167,0)
 S RESULT=$$PRPTTPC^SCAPMC(PTPI,"ZDATE","LIST","ERROR",1)
"RTN","SCRPV1A",168,0)
 ;
"RTN","SCRPV1A",169,0)
 S NUM=0
"RTN","SCRPV1A",170,0)
 F  S NUM=$O(LIST(NUM)) Q:'NUM  D  ;
"RTN","SCRPV1A",171,0)
 . S TYPE=""
"RTN","SCRPV1A",172,0)
 . F  S TYPE=$O(LIST(NUM,TYPE)) Q:TYPE=""  D  ;
"RTN","SCRPV1A",173,0)
 .. S ID=""
"RTN","SCRPV1A",174,0)
 .. F  S ID=$O(LIST(NUM,TYPE,ID)) Q:ID=""  D  ;
"RTN","SCRPV1A",175,0)
 ... S POS=$P(LIST(NUM,TYPE,ID),U,3) Q:'POS
"RTN","SCRPV1A",176,0)
 ... ;See if field 4, POSSIBLE PRIMARY PRACTITIONER, equals 1.
"RTN","SCRPV1A",177,0)
 ... Q:$P($G(^SCTM(404.57,POS,0)),U,4)=1
"RTN","SCRPV1A",178,0)
 ... I TYPE="AP" D  Q
"RTN","SCRPV1A",179,0)
 .... S ^TMP("PCMM PATIENT",$J,DFNNAM,DFN,6,TMN,POSN)=PTPI ;........#6
"RTN","SCRPV1A",180,0)
 ... I TYPE="PCP" D  Q
"RTN","SCRPV1A",181,0)
 .... S ^TMP("PCMM PATIENT",$J,DFNNAM,DFN,7,TMN,POSN)=PTPI ;........#7
"RTN","SCRPV1A",182,0)
 Q
"RTN","SCRPV1A",183,0)
 ;
"RTN","SCRPV1A",184,0)
TMNAME(TMI) ;Return team name
"RTN","SCRPV1A",185,0)
 NEW NAME
"RTN","SCRPV1A",186,0)
 S NAME=$P($G(^SCTM(404.51,TMI,0)),U,1)
"RTN","SCRPV1A",187,0)
 S:NAME="" NAME="UNKNOWN"
"RTN","SCRPV1A",188,0)
 Q NAME
"RTN","SCRPV1A",189,0)
 ;
"RTN","SCRPV1A",190,0)
POSNAME(POSI) ;Return position name
"RTN","SCRPV1A",191,0)
 NEW NAME
"RTN","SCRPV1A",192,0)
 S NAME=$P($G(^SCTM(404.57,POSI,0)),U,1)
"RTN","SCRPV1A",193,0)
 S:NAME="" NAME="UNKNOWN"
"RTN","SCRPV1A",194,0)
 Q NAME
"RTN","SCRPV1A",195,0)
 ;
"RTN","SCRPV1A",196,0)
PTNAME(DFN) ;Return patient name
"RTN","SCRPV1A",197,0)
 NEW NAME
"RTN","SCRPV1A",198,0)
 S NAME=$P($G(^DPT(DFN,0)),U,1)
"RTN","SCRPV1A",199,0)
 S:NAME="" NAME="UNKNOWN"
"RTN","SCRPV1A",200,0)
 Q NAME
"RTN","SDM2A")
0^3^B17573653^B17556910
"RTN","SDM2A",1,0)
SDM2A ; OG - MAKE APPOINTMENT - overflow routine due to SACC 10K limit.  ; Compiled August 28, 2007 16:08:18  ; Compiled June 13, 2008 16:32:51  ; Compiled June 24, 2008 11:57:22
"RTN","SDM2A",2,0)
 ;;5.3;Scheduling;**446,528**;Aug 13 1993;Build 4
"RTN","SDM2A",3,0)
WL(SC) ;Wait List Hook/teh patch 263 ;SD/327 passed 'SC'
"RTN","SDM2A",4,0)
 N DA,DIE,DR,SBEG,SCSR,SDDIV,SDINST,SDPAR,SDWLDA,SDWLDFN,SDWLSCL
"RTN","SDM2A",5,0)
 Q:$G(SC)'>0
"RTN","SDM2A",6,0)
 I '$D(^SC(SC)) Q
"RTN","SDM2A",7,0)
 S SDINST=""
"RTN","SDM2A",8,0)
 ;S SDINST=$$GET1^DIQ(44,SC_",",3,"I")  ; get Inst BEFORE
"RTN","SDM2A",9,0)
 S SDDIV=$$GET1^DIQ(44,SC_",",3.5,"I") S:SDDIV'="" SDINST=$$GET1^DIQ(40.8,SDDIV_",",.07,"I")
"RTN","SDM2A",10,0)
 I SDINST="" D  Q  ; sd/446
"RTN","SDM2A",11,0)
 .N DIR
"RTN","SDM2A",12,0)
 .D MESS2^SDWL120(SC)
"RTN","SDM2A",13,0)
 .W !,"No Institution/Division is associated with this Clinic."
"RTN","SDM2A",14,0)
 .W !,"Unable to create a Wait List Entry. Abandoning request."
"RTN","SDM2A",15,0)
 .W !!,"A message is being sent to the administrators mail group"
"RTN","SDM2A",16,0)
 .W !,"alerting them to the situation."
"RTN","SDM2A",17,0)
 .S DIR(0)="E" D ^DIR
"RTN","SDM2A",18,0)
 .Q
"RTN","SDM2A",19,0)
 S SDPAR=0
"RTN","SDM2A",20,0)
 ;create 409.32 entry
"RTN","SDM2A",21,0)
 I $D(^SDWL(409.32,"B",SC)) S SDWLSCL=$O(^SDWL(409.32,"B",SC,""))
"RTN","SDM2A",22,0)
 E  D
"RTN","SDM2A",23,0)
 .N DA,DIC,X,DIE,DR
"RTN","SDM2A",24,0)
 .S DIC(0)="LX",X=SC,DIC="^SDWL(409.32," D FILE^DICN
"RTN","SDM2A",25,0)
 .S SDWLSCL=DA
"RTN","SDM2A",26,0)
 .S DIE="^SDWL(409.32,"
"RTN","SDM2A",27,0)
 .S DR=".02////^S X=SDINST" D ^DIE
"RTN","SDM2A",28,0)
 .S DR="1////^S X=DT"
"RTN","SDM2A",29,0)
 .S DR=DR_";2////^S X=DUZ"
"RTN","SDM2A",30,0)
 .D ^DIE S SDPAR=1 ; flag indicating clinic parameter entry
"RTN","SDM2A",31,0)
 .; CREATE 409.3 with 120 flag
"RTN","SDM2A",32,0)
 S DIC(0)="LX",(X,SDWLDFN)=DFN,DIC="^SDWL(409.3," D FILE^DICN
"RTN","SDM2A",33,0)
 ; File just created so lock should never fail.
"RTN","SDM2A",34,0)
 F  L +^SDWL(409.3,DA):5 Q:$T  W !,"Unable to acquire a lock on the Wait List file" Q
"RTN","SDM2A",35,0)
 ; Update EWL variables.
"RTN","SDM2A",36,0)
 S SDWLDA=DA D EN^SDWLE11 ; get enrollee both SDWLDA and SDWLDFN have to be defined
"RTN","SDM2A",37,0)
 S DIE="^SDWL(409.3,"
"RTN","SDM2A",38,0)
 S DR="1////^S X=DT"
"RTN","SDM2A",39,0)
 S DR=DR_";2////^S X=SDINST"
"RTN","SDM2A",40,0)
 S DR=DR_";4////^S X=4"
"RTN","SDM2A",41,0)
 S DR=DR_";8////^S X=SDWLSCL"
"RTN","SDM2A",42,0)
 S DR=DR_";9////^S X=DUZ"
"RTN","SDM2A",43,0)
 S DR=DR_";10////^S X=""A"""
"RTN","SDM2A",44,0)
 S DR=DR_";11////^S X=2" ; by patient for this entry to avoid asking for provider
"RTN","SDM2A",45,0)
 S DR=DR_";14////^S X="""_$S($P($G(^DPT(SDWLDFN,.3)),U,1)="Y":$P(^DPT(SDWLDFN,.3),U,2),1:"")_""""
"RTN","SDM2A",46,0)
 S DR=DR_";15////^S X="_$S($P($G(^DPT(SDWLDFN,.3)),U,1)="Y":1,1:0)
"RTN","SDM2A",47,0)
 S DR=DR_";22////^S X=SDDATE"
"RTN","SDM2A",48,0)
 S DR=DR_";23////^S X=""O"""
"RTN","SDM2A",49,0)
 S DR=DR_";25////^S X="" > 120 days"""
"RTN","SDM2A",50,0)
 S DR=DR_";36////^S X=1"
"RTN","SDM2A",51,0)
 D ^DIE
"RTN","SDM2A",52,0)
 L -^SDWL(409.3,DA)
"RTN","SDM2A",53,0)
 S SDWLFLG=0 D MESS^SDWL120(SDWLDFN,SDWLDA,SDPAR)
"RTN","SDM2A",54,0)
 Q
"RTN","SDM2A",55,0)
 ;
"RTN","SDM2A",56,0)
WLCL120(SC,DESDT) ; Is there clinic availability within 120 days of desired date ; sd/446
"RTN","SDM2A",57,0)
 N SBEG,SD120
"RTN","SDM2A",58,0)
 Q:$$GET1^DIQ(44,SC,2502,"I")="Y" 1  ; Non-count clinic. Allow > 120 days.
"RTN","SDM2A",59,0)
 S SD120=0,SBEG=DESDT-1
"RTN","SDM2A",60,0)
 F  S SBEG=$O(^SC(SC,"ST",SBEG)) Q:SBEG=""  I $$HASAVSL(^SC(SC,"ST",SBEG,1)) D  Q
"RTN","SDM2A",61,0)
 .N X,DESDTH
"RTN","SDM2A",62,0)
 .S X=SBEG D H^%DTC S SBEG=%H
"RTN","SDM2A",63,0)
 .S X=DESDT D H^%DTC S DESDTH=%H
"RTN","SDM2A",64,0)
 .S SD120=(SBEG-DESDTH>120)
"RTN","SDM2A",65,0)
 .Q
"RTN","SDM2A",66,0)
 Q 'SD120
"RTN","SDM2A",67,0)
 ;
"RTN","SDM2A",68,0)
WLCL120A(SDWLAPDT,SDDATE1,SC) ;
"RTN","SDM2A",69,0)
 N %DT,DIR,X,X1,X2,Y
"RTN","SDM2A",70,0)
 Q:$$GET1^DIQ(44,SC,2502,"I")="Y" 1  ; Non-count clinic. Allow > 120 days.
"RTN","SDM2A",71,0)
 S X=SDWLAPDT,%DT="TXF" D ^%DT
"RTN","SDM2A",72,0)
 Q:Y=-1 1
"RTN","SDM2A",73,0)
 S X1=Y,X2=SDDATE1 D ^%DTC
"RTN","SDM2A",74,0)
 I X'>120 Q 1
"RTN","SDM2A",75,0)
 S DIR(0)="Y",DIR("B")="YES"
"RTN","SDM2A",76,0)
 S DIR("A")="Add to EWL",DIR("A",1)="The date is more than 120 days beyond the Desired Date"
"RTN","SDM2A",77,0)
 W ! D ^DIR
"RTN","SDM2A",78,0)
 I Y=1 D WL(SC)
"RTN","SDM2A",79,0)
 Q 0
"RTN","SDM2A",80,0)
 ;
"RTN","SDM2A",81,0)
WLCLASK() ; No appointment availability warning. ; sd/446
"RTN","SDM2A",82,0)
 N DIR
"RTN","SDM2A",83,0)
 S DIR(0)="Y"
"RTN","SDM2A",84,0)
 S DIR("A",1)="No appointments are available within 120 days of the Desired Date."
"RTN","SDM2A",85,0)
 S DIR("A",2)="Do you want to place this patient on the Electronic Wait List"
"RTN","SDM2A",86,0)
 S DIR("A",3)="or change the desired date?"
"RTN","SDM2A",87,0)
 S DIR("A",4)=""
"RTN","SDM2A",88,0)
 S DIR("A",5)="Enter ""Y"" to place on EWL, ""N"" to go back"
"RTN","SDM2A",89,0)
 S DIR("A")="or ""^"" to return to the CLINIC: prompt. "
"RTN","SDM2A",90,0)
 W ! D ^DIR
"RTN","SDM2A",91,0)
 Q Y
"RTN","SDM2A",92,0)
 ;
"RTN","SDM2A",93,0)
HASAVSL(SCSR) ; Has available slots ; sd/446
"RTN","SDM2A",94,0)
 ; Look at CLINIC PATTERN CURRENT AVAILABILITY string (44.005/1)
"RTN","SDM2A",95,0)
 ; If there is 1-9,j-z within the [ ... ], there is availability for that day.
"RTN","SDM2A",96,0)
 N DIC,F,SDOK,X,Y
"RTN","SDM2A",97,0)
 ; Allow whatever if user has a key to overbook.
"RTN","SDM2A",98,0)
 S DIC="^VA(200,"_DUZ_",51,",X="SDOB" D ^DIC Q:Y'=-1 1
"RTN","SDM2A",99,0)
 S X="SDMOB" D ^DIC Q:Y'=-1 1
"RTN","SDM2A",100,0)
 Q:SCSR'["[" 0  ; No slots.
"RTN","SDM2A",101,0)
 S SCSR=$TR($E(SCSR,$F(SCSR,"[")-1,$L(SCSR))," |"),(SDOK,F)=0
"RTN","SDM2A",102,0)
 F  S F=$F(SCSR,"[",F) Q:'F  D  Q:SDOK
"RTN","SDM2A",103,0)
 .N I,SCSR0,SL
"RTN","SDM2A",104,0)
 .S SCSR0=$E(SCSR,F,$F(SCSR,"]",F)-2)
"RTN","SDM2A",105,0)
 .F I=1:1:$L(SCSR0) S SL=$E(SCSR0,I) I $A(SL)>105&($A(SL)<123)!SL S SDOK=1 Q  ; If SL=1-9,j-z slots are available
"RTN","SDM2A",106,0)
 .Q
"RTN","SDM2A",107,0)
 Q SDOK
"RTN","SDRPA07")
0^2^B60226840^B59962530
"RTN","SDRPA07",1,0)
SDRPA07 ;BP-OIFO/ESW - APPOINTMENT BATCH TRANSMISSION BUILDER; ; 9/14/04 9:20am  ; Compiled April 24, 2006 17:00:51  ; Compiled June 20, 2008 08:32:32
"RTN","SDRPA07",2,0)
 ;;5.3;Scheduling;**290,333,349,376,446,528**;AUG 13 1993;Build 4
"RTN","SDRPA07",3,0)
 ;
"RTN","SDRPA07",4,0)
 ;
"RTN","SDRPA07",5,0)
SNDS19(ZTSK,SDBCID,SDMCID) ;Main entry point for the sending of SIU-S19 batch messages to
"RTN","SDRPA07",6,0)
 ; the National Patient Care Database
"RTN","SDRPA07",7,0)
 ;
"RTN","SDRPA07",8,0)
 ;Input  : ZTSK
"RTN","SDRPA07",9,0)
 ;Output : SDBCID - Batch Control ID
"RTN","SDRPA07",10,0)
 ;         SDMCID - Message Control ID
"RTN","SDRPA07",11,0)
 ;
"RTN","SDRPA07",12,0)
 ;
"RTN","SDRPA07",13,0)
 ;Declare variables
"RTN","SDRPA07",14,0)
 N X,X1,X2,%H
"RTN","SDRPA07",15,0)
 N BATCHC,MSGN,CURLINE
"RTN","SDRPA07",16,0)
 N LINEN,MSHLINE,XMITERR,HL7XMIT,ERROR,ORIGENT,ORIGMNT
"RTN","SDRPA07",17,0)
 N HLEID,HL,HLECH,HLFS,HLQ,HLMID,HLMTIEN,HLDT,HLDT1,MSGID,HLRESLT,HLP
"RTN","SDRPA07",18,0)
 ;Set message count limit for batch message
"RTN","SDRPA07",19,0)
 ;Initialize global locations
"RTN","SDRPA07",20,0)
 S XMITERR="^TMP(""SD-PAIT-BLD"","_$J_",""ERRORS"")"
"RTN","SDRPA07",21,0)
 S HL7XMIT="^TMP(""HLS"","_$J_")"
"RTN","SDRPA07",22,0)
 K @XMITERR,@HL7XMIT
"RTN","SDRPA07",23,0)
 ;Initiate
"RTN","SDRPA07",24,0)
 D INIT^HLFNC2("SD-PAIT-EVENT",.HL)
"RTN","SDRPA07",25,0)
 ;Unable to initiate HL7 variable - send error bulletin - done
"RTN","SDRPA07",26,0)
 ;I ($O(HL(""))="") D ERRBUL($P(HL,U,2)) Q  ; create ERRBUL later
"RTN","SDRPA07",27,0)
 ;Create batch message
"RTN","SDRPA07",28,0)
 D CREATE^HLTF(.HLMID,.HLMTIEN,.HLDT,.HLDT1)
"RTN","SDRPA07",29,0)
 ;HLMID - value of batch ID
"RTN","SDRPA07",30,0)
 ;HLMTIEN - IEN of Message Text file entry
"RTN","SDRPA07",31,0)
 ;HLDT - current date/time in FM internal format
"RTN","SDRPA07",32,0)
 ;HLDT1 - current date/time in HL7 format
"RTN","SDRPA07",33,0)
 N SDA,SDDT S SDA=HLMID,SDDT=HLDT ; to be used to file later
"RTN","SDRPA07",34,0)
 ;Unable to create batch message - send error bulletin - done
"RTN","SDRPA07",35,0)
 ;I ('HLMTIEN) D ERRBUL("Unable to create batch HL7 message") Q
"RTN","SDRPA07",36,0)
 ;Initialize message count
"RTN","SDRPA07",37,0)
 S BATCHC=0
"RTN","SDRPA07",38,0)
 ;Initialize message number
"RTN","SDRPA07",39,0)
 S MSGN=0
"RTN","SDRPA07",40,0)
 ;Initialize line count
"RTN","SDRPA07",41,0)
 S LINEN=1
"RTN","SDRPA07",42,0)
 S CURLINE=LINEN
"RTN","SDRPA07",43,0)
 ;Loop through list of appointments requiring transmission
"RTN","SDRPA07",44,0)
 N RUNID S RUNID=$O(^SDWL(409.6,"AD",ZTSK,""))
"RTN","SDRPA07",45,0)
 N DFN,SD25,SD6,SD8,SD7,SDPATCL S DFN="" F  S DFN=$O(^TMP("SDDPT",$J,DFN)) Q:DFN=""  D
"RTN","SDRPA07",46,0)
 .N SDP,ICN,SSN,SNM,FNM,MNM,DOB,SDSC,SDSCP,SDENRO,SDAPPT S SDP=^TMP("SDDPT",$J,DFN)
"RTN","SDRPA07",47,0)
 .S ICN=$P(SDP,U),SSN=$P(SDP,U,2),SNM=$P(SDP,U,3),FNM=$P(SDP,U,4)
"RTN","SDRPA07",48,0)
 .S MNM=$P(SDP,U,5),DOB=$P(SDP,U,6),SDSC=$P(SDP,U,7),SDSCP=$P(SDP,U,8),SDENRO=$P(SDP,U,9)
"RTN","SDRPA07",49,0)
 .N SDADT S SDADT="" F  S SDADT=$O(^TMP("SDDPT",$J,DFN,SDADT)) Q:SDADT=""  D
"RTN","SDRPA07",50,0)
 ..N SDPT,SDCDATE,SDADID,SDSDDT,SDSTAT,SDNAVA,SDCHKOUT,SDCDT,SDARF,SDARDT,SDNEW,SDCL,SDCLNUM,SDSTOP,SDCSTOP,SDFAC,SDDAM,SDCLNM,SDSTOPD,SDCSTOPD
"RTN","SDRPA07",51,0)
 ..N SDSTOPDD,SD8RD
"RTN","SDRPA07",52,0)
 ..S SDPT=^TMP("SDDPT",$J,DFN,SDADT),SDADID=$P(SDPT,U),SDDAM=$P(SDPT,U,2),SDSDDT=$P(SDPT,U,3),SDNAVA=$P(SDPT,U,5)
"RTN","SDRPA07",53,0)
 ..S SDCHKOUT=$P(SDPT,U,6),SDCDT=$P(SDPT,U,7),SDARDT=$P(SDPT,U,9),SDNEW=$P(SDPT,U,10),SDCL=$P(SDPT,U,12),SDCLNM=$P(SDPT,U,13)
"RTN","SDRPA07",54,0)
 ..S SDSTOP=$P(SDPT,U,14),SDCSTOP=$P(SDPT,U,15),SDFAC=$P(SDPT,U,16),SDPATCL=$P(SDPT,U,4)
"RTN","SDRPA07",55,0)
 ..S SDAPPT=^TMP("SDDPT",$J,DFN,SDADT,"SCH"),SD25=$P(SDAPPT,"^",2),SD6=$P(SDAPPT,"^",3),SD8=$P(SDAPPT,"^",4),SD8RD=$P(SDAPPT,"^",7)
"RTN","SDRPA07",56,0)
 ..S SDSTOPDD=^TMP("SDDPT",$J,DFN,SDADT,"STDC"),SDSTOPD=$P(SDSTOPDD,"^"),SDCSTOPD=$P(SDSTOPDD,"^",2)
"RTN","SDRPA07",57,0)
 ..;calculate consult date if applicable; 446
"RTN","SDRPA07",58,0)
 ..N SEQ S SEQ=0,SDCDATE="" F  S SEQ=$O(^SC(SDCL,"S",SDADT,1,SEQ)) Q:+SEQ'=SEQ  I $P($G(^SC(SDCL,"S",SDADT,1,SEQ,0)),"^")=DFN D  Q  ;SD/528 added $G
"RTN","SDRPA07",59,0)
 ...S SDCSLT=$$GET1^DIQ(44.003,SEQ_","_SDADT_","_SDCL_",",688,"I")  ; consult
"RTN","SDRPA07",60,0)
 ...Q:SDCSLT=""
"RTN","SDRPA07",61,0)
 ...I $D(^GMR(123,SDCSLT)) S SDCDATE=$$DTCONV^SDRPA08($$GET1^DIQ(123,SDCSLT_",",3,"I")) ;date converted to HL7
"RTN","SDRPA07",62,0)
 ..;Calculate message control ID
"RTN","SDRPA07",63,0)
 ..S MSGN=MSGN+1
"RTN","SDRPA07",64,0)
 ..S MSGID=HLMID_"-"_MSGN
"RTN","SDRPA07",65,0)
 ..;Build MSG segment
"RTN","SDRPA07",66,0)
 ..I (MSGID'="") D
"RTN","SDRPA07",67,0)
 ...;remember orig message and event type
"RTN","SDRPA07",68,0)
 ...S ORIGMNT="SIU"
"RTN","SDRPA07",69,0)
 ...S ORIGENT="S12"
"RTN","SDRPA07",70,0)
 ...S HL("MNT")="SIU",HL("ETN")=$P(SDAPPT,"^")
"RTN","SDRPA07",71,0)
 ...;build MSH segment
"RTN","SDRPA07",72,0)
 ...K RESULT D MSH^HLFNC2(.HL,MSGID,.RESULT)
"RTN","SDRPA07",73,0)
 ...;reset message & event type to its orig values
"RTN","SDRPA07",74,0)
 ...S HL("MNT")=ORIGMNT
"RTN","SDRPA07",75,0)
 ...S HL("ETN")=ORIGENT
"RTN","SDRPA07",76,0)
 ...;copy MSH segment into HL7 message
"RTN","SDRPA07",77,0)
 ...S @HL7XMIT@(CURLINE)=RESULT
"RTN","SDRPA07",78,0)
 ...N SDFACL S SDFACL=$P($$SITE^VASITE(),"^",3)
"RTN","SDRPA07",79,0)
 ...S $P(@HL7XMIT@(CURLINE),U,4)=SDFACL ;sending facility station #
"RTN","SDRPA07",80,0)
 ...S $P(@HL7XMIT@(CURLINE),U,5)="SD-AAC-PAIT" ;Receiving Application
"RTN","SDRPA07",81,0)
 ...S $P(@HL7XMIT@(CURLINE),U,6)=200 ; Receiving Facility
"RTN","SDRPA07",82,0)
 ...I ($D(RESULT(1))) D
"RTN","SDRPA07",83,0)
 ....S @HL7XMIT@(CURLINE,1)=RESULT(1)
"RTN","SDRPA07",84,0)
 ....S CURLINE=CURLINE+1
"RTN","SDRPA07",85,0)
 ...E  S CURLINE=CURLINE+1
"RTN","SDRPA07",86,0)
 ..;get list of segments
"RTN","SDRPA07",87,0)
 ..N SDSCH S SDSCH="SCH"_HLFS_1_"^^^^^"
"RTN","SDRPA07",88,0)
 ..S SD7=SDNAVA
"RTN","SDRPA07",89,0)
 ..;S ^TMP("HLS",$J,CURLINE)
"RTN","SDRPA07",90,0)
 ..S @HL7XMIT@(CURLINE)=SDSCH_SD6_"^"_SD7_"^"_SD8_"^^^"
"RTN","SDRPA07",91,0)
 ..N SDDAT S SDDAT="~~~"_SDDAM_"~~~"_"Date Appt Created|~~~"_SDSDDT_"~~~"_"Desired Date|~~~"_SDADID_"~~~"_"Appt Date"
"RTN","SDRPA07",92,0)
 ..S SDDAT=SDDAT_"|~~~"_SDCHKOUT_"~~~"_"Checkout Date"
"RTN","SDRPA07",93,0)
 ..S SDDAT=SDDAT_"|~~~"_SDCDT_"~~~"_"Cancellation Date"
"RTN","SDRPA07",94,0)
 ..S SDDAT=SDDAT_"|~~~"_SDARDT_"~~~"_"Auto-rebook Date"
"RTN","SDRPA07",95,0)
 ..S SDDAT=SDDAT_"|~~~"_SD8RD_"~~~"_"Resched Date"
"RTN","SDRPA07",96,0)
 ..S SDDAT=SDDAT_"|~~~"_SDCDATE_"~~~"_"Consult Date"
"RTN","SDRPA07",97,0)
 ..;S $P(SDSCH,U,12)=SDDAT,$P(SDSCH,U,26)=SDSTAT
"RTN","SDRPA07",98,0)
 ..S @HL7XMIT@(CURLINE,1)=SDDAT_"^^^^^^^^^^^^^^"_SD25
"RTN","SDRPA07",99,0)
 ..S CURLINE=CURLINE+1
"RTN","SDRPA07",100,0)
 ..S @HL7XMIT@(CURLINE)=$$EN^VAFHLPID(DFN,"1,3,5,7,11,19",1,1)
"RTN","SDRPA07",101,0)
 ..N SDCDFN S SDCDFN=$P(@HL7XMIT@(CURLINE),"^",4),SDCDFN=SDCDFN_"|"_DFN_"~~~USVHA&&L~PI" I $P(SDCDFN,"~")["V" S $P(SDCDFN,"~",2)=""
"RTN","SDRPA07",102,0)
 ..S $P(@HL7XMIT@(CURLINE),"^",4)=SDCDFN
"RTN","SDRPA07",103,0)
 ..N SDZIP S SDZIP=$P(@HL7XMIT@(CURLINE),U,12),SDZIP=$P(SDZIP,"~",5) S $P(@HL7XMIT@(CURLINE),U,12)="~~~~"_SDZIP
"RTN","SDRPA07",104,0)
 ..S CURLINE=CURLINE+1
"RTN","SDRPA07",105,0)
 ..;get Admission Type
"RTN","SDRPA07",106,0)
 ..N SDCR1,SDAT,SDCR S SDCR1=$E(SDDAM,5,8)_$E(SDDAM,1,4) D DT^DILF(,SDCR1,.SDCR) S SDAT=$$POV^SDRPA20(DFN,SDADT,SDCL,SDCR)
"RTN","SDRPA07",107,0)
 ..S @HL7XMIT@(CURLINE)="PV1^1^"_SDPATCL_"^^"_SDAT_"^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"_SDFAC
"RTN","SDRPA07",108,0)
 ..S CURLINE=CURLINE+1
"RTN","SDRPA07",109,0)
 ..S SDNEW=$S(SDNEW=1:"NSF",SDNEW=2:"OPN",SDNEW=3:"SHB")
"RTN","SDRPA07",110,0)
 ..S @HL7XMIT@(CURLINE)="PV2^^^^^^^^^^^^^^^^^^^^^^^^"_SDNEW
"RTN","SDRPA07",111,0)
 ..S CURLINE=CURLINE+1
"RTN","SDRPA07",112,0)
 ..I $D(^TMP("SDDPT",$J,DFN,SDADT,"ROL")) D
"RTN","SDRPA07",113,0)
 ...N SDCNT,SDAIP S SDAIP="AIP^" S SDCNT="" F  S SDCNT=$O(^TMP("SDDPT",$J,DFN,SDADT,"ROL",SDCNT)) Q:SDCNT=""  D
"RTN","SDRPA07",114,0)
 ....N SDPOVID,SDPROVNM,SDROLS
"RTN","SDRPA07",115,0)
 ....S SDROLS=^TMP("SDDPT",$J,DFN,SDADT,"ROL",SDCNT)
"RTN","SDRPA07",116,0)
 ....S SDPOVID=$P(SDROLS,U,3),SDPROVNM=$P(SDROLS,U,4),SDPROVNM=$TR(SDPROVNM,",","~")
"RTN","SDRPA07",117,0)
 ....S SDPROVNM=$TR(SDPROVNM," ","~")
"RTN","SDRPA07",118,0)
 ....I $L(SDPROVNM,"~")=2 S SDPROVNM=SDPROVNM_"~~"
"RTN","SDRPA07",119,0)
 ....E  I $L(SDPROVNM,"~")=3 S SDPROVNM=SDPROVNM_"~"
"RTN","SDRPA07",120,0)
 ....S @HL7XMIT@(CURLINE)=SDAIP_SDCNT_"^^"_SDPOVID_"~"_SDPROVNM_"^"_"Provider"
"RTN","SDRPA07",121,0)
 ....S CURLINE=CURLINE+1
"RTN","SDRPA07",122,0)
 ..S @HL7XMIT@(CURLINE)="AIL^1^^"_SDCL_"~~~~~~~~"_SDCLNM_"^"_SDSTOP_"~"_SDSTOPD_"~DSS Clinic ID^"_SDCSTOP_"~"_SDCSTOPD_"~DSS Credit Stop"
"RTN","SDRPA07",123,0)
 ..S CURLINE=CURLINE+1
"RTN","SDRPA07",124,0)
 ..N SDCNT S SDCNT="" F  S SDCNT=$O(^TMP("SDDPT",$J,DFN,SDADT,"ZCL",SDCNT)) Q:SDCNT=""  D
"RTN","SDRPA07",125,0)
 ...S @HL7XMIT@(CURLINE)=^TMP("SDDPT",$J,DFN,SDADT,"ZCL",SDCNT,0)
"RTN","SDRPA07",126,0)
 ...S CURLINE=CURLINE+1
"RTN","SDRPA07",127,0)
 ..;create ZEN only if enrollment was retrieved
"RTN","SDRPA07",128,0)
 ..I SDENRO>0 S @HL7XMIT@(CURLINE)="ZEN^1^^^^^^^^"_SDENRO,CURLINE=CURLINE+1
"RTN","SDRPA07",129,0)
 ..S @HL7XMIT@(CURLINE)="ZSP^1^"_SDSC_"^"_SDSCP
"RTN","SDRPA07",130,0)
 ..S CURLINE=CURLINE+1
"RTN","SDRPA07",131,0)
 ..;ZEL
"RTN","SDRPA07",132,0)
 ..N SDZEL D EN1^VAFHLZEL(DFN,"1,37,38",1,.SDZEL) D
"RTN","SDRPA07",133,0)
 ...;need to modify 37 WITH THE CREATION DATE
"RTN","SDRPA07",134,0)
 ...N SDDAMV S SDDAMV=$$HL7TFM^XLFDT(SDDAM)
"RTN","SDRPA07",135,0)
 ...N SDVC S SDVC=$$CVEDT^DGCV(DFN,SDDAMV),SDVC=$P(SDVC,"^",3) D
"RTN","SDRPA07",136,0)
 ....S $P(SDZEL(1),"^",38)=$S(SDVC=1:1,SDVC=0:0,1:"U")
"RTN","SDRPA07",137,0)
 ....I $P(SDZEL(1),"^",39)'?8N S $P(SDZEL(1),"^",39)=""
"RTN","SDRPA07",138,0)
 ...S @HL7XMIT@(CURLINE)=SDZEL(1)
"RTN","SDRPA07",139,0)
 ..S CURLINE=CURLINE+1
"RTN","SDRPA07",140,0)
 ..;ZMH
"RTN","SDRPA07",141,0)
 ..N SAR D ENTER^VAFHLZMH(DFN,"SAR","1,5,10","3,4",HL("FS"),HL("ECH"),"")
"RTN","SDRPA07",142,0)
 ..S $P(SAR(1,0),"^",4)="" ;
"RTN","SDRPA07",143,0)
 ..;service separation date
"RTN","SDRPA07",144,0)
 ..;combat indication and location;gulf war indication
"RTN","SDRPA07",145,0)
 ..S $P(SAR(1,0),"^",5)="~"_$P($P(SAR(1,0),"^",5),"~",2)
"RTN","SDRPA07",146,0)
 ..N SS F SS=2,3 D
"RTN","SDRPA07",147,0)
 ...S $P(SAR(SS,0),"^",5)=""
"RTN","SDRPA07",148,0)
 ..I $E($P(SAR(2,0),"^",4))'="Y" S $P(SAR(2,0),"^",4)="N~"
"RTN","SDRPA07",149,0)
 ..I $E($P(SAR(3,0),"^",4))'="Y" S $P(SAR(3,0),"^",4)="N"
"RTN","SDRPA07",150,0)
 ..N SDD F SDD=1,2,3 S @HL7XMIT@(CURLINE)=SAR(SDD,0) S CURLINE=CURLINE+1
"RTN","SDRPA07",151,0)
 ..;file MSGID into 409.69 separately as batch # and ID #
"RTN","SDRPA07",152,0)
 ..N DIE,DA D
"RTN","SDRPA07",153,0)
 ...S DIE="^SDWL(409.6,"_RUNID_",1,",DA(1)=RUNID
"RTN","SDRPA07",154,0)
 ...S DA=$O(^SDWL(409.6,"AC",DFN,SDADT,RUNID,"")) D
"RTN","SDRPA07",155,0)
 ....I $P(^SDWL(409.6,RUNID,1,DA,0),"^",3)'="" S DA=$O(^SDWL(409.6,"AC",DFN,SDADT,RUNID,DA))
"RTN","SDRPA07",156,0)
 ...S DR="2///"_+MSGID_";3///"_$P(MSGID,"-",2) D ^DIE
"RTN","SDRPA07",157,0)
 D GENERATE^HLMA("SD-PAIT-EVENT","GB",1,.HLRESLT,HLMTIEN,.HLP) K @HL7XMIT
"RTN","SDRPA07",158,0)
 N DA,DIE,DR S DA=RUNID,DIE=409.6,DR="1.1///"_+$G(MSGID) D ^DIE
"RTN","SDRPA07",159,0)
 S SDMCID=+$G(SDMCID)
"RTN","SDRPA07",160,0)
 ;file message control ID # and batch control ID number
"RTN","SDRPA07",161,0)
 N DIC,DA,X,Y D
"RTN","SDRPA07",162,0)
 .S DIC="^SDWL(409.6,"_RUNID_",2,",DA(1)=RUNID,DIC("P")=409.7,DIC(0)="X"
"RTN","SDRPA07",163,0)
 .S SDBCID=+$G(HLRESLT)
"RTN","SDRPA07",164,0)
 .K DO S X=+$G(SDBCID) D FILE^DICN
"RTN","SDRPA07",165,0)
 .S DA=+Y,DIE=DIC,DR=".02///"_+$G(SDDT)_";.03///"_+$G(SDA) D ^DIE
"RTN","SDRPA07",166,0)
 Q
"RTN","SDRPA08")
0^5^B40122267^B43490788
"RTN","SDRPA08",1,0)
SDRPA08 ;BP-OIFO/OWAIN,ESW - Patient Appointment Data Compilation  ; 9/10/04 9:41am  ; Compiled April 24, 2006 16:55:01  ; Compiled July 1, 2008 16:48:16
"RTN","SDRPA08",2,0)
 ;;5.3;Scheduling;**290,333,349,376,528**;AUG 13, 1993;Build 4
"RTN","SDRPA08",3,0)
 ;This program generates appointment data into ^TMP("SDDPT",$J to be used by HL7 builder
"RTN","SDRPA08",4,0)
 Q
"RTN","SDRPA08",5,0)
 ;
"RTN","SDRPA08",6,0)
APPT(DFN,SDADT,SDDM,SDCL,SDSTAT) ;
"RTN","SDRPA08",7,0)
 ;SDDM - HL7 format of creation date
"RTN","SDRPA08",8,0)
 ;SDSTAT - string from SDRPA05
"RTN","SDRPA08",9,0)
 N ARRAY,SDCLNM,SDSTOP,SDSTOP1,SDCSTOP,SDCSTOP1,SDINST,SDFAC,SDSDDT,SDCDT,SDARF,SDARDT,SDENRO,SDNAVA,SD6A,SD8A,SD8RD
"RTN","SDRPA08",10,0)
 N SDNEW,SDSCHED,SDCHKOUT,SDPRVSEQ,SDCNT,SDSCE,SDSTOPD,SDCSTOPD
"RTN","SDRPA08",11,0)
 D GETS^DIQ(44,SDCL_",",".01;3;8;99;2503","I","ARRAY")  ; GETS called to try to improve efficiency.
"RTN","SDRPA08",12,0)
 S SDCLNM=$G(ARRAY(44,SDCL_",",.01,"I"))  ; Clinic name.
"RTN","SDRPA08",13,0)
 S SDSTOP1=$G(ARRAY(44,SDCL_",",8,"I"))  ; DSS identifier of clinic.
"RTN","SDRPA08",14,0)
 S SDSTOP=$$GET1^DIQ(40.7,SDSTOP1_",",1,"I")
"RTN","SDRPA08",15,0)
 S SDSTOPD=$$GET1^DIQ(40.7,SDSTOP1_",",.01,"I") ;description
"RTN","SDRPA08",16,0)
 S SDCSTOP1=$G(ARRAY(44,SDCL_",",2503,"I"))  ; DSS credit stop of clinic.
"RTN","SDRPA08",17,0)
 S SDCSTOP="",SDCSTOPD=""
"RTN","SDRPA08",18,0)
 I SDCSTOP1>0 S SDCSTOP=$$GET1^DIQ(40.7,SDCSTOP1_",",1,"I"),SDCSTOPD=$$GET1^DIQ(40.7,SDCSTOP1_",",.01,"I")
"RTN","SDRPA08",19,0)
 ;retrieve institution and station number through the division path
"RTN","SDRPA08",20,0)
 S SDDIV=$$GET1^DIQ(44,SDCL_",",3.5,"I")
"RTN","SDRPA08",21,0)
 S SDFAC=""
"RTN","SDRPA08",22,0)
 I SDDIV'="" S SDINST=$$GET1^DIQ(40.8,SDDIV_",",.07,"I") D
"RTN","SDRPA08",23,0)
 .S SDFAC=$S(SDINST="":"",1:$$GET1^DIQ(4,SDINST_",",99,"I"))  ; Station
"RTN","SDRPA08",24,0)
 I SDFAC="" D
"RTN","SDRPA08",25,0)
 .I SDDIV'="" S SDFAC1=$P($$SITE^VASITE(,SDDIV),"^",3) Q
"RTN","SDRPA08",26,0)
 .S SDFAC=$P($$SITE^VASITE(,),"^",3)
"RTN","SDRPA08",27,0)
 ;
"RTN","SDRPA08",28,0)
 S SDCHKOUT=""
"RTN","SDRPA08",29,0)
 I $P(SDSTAT,"^",5)'="" S SDCHKOUT=$$DTCONV($P(SDSTAT,"^",5))
"RTN","SDRPA08",30,0)
 S SD8RD=""
"RTN","SDRPA08",31,0)
 I $P(SDSTAT,"^",7)'="" S SD8RD=$$DTCONV($P(SDSTAT,"^",7))
"RTN","SDRPA08",32,0)
 S SDSDDT=$$DTCONV($$GET1^DIQ(2.98,SDADT_","_DFN_",",27,"I"))  ; desired date 
"RTN","SDRPA08",33,0)
 S SDCDT=$$GET1^DIQ(2.98,SDADT_","_DFN_",",15,"I")  ; Cancellation date.
"RTN","SDRPA08",34,0)
 S SDARF=$S($$GET1^DIQ(2.98,SDADT_","_DFN_",",25,"I")="A":"A",1:"")  ; Auto-rebook flag.
"RTN","SDRPA08",35,0)
 S SDARDT=$$DTCONV($$GET1^DIQ(2.98,SDADT_","_DFN_",",12,"I"))  ; Auto-rebook date.
"RTN","SDRPA08",36,0)
 S SDNAVA=$$GET1^DIQ(2.98,SDADT_","_DFN_",",26,"I")  ; Next available appointment indicator.
"RTN","SDRPA08",37,0)
 I SDNAVA=0 D
"RTN","SDRPA08",38,0)
 .I SDARF="A" S SDNAVA=4
"RTN","SDRPA08",39,0)
 .E  S SDNAVA=5
"RTN","SDRPA08",40,0)
 I SDNAVA="" S SDNAVA=6
"RTN","SDRPA08",41,0)
 S SDNEW=$$NEWAT(DFN,SDADT,SDSTOP1,SDCSTOP1,SDFAC)  ; New to facility/clinic flag.
"RTN","SDRPA08",42,0)
 ;
"RTN","SDRPA08",43,0)
 S SD6A=$P(SDSTAT,"^",3) S SD8A=$P(SDSTAT,"^",4)
"RTN","SDRPA08",44,0)
 S ^TMP("SDDPT",$J,DFN,SDADT)=$$DTCONV(SDADT)_"^"_SDDM_"^"_SDSDDT_"^^"_SDNAVA_"^"_SDCHKOUT_"^"_$$DTCONV(SDCDT)_"^^"_SDARDT
"RTN","SDRPA08",45,0)
 S ^TMP("SDDPT",$J,DFN,SDADT)=^TMP("SDDPT",$J,DFN,SDADT)_"^"_SDNEW_"^^"_SDCL_"^"_SDCLNM_"^"_SDSTOP_"^"_SDCSTOP_"^"_SDFAC
"RTN","SDRPA08",46,0)
 S ^TMP("SDDPT",$J,DFN,SDADT,"SCH")=$P(SDSTAT,U,1,6)_U_SD8RD ;446 added consult request date in SDRPA07
"RTN","SDRPA08",47,0)
 S ^TMP("SDDPT",$J,DFN,SDADT,"STDC")=SDSTOPD_"^"_SDCSTOPD
"RTN","SDRPA08",48,0)
 ; Outpatient classification.
"RTN","SDRPA08",49,0)
 S SDSCE=$$GET1^DIQ(2.98,SDADT_","_DFN_",",21,"I")
"RTN","SDRPA08",50,0)
 I SDSCE'="" D EN^VAFHLZCL(DFN,SDSCE,"1,2,3","","^","^TMP(""SDDPT"",$J,DFN,SDADT,""ZCL"")")
"RTN","SDRPA08",51,0)
 ;get patient class
"RTN","SDRPA08",52,0)
 D GETAPPT^SDAMA201(DFN,"12",,SDADT,SDADT) N SDPATCL D  K ^TMP($J,"SDAMA201")
"RTN","SDRPA08",53,0)
 .S SDPATCL=$G(^TMP($J,"SDAMA201","GETAPPT",1,12))
"RTN","SDRPA08",54,0)
 .I SDPATCL="" D
"RTN","SDRPA08",55,0)
 ..I SDSCE'="" N SDVST S SDVST=$$GET1^DIQ(409.68,SDSCE_",",.05,"I") D
"RTN","SDRPA08",56,0)
 ...I SDVST S SDPATCL=$$GET1^DIQ(9000010,SDVST_",",15002,"I")
"RTN","SDRPA08",57,0)
 ...S SDPATCL=$S(SDPATCL=1:"I",SDPATCL=0:"O",1:"U")
"RTN","SDRPA08",58,0)
 ..I SDSCE="" S SDPATCL="U"
"RTN","SDRPA08",59,0)
 .S $P(^TMP("SDDPT",$J,DFN,SDADT),"^",4)=SDPATCL
"RTN","SDRPA08",60,0)
 ; Get providers for clinic.
"RTN","SDRPA08",61,0)
 N SDPROV S (SDPRVSEQ,SDCNT)=0,SDPROV=""
"RTN","SDRPA08",62,0)
 N PROVID
"RTN","SDRPA08",63,0)
 F  S SDPRVSEQ=$O(^SC(SDCL,"PR",SDPRVSEQ)) Q:+SDPRVSEQ'=SDPRVSEQ!(SDCNT>10)  D
"RTN","SDRPA08",64,0)
 .S SDCNT=SDCNT+1,PROVID=$$GET1^DIQ(44.1,SDPRVSEQ_","_SDCL_",",.01,"I")
"RTN","SDRPA08",65,0)
 .S ^TMP("SDDPT",$J,DFN,SDADT,"ROL",SDCNT)="ROL^"_SDCNT_"^"_PROVID_"^"_$$GET1^DIQ(200,PROVID_",",.01,"I")
"RTN","SDRPA08",66,0)
 .Q
"RTN","SDRPA08",67,0)
 Q
"RTN","SDRPA08",68,0)
NEWAT(DFN,SDADT,SDSTOP1,SDCSTOP1,SDFAC) ; New to facility/clinic flag.
"RTN","SDRPA08",69,0)
 N OK,SDADT0,SDFAC1,SDDIV
"RTN","SDRPA08",70,0)
 S OK=0,SDADT0=SDADT
"RTN","SDRPA08",71,0)
 F  S SDADT=$O(^DPT(DFN,"S",SDADT),-1) Q:'SDADT  Q:$$GT24(SDADT,SDADT0)  D  Q:OK
"RTN","SDRPA08",72,0)
 .N SDCL,SDDIV,ARRAY
"RTN","SDRPA08",73,0)
 .S SDCL=$$GET1^DIQ(2.98,SDADT_","_DFN_",",.01,"I")
"RTN","SDRPA08",74,0)
 .Q:$$GET1^DIQ(44,SDCL_",",8,"I")'=SDSTOP1
"RTN","SDRPA08",75,0)
 .Q:$$GET1^DIQ(44,SDCL_",",2503,"I")'=SDCSTOP1
"RTN","SDRPA08",76,0)
 .S SDDIV=$$GET1^DIQ(44,SDCL_",",3.5,"I")
"RTN","SDRPA08",77,0)
 .S SDFAC1=""
"RTN","SDRPA08",78,0)
 .I SDDIV'="" S SDINST=$$GET1^DIQ(40.8,SDDIV_",",.07,"I") D
"RTN","SDRPA08",79,0)
 ..S SDFAC1=$S(SDINST="":"",1:$$GET1^DIQ(4,SDINST_",",99,"I"))  ; Station
"RTN","SDRPA08",80,0)
 .I SDFAC1="" D
"RTN","SDRPA08",81,0)
 ..I SDDIV'="" S SDFAC1=$P($$SITE^VASITE(,SDDIV),"^",3) Q
"RTN","SDRPA08",82,0)
 ..S SDFAC1=$P($$SITE^VASITE(,),"^",3)
"RTN","SDRPA08",83,0)
 .I SDFAC1=SDFAC S OK=3
"RTN","SDRPA08",84,0)
 .Q
"RTN","SDRPA08",85,0)
 I OK Q OK
"RTN","SDRPA08",86,0)
 S SDADT=SDADT0
"RTN","SDRPA08",87,0)
 F  S SDADT=$O(^DPT(DFN,"S",SDADT),-1) Q:'SDADT  Q:$$GT24(SDADT,SDADT0)  D  Q:OK
"RTN","SDRPA08",88,0)
 .N SDCL,SDDIV,ARRAY
"RTN","SDRPA08",89,0)
 .S SDCL=$$GET1^DIQ(2.98,SDADT_","_DFN_",",.01,"I")
"RTN","SDRPA08",90,0)
 .Q:$$GET1^DIQ(44,SDCL_",",8,"I")'=SDSTOP1
"RTN","SDRPA08",91,0)
 .S SDDIV=$$GET1^DIQ(44,SDCL_",",3.5,"I")
"RTN","SDRPA08",92,0)
 .S SDFAC1=""
"RTN","SDRPA08",93,0)
 .I SDDIV'="" S SDINST=$$GET1^DIQ(40.8,SDDIV_",",.07,"I") D
"RTN","SDRPA08",94,0)
 ..S SDFAC1=$S(SDINST="":"",1:$$GET1^DIQ(4,SDINST_",",99,"I"))  ; Station
"RTN","SDRPA08",95,0)
 .I SDFAC1="" D
"RTN","SDRPA08",96,0)
 ..I SDDIV'="" S SDFAC1=$P($$SITE^VASITE(,SDDIV),"^",3) Q
"RTN","SDRPA08",97,0)
 ..S SDFAC1=$P($$SITE^VASITE(,),"^",3)
"RTN","SDRPA08",98,0)
 .I $E(SDFAC1,1,3)=$E(SDFAC,1,3) S OK=2
"RTN","SDRPA08",99,0)
 .Q
"RTN","SDRPA08",100,0)
 I OK Q OK
"RTN","SDRPA08",101,0)
 S OK=1 Q OK
"RTN","SDRPA08",102,0)
 ;
"RTN","SDRPA08",103,0)
GT24(DATE1,DATE2) ; Are two dates greater than 24 months apart?
"RTN","SDRPA08",104,0)
 ; DATE1 should be before DATE2.
"RTN","SDRPA08",105,0)
 ; If they are not in that order, they are swapped anyway.
"RTN","SDRPA08",106,0)
 N MONTHS,TEMP
"RTN","SDRPA08",107,0)
 I DATE1>DATE2 S TEMP=DATE1,DATE1=DATE2,DATE2=TEMP
"RTN","SDRPA08",108,0)
 S MONTHS=$E(DATE2,2,3)-$E(DATE1,2,3)*12+$E(DATE2,4,5)-$E(DATE1,4,5)
"RTN","SDRPA08",109,0)
 Q MONTHS>24
"RTN","SDRPA08",110,0)
DPT(DFN,SDCE) ;
"RTN","SDRPA08",111,0)
 ; Extrinsic. Returns boolean, 0: ^TMP("SDDPT",$J,DFN) not created; 1: created.
"RTN","SDRPA08",112,0)
 ;
"RTN","SDRPA08",113,0)
 N SDNAMEL,SDNAMEF,SDNAMEM,SDNAMES,SDNAME,NAME,DOB,SSN,SSNP,SDSC,ICN,SDADT,SDSCP,ARRAY,SDDCE
"RTN","SDRPA08",114,0)
 S SDDCE=$$GET1^DIQ(2,DFN_",",27.01,"I")  ; Current enrollment. Required elsewhere.
"RTN","SDRPA08",115,0)
 S:SDDCE="" SDCE="" I SDDCE>0 S SDCE=$$GET1^DIQ(27.11,SDDCE_",",.07,"I") ; Enrollment priority
"RTN","SDRPA08",116,0)
 Q:$D(^TMP("SDDPT",$J,DFN)) 1
"RTN","SDRPA08",117,0)
 D GETS^DIQ(2,DFN_",",".301;.302;991.01","I","ARRAY")  ; GETS called to try to improve efficiency.
"RTN","SDRPA08",118,0)
 S SDSC=$G(ARRAY(2,DFN_",",.301,"I"))  ; Service connected.
"RTN","SDRPA08",119,0)
 S SDSCP=$G(ARRAY(2,DFN_",",.302,"I"))  ; Service connected percentage.
"RTN","SDRPA08",120,0)
 S ICN=$$GETICN^MPIF001(DFN)  ; Integration Control Number.
"RTN","SDRPA08",121,0)
 I +ICN<0 S ICN="" ; 
"RTN","SDRPA08",122,0)
 D DEM^VADPT ;VADM array as output of this call
"RTN","SDRPA08",123,0)
 S (SDNAMEL,SDNAMEF,SDNAMEM,SDNAMES,SDNAME,NAME(1))=""
"RTN","SDRPA08",124,0)
 S NAME=$$GETNAME(DFN)
"RTN","SDRPA08",125,0)
 S DOB=$$DTCONV($P($G(VADM(3)),"^"))  ; Date of birth.
"RTN","SDRPA08",126,0)
 S (SSN,SSNP)="" S SSN=$P($G(VADM(2)),"^") I SSN["P" S SSNP="P",SSN=$E(SSN,1,9)  ; Social security number.
"RTN","SDRPA08",127,0)
 Q:$E(SSN,1,5)="00000" 0  ; Exclude test patients.
"RTN","SDRPA08",128,0)
 ;
"RTN","SDRPA08",129,0)
 S ^TMP("SDDPT",$J,DFN)=ICN_"^"_SSN_SSNP_"^"_NAME_"^"_DOB_"^"_$E(SDSC)_"^"_SDSCP_"^"_SDCE
"RTN","SDRPA08",130,0)
 Q 1
"RTN","SDRPA08",131,0)
DTCONV(DT) ; Date conversion.
"RTN","SDRPA08",132,0)
 ; CYYMMDD -> CCYYMMDD
"RTN","SDRPA08",133,0)
 ; CYYMMDD.H{HMMSS} -> CCYYMMDDHHMM
"RTN","SDRPA08",134,0)
 I DT?7N Q DT+17E6
"RTN","SDRPA08",135,0)
 Q:DT?7N1"."1.6N DT\1+17E6_$E(DT#1+1*1E4,2,5)
"RTN","SDRPA08",136,0)
 Q ""
"RTN","SDRPA08",137,0)
GETNAME(NMID) ; Name in HL7 format.
"RTN","SDRPA08",138,0)
 N SDNAME,NAME,SDNAMEL,SDNAMF,SDNAMEM,SDNAMES,SDNAMEF
"RTN","SDRPA08",139,0)
 S SDNAME("FILE")=2,SDNAME("IENS")=NMID,SDNAME("FIELD")=.01
"RTN","SDRPA08",140,0)
 S NAME(1)=$$HLNAME^XLFNAME(.SDNAME,"","^")
"RTN","SDRPA08",141,0)
 S SDNAMEL=$P($G(NAME(1)),"^"),SDNAMEF=$P($G(NAME(1)),"^",2),SDNAMEM=$P($G(NAME(1)),"^",3),SDNAMES=$P($G(NAME(1)),"^",4)
"RTN","SDRPA08",142,0)
 Q SDNAMEL_"^"_SDNAMEF_"^"_SDNAMEM_" "_SDNAMES
"RTN","SDRPA08",143,0)
 Q
"RTN","SDWLQSC1")
0^4^B19655747^B18866005
"RTN","SDWLQSC1",1,0)
SDWLQSC1 ;IOFO BAY PINES/ESW - WAITING LIST-SC PRIORITY BACKGROUND ;09/02/2004 2:10 PM [4/21/05 8:04pm]  ; Compiled December 20, 2006 09:00:39  ; Compiled May 15, 2008 16:54:54  ; Compiled June 23, 2008 10:26:21
"RTN","SDWLQSC1",2,0)
 ;;5.3;scheduling;**446,528**;AUG 13, 1993;Build 4
"RTN","SDWLQSC1",3,0)
 ;
"RTN","SDWLQSC1",4,0)
 ;Modification included to be provided with patch SD*5.3*528, see: Q:SS'[$J          
"RTN","SDWLQSC1",5,0)
 ;This routine will be called by SDWLQSC that run as a background job. It is created because SDWLQSC exceeded 10000.                               
"RTN","SDWLQSC1",6,0)
 Q
"RTN","SDWLQSC1",7,0)
EN2 ;Part 2 - checks status of appts linked to closed EWL entries.
"RTN","SDWLQSC1",8,0)
 N IEN,APPT,WLAPPT,CLINIC,SDAPPT,WLSTAT,STATUS,NN,SDFORM,EE
"RTN","SDWLQSC1",9,0)
 S (IEN,APPT,WLAPPT,CLINIC,SDAPPT,WLSTAT,STATUS,NN,SDFORM,EE)=""
"RTN","SDWLQSC1",10,0)
 S EE=0,DFN=0
"RTN","SDWLQSC1",11,0)
 F  S DFN=$O(^SDWL(409.3,"B",DFN)) Q:DFN<1  D
"RTN","SDWLQSC1",12,0)
 .K ^TMP("ENC",$J)
"RTN","SDWLQSC1",13,0)
 .S IEN="" F  S IEN=$O(^SDWL(409.3,"B",DFN,IEN)) Q:IEN<1  D
"RTN","SDWLQSC1",14,0)
 ..S STATUS="" S STATUS=$$GET1^DIQ(409.3,IEN_",",23,"I")
"RTN","SDWLQSC1",15,0)
 ..IF STATUS="C" D
"RTN","SDWLQSC1",16,0)
 ...IF $G(^SDWL(409.3,IEN,"SDAPT")) D
"RTN","SDWLQSC1",17,0)
 ....S CLINIC=$$GET1^DIQ(409.3,IEN_",",13.2,"I") IF CLINIC>0 D
"RTN","SDWLQSC1",18,0)
 .....S WLAPPT=$$GET1^DIQ(409.3,IEN_",",13,"I"),WLSTAT=$$GET1^DIQ(409.3,IEN_",",21,"I")
"RTN","SDWLQSC1",19,0)
 .....IF WLSTAT="SA" D APPT^SDWLQSC(CLINIC,IEN) ; call creates ^TMP("SDWLQSC3",$J)
"RTN","SDWLQSC1",20,0)
 ..I STATUS="O" N SDPCL,SDPSP S SDPCL=$$GET1^DIQ(409.3,IEN_",",8,"I"),SDPSP=$$GET1^DIQ(409.3,IEN_",",7,"I") I SDPCL>0!(SDPSP>0) D
"RTN","SDWLQSC1",21,0)
 ...S (SDCL,SDSP)=""
"RTN","SDWLQSC1",22,0)
 ...I SDPCL>0 S SDCL=$$GET1^DIQ(409.32,SDPCL_",",.01,"I")
"RTN","SDWLQSC1",23,0)
 ...I SDPSP>0 S SDSP=$$GET1^DIQ(409.31,SDPSP_",",.01,"I")
"RTN","SDWLQSC1",24,0)
 ...S SDORG=$$GET1^DIQ(409.3,IEN_",",1,"I")
"RTN","SDWLQSC1",25,0)
 ...N SDD S SDD=$$CHKENC(DFN,SDORG,SDCL,SDSP,0)  ; 0 - the first appt/enc only 
"RTN","SDWLQSC1",26,0)
 .IF $D(^TMP("ENC",$J)) D MESS9^SDWLMSG(DFN) K ^TMP("ENC",$J)
"RTN","SDWLQSC1",27,0)
 IF $D(^TMP("SDWLQSC3",$J)) D MESS2^SDWLMSG
"RTN","SDWLQSC1",28,0)
 Q
"RTN","SDWLQSC1",29,0)
CHKENC(DFN,SDORG,SDCL,SDSP,PROC) ;check if any encounters are present
"RTN","SDWLQSC1",30,0)
 ;SDORG - orig DATE of EWL entry
"RTN","SDWLQSC1",31,0)
 ;SDCL - pointer to file 44
"RTN","SDWLQSC1",32,0)
 ;SDSP - pointer to fiel # 40.7
"RTN","SDWLQSC1",33,0)
 ;PROC - 0 -create the first appt/enc only
"RTN","SDWLQSC1",34,0)
 ;       1 - multiple appt/enc ; called from outside for a list of appointment(s)/encounter(s)
"RTN","SDWLQSC1",35,0)
 N CNT S CNT=0,EE=0
"RTN","SDWLQSC1",36,0)
 N SDEND,X,X1,X2 S X1=SDORG,X2=119 D C^%DTC S SDEND=X
"RTN","SDWLQSC1",37,0)
 K ^TMP("SD ENCOUNTER LIST",$J) K ^TMP($J,"SDAMA301") K ^TMP($J,"APPT") K ^TMP("ENC",$J)
"RTN","SDWLQSC1",38,0)
 N SDARR S SDARR(1)=SDORG_";"_SDEND
"RTN","SDWLQSC1",39,0)
 S SDARR(3)="R" ;only kept/scheduled 
"RTN","SDWLQSC1",40,0)
 S SDARR(4)=DFN
"RTN","SDWLQSC1",41,0)
 I SDCL S SDARR(2)=SDCL
"RTN","SDWLQSC1",42,0)
 I SDSP S SDARR(13)=$$GET1^DIQ(40.7,SDSP_",",1) ; STOP CODE
"RTN","SDWLQSC1",43,0)
 S SDARR("FLDS")="1;2;3;4;10;13;14;17"
"RTN","SDWLQSC1",44,0)
 S SDAPPT=$$SDAPI^SDAMA301(.SDARR)
"RTN","SDWLQSC1",45,0)
 I SDAPPT D
"RTN","SDWLQSC1",46,0)
 .I 'PROC N SS,SDP S SS="^TMP("_$J_",""SDAMA301"")" S SDP=@$Q(@SS) D  ; string containg app data
"RTN","SDWLQSC1",47,0)
 ..; see example: SDP=3060615.09^359;11CP SURG^^7171882;WOLF,ED^^^^^^^^
"RTN","SDWLQSC1",48,0)
 ..N CL,SDC S CL=+$P(SDP,U,2) S SDC=$$GET1^DIQ(44,CL_",",.01),SDC=$E(SDC,1,17)
"RTN","SDWLQSC1",49,0)
 ..N SDNAM S SDNAM=$$GET1^DIQ(2,DFN_",",.01),SDNAM=$E(SDNAM,1,19)
"RTN","SDWLQSC1",50,0)
 ..N Y,SDAPPT S Y=+SDP D DD^%DT S SDAPPT=Y
"RTN","SDWLQSC1",51,0)
 ..N Y S Y=SDORG D DD^%DT S SDORGD=Y S SDORGD=$S(SDCL>0:"C-",1:"S-")_SDORGD
"RTN","SDWLQSC1",52,0)
 ..S SDFORM=$$FORM^SDFORM(SDNAM,22,SDC,20,SDORGD,20,SDAPPT,21)
"RTN","SDWLQSC1",53,0)
 ..S EE="" S EE=+$O(^TMP("ENC",$J,EE),-1)+1 S ^TMP("ENC",$J,EE)=SDFORM
"RTN","SDWLQSC1",54,0)
 .I PROC N SS,SCNT S SS="^TMP("_$J_",""SDAMA301"")" F  S SS=$Q(@SS) Q:SS'["SDAMA301"  Q:SS'[$J  D  ; SD/528
"RTN","SDWLQSC1",55,0)
 ..N CL,SDP,SD S SDP=@SS S SD=+SDP,CL=+$P(SDP,U,2)
"RTN","SDWLQSC1",56,0)
 ..S SCNT=$O(^TMP($J,"APPT",""),-1)+1
"RTN","SDWLQSC1",57,0)
 ..S ^TMP($J,"APPT",SCNT)=^TMP($J,"SDAMA301",DFN,CL,SD)
"RTN","SDWLQSC1",58,0)
 ..N SDCLIN,SDFAC,SDINST,SDINSTE S SDCLIN=$$CLIN^SDWLBACC(CL),SDINST=$P(SDCLIN,U),SDFAC=$P(SDCLIN,U,2),SDINSTE=$P(SDCLIN,U,3)
"RTN","SDWLQSC1",59,0)
 ..S $P(^TMP($J,"APPT",SCNT),"^",15)=SDINST_";"_SDINSTE
"RTN","SDWLQSC1",60,0)
 ..S $P(^TMP($J,"APPT",SCNT),"^",16)=SDFAC
"RTN","SDWLQSC1",61,0)
 ..N SDD3 S SDD3=$S(SD<DT:"KEPT",1:"SCHEDULED") S $P(^TMP($J,"APPT",SCNT),U,3)=";"_SDD3
"RTN","SDWLQSC1",62,0)
 I 'PROC I EE Q EE
"RTN","SDWLQSC1",63,0)
 N ARR,SQ K ^TMP("SD ENCOUNTER LIST",$J) D LISTPAT^SDOERPC(.ARR,DFN,SDORG,SDEND)
"RTN","SDWLQSC1",64,0)
 I $D(@ARR) S CNT=0,SQ="" F  S SQ=$O(^TMP("SD ENCOUNTER LIST",$J,SQ)) Q:SQ=""  D   I 'PROC,EE=1 Q
"RTN","SDWLQSC1",65,0)
 .N STR I SDCL Q:$P(^TMP("SD ENCOUNTER LIST",$J,SQ),U,4)'=SDCL  S STR=$P(^TMP("SD ENCOUNTER LIST",$J,SQ),";;",2)
"RTN","SDWLQSC1",66,0)
 .I SDSP Q:$P(^TMP("SD ENCOUNTER LIST",$J,SQ),U,3)'=SDSP  S STR=$P(^TMP("SD ENCOUNTER LIST",$J,SQ),";;",2)
"RTN","SDWLQSC1",67,0)
 .S CL=$P(STR,U,4)
"RTN","SDWLQSC1",68,0)
 .S SDC=$$GET1^DIQ(44,CL_",",.01),SDC=$E(SDC,1,17)
"RTN","SDWLQSC1",69,0)
 .S SDNAM=$$GET1^DIQ(2,DFN_",",.01),SDNAM=$E(SDNAM,1,19)
"RTN","SDWLQSC1",70,0)
 .N Y S Y=$P(STR,U) D DD^%DT S SDAPPT=Y,SDAPPT=SDAPPT_"-E"
"RTN","SDWLQSC1",71,0)
 .N Y S Y=SDORG D DD^%DT S SDORGD=Y S SDORGD=$S(SDCL>0:"C-",1:"S-")_SDORGD ; C - clinic EWL entry ; S - specialty EWL entry
"RTN","SDWLQSC1",72,0)
 .I 'PROC S SDFORM=$$FORM^SDFORM(SDNAM,22,SDC,20,SDORGD,20,SDAPPT,21) D  Q
"RTN","SDWLQSC1",73,0)
 ..S EE="" S EE=+$O(^TMP("ENC",$J,EE),-1)+1 S ^TMP("ENC",$J,EE)=SDFORM
"RTN","SDWLQSC1",74,0)
 .I PROC S SCNT=$O(^TMP($J,"APPT",""),-1)+1 D
"RTN","SDWLQSC1",75,0)
 ..I +$P(STR,U,7) S ^TMP($J,"APPT",SCNT)=$P(STR,U)_U_CL_";"_SDC_"^^"_DFN_";"_SDNAM D
"RTN","SDWLQSC1",76,0)
 ...S $P(^TMP($J,"APPT",SCNT),U,18)=$P(STR,U,7)
"RTN","SDWLQSC1",77,0)
 ...S $P(^TMP($J,"APPT",SCNT),U,3)=";CHECKED OUT"
"RTN","SDWLQSC1",78,0)
 I PROC I $D(^TMP($J,"APPT")) S EE=1
"RTN","SDWLQSC1",79,0)
 Q EE
"VER")
8.0^22.0
"BLD",7633,6)
^443
**END**
**END**

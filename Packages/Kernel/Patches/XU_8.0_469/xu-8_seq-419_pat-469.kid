KIDS Distribution saved on Nov 03, 2010@08:34:01
XU 469
**KIDS**:XU*8.0*469^

**INSTALL NAME**
XU*8.0*469
"BLD",7476,0)
XU*8.0*469^KERNEL^0^3101103^y
"BLD",7476,1,0)
^^2^2^3070919^
"BLD",7476,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"BLD",7476,1,2,0)
XU*8*469   Maintain Institution in Auto Sign-on.
"BLD",7476,4,0)
^9.64PA^3.081^1
"BLD",7476,4,3.081,0)
3.081
"BLD",7476,4,3.081,2,0)
^9.641^3.081^1
"BLD",7476,4,3.081,2,3.081,0)
SIGN-ON LOG  (File-top level)
"BLD",7476,4,3.081,2,3.081,1,0)
^9.6411^17^1
"BLD",7476,4,3.081,2,3.081,1,17,0)
DIVISION
"BLD",7476,4,3.081,222)
y^y^p^^^^n^^n
"BLD",7476,4,3.081,224)

"BLD",7476,4,"APDD",3.081,3.081)

"BLD",7476,4,"APDD",3.081,3.081,17)

"BLD",7476,4,"B",3.081,3.081)

"BLD",7476,6)
^419
"BLD",7476,6.3)
8
"BLD",7476,"INID")
^n
"BLD",7476,"INIT")
POST^XU8P469
"BLD",7476,"KRN",0)
^9.67PA^779.2^20
"BLD",7476,"KRN",.4,0)
.4
"BLD",7476,"KRN",.401,0)
.401
"BLD",7476,"KRN",.402,0)
.402
"BLD",7476,"KRN",.403,0)
.403
"BLD",7476,"KRN",.5,0)
.5
"BLD",7476,"KRN",.84,0)
.84
"BLD",7476,"KRN",3.6,0)
3.6
"BLD",7476,"KRN",3.8,0)
3.8
"BLD",7476,"KRN",9.2,0)
9.2
"BLD",7476,"KRN",9.8,0)
9.8
"BLD",7476,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",7476,"KRN",9.8,"NM",1,0)
XUS1B^^0^B3544888
"BLD",7476,"KRN",9.8,"NM",2,0)
XUS1^^0^B26024789
"BLD",7476,"KRN",9.8,"NM",3,0)
XUSRB2^^0^B3605542
"BLD",7476,"KRN",9.8,"NM",4,0)
XUP^^0^B11551061
"BLD",7476,"KRN",9.8,"NM","B","XUP",4)

"BLD",7476,"KRN",9.8,"NM","B","XUS1",2)

"BLD",7476,"KRN",9.8,"NM","B","XUS1B",1)

"BLD",7476,"KRN",9.8,"NM","B","XUSRB2",3)

"BLD",7476,"KRN",19,0)
19
"BLD",7476,"KRN",19.1,0)
19.1
"BLD",7476,"KRN",101,0)
101
"BLD",7476,"KRN",409.61,0)
409.61
"BLD",7476,"KRN",771,0)
771
"BLD",7476,"KRN",779.2,0)
779.2
"BLD",7476,"KRN",870,0)
870
"BLD",7476,"KRN",8989.51,0)
8989.51
"BLD",7476,"KRN",8989.52,0)
8989.52
"BLD",7476,"KRN",8994,0)
8994
"BLD",7476,"KRN","B",.4,.4)

"BLD",7476,"KRN","B",.401,.401)

"BLD",7476,"KRN","B",.402,.402)

"BLD",7476,"KRN","B",.403,.403)

"BLD",7476,"KRN","B",.5,.5)

"BLD",7476,"KRN","B",.84,.84)

"BLD",7476,"KRN","B",3.6,3.6)

"BLD",7476,"KRN","B",3.8,3.8)

"BLD",7476,"KRN","B",9.2,9.2)

"BLD",7476,"KRN","B",9.8,9.8)

"BLD",7476,"KRN","B",19,19)

"BLD",7476,"KRN","B",19.1,19.1)

"BLD",7476,"KRN","B",101,101)

"BLD",7476,"KRN","B",409.61,409.61)

"BLD",7476,"KRN","B",771,771)

"BLD",7476,"KRN","B",779.2,779.2)

"BLD",7476,"KRN","B",870,870)

"BLD",7476,"KRN","B",8989.51,8989.51)

"BLD",7476,"KRN","B",8989.52,8989.52)

"BLD",7476,"KRN","B",8994,8994)

"BLD",7476,"QDEF")
^^^^YES
"BLD",7476,"QUES",0)
^9.62^^
"BLD",7476,"REQB",0)
^9.611^3^3
"BLD",7476,"REQB",1,0)
XU*8.0*395^2
"BLD",7476,"REQB",2,0)
XU*8.0*419^2
"BLD",7476,"REQB",3,0)
XU*8.0*432^2
"BLD",7476,"REQB","B","XU*8.0*395",1)

"BLD",7476,"REQB","B","XU*8.0*419",2)

"BLD",7476,"REQB","B","XU*8.0*432",3)

"FIA",3.081)
SIGN-ON LOG
"FIA",3.081,0)
^XUSEC(0,
"FIA",3.081,0,0)
3.081P
"FIA",3.081,0,1)
y^y^p^^^^n^^n
"FIA",3.081,0,10)

"FIA",3.081,0,11)

"FIA",3.081,0,"RLRO")

"FIA",3.081,0,"VR")
8.0^XU
"FIA",3.081,3.081)
1
"FIA",3.081,3.081,17)

"INIT")
POST^XU8P469
"MBREQ")
0
"PKG",163,-1)
1^1
"PKG",163,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",163,22,0)
^9.49I^1^1
"PKG",163,22,1,0)
8.0^2950703^2951019^1039
"PKG",163,22,1,"PAH",1,0)
469^3101103
"PKG",163,22,1,"PAH",1,1,0)
^^2^2^3101103
"PKG",163,22,1,"PAH",1,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"PKG",163,22,1,"PAH",1,1,2,0)
XU*8*469   Maintain Institution in Auto Sign-on.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","XU8P469")
0^^B5416949
"RTN","XU8P469",1,0)
XU8P469 ;ISF/RWF - Patch XU*8*469 post-init ;1/30/08  09:08
"RTN","XU8P469",2,0)
 ;;8.0;KERNEL;**469**;Jul 10, 1995;Build 8
"RTN","XU8P469",3,0)
POST ;Post-init to clean-up files
"RTN","XU8P469",4,0)
 D MES^XPDUTL("Begin POST-INIT.")
"RTN","XU8P469",5,0)
 D F19,EN1,EN2,SLOG
"RTN","XU8P469",6,0)
 D MES^XPDUTL("Finished POST-INIT.")
"RTN","XU8P469",7,0)
 Q
"RTN","XU8P469",8,0)
 ;
"RTN","XU8P469",9,0)
EN1 ;Change $N in file 200, field 9 to $O
"RTN","XU8P469",10,0)
 D
"RTN","XU8P469",11,0)
 . N ITRANS,PIECE
"RTN","XU8P469",12,0)
 . S PIECE="$N(^VA(200,""SSN"",X,0))"
"RTN","XU8P469",13,0)
 . S ITRANS=$P(^DD(200,9,0),U,5,99)
"RTN","XU8P469",14,0)
 . I ITRANS'[PIECE Q  ;Already altered Input Transform
"RTN","XU8P469",15,0)
 . S ITRANS=$P(ITRANS,PIECE)_"$O(^VA(200,""SSN"",X,0))"_$P(ITRANS,PIECE,2)
"RTN","XU8P469",16,0)
 . S $P(^DD(200,9,0),U,5,99)=ITRANS
"RTN","XU8P469",17,0)
 . Q
"RTN","XU8P469",18,0)
 Q
"RTN","XU8P469",19,0)
 ;
"RTN","XU8P469",20,0)
EN2 ;Now queue the removal of QAR fields and data.
"RTN","XU8P469",21,0)
 ;D MES^XPDUTL("Begin clean up of the NEW PERSON(#200) file...")
"RTN","XU8P469",22,0)
 N ZTRTN,ZTDTH,ZTDESC,ZTSK,ZTIO
"RTN","XU8P469",23,0)
 S ZTRTN="F200^XU8P469",ZTDTH=$H,ZTDESC="QAR data removal",ZTIO=""
"RTN","XU8P469",24,0)
 D ^%ZTLOAD
"RTN","XU8P469",25,0)
 D MES^XPDUTL("Queued the removal of QAR fields and data as task #"_ZTSK)
"RTN","XU8P469",26,0)
 Q
"RTN","XU8P469",27,0)
 ;
"RTN","XU8P469",28,0)
SLOG ;Clean up any long last signon nodes.
"RTN","XU8P469",29,0)
 N DA S DA=0
"RTN","XU8P469",30,0)
 F  S DA=$O(^VA(200,DA)) Q:'DA  I $L($G(^VA(200,DA,1.1)),U)>5 D
"RTN","XU8P469",31,0)
 . S ^VA(200,DA,1.1)=$P(^VA(200,DA,1.1),U,1,5)
"RTN","XU8P469",32,0)
 . Q
"RTN","XU8P469",33,0)
 Q
"RTN","XU8P469",34,0)
 ;
"RTN","XU8P469",35,0)
 ;From Cameron 2/9/2005
"RTN","XU8P469",36,0)
 ;Kernel should delete the whole range of fields from 747.1 through 747.9, all fields and all multiples between.
"RTN","XU8P469",37,0)
F200 ;Only remove if the pointed to files have been removed.
"RTN","XU8P469",38,0)
 I $D(^DIC(747.25,0))!$D(DIC(747.5,0))!$D(^DIC(747.7,0)) Q
"RTN","XU8P469",39,0)
 N FLD,DIU,DA,DIK
"RTN","XU8P469",40,0)
 ;First remove the multipuls
"RTN","XU8P469",41,0)
 S FLD=747
"RTN","XU8P469",42,0)
 ;F FLD=.111,.13,.2,.27,.28,.31,.32,.34,.36,.43,.45,.5,.6,.7,.8 D
"RTN","XU8P469",43,0)
 F  S FLD=$O(^DD(200,FLD)) Q:FLD'["747."  D
"RTN","XU8P469",44,0)
 . S DIU(0)="S"
"RTN","XU8P469",45,0)
 . I $D(^DD(200,FLD,0)),$P(^(0),U,2)>1 S DIU=+$P(^(0),U,2) D EN^DIU2
"RTN","XU8P469",46,0)
 . Q
"RTN","XU8P469",47,0)
 ;Now remove the other fields.
"RTN","XU8P469",48,0)
 S FLD=747
"RTN","XU8P469",49,0)
 F  S FLD=$O(^DD(200,FLD)) Q:FLD'["747."  S DIK="^DD(200,",DA=FLD,DA(1)=200 D ^DIK
"RTN","XU8P469",50,0)
 ;
"RTN","XU8P469",51,0)
QAR ;Delete all QAR data from the NPF
"RTN","XU8P469",52,0)
 N DA,ND
"RTN","XU8P469",53,0)
 S DA=.5
"RTN","XU8P469",54,0)
 F  S DA=$O(^VA(200,DA)) Q:DA'>0  D
"RTN","XU8P469",55,0)
 . S ND="QAQz"
"RTN","XU8P469",56,0)
 . F  S ND=$O(^VA(200,DA,ND)) Q:$E(ND,1,3)'="QAR"  D
"RTN","XU8P469",57,0)
 . . K ^VA(200,DA,ND)
"RTN","XU8P469",58,0)
 . . Q
"RTN","XU8P469",59,0)
 . Q
"RTN","XU8P469",60,0)
 Q
"RTN","XU8P469",61,0)
 ;
"RTN","XU8P469",62,0)
F19 ;File 19 Field 24.
"RTN","XU8P469",63,0)
 D MES^XPDUTL("Remove Field #24 from the OPTION(#19) file...")
"RTN","XU8P469",64,0)
 I '$D(^DD(19,24,0))#2 D MES^XPDUTL("Field #24 is not defined.") G DONE
"RTN","XU8P469",65,0)
 N DIK,DA
"RTN","XU8P469",66,0)
 S DIK="^DD(19,",DA=24,DA(1)=19
"RTN","XU8P469",67,0)
 D ^DIK
"RTN","XU8P469",68,0)
DONE D MES^XPDUTL("Finished cleaning up the OPTION(#19) file.")
"RTN","XU8P469",69,0)
 Q
"RTN","XUP")
0^4^B11551061
"RTN","XUP",1,0)
XUP ;SFISC/RWF - Setup enviroment for programmers ;1/30/08  11:12
"RTN","XUP",2,0)
 ;;8.0;KERNEL;**208,258,284,432,469**;Jul 10, 1995;Build 8
"RTN","XUP",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XUP",4,0)
 W !,"Setting up programmer environment"
"RTN","XUP",5,0)
 S U="^",$ECODE="",$ETRAP="" ;Clear error and error trap
"RTN","XUP",6,0)
 X ^%ZOSF("TYPE-AHEAD")
"RTN","XUP",7,0)
 ;Check if Production and report
"RTN","XUP",8,0)
 W !,"This is a "_$S($$PROD^XUPROD(1):"PRODUCTION",1:"TEST")_" account.",!
"RTN","XUP",9,0)
 ;
"RTN","XUP",10,0)
 K ^UTILITY($J),^XUTL("XQ",$J) D KILL1^XUSCLEAN
"RTN","XUP",11,0)
 S U="^",DT=$$DT^XLFDT
"RTN","XUP",12,0)
 S XUEOFF=^%ZOSF("EOFF"),XUEON=^%ZOSF("EON"),U="^",XUTT=0,XUIOP=""
"RTN","XUP",13,0)
 D GETENV^%ZOSV S XUENV=Y,XUVOL=$P(Y,U,2),XUCI=$P(Y,U,1)
"RTN","XUP",14,0)
 ;Reset DUZ if user "Switched Identities".
"RTN","XUP",15,0)
 I $D(DUZ("SAV")) S DUZ=+DUZ("SAV"),DUZ(0)=$P(DUZ("SAV"),U,2) K DUZ("SAV")
"RTN","XUP",16,0)
 ;Get user info
"RTN","XUP",17,0)
 I $G(DUZ)>.5,$D(^VA(200,DUZ,0))[0 K DUZ W !,"DUZ Must point to a real user." G EXIT ;p432
"RTN","XUP",18,0)
 I $G(DUZ)>0 D DUZ(DUZ)
"RTN","XUP",19,0)
 I $G(DUZ)'>0!('$D(DUZ(0))) D ASKDUZ G:Y'>0 EXIT
"RTN","XUP",20,0)
 I '$D(XQUSER) S XQUSER=$S($D(^VA(200,DUZ,20)):$P(^(20),"^",2),1:"Unk")
"RTN","XUP",21,0)
 S DTIME=600 ;Set a temp DTIME
"RTN","XUP",22,0)
 S DILOCKTM=+$G(^DD("DILOCKTM"),1) ;p432
"RTN","XUP",23,0)
 ;Getting Terminal Type
"RTN","XUP",24,0)
ZIS I XUTT D ENQ^XUS1 G:$D(XUIOP(1)) ZIS2 S Y=0 D TT^XUS3 I Y>0 S XUIOP(1)=$P(XUIOP,";",2) G ZIS2
"RTN","XUP",25,0)
 S X="`"_+$G(^VA(200,DUZ,1.2)),DIC="^%ZIS(2,",DIC(0)="MQ"_$S(X]"`0":"",1:"AE") D ^DIC G:Y'>0 EXIT
"RTN","XUP",26,0)
 S XUIOP(1)=$P(Y,U,2) I DIC(0)["A",$G(^VA(200,+DUZ,0))]"" S $P(^VA(200,DUZ,1.2),U,1)=+Y
"RTN","XUP",27,0)
ZIS2 S %ZIS="L",IOP="HOME;"_XUIOP(1) D ^%ZIS G EXIT:POP W !,"Terminal Type set to: ",IOST,!
"RTN","XUP",28,0)
 S DTIME=$$DTIME(DUZ,IOS),DUZ("BUF")=1,XUDEV=IOS
"RTN","XUP",29,0)
 S %=+$G(^VA(200,DUZ,.1)) I %>0 S %=$P(^XTV(8989.3,1,"XUS"),U,15)-($H-%) I %<14,%>0 W !!,"Your VERIFY code will expire in "_%_" days",!!
"RTN","XUP",30,0)
 ;Save info, Set last sign-on
"RTN","XUP",31,0)
 D SAVE^XUS1 S $P(^VA(200,DUZ,1.1),"^",1)=$$NOW^XLFDT
"RTN","XUP",32,0)
 ;Check Mail
"RTN","XUP",33,0)
 S Y=$P($G(^XMB(3.7,DUZ,0)),U,6) I Y W !,"You have "_Y_" new message"_$S(Y=1:"",1:"s")_"."
"RTN","XUP",34,0)
 ;Setup error trap
"RTN","XUP",35,0)
 I $$GET^XPAR("USR^SYS","XUS-XUP SET ERROR TRAP",1,"Q") S $ETRAP="D ERR^XUP"
"RTN","XUP",36,0)
 D KILL1^XUSCLEAN S $P(XQXFLG,U,3)="XUP" D ^XQ1
"RTN","XUP",37,0)
EXIT ;Clean-up and exit
"RTN","XUP",38,0)
 D KILL1^XUSCLEAN K XQY,XQY0
"RTN","XUP",39,0)
 I $G(DUZ)>0,$$GET^XPAR("USR^SYS","XUS-XUP VPE",1,"Q"),$D(^%ZVEMS) X ^%ZVEMS ;Run VPE
"RTN","XUP",40,0)
 Q
"RTN","XUP",41,0)
 ;
"RTN","XUP",42,0)
ASKDUZ ;Ask for Access Code
"RTN","XUP",43,0)
 N X
"RTN","XUP",44,0)
 ;X XUEOFF S DIR(0)="FO",DIR("A")="Access Code" D ^DIR W ! X XUEON I $D(DIRUT) S Y=-1 Q
"RTN","XUP",45,0)
 X XUEOFF W !,"Access Code: " S X=$$ACCEPT^XUS() X XUEON
"RTN","XUP",46,0)
 I X["^"!('$L(X)) S Y=-1 Q
"RTN","XUP",47,0)
 S X=$$UP^XLFSTR(X) S:X[":" XUTT=1,X=$P(X,":",1)_$P(X,":",2)
"RTN","XUP",48,0)
 D ^XUSHSH S Y=$O(^VA(200,"A",X,0))
"RTN","XUP",49,0)
 K DUZ D DUZ(+Y)
"RTN","XUP",50,0)
 Q
"RTN","XUP",51,0)
 ;
"RTN","XUP",52,0)
DUZ(DA) ;Build DUZ for a user.  Used by Mailman.
"RTN","XUP",53,0)
 ;(p284) Make the setting of several DUZ parts conditional.
"RTN","XUP",54,0)
 N Y
"RTN","XUP",55,0)
 S Y(0)=$G(^VA(200,+DA,0)),Y("XUS")=$G(^XTV(8989.3,1,"XUS"))
"RTN","XUP",56,0)
 S DUZ=DA
"RTN","XUP",57,0)
 S:$G(DUZ(0))'="@" DUZ(0)=$P(Y(0),"^",4)
"RTN","XUP",58,0)
 S DUZ(1)="",DUZ("AG")=$P($G(^XTV(8989.3,1,0)),"^",8)
"RTN","XUP",59,0)
 S:'$G(DUZ(2)) DUZ(2)=$O(^VA(200,DUZ,2,0))
"RTN","XUP",60,0)
 S:'DUZ(2) DUZ(2)=+$P(Y("XUS"),"^",17)
"RTN","XUP",61,0)
 S:'$L($G(DUZ("LANG"))) DUZ("LANG")=$P(Y("XUS"),"^",7)
"RTN","XUP",62,0)
 Q
"RTN","XUP",63,0)
 ;
"RTN","XUP",64,0)
DTIME(E,D) ;Return DTIME value for user E, device D.
"RTN","XUP",65,0)
 N P
"RTN","XUP",66,0)
 S P=$P($G(^VA(200,+$G(E),200)),"^",10) S:P="" P=$P($G(^%ZIS(1,+$G(D),"XUS")),"^",10) S:P="" P=$P($G(^XTV(8989.3,1,"XUS")),"^",10)
"RTN","XUP",67,0)
 Q $S(P]"":P,1:300)
"RTN","XUP",68,0)
 ;
"RTN","XUP",69,0)
ERR ;
"RTN","XUP",70,0)
 N %XUP U $P
"RTN","XUP",71,0)
 W !,"$ECODE=",$ECODE,"   $STACK=",$STACK
"RTN","XUP",72,0)
 W !,"Location: ",$STACK($STACK-1,"PLACE")
"RTN","XUP",73,0)
 R !!,"Want to record the error: No// ",%XUP:600 I "Yy"[$E(%XUP_"N") D ^%ZTER
"RTN","XUP",74,0)
 D UNWIND^%ZTER ;S:'$ESTACK $ECODE="" S $ETRAP="" Q:$QUIT "" Q
"RTN","XUS1")
0^2^B26024789
"RTN","XUS1",1,0)
XUS1 ;SF-ISC/STAFF - SIGNON ;02/03/10  16:01
"RTN","XUS1",2,0)
 ;;8.0;KERNEL;**9,59,111,165,150,252,265,419,469,523**;Jul 10, 1995;Build 8
"RTN","XUS1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XUS1",4,0)
 ;User setup
"RTN","XUS1",5,0)
USER ;
"RTN","XUS1",6,0)
 K XUTEXT S XUM=$$USER^XUS1A(),$Y=0
"RTN","XUS1",7,0)
 ;Show post sign-on text
"RTN","XUS1",8,0)
 F I=0:0 S I=$O(XUTEXT(I)) Q:I'>0  D:$Y>20  W:$E(XUTEXT(I),1)="!" ! W $E(XUTEXT(I),2,999)
"RTN","XUS1",9,0)
 . N DIR S DIR(0)="E",DIR("A")="Enter RETURN to continue" D ^DIR W @IOF Q
"RTN","XUS1",10,0)
 ;if XUM=9 multi sign-on NOT allowed
"RTN","XUS1",11,0)
 I XUM=9 W !!,?8,$$EZBLD^DIALOG(30810.45)
"RTN","XUS1",12,0)
 Q:XUM  ;User can't sign-on.
"RTN","XUS1",13,0)
SET ;
"RTN","XUS1",14,0)
 S Y=$$CHKDIV()
"RTN","XUS1",15,0)
 I $P(Y,U,2)>0,$D(^DIC(4,0)) D ASKDIV
"RTN","XUS1",16,0)
 S DUZ(2)=+Y D DUZ^XUS1A
"RTN","XUS1",17,0)
 ;Check verify code
"RTN","XUS1",18,0)
 I $$VCHG D CVC^XUS2 G:$D(DUOUT) H^XUS
"RTN","XUS1",19,0)
 S:$P(XOPT,"^",5) XUTT=1 ;Ask Device
"RTN","XUS1",20,0)
 D ENQ ;Inquire to Terminal Type
"RTN","XUS1",21,0)
 Q
"RTN","XUS1",22,0)
 ;
"RTN","XUS1",23,0)
VCHG() ;Check if the Verify code needs to be changed
"RTN","XUS1",24,0)
 I $D(DUZ("ASH")) Q 0 ;rwf 403
"RTN","XUS1",25,0)
 D:'$D(XUSER) USER^XUS(DUZ)
"RTN","XUS1",26,0)
 Q:'$L($P(XUSER(1),U,2)) 1 ;Null VC
"RTN","XUS1",27,0)
 I $$BROKER^XWBLIB Q:$P(XUSER(0),U,8)=1 0 ;VC never expires, only for BROKER
"RTN","XUS1",28,0)
 Q (XUSER(1)+$P(XOPT,U,15))'>$H ;Time to change
"RTN","XUS1",29,0)
 ;
"RTN","XUS1",30,0)
ASKDIV ;Ask the user for the Division, return Y
"RTN","XUS1",31,0)
 N X
"RTN","XUS1",32,0)
 S DIC="^VA(200,DUZ,2,",DIC(0)="AEMQ",DIC("P")="200.02P",X=$O(^VA(200,DUZ,2,"AX1",1,0)) S:X>0 DIC("B")=$P($$NS^XUAF4(X),U)
"RTN","XUS1",33,0)
 D ^DIC I Y'>0 W !,*7,"You must select one." G ASKDIV
"RTN","XUS1",34,0)
 Q
"RTN","XUS1",35,0)
 ;
"RTN","XUS1",36,0)
CHKDIV(CD) ;ef,sr Check if user needs to select Division.
"RTN","XUS1",37,0)
 N %,%1,%2,%3,%4
"RTN","XUS1",38,0)
 I $G(DUZ("DIV"))>0 Q DUZ("DIV") ;p469 Set outside
"RTN","XUS1",39,0)
 S %=$O(^VA(200,DUZ,2,0)),%1=$O(^(%))
"RTN","XUS1",40,0)
 I %1,$D(CD) D
"RTN","XUS1",41,0)
 . S %2=0,%3=0,CD=0
"RTN","XUS1",42,0)
 . F  S %2=$O(^VA(200,DUZ,2,%2)) Q:%2'>0  S %4=^(%2,0),%3=%3+1,CD(%3)=%2_"^"_$$NS^XUAF4(%2)_$S($P(%4,"^",2):"^1",1:"")
"RTN","XUS1",43,0)
 . S CD=%3
"RTN","XUS1",44,0)
 Q %_"^"_%1
"RTN","XUS1",45,0)
 ;
"RTN","XUS1",46,0)
ENQ ;Get terminal type
"RTN","XUS1",47,0)
 S XUT1="" I XUTT X XUEOFF R X:0 X ^%ZOSF("TYPE-AHEAD") W $C(27,91,99) R *X:2 I X=27 F  R X#1:2 S XUT1=XUT1_X Q:'$T!(X="c")
"RTN","XUS1",48,0)
 ;Commented out the next line as Wyse 75 are not used
"RTN","XUS1",49,0)
 ;I XUTT,(XUT1'["[") R X:0 S XUT1="" W *5 R *X:2 R:$T XUT1:2 S X=$S(X=6:"C-WYSE 75",1:$C(X)_XUT1),XUT1=""
"RTN","XUS1",50,0)
 X XUEON I XUTT,XUT1["[" S Y=$O(^%ZIS(3.22,"B",XUT1,0)) I Y>0 S X=$P($G(^%ZIS(3.22,Y,0)),"^",2)
"RTN","XUS1",51,0)
 I X?1.ANP S DIC="^%ZIS(2,",DIC(0)="MO" D ^DIC I Y>0 S XUIOP(1)=$P(Y,U,2),$P(XUIOP,";",2)=XUIOP(1),^VA(200,DUZ,1.2)=+Y
"RTN","XUS1",52,0)
 I '$D(XUIOP(1)),$D(^VA(200,DUZ,1.2)) S X=+^(1.2) I X>0,$D(^%ZIS(2,X,0)) S $P(XUIOP,";",2)=$P(^(0),U)
"RTN","XUS1",53,0)
 Q
"RTN","XUS1",54,0)
 ;
"RTN","XUS1",55,0)
NEXT ;Jump to the next routine
"RTN","XUS1",56,0)
 S IOP=XUIOP D ^%ZIS D SAVE ;Save off device/user info
"RTN","XUS1",57,0)
 S X=$G(^DISV(DUZ)) ;Add kill by session or day here
"RTN","XUS1",58,0)
 S ^DISV(DUZ)=$H
"RTN","XUS1",59,0)
 ;Removed UCI jump p469
"RTN","XUS1",60,0)
 ;S X=%UCI,N1=XUCI I PGM["[" S X=$P(PGM,"[",2,4),PGM=$P(PGM,"[",1)
"RTN","XUS1",61,0)
 ;S:X["""" X=$P(X,"""",2) S:X?.E1"]"&(X'["[") X=$E(X,1,$L(X)-1) S XUM=14,XUM(0)=X
"RTN","XUS1",62,0)
 ;S %UCI=X I "PRODMGR"'[X,$D(^%ZOSF("UCICHECK")) X ^("UCICHECK") G NO:Y="" S:N1=Y %UCI=""
"RTN","XUS1",63,0)
 ;S XUM=15,XUM(0)=PGM G NO:PGM'?1AP.AN
"RTN","XUS1",64,0)
 ;G NO:":"_XUA_":"'[(":"_PGM_":")
"RTN","XUS1",65,0)
 D AUDIT
"RTN","XUS1",66,0)
 S X=$S($D(^VA(200,DUZ,0)):$P($P(^(0),U),","),1:"Unk"),X=$E(X,1,10)_"_"_($J#10000) D SETENV^%ZOSV ;Set Process Name
"RTN","XUS1",67,0)
 ;S X=$P(XOPT,U,16) X:X ^%ZOSF("PRIORITY")
"RTN","XUS1",68,0)
 D LOG:DUZ,KILL
"RTN","XUS1",69,0)
 ;I %UCI]"" K ^XUTL("XQ",$J) S $P(^VA(200,DUZ,1.1),U,3)=0 G GO^%XUCI
"RTN","XUS1",70,0)
 K ^XUTL("OR",$J),^UTILITY($J),%UCI
"RTN","XUS1",71,0)
 G ^XQ ;@(U_PGM)
"RTN","XUS1",72,0)
 ;
"RTN","XUS1",73,0)
SAVE ;
"RTN","XUS1",74,0)
 N X
"RTN","XUS1",75,0)
 S X="DUZ" F  S X=$Q(@X) Q:X=""  I $D(@X) S ^XUTL("XQ",$J,$TR(X,""""))=@X
"RTN","XUS1",76,0)
 F X="DUZ","IO","IO(""IP"")","IO(""CLNM"")","XQVOL" I $D(@X) S ^XUTL("XQ",$J,X)=@X
"RTN","XUS1",77,0)
 D SAVEVAR^%ZIS ;Save the HOME device variables
"RTN","XUS1",78,0)
 Q
"RTN","XUS1",79,0)
 ;
"RTN","XUS1",80,0)
LOG ;used by R/S and Broker
"RTN","XUS1",81,0)
 N %,XP1,XP2
"RTN","XUS1",82,0)
 S XQXFLG("LLOG")=$P($G(^VA(200,DUZ,1.1)),U) ;Save for LOGIN templates
"RTN","XUS1",83,0)
 S XP1=$$SLOG($P(XUVOL,U,1),,XUDEV,XUCI,$P(XUENV,U,3))
"RTN","XUS1",84,0)
 S %=$$COOKIE($P(^VA(200,DUZ,0),U),XP1) I $L(%) S XQXFLG("ZEBRA")=XP1_"~"_%,$P(^XUSEC(0,XP1,0),U,13)=% L +^XWB("SESSION",XQXFLG("ZEBRA")):60
"RTN","XUS1",85,0)
 Q
"RTN","XUS1",86,0)
 ;
"RTN","XUS1",87,0)
 ;Division updated in DIVSET^XUSRB2
"RTN","XUS1",88,0)
 ;The other parameters are in the symbol table with known names.
"RTN","XUS1",89,0)
 ;P1=DUZ,P2=$I,P3=$J,P4=EXIT D/T,P5=VOLUME,P6=TASKMAN,P7=XUDEV,P8=UCI,P9=ZIO,P10=NODE,P11=IP,P12=CLNM,P13=HANDLE,P14=REMOTE SITE,P15=REMOTE IEN
"RTN","XUS1",90,0)
SLOG(P5,P6,P7,P8,P10,P14,P15) ;
"RTN","XUS1",91,0)
 N %,I,DA,DIK,N,XL1,XL2 S XL1=$$NOW^XLFDT
"RTN","XUS1",92,0)
 S P5=$G(P5),P6=$G(P6),P7=$G(P7),P8=$G(P8),P10=$G(P10)
"RTN","XUS1",93,0)
 S N=DUZ_"^"_$I_"^"_$J_"^^"_P5_"^"_P6_"^"_P7_"^"_P8_"^"_$G(IO("ZIO"))_"^"_P10_"^"_$G(IO("IP"))_"^"_$G(IO("CLNM"))
"RTN","XUS1",94,0)
 S:$D(DUZ("VISITOR")) $P(N,U,14,15)=DUZ("VISITOR") ;p523
"RTN","XUS1",95,0)
 S:$G(DUZ(2))>0 $P(N,"^",17)=DUZ(2)
"RTN","XUS1",96,0)
 S:$D(DUZ("REMAPP")) $P(N,U,18)=$P(DUZ("REMAPP"),U) ;p523
"RTN","XUS1",97,0)
 F I=XL1:.00000001 L +^XUSEC(0,I):1 Q:'$D(^XUSEC(0,I))  L -^XUSEC(0,I)
"RTN","XUS1",98,0)
 S ^XUSEC(0,I,0)=N
"RTN","XUS1",99,0)
 L -^XUSEC(0,I)
"RTN","XUS1",100,0)
 S $P(^XUSEC(0,0),"^",3,4)=I_U_(1+$P(^XUSEC(0,0),"^",4))
"RTN","XUS1",101,0)
 S (XL1,DA)=I,DIK="^XUSEC(0," D IX^DIK ;index new entry
"RTN","XUS1",102,0)
 S ^XUTL("XQ",$J,0)=XL1 ;save for sign-off
"RTN","XUS1",103,0)
 I 'P6 S XL2=$G(^VA(200,DUZ,1.1)),$P(XL2,U,1,3)=XL1_"^0^1",$P(XL2,U,5)="",^VA(200,DUZ,1.1)=XL2  ;Set last Sign-on
"RTN","XUS1",104,0)
 Q XL1
"RTN","XUS1",105,0)
 ;
"RTN","XUS1",106,0)
COOKIE(J1,J2) ;Call VAdeamon for a cookie
"RTN","XUS1",107,0)
 N ZZ,%
"RTN","XUS1",108,0)
 I $G(XQXFLG("ZEBRA"))=-1 K XQXFLG("ZEBRA") Q "" ;Disabled
"RTN","XUS1",109,0)
 Q:$G(IO("IP"))="" "" ;Not using Telnet
"RTN","XUS1",110,0)
 Q:$D(DUZ("VISITOR")) "" ;Don't create Handles for visitors p523
"RTN","XUS1",111,0)
 ;
"RTN","XUS1",112,0)
 S %=$$CMD^XWBCAGNT(.ZZ,"XWB CREATE HANDLE",J1_"^"_J2) Q:'% ""
"RTN","XUS1",113,0)
 Q $G(ZZ(1))
"RTN","XUS1",114,0)
 ;
"RTN","XUS1",115,0)
AUDIT ;Set-up Audit info
"RTN","XUS1",116,0)
 N I,I1,I2
"RTN","XUS1",117,0)
 S I=$G(^XTV(8989.3,1,19)),I1=$P(I,U),I2=$P(I,U,2) Q:"asu"'[I1  I (I2>XUNOW)!($P(I,U,3)<XUNOW) Q
"RTN","XUS1",118,0)
 I "au"[I1 S:(I1="a")!($D(^XTV(8989.3,1,19.3,"B",DUZ))>1) XQAUDIT=1 Q
"RTN","XUS1",119,0)
 S XQAUDIT="" F I=0:0 S I=$O(^XTV(8989.3,1,19.1,"B",I)) Q:I'>0!($L(XQAUDIT)>245)  S XQAUDIT=XQAUDIT_"2^"_I_U
"RTN","XUS1",120,0)
 S I1="" F I=0:0 S I1=$O(^XTV(8989.3,1,19.2,"B",I1)) Q:I1']""!($L(XQAUDIT)>245)  S XQAUDIT=XQAUDIT_"3^"_I1_U
"RTN","XUS1",121,0)
 Q
"RTN","XUS1",122,0)
 ;
"RTN","XUS1",123,0)
DD(Y) Q $$FMTE^XLFDT(Y,1)
"RTN","XUS1",124,0)
 ;
"RTN","XUS1",125,0)
KILL N %UCI,PGM,U,XQUR,XMCHAN G KILL1^XUSCLEAN
"RTN","XUS1",126,0)
 Q
"RTN","XUS1",127,0)
NO G NO^XUS
"RTN","XUS1B")
0^1^B3544888
"RTN","XUS1B",1,0)
XUS1B ;ISCSF/RWF - Auto sign-on ;1/30/08  11:37
"RTN","XUS1B",2,0)
 ;;8.0;;**59,337,395,469**;Jul 10, 1995;Build 8
"RTN","XUS1B",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XUS1B",4,0)
 Q
"RTN","XUS1B",5,0)
 ;
"RTN","XUS1B",6,0)
AUTOXUS() ;Do the check for XUS and Auto Sign-on
"RTN","XUS1B",7,0)
 N %,FG,Y
"RTN","XUS1B",8,0)
 I $G(XQXFLG("ASO")) Q 0 ;Already tried once.
"RTN","XUS1B",9,0)
 G AUTO
"RTN","XUS1B",10,0)
 ;
"RTN","XUS1B",11,0)
AUTOXWB() ;Do the check for XWB and Auto Sign-on
"RTN","XUS1B",12,0)
 N %,FG,Y
"RTN","XUS1B",13,0)
 I $G(XQXFLG("ASO")) Q 0 ;Already tried so skip.
"RTN","XUS1B",14,0)
AUTO ;Common code
"RTN","XUS1B",15,0)
 I ($T(^XWBCAGNT)="")!($P(XOPT,U,18)="d") S XQXFLG("ZEBRA")=-1 Q 0 ;Disabled
"RTN","XUS1B",16,0)
 S Y=$$CHKVIP(),%=0
"RTN","XUS1B",17,0)
 I Y>0 S XQXFLG("ASO")=1,%=$$PREF($P(XOPT,U,18),$P($G(^VA(200,Y,200)),U,18))
"RTN","XUS1B",18,0)
 I Y>0,'% S Y=0 ;No Auto signon
"RTN","XUS1B",19,0)
 I Y>0 S DUZ("DIV")=+FG ;Set Division p469
"RTN","XUS1B",20,0)
 Q Y
"RTN","XUS1B",21,0)
 ;
"RTN","XUS1B",22,0)
CHKVIP() ;Check for a Valid current IP
"RTN","XUS1B",23,0)
 N REF,XREF,IEN,R0,ENV,JOB,HNDL
"RTN","XUS1B",24,0)
 S IEN=0,ENV=$$ENV,REF=$G(IO("IP")) I $L(REF) D GETHNDL(.HNDL)
"RTN","XUS1B",25,0)
 I $L(REF) D LKUP("AS1",$P(REF,":")) Q:IEN>0 IEN
"RTN","XUS1B",26,0)
 Q 0
"RTN","XUS1B",27,0)
 ;
"RTN","XUS1B",28,0)
LKUP(XREF,LK) ;Check one X-ref
"RTN","XUS1B",29,0)
 S IX=0
"RTN","XUS1B",30,0)
 F  S IX=$O(^XUSEC(0,XREF,LK,IX)) Q:'$L(IX)  D CHK Q:IEN>0
"RTN","XUS1B",31,0)
 Q
"RTN","XUS1B",32,0)
CHK ;Could this be a good one.
"RTN","XUS1B",33,0)
 N R0,R1,JOB
"RTN","XUS1B",34,0)
 S R0=$G(^XUSEC(0,IX,0))
"RTN","XUS1B",35,0)
 ;Check handle.
"RTN","XUS1B",36,0)
 S R1=$P(R0,U,13) I R1]"",$D(HNDL(R1)) D  Q:IEN>0
"RTN","XUS1B",37,0)
 . L +^XWB("SESSION",IX_"~"_R1):0 I $T L -^XWB("SESSION",IX_"~"_R1) Q
"RTN","XUS1B",38,0)
 . S IEN=+R0,FG=$P(R0,"^",17) Q  ;Found a match
"RTN","XUS1B",39,0)
 Q
"RTN","XUS1B",40,0)
 ;
"RTN","XUS1B",41,0)
ENV() N Y D GETENV^%ZOSV
"RTN","XUS1B",42,0)
 Q Y
"RTN","XUS1B",43,0)
 ;
"RTN","XUS1B",44,0)
PREF(%1,%2) ;
"RTN","XUS1B",45,0)
 Q $S($L(%2):%2,1:%1)
"RTN","XUS1B",46,0)
 ;
"RTN","XUS1B",47,0)
GETHNDL(RET) ;Get the Handles from the Client
"RTN","XUS1B",48,0)
 N %,%1,X,XXX
"RTN","XUS1B",49,0)
 ;I '$D(XWBUSRNM) Q  ;JLI
"RTN","XUS1B",50,0)
 S %=$$CMD^XWBCAGNT(.XXX,"XWB GET HANDLES") Q:'%
"RTN","XUS1B",51,0)
 Q:'$O(XXX(0))
"RTN","XUS1B",52,0)
 ;build array
"RTN","XUS1B",53,0)
 S RET=0,%1=1 F %=1:1:$L(XXX(%1),"^") S X=$P(XXX(%1),"^",%) S:X]"" RET(X)="",RET=RET+1
"RTN","XUS1B",54,0)
 Q
"RTN","XUSRB2")
0^3^B3605542
"RTN","XUSRB2",1,0)
XUSRB2 ;SFISC/RWF - RPC Broker Kernel Utilities. ;1/30/08  11:37
"RTN","XUSRB2",2,0)
 ;;8.0;KERNEL;**115,150,277,337,469**;Jul 10, 1995;Build 8
"RTN","XUSRB2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XUSRB2",4,0)
 Q
"RTN","XUSRB2",5,0)
 ;
"RTN","XUSRB2",6,0)
DIVGET(RET,IEN) ;Get Division data
"RTN","XUSRB2",7,0)
 ;IEN is userid (DUZ or username) for future use.
"RTN","XUSRB2",8,0)
 N %,XUDIV
"RTN","XUSRB2",9,0)
 S XUDIV=0,%=$$CHKDIV^XUS1(.XUDIV) ;Get users div.
"RTN","XUSRB2",10,0)
 I (%>0)&($P(%,U,2)'>0) D UPDIV(+%) ;Set users default div.
"RTN","XUSRB2",11,0)
 S RET(0)=XUDIV ;RET(0) is number of divisions.
"RTN","XUSRB2",12,0)
 I XUDIV S %=0 D  S RET(0)=XUDIV
"RTN","XUSRB2",13,0)
 . ;RET(%) is divison array eg. ien;station name;station#
"RTN","XUSRB2",14,0)
 . F  S %=$O(XUDIV(%)) Q:(%'>0)  S RET(%)=XUDIV(%)
"RTN","XUSRB2",15,0)
 Q
"RTN","XUSRB2",16,0)
DIVSET(RET,DIV) ;Set users Division
"RTN","XUSRB2",17,0)
 S RET=0,DIV=$$FIND1^DIC(200.02,","_DUZ_",","MX",$G(DIV))
"RTN","XUSRB2",18,0)
 Q:DIV'>0
"RTN","XUSRB2",19,0)
 N X
"RTN","XUSRB2",20,0)
 I '$D(^VA(200,DUZ,2,DIV,0)) Q
"RTN","XUSRB2",21,0)
 S RET=1 ;1=set, 0=not set
"RTN","XUSRB2",22,0)
 D UPDIV(+DIV) ;Update Sign-on log
"RTN","XUSRB2",23,0)
 Q
"RTN","XUSRB2",24,0)
 ;
"RTN","XUSRB2",25,0)
UPDIV(V) ;Update the Sign-on Log & DUZ(2)
"RTN","XUSRB2",26,0)
 N IX
"RTN","XUSRB2",27,0)
 S DUZ(2)=V
"RTN","XUSRB2",28,0)
 S IX=$G(^XUTL("XQ",$J,0)) I IX S $P(^XUSEC(0,IX,0),U,17)=DUZ(2)
"RTN","XUSRB2",29,0)
 Q
"RTN","XUSRB2",30,0)
 ;
"RTN","XUSRB2",31,0)
USERINFO(RET) ;generic user information for seeding VistaUser object.
"RTN","XUSRB2",32,0)
 ;Entry point for 'XUS GET USER INFO' RPC
"RTN","XUSRB2",33,0)
 N %,XU1,XU5
"RTN","XUSRB2",34,0)
 S RET(0)=DUZ
"RTN","XUSRB2",35,0)
 F %=1:1:6 S RET(%)="unk"
"RTN","XUSRB2",36,0)
 I DUZ'>0 S XWBSEC="User not fully sign-on" Q
"RTN","XUSRB2",37,0)
 S XU1=^VA(200,DUZ,0),XU5=$G(^(5))
"RTN","XUSRB2",38,0)
 S RET(1)=$P(XU1,"^") ;.01 User name.
"RTN","XUSRB2",39,0)
 S RET(2)=$$NAME^XUSER(DUZ) ;Return standard name.
"RTN","XUSRB2",40,0)
 S RET(3)=DUZ(2)_"^"_$$NS^XUAF4(DUZ(2))
"RTN","XUSRB2",41,0)
 S %=+$P(XU1,U,9),RET(4)=$P($G(^DIC(3.1,%,0)),U) ;Title
"RTN","XUSRB2",42,0)
 S %=+XU5,RET(5)=$P($G(^DIC(49,%,0)),U) ;Service/Section
"RTN","XUSRB2",43,0)
 S RET(6)=$G(DUZ("LANG")) ;User language
"RTN","XUSRB2",44,0)
 S RET(7)=DTIME ;Users DTIME
"RTN","XUSRB2",45,0)
 S RET(8)=$$VPID^XUPS(DUZ) ;Return VPID
"RTN","XUSRB2",46,0)
 Q
"VER")
8.0^22.0
"^DD",3.081,3.081,17,0)
DIVISION^P4'^DIC(4,^0;17^Q
"^DD",3.081,3.081,17,.1)
Division
"^DD",3.081,3.081,17,21,0)
^^2^2^3070919^
"^DD",3.081,3.081,17,21,1,0)
This field holds the division that the user signed into.
"^DD",3.081,3.081,17,21,2,0)
It is used to set the division if the user sign-on is thru AUTO SIGN-ON.
"^DD",3.081,3.081,17,"DT")
3070919
**END**
**END**

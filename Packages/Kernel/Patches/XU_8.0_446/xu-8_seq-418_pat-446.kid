KIDS Distribution saved on Nov 03, 2010@08:33:24
XU 446
**KIDS**:XU*8.0*446^

**INSTALL NAME**
XU*8.0*446
"BLD",7448,0)
XU*8.0*446^KERNEL^0^3101103^y^^
"BLD",7448,4,0)
^9.64PA^14.7^3
"BLD",7448,4,14.7,0)
14.7
"BLD",7448,4,14.7,2,0)
^9.641^14.7^1
"BLD",7448,4,14.7,2,14.7,0)
TASKMAN SITE PARAMETERS  (File-top level)
"BLD",7448,4,14.7,2,14.7,1,0)
^9.6411^21^1
"BLD",7448,4,14.7,2,14.7,1,21,0)
LOAD BALANCE ROUTINE
"BLD",7448,4,14.7,222)
y^y^p^^^^n^^n
"BLD",7448,4,14.7,224)

"BLD",7448,4,14.71,0)
14.71
"BLD",7448,4,14.71,222)
y^y^f^^^^n
"BLD",7448,4,14.72,0)
14.72
"BLD",7448,4,14.72,222)
y^y^f^^^^n
"BLD",7448,4,"APDD",14.7,14.7)

"BLD",7448,4,"APDD",14.7,14.7,21)

"BLD",7448,4,"B",14.7,14.7)

"BLD",7448,4,"B",14.71,14.71)

"BLD",7448,4,"B",14.72,14.72)

"BLD",7448,6)
^418
"BLD",7448,6.3)
36
"BLD",7448,"INIT")
POST^XU8P446
"BLD",7448,"KRN",0)
^9.67PA^779.2^20
"BLD",7448,"KRN",.4,0)
.4
"BLD",7448,"KRN",.401,0)
.401
"BLD",7448,"KRN",.402,0)
.402
"BLD",7448,"KRN",.403,0)
.403
"BLD",7448,"KRN",.5,0)
.5
"BLD",7448,"KRN",.84,0)
.84
"BLD",7448,"KRN",3.6,0)
3.6
"BLD",7448,"KRN",3.8,0)
3.8
"BLD",7448,"KRN",9.2,0)
9.2
"BLD",7448,"KRN",9.8,0)
9.8
"BLD",7448,"KRN",9.8,"NM",0)
^9.68A^23^23
"BLD",7448,"KRN",9.8,"NM",1,0)
ZTMS5^^0^B1225600
"BLD",7448,"KRN",9.8,"NM",2,0)
ZTMON2^^0^B35614836
"BLD",7448,"KRN",9.8,"NM",3,0)
ZTMGRSET^^0^B54941338
"BLD",7448,"KRN",9.8,"NM",4,0)
ZTM^^0^B46237405
"BLD",7448,"KRN",9.8,"NM",5,0)
ZTMS1^^0^B35620816
"BLD",7448,"KRN",9.8,"NM",6,0)
ZTMON^^0^B9524889
"BLD",7448,"KRN",9.8,"NM",7,0)
ZTLOAD5^^0^B11826383
"BLD",7448,"KRN",9.8,"NM",8,0)
ZTMON1^^0^B20595166
"BLD",7448,"KRN",9.8,"NM",9,0)
ZTMS^^0^B17897221
"BLD",7448,"KRN",9.8,"NM",10,0)
ZTM5^^0^B22884813
"BLD",7448,"KRN",9.8,"NM",11,0)
ZTM6^^0^B9213954
"BLD",7448,"KRN",9.8,"NM",12,0)
ZTMCHK1^^0^B10420129
"BLD",7448,"KRN",9.8,"NM",13,0)
ZTMS3^^0^B22900045
"BLD",7448,"KRN",9.8,"NM",14,0)
XUTMK^^0^B33435876
"BLD",7448,"KRN",9.8,"NM",15,0)
ZTMS2^^0^B23695749
"BLD",7448,"KRN",9.8,"NM",16,0)
ZTMS0^^0^B6489089
"BLD",7448,"KRN",9.8,"NM",17,0)
XUTMHR^^0^B19817174
"BLD",7448,"KRN",9.8,"NM",18,0)
ZTM0^^0^B17449159
"BLD",7448,"KRN",9.8,"NM",19,0)
ZTLOAD1^^0^B24362203
"BLD",7448,"KRN",9.8,"NM",20,0)
ZTLOAD2^^0^B9668980
"BLD",7448,"KRN",9.8,"NM",21,0)
ZTLOAD3^^0^B10890458
"BLD",7448,"KRN",9.8,"NM",22,0)
XQ1^^0^B38155212
"BLD",7448,"KRN",9.8,"NM",23,0)
ZTMB^^0^B24960683
"BLD",7448,"KRN",9.8,"NM","B","XQ1",22)

"BLD",7448,"KRN",9.8,"NM","B","XUTMHR",17)

"BLD",7448,"KRN",9.8,"NM","B","XUTMK",14)

"BLD",7448,"KRN",9.8,"NM","B","ZTLOAD1",19)

"BLD",7448,"KRN",9.8,"NM","B","ZTLOAD2",20)

"BLD",7448,"KRN",9.8,"NM","B","ZTLOAD3",21)

"BLD",7448,"KRN",9.8,"NM","B","ZTLOAD5",7)

"BLD",7448,"KRN",9.8,"NM","B","ZTM",4)

"BLD",7448,"KRN",9.8,"NM","B","ZTM0",18)

"BLD",7448,"KRN",9.8,"NM","B","ZTM5",10)

"BLD",7448,"KRN",9.8,"NM","B","ZTM6",11)

"BLD",7448,"KRN",9.8,"NM","B","ZTMB",23)

"BLD",7448,"KRN",9.8,"NM","B","ZTMCHK1",12)

"BLD",7448,"KRN",9.8,"NM","B","ZTMGRSET",3)

"BLD",7448,"KRN",9.8,"NM","B","ZTMON",6)

"BLD",7448,"KRN",9.8,"NM","B","ZTMON1",8)

"BLD",7448,"KRN",9.8,"NM","B","ZTMON2",2)

"BLD",7448,"KRN",9.8,"NM","B","ZTMS",9)

"BLD",7448,"KRN",9.8,"NM","B","ZTMS0",16)

"BLD",7448,"KRN",9.8,"NM","B","ZTMS1",5)

"BLD",7448,"KRN",9.8,"NM","B","ZTMS2",15)

"BLD",7448,"KRN",9.8,"NM","B","ZTMS3",13)

"BLD",7448,"KRN",9.8,"NM","B","ZTMS5",1)

"BLD",7448,"KRN",19,0)
19
"BLD",7448,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",7448,"KRN",19,"NM",1,0)
XUTM SNAPSHOT^^0
"BLD",7448,"KRN",19,"NM","B","XUTM SNAPSHOT",1)

"BLD",7448,"KRN",19.1,0)
19.1
"BLD",7448,"KRN",101,0)
101
"BLD",7448,"KRN",409.61,0)
409.61
"BLD",7448,"KRN",771,0)
771
"BLD",7448,"KRN",779.2,0)
779.2
"BLD",7448,"KRN",870,0)
870
"BLD",7448,"KRN",8989.51,0)
8989.51
"BLD",7448,"KRN",8989.52,0)
8989.52
"BLD",7448,"KRN",8994,0)
8994
"BLD",7448,"KRN","B",.4,.4)

"BLD",7448,"KRN","B",.401,.401)

"BLD",7448,"KRN","B",.402,.402)

"BLD",7448,"KRN","B",.403,.403)

"BLD",7448,"KRN","B",.5,.5)

"BLD",7448,"KRN","B",.84,.84)

"BLD",7448,"KRN","B",3.6,3.6)

"BLD",7448,"KRN","B",3.8,3.8)

"BLD",7448,"KRN","B",9.2,9.2)

"BLD",7448,"KRN","B",9.8,9.8)

"BLD",7448,"KRN","B",19,19)

"BLD",7448,"KRN","B",19.1,19.1)

"BLD",7448,"KRN","B",101,101)

"BLD",7448,"KRN","B",409.61,409.61)

"BLD",7448,"KRN","B",771,771)

"BLD",7448,"KRN","B",779.2,779.2)

"BLD",7448,"KRN","B",870,870)

"BLD",7448,"KRN","B",8989.51,8989.51)

"BLD",7448,"KRN","B",8989.52,8989.52)

"BLD",7448,"KRN","B",8994,8994)

"BLD",7448,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7448,"QUES",0)
^9.62^^
"BLD",7448,"REQB",0)
^9.611^2^2
"BLD",7448,"REQB",1,0)
XU*8.0*355^2
"BLD",7448,"REQB",2,0)
XU*8.0*339^2
"BLD",7448,"REQB","B","XU*8.0*339",2)

"BLD",7448,"REQB","B","XU*8.0*355",1)

"FIA",14.7)
TASKMAN SITE PARAMETERS
"FIA",14.7,0)
^%ZIS(14.7,
"FIA",14.7,0,0)
14.7
"FIA",14.7,0,1)
y^y^p^^^^n^^n
"FIA",14.7,0,10)

"FIA",14.7,0,11)

"FIA",14.7,0,"RLRO")

"FIA",14.7,0,"VR")
8.0^XU
"FIA",14.7,14.7)
1
"FIA",14.7,14.7,21)

"FIA",14.71)
TASKMAN MONITOR
"FIA",14.71,0)
^%ZIS(14.71,
"FIA",14.71,0,0)
14.71D
"FIA",14.71,0,1)
y^y^f^^^^n
"FIA",14.71,0,10)

"FIA",14.71,0,11)

"FIA",14.71,0,"RLRO")

"FIA",14.71,0,"VR")
8.0^XU
"FIA",14.71,14.71)
0
"FIA",14.72)
TASKMAN SNAPSHOT
"FIA",14.72,0)
^%ZIS(14.72,
"FIA",14.72,0,0)
14.72D
"FIA",14.72,0,1)
y^y^f^^^^n
"FIA",14.72,0,10)

"FIA",14.72,0,11)

"FIA",14.72,0,"RLRO")

"FIA",14.72,0,"VR")
8.0^XU
"FIA",14.72,14.72)
0
"FIA",14.72,14.72101)
0
"FIA",14.72,14.72201)
0
"INIT")
POST^XU8P446
"KRN",19,13720,-1)
0^1
"KRN",19,13720,0)
XUTM SNAPSHOT^Taskman snapshot^^R^^^^^^^^KERNEL^y
"KRN",19,13720,1,0)
^^9^9^3081104^
"KRN",19,13720,1,1,0)
Schedule this option (XUTM SNAPSHOT) to grab a snapshot of Taskman work
"KRN",19,13720,1,2,0)
counts and save them in the TASKMAN SNAPSHOT file (#14.72). When the Task
"KRN",19,13720,1,3,0)
is scheduled it takes an entry in the TASK PARAMETERS field.
"KRN",19,13720,1,4,0)
This is how many MINUTES to sample for, "," and how many SECONDS to wait
"KRN",19,13720,1,5,0)
between samples.
"KRN",19,13720,1,6,0)
It has a limit of 480 minutes (8 hours) and a minimum of 2 seconds to
"KRN",19,13720,1,7,0)
wait. At these limits it would record 14400 samples.  It will default to
"KRN",19,13720,1,8,0)
60 minutes with a sample every 60 seconds if the TASK PARAMETERS field is
"KRN",19,13720,1,9,0)
not filled in.
"KRN",19,13720,25)
SNAP^XUTMHR
"KRN",19,13720,200.9)
y
"KRN",19,13720,"U")
TASKMAN SNAPSHOT
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",163,-1)
1^1
"PKG",163,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",163,22,0)
^9.49I^1^1
"PKG",163,22,1,0)
8.0^2950703^2951019^1039
"PKG",163,22,1,"PAH",1,0)
446^3101103
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
24
"RTN","XQ1")
0^22^B38155212
"RTN","XQ1",1,0)
XQ1 ; SEA/MJM - DRIVER FOR MENUMAN (PART 2) ;08/28/08  13:20
"RTN","XQ1",2,0)
 ;;8.0;KERNEL;**1,15,59,67,46,151,170,242,446**;Jul 10, 1995;Build 36
"RTN","XQ1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQ1",4,0)
 S DIC=19,DIC(0)="AEQM" D ^DIC Q:Y<0  S (XQDIC,XQY)=+Y K DIC,XQUR,Y,^VA(200,DUZ,202.1)
"RTN","XQ1",5,0)
 D INIT^XQ12
"RTN","XQ1",6,0)
 G M^XQ
"RTN","XQ1",7,0)
 ;
"RTN","XQ1",8,0)
KILL K D,D0,D1,DA,DIC,DIE,DIR,DIS,DR,XQI,XQV,XQW,XQZ
"RTN","XQ1",9,0)
 D CLEAN^DILF
"RTN","XQ1",10,0)
 ;
"RTN","XQ1",11,0)
OUT ;Exit point for all option types
"RTN","XQ1",12,0)
 S U="^"
"RTN","XQ1",13,0)
 I $D(XQXFLG("ZEBRA")) L ^XWB("SESSION",XQXFLG("ZEBRA")):15 ;Clear by setting new lock
"RTN","XQ1",14,0)
 E  L  ;Clear the lock table
"RTN","XQ1",15,0)
 ;
"RTN","XQ1",16,0)
 I $D(ZTQUEUED),'$D(XQUIT) D
"RTN","XQ1",17,0)
 .N XQF
"RTN","XQ1",18,0)
 .S XQF=$S('$D(^DIC(19,XQY,15)):0,'$L(^(15)):0,1:1)
"RTN","XQ1",19,0)
 .X:XQF ^(15)
"RTN","XQ1",20,0)
 .Q
"RTN","XQ1",21,0)
 Q:$D(ZTQUEUED)  ;Quit here if it's a Taskman job
"RTN","XQ1",22,0)
 ;
"RTN","XQ1",23,0)
 I '$D(DT)!('$D(DTIME))!('$D(DUZ))!('$D(DUZ(0)))!('$D(DUZ("AG")))!('$D(DUZ("AUTO"))) D DVARS^XQ12
"RTN","XQ1",24,0)
 I $D(DUZ("AUTO")),DUZ("AUTO"),$D(XQY),$D(^DIC(19,+XQY,0))#2,$P(^(0),"^",11)["y" W !!,*7,"Press RETURN to continue..." R %:DTIME
"RTN","XQ1",25,0)
 I $D(^XUTL("XQ",$J,"RBX")) G RBX^XQ73
"RTN","XQ1",26,0)
 I $D(^XUTL("XQ",$J,"T")) I ^("T")<0 S ^("T")=$S($D(^XUTL("XQ",$J,1)):1,1:0)
"RTN","XQ1",27,0)
 I $D(^XUTL("XQ",$J,"T")) S XQY=+^(^("T")),XQT="" S:$D(^DIC(19,+XQY,0)) XQT=$P(^(0),U,4) I '$D(XQUIT),("LOQX"'[XQT),$D(^DIC(19,XQY,15)),$L(^(15)) X ^(15) ;W "  ==> OUT^XQ1"
"RTN","XQ1",28,0)
 Q:'$D(^XUTL("XQ",$J,"T"))
"RTN","XQ1",29,0)
 I $D(^XUTL("XQ",$J,"T")) S XQTT=$S($D(XQUIT):^XUTL("XQ",$J,"T"),1:^XUTL("XQ",$J,"T")-1) K XQUIT
"RTN","XQ1",30,0)
 I XQTT'<1 S ^XUTL("XQ",$J,"T")=XQTT,XQY=^(XQTT),XQY0=$P(XQY,U,2,999),XQPSM=$P(XQY,U,1),XQY=+XQPSM,XQPSM=$P(XQPSM,XQY,2,99),XQABOLD=1
"RTN","XQ1",31,0)
 I XQTT=0 S XQY=-1
"RTN","XQ1",32,0)
 I $P(XQY0,U,4)="M" S XQAA=$P(XQY0,U,2) I $P(XQY0,U,17),$D(^DIC(19,+XQY,26)),$L(^(26)) X ^(26) ;W "  ==> OUT^XQ1"
"RTN","XQ1",33,0)
 K %,X,XQDICNEW,XQF,XQCO,XQEA,XQFLG,XQI,XQJ,XQJS,XQK,XQLOK,XQNOPE,XQOK,XQTT,XQX,XQZ,Y,Z
"RTN","XQ1",34,0)
 G M1^XQ
"RTN","XQ1",35,0)
 ;
"RTN","XQ1",36,0)
A ;ACTION type option entry point
"RTN","XQ1",37,0)
 X:$D(^DIC(19,+XQY,20)) ^(20) ;W "  ==> A^XQ1"
"RTN","XQ1",38,0)
 I $D(XQUIT) S XQUIT=1 D ^XQUIT I $D(XQUIT) K XQUIT G OUT
"RTN","XQ1",39,0)
 I $P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26) ;W "  ==> A^XQ1"
"RTN","XQ1",40,0)
 G OUT
"RTN","XQ1",41,0)
 ;
"RTN","XQ1",42,0)
C ;ScreenMan type options
"RTN","XQ1",43,0)
 D DIC G:DA=-1 KILL S XQZ="DR,DDSFILE,DDSFILE(1)",XQW=39 D SET
"RTN","XQ1",44,0)
 S DDSPAGE=$P($G(^DIC(19,+XQY,43)),U) K:DDSPAGE="" DDSPAGE
"RTN","XQ1",45,0)
 S DDSPARM=$P($G(^DIC(19,+XQY,43)),U,2) K:DDSPARM="" DDSPARM
"RTN","XQ1",46,0)
 I DDSFILE["(",DDSFILE'[U S DDSFILE=U_DDSFILE
"RTN","XQ1",47,0)
 I $D(DDSFILE(1)),DDSFILE(1)["(",DDSFILE(1)'[U S DDSFILE(1)=U_DDSFILE(1)
"RTN","XQ1",48,0)
 D ^DDS K DDSFILE G C
"RTN","XQ1",49,0)
 ;
"RTN","XQ1",50,0)
P ;PRINT type option
"RTN","XQ1",51,0)
 S XQZ="DIC,PG,L,FLDS,BY,FR,TO,DHD,DCOPIES,DIS(0),IOP,DHIT,DIOBEG,DIOEND",XQW=59 D SET
"RTN","XQ1",52,0)
 I $D(DIS(0))#2 F XQI=1:1:3 Q:'$D(^DIC(19,+XQY,69+(XQI/10)))  Q:^(69+(XQI/10))=""  S DIS(XQI)=^(69+(XQI/10))
"RTN","XQ1",53,0)
 S:$D(XQIOP) IOP=XQIOP
"RTN","XQ1",54,0)
 S XQI=$G(^DIC(19,XQY,79)) S:XQI>0 DIASKHD="" S:$P(XQI,U,2) DISUPNO=1 S:$P(XQI,U,3) DIPCRIT=1
"RTN","XQ1",55,0)
 D D1,EN1^DIP K IOP,DIOBEG,DIS,DP G OUT
"RTN","XQ1",56,0)
 ;
"RTN","XQ1",57,0)
I ;INQUIRE type option
"RTN","XQ1",58,0)
I1 D DIC G KILL:DA=-1 S DI=DIC,XQZ="DIC,DR,DIQ(0)",XQW=79 D SET,D1 S:$D(DIC)[0 DIC=DI
"RTN","XQ1",59,0)
 I $D(^DIC(19,+XQY,63)),$L(^(63)) S FLDS=^(63)
"RTN","XQ1",60,0)
 E  S FLDS="[CAPTIONED]"
"RTN","XQ1",61,0)
 I $G(^DIC(19,+XQY,83))["Y" S IOP="HOME"
"RTN","XQ1",62,0)
I2 ;
"RTN","XQ1",63,0)
 W ! S XQZ="DHD",XQW=66 D SET K ^UTILITY($J),^(U,$J) S ^($J,1,DA)="",@("L=+$P("_DI_"0),U,2)"),DPP(1)=L_"^^^@",L=0,C=",",Q="""",DPP=1,DPP(1,"IX")="^UTILITY(U,$J,"_DI_"^2" D N^DIP1 S Y=XQY G I1
"RTN","XQ1",64,0)
 ;
"RTN","XQ1",65,0)
E ;EDIT type option entry point
"RTN","XQ1",66,0)
E1 D DIC G KILL:DA=-1 K DIE,DIC S XQZ="DIE,DR",XQW=49 D SET S XQZ="DIE(""W"")",XQW=53 D SET
"RTN","XQ1",67,0)
 I $D(^DIC(19,XQY,53)),$L(^(53)) S %=^(53),DIE("NO^")=$S(%="N":"",1:%)
"RTN","XQ1",68,0)
 ;S:DIE["(" DIE=U_DIE
"RTN","XQ1",69,0)
 ;
"RTN","XQ1",70,0)
 ;DIE does not lock so we do it here
"RTN","XQ1",71,0)
 ;
"RTN","XQ1",72,0)
 S XQLOK="",XQNOPE=0
"RTN","XQ1",73,0)
 I DIE["(" D
"RTN","XQ1",74,0)
 .S DIE=U_DIE
"RTN","XQ1",75,0)
 .S XQLOK=DIE_DA_")" L +@XQLOK:2
"RTN","XQ1",76,0)
 .I '$T S XQNOPE=1 W !,"Someone else is editing this data.  Try later."
"RTN","XQ1",77,0)
 .Q
"RTN","XQ1",78,0)
 ;
"RTN","XQ1",79,0)
 I DIE=+DIE D
"RTN","XQ1",80,0)
 .N %
"RTN","XQ1",81,0)
 .S %=$$ROOT^DILFD(DIE)
"RTN","XQ1",82,0)
 .I %'="" S XQLOK=%_DA_")" L +@XQLOK:2
"RTN","XQ1",83,0)
 .I '$T S XQNOPE=1 W !,"Someone else is editing this data.  Try later."
"RTN","XQ1",84,0)
 .Q
"RTN","XQ1",85,0)
 ;
"RTN","XQ1",86,0)
 G:XQNOPE E1  ;Node is being edited right now, skip DIE
"RTN","XQ1",87,0)
 D ^DIE S Y=XQY
"RTN","XQ1",88,0)
 I XQLOK'="" L -@XQLOK
"RTN","XQ1",89,0)
 G E1
"RTN","XQ1",90,0)
 ;
"RTN","XQ1",91,0)
 ;
"RTN","XQ1",92,0)
DIC ;Get FileMan parameters from Option File and do look up
"RTN","XQ1",93,0)
 W ! K DIC S XQZ="DIC,DIC(0),DIC(""A""),DIC(""B""),DIC(""S""),DIC(""W""),D",XQW=29 D SET,D1
"RTN","XQ1",94,0)
 I '$D(D) D ^DIC
"RTN","XQ1",95,0)
 I $D(D) S:D="" D="B" D IX^DIC
"RTN","XQ1",96,0)
 I $D(Y),Y>0,$P(Y,U,3) S XQDICNEW=Y
"RTN","XQ1",97,0)
 S DA=+Y,Y=XQY
"RTN","XQ1",98,0)
 Q
"RTN","XQ1",99,0)
 ;
"RTN","XQ1",100,0)
D1 S:DIC["(" DIC=U_DIC Q
"RTN","XQ1",101,0)
 ;
"RTN","XQ1",102,0)
SET F XQI=1:1 S XQV=$P(XQZ,",",XQI) Q:XQV=""  K @XQV I $D(^DIC(19,+XQY,XQW+XQI)),^(XQW+XQI)]"" S @XQV=^(XQW+XQI)
"RTN","XQ1",103,0)
 I $D(DIC("A")),DIC("A")]"" S DIC("A")=DIC("A")_" "
"RTN","XQ1",104,0)
 K XQI,J
"RTN","XQ1",105,0)
 Q
"RTN","XQ1",106,0)
 ;
"RTN","XQ1",107,0)
R ;RUN ROUTINE type option entry point
"RTN","XQ1",108,0)
 G:'$D(^DIC(19,XQY,25)) OUT:$D(ZTQUEUED),M1^XQ S XQZ=^(25) G:'$L(XQZ) M1^XQ S:XQZ'[U XQZ=U_XQZ I XQZ["[" D DO^%XUCI G OUT
"RTN","XQ1",109,0)
 D @XQZ G OUT
"RTN","XQ1",110,0)
 ;
"RTN","XQ1",111,0)
W ;Window type option entry point
"RTN","XQ1",112,0)
 S XQOK=1
"RTN","XQ1",113,0)
 I $D(^DIC(19,XQY,25)),$L(^(25)) D  G OUT ;Routine type
"RTN","XQ1",114,0)
 .S XQZ=^DIC(19,XQY,25)
"RTN","XQ1",115,0)
 .S:XQZ'[U XQZ=U_XQZ
"RTN","XQ1",116,0)
 .I XQZ["[" D DO^%XUCI Q
"RTN","XQ1",117,0)
 .D @XQZ
"RTN","XQ1",118,0)
 .Q
"RTN","XQ1",119,0)
 ;
"RTN","XQ1",120,0)
 ;I $D(^DIC(19,XQY,24)),$L(^(24)) D  G:XQOK OUT ;Pointer type
"RTN","XQ1",121,0)
 ;.S XQZ=^DIC(19,XQY,24)
"RTN","XQ1",122,0)
 ;.S XQZ=$P($G(^XTV(8995,XQZ,0)),U) I XQZ="" S XQOK=0 Q
"RTN","XQ1",123,0)
 ;.D PREP^XG
"RTN","XQ1",124,0)
 ;.S XQWIN=$$NEXTNM^XGCLOAD("XQWIN")
"RTN","XQ1",125,0)
 ;.D GET^XGCLOAD(XQZ,XQWIN,"^TMP($J)")
"RTN","XQ1",126,0)
 ;.D GET^XGCLOAD(XQZ,$NA(^TMP($J,XQWIN)))
"RTN","XQ1",127,0)
 ;.D M^XG(XQWIN,$NA(^TMP($J,XQWIN)))
"RTN","XQ1",128,0)
 ;.D ESTA^XG() ;Send it off to window land
"RTN","XQ1",129,0)
 ;.;
"RTN","XQ1",130,0)
 ;.D K^XG(XQWIN) ;Return here after the ESTOP
"RTN","XQ1",131,0)
 ;.;I $D(^%ZOSF("OS")),^%ZOSF("OS")["MSM" ZSTOP
"RTN","XQ1",132,0)
 ;.Q
"RTN","XQ1",133,0)
 ;
"RTN","XQ1",134,0)
 G M1^XQ ;Window failed
"RTN","XQ1",135,0)
 ;
"RTN","XQ1",136,0)
Z ;Window suite option
"RTN","XQ1",137,0)
 G EN^XQSUITE
"RTN","XQ1",138,0)
 ;
"RTN","XQ1",139,0)
S ;Server-type option pseudo entry-point can't be invoked from Meun System
"RTN","XQ1",140,0)
 G OUT
"RTN","XQ1",141,0)
 ;
"RTN","XQ1",142,0)
B ;Client/Server option can't be run from menu system
"RTN","XQ1",143,0)
 G OUT
"RTN","XQ1",144,0)
 ;
"RTN","XQ1",145,0)
L ;OE/RR Limited option
"RTN","XQ1",146,0)
O ;OE/RR Protocol (orderables) type option entry point
"RTN","XQ1",147,0)
X ;OE/RR Extended Action type option (Subset of Protocol type)
"RTN","XQ1",148,0)
Q ;OE/RR Protocol Menu type option entry point
"RTN","XQ1",149,0)
 S XQOR=+XQY,XQOR(1)=XQT D XQ^XQOR K XQOR G OUT
"RTN","XQ1",150,0)
 ;
"RTN","XQ1",151,0)
ZTSK ;Task Manager entry point
"RTN","XQ1",152,0)
 S U="^" G:$G(XQSCH)'>0 ZTSK2 ;No reschedule
"RTN","XQ1",153,0)
 S %=$$S^%ZTLOAD("Reschedule Task")
"RTN","XQ1",154,0)
 S XQ=$G(^DIC(19.2,XQSCH,0)),XQY=+XQ Q:XQY'>0
"RTN","XQ1",155,0)
 K ZTQPARAM ;Build params from schedule in case we delete it.
"RTN","XQ1",156,0)
 I $D(^DIC(19.2,XQSCH,3)),$L(^(3)) S ZTQPARAM=^(3)
"RTN","XQ1",157,0)
 I $D(^DIC(19.2,XQSCH,2)) D  ;Build other symbols
"RTN","XQ1",158,0)
 . N X1,X2 S X2=XQSCH N XQSCH,XQY,XQ
"RTN","XQ1",159,0)
 . F X1=0:0 S X1=$O(^DIC(19.2,X2,2,X1)) Q:X1'>0  S X=^(X1,0),@($P(X,U)_"="_$P(X,U,2))
"RTN","XQ1",160,0)
 . Q
"RTN","XQ1",161,0)
 ;
"RTN","XQ1",162,0)
 S X=$P($G(^DIC(19.2,XQSCH,1.1)),U) I X>0 D DUZ^XUP(X) ;User to run job ;p446
"RTN","XQ1",163,0)
REQ D  ;Set the user and Requeue
"RTN","XQ1",164,0)
 . N DA,DIE,DR,X,X1,X2
"RTN","XQ1",165,0)
 . S X1=$P(XQ,U,2),X2=$P(XQ,U,6) ;Get params for new schedule
"RTN","XQ1",166,0)
 . S DA=XQSCH,DIE="^DIC(19.2,",DR=$S((X2="")&($P(XQ,U,9)=""):".01///@",X2="":"2///@",1:"2////"_$$SCH^XLFDT(X2,+X1,1))
"RTN","XQ1",167,0)
 . L +^%ZTSK(ZTSK,0):15 D ^DIE L -^%ZTSK(ZTSK,0) ;File new schedule
"RTN","XQ1",168,0)
 . Q
"RTN","XQ1",169,0)
 ;ZTREQ is set by TM.
"RTN","XQ1",170,0)
ZTSK2 I '$D(XQY) K ZTREQ Q  ;Leave task
"RTN","XQ1",171,0)
 D UI^XQ12
"RTN","XQ1",172,0)
 Q:'$D(^DIC(19,XQY,0))  S XQY0=^(0),XQT=$P(XQY0,U,4) Q:XQT'="A"&(XQT'="P")&(XQT'="R")
"RTN","XQ1",173,0)
 ;Kernel no longer supports reseting priority
"RTN","XQ1",174,0)
 ;S X=$P(XQY0,U,8) I X>0,X<11 X ^%ZOSF("PRIORITY")
"RTN","XQ1",175,0)
 I $P(XQY0,U,3)]""!($D(XQUIT)) S XQT="KILL"
"RTN","XQ1",176,0)
 ;
"RTN","XQ1",177,0)
 S %=$$S^%ZTLOAD("Run Task")
"RTN","XQ1",178,0)
RUN S:XQT="P"&$L(IO) XQIOP=ION_";"_IOST_";"_IOM_";"_IOSL G @XQT
"RTN","XQ1",179,0)
 Q
"RTN","XU8P446")
0^^B672454
"RTN","XU8P446",1,0)
XU8P446 ;ISF/RWF - POST INIT FOR PATCH XU*8*446 ;08/27/08  15:06
"RTN","XU8P446",2,0)
 ;;8.0;KERNEL;**446**;JUL 10, 1995;Build 36
"RTN","XU8P446",3,0)
 Q
"RTN","XU8P446",4,0)
 ;
"RTN","XU8P446",5,0)
POST ;
"RTN","XU8P446",6,0)
 D PROXY
"RTN","XU8P446",7,0)
 D PATCH^ZTMGRSET(446)
"RTN","XU8P446",8,0)
 Q
"RTN","XU8P446",9,0)
 ;
"RTN","XU8P446",10,0)
PROXY ;Setup Proxy User
"RTN","XU8P446",11,0)
 N X,NAME
"RTN","XU8P446",12,0)
 S NAME="TASKMAN,PROXY USER"
"RTN","XU8P446",13,0)
 S X=$$APFIND^XUSAP(NAME) I X>0 Q  ;All ready setup
"RTN","XU8P446",14,0)
 I (+X)'=-1 Q  ;Some problem
"RTN","XU8P446",15,0)
 ;Setup Proxy
"RTN","XU8P446",16,0)
 S X=$$CREATE^XUSAP(NAME,"#")
"RTN","XU8P446",17,0)
 D BMES^XPDUTL("POST-INIT: Taskman proxy "_$S(X>0:"created.",1:"Failed"))
"RTN","XU8P446",18,0)
 Q
"RTN","XUTMHR")
0^17^B19817174
"RTN","XUTMHR",1,0)
XUTMHR ;ISF/RWF - Taskman Hourly checkup routine. ;08/27/08  14:28
"RTN","XUTMHR",2,0)
 ;;8.0;KERNEL;**446**;Jul 10, 1995;Build 36
"RTN","XUTMHR",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XUTMHR",4,0)
 Q
"RTN","XUTMHR",5,0)
 ;
"RTN","XUTMHR",6,0)
HOUR ;Work to do each hour
"RTN","XUTMHR",7,0)
 D SCAN
"RTN","XUTMHR",8,0)
 Q
"RTN","XUTMHR",9,0)
 ;
"RTN","XUTMHR",10,0)
SCAN ;Scan the Scheduled Tasks file.  Merge with XUTMCS sometime.
"RTN","XUTMHR",11,0)
 N D0,OLD,NOW,X,X1,X2,Z0,Z4,Z5,TK
"RTN","XUTMHR",12,0)
 S U="^",D0=0,NOW=$$NOW^XLFDT,OLD=$$HTFM^XLFDT($H-1)
"RTN","XUTMHR",13,0)
 F  S D0=$O(^DIC(19.2,D0)) Q:'D0  D  L -^DIC(19.2,D0)
"RTN","XUTMHR",14,0)
 . L +^DIC(19.2,D0):2 I '$T Q
"RTN","XUTMHR",15,0)
 . S X=$G(^DIC(19.2,D0,0)),X1=+$G(^(1)) ;X1 is the task #.
"RTN","XUTMHR",16,0)
 . ;Check that the Option still exists.
"RTN","XUTMHR",17,0)
 . I '($D(^DIC(19,+X,0))#2) D REMOVE(D0) Q
"RTN","XUTMHR",18,0)
 . I $P(X,U,2)="" Q  ;No Scheduled time.
"RTN","XUTMHR",19,0)
 . ;I $P(X,U,9)["S" Q  ;Start-up.
"RTN","XUTMHR",20,0)
 . I $P(X,U,2)>NOW,$D(^%ZTSK(X1)) Q  ;Scheduled for future
"RTN","XUTMHR",21,0)
 . I X1,'$D(^%ZTSK(X1)) D FIX(D0,X) Q  ;%ZTSK entry missing
"RTN","XUTMHR",22,0)
 . S TK=$G(^%ZTSK(X1,0))
"RTN","XUTMHR",23,0)
 . I $P(X,U,2)>OLD,$L($P(X,U,6)) D FIX(D0,X,$P(TK,U,3)) Q  ;
"RTN","XUTMHR",24,0)
 S ZTREQ="@"
"RTN","XUTMHR",25,0)
 Q
"RTN","XUTMHR",26,0)
 ;
"RTN","XUTMHR",27,0)
FIX(DA,X,USER) ;Reschedule
"RTN","XUTMHR",28,0)
 N FDA,IEN,Y,DUZ
"RTN","XUTMHR",29,0)
 S Y=$$APFIND^XUSAP("TASKMAN,PROXY USER")
"RTN","XUTMHR",30,0)
 S DUZ=$S($G(USER):USER,Y>0:Y,1:.5)
"RTN","XUTMHR",31,0)
 S Y=$$SCH^XLFDT($P(X,U,6),$P(X,U,2),1),IEN=DA_"," Q:'Y
"RTN","XUTMHR",32,0)
 S FDA(19.2,IEN,2)=Y
"RTN","XUTMHR",33,0)
 D FILE^DIE("K","FDA")
"RTN","XUTMHR",34,0)
 Q
"RTN","XUTMHR",35,0)
 ;
"RTN","XUTMHR",36,0)
REMOVE(DA) ;Remove if pointed to option is missing
"RTN","XUTMHR",37,0)
 N DIK
"RTN","XUTMHR",38,0)
 S DIK="^DIC(19.2," D ^DIK
"RTN","XUTMHR",39,0)
 Q
"RTN","XUTMHR",40,0)
 ;
"RTN","XUTMHR",41,0)
EN(ZTQPARAM) ;So can job it to run.
"RTN","XUTMHR",42,0)
 ;
"RTN","XUTMHR",43,0)
SNAP ;Snapshot ZTMON data into the TASKMAN SNAPSHOT file.
"RTN","XUTMHR",44,0)
 S U="^"
"RTN","XUTMHR",45,0)
 N ZT1,ZT2,ZT3,ZT4,ZT5,ZTC,ZTC2,FDA,IEN,NOWH3,ZTQ1,ZTQ2
"RTN","XUTMHR",46,0)
 S ZTQPARAM=$G(ZTQPARAM,"60,60") ;Default run for 60 minutes, snap every minute
"RTN","XUTMHR",47,0)
 S ZTQ1=+ZTQPARAM*60 ;Convert minutes to seconds.
"RTN","XUTMHR",48,0)
 S:ZTQ1>480 ZTQ1=480 ;Max 8 hours
"RTN","XUTMHR",49,0)
 S ZTQ2=+$P(ZTQPARAM,",",2)
"RTN","XUTMHR",50,0)
 S ZTQ2=$S(ZTQ2<2:2,ZTQ2>ZTQ1:ZTQ1,1:ZTQ2) ;See in bounds
"RTN","XUTMHR",51,0)
 ;
"RTN","XUTMHR",52,0)
 F  D SN2 S ZTQ1=ZTQ1-ZTQ2 Q:'ZTQ1  H ZTQ2
"RTN","XUTMHR",53,0)
 Q
"RTN","XUTMHR",54,0)
 ;
"RTN","XUTMHR",55,0)
SN2 ;Do the snapshot
"RTN","XUTMHR",56,0)
 K IEN,FDA,%,R2,R3,SI,I2,I3
"RTN","XUTMHR",57,0)
 S IEN="+1,",NOWH3=$$H3^%ZTM($H)
"RTN","XUTMHR",58,0)
 S FDA(14.72,IEN,.01)=$$NOW^XLFDT
"RTN","XUTMHR",59,0)
 S FDA(14.72,IEN,2)=$$TM^ZTLOAD
"RTN","XUTMHR",60,0)
 S ZT1="",ZT2=0,SI=101,R2=14.72101
"RTN","XUTMHR",61,0)
 ;Get the Manager status data
"RTN","XUTMHR",62,0)
 F  S ZT1=$O(^%ZTSCH("STATUS",ZT1)) Q:ZT1=""  S X=^(ZT1) D
"RTN","XUTMHR",63,0)
 . S ZT2=ZT2+1,I2="+"_SI_","_IEN,SI=SI+1
"RTN","XUTMHR",64,0)
 . S FDA(R2,I2,.01)=ZT1,FDA(R2,I2,2)=$P(X,U),FDA(R2,I2,3)=$P(X,U,2)
"RTN","XUTMHR",65,0)
 . S FDA(R2,I2,4)=$P(X,U,3),FDA(R2,I2,5)=$P(X,U,4)
"RTN","XUTMHR",66,0)
 . Q
"RTN","XUTMHR",67,0)
 S FDA(14.72,IEN,3)=ZT2
"RTN","XUTMHR",68,0)
 ;Check and get the LOAD Balance data
"RTN","XUTMHR",69,0)
 S %=$G(^%ZTSCH("LOAD")),FDA(14.72,IEN,4)=$P(%,U),FDA(14.72,IEN,5)=$P(%,U,2)
"RTN","XUTMHR",70,0)
 ;S ZT1=$O(^%ZTSCH(1)),FDA(14.72,IEN,8)=$$LATE(ZT1,NOWH3)
"RTN","XUTMHR",71,0)
 S ZT1=1,ZT2=0,ZT3=0,ZTC=0,ZTC2=0,ZT5=0
"RTN","XUTMHR",72,0)
 ;Look at the task schedule list
"RTN","XUTMHR",73,0)
 ;ZT3 late amount, ZT5 is current time late, ZTC2 is count of late tasks.
"RTN","XUTMHR",74,0)
 F  S ZT1=$O(^%ZTSCH(ZT1)),ZT2=0 Q:'ZT1  S ZT5=$$LATE(ZT1,NOWH3) S:'ZT3 ZT3=ZT5 D
"RTN","XUTMHR",75,0)
 . F  S ZT2=$O(^%ZTSCH(ZT1,ZT2)) Q:'ZT2  S ZTC=ZTC+1 S:ZT5 ZTC2=ZTC2+1
"RTN","XUTMHR",76,0)
 S FDA(14.72,IEN,7)=ZTC,FDA(14.72,IEN,8)=ZT3,FDA(14.72,IEN,9)=ZTC2
"RTN","XUTMHR",77,0)
 ;Look at the IO list
"RTN","XUTMHR",78,0)
 S ZT1="",ZTC=0
"RTN","XUTMHR",79,0)
 F  S ZT1=$O(^%ZTSCH("IO",ZT1)) Q:ZT1=""  S:$O(^%ZTSCH("IO",ZT1,0)) ZTC=ZTC+1
"RTN","XUTMHR",80,0)
 S FDA(14.72,IEN,10)=ZTC
"RTN","XUTMHR",81,0)
 S ZT1="",ZT2=0,ZT3=0,ZT4=0,ZTC=0
"RTN","XUTMHR",82,0)
 F  S ZT1=$O(^%ZTSCH("IO",ZT1)),ZT2=0 Q:'ZT1  F  S ZT2=$O(^%ZTSCH("IO",ZT1,ZT2)),ZT3=0 Q:'ZT2  S:'ZT4 ZT4=ZT2 F  S ZT3=$O(^%ZTSCH("IO",ZT1,ZT2,ZT3)) Q:ZT3=""  S ZTC=ZTC+1
"RTN","XUTMHR",83,0)
 S FDA(14.72,IEN,11)=ZTC,FDA(14.72,IEN,12)=ZT4
"RTN","XUTMHR",84,0)
 ;Look at the JOB list
"RTN","XUTMHR",85,0)
 S ZT1=0,ZT2=0,ZT3=0,ZTC=0
"RTN","XUTMHR",86,0)
 F  S ZT1=$O(^%ZTSCH("JOB",ZT1)),ZT2=0 Q:'ZT1  F  S ZT2=$O(^%ZTSCH("JOB",ZT1,ZT2)) Q:'ZT2  S ZTC=ZTC+1
"RTN","XUTMHR",87,0)
 ;Look at the C list
"RTN","XUTMHR",88,0)
 S ZT1="",ZT2=0,ZT3=0
"RTN","XUTMHR",89,0)
 F  S ZT1=$O(^%ZTSCH("C",ZT1)),ZT2=0 Q:ZT1=""  F  S ZT2=$O(^%ZTSCH("C",ZT1,ZT2)),ZT3=0 Q:ZT2=""  F  S ZT3=$O(^%ZTSCH("C",ZT1,ZT2,ZT3)) Q:ZT3=""  S ZTC=ZTC+1
"RTN","XUTMHR",90,0)
 S FDA(14.72,IEN,15)=ZTC
"RTN","XUTMHR",91,0)
 S FDA(14.72,IEN,16)=$$LATE($O(^%ZTSCH("JOB",1)),NOWH3)
"RTN","XUTMHR",92,0)
 ;Look at the running Task list
"RTN","XUTMHR",93,0)
 S ZT1=0,ZT2=0,ZT3=0,ZTC=0
"RTN","XUTMHR",94,0)
 F  S ZT1=$O(^%ZTSCH("TASK",ZT1)) Q:'ZT1  S ZTC=ZTC+1
"RTN","XUTMHR",95,0)
 S FDA(14.72,IEN,20)=ZTC
"RTN","XUTMHR",96,0)
 ;Look at the SUB-Managers
"RTN","XUTMHR",97,0)
 S ZT1=0,ZT2=0,ZT3=0,ZTC=0,R3=14.72201,SI=201
"RTN","XUTMHR",98,0)
 F  S ZT1=$O(^%ZTSCH("SUB",ZT1)),ZT2=0 Q:'$L(ZT1)  F  S ZT2=$O(^%ZTSCH("SUB",ZT1,ZT2)) Q:'ZT2  S X=^(ZT2) D
"RTN","XUTMHR",99,0)
 . S ZTC=ZTC+1,I3="+"_SI_","_IEN,SI=SI+1
"RTN","XUTMHR",100,0)
 . S FDA(R3,I3,.01)=ZT2,FDA(R3,I3,2)=$P(X,U),FDA(R3,I3,3)=$P(X,U,2),FDA(R3,I3,4)=$P(X,U,3),FDA(R3,I3,5)=ZT1
"RTN","XUTMHR",101,0)
 . Q
"RTN","XUTMHR",102,0)
 S FDA(14.72,IEN,19)=ZTC
"RTN","XUTMHR",103,0)
 S FDA(14.72,IEN,22)=$$ACTJ^%ZOSV() ;Total jobs
"RTN","XUTMHR",104,0)
 ;Now save the data.
"RTN","XUTMHR",105,0)
 L +^%ZIS(14.72,0):10 D UPDATE^DIE("S","FDA") L -^%ZIS(14.72,0)
"RTN","XUTMHR",106,0)
 I $D(^TMP("DIERR",$J)) D ^%ZTER
"RTN","XUTMHR",107,0)
 Q
"RTN","XUTMHR",108,0)
 ;
"RTN","XUTMHR",109,0)
LATE(T1,NOW) ;Return if a H3 time is Late
"RTN","XUTMHR",110,0)
 S:T1["," T1=$$H3^%ZTM(T1)
"RTN","XUTMHR",111,0)
 Q $S(T1<1:0,T1<NOW:NOW-T1,1:0)
"RTN","XUTMK")
0^14^B33435876
"RTN","XUTMK",1,0)
XUTMK ;SEA/RDS - Taskman: Option, ZTMCLEAN/ZTMQCLEAN ;11/1/07  14:44
"RTN","XUTMK",2,0)
 ;;8.0;KERNEL;**49,67,118,169,222,275,446**;Jul 10, 1995;Build 36
"RTN","XUTMK",3,0)
 ;
"RTN","XUTMK",4,0)
SETUP ;Setup Variables And Synchronize ^%ZTSK With ^%ZTSCH
"RTN","XUTMK",5,0)
 S ZTDTH=0
"RTN","XUTMK",6,0)
 F  S ZTDTH=$O(^%ZTSCH(ZTDTH)) Q:'ZTDTH  F ZTS=0:0 S ZTS=$O(^%ZTSCH(ZTDTH,ZTS)) Q:'ZTS  D
"RTN","XUTMK",7,0)
 . L +^%ZTSK(ZTS):2 Q:'$T  K:$D(^%ZTSK(ZTS,0))[0 ^%ZTSK(ZTS),^%ZTSCH(ZTDTH,ZTS)
"RTN","XUTMK",8,0)
 . S:$D(^%ZTSK(ZTS,0))#2 $P(^(0),U,6)=$$H0^%ZTM(ZTDTH)
"RTN","XUTMK",9,0)
 . L -^%ZTSK(ZTS) Q
"RTN","XUTMK",10,0)
 I $D(ZTKEEP)#2 G SX
"RTN","XUTMK",11,0)
 S ZTKEEP="",ZTV=^%ZOSF("VOL"),ZTI=$O(^%ZIS(14.5,"B",ZTV,""))
"RTN","XUTMK",12,0)
 I ZTI]"",$D(^%ZIS(14.5,ZTI,0))#2 S ZTKEEP=$P(^(0),U,9)
"RTN","XUTMK",13,0)
SX S:ZTKEEP="" ZTKEEP=7 S ZTKEEP=$H-ZTKEEP,ZTCNT=0,ZTMAX=100,ZTS=.9
"RTN","XUTMK",14,0)
 ;
"RTN","XUTMK",15,0)
CLEAN ;Delete Obsolete Entries
"RTN","XUTMK",16,0)
 I '(ZTCNT#20),$$S^%ZTLOAD S ZTSTOP=1 Q
"RTN","XUTMK",17,0)
 S ZTS=$O(^%ZTSK(ZTS)) I 'ZTS G FINAL
"RTN","XUTMK",18,0)
 S ZTMAX=ZTS,ZTCNT=ZTCNT+1
"RTN","XUTMK",19,0)
 L +^%ZTSK(ZTS):0 I '$T G CLEAN
"RTN","XUTMK",20,0)
 I $D(^%ZTSK(ZTS,0))[0 K ^%ZTSK(ZTS) W:'$D(ZTQUEUED) "." G NEXT
"RTN","XUTMK",21,0)
 ;
"RTN","XUTMK",22,0)
1 ;keep active tasks
"RTN","XUTMK",23,0)
 I $D(^%ZTSCH("TASK",ZTS)) G NEXT
"RTN","XUTMK",24,0)
 S ZTREC=^%ZTSK(ZTS,0),ZTDTH=$P(ZTREC,U,6) I ZTDTH="" G 2
"RTN","XUTMK",25,0)
 S:ZTDTH'["," ZTDTH=$$H0^%ZTM(ZTDTH) S ZTDTH3=$$H3^%ZTM(ZTDTH)
"RTN","XUTMK",26,0)
 I $D(^%ZTSCH(ZTDTH3,ZTS)) G NEXT
"RTN","XUTMK",27,0)
 I $D(^%ZTSCH("JOB",ZTDTH3,ZTS)) G NEXT
"RTN","XUTMK",28,0)
 S ZTCNTPU=$P(ZTREC,U,14),ZTIO=$P($G(^%ZTSK(ZTS,.2)),U,2)
"RTN","XUTMK",29,0)
 I ZTCNTPU]"",$D(^%ZTSCH("LINK",ZTCNTPU,ZTDTH3,ZTS)) G NEXT
"RTN","XUTMK",30,0)
 I ZTIO]"",$D(^%ZTSCH("IO",ZTIO,ZTDTH3,ZTS)) G NEXT
"RTN","XUTMK",31,0)
 ;
"RTN","XUTMK",32,0)
2 ;keep young inactive tasks
"RTN","XUTMK",33,0)
 S Z1=$G(^%ZTSK(ZTS,.1))
"RTN","XUTMK",34,0)
 I Z1]"",$P(Z1,U,8),$H'>$P(Z1,U,8) G NEXT ;Remember Until
"RTN","XUTMK",35,0)
 S ZTF=$S($P(Z1,U)="":0,"135AG"[$P(Z1,U):0,1:$P(Z1,U,2)'<ZTKEEP) ;Last status update
"RTN","XUTMK",36,0)
 S ZTF=$S(ZTF:ZTF,ZTDTH="":0,1:ZTDTH'<+ZTKEEP) ;Run time
"RTN","XUTMK",37,0)
 S ZTF=$S(ZTF:ZTF,$P(ZTREC,U,5)="":0,1:$P(ZTREC,U,5)'<+ZTKEEP) ;creation date
"RTN","XUTMK",38,0)
 I ZTF G NEXT
"RTN","XUTMK",39,0)
 ;
"RTN","XUTMK",40,0)
3 ;delete old inactive tasks
"RTN","XUTMK",41,0)
 K ^%ZTSK(ZTS) W:'$D(ZTQUEUED) "."
"RTN","XUTMK",42,0)
 ;
"RTN","XUTMK",43,0)
NEXT L -^%ZTSK(ZTS)
"RTN","XUTMK",44,0)
 G CLEAN
"RTN","XUTMK",45,0)
 ;
"RTN","XUTMK",46,0)
FINAL ;Final Steps.
"RTN","XUTMK",47,0)
 L +^%ZTSK(-1) ;lock top
"RTN","XUTMK",48,0)
 S $P(^%ZTSK(0),"^",3,4)=ZTMAX_"^"_ZTCNT
"RTN","XUTMK",49,0)
 I ^%ZTSK(-1)>9000000 S ^%ZTSK(-1)=100
"RTN","XUTMK",50,0)
 L -^%ZTSK(-1)
"RTN","XUTMK",51,0)
 D CLIST,TASK,SUB,CLEARIO,MONITOR
"RTN","XUTMK",52,0)
 ;Call TM error purge
"RTN","XUTMK",53,0)
 S %=$$PURGE^XUTMKE(0,ZTKEEP,"")
"RTN","XUTMK",54,0)
 ;Clear bad time
"RTN","XUTMK",55,0)
 K ^%ZTSCH(0)
"RTN","XUTMK",56,0)
 K ZT,ZTDTH,ZTF,ZTI,ZTKEEP,ZTS,ZTV
"RTN","XUTMK",57,0)
 Q
"RTN","XUTMK",58,0)
 ;
"RTN","XUTMK",59,0)
CLIST ;Clean up the C list
"RTN","XUTMK",60,0)
 S ZT1=""
"RTN","XUTMK",61,0)
 F  S ZT1=$O(^%ZTSCH("C",ZT1)),ZT2="" Q:ZT1=""  F  S ZT2=$O(^%ZTSCH("C",ZT1,ZT2)),ZT3="" Q:ZT2=""  D
"RTN","XUTMK",62,0)
 . F  S ZT3=$O(^%ZTSCH("C",ZT1,ZT2,ZT3)) Q:ZT3=""  I $D(^%ZTSK(ZT3,0))[0 K ^%ZTSCH("C",ZT1,ZT2,ZT3)
"RTN","XUTMK",63,0)
 . Q
"RTN","XUTMK",64,0)
 Q
"RTN","XUTMK",65,0)
TASK ;Clean the TASK nodes.
"RTN","XUTMK",66,0)
 N ZT1,ZT2
"RTN","XUTMK",67,0)
 F ZT1=0:0 S ZT1=$O(^%ZTSCH("TASK",ZT1)) Q:ZT1'>0  D
"RTN","XUTMK",68,0)
 . L +^%ZTSCH("TASK",ZT1):0 Q:'$T
"RTN","XUTMK",69,0)
 . S ZT2=$G(^%ZTSCH("TASK",ZT1)),$P(ZT2,U,5)=$G(^(ZT1,1))
"RTN","XUTMK",70,0)
 . L -^%ZTSCH("TASK",ZT1)
"RTN","XUTMK",71,0)
 . I ZT2="^^^^" K ^%ZTSCH("TASK",ZT1) Q
"RTN","XUTMK",72,0)
 . I $D(^%ZTSCH("TASK",ZT1,"P")) Q  ;Persistent tasks
"RTN","XUTMK",73,0)
 . I "^XMAD^"[(U_$E($P(ZT2,U,2),1,4)_U) Q
"RTN","XUTMK",74,0)
 . I $H-$P(ZT2,U,5)>4  K ^%ZTSCH("TASK",ZT1)
"RTN","XUTMK",75,0)
 . Q
"RTN","XUTMK",76,0)
 Q
"RTN","XUTMK",77,0)
 ;
"RTN","XUTMK",78,0)
SUB ;Sync the SUB nodes
"RTN","XUTMK",79,0)
 D SUBCHK^%ZTMS5($G(DILOCKTM,2))
"RTN","XUTMK",80,0)
 Q
"RTN","XUTMK",81,0)
CLEARIO ;Clear any empty IO lists
"RTN","XUTMK",82,0)
 L +^%ZTSCH("IO"):5 Q:'$T
"RTN","XUTMK",83,0)
 S ^%ZTSCH("WAIT","MGR")="XUTMK",^%ZTSCH("WAIT","SUB")="XUTMK"
"RTN","XUTMK",84,0)
 L -^%ZTSCH("IO")
"RTN","XUTMK",85,0)
 N %ZTIO,%ZTPAIR S %ZTIO="" H 10 ;Let jobs see flag
"RTN","XUTMK",86,0)
 F  S %ZTIO=$O(^%ZTSCH("IO",%ZTIO)) Q:%ZTIO=""  D
"RTN","XUTMK",87,0)
 . I $D(^%ZTSCH("IO",%ZTIO))=1 D
"RTN","XUTMK",88,0)
 . . K ^%ZTSCH("DEVTRY",%ZTIO)
"RTN","XUTMK",89,0)
 . . I $G(^%ZTSCH("IO",%ZTIO))="RES" Q  ;Leave Resource devices
"RTN","XUTMK",90,0)
 . . K ^%ZTSCH("IO",%ZTIO)
"RTN","XUTMK",91,0)
 . Q
"RTN","XUTMK",92,0)
 ;Now Clear and empty "C" lists
"RTN","XUTMK",93,0)
 S %ZTPAIR=""
"RTN","XUTMK",94,0)
 F  S %ZTPAIR=$O(^%ZTSCH("C",%ZTPAIR)) Q:%ZTPAIR=""  D
"RTN","XUTMK",95,0)
 . I $O(^%ZTSCH("C",%ZTPAIR,0))="" K ^%ZTSCH("C",%ZTPAIR)
"RTN","XUTMK",96,0)
 . Q
"RTN","XUTMK",97,0)
 K ^%ZTSCH("WAIT","MGR"),^%ZTSCH("WAIT","SUB")
"RTN","XUTMK",98,0)
 Q
"RTN","XUTMK",99,0)
 ;
"RTN","XUTMK",100,0)
MONITOR ;Move any Monitor data,
"RTN","XUTMK",101,0)
 N ZT1,ZT2,ZR,ZR2,IEN,ZFDA,X,DA,DIK
"RTN","XUTMK",102,0)
 I '($D(^%ZIS(14.71,0))#2) S ^%ZIS(14.71,0)="TASKMAN MONITOR^14.71D^"
"RTN","XUTMK",103,0)
 S ZT1="",IEN=0,ZR=$NA(^%ZTSCH("MON"))
"RTN","XUTMK",104,0)
 F  S ZT1=$O(@ZR@(ZT1)),ZT2=0 Q:ZT1=""  D
"RTN","XUTMK",105,0)
 . F  S ZT2=$O(@ZR@(ZT1,ZT2)) Q:ZT2=""  D
"RTN","XUTMK",106,0)
 . . S IEN=IEN+1,ZR2=$NA(ZFDA(14.71,"+"_IEN_","))
"RTN","XUTMK",107,0)
 . . S Y=@ZR@(ZT1,ZT2)
"RTN","XUTMK",108,0)
 . . S @ZR2@(.01)=$$HTFM^XLFDT(ZT2),@ZR2@(2)=ZT1
"RTN","XUTMK",109,0)
 . . F I=3:1:26 S @ZR2@(I)=$P(Y,U,I-2)
"RTN","XUTMK",110,0)
 . . D UPDATE^DIE("","ZFDA")
"RTN","XUTMK",111,0)
 . . K @ZR@(ZT1,ZT2),ZFDA ;Clear Global and Local.
"RTN","XUTMK",112,0)
 . . Q
"RTN","XUTMK",113,0)
 . Q
"RTN","XUTMK",114,0)
 ;Remove old data
"RTN","XUTMK",115,0)
 S ZT1=0,ZR2=$$HTFM^XLFDT($H-365)
"RTN","XUTMK",116,0)
 F  S ZT1=$O(^%ZIS(14.71,ZT1)) Q:'ZT1  S ZT2=$G(^(ZT1,0)) Q:$P(ZT2,U)>ZR2  D
"RTN","XUTMK",117,0)
 . S DA=ZT1,DIK="^%ZIS(14.71," D ^DIK
"RTN","XUTMK",118,0)
 . Q
"RTN","XUTMK",119,0)
 Q
"RTN","XUTMK",120,0)
 ;
"RTN","XUTMK",121,0)
OPTION ;Entry Point For ZTMCLEAN Option
"RTN","XUTMK",122,0)
 W !!,"This option queues a task to clean up the Task file."
"RTN","XUTMK",123,0)
 W !,"All tasks that have been inactive for a certain number of days are deleted.",!
"RTN","XUTMK",124,0)
 ;
"RTN","XUTMK",125,0)
ZTKEEP ;ask user how long to keep inactive tasks
"RTN","XUTMK",126,0)
 S DIR(0)="NA^0:365",DIR("A")="Number of days to save inactive tasks: ",DIR("B")=""
"RTN","XUTMK",127,0)
 S ZTV=^%ZOSF("VOL"),ZTI=$O(^%ZIS(14.5,"B",ZTV,""))
"RTN","XUTMK",128,0)
 I ZTI]"",$D(^%ZIS(14.5,ZTI,0))#2 S DIR("B")=$P(^(0),U,9)
"RTN","XUTMK",129,0)
 I DIR("B")="" S DIR("B")=7
"RTN","XUTMK",130,0)
 S DIR("?")="     Answer must be an integer between 0 and 365",DIR("??")="^D HELP1^XUTMK"
"RTN","XUTMK",131,0)
 D ^DIR W:$D(DTOUT) $C(7)
"RTN","XUTMK",132,0)
 K DIR,DIRUT,DTOUT,DUOUT,ZTI,ZTV
"RTN","XUTMK",133,0)
 I Y'=0&'Y K %,X,Y D NOTQED Q
"RTN","XUTMK",134,0)
 S ZTKEEP=Y
"RTN","XUTMK",135,0)
 ;
"RTN","XUTMK",136,0)
ZTDTH ;ask user when to start the cleanup
"RTN","XUTMK",137,0)
 S DIR(0)="DA^::AERSX",DIR("A")="Start time for cleanup task: ",DIR("B")="NOW"
"RTN","XUTMK",138,0)
 S DIR("?")="     Answer must be a date and time",DIR("??")="^D HELP2^XUTMK"
"RTN","XUTMK",139,0)
 D ^DIR W:$D(DTOUT) $C(7)
"RTN","XUTMK",140,0)
 K DIR,DIRUT,DTOUT,DUOUT
"RTN","XUTMK",141,0)
 I 'Y K %,X,Y D NOTQED Q
"RTN","XUTMK",142,0)
 S ZTDTH=Y
"RTN","XUTMK",143,0)
 ;
"RTN","XUTMK",144,0)
QUEUE ;queue the cleanup task
"RTN","XUTMK",145,0)
 S ZTRTN="XUTMK",ZTIO="",ZTDESC="TaskMan: clean the Task file",ZTSAVE("ZTKEEP")=""
"RTN","XUTMK",146,0)
 D ^%ZTLOAD
"RTN","XUTMK",147,0)
 W !!?5,"Task file cleanup queued!" H 1
"RTN","XUTMK",148,0)
 K ZTSK Q
"RTN","XUTMK",149,0)
 ;
"RTN","XUTMK",150,0)
HELP1 ;ZTKEEP--?? help for first prompt
"RTN","XUTMK",151,0)
 W !!?5,"Answer how many days inactive tasks should be kept."
"RTN","XUTMK",152,0)
 W !?5,"Any task currently scheduled, waiting, or running is still active."
"RTN","XUTMK",153,0)
 Q
"RTN","XUTMK",154,0)
 ;
"RTN","XUTMK",155,0)
HELP2 ;ZTDTH--?? help for second prompt
"RTN","XUTMK",156,0)
 W !!?5,"Answer exactly when the task should begin the cleanup."
"RTN","XUTMK",157,0)
 Q
"RTN","XUTMK",158,0)
 ;
"RTN","XUTMK",159,0)
NOTQED ;OPTION--feedback when task is canceled
"RTN","XUTMK",160,0)
 W !!?5,"Task file cleanup NOT queued!" H 1
"RTN","XUTMK",161,0)
 Q
"RTN","XUTMK",162,0)
 ;
"RTN","ZTLOAD1")
0^19^B24362203
"RTN","ZTLOAD1",1,0)
%ZTLOAD1 ;SEA/RDS-TaskMan: P I: Queue ;09/23/08  10:06
"RTN","ZTLOAD1",2,0)
 ;;8.0;KERNEL;**112,118,127,162,275,363,409,415,425,446**;Jul 10, 1995;Build 36
"RTN","ZTLOAD1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTLOAD1",4,0)
 ;
"RTN","ZTLOAD1",5,0)
GET ;get task data
"RTN","ZTLOAD1",6,0)
 N %X,%Y,X,Y,X1,ZT,ZTC1,ZTC2,ZTA1,ZTA4,ZTA5,ZTINC,ZTGOT,ZTC34P
"RTN","ZTLOAD1",7,0)
 K %ZTLOAD
"RTN","ZTLOAD1",8,0)
 I ("^"[$G(ZTRTN))!($L($G(ZTRTN),"^")>2) D REJECT^%ZTLOAD2("Bad Routine") G EXIT
"RTN","ZTLOAD1",9,0)
 S U="^" I ZTRTN'[U S ZTRTN=U_ZTRTN
"RTN","ZTLOAD1",10,0)
 S ZTC1=+$G(DUZ),ZTC2=""
"RTN","ZTLOAD1",11,0)
 I ZTC1>0 S ZTC2=$P($G(^VA(200,ZTC1,0)),U)
"RTN","ZTLOAD1",12,0)
 ;Check Date/Time
"RTN","ZTLOAD1",13,0)
1 I $D(ZTDTH)[0 S ZTDTH=""
"RTN","ZTLOAD1",14,0)
 I ZTDTH?7N.".".N S ZTDTH=$$FMTH^%ZTLOAD7(ZTDTH)
"RTN","ZTLOAD1",15,0)
 I $P($G(XQY0),U,18) D RESTRCT^%ZTLOAD2
"RTN","ZTLOAD1",16,0)
 I ZTDTH'="@",ZTDTH'?1.5N1","1.5N D ASK^%ZTLOAD2 I ZTDTH'>0 D REJECT^%ZTLOAD2("Bad Date/Time") G EXIT
"RTN","ZTLOAD1",17,0)
 ;
"RTN","ZTLOAD1",18,0)
 S ZTA1="R",ZTA4="",ZTA5=""
"RTN","ZTLOAD1",19,0)
 I ZTRTN="ZTSK^XQ1" D OPTION^%ZTLOAD2 I ZTA1="" D REJECT^%ZTLOAD2("Bad Option") G EXIT
"RTN","ZTLOAD1",20,0)
 I ZTA1="R" D
"RTN","ZTLOAD1",21,0)
 . S ZTSAVE("XQY")="",ZTSAVE("XQY0")="",ZTA4=$G(XQY),ZTA5=$P($G(XQY0),U)
"RTN","ZTLOAD1",22,0)
 ;
"RTN","ZTLOAD1",23,0)
 D GETENV^%ZOSV S ZTC34P=Y
"RTN","ZTLOAD1",24,0)
 ;Description
"RTN","ZTLOAD1",25,0)
2 I $D(ZTDESC)[0 S ZTDESC="No Description (%ZTLOAD)"
"RTN","ZTLOAD1",26,0)
 ;
"RTN","ZTLOAD1",27,0)
 I $G(ZTKIL)]"" D ZTKIL^%ZTLOAD2
"RTN","ZTLOAD1",28,0)
 S:$G(ZTUCI)["," ZTUCI=$P(ZTUCI,",") S:$G(ZTCPU)["," ZTCPU=$P(ZTCPU,",",2)
"RTN","ZTLOAD1",29,0)
DEVICE ;get device data
"RTN","ZTLOAD1",30,0)
 I $D(ZTIO)#2,$G(ION)=$P(ZTIO,";"),$G(IOT)="SPL" D SPOOL^%ZTLOAD2
"RTN","ZTLOAD1",31,0)
 ;If no ZTIO, build from symbol table
"RTN","ZTLOAD1",32,0)
 I $D(ZTIO)[0 S ZTIO=$G(ION) I $L(ZTIO) D
"RTN","ZTLOAD1",33,0)
 . S:$G(IOST)]"" $P(ZTIO,";",2)=IOST
"RTN","ZTLOAD1",34,0)
 . I $G(IO("DOC"))]"" S ZTIO=ZTIO_";"_IO("DOC")
"RTN","ZTLOAD1",35,0)
 . E  I $G(IOM)]"" S ZTIO=ZTIO_";"_IOM I $G(IOSL)]"" S ZTIO=ZTIO_";"_IOSL
"RTN","ZTLOAD1",36,0)
 . Q
"RTN","ZTLOAD1",37,0)
 ;
"RTN","ZTLOAD1",38,0)
 I $E(ZTIO,1)="`" S $P(ZTIO,";")=$P(^%ZIS(1,+$E(ZTIO,2,99),0),"^") ;Convert `IEN format
"RTN","ZTLOAD1",39,0)
 S ZTIO(1)=$S($G(ZTIO(1))'="D":"Q",1:"DIRECT")
"RTN","ZTLOAD1",40,0)
 I $L(ZTIO) D  ;Skip if no device
"RTN","ZTLOAD1",41,0)
 . ;IO("HFSIO") and IOPAR are how %ZIS reports the user selected file name and parameters
"RTN","ZTLOAD1",42,0)
 . S:'$D(ZTIO("H")) ZTIO("H")=$G(IO("HFSIO"))
"RTN","ZTLOAD1",43,0)
 . S:'$D(ZTIO("P")) ZTIO("P")=$G(IOPAR)
"RTN","ZTLOAD1",44,0)
 . I $G(IO("P"))]"",ZTIO'[";/" S ZTIO=ZTIO_";/"_IO("P")
"RTN","ZTLOAD1",45,0)
 . I $$NOQ^%ZISUTL($P(ZTIO,";")) D BADDEV^%ZTLOAD2("Restricted Device")
"RTN","ZTLOAD1",46,0)
 . I $E(ZTIO,1,9)="P-MESSAGE" S ZTSAVE("^TMP(""XM-MESS"",$J,")=""
"RTN","ZTLOAD1",47,0)
 . Q
"RTN","ZTLOAD1",48,0)
 ;
"RTN","ZTLOAD1",49,0)
 I $D(%ZTLOAD("ERROR")) G EXIT
"RTN","ZTLOAD1",50,0)
 ;
"RTN","ZTLOAD1",51,0)
 ;See that ^%ZTSK(-1) is set
"RTN","ZTLOAD1",52,0)
 I $D(^%ZTSK(-1))[0 S ^%ZTSK(-1)=$S($P($G(^%ZTSK(0)),U,3):$P(^(0),U,3),1:1000)
"RTN","ZTLOAD1",53,0)
RECORD ;build record
"RTN","ZTLOAD1",54,0)
 S ZTINC=$G(^%ZOSF("$INC"),1) ;Set to 1 if this system has $INCREMENT, otherwise 0.
"RTN","ZTLOAD1",55,0)
 S ZTGOT=0
"RTN","ZTLOAD1",56,0)
 I 'ZTINC D  ;For System that don't have $INC (GT.M, DTM, MSM)
"RTN","ZTLOAD1",57,0)
 . ;Find a free entry, Claim it and Lock it.
"RTN","ZTLOAD1",58,0)
 . L +^%ZTSK(-1):0 S ZTSK=^%ZTSK(-1) ;This is just a starting point
"RTN","ZTLOAD1",59,0)
 . F  S ZTSK=ZTSK+1 I '$D(^%ZTSK(ZTSK)) D  Q:ZTGOT
"RTN","ZTLOAD1",60,0)
 . . L +^%ZTSK(ZTSK):$G(DILOCKTM,3) Q:'$T  ;Can we lock it
"RTN","ZTLOAD1",61,0)
 . . I $D(^%ZTSK(ZTSK)) L -^%ZTSK(ZTSK) ;Already claimed
"RTN","ZTLOAD1",62,0)
 . . S ^%ZTSK(ZTSK,.1)=0,^%ZTSK(-1)=ZTSK,ZTGOT=1 ;Claim it
"RTN","ZTLOAD1",63,0)
 . . Q
"RTN","ZTLOAD1",64,0)
 . L -^%ZTSK(-1) ;
"RTN","ZTLOAD1",65,0)
 . Q
"RTN","ZTLOAD1",66,0)
 I ZTINC D  ;For DSM and OpenM. Faster over network(DDP)
"RTN","ZTLOAD1",67,0)
 . S ZTSK=$INCREMENT(^%ZTSK(-1))
"RTN","ZTLOAD1",68,0)
 . L +^%ZTSK(ZTSK):$G(DILOCKTM,3) S ZTGOT=$T ;p446
"RTN","ZTLOAD1",69,0)
 I 'ZTGOT!($D(^%ZTSK(ZTSK,0))) L -^%ZTSK(ZTSK) G RECORD
"RTN","ZTLOAD1",70,0)
 TSTART  ;
"RTN","ZTLOAD1",71,0)
 S ^%ZTSK(ZTSK,0)=ZTRTN_U_ZTC1_U_$G(ZTUCI)_U_$H_U_ZTDTH_U_ZTA1_U_ZTA4_U_ZTA5_U_ZTC2_U_$P(ZTC34P,U,1,2)_U_"ZTDESC"_U_$G(ZTCPU)_U_$G(ZTPRI)
"RTN","ZTLOAD1",72,0)
 S ^%ZTSK(ZTSK,.1)=0,^%ZTSK(ZTSK,.03)=ZTDESC
"RTN","ZTLOAD1",73,0)
 S ^%ZTSK(ZTSK,.2)=ZTIO_"^^^^"_ZTIO(1)_U_$G(ZTIO("H")) S:$D(ZTSYNC) $P(^%ZTSK(ZTSK,.2),U,7)=ZTSYNC
"RTN","ZTLOAD1",74,0)
 I $G(ZTIO("P"))]"" S ^%ZTSK(ZTSK,.25)=ZTIO("P")
"RTN","ZTLOAD1",75,0)
 ;
"RTN","ZTLOAD1",76,0)
 D ZTSAVE
"RTN","ZTLOAD1",77,0)
 ;
"RTN","ZTLOAD1",78,0)
SCHED ;schedule task and quit
"RTN","ZTLOAD1",79,0)
 S ZTSTAT=$S(ZTDTH'="@":1,1:"K")_"^"_$H,$P(ZTSTAT,U,8)=$G(ZTKIL)
"RTN","ZTLOAD1",80,0)
 S ^%ZTSK(ZTSK,.1)=ZTSTAT
"RTN","ZTLOAD1",81,0)
 I ZTDTH'="@" L +^%ZTSCH("SCHQ"):$G(DILOCKTM,3) S ZT=$$H3(ZTDTH),^%ZTSK(ZTSK,.04)=ZT,^%ZTSCH(ZT,ZTSK)="" L -^%ZTSCH("SCHQ")
"RTN","ZTLOAD1",82,0)
 L -^%ZTSK(ZTSK) S ZTSK("D")=ZTDTH
"RTN","ZTLOAD1",83,0)
 TCOMMIT  ;
"RTN","ZTLOAD1",84,0)
EXIT ;Clean up
"RTN","ZTLOAD1",85,0)
 I $E($G(ZTIO),1,9)="P-MESSAGE" K ^TMP("XM-MESS",$J) ;Clean up the Global
"RTN","ZTLOAD1",86,0)
 K X1,ZT,ZT1,ZTDTH,ZTKIL,ZTSAVE,ZTSTAT,ZTIO
"RTN","ZTLOAD1",87,0)
 Q
"RTN","ZTLOAD1",88,0)
 ;
"RTN","ZTLOAD1",89,0)
ZTSAVE ;save variables
"RTN","ZTLOAD1",90,0)
 N ZTIO
"RTN","ZTLOAD1",91,0)
 K %H,%T,ZTA1,ZTA4,ZTA5,ZTC1,ZTC2,ZTC34P,ZTCPU,ZTDESC,ZTIO,ZTNOGO,ZTPRI,ZTRTN,ZTUCI,ZTSYNC
"RTN","ZTLOAD1",92,0)
 S ZTSAVE("DUZ(")=""
"RTN","ZTLOAD1",93,0)
 S ZT1="" F  S ZT1=$O(ZTSAVE(ZT1)) Q:ZT1=""  D EVAL
"RTN","ZTLOAD1",94,0)
 K ^%ZTSK(ZTSK,.3,"DUZ(","NEWCODE")
"RTN","ZTLOAD1",95,0)
 K ^%ZTSK(ZTSK,.3,"ZTSK"),^("ZTSAVE"),^("ZTDTH")
"RTN","ZTLOAD1",96,0)
 K ^%ZTSK(ZTSK,.3,"XQNOGO")
"RTN","ZTLOAD1",97,0)
 Q
"RTN","ZTLOAD1",98,0)
 ;
"RTN","ZTLOAD1",99,0)
EVAL ;ZTSAVE--evaluate expression
"RTN","ZTLOAD1",100,0)
 I ZT1="*" S X="^%ZTSK(ZTSK,.3," D DOLRO^%ZOSV Q
"RTN","ZTLOAD1",101,0)
 I ZT1["*",$P(ZT1,"*")'["(" S X="^%ZTSK(ZTSK,.3,",Y=ZT1 D ORDER^%ZOSV Q
"RTN","ZTLOAD1",102,0)
 I $S($E(ZT1)="""":1,+ZT1'=ZT1:0,1:ZT1]0),$D(ZTSAVE(ZT1))#2 S @("^%ZTSK(ZTSK,"_ZT1_")=ZTSAVE(ZT1)") Q
"RTN","ZTLOAD1",103,0)
 I $S(ZT1'["(":1,1:$E(ZT1,$L(ZT1))=")"),$S($D(@ZT1)#2:1,1:ZTSAVE(ZT1)]"") S ^%ZTSK(ZTSK,.3,ZT1)=$S(ZTSAVE(ZT1)]"":ZTSAVE(ZT1),1:@ZT1) Q
"RTN","ZTLOAD1",104,0)
 I $E(ZT1)="^",ZT1["(" S %X=ZT1,%Y="^%ZTSK(ZTSK,.3,ZT1," D %XY^%RCR Q
"RTN","ZTLOAD1",105,0)
 I ZT1["(" S %X=ZT1,%Y="^%ZTSK(ZTSK,.3,ZT1," D %XY^%RCR
"RTN","ZTLOAD1",106,0)
 ;I ZT1["(" M ^%ZTSK(ZTSK,.3,ZT1)=@$P(ZT1,"(")
"RTN","ZTLOAD1",107,0)
 Q
"RTN","ZTLOAD1",108,0)
 ;
"RTN","ZTLOAD1",109,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTLOAD1",110,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTLOAD1",111,0)
H0(%) ;Covert from seconds to $H
"RTN","ZTLOAD1",112,0)
 Q (%\86400)_","_(%#86400)
"RTN","ZTLOAD2")
0^20^B9668980
"RTN","ZTLOAD2",1,0)
%ZTLOAD2 ;SEA/RDS-TaskMan:  Queue, Part 2 ;12/10/08  07:23
"RTN","ZTLOAD2",2,0)
 ;;8.0;KERNEL;**1,67,118,275,339,446**;Jul 10, 1995;Build 36
"RTN","ZTLOAD2",3,0)
 ;
"RTN","ZTLOAD2",4,0)
REJECT(MSG) ;GET--reject bad task
"RTN","ZTLOAD2",5,0)
 I '$D(ZTQUEUED) W !,"QUEUE INFORMATION MISSING - NOT QUEUED",!,MSG
"RTN","ZTLOAD2",6,0)
 G EXIT
"RTN","ZTLOAD2",7,0)
 ;
"RTN","ZTLOAD2",8,0)
BADDEV(MSG) ;GET--Reject task because of device issue.
"RTN","ZTLOAD2",9,0)
 I '$D(ZTQUEUED) W !,"Queueing not allowed to device -- NOT QUEUED",!,MSG
"RTN","ZTLOAD2",10,0)
EXIT ;Report back to app.
"RTN","ZTLOAD2",11,0)
 S %ZTLOAD("ERROR")=MSG
"RTN","ZTLOAD2",12,0)
 Q
"RTN","ZTLOAD2",13,0)
 ;
"RTN","ZTLOAD2",14,0)
RESTRCT ;GET--flag tasks with output restricted from certain times; check.
"RTN","ZTLOAD2",15,0)
 I $D(ZTQUEUED) Q
"RTN","ZTLOAD2",16,0)
 S ZTNOGO=0
"RTN","ZTLOAD2",17,0)
 I ZTDTH="@" Q
"RTN","ZTLOAD2",18,0)
 I ZTDTH'?1.5N1","1.5N Q
"RTN","ZTLOAD2",19,0)
 S X=$$HTFM^%ZTLOAD7(ZTDTH) D ^XQ92 I X="" S ZTDTH="" W !,"Sorry--that time is restricted!",!,$C(7)
"RTN","ZTLOAD2",20,0)
 Q
"RTN","ZTLOAD2",21,0)
 ;
"RTN","ZTLOAD2",22,0)
ASK ;GET--ask for start time
"RTN","ZTLOAD2",23,0)
 N %DT,Y
"RTN","ZTLOAD2",24,0)
 I $D(ZTQUEUED) D:ZTDTH]""  Q
"RTN","ZTLOAD2",25,0)
 . S %DT="FRS",X=ZTDTH D ^%DT
"RTN","ZTLOAD2",26,0)
 . S ZTDTH=$$FMTH^%ZTLOAD7(+Y) I Y'>0 S ZTDTH=""
"RTN","ZTLOAD2",27,0)
 . Q
"RTN","ZTLOAD2",28,0)
 S ZTDTH="",%DT="AERSX",%DT("A")="Requested Start Time: ",%DT("B")="NOW",%DT(0)="NOW"
"RTN","ZTLOAD2",29,0)
 I $D(ZTNOGO) D  I X="" Q
"RTN","ZTLOAD2",30,0)
 . S Y=+XQY D NEXT^XQ92 I X="" W !,"Output is never allowed from this option!",$C(7),$C(7) Q
"RTN","ZTLOAD2",31,0)
 . S %DT("B")=$$FMTE^%ZTLOAD7(X),%DT="AERSX"
"RTN","ZTLOAD2",32,0)
 . Q
"RTN","ZTLOAD2",33,0)
 I $D(ZTNOGO),'$D(XQNOGO) W !,"Output from this option is restricted during certain times."
"RTN","ZTLOAD2",34,0)
 F ZT=0:0 D ^%DT Q:(Y<0)!'$D(ZTNOGO)  S ZT=Y,X=Y D ^XQ92 S Y=ZT Q:X]""  W !!,"That is a restricted time!",!,$C(7)
"RTN","ZTLOAD2",35,0)
 S:Y>0 ZTDTH=$$FMTH^%ZTLOAD7(+Y)
"RTN","ZTLOAD2",36,0)
 K %DT,%T,X5,ZT
"RTN","ZTLOAD2",37,0)
 Q
"RTN","ZTLOAD2",38,0)
 ;
"RTN","ZTLOAD2",39,0)
OPTION ;GET--get option data
"RTN","ZTLOAD2",40,0)
 S ZTA4=$G(ZTSAVE("XQY")) I 'ZTA4 S ZTA4=$G(XQY) I 'ZTA4 S ZTA4=""
"RTN","ZTLOAD2",41,0)
 S ZTA1="O" I 'ZTA4 S ZTA1="" Q
"RTN","ZTLOAD2",42,0)
 S ZTA5=$P($G(^DIC(19,ZTA4,0)),U)
"RTN","ZTLOAD2",43,0)
 Q
"RTN","ZTLOAD2",44,0)
 ;
"RTN","ZTLOAD2",45,0)
ZTKIL ;GET--convert forget time
"RTN","ZTLOAD2",46,0)
 S ZTKIL=$S(ZTKIL?5N:ZTKIL,ZTKIL?5N1","1.5N:ZTKIL,ZTKIL?7N.".".N:$$FMTH^%ZTLOAD7(ZTKIL),1:"")
"RTN","ZTLOAD2",47,0)
 Q
"RTN","ZTLOAD2",48,0)
 ;
"RTN","ZTLOAD2",49,0)
SPOOL ;DEVICE--for predefined ZTIO spool device, pick up IO("DOC") if missing
"RTN","ZTLOAD2",50,0)
 I $G(IO("DOC"))="" Q
"RTN","ZTLOAD2",51,0)
 I ZTIO[IO("DOC") Q
"RTN","ZTLOAD2",52,0)
 I $P(ZTIO,";",2)?.N D
"RTN","ZTLOAD2",53,0)
 .S ZTIO=$P(ZTIO,";")_";"_IO("DOC")_";"_$P(ZTIO,";",2,999)
"RTN","ZTLOAD2",54,0)
 E  I $P(ZTIO,";",2)?1.2A1"-"1.ANP,$P(ZTIO,";",3)?.N D
"RTN","ZTLOAD2",55,0)
 .S ZTIO=$P(ZTIO,";",1,2)_";"_IO("DOC")_";"_$P(ZTIO,";",3,999)
"RTN","ZTLOAD2",56,0)
 Q
"RTN","ZTLOAD2",57,0)
 ;
"RTN","ZTLOAD2",58,0)
ASKSTOP ;e.f. Called from ASKSTOP^%ZTLOAD
"RTN","ZTLOAD2",59,0)
 ;Ask a task to stop. Unschedule if not started.
"RTN","ZTLOAD2",60,0)
 N % S ZTSK=+$G(ZTSK) I ZTSK<1 Q "0^BAD TASK NUMBER"
"RTN","ZTLOAD2",61,0)
 L +^%ZTSK(ZTSK):10 I '$T Q "0^Busy"
"RTN","ZTLOAD2",62,0)
 S %=$$AKS
"RTN","ZTLOAD2",63,0)
 L -^%ZTSK(ZTSK)
"RTN","ZTLOAD2",64,0)
 Q %
"RTN","ZTLOAD2",65,0)
 ;
"RTN","ZTLOAD2",66,0)
AKS() ;Locked before called
"RTN","ZTLOAD2",67,0)
 N ZT1,ZT2,ZTDTH,%ZTIO
"RTN","ZTLOAD2",68,0)
 S ZTSK(0)=$G(^%ZTSK(ZTSK,0)),ZTSK(.1)=$G(^(.1))
"RTN","ZTLOAD2",69,0)
 I ZTSK(0)="" Q "1^Task missing"
"RTN","ZTLOAD2",70,0)
 S $P(^%ZTSK(ZTSK,.1),U,10)=$S($D(ZTNAME)#2:ZTNAME,1:$G(DUZ,.5))
"RTN","ZTLOAD2",71,0)
 I +ZTSK(.1)=6 Q "1^Finished running"
"RTN","ZTLOAD2",72,0)
 I +ZTSK(.1)=5 Q "2^Asked to stop"
"RTN","ZTLOAD2",73,0)
 S ZTDTH=$$H3^%ZTM($P(ZTSK(0),U,6))
"RTN","ZTLOAD2",74,0)
 K ^%ZTSCH(ZTDTH,ZTSK) ;Remove from schedule
"RTN","ZTLOAD2",75,0)
 S %ZTIO=$O(^%ZTSK(ZTSK,.26,"")) I %ZTIO]"" D DQ^%ZTM4 ;Remove from device lists.
"RTN","ZTLOAD2",76,0)
 Q "2^Unscheduled"
"RTN","ZTLOAD3")
0^21^B10890458
"RTN","ZTLOAD3",1,0)
%ZTLOAD3 ;SEA/RDS - TaskMan: Task Requeue ;07/29/08  11:46
"RTN","ZTLOAD3",2,0)
 ;;8.0;KERNEL;**67,127,136,192,446**;JUL 10, 1995;Build 36
"RTN","ZTLOAD3",3,0)
 ;
"RTN","ZTLOAD3",4,0)
INPUT ;check for error conditions
"RTN","ZTLOAD3",5,0)
 N %H,%T,X,X1,Y,ZT,ZT1,ZT2,ZT3,ZTH,ZTL,ZTOS,ZTREC,ZTREC1,ZTREC2,ZTREC25
"RTN","ZTLOAD3",6,0)
 S ZTSK=$G(ZTSK) K ZTSK(0),ZTREQ ;Kill ZTREQ so we don't kill the entry
"RTN","ZTLOAD3",7,0)
 L +^%ZTSK(ZTSK):9 S ZTREC=$G(^%ZTSK(ZTSK,0)) I ZTREC="" G BAD
"RTN","ZTLOAD3",8,0)
 I $D(ZTDTH)#2,ZTDTH]"",ZTDTH'?1.5N1","1.5N,ZTDTH'?7N.".".N,ZTDTH'="@","SHD"'[$E(ZTDTH,$L(ZTDTH)) G BAD
"RTN","ZTLOAD3",9,0)
 ;
"RTN","ZTLOAD3",10,0)
DQ ;make sure task is not pending
"RTN","ZTLOAD3",11,0)
 D UNSCH^%ZTLOAD6
"RTN","ZTLOAD3",12,0)
 I $D(^%ZTSK(ZTSK,0))[0 G BAD
"RTN","ZTLOAD3",13,0)
 ;
"RTN","ZTLOAD3",14,0)
ZTDTH ;determine task's next start time
"RTN","ZTLOAD3",15,0)
 S:$P(ZTREC,"^",16)="" $P(ZTREC,"^",16)=$P(ZTREC,"^",5) ;Save original create time
"RTN","ZTLOAD3",16,0)
 S $P(ZTREC,"^",5)=$H ;Set a new create time
"RTN","ZTLOAD3",17,0)
 I $D(ZTDTH)[0 S ZTDTH=$P(ZTREC,"^",6) G ZTRTN ;Use original time.
"RTN","ZTLOAD3",18,0)
 I ZTDTH="" S ZTDTH=$H G ZTRTN
"RTN","ZTLOAD3",19,0)
 I ZTDTH?1.5N1","1.5N G ZTRTN
"RTN","ZTLOAD3",20,0)
 I ZTDTH?7N.".".N S ZTDTH=$$FMTH^%ZTLOAD7(ZTDTH) G ZTRTN
"RTN","ZTLOAD3",21,0)
 I ZTDTH="@" G ZTRTN
"RTN","ZTLOAD3",22,0)
 S ZTH=$$H3^%ZTM($P(ZTREC,"^",6)),ZTL=$E(ZTDTH,$L(ZTDTH)) ;From start time
"RTN","ZTLOAD3",23,0)
DT I ZTL="S" S ZTH=ZTH+ZTDTH
"RTN","ZTLOAD3",24,0)
 I ZTL="H" S ZTH=(ZTDTH*3600)+ZTH
"RTN","ZTLOAD3",25,0)
 I ZTL="D" S ZTH=(ZTDTH*86400)+ZTH
"RTN","ZTLOAD3",26,0)
DTX I ZTH<$$H3^%ZTM($H) G DT
"RTN","ZTLOAD3",27,0)
 S ZTDTH=$$H0^%ZTM(ZTH)
"RTN","ZTLOAD3",28,0)
 ;
"RTN","ZTLOAD3",29,0)
ZTRTN ;determine whether entry point should change
"RTN","ZTLOAD3",30,0)
 I $D(ZTRTN)[0 G ZTIO
"RTN","ZTLOAD3",31,0)
 I ZTRTN="" G ZTIO
"RTN","ZTLOAD3",32,0)
 I ZTRTN'[U S ZTRTN=U_ZTRTN
"RTN","ZTLOAD3",33,0)
 S ZT=$P(ZTREC,U,1,2)
"RTN","ZTLOAD3",34,0)
 I ZT'=ZTRTN S $P(ZTREC,U,1,2)=ZTRTN I ZT="ZTSK^XQ1" S $P(ZTREC,U,7,9)="R^^"
"RTN","ZTLOAD3",35,0)
 ;
"RTN","ZTLOAD3",36,0)
ZTIO ;determine whether i/o device should change
"RTN","ZTLOAD3",37,0)
 N ZTREC2,ZTREC25
"RTN","ZTLOAD3",38,0)
 S ZTREC2=$G(^%ZTSK(ZTSK,.2)),ZT=$P(ZTREC2,U)
"RTN","ZTLOAD3",39,0)
 I $D(ZTIO)[0 G ZTIO1
"RTN","ZTLOAD3",40,0)
 I ZTIO="" G ZTIO1
"RTN","ZTLOAD3",41,0)
 I $P(ZTIO,";")'=$P(ZT,";") S $P(ZTREC2,U,6)="",ZTREC25=""
"RTN","ZTLOAD3",42,0)
 I ZTIO="@" S $P(ZTREC2,U)="" G ZTIO1
"RTN","ZTLOAD3",43,0)
 I ZTIO'=ZT S $P(ZTREC2,U)=ZTIO
"RTN","ZTLOAD3",44,0)
 ;
"RTN","ZTLOAD3",45,0)
ZTIO1 ;set hunt group suppression flag
"RTN","ZTLOAD3",46,0)
 S $P(ZTREC2,U,5)=$S($D(ZTIO(1))[0:"",ZTIO(1)="D":"DIRECT",1:"")
"RTN","ZTLOAD3",47,0)
 ;
"RTN","ZTLOAD3",48,0)
ZTDESC ;determine whether description should change
"RTN","ZTLOAD3",49,0)
 I $S($D(ZTDESC)[0:1,ZTDESC="":1,1:0) S ZTDESC=$G(^%ZTSK(ZTSK,.03))
"RTN","ZTLOAD3",50,0)
 I ZTDESC=""!(ZTDESC="No Description (%ZTLOAD)") S ZTDESC="No Description (REQ~%ZTLOAD)"
"RTN","ZTLOAD3",51,0)
 S ^%ZTSK(ZTSK,.03)=ZTDESC
"RTN","ZTLOAD3",52,0)
 ;
"RTN","ZTLOAD3",53,0)
RECORD ;record changes in Task File entry
"RTN","ZTLOAD3",54,0)
 I $D(ZTREC2)#2 S ^%ZTSK(ZTSK,.2)=ZTREC2
"RTN","ZTLOAD3",55,0)
 I $D(ZTREC25)#2 S ^%ZTSK(ZTSK,.25)=ZTREC25
"RTN","ZTLOAD3",56,0)
 I ZTDTH'="@" S $P(ZTREC,U,6)=ZTDTH ;Reset the Scheduled time piece
"RTN","ZTLOAD3",57,0)
 S ^%ZTSK(ZTSK,0)=ZTREC
"RTN","ZTLOAD3",58,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,3)=$S(ZTDTH'="@":"1^"_$H_"^REQUEUED",1:"H^"_$H_"^EDITED BUT NOT REQUEUED")
"RTN","ZTLOAD3",59,0)
 ;
"RTN","ZTLOAD3",60,0)
ZTSAVE ;See if new data to save
"RTN","ZTLOAD3",61,0)
 K %H,%T,X,X1,Y,ZT,ZT1,ZT2,ZT3,ZTH,ZTL,ZTOS,ZTREC,ZTREC1,ZTREC2,ZTREC25
"RTN","ZTLOAD3",62,0)
 K ZTDESC,ZTIO,ZTRTN
"RTN","ZTLOAD3",63,0)
 I $D(ZTSAVE) K:$G(ZTSAVE)="KILL" ^%ZTSK(ZTSK,.3) D ZTSAVE^%ZTLOAD1
"RTN","ZTLOAD3",64,0)
SCHED ;schedule task, cleanup, quit
"RTN","ZTLOAD3",65,0)
 I ZTDTH'="@" L +^%ZTSCH("SCHQ"):6 S ZT=$$H3^%ZTLOAD1(ZTDTH),^%ZTSK(ZTSK,.04)=ZT,^%ZTSCH(ZT,ZTSK)="" L -^%ZTSCH("SCHQ")
"RTN","ZTLOAD3",66,0)
 K %X,%Y,X,X1,Y,ZT1,ZT2,ZT3,ZTDTH,ZTSAVE
"RTN","ZTLOAD3",67,0)
 L -^%ZTSK(ZTSK) S ZTSK(0)=1
"RTN","ZTLOAD3",68,0)
 Q
"RTN","ZTLOAD3",69,0)
 ;
"RTN","ZTLOAD3",70,0)
BAD L -^%ZTSK(ZTSK) S ZTSK(0)=0
"RTN","ZTLOAD3",71,0)
 Q
"RTN","ZTLOAD3",72,0)
REQP(ZT1) ;Reschedule a persistent task. Called from ZTM
"RTN","ZTLOAD3",73,0)
 N ZTSK,ZT2,ZT3,ZTDTH,ZTSAVE S ZTDTH=$H,ZTSK=ZT1
"RTN","ZTLOAD3",74,0)
 L +^%ZTSK(ZTSK):20 Q:'$T
"RTN","ZTLOAD3",75,0)
 I $D(^%ZTSK(ZTSK,0))[0 Q  ;Should tell someone
"RTN","ZTLOAD3",76,0)
 G SCHED
"RTN","ZTLOAD5")
0^7^B11826383
"RTN","ZTLOAD5",1,0)
%ZTLOAD5 ;SEA/RDS-TaskMan: P I: Task Status ;1/18/08  14:29
"RTN","ZTLOAD5",2,0)
 ;;8.0;KERNEL;**49,339,446**;JUL 10, 1995;Build 36
"RTN","ZTLOAD5",3,0)
 ;
"RTN","ZTLOAD5",4,0)
INPUT ;check input parameters for error conditions
"RTN","ZTLOAD5",5,0)
 N %,ZT1,ZT2,ZT3
"RTN","ZTLOAD5",6,0)
 S:$D(ZTSK)[0 ZTSK=""
"RTN","ZTLOAD5",7,0)
 I $D(ZTSK)>1 S %=ZTSK K ZTSK S ZTSK=%
"RTN","ZTLOAD5",8,0)
 S ZTSK(0)=0,ZTSK(1)=0,ZTSK(2)="Undefined"
"RTN","ZTLOAD5",9,0)
 I ZTSK<1!('$D(^%ZTSK(ZTSK,0))) Q
"RTN","ZTLOAD5",10,0)
 L +^%ZTSK(ZTSK):5 E  S ZTSK(2)="Busy" Q  ;p446
"RTN","ZTLOAD5",11,0)
 D SEARCH L -^%ZTSK(ZTSK)
"RTN","ZTLOAD5",12,0)
 Q
"RTN","ZTLOAD5",13,0)
 ;
"RTN","ZTLOAD5",14,0)
SEARCH ;search ^%ZTSCH for task
"RTN","ZTLOAD5",15,0)
 I $D(^%ZTSCH("TASK",ZTSK))#2 D  Q
"RTN","ZTLOAD5",16,0)
 . S ZTSK(0)=1,ZTSK(1)=2,ZTSK(2)="Active: Running"
"RTN","ZTLOAD5",17,0)
 . ;With a zero lock timeout it may report "active" falsely
"RTN","ZTLOAD5",18,0)
 . L +^%ZTSCH("TASK",ZTSK):0 I $T S ZTSK(1)=5,ZTSK(2)="Inactive: Interrupted" L -^%ZTSCH("TASK",ZTSK) ;p446
"RTN","ZTLOAD5",19,0)
 . Q
"RTN","ZTLOAD5",20,0)
 S ZT1=0 D  Q:ZTSK(0)  ;*339
"RTN","ZTLOAD5",21,0)
 . F  S ZT1=$O(^%ZTSCH(ZT1)) Q:ZT1'>0  I $D(^%ZTSCH(ZT1,ZTSK))#2 S ZTSK(0)=1,ZTSK(1)=1,ZTSK(2)="Active: Pending" Q
"RTN","ZTLOAD5",22,0)
 S ZT1="" D  Q:ZTSK(0)
"RTN","ZTLOAD5",23,0)
 . F  S ZT1=$O(^%ZTSCH("IO",ZT1)),ZT2="" Q:ZT1=""  D  Q:ZTSK(0)
"RTN","ZTLOAD5",24,0)
 . . F  S ZT2=$O(^%ZTSCH("IO",ZT1,ZT2)) Q:ZT2=""  I $D(^(ZT2,ZTSK))#2 S ZTSK(0)=1,ZTSK(1)=1,ZTSK(2)="Active: Pending" Q
"RTN","ZTLOAD5",25,0)
 S ZT1="" D  Q:ZTSK(0)
"RTN","ZTLOAD5",26,0)
 . F  S ZT1=$O(^%ZTSCH("JOB",ZT1)) Q:ZT1=""  I $D(^(ZT1,ZTSK))#2 S ZTSK(0)=1,ZTSK(1)=1,ZTSK(2)="Active: Pending" Q
"RTN","ZTLOAD5",27,0)
 S ZT1="" D  Q:ZTSK(0)
"RTN","ZTLOAD5",28,0)
 . F  S ZT1=$O(^%ZTSCH("LINK",ZT1)),ZT2="" Q:ZT1=""  D  Q:ZTSK(0)
"RTN","ZTLOAD5",29,0)
 . . F  S ZT2=$O(^%ZTSCH("LINK",ZT1,ZT2)) Q:ZT2=""  I $D(^(ZT2,ZTSK))#2 S ZTSK(0)=1,ZTSK(1)=1,ZTSK(2)="Active: Pending" Q
"RTN","ZTLOAD5",30,0)
 S ZT1=0 D  Q:ZTSK(0)  ;*339
"RTN","ZTLOAD5",31,0)
 . F  S ZT1=$O(^%ZTSCH("C",ZT1)) Q:ZT1'>0  I $D(^(ZT1,ZTSK)) S ZTSK(0)=1,ZTSK(2)="Active: Pending" Q
"RTN","ZTLOAD5",32,0)
 ;
"RTN","ZTLOAD5",33,0)
FLAG ;If we didn't find it in a list, use status flag
"RTN","ZTLOAD5",34,0)
 I $D(^%ZTSK(ZTSK,.1))[0 Q
"RTN","ZTLOAD5",35,0)
 S ZT=$P(^%ZTSK(ZTSK,.1),U),ZTSK(0)=1
"RTN","ZTLOAD5",36,0)
 I ZT=2!(ZT=4) S ZTSK(1)=1,ZTSK(2)="Active: Pending" Q
"RTN","ZTLOAD5",37,0)
 I ZT=6 S ZTSK(1)=3,ZTSK(2)="Inactive: Finished" Q
"RTN","ZTLOAD5",38,0)
 I ZT="H"!(ZT="K") S ZTSK(1)=4,ZTSK(2)="Inactive: Available" Q
"RTN","ZTLOAD5",39,0)
 S ZTSK(1)=5,ZTSK(2)="Inactive: Interrupted"
"RTN","ZTLOAD5",40,0)
 Q
"RTN","ZTLOAD5",41,0)
 ;
"RTN","ZTLOAD5",42,0)
DESC ;Find tasks with matching description.
"RTN","ZTLOAD5",43,0)
 ;From %ZTLOAD input param DESC,LST
"RTN","ZTLOAD5",44,0)
 Q:$G(DESC)=""
"RTN","ZTLOAD5",45,0)
 N ZTSK,X D ENV
"RTN","ZTLOAD5",46,0)
 S:'$D(LST) LST="^TMP($J)" S ZTSK=0
"RTN","ZTLOAD5",47,0)
 F  S ZTSK=$O(^%ZTSK(ZTSK)) Q:ZTSK'>0  S X=$G(^%ZTSK(ZTSK,0)) D
"RTN","ZTLOAD5",48,0)
 . Q:$$SKIP()
"RTN","ZTLOAD5",49,0)
 . I $G(^%ZTSK(ZTSK,.03))=DESC S @LST@(ZTSK)=""
"RTN","ZTLOAD5",50,0)
 . Q
"RTN","ZTLOAD5",51,0)
 Q
"RTN","ZTLOAD5",52,0)
RTN ;Find tasks with matching routines
"RTN","ZTLOAD5",53,0)
 ;From %ZTLOAD input param RTN,LST
"RTN","ZTLOAD5",54,0)
 Q:$G(RTN)=""
"RTN","ZTLOAD5",55,0)
 N ZTSK,X D ENV
"RTN","ZTLOAD5",56,0)
 S:'$D(LST) LST="^TMP($J)" S:RTN'["^" RTN="^"_RTN S ZTSK=0
"RTN","ZTLOAD5",57,0)
 F  S ZTSK=$O(^%ZTSK(ZTSK)) Q:ZTSK'>0  S X=$G(^%ZTSK(ZTSK,0)) D
"RTN","ZTLOAD5",58,0)
 . Q:$$SKIP()
"RTN","ZTLOAD5",59,0)
 . I $P(X,"^",1,2)=RTN S @LST@(ZTSK)="" Q
"RTN","ZTLOAD5",60,0)
 . I "^"_($P(X,"^",2))=RTN S @LST@(ZTSK)=""
"RTN","ZTLOAD5",61,0)
 . Q
"RTN","ZTLOAD5",62,0)
 Q
"RTN","ZTLOAD5",63,0)
OPTION ;Find tasks with matching option names
"RTN","ZTLOAD5",64,0)
 ;From %ZTLOAD input param OPNM, LST
"RTN","ZTLOAD5",65,0)
 Q:$G(OPNM)=""  N ZTSK,X,FLG D ENV
"RTN","ZTLOAD5",66,0)
 S:'$D(LST) LST="^TMP($J)" S ZTSK=0,FLG=(OPNM?1.N1"^"1A.ANP)
"RTN","ZTLOAD5",67,0)
 Q:'FLG&(OPNM'?1A.ANP)
"RTN","ZTLOAD5",68,0)
 F  S ZTSK=$O(^%ZTSK(ZTSK)) Q:ZTSK'>0  S X=$G(^%ZTSK(ZTSK,0)) D
"RTN","ZTLOAD5",69,0)
 . Q:$$SKIP()
"RTN","ZTLOAD5",70,0)
 . I FLG,$P(X,"^",8,9)=OPNM S @LST@(ZTSK)="" Q
"RTN","ZTLOAD5",71,0)
 . I $P(X,"^",1,2)="ZTSK^XQ1",$P(X,"^",9)=OPNM S @LST@(ZTSK)=""
"RTN","ZTLOAD5",72,0)
 . Q
"RTN","ZTLOAD5",73,0)
 Q
"RTN","ZTLOAD5",74,0)
SKIP() ;Screen on ZTKEY, UCI, DUZ, return: 0=OK, 1=Skip
"RTN","ZTLOAD5",75,0)
 Q:ZTKEY 0
"RTN","ZTLOAD5",76,0)
 Q:($P(X,U,11)_","_$P(X,U,12))'=ZTUCI 1
"RTN","ZTLOAD5",77,0)
 Q:$P(X,U,3)'=DUZ 1
"RTN","ZTLOAD5",78,0)
 Q 0
"RTN","ZTLOAD5",79,0)
ENV ;Setup
"RTN","ZTLOAD5",80,0)
 S ZTKEY=$D(^XUSEC("ZTMQ",DUZ)),U="^"
"RTN","ZTLOAD5",81,0)
 X ^%ZOSF("UCI") S ZTUCI=Y
"RTN","ZTLOAD5",82,0)
 Q
"RTN","ZTLOAD5",83,0)
 ;
"RTN","ZTLOAD5",84,0)
JOB ;Return JOB # for running task. Called from JOB^ZTLOAD (*339)
"RTN","ZTLOAD5",85,0)
 N Z1,Z2 S Z1=""
"RTN","ZTLOAD5",86,0)
 I $G(ZTM)>0 S Z2=$G(^%ZTSCH("TASK",ZTM)),Z1=$S($L(Z2):$P(Z2,"^",10),1:"")
"RTN","ZTLOAD5",87,0)
 Q Z1
"RTN","ZTM")
0^4^B46237405
"RTN","ZTM",1,0)
%ZTM ;SEA/RDS-TaskMan: Manager, Part 1 (Main Loop) ;10/02/08  09:00
"RTN","ZTM",2,0)
 ;;8.0;KERNEL;**24,36,64,67,118,127,136,275,355,446**;JUL 10, 1995;Build 36
"RTN","ZTM",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTM",4,0)
 ;%ZTCHK is set to 1 @ top of SCHQ, set to 0 if sent a task to SM
"RTN","ZTM",5,0)
LOOP ;Taskman's Main Loop
"RTN","ZTM",6,0)
 S %ZTRUN=1,%ZTCHK=1
"RTN","ZTM",7,0)
 F %ZTLOOP=0:1 S %ZTLOOP=%ZTLOOP#16 D CHECK,SCHQ,IDLE:%ZTCHK
"RTN","ZTM",8,0)
 S %ZTFALL="" G LOOP
"RTN","ZTM",9,0)
 ;
"RTN","ZTM",10,0)
CHECK ;LOOP--Check Status And Update Loop Data
"RTN","ZTM",11,0)
 ;Do CHECK if sent a new job or %ZTLOOP=0.
"RTN","ZTM",12,0)
 Q:%ZTLOOP&$G(%ZTCHK)
"RTN","ZTM",13,0)
 I $D(^%ZTSCH("STOP","MGR",%ZTPAIR)) G HALT^%ZTM0
"RTN","ZTM",14,0)
 S ^%ZTSCH("RUN")=$H,ZTPAIR="",%ZTIME=$$H3($H)
"RTN","ZTM",15,0)
 I $D(^%ZTSCH("WAIT","MGR"))#2 D STATUS("WAIT","Taskman Waiting") H 5 G CHECK
"RTN","ZTM",16,0)
 ;
"RTN","ZTM",17,0)
 I '$D(^%ZTSCH("UPDATE",$J)) D UPDATE^%ZTM5
"RTN","ZTM",18,0)
 I %ZTVLI D STATUS("PAUSE","Logons Inhibited") H 60 G CHECK ;Set in %ZTM5
"RTN","ZTM",19,0)
 I @%ZTNLG D INHIBIT^%ZTM5(1),STATUS("PAUSE","No Signons Allowed") H 60 G CHECK
"RTN","ZTM",20,0)
 I $G(^%ZIS(14.5,"LOGON",%ZTVOL)) D INHIBIT^%ZTM5(0) ;Check field
"RTN","ZTM",21,0)
 I $D(ZTREQUIR)#2 D STATUS("PAUSE","Required link to "_ZTREQUIR_" is down.") H 60 D REQUIR^%ZTM5 G CHECK
"RTN","ZTM",22,0)
 ;
"RTN","ZTM",23,0)
 I $D(^%ZTSCH("LINK"))#2,$$DIFF($H,^("LINK"))>900 D LINK^%ZTM3
"RTN","ZTM",24,0)
 ;Job Limit check done in NEWJOB. p446
"RTN","ZTM",25,0)
 ;
"RTN","ZTM",26,0)
 I $L(%ZTPFLG("BAL")) D  I ZTOVERLD G CHECK
"RTN","ZTM",27,0)
 . S ZTOVERLD=0
"RTN","ZTM",28,0)
 . Q:%ZTPFLG("LBT")>%ZTIME  ;Running, Not time to recheck
"RTN","ZTM",29,0)
 . S %ZTPFLG("LBT")=%ZTIME+%ZTPFLG("BI") ;Next time to check.
"RTN","ZTM",30,0)
 . D BALANCE^%ZTM6 Q:'ZTOVERLD
"RTN","ZTM",31,0)
 . D STATUS("BALANCE","Load Balance Wait.")
"RTN","ZTM",32,0)
 . ;Start submanagers for C list work
"RTN","ZTM",33,0)
 . I $D(^%ZTSCH("C",%ZTPAIR))>9 D NEWJOB(%ZTUCI,%ZTVOL,"")
"RTN","ZTM",34,0)
 . N T F T=1:2:%ZTPFLG("BI") H 2 Q:$$STOPWT^%ZTM6()  ;p446 Wait, Check if leave early
"RTN","ZTM",35,0)
 . Q
"RTN","ZTM",36,0)
 ;
"RTN","ZTM",37,0)
 I %ZTRUN D STATUS("RUN","Main Loop")
"RTN","ZTM",38,0)
 I '%ZTRUN D
"RTN","ZTM",39,0)
 . D STATUS("RUN","Taskman Job Limit Reached"),CHECK^%ZTM6
"RTN","ZTM",40,0)
 . S %ZTPFLG("JLC")=(%ZTPFLG("JLC")+1)#3
"RTN","ZTM",41,0)
 . I '%ZTPFLG("JLC") S %ZTRUN=%ZTVMJ>$$ACTJ^%ZOSV ;ReCheck for job limit p446
"RTN","ZTM",42,0)
 Q
"RTN","ZTM",43,0)
 ;
"RTN","ZTM",44,0)
STATUS(ST,MSG) ;Record TM status
"RTN","ZTM",45,0)
 N F
"RTN","ZTM",46,0)
 ;p446 Only update status every 5 seconds, unless MSG has changed.
"RTN","ZTM",47,0)
 S F=(MSG'=$G(%ZTPFLG("StatusM")))
"RTN","ZTM",48,0)
 I $G(%ZTPFLG("Status"))>%ZTIME,'$G(F) Q
"RTN","ZTM",49,0)
 S ^%ZTSCH("STATUS",$J)=$H_"^"_ST_"^"_$G(%ZTPAIR)_"^"_MSG
"RTN","ZTM",50,0)
 S %ZTPFLG("Status")=%ZTIME+5,%ZTPFLG("StatusM")=MSG
"RTN","ZTM",51,0)
 Q
"RTN","ZTM",52,0)
 ;
"RTN","ZTM",53,0)
TLOCK(M) ;Lock/unlock the SCHQ node
"RTN","ZTM",54,0)
 I M>0 L +^%ZTSCH("SCHQ"):%ZTLKTM Q $T
"RTN","ZTM",55,0)
 L -^%ZTSCH("SCHQ") Q
"RTN","ZTM",56,0)
 ;
"RTN","ZTM",57,0)
SCHQ ;LOOP--Check Schedule List
"RTN","ZTM",58,0)
 S %ZTIME=$$H3($H),ZTDTH=0,ZTSK=0,%ZTCHK=1,IO=""
"RTN","ZTM",59,0)
 I '$$TLOCK(1) Q  ;Lock and Sync %ZTSCH
"RTN","ZTM",60,0)
S1 S ZTDTH=$O(^%ZTSCH(ZTDTH)),ZTSK=0 I (ZTDTH>%ZTIME)!('ZTDTH)!(ZTDTH'?1.N) D TLOCK(-1) Q
"RTN","ZTM",61,0)
 I +ZTDTH<0 K ^%ZTSCH(ZTDTH) G S1
"RTN","ZTM",62,0)
S2 S ZTSK=$O(^%ZTSCH(ZTDTH,ZTSK)) I ZTSK="" G S1
"RTN","ZTM",63,0)
 S ZTST=$G(^%ZTSCH(ZTDTH,ZTSK))
"RTN","ZTM",64,0)
 ;Get task lock then release SCHQ lock
"RTN","ZTM",65,0)
 L +^%ZTSK(ZTSK):0 G S2:'$T
"RTN","ZTM",66,0)
 K ^%ZTSCH(ZTDTH,ZTSK) D TLOCK(-1)
"RTN","ZTM",67,0)
 I $D(^%ZTSK(ZTSK,0))[0 D TSKSTAT("I") L -^%ZTSK(ZTSK) Q  ;p446
"RTN","ZTM",68,0)
 I $L($P($G(^%ZTSK(ZTSK,.1)),U,10)) D TSKSTAT("D","Stopped") L -^%ZTSK(ZTSK) Q  ;p446
"RTN","ZTM",69,0)
 D ^%ZTM1
"RTN","ZTM",70,0)
 I %ZTREJCT L -^%ZTSK(ZTSK) Q  ;p446, Need to get SCHQ lock again.
"RTN","ZTM",71,0)
 ;Count tasks
"RTN","ZTM",72,0)
 S %ZTMON(%ZTMON)=$G(%ZTMON(%ZTMON))+1
"RTN","ZTM",73,0)
 ;
"RTN","ZTM",74,0)
SEND ;Send Task To Submanager
"RTN","ZTM",75,0)
 S %ZTCHK=0,ZTPAIR=""
"RTN","ZTM",76,0)
 I ZTDVOL'=%ZTVOL D XLINK^%ZTM2 G:'ZTJOBIT SCHX
"RTN","ZTM",77,0)
 ;Clear before job cmd
"RTN","ZTM",78,0)
 L +^%ZTSCH("JOBQ"):99
"RTN","ZTM",79,0)
 I (ZTYPE'="C")&(%ZTNODE[ZTNODE) D
"RTN","ZTM",80,0)
 . D TSKSTAT(3,"Placed on JOB List")
"RTN","ZTM",81,0)
 . S ^%ZTSCH("JOB",ZTDTH,ZTSK)=IO ;No other lock on JOB
"RTN","ZTM",82,0)
 E  D
"RTN","ZTM",83,0)
 . D TSKSTAT("M","Placed on C List")
"RTN","ZTM",84,0)
 . S ZTPAIR=ZTDVOL_$S($L(ZTNODE):":"_ZTNODE,1:"")
"RTN","ZTM",85,0)
 . S ^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK)=IO
"RTN","ZTM",86,0)
 ;
"RTN","ZTM",87,0)
 L -^%ZTSK(ZTSK),-^%ZTSCH("JOBQ")
"RTN","ZTM",88,0)
 ;Check if need new sub-manager.
"RTN","ZTM",89,0)
 I (ZTYPE="C")!$$NEWSUB,'$$OOS(ZTPAIR) D NEWJOB(ZTUCI,ZTDVOL,ZTNODE)
"RTN","ZTM",90,0)
SCHX ;Clear all locks
"RTN","ZTM",91,0)
 L  K ZTREP
"RTN","ZTM",92,0)
 Q
"RTN","ZTM",93,0)
 ;
"RTN","ZTM",94,0)
IDLE ;LOOP--DEV Node Maintenance; Backup JOB Commands
"RTN","ZTM",95,0)
 N R,C,T
"RTN","ZTM",96,0)
 I %ZTMON("NEXT")'>%ZTIME D MON ;See if time to update %ZTMON
"RTN","ZTM",97,0)
 S (ZTREC,ZTCVOL)="" H 1 ;This is the main hang
"RTN","ZTM",98,0)
 I $D(^%ZTSCH("STOP","MGR",%ZTPAIR)) Q
"RTN","ZTM",99,0)
 ;job off a new submanager if MIN count < # SUBs
"RTN","ZTM",100,0)
 I $$NEWSUB D NEWJOB(%ZTUCI,%ZTVOL,"")
"RTN","ZTM",101,0)
 ;Job off a new submanagers if the JOB list is long.
"RTN","ZTM",102,0)
 S R=$NA(^%ZTSCH("JOB")),C=0,T=15
"RTN","ZTM",103,0)
 F  S R=$Q(@R),C=C+1 Q:R'["JOB"  I C>T D NEWJOB(%ZTUCI,%ZTVOL,"") Q  ;Just start one at a time ;p446
"RTN","ZTM",104,0)
 ;Other Idle work.
"RTN","ZTM",105,0)
 L +^%ZTSCH("IDLE",%ZTPAIR):%ZTLKTM Q:'$T  D IDLE1 L -^%ZTSCH("IDLE",%ZTPAIR)
"RTN","ZTM",106,0)
 Q
"RTN","ZTM",107,0)
 ;
"RTN","ZTM",108,0)
IDLE1 ;only proceed with idle work if 60 seconds since last check
"RTN","ZTM",109,0)
 I $$DIFF(%ZTIME,^%ZTSCH("IDLE"),1)<60 Q
"RTN","ZTM",110,0)
 S ^%ZTSCH("IDLE")=%ZTIME ;Set new time.
"RTN","ZTM",111,0)
 I %ZTPFLG("XUSCNT") D TOUCH^XUSCNT
"RTN","ZTM",112,0)
 D I1,I2 X "JOB DETACH^%ZTM"
"RTN","ZTM",113,0)
 Q
"RTN","ZTM",114,0)
 ;
"RTN","ZTM",115,0)
I1 ;clear out old DEV nodes
"RTN","ZTM",116,0)
 N X,%ZTIO S %ZTIO=""
"RTN","ZTM",117,0)
 F  S %ZTIO=$O(^%ZTSCH("DEV",%ZTIO)) Q:%ZTIO=""  L +^%ZTSCH("DEV",%ZTIO):0 I $T D  L -^%ZTSCH("DEV",%ZTIO)
"RTN","ZTM",118,0)
 . S X=$G(^%ZTSCH("DEV",%ZTIO)) Q:'$L(X)
"RTN","ZTM",119,0)
 . I $$DIFF(%ZTIME,X,1)>120 K ^%ZTSCH("DEV",%ZTIO)
"RTN","ZTM",120,0)
 . Q
"RTN","ZTM",121,0)
 Q
"RTN","ZTM",122,0)
 ;
"RTN","ZTM",123,0)
I2 ;job new submanagers cross-volume for each unfinished C list
"RTN","ZTM",124,0)
 I $D(^%ZTSCH("C")) D
"RTN","ZTM",125,0)
 . N Y,ZTUCI,ZTVOL,ZTNODE,$ETRAP,$ESTACK S $ET="S $EC="""" D ERCL^%ZTM2"
"RTN","ZTM",126,0)
 . S ZTVOL="" F  S ZTVOL=$O(^%ZTSCH("C",ZTVOL)) Q:ZTVOL=""  D
"RTN","ZTM",127,0)
 .. I $O(^%ZTSCH("C",ZTVOL,0))="" Q
"RTN","ZTM",128,0)
 .. S ZTNODE="",ZTDVOL=ZTVOL S:ZTDVOL[":" ZTNODE=$P(ZTDVOL,":",2),ZTDVOL=$P(ZTDVOL,":")
"RTN","ZTM",129,0)
 .. S X=$G(^%ZTSCH("C",ZTVOL))
"RTN","ZTM",130,0)
 .. I $D(^%ZTSCH("LINK",ZTDVOL))!(X>9)!$$OOS(ZTVOL) Q
"RTN","ZTM",131,0)
 .. S ^%ZTSCH("C",ZTVOL)=X+1
"RTN","ZTM",132,0)
 .. S ZTUCI=$O(^%ZIS(14.6,"AV",ZTDVOL,""))
"RTN","ZTM",133,0)
 .. D NEWJOB(ZTUCI,ZTDVOL,ZTNODE)
"RTN","ZTM",134,0)
 .. Q
"RTN","ZTM",135,0)
 . Q
"RTN","ZTM",136,0)
 Q
"RTN","ZTM",137,0)
 ;
"RTN","ZTM",138,0)
MON ;Set Next %ZTMON each Hour
"RTN","ZTM",139,0)
 I %ZTMON("DAY")<+$H D DAY^%ZTM5
"RTN","ZTM",140,0)
 S %ZTMON=$P($H,",",2)\3600,%ZTMON(%ZTMON)=0
"RTN","ZTM",141,0)
 S %ZTMON("NEXT")=($H*86400)+(%ZTMON+1*3600)
"RTN","ZTM",142,0)
 D HOUR^%ZTM5
"RTN","ZTM",143,0)
 Q
"RTN","ZTM",144,0)
 ;
"RTN","ZTM",145,0)
NEWJOB(ZTUCI,ZTDVOL,ZTNODE) ;Start a new Job
"RTN","ZTM",146,0)
 S %ZTRUN=%ZTVMJ>$$ACTJ^%ZOSV ;Check for job limit p446
"RTN","ZTM",147,0)
 ;At the job limit if $ZTRUN=0
"RTN","ZTM",148,0)
 I '%ZTRUN D STATUS("RUN","Taskman Job Limit Reached") Q
"RTN","ZTM",149,0)
 S ZTUCI=$G(ZTUCI),ZTDVOL=$G(ZTDVOL),ZTNODE=$G(ZTNODE)
"RTN","ZTM",150,0)
 X %ZTJOB H %ZTSLO ;If job doesn't work, will catch next time.
"RTN","ZTM",151,0)
 Q
"RTN","ZTM",152,0)
 ;
"RTN","ZTM",153,0)
DIFF(N,O,T) ;Diff in sec.
"RTN","ZTM",154,0)
 Q:$G(T) N-O ;For new seconds times
"RTN","ZTM",155,0)
 Q N-O*86400-$P(O,",",2)+$P(N,",",2)
"RTN","ZTM",156,0)
 ;
"RTN","ZTM",157,0)
OOS(BV) ;Check if Box-Volume is Out Of Service, Return 1 if OOS.
"RTN","ZTM",158,0)
 Q:BV="" 0 N %
"RTN","ZTM",159,0)
 S %=$O(^%ZIS(14.7,"B",BV,0)),%=$G(^%ZIS(14.7,+%,0))
"RTN","ZTM",160,0)
 Q:%="" 1 Q $P(%,U,11)=1
"RTN","ZTM",161,0)
 ;
"RTN","ZTM",162,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTM",163,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTM",164,0)
 ;
"RTN","ZTM",165,0)
H0(%) ;Covert from seconds to $H
"RTN","ZTM",166,0)
 Q (%\86400)_","_(%#86400)
"RTN","ZTM",167,0)
 ;
"RTN","ZTM",168,0)
SUBOK() ;Check if sub's are starting, return 1 if OK
"RTN","ZTM",169,0)
 N T L +^%ZTSCH("SUB",%ZTPAIR):0 S T=$T
"RTN","ZTM",170,0)
 S ^%ZTSCH("SUB",%ZTPAIR,0)=($G(^%ZTSCH("SUB",%ZTPAIR,0))+1)_"^"_$H
"RTN","ZTM",171,0)
 I T L -^%ZTSCH("SUB",%ZTPAIR)
"RTN","ZTM",172,0)
 Q ^%ZTSCH("SUB",%ZTPAIR,0)<10
"RTN","ZTM",173,0)
 ;
"RTN","ZTM",174,0)
NEWSUB() ;See if we need a new submanager
"RTN","ZTM",175,0)
 N SUBS,T
"RTN","ZTM",176,0)
 L +^%ZTSCH("SUB",%ZTPAIR):0 S T=$T ;Sync ^%ZTSCH("SUB",%ZTPAIR)
"RTN","ZTM",177,0)
 S SUBS=^%ZTSCH("SUB",%ZTPAIR)
"RTN","ZTM",178,0)
 I T L -^%ZTSCH("SUB",%ZTPAIR)
"RTN","ZTM",179,0)
 Q SUBS<%ZTPFLG("MINSUB")
"RTN","ZTM",180,0)
 ;
"RTN","ZTM",181,0)
TSKSTAT(CODE,MSG) ; Update task's status
"RTN","ZTM",182,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,4)=$G(CODE)_U_$H_U_$G(MSG)_U_$J
"RTN","ZTM",183,0)
 Q
"RTN","ZTM",184,0)
 ;
"RTN","ZTM",185,0)
DETACH ;Do slow work in background job
"RTN","ZTM",186,0)
 D PARAMS^%ZTM5 S $ET="D ^%ZTER"
"RTN","ZTM",187,0)
 D I5,I6
"RTN","ZTM",188,0)
 Q
"RTN","ZTM",189,0)
 ;
"RTN","ZTM",190,0)
I5 ;Clean up %ZTSCH
"RTN","ZTM",191,0)
 S ZTDTH="0,0" F  S ZTDTH=$O(^%ZTSCH(ZTDTH)) Q:ZTDTH'[","  D
"RTN","ZTM",192,0)
 . L +^%ZTSCH("SCHQ"):%ZTLKTM Q:'$T  ;Keep others out while cleaning
"RTN","ZTM",193,0)
 . N ZTSK,X
"RTN","ZTM",194,0)
 . S ZTSK=$O(^%ZTSCH(ZTDTH,0)) I ZTSK>0 S X=^(ZTSK),^%ZTSCH($$H3(ZTDTH),ZTSK)=X K ^%ZTSCH(ZTDTH,ZTSK)
"RTN","ZTM",195,0)
 . L -^%ZTSCH("SCHQ")
"RTN","ZTM",196,0)
 . Q
"RTN","ZTM",197,0)
 Q
"RTN","ZTM",198,0)
 ;
"RTN","ZTM",199,0)
I6 ;Check on persistent jobs, Locks can take time, Called from %ZTM0 at start.
"RTN","ZTM",200,0)
 S ZTSK=0 F  S ZTSK=$O(^%ZTSCH("TASK",ZTSK)) Q:ZTSK'>0  D:$D(^%ZTSCH("TASK",ZTSK,"P"))
"RTN","ZTM",201,0)
 . L +^%ZTSCH("TASK",ZTSK):%ZTLKTM E  Q  ;Still running
"RTN","ZTM",202,0)
 . D:$D(^%ZTSCH("TASK",ZTSK,"P")) REQP^%ZTLOAD3(ZTSK) ;START NEW TASK.
"RTN","ZTM",203,0)
 . K ^%ZTSCH("TASK",ZTSK)
"RTN","ZTM",204,0)
 . L -^%ZTSCH("TASK",ZTSK)
"RTN","ZTM",205,0)
 . Q
"RTN","ZTM",206,0)
 K %ZTVS
"RTN","ZTM",207,0)
 Q
"RTN","ZTM",208,0)
 ;
"RTN","ZTM0")
0^18^B17449159
"RTN","ZTM0",1,0)
%ZTM0 ;SEA/RDS-TaskMan: Manager, Part 2 (Begin) ;07/17/08  08:16
"RTN","ZTM0",2,0)
 ;;8.0;KERNEL;**42,36,67,88,118,127,136,175,275,355,446**;Jul 10, 1995;Build 36
"RTN","ZTM0",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTM0",4,0)
 ;
"RTN","ZTM0",5,0)
START ;Entry Point--start Task Manager at system startup
"RTN","ZTM0",6,0)
 S $ETRAP="D ER^%ZTM5",^%ZTSCH("ER")="",U="^"
"RTN","ZTM0",7,0)
 L ^%ZTSCH:10 G:'$T RESTART ;Someone already running
"RTN","ZTM0",8,0)
 K ^%ZTSCH("DEV"),^("DEVOPEN"),^("LOAD"),^("LOADA"),^("STATUS"),^("STOP"),^("SUB"),^("UPDATE")
"RTN","ZTM0",9,0)
 S %ZTIME=$$H3^%ZTM($H)
"RTN","ZTM0",10,0)
 D STATUS^%ZTM("RUN","Startup") ;Move after kill p446
"RTN","ZTM0",11,0)
 S %ZTLKTM=5 ;Temp value for I6^%ZTM ;p446
"RTN","ZTM0",12,0)
 D I6^%ZTM ;Handle Persistent Jobs
"RTN","ZTM0",13,0)
 S ZTSK=0 F  S ZTSK=$O(^%ZTSCH("TASK",ZTSK)) Q:'ZTSK  D
"RTN","ZTM0",14,0)
 . D TSKSTAT^%ZTM1("E","Interrupted While Running")
"RTN","ZTM0",15,0)
 . K ^%ZTSCH("TASK",ZTSK)
"RTN","ZTM0",16,0)
 K ^%ZTSCH("TASK") ;Remove all p446
"RTN","ZTM0",17,0)
 D SETUP
"RTN","ZTM0",18,0)
 I "CFO"[%ZTYPE G BADTYPE ;Moved after SETUP p446
"RTN","ZTM0",19,0)
 S ^%ZTSCH("IDLE")=0,^%ZTSCH("SUB",%ZTPAIR)=0,^(%ZTPAIR,0)=0
"RTN","ZTM0",20,0)
 D STATUS^%ZTM("RUN","Startup Hang")
"RTN","ZTM0",21,0)
 H %ZTPFLG("TM-DELAY") ;Wait for system stability.
"RTN","ZTM0",22,0)
S1 ;
"RTN","ZTM0",23,0)
 D STATUS^%ZTM("RUN","Startup jobs")
"RTN","ZTM0",24,0)
 ;S %ZTLOOP=0,%ZTRUN=1 D CHECK^%ZTM ;Why? ;p446
"RTN","ZTM0",25,0)
 D STRTUP
"RTN","ZTM0",26,0)
 S ZTU="" F  S ZTU=$O(^%ZTSCH("C",ZTU)) Q:ZTU=""  S ^%ZTSCH("C",ZTU)=0 ;Reset VS counts in C list.
"RTN","ZTM0",27,0)
 K %ZTI,%ZTY,ZTIO,ZTO,ZTP,ZTSK,ZTU
"RTN","ZTM0",28,0)
 I %ZTPFLG("XUSCNT") D COUNT^XUSCNT(1)
"RTN","ZTM0",29,0)
 G ^%ZTM
"RTN","ZTM0",30,0)
 ;
"RTN","ZTM0",31,0)
RESTART ;Entry Point--restart Task Manager
"RTN","ZTM0",32,0)
 S $ETRAP="D ER^%ZTM5",^%ZTSCH("ER")="",U="^"
"RTN","ZTM0",33,0)
 K ^%ZTSCH("STATUS"),^("STOP")
"RTN","ZTM0",34,0)
 S %ZTIME=$$H3^%ZTM($H)
"RTN","ZTM0",35,0)
 D STATUS^%ZTM("RUN","Restart") ;Move after kill p446
"RTN","ZTM0",36,0)
 D SETUP
"RTN","ZTM0",37,0)
 I '$D(^%ZTSCH("IDLE")) S ^%ZTSCH("IDLE")=0
"RTN","ZTM0",38,0)
 I '$D(^%ZTSCH("SUB",%ZTPAIR)) S ^%ZTSCH("SUB",%ZTPAIR)=0
"RTN","ZTM0",39,0)
 I "CFO"[%ZTYPE G BADTYPE
"RTN","ZTM0",40,0)
 I %ZTPFLG("XUSCNT") D COUNT^XUSCNT(1)
"RTN","ZTM0",41,0)
 G ^%ZTM
"RTN","ZTM0",42,0)
 ;
"RTN","ZTM0",43,0)
 ;
"RTN","ZTM0",44,0)
SETUP ;Setup Task Manager's Environment
"RTN","ZTM0",45,0)
 N X,Y,Z,ZT
"RTN","ZTM0",46,0)
ST2 S ^%ZTSCH("RUN")=$H,%ZTPAIR="ROU"
"RTN","ZTM0",47,0)
 D STATUS^%ZTM("RUN","Setup")
"RTN","ZTM0",48,0)
 D ZOSF I Y]"" D STATUS^%ZTM("PAUSE","The following required ^%ZOSF nodes are undefined: "_Y_".") H 60 G ST2
"RTN","ZTM0",49,0)
 D UPDATE^%ZTM5 I $D(ZTREQUIR)#2 D STATUS^%ZTM("PAUSE","Required link to "_ZTREQUIR_" is down.") H 60 G ST2
"RTN","ZTM0",50,0)
 ;Clear the NOT Responding count
"RTN","ZTM0",51,0)
 S X="" F  S X=$O(^%ZTSCH("C",X)) Q:X=""  S ^%ZTSCH("C",X)=0
"RTN","ZTM0",52,0)
 D JOB,NOLOG^%ZOSV S %ZTNLG=Y,DTIME=1,DUZ=0,DUZ(0)="@"
"RTN","ZTM0",53,0)
 K Z D NAME K X,Y,Z,ZT
"RTN","ZTM0",54,0)
 Q
"RTN","ZTM0",55,0)
STRTUP ;Queue the entries from the STARTUP X-ref
"RTN","ZTM0",56,0)
 ;After talking with the DBA, All STARTUP jobs will have DUZ=.5
"RTN","ZTM0",57,0)
 N ZTU,ZTO,ZTSAVE,ZTRTN,DUZ
"RTN","ZTM0",58,0)
 S DUZ=.5,DUZ(0)="@"
"RTN","ZTM0",59,0)
 S ZTU="" F  S ZTU=$O(^%ZTSCH("STARTUP",ZTU)),ZTO="" Q:ZTU=""  F  S ZTO=$O(^%ZTSCH("STARTUP",ZTU,ZTO)) Q:ZTO=""  D
"RTN","ZTM0",60,0)
 . S ZTSAVE("XQY")=$P(ZTO,"Q",2) ;This must be set for %ZTLOAD
"RTN","ZTM0",61,0)
 . S ZTDTH=$H,ZTIO=$P(^%ZTSCH("STARTUP",ZTU,ZTO),"^",2),ZTRTN="ZTSK^XQ1",ZTSAVE($S(ZTO["Q":"XQSCH",1:"XQY"))=+ZTO,ZTUCI=$P(ZTU,","),ZTCPU=$P(ZTU,",",2)
"RTN","ZTM0",62,0)
 . D ^%ZTLOAD
"RTN","ZTM0",63,0)
 . Q
"RTN","ZTM0",64,0)
 Q
"RTN","ZTM0",65,0)
 ;
"RTN","ZTM0",66,0)
ZOSF ;SETUP--determine whether any required ^%ZOSF nodes are missing
"RTN","ZTM0",67,0)
 S Y=""
"RTN","ZTM0",68,0)
 F X="ACTJ","OS","PROD","UCI","UCICHECK","VOL" I $D(^%ZOSF(X))[0 S Y=Y_","_X
"RTN","ZTM0",69,0)
 S:$T(ACTJ^%ZOSV)="" Y=Y_",ACTJ^%ZOSV"
"RTN","ZTM0",70,0)
 I Y]"" S Y=$E(Y,2,$L(Y))
"RTN","ZTM0",71,0)
 Q
"RTN","ZTM0",72,0)
 ;
"RTN","ZTM0",73,0)
JOB ;SETUP--setup JOB command
"RTN","ZTM0",74,0)
 I %ZTOS["OpenM" D  Q
"RTN","ZTM0",75,0)
 . S:'$L(%ZTPFLG("DCL")) %ZTJOB="J ^%ZTMS::5"  ;"J ^%ZTMS:ZTUCI:5"
"RTN","ZTM0",76,0)
 . S:$L(%ZTPFLG("DCL")) %ZTJOB="D ^%ZTMDCL"
"RTN","ZTM0",77,0)
 . Q
"RTN","ZTM0",78,0)
 I %ZTOS["GT.M" S %ZTJOB="J GTM^%ZTMS::5",@("$ZINTERRUPT=""I $$JOBEXAM^ZU($ZPOSITION)""") Q
"RTN","ZTM0",79,0)
 I %ZTOS["VAX DSM" D  Q
"RTN","ZTM0",80,0)
 . S:'$L(%ZTPFLG("DCL")) %ZTJOB="J ^%ZTMS:(OPTION=""/UCI=""_$P(ZTUCI,"","")_""/VOL=""_ZTDVOL):5"
"RTN","ZTM0",81,0)
 . S:$L(%ZTPFLG("DCL")) %ZTJOB="D ^%ZTMDCL"
"RTN","ZTM0",82,0)
 . Q
"RTN","ZTM0",83,0)
 I %ZTOS["MSM" S %ZTJOB="J ^%ZTMS[ZTUCI,ZTDVOL]:%ZTSIZ:5" Q  ;Set Maxpartsiz
"RTN","ZTM0",84,0)
 I %ZTOS["DTM" S %ZTJOB="J ^%ZTMS:(NSPACE=ZTUCI)" Q
"RTN","ZTM0",85,0)
 S %ZTJOB="J ^%ZTMS::5"
"RTN","ZTM0",86,0)
 Q
"RTN","ZTM0",87,0)
 ;
"RTN","ZTM0",88,0)
NAME ;Give a name to process.
"RTN","ZTM0",89,0)
 N $ETRAP,ZQ S $ETRAP="S ZQ=0,$EC="""" Q"
"RTN","ZTM0",90,0)
 F Z=1:1:9 S X="Taskman "_%ZTVOL_" "_Z,ZQ=1 D SETENV^%ZOSV Q:ZQ
"RTN","ZTM0",91,0)
 Q
"RTN","ZTM0",92,0)
BADTYPE ;Taskman should not run on this type of node.
"RTN","ZTM0",93,0)
 K ^%ZTSCH("STATUS")
"RTN","ZTM0",94,0)
 S ^%ZTSCH("RUN")=%ZTPAIR_" is the wrong type in taskman site parameters."
"RTN","ZTM0",95,0)
 Q
"RTN","ZTM0",96,0)
 ;
"RTN","ZTM0",97,0)
HALT ;Cleanup and halt
"RTN","ZTM0",98,0)
 I %ZTPFLG("XUSCNT") D COUNT^XUSCNT(-1)
"RTN","ZTM0",99,0)
 K ^%ZTSCH("STATUS",$J),^%ZTSCH("RUN"),^%ZTSCH("UPDATE",$J)
"RTN","ZTM0",100,0)
 K ^%ZTSCH("LOADA",%ZTPAIR)
"RTN","ZTM0",101,0)
 X "HALT"
"RTN","ZTM5")
0^10^B22884813
"RTN","ZTM5",1,0)
%ZTM5 ;SEA/RDS-TaskMan: Manager, Part 5 (Short Subroutines) ;10/01/08  14:35
"RTN","ZTM5",2,0)
 ;;8.0;KERNEL;**24,36,118,127,136,162,275,355,446**;JUL 10, 1995;Build 36
"RTN","ZTM5",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTM5",4,0)
 ;
"RTN","ZTM5",5,0)
ER ;primary error trap for manager
"RTN","ZTM5",6,0)
 S %ZTERLGR=$$LGR^%ZOSV,ZTERCODE=$$EC^%ZOSV ;Grab LGR and EC first p446
"RTN","ZTM5",7,0)
 S $ETRAP="D ER2^%ZTM5"
"RTN","ZTM5",8,0)
 D ^%ZTER ;Record error now p446
"RTN","ZTM5",9,0)
 L  ;Clear all locks
"RTN","ZTM5",10,0)
 S ^%ZTSCH("RUN")=$H
"RTN","ZTM5",11,0)
 D STATUS^%ZTM("ERROR","Recording A Trapped Error.") ;p446
"RTN","ZTM5",12,0)
 ;
"RTN","ZTM5",13,0)
 N ZT1,ZT2 ;p446
"RTN","ZTM5",14,0)
 I '$$SCREEN^%ZTER(ZTERCODE) D
"RTN","ZTM5",15,0)
 . L +^%ZTSCH("ER"):15 H 1 S ZT1=$H,ZT2=$P(ZT1,",",2),ZT1=+ZT1 ;p446
"RTN","ZTM5",16,0)
 . S ^%ZTSCH("ER",ZT1,ZT2)=ZTERCODE,^(ZT2,1)="Caused by the manager." ;p446
"RTN","ZTM5",17,0)
 . L -^%ZTSCH("ER")
"RTN","ZTM5",18,0)
 . Q
"RTN","ZTM5",19,0)
 ;
"RTN","ZTM5",20,0)
 K ZTERCODE
"RTN","ZTM5",21,0)
 ;Lets wait before restarting.
"RTN","ZTM5",22,0)
ER2 H 10 S $ET="Q:$STACK  S $EC="""" G RESTART^%ZTM0" S $EC=",U99,"
"RTN","ZTM5",23,0)
 ;
"RTN","ZTM5",24,0)
UPDATE ;CHECK^%ZTM/LOOKUP^%ZTM0--update TaskMan site parameters
"RTN","ZTM5",25,0)
 L +^%ZTSCH("UPDATE",$J):99
"RTN","ZTM5",26,0)
 I '$D(^%ZTSCH("LOAD")) S ^%ZTSCH("LOAD")="" ;Starting value p446
"RTN","ZTM5",27,0)
 D PARAMS ;p446
"RTN","ZTM5",28,0)
 D MON^%ZTM ;Setup Task Counting
"RTN","ZTM5",29,0)
 S ^%ZTSCH("UPDATE",$J)=$H
"RTN","ZTM5",30,0)
 K ^%ZTSCH("LOADA",%ZTPAIR) ;Clear LB in case we stop doing LB.
"RTN","ZTM5",31,0)
 L -^%ZTSCH("UPDATE",$J)
"RTN","ZTM5",32,0)
 I "GP"'[%ZTYPE D  X "HALT  "
"RTN","ZTM5",33,0)
 . K ^%ZTSCH("STATUS")
"RTN","ZTM5",34,0)
 . S ^%ZTSCH("RUN")=%ZTNODE_" is the wrong type of volume set for TaskMan."
"RTN","ZTM5",35,0)
 . Q
"RTN","ZTM5",36,0)
 Q
"RTN","ZTM5",37,0)
 ;
"RTN","ZTM5",38,0)
PARAMS ;Setup Parameters ;p446
"RTN","ZTM5",39,0)
 S %ZTOS=^%ZOSF("OS"),U="^"
"RTN","ZTM5",40,0)
 D GETENV^%ZOSV
"RTN","ZTM5",41,0)
 S %ZTUCI=$P(Y,U),%ZTVOL=$P(Y,U,2),%ZTNODE=$P(Y,U,3),%ZTPAIR=$P(Y,U,4)
"RTN","ZTM5",42,0)
 S %ZTVSN=+$O(^%ZIS(14.5,"B",%ZTVOL,"")),%ZTVSS=$G(^%ZIS(14.5,%ZTVSN,0))
"RTN","ZTM5",43,0)
 S %ZTVLI=($P(%ZTVSS,U,2)="Y") ;Did site set Inhibit.
"RTN","ZTM5",44,0)
 S %ZTYPE("V")=$P(%ZTVSS,U,10) ;get vol set type
"RTN","ZTM5",45,0)
U1 ;
"RTN","ZTM5",46,0)
 S %ZTPN=+$O(^%ZIS(14.7,"B",%ZTPAIR,"")),%ZTPS=$G(^%ZIS(14.7,%ZTPN,0))
"RTN","ZTM5",47,0)
 S %ZTPT=+$P(%ZTPS,U,4) ;Priority
"RTN","ZTM5",48,0)
 S %ZTSIZ=+$P(%ZTPS,U,5) ;par size
"RTN","ZTM5",49,0)
 S %ZTRET=+$P(%ZTPS,U,6) ;Retention Time
"RTN","ZTM5",50,0)
 S %ZTVMJ=+$P(%ZTPS,U,7) ;TM job limit
"RTN","ZTM5",51,0)
 S %ZTSLO=+$P(%ZTPS,U,8) ;TM slow down
"RTN","ZTM5",52,0)
 S %ZTYPE=$P(%ZTPS,U,9) ;TM Mode
"RTN","ZTM5",53,0)
 K %ZTPFLG S %ZTPFLG="" ;Start Clean
"RTN","ZTM5",54,0)
 S %ZTPFLG("DCL")=$P(%ZTPS,U,10) ;TM mode, VAX DCL
"RTN","ZTM5",55,0)
 S %ZTPFLG("BAL")=$G(^%ZIS(14.7,%ZTPN,2))
"RTN","ZTM5",56,0)
 S %ZTPFLG("MINSUB")=$S($P(%ZTPS,U,12):$P(%ZTPS,U,12),1:1)
"RTN","ZTM5",57,0)
 S %ZTPFLG("LBT")=0,%ZTPFLG("BI")=$S($P(%ZTPS,U,14):$P(%ZTPS,U,14),1:120) ;Balance Interval ;p446
"RTN","ZTM5",58,0)
 S %ZTPFLG("JLC")=0 ;Job Limit check ;P446
"RTN","ZTM5",59,0)
 S %ZTPFLG("TM-DELAY")=$P($G(^%ZIS(14.7,%ZTPN,3),"^60"),U,2) ;Start Delay
"RTN","ZTM5",60,0)
 S %ZTPFLG("START")=+$H
"RTN","ZTM5",61,0)
 S %ZTPFLG("XUSCNT")=0 I %ZTOS["GT.M" S %ZTPFLG("XUSCNT")=$L($T(^XUSCNT))
"RTN","ZTM5",62,0)
 S %ZTLKTM=+$G(^DD("DILOCKTM"),1) ;Lock timeout p446
"RTN","ZTM5",63,0)
 S %ZTMON("DAY")=+$H
"RTN","ZTM5",64,0)
 ;For Cache Map CPF to Node.
"RTN","ZTM5",65,0)
 I %ZTOS["OpenM",$ZV["VMS" D
"RTN","ZTM5",66,0)
 . N I,X,Y S Y=$P(%ZTPAIR,":"),X=Y
"RTN","ZTM5",67,0)
 . F  S X=$O(^%ZIS(14.7,"B",X)) Q:X'[Y  D
"RTN","ZTM5",68,0)
 . . S I=$O(^%ZIS(14.7,"B",X,0)),Z=^%ZIS(14.7,I,0)
"RTN","ZTM5",69,0)
 . . S I=$P(Z,U,10) S:$L(I) %ZTPFLG("Q",$P($P(Z,U),":",2))=I,%ZTPFLG("Q",I)=$P($P(Z,U),":",2)
"RTN","ZTM5",70,0)
 . Q
"RTN","ZTM5",71,0)
 Q
"RTN","ZTM5",72,0)
 ;
"RTN","ZTM5",73,0)
HOUR ;Run once an hour for each taskman
"RTN","ZTM5",74,0)
 D SUBCHK
"RTN","ZTM5",75,0)
 D SCHCHK
"RTN","ZTM5",76,0)
 Q
"RTN","ZTM5",77,0)
 ;
"RTN","ZTM5",78,0)
DAY ;Run once a DAY for each Taskman
"RTN","ZTM5",79,0)
 D MON
"RTN","ZTM5",80,0)
 Q
"RTN","ZTM5",81,0)
 ;
"RTN","ZTM5",82,0)
MON ;Save off the monitor data
"RTN","ZTM5",83,0)
 N X S X=""
"RTN","ZTM5",84,0)
 F I=0:1:23 S X=X_(+$G(%ZTMON(I)))_"^",%ZTMON(I)=0
"RTN","ZTM5",85,0)
 S ^%ZTSCH("MON",%ZTPAIR,%ZTMON("DAY"))=X
"RTN","ZTM5",86,0)
 S %ZTMON("DAY")=+$H
"RTN","ZTM5",87,0)
 Q
"RTN","ZTM5",88,0)
 ;
"RTN","ZTM5",89,0)
SUBCHK ;Job the SUB check routine
"RTN","ZTM5",90,0)
 J SUBCHK^%ZTMS5(%ZTLKTM)
"RTN","ZTM5",91,0)
 Q
"RTN","ZTM5",92,0)
 ;
"RTN","ZTM5",93,0)
SCHCHK ;Queue the check of the option schedule file. ;p446
"RTN","ZTM5",94,0)
 I $$DIFF^%ZTM(%ZTIME,$G(^%ZTSCH("HOUR")),1)<3599 Q
"RTN","ZTM5",95,0)
 S ^%ZTSCH("HOUR")=%ZTIME
"RTN","ZTM5",96,0)
 N ZTRTN,ZTDTH,ZTDESC,ZTSK,ZTIO,DUZ
"RTN","ZTM5",97,0)
 S DUZ=.5,ZTRTN="HOUR^XUTMHR",ZTIO="",ZTDTH=$H,ZTDESC="Taskman Hourly Job"
"RTN","ZTM5",98,0)
 D ^%ZTLOAD
"RTN","ZTM5",99,0)
 Q
"RTN","ZTM5",100,0)
 ;
"RTN","ZTM5",101,0)
REQUIR ;UPDATE/CHECK^%ZTM--ensure required links are available
"RTN","ZTM5",102,0)
 K ZTREQUIR N ZT1,ZTN,ZTS,ZTU S ZT1=0
"RTN","ZTM5",103,0)
 F  S ZT1=$O(^%ZIS(14.5,ZT1)) Q:'ZT1  I $D(^%ZIS(14.5,ZT1,0))#2 S ZTS=^(0) I $P(ZTS,U,5)="Y" D TEST I $D(ZTREQUIR)#2 Q
"RTN","ZTM5",104,0)
 K ZT,ZT1,ZTN,ZTS,ZTU
"RTN","ZTM5",105,0)
 Q
"RTN","ZTM5",106,0)
 ;
"RTN","ZTM5",107,0)
TEST ;REQUIR--test a required volume set
"RTN","ZTM5",108,0)
 N $ET,$ES,NULL
"RTN","ZTM5",109,0)
 S ZTN=$P(ZTS,U),NULL="" I ZTN="" Q
"RTN","ZTM5",110,0)
 I ZTN=%ZTVOL Q
"RTN","ZTM5",111,0)
 I $P(ZTS,U,3)="N" S ZTREQUIR=ZTN Q
"RTN","ZTM5",112,0)
 I $P(ZTS,U,4)="Y" S ZTREQUIR=ZTN Q
"RTN","ZTM5",113,0)
 S ZTU=$O(^%ZIS(14.6,"AV",ZTN,"")) I ZTU="" Q
"RTN","ZTM5",114,0)
 S $ET="S ZTREQUIR=ZTN,$EC=NULL Q"
"RTN","ZTM5",115,0)
 S @("X=$D(^[ZTU,ZTN]DIC(0))")
"RTN","ZTM5",116,0)
 L +^%ZTSCH("LINK",ZTN):99
"RTN","ZTM5",117,0)
 I $D(^%ZTSCH("LINK",ZTN)) S ^%ZTSCH("LINK")=0
"RTN","ZTM5",118,0)
 L -^%ZTSCH("LINK",ZTN)
"RTN","ZTM5",119,0)
 Q
"RTN","ZTM5",120,0)
 ;
"RTN","ZTM5",121,0)
LINK(ZTVOL) ;internal Kernel extrinsic function
"RTN","ZTM5",122,0)
 ;input--volume set where task should run
"RTN","ZTM5",123,0)
 ;output--UCI,volume set where record must be created
"RTN","ZTM5",124,0)
 ;after call check 1--if value is "", the input or file is bad
"RTN","ZTM5",125,0)
 ;after call check 2--if $P(value,",",2) is current volume set then
"RTN","ZTM5",126,0)
 ;...no extended reference should be used
"RTN","ZTM5",127,0)
 ;
"RTN","ZTM5",128,0)
L0 ;was a volume set passed in?
"RTN","ZTM5",129,0)
 N ZTN,ZTU,ZTV,ZTVD,ZTVN
"RTN","ZTM5",130,0)
 I $G(ZTVOL)'?2.7U Q ""
"RTN","ZTM5",131,0)
 ;
"RTN","ZTM5",132,0)
L1 ;is this volume set on file?
"RTN","ZTM5",133,0)
 S ZTVN=$O(^%ZIS(14.5,"B",ZTVOL,""))
"RTN","ZTM5",134,0)
 I ZTVN="" Q ""
"RTN","ZTM5",135,0)
 I $D(^%ZIS(14.5,ZTVN,0))[0 Q ""
"RTN","ZTM5",136,0)
 S ZTVD=^%ZIS(14.5,ZTVN,0)
"RTN","ZTM5",137,0)
 ;
"RTN","ZTM5",138,0)
L2 ;is there a TaskMan Files Volume Set?  if not, skip next section
"RTN","ZTM5",139,0)
 S ZTN=$P(ZTVD,"^",7)
"RTN","ZTM5",140,0)
 I ZTN="" S ZTV=ZTVOL G L4
"RTN","ZTM5",141,0)
 ;
"RTN","ZTM5",142,0)
L3 ;if there is a separate TaskMan Files Volume Set, is it on file?
"RTN","ZTM5",143,0)
 I $D(^%ZIS(14.5,ZTN,0))[0 Q ""
"RTN","ZTM5",144,0)
 S ZTVD=^%ZIS(14.5,ZTN,0)
"RTN","ZTM5",145,0)
 S ZTV=$P(ZTVD,"^")
"RTN","ZTM5",146,0)
 I ZTV="" Q ""
"RTN","ZTM5",147,0)
 ;
"RTN","ZTM5",148,0)
L4 ;if there is a TaskMan Files UCI, return UCI,volume set
"RTN","ZTM5",149,0)
 S ZTU=$P(ZTVD,"^",6)
"RTN","ZTM5",150,0)
 I ZTU="" Q ""
"RTN","ZTM5",151,0)
 Q ZTU_","_ZTV
"RTN","ZTM5",152,0)
 ;
"RTN","ZTM5",153,0)
 ;
"RTN","ZTM5",154,0)
INHIBIT(Y) ;Set/Clear the Inhibit logon field
"RTN","ZTM5",155,0)
 I Y=1 S $P(^%ZIS(14.5,%ZTVSN,0),U,2)="S",^%ZIS(14.5,"LOGON",%ZTVOL)=1 Q
"RTN","ZTM5",156,0)
 I Y=0 S $P(^%ZIS(14.5,%ZTVSN,0),U,2)="N" K ^%ZIS(14.5,"LOGON",%ZTVOL) Q
"RTN","ZTM5",157,0)
 Q
"RTN","ZTM6")
0^11^B9213954
"RTN","ZTM6",1,0)
%ZTM6 ;SEA/RDS-TaskMan: Manager, Part 8 (Load Balancing) ;07/01/08  15:46
"RTN","ZTM6",2,0)
 ;;8.0;KERNEL;**23,118,127,136,355,446**;JUL 10, 1995;Build 36
"RTN","ZTM6",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTM6",4,0)
 ;
"RTN","ZTM6",5,0)
BALANCE ;CHECK^%ZTM--determine whether cpu should wait for balance
"RTN","ZTM6",6,0)
 ;Return ZTOVERLD =1 if need to wait, 0 to run
"RTN","ZTM6",7,0)
 ;The TM with the largest value sets ^%ZTSCH("LOAD")=who^value^when p446
"RTN","ZTM6",8,0)
 ;If your value is greater or equal then you run.
"RTN","ZTM6",9,0)
 ;If your value is less you wait unless you set LOAD then you run.
"RTN","ZTM6",10,0)
 ;Tell sub-managers by setting ^%ZTSCH("LOADA",%ZTPAIR)=run^value^time^$J
"RTN","ZTM6",11,0)
 ;Use %ZTLKTM for lock timeout
"RTN","ZTM6",12,0)
 S ZTOVERLD=0 ;p446 Default
"RTN","ZTM6",13,0)
 TSTART
"RTN","ZTM6",14,0)
 L +^%ZTSCH("LOAD"):(%ZTLKTM+1) E  TROLLBACK  Q  ;p446 Keep working if can't get lock
"RTN","ZTM6",15,0)
 N X,ZTIME,ZTLEFT,ZTPREV
"RTN","ZTM6",16,0)
 N $ES,$ET S $ET="Q:$ES>0  D ERR^%ZTM6"
"RTN","ZTM6",17,0)
 S ZTOVERLD=0,ZTPREV=+$P($G(^%ZTSCH("LOAD")),"^",2),ZTIME=$$H3($H)
"RTN","ZTM6",18,0)
 S @("ZTLEFT="_%ZTPFLG("BAL"))
"RTN","ZTM6",19,0)
 S ZTIME=$$H3($H),ZTOVERLD=$$COMPARE(%ZTPAIR,ZTLEFT,ZTPREV)
"RTN","ZTM6",20,0)
 ;If we are RUNNING have other submanagers wait
"RTN","ZTM6",21,0)
 I 'ZTOVERLD D
"RTN","ZTM6",22,0)
 . S X="" F  S X=$O(^%ZTSCH("LOADA",X)) Q:X=""  S $P(^(X),"^")=1 ;Have others wait
"RTN","ZTM6",23,0)
 . S ^%ZTSCH("LOAD")=%ZTPAIR_"^"_ZTLEFT_"^"_ZTIME
"RTN","ZTM6",24,0)
 ;Now set a value that is used by our %ZTMS to run/wait also
"RTN","ZTM6",25,0)
 S ^%ZTSCH("LOADA",%ZTPAIR)=ZTOVERLD_"^"_ZTLEFT_"^"_ZTIME_"^"_$J
"RTN","ZTM6",26,0)
 L -^%ZTSCH("LOAD")
"RTN","ZTM6",27,0)
 TCOMMIT
"RTN","ZTM6",28,0)
 Q
"RTN","ZTM6",29,0)
 ;
"RTN","ZTM6",30,0)
STOPWT() ;See if we should stop Balance wait, Called from %ZTM.
"RTN","ZTM6",31,0)
 L +^%ZTSCH("LOAD"):%ZTLKTM Q:'$T 1 ;Run if can't get lock
"RTN","ZTM6",32,0)
 N I,J S I="",J=1
"RTN","ZTM6",33,0)
 F  S I=$O(^%ZTSCH("LOADA",I)) Q:I=""  I '^(I) S J=0
"RTN","ZTM6",34,0)
 L -^%ZTSCH("LOAD")
"RTN","ZTM6",35,0)
 Q J ;Return: 1 stop waiting, 0 keep waiting. (Someone is in run state)
"RTN","ZTM6",36,0)
 ;
"RTN","ZTM6",37,0)
CHECK ;Called when job limit reached.
"RTN","ZTM6",38,0)
 ;If not doing balancing, remove node and quit
"RTN","ZTM6",39,0)
 N I,J,K
"RTN","ZTM6",40,0)
 I %ZTPFLG("BAL")="" K ^%ZTSCH("LOADA",%ZTPAIR) Q
"RTN","ZTM6",41,0)
 L +^%ZTSCH("LOAD"):%ZTLKTM Q:'$T  ;Get it next time
"RTN","ZTM6",42,0)
 ;If at job limit see if sub-managers should run
"RTN","ZTM6",43,0)
 S I=$P($G(^%ZTSCH("LOAD")),"^",2),J=$P($G(^%ZTSCH("LOADA",%ZTPAIR)),"^",2)
"RTN","ZTM6",44,0)
 S K=(J<I),$P(^%ZTSCH("LOADA",%ZTPAIR),"^",1)=K
"RTN","ZTM6",45,0)
 L -^%ZTSCH("LOAD")
"RTN","ZTM6",46,0)
 Q
"RTN","ZTM6",47,0)
 ;
"RTN","ZTM6",48,0)
COMPARE(ID,ZTLEFT,ZTPREV) ;
"RTN","ZTM6",49,0)
 ;BALANCE--compare our cpu capacity left to that of previous checker
"RTN","ZTM6",50,0)
 ;input:  cpu name, cpu capacity left, cpu capacity of previous checker
"RTN","ZTM6",51,0)
 ;output: whether current cpu should wait, 0=run, 1=wait
"RTN","ZTM6",52,0)
 N X
"RTN","ZTM6",53,0)
 I ZTLEFT'<ZTPREV Q 0
"RTN","ZTM6",54,0)
 S X=^%ZTSCH("LOAD")
"RTN","ZTM6",55,0)
 I $P(X,"^",3)+(%ZTPFLG("BI")+5)<ZTIME Q 0
"RTN","ZTM6",56,0)
 Q $P(X,"^")'[ID
"RTN","ZTM6",57,0)
 ;
"RTN","ZTM6",58,0)
ERR ;Clean up if error
"RTN","ZTM6",59,0)
 S %ZTPFLG("EBAL")=1+$G(%ZTPFLG("EBAL")),ZTOVERLD=0
"RTN","ZTM6",60,0)
 I $G(%ZTPFLG("EBAL"))>10 D ^%ZTER S %ZTPFLG("BAL")="" ;Only stop after 10 errors ;p446
"RTN","ZTM6",61,0)
 S $EC=""
"RTN","ZTM6",62,0)
 ;TROLLBACK
"RTN","ZTM6",63,0)
 L -^%ZTSCH("LOAD")
"RTN","ZTM6",64,0)
 Q
"RTN","ZTM6",65,0)
 ;
"RTN","ZTM6",66,0)
H3(%) ;Convert $H to seconds
"RTN","ZTM6",67,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTM6",68,0)
 ;
"RTN","ZTM6",69,0)
VXD(BIAS) ;--algorithm for VAX DSM
"RTN","ZTM6",70,0)
 ;Capacity Left=Available Jobs + BIAS
"RTN","ZTM6",71,0)
 Q $$AVJ^%ZOSV()+$G(BIAS)
"RTN","ZTM6",72,0)
 ;
"RTN","ZTM6",73,0)
MSM4() ;Use MSMv4 LAT calcuation
"RTN","ZTM6",74,0)
 N MAXJOB,CURJOB
"RTN","ZTM6",75,0)
 X "S MAXJOB=$V($V(3,-5),-3,0),CURJOB=$V(168,-4,2)"
"RTN","ZTM6",76,0)
 Q MAXJOB-CURJOB*255\MAXJOB
"RTN","ZTM6",77,0)
 ;
"RTN","ZTM6",78,0)
CACHE1(BIAS) ;Use available jobs
"RTN","ZTM6",79,0)
 N CUR,MAX
"RTN","ZTM6",80,0)
 Q $$AVJ^%ZOSV()+$G(BIAS)
"RTN","ZTM6",81,0)
 ;
"RTN","ZTM6",82,0)
CACHE2(%COM,%LOG) ;Cache, Pull metric data
"RTN","ZTM6",83,0)
 N TMP,$ET
"RTN","ZTM6",84,0)
 S $ETRAP="S $ECODE="""" Q ZTPREV"
"RTN","ZTM6",85,0)
 S %LOG=$G(%LOG,"VISTA$METRIC")
"RTN","ZTM6",86,0)
 I $L($G(%COM)) S TMP=$ZF(-1,%COM)
"RTN","ZTM6",87,0)
 Q $ZF("TRNLNM",%LOG)
"RTN","ZTM6",88,0)
 ;
"RTN","ZTM6",89,0)
RNDRBN() ;Round Robin
"RTN","ZTM6",90,0)
 ;value^node^time
"RTN","ZTM6",91,0)
 N R,R2
"RTN","ZTM6",92,0)
 L +^%ZTSCH("RNDRBN"):$G(%ZTLKTM,1)
"RTN","ZTM6",93,0)
 S R=$G(^%ZTSCH("RNDRBN"))
"RTN","ZTM6",94,0)
 I $P(R,U,2)=%ZTPAIR S R2=+R G RX
"RTN","ZTM6",95,0)
 I ZTIME<$P(R,U,3) S R2=R-1 G RX
"RTN","ZTM6",96,0)
 S R2=R+2#512,^%ZTSCH("RNDRBN")=R2_U_%ZTPAIR_U_(ZTIME+%ZTPFLG("BI"))
"RTN","ZTM6",97,0)
RX L -^%ZTSCH("RNDRBN")
"RTN","ZTM6",98,0)
 Q R2
"RTN","ZTMB")
0^23^B24960683
"RTN","ZTMB",1,0)
ZTMB ;SEA/RDS-Taskman: Manager, Boot/ Option, ZTMRESTART ;10/07/08  16:13
"RTN","ZTMB",2,0)
 ;;8.0;KERNEL;**275,355,446**;Jul 10, 1995;Build 36
"RTN","ZTMB",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMB",4,0)
 ;
"RTN","ZTMB",5,0)
START ;Start Taskmanager
"RTN","ZTMB",6,0)
 N %,X,Z,ZTOS,ZTMB,ZTUCI,ZTMODE,ZTPAIR,ZTVOL,ZTNODE,ZTMULT
"RTN","ZTMB",7,0)
 D INIT S ZTMB="START"
"RTN","ZTMB",8,0)
 I ZTOS["OpenM" G CACHE
"RTN","ZTMB",9,0)
 I ZTOS["VAX DSM" G VXD
"RTN","ZTMB",10,0)
 I ZTOS["GT.M" J START^%ZTM0 Q
"RTN","ZTMB",11,0)
 I ZTOS["DTM" G DTM
"RTN","ZTMB",12,0)
 I $L($T(START^%ZTM0)) J START^%ZTM0 Q
"RTN","ZTMB",13,0)
 W !,"Taskman NOT Started"
"RTN","ZTMB",14,0)
 Q
"RTN","ZTMB",15,0)
VXD S %=($ZC(%GETJPI,$J,"CURPRIV")["SHARE") I % W !,"Don't start TaskMan with the SHARE privilege" Q
"RTN","ZTMB",16,0)
 S Z=0,%=$O(^%ZIS(14.7,"B",ZTPAIR,0)),ZTMODE=$P($G(^%ZIS(14.7,+%,0)),U,10)
"RTN","ZTMB",17,0)
VXD2 I Z,$$EC^%ZOSV["access not authorized"!($$EC^%ZOSV["no privilege") W !!,"You lack the system privilege to start TaskMan." H 2 Q
"RTN","ZTMB",18,0)
 I Z,$$EC^%ZOSV'["duplicate name" W !!,"The following error has prevented TaskMan from starting:",!,$$EC^%ZOSV H 2 Q
"RTN","ZTMB",19,0)
 S X="VXD2",@^%ZOSF("TRAP"),Z=Z+1
"RTN","ZTMB",20,0)
 I ZTMODE="" S %=ZTMB_"^%ZTM0:(OPTION=""/UCI=""_ZTUCI,NAME=""TaskMan ""_$E(^%ZOSF(""VOL""),1,3)_"" ""_Z)" J @% Q
"RTN","ZTMB",21,0)
 ;Remove the '/NOLOG' if you want a log file for trouble shooting
"RTN","ZTMB",22,0)
 I $L(ZTMODE) S %SPAWN="SUBMIT/NOPRINT/NOLOG/USER=TASKMAN/QUEUE=TM$"_ZTNODE_" DHCP$TASKMAN:ZTMWDCL/PARAM=("_ZTMODE_","_(ZTMB["RE")_")" D ^%SPAWN
"RTN","ZTMB",23,0)
 Q
"RTN","ZTMB",24,0)
 ;
"RTN","ZTMB",25,0)
CACHE ;Cache or OpenM
"RTN","ZTMB",26,0)
 I $ZV'["VMS" J START^%ZTM0 Q  ;Non-VMS start in current namespace
"RTN","ZTMB",27,0)
 ;For Cache/VMS
"RTN","ZTMB",28,0)
 S Z=0,%=$O(^%ZIS(14.7,"B",ZTPAIR,0)),ZTMODE=$P($G(^%ZIS(14.7,+%,0)),U,10)
"RTN","ZTMB",29,0)
 I '$L(ZTMODE) D  Q  ;Non-DCL Start
"RTN","ZTMB",30,0)
 . S %=($ZF("GETJPI",$J,"PROCPRIV")["SHARE")
"RTN","ZTMB",31,0)
 . I % W !,"Don't start TaskMan with the SHARE privilege" Q
"RTN","ZTMB",32,0)
 . J START^%ZTM0
"RTN","ZTMB",33,0)
 . Q
"RTN","ZTMB",34,0)
 I $L(ZTMODE) D
"RTN","ZTMB",35,0)
 . N CONF S CONF=$P(ZTPAIR,":",2)
"RTN","ZTMB",36,0)
 . ;Remove the '/NOLOG' if you want a log file for trouble shooting
"RTN","ZTMB",37,0)
 . S %SPAWN="SUBMIT/NOPRINT/NOLOG/USER=TASKMAN/QUEUE=TM$"_ZTNODE_" DHCP$TASKMAN:ZTM2WDCL.COM/PARAM=("_CONF_","_ZTUCI_",0)"
"RTN","ZTMB",38,0)
 . S %=$ZF(-1,%SPAWN)
"RTN","ZTMB",39,0)
 Q
"RTN","ZTMB",40,0)
 ;
"RTN","ZTMB",41,0)
DTM ;For DTM only
"RTN","ZTMB",42,0)
 N DEV,NULLDEV
"RTN","ZTMB",43,0)
 I ZTMB="START" D NULLDEV F DEV=10:1:19 O DEV:("W":NULLDEV):0 C DEV
"RTN","ZTMB",44,0)
 S Z=0
"RTN","ZTMB",45,0)
DTM2 S X="DTM2",@^%ZOSF("TRAP"),Z=Z+1,%=ZTMB_"^%ZTM0:(NSPACE="""_ZTUCI_""":STRSTK=8000:LVMEM=12000:NAME=""TaskMan "_$E(^%ZOSF("VOL"),1,3)_" "_Z_""")" J @% Q
"RTN","ZTMB",46,0)
 ;
"RTN","ZTMB",47,0)
RESTART ;Restart Taskmanager
"RTN","ZTMB",48,0)
 N %,%ZTI,X,Z,ZTOS,ZTMB,ZTUCI,ZTMODE,ZTPAIR,ZTVOL,ZTNODE,ZTMULT
"RTN","ZTMB",49,0)
 D INIT
"RTN","ZTMB",50,0)
 I $D(^%ZOSF("SIGNOFF")) X ^("SIGNOFF") I  D  Q
"RTN","ZTMB",51,0)
 . W $C(7),!,"NOTE THAT THE SYSTEM IS IN A 'SIGNOFF' STATE,",!?4,"WHICH PROBABLY EXPLAINS WHY TASKS ARE NOT RUNNING!!",!
"RTN","ZTMB",52,0)
 S ZTMULT=0
"RTN","ZTMB",53,0)
 I $S($D(^%ZTSCH("RUN"))[0:0,^("RUN")-$H:0,1:$P($H,",",2)-150'>$P(^("RUN"),",",2)) W !,"TASKMAN IS ALREADY RUNNING" S ZTMULT=1
"RTN","ZTMB",54,0)
 I ZTOS["VAX DSM" I $ZC(%GETJPI,$J,"CURPRIV")["SHARE" D  Q
"RTN","ZTMB",55,0)
 . W !,"Don't start TaskMan with the SHARE privilege" Q
"RTN","ZTMB",56,0)
 I ZTOS["OpenM",$ZV["VMS" I $ZF("GETJPI",$J,"PROCPRIV")["SHARE" D  Q
"RTN","ZTMB",57,0)
 . W !,"Don't start TaskMan with the SHARE privilege" Q
"RTN","ZTMB",58,0)
 F %ZTI=0:0 D  Q:"YESyes^NOno"[%Y
"RTN","ZTMB",59,0)
 . W !,"ARE YOU SURE YOU WANT TO RESTART ",$S(ZTMULT:"ANOTHER ",1:""),"TASKMAN? NO//"
"RTN","ZTMB",60,0)
 . R %Y:$S($D(DTIME)#2:DTIME,1:60) S:'$T %Y="^" Q:"YESyes^NOno"[%Y
"RTN","ZTMB",61,0)
 . W:'$T "*TIMEOUT*" W:%Y'["?" *7 D HELP1:%Y'["??",HELP2:%Y["??"
"RTN","ZTMB",62,0)
 I %Y=""!("YESyes"'[%Y) W "  (NO)",!,*7,"<NO ACTION TAKEN>",! Q
"RTN","ZTMB",63,0)
 W "  (YES)",!,"Restarting..."
"RTN","ZTMB",64,0)
 S ZTMB="RESTART"
"RTN","ZTMB",65,0)
 I ZTOS["OpenM" D CACHE,DONE Q
"RTN","ZTMB",66,0)
 I ZTOS["DTM" G DTM
"RTN","ZTMB",67,0)
 I ZTOS["GT.M" J RESTART^%ZTM0 D DONE Q
"RTN","ZTMB",68,0)
 I ZTOS'["VAX DSM" J RESTART^%ZTM0[ZTUCI] D DONE Q
"RTN","ZTMB",69,0)
 I ZTOS["VAX DSM" G VXD
"RTN","ZTMB",70,0)
 W !!,$C(7),"Taskman NOT Restared",!
"RTN","ZTMB",71,0)
 Q
"RTN","ZTMB",72,0)
INIT S U="^",ZTOS=^%ZOSF("OS"),ZTUCI=$P(^%ZOSF("MGR"),",")
"RTN","ZTMB",73,0)
 D GETENV^%ZOSV S ZTVOL=$P(Y,U,2),ZTNODE=$P(Y,U,3),ZTPAIR=$P(Y,U,4)
"RTN","ZTMB",74,0)
 Q
"RTN","ZTMB",75,0)
 ;
"RTN","ZTMB",76,0)
 ;NOTE:  On DataTree systems:
"RTN","ZTMB",77,0)
 ;For automatic startup of TaskMan at boot, save as %ustart in SYS.
"RTN","ZTMB",78,0)
 ;In %ustart, remove ';' from the next two lines:
"RTN","ZTMB",79,0)
 ;I $P($ZVER,"/",2)>4.0,$P($ZVER,"/",2)<4.3 VIEW 1:296:$C(2) ;increase name table allocation
"RTN","ZTMB",80,0)
 ;I  ZZSWITCH 256 ;display current namespace
"RTN","ZTMB",81,0)
 ;
"RTN","ZTMB",82,0)
NULLDEV ;SELECT NULL DEVICE (DTM OS Dependent)
"RTN","ZTMB",83,0)
 N %HW
"RTN","ZTMB",84,0)
 D HWTYPE S NULLDEV="NUL" I %HW'="PC" S NULLDEV="[NUL]"
"RTN","ZTMB",85,0)
 Q
"RTN","ZTMB",86,0)
 ;
"RTN","ZTMB",87,0)
HWTYPE ;HARDWARE TYPE(DTM OS Dependent)
"RTN","ZTMB",88,0)
 K %HW S %H=$S($P($ZVER,"/",2)<4:$V(4,3,-1),1:$V(1,3,-1)) ;get hardware type number
"RTN","ZTMB",89,0)
 S %HW=$S(%H<10:"WS",%H<20:"MF",%H<64:"?",%H<129:"PC",1:"?")
"RTN","ZTMB",90,0)
 Q
"RTN","ZTMB",91,0)
 ;
"RTN","ZTMB",92,0)
HELP1 ;RESTART--improved help for the confirmation prompt.
"RTN","ZTMB",93,0)
 W !!?5,"Answer must be YES or NO."
"RTN","ZTMB",94,0)
 W !?5,"Answer YES to restart ",$S(ZTMULT:"another ",1:""),"TaskMan.",!
"RTN","ZTMB",95,0)
 Q
"RTN","ZTMB",96,0)
 ;
"RTN","ZTMB",97,0)
HELP2 ;RESTART--??-help for confirmation prompt
"RTN","ZTMB",98,0)
 W !!?5,"TaskMan must be running in each library uci on the system for tasks to run."
"RTN","ZTMB",99,0)
 W !?5,"One TaskMan per library uci should be enough for all but the busiest sites."
"RTN","ZTMB",100,0)
 W !?5,"The System Status option and the Monitor TaskMan option can help determine"
"RTN","ZTMB",101,0)
 W !?5,"whether a TaskMan is running on this volume set."
"RTN","ZTMB",102,0)
 W !!?5,"If you are still uncertain how to respond, answer NO and consult your"
"RTN","ZTMB",103,0)
 W !?5,"documentation or your support ISC.",!
"RTN","ZTMB",104,0)
 Q
"RTN","ZTMB",105,0)
 ;
"RTN","ZTMB",106,0)
DONE ;RESTART--feedback after restarting TaskMan
"RTN","ZTMB",107,0)
 W "TaskMan restarted!",! Q
"RTN","ZTMB",108,0)
 ;
"RTN","ZTMCHK1")
0^12^B10420129
"RTN","ZTMCHK1",1,0)
ZTMCHK1 ;SEA/RDS-Taskman: Option, ZTMCHECK, Part 2 ;5/31/07  12:13
"RTN","ZTMCHK1",2,0)
 ;;8.0;KERNEL;**127,446**;Jul 10, 1995;Build 36
"RTN","ZTMCHK1",3,0)
 ;
"RTN","ZTMCHK1",4,0)
LINKS ;Check Required Volume Sets' Links
"RTN","ZTMCHK1",5,0)
 W !!,"Checking the links to the required volume sets..."
"RTN","ZTMCHK1",6,0)
 S (ZTJ,ZTV)=0
"RTN","ZTMCHK1",7,0)
 F  S ZTV=$O(^%ZIS(14.5,ZTV)) Q:'ZTV  S ZTS=$P(^(ZTV,0),U) I $P(^(0),U,5)="Y",ZTS'=ZTVOL D LK
"RTN","ZTMCHK1",8,0)
 I 'ZTJ W !?5,"There are no volume sets whose links are required!"
"RTN","ZTMCHK1",9,0)
 W !!,"Checks completed...Taskman's environment is okay!"
"RTN","ZTMCHK1",10,0)
 ;
"RTN","ZTMCHK1",11,0)
EOP ;Pause at end of page
"RTN","ZTMCHK1",12,0)
 W ! S Y="" F ZT=0:0 R !,"Press RETURN to continue or '^' to exit: ",Y:$S($D(DTIME)#2:DTIME,1:60) S:'$T DTOUT="" S:Y="^" DUOUT="" Q:Y=""!(Y="^")  W !!,"Enter either RETURN or '^'",! W:Y'["?" $C(7)
"RTN","ZTMCHK1",13,0)
 I $D(DUOUT)!$D(DTOUT) W:$D(DTOUT) $C(7) G EXIT
"RTN","ZTMCHK1",14,0)
 ;
"RTN","ZTMCHK1",15,0)
INFO ;Display Task Manager's Information
"RTN","ZTMCHK1",16,0)
 W @IOF,!!,"Here is the information that Taskman is using:"
"RTN","ZTMCHK1",17,0)
 W !?5,"Operating System:  ",$P(ZTOS,U)
"RTN","ZTMCHK1",18,0)
 W !?5,"Volume Set:  ",ZTVOL
"RTN","ZTMCHK1",19,0)
 W !?5,"Cpu-volume Pair:  ",ZTPAIR
"RTN","ZTMCHK1",20,0)
 W !?5,"TaskMan Files UCI and Volume Set:  ",$P(ZTVSS,U,6),"," S X=$P(ZTVSS,U,7) W $S(X="":ZTVOL,$D(^%ZIS(14.5,X,0))[0:ZTVOL,$P(^(0),U)="":ZTVOL,1:$P(^(0),U)) K X
"RTN","ZTMCHK1",21,0)
 W !!?5,"Log Tasks?  ",$P(ZTPS,U,3)
"RTN","ZTMCHK1",22,0)
 ;W !?5,"Default Task Priority: ",ZTPT ;p446
"RTN","ZTMCHK1",23,0)
 I ZTOS["DSM"&(ZTOS'["VAX"),ZTSIZ]"" W !?5,"Task Partition Size: ",ZTSIZ
"RTN","ZTMCHK1",24,0)
 W !?5,"Submanager Retention Time: ",ZTRET
"RTN","ZTMCHK1",25,0)
 W !?5,"Min Submanager Count: ",$P(ZTPS,U,12)
"RTN","ZTMCHK1",26,0)
 W !?5,"Taskman Hang Between New Jobs: ",ZTSLO
"RTN","ZTMCHK1",27,0)
 W !?5,"TaskMan running as a type: ",$P("^COMPUTE^PRINT^GENERAL^","^",$F("CPG",$P(ZTPS,U,9)))
"RTN","ZTMCHK1",28,0)
 I $P(ZTPS,U,10)]"" W !?5,"TaskMan is using VAX enviroment: ",$P(ZTPS,U,10) ;p446
"RTN","ZTMCHK1",29,0)
 I $G(^%ZIS(14.7,+ZTPN,2))]"" D
"RTN","ZTMCHK1",30,0)
 . W !?5,"TaskMan is using '",^(2),"' for load balancing"
"RTN","ZTMCHK1",31,0)
 . W !?5,"Balance Interval: ",$P(ZTPS,U,14) ;p446
"RTN","ZTMCHK1",32,0)
 . Q
"RTN","ZTMCHK1",33,0)
 ;
"RTN","ZTMCHK1",34,0)
STATUS ;Display Task Manager's Status-Related Information
"RTN","ZTMCHK1",35,0)
 W !!?5,"Logons Inhibited?:  ",ZTVLI
"RTN","ZTMCHK1",36,0)
 W !?5,"Taskman Job Limit:  ",ZTVMJ
"RTN","ZTMCHK1",37,0)
 I $D(^XTV(8989.3,0)) S %=$O(^XTV(8989.3,1,4,"B",ZTVOL,0)) W !?5,"Max sign-ons: ",$P($G(^XTV(8989.3,1,4,+%,0)),U,3)
"RTN","ZTMCHK1",38,0)
 X ^%ZOSF("ACTJ") W !?5,"Current number of active jobs: ",Y
"RTN","ZTMCHK1",39,0)
 ;
"RTN","ZTMCHK1",40,0)
DONE ;Prompt To Continue And Quit
"RTN","ZTMCHK1",41,0)
 W ! R !,"End of listing.  Press RETURN to continue: ",Y:$S($D(DTIME)#2:DTIME,1:60) S:'$T DTOUT="" S:Y="^" DUOUT=""
"RTN","ZTMCHK1",42,0)
EXIT Q
"RTN","ZTMCHK1",43,0)
 ;
"RTN","ZTMCHK1",44,0)
MGR ;LINKS--lookup name of another volume set's library uci
"RTN","ZTMCHK1",45,0)
 S Y=ZTX I Y]"" S Y=$O(^%ZIS(14.5,"B",Y,""))
"RTN","ZTMCHK1",46,0)
 I Y]"" S Y=$S($D(^%ZIS(14.5,Y,0))#2:$P(^(0),U,6),1:"")
"RTN","ZTMCHK1",47,0)
 I Y="" S Y=$P($P(^%ZIS(14.5,ZTVSN,0),U,6),",")
"RTN","ZTMCHK1",48,0)
 Q
"RTN","ZTMCHK1",49,0)
 ;
"RTN","ZTMCHK1",50,0)
LK ;Check one link
"RTN","ZTMCHK1",51,0)
 N $ES,$ET S $ET="D ERLINKS^ZTMCHK1"
"RTN","ZTMCHK1",52,0)
 S ZTJ=ZTJ+1,ZTX=ZTS D MGR S ZTX=$D(^[Y,ZTS]%ZOSF("PROD")) W !?5,"The link to volume set ",ZTS," is present!"
"RTN","ZTMCHK1",53,0)
 Q
"RTN","ZTMCHK1",54,0)
 ;
"RTN","ZTMCHK1",55,0)
ERLINKS ;Error Trap For LINKS Code
"RTN","ZTMCHK1",56,0)
 W !?5,"The link to volume set ",ZTS," appears to be down!",$C(7)
"RTN","ZTMCHK1",57,0)
 S $EC=""
"RTN","ZTMCHK1",58,0)
 Q
"RTN","ZTMCHK1",59,0)
 ;
"RTN","ZTMGRSET")
0^3^B54941338
"RTN","ZTMGRSET",1,0)
ZTMGRSET ;SF/RWF,PUG/TOAD - SET UP THE MGR ACCOUNT FOR THE SYSTEM ;02/13/2008
"RTN","ZTMGRSET",2,0)
 ;;8.0;KERNEL;**34,36,69,94,121,127,136,191,275,355,446**;JUL 10, 1995;Build 36
"RTN","ZTMGRSET",3,0)
 ;
"RTN","ZTMGRSET",4,0)
 N %D,%S,I,OSMAX,U,X,X1,X2,Y,Z1,Z2,ZTOS,ZTMODE,SCR
"RTN","ZTMGRSET",5,0)
 S ZTMODE=0
"RTN","ZTMGRSET",6,0)
A W !!,"ZTMGRSET Version ",$P($T(+2),";",3)," Patch level ",$P($T(+2),";",5)
"RTN","ZTMGRSET",7,0)
 W !,"HELLO! I exist to assist you in correctly initializing the current account."
"RTN","ZTMGRSET",8,0)
 I $D(^%ZOSF("UCI")) X ^%ZOSF("UCI") D  G A:"YNyn"'[$E(X) Q:"Nn"[$E(X)
"RTN","ZTMGRSET",9,0)
 . I ZTMODE=2 S X="Y" Q
"RTN","ZTMGRSET",10,0)
 . W $C(7),!!,"This is namespace or uci ",Y,".",!
"RTN","ZTMGRSET",11,0)
 . R "Should I continue? N//",X:120
"RTN","ZTMGRSET",12,0)
 . Q
"RTN","ZTMGRSET",13,0)
 S ZTOS=$$OS() I ZTOS'>0 W !,"OS type not selected. Exiting ZTMGRSET." Q
"RTN","ZTMGRSET",14,0)
 I ZTMODE D  I (PCNM<1)!(PCNM>999) W !,"Need a Patch number to load." Q
"RTN","ZTMGRSET",15,0)
 . I ZTMODE<2 R !!,"Patch number to load: ",PCNM:120 Q:(PCNM<1)!(PCNM>999)
"RTN","ZTMGRSET",16,0)
 . S SCR="I $P($T(+2^@X),"";"",5)?.E1P1"_$C(34)_PCNM_$C(34)_"1P.E"
"RTN","ZTMGRSET",17,0)
 ;
"RTN","ZTMGRSET",18,0)
 K ^%ZOSF("MASTER"),^("SIGNOFF") ;Remove old nodes.
"RTN","ZTMGRSET",19,0)
 ;
"RTN","ZTMGRSET",20,0)
DOIT D MES("I will now rename a group of routines specific to your operating system.",1)
"RTN","ZTMGRSET",21,0)
 D @ZTOS,ALL,GLOBALS:'ZTMODE D MES("ALL DONE",1)
"RTN","ZTMGRSET",22,0)
 Q
"RTN","ZTMGRSET",23,0)
 ;========================================
"RTN","ZTMGRSET",24,0)
RELOAD ;Reload any patched routines
"RTN","ZTMGRSET",25,0)
 N %D,%S,I,OSMAX,U,X,X1,X2,Y,Z1,Z2,ZTOS,ZTMODE,SCR
"RTN","ZTMGRSET",26,0)
 S ZTMODE=1 G A
"RTN","ZTMGRSET",27,0)
 Q
"RTN","ZTMGRSET",28,0)
 ;
"RTN","ZTMGRSET",29,0)
PATCH(PCNM) ;Post install Reload any patched routines
"RTN","ZTMGRSET",30,0)
 N %D,%S,I,OSMAX,U,X,X1,X2,Y,Z1,Z2,ZTOS,ZTMODE,SCR
"RTN","ZTMGRSET",31,0)
 I (1>PCNM)!(PCNM>999) D MES("PATCH NUMBER OUT OF RANGE",1) Q
"RTN","ZTMGRSET",32,0)
 D MES("Rename the routines in Patch "_PCNM,1)
"RTN","ZTMGRSET",33,0)
 S ZTMODE=2 G A
"RTN","ZTMGRSET",34,0)
 Q
"RTN","ZTMGRSET",35,0)
 ;
"RTN","ZTMGRSET",36,0)
MES(T,B) ;Write message.
"RTN","ZTMGRSET",37,0)
 S B=$G(B)
"RTN","ZTMGRSET",38,0)
 I $L($T(BMES^XPDUTL)) D BMES^XPDUTL(T):B,MES^XPDUTL(T):'B Q
"RTN","ZTMGRSET",39,0)
 W:B ! W !,T
"RTN","ZTMGRSET",40,0)
 Q
"RTN","ZTMGRSET",41,0)
 ;
"RTN","ZTMGRSET",42,0)
OS() ;Select the OS
"RTN","ZTMGRSET",43,0)
 N Y,X1,X,OSMAX
"RTN","ZTMGRSET",44,0)
 S U="^",SCR="I 1" F I=1:1:20 S X=$T(@I) Q:X=""  S OSMAX=I
"RTN","ZTMGRSET",45,0)
B S Y=0,ZTOS=0 I $D(^%ZOSF("OS")) D
"RTN","ZTMGRSET",46,0)
 . S X1=$P(^%ZOSF("OS"),U),ZTOS=$$OSNUM W !,"I think you are using ",X1
"RTN","ZTMGRSET",47,0)
 I ZTMODE=2,ZTOS>0 Q ZTOS
"RTN","ZTMGRSET",48,0)
 W !,"Which MUMPS system should I install?",!
"RTN","ZTMGRSET",49,0)
 F I=1:1:OSMAX W !,I," = ",$P($T(@I),";",3)
"RTN","ZTMGRSET",50,0)
 W !,"System: " W:ZTOS ZTOS,"//"
"RTN","ZTMGRSET",51,0)
 R X:300 S:X="" X=ZTOS
"RTN","ZTMGRSET",52,0)
 I X<1!(X>OSMAX) W !,"NOT A VALID CHOICE" Q:X[U 0 G B
"RTN","ZTMGRSET",53,0)
 Q X
"RTN","ZTMGRSET",54,0)
 ;
"RTN","ZTMGRSET",55,0)
OSNUM() ;Return the OS number
"RTN","ZTMGRSET",56,0)
 N I,X1,X2,Y S Y=0,X1=$P($G(^%ZOSF("OS")),"^")
"RTN","ZTMGRSET",57,0)
 F I=1:1 S X2=$T(@I) Q:X2=""  I X2[X1 S Y=I Q
"RTN","ZTMGRSET",58,0)
 Q Y
"RTN","ZTMGRSET",59,0)
 ;
"RTN","ZTMGRSET",60,0)
ALL W !!,"Now to load routines common to all systems."
"RTN","ZTMGRSET",61,0)
 D TM,ETRAP,DEV,OTHER,FM
"RTN","ZTMGRSET",62,0)
 I ZTOS=7!(ZTOS=8) D
"RTN","ZTMGRSET",63,0)
 . S ^%ZE="D ^ZE"
"RTN","ZTMGRSET",64,0)
 E  D  ;With ZLoad, ZSave, ZInsert
"RTN","ZTMGRSET",65,0)
 . W !,"Installing ^%Z editor"
"RTN","ZTMGRSET",66,0)
 . D ^ZTEDIT
"RTN","ZTMGRSET",67,0)
 I 'ZTMODE W !,"Setting ^%ZIS('C')" K ^%ZIS("C") S ^%ZIS("C")="G ^%ZISC"
"RTN","ZTMGRSET",68,0)
 Q
"RTN","ZTMGRSET",69,0)
 ;
"RTN","ZTMGRSET",70,0)
TM ;Taskman
"RTN","ZTMGRSET",71,0)
 S %S="ZTLOAD^ZTLOAD1^ZTLOAD2^ZTLOAD3^ZTLOAD4^ZTLOAD5^ZTLOAD6^ZTLOAD7"
"RTN","ZTMGRSET",72,0)
 S %D="%ZTLOAD^%ZTLOAD1^%ZTLOAD2^%ZTLOAD3^%ZTLOAD4^%ZTLOAD5^%ZTLOAD6^%ZTLOAD7"
"RTN","ZTMGRSET",73,0)
 D MOVE
"RTN","ZTMGRSET",74,0)
 S %S="ZTM^ZTM0^ZTM1^ZTM2^ZTM3^ZTM4^ZTM5^ZTM6"
"RTN","ZTMGRSET",75,0)
 S %D="%ZTM^%ZTM0^%ZTM1^%ZTM2^%ZTM3^%ZTM4^%ZTM5^%ZTM6"
"RTN","ZTMGRSET",76,0)
 D MOVE
"RTN","ZTMGRSET",77,0)
 S %S="ZTMS^ZTMS0^ZTMS1^ZTMS2^ZTMS3^ZTMS4^ZTMS5^ZTMS7^ZTMSH"
"RTN","ZTMGRSET",78,0)
 S %D="%ZTMS^%ZTMS0^%ZTMS1^%ZTMS2^%ZTMS3^%ZTMS4^%ZTMS5^%ZTMS7^%ZTMSH"
"RTN","ZTMGRSET",79,0)
 D MOVE
"RTN","ZTMGRSET",80,0)
 Q
"RTN","ZTMGRSET",81,0)
FM ;Rename the FileMan routines
"RTN","ZTMGRSET",82,0)
 I ZTMODE>0 Q  ;Only ask on full install
"RTN","ZTMGRSET",83,0)
 R !,"Want to rename the FileMan routines: No//",X:600 Q:"Yy"'[$E(X_"N")
"RTN","ZTMGRSET",84,0)
 S %S="DIDT^DIDTC^DIRCR",%D="%DT^%DTC^%RCR"
"RTN","ZTMGRSET",85,0)
 D MOVE
"RTN","ZTMGRSET",86,0)
 Q
"RTN","ZTMGRSET",87,0)
 ;
"RTN","ZTMGRSET",88,0)
ETRAP ;Error Trap
"RTN","ZTMGRSET",89,0)
 S %S="ZTER^ZTER1",%D="%ZTER^%ZTER1"
"RTN","ZTMGRSET",90,0)
 D MOVE
"RTN","ZTMGRSET",91,0)
 Q
"RTN","ZTMGRSET",92,0)
OTHER S %S="ZTPP^ZTP1^ZTPTCH^ZTRDEL^ZTMOVE"
"RTN","ZTMGRSET",93,0)
 S %D="%ZTPP^%ZTP1^%ZTPTCH^%ZTRDEL^%ZTMOVE"
"RTN","ZTMGRSET",94,0)
 D MOVE
"RTN","ZTMGRSET",95,0)
 Q
"RTN","ZTMGRSET",96,0)
DEV S %S="ZIS^ZIS1^ZIS2^ZIS3^ZIS5^ZIS6^ZIS7^ZISC^ZISP^ZISS^ZISS1^ZISS2^ZISTCP^ZISUTL"
"RTN","ZTMGRSET",97,0)
 S %D="%ZIS^%ZIS1^%ZIS2^%ZIS3^%ZIS5^%ZIS6^%ZIS7^%ZISC^%ZISP^%ZISS^%ZISS1^%ZISS2^%ZISTCP^%ZISUTL"
"RTN","ZTMGRSET",98,0)
 D MOVE
"RTN","ZTMGRSET",99,0)
 Q
"RTN","ZTMGRSET",100,0)
RUM ;Build the routines for Capacity Management (CM)
"RTN","ZTMGRSET",101,0)
 S %S=""
"RTN","ZTMGRSET",102,0)
 I ZTOS=1 S %S="ZOSVKRV^ZOSVKSVE^ZOSVKSVS^ZOSVKSD" ;DSM
"RTN","ZTMGRSET",103,0)
 I ZTOS=2 S %S="ZOSVKRM^ZOSVKSME^ZOSVKSMS^ZOSVKSD" ;MSM
"RTN","ZTMGRSET",104,0)
 I ZTOS=3 S %S="ZOSVKRO^ZOSVKSOE^ZOSVKSOS^ZOSVKSD" ;OpenM
"RTN","ZTMGRSET",105,0)
 I ZTOS=7!(ZTOS=8) S %S="ZOSVKRG^ZOSVKSGE^ZOSVKSGS^ZOSVKSD" ;GT.M
"RTN","ZTMGRSET",106,0)
 S %D="%ZOSVKR^%ZOSVKSE^%ZOSVKSS^%ZOSVKSD"
"RTN","ZTMGRSET",107,0)
 D MOVE
"RTN","ZTMGRSET",108,0)
 Q
"RTN","ZTMGRSET",109,0)
ZOSF(X) ;
"RTN","ZTMGRSET",110,0)
 X SCR I $T W ! D @(U_X) W !
"RTN","ZTMGRSET",111,0)
 Q
"RTN","ZTMGRSET",112,0)
1 ;;VAX DSM(V6), VAX DSM(V7)
"RTN","ZTMGRSET",113,0)
 S %S="ZOSVVXD^ZTBKCVXD^ZIS4VXD^ZISFVXD^ZISHVXD^XUCIVXD"
"RTN","ZTMGRSET",114,0)
 D DES,MOVE
"RTN","ZTMGRSET",115,0)
 S %S="ZOSV2VXD^ZTMDCL",%D="%ZOSV2^%ZTMDCL"
"RTN","ZTMGRSET",116,0)
 D MOVE,RUM,ZOSF("ZOSFVXD")
"RTN","ZTMGRSET",117,0)
 Q
"RTN","ZTMGRSET",118,0)
2 ;;MSM-PC/PLUS, MSM for NT or UNIX
"RTN","ZTMGRSET",119,0)
 W !,"- Use autostart to do ZTMB don't resave as STUSER."
"RTN","ZTMGRSET",120,0)
 S %S="ZOSVMSM^ZTBKCMSM^ZIS4MSM^ZISFMSM^ZISHMSM^XUCIMSM"
"RTN","ZTMGRSET",121,0)
 D DES,MOVE
"RTN","ZTMGRSET",122,0)
 S %S="ZOSV2MSM",%D="%ZOSV2"
"RTN","ZTMGRSET",123,0)
 D MOVE,RUM,ZOSF("ZOSFMSM")
"RTN","ZTMGRSET",124,0)
 I $$VERSION^%ZOSV(1)["UNIX" S %S="ZISHMSU",%D="%ZISH" D MOVE
"RTN","ZTMGRSET",125,0)
 Q
"RTN","ZTMGRSET",126,0)
3 ;;Cache (VMS, NT, Linux), OpenM-NT
"RTN","ZTMGRSET",127,0)
 S %S="ZOSVONT^^ZIS4ONT^ZISFONT^ZISHONT^XUCIONT"
"RTN","ZTMGRSET",128,0)
 D DES,MOVE
"RTN","ZTMGRSET",129,0)
 S %S="ZISTCPS^ZTMDCL",%D="%ZISTCPS^%ZTMDCL"
"RTN","ZTMGRSET",130,0)
 D MOVE,RUM,ZOSF("ZOSFONT")
"RTN","ZTMGRSET",131,0)
 Q
"RTN","ZTMGRSET",132,0)
4 ;;Datatree, DTM-PC, DT-MAX
"RTN","ZTMGRSET",133,0)
 S %S="ZOSVDTM^ZTBKCDTM^ZIS4DTM^ZISFDTM^ZISHDTM^XUCIDTM"
"RTN","ZTMGRSET",134,0)
 D DES,MOVE
"RTN","ZTMGRSET",135,0)
 S %S="ZOSV1DTM^ZTMB",%D="%ZOSV1^%ustart"
"RTN","ZTMGRSET",136,0)
 D MOVE,ZOSF("ZOSFDTM")
"RTN","ZTMGRSET",137,0)
 Q
"RTN","ZTMGRSET",138,0)
5 ;;
"RTN","ZTMGRSET",139,0)
6 ;;
"RTN","ZTMGRSET",140,0)
7 ;;GT.M (VMS)
"RTN","ZTMGRSET",141,0)
 S %ZE=".M" D init^%RSEL
"RTN","ZTMGRSET",142,0)
 S %S="ZOSVGTM^^ZIS4GTM^ZISFGTM^ZISHGTM^XUCIGTM"
"RTN","ZTMGRSET",143,0)
 D DES,MOVE
"RTN","ZTMGRSET",144,0)
 S %S="ZOSV2GTM^ZISTCPS^ZTMDCL",%D="%ZOSV2^%ZISTCPS^ZTMDCL"
"RTN","ZTMGRSET",145,0)
 D MOVE,ZOSF("ZOSFGTM")
"RTN","ZTMGRSET",146,0)
 Q
"RTN","ZTMGRSET",147,0)
8 ;;GT.M (Unix)
"RTN","ZTMGRSET",148,0)
 S %ZE=".m" D init^%RSEL
"RTN","ZTMGRSET",149,0)
 S %S="ZOSVGUX^^ZIS4GTM^ZISFGTM^ZISHGTM^XUCIGTM"
"RTN","ZTMGRSET",150,0)
 D DES,MOVE
"RTN","ZTMGRSET",151,0)
 S %S="ZOSV2GTM^ZISTCPS",%D="%ZOSV2^%ZISTCPS"
"RTN","ZTMGRSET",152,0)
 D MOVE,ZOSF("ZOSFGUX")
"RTN","ZTMGRSET",153,0)
 Q
"RTN","ZTMGRSET",154,0)
10 ;;NOT SUPPORTED
"RTN","ZTMGRSET",155,0)
 Q
"RTN","ZTMGRSET",156,0)
MOVE ; rename % routines
"RTN","ZTMGRSET",157,0)
 N %,X,Y,M
"RTN","ZTMGRSET",158,0)
 F %=1:1:$L(%D,"^") D  D MES(M)
"RTN","ZTMGRSET",159,0)
 . S M="",X=$P(%S,U,%) ; from
"RTN","ZTMGRSET",160,0)
 . S Y=$P(%D,U,%) ; to
"RTN","ZTMGRSET",161,0)
 . Q:X=""
"RTN","ZTMGRSET",162,0)
 . S M="Routine: "_$J(X,8)
"RTN","ZTMGRSET",163,0)
 . Q:Y=""  I $T(^@X)=""  S M=M_"  Missing" Q
"RTN","ZTMGRSET",164,0)
 . X SCR Q:'$T
"RTN","ZTMGRSET",165,0)
 . S M=M_" Loaded, "
"RTN","ZTMGRSET",166,0)
 . D COPY(X,Y)
"RTN","ZTMGRSET",167,0)
 . S M=M_"Saved as "_$J(Y,8)
"RTN","ZTMGRSET",168,0)
 Q
"RTN","ZTMGRSET",169,0)
 ;
"RTN","ZTMGRSET",170,0)
COPY(FROM,TO) ;
"RTN","ZTMGRSET",171,0)
 I ZTOS'=7,ZTOS'=8 X "ZL @FROM ZS @TO" Q
"RTN","ZTMGRSET",172,0)
 ;For GT.M below
"RTN","ZTMGRSET",173,0)
 N PATH,COPY,CMD S PATH=$$R
"RTN","ZTMGRSET",174,0)
 S FROM=PATH_FROM_".m"
"RTN","ZTMGRSET",175,0)
 S TO=PATH_$TR(TO,"%","_")_".m"
"RTN","ZTMGRSET",176,0)
 S COPY=$S(ZTOS=7:"COPY",1:"cp")
"RTN","ZTMGRSET",177,0)
 S CMD=COPY_" "_FROM_" "_TO
"RTN","ZTMGRSET",178,0)
 X "ZSYSTEM CMD"
"RTN","ZTMGRSET",179,0)
 Q
"RTN","ZTMGRSET",180,0)
 ;
"RTN","ZTMGRSET",181,0)
R() ; routine directory for GT.M
"RTN","ZTMGRSET",182,0)
 N ZRO X "S ZRO=$ZRO"
"RTN","ZTMGRSET",183,0)
 I ZTOS=7 D  Q $S(ZRO["(":$P($P(ZRO,"(",2),")"),1:ZRO)
"RTN","ZTMGRSET",184,0)
 . S ZRO=$P(ZRO,",")
"RTN","ZTMGRSET",185,0)
 . I ZRO["/SRC=" S ZRO=$P(ZRO,"=",2) Q  ;Source dir
"RTN","ZTMGRSET",186,0)
 . S ZRO=$S(ZRO["/":$P(ZRO,"/"),1:ZRO) Q  ;Source and Obj in same dir
"RTN","ZTMGRSET",187,0)
 I ZTOS=8 Q $P($S(ZRO["(":$P($P(ZRO,"(",2),")"),1:ZRO)," ")_"/" ;Use first source dir.
"RTN","ZTMGRSET",188,0)
 E  Q ""
"RTN","ZTMGRSET",189,0)
 ;
"RTN","ZTMGRSET",190,0)
DES S %D="%ZOSV^%ZTBKC1^%ZIS4^%ZISF^%ZISH^%XUCI" Q
"RTN","ZTMGRSET",191,0)
 ;
"RTN","ZTMGRSET",192,0)
GLOBALS ;Set node zero of file #3.05 & #3.07
"RTN","ZTMGRSET",193,0)
 W !!,"Now, I will check your % globals."
"RTN","ZTMGRSET",194,0)
 W ".........."
"RTN","ZTMGRSET",195,0)
 F %="^%ZIS","^%ZISL","^%ZTER","^%ZUA" S:'$D(@%) @%=""
"RTN","ZTMGRSET",196,0)
 S:$D(^%ZTSK(0))[0 ^%ZTSK(-1)=100,^%ZTSCH=""
"RTN","ZTMGRSET",197,0)
 S Z1=$G(^%ZTSK(-1),-1),Z2=$G(^%ZTSK(0))
"RTN","ZTMGRSET",198,0)
 I Z1'=$P(Z2,"^",3) S:Z1'>0 ^%ZTSK(-1)=+Z2 S ^%ZTSK(0)="TASKS^14.4^"_^%ZTSK(-1)
"RTN","ZTMGRSET",199,0)
 S:$D(^%ZUA(3.05,0))[0 ^%ZUA(3.05,0)="FAILED ACCESS ATTEMPTS LOG^3.05^^"
"RTN","ZTMGRSET",200,0)
 S:$D(^%ZUA(3.07,0))[0 ^%ZUA(3.07,0)="PROGRAMMER MODE LOG^3.07^^"
"RTN","ZTMGRSET",201,0)
 Q
"RTN","ZTMGRSET",202,0)
NAME ;Setup the static names for this system
"RTN","ZTMGRSET",203,0)
MGR W !,"NAME OF MANAGER'S UCI,VOLUME SET: "_^%ZOSF("MGR")_"// " R X:$S($G(DTIME):DTIME,1:9999) I X]"" X ^("UCICHECK") G MGR:0[Y S ^%ZOSF("MGR")=X
"RTN","ZTMGRSET",204,0)
PROD W !,"PRODUCTION (SIGN-ON) UCI,VOLUME SET: "_^%ZOSF("PROD")_"// " R X:$S($G(DTIME):DTIME,1:9999) I X]"" X ^("UCICHECK") G PROD:0[Y S ^%ZOSF("PROD")=X
"RTN","ZTMGRSET",205,0)
VOL W !,"NAME OF VOLUME SET: "_^%ZOSF("VOL")_"//" R X:$S($G(DTIME):DTIME,1:9999) I X]"" S:X?3U ^%ZOSF("VOL")=X I X'?3U W "MUST BE 3 Upper case." G VOL
"RTN","ZTMGRSET",206,0)
 W ! Q
"RTN","ZTMON")
0^6^B9524889
"RTN","ZTMON",1,0)
ZTMON ;SEA/RDS-TaskMan: Option, ZTMON, Part 1 (Main Loop) ;3/21/07  14:36
"RTN","ZTMON",2,0)
 ;;8.0;KERNEL;**118,127,136,355,446**;Jul 10, 1995;Build 36
"RTN","ZTMON",3,0)
 ;
"RTN","ZTMON",4,0)
ENV ;Main Entry Point For Taskman Status Monitor
"RTN","ZTMON",5,0)
 D EN(1) ;Long mode
"RTN","ZTMON",6,0)
 Q
"RTN","ZTMON",7,0)
EN(MODE) ;
"RTN","ZTMON",8,0)
 D HOME^%ZIS N %,%H,X,Y,Z,ZT,ZT1,ZT2,ZT3,ZT4,ZTC,ZTCO,ZTD,ZTENV,ZTH,ZTR,ZTUCI,ZTX,ZTY
"RTN","ZTMON",9,0)
 S U="^" X ^%ZOSF("UCI") S ZTUCI=Y W @IOF
"RTN","ZTMON",10,0)
MON D RUN,STATUS,SCHQ
"RTN","ZTMON",11,0)
 ;Continued in ZTMON1
"RTN","ZTMON",12,0)
 G ^ZTMON1
"RTN","ZTMON",13,0)
 ;
"RTN","ZTMON",14,0)
EN2 ;A shorter monitor
"RTN","ZTMON",15,0)
 D EN(0)
"RTN","ZTMON",16,0)
 Q
"RTN","ZTMON",17,0)
 ;
"RTN","ZTMON",18,0)
RUN ;Evaluate RUN-Node
"RTN","ZTMON",19,0)
 W @IOF,!!,"Checking Taskman."
"RTN","ZTMON",20,0)
 S ZTH=$H,ZTR=$G(^%ZTSCH("RUN"))
"RTN","ZTMON",21,0)
 I ZTR]"" S ZTD=$$DIFF^%ZTM(ZTH,ZTR,0)
"RTN","ZTMON",22,0)
 S ZTY=$S(ZTR="":0,ZTD>20:0,1:1)
"RTN","ZTMON",23,0)
 W ?20,"Current $H=",ZTH,"  (",$$HTE^%ZTLOAD7(ZTH),")"
"RTN","ZTMON",24,0)
 W !,?22,"RUN NODE=",$S(ZTR]"":ZTR,1:"<Undefined>") I ZTR]"" W "  (",$$HTE^%ZTLOAD7(ZTR),")"
"RTN","ZTMON",25,0)
 W !,"Taskman is ",$S(ZTY:"current.",ZTR]"":"late by "_(ZTD-15)_" seconds."_$C(7),1:"")
"RTN","ZTMON",26,0)
 W:$D(^%ZTSCH("STOP")) " shutting down" W:'$D(^%ZTSCH("STATUS")) " not running."_$C(7) W "."
"RTN","ZTMON",27,0)
 Q
"RTN","ZTMON",28,0)
 ;
"RTN","ZTMON",29,0)
STATUS ;Evaluate Status List
"RTN","ZTMON",30,0)
 K X,ZTC S ZT="",ZTH=$$H3^%ZTM($H),ZT2=""
"RTN","ZTMON",31,0)
 ;Tell sub-managers by setting ^%ZTSCH("LOADA",%ZTPAIR)=run^value^time^$J
"RTN","ZTMON",32,0)
 M ZTC("S")=^%ZTSCH("STATUS"),ZTC("L")=^%ZTSCH("LOADA")
"RTN","ZTMON",33,0)
 F  S ZT=$O(ZTC("S",ZT)) Q:ZT=""  S X=ZTC("S",ZT) I $L($P(X,U,3)) S ZTC("D",$P(X,U,3),ZT)=ZT
"RTN","ZTMON",34,0)
 W !,"Checking the Status List:",!,"  Node",?14,"weight  status",?34,"time",?44," $J"
"RTN","ZTMON",35,0)
 S ZT=""
"RTN","ZTMON",36,0)
 F  S ZT=$O(ZTC("D",ZT)),ZT1="" Q:ZT=""  F  S ZT1=$O(ZTC("D",ZT,ZT1)) Q:ZT1=""  D
"RTN","ZTMON",37,0)
 . S %=ZTC("S",ZT1),ZT2=1
"RTN","ZTMON",38,0)
 . W !?1,ZT W ?15,$S($D(ZTC("L",ZT)):$J($P(ZTC("L",ZT),U,2),3),1:""),?22,$P(%,U,2),?31,$$STIME($P(%,U)) W ?44,ZT1,?54,$P(%,U,4)
"RTN","ZTMON",39,0)
 . Q
"RTN","ZTMON",40,0)
 I 'ZT2 W !?5,"The Status List is ",$S(ZTY:"temporarily ",1:""),"empty."
"RTN","ZTMON",41,0)
 Q
"RTN","ZTMON",42,0)
 ;
"RTN","ZTMON",43,0)
SCHQ ;Evaluate Schedule List
"RTN","ZTMON",44,0)
 N X,ZTL
"RTN","ZTMON",45,0)
 W !!,"Checking the Schedule List:"
"RTN","ZTMON",46,0)
 S ZT1=0,ZTCO=0,ZTC=0,ZTH=$$H3^%ZTM($H)
"RTN","ZTMON",47,0)
 S X=$O(^%ZTSCH(0)),ZTL=$$DIFF(ZTH,X,1)
"RTN","ZTMON",48,0)
 F  S ZT1=$O(^%ZTSCH(ZT1)) Q:'ZT1  D
"RTN","ZTMON",49,0)
 . F ZT2=0:0 S ZT2=$O(^%ZTSCH(ZT1,ZT2)) Q:ZT2=""  S ZTC=ZTC+1 I $$DIFF(ZTH,ZT1,1)>0 S ZTCO=ZTCO+1
"RTN","ZTMON",50,0)
 W !?5,"Taskman has ",$S('ZTC:"no",1:ZTC)," task",$S(ZTC'=1:"s",1:"")," scheduled."
"RTN","ZTMON",51,0)
 I ZTC=1 W !?5,"It is ",$S('ZTCO:"not ",1:""),"overdue."
"RTN","ZTMON",52,0)
 I ZTC>1 W !?5,$S('ZTCO:"None",ZTCO=ZTC&(ZTCO=2):"Both",ZTCO=ZTC:"All",1:ZTCO)," of them ",$S(ZTCO=1:"is",1:"are")," overdue." W:ZTCO>10 *7
"RTN","ZTMON",53,0)
 I ZTC>0,ZTL>0 W "  First task is ",ZTL," seconds late."
"RTN","ZTMON",54,0)
 Q
"RTN","ZTMON",55,0)
 ;
"RTN","ZTMON",56,0)
DIFF(N,O,T) ;Diff in sec.
"RTN","ZTMON",57,0)
 Q:$G(T) N-O ;For new seconds times
"RTN","ZTMON",58,0)
 Q N-O*86400-$P(O,",",2)+$P(N,",",2)
"RTN","ZTMON",59,0)
 ;
"RTN","ZTMON",60,0)
STIME(%H) ;Status time
"RTN","ZTMON",61,0)
 I +$H=+%H Q "T@"_$P($$HTE^%ZTLOAD7(%H),"@",2)
"RTN","ZTMON",62,0)
 Q "T-"_($H-%H)_"@"_$P($$HTE^%ZTLOAD7(%H),"@",2)
"RTN","ZTMON1")
0^8^B20595166
"RTN","ZTMON1",1,0)
ZTMON1 ;SEA/RDS-TaskMan: Option, ZTMON, Part 2 (Main Loop) ;2/19/08  13:36
"RTN","ZTMON1",2,0)
 ;;8.0;KERNEL;**36,118,127,275,446**;Jul 10, 1995;Build 36
"RTN","ZTMON1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMON1",4,0)
MON D IO:MODE,JOB,SUB
"RTN","ZTMON1",5,0)
 G DONE
"RTN","ZTMON1",6,0)
 ;
"RTN","ZTMON1",7,0)
IO ;Evaluate Waiting Lists
"RTN","ZTMON1",8,0)
 N X,X1
"RTN","ZTMON1",9,0)
 S ZT1=$$H3($H),ZT2=$G(^%ZTSCH("IO")),ZT=$$DIFF^%ZTMS1(ZT1,+ZT2,1)
"RTN","ZTMON1",10,0)
 W !!,"Checking the IO Lists:" I $D(^%ZTSCH("IO"))>2 W:+ZT2 "  Last TM scan: ",ZT," sec, " W:$P(ZT2,"^",2)]"" "Last Dev: ",$P(ZT2,"^",2)
"RTN","ZTMON1",11,0)
 S ZT1="",ZTT=0
"RTN","ZTMON1",12,0)
I1 S ZT1=$O(^%ZTSCH("IO",ZT1)) I ZT1="" W:ZTT=0 !?5,"There are no tasks waiting for devices." Q
"RTN","ZTMON1",13,0)
 I $D(^%ZTSCH("IO",ZT1))<9 G I1 ;Skip devices without tasks
"RTN","ZTMON1",14,0)
 W !?5,"Device: ",ZT1 S Y=1 I ZT1'=$I S X=ZT1,X1=$G(^%ZTSCH("IO",ZT1)) D DEVOK^%ZOSV
"RTN","ZTMON1",15,0)
 W $S(Y:" is not available,",$D(^%ZTSCH("DEV",ZT1)):" is allocated,",1:" is AVAILABLE,")
"RTN","ZTMON1",16,0)
 S ZTC=0,ZT2="" F ZT=0:0 S ZT2=$O(^%ZTSCH("IO",ZT1,ZT2)),ZT3="" Q:'ZT2  F ZT=0:0 S ZT3=$O(^%ZTSCH("IO",ZT1,ZT2,ZT3)) Q:ZT3=""  S ZTC=ZTC+1,ZTT=1
"RTN","ZTMON1",17,0)
 W " with ",$S(ZTC=1:"one task",1:ZTC_" tasks")," waiting." W:ZTC>50 $C(7)
"RTN","ZTMON1",18,0)
 G I1
"RTN","ZTMON1",19,0)
 ;
"RTN","ZTMON1",20,0)
JOB ;Evaluate Job List
"RTN","ZTMON1",21,0)
 W !!,"Checking the Job List:"
"RTN","ZTMON1",22,0)
 S ZTC=0,ZT1="" F ZT=0:0 S ZT1=$O(^%ZTSCH("JOB",ZT1)),ZT2=0 Q:ZT1=""  F ZT=0:0 S ZT2=$O(^%ZTSCH("JOB",ZT1,ZT2)) Q:'ZT2  S ZTC=ZTC+1
"RTN","ZTMON1",23,0)
 W !?5,"There ",$S(ZTC=0:"are no tasks",ZTC=1:"is 1 task",1:"are "_ZTC_" tasks")," waiting for ",$S(ZTC'=1:"partitions.",1:"a partition.") W:ZTC>20 $C(7)
"RTN","ZTMON1",24,0)
 ;
"RTN","ZTMON1",25,0)
C ;Evaluate Cross CPU list
"RTN","ZTMON1",26,0)
 S ZT1=""
"RTN","ZTMON1",27,0)
 F  S ZT1=$O(^%ZTSCH("C",ZT1)) Q:ZT1=""  S ZTC=+$G(^(ZT1)) D
"RTN","ZTMON1",28,0)
 . S ZTCO=0,ZT2=""
"RTN","ZTMON1",29,0)
 . F  S ZT2=$O(^%ZTSCH("C",ZT1,ZT2)),ZT3=0 Q:ZT2=""  F  S ZT3=$O(^%ZTSCH("C",ZT1,ZT2,ZT3)) Q:ZT3=""  S ZTCO=ZTCO+1
"RTN","ZTMON1",30,0)
 . W !?5,"For ",ZT1," there ",$S(ZTCO=1:"is ",1:"are "),ZTCO," tasks.  "
"RTN","ZTMON1",31,0)
 . W $S(ZTC>8:"Not responding",$$OOS^%ZTM(ZT1):"Out Of Service",'$D(^%ZIS(14.7,"B",ZT1)):"Not defined",1:"")
"RTN","ZTMON1",32,0)
 . Q
"RTN","ZTMON1",33,0)
TASK ;Evaluate Task List
"RTN","ZTMON1",34,0)
 W !!,"Checking the Task List:"
"RTN","ZTMON1",35,0)
 S ZTC=0 F ZT1=0:0 S ZT1=$O(^%ZTSCH("TASK",ZT1)) Q:'ZT1  S ZTC=ZTC+1
"RTN","ZTMON1",36,0)
 W !?5,"There ",$S(ZTC=0:"are no tasks",ZTC=1:"is 1 task",1:"are "_ZTC_" tasks")," currently running."
"RTN","ZTMON1",37,0)
 Q
"RTN","ZTMON1",38,0)
 ;
"RTN","ZTMON1",39,0)
SUB ;Look for idle submanagers
"RTN","ZTMON1",40,0)
 N %N,ZT1,ZT2,ZT3,ZT4
"RTN","ZTMON1",41,0)
 W !,"Checking Sub-Managers:"
"RTN","ZTMON1",42,0)
 I $D(^%ZTSCH("WAIT","SUB")) W !?5,"Sub-Managers told to Wait."
"RTN","ZTMON1",43,0)
 D SUBCHK^%ZTMS5(0)
"RTN","ZTMON1",44,0)
 S %N=""
"RTN","ZTMON1",45,0)
 F  S %N=$O(^%ZTSCH("SUB",%N)) Q:%N=""  D
"RTN","ZTMON1",46,0)
 . S %=$G(^(%N)),ZT4=+$G(^%ZTSCH("LOADA",%N))
"RTN","ZTMON1",47,0)
 . W !?5,"On node ",%N," there ",$S('%:"are no",%=1:"is  1",1:"are "_$J(%,2))," free Sub-Manager(s)."
"RTN","ZTMON1",48,0)
 . W " Status: ",$S($D(^%ZTSCH("STOP","SUB",%N)):"Stop",ZT4:"BWait",1:"Run")
"RTN","ZTMON1",49,0)
 . I $G(^%ZTSCH("SUB",%N,0))>5 W !?10,"SUB-MANAGERS ARE NOT STARTING."
"RTN","ZTMON1",50,0)
 . Q
"RTN","ZTMON1",51,0)
 Q
"RTN","ZTMON1",52,0)
 ;
"RTN","ZTMON1",53,0)
DONE ;Prompt to Quit Or Continue
"RTN","ZTMON1",54,0)
 W !!,"Enter monitor action: UPDATE// "
"RTN","ZTMON1",55,0)
 R ZTR:$S($D(DTIME)#2:DTIME,1:60) S:ZTR="" ZTR="U"
"RTN","ZTMON1",56,0)
 I "Uu"[$E(ZTR) G MON^ZTMON
"RTN","ZTMON1",57,0)
 I "Ee"[$E(ZTR) Q:$$CALL("LIST^XUTMKE")  G DONE
"RTN","ZTMON1",58,0)
 I "Ss"[$E(ZTR) W @IOF X ^%ZOSF("SS") G DONE
"RTN","ZTMON1",59,0)
 I "Pp"[$E(ZTR) W @IOF D PARAMS^ZTMCHK G DONE
"RTN","ZTMON1",60,0)
 I "Rr"[$E(ZTR) W @IOF D RES G DONE
"RTN","ZTMON1",61,0)
 I "Tt"[$E(ZTR) S MODE='MODE W !,"Mode set to ",$S(MODE:"normal",1:"short") G DONE
"RTN","ZTMON1",62,0)
 I ZTR="^"!(ZTR="@") Q
"RTN","ZTMON1",63,0)
 I ZTR'["?" G MON^ZTMON
"RTN","ZTMON1",64,0)
 I ZTR="??" Q:$$CALL("SELECT^XUTMONH")  G MON^ZTMON
"RTN","ZTMON1",65,0)
 W !!?5,"Enter <RETURN> to update the monitor screen."
"RTN","ZTMON1",66,0)
 W !?5,"Enter ^ to exit the monitor."
"RTN","ZTMON1",67,0)
 W !?5,"Enter E to inspect the TaskMan Error file."
"RTN","ZTMON1",68,0)
 W !?5,"Enter P to see taskman parameters."
"RTN","ZTMON1",69,0)
 W !?5,"Enter R to see busy Resource slots."
"RTN","ZTMON1",70,0)
 W !?5,"Enter S to see a system status listing."
"RTN","ZTMON1",71,0)
 W !?5,"Enter ? to see this message."
"RTN","ZTMON1",72,0)
 W !?5,"Enter ?? to inspect the tasks in the monitor's lists."
"RTN","ZTMON1",73,0)
 G DONE
"RTN","ZTMON1",74,0)
 ;
"RTN","ZTMON1",75,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTMON1",76,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTMON1",77,0)
 ;
"RTN","ZTMON1",78,0)
CALL(RTN) ;Check for called routine
"RTN","ZTMON1",79,0)
 N DUOUT
"RTN","ZTMON1",80,0)
 I $D(^DIC(19,0))[0 W !,"In the wrong account." Q 0
"RTN","ZTMON1",81,0)
 D @RTN Q $D(DUOUT)
"RTN","ZTMON1",82,0)
 ;
"RTN","ZTMON1",83,0)
RES ;Check on resource devices
"RTN","ZTMON1",84,0)
 N ZT1,ZT2,ZT3,ZTIM,X
"RTN","ZTMON1",85,0)
 S ZT1=""
"RTN","ZTMON1",86,0)
 F  S ZT1=$O(^%ZTSCH("IO",ZT1)) Q:ZT1=""  I ^%ZTSCH("IO",ZT1)="RES" D
"RTN","ZTMON1",87,0)
 . ;Q:$D(^%ZTSCH("IO",ZT1))<9
"RTN","ZTMON1",88,0)
 . S ZT2=$O(^%ZISL(3.54,"B",ZT1,0)),ZT3=0 Q:ZT2'>0
"RTN","ZTMON1",89,0)
 . S X=$G(^%ZISL(3.54,ZT2,0))
"RTN","ZTMON1",90,0)
 . W !,"Resource ",ZT1,"  Aval. Slots: ",$P(X,U,2)
"RTN","ZTMON1",91,0)
 . F  S ZT3=$O(^%ZISL(3.54,ZT2,1,ZT3)) Q:ZT3'>0  D
"RTN","ZTMON1",92,0)
 . . S X=^%ZISL(3.54,ZT2,1,ZT3,0),ZTIM=$P(X,U,5) I ZTIM]"",ZTIM'["," S ZTIM=$$H0^%ZTM(ZTIM)
"RTN","ZTMON1",93,0)
 . . W !,?10,"Slot: ",$J(ZT3,2)," Job: ",$P(X,U,3)," Task: ",$P(X,U,4)
"RTN","ZTMON1",94,0)
 . . W "  time: ",$$HDIFF^%ZTLOAD7($H,ZTIM,2)
"RTN","ZTMON1",95,0)
 . . Q
"RTN","ZTMON1",96,0)
 . Q
"RTN","ZTMON1",97,0)
 Q
"RTN","ZTMON2")
0^2^B35614836
"RTN","ZTMON2",1,0)
ZTMON2 ;SEA/RDS-TaskMan: Option, ZTMON, Part 1 (Main Loop) ;2/19/08  13:36
"RTN","ZTMON2",2,0)
 ;;8.0;KERNEL;**446**;Jul 10, 1995;Build 36
"RTN","ZTMON2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMON2",4,0)
 ;
"RTN","ZTMON2",5,0)
ENV ;Main Entry Point For Taskman Status Monitor
"RTN","ZTMON2",6,0)
 S U="^"
"RTN","ZTMON2",7,0)
 N %,%H,X,Y,Z,ZT,ZT1,ZT2,ZT3,ZT4,ZTC,ZTCO,ZTD,ZTENV,ZTH,ZTR,ZTUCI,ZTX,ZTY
"RTN","ZTMON2",8,0)
 D HOME^%ZIS
"RTN","ZTMON2",9,0)
 X ^%ZOSF("UCI") S ZTUCI=Y W @IOF
"RTN","ZTMON2",10,0)
 ;
"RTN","ZTMON2",11,0)
RUN ;Evaluate RUN-Node
"RTN","ZTMON2",12,0)
 W @IOF,!,"Checking Taskman."
"RTN","ZTMON2",13,0)
 S ZTH=$H,ZTR=$G(^%ZTSCH("RUN"))
"RTN","ZTMON2",14,0)
 I ZTR>0 S ZTD=$$DIFF^%ZTM(ZTH,ZTR,0)
"RTN","ZTMON2",15,0)
 S ZTY=$S(ZTR="":0,ZTD>15:0,1:1)
"RTN","ZTMON2",16,0)
 W ?20,"Current $H=",ZTH,"  (",$$HTE^%ZTLOAD7(ZTH),")"
"RTN","ZTMON2",17,0)
 W !,?22,"RUN NODE=",$S(ZTR]"":ZTR,1:"<Undefined>") I ZTR]"" W "  (",$$HTE^%ZTLOAD7(ZTR),")"
"RTN","ZTMON2",18,0)
 W !,"Taskman is ",$S(ZTY:"current.",ZTR]"":"late by "_(ZTD-15)_" seconds."_$C(7),$D(^%ZTSCH("STATUS")):"shutting down.",1:"not running."_$C(7))
"RTN","ZTMON2",19,0)
 ;
"RTN","ZTMON2",20,0)
STATUS ;Evaluate Status List
"RTN","ZTMON2",21,0)
 K ZTC S ZT="",ZTH=$$H3^%ZTM($H)
"RTN","ZTMON2",22,0)
 L +^%ZTSCH("LOAD"):0 E  W !,"Did not get a LOCK on ^%ZTSCH(""LOAD"")"
"RTN","ZTMON2",23,0)
 F  S ZT=$O(^%ZTSCH("LOADA",ZT)) Q:ZT=""  S ZTC=^(ZT),ZTC($P(ZTC,U,4))=ZTC
"RTN","ZTMON2",24,0)
 L -^%ZTSCH("LOAD")
"RTN","ZTMON2",25,0)
 W !,"Checking the Status List:",!," Taskman $J  status",?22,"time",?33,"weight node"
"RTN","ZTMON2",26,0)
 S ZT1="" F ZT=0:1 S ZT1=$O(^%ZTSCH("STATUS",ZT1)) Q:ZT1=""  S %=^(ZT1) D
"RTN","ZTMON2",27,0)
 . W !?2,ZT1 W ?13,$P(%,U,2),?22,$$STIME($P(%,U)) W:$D(ZTC(ZT1)) ?32," ",$J($P(ZTC(ZT1),U,2),4) W ?39," ",$P(%,U,3)
"RTN","ZTMON2",28,0)
 . Q
"RTN","ZTMON2",29,0)
 I 'ZT W !?5,"The Status List is ",$S(ZTY:"temporarily ",1:""),"empty."
"RTN","ZTMON2",30,0)
 ;
"RTN","ZTMON2",31,0)
SCHQ ;Evaluate Schedule List
"RTN","ZTMON2",32,0)
 W !!,"Checking the Schedule List:"
"RTN","ZTMON2",33,0)
 S ZT1=$O(^%ZTSCH(0)),ZTH=$$H3^%ZTM($H)
"RTN","ZTMON2",34,0)
 D OVERDUE(ZT1)
"RTN","ZTMON2",35,0)
 S ZT1=0,ZTCO=0,ZTC=0
"RTN","ZTMON2",36,0)
 F ZT=0:0 S ZT1=$O(^%ZTSCH(ZT1)) Q:'ZT1  D
"RTN","ZTMON2",37,0)
 . L +^%ZTSCH(ZT1):0 W:'$T !,?5,"^%ZTSCH(",ZT1,") is locked" L -^%ZTSCH(ZT1)
"RTN","ZTMON2",38,0)
 . F ZT2=0:0 S ZT2=$O(^%ZTSCH(ZT1,ZT2)) Q:ZT2=""  S ZTC=ZTC+1 I $$DIFF^%ZTM(ZTH,ZT1,1)>0 S ZTCO=ZTCO+1
"RTN","ZTMON2",39,0)
 W !?5,"Taskman has ",$S('ZTC:"no",1:ZTC)," task",$S(ZTC'=1:"s",1:"")," scheduled."
"RTN","ZTMON2",40,0)
 I ZTC=1 W !?5,"It is ",$S('ZTCO:"not ",1:""),"overdue."
"RTN","ZTMON2",41,0)
 I ZTC>1 W !?5,$S('ZTCO:"None",ZTCO=ZTC&(ZTCO=2):"Both",ZTCO=ZTC:"All",1:ZTCO)," of them ",$S(ZTCO=1:"is",1:"are")," overdue." W:ZTCO>10 *7
"RTN","ZTMON2",42,0)
 ;
"RTN","ZTMON2",43,0)
CONT ;Continued
"RTN","ZTMON2",44,0)
 D JOB,SUB
"RTN","ZTMON2",45,0)
 G DONE
"RTN","ZTMON2",46,0)
 ;
"RTN","ZTMON2",47,0)
OVERDUE(X1) ;Write how overdue the oldest task is
"RTN","ZTMON2",48,0)
 N ZTH S ZTH=$$H3^%ZTM($H)
"RTN","ZTMON2",49,0)
 I X1>0,X1<ZTH S ZTH=ZTH-X1 W:ZTH>10 "  Overdue by ",ZTH
"RTN","ZTMON2",50,0)
 Q
"RTN","ZTMON2",51,0)
 ;
"RTN","ZTMON2",52,0)
JOB ;Evaluate Job List
"RTN","ZTMON2",53,0)
 W !!,"Checking the Job List:"
"RTN","ZTMON2",54,0)
 S ZT1=$O(^%ZTSCH("JOB",0)) D OVERDUE(ZT1)
"RTN","ZTMON2",55,0)
 L +^%ZTSCH("JOBQ"):0 I '$T D
"RTN","ZTMON2",56,0)
 . W !,"  Did not get the 'JOBQ' lock."
"RTN","ZTMON2",57,0)
 . Q
"RTN","ZTMON2",58,0)
 S ZTC=0,ZT1="" F ZT=0:0 S ZT1=$O(^%ZTSCH("JOB",ZT1)),ZT2=0 Q:ZT1=""  F ZT=0:0 S ZT2=$O(^%ZTSCH("JOB",ZT1,ZT2)) Q:'ZT2  S ZTC=ZTC+1
"RTN","ZTMON2",59,0)
 W !?5,"There ",$S(ZTC=0:"are no tasks",ZTC=1:"is 1 task",1:"are "_ZTC_" tasks")," waiting for ",$S(ZTC'=1:"partitions.",1:"a partition.") W:ZTC>20 $C(7)
"RTN","ZTMON2",60,0)
 L -^%ZTSCH("JOBQ")
"RTN","ZTMON2",61,0)
 ;
"RTN","ZTMON2",62,0)
C ;Evaluate Cross CPU list
"RTN","ZTMON2",63,0)
 S ZT1=""
"RTN","ZTMON2",64,0)
 F  S ZT1=$O(^%ZTSCH("C",ZT1)) Q:ZT1=""  S ZTC=+$G(^(ZT1)) D
"RTN","ZTMON2",65,0)
 . S ZTCO=0,ZT2=""
"RTN","ZTMON2",66,0)
 . F  S ZT2=$O(^%ZTSCH("C",ZT1,ZT2)),ZT3=0 Q:ZT2=""  F  S ZT3=$O(^%ZTSCH("C",ZT1,ZT2,ZT3)) Q:ZT3=""  S ZTCO=ZTCO+1
"RTN","ZTMON2",67,0)
 . W !?5,"For ",ZT1," there ",$S(ZTCO=1:"is ",1:"are "),ZTCO," tasks.  "
"RTN","ZTMON2",68,0)
 . W $S(ZTC>8:"Not responding",$$OOS^%ZTM(ZT1):"Out Of Service",'$D(^%ZIS(14.7,"B",ZT1)):"Not defined",1:"")
"RTN","ZTMON2",69,0)
 . Q
"RTN","ZTMON2",70,0)
TASK ;Evaluate Task List
"RTN","ZTMON2",71,0)
 W !!,"Checking the Task List:"
"RTN","ZTMON2",72,0)
 S ZTC=0 F ZT1=0:0 S ZT1=$O(^%ZTSCH("TASK",ZT1)) Q:'ZT1  S ZTC=ZTC+1
"RTN","ZTMON2",73,0)
 W !?5,"There ",$S(ZTC=0:"are no tasks",ZTC=1:"is 1 task",1:"are "_ZTC_" tasks")," currently running."
"RTN","ZTMON2",74,0)
 Q
"RTN","ZTMON2",75,0)
 ;
"RTN","ZTMON2",76,0)
SUB ;Look for idle submanagers
"RTN","ZTMON2",77,0)
 N %,%N,ZT1,ZT2,ZT3,ZT4,ZT5
"RTN","ZTMON2",78,0)
 W !!,"Sub-manager wait detail:"
"RTN","ZTMON2",79,0)
 S %N="",ZT3=$$H3($H)
"RTN","ZTMON2",80,0)
 F  S %N=$O(^%ZTSCH("SUB",%N)) Q:%N=""  D
"RTN","ZTMON2",81,0)
 . W !,"Node: ",%N
"RTN","ZTMON2",82,0)
 . L +^%ZTSCH("SUB",%N):3 W:'$T !,"Did not get the ^%ZTSCH(""SUB"",",%N,") lock."
"RTN","ZTMON2",83,0)
 . S %=0,ZT1=0,ZT4=$G(^%ZTSCH("LOADA",%N))
"RTN","ZTMON2",84,0)
 . ;W "  Weight: ",$P(ZT4,U,2)
"RTN","ZTMON2",85,0)
 . F  S ZT1=$O(^%ZTSCH("SUB",%N,ZT1)) Q:ZT1'>0  D
"RTN","ZTMON2",86,0)
 . . W !,?5,"Job: ",ZT1
"RTN","ZTMON2",87,0)
 . . L +^%ZTSCH("SUBLK",%N,ZT1):1 I $T D  Q
"RTN","ZTMON2",88,0)
 . . . L -^%ZTSCH("SUBLK",%N,ZT1) Q:'$D(^%ZTSCH("SUB",%N,ZT1))
"RTN","ZTMON2",89,0)
 . . . K ^%ZTSCH("SUB",%N,ZT1)
"RTN","ZTMON2",90,0)
 . . . W " Didn't hold the lock, Removed from table."
"RTN","ZTMON2",91,0)
 . . . Q
"RTN","ZTMON2",92,0)
 . . S ZT5=$G(^(ZT1)),ZT2=$$H3($P(ZT5,U)),ZT3=$$H3($H),ZT5=$P(ZT5,U,2,4)
"RTN","ZTMON2",93,0)
 . . I (ZT2+30)<ZT3 W " Last timestamp >30 sec old, Removed." K ^%ZTSCH("SUB",%N,ZT1) Q
"RTN","ZTMON2",94,0)
 . . S %=%+1 W " ",ZT2-ZT3," ",$S($L(ZT5):" Status: "_ZT5,1:" Looks good.")
"RTN","ZTMON2",95,0)
 . S ^%ZTSCH("SUB",%N)=%
"RTN","ZTMON2",96,0)
 . W !?5,"On node ",%N," there ",$S('%:"are no",%=1:"is  1",1:"are "_$J(%,2))," free Sub-Manager(s)."
"RTN","ZTMON2",97,0)
 . W " ",$S(+ZT4:"Wait",1:"Run")
"RTN","ZTMON2",98,0)
 . I $G(^%ZTSCH("SUB",%N,0))>5 W !?10,"SUB-MANAGERS ARE NOT STARTING."
"RTN","ZTMON2",99,0)
 . L -^%ZTSCH("SUB",%N)
"RTN","ZTMON2",100,0)
 . Q
"RTN","ZTMON2",101,0)
 Q
"RTN","ZTMON2",102,0)
 ;
"RTN","ZTMON2",103,0)
DONE ;Prompt to Quit Or Continue
"RTN","ZTMON2",104,0)
 W !!,"Enter monitor action: UPDATE// "
"RTN","ZTMON2",105,0)
 R ZTR:$S($D(DTIME)#2:DTIME,1:60) S:ZTR="" ZTR="U"
"RTN","ZTMON2",106,0)
 I "Ee"[$E(ZTR) Q:$$CALL("LIST^XUTMKE")  G DONE
"RTN","ZTMON2",107,0)
 I "Ss"[$E(ZTR) W @IOF X ^%ZOSF("SS") G DONE
"RTN","ZTMON2",108,0)
 I "Pp"[$E(ZTR) W @IOF D PARAMS^ZTMCHK G DONE
"RTN","ZTMON2",109,0)
 I "Ll"[$E(ZTR) W !! D LIST G DONE
"RTN","ZTMON2",110,0)
 I "Dd"[$E(ZTR) K ^%ZTSCH("UPDATE"),^%ZTSCH("STATUS") W !!,"OK" H 2
"RTN","ZTMON2",111,0)
 I ZTR="^"!(ZTR="@") Q
"RTN","ZTMON2",112,0)
 I ZTR'["?" G RUN^ZTMON2
"RTN","ZTMON2",113,0)
 I ZTR="??" Q:$$CALL("SELECT^XUTMONH")  G RUN^ZTMON2
"RTN","ZTMON2",114,0)
 W !!?5,"Enter <RETURN> to update the monitor screen."
"RTN","ZTMON2",115,0)
 W !?5,"Enter ^ to exit the monitor."
"RTN","ZTMON2",116,0)
 W !?5,"Enter E to inspect the TaskMan Error file."
"RTN","ZTMON2",117,0)
 W !?5,"Enter L to see task's in JOB pending status"
"RTN","ZTMON2",118,0)
 W !?5,"Enter P to see Taskman parameters"
"RTN","ZTMON2",119,0)
 W !?5,"Enter S to see a system status listing."
"RTN","ZTMON2",120,0)
 W !?5,"Enter D to cause Taskman to ReRead it parameters."
"RTN","ZTMON2",121,0)
 W !?5,"Enter ? to see this message."
"RTN","ZTMON2",122,0)
 W !?5,"Enter ?? to inspect the tasks in the monitor's lists."
"RTN","ZTMON2",123,0)
 G DONE
"RTN","ZTMON2",124,0)
 ;
"RTN","ZTMON2",125,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTMON2",126,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTMON2",127,0)
 ;
"RTN","ZTMON2",128,0)
CALL(RTN) ;Check for called routine
"RTN","ZTMON2",129,0)
 N DUOUT
"RTN","ZTMON2",130,0)
 I $D(^DIC(19,0))[0 W !,"In the wrong account." Q 0
"RTN","ZTMON2",131,0)
 D @RTN Q $D(DUOUT)
"RTN","ZTMON2",132,0)
 ;
"RTN","ZTMON2",133,0)
LIST ;Check for tasks in stat 3.
"RTN","ZTMON2",134,0)
 N ZT1,ZT2
"RTN","ZTMON2",135,0)
 S ZT1=0
"RTN","ZTMON2",136,0)
 F  S ZT1=$O(^%ZTSK(ZT1)) Q:'ZT1  I 3=+$G(^%ZTSK(ZT1,.1),0) D
"RTN","ZTMON2",137,0)
 . D EN^XUTMTP(ZT1)
"RTN","ZTMON2",138,0)
 W "Done",!
"RTN","ZTMON2",139,0)
 Q
"RTN","ZTMON2",140,0)
 ;
"RTN","ZTMON2",141,0)
STIME(%H) ;Status time
"RTN","ZTMON2",142,0)
 I +$H=+%H Q "T@"_$P($$HTE^%ZTLOAD7(%H),"@",2)
"RTN","ZTMON2",143,0)
 Q "T-"_($H-%H)_"@"_$P($$HTE^%ZTLOAD7(%H),"@",2)
"RTN","ZTMS")
0^9^B17897221
"RTN","ZTMS",1,0)
%ZTMS ;SEA/RDS-TaskMan: Submanager, (Entry & Trap) ;09/25/08  16:07
"RTN","ZTMS",2,0)
 ;;8.0;KERNEL;**2,18,24,36,67,94,118,127,136,162,275,446**;Jul 10, 1995;Build 36
"RTN","ZTMS",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMS",4,0)
 ;
"RTN","ZTMS",5,0)
START ;Bottom level of submanager
"RTN","ZTMS",6,0)
 S $ETRAP="D ERROR^%ZTMS HALT"
"RTN","ZTMS",7,0)
 D NOW^%DTC S ZTQUEUED=0,U="^",DT=X
"RTN","ZTMS",8,0)
 D KMPR("$STRT ZTMS$")
"RTN","ZTMS",9,0)
 D PARAMS G:$D(ZTOUT) QUIT
"RTN","ZTMS",10,0)
 I ZTPFLG("XUSCNT") D COUNT^XUSCNT(1)
"RTN","ZTMS",11,0)
 D SETNM^%ZOSV("Sub "_$J)
"RTN","ZTMS",12,0)
 S ^%ZTSCH("SUB",ZTPFLG("HOME"),0)=0
"RTN","ZTMS",13,0)
 I $D(^%ZTSCH("STOP","SUB",ZTPAIR)) G QUIT
"RTN","ZTMS",14,0)
 I ZTPFLG("XUSCNT") D SETLOCK^XUSCNT($NA(^%ZTSCH("SUBLK",ZTPFLG("HOME"),$J)))
"RTN","ZTMS",15,0)
 G SUBMGR^%ZTMS1
"RTN","ZTMS",16,0)
 ;
"RTN","ZTMS",17,0)
KMPR(TAG) ;Call KMPR to log data
"RTN","ZTMS",18,0)
 N Y
"RTN","ZTMS",19,0)
 I +$G(^%ZTSCH("LOGRSRC")) S Y="" X $G(^%ZOSF("UCI")) I Y[^%ZOSF("PROD") D LOGRSRC^%ZOSV(TAG)
"RTN","ZTMS",20,0)
 Q
"RTN","ZTMS",21,0)
QUIT ;Submanager exit
"RTN","ZTMS",22,0)
 D KMPR("$STOP ZTMS$")
"RTN","ZTMS",23,0)
 I ZTPFLG("XUSCNT") D COUNT^XUSCNT(-1)
"RTN","ZTMS",24,0)
 Q
"RTN","ZTMS",25,0)
PARAMS ;
"RTN","ZTMS",26,0)
 ;START--lookup parameters
"RTN","ZTMS",27,0)
 S U="^"
"RTN","ZTMS",28,0)
 X ^%ZOSF("PRIINQ") S %ZTMS("PRIO")=Y ;Get starting priority
"RTN","ZTMS",29,0)
 D GETENV^%ZOSV
"RTN","ZTMS",30,0)
 S ZTCPU=$P(Y,U,2),ZTNODE=$P(Y,U,3),ZTPAIR=$P(Y,U,4),ZTUCI=$P(Y,U)_$S(ZTCPU]"":","_ZTCPU,1:"") S:ZTPAIR[":" ZTNODE=$P(ZTPAIR,":",2)
"RTN","ZTMS",31,0)
 S ZTPFLG("RT")=0,ZTPFLG("MIN")=1,ZTYPE="",ZTPFLG("ZTREQ")=0
"RTN","ZTMS",32,0)
 S ZTPN=$O(^%ZIS(14.7,"B",ZTPAIR,0)),ZTPFLG("ZTPN")=ZTPN
"RTN","ZTMS",33,0)
 I ZTPN>0 S %=$G(^%ZIS(14.7,ZTPN,0)) D
"RTN","ZTMS",34,0)
 . S ZTPFLG("RT")=+$P(%,U,6),ZTYPE=$P(%,U,9) S:$P(%,U,12)>1 ZTPFLG("MIN")=$P(%,U,12)
"RTN","ZTMS",35,0)
 . S ZTPFLG("HOME")=$S($P(%,U,13):$P(^%ZIS(14.7,+$P(%,U,13),0),U),1:ZTPAIR)
"RTN","ZTMS",36,0)
 . S ZTPFLG("ZTREQ")=+$G(^%ZIS(14.7,ZTPN,3))
"RTN","ZTMS",37,0)
 . Q
"RTN","ZTMS",38,0)
 S ZTPFLG("XUSCNT")=0 I ^%ZOSF("OS")["GT.M" S ZTPFLG("XUSCNT")=$L($T(^XUSCNT))
"RTN","ZTMS",39,0)
 S (ZTPFLG("LOCKTM"),ZTLKTM)=+$G(^DD("DILOCKTM"),0) ;p446
"RTN","ZTMS",40,0)
 S ZTPFLG("BalLimit")=$G(^%ZTSCH("BALLIMIT"),100) ;p446
"RTN","ZTMS",41,0)
 S X=0 I $L($T(APFIND^XUSAP)) S X=+$$APFIND^XUSAP("TASKMAN,PROXY USER") ;p446
"RTN","ZTMS",42,0)
 S ZTPFLG("USER")=$S(X>0:X,1:.5) ;p446
"RTN","ZTMS",43,0)
 K ZTMLOG ;Set to log msg about locks
"RTN","ZTMS",44,0)
 I "FO"[ZTYPE S ZTOUT=1 Q  ;SM only run on C,P,G types
"RTN","ZTMS",45,0)
 Q
"RTN","ZTMS",46,0)
ERROR ;START--trap
"RTN","ZTMS",47,0)
 I $S(^%ZOSF("OS")["GT.M":$ZS["STACKO",1:$ZE["STKOVR"!($ZE["STACK")) S $ET="Q:$ST>"_($ST-8)_"  D ERR2^%ZTMS" Q
"RTN","ZTMS",48,0)
 ;set backup trap, prepare to handle error.
"RTN","ZTMS",49,0)
ERR2 S $ETRAP="D ERROR2^%ZTMS0 HALT"
"RTN","ZTMS",50,0)
 S %ZTERLGR=$$LGR^%ZOSV
"RTN","ZTMS",51,0)
 S %ZTME=$$EC^%ZOSV,%ZTMEH=$H
"RTN","ZTMS",52,0)
 S %ZTMETSK=$S($D(%ZTTV)#2:$P(%ZTTV,"^",4),$G(ZTSK)>0:ZTSK,1:0)
"RTN","ZTMS",53,0)
 I %ZTMETSK L ^%ZTSK(%ZTMETSK):99 ;Unlock all other locks
"RTN","ZTMS",54,0)
 I $G(IO)]"" L +^%ZTSCH("DEV",IO):99 ;Keep other tasks from IO device.
"RTN","ZTMS",55,0)
 ;Check if to record error
"RTN","ZTMS",56,0)
 I '$$SCREEN^%ZTER(%ZTME) D
"RTN","ZTMS",57,0)
 . D ^%ZTER ;Kernel error file
"RTN","ZTMS",58,0)
 . ;log error and context in TaskMan Error file
"RTN","ZTMS",59,0)
 . L +^%ZTSCH("ER"):99 H 1 S %ZTMEH=$H
"RTN","ZTMS",60,0)
 . S ^%ZTSCH("ER",+%ZTMEH,$P(%ZTMEH,",",2))=%ZTME
"RTN","ZTMS",61,0)
 . D XREF^%ZTMS0
"RTN","ZTMS",62,0)
 . S ^%ZTSCH("ER",+%ZTMEH,$P(%ZTMEH,",",2),1)=ZTERROX1
"RTN","ZTMS",63,0)
 . L -^%ZTSCH("ER")
"RTN","ZTMS",64,0)
 . Q
"RTN","ZTMS",65,0)
 ;
"RTN","ZTMS",66,0)
 I $D(ZTDEVOK) S $P(^%ZTSCH("IO"),U,2)=ZTDEVOK ;Have others skip dev.
"RTN","ZTMS",67,0)
 ;Update Task file entry
"RTN","ZTMS",68,0)
 I $G(ZTQUEUED),%ZTMETSK,$D(^%ZTSK(%ZTMETSK)) D STATUS^%ZTMS0
"RTN","ZTMS",69,0)
 ;
"RTN","ZTMS",70,0)
 I ZTPFLG("XUSCNT") D COUNT^XUSCNT(-1)
"RTN","ZTMS",71,0)
 I ZTQUEUED>.9,%ZTMETSK>0,$G(DUZ)>.9,$D(^DD(8992,.01,0)) D
"RTN","ZTMS",72,0)
 . S XQA(DUZ)="",XQAMSG="Your task #"_%ZTMETSK_" stopped because of an error",XQADATA=%ZTMETSK,XQAROU="XQA^XUTMUTL"
"RTN","ZTMS",73,0)
 . D SETUP^XQALERT Q
"RTN","ZTMS",74,0)
 ;
"RTN","ZTMS",75,0)
CLEAN ;clean up global data related to this process
"RTN","ZTMS",76,0)
 I $G(ZTQUEUED)>.9,'$D(^%ZTSCH("TASK",ZTQUEUED,"P")) K ^%ZTSCH("TASK",ZTQUEUED)
"RTN","ZTMS",77,0)
 K ^TMP($J),^UTILITY($J),^XUTL("XQ",$J)
"RTN","ZTMS",78,0)
 I '$G(ZTQUEUED) D SUB^%ZTMS1(-1)
"RTN","ZTMS",79,0)
 I $D(ZTDEVN)#2,$D(%ZTIO)#2,%ZTIO]"" D DEVLK^%ZTMS1(-1,%ZTIO)
"RTN","ZTMS",80,0)
 I $D(ZTDEVOK)#2 D DEVBAD^%ZTMS0
"RTN","ZTMS",81,0)
 I $G(ZTSYNCFL)]"" S X=$$SYNCFLG^%ZTMS2("S",ZTSYNCFL,"","Stopped because of an error")
"RTN","ZTMS",82,0)
 ;
"RTN","ZTMS",83,0)
CLOSE ;close i/o device after error
"RTN","ZTMS",84,0)
 D ERCLOZ^%ZTMS0
"RTN","ZTMS",85,0)
 I $G(IO)]"" C IO H 5 ;In case of a port problem give it time to reset.
"RTN","ZTMS",86,0)
 ;
"RTN","ZTMS",87,0)
 D KMPR("$STOP ZTMS$")
"RTN","ZTMS",88,0)
 I ZTQUEUED=.5,%ZTMETSK>0,$P($G(^%ZTSK(%ZTMETSK,.12)),"^")<5 D  ;Only try 5 times
"RTN","ZTMS",89,0)
 . S $P(^(.12),"^")=^%ZTSK(%ZTMETSK,.12)+1
"RTN","ZTMS",90,0)
 . S ^%ZTSCH($$NEWH^%ZTMS2($H,600),%ZTMETSK)=""
"RTN","ZTMS",91,0)
 HALT  ;Start a new process to continue
"RTN","ZTMS",92,0)
 ;
"RTN","ZTMS",93,0)
GTM ;Special entry point for GT.M
"RTN","ZTMS",94,0)
 S @("$ZINTERRUPT=""I $$JOBEXAM^ZU($ZPOSITION)""")
"RTN","ZTMS",95,0)
 G START
"RTN","ZTMS0")
0^16^B6489089
"RTN","ZTMS0",1,0)
%ZTMS0 ;SEA/RDS-TaskMan: Submanager, Part 2 (Trap Functions) ;09/25/08  16:07
"RTN","ZTMS0",2,0)
 ;;8.0;KERNEL;**24,118,275,446**;JUL 10, 1995;Build 36
"RTN","ZTMS0",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMS0",4,0)
 ;
"RTN","ZTMS0",5,0)
ERROR2 ;ERROR--trap
"RTN","ZTMS0",6,0)
 L +^%ZTSCH("ER"):99 H 1 S ZTH=$H
"RTN","ZTMS0",7,0)
 S ^%ZTSCH("ER",+ZTH,$P(ZTH,",",2))=$$EC^%ZOSV
"RTN","ZTMS0",8,0)
 S ^%ZTSCH("ER",+ZTH,$P(ZTH,",",2),1)="Caused by the submanager while trapping an error."
"RTN","ZTMS0",9,0)
 L
"RTN","ZTMS0",10,0)
 X "HALT  " ;HALT JOB
"RTN","ZTMS0",11,0)
 ;
"RTN","ZTMS0",12,0)
STATUS ;ERROR--update task's status in Task File, Call w/ ^%ZTSK locked
"RTN","ZTMS0",13,0)
 S ZTE=$E(%ZTME,1,70)
"RTN","ZTMS0",14,0)
 S ZTE=$TR(ZTE,"^","~")
"RTN","ZTMS0",15,0)
 S $P(^%ZTSK(%ZTMETSK,.1),"^",1,3)=$S(ZTQUEUED>.5:"C^",1:"L^")_$H_"^"_ZTE
"RTN","ZTMS0",16,0)
 S $P(^%ZTSK(%ZTMETSK,.12),"^",2,9)=%ZTMEH_"^"_%ZTME
"RTN","ZTMS0",17,0)
 S ^%ZTSK(%ZTMETSK,.12,%ZTMEH)=%ZTME
"RTN","ZTMS0",18,0)
 Q
"RTN","ZTMS0",19,0)
 ;
"RTN","ZTMS0",20,0)
DEVBAD ;ERROR--dequeue all entries for a bad device
"RTN","ZTMS0",21,0)
 N ZT,ZT1,ZT2,ZT3,ZT4
"RTN","ZTMS0",22,0)
 Q:'$$DEVLK^%ZTMS1(1,ZTDEVOK)
"RTN","ZTMS0",23,0)
 L +^%ZTSCH("IO"):5 G DBX:'$T  S $P(^%ZTSCH("IO"),"^")=$$H3^%ZTM($H)
"RTN","ZTMS0",24,0)
 S ZT2=ZTDEVOK,ZT3=""
"RTN","ZTMS0",25,0)
 F  S ZT3=$O(^%ZTSCH("IO",ZT2,ZT3)),ZT4="" Q:ZT3=""  F  S ZT4=$O(^%ZTSCH("IO",ZT2,ZT3,ZT4)) Q:ZT4=""  L +^%ZTSK(ZT4):99 D DQ L -^%ZTSK(ZT4)
"RTN","ZTMS0",26,0)
 K ^%ZTSCH("IO",ZTDEVOK)
"RTN","ZTMS0",27,0)
 I $O(^%ZTSCH("IO",""))="" K ^%ZTSCH("IO")
"RTN","ZTMS0",28,0)
 L -^%ZTSCH("IO")
"RTN","ZTMS0",29,0)
DBX D DEVLK^%ZTMS1(-1,ZTDEVOK)
"RTN","ZTMS0",30,0)
 Q
"RTN","ZTMS0",31,0)
 ;
"RTN","ZTMS0",32,0)
DQ ;DEVBAD--remove a task from the waiting list for a bad device
"RTN","ZTMS0",33,0)
 K ^%ZTSCH("IO",ZT2,ZT3,ZT4)
"RTN","ZTMS0",34,0)
 S $P(^%ZTSK(ZT4,.1),"^",1,3)="B^"_$H_"^BAD IO DEVICE "_ZT2
"RTN","ZTMS0",35,0)
 K ^%ZTSK(ZT4,.26,ZT2)
"RTN","ZTMS0",36,0)
 I $O(^%ZTSK(ZT4,.26,""))]"" Q
"RTN","ZTMS0",37,0)
 K ^%ZTSK(ZT4,.26)
"RTN","ZTMS0",38,0)
 Q
"RTN","ZTMS0",39,0)
 ;
"RTN","ZTMS0",40,0)
ERCLOZ ;ERROR--close device after error
"RTN","ZTMS0",41,0)
 ;N %ZT1 S %ZT1=(IO=$G(^XUTL("XQ",$J,"IO")))
"RTN","ZTMS0",42,0)
 I $L($G(IO)) S IO("C")="" D ^%ZISC ;Close the current device
"RTN","ZTMS0",43,0)
 ;I $G(^XUTL("XQ",$J,"IO"))'=$I D ERC2
"RTN","ZTMS0",44,0)
 I $L(IO),$D(IO(1,IO)) S IO("C")="" D ^%ZISC ;Close a second device open
"RTN","ZTMS0",45,0)
 Q
"RTN","ZTMS0",46,0)
 ;
"RTN","ZTMS0",47,0)
ERC2 ;Close original Device
"RTN","ZTMS0",48,0)
 N POP
"RTN","ZTMS0",49,0)
 S POP=1 D RESETVAR^%ZIS Q:POP
"RTN","ZTMS0",50,0)
 ;S IOS=$P(%ZTTV,"^",2),(IO,IO(0))=$P(%ZTTV,"^",5),IOT=$P(%ZTTV,"^",6),IOF=$P(%ZTTV,"^",11),IOST=$P(%ZTTV,"^",12),IO("C")=""
"RTN","ZTMS0",51,0)
 I $D(IO(1,IO)) S IO("C")="" D ^%ZISC
"RTN","ZTMS0",52,0)
 Q
"RTN","ZTMS0",53,0)
 ;
"RTN","ZTMS0",54,0)
XREF ;ERROR--cross-reference TaskMan Error file entry by context of error
"RTN","ZTMS0",55,0)
 S ZTERROX=$S('%ZTMETSK:"an unknown task.",1:"Task # "_%ZTMETSK_".")
"RTN","ZTMS0",56,0)
 S ZTQUEUED=$G(ZTQUEUED)
"RTN","ZTMS0",57,0)
 I ZTQUEUED=0 S ZTERROX1="Caused by the submanager." Q
"RTN","ZTMS0",58,0)
 I ZTQUEUED=.5 S ZTERROX1="Caused by the submanager while preparing "_ZTERROX Q
"RTN","ZTMS0",59,0)
 I ZTQUEUED=.6 S ZTERROX1="Caused by submanager after "_ZTERROX Q
"RTN","ZTMS0",60,0)
 S ZTERROX1="Caused by "_ZTERROX
"RTN","ZTMS0",61,0)
 Q
"RTN","ZTMS0",62,0)
 ;
"RTN","ZTMS1")
0^5^B35620816
"RTN","ZTMS1",1,0)
%ZTMS1 ;SEA/RDS-TaskMan: Submanager, (Loop & Get Task) ;10/07/08  15:46
"RTN","ZTMS1",2,0)
 ;;8.0;KERNEL;**36,49,104,118,127,136,275,446**;JUL 10, 1995;Build 36
"RTN","ZTMS1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMS1",4,0)
 ;Use ZTLKTM for Lock timeout. p446
"RTN","ZTMS1",5,0)
SUBMGR ;START--outer submanager loop
"RTN","ZTMS1",6,0)
 D GETTASK G:ZTSK'>0 QUIT^%ZTMS ;task locked
"RTN","ZTMS1",7,0)
 S STATUS="Run Task "_ZTSK
"RTN","ZTMS1",8,0)
 D PROCESS^%ZTMS2 G:$D(ZTQUIT) QUIT^%ZTMS
"RTN","ZTMS1",9,0)
 S STATUS="Idle"
"RTN","ZTMS1",10,0)
 G SUBMGR
"RTN","ZTMS1",11,0)
 ;
"RTN","ZTMS1",12,0)
GETTASK ;SUBMGR--retain the partition; check Waiting Lists every 1 seconds
"RTN","ZTMS1",13,0)
 D SUB(1) S ZTSK=0
"RTN","ZTMS1",14,0)
 ;
"RTN","ZTMS1",15,0)
 F ZRT=0:0 D  Q:$$EXIT  S %=$S($O(^%ZTSCH("JOB",0))>0:1,1:$$FIRST()),ZRT=ZRT+% H % ;Space out the SM loop
"RTN","ZTMS1",16,0)
 . I $D(^%ZTSCH("WAIT","SUB")) S STATUS="Wait Node" H 5 Q  ;Wait
"RTN","ZTMS1",17,0)
 . S %ZTIME=$$H3($H),ZTSK=0 I $D(^%ZTSCH("STOP","SUB",ZTPAIR)) Q
"RTN","ZTMS1",18,0)
 . D C Q:ZTSK!(ZTYPE="C")  ;Do directed work before check for balance
"RTN","ZTMS1",19,0)
 . ;If more than xx tasks in JOB Queue don't balance wait. p446
"RTN","ZTMS1",20,0)
 . I $$BALANCE S ZRT=ZRT-.9,STATUS="Balance Wait" I $$JCNT(ZTPFLG("BalLimit")) Q  ;Wait for balance, Slow ZRT rise.
"RTN","ZTMS1",21,0)
 . D JOB,IOQ:'ZTSK ;Look for work
"RTN","ZTMS1",22,0)
 . Q
"RTN","ZTMS1",23,0)
 D SUB(-1) ;Adjust counter
"RTN","ZTMS1",24,0)
 Q
"RTN","ZTMS1",25,0)
 ;
"RTN","ZTMS1",26,0)
EXIT() ;GETTASK--decide whether to exit retention loop
"RTN","ZTMS1",27,0)
 I ZTSK,$D(^%ZTSCH("NO-OPTION")),$P(^%ZTSK(ZTSK,0),"^",1,2)="ZTSK^XQ1" D
"RTN","ZTMS1",28,0)
 . D SCHTM^%ZTMS2(ZTDTH+60) S ZTSK=0
"RTN","ZTMS1",29,0)
 . Q
"RTN","ZTMS1",30,0)
 I ZTSK G YES
"RTN","ZTMS1",31,0)
 I $D(^%ZTSCH("STOP","SUB",ZTPAIR)) G YES
"RTN","ZTMS1",32,0)
 I ZTPFLG("RT")>ZRT G NO ;Retention time check
"RTN","ZTMS1",33,0)
 I $$SUB(0)>ZTPFLG("MIN") G YES ;Let extras go
"RTN","ZTMS1",34,0)
NO ;Don't exit, Update status node
"RTN","ZTMS1",35,0)
 L +^%ZTSCH("SUB",ZTPFLG("HOME"),$J):10 ;p446
"RTN","ZTMS1",36,0)
 S ^%ZTSCH("SUB",ZTPFLG("HOME"),$J)=$H_"^"_$G(STATUS)_"^"_$G(STATUS("Bal")) ;Keep our node current
"RTN","ZTMS1",37,0)
 I ZTPFLG("XUSCNT") D SETLOCK^XUSCNT($NA(^%ZTSCH("SUBLK",ZTPFLG("HOME"),$J)))
"RTN","ZTMS1",38,0)
 L -^%ZTSCH("SUB",ZTPFLG("HOME"),$J) ;p446
"RTN","ZTMS1",39,0)
 Q 0
"RTN","ZTMS1",40,0)
 ;
"RTN","ZTMS1",41,0)
YES ;EXIT--Yes ;p446
"RTN","ZTMS1",42,0)
 Q 1
"RTN","ZTMS1",43,0)
 ;
"RTN","ZTMS1",44,0)
C ;GETTASK--On C type volume sets, get tasks from Cross-Volume Job List
"RTN","ZTMS1",45,0)
 S STATUS="C List",ZTSK=0
"RTN","ZTMS1",46,0)
 I $O(^%ZTSCH("C",ZTPAIR,0))="" Q
"RTN","ZTMS1",47,0)
 L +^%ZTSCH("C",ZTPAIR):ZTLKTM I '$T S STATUS="No C Lock" Q
"RTN","ZTMS1",48,0)
 S ZTDTH="",^%ZTSCH("C",ZTPAIR)=0
"RTN","ZTMS1",49,0)
 F  S ZTDTH=$O(^%ZTSCH("C",ZTPAIR,ZTDTH)),ZTSK=0 Q:ZTDTH=""  D  Q:ZTSK
"RTN","ZTMS1",50,0)
 . F  S ZTSK=$O(^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK)),ZX=0 Q:ZTSK=""  D  Q:ZX
"RTN","ZTMS1",51,0)
 .. I $D(^%ZTSK(ZTSK,0))[0!'ZTSK D  Q
"RTN","ZTMS1",52,0)
 ... I ZTSK'=0,$D(^%ZTSK(ZTSK)) D TSKSTAT("I")
"RTN","ZTMS1",53,0)
 ... K ^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK) S ZTSK=0
"RTN","ZTMS1",54,0)
 ... Q
"RTN","ZTMS1",55,0)
 .. L +^%ZTSK(ZTSK):0 Q:'$T
"RTN","ZTMS1",56,0)
 .. S %ZTIO=^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK),ZTQUEUED=.5
"RTN","ZTMS1",57,0)
 .. I %ZTIO]"" S ZTDEVN=1
"RTN","ZTMS1",58,0)
 .. K ^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK)
"RTN","ZTMS1",59,0)
 .. S ZX=1
"RTN","ZTMS1",60,0)
 .. Q
"RTN","ZTMS1",61,0)
 . Q
"RTN","ZTMS1",62,0)
 L -^%ZTSCH("C",ZTPAIR) ;If ZTSK>0 then ^%ZTSK(ztsk) is locked.
"RTN","ZTMS1",63,0)
 Q
"RTN","ZTMS1",64,0)
 ;
"RTN","ZTMS1",65,0)
BALANCE() ;GETTASK--check load balance, and wait while Manager waits
"RTN","ZTMS1",66,0)
 Q:ZTPAIR="" 0
"RTN","ZTMS1",67,0)
 S STATUS("Bal")=0
"RTN","ZTMS1",68,0)
 ;Try and Lock so we are synced. If can't get Lock run. ;p446
"RTN","ZTMS1",69,0)
 L +^%ZTSCH("LOADA"):0
"RTN","ZTMS1",70,0)
 I $T S STATUS("Bal")=+$G(^%ZTSCH("LOADA",ZTPAIR)) L -^%ZTSCH("LOADA")
"RTN","ZTMS1",71,0)
 I STATUS("Bal") H 1 ;Added set var & Hang. p446
"RTN","ZTMS1",72,0)
 Q STATUS("Bal")
"RTN","ZTMS1",73,0)
 ;
"RTN","ZTMS1",74,0)
JOB ;GETTASK--search Partition Waiting List
"RTN","ZTMS1",75,0)
 S ZTSK=0,ZTDTH=0,ZTQUEUED=0,STATUS="JOB Q"
"RTN","ZTMS1",76,0)
 L +^%ZTSCH("JOBQ"):ZTLKTM I '$T S STATUS="No JOBQ Lock" Q
"RTN","ZTMS1",77,0)
J2 S ZTDTH=$O(^%ZTSCH("JOB",ZTDTH)),ZTSK=0 I ZTDTH="" L -^%ZTSCH("JOBQ") Q
"RTN","ZTMS1",78,0)
J3 S ZTSK=$O(^%ZTSCH("JOB",ZTDTH,ZTSK)),ZTQUEUED=0 I ZTSK'>0 G J2
"RTN","ZTMS1",79,0)
 L +^%ZTSK(ZTSK):0 I '$T S STATUS="No ZTSK Lock" G J3 ;p446 Back to 0
"RTN","ZTMS1",80,0)
 I $D(^%ZTSCH("JOB",ZTDTH,ZTSK))[0 L -^%ZTSK(ZTSK) S STATUS="JOB cleared" G J3
"RTN","ZTMS1",81,0)
 I $D(^%ZTSK(ZTSK,0))[0 D BADTASK L -^%ZTSK(ZTSK) G J3
"RTN","ZTMS1",82,0)
 S %ZTIO=^%ZTSCH("JOB",ZTDTH,ZTSK),ZTQUEUED=.5,STATUS="Work Task "_ZTSK
"RTN","ZTMS1",83,0)
 K ^%ZTSCH("JOB",ZTDTH,ZTSK)
"RTN","ZTMS1",84,0)
 L -^%ZTSCH("JOBQ") ;Now can release JOBQ
"RTN","ZTMS1",85,0)
 ;try and only pick up work for this node.
"RTN","ZTMS1",86,0)
 S ZTREC=$G(^%ZTSK(ZTSK,0)),%=$P(ZTREC,U,14) I %[":",%'[ZTNODE D  ;p446
"RTN","ZTMS1",87,0)
 . L +^%ZTSCH("C",%):99 ;p446
"RTN","ZTMS1",88,0)
 . S ^%ZTSCH("C",%,ZTDTH,ZTSK)=%ZTIO
"RTN","ZTMS1",89,0)
 . L -^%ZTSCH("C",%),-^%ZTSK(ZTSK) ;p446
"RTN","ZTMS1",90,0)
 . S ZTSK=0,%ZTIO="" ;p446
"RTN","ZTMS1",91,0)
 . Q
"RTN","ZTMS1",92,0)
 I %ZTIO'="" S ZTDEVN=1
"RTN","ZTMS1",93,0)
 ;On exit we have ^%ZTSK(ZTSK) Locked if ZTSK>0.
"RTN","ZTMS1",94,0)
 Q
"RTN","ZTMS1",95,0)
 ;
"RTN","ZTMS1",96,0)
BADTASK ;JOB--unschedule tasks with bad numbers or incomplete records
"RTN","ZTMS1",97,0)
 S %ZTIO=^%ZTSCH("JOB",ZTDTH,ZTSK) I %ZTIO]"" S ZTDEVN=1
"RTN","ZTMS1",98,0)
 I ZTSK'=0,$D(^%ZTSK(ZTSK)) D TSKSTAT("I",3)
"RTN","ZTMS1",99,0)
 K ^%ZTSCH("JOB",ZTDTH,ZTSK)
"RTN","ZTMS1",100,0)
 S ZTQUEUED=0
"RTN","ZTMS1",101,0)
 I %ZTIO]"" D DEVLK(-1,%ZTIO)
"RTN","ZTMS1",102,0)
 Q
"RTN","ZTMS1",103,0)
 ;
"RTN","ZTMS1",104,0)
IOQ ;GETTASK--search Device Waiting List, Lock IO then DEV.
"RTN","ZTMS1",105,0)
 S ZTSK=0 I '$D(^%ZTSCH("IO")) Q
"RTN","ZTMS1",106,0)
 ;Lock to just to get last scan
"RTN","ZTMS1",107,0)
 L +^%ZTSCH("IO"):ZTLKTM I '$T S STATUS="No IO Lock" Q
"RTN","ZTMS1",108,0)
 S ZTI=$G(^%ZTSCH("IO")),ZTH=%ZTIME,%ZTIO=$P(ZTI,"^",2)
"RTN","ZTMS1",109,0)
 I $$I1() S ^%ZTSCH("IO")=ZTH_"^"_%ZTIO ;See if need to update
"RTN","ZTMS1",110,0)
 L -^%ZTSCH("IO") ;Update p446
"RTN","ZTMS1",111,0)
 Q
"RTN","ZTMS1",112,0)
 ;
"RTN","ZTMS1",113,0)
I1() ;Keep 2 sec apart
"RTN","ZTMS1",114,0)
 N ZTDEVOK,X1
"RTN","ZTMS1",115,0)
 I $$PDIFF(%ZTIME,+ZTI,1)'>1 Q 0 ;
"RTN","ZTMS1",116,0)
I2 S %ZTIO=$O(^%ZTSCH("IO",%ZTIO)),ZTDTH="" I %ZTIO="" G IOX
"RTN","ZTMS1",117,0)
 I $D(^%ZTSCH("IO",%ZTIO))<9 G I2
"RTN","ZTMS1",118,0)
 S IOT=^%ZTSCH("IO",%ZTIO)
"RTN","ZTMS1",119,0)
 I IOT'["RES" G I2:'$$DEVLK(1,%ZTIO) ;lock device if not Resource.
"RTN","ZTMS1",120,0)
 I '$D(^%ZTSCH("DEVTRY",%ZTIO)) S ^%ZTSCH("DEVTRY",%ZTIO)=%ZTIME ;Set problem device check
"RTN","ZTMS1",121,0)
 S X=%ZTIO,X1=IOT,ZTDEVOK=X D DEVOK^%ZOSV I Y D DEVLK(-1,%ZTIO) G I2
"RTN","ZTMS1",122,0)
I3 S ZTDTH=$O(^%ZTSCH("IO",%ZTIO,ZTDTH)),ZTSK=0 I ZTDTH="" D DEVLK(-1,%ZTIO) G I2
"RTN","ZTMS1",123,0)
I5 S ZTSK=$O(^%ZTSCH("IO",%ZTIO,ZTDTH,ZTSK)) I ZTSK'>0 G I3
"RTN","ZTMS1",124,0)
 L +^%ZTSK(ZTSK):0 G I5:('$T)
"RTN","ZTMS1",125,0)
 S ZTQUEUED=.5 D DQ^%ZTM4 I $G(^%ZTSK(ZTSK,0))="" L -^%ZTSK(ZTSK) G I5
"RTN","ZTMS1",126,0)
 S ZTH=%ZTIME-20 ;Leave ^%ZTSCH("DEV",io) locked, Released in %ZTMS2
"RTN","ZTMS1",127,0)
IOX ;
"RTN","ZTMS1",128,0)
 Q 1
"RTN","ZTMS1",129,0)
 ;
"RTN","ZTMS1",130,0)
DEVLK(X,ZIO,TO) ;1=Lock/-1=unlock the ^%ZTSCH("DEV",ZIO) node.
"RTN","ZTMS1",131,0)
 I X<0 L -^%ZTSCH("DEV",ZIO) Q
"RTN","ZTMS1",132,0)
 L +^%ZTSCH("DEV",ZIO):+$G(TO,ZTLKTM) I '$T Q 0
"RTN","ZTMS1",133,0)
 Q 1
"RTN","ZTMS1",134,0)
 ;
"RTN","ZTMS1",135,0)
SUB(X) ;Inc/Dec SUB or return SUB count
"RTN","ZTMS1",136,0)
 N % L +^%ZTSCH("SUB",ZTPFLG("HOME")):5
"RTN","ZTMS1",137,0)
 S %=+$G(^%ZTSCH("SUB",ZTPFLG("HOME"))) S:%<1 %=0
"RTN","ZTMS1",138,0)
 I X>0 D
"RTN","ZTMS1",139,0)
 . L +^%ZTSCH("SUBLK",ZTPFLG("HOME"),$J):5 ;p446
"RTN","ZTMS1",140,0)
 . S ^%ZTSCH("SUB",ZTPFLG("HOME"))=%+1,^%ZTSCH("SUB",ZTPFLG("HOME"),$J)=$H_"^"_$G(STATUS)
"RTN","ZTMS1",141,0)
 . Q
"RTN","ZTMS1",142,0)
 I X<0 D
"RTN","ZTMS1",143,0)
 . S ^%ZTSCH("SUB",ZTPFLG("HOME"))=$S(%>0:%-1,1:0) K ^%ZTSCH("SUB",ZTPFLG("HOME"),$J)
"RTN","ZTMS1",144,0)
 . L -^%ZTSCH("SUBLK",ZTPFLG("HOME"),$J) ;p446
"RTN","ZTMS1",145,0)
 . Q
"RTN","ZTMS1",146,0)
 L -^%ZTSCH("SUB",ZTPFLG("HOME"))
"RTN","ZTMS1",147,0)
 Q:X=0 % Q
"RTN","ZTMS1",148,0)
 ;
"RTN","ZTMS1",149,0)
JCNT(MAXWAIT) ;See if less that MaxWait tasks in JOB list p446
"RTN","ZTMS1",150,0)
 N Z2,Z3 S Z3=$NA(^%ZTSCH("JOB"))
"RTN","ZTMS1",151,0)
 F Z2=1:1:MAXWAIT+1 S Z3=$Q(@Z3) Q:Z3'["JOB"
"RTN","ZTMS1",152,0)
 Q (MAXWAIT>Z2)
"RTN","ZTMS1",153,0)
 ;
"RTN","ZTMS1",154,0)
PDIFF(N,O,T) ;Positive Diff
"RTN","ZTMS1",155,0)
 Q $TR($$DIFF(N,O,$G(T)),"-")
"RTN","ZTMS1",156,0)
 ;
"RTN","ZTMS1",157,0)
DIFF(N,O,T) ;Diff in sec.
"RTN","ZTMS1",158,0)
 Q:$G(T) N-O ;For new seconds times
"RTN","ZTMS1",159,0)
 Q N-O*86400-$P(O,",",2)+$P(N,",",2)
"RTN","ZTMS1",160,0)
 ;
"RTN","ZTMS1",161,0)
TSKSTAT(CODE,MSG) ;Update task's status
"RTN","ZTMS1",162,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,4)=$G(CODE)_U_$H_U_$G(MSG)_U_$J
"RTN","ZTMS1",163,0)
 Q
"RTN","ZTMS1",164,0)
 ;
"RTN","ZTMS1",165,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTMS1",166,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTMS1",167,0)
H0(%) ;Covert from seconds to $H
"RTN","ZTMS1",168,0)
 Q (%\86400)_","_(%#86400)
"RTN","ZTMS1",169,0)
 ;
"RTN","ZTMS1",170,0)
FIRST() ;See if SM with lowest $J
"RTN","ZTMS1",171,0)
 I $O(^%ZTSCH("SUB",ZTPFLG("HOME"),0))=$J Q 1
"RTN","ZTMS1",172,0)
 Q 2
"RTN","ZTMS2")
0^15^B23695749
"RTN","ZTMS2",1,0)
%ZTMS2 ;SEA/RDS-TaskMan: Submanager, Part 4 (Unload, Get Device) ;2/19/08  13:38
"RTN","ZTMS2",2,0)
 ;;8.0;KERNEL;**2,18,23,36,67,118,127,163,167,175,199,275,446**;Jul 10, 1995;Build 36
"RTN","ZTMS2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMS2",4,0)
 ;
"RTN","ZTMS2",5,0)
 ;^%ZTSK(ZTSK),^%ZTSCH("DEV",IO) is locked on entry or return from GETNEXT
"RTN","ZTMS2",6,0)
PROCESS ;SUBMGR--process task and all others waiting for same device
"RTN","ZTMS2",7,0)
 L +^%ZTSCH("TASK",ZTSK):1 I '$T Q  ;Only allow one copy of a task at one time
"RTN","ZTMS2",8,0)
 D LOOKUP I $D(ZTREJECT) Q
"RTN","ZTMS2",9,0)
 D DEVICE
"RTN","ZTMS2",10,0)
 I POP L  Q  ;Release all locks
"RTN","ZTMS2",11,0)
 I ZTSYNCFL]"",'$$SYNCFLG("A",ZTSYNCFL,%ZTIO) D  Q
"RTN","ZTMS2",12,0)
 . D SYNCQ(ZTSYNCFL,%ZTIO,ZTDTH,ZTSK),^%ZISC L  ;Release all locks
"RTN","ZTMS2",13,0)
 . Q
"RTN","ZTMS2",14,0)
 ;Go run task
"RTN","ZTMS2",15,0)
 D TASK^%ZTMS3 I ZTYPE="C"!$D(ZTNONEXT) Q
"RTN","ZTMS2",16,0)
 D GETNEXT^%ZTMS7 I $D(ZTNONEXT)!$D(ZTQUIT) Q
"RTN","ZTMS2",17,0)
 G PROCESS
"RTN","ZTMS2",18,0)
 ;
"RTN","ZTMS2",19,0)
LOOKUP ;PROCESS--unload task, switch ucis, and test entry routine
"RTN","ZTMS2",20,0)
 K (%ZTIME,%ZTIO,DT,IO,U,ZTCPU,ZTDEVN,ZTDTH,ZTNODE,ZTPAIR,ZTPFLG,ZTQUEUED,ZTSK,ZTUCI,ZTYPE,ZTLKTM) ;p446
"RTN","ZTMS2",21,0)
 D TSKSTAT(4,"")
"RTN","ZTMS2",22,0)
 S ZTREC=^%ZTSK(ZTSK,0),ZTREC02=^(.02)
"RTN","ZTMS2",23,0)
 S ZTREC2=^%ZTSK(ZTSK,.2),ZTREC21=^(.21),ZTREC25=^(.25)
"RTN","ZTMS2",24,0)
 S ZTSYNCFL=$P(ZTREC2,"^",7),DUZ=+$P(ZTREC,U,3),DUZ(0)="@"
"RTN","ZTMS2",25,0)
 S X=$P(ZTREC02,U)_","_$P(ZTREC02,U,2)
"RTN","ZTMS2",26,0)
 I $P(ZTREC02,U,4) S $P(X,",",2)=ZTCPU
"RTN","ZTMS2",27,0)
 ;should do a check to see if X is OK, Should check UCI mapping.
"RTN","ZTMS2",28,0)
 I X'=ZTUCI S ZTUCI=X D SWAP^%XUCI
"RTN","ZTMS2",29,0)
 S X=$P($P(ZTREC,U,2),"("),ZTRTN=$P(ZTREC,U,1,2)
"RTN","ZTMS2",30,0)
 I $E(X)'="%",$L(X) X ^%ZOSF("TEST") I X=""!'$T D REJECT S ZTREJECT=""
"RTN","ZTMS2",31,0)
 Q
"RTN","ZTMS2",32,0)
 ;
"RTN","ZTMS2",33,0)
REJECT ;LOOKUP--entry routine isn't here; reject task
"RTN","ZTMS2",34,0)
 N Y X ^%ZOSF("UCI")
"RTN","ZTMS2",35,0)
 D TSKSTAT("B","No routine at destination "_Y_".")
"RTN","ZTMS2",36,0)
 I $D(ZTDEVN) D DEVLK^%ZTMS1(-1,%ZTIO) K ZTDEVN
"RTN","ZTMS2",37,0)
 L  Q  ;Clear all locks
"RTN","ZTMS2",38,0)
 ;
"RTN","ZTMS2",39,0)
DEVICE ;PROCESS--prepare requested device; if can't, make task wait
"RTN","ZTMS2",40,0)
 ;First clean-up all IO variables that could influence the device
"RTN","ZTMS2",41,0)
 K %ZIS,IO,IOCPU,IOHG,IOPAR,IOUPAR,IOS
"RTN","ZTMS2",42,0)
 ;If don't need a device, Setup minimum.
"RTN","ZTMS2",43,0)
 S ZTIO=$P(ZTREC2,U),ZTIOT=$P(ZTREC2,U,3)
"RTN","ZTMS2",44,0)
 I ZTIO="" S (IO,IO(0),IOF,IOM,ION,IOS,IOSL,IOST,IOT)="",POP=0 Q
"RTN","ZTMS2",45,0)
 ;
"RTN","ZTMS2",46,0)
 ;setup call
"RTN","ZTMS2",47,0)
 S %ZIS="LRS0"_$S($P(ZTREC2,U,5)="DIRECT":"D",1:"")
"RTN","ZTMS2",48,0)
 S:ZTIOT="HFS" %ZIS("HFSIO")=$P(ZTREC2,U,6),%ZIS("IOPAR")=ZTREC25
"RTN","ZTMS2",49,0)
 S:ZTIOT="MT" %ZIS("IOPAR")=ZTREC25
"RTN","ZTMS2",50,0)
 S (IO,IO(0))=%ZTIO,IOP=ZTIO
"RTN","ZTMS2",51,0)
 S:'$D(^%ZTSCH("DEVTRY",$P(ZTIO,";"))) ^($P(ZTIO,";"))=%ZTIME ;Set problem device check
"RTN","ZTMS2",52,0)
 K ^XUTL("XQ",$J),IO("ERROR")
"RTN","ZTMS2",53,0)
 ;
"RTN","ZTMS2",54,0)
 S:$P(ZTREC2,U,4)["MINIOUT" %ZISLOCK="^%ZTSCH(""NETMAIL"",IO)" ;The hang is on the close
"RTN","ZTMS2",55,0)
 ;call
"RTN","ZTMS2",56,0)
 S %ZISTO=3 D ^%ZIS K %ZISTO,%ZISLOCK ;See that we use a timeout.
"RTN","ZTMS2",57,0)
 I %ZTIO]"" D DEVLK^%ZTMS1(-1,%ZTIO) K ZTDEVN
"RTN","ZTMS2",58,0)
 I 'POP K ^%ZTSCH("DEVTRY",IO),^($P(ZTIO,";")) ;Clear problem device check
"RTN","ZTMS2",59,0)
 ;Reset %ZTIO if IO doesn't match
"RTN","ZTMS2",60,0)
 I 'POP,%ZTIO]"",IO'=%ZTIO C %ZTIO K IO(1,%ZTIO),^%ZTSCH("DEVTRY",$P(%ZTIO,";")) S %ZTIO=IO
"RTN","ZTMS2",61,0)
 ;
"RTN","ZTMS2",62,0)
 ;results
"RTN","ZTMS2",63,0)
 I POP,(ZTYPE'="C"),(ZTIOT="TRM")!(ZTIOT="RES")!(ZTIOT="HG") D IONQ Q  ;only add to IO queue if not type C.
"RTN","ZTMS2",64,0)
 I POP D SCHNQ Q
"RTN","ZTMS2",65,0)
 I IOT'="RES",IOT'="HG" U IO
"RTN","ZTMS2",66,0)
 S IO(0)=IO
"RTN","ZTMS2",67,0)
 I $P(^%ZIS(1,+IOS,0),U,7)="y" D ^%ZTMSH
"RTN","ZTMS2",68,0)
 Q
"RTN","ZTMS2",69,0)
 ;
"RTN","ZTMS2",70,0)
IONQ ;DEVICE--put task on Device Waiting List
"RTN","ZTMS2",71,0)
 I $D(^%ZTSK(ZTSK,0))[0 D TSKSTAT("I",4) G IOQX
"RTN","ZTMS2",72,0)
 D TSKSTAT("A","")
"RTN","ZTMS2",73,0)
 N %ZTIO S %ZTIO=IO
"RTN","ZTMS2",74,0)
 S ZTIO(1)=$P(ZTREC2,U,5),ZTIOS=ZTREC21
"RTN","ZTMS2",75,0)
 D NQ^%ZTM4 ;Uses %ZTIO as the Device $I value
"RTN","ZTMS2",76,0)
IOQX L  Q  ;Clear all Locks
"RTN","ZTMS2",77,0)
 ;
"RTN","ZTMS2",78,0)
SCHNQ ;DEVICE--if HFS or SPL or TYPE'=C, reschedule task 10 min in future (try later)
"RTN","ZTMS2",79,0)
 S ZTH=$$NEWH($H,300)
"RTN","ZTMS2",80,0)
 D TSKSTAT(1,"rescheduled for busy device")
"RTN","ZTMS2",81,0)
 S $P(^%ZTSK(ZTSK,.2),U,8)=$P(^%ZTSK(ZTSK,.2),U,8)+1 ;ReQ count
"RTN","ZTMS2",82,0)
 D SCHTM(ZTH)
"RTN","ZTMS2",83,0)
 I $L($G(IO("ERROR"))) S $P(^%ZTSK(ZTSK,.12),U,2,9)=$H_U_IO("ERROR") ;May tell why couldn't get device
"RTN","ZTMS2",84,0)
 L  Q  ;Clear all locks
"RTN","ZTMS2",85,0)
 ;
"RTN","ZTMS2",86,0)
SCHTM(ZTDTH) ;Set a new schedule time, See that task is updated
"RTN","ZTMS2",87,0)
 S $P(^%ZTSK(ZTSK,0),U,6)=$$H0^%ZTM(ZTDTH),^%ZTSK(ZTSK,.04)=ZTDTH,^%ZTSCH(ZTDTH,ZTSK)=""
"RTN","ZTMS2",88,0)
 Q
"RTN","ZTMS2",89,0)
NEWH(%H,%Y) ;Build a new schedule time, Return $H3 time.
"RTN","ZTMS2",90,0)
 N %
"RTN","ZTMS2",91,0)
 I %H["," S %H=$$H3^%ZTM(%H)
"RTN","ZTMS2",92,0)
 Q (%H+%Y)
"RTN","ZTMS2",93,0)
 ;
"RTN","ZTMS2",94,0)
SYNCFLG(ACT,FLAG,ZIO,STAT) ;Allocate/deallocate sync flag
"RTN","ZTMS2",95,0)
 N X,DA,SYNC
"RTN","ZTMS2",96,0)
 L +^%ZISL(14.8):30 E  Q 0
"RTN","ZTMS2",97,0)
 S X=0,SYNC=FLAG_"~"_ZIO,DA=$O(^%ZISL(14.8,"B",SYNC,0))
"RTN","ZTMS2",98,0)
 I ACT["A" D
"RTN","ZTMS2",99,0)
 . I DA S X=0 Q
"RTN","ZTMS2",100,0)
 . ;I $D(^%ZTSCH("SYNC",ZIO,FLAG)) S X=0 Q
"RTN","ZTMS2",101,0)
 . S X=$P(^%ZISL(14.8,0),"^",3)+1 F  Q:'$D(^%ZISL(14.8,X))  S X=X+1
"RTN","ZTMS2",102,0)
 . S $P(^(0),"^",3,4)=X_"^"_($P(^%ZISL(14.8,0),"^",4)+1),^%ZISL(14.8,X,0)=SYNC,^%ZISL(14.8,"B",SYNC,X)=""
"RTN","ZTMS2",103,0)
 . S X=1 Q
"RTN","ZTMS2",104,0)
 I ACT["D" D  S X=1
"RTN","ZTMS2",105,0)
 . Q:DA'>0
"RTN","ZTMS2",106,0)
 . K ^%ZISL(14.8,DA),^%ZISL(14.8,"B",SYNC,DA)
"RTN","ZTMS2",107,0)
 . S $P(^(0),"^",3,4)=(DA-1)_"^"_($P(^%ZISL(14.8,0),"^",4)-1)
"RTN","ZTMS2",108,0)
 . Q
"RTN","ZTMS2",109,0)
 I ACT["S" D  S X=1
"RTN","ZTMS2",110,0)
 . Q:DA'>0
"RTN","ZTMS2",111,0)
 . S ^%ZISL(14.8,DA,1)=$G(STAT)
"RTN","ZTMS2",112,0)
 . Q
"RTN","ZTMS2",113,0)
 I ACT["?" S X=(DA)!($D(^%ZTSCH("SYNC",ZIO,FLAG)))
"RTN","ZTMS2",114,0)
 L -^%ZISL(14.8)
"RTN","ZTMS2",115,0)
 Q X
"RTN","ZTMS2",116,0)
 ;
"RTN","ZTMS2",117,0)
SYNCQ(FLAG,ZIO,ZTH,ZTSK) ;Put task on sync flag waiting list
"RTN","ZTMS2",118,0)
 L +^%ZTSCH("SYNC")
"RTN","ZTMS2",119,0)
 S ^%ZTSCH("SYNC",ZIO,FLAG,ZTSK)=ZTH
"RTN","ZTMS2",120,0)
 L -^%ZTSCH("SYNC")
"RTN","ZTMS2",121,0)
 Q
"RTN","ZTMS2",122,0)
SCHSYNC(FLAG,ZIO) ;put a waiting task in IO queue
"RTN","ZTMS2",123,0)
 L +^%ZTSCH("SYNC") I $D(^%ZTSCH("SYNC",ZIO,FLAG)) N ZTH,ZTSK D
"RTN","ZTMS2",124,0)
 . S ZTSK=$O(^(FLAG,0)),ZTH=$G(^(+ZTSK)) Q:ZTSK=""  S:$D(^%ZTSCH("IO",ZIO))[0 ^(ZIO)=IOT
"RTN","ZTMS2",125,0)
 . S ^%ZTSCH("IO",ZIO,ZTH,ZTSK)=""
"RTN","ZTMS2",126,0)
 . K ^%ZTSCH("SYNC",ZIO,FLAG,ZTSK)
"RTN","ZTMS2",127,0)
 . Q
"RTN","ZTMS2",128,0)
 L -^%ZTSCH("SYNC")
"RTN","ZTMS2",129,0)
 Q
"RTN","ZTMS2",130,0)
TSKSTAT(CODE,MSG) ;Record status
"RTN","ZTMS2",131,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,3)=$G(CODE)_U_$H_U_$G(MSG)
"RTN","ZTMS2",132,0)
 Q
"RTN","ZTMS2",133,0)
 ;
"RTN","ZTMS2",134,0)
POST ;Post INIT cleanup for patch XU*8*167
"RTN","ZTMS2",135,0)
 N T S T=0
"RTN","ZTMS2",136,0)
 F  S T=$O(^%ZTSCH(T)) Q:T'>0  I $D(^%ZTSCH(T,0)) K ^%ZTSCH(T,0)
"RTN","ZTMS2",137,0)
 Q
"RTN","ZTMS3")
0^13^B22900045
"RTN","ZTMS3",1,0)
%ZTMS3 ;SEA/RDS-TaskMan: Submanager, Part 5 (Run Task) ;08/27/08  14:19
"RTN","ZTMS3",2,0)
 ;;8.0;KERNEL;**1,18,36,49,64,67,94,118,127,136,175,275,355,446**;Jul 10, 1995;Build 36
"RTN","ZTMS3",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMS3",4,0)
 ;
"RTN","ZTMS3",5,0)
TASK ;SUBMGR--prepare and run task; cleanup after
"RTN","ZTMS3",6,0)
 ;
"RTN","ZTMS3",7,0)
BEFORE ;prepare task
"RTN","ZTMS3",8,0)
 ;Save submanager's variables
"RTN","ZTMS3",9,0)
 K %ZTTV
"RTN","ZTMS3",10,0)
 S (%ZTTV("DUZ"),DUZ)=+$P(ZTREC,U,3)
"RTN","ZTMS3",11,0)
 S %ZTTV=ZTUCI_U_IOS_U_U_ZTSK_U_IO_U_IOT_U_ZTCPU_U_ZTNODE_U_DUZ_U_U_IOF_U_IOST_U_ZTPAIR_U_ZTYPE_U
"RTN","ZTMS3",12,0)
 S %ZTTV(0)=ZTRTN_U_$P(ZTREC,U,8,9)_U_$P(ZTREC,U,6)_U_ION_U_ZTUCI_U_$P(ZTREC,U,5)_U_$S($L($P(ZTREC,U,10)):$P(ZTREC,U,10),1:$P(ZTREC,U,3))_U_$J_U_ZTSYNCFL_U_ZTPAIR_U_$H
"RTN","ZTMS3",13,0)
 ;
"RTN","ZTMS3",14,0)
 I +$G(^%ZTSCH("LOGRSRC")) S %ZTTV(1)="!"_$S($P(ZTREC,U,9)="":$P(ZTREC,U,2),1:$P(ZTREC,U,9))
"RTN","ZTMS3",15,0)
 ;
"RTN","ZTMS3",16,0)
 ;external calls
"RTN","ZTMS3",17,0)
 D NOW^%DTC S DT=% ;DT is Date.time at this point.
"RTN","ZTMS3",18,0)
1 D SETNM^%ZOSV($E("BTask ",(ZTIO]"")+1,6)_(ZTSK#100000000))
"RTN","ZTMS3",19,0)
 ;
"RTN","ZTMS3",20,0)
 ;priority (Not done in the VA)
"RTN","ZTMS3",21,0)
 ;
"RTN","ZTMS3",22,0)
2 ;restore saved variables
"RTN","ZTMS3",23,0)
 S X=$O(^XTV(8989.3,1,4,"B",ZTCPU,0)) S:$P($G(^XTV(8989.3,1,4,+X,0)),U,6)="y" XRTL=ZTUCI
"RTN","ZTMS3",24,0)
 K %,%H,%I,%ZTI,%ZTIO,IO("C"),IO("T"),X,Y,ZTCPU,ZTDEF,ZTIOST,ZTIOT,ZTNODE,ZTPAIR,ZTREC,ZTREC2,ZTREC21,ZTREC25,ZTUCI
"RTN","ZTMS3",25,0)
 K ^TMP($J),^UTILITY($J),^XUTL("XQ",$J)
"RTN","ZTMS3",26,0)
 S DUZ(0)="" D RESTORE^%ZTMS4
"RTN","ZTMS3",27,0)
 ;Setup User, If zero Default to Taskman Proxy
"RTN","ZTMS3",28,0)
 S DUZ=%ZTTV("DUZ") S:'DUZ DUZ=ZTPFLG("USER") ;p446
"RTN","ZTMS3",29,0)
 I DUZ(0)="" S DUZ(0)=$P($G(^VA(200,DUZ,0)),U,4)
"RTN","ZTMS3",30,0)
 I $D(DUZ(2))[0 S DUZ(2)=$S($D(^VA(200,DUZ,2,"AX1",1)):$O(^(1,0)),$D(^VA(200,DUZ,2,0)):$O(^(0)),1:0)
"RTN","ZTMS3",31,0)
 ;force values, DTIME=1 so HFS reads work under Cache
"RTN","ZTMS3",32,0)
 S DTIME=1,ZTDESC=$G(^%ZTSK(ZTSK,.03)),ZTDTH=$H
"RTN","ZTMS3",33,0)
 S DILOCKTM=+$G(^DD("DILOCKTM"),1) ;p446
"RTN","ZTMS3",34,0)
 ;Build Globals
"RTN","ZTMS3",35,0)
 S ^XUTL("XQ",$J,0)=DT,^("ZTSK")=ZTDESC,^("ZTSKNUM")=ZTSK
"RTN","ZTMS3",36,0)
 S ^XUTL("XQ",$J,"DUZ")=DUZ D SAVEVAR^%ZIS
"RTN","ZTMS3",37,0)
 S X="DUZ" F  S X=$Q(@X) Q:X=""  I $D(@X) S ^XUTL("XQ",$J,$TR(X,""""))=@X
"RTN","ZTMS3",38,0)
3 ;
"RTN","ZTMS3",39,0)
 ;final checks & sets
"RTN","ZTMS3",40,0)
 I '$D(^%ZTSK(ZTSK)) D AFTER(0) Q
"RTN","ZTMS3",41,0)
 I $L($P($G(^%ZTSK(ZTSK,.1)),U,10)) D  Q
"RTN","ZTMS3",42,0)
 . D TSKSTAT("D","Stopped by User"),AFTER(0)
"RTN","ZTMS3",43,0)
 D TSKSTAT(5,"Started Running",$J)
"RTN","ZTMS3",44,0)
 S ZTQUEUED=ZTSK,ZTSTAT="1 General error"
"RTN","ZTMS3",45,0)
 ;
"RTN","ZTMS3",46,0)
4 ;run task
"RTN","ZTMS3",47,0)
 ;Clear all locks
"RTN","ZTMS3",48,0)
 I ZTPFLG("XUSCNT") D SETLOCK^XUSCNT($NA(^%ZTSCH("TASK",ZTSK)))
"RTN","ZTMS3",49,0)
 L ^%ZTSCH("TASK",ZTSK):99 ;Clear any other Locks and establish a lock to be used to indicate that it is active p446
"RTN","ZTMS3",50,0)
 ;Persistents flag gets set in ZTSK^XQ1
"RTN","ZTMS3",51,0)
 I $P(^%ZIS(14.7,ZTPFLG("ZTPN"),0),U,3)="Y" S %ZTTV("LOG")=1 D LOGIN^%ZTMS4
"RTN","ZTMS3",52,0)
 S $P(%ZTTV(0),U,13)=$H,^%ZTSCH("TASK",ZTSK)=%ZTTV(0),^(ZTSK,2)=%ZTTV
"RTN","ZTMS3",53,0)
 I $D(%ZTTV(1)) D:+$G(^%ZTSCH("LOGRSRC")) LOGRSRC^%ZOSV(%ZTTV(1))
"RTN","ZTMS3",54,0)
 S DT=$P(DT,".") S:ZTPFLG("ZTREQ") ZTREQ="@"
"RTN","ZTMS3",55,0)
 M %ZTPFLG=ZTPFLG
"RTN","ZTMS3",56,0)
 D RUN
"RTN","ZTMS3",57,0)
5 K %ZTPFLG ;p446
"RTN","ZTMS3",58,0)
 S U="^",ZTLKTM=$G(ZTPFLG("LOCKTM")),ZTSK=$P(%ZTTV,U,4) ;p446
"RTN","ZTMS3",59,0)
 I $D(%ZTTV(1)) D:+$G(^%ZTSCH("LOGRSRC")) LOGRSRC^%ZOSV("$AFTR ZTMS$")
"RTN","ZTMS3",60,0)
 I $G(%ZTTV("LOG")) D LOGOUT^%ZTMS4
"RTN","ZTMS3",61,0)
 D PCLEAR^%ZTLOAD(ZTSK) ;Clear persistent flag
"RTN","ZTMS3",62,0)
 D TSKSTAT(6,"Finished"),AFTER(1)
"RTN","ZTMS3",63,0)
 Q
"RTN","ZTMS3",64,0)
 ;
"RTN","ZTMS3",65,0)
AFTER(ZTTASK) ;cleanup after task; reset partition
"RTN","ZTMS3",66,0)
 I ZTPFLG("XUSCNT") D SETLOCK^XUSCNT()
"RTN","ZTMS3",67,0)
 ;L  ;Clear all user locks. p446
"RTN","ZTMS3",68,0)
 L ^%ZTSK(ZTSK):99 ;Clear any Locks from Task and set our Lock. p446
"RTN","ZTMS3",69,0)
 I ZTTASK K ^%ZTSCH("TASK",ZTSK) S ZTQUEUED=.6
"RTN","ZTMS3",70,0)
 ;S X=10 X ^%ZOSF("PRIORITY")
"RTN","ZTMS3",71,0)
 D SETNM^%ZOSV("Sub "_$J) ;Change name back
"RTN","ZTMS3",72,0)
 S ZTUCI=$P(%ZTTV,U),IOS=$P(%ZTTV,U,2),(IO,IO(0),%ZTIO)=$P(%ZTTV,U,5),IOT=$P(%ZTTV,U,6),ZTCPU=$P(%ZTTV,U,7),ZTNODE=$P(%ZTTV,U,8)
"RTN","ZTMS3",73,0)
 S IOF=$P(%ZTTV,U,11),IOST=$P(%ZTTV,U,12),ZTPAIR=$P(%ZTTV,U,13),ZTYPE=$P(%ZTTV,U,14),ZTSYNCFL=$P(%ZTTV(0),U,11),DUZ=%ZTTV("DUZ")
"RTN","ZTMS3",74,0)
 I $G(ZTSYNCFL)]"" S X=$$SYNCFLG^%ZTMS2($S($G(ZTSTAT):"S",1:"D"),ZTSYNCFL,IO,$G(ZTSTAT)) D SCHSYNC^%ZTMS2(ZTSYNCFL,IO):'$G(ZTSTAT)
"RTN","ZTMS3",75,0)
 D POST^%ZTMS4:ZTTASK,CLOSE
"RTN","ZTMS3",76,0)
 K ^TMP($J),^UTILITY($J),^XUTL("XQ",$J) I $T(XUTL^XUSCLEAN)]"" D XUTL^XUSCLEAN
"RTN","ZTMS3",77,0)
 K (%ZTIO,%ZTTV,DT,IO,IOF,ION,IOS,IOST,IOT,U,ZTCPU,ZTNODE,ZTNONEXT,ZTPAIR,ZTPFLG,ZTQUEUED,ZTREQ,ZTSTOP,ZTUCI,ZTYPE,ZTLKTM) ;p446
"RTN","ZTMS3",78,0)
 K IO("C"),IO("T"),IO("ERROR"),IO("LASTERR"),IO("DOC"),IO("P"),IO("HFSIO")
"RTN","ZTMS3",79,0)
 S DUZ=0,DUZ(0)="@",ZTQUEUED=0
"RTN","ZTMS3",80,0)
 L  ;Clear all locks, -^%ZTSK(ZTSK)
"RTN","ZTMS3",81,0)
 Q
"RTN","ZTMS3",82,0)
 ;
"RTN","ZTMS3",83,0)
RUN ;Need ZTPFLG in run environment in case of error trap.
"RTN","ZTMS3",84,0)
 N %,%ZTTV,ZTPFLG,XUALLOC
"RTN","ZTMS3",85,0)
 M ZTPFLG=%ZTPFLG ;p446
"RTN","ZTMS3",86,0)
 F %=1:1:12 S $P(XUALLOC(%)," ",250)=""
"RTN","ZTMS3",87,0)
 D @ZTRTN
"RTN","ZTMS3",88,0)
 Q
"RTN","ZTMS3",89,0)
 ;
"RTN","ZTMS3",90,0)
CLOSE ;RUN--close &/or close execute
"RTN","ZTMS3",91,0)
 I %ZTIO="" S ZTNONEXT=1 G CLX
"RTN","ZTMS3",92,0)
 N ZTUCI,ZTCPU,ZTNODE,IOCPU,%IO
"RTN","ZTMS3",93,0)
 I IOT="HFS"!(IOT="SPL") S ZTNONEXT=1
"RTN","ZTMS3",94,0)
 K IO("C") S:IOT'="TRM" IO("C")=1
"RTN","ZTMS3",95,0)
 S:$D(IO("CLOSE")) IO("T")=1
"RTN","ZTMS3",96,0)
 I IOT="RES" K ZTNONEXT Q  ;For a Resource, don't close.
"RTN","ZTMS3",97,0)
 ;Here is the Lock and hang to allow IDCU ports to reset. See %ZTMS2.
"RTN","ZTMS3",98,0)
 ;I IOST["MINIOUT" S IO("C")=1,%IO=1 L +^%ZTSCH("NETMAIL",%ZTIO):8 ;p446
"RTN","ZTMS3",99,0)
 I $D(IO(1,IO))#2 D ^%ZISC
"RTN","ZTMS3",100,0)
 I $G(%IO) H 6 ;Wait for terminal server to reset.
"RTN","ZTMS3",101,0)
 ;Unlock of all locks is done in clean
"RTN","ZTMS3",102,0)
 ;See that all devices are closed.
"RTN","ZTMS3",103,0)
CLX S %IO="" F  S %IO=$O(IO(1,%IO)) Q:%IO=""  I %IO'=IO K IO(1,%IO) C %IO
"RTN","ZTMS3",104,0)
 Q
"RTN","ZTMS3",105,0)
 ;
"RTN","ZTMS3",106,0)
TSKSTAT(CODE,MSG,JOB) ; Update task's status
"RTN","ZTMS3",107,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,3)=$G(CODE)_U_$H_U_$G(MSG)
"RTN","ZTMS3",108,0)
 I $G(JOB)>0 S $P(^%ZTSK(ZTSK,.1),U,4)=JOB
"RTN","ZTMS3",109,0)
 Q
"RTN","ZTMS3",110,0)
 ;
"RTN","ZTMS5")
0^1^B1225600
"RTN","ZTMS5",1,0)
%ZTMS5 ;ISF/RWF - TaskMan utility ;2/19/08  13:46
"RTN","ZTMS5",2,0)
 ;;8.0;KERNEL;**275,446**;Jul 10, 1995;Build 36
"RTN","ZTMS5",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ZTMS5",4,0)
 Q
"RTN","ZTMS5",5,0)
 ;Called from ZTMON1, Jobed from %ZTM5.
"RTN","ZTMS5",6,0)
SUBCHK(DILOCKTM) ;Check for lost submanagers, Update Count
"RTN","ZTMS5",7,0)
 N %C,%N,%J,ZT2,ZT3,TO
"RTN","ZTMS5",8,0)
 I '$D(DILOCKTM) S DILOCKTM=+$G(^DD("DILOCKTM"),0) ;p446
"RTN","ZTMS5",9,0)
 S %N="",MARK=$G(MARK)
"RTN","ZTMS5",10,0)
 F  S %N=$O(^%ZTSCH("SUB",%N)) Q:%N=""  D
"RTN","ZTMS5",11,0)
 . L +^%ZTSCH("SUB",%N):DILOCKTM
"RTN","ZTMS5",12,0)
 . S %C=0,%J=0,ZT3=$$H3^%ZTM($H)
"RTN","ZTMS5",13,0)
 . F  S %J=$O(^%ZTSCH("SUB",%N,%J)) Q:%J'>0  D
"RTN","ZTMS5",14,0)
 . . S ZT2=$$H3^%ZTM($G(^(%J)))
"RTN","ZTMS5",15,0)
 . . ;Check for old
"RTN","ZTMS5",16,0)
 . . I (ZT2+30)<ZT3 K ^%ZTSCH("SUB",%N,%J) Q
"RTN","ZTMS5",17,0)
 . . ;Check for not locked.
"RTN","ZTMS5",18,0)
 . . L +^%ZTSCH("SUBLK",%N,%J):DILOCKTM I $T L -^%ZTSCH("SUBLK",%N,%J) K ^%ZTSCH("SUB",%N,%J) Q
"RTN","ZTMS5",19,0)
 . . S %C=%C+1
"RTN","ZTMS5",20,0)
 . . Q
"RTN","ZTMS5",21,0)
 . S ^%ZTSCH("SUB",%N)=%C
"RTN","ZTMS5",22,0)
 . L -^%ZTSCH("SUB",%N)
"RTN","ZTMS5",23,0)
 . Q
"RTN","ZTMS5",24,0)
 Q
"SEC","^DIC",14.71,14.71,0,"AUDIT")
@
"SEC","^DIC",14.71,14.71,0,"DD")
@
"SEC","^DIC",14.71,14.71,0,"DEL")
@
"SEC","^DIC",14.71,14.71,0,"LAYGO")
@
"SEC","^DIC",14.71,14.71,0,"RD")

"SEC","^DIC",14.71,14.71,0,"WR")
@
"SEC","^DIC",14.72,14.72,0,"AUDIT")
@
"SEC","^DIC",14.72,14.72,0,"DD")
@
"SEC","^DIC",14.72,14.72,0,"DEL")
 
"SEC","^DIC",14.72,14.72,0,"LAYGO")
@
"SEC","^DIC",14.72,14.72,0,"RD")
 
"SEC","^DIC",14.72,14.72,0,"WR")
 
"VER")
8.0^22.0
"^DD",14.7,14.7,21,0)
LOAD BALANCE ROUTINE^F^^2;E1,75^K:$L(X)>75!($L(X)<3)!'(X?1"$".1PA.E) X
"^DD",14.7,14.7,21,1,0)
^.1
"^DD",14.7,14.7,21,1,1,0)
14.7^AI^MUMPS
"^DD",14.7,14.7,21,1,1,1)
D ^XUTMG14P
"^DD",14.7,14.7,21,1,1,2)
D ^XUTMG14P
"^DD",14.7,14.7,21,1,1,3)
This cross-reference notifies TaskMan of changes to the field.
"^DD",14.7,14.7,21,1,1,"DT")
3070222
"^DD",14.7,14.7,21,3)
Answer must be 3-75 characters in length. Funtion, Extrinsic function, External routine.
"^DD",14.7,14.7,21,21,0)
^^28^28^3050224^
"^DD",14.7,14.7,21,21,1,0)
This field holds the name of a Function, Extrinsic function or External
"^DD",14.7,14.7,21,21,2,0)
routine call that returns a load rating. If this field contains a value,
"^DD",14.7,14.7,21,21,3,0)
TaskMan will use this name in preforming Load Balancing.
"^DD",14.7,14.7,21,21,4,0)
 
"^DD",14.7,14.7,21,21,5,0)
Only use Load Balancing if you have two or more CPU's running TM that
"^DD",14.7,14.7,21,21,6,0)
share the same %ZTSCH global.
"^DD",14.7,14.7,21,21,7,0)
 
"^DD",14.7,14.7,21,21,8,0)
The Load Balancing function must return a value between 1 and 256.
"^DD",14.7,14.7,21,21,9,0)
Where: 1 represents a CPU with no capacity for any more work.
"^DD",14.7,14.7,21,21,10,0)
       256 represents a CPU that is Idle.
"^DD",14.7,14.7,21,21,11,0)
 
"^DD",14.7,14.7,21,21,12,0)
The only included functions are
"^DD",14.7,14.7,21,21,13,0)
For VAX DSM it is '$$VXD' and its algorithm is:
"^DD",14.7,14.7,21,21,14,0)
Capacity left= Available jobs - Active jobs - (4 * Computable jobs)
"^DD",14.7,14.7,21,21,15,0)
 
"^DD",14.7,14.7,21,21,16,0)
For Cache/NT it is '$$CACHE1(constant)' its algorithm is:
"^DD",14.7,14.7,21,21,17,0)
Capacity left= Available jobs + constant
"^DD",14.7,14.7,21,21,18,0)
 
"^DD",14.7,14.7,21,21,19,0)
For Cache/VMS it is '$$CACHE2(@com-file,logical-name)'.
"^DD",14.7,14.7,21,21,20,0)
If the com-file value is set, that com-file will be run each time taskman
"^DD",14.7,14.7,21,21,21,0)
wants to get the balance value.
"^DD",14.7,14.7,21,21,22,0)
The logical-name will default to "VISTA$METRIC" or us the value entered.
"^DD",14.7,14.7,21,21,23,0)
The normal way would be to have $$CACHE2() in the field and use the two
"^DD",14.7,14.7,21,21,24,0)
scripts.
"^DD",14.7,14.7,21,21,25,0)
 
"^DD",14.7,14.7,21,21,26,0)
A script "GET_METRIC.COM" will set the logical "VISTA$METRIC".
"^DD",14.7,14.7,21,21,27,0)
This can be run by taskman or from the TM$node batch queue with the 
"^DD",14.7,14.7,21,21,28,0)
script "METRIC_SCHEDULE.COM".
"^DD",14.7,14.7,21,"DT")
3070222
"^DD",14.71,14.71,0)
FIELD^^101^27
"^DD",14.71,14.71,0,"DDA")
N
"^DD",14.71,14.71,0,"DT")
3080219
"^DD",14.71,14.71,0,"IX","B",14.71,.01)

"^DD",14.71,14.71,0,"NM","TASKMAN MONITOR")

"^DD",14.71,14.71,0,"VRPK")
XU
"^DD",14.71,14.71,.01,0)
DATE^RD^^0;1^S %DT="EX" D ^%DT S X=Y K:Y<1 X
"^DD",14.71,14.71,.01,1,0)
^.1
"^DD",14.71,14.71,.01,1,1,0)
14.71^B
"^DD",14.71,14.71,.01,1,1,1)
S ^%ZIS(14.71,"B",$E(X,1,30),DA)=""
"^DD",14.71,14.71,.01,1,1,2)
K ^%ZIS(14.71,"B",$E(X,1,30),DA)
"^DD",14.71,14.71,.01,3)

"^DD",14.71,14.71,.01,21,0)
^^1^1^3000313^
"^DD",14.71,14.71,.01,21,1,0)
This field holds the FM date that this set of monitor data is for.
"^DD",14.71,14.71,.01,"DT")
3000313
"^DD",14.71,14.71,2,0)
BOX-VOLUME PAIR^F^^0;2^K:$L(X)>30!($L(X)<3) X
"^DD",14.71,14.71,2,3)
Answer must be 3-30 characters in length.
"^DD",14.71,14.71,2,21,0)
^^2^2^3000313^^
"^DD",14.71,14.71,2,21,1,0)
This field holds the Taskman ZTPAIR data. It should match a current
"^DD",14.71,14.71,2,21,2,0)
Taskman Box-Volume pair.
"^DD",14.71,14.71,2,"DT")
3000313
"^DD",14.71,14.71,3,0)
Task Count 0^NJ7,0^^0;3^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,3,.1)
 1am
"^DD",14.71,14.71,3,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,3,21,0)
^^2^2^3071018^^
"^DD",14.71,14.71,3,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,3,21,2,0)
from the schedule queue for time 00:00-00:59.
"^DD",14.71,14.71,3,"DT")
3071018
"^DD",14.71,14.71,4,0)
Task Count 1^NJ7,0^^0;4^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,4,.1)
 2am
"^DD",14.71,14.71,4,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,4,21,0)
^^2^2^3000313^^
"^DD",14.71,14.71,4,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,4,21,2,0)
from the schedule queue for time 1:00-1:59.
"^DD",14.71,14.71,4,"DT")
3071018
"^DD",14.71,14.71,5,0)
Task Count 2^NJ7,0^^0;5^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,5,.1)
 3am
"^DD",14.71,14.71,5,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,5,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,5,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,5,21,2,0)
from the schedule queue for time 2:00-2:59.
"^DD",14.71,14.71,5,"DT")
3000313
"^DD",14.71,14.71,6,0)
Task Count 3^NJ7,0^^0;6^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,6,.1)
 4am
"^DD",14.71,14.71,6,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,6,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,6,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,6,21,2,0)
from the schedule queue for time 3:00-3:59.
"^DD",14.71,14.71,6,"DT")
3000313
"^DD",14.71,14.71,7,0)
Task Count 4^NJ7,0^^0;7^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,7,.1)
 5am
"^DD",14.71,14.71,7,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,7,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,7,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,7,21,2,0)
from the schedule queue for time 4:00-4:59.
"^DD",14.71,14.71,7,"DT")
3000313
"^DD",14.71,14.71,8,0)
Task Count 5^NJ7,0^^0;8^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,8,.1)
 6am
"^DD",14.71,14.71,8,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,8,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,8,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,8,21,2,0)
from the schedule queue for time 5:00-5:59.
"^DD",14.71,14.71,8,"DT")
3000313
"^DD",14.71,14.71,9,0)
Task Count 6^NJ7,0^^0;9^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,9,.1)
 7am
"^DD",14.71,14.71,9,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,9,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,9,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,9,21,2,0)
from the schedule queue for time 6:00-6:59.
"^DD",14.71,14.71,9,"DT")
3000313
"^DD",14.71,14.71,10,0)
Task Count 7^NJ7,0^^0;10^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,10,.1)
 8am
"^DD",14.71,14.71,10,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,10,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,10,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,10,21,2,0)
from the schedule queue for time 7:00-7:59.
"^DD",14.71,14.71,10,"DT")
3000313
"^DD",14.71,14.71,11,0)
Task Count 8^NJ7,0^^0;11^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,11,.1)
 9am
"^DD",14.71,14.71,11,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,11,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,11,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,11,21,2,0)
from the schedule queue for time 8:00-8:59.
"^DD",14.71,14.71,11,"DT")
3000313
"^DD",14.71,14.71,12,0)
Task Count 9^NJ7,0^^0;12^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,12,.1)
10am
"^DD",14.71,14.71,12,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,12,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,12,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,12,21,2,0)
from the schedule queue for time 9:00-9:59.
"^DD",14.71,14.71,12,"DT")
3000313
"^DD",14.71,14.71,13,0)
Task Count 10^NJ7,0^^0;13^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,13,.1)
11am
"^DD",14.71,14.71,13,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,13,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,13,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,13,21,2,0)
from the schedule queue for time 10:00-10:59.
"^DD",14.71,14.71,13,"DT")
3000313
"^DD",14.71,14.71,14,0)
Task Count 11^NJ7,0^^0;14^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,14,.1)
noon
"^DD",14.71,14.71,14,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,14,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,14,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,14,21,2,0)
from the schedule queue for time 11:00-11:59.
"^DD",14.71,14.71,14,"DT")
3000313
"^DD",14.71,14.71,15,0)
Task Count 12^NJ7,0^^0;15^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,15,.1)
 1pm
"^DD",14.71,14.71,15,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,15,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,15,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,15,21,2,0)
from the schedule queue for time 12:00-12:59.
"^DD",14.71,14.71,15,"DT")
3000313
"^DD",14.71,14.71,16,0)
Task Count 13^NJ7,0^^0;16^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,16,.1)
 2pm
"^DD",14.71,14.71,16,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,16,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,16,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,16,21,2,0)
from the schedule queue for time 13:00-13:59.
"^DD",14.71,14.71,16,"DT")
3000313
"^DD",14.71,14.71,17,0)
Task Count 14^NJ7,0^^0;17^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,17,.1)
 3pm
"^DD",14.71,14.71,17,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,17,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,17,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,17,21,2,0)
from the schedule queue for time 14:00-14:59.
"^DD",14.71,14.71,17,"DT")
3000313
"^DD",14.71,14.71,18,0)
Task Count 15^NJ7,0^^0;18^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,18,.1)
 4pm
"^DD",14.71,14.71,18,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,18,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,18,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,18,21,2,0)
from the schedule queue for time 15:00-15:59.
"^DD",14.71,14.71,18,"DT")
3000313
"^DD",14.71,14.71,19,0)
Task Count 16^NJ7,0^^0;19^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,19,.1)
 5pm
"^DD",14.71,14.71,19,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,19,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,19,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,19,21,2,0)
from the schedule queue for time 16:00-16:59.
"^DD",14.71,14.71,19,"DT")
3000313
"^DD",14.71,14.71,20,0)
Task Count 17^NJ7,0^^0;20^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,20,.1)
 6pm
"^DD",14.71,14.71,20,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,20,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,20,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,20,21,2,0)
from the schedule queue for time 17:00-17:59.
"^DD",14.71,14.71,20,"DT")
3000313
"^DD",14.71,14.71,21,0)
Task Count 18^NJ7,0^^0;21^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,21,.1)
 7pm
"^DD",14.71,14.71,21,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,21,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,21,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,21,21,2,0)
from the schedule queue for time 18:00-18:59.
"^DD",14.71,14.71,21,"DT")
3000313
"^DD",14.71,14.71,22,0)
Task Count 19^NJ7,0^^0;22^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,22,.1)
 8pm
"^DD",14.71,14.71,22,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,22,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,22,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,22,21,2,0)
from the schedule queue for time 19:00-19:59.
"^DD",14.71,14.71,22,"DT")
3000313
"^DD",14.71,14.71,23,0)
Task Count 20^NJ7,0^^0;23^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,23,.1)
 9pm
"^DD",14.71,14.71,23,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,23,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,23,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,23,21,2,0)
from the schedule queue for time 20:00-20:59.
"^DD",14.71,14.71,23,"DT")
3000313
"^DD",14.71,14.71,24,0)
Task Count 21^NJ7,0^^0;24^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,24,.1)
10pm
"^DD",14.71,14.71,24,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,24,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,24,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,24,21,2,0)
from the schedule queue for time 21:00-21:59.
"^DD",14.71,14.71,24,"DT")
3000313
"^DD",14.71,14.71,25,0)
Task Count 22^NJ7,0^^0;25^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,25,.1)
11pm
"^DD",14.71,14.71,25,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,25,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,25,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,25,21,2,0)
from the schedule queue for time 22:00-22:59.
"^DD",14.71,14.71,25,"DT")
3000313
"^DD",14.71,14.71,26,0)
Task Count 23^NJ7,0^^0;26^K:+X'=X!(X>9999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.71,14.71,26,.1)
12pm
"^DD",14.71,14.71,26,3)
Type a number between 0 and 9999999, 0 Decimal Digits
"^DD",14.71,14.71,26,21,0)
^^2^2^3000313^
"^DD",14.71,14.71,26,21,1,0)
This field holds the count of the number of tasks that the manager moved
"^DD",14.71,14.71,26,21,2,0)
from the schedule queue for time 23:00-23:59.
"^DD",14.71,14.71,26,"DT")
3000313
"^DD",14.71,14.71,101,0)
Daily Total^CJ6^^ ; ^X ^DD(14.71,101,9.5) S X=X+$P(Y(14.71,101,1),U,26)
"^DD",14.71,14.71,101,9)
^
"^DD",14.71,14.71,101,9.01)
14.71^26;14.71^25;14.71^24;14.71^23;14.71^22;14.71^21;14.71^20;14.71^19;14.71^18;14.71^17;14.71^16;14.71^15;14.71^14;14.71^13;14.71^12;14.71^11;14.71^10;14.71^9;14.71^8;14.71^7;14.71^6;14.71^5;14.71^4;14.71^3
"^DD",14.71,14.71,101,9.1)
#3+#4+#5+#6+#7+#8+#9+#10+#11+#12+#13+#14+#15+#16+#17+#18+#19+#20+#21+#22+#23+#24+#25+#26
"^DD",14.71,14.71,101,9.2)
S Y(14.71,101,1)=$S($D(^%ZIS(14.71,D0,0)):^(0),1:"") S X=$P(Y(14.71,101,1),U,3)+$P(Y(14.71,101,1),U,4)+$P(Y(14.71,101,1),U,5)+$P(Y(14.71,101,1),U,6)+$P(Y(14.71,101,1),U,7)
"^DD",14.71,14.71,101,9.3)
X ^DD(14.71,101,9.2) S X=X+$P(Y(14.71,101,1),U,8)+$P(Y(14.71,101,1),U,9)+$P(Y(14.71,101,1),U,10)+$P(Y(14.71,101,1),U,11)+$P(Y(14.71,101,1),U,12)+$P(Y(14.71,101,1),U,13)
"^DD",14.71,14.71,101,9.4)
X ^DD(14.71,101,9.3) S X=X+$P(Y(14.71,101,1),U,14)+$P(Y(14.71,101,1),U,15)+$P(Y(14.71,101,1),U,16)+$P(Y(14.71,101,1),U,17)+$P(Y(14.71,101,1),U,18)+$P(Y(14.71,101,1),U,19)
"^DD",14.71,14.71,101,9.5)
X ^DD(14.71,101,9.4) S X=X+$P(Y(14.71,101,1),U,20)+$P(Y(14.71,101,1),U,21)+$P(Y(14.71,101,1),U,22)+$P(Y(14.71,101,1),U,23)+$P(Y(14.71,101,1),U,24)+$P(Y(14.71,101,1),U,25)
"^DD",14.71,14.71,101,"DT")
3080219
"^DD",14.72,14.72,0)
FIELD^^9^18
"^DD",14.72,14.72,0,"DDA")
N
"^DD",14.72,14.72,0,"DT")
3080618
"^DD",14.72,14.72,0,"IX","B",14.72,.01)

"^DD",14.72,14.72,0,"NM","TASKMAN SNAPSHOT")

"^DD",14.72,14.72,0,"VRPK")
XU
"^DD",14.72,14.72,.01,0)
DATE^RD^^0;1^S %DT="ESTXR" D ^%DT S X=Y K:Y<1 X
"^DD",14.72,14.72,.01,.1)
Date-Time
"^DD",14.72,14.72,.01,1,0)
^.1
"^DD",14.72,14.72,.01,1,1,0)
14.72^B
"^DD",14.72,14.72,.01,1,1,1)
S ^%ZIS(14.72,"B",$E(X,1,30),DA)=""
"^DD",14.72,14.72,.01,1,1,2)
K ^%ZIS(14.72,"B",$E(X,1,30),DA)
"^DD",14.72,14.72,.01,3)

"^DD",14.72,14.72,.01,"DT")
3071018
"^DD",14.72,14.72,2,0)
TASKMAN CURRENT^S^0:NO;1:Yes;^0;2^Q
"^DD",14.72,14.72,2,21,0)
^^1^1^3071018^
"^DD",14.72,14.72,2,21,1,0)
This hold the value returned by $$TM^%ZTLOAD.
"^DD",14.72,14.72,2,"DT")
3071018
"^DD",14.72,14.72,3,0)
TASKMAN COUNT^NJ2,0^^0;3^K:+X'=X!(X>10)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,3,3)
Type a Number between 0 and 10, 0 Decimal Digits
"^DD",14.72,14.72,3,21,0)
^^2^2^3071018^
"^DD",14.72,14.72,3,21,1,0)
This is the count of the number of entries in the ^%ZTSCH("STATUS") 
"^DD",14.72,14.72,3,21,2,0)
global.
"^DD",14.72,14.72,3,"DT")
3071018
"^DD",14.72,14.72,4,0)
TASKMAN BALANCE^F^^0;4^K:$L(X)>20!($L(X)<3) X
"^DD",14.72,14.72,4,3)
Answer must be 3-20 characters in length.
"^DD",14.72,14.72,4,21,0)
^^2^2^3071018^
"^DD",14.72,14.72,4,21,1,0)
This is what node is the current run node if taskman is doing load 
"^DD",14.72,14.72,4,21,2,0)
balancing.
"^DD",14.72,14.72,4,"DT")
3071115
"^DD",14.72,14.72,5,0)
BALANCE WEIGHT^NJ4,0^^0;5^K:+X'=X!(X>1000)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,5,3)
Type a Number between 0 and 1000, 0 Decimal Digits
"^DD",14.72,14.72,5,21,0)
^^1^1^3071115^
"^DD",14.72,14.72,5,21,1,0)
This field holds the Balance Weight of the current Task Manager.
"^DD",14.72,14.72,5,"DT")
3071115
"^DD",14.72,14.72,7,0)
SCHEDULE COUNT^NJ6,0^^0;7^K:+X'=X!(X>999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,7,3)
Type a Number between 0 and 999999, 0 Decimal Digits
"^DD",14.72,14.72,7,21,0)
^^1^1^3071018^
"^DD",14.72,14.72,7,21,1,0)
This is the number of tasks in the schedule list.
"^DD",14.72,14.72,7,"DT")
3071018
"^DD",14.72,14.72,8,0)
SCH LATE BY^NJ5,0^^0;8^K:+X'=X!(X>99999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,8,3)
Type a Number between 0 and 99999, 0 Decimal Digits
"^DD",14.72,14.72,8,21,0)
^.001^1^1^3080611^^
"^DD",14.72,14.72,8,21,1,0)
The number of seconds the first task in the schedule list is late.
"^DD",14.72,14.72,8,"DT")
3080611
"^DD",14.72,14.72,9,0)
SCH LATE CNT^NJ5,0^^0;9^K:+X'=X!(X>99999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,9,3)
Type a Number between 0 and 99999, 0 Decimal Digits
"^DD",14.72,14.72,9,21,0)
^^1^1^3080611^
"^DD",14.72,14.72,9,21,1,0)
This field holds a count of the number of late tasks in the schedule list.
"^DD",14.72,14.72,9,"DT")
3080611
"^DD",14.72,14.72,10,0)
IO DEVICE CNT^NJ6,0^^0;10^K:+X'=X!(X>999999)!(X<0)!(X?.E1"."1.N) X
"^DD",14.72,14.72,10,3)
Type a number between 0 and 999999, 0 Decimal Digits
"^DD",14.72,14.72,10,21,0)
^^1^1^3071018^^
"^DD",14.72,14.72,10,21,1,0)
This is the number of IO WAIT queues.
"^DD",14.72,14.72,10,"DT")
3071018
"^DD",14.72,14.72,11,0)
IO TASK COUNT^NJ6,0^^0;11^K:+X'=X!(X>999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,11,3)
Type a Number between 0 and 999999, 0 Decimal Digits
"^DD",14.72,14.72,11,21,0)
^^1^1^3071018^
"^DD",14.72,14.72,11,21,1,0)
This is the number of tasks in IO WAIT queues.
"^DD",14.72,14.72,11,"DT")
3071018
"^DD",14.72,14.72,12,0)
IO LATE^NJ6,0^^0;12^K:+X'=X!(X>999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,12,3)
Type a Number between 0 and 999999, 0 Decimal Digits
"^DD",14.72,14.72,12,21,0)
^^2^2^3071018^
"^DD",14.72,14.72,12,21,1,0)
This is the number of seconds the first task is late.
"^DD",14.72,14.72,12,21,2,0)
Will have to see if it has any value.
"^DD",14.72,14.72,12,"DT")
3071018
"^DD",14.72,14.72,15,0)
JOBQ^NJ6,0^^0;15^K:+X'=X!(X>999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,15,3)
Type a Number between 0 and 999999, 0 Decimal Digits
"^DD",14.72,14.72,15,21,0)
^^1^1^3071018^
"^DD",14.72,14.72,15,21,1,0)
This is the number of tasks in the JOB and C lists waiting to run.
"^DD",14.72,14.72,15,"DT")
3071018
"^DD",14.72,14.72,16,0)
JOBQ LATE^NJ6,0^^0;16^K:+X'=X!(X>999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,16,3)
Type a Number between 0 and 999999, 0 Decimal Digits
"^DD",14.72,14.72,16,21,0)
^^1^1^3071018^
"^DD",14.72,14.72,16,21,1,0)
This is the number of seconds the first task in the JOB list is late.
"^DD",14.72,14.72,16,"DT")
3071018
"^DD",14.72,14.72,19,0)
SUBMANAGER COUNT^NJ6,0^^0;19^K:+X'=X!(X>999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,19,3)
Type a Number between 0 and 999999, 0 Decimal Digits
"^DD",14.72,14.72,19,21,0)
^^1^1^3071018^
"^DD",14.72,14.72,19,21,1,0)
This is the total number of submanagers running.
"^DD",14.72,14.72,19,"DT")
3071018
"^DD",14.72,14.72,20,0)
RUNNING TASKS^NJ6,0^^0;20^K:+X'=X!(X>999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,20,3)
Type a Number between 0 and 999999, 0 Decimal Digits
"^DD",14.72,14.72,20,21,0)
^^1^1^3071018^
"^DD",14.72,14.72,20,21,1,0)
This is the number of running tasks.
"^DD",14.72,14.72,20,"DT")
3071018
"^DD",14.72,14.72,22,0)
TOTAL JOBS^NJ4,0^^0;22^K:+X'=X!(X>9999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.72,14.72,22,3)
Type a Number between 0 and 9999, 0 Decimal Digits
"^DD",14.72,14.72,22,21,0)
^^2^2^3071115^
"^DD",14.72,14.72,22,21,1,0)
This field holds the total number of running jobs as reported by 
"^DD",14.72,14.72,22,21,2,0)
$$ACTJ^%ZOSV.
"^DD",14.72,14.72,22,"DT")
3071115
"^DD",14.72,14.72,101,0)
MANAGERS^14.72101^^1;0
"^DD",14.72,14.72,201,0)
SUBMANAGERS^14.72201^^2;0
"^DD",14.72,14.72101,0)
MANAGERS SUB-FIELD^^5^5
"^DD",14.72,14.72101,0,"DT")
3080618
"^DD",14.72,14.72101,0,"IX","B",14.72101,.01)

"^DD",14.72,14.72101,0,"NM","MANAGERS")

"^DD",14.72,14.72101,0,"UP")
14.72
"^DD",14.72,14.72101,.01,0)
MANAGER^NJ9,0^^0;1^K:+X'=X!(X>999999999)!(X<1)!(X?.E1"."1N.N) X
"^DD",14.72,14.72101,.01,1,0)
^.1
"^DD",14.72,14.72101,.01,1,1,0)
14.72101^B
"^DD",14.72,14.72101,.01,1,1,1)
S ^%ZIS(14.72,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",14.72,14.72101,.01,1,1,2)
K ^%ZIS(14.72,DA(1),1,"B",$E(X,1,30),DA)
"^DD",14.72,14.72101,.01,3)
Type a Number between 1 and 999999999, 0 Decimal Digits
"^DD",14.72,14.72101,.01,21,0)
^^1^1^3080604^
"^DD",14.72,14.72101,.01,21,1,0)
To store info about each Task Manager running.
"^DD",14.72,14.72101,.01,"DT")
3080619
"^DD",14.72,14.72101,2,0)
DATETIME^FO^^0;2^K:$L(X)>11!($L(X)<5) X
"^DD",14.72,14.72101,2,2)
S Y(0)=Y S Y=$$HTE^XLFDT(Y)
"^DD",14.72,14.72101,2,2.1)
S Y=$$HTE^XLFDT(Y)
"^DD",14.72,14.72101,2,3)
Answer must be 5-11 characters in length.
"^DD",14.72,14.72101,2,21,0)
^^1^1^3080604^
"^DD",14.72,14.72101,2,21,1,0)
This is the short Status.
"^DD",14.72,14.72101,2,"DT")
3080611
"^DD",14.72,14.72101,3,0)
STATUS^F^^0;3^K:$L(X)>7!($L(X)<3) X
"^DD",14.72,14.72101,3,3)
Answer must be 3-7 characters in length.
"^DD",14.72,14.72101,3,21,0)
^^1^1^3080604^
"^DD",14.72,14.72101,3,21,1,0)
The short Status word.
"^DD",14.72,14.72101,3,"DT")
3080604
"^DD",14.72,14.72101,4,0)
PAIR^F^^0;4^K:$L(X)>20!($L(X)<3) X
"^DD",14.72,14.72101,4,3)
Answer must be 3-20 characters in length.
"^DD",14.72,14.72101,4,21,0)
^^1^1^3080604^
"^DD",14.72,14.72101,4,21,1,0)
The Box:Volume pair name.
"^DD",14.72,14.72101,4,"DT")
3080618
"^DD",14.72,14.72101,5,0)
LONG STATUS^F^^0;5^K:$L(X)>30!($L(X)<2) X
"^DD",14.72,14.72101,5,3)
Answer must be 2-30 characters in length.
"^DD",14.72,14.72101,5,21,0)
^^1^1^3080604^
"^DD",14.72,14.72101,5,21,1,0)
This is the Long Status message.
"^DD",14.72,14.72101,5,"DT")
3080604
"^DD",14.72,14.72201,0)
SUBMANAGERS SUB-FIELD^^5^5
"^DD",14.72,14.72201,0,"DT")
3080618
"^DD",14.72,14.72201,0,"IX","B",14.72201,.01)

"^DD",14.72,14.72201,0,"NM","SUBMANAGERS")

"^DD",14.72,14.72201,0,"UP")
14.72
"^DD",14.72,14.72201,.01,0)
SUBMANAGER^NJ9,0^^0;1^K:+X'=X!(X>999999999)!(X<1)!(X?.E1"."1N.N) X
"^DD",14.72,14.72201,.01,1,0)
^.1
"^DD",14.72,14.72201,.01,1,1,0)
14.72201^B
"^DD",14.72,14.72201,.01,1,1,1)
S ^%ZIS(14.72,DA(1),2,"B",$E(X,1,30),DA)=""
"^DD",14.72,14.72201,.01,1,1,2)
K ^%ZIS(14.72,DA(1),2,"B",$E(X,1,30),DA)
"^DD",14.72,14.72201,.01,3)
Type a Number between 1 and 999999999, 0 Decimal Digits
"^DD",14.72,14.72201,.01,21,0)
^^1^1^3080604^
"^DD",14.72,14.72201,.01,21,1,0)
This field holds info about the sub-managers.
"^DD",14.72,14.72201,.01,"DT")
3080619
"^DD",14.72,14.72201,2,0)
DATETIME^FO^^0;2^K:$L(X)>11!($L(X)<5) X
"^DD",14.72,14.72201,2,2)
S Y(0)=Y S Y=$$HTE^XLFDT(Y)
"^DD",14.72,14.72201,2,2.1)
S Y=$$HTE^XLFDT(Y)
"^DD",14.72,14.72201,2,3)
Answer must be 5-11 characters in length.
"^DD",14.72,14.72201,2,21,0)
^^1^1^3080604^
"^DD",14.72,14.72201,2,21,1,0)
This is the $H time that this sub-manager updated the node.
"^DD",14.72,14.72201,2,"DT")
3080611
"^DD",14.72,14.72201,3,0)
STATUS^F^^0;3^K:$L(X)>15!($L(X)<1) X
"^DD",14.72,14.72201,3,3)
Answer must be 1-15 characters in length.
"^DD",14.72,14.72201,3,21,0)
^^1^1^3080604^
"^DD",14.72,14.72201,3,21,1,0)
This is the sub-managers status.
"^DD",14.72,14.72201,3,"DT")
3080604
"^DD",14.72,14.72201,4,0)
BALANCE^S^0:NO;1:YES;^0;4^Q
"^DD",14.72,14.72201,4,21,0)
^^1^1^3080604^
"^DD",14.72,14.72201,4,21,1,0)
Is the sub-manager in Balance mode.
"^DD",14.72,14.72201,4,"DT")
3080604
"^DD",14.72,14.72201,5,0)
PAIR^F^^0;5^K:$L(X)>20!($L(X)<3) X
"^DD",14.72,14.72201,5,3)
Answer must be 3-20 characters in length.
"^DD",14.72,14.72201,5,21,0)
^^1^1^3080618^
"^DD",14.72,14.72201,5,21,1,0)
This field hold the Box-Volume pair that the submanagers is running on.
"^DD",14.72,14.72201,5,"DT")
3080618
"^DIC",14.71,14.71,0)
TASKMAN MONITOR^14.71
"^DIC",14.71,14.71,0,"GL")
^%ZIS(14.71,
"^DIC",14.71,14.71,"%",0)
^1.005^^0
"^DIC",14.71,14.71,"%D",0)
^^3^3^3000313^
"^DIC",14.71,14.71,"%D",1,0)
This Taskman file hold counts that taskman has collected during the day.
"^DIC",14.71,14.71,"%D",2,0)
Each of the fields 3 to 26 holds the count for 1 hour starting from
"^DIC",14.71,14.71,"%D",3,0)
midnight.
"^DIC",14.71,"B","TASKMAN MONITOR",14.71)

"^DIC",14.72,14.72,0)
TASKMAN SNAPSHOT^14.72
"^DIC",14.72,14.72,0,"GL")
^%ZIS(14.72,
"^DIC",14.72,14.72,"%",0)
^1.005^^0
"^DIC",14.72,14.72,"%D",0)
^1.001^4^4^3080702^^
"^DIC",14.72,14.72,"%D",1,0)
This file holds Taskman SnapShot data.
"^DIC",14.72,14.72,"%D",2,0)
This is a snapshot of the counts in the taskman ^%ZTSCH global.
"^DIC",14.72,14.72,"%D",3,0)
There should be no user entry of this data.
"^DIC",14.72,14.72,"%D",4,0)
It is just for reporting.
"^DIC",14.72,"B","TASKMAN SNAPSHOT",14.72)

**END**
**END**

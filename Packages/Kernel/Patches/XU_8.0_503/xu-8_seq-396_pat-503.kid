Released XU*8*503 SEQ #396
Extracted from mail message
**KIDS**:XU*8.0*503^

**INSTALL NAME**
XU*8.0*503
"BLD",1090,0)
XU*8.0*503^KERNEL^0^3080520^y
"BLD",1090,1,0)
^^2^2^3080520^
"BLD",1090,1,1,0)
This Kernel patch XU*8.0*503; See If a User Access to an Option.
"BLD",1090,1,2,0)
Please refer to the Description in Forum Module for details.
"BLD",1090,4,0)
^9.64PA^^
"BLD",1090,6.3)
2
"BLD",1090,"ABPKG")
n
"BLD",1090,"KRN",0)
^9.67PA^779.2^20
"BLD",1090,"KRN",.4,0)
.4
"BLD",1090,"KRN",.401,0)
.401
"BLD",1090,"KRN",.402,0)
.402
"BLD",1090,"KRN",.403,0)
.403
"BLD",1090,"KRN",.5,0)
.5
"BLD",1090,"KRN",.84,0)
.84
"BLD",1090,"KRN",3.6,0)
3.6
"BLD",1090,"KRN",3.8,0)
3.8
"BLD",1090,"KRN",9.2,0)
9.2
"BLD",1090,"KRN",9.8,0)
9.8
"BLD",1090,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",1090,"KRN",9.8,"NM",1,0)
XQCHK^^0^B16817550
"BLD",1090,"KRN",9.8,"NM",2,0)
XQCHK2^^0^B6390700
"BLD",1090,"KRN",9.8,"NM",3,0)
XQCHK3^^0^B53865411
"BLD",1090,"KRN",9.8,"NM","B","XQCHK",1)

"BLD",1090,"KRN",9.8,"NM","B","XQCHK2",2)

"BLD",1090,"KRN",9.8,"NM","B","XQCHK3",3)

"BLD",1090,"KRN",19,0)
19
"BLD",1090,"KRN",19.1,0)
19.1
"BLD",1090,"KRN",101,0)
101
"BLD",1090,"KRN",409.61,0)
409.61
"BLD",1090,"KRN",771,0)
771
"BLD",1090,"KRN",779.2,0)
779.2
"BLD",1090,"KRN",870,0)
870
"BLD",1090,"KRN",8989.51,0)
8989.51
"BLD",1090,"KRN",8989.52,0)
8989.52
"BLD",1090,"KRN",8994,0)
8994
"BLD",1090,"KRN","B",.4,.4)

"BLD",1090,"KRN","B",.401,.401)

"BLD",1090,"KRN","B",.402,.402)

"BLD",1090,"KRN","B",.403,.403)

"BLD",1090,"KRN","B",.5,.5)

"BLD",1090,"KRN","B",.84,.84)

"BLD",1090,"KRN","B",3.6,3.6)

"BLD",1090,"KRN","B",3.8,3.8)

"BLD",1090,"KRN","B",9.2,9.2)

"BLD",1090,"KRN","B",9.8,9.8)

"BLD",1090,"KRN","B",19,19)

"BLD",1090,"KRN","B",19.1,19.1)

"BLD",1090,"KRN","B",101,101)

"BLD",1090,"KRN","B",409.61,409.61)

"BLD",1090,"KRN","B",771,771)

"BLD",1090,"KRN","B",779.2,779.2)

"BLD",1090,"KRN","B",870,870)

"BLD",1090,"KRN","B",8989.51,8989.51)

"BLD",1090,"KRN","B",8989.52,8989.52)

"BLD",1090,"KRN","B",8994,8994)

"BLD",1090,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",1090,"QUES",0)
^9.62^^
"BLD",1090,"REQB",0)
^9.611^1^1
"BLD",1090,"REQB",1,0)
XU*8.0*427^1
"BLD",1090,"REQB","B","XU*8.0*427",1)

"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3051215^2970507^.5
"PKG",3,22,1,"PAH",1,0)
503^3080520
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3080520
"PKG",3,22,1,"PAH",1,1,1,0)
This Kernel patch XU*8.0*503; See If a User Access to an Option.
"PKG",3,22,1,"PAH",1,1,2,0)
Please refer to the Description in Forum Module for details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","XQCHK")
0^1^B16817550^B16817550
"RTN","XQCHK",1,0)
XQCHK ; SEA/MJM - Check security on option # XQCY ;5/20/08
"RTN","XQCHK",2,0)
 ;;8.0;KERNEL;**47,110,149,303,427,503**;Jul 10, 1995;Build 2
"RTN","XQCHK",3,0)
 ;;"Per VHA Directive 2004-038, this routine should not be modified".
"RTN","XQCHK",4,0)
 ;
"RTN","XQCHK",5,0)
 Q:'$D(XQCY)!(XQCY<1)  S:'$D(XQJMP) XQJMP=0
"RTN","XQCHK",6,0)
 I '$D(XQY0) S XQY0=^DIC(19,+XQCY,0)
"RTN","XQCHK",7,0)
 I '$D(XQCY0) S XQSAV=XQY0,XQY=XQCY D SET Q:XQCY<0  S XQCY0=XQY0,XQY0=XQSAV
"RTN","XQCHK",8,0)
CHK I XQCY0="" S XQCY=-1 G OUT
"RTN","XQCHK",9,0)
 I $P(XQCY0,U,3)'="" S XQCY=-1 G OUT
"RTN","XQCHK",10,0)
 N XQRT S XQRT=$$CHCKL^XQCHK2(XQCY0,DUZ) I +XQRT S XQCY=-2 G OUT  ; add this line to check all Locks
"RTN","XQCHK",11,0)
 I $L($P(XQCY0,U,6)) S %="" F %XQI=1:1 S %=$P($P(XQCY0,U,6),",",%XQI) Q:%=""  I '$D(^XUSEC(%,DUZ)) S XQCY=-2 G OUT  ; remove
"RTN","XQCHK",12,0)
 N XQRT S XQRT=$$CHCKRL^XQCHK2(XQCY0,DUZ) I +XQRT S XQCY=-3 G OUT  ; add this line to check all Reversed Locks
"RTN","XQCHK",13,0)
 I $L($P(XQCY0,U,16)) S %="" F %XQI=1:1 S %=$P($P(XQCY0,U,16),",",%XQI) Q:%=""  I $D(^XUSEC(%,DUZ)) S XQCY=-3 G OUT  ; remove
"RTN","XQCHK",14,0)
 I $L($P(XQCY0,U,9)) S XQZ=$P(XQCY0,U,9) D ^XQDATE S X=% D XQO^XQ92 I X="" S XQCY=-4 G OUT
"RTN","XQCHK",15,0)
 G:$P(XQCY0,U,10)'["y" OUT
"RTN","XQCHK",16,0)
 S %=0 F %XQI=1:1 S %=$O(^DIC(19,XQCY,3.96,%,0)) Q:%=""  I IOS=% G OUT
"RTN","XQCHK",17,0)
 S XQCY=-5 G OUT
"RTN","XQCHK",18,0)
 Q
"RTN","XQCHK",19,0)
 ;
"RTN","XQCHK",20,0)
OUT K %,%XQI,XQCY0,%Y,XQZ
"RTN","XQCHK",21,0)
 Q
"RTN","XQCHK",22,0)
 ;
"RTN","XQCHK",23,0)
JMP ;Check all options in jump path in %XQJP returned as "" if not OK
"RTN","XQCHK",24,0)
 S XQJMP=1
"RTN","XQCHK",25,0)
 F %XQCI=1:1 S XQCY=$P(%XQJP,",",%XQCI) Q:XQCY=""  S XQCY0=$G(^XUTL("XQO",XQDIC,"^",XQCY)),XQCY0=$P(XQCY0,U,2,99) D CHK S:XQCY<0 %XQJP=""
"RTN","XQCHK",26,0)
 K %XQCI,XQCY,XQCY0
"RTN","XQCHK",27,0)
 Q
"RTN","XQCHK",28,0)
 ;
"RTN","XQCHK",29,0)
SET ;Produce the same XQY0 as SET1^XQ7 without the synonym
"RTN","XQCHK",30,0)
 I '$D(^DIC(19,+XQY,0)) S XQY=-1 Q
"RTN","XQCHK",31,0)
S1 Q:XQY'>0  S XQY0=^DIC(19,+XQY,0),XQY0=$P(XQY0,U,1,2)_U_$S($P(XQY0,U,3)]"":1,1:"")_U_$P(XQY0,U,4)_U_U_$P(XQY0,U,6,99)
"RTN","XQCHK",32,0)
 S %="" I $D(^DIC(19,+XQY,3.91)) F %XQI=0:0 S %XQI=$O(^DIC(19,+XQY,3.91,%XQI)) Q:%XQI=""!(%XQI'=+%XQI)  I ^(%XQI,0)]"" S %=$S(%'="":%_";",1:"")_$P(^(0),U,1)_$P(^(0),U,2)
"RTN","XQCHK",33,0)
 I %]"" S XQY0=$P(XQY0,U,1,8)_U_%_U_$P(XQY0,U,10,99)
"RTN","XQCHK",34,0)
 I $P(XQY0,U,16),$D(^DIC(19,XQY,3)) S %=$P(^(3),U) I %'="" S XQY0=$P(XQY0,U,1,15)_U_%_U_$P(XQY0,U,17,99)
"RTN","XQCHK",35,0)
 K %,%XQI
"RTN","XQCHK",36,0)
 Q
"RTN","XQCHK",37,0)
 ;
"RTN","XQCHK",38,0)
MES ;Messages for rejected options from a call to XQCHK
"RTN","XQCHK",39,0)
 W $C(7)
"RTN","XQCHK",40,0)
 I XQCY=-1 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," is out of order with the message:",!?10,$P(^DIC(19,XQY,0),U,3)
"RTN","XQCHK",41,0)
 I XQCY=-2 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," is locked."
"RTN","XQCHK",42,0)
 I XQCY=-3 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," has a reverse lock on it."
"RTN","XQCHK",43,0)
 I XQCY=-4 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," not allowed right now."
"RTN","XQCHK",44,0)
 I XQCY=-5 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," not allowed on this device."
"RTN","XQCHK",45,0)
 Q
"RTN","XQCHK",46,0)
 ;
"RTN","XQCHK",47,0)
OP ;Find out what option or protocol is in charge right now
"RTN","XQCHK",48,0)
 ;Returns option or protocol name and text in XQOPT
"RTN","XQCHK",49,0)
 S U="^",%XQ=0
"RTN","XQCHK",50,0)
 I $D(XQORNOD) S %XQ=+XQORNOD,%XQ1=U_$P(XQORNOD,";",2),%XQ=@(%XQ1_%XQ_",0)"),XQOPT=$P(%XQ,U)_U_$P(%XQ,U,2)
"RTN","XQCHK",51,0)
 I '$D(XQORNOD) S %XQ=$S($D(XQY)#2:XQY,1:0) I %XQ S %XQ1=^DIC(19,+%XQ,0),XQOPT=$P(%XQ1,U)_U_$P(%XQ1,U,2)
"RTN","XQCHK",52,0)
 I '$D(XQOPT) S XQOPT="-1^Unknown"
"RTN","XQCHK",53,0)
 K %XQ,%XQ1
"RTN","XQCHK",54,0)
 Q
"RTN","XQCHK",55,0)
 ;
"RTN","XQCHK",56,0)
OP1() ;Extrinsic function call returns 3 pieces: 1. "P", "O", or "U" for
"RTN","XQCHK",57,0)
 ;Protocol, Option, or Unknown.  2: The Option or Protocol's name. 3:
"RTN","XQCHK",58,0)
 ;3: Text name of the Protocol or Option.  For example:
"RTN","XQCHK",59,0)
 ;
"RTN","XQCHK",60,0)
 ;           O^EVE^System Manager's Menu
"RTN","XQCHK",61,0)
 ;
"RTN","XQCHK",62,0)
 N %,%XQ,%XQ1
"RTN","XQCHK",63,0)
 S U="^",%XQ=0
"RTN","XQCHK",64,0)
 I $D(XQORNOD) S %XQ=+XQORNOD,%XQ1=U_$P(XQORNOD,";",2),%XQ=@(%XQ1_%XQ_",0)"),%="P"_U_$P(%XQ,U)_U_$P(%XQ,U,2)
"RTN","XQCHK",65,0)
 I '$D(XQORNOD) S %XQ=$S($D(XQY)#2:XQY,1:0) I %XQ S %XQ1=^DIC(19,+%XQ,0),%="O"_U_$P(%XQ1,U)_U_$P(%XQ1,U,2)
"RTN","XQCHK",66,0)
 I '$D(%) S %="U"_U_"Unknown"_U_"No option or protocol data available"
"RTN","XQCHK",67,0)
 Q %
"RTN","XQCHK",68,0)
 ;
"RTN","XQCHK",69,0)
ACCESS(%XQUSR,%XQOP) ;Find out if a user has access to a particular option
"RTN","XQCHK",70,0)
 Q $$ACCESS^XQCHK3(%XQUSR,%XQOP)
"RTN","XQCHK",71,0)
 ;
"RTN","XQCHK",72,0)
OPACCES ;Entry point for the option that checks to see if a user has
"RTN","XQCHK",73,0)
 ;access to a particular option by calling the above function.
"RTN","XQCHK",74,0)
 D OPACCES^XQCHK3
"RTN","XQCHK",75,0)
 Q
"RTN","XQCHK",76,0)
 ;
"RTN","XQCHK",77,0)
KEYSET(XQU) ;Collect users keys and set them into ^TMP($J)
"RTN","XQCHK",78,0)
 N %,XQI
"RTN","XQCHK",79,0)
 S %=0 F XQI=0:1 S %=$O(^VA(200,XQU,51,"B",%)) Q:%=""  S:$D(^DIC(19.1,%,0)) ^TMP($J,$P(^DIC(19.1,%,0),U),%)=""
"RTN","XQCHK",80,0)
 Q
"RTN","XQCHK2")
0^2^B6390700^B6390700
"RTN","XQCHK2",1,0)
XQCHK2 ; OAK-BP/BDT - Internal APIs to check Keys for options; 5/20/08
"RTN","XQCHK2",2,0)
 ;;8.0;KERNEL;**427,503**;Jul 10, 1995;Build 2
"RTN","XQCHK2",3,0)
 ;;"Per VHA Directive 2004-038, this routine should not be modified".
"RTN","XQCHK2",4,0)
 Q
"RTN","XQCHK2",5,0)
 ;; These Internal Kernel APIs are using in the routine XQCHK
"RTN","XQCHK2",6,0)
 ;; to check Keys for options
"RTN","XQCHK2",7,0)
 ;; 
"RTN","XQCHK2",8,0)
CHCKL(XQCY0,XQDUZ) ;Entry point for checking all Locks for an option
"RTN","XQCHK2",9,0)
 ;; XQCY0 is $P(^XUTL("XQO",XQDIC,"^",%XQOP),"^",2,99)
"RTN","XQCHK2",10,0)
 ;; XQDUZ is IEN of user
"RTN","XQCHK2",11,0)
 ;; Return XQRT: Zero or 1^Key found that user needed for the option
"RTN","XQCHK2",12,0)
 S XQCY0=$G(XQCY0)
"RTN","XQCHK2",13,0)
 N XQI,XQY,XQX,XQRT,XQK S (XQRT,XQX)=0
"RTN","XQCHK2",14,0)
 ;check Key for the option; p457
"RTN","XQCHK2",15,0)
 S XQY=$P(XQCY0,"^"),XQX=$$GETIEN(XQY)
"RTN","XQCHK2",16,0)
 I +XQX S XQK=$$GET1^DIQ(19,XQX,3)
"RTN","XQCHK2",17,0)
 I $G(XQK)'="",'$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK Q XQRT
"RTN","XQCHK2",18,0)
 ;loop through higher menu options.
"RTN","XQCHK2",19,0)
 S XQY=$P(XQCY0,"^",5)
"RTN","XQCHK2",20,0)
 F XQI=1:1  S XQX=$P(XQY,",",XQI) Q:'XQX  D
"RTN","XQCHK2",21,0)
 . I +XQX S XQK=$$GET1^DIQ(19,XQX,3) I XQK'="",'$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK Q
"RTN","XQCHK2",22,0)
 Q XQRT
"RTN","XQCHK2",23,0)
 ;
"RTN","XQCHK2",24,0)
CHCKRL(XQCY0,XQDUZ) ;Entry point for checking all Reversed Locks for an option
"RTN","XQCHK2",25,0)
 ;; XQCY0 is $P(^XUTL("XQO",XQDIC,"^",%XQOP),"^",2,99)
"RTN","XQCHK2",26,0)
 ;; XQDUZ is IEN of user
"RTN","XQCHK2",27,0)
 ;; Return XQRT: Zero or 1^Reversed Key found that user has
"RTN","XQCHK2",28,0)
 S XQCY0=$G(XQCY0)
"RTN","XQCHK2",29,0)
 N XQI,XQY,XQX,XQRT,XQK S (XQRT,XQX)=0
"RTN","XQCHK2",30,0)
 ;check Reversed Key for the option; p457
"RTN","XQCHK2",31,0)
 S XQY=$P(XQCY0,"^"),XQX=$$GETIEN(XQY)
"RTN","XQCHK2",32,0)
 I +XQX S XQK=$$GET1^DIQ(19,XQX,3.01)
"RTN","XQCHK2",33,0)
 I $G(XQK)'="",$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK Q XQRT
"RTN","XQCHK2",34,0)
 ;loop through higher menu options.
"RTN","XQCHK2",35,0)
 S XQY=$P(XQCY0,"^",5)
"RTN","XQCHK2",36,0)
 F XQI=1:1  S XQX=$P(XQY,",",XQI) Q:'XQX  D
"RTN","XQCHK2",37,0)
 . I +XQX S XQK=$$GET1^DIQ(19,XQX,3.01) I XQK'="",$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK Q 
"RTN","XQCHK2",38,0)
 Q XQRT
"RTN","XQCHK2",39,0)
 ;
"RTN","XQCHK2",40,0)
GETIEN(XQNAME) ;get IEN for an option; 457
"RTN","XQCHK2",41,0)
 ;; XQNAME is name of an option
"RTN","XQCHK2",42,0)
 ;; Retrun XQIEN: Null or IEN if existed
"RTN","XQCHK2",43,0)
 N XQIEN S XQIEN=""
"RTN","XQCHK2",44,0)
 I $G(XQNAME)="" Q XQIEN
"RTN","XQCHK2",45,0)
 I '$D(^DIC(19,"B",XQNAME)) Q XQIEN
"RTN","XQCHK2",46,0)
 S XQIEN=$O(^DIC(19,"B",XQNAME,XQIEN))
"RTN","XQCHK2",47,0)
 Q XQIEN
"RTN","XQCHK2",48,0)
 ;
"RTN","XQCHK2",49,0)
CHKTOPL(XQIEN,XQDUZ) ;Check Lock for the top level of the secondary options
"RTN","XQCHK2",50,0)
 ;this need to be called to check the top level first when check the
"RTN","XQCHK2",51,0)
 ;Locks for lower menu option because the 6th piece of ^XUTL does not
"RTN","XQCHK2",52,0)
 ;contain the IEN of the top menu option.
"RTN","XQCHK2",53,0)
 N XQRT,XQK S XQRT=0
"RTN","XQCHK2",54,0)
 I XQIEN'=+$G(XQIEN) Q XQRT
"RTN","XQCHK2",55,0)
 S XQK=$$GET1^DIQ(19,XQIEN,3)
"RTN","XQCHK2",56,0)
 I $G(XQK)'="",'$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK
"RTN","XQCHK2",57,0)
 Q XQRT
"RTN","XQCHK2",58,0)
 ;
"RTN","XQCHK2",59,0)
CHKTOPRL(XQIEN,XQDUZ) ;Check Reversed Lock the top level of the secondary options
"RTN","XQCHK2",60,0)
 ;this need to be called to check the top level first when check the
"RTN","XQCHK2",61,0)
 ;Reversed Locks for lower menu option because the 6th piece of ^XUTL does not
"RTN","XQCHK2",62,0)
 ;contain the IEN of the top menu option.
"RTN","XQCHK2",63,0)
 N XQRT,XQK S XQRT=0
"RTN","XQCHK2",64,0)
 I XQIEN'=+$G(XQIEN) Q XQRT
"RTN","XQCHK2",65,0)
 S XQK=$$GET1^DIQ(19,XQIEN,3.01)
"RTN","XQCHK2",66,0)
 I $G(XQK)'="",$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK
"RTN","XQCHK2",67,0)
 Q XQRT
"RTN","XQCHK3")
0^3^B53865411^B53861880
"RTN","XQCHK3",1,0)
XQCHK3 ; OAK-BY/BDT - This routine for XQCHK; 5/20/08
"RTN","XQCHK3",2,0)
 ;;8.0;KERNEL;**503**;Jul 10, 1995;Build 2
"RTN","XQCHK3",3,0)
 ;;"Per VHA Directive 2004-038, this routine should not be modified".
"RTN","XQCHK3",4,0)
 ;
"RTN","XQCHK3",5,0)
 Q
"RTN","XQCHK3",6,0)
OPACCES ;Entry point for the option that checks to see if a user has
"RTN","XQCHK3",7,0)
 ;access to a particular option by calling the above function.
"RTN","XQCHK3",8,0)
 N DIC,X,Y,XQANS,XQOPN,XQUSER,XQUSN,XQOPT
"RTN","XQCHK3",9,0)
 ;get user
"RTN","XQCHK3",10,0)
 S DIC(0)="AEMNQ",DIC="^VA(200,",DIC("A")="Please enter the user's name: " D ^DIC
"RTN","XQCHK3",11,0)
 I $D(DUOUT)!($D(DTOUT)) D KILLFM Q
"RTN","XQCHK3",12,0)
 I Y=-1 W !!?5,"Sorry we couldn't find that user in the New Person File.",! D KILLFM Q
"RTN","XQCHK3",13,0)
 S XQUSN=+Y,XQUSER=$P(Y,U,2) D KILLFM
"RTN","XQCHK3",14,0)
 ;get option
"RTN","XQCHK3",15,0)
 S DIC(0)="AEMNQ",DIC="^DIC(19,",DIC("A")="Please enter the name of the option: " D ^DIC
"RTN","XQCHK3",16,0)
 I $D(DUOUT)!($D(DTOUT)) D KILLFM Q
"RTN","XQCHK3",17,0)
 I Y=-1 W !!?5,"Sorry we couldn't find that option.",! D KILLFM Q
"RTN","XQCHK3",18,0)
 S XQOPN=+Y,XQOPT=$P(Y,U,2) D KILLFM
"RTN","XQCHK3",19,0)
 ;check keys
"RTN","XQCHK3",20,0)
 S XQANS=$$ACCESS(XQUSN,XQOPN)
"RTN","XQCHK3",21,0)
 ;print out
"RTN","XQCHK3",22,0)
 D PRINT(XQANS)
"RTN","XQCHK3",23,0)
 Q
"RTN","XQCHK3",24,0)
 ;
"RTN","XQCHK3",25,0)
ACCESS(%XQUSR,%XQOP) ;Find out if a user has access to a particular option
"RTN","XQCHK3",26,0)
 ;;W $$ACCESS(DUZ,Option IEN) returns:
"RTN","XQCHK3",27,0)
 ;;
"RTN","XQCHK3",28,0)
 ;;-1:no such user in the New Person File
"RTN","XQCHK3",29,0)
 ;;-2: User terminated or has no access code
"RTN","XQCHK3",30,0)
 ;;-3: no such option in the Option File
"RTN","XQCHK3",31,0)
 ;;0: no access found in any menu tree the user owns
"RTN","XQCHK3",32,0)
 ;;
"RTN","XQCHK3",33,0)
 ;;All other cases return a 4-piece string stating
"RTN","XQCHK3",34,0)
 ;;access ^ menu tree IEN ^ a set of codes ^ key
"RTN","XQCHK3",35,0)
 ;;
"RTN","XQCHK3",36,0)
 ;;O^tree^codes^key: No access because of locks (see XQCODES below)
"RTN","XQCHK3",37,0)
 ;;where 'tree' is the menu where access WOULD be allowed
"RTN","XQCHK3",38,0)
 ;;and 'key' is the key preventing access
"RTN","XQCHK3",39,0)
 ;;
"RTN","XQCHK3",40,0)
 ;;1^OpIEN^^: Access allowed through Primary Menu
"RTN","XQCHK3",41,0)
 ;;2^OpIEN^codes^: Access found in the Common Options
"RTN","XQCHK3",42,0)
 ;;3^OpIEN^codes^: Access found in top level of secondary option
"RTN","XQCHK3",43,0)
 ;;4^OpIEN^codes^: Access through a the secondary menu tree OpIEN.
"RTN","XQCHK3",44,0)
 ;;
"RTN","XQCHK3",45,0)
 ;;XQCODES can contain:
"RTN","XQCHK3",46,0)
 ;;N=No Primary Menu in the User File (warning only)
"RTN","XQCHK3",47,0)
 ;;L=Locked and the user does not have the key (forces 0 in first piece)
"RTN","XQCHK3",48,0)
 ;;R=Reverse lock and user has the key (forces 0 in first piece)
"RTN","XQCHK3",49,0)
 ;
"RTN","XQCHK3",50,0)
 N XQUSR,U S U="^"
"RTN","XQCHK3",51,0)
 S XQUSR=$$ACTIVE^XUSER(%XQUSR)
"RTN","XQCHK3",52,0)
 I XQUSR="" Q -1
"RTN","XQCHK3",53,0)
 I +XQUSR=0 Q -2
"RTN","XQCHK3",54,0)
 ;
"RTN","XQCHK3",55,0)
 ;Convert %XQOP to its IEN if the name is passed
"RTN","XQCHK3",56,0)
 I %XQOP'=+$G(%XQOP) D
"RTN","XQCHK3",57,0)
 .I $D(^DIC(19,"B",%XQOP))<1 S %XQOP=0 Q
"RTN","XQCHK3",58,0)
 .E  S %XQOP=$O(^DIC(19,"B",%XQOP,0))
"RTN","XQCHK3",59,0)
 .Q
"RTN","XQCHK3",60,0)
 I '%XQOP Q -3
"RTN","XQCHK3",61,0)
 I '$D(^DIC(19,%XQOP,0)) Q -3
"RTN","XQCHK3",62,0)
 ;checking
"RTN","XQCHK3",63,0)
 N XQRT,XQRT1 S XQRT="",XQRT1=""
"RTN","XQCHK3",64,0)
 S XQRT=$$CKPM(%XQUSR,%XQOP) ;primary menu and sub-menu in the primary menu
"RTN","XQCHK3",65,0)
 I $P(XQRT,U)=1 Q XQRT
"RTN","XQCHK3",66,0)
 I $P(XQRT,U)="N" Q XQRT
"RTN","XQCHK3",67,0)
 S XQRT1=XQRT
"RTN","XQCHK3",68,0)
 S XQRT=$$CKCM(%XQUSR,%XQOP) ;common menu
"RTN","XQCHK3",69,0)
 I $P(XQRT,U)=2 Q XQRT
"RTN","XQCHK3",70,0)
 I $P(XQRT,U)=0 S XQRT1=XQRT
"RTN","XQCHK3",71,0)
 S XQRT=$$CKTSM(%XQUSR,%XQOP) ;top level of secondary menus
"RTN","XQCHK3",72,0)
 I $P(XQRT,U)=3 Q XQRT
"RTN","XQCHK3",73,0)
 I $P(XQRT,U)=0 S XQRT1=XQRT
"RTN","XQCHK3",74,0)
 S XQRT=$$CKTESM(%XQUSR,%XQOP) ;sub-menu in secondary menus
"RTN","XQCHK3",75,0)
 I $P(XQRT,U)=4 Q XQRT
"RTN","XQCHK3",76,0)
 I $P(XQRT,U)=0 S XQRT1=XQRT
"RTN","XQCHK3",77,0)
 I XQRT1="" S XQRT1=0
"RTN","XQCHK3",78,0)
 Q XQRT1
"RTN","XQCHK3",79,0)
 ;
"RTN","XQCHK3",80,0)
CKPM(XQUSR,XQIEN) ;
"RTN","XQCHK3",81,0)
 ;Look in the user's primary menu tree
"RTN","XQCHK3",82,0)
 ;take in XQUSR = IEN in New Person file; XQIEN = IEN in the Option file
"RTN","XQCHK3",83,0)
 ;Return = access ^ menu tree IEN ^ a set of codes ^ key
"RTN","XQCHK3",84,0)
 N XQPM,XQDIC,XQTL,XQRT
"RTN","XQCHK3",85,0)
 S XQPM=$P($G(^VA(200,XQUSR,201)),"^")
"RTN","XQCHK3",86,0)
 I 'XQPM Q "N"
"RTN","XQCHK3",87,0)
 ; check Lock on the Primary menu
"RTN","XQCHK3",88,0)
 S XQRT=$$KEYSTOP(XQIEN,XQUSR)
"RTN","XQCHK3",89,0)
 I XQRT'="OK" Q "0^"_XQPM_"^"_XQRT
"RTN","XQCHK3",90,0)
 ; 
"RTN","XQCHK3",91,0)
 S XQDIC="P"_XQPM
"RTN","XQCHK3",92,0)
 I '$D(^XUTL("XQO",XQDIC,"^",XQIEN)) Q ""
"RTN","XQCHK3",93,0)
 S XQTL=$P($G(^XUTL("XQO",XQDIC,"^",XQIEN)),"^",2,99)
"RTN","XQCHK3",94,0)
 I XQTL="" Q ""
"RTN","XQCHK3",95,0)
 S XQRT=$$KEYS(XQTL,XQUSR)
"RTN","XQCHK3",96,0)
 I XQRT="OK" Q "1^"_XQPM
"RTN","XQCHK3",97,0)
 Q "0^"_XQPM_"^"_XQRT
"RTN","XQCHK3",98,0)
 ;
"RTN","XQCHK3",99,0)
CKCM(XQUSR,XQIEN) ;
"RTN","XQCHK3",100,0)
 ;Look in the user's primary menu tree
"RTN","XQCHK3",101,0)
 ;take in XQUSR = IEN in New Person file; XQIEN = IEN in the Option file
"RTN","XQCHK3",102,0)
 ;Return = access ^ menu tree IEN ^ a set of codes ^ key
"RTN","XQCHK3",103,0)
 N XQTL,XQDIC,XQCOM,XQRT
"RTN","XQCHK3",104,0)
 S XQCOM=$O(^DIC(19,"B","XUCOMMAND",0))
"RTN","XQCHK3",105,0)
 S XQDIC="PXU"
"RTN","XQCHK3",106,0)
 I '$D(^XUTL("XQO",XQDIC,"^",XQIEN)) Q "N"
"RTN","XQCHK3",107,0)
 S XQTL=$P($G(^XUTL("XQO",XQDIC,"^",%XQOP)),"^",2,99)
"RTN","XQCHK3",108,0)
 I XQTL="" Q ""
"RTN","XQCHK3",109,0)
 S XQRT=$$KEYS(XQTL,XQUSR)
"RTN","XQCHK3",110,0)
 I XQRT="OK" Q "2^"_"^^^"_XQCOM
"RTN","XQCHK3",111,0)
 Q "0^"_"^"_XQRT_"^"_XQCOM
"RTN","XQCHK3",112,0)
 ;
"RTN","XQCHK3",113,0)
CKTSM(XQUSR,XQIEN) ;
"RTN","XQCHK3",114,0)
 ;Look in the user's primary menu tree
"RTN","XQCHK3",115,0)
 ;take in XQUSR = IEN in New Person file; XQIEN = IEN in the Option file
"RTN","XQCHK3",116,0)
 ;Return = access ^ menu tree IEN ^ a set of codes ^ key
"RTN","XQCHK3",117,0)
 N XQDIC,XQRT,XQTL
"RTN","XQCHK3",118,0)
 S XQDIC="U"_XQUSR
"RTN","XQCHK3",119,0)
 I '$D(^VA(200,XQUSR,203,"B",XQIEN)) Q "N"
"RTN","XQCHK3",120,0)
 S XQTL=$P($G(^XUTL("XQO",XQDIC,"^",XQIEN)),"^",2,99)
"RTN","XQCHK3",121,0)
 I XQTL="" Q ""
"RTN","XQCHK3",122,0)
 S XQRT=$$KEYS(XQTL,XQUSR)
"RTN","XQCHK3",123,0)
 I XQRT="OK" Q "3^"_XQIEN
"RTN","XQCHK3",124,0)
 Q "0^"_XQIEN_"^"_XQRT
"RTN","XQCHK3",125,0)
 ;
"RTN","XQCHK3",126,0)
CKTESM(XQUSR,XQIEN) ;
"RTN","XQCHK3",127,0)
 ;Look in the user's primary menu tree
"RTN","XQCHK3",128,0)
 ;take in XQUSR = IEN in New Person file; XQIEN = IEN in the Option file
"RTN","XQCHK3",129,0)
 ;Return = access ^ menu tree IEN ^ a set of codes ^ key
"RTN","XQCHK3",130,0)
 N XQI,XQY,XQRT,XQDIC,XQTL S XQI=0,XQRT="",XQY=""
"RTN","XQCHK3",131,0)
 F  S XQI=$O(^VA(200,XQUSR,203,"B",XQI)) Q:XQI'>0  D
"RTN","XQCHK3",132,0)
 .S XQDIC="P"_XQI
"RTN","XQCHK3",133,0)
 .S XQTL=$G(^XUTL("XQO",XQDIC,"^",XQIEN)) I XQTL="" Q
"RTN","XQCHK3",134,0)
 .S XQTL=$P(XQTL,"^",2,99) I XQTL="" Q
"RTN","XQCHK3",135,0)
 .S XQRT=$$KEYSTOP(XQI,XQUSR)
"RTN","XQCHK3",136,0)
 .I XQRT="OK" S XQRT=$$KEYS(XQTL,XQUSR)
"RTN","XQCHK3",137,0)
 .S XQY=XQI
"RTN","XQCHK3",138,0)
 .I XQRT="OK" S XQI="ZZZ" Q
"RTN","XQCHK3",139,0)
 I XQRT="OK" Q "4^"_XQY
"RTN","XQCHK3",140,0)
 I XQRT="" Q XQRT
"RTN","XQCHK3",141,0)
 Q "0^"_XQY_"^"_XQRT
"RTN","XQCHK3",142,0)
 ;
"RTN","XQCHK3",143,0)
KEYS(XQA,XQUSR) ;Check for keys, reverse keys...
"RTN","XQCHK3",144,0)
 ;XQA         = ^XUTL("XQO",XQDIC,"^",%XQOP) or U_^DIC(19,%XQOP,0)
"RTN","XQCHK3",145,0)
 ;XQUSR       = IEN user in the New Person #200 file
"RTN","XQCHK3",146,0)
 ;Return XQRT = Null or Lock/ReLock if found
"RTN","XQCHK3",147,0)
 ;
"RTN","XQCHK3",148,0)
 N XQL,XQRL,XQRT S XQRT="OK"
"RTN","XQCHK3",149,0)
 S XQL=$$CHCKL^XQCHK2(XQA,XQUSR) ;check for keys
"RTN","XQCHK3",150,0)
 I +XQL>0 S XQRT="L^"_$P(XQL,"^",2)
"RTN","XQCHK3",151,0)
 S XQRL=$$CHCKRL^XQCHK2(XQA,XQUSR) ;check for reverse keys
"RTN","XQCHK3",152,0)
 I +XQRL>0 S XQRT="R^"_$P(XQRL,"^",2)
"RTN","XQCHK3",153,0)
 Q XQRT
"RTN","XQCHK3",154,0)
 ;
"RTN","XQCHK3",155,0)
KEYSTOP(XQIEN,XQUSR) ;check Lock and Reversed Lock on the top level menu
"RTN","XQCHK3",156,0)
 ;;XQIEN       = IEN option in the Option #19 file 
"RTN","XQCHK3",157,0)
 ;;XQUSR       = IEN use in the New Person #200 file
"RTN","XQCHK3",158,0)
 ;;Return XQRT = Null or Lock/ReLock if found
"RTN","XQCHK3",159,0)
 N XQL,XQRL,XQRT S XQRT="OK"
"RTN","XQCHK3",160,0)
 S XQL=$$CHKTOPL^XQCHK2(XQIEN,XQUSR) ;check for keys on top level
"RTN","XQCHK3",161,0)
 I +XQL>0 S XQRT="L^"_$P(XQL,"^",2)
"RTN","XQCHK3",162,0)
 S XQRL=$$CHKTOPRL^XQCHK2(XQIEN,XQUSR) ;check for reverse keys on top level
"RTN","XQCHK3",163,0)
 I +XQRL>0 S XQRT="R^"_$P(XQRL,"^",2)
"RTN","XQCHK3",164,0)
 Q XQRT
"RTN","XQCHK3",165,0)
 ;
"RTN","XQCHK3",166,0)
PRINT(XQANS) ; print out the result
"RTN","XQCHK3",167,0)
 N XQRSLT,XQTREE,XQPTR,XQCODES,XQKEY
"RTN","XQCHK3",168,0)
 S XQRSLT=+XQANS,XQTREE=""
"RTN","XQCHK3",169,0)
 S XQPTR=$P(XQANS,U,2)
"RTN","XQCHK3",170,0)
 I XQPTR>0 S XQTREE=$P(^DIC(19,$P(XQANS,U,2),0),U)
"RTN","XQCHK3",171,0)
 S XQCODES=$P(XQANS,U,3),XQKEY=$P(XQANS,U,4)
"RTN","XQCHK3",172,0)
 ;-------------------------------------------------------------------------------
"RTN","XQCHK3",173,0)
 I XQRSLT=-1 W !!?5,"User ",XQUSER," is not in the New Person File."
"RTN","XQCHK3",174,0)
 I XQRSLT=-2 W !!?5,"User ",XQUSER," has an active termination date,",!?5,"or no verify code."
"RTN","XQCHK3",175,0)
 I XQRSLT=-3 W !!?5,"Option ",XQOPT," is not in the Option File."
"RTN","XQCHK3",176,0)
 I XQRSLT=0 D
"RTN","XQCHK3",177,0)
 .W !!?5,"User ",XQUSER," does not have access to the option",!?5,XQOPT,"."
"RTN","XQCHK3",178,0)
 .I XQCODES["L" W !!?5,"There is a lock somewhere in the menu tree "_XQTREE,!?5,"and the user does not hold the key "_XQKEY_"."
"RTN","XQCHK3",179,0)
 .I XQCODES["R" W !!?5,"There is a reverse lock somewhere in the menu tree "_XQTREE,!?5,"and the user holds the key "_XQKEY_"."
"RTN","XQCHK3",180,0)
 .Q
"RTN","XQCHK3",181,0)
 I XQRSLT=1 W !!?5,"User ",XQUSER," has access to the option ",XQOPT,!?5,"through the primary menu ",XQTREE," (",$P(^DIC(19,XQPTR,0),U,2),")."
"RTN","XQCHK3",182,0)
 I XQRSLT=2 W !!?5,"User ",XQUSER," has access to the option ",XQOPT,!?5,"through the Common Options (XUCOMMAND)."
"RTN","XQCHK3",183,0)
 I XQRSLT=3 W !!?5,"User ",XQUSER," has access to the option ",XQOPT,!?5,"as a top-level secondary menu option."
"RTN","XQCHK3",184,0)
 I XQRSLT=4 W !!?5,"User ",XQUSER," has access to the option ",XQOPT,!?5,"through the secondary menu tree ",XQTREE," (",$P(^DIC(19,XQPTR,0),U,2),")."
"RTN","XQCHK3",185,0)
 W !
"RTN","XQCHK3",186,0)
 Q
"RTN","XQCHK3",187,0)
 ;
"RTN","XQCHK3",188,0)
KILLFM ;Kill off the FileMan variables
"RTN","XQCHK3",189,0)
 K D0,DI,DIC,DIE,DISYS,DQ,DR,DUOUT,DTOUT,X,Y
"RTN","XQCHK3",190,0)
 Q
"VER")
8.0^22.0
"BLD",1090,6)
^396
**END**
**END**

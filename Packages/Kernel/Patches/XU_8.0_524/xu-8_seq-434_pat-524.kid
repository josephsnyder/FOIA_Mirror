KIDS Distribution saved on Nov 03, 2010@09:46:18
XU 524
**KIDS**:XU*8.0*524^

**INSTALL NAME**
XU*8.0*524
"BLD",1228,0)
XU*8.0*524^KERNEL^0^3100126^y
"BLD",1228,1,0)
^^2^2^3090610^^
"BLD",1228,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"BLD",1228,1,2,0)
XU*8*524  SSH fix.
"BLD",1228,4,0)
^9.64PA^^
"BLD",1228,6)
^434
"BLD",1228,6.3)
12
"BLD",1228,"INID")
^y
"BLD",1228,"INIT")
POST^XU8P524
"BLD",1228,"KRN",0)
^9.67PA^9002226^21
"BLD",1228,"KRN",.4,0)
.4
"BLD",1228,"KRN",.401,0)
.401
"BLD",1228,"KRN",.402,0)
.402
"BLD",1228,"KRN",.403,0)
.403
"BLD",1228,"KRN",.5,0)
.5
"BLD",1228,"KRN",.84,0)
.84
"BLD",1228,"KRN",3.6,0)
3.6
"BLD",1228,"KRN",3.8,0)
3.8
"BLD",1228,"KRN",9.2,0)
9.2
"BLD",1228,"KRN",9.8,0)
9.8
"BLD",1228,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",1228,"KRN",9.8,"NM",1,0)
ZIS4ONT^^0^B29959546
"BLD",1228,"KRN",9.8,"NM",2,0)
ZIS^^0^B21144380
"BLD",1228,"KRN",9.8,"NM",3,0)
ZISHONT^^0^B59753873
"BLD",1228,"KRN",9.8,"NM",4,0)
ZISHGTM^^0^B32232259
"BLD",1228,"KRN",9.8,"NM",5,0)
ZISFONT^^0^B10288750
"BLD",1228,"KRN",9.8,"NM","B","ZIS",2)

"BLD",1228,"KRN",9.8,"NM","B","ZIS4ONT",1)

"BLD",1228,"KRN",9.8,"NM","B","ZISFONT",5)

"BLD",1228,"KRN",9.8,"NM","B","ZISHGTM",4)

"BLD",1228,"KRN",9.8,"NM","B","ZISHONT",3)

"BLD",1228,"KRN",19,0)
19
"BLD",1228,"KRN",19.1,0)
19.1
"BLD",1228,"KRN",101,0)
101
"BLD",1228,"KRN",409.61,0)
409.61
"BLD",1228,"KRN",771,0)
771
"BLD",1228,"KRN",779.2,0)
779.2
"BLD",1228,"KRN",870,0)
870
"BLD",1228,"KRN",8989.51,0)
8989.51
"BLD",1228,"KRN",8989.52,0)
8989.52
"BLD",1228,"KRN",8994,0)
8994
"BLD",1228,"KRN",9002226,0)
9002226
"BLD",1228,"KRN","B",.4,.4)

"BLD",1228,"KRN","B",.401,.401)

"BLD",1228,"KRN","B",.402,.402)

"BLD",1228,"KRN","B",.403,.403)

"BLD",1228,"KRN","B",.5,.5)

"BLD",1228,"KRN","B",.84,.84)

"BLD",1228,"KRN","B",3.6,3.6)

"BLD",1228,"KRN","B",3.8,3.8)

"BLD",1228,"KRN","B",9.2,9.2)

"BLD",1228,"KRN","B",9.8,9.8)

"BLD",1228,"KRN","B",19,19)

"BLD",1228,"KRN","B",19.1,19.1)

"BLD",1228,"KRN","B",101,101)

"BLD",1228,"KRN","B",409.61,409.61)

"BLD",1228,"KRN","B",771,771)

"BLD",1228,"KRN","B",779.2,779.2)

"BLD",1228,"KRN","B",870,870)

"BLD",1228,"KRN","B",8989.51,8989.51)

"BLD",1228,"KRN","B",8989.52,8989.52)

"BLD",1228,"KRN","B",8994,8994)

"BLD",1228,"KRN","B",9002226,9002226)

"BLD",1228,"QDEF")
^^^^YES
"BLD",1228,"QUES",0)
^9.62^^
"BLD",1228,"REQB",0)
^9.611^2^2
"BLD",1228,"REQB",1,0)
XU*8.0*499^2
"BLD",1228,"REQB",2,0)
XU*8.0*518^2
"BLD",1228,"REQB","B","XU*8.0*499",1)

"BLD",1228,"REQB","B","XU*8.0*518",2)

"INIT")
POST^XU8P524
"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3090706^3090706^6
"PKG",3,22,1,"PAH",1,0)
524^3100126^2
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3100126
"PKG",3,22,1,"PAH",1,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"PKG",3,22,1,"PAH",1,1,2,0)
XU*8*524  SSH fix.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","XU8P524")
0^^B31551^n/a
"RTN","XU8P524",1,0)
XU8P524 ;ISF/RWF - Patch XU*8*524 ;06/10/09  15:57
"RTN","XU8P524",2,0)
 ;;8.0;KERNEL;**524**;Jul 10, 1995;Build 12
"RTN","XU8P524",3,0)
 Q
"RTN","XU8P524",4,0)
 ;
"RTN","XU8P524",5,0)
POST ;POST-INIT
"RTN","XU8P524",6,0)
 D PATCH^ZTMGRSET(524)
"RTN","XU8P524",7,0)
 Q
"RTN","ZIS")
0^2^B21144380^B20827574
"RTN","ZIS",1,0)
%ZIS ;SFISC/AC,RWF -- DEVICE HANDLER ;01/25/10  17:19
"RTN","ZIS",2,0)
 ;;8.0;KERNEL;**18,23,69,112,199,191,275,363,440,499,524**;JUL 10, 1995;Build 12
"RTN","ZIS",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","ZIS",4,0)
 N %ZISOS,%ZISV
"RTN","ZIS",5,0)
 S U="^",%ZISOS=$G(^%ZOSF("OS")),%ZISV=$G(^%ZOSF("VOL")),POP=0 ;p524
"RTN","ZIS",6,0)
 ;Check SPOOLER special case first
"RTN","ZIS",7,0)
INIT ;I $D(ZTQUEUED),$G(IOT)="SPL",$D(IO)#2,$D(IO(0))#2,IO]"",IO=IO(0),$D(IO(1,IO))#2,%ZISOS["VAX DSM"!(%ZISOS["M/VX"),$G(IOP)[ION!(IOP[IO) K %ZIS,%IS,IOP Q
"RTN","ZIS",8,0)
 I $G(ZTQUEUED),$G(IOT)="SPL",$D(IOP),$L($G(IO)),IO=$G(IO(0)),$D(IO(1,IO))#2,(IOP[$G(ION)!(IOP[IO)) K %ZIS,%IS,IOP Q  ;p524
"RTN","ZIS",9,0)
 ;p524 Line above for HD141181.
"RTN","ZIS",10,0)
 I '$D(%ZIS),$D(%IS) M %ZIS=%IS
"RTN","ZIS",11,0)
 S:'($D(%ZIS)#2) %ZIS="M" M %IS=%ZIS ;update %IS for now
"RTN","ZIS",12,0)
 I '$D(^XUTL("XQ",$J,"MIXED OS")) S ^XUTL("XQ",$J,"MIXED OS")=$$PRI^%ZOSV
"RTN","ZIS",13,0)
 S %ZIS("PRI")=$G(^XUTL("XQ",$J,"MIXED OS"),1)
"RTN","ZIS",14,0)
 ;
"RTN","ZIS",15,0)
 I $D(ZTQUEUED) D  I '$D(IOP) S POP=1 G EXIT^%ZIS1
"RTN","ZIS",16,0)
 .I $D(ZTIO)#2,ZTIO="" S:%IS'[0 %IS=%IS_"0",%ZIS=%ZIS_"0"
"RTN","ZIS",17,0)
 I '$D(ZTQUEUED),%IS["T",$P($G(IOP),";")="Q" S POP=1 G EXIT^%ZIS1
"RTN","ZIS",18,0)
 N %,%A,%E,%H,%I,%X,%XX,%Y,%Z,%Z1,%Z2,%Z9,%Z90,%Z91,%Z95,%ZISB,%ZTIME,%ZTYPE
"RTN","ZIS",19,0)
 N %ZHFN,%ZISOLD,%ZTOUT,%ZISDTIM,DTOUT,DUOUT
"RTN","ZIS",20,0)
 S %ZISDTIM=$G(DTIME,300)
"RTN","ZIS",21,0)
 ;Save symbols to restore if don't open a device
"RTN","ZIS",22,0)
 D SYMBOL^%ZISUTL(0,$NA(%ZISOLD))
"RTN","ZIS",23,0)
A D CLEAN ;(p363) K IO("CLOSE"),IO("HFSIO")
"RTN","ZIS",24,0)
 K IO("P"),IO("Q"),IO("S"),IO("T")
"RTN","ZIS",25,0)
K2 D K2^%ZIS1
"RTN","ZIS",26,0)
 S %ZISB=%ZIS'["N",(%E,%H,POP)=0,%Y="" S:'$D(IO(0)) IO(0)=$I
"RTN","ZIS",27,0)
 ;I %ZISOS["VAX DSM",$I["SYS$INPUT:.;" S:%ZIS'[0 %IS=%IS_"0",%ZIS=%ZIS_"0"
"RTN","ZIS",28,0)
 ;I %IS["T"&(%IS["0") S (%H,%E)=0 G ^%ZIS1
"RTN","ZIS",29,0)
 I $D(IOP),IOP=$I!(IOP="HOME")!(0[IOP),$D(^XUTL("XQ",$J,"IO")) D HOME K %IS,%Y,%ZIS,%ZISB,%ZISV,IOP Q
"RTN","ZIS",30,0)
 ;Don't worry about HOME if %ZIS[0
"RTN","ZIS",31,0)
 D:%ZIS'[0 GETHOME G EXIT^%ZIS1:POP,^%ZIS1 ;Jump to next part
"RTN","ZIS",32,0)
 ;
"RTN","ZIS",33,0)
GETHOME I $D(IO("HOME")),$P(IO("HOME"),"^",2)=IO(0) S (%E,%H)=+IO("HOME") Q
"RTN","ZIS",34,0)
 I $D(^XUTL("XQ",$J,"IOS")),$D(^("IO")),IO(0)=^("IO") S (%E,%H)=^("IOS") Q
"RTN","ZIS",35,0)
 ;CALL LINEPORT CODE HERE---
"RTN","ZIS",36,0)
 S %=$$LINEPORT^%ZISUTL I % S (%E,%H)=% Q
"RTN","ZIS",37,0)
 S %ZISVT=$I D VTLKUP I '%E S %ZISVT=$I D VIRTUAL
"RTN","ZIS",38,0)
 I %ZISVT=""!(%E'>0) I %IS'[0 O IO(0)::0 I $T U IO(0) W !,"HOME DEVICE ("_$I_") DOES NOT EXIST IN THE DEVICE FILE",!,"PLEASE CONTACT YOUR SYSTEM MANAGER!",*7
"RTN","ZIS",39,0)
 S %H=%E S:'%H&(%IS'[0) POP=1 S:(%H>0)&('$D(IO("HOME"))) IO("HOME")=%H_"^"_$I
"RTN","ZIS",40,0)
 Q
"RTN","ZIS",41,0)
VIRTUAL ;See if a Virtual Terminal (LAT, TELNET)
"RTN","ZIS",42,0)
 ;Change the MSM check for telnet to work with v4.4
"RTN","ZIS",43,0)
 I %ZISOS["MSM" X "I $P($ZV,""Version "",2)'<3 S %ZISVT=$ZDE(+%ZISVT) I %ZISVT?.E1""~""4.5N.E S %ZISVT=""TELNET"""
"RTN","ZIS",44,0)
 F %ZISI=$L(%ZISVT):-1:0 D:$D(^%ZIS(1,"C",%ZISVT))  Q:$S('%E:0,'$D(^%ZIS(1,%E,"TYPE")):0,^("TYPE")="VTRM":1,1:0)  S %ZISVT=$E(%ZISVT,1,%ZISI)
"RTN","ZIS",45,0)
 .D VTLKUP Q:$S('%E:0,'$D(^%ZIS(1,%E,"TYPE")):0,^("TYPE")="VTRM":1,1:0)
"RTN","ZIS",46,0)
 .S %X=0 F %ZISX=%ZISV,"" Q:%X>0  S %X=0 F  S %E=+$O(^%ZIS(1,"CPU",%ZISX_"."_%ZISVT,%X)) S %X=%E Q:%E'>0  I $G(^%ZIS(1,+%E,"TYPE"))="VTRM" Q
"RTN","ZIS",47,0)
 Q
"RTN","ZIS",48,0)
VTLKUP F %ZISX=%ZISV,"" S %E=+$O(^%ZIS(1,"G","SYS."_%ZISX_"."_%ZISVT,0)) Q:%E  S %E=+$O(^%ZIS(1,"CPU",%ZISX_"."_%ZISVT,0)) Q:%E
"RTN","ZIS",49,0)
 Q
"RTN","ZIS",50,0)
 ;
"RTN","ZIS",51,0)
CURRENT N POP,%ZIS,%IS,%E,%H
"RTN","ZIS",52,0)
 S FF="#",SL=24,BS="*8",RM=80,(SUB,XY)="",%IS=0,%ZISOS=$G(^%ZOSF("OS")),%ZISV=$G(^("VOL")),POP=0
"RTN","ZIS",53,0)
 D GETHOME K %E,%IS,%ZISI,%ZISOS,%ZISV,%ZISVT,%ZISX Q:POP
"RTN","ZIS",54,0)
 I $D(^%ZIS(1,%H,"SUBTYPE")) S SUB=+^("SUBTYPE") K %H
"RTN","ZIS",55,0)
 I $D(SUB),SUB,$D(^%ZIS(2,SUB,1)) S SUB=$S($D(^(0)):$P(^(0),"^"),1:""),FF=$P(^(1),"^",2),SL=$P(^(1),"^",3),BS=$P(^(1),"^",4),XY=$P(^(1),"^",5),RM=+^(1)
"RTN","ZIS",56,0)
 E  S SUB=""
"RTN","ZIS",57,0)
 I $D(^%ZOSF("RM")) N X S X=RM X ^("RM") K %A
"RTN","ZIS",58,0)
 Q
"RTN","ZIS",59,0)
HOME ;Entry point to establish IO* variables for home device.
"RTN","ZIS",60,0)
 D CLEAN ;(p363)
"RTN","ZIS",61,0)
 N X I '$D(^XUTL("XQ",$J,"IO")) S IOP="HOME" D ^%ZIS Q
"RTN","ZIS",62,0)
 D RESETVAR
"RTN","ZIS",63,0)
 I $L($G(IO)),$P($G(IO("HOME")),"^",2)=IO,$D(IO(1,IO)) U IO ;p524
"RTN","ZIS",64,0)
 I '$D(IO("C")),$G(IOM),IO=$I,$D(IO(1,IO)),$D(^%ZOSF("RM")) S X=+IOM X ^("RM")
"RTN","ZIS",65,0)
 Q
"RTN","ZIS",66,0)
 ;IO("Q") is checked by many routines after a call to ^%ZISC, so only clean on call to %ZIS.
"RTN","ZIS",67,0)
CLEAN ;Cleanup env. Called from %ZISC also.
"RTN","ZIS",68,0)
 I $G(IOT)'="SPL" K IO("DOC"),IO("SPOOL") ;(p440)
"RTN","ZIS",69,0)
 I $G(IOT)'="HFS" K IO("HFSIO") ;p440
"RTN","ZIS",70,0)
 S (IOPAR,IOUPAR)=""
"RTN","ZIS",71,0)
 Q
"RTN","ZIS",72,0)
 ;
"RTN","ZIS",73,0)
RESETVAR ;Reset home IO* variables.
"RTN","ZIS",74,0)
 I '$D(^XUTL("XQ",$J,"IO")) Q
"RTN","ZIS",75,0)
 N %
"RTN","ZIS",76,0)
 F %="IO","IOBS","IOF","IOM","ION","IOS","IOSL","IOST","IOST(0)","IOT","IOXY","IOPAR","IOUPAR" I $D(^XUTL("XQ",$J,%))#2 S @%=^(%)
"RTN","ZIS",77,0)
 F %="IO(""IP"")","IO(""CLNM"")","IO(""DOC"")","IO(""HFSIO"")","IO(""SPOOL"")" I $D(^XUTL("XQ",$J,%))#2 S @%=^(%)
"RTN","ZIS",78,0)
 S POP=0,IO(0)=IO
"RTN","ZIS",79,0)
 Q
"RTN","ZIS",80,0)
SAVEVAR ;Save home IO* variables, called from XUS1,%ZTMS3
"RTN","ZIS",81,0)
 N %
"RTN","ZIS",82,0)
 F %="IO","IOBS","IOF","IOM","ION","IOS","IOSL","IOST","IOST(0)","IOT","IOXY","IOPAR","IOUPAR" I $D(@%) S ^XUTL("XQ",$J,%)=@%
"RTN","ZIS",83,0)
 F %="IO(""IP"")","IO(""CLNM"")","IO(""DOC"")","IO(""HFSIO"")","IO(""SPOOL"")" I $D(@%) S ^XUTL("XQ",$J,%)=@%
"RTN","ZIS",84,0)
 Q
"RTN","ZIS",85,0)
ZISLPC Q  ;No longer called in Kernel v8.
"RTN","ZIS",86,0)
 ;
"RTN","ZIS",87,0)
HLP1 G EN1^%ZIS7
"RTN","ZIS",88,0)
HLP2 N %E,%H,%X,%ZISV,X,%ZISDTIM
"RTN","ZIS",89,0)
 S %ZISDTIM=$G(DTIME,60),%ZISV=$S($D(^%ZOSF("VOL")):^("VOL"),1:"") G EN2^%ZIS7
"RTN","ZIS",90,0)
 ;
"RTN","ZIS",91,0)
REWIND(IO2,IOT,IOPAR) ;Rewind Device
"RTN","ZIS",92,0)
 N %,X,Y,$ES,$ET S $ET="D REWERR^%ZIS Q 0"
"RTN","ZIS",93,0)
 S %=$I
"RTN","ZIS",94,0)
 I '($D(IO2)#2)!'$D(IOT)!'$D(IOPAR) Q 0
"RTN","ZIS",95,0)
 I "MT^SDP^HFS"'[IOT Q 0
"RTN","ZIS",96,0)
 S @("Y=$$REW"_IOT_"^%ZIS4(IO2,IOPAR)")
"RTN","ZIS",97,0)
 U %
"RTN","ZIS",98,0)
 Q Y
"RTN","ZIS",99,0)
REWERR ;Error encountered
"RTN","ZIS",100,0)
 S IO("ERROR")=$EC
"RTN","ZIS",101,0)
 S $EC="",$ET="Q:$ES>1  S $EC="""" Q 0" S $EC=",U1,"
"RTN","ZIS",102,0)
 Q 0
"RTN","ZIS",103,0)
 ;
"RTN","ZIS4ONT")
0^1^B29959546^B29872561
"RTN","ZIS4ONT",1,0)
%ZIS4 ;SFISC/RWF,AC - DEVICE HANDLER SPOOL SPECIFIC CODE (Cache) ;04/06/09  13:28
"RTN","ZIS4ONT",2,0)
 ;;8.0;KERNEL;**34,59,69,191,278,293,440,499,524**;Jul 10, 1995;Build 12
"RTN","ZIS4ONT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","ZIS4ONT",4,0)
 ;
"RTN","ZIS4ONT",5,0)
OPEN ;Called for TRM devices
"RTN","ZIS4ONT",6,0)
 G OPN2:$D(IO(1,IO))
"RTN","ZIS4ONT",7,0)
 S POP=0 D OP1 G NOPEN:'$D(IO(1,IO))
"RTN","ZIS4ONT",8,0)
OPN2 ;
"RTN","ZIS4ONT",9,0)
 I $D(%ZISHP),'$D(IOP) W !,$C(7)_" Routing to device "_$P(^%ZIS(1,%E,0),"^",1)_$S($D(^(1)):" "_$P(^(1),"^",1)_" ",1:"")
"RTN","ZIS4ONT",10,0)
 Q
"RTN","ZIS4ONT",11,0)
NOPEN ;
"RTN","ZIS4ONT",12,0)
 I %IS'["D",$D(%ZISHP)!(%ZISHG]"") S POP=1 Q
"RTN","ZIS4ONT",13,0)
 I '$D(IOP) W $C(7)_"  [BUSY]" W "  ...  RETRY" S %=2,U="^" D YN^%ZIS1 G OPEN:%=1
"RTN","ZIS4ONT",14,0)
 S POP=1 Q
"RTN","ZIS4ONT",15,0)
 Q
"RTN","ZIS4ONT",16,0)
OP1 N $ET S $ET="G OPNERR^%ZIS4"
"RTN","ZIS4ONT",17,0)
 I $D(%ZISLOCK) L +@%ZISLOCK:5 E  S POP=1 Q
"RTN","ZIS4ONT",18,0)
 O IO::%ZISTO S:$T IO(1,IO)="" S:'$T POP=1
"RTN","ZIS4ONT",19,0)
 Q
"RTN","ZIS4ONT",20,0)
OPNERR S POP=1,IO("LASTERR")=$G(IO("ERROR")),IO("ERROR")=$ZE,$EC=""
"RTN","ZIS4ONT",21,0)
 Q
"RTN","ZIS4ONT",22,0)
 ;
"RTN","ZIS4ONT",23,0)
O ;Gets called for all devices
"RTN","ZIS4ONT",24,0)
 N X,%A1
"RTN","ZIS4ONT",25,0)
 D:%ZIS["L" ZIO
"RTN","ZIS4ONT",26,0)
 I $D(IO("S")),$D(^%ZIS(2,IO("S"),10)),^(10)]"" U IO(0) D X10^ZISX ;Open Printer port
"RTN","ZIS4ONT",27,0)
OPAR I $D(IOP),%ZTYPE="HFS",$D(%ZIS("HFSIO")),$D(%ZIS("IOPAR")),%ZIS("HFSIO")]"" S IO=%ZIS("HFSIO"),%ZISOPAR=%ZIS("IOPAR")
"RTN","ZIS4ONT",28,0)
 S %A=$S($L(%ZISOPAR):%ZISOPAR,%ZTYPE'["TRM":"",$E(%ZISIOST,1)="C":"("_+%Z91_":""C"")",$E(%ZISIOST,1,2)="PK":"("_+%Z91_":""P"")",1:+%Z91)
"RTN","ZIS4ONT",29,0)
 S %A=%A_$S(%A["):":"",%ZTYPE["OTH"&($P(%ZTIME,"^",3)="n"):"",1:":"_%ZISTO),%A=""""_IO_""""_$E(":",%A]"")_%A
"RTN","ZIS4ONT",30,0)
 D O1 I POP W:'$D(IOP) !,?5,$C(7)_"[Device is BUSY]" Q
"RTN","ZIS4ONT",31,0)
 ;I %ZTYPE="HFS" U IO S X=IO,IO=IO_";"_$P($ZIO,";",2),IO(1,IO)="" K IO(1,X)
"RTN","ZIS4ONT",32,0)
 U IO S $X=0,$Y=0
"RTN","ZIS4ONT",33,0)
 I $L(%ZISUPAR) S %A1=""""_IO_""":"_%ZISUPAR U @%A1
"RTN","ZIS4ONT",34,0)
 ;U:%IS'[0 IO(0)
"RTN","ZIS4ONT",35,0)
 G OXECUTE^%ZIS6
"RTN","ZIS4ONT",36,0)
 ;
"RTN","ZIS4ONT",37,0)
O1 N $ET S $ET="G OPNERR^%ZIS4"
"RTN","ZIS4ONT",38,0)
 I $D(%ZISLOCK) L +@%ZISLOCK:5 E  S POP=1 Q
"RTN","ZIS4ONT",39,0)
 O @%A S:'$T&(%A?.E1":".N) POP=1 S:'POP IO(1,IO)=""
"RTN","ZIS4ONT",40,0)
 S IO("ERROR")=""
"RTN","ZIS4ONT",41,0)
 Q
"RTN","ZIS4ONT",42,0)
 ;Version 3 used ip/port, Version 4 has ip:port|xx
"RTN","ZIS4ONT",43,0)
ZIO I $D(IO("IP")),$D(IO("ZIO")) Q  ;p499,p524
"RTN","ZIS4ONT",44,0)
 N %,%1 S %=$ZIO,%1=$$VERSION^%ZOSV
"RTN","ZIS4ONT",45,0)
 S IO("ZIO")=$S(%1<4:$I,1:$ZIO),%1=$S(%["/":"/",1:":")
"RTN","ZIS4ONT",46,0)
 ;Drop prefix
"RTN","ZIS4ONT",47,0)
 S:%["|TNT|" %=$E(%,6,999) S:%["|TNA|" %=$E(%,6,999)
"RTN","ZIS4ONT",48,0)
 ;Get IP name or number
"RTN","ZIS4ONT",49,0)
 S:$P(%,%1)["." IO("IP")=$P(%,%1)
"RTN","ZIS4ONT",50,0)
 I $$OS^%ZOSV="VMS",$G(IO("IP"))="" S IO("IP")=$P($ZF("TRNLNM","SYS$REM_NODE"),":") ;For SSH, p499
"RTN","ZIS4ONT",51,0)
 S:'$L(IO("ZIO")) IO("ZIO")=$G(IO("IP"))
"RTN","ZIS4ONT",52,0)
 I $L($G(IO("IP"))),IO("IP")'?1.3N1P1.3N1P1.3N1P1.3N S IO("IP")=$P($ZU(54,13,IO("IP")),",") ;p499
"RTN","ZIS4ONT",53,0)
 Q
"RTN","ZIS4ONT",54,0)
 ;
"RTN","ZIS4ONT",55,0)
SPOOL ;%ZDA=pointer to ^XMB(3.51, %ZFN=spool file Num/Name.
"RTN","ZIS4ONT",56,0)
 N %ZOS S %ZOS=$$OS^%ZOSV
"RTN","ZIS4ONT",57,0)
 I '$D(^XMB(3.51,0)) W:'$D(IOP) !?5,"The spooler files are not setup in this account." G NO
"RTN","ZIS4ONT",58,0)
 I $D(ZISDA) W:'$D(IOP) !?5,$C(7)_"You may not Spool the printing of a Spool document" G NO
"RTN","ZIS4ONT",59,0)
 I $D(DUZ)[0 W:'$D(IOP) !,"Must be a valid user." G NO
"RTN","ZIS4ONT",60,0)
 ;Get entry in Spool Doc file
"RTN","ZIS4ONT",61,0)
R S %ZY=-1 D NEWDOC^ZISPL1:$D(DUZ)=11 G NO:%ZY'>0 S %ZDA=+%ZY,%ZFN=$P(%ZY(0),U,2),IO("DOC")=$P(%ZY(0),U,1) G OK:$D(IO("Q"))
"RTN","ZIS4ONT",62,0)
 G:'%ZISB OK I '$P(%ZY,"^",3),%ZFN]"" D SPL3 G NO:%ZFN<0,DOC
"RTN","ZIS4ONT",63,0)
 I %ZOS="NT" D  G:%ZFN>255 NO
"RTN","ZIS4ONT",64,0)
 . F %ZFN=1:1:260 I '$D(^XMB(3.51,"C",%ZFN))!$D(^(%ZFN,%ZDA)) Q:%ZFN<256  W:'$D(IOP) $C(7)_"  DELETE SOME OTHER DOCUMENT!" Q
"RTN","ZIS4ONT",65,0)
 . Q:%ZFN>255  D SPL2 S $P(^XMB(3.51,%ZDA,0),U,2)=%ZFN,^XMB(3.51,"C",%ZFN,%ZDA)=""
"RTN","ZIS4ONT",66,0)
 I %ZOS="VMS" D  G:%ZFN=-1 NO
"RTN","ZIS4ONT",67,0)
 . S %ZFN=IO_"SPOOL_no_"_%ZDA_".TMP" D SPL2 Q:%ZFN=-1  S $P(^XMB(3.51,%ZDA,0),U,2)=%ZFN,^XMB(3.51,"C",%ZFN,%ZDA)="",IO=%ZFN
"RTN","ZIS4ONT",68,0)
DOC S IO("SPOOL")=%ZDA,^XUTL("XQ",$J,"SPOOL")=%ZDA
"RTN","ZIS4ONT",69,0)
 I $D(^%ZIS(1,%ZISIOS,1)),$P(^(1),"^",8),$O(^("SPL",0)) S ^XUTL("XQ",$J,"ADSPL")=%ZISIOS,ZISPLAD=%ZISIOS
"RTN","ZIS4ONT",70,0)
OK K %ZDA,%ZFN Q
"RTN","ZIS4ONT",71,0)
NO K %ZDA,%ZFN,IO("DOC") S POP=1 Q
"RTN","ZIS4ONT",72,0)
 ;
"RTN","ZIS4ONT",73,0)
SPL2 I %ZOS="NT" O IO:(%ZFN:0) S IO(1,IO)="",^SPOOL(0,IO("DOC"),%ZFN)="",^SPOOL(%ZFN,0)=IO("DOC")_"{"_$H Q
"RTN","ZIS4ONT",74,0)
 ;VMS
"RTN","ZIS4ONT",75,0)
 O %ZFN:("WNS"):2 G:'$T SPL4 S IO(1,%ZFN)="" Q
"RTN","ZIS4ONT",76,0)
 ;
"RTN","ZIS4ONT",77,0)
SPL3 I %ZOS="NT" G SPL4:'$D(^SPOOL(%ZFN,2147483647)) O IO:(%ZFN:$P(^(2147483647),"{",3)):1 S:'$T ZISPLQ=1 K ^(2147483647) S IO(1,IO)="" Q
"RTN","ZIS4ONT",78,0)
 ;VMS
"RTN","ZIS4ONT",79,0)
 N $ETRAP S $ETRAP="S $EC="""" G SPL4^%ZIS4"
"RTN","ZIS4ONT",80,0)
 O %ZFN:"RV":1 S:'$T ZISPLQ=1 G:$ZA<0!('$T) SPL4 S IO(1,%ZFN)="" Q
"RTN","ZIS4ONT",81,0)
 ;
"RTN","ZIS4ONT",82,0)
SPL4 W:'$D(IOP) !,"Spool file already open" S %ZFN=-1 Q
"RTN","ZIS4ONT",83,0)
 ;
"RTN","ZIS4ONT",84,0)
CLOSE N %ZOS,%Z1,%ZCR,%2,%3,%X,%Y,ZTSK,%ZFN S %ZOS=$$OS^%ZOSV
"RTN","ZIS4ONT",85,0)
 I %ZOS="NT",IO=2,$D(IO(1,IO)) K IO(1,IO) C IO
"RTN","ZIS4ONT",86,0)
 I %ZOS="VMS",IO]"",$D(IO(1,IO)) U IO S %ZFN=$ZIO C IO K IO(1,IO)
"RTN","ZIS4ONT",87,0)
 ;See that ZTSK is set so we will move to the global now.
"RTN","ZIS4ONT",88,0)
 S ZTSK=$G(ZTSK,1) D FILE^ZISPL1 I %ZDA'>0 K ZISPLAD Q
"RTN","ZIS4ONT",89,0)
 G:%ZOS="VMS" CLVMS
"RTN","ZIS4ONT",90,0)
 S %ZFN=$P(%ZS,"^",2),%ZCR=$C(13),%Y="",%=0,%3=$P(^SPOOL(%ZFN,2147483647),"{",3)
"RTN","ZIS4ONT",91,0)
 S %Z1=+$G(^XTV(8989.3,1,"SPL"))
"RTN","ZIS4ONT",92,0)
 F %2=1:1:%3 Q:'$D(^SPOOL(%ZFN,%2))  S %X=^SPOOL(%ZFN,%2) D
"RTN","ZIS4ONT",93,0)
 . I %Z1<% D LIMIT S %2=%3 Q
"RTN","ZIS4ONT",94,0)
 . I %X[$C(13,12) D:$L($P(%X,$C(13))) ADD($P(%X,$C(13))) D ADD("|TOP|") Q
"RTN","ZIS4ONT",95,0)
 . D ADD($P(%X,$C(13),1))
"RTN","ZIS4ONT",96,0)
 K ^SPOOL(%ZFN),^SPOOL(0,$P(%ZS,U,1)),%Y,%X,%1,%2,%3 D CLOSE^ZISPL1
"RTN","ZIS4ONT",97,0)
 Q
"RTN","ZIS4ONT",98,0)
ADD(L) S %=%+1,^XMBS(3.519,XS,2,%,0)=L
"RTN","ZIS4ONT",99,0)
 Q
"RTN","ZIS4ONT",100,0)
LIMIT D ADD("*** INCOMPLETE REPORT  -- SPOOL DOCUMENT LINE LIMIT EXCEEDED ***") S $P(^XMB(3.51,%ZDA,0),"^",11)=1
"RTN","ZIS4ONT",101,0)
 Q
"RTN","ZIS4ONT",102,0)
CLVMS ;Close for Cache VMS
"RTN","ZIS4ONT",103,0)
 N $ES,$ET S $ET="D:$EC'[""ENDOF"" ^%ZTER,UNWIND^%ZTER S $EC="""" D SPLEX^%ZIS4,UNWIND^%ZTER"
"RTN","ZIS4ONT",104,0)
 S %ZA=$ZU(68,40,1) ;Work like DSM
"RTN","ZIS4ONT",105,0)
 ;%ZFN Could be set at the top
"RTN","ZIS4ONT",106,0)
 S %ZFN=$S($G(%ZFN)]"":%ZFN,1:$P(%ZS,"^",2)) D SPL3 Q:%ZFN']""  U %ZFN S %ZCR=$C(13),%Y=""
"RTN","ZIS4ONT",107,0)
 S %Z1=+$G(^XTV(8989.3,1,"SPL")),%=0
"RTN","ZIS4ONT",108,0)
 F  R %X#255:5 Q:$ZEOF<0  D  G:%Z1<% SPLEX
"RTN","ZIS4ONT",109,0)
 . I %Z1<% D LIMIT Q
"RTN","ZIS4ONT",110,0)
 . I %X[$C(12) D  Q
"RTN","ZIS4ONT",111,0)
 . . S %Y=$P(%X,$C(12)) D:$L(%Y) ADD(%Y),ADD("|TOP|")
"RTN","ZIS4ONT",112,0)
 . . S %Y=$P(%X,$C(12),2) D:$L(%Y) ADD(%Y)
"RTN","ZIS4ONT",113,0)
 . . Q
"RTN","ZIS4ONT",114,0)
 . D ADD(%X)
"RTN","ZIS4ONT",115,0)
 . Q
"RTN","ZIS4ONT",116,0)
SPLEX C %ZFN:"D" K:%ZFN]"" IO(1,%ZFN) D CLOSE^ZISPL1 K %Y,%X,%1,%ZFN Q
"RTN","ZIS4ONT",117,0)
 ;
"RTN","ZIS4ONT",118,0)
 ;
"RTN","ZIS4ONT",119,0)
HFS G HFS^%ZISF
"RTN","ZIS4ONT",120,0)
REWMT(IO2,IOPAR) ;Rewind Magtape
"RTN","ZIS4ONT",121,0)
 N $ETRAP S $ET="G REWERR^%ZIS4"
"RTN","ZIS4ONT",122,0)
 U IO2 W *5
"RTN","ZIS4ONT",123,0)
 Q 1
"RTN","ZIS4ONT",124,0)
REWSDP(IO2,IOPAR) ;Rewind SDP
"RTN","ZIS4ONT",125,0)
 G REW1
"RTN","ZIS4ONT",126,0)
REWHFS(IO2,IOPAR) ;Rewind Host File.
"RTN","ZIS4ONT",127,0)
REW1 ;ZIS set % to the current $I so need to update % if = IO
"RTN","ZIS4ONT",128,0)
 N NIO,OP,$ETRAP
"RTN","ZIS4ONT",129,0)
 S $ET="G REWERR^%ZIS4"
"RTN","ZIS4ONT",130,0)
 C IO2 ;You do a rewind to read the file.
"RTN","ZIS4ONT",131,0)
 S OP=$S($ZV["VMS":"RV",1:"RS")
"RTN","ZIS4ONT",132,0)
 O IO2:(OP):1 S IO(1,IO2)=""
"RTN","ZIS4ONT",133,0)
 Q 1
"RTN","ZIS4ONT",134,0)
REWERR ;Error encountered
"RTN","ZIS4ONT",135,0)
 S IO("ERROR")=$EC,$ECODE=""
"RTN","ZIS4ONT",136,0)
 Q 0
"RTN","ZISFONT")
0^5^B10288750^B9782391
"RTN","ZISFONT",1,0)
%ZISF ;SFISC/AC - HOST FILES FOR Cache on NT & VMS ;01/25/10  16:33
"RTN","ZISFONT",2,0)
 ;;8.0;KERNEL;**34,191,271,385,499,524**;Jul 10, 1995;Build 12
"RTN","ZISFONT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","ZISFONT",4,0)
HFS ;Host File Server
"RTN","ZISFONT",5,0)
 ;Calling parameters in %ZIS override Device file.
"RTN","ZISFONT",6,0)
 Q:$D(IOP)&$D(%ZIS("HFSIO"))&$D(%ZIS("IOPAR"))
"RTN","ZISFONT",7,0)
 N %
"RTN","ZISFONT",8,0)
 ;Get file name
"RTN","ZISFONT",9,0)
 I $D(%ZIS("HFSNAME")) S IO=%ZIS("HFSNAME"),%X=IO
"RTN","ZISFONT",10,0)
 E  D ASKHFS ;Return name in %X
"RTN","ZISFONT",11,0)
 ;Mode or actual parameters
"RTN","ZISFONT",12,0)
H S:$D(%ZIS("HFSMODE")) %ZISOPAR=$$MODE(%ZIS("HFSMODE"))
"RTN","ZISFONT",13,0)
H1 I $D(IO("Q"))!(%ZIS["Z") S IO("HFSIO")=""
"RTN","ZISFONT",14,0)
 S:$L(%X) %ZIS("afn")=1
"RTN","ZISFONT",15,0)
 S IO=$S($L(%X):%X,1:IO),IO=$$CHKNM(IO) ;See that we have a directory
"RTN","ZISFONT",16,0)
 S:$D(IO("HFSIO")) IO("HFSIO")=IO
"RTN","ZISFONT",17,0)
 I '$D(IOP)&$D(%ZIS("HFSNAME")) S %="    HOST FILE USED:  "_%ZIS("HFSNAME") W:$X+$L(%)>75 ! W %,!
"RTN","ZISFONT",18,0)
 ;Check Ask Parameters
"RTN","ZISFONT",19,0)
 D ASKPAR^%ZIS6,SETPAR^%ZIS3
"RTN","ZISFONT",20,0)
 ;Check Ask IO Mode
"RTN","ZISFONT",21,0)
HFSIOO I '$D(IOP),%ZTYPE="HFS",'$D(%ZIS("HFSMODE")),'$P(^%ZIS(1,%E,0),"^",4),%ZISOPAR="",$P($G(^%ZIS(1,%E,1)),"^",6) D
"RTN","ZISFONT",22,0)
 . W:$X>19 ! W ?20,"INPUT/OUTPUT OPERATION: R//"
"RTN","ZISFONT",23,0)
 Q:'$T  D SBR^%ZIS1 I $D(DTOUT)!$D(DFOUT)!$D(DUOUT) S POP=1 Q
"RTN","ZISFONT",24,0)
 S:%X="" %X="R" S %X=$$UP^%ZIS1(%X)
"RTN","ZISFONT",25,0)
 D HOPT:%X="?"!'$$CHECK(%X),HOPT1:%X="??" G HFSIOO:%X="?"!'$$CHECK(%X)
"RTN","ZISFONT",26,0)
 S:%X]"" %ZISOPAR="("_$$MODE(%X)_")"
"RTN","ZISFONT",27,0)
 Q
"RTN","ZISFONT",28,0)
 ;
"RTN","ZISFONT",29,0)
CHECK(X) ;Check that we have valid option
"RTN","ZISFONT",30,0)
 N Y,%
"RTN","ZISFONT",31,0)
 Q:(X["R")&(X["W") 0 ;Can't have both
"RTN","ZISFONT",32,0)
 S Y=1 I $L($TR(X,"ANRW")) S Y=0
"RTN","ZISFONT",33,0)
 Q Y
"RTN","ZISFONT",34,0)
 ;
"RTN","ZISFONT",35,0)
ASKHFS ;---Ask host file name here---
"RTN","ZISFONT",36,0)
 I $D(%ZIS("B","HFS"))#2,%ZIS("B","HFS")]"" D
"RTN","ZISFONT",37,0)
 .S IO=%ZIS("B","HFS") ;Set default host file name
"RTN","ZISFONT",38,0)
 S %X='$P($G(^%ZIS(1,%E,1)),"^",5)
"RTN","ZISFONT",39,0)
 S:'%X %X=""
"RTN","ZISFONT",40,0)
 I $D(IOP)!%X!$D(%ZIS("HFSNAME")) S %X="" Q
"RTN","ZISFONT",41,0)
ASKAGN W !,"HOST FILE NAME: "_IO_"//" D SBR^%ZIS1
"RTN","ZISFONT",42,0)
 I %X?1."?".E W !,"ENTER HOST FILE NAME" G ASKAGN
"RTN","ZISFONT",43,0)
 S:$D(DTOUT)!$D(DUOUT) POP=1
"RTN","ZISFONT",44,0)
 Q
"RTN","ZISFONT",45,0)
CHKNM(H)        ;Check the HFS name
"RTN","ZISFONT",46,0)
 N N,P,F,%OS S N=H,%OS=$$OS^%ZOSV
"RTN","ZISFONT",47,0)
 ;Find any path may have
"RTN","ZISFONT",48,0)
 S P=$TR($RE(H),"\:[]","////"),F=$RE($P(P,"/")),P=$P(H,F,1)
"RTN","ZISFONT",49,0)
 I %OS["VMS",((P'[":")&(P'["["))!(P["\") S N=$$DEFDIR^%ZISH("")_F ;VMS - disk:[directory]file
"RTN","ZISFONT",50,0)
 I %OS["NT",'(P?1A1":\".E)!($E(P)="\") S N=$$DEFDIR^%ZISH("")_F ;NT - C:\DIR\FILE
"RTN","ZISFONT",51,0)
 I %OS["UNIX",(P'["/") S N=$$DEFDIR^%ZISH("")_F ;UNIX/Linux - ./file or /mnt/dir/file
"RTN","ZISFONT",52,0)
 Q N
"RTN","ZISFONT",53,0)
 ;
"RTN","ZISFONT",54,0)
MODE(X) ;Return value for %ZISOPAR.
"RTN","ZISFONT",55,0)
 ;For VMS only, The H is for read SHARE. Going back to READ Stream mode.
"RTN","ZISFONT",56,0)
 N Y,Q S Q=$C(34)
"RTN","ZISFONT",57,0)
 I $ZV["VMS" S Y=$S(X="N":"NWS",X="W":"NWS",X="A":"AWS",1:"RHS")
"RTN","ZISFONT",58,0)
 E  S Y=$S(X="N":"NWS",X="W":"NWS",X="A":"AWS",1:"RS")
"RTN","ZISFONT",59,0)
 Q $S($L(Y):Q_Y_Q,1:Y)
"RTN","ZISFONT",60,0)
 ;
"RTN","ZISFONT",61,0)
HOPT W !,"You may enter a code that represents one of",!,"the following host file input/ouput operation:"
"RTN","ZISFONT",62,0)
 W !?16,"R = READ ACCESS",!?16,"W = WRITE ACCESS",!?16,"N = NEWVERSION",!?16,"A = APPEND"
"RTN","ZISFONT",63,0)
 Q
"RTN","ZISFONT",64,0)
 ;
"RTN","ZISFONT",65,0)
HOPT1 S %ZISI=$O(^DIC(9.2,"B","XUHFSPARAM-MVX",0)) Q:'%ZISI  Q:'$D(^DIC(9.2,+%ZISI,0))  Q:$P(^(0),"^",1)'="XUHFSPARAM-MVX"
"RTN","ZISFONT",66,0)
 Q:$D(^DIC(9.2,+%ZISI,1))'>9  F %X=0:0 S %X=$O(^DIC(9.2,+%ZISI,1,%X)) Q:%X'>0  I $D(^(%X,0)) W !,^(0)
"RTN","ZISFONT",67,0)
 W ! S %X="??"
"RTN","ZISFONT",68,0)
 Q
"RTN","ZISHGTM")
0^4^B32232259^B32407982
"RTN","ZISHGTM",1,0)
%ZISH ;ISF/AC,RWF - GT.M for VMS/Unix Host file Control ;12/07/09  15:53
"RTN","ZISHGTM",2,0)
 ;;8.0;KERNEL;**275,306,385,524**;Jul 10, 1995;Build 12
"RTN","ZISHGTM",3,0)
 ; for GT.M for Unix/VMS, version 4.3
"RTN","ZISHGTM",4,0)
 ;
"RTN","ZISHGTM",5,0)
OPENERR ;
"RTN","ZISHGTM",6,0)
 Q 0
"RTN","ZISHGTM",7,0)
 ;
"RTN","ZISHGTM",8,0)
OPEN(X1,X2,X3,X4,X5,X6) ;SR. Open file
"RTN","ZISHGTM",9,0)
 ;D OPEN^%ZISH([handlename],[directory],filename,[accessmode],[recsize])
"RTN","ZISHGTM",10,0)
 ;X1=handle name
"RTN","ZISHGTM",11,0)
 ;X2=directory, X3=filename, X4=access mode
"RTN","ZISHGTM",12,0)
 ;X5=new file max record size, X6=Subtype
"RTN","ZISHGTM",13,0)
 ;
"RTN","ZISHGTM",14,0)
 N %,%1,%2,%IO,%I2,%P,%T,X,Y,$ETRAP
"RTN","ZISHGTM",15,0)
 S $ETRAP="D OPNERR^%ZISH"
"RTN","ZISHGTM",16,0)
 S U="^",X2=$$DEFDIR($G(X2)),X4=$$UP^XLFSTR(X4)
"RTN","ZISHGTM",17,0)
 S Y=$S(X4["A":"append",X4["R":"readonly",X4["W":"newversion",1:"readonly")
"RTN","ZISHGTM",18,0)
 S Y=Y_$S(X4["B":":fixed:nowrap:recordsize=512",$G(X5)&(X4["W"):":WIDTH="_+X5,1:"")
"RTN","ZISHGTM",19,0)
 S:$E(Y)=":" Y=$E(Y,2,999) S %IO=X2_X3,%I2="%IO:"_$S($L(Y):"("_Y_")",1:"")_":3"
"RTN","ZISHGTM",20,0)
 O @%I2 S %T=$T
"RTN","ZISHGTM",21,0)
 I '%T S POP=1 Q
"RTN","ZISHGTM",22,0)
 S IO=%IO,IO(1,IO)="",IOT="HFS",IOM=80,IOSL=60,POP=0 D SUBTYPE^%ZIS3($G(X6))
"RTN","ZISHGTM",23,0)
 I $G(X1)]"" D SAVDEV^%ZISUTL(X1)
"RTN","ZISHGTM",24,0)
 ;U IO U $P ;Don't do a USE.
"RTN","ZISHGTM",25,0)
 Q
"RTN","ZISHGTM",26,0)
OPNERR ;error on open
"RTN","ZISHGTM",27,0)
 S POP=1,$ECODE=""
"RTN","ZISHGTM",28,0)
 ;U:$G(%P)]"" %P
"RTN","ZISHGTM",29,0)
 Q
"RTN","ZISHGTM",30,0)
 ;
"RTN","ZISHGTM",31,0)
CLOSE(X) ;SR. Close HFS device not opened by %ZIS.
"RTN","ZISHGTM",32,0)
 ;X1=Handle name, IO=device
"RTN","ZISHGTM",33,0)
 I IO]"" C IO K IO(1,IO)
"RTN","ZISHGTM",34,0)
 I $G(X)]"" D RMDEV^%ZISUTL(X)
"RTN","ZISHGTM",35,0)
 I $D(IO("HOME"))!$D(^XUTL("XQ",$J,"IOS")) D HOME^%ZIS
"RTN","ZISHGTM",36,0)
 Q
"RTN","ZISHGTM",37,0)
DEL(%ZX1,%ZX2) ;ef,SR. Del fl(s)
"RTN","ZISHGTM",38,0)
 ;S Y=$$DEL^%ZISH("dir path",$NA(array))
"RTN","ZISHGTM",39,0)
 N %ZISH,%ZISHLGR,%ZX,X,%ZXDEL
"RTN","ZISHGTM",40,0)
 S %ZX1=$$DEFDIR($G(%ZX1)),%ZXDEL=1,%ZISH=""
"RTN","ZISHGTM",41,0)
 F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  D
"RTN","ZISHGTM",42,0)
 . N $ETRAP,$ESTACK S $ETRAP="D DELERR^%ZISH"
"RTN","ZISHGTM",43,0)
 . I %ZISH["*" S %ZXDEL=0 Q  ; Wild card not allowed.
"RTN","ZISHGTM",44,0)
 . S %ZX=$ZSEARCH(%ZX1_%ZISH)
"RTN","ZISHGTM",45,0)
 . Q:%ZX']""           ; File doesn't exist - not an error, just quit.
"RTN","ZISHGTM",46,0)
 . O %ZX:READONLY:0
"RTN","ZISHGTM",47,0)
 . I '$T S %ZXDEL=0 Q  ; Can't open it.
"RTN","ZISHGTM",48,0)
 . C %ZX:DELETE
"RTN","ZISHGTM",49,0)
 . I $ZSEARCH(%ZX)]"" S %ZXDEL=0 ; Delete was not successful.
"RTN","ZISHGTM",50,0)
 Q %ZXDEL
"RTN","ZISHGTM",51,0)
DELERR ;Trap any $ETRAP error, unwind and return.
"RTN","ZISHGTM",52,0)
 S $ETRAP="D UNWIND^%ZTER"
"RTN","ZISHGTM",53,0)
 S %ZXDEL=0
"RTN","ZISHGTM",54,0)
 D UNWIND^%ZTER
"RTN","ZISHGTM",55,0)
 Q
"RTN","ZISHGTM",56,0)
 ;
"RTN","ZISHGTM",57,0)
LIST(%ZX1,%ZX2,%ZX3) ;ef,SR. Set local array holding fl names
"RTN","ZISHGTM",58,0)
 ;S Y=$$LIST^ZISH("/dir/","list_root","return_root")
"RTN","ZISHGTM",59,0)
 ;list_root can have XX("A*"), XX("test.com")...
"RTN","ZISHGTM",60,0)
 ;Both arrays passed as $NA values (closed roots).
"RTN","ZISHGTM",61,0)
 N %ZISH,%ZIX,%ZIY,POP,X
"RTN","ZISHGTM",62,0)
 N $ETRAP,$ESTACK S $ETRAP="G LSTX^%ZISH",%ZX1=$$DEFDIR($G(%ZX1))
"RTN","ZISHGTM",63,0)
 ;Get fls, Build listing in %ZISHDL1 with ls
"RTN","ZISHGTM",64,0)
 S %ZISH=""
"RTN","ZISHGTM",65,0)
 F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  D
"RTN","ZISHGTM",66,0)
 . S %ZIX=$ZPARSE(%ZX1_%ZISH) Q:%ZIX=""
"RTN","ZISHGTM",67,0)
 . F  S %ZIY=$ZSEARCH(%ZIX) Q:%ZIY=""  S %ZIY=$ZPARSE(%ZIY,"NAME")_$ZPARSE(%ZIY,"TYPE"),@%ZX3@(%ZIY)=""
"RTN","ZISHGTM",68,0)
LSTX ;
"RTN","ZISHGTM",69,0)
 S $ECODE=""
"RTN","ZISHGTM",70,0)
 Q ($Q(@%ZX3)]"")
"RTN","ZISHGTM",71,0)
 ;
"RTN","ZISHGTM",72,0)
SPAWNERR ;TRAP ERROR OF SPAWN
"RTN","ZISHGTM",73,0)
 O %ZISHDL1:READONLY:1 I $T C %ZISHDL1:DELETE
"RTN","ZISHGTM",74,0)
 S $ECODE=""
"RTN","ZISHGTM",75,0)
 Q 0
"RTN","ZISHGTM",76,0)
 ;
"RTN","ZISHGTM",77,0)
MV(X1,X2,Y1,Y2) ;ef,SR. Rename a fl
"RTN","ZISHGTM",78,0)
 ;S Y=$$MV^ZISH("/dir/","fl","/dir/","fl")
"RTN","ZISHGTM",79,0)
 N %Z,%C
"RTN","ZISHGTM",80,0)
 S X1=$$DEFDIR($G(X1)),Y1=$$DEFDIR($G(Y1))
"RTN","ZISHGTM",81,0)
 S %C=$S($ZV["VMS":"RENAME ",1:"mv ")
"RTN","ZISHGTM",82,0)
 ;Pbv or qit
"RTN","ZISHGTM",83,0)
 I (X2="")!(Y2="") Q 0
"RTN","ZISHGTM",84,0)
 ZSYSTEM %C_X1_X2_" "_Y1_Y2 ;Use system rename
"RTN","ZISHGTM",85,0)
 S %Z=$ZSEARCH(Y1_Y2)
"RTN","ZISHGTM",86,0)
 Q $L(%Z)>0
"RTN","ZISHGTM",87,0)
 ;
"RTN","ZISHGTM",88,0)
PWD() ;ef,SR. Print working directory
"RTN","ZISHGTM",89,0)
 N Y
"RTN","ZISHGTM",90,0)
 S Y=$$DEFDIR("")
"RTN","ZISHGTM",91,0)
 S:Y="" Y=$ZDIR
"RTN","ZISHGTM",92,0)
 Q Y
"RTN","ZISHGTM",93,0)
 ;
"RTN","ZISHGTM",94,0)
DEFDIR(DF) ;ef. Default Dir and frmt
"RTN","ZISHGTM",95,0)
 S DF=$G(DF) Q:DF="." "" ;Special way to get current dir.
"RTN","ZISHGTM",96,0)
 S:DF="" DF=$P($G(^XTV(8989.3,1,"DEV")),"^",1)
"RTN","ZISHGTM",97,0)
 ;Old code
"RTN","ZISHGTM",98,0)
 ;Check syntax, VMS needs : or [ ]
"RTN","ZISHGTM",99,0)
 I ^%ZOSF("OS")["VMS" D  Q DF ;***EXIT FOR VMS/GTM
"RTN","ZISHGTM",100,0)
 . N P1,P2
"RTN","ZISHGTM",101,0)
 . S DF=$ZPARSE(DF)
"RTN","ZISHGTM",102,0)
 . I DF[":" S P1=$P(DF,":")_":",P2=$P(DF,":",2)
"RTN","ZISHGTM",103,0)
 . E  S P1="",P2=DF
"RTN","ZISHGTM",104,0)
 . I P1="",P2["$" S DF=P2 Q  ;Assume a logical
"RTN","ZISHGTM",105,0)
 . I $L(P2) S:P2'["[" P2="["_P2 S:P2'["]" P2=P2_"]"
"RTN","ZISHGTM",106,0)
 . S DF=P1_P2
"RTN","ZISHGTM",107,0)
 . Q
"RTN","ZISHGTM",108,0)
 ;
"RTN","ZISHGTM",109,0)
 ;Check syntax, Unix check leading & trailing "/"
"RTN","ZISHGTM",110,0)
 S DF=$ZPARSE(DF)
"RTN","ZISHGTM",111,0)
 I "./"'[$E(DF) S DF="/"_DF
"RTN","ZISHGTM",112,0)
 I $E(DF,$L(DF))'="/" S DF=DF_"/"
"RTN","ZISHGTM",113,0)
 Q DF
"RTN","ZISHGTM",114,0)
STATUS() ;ef,SR. Return EOF status
"RTN","ZISHGTM",115,0)
 U $I
"RTN","ZISHGTM",116,0)
 Q $ZEOF
"RTN","ZISHGTM",117,0)
 ;
"RTN","ZISHGTM",118,0)
EOF(X) ;Eof flag, Pass in $ZA
"RTN","ZISHGTM",119,0)
 Q X
"RTN","ZISHGTM",120,0)
QL(X) ;Qlfrs
"RTN","ZISHGTM",121,0)
 Q:X=""
"RTN","ZISHGTM",122,0)
 S:$E(X)'="-" X="-"_X
"RTN","ZISHGTM",123,0)
 Q
"RTN","ZISHGTM",124,0)
FL(X) ;Fl len
"RTN","ZISHGTM",125,0)
 N ZOSHP1,ZOSHP2
"RTN","ZISHGTM",126,0)
 S ZOSHP1=$P(X,"."),ZOSHP2=$P(X,".",2)
"RTN","ZISHGTM",127,0)
 I $L(ZOSHP1)>14 S X=4 Q
"RTN","ZISHGTM",128,0)
 I $L(ZOSHP2)>8 S X=4 Q
"RTN","ZISHGTM",129,0)
 Q
"RTN","ZISHGTM",130,0)
 ;
"RTN","ZISHGTM",131,0)
MAKEREF(HF,IX,OVF) ;Internal call to rebuild global ref.
"RTN","ZISHGTM",132,0)
 ;Return %ZISHF,%ZISHO,%ZISHI,%ZISUB
"RTN","ZISHGTM",133,0)
 N I,F,MX
"RTN","ZISHGTM",134,0)
 S OVF=$G(OVF,"%ZISHOF")
"RTN","ZISHGTM",135,0)
 S %ZISHI=$$QS^DDBRAP(HF,IX),MX=$$QL^DDBRAP(HF) ;
"RTN","ZISHGTM",136,0)
 S F=$NA(@HF,IX-1) ;Get first part
"RTN","ZISHGTM",137,0)
 I IX=1 S %ZISHF=F_"(%ZISHI" ;Build root, IX=1
"RTN","ZISHGTM",138,0)
 I IX>1 S %ZISHF=$E(F,1,$L(F)-1)_",%ZISHI" ;Build root
"RTN","ZISHGTM",139,0)
 S %ZISHO=%ZISHF_","_OVF_",%OVFCNT)" ;Make overflow
"RTN","ZISHGTM",140,0)
 F I=IX+1:1:MX S %ZISHF=%ZISHF_",%ZISUB("_I_")",%ZISUB(I)=$$QS^DDBRAP(HF,I)
"RTN","ZISHGTM",141,0)
 S %ZISHF=%ZISHF_")"
"RTN","ZISHGTM",142,0)
 Q
"RTN","ZISHGTM",143,0)
FTG(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;ef,SR. Unload contents of host file into global
"RTN","ZISHGTM",144,0)
 ;p1=host file directory
"RTN","ZISHGTM",145,0)
 ;p2=host file name
"RTN","ZISHGTM",146,0)
 ;p3= $NAME REFERENCE INCLUDING STARTING SUBSCRIPT
"RTN","ZISHGTM",147,0)
 ;p4=INCREMENT SUBSCRIPT
"RTN","ZISHGTM",148,0)
 ;p5=Overflow subscript, defaults to "OVF"
"RTN","ZISHGTM",149,0)
 N %ZA,%ZB,%ZC,%ZL,X,%OVFCNT,%CONT,%EXIT
"RTN","ZISHGTM",150,0)
 N I,%ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHLGR,%ZISHOF,%ZISHOX,%ZISHS,%ZX,%ZISHY,POP,%ZISUB
"RTN","ZISHGTM",151,0)
 S %ZX1=$$DEFDIR($G(%ZX1)),%ZISHOF=$G(%ZX5,"OVF")
"RTN","ZISHGTM",152,0)
 D MAKEREF(%ZX3,%ZX4,"%ZISHOF")
"RTN","ZISHGTM",153,0)
 D OPEN^%ZISH(,%ZX1,%ZX2,"R")
"RTN","ZISHGTM",154,0)
 I POP Q 0
"RTN","ZISHGTM",155,0)
 N $ETRAP S %EXIT=0,$ETRAP="S %ZA=1,%EXIT=1,$ECODE="""" Q"
"RTN","ZISHGTM",156,0)
 U IO F  K %XX D READNXT(.%XX) Q:$$EOF(%ZA)  D
"RTN","ZISHGTM",157,0)
 . S @%ZISHF=%XX
"RTN","ZISHGTM",158,0)
 . I $D(%XX)>2 F %OVFCNT=1:1 Q:'$D(%XX(%OVFCNT))  S @%ZISHO=%XX(%OVFCNT)
"RTN","ZISHGTM",159,0)
 . S %ZISHI=%ZISHI+1
"RTN","ZISHGTM",160,0)
 . Q
"RTN","ZISHGTM",161,0)
 D CLOSE() ;Normal exit
"RTN","ZISHGTM",162,0)
 Q 1
"RTN","ZISHGTM",163,0)
 ;
"RTN","ZISHGTM",164,0)
ERREOF D CLOSE() ;Got error Reading file
"RTN","ZISHGTM",165,0)
 Q 0
"RTN","ZISHGTM",166,0)
 ;
"RTN","ZISHGTM",167,0)
READNXT(REC) ;
"RTN","ZISHGTM",168,0)
 N T,I,X,%
"RTN","ZISHGTM",169,0)
 U IO R X:2 S %ZA=$ZEOF,REC=$E(X,1,255)
"RTN","ZISHGTM",170,0)
 Q:$L(X)<256
"RTN","ZISHGTM",171,0)
 S %=256 F I=1:1 Q:$L(X)<%  S REC(I)=$E(X,%,%+254),%=%+255
"RTN","ZISHGTM",172,0)
 Q
"RTN","ZISHGTM",173,0)
 ;
"RTN","ZISHGTM",174,0)
GTF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Load contents of global to host file.
"RTN","ZISHGTM",175,0)
 ;Previously name LOAD
"RTN","ZISHGTM",176,0)
 ;p1=$NAME of global reference
"RTN","ZISHGTM",177,0)
 ;p2=incrementing subscript
"RTN","ZISHGTM",178,0)
 ;p3=host file directory
"RTN","ZISHGTM",179,0)
 ;p4=host file name
"RTN","ZISHGTM",180,0)
 N %ZISHY,%ZISHLGR,%ZISHOX
"RTN","ZISHGTM",181,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,$G(%ZX3),%ZX4,"W")
"RTN","ZISHGTM",182,0)
 Q %ZISHY
"RTN","ZISHGTM",183,0)
 ;
"RTN","ZISHGTM",184,0)
GATF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Append to host file.
"RTN","ZISHGTM",185,0)
 ;
"RTN","ZISHGTM",186,0)
 ;p1=$NAME of global reference
"RTN","ZISHGTM",187,0)
 ;p2=incrementing subscript
"RTN","ZISHGTM",188,0)
 ;p3=host file directory
"RTN","ZISHGTM",189,0)
 ;p4=host file name
"RTN","ZISHGTM",190,0)
 N %ZISHY
"RTN","ZISHGTM",191,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,$G(%ZX3),%ZX4,"A")
"RTN","ZISHGTM",192,0)
 Q %ZISHY
"RTN","ZISHGTM",193,0)
 ;
"RTN","ZISHGTM",194,0)
MGTF(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;
"RTN","ZISHGTM",195,0)
 ;p1=$NAME of global reference
"RTN","ZISHGTM",196,0)
 ;p2=incrementing subscript
"RTN","ZISHGTM",197,0)
 ;p3=host file directory
"RTN","ZISHGTM",198,0)
 ;p4=host file name
"RTN","ZISHGTM",199,0)
 N %ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHLGR,%ZISHS,%ZISHOX,IO,%ZX,Y
"RTN","ZISHGTM",200,0)
 D MAKEREF(%ZX1,%ZX2)
"RTN","ZISHGTM",201,0)
 D OPEN^%ZISH(,%ZX3,%ZX4,%ZX5) ;Default dir set in open
"RTN","ZISHGTM",202,0)
 I POP Q 0
"RTN","ZISHGTM",203,0)
 N X
"RTN","ZISHGTM",204,0)
 N $ETRAP S $ETRAP="S $EC="""" D CLOSE^%ZISH() Q 0"
"RTN","ZISHGTM",205,0)
 F  Q:'($D(@%ZISHF)#2)  S %ZX=@%ZISHF,%ZISHI=%ZISHI+1 U IO W %ZX,!
"RTN","ZISHGTM",206,0)
 D CLOSE() ;Normal Exit
"RTN","ZISHGTM",207,0)
 Q 1
"RTN","ZISHGTM",208,0)
 ;
"RTN","ZISHONT")
0^3^B59753873^B59942519
"RTN","ZISHONT",1,0)
%ZISH ;IHS/PR,SFISC/AC - Host File Control for Cache for VMS/NT/UNIX ;12/07/09  15:44
"RTN","ZISHONT",2,0)
 ;;8.0;KERNEL;**34,65,84,104,191,306,385,440,518,524**;JUL 10, 1995;Build 12
"RTN","ZISHONT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","ZISHONT",4,0)
 ;
"RTN","ZISHONT",5,0)
OPEN(X1,X2,X3,X4,X5,X6)    ;SR. Open Host File
"RTN","ZISHONT",6,0)
 ;X1=handle name
"RTN","ZISHONT",7,0)
 ;X2=directory name \dir\
"RTN","ZISHONT",8,0)
 ;X3=file name
"RTN","ZISHONT",9,0)
 ;X4=file access mode e.g.: W for write, R for read, A for append.
"RTN","ZISHONT",10,0)
 ;X5=Max record size for a new file, X6=Subtype
"RTN","ZISHONT",11,0)
 N %,%1,%2,%I,%ZOS,%T,%ZA,%ZISHIO,$ET
"RTN","ZISHONT",12,0)
 S $ET="D OPNERR^%ZISH"
"RTN","ZISHONT",13,0)
 S U="^",%I=$I,%T=0,POP=0,X2=$$DEFDIR($G(X2)),%ZOS=$$OS^%ZOSV M %ZISHIO=IO
"RTN","ZISHONT",14,0)
 I %ZOS'="VMS" S %1=$S(X4["A":"AW",X4["W":"WN",1:"R")_$S(X4["B":"U",1:"S") ;NT & Unix
"RTN","ZISHONT",15,0)
 I %ZOS="VMS" S %1=$S(X4["A":"AW",X4["W":"WN",1:"RH")_$S(X4["B":"U",1:"S")
"RTN","ZISHONT",16,0)
 ;The next line eliminates the <ENDOFFILE> error for sequential files for the current process.
"RTN","ZISHONT",17,0)
 S %ZA=$ZUTIL(68,40,1) ;Work like DSM
"RTN","ZISHONT",18,0)
 S %=X2_X3 O %:(%1):2 I '$T S POP=1 Q
"RTN","ZISHONT",19,0)
 S IO=%,IO(1,IO)="",IOT="HFS",IOM=80,IOSL=60,POP=0 D SUBTYPE^%ZIS3($G(X6,"P-OTHER"))
"RTN","ZISHONT",20,0)
 I $G(X1)]"" D SAVDEV^%ZISUTL(X1)
"RTN","ZISHONT",21,0)
 ;I $L($G(%I)) U %I ;Would only needed if we had done a USE.
"RTN","ZISHONT",22,0)
 Q
"RTN","ZISHONT",23,0)
 ;
"RTN","ZISHONT",24,0)
OPNERR ;Handle open error
"RTN","ZISHONT",25,0)
 S POP=1,$ECODE=""
"RTN","ZISHONT",26,0)
 ;I $L($G(%I)) U %I
"RTN","ZISHONT",27,0)
 Q
"RTN","ZISHONT",28,0)
 ;
"RTN","ZISHONT",29,0)
CLOSE(X) ;SR. Close HFS device not opened by %ZIS.
"RTN","ZISHONT",30,0)
 ;X=HANDLE NAME
"RTN","ZISHONT",31,0)
 ;IO=Device
"RTN","ZISHONT",32,0)
 N %
"RTN","ZISHONT",33,0)
 I $L($G(IO)) C IO K IO(1,IO)
"RTN","ZISHONT",34,0)
 I $L($G(X)) D RMDEV^%ZISUTL(X)
"RTN","ZISHONT",35,0)
 ;Only reset home if one setup.
"RTN","ZISHONT",36,0)
 I $D(IO("HOME"))!$D(^XUTL("XQ",$J,"IOS")) D HOME^%ZIS
"RTN","ZISHONT",37,0)
 Q
"RTN","ZISHONT",38,0)
 ;
"RTN","ZISHONT",39,0)
OPENERR ;
"RTN","ZISHONT",40,0)
 Q 0
"RTN","ZISHONT",41,0)
 ;
"RTN","ZISHONT",42,0)
DEL(%ZX1,%ZX2) ;ef,SR. Del files, return 1 if deleted all requested.
"RTN","ZISHONT",43,0)
 ;S Y=$$DEL^%ZISH("dir path",$NA(array))
"RTN","ZISHONT",44,0)
 ; will invoke an OS command to delete file(s)
"RTN","ZISHONT",45,0)
 ; UNIX: rm -f filespec[ ...]
"RTN","ZISHONT",46,0)
 ; VMS: del filespec[,...]
"RTN","ZISHONT",47,0)
 N %ZARG,%ZXDEL,%ZOS,%ZDELIM,%ZCOMND,%ZLIST
"RTN","ZISHONT",48,0)
 S %ZARG="",%ZXDEL=1
"RTN","ZISHONT",49,0)
 S %ZX1=$$DEFDIR($G(%ZX1))
"RTN","ZISHONT",50,0)
 S %ZOS=$$OS^%ZOSV
"RTN","ZISHONT",51,0)
 S %ZDELIM=$S(%ZOS="UNIX":" ",1:",")
"RTN","ZISHONT",52,0)
 S %ZCOMND=$S(%ZOS="UNIX":"rm -f ",1:"del ")
"RTN","ZISHONT",53,0)
 D
"RTN","ZISHONT",54,0)
 . N $ETRAP,$ESTACK S $ETRAP="D DELERR^%ZISH"
"RTN","ZISHONT",55,0)
 . N %,%ZI,%ZISH,%ZX,%ZFOUND S %ZISH=""
"RTN","ZISHONT",56,0)
 . F %ZI=1:1 S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  D
"RTN","ZISHONT",57,0)
 . . N $ETRAP,$ESTACK S $ETRAP="D DELERR^%ZISH"
"RTN","ZISHONT",58,0)
 . . I %ZISH["*" S %ZXDEL=0 Q  ; Wild card not allowed.
"RTN","ZISHONT",59,0)
 . . S %ZX=$S(%ZISH[%ZX1:%ZISH,1:%ZX1_%ZISH) ; prepend directory path
"RTN","ZISHONT",60,0)
 . . I %ZOS="VMS",%ZX'[";" S %ZX=%ZX_";*"
"RTN","ZISHONT",61,0)
 . . S %ZFOUND=$ZSEARCH(%ZX)]""  ; File exists
"RTN","ZISHONT",62,0)
 . . S:%ZFOUND %ZARG=$S(%ZARG="":%ZX,1:%ZARG_%ZDELIM_%ZX) ; join files
"RTN","ZISHONT",63,0)
 . . I $L(%ZARG)>2000 S %=$ZF(-1,%ZCOMND_%ZARG),%ZARG="" H 1 ; delete files at a time
"RTN","ZISHONT",64,0)
 . ;
"RTN","ZISHONT",65,0)
 . I $L(%ZARG) S %=$ZF(-1,%ZCOMND_%ZARG) ; delete remaining files
"RTN","ZISHONT",66,0)
 ;
"RTN","ZISHONT",67,0)
 I %ZXDEL S %ZXDEL='$$LIST(%ZX1,%ZX2,"%ZLIST")
"RTN","ZISHONT",68,0)
 Q %ZXDEL
"RTN","ZISHONT",69,0)
 ;
"RTN","ZISHONT",70,0)
DELERR ;Trap any $ETRAP error, unwind and return.
"RTN","ZISHONT",71,0)
 S $ETRAP="D UNWIND^%ZTER"
"RTN","ZISHONT",72,0)
 S %ZXDEL=0,%ZARG=""
"RTN","ZISHONT",73,0)
 D UNWIND^%ZTER
"RTN","ZISHONT",74,0)
 Q
"RTN","ZISHONT",75,0)
 ;
"RTN","ZISHONT",76,0)
DEL1(%ZX3) ;ef,SR. Delete one file
"RTN","ZISHONT",77,0)
 N %ZI1,%ZI2
"RTN","ZISHONT",78,0)
 D SPLIT(%ZX3,.%ZI1,.%ZI2) S %ZI2(%ZI2)=""
"RTN","ZISHONT",79,0)
 Q $$DEL(%ZI1,$NA(%ZI2))
"RTN","ZISHONT",80,0)
 ;
"RTN","ZISHONT",81,0)
SPLIT(%I,%O1,%O2) ;Split to path,file
"RTN","ZISHONT",82,0)
 N %ZOS,%D,D S %ZOS=$$OS^%ZOSV
"RTN","ZISHONT",83,0)
 I %ZOS["VMS" D  Q
"RTN","ZISHONT",84,0)
 . S D=$S(%I["]":"]",1:":")
"RTN","ZISHONT",85,0)
 . S %O1=$P(%I,D,1)_D,%O2=$P(%I,D,2)
"RTN","ZISHONT",86,0)
 . Q
"RTN","ZISHONT",87,0)
 S %D=$S(%ZOS="UNIX":"/",%ZOS="NT":"\",1:""),%O1="",%O2="" Q:%D=""
"RTN","ZISHONT",88,0)
 S D=$L(%I,%D),%O1=$P(%I,%D,1,D-1),%O2=$P(%I,%D,D)
"RTN","ZISHONT",89,0)
 Q
"RTN","ZISHONT",90,0)
 ;
"RTN","ZISHONT",91,0)
FEXIST(%PATH,%FL) ;Check if files exsist.
"RTN","ZISHONT",92,0)
 ;S Y=$$DTEST("/usr/var",$NA(array))
"RTN","ZISHONT",93,0)
 N %ZISH,%ZISHY
"RTN","ZISHONT",94,0)
 S %ZISH=$$LIST(%PATH,%FL,"%ZISHY")
"RTN","ZISHONT",95,0)
 Q %ZISH
"RTN","ZISHONT",96,0)
 ;
"RTN","ZISHONT",97,0)
LIST(%ZX1,%ZX2,%ZX3) ;ef,SR. Create a local array holding file names
"RTN","ZISHONT",98,0)
 ;S Y=$$LIST^%ZISH("\dir\",$NA(array),$NA(return array)) Return 1 if found anything
"RTN","ZISHONT",99,0)
 ;
"RTN","ZISHONT",100,0)
 N %ZISH,%ZISHN,%ZX,%ZISHY,%ZY,%ZOS
"RTN","ZISHONT",101,0)
 S %ZX1=$$DEFDIR($G(%ZX1)),%ZOS=$$OS^%ZOSV
"RTN","ZISHONT",102,0)
 ;S %ZX1=$$TRNLNM(%ZX1)
"RTN","ZISHONT",103,0)
 ;Get fls to act on
"RTN","ZISHONT",104,0)
 S %ZISH="" F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  D
"RTN","ZISHONT",105,0)
 . S %ZISHY=$P(%ZISH,"*")
"RTN","ZISHONT",106,0)
 . I %ZOS="VMS",%ZISH'["." S %ZISH=%ZISH_".*" ;Allways upper
"RTN","ZISHONT",107,0)
 . ;NT, display case, ignore for lookup
"RTN","ZISHONT",108,0)
 . S %ZX=%ZX1_%ZISH
"RTN","ZISHONT",109,0)
 . F %ZISHN=0:1 D  Q:(%ZX="")
"RTN","ZISHONT",110,0)
 . . S %ZX=$ZSEARCH($S(%ZISHN:"",1:%ZX))
"RTN","ZISHONT",111,0)
 . . ;Q:(%ZX="")!($$UP^XLFSTR(%ZX)'[%ZISHY)!(%ZX?.E1.2".")
"RTN","ZISHONT",112,0)
 . . Q:(%ZX="")!(%ZX?.E1.2".")
"RTN","ZISHONT",113,0)
 . . I %ZOS="VMS" S %ZX=$P(%ZX,"]",2),@%ZX3@(%ZX)=""
"RTN","ZISHONT",114,0)
 . . I %ZOS="NT" S %ZY=$P(%ZX,"\",$L(%ZX,"\")),@%ZX3@(%ZY)=""
"RTN","ZISHONT",115,0)
 . . I %ZOS="UNIX" S %ZY=$P(%ZX,"/",$L(%ZX,"/")) Q:%ZX'[%ZISHY  S @%ZX3@(%ZY)=""
"RTN","ZISHONT",116,0)
 . . Q
"RTN","ZISHONT",117,0)
 Q $O(@%ZX3@(""))]""
"RTN","ZISHONT",118,0)
 ;
"RTN","ZISHONT",119,0)
MV(X1,X2,Y1,Y2) ;ef,SR. Rename a fl
"RTN","ZISHONT",120,0)
 ;S Y=$$MV^ZOSHDOS("\dir\","fl","\dir\","fl")
"RTN","ZISHONT",121,0)
 ;Unix use mv, NT/VMS use COPY and DEL
"RTN","ZISHONT",122,0)
 N %,X,Y,%ZOS,%ZISHX S %ZOS=$$OS^%ZOSV
"RTN","ZISHONT",123,0)
 S X1=$$DEFDIR($G(X1)),Y1=$$DEFDIR($G(Y1))
"RTN","ZISHONT",124,0)
 S X=$ZSEARCH(X1_X2),Y=Y1_Y2 ;move X to Y
"RTN","ZISHONT",125,0)
 I X="" Q 0
"RTN","ZISHONT",126,0)
 ;Move to same place can delete file. Since at destination return 1
"RTN","ZISHONT",127,0)
 I $P(X,";")=Y Q 1
"RTN","ZISHONT",128,0)
 S %=$ZF(-1,$S(%ZOS="UNIX":"mv ",1:"copy ")_X_" "_Y) ;Use NT/VMS copy
"RTN","ZISHONT",129,0)
 I %ZOS'="UNIX" D
"RTN","ZISHONT",130,0)
 . S X2=$P(X,X1,2),%ZISHX(X2)=""
"RTN","ZISHONT",131,0)
 . S Y=$$DEL^%ZISH(X1,$NA(%ZISHX))
"RTN","ZISHONT",132,0)
 Q 1
"RTN","ZISHONT",133,0)
 ;
"RTN","ZISHONT",134,0)
PWD() ;ef,SR. Print working directory
"RTN","ZISHONT",135,0)
 N Y,%ZOS
"RTN","ZISHONT",136,0)
 S Y=$$DEFDIR(""),%ZOS=$$OS^%ZOSV
"RTN","ZISHONT",137,0)
 I Y="" S Y=$ZSEARCH("*")
"RTN","ZISHONT",138,0)
 Q $S(%ZOS["VMS":Y,1:$P(Y,".",1))
"RTN","ZISHONT",139,0)
 ;
"RTN","ZISHONT",140,0)
TRNLNM(PATH) ;ef. Expand logical path
"RTN","ZISHONT",141,0)
 N %ZOS,P1,P2
"RTN","ZISHONT",142,0)
 S %ZOS=$$OS^%ZOSV,PATH=$G(PATH)
"RTN","ZISHONT",143,0)
 I %ZOS="VMS" D  Q PATH
"RTN","ZISHONT",144,0)
 . S P1=PATH_$S(PATH[":":"*.*",1:":*.*")
"RTN","ZISHONT",145,0)
 . S P2=$ZSEARCH(P1)
"RTN","ZISHONT",146,0)
 . S:$L(P2) PATH=$S(P2["]":$P(P2,"]",1,$L(P2,"]")-1)_"]",1:$P(P2,":",1)_":")
"RTN","ZISHONT",147,0)
 . Q
"RTN","ZISHONT",148,0)
 I %ZOS="NT" D  Q PATH
"RTN","ZISHONT",149,0)
 . S P1=PATH_$S($E(PATH,$L(PATH))'="\":"\*",1:"*"),P2=$ZSEARCH(P1)
"RTN","ZISHONT",150,0)
 . S:$L(P2) PATH=$P(P2,"\",1,$L(P2,"\")-1)_"\"
"RTN","ZISHONT",151,0)
 . Q
"RTN","ZISHONT",152,0)
 ;Unix Cache $ZSEARCH uses % around an environment variable
"RTN","ZISHONT",153,0)
 I %ZOS="UNIX" D  Q PATH
"RTN","ZISHONT",154,0)
 . S P1=PATH_$S($E(PATH,$L(PATH))'="/":"/*",1:"*"),P2=$ZSEARCH(P1)
"RTN","ZISHONT",155,0)
 . S:$L(P2) PATH=$P(P2,"/",1,$L(P2,"/")-1)_"/"
"RTN","ZISHONT",156,0)
 . Q
"RTN","ZISHONT",157,0)
 Q PATH
"RTN","ZISHONT",158,0)
 ;
"RTN","ZISHONT",159,0)
DEFDIR(DF) ;ef. Default Dir and frmt
"RTN","ZISHONT",160,0)
 ;Need to handle NT, VMS and Linux
"RTN","ZISHONT",161,0)
 N %ZOS,P1,P2 S %ZOS=$$OS^%ZOSV,DF=$G(DF)
"RTN","ZISHONT",162,0)
 Q:DF="." "" ;Special way to get current dir.
"RTN","ZISHONT",163,0)
 S:DF="" DF=$G(^XTV(8989.3,1,"DEV")),DF=$P(DF,"^",$S($$PRI^%ZOSV<2:1,1:2))
"RTN","ZISHONT",164,0)
 Q:DF="" ""
"RTN","ZISHONT",165,0)
 ;Check syntax, VMS needs disk:[dir] or logical:
"RTN","ZISHONT",166,0)
 I %ZOS="VMS" D
"RTN","ZISHONT",167,0)
 . I DF[":" S P1=$P(DF,":")_":",P2=$P(DF,":",2)
"RTN","ZISHONT",168,0)
 . E  S P1="",P2=DF
"RTN","ZISHONT",169,0)
 . I P1="",P2["$" S P1=P2,P2=""  ;Could be a logical
"RTN","ZISHONT",170,0)
 . I $L(P2) S:P2'["[" P2="["_P2 S:P2'["]" P2=P2_"]"
"RTN","ZISHONT",171,0)
 . S DF=P1_P2 S:DF'[":" DF=DF_":"
"RTN","ZISHONT",172,0)
 . Q
"RTN","ZISHONT",173,0)
 ;Check syntax, Unix needs /mnt/fl, ./fl, ~/fl %HOME%/fl
"RTN","ZISHONT",174,0)
 I %ZOS="UNIX" D
"RTN","ZISHONT",175,0)
 . S DF=$TR(DF,"\","/")
"RTN","ZISHONT",176,0)
 . S:$E(DF,$L(DF))'="/" DF=DF_"/"
"RTN","ZISHONT",177,0)
 . Q
"RTN","ZISHONT",178,0)
 ;Check syntax, NT needs c:\dir\
"RTN","ZISHONT",179,0)
 I %ZOS="NT" D
"RTN","ZISHONT",180,0)
 . N P1,P2
"RTN","ZISHONT",181,0)
 . I DF[":" S P1=$P(DF,":")_":",P2=$P(DF,":",2)
"RTN","ZISHONT",182,0)
 . E  S P1="",P2=DF
"RTN","ZISHONT",183,0)
 . S P2=$TR(P2,"/","\")
"RTN","ZISHONT",184,0)
 . I $L(P2) S:".\"'[$E(P2,1) P2="\"_P2 S:$E(P2,$L(P2))'="\" P2=P2_"\"
"RTN","ZISHONT",185,0)
 . S DF=P1_P2
"RTN","ZISHONT",186,0)
 . Q
"RTN","ZISHONT",187,0)
 S DF=$$TRNLNM(DF) ;Resolve logicals
"RTN","ZISHONT",188,0)
 Q DF
"RTN","ZISHONT",189,0)
 ;
"RTN","ZISHONT",190,0)
FL(X) ;Fl len
"RTN","ZISHONT",191,0)
 N ZOSHP1,ZOSHP2
"RTN","ZISHONT",192,0)
 S ZOSHP1=$P(X,"."),ZOSHP2=$P(X,".",2)
"RTN","ZISHONT",193,0)
 I $L(ZOSHP1)>8 S X=4 Q
"RTN","ZISHONT",194,0)
 I $L(ZOSHP2)>3 S X=4 Q
"RTN","ZISHONT",195,0)
 Q
"RTN","ZISHONT",196,0)
 ;
"RTN","ZISHONT",197,0)
STATUS() ;ef,SR. Return EOF status
"RTN","ZISHONT",198,0)
 U $I
"RTN","ZISHONT",199,0)
 Q $$EOF($ZEOF)
"RTN","ZISHONT",200,0)
 ;
"RTN","ZISHONT",201,0)
EOF(X) ;Eof flag, pass in $ZEOF
"RTN","ZISHONT",202,0)
 Q (X=-1)
"RTN","ZISHONT",203,0)
 ;
"RTN","ZISHONT",204,0)
MAKEREF(HF,IX,OVF) ;Internal call to rebuild global ref.
"RTN","ZISHONT",205,0)
 ;Return %ZISHF,%ZISHO,%ZISHI,%ZISUB
"RTN","ZISHONT",206,0)
 N I,F,MX
"RTN","ZISHONT",207,0)
 S OVF=$G(OVF,"%ZISHOF")
"RTN","ZISHONT",208,0)
 S %ZISHI=$QS(HF,IX),MX=$QL(HF) ;
"RTN","ZISHONT",209,0)
 S F=$NA(@HF,IX-1) ;Get first part
"RTN","ZISHONT",210,0)
 I IX=1 S %ZISHF=F_"(%ZISHI" ;Build root, IX=1
"RTN","ZISHONT",211,0)
 I IX>1 S %ZISHF=$E(F,1,$L(F)-1)_",%ZISHI" ;Build root
"RTN","ZISHONT",212,0)
 S %ZISHO=%ZISHF_","_OVF_",%OVFCNT)" ;Make overflow
"RTN","ZISHONT",213,0)
 F I=IX+1:1:MX S %ZISHF=%ZISHF_",%ZISUB("_I_")",%ZISUB(I)=$QS(HF,I)
"RTN","ZISHONT",214,0)
 S %ZISHF=%ZISHF_")"
"RTN","ZISHONT",215,0)
 Q
"RTN","ZISHONT",216,0)
 ;
"RTN","ZISHONT",217,0)
READNXT(REC) ;Read any sized record into array. %ZB has terminator
"RTN","ZISHONT",218,0)
 N %,I,X,$ES,$ET S REC="",$ET="D READNX^%ZISH Q"
"RTN","ZISHONT",219,0)
 U IO R X:5 S %ZB=$A($ZB),REC=$E(X,1,255)
"RTN","ZISHONT",220,0)
 Q:$L(X)<256
"RTN","ZISHONT",221,0)
 S %=256 F I=1:1 Q:$L(X)<%  S REC(I)=$E(X,%,%+254),%=%+255
"RTN","ZISHONT",222,0)
 Q
"RTN","ZISHONT",223,0)
READNX ;Check for EOF
"RTN","ZISHONT",224,0)
 I $ZE["ENDOFFILE" S %ZA=-1
"RTN","ZISHONT",225,0)
 S $EC=""
"RTN","ZISHONT",226,0)
 Q
"RTN","ZISHONT",227,0)
 ;
"RTN","ZISHONT",228,0)
FTG(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;ef,SR. Unload contents of host file into global
"RTN","ZISHONT",229,0)
 ;p1=hostf file directory
"RTN","ZISHONT",230,0)
 ;p2=host file name
"RTN","ZISHONT",231,0)
 ;p3= $NAME REFERENCE INCLUDING STARTING SUBSCRIPT
"RTN","ZISHONT",232,0)
 ;p4=INCREMENT SUBSCRIPT
"RTN","ZISHONT",233,0)
 ;p5=Overflow subscript, defaults to "OVF"
"RTN","ZISHONT",234,0)
 N %ZA,%ZB,%ZC,%XX,%OVFCNT,%ZISHF,%ZISHO,POP,%ZISUB,$ES,$ET
"RTN","ZISHONT",235,0)
 N I,%ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHOF,%ZISHOX,%ZISHS,%ZX,%ZISHY
"RTN","ZISHONT",236,0)
 S %ZX1=$$DEFDIR($G(%ZX1)),%ZISHOF=$G(%ZX5,"OVF")
"RTN","ZISHONT",237,0)
 D MAKEREF(%ZX3,%ZX4,"%ZISHOF")
"RTN","ZISHONT",238,0)
 D OPEN^%ZISH(,%ZX1,%ZX2,"R")
"RTN","ZISHONT",239,0)
 I POP Q 0
"RTN","ZISHONT",240,0)
 S %ZC=1,%ZA=0,$ET="S %ZC=0,%ZA=-1,$EC="""" Q"
"RTN","ZISHONT",241,0)
 U IO F  K %XX D READNXT(.%XX) Q:$$EOF($ZEOF)!%ZA  D
"RTN","ZISHONT",242,0)
 . S @%ZISHF=%XX
"RTN","ZISHONT",243,0)
 . I $D(%XX)>2 F %OVFCNT=1:1 Q:'$D(%XX(%OVFCNT))  S @%ZISHO=%XX(%OVFCNT)
"RTN","ZISHONT",244,0)
 . S %ZISHI=%ZISHI+1
"RTN","ZISHONT",245,0)
 . Q
"RTN","ZISHONT",246,0)
 D CLOSE() ;Normal exit
"RTN","ZISHONT",247,0)
 Q %ZC
"RTN","ZISHONT",248,0)
 ;
"RTN","ZISHONT",249,0)
GTF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Load contents of global to host file.
"RTN","ZISHONT",250,0)
 ;p1=$NAME of global reference
"RTN","ZISHONT",251,0)
 ;p2=incrementing subscript
"RTN","ZISHONT",252,0)
 ;p3=host file directory
"RTN","ZISHONT",253,0)
 ;p4=host file name
"RTN","ZISHONT",254,0)
 N %ZISHY,%ZISHOX
"RTN","ZISHONT",255,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,%ZX3,%ZX4,"W")
"RTN","ZISHONT",256,0)
 Q %ZISHY
"RTN","ZISHONT",257,0)
 ;
"RTN","ZISHONT",258,0)
GATF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Append to host file.
"RTN","ZISHONT",259,0)
 ;
"RTN","ZISHONT",260,0)
 ;p1=$NAME of global reference
"RTN","ZISHONT",261,0)
 ;p2=incrementing subscript
"RTN","ZISHONT",262,0)
 ;p3=host file directory
"RTN","ZISHONT",263,0)
 ;p4=host file name
"RTN","ZISHONT",264,0)
 N %ZISHY
"RTN","ZISHONT",265,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,%ZX3,%ZX4,"A")
"RTN","ZISHONT",266,0)
 Q %ZISHY
"RTN","ZISHONT",267,0)
 ;
"RTN","ZISHONT",268,0)
MGTF(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;
"RTN","ZISHONT",269,0)
 ;p1=$NAME of global reference
"RTN","ZISHONT",270,0)
 ;p2=incrementing subscript
"RTN","ZISHONT",271,0)
 ;p3=host file directory
"RTN","ZISHONT",272,0)
 ;p4=host file name
"RTN","ZISHONT",273,0)
 N %ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHS,%ZISHOX,IO,%ZX,Y,%ZC
"RTN","ZISHONT",274,0)
 D MAKEREF(%ZX1,%ZX2)
"RTN","ZISHONT",275,0)
 D OPEN^%ZISH(,$G(%ZX3),%ZX4,%ZX5) ;Default dir set in open
"RTN","ZISHONT",276,0)
 I POP Q 0
"RTN","ZISHONT",277,0)
 N $ETRAP S $ETRAP="S $EC="""" D CLOSE^%ZISH() Q 0"
"RTN","ZISHONT",278,0)
 F  Q:'($D(@%ZISHF)#2)  S %ZX=@%ZISHF,%ZISHI=%ZISHI+1 U IO W %ZX,!
"RTN","ZISHONT",279,0)
 D CLOSE()
"RTN","ZISHONT",280,0)
 Q 1
"RTN","ZISHONT",281,0)
 ;
"VER")
8.0^22.0
**END**
**END**

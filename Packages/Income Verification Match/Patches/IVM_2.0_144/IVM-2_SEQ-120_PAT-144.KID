Released IVM*2*144 SEQ #120
Extracted from mail message
**KIDS**:IVM*2.0*144^

**INSTALL NAME**
IVM*2.0*144
"BLD",7137,0)
IVM*2.0*144^INCOME VERIFICATION MATCH^0^3100104^y
"BLD",7137,4,0)
^9.64PA^^
"BLD",7137,6.3)
1
"BLD",7137,"KRN",0)
^9.67PA^8989.52^19
"BLD",7137,"KRN",.4,0)
.4
"BLD",7137,"KRN",.401,0)
.401
"BLD",7137,"KRN",.402,0)
.402
"BLD",7137,"KRN",.403,0)
.403
"BLD",7137,"KRN",.5,0)
.5
"BLD",7137,"KRN",.84,0)
.84
"BLD",7137,"KRN",3.6,0)
3.6
"BLD",7137,"KRN",3.8,0)
3.8
"BLD",7137,"KRN",9.2,0)
9.2
"BLD",7137,"KRN",9.8,0)
9.8
"BLD",7137,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",7137,"KRN",9.8,"NM",1,0)
IVMPREC6^^0^B78491649
"BLD",7137,"KRN",9.8,"NM",2,0)
IVMPRECA^^0^B53857951
"BLD",7137,"KRN",9.8,"NM","B","IVMPREC6",1)

"BLD",7137,"KRN",9.8,"NM","B","IVMPRECA",2)

"BLD",7137,"KRN",19,0)
19
"BLD",7137,"KRN",19.1,0)
19.1
"BLD",7137,"KRN",101,0)
101
"BLD",7137,"KRN",409.61,0)
409.61
"BLD",7137,"KRN",771,0)
771
"BLD",7137,"KRN",870,0)
870
"BLD",7137,"KRN",8989.51,0)
8989.51
"BLD",7137,"KRN",8989.52,0)
8989.52
"BLD",7137,"KRN",8994,0)
8994
"BLD",7137,"KRN","B",.4,.4)

"BLD",7137,"KRN","B",.401,.401)

"BLD",7137,"KRN","B",.402,.402)

"BLD",7137,"KRN","B",.403,.403)

"BLD",7137,"KRN","B",.5,.5)

"BLD",7137,"KRN","B",.84,.84)

"BLD",7137,"KRN","B",3.6,3.6)

"BLD",7137,"KRN","B",3.8,3.8)

"BLD",7137,"KRN","B",9.2,9.2)

"BLD",7137,"KRN","B",9.8,9.8)

"BLD",7137,"KRN","B",19,19)

"BLD",7137,"KRN","B",19.1,19.1)

"BLD",7137,"KRN","B",101,101)

"BLD",7137,"KRN","B",409.61,409.61)

"BLD",7137,"KRN","B",771,771)

"BLD",7137,"KRN","B",870,870)

"BLD",7137,"KRN","B",8989.51,8989.51)

"BLD",7137,"KRN","B",8989.52,8989.52)

"BLD",7137,"KRN","B",8994,8994)

"BLD",7137,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7137,"QUES",0)
^9.62^^
"BLD",7137,"REQB",0)
^9.611^2^2
"BLD",7137,"REQB",1,0)
IVM*2.0*140^2
"BLD",7137,"REQB",2,0)
IVM*2.0*115^2
"BLD",7137,"REQB","B","IVM*2.0*115",2)

"BLD",7137,"REQB","B","IVM*2.0*140",1)

"MBREQ")
0
"PKG",120,-1)
1^1
"PKG",120,0)
INCOME VERIFICATION MATCH^IVM^IVM Software for interface with the IVM Center
"PKG",120,20,0)
^9.402P^^
"PKG",120,22,0)
^9.49I^1^1
"PKG",120,22,1,0)
2.0^2941021^2960823
"PKG",120,22,1,"PAH",1,0)
144^3100104
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","IVMPREC6")
0^1^B78491649^B74103661
"RTN","IVMPREC6",1,0)
IVMPREC6 ;ALB/KCL/BRM/CKN,TDM - PROCESS INCOMING (Z05 EVENT TYPE) HL7 MESSAGES ; 1/4/10 11:36am
"RTN","IVMPREC6",2,0)
 ;;2.0; INCOME VERIFICATION MATCH ;**3,4,12,17,34,58,79,102,115,140,144**; 21-OCT-94;Build 1
"RTN","IVMPREC6",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMPREC6",4,0)
 ;
"RTN","IVMPREC6",5,0)
 ; This routine will process batch ORU demographic (event type Z05) HL7
"RTN","IVMPREC6",6,0)
 ; messages received from the IVM center.  Format of HL7 batch message:
"RTN","IVMPREC6",7,0)
 ;
"RTN","IVMPREC6",8,0)
 ;       BHS
"RTN","IVMPREC6",9,0)
 ;       {MSH
"RTN","IVMPREC6",10,0)
 ;        PID
"RTN","IVMPREC6",11,0)
 ;        ZPD
"RTN","IVMPREC6",12,0)
 ;        ZGD
"RTN","IVMPREC6",13,0)
 ;        RF1 (optional)
"RTN","IVMPREC6",14,0)
 ;       }
"RTN","IVMPREC6",15,0)
 ;       BTS
"RTN","IVMPREC6",16,0)
 ;
"RTN","IVMPREC6",17,0)
 ;
"RTN","IVMPREC6",18,0)
EN ; - entry point to process HL7 patient demographic message 
"RTN","IVMPREC6",19,0)
 ;
"RTN","IVMPREC6",20,0)
 N DGENUPLD,VAFCA08,DGRUGA08,COMP,DODSEG,GUARSEG
"RTN","IVMPREC6",21,0)
 N MULTDONE,XREP
"RTN","IVMPREC6",22,0)
 ;
"RTN","IVMPREC6",23,0)
 ; prevent a return Z07 when uploading a Z05 (Patient file triggers)
"RTN","IVMPREC6",24,0)
 S DGENUPLD="ENROLLMENT/ELIGIBILITY UPLOAD IN PROGRESS"
"RTN","IVMPREC6",25,0)
 ;
"RTN","IVMPREC6",26,0)
 ; prevent MPI A08 message when uploading Z05 (Patient file triggers)
"RTN","IVMPREC6",27,0)
 S VAFCA08=1  ;MPI/CIRN A08 suppression flag
"RTN","IVMPREC6",28,0)
 ;
"RTN","IVMPREC6",29,0)
 S IVMFLG=0,IVMADFLG=0
"RTN","IVMPREC6",30,0)
 ; - get incoming HL7 message from HL7 Transmission (#772) file
"RTN","IVMPREC6",31,0)
 F IVMDA=0:0 S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)) Q:'IVMDA  S IVMSEG=$G(^(IVMDA,0)) I $E(IVMSEG,1,3)="MSH" D
"RTN","IVMPREC6",32,0)
 .K HLERR
"RTN","IVMPREC6",33,0)
 .;
"RTN","IVMPREC6",34,0)
 .; - message control id from MSH segment
"RTN","IVMPREC6",35,0)
 .S MSGID=$P(IVMSEG,HLFS,10),HLMID=MSGID
"RTN","IVMPREC6",36,0)
 .;
"RTN","IVMPREC6",37,0)
 .; - perform demographics message consistency check
"RTN","IVMPREC6",38,0)
 .D EN^IVMPRECA Q:$D(HLERR)
"RTN","IVMPREC6",39,0)
 .;
"RTN","IVMPREC6",40,0)
 .;Set array of Email, Cell, Pager fields
"RTN","IVMPREC6",41,0)
 .D EPCFLDS(.EPCFARY,.EPCDEL)
"RTN","IVMPREC6",42,0)
 .; - get next msg segment
"RTN","IVMPREC6",43,0)
 .D NEXT I $E(IVMSEG,1,3)'="PID" D  Q
"RTN","IVMPREC6",44,0)
 ..S HLERR="Missing PID segment" D ACK^IVMPREC
"RTN","IVMPREC6",45,0)
 .;
"RTN","IVMPREC6",46,0)
 .F I=1:1 D NEXT Q:$E(IVMSEG,1,4)="ZPD^"  ;Go through all PID
"RTN","IVMPREC6",47,0)
 .; - patient IEN (DFN) from PID segment
"RTN","IVMPREC6",48,0)
 .;Use IVMPID array created in IVMPRECA while performing consistency
"RTN","IVMPREC6",49,0)
 .;to process PID segment
"RTN","IVMPREC6",50,0)
 .;
"RTN","IVMPREC6",51,0)
 .;I '$G(IVMDFN) S HLERR="Invalid DFN" D ACK^IVMPREC  Q
"RTN","IVMPREC6",52,0)
 .S DFN=$G(IVMDFN)
"RTN","IVMPREC6",53,0)
 .;I ('DFN!(DFN'=+DFN)!('$D(^DPT(+DFN,0)))) D  Q
"RTN","IVMPREC6",54,0)
 .;.S HLERR="Invalid DFN" D ACK^IVMPREC
"RTN","IVMPREC6",55,0)
 .;I IVMPID(19)'=$P(^DPT(DFN,0),"^",9) D  Q
"RTN","IVMPREC6",56,0)
 .;.S HLERR="Couldn't match HEC SSN with DHCP SSN" D ACK^IVMPREC
"RTN","IVMPREC6",57,0)
 .;
"RTN","IVMPREC6",58,0)
 .; - check for entry in IVM PATIENT file, otherwise create stub entry
"RTN","IVMPREC6",59,0)
 .S IVM3015=$O(^IVM(301.5,"B",DFN,0))
"RTN","IVMPREC6",60,0)
 .I 'IVM3015 S IVM3015=$$LOG^IVMPLOG(DFN,DT)
"RTN","IVMPREC6",61,0)
 .I 'IVM3015 D  Q
"RTN","IVMPREC6",62,0)
 ..S HLERR="Failed to create entry in IVM PATIENT file"
"RTN","IVMPREC6",63,0)
 ..D ACK^IVMPREC
"RTN","IVMPREC6",64,0)
 .;
"RTN","IVMPREC6",65,0)
 .; - compare PID segment fields with DHCP fields
"RTN","IVMPREC6",66,0)
 .S IVMSEG="PID"  ;Setting IVMSEG to PID before it calls COMPARE
"RTN","IVMPREC6",67,0)
 .I 'DODSEG,'GUARSEG D COMPARE(IVMSEG) Q:$D(HLERR)
"RTN","IVMPREC6",68,0)
 .;
"RTN","IVMPREC6",69,0)
 .; - get next msg segment -decrement the counter so it can pickup ZPD
"RTN","IVMPREC6",70,0)
 .S IVMDA=IVMDA-1 D NEXT I $E(IVMSEG,1,3)'="ZPD" D  Q
"RTN","IVMPREC6",71,0)
 ..S HLERR="Missing ZPD segment" D ACK^IVMPREC
"RTN","IVMPREC6",72,0)
 .;Convert "" to null in ZPD segment except seq. 8,9, 31 and 32
"RTN","IVMPREC6",73,0)
 .S IVMSEG=$$CLEARF^IVMPRECA(IVMSEG,HLFS,",9,10,32,33,")
"RTN","IVMPREC6",74,0)
 .;
"RTN","IVMPREC6",75,0)
 .; - compare ZPD segment fields with DHCP fields
"RTN","IVMPREC6",76,0)
 .D COMPARE(IVMSEG)
"RTN","IVMPREC6",77,0)
 .;
"RTN","IVMPREC6",78,0)
 .; - get next msg segment
"RTN","IVMPREC6",79,0)
 .D NEXT I $E(IVMSEG,1,3)="ZEL" D  Q
"RTN","IVMPREC6",80,0)
 ..S HLERR="ZEL segment should not be sent in Z05 message" D ACK^IVMPREC
"RTN","IVMPREC6",81,0)
 .;
"RTN","IVMPREC6",82,0)
 .I $E(IVMSEG,1,3)="ZTA" D NEXT    ;Skip ZTA -coming later
"RTN","IVMPREC6",83,0)
 .;
"RTN","IVMPREC6",84,0)
 .; - get next msg segment
"RTN","IVMPREC6",85,0)
 .I $E(IVMSEG,1,3)'="ZGD" D  Q
"RTN","IVMPREC6",86,0)
 ..S HLERR="Missing ZGD segment" D ACK^IVMPREC
"RTN","IVMPREC6",87,0)
 .;
"RTN","IVMPREC6",88,0)
 .; - compare ZGD segment fields with DHCP fields
"RTN","IVMPREC6",89,0)
 .; convert "" to null for ZGD segment
"RTN","IVMPREC6",90,0)
 .S IVMSEG=$$CLEARF^IVMPRECA(IVMSEG,HLFS,",7,") ;ignore seq. 6
"RTN","IVMPREC6",91,0)
 .; convert seq. 6 separately
"RTN","IVMPREC6",92,0)
 .S $P(IVMSEG,HLFS,7)=$$CLEARF^IVMPRECA($P(IVMSEG,HLFS,7),$E(HLECH))
"RTN","IVMPREC6",93,0)
 .D COMPARE(IVMSEG)
"RTN","IVMPREC6",94,0)
 .;S IVMFLG=0
"RTN","IVMPREC6",95,0)
 .;
"RTN","IVMPREC6",96,0)
 .S MULTDONE=0 F XREP=1:1 D  Q:MULTDONE  ;Skip ZCT & ZEM -coming later
"RTN","IVMPREC6",97,0)
 ..D NEXT
"RTN","IVMPREC6",98,0)
 ..I ($E(IVMSEG,1,3)'="ZCT")&($E(IVMSEG,1,3)'="ZEM") S MULTDONE=1 Q
"RTN","IVMPREC6",99,0)
 .S IVMDA=IVMDA-1
"RTN","IVMPREC6",100,0)
 .;
"RTN","IVMPREC6",101,0)
 .; - check for RF1 segment and get segment if it exists
"RTN","IVMPREC6",102,0)
 .;     This process will automatically update patient address data
"RTN","IVMPREC6",103,0)
 .;     in the Patient (#2) file if the incoming address is more
"RTN","IVMPREC6",104,0)
 .;     recent than the existing one.
"RTN","IVMPREC6",105,0)
 .;Modified code to handle multiple RF1 segment - IVM*2*115
"RTN","IVMPREC6",106,0)
 .S (UPDEPC("SAD"),UPDEPC("CPH"),UPDEPC("PNO"),UPDEPC("EAD"))=0
"RTN","IVMPREC6",107,0)
 .S QFLG=0 I $$RF1CHK(IVMRTN,IVMDA) F I=1:1 D  Q:QFLG
"RTN","IVMPREC6",108,0)
 ..D NEXT
"RTN","IVMPREC6",109,0)
 ..S IVMSEG=$$CLEARF^IVMPRECA(IVMSEG,HLFS,",7,") ;ignore seq. 6
"RTN","IVMPREC6",110,0)
 ..S $P(IVMSEG,HLFS,7)=$$CLEARF^IVMPRECA($P(IVMSEG,HLFS,7),$E(HLECH))
"RTN","IVMPREC6",111,0)
 ..I $P(IVMSEG,HLFS,4)="" S QFLG=1 Q  ;Quit if RF1 is blank
"RTN","IVMPREC6",112,0)
 ..D COMPARE(IVMSEG)
"RTN","IVMPREC6",113,0)
 ..I '$$RF1CHK(IVMRTN,IVMDA) S QFLG=1
"RTN","IVMPREC6",114,0)
 .S IVMFLG=0
"RTN","IVMPREC6",115,0)
 ;
"RTN","IVMPREC6",116,0)
 ; - send mail message if necessary
"RTN","IVMPREC6",117,0)
 ; This bulletin has been disabled.  IVM*2*140
"RTN","IVMPREC6",118,0)
 ;I IVMCNTR D MAIL^IVMUFNC()
"RTN","IVMPREC6",119,0)
 ; Cleanup variables if no msg necessary
"RTN","IVMPREC6",120,0)
 I 'IVMCNTR K IVMTEXT,XMSUB
"RTN","IVMPREC6",121,0)
 ;
"RTN","IVMPREC6",122,0)
ENQ ; - cleanup variables
"RTN","IVMPREC6",123,0)
 K DA,DFN,IVMADDR,IVMADFLG,IVMDA,IVMDHCP,IVMFLAG,IVMFLD,IVMPIECE,IVMSEG,IVMSTART,IVMXREF,DGENUPLD,IVMPID,PIDSTR,ADDRESS,TELECOM,UPDEPC,EPCFARY,IVMDFN,DODSEG,EPCDEL,GUARSEG
"RTN","IVMPREC6",124,0)
 Q
"RTN","IVMPREC6",125,0)
 ;
"RTN","IVMPREC6",126,0)
 ;
"RTN","IVMPREC6",127,0)
NEXT ; - get the next HL7 segment in the message from HL7 Transmission (#772) file
"RTN","IVMPREC6",128,0)
 ;
"RTN","IVMPREC6",129,0)
 S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)),IVMSEG=$G(^(+IVMDA,0))
"RTN","IVMPREC6",130,0)
 Q
"RTN","IVMPREC6",131,0)
 ;
"RTN","IVMPREC6",132,0)
 ;
"RTN","IVMPREC6",133,0)
COMPARE(IVMSEG) ; - compare incoming HL7 segment/fields with DHCP fields
"RTN","IVMPREC6",134,0)
 ;
"RTN","IVMPREC6",135,0)
 ;  Input:  IVMSEG  --  as the text of the incoming HL7 message
"RTN","IVMPREC6",136,0)
 ;
"RTN","IVMPREC6",137,0)
 ; Output:  None
"RTN","IVMPREC6",138,0)
 ;
"RTN","IVMPREC6",139,0)
 ; - get 3 letter HL7 segment name
"RTN","IVMPREC6",140,0)
 S IVMXREF=$P(IVMSEG,HLFS,1),IVMSTART=IVMXREF
"RTN","IVMPREC6",141,0)
 ;
"RTN","IVMPREC6",142,0)
 ; - strip off HL7 segment name
"RTN","IVMPREC6",143,0)
 S IVMSEG=$P(IVMSEG,HLFS,2,99)
"RTN","IVMPREC6",144,0)
 ;
"RTN","IVMPREC6",145,0)
 ; - roll through "C" x-ref in IVM Demographic Upload Fields (#301.92) file
"RTN","IVMPREC6",146,0)
 F  S IVMXREF=$O(^IVM(301.92,"C",IVMXREF)) Q:IVMXREF']""  D
"RTN","IVMPREC6",147,0)
 .S IVMDEMDA=$O(^IVM(301.92,"C",IVMXREF,"")) Q:IVMDEMDA']""
"RTN","IVMPREC6",148,0)
 .I $$INACTIVE(IVMDEMDA) Q
"RTN","IVMPREC6",149,0)
 .;
"RTN","IVMPREC6",150,0)
 .; - compare incoming HL7 segment fields with DHCP fields
"RTN","IVMPREC6",151,0)
 .I IVMXREF["PID",(IVMSTART["PID") D PID^IVMPREC8
"RTN","IVMPREC6",152,0)
 .I IVMXREF["ZPD",(IVMSTART["ZPD") D ZPD^IVMPREC8
"RTN","IVMPREC6",153,0)
 .I IVMXREF["ZGD",(IVMSTART["ZGD") D ZGD^IVMPREC8
"RTN","IVMPREC6",154,0)
 .I IVMXREF["RF1",(IVMSTART["RF1") D RF1^IVMPREC8
"RTN","IVMPREC6",155,0)
 Q
"RTN","IVMPREC6",156,0)
 ;
"RTN","IVMPREC6",157,0)
 ;
"RTN","IVMPREC6",158,0)
DEMBULL ; -  build mail message for transmission to IVM mail group notifying
"RTN","IVMPREC6",159,0)
 ;    them that patients with updated demographic data has been received
"RTN","IVMPREC6",160,0)
 ;    from the IVM Center and may now be uploaded into DHCP.
"RTN","IVMPREC6",161,0)
 ;
"RTN","IVMPREC6",162,0)
 ; If record is auto uploaded, don't add veteran to bulletin
"RTN","IVMPREC6",163,0)
 I $$CKAUTO Q
"RTN","IVMPREC6",164,0)
 ;
"RTN","IVMPREC6",165,0)
 S IVMPTID=$$PT^IVMUFNC4(DFN)
"RTN","IVMPREC6",166,0)
 S XMSUB="IVM - DEMOGRAPHIC UPLOAD for "_$P($P(IVMPTID,"^"),",")_" ("_$P(IVMPTID,"^",3)_")"
"RTN","IVMPREC6",167,0)
 S IVMTEXT(1)="Updated demographic information has been received from the"
"RTN","IVMPREC6",168,0)
 S IVMTEXT(2)="Health Eligibilty Center.  Please select the 'Demographic Upload'"
"RTN","IVMPREC6",169,0)
 S IVMTEXT(3)="option from the IVM Upload Menu in order to take action on this"
"RTN","IVMPREC6",170,0)
 S IVMTEXT(4)="demographic information.  If you have any questions concerning the"
"RTN","IVMPREC6",171,0)
 S IVMTEXT(5)="information received, please contact the Health Eligibility Center."
"RTN","IVMPREC6",172,0)
 S IVMTEXT(7)=""
"RTN","IVMPREC6",173,0)
 S IVMTEXT(8)="The Health Eligibilty Center has identified the following"
"RTN","IVMPREC6",174,0)
 S IVMTEXT(9)="patients as having updated demographic information:"
"RTN","IVMPREC6",175,0)
 S IVMTEXT(10)=""
"RTN","IVMPREC6",176,0)
 S IVMCNTR=IVMCNTR+1
"RTN","IVMPREC6",177,0)
 S IVMTEXT(IVMCNTR+10)=$J(IVMCNTR_")",5)_"  "_$P(IVMPTID,"^")_" ("_$P(IVMPTID,"^",3)_")"
"RTN","IVMPREC6",178,0)
 Q
"RTN","IVMPREC6",179,0)
 ;
"RTN","IVMPREC6",180,0)
INACTIVE(IVMDEMDA) ;Check if field is inactive in Demographic Upload
"RTN","IVMPREC6",181,0)
 ; Input  -- IVMDEMDA IVM Demographic Upload Fields IEN
"RTN","IVMPREC6",182,0)
 ; Output -- 1=Yes and 0=No
"RTN","IVMPREC6",183,0)
 Q +$P($G(^IVM(301.92,IVMDEMDA,0)),U,9)
"RTN","IVMPREC6",184,0)
 ;
"RTN","IVMPREC6",185,0)
RF1CHK(IVMRTN,IVMDA) ;does an RF1 segment exist in this message?
"RTN","IVMPREC6",186,0)
 N RF1
"RTN","IVMPREC6",187,0)
 S RF1=$O(^TMP($J,IVMRTN,IVMDA))
"RTN","IVMPREC6",188,0)
 I $E($G(^(+RF1,0)),1,3)'="RF1" Q 0
"RTN","IVMPREC6",189,0)
 Q 1
"RTN","IVMPREC6",190,0)
 ;
"RTN","IVMPREC6",191,0)
CKAUTO() ;
"RTN","IVMPREC6",192,0)
 ; Chect if message qualifies for an auto upload.
"RTN","IVMPREC6",193,0)
 N AUTO,IVMI,DOD
"RTN","IVMPREC6",194,0)
 S AUTO=0,IVMI=$O(^IVM(301.92,"C","ZPD09",""))
"RTN","IVMPREC6",195,0)
 I IVMI=IVMDEMDA  D
"RTN","IVMPREC6",196,0)
 .I +IVMFLD'>0 S AUTO=1 Q
"RTN","IVMPREC6",197,0)
 .S DOD=$P($G(^DPT(DFN,.35)),U)
"RTN","IVMPREC6",198,0)
 .I DOD=IVMFLD S AUTO=1 Q
"RTN","IVMPREC6",199,0)
 ;
"RTN","IVMPREC6",200,0)
 Q AUTO
"RTN","IVMPREC6",201,0)
BLDPID(PIDTMP,IVMPID) ;Build IVMPID subscripted by sequence number
"RTN","IVMPREC6",202,0)
 N STR,X1,X2,N,TEXT,C,L
"RTN","IVMPREC6",203,0)
 S STR="",X1=1,(N,X2)=0
"RTN","IVMPREC6",204,0)
 F  S N=$O(PIDTMP(N)) Q:N=""  S TEXT=PIDTMP(N) F L=1:1:$L(TEXT) S C=$E(TEXT,L) D
"RTN","IVMPREC6",205,0)
 . I C="^" D  Q
"RTN","IVMPREC6",206,0)
 . . I X2 S X2=X2+1,IVMPID(X1,X2)=STR
"RTN","IVMPREC6",207,0)
 . . E  S IVMPID(X1)=STR
"RTN","IVMPREC6",208,0)
 . . S STR="",X1=X1+1,X2=0
"RTN","IVMPREC6",209,0)
 . I C="|" D  Q
"RTN","IVMPREC6",210,0)
 . . S X2=X2+1,IVMPID(X1,X2)=STR,STR=""
"RTN","IVMPREC6",211,0)
 . S STR=STR_C
"RTN","IVMPREC6",212,0)
 I $G(C)'="",$G(C)'="^",$G(C)'="|" D
"RTN","IVMPREC6",213,0)
 . I X2 S X2=X2+1,IVMPID(X1,X2)=STR Q
"RTN","IVMPREC6",214,0)
 . S IVMPID(X1)=STR
"RTN","IVMPREC6",215,0)
 Q
"RTN","IVMPREC6",216,0)
ADDRCHNG(DFN) ;Store Address Change Date/time, Source and site if necessary
"RTN","IVMPREC6",217,0)
 N IVMVALUE,IVMFIELD
"RTN","IVMPREC6",218,0)
 I '$D(^TMP($J,"CHANGE UPDATE")) Q
"RTN","IVMPREC6",219,0)
 S IVMFIELD=0 F  S IVMFIELD=$O(^TMP($J,"CHANGE UPDATE",IVMFIELD)) Q:IVMFIELD=""  D
"RTN","IVMPREC6",220,0)
 . S IVMVALUE=$G(^TMP($J,"CHANGE UPDATE",IVMFIELD))
"RTN","IVMPREC6",221,0)
 . S DIE="^DPT(",DA=DFN,DR=IVMFIELD_"////^S X=IVMVALUE"
"RTN","IVMPREC6",222,0)
 . D ^DIE K DA,DIE,DR
"RTN","IVMPREC6",223,0)
 .; - delete inaccurate Addr Change Site data if Source is not VAMC
"RTN","IVMPREC6",224,0)
 . I IVMFIELD=.119,IVMVALUE'="VAMC" S FDA(2,+DFN_",",.12)="@" D UPDATE^DIE("E","FDA")
"RTN","IVMPREC6",225,0)
 K ^TMP($J,"CHANGE UPDATE")
"RTN","IVMPREC6",226,0)
 Q
"RTN","IVMPREC6",227,0)
EPCFLDS(EPCFARY,EPCDEL) ;
"RTN","IVMPREC6",228,0)
 ;EPCFARY - Contains IENs of Pager, email and Cell phone records in 301.92 File - Passed by reference
"RTN","IVMPREC6",229,0)
 ;EPCDEL - Contains field # of Pager, Email and Cell phone fields in Patient(#2) file. - Passed by reference
"RTN","IVMPREC6",230,0)
 I (DODSEG)!(GUARSEG) Q
"RTN","IVMPREC6",231,0)
 S EPCFARY("PNO")=$O(^IVM(301.92,"B","PAGER NUMBER",0))_"^"_$O(^IVM(301.92,"B","PAGER CHANGE DT/TM",0))_"^"_$O(^IVM(301.92,"B","PAGER CHANGE SITE",0))_"^"_$O(^IVM(301.92,"B","PAGER CHANGE SOURCE",0))
"RTN","IVMPREC6",232,0)
 S EPCFARY("CPH")=$O(^IVM(301.92,"B","CELLULAR NUMBER",0))_"^"_$O(^IVM(301.92,"B","CELL PHONE CHANGE DT/TM",0))_"^"_$O(^IVM(301.92,"B","CELL PHONE CHANGE SITE",0))_"^"_$O(^IVM(301.92,"B","CELL PHONE CHANGE SOURCE",0))
"RTN","IVMPREC6",233,0)
 S EPCFARY("EAD")=$O(^IVM(301.92,"B","EMAIL ADDRESS",0))_"^"_$O(^IVM(301.92,"B","EMAIL CHANGE DT/TM",0))_"^"_$O(^IVM(301.92,"B","EMAIL CHANGE SITE",0))_"^"_$O(^IVM(301.92,"B","EMAIL CHANGE SOURCE",0))
"RTN","IVMPREC6",234,0)
 S EPCDEL("PNO")=".135^.1312^.1313^.1314"
"RTN","IVMPREC6",235,0)
 S EPCDEL("CPH")=".134^.139^.1311^.13111"
"RTN","IVMPREC6",236,0)
 S EPCDEL("EAD")=".133^.136^.137^.138"
"RTN","IVMPREC6",237,0)
 Q
"RTN","IVMPRECA")
0^2^B53857951^B47594808
"RTN","IVMPRECA",1,0)
IVMPRECA ;ALB/KCL/BRM/PJR/RGL/CKN - DEMOGRAPHICS MESSAGE CONSISTENCY CHECK ; 1/4/10 11:36am
"RTN","IVMPRECA",2,0)
 ;;2.0; INCOME VERIFICATION MATCH ;**5,6,12,34,58,56,115,144**; 21-OCT-94;Build 1
"RTN","IVMPRECA",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMPRECA",4,0)
 ;
"RTN","IVMPRECA",5,0)
 ; This routine will perform data validation checks on uploadable
"RTN","IVMPRECA",6,0)
 ; demographic fields received from the IVM Center to ensure they
"RTN","IVMPRECA",7,0)
 ; are acurate prior to their upload into DHCP.
"RTN","IVMPRECA",8,0)
 ;
"RTN","IVMPRECA",9,0)
 ;
"RTN","IVMPRECA",10,0)
 ; Called from routine IVMPREC6 before uploadable demographic fields
"RTN","IVMPRECA",11,0)
 ; are stored in DHCP.
"RTN","IVMPRECA",12,0)
 ;
"RTN","IVMPRECA",13,0)
 ;
"RTN","IVMPRECA",14,0)
EN ; - Entry point to create temp array and perform msg consistency checks
"RTN","IVMPRECA",15,0)
 ;
"RTN","IVMPRECA",16,0)
 N DFN,IVMCNTY,IVMCR,IVMEG,IVMFLAG,IVMFLD,IVMNUM,IVMSTR,IVMSTPTR,X
"RTN","IVMPRECA",17,0)
 N COMP,CNTR,NOPID,ADDRTYPE,ADDSEQ,TELESEQ,COMMTYPE,TCFLG,TMPARRY,PID3ARRY,CNTR2
"RTN","IVMPRECA",18,0)
 S IVMNUM=IVMDA ; 'current' line in ^HL(772,"IN",...
"RTN","IVMPRECA",19,0)
 S DODSEG=0 ;Initialize flag for DOD information
"RTN","IVMPRECA",20,0)
 S GUARSEG=0 ;Initialize flag for Guardian information
"RTN","IVMPRECA",21,0)
 ;
"RTN","IVMPRECA",22,0)
 ; - check the format of the HL7 demographic message
"RTN","IVMPRECA",23,0)
 D NEXT I $E(IVMSTR,1,3)'="PID" S HLERR="Missing PID segment" G ENQ
"RTN","IVMPRECA",24,0)
 S CNTR=1,NOPID=0,PIDSTR(CNTR)=$P(IVMSTR,HLFS,2,999)
"RTN","IVMPRECA",25,0)
 ;Handle wrapped PID segment
"RTN","IVMPRECA",26,0)
 F I=1:1 D  Q:NOPID
"RTN","IVMPRECA",27,0)
 . D NEXT I $E(IVMSTR,1,4)="ZPD^" S NOPID=1 Q
"RTN","IVMPRECA",28,0)
 . S CNTR=CNTR+1,PIDSTR(CNTR)=IVMSTR
"RTN","IVMPRECA",29,0)
 D BLDPID^IVMPREC6(.PIDSTR,.IVMPID)  ;Create IVMPID subscript by seq #
"RTN","IVMPRECA",30,0)
 ;convert "" to null for PID segment
"RTN","IVMPRECA",31,0)
 S CNTR="" F  S CNTR=$O(IVMPID(CNTR)) Q:CNTR=""  D
"RTN","IVMPRECA",32,0)
 . I $O(IVMPID(CNTR,"")) D  Q
"RTN","IVMPRECA",33,0)
 . . S CNTR2="" F  S CNTR2=$O(IVMPID(CNTR,CNTR2)) Q:CNTR2=""  D
"RTN","IVMPRECA",34,0)
 . . . S IVMPID(CNTR,CNTR2)=$$CLEARF(IVMPID(CNTR,CNTR2),$E(HLECH))
"RTN","IVMPRECA",35,0)
 . I CNTR=11 S IVMPID(CNTR)=$$CLEARF(IVMPID(CNTR),$E(HLECH)) Q
"RTN","IVMPRECA",36,0)
 . I IVMPID(CNTR)=HLQ S IVMPID(CNTR)=""
"RTN","IVMPRECA",37,0)
 I $E(IVMSTR,1,3)'="ZPD" S HLERR="Missing ZPD segment" G ENQ
"RTN","IVMPRECA",38,0)
 S IVMSTR("ZPD")=$P(IVMSTR,HLFS,2,999)
"RTN","IVMPRECA",39,0)
 I $P(IVMSTR("ZPD"),HLFS,8)'="" S GUARSEG=1
"RTN","IVMPRECA",40,0)
 I $P(IVMSTR("ZPD"),HLFS,9)'="" S DODSEG=1
"RTN","IVMPRECA",41,0)
 D NEXT I $E(IVMSTR,1,3)="ZEL" S HLERR="ZEL segment should not be sent in Z05 message" G ENQ
"RTN","IVMPRECA",42,0)
 I $E(IVMSTR,1,3)="ZTA" D NEXT  ;Skip ZTA -coming later
"RTN","IVMPRECA",43,0)
 I $E(IVMSTR,1,3)'="ZGD" S HLERR="Missing ZGD segment" G ENQ
"RTN","IVMPRECA",44,0)
 S IVMSTR("ZGD")=$P(IVMSTR,HLFS,2,999)
"RTN","IVMPRECA",45,0)
 ;
"RTN","IVMPRECA",46,0)
 ; - perform field validation checks for PID segment
"RTN","IVMPRECA",47,0)
 M TMPARRY(3)=IVMPID(3) D PARSPID3^IVMUFNC(.TMPARRY,.PID3ARY)
"RTN","IVMPRECA",48,0)
 S DFN=$G(PID3ARY("PI")),ICN=$G(PID3ARY("NI"))
"RTN","IVMPRECA",49,0)
 K TMPARRY,PID3ARY
"RTN","IVMPRECA",50,0)
 I '$$MATCH^IVMUFNC(DFN,ICN,"","","I",.ERRMSG) S HLERR=ERRMSG G ENQ
"RTN","IVMPRECA",51,0)
 S IVMDFN=DFN  ;Store DFN in temp variable to use later
"RTN","IVMPRECA",52,0)
 ;I IVMPID(19)'=$P(^DPT(DFN,0),"^",9) S HLERR="Couldn't match IVM SSN with DHCP SSN" G ENQ
"RTN","IVMPRECA",53,0)
 ;
"RTN","IVMPRECA",54,0)
 S X=IVMPID(7) I X]"",($$FMDATE^HLFNC(X)>DT) S HLERR="Date of Birth greater than current date" G ENQ
"RTN","IVMPRECA",55,0)
 ;
"RTN","IVMPRECA",56,0)
 S X=IVMPID(8) I X]"",X'="M",X'="F" S HLERR="Invalid code sent for Patient sex" G ENQ
"RTN","IVMPRECA",57,0)
 ;
"RTN","IVMPRECA",58,0)
 ; - if address - perform validation checks on addr fields
"RTN","IVMPRECA",59,0)
 ;Get all address from seq. 11 of PID segment
"RTN","IVMPRECA",60,0)
 I 'DODSEG,'GUARSEG D
"RTN","IVMPRECA",61,0)
 . D PID11 Q:$D(HLERR)
"RTN","IVMPRECA",62,0)
 . D PID13
"RTN","IVMPRECA",63,0)
 G ENQ:$D(HLERR)
"RTN","IVMPRECA",64,0)
 ;
"RTN","IVMPRECA",65,0)
 ; - perform field validation check for ZPD and ZGD segment
"RTN","IVMPRECA",66,0)
 ; - I X]"" was changed to I X below for IVM*2*56
"RTN","IVMPRECA",67,0)
 S X=$P(IVMSTR("ZPD"),HLFS,9) I X,($$FMDATE^HLFNC(X)<$P($G(^DPT(+DFN,0)),"^",3))!($$FMDATE^HLFNC(X)>$$DT^XLFDT) S HLERR="Invalid date of death" G ENQ
"RTN","IVMPRECA",68,0)
 S X=$P(IVMSTR("ZGD"),HLFS,2) I X,X'=1 S HLERR="Invalid Guardian Type" G ENQ
"RTN","IVMPRECA",69,0)
 ;
"RTN","IVMPRECA",70,0)
 ;
"RTN","IVMPRECA",71,0)
ENQ ; - send acknowledgement (ACK) 'AE' msg to the IVM Center
"RTN","IVMPRECA",72,0)
 I $D(HLERR) D ACK^IVMPREC
"RTN","IVMPRECA",73,0)
 Q
"RTN","IVMPRECA",74,0)
 ;
"RTN","IVMPRECA",75,0)
 ;
"RTN","IVMPRECA",76,0)
ADDRCHK ; - validate address fields sent by IVM Center
"RTN","IVMPRECA",77,0)
 ;
"RTN","IVMPRECA",78,0)
 S CNTRY=$P(X,$E(HLECH),6) I CNTRY']"" S HLERR="Invalid address - Missing Country" Q
"RTN","IVMPRECA",79,0)
 I '$$CNTRCONV^IVMPREC8(CNTRY) S HLERR="Invalid address - Invalid Country" Q
"RTN","IVMPRECA",80,0)
 S FORFLG=$S(CNTRY="USA":0,1:1)
"RTN","IVMPRECA",81,0)
 I $P(X,$E(HLECH),1)']"" S HLERR="Invalid address - Missing street address [line 1]" Q
"RTN","IVMPRECA",82,0)
 I $P(X,$E(HLECH),3)']"" S HLERR="Invalid address - Missing city" Q
"RTN","IVMPRECA",83,0)
 ;I $P(X,$E(HLECH),4)']"" S HLERR="Invalid address - Missing "_$S('FORFLG:"state abbreviation",1:"province") Q
"RTN","IVMPRECA",84,0)
 ;I $P(X,$E(HLECH),5)']"" S HLERR="Invalid address - Missing "_$S('FORFLG:"zip code",1:"postal code") Q
"RTN","IVMPRECA",85,0)
 I $P(X,$E(HLECH),4)']"",'FORFLG S HLERR="Invalid address - Missing State abbreviation" Q
"RTN","IVMPRECA",86,0)
 I $P(X,$E(HLECH),5)']"",'FORFLG S HLERR="Invalid address - Missing Zip Code" Q
"RTN","IVMPRECA",87,0)
 I 'FORFLG D  Q:$D(HLERR)
"RTN","IVMPRECA",88,0)
 . S IVMCNTY=$G(IVMPID(12))
"RTN","IVMPRECA",89,0)
 . I IVMCNTY']"" S HLERR="Invalid address - Missing county code" Q
"RTN","IVMPRECA",90,0)
 I $L($P(X,$E(HLECH),1))>35!($L($P(X,$E(HLECH),1))<3) S HLERR="Invalid street address [line 1]" Q
"RTN","IVMPRECA",91,0)
 I $P(X,$E(HLECH),2)]"",(($L($P(X,$E(HLECH),2))>30)!($L($P(X,$E(HLECH),2))<3)) S HLERR="Invalid street address [line 2]" Q
"RTN","IVMPRECA",92,0)
 I $L($P(X,$E(HLECH),3))>15!($L($P(X,$E(HLECH),3))<2) S HLERR="Invalid city" Q
"RTN","IVMPRECA",93,0)
 ;
"RTN","IVMPRECA",94,0)
 ; - save state pointer for county code validation only if not foreign address
"RTN","IVMPRECA",95,0)
 I 'FORFLG D  Q:$D(HLERR)
"RTN","IVMPRECA",96,0)
 .S IVMSTPTR=+$O(^DIC(5,"C",$P(X,$E(HLECH),4),0))
"RTN","IVMPRECA",97,0)
 .I 'IVMSTPTR S HLERR="Invalid state abbreviation" Q
"RTN","IVMPRECA",98,0)
 .I '$O(^DIC(5,IVMSTPTR,1,"C",IVMCNTY,0)) D  Q:$G(HLERR)]""
"RTN","IVMPRECA",99,0)
 ..N STFIPS
"RTN","IVMPRECA",100,0)
 ..S STFIPS=IVMSTPTR
"RTN","IVMPRECA",101,0)
 ..S:$L(STFIPS)<2 STFIPS="0"_STFIPS
"RTN","IVMPRECA",102,0)
 ..Q:$$FIPSCHK^XIPUTIL(STFIPS_IVMCNTY)  ;county code is valid
"RTN","IVMPRECA",103,0)
 ..S HLERR="Invalid county code"
"RTN","IVMPRECA",104,0)
 .S X=$P(X,$E(HLECH),5) D ZIPIN^VAFADDR I $D(X)[0 S HLERR="Invalid zip code" Q
"RTN","IVMPRECA",105,0)
 Q
"RTN","IVMPRECA",106,0)
 ;
"RTN","IVMPRECA",107,0)
 ;
"RTN","IVMPRECA",108,0)
NEXT ; - get the next HL7 segment in the message from HL7 Transmission (#772) file
"RTN","IVMPRECA",109,0)
 S IVMNUM=$O(^TMP($J,IVMRTN,IVMNUM)),IVMSTR=$G(^(+IVMNUM,0))
"RTN","IVMPRECA",110,0)
 Q
"RTN","IVMPRECA",111,0)
PID11 ; Perform consistency check for seq. 11
"RTN","IVMPRECA",112,0)
 ;
"RTN","IVMPRECA",113,0)
 ;Start of temp code to ignore new addr types for now.
"RTN","IVMPRECA",114,0)
 I $D(IVMPID(11)) D
"RTN","IVMPRECA",115,0)
 . I $O(IVMPID(11,"")) D  Q
"RTN","IVMPRECA",116,0)
 . . S ADDSEQ=0 F  S ADDSEQ=$O(IVMPID(11,ADDSEQ)) Q:ADDSEQ=""  D
"RTN","IVMPRECA",117,0)
 . . . S ADDRTYPE=$P($G(IVMPID(11,ADDSEQ)),$E(HLECH),7)
"RTN","IVMPRECA",118,0)
 . . . I ($G(ADDRTYPE)="VACAE")!($G(ADDRTYPE)="VACAA")!($G(ADDRTYPE)="VACAC")!($G(ADDRTYPE)="VACAM") K IVMPID(11,ADDSEQ)
"RTN","IVMPRECA",119,0)
 . S ADDRTYPE=$P($G(IVMPID(11)),$E(HLECH),7)
"RTN","IVMPRECA",120,0)
 . I ($G(ADDRTYPE)="VACAE")!($G(ADDRTYPE)="VACAA")!($G(ADDRTYPE)="VACAC")!($G(ADDRTYPE)="VACAM") K IVMPID(11)
"RTN","IVMPRECA",121,0)
 ;End of temp code.
"RTN","IVMPRECA",122,0)
 ;
"RTN","IVMPRECA",123,0)
 I $D(IVMPID(11)) D
"RTN","IVMPRECA",124,0)
 . I $O(IVMPID(11,"")) D  Q
"RTN","IVMPRECA",125,0)
 . . S ADDSEQ=0 F  S ADDSEQ=$O(IVMPID(11,ADDSEQ)) Q:ADDSEQ=""!($D(HLERR))  D
"RTN","IVMPRECA",126,0)
 . . . I $G(IVMPID(11,ADDSEQ))="" S HLERR="Invalid Address - Missing Address information" Q
"RTN","IVMPRECA",127,0)
 . . . S ADDRTYPE=$P($G(IVMPID(11,ADDSEQ)),$E(HLECH),7)
"RTN","IVMPRECA",128,0)
 . . . I ADDRTYPE="" S HLERR="Invalid Address - Missing Address Type" Q
"RTN","IVMPRECA",129,0)
 . . . I ADDRTYPE="P"!(ADDRTYPE="VAB1")!(ADDRTYPE="VAB2")!(ADDRTYPE="VAB3")!(ADDRTYPE="VAB4") S ADDRESS(ADDRTYPE)=IVMPID(11,ADDSEQ)
"RTN","IVMPRECA",130,0)
 . I $G(IVMPID(11))="" S HLERR="Invalid Address - Missing Address information" Q
"RTN","IVMPRECA",131,0)
 . S ADDRTYPE=$P($G(IVMPID(11)),$E(HLECH),7)
"RTN","IVMPRECA",132,0)
 . I ADDRTYPE="" S HLERR="Invalid Address - Missing Address Type" Q
"RTN","IVMPRECA",133,0)
 . I ADDRTYPE="P"!(ADDRTYPE="VAB1")!(ADDRTYPE="VAB2")!(ADDRTYPE="VAB3")!(ADDRTYPE="VAB4") S ADDRESS(ADDRTYPE)=IVMPID(11)
"RTN","IVMPRECA",134,0)
 Q:$D(HLERR)
"RTN","IVMPRECA",135,0)
 ;perform consistency checks on Permanent and all bad address
"RTN","IVMPRECA",136,0)
 I '$D(ADDRESS) S HLERR="Invalid Address - Invalid Address Type" Q
"RTN","IVMPRECA",137,0)
 S ADDRTYPE="" S ADDRTYPE=$O(ADDRESS(ADDRTYPE)) D
"RTN","IVMPRECA",138,0)
 . S X=$G(ADDRESS(ADDRTYPE)) D ADDRCHK
"RTN","IVMPRECA",139,0)
 Q
"RTN","IVMPRECA",140,0)
 ;
"RTN","IVMPRECA",141,0)
PID13 ; Perform consistency checks for seq. 13
"RTN","IVMPRECA",142,0)
 ;Get communication data for all types from seq. 13 or PID segment
"RTN","IVMPRECA",143,0)
 S TCFLG=1 ;Flag to check if Telecom data exist.
"RTN","IVMPRECA",144,0)
 I $D(IVMPID(13)) D
"RTN","IVMPRECA",145,0)
 . I $O(IVMPID(13,"")) D  Q
"RTN","IVMPRECA",146,0)
 . . S TELESEQ=0 F  S TELESEQ=$O(IVMPID(13,TELESEQ)) Q:((TELESEQ="")!($D(HLERR))!('TCFLG))  D
"RTN","IVMPRECA",147,0)
 . . . I $G(IVMPID(13,TELESEQ))="" S TCFLG=0 Q
"RTN","IVMPRECA",148,0)
 . . . I $P(IVMPID(13,TELESEQ),$E(HLECH),2)="" S HLERR="Invalid Communication Data - Missing Communication Type - PID Seq 13" Q
"RTN","IVMPRECA",149,0)
 . . . S TELECOM($P(IVMPID(13,TELESEQ),$E(HLECH),2))=IVMPID(13,TELESEQ)
"RTN","IVMPRECA",150,0)
 . I $G(IVMPID(13))="" S TCFLG=0 Q
"RTN","IVMPRECA",151,0)
 . I $P(IVMPID(13),$E(HLECH),2)="" S HLERR="Invalid Communication Data - Missing Communication Type - PID Seq 13" Q
"RTN","IVMPRECA",152,0)
 . S TELECOM($P(IVMPID(13),$E(HLECH),2))=IVMPID(13)
"RTN","IVMPRECA",153,0)
 Q:$D(HLERR)
"RTN","IVMPRECA",154,0)
 ;perform consistency checks on all types of communication data.
"RTN","IVMPRECA",155,0)
 I TCFLG D
"RTN","IVMPRECA",156,0)
 . S COMMTYPE="" F  S COMMTYPE=$O(TELECOM(COMMTYPE)) Q:COMMTYPE=""!$D(HLERR)  D
"RTN","IVMPRECA",157,0)
 . . I COMMTYPE="NET" D  Q
"RTN","IVMPRECA",158,0)
 . . . S X=$P(TELECOM(COMMTYPE),$E(HLECH),4)
"RTN","IVMPRECA",159,0)
 . . . I X]"",'$$CHKEMAIL^IVMPREC8(X) S HLERR="Invalid Email address"
"RTN","IVMPRECA",160,0)
 . . S X=$P(TELECOM(COMMTYPE),$E(HLECH)) I X]"",(($L(X)>20)!($L(X)<4)) S HLERR="Invalid phone number"
"RTN","IVMPRECA",161,0)
 Q
"RTN","IVMPRECA",162,0)
 ;
"RTN","IVMPRECA",163,0)
CLEARF(NODE,DEL,IGNORE) ;
"RTN","IVMPRECA",164,0)
 ; Input:       NODE    - SEGMENT/SEQ.
"RTN","IVMPRECA",165,0)
 ;               DEL    - Delimiter (optional - default is ^)
"RTN","IVMPRECA",166,0)
 ;            IGNORE    - String of seq # to avoid (optional)
"RTN","IVMPRECA",167,0)
 N I
"RTN","IVMPRECA",168,0)
 I $G(DEL)="" S DEL=HLFS
"RTN","IVMPRECA",169,0)
 F I=1:1:$L(NODE,DEL) D
"RTN","IVMPRECA",170,0)
 . I $G(IGNORE)[(","_I_",") Q  ;Ignore this seq. to convert
"RTN","IVMPRECA",171,0)
 . I $P(NODE,DEL,I)=HLQ S $P(NODE,DEL,I)=""
"RTN","IVMPRECA",172,0)
 Q NODE
"VER")
8.0^22.0
"BLD",7137,6)
^120
**END**
**END**

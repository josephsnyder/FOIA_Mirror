EMERGENCY Released IVM*2*140 SEQ #114
Extracted from mail message
**KIDS**:IVM*2.0*140^

**INSTALL NAME**
IVM*2.0*140
"BLD",7184,0)
IVM*2.0*140^INCOME VERIFICATION MATCH^0^3090408^y
"BLD",7184,4,0)
^9.64PA^^
"BLD",7184,6.3)
2
"BLD",7184,"KRN",0)
^9.67PA^8989.52^19
"BLD",7184,"KRN",.4,0)
.4
"BLD",7184,"KRN",.401,0)
.401
"BLD",7184,"KRN",.402,0)
.402
"BLD",7184,"KRN",.403,0)
.403
"BLD",7184,"KRN",.5,0)
.5
"BLD",7184,"KRN",.84,0)
.84
"BLD",7184,"KRN",3.6,0)
3.6
"BLD",7184,"KRN",3.8,0)
3.8
"BLD",7184,"KRN",9.2,0)
9.2
"BLD",7184,"KRN",9.8,0)
9.8
"BLD",7184,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",7184,"KRN",9.8,"NM",1,0)
IVMCMB^^0^B16887708
"BLD",7184,"KRN",9.8,"NM",2,0)
IVMPREC6^^0^B74103661
"BLD",7184,"KRN",9.8,"NM","B","IVMCMB",1)

"BLD",7184,"KRN",9.8,"NM","B","IVMPREC6",2)

"BLD",7184,"KRN",19,0)
19
"BLD",7184,"KRN",19.1,0)
19.1
"BLD",7184,"KRN",101,0)
101
"BLD",7184,"KRN",409.61,0)
409.61
"BLD",7184,"KRN",771,0)
771
"BLD",7184,"KRN",870,0)
870
"BLD",7184,"KRN",8989.51,0)
8989.51
"BLD",7184,"KRN",8989.52,0)
8989.52
"BLD",7184,"KRN",8994,0)
8994
"BLD",7184,"KRN","B",.4,.4)

"BLD",7184,"KRN","B",.401,.401)

"BLD",7184,"KRN","B",.402,.402)

"BLD",7184,"KRN","B",.403,.403)

"BLD",7184,"KRN","B",.5,.5)

"BLD",7184,"KRN","B",.84,.84)

"BLD",7184,"KRN","B",3.6,3.6)

"BLD",7184,"KRN","B",3.8,3.8)

"BLD",7184,"KRN","B",9.2,9.2)

"BLD",7184,"KRN","B",9.8,9.8)

"BLD",7184,"KRN","B",19,19)

"BLD",7184,"KRN","B",19.1,19.1)

"BLD",7184,"KRN","B",101,101)

"BLD",7184,"KRN","B",409.61,409.61)

"BLD",7184,"KRN","B",771,771)

"BLD",7184,"KRN","B",870,870)

"BLD",7184,"KRN","B",8989.51,8989.51)

"BLD",7184,"KRN","B",8989.52,8989.52)

"BLD",7184,"KRN","B",8994,8994)

"BLD",7184,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7184,"QUES",0)
^9.62^^
"BLD",7184,"REQB",0)
^9.611^2^2
"BLD",7184,"REQB",1,0)
IVM*2.0*49^2
"BLD",7184,"REQB",2,0)
IVM*2.0*115^2
"BLD",7184,"REQB","B","IVM*2.0*115",2)

"BLD",7184,"REQB","B","IVM*2.0*49",1)

"MBREQ")
0
"PKG",120,-1)
1^1
"PKG",120,0)
INCOME VERIFICATION MATCH^IVM^IVM Software for interface with the IVM Center
"PKG",120,20,0)
^9.402P^^
"PKG",120,22,0)
^9.49I^1^1
"PKG",120,22,1,0)
2.0^2941021^2960823
"PKG",120,22,1,"PAH",1,0)
140^3090408
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","IVMCMB")
0^1^B16887708^B16093169
"RTN","IVMCMB",1,0)
IVMCMB ;ALB/SEK,BRM,TDM - SEND INCOME TEST TRANSMISSION BULLETIN ; 4/2/09 1:19pm
"RTN","IVMCMB",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**17,49,140**;21-OCT-94;Build 2
"RTN","IVMCMB",3,0)
 ;
"RTN","IVMCMB",4,0)
 ;  Input array required:
"RTN","IVMCMB",5,0)
 ;    ^TMP($J,"IVMBULL"  --  contains lists of tests which were uploaded
"RTN","IVMCMB",6,0)
 ;     dfn^type of test^dt of test^category^action
"RTN","IVMCMB",7,0)
 ;
"RTN","IVMCMB",8,0)
BULL ; Send mail message notifying site of uploaded income tests.
"RTN","IVMCMB",9,0)
 ;
"RTN","IVMCMB",10,0)
 G BULLQ        ; This bulletin has been disabled.  IVM*2*140
"RTN","IVMCMB",11,0)
 ;
"RTN","IVMCMB",12,0)
 K IVMTEXT
"RTN","IVMCMB",13,0)
 I '$D(^TMP($J,"IVMBULL")) G BULLQ
"RTN","IVMCMB",14,0)
 S XMSUB="HEC INCOME TEST UPLOAD"
"RTN","IVMCMB",15,0)
 S IVMTEXT(1)="Income tests were uploaded from the Health Eligibility Center"
"RTN","IVMCMB",16,0)
 S IVMTEXT(2)="for the following patients:"
"RTN","IVMCMB",17,0)
 S IVMTEXT(3)=" "
"RTN","IVMCMB",18,0)
 S IVMTEXT(4)="    Name         PID          Type        TestDate   Old->New  Action"
"RTN","IVMCMB",19,0)
 S IVMTEXT(5)="                                                       Code"
"RTN","IVMCMB",20,0)
 S IVMBCTR=$G(^TMP($J,"IVMBULL",0))
"RTN","IVMCMB",21,0)
 F IVMBDA=1:1:IVMBCTR D
"RTN","IVMCMB",22,0)
 .S IVMBULLM=$G(^TMP($J,"IVMBULL",IVMBDA)) Q:'IVMBULLM
"RTN","IVMCMB",23,0)
 .S IVMPAT=$$PT^IVMUFNC4($P(IVMBULLM,"^"))
"RTN","IVMCMB",24,0)
 .S $E(IVMTEXT(IVMBDA+5),1,30)=$E($P(IVMPAT,"^"),1,18)_" "_$P(IVMPAT,"^",2)
"RTN","IVMCMB",25,0)
 .S $E(IVMTEXT(IVMBDA+5),31,41)=$S($P(IVMBULLM,"^",2)=1:"Means Test",$P(IVMBULLM,"^",2)=2:"Copay Test",$P(IVMBULLM,"^",2)=4:"LTC Test",1:"")
"RTN","IVMCMB",26,0)
 .S Y=$P(IVMBULLM,"^",3) X ^DD("DD") ;test date
"RTN","IVMCMB",27,0)
 .S $E(IVMTEXT(IVMBDA+5),43,53)=Y
"RTN","IVMCMB",28,0)
 .S $E(IVMTEXT(IVMBDA+5),56,56)=$P(IVMBULLM,"^",4) ;status before
"RTN","IVMCMB",29,0)
 .S $E(IVMTEXT(IVMBDA+5),57,58)="->"
"RTN","IVMCMB",30,0)
 .S $E(IVMTEXT(IVMBDA+5),59)=$P(IVMBULLM,"^",5) ;status after
"RTN","IVMCMB",31,0)
 .S $E(IVMTEXT(IVMBDA+5),64,78)=$P(IVMBULLM,"^",6) ;action
"RTN","IVMCMB",32,0)
 ;
"RTN","IVMCMB",33,0)
 D MAIL^IVMUFNC("DGMT MT/CT UPLOAD ALERTS")
"RTN","IVMCMB",34,0)
BULLQ K IVMBCTR,IVMBDA,IVMBULLM,^TMP($J,"IVMBULL"),IVMPAT,Y
"RTN","IVMCMB",35,0)
 Q
"RTN","IVMCMB",36,0)
 ;
"RTN","IVMCMB",37,0)
BULL1(DFN,WDATE,SITE) ; 
"RTN","IVMCMB",38,0)
 ;Send message notifying site of hardship determination
"RTN","IVMCMB",39,0)
 ;
"RTN","IVMCMB",40,0)
 N IVMTEXT,IVMPAT
"RTN","IVMCMB",41,0)
 S IVMPAT=$$PT^IVMUFNC4(DFN)
"RTN","IVMCMB",42,0)
 S XMSUB="HEC NOTIFICATION OF HARDSHIP"
"RTN","IVMCMB",43,0)
 S IVMTEXT(1)="A hardship determination was uploaded from the Health Eligibility Center"
"RTN","IVMCMB",44,0)
 S IVMTEXT(2)="for the following patient:"
"RTN","IVMCMB",45,0)
 S IVMTEXT(3)=" "
"RTN","IVMCMB",46,0)
 S IVMTEXT(4)="                  Name: "_$P(IVMPAT,"^")
"RTN","IVMCMB",47,0)
 S IVMTEXT(5)="                   PID: "_$P(IVMPAT,"^",2)
"RTN","IVMCMB",48,0)
 S IVMTEXT(6)="        Effective Date: "_$S(WDATE:$$FMTE^XLFDT(WDATE),1:"UNKNOWN")
"RTN","IVMCMB",49,0)
 S IVMTEXT(7)="Site Granting Hardship: "_$S($L(SITE):SITE,1:"UNKNOWN")
"RTN","IVMCMB",50,0)
 ;
"RTN","IVMCMB",51,0)
 D MAIL^IVMUFNC("DGMT MT/CT UPLOAD ALERTS")
"RTN","IVMCMB",52,0)
 Q
"RTN","IVMCMB",53,0)
 ;
"RTN","IVMCMB",54,0)
BULL2(DFN,WDATE,SITE) ; 
"RTN","IVMCMB",55,0)
 ;Send message notifying site of deletion of hardship determination
"RTN","IVMCMB",56,0)
 ;
"RTN","IVMCMB",57,0)
 N IVMTEXT,IVMPAT
"RTN","IVMCMB",58,0)
 S IVMPAT=$$PT^IVMUFNC4(DFN)
"RTN","IVMCMB",59,0)
 S XMSUB="HEC NOTIFICATION OF HARDSHIP"
"RTN","IVMCMB",60,0)
 S IVMTEXT(1)="Notification has been received from the Health Eligibility Center "
"RTN","IVMCMB",61,0)
 S IVMTEXT(2)="that the hardship determination was deleted for the following patient:"
"RTN","IVMCMB",62,0)
 S IVMTEXT(3)=" "
"RTN","IVMCMB",63,0)
 S IVMTEXT(4)="                             Name: "_$P(IVMPAT,"^")
"RTN","IVMCMB",64,0)
 S IVMTEXT(5)="                              PID: "_$P(IVMPAT,"^",2)
"RTN","IVMCMB",65,0)
 S IVMTEXT(6)=" Effective Date Prior to Deletion: "_$S(WDATE:$$FMTE^XLFDT(WDATE),1:"UNKNOWN")
"RTN","IVMCMB",66,0)
 S IVMTEXT(7)="Site Originally Granting Hardship: "_$S($L(SITE):SITE,1:"UNKNOWN")
"RTN","IVMCMB",67,0)
 ;
"RTN","IVMCMB",68,0)
 D MAIL^IVMUFNC("DGMT MT/CT UPLOAD ALERTS")
"RTN","IVMCMB",69,0)
 Q
"RTN","IVMCMB",70,0)
 ;
"RTN","IVMCMB",71,0)
BULL3(DFN) ; 
"RTN","IVMCMB",72,0)
 ;Send message notifying site to discontinue net-worth adjudication
"RTN","IVMCMB",73,0)
 ;
"RTN","IVMCMB",74,0)
 Q:('$G(DFN))
"RTN","IVMCMB",75,0)
 ;
"RTN","IVMCMB",76,0)
 N IVMTEXT,IVMPAT
"RTN","IVMCMB",77,0)
 S IVMPAT=$$PT^IVMUFNC4(DFN)
"RTN","IVMCMB",78,0)
 S XMSUB="HEC Authority Over Networth-Adjudication"
"RTN","IVMCMB",79,0)
 S IVMTEXT(1)="Please discontinue development of net-worth for the following patient:"
"RTN","IVMCMB",80,0)
 S IVMTEXT(2)=" "
"RTN","IVMCMB",81,0)
 S IVMTEXT(3)=" "
"RTN","IVMCMB",82,0)
 S IVMTEXT(4)="                  Name: "_$P(IVMPAT,"^")
"RTN","IVMCMB",83,0)
 S IVMTEXT(5)="                   PID: "_$P(IVMPAT,"^",2)
"RTN","IVMCMB",84,0)
 ;
"RTN","IVMCMB",85,0)
 D MAIL^IVMUFNC("DGMT MT/CT UPLOAD ALERTS")
"RTN","IVMCMB",86,0)
 Q
"RTN","IVMCMB",87,0)
 ;
"RTN","IVMCMB",88,0)
ADD(DFN,TYPETEST,ACTION,TESTDATE,STATUS1,STATUS2) ;
"RTN","IVMCMB",89,0)
 ;Adds to the notification list
"RTN","IVMCMB",90,0)
 ;
"RTN","IVMCMB",91,0)
 N COUNT
"RTN","IVMCMB",92,0)
 S COUNT=$G(^TMP($J,"IVMBULL",0))+1
"RTN","IVMCMB",93,0)
 S ^TMP($J,"IVMBULL",COUNT)=DFN_U_$G(TYPETEST)_U_$G(TESTDATE)_U_$G(STATUS1)_U_$G(STATUS2)_U_$G(ACTION)
"RTN","IVMCMB",94,0)
 S ^TMP($J,"IVMBULL",0)=COUNT
"RTN","IVMCMB",95,0)
 Q
"RTN","IVMPREC6")
0^2^B74103661^B74089697
"RTN","IVMPREC6",1,0)
IVMPREC6 ;ALB/KCL/BRM/CKN,TDM - PROCESS INCOMING (Z05 EVENT TYPE) HL7 MESSAGES ; 4/2/09 1:44pm
"RTN","IVMPREC6",2,0)
 ;;2.0; INCOME VERIFICATION MATCH ;**3,4,12,17,34,58,79,102,115,140**; 21-OCT-94;Build 2
"RTN","IVMPREC6",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMPREC6",4,0)
 ;
"RTN","IVMPREC6",5,0)
 ; This routine will process batch ORU demographic (event type Z05) HL7
"RTN","IVMPREC6",6,0)
 ; messages received from the IVM center.  Format of HL7 batch message:
"RTN","IVMPREC6",7,0)
 ;
"RTN","IVMPREC6",8,0)
 ;       BHS
"RTN","IVMPREC6",9,0)
 ;       {MSH
"RTN","IVMPREC6",10,0)
 ;        PID
"RTN","IVMPREC6",11,0)
 ;        ZPD
"RTN","IVMPREC6",12,0)
 ;        ZGD
"RTN","IVMPREC6",13,0)
 ;        RF1 (optional)
"RTN","IVMPREC6",14,0)
 ;       }
"RTN","IVMPREC6",15,0)
 ;       BTS
"RTN","IVMPREC6",16,0)
 ;
"RTN","IVMPREC6",17,0)
 ;
"RTN","IVMPREC6",18,0)
EN ; - entry point to process HL7 patient demographic message 
"RTN","IVMPREC6",19,0)
 ;
"RTN","IVMPREC6",20,0)
 N DGENUPLD,VAFCA08,DGRUGA08,COMP,DODSEG,GUARSEG
"RTN","IVMPREC6",21,0)
 ;
"RTN","IVMPREC6",22,0)
 ; prevent a return Z07 when uploading a Z05 (Patient file triggers)
"RTN","IVMPREC6",23,0)
 S DGENUPLD="ENROLLMENT/ELIGIBILITY UPLOAD IN PROGRESS"
"RTN","IVMPREC6",24,0)
 ;
"RTN","IVMPREC6",25,0)
 ; prevent MPI A08 message when uploading Z05 (Patient file triggers)
"RTN","IVMPREC6",26,0)
 S VAFCA08=1  ;MPI/CIRN A08 suppression flag
"RTN","IVMPREC6",27,0)
 ;
"RTN","IVMPREC6",28,0)
 S IVMFLG=0,IVMADFLG=0
"RTN","IVMPREC6",29,0)
 ; - get incoming HL7 message from HL7 Transmission (#772) file
"RTN","IVMPREC6",30,0)
 F IVMDA=0:0 S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)) Q:'IVMDA  S IVMSEG=$G(^(IVMDA,0)) I $E(IVMSEG,1,3)="MSH" D
"RTN","IVMPREC6",31,0)
 .K HLERR
"RTN","IVMPREC6",32,0)
 .;
"RTN","IVMPREC6",33,0)
 .; - message control id from MSH segment
"RTN","IVMPREC6",34,0)
 .S MSGID=$P(IVMSEG,HLFS,10),HLMID=MSGID
"RTN","IVMPREC6",35,0)
 .;
"RTN","IVMPREC6",36,0)
 .; - perform demographics message consistency check
"RTN","IVMPREC6",37,0)
 .D EN^IVMPRECA Q:$D(HLERR)
"RTN","IVMPREC6",38,0)
 .;
"RTN","IVMPREC6",39,0)
 .;Set array of Email, Cell, Pager fields
"RTN","IVMPREC6",40,0)
 .D EPCFLDS(.EPCFARY,.EPCDEL)
"RTN","IVMPREC6",41,0)
 .; - get next msg segment
"RTN","IVMPREC6",42,0)
 .D NEXT I $E(IVMSEG,1,3)'="PID" D  Q
"RTN","IVMPREC6",43,0)
 ..S HLERR="Missing PID segment" D ACK^IVMPREC
"RTN","IVMPREC6",44,0)
 .;
"RTN","IVMPREC6",45,0)
 .F I=1:1 D NEXT Q:$E(IVMSEG,1,4)="ZPD^"  ;Go through all PID
"RTN","IVMPREC6",46,0)
 .; - patient IEN (DFN) from PID segment
"RTN","IVMPREC6",47,0)
 .;Use IVMPID array created in IVMPRECA while performing consistency
"RTN","IVMPREC6",48,0)
 .;to process PID segment
"RTN","IVMPREC6",49,0)
 .;
"RTN","IVMPREC6",50,0)
 .;I '$G(IVMDFN) S HLERR="Invalid DFN" D ACK^IVMPREC  Q
"RTN","IVMPREC6",51,0)
 .S DFN=$G(IVMDFN)
"RTN","IVMPREC6",52,0)
 .;I ('DFN!(DFN'=+DFN)!('$D(^DPT(+DFN,0)))) D  Q
"RTN","IVMPREC6",53,0)
 .;.S HLERR="Invalid DFN" D ACK^IVMPREC
"RTN","IVMPREC6",54,0)
 .;I IVMPID(19)'=$P(^DPT(DFN,0),"^",9) D  Q
"RTN","IVMPREC6",55,0)
 .;.S HLERR="Couldn't match HEC SSN with DHCP SSN" D ACK^IVMPREC
"RTN","IVMPREC6",56,0)
 .;
"RTN","IVMPREC6",57,0)
 .; - check for entry in IVM PATIENT file, otherwise create stub entry
"RTN","IVMPREC6",58,0)
 .S IVM3015=$O(^IVM(301.5,"B",DFN,0))
"RTN","IVMPREC6",59,0)
 .I 'IVM3015 S IVM3015=$$LOG^IVMPLOG(DFN,DT)
"RTN","IVMPREC6",60,0)
 .I 'IVM3015 D  Q
"RTN","IVMPREC6",61,0)
 ..S HLERR="Failed to create entry in IVM PATIENT file"
"RTN","IVMPREC6",62,0)
 ..D ACK^IVMPREC
"RTN","IVMPREC6",63,0)
 .;
"RTN","IVMPREC6",64,0)
 .; - compare PID segment fields with DHCP fields
"RTN","IVMPREC6",65,0)
 .S IVMSEG="PID"  ;Setting IVMSEG to PID before it calls COMPARE
"RTN","IVMPREC6",66,0)
 .I 'DODSEG,'GUARSEG D COMPARE(IVMSEG) Q:$D(HLERR)
"RTN","IVMPREC6",67,0)
 .;
"RTN","IVMPREC6",68,0)
 .; - get next msg segment -decrement the counter so it can pickup ZPD
"RTN","IVMPREC6",69,0)
 .S IVMDA=IVMDA-1 D NEXT I $E(IVMSEG,1,3)'="ZPD" D  Q
"RTN","IVMPREC6",70,0)
 ..S HLERR="Missing ZPD segment" D ACK^IVMPREC
"RTN","IVMPREC6",71,0)
 .;Convert "" to null in ZPD segment except seq. 8,9, 31 and 32
"RTN","IVMPREC6",72,0)
 .S IVMSEG=$$CLEARF^IVMPRECA(IVMSEG,HLFS,",9,10,32,33,")
"RTN","IVMPREC6",73,0)
 .;
"RTN","IVMPREC6",74,0)
 .; - compare ZPD segment fields with DHCP fields
"RTN","IVMPREC6",75,0)
 .D COMPARE(IVMSEG)
"RTN","IVMPREC6",76,0)
 .;
"RTN","IVMPREC6",77,0)
 .; - get next msg segment
"RTN","IVMPREC6",78,0)
 .D NEXT I $E(IVMSEG,1,3)="ZEL" D  Q
"RTN","IVMPREC6",79,0)
 ..S HLERR="ZEL segment should not be sent in Z05 message" D ACK^IVMPREC
"RTN","IVMPREC6",80,0)
 .;
"RTN","IVMPREC6",81,0)
 .; - get next msg segment
"RTN","IVMPREC6",82,0)
 .I $E(IVMSEG,1,3)'="ZGD" D  Q
"RTN","IVMPREC6",83,0)
 ..S HLERR="Missing ZGD segment" D ACK^IVMPREC
"RTN","IVMPREC6",84,0)
 .;
"RTN","IVMPREC6",85,0)
 .; - compare ZGD segment fields with DHCP fields
"RTN","IVMPREC6",86,0)
 .; convert "" to null for ZGD segment
"RTN","IVMPREC6",87,0)
 .S IVMSEG=$$CLEARF^IVMPRECA(IVMSEG,HLFS,",7,") ;ignore seq. 6
"RTN","IVMPREC6",88,0)
 .; convert seq. 6 separately
"RTN","IVMPREC6",89,0)
 .S $P(IVMSEG,HLFS,7)=$$CLEARF^IVMPRECA($P(IVMSEG,HLFS,7),$E(HLECH))
"RTN","IVMPREC6",90,0)
 .D COMPARE(IVMSEG)
"RTN","IVMPREC6",91,0)
 .;S IVMFLG=0
"RTN","IVMPREC6",92,0)
 .;
"RTN","IVMPREC6",93,0)
 .; - check for RF1 segment and get segment if it exists
"RTN","IVMPREC6",94,0)
 .;     This process will automatically update patient address data
"RTN","IVMPREC6",95,0)
 .;     in the Patient (#2) file if the incoming address is more
"RTN","IVMPREC6",96,0)
 .;     recent than the existing one.
"RTN","IVMPREC6",97,0)
 .;Modified code to handle multiple RF1 segment - IVM*2*115
"RTN","IVMPREC6",98,0)
 .S (UPDEPC("SAD"),UPDEPC("CPH"),UPDEPC("PNO"),UPDEPC("EAD"))=0
"RTN","IVMPREC6",99,0)
 .S QFLG=0 I $$RF1CHK(IVMRTN,IVMDA) F I=1:1 D  Q:QFLG
"RTN","IVMPREC6",100,0)
 ..D NEXT
"RTN","IVMPREC6",101,0)
 ..S IVMSEG=$$CLEARF^IVMPRECA(IVMSEG,HLFS,",7,") ;ignore seq. 6
"RTN","IVMPREC6",102,0)
 ..S $P(IVMSEG,HLFS,7)=$$CLEARF^IVMPRECA($P(IVMSEG,HLFS,7),$E(HLECH))
"RTN","IVMPREC6",103,0)
 ..I $P(IVMSEG,HLFS,4)="" S QFLG=1 Q  ;Quit if RF1 is blank
"RTN","IVMPREC6",104,0)
 ..D COMPARE(IVMSEG)
"RTN","IVMPREC6",105,0)
 ..I '$$RF1CHK(IVMRTN,IVMDA) S QFLG=1
"RTN","IVMPREC6",106,0)
 .S IVMFLG=0
"RTN","IVMPREC6",107,0)
 ;
"RTN","IVMPREC6",108,0)
 ; - send mail message if necessary
"RTN","IVMPREC6",109,0)
 ; This bulletin has been disabled.  IVM*2*140
"RTN","IVMPREC6",110,0)
 ;I IVMCNTR D MAIL^IVMUFNC()
"RTN","IVMPREC6",111,0)
 ; Cleanup variables if no msg necessary
"RTN","IVMPREC6",112,0)
 I 'IVMCNTR K IVMTEXT,XMSUB
"RTN","IVMPREC6",113,0)
 ;
"RTN","IVMPREC6",114,0)
ENQ ; - cleanup variables
"RTN","IVMPREC6",115,0)
 K DA,DFN,IVMADDR,IVMADFLG,IVMDA,IVMDHCP,IVMFLAG,IVMFLD,IVMPIECE,IVMSEG,IVMSTART,IVMXREF,DGENUPLD,IVMPID,PIDSTR,ADDRESS,TELECOM,UPDEPC,EPCFARY,IVMDFN,DODSEG,EPCDEL,GUARSEG
"RTN","IVMPREC6",116,0)
 Q
"RTN","IVMPREC6",117,0)
 ;
"RTN","IVMPREC6",118,0)
 ;
"RTN","IVMPREC6",119,0)
NEXT ; - get the next HL7 segment in the message from HL7 Transmission (#772) file
"RTN","IVMPREC6",120,0)
 ;
"RTN","IVMPREC6",121,0)
 S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)),IVMSEG=$G(^(+IVMDA,0))
"RTN","IVMPREC6",122,0)
 Q
"RTN","IVMPREC6",123,0)
 ;
"RTN","IVMPREC6",124,0)
 ;
"RTN","IVMPREC6",125,0)
COMPARE(IVMSEG) ; - compare incoming HL7 segment/fields with DHCP fields
"RTN","IVMPREC6",126,0)
 ;
"RTN","IVMPREC6",127,0)
 ;  Input:  IVMSEG  --  as the text of the incoming HL7 message
"RTN","IVMPREC6",128,0)
 ;
"RTN","IVMPREC6",129,0)
 ; Output:  None
"RTN","IVMPREC6",130,0)
 ;
"RTN","IVMPREC6",131,0)
 ; - get 3 letter HL7 segment name
"RTN","IVMPREC6",132,0)
 S IVMXREF=$P(IVMSEG,HLFS,1),IVMSTART=IVMXREF
"RTN","IVMPREC6",133,0)
 ;
"RTN","IVMPREC6",134,0)
 ; - strip off HL7 segment name
"RTN","IVMPREC6",135,0)
 S IVMSEG=$P(IVMSEG,HLFS,2,99)
"RTN","IVMPREC6",136,0)
 ;
"RTN","IVMPREC6",137,0)
 ; - roll through "C" x-ref in IVM Demographic Upload Fields (#301.92) file
"RTN","IVMPREC6",138,0)
 F  S IVMXREF=$O(^IVM(301.92,"C",IVMXREF)) Q:IVMXREF']""  D
"RTN","IVMPREC6",139,0)
 .S IVMDEMDA=$O(^IVM(301.92,"C",IVMXREF,"")) Q:IVMDEMDA']""
"RTN","IVMPREC6",140,0)
 .I $$INACTIVE(IVMDEMDA) Q
"RTN","IVMPREC6",141,0)
 .;
"RTN","IVMPREC6",142,0)
 .; - compare incoming HL7 segment fields with DHCP fields
"RTN","IVMPREC6",143,0)
 .I IVMXREF["PID",(IVMSTART["PID") D PID^IVMPREC8
"RTN","IVMPREC6",144,0)
 .I IVMXREF["ZPD",(IVMSTART["ZPD") D ZPD^IVMPREC8
"RTN","IVMPREC6",145,0)
 .I IVMXREF["ZGD",(IVMSTART["ZGD") D ZGD^IVMPREC8
"RTN","IVMPREC6",146,0)
 .I IVMXREF["RF1",(IVMSTART["RF1") D RF1^IVMPREC8
"RTN","IVMPREC6",147,0)
 Q
"RTN","IVMPREC6",148,0)
 ;
"RTN","IVMPREC6",149,0)
 ;
"RTN","IVMPREC6",150,0)
DEMBULL ; -  build mail message for transmission to IVM mail group notifying
"RTN","IVMPREC6",151,0)
 ;    them that patients with updated demographic data has been received
"RTN","IVMPREC6",152,0)
 ;    from the IVM Center and may now be uploaded into DHCP.
"RTN","IVMPREC6",153,0)
 ;
"RTN","IVMPREC6",154,0)
 ; If record is auto uploaded, don't add veteran to bulletin
"RTN","IVMPREC6",155,0)
 I $$CKAUTO Q
"RTN","IVMPREC6",156,0)
 ;
"RTN","IVMPREC6",157,0)
 S IVMPTID=$$PT^IVMUFNC4(DFN)
"RTN","IVMPREC6",158,0)
 S XMSUB="IVM - DEMOGRAPHIC UPLOAD for "_$P($P(IVMPTID,"^"),",")_" ("_$P(IVMPTID,"^",3)_")"
"RTN","IVMPREC6",159,0)
 S IVMTEXT(1)="Updated demographic information has been received from the"
"RTN","IVMPREC6",160,0)
 S IVMTEXT(2)="Health Eligibilty Center.  Please select the 'Demographic Upload'"
"RTN","IVMPREC6",161,0)
 S IVMTEXT(3)="option from the IVM Upload Menu in order to take action on this"
"RTN","IVMPREC6",162,0)
 S IVMTEXT(4)="demographic information.  If you have any questions concerning the"
"RTN","IVMPREC6",163,0)
 S IVMTEXT(5)="information received, please contact the Health Eligibility Center."
"RTN","IVMPREC6",164,0)
 S IVMTEXT(7)=""
"RTN","IVMPREC6",165,0)
 S IVMTEXT(8)="The Health Eligibilty Center has identified the following"
"RTN","IVMPREC6",166,0)
 S IVMTEXT(9)="patients as having updated demographic information:"
"RTN","IVMPREC6",167,0)
 S IVMTEXT(10)=""
"RTN","IVMPREC6",168,0)
 S IVMCNTR=IVMCNTR+1
"RTN","IVMPREC6",169,0)
 S IVMTEXT(IVMCNTR+10)=$J(IVMCNTR_")",5)_"  "_$P(IVMPTID,"^")_" ("_$P(IVMPTID,"^",3)_")"
"RTN","IVMPREC6",170,0)
 Q
"RTN","IVMPREC6",171,0)
 ;
"RTN","IVMPREC6",172,0)
INACTIVE(IVMDEMDA) ;Check if field is inactive in Demographic Upload
"RTN","IVMPREC6",173,0)
 ; Input  -- IVMDEMDA IVM Demographic Upload Fields IEN
"RTN","IVMPREC6",174,0)
 ; Output -- 1=Yes and 0=No
"RTN","IVMPREC6",175,0)
 Q +$P($G(^IVM(301.92,IVMDEMDA,0)),U,9)
"RTN","IVMPREC6",176,0)
 ;
"RTN","IVMPREC6",177,0)
RF1CHK(IVMRTN,IVMDA) ;does an RF1 segment exist in this message?
"RTN","IVMPREC6",178,0)
 N RF1
"RTN","IVMPREC6",179,0)
 S RF1=$O(^TMP($J,IVMRTN,IVMDA))
"RTN","IVMPREC6",180,0)
 I $E($G(^(+RF1,0)),1,3)'="RF1" Q 0
"RTN","IVMPREC6",181,0)
 Q 1
"RTN","IVMPREC6",182,0)
 ;
"RTN","IVMPREC6",183,0)
CKAUTO() ;
"RTN","IVMPREC6",184,0)
 ; Chect if message qualifies for an auto upload.
"RTN","IVMPREC6",185,0)
 N AUTO,IVMI,DOD
"RTN","IVMPREC6",186,0)
 S AUTO=0,IVMI=$O(^IVM(301.92,"C","ZPD09",""))
"RTN","IVMPREC6",187,0)
 I IVMI=IVMDEMDA  D
"RTN","IVMPREC6",188,0)
 .I +IVMFLD'>0 S AUTO=1 Q
"RTN","IVMPREC6",189,0)
 .S DOD=$P($G(^DPT(DFN,.35)),U)
"RTN","IVMPREC6",190,0)
 .I DOD=IVMFLD S AUTO=1 Q
"RTN","IVMPREC6",191,0)
 ;
"RTN","IVMPREC6",192,0)
 Q AUTO
"RTN","IVMPREC6",193,0)
BLDPID(PIDTMP,IVMPID) ;Build IVMPID subscripted by sequence number
"RTN","IVMPREC6",194,0)
 N STR,X1,X2,N,TEXT,C,L
"RTN","IVMPREC6",195,0)
 S STR="",X1=1,(N,X2)=0
"RTN","IVMPREC6",196,0)
 F  S N=$O(PIDTMP(N)) Q:N=""  S TEXT=PIDTMP(N) F L=1:1:$L(TEXT) S C=$E(TEXT,L) D
"RTN","IVMPREC6",197,0)
 . I C="^" D  Q
"RTN","IVMPREC6",198,0)
 . . I X2 S X2=X2+1,IVMPID(X1,X2)=STR
"RTN","IVMPREC6",199,0)
 . . E  S IVMPID(X1)=STR
"RTN","IVMPREC6",200,0)
 . . S STR="",X1=X1+1,X2=0
"RTN","IVMPREC6",201,0)
 . I C="|" D  Q
"RTN","IVMPREC6",202,0)
 . . S X2=X2+1,IVMPID(X1,X2)=STR,STR=""
"RTN","IVMPREC6",203,0)
 . S STR=STR_C
"RTN","IVMPREC6",204,0)
 I $G(C)'="",$G(C)'="^",$G(C)'="|" D
"RTN","IVMPREC6",205,0)
 . I X2 S X2=X2+1,IVMPID(X1,X2)=STR Q
"RTN","IVMPREC6",206,0)
 . S IVMPID(X1)=STR
"RTN","IVMPREC6",207,0)
 Q
"RTN","IVMPREC6",208,0)
ADDRCHNG(DFN) ;Store Address Change Date/time, Source and site if necessary
"RTN","IVMPREC6",209,0)
 N IVMVALUE,IVMFIELD
"RTN","IVMPREC6",210,0)
 I '$D(^TMP($J,"CHANGE UPDATE")) Q
"RTN","IVMPREC6",211,0)
 S IVMFIELD=0 F  S IVMFIELD=$O(^TMP($J,"CHANGE UPDATE",IVMFIELD)) Q:IVMFIELD=""  D
"RTN","IVMPREC6",212,0)
 . S IVMVALUE=$G(^TMP($J,"CHANGE UPDATE",IVMFIELD))
"RTN","IVMPREC6",213,0)
 . S DIE="^DPT(",DA=DFN,DR=IVMFIELD_"////^S X=IVMVALUE"
"RTN","IVMPREC6",214,0)
 . D ^DIE K DA,DIE,DR
"RTN","IVMPREC6",215,0)
 .; - delete inaccurate Addr Change Site data if Source is not VAMC
"RTN","IVMPREC6",216,0)
 . I IVMFIELD=.119,IVMVALUE'="VAMC" S FDA(2,+DFN_",",.12)="@" D UPDATE^DIE("E","FDA")
"RTN","IVMPREC6",217,0)
 K ^TMP($J,"CHANGE UPDATE")
"RTN","IVMPREC6",218,0)
 Q
"RTN","IVMPREC6",219,0)
EPCFLDS(EPCFARY,EPCDEL) ;
"RTN","IVMPREC6",220,0)
 ;EPCFARY - Contains IENs of Pager, email and Cell phone records in 301.92 File - Passed by reference
"RTN","IVMPREC6",221,0)
 ;EPCDEL - Contains field # of Pager, Email and Cell phone fields in Patient(#2) file. - Passed by reference
"RTN","IVMPREC6",222,0)
 I (DODSEG)!(GUARSEG) Q
"RTN","IVMPREC6",223,0)
 S EPCFARY("PNO")=$O(^IVM(301.92,"B","PAGER NUMBER",0))_"^"_$O(^IVM(301.92,"B","PAGER CHANGE DT/TM",0))_"^"_$O(^IVM(301.92,"B","PAGER CHANGE SITE",0))_"^"_$O(^IVM(301.92,"B","PAGER CHANGE SOURCE",0))
"RTN","IVMPREC6",224,0)
 S EPCFARY("CPH")=$O(^IVM(301.92,"B","CELLULAR NUMBER",0))_"^"_$O(^IVM(301.92,"B","CELL PHONE CHANGE DT/TM",0))_"^"_$O(^IVM(301.92,"B","CELL PHONE CHANGE SITE",0))_"^"_$O(^IVM(301.92,"B","CELL PHONE CHANGE SOURCE",0))
"RTN","IVMPREC6",225,0)
 S EPCFARY("EAD")=$O(^IVM(301.92,"B","EMAIL ADDRESS",0))_"^"_$O(^IVM(301.92,"B","EMAIL CHANGE DT/TM",0))_"^"_$O(^IVM(301.92,"B","EMAIL CHANGE SITE",0))_"^"_$O(^IVM(301.92,"B","EMAIL CHANGE SOURCE",0))
"RTN","IVMPREC6",226,0)
 S EPCDEL("PNO")=".135^.1312^.1313^.1314"
"RTN","IVMPREC6",227,0)
 S EPCDEL("CPH")=".134^.139^.1311^.13111"
"RTN","IVMPREC6",228,0)
 S EPCDEL("EAD")=".133^.136^.137^.138"
"RTN","IVMPREC6",229,0)
 Q
"VER")
8.0^22.0
"BLD",7184,6)
^114
**END**
**END**
